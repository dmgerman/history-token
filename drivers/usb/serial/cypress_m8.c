multiline_comment|/*&n; * USB Cypress M8 driver&n; *&n; * &t;Copyright (C) 2004&n; * &t;    Lonnie Mendez (dignome@gmail.com) &n; *&t;Copyright (C) 2003,2004&n; *&t;    Neil Whelchel (koyama@firstlight.net)&n; *&n; * &t;This program is free software; you can redistribute it and/or modify&n; * &t;it under the terms of the GNU General Public License as published by&n; * &t;the Free Software Foundation; either version 2 of the License, or&n; * &t;(at your option) any later version.&n; *&n; * See Documentation/usb/usb-serial.txt for more information on using this driver&n; *&n; * See http://geocities.com/i0xox0i for information on this driver and the&n; * earthmate usb device.&n; *&n; *&n; *  Lonnie Mendez &lt;dignome@gmail.com&gt;&n; *  04-10-2004&n; *&t;Driver modified to support dynamic line settings.  Various improvments&n; *      and features.&n; *&n; *  Neil Whelchel&n; *  10-2003&n; *&t;Driver first released.&n; *&n; *&n; * Long Term TODO:&n; *&t;Improve transfer speeds - both read/write are somewhat slow&n; *   at this point.&n; */
multiline_comment|/* Neil Whelchel wrote the cypress m8 implementation */
multiline_comment|/* Thanks to cypress for providing references for the hid reports. */
multiline_comment|/* Thanks to Jiang Zhang for providing links and for general help. */
multiline_comment|/* Code originates and was built up from ftdi_sio, belkin, pl2303 and others. */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/tty_driver.h&gt;
macro_line|#include &lt;linux/tty_flip.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/moduleparam.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/usb.h&gt;
macro_line|#include &lt;linux/serial.h&gt;
macro_line|#ifdef CONFIG_USB_SERIAL_DEBUG
DECL|variable|debug
r_static
r_int
id|debug
op_assign
l_int|1
suffix:semicolon
macro_line|#else
DECL|variable|debug
r_static
r_int
id|debug
suffix:semicolon
macro_line|#endif
DECL|variable|stats
r_static
r_int
id|stats
suffix:semicolon
macro_line|#include &quot;usb-serial.h&quot;
macro_line|#include &quot;cypress_m8.h&quot;
multiline_comment|/*&n; * Version Information&n; */
DECL|macro|DRIVER_VERSION
mdefine_line|#define DRIVER_VERSION &quot;v1.06&quot;
DECL|macro|DRIVER_AUTHOR
mdefine_line|#define DRIVER_AUTHOR &quot;Lonnie Mendez &lt;dignome@gmail.com&gt;, Neil Whelchel &lt;koyama@firstlight.net&gt;&quot;
DECL|macro|DRIVER_DESC
mdefine_line|#define DRIVER_DESC &quot;Cypress USB to Serial Driver&quot;
DECL|variable|id_table_earthmate
r_static
r_struct
id|usb_device_id
id|id_table_earthmate
(braket
)braket
op_assign
(brace
(brace
id|USB_DEVICE
c_func
(paren
id|VENDOR_ID_DELORME
comma
id|PRODUCT_ID_EARTHMATEUSB
)paren
)brace
comma
(brace
)brace
multiline_comment|/* Terminating entry */
)brace
suffix:semicolon
DECL|variable|id_table_cyphidcomrs232
r_static
r_struct
id|usb_device_id
id|id_table_cyphidcomrs232
(braket
)braket
op_assign
(brace
(brace
id|USB_DEVICE
c_func
(paren
id|VENDOR_ID_CYPRESS
comma
id|PRODUCT_ID_CYPHIDCOM
)paren
)brace
comma
(brace
)brace
multiline_comment|/* Terminating entry */
)brace
suffix:semicolon
DECL|variable|id_table_combined
r_static
r_struct
id|usb_device_id
id|id_table_combined
(braket
)braket
op_assign
(brace
(brace
id|USB_DEVICE
c_func
(paren
id|VENDOR_ID_DELORME
comma
id|PRODUCT_ID_EARTHMATEUSB
)paren
)brace
comma
(brace
id|USB_DEVICE
c_func
(paren
id|VENDOR_ID_CYPRESS
comma
id|PRODUCT_ID_CYPHIDCOM
)paren
)brace
comma
(brace
)brace
multiline_comment|/* Terminating entry */
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
(paren
id|usb
comma
id|id_table_combined
)paren
suffix:semicolon
DECL|variable|cypress_driver
r_static
r_struct
id|usb_driver
id|cypress_driver
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;cypress&quot;
comma
dot
id|probe
op_assign
id|usb_serial_probe
comma
dot
id|disconnect
op_assign
id|usb_serial_disconnect
comma
dot
id|id_table
op_assign
id|id_table_combined
comma
)brace
suffix:semicolon
DECL|struct|cypress_private
r_struct
id|cypress_private
(brace
DECL|member|lock
id|spinlock_t
id|lock
suffix:semicolon
multiline_comment|/* private lock */
DECL|member|chiptype
r_int
id|chiptype
suffix:semicolon
multiline_comment|/* identifier of device, for quirks/etc */
DECL|member|bytes_in
r_int
id|bytes_in
suffix:semicolon
multiline_comment|/* used for statistics */
DECL|member|bytes_out
r_int
id|bytes_out
suffix:semicolon
multiline_comment|/* used for statistics */
DECL|member|cmd_count
r_int
id|cmd_count
suffix:semicolon
multiline_comment|/* used for statistics */
DECL|member|cmd_ctrl
r_int
id|cmd_ctrl
suffix:semicolon
multiline_comment|/* always set this to 1 before issuing a command */
DECL|member|termios_initialized
r_int
id|termios_initialized
suffix:semicolon
DECL|member|line_control
id|__u8
id|line_control
suffix:semicolon
multiline_comment|/* holds dtr / rts value */
DECL|member|current_status
id|__u8
id|current_status
suffix:semicolon
multiline_comment|/* received from last read - info on dsr,cts,cd,ri,etc */
DECL|member|current_config
id|__u8
id|current_config
suffix:semicolon
multiline_comment|/* stores the current configuration byte */
DECL|member|rx_flags
id|__u8
id|rx_flags
suffix:semicolon
multiline_comment|/* throttling - used from whiteheat/ftdi_sio */
DECL|member|baud_rate
r_int
id|baud_rate
suffix:semicolon
multiline_comment|/* stores current baud rate in integer form */
DECL|member|cbr_mask
r_int
id|cbr_mask
suffix:semicolon
multiline_comment|/* stores current baud rate in masked form */
DECL|member|isthrottled
r_int
id|isthrottled
suffix:semicolon
multiline_comment|/* if throttled, discard reads */
DECL|member|delta_msr_wait
id|wait_queue_head_t
id|delta_msr_wait
suffix:semicolon
multiline_comment|/* used for TIOCMIWAIT */
DECL|member|prev_status
DECL|member|diff_status
r_char
id|prev_status
comma
id|diff_status
suffix:semicolon
multiline_comment|/* used for TIOCMIWAIT */
multiline_comment|/* we pass a pointer to this as the arguement sent to cypress_set_termios old_termios */
DECL|member|tmp_termios
r_struct
id|termios
id|tmp_termios
suffix:semicolon
multiline_comment|/* stores the old termios settings */
DECL|member|write_interval
r_int
id|write_interval
suffix:semicolon
multiline_comment|/* interrupt out write interval, as obtained from interrupt_out_urb */
DECL|member|writepipe
r_int
id|writepipe
suffix:semicolon
multiline_comment|/* used for clear halt, if necessary */
)brace
suffix:semicolon
multiline_comment|/* function prototypes for the Cypress USB to serial device */
r_static
r_int
id|cypress_earthmate_startup
(paren
r_struct
id|usb_serial
op_star
id|serial
)paren
suffix:semicolon
r_static
r_int
id|cypress_hidcom_startup
(paren
r_struct
id|usb_serial
op_star
id|serial
)paren
suffix:semicolon
r_static
r_void
id|cypress_shutdown
(paren
r_struct
id|usb_serial
op_star
id|serial
)paren
suffix:semicolon
r_static
r_int
id|cypress_open
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|file
op_star
id|filp
)paren
suffix:semicolon
r_static
r_void
id|cypress_close
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|file
op_star
id|filp
)paren
suffix:semicolon
r_static
r_int
id|cypress_write
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_const
r_int
r_char
op_star
id|buf
comma
r_int
id|count
)paren
suffix:semicolon
r_static
r_int
id|cypress_write_room
(paren
r_struct
id|usb_serial_port
op_star
id|port
)paren
suffix:semicolon
r_static
r_int
id|cypress_ioctl
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
suffix:semicolon
r_static
r_void
id|cypress_set_termios
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|termios
op_star
id|old
)paren
suffix:semicolon
r_static
r_int
id|cypress_tiocmget
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|file
op_star
id|file
)paren
suffix:semicolon
r_static
r_int
id|cypress_tiocmset
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|set
comma
r_int
r_int
id|clear
)paren
suffix:semicolon
r_static
r_int
id|cypress_chars_in_buffer
(paren
r_struct
id|usb_serial_port
op_star
id|port
)paren
suffix:semicolon
r_static
r_void
id|cypress_throttle
(paren
r_struct
id|usb_serial_port
op_star
id|port
)paren
suffix:semicolon
r_static
r_void
id|cypress_unthrottle
(paren
r_struct
id|usb_serial_port
op_star
id|port
)paren
suffix:semicolon
r_static
r_void
id|cypress_read_int_callback
(paren
r_struct
id|urb
op_star
id|urb
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_void
id|cypress_write_int_callback
(paren
r_struct
id|urb
op_star
id|urb
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
r_static
r_int
id|mask_to_rate
(paren
r_int
id|mask
)paren
suffix:semicolon
r_static
r_int
id|rate_to_mask
(paren
r_int
id|rate
)paren
suffix:semicolon
DECL|variable|cypress_earthmate_device
r_static
r_struct
id|usb_serial_device_type
id|cypress_earthmate_device
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|name
op_assign
l_string|&quot;DeLorme Earthmate USB&quot;
comma
dot
id|short_name
op_assign
l_string|&quot;earthmate&quot;
comma
dot
id|id_table
op_assign
id|id_table_earthmate
comma
dot
id|num_interrupt_in
op_assign
l_int|1
comma
dot
id|num_interrupt_out
op_assign
l_int|1
comma
dot
id|num_bulk_in
op_assign
id|NUM_DONT_CARE
comma
dot
id|num_bulk_out
op_assign
id|NUM_DONT_CARE
comma
dot
id|num_ports
op_assign
l_int|1
comma
dot
id|attach
op_assign
id|cypress_earthmate_startup
comma
dot
id|shutdown
op_assign
id|cypress_shutdown
comma
dot
id|open
op_assign
id|cypress_open
comma
dot
id|close
op_assign
id|cypress_close
comma
dot
id|write
op_assign
id|cypress_write
comma
dot
id|write_room
op_assign
id|cypress_write_room
comma
dot
id|ioctl
op_assign
id|cypress_ioctl
comma
dot
id|set_termios
op_assign
id|cypress_set_termios
comma
dot
id|tiocmget
op_assign
id|cypress_tiocmget
comma
dot
id|tiocmset
op_assign
id|cypress_tiocmset
comma
dot
id|chars_in_buffer
op_assign
id|cypress_chars_in_buffer
comma
dot
id|throttle
op_assign
id|cypress_throttle
comma
dot
id|unthrottle
op_assign
id|cypress_unthrottle
comma
dot
id|read_int_callback
op_assign
id|cypress_read_int_callback
comma
dot
id|write_int_callback
op_assign
id|cypress_write_int_callback
comma
)brace
suffix:semicolon
DECL|variable|cypress_hidcom_device
r_static
r_struct
id|usb_serial_device_type
id|cypress_hidcom_device
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|name
op_assign
l_string|&quot;HID-&gt;COM RS232 Adapter&quot;
comma
dot
id|short_name
op_assign
l_string|&quot;cyphidcom&quot;
comma
dot
id|id_table
op_assign
id|id_table_cyphidcomrs232
comma
dot
id|num_interrupt_in
op_assign
l_int|1
comma
dot
id|num_interrupt_out
op_assign
l_int|1
comma
dot
id|num_bulk_in
op_assign
id|NUM_DONT_CARE
comma
dot
id|num_bulk_out
op_assign
id|NUM_DONT_CARE
comma
dot
id|num_ports
op_assign
l_int|1
comma
dot
id|attach
op_assign
id|cypress_hidcom_startup
comma
dot
id|shutdown
op_assign
id|cypress_shutdown
comma
dot
id|open
op_assign
id|cypress_open
comma
dot
id|close
op_assign
id|cypress_close
comma
dot
id|write
op_assign
id|cypress_write
comma
dot
id|write_room
op_assign
id|cypress_write_room
comma
dot
id|ioctl
op_assign
id|cypress_ioctl
comma
dot
id|set_termios
op_assign
id|cypress_set_termios
comma
dot
id|tiocmget
op_assign
id|cypress_tiocmget
comma
dot
id|tiocmset
op_assign
id|cypress_tiocmset
comma
dot
id|chars_in_buffer
op_assign
id|cypress_chars_in_buffer
comma
dot
id|throttle
op_assign
id|cypress_throttle
comma
dot
id|unthrottle
op_assign
id|cypress_unthrottle
comma
dot
id|read_int_callback
op_assign
id|cypress_read_int_callback
comma
dot
id|write_int_callback
op_assign
id|cypress_write_int_callback
comma
)brace
suffix:semicolon
multiline_comment|/*****************************************************************************&n; * Cypress serial helper functions&n; *****************************************************************************/
multiline_comment|/* This function can either set or retreive the current serial line settings */
DECL|function|cypress_serial_control
r_static
r_int
id|cypress_serial_control
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_int
id|baud_mask
comma
r_int
id|data_bits
comma
r_int
id|stop_bits
comma
r_int
id|parity_enable
comma
r_int
id|parity_type
comma
r_int
id|reset
comma
r_int
id|cypress_request_type
)paren
(brace
r_int
id|i
comma
id|n_baud_rate
op_assign
l_int|0
comma
id|retval
op_assign
l_int|0
suffix:semicolon
r_struct
id|cypress_private
op_star
id|priv
suffix:semicolon
id|__u8
id|feature_buffer
(braket
l_int|5
)braket
suffix:semicolon
id|__u8
id|config
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|priv
op_assign
id|usb_get_serial_port_data
c_func
(paren
id|port
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cypress_request_type
)paren
(brace
r_case
id|CYPRESS_SET_CONFIG
suffix:colon
multiline_comment|/*&n;&t;&t;&t; * The general purpose firmware for the Cypress M8 allows for a maximum speed&n; &t;&t;&t; * of 57600bps (I have no idea whether DeLorme chose to use the general purpose&n;&t;&t;&t; * firmware or not), if you need to modify this speed setting for your own&n;&t;&t;&t; * project please add your own chiptype and modify the code likewise.  The&n;&t;&t;&t; * Cypress HID-&gt;COM device will work successfully up to 115200bps.&n;&t;&t;&t; */
r_if
c_cond
(paren
id|baud_mask
op_ne
id|priv-&gt;cbr_mask
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;%s - baud rate is changing&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;chiptype
op_eq
id|CT_EARTHMATE
)paren
(brace
multiline_comment|/* 300 and 600 baud rates are supported under the generic firmware,&n;&t;&t;&t;&t;&t; * but are not used with NMEA and SiRF protocols */
r_if
c_cond
(paren
(paren
id|baud_mask
op_eq
id|B300
)paren
op_logical_or
(paren
id|baud_mask
op_eq
id|B600
)paren
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s - failed setting baud rate, unsupported speed (default to 4800)&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|n_baud_rate
op_assign
l_int|4800
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|n_baud_rate
op_assign
id|mask_to_rate
c_func
(paren
id|baud_mask
)paren
)paren
op_eq
op_minus
l_int|1
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s - failed setting baud rate, unsupported speed (default to 4800)&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|n_baud_rate
op_assign
l_int|4800
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|priv-&gt;chiptype
op_eq
id|CT_CYPHIDCOM
)paren
(brace
r_if
c_cond
(paren
(paren
id|n_baud_rate
op_assign
id|mask_to_rate
c_func
(paren
id|baud_mask
)paren
)paren
op_eq
op_minus
l_int|1
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s - failed setting baud rate, unsupported speed (default to 4800)&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|n_baud_rate
op_assign
l_int|4800
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|priv-&gt;chiptype
op_eq
id|CT_GENERIC
)paren
(brace
r_if
c_cond
(paren
(paren
id|n_baud_rate
op_assign
id|mask_to_rate
c_func
(paren
id|baud_mask
)paren
)paren
op_eq
op_minus
l_int|1
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s - failed setting baud rate, unsupported speed (default to 4800)&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|n_baud_rate
op_assign
l_int|4800
suffix:semicolon
)brace
)brace
r_else
(brace
id|info
c_func
(paren
l_string|&quot;%s - please define your chiptype, using 4800bps default&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|n_baud_rate
op_assign
l_int|4800
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* baud rate not changing, keep the old */
id|n_baud_rate
op_assign
id|priv-&gt;baud_rate
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;%s - baud rate is being sent as %d&quot;
comma
id|__FUNCTION__
comma
id|n_baud_rate
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * This algorithm accredited to Jiang Jay Zhang... thanks for all the help!&n;&t;&t;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
op_increment
id|i
)paren
(brace
id|feature_buffer
(braket
id|i
)braket
op_assign
(paren
id|n_baud_rate
op_rshift
(paren
id|i
op_star
l_int|8
)paren
op_amp
l_int|0xFF
)paren
suffix:semicolon
)brace
id|config
op_assign
l_int|0
suffix:semicolon
singleline_comment|// reset config byte
id|config
op_or_assign
id|data_bits
suffix:semicolon
singleline_comment|// assign data bits in 2 bit space ( max 3 )
multiline_comment|/* 1 bit gap */
id|config
op_or_assign
(paren
id|stop_bits
op_lshift
l_int|3
)paren
suffix:semicolon
singleline_comment|// assign stop bits in 1 bit space
id|config
op_or_assign
(paren
id|parity_enable
op_lshift
l_int|4
)paren
suffix:semicolon
singleline_comment|// assign parity flag in 1 bit space
id|config
op_or_assign
(paren
id|parity_type
op_lshift
l_int|5
)paren
suffix:semicolon
singleline_comment|// assign parity type in 1 bit space
multiline_comment|/* 1 bit gap */
id|config
op_or_assign
(paren
id|reset
op_lshift
l_int|7
)paren
suffix:semicolon
singleline_comment|// assign reset at end of byte, 1 bit space
id|feature_buffer
(braket
l_int|4
)braket
op_assign
id|config
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - device is being sent this feature report:&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - %02X - %02X - %02X - %02X - %02X&quot;
comma
id|__FUNCTION__
comma
id|feature_buffer
(braket
l_int|0
)braket
comma
id|feature_buffer
(braket
l_int|1
)braket
comma
id|feature_buffer
(braket
l_int|2
)braket
comma
id|feature_buffer
(braket
l_int|3
)braket
comma
id|feature_buffer
(braket
l_int|4
)braket
)paren
suffix:semicolon
id|retval
op_assign
id|usb_control_msg
(paren
id|port-&gt;serial-&gt;dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|port-&gt;serial-&gt;dev
comma
l_int|0
)paren
comma
id|HID_REQ_SET_REPORT
comma
id|USB_DIR_OUT
op_or
id|USB_RECIP_INTERFACE
op_or
id|USB_TYPE_CLASS
comma
l_int|0x0300
comma
l_int|0
comma
id|feature_buffer
comma
l_int|5
comma
l_int|500
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
op_ne
l_int|5
)paren
id|err
c_func
(paren
l_string|&quot;%s - failed sending serial line settings - %d&quot;
comma
id|__FUNCTION__
comma
id|retval
)paren
suffix:semicolon
r_else
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|priv-&gt;baud_rate
op_assign
id|n_baud_rate
suffix:semicolon
id|priv-&gt;cbr_mask
op_assign
id|baud_mask
suffix:semicolon
id|priv-&gt;current_config
op_assign
id|config
suffix:semicolon
op_increment
id|priv-&gt;cmd_count
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|CYPRESS_GET_CONFIG
suffix:colon
id|dbg
c_func
(paren
l_string|&quot;%s - retreiving serial line settings&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
multiline_comment|/* reset values in feature buffer */
id|memset
c_func
(paren
id|feature_buffer
comma
l_int|0
comma
l_int|5
)paren
suffix:semicolon
id|retval
op_assign
id|usb_control_msg
(paren
id|port-&gt;serial-&gt;dev
comma
id|usb_rcvctrlpipe
c_func
(paren
id|port-&gt;serial-&gt;dev
comma
l_int|0
)paren
comma
id|HID_REQ_GET_REPORT
comma
id|USB_DIR_IN
op_or
id|USB_RECIP_INTERFACE
op_or
id|USB_TYPE_CLASS
comma
l_int|0x0300
comma
l_int|0
comma
id|feature_buffer
comma
l_int|5
comma
l_int|500
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
op_ne
l_int|5
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s - failed to retreive serial line settings - %d&quot;
comma
id|__FUNCTION__
comma
id|retval
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
r_else
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* store the config in one byte, and later use bit masks to check values */
id|priv-&gt;current_config
op_assign
id|feature_buffer
(braket
l_int|4
)braket
suffix:semicolon
multiline_comment|/* reverse the process above to get the baud_mask value */
id|n_baud_rate
op_assign
l_int|0
suffix:semicolon
singleline_comment|// reset bits
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
op_increment
id|i
)paren
(brace
id|n_baud_rate
op_or_assign
(paren
id|feature_buffer
(braket
id|i
)braket
op_lshift
(paren
id|i
op_star
l_int|8
)paren
)paren
suffix:semicolon
)brace
id|priv-&gt;baud_rate
op_assign
id|n_baud_rate
suffix:semicolon
r_if
c_cond
(paren
(paren
id|priv-&gt;cbr_mask
op_assign
id|rate_to_mask
c_func
(paren
id|n_baud_rate
)paren
)paren
op_eq
l_int|0x40
)paren
id|dbg
c_func
(paren
l_string|&quot;%s - failed setting the baud mask (not defined)&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
op_increment
id|priv-&gt;cmd_count
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|err
c_func
(paren
l_string|&quot;%s - unsupported serial control command issued&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
)brace
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* cypress_serial_control */
multiline_comment|/* given a baud mask, it will return speed on success */
DECL|function|mask_to_rate
r_static
r_int
id|mask_to_rate
(paren
r_int
id|mask
)paren
(brace
r_int
id|rate
suffix:semicolon
r_switch
c_cond
(paren
id|mask
)paren
(brace
r_case
id|B0
suffix:colon
id|rate
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B300
suffix:colon
id|rate
op_assign
l_int|300
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B600
suffix:colon
id|rate
op_assign
l_int|600
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B1200
suffix:colon
id|rate
op_assign
l_int|1200
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B2400
suffix:colon
id|rate
op_assign
l_int|2400
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B4800
suffix:colon
id|rate
op_assign
l_int|4800
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B9600
suffix:colon
id|rate
op_assign
l_int|9600
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B19200
suffix:colon
id|rate
op_assign
l_int|19200
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B38400
suffix:colon
id|rate
op_assign
l_int|38400
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B57600
suffix:colon
id|rate
op_assign
l_int|57600
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B115200
suffix:colon
id|rate
op_assign
l_int|115200
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|rate
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
r_return
id|rate
suffix:semicolon
)brace
DECL|function|rate_to_mask
r_static
r_int
id|rate_to_mask
(paren
r_int
id|rate
)paren
(brace
r_int
id|mask
suffix:semicolon
r_switch
c_cond
(paren
id|rate
)paren
(brace
r_case
l_int|0
suffix:colon
id|mask
op_assign
id|B0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|300
suffix:colon
id|mask
op_assign
id|B300
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|600
suffix:colon
id|mask
op_assign
id|B600
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1200
suffix:colon
id|mask
op_assign
id|B1200
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2400
suffix:colon
id|mask
op_assign
id|B2400
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4800
suffix:colon
id|mask
op_assign
id|B4800
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|9600
suffix:colon
id|mask
op_assign
id|B9600
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|19200
suffix:colon
id|mask
op_assign
id|B19200
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|38400
suffix:colon
id|mask
op_assign
id|B38400
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|57600
suffix:colon
id|mask
op_assign
id|B57600
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|115200
suffix:colon
id|mask
op_assign
id|B115200
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|mask
op_assign
l_int|0x40
suffix:semicolon
)brace
r_return
id|mask
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************&n; * Cypress serial driver functions&n; *****************************************************************************/
DECL|function|generic_startup
r_static
r_int
id|generic_startup
(paren
r_struct
id|usb_serial
op_star
id|serial
)paren
(brace
r_struct
id|cypress_private
op_star
id|priv
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - port %d&quot;
comma
id|__FUNCTION__
comma
id|serial-&gt;port
(braket
l_int|0
)braket
op_member_access_from_pointer
id|number
)paren
suffix:semicolon
id|priv
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|cypress_private
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|priv
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|priv
comma
l_int|0x00
comma
r_sizeof
(paren
r_struct
id|cypress_private
)paren
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|priv-&gt;lock
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|priv-&gt;delta_msr_wait
)paren
suffix:semicolon
id|priv-&gt;writepipe
op_assign
id|serial-&gt;port
(braket
l_int|0
)braket
op_member_access_from_pointer
id|interrupt_out_urb-&gt;pipe
suffix:semicolon
multiline_comment|/* free up interrupt_out buffer / urb allocated by usbserial&n; &t; * for this port as we use our own urbs for writing */
r_if
c_cond
(paren
id|serial-&gt;port
(braket
l_int|0
)braket
op_member_access_from_pointer
id|interrupt_out_buffer
)paren
(brace
id|kfree
c_func
(paren
id|serial-&gt;port
(braket
l_int|0
)braket
op_member_access_from_pointer
id|interrupt_out_buffer
)paren
suffix:semicolon
id|serial-&gt;port
(braket
l_int|0
)braket
op_member_access_from_pointer
id|interrupt_out_buffer
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|serial-&gt;port
(braket
l_int|0
)braket
op_member_access_from_pointer
id|interrupt_out_urb
)paren
(brace
id|priv-&gt;write_interval
op_assign
id|serial-&gt;port
(braket
l_int|0
)braket
op_member_access_from_pointer
id|interrupt_out_urb-&gt;interval
suffix:semicolon
id|usb_free_urb
c_func
(paren
id|serial-&gt;port
(braket
l_int|0
)braket
op_member_access_from_pointer
id|interrupt_out_urb
)paren
suffix:semicolon
id|serial-&gt;port
(braket
l_int|0
)braket
op_member_access_from_pointer
id|interrupt_out_urb
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
multiline_comment|/* still need a write interval */
id|priv-&gt;write_interval
op_assign
l_int|10
suffix:semicolon
id|priv-&gt;cmd_ctrl
op_assign
l_int|0
suffix:semicolon
id|priv-&gt;line_control
op_assign
l_int|0
suffix:semicolon
id|priv-&gt;termios_initialized
op_assign
l_int|0
suffix:semicolon
id|priv-&gt;rx_flags
op_assign
l_int|0
suffix:semicolon
id|usb_set_serial_port_data
c_func
(paren
id|serial-&gt;port
(braket
l_int|0
)braket
comma
id|priv
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|cypress_earthmate_startup
r_static
r_int
id|cypress_earthmate_startup
(paren
r_struct
id|usb_serial
op_star
id|serial
)paren
(brace
r_struct
id|cypress_private
op_star
id|priv
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_if
c_cond
(paren
id|generic_startup
c_func
(paren
id|serial
)paren
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;%s - Failed setting up port %d&quot;
comma
id|__FUNCTION__
comma
id|serial-&gt;port
(braket
l_int|0
)braket
op_member_access_from_pointer
id|number
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|priv
op_assign
id|usb_get_serial_port_data
c_func
(paren
id|serial-&gt;port
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|priv-&gt;chiptype
op_assign
id|CT_EARTHMATE
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* cypress_earthmate_startup */
DECL|function|cypress_hidcom_startup
r_static
r_int
id|cypress_hidcom_startup
(paren
r_struct
id|usb_serial
op_star
id|serial
)paren
(brace
r_struct
id|cypress_private
op_star
id|priv
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_if
c_cond
(paren
id|generic_startup
c_func
(paren
id|serial
)paren
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;%s - Failed setting up port %d&quot;
comma
id|__FUNCTION__
comma
id|serial-&gt;port
(braket
l_int|0
)braket
op_member_access_from_pointer
id|number
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|priv
op_assign
id|usb_get_serial_port_data
c_func
(paren
id|serial-&gt;port
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|priv-&gt;chiptype
op_assign
id|CT_CYPHIDCOM
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* cypress_hidcom_startup */
DECL|function|cypress_shutdown
r_static
r_void
id|cypress_shutdown
(paren
r_struct
id|usb_serial
op_star
id|serial
)paren
(brace
r_struct
id|cypress_private
op_star
id|priv
suffix:semicolon
id|dbg
(paren
l_string|&quot;%s - port %d&quot;
comma
id|__FUNCTION__
comma
id|serial-&gt;port
(braket
l_int|0
)braket
op_member_access_from_pointer
id|number
)paren
suffix:semicolon
multiline_comment|/* all open ports are closed at this point */
id|priv
op_assign
id|usb_get_serial_port_data
c_func
(paren
id|serial-&gt;port
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|priv
)paren
(brace
id|kfree
c_func
(paren
id|priv
)paren
suffix:semicolon
id|usb_set_serial_port_data
c_func
(paren
id|serial-&gt;port
(braket
l_int|0
)braket
comma
l_int|NULL
)paren
suffix:semicolon
)brace
)brace
DECL|function|cypress_open
r_static
r_int
id|cypress_open
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_struct
id|cypress_private
op_star
id|priv
op_assign
id|usb_get_serial_port_data
c_func
(paren
id|port
)paren
suffix:semicolon
r_struct
id|usb_serial
op_star
id|serial
op_assign
id|port-&gt;serial
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|result
op_assign
l_int|0
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - port %d&quot;
comma
id|__FUNCTION__
comma
id|port-&gt;number
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* reset read/write statistics */
id|priv-&gt;bytes_in
op_assign
l_int|0
suffix:semicolon
id|priv-&gt;bytes_out
op_assign
l_int|0
suffix:semicolon
id|priv-&gt;cmd_count
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* turn on dtr / rts since we are not flow controlling by default */
id|priv-&gt;line_control
op_assign
id|CONTROL_DTR
op_or
id|CONTROL_RTS
suffix:semicolon
multiline_comment|/* sent in status byte */
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|priv-&gt;cmd_ctrl
op_assign
l_int|1
suffix:semicolon
id|result
op_assign
id|cypress_write
c_func
(paren
id|port
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
id|port-&gt;tty-&gt;low_latency
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* termios defaults are set by usb_serial_init */
id|cypress_set_termios
c_func
(paren
id|port
comma
op_amp
id|priv-&gt;tmp_termios
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|port-&gt;dev
comma
l_string|&quot;%s - failed setting the control lines - error %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|result
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
r_else
id|dbg
c_func
(paren
l_string|&quot;%s - success setting the control lines&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
multiline_comment|/* throttling off */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|priv-&gt;rx_flags
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* setup the port and&n;&t; * start reading from the device */
r_if
c_cond
(paren
op_logical_neg
id|port-&gt;interrupt_in_urb
)paren
(brace
id|err
c_func
(paren
l_string|&quot;%s - interrupt_in_urb is empty!&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|usb_fill_int_urb
c_func
(paren
id|port-&gt;interrupt_in_urb
comma
id|serial-&gt;dev
comma
id|usb_rcvintpipe
c_func
(paren
id|serial-&gt;dev
comma
id|port-&gt;interrupt_in_endpointAddress
)paren
comma
id|port-&gt;interrupt_in_urb-&gt;transfer_buffer
comma
id|port-&gt;interrupt_in_urb-&gt;transfer_buffer_length
comma
id|cypress_read_int_callback
comma
id|port
comma
id|port-&gt;interrupt_in_urb-&gt;interval
)paren
suffix:semicolon
id|result
op_assign
id|usb_submit_urb
c_func
(paren
id|port-&gt;interrupt_in_urb
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|port-&gt;dev
comma
l_string|&quot;%s - failed submitting read urb, error %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|result
)paren
suffix:semicolon
)brace
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/* cypress_open */
DECL|function|cypress_close
r_static
r_void
id|cypress_close
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_struct
id|cypress_private
op_star
id|priv
op_assign
id|usb_get_serial_port_data
c_func
(paren
id|port
)paren
suffix:semicolon
r_int
r_int
id|c_cflag
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - port %d&quot;
comma
id|__FUNCTION__
comma
id|port-&gt;number
)paren
suffix:semicolon
r_if
c_cond
(paren
id|port-&gt;tty
)paren
(brace
id|c_cflag
op_assign
id|port-&gt;tty-&gt;termios-&gt;c_cflag
suffix:semicolon
r_if
c_cond
(paren
id|c_cflag
op_amp
id|HUPCL
)paren
(brace
multiline_comment|/* drop dtr and rts */
id|priv
op_assign
id|usb_get_serial_port_data
c_func
(paren
id|port
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|priv-&gt;line_control
op_assign
l_int|0
suffix:semicolon
id|priv-&gt;cmd_ctrl
op_assign
l_int|1
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|cypress_write
c_func
(paren
id|port
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|port-&gt;interrupt_in_urb
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;%s - stopping read urb&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|usb_kill_urb
(paren
id|port-&gt;interrupt_in_urb
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|stats
)paren
id|dev_info
(paren
op_amp
id|port-&gt;dev
comma
l_string|&quot;Statistics: %d Bytes In | %d Bytes Out | %d Commands Issued&bslash;n&quot;
comma
id|priv-&gt;bytes_in
comma
id|priv-&gt;bytes_out
comma
id|priv-&gt;cmd_count
)paren
suffix:semicolon
)brace
multiline_comment|/* cypress_close */
DECL|function|cypress_write
r_static
r_int
id|cypress_write
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_const
r_int
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_struct
id|cypress_private
op_star
id|priv
op_assign
id|usb_get_serial_port_data
c_func
(paren
id|port
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|urb
op_star
id|urb
suffix:semicolon
r_int
id|status
comma
id|s_pos
op_assign
l_int|0
suffix:semicolon
id|__u8
id|transfer_size
op_assign
l_int|0
suffix:semicolon
id|__u8
op_star
id|buffer
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - port %d&quot;
comma
id|__FUNCTION__
comma
id|port-&gt;number
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
op_eq
l_int|0
op_logical_and
op_logical_neg
id|priv-&gt;cmd_ctrl
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - write request of 0 bytes&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|priv-&gt;cmd_ctrl
)paren
op_increment
id|priv-&gt;cmd_count
suffix:semicolon
id|priv-&gt;cmd_ctrl
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - interrupt out size is %d&quot;
comma
id|__FUNCTION__
comma
id|port-&gt;interrupt_out_size
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - count is %d&quot;
comma
id|__FUNCTION__
comma
id|count
)paren
suffix:semicolon
multiline_comment|/* Allocate buffer and urb */
id|buffer
op_assign
id|kmalloc
(paren
id|port-&gt;interrupt_out_size
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|buffer
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|port-&gt;dev
comma
l_string|&quot;ran out of memory for buffer&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|urb
op_assign
id|usb_alloc_urb
(paren
l_int|0
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|urb
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|port-&gt;dev
comma
l_string|&quot;failed allocating write urb&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
(paren
id|buffer
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|buffer
comma
l_int|0
comma
id|port-&gt;interrupt_out_size
)paren
suffix:semicolon
singleline_comment|// test if this is needed... probably not since loop removed
id|spin_lock_irqsave
c_func
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|port-&gt;interrupt_out_size
)paren
(brace
r_case
l_int|32
suffix:colon
singleline_comment|// this is for the CY7C64013...
id|transfer_size
op_assign
id|min
(paren
id|count
comma
l_int|30
)paren
suffix:semicolon
id|buffer
(braket
l_int|0
)braket
op_assign
id|priv-&gt;line_control
suffix:semicolon
id|buffer
(braket
l_int|1
)braket
op_assign
id|transfer_size
suffix:semicolon
id|s_pos
op_assign
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|8
suffix:colon
singleline_comment|// this is for the CY7C63743...
id|transfer_size
op_assign
id|min
(paren
id|count
comma
l_int|7
)paren
suffix:semicolon
id|buffer
(braket
l_int|0
)braket
op_assign
id|priv-&gt;line_control
op_or
id|transfer_size
suffix:semicolon
id|s_pos
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|dbg
c_func
(paren
l_string|&quot;%s - wrong packet size&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|kfree
(paren
id|buffer
)paren
suffix:semicolon
id|usb_free_urb
(paren
id|urb
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|priv-&gt;line_control
op_amp
id|CONTROL_RESET
)paren
id|priv-&gt;line_control
op_and_assign
op_complement
id|CONTROL_RESET
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* copy data to offset position in urb transfer buffer */
id|memcpy
(paren
op_amp
id|buffer
(braket
id|s_pos
)braket
comma
id|buf
comma
id|transfer_size
)paren
suffix:semicolon
id|usb_serial_debug_data
(paren
id|debug
comma
op_amp
id|port-&gt;dev
comma
id|__FUNCTION__
comma
id|port-&gt;interrupt_out_size
comma
id|buffer
)paren
suffix:semicolon
multiline_comment|/* build up the urb */
id|usb_fill_int_urb
(paren
id|urb
comma
id|port-&gt;serial-&gt;dev
comma
id|usb_sndintpipe
c_func
(paren
id|port-&gt;serial-&gt;dev
comma
id|port-&gt;interrupt_out_endpointAddress
)paren
comma
id|buffer
comma
id|port-&gt;interrupt_out_size
comma
id|cypress_write_int_callback
comma
id|port
comma
id|priv-&gt;write_interval
)paren
suffix:semicolon
id|status
op_assign
id|usb_submit_urb
c_func
(paren
id|urb
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|port-&gt;dev
comma
l_string|&quot;%s - usb_submit_urb (write interrupt) failed with status %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|status
)paren
suffix:semicolon
id|transfer_size
op_assign
id|status
suffix:semicolon
id|kfree
(paren
id|buffer
)paren
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|priv-&gt;bytes_out
op_add_assign
id|transfer_size
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
m_exit
suffix:colon
multiline_comment|/* buffer free&squot;d in callback */
id|usb_free_urb
(paren
id|urb
)paren
suffix:semicolon
r_return
id|transfer_size
suffix:semicolon
)brace
multiline_comment|/* cypress_write */
DECL|function|cypress_write_room
r_static
r_int
id|cypress_write_room
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;%s - port %d&quot;
comma
id|__FUNCTION__
comma
id|port-&gt;number
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * We really can take anything the user throw at us&n;&t; * but let&squot;s pick a nice big number to tell the tty&n;&t; * layer that we have lots of free space&n;&t; */
r_return
l_int|2048
suffix:semicolon
)brace
DECL|function|cypress_tiocmget
r_static
r_int
id|cypress_tiocmget
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|cypress_private
op_star
id|priv
op_assign
id|usb_get_serial_port_data
c_func
(paren
id|port
)paren
suffix:semicolon
id|__u8
id|status
comma
id|control
suffix:semicolon
r_int
r_int
id|result
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - port %d&quot;
comma
id|__FUNCTION__
comma
id|port-&gt;number
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|control
op_assign
id|priv-&gt;line_control
suffix:semicolon
id|status
op_assign
id|priv-&gt;current_status
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|result
op_assign
(paren
(paren
id|control
op_amp
id|CONTROL_DTR
)paren
ques
c_cond
id|TIOCM_DTR
suffix:colon
l_int|0
)paren
op_or
(paren
(paren
id|control
op_amp
id|CONTROL_RTS
)paren
ques
c_cond
id|TIOCM_RTS
suffix:colon
l_int|0
)paren
op_or
(paren
(paren
id|status
op_amp
id|UART_CTS
)paren
ques
c_cond
id|TIOCM_CTS
suffix:colon
l_int|0
)paren
op_or
(paren
(paren
id|status
op_amp
id|UART_DSR
)paren
ques
c_cond
id|TIOCM_DSR
suffix:colon
l_int|0
)paren
op_or
(paren
(paren
id|status
op_amp
id|UART_RI
)paren
ques
c_cond
id|TIOCM_RI
suffix:colon
l_int|0
)paren
op_or
(paren
(paren
id|status
op_amp
id|UART_CD
)paren
ques
c_cond
id|TIOCM_CD
suffix:colon
l_int|0
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - result = %x&quot;
comma
id|__FUNCTION__
comma
id|result
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
DECL|function|cypress_tiocmset
r_static
r_int
id|cypress_tiocmset
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|set
comma
r_int
r_int
id|clear
)paren
(brace
r_struct
id|cypress_private
op_star
id|priv
op_assign
id|usb_get_serial_port_data
c_func
(paren
id|port
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - port %d&quot;
comma
id|__FUNCTION__
comma
id|port-&gt;number
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|set
op_amp
id|TIOCM_RTS
)paren
id|priv-&gt;line_control
op_or_assign
id|CONTROL_RTS
suffix:semicolon
r_if
c_cond
(paren
id|set
op_amp
id|TIOCM_DTR
)paren
id|priv-&gt;line_control
op_or_assign
id|CONTROL_DTR
suffix:semicolon
r_if
c_cond
(paren
id|clear
op_amp
id|TIOCM_RTS
)paren
id|priv-&gt;line_control
op_and_assign
op_complement
id|CONTROL_RTS
suffix:semicolon
r_if
c_cond
(paren
id|clear
op_amp
id|TIOCM_DTR
)paren
id|priv-&gt;line_control
op_and_assign
op_complement
id|CONTROL_DTR
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|priv-&gt;cmd_ctrl
op_assign
l_int|1
suffix:semicolon
r_return
id|cypress_write
c_func
(paren
id|port
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|cypress_ioctl
r_static
r_int
id|cypress_ioctl
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_struct
id|cypress_private
op_star
id|priv
op_assign
id|usb_get_serial_port_data
c_func
(paren
id|port
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - port %d, cmd 0x%.4x&quot;
comma
id|__FUNCTION__
comma
id|port-&gt;number
comma
id|cmd
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|TIOCGSERIAL
suffix:colon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_void
id|__user
op_star
)paren
id|arg
comma
id|port-&gt;tty-&gt;termios
comma
r_sizeof
(paren
r_struct
id|termios
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TIOCSSERIAL
suffix:colon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|port-&gt;tty-&gt;termios
comma
(paren
r_void
id|__user
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|termios
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
multiline_comment|/* here we need to call cypress_set_termios to invoke the new settings */
id|cypress_set_termios
c_func
(paren
id|port
comma
op_amp
id|priv-&gt;tmp_termios
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* these are called when setting baud rate from gpsd */
r_case
id|TCGETS
suffix:colon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_void
id|__user
op_star
)paren
id|arg
comma
id|port-&gt;tty-&gt;termios
comma
r_sizeof
(paren
r_struct
id|termios
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TCSETS
suffix:colon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|port-&gt;tty-&gt;termios
comma
(paren
r_void
id|__user
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|termios
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
multiline_comment|/* here we need to call cypress_set_termios to invoke the new settings */
id|cypress_set_termios
c_func
(paren
id|port
comma
op_amp
id|priv-&gt;tmp_termios
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* This code comes from drivers/char/serial.c and ftdi_sio.c */
r_case
id|TIOCMIWAIT
suffix:colon
r_while
c_loop
(paren
id|priv
op_ne
l_int|NULL
)paren
(brace
id|interruptible_sleep_on
c_func
(paren
op_amp
id|priv-&gt;delta_msr_wait
)paren
suffix:semicolon
multiline_comment|/* see if a signal did it */
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
r_return
op_minus
id|ERESTARTSYS
suffix:semicolon
r_else
(brace
r_char
id|diff
op_assign
id|priv-&gt;diff_status
suffix:semicolon
r_if
c_cond
(paren
id|diff
op_eq
l_int|0
)paren
(brace
r_return
op_minus
id|EIO
suffix:semicolon
multiline_comment|/* no change =&gt; error */
)brace
multiline_comment|/* consume all events */
id|priv-&gt;diff_status
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* return 0 if caller wanted to know about these bits */
r_if
c_cond
(paren
(paren
(paren
id|arg
op_amp
id|TIOCM_RNG
)paren
op_logical_and
(paren
id|diff
op_amp
id|UART_RI
)paren
)paren
op_logical_or
(paren
(paren
id|arg
op_amp
id|TIOCM_DSR
)paren
op_logical_and
(paren
id|diff
op_amp
id|UART_DSR
)paren
)paren
op_logical_or
(paren
(paren
id|arg
op_amp
id|TIOCM_CD
)paren
op_logical_and
(paren
id|diff
op_amp
id|UART_CD
)paren
)paren
op_logical_or
(paren
(paren
id|arg
op_amp
id|TIOCM_CTS
)paren
op_logical_and
(paren
id|diff
op_amp
id|UART_CTS
)paren
)paren
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* otherwise caller can&squot;t care less about what happened,&n;&t;&t;&t;&t;&t; * and so we continue to wait for more events.&n;&t;&t;&t;&t;&t; */
)brace
)brace
r_return
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;%s - arg not supported - it was 0x%04x - check include/asm/ioctls.h&quot;
comma
id|__FUNCTION__
comma
id|cmd
)paren
suffix:semicolon
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
)brace
multiline_comment|/* cypress_ioctl */
DECL|function|cypress_set_termios
r_static
r_void
id|cypress_set_termios
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|termios
op_star
id|old_termios
)paren
(brace
r_struct
id|cypress_private
op_star
id|priv
op_assign
id|usb_get_serial_port_data
c_func
(paren
id|port
)paren
suffix:semicolon
r_struct
id|tty_struct
op_star
id|tty
suffix:semicolon
r_int
id|data_bits
comma
id|stop_bits
comma
id|parity_type
comma
id|parity_enable
suffix:semicolon
r_int
id|cflag
comma
id|iflag
comma
id|baud_mask
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - port %d&quot;
comma
id|__FUNCTION__
comma
id|port-&gt;number
)paren
suffix:semicolon
id|tty
op_assign
id|port-&gt;tty
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
id|tty
)paren
op_logical_or
(paren
op_logical_neg
id|tty-&gt;termios
)paren
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;%s - no tty structures&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|priv-&gt;termios_initialized
)paren
(brace
r_if
c_cond
(paren
id|priv-&gt;chiptype
op_eq
id|CT_EARTHMATE
)paren
(brace
op_star
(paren
id|tty-&gt;termios
)paren
op_assign
id|tty_std_termios
suffix:semicolon
id|tty-&gt;termios-&gt;c_cflag
op_assign
id|B4800
op_or
id|CS8
op_or
id|CREAD
op_or
id|HUPCL
op_or
id|CLOCAL
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|priv-&gt;chiptype
op_eq
id|CT_CYPHIDCOM
)paren
(brace
op_star
(paren
id|tty-&gt;termios
)paren
op_assign
id|tty_std_termios
suffix:semicolon
id|tty-&gt;termios-&gt;c_cflag
op_assign
id|B9600
op_or
id|CS8
op_or
id|CREAD
op_or
id|HUPCL
op_or
id|CLOCAL
suffix:semicolon
)brace
id|priv-&gt;termios_initialized
op_assign
l_int|1
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|cflag
op_assign
id|tty-&gt;termios-&gt;c_cflag
suffix:semicolon
id|iflag
op_assign
id|tty-&gt;termios-&gt;c_iflag
suffix:semicolon
multiline_comment|/* check if there are new settings */
r_if
c_cond
(paren
id|old_termios
)paren
(brace
r_if
c_cond
(paren
(paren
id|cflag
op_ne
id|old_termios-&gt;c_cflag
)paren
op_logical_or
(paren
id|RELEVANT_IFLAG
c_func
(paren
id|iflag
)paren
op_ne
id|RELEVANT_IFLAG
c_func
(paren
id|old_termios-&gt;c_iflag
)paren
)paren
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;%s - attempting to set new termios settings&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
multiline_comment|/* should make a copy of this in case something goes wrong in the function, we can restore it */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|priv-&gt;tmp_termios
op_assign
op_star
(paren
id|tty-&gt;termios
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_else
(brace
id|dbg
c_func
(paren
l_string|&quot;%s - nothing to do, exiting&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
r_else
r_return
suffix:semicolon
multiline_comment|/* set number of data bits, parity, stop bits */
multiline_comment|/* when parity is disabled the parity type bit is ignored */
id|stop_bits
op_assign
id|cflag
op_amp
id|CSTOPB
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
multiline_comment|/* 1 means 2 stop bits, 0 means 1 stop bit */
r_if
c_cond
(paren
id|cflag
op_amp
id|PARENB
)paren
(brace
id|parity_enable
op_assign
l_int|1
suffix:semicolon
id|parity_type
op_assign
id|cflag
op_amp
id|PARODD
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
multiline_comment|/* 1 means odd parity, 0 means even parity */
)brace
r_else
id|parity_enable
op_assign
id|parity_type
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|cflag
op_amp
id|CSIZE
)paren
(brace
r_switch
c_cond
(paren
id|cflag
op_amp
id|CSIZE
)paren
(brace
r_case
id|CS5
suffix:colon
id|data_bits
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS6
suffix:colon
id|data_bits
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS7
suffix:colon
id|data_bits
op_assign
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS8
suffix:colon
id|data_bits
op_assign
l_int|3
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|err
c_func
(paren
l_string|&quot;%s - CSIZE was set, but not CS5-CS8&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|data_bits
op_assign
l_int|3
suffix:semicolon
)brace
)brace
r_else
id|data_bits
op_assign
l_int|3
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|cflag
op_amp
id|CBAUD
)paren
op_eq
id|B0
)paren
(brace
multiline_comment|/* drop dtr and rts */
id|dbg
c_func
(paren
l_string|&quot;%s - dropping the lines, baud rate 0bps&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|baud_mask
op_assign
id|B0
suffix:semicolon
id|priv-&gt;line_control
op_and_assign
op_complement
(paren
id|CONTROL_DTR
op_or
id|CONTROL_RTS
)paren
suffix:semicolon
)brace
r_else
(brace
id|baud_mask
op_assign
(paren
id|cflag
op_amp
id|CBAUD
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|baud_mask
)paren
(brace
r_case
id|B300
suffix:colon
id|dbg
c_func
(paren
l_string|&quot;%s - setting baud 300bps&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B600
suffix:colon
id|dbg
c_func
(paren
l_string|&quot;%s - setting baud 600bps&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B1200
suffix:colon
id|dbg
c_func
(paren
l_string|&quot;%s - setting baud 1200bps&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B2400
suffix:colon
id|dbg
c_func
(paren
l_string|&quot;%s - setting baud 2400bps&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B4800
suffix:colon
id|dbg
c_func
(paren
l_string|&quot;%s - setting baud 4800bps&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B9600
suffix:colon
id|dbg
c_func
(paren
l_string|&quot;%s - setting baud 9600bps&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B19200
suffix:colon
id|dbg
c_func
(paren
l_string|&quot;%s - setting baud 19200bps&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B38400
suffix:colon
id|dbg
c_func
(paren
l_string|&quot;%s - setting baud 38400bps&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B57600
suffix:colon
id|dbg
c_func
(paren
l_string|&quot;%s - setting baud 57600bps&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B115200
suffix:colon
id|dbg
c_func
(paren
l_string|&quot;%s - setting baud 115200bps&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|dbg
c_func
(paren
l_string|&quot;%s - unknown masked baud rate&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
)brace
id|priv-&gt;line_control
op_or_assign
id|CONTROL_DTR
suffix:semicolon
multiline_comment|/* this is probably not what I think it is... check into it */
r_if
c_cond
(paren
id|cflag
op_amp
id|CRTSCTS
)paren
id|priv-&gt;line_control
op_or_assign
id|CONTROL_RTS
suffix:semicolon
r_else
id|priv-&gt;line_control
op_and_assign
op_complement
id|CONTROL_RTS
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - sending %d stop_bits, %d parity_enable, %d parity_type, %d data_bits (+5)&quot;
comma
id|__FUNCTION__
comma
id|stop_bits
comma
id|parity_enable
comma
id|parity_type
comma
id|data_bits
)paren
suffix:semicolon
id|cypress_serial_control
c_func
(paren
id|port
comma
id|baud_mask
comma
id|data_bits
comma
id|stop_bits
comma
id|parity_enable
comma
id|parity_type
comma
l_int|0
comma
id|CYPRESS_SET_CONFIG
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
l_int|50
op_star
id|HZ
op_div
l_int|1000
)paren
suffix:semicolon
multiline_comment|/* give some time between change and read (50ms) */
multiline_comment|/* we perform a CYPRESS_GET_CONFIG so that the current settings are filled into the private structure&n;         * this should confirm that all is working if it returns what we just set */
id|cypress_serial_control
c_func
(paren
id|port
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
id|CYPRESS_GET_CONFIG
)paren
suffix:semicolon
multiline_comment|/* Here we can define custom tty settings for devices&n;         *&n;         * the main tty base comes from empeg.c&n;         */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|priv-&gt;chiptype
op_eq
id|CT_EARTHMATE
)paren
op_logical_and
(paren
id|priv-&gt;baud_rate
op_eq
l_int|4800
)paren
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;Using custom termios settings for a baud rate of 4800bps.&quot;
)paren
suffix:semicolon
multiline_comment|/* define custom termios settings for NMEA protocol */
id|tty-&gt;termios-&gt;c_iflag
multiline_comment|/* input modes - */
op_and_assign
op_complement
(paren
id|IGNBRK
multiline_comment|/* disable ignore break */
op_or
id|BRKINT
multiline_comment|/* disable break causes interrupt */
op_or
id|PARMRK
multiline_comment|/* disable mark parity errors */
op_or
id|ISTRIP
multiline_comment|/* disable clear high bit of input characters */
op_or
id|INLCR
multiline_comment|/* disable translate NL to CR */
op_or
id|IGNCR
multiline_comment|/* disable ignore CR */
op_or
id|ICRNL
multiline_comment|/* disable translate CR to NL */
op_or
id|IXON
)paren
suffix:semicolon
multiline_comment|/* disable enable XON/XOFF flow control */
id|tty-&gt;termios-&gt;c_oflag
multiline_comment|/* output modes */
op_and_assign
op_complement
id|OPOST
suffix:semicolon
multiline_comment|/* disable postprocess output characters */
id|tty-&gt;termios-&gt;c_lflag
multiline_comment|/* line discipline modes */
op_and_assign
op_complement
(paren
id|ECHO
multiline_comment|/* disable echo input characters */
op_or
id|ECHONL
multiline_comment|/* disable echo new line */
op_or
id|ICANON
multiline_comment|/* disable erase, kill, werase, and rprnt special characters */
op_or
id|ISIG
multiline_comment|/* disable interrupt, quit, and suspend special characters */
op_or
id|IEXTEN
)paren
suffix:semicolon
multiline_comment|/* disable non-POSIX special characters */
)brace
r_else
r_if
c_cond
(paren
id|priv-&gt;chiptype
op_eq
id|CT_CYPHIDCOM
)paren
(brace
singleline_comment|// Software app handling it for device...&t;
)brace
r_else
(brace
multiline_comment|/* do something here */
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* set lines */
id|priv-&gt;cmd_ctrl
op_assign
l_int|1
suffix:semicolon
id|cypress_write
c_func
(paren
id|port
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* cypress_set_termios */
DECL|function|cypress_chars_in_buffer
r_static
r_int
id|cypress_chars_in_buffer
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;%s - port %d&quot;
comma
id|__FUNCTION__
comma
id|port-&gt;number
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * We can&squot;t really account for how much data we&n;&t; * have sent out, but hasn&squot;t made it through to the&n;&t; * device, so just tell the tty layer that everything&n;&t; * is flushed.&n;&t; */
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cypress_throttle
r_static
r_void
id|cypress_throttle
(paren
r_struct
id|usb_serial_port
op_star
id|port
)paren
(brace
r_struct
id|cypress_private
op_star
id|priv
op_assign
id|usb_get_serial_port_data
c_func
(paren
id|port
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - port %d&quot;
comma
id|__FUNCTION__
comma
id|port-&gt;number
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|priv-&gt;rx_flags
op_assign
id|THROTTLED
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|cypress_unthrottle
r_static
r_void
id|cypress_unthrottle
(paren
r_struct
id|usb_serial_port
op_star
id|port
)paren
(brace
r_struct
id|cypress_private
op_star
id|priv
op_assign
id|usb_get_serial_port_data
c_func
(paren
id|port
)paren
suffix:semicolon
r_int
id|actually_throttled
comma
id|result
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - port %d&quot;
comma
id|__FUNCTION__
comma
id|port-&gt;number
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|actually_throttled
op_assign
id|priv-&gt;rx_flags
op_amp
id|ACTUALLY_THROTTLED
suffix:semicolon
id|priv-&gt;rx_flags
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|actually_throttled
)paren
(brace
id|port-&gt;interrupt_in_urb-&gt;dev
op_assign
id|port-&gt;serial-&gt;dev
suffix:semicolon
id|result
op_assign
id|usb_submit_urb
c_func
(paren
id|port-&gt;interrupt_in_urb
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
id|dev_err
c_func
(paren
op_amp
id|port-&gt;dev
comma
l_string|&quot;%s - failed submitting read urb, error %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|result
)paren
suffix:semicolon
)brace
)brace
DECL|function|cypress_read_int_callback
r_static
r_void
id|cypress_read_int_callback
c_func
(paren
r_struct
id|urb
op_star
id|urb
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|usb_serial_port
op_star
id|port
op_assign
(paren
r_struct
id|usb_serial_port
op_star
)paren
id|urb-&gt;context
suffix:semicolon
r_struct
id|cypress_private
op_star
id|priv
op_assign
id|usb_get_serial_port_data
c_func
(paren
id|port
)paren
suffix:semicolon
r_struct
id|tty_struct
op_star
id|tty
suffix:semicolon
r_int
r_char
op_star
id|data
op_assign
id|urb-&gt;transfer_buffer
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_char
id|tty_flag
op_assign
id|TTY_NORMAL
suffix:semicolon
r_int
id|bytes
op_assign
l_int|0
suffix:semicolon
r_int
id|result
suffix:semicolon
r_int
id|i
op_assign
l_int|0
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - port %d&quot;
comma
id|__FUNCTION__
comma
id|port-&gt;number
)paren
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;status
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;%s - nonzero read status received: %d&quot;
comma
id|__FUNCTION__
comma
id|urb-&gt;status
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;rx_flags
op_amp
id|THROTTLED
)paren
(brace
id|priv-&gt;rx_flags
op_or_assign
id|ACTUALLY_THROTTLED
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|tty
op_assign
id|port-&gt;tty
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tty
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;%s - bad tty pointer - exiting&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|usb_serial_debug_data
(paren
id|debug
comma
op_amp
id|port-&gt;dev
comma
id|__FUNCTION__
comma
id|urb-&gt;actual_length
comma
id|data
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|urb-&gt;actual_length
)paren
(brace
r_case
l_int|32
suffix:colon
singleline_comment|// This is for the CY7C64013...
id|priv-&gt;current_status
op_assign
id|data
(braket
l_int|0
)braket
op_amp
l_int|0xF8
suffix:semicolon
id|bytes
op_assign
id|data
(braket
l_int|1
)braket
op_plus
l_int|2
suffix:semicolon
id|i
op_assign
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|8
suffix:colon
singleline_comment|// This is for the CY7C63743...
id|priv-&gt;current_status
op_assign
id|data
(braket
l_int|0
)braket
op_amp
l_int|0xF8
suffix:semicolon
id|bytes
op_assign
(paren
id|data
(braket
l_int|0
)braket
op_amp
l_int|0x07
)paren
op_plus
l_int|1
suffix:semicolon
id|i
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|dbg
c_func
(paren
l_string|&quot;%s - wrong packet size - received %d bytes&quot;
comma
id|__FUNCTION__
comma
id|urb-&gt;actual_length
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_goto
id|continue_read
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* check to see if status has changed */
r_if
c_cond
(paren
id|priv
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|priv-&gt;current_status
op_ne
id|priv-&gt;prev_status
)paren
(brace
id|priv-&gt;diff_status
op_or_assign
id|priv-&gt;current_status
op_xor
id|priv-&gt;prev_status
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|priv-&gt;delta_msr_wait
)paren
suffix:semicolon
id|priv-&gt;prev_status
op_assign
id|priv-&gt;current_status
suffix:semicolon
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* hangup, as defined in acm.c... this might be a bad place for it though */
r_if
c_cond
(paren
id|tty
op_logical_and
op_logical_neg
(paren
id|tty-&gt;termios-&gt;c_cflag
op_amp
id|CLOCAL
)paren
op_logical_and
op_logical_neg
(paren
id|priv-&gt;current_status
op_amp
id|UART_CD
)paren
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;%s - calling hangup&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|tty_hangup
c_func
(paren
id|tty
)paren
suffix:semicolon
r_goto
id|continue_read
suffix:semicolon
)brace
multiline_comment|/* There is one error bit... I&squot;m assuming it is a parity error indicator&n;&t; * as the generic firmware will set this bit to 1 if a parity error occurs.&n;&t; * I can not find reference to any other error events.&n;&t; *&n;&t; */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;current_status
op_amp
id|CYP_ERROR
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|tty_flag
op_assign
id|TTY_PARITY
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - Parity Error detected&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
)brace
r_else
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* process read if there is data other than line status */
r_if
c_cond
(paren
id|tty
op_logical_and
(paren
id|bytes
OG
id|i
)paren
)paren
(brace
r_for
c_loop
(paren
suffix:semicolon
id|i
OL
id|bytes
suffix:semicolon
op_increment
id|i
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;pushing byte number %d - %d&quot;
comma
id|i
comma
id|data
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tty-&gt;flip.count
op_ge
id|TTY_FLIPBUF_SIZE
)paren
(brace
id|tty_flip_buffer_push
c_func
(paren
id|tty
)paren
suffix:semicolon
)brace
id|tty_insert_flip_char
c_func
(paren
id|tty
comma
id|data
(braket
id|i
)braket
comma
id|tty_flag
)paren
suffix:semicolon
)brace
id|tty_flip_buffer_push
c_func
(paren
id|port-&gt;tty
)paren
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|priv-&gt;bytes_in
op_add_assign
id|bytes
suffix:semicolon
multiline_comment|/* control and status byte(s) are also counted */
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|continue_read
suffix:colon
multiline_comment|/* Continue trying to always read... unless the port has closed.  */
r_if
c_cond
(paren
id|port-&gt;open_count
OG
l_int|0
)paren
(brace
id|usb_fill_int_urb
c_func
(paren
id|port-&gt;interrupt_in_urb
comma
id|port-&gt;serial-&gt;dev
comma
id|usb_rcvintpipe
c_func
(paren
id|port-&gt;serial-&gt;dev
comma
id|port-&gt;interrupt_in_endpointAddress
)paren
comma
id|port-&gt;interrupt_in_urb-&gt;transfer_buffer
comma
id|port-&gt;interrupt_in_urb-&gt;transfer_buffer_length
comma
id|cypress_read_int_callback
comma
id|port
comma
id|port-&gt;interrupt_in_urb-&gt;interval
)paren
suffix:semicolon
id|result
op_assign
id|usb_submit_urb
c_func
(paren
id|port-&gt;interrupt_in_urb
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
id|dev_err
c_func
(paren
op_amp
id|urb-&gt;dev-&gt;dev
comma
l_string|&quot;%s - failed resubmitting read urb, error %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|result
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/* cypress_read_int_callback */
DECL|function|cypress_write_int_callback
r_static
r_void
id|cypress_write_int_callback
c_func
(paren
r_struct
id|urb
op_star
id|urb
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|usb_serial_port
op_star
id|port
op_assign
(paren
r_struct
id|usb_serial_port
op_star
)paren
id|urb-&gt;context
suffix:semicolon
multiline_comment|/* free up the transfer buffer, as usb_free_urb() does not do this */
id|kfree
(paren
id|urb-&gt;transfer_buffer
)paren
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - port %d&quot;
comma
id|__FUNCTION__
comma
id|port-&gt;number
)paren
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;status
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;%s - nonzero write status received: %d&quot;
comma
id|__FUNCTION__
comma
id|urb-&gt;status
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|schedule_work
c_func
(paren
op_amp
id|port-&gt;work
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************&n; * Module functions&n; *****************************************************************************/
DECL|function|cypress_init
r_static
r_int
id|__init
id|cypress_init
c_func
(paren
r_void
)paren
(brace
r_int
id|retval
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|retval
op_assign
id|usb_serial_register
c_func
(paren
op_amp
id|cypress_earthmate_device
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
r_goto
id|failed_em_register
suffix:semicolon
id|retval
op_assign
id|usb_serial_register
c_func
(paren
op_amp
id|cypress_hidcom_device
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
r_goto
id|failed_hidcom_register
suffix:semicolon
id|retval
op_assign
id|usb_register
c_func
(paren
op_amp
id|cypress_driver
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
r_goto
id|failed_usb_register
suffix:semicolon
id|info
c_func
(paren
id|DRIVER_DESC
l_string|&quot; &quot;
id|DRIVER_VERSION
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|failed_usb_register
suffix:colon
id|usb_deregister
c_func
(paren
op_amp
id|cypress_driver
)paren
suffix:semicolon
id|failed_hidcom_register
suffix:colon
id|usb_serial_deregister
c_func
(paren
op_amp
id|cypress_hidcom_device
)paren
suffix:semicolon
id|failed_em_register
suffix:colon
id|usb_serial_deregister
c_func
(paren
op_amp
id|cypress_earthmate_device
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
DECL|function|cypress_exit
r_static
r_void
id|__exit
id|cypress_exit
(paren
r_void
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;%s&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|usb_deregister
(paren
op_amp
id|cypress_driver
)paren
suffix:semicolon
id|usb_serial_deregister
(paren
op_amp
id|cypress_earthmate_device
)paren
suffix:semicolon
id|usb_serial_deregister
(paren
op_amp
id|cypress_hidcom_device
)paren
suffix:semicolon
)brace
DECL|variable|cypress_init
id|module_init
c_func
(paren
id|cypress_init
)paren
suffix:semicolon
DECL|variable|cypress_exit
id|module_exit
c_func
(paren
id|cypress_exit
)paren
suffix:semicolon
DECL|variable|DRIVER_AUTHOR
id|MODULE_AUTHOR
c_func
(paren
id|DRIVER_AUTHOR
)paren
suffix:semicolon
DECL|variable|DRIVER_DESC
id|MODULE_DESCRIPTION
c_func
(paren
id|DRIVER_DESC
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|module_param
c_func
(paren
id|debug
comma
r_bool
comma
id|S_IRUGO
op_or
id|S_IWUSR
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|debug
comma
l_string|&quot;Debug enabled or not&quot;
)paren
suffix:semicolon
id|module_param
c_func
(paren
id|stats
comma
r_bool
comma
id|S_IRUGO
op_or
id|S_IWUSR
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|stats
comma
l_string|&quot;Enable statistics or not&quot;
)paren
suffix:semicolon
eof
