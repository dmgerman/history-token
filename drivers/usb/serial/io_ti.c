multiline_comment|/*&n; * Edgeport USB Serial Converter driver&n; *&n; * Copyright(c) 2000-2002 Inside Out Networks, All rights reserved.&n; * Copyright(c) 2001-2002 Greg Kroah-Hartman &lt;greg@kroah.com&gt;&n; *&n; *&t;This program is free software; you can redistribute it and/or modify&n; *&t;it under the terms of the GNU General Public License as published by&n; *&t;the Free Software Foundation; either version 2 of the License, or&n; *&t;(at your option) any later version.&n; *&n; * Supports the following devices:&n; *&t;EP/1 EP/2 EP/4&n; *&n; * Version history:&n; *&n; *&t;July 11, 2002 &t;Removed 4 port device structure since all TI UMP &n; *&t;&t;&t;chips have only 2 ports &n; *&t;&t;&t;David Iacovelli (davidi@ionetworks.com)&n; *&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/jiffies.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/tty_driver.h&gt;
macro_line|#include &lt;linux/tty_flip.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/serial.h&gt;
macro_line|#include &lt;linux/ioctl.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/usb.h&gt;
macro_line|#ifdef CONFIG_USB_SERIAL_DEBUG
DECL|variable|debug
r_static
r_int
id|debug
op_assign
l_int|1
suffix:semicolon
macro_line|#else
DECL|variable|debug
r_static
r_int
id|debug
suffix:semicolon
macro_line|#endif
macro_line|#include &quot;usb-serial.h&quot;
macro_line|#include &quot;io_16654.h&quot;
macro_line|#include &quot;io_usbvend.h&quot;
macro_line|#include &quot;io_ti.h&quot;
multiline_comment|/*&n; * Version Information&n; */
DECL|macro|DRIVER_VERSION
mdefine_line|#define DRIVER_VERSION &quot;v0.2&quot;
DECL|macro|DRIVER_AUTHOR
mdefine_line|#define DRIVER_AUTHOR &quot;Greg Kroah-Hartman &lt;greg@kroah.com&gt; and David Iacovelli&quot;
DECL|macro|DRIVER_DESC
mdefine_line|#define DRIVER_DESC &quot;Edgeport USB Serial Driver&quot;
multiline_comment|/* firmware image code */
DECL|macro|IMAGE_VERSION_NAME
mdefine_line|#define IMAGE_VERSION_NAME&t;PagableOperationalCodeImageVersion
DECL|macro|IMAGE_ARRAY_NAME
mdefine_line|#define IMAGE_ARRAY_NAME&t;PagableOperationalCodeImage
DECL|macro|IMAGE_SIZE
mdefine_line|#define IMAGE_SIZE&t;&t;PagableOperationalCodeSize
macro_line|#include &quot;io_fw_down3.h&quot;&t;/* Define array OperationalCodeImage[] */
DECL|macro|EPROM_PAGE_SIZE
mdefine_line|#define EPROM_PAGE_SIZE&t;&t;64
DECL|struct|edgeport_uart_buf_desc
r_struct
id|edgeport_uart_buf_desc
(brace
DECL|member|count
id|__u32
id|count
suffix:semicolon
singleline_comment|// Number of bytes currently in buffer
)brace
suffix:semicolon
multiline_comment|/* different hardware types */
DECL|macro|HARDWARE_TYPE_930
mdefine_line|#define HARDWARE_TYPE_930&t;0
DECL|macro|HARDWARE_TYPE_TIUMP
mdefine_line|#define HARDWARE_TYPE_TIUMP&t;1
singleline_comment|// IOCTL_PRIVATE_TI_GET_MODE Definitions
DECL|macro|TI_MODE_CONFIGURING
mdefine_line|#define&t;TI_MODE_CONFIGURING&t;0   
singleline_comment|// Device has not entered start device 
DECL|macro|TI_MODE_BOOT
mdefine_line|#define&t;TI_MODE_BOOT&t;&t;1   
singleline_comment|// Staying in boot mode
DECL|macro|TI_MODE_DOWNLOAD
mdefine_line|#define TI_MODE_DOWNLOAD&t;2   
singleline_comment|// Made it to download mode
DECL|macro|TI_MODE_TRANSITIONING
mdefine_line|#define TI_MODE_TRANSITIONING&t;3   
singleline_comment|// Currently in boot mode but transitioning to download mode
multiline_comment|/* Product information read from the Edgeport */
DECL|struct|product_info
r_struct
id|product_info
(brace
DECL|member|TiMode
r_int
id|TiMode
suffix:semicolon
singleline_comment|// Current TI Mode
DECL|member|hardware_type
id|__u8
id|hardware_type
suffix:semicolon
singleline_comment|// Type of hardware
)brace
id|__attribute__
c_func
(paren
(paren
id|packed
)paren
)paren
suffix:semicolon
DECL|struct|edgeport_port
r_struct
id|edgeport_port
(brace
DECL|member|uart_base
id|__u16
id|uart_base
suffix:semicolon
DECL|member|dma_address
id|__u16
id|dma_address
suffix:semicolon
DECL|member|shadow_msr
id|__u8
id|shadow_msr
suffix:semicolon
DECL|member|shadow_mcr
id|__u8
id|shadow_mcr
suffix:semicolon
DECL|member|shadow_lsr
id|__u8
id|shadow_lsr
suffix:semicolon
DECL|member|lsr_mask
id|__u8
id|lsr_mask
suffix:semicolon
DECL|member|ump_read_timeout
id|__u32
id|ump_read_timeout
suffix:semicolon
multiline_comment|/* Number of miliseconds the UMP will&n;&t;&t;&t;&t;&t;   wait without data before completing&n;&t;&t;&t;&t;&t;   a read short */
DECL|member|baud_rate
r_int
id|baud_rate
suffix:semicolon
DECL|member|close_pending
r_int
id|close_pending
suffix:semicolon
DECL|member|lsr_event
r_int
id|lsr_event
suffix:semicolon
DECL|member|tx
r_struct
id|edgeport_uart_buf_desc
id|tx
suffix:semicolon
DECL|member|icount
r_struct
id|async_icount
id|icount
suffix:semicolon
DECL|member|delta_msr_wait
id|wait_queue_head_t
id|delta_msr_wait
suffix:semicolon
multiline_comment|/* for handling sleeping while&n;&t;&t;&t;&t;&t;&t;   waiting for msr change to&n;&t;&t;&t;&t;&t;&t;   happen */
DECL|member|edge_serial
r_struct
id|edgeport_serial
op_star
id|edge_serial
suffix:semicolon
DECL|member|port
r_struct
id|usb_serial_port
op_star
id|port
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|edgeport_serial
r_struct
id|edgeport_serial
(brace
DECL|member|product_info
r_struct
id|product_info
id|product_info
suffix:semicolon
DECL|member|TI_I2C_Type
id|u8
id|TI_I2C_Type
suffix:semicolon
singleline_comment|// Type of I2C in UMP
DECL|member|TiReadI2C
id|u8
id|TiReadI2C
suffix:semicolon
singleline_comment|// Set to TRUE if we have read the I2c in Boot Mode
DECL|member|num_ports_open
r_int
id|num_ports_open
suffix:semicolon
DECL|member|serial
r_struct
id|usb_serial
op_star
id|serial
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* Devices that this driver supports */
DECL|variable|edgeport_1port_id_table
r_static
r_struct
id|usb_device_id
id|edgeport_1port_id_table
(braket
)braket
op_assign
(brace
(brace
id|USB_DEVICE
c_func
(paren
id|USB_VENDOR_ID_ION
comma
id|ION_DEVICE_ID_TI_EDGEPORT_1
)paren
)brace
comma
(brace
)brace
)brace
suffix:semicolon
DECL|variable|edgeport_2port_id_table
r_static
r_struct
id|usb_device_id
id|edgeport_2port_id_table
(braket
)braket
op_assign
(brace
(brace
id|USB_DEVICE
c_func
(paren
id|USB_VENDOR_ID_ION
comma
id|ION_DEVICE_ID_TI_EDGEPORT_2
)paren
)brace
comma
(brace
id|USB_DEVICE
c_func
(paren
id|USB_VENDOR_ID_ION
comma
id|ION_DEVICE_ID_TI_EDGEPORT_2I
)paren
)brace
comma
(brace
id|USB_DEVICE
c_func
(paren
id|USB_VENDOR_ID_ION
comma
id|ION_DEVICE_ID_TI_EDGEPORT_421
)paren
)brace
comma
(brace
id|USB_DEVICE
c_func
(paren
id|USB_VENDOR_ID_ION
comma
id|ION_DEVICE_ID_TI_EDGEPORT_421_BOOT
)paren
)brace
comma
(brace
id|USB_DEVICE
c_func
(paren
id|USB_VENDOR_ID_ION
comma
id|ION_DEVICE_ID_TI_EDGEPORT_421_DOWN
)paren
)brace
comma
(brace
id|USB_DEVICE
c_func
(paren
id|USB_VENDOR_ID_ION
comma
id|ION_DEVICE_ID_TI_EDGEPORT_21
)paren
)brace
comma
(brace
id|USB_DEVICE
c_func
(paren
id|USB_VENDOR_ID_ION
comma
id|ION_DEVICE_ID_TI_EDGEPORT_21_BOOT
)paren
)brace
comma
(brace
id|USB_DEVICE
c_func
(paren
id|USB_VENDOR_ID_ION
comma
id|ION_DEVICE_ID_TI_EDGEPORT_21_DOWN
)paren
)brace
comma
(brace
id|USB_DEVICE
c_func
(paren
id|USB_VENDOR_ID_ION
comma
id|ION_DEVICE_ID_TI_EDGEPORT_42
)paren
)brace
comma
(brace
id|USB_DEVICE
c_func
(paren
id|USB_VENDOR_ID_ION
comma
id|ION_DEVICE_ID_TI_EDGEPORT_4
)paren
)brace
comma
(brace
id|USB_DEVICE
c_func
(paren
id|USB_VENDOR_ID_ION
comma
id|ION_DEVICE_ID_TI_EDGEPORT_4I
)paren
)brace
comma
(brace
id|USB_DEVICE
c_func
(paren
id|USB_VENDOR_ID_ION
comma
id|ION_DEVICE_ID_TI_EDGEPORT_22
)paren
)brace
comma
(brace
)brace
)brace
suffix:semicolon
multiline_comment|/* Devices that this driver supports */
DECL|variable|id_table_combined
r_static
r_struct
id|usb_device_id
id|id_table_combined
(braket
)braket
op_assign
(brace
(brace
id|USB_DEVICE
c_func
(paren
id|USB_VENDOR_ID_ION
comma
id|ION_DEVICE_ID_TI_EDGEPORT_1
)paren
)brace
comma
(brace
id|USB_DEVICE
c_func
(paren
id|USB_VENDOR_ID_ION
comma
id|ION_DEVICE_ID_TI_EDGEPORT_2
)paren
)brace
comma
(brace
id|USB_DEVICE
c_func
(paren
id|USB_VENDOR_ID_ION
comma
id|ION_DEVICE_ID_TI_EDGEPORT_2I
)paren
)brace
comma
(brace
id|USB_DEVICE
c_func
(paren
id|USB_VENDOR_ID_ION
comma
id|ION_DEVICE_ID_TI_EDGEPORT_421
)paren
)brace
comma
(brace
id|USB_DEVICE
c_func
(paren
id|USB_VENDOR_ID_ION
comma
id|ION_DEVICE_ID_TI_EDGEPORT_421_BOOT
)paren
)brace
comma
(brace
id|USB_DEVICE
c_func
(paren
id|USB_VENDOR_ID_ION
comma
id|ION_DEVICE_ID_TI_EDGEPORT_421_DOWN
)paren
)brace
comma
(brace
id|USB_DEVICE
c_func
(paren
id|USB_VENDOR_ID_ION
comma
id|ION_DEVICE_ID_TI_EDGEPORT_21
)paren
)brace
comma
(brace
id|USB_DEVICE
c_func
(paren
id|USB_VENDOR_ID_ION
comma
id|ION_DEVICE_ID_TI_EDGEPORT_21_BOOT
)paren
)brace
comma
(brace
id|USB_DEVICE
c_func
(paren
id|USB_VENDOR_ID_ION
comma
id|ION_DEVICE_ID_TI_EDGEPORT_21_DOWN
)paren
)brace
comma
(brace
id|USB_DEVICE
c_func
(paren
id|USB_VENDOR_ID_ION
comma
id|ION_DEVICE_ID_TI_EDGEPORT_42
)paren
)brace
comma
(brace
id|USB_DEVICE
c_func
(paren
id|USB_VENDOR_ID_ION
comma
id|ION_DEVICE_ID_TI_EDGEPORT_4
)paren
)brace
comma
(brace
id|USB_DEVICE
c_func
(paren
id|USB_VENDOR_ID_ION
comma
id|ION_DEVICE_ID_TI_EDGEPORT_4I
)paren
)brace
comma
(brace
id|USB_DEVICE
c_func
(paren
id|USB_VENDOR_ID_ION
comma
id|ION_DEVICE_ID_TI_EDGEPORT_22
)paren
)brace
comma
(brace
)brace
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
(paren
id|usb
comma
id|id_table_combined
)paren
suffix:semicolon
DECL|variable|io_driver
r_static
r_struct
id|usb_driver
id|io_driver
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|name
op_assign
l_string|&quot;io_ti&quot;
comma
dot
id|probe
op_assign
id|usb_serial_probe
comma
dot
id|disconnect
op_assign
id|usb_serial_disconnect
comma
dot
id|id_table
op_assign
id|id_table_combined
comma
)brace
suffix:semicolon
DECL|variable|OperationalCodeImageVersion
r_static
r_struct
id|EDGE_FIRMWARE_VERSION_INFO
id|OperationalCodeImageVersion
suffix:semicolon
DECL|variable|TIStayInBootMode
r_static
r_int
id|TIStayInBootMode
op_assign
l_int|0
suffix:semicolon
DECL|variable|ignore_cpu_rev
r_static
r_int
id|ignore_cpu_rev
op_assign
l_int|0
suffix:semicolon
r_static
r_void
id|edge_set_termios
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|termios
op_star
id|old_termios
)paren
suffix:semicolon
DECL|function|TIReadVendorRequestSync
r_static
r_int
id|TIReadVendorRequestSync
(paren
r_struct
id|usb_device
op_star
id|dev
comma
id|__u8
id|request
comma
id|__u16
id|value
comma
id|__u16
id|index
comma
id|u8
op_star
id|data
comma
r_int
id|size
)paren
(brace
r_int
id|status
suffix:semicolon
id|status
op_assign
id|usb_control_msg
(paren
id|dev
comma
id|usb_rcvctrlpipe
c_func
(paren
id|dev
comma
l_int|0
)paren
comma
id|request
comma
(paren
id|USB_TYPE_VENDOR
op_or
id|USB_RECIP_DEVICE
op_or
id|USB_DIR_IN
)paren
comma
id|value
comma
id|index
comma
id|data
comma
id|size
comma
id|HZ
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
OL
l_int|0
)paren
r_return
id|status
suffix:semicolon
r_if
c_cond
(paren
id|status
op_ne
id|size
)paren
(brace
id|dbg
(paren
l_string|&quot;%s - wanted to write %d, but only wrote %d&quot;
comma
id|__FUNCTION__
comma
id|size
comma
id|status
)paren
suffix:semicolon
r_return
op_minus
id|ECOMM
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|TISendVendorRequestSync
r_static
r_int
id|TISendVendorRequestSync
(paren
r_struct
id|usb_device
op_star
id|dev
comma
id|__u8
id|request
comma
id|__u16
id|value
comma
id|__u16
id|index
comma
id|u8
op_star
id|data
comma
r_int
id|size
)paren
(brace
r_int
id|status
suffix:semicolon
id|status
op_assign
id|usb_control_msg
(paren
id|dev
comma
id|usb_sndctrlpipe
c_func
(paren
id|dev
comma
l_int|0
)paren
comma
id|request
comma
(paren
id|USB_TYPE_VENDOR
op_or
id|USB_RECIP_DEVICE
op_or
id|USB_DIR_OUT
)paren
comma
id|value
comma
id|index
comma
id|data
comma
id|size
comma
id|HZ
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
OL
l_int|0
)paren
r_return
id|status
suffix:semicolon
r_if
c_cond
(paren
id|status
op_ne
id|size
)paren
(brace
id|dbg
(paren
l_string|&quot;%s - wanted to write %d, but only wrote %d&quot;
comma
id|__FUNCTION__
comma
id|size
comma
id|status
)paren
suffix:semicolon
r_return
op_minus
id|ECOMM
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|TIWriteCommandSync
r_static
r_int
id|TIWriteCommandSync
(paren
r_struct
id|usb_device
op_star
id|dev
comma
id|__u8
id|command
comma
id|__u8
id|moduleid
comma
id|__u16
id|value
comma
id|u8
op_star
id|data
comma
r_int
id|size
)paren
(brace
r_return
id|TISendVendorRequestSync
(paren
id|dev
comma
id|command
comma
singleline_comment|// Request
id|value
comma
singleline_comment|// wValue 
id|moduleid
comma
singleline_comment|// wIndex
id|data
comma
singleline_comment|// TransferBuffer
id|size
)paren
suffix:semicolon
singleline_comment|// TransferBufferLength
)brace
multiline_comment|/* clear tx/rx buffers and fifo in TI UMP */
DECL|function|TIPurgeDataSync
r_static
r_int
id|TIPurgeDataSync
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
id|__u16
id|mask
)paren
(brace
r_int
id|port_number
op_assign
id|port-&gt;number
op_minus
id|port-&gt;serial-&gt;minor
suffix:semicolon
id|dbg
(paren
l_string|&quot;%s - port %d, mask %x&quot;
comma
id|__FUNCTION__
comma
id|port_number
comma
id|mask
)paren
suffix:semicolon
r_return
id|TIWriteCommandSync
(paren
id|port-&gt;serial-&gt;dev
comma
id|UMPC_PURGE_PORT
comma
(paren
id|__u8
)paren
(paren
id|UMPM_UART1_PORT
op_plus
id|port_number
)paren
comma
id|mask
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * TIReadDownloadMemory - Read edgeport memory from TI chip&n; * @dev: usb device pointer&n; * @address: Device CPU address at which to read&n; * @length: Length of above data&n; * @address_type: Can read both XDATA and I2C&n; * @buffer: pointer to input data buffer&n; */
DECL|function|TIReadDownloadMemory
r_int
id|TIReadDownloadMemory
(paren
r_struct
id|usb_device
op_star
id|dev
comma
r_int
id|start_address
comma
r_int
id|length
comma
id|__u8
id|address_type
comma
id|__u8
op_star
id|buffer
)paren
(brace
r_int
id|status
op_assign
l_int|0
suffix:semicolon
id|__u8
id|read_length
suffix:semicolon
id|__u16
id|be_start_address
suffix:semicolon
id|dbg
(paren
l_string|&quot;%s - @ %x for %d&quot;
comma
id|__FUNCTION__
comma
id|start_address
comma
id|length
)paren
suffix:semicolon
multiline_comment|/* Read in blocks of 64 bytes&n;&t; * (TI firmware can&squot;t handle more than 64 byte reads)&n;&t; */
r_while
c_loop
(paren
id|length
)paren
(brace
r_if
c_cond
(paren
id|length
OG
l_int|64
)paren
id|read_length
op_assign
l_int|64
suffix:semicolon
r_else
id|read_length
op_assign
(paren
id|__u8
)paren
id|length
suffix:semicolon
r_if
c_cond
(paren
id|read_length
OG
l_int|1
)paren
(brace
id|dbg
(paren
l_string|&quot;%s - @ %x for %d&quot;
comma
id|__FUNCTION__
comma
id|start_address
comma
id|read_length
)paren
suffix:semicolon
)brace
id|be_start_address
op_assign
id|cpu_to_be16
(paren
id|start_address
)paren
suffix:semicolon
id|status
op_assign
id|TIReadVendorRequestSync
(paren
id|dev
comma
id|UMPC_MEMORY_READ
comma
singleline_comment|// Request
(paren
id|__u16
)paren
id|address_type
comma
singleline_comment|// wValue (Address type)
id|be_start_address
comma
singleline_comment|// wIndex (Address to read)
id|buffer
comma
singleline_comment|// TransferBuffer
id|read_length
)paren
suffix:semicolon
singleline_comment|// TransferBufferLength
r_if
c_cond
(paren
id|status
)paren
(brace
id|dbg
(paren
l_string|&quot;%s - ERROR %x&quot;
comma
id|__FUNCTION__
comma
id|status
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
r_if
c_cond
(paren
id|read_length
OG
l_int|1
)paren
(brace
id|usb_serial_debug_data
(paren
id|__FILE__
comma
id|__FUNCTION__
comma
id|read_length
comma
id|buffer
)paren
suffix:semicolon
)brace
multiline_comment|/* Update pointers/length */
id|start_address
op_add_assign
id|read_length
suffix:semicolon
id|buffer
op_add_assign
id|read_length
suffix:semicolon
id|length
op_sub_assign
id|read_length
suffix:semicolon
)brace
r_return
id|status
suffix:semicolon
)brace
DECL|function|TIReadRam
r_int
id|TIReadRam
(paren
r_struct
id|usb_device
op_star
id|dev
comma
r_int
id|start_address
comma
r_int
id|length
comma
id|__u8
op_star
id|buffer
)paren
(brace
r_return
id|TIReadDownloadMemory
(paren
id|dev
comma
id|start_address
comma
id|length
comma
id|DTK_ADDR_SPACE_XDATA
comma
id|buffer
)paren
suffix:semicolon
)brace
multiline_comment|/* Read edgeport memory to a given block */
DECL|function|TIReadBootMemory
r_static
r_int
id|TIReadBootMemory
(paren
r_struct
id|edgeport_serial
op_star
id|serial
comma
r_int
id|start_address
comma
r_int
id|length
comma
id|__u8
op_star
id|buffer
)paren
(brace
r_int
id|status
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|length
suffix:semicolon
id|i
op_increment
)paren
(brace
id|status
op_assign
id|TIReadVendorRequestSync
(paren
id|serial-&gt;serial-&gt;dev
comma
id|UMPC_MEMORY_READ
comma
singleline_comment|// Request
id|serial-&gt;TI_I2C_Type
comma
singleline_comment|// wValue (Address type)
(paren
id|__u16
)paren
(paren
id|start_address
op_plus
id|i
)paren
comma
singleline_comment|// wIndex
op_amp
id|buffer
(braket
id|i
)braket
comma
singleline_comment|// TransferBuffer
l_int|0x01
)paren
suffix:semicolon
singleline_comment|// TransferBufferLength
r_if
c_cond
(paren
id|status
)paren
(brace
id|dbg
(paren
l_string|&quot;%s - ERROR %x&quot;
comma
id|__FUNCTION__
comma
id|status
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
)brace
id|dbg
(paren
l_string|&quot;%s - start_address = %x, length = %d&quot;
comma
id|__FUNCTION__
comma
id|start_address
comma
id|length
)paren
suffix:semicolon
id|usb_serial_debug_data
(paren
id|__FILE__
comma
id|__FUNCTION__
comma
id|length
comma
id|buffer
)paren
suffix:semicolon
id|serial-&gt;TiReadI2C
op_assign
l_int|1
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/* Write given block to TI EPROM memory */
DECL|function|TIWriteBootMemory
r_static
r_int
id|TIWriteBootMemory
(paren
r_struct
id|edgeport_serial
op_star
id|serial
comma
r_int
id|start_address
comma
r_int
id|length
comma
id|__u8
op_star
id|buffer
)paren
(brace
r_int
id|status
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
id|__u8
id|temp
suffix:semicolon
multiline_comment|/* Must do a read before write */
r_if
c_cond
(paren
op_logical_neg
id|serial-&gt;TiReadI2C
)paren
(brace
id|status
op_assign
id|TIReadBootMemory
c_func
(paren
id|serial
comma
l_int|0
comma
l_int|1
comma
op_amp
id|temp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
r_return
id|status
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|length
suffix:semicolon
op_increment
id|i
)paren
(brace
id|status
op_assign
id|TISendVendorRequestSync
(paren
id|serial-&gt;serial-&gt;dev
comma
id|UMPC_MEMORY_WRITE
comma
singleline_comment|// Request
id|buffer
(braket
id|i
)braket
comma
singleline_comment|// wValue
(paren
id|__u16
)paren
(paren
id|i
op_plus
id|start_address
)paren
comma
singleline_comment|// wIndex
l_int|NULL
comma
singleline_comment|// TransferBuffer
l_int|0
)paren
suffix:semicolon
singleline_comment|// TransferBufferLength
r_if
c_cond
(paren
id|status
)paren
r_return
id|status
suffix:semicolon
)brace
id|dbg
(paren
l_string|&quot;%s - start_sddr = %x, length = %d&quot;
comma
id|__FUNCTION__
comma
id|start_address
comma
id|length
)paren
suffix:semicolon
id|usb_serial_debug_data
(paren
id|__FILE__
comma
id|__FUNCTION__
comma
id|length
comma
id|buffer
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/* Write edgeport I2C memory to TI chip&t;*/
DECL|function|TIWriteDownloadI2C
r_static
r_int
id|TIWriteDownloadI2C
(paren
r_struct
id|edgeport_serial
op_star
id|serial
comma
r_int
id|start_address
comma
r_int
id|length
comma
id|__u8
id|address_type
comma
id|__u8
op_star
id|buffer
)paren
(brace
r_int
id|status
op_assign
l_int|0
suffix:semicolon
r_int
id|write_length
suffix:semicolon
id|__u16
id|be_start_address
suffix:semicolon
multiline_comment|/* We can only send a maximum of 1 aligned byte page at a time */
multiline_comment|/* calulate the number of bytes left in the first page */
id|write_length
op_assign
id|EPROM_PAGE_SIZE
op_minus
(paren
id|start_address
op_amp
(paren
id|EPROM_PAGE_SIZE
op_minus
l_int|1
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|write_length
OG
id|length
)paren
id|write_length
op_assign
id|length
suffix:semicolon
id|dbg
(paren
l_string|&quot;%s - BytesInFirstPage Addr = %x, length = %d&quot;
comma
id|__FUNCTION__
comma
id|start_address
comma
id|write_length
)paren
suffix:semicolon
id|usb_serial_debug_data
(paren
id|__FILE__
comma
id|__FUNCTION__
comma
id|write_length
comma
id|buffer
)paren
suffix:semicolon
multiline_comment|/* Write first page */
id|be_start_address
op_assign
id|cpu_to_be16
(paren
id|start_address
)paren
suffix:semicolon
id|status
op_assign
id|TISendVendorRequestSync
(paren
id|serial-&gt;serial-&gt;dev
comma
id|UMPC_MEMORY_WRITE
comma
singleline_comment|// Request
(paren
id|__u16
)paren
id|address_type
comma
singleline_comment|// wValue
id|be_start_address
comma
singleline_comment|// wIndex
id|buffer
comma
singleline_comment|// TransferBuffer
id|write_length
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
(brace
id|dbg
(paren
l_string|&quot;%s - ERROR %d&quot;
comma
id|__FUNCTION__
comma
id|status
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
id|length
op_sub_assign
id|write_length
suffix:semicolon
id|start_address
op_add_assign
id|write_length
suffix:semicolon
id|buffer
op_add_assign
id|write_length
suffix:semicolon
multiline_comment|/* We should be aligned now -- can write max page size bytes at a time */
r_while
c_loop
(paren
id|length
)paren
(brace
r_if
c_cond
(paren
id|length
OG
id|EPROM_PAGE_SIZE
)paren
id|write_length
op_assign
id|EPROM_PAGE_SIZE
suffix:semicolon
r_else
id|write_length
op_assign
id|length
suffix:semicolon
id|dbg
(paren
l_string|&quot;%s - Page Write Addr = %x, length = %d&quot;
comma
id|__FUNCTION__
comma
id|start_address
comma
id|write_length
)paren
suffix:semicolon
id|usb_serial_debug_data
(paren
id|__FILE__
comma
id|__FUNCTION__
comma
id|write_length
comma
id|buffer
)paren
suffix:semicolon
multiline_comment|/* Write next page */
id|be_start_address
op_assign
id|cpu_to_be16
(paren
id|start_address
)paren
suffix:semicolon
id|status
op_assign
id|TISendVendorRequestSync
(paren
id|serial-&gt;serial-&gt;dev
comma
id|UMPC_MEMORY_WRITE
comma
singleline_comment|// Request
(paren
id|__u16
)paren
id|address_type
comma
singleline_comment|// wValue
id|be_start_address
comma
singleline_comment|// wIndex
id|buffer
comma
singleline_comment|// TransferBuffer
id|write_length
)paren
suffix:semicolon
singleline_comment|// TransferBufferLength
r_if
c_cond
(paren
id|status
)paren
(brace
id|dbg
(paren
l_string|&quot;%s - ERROR %d&quot;
comma
id|__FUNCTION__
comma
id|status
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
id|length
op_sub_assign
id|write_length
suffix:semicolon
id|start_address
op_add_assign
id|write_length
suffix:semicolon
id|buffer
op_add_assign
id|write_length
suffix:semicolon
)brace
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/* Examine the UMP DMA registers and LSR&n; * &n; * Check the MSBit of the X and Y DMA byte count registers.&n; * A zero in this bit indicates that the TX DMA buffers are empty&n; * then check the TX Empty bit in the UART.&n; */
DECL|function|TIIsTxActive
r_static
r_int
id|TIIsTxActive
(paren
r_struct
id|edgeport_port
op_star
id|port
)paren
(brace
r_int
id|status
suffix:semicolon
r_struct
id|out_endpoint_desc_block
op_star
id|oedb
suffix:semicolon
id|__u8
op_star
id|lsr
suffix:semicolon
r_int
id|bytes_left
op_assign
l_int|0
suffix:semicolon
id|oedb
op_assign
id|kmalloc
(paren
r_sizeof
(paren
op_star
id|oedb
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|oedb
)paren
(brace
id|dev_err
(paren
op_amp
id|port-&gt;port-&gt;dev
comma
l_string|&quot;%s - out of memory&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|lsr
op_assign
id|kmalloc
(paren
l_int|1
comma
id|GFP_KERNEL
)paren
suffix:semicolon
multiline_comment|/* Sigh, that&squot;s right, just one byte,&n;&t;&t;&t;&t;&t;   as not all platforms can do DMA&n;&t;&t;&t;&t;&t;   from stack */
r_if
c_cond
(paren
op_logical_neg
id|lsr
)paren
(brace
id|kfree
c_func
(paren
id|oedb
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/* Read the DMA Count Registers */
id|status
op_assign
id|TIReadRam
(paren
id|port-&gt;port-&gt;serial-&gt;dev
comma
id|port-&gt;dma_address
comma
r_sizeof
(paren
op_star
id|oedb
)paren
comma
(paren
r_void
op_star
)paren
id|oedb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
r_goto
id|exit_is_tx_active
suffix:semicolon
id|dbg
(paren
l_string|&quot;%s - XByteCount    0x%X&quot;
comma
id|__FUNCTION__
comma
id|oedb-&gt;XByteCount
)paren
suffix:semicolon
multiline_comment|/* and the LSR */
id|status
op_assign
id|TIReadRam
(paren
id|port-&gt;port-&gt;serial-&gt;dev
comma
id|port-&gt;uart_base
op_plus
id|UMPMEM_OFFS_UART_LSR
comma
l_int|1
comma
id|lsr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
r_goto
id|exit_is_tx_active
suffix:semicolon
id|dbg
(paren
l_string|&quot;%s - LSR = 0x%X&quot;
comma
id|__FUNCTION__
comma
op_star
id|lsr
)paren
suffix:semicolon
multiline_comment|/* If either buffer has data or we are transmitting then return TRUE */
r_if
c_cond
(paren
(paren
id|oedb-&gt;XByteCount
op_amp
l_int|0x80
)paren
op_ne
l_int|0
)paren
id|bytes_left
op_add_assign
l_int|64
suffix:semicolon
r_if
c_cond
(paren
(paren
op_star
id|lsr
op_amp
id|UMP_UART_LSR_TX_MASK
)paren
op_eq
l_int|0
)paren
id|bytes_left
op_add_assign
l_int|1
suffix:semicolon
multiline_comment|/* We return Not Active if we get any kind of error */
id|exit_is_tx_active
suffix:colon
id|dbg
(paren
l_string|&quot;%s - return %d&quot;
comma
id|__FUNCTION__
comma
id|bytes_left
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|lsr
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|oedb
)paren
suffix:semicolon
r_return
id|bytes_left
suffix:semicolon
)brace
DECL|function|TIChasePort
r_static
r_void
id|TIChasePort
c_func
(paren
r_struct
id|edgeport_port
op_star
id|port
)paren
(brace
r_int
id|loops
suffix:semicolon
r_int
id|last_count
suffix:semicolon
r_int
id|write_size
suffix:semicolon
id|restart_tx_loop
suffix:colon
singleline_comment|// Base the LoopTime on the baud rate
r_if
c_cond
(paren
id|port-&gt;baud_rate
op_eq
l_int|0
)paren
id|port-&gt;baud_rate
op_assign
l_int|1200
suffix:semicolon
id|write_size
op_assign
id|port-&gt;tx.count
suffix:semicolon
id|loops
op_assign
id|max
c_func
(paren
l_int|100
comma
(paren
l_int|100
op_star
id|write_size
)paren
op_div
(paren
id|port-&gt;baud_rate
op_div
l_int|10
)paren
)paren
suffix:semicolon
id|dbg
(paren
l_string|&quot;%s - write_size %d, baud %d loop = %d&quot;
comma
id|__FUNCTION__
comma
id|write_size
comma
id|port-&gt;baud_rate
comma
id|loops
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
singleline_comment|// Save Last count
id|last_count
op_assign
id|port-&gt;tx.count
suffix:semicolon
id|dbg
(paren
l_string|&quot;%s - Tx Buffer Size = %d loops = %d&quot;
comma
id|__FUNCTION__
comma
id|last_count
comma
id|loops
)paren
suffix:semicolon
multiline_comment|/* Is the Edgeport Buffer empty? */
r_if
c_cond
(paren
id|port-&gt;tx.count
op_eq
l_int|0
)paren
r_break
suffix:semicolon
multiline_comment|/* Block the thread for 10ms */
id|wait_ms
(paren
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|last_count
op_eq
id|port-&gt;tx.count
)paren
(brace
multiline_comment|/* No activity.. count down. */
op_decrement
id|loops
suffix:semicolon
r_if
c_cond
(paren
id|loops
op_eq
l_int|0
)paren
(brace
id|dbg
(paren
l_string|&quot;%s - Wait for TxEmpty - TIMEOUT&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* Reset timeout value back to a minimum of 1 second */
id|dbg
(paren
l_string|&quot;%s - Wait for TxEmpty  Reset Count&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_goto
id|restart_tx_loop
suffix:semicolon
)brace
)brace
id|dbg
(paren
l_string|&quot;%s - Local Tx Buffer Empty -- Waiting for TI UMP to EMPTY X/Y and FIFO&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|write_size
op_assign
id|TIIsTxActive
(paren
id|port
)paren
suffix:semicolon
id|loops
op_assign
id|max
c_func
(paren
l_int|50
comma
(paren
l_int|100
op_star
id|write_size
)paren
op_div
(paren
id|port-&gt;baud_rate
op_div
l_int|10
)paren
)paren
suffix:semicolon
id|dbg
(paren
l_string|&quot;%s - write_size %d, baud %d loop = %d&quot;
comma
id|__FUNCTION__
comma
id|write_size
comma
id|port-&gt;baud_rate
comma
id|loops
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
multiline_comment|/* This function takes 4 ms; */
r_if
c_cond
(paren
op_logical_neg
id|TIIsTxActive
(paren
id|port
)paren
)paren
(brace
multiline_comment|/* Delay a few char times */
id|wait_ms
(paren
l_int|50
)paren
suffix:semicolon
id|dbg
(paren
l_string|&quot;%s - Empty&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
op_decrement
id|loops
suffix:semicolon
r_if
c_cond
(paren
id|loops
op_eq
l_int|0
)paren
(brace
id|dbg
(paren
l_string|&quot;%s - TIMEOUT&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
)brace
DECL|function|TIChooseConfiguration
r_static
r_int
id|TIChooseConfiguration
(paren
r_struct
id|usb_device
op_star
id|dev
)paren
(brace
singleline_comment|// There may be multiple configurations on this device, in which case
singleline_comment|// we would need to read and parse all of them to find out which one
singleline_comment|// we want. However, we just support one config at this point,
singleline_comment|// configuration # 1, which is Config Descriptor 0.
id|dbg
(paren
l_string|&quot;%s - Number of Interfaces = %d&quot;
comma
id|__FUNCTION__
comma
id|dev-&gt;config-&gt;desc.bNumInterfaces
)paren
suffix:semicolon
id|dbg
(paren
l_string|&quot;%s - MAX Power            = %d&quot;
comma
id|__FUNCTION__
comma
id|dev-&gt;config-&gt;desc.bMaxPower
op_star
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;config-&gt;desc.bNumInterfaces
op_ne
l_int|1
)paren
(brace
id|dev_err
(paren
op_amp
id|dev-&gt;dev
comma
l_string|&quot;%s - bNumInterfaces is not 1, ERROR!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|TIReadRom
r_int
id|TIReadRom
(paren
r_struct
id|edgeport_serial
op_star
id|serial
comma
r_int
id|start_address
comma
r_int
id|length
comma
id|__u8
op_star
id|buffer
)paren
(brace
r_int
id|status
suffix:semicolon
r_if
c_cond
(paren
id|serial-&gt;product_info.TiMode
op_eq
id|TI_MODE_DOWNLOAD
)paren
(brace
id|status
op_assign
id|TIReadDownloadMemory
(paren
id|serial-&gt;serial-&gt;dev
comma
id|start_address
comma
id|length
comma
id|serial-&gt;TI_I2C_Type
comma
id|buffer
)paren
suffix:semicolon
)brace
r_else
(brace
id|status
op_assign
id|TIReadBootMemory
(paren
id|serial
comma
id|start_address
comma
id|length
comma
id|buffer
)paren
suffix:semicolon
)brace
r_return
id|status
suffix:semicolon
)brace
DECL|function|TIWriteRom
r_int
id|TIWriteRom
(paren
r_struct
id|edgeport_serial
op_star
id|serial
comma
r_int
id|start_address
comma
r_int
id|length
comma
id|__u8
op_star
id|buffer
)paren
(brace
r_if
c_cond
(paren
id|serial-&gt;product_info.TiMode
op_eq
id|TI_MODE_BOOT
)paren
r_return
id|TIWriteBootMemory
(paren
id|serial
comma
id|start_address
comma
id|length
comma
id|buffer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|serial-&gt;product_info.TiMode
op_eq
id|TI_MODE_DOWNLOAD
)paren
r_return
id|TIWriteDownloadI2C
(paren
id|serial
comma
id|start_address
comma
id|length
comma
id|serial-&gt;TI_I2C_Type
comma
id|buffer
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* Read a descriptor header from I2C based on type */
DECL|function|TIGetDescriptorAddress
r_static
r_int
id|TIGetDescriptorAddress
(paren
r_struct
id|edgeport_serial
op_star
id|serial
comma
r_int
id|desc_type
comma
r_struct
id|ti_i2c_desc
op_star
id|rom_desc
)paren
(brace
r_int
id|start_address
suffix:semicolon
r_int
id|status
suffix:semicolon
multiline_comment|/* Search for requested descriptor in I2C */
id|start_address
op_assign
l_int|2
suffix:semicolon
r_do
(brace
id|status
op_assign
id|TIReadRom
(paren
id|serial
comma
id|start_address
comma
r_sizeof
(paren
r_struct
id|ti_i2c_desc
)paren
comma
(paren
id|__u8
op_star
)paren
id|rom_desc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|rom_desc-&gt;Type
op_eq
id|desc_type
)paren
r_return
id|start_address
suffix:semicolon
id|start_address
op_assign
id|start_address
op_plus
r_sizeof
(paren
r_struct
id|ti_i2c_desc
)paren
op_plus
id|rom_desc-&gt;Size
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|start_address
OL
id|TI_MAX_I2C_SIZE
)paren
op_logical_and
id|rom_desc-&gt;Type
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Validate descriptor checksum */
DECL|function|ValidChecksum
r_static
r_int
id|ValidChecksum
c_func
(paren
r_struct
id|ti_i2c_desc
op_star
id|rom_desc
comma
id|__u8
op_star
id|buffer
)paren
(brace
id|__u16
id|i
suffix:semicolon
id|__u8
id|cs
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|rom_desc-&gt;Size
suffix:semicolon
id|i
op_increment
)paren
(brace
id|cs
op_assign
(paren
id|__u8
)paren
(paren
id|cs
op_plus
id|buffer
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cs
op_ne
id|rom_desc-&gt;CheckSum
)paren
(brace
id|dbg
(paren
l_string|&quot;%s - Mismatch %x - %x&quot;
comma
id|__FUNCTION__
comma
id|rom_desc-&gt;CheckSum
comma
id|cs
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Make sure that the I2C image is good */
DECL|function|TiValidateI2cImage
r_static
r_int
id|TiValidateI2cImage
(paren
r_struct
id|edgeport_serial
op_star
id|serial
)paren
(brace
r_struct
id|device
op_star
id|dev
op_assign
op_amp
id|serial-&gt;serial-&gt;dev-&gt;dev
suffix:semicolon
r_int
id|status
op_assign
l_int|0
suffix:semicolon
r_struct
id|ti_i2c_desc
op_star
id|rom_desc
suffix:semicolon
r_int
id|start_address
op_assign
l_int|2
suffix:semicolon
id|__u8
op_star
id|buffer
suffix:semicolon
id|rom_desc
op_assign
id|kmalloc
(paren
r_sizeof
(paren
op_star
id|rom_desc
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rom_desc
)paren
(brace
id|dev_err
(paren
id|dev
comma
l_string|&quot;%s - out of memory&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|buffer
op_assign
id|kmalloc
(paren
id|TI_MAX_I2C_SIZE
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|buffer
)paren
(brace
id|dev_err
(paren
id|dev
comma
l_string|&quot;%s - out of memory when allocating buffer&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|kfree
(paren
id|rom_desc
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
singleline_comment|// Read the first byte (Signature0) must be 0x52
id|status
op_assign
id|TIReadRom
(paren
id|serial
comma
l_int|0
comma
l_int|1
comma
id|buffer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
r_goto
id|ExitTiValidateI2cImage
suffix:semicolon
r_if
c_cond
(paren
op_star
id|buffer
op_ne
l_int|0x52
)paren
(brace
id|dev_err
(paren
id|dev
comma
l_string|&quot;%s - invalid buffer signature&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|status
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|ExitTiValidateI2cImage
suffix:semicolon
)brace
r_do
(brace
singleline_comment|// Validate the I2C
id|status
op_assign
id|TIReadRom
(paren
id|serial
comma
id|start_address
comma
r_sizeof
(paren
r_struct
id|ti_i2c_desc
)paren
comma
(paren
id|__u8
op_star
)paren
id|rom_desc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
(paren
id|start_address
op_plus
r_sizeof
(paren
r_struct
id|ti_i2c_desc
)paren
op_plus
id|rom_desc-&gt;Size
)paren
OG
id|TI_MAX_I2C_SIZE
)paren
(brace
id|status
op_assign
op_minus
id|ENODEV
suffix:semicolon
id|dbg
(paren
l_string|&quot;%s - structure too big, erroring out.&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|dbg
(paren
l_string|&quot;%s Type = 0x%x&quot;
comma
id|__FUNCTION__
comma
id|rom_desc-&gt;Type
)paren
suffix:semicolon
singleline_comment|// Skip type 2 record
r_if
c_cond
(paren
(paren
id|rom_desc-&gt;Type
op_amp
l_int|0x0f
)paren
op_ne
id|I2C_DESC_TYPE_FIRMWARE_BASIC
)paren
(brace
singleline_comment|// Read the descriptor data
id|status
op_assign
id|TIReadRom
c_func
(paren
id|serial
comma
id|start_address
op_plus
r_sizeof
(paren
r_struct
id|ti_i2c_desc
)paren
comma
id|rom_desc-&gt;Size
comma
id|buffer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
r_break
suffix:semicolon
id|status
op_assign
id|ValidChecksum
c_func
(paren
id|rom_desc
comma
id|buffer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
r_break
suffix:semicolon
)brace
id|start_address
op_assign
id|start_address
op_plus
r_sizeof
(paren
r_struct
id|ti_i2c_desc
)paren
op_plus
id|rom_desc-&gt;Size
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|rom_desc-&gt;Type
op_ne
id|I2C_DESC_TYPE_ION
)paren
op_logical_and
(paren
id|start_address
OL
id|TI_MAX_I2C_SIZE
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rom_desc-&gt;Type
op_ne
id|I2C_DESC_TYPE_ION
)paren
op_logical_or
(paren
id|start_address
OG
id|TI_MAX_I2C_SIZE
)paren
)paren
id|status
op_assign
op_minus
id|ENODEV
suffix:semicolon
id|ExitTiValidateI2cImage
suffix:colon
id|kfree
(paren
id|buffer
)paren
suffix:semicolon
id|kfree
(paren
id|rom_desc
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
DECL|function|TIReadManufDescriptor
r_static
r_int
id|TIReadManufDescriptor
(paren
r_struct
id|edgeport_serial
op_star
id|serial
comma
id|__u8
op_star
id|buffer
)paren
(brace
r_int
id|status
suffix:semicolon
r_int
id|start_address
suffix:semicolon
r_struct
id|ti_i2c_desc
op_star
id|rom_desc
suffix:semicolon
r_struct
id|edge_ti_manuf_descriptor
op_star
id|desc
suffix:semicolon
id|rom_desc
op_assign
id|kmalloc
(paren
r_sizeof
(paren
op_star
id|rom_desc
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rom_desc
)paren
(brace
id|dev_err
(paren
op_amp
id|serial-&gt;serial-&gt;dev-&gt;dev
comma
l_string|&quot;%s - out of memory&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|start_address
op_assign
id|TIGetDescriptorAddress
(paren
id|serial
comma
id|I2C_DESC_TYPE_ION
comma
id|rom_desc
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|start_address
)paren
(brace
id|dbg
(paren
l_string|&quot;%s - Edge Descriptor not found in I2C&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|status
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
singleline_comment|// Read the descriptor data
id|status
op_assign
id|TIReadRom
(paren
id|serial
comma
id|start_address
op_plus
r_sizeof
(paren
r_struct
id|ti_i2c_desc
)paren
comma
id|rom_desc-&gt;Size
comma
id|buffer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
r_goto
m_exit
suffix:semicolon
id|status
op_assign
id|ValidChecksum
c_func
(paren
id|rom_desc
comma
id|buffer
)paren
suffix:semicolon
id|desc
op_assign
(paren
r_struct
id|edge_ti_manuf_descriptor
op_star
)paren
id|buffer
suffix:semicolon
id|dbg
(paren
l_string|&quot;%s - IonConfig      0x%x&quot;
comma
id|__FUNCTION__
comma
id|desc-&gt;IonConfig
)paren
suffix:semicolon
id|dbg
(paren
l_string|&quot;%s - Version          %d&quot;
comma
id|__FUNCTION__
comma
id|desc-&gt;Version
)paren
suffix:semicolon
id|dbg
(paren
l_string|&quot;%s - Cpu/Board      0x%x&quot;
comma
id|__FUNCTION__
comma
id|desc-&gt;CpuRev_BoardRev
)paren
suffix:semicolon
id|dbg
(paren
l_string|&quot;%s - NumPorts         %d&quot;
comma
id|__FUNCTION__
comma
id|desc-&gt;NumPorts
)paren
suffix:semicolon
id|dbg
(paren
l_string|&quot;%s - NumVirtualPorts  %d&quot;
comma
id|__FUNCTION__
comma
id|desc-&gt;NumVirtualPorts
)paren
suffix:semicolon
id|dbg
(paren
l_string|&quot;%s - TotalPorts       %d&quot;
comma
id|__FUNCTION__
comma
id|desc-&gt;TotalPorts
)paren
suffix:semicolon
m_exit
suffix:colon
id|kfree
(paren
id|rom_desc
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/* Build firmware header used for firmware update */
DECL|function|BuildI2CFirmwareHeader
r_static
r_int
id|BuildI2CFirmwareHeader
(paren
id|__u8
op_star
id|header
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
id|__u8
op_star
id|buffer
suffix:semicolon
r_int
id|buffer_size
suffix:semicolon
r_int
id|i
suffix:semicolon
id|__u8
id|cs
op_assign
l_int|0
suffix:semicolon
r_struct
id|ti_i2c_desc
op_star
id|i2c_header
suffix:semicolon
r_struct
id|ti_i2c_image_header
op_star
id|img_header
suffix:semicolon
r_struct
id|ti_i2c_firmware_rec
op_star
id|firmware_rec
suffix:semicolon
singleline_comment|// In order to update the I2C firmware we must change the type 2 record to type 0xF2.
singleline_comment|// This will force the UMP to come up in Boot Mode.  Then while in boot mode, the driver 
singleline_comment|// will download the latest firmware (padded to 15.5k) into the UMP ram. 
singleline_comment|// And finally when the device comes back up in download mode the driver will cause 
singleline_comment|// the new firmware to be copied from the UMP Ram to I2C and the firmware will update
singleline_comment|// the record type from 0xf2 to 0x02.
singleline_comment|// Allocate a 15.5k buffer + 2 bytes for version number (Firmware Record)
id|buffer_size
op_assign
(paren
(paren
(paren
l_int|1024
op_star
l_int|16
)paren
op_minus
l_int|512
)paren
op_plus
r_sizeof
(paren
r_struct
id|ti_i2c_firmware_rec
)paren
)paren
suffix:semicolon
id|buffer
op_assign
id|kmalloc
(paren
id|buffer_size
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|buffer
)paren
(brace
id|dev_err
(paren
id|dev
comma
l_string|&quot;%s - out of memory&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
singleline_comment|// Set entire image of 0xffs
id|memset
(paren
id|buffer
comma
l_int|0xff
comma
id|buffer_size
)paren
suffix:semicolon
singleline_comment|// Copy version number into firmware record
id|firmware_rec
op_assign
(paren
r_struct
id|ti_i2c_firmware_rec
op_star
)paren
id|buffer
suffix:semicolon
id|firmware_rec-&gt;Ver_Major
op_assign
id|OperationalCodeImageVersion.MajorVersion
suffix:semicolon
id|firmware_rec-&gt;Ver_Minor
op_assign
id|OperationalCodeImageVersion.MinorVersion
suffix:semicolon
singleline_comment|// Pointer to fw_down memory image
id|img_header
op_assign
(paren
r_struct
id|ti_i2c_image_header
op_star
)paren
op_amp
id|PagableOperationalCodeImage
(braket
l_int|0
)braket
suffix:semicolon
id|memcpy
(paren
id|buffer
op_plus
r_sizeof
(paren
r_struct
id|ti_i2c_firmware_rec
)paren
comma
op_amp
id|PagableOperationalCodeImage
(braket
r_sizeof
(paren
r_struct
id|ti_i2c_image_header
)paren
)braket
comma
id|img_header-&gt;Length
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|buffer_size
suffix:semicolon
id|i
op_increment
)paren
(brace
id|cs
op_assign
(paren
id|__u8
)paren
(paren
id|cs
op_plus
id|buffer
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|kfree
(paren
id|buffer
)paren
suffix:semicolon
singleline_comment|// Build new header
id|i2c_header
op_assign
(paren
r_struct
id|ti_i2c_desc
op_star
)paren
id|header
suffix:semicolon
id|firmware_rec
op_assign
(paren
r_struct
id|ti_i2c_firmware_rec
op_star
)paren
id|i2c_header-&gt;Data
suffix:semicolon
id|i2c_header-&gt;Type
op_assign
id|I2C_DESC_TYPE_FIRMWARE_BLANK
suffix:semicolon
id|i2c_header-&gt;Size
op_assign
(paren
id|__u16
)paren
id|buffer_size
suffix:semicolon
id|i2c_header-&gt;CheckSum
op_assign
id|cs
suffix:semicolon
id|firmware_rec-&gt;Ver_Major
op_assign
id|OperationalCodeImageVersion.MajorVersion
suffix:semicolon
id|firmware_rec-&gt;Ver_Minor
op_assign
id|OperationalCodeImageVersion.MinorVersion
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Try to figure out what type of I2c we have */
DECL|function|TIGetI2cTypeInBootMode
r_static
r_int
id|TIGetI2cTypeInBootMode
(paren
r_struct
id|edgeport_serial
op_star
id|serial
)paren
(brace
r_int
id|status
suffix:semicolon
id|__u8
id|data
suffix:semicolon
singleline_comment|// Try to read type 2
id|status
op_assign
id|TIReadVendorRequestSync
(paren
id|serial-&gt;serial-&gt;dev
comma
id|UMPC_MEMORY_READ
comma
singleline_comment|// Request
id|DTK_ADDR_SPACE_I2C_TYPE_II
comma
singleline_comment|// wValue (Address type)
l_int|0
comma
singleline_comment|// wIndex
op_amp
id|data
comma
singleline_comment|// TransferBuffer
l_int|0x01
)paren
suffix:semicolon
singleline_comment|// TransferBufferLength
r_if
c_cond
(paren
id|status
)paren
id|dbg
(paren
l_string|&quot;%s - read 2 status error = %d&quot;
comma
id|__FUNCTION__
comma
id|status
)paren
suffix:semicolon
r_else
id|dbg
(paren
l_string|&quot;%s - read 2 data = 0x%x&quot;
comma
id|__FUNCTION__
comma
id|data
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
id|status
)paren
op_logical_and
id|data
op_eq
l_int|0x52
)paren
(brace
id|dbg
(paren
l_string|&quot;%s - ROM_TYPE_II&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|serial-&gt;TI_I2C_Type
op_assign
id|DTK_ADDR_SPACE_I2C_TYPE_II
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
singleline_comment|// Try to read type 3
id|status
op_assign
id|TIReadVendorRequestSync
(paren
id|serial-&gt;serial-&gt;dev
comma
id|UMPC_MEMORY_READ
comma
singleline_comment|// Request
id|DTK_ADDR_SPACE_I2C_TYPE_III
comma
singleline_comment|// wValue (Address type)
l_int|0
comma
singleline_comment|// wIndex
op_amp
id|data
comma
singleline_comment|// TransferBuffer
l_int|0x01
)paren
suffix:semicolon
singleline_comment|// TransferBufferLength
r_if
c_cond
(paren
id|status
)paren
id|dbg
(paren
l_string|&quot;%s - read 3 status error = %d&quot;
comma
id|__FUNCTION__
comma
id|status
)paren
suffix:semicolon
r_else
id|dbg
(paren
l_string|&quot;%s - read 2 data = 0x%x&quot;
comma
id|__FUNCTION__
comma
id|data
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
id|status
)paren
op_logical_and
id|data
op_eq
l_int|0x52
)paren
(brace
id|dbg
(paren
l_string|&quot;%s - ROM_TYPE_III&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|serial-&gt;TI_I2C_Type
op_assign
id|DTK_ADDR_SPACE_I2C_TYPE_III
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|dbg
(paren
l_string|&quot;%s - Unknown&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|serial-&gt;TI_I2C_Type
op_assign
id|DTK_ADDR_SPACE_I2C_TYPE_II
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
DECL|function|TISendBulkTransferSync
r_static
r_int
id|TISendBulkTransferSync
(paren
r_struct
id|usb_serial
op_star
id|serial
comma
r_void
op_star
id|buffer
comma
r_int
id|length
comma
r_int
op_star
id|num_sent
)paren
(brace
r_int
id|status
suffix:semicolon
id|status
op_assign
id|usb_bulk_msg
(paren
id|serial-&gt;dev
comma
id|usb_sndbulkpipe
c_func
(paren
id|serial-&gt;dev
comma
id|serial-&gt;port
(braket
l_int|0
)braket
dot
id|bulk_out_endpointAddress
)paren
comma
id|buffer
comma
id|length
comma
id|num_sent
comma
id|HZ
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/* Download given firmware image to the device (IN BOOT MODE) */
DECL|function|TIDownloadCodeImage
r_static
r_int
id|TIDownloadCodeImage
(paren
r_struct
id|edgeport_serial
op_star
id|serial
comma
id|__u8
op_star
id|image
comma
r_int
id|image_length
)paren
(brace
r_int
id|status
op_assign
l_int|0
suffix:semicolon
r_int
id|pos
suffix:semicolon
r_int
id|transfer
suffix:semicolon
r_int
id|done
suffix:semicolon
singleline_comment|// Transfer firmware image
r_for
c_loop
(paren
id|pos
op_assign
l_int|0
suffix:semicolon
id|pos
OL
id|image_length
suffix:semicolon
)paren
(brace
singleline_comment|// Read the next buffer from file
id|transfer
op_assign
id|image_length
op_minus
id|pos
suffix:semicolon
r_if
c_cond
(paren
id|transfer
OG
id|EDGE_FW_BULK_MAX_PACKET_SIZE
)paren
id|transfer
op_assign
id|EDGE_FW_BULK_MAX_PACKET_SIZE
suffix:semicolon
singleline_comment|// Transfer data
id|status
op_assign
id|TISendBulkTransferSync
(paren
id|serial-&gt;serial
comma
op_amp
id|image
(braket
id|pos
)braket
comma
id|transfer
comma
op_amp
id|done
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
r_break
suffix:semicolon
singleline_comment|// Advance buffer pointer
id|pos
op_add_assign
id|done
suffix:semicolon
)brace
r_return
id|status
suffix:semicolon
)brace
singleline_comment|// FIXME!!!
DECL|function|TIConfigureBootDevice
r_static
r_int
id|TIConfigureBootDevice
(paren
r_struct
id|usb_device
op_star
id|dev
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * DownloadTIFirmware - Download run-time operating firmware to the TI5052&n; * &n; * This routine downloads the main operating code into the TI5052, using the&n; * boot code already burned into E2PROM or ROM.&n; */
DECL|function|TIDownloadFirmware
r_static
r_int
id|TIDownloadFirmware
(paren
r_struct
id|edgeport_serial
op_star
id|serial
)paren
(brace
r_struct
id|device
op_star
id|dev
op_assign
op_amp
id|serial-&gt;serial-&gt;dev-&gt;dev
suffix:semicolon
r_int
id|status
op_assign
l_int|0
suffix:semicolon
r_int
id|start_address
suffix:semicolon
r_struct
id|edge_ti_manuf_descriptor
op_star
id|ti_manuf_desc
suffix:semicolon
r_struct
id|usb_interface_descriptor
op_star
id|interface
suffix:semicolon
r_int
id|download_cur_ver
suffix:semicolon
r_int
id|download_new_ver
suffix:semicolon
multiline_comment|/* This routine is entered by both the BOOT mode and the Download mode&n;&t; * We can determine which code is running by the reading the config&n;&t; * descriptor and if we have only one bulk pipe it is in boot mode&n;&t; */
id|serial-&gt;product_info.hardware_type
op_assign
id|HARDWARE_TYPE_TIUMP
suffix:semicolon
multiline_comment|/* Default to type 2 i2c */
id|serial-&gt;TI_I2C_Type
op_assign
id|DTK_ADDR_SPACE_I2C_TYPE_II
suffix:semicolon
id|status
op_assign
id|TIChooseConfiguration
(paren
id|serial-&gt;serial-&gt;dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
r_return
id|status
suffix:semicolon
id|interface
op_assign
op_amp
id|serial-&gt;serial-&gt;dev-&gt;config-&gt;interface-&gt;altsetting-&gt;desc
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|interface
)paren
(brace
id|dev_err
(paren
op_amp
id|serial-&gt;serial-&gt;dev-&gt;dev
comma
l_string|&quot;%s - no interface set, error!&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
singleline_comment|// Setup initial mode -- the default mode 0 is TI_MODE_CONFIGURING
singleline_comment|// if we have more than one endpoint we are definitely in download mode
r_if
c_cond
(paren
id|interface-&gt;bNumEndpoints
OG
l_int|1
)paren
id|serial-&gt;product_info.TiMode
op_assign
id|TI_MODE_DOWNLOAD
suffix:semicolon
r_else
singleline_comment|// Otherwise we will remain in configuring mode
id|serial-&gt;product_info.TiMode
op_assign
id|TI_MODE_CONFIGURING
suffix:semicolon
singleline_comment|// Save Download Version Number
id|OperationalCodeImageVersion.MajorVersion
op_assign
id|PagableOperationalCodeImageVersion.MajorVersion
suffix:semicolon
id|OperationalCodeImageVersion.MinorVersion
op_assign
id|PagableOperationalCodeImageVersion.MinorVersion
suffix:semicolon
id|OperationalCodeImageVersion.BuildNumber
op_assign
id|PagableOperationalCodeImageVersion.BuildNumber
suffix:semicolon
multiline_comment|/********************************************************************/
multiline_comment|/* Download Mode */
multiline_comment|/********************************************************************/
r_if
c_cond
(paren
id|serial-&gt;product_info.TiMode
op_eq
id|TI_MODE_DOWNLOAD
)paren
(brace
r_struct
id|ti_i2c_desc
op_star
id|rom_desc
suffix:semicolon
id|dbg
(paren
l_string|&quot;%s - &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;RUNNING IN DOWNLOAD MODE&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|status
op_assign
id|TiValidateI2cImage
(paren
id|serial
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
(brace
id|dbg
(paren
l_string|&quot;%s - &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;DOWNLOAD MODE -- BAD I2C &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/* Validate Hardware version number&n;&t;&t; * Read Manufacturing Descriptor from TI Based Edgeport&n;&t;&t; */
id|ti_manuf_desc
op_assign
id|kmalloc
(paren
r_sizeof
(paren
op_star
id|ti_manuf_desc
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ti_manuf_desc
)paren
(brace
id|dev_err
(paren
id|dev
comma
l_string|&quot;%s - out of memory.&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|status
op_assign
id|TIReadManufDescriptor
(paren
id|serial
comma
(paren
id|__u8
op_star
)paren
id|ti_manuf_desc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
(brace
id|kfree
(paren
id|ti_manuf_desc
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
singleline_comment|// Check version number of ION descriptor
r_if
c_cond
(paren
op_logical_neg
id|ignore_cpu_rev
op_logical_and
id|TI_GET_CPU_REVISION
c_func
(paren
id|ti_manuf_desc-&gt;CpuRev_BoardRev
)paren
OL
l_int|2
)paren
(brace
id|dbg
(paren
l_string|&quot;%s - Wrong CPU Rev %d (Must be 2)&quot;
comma
id|__FUNCTION__
comma
id|TI_GET_CPU_REVISION
c_func
(paren
id|ti_manuf_desc-&gt;CpuRev_BoardRev
)paren
)paren
suffix:semicolon
id|kfree
(paren
id|ti_manuf_desc
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|rom_desc
op_assign
id|kmalloc
(paren
r_sizeof
(paren
op_star
id|rom_desc
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rom_desc
)paren
(brace
id|dev_err
(paren
id|dev
comma
l_string|&quot;%s - out of memory.&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|kfree
(paren
id|ti_manuf_desc
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
singleline_comment|// Search for type 2 record (firmware record)
r_if
c_cond
(paren
(paren
id|start_address
op_assign
id|TIGetDescriptorAddress
(paren
id|serial
comma
id|I2C_DESC_TYPE_FIRMWARE_BASIC
comma
id|rom_desc
)paren
)paren
op_ne
l_int|0
)paren
(brace
r_struct
id|ti_i2c_firmware_rec
op_star
id|firmware_version
suffix:semicolon
id|__u8
id|record
suffix:semicolon
id|dbg
(paren
l_string|&quot;%s - Found Type FIRMWARE (Type 2) record&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|firmware_version
op_assign
id|kmalloc
(paren
r_sizeof
(paren
op_star
id|firmware_version
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|firmware_version
)paren
(brace
id|dev_err
(paren
id|dev
comma
l_string|&quot;%s - out of memory.&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|kfree
(paren
id|rom_desc
)paren
suffix:semicolon
id|kfree
(paren
id|ti_manuf_desc
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
singleline_comment|// Validate version number&t;&t;&t;&t;
singleline_comment|// Read the descriptor data
id|status
op_assign
id|TIReadRom
(paren
id|serial
comma
id|start_address
op_plus
r_sizeof
(paren
r_struct
id|ti_i2c_desc
)paren
comma
r_sizeof
(paren
r_struct
id|ti_i2c_firmware_rec
)paren
comma
(paren
id|__u8
op_star
)paren
id|firmware_version
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
(brace
id|kfree
(paren
id|firmware_version
)paren
suffix:semicolon
id|kfree
(paren
id|rom_desc
)paren
suffix:semicolon
id|kfree
(paren
id|ti_manuf_desc
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
singleline_comment|// Check version number of download with current version in I2c
id|download_cur_ver
op_assign
(paren
id|firmware_version-&gt;Ver_Major
op_lshift
l_int|8
)paren
op_plus
(paren
id|firmware_version-&gt;Ver_Minor
)paren
suffix:semicolon
id|download_new_ver
op_assign
(paren
id|OperationalCodeImageVersion.MajorVersion
op_lshift
l_int|8
)paren
op_plus
(paren
id|OperationalCodeImageVersion.MinorVersion
)paren
suffix:semicolon
id|dbg
(paren
l_string|&quot;%s - &gt;&gt;&gt;Firmware Versions Device %d.%d  Driver %d.%d&quot;
comma
id|__FUNCTION__
comma
id|firmware_version-&gt;Ver_Major
comma
id|firmware_version-&gt;Ver_Minor
comma
id|OperationalCodeImageVersion.MajorVersion
comma
id|OperationalCodeImageVersion.MinorVersion
)paren
suffix:semicolon
singleline_comment|// Check if we have an old version in the I2C and update if necessary
r_if
c_cond
(paren
id|download_cur_ver
op_ne
id|download_new_ver
)paren
(brace
id|dbg
(paren
l_string|&quot;%s - Update I2C Download from %d.%d to %d.%d&quot;
comma
id|__FUNCTION__
comma
id|firmware_version-&gt;Ver_Major
comma
id|firmware_version-&gt;Ver_Minor
comma
id|OperationalCodeImageVersion.MajorVersion
comma
id|OperationalCodeImageVersion.MinorVersion
)paren
suffix:semicolon
singleline_comment|// In order to update the I2C firmware we must change the type 2 record to type 0xF2.
singleline_comment|// This will force the UMP to come up in Boot Mode.  Then while in boot mode, the driver 
singleline_comment|// will download the latest firmware (padded to 15.5k) into the UMP ram. 
singleline_comment|// And finally when the device comes back up in download mode the driver will cause 
singleline_comment|// the new firmware to be copied from the UMP Ram to I2C and the firmware will update
singleline_comment|// the record type from 0xf2 to 0x02.
id|record
op_assign
id|I2C_DESC_TYPE_FIRMWARE_BLANK
suffix:semicolon
singleline_comment|// Change the I2C Firmware record type to 0xf2 to trigger an update
id|status
op_assign
id|TIWriteRom
(paren
id|serial
comma
id|start_address
comma
r_sizeof
(paren
id|record
)paren
comma
op_amp
id|record
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
(brace
id|kfree
(paren
id|firmware_version
)paren
suffix:semicolon
id|kfree
(paren
id|rom_desc
)paren
suffix:semicolon
id|kfree
(paren
id|ti_manuf_desc
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
singleline_comment|// verify the write -- must do this in order for write to 
singleline_comment|// complete before we do the hardware reset
id|status
op_assign
id|TIReadRom
(paren
id|serial
comma
id|start_address
comma
r_sizeof
(paren
id|record
)paren
comma
op_amp
id|record
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
(brace
id|kfree
(paren
id|firmware_version
)paren
suffix:semicolon
id|kfree
(paren
id|rom_desc
)paren
suffix:semicolon
id|kfree
(paren
id|ti_manuf_desc
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
r_if
c_cond
(paren
id|record
op_ne
id|I2C_DESC_TYPE_FIRMWARE_BLANK
)paren
(brace
id|dev_err
(paren
id|dev
comma
l_string|&quot;%s - error resetting device&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|kfree
(paren
id|firmware_version
)paren
suffix:semicolon
id|kfree
(paren
id|rom_desc
)paren
suffix:semicolon
id|kfree
(paren
id|ti_manuf_desc
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|dbg
(paren
l_string|&quot;%s - HARDWARE RESET&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
singleline_comment|// Reset UMP -- Back to BOOT MODE
id|status
op_assign
id|TISendVendorRequestSync
(paren
id|serial-&gt;serial-&gt;dev
comma
id|UMPC_HARDWARE_RESET
comma
singleline_comment|// Request
l_int|0
comma
singleline_comment|// wValue
l_int|0
comma
singleline_comment|// wIndex
l_int|NULL
comma
singleline_comment|// TransferBuffer
l_int|0
)paren
suffix:semicolon
singleline_comment|// TransferBufferLength
id|dbg
(paren
l_string|&quot;%s - HARDWARE RESET return %d&quot;
comma
id|__FUNCTION__
comma
id|status
)paren
suffix:semicolon
multiline_comment|/* return an error on purpose. */
id|kfree
(paren
id|firmware_version
)paren
suffix:semicolon
id|kfree
(paren
id|rom_desc
)paren
suffix:semicolon
id|kfree
(paren
id|ti_manuf_desc
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|kfree
(paren
id|firmware_version
)paren
suffix:semicolon
)brace
singleline_comment|// Search for type 0xF2 record (firmware blank record)
r_else
r_if
c_cond
(paren
(paren
id|start_address
op_assign
id|TIGetDescriptorAddress
(paren
id|serial
comma
id|I2C_DESC_TYPE_FIRMWARE_BLANK
comma
id|rom_desc
)paren
)paren
op_ne
l_int|0
)paren
(brace
DECL|macro|HEADER_SIZE
mdefine_line|#define HEADER_SIZE&t;(sizeof(struct ti_i2c_desc) + sizeof(struct ti_i2c_firmware_rec))
id|__u8
op_star
id|header
suffix:semicolon
id|__u8
op_star
id|vheader
suffix:semicolon
id|header
op_assign
id|kmalloc
(paren
id|HEADER_SIZE
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|header
)paren
(brace
id|dev_err
(paren
id|dev
comma
l_string|&quot;%s - out of memory.&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|kfree
(paren
id|rom_desc
)paren
suffix:semicolon
id|kfree
(paren
id|ti_manuf_desc
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|vheader
op_assign
id|kmalloc
(paren
id|HEADER_SIZE
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|vheader
)paren
(brace
id|dev_err
(paren
id|dev
comma
l_string|&quot;%s - out of memory.&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|kfree
(paren
id|header
)paren
suffix:semicolon
id|kfree
(paren
id|rom_desc
)paren
suffix:semicolon
id|kfree
(paren
id|ti_manuf_desc
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|dbg
(paren
l_string|&quot;%s - Found Type BLANK FIRMWARE (Type F2) record&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
singleline_comment|// In order to update the I2C firmware we must change the type 2 record to type 0xF2.
singleline_comment|// This will force the UMP to come up in Boot Mode.  Then while in boot mode, the driver 
singleline_comment|// will download the latest firmware (padded to 15.5k) into the UMP ram. 
singleline_comment|// And finally when the device comes back up in download mode the driver will cause 
singleline_comment|// the new firmware to be copied from the UMP Ram to I2C and the firmware will update
singleline_comment|// the record type from 0xf2 to 0x02.
id|status
op_assign
id|BuildI2CFirmwareHeader
c_func
(paren
id|header
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
(brace
id|kfree
(paren
id|vheader
)paren
suffix:semicolon
id|kfree
(paren
id|header
)paren
suffix:semicolon
id|kfree
(paren
id|rom_desc
)paren
suffix:semicolon
id|kfree
(paren
id|ti_manuf_desc
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
singleline_comment|// Update I2C with type 0xf2 record with correct size and checksum
id|status
op_assign
id|TIWriteRom
(paren
id|serial
comma
id|start_address
comma
id|HEADER_SIZE
comma
id|header
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
(brace
id|kfree
(paren
id|vheader
)paren
suffix:semicolon
id|kfree
(paren
id|header
)paren
suffix:semicolon
id|kfree
(paren
id|rom_desc
)paren
suffix:semicolon
id|kfree
(paren
id|ti_manuf_desc
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
singleline_comment|// verify the write -- must do this in order for write to 
singleline_comment|// complete before we do the hardware reset
id|status
op_assign
id|TIReadRom
(paren
id|serial
comma
id|start_address
comma
id|HEADER_SIZE
comma
id|vheader
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
(brace
id|dbg
(paren
l_string|&quot;%s - can&squot;t read header back&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|kfree
(paren
id|vheader
)paren
suffix:semicolon
id|kfree
(paren
id|header
)paren
suffix:semicolon
id|kfree
(paren
id|rom_desc
)paren
suffix:semicolon
id|kfree
(paren
id|ti_manuf_desc
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
r_if
c_cond
(paren
id|memcmp
c_func
(paren
id|vheader
comma
id|header
comma
id|HEADER_SIZE
)paren
)paren
(brace
id|dbg
(paren
l_string|&quot;%s - write download record failed&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|kfree
(paren
id|vheader
)paren
suffix:semicolon
id|kfree
(paren
id|header
)paren
suffix:semicolon
id|kfree
(paren
id|rom_desc
)paren
suffix:semicolon
id|kfree
(paren
id|ti_manuf_desc
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
id|kfree
(paren
id|vheader
)paren
suffix:semicolon
id|kfree
(paren
id|header
)paren
suffix:semicolon
id|dbg
(paren
l_string|&quot;%s - Start firmware update&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
singleline_comment|// Tell firmware to copy download image into I2C 
id|status
op_assign
id|TISendVendorRequestSync
(paren
id|serial-&gt;serial-&gt;dev
comma
id|UMPC_COPY_DNLD_TO_I2C
comma
singleline_comment|// Request
l_int|0
comma
singleline_comment|// wValue 
l_int|0
comma
singleline_comment|// wIndex
l_int|NULL
comma
singleline_comment|// TransferBuffer
l_int|0
)paren
suffix:semicolon
singleline_comment|// TransferBufferLength
id|dbg
(paren
l_string|&quot;%s - Update complete 0x%x&quot;
comma
id|__FUNCTION__
comma
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
(brace
id|dbg
(paren
l_string|&quot;%s - UMPC_COPY_DNLD_TO_I2C failed&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|kfree
(paren
id|rom_desc
)paren
suffix:semicolon
id|kfree
(paren
id|ti_manuf_desc
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
)brace
singleline_comment|// The device is running the download code
id|kfree
(paren
id|rom_desc
)paren
suffix:semicolon
id|kfree
(paren
id|ti_manuf_desc
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/********************************************************************/
multiline_comment|/* Boot Mode */
multiline_comment|/********************************************************************/
id|dbg
(paren
l_string|&quot;%s - &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;RUNNING IN BOOT MODE&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
singleline_comment|// Configure the TI device so we can use the BULK pipes for download
id|status
op_assign
id|TIConfigureBootDevice
(paren
id|serial-&gt;serial-&gt;dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
r_return
id|status
suffix:semicolon
r_if
c_cond
(paren
id|serial-&gt;serial-&gt;dev-&gt;descriptor.idVendor
op_ne
id|USB_VENDOR_ID_ION
)paren
(brace
id|dbg
(paren
l_string|&quot;%s - VID = 0x%x&quot;
comma
id|__FUNCTION__
comma
id|serial-&gt;serial-&gt;dev-&gt;descriptor.idVendor
)paren
suffix:semicolon
id|serial-&gt;TI_I2C_Type
op_assign
id|DTK_ADDR_SPACE_I2C_TYPE_II
suffix:semicolon
r_goto
id|StayInBootMode
suffix:semicolon
)brace
singleline_comment|// We have an ION device (I2c Must be programmed)
singleline_comment|// Determine I2C image type
r_if
c_cond
(paren
id|TIGetI2cTypeInBootMode
c_func
(paren
id|serial
)paren
)paren
(brace
r_goto
id|StayInBootMode
suffix:semicolon
)brace
singleline_comment|// Registry variable set?
r_if
c_cond
(paren
id|TIStayInBootMode
)paren
(brace
id|dbg
(paren
l_string|&quot;%s - TIStayInBootMode&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_goto
id|StayInBootMode
suffix:semicolon
)brace
singleline_comment|// Check for ION Vendor ID and that the I2C is valid
r_if
c_cond
(paren
op_logical_neg
id|TiValidateI2cImage
c_func
(paren
id|serial
)paren
)paren
(brace
r_struct
id|ti_i2c_image_header
op_star
id|header
suffix:semicolon
r_int
id|i
suffix:semicolon
id|__u8
id|cs
op_assign
l_int|0
suffix:semicolon
id|__u8
op_star
id|buffer
suffix:semicolon
r_int
id|buffer_size
suffix:semicolon
multiline_comment|/* Validate Hardware version number&n;&t;&t; * Read Manufacturing Descriptor from TI Based Edgeport&n;&t;&t; */
id|ti_manuf_desc
op_assign
id|kmalloc
(paren
r_sizeof
(paren
op_star
id|ti_manuf_desc
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ti_manuf_desc
)paren
(brace
id|dev_err
(paren
id|dev
comma
l_string|&quot;%s - out of memory.&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|status
op_assign
id|TIReadManufDescriptor
(paren
id|serial
comma
(paren
id|__u8
op_star
)paren
id|ti_manuf_desc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
(brace
id|kfree
(paren
id|ti_manuf_desc
)paren
suffix:semicolon
r_goto
id|StayInBootMode
suffix:semicolon
)brace
singleline_comment|// Check for version 2
r_if
c_cond
(paren
op_logical_neg
id|ignore_cpu_rev
op_logical_and
id|TI_GET_CPU_REVISION
c_func
(paren
id|ti_manuf_desc-&gt;CpuRev_BoardRev
)paren
OL
l_int|2
)paren
(brace
id|dbg
(paren
l_string|&quot;%s - Wrong CPU Rev %d (Must be 2)&quot;
comma
id|__FUNCTION__
comma
id|TI_GET_CPU_REVISION
c_func
(paren
id|ti_manuf_desc-&gt;CpuRev_BoardRev
)paren
)paren
suffix:semicolon
id|kfree
(paren
id|ti_manuf_desc
)paren
suffix:semicolon
r_goto
id|StayInBootMode
suffix:semicolon
)brace
id|kfree
(paren
id|ti_manuf_desc
)paren
suffix:semicolon
singleline_comment|// In order to update the I2C firmware we must change the type 2 record to type 0xF2.
singleline_comment|// This will force the UMP to come up in Boot Mode.  Then while in boot mode, the driver 
singleline_comment|// will download the latest firmware (padded to 15.5k) into the UMP ram. 
singleline_comment|// And finally when the device comes back up in download mode the driver will cause 
singleline_comment|// the new firmware to be copied from the UMP Ram to I2C and the firmware will update
singleline_comment|// the record type from 0xf2 to 0x02.
multiline_comment|/*&n;&t;&t; * Do we really have to copy the whole firmware image,&n;&t;&t; * or could we do this in place!&n;&t;&t; */
singleline_comment|// Allocate a 15.5k buffer + 3 byte header
id|buffer_size
op_assign
(paren
(paren
(paren
l_int|1024
op_star
l_int|16
)paren
op_minus
l_int|512
)paren
op_plus
r_sizeof
(paren
r_struct
id|ti_i2c_image_header
)paren
)paren
suffix:semicolon
id|buffer
op_assign
id|kmalloc
(paren
id|buffer_size
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|buffer
)paren
(brace
id|dev_err
(paren
id|dev
comma
l_string|&quot;%s - out of memory&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
singleline_comment|// Initialize the buffer to 0xff (pad the buffer)
id|memset
(paren
id|buffer
comma
l_int|0xff
comma
id|buffer_size
)paren
suffix:semicolon
id|memcpy
(paren
id|buffer
comma
op_amp
id|PagableOperationalCodeImage
(braket
l_int|0
)braket
comma
id|PagableOperationalCodeSize
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
r_sizeof
(paren
r_struct
id|ti_i2c_image_header
)paren
suffix:semicolon
id|i
OL
id|buffer_size
suffix:semicolon
id|i
op_increment
)paren
(brace
id|cs
op_assign
(paren
id|__u8
)paren
(paren
id|cs
op_plus
id|buffer
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|header
op_assign
(paren
r_struct
id|ti_i2c_image_header
op_star
)paren
id|buffer
suffix:semicolon
singleline_comment|// update length and checksum after padding
id|header-&gt;Length
op_assign
(paren
id|__u16
)paren
(paren
id|buffer_size
op_minus
r_sizeof
(paren
r_struct
id|ti_i2c_image_header
)paren
)paren
suffix:semicolon
id|header-&gt;CheckSum
op_assign
id|cs
suffix:semicolon
singleline_comment|// Download the operational code 
id|dbg
(paren
l_string|&quot;%s - Downloading operational code image (TI UMP)&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|status
op_assign
id|TIDownloadCodeImage
(paren
id|serial
comma
id|buffer
comma
id|buffer_size
)paren
suffix:semicolon
id|kfree
(paren
id|buffer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
(brace
id|dbg
(paren
l_string|&quot;%s - Error downloading operational code image&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
singleline_comment|// Device will reboot
id|serial-&gt;product_info.TiMode
op_assign
id|TI_MODE_TRANSITIONING
suffix:semicolon
id|dbg
(paren
l_string|&quot;%s - Download successful -- Device rebooting...&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
multiline_comment|/* return an error on purpose */
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|StayInBootMode
suffix:colon
singleline_comment|// Eprom is invalid or blank stay in boot mode
id|dbg
(paren
l_string|&quot;%s - &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;STAYING IN BOOT MODE&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|serial-&gt;product_info.TiMode
op_assign
id|TI_MODE_BOOT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|TISetDtr
r_static
r_int
id|TISetDtr
(paren
r_struct
id|edgeport_port
op_star
id|port
)paren
(brace
r_int
id|port_number
op_assign
id|port-&gt;port-&gt;number
op_minus
id|port-&gt;port-&gt;serial-&gt;minor
suffix:semicolon
id|dbg
(paren
l_string|&quot;%s&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|port-&gt;shadow_mcr
op_or_assign
id|MCR_DTR
suffix:semicolon
r_return
id|TIWriteCommandSync
(paren
id|port-&gt;port-&gt;serial-&gt;dev
comma
id|UMPC_SET_CLR_DTR
comma
(paren
id|__u8
)paren
(paren
id|UMPM_UART1_PORT
op_plus
id|port_number
)paren
comma
l_int|1
comma
multiline_comment|/* set */
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|TIClearDtr
r_static
r_int
id|TIClearDtr
(paren
r_struct
id|edgeport_port
op_star
id|port
)paren
(brace
r_int
id|port_number
op_assign
id|port-&gt;port-&gt;number
op_minus
id|port-&gt;port-&gt;serial-&gt;minor
suffix:semicolon
id|dbg
(paren
l_string|&quot;%s&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|port-&gt;shadow_mcr
op_and_assign
op_complement
id|MCR_DTR
suffix:semicolon
r_return
id|TIWriteCommandSync
(paren
id|port-&gt;port-&gt;serial-&gt;dev
comma
id|UMPC_SET_CLR_DTR
comma
(paren
id|__u8
)paren
(paren
id|UMPM_UART1_PORT
op_plus
id|port_number
)paren
comma
l_int|0
comma
multiline_comment|/* clear */
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|TISetRts
r_static
r_int
id|TISetRts
(paren
r_struct
id|edgeport_port
op_star
id|port
)paren
(brace
r_int
id|port_number
op_assign
id|port-&gt;port-&gt;number
op_minus
id|port-&gt;port-&gt;serial-&gt;minor
suffix:semicolon
id|dbg
(paren
l_string|&quot;%s&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|port-&gt;shadow_mcr
op_or_assign
id|MCR_RTS
suffix:semicolon
r_return
id|TIWriteCommandSync
(paren
id|port-&gt;port-&gt;serial-&gt;dev
comma
id|UMPC_SET_CLR_RTS
comma
(paren
id|__u8
)paren
(paren
id|UMPM_UART1_PORT
op_plus
id|port_number
)paren
comma
l_int|1
comma
multiline_comment|/* set */
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|TIClearRts
r_static
r_int
id|TIClearRts
(paren
r_struct
id|edgeport_port
op_star
id|port
)paren
(brace
r_int
id|port_number
op_assign
id|port-&gt;port-&gt;number
op_minus
id|port-&gt;port-&gt;serial-&gt;minor
suffix:semicolon
id|dbg
(paren
l_string|&quot;%s&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|port-&gt;shadow_mcr
op_and_assign
op_complement
id|MCR_RTS
suffix:semicolon
r_return
id|TIWriteCommandSync
(paren
id|port-&gt;port-&gt;serial-&gt;dev
comma
id|UMPC_SET_CLR_RTS
comma
(paren
id|__u8
)paren
(paren
id|UMPM_UART1_PORT
op_plus
id|port_number
)paren
comma
l_int|0
comma
multiline_comment|/* clear */
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|TISetLoopBack
r_static
r_int
id|TISetLoopBack
(paren
r_struct
id|edgeport_port
op_star
id|port
)paren
(brace
r_int
id|port_number
op_assign
id|port-&gt;port-&gt;number
op_minus
id|port-&gt;port-&gt;serial-&gt;minor
suffix:semicolon
id|dbg
(paren
l_string|&quot;%s&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
id|TIWriteCommandSync
(paren
id|port-&gt;port-&gt;serial-&gt;dev
comma
id|UMPC_SET_CLR_LOOPBACK
comma
(paren
id|__u8
)paren
(paren
id|UMPM_UART1_PORT
op_plus
id|port_number
)paren
comma
l_int|1
comma
multiline_comment|/* set */
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|TIClearLoopBack
r_static
r_int
id|TIClearLoopBack
(paren
r_struct
id|edgeport_port
op_star
id|port
)paren
(brace
r_int
id|port_number
op_assign
id|port-&gt;port-&gt;number
op_minus
id|port-&gt;port-&gt;serial-&gt;minor
suffix:semicolon
id|dbg
(paren
l_string|&quot;%s&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
id|TIWriteCommandSync
(paren
id|port-&gt;port-&gt;serial-&gt;dev
comma
id|UMPC_SET_CLR_LOOPBACK
comma
(paren
id|__u8
)paren
(paren
id|UMPM_UART1_PORT
op_plus
id|port_number
)paren
comma
l_int|0
comma
multiline_comment|/* clear */
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|TISetBreak
r_static
r_int
id|TISetBreak
(paren
r_struct
id|edgeport_port
op_star
id|port
)paren
(brace
r_int
id|port_number
op_assign
id|port-&gt;port-&gt;number
op_minus
id|port-&gt;port-&gt;serial-&gt;minor
suffix:semicolon
id|dbg
(paren
l_string|&quot;%s&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
id|TIWriteCommandSync
(paren
id|port-&gt;port-&gt;serial-&gt;dev
comma
id|UMPC_SET_CLR_BREAK
comma
(paren
id|__u8
)paren
(paren
id|UMPM_UART1_PORT
op_plus
id|port_number
)paren
comma
l_int|1
comma
multiline_comment|/* set */
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|TIClearBreak
r_static
r_int
id|TIClearBreak
(paren
r_struct
id|edgeport_port
op_star
id|port
)paren
(brace
r_int
id|port_number
op_assign
id|port-&gt;port-&gt;number
op_minus
id|port-&gt;port-&gt;serial-&gt;minor
suffix:semicolon
id|dbg
(paren
l_string|&quot;%s&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
id|TIWriteCommandSync
(paren
id|port-&gt;port-&gt;serial-&gt;dev
comma
id|UMPC_SET_CLR_BREAK
comma
(paren
id|__u8
)paren
(paren
id|UMPM_UART1_PORT
op_plus
id|port_number
)paren
comma
l_int|0
comma
multiline_comment|/* clear */
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|TIRestoreMCR
r_static
r_int
id|TIRestoreMCR
(paren
r_struct
id|edgeport_port
op_star
id|port
comma
id|__u8
id|mcr
)paren
(brace
r_int
id|status
op_assign
l_int|0
suffix:semicolon
id|dbg
(paren
l_string|&quot;%s - %x&quot;
comma
id|__FUNCTION__
comma
id|mcr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mcr
op_amp
id|MCR_DTR
)paren
id|status
op_assign
id|TISetDtr
(paren
id|port
)paren
suffix:semicolon
r_else
id|status
op_assign
id|TIClearDtr
(paren
id|port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
r_return
id|status
suffix:semicolon
r_if
c_cond
(paren
id|mcr
op_amp
id|MCR_RTS
)paren
id|status
op_assign
id|TISetRts
(paren
id|port
)paren
suffix:semicolon
r_else
id|status
op_assign
id|TIClearRts
(paren
id|port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
r_return
id|status
suffix:semicolon
r_if
c_cond
(paren
id|mcr
op_amp
id|MCR_LOOPBACK
)paren
id|status
op_assign
id|TISetLoopBack
(paren
id|port
)paren
suffix:semicolon
r_else
id|status
op_assign
id|TIClearLoopBack
(paren
id|port
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/* Convert TI LSR to standard UART flags */
DECL|function|MapLineStatus
r_static
id|__u8
id|MapLineStatus
(paren
id|__u8
id|ti_lsr
)paren
(brace
id|__u8
id|lsr
op_assign
l_int|0
suffix:semicolon
DECL|macro|MAP_FLAG
mdefine_line|#define MAP_FLAG(flagUmp, flagUart)    &bslash;&n;&t;if (ti_lsr &amp; flagUmp) &bslash;&n;&t;&t;lsr |= flagUart;
id|MAP_FLAG
c_func
(paren
id|UMP_UART_LSR_OV_MASK
comma
id|LSR_OVER_ERR
)paren
multiline_comment|/* overrun */
id|MAP_FLAG
c_func
(paren
id|UMP_UART_LSR_PE_MASK
comma
id|LSR_PAR_ERR
)paren
multiline_comment|/* parity error */
id|MAP_FLAG
c_func
(paren
id|UMP_UART_LSR_FE_MASK
comma
id|LSR_FRM_ERR
)paren
multiline_comment|/* framing error */
id|MAP_FLAG
c_func
(paren
id|UMP_UART_LSR_BR_MASK
comma
id|LSR_BREAK
)paren
multiline_comment|/* break detected */
id|MAP_FLAG
c_func
(paren
id|UMP_UART_LSR_RX_MASK
comma
id|LSR_RX_AVAIL
)paren
multiline_comment|/* receive data available */
id|MAP_FLAG
c_func
(paren
id|UMP_UART_LSR_TX_MASK
comma
id|LSR_TX_EMPTY
)paren
multiline_comment|/* transmit holding register empty */
DECL|macro|MAP_FLAG
macro_line|#undef MAP_FLAG
r_return
id|lsr
suffix:semicolon
)brace
DECL|function|handle_new_msr
r_static
r_void
id|handle_new_msr
(paren
r_struct
id|edgeport_port
op_star
id|edge_port
comma
id|__u8
id|msr
)paren
(brace
r_struct
id|async_icount
op_star
id|icount
suffix:semicolon
id|dbg
(paren
l_string|&quot;%s - %02x&quot;
comma
id|__FUNCTION__
comma
id|msr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|msr
op_amp
(paren
id|MSR_DELTA_CTS
op_or
id|MSR_DELTA_DSR
op_or
id|MSR_DELTA_RI
op_or
id|MSR_DELTA_CD
)paren
)paren
(brace
id|icount
op_assign
op_amp
id|edge_port-&gt;icount
suffix:semicolon
multiline_comment|/* update input line counters */
r_if
c_cond
(paren
id|msr
op_amp
id|MSR_DELTA_CTS
)paren
id|icount-&gt;cts
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|msr
op_amp
id|MSR_DELTA_DSR
)paren
id|icount-&gt;dsr
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|msr
op_amp
id|MSR_DELTA_CD
)paren
id|icount-&gt;dcd
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|msr
op_amp
id|MSR_DELTA_RI
)paren
id|icount-&gt;rng
op_increment
suffix:semicolon
id|wake_up_interruptible
(paren
op_amp
id|edge_port-&gt;delta_msr_wait
)paren
suffix:semicolon
)brace
multiline_comment|/* Save the new modem status */
id|edge_port-&gt;shadow_msr
op_assign
id|msr
op_amp
l_int|0xf0
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|handle_new_lsr
r_static
r_void
id|handle_new_lsr
(paren
r_struct
id|edgeport_port
op_star
id|edge_port
comma
r_int
id|lsr_data
comma
id|__u8
id|lsr
comma
id|__u8
id|data
)paren
(brace
r_struct
id|async_icount
op_star
id|icount
suffix:semicolon
id|__u8
id|new_lsr
op_assign
(paren
id|__u8
)paren
(paren
id|lsr
op_amp
(paren
id|__u8
)paren
(paren
id|LSR_OVER_ERR
op_or
id|LSR_PAR_ERR
op_or
id|LSR_FRM_ERR
op_or
id|LSR_BREAK
)paren
)paren
suffix:semicolon
id|dbg
(paren
l_string|&quot;%s - %02x&quot;
comma
id|__FUNCTION__
comma
id|new_lsr
)paren
suffix:semicolon
id|edge_port-&gt;shadow_lsr
op_assign
id|lsr
suffix:semicolon
r_if
c_cond
(paren
id|new_lsr
op_amp
id|LSR_BREAK
)paren
(brace
multiline_comment|/*&n;&t;&t; * Parity and Framing errors only count if they&n;&t;&t; * occur exclusive of a break being received.&n;&t;&t; */
id|new_lsr
op_and_assign
(paren
id|__u8
)paren
(paren
id|LSR_OVER_ERR
op_or
id|LSR_BREAK
)paren
suffix:semicolon
)brace
multiline_comment|/* Place LSR data byte into Rx buffer */
r_if
c_cond
(paren
id|lsr_data
op_logical_and
id|edge_port-&gt;port-&gt;tty
)paren
(brace
id|tty_insert_flip_char
c_func
(paren
id|edge_port-&gt;port-&gt;tty
comma
id|data
comma
l_int|0
)paren
suffix:semicolon
id|tty_flip_buffer_push
c_func
(paren
id|edge_port-&gt;port-&gt;tty
)paren
suffix:semicolon
)brace
multiline_comment|/* update input line counters */
id|icount
op_assign
op_amp
id|edge_port-&gt;icount
suffix:semicolon
r_if
c_cond
(paren
id|new_lsr
op_amp
id|LSR_BREAK
)paren
id|icount-&gt;brk
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|new_lsr
op_amp
id|LSR_OVER_ERR
)paren
id|icount-&gt;overrun
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|new_lsr
op_amp
id|LSR_PAR_ERR
)paren
id|icount-&gt;parity
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|new_lsr
op_amp
id|LSR_FRM_ERR
)paren
id|icount-&gt;frame
op_increment
suffix:semicolon
)brace
DECL|function|edge_interrupt_callback
r_static
r_void
id|edge_interrupt_callback
(paren
r_struct
id|urb
op_star
id|urb
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|edgeport_serial
op_star
id|edge_serial
op_assign
(paren
r_struct
id|edgeport_serial
op_star
)paren
id|urb-&gt;context
suffix:semicolon
r_struct
id|usb_serial_port
op_star
id|port
suffix:semicolon
r_struct
id|edgeport_port
op_star
id|edge_port
suffix:semicolon
r_int
r_char
op_star
id|data
op_assign
id|urb-&gt;transfer_buffer
suffix:semicolon
r_int
id|length
op_assign
id|urb-&gt;actual_length
suffix:semicolon
r_int
id|port_number
suffix:semicolon
r_int
id|function
suffix:semicolon
r_int
id|status
suffix:semicolon
id|__u8
id|lsr
suffix:semicolon
id|__u8
id|msr
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_if
c_cond
(paren
id|serial_paranoia_check
(paren
id|edge_serial-&gt;serial
comma
id|__FUNCTION__
)paren
)paren
(brace
r_return
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|urb-&gt;status
)paren
(brace
r_case
l_int|0
suffix:colon
multiline_comment|/* success */
r_break
suffix:semicolon
r_case
op_minus
id|ECONNRESET
suffix:colon
r_case
op_minus
id|ENOENT
suffix:colon
r_case
op_minus
id|ESHUTDOWN
suffix:colon
multiline_comment|/* this urb is terminated, clean up */
id|dbg
c_func
(paren
l_string|&quot;%s - urb shutting down with status: %d&quot;
comma
id|__FUNCTION__
comma
id|urb-&gt;status
)paren
suffix:semicolon
r_return
suffix:semicolon
r_default
suffix:colon
id|dbg
c_func
(paren
l_string|&quot;%s - nonzero urb status received: %d&quot;
comma
id|__FUNCTION__
comma
id|urb-&gt;status
)paren
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|length
)paren
(brace
id|dbg
(paren
l_string|&quot;%s - no data in urb&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
id|usb_serial_debug_data
(paren
id|__FILE__
comma
id|__FUNCTION__
comma
id|length
comma
id|data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|length
op_ne
l_int|2
)paren
(brace
id|dbg
(paren
l_string|&quot;%s - expecting packet of size 2, got %d&quot;
comma
id|__FUNCTION__
comma
id|length
)paren
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
id|port_number
op_assign
id|TIUMP_GET_PORT_FROM_CODE
(paren
id|data
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|function
op_assign
id|TIUMP_GET_FUNC_FROM_CODE
(paren
id|data
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|dbg
(paren
l_string|&quot;%s - port_number %d, function %d, info 0x%x&quot;
comma
id|__FUNCTION__
comma
id|port_number
comma
id|function
comma
id|data
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|port
op_assign
op_amp
id|edge_serial-&gt;serial-&gt;port
(braket
id|port_number
)braket
suffix:semicolon
r_if
c_cond
(paren
id|port_paranoia_check
(paren
id|port
comma
id|__FUNCTION__
)paren
)paren
(brace
id|dbg
(paren
l_string|&quot;%s - change found for port that is not present&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|edge_port
op_assign
id|usb_get_serial_port_data
c_func
(paren
id|port
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|edge_port
)paren
(brace
id|dbg
(paren
l_string|&quot;%s - edge_port not found&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|function
)paren
(brace
r_case
id|TIUMP_INTERRUPT_CODE_LSR
suffix:colon
id|lsr
op_assign
id|MapLineStatus
c_func
(paren
id|data
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lsr
op_amp
id|UMP_UART_LSR_DATA_MASK
)paren
(brace
multiline_comment|/* Save the LSR event for bulk read completion routine */
id|dbg
(paren
l_string|&quot;%s - LSR Event Port %u LSR Status = %02x&quot;
comma
id|__FUNCTION__
comma
id|port_number
comma
id|lsr
)paren
suffix:semicolon
id|edge_port-&gt;lsr_event
op_assign
l_int|1
suffix:semicolon
id|edge_port-&gt;lsr_mask
op_assign
id|lsr
suffix:semicolon
)brace
r_else
(brace
id|dbg
(paren
l_string|&quot;%s - ===== Port %d LSR Status = %02x ======&quot;
comma
id|__FUNCTION__
comma
id|port_number
comma
id|lsr
)paren
suffix:semicolon
id|handle_new_lsr
(paren
id|edge_port
comma
l_int|0
comma
id|lsr
comma
l_int|0
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|TIUMP_INTERRUPT_CODE_MSR
suffix:colon
singleline_comment|// MSR
multiline_comment|/* Copy MSR from UMP */
id|msr
op_assign
id|data
(braket
l_int|1
)braket
suffix:semicolon
id|dbg
(paren
l_string|&quot;%s - ===== Port %u MSR Status = %02x ======&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|port_number
comma
id|msr
)paren
suffix:semicolon
id|handle_new_msr
(paren
id|edge_port
comma
id|msr
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|dev_err
(paren
op_amp
id|urb-&gt;dev-&gt;dev
comma
l_string|&quot;%s - Unknown Interrupt code from UMP %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|data
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
m_exit
suffix:colon
id|status
op_assign
id|usb_submit_urb
(paren
id|urb
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
id|dev_err
(paren
op_amp
id|urb-&gt;dev-&gt;dev
comma
l_string|&quot;%s - usb_submit_urb failed with result %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|status
)paren
suffix:semicolon
)brace
DECL|function|edge_bulk_in_callback
r_static
r_void
id|edge_bulk_in_callback
(paren
r_struct
id|urb
op_star
id|urb
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|edgeport_port
op_star
id|edge_port
op_assign
(paren
r_struct
id|edgeport_port
op_star
)paren
id|urb-&gt;context
suffix:semicolon
r_int
r_char
op_star
id|data
op_assign
id|urb-&gt;transfer_buffer
suffix:semicolon
r_struct
id|tty_struct
op_star
id|tty
suffix:semicolon
r_int
id|status
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|port_number
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_if
c_cond
(paren
id|port_paranoia_check
(paren
id|edge_port-&gt;port
comma
id|__FUNCTION__
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;status
)paren
(brace
id|dbg
(paren
l_string|&quot;%s - nonzero read bulk status received: %d&quot;
comma
id|__FUNCTION__
comma
id|urb-&gt;status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;status
op_eq
op_minus
id|EPIPE
)paren
(brace
multiline_comment|/* clear any problem that might have happened on this pipe */
id|usb_clear_halt
(paren
id|edge_port-&gt;port-&gt;serial-&gt;dev
comma
id|urb-&gt;pipe
)paren
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
id|port_number
op_assign
id|edge_port-&gt;port-&gt;number
op_minus
id|edge_port-&gt;port-&gt;serial-&gt;minor
suffix:semicolon
r_if
c_cond
(paren
id|edge_port-&gt;lsr_event
)paren
(brace
id|edge_port-&gt;lsr_event
op_assign
l_int|0
suffix:semicolon
id|dbg
(paren
l_string|&quot;%s ===== Port %u LSR Status = %02x, Data = %02x ======&quot;
comma
id|__FUNCTION__
comma
id|port_number
comma
id|edge_port-&gt;lsr_mask
comma
op_star
id|data
)paren
suffix:semicolon
id|handle_new_lsr
(paren
id|edge_port
comma
l_int|1
comma
id|edge_port-&gt;lsr_mask
comma
op_star
id|data
)paren
suffix:semicolon
multiline_comment|/* Adjust buffer length/pointer */
op_decrement
id|urb-&gt;actual_length
suffix:semicolon
op_increment
id|data
suffix:semicolon
)brace
id|tty
op_assign
id|edge_port-&gt;port-&gt;tty
suffix:semicolon
r_if
c_cond
(paren
id|tty
op_logical_and
id|urb-&gt;actual_length
)paren
(brace
id|usb_serial_debug_data
(paren
id|__FILE__
comma
id|__FUNCTION__
comma
id|urb-&gt;actual_length
comma
id|data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|edge_port-&gt;close_pending
)paren
(brace
id|dbg
(paren
l_string|&quot;%s - close is pending, dropping data on the floor.&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
)brace
r_else
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|urb-&gt;actual_length
suffix:semicolon
op_increment
id|i
)paren
(brace
multiline_comment|/* if we insert more than TTY_FLIPBUF_SIZE characters,&n;&t;&t;&t;&t; * we drop them. */
r_if
c_cond
(paren
id|tty-&gt;flip.count
op_ge
id|TTY_FLIPBUF_SIZE
)paren
(brace
id|tty_flip_buffer_push
c_func
(paren
id|tty
)paren
suffix:semicolon
)brace
multiline_comment|/* this doesn&squot;t actually push the data through unless&n;&t;&t;&t;&t; * tty-&gt;low_latency is set */
id|tty_insert_flip_char
c_func
(paren
id|tty
comma
id|data
(braket
id|i
)braket
comma
l_int|0
)paren
suffix:semicolon
)brace
id|tty_flip_buffer_push
c_func
(paren
id|tty
)paren
suffix:semicolon
)brace
id|edge_port-&gt;icount.rx
op_add_assign
id|urb-&gt;actual_length
suffix:semicolon
)brace
m_exit
suffix:colon
multiline_comment|/* continue always trying to read */
id|status
op_assign
id|usb_submit_urb
(paren
id|urb
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
id|dev_err
(paren
op_amp
id|urb-&gt;dev-&gt;dev
comma
l_string|&quot;%s - usb_submit_urb failed with result %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|status
)paren
suffix:semicolon
)brace
DECL|function|edge_bulk_out_callback
r_static
r_void
id|edge_bulk_out_callback
(paren
r_struct
id|urb
op_star
id|urb
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|usb_serial_port
op_star
id|port
op_assign
(paren
r_struct
id|usb_serial_port
op_star
)paren
id|urb-&gt;context
suffix:semicolon
r_struct
id|usb_serial
op_star
id|serial
op_assign
id|get_usb_serial
(paren
id|port
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_struct
id|tty_struct
op_star
id|tty
suffix:semicolon
id|dbg
(paren
l_string|&quot;%s - port %d&quot;
comma
id|__FUNCTION__
comma
id|port-&gt;number
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|serial
)paren
(brace
id|dbg
(paren
l_string|&quot;%s - bad serial pointer, exiting&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|urb-&gt;status
)paren
(brace
id|dbg
(paren
l_string|&quot;%s - nonzero write bulk status received: %d&quot;
comma
id|__FUNCTION__
comma
id|urb-&gt;status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;status
op_eq
op_minus
id|EPIPE
)paren
(brace
multiline_comment|/* clear any problem that might have happened on this pipe */
id|usb_clear_halt
(paren
id|serial-&gt;dev
comma
id|urb-&gt;pipe
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
id|tty
op_assign
id|port-&gt;tty
suffix:semicolon
r_if
c_cond
(paren
id|tty
)paren
(brace
multiline_comment|/* let the tty driver wakeup if it has a special write_wakeup function */
r_if
c_cond
(paren
(paren
id|tty-&gt;flags
op_amp
(paren
l_int|1
op_lshift
id|TTY_DO_WRITE_WAKEUP
)paren
)paren
op_logical_and
id|tty-&gt;ldisc.write_wakeup
)paren
(brace
(paren
id|tty-&gt;ldisc.write_wakeup
)paren
(paren
id|tty
)paren
suffix:semicolon
)brace
multiline_comment|/* tell the tty driver that something has changed */
id|wake_up_interruptible
c_func
(paren
op_amp
id|tty-&gt;write_wait
)paren
suffix:semicolon
)brace
)brace
DECL|function|edge_open
r_static
r_int
id|edge_open
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_struct
id|edgeport_port
op_star
id|edge_port
op_assign
id|usb_get_serial_port_data
c_func
(paren
id|port
)paren
suffix:semicolon
r_struct
id|edgeport_serial
op_star
id|edge_serial
suffix:semicolon
r_struct
id|usb_device
op_star
id|dev
suffix:semicolon
r_struct
id|urb
op_star
id|urb
suffix:semicolon
r_int
id|port_number
suffix:semicolon
r_int
id|status
suffix:semicolon
id|u16
id|open_settings
suffix:semicolon
id|u8
id|transaction_timeout
suffix:semicolon
r_if
c_cond
(paren
id|port_paranoia_check
(paren
id|port
comma
id|__FUNCTION__
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - port %d&quot;
comma
id|__FUNCTION__
comma
id|port-&gt;number
)paren
suffix:semicolon
r_if
c_cond
(paren
id|edge_port
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
multiline_comment|/* force low_latency on so that our tty_push actually forces the data through, &n;&t;   otherwise it is scheduled, and with high data rates (like with OHCI) data&n;&t;   can get lost. */
r_if
c_cond
(paren
id|port-&gt;tty
)paren
id|port-&gt;tty-&gt;low_latency
op_assign
l_int|1
suffix:semicolon
id|port_number
op_assign
id|port-&gt;number
op_minus
id|port-&gt;serial-&gt;minor
suffix:semicolon
r_switch
c_cond
(paren
id|port_number
)paren
(brace
r_case
l_int|0
suffix:colon
id|edge_port-&gt;uart_base
op_assign
id|UMPMEM_BASE_UART1
suffix:semicolon
id|edge_port-&gt;dma_address
op_assign
id|UMPD_OEDB1_ADDRESS
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|edge_port-&gt;uart_base
op_assign
id|UMPMEM_BASE_UART2
suffix:semicolon
id|edge_port-&gt;dma_address
op_assign
id|UMPD_OEDB2_ADDRESS
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|dev_err
(paren
op_amp
id|port-&gt;dev
comma
l_string|&quot;Unknown port number!!!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|dbg
(paren
l_string|&quot;%s - port_number = %d, uart_base = %04x, dma_address = %04x&quot;
comma
id|__FUNCTION__
comma
id|port_number
comma
id|edge_port-&gt;uart_base
comma
id|edge_port-&gt;dma_address
)paren
suffix:semicolon
id|dev
op_assign
id|port-&gt;serial-&gt;dev
suffix:semicolon
id|memset
(paren
op_amp
(paren
id|edge_port-&gt;icount
)paren
comma
l_int|0x00
comma
r_sizeof
(paren
id|edge_port-&gt;icount
)paren
)paren
suffix:semicolon
id|init_waitqueue_head
(paren
op_amp
id|edge_port-&gt;delta_msr_wait
)paren
suffix:semicolon
multiline_comment|/* turn off loopback */
id|status
op_assign
id|TIClearLoopBack
(paren
id|edge_port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
r_return
id|status
suffix:semicolon
multiline_comment|/* set up the port settings */
id|edge_set_termios
(paren
id|port
comma
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/* open up the port */
multiline_comment|/* milliseconds to timeout for DMA transfer */
id|transaction_timeout
op_assign
l_int|2
suffix:semicolon
id|edge_port-&gt;ump_read_timeout
op_assign
id|max
(paren
l_int|20
comma
(paren
(paren
id|transaction_timeout
op_star
l_int|3
)paren
op_div
l_int|2
)paren
)paren
suffix:semicolon
singleline_comment|// milliseconds to timeout for DMA transfer
id|open_settings
op_assign
(paren
id|u8
)paren
(paren
id|UMP_DMA_MODE_CONTINOUS
op_or
id|UMP_PIPE_TRANS_TIMEOUT_ENA
op_or
(paren
id|transaction_timeout
op_lshift
l_int|2
)paren
)paren
suffix:semicolon
id|dbg
(paren
l_string|&quot;%s - Sending UMPC_OPEN_PORT&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
multiline_comment|/* Tell TI to open and start the port */
id|status
op_assign
id|TIWriteCommandSync
(paren
id|dev
comma
id|UMPC_OPEN_PORT
comma
(paren
id|u8
)paren
(paren
id|UMPM_UART1_PORT
op_plus
id|port_number
)paren
comma
id|open_settings
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
r_return
id|status
suffix:semicolon
multiline_comment|/* Start the DMA? */
id|status
op_assign
id|TIWriteCommandSync
(paren
id|dev
comma
id|UMPC_START_PORT
comma
(paren
id|u8
)paren
(paren
id|UMPM_UART1_PORT
op_plus
id|port_number
)paren
comma
l_int|0
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
r_return
id|status
suffix:semicolon
multiline_comment|/* Clear TX and RX buffers in UMP */
id|status
op_assign
id|TIPurgeDataSync
(paren
id|port
comma
id|UMP_PORT_DIR_OUT
op_or
id|UMP_PORT_DIR_IN
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
r_return
id|status
suffix:semicolon
multiline_comment|/* Read Initial MSR */
id|status
op_assign
id|TIReadVendorRequestSync
(paren
id|dev
comma
id|UMPC_READ_MSR
comma
singleline_comment|// Request
l_int|0
comma
singleline_comment|// wValue
(paren
id|__u16
)paren
(paren
id|UMPM_UART1_PORT
op_plus
id|port_number
)paren
comma
singleline_comment|// wIndex (Address)
op_amp
id|edge_port-&gt;shadow_msr
comma
singleline_comment|// TransferBuffer
l_int|1
)paren
suffix:semicolon
singleline_comment|// TransferBufferLength
r_if
c_cond
(paren
id|status
)paren
r_return
id|status
suffix:semicolon
id|dbg
(paren
l_string|&quot;ShadowMSR 0x%X&quot;
comma
id|edge_port-&gt;shadow_msr
)paren
suffix:semicolon
id|edge_serial
op_assign
id|edge_port-&gt;edge_serial
suffix:semicolon
r_if
c_cond
(paren
id|edge_serial-&gt;num_ports_open
op_eq
l_int|0
)paren
(brace
multiline_comment|/* we are the first port to be opened, let&squot;s post the interrupt urb */
id|urb
op_assign
id|edge_serial-&gt;serial-&gt;port
(braket
l_int|0
)braket
dot
id|interrupt_in_urb
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|urb
)paren
(brace
id|dev_err
(paren
op_amp
id|port-&gt;dev
comma
l_string|&quot;%s - no interrupt urb present, exiting&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|urb-&gt;complete
op_assign
id|edge_interrupt_callback
suffix:semicolon
id|urb-&gt;context
op_assign
id|edge_serial
suffix:semicolon
id|urb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|status
op_assign
id|usb_submit_urb
(paren
id|urb
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
(brace
id|dev_err
(paren
op_amp
id|port-&gt;dev
comma
l_string|&quot;%s - usb_submit_urb failed with value %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|status
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t; * reset the data toggle on the bulk endpoints to work around bug in&n;&t; * host controllers where things get out of sync some times&n;&t; */
id|usb_clear_halt
(paren
id|dev
comma
id|port-&gt;write_urb-&gt;pipe
)paren
suffix:semicolon
id|usb_clear_halt
(paren
id|dev
comma
id|port-&gt;read_urb-&gt;pipe
)paren
suffix:semicolon
multiline_comment|/* start up our bulk read urb */
id|urb
op_assign
id|port-&gt;read_urb
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|urb
)paren
(brace
id|dev_err
(paren
op_amp
id|port-&gt;dev
comma
l_string|&quot;%s - no read urb present, exiting&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|urb-&gt;complete
op_assign
id|edge_bulk_in_callback
suffix:semicolon
id|urb-&gt;context
op_assign
id|edge_port
suffix:semicolon
id|urb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|status
op_assign
id|usb_submit_urb
(paren
id|urb
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
(brace
id|dev_err
(paren
op_amp
id|port-&gt;dev
comma
l_string|&quot;%s - read bulk usb_submit_urb failed with value %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|status
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
op_increment
id|edge_serial-&gt;num_ports_open
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - exited&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|edge_close
r_static
r_void
id|edge_close
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_struct
id|usb_serial
op_star
id|serial
suffix:semicolon
r_struct
id|edgeport_serial
op_star
id|edge_serial
suffix:semicolon
r_struct
id|edgeport_port
op_star
id|edge_port
suffix:semicolon
r_int
id|port_number
suffix:semicolon
r_int
id|status
suffix:semicolon
r_if
c_cond
(paren
id|port_paranoia_check
(paren
id|port
comma
id|__FUNCTION__
)paren
)paren
r_return
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - port %d&quot;
comma
id|__FUNCTION__
comma
id|port-&gt;number
)paren
suffix:semicolon
id|serial
op_assign
id|get_usb_serial
(paren
id|port
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|serial
)paren
r_return
suffix:semicolon
id|edge_serial
op_assign
id|usb_get_serial_data
c_func
(paren
id|serial
)paren
suffix:semicolon
id|edge_port
op_assign
id|usb_get_serial_port_data
c_func
(paren
id|port
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|edge_serial
op_eq
l_int|NULL
)paren
op_logical_or
(paren
id|edge_port
op_eq
l_int|NULL
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|serial-&gt;dev
)paren
(brace
multiline_comment|/* The bulkreadcompletion routine will check &n;&t;&t; * this flag and dump add read data */
id|edge_port-&gt;close_pending
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* chase the port close */
id|TIChasePort
(paren
id|edge_port
)paren
suffix:semicolon
id|usb_unlink_urb
(paren
id|port-&gt;read_urb
)paren
suffix:semicolon
multiline_comment|/* assuming we can still talk to the device,&n;&t;&t; * send a close port command to it */
id|dbg
c_func
(paren
l_string|&quot;%s - send umpc_close_port&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|port_number
op_assign
id|port-&gt;number
op_minus
id|port-&gt;serial-&gt;minor
suffix:semicolon
id|status
op_assign
id|TIWriteCommandSync
(paren
id|port-&gt;serial-&gt;dev
comma
id|UMPC_CLOSE_PORT
comma
(paren
id|__u8
)paren
(paren
id|UMPM_UART1_PORT
op_plus
id|port_number
)paren
comma
l_int|0
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
op_decrement
id|edge_port-&gt;edge_serial-&gt;num_ports_open
suffix:semicolon
r_if
c_cond
(paren
id|edge_port-&gt;edge_serial-&gt;num_ports_open
op_le
l_int|0
)paren
(brace
multiline_comment|/* last port is now closed, let&squot;s shut down our interrupt urb */
id|usb_unlink_urb
(paren
id|serial-&gt;port
(braket
l_int|0
)braket
dot
id|interrupt_in_urb
)paren
suffix:semicolon
id|edge_port-&gt;edge_serial-&gt;num_ports_open
op_assign
l_int|0
suffix:semicolon
)brace
id|edge_port-&gt;close_pending
op_assign
l_int|0
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;%s - exited&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
)brace
DECL|function|edge_write
r_static
r_int
id|edge_write
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_int
id|from_user
comma
r_const
r_int
r_char
op_star
id|data
comma
r_int
id|count
)paren
(brace
r_struct
id|usb_serial
op_star
id|serial
op_assign
id|port-&gt;serial
suffix:semicolon
r_struct
id|edgeport_port
op_star
id|edge_port
op_assign
id|usb_get_serial_port_data
c_func
(paren
id|port
)paren
suffix:semicolon
r_int
id|result
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - port %d&quot;
comma
id|__FUNCTION__
comma
id|port-&gt;number
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
op_eq
l_int|0
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;%s - write request of 0 bytes&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|edge_port
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|edge_port-&gt;close_pending
op_eq
l_int|1
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|port-&gt;write_urb-&gt;status
op_eq
op_minus
id|EINPROGRESS
)paren
(brace
id|dbg
(paren
l_string|&quot;%s - already writing&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|count
op_assign
id|min
(paren
id|count
comma
id|port-&gt;bulk_out_size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|from_user
)paren
(brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|port-&gt;write_urb-&gt;transfer_buffer
comma
id|data
comma
id|count
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_else
(brace
id|memcpy
(paren
id|port-&gt;write_urb-&gt;transfer_buffer
comma
id|data
comma
id|count
)paren
suffix:semicolon
)brace
id|usb_serial_debug_data
(paren
id|__FILE__
comma
id|__FUNCTION__
comma
id|count
comma
id|port-&gt;write_urb-&gt;transfer_buffer
)paren
suffix:semicolon
multiline_comment|/* set up our urb */
id|usb_fill_bulk_urb
(paren
id|port-&gt;write_urb
comma
id|serial-&gt;dev
comma
id|usb_sndbulkpipe
(paren
id|serial-&gt;dev
comma
id|port-&gt;bulk_out_endpointAddress
)paren
comma
id|port-&gt;write_urb-&gt;transfer_buffer
comma
id|count
comma
id|edge_bulk_out_callback
comma
id|port
)paren
suffix:semicolon
multiline_comment|/* send the data out the bulk port */
id|result
op_assign
id|usb_submit_urb
c_func
(paren
id|port-&gt;write_urb
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
id|dev_err
c_func
(paren
op_amp
id|port-&gt;dev
comma
l_string|&quot;%s - failed submitting write urb, error %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|result
)paren
suffix:semicolon
r_else
id|result
op_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
id|result
OG
l_int|0
)paren
id|edge_port-&gt;icount.tx
op_add_assign
id|count
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
DECL|function|edge_write_room
r_static
r_int
id|edge_write_room
(paren
r_struct
id|usb_serial_port
op_star
id|port
)paren
(brace
r_struct
id|edgeport_port
op_star
id|edge_port
op_assign
id|usb_get_serial_port_data
c_func
(paren
id|port
)paren
suffix:semicolon
r_int
id|room
op_assign
l_int|0
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_if
c_cond
(paren
id|edge_port
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|edge_port-&gt;close_pending
op_eq
l_int|1
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - port %d&quot;
comma
id|__FUNCTION__
comma
id|port-&gt;number
)paren
suffix:semicolon
r_if
c_cond
(paren
id|port-&gt;write_urb-&gt;status
op_ne
op_minus
id|EINPROGRESS
)paren
id|room
op_assign
id|port-&gt;bulk_out_size
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - returns %d&quot;
comma
id|__FUNCTION__
comma
id|room
)paren
suffix:semicolon
r_return
id|room
suffix:semicolon
)brace
DECL|function|edge_chars_in_buffer
r_static
r_int
id|edge_chars_in_buffer
(paren
r_struct
id|usb_serial_port
op_star
id|port
)paren
(brace
r_struct
id|edgeport_port
op_star
id|edge_port
op_assign
id|usb_get_serial_port_data
c_func
(paren
id|port
)paren
suffix:semicolon
r_int
id|chars
op_assign
l_int|0
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_if
c_cond
(paren
id|edge_port
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|edge_port-&gt;close_pending
op_eq
l_int|1
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - port %d&quot;
comma
id|__FUNCTION__
comma
id|port-&gt;number
)paren
suffix:semicolon
r_if
c_cond
(paren
id|port-&gt;write_urb-&gt;status
op_eq
op_minus
id|EINPROGRESS
)paren
id|chars
op_assign
id|port-&gt;write_urb-&gt;transfer_buffer_length
suffix:semicolon
id|dbg
(paren
l_string|&quot;%s - returns %d&quot;
comma
id|__FUNCTION__
comma
id|chars
)paren
suffix:semicolon
r_return
id|chars
suffix:semicolon
)brace
DECL|function|edge_throttle
r_static
r_void
id|edge_throttle
(paren
r_struct
id|usb_serial_port
op_star
id|port
)paren
(brace
r_struct
id|edgeport_port
op_star
id|edge_port
op_assign
id|usb_get_serial_port_data
c_func
(paren
id|port
)paren
suffix:semicolon
r_struct
id|tty_struct
op_star
id|tty
suffix:semicolon
r_int
id|status
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - port %d&quot;
comma
id|__FUNCTION__
comma
id|port-&gt;number
)paren
suffix:semicolon
r_if
c_cond
(paren
id|edge_port
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|tty
op_assign
id|port-&gt;tty
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tty
)paren
(brace
id|dbg
(paren
l_string|&quot;%s - no tty available&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* if we are implementing XON/XOFF, send the stop character */
r_if
c_cond
(paren
id|I_IXOFF
c_func
(paren
id|tty
)paren
)paren
(brace
r_int
r_char
id|stop_char
op_assign
id|STOP_CHAR
c_func
(paren
id|tty
)paren
suffix:semicolon
id|status
op_assign
id|edge_write
(paren
id|port
comma
l_int|0
comma
op_amp
id|stop_char
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_le
l_int|0
)paren
(brace
r_return
suffix:semicolon
)brace
)brace
multiline_comment|/* if we are implementing RTS/CTS, toggle that line */
r_if
c_cond
(paren
id|tty-&gt;termios-&gt;c_cflag
op_amp
id|CRTSCTS
)paren
(brace
id|status
op_assign
id|TIClearRts
(paren
id|edge_port
)paren
suffix:semicolon
)brace
id|usb_unlink_urb
(paren
id|port-&gt;read_urb
)paren
suffix:semicolon
)brace
DECL|function|edge_unthrottle
r_static
r_void
id|edge_unthrottle
(paren
r_struct
id|usb_serial_port
op_star
id|port
)paren
(brace
r_struct
id|edgeport_port
op_star
id|edge_port
op_assign
id|usb_get_serial_port_data
c_func
(paren
id|port
)paren
suffix:semicolon
r_struct
id|tty_struct
op_star
id|tty
suffix:semicolon
r_int
id|status
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - port %d&quot;
comma
id|__FUNCTION__
comma
id|port-&gt;number
)paren
suffix:semicolon
r_if
c_cond
(paren
id|edge_port
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|tty
op_assign
id|port-&gt;tty
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tty
)paren
(brace
id|dbg
(paren
l_string|&quot;%s - no tty available&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* if we are implementing XON/XOFF, send the start character */
r_if
c_cond
(paren
id|I_IXOFF
c_func
(paren
id|tty
)paren
)paren
(brace
r_int
r_char
id|start_char
op_assign
id|START_CHAR
c_func
(paren
id|tty
)paren
suffix:semicolon
id|status
op_assign
id|edge_write
(paren
id|port
comma
l_int|0
comma
op_amp
id|start_char
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_le
l_int|0
)paren
(brace
r_return
suffix:semicolon
)brace
)brace
multiline_comment|/* if we are implementing RTS/CTS, toggle that line */
r_if
c_cond
(paren
id|tty-&gt;termios-&gt;c_cflag
op_amp
id|CRTSCTS
)paren
(brace
id|status
op_assign
id|TISetRts
(paren
id|edge_port
)paren
suffix:semicolon
)brace
id|port-&gt;read_urb-&gt;dev
op_assign
id|port-&gt;serial-&gt;dev
suffix:semicolon
id|status
op_assign
id|usb_submit_urb
(paren
id|port-&gt;read_urb
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
(brace
id|dev_err
(paren
op_amp
id|port-&gt;dev
comma
l_string|&quot;%s - usb_submit_urb failed with value %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|status
)paren
suffix:semicolon
)brace
)brace
DECL|function|change_port_settings
r_static
r_void
id|change_port_settings
(paren
r_struct
id|edgeport_port
op_star
id|edge_port
comma
r_struct
id|termios
op_star
id|old_termios
)paren
(brace
r_struct
id|ump_uart_config
op_star
id|config
suffix:semicolon
r_struct
id|tty_struct
op_star
id|tty
suffix:semicolon
r_int
id|baud
suffix:semicolon
r_int
id|round
suffix:semicolon
r_int
id|cflag
suffix:semicolon
r_int
id|status
suffix:semicolon
r_int
id|port_number
op_assign
id|edge_port-&gt;port-&gt;number
op_minus
id|edge_port-&gt;port-&gt;serial-&gt;minor
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - port %d&quot;
comma
id|__FUNCTION__
comma
id|edge_port-&gt;port-&gt;number
)paren
suffix:semicolon
id|tty
op_assign
id|edge_port-&gt;port-&gt;tty
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
id|tty
)paren
op_logical_or
(paren
op_logical_neg
id|tty-&gt;termios
)paren
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;%s - no tty structures&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|config
op_assign
id|kmalloc
(paren
r_sizeof
(paren
op_star
id|config
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|config
)paren
(brace
id|dev_err
(paren
op_amp
id|edge_port-&gt;port-&gt;dev
comma
l_string|&quot;%s - out of memory&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|cflag
op_assign
id|tty-&gt;termios-&gt;c_cflag
suffix:semicolon
id|config-&gt;wFlags
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* These flags must be set */
id|config-&gt;wFlags
op_or_assign
id|UMP_MASK_UART_FLAGS_RECEIVE_MS_INT
suffix:semicolon
id|config-&gt;wFlags
op_or_assign
id|UMP_MASK_UART_FLAGS_AUTO_START_ON_ERR
suffix:semicolon
id|config-&gt;bUartMode
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|cflag
op_amp
id|CSIZE
)paren
(brace
r_case
id|CS5
suffix:colon
id|config-&gt;bDataBits
op_assign
id|UMP_UART_CHAR5BITS
suffix:semicolon
id|dbg
(paren
l_string|&quot;%s - data bits = 5&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS6
suffix:colon
id|config-&gt;bDataBits
op_assign
id|UMP_UART_CHAR6BITS
suffix:semicolon
id|dbg
(paren
l_string|&quot;%s - data bits = 6&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS7
suffix:colon
id|config-&gt;bDataBits
op_assign
id|UMP_UART_CHAR7BITS
suffix:semicolon
id|dbg
(paren
l_string|&quot;%s - data bits = 7&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_case
id|CS8
suffix:colon
id|config-&gt;bDataBits
op_assign
id|UMP_UART_CHAR8BITS
suffix:semicolon
id|dbg
(paren
l_string|&quot;%s - data bits = 8&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cflag
op_amp
id|PARENB
)paren
(brace
r_if
c_cond
(paren
id|cflag
op_amp
id|PARODD
)paren
(brace
id|config-&gt;wFlags
op_or_assign
id|UMP_MASK_UART_FLAGS_PARITY
suffix:semicolon
id|config-&gt;bParity
op_assign
id|UMP_UART_ODDPARITY
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - parity = odd&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
)brace
r_else
(brace
id|config-&gt;wFlags
op_or_assign
id|UMP_MASK_UART_FLAGS_PARITY
suffix:semicolon
id|config-&gt;bParity
op_assign
id|UMP_UART_EVENPARITY
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - parity = even&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|config-&gt;bParity
op_assign
id|UMP_UART_NOPARITY
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - parity = none&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cflag
op_amp
id|CSTOPB
)paren
(brace
id|config-&gt;bStopBits
op_assign
id|UMP_UART_STOPBIT2
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - stop bits = 2&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
)brace
r_else
(brace
id|config-&gt;bStopBits
op_assign
id|UMP_UART_STOPBIT1
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - stop bits = 1&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
)brace
multiline_comment|/* figure out the flow control settings */
r_if
c_cond
(paren
id|cflag
op_amp
id|CRTSCTS
)paren
(brace
id|config-&gt;wFlags
op_or_assign
id|UMP_MASK_UART_FLAGS_OUT_X_CTS_FLOW
suffix:semicolon
id|config-&gt;wFlags
op_or_assign
id|UMP_MASK_UART_FLAGS_RTS_FLOW
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - RTS/CTS is enabled&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
)brace
r_else
(brace
id|dbg
c_func
(paren
l_string|&quot;%s - RTS/CTS is disabled&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
)brace
multiline_comment|/* if we are implementing XON/XOFF, set the start and stop character in the device */
r_if
c_cond
(paren
id|I_IXOFF
c_func
(paren
id|tty
)paren
op_logical_or
id|I_IXON
c_func
(paren
id|tty
)paren
)paren
(brace
id|config-&gt;cXon
op_assign
id|START_CHAR
c_func
(paren
id|tty
)paren
suffix:semicolon
id|config-&gt;cXoff
op_assign
id|STOP_CHAR
c_func
(paren
id|tty
)paren
suffix:semicolon
multiline_comment|/* if we are implementing INBOUND XON/XOFF */
r_if
c_cond
(paren
id|I_IXOFF
c_func
(paren
id|tty
)paren
)paren
(brace
id|config-&gt;wFlags
op_or_assign
id|UMP_MASK_UART_FLAGS_IN_X
suffix:semicolon
id|dbg
(paren
l_string|&quot;%s - INBOUND XON/XOFF is enabled, XON = %2x, XOFF = %2x&quot;
comma
id|__FUNCTION__
comma
id|config-&gt;cXon
comma
id|config-&gt;cXoff
)paren
suffix:semicolon
)brace
r_else
(brace
id|dbg
(paren
l_string|&quot;%s - INBOUND XON/XOFF is disabled&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
)brace
multiline_comment|/* if we are implementing OUTBOUND XON/XOFF */
r_if
c_cond
(paren
id|I_IXON
c_func
(paren
id|tty
)paren
)paren
(brace
id|config-&gt;wFlags
op_or_assign
id|UMP_MASK_UART_FLAGS_OUT_X
suffix:semicolon
id|dbg
(paren
l_string|&quot;%s - OUTBOUND XON/XOFF is enabled, XON = %2x, XOFF = %2x&quot;
comma
id|__FUNCTION__
comma
id|config-&gt;cXon
comma
id|config-&gt;cXoff
)paren
suffix:semicolon
)brace
r_else
(brace
id|dbg
(paren
l_string|&quot;%s - OUTBOUND XON/XOFF is disabled&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Round the baud rate */
id|baud
op_assign
id|tty_get_baud_rate
c_func
(paren
id|tty
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|baud
)paren
(brace
multiline_comment|/* pick a default, any default... */
id|baud
op_assign
l_int|9600
suffix:semicolon
)brace
id|config-&gt;wBaudRate
op_assign
(paren
id|__u16
)paren
(paren
l_int|461550L
op_div
id|baud
)paren
suffix:semicolon
id|round
op_assign
l_int|4615500L
op_div
id|baud
suffix:semicolon
r_if
c_cond
(paren
(paren
id|round
op_minus
(paren
id|config-&gt;wBaudRate
op_star
l_int|10
)paren
)paren
op_ge
l_int|5
)paren
id|config-&gt;wBaudRate
op_increment
suffix:semicolon
id|dbg
(paren
l_string|&quot;%s - baud rate = %d, wBaudRate = %d&quot;
comma
id|__FUNCTION__
comma
id|baud
comma
id|config-&gt;wBaudRate
)paren
suffix:semicolon
id|dbg
(paren
l_string|&quot;wBaudRate:   %d&quot;
comma
(paren
r_int
)paren
(paren
l_int|461550L
op_div
id|config-&gt;wBaudRate
)paren
)paren
suffix:semicolon
id|dbg
(paren
l_string|&quot;wFlags:    0x%x&quot;
comma
id|config-&gt;wFlags
)paren
suffix:semicolon
id|dbg
(paren
l_string|&quot;bDataBits:   %d&quot;
comma
id|config-&gt;bDataBits
)paren
suffix:semicolon
id|dbg
(paren
l_string|&quot;bParity:     %d&quot;
comma
id|config-&gt;bParity
)paren
suffix:semicolon
id|dbg
(paren
l_string|&quot;bStopBits:   %d&quot;
comma
id|config-&gt;bStopBits
)paren
suffix:semicolon
id|dbg
(paren
l_string|&quot;cXon:        %d&quot;
comma
id|config-&gt;cXon
)paren
suffix:semicolon
id|dbg
(paren
l_string|&quot;cXoff:       %d&quot;
comma
id|config-&gt;cXoff
)paren
suffix:semicolon
id|dbg
(paren
l_string|&quot;bUartMode:   %d&quot;
comma
id|config-&gt;bUartMode
)paren
suffix:semicolon
multiline_comment|/* move the word values into big endian mode */
id|cpu_to_be16s
(paren
op_amp
id|config-&gt;wFlags
)paren
suffix:semicolon
id|cpu_to_be16s
(paren
op_amp
id|config-&gt;wBaudRate
)paren
suffix:semicolon
id|status
op_assign
id|TIWriteCommandSync
(paren
id|edge_port-&gt;port-&gt;serial-&gt;dev
comma
id|UMPC_SET_CONFIG
comma
(paren
id|__u8
)paren
(paren
id|UMPM_UART1_PORT
op_plus
id|port_number
)paren
comma
l_int|0
comma
(paren
id|__u8
op_star
)paren
id|config
comma
r_sizeof
(paren
op_star
id|config
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
(brace
id|dbg
(paren
l_string|&quot;%s - error %d when trying to write config to device&quot;
comma
id|__FUNCTION__
comma
id|status
)paren
suffix:semicolon
)brace
id|kfree
(paren
id|config
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|edge_set_termios
r_static
r_void
id|edge_set_termios
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|termios
op_star
id|old_termios
)paren
(brace
r_struct
id|edgeport_port
op_star
id|edge_port
op_assign
id|usb_get_serial_port_data
c_func
(paren
id|port
)paren
suffix:semicolon
r_struct
id|tty_struct
op_star
id|tty
op_assign
id|port-&gt;tty
suffix:semicolon
r_int
r_int
id|cflag
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|port-&gt;tty
op_logical_or
op_logical_neg
id|port-&gt;tty-&gt;termios
)paren
(brace
id|dbg
(paren
l_string|&quot;%s - no tty or termios&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|cflag
op_assign
id|tty-&gt;termios-&gt;c_cflag
suffix:semicolon
multiline_comment|/* check that they really want us to change something */
r_if
c_cond
(paren
id|old_termios
)paren
(brace
r_if
c_cond
(paren
(paren
id|cflag
op_eq
id|old_termios-&gt;c_cflag
)paren
op_logical_and
(paren
id|RELEVANT_IFLAG
c_func
(paren
id|tty-&gt;termios-&gt;c_iflag
)paren
op_eq
id|RELEVANT_IFLAG
c_func
(paren
id|old_termios-&gt;c_iflag
)paren
)paren
)paren
(brace
id|dbg
(paren
l_string|&quot;%s - nothing to change&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
id|dbg
c_func
(paren
l_string|&quot;%s - clfag %08x iflag %08x&quot;
comma
id|__FUNCTION__
comma
id|tty-&gt;termios-&gt;c_cflag
comma
id|RELEVANT_IFLAG
c_func
(paren
id|tty-&gt;termios-&gt;c_iflag
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|old_termios
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;%s - old clfag %08x old iflag %08x&quot;
comma
id|__FUNCTION__
comma
id|old_termios-&gt;c_cflag
comma
id|RELEVANT_IFLAG
c_func
(paren
id|old_termios-&gt;c_iflag
)paren
)paren
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;%s - port %d&quot;
comma
id|__FUNCTION__
comma
id|port-&gt;number
)paren
suffix:semicolon
r_if
c_cond
(paren
id|edge_port
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
multiline_comment|/* change the port settings to the new ones specified */
id|change_port_settings
(paren
id|edge_port
comma
id|old_termios
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|edge_tiocmset
r_static
r_int
id|edge_tiocmset
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|set
comma
r_int
r_int
id|clear
)paren
(brace
r_struct
id|edgeport_port
op_star
id|edge_port
op_assign
id|usb_get_serial_port_data
c_func
(paren
id|port
)paren
suffix:semicolon
r_int
r_int
id|mcr
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - port %d&quot;
comma
id|__FUNCTION__
comma
id|port-&gt;number
)paren
suffix:semicolon
id|mcr
op_assign
id|edge_port-&gt;shadow_mcr
suffix:semicolon
r_if
c_cond
(paren
id|set
op_amp
id|TIOCM_RTS
)paren
id|mcr
op_or_assign
id|MCR_RTS
suffix:semicolon
r_if
c_cond
(paren
id|set
op_amp
id|TIOCM_DTR
)paren
id|mcr
op_or_assign
id|MCR_DTR
suffix:semicolon
r_if
c_cond
(paren
id|set
op_amp
id|TIOCM_LOOP
)paren
id|mcr
op_or_assign
id|MCR_LOOPBACK
suffix:semicolon
r_if
c_cond
(paren
id|clear
op_amp
id|TIOCM_RTS
)paren
id|mcr
op_and_assign
op_complement
id|MCR_RTS
suffix:semicolon
r_if
c_cond
(paren
id|clear
op_amp
id|TIOCM_DTR
)paren
id|mcr
op_and_assign
op_complement
id|MCR_DTR
suffix:semicolon
r_if
c_cond
(paren
id|clear
op_amp
id|TIOCM_LOOP
)paren
id|mcr
op_and_assign
op_complement
id|MCR_LOOPBACK
suffix:semicolon
id|edge_port-&gt;shadow_mcr
op_assign
id|mcr
suffix:semicolon
id|TIRestoreMCR
(paren
id|edge_port
comma
id|mcr
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|edge_tiocmget
r_static
r_int
id|edge_tiocmget
c_func
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|edgeport_port
op_star
id|edge_port
op_assign
id|usb_get_serial_port_data
c_func
(paren
id|port
)paren
suffix:semicolon
r_int
r_int
id|result
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|msr
suffix:semicolon
r_int
r_int
id|mcr
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - port %d&quot;
comma
id|__FUNCTION__
comma
id|port-&gt;number
)paren
suffix:semicolon
id|msr
op_assign
id|edge_port-&gt;shadow_msr
suffix:semicolon
id|mcr
op_assign
id|edge_port-&gt;shadow_mcr
suffix:semicolon
id|result
op_assign
(paren
(paren
id|mcr
op_amp
id|MCR_DTR
)paren
ques
c_cond
id|TIOCM_DTR
suffix:colon
l_int|0
)paren
multiline_comment|/* 0x002 */
op_or
(paren
(paren
id|mcr
op_amp
id|MCR_RTS
)paren
ques
c_cond
id|TIOCM_RTS
suffix:colon
l_int|0
)paren
multiline_comment|/* 0x004 */
op_or
(paren
(paren
id|msr
op_amp
id|MSR_CTS
)paren
ques
c_cond
id|TIOCM_CTS
suffix:colon
l_int|0
)paren
multiline_comment|/* 0x020 */
op_or
(paren
(paren
id|msr
op_amp
id|MSR_CD
)paren
ques
c_cond
id|TIOCM_CAR
suffix:colon
l_int|0
)paren
multiline_comment|/* 0x040 */
op_or
(paren
(paren
id|msr
op_amp
id|MSR_RI
)paren
ques
c_cond
id|TIOCM_RI
suffix:colon
l_int|0
)paren
multiline_comment|/* 0x080 */
op_or
(paren
(paren
id|msr
op_amp
id|MSR_DSR
)paren
ques
c_cond
id|TIOCM_DSR
suffix:colon
l_int|0
)paren
suffix:semicolon
multiline_comment|/* 0x100 */
id|dbg
c_func
(paren
l_string|&quot;%s -- %x&quot;
comma
id|__FUNCTION__
comma
id|result
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
DECL|function|get_serial_info
r_static
r_int
id|get_serial_info
(paren
r_struct
id|edgeport_port
op_star
id|edge_port
comma
r_struct
id|serial_struct
op_star
id|retinfo
)paren
(brace
r_struct
id|serial_struct
id|tmp
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|retinfo
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|tmp
comma
l_int|0
comma
r_sizeof
(paren
id|tmp
)paren
)paren
suffix:semicolon
id|tmp.type
op_assign
id|PORT_16550A
suffix:semicolon
id|tmp.line
op_assign
id|edge_port-&gt;port-&gt;serial-&gt;minor
suffix:semicolon
id|tmp.port
op_assign
id|edge_port-&gt;port-&gt;number
suffix:semicolon
id|tmp.irq
op_assign
l_int|0
suffix:semicolon
id|tmp.flags
op_assign
id|ASYNC_SKIP_TEST
op_or
id|ASYNC_AUTO_IRQ
suffix:semicolon
id|tmp.xmit_fifo_size
op_assign
id|edge_port-&gt;port-&gt;bulk_out_size
suffix:semicolon
id|tmp.baud_base
op_assign
l_int|9600
suffix:semicolon
id|tmp.close_delay
op_assign
l_int|5
op_star
id|HZ
suffix:semicolon
id|tmp.closing_wait
op_assign
l_int|30
op_star
id|HZ
suffix:semicolon
singleline_comment|//&t;tmp.custom_divisor&t;= state-&gt;custom_divisor;
singleline_comment|//&t;tmp.hub6&t;&t;= state-&gt;hub6;
singleline_comment|//&t;tmp.io_type&t;&t;= state-&gt;io_type;
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|retinfo
comma
op_amp
id|tmp
comma
r_sizeof
(paren
op_star
id|retinfo
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|edge_ioctl
r_static
r_int
id|edge_ioctl
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_struct
id|edgeport_port
op_star
id|edge_port
op_assign
id|usb_get_serial_port_data
c_func
(paren
id|port
)paren
suffix:semicolon
r_struct
id|async_icount
id|cnow
suffix:semicolon
r_struct
id|async_icount
id|cprev
suffix:semicolon
id|dbg
c_func
(paren
l_string|&quot;%s - port %d, cmd = 0x%x&quot;
comma
id|__FUNCTION__
comma
id|port-&gt;number
comma
id|cmd
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|TIOCINQ
suffix:colon
id|dbg
c_func
(paren
l_string|&quot;%s - (%d) TIOCINQ&quot;
comma
id|__FUNCTION__
comma
id|port-&gt;number
)paren
suffix:semicolon
singleline_comment|//&t;&t;&t;return get_number_bytes_avail(edge_port, (unsigned int *) arg);
r_break
suffix:semicolon
r_case
id|TIOCSERGETLSR
suffix:colon
id|dbg
c_func
(paren
l_string|&quot;%s - (%d) TIOCSERGETLSR&quot;
comma
id|__FUNCTION__
comma
id|port-&gt;number
)paren
suffix:semicolon
singleline_comment|//&t;&t;&t;return get_lsr_info(edge_port, (unsigned int *) arg);
r_break
suffix:semicolon
r_case
id|TIOCGSERIAL
suffix:colon
id|dbg
c_func
(paren
l_string|&quot;%s - (%d) TIOCGSERIAL&quot;
comma
id|__FUNCTION__
comma
id|port-&gt;number
)paren
suffix:semicolon
r_return
id|get_serial_info
c_func
(paren
id|edge_port
comma
(paren
r_struct
id|serial_struct
op_star
)paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TIOCSSERIAL
suffix:colon
id|dbg
c_func
(paren
l_string|&quot;%s - (%d) TIOCSSERIAL&quot;
comma
id|__FUNCTION__
comma
id|port-&gt;number
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TIOCMIWAIT
suffix:colon
id|dbg
c_func
(paren
l_string|&quot;%s - (%d) TIOCMIWAIT&quot;
comma
id|__FUNCTION__
comma
id|port-&gt;number
)paren
suffix:semicolon
id|cprev
op_assign
id|edge_port-&gt;icount
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|interruptible_sleep_on
c_func
(paren
op_amp
id|edge_port-&gt;delta_msr_wait
)paren
suffix:semicolon
multiline_comment|/* see if a signal did it */
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
r_return
op_minus
id|ERESTARTSYS
suffix:semicolon
id|cnow
op_assign
id|edge_port-&gt;icount
suffix:semicolon
r_if
c_cond
(paren
id|cnow.rng
op_eq
id|cprev.rng
op_logical_and
id|cnow.dsr
op_eq
id|cprev.dsr
op_logical_and
id|cnow.dcd
op_eq
id|cprev.dcd
op_logical_and
id|cnow.cts
op_eq
id|cprev.cts
)paren
r_return
op_minus
id|EIO
suffix:semicolon
multiline_comment|/* no change =&gt; error */
r_if
c_cond
(paren
(paren
(paren
id|arg
op_amp
id|TIOCM_RNG
)paren
op_logical_and
(paren
id|cnow.rng
op_ne
id|cprev.rng
)paren
)paren
op_logical_or
(paren
(paren
id|arg
op_amp
id|TIOCM_DSR
)paren
op_logical_and
(paren
id|cnow.dsr
op_ne
id|cprev.dsr
)paren
)paren
op_logical_or
(paren
(paren
id|arg
op_amp
id|TIOCM_CD
)paren
op_logical_and
(paren
id|cnow.dcd
op_ne
id|cprev.dcd
)paren
)paren
op_logical_or
(paren
(paren
id|arg
op_amp
id|TIOCM_CTS
)paren
op_logical_and
(paren
id|cnow.cts
op_ne
id|cprev.cts
)paren
)paren
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|cprev
op_assign
id|cnow
suffix:semicolon
)brace
multiline_comment|/* not reached */
r_break
suffix:semicolon
r_case
id|TIOCGICOUNT
suffix:colon
id|dbg
(paren
l_string|&quot;%s - (%d) TIOCGICOUNT RX=%d, TX=%d&quot;
comma
id|__FUNCTION__
comma
id|port-&gt;number
comma
id|edge_port-&gt;icount.rx
comma
id|edge_port-&gt;icount.tx
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|edge_port-&gt;icount
comma
r_sizeof
(paren
id|edge_port-&gt;icount
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
)brace
DECL|function|edge_break
r_static
r_void
id|edge_break
(paren
r_struct
id|usb_serial_port
op_star
id|port
comma
r_int
id|break_state
)paren
(brace
r_struct
id|edgeport_port
op_star
id|edge_port
op_assign
id|usb_get_serial_port_data
c_func
(paren
id|port
)paren
suffix:semicolon
r_int
id|status
suffix:semicolon
id|dbg
(paren
l_string|&quot;%s - state = %d&quot;
comma
id|__FUNCTION__
comma
id|break_state
)paren
suffix:semicolon
multiline_comment|/* chase the port close */
id|TIChasePort
(paren
id|edge_port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|break_state
op_eq
op_minus
l_int|1
)paren
(brace
id|status
op_assign
id|TISetBreak
(paren
id|edge_port
)paren
suffix:semicolon
)brace
r_else
(brace
id|status
op_assign
id|TIClearBreak
(paren
id|edge_port
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
)paren
(brace
id|dbg
(paren
l_string|&quot;%s - error %d sending break set/clear command.&quot;
comma
id|__FUNCTION__
comma
id|status
)paren
suffix:semicolon
)brace
)brace
DECL|function|edge_startup
r_static
r_int
id|edge_startup
(paren
r_struct
id|usb_serial
op_star
id|serial
)paren
(brace
r_struct
id|edgeport_serial
op_star
id|edge_serial
suffix:semicolon
r_struct
id|edgeport_port
op_star
id|edge_port
suffix:semicolon
r_struct
id|usb_device
op_star
id|dev
suffix:semicolon
r_int
id|status
suffix:semicolon
r_int
id|i
suffix:semicolon
id|dev
op_assign
id|serial-&gt;dev
suffix:semicolon
multiline_comment|/* create our private serial structure */
id|edge_serial
op_assign
id|kmalloc
(paren
r_sizeof
(paren
r_struct
id|edgeport_serial
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|edge_serial
op_eq
l_int|NULL
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|serial-&gt;dev-&gt;dev
comma
l_string|&quot;%s - Out of memory&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
(paren
id|edge_serial
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|edgeport_serial
)paren
)paren
suffix:semicolon
id|edge_serial-&gt;serial
op_assign
id|serial
suffix:semicolon
id|usb_set_serial_data
c_func
(paren
id|serial
comma
id|edge_serial
)paren
suffix:semicolon
id|status
op_assign
id|TIDownloadFirmware
(paren
id|edge_serial
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
(brace
id|kfree
(paren
id|edge_serial
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/* set up our port private structures */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|serial-&gt;num_ports
suffix:semicolon
op_increment
id|i
)paren
(brace
id|edge_port
op_assign
id|kmalloc
(paren
r_sizeof
(paren
r_struct
id|edgeport_port
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|edge_port
op_eq
l_int|NULL
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|serial-&gt;dev-&gt;dev
comma
l_string|&quot;%s - Out of memory&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
(paren
id|edge_port
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|edgeport_port
)paren
)paren
suffix:semicolon
id|edge_port-&gt;port
op_assign
op_amp
id|serial-&gt;port
(braket
id|i
)braket
suffix:semicolon
id|edge_port-&gt;edge_serial
op_assign
id|edge_serial
suffix:semicolon
id|usb_set_serial_port_data
c_func
(paren
op_amp
id|serial-&gt;port
(braket
id|i
)braket
comma
id|edge_port
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|edge_shutdown
r_static
r_void
id|edge_shutdown
(paren
r_struct
id|usb_serial
op_star
id|serial
)paren
(brace
r_int
id|i
suffix:semicolon
id|dbg
(paren
l_string|&quot;%s&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|serial-&gt;num_ports
suffix:semicolon
op_increment
id|i
)paren
(brace
id|kfree
(paren
id|usb_get_serial_port_data
c_func
(paren
op_amp
id|serial-&gt;port
(braket
id|i
)braket
)paren
)paren
suffix:semicolon
id|usb_set_serial_port_data
c_func
(paren
op_amp
id|serial-&gt;port
(braket
id|i
)braket
comma
l_int|NULL
)paren
suffix:semicolon
)brace
id|kfree
(paren
id|usb_get_serial_data
c_func
(paren
id|serial
)paren
)paren
suffix:semicolon
id|usb_set_serial_data
c_func
(paren
id|serial
comma
l_int|NULL
)paren
suffix:semicolon
)brace
DECL|variable|edgeport_1port_device
r_static
r_struct
id|usb_serial_device_type
id|edgeport_1port_device
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|name
op_assign
l_string|&quot;Edgeport TI 1 port adapter&quot;
comma
dot
id|short_name
op_assign
l_string|&quot;edgeport_ti_1&quot;
comma
dot
id|id_table
op_assign
id|edgeport_1port_id_table
comma
dot
id|num_interrupt_in
op_assign
l_int|1
comma
dot
id|num_bulk_in
op_assign
l_int|1
comma
dot
id|num_bulk_out
op_assign
l_int|1
comma
dot
id|num_ports
op_assign
l_int|1
comma
dot
id|open
op_assign
id|edge_open
comma
dot
id|close
op_assign
id|edge_close
comma
dot
id|throttle
op_assign
id|edge_throttle
comma
dot
id|unthrottle
op_assign
id|edge_unthrottle
comma
dot
id|attach
op_assign
id|edge_startup
comma
dot
id|shutdown
op_assign
id|edge_shutdown
comma
dot
id|ioctl
op_assign
id|edge_ioctl
comma
dot
id|set_termios
op_assign
id|edge_set_termios
comma
dot
id|tiocmget
op_assign
id|edge_tiocmget
comma
dot
id|tiocmset
op_assign
id|edge_tiocmset
comma
dot
id|write
op_assign
id|edge_write
comma
dot
id|write_room
op_assign
id|edge_write_room
comma
dot
id|chars_in_buffer
op_assign
id|edge_chars_in_buffer
comma
dot
id|break_ctl
op_assign
id|edge_break
comma
)brace
suffix:semicolon
DECL|variable|edgeport_2port_device
r_static
r_struct
id|usb_serial_device_type
id|edgeport_2port_device
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|name
op_assign
l_string|&quot;Edgeport TI 2 port adapter&quot;
comma
dot
id|short_name
op_assign
l_string|&quot;edgeport_ti_2&quot;
comma
dot
id|id_table
op_assign
id|edgeport_2port_id_table
comma
dot
id|num_interrupt_in
op_assign
l_int|1
comma
dot
id|num_bulk_in
op_assign
l_int|2
comma
dot
id|num_bulk_out
op_assign
l_int|2
comma
dot
id|num_ports
op_assign
l_int|2
comma
dot
id|open
op_assign
id|edge_open
comma
dot
id|close
op_assign
id|edge_close
comma
dot
id|throttle
op_assign
id|edge_throttle
comma
dot
id|unthrottle
op_assign
id|edge_unthrottle
comma
dot
id|attach
op_assign
id|edge_startup
comma
dot
id|shutdown
op_assign
id|edge_shutdown
comma
dot
id|ioctl
op_assign
id|edge_ioctl
comma
dot
id|set_termios
op_assign
id|edge_set_termios
comma
dot
id|tiocmget
op_assign
id|edge_tiocmget
comma
dot
id|tiocmset
op_assign
id|edge_tiocmset
comma
dot
id|write
op_assign
id|edge_write
comma
dot
id|write_room
op_assign
id|edge_write_room
comma
dot
id|chars_in_buffer
op_assign
id|edge_chars_in_buffer
comma
dot
id|break_ctl
op_assign
id|edge_break
comma
)brace
suffix:semicolon
DECL|function|edgeport_init
r_static
r_int
id|__init
id|edgeport_init
c_func
(paren
r_void
)paren
(brace
id|usb_serial_register
(paren
op_amp
id|edgeport_1port_device
)paren
suffix:semicolon
id|usb_serial_register
(paren
op_amp
id|edgeport_2port_device
)paren
suffix:semicolon
id|usb_register
(paren
op_amp
id|io_driver
)paren
suffix:semicolon
id|info
c_func
(paren
id|DRIVER_DESC
l_string|&quot; &quot;
id|DRIVER_VERSION
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|edgeport_exit
r_static
r_void
id|__exit
id|edgeport_exit
(paren
r_void
)paren
(brace
id|usb_deregister
(paren
op_amp
id|io_driver
)paren
suffix:semicolon
id|usb_serial_deregister
(paren
op_amp
id|edgeport_1port_device
)paren
suffix:semicolon
id|usb_serial_deregister
(paren
op_amp
id|edgeport_2port_device
)paren
suffix:semicolon
)brace
DECL|variable|edgeport_init
id|module_init
c_func
(paren
id|edgeport_init
)paren
suffix:semicolon
DECL|variable|edgeport_exit
id|module_exit
c_func
(paren
id|edgeport_exit
)paren
suffix:semicolon
multiline_comment|/* Module information */
DECL|variable|DRIVER_AUTHOR
id|MODULE_AUTHOR
c_func
(paren
id|DRIVER_AUTHOR
)paren
suffix:semicolon
DECL|variable|DRIVER_DESC
id|MODULE_DESCRIPTION
c_func
(paren
id|DRIVER_DESC
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|debug
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|debug
comma
l_string|&quot;Debug enabled or not&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|ignore_cpu_rev
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|ignore_cpu_rev
comma
l_string|&quot;Ignore the cpu revision when connecting to a device&quot;
)paren
suffix:semicolon
eof
