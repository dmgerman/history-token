multiline_comment|/*&n; * Common routines for a handful of drivers.&n; * Unrelated to CF/SM - just scatter-gather stuff.&n; */
macro_line|#include &quot;usb.h&quot;
macro_line|#include &quot;raw_bulk.h&quot;
multiline_comment|/*&n; * The routines below convert scatter-gather to single buffer.&n; * Some drivers claim this is necessary.&n; * Nothing is done when use_sg is zero.&n; */
multiline_comment|/*&n; * Copy from scatter-gather buffer into a newly allocated single buffer,&n; * starting at a given index and offset.&n; * When done, update index and offset.&n; * Return a pointer to the single buffer.&n; */
r_int
r_char
op_star
DECL|function|us_copy_from_sgbuf
id|us_copy_from_sgbuf
c_func
(paren
r_int
r_char
op_star
id|content
comma
r_int
id|len
comma
r_int
op_star
id|index
comma
r_int
op_star
id|offset
comma
r_int
id|use_sg
)paren
(brace
r_struct
id|scatterlist
op_star
id|sg
suffix:semicolon
r_int
r_char
op_star
id|buffer
suffix:semicolon
r_int
id|transferred
comma
id|i
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|use_sg
)paren
r_return
id|content
suffix:semicolon
id|sg
op_assign
(paren
r_struct
id|scatterlist
op_star
)paren
id|content
suffix:semicolon
id|buffer
op_assign
id|kmalloc
c_func
(paren
id|len
comma
id|GFP_NOIO
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buffer
op_eq
l_int|NULL
)paren
r_return
l_int|NULL
suffix:semicolon
id|transferred
op_assign
l_int|0
suffix:semicolon
id|i
op_assign
op_star
id|index
suffix:semicolon
r_while
c_loop
(paren
id|i
OL
id|use_sg
op_logical_and
id|transferred
OL
id|len
)paren
(brace
r_int
r_char
op_star
id|ptr
suffix:semicolon
r_int
r_int
id|length
comma
id|room
suffix:semicolon
id|ptr
op_assign
id|sg_address
c_func
(paren
id|sg
(braket
id|i
)braket
)paren
op_plus
op_star
id|offset
suffix:semicolon
id|room
op_assign
id|sg
(braket
id|i
)braket
dot
id|length
op_minus
op_star
id|offset
suffix:semicolon
id|length
op_assign
id|len
op_minus
id|transferred
suffix:semicolon
r_if
c_cond
(paren
id|length
OG
id|room
)paren
id|length
op_assign
id|room
suffix:semicolon
id|memcpy
c_func
(paren
id|buffer
op_plus
id|transferred
comma
id|ptr
comma
id|length
)paren
suffix:semicolon
id|transferred
op_add_assign
id|length
suffix:semicolon
op_star
id|offset
op_add_assign
id|length
suffix:semicolon
r_if
c_cond
(paren
id|length
op_eq
id|room
)paren
(brace
id|i
op_increment
suffix:semicolon
op_star
id|offset
op_assign
l_int|0
suffix:semicolon
)brace
)brace
op_star
id|index
op_assign
id|i
suffix:semicolon
r_return
id|buffer
suffix:semicolon
)brace
r_int
r_char
op_star
DECL|function|us_copy_from_sgbuf_all
id|us_copy_from_sgbuf_all
c_func
(paren
r_int
r_char
op_star
id|content
comma
r_int
id|len
comma
r_int
id|use_sg
)paren
(brace
r_int
id|index
comma
id|offset
suffix:semicolon
id|index
op_assign
id|offset
op_assign
l_int|0
suffix:semicolon
r_return
id|us_copy_from_sgbuf
c_func
(paren
id|content
comma
id|len
comma
op_amp
id|index
comma
op_amp
id|offset
comma
id|use_sg
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Copy from a single buffer into a scatter-gather buffer,&n; * starting at a given index and offset.&n; * When done, update index and offset.&n; */
r_void
DECL|function|us_copy_to_sgbuf
id|us_copy_to_sgbuf
c_func
(paren
r_int
r_char
op_star
id|buffer
comma
r_int
id|buflen
comma
r_void
op_star
id|content
comma
r_int
op_star
id|index
comma
r_int
op_star
id|offset
comma
r_int
id|use_sg
)paren
(brace
r_struct
id|scatterlist
op_star
id|sg
suffix:semicolon
r_int
id|i
comma
id|transferred
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|use_sg
)paren
r_return
suffix:semicolon
id|transferred
op_assign
l_int|0
suffix:semicolon
id|sg
op_assign
id|content
suffix:semicolon
id|i
op_assign
op_star
id|index
suffix:semicolon
r_while
c_loop
(paren
id|i
OL
id|use_sg
op_logical_and
id|transferred
OL
id|buflen
)paren
(brace
r_int
r_char
op_star
id|ptr
suffix:semicolon
r_int
r_int
id|length
comma
id|room
suffix:semicolon
id|ptr
op_assign
id|sg_address
c_func
(paren
id|sg
(braket
id|i
)braket
)paren
op_plus
op_star
id|offset
suffix:semicolon
id|room
op_assign
id|sg
(braket
id|i
)braket
dot
id|length
op_minus
op_star
id|offset
suffix:semicolon
id|length
op_assign
id|buflen
op_minus
id|transferred
suffix:semicolon
r_if
c_cond
(paren
id|length
OG
id|room
)paren
id|length
op_assign
id|room
suffix:semicolon
id|memcpy
c_func
(paren
id|ptr
comma
id|buffer
op_plus
id|transferred
comma
id|length
)paren
suffix:semicolon
id|transferred
op_add_assign
id|sg
(braket
id|i
)braket
dot
id|length
suffix:semicolon
op_star
id|offset
op_add_assign
id|length
suffix:semicolon
r_if
c_cond
(paren
id|length
op_eq
id|room
)paren
(brace
id|i
op_increment
suffix:semicolon
op_star
id|offset
op_assign
l_int|0
suffix:semicolon
)brace
)brace
op_star
id|index
op_assign
id|i
suffix:semicolon
)brace
r_void
DECL|function|us_copy_to_sgbuf_all
id|us_copy_to_sgbuf_all
c_func
(paren
r_int
r_char
op_star
id|buffer
comma
r_int
id|buflen
comma
r_void
op_star
id|content
comma
r_int
id|use_sg
)paren
(brace
r_int
id|index
comma
id|offset
suffix:semicolon
id|index
op_assign
id|offset
op_assign
l_int|0
suffix:semicolon
id|us_copy_to_sgbuf
c_func
(paren
id|buffer
comma
id|buflen
comma
id|content
comma
op_amp
id|index
comma
op_amp
id|offset
comma
id|use_sg
)paren
suffix:semicolon
)brace
eof
