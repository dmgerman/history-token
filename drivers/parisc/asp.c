multiline_comment|/*&n; *&t;ASP Device Driver&n; *&n; *&t;(c) Copyright 2000 The Puffin Group Inc.&n; *&n; *&t;This program is free software; you can redistribute it and/or modify&n; *&t;it under the terms of the GNU General Public License as published by&n; *      the Free Software Foundation; either version 2 of the License, or&n; *      (at your option) any later version.&n; *&n; *&t;by Helge Deller &lt;deller@gmx.de&gt;&n; */
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/led.h&gt;
macro_line|#include &quot;gsc.h&quot;
DECL|macro|ASP_GSC_IRQ
mdefine_line|#define ASP_GSC_IRQ&t;3&t;&t;/* hardcoded interrupt for GSC */
DECL|macro|ASP_VER_OFFSET
mdefine_line|#define ASP_VER_OFFSET &t;0x20&t;&t;/* offset of ASP version */
DECL|macro|ASP_LED_ADDR
mdefine_line|#define ASP_LED_ADDR&t;0xf0800020
DECL|macro|VIPER_INT_WORD
mdefine_line|#define VIPER_INT_WORD  0xFFFBF088      /* addr of viper interrupt word */
DECL|variable|asp
r_static
r_struct
id|gsc_asic
id|asp
suffix:semicolon
DECL|function|asp_choose_irq
r_static
r_void
id|asp_choose_irq
c_func
(paren
r_struct
id|parisc_device
op_star
id|dev
comma
r_void
op_star
id|ctrl
)paren
(brace
r_int
id|irq
suffix:semicolon
r_switch
c_cond
(paren
id|dev-&gt;id.sversion
)paren
(brace
r_case
l_int|0x71
suffix:colon
id|irq
op_assign
l_int|9
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* SCSI */
r_case
l_int|0x72
suffix:colon
id|irq
op_assign
l_int|8
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* LAN */
r_case
l_int|0x73
suffix:colon
id|irq
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* HIL */
r_case
l_int|0x74
suffix:colon
id|irq
op_assign
l_int|7
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* Centronics */
r_case
l_int|0x75
suffix:colon
id|irq
op_assign
(paren
id|dev-&gt;hw_path
op_eq
l_int|4
)paren
ques
c_cond
l_int|5
suffix:colon
l_int|6
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* RS232 */
r_case
l_int|0x76
suffix:colon
id|irq
op_assign
l_int|10
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* EISA BA */
r_case
l_int|0x77
suffix:colon
id|irq
op_assign
l_int|11
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* Graphics1 */
r_case
l_int|0x7a
suffix:colon
id|irq
op_assign
l_int|13
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* Audio (Bushmaster) */
r_case
l_int|0x7b
suffix:colon
id|irq
op_assign
l_int|13
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* Audio (Scorpio) */
r_case
l_int|0x7c
suffix:colon
id|irq
op_assign
l_int|3
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* FW SCSI */
r_case
l_int|0x7d
suffix:colon
id|irq
op_assign
l_int|4
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* FDDI */
r_case
l_int|0x7f
suffix:colon
id|irq
op_assign
l_int|13
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* Audio (Outfield) */
r_default
suffix:colon
r_return
suffix:semicolon
multiline_comment|/* Unknown */
)brace
id|gsc_asic_assign_irq
c_func
(paren
id|ctrl
comma
id|irq
comma
op_amp
id|dev-&gt;irq
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|dev-&gt;id.sversion
)paren
(brace
r_case
l_int|0x73
suffix:colon
id|irq
op_assign
l_int|2
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* i8042 High-priority */
r_case
l_int|0x76
suffix:colon
id|irq
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* EISA BA */
r_default
suffix:colon
r_return
suffix:semicolon
multiline_comment|/* Other */
)brace
id|gsc_asic_assign_irq
c_func
(paren
id|ctrl
comma
id|irq
comma
op_amp
id|dev-&gt;aux_irq
)paren
suffix:semicolon
)brace
multiline_comment|/* There are two register ranges we&squot;re interested in.  Interrupt /&n; * Status / LED are at 0xf080xxxx and Asp special registers are at&n; * 0xf082fxxx.  PDC only tells us that Asp is at 0xf082f000, so for&n; * the purposes of interrupt handling, we have to tell other bits of&n; * the kernel to look at the other registers.&n; */
DECL|macro|ASP_INTERRUPT_ADDR
mdefine_line|#define ASP_INTERRUPT_ADDR 0xf0800000
r_int
id|__init
DECL|function|asp_init_chip
id|asp_init_chip
c_func
(paren
r_struct
id|parisc_device
op_star
id|dev
)paren
(brace
r_struct
id|gsc_irq
id|gsc_irq
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|asp.version
op_assign
id|gsc_readb
c_func
(paren
id|dev-&gt;hpa
op_plus
id|ASP_VER_OFFSET
)paren
op_amp
l_int|0xf
suffix:semicolon
id|asp.name
op_assign
(paren
id|asp.version
op_eq
l_int|1
)paren
ques
c_cond
l_string|&quot;Asp&quot;
suffix:colon
l_string|&quot;Cutoff&quot;
suffix:semicolon
id|asp.hpa
op_assign
id|ASP_INTERRUPT_ADDR
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s version %d at 0x%lx found.&bslash;n&quot;
comma
id|asp.name
comma
id|asp.version
comma
id|dev-&gt;hpa
)paren
suffix:semicolon
multiline_comment|/* the IRQ ASP should use */
id|ret
op_assign
op_minus
id|EBUSY
suffix:semicolon
id|dev-&gt;irq
op_assign
id|gsc_claim_irq
c_func
(paren
op_amp
id|gsc_irq
comma
id|ASP_GSC_IRQ
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;irq
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s(): cannot get GSC irq&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|asp.eim
op_assign
(paren
(paren
id|u32
)paren
id|gsc_irq.txn_addr
)paren
op_or
id|gsc_irq.txn_data
suffix:semicolon
id|ret
op_assign
id|request_irq
c_func
(paren
id|gsc_irq.irq
comma
id|gsc_asic_intr
comma
l_int|0
comma
l_string|&quot;asp&quot;
comma
op_amp
id|asp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* Program VIPER to interrupt on the ASP irq */
id|gsc_writel
c_func
(paren
(paren
l_int|1
op_lshift
(paren
l_int|31
op_minus
id|ASP_GSC_IRQ
)paren
)paren
comma
id|VIPER_INT_WORD
)paren
suffix:semicolon
multiline_comment|/* Done init&squot;ing, register this driver */
id|ret
op_assign
id|gsc_common_setup
c_func
(paren
id|dev
comma
op_amp
id|asp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_goto
id|out
suffix:semicolon
id|gsc_fixup_irqs
c_func
(paren
id|dev
comma
op_amp
id|asp
comma
id|asp_choose_irq
)paren
suffix:semicolon
multiline_comment|/* Mongoose is a sibling of Asp, not a child... */
id|gsc_fixup_irqs
c_func
(paren
id|parisc_parent
c_func
(paren
id|dev
)paren
comma
op_amp
id|asp
comma
id|asp_choose_irq
)paren
suffix:semicolon
multiline_comment|/* initialize the chassis LEDs */
macro_line|#ifdef CONFIG_CHASSIS_LCD_LED&t;
id|register_led_driver
c_func
(paren
id|DISPLAY_MODEL_OLD_ASP
comma
id|LED_CMD_REG_NONE
comma
id|ASP_LED_ADDR
)paren
suffix:semicolon
macro_line|#endif
id|out
suffix:colon
r_return
id|ret
suffix:semicolon
)brace
DECL|variable|asp_tbl
r_static
r_struct
id|parisc_device_id
id|asp_tbl
(braket
)braket
op_assign
(brace
(brace
id|HPHW_BA
comma
id|HVERSION_REV_ANY_ID
comma
id|HVERSION_ANY_ID
comma
l_int|0x00070
)brace
comma
(brace
l_int|0
comma
)brace
)brace
suffix:semicolon
DECL|variable|asp_driver
r_struct
id|parisc_driver
id|asp_driver
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;Asp&quot;
comma
dot
id|id_table
op_assign
id|asp_tbl
comma
dot
id|probe
op_assign
id|asp_init_chip
comma
)brace
suffix:semicolon
eof
