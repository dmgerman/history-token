multiline_comment|/*      National Semiconductor NS87560UBD Super I/O controller used in&n; *      HP [BCJ]x000 workstations.&n; *&n; *      This chip is a horrid piece of engineering, and National&n; *      denies any knowledge of its existence. Thus no datasheet is&n; *      available off www.national.com. &n; *&n; *&t;(C) Copyright 2000 Linuxcare, Inc.&n; * &t;(C) Copyright 2000 Linuxcare Canada, Inc.&n; *&t;(C) Copyright 2000 Martin K. Petersen &lt;mkp@linuxcare.com&gt;&n; * &t;(C) Copyright 2000 Alex deVries &lt;alex@onefishtwo.ca&gt;&n; *      (C) Copyright 2001 John Marvin &lt;jsm fc hp com&gt;&n; *      (C) Copyright 2003 Grant Grundler &lt;grundler parisc-linux org&gt;&n; *&n; *&t;This program is free software; you can redistribute it and/or&n; *&t;modify it under the terms of the GNU General Public License as&n; *&t;published by the Free Software Foundation; either version 2 of&n; *&t;the License, or (at your option) any later version.  &n; *&n; *&t;The initial version of this is by Martin Peterson.  Alex deVries&n; *&t;has spent a bit of time trying to coax it into working.&n; *&n; *      Major changes to get basic interrupt infrastructure working to&n; *      hopefully be able to support all SuperIO devices. Currently&n; *      works with serial. -- John Marvin &lt;jsm@fc.hp.com&gt;&n; */
multiline_comment|/* NOTES:&n; * &n; * Function 0 is an IDE controller. It is identical to a PC87415 IDE&n; * controller (and identifies itself as such).&n; *&n; * Function 1 is a &quot;Legacy I/O&quot; controller. Under this function is a&n; * whole mess of legacy I/O peripherals. Of course, HP hasn&squot;t enabled&n; * all the functionality in hardware, but the following is available:&n; *&n; *      Two 16550A compatible serial controllers&n; *      An IEEE 1284 compatible parallel port&n; *      A floppy disk controller&n; *&n; * Function 2 is a USB controller.&n; *&n; * We must be incredibly careful during initialization.  Since all&n; * interrupts are routed through function 1 (which is not allowed by&n; * the PCI spec), we need to program the PICs on the legacy I/O port&n; * *before* we attempt to set up IDE and USB.  @#$!&amp;&n; *&n; * According to HP, devices are only enabled by firmware if they have&n; * a physical device connected.&n; *&n; * Configuration register bits:&n; *     0x5A: FDC, SP1, IDE1, SP2, IDE2, PAR, Reserved, P92&n; *     0x5B: RTC, 8259, 8254, DMA1, DMA2, KBC, P61, APM&n; *&n; */
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/serial.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/parport.h&gt;
macro_line|#include &lt;linux/parport_pc.h&gt;
macro_line|#include &lt;linux/termios.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/serial_core.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/hardware.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/superio.h&gt;
DECL|variable|sio_dev
r_static
r_struct
id|superio_device
id|sio_dev
suffix:semicolon
DECL|macro|DEBUG_SUPERIO_INIT
macro_line|#undef DEBUG_SUPERIO_INIT
macro_line|#ifdef DEBUG_SUPERIO_INIT
DECL|macro|DBG_INIT
mdefine_line|#define DBG_INIT(x...)  printk(x)
macro_line|#else
DECL|macro|DBG_INIT
mdefine_line|#define DBG_INIT(x...)
macro_line|#endif
r_static
id|irqreturn_t
DECL|function|superio_interrupt
id|superio_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|devp
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|superio_device
op_star
id|sio
op_assign
(paren
r_struct
id|superio_device
op_star
)paren
id|devp
suffix:semicolon
id|u8
id|results
suffix:semicolon
id|u8
id|local_irq
suffix:semicolon
multiline_comment|/* Poll the 8259 to see if there&squot;s an interrupt. */
id|outb
(paren
id|OCW3_POLL
comma
id|IC_PIC1
op_plus
l_int|0
)paren
suffix:semicolon
id|results
op_assign
id|inb
c_func
(paren
id|IC_PIC1
op_plus
l_int|0
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Bit    7:&t;1 = active Interrupt; 0 = no Interrupt pending&n;&t; * Bits 6-3:&t;zero&n;&t; * Bits 2-0:&t;highest priority, active requesting interrupt ID (0-7)&n;&t; */
r_if
c_cond
(paren
(paren
id|results
op_amp
l_int|0x80
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* I suspect &quot;spurious&quot; interrupts are from unmasking an IRQ.&n;&t;&t; * We don&squot;t know if an interrupt was/is pending and thus&n;&t;&t; * just call the handler for that IRQ as if it were pending.&n;&t;&t; */
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
multiline_comment|/* Check to see which device is interrupting */
id|local_irq
op_assign
id|results
op_amp
l_int|0x0f
suffix:semicolon
r_if
c_cond
(paren
id|local_irq
op_eq
l_int|2
op_logical_or
id|local_irq
OG
l_int|7
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;SuperIO: slave interrupted!&bslash;n&quot;
)paren
suffix:semicolon
id|BUG
c_func
(paren
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
r_if
c_cond
(paren
id|local_irq
op_eq
l_int|7
)paren
(brace
multiline_comment|/* Could be spurious. Check in service bits */
id|outb
c_func
(paren
id|OCW3_ISR
comma
id|IC_PIC1
op_plus
l_int|0
)paren
suffix:semicolon
id|results
op_assign
id|inb
c_func
(paren
id|IC_PIC1
op_plus
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|results
op_amp
l_int|0x80
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* if ISR7 not set: spurious */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;SuperIO: spurious interrupt!&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
)brace
multiline_comment|/* Call the appropriate device&squot;s interrupt */
id|do_irq
c_func
(paren
op_amp
id|sio-&gt;irq_region-&gt;action
(braket
id|local_irq
)braket
comma
id|sio-&gt;irq_region-&gt;data.irqbase
op_plus
id|local_irq
comma
id|regs
)paren
suffix:semicolon
multiline_comment|/* set EOI - forces a new interrupt if a lower priority device&n;&t; * still needs service.&n;&t; */
id|outb
c_func
(paren
(paren
id|OCW2_SEOI
op_or
id|local_irq
)paren
comma
id|IC_PIC1
op_plus
l_int|0
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
multiline_comment|/* Initialize Super I/O device */
r_static
r_void
id|__devinit
DECL|function|superio_init
id|superio_init
c_func
(paren
r_struct
id|superio_device
op_star
id|sio
)paren
(brace
r_struct
id|pci_dev
op_star
id|pdev
op_assign
id|sio-&gt;lio_pdev
suffix:semicolon
id|u16
id|word
suffix:semicolon
r_if
c_cond
(paren
id|sio-&gt;suckyio_irq_enabled
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pdev
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sio-&gt;usb_pdev
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* use the IRQ iosapic found for USB INT D... */
id|pdev-&gt;irq
op_assign
id|sio-&gt;usb_pdev-&gt;irq
suffix:semicolon
multiline_comment|/* ...then properly fixup the USB to point at suckyio PIC */
id|sio-&gt;usb_pdev-&gt;irq
op_assign
id|superio_fixup_irq
c_func
(paren
id|sio-&gt;usb_pdev
)paren
suffix:semicolon
id|printk
(paren
id|KERN_INFO
l_string|&quot;SuperIO: Found NS87560 Legacy I/O device at %s (IRQ %i) &bslash;n&quot;
comma
id|pci_name
c_func
(paren
id|pdev
)paren
comma
id|pdev-&gt;irq
)paren
suffix:semicolon
id|pci_read_config_dword
(paren
id|pdev
comma
id|SIO_SP1BAR
comma
op_amp
id|sio-&gt;sp1_base
)paren
suffix:semicolon
id|sio-&gt;sp1_base
op_and_assign
op_complement
l_int|1
suffix:semicolon
id|printk
(paren
id|KERN_INFO
l_string|&quot;SuperIO: Serial port 1 at 0x%x&bslash;n&quot;
comma
id|sio-&gt;sp1_base
)paren
suffix:semicolon
id|pci_read_config_dword
(paren
id|pdev
comma
id|SIO_SP2BAR
comma
op_amp
id|sio-&gt;sp2_base
)paren
suffix:semicolon
id|sio-&gt;sp2_base
op_and_assign
op_complement
l_int|1
suffix:semicolon
id|printk
(paren
id|KERN_INFO
l_string|&quot;SuperIO: Serial port 2 at 0x%x&bslash;n&quot;
comma
id|sio-&gt;sp2_base
)paren
suffix:semicolon
id|pci_read_config_dword
(paren
id|pdev
comma
id|SIO_PPBAR
comma
op_amp
id|sio-&gt;pp_base
)paren
suffix:semicolon
id|sio-&gt;pp_base
op_and_assign
op_complement
l_int|1
suffix:semicolon
id|printk
(paren
id|KERN_INFO
l_string|&quot;SuperIO: Parallel port at 0x%x&bslash;n&quot;
comma
id|sio-&gt;pp_base
)paren
suffix:semicolon
id|pci_read_config_dword
(paren
id|pdev
comma
id|SIO_FDCBAR
comma
op_amp
id|sio-&gt;fdc_base
)paren
suffix:semicolon
id|sio-&gt;fdc_base
op_and_assign
op_complement
l_int|1
suffix:semicolon
id|printk
(paren
id|KERN_INFO
l_string|&quot;SuperIO: Floppy controller at 0x%x&bslash;n&quot;
comma
id|sio-&gt;fdc_base
)paren
suffix:semicolon
id|pci_read_config_dword
(paren
id|pdev
comma
id|SIO_ACPIBAR
comma
op_amp
id|sio-&gt;acpi_base
)paren
suffix:semicolon
id|sio-&gt;acpi_base
op_and_assign
op_complement
l_int|1
suffix:semicolon
id|printk
(paren
id|KERN_INFO
l_string|&quot;SuperIO: ACPI at 0x%x&bslash;n&quot;
comma
id|sio-&gt;acpi_base
)paren
suffix:semicolon
id|request_region
(paren
id|IC_PIC1
comma
l_int|0x1f
comma
l_string|&quot;pic1&quot;
)paren
suffix:semicolon
id|request_region
(paren
id|IC_PIC2
comma
l_int|0x1f
comma
l_string|&quot;pic2&quot;
)paren
suffix:semicolon
id|request_region
(paren
id|sio-&gt;acpi_base
comma
l_int|0x1f
comma
l_string|&quot;acpi&quot;
)paren
suffix:semicolon
multiline_comment|/* Enable the legacy I/O function */
id|pci_read_config_word
(paren
id|pdev
comma
id|PCI_COMMAND
comma
op_amp
id|word
)paren
suffix:semicolon
id|word
op_or_assign
id|PCI_COMMAND_SERR
op_or
id|PCI_COMMAND_PARITY
op_or
id|PCI_COMMAND_IO
suffix:semicolon
id|pci_write_config_word
(paren
id|pdev
comma
id|PCI_COMMAND
comma
id|word
)paren
suffix:semicolon
id|pci_set_master
(paren
id|pdev
)paren
suffix:semicolon
id|pci_enable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Next project is programming the onboard interrupt controllers.&n;&t; * PDC hasn&squot;t done this for us, since it&squot;s using polled I/O.&n;&t; *&n;&t; * XXX Use dword writes to avoid bugs in Elroy or Suckyio Config&n;&t; *     space access.  PCI is by nature a 32-bit bus and config&n;&t; *     space can be sensitive to that.&n;&t; */
multiline_comment|/* 0x64 - 0x67 :&n;&t;&t;DMA Rtg 2&n;&t;&t;DMA Rtg 3&n;&t;&t;DMA Chan Ctl&n;&t;&t;TRIGGER_1    == 0x82   USB &amp; IDE level triggered, rest to edge&n;&t;*/
id|pci_write_config_dword
(paren
id|pdev
comma
l_int|0x64
comma
l_int|0x82000000U
)paren
suffix:semicolon
multiline_comment|/* 0x68 - 0x6b :&n;&t;&t;TRIGGER_2    == 0x00   all edge triggered (not used)&n;&t;&t;CFG_IR_SER   == 0x43   SerPort1 = IRQ3, SerPort2 = IRQ4&n;&t;&t;CFG_IR_PF    == 0x65   ParPort  = IRQ5, FloppyCtlr = IRQ6&n;&t;&t;CFG_IR_IDE   == 0x07   IDE1 = IRQ7, reserved&n;&t;*/
id|pci_write_config_dword
(paren
id|pdev
comma
id|TRIGGER_2
comma
l_int|0x07654300U
)paren
suffix:semicolon
multiline_comment|/* 0x6c - 0x6f :&n;&t;&t;CFG_IR_INTAB == 0x00&n;&t;&t;CFG_IR_INTCD == 0x10   USB = IRQ1&n;&t;&t;CFG_IR_PS2   == 0x00&n;&t;&t;CFG_IR_FXBUS == 0x00&n;&t;*/
id|pci_write_config_dword
(paren
id|pdev
comma
id|CFG_IR_INTAB
comma
l_int|0x00001000U
)paren
suffix:semicolon
multiline_comment|/* 0x70 - 0x73 :&n;&t;&t;CFG_IR_USB   == 0x00  not used. USB is connected to INTD.&n;&t;&t;CFG_IR_ACPI  == 0x00  not used.&n;&t;&t;DMA Priority == 0x4c88  Power on default value. NFC.&n;&t;*/
id|pci_write_config_dword
(paren
id|pdev
comma
id|CFG_IR_USB
comma
l_int|0x4c880000U
)paren
suffix:semicolon
multiline_comment|/* PIC1 Initialization Command Word register programming */
id|outb
(paren
l_int|0x11
comma
id|IC_PIC1
op_plus
l_int|0
)paren
suffix:semicolon
multiline_comment|/* ICW1: ICW4 write req | ICW1 */
id|outb
(paren
l_int|0x00
comma
id|IC_PIC1
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* ICW2: interrupt vector table - not used */
id|outb
(paren
l_int|0x04
comma
id|IC_PIC1
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* ICW3: Cascade */
id|outb
(paren
l_int|0x01
comma
id|IC_PIC1
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* ICW4: x86 mode */
multiline_comment|/* PIC1 Program Operational Control Words */
id|outb
(paren
l_int|0xff
comma
id|IC_PIC1
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* OCW1: Mask all interrupts */
id|outb
(paren
l_int|0xc2
comma
id|IC_PIC1
op_plus
l_int|0
)paren
suffix:semicolon
multiline_comment|/* OCW2: priority (3-7,0-2) */
multiline_comment|/* PIC2 Initialization Command Word register programming */
id|outb
(paren
l_int|0x11
comma
id|IC_PIC2
op_plus
l_int|0
)paren
suffix:semicolon
multiline_comment|/* ICW1: ICW4 write req | ICW1 */
id|outb
(paren
l_int|0x00
comma
id|IC_PIC2
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* ICW2: N/A */
id|outb
(paren
l_int|0x02
comma
id|IC_PIC2
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* ICW3: Slave ID code */
id|outb
(paren
l_int|0x01
comma
id|IC_PIC2
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* ICW4: x86 mode */
multiline_comment|/* Program Operational Control Words */
id|outb
(paren
l_int|0xff
comma
id|IC_PIC1
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* OCW1: Mask all interrupts */
id|outb
(paren
l_int|0x68
comma
id|IC_PIC1
op_plus
l_int|0
)paren
suffix:semicolon
multiline_comment|/* OCW3: OCW3 select | ESMM | SMM */
multiline_comment|/* Write master mask reg */
id|outb
(paren
l_int|0xff
comma
id|IC_PIC1
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Setup USB power regulation */
id|outb
c_func
(paren
l_int|1
comma
id|sio-&gt;acpi_base
op_plus
id|USB_REG_CR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inb
c_func
(paren
id|sio-&gt;acpi_base
op_plus
id|USB_REG_CR
)paren
op_amp
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;SuperIO: USB regulator enabled&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;USB regulator not initialized!&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|pdev-&gt;irq
comma
id|superio_interrupt
comma
id|SA_INTERRUPT
comma
l_string|&quot;SuperIO&quot;
comma
(paren
r_void
op_star
)paren
id|sio
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;SuperIO: could not get irq&bslash;n&quot;
)paren
suffix:semicolon
id|BUG
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|sio-&gt;suckyio_irq_enabled
op_assign
l_int|1
suffix:semicolon
)brace
r_static
r_void
DECL|function|superio_disable_irq
id|superio_disable_irq
c_func
(paren
r_void
op_star
id|dev
comma
r_int
id|local_irq
)paren
(brace
id|u8
id|r8
suffix:semicolon
r_if
c_cond
(paren
(paren
id|local_irq
OL
l_int|1
)paren
op_logical_or
(paren
id|local_irq
op_eq
l_int|2
)paren
op_logical_or
(paren
id|local_irq
OG
l_int|7
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;SuperIO: Illegal irq number.&bslash;n&quot;
)paren
suffix:semicolon
id|BUG
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Mask interrupt */
id|r8
op_assign
id|inb
c_func
(paren
id|IC_PIC1
op_plus
l_int|1
)paren
suffix:semicolon
id|r8
op_or_assign
(paren
l_int|1
op_lshift
id|local_irq
)paren
suffix:semicolon
id|outb
(paren
id|r8
comma
id|IC_PIC1
op_plus
l_int|1
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|superio_enable_irq
id|superio_enable_irq
c_func
(paren
r_void
op_star
id|dev
comma
r_int
id|local_irq
)paren
(brace
id|u8
id|r8
suffix:semicolon
r_if
c_cond
(paren
(paren
id|local_irq
OL
l_int|1
)paren
op_logical_or
(paren
id|local_irq
op_eq
l_int|2
)paren
op_logical_or
(paren
id|local_irq
OG
l_int|7
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;SuperIO: Illegal irq number (%d).&bslash;n&quot;
comma
id|local_irq
)paren
suffix:semicolon
id|BUG
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Unmask interrupt */
id|r8
op_assign
id|inb
c_func
(paren
id|IC_PIC1
op_plus
l_int|1
)paren
suffix:semicolon
id|r8
op_and_assign
op_complement
(paren
l_int|1
op_lshift
id|local_irq
)paren
suffix:semicolon
id|outb
(paren
id|r8
comma
id|IC_PIC1
op_plus
l_int|1
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|superio_mask_irq
id|superio_mask_irq
c_func
(paren
r_void
op_star
id|dev
comma
r_int
id|local_irq
)paren
(brace
id|BUG
c_func
(paren
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|superio_unmask_irq
id|superio_unmask_irq
c_func
(paren
r_void
op_star
id|dev
comma
r_int
id|local_irq
)paren
(brace
id|BUG
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|variable|superio_irq_ops
r_static
r_struct
id|irq_region_ops
id|superio_irq_ops
op_assign
(brace
dot
id|disable_irq
op_assign
id|superio_disable_irq
comma
dot
id|enable_irq
op_assign
id|superio_enable_irq
comma
dot
id|mask_irq
op_assign
id|superio_mask_irq
comma
dot
id|unmask_irq
op_assign
id|superio_unmask_irq
)brace
suffix:semicolon
macro_line|#ifdef DEBUG_SUPERIO_INIT
DECL|variable|expected_device
r_static
r_int
r_int
id|expected_device
(braket
l_int|3
)braket
op_assign
(brace
id|PCI_DEVICE_ID_NS_87415
comma
id|PCI_DEVICE_ID_NS_87560_LIO
comma
id|PCI_DEVICE_ID_NS_87560_USB
)brace
suffix:semicolon
macro_line|#endif
DECL|function|superio_fixup_irq
r_int
id|superio_fixup_irq
c_func
(paren
r_struct
id|pci_dev
op_star
id|pcidev
)paren
(brace
r_int
id|local_irq
suffix:semicolon
macro_line|#ifdef DEBUG_SUPERIO_INIT
r_int
id|fn
suffix:semicolon
id|fn
op_assign
id|PCI_FUNC
c_func
(paren
id|pcidev-&gt;devfn
)paren
suffix:semicolon
multiline_comment|/* Verify the function number matches the expected device id. */
r_if
c_cond
(paren
id|expected_device
(braket
id|fn
)braket
op_ne
id|pcidev-&gt;device
)paren
(brace
id|BUG
c_func
(paren
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;superio_fixup_irq(%s) ven 0x%x dev 0x%x from %p&bslash;n&quot;
comma
id|pci_name
c_func
(paren
id|pcidev
)paren
comma
id|pcidev-&gt;vendor
comma
id|pcidev-&gt;device
comma
id|__builtin_return_address
c_func
(paren
l_int|0
)paren
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|sio_dev.irq_region
)paren
(brace
multiline_comment|/* Allocate an irq region for SuperIO devices */
id|sio_dev.irq_region
op_assign
id|alloc_irq_region
c_func
(paren
id|SUPERIO_NIRQS
comma
op_amp
id|superio_irq_ops
comma
l_string|&quot;SuperIO&quot;
comma
(paren
r_void
op_star
)paren
op_amp
id|sio_dev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sio_dev.irq_region
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;SuperIO: alloc_irq_region failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t; * We don&squot;t allocate a SuperIO irq for the legacy IO function,&n;&t; * since it is a &quot;bridge&quot;. Instead, we will allocate irq&squot;s for&n;&t; * each legacy device as they are initialized.&n;&t; */
r_switch
c_cond
(paren
id|pcidev-&gt;device
)paren
(brace
r_case
id|PCI_DEVICE_ID_NS_87415
suffix:colon
multiline_comment|/* Function 0 */
id|local_irq
op_assign
id|IDE_IRQ
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PCI_DEVICE_ID_NS_87560_LIO
suffix:colon
multiline_comment|/* Function 1 */
id|sio_dev.lio_pdev
op_assign
id|pcidev
suffix:semicolon
multiline_comment|/* save for superio_init() */
r_return
op_minus
l_int|1
suffix:semicolon
r_case
id|PCI_DEVICE_ID_NS_87560_USB
suffix:colon
multiline_comment|/* Function 2 */
id|sio_dev.usb_pdev
op_assign
id|pcidev
suffix:semicolon
multiline_comment|/* save for superio_init() */
id|local_irq
op_assign
id|USB_IRQ
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|local_irq
op_assign
op_minus
l_int|1
suffix:semicolon
id|BUG
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|sio_dev.irq_region-&gt;data.irqbase
op_plus
id|local_irq
suffix:semicolon
)brace
DECL|variable|serial
r_static
r_struct
id|uart_port
id|serial
(braket
)braket
op_assign
(brace
(brace
dot
id|iotype
op_assign
id|UPIO_PORT
comma
dot
id|line
op_assign
l_int|0
comma
dot
id|type
op_assign
id|PORT_16550A
comma
dot
id|uartclk
op_assign
l_int|115200
op_star
l_int|16
comma
dot
id|fifosize
op_assign
l_int|16
comma
)brace
comma
(brace
dot
id|iotype
op_assign
id|UPIO_PORT
comma
dot
id|line
op_assign
l_int|1
comma
dot
id|type
op_assign
id|PORT_16550A
comma
dot
id|uartclk
op_assign
l_int|115200
op_star
l_int|16
comma
dot
id|fifosize
op_assign
l_int|16
comma
)brace
)brace
suffix:semicolon
r_void
id|__devinit
DECL|function|superio_serial_init
id|superio_serial_init
c_func
(paren
r_void
)paren
(brace
macro_line|#ifdef CONFIG_SERIAL_8250
r_int
id|retval
suffix:semicolon
macro_line|#ifdef CONFIG_SERIAL_8250_CONSOLE
r_extern
r_void
id|serial8250_console_init
c_func
(paren
r_void
)paren
suffix:semicolon
multiline_comment|/* drivers/serial/8250.c */
macro_line|#endif        
r_if
c_cond
(paren
op_logical_neg
id|sio_dev.irq_region
)paren
r_return
suffix:semicolon
multiline_comment|/* superio not present */
r_if
c_cond
(paren
op_logical_neg
id|serial
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;SuperIO: Could not get memory for serial struct.&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|serial
(braket
l_int|0
)braket
dot
id|iobase
op_assign
id|sio_dev.sp1_base
suffix:semicolon
id|serial
(braket
l_int|0
)braket
dot
id|irq
op_assign
id|sio_dev.irq_region-&gt;data.irqbase
op_plus
id|SP1_IRQ
suffix:semicolon
id|retval
op_assign
id|early_serial_setup
c_func
(paren
op_amp
id|serial
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;SuperIO: Register Serial #0 failed.&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_SERIAL_8250_CONSOLE
id|serial8250_console_init
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
id|serial
(braket
l_int|1
)braket
dot
id|iobase
op_assign
id|sio_dev.sp2_base
suffix:semicolon
id|serial
(braket
l_int|1
)braket
dot
id|irq
op_assign
id|sio_dev.irq_region-&gt;data.irqbase
op_plus
id|SP2_IRQ
suffix:semicolon
id|retval
op_assign
id|early_serial_setup
c_func
(paren
op_amp
id|serial
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
OL
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;SuperIO: Register Serial #1 failed.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_SERIAL_8250 */
)brace
r_static
r_void
id|__devinit
DECL|function|superio_parport_init
id|superio_parport_init
c_func
(paren
r_void
)paren
(brace
macro_line|#ifdef CONFIG_PARPORT_PC
r_if
c_cond
(paren
op_logical_neg
id|parport_pc_probe_port
c_func
(paren
id|sio_dev.pp_base
comma
l_int|0
multiline_comment|/*base_hi*/
comma
id|sio_dev.irq_region-&gt;data.irqbase
op_plus
id|PAR_IRQ
comma
id|PARPORT_DMA_NONE
multiline_comment|/* dma */
comma
l_int|NULL
multiline_comment|/*struct pci_dev* */
)paren
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;SuperIO: Probing parallel port failed.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif&t;/* CONFIG_PARPORT_PC */
)brace
DECL|function|superio_fixup_pci
r_void
id|superio_fixup_pci
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
id|u8
id|prog
suffix:semicolon
id|pdev
op_member_access_from_pointer
r_class
op_or_assign
l_int|0x5
suffix:semicolon
id|pci_write_config_byte
c_func
(paren
id|pdev
comma
id|PCI_CLASS_PROG
comma
id|pdev
op_member_access_from_pointer
r_class
)paren
suffix:semicolon
id|pci_read_config_byte
c_func
(paren
id|pdev
comma
id|PCI_CLASS_PROG
comma
op_amp
id|prog
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;PCI: Enabled native mode for NS87415 (pif=0x%x)&bslash;n&quot;
comma
id|prog
)paren
suffix:semicolon
)brace
id|DECLARE_PCI_FIXUP_EARLY
c_func
(paren
id|PCI_VENDOR_ID_NS
comma
id|PCI_DEVICE_ID_NS_87415
comma
id|superio_fixup_pci
)paren
suffix:semicolon
DECL|function|superio_probe
r_static
r_int
id|__devinit
id|superio_probe
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_const
r_struct
id|pci_device_id
op_star
id|id
)paren
(brace
multiline_comment|/*&n;&t;** superio_probe(00:0e.0) ven 0x100b dev 0x2 sv 0x0 sd 0x0 class 0x1018a&n;&t;** superio_probe(00:0e.1) ven 0x100b dev 0xe sv 0x0 sd 0x0 class 0x68000&n;&t;** superio_probe(00:0e.2) ven 0x100b dev 0x12 sv 0x0 sd 0x0 class 0xc0310&n;&t;*/
id|DBG_INIT
c_func
(paren
l_string|&quot;superio_probe(%s) ven 0x%x dev 0x%x sv 0x%x sd 0x%x class 0x%x&bslash;n&quot;
comma
id|pci_name
c_func
(paren
id|dev
)paren
comma
id|dev-&gt;vendor
comma
id|dev-&gt;device
comma
id|dev-&gt;subsystem_vendor
comma
id|dev-&gt;subsystem_device
comma
id|dev
op_member_access_from_pointer
r_class
)paren
suffix:semicolon
id|superio_init
c_func
(paren
op_amp
id|sio_dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;device
op_eq
id|PCI_DEVICE_ID_NS_87560_LIO
)paren
(brace
multiline_comment|/* Function 1 */
id|superio_parport_init
c_func
(paren
)paren
suffix:semicolon
id|superio_serial_init
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* REVISIT XXX : superio_fdc_init() ? */
r_return
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|dev-&gt;device
op_eq
id|PCI_DEVICE_ID_NS_87415
)paren
(brace
multiline_comment|/* Function 0 */
id|DBG_INIT
c_func
(paren
l_string|&quot;superio_probe: ignoring IDE 87415&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|dev-&gt;device
op_eq
id|PCI_DEVICE_ID_NS_87560_USB
)paren
(brace
multiline_comment|/* Function 2 */
id|DBG_INIT
c_func
(paren
l_string|&quot;superio_probe: ignoring USB OHCI controller&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|DBG_INIT
c_func
(paren
l_string|&quot;superio_probe: WTF? Fire Extinguisher?&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* Let appropriate other driver claim this device. */
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
DECL|variable|superio_tbl
r_static
r_struct
id|pci_device_id
id|superio_tbl
(braket
)braket
op_assign
(brace
(brace
id|PCI_VENDOR_ID_NS
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
)brace
)brace
suffix:semicolon
DECL|variable|superio_driver
r_static
r_struct
id|pci_driver
id|superio_driver
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;SuperIO&quot;
comma
dot
id|id_table
op_assign
id|superio_tbl
comma
dot
id|probe
op_assign
id|superio_probe
comma
)brace
suffix:semicolon
DECL|function|superio_modinit
r_static
r_int
id|__init
id|superio_modinit
c_func
(paren
r_void
)paren
(brace
r_return
id|pci_module_init
c_func
(paren
op_amp
id|superio_driver
)paren
suffix:semicolon
)brace
DECL|function|superio_exit
r_static
r_void
id|__exit
id|superio_exit
c_func
(paren
r_void
)paren
(brace
id|pci_unregister_driver
c_func
(paren
op_amp
id|superio_driver
)paren
suffix:semicolon
)brace
DECL|variable|superio_modinit
id|module_init
c_func
(paren
id|superio_modinit
)paren
suffix:semicolon
DECL|variable|superio_exit
id|module_exit
c_func
(paren
id|superio_exit
)paren
suffix:semicolon
eof
