multiline_comment|/*&n;**  System Bus Adapter (SBA) I/O MMU manager&n;**&n;**&t;(c) Copyright 2000-2004 Grant Grundler &lt;grundler @ parisc-linux x org&gt;&n;**&t;(c) Copyright 2004 Naresh Kumar Inna &lt;knaresh at india x hp x com&gt;&n;**&t;(c) Copyright 2000-2004 Hewlett-Packard Company&n;**&n;**&t;Portions (c) 1999 Dave S. Miller (from sparc64 I/O MMU code)&n;**&n;**&t;This program is free software; you can redistribute it and/or modify&n;**&t;it under the terms of the GNU General Public License as published by&n;**      the Free Software Foundation; either version 2 of the License, or&n;**      (at your option) any later version.&n;**&n;**&n;** This module initializes the IOC (I/O Controller) found on B1000/C3000/&n;** J5000/J7000/N-class/L-class machines and their successors.&n;**&n;** FIXME: add DMA hint support programming in both sba and lba modules.&n;*/
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;asm/byteorder.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/dma.h&gt;&t;&t;/* for DMA_CHUNK_SIZE */
macro_line|#include &lt;asm/hardware.h&gt;&t;/* for register_parisc_driver() stuff */
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;asm/runway.h&gt;&t;&t;/* for proc_runway_root */
macro_line|#include &lt;asm/pdc.h&gt;&t;&t;/* for PDC_MODEL_* */
macro_line|#include &lt;asm/pdcpat.h&gt;&t;&t;/* for is_pdc_pat() */
macro_line|#include &lt;asm/parisc-device.h&gt;
multiline_comment|/* declared in arch/parisc/kernel/setup.c */
r_extern
r_struct
id|proc_dir_entry
op_star
id|proc_mckinley_root
suffix:semicolon
DECL|macro|MODULE_NAME
mdefine_line|#define MODULE_NAME &quot;SBA&quot;
macro_line|#ifdef CONFIG_PROC_FS
multiline_comment|/* depends on proc fs support. But costs CPU performance */
DECL|macro|SBA_COLLECT_STATS
macro_line|#undef SBA_COLLECT_STATS
macro_line|#endif
multiline_comment|/*&n;** The number of debug flags is a clue - this code is fragile.&n;** Don&squot;t even think about messing with it unless you have&n;** plenty of 710&squot;s to sacrifice to the computer gods. :^)&n;*/
DECL|macro|DEBUG_SBA_ASSERT
macro_line|#undef DEBUG_SBA_ASSERT
DECL|macro|DEBUG_SBA_INIT
macro_line|#undef DEBUG_SBA_INIT
DECL|macro|DEBUG_SBA_RUN
macro_line|#undef DEBUG_SBA_RUN
DECL|macro|DEBUG_SBA_RUN_SG
macro_line|#undef DEBUG_SBA_RUN_SG
DECL|macro|DEBUG_SBA_RESOURCE
macro_line|#undef DEBUG_SBA_RESOURCE
DECL|macro|ASSERT_PDIR_SANITY
macro_line|#undef ASSERT_PDIR_SANITY
DECL|macro|DEBUG_LARGE_SG_ENTRIES
macro_line|#undef DEBUG_LARGE_SG_ENTRIES
DECL|macro|DEBUG_DMB_TRAP
macro_line|#undef DEBUG_DMB_TRAP
macro_line|#ifdef DEBUG_SBA_INIT
DECL|macro|DBG_INIT
mdefine_line|#define DBG_INIT(x...)&t;printk(x)
macro_line|#else
DECL|macro|DBG_INIT
mdefine_line|#define DBG_INIT(x...)
macro_line|#endif
macro_line|#ifdef DEBUG_SBA_RUN
DECL|macro|DBG_RUN
mdefine_line|#define DBG_RUN(x...)&t;printk(x)
macro_line|#else
DECL|macro|DBG_RUN
mdefine_line|#define DBG_RUN(x...)
macro_line|#endif
macro_line|#ifdef DEBUG_SBA_RUN_SG
DECL|macro|DBG_RUN_SG
mdefine_line|#define DBG_RUN_SG(x...)&t;printk(x)
macro_line|#else
DECL|macro|DBG_RUN_SG
mdefine_line|#define DBG_RUN_SG(x...)
macro_line|#endif
macro_line|#ifdef DEBUG_SBA_RESOURCE
DECL|macro|DBG_RES
mdefine_line|#define DBG_RES(x...)&t;printk(x)
macro_line|#else
DECL|macro|DBG_RES
mdefine_line|#define DBG_RES(x...)
macro_line|#endif
macro_line|#ifdef DEBUG_SBA_ASSERT
DECL|macro|ASSERT
macro_line|#undef ASSERT
DECL|macro|ASSERT
mdefine_line|#define ASSERT(expr) &bslash;&n;&t;if(!(expr)) { &bslash;&n;&t;&t;printk(&quot;&bslash;n%s:%d: Assertion &quot; #expr &quot; failed!&bslash;n&quot;, &bslash;&n;&t;&t;&t;&t;__FILE__, __LINE__); &bslash;&n;&t;&t;panic(#expr); &bslash;&n;&t;}
macro_line|#else
DECL|macro|ASSERT
mdefine_line|#define ASSERT(expr)
macro_line|#endif
macro_line|#if defined(__LP64__) &amp;&amp; !defined(CONFIG_PDC_NARROW)
multiline_comment|/* &quot;low end&quot; PA8800 machines use ZX1 chipset */
DECL|macro|ZX1_SUPPORT
mdefine_line|#define ZX1_SUPPORT
macro_line|#endif
DECL|macro|SBA_INLINE
mdefine_line|#define SBA_INLINE&t;__inline__
multiline_comment|/*&n;** The number of pdir entries to &quot;free&quot; before issueing&n;** a read to PCOM register to flush out PCOM writes.&n;** Interacts with allocation granularity (ie 4 or 8 entries&n;** allocated and free&squot;d/purged at a time might make this&n;** less interesting).&n;*/
DECL|macro|DELAYED_RESOURCE_CNT
mdefine_line|#define DELAYED_RESOURCE_CNT&t;16
DECL|macro|DEFAULT_DMA_HINT_REG
mdefine_line|#define DEFAULT_DMA_HINT_REG&t;0
DECL|macro|ASTRO_RUNWAY_PORT
mdefine_line|#define ASTRO_RUNWAY_PORT&t;0x582
DECL|macro|ASTRO_ROPES_PORT
mdefine_line|#define ASTRO_ROPES_PORT&t;0x780
DECL|macro|IKE_MERCED_PORT
mdefine_line|#define IKE_MERCED_PORT&t;&t;0x803
DECL|macro|IKE_ROPES_PORT
mdefine_line|#define IKE_ROPES_PORT&t;&t;0x781
DECL|macro|REO_MERCED_PORT
mdefine_line|#define REO_MERCED_PORT&t;&t;0x804
DECL|macro|REO_ROPES_PORT
mdefine_line|#define REO_ROPES_PORT&t;&t;0x782
DECL|macro|REOG_MERCED_PORT
mdefine_line|#define REOG_MERCED_PORT&t;0x805
DECL|macro|REOG_ROPES_PORT
mdefine_line|#define REOG_ROPES_PORT&t;&t;0x783
DECL|macro|PLUTO_MCKINLEY_PORT
mdefine_line|#define PLUTO_MCKINLEY_PORT&t;0x880
DECL|macro|PLUTO_ROPES_PORT
mdefine_line|#define PLUTO_ROPES_PORT&t;0x784
DECL|macro|SBA_FUNC_ID
mdefine_line|#define SBA_FUNC_ID&t;0x0000&t;/* function id */
DECL|macro|SBA_FCLASS
mdefine_line|#define SBA_FCLASS&t;0x0008&t;/* function class, bist, header, rev... */
DECL|macro|IS_ASTRO
mdefine_line|#define IS_ASTRO(id) &bslash;&n;(((id)-&gt;hversion == ASTRO_RUNWAY_PORT) || ((id)-&gt;hversion == ASTRO_ROPES_PORT))
DECL|macro|IS_IKE
mdefine_line|#define IS_IKE(id) &bslash;&n;(((id)-&gt;hversion == IKE_MERCED_PORT) || ((id)-&gt;hversion == IKE_ROPES_PORT))
DECL|macro|IS_PLUTO
mdefine_line|#define IS_PLUTO(id) &bslash;&n;(((id)-&gt;hversion == PLUTO_MCKINLEY_PORT) || ((id)-&gt;hversion == PLUTO_ROPES_PORT))
DECL|macro|SBA_FUNC_SIZE
mdefine_line|#define SBA_FUNC_SIZE 4096   /* SBA configuration function reg set */
DECL|macro|ASTRO_IOC_OFFSET
mdefine_line|#define ASTRO_IOC_OFFSET 0x20000
multiline_comment|/* Ike&squot;s IOC&squot;s occupy functions 2 and 3 (not 0 and 1) */
DECL|macro|IKE_IOC_OFFSET
mdefine_line|#define IKE_IOC_OFFSET(p) ((p+2)*SBA_FUNC_SIZE)
DECL|macro|PLUTO_IOC_OFFSET
mdefine_line|#define PLUTO_IOC_OFFSET 0x1000
DECL|macro|IOC_CTRL
mdefine_line|#define IOC_CTRL          0x8&t;/* IOC_CTRL offset */
DECL|macro|IOC_CTRL_TC
mdefine_line|#define IOC_CTRL_TC       (1 &lt;&lt; 0) /* TOC Enable */
DECL|macro|IOC_CTRL_CE
mdefine_line|#define IOC_CTRL_CE       (1 &lt;&lt; 1) /* Coalesce Enable */
DECL|macro|IOC_CTRL_DE
mdefine_line|#define IOC_CTRL_DE       (1 &lt;&lt; 2) /* Dillon Enable */
DECL|macro|IOC_CTRL_RM
mdefine_line|#define IOC_CTRL_RM       (1 &lt;&lt; 8) /* Real Mode */
DECL|macro|IOC_CTRL_NC
mdefine_line|#define IOC_CTRL_NC       (1 &lt;&lt; 9) /* Non Coherent Mode */
DECL|macro|MAX_IOC
mdefine_line|#define MAX_IOC&t;&t;2&t;/* per Ike. Pluto/Astro only have 1. */
DECL|macro|ROPES_PER_IOC
mdefine_line|#define ROPES_PER_IOC&t;8&t;/* per Ike half or Pluto/Astro */
multiline_comment|/*&n;** Offsets into MBIB (Function 0 on Ike and hopefully Astro)&n;** Firmware programs this stuff. Don&squot;t touch it.&n;*/
DECL|macro|LMMIO_DIRECT0_BASE
mdefine_line|#define LMMIO_DIRECT0_BASE  0x300
DECL|macro|LMMIO_DIRECT0_MASK
mdefine_line|#define LMMIO_DIRECT0_MASK  0x308
DECL|macro|LMMIO_DIRECT0_ROUTE
mdefine_line|#define LMMIO_DIRECT0_ROUTE 0x310
DECL|macro|LMMIO_DIST_BASE
mdefine_line|#define LMMIO_DIST_BASE  0x360
DECL|macro|LMMIO_DIST_MASK
mdefine_line|#define LMMIO_DIST_MASK  0x368
DECL|macro|LMMIO_DIST_ROUTE
mdefine_line|#define LMMIO_DIST_ROUTE 0x370
DECL|macro|IOS_DIST_BASE
mdefine_line|#define IOS_DIST_BASE&t;0x390
DECL|macro|IOS_DIST_MASK
mdefine_line|#define IOS_DIST_MASK&t;0x398
DECL|macro|IOS_DIST_ROUTE
mdefine_line|#define IOS_DIST_ROUTE&t;0x3A0
DECL|macro|IOS_DIRECT_BASE
mdefine_line|#define IOS_DIRECT_BASE&t;0x3C0
DECL|macro|IOS_DIRECT_MASK
mdefine_line|#define IOS_DIRECT_MASK&t;0x3C8
DECL|macro|IOS_DIRECT_ROUTE
mdefine_line|#define IOS_DIRECT_ROUTE 0x3D0
multiline_comment|/*&n;** Offsets into I/O TLB (Function 2 and 3 on Ike)&n;*/
DECL|macro|ROPE0_CTL
mdefine_line|#define ROPE0_CTL&t;0x200  /* &quot;regbus pci0&quot; */
DECL|macro|ROPE1_CTL
mdefine_line|#define ROPE1_CTL&t;0x208
DECL|macro|ROPE2_CTL
mdefine_line|#define ROPE2_CTL&t;0x210
DECL|macro|ROPE3_CTL
mdefine_line|#define ROPE3_CTL&t;0x218
DECL|macro|ROPE4_CTL
mdefine_line|#define ROPE4_CTL&t;0x220
DECL|macro|ROPE5_CTL
mdefine_line|#define ROPE5_CTL&t;0x228
DECL|macro|ROPE6_CTL
mdefine_line|#define ROPE6_CTL&t;0x230
DECL|macro|ROPE7_CTL
mdefine_line|#define ROPE7_CTL&t;0x238
DECL|macro|HF_ENABLE
mdefine_line|#define HF_ENABLE&t;0x40
DECL|macro|IOC_IBASE
mdefine_line|#define IOC_IBASE&t;0x300&t;/* IO TLB */
DECL|macro|IOC_IMASK
mdefine_line|#define IOC_IMASK&t;0x308
DECL|macro|IOC_PCOM
mdefine_line|#define IOC_PCOM&t;0x310
DECL|macro|IOC_TCNFG
mdefine_line|#define IOC_TCNFG&t;0x318
DECL|macro|IOC_PDIR_BASE
mdefine_line|#define IOC_PDIR_BASE&t;0x320
multiline_comment|/* AGP GART driver looks for this */
DECL|macro|SBA_IOMMU_COOKIE
mdefine_line|#define SBA_IOMMU_COOKIE    0x0000badbadc0ffeeUL
multiline_comment|/*&n;** IOC supports 4/8/16/64KB page sizes (see TCNFG register)&n;** It&squot;s safer (avoid memory corruption) to keep DMA page mappings&n;** equivalently sized to VM PAGE_SIZE.&n;**&n;** We really can&squot;t avoid generating a new mapping for each&n;** page since the Virtual Coherence Index has to be generated&n;** and updated for each page.&n;**&n;** PAGE_SIZE could be greater than IOVP_SIZE. But not the inverse.&n;*/
DECL|macro|IOVP_SIZE
mdefine_line|#define IOVP_SIZE&t;PAGE_SIZE
DECL|macro|IOVP_SHIFT
mdefine_line|#define IOVP_SHIFT&t;PAGE_SHIFT
DECL|macro|IOVP_MASK
mdefine_line|#define IOVP_MASK&t;PAGE_MASK
DECL|macro|SBA_PERF_CFG
mdefine_line|#define SBA_PERF_CFG&t;0x708&t;/* Performance Counter stuff */
DECL|macro|SBA_PERF_MASK1
mdefine_line|#define SBA_PERF_MASK1&t;0x718
DECL|macro|SBA_PERF_MASK2
mdefine_line|#define SBA_PERF_MASK2&t;0x730
multiline_comment|/*&n;** Offsets into PCI Performance Counters (functions 12 and 13)&n;** Controlled by PERF registers in function 2 &amp; 3 respectively.&n;*/
DECL|macro|SBA_PERF_CNT1
mdefine_line|#define SBA_PERF_CNT1&t;0x200
DECL|macro|SBA_PERF_CNT2
mdefine_line|#define SBA_PERF_CNT2&t;0x208
DECL|macro|SBA_PERF_CNT3
mdefine_line|#define SBA_PERF_CNT3&t;0x210
DECL|struct|ioc
r_struct
id|ioc
(brace
DECL|member|ioc_hpa
r_int
r_int
id|ioc_hpa
suffix:semicolon
multiline_comment|/* I/O MMU base address */
DECL|member|res_map
r_char
op_star
id|res_map
suffix:semicolon
multiline_comment|/* resource map, bit == pdir entry */
DECL|member|pdir_base
id|u64
op_star
id|pdir_base
suffix:semicolon
multiline_comment|/* physical base address */
DECL|member|ibase
r_int
r_int
id|ibase
suffix:semicolon
multiline_comment|/* pdir IOV Space base - shared w/lba_pci */
DECL|member|imask
r_int
r_int
id|imask
suffix:semicolon
multiline_comment|/* pdir IOV Space mask - shared w/lba_pci */
macro_line|#ifdef ZX1_SUPPORT
DECL|member|iovp_mask
r_int
r_int
id|iovp_mask
suffix:semicolon
multiline_comment|/* help convert IOVA to IOVP */
macro_line|#endif
DECL|member|res_hint
r_int
r_int
op_star
id|res_hint
suffix:semicolon
multiline_comment|/* next avail IOVP - circular search */
DECL|member|res_lock
id|spinlock_t
id|res_lock
suffix:semicolon
DECL|member|res_bitshift
r_int
r_int
id|res_bitshift
suffix:semicolon
multiline_comment|/* from the LEFT! */
DECL|member|res_size
r_int
r_int
id|res_size
suffix:semicolon
multiline_comment|/* size of resource map in bytes */
macro_line|#if SBA_HINT_SUPPORT
multiline_comment|/* FIXME : DMA HINTs not used */
DECL|member|hint_mask_pdir
r_int
r_int
id|hint_mask_pdir
suffix:semicolon
multiline_comment|/* bits used for DMA hints */
DECL|member|hint_shift_pdir
r_int
r_int
id|hint_shift_pdir
suffix:semicolon
macro_line|#endif
macro_line|#if DELAYED_RESOURCE_CNT &gt; 0
DECL|member|saved_cnt
r_int
id|saved_cnt
suffix:semicolon
DECL|struct|sba_dma_pair
r_struct
id|sba_dma_pair
(brace
DECL|member|iova
id|dma_addr_t
id|iova
suffix:semicolon
DECL|member|size
r_int
id|size
suffix:semicolon
DECL|member|saved
)brace
id|saved
(braket
id|DELAYED_RESOURCE_CNT
)braket
suffix:semicolon
macro_line|#endif
macro_line|#ifdef SBA_COLLECT_STATS
DECL|macro|SBA_SEARCH_SAMPLE
mdefine_line|#define SBA_SEARCH_SAMPLE&t;0x100
DECL|member|avg_search
r_int
r_int
id|avg_search
(braket
id|SBA_SEARCH_SAMPLE
)braket
suffix:semicolon
DECL|member|avg_idx
r_int
r_int
id|avg_idx
suffix:semicolon
multiline_comment|/* current index into avg_search */
DECL|member|used_pages
r_int
r_int
id|used_pages
suffix:semicolon
DECL|member|msingle_calls
r_int
r_int
id|msingle_calls
suffix:semicolon
DECL|member|msingle_pages
r_int
r_int
id|msingle_pages
suffix:semicolon
DECL|member|msg_calls
r_int
r_int
id|msg_calls
suffix:semicolon
DECL|member|msg_pages
r_int
r_int
id|msg_pages
suffix:semicolon
DECL|member|usingle_calls
r_int
r_int
id|usingle_calls
suffix:semicolon
DECL|member|usingle_pages
r_int
r_int
id|usingle_pages
suffix:semicolon
DECL|member|usg_calls
r_int
r_int
id|usg_calls
suffix:semicolon
DECL|member|usg_pages
r_int
r_int
id|usg_pages
suffix:semicolon
macro_line|#endif
multiline_comment|/* STUFF We don&squot;t need in performance path */
DECL|member|pdir_size
r_int
r_int
id|pdir_size
suffix:semicolon
multiline_comment|/* in bytes, determined by IOV Space size */
)brace
suffix:semicolon
DECL|struct|sba_device
r_struct
id|sba_device
(brace
DECL|member|next
r_struct
id|sba_device
op_star
id|next
suffix:semicolon
multiline_comment|/* list of SBA&squot;s in system */
DECL|member|dev
r_struct
id|parisc_device
op_star
id|dev
suffix:semicolon
multiline_comment|/* dev found in bus walk */
DECL|member|iodc
r_struct
id|parisc_device_id
op_star
id|iodc
suffix:semicolon
multiline_comment|/* data about dev from firmware */
DECL|member|name
r_const
r_char
op_star
id|name
suffix:semicolon
DECL|member|sba_hpa
r_int
r_int
id|sba_hpa
suffix:semicolon
multiline_comment|/* base address */
DECL|member|sba_lock
id|spinlock_t
id|sba_lock
suffix:semicolon
DECL|member|flags
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/* state/functionality enabled */
DECL|member|hw_rev
r_int
r_int
id|hw_rev
suffix:semicolon
multiline_comment|/* HW revision of chip */
DECL|member|chip_resv
r_struct
id|resource
id|chip_resv
suffix:semicolon
multiline_comment|/* MMIO reserved for chip */
DECL|member|iommu_resv
r_struct
id|resource
id|iommu_resv
suffix:semicolon
multiline_comment|/* MMIO reserved for iommu */
DECL|member|num_ioc
r_int
r_int
id|num_ioc
suffix:semicolon
multiline_comment|/* number of on-board IOC&squot;s */
DECL|member|ioc
r_struct
id|ioc
id|ioc
(braket
id|MAX_IOC
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|sba_list
r_static
r_struct
id|sba_device
op_star
id|sba_list
suffix:semicolon
DECL|variable|ioc_needs_fdc
r_static
r_int
r_int
id|ioc_needs_fdc
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Ratio of Host MEM to IOV Space size */
DECL|variable|sba_mem_ratio
r_static
r_int
r_int
id|sba_mem_ratio
op_assign
l_int|8
suffix:semicolon
multiline_comment|/* global count of IOMMUs in the system */
DECL|variable|global_ioc_cnt
r_static
r_int
r_int
id|global_ioc_cnt
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* PA8700 (Piranha 2.2) bug workaround */
DECL|variable|piranha_bad_128k
r_static
r_int
r_int
id|piranha_bad_128k
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Looks nice and keeps the compiler happy */
DECL|macro|SBA_DEV
mdefine_line|#define SBA_DEV(d) ((struct sba_device *) (d))
macro_line|#if SBA_AGP_SUPPORT
DECL|variable|reserve_sba_gart
r_static
r_int
id|reserve_sba_gart
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
DECL|macro|ROUNDUP
mdefine_line|#define ROUNDUP(x,y) ((x + ((y)-1)) &amp; ~((y)-1))
multiline_comment|/************************************&n;** SBA register read and write support&n;**&n;** BE WARNED: register writes are posted.&n;**  (ie follow writes which must reach HW with a read)&n;**&n;** Superdome (in particular, REO) allows only 64-bit CSR accesses.&n;*/
DECL|macro|READ_REG32
mdefine_line|#define READ_REG32(addr)&t; le32_to_cpu(__raw_readl(addr))
DECL|macro|READ_REG64
mdefine_line|#define READ_REG64(addr)&t; le64_to_cpu(__raw_readq(addr))
DECL|macro|WRITE_REG32
mdefine_line|#define WRITE_REG32(val, addr) __raw_writel(cpu_to_le32(val), addr)
DECL|macro|WRITE_REG64
mdefine_line|#define WRITE_REG64(val, addr) __raw_writeq(cpu_to_le64(val), addr)
macro_line|#ifdef __LP64__
DECL|macro|READ_REG
mdefine_line|#define READ_REG(addr)&t;&t;READ_REG64(addr)
DECL|macro|WRITE_REG
mdefine_line|#define WRITE_REG(value, addr)&t;WRITE_REG64(value, addr)
macro_line|#else
DECL|macro|READ_REG
mdefine_line|#define READ_REG(addr)&t;&t;READ_REG32(addr)
DECL|macro|WRITE_REG
mdefine_line|#define WRITE_REG(value, addr)&t;WRITE_REG32(value, addr)
macro_line|#endif
macro_line|#ifdef DEBUG_SBA_INIT
multiline_comment|/* NOTE: When __LP64__ isn&squot;t defined, READ_REG64() is two 32-bit reads */
multiline_comment|/**&n; * sba_dump_ranges - debugging only - print ranges assigned to this IOA&n; * @hpa: base address of the sba&n; *&n; * Print the MMIO and IO Port address ranges forwarded by an Astro/Ike/RIO&n; * IO Adapter (aka Bus Converter).&n; */
r_static
r_void
DECL|function|sba_dump_ranges
id|sba_dump_ranges
c_func
(paren
r_int
r_int
id|hpa
)paren
(brace
id|DBG_INIT
c_func
(paren
l_string|&quot;SBA at 0x%lx&bslash;n&quot;
comma
id|hpa
)paren
suffix:semicolon
id|DBG_INIT
c_func
(paren
l_string|&quot;IOS_DIST_BASE   : %Lx&bslash;n&quot;
comma
id|READ_REG64
c_func
(paren
id|hpa
op_plus
id|IOS_DIST_BASE
)paren
)paren
suffix:semicolon
id|DBG_INIT
c_func
(paren
l_string|&quot;IOS_DIST_MASK   : %Lx&bslash;n&quot;
comma
id|READ_REG64
c_func
(paren
id|hpa
op_plus
id|IOS_DIST_MASK
)paren
)paren
suffix:semicolon
id|DBG_INIT
c_func
(paren
l_string|&quot;IOS_DIST_ROUTE  : %Lx&bslash;n&quot;
comma
id|READ_REG64
c_func
(paren
id|hpa
op_plus
id|IOS_DIST_ROUTE
)paren
)paren
suffix:semicolon
id|DBG_INIT
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|DBG_INIT
c_func
(paren
l_string|&quot;IOS_DIRECT_BASE : %Lx&bslash;n&quot;
comma
id|READ_REG64
c_func
(paren
id|hpa
op_plus
id|IOS_DIRECT_BASE
)paren
)paren
suffix:semicolon
id|DBG_INIT
c_func
(paren
l_string|&quot;IOS_DIRECT_MASK : %Lx&bslash;n&quot;
comma
id|READ_REG64
c_func
(paren
id|hpa
op_plus
id|IOS_DIRECT_MASK
)paren
)paren
suffix:semicolon
id|DBG_INIT
c_func
(paren
l_string|&quot;IOS_DIRECT_ROUTE: %Lx&bslash;n&quot;
comma
id|READ_REG64
c_func
(paren
id|hpa
op_plus
id|IOS_DIRECT_ROUTE
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * sba_dump_tlb - debugging only - print IOMMU operating parameters&n; * @hpa: base address of the IOMMU&n; *&n; * Print the size/location of the IO MMU PDIR.&n; */
r_static
r_void
DECL|function|sba_dump_tlb
id|sba_dump_tlb
c_func
(paren
r_int
r_int
id|hpa
)paren
(brace
id|DBG_INIT
c_func
(paren
l_string|&quot;IO TLB at 0x%lx&bslash;n&quot;
comma
id|hpa
)paren
suffix:semicolon
id|DBG_INIT
c_func
(paren
l_string|&quot;IOC_IBASE    : 0x%Lx&bslash;n&quot;
comma
id|READ_REG64
c_func
(paren
id|hpa
op_plus
id|IOC_IBASE
)paren
)paren
suffix:semicolon
id|DBG_INIT
c_func
(paren
l_string|&quot;IOC_IMASK    : 0x%Lx&bslash;n&quot;
comma
id|READ_REG64
c_func
(paren
id|hpa
op_plus
id|IOC_IMASK
)paren
)paren
suffix:semicolon
id|DBG_INIT
c_func
(paren
l_string|&quot;IOC_TCNFG    : 0x%Lx&bslash;n&quot;
comma
id|READ_REG64
c_func
(paren
id|hpa
op_plus
id|IOC_TCNFG
)paren
)paren
suffix:semicolon
id|DBG_INIT
c_func
(paren
l_string|&quot;IOC_PDIR_BASE: 0x%Lx&bslash;n&quot;
comma
id|READ_REG64
c_func
(paren
id|hpa
op_plus
id|IOC_PDIR_BASE
)paren
)paren
suffix:semicolon
id|DBG_INIT
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#else
DECL|macro|sba_dump_ranges
mdefine_line|#define sba_dump_ranges(x)
DECL|macro|sba_dump_tlb
mdefine_line|#define sba_dump_tlb(x)
macro_line|#endif
macro_line|#ifdef ASSERT_PDIR_SANITY
multiline_comment|/**&n; * sba_dump_pdir_entry - debugging only - print one IOMMU PDIR entry&n; * @ioc: IO MMU structure which owns the pdir we are interested in.&n; * @msg: text to print ont the output line.&n; * @pide: pdir index.&n; *&n; * Print one entry of the IO MMU PDIR in human readable form.&n; */
r_static
r_void
DECL|function|sba_dump_pdir_entry
id|sba_dump_pdir_entry
c_func
(paren
r_struct
id|ioc
op_star
id|ioc
comma
r_char
op_star
id|msg
comma
id|uint
id|pide
)paren
(brace
multiline_comment|/* start printing from lowest pde in rval */
id|u64
op_star
id|ptr
op_assign
op_amp
(paren
id|ioc-&gt;pdir_base
(braket
id|pide
op_amp
(paren
op_complement
l_int|0U
op_star
id|BITS_PER_LONG
)paren
)braket
)paren
suffix:semicolon
r_int
r_int
op_star
id|rptr
op_assign
(paren
r_int
r_int
op_star
)paren
op_amp
(paren
id|ioc-&gt;res_map
(braket
(paren
id|pide
op_rshift
l_int|3
)paren
op_amp
op_complement
(paren
r_sizeof
(paren
r_int
r_int
)paren
op_minus
l_int|1
)paren
)braket
)paren
suffix:semicolon
id|uint
id|rcnt
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;SBA: %s rp %p bit %d rval 0x%lx&bslash;n&quot;
comma
id|msg
comma
id|rptr
comma
id|pide
op_amp
(paren
id|BITS_PER_LONG
op_minus
l_int|1
)paren
comma
op_star
id|rptr
)paren
suffix:semicolon
id|rcnt
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|rcnt
OL
id|BITS_PER_LONG
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s %2d %p %016Lx&bslash;n&quot;
comma
(paren
id|rcnt
op_eq
(paren
id|pide
op_amp
(paren
id|BITS_PER_LONG
op_minus
l_int|1
)paren
)paren
)paren
ques
c_cond
l_string|&quot;    --&gt;&quot;
suffix:colon
l_string|&quot;       &quot;
comma
id|rcnt
comma
id|ptr
comma
op_star
id|ptr
)paren
suffix:semicolon
id|rcnt
op_increment
suffix:semicolon
id|ptr
op_increment
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s&quot;
comma
id|msg
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * sba_check_pdir - debugging only - consistency checker&n; * @ioc: IO MMU structure which owns the pdir we are interested in.&n; * @msg: text to print ont the output line.&n; *&n; * Verify the resource map and pdir state is consistent&n; */
r_static
r_int
DECL|function|sba_check_pdir
id|sba_check_pdir
c_func
(paren
r_struct
id|ioc
op_star
id|ioc
comma
r_char
op_star
id|msg
)paren
(brace
id|u32
op_star
id|rptr_end
op_assign
(paren
id|u32
op_star
)paren
op_amp
(paren
id|ioc-&gt;res_map
(braket
id|ioc-&gt;res_size
)braket
)paren
suffix:semicolon
id|u32
op_star
id|rptr
op_assign
(paren
id|u32
op_star
)paren
id|ioc-&gt;res_map
suffix:semicolon
multiline_comment|/* resource map ptr */
id|u64
op_star
id|pptr
op_assign
id|ioc-&gt;pdir_base
suffix:semicolon
multiline_comment|/* pdir ptr */
id|uint
id|pide
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|rptr
OL
id|rptr_end
)paren
(brace
id|u32
id|rval
op_assign
op_star
id|rptr
suffix:semicolon
r_int
id|rcnt
op_assign
l_int|32
suffix:semicolon
multiline_comment|/* number of bits we might check */
r_while
c_loop
(paren
id|rcnt
)paren
(brace
multiline_comment|/* Get last byte and highest bit from that */
id|u32
id|pde
op_assign
(paren
(paren
id|u32
)paren
(paren
(paren
(paren
r_char
op_star
)paren
id|pptr
)paren
(braket
l_int|7
)braket
)paren
)paren
op_lshift
l_int|24
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rval
op_xor
id|pde
)paren
op_amp
l_int|0x80000000
)paren
(brace
multiline_comment|/*&n;&t;&t;&t;&t;** BUMMER!  -- res_map != pdir --&n;&t;&t;&t;&t;** Dump rval and matching pdir entries&n;&t;&t;&t;&t;*/
id|sba_dump_pdir_entry
c_func
(paren
id|ioc
comma
id|msg
comma
id|pide
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|rcnt
op_decrement
suffix:semicolon
id|rval
op_lshift_assign
l_int|1
suffix:semicolon
multiline_comment|/* try the next bit */
id|pptr
op_increment
suffix:semicolon
id|pide
op_increment
suffix:semicolon
)brace
id|rptr
op_increment
suffix:semicolon
multiline_comment|/* look at next word of res_map */
)brace
multiline_comment|/* It&squot;d be nice if we always got here :^) */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * sba_dump_sg - debugging only - print Scatter-Gather list&n; * @ioc: IO MMU structure which owns the pdir we are interested in.&n; * @startsg: head of the SG list&n; * @nents: number of entries in SG list&n; *&n; * print the SG list so we can verify it&squot;s correct by hand.&n; */
r_static
r_void
DECL|function|sba_dump_sg
id|sba_dump_sg
c_func
(paren
r_struct
id|ioc
op_star
id|ioc
comma
r_struct
id|scatterlist
op_star
id|startsg
comma
r_int
id|nents
)paren
(brace
r_while
c_loop
(paren
id|nents
op_decrement
OG
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot; %d : %08lx/%05x %p/%05x&bslash;n&quot;
comma
id|nents
comma
(paren
r_int
r_int
)paren
id|sg_dma_address
c_func
(paren
id|startsg
)paren
comma
id|sg_dma_len
c_func
(paren
id|startsg
)paren
comma
id|sg_virt_addr
c_func
(paren
id|startsg
)paren
comma
id|startsg-&gt;length
)paren
suffix:semicolon
id|startsg
op_increment
suffix:semicolon
)brace
)brace
macro_line|#endif /* ASSERT_PDIR_SANITY */
multiline_comment|/**************************************************************&n;*&n;*   I/O Pdir Resource Management&n;*&n;*   Bits set in the resource map are in use.&n;*   Each bit can represent a number of pages.&n;*   LSbs represent lower addresses (IOVA&squot;s).&n;*&n;***************************************************************/
DECL|macro|PAGES_PER_RANGE
mdefine_line|#define PAGES_PER_RANGE 1&t;/* could increase this to 4 or 8 if needed */
multiline_comment|/* Convert from IOVP to IOVA and vice versa. */
macro_line|#ifdef ZX1_SUPPORT
multiline_comment|/* Pluto (aka ZX1) boxes need to set or clear the ibase bits appropriately */
DECL|macro|SBA_IOVA
mdefine_line|#define SBA_IOVA(ioc,iovp,offset,hint_reg) ((ioc-&gt;ibase) | (iovp) | (offset))
DECL|macro|SBA_IOVP
mdefine_line|#define SBA_IOVP(ioc,iova) ((iova) &amp; (ioc)-&gt;iovp_mask)
macro_line|#else
multiline_comment|/* only support Astro and ancestors. Saves a few cycles in key places */
DECL|macro|SBA_IOVA
mdefine_line|#define SBA_IOVA(ioc,iovp,offset,hint_reg) ((iovp) | (offset))
DECL|macro|SBA_IOVP
mdefine_line|#define SBA_IOVP(ioc,iova) (iova)
macro_line|#endif
DECL|macro|PDIR_INDEX
mdefine_line|#define PDIR_INDEX(iovp)   ((iovp)&gt;&gt;IOVP_SHIFT)
DECL|macro|RESMAP_MASK
mdefine_line|#define RESMAP_MASK(n)    (~0UL &lt;&lt; (BITS_PER_LONG - (n)))
DECL|macro|RESMAP_IDX_MASK
mdefine_line|#define RESMAP_IDX_MASK   (sizeof(unsigned long) - 1)
multiline_comment|/**&n; * sba_search_bitmap - find free space in IO PDIR resource bitmap&n; * @ioc: IO MMU structure which owns the pdir we are interested in.&n; * @bits_wanted: number of entries we need.&n; *&n; * Find consecutive free bits in resource bitmap.&n; * Each bit represents one entry in the IO Pdir.&n; * Cool perf optimization: search for log2(size) bits at a time.&n; */
r_static
id|SBA_INLINE
r_int
r_int
DECL|function|sba_search_bitmap
id|sba_search_bitmap
c_func
(paren
r_struct
id|ioc
op_star
id|ioc
comma
r_int
r_int
id|bits_wanted
)paren
(brace
r_int
r_int
op_star
id|res_ptr
op_assign
id|ioc-&gt;res_hint
suffix:semicolon
r_int
r_int
op_star
id|res_end
op_assign
(paren
r_int
r_int
op_star
)paren
op_amp
(paren
id|ioc-&gt;res_map
(braket
id|ioc-&gt;res_size
)braket
)paren
suffix:semicolon
r_int
r_int
id|pide
op_assign
op_complement
l_int|0UL
suffix:semicolon
id|ASSERT
c_func
(paren
(paren
(paren
r_int
r_int
)paren
id|ioc-&gt;res_hint
op_amp
(paren
r_sizeof
(paren
r_int
r_int
)paren
op_minus
l_int|1UL
)paren
)paren
op_eq
l_int|0
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|res_ptr
OL
id|res_end
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bits_wanted
OG
(paren
id|BITS_PER_LONG
op_div
l_int|2
)paren
)paren
(brace
multiline_comment|/* Search word at a time - no mask needed */
r_for
c_loop
(paren
suffix:semicolon
id|res_ptr
OL
id|res_end
suffix:semicolon
op_increment
id|res_ptr
)paren
(brace
r_if
c_cond
(paren
op_star
id|res_ptr
op_eq
l_int|0
)paren
(brace
op_star
id|res_ptr
op_assign
id|RESMAP_MASK
c_func
(paren
id|bits_wanted
)paren
suffix:semicolon
id|pide
op_assign
(paren
(paren
r_int
r_int
)paren
id|res_ptr
op_minus
(paren
r_int
r_int
)paren
id|ioc-&gt;res_map
)paren
suffix:semicolon
id|pide
op_lshift_assign
l_int|3
suffix:semicolon
multiline_comment|/* convert to bit address */
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* point to the next word on next pass */
id|res_ptr
op_increment
suffix:semicolon
id|ioc-&gt;res_bitshift
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t;** Search the resource bit map on well-aligned values.&n;&t;&t;** &quot;o&quot; is the alignment.&n;&t;&t;** We need the alignment to invalidate I/O TLB using&n;&t;&t;** SBA HW features in the unmap path.&n;&t;&t;*/
r_int
r_int
id|o
op_assign
l_int|1
op_lshift
id|get_order
c_func
(paren
id|bits_wanted
op_lshift
id|PAGE_SHIFT
)paren
suffix:semicolon
id|uint
id|bitshiftcnt
op_assign
id|ROUNDUP
c_func
(paren
id|ioc-&gt;res_bitshift
comma
id|o
)paren
suffix:semicolon
r_int
r_int
id|mask
suffix:semicolon
r_if
c_cond
(paren
id|bitshiftcnt
op_ge
id|BITS_PER_LONG
)paren
(brace
id|bitshiftcnt
op_assign
l_int|0
suffix:semicolon
id|res_ptr
op_increment
suffix:semicolon
)brace
id|mask
op_assign
id|RESMAP_MASK
c_func
(paren
id|bits_wanted
)paren
op_rshift
id|bitshiftcnt
suffix:semicolon
id|DBG_RES
c_func
(paren
l_string|&quot;%s() o %ld %p&quot;
comma
id|__FUNCTION__
comma
id|o
comma
id|res_ptr
)paren
suffix:semicolon
r_while
c_loop
(paren
id|res_ptr
OL
id|res_end
)paren
(brace
id|DBG_RES
c_func
(paren
l_string|&quot;    %p %lx %lx&bslash;n&quot;
comma
id|res_ptr
comma
id|mask
comma
op_star
id|res_ptr
)paren
suffix:semicolon
id|BUG_ON
c_func
(paren
l_int|0
op_eq
id|mask
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_eq
(paren
(paren
op_star
id|res_ptr
)paren
op_amp
id|mask
)paren
)paren
(brace
op_star
id|res_ptr
op_or_assign
id|mask
suffix:semicolon
multiline_comment|/* mark resources busy! */
id|pide
op_assign
(paren
(paren
r_int
r_int
)paren
id|res_ptr
op_minus
(paren
r_int
r_int
)paren
id|ioc-&gt;res_map
)paren
suffix:semicolon
id|pide
op_lshift_assign
l_int|3
suffix:semicolon
multiline_comment|/* convert to bit address */
id|pide
op_add_assign
id|bitshiftcnt
suffix:semicolon
r_break
suffix:semicolon
)brace
id|mask
op_rshift_assign
id|o
suffix:semicolon
id|bitshiftcnt
op_add_assign
id|o
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_eq
id|mask
)paren
(brace
id|mask
op_assign
id|RESMAP_MASK
c_func
(paren
id|bits_wanted
)paren
suffix:semicolon
id|bitshiftcnt
op_assign
l_int|0
suffix:semicolon
id|res_ptr
op_increment
suffix:semicolon
)brace
)brace
multiline_comment|/* look in the same word on the next pass */
id|ioc-&gt;res_bitshift
op_assign
id|bitshiftcnt
op_plus
id|bits_wanted
suffix:semicolon
)brace
multiline_comment|/* wrapped ? */
r_if
c_cond
(paren
id|res_end
op_le
id|res_ptr
)paren
(brace
id|ioc-&gt;res_hint
op_assign
(paren
r_int
r_int
op_star
)paren
id|ioc-&gt;res_map
suffix:semicolon
id|ioc-&gt;res_bitshift
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|ioc-&gt;res_hint
op_assign
id|res_ptr
suffix:semicolon
)brace
r_return
(paren
id|pide
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * sba_alloc_range - find free bits and mark them in IO PDIR resource bitmap&n; * @ioc: IO MMU structure which owns the pdir we are interested in.&n; * @size: number of bytes to create a mapping for&n; *&n; * Given a size, find consecutive unmarked and then mark those bits in the&n; * resource bit map.&n; */
r_static
r_int
DECL|function|sba_alloc_range
id|sba_alloc_range
c_func
(paren
r_struct
id|ioc
op_star
id|ioc
comma
r_int
id|size
)paren
(brace
r_int
r_int
id|pages_needed
op_assign
id|size
op_rshift
id|IOVP_SHIFT
suffix:semicolon
macro_line|#ifdef SBA_COLLECT_STATS
r_int
r_int
id|cr_start
op_assign
id|mfctl
c_func
(paren
l_int|16
)paren
suffix:semicolon
macro_line|#endif
r_int
r_int
id|pide
suffix:semicolon
id|ASSERT
c_func
(paren
id|pages_needed
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
(paren
id|pages_needed
op_star
id|IOVP_SIZE
)paren
op_le
id|DMA_CHUNK_SIZE
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|pages_needed
op_le
id|BITS_PER_LONG
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
l_int|0
op_eq
(paren
id|size
op_amp
op_complement
id|IOVP_MASK
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t;** &quot;seek and ye shall find&quot;...praying never hurts either...&n;&t;** ggg sacrifices another 710 to the computer gods.&n;&t;*/
id|pide
op_assign
id|sba_search_bitmap
c_func
(paren
id|ioc
comma
id|pages_needed
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pide
op_ge
(paren
id|ioc-&gt;res_size
op_lshift
l_int|3
)paren
)paren
(brace
id|pide
op_assign
id|sba_search_bitmap
c_func
(paren
id|ioc
comma
id|pages_needed
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pide
op_ge
(paren
id|ioc-&gt;res_size
op_lshift
l_int|3
)paren
)paren
id|panic
c_func
(paren
l_string|&quot;%s: I/O MMU @ %lx is out of mapping resources&bslash;n&quot;
comma
id|__FILE__
comma
id|ioc-&gt;ioc_hpa
)paren
suffix:semicolon
)brace
macro_line|#ifdef ASSERT_PDIR_SANITY
multiline_comment|/* verify the first enable bit is clear */
r_if
c_cond
(paren
l_int|0x00
op_ne
(paren
(paren
id|u8
op_star
)paren
id|ioc-&gt;pdir_base
)paren
(braket
id|pide
op_star
r_sizeof
(paren
id|u64
)paren
op_plus
l_int|7
)braket
)paren
(brace
id|sba_dump_pdir_entry
c_func
(paren
id|ioc
comma
l_string|&quot;sba_search_bitmap() botched it?&quot;
comma
id|pide
)paren
suffix:semicolon
)brace
macro_line|#endif
id|DBG_RES
c_func
(paren
l_string|&quot;%s(%x) %d -&gt; %lx hint %x/%x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|size
comma
id|pages_needed
comma
id|pide
comma
(paren
id|uint
)paren
(paren
(paren
r_int
r_int
)paren
id|ioc-&gt;res_hint
op_minus
(paren
r_int
r_int
)paren
id|ioc-&gt;res_map
)paren
comma
id|ioc-&gt;res_bitshift
)paren
suffix:semicolon
macro_line|#ifdef SBA_COLLECT_STATS
(brace
r_int
r_int
id|cr_end
op_assign
id|mfctl
c_func
(paren
l_int|16
)paren
suffix:semicolon
r_int
r_int
id|tmp
op_assign
id|cr_end
op_minus
id|cr_start
suffix:semicolon
multiline_comment|/* check for roll over */
id|cr_start
op_assign
(paren
id|cr_end
OL
id|cr_start
)paren
ques
c_cond
op_minus
(paren
id|tmp
)paren
suffix:colon
(paren
id|tmp
)paren
suffix:semicolon
)brace
id|ioc-&gt;avg_search
(braket
id|ioc-&gt;avg_idx
op_increment
)braket
op_assign
id|cr_start
suffix:semicolon
id|ioc-&gt;avg_idx
op_and_assign
id|SBA_SEARCH_SAMPLE
op_minus
l_int|1
suffix:semicolon
id|ioc-&gt;used_pages
op_add_assign
id|pages_needed
suffix:semicolon
macro_line|#endif
r_return
(paren
id|pide
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * sba_free_range - unmark bits in IO PDIR resource bitmap&n; * @ioc: IO MMU structure which owns the pdir we are interested in.&n; * @iova: IO virtual address which was previously allocated.&n; * @size: number of bytes to create a mapping for&n; *&n; * clear bits in the ioc&squot;s resource map&n; */
r_static
id|SBA_INLINE
r_void
DECL|function|sba_free_range
id|sba_free_range
c_func
(paren
r_struct
id|ioc
op_star
id|ioc
comma
id|dma_addr_t
id|iova
comma
r_int
id|size
)paren
(brace
r_int
r_int
id|iovp
op_assign
id|SBA_IOVP
c_func
(paren
id|ioc
comma
id|iova
)paren
suffix:semicolon
r_int
r_int
id|pide
op_assign
id|PDIR_INDEX
c_func
(paren
id|iovp
)paren
suffix:semicolon
r_int
r_int
id|ridx
op_assign
id|pide
op_rshift
l_int|3
suffix:semicolon
multiline_comment|/* convert bit to byte address */
r_int
r_int
op_star
id|res_ptr
op_assign
(paren
r_int
r_int
op_star
)paren
op_amp
(paren
(paren
id|ioc
)paren
op_member_access_from_pointer
id|res_map
(braket
id|ridx
op_amp
op_complement
id|RESMAP_IDX_MASK
)braket
)paren
suffix:semicolon
r_int
id|bits_not_wanted
op_assign
id|size
op_rshift
id|IOVP_SHIFT
suffix:semicolon
multiline_comment|/* 3-bits &quot;bit&quot; address plus 2 (or 3) bits for &quot;byte&quot; == bit in word */
r_int
r_int
id|m
op_assign
id|RESMAP_MASK
c_func
(paren
id|bits_not_wanted
)paren
op_rshift
(paren
id|pide
op_amp
(paren
id|BITS_PER_LONG
op_minus
l_int|1
)paren
)paren
suffix:semicolon
id|DBG_RES
c_func
(paren
l_string|&quot;%s( ,%x,%x) %x/%lx %x %p %lx&bslash;n&quot;
comma
id|__FUNCTION__
comma
(paren
id|uint
)paren
id|iova
comma
id|size
comma
id|bits_not_wanted
comma
id|m
comma
id|pide
comma
id|res_ptr
comma
op_star
id|res_ptr
)paren
suffix:semicolon
macro_line|#ifdef SBA_COLLECT_STATS
id|ioc-&gt;used_pages
op_sub_assign
id|bits_not_wanted
suffix:semicolon
macro_line|#endif
id|ASSERT
c_func
(paren
id|m
op_ne
l_int|0
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|bits_not_wanted
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
(paren
id|bits_not_wanted
op_star
id|IOVP_SIZE
)paren
op_le
id|DMA_CHUNK_SIZE
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|bits_not_wanted
op_le
id|BITS_PER_LONG
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
(paren
op_star
id|res_ptr
op_amp
id|m
)paren
op_eq
id|m
)paren
suffix:semicolon
multiline_comment|/* verify same bits are set */
op_star
id|res_ptr
op_and_assign
op_complement
id|m
suffix:semicolon
)brace
multiline_comment|/**************************************************************&n;*&n;*   &quot;Dynamic DMA Mapping&quot; support (aka &quot;Coherent I/O&quot;)&n;*&n;***************************************************************/
macro_line|#if SBA_HINT_SUPPORT
DECL|macro|SBA_DMA_HINT
mdefine_line|#define SBA_DMA_HINT(ioc, val) ((val) &lt;&lt; (ioc)-&gt;hint_shift_pdir)
macro_line|#endif
DECL|typedef|space_t
r_typedef
r_int
r_int
id|space_t
suffix:semicolon
DECL|macro|KERNEL_SPACE
mdefine_line|#define KERNEL_SPACE 0
multiline_comment|/**&n; * sba_io_pdir_entry - fill in one IO PDIR entry&n; * @pdir_ptr:  pointer to IO PDIR entry&n; * @sid: process Space ID&n; * @vba: Virtual CPU address of buffer to map&n; *&n; * SBA Mapping Routine&n; *&n; * Given a virtual address (vba, arg2) and space id, (sid, arg1)&n; * sba_io_pdir_entry() loads the I/O PDIR entry pointed to by&n; * pdir_ptr (arg0). &n; * Using the bass-ackwards HP bit numbering, Each IO Pdir entry&n; * for Astro/Ike looks like:&n; *&n; *&n; *  0                    19                                 51   55       63&n; * +-+---------------------+----------------------------------+----+--------+&n; * |V|        U            |            PPN[43:12]            | U  |   VI   |&n; * +-+---------------------+----------------------------------+----+--------+&n; *&n; * Pluto is basically identical, supports fewer physical address bits:&n; *&n; *  0                       23                              51   55       63&n; * +-+------------------------+-------------------------------+----+--------+&n; * |V|        U               |         PPN[39:12]            | U  |   VI   |&n; * +-+------------------------+-------------------------------+----+--------+&n; *&n; *  V  == Valid Bit  (Most Significant Bit is bit 0)&n; *  U  == Unused&n; * PPN == Physical Page Number&n; * VI  == Virtual Index (aka Coherent Index)&n; *&n; * LPA instruction output is put into PPN field.&n; * LCI (Load Coherence Index) instruction provides the &quot;VI&quot; bits.&n; *&n; * We pre-swap the bytes since PCX-W is Big Endian and the&n; * IOMMU uses little endian for the pdir.&n; */
r_void
id|SBA_INLINE
DECL|function|sba_io_pdir_entry
id|sba_io_pdir_entry
c_func
(paren
id|u64
op_star
id|pdir_ptr
comma
id|space_t
id|sid
comma
r_int
r_int
id|vba
comma
r_int
r_int
id|hint
)paren
(brace
id|u64
id|pa
suffix:semicolon
multiline_comment|/* physical address */
r_register
r_int
id|ci
suffix:semicolon
multiline_comment|/* coherent index */
multiline_comment|/* We currently only support kernel addresses.&n;&t; * fdc instr below will need to reload sr1 with KERNEL_SPACE&n;&t; * once we try to support direct DMA to user space.&n;&t; */
id|ASSERT
c_func
(paren
id|sid
op_eq
id|KERNEL_SPACE
)paren
suffix:semicolon
id|pa
op_assign
id|virt_to_phys
c_func
(paren
id|vba
)paren
suffix:semicolon
id|pa
op_and_assign
id|IOVP_MASK
suffix:semicolon
id|mtsp
c_func
(paren
id|sid
comma
l_int|1
)paren
suffix:semicolon
id|asm
c_func
(paren
l_string|&quot;lci 0(%%sr1, %1), %0&quot;
suffix:colon
l_string|&quot;=r&quot;
(paren
id|ci
)paren
suffix:colon
l_string|&quot;r&quot;
(paren
id|vba
)paren
)paren
suffix:semicolon
id|pa
op_or_assign
(paren
id|ci
op_rshift
l_int|12
)paren
op_amp
l_int|0xff
suffix:semicolon
multiline_comment|/* move CI (8 bits) into lowest byte */
id|pa
op_or_assign
l_int|0x8000000000000000ULL
suffix:semicolon
multiline_comment|/* set &quot;valid&quot; bit */
op_star
id|pdir_ptr
op_assign
id|cpu_to_le64
c_func
(paren
id|pa
)paren
suffix:semicolon
multiline_comment|/* swap and store into I/O Pdir */
multiline_comment|/*&n;&t; * If the PDC_MODEL capabilities has Non-coherent IO-PDIR bit set&n;&t; * (bit #61, big endian), we have to flush and sync every time&n;&t; * IO-PDIR is changed in Ike/Astro.&n;&t; */
r_if
c_cond
(paren
id|ioc_needs_fdc
)paren
(brace
id|asm
r_volatile
(paren
l_string|&quot;fdc 0(%%sr1,%0)&bslash;n&bslash;tsync&quot;
suffix:colon
suffix:colon
l_string|&quot;r&quot;
(paren
id|pdir_ptr
)paren
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; * sba_mark_invalid - invalidate one or more IO PDIR entries&n; * @ioc: IO MMU structure which owns the pdir we are interested in.&n; * @iova:  IO Virtual Address mapped earlier&n; * @byte_cnt:  number of bytes this mapping covers.&n; *&n; * Marking the IO PDIR entry(ies) as Invalid and invalidate&n; * corresponding IO TLB entry. The Ike PCOM (Purge Command Register)&n; * is to purge stale entries in the IO TLB when unmapping entries.&n; *&n; * The PCOM register supports purging of multiple pages, with a minium&n; * of 1 page and a maximum of 2GB. Hardware requires the address be&n; * aligned to the size of the range being purged. The size of the range&n; * must be a power of 2. The &quot;Cool perf optimization&quot; in the&n; * allocation routine helps keep that true.&n; */
r_static
id|SBA_INLINE
r_void
DECL|function|sba_mark_invalid
id|sba_mark_invalid
c_func
(paren
r_struct
id|ioc
op_star
id|ioc
comma
id|dma_addr_t
id|iova
comma
r_int
id|byte_cnt
)paren
(brace
id|u32
id|iovp
op_assign
(paren
id|u32
)paren
id|SBA_IOVP
c_func
(paren
id|ioc
comma
id|iova
)paren
suffix:semicolon
multiline_comment|/* Even though this is a big-endian machine, the entries&n;&t;** in the iopdir are little endian. That&squot;s why we clear the byte&n;&t;** at +7 instead of at +0.&n;&t;*/
r_int
id|off
op_assign
id|PDIR_INDEX
c_func
(paren
id|iovp
)paren
op_star
r_sizeof
(paren
id|u64
)paren
op_plus
l_int|7
suffix:semicolon
multiline_comment|/* Must be non-zero and rounded up */
id|ASSERT
c_func
(paren
id|byte_cnt
OG
l_int|0
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
l_int|0
op_eq
(paren
id|byte_cnt
op_amp
op_complement
id|IOVP_MASK
)paren
)paren
suffix:semicolon
macro_line|#ifdef ASSERT_PDIR_SANITY
multiline_comment|/* Assert first pdir entry is set */
r_if
c_cond
(paren
l_int|0x80
op_ne
(paren
(paren
(paren
id|u8
op_star
)paren
id|ioc-&gt;pdir_base
)paren
(braket
id|off
)braket
)paren
)paren
(brace
id|sba_dump_pdir_entry
c_func
(paren
id|ioc
comma
l_string|&quot;sba_mark_invalid()&quot;
comma
id|PDIR_INDEX
c_func
(paren
id|iovp
)paren
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|byte_cnt
op_le
id|IOVP_SIZE
)paren
(brace
id|ASSERT
c_func
(paren
id|off
OL
id|ioc-&gt;pdir_size
)paren
suffix:semicolon
id|iovp
op_or_assign
id|IOVP_SHIFT
suffix:semicolon
multiline_comment|/* set &quot;size&quot; field for PCOM */
multiline_comment|/*&n;&t;&t;** clear I/O PDIR entry &quot;valid&quot; bit&n;&t;&t;** Do NOT clear the rest - save it for debugging.&n;&t;&t;** We should only clear bits that have previously&n;&t;&t;** been enabled.&n;&t;&t;*/
(paren
(paren
id|u8
op_star
)paren
(paren
id|ioc-&gt;pdir_base
)paren
)paren
(braket
id|off
)braket
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|u32
id|t
op_assign
id|get_order
c_func
(paren
id|byte_cnt
)paren
op_plus
id|PAGE_SHIFT
suffix:semicolon
id|iovp
op_or_assign
id|t
suffix:semicolon
id|ASSERT
c_func
(paren
id|t
op_le
l_int|31
)paren
suffix:semicolon
multiline_comment|/* 2GB! Max value of &quot;size&quot; field */
r_do
(brace
multiline_comment|/* verify this pdir entry is enabled */
id|ASSERT
c_func
(paren
l_int|0x80
op_eq
(paren
(paren
(paren
id|u8
op_star
)paren
id|ioc-&gt;pdir_base
)paren
(braket
id|off
)braket
op_amp
l_int|0x80
)paren
)paren
suffix:semicolon
multiline_comment|/* clear I/O Pdir entry &quot;valid&quot; bit first */
(paren
(paren
id|u8
op_star
)paren
(paren
id|ioc-&gt;pdir_base
)paren
)paren
(braket
id|off
)braket
op_assign
l_int|0
suffix:semicolon
id|off
op_add_assign
r_sizeof
(paren
id|u64
)paren
suffix:semicolon
id|byte_cnt
op_sub_assign
id|IOVP_SIZE
suffix:semicolon
)brace
r_while
c_loop
(paren
id|byte_cnt
OG
l_int|0
)paren
suffix:semicolon
)brace
id|WRITE_REG
c_func
(paren
id|SBA_IOVA
c_func
(paren
id|ioc
comma
id|iovp
comma
l_int|0
comma
l_int|0
)paren
comma
id|ioc-&gt;ioc_hpa
op_plus
id|IOC_PCOM
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * sba_dma_supported - PCI driver can query DMA support&n; * @dev: instance of PCI owned by the driver that&squot;s asking&n; * @mask:  number of address bits this PCI device can handle&n; *&n; * See Documentation/DMA-mapping.txt&n; */
r_static
r_int
DECL|function|sba_dma_supported
id|sba_dma_supported
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|u64
id|mask
)paren
(brace
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|MODULE_NAME
l_string|&quot;: EISA/ISA/et al not supported&bslash;n&quot;
)paren
suffix:semicolon
id|BUG
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* only support 32-bit PCI devices - no DAC support (yet) */
r_return
(paren
r_int
)paren
(paren
id|mask
op_eq
l_int|0xffffffffUL
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * sba_map_single - map one buffer and return IOVA for DMA&n; * @dev: instance of PCI owned by the driver that&squot;s asking.&n; * @addr:  driver buffer to map.&n; * @size:  number of bytes to map in driver buffer.&n; * @direction:  R/W or both.&n; *&n; * See Documentation/DMA-mapping.txt&n; */
r_static
id|dma_addr_t
DECL|function|sba_map_single
id|sba_map_single
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_void
op_star
id|addr
comma
r_int
id|size
comma
r_enum
id|dma_data_direction
id|direction
)paren
(brace
r_struct
id|ioc
op_star
id|ioc
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|dma_addr_t
id|iovp
suffix:semicolon
id|dma_addr_t
id|offset
suffix:semicolon
id|u64
op_star
id|pdir_start
suffix:semicolon
r_int
id|pide
suffix:semicolon
id|ASSERT
c_func
(paren
id|size
OG
l_int|0
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|size
op_le
id|DMA_CHUNK_SIZE
)paren
suffix:semicolon
id|ioc
op_assign
id|GET_IOC
c_func
(paren
id|dev
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|ioc
)paren
suffix:semicolon
multiline_comment|/* save offset bits */
id|offset
op_assign
(paren
(paren
id|dma_addr_t
)paren
(paren
r_int
)paren
id|addr
)paren
op_amp
op_complement
id|IOVP_MASK
suffix:semicolon
multiline_comment|/* round up to nearest IOVP_SIZE */
id|size
op_assign
(paren
id|size
op_plus
id|offset
op_plus
op_complement
id|IOVP_MASK
)paren
op_amp
id|IOVP_MASK
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ioc-&gt;res_lock
comma
id|flags
)paren
suffix:semicolon
macro_line|#ifdef ASSERT_PDIR_SANITY
id|sba_check_pdir
c_func
(paren
id|ioc
comma
l_string|&quot;Check before sba_map_single()&quot;
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef SBA_COLLECT_STATS
id|ioc-&gt;msingle_calls
op_increment
suffix:semicolon
id|ioc-&gt;msingle_pages
op_add_assign
id|size
op_rshift
id|IOVP_SHIFT
suffix:semicolon
macro_line|#endif
id|pide
op_assign
id|sba_alloc_range
c_func
(paren
id|ioc
comma
id|size
)paren
suffix:semicolon
id|iovp
op_assign
(paren
id|dma_addr_t
)paren
id|pide
op_lshift
id|IOVP_SHIFT
suffix:semicolon
id|DBG_RUN
c_func
(paren
l_string|&quot;%s() 0x%p -&gt; 0x%lx&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|addr
comma
(paren
r_int
)paren
id|iovp
op_or
id|offset
)paren
suffix:semicolon
id|pdir_start
op_assign
op_amp
(paren
id|ioc-&gt;pdir_base
(braket
id|pide
)braket
)paren
suffix:semicolon
r_while
c_loop
(paren
id|size
OG
l_int|0
)paren
(brace
id|ASSERT
c_func
(paren
(paren
(paren
id|u8
op_star
)paren
id|pdir_start
)paren
(braket
l_int|7
)braket
op_eq
l_int|0
)paren
suffix:semicolon
multiline_comment|/* verify availability */
id|sba_io_pdir_entry
c_func
(paren
id|pdir_start
comma
id|KERNEL_SPACE
comma
(paren
r_int
r_int
)paren
id|addr
comma
l_int|0
)paren
suffix:semicolon
id|DBG_RUN
c_func
(paren
l_string|&quot;&t;pdir 0x%p %02x%02x%02x%02x%02x%02x%02x%02x&bslash;n&quot;
comma
id|pdir_start
comma
(paren
id|u8
)paren
(paren
(paren
(paren
id|u8
op_star
)paren
id|pdir_start
)paren
(braket
l_int|7
)braket
)paren
comma
(paren
id|u8
)paren
(paren
(paren
(paren
id|u8
op_star
)paren
id|pdir_start
)paren
(braket
l_int|6
)braket
)paren
comma
(paren
id|u8
)paren
(paren
(paren
(paren
id|u8
op_star
)paren
id|pdir_start
)paren
(braket
l_int|5
)braket
)paren
comma
(paren
id|u8
)paren
(paren
(paren
(paren
id|u8
op_star
)paren
id|pdir_start
)paren
(braket
l_int|4
)braket
)paren
comma
(paren
id|u8
)paren
(paren
(paren
(paren
id|u8
op_star
)paren
id|pdir_start
)paren
(braket
l_int|3
)braket
)paren
comma
(paren
id|u8
)paren
(paren
(paren
(paren
id|u8
op_star
)paren
id|pdir_start
)paren
(braket
l_int|2
)braket
)paren
comma
(paren
id|u8
)paren
(paren
(paren
(paren
id|u8
op_star
)paren
id|pdir_start
)paren
(braket
l_int|1
)braket
)paren
comma
(paren
id|u8
)paren
(paren
(paren
(paren
id|u8
op_star
)paren
id|pdir_start
)paren
(braket
l_int|0
)braket
)paren
)paren
suffix:semicolon
id|addr
op_add_assign
id|IOVP_SIZE
suffix:semicolon
id|size
op_sub_assign
id|IOVP_SIZE
suffix:semicolon
id|pdir_start
op_increment
suffix:semicolon
)brace
multiline_comment|/* form complete address */
macro_line|#ifdef ASSERT_PDIR_SANITY
id|sba_check_pdir
c_func
(paren
id|ioc
comma
l_string|&quot;Check after sba_map_single()&quot;
)paren
suffix:semicolon
macro_line|#endif
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ioc-&gt;res_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|SBA_IOVA
c_func
(paren
id|ioc
comma
id|iovp
comma
id|offset
comma
id|DEFAULT_DMA_HINT_REG
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * sba_unmap_single - unmap one IOVA and free resources&n; * @dev: instance of PCI owned by the driver that&squot;s asking.&n; * @iova:  IOVA of driver buffer previously mapped.&n; * @size:  number of bytes mapped in driver buffer.&n; * @direction:  R/W or both.&n; *&n; * See Documentation/DMA-mapping.txt&n; */
r_static
r_void
DECL|function|sba_unmap_single
id|sba_unmap_single
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|dma_addr_t
id|iova
comma
r_int
id|size
comma
r_enum
id|dma_data_direction
id|direction
)paren
(brace
r_struct
id|ioc
op_star
id|ioc
suffix:semicolon
macro_line|#if DELAYED_RESOURCE_CNT &gt; 0
r_struct
id|sba_dma_pair
op_star
id|d
suffix:semicolon
macro_line|#endif
r_int
r_int
id|flags
suffix:semicolon
id|dma_addr_t
id|offset
suffix:semicolon
id|ioc
op_assign
id|GET_IOC
c_func
(paren
id|dev
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|ioc
)paren
suffix:semicolon
id|offset
op_assign
id|iova
op_amp
op_complement
id|IOVP_MASK
suffix:semicolon
id|DBG_RUN
c_func
(paren
l_string|&quot;%s() iovp 0x%lx/%x&bslash;n&quot;
comma
id|__FUNCTION__
comma
(paren
r_int
)paren
id|iova
comma
id|size
)paren
suffix:semicolon
id|iova
op_xor_assign
id|offset
suffix:semicolon
multiline_comment|/* clear offset bits */
id|size
op_add_assign
id|offset
suffix:semicolon
id|size
op_assign
id|ROUNDUP
c_func
(paren
id|size
comma
id|IOVP_SIZE
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ioc-&gt;res_lock
comma
id|flags
)paren
suffix:semicolon
macro_line|#ifdef SBA_COLLECT_STATS
id|ioc-&gt;usingle_calls
op_increment
suffix:semicolon
id|ioc-&gt;usingle_pages
op_add_assign
id|size
op_rshift
id|IOVP_SHIFT
suffix:semicolon
macro_line|#endif
id|sba_mark_invalid
c_func
(paren
id|ioc
comma
id|iova
comma
id|size
)paren
suffix:semicolon
macro_line|#if DELAYED_RESOURCE_CNT &gt; 0
multiline_comment|/* Delaying when we re-use a IO Pdir entry reduces the number&n;&t; * of MMIO reads needed to flush writes to the PCOM register.&n;&t; */
id|d
op_assign
op_amp
(paren
id|ioc-&gt;saved
(braket
id|ioc-&gt;saved_cnt
)braket
)paren
suffix:semicolon
id|d-&gt;iova
op_assign
id|iova
suffix:semicolon
id|d-&gt;size
op_assign
id|size
suffix:semicolon
r_if
c_cond
(paren
op_increment
(paren
id|ioc-&gt;saved_cnt
)paren
op_ge
id|DELAYED_RESOURCE_CNT
)paren
(brace
r_int
id|cnt
op_assign
id|ioc-&gt;saved_cnt
suffix:semicolon
r_while
c_loop
(paren
id|cnt
op_decrement
)paren
(brace
id|sba_free_range
c_func
(paren
id|ioc
comma
id|d-&gt;iova
comma
id|d-&gt;size
)paren
suffix:semicolon
id|d
op_decrement
suffix:semicolon
)brace
id|ioc-&gt;saved_cnt
op_assign
l_int|0
suffix:semicolon
id|READ_REG
c_func
(paren
id|ioc-&gt;ioc_hpa
op_plus
id|IOC_PCOM
)paren
suffix:semicolon
multiline_comment|/* flush purges */
)brace
macro_line|#else /* DELAYED_RESOURCE_CNT == 0 */
id|sba_free_range
c_func
(paren
id|ioc
comma
id|iova
comma
id|size
)paren
suffix:semicolon
id|READ_REG
c_func
(paren
id|ioc-&gt;ioc_hpa
op_plus
id|IOC_PCOM
)paren
suffix:semicolon
multiline_comment|/* flush purges */
macro_line|#endif /* DELAYED_RESOURCE_CNT == 0 */
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ioc-&gt;res_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* XXX REVISIT for 2.5 Linux - need syncdma for zero-copy support.&n;&t;** For Astro based systems this isn&squot;t a big deal WRT performance.&n;&t;** As long as 2.4 kernels copyin/copyout data from/to userspace,&n;&t;** we don&squot;t need the syncdma. The issue here is I/O MMU cachelines&n;&t;** are *not* coherent in all cases.  May be hwrev dependent.&n;&t;** Need to investigate more.&n;&t;asm volatile(&quot;syncdma&quot;);&t;&n;&t;*/
)brace
multiline_comment|/**&n; * sba_alloc_consistent - allocate/map shared mem for DMA&n; * @hwdev: instance of PCI owned by the driver that&squot;s asking.&n; * @size:  number of bytes mapped in driver buffer.&n; * @dma_handle:  IOVA of new buffer.&n; *&n; * See Documentation/DMA-mapping.txt&n; */
DECL|function|sba_alloc_consistent
r_static
r_void
op_star
id|sba_alloc_consistent
c_func
(paren
r_struct
id|device
op_star
id|hwdev
comma
r_int
id|size
comma
id|dma_addr_t
op_star
id|dma_handle
comma
r_int
id|gfp
)paren
(brace
r_void
op_star
id|ret
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hwdev
)paren
(brace
multiline_comment|/* only support PCI */
op_star
id|dma_handle
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|ret
op_assign
(paren
r_void
op_star
)paren
id|__get_free_pages
c_func
(paren
id|gfp
comma
id|get_order
c_func
(paren
id|size
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|memset
c_func
(paren
id|ret
comma
l_int|0
comma
id|size
)paren
suffix:semicolon
op_star
id|dma_handle
op_assign
id|sba_map_single
c_func
(paren
id|hwdev
comma
id|ret
comma
id|size
comma
l_int|0
)paren
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/**&n; * sba_free_consistent - free/unmap shared mem for DMA&n; * @hwdev: instance of PCI owned by the driver that&squot;s asking.&n; * @size:  number of bytes mapped in driver buffer.&n; * @vaddr:  virtual address IOVA of &quot;consistent&quot; buffer.&n; * @dma_handler:  IO virtual address of &quot;consistent&quot; buffer.&n; *&n; * See Documentation/DMA-mapping.txt&n; */
r_static
r_void
DECL|function|sba_free_consistent
id|sba_free_consistent
c_func
(paren
r_struct
id|device
op_star
id|hwdev
comma
r_int
id|size
comma
r_void
op_star
id|vaddr
comma
id|dma_addr_t
id|dma_handle
)paren
(brace
id|sba_unmap_single
c_func
(paren
id|hwdev
comma
id|dma_handle
comma
id|size
comma
l_int|0
)paren
suffix:semicolon
id|free_pages
c_func
(paren
(paren
r_int
r_int
)paren
id|vaddr
comma
id|get_order
c_func
(paren
id|size
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;** Since 0 is a valid pdir_base index value, can&squot;t use that&n;** to determine if a value is valid or not. Use a flag to indicate&n;** the SG list entry contains a valid pdir index.&n;*/
DECL|macro|PIDE_FLAG
mdefine_line|#define PIDE_FLAG 0x80000000UL
macro_line|#ifdef SBA_COLLECT_STATS
DECL|macro|IOMMU_MAP_STATS
mdefine_line|#define IOMMU_MAP_STATS
macro_line|#endif
macro_line|#include &quot;iommu-helpers.h&quot;
macro_line|#ifdef DEBUG_LARGE_SG_ENTRIES
DECL|variable|dump_run_sg
r_int
id|dump_run_sg
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
multiline_comment|/**&n; * sba_map_sg - map Scatter/Gather list&n; * @dev: instance of PCI owned by the driver that&squot;s asking.&n; * @sglist:  array of buffer/length pairs&n; * @nents:  number of entries in list&n; * @direction:  R/W or both.&n; *&n; * See Documentation/DMA-mapping.txt&n; */
r_static
r_int
DECL|function|sba_map_sg
id|sba_map_sg
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|scatterlist
op_star
id|sglist
comma
r_int
id|nents
comma
r_enum
id|dma_data_direction
id|direction
)paren
(brace
r_struct
id|ioc
op_star
id|ioc
suffix:semicolon
r_int
id|coalesced
comma
id|filled
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|DBG_RUN_SG
c_func
(paren
l_string|&quot;%s() START %d entries&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|nents
)paren
suffix:semicolon
id|ioc
op_assign
id|GET_IOC
c_func
(paren
id|dev
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|ioc
)paren
suffix:semicolon
multiline_comment|/* Fast path single entry scatterlists. */
r_if
c_cond
(paren
id|nents
op_eq
l_int|1
)paren
(brace
id|sg_dma_address
c_func
(paren
id|sglist
)paren
op_assign
id|sba_map_single
c_func
(paren
id|dev
comma
(paren
r_void
op_star
)paren
id|sg_virt_addr
c_func
(paren
id|sglist
)paren
comma
id|sglist-&gt;length
comma
id|direction
)paren
suffix:semicolon
id|sg_dma_len
c_func
(paren
id|sglist
)paren
op_assign
id|sglist-&gt;length
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ioc-&gt;res_lock
comma
id|flags
)paren
suffix:semicolon
macro_line|#ifdef ASSERT_PDIR_SANITY
r_if
c_cond
(paren
id|sba_check_pdir
c_func
(paren
id|ioc
comma
l_string|&quot;Check before sba_map_sg()&quot;
)paren
)paren
(brace
id|sba_dump_sg
c_func
(paren
id|ioc
comma
id|sglist
comma
id|nents
)paren
suffix:semicolon
id|panic
c_func
(paren
l_string|&quot;Check before sba_map_sg()&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifdef SBA_COLLECT_STATS
id|ioc-&gt;msg_calls
op_increment
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;&t;** First coalesce the chunks and allocate I/O pdir space&n;&t;**&n;&t;** If this is one DMA stream, we can properly map using the&n;&t;** correct virtual address associated with each DMA page.&n;&t;** w/o this association, we wouldn&squot;t have coherent DMA!&n;&t;** Access to the virtual address is what forces a two pass algorithm.&n;&t;*/
id|coalesced
op_assign
id|iommu_coalesce_chunks
c_func
(paren
id|ioc
comma
id|sglist
comma
id|nents
comma
id|sba_alloc_range
)paren
suffix:semicolon
multiline_comment|/*&n;&t;** Program the I/O Pdir&n;&t;**&n;&t;** map the virtual addresses to the I/O Pdir&n;&t;** o dma_address will contain the pdir index&n;&t;** o dma_len will contain the number of bytes to map &n;&t;** o address contains the virtual address.&n;&t;*/
id|filled
op_assign
id|iommu_fill_pdir
c_func
(paren
id|ioc
comma
id|sglist
comma
id|nents
comma
l_int|0
comma
id|sba_io_pdir_entry
)paren
suffix:semicolon
macro_line|#ifdef ASSERT_PDIR_SANITY
r_if
c_cond
(paren
id|sba_check_pdir
c_func
(paren
id|ioc
comma
l_string|&quot;Check after sba_map_sg()&quot;
)paren
)paren
(brace
id|sba_dump_sg
c_func
(paren
id|ioc
comma
id|sglist
comma
id|nents
)paren
suffix:semicolon
id|panic
c_func
(paren
l_string|&quot;Check after sba_map_sg()&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ioc-&gt;res_lock
comma
id|flags
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|coalesced
op_eq
id|filled
)paren
suffix:semicolon
id|DBG_RUN_SG
c_func
(paren
l_string|&quot;%s() DONE %d mappings&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|filled
)paren
suffix:semicolon
r_return
id|filled
suffix:semicolon
)brace
multiline_comment|/**&n; * sba_unmap_sg - unmap Scatter/Gather list&n; * @dev: instance of PCI owned by the driver that&squot;s asking.&n; * @sglist:  array of buffer/length pairs&n; * @nents:  number of entries in list&n; * @direction:  R/W or both.&n; *&n; * See Documentation/DMA-mapping.txt&n; */
r_static
r_void
DECL|function|sba_unmap_sg
id|sba_unmap_sg
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|scatterlist
op_star
id|sglist
comma
r_int
id|nents
comma
r_enum
id|dma_data_direction
id|direction
)paren
(brace
r_struct
id|ioc
op_star
id|ioc
suffix:semicolon
macro_line|#ifdef ASSERT_PDIR_SANITY
r_int
r_int
id|flags
suffix:semicolon
macro_line|#endif
id|DBG_RUN_SG
c_func
(paren
l_string|&quot;%s() START %d entries,  %p,%x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|nents
comma
id|sg_virt_addr
c_func
(paren
id|sglist
)paren
comma
id|sglist-&gt;length
)paren
suffix:semicolon
id|ioc
op_assign
id|GET_IOC
c_func
(paren
id|dev
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|ioc
)paren
suffix:semicolon
macro_line|#ifdef SBA_COLLECT_STATS
id|ioc-&gt;usg_calls
op_increment
suffix:semicolon
macro_line|#endif
macro_line|#ifdef ASSERT_PDIR_SANITY
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ioc-&gt;res_lock
comma
id|flags
)paren
suffix:semicolon
id|sba_check_pdir
c_func
(paren
id|ioc
comma
l_string|&quot;Check before sba_unmap_sg()&quot;
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ioc-&gt;res_lock
comma
id|flags
)paren
suffix:semicolon
macro_line|#endif
r_while
c_loop
(paren
id|sg_dma_len
c_func
(paren
id|sglist
)paren
op_logical_and
id|nents
op_decrement
)paren
(brace
id|sba_unmap_single
c_func
(paren
id|dev
comma
id|sg_dma_address
c_func
(paren
id|sglist
)paren
comma
id|sg_dma_len
c_func
(paren
id|sglist
)paren
comma
id|direction
)paren
suffix:semicolon
macro_line|#ifdef SBA_COLLECT_STATS
id|ioc-&gt;usg_pages
op_add_assign
(paren
(paren
id|sg_dma_address
c_func
(paren
id|sglist
)paren
op_amp
op_complement
id|IOVP_MASK
)paren
op_plus
id|sg_dma_len
c_func
(paren
id|sglist
)paren
op_plus
id|IOVP_SIZE
op_minus
l_int|1
)paren
op_rshift
id|PAGE_SHIFT
suffix:semicolon
id|ioc-&gt;usingle_calls
op_decrement
suffix:semicolon
multiline_comment|/* kluge since call is unmap_sg() */
macro_line|#endif
op_increment
id|sglist
suffix:semicolon
)brace
id|DBG_RUN_SG
c_func
(paren
l_string|&quot;%s() DONE (nents %d)&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|nents
)paren
suffix:semicolon
macro_line|#ifdef ASSERT_PDIR_SANITY
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ioc-&gt;res_lock
comma
id|flags
)paren
suffix:semicolon
id|sba_check_pdir
c_func
(paren
id|ioc
comma
l_string|&quot;Check after sba_unmap_sg()&quot;
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ioc-&gt;res_lock
comma
id|flags
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|variable|sba_ops
r_static
r_struct
id|hppa_dma_ops
id|sba_ops
op_assign
(brace
dot
id|dma_supported
op_assign
id|sba_dma_supported
comma
dot
id|alloc_consistent
op_assign
id|sba_alloc_consistent
comma
dot
id|alloc_noncoherent
op_assign
id|sba_alloc_consistent
comma
dot
id|free_consistent
op_assign
id|sba_free_consistent
comma
dot
id|map_single
op_assign
id|sba_map_single
comma
dot
id|unmap_single
op_assign
id|sba_unmap_single
comma
dot
id|map_sg
op_assign
id|sba_map_sg
comma
dot
id|unmap_sg
op_assign
id|sba_unmap_sg
comma
dot
id|dma_sync_single_for_cpu
op_assign
l_int|NULL
comma
dot
id|dma_sync_single_for_device
op_assign
l_int|NULL
comma
dot
id|dma_sync_sg_for_cpu
op_assign
l_int|NULL
comma
dot
id|dma_sync_sg_for_device
op_assign
l_int|NULL
comma
)brace
suffix:semicolon
multiline_comment|/**************************************************************************&n;**&n;**   SBA PAT PDC support&n;**&n;**   o call pdc_pat_cell_module()&n;**   o store ranges in PCI &quot;resource&quot; structures&n;**&n;**************************************************************************/
r_static
r_void
DECL|function|sba_get_pat_resources
id|sba_get_pat_resources
c_func
(paren
r_struct
id|sba_device
op_star
id|sba_dev
)paren
(brace
macro_line|#if 0
multiline_comment|/*&n;** TODO/REVISIT/FIXME: support for directed ranges requires calls to&n;**      PAT PDC to program the SBA/LBA directed range registers...this&n;**      burden may fall on the LBA code since it directly supports the&n;**      PCI subsystem. It&squot;s not clear yet. - ggg&n;*/
id|PAT_MOD
c_func
(paren
id|mod
)paren
op_member_access_from_pointer
id|mod_info.mod_pages
op_assign
id|PAT_GET_MOD_PAGES
c_func
(paren
id|temp
)paren
suffix:semicolon
id|FIXME
suffix:colon
ques
c_cond
ques
c_cond
ques
c_cond
id|PAT_MOD
c_func
(paren
id|mod
)paren
op_member_access_from_pointer
id|mod_info.dvi
op_assign
id|PAT_GET_DVI
c_func
(paren
id|temp
)paren
suffix:semicolon
id|Tells
id|where
id|the
id|dvi
id|bits
id|are
id|located
id|in
id|the
id|address
dot
id|PAT_MOD
c_func
(paren
id|mod
)paren
op_member_access_from_pointer
id|mod_info.ioc
op_assign
id|PAT_GET_IOC
c_func
(paren
id|temp
)paren
suffix:semicolon
id|FIXME
suffix:colon
ques
c_cond
ques
c_cond
ques
c_cond
macro_line|#endif
)brace
multiline_comment|/**************************************************************&n;*&n;*   Initialization and claim&n;*&n;***************************************************************/
DECL|macro|PIRANHA_ADDR_MASK
mdefine_line|#define PIRANHA_ADDR_MASK&t;0x00160000UL /* bit 17,18,20 */
DECL|macro|PIRANHA_ADDR_VAL
mdefine_line|#define PIRANHA_ADDR_VAL&t;0x00060000UL /* bit 17,18 on */
r_static
r_void
op_star
DECL|function|sba_alloc_pdir
id|sba_alloc_pdir
c_func
(paren
r_int
r_int
id|pdir_size
)paren
(brace
r_int
r_int
id|pdir_base
suffix:semicolon
r_int
r_int
id|pdir_order
op_assign
id|get_order
c_func
(paren
id|pdir_size
)paren
suffix:semicolon
id|pdir_base
op_assign
id|__get_free_pages
c_func
(paren
id|GFP_KERNEL
comma
id|pdir_order
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_eq
(paren
r_void
op_star
)paren
id|pdir_base
)paren
id|panic
c_func
(paren
l_string|&quot;sba_ioc_init() could not allocate I/O Page Table&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* If this is not PA8700 (PCX-W2)&n;&t;**&t;OR newer than ver 2.2&n;&t;**&t;OR in a system that doesn&squot;t need VINDEX bits from SBA,&n;&t;**&n;&t;** then we aren&squot;t exposed to the HW bug.&n;&t;*/
r_if
c_cond
(paren
(paren
(paren
id|boot_cpu_data.pdc.cpuid
op_rshift
l_int|5
)paren
op_amp
l_int|0x7f
)paren
op_ne
l_int|0x13
op_logical_or
(paren
id|boot_cpu_data.pdc.versions
OG
l_int|0x202
)paren
op_logical_or
(paren
id|boot_cpu_data.pdc.capabilities
op_amp
l_int|0x08L
)paren
)paren
r_return
(paren
r_void
op_star
)paren
id|pdir_base
suffix:semicolon
multiline_comment|/*&n;&t; * PA8700 (PCX-W2, aka piranha) silent data corruption fix&n;&t; *&n;&t; * An interaction between PA8700 CPU (Ver 2.2 or older) and&n;&t; * Ike/Astro can cause silent data corruption. This is only&n;&t; * a problem if the I/O PDIR is located in memory such that&n;&t; * (little-endian)  bits 17 and 18 are on and bit 20 is off.&n;&t; *&n;&t; * Since the max IO Pdir size is 2MB, by cleverly allocating the&n;&t; * right physical address, we can either avoid (IOPDIR &lt;= 1MB)&n;&t; * or minimize (2MB IO Pdir) the problem if we restrict the&n;&t; * IO Pdir to a maximum size of 2MB-128K (1902K).&n;&t; *&n;&t; * Because we always allocate 2^N sized IO pdirs, either of the&n;&t; * &quot;bad&quot; regions will be the last 128K if at all. That&squot;s easy&n;&t; * to test for.&n;&t; * &n;&t; */
r_if
c_cond
(paren
id|pdir_order
op_le
(paren
l_int|19
op_minus
l_int|12
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
(paren
id|virt_to_phys
c_func
(paren
id|pdir_base
)paren
op_plus
id|pdir_size
op_minus
l_int|1
)paren
op_amp
id|PIRANHA_ADDR_MASK
)paren
op_eq
id|PIRANHA_ADDR_VAL
)paren
(brace
multiline_comment|/* allocate a new one on 512k alignment */
r_int
r_int
id|new_pdir
op_assign
id|__get_free_pages
c_func
(paren
id|GFP_KERNEL
comma
(paren
l_int|19
op_minus
l_int|12
)paren
)paren
suffix:semicolon
multiline_comment|/* release original */
id|free_pages
c_func
(paren
id|pdir_base
comma
id|pdir_order
)paren
suffix:semicolon
id|pdir_base
op_assign
id|new_pdir
suffix:semicolon
multiline_comment|/* release excess */
r_while
c_loop
(paren
id|pdir_order
OL
(paren
l_int|19
op_minus
l_int|12
)paren
)paren
(brace
id|new_pdir
op_add_assign
id|pdir_size
suffix:semicolon
id|free_pages
c_func
(paren
id|new_pdir
comma
id|pdir_order
)paren
suffix:semicolon
id|pdir_order
op_add_assign
l_int|1
suffix:semicolon
id|pdir_size
op_lshift_assign
l_int|1
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t;** 1MB or 2MB Pdir&n;&t;&t;** Needs to be aligned on an &quot;odd&quot; 1MB boundary.&n;&t;&t;*/
r_int
r_int
id|new_pdir
op_assign
id|__get_free_pages
c_func
(paren
id|GFP_KERNEL
comma
id|pdir_order
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* 2 or 4MB */
multiline_comment|/* release original */
id|free_pages
c_func
(paren
id|pdir_base
comma
id|pdir_order
)paren
suffix:semicolon
multiline_comment|/* release first 1MB */
id|free_pages
c_func
(paren
id|new_pdir
comma
l_int|20
op_minus
l_int|12
)paren
suffix:semicolon
id|pdir_base
op_assign
id|new_pdir
op_plus
l_int|1024
op_star
l_int|1024
suffix:semicolon
r_if
c_cond
(paren
id|pdir_order
OG
(paren
l_int|20
op_minus
l_int|12
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t;&t;** 2MB Pdir.&n;&t;&t;&t;**&n;&t;&t;&t;** Flag tells init_bitmap() to mark bad 128k as used&n;&t;&t;&t;** and to reduce the size by 128k.&n;&t;&t;&t;*/
id|piranha_bad_128k
op_assign
l_int|1
suffix:semicolon
id|new_pdir
op_add_assign
l_int|3
op_star
l_int|1024
op_star
l_int|1024
suffix:semicolon
multiline_comment|/* release last 1MB */
id|free_pages
c_func
(paren
id|new_pdir
comma
l_int|20
op_minus
l_int|12
)paren
suffix:semicolon
multiline_comment|/* release unusable 128KB */
id|free_pages
c_func
(paren
id|new_pdir
op_minus
l_int|128
op_star
l_int|1024
comma
l_int|17
op_minus
l_int|12
)paren
suffix:semicolon
id|pdir_size
op_sub_assign
l_int|128
op_star
l_int|1024
suffix:semicolon
)brace
)brace
id|memset
c_func
(paren
(paren
r_void
op_star
)paren
id|pdir_base
comma
l_int|0
comma
id|pdir_size
)paren
suffix:semicolon
r_return
(paren
r_void
op_star
)paren
id|pdir_base
suffix:semicolon
)brace
r_static
r_void
DECL|function|sba_ioc_init_pluto
id|sba_ioc_init_pluto
c_func
(paren
r_struct
id|parisc_device
op_star
id|sba
comma
r_struct
id|ioc
op_star
id|ioc
comma
r_int
id|ioc_num
)paren
(brace
multiline_comment|/* lba_set_iregs() is in arch/parisc/kernel/lba_pci.c */
r_extern
r_void
id|lba_set_iregs
c_func
(paren
r_struct
id|parisc_device
op_star
comma
id|u32
comma
id|u32
)paren
suffix:semicolon
id|u32
id|iova_space_mask
suffix:semicolon
id|u32
id|iova_space_size
suffix:semicolon
r_int
id|iov_order
comma
id|tcnfg
suffix:semicolon
r_struct
id|parisc_device
op_star
id|lba
suffix:semicolon
macro_line|#if SBA_AGP_SUPPORT
r_int
id|agp_found
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;&t;** Firmware programs the base and size of a &quot;safe IOVA space&quot;&n;&t;** (one that doesn&squot;t overlap memory or LMMIO space) in the&n;&t;** IBASE and IMASK registers.&n;&t;*/
id|ioc-&gt;ibase
op_assign
id|READ_REG
c_func
(paren
id|ioc-&gt;ioc_hpa
op_plus
id|IOC_IBASE
)paren
suffix:semicolon
id|iova_space_size
op_assign
op_complement
(paren
id|READ_REG
c_func
(paren
id|ioc-&gt;ioc_hpa
op_plus
id|IOC_IMASK
)paren
op_amp
l_int|0xFFFFFFFFUL
)paren
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ioc-&gt;ibase
OL
l_int|0xfed00000UL
)paren
op_logical_and
(paren
(paren
id|ioc-&gt;ibase
op_plus
id|iova_space_size
)paren
OG
l_int|0xfee00000UL
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;WARNING: IOV space overlaps local config and interrupt message, truncating&bslash;n&quot;
)paren
suffix:semicolon
id|iova_space_size
op_div_assign
l_int|2
suffix:semicolon
)brace
multiline_comment|/*&n;&t;** iov_order is always based on a 1GB IOVA space since we want to&n;&t;** turn on the other half for AGP GART.&n;&t;*/
id|iov_order
op_assign
id|get_order
c_func
(paren
id|iova_space_size
op_rshift
(paren
id|IOVP_SHIFT
op_minus
id|PAGE_SHIFT
)paren
)paren
suffix:semicolon
id|ioc-&gt;pdir_size
op_assign
(paren
id|iova_space_size
op_div
id|IOVP_SIZE
)paren
op_star
r_sizeof
(paren
id|u64
)paren
suffix:semicolon
id|DBG_INIT
c_func
(paren
l_string|&quot;%s() hpa 0x%lx IOV %dMB (%d bits)&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|ioc-&gt;ioc_hpa
comma
id|iova_space_size
op_rshift
l_int|20
comma
id|iov_order
op_plus
id|PAGE_SHIFT
)paren
suffix:semicolon
id|ioc-&gt;pdir_base
op_assign
(paren
r_void
op_star
)paren
id|__get_free_pages
c_func
(paren
id|GFP_KERNEL
comma
id|get_order
c_func
(paren
id|ioc-&gt;pdir_size
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ioc-&gt;pdir_base
)paren
id|panic
c_func
(paren
l_string|&quot;Couldn&squot;t allocate I/O Page Table&bslash;n&quot;
)paren
suffix:semicolon
id|memset
c_func
(paren
id|ioc-&gt;pdir_base
comma
l_int|0
comma
id|ioc-&gt;pdir_size
)paren
suffix:semicolon
id|DBG_INIT
c_func
(paren
l_string|&quot;%s() pdir %p size %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|ioc-&gt;pdir_base
comma
id|ioc-&gt;pdir_size
)paren
suffix:semicolon
macro_line|#if SBA_HINT_SUPPORT
id|ioc-&gt;hint_shift_pdir
op_assign
id|iov_order
op_plus
id|PAGE_SHIFT
suffix:semicolon
id|ioc-&gt;hint_mask_pdir
op_assign
op_complement
(paren
l_int|0x3
op_lshift
(paren
id|iov_order
op_plus
id|PAGE_SHIFT
)paren
)paren
suffix:semicolon
id|DBG_INIT
c_func
(paren
l_string|&quot;&t;hint_shift_pdir %x hint_mask_pdir %lx&bslash;n&quot;
comma
id|ioc-&gt;hint_shift_pdir
comma
id|ioc-&gt;hint_mask_pdir
)paren
suffix:semicolon
macro_line|#endif
id|ASSERT
c_func
(paren
(paren
(paren
(paren
r_int
r_int
)paren
id|ioc-&gt;pdir_base
)paren
op_amp
id|PAGE_MASK
)paren
op_eq
(paren
r_int
r_int
)paren
id|ioc-&gt;pdir_base
)paren
suffix:semicolon
id|WRITE_REG
c_func
(paren
id|virt_to_phys
c_func
(paren
id|ioc-&gt;pdir_base
)paren
comma
id|ioc-&gt;ioc_hpa
op_plus
id|IOC_PDIR_BASE
)paren
suffix:semicolon
multiline_comment|/* build IMASK for IOC and Elroy */
id|iova_space_mask
op_assign
l_int|0xffffffff
suffix:semicolon
id|iova_space_mask
op_lshift_assign
(paren
id|iov_order
op_plus
id|PAGE_SHIFT
)paren
suffix:semicolon
id|ioc-&gt;imask
op_assign
id|iova_space_mask
suffix:semicolon
macro_line|#ifdef ZX1_SUPPORT
id|ioc-&gt;iovp_mask
op_assign
op_complement
(paren
id|iova_space_mask
op_plus
id|PAGE_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
macro_line|#endif
id|sba_dump_tlb
c_func
(paren
id|ioc-&gt;ioc_hpa
)paren
suffix:semicolon
multiline_comment|/*&n;&t;** setup Mercury IBASE/IMASK registers as well.&n;&t;*/
r_for
c_loop
(paren
id|lba
op_assign
id|sba-&gt;child
suffix:semicolon
id|lba
suffix:semicolon
id|lba
op_assign
id|lba-&gt;sibling
)paren
(brace
r_int
id|rope_num
op_assign
(paren
id|lba-&gt;hpa
op_rshift
l_int|13
)paren
op_amp
l_int|0xf
suffix:semicolon
r_if
c_cond
(paren
id|rope_num
op_rshift
l_int|3
op_eq
id|ioc_num
)paren
id|lba_set_iregs
c_func
(paren
id|lba
comma
id|ioc-&gt;ibase
comma
id|ioc-&gt;imask
)paren
suffix:semicolon
)brace
id|WRITE_REG
c_func
(paren
id|ioc-&gt;imask
comma
id|ioc-&gt;ioc_hpa
op_plus
id|IOC_IMASK
)paren
suffix:semicolon
macro_line|#ifdef __LP64__
multiline_comment|/*&n;&t;** Setting the upper bits makes checking for bypass addresses&n;&t;** a little faster later on.&n;&t;*/
id|ioc-&gt;imask
op_or_assign
l_int|0xFFFFFFFF00000000UL
suffix:semicolon
macro_line|#endif
multiline_comment|/* Set I/O PDIR Page size to system page size */
r_switch
c_cond
(paren
id|PAGE_SHIFT
)paren
(brace
r_case
l_int|12
suffix:colon
id|tcnfg
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/*  4K */
r_case
l_int|13
suffix:colon
id|tcnfg
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/*  8K */
r_case
l_int|14
suffix:colon
id|tcnfg
op_assign
l_int|2
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* 16K */
r_case
l_int|16
suffix:colon
id|tcnfg
op_assign
l_int|3
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* 64K */
r_default
suffix:colon
id|panic
c_func
(paren
id|__FILE__
l_string|&quot;Unsupported system page size %d&quot;
comma
l_int|1
op_lshift
id|PAGE_SHIFT
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|WRITE_REG
c_func
(paren
id|tcnfg
comma
id|ioc-&gt;ioc_hpa
op_plus
id|IOC_TCNFG
)paren
suffix:semicolon
multiline_comment|/*&n;&t;** Program the IOC&squot;s ibase and enable IOVA translation&n;&t;** Bit zero == enable bit.&n;&t;*/
id|WRITE_REG
c_func
(paren
id|ioc-&gt;ibase
op_or
l_int|1
comma
id|ioc-&gt;ioc_hpa
op_plus
id|IOC_IBASE
)paren
suffix:semicolon
multiline_comment|/*&n;&t;** Clear I/O TLB of any possible entries.&n;&t;** (Yes. This is a bit paranoid...but so what)&n;&t;*/
id|WRITE_REG
c_func
(paren
id|ioc-&gt;ibase
op_or
l_int|31
comma
id|ioc-&gt;ioc_hpa
op_plus
id|IOC_PCOM
)paren
suffix:semicolon
macro_line|#if SBA_AGP_SUPPORT
multiline_comment|/*&n;&t;** If an AGP device is present, only use half of the IOV space&n;&t;** for PCI DMA.  Unfortunately we can&squot;t know ahead of time&n;&t;** whether GART support will actually be used, for now we&n;&t;** can just key on any AGP device found in the system.&n;&t;** We program the next pdir index after we stop w/ a key for&n;&t;** the GART code to handshake on.&n;&t;*/
id|device
op_assign
l_int|NULL
suffix:semicolon
r_for
c_loop
(paren
id|lba
op_assign
id|sba-&gt;child
suffix:semicolon
id|lba
suffix:semicolon
id|lba
op_assign
id|lba-&gt;sibling
)paren
(brace
r_if
c_cond
(paren
id|IS_QUICKSILVER
c_func
(paren
id|lba
)paren
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|lba
)paren
(brace
id|DBG_INIT
c_func
(paren
l_string|&quot;%s: Reserving half of IOVA space for AGP GART support&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|ioc-&gt;pdir_size
op_div_assign
l_int|2
suffix:semicolon
(paren
(paren
id|u64
op_star
)paren
id|ioc-&gt;pdir_base
)paren
(braket
id|PDIR_INDEX
c_func
(paren
id|iova_space_size
op_div
l_int|2
)paren
)braket
op_assign
id|SBA_IOMMU_COOKIE
suffix:semicolon
)brace
r_else
(brace
id|DBG_INIT
c_func
(paren
l_string|&quot;%s: No GART needed - no AGP controller found&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
)brace
macro_line|#endif /* 0 */
)brace
r_static
r_void
DECL|function|sba_ioc_init
id|sba_ioc_init
c_func
(paren
r_struct
id|parisc_device
op_star
id|sba
comma
r_struct
id|ioc
op_star
id|ioc
comma
r_int
id|ioc_num
)paren
(brace
multiline_comment|/* lba_set_iregs() is in arch/parisc/kernel/lba_pci.c */
r_extern
r_void
id|lba_set_iregs
c_func
(paren
r_struct
id|parisc_device
op_star
comma
id|u32
comma
id|u32
)paren
suffix:semicolon
id|u32
id|iova_space_size
comma
id|iova_space_mask
suffix:semicolon
r_int
id|pdir_size
comma
id|iov_order
suffix:semicolon
r_int
r_int
id|physmem
suffix:semicolon
r_struct
id|parisc_device
op_star
id|lba
suffix:semicolon
multiline_comment|/*&n;&t;** Determine IOVA Space size from memory size.&n;&t;**&n;&t;** Ideally, PCI drivers would register the maximum number&n;&t;** of DMA they can have outstanding for each device they&n;&t;** own.  Next best thing would be to guess how much DMA&n;&t;** can be outstanding based on PCI Class/sub-class. Both&n;&t;** methods still require some &quot;extra&quot; to support PCI&n;&t;** Hot-Plug/Removal of PCI cards. (aka PCI OLARD).&n;&t;**&n;&t;** While we have 32-bits &quot;IOVA&quot; space, top two 2 bits are used&n;&t;** for DMA hints - ergo only 30 bits max.&n;&t;*/
id|physmem
op_assign
id|num_physpages
op_lshift
id|PAGE_SHIFT
suffix:semicolon
id|iova_space_size
op_assign
(paren
id|u32
)paren
(paren
id|physmem
op_div
(paren
id|sba_mem_ratio
op_star
id|global_ioc_cnt
)paren
)paren
suffix:semicolon
multiline_comment|/* limit IOVA space size to 1MB-1GB */
r_if
c_cond
(paren
id|iova_space_size
OL
l_int|1024
op_star
l_int|1024
)paren
(brace
id|iova_space_size
op_assign
l_int|1024
op_star
l_int|1024
suffix:semicolon
)brace
macro_line|#ifdef __LP64__
r_else
r_if
c_cond
(paren
id|iova_space_size
OG
l_int|512
op_star
l_int|1024
op_star
l_int|1024
)paren
(brace
id|iova_space_size
op_assign
l_int|512
op_star
l_int|1024
op_star
l_int|1024
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n;&t;** iova space must be log2() in size.&n;&t;** thus, pdir/res_map will also be log2().&n;&t;** PIRANHA BUG: Exception is when IO Pdir is 2MB (gets reduced)&n;&t;*/
id|iov_order
op_assign
id|get_order
c_func
(paren
id|iova_space_size
op_rshift
(paren
id|IOVP_SHIFT
op_minus
id|PAGE_SHIFT
)paren
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|iov_order
op_le
(paren
l_int|30
op_minus
id|IOVP_SHIFT
)paren
)paren
suffix:semicolon
multiline_comment|/* iova_space_size &lt;= 1GB */
id|ASSERT
c_func
(paren
id|iov_order
op_ge
(paren
l_int|20
op_minus
id|IOVP_SHIFT
)paren
)paren
suffix:semicolon
multiline_comment|/* iova_space_size &gt;= 1MB */
id|iova_space_size
op_assign
l_int|1
op_lshift
(paren
id|iov_order
op_plus
id|IOVP_SHIFT
)paren
suffix:semicolon
id|ioc-&gt;pdir_size
op_assign
id|pdir_size
op_assign
(paren
id|iova_space_size
op_div
id|IOVP_SIZE
)paren
op_star
r_sizeof
(paren
id|u64
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|pdir_size
OL
l_int|4
op_star
l_int|1024
op_star
l_int|1024
)paren
suffix:semicolon
multiline_comment|/* max pdir size == 2MB */
multiline_comment|/* Verify it&squot;s a power of two */
id|ASSERT
c_func
(paren
(paren
l_int|1
op_lshift
id|get_order
c_func
(paren
id|pdir_size
)paren
)paren
op_eq
(paren
id|pdir_size
op_rshift
id|PAGE_SHIFT
)paren
)paren
suffix:semicolon
id|DBG_INIT
c_func
(paren
l_string|&quot;%s() hpa 0x%lx mem %dMB IOV %dMB (%d bits) PDIR size 0x%0x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|ioc-&gt;ioc_hpa
comma
(paren
r_int
)paren
(paren
id|physmem
op_rshift
l_int|20
)paren
comma
id|iova_space_size
op_rshift
l_int|20
comma
id|iov_order
op_plus
id|PAGE_SHIFT
comma
id|pdir_size
)paren
suffix:semicolon
id|ioc-&gt;pdir_base
op_assign
id|sba_alloc_pdir
c_func
(paren
id|pdir_size
)paren
suffix:semicolon
id|DBG_INIT
c_func
(paren
l_string|&quot;%s() pdir %p size %x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|ioc-&gt;pdir_base
comma
id|pdir_size
)paren
suffix:semicolon
macro_line|#if SBA_HINT_SUPPORT
multiline_comment|/* FIXME : DMA HINTs not used */
id|ioc-&gt;hint_shift_pdir
op_assign
id|iov_order
op_plus
id|PAGE_SHIFT
suffix:semicolon
id|ioc-&gt;hint_mask_pdir
op_assign
op_complement
(paren
l_int|0x3
op_lshift
(paren
id|iov_order
op_plus
id|PAGE_SHIFT
)paren
)paren
suffix:semicolon
id|DBG_INIT
c_func
(paren
l_string|&quot;&t;hint_shift_pdir %x hint_mask_pdir %lx&bslash;n&quot;
comma
id|ioc-&gt;hint_shift_pdir
comma
id|ioc-&gt;hint_mask_pdir
)paren
suffix:semicolon
macro_line|#endif
id|ASSERT
c_func
(paren
(paren
(paren
(paren
r_int
r_int
)paren
id|ioc-&gt;pdir_base
)paren
op_amp
id|PAGE_MASK
)paren
op_eq
(paren
r_int
r_int
)paren
id|ioc-&gt;pdir_base
)paren
suffix:semicolon
id|WRITE_REG64
c_func
(paren
id|virt_to_phys
c_func
(paren
id|ioc-&gt;pdir_base
)paren
comma
id|ioc-&gt;ioc_hpa
op_plus
id|IOC_PDIR_BASE
)paren
suffix:semicolon
multiline_comment|/* build IMASK for IOC and Elroy */
id|iova_space_mask
op_assign
l_int|0xffffffff
suffix:semicolon
id|iova_space_mask
op_lshift_assign
(paren
id|iov_order
op_plus
id|PAGE_SHIFT
)paren
suffix:semicolon
multiline_comment|/*&n;&t;** On C3000 w/512MB mem, HP-UX 10.20 reports:&n;&t;**     ibase=0, imask=0xFE000000, size=0x2000000.&n;&t;*/
id|ioc-&gt;ibase
op_assign
l_int|0
suffix:semicolon
id|ioc-&gt;imask
op_assign
id|iova_space_mask
suffix:semicolon
multiline_comment|/* save it */
macro_line|#ifdef ZX1_SUPPORT
id|ioc-&gt;iovp_mask
op_assign
op_complement
(paren
id|iova_space_mask
op_plus
id|PAGE_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
macro_line|#endif
id|DBG_INIT
c_func
(paren
l_string|&quot;%s() IOV base 0x%lx mask 0x%0lx&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|ioc-&gt;ibase
comma
id|ioc-&gt;imask
)paren
suffix:semicolon
multiline_comment|/*&n;&t;** FIXME: Hint registers are programmed with default hint&n;&t;** values during boot, so hints should be sane even if we&n;&t;** can&squot;t reprogram them the way drivers want.&n;&t;*/
multiline_comment|/*&n;&t;** setup Elroy IBASE/IMASK registers as well.&n;&t;*/
r_for
c_loop
(paren
id|lba
op_assign
id|sba-&gt;child
suffix:semicolon
id|lba
suffix:semicolon
id|lba
op_assign
id|lba-&gt;sibling
)paren
(brace
r_int
id|rope_num
op_assign
(paren
id|lba-&gt;hpa
op_rshift
l_int|13
)paren
op_amp
l_int|0xf
suffix:semicolon
r_if
c_cond
(paren
id|rope_num
op_rshift
l_int|3
op_eq
id|ioc_num
)paren
id|lba_set_iregs
c_func
(paren
id|lba
comma
id|ioc-&gt;ibase
comma
id|ioc-&gt;imask
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t;** Program the IOC&squot;s ibase and enable IOVA translation&n;&t;*/
id|WRITE_REG
c_func
(paren
id|ioc-&gt;ibase
op_or
l_int|1
comma
id|ioc-&gt;ioc_hpa
op_plus
id|IOC_IBASE
)paren
suffix:semicolon
id|WRITE_REG
c_func
(paren
id|ioc-&gt;imask
comma
id|ioc-&gt;ioc_hpa
op_plus
id|IOC_IMASK
)paren
suffix:semicolon
multiline_comment|/* Set I/O PDIR Page size to 4K */
id|WRITE_REG
c_func
(paren
l_int|0
comma
id|ioc-&gt;ioc_hpa
op_plus
id|IOC_TCNFG
)paren
suffix:semicolon
multiline_comment|/*&n;&t;** Clear I/O TLB of any possible entries.&n;&t;** (Yes. This is a bit paranoid...but so what)&n;&t;*/
id|WRITE_REG
c_func
(paren
l_int|0
op_or
l_int|31
comma
id|ioc-&gt;ioc_hpa
op_plus
id|IOC_PCOM
)paren
suffix:semicolon
id|ioc-&gt;ibase
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* used by SBA_IOVA and related macros */
id|DBG_INIT
c_func
(paren
l_string|&quot;%s() DONE&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
)brace
multiline_comment|/**************************************************************************&n;**&n;**   SBA initialization code (HW and SW)&n;**&n;**   o identify SBA chip itself&n;**   o initialize SBA chip modes (HardFail)&n;**   o initialize SBA chip modes (HardFail)&n;**   o FIXME: initialize DMA hints for reasonable defaults&n;**&n;**************************************************************************/
r_static
r_void
DECL|function|sba_hw_init
id|sba_hw_init
c_func
(paren
r_struct
id|sba_device
op_star
id|sba_dev
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|num_ioc
suffix:semicolon
id|u64
id|ioc_ctl
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|is_pdc_pat
c_func
(paren
)paren
)paren
(brace
multiline_comment|/* Shutdown the USB controller on Astro-based workstations.&n;&t;&t;** Once we reprogram the IOMMU, the next DMA performed by&n;&t;&t;** USB will HPMC the box.&n;&t;&t;*/
id|pdc_io_reset_devices
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;** XXX May need something more sophisticated to deal&n;&t;&t;**     with DMA from LAN. Maybe use page zero boot device&n;&t;&t;**     as a handle to talk to PDC about which device to&n;&t;&t;**     shutdown. This also needs to work for is_pdc_pat(). &n;&t;&t;*/
)brace
r_if
c_cond
(paren
op_logical_neg
id|IS_PLUTO
c_func
(paren
id|sba_dev-&gt;iodc
)paren
)paren
(brace
id|ioc_ctl
op_assign
id|READ_REG
c_func
(paren
id|sba_dev-&gt;sba_hpa
op_plus
id|IOC_CTRL
)paren
suffix:semicolon
id|DBG_INIT
c_func
(paren
l_string|&quot;%s() hpa 0x%lx ioc_ctl 0x%Lx -&gt;&quot;
comma
id|__FUNCTION__
comma
id|sba_dev-&gt;sba_hpa
comma
id|ioc_ctl
)paren
suffix:semicolon
id|ioc_ctl
op_and_assign
op_complement
(paren
id|IOC_CTRL_RM
op_or
id|IOC_CTRL_NC
op_or
id|IOC_CTRL_CE
)paren
suffix:semicolon
id|ioc_ctl
op_or_assign
id|IOC_CTRL_TC
suffix:semicolon
multiline_comment|/* Astro: firmware enables this */
id|WRITE_REG
c_func
(paren
id|ioc_ctl
comma
id|sba_dev-&gt;sba_hpa
op_plus
id|IOC_CTRL
)paren
suffix:semicolon
macro_line|#ifdef DEBUG_SBA_INIT
id|ioc_ctl
op_assign
id|READ_REG64
c_func
(paren
id|sba_dev-&gt;sba_hpa
op_plus
id|IOC_CTRL
)paren
suffix:semicolon
id|DBG_INIT
c_func
(paren
l_string|&quot; 0x%Lx&bslash;n&quot;
comma
id|ioc_ctl
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/* if !PLUTO */
r_if
c_cond
(paren
id|IS_ASTRO
c_func
(paren
id|sba_dev-&gt;iodc
)paren
)paren
(brace
r_int
id|err
suffix:semicolon
multiline_comment|/* PAT_PDC (L-class) also reports the same goofy base */
id|sba_dev-&gt;ioc
(braket
l_int|0
)braket
dot
id|ioc_hpa
op_assign
id|ASTRO_IOC_OFFSET
suffix:semicolon
id|num_ioc
op_assign
l_int|1
suffix:semicolon
id|sba_dev-&gt;chip_resv.name
op_assign
l_string|&quot;Astro Intr Ack&quot;
suffix:semicolon
id|sba_dev-&gt;chip_resv.start
op_assign
id|PCI_F_EXTEND
op_or
l_int|0xfef00000UL
suffix:semicolon
id|sba_dev-&gt;chip_resv.end
op_assign
id|PCI_F_EXTEND
op_or
(paren
l_int|0xff000000UL
op_minus
l_int|1
)paren
suffix:semicolon
id|err
op_assign
id|request_resource
c_func
(paren
op_amp
id|iomem_resource
comma
op_amp
(paren
id|sba_dev-&gt;chip_resv
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
id|BUG
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|IS_PLUTO
c_func
(paren
id|sba_dev-&gt;iodc
)paren
)paren
(brace
r_int
id|err
suffix:semicolon
multiline_comment|/* We use a negative value for IOC HPA so it gets &n;                 * corrected when we add it with IKE&squot;s IOC offset.&n;&t;&t; * Doesnt look clean, but fewer code. &n;                 */
id|sba_dev-&gt;ioc
(braket
l_int|0
)braket
dot
id|ioc_hpa
op_assign
op_minus
id|PLUTO_IOC_OFFSET
suffix:semicolon
id|num_ioc
op_assign
l_int|1
suffix:semicolon
id|sba_dev-&gt;chip_resv.name
op_assign
l_string|&quot;Pluto Intr/PIOP/VGA&quot;
suffix:semicolon
id|sba_dev-&gt;chip_resv.start
op_assign
id|PCI_F_EXTEND
op_or
l_int|0xfee00000UL
suffix:semicolon
id|sba_dev-&gt;chip_resv.end
op_assign
id|PCI_F_EXTEND
op_or
(paren
l_int|0xff200000UL
op_minus
l_int|1
)paren
suffix:semicolon
id|err
op_assign
id|request_resource
c_func
(paren
op_amp
id|iomem_resource
comma
op_amp
(paren
id|sba_dev-&gt;chip_resv
)paren
)paren
suffix:semicolon
id|BUG_ON
c_func
(paren
id|err
OL
l_int|0
)paren
suffix:semicolon
id|sba_dev-&gt;iommu_resv.name
op_assign
l_string|&quot;IOVA Space&quot;
suffix:semicolon
id|sba_dev-&gt;iommu_resv.start
op_assign
l_int|0x40000000UL
suffix:semicolon
id|sba_dev-&gt;iommu_resv.end
op_assign
l_int|0x50000000UL
op_minus
l_int|1
suffix:semicolon
id|err
op_assign
id|request_resource
c_func
(paren
op_amp
id|iomem_resource
comma
op_amp
(paren
id|sba_dev-&gt;iommu_resv
)paren
)paren
suffix:semicolon
id|BUG_ON
c_func
(paren
id|err
OL
l_int|0
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* IS_IKE (ie N-class, L3000, L1500) */
id|sba_dev-&gt;ioc
(braket
l_int|0
)braket
dot
id|ioc_hpa
op_assign
id|sba_dev-&gt;ioc
(braket
l_int|1
)braket
dot
id|ioc_hpa
op_assign
l_int|0
suffix:semicolon
id|num_ioc
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* TODO - LOOKUP Ike/Stretch chipset mem map */
)brace
id|sba_dev-&gt;num_ioc
op_assign
id|num_ioc
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_ioc
suffix:semicolon
id|i
op_increment
)paren
(brace
id|sba_dev-&gt;ioc
(braket
id|i
)braket
dot
id|ioc_hpa
op_add_assign
id|sba_dev-&gt;sba_hpa
op_plus
id|IKE_IOC_OFFSET
c_func
(paren
id|i
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;** Make sure the box crashes if we get any errors on a rope.&n;&t;&t;*/
id|WRITE_REG
c_func
(paren
id|HF_ENABLE
comma
id|sba_dev-&gt;ioc
(braket
id|i
)braket
dot
id|ioc_hpa
op_plus
id|ROPE0_CTL
)paren
suffix:semicolon
id|WRITE_REG
c_func
(paren
id|HF_ENABLE
comma
id|sba_dev-&gt;ioc
(braket
id|i
)braket
dot
id|ioc_hpa
op_plus
id|ROPE1_CTL
)paren
suffix:semicolon
id|WRITE_REG
c_func
(paren
id|HF_ENABLE
comma
id|sba_dev-&gt;ioc
(braket
id|i
)braket
dot
id|ioc_hpa
op_plus
id|ROPE2_CTL
)paren
suffix:semicolon
id|WRITE_REG
c_func
(paren
id|HF_ENABLE
comma
id|sba_dev-&gt;ioc
(braket
id|i
)braket
dot
id|ioc_hpa
op_plus
id|ROPE3_CTL
)paren
suffix:semicolon
id|WRITE_REG
c_func
(paren
id|HF_ENABLE
comma
id|sba_dev-&gt;ioc
(braket
id|i
)braket
dot
id|ioc_hpa
op_plus
id|ROPE4_CTL
)paren
suffix:semicolon
id|WRITE_REG
c_func
(paren
id|HF_ENABLE
comma
id|sba_dev-&gt;ioc
(braket
id|i
)braket
dot
id|ioc_hpa
op_plus
id|ROPE5_CTL
)paren
suffix:semicolon
id|WRITE_REG
c_func
(paren
id|HF_ENABLE
comma
id|sba_dev-&gt;ioc
(braket
id|i
)braket
dot
id|ioc_hpa
op_plus
id|ROPE6_CTL
)paren
suffix:semicolon
id|WRITE_REG
c_func
(paren
id|HF_ENABLE
comma
id|sba_dev-&gt;ioc
(braket
id|i
)braket
dot
id|ioc_hpa
op_plus
id|ROPE7_CTL
)paren
suffix:semicolon
multiline_comment|/* flush out the writes */
id|READ_REG
c_func
(paren
id|sba_dev-&gt;ioc
(braket
id|i
)braket
dot
id|ioc_hpa
op_plus
id|ROPE7_CTL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_PLUTO
c_func
(paren
id|sba_dev-&gt;iodc
)paren
)paren
(brace
id|sba_ioc_init_pluto
c_func
(paren
id|sba_dev-&gt;dev
comma
op_amp
(paren
id|sba_dev-&gt;ioc
(braket
id|i
)braket
)paren
comma
id|i
)paren
suffix:semicolon
)brace
r_else
(brace
id|sba_ioc_init
c_func
(paren
id|sba_dev-&gt;dev
comma
op_amp
(paren
id|sba_dev-&gt;ioc
(braket
id|i
)braket
)paren
comma
id|i
)paren
suffix:semicolon
)brace
)brace
)brace
r_static
r_void
DECL|function|sba_common_init
id|sba_common_init
c_func
(paren
r_struct
id|sba_device
op_star
id|sba_dev
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/* add this one to the head of the list (order doesn&squot;t matter)&n;&t;** This will be useful for debugging - especially if we get coredumps&n;&t;*/
id|sba_dev-&gt;next
op_assign
id|sba_list
suffix:semicolon
id|sba_list
op_assign
id|sba_dev
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|sba_dev-&gt;num_ioc
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
id|res_size
suffix:semicolon
macro_line|#ifdef DEBUG_DMB_TRAP
r_extern
r_void
id|iterate_pages
c_func
(paren
r_int
r_int
comma
r_int
r_int
comma
r_void
(paren
op_star
)paren
(paren
id|pte_t
op_star
comma
r_int
r_int
)paren
comma
r_int
r_int
)paren
suffix:semicolon
r_void
id|set_data_memory_break
c_func
(paren
id|pte_t
op_star
comma
r_int
r_int
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* resource map size dictated by pdir_size */
id|res_size
op_assign
id|sba_dev-&gt;ioc
(braket
id|i
)braket
dot
id|pdir_size
op_div
r_sizeof
(paren
id|u64
)paren
suffix:semicolon
multiline_comment|/* entries */
multiline_comment|/* Second part of PIRANHA BUG */
r_if
c_cond
(paren
id|piranha_bad_128k
)paren
(brace
id|res_size
op_sub_assign
(paren
l_int|128
op_star
l_int|1024
)paren
op_div
r_sizeof
(paren
id|u64
)paren
suffix:semicolon
)brace
id|res_size
op_rshift_assign
l_int|3
suffix:semicolon
multiline_comment|/* convert bit count to byte count */
id|DBG_INIT
c_func
(paren
l_string|&quot;%s() res_size 0x%x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|res_size
)paren
suffix:semicolon
id|sba_dev-&gt;ioc
(braket
id|i
)braket
dot
id|res_size
op_assign
id|res_size
suffix:semicolon
id|sba_dev-&gt;ioc
(braket
id|i
)braket
dot
id|res_map
op_assign
(paren
r_char
op_star
)paren
id|__get_free_pages
c_func
(paren
id|GFP_KERNEL
comma
id|get_order
c_func
(paren
id|res_size
)paren
)paren
suffix:semicolon
macro_line|#ifdef DEBUG_DMB_TRAP
id|iterate_pages
c_func
(paren
id|sba_dev-&gt;ioc
(braket
id|i
)braket
dot
id|res_map
comma
id|res_size
comma
id|set_data_memory_break
comma
l_int|0
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
l_int|NULL
op_eq
id|sba_dev-&gt;ioc
(braket
id|i
)braket
dot
id|res_map
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;%s:%s() could not allocate resource map&bslash;n&quot;
comma
id|__FILE__
comma
id|__FUNCTION__
)paren
suffix:semicolon
)brace
id|memset
c_func
(paren
id|sba_dev-&gt;ioc
(braket
id|i
)braket
dot
id|res_map
comma
l_int|0
comma
id|res_size
)paren
suffix:semicolon
multiline_comment|/* next available IOVP - circular search */
id|sba_dev-&gt;ioc
(braket
id|i
)braket
dot
id|res_hint
op_assign
(paren
r_int
r_int
op_star
)paren
op_amp
(paren
id|sba_dev-&gt;ioc
(braket
id|i
)braket
dot
id|res_map
(braket
id|L1_CACHE_BYTES
)braket
)paren
suffix:semicolon
macro_line|#ifdef ASSERT_PDIR_SANITY
multiline_comment|/* Mark first bit busy - ie no IOVA 0 */
id|sba_dev-&gt;ioc
(braket
id|i
)braket
dot
id|res_map
(braket
l_int|0
)braket
op_assign
l_int|0x80
suffix:semicolon
id|sba_dev-&gt;ioc
(braket
id|i
)braket
dot
id|pdir_base
(braket
l_int|0
)braket
op_assign
l_int|0xeeffc0addbba0080ULL
suffix:semicolon
macro_line|#endif
multiline_comment|/* Third (and last) part of PIRANHA BUG */
r_if
c_cond
(paren
id|piranha_bad_128k
)paren
(brace
multiline_comment|/* region from +1408K to +1536 is un-usable. */
r_int
id|idx_start
op_assign
(paren
l_int|1408
op_star
l_int|1024
op_div
r_sizeof
(paren
id|u64
)paren
)paren
op_rshift
l_int|3
suffix:semicolon
r_int
id|idx_end
op_assign
(paren
l_int|1536
op_star
l_int|1024
op_div
r_sizeof
(paren
id|u64
)paren
)paren
op_rshift
l_int|3
suffix:semicolon
r_int
op_star
id|p_start
op_assign
(paren
r_int
op_star
)paren
op_amp
(paren
id|sba_dev-&gt;ioc
(braket
id|i
)braket
dot
id|res_map
(braket
id|idx_start
)braket
)paren
suffix:semicolon
r_int
op_star
id|p_end
op_assign
(paren
r_int
op_star
)paren
op_amp
(paren
id|sba_dev-&gt;ioc
(braket
id|i
)braket
dot
id|res_map
(braket
id|idx_end
)braket
)paren
suffix:semicolon
multiline_comment|/* mark that part of the io pdir busy */
r_while
c_loop
(paren
id|p_start
OL
id|p_end
)paren
op_star
id|p_start
op_increment
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
macro_line|#ifdef DEBUG_DMB_TRAP
id|iterate_pages
c_func
(paren
id|sba_dev-&gt;ioc
(braket
id|i
)braket
dot
id|res_map
comma
id|res_size
comma
id|set_data_memory_break
comma
l_int|0
)paren
suffix:semicolon
id|iterate_pages
c_func
(paren
id|sba_dev-&gt;ioc
(braket
id|i
)braket
dot
id|pdir_base
comma
id|sba_dev-&gt;ioc
(braket
id|i
)braket
dot
id|pdir_size
comma
id|set_data_memory_break
comma
l_int|0
)paren
suffix:semicolon
macro_line|#endif
id|DBG_INIT
c_func
(paren
l_string|&quot;%s() %d res_map %x %p&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|i
comma
id|res_size
comma
id|sba_dev-&gt;ioc
(braket
id|i
)braket
dot
id|res_map
)paren
suffix:semicolon
)brace
id|sba_dev-&gt;sba_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
id|ioc_needs_fdc
op_assign
id|boot_cpu_data.pdc.capabilities
op_amp
id|PDC_MODEL_IOPDIR_FDC
suffix:semicolon
macro_line|#ifdef DEBUG_SBA_INIT
multiline_comment|/*&n;&t; * If the PDC_MODEL capabilities has Non-coherent IO-PDIR bit set&n;&t; * (bit #61, big endian), we have to flush and sync every time&n;&t; * IO-PDIR is changed in Ike/Astro.&n;&t; */
r_if
c_cond
(paren
id|boot_cpu_data.pdc.capabilities
op_amp
id|PDC_MODEL_IOPDIR_FDC
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
id|MODULE_NAME
l_string|&quot; FDC/SYNC required.&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_INFO
id|MODULE_NAME
l_string|&quot; IOC has cache coherent PDIR.&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
)brace
macro_line|#ifdef CONFIG_PROC_FS
DECL|function|sba_proc_info
r_static
r_int
id|sba_proc_info
c_func
(paren
r_char
op_star
id|buf
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|len
)paren
(brace
r_struct
id|sba_device
op_star
id|sba_dev
op_assign
id|sba_list
suffix:semicolon
r_struct
id|ioc
op_star
id|ioc
op_assign
op_amp
id|sba_dev-&gt;ioc
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/* FIXME: Multi-IOC support! */
r_int
id|total_pages
op_assign
(paren
r_int
)paren
(paren
id|ioc-&gt;res_size
op_lshift
l_int|3
)paren
suffix:semicolon
multiline_comment|/* 8 bits per byte */
r_int
r_int
id|i
suffix:semicolon
macro_line|#ifdef SBA_COLLECT_STATS
r_int
r_int
id|avg
op_assign
l_int|0
comma
id|min
comma
id|max
suffix:semicolon
macro_line|#endif
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%s rev %d.%d&bslash;n&quot;
comma
id|sba_dev-&gt;name
comma
(paren
id|sba_dev-&gt;hw_rev
op_amp
l_int|0x7
)paren
op_plus
l_int|1
comma
(paren
id|sba_dev-&gt;hw_rev
op_amp
l_int|0x18
)paren
op_rshift
l_int|3
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%sIO PDIR size    : %d bytes (%d entries)&bslash;n&quot;
comma
id|buf
comma
(paren
r_int
)paren
(paren
(paren
id|ioc-&gt;res_size
op_lshift
l_int|3
)paren
op_star
r_sizeof
(paren
id|u64
)paren
)paren
comma
multiline_comment|/* 8 bits/byte */
id|total_pages
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%sResource bitmap : %d bytes (%d pages)&bslash;n&quot;
comma
id|buf
comma
id|ioc-&gt;res_size
comma
id|ioc-&gt;res_size
op_lshift
l_int|3
)paren
suffix:semicolon
multiline_comment|/* 8 bits per byte */
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%sLMMIO_BASE/MASK/ROUTE %08x %08x %08x&bslash;n&quot;
comma
id|buf
comma
id|READ_REG32
c_func
(paren
id|sba_dev-&gt;sba_hpa
op_plus
id|LMMIO_DIST_BASE
)paren
comma
id|READ_REG32
c_func
(paren
id|sba_dev-&gt;sba_hpa
op_plus
id|LMMIO_DIST_MASK
)paren
comma
id|READ_REG32
c_func
(paren
id|sba_dev-&gt;sba_hpa
op_plus
id|LMMIO_DIST_ROUTE
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%sDIR%ld_BASE/MASK/ROUTE %08x %08x %08x&bslash;n&quot;
comma
id|buf
comma
id|i
comma
id|READ_REG32
c_func
(paren
id|sba_dev-&gt;sba_hpa
op_plus
id|LMMIO_DIRECT0_BASE
op_plus
id|i
op_star
l_int|0x18
)paren
comma
id|READ_REG32
c_func
(paren
id|sba_dev-&gt;sba_hpa
op_plus
id|LMMIO_DIRECT0_MASK
op_plus
id|i
op_star
l_int|0x18
)paren
comma
id|READ_REG32
c_func
(paren
id|sba_dev-&gt;sba_hpa
op_plus
id|LMMIO_DIRECT0_ROUTE
op_plus
id|i
op_star
l_int|0x18
)paren
)paren
suffix:semicolon
macro_line|#ifdef SBA_COLLECT_STATS
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%sIO PDIR entries : %ld free  %ld used (%d%%)&bslash;n&quot;
comma
id|buf
comma
id|total_pages
op_minus
id|ioc-&gt;used_pages
comma
id|ioc-&gt;used_pages
comma
(paren
r_int
)paren
(paren
id|ioc-&gt;used_pages
op_star
l_int|100
op_div
id|total_pages
)paren
)paren
suffix:semicolon
id|min
op_assign
id|max
op_assign
id|ioc-&gt;avg_search
(braket
l_int|0
)braket
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|SBA_SEARCH_SAMPLE
suffix:semicolon
id|i
op_increment
)paren
(brace
id|avg
op_add_assign
id|ioc-&gt;avg_search
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|ioc-&gt;avg_search
(braket
id|i
)braket
OG
id|max
)paren
id|max
op_assign
id|ioc-&gt;avg_search
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|ioc-&gt;avg_search
(braket
id|i
)braket
OL
id|min
)paren
id|min
op_assign
id|ioc-&gt;avg_search
(braket
id|i
)braket
suffix:semicolon
)brace
id|avg
op_div_assign
id|SBA_SEARCH_SAMPLE
suffix:semicolon
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%s  Bitmap search : %ld/%ld/%ld (min/avg/max CPU Cycles)&bslash;n&quot;
comma
id|buf
comma
id|min
comma
id|avg
comma
id|max
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%spci_map_single(): %12ld calls  %12ld pages (avg %d/1000)&bslash;n&quot;
comma
id|buf
comma
id|ioc-&gt;msingle_calls
comma
id|ioc-&gt;msingle_pages
comma
(paren
r_int
)paren
(paren
(paren
id|ioc-&gt;msingle_pages
op_star
l_int|1000
)paren
op_div
id|ioc-&gt;msingle_calls
)paren
)paren
suffix:semicolon
multiline_comment|/* KLUGE - unmap_sg calls unmap_single for each mapped page */
id|min
op_assign
id|ioc-&gt;usingle_calls
suffix:semicolon
id|max
op_assign
id|ioc-&gt;usingle_pages
op_minus
id|ioc-&gt;usg_pages
suffix:semicolon
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%spci_unmap_single: %12ld calls  %12ld pages (avg %d/1000)&bslash;n&quot;
comma
id|buf
comma
id|min
comma
id|max
comma
(paren
r_int
)paren
(paren
(paren
id|max
op_star
l_int|1000
)paren
op_div
id|min
)paren
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%spci_map_sg()    : %12ld calls  %12ld pages (avg %d/1000)&bslash;n&quot;
comma
id|buf
comma
id|ioc-&gt;msg_calls
comma
id|ioc-&gt;msg_pages
comma
(paren
r_int
)paren
(paren
(paren
id|ioc-&gt;msg_pages
op_star
l_int|1000
)paren
op_div
id|ioc-&gt;msg_calls
)paren
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%spci_unmap_sg()  : %12ld calls  %12ld pages (avg %d/1000)&bslash;n&quot;
comma
id|buf
comma
id|ioc-&gt;usg_calls
comma
id|ioc-&gt;usg_pages
comma
(paren
r_int
)paren
(paren
(paren
id|ioc-&gt;usg_pages
op_star
l_int|1000
)paren
op_div
id|ioc-&gt;usg_calls
)paren
)paren
suffix:semicolon
macro_line|#endif
r_return
id|strlen
c_func
(paren
id|buf
)paren
suffix:semicolon
)brace
macro_line|#if 0
multiline_comment|/* XXX too much output - exceeds 4k limit and needs to be re-written */
r_static
r_int
id|sba_resource_map
c_func
(paren
r_char
op_star
id|buf
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|len
)paren
(brace
r_struct
id|sba_device
op_star
id|sba_dev
op_assign
id|sba_list
suffix:semicolon
r_struct
id|ioc
op_star
id|ioc
op_assign
op_amp
id|sba_dev-&gt;ioc
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/* FIXME: Mutli-IOC suppoer! */
r_int
r_int
op_star
id|res_ptr
op_assign
(paren
r_int
r_int
op_star
)paren
id|ioc-&gt;res_map
suffix:semicolon
r_int
id|i
suffix:semicolon
id|buf
(braket
l_int|0
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|ioc-&gt;res_size
op_div
r_sizeof
(paren
r_int
r_int
)paren
)paren
suffix:semicolon
op_increment
id|i
comma
op_increment
id|res_ptr
)paren
(brace
r_if
c_cond
(paren
(paren
id|i
op_amp
l_int|7
)paren
op_eq
l_int|0
)paren
id|strcat
c_func
(paren
id|buf
comma
l_string|&quot;&bslash;n   &quot;
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%s %08x&quot;
comma
id|buf
comma
op_star
id|res_ptr
)paren
suffix:semicolon
)brace
id|strcat
c_func
(paren
id|buf
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|strlen
c_func
(paren
id|buf
)paren
suffix:semicolon
)brace
macro_line|#endif /* 0 */
macro_line|#endif /* CONFIG_PROC_FS */
DECL|variable|sba_tbl
r_static
r_struct
id|parisc_device_id
id|sba_tbl
(braket
)braket
op_assign
(brace
(brace
id|HPHW_IOA
comma
id|HVERSION_REV_ANY_ID
comma
id|ASTRO_RUNWAY_PORT
comma
l_int|0xb
)brace
comma
(brace
id|HPHW_BCPORT
comma
id|HVERSION_REV_ANY_ID
comma
id|IKE_MERCED_PORT
comma
l_int|0xc
)brace
comma
(brace
id|HPHW_BCPORT
comma
id|HVERSION_REV_ANY_ID
comma
id|REO_MERCED_PORT
comma
l_int|0xc
)brace
comma
(brace
id|HPHW_BCPORT
comma
id|HVERSION_REV_ANY_ID
comma
id|REOG_MERCED_PORT
comma
l_int|0xc
)brace
comma
(brace
id|HPHW_IOA
comma
id|HVERSION_REV_ANY_ID
comma
id|PLUTO_MCKINLEY_PORT
comma
l_int|0xc
)brace
comma
multiline_comment|/* These two entries commented out because we don&squot;t find them in a&n; * buswalk yet.  If/when we do, they would cause us to think we had&n; * many more SBAs then we really do.&n; *&t;{ HPHW_BCPORT, HVERSION_REV_ANY_ID, ASTRO_ROPES_PORT, 0xc },&n; *&t;{ HPHW_BCPORT, HVERSION_REV_ANY_ID, IKE_ROPES_PORT, 0xc },&n; */
multiline_comment|/* We shall also comment out Pluto Ropes Port since bus walk doesnt&n; * report it yet. &n; *&t;{ HPHW_BCPORT, HVERSION_REV_ANY_ID, PLUTO_ROPES_PORT, 0xc },&n; */
(brace
l_int|0
comma
)brace
)brace
suffix:semicolon
r_int
id|sba_driver_callback
c_func
(paren
r_struct
id|parisc_device
op_star
)paren
suffix:semicolon
DECL|variable|sba_driver
r_static
r_struct
id|parisc_driver
id|sba_driver
op_assign
(brace
dot
id|name
op_assign
id|MODULE_NAME
comma
dot
id|id_table
op_assign
id|sba_tbl
comma
dot
id|probe
op_assign
id|sba_driver_callback
comma
)brace
suffix:semicolon
multiline_comment|/*&n;** Determine if sba should claim this chip (return 0) or not (return 1).&n;** If so, initialize the chip and tell other partners in crime they&n;** have work to do.&n;*/
r_int
DECL|function|sba_driver_callback
id|sba_driver_callback
c_func
(paren
r_struct
id|parisc_device
op_star
id|dev
)paren
(brace
r_struct
id|sba_device
op_star
id|sba_dev
suffix:semicolon
id|u32
id|func_class
suffix:semicolon
r_int
id|i
suffix:semicolon
r_char
op_star
id|version
suffix:semicolon
id|sba_dump_ranges
c_func
(paren
id|dev-&gt;hpa
)paren
suffix:semicolon
multiline_comment|/* Read HW Rev First */
id|func_class
op_assign
id|READ_REG
c_func
(paren
id|dev-&gt;hpa
op_plus
id|SBA_FCLASS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ASTRO
c_func
(paren
op_amp
id|dev-&gt;id
)paren
)paren
(brace
r_int
r_int
id|fclass
suffix:semicolon
r_static
r_char
id|astro_rev
(braket
)braket
op_assign
l_string|&quot;Astro ?.?&quot;
suffix:semicolon
multiline_comment|/* Astro is broken...Read HW Rev First */
id|fclass
op_assign
id|READ_REG
c_func
(paren
id|dev-&gt;hpa
)paren
suffix:semicolon
id|astro_rev
(braket
l_int|6
)braket
op_assign
l_char|&squot;1&squot;
op_plus
(paren
r_char
)paren
(paren
id|fclass
op_amp
l_int|0x7
)paren
suffix:semicolon
id|astro_rev
(braket
l_int|8
)braket
op_assign
l_char|&squot;0&squot;
op_plus
(paren
r_char
)paren
(paren
(paren
id|fclass
op_amp
l_int|0x18
)paren
op_rshift
l_int|3
)paren
suffix:semicolon
id|version
op_assign
id|astro_rev
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|IS_IKE
c_func
(paren
op_amp
id|dev-&gt;id
)paren
)paren
(brace
r_static
r_char
id|ike_rev
(braket
)braket
op_assign
l_string|&quot;Ike rev ?&quot;
suffix:semicolon
id|ike_rev
(braket
l_int|8
)braket
op_assign
l_char|&squot;0&squot;
op_plus
(paren
r_char
)paren
(paren
id|func_class
op_amp
l_int|0xff
)paren
suffix:semicolon
id|version
op_assign
id|ike_rev
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|IS_PLUTO
c_func
(paren
op_amp
id|dev-&gt;id
)paren
)paren
(brace
r_static
r_char
id|pluto_rev
(braket
)braket
op_assign
l_string|&quot;Pluto ?.?&quot;
suffix:semicolon
id|pluto_rev
(braket
l_int|6
)braket
op_assign
l_char|&squot;0&squot;
op_plus
(paren
r_char
)paren
(paren
(paren
id|func_class
op_amp
l_int|0xf0
)paren
op_rshift
l_int|4
)paren
suffix:semicolon
id|pluto_rev
(braket
l_int|8
)braket
op_assign
l_char|&squot;0&squot;
op_plus
(paren
r_char
)paren
(paren
id|func_class
op_amp
l_int|0x0f
)paren
suffix:semicolon
id|version
op_assign
id|pluto_rev
suffix:semicolon
)brace
r_else
(brace
r_static
r_char
id|reo_rev
(braket
)braket
op_assign
l_string|&quot;REO rev ?&quot;
suffix:semicolon
id|reo_rev
(braket
l_int|8
)braket
op_assign
l_char|&squot;0&squot;
op_plus
(paren
r_char
)paren
(paren
id|func_class
op_amp
l_int|0xff
)paren
suffix:semicolon
id|version
op_assign
id|reo_rev
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|global_ioc_cnt
)paren
(brace
id|global_ioc_cnt
op_assign
id|count_parisc_driver
c_func
(paren
op_amp
id|sba_driver
)paren
suffix:semicolon
multiline_comment|/* Astro and Pluto have one IOC per SBA */
r_if
c_cond
(paren
(paren
op_logical_neg
id|IS_ASTRO
c_func
(paren
op_amp
id|dev-&gt;id
)paren
)paren
op_logical_or
(paren
op_logical_neg
id|IS_PLUTO
c_func
(paren
op_amp
id|dev-&gt;id
)paren
)paren
)paren
id|global_ioc_cnt
op_mul_assign
l_int|2
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s found %s at 0x%lx&bslash;n&quot;
comma
id|MODULE_NAME
comma
id|version
comma
id|dev-&gt;hpa
)paren
suffix:semicolon
id|sba_dev
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|sba_device
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_eq
id|sba_dev
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|MODULE_NAME
l_string|&quot; - couldn&squot;t alloc sba_device&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|dev-&gt;sysdata
op_assign
(paren
r_void
op_star
)paren
id|sba_dev
suffix:semicolon
id|memset
c_func
(paren
id|sba_dev
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|sba_device
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_IOC
suffix:semicolon
id|i
op_increment
)paren
(brace
id|spin_lock_init
c_func
(paren
op_amp
(paren
id|sba_dev-&gt;ioc
(braket
id|i
)braket
dot
id|res_lock
)paren
)paren
suffix:semicolon
)brace
id|sba_dev-&gt;dev
op_assign
id|dev
suffix:semicolon
id|sba_dev-&gt;hw_rev
op_assign
id|func_class
suffix:semicolon
id|sba_dev-&gt;iodc
op_assign
op_amp
id|dev-&gt;id
suffix:semicolon
id|sba_dev-&gt;name
op_assign
id|dev-&gt;name
suffix:semicolon
id|sba_dev-&gt;sba_hpa
op_assign
id|dev-&gt;hpa
suffix:semicolon
multiline_comment|/* faster access */
id|sba_get_pat_resources
c_func
(paren
id|sba_dev
)paren
suffix:semicolon
id|sba_hw_init
c_func
(paren
id|sba_dev
)paren
suffix:semicolon
id|sba_common_init
c_func
(paren
id|sba_dev
)paren
suffix:semicolon
id|hppa_dma_ops
op_assign
op_amp
id|sba_ops
suffix:semicolon
macro_line|#ifdef CONFIG_PROC_FS
r_if
c_cond
(paren
id|IS_ASTRO
c_func
(paren
op_amp
id|dev-&gt;id
)paren
)paren
(brace
id|create_proc_info_entry
c_func
(paren
l_string|&quot;Astro&quot;
comma
l_int|0
comma
id|proc_runway_root
comma
id|sba_proc_info
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|IS_IKE
c_func
(paren
op_amp
id|dev-&gt;id
)paren
)paren
(brace
id|create_proc_info_entry
c_func
(paren
l_string|&quot;Ike&quot;
comma
l_int|0
comma
id|proc_runway_root
comma
id|sba_proc_info
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|IS_PLUTO
c_func
(paren
op_amp
id|dev-&gt;id
)paren
)paren
(brace
id|create_proc_info_entry
c_func
(paren
l_string|&quot;Pluto&quot;
comma
l_int|0
comma
id|proc_mckinley_root
comma
id|sba_proc_info
)paren
suffix:semicolon
)brace
r_else
(brace
id|create_proc_info_entry
c_func
(paren
l_string|&quot;Reo&quot;
comma
l_int|0
comma
id|proc_runway_root
comma
id|sba_proc_info
)paren
suffix:semicolon
)brace
macro_line|#if 0
id|create_proc_info_entry
c_func
(paren
l_string|&quot;bitmap&quot;
comma
l_int|0
comma
id|proc_runway_root
comma
id|sba_resource_map
)paren
suffix:semicolon
macro_line|#endif
macro_line|#endif
id|parisc_vmerge_boundary
op_assign
id|IOVP_SIZE
suffix:semicolon
id|parisc_vmerge_max_size
op_assign
id|IOVP_SIZE
op_star
id|BITS_PER_LONG
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;** One time initialization to let the world know the SBA was found.&n;** This is the only routine which is NOT static.&n;** Must be called exactly once before pci_init().&n;*/
DECL|function|sba_init
r_void
id|__init
id|sba_init
c_func
(paren
r_void
)paren
(brace
id|register_parisc_driver
c_func
(paren
op_amp
id|sba_driver
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * sba_get_iommu - Assign the iommu pointer for the pci bus controller.&n; * @dev: The parisc device.&n; *&n; * Returns the appropriate IOMMU data for the given parisc PCI controller.&n; * This is cached and used later for PCI DMA Mapping.&n; */
DECL|function|sba_get_iommu
r_void
op_star
id|sba_get_iommu
c_func
(paren
r_struct
id|parisc_device
op_star
id|pci_hba
)paren
(brace
r_struct
id|parisc_device
op_star
id|sba_dev
op_assign
id|parisc_parent
c_func
(paren
id|pci_hba
)paren
suffix:semicolon
r_struct
id|sba_device
op_star
id|sba
op_assign
id|sba_dev-&gt;dev.driver_data
suffix:semicolon
r_char
id|t
op_assign
id|sba_dev-&gt;id.hw_type
suffix:semicolon
r_int
id|iocnum
op_assign
(paren
id|pci_hba-&gt;hw_path
op_rshift
l_int|3
)paren
suffix:semicolon
multiline_comment|/* rope # */
id|BUG_ON
c_func
(paren
(paren
id|t
op_ne
id|HPHW_IOA
)paren
op_logical_and
(paren
id|t
op_ne
id|HPHW_BCPORT
)paren
)paren
suffix:semicolon
r_return
op_amp
(paren
id|sba-&gt;ioc
(braket
id|iocnum
)braket
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * sba_directed_lmmio - return first directed LMMIO range routed to rope&n; * @pa_dev: The parisc device.&n; * @r: resource PCI host controller wants start/end fields assigned.&n; *&n; * For the given parisc PCI controller, determine if any direct ranges&n; * are routed down the corresponding rope.&n; */
DECL|function|sba_directed_lmmio
r_void
id|sba_directed_lmmio
c_func
(paren
r_struct
id|parisc_device
op_star
id|pci_hba
comma
r_struct
id|resource
op_star
id|r
)paren
(brace
r_struct
id|parisc_device
op_star
id|sba_dev
op_assign
id|parisc_parent
c_func
(paren
id|pci_hba
)paren
suffix:semicolon
r_struct
id|sba_device
op_star
id|sba
op_assign
id|sba_dev-&gt;dev.driver_data
suffix:semicolon
r_char
id|t
op_assign
id|sba_dev-&gt;id.hw_type
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|rope
op_assign
(paren
id|pci_hba-&gt;hw_path
op_amp
(paren
id|ROPES_PER_IOC
op_minus
l_int|1
)paren
)paren
suffix:semicolon
multiline_comment|/* rope # */
r_if
c_cond
(paren
(paren
id|t
op_ne
id|HPHW_IOA
)paren
op_logical_and
(paren
id|t
op_ne
id|HPHW_BCPORT
)paren
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
id|r-&gt;start
op_assign
id|r-&gt;end
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Astro has 4 directed ranges. Not sure about Ike/Pluto/et al */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
id|base
comma
id|size
suffix:semicolon
r_int
r_int
id|reg
op_assign
id|sba-&gt;sba_hpa
op_plus
id|i
op_star
l_int|0x18
suffix:semicolon
id|base
op_assign
id|READ_REG32
c_func
(paren
id|reg
op_plus
id|LMMIO_DIRECT0_BASE
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|base
op_amp
l_int|1
)paren
op_eq
l_int|0
)paren
r_continue
suffix:semicolon
multiline_comment|/* not enabled */
id|size
op_assign
id|READ_REG32
c_func
(paren
id|reg
op_plus
id|LMMIO_DIRECT0_ROUTE
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|size
op_amp
(paren
id|ROPES_PER_IOC
op_minus
l_int|1
)paren
)paren
op_ne
id|rope
)paren
r_continue
suffix:semicolon
multiline_comment|/* directed down different rope */
id|r-&gt;start
op_assign
(paren
id|base
op_amp
op_complement
l_int|1UL
)paren
op_or
id|PCI_F_EXTEND
suffix:semicolon
id|size
op_assign
op_complement
id|READ_REG32
c_func
(paren
id|reg
op_plus
id|LMMIO_DIRECT0_MASK
)paren
suffix:semicolon
id|r-&gt;end
op_assign
id|r-&gt;start
op_plus
id|size
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; * sba_distributed_lmmio - return portion of distributed LMMIO range&n; * @pa_dev: The parisc device.&n; * @r: resource PCI host controller wants start/end fields assigned.&n; *&n; * For the given parisc PCI controller, return portion of distributed LMMIO&n; * range. The distributed LMMIO is always present and it&squot;s just a question&n; * of the base address and size of the range.&n; */
DECL|function|sba_distributed_lmmio
r_void
id|sba_distributed_lmmio
c_func
(paren
r_struct
id|parisc_device
op_star
id|pci_hba
comma
r_struct
id|resource
op_star
id|r
)paren
(brace
r_struct
id|parisc_device
op_star
id|sba_dev
op_assign
id|parisc_parent
c_func
(paren
id|pci_hba
)paren
suffix:semicolon
r_struct
id|sba_device
op_star
id|sba
op_assign
id|sba_dev-&gt;dev.driver_data
suffix:semicolon
r_char
id|t
op_assign
id|sba_dev-&gt;id.hw_type
suffix:semicolon
r_int
id|base
comma
id|size
suffix:semicolon
r_int
id|rope
op_assign
(paren
id|pci_hba-&gt;hw_path
op_amp
(paren
id|ROPES_PER_IOC
op_minus
l_int|1
)paren
)paren
suffix:semicolon
multiline_comment|/* rope # */
r_if
c_cond
(paren
(paren
id|t
op_ne
id|HPHW_IOA
)paren
op_logical_and
(paren
id|t
op_ne
id|HPHW_BCPORT
)paren
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
id|r-&gt;start
op_assign
id|r-&gt;end
op_assign
l_int|0
suffix:semicolon
id|base
op_assign
id|READ_REG32
c_func
(paren
id|sba-&gt;sba_hpa
op_plus
id|LMMIO_DIST_BASE
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|base
op_amp
l_int|1
)paren
op_eq
l_int|0
)paren
(brace
id|BUG
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Gah! Distr Range wasn&squot;t enabled! */
r_return
suffix:semicolon
)brace
id|r-&gt;start
op_assign
(paren
id|base
op_amp
op_complement
l_int|1UL
)paren
op_or
id|PCI_F_EXTEND
suffix:semicolon
id|size
op_assign
(paren
op_complement
id|READ_REG32
c_func
(paren
id|sba-&gt;sba_hpa
op_plus
id|LMMIO_DIST_MASK
)paren
)paren
op_div
id|ROPES_PER_IOC
suffix:semicolon
id|r-&gt;start
op_add_assign
id|rope
op_star
(paren
id|size
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* adjust base for this rope */
id|r-&gt;end
op_assign
id|r-&gt;start
op_plus
id|size
suffix:semicolon
)brace
eof
