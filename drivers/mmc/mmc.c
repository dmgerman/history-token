multiline_comment|/*&n; *  linux/drivers/mmc/mmc.c&n; *&n; *  Copyright (C) 2003-2004 Russell King, All Rights Reserved.&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License version 2 as&n; * published by the Free Software Foundation.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/completion.h&gt;
macro_line|#include &lt;linux/device.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/pagemap.h&gt;
macro_line|#include &lt;linux/err.h&gt;
macro_line|#include &lt;linux/mmc/card.h&gt;
macro_line|#include &lt;linux/mmc/host.h&gt;
macro_line|#include &lt;linux/mmc/protocol.h&gt;
macro_line|#include &quot;mmc.h&quot;
macro_line|#ifdef CONFIG_MMC_DEBUG
DECL|macro|DBG
mdefine_line|#define DBG(x...)&t;printk(KERN_DEBUG x)
macro_line|#else
DECL|macro|DBG
mdefine_line|#define DBG(x...)&t;do { } while (0)
macro_line|#endif
DECL|macro|CMD_RETRIES
mdefine_line|#define CMD_RETRIES&t;3
multiline_comment|/*&n; * OCR Bit positions to 10s of Vdd mV.&n; */
DECL|variable|mmc_ocr_bit_to_vdd
r_static
r_const
r_int
r_int
id|mmc_ocr_bit_to_vdd
(braket
)braket
op_assign
(brace
l_int|150
comma
l_int|155
comma
l_int|160
comma
l_int|165
comma
l_int|170
comma
l_int|180
comma
l_int|190
comma
l_int|200
comma
l_int|210
comma
l_int|220
comma
l_int|230
comma
l_int|240
comma
l_int|250
comma
l_int|260
comma
l_int|270
comma
l_int|280
comma
l_int|290
comma
l_int|300
comma
l_int|310
comma
l_int|320
comma
l_int|330
comma
l_int|340
comma
l_int|350
comma
l_int|360
)brace
suffix:semicolon
DECL|variable|tran_exp
r_static
r_const
r_int
r_int
id|tran_exp
(braket
)braket
op_assign
(brace
l_int|10000
comma
l_int|100000
comma
l_int|1000000
comma
l_int|10000000
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
DECL|variable|tran_mant
r_static
r_const
r_int
r_char
id|tran_mant
(braket
)braket
op_assign
(brace
l_int|0
comma
l_int|10
comma
l_int|12
comma
l_int|13
comma
l_int|15
comma
l_int|20
comma
l_int|25
comma
l_int|30
comma
l_int|35
comma
l_int|40
comma
l_int|45
comma
l_int|50
comma
l_int|55
comma
l_int|60
comma
l_int|70
comma
l_int|80
comma
)brace
suffix:semicolon
DECL|variable|tacc_exp
r_static
r_const
r_int
r_int
id|tacc_exp
(braket
)braket
op_assign
(brace
l_int|1
comma
l_int|10
comma
l_int|100
comma
l_int|1000
comma
l_int|10000
comma
l_int|100000
comma
l_int|1000000
comma
l_int|10000000
comma
)brace
suffix:semicolon
DECL|variable|tacc_mant
r_static
r_const
r_int
r_int
id|tacc_mant
(braket
)braket
op_assign
(brace
l_int|0
comma
l_int|10
comma
l_int|12
comma
l_int|13
comma
l_int|15
comma
l_int|20
comma
l_int|25
comma
l_int|30
comma
l_int|35
comma
l_int|40
comma
l_int|45
comma
l_int|50
comma
l_int|55
comma
l_int|60
comma
l_int|70
comma
l_int|80
comma
)brace
suffix:semicolon
multiline_comment|/**&n; *&t;mmc_request_done - finish processing an MMC command&n; *&t;@host: MMC host which completed command&n; *&t;@mrq: MMC request which completed&n; *&n; *&t;MMC drivers should call this function when they have completed&n; *&t;their processing of a command.  This should be called before the&n; *&t;data part of the command has completed.&n; */
DECL|function|mmc_request_done
r_void
id|mmc_request_done
c_func
(paren
r_struct
id|mmc_host
op_star
id|host
comma
r_struct
id|mmc_request
op_star
id|mrq
)paren
(brace
r_struct
id|mmc_command
op_star
id|cmd
op_assign
id|mrq-&gt;cmd
suffix:semicolon
r_int
id|err
op_assign
id|mrq-&gt;cmd-&gt;error
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;MMC: req done (%02x): %d: %08x %08x %08x %08x&bslash;n&quot;
comma
id|cmd-&gt;opcode
comma
id|err
comma
id|cmd-&gt;resp
(braket
l_int|0
)braket
comma
id|cmd-&gt;resp
(braket
l_int|1
)braket
comma
id|cmd-&gt;resp
(braket
l_int|2
)braket
comma
id|cmd-&gt;resp
(braket
l_int|3
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_logical_and
id|cmd-&gt;retries
)paren
(brace
id|cmd-&gt;retries
op_decrement
suffix:semicolon
id|cmd-&gt;error
op_assign
l_int|0
suffix:semicolon
id|host-&gt;ops
op_member_access_from_pointer
id|request
c_func
(paren
id|host
comma
id|mrq
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|mrq-&gt;done
)paren
(brace
id|mrq
op_member_access_from_pointer
id|done
c_func
(paren
id|mrq
)paren
suffix:semicolon
)brace
)brace
DECL|variable|mmc_request_done
id|EXPORT_SYMBOL
c_func
(paren
id|mmc_request_done
)paren
suffix:semicolon
multiline_comment|/**&n; *&t;mmc_start_request - start a command on a host&n; *&t;@host: MMC host to start command on&n; *&t;@mrq: MMC request to start&n; *&n; *&t;Queue a command on the specified host.  We expect the&n; *&t;caller to be holding the host lock with interrupts disabled.&n; */
r_void
DECL|function|mmc_start_request
id|mmc_start_request
c_func
(paren
r_struct
id|mmc_host
op_star
id|host
comma
r_struct
id|mmc_request
op_star
id|mrq
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;MMC: starting cmd %02x arg %08x flags %08x&bslash;n&quot;
comma
id|mrq-&gt;cmd-&gt;opcode
comma
id|mrq-&gt;cmd-&gt;arg
comma
id|mrq-&gt;cmd-&gt;flags
)paren
suffix:semicolon
id|WARN_ON
c_func
(paren
id|host-&gt;card_busy
op_eq
l_int|NULL
)paren
suffix:semicolon
id|mrq-&gt;cmd-&gt;error
op_assign
l_int|0
suffix:semicolon
id|mrq-&gt;cmd-&gt;mrq
op_assign
id|mrq
suffix:semicolon
r_if
c_cond
(paren
id|mrq-&gt;data
)paren
(brace
id|mrq-&gt;cmd-&gt;data
op_assign
id|mrq-&gt;data
suffix:semicolon
id|mrq-&gt;data-&gt;error
op_assign
l_int|0
suffix:semicolon
id|mrq-&gt;data-&gt;mrq
op_assign
id|mrq
suffix:semicolon
r_if
c_cond
(paren
id|mrq-&gt;stop
)paren
(brace
id|mrq-&gt;data-&gt;stop
op_assign
id|mrq-&gt;stop
suffix:semicolon
id|mrq-&gt;stop-&gt;error
op_assign
l_int|0
suffix:semicolon
id|mrq-&gt;stop-&gt;mrq
op_assign
id|mrq
suffix:semicolon
)brace
)brace
id|host-&gt;ops
op_member_access_from_pointer
id|request
c_func
(paren
id|host
comma
id|mrq
)paren
suffix:semicolon
)brace
DECL|variable|mmc_start_request
id|EXPORT_SYMBOL
c_func
(paren
id|mmc_start_request
)paren
suffix:semicolon
DECL|function|mmc_wait_done
r_static
r_void
id|mmc_wait_done
c_func
(paren
r_struct
id|mmc_request
op_star
id|mrq
)paren
(brace
id|complete
c_func
(paren
id|mrq-&gt;done_data
)paren
suffix:semicolon
)brace
DECL|function|mmc_wait_for_req
r_int
id|mmc_wait_for_req
c_func
(paren
r_struct
id|mmc_host
op_star
id|host
comma
r_struct
id|mmc_request
op_star
id|mrq
)paren
(brace
id|DECLARE_COMPLETION
c_func
(paren
id|complete
)paren
suffix:semicolon
id|mrq-&gt;done_data
op_assign
op_amp
id|complete
suffix:semicolon
id|mrq-&gt;done
op_assign
id|mmc_wait_done
suffix:semicolon
id|mmc_start_request
c_func
(paren
id|host
comma
id|mrq
)paren
suffix:semicolon
id|wait_for_completion
c_func
(paren
op_amp
id|complete
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|mmc_wait_for_req
id|EXPORT_SYMBOL
c_func
(paren
id|mmc_wait_for_req
)paren
suffix:semicolon
multiline_comment|/**&n; *&t;mmc_wait_for_cmd - start a command and wait for completion&n; *&t;@host: MMC host to start command&n; *&t;@cmd: MMC command to start&n; *&t;@retries: maximum number of retries&n; *&n; *&t;Start a new MMC command for a host, and wait for the command&n; *&t;to complete.  Return any error that occurred while the command&n; *&t;was executing.  Do not attempt to parse the response.&n; */
DECL|function|mmc_wait_for_cmd
r_int
id|mmc_wait_for_cmd
c_func
(paren
r_struct
id|mmc_host
op_star
id|host
comma
r_struct
id|mmc_command
op_star
id|cmd
comma
r_int
id|retries
)paren
(brace
r_struct
id|mmc_request
id|mrq
suffix:semicolon
id|BUG_ON
c_func
(paren
id|host-&gt;card_busy
op_eq
l_int|NULL
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|mrq
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|mmc_request
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
id|cmd-&gt;resp
comma
l_int|0
comma
r_sizeof
(paren
id|cmd-&gt;resp
)paren
)paren
suffix:semicolon
id|cmd-&gt;retries
op_assign
id|retries
suffix:semicolon
id|mrq.cmd
op_assign
id|cmd
suffix:semicolon
id|cmd-&gt;data
op_assign
l_int|NULL
suffix:semicolon
id|mmc_wait_for_req
c_func
(paren
id|host
comma
op_amp
id|mrq
)paren
suffix:semicolon
r_return
id|cmd-&gt;error
suffix:semicolon
)brace
DECL|variable|mmc_wait_for_cmd
id|EXPORT_SYMBOL
c_func
(paren
id|mmc_wait_for_cmd
)paren
suffix:semicolon
multiline_comment|/**&n; *&t;__mmc_claim_host - exclusively claim a host&n; *&t;@host: mmc host to claim&n; *&t;@card: mmc card to claim host for&n; *&n; *&t;Claim a host for a set of operations.  If a valid card&n; *&t;is passed and this wasn&squot;t the last card selected, select&n; *&t;the card before returning.&n; *&n; *&t;Note: you should use mmc_card_claim_host or mmc_claim_host.&n; */
DECL|function|__mmc_claim_host
r_int
id|__mmc_claim_host
c_func
(paren
r_struct
id|mmc_host
op_star
id|host
comma
r_struct
id|mmc_card
op_star
id|card
)paren
(brace
id|DECLARE_WAITQUEUE
c_func
(paren
id|wait
comma
id|current
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
id|add_wait_queue
c_func
(paren
op_amp
id|host-&gt;wq
comma
op_amp
id|wait
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|host-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|host-&gt;card_busy
op_eq
l_int|NULL
)paren
r_break
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|host-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|host-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
id|set_current_state
c_func
(paren
id|TASK_RUNNING
)paren
suffix:semicolon
id|host-&gt;card_busy
op_assign
id|card
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|host-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|remove_wait_queue
c_func
(paren
op_amp
id|host-&gt;wq
comma
op_amp
id|wait
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card
op_ne
(paren
r_void
op_star
)paren
op_minus
l_int|1
op_logical_and
id|host-&gt;card_selected
op_ne
id|card
)paren
(brace
r_struct
id|mmc_command
id|cmd
suffix:semicolon
id|host-&gt;card_selected
op_assign
id|card
suffix:semicolon
id|cmd.opcode
op_assign
id|MMC_SELECT_CARD
suffix:semicolon
id|cmd.arg
op_assign
id|card-&gt;rca
op_lshift
l_int|16
suffix:semicolon
id|cmd.flags
op_assign
id|MMC_RSP_R1
suffix:semicolon
id|err
op_assign
id|mmc_wait_for_cmd
c_func
(paren
id|host
comma
op_amp
id|cmd
comma
id|CMD_RETRIES
)paren
suffix:semicolon
)brace
r_return
id|err
suffix:semicolon
)brace
DECL|variable|__mmc_claim_host
id|EXPORT_SYMBOL
c_func
(paren
id|__mmc_claim_host
)paren
suffix:semicolon
multiline_comment|/**&n; *&t;mmc_release_host - release a host&n; *&t;@host: mmc host to release&n; *&n; *&t;Release a MMC host, allowing others to claim the host&n; *&t;for their operations.&n; */
DECL|function|mmc_release_host
r_void
id|mmc_release_host
c_func
(paren
r_struct
id|mmc_host
op_star
id|host
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|BUG_ON
c_func
(paren
id|host-&gt;card_busy
op_eq
l_int|NULL
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|host-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|host-&gt;card_busy
op_assign
l_int|NULL
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|host-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|host-&gt;wq
)paren
suffix:semicolon
)brace
DECL|variable|mmc_release_host
id|EXPORT_SYMBOL
c_func
(paren
id|mmc_release_host
)paren
suffix:semicolon
multiline_comment|/*&n; * Ensure that no card is selected.&n; */
DECL|function|mmc_deselect_cards
r_static
r_void
id|mmc_deselect_cards
c_func
(paren
r_struct
id|mmc_host
op_star
id|host
)paren
(brace
r_struct
id|mmc_command
id|cmd
suffix:semicolon
r_if
c_cond
(paren
id|host-&gt;card_selected
)paren
(brace
id|host-&gt;card_selected
op_assign
l_int|NULL
suffix:semicolon
id|cmd.opcode
op_assign
id|MMC_SELECT_CARD
suffix:semicolon
id|cmd.arg
op_assign
l_int|0
suffix:semicolon
id|cmd.flags
op_assign
id|MMC_RSP_NONE
suffix:semicolon
id|mmc_wait_for_cmd
c_func
(paren
id|host
comma
op_amp
id|cmd
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
DECL|function|mmc_delay
r_static
r_inline
r_void
id|mmc_delay
c_func
(paren
r_int
r_int
id|ms
)paren
(brace
r_if
c_cond
(paren
id|ms
OL
id|HZ
op_div
l_int|1000
)paren
(brace
id|yield
c_func
(paren
)paren
suffix:semicolon
id|mdelay
c_func
(paren
id|ms
)paren
suffix:semicolon
)brace
r_else
(brace
id|msleep_interruptible
(paren
id|ms
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Mask off any voltages we don&squot;t support and select&n; * the lowest voltage&n; */
DECL|function|mmc_select_voltage
r_static
id|u32
id|mmc_select_voltage
c_func
(paren
r_struct
id|mmc_host
op_star
id|host
comma
id|u32
id|ocr
)paren
(brace
r_int
id|bit
suffix:semicolon
id|ocr
op_and_assign
id|host-&gt;ocr_avail
suffix:semicolon
id|bit
op_assign
id|ffs
c_func
(paren
id|ocr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bit
)paren
(brace
id|bit
op_sub_assign
l_int|1
suffix:semicolon
id|ocr
op_assign
l_int|3
op_lshift
id|bit
suffix:semicolon
id|host-&gt;ios.vdd
op_assign
id|bit
suffix:semicolon
id|host-&gt;ops
op_member_access_from_pointer
id|set_ios
c_func
(paren
id|host
comma
op_amp
id|host-&gt;ios
)paren
suffix:semicolon
)brace
r_else
(brace
id|ocr
op_assign
l_int|0
suffix:semicolon
)brace
r_return
id|ocr
suffix:semicolon
)brace
DECL|macro|UNSTUFF_BITS
mdefine_line|#define UNSTUFF_BITS(resp,start,size)&t;&t;&t;&t;&t;&bslash;&n;&t;({&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;&t;const u32 __mask = (1 &lt;&lt; (size)) - 1;&t;&t;&t;&bslash;&n;&t;&t;const int __off = 3 - ((start) / 32);&t;&t;&t;&bslash;&n;&t;&t;const int __shft = (start) &amp; 31;&t;&t;&t;&bslash;&n;&t;&t;u32 __res;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;&t;__res = resp[__off] &gt;&gt; __shft;&t;&t;&t;&t;&bslash;&n;&t;&t;if ((size) + __shft &gt;= 32)&t;&t;&t;&t;&bslash;&n;&t;&t;&t;__res |= resp[__off-1] &lt;&lt; (32 - __shft);&t;&bslash;&n;&t;&t;__res &amp; __mask;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;})
multiline_comment|/*&n; * Given the decoded CSD structure, decode the raw CID to our CID structure.&n; */
DECL|function|mmc_decode_cid
r_static
r_void
id|mmc_decode_cid
c_func
(paren
r_struct
id|mmc_card
op_star
id|card
)paren
(brace
id|u32
op_star
id|resp
op_assign
id|card-&gt;raw_cid
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|card-&gt;cid
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|mmc_cid
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * The selection of the format here is guesswork based upon&n;&t; * information people have sent to date.&n;&t; */
r_switch
c_cond
(paren
id|card-&gt;csd.mmca_vsn
)paren
(brace
r_case
l_int|0
suffix:colon
multiline_comment|/* MMC v1.? */
r_case
l_int|1
suffix:colon
multiline_comment|/* MMC v1.4 */
id|card-&gt;cid.manfid
op_assign
id|UNSTUFF_BITS
c_func
(paren
id|resp
comma
l_int|104
comma
l_int|24
)paren
suffix:semicolon
id|card-&gt;cid.prod_name
(braket
l_int|0
)braket
op_assign
id|UNSTUFF_BITS
c_func
(paren
id|resp
comma
l_int|96
comma
l_int|8
)paren
suffix:semicolon
id|card-&gt;cid.prod_name
(braket
l_int|1
)braket
op_assign
id|UNSTUFF_BITS
c_func
(paren
id|resp
comma
l_int|88
comma
l_int|8
)paren
suffix:semicolon
id|card-&gt;cid.prod_name
(braket
l_int|2
)braket
op_assign
id|UNSTUFF_BITS
c_func
(paren
id|resp
comma
l_int|80
comma
l_int|8
)paren
suffix:semicolon
id|card-&gt;cid.prod_name
(braket
l_int|3
)braket
op_assign
id|UNSTUFF_BITS
c_func
(paren
id|resp
comma
l_int|72
comma
l_int|8
)paren
suffix:semicolon
id|card-&gt;cid.prod_name
(braket
l_int|4
)braket
op_assign
id|UNSTUFF_BITS
c_func
(paren
id|resp
comma
l_int|64
comma
l_int|8
)paren
suffix:semicolon
id|card-&gt;cid.prod_name
(braket
l_int|5
)braket
op_assign
id|UNSTUFF_BITS
c_func
(paren
id|resp
comma
l_int|56
comma
l_int|8
)paren
suffix:semicolon
id|card-&gt;cid.prod_name
(braket
l_int|6
)braket
op_assign
id|UNSTUFF_BITS
c_func
(paren
id|resp
comma
l_int|48
comma
l_int|8
)paren
suffix:semicolon
id|card-&gt;cid.hwrev
op_assign
id|UNSTUFF_BITS
c_func
(paren
id|resp
comma
l_int|44
comma
l_int|4
)paren
suffix:semicolon
id|card-&gt;cid.fwrev
op_assign
id|UNSTUFF_BITS
c_func
(paren
id|resp
comma
l_int|40
comma
l_int|4
)paren
suffix:semicolon
id|card-&gt;cid.serial
op_assign
id|UNSTUFF_BITS
c_func
(paren
id|resp
comma
l_int|16
comma
l_int|24
)paren
suffix:semicolon
id|card-&gt;cid.month
op_assign
id|UNSTUFF_BITS
c_func
(paren
id|resp
comma
l_int|12
comma
l_int|4
)paren
suffix:semicolon
id|card-&gt;cid.year
op_assign
id|UNSTUFF_BITS
c_func
(paren
id|resp
comma
l_int|8
comma
l_int|4
)paren
op_plus
l_int|1997
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
multiline_comment|/* MMC v2.x ? */
r_case
l_int|3
suffix:colon
multiline_comment|/* MMC v3.x ? */
id|card-&gt;cid.manfid
op_assign
id|UNSTUFF_BITS
c_func
(paren
id|resp
comma
l_int|120
comma
l_int|8
)paren
suffix:semicolon
id|card-&gt;cid.oemid
op_assign
id|UNSTUFF_BITS
c_func
(paren
id|resp
comma
l_int|104
comma
l_int|16
)paren
suffix:semicolon
id|card-&gt;cid.prod_name
(braket
l_int|0
)braket
op_assign
id|UNSTUFF_BITS
c_func
(paren
id|resp
comma
l_int|96
comma
l_int|8
)paren
suffix:semicolon
id|card-&gt;cid.prod_name
(braket
l_int|1
)braket
op_assign
id|UNSTUFF_BITS
c_func
(paren
id|resp
comma
l_int|88
comma
l_int|8
)paren
suffix:semicolon
id|card-&gt;cid.prod_name
(braket
l_int|2
)braket
op_assign
id|UNSTUFF_BITS
c_func
(paren
id|resp
comma
l_int|80
comma
l_int|8
)paren
suffix:semicolon
id|card-&gt;cid.prod_name
(braket
l_int|3
)braket
op_assign
id|UNSTUFF_BITS
c_func
(paren
id|resp
comma
l_int|72
comma
l_int|8
)paren
suffix:semicolon
id|card-&gt;cid.prod_name
(braket
l_int|4
)braket
op_assign
id|UNSTUFF_BITS
c_func
(paren
id|resp
comma
l_int|64
comma
l_int|8
)paren
suffix:semicolon
id|card-&gt;cid.prod_name
(braket
l_int|5
)braket
op_assign
id|UNSTUFF_BITS
c_func
(paren
id|resp
comma
l_int|56
comma
l_int|8
)paren
suffix:semicolon
id|card-&gt;cid.serial
op_assign
id|UNSTUFF_BITS
c_func
(paren
id|resp
comma
l_int|16
comma
l_int|32
)paren
suffix:semicolon
id|card-&gt;cid.month
op_assign
id|UNSTUFF_BITS
c_func
(paren
id|resp
comma
l_int|12
comma
l_int|4
)paren
suffix:semicolon
id|card-&gt;cid.year
op_assign
id|UNSTUFF_BITS
c_func
(paren
id|resp
comma
l_int|8
comma
l_int|4
)paren
op_plus
l_int|1997
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;%s: card has unknown MMCA version %d&bslash;n&quot;
comma
id|card-&gt;host-&gt;host_name
comma
id|card-&gt;csd.mmca_vsn
)paren
suffix:semicolon
id|mmc_card_set_bad
c_func
(paren
id|card
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Given a 128-bit response, decode to our card CSD structure.&n; */
DECL|function|mmc_decode_csd
r_static
r_void
id|mmc_decode_csd
c_func
(paren
r_struct
id|mmc_card
op_star
id|card
)paren
(brace
r_struct
id|mmc_csd
op_star
id|csd
op_assign
op_amp
id|card-&gt;csd
suffix:semicolon
r_int
r_int
id|e
comma
id|m
comma
id|csd_struct
suffix:semicolon
id|u32
op_star
id|resp
op_assign
id|card-&gt;raw_csd
suffix:semicolon
multiline_comment|/*&n;&t; * We only understand CSD structure v1.1 and v2.&n;&t; * v2 has extra information in bits 15, 11 and 10.&n;&t; */
id|csd_struct
op_assign
id|UNSTUFF_BITS
c_func
(paren
id|resp
comma
l_int|126
comma
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|csd_struct
op_ne
l_int|1
op_logical_and
id|csd_struct
op_ne
l_int|2
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: unrecognised CSD structure version %d&bslash;n&quot;
comma
id|card-&gt;host-&gt;host_name
comma
id|csd_struct
)paren
suffix:semicolon
id|mmc_card_set_bad
c_func
(paren
id|card
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|csd-&gt;mmca_vsn
op_assign
id|UNSTUFF_BITS
c_func
(paren
id|resp
comma
l_int|122
comma
l_int|4
)paren
suffix:semicolon
id|m
op_assign
id|UNSTUFF_BITS
c_func
(paren
id|resp
comma
l_int|115
comma
l_int|4
)paren
suffix:semicolon
id|e
op_assign
id|UNSTUFF_BITS
c_func
(paren
id|resp
comma
l_int|112
comma
l_int|3
)paren
suffix:semicolon
id|csd-&gt;tacc_ns
op_assign
(paren
id|tacc_exp
(braket
id|e
)braket
op_star
id|tacc_mant
(braket
id|m
)braket
op_plus
l_int|9
)paren
op_div
l_int|10
suffix:semicolon
id|csd-&gt;tacc_clks
op_assign
id|UNSTUFF_BITS
c_func
(paren
id|resp
comma
l_int|104
comma
l_int|8
)paren
op_star
l_int|100
suffix:semicolon
id|m
op_assign
id|UNSTUFF_BITS
c_func
(paren
id|resp
comma
l_int|99
comma
l_int|4
)paren
suffix:semicolon
id|e
op_assign
id|UNSTUFF_BITS
c_func
(paren
id|resp
comma
l_int|96
comma
l_int|3
)paren
suffix:semicolon
id|csd-&gt;max_dtr
op_assign
id|tran_exp
(braket
id|e
)braket
op_star
id|tran_mant
(braket
id|m
)braket
suffix:semicolon
id|csd-&gt;cmdclass
op_assign
id|UNSTUFF_BITS
c_func
(paren
id|resp
comma
l_int|84
comma
l_int|12
)paren
suffix:semicolon
id|e
op_assign
id|UNSTUFF_BITS
c_func
(paren
id|resp
comma
l_int|47
comma
l_int|3
)paren
suffix:semicolon
id|m
op_assign
id|UNSTUFF_BITS
c_func
(paren
id|resp
comma
l_int|62
comma
l_int|12
)paren
suffix:semicolon
id|csd-&gt;capacity
op_assign
(paren
l_int|1
op_plus
id|m
)paren
op_lshift
(paren
id|e
op_plus
l_int|2
)paren
suffix:semicolon
id|csd-&gt;read_blkbits
op_assign
id|UNSTUFF_BITS
c_func
(paren
id|resp
comma
l_int|80
comma
l_int|4
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Locate a MMC card on this MMC host given a raw CID.&n; */
DECL|function|mmc_find_card
r_static
r_struct
id|mmc_card
op_star
id|mmc_find_card
c_func
(paren
r_struct
id|mmc_host
op_star
id|host
comma
id|u32
op_star
id|raw_cid
)paren
(brace
r_struct
id|mmc_card
op_star
id|card
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|card
comma
op_amp
id|host-&gt;cards
comma
id|node
)paren
(brace
r_if
c_cond
(paren
id|memcmp
c_func
(paren
id|card-&gt;raw_cid
comma
id|raw_cid
comma
r_sizeof
(paren
id|card-&gt;raw_cid
)paren
)paren
op_eq
l_int|0
)paren
r_return
id|card
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; * Allocate a new MMC card, and assign a unique RCA.&n; */
r_static
r_struct
id|mmc_card
op_star
DECL|function|mmc_alloc_card
id|mmc_alloc_card
c_func
(paren
r_struct
id|mmc_host
op_star
id|host
comma
id|u32
op_star
id|raw_cid
comma
r_int
r_int
op_star
id|frca
)paren
(brace
r_struct
id|mmc_card
op_star
id|card
comma
op_star
id|c
suffix:semicolon
r_int
r_int
id|rca
op_assign
op_star
id|frca
suffix:semicolon
id|card
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|mmc_card
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|card
)paren
r_return
id|ERR_PTR
c_func
(paren
op_minus
id|ENOMEM
)paren
suffix:semicolon
id|mmc_init_card
c_func
(paren
id|card
comma
id|host
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|card-&gt;raw_cid
comma
id|raw_cid
comma
r_sizeof
(paren
id|card-&gt;raw_cid
)paren
)paren
suffix:semicolon
id|again
suffix:colon
id|list_for_each_entry
c_func
(paren
id|c
comma
op_amp
id|host-&gt;cards
comma
id|node
)paren
r_if
c_cond
(paren
id|c-&gt;rca
op_eq
id|rca
)paren
(brace
id|rca
op_increment
suffix:semicolon
r_goto
id|again
suffix:semicolon
)brace
id|card-&gt;rca
op_assign
id|rca
suffix:semicolon
op_star
id|frca
op_assign
id|rca
suffix:semicolon
r_return
id|card
suffix:semicolon
)brace
multiline_comment|/*&n; * Tell attached cards to go to IDLE state&n; */
DECL|function|mmc_idle_cards
r_static
r_void
id|mmc_idle_cards
c_func
(paren
r_struct
id|mmc_host
op_star
id|host
)paren
(brace
r_struct
id|mmc_command
id|cmd
suffix:semicolon
id|cmd.opcode
op_assign
id|MMC_GO_IDLE_STATE
suffix:semicolon
id|cmd.arg
op_assign
l_int|0
suffix:semicolon
id|cmd.flags
op_assign
id|MMC_RSP_NONE
suffix:semicolon
id|mmc_wait_for_cmd
c_func
(paren
id|host
comma
op_amp
id|cmd
comma
l_int|0
)paren
suffix:semicolon
id|mmc_delay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Apply power to the MMC stack.&n; */
DECL|function|mmc_power_up
r_static
r_void
id|mmc_power_up
c_func
(paren
r_struct
id|mmc_host
op_star
id|host
)paren
(brace
r_int
id|bit
op_assign
id|fls
c_func
(paren
id|host-&gt;ocr_avail
)paren
op_minus
l_int|1
suffix:semicolon
id|host-&gt;ios.vdd
op_assign
id|bit
suffix:semicolon
id|host-&gt;ios.bus_mode
op_assign
id|MMC_BUSMODE_OPENDRAIN
suffix:semicolon
id|host-&gt;ios.power_mode
op_assign
id|MMC_POWER_UP
suffix:semicolon
id|host-&gt;ops
op_member_access_from_pointer
id|set_ios
c_func
(paren
id|host
comma
op_amp
id|host-&gt;ios
)paren
suffix:semicolon
id|mmc_delay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|host-&gt;ios.clock
op_assign
id|host-&gt;f_min
suffix:semicolon
id|host-&gt;ios.power_mode
op_assign
id|MMC_POWER_ON
suffix:semicolon
id|host-&gt;ops
op_member_access_from_pointer
id|set_ios
c_func
(paren
id|host
comma
op_amp
id|host-&gt;ios
)paren
suffix:semicolon
id|mmc_delay
c_func
(paren
l_int|2
)paren
suffix:semicolon
)brace
DECL|function|mmc_power_off
r_static
r_void
id|mmc_power_off
c_func
(paren
r_struct
id|mmc_host
op_star
id|host
)paren
(brace
id|host-&gt;ios.clock
op_assign
l_int|0
suffix:semicolon
id|host-&gt;ios.vdd
op_assign
l_int|0
suffix:semicolon
id|host-&gt;ios.bus_mode
op_assign
id|MMC_BUSMODE_OPENDRAIN
suffix:semicolon
id|host-&gt;ios.power_mode
op_assign
id|MMC_POWER_OFF
suffix:semicolon
id|host-&gt;ops
op_member_access_from_pointer
id|set_ios
c_func
(paren
id|host
comma
op_amp
id|host-&gt;ios
)paren
suffix:semicolon
)brace
DECL|function|mmc_send_op_cond
r_static
r_int
id|mmc_send_op_cond
c_func
(paren
r_struct
id|mmc_host
op_star
id|host
comma
id|u32
id|ocr
comma
id|u32
op_star
id|rocr
)paren
(brace
r_struct
id|mmc_command
id|cmd
suffix:semicolon
r_int
id|i
comma
id|err
op_assign
l_int|0
suffix:semicolon
id|cmd.opcode
op_assign
id|MMC_SEND_OP_COND
suffix:semicolon
id|cmd.arg
op_assign
id|ocr
suffix:semicolon
id|cmd.flags
op_assign
id|MMC_RSP_R3
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|100
suffix:semicolon
id|i
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|err
op_assign
id|mmc_wait_for_cmd
c_func
(paren
id|host
comma
op_amp
id|cmd
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_ne
id|MMC_ERR_NONE
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|cmd.resp
(braket
l_int|0
)braket
op_amp
id|MMC_CARD_BUSY
op_logical_or
id|ocr
op_eq
l_int|0
)paren
r_break
suffix:semicolon
id|err
op_assign
id|MMC_ERR_TIMEOUT
suffix:semicolon
id|mmc_delay
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rocr
)paren
op_star
id|rocr
op_assign
id|cmd.resp
(braket
l_int|0
)braket
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*&n; * Discover cards by requesting their CID.  If this command&n; * times out, it is not an error; there are no further cards&n; * to be discovered.  Add new cards to the list.&n; *&n; * Create a mmc_card entry for each discovered card, assigning&n; * it an RCA, and save the raw CID for decoding later.&n; */
DECL|function|mmc_discover_cards
r_static
r_void
id|mmc_discover_cards
c_func
(paren
r_struct
id|mmc_host
op_star
id|host
)paren
(brace
r_struct
id|mmc_card
op_star
id|card
suffix:semicolon
r_int
r_int
id|first_rca
op_assign
l_int|1
comma
id|err
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
r_struct
id|mmc_command
id|cmd
suffix:semicolon
id|cmd.opcode
op_assign
id|MMC_ALL_SEND_CID
suffix:semicolon
id|cmd.arg
op_assign
l_int|0
suffix:semicolon
id|cmd.flags
op_assign
id|MMC_RSP_R2
suffix:semicolon
id|err
op_assign
id|mmc_wait_for_cmd
c_func
(paren
id|host
comma
op_amp
id|cmd
comma
id|CMD_RETRIES
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_eq
id|MMC_ERR_TIMEOUT
)paren
(brace
id|err
op_assign
id|MMC_ERR_NONE
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|err
op_ne
id|MMC_ERR_NONE
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: error requesting CID: %d&bslash;n&quot;
comma
id|host-&gt;host_name
comma
id|err
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|card
op_assign
id|mmc_find_card
c_func
(paren
id|host
comma
id|cmd.resp
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|card
)paren
(brace
id|card
op_assign
id|mmc_alloc_card
c_func
(paren
id|host
comma
id|cmd.resp
comma
op_amp
id|first_rca
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|card
)paren
)paren
(brace
id|err
op_assign
id|PTR_ERR
c_func
(paren
id|card
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|list_add
c_func
(paren
op_amp
id|card-&gt;node
comma
op_amp
id|host-&gt;cards
)paren
suffix:semicolon
)brace
id|card-&gt;state
op_and_assign
op_complement
id|MMC_STATE_DEAD
suffix:semicolon
id|cmd.opcode
op_assign
id|MMC_SET_RELATIVE_ADDR
suffix:semicolon
id|cmd.arg
op_assign
id|card-&gt;rca
op_lshift
l_int|16
suffix:semicolon
id|cmd.flags
op_assign
id|MMC_RSP_R1
suffix:semicolon
id|err
op_assign
id|mmc_wait_for_cmd
c_func
(paren
id|host
comma
op_amp
id|cmd
comma
id|CMD_RETRIES
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_ne
id|MMC_ERR_NONE
)paren
id|mmc_card_set_dead
c_func
(paren
id|card
)paren
suffix:semicolon
)brace
)brace
DECL|function|mmc_read_csds
r_static
r_void
id|mmc_read_csds
c_func
(paren
r_struct
id|mmc_host
op_star
id|host
)paren
(brace
r_struct
id|mmc_card
op_star
id|card
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|card
comma
op_amp
id|host-&gt;cards
comma
id|node
)paren
(brace
r_struct
id|mmc_command
id|cmd
suffix:semicolon
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;state
op_amp
(paren
id|MMC_STATE_DEAD
op_or
id|MMC_STATE_PRESENT
)paren
)paren
r_continue
suffix:semicolon
id|cmd.opcode
op_assign
id|MMC_SEND_CSD
suffix:semicolon
id|cmd.arg
op_assign
id|card-&gt;rca
op_lshift
l_int|16
suffix:semicolon
id|cmd.flags
op_assign
id|MMC_RSP_R2
suffix:semicolon
id|err
op_assign
id|mmc_wait_for_cmd
c_func
(paren
id|host
comma
op_amp
id|cmd
comma
id|CMD_RETRIES
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_ne
id|MMC_ERR_NONE
)paren
(brace
id|mmc_card_set_dead
c_func
(paren
id|card
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|card-&gt;raw_csd
comma
id|cmd.resp
comma
r_sizeof
(paren
id|card-&gt;raw_csd
)paren
)paren
suffix:semicolon
id|mmc_decode_csd
c_func
(paren
id|card
)paren
suffix:semicolon
id|mmc_decode_cid
c_func
(paren
id|card
)paren
suffix:semicolon
)brace
)brace
DECL|function|mmc_calculate_clock
r_static
r_int
r_int
id|mmc_calculate_clock
c_func
(paren
r_struct
id|mmc_host
op_star
id|host
)paren
(brace
r_struct
id|mmc_card
op_star
id|card
suffix:semicolon
r_int
r_int
id|max_dtr
op_assign
id|host-&gt;f_max
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|card
comma
op_amp
id|host-&gt;cards
comma
id|node
)paren
r_if
c_cond
(paren
op_logical_neg
id|mmc_card_dead
c_func
(paren
id|card
)paren
op_logical_and
id|max_dtr
OG
id|card-&gt;csd.max_dtr
)paren
id|max_dtr
op_assign
id|card-&gt;csd.max_dtr
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;MMC: selected %d.%03dMHz transfer rate&bslash;n&quot;
comma
id|max_dtr
op_div
l_int|1000000
comma
(paren
id|max_dtr
op_div
l_int|1000
)paren
op_mod
l_int|1000
)paren
suffix:semicolon
r_return
id|max_dtr
suffix:semicolon
)brace
multiline_comment|/*&n; * Check whether cards we already know about are still present.&n; * We do this by requesting status, and checking whether a card&n; * responds.&n; *&n; * A request for status does not cause a state change in data&n; * transfer mode.&n; */
DECL|function|mmc_check_cards
r_static
r_void
id|mmc_check_cards
c_func
(paren
r_struct
id|mmc_host
op_star
id|host
)paren
(brace
r_struct
id|list_head
op_star
id|l
comma
op_star
id|n
suffix:semicolon
id|mmc_deselect_cards
c_func
(paren
id|host
)paren
suffix:semicolon
id|list_for_each_safe
c_func
(paren
id|l
comma
id|n
comma
op_amp
id|host-&gt;cards
)paren
(brace
r_struct
id|mmc_card
op_star
id|card
op_assign
id|mmc_list_to_card
c_func
(paren
id|l
)paren
suffix:semicolon
r_struct
id|mmc_command
id|cmd
suffix:semicolon
r_int
id|err
suffix:semicolon
id|cmd.opcode
op_assign
id|MMC_SEND_STATUS
suffix:semicolon
id|cmd.arg
op_assign
id|card-&gt;rca
op_lshift
l_int|16
suffix:semicolon
id|cmd.flags
op_assign
id|MMC_RSP_R1
suffix:semicolon
id|err
op_assign
id|mmc_wait_for_cmd
c_func
(paren
id|host
comma
op_amp
id|cmd
comma
id|CMD_RETRIES
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_eq
id|MMC_ERR_NONE
)paren
r_continue
suffix:semicolon
id|mmc_card_set_dead
c_func
(paren
id|card
)paren
suffix:semicolon
)brace
)brace
DECL|function|mmc_setup
r_static
r_void
id|mmc_setup
c_func
(paren
r_struct
id|mmc_host
op_star
id|host
)paren
(brace
r_if
c_cond
(paren
id|host-&gt;ios.power_mode
op_ne
id|MMC_POWER_ON
)paren
(brace
r_int
id|err
suffix:semicolon
id|u32
id|ocr
suffix:semicolon
id|mmc_power_up
c_func
(paren
id|host
)paren
suffix:semicolon
id|mmc_idle_cards
c_func
(paren
id|host
)paren
suffix:semicolon
id|err
op_assign
id|mmc_send_op_cond
c_func
(paren
id|host
comma
l_int|0
comma
op_amp
id|ocr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_ne
id|MMC_ERR_NONE
)paren
r_return
suffix:semicolon
id|host-&gt;ocr
op_assign
id|mmc_select_voltage
c_func
(paren
id|host
comma
id|ocr
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Since we&squot;re changing the OCR value, we seem to&n;&t;&t; * need to tell some cards to go back to the idle&n;&t;&t; * state.  We wait 1ms to give cards time to&n;&t;&t; * respond.&n;&t;&t; */
r_if
c_cond
(paren
id|host-&gt;ocr
)paren
id|mmc_idle_cards
c_func
(paren
id|host
)paren
suffix:semicolon
)brace
r_else
(brace
id|host-&gt;ios.bus_mode
op_assign
id|MMC_BUSMODE_OPENDRAIN
suffix:semicolon
id|host-&gt;ios.clock
op_assign
id|host-&gt;f_min
suffix:semicolon
id|host-&gt;ops
op_member_access_from_pointer
id|set_ios
c_func
(paren
id|host
comma
op_amp
id|host-&gt;ios
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * We should remember the OCR mask from the existing&n;&t;&t; * cards, and detect the new cards OCR mask, combine&n;&t;&t; * the two and re-select the VDD.  However, if we do&n;&t;&t; * change VDD, we should do an idle, and then do a&n;&t;&t; * full re-initialisation.  We would need to notify&n;&t;&t; * drivers so that they can re-setup the cards as&n;&t;&t; * well, while keeping their queues at bay.&n;&t;&t; *&n;&t;&t; * For the moment, we take the easy way out - if the&n;&t;&t; * new cards don&squot;t like our currently selected VDD,&n;&t;&t; * they drop off the bus.&n;&t;&t; */
)brace
r_if
c_cond
(paren
id|host-&gt;ocr
op_eq
l_int|0
)paren
r_return
suffix:semicolon
multiline_comment|/*&n;&t; * Send the selected OCR multiple times... until the cards&n;&t; * all get the idea that they should be ready for CMD2.&n;&t; * (My SanDisk card seems to need this.)&n;&t; */
id|mmc_send_op_cond
c_func
(paren
id|host
comma
id|host-&gt;ocr
comma
l_int|NULL
)paren
suffix:semicolon
id|mmc_discover_cards
c_func
(paren
id|host
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Ok, now switch to push-pull mode.&n;&t; */
id|host-&gt;ios.bus_mode
op_assign
id|MMC_BUSMODE_PUSHPULL
suffix:semicolon
id|host-&gt;ops
op_member_access_from_pointer
id|set_ios
c_func
(paren
id|host
comma
op_amp
id|host-&gt;ios
)paren
suffix:semicolon
id|mmc_read_csds
c_func
(paren
id|host
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;mmc_detect_change - process change of state on a MMC socket&n; *&t;@host: host which changed state.&n; *&n; *&t;All we know is that card(s) have been inserted or removed&n; *&t;from the socket(s).  We don&squot;t know which socket or cards.&n; */
DECL|function|mmc_detect_change
r_void
id|mmc_detect_change
c_func
(paren
r_struct
id|mmc_host
op_star
id|host
)paren
(brace
id|schedule_work
c_func
(paren
op_amp
id|host-&gt;detect
)paren
suffix:semicolon
)brace
DECL|variable|mmc_detect_change
id|EXPORT_SYMBOL
c_func
(paren
id|mmc_detect_change
)paren
suffix:semicolon
DECL|function|mmc_rescan
r_static
r_void
id|mmc_rescan
c_func
(paren
r_void
op_star
id|data
)paren
(brace
r_struct
id|mmc_host
op_star
id|host
op_assign
id|data
suffix:semicolon
r_struct
id|list_head
op_star
id|l
comma
op_star
id|n
suffix:semicolon
id|mmc_claim_host
c_func
(paren
id|host
)paren
suffix:semicolon
r_if
c_cond
(paren
id|host-&gt;ios.power_mode
op_eq
id|MMC_POWER_ON
)paren
id|mmc_check_cards
c_func
(paren
id|host
)paren
suffix:semicolon
id|mmc_setup
c_func
(paren
id|host
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|host-&gt;cards
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t; * (Re-)calculate the fastest clock rate which the&n;&t;&t; * attached cards and the host support.&n;&t;&t; */
id|host-&gt;ios.clock
op_assign
id|mmc_calculate_clock
c_func
(paren
id|host
)paren
suffix:semicolon
id|host-&gt;ops
op_member_access_from_pointer
id|set_ios
c_func
(paren
id|host
comma
op_amp
id|host-&gt;ios
)paren
suffix:semicolon
)brace
id|mmc_release_host
c_func
(paren
id|host
)paren
suffix:semicolon
id|list_for_each_safe
c_func
(paren
id|l
comma
id|n
comma
op_amp
id|host-&gt;cards
)paren
(brace
r_struct
id|mmc_card
op_star
id|card
op_assign
id|mmc_list_to_card
c_func
(paren
id|l
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * If this is a new and good card, register it.&n;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
id|mmc_card_present
c_func
(paren
id|card
)paren
op_logical_and
op_logical_neg
id|mmc_card_dead
c_func
(paren
id|card
)paren
)paren
(brace
r_if
c_cond
(paren
id|mmc_register_card
c_func
(paren
id|card
)paren
)paren
id|mmc_card_set_dead
c_func
(paren
id|card
)paren
suffix:semicolon
r_else
id|mmc_card_set_present
c_func
(paren
id|card
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * If this card is dead, destroy it.&n;&t;&t; */
r_if
c_cond
(paren
id|mmc_card_dead
c_func
(paren
id|card
)paren
)paren
(brace
id|list_del
c_func
(paren
op_amp
id|card-&gt;node
)paren
suffix:semicolon
id|mmc_remove_card
c_func
(paren
id|card
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t; * If we discover that there are no cards on the&n;&t; * bus, turn off the clock and power down.&n;&t; */
r_if
c_cond
(paren
id|list_empty
c_func
(paren
op_amp
id|host-&gt;cards
)paren
)paren
id|mmc_power_off
c_func
(paren
id|host
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;mmc_alloc_host - initialise the per-host structure.&n; *&t;@extra: sizeof private data structure&n; *&t;@dev: pointer to host device model structure&n; *&n; *&t;Initialise the per-host structure.&n; */
DECL|function|mmc_alloc_host
r_struct
id|mmc_host
op_star
id|mmc_alloc_host
c_func
(paren
r_int
id|extra
comma
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|mmc_host
op_star
id|host
suffix:semicolon
id|host
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|mmc_host
)paren
op_plus
id|extra
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|host
)paren
(brace
id|memset
c_func
(paren
id|host
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|mmc_host
)paren
op_plus
id|extra
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|host-&gt;lock
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|host-&gt;wq
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|host-&gt;cards
)paren
suffix:semicolon
id|INIT_WORK
c_func
(paren
op_amp
id|host-&gt;detect
comma
id|mmc_rescan
comma
id|host
)paren
suffix:semicolon
id|host-&gt;dev
op_assign
id|dev
suffix:semicolon
multiline_comment|/*&n;&t;&t; * By default, hosts do not support SGIO or large requests.&n;&t;&t; * They have to set these according to their abilities.&n;&t;&t; */
id|host-&gt;max_hw_segs
op_assign
l_int|1
suffix:semicolon
id|host-&gt;max_phys_segs
op_assign
l_int|1
suffix:semicolon
id|host-&gt;max_sectors
op_assign
l_int|1
op_lshift
(paren
id|PAGE_CACHE_SHIFT
op_minus
l_int|9
)paren
suffix:semicolon
id|host-&gt;max_seg_size
op_assign
id|PAGE_CACHE_SIZE
suffix:semicolon
)brace
r_return
id|host
suffix:semicolon
)brace
DECL|variable|mmc_alloc_host
id|EXPORT_SYMBOL
c_func
(paren
id|mmc_alloc_host
)paren
suffix:semicolon
multiline_comment|/**&n; *&t;mmc_add_host - initialise host hardware&n; *&t;@host: mmc host&n; */
DECL|function|mmc_add_host
r_int
id|mmc_add_host
c_func
(paren
r_struct
id|mmc_host
op_star
id|host
)paren
(brace
r_static
r_int
r_int
id|host_num
suffix:semicolon
id|snprintf
c_func
(paren
id|host-&gt;host_name
comma
r_sizeof
(paren
id|host-&gt;host_name
)paren
comma
l_string|&quot;mmc%d&quot;
comma
id|host_num
op_increment
)paren
suffix:semicolon
id|mmc_power_off
c_func
(paren
id|host
)paren
suffix:semicolon
id|mmc_detect_change
c_func
(paren
id|host
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|mmc_add_host
id|EXPORT_SYMBOL
c_func
(paren
id|mmc_add_host
)paren
suffix:semicolon
multiline_comment|/**&n; *&t;mmc_remove_host - remove host hardware&n; *&t;@host: mmc host&n; *&n; *&t;Unregister and remove all cards associated with this host,&n; *&t;and power down the MMC bus.&n; */
DECL|function|mmc_remove_host
r_void
id|mmc_remove_host
c_func
(paren
r_struct
id|mmc_host
op_star
id|host
)paren
(brace
r_struct
id|list_head
op_star
id|l
comma
op_star
id|n
suffix:semicolon
id|list_for_each_safe
c_func
(paren
id|l
comma
id|n
comma
op_amp
id|host-&gt;cards
)paren
(brace
r_struct
id|mmc_card
op_star
id|card
op_assign
id|mmc_list_to_card
c_func
(paren
id|l
)paren
suffix:semicolon
id|mmc_remove_card
c_func
(paren
id|card
)paren
suffix:semicolon
)brace
id|mmc_power_off
c_func
(paren
id|host
)paren
suffix:semicolon
)brace
DECL|variable|mmc_remove_host
id|EXPORT_SYMBOL
c_func
(paren
id|mmc_remove_host
)paren
suffix:semicolon
multiline_comment|/**&n; *&t;mmc_free_host - free the host structure&n; *&t;@host: mmc host&n; *&n; *&t;Free the host once all references to it have been dropped.&n; */
DECL|function|mmc_free_host
r_void
id|mmc_free_host
c_func
(paren
r_struct
id|mmc_host
op_star
id|host
)paren
(brace
id|flush_scheduled_work
c_func
(paren
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|host
)paren
suffix:semicolon
)brace
DECL|variable|mmc_free_host
id|EXPORT_SYMBOL
c_func
(paren
id|mmc_free_host
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_PM
multiline_comment|/**&n; *&t;mmc_suspend_host - suspend a host&n; *&t;@host: mmc host&n; *&t;@state: suspend mode (PM_SUSPEND_xxx)&n; */
DECL|function|mmc_suspend_host
r_int
id|mmc_suspend_host
c_func
(paren
r_struct
id|mmc_host
op_star
id|host
comma
id|u32
id|state
)paren
(brace
id|mmc_claim_host
c_func
(paren
id|host
)paren
suffix:semicolon
id|mmc_deselect_cards
c_func
(paren
id|host
)paren
suffix:semicolon
id|mmc_power_off
c_func
(paren
id|host
)paren
suffix:semicolon
id|mmc_release_host
c_func
(paren
id|host
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|mmc_suspend_host
id|EXPORT_SYMBOL
c_func
(paren
id|mmc_suspend_host
)paren
suffix:semicolon
multiline_comment|/**&n; *&t;mmc_resume_host - resume a previously suspended host&n; *&t;@host: mmc host&n; */
DECL|function|mmc_resume_host
r_int
id|mmc_resume_host
c_func
(paren
r_struct
id|mmc_host
op_star
id|host
)paren
(brace
id|mmc_detect_change
c_func
(paren
id|host
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|mmc_resume_host
id|EXPORT_SYMBOL
c_func
(paren
id|mmc_resume_host
)paren
suffix:semicolon
macro_line|#endif
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
eof
