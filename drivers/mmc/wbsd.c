multiline_comment|/*&n; *  linux/drivers/mmc/wbsd.c&n; *&n; *  Copyright (C) 2004 Pierre Ossman, All Rights Reserved.&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License version 2 as&n; * published by the Free Software Foundation.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/moduleparam.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/device.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/blkdev.h&gt;
macro_line|#include &lt;linux/mmc/host.h&gt;
macro_line|#include &lt;linux/mmc/protocol.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &quot;wbsd.h&quot;
DECL|macro|DRIVER_NAME
mdefine_line|#define DRIVER_NAME &quot;wbsd&quot;
DECL|macro|DRIVER_VERSION
mdefine_line|#define DRIVER_VERSION &quot;1.0&quot;
macro_line|#ifdef CONFIG_MMC_DEBUG
DECL|macro|DBG
mdefine_line|#define DBG(x...) &bslash;&n;&t;printk(KERN_DEBUG DRIVER_NAME &quot;: &quot; x)
DECL|macro|DBGF
mdefine_line|#define DBGF(f, x...) &bslash;&n;&t;printk(KERN_DEBUG DRIVER_NAME &quot; [%s()]: &quot; f, __func__, ##x)
macro_line|#else
DECL|macro|DBG
mdefine_line|#define DBG(x...)&t;do { } while (0)
DECL|macro|DBGF
mdefine_line|#define DBGF(x...)&t;do { } while (0)
macro_line|#endif
DECL|variable|io
r_static
r_int
r_int
id|io
op_assign
l_int|0x248
suffix:semicolon
DECL|variable|irq
r_static
r_int
r_int
id|irq
op_assign
l_int|6
suffix:semicolon
DECL|variable|dma
r_static
r_int
id|dma
op_assign
l_int|2
suffix:semicolon
macro_line|#ifdef CONFIG_MMC_DEBUG
DECL|function|DBG_REG
r_void
id|DBG_REG
c_func
(paren
r_int
id|reg
comma
id|u8
id|value
)paren
(brace
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;wbsd: Register %d: 0x%02X %3d &squot;%c&squot; &quot;
comma
id|reg
comma
(paren
r_int
)paren
id|value
comma
(paren
r_int
)paren
id|value
comma
(paren
id|value
OL
l_int|0x20
)paren
ques
c_cond
l_char|&squot;.&squot;
suffix:colon
id|value
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|7
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
r_if
c_cond
(paren
id|value
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;x&quot;
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
l_string|&quot;.&quot;
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#else
DECL|macro|DBG_REG
mdefine_line|#define DBG_REG(r, v) do {}  while (0)
macro_line|#endif
multiline_comment|/*&n; * Basic functions&n; */
DECL|function|wbsd_unlock_config
r_static
r_inline
r_void
id|wbsd_unlock_config
c_func
(paren
r_struct
id|wbsd_host
op_star
id|host
)paren
(brace
id|outb
c_func
(paren
id|host-&gt;unlock_code
comma
id|host-&gt;config
)paren
suffix:semicolon
id|outb
c_func
(paren
id|host-&gt;unlock_code
comma
id|host-&gt;config
)paren
suffix:semicolon
)brace
DECL|function|wbsd_lock_config
r_static
r_inline
r_void
id|wbsd_lock_config
c_func
(paren
r_struct
id|wbsd_host
op_star
id|host
)paren
(brace
id|outb
c_func
(paren
id|LOCK_CODE
comma
id|host-&gt;config
)paren
suffix:semicolon
)brace
DECL|function|wbsd_write_config
r_static
r_inline
r_void
id|wbsd_write_config
c_func
(paren
r_struct
id|wbsd_host
op_star
id|host
comma
id|u8
id|reg
comma
id|u8
id|value
)paren
(brace
id|outb
c_func
(paren
id|reg
comma
id|host-&gt;config
)paren
suffix:semicolon
id|outb
c_func
(paren
id|value
comma
id|host-&gt;config
op_plus
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|wbsd_read_config
r_static
r_inline
id|u8
id|wbsd_read_config
c_func
(paren
r_struct
id|wbsd_host
op_star
id|host
comma
id|u8
id|reg
)paren
(brace
id|outb
c_func
(paren
id|reg
comma
id|host-&gt;config
)paren
suffix:semicolon
r_return
id|inb
c_func
(paren
id|host-&gt;config
op_plus
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|wbsd_write_index
r_static
r_inline
r_void
id|wbsd_write_index
c_func
(paren
r_struct
id|wbsd_host
op_star
id|host
comma
id|u8
id|index
comma
id|u8
id|value
)paren
(brace
id|outb
c_func
(paren
id|index
comma
id|host-&gt;base
op_plus
id|WBSD_IDXR
)paren
suffix:semicolon
id|outb
c_func
(paren
id|value
comma
id|host-&gt;base
op_plus
id|WBSD_DATAR
)paren
suffix:semicolon
)brace
DECL|function|wbsd_read_index
r_static
r_inline
id|u8
id|wbsd_read_index
c_func
(paren
r_struct
id|wbsd_host
op_star
id|host
comma
id|u8
id|index
)paren
(brace
id|outb
c_func
(paren
id|index
comma
id|host-&gt;base
op_plus
id|WBSD_IDXR
)paren
suffix:semicolon
r_return
id|inb
c_func
(paren
id|host-&gt;base
op_plus
id|WBSD_DATAR
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Common routines&n; */
DECL|function|wbsd_init_device
r_static
r_void
id|wbsd_init_device
c_func
(paren
r_struct
id|wbsd_host
op_star
id|host
)paren
(brace
id|u8
id|setup
comma
id|ier
suffix:semicolon
multiline_comment|/*&n;&t; * Reset chip (SD/MMC part) and fifo.&n;&t; */
id|setup
op_assign
id|wbsd_read_index
c_func
(paren
id|host
comma
id|WBSD_IDX_SETUP
)paren
suffix:semicolon
id|setup
op_or_assign
id|WBSD_FIFO_RESET
op_or
id|WBSD_SOFT_RESET
suffix:semicolon
id|wbsd_write_index
c_func
(paren
id|host
comma
id|WBSD_IDX_SETUP
comma
id|setup
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Read back default clock.&n;&t; */
id|host-&gt;clk
op_assign
id|wbsd_read_index
c_func
(paren
id|host
comma
id|WBSD_IDX_CLK
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Power down port.&n;&t; */
id|outb
c_func
(paren
id|WBSD_POWER_N
comma
id|host-&gt;base
op_plus
id|WBSD_CSR
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Set maximum timeout.&n;&t; */
id|wbsd_write_index
c_func
(paren
id|host
comma
id|WBSD_IDX_TAAC
comma
l_int|0x7F
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Enable interesting interrupts.&n;&t; */
id|ier
op_assign
l_int|0
suffix:semicolon
id|ier
op_or_assign
id|WBSD_EINT_CARD
suffix:semicolon
id|ier
op_or_assign
id|WBSD_EINT_FIFO_THRE
suffix:semicolon
id|ier
op_or_assign
id|WBSD_EINT_CCRC
suffix:semicolon
id|ier
op_or_assign
id|WBSD_EINT_TIMEOUT
suffix:semicolon
id|ier
op_or_assign
id|WBSD_EINT_CRC
suffix:semicolon
id|ier
op_or_assign
id|WBSD_EINT_TC
suffix:semicolon
id|outb
c_func
(paren
id|ier
comma
id|host-&gt;base
op_plus
id|WBSD_EIR
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Clear interrupts.&n;&t; */
id|inb
c_func
(paren
id|host-&gt;base
op_plus
id|WBSD_ISR
)paren
suffix:semicolon
)brace
DECL|function|wbsd_reset
r_static
r_void
id|wbsd_reset
c_func
(paren
r_struct
id|wbsd_host
op_star
id|host
)paren
(brace
id|u8
id|setup
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
id|DRIVER_NAME
l_string|&quot;: Resetting chip&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Soft reset of chip (SD/MMC part).&n;&t; */
id|setup
op_assign
id|wbsd_read_index
c_func
(paren
id|host
comma
id|WBSD_IDX_SETUP
)paren
suffix:semicolon
id|setup
op_or_assign
id|WBSD_SOFT_RESET
suffix:semicolon
id|wbsd_write_index
c_func
(paren
id|host
comma
id|WBSD_IDX_SETUP
comma
id|setup
)paren
suffix:semicolon
)brace
DECL|function|wbsd_request_end
r_static
r_void
id|wbsd_request_end
c_func
(paren
r_struct
id|wbsd_host
op_star
id|host
comma
r_struct
id|mmc_request
op_star
id|mrq
)paren
(brace
r_int
r_int
id|dmaflags
suffix:semicolon
id|DBGF
c_func
(paren
l_string|&quot;Ending request, cmd (%x)&bslash;n&quot;
comma
id|mrq-&gt;cmd-&gt;opcode
)paren
suffix:semicolon
r_if
c_cond
(paren
id|host-&gt;dma
op_ge
l_int|0
)paren
(brace
multiline_comment|/*&n;&t;&t; * Release ISA DMA controller.&n;&t;&t; */
id|dmaflags
op_assign
id|claim_dma_lock
c_func
(paren
)paren
suffix:semicolon
id|disable_dma
c_func
(paren
id|host-&gt;dma
)paren
suffix:semicolon
id|clear_dma_ff
c_func
(paren
id|host-&gt;dma
)paren
suffix:semicolon
id|release_dma_lock
c_func
(paren
id|dmaflags
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Disable DMA on host.&n;&t;&t; */
id|wbsd_write_index
c_func
(paren
id|host
comma
id|WBSD_IDX_DMA
comma
l_int|0
)paren
suffix:semicolon
)brace
id|host-&gt;mrq
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/*&n;&t; * MMC layer might call back into the driver so first unlock.&n;&t; */
id|spin_unlock
c_func
(paren
op_amp
id|host-&gt;lock
)paren
suffix:semicolon
id|mmc_request_done
c_func
(paren
id|host-&gt;mmc
comma
id|mrq
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|host-&gt;lock
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Scatter/gather functions&n; */
DECL|function|wbsd_init_sg
r_static
r_inline
r_void
id|wbsd_init_sg
c_func
(paren
r_struct
id|wbsd_host
op_star
id|host
comma
r_struct
id|mmc_data
op_star
id|data
)paren
(brace
multiline_comment|/*&n;&t; * Get info. about SG list from data structure.&n;&t; */
id|host-&gt;cur_sg
op_assign
id|data-&gt;sg
suffix:semicolon
id|host-&gt;num_sg
op_assign
id|data-&gt;sg_len
suffix:semicolon
id|host-&gt;offset
op_assign
l_int|0
suffix:semicolon
id|host-&gt;remain
op_assign
id|host-&gt;cur_sg-&gt;length
suffix:semicolon
)brace
DECL|function|wbsd_next_sg
r_static
r_inline
r_int
id|wbsd_next_sg
c_func
(paren
r_struct
id|wbsd_host
op_star
id|host
)paren
(brace
multiline_comment|/*&n;&t; * Skip to next SG entry.&n;&t; */
id|host-&gt;cur_sg
op_increment
suffix:semicolon
id|host-&gt;num_sg
op_decrement
suffix:semicolon
multiline_comment|/*&n;&t; * Any entries left?&n;&t; */
r_if
c_cond
(paren
id|host-&gt;num_sg
OG
l_int|0
)paren
(brace
id|host-&gt;offset
op_assign
l_int|0
suffix:semicolon
id|host-&gt;remain
op_assign
id|host-&gt;cur_sg-&gt;length
suffix:semicolon
)brace
r_return
id|host-&gt;num_sg
suffix:semicolon
)brace
DECL|function|wbsd_kmap_sg
r_static
r_inline
r_char
op_star
id|wbsd_kmap_sg
c_func
(paren
r_struct
id|wbsd_host
op_star
id|host
)paren
(brace
r_return
id|kmap_atomic
c_func
(paren
id|host-&gt;cur_sg-&gt;page
comma
id|KM_BIO_SRC_IRQ
)paren
op_plus
id|host-&gt;cur_sg-&gt;offset
suffix:semicolon
)brace
DECL|function|wbsd_kunmap_sg
r_static
r_inline
r_void
id|wbsd_kunmap_sg
c_func
(paren
r_struct
id|wbsd_host
op_star
id|host
)paren
(brace
id|kunmap_atomic
c_func
(paren
id|host-&gt;cur_sg-&gt;page
comma
id|KM_BIO_SRC_IRQ
)paren
suffix:semicolon
)brace
DECL|function|wbsd_sg_to_dma
r_static
r_inline
r_void
id|wbsd_sg_to_dma
c_func
(paren
r_struct
id|wbsd_host
op_star
id|host
comma
r_struct
id|mmc_data
op_star
id|data
)paren
(brace
r_int
r_int
id|len
comma
id|i
comma
id|size
suffix:semicolon
r_struct
id|scatterlist
op_star
id|sg
suffix:semicolon
r_char
op_star
id|dmabuf
op_assign
id|host-&gt;dma_buffer
suffix:semicolon
r_char
op_star
id|sgbuf
suffix:semicolon
id|size
op_assign
id|host-&gt;size
suffix:semicolon
id|sg
op_assign
id|data-&gt;sg
suffix:semicolon
id|len
op_assign
id|data-&gt;sg_len
suffix:semicolon
multiline_comment|/*&n;&t; * Just loop through all entries. Size might not&n;&t; * be the entire list though so make sure that&n;&t; * we do not transfer too much.&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
id|i
op_increment
)paren
(brace
id|sgbuf
op_assign
id|kmap_atomic
c_func
(paren
id|sg
(braket
id|i
)braket
dot
id|page
comma
id|KM_BIO_SRC_IRQ
)paren
op_plus
id|sg
(braket
id|i
)braket
dot
id|offset
suffix:semicolon
r_if
c_cond
(paren
id|size
OL
id|sg
(braket
id|i
)braket
dot
id|length
)paren
id|memcpy
c_func
(paren
id|dmabuf
comma
id|sgbuf
comma
id|size
)paren
suffix:semicolon
r_else
id|memcpy
c_func
(paren
id|dmabuf
comma
id|sgbuf
comma
id|sg
(braket
id|i
)braket
dot
id|length
)paren
suffix:semicolon
id|kunmap_atomic
c_func
(paren
id|sg
(braket
id|i
)braket
dot
id|page
comma
id|KM_BIO_SRC_IRQ
)paren
suffix:semicolon
id|dmabuf
op_add_assign
id|sg
(braket
id|i
)braket
dot
id|length
suffix:semicolon
r_if
c_cond
(paren
id|size
OL
id|sg
(braket
id|i
)braket
dot
id|length
)paren
id|size
op_assign
l_int|0
suffix:semicolon
r_else
id|size
op_sub_assign
id|sg
(braket
id|i
)braket
dot
id|length
suffix:semicolon
r_if
c_cond
(paren
id|size
op_eq
l_int|0
)paren
r_break
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Check that we didn&squot;t get a request to transfer&n;&t; * more data than can fit into the SG list.&n;&t; */
id|BUG_ON
c_func
(paren
id|size
op_ne
l_int|0
)paren
suffix:semicolon
id|host-&gt;size
op_sub_assign
id|size
suffix:semicolon
)brace
DECL|function|wbsd_dma_to_sg
r_static
r_inline
r_void
id|wbsd_dma_to_sg
c_func
(paren
r_struct
id|wbsd_host
op_star
id|host
comma
r_struct
id|mmc_data
op_star
id|data
)paren
(brace
r_int
r_int
id|len
comma
id|i
comma
id|size
suffix:semicolon
r_struct
id|scatterlist
op_star
id|sg
suffix:semicolon
r_char
op_star
id|dmabuf
op_assign
id|host-&gt;dma_buffer
suffix:semicolon
r_char
op_star
id|sgbuf
suffix:semicolon
id|size
op_assign
id|host-&gt;size
suffix:semicolon
id|sg
op_assign
id|data-&gt;sg
suffix:semicolon
id|len
op_assign
id|data-&gt;sg_len
suffix:semicolon
multiline_comment|/*&n;&t; * Just loop through all entries. Size might not&n;&t; * be the entire list though so make sure that&n;&t; * we do not transfer too much.&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
id|i
op_increment
)paren
(brace
id|sgbuf
op_assign
id|kmap_atomic
c_func
(paren
id|sg
(braket
id|i
)braket
dot
id|page
comma
id|KM_BIO_SRC_IRQ
)paren
op_plus
id|sg
(braket
id|i
)braket
dot
id|offset
suffix:semicolon
r_if
c_cond
(paren
id|size
OL
id|sg
(braket
id|i
)braket
dot
id|length
)paren
id|memcpy
c_func
(paren
id|sgbuf
comma
id|dmabuf
comma
id|size
)paren
suffix:semicolon
r_else
id|memcpy
c_func
(paren
id|sgbuf
comma
id|dmabuf
comma
id|sg
(braket
id|i
)braket
dot
id|length
)paren
suffix:semicolon
id|kunmap_atomic
c_func
(paren
id|sg
(braket
id|i
)braket
dot
id|page
comma
id|KM_BIO_SRC_IRQ
)paren
suffix:semicolon
id|dmabuf
op_add_assign
id|sg
(braket
id|i
)braket
dot
id|length
suffix:semicolon
r_if
c_cond
(paren
id|size
OL
id|sg
(braket
id|i
)braket
dot
id|length
)paren
id|size
op_assign
l_int|0
suffix:semicolon
r_else
id|size
op_sub_assign
id|sg
(braket
id|i
)braket
dot
id|length
suffix:semicolon
r_if
c_cond
(paren
id|size
op_eq
l_int|0
)paren
r_break
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Check that we didn&squot;t get a request to transfer&n;&t; * more data than can fit into the SG list.&n;&t; */
id|BUG_ON
c_func
(paren
id|size
op_ne
l_int|0
)paren
suffix:semicolon
id|host-&gt;size
op_sub_assign
id|size
suffix:semicolon
)brace
multiline_comment|/*&n; * Command handling&n; */
DECL|function|wbsd_get_short_reply
r_static
r_inline
r_void
id|wbsd_get_short_reply
c_func
(paren
r_struct
id|wbsd_host
op_star
id|host
comma
r_struct
id|mmc_command
op_star
id|cmd
)paren
(brace
multiline_comment|/*&n;&t; * Correct response type?&n;&t; */
r_if
c_cond
(paren
id|wbsd_read_index
c_func
(paren
id|host
comma
id|WBSD_IDX_RSPLEN
)paren
op_ne
id|WBSD_RSP_SHORT
)paren
(brace
id|cmd-&gt;error
op_assign
id|MMC_ERR_INVALID
suffix:semicolon
r_return
suffix:semicolon
)brace
id|cmd-&gt;resp
(braket
l_int|0
)braket
op_assign
id|wbsd_read_index
c_func
(paren
id|host
comma
id|WBSD_IDX_RESP12
)paren
op_lshift
l_int|24
suffix:semicolon
id|cmd-&gt;resp
(braket
l_int|0
)braket
op_or_assign
id|wbsd_read_index
c_func
(paren
id|host
comma
id|WBSD_IDX_RESP13
)paren
op_lshift
l_int|16
suffix:semicolon
id|cmd-&gt;resp
(braket
l_int|0
)braket
op_or_assign
id|wbsd_read_index
c_func
(paren
id|host
comma
id|WBSD_IDX_RESP14
)paren
op_lshift
l_int|8
suffix:semicolon
id|cmd-&gt;resp
(braket
l_int|0
)braket
op_or_assign
id|wbsd_read_index
c_func
(paren
id|host
comma
id|WBSD_IDX_RESP15
)paren
op_lshift
l_int|0
suffix:semicolon
id|cmd-&gt;resp
(braket
l_int|1
)braket
op_assign
id|wbsd_read_index
c_func
(paren
id|host
comma
id|WBSD_IDX_RESP16
)paren
op_lshift
l_int|24
suffix:semicolon
)brace
DECL|function|wbsd_get_long_reply
r_static
r_inline
r_void
id|wbsd_get_long_reply
c_func
(paren
r_struct
id|wbsd_host
op_star
id|host
comma
r_struct
id|mmc_command
op_star
id|cmd
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/*&n;&t; * Correct response type?&n;&t; */
r_if
c_cond
(paren
id|wbsd_read_index
c_func
(paren
id|host
comma
id|WBSD_IDX_RSPLEN
)paren
op_ne
id|WBSD_RSP_LONG
)paren
(brace
id|cmd-&gt;error
op_assign
id|MMC_ERR_INVALID
suffix:semicolon
r_return
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
id|cmd-&gt;resp
(braket
id|i
)braket
op_assign
id|wbsd_read_index
c_func
(paren
id|host
comma
id|WBSD_IDX_RESP1
op_plus
id|i
op_star
l_int|4
)paren
op_lshift
l_int|24
suffix:semicolon
id|cmd-&gt;resp
(braket
id|i
)braket
op_or_assign
id|wbsd_read_index
c_func
(paren
id|host
comma
id|WBSD_IDX_RESP2
op_plus
id|i
op_star
l_int|4
)paren
op_lshift
l_int|16
suffix:semicolon
id|cmd-&gt;resp
(braket
id|i
)braket
op_or_assign
id|wbsd_read_index
c_func
(paren
id|host
comma
id|WBSD_IDX_RESP3
op_plus
id|i
op_star
l_int|4
)paren
op_lshift
l_int|8
suffix:semicolon
id|cmd-&gt;resp
(braket
id|i
)braket
op_or_assign
id|wbsd_read_index
c_func
(paren
id|host
comma
id|WBSD_IDX_RESP4
op_plus
id|i
op_star
l_int|4
)paren
op_lshift
l_int|0
suffix:semicolon
)brace
)brace
r_static
id|irqreturn_t
id|wbsd_irq
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
DECL|function|wbsd_send_command
r_static
r_void
id|wbsd_send_command
c_func
(paren
r_struct
id|wbsd_host
op_star
id|host
comma
r_struct
id|mmc_command
op_star
id|cmd
)paren
(brace
r_int
id|i
suffix:semicolon
id|u8
id|status
comma
id|eir
comma
id|isr
suffix:semicolon
id|DBGF
c_func
(paren
l_string|&quot;Sending cmd (%x)&bslash;n&quot;
comma
id|cmd-&gt;opcode
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Disable interrupts as the interrupt routine&n;&t; * will destroy the contents of ISR.&n;&t; */
id|eir
op_assign
id|inb
c_func
(paren
id|host-&gt;base
op_plus
id|WBSD_EIR
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|host-&gt;base
op_plus
id|WBSD_EIR
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Send the command (CRC calculated by host).&n;&t; */
id|outb
c_func
(paren
id|cmd-&gt;opcode
comma
id|host-&gt;base
op_plus
id|WBSD_CMDR
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|3
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
id|outb
c_func
(paren
(paren
id|cmd-&gt;arg
op_rshift
(paren
id|i
op_star
l_int|8
)paren
)paren
op_amp
l_int|0xff
comma
id|host-&gt;base
op_plus
id|WBSD_CMDR
)paren
suffix:semicolon
id|cmd-&gt;error
op_assign
id|MMC_ERR_NONE
suffix:semicolon
multiline_comment|/*&n;&t; * Wait for the request to complete.&n;&t; */
r_do
(brace
id|status
op_assign
id|wbsd_read_index
c_func
(paren
id|host
comma
id|WBSD_IDX_STATUS
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|status
op_amp
id|WBSD_CARDTRAFFIC
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Do we expect a reply?&n;&t; */
r_if
c_cond
(paren
(paren
id|cmd-&gt;flags
op_amp
id|MMC_RSP_MASK
)paren
op_ne
id|MMC_RSP_NONE
)paren
(brace
multiline_comment|/*&n;&t;&t; * Read back status.&n;&t;&t; */
id|isr
op_assign
id|inb
c_func
(paren
id|host-&gt;base
op_plus
id|WBSD_ISR
)paren
suffix:semicolon
multiline_comment|/* Card removed? */
r_if
c_cond
(paren
id|isr
op_amp
id|WBSD_INT_CARD
)paren
id|cmd-&gt;error
op_assign
id|MMC_ERR_TIMEOUT
suffix:semicolon
multiline_comment|/* Timeout? */
r_else
r_if
c_cond
(paren
id|isr
op_amp
id|WBSD_INT_TIMEOUT
)paren
id|cmd-&gt;error
op_assign
id|MMC_ERR_TIMEOUT
suffix:semicolon
multiline_comment|/* CRC? */
r_else
r_if
c_cond
(paren
(paren
id|cmd-&gt;flags
op_amp
id|MMC_RSP_CRC
)paren
op_logical_and
(paren
id|isr
op_amp
id|WBSD_INT_CRC
)paren
)paren
id|cmd-&gt;error
op_assign
id|MMC_ERR_BADCRC
suffix:semicolon
multiline_comment|/* All ok */
r_else
(brace
r_if
c_cond
(paren
(paren
id|cmd-&gt;flags
op_amp
id|MMC_RSP_MASK
)paren
op_eq
id|MMC_RSP_SHORT
)paren
id|wbsd_get_short_reply
c_func
(paren
id|host
comma
id|cmd
)paren
suffix:semicolon
r_else
id|wbsd_get_long_reply
c_func
(paren
id|host
comma
id|cmd
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t; * Restore interrupt mask to previous value.&n;&t; */
id|outb
c_func
(paren
id|eir
comma
id|host-&gt;base
op_plus
id|WBSD_EIR
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Call the interrupt routine to jump start&n;&t; * interrupts.&n;&t; */
id|wbsd_irq
c_func
(paren
l_int|0
comma
id|host
comma
l_int|NULL
)paren
suffix:semicolon
id|DBGF
c_func
(paren
l_string|&quot;Sent cmd (%x), res %d&bslash;n&quot;
comma
id|cmd-&gt;opcode
comma
id|cmd-&gt;error
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Data functions&n; */
DECL|function|wbsd_empty_fifo
r_static
r_void
id|wbsd_empty_fifo
c_func
(paren
r_struct
id|wbsd_host
op_star
id|host
)paren
(brace
r_struct
id|mmc_data
op_star
id|data
op_assign
id|host-&gt;mrq-&gt;cmd-&gt;data
suffix:semicolon
r_char
op_star
id|buffer
suffix:semicolon
multiline_comment|/*&n;&t; * Handle excessive data.&n;&t; */
r_if
c_cond
(paren
id|data-&gt;bytes_xfered
op_eq
id|host-&gt;size
)paren
r_return
suffix:semicolon
id|buffer
op_assign
id|wbsd_kmap_sg
c_func
(paren
id|host
)paren
op_plus
id|host-&gt;offset
suffix:semicolon
multiline_comment|/*&n;&t; * Drain the fifo. This has a tendency to loop longer&n;&t; * than the FIFO length (usually one block).&n;&t; */
r_while
c_loop
(paren
op_logical_neg
(paren
id|inb
c_func
(paren
id|host-&gt;base
op_plus
id|WBSD_FSR
)paren
op_amp
id|WBSD_FIFO_EMPTY
)paren
)paren
(brace
op_star
id|buffer
op_assign
id|inb
c_func
(paren
id|host-&gt;base
op_plus
id|WBSD_DFR
)paren
suffix:semicolon
id|buffer
op_increment
suffix:semicolon
id|host-&gt;offset
op_increment
suffix:semicolon
id|host-&gt;remain
op_decrement
suffix:semicolon
id|data-&gt;bytes_xfered
op_increment
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Transfer done?&n;&t;&t; */
r_if
c_cond
(paren
id|data-&gt;bytes_xfered
op_eq
id|host-&gt;size
)paren
(brace
id|wbsd_kunmap_sg
c_func
(paren
id|host
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * End of scatter list entry?&n;&t;&t; */
r_if
c_cond
(paren
id|host-&gt;remain
op_eq
l_int|0
)paren
(brace
id|wbsd_kunmap_sg
c_func
(paren
id|host
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * Get next entry. Check if last.&n;&t;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
id|wbsd_next_sg
c_func
(paren
id|host
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t;&t;&t; * We should never reach this point.&n;&t;&t;&t;&t; * It means that we&squot;re trying to&n;&t;&t;&t;&t; * transfer more blocks than can fit&n;&t;&t;&t;&t; * into the scatter list.&n;&t;&t;&t;&t; */
id|BUG_ON
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|host-&gt;size
op_assign
id|data-&gt;bytes_xfered
suffix:semicolon
r_return
suffix:semicolon
)brace
id|buffer
op_assign
id|wbsd_kmap_sg
c_func
(paren
id|host
)paren
suffix:semicolon
)brace
)brace
id|wbsd_kunmap_sg
c_func
(paren
id|host
)paren
suffix:semicolon
)brace
DECL|function|wbsd_fill_fifo
r_static
r_void
id|wbsd_fill_fifo
c_func
(paren
r_struct
id|wbsd_host
op_star
id|host
)paren
(brace
r_struct
id|mmc_data
op_star
id|data
op_assign
id|host-&gt;mrq-&gt;cmd-&gt;data
suffix:semicolon
r_char
op_star
id|buffer
suffix:semicolon
multiline_comment|/*&n;&t; * Check that we aren&squot;t being called after the&n;&t; * entire buffer has been transfered.&n;&t; */
r_if
c_cond
(paren
id|data-&gt;bytes_xfered
op_eq
id|host-&gt;size
)paren
r_return
suffix:semicolon
id|buffer
op_assign
id|wbsd_kmap_sg
c_func
(paren
id|host
)paren
op_plus
id|host-&gt;offset
suffix:semicolon
multiline_comment|/*&n;&t; * Fill the fifo. This has a tendency to loop longer&n;&t; * than the FIFO length (usually one block).&n;&t; */
r_while
c_loop
(paren
op_logical_neg
(paren
id|inb
c_func
(paren
id|host-&gt;base
op_plus
id|WBSD_FSR
)paren
op_amp
id|WBSD_FIFO_FULL
)paren
)paren
(brace
id|outb
c_func
(paren
op_star
id|buffer
comma
id|host-&gt;base
op_plus
id|WBSD_DFR
)paren
suffix:semicolon
id|buffer
op_increment
suffix:semicolon
id|host-&gt;offset
op_increment
suffix:semicolon
id|host-&gt;remain
op_decrement
suffix:semicolon
id|data-&gt;bytes_xfered
op_increment
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Transfer done?&n;&t;&t; */
r_if
c_cond
(paren
id|data-&gt;bytes_xfered
op_eq
id|host-&gt;size
)paren
(brace
id|wbsd_kunmap_sg
c_func
(paren
id|host
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * End of scatter list entry?&n;&t;&t; */
r_if
c_cond
(paren
id|host-&gt;remain
op_eq
l_int|0
)paren
(brace
id|wbsd_kunmap_sg
c_func
(paren
id|host
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * Get next entry. Check if last.&n;&t;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
id|wbsd_next_sg
c_func
(paren
id|host
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t;&t;&t; * We should never reach this point.&n;&t;&t;&t;&t; * It means that we&squot;re trying to&n;&t;&t;&t;&t; * transfer more blocks than can fit&n;&t;&t;&t;&t; * into the scatter list.&n;&t;&t;&t;&t; */
id|BUG_ON
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|host-&gt;size
op_assign
id|data-&gt;bytes_xfered
suffix:semicolon
r_return
suffix:semicolon
)brace
id|buffer
op_assign
id|wbsd_kmap_sg
c_func
(paren
id|host
)paren
suffix:semicolon
)brace
)brace
id|wbsd_kunmap_sg
c_func
(paren
id|host
)paren
suffix:semicolon
)brace
DECL|function|wbsd_prepare_data
r_static
r_void
id|wbsd_prepare_data
c_func
(paren
r_struct
id|wbsd_host
op_star
id|host
comma
r_struct
id|mmc_data
op_star
id|data
)paren
(brace
id|u16
id|blksize
suffix:semicolon
id|u8
id|setup
suffix:semicolon
r_int
r_int
id|dmaflags
suffix:semicolon
id|DBGF
c_func
(paren
l_string|&quot;blksz %04x blks %04x flags %08x&bslash;n&quot;
comma
l_int|1
op_lshift
id|data-&gt;blksz_bits
comma
id|data-&gt;blocks
comma
id|data-&gt;flags
)paren
suffix:semicolon
id|DBGF
c_func
(paren
l_string|&quot;tsac %d ms nsac %d clk&bslash;n&quot;
comma
id|data-&gt;timeout_ns
op_div
l_int|1000000
comma
id|data-&gt;timeout_clks
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Calculate size.&n;&t; */
id|host-&gt;size
op_assign
id|data-&gt;blocks
op_lshift
id|data-&gt;blksz_bits
suffix:semicolon
multiline_comment|/*&n;&t; * Check timeout values for overflow.&n;&t; * (Yes, some cards cause this value to overflow).&n;&t; */
r_if
c_cond
(paren
id|data-&gt;timeout_ns
OG
l_int|127000000
)paren
id|wbsd_write_index
c_func
(paren
id|host
comma
id|WBSD_IDX_TAAC
comma
l_int|127
)paren
suffix:semicolon
r_else
id|wbsd_write_index
c_func
(paren
id|host
comma
id|WBSD_IDX_TAAC
comma
id|data-&gt;timeout_ns
op_div
l_int|1000000
)paren
suffix:semicolon
r_if
c_cond
(paren
id|data-&gt;timeout_clks
OG
l_int|255
)paren
id|wbsd_write_index
c_func
(paren
id|host
comma
id|WBSD_IDX_NSAC
comma
l_int|255
)paren
suffix:semicolon
r_else
id|wbsd_write_index
c_func
(paren
id|host
comma
id|WBSD_IDX_NSAC
comma
id|data-&gt;timeout_clks
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Inform the chip of how large blocks will be&n;&t; * sent. It needs this to determine when to&n;&t; * calculate CRC.&n;&t; *&n;&t; * Space for CRC must be included in the size.&n;&t; */
id|blksize
op_assign
(paren
l_int|1
op_lshift
id|data-&gt;blksz_bits
)paren
op_plus
l_int|2
suffix:semicolon
id|wbsd_write_index
c_func
(paren
id|host
comma
id|WBSD_IDX_PBSMSB
comma
(paren
id|blksize
op_rshift
l_int|4
)paren
op_amp
l_int|0xF0
)paren
suffix:semicolon
id|wbsd_write_index
c_func
(paren
id|host
comma
id|WBSD_IDX_PBSLSB
comma
id|blksize
op_amp
l_int|0xFF
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Clear the FIFO. This is needed even for DMA&n;&t; * transfers since the chip still uses the FIFO&n;&t; * internally.&n;&t; */
id|setup
op_assign
id|wbsd_read_index
c_func
(paren
id|host
comma
id|WBSD_IDX_SETUP
)paren
suffix:semicolon
id|setup
op_or_assign
id|WBSD_FIFO_RESET
suffix:semicolon
id|wbsd_write_index
c_func
(paren
id|host
comma
id|WBSD_IDX_SETUP
comma
id|setup
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * DMA transfer?&n;&t; */
r_if
c_cond
(paren
id|host-&gt;dma
op_ge
l_int|0
)paren
(brace
multiline_comment|/*&n;&t;&t; * The buffer for DMA is only 64 kB.&n;&t;&t; */
id|BUG_ON
c_func
(paren
id|host-&gt;size
OG
l_int|0x10000
)paren
suffix:semicolon
r_if
c_cond
(paren
id|host-&gt;size
OG
l_int|0x10000
)paren
(brace
id|data-&gt;error
op_assign
id|MMC_ERR_INVALID
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * Transfer data from the SG list to&n;&t;&t; * the DMA buffer.&n;&t;&t; */
r_if
c_cond
(paren
id|data-&gt;flags
op_amp
id|MMC_DATA_WRITE
)paren
id|wbsd_sg_to_dma
c_func
(paren
id|host
comma
id|data
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Initialise the ISA DMA controller.&n;&t;&t; */
id|dmaflags
op_assign
id|claim_dma_lock
c_func
(paren
)paren
suffix:semicolon
id|disable_dma
c_func
(paren
id|host-&gt;dma
)paren
suffix:semicolon
id|clear_dma_ff
c_func
(paren
id|host-&gt;dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|data-&gt;flags
op_amp
id|MMC_DATA_READ
)paren
id|set_dma_mode
c_func
(paren
id|host-&gt;dma
comma
id|DMA_MODE_READ
)paren
suffix:semicolon
r_else
id|set_dma_mode
c_func
(paren
id|host-&gt;dma
comma
id|DMA_MODE_WRITE
)paren
suffix:semicolon
id|set_dma_addr
c_func
(paren
id|host-&gt;dma
comma
id|host-&gt;dma_addr
)paren
suffix:semicolon
id|set_dma_count
c_func
(paren
id|host-&gt;dma
comma
id|host-&gt;size
)paren
suffix:semicolon
id|enable_dma
c_func
(paren
id|host-&gt;dma
)paren
suffix:semicolon
id|release_dma_lock
c_func
(paren
id|dmaflags
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Enable DMA on the host.&n;&t;&t; */
id|wbsd_write_index
c_func
(paren
id|host
comma
id|WBSD_IDX_DMA
comma
id|WBSD_DMA_SINGLE
op_or
id|WBSD_DMA_ENABLE
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t; * This flag is used to keep printk&n;&t;&t; * output to a minimum.&n;&t;&t; */
id|host-&gt;firsterr
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Initialise the SG list.&n;&t;&t; */
id|wbsd_init_sg
c_func
(paren
id|host
comma
id|data
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Turn off DMA.&n;&t;&t; */
id|wbsd_write_index
c_func
(paren
id|host
comma
id|WBSD_IDX_DMA
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Set up FIFO threshold levels (and fill&n;&t;&t; * buffer if doing a write).&n;&t;&t; */
r_if
c_cond
(paren
id|data-&gt;flags
op_amp
id|MMC_DATA_READ
)paren
(brace
id|wbsd_write_index
c_func
(paren
id|host
comma
id|WBSD_IDX_FIFOEN
comma
id|WBSD_FIFOEN_FULL
op_or
l_int|8
)paren
suffix:semicolon
)brace
r_else
(brace
id|wbsd_write_index
c_func
(paren
id|host
comma
id|WBSD_IDX_FIFOEN
comma
id|WBSD_FIFOEN_EMPTY
op_or
l_int|8
)paren
suffix:semicolon
id|wbsd_fill_fifo
c_func
(paren
id|host
)paren
suffix:semicolon
)brace
)brace
id|data-&gt;error
op_assign
id|MMC_ERR_NONE
suffix:semicolon
)brace
DECL|function|wbsd_finish_data
r_static
r_void
id|wbsd_finish_data
c_func
(paren
r_struct
id|wbsd_host
op_star
id|host
comma
r_struct
id|mmc_data
op_star
id|data
)paren
(brace
r_int
r_int
id|dmaflags
suffix:semicolon
r_int
id|count
suffix:semicolon
id|WARN_ON
c_func
(paren
id|host-&gt;mrq
op_eq
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Send a stop command if needed.&n;&t; */
r_if
c_cond
(paren
id|data-&gt;stop
)paren
id|wbsd_send_command
c_func
(paren
id|host
comma
id|data-&gt;stop
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * DMA transfer?&n;&t; */
r_if
c_cond
(paren
id|host-&gt;dma
op_ge
l_int|0
)paren
(brace
multiline_comment|/*&n;&t;&t; * Disable DMA on the host.&n;&t;&t; */
id|wbsd_write_index
c_func
(paren
id|host
comma
id|WBSD_IDX_DMA
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Turn of ISA DMA controller.&n;&t;&t; */
id|dmaflags
op_assign
id|claim_dma_lock
c_func
(paren
)paren
suffix:semicolon
id|disable_dma
c_func
(paren
id|host-&gt;dma
)paren
suffix:semicolon
id|clear_dma_ff
c_func
(paren
id|host-&gt;dma
)paren
suffix:semicolon
id|count
op_assign
id|get_dma_residue
c_func
(paren
id|host-&gt;dma
)paren
suffix:semicolon
id|release_dma_lock
c_func
(paren
id|dmaflags
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Any leftover data?&n;&t;&t; */
r_if
c_cond
(paren
id|count
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|DRIVER_NAME
l_string|&quot;: Incomplete DMA &quot;
l_string|&quot;transfer. %d bytes left.&bslash;n&quot;
comma
id|count
)paren
suffix:semicolon
id|data-&gt;error
op_assign
id|MMC_ERR_FAILED
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t;&t; * Transfer data from DMA buffer to&n;&t;&t;&t; * SG list.&n;&t;&t;&t; */
r_if
c_cond
(paren
id|data-&gt;flags
op_amp
id|MMC_DATA_READ
)paren
id|wbsd_dma_to_sg
c_func
(paren
id|host
comma
id|data
)paren
suffix:semicolon
id|data-&gt;bytes_xfered
op_assign
id|host-&gt;size
suffix:semicolon
)brace
)brace
id|DBGF
c_func
(paren
l_string|&quot;Ending data transfer (%d bytes)&bslash;n&quot;
comma
id|data-&gt;bytes_xfered
)paren
suffix:semicolon
id|wbsd_request_end
c_func
(paren
id|host
comma
id|host-&gt;mrq
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * MMC Callbacks&n; */
DECL|function|wbsd_request
r_static
r_void
id|wbsd_request
c_func
(paren
r_struct
id|mmc_host
op_star
id|mmc
comma
r_struct
id|mmc_request
op_star
id|mrq
)paren
(brace
r_struct
id|wbsd_host
op_star
id|host
op_assign
id|mmc_priv
c_func
(paren
id|mmc
)paren
suffix:semicolon
r_struct
id|mmc_command
op_star
id|cmd
suffix:semicolon
multiline_comment|/*&n;&t; * Disable tasklets to avoid a deadlock.&n;&t; */
id|spin_lock_bh
c_func
(paren
op_amp
id|host-&gt;lock
)paren
suffix:semicolon
id|BUG_ON
c_func
(paren
id|host-&gt;mrq
op_ne
l_int|NULL
)paren
suffix:semicolon
id|cmd
op_assign
id|mrq-&gt;cmd
suffix:semicolon
id|host-&gt;mrq
op_assign
id|mrq
suffix:semicolon
multiline_comment|/*&n;&t; * If there is no card in the slot then&n;&t; * timeout immediatly.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|inb
c_func
(paren
id|host-&gt;base
op_plus
id|WBSD_CSR
)paren
op_amp
id|WBSD_CARDPRESENT
)paren
)paren
(brace
id|cmd-&gt;error
op_assign
id|MMC_ERR_TIMEOUT
suffix:semicolon
r_goto
id|done
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Does the request include data?&n;&t; */
r_if
c_cond
(paren
id|cmd-&gt;data
)paren
(brace
id|wbsd_prepare_data
c_func
(paren
id|host
comma
id|cmd-&gt;data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmd-&gt;data-&gt;error
op_ne
id|MMC_ERR_NONE
)paren
r_goto
id|done
suffix:semicolon
)brace
id|wbsd_send_command
c_func
(paren
id|host
comma
id|cmd
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * If this is a data transfer the request&n;&t; * will be finished after the data has&n;&t; * transfered.&n;&t; */
r_if
c_cond
(paren
id|cmd-&gt;data
op_logical_and
(paren
id|cmd-&gt;error
op_eq
id|MMC_ERR_NONE
)paren
)paren
(brace
id|spin_unlock_bh
c_func
(paren
op_amp
id|host-&gt;lock
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|done
suffix:colon
id|wbsd_request_end
c_func
(paren
id|host
comma
id|mrq
)paren
suffix:semicolon
id|spin_unlock_bh
c_func
(paren
op_amp
id|host-&gt;lock
)paren
suffix:semicolon
)brace
DECL|function|wbsd_set_ios
r_static
r_void
id|wbsd_set_ios
c_func
(paren
r_struct
id|mmc_host
op_star
id|mmc
comma
r_struct
id|mmc_ios
op_star
id|ios
)paren
(brace
r_struct
id|wbsd_host
op_star
id|host
op_assign
id|mmc_priv
c_func
(paren
id|mmc
)paren
suffix:semicolon
id|u8
id|clk
comma
id|setup
comma
id|pwr
suffix:semicolon
id|DBGF
c_func
(paren
l_string|&quot;clock %uHz busmode %u powermode %u Vdd %u&bslash;n&quot;
comma
id|ios-&gt;clock
comma
id|ios-&gt;bus_mode
comma
id|ios-&gt;power_mode
comma
id|ios-&gt;vdd
)paren
suffix:semicolon
id|spin_lock_bh
c_func
(paren
op_amp
id|host-&gt;lock
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Reset the chip on each power off.&n;&t; * Should clear out any weird states.&n;&t; */
r_if
c_cond
(paren
id|ios-&gt;power_mode
op_eq
id|MMC_POWER_OFF
)paren
id|wbsd_init_device
c_func
(paren
id|host
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ios-&gt;clock
op_ge
l_int|24000000
)paren
id|clk
op_assign
id|WBSD_CLK_24M
suffix:semicolon
r_else
r_if
c_cond
(paren
id|ios-&gt;clock
op_ge
l_int|16000000
)paren
id|clk
op_assign
id|WBSD_CLK_16M
suffix:semicolon
r_else
r_if
c_cond
(paren
id|ios-&gt;clock
op_ge
l_int|12000000
)paren
id|clk
op_assign
id|WBSD_CLK_12M
suffix:semicolon
r_else
id|clk
op_assign
id|WBSD_CLK_375K
suffix:semicolon
multiline_comment|/*&n;&t; * Only write to the clock register when&n;&t; * there is an actual change.&n;&t; */
r_if
c_cond
(paren
id|clk
op_ne
id|host-&gt;clk
)paren
(brace
id|wbsd_write_index
c_func
(paren
id|host
comma
id|WBSD_IDX_CLK
comma
id|clk
)paren
suffix:semicolon
id|host-&gt;clk
op_assign
id|clk
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ios-&gt;power_mode
op_ne
id|MMC_POWER_OFF
)paren
(brace
multiline_comment|/*&n;&t;&t; * Power up card.&n;&t;&t; */
id|pwr
op_assign
id|inb
c_func
(paren
id|host-&gt;base
op_plus
id|WBSD_CSR
)paren
suffix:semicolon
id|pwr
op_and_assign
op_complement
id|WBSD_POWER_N
suffix:semicolon
id|outb
c_func
(paren
id|pwr
comma
id|host-&gt;base
op_plus
id|WBSD_CSR
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * This behaviour is stolen from the&n;&t;&t; * Windows driver. Don&squot;t know why, but&n;&t;&t; * it is needed.&n;&t;&t; */
id|setup
op_assign
id|wbsd_read_index
c_func
(paren
id|host
comma
id|WBSD_IDX_SETUP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ios-&gt;bus_mode
op_eq
id|MMC_BUSMODE_OPENDRAIN
)paren
id|setup
op_or_assign
id|WBSD_DAT3_H
suffix:semicolon
r_else
id|setup
op_and_assign
op_complement
id|WBSD_DAT3_H
suffix:semicolon
id|wbsd_write_index
c_func
(paren
id|host
comma
id|WBSD_IDX_SETUP
comma
id|setup
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
id|spin_unlock_bh
c_func
(paren
op_amp
id|host-&gt;lock
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Tasklets&n; */
DECL|function|wbsd_get_data
r_inline
r_static
r_struct
id|mmc_data
op_star
id|wbsd_get_data
c_func
(paren
r_struct
id|wbsd_host
op_star
id|host
)paren
(brace
id|WARN_ON
c_func
(paren
op_logical_neg
id|host-&gt;mrq
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|host-&gt;mrq
)paren
r_return
l_int|NULL
suffix:semicolon
id|WARN_ON
c_func
(paren
op_logical_neg
id|host-&gt;mrq-&gt;cmd
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|host-&gt;mrq-&gt;cmd
)paren
r_return
l_int|NULL
suffix:semicolon
id|WARN_ON
c_func
(paren
op_logical_neg
id|host-&gt;mrq-&gt;cmd-&gt;data
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|host-&gt;mrq-&gt;cmd-&gt;data
)paren
r_return
l_int|NULL
suffix:semicolon
r_return
id|host-&gt;mrq-&gt;cmd-&gt;data
suffix:semicolon
)brace
DECL|function|wbsd_tasklet_card
r_static
r_void
id|wbsd_tasklet_card
c_func
(paren
r_int
r_int
id|param
)paren
(brace
r_struct
id|wbsd_host
op_star
id|host
op_assign
(paren
r_struct
id|wbsd_host
op_star
)paren
id|param
suffix:semicolon
id|u8
id|csr
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|host-&gt;lock
)paren
suffix:semicolon
id|csr
op_assign
id|inb
c_func
(paren
id|host-&gt;base
op_plus
id|WBSD_CSR
)paren
suffix:semicolon
id|WARN_ON
c_func
(paren
id|csr
op_eq
l_int|0xff
)paren
suffix:semicolon
r_if
c_cond
(paren
id|csr
op_amp
id|WBSD_CARDPRESENT
)paren
id|DBG
c_func
(paren
l_string|&quot;Card inserted&bslash;n&quot;
)paren
suffix:semicolon
r_else
(brace
id|DBG
c_func
(paren
l_string|&quot;Card removed&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|host-&gt;mrq
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|DRIVER_NAME
l_string|&quot;: Card removed during transfer!&bslash;n&quot;
)paren
suffix:semicolon
id|wbsd_reset
c_func
(paren
id|host
)paren
suffix:semicolon
id|host-&gt;mrq-&gt;cmd-&gt;error
op_assign
id|MMC_ERR_FAILED
suffix:semicolon
id|tasklet_schedule
c_func
(paren
op_amp
id|host-&gt;finish_tasklet
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t; * Unlock first since we might get a call back.&n;&t; */
id|spin_unlock
c_func
(paren
op_amp
id|host-&gt;lock
)paren
suffix:semicolon
id|mmc_detect_change
c_func
(paren
id|host-&gt;mmc
)paren
suffix:semicolon
)brace
DECL|function|wbsd_tasklet_fifo
r_static
r_void
id|wbsd_tasklet_fifo
c_func
(paren
r_int
r_int
id|param
)paren
(brace
r_struct
id|wbsd_host
op_star
id|host
op_assign
(paren
r_struct
id|wbsd_host
op_star
)paren
id|param
suffix:semicolon
r_struct
id|mmc_data
op_star
id|data
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|host-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|host-&gt;mrq
)paren
r_goto
id|end
suffix:semicolon
id|data
op_assign
id|wbsd_get_data
c_func
(paren
id|host
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|data
)paren
r_goto
id|end
suffix:semicolon
r_if
c_cond
(paren
id|data-&gt;flags
op_amp
id|MMC_DATA_WRITE
)paren
id|wbsd_fill_fifo
c_func
(paren
id|host
)paren
suffix:semicolon
r_else
id|wbsd_empty_fifo
c_func
(paren
id|host
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Done?&n;&t; */
r_if
c_cond
(paren
id|host-&gt;size
op_eq
id|data-&gt;bytes_xfered
)paren
(brace
id|wbsd_write_index
c_func
(paren
id|host
comma
id|WBSD_IDX_FIFOEN
comma
l_int|0
)paren
suffix:semicolon
id|tasklet_schedule
c_func
(paren
op_amp
id|host-&gt;finish_tasklet
)paren
suffix:semicolon
)brace
id|end
suffix:colon
id|spin_unlock
c_func
(paren
op_amp
id|host-&gt;lock
)paren
suffix:semicolon
)brace
DECL|function|wbsd_tasklet_crc
r_static
r_void
id|wbsd_tasklet_crc
c_func
(paren
r_int
r_int
id|param
)paren
(brace
r_struct
id|wbsd_host
op_star
id|host
op_assign
(paren
r_struct
id|wbsd_host
op_star
)paren
id|param
suffix:semicolon
r_struct
id|mmc_data
op_star
id|data
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|host-&gt;lock
)paren
suffix:semicolon
id|WARN_ON
c_func
(paren
op_logical_neg
id|host-&gt;mrq
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|host-&gt;mrq
)paren
r_goto
id|end
suffix:semicolon
id|data
op_assign
id|wbsd_get_data
c_func
(paren
id|host
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|data
)paren
r_goto
id|end
suffix:semicolon
id|DBGF
c_func
(paren
l_string|&quot;CRC error&bslash;n&quot;
)paren
suffix:semicolon
id|data-&gt;error
op_assign
id|MMC_ERR_BADCRC
suffix:semicolon
id|tasklet_schedule
c_func
(paren
op_amp
id|host-&gt;finish_tasklet
)paren
suffix:semicolon
id|end
suffix:colon
id|spin_unlock
c_func
(paren
op_amp
id|host-&gt;lock
)paren
suffix:semicolon
)brace
DECL|function|wbsd_tasklet_timeout
r_static
r_void
id|wbsd_tasklet_timeout
c_func
(paren
r_int
r_int
id|param
)paren
(brace
r_struct
id|wbsd_host
op_star
id|host
op_assign
(paren
r_struct
id|wbsd_host
op_star
)paren
id|param
suffix:semicolon
r_struct
id|mmc_data
op_star
id|data
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|host-&gt;lock
)paren
suffix:semicolon
id|WARN_ON
c_func
(paren
op_logical_neg
id|host-&gt;mrq
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|host-&gt;mrq
)paren
r_goto
id|end
suffix:semicolon
id|data
op_assign
id|wbsd_get_data
c_func
(paren
id|host
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|data
)paren
r_goto
id|end
suffix:semicolon
id|DBGF
c_func
(paren
l_string|&quot;Timeout&bslash;n&quot;
)paren
suffix:semicolon
id|data-&gt;error
op_assign
id|MMC_ERR_TIMEOUT
suffix:semicolon
id|tasklet_schedule
c_func
(paren
op_amp
id|host-&gt;finish_tasklet
)paren
suffix:semicolon
id|end
suffix:colon
id|spin_unlock
c_func
(paren
op_amp
id|host-&gt;lock
)paren
suffix:semicolon
)brace
DECL|function|wbsd_tasklet_finish
r_static
r_void
id|wbsd_tasklet_finish
c_func
(paren
r_int
r_int
id|param
)paren
(brace
r_struct
id|wbsd_host
op_star
id|host
op_assign
(paren
r_struct
id|wbsd_host
op_star
)paren
id|param
suffix:semicolon
r_struct
id|mmc_data
op_star
id|data
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|host-&gt;lock
)paren
suffix:semicolon
id|WARN_ON
c_func
(paren
op_logical_neg
id|host-&gt;mrq
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|host-&gt;mrq
)paren
r_goto
id|end
suffix:semicolon
id|data
op_assign
id|wbsd_get_data
c_func
(paren
id|host
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|data
)paren
r_goto
id|end
suffix:semicolon
id|wbsd_finish_data
c_func
(paren
id|host
comma
id|data
)paren
suffix:semicolon
id|end
suffix:colon
id|spin_unlock
c_func
(paren
op_amp
id|host-&gt;lock
)paren
suffix:semicolon
)brace
DECL|function|wbsd_tasklet_block
r_static
r_void
id|wbsd_tasklet_block
c_func
(paren
r_int
r_int
id|param
)paren
(brace
r_struct
id|wbsd_host
op_star
id|host
op_assign
(paren
r_struct
id|wbsd_host
op_star
)paren
id|param
suffix:semicolon
r_struct
id|mmc_data
op_star
id|data
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|host-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|wbsd_read_index
c_func
(paren
id|host
comma
id|WBSD_IDX_CRCSTATUS
)paren
op_amp
id|WBSD_CRC_MASK
)paren
op_ne
id|WBSD_CRC_OK
)paren
(brace
id|data
op_assign
id|wbsd_get_data
c_func
(paren
id|host
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|data
)paren
r_goto
id|end
suffix:semicolon
id|DBGF
c_func
(paren
l_string|&quot;CRC error&bslash;n&quot;
)paren
suffix:semicolon
id|data-&gt;error
op_assign
id|MMC_ERR_BADCRC
suffix:semicolon
id|tasklet_schedule
c_func
(paren
op_amp
id|host-&gt;finish_tasklet
)paren
suffix:semicolon
)brace
id|end
suffix:colon
id|spin_unlock
c_func
(paren
op_amp
id|host-&gt;lock
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Interrupt handling&n; */
DECL|function|wbsd_irq
r_static
id|irqreturn_t
id|wbsd_irq
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|wbsd_host
op_star
id|host
op_assign
id|dev_id
suffix:semicolon
r_int
id|isr
suffix:semicolon
id|isr
op_assign
id|inb
c_func
(paren
id|host-&gt;base
op_plus
id|WBSD_ISR
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Was it actually our hardware that caused the interrupt?&n;&t; */
r_if
c_cond
(paren
id|isr
op_eq
l_int|0xff
op_logical_or
id|isr
op_eq
l_int|0x00
)paren
r_return
id|IRQ_NONE
suffix:semicolon
multiline_comment|/*&n;&t; * Schedule tasklets as needed.&n;&t; */
r_if
c_cond
(paren
id|isr
op_amp
id|WBSD_INT_CARD
)paren
id|tasklet_schedule
c_func
(paren
op_amp
id|host-&gt;card_tasklet
)paren
suffix:semicolon
r_if
c_cond
(paren
id|isr
op_amp
id|WBSD_INT_FIFO_THRE
)paren
id|tasklet_hi_schedule
c_func
(paren
op_amp
id|host-&gt;fifo_tasklet
)paren
suffix:semicolon
r_if
c_cond
(paren
id|isr
op_amp
id|WBSD_INT_CRC
)paren
id|tasklet_hi_schedule
c_func
(paren
op_amp
id|host-&gt;crc_tasklet
)paren
suffix:semicolon
r_if
c_cond
(paren
id|isr
op_amp
id|WBSD_INT_TIMEOUT
)paren
id|tasklet_hi_schedule
c_func
(paren
op_amp
id|host-&gt;timeout_tasklet
)paren
suffix:semicolon
r_if
c_cond
(paren
id|isr
op_amp
id|WBSD_INT_BUSYEND
)paren
id|tasklet_hi_schedule
c_func
(paren
op_amp
id|host-&gt;block_tasklet
)paren
suffix:semicolon
r_if
c_cond
(paren
id|isr
op_amp
id|WBSD_INT_TC
)paren
id|tasklet_schedule
c_func
(paren
op_amp
id|host-&gt;finish_tasklet
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
multiline_comment|/*&n; * Support functions for probe&n; */
DECL|function|wbsd_scan
r_static
r_int
id|wbsd_scan
c_func
(paren
r_struct
id|wbsd_host
op_star
id|host
)paren
(brace
r_int
id|i
comma
id|j
comma
id|k
suffix:semicolon
r_int
id|id
suffix:semicolon
multiline_comment|/*&n;&t; * Iterate through all ports, all codes to&n;&t; * find hardware that is in our known list.&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
(paren
id|config_ports
)paren
op_div
r_sizeof
(paren
r_int
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|request_region
c_func
(paren
id|config_ports
(braket
id|i
)braket
comma
l_int|2
comma
id|DRIVER_NAME
)paren
)paren
r_continue
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
r_sizeof
(paren
id|unlock_codes
)paren
op_div
r_sizeof
(paren
r_int
)paren
suffix:semicolon
id|j
op_increment
)paren
(brace
id|id
op_assign
l_int|0xFFFF
suffix:semicolon
id|outb
c_func
(paren
id|unlock_codes
(braket
id|j
)braket
comma
id|config_ports
(braket
id|i
)braket
)paren
suffix:semicolon
id|outb
c_func
(paren
id|unlock_codes
(braket
id|j
)braket
comma
id|config_ports
(braket
id|i
)braket
)paren
suffix:semicolon
id|outb
c_func
(paren
id|WBSD_CONF_ID_HI
comma
id|config_ports
(braket
id|i
)braket
)paren
suffix:semicolon
id|id
op_assign
id|inb
c_func
(paren
id|config_ports
(braket
id|i
)braket
op_plus
l_int|1
)paren
op_lshift
l_int|8
suffix:semicolon
id|outb
c_func
(paren
id|WBSD_CONF_ID_LO
comma
id|config_ports
(braket
id|i
)braket
)paren
suffix:semicolon
id|id
op_or_assign
id|inb
c_func
(paren
id|config_ports
(braket
id|i
)braket
op_plus
l_int|1
)paren
suffix:semicolon
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
id|k
OL
r_sizeof
(paren
id|valid_ids
)paren
op_div
r_sizeof
(paren
r_int
)paren
suffix:semicolon
id|k
op_increment
)paren
(brace
r_if
c_cond
(paren
id|id
op_eq
id|valid_ids
(braket
id|k
)braket
)paren
(brace
id|host-&gt;chip_id
op_assign
id|id
suffix:semicolon
id|host-&gt;config
op_assign
id|config_ports
(braket
id|i
)braket
suffix:semicolon
id|host-&gt;unlock_code
op_assign
id|unlock_codes
(braket
id|i
)braket
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|id
op_ne
l_int|0xFFFF
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;Unknown hardware (id %x) found at %x&bslash;n&quot;
comma
id|id
comma
id|config_ports
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|outb
c_func
(paren
id|LOCK_CODE
comma
id|config_ports
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|release_region
c_func
(paren
id|config_ports
(braket
id|i
)braket
comma
l_int|2
)paren
suffix:semicolon
)brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
DECL|function|wbsd_request_regions
r_static
r_int
id|wbsd_request_regions
c_func
(paren
r_struct
id|wbsd_host
op_star
id|host
)paren
(brace
r_if
c_cond
(paren
id|io
op_amp
l_int|0x7
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|request_region
c_func
(paren
id|io
comma
l_int|8
comma
id|DRIVER_NAME
)paren
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|host-&gt;base
op_assign
id|io
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|wbsd_release_regions
r_static
r_void
id|wbsd_release_regions
c_func
(paren
r_struct
id|wbsd_host
op_star
id|host
)paren
(brace
r_if
c_cond
(paren
id|host-&gt;base
)paren
id|release_region
c_func
(paren
id|host-&gt;base
comma
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|host-&gt;config
)paren
id|release_region
c_func
(paren
id|host-&gt;config
comma
l_int|2
)paren
suffix:semicolon
)brace
DECL|function|wbsd_init_dma
r_static
r_void
id|wbsd_init_dma
c_func
(paren
r_struct
id|wbsd_host
op_star
id|host
)paren
(brace
id|host-&gt;dma
op_assign
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|dma
OL
l_int|0
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|request_dma
c_func
(paren
id|dma
comma
id|DRIVER_NAME
)paren
)paren
r_goto
id|err
suffix:semicolon
multiline_comment|/*&n;&t; * We need to allocate a special buffer in&n;&t; * order for ISA to be able to DMA to it.&n;&t; */
id|host-&gt;dma_buffer
op_assign
id|kmalloc
c_func
(paren
l_int|65536
comma
id|GFP_NOIO
op_or
id|GFP_DMA
op_or
id|__GFP_REPEAT
op_or
id|__GFP_NOWARN
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|host-&gt;dma_buffer
)paren
r_goto
id|free
suffix:semicolon
multiline_comment|/*&n;&t; * Translate the address to a physical address.&n;&t; */
id|host-&gt;dma_addr
op_assign
id|isa_virt_to_bus
c_func
(paren
id|host-&gt;dma_buffer
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * ISA DMA must be aligned on a 64k basis.&n;&t; */
r_if
c_cond
(paren
(paren
id|host-&gt;dma_addr
op_amp
l_int|0xffff
)paren
op_ne
l_int|0
)paren
r_goto
id|kfree
suffix:semicolon
multiline_comment|/*&n;&t; * ISA cannot access memory above 16 MB.&n;&t; */
r_else
r_if
c_cond
(paren
id|host-&gt;dma_addr
op_ge
l_int|0x1000000
)paren
r_goto
id|kfree
suffix:semicolon
id|host-&gt;dma
op_assign
id|dma
suffix:semicolon
r_return
suffix:semicolon
id|kfree
suffix:colon
multiline_comment|/*&n;&t; * If we&squot;ve gotten here then there is some kind of alignment bug&n;&t; */
id|BUG_ON
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|host-&gt;dma_buffer
)paren
suffix:semicolon
id|host-&gt;dma_buffer
op_assign
l_int|NULL
suffix:semicolon
id|free
suffix:colon
id|free_dma
c_func
(paren
id|dma
)paren
suffix:semicolon
id|err
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
id|DRIVER_NAME
l_string|&quot;: Unable to allocate DMA %d. &quot;
l_string|&quot;Falling back on FIFO.&bslash;n&quot;
comma
id|dma
)paren
suffix:semicolon
)brace
DECL|variable|wbsd_ops
r_static
r_struct
id|mmc_host_ops
id|wbsd_ops
op_assign
(brace
dot
id|request
op_assign
id|wbsd_request
comma
dot
id|set_ios
op_assign
id|wbsd_set_ios
comma
)brace
suffix:semicolon
multiline_comment|/*&n; * Device probe&n; */
DECL|function|wbsd_probe
r_static
r_int
id|wbsd_probe
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|wbsd_host
op_star
id|host
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|mmc_host
op_star
id|mmc
op_assign
l_int|NULL
suffix:semicolon
r_int
id|ret
suffix:semicolon
multiline_comment|/*&n;&t; * Allocate MMC structure.&n;&t; */
id|mmc
op_assign
id|mmc_alloc_host
c_func
(paren
r_sizeof
(paren
r_struct
id|wbsd_host
)paren
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mmc
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|host
op_assign
id|mmc_priv
c_func
(paren
id|mmc
)paren
suffix:semicolon
id|host-&gt;mmc
op_assign
id|mmc
suffix:semicolon
multiline_comment|/*&n;&t; * Scan for hardware.&n;&t; */
id|ret
op_assign
id|wbsd_scan
c_func
(paren
id|host
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_goto
id|freemmc
suffix:semicolon
multiline_comment|/*&n;&t; * Reset the chip.&n;&t; */
id|wbsd_write_config
c_func
(paren
id|host
comma
id|WBSD_CONF_SWRST
comma
l_int|1
)paren
suffix:semicolon
id|wbsd_write_config
c_func
(paren
id|host
comma
id|WBSD_CONF_SWRST
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Allocate I/O ports.&n;&t; */
id|ret
op_assign
id|wbsd_request_regions
c_func
(paren
id|host
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_goto
id|release
suffix:semicolon
multiline_comment|/*&n;&t; * Set host parameters.&n;&t; */
id|mmc-&gt;ops
op_assign
op_amp
id|wbsd_ops
suffix:semicolon
id|mmc-&gt;f_min
op_assign
l_int|375000
suffix:semicolon
id|mmc-&gt;f_max
op_assign
l_int|24000000
suffix:semicolon
id|mmc-&gt;ocr_avail
op_assign
id|MMC_VDD_32_33
op_or
id|MMC_VDD_33_34
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|host-&gt;lock
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Select SD/MMC function.&n;&t; */
id|wbsd_write_config
c_func
(paren
id|host
comma
id|WBSD_CONF_DEVICE
comma
id|DEVICE_SD
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Set up card detection.&n;&t; */
id|wbsd_write_config
c_func
(paren
id|host
comma
id|WBSD_CONF_PINS
comma
l_int|0x02
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Configure I/O port.&n;&t; */
id|wbsd_write_config
c_func
(paren
id|host
comma
id|WBSD_CONF_PORT_HI
comma
id|host-&gt;base
op_rshift
l_int|8
)paren
suffix:semicolon
id|wbsd_write_config
c_func
(paren
id|host
comma
id|WBSD_CONF_PORT_LO
comma
id|host-&gt;base
op_amp
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Allocate interrupt.&n;&t; */
id|ret
op_assign
id|request_irq
c_func
(paren
id|irq
comma
id|wbsd_irq
comma
id|SA_SHIRQ
comma
id|DRIVER_NAME
comma
id|host
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_goto
id|release
suffix:semicolon
id|host-&gt;irq
op_assign
id|irq
suffix:semicolon
multiline_comment|/*&n;&t; * Set up tasklets.&n;&t; */
id|tasklet_init
c_func
(paren
op_amp
id|host-&gt;card_tasklet
comma
id|wbsd_tasklet_card
comma
(paren
r_int
r_int
)paren
id|host
)paren
suffix:semicolon
id|tasklet_init
c_func
(paren
op_amp
id|host-&gt;fifo_tasklet
comma
id|wbsd_tasklet_fifo
comma
(paren
r_int
r_int
)paren
id|host
)paren
suffix:semicolon
id|tasklet_init
c_func
(paren
op_amp
id|host-&gt;crc_tasklet
comma
id|wbsd_tasklet_crc
comma
(paren
r_int
r_int
)paren
id|host
)paren
suffix:semicolon
id|tasklet_init
c_func
(paren
op_amp
id|host-&gt;timeout_tasklet
comma
id|wbsd_tasklet_timeout
comma
(paren
r_int
r_int
)paren
id|host
)paren
suffix:semicolon
id|tasklet_init
c_func
(paren
op_amp
id|host-&gt;finish_tasklet
comma
id|wbsd_tasklet_finish
comma
(paren
r_int
r_int
)paren
id|host
)paren
suffix:semicolon
id|tasklet_init
c_func
(paren
op_amp
id|host-&gt;block_tasklet
comma
id|wbsd_tasklet_block
comma
(paren
r_int
r_int
)paren
id|host
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Configure interrupt.&n;&t; */
id|wbsd_write_config
c_func
(paren
id|host
comma
id|WBSD_CONF_IRQ
comma
id|host-&gt;irq
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Allocate DMA.&n;&t; */
id|wbsd_init_dma
c_func
(paren
id|host
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * If all went well, then configure DMA.&n;&t; */
r_if
c_cond
(paren
id|host-&gt;dma
op_ge
l_int|0
)paren
id|wbsd_write_config
c_func
(paren
id|host
comma
id|WBSD_CONF_DRQ
comma
id|host-&gt;dma
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Maximum number of segments. Worst case is one sector per segment&n;&t; * so this will be 64kB/512.&n;&t; */
id|mmc-&gt;max_hw_segs
op_assign
id|NR_SG
suffix:semicolon
id|mmc-&gt;max_phys_segs
op_assign
id|NR_SG
suffix:semicolon
multiline_comment|/*&n;&t; * Maximum number of sectors in one transfer. Also limited by 64kB&n;&t; * buffer.&n;&t; */
id|mmc-&gt;max_sectors
op_assign
l_int|128
suffix:semicolon
multiline_comment|/*&n;&t; * Maximum segment size. Could be one segment with the maximum number&n;&t; * of segments.&n;&t; */
id|mmc-&gt;max_seg_size
op_assign
id|mmc-&gt;max_sectors
op_star
l_int|512
suffix:semicolon
multiline_comment|/*&n;&t; * Enable chip.&n;&t; */
id|wbsd_write_config
c_func
(paren
id|host
comma
id|WBSD_CONF_ENABLE
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Power up chip.&n;&t; */
id|wbsd_write_config
c_func
(paren
id|host
comma
id|WBSD_CONF_POWER
comma
l_int|0x20
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Power Management stuff. No idea how this works.&n;&t; * Not tested.&n;&t; */
macro_line|#ifdef CONFIG_PM
id|wbsd_write_config
c_func
(paren
id|host
comma
id|WBSD_CONF_PME
comma
l_int|0xA0
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;&t; * Reset the chip into a known state.&n;&t; */
id|wbsd_init_device
c_func
(paren
id|host
)paren
suffix:semicolon
id|dev_set_drvdata
c_func
(paren
id|dev
comma
id|mmc
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Add host to MMC layer.&n;&t; */
id|mmc_add_host
c_func
(paren
id|mmc
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: W83L51xD id %x at 0x%x irq %d dma %d&bslash;n&quot;
comma
id|mmc-&gt;host_name
comma
(paren
r_int
)paren
id|host-&gt;chip_id
comma
(paren
r_int
)paren
id|host-&gt;base
comma
(paren
r_int
)paren
id|host-&gt;irq
comma
(paren
r_int
)paren
id|host-&gt;dma
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|release
suffix:colon
id|wbsd_release_regions
c_func
(paren
id|host
)paren
suffix:semicolon
id|freemmc
suffix:colon
id|mmc_free_host
c_func
(paren
id|mmc
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n; * Device remove&n; */
DECL|function|wbsd_remove
r_static
r_int
id|wbsd_remove
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|mmc_host
op_star
id|mmc
op_assign
id|dev_get_drvdata
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|wbsd_host
op_star
id|host
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mmc
)paren
r_return
l_int|0
suffix:semicolon
id|host
op_assign
id|mmc_priv
c_func
(paren
id|mmc
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Unregister host with MMC layer.&n;&t; */
id|mmc_remove_host
c_func
(paren
id|mmc
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Power down the SD/MMC function.&n;&t; */
id|wbsd_unlock_config
c_func
(paren
id|host
)paren
suffix:semicolon
id|wbsd_write_config
c_func
(paren
id|host
comma
id|WBSD_CONF_DEVICE
comma
id|DEVICE_SD
)paren
suffix:semicolon
id|wbsd_write_config
c_func
(paren
id|host
comma
id|WBSD_CONF_ENABLE
comma
l_int|0
)paren
suffix:semicolon
id|wbsd_lock_config
c_func
(paren
id|host
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Free resources.&n;&t; */
r_if
c_cond
(paren
id|host-&gt;dma_buffer
)paren
id|kfree
c_func
(paren
id|host-&gt;dma_buffer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|host-&gt;dma
op_ge
l_int|0
)paren
id|free_dma
c_func
(paren
id|host-&gt;dma
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|host-&gt;irq
comma
id|host
)paren
suffix:semicolon
id|tasklet_kill
c_func
(paren
op_amp
id|host-&gt;card_tasklet
)paren
suffix:semicolon
id|tasklet_kill
c_func
(paren
op_amp
id|host-&gt;fifo_tasklet
)paren
suffix:semicolon
id|tasklet_kill
c_func
(paren
op_amp
id|host-&gt;crc_tasklet
)paren
suffix:semicolon
id|tasklet_kill
c_func
(paren
op_amp
id|host-&gt;timeout_tasklet
)paren
suffix:semicolon
id|tasklet_kill
c_func
(paren
op_amp
id|host-&gt;finish_tasklet
)paren
suffix:semicolon
id|tasklet_kill
c_func
(paren
op_amp
id|host-&gt;block_tasklet
)paren
suffix:semicolon
id|wbsd_release_regions
c_func
(paren
id|host
)paren
suffix:semicolon
id|mmc_free_host
c_func
(paren
id|mmc
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Power management&n; */
macro_line|#ifdef CONFIG_PM
DECL|function|wbsd_suspend
r_static
r_int
id|wbsd_suspend
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|u32
id|state
comma
id|u32
id|level
)paren
(brace
id|DBGF
c_func
(paren
l_string|&quot;Not yet supported&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|wbsd_resume
r_static
r_int
id|wbsd_resume
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|u32
id|level
)paren
(brace
id|DBGF
c_func
(paren
l_string|&quot;Not yet supported&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#else
DECL|macro|wbsd_suspend
mdefine_line|#define wbsd_suspend NULL
DECL|macro|wbsd_resume
mdefine_line|#define wbsd_resume NULL
macro_line|#endif
DECL|function|wbsd_release
r_static
r_void
id|wbsd_release
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
)brace
DECL|variable|wbsd_device
r_static
r_struct
id|platform_device
id|wbsd_device
op_assign
(brace
dot
id|name
op_assign
id|DRIVER_NAME
comma
dot
id|id
op_assign
op_minus
l_int|1
comma
dot
id|dev
op_assign
(brace
dot
id|release
op_assign
id|wbsd_release
comma
)brace
comma
)brace
suffix:semicolon
DECL|variable|wbsd_driver
r_static
r_struct
id|device_driver
id|wbsd_driver
op_assign
(brace
dot
id|name
op_assign
id|DRIVER_NAME
comma
dot
id|bus
op_assign
op_amp
id|platform_bus_type
comma
dot
id|probe
op_assign
id|wbsd_probe
comma
dot
id|remove
op_assign
id|wbsd_remove
comma
dot
id|suspend
op_assign
id|wbsd_suspend
comma
dot
id|resume
op_assign
id|wbsd_resume
comma
)brace
suffix:semicolon
multiline_comment|/*&n; * Module loading/unloading&n; */
DECL|function|wbsd_drv_init
r_static
r_int
id|__init
id|wbsd_drv_init
c_func
(paren
r_void
)paren
(brace
r_int
id|result
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
id|DRIVER_NAME
l_string|&quot;: Winbond W83L51xD SD/MMC card interface driver, &quot;
id|DRIVER_VERSION
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
id|DRIVER_NAME
l_string|&quot;: Copyright(c) Pierre Ossman&bslash;n&quot;
)paren
suffix:semicolon
id|result
op_assign
id|driver_register
c_func
(paren
op_amp
id|wbsd_driver
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
r_return
id|result
suffix:semicolon
id|result
op_assign
id|platform_device_register
c_func
(paren
op_amp
id|wbsd_device
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
r_return
id|result
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|wbsd_drv_exit
r_static
r_void
id|__exit
id|wbsd_drv_exit
c_func
(paren
r_void
)paren
(brace
id|platform_device_unregister
c_func
(paren
op_amp
id|wbsd_device
)paren
suffix:semicolon
id|driver_unregister
c_func
(paren
op_amp
id|wbsd_driver
)paren
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;unloaded&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|variable|wbsd_drv_init
id|module_init
c_func
(paren
id|wbsd_drv_init
)paren
suffix:semicolon
DECL|variable|wbsd_drv_exit
id|module_exit
c_func
(paren
id|wbsd_drv_exit
)paren
suffix:semicolon
id|module_param
c_func
(paren
id|io
comma
id|uint
comma
l_int|0444
)paren
suffix:semicolon
id|module_param
c_func
(paren
id|irq
comma
id|uint
comma
l_int|0444
)paren
suffix:semicolon
id|module_param
c_func
(paren
id|dma
comma
r_int
comma
l_int|0444
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Winbond W83L51xD SD/MMC card interface driver&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|io
comma
l_string|&quot;I/O base to allocate. Must be 8 byte aligned. (default 0x248)&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|irq
comma
l_string|&quot;IRQ to allocate. (default 6)&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|dma
comma
l_string|&quot;DMA channel to allocate. -1 for no DMA. (default 2)&quot;
)paren
suffix:semicolon
eof
