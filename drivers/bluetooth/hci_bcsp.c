multiline_comment|/* &n;   BlueCore Serial Protocol (BCSP) for Linux Bluetooth stack (BlueZ).&n;   Copyright 2002 by Fabrizio Gennari &lt;fabrizio.gennari@philips.com&gt;&n;&n;   Based on&n;       hci_h4.c  by Maxim Krasnyansky &lt;maxk@qualcomm.com&gt;&n;       ABCSP     by Carl Orsborn &lt;cjo@csr.com&gt;&n;&n;   This program is free software; you can redistribute it and/or modify&n;   it under the terms of the GNU General Public License version 2 as&n;   published by the Free Software Foundation;&n;&n;   THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS&n;   OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,&n;   FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT OF THIRD PARTY RIGHTS.&n;   IN NO EVENT SHALL THE COPYRIGHT HOLDER(S) AND AUTHOR(S) BE LIABLE FOR ANY&n;   CLAIM, OR ANY SPECIAL INDIRECT OR CONSEQUENTIAL DAMAGES, OR ANY DAMAGES &n;   WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN &n;   ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF &n;   OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.&n;&n;   ALL LIABILITY, INCLUDING LIABILITY FOR INFRINGEMENT OF ANY PATENTS, &n;   COPYRIGHTS, TRADEMARKS OR OTHER RIGHTS, RELATING TO USE OF THIS &n;   SOFTWARE IS DISCLAIMED.&n;*/
multiline_comment|/*&n; * $Id: hci_bcsp.c,v 1.2 2002/09/26 05:05:14 maxk Exp $&n; */
DECL|macro|VERSION
mdefine_line|#define VERSION &quot;0.1&quot;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/poll.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/signal.h&gt;
macro_line|#include &lt;linux/ioctl.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;net/bluetooth/bluetooth.h&gt;
macro_line|#include &lt;net/bluetooth/hci_core.h&gt;
macro_line|#include &quot;hci_uart.h&quot;
macro_line|#include &quot;hci_bcsp.h&quot;
macro_line|#ifndef CONFIG_BT_HCIUART_DEBUG
DECL|macro|BT_DBG
macro_line|#undef  BT_DBG
DECL|macro|BT_DBG
mdefine_line|#define BT_DBG( A... )
DECL|macro|BT_DMP
macro_line|#undef  BT_DMP
DECL|macro|BT_DMP
mdefine_line|#define BT_DMP( A... )
macro_line|#endif
multiline_comment|/* ---- BCSP CRC calculation ---- */
multiline_comment|/* Table for calculating CRC for polynomial 0x1021, LSB processed first,&n;initial value 0xffff, bits shifted in reverse order. */
DECL|variable|crc_table
r_static
r_const
id|u16
id|crc_table
(braket
)braket
op_assign
(brace
l_int|0x0000
comma
l_int|0x1081
comma
l_int|0x2102
comma
l_int|0x3183
comma
l_int|0x4204
comma
l_int|0x5285
comma
l_int|0x6306
comma
l_int|0x7387
comma
l_int|0x8408
comma
l_int|0x9489
comma
l_int|0xa50a
comma
l_int|0xb58b
comma
l_int|0xc60c
comma
l_int|0xd68d
comma
l_int|0xe70e
comma
l_int|0xf78f
)brace
suffix:semicolon
multiline_comment|/* Initialise the crc calculator */
DECL|macro|BCSP_CRC_INIT
mdefine_line|#define BCSP_CRC_INIT(x) x = 0xffff
multiline_comment|/*&n;   Update crc with next data byte&n;&n;   Implementation note&n;        The data byte is treated as two nibbles.  The crc is generated&n;        in reverse, i.e., bits are fed into the register from the top.&n;*/
DECL|function|bcsp_crc_update
r_static
r_void
id|bcsp_crc_update
c_func
(paren
id|u16
op_star
id|crc
comma
id|u8
id|d
)paren
(brace
id|u16
id|reg
op_assign
op_star
id|crc
suffix:semicolon
id|reg
op_assign
(paren
id|reg
op_rshift
l_int|4
)paren
op_xor
id|crc_table
(braket
(paren
id|reg
op_xor
id|d
)paren
op_amp
l_int|0x000f
)braket
suffix:semicolon
id|reg
op_assign
(paren
id|reg
op_rshift
l_int|4
)paren
op_xor
id|crc_table
(braket
(paren
id|reg
op_xor
(paren
id|d
op_rshift
l_int|4
)paren
)paren
op_amp
l_int|0x000f
)braket
suffix:semicolon
op_star
id|crc
op_assign
id|reg
suffix:semicolon
)brace
multiline_comment|/*&n;   Get reverse of generated crc&n;&n;   Implementation note&n;        The crc generator (bcsp_crc_init() and bcsp_crc_update())&n;        creates a reversed crc, so it needs to be swapped back before&n;        being passed on.&n;*/
DECL|function|bcsp_crc_reverse
r_static
id|u16
id|bcsp_crc_reverse
c_func
(paren
id|u16
id|crc
)paren
(brace
id|u16
id|b
comma
id|rev
suffix:semicolon
r_for
c_loop
(paren
id|b
op_assign
l_int|0
comma
id|rev
op_assign
l_int|0
suffix:semicolon
id|b
OL
l_int|16
suffix:semicolon
id|b
op_increment
)paren
(brace
id|rev
op_assign
id|rev
op_lshift
l_int|1
suffix:semicolon
id|rev
op_or_assign
(paren
id|crc
op_amp
l_int|1
)paren
suffix:semicolon
id|crc
op_assign
id|crc
op_rshift
l_int|1
suffix:semicolon
)brace
r_return
(paren
id|rev
)paren
suffix:semicolon
)brace
multiline_comment|/* ---- BCSP core ---- */
DECL|function|bcsp_slip_msgdelim
r_static
r_void
id|bcsp_slip_msgdelim
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_const
r_char
id|pkt_delim
op_assign
l_int|0xc0
suffix:semicolon
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
l_int|1
)paren
comma
op_amp
id|pkt_delim
comma
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|bcsp_slip_one_byte
r_static
r_void
id|bcsp_slip_one_byte
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
id|u8
id|c
)paren
(brace
r_const
r_char
id|esc_c0
(braket
l_int|2
)braket
op_assign
(brace
l_int|0xdb
comma
l_int|0xdc
)brace
suffix:semicolon
r_const
r_char
id|esc_db
(braket
l_int|2
)braket
op_assign
(brace
l_int|0xdb
comma
l_int|0xdd
)brace
suffix:semicolon
r_switch
c_cond
(paren
id|c
)paren
(brace
r_case
l_int|0xc0
suffix:colon
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
l_int|2
)paren
comma
op_amp
id|esc_c0
comma
l_int|2
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0xdb
suffix:colon
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
l_int|2
)paren
comma
op_amp
id|esc_db
comma
l_int|2
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
l_int|1
)paren
comma
op_amp
id|c
comma
l_int|1
)paren
suffix:semicolon
)brace
)brace
DECL|function|bcsp_enqueue
r_static
r_int
id|bcsp_enqueue
c_func
(paren
r_struct
id|hci_uart
op_star
id|hu
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|bcsp_struct
op_star
id|bcsp
op_assign
id|hu-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;len
OG
l_int|0xFFF
)paren
(brace
id|BT_ERR
c_func
(paren
l_string|&quot;Packet too long&quot;
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|skb-&gt;pkt_type
)paren
(brace
r_case
id|HCI_ACLDATA_PKT
suffix:colon
r_case
id|HCI_COMMAND_PKT
suffix:colon
id|skb_queue_tail
c_func
(paren
op_amp
id|bcsp-&gt;rel
comma
id|skb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HCI_SCODATA_PKT
suffix:colon
id|skb_queue_tail
c_func
(paren
op_amp
id|bcsp-&gt;unrel
comma
id|skb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|BT_ERR
c_func
(paren
l_string|&quot;Unknown packet type&quot;
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|bcsp_prepare_pkt
r_static
r_struct
id|sk_buff
op_star
id|bcsp_prepare_pkt
c_func
(paren
r_struct
id|bcsp_struct
op_star
id|bcsp
comma
id|u8
op_star
id|data
comma
r_int
id|len
comma
r_int
id|pkt_type
)paren
(brace
r_struct
id|sk_buff
op_star
id|nskb
suffix:semicolon
id|u8
id|hdr
(braket
l_int|4
)braket
comma
id|chan
suffix:semicolon
r_int
id|rel
comma
id|i
suffix:semicolon
macro_line|#ifdef CONFIG_BT_HCIUART_BCSP_TXCRC
id|u16
id|BCSP_CRC_INIT
c_func
(paren
id|bcsp_txmsg_crc
)paren
suffix:semicolon
macro_line|#endif
r_switch
c_cond
(paren
id|pkt_type
)paren
(brace
r_case
id|HCI_ACLDATA_PKT
suffix:colon
id|chan
op_assign
l_int|6
suffix:semicolon
multiline_comment|/* BCSP ACL channel */
id|rel
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* reliable channel */
r_break
suffix:semicolon
r_case
id|HCI_COMMAND_PKT
suffix:colon
id|chan
op_assign
l_int|5
suffix:semicolon
multiline_comment|/* BCSP cmd/evt channel */
id|rel
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* reliable channel */
r_break
suffix:semicolon
r_case
id|HCI_SCODATA_PKT
suffix:colon
id|chan
op_assign
l_int|7
suffix:semicolon
multiline_comment|/* BCSP SCO channel */
id|rel
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* unreliable channel */
r_break
suffix:semicolon
r_case
id|BCSP_LE_PKT
suffix:colon
id|chan
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* BCSP LE channel */
id|rel
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* unreliable channel */
r_break
suffix:semicolon
r_case
id|BCSP_ACK_PKT
suffix:colon
id|chan
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* BCSP internal channel */
id|rel
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* unreliable channel */
r_break
suffix:semicolon
r_default
suffix:colon
id|BT_ERR
c_func
(paren
l_string|&quot;Unknown packet type&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* Max len of packet: (original len +4(bcsp hdr) +2(crc))*2&n;&t;   (because bytes 0xc0 and 0xdb are escaped, worst case is&n;&t;   when the packet is all made of 0xc0 and 0xdb :) )&n;&t;   + 2 (0xc0 delimiters at start and end). */
id|nskb
op_assign
id|alloc_skb
c_func
(paren
(paren
id|len
op_plus
l_int|6
)paren
op_star
l_int|2
op_plus
l_int|2
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|nskb
)paren
r_return
l_int|NULL
suffix:semicolon
id|nskb-&gt;pkt_type
op_assign
id|pkt_type
suffix:semicolon
id|bcsp_slip_msgdelim
c_func
(paren
id|nskb
)paren
suffix:semicolon
id|hdr
(braket
l_int|0
)braket
op_assign
id|bcsp-&gt;rxseq_txack
op_lshift
l_int|3
suffix:semicolon
id|bcsp-&gt;txack_req
op_assign
l_int|0
suffix:semicolon
id|BT_DBG
c_func
(paren
l_string|&quot;We request packet no %u to card&quot;
comma
id|bcsp-&gt;rxseq_txack
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rel
)paren
(brace
id|hdr
(braket
l_int|0
)braket
op_or_assign
l_int|0x80
op_plus
id|bcsp-&gt;msgq_txseq
suffix:semicolon
id|BT_DBG
c_func
(paren
l_string|&quot;Sending packet with seqno %u&quot;
comma
id|bcsp-&gt;msgq_txseq
)paren
suffix:semicolon
id|bcsp-&gt;msgq_txseq
op_assign
op_increment
(paren
id|bcsp-&gt;msgq_txseq
)paren
op_amp
l_int|0x07
suffix:semicolon
)brace
macro_line|#ifdef  CONFIG_BT_HCIUART_BCSP_TXCRC
id|hdr
(braket
l_int|0
)braket
op_or_assign
l_int|0x40
suffix:semicolon
macro_line|#endif
id|hdr
(braket
l_int|1
)braket
op_assign
(paren
id|len
op_lshift
l_int|4
)paren
op_amp
l_int|0xFF
suffix:semicolon
id|hdr
(braket
l_int|1
)braket
op_or_assign
id|chan
suffix:semicolon
id|hdr
(braket
l_int|2
)braket
op_assign
id|len
op_rshift
l_int|4
suffix:semicolon
id|hdr
(braket
l_int|3
)braket
op_assign
op_complement
(paren
id|hdr
(braket
l_int|0
)braket
op_plus
id|hdr
(braket
l_int|1
)braket
op_plus
id|hdr
(braket
l_int|2
)braket
)paren
suffix:semicolon
multiline_comment|/* Put BCSP header */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
id|bcsp_slip_one_byte
c_func
(paren
id|nskb
comma
id|hdr
(braket
id|i
)braket
)paren
suffix:semicolon
macro_line|#ifdef  CONFIG_BT_HCIUART_BCSP_TXCRC
id|bcsp_crc_update
c_func
(paren
op_amp
id|bcsp_txmsg_crc
comma
id|hdr
(braket
id|i
)braket
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/* Put payload */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
id|i
op_increment
)paren
(brace
id|bcsp_slip_one_byte
c_func
(paren
id|nskb
comma
id|data
(braket
id|i
)braket
)paren
suffix:semicolon
macro_line|#ifdef  CONFIG_BT_HCIUART_BCSP_TXCRC
id|bcsp_crc_update
c_func
(paren
op_amp
id|bcsp_txmsg_crc
comma
id|data
(braket
id|i
)braket
)paren
suffix:semicolon
macro_line|#endif
)brace
macro_line|#ifdef CONFIG_BT_HCIUART_BCSP_TXCRC
multiline_comment|/* Put CRC */
id|bcsp_txmsg_crc
op_assign
id|bcsp_crc_reverse
c_func
(paren
id|bcsp_txmsg_crc
)paren
suffix:semicolon
id|bcsp_slip_one_byte
c_func
(paren
id|nskb
comma
(paren
id|u8
)paren
(paren
(paren
id|bcsp_txmsg_crc
op_rshift
l_int|8
)paren
op_amp
l_int|0x00ff
)paren
)paren
suffix:semicolon
id|bcsp_slip_one_byte
c_func
(paren
id|nskb
comma
(paren
id|u8
)paren
(paren
id|bcsp_txmsg_crc
op_amp
l_int|0x00ff
)paren
)paren
suffix:semicolon
macro_line|#endif
id|bcsp_slip_msgdelim
c_func
(paren
id|nskb
)paren
suffix:semicolon
r_return
id|nskb
suffix:semicolon
)brace
multiline_comment|/* This is a rewrite of pkt_avail in ABCSP */
DECL|function|bcsp_dequeue
r_static
r_struct
id|sk_buff
op_star
id|bcsp_dequeue
c_func
(paren
r_struct
id|hci_uart
op_star
id|hu
)paren
(brace
r_struct
id|bcsp_struct
op_star
id|bcsp
op_assign
id|hu-&gt;priv
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
multiline_comment|/* First of all, check for unreliable messages in the queue,&n;&t;   since they have priority */
r_if
c_cond
(paren
(paren
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|bcsp-&gt;unrel
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
r_struct
id|sk_buff
op_star
id|nskb
op_assign
id|bcsp_prepare_pkt
c_func
(paren
id|bcsp
comma
id|skb-&gt;data
comma
id|skb-&gt;len
comma
id|skb-&gt;pkt_type
)paren
suffix:semicolon
r_if
c_cond
(paren
id|nskb
)paren
(brace
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
id|nskb
suffix:semicolon
)brace
r_else
(brace
id|skb_queue_head
c_func
(paren
op_amp
id|bcsp-&gt;unrel
comma
id|skb
)paren
suffix:semicolon
id|BT_ERR
c_func
(paren
l_string|&quot;Could not dequeue pkt because alloc_skb failed&quot;
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Now, try to send a reliable pkt. We can only send a&n;&t;   reliable packet if the number of packets sent but not yet ack&squot;ed&n;&t;   is &lt; than the winsize */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|bcsp-&gt;unack.lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bcsp-&gt;unack.qlen
OL
id|BCSP_TXWINSIZE
op_logical_and
(paren
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|bcsp-&gt;rel
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
r_struct
id|sk_buff
op_star
id|nskb
op_assign
id|bcsp_prepare_pkt
c_func
(paren
id|bcsp
comma
id|skb-&gt;data
comma
id|skb-&gt;len
comma
id|skb-&gt;pkt_type
)paren
suffix:semicolon
r_if
c_cond
(paren
id|nskb
)paren
(brace
id|__skb_queue_tail
c_func
(paren
op_amp
id|bcsp-&gt;unack
comma
id|skb
)paren
suffix:semicolon
id|mod_timer
c_func
(paren
op_amp
id|bcsp-&gt;tbcsp
comma
id|jiffies
op_plus
id|HZ
op_div
l_int|4
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|bcsp-&gt;unack.lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|nskb
suffix:semicolon
)brace
r_else
(brace
id|skb_queue_head
c_func
(paren
op_amp
id|bcsp-&gt;rel
comma
id|skb
)paren
suffix:semicolon
id|BT_ERR
c_func
(paren
l_string|&quot;Could not dequeue pkt because alloc_skb failed&quot;
)paren
suffix:semicolon
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|bcsp-&gt;unack.lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* We could not send a reliable packet, either because there are&n;&t;   none or because there are too many unack&squot;ed pkts. Did we receive&n;&t;   any packets we have not acknowledged yet ? */
r_if
c_cond
(paren
id|bcsp-&gt;txack_req
)paren
(brace
multiline_comment|/* if so, craft an empty ACK pkt and send it on BCSP unreliable&n;&t;&t;   channel 0 */
r_struct
id|sk_buff
op_star
id|nskb
op_assign
id|bcsp_prepare_pkt
c_func
(paren
id|bcsp
comma
l_int|NULL
comma
l_int|0
comma
id|BCSP_ACK_PKT
)paren
suffix:semicolon
r_return
id|nskb
suffix:semicolon
)brace
multiline_comment|/* We have nothing to send */
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|bcsp_flush
r_static
r_int
id|bcsp_flush
c_func
(paren
r_struct
id|hci_uart
op_star
id|hu
)paren
(brace
id|BT_DBG
c_func
(paren
l_string|&quot;hu %p&quot;
comma
id|hu
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Remove ack&squot;ed packets */
DECL|function|bcsp_pkt_cull
r_static
r_void
id|bcsp_pkt_cull
c_func
(paren
r_struct
id|bcsp_struct
op_star
id|bcsp
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|i
comma
id|pkts_to_be_removed
suffix:semicolon
id|u8
id|seqno
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|bcsp-&gt;unack.lock
comma
id|flags
)paren
suffix:semicolon
id|pkts_to_be_removed
op_assign
id|bcsp-&gt;unack.qlen
suffix:semicolon
id|seqno
op_assign
id|bcsp-&gt;msgq_txseq
suffix:semicolon
r_while
c_loop
(paren
id|pkts_to_be_removed
)paren
(brace
r_if
c_cond
(paren
id|bcsp-&gt;rxack
op_eq
id|seqno
)paren
r_break
suffix:semicolon
id|pkts_to_be_removed
op_decrement
suffix:semicolon
id|seqno
op_assign
(paren
id|seqno
op_minus
l_int|1
)paren
op_amp
l_int|0x07
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bcsp-&gt;rxack
op_ne
id|seqno
)paren
id|BT_ERR
c_func
(paren
l_string|&quot;Peer acked invalid packet&quot;
)paren
suffix:semicolon
id|BT_DBG
c_func
(paren
l_string|&quot;Removing %u pkts out of %u, up to seqno %u&quot;
comma
id|pkts_to_be_removed
comma
id|bcsp-&gt;unack.qlen
comma
(paren
id|seqno
op_minus
l_int|1
)paren
op_amp
l_int|0x07
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|skb
op_assign
(paren
(paren
r_struct
id|sk_buff
op_star
)paren
op_amp
id|bcsp-&gt;unack
)paren
op_member_access_from_pointer
id|next
suffix:semicolon
id|i
OL
id|pkts_to_be_removed
op_logical_and
id|skb
op_ne
(paren
r_struct
id|sk_buff
op_star
)paren
op_amp
id|bcsp-&gt;unack
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|sk_buff
op_star
id|nskb
suffix:semicolon
id|nskb
op_assign
id|skb-&gt;next
suffix:semicolon
id|__skb_unlink
c_func
(paren
id|skb
comma
op_amp
id|bcsp-&gt;unack
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|skb
op_assign
id|nskb
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bcsp-&gt;unack.qlen
op_eq
l_int|0
)paren
id|del_timer
c_func
(paren
op_amp
id|bcsp-&gt;tbcsp
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|bcsp-&gt;unack.lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ne
id|pkts_to_be_removed
)paren
id|BT_ERR
c_func
(paren
l_string|&quot;Removed only %u out of %u pkts&quot;
comma
id|i
comma
id|pkts_to_be_removed
)paren
suffix:semicolon
)brace
multiline_comment|/* Handle BCSP link-establishment packets. When we&n;   detect a &quot;sync&quot; packet, symptom that the BT module has reset,&n;   we do nothing :) (yet) */
DECL|function|bcsp_handle_le_pkt
r_static
r_void
id|bcsp_handle_le_pkt
c_func
(paren
r_struct
id|hci_uart
op_star
id|hu
)paren
(brace
r_struct
id|bcsp_struct
op_star
id|bcsp
op_assign
id|hu-&gt;priv
suffix:semicolon
id|u8
id|conf_pkt
(braket
l_int|4
)braket
op_assign
(brace
l_int|0xad
comma
l_int|0xef
comma
l_int|0xac
comma
l_int|0xed
)brace
suffix:semicolon
id|u8
id|conf_rsp_pkt
(braket
l_int|4
)braket
op_assign
(brace
l_int|0xde
comma
l_int|0xad
comma
l_int|0xd0
comma
l_int|0xd0
)brace
suffix:semicolon
id|u8
id|sync_pkt
(braket
l_int|4
)braket
op_assign
(brace
l_int|0xda
comma
l_int|0xdc
comma
l_int|0xed
comma
l_int|0xed
)brace
suffix:semicolon
multiline_comment|/* spot &quot;conf&quot; pkts and reply with a &quot;conf rsp&quot; pkt */
r_if
c_cond
(paren
id|bcsp-&gt;rx_skb-&gt;data
(braket
l_int|1
)braket
op_rshift
l_int|4
op_eq
l_int|4
op_logical_and
id|bcsp-&gt;rx_skb-&gt;data
(braket
l_int|2
)braket
op_eq
l_int|0
op_logical_and
op_logical_neg
id|memcmp
c_func
(paren
op_amp
id|bcsp-&gt;rx_skb-&gt;data
(braket
l_int|4
)braket
comma
id|conf_pkt
comma
l_int|4
)paren
)paren
(brace
r_struct
id|sk_buff
op_star
id|nskb
op_assign
id|alloc_skb
c_func
(paren
l_int|4
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
id|BT_DBG
c_func
(paren
l_string|&quot;Found a LE conf pkt&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|nskb
)paren
r_return
suffix:semicolon
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|nskb
comma
l_int|4
)paren
comma
id|conf_rsp_pkt
comma
l_int|4
)paren
suffix:semicolon
id|nskb-&gt;pkt_type
op_assign
id|BCSP_LE_PKT
suffix:semicolon
id|skb_queue_head
c_func
(paren
op_amp
id|bcsp-&gt;unrel
comma
id|nskb
)paren
suffix:semicolon
id|hci_uart_tx_wakeup
c_func
(paren
id|hu
)paren
suffix:semicolon
)brace
multiline_comment|/* Spot &quot;sync&quot; pkts. If we find one...disaster! */
r_else
r_if
c_cond
(paren
id|bcsp-&gt;rx_skb-&gt;data
(braket
l_int|1
)braket
op_rshift
l_int|4
op_eq
l_int|4
op_logical_and
id|bcsp-&gt;rx_skb-&gt;data
(braket
l_int|2
)braket
op_eq
l_int|0
op_logical_and
op_logical_neg
id|memcmp
c_func
(paren
op_amp
id|bcsp-&gt;rx_skb-&gt;data
(braket
l_int|4
)braket
comma
id|sync_pkt
comma
l_int|4
)paren
)paren
(brace
id|BT_ERR
c_func
(paren
l_string|&quot;Found a LE sync pkt, card has reset&quot;
)paren
suffix:semicolon
)brace
)brace
DECL|function|bcsp_unslip_one_byte
r_static
r_inline
r_void
id|bcsp_unslip_one_byte
c_func
(paren
r_struct
id|bcsp_struct
op_star
id|bcsp
comma
r_int
r_char
id|byte
)paren
(brace
r_const
id|u8
id|c0
op_assign
l_int|0xc0
comma
id|db
op_assign
l_int|0xdb
suffix:semicolon
r_switch
c_cond
(paren
id|bcsp-&gt;rx_esc_state
)paren
(brace
r_case
id|BCSP_ESCSTATE_NOESC
suffix:colon
r_switch
c_cond
(paren
id|byte
)paren
(brace
r_case
l_int|0xdb
suffix:colon
id|bcsp-&gt;rx_esc_state
op_assign
id|BCSP_ESCSTATE_ESC
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|bcsp-&gt;rx_skb
comma
l_int|1
)paren
comma
op_amp
id|byte
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|bcsp-&gt;rx_skb
op_member_access_from_pointer
id|data
(braket
l_int|0
)braket
op_amp
l_int|0x40
)paren
op_ne
l_int|0
op_logical_and
id|bcsp-&gt;rx_state
op_ne
id|BCSP_W4_CRC
)paren
id|bcsp_crc_update
c_func
(paren
op_amp
id|bcsp-&gt;message_crc
comma
id|byte
)paren
suffix:semicolon
id|bcsp-&gt;rx_count
op_decrement
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|BCSP_ESCSTATE_ESC
suffix:colon
r_switch
c_cond
(paren
id|byte
)paren
(brace
r_case
l_int|0xdc
suffix:colon
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|bcsp-&gt;rx_skb
comma
l_int|1
)paren
comma
op_amp
id|c0
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|bcsp-&gt;rx_skb
op_member_access_from_pointer
id|data
(braket
l_int|0
)braket
op_amp
l_int|0x40
)paren
op_ne
l_int|0
op_logical_and
id|bcsp-&gt;rx_state
op_ne
id|BCSP_W4_CRC
)paren
id|bcsp_crc_update
c_func
(paren
op_amp
id|bcsp
op_member_access_from_pointer
id|message_crc
comma
l_int|0xc0
)paren
suffix:semicolon
id|bcsp-&gt;rx_esc_state
op_assign
id|BCSP_ESCSTATE_NOESC
suffix:semicolon
id|bcsp-&gt;rx_count
op_decrement
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0xdd
suffix:colon
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|bcsp-&gt;rx_skb
comma
l_int|1
)paren
comma
op_amp
id|db
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|bcsp-&gt;rx_skb
op_member_access_from_pointer
id|data
(braket
l_int|0
)braket
op_amp
l_int|0x40
)paren
op_ne
l_int|0
op_logical_and
id|bcsp-&gt;rx_state
op_ne
id|BCSP_W4_CRC
)paren
id|bcsp_crc_update
c_func
(paren
op_amp
id|bcsp
op_member_access_from_pointer
id|message_crc
comma
l_int|0xdb
)paren
suffix:semicolon
id|bcsp-&gt;rx_esc_state
op_assign
id|BCSP_ESCSTATE_NOESC
suffix:semicolon
id|bcsp-&gt;rx_count
op_decrement
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|BT_ERR
(paren
l_string|&quot;Invalid byte %02x after esc byte&quot;
comma
id|byte
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|bcsp-&gt;rx_skb
)paren
suffix:semicolon
id|bcsp-&gt;rx_skb
op_assign
l_int|NULL
suffix:semicolon
id|bcsp-&gt;rx_state
op_assign
id|BCSP_W4_PKT_DELIMITER
suffix:semicolon
id|bcsp-&gt;rx_count
op_assign
l_int|0
suffix:semicolon
)brace
)brace
)brace
DECL|function|bcsp_complete_rx_pkt
r_static
r_inline
r_void
id|bcsp_complete_rx_pkt
c_func
(paren
r_struct
id|hci_uart
op_star
id|hu
)paren
(brace
r_struct
id|bcsp_struct
op_star
id|bcsp
op_assign
id|hu-&gt;priv
suffix:semicolon
r_int
id|pass_up
suffix:semicolon
r_if
c_cond
(paren
id|bcsp-&gt;rx_skb-&gt;data
(braket
l_int|0
)braket
op_amp
l_int|0x80
)paren
(brace
multiline_comment|/* reliable pkt */
id|BT_DBG
c_func
(paren
l_string|&quot;Received seqno %u from card&quot;
comma
id|bcsp-&gt;rxseq_txack
)paren
suffix:semicolon
id|bcsp-&gt;rxseq_txack
op_increment
suffix:semicolon
id|bcsp-&gt;rxseq_txack
op_mod_assign
l_int|0x8
suffix:semicolon
id|bcsp-&gt;txack_req
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* If needed, transmit an ack pkt */
id|hci_uart_tx_wakeup
c_func
(paren
id|hu
)paren
suffix:semicolon
)brace
id|bcsp-&gt;rxack
op_assign
(paren
id|bcsp-&gt;rx_skb-&gt;data
(braket
l_int|0
)braket
op_rshift
l_int|3
)paren
op_amp
l_int|0x07
suffix:semicolon
id|BT_DBG
c_func
(paren
l_string|&quot;Request for pkt %u from card&quot;
comma
id|bcsp-&gt;rxack
)paren
suffix:semicolon
id|bcsp_pkt_cull
c_func
(paren
id|bcsp
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|bcsp-&gt;rx_skb-&gt;data
(braket
l_int|1
)braket
op_amp
l_int|0x0f
)paren
op_eq
l_int|6
op_logical_and
id|bcsp-&gt;rx_skb-&gt;data
(braket
l_int|0
)braket
op_amp
l_int|0x80
)paren
(brace
id|bcsp-&gt;rx_skb-&gt;pkt_type
op_assign
id|HCI_ACLDATA_PKT
suffix:semicolon
id|pass_up
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|bcsp-&gt;rx_skb-&gt;data
(braket
l_int|1
)braket
op_amp
l_int|0x0f
)paren
op_eq
l_int|5
op_logical_and
id|bcsp-&gt;rx_skb-&gt;data
(braket
l_int|0
)braket
op_amp
l_int|0x80
)paren
(brace
id|bcsp-&gt;rx_skb-&gt;pkt_type
op_assign
id|HCI_EVENT_PKT
suffix:semicolon
id|pass_up
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|bcsp-&gt;rx_skb-&gt;data
(braket
l_int|1
)braket
op_amp
l_int|0x0f
)paren
op_eq
l_int|7
)paren
(brace
id|bcsp-&gt;rx_skb-&gt;pkt_type
op_assign
id|HCI_SCODATA_PKT
suffix:semicolon
id|pass_up
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|bcsp-&gt;rx_skb-&gt;data
(braket
l_int|1
)braket
op_amp
l_int|0x0f
)paren
op_eq
l_int|1
op_logical_and
op_logical_neg
(paren
id|bcsp-&gt;rx_skb-&gt;data
(braket
l_int|0
)braket
op_amp
l_int|0x80
)paren
)paren
(brace
id|bcsp_handle_le_pkt
c_func
(paren
id|hu
)paren
suffix:semicolon
id|pass_up
op_assign
l_int|0
suffix:semicolon
)brace
r_else
id|pass_up
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pass_up
)paren
(brace
r_if
c_cond
(paren
(paren
id|bcsp-&gt;rx_skb-&gt;data
(braket
l_int|1
)braket
op_amp
l_int|0x0f
)paren
op_ne
l_int|0
op_logical_and
(paren
id|bcsp-&gt;rx_skb-&gt;data
(braket
l_int|1
)braket
op_amp
l_int|0x0f
)paren
op_ne
l_int|1
)paren
(brace
id|BT_ERR
(paren
l_string|&quot;Packet for unknown channel (%u %s)&quot;
comma
id|bcsp-&gt;rx_skb-&gt;data
(braket
l_int|1
)braket
op_amp
l_int|0x0f
comma
id|bcsp-&gt;rx_skb-&gt;data
(braket
l_int|0
)braket
op_amp
l_int|0x80
ques
c_cond
l_string|&quot;reliable&quot;
suffix:colon
l_string|&quot;unreliable&quot;
)paren
suffix:semicolon
)brace
id|kfree_skb
c_func
(paren
id|bcsp-&gt;rx_skb
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Pull out BCSP hdr */
id|skb_pull
c_func
(paren
id|bcsp-&gt;rx_skb
comma
l_int|4
)paren
suffix:semicolon
id|hci_recv_frame
c_func
(paren
id|bcsp-&gt;rx_skb
)paren
suffix:semicolon
)brace
id|bcsp-&gt;rx_state
op_assign
id|BCSP_W4_PKT_DELIMITER
suffix:semicolon
id|bcsp-&gt;rx_skb
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* Recv data */
DECL|function|bcsp_recv
r_static
r_int
id|bcsp_recv
c_func
(paren
r_struct
id|hci_uart
op_star
id|hu
comma
r_void
op_star
id|data
comma
r_int
id|count
)paren
(brace
r_struct
id|bcsp_struct
op_star
id|bcsp
op_assign
id|hu-&gt;priv
suffix:semicolon
r_register
r_int
r_char
op_star
id|ptr
suffix:semicolon
id|BT_DBG
c_func
(paren
l_string|&quot;hu %p count %d rx_state %d rx_count %ld&quot;
comma
id|hu
comma
id|count
comma
id|bcsp-&gt;rx_state
comma
id|bcsp-&gt;rx_count
)paren
suffix:semicolon
id|ptr
op_assign
id|data
suffix:semicolon
r_while
c_loop
(paren
id|count
)paren
(brace
r_if
c_cond
(paren
id|bcsp-&gt;rx_count
)paren
(brace
r_if
c_cond
(paren
op_star
id|ptr
op_eq
l_int|0xc0
)paren
(brace
id|BT_ERR
c_func
(paren
l_string|&quot;Short BCSP packet&quot;
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|bcsp-&gt;rx_skb
)paren
suffix:semicolon
id|bcsp-&gt;rx_state
op_assign
id|BCSP_W4_PKT_START
suffix:semicolon
id|bcsp-&gt;rx_count
op_assign
l_int|0
suffix:semicolon
)brace
r_else
id|bcsp_unslip_one_byte
c_func
(paren
id|bcsp
comma
op_star
id|ptr
)paren
suffix:semicolon
id|ptr
op_increment
suffix:semicolon
id|count
op_decrement
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|bcsp-&gt;rx_state
)paren
(brace
r_case
id|BCSP_W4_BCSP_HDR
suffix:colon
r_if
c_cond
(paren
(paren
l_int|0xff
op_amp
(paren
id|u8
)paren
op_complement
(paren
id|bcsp-&gt;rx_skb-&gt;data
(braket
l_int|0
)braket
op_plus
id|bcsp-&gt;rx_skb-&gt;data
(braket
l_int|1
)braket
op_plus
id|bcsp-&gt;rx_skb-&gt;data
(braket
l_int|2
)braket
)paren
)paren
op_ne
id|bcsp-&gt;rx_skb-&gt;data
(braket
l_int|3
)braket
)paren
(brace
id|BT_ERR
c_func
(paren
l_string|&quot;Error in BCSP hdr checksum&quot;
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|bcsp-&gt;rx_skb
)paren
suffix:semicolon
id|bcsp-&gt;rx_state
op_assign
id|BCSP_W4_PKT_DELIMITER
suffix:semicolon
id|bcsp-&gt;rx_count
op_assign
l_int|0
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bcsp-&gt;rx_skb-&gt;data
(braket
l_int|0
)braket
op_amp
l_int|0x80
multiline_comment|/* reliable pkt */
op_logical_and
(paren
id|bcsp-&gt;rx_skb-&gt;data
(braket
l_int|0
)braket
op_amp
l_int|0x07
)paren
op_ne
id|bcsp-&gt;rxseq_txack
)paren
(brace
id|BT_ERR
(paren
l_string|&quot;Out-of-order packet arrived, got %u expected %u&quot;
comma
id|bcsp-&gt;rx_skb-&gt;data
(braket
l_int|0
)braket
op_amp
l_int|0x07
comma
id|bcsp-&gt;rxseq_txack
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|bcsp-&gt;rx_skb
)paren
suffix:semicolon
id|bcsp-&gt;rx_state
op_assign
id|BCSP_W4_PKT_DELIMITER
suffix:semicolon
id|bcsp-&gt;rx_count
op_assign
l_int|0
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|bcsp-&gt;rx_state
op_assign
id|BCSP_W4_DATA
suffix:semicolon
id|bcsp-&gt;rx_count
op_assign
(paren
id|bcsp-&gt;rx_skb-&gt;data
(braket
l_int|1
)braket
op_rshift
l_int|4
)paren
op_plus
(paren
id|bcsp-&gt;rx_skb-&gt;data
(braket
l_int|2
)braket
op_lshift
l_int|4
)paren
suffix:semicolon
multiline_comment|/* May be 0 */
r_continue
suffix:semicolon
r_case
id|BCSP_W4_DATA
suffix:colon
r_if
c_cond
(paren
id|bcsp-&gt;rx_skb-&gt;data
(braket
l_int|0
)braket
op_amp
l_int|0x40
)paren
(brace
multiline_comment|/* pkt with crc */
id|bcsp-&gt;rx_state
op_assign
id|BCSP_W4_CRC
suffix:semicolon
id|bcsp-&gt;rx_count
op_assign
l_int|2
suffix:semicolon
)brace
r_else
id|bcsp_complete_rx_pkt
c_func
(paren
id|hu
)paren
suffix:semicolon
r_continue
suffix:semicolon
r_case
id|BCSP_W4_CRC
suffix:colon
r_if
c_cond
(paren
id|bcsp_crc_reverse
c_func
(paren
id|bcsp-&gt;message_crc
)paren
op_ne
(paren
id|bcsp-&gt;rx_skb-&gt;data
(braket
id|bcsp-&gt;rx_skb-&gt;len
op_minus
l_int|2
)braket
op_lshift
l_int|8
)paren
op_plus
id|bcsp-&gt;rx_skb-&gt;data
(braket
id|bcsp-&gt;rx_skb-&gt;len
op_minus
l_int|1
)braket
)paren
(brace
id|BT_ERR
(paren
l_string|&quot;Checksum failed: computed %04x received %04x&quot;
comma
id|bcsp_crc_reverse
c_func
(paren
id|bcsp-&gt;message_crc
)paren
comma
(paren
id|bcsp-&gt;rx_skb
op_member_access_from_pointer
id|data
(braket
id|bcsp-&gt;rx_skb-&gt;len
op_minus
l_int|2
)braket
op_lshift
l_int|8
)paren
op_plus
id|bcsp-&gt;rx_skb-&gt;data
(braket
id|bcsp-&gt;rx_skb-&gt;len
op_minus
l_int|1
)braket
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|bcsp-&gt;rx_skb
)paren
suffix:semicolon
id|bcsp-&gt;rx_state
op_assign
id|BCSP_W4_PKT_DELIMITER
suffix:semicolon
id|bcsp-&gt;rx_count
op_assign
l_int|0
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|skb_trim
c_func
(paren
id|bcsp-&gt;rx_skb
comma
id|bcsp-&gt;rx_skb-&gt;len
op_minus
l_int|2
)paren
suffix:semicolon
id|bcsp_complete_rx_pkt
c_func
(paren
id|hu
)paren
suffix:semicolon
r_continue
suffix:semicolon
r_case
id|BCSP_W4_PKT_DELIMITER
suffix:colon
r_switch
c_cond
(paren
op_star
id|ptr
)paren
(brace
r_case
l_int|0xc0
suffix:colon
id|bcsp-&gt;rx_state
op_assign
id|BCSP_W4_PKT_START
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/*BT_ERR(&quot;Ignoring byte %02x&quot;, *ptr);*/
r_break
suffix:semicolon
)brace
id|ptr
op_increment
suffix:semicolon
id|count
op_decrement
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BCSP_W4_PKT_START
suffix:colon
r_switch
c_cond
(paren
op_star
id|ptr
)paren
(brace
r_case
l_int|0xc0
suffix:colon
id|ptr
op_increment
suffix:semicolon
id|count
op_decrement
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|bcsp-&gt;rx_state
op_assign
id|BCSP_W4_BCSP_HDR
suffix:semicolon
id|bcsp-&gt;rx_count
op_assign
l_int|4
suffix:semicolon
id|bcsp-&gt;rx_esc_state
op_assign
id|BCSP_ESCSTATE_NOESC
suffix:semicolon
id|BCSP_CRC_INIT
c_func
(paren
id|bcsp-&gt;message_crc
)paren
suffix:semicolon
multiline_comment|/* Do not increment ptr or decrement count&n;&t;&t;&t;&t; * Allocate packet. Max len of a BCSP pkt= &n;&t;&t;&t;&t; * 0xFFF (payload) +4 (header) +2 (crc) */
id|bcsp-&gt;rx_skb
op_assign
id|bt_skb_alloc
c_func
(paren
l_int|0x1005
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bcsp-&gt;rx_skb
)paren
(brace
id|BT_ERR
c_func
(paren
l_string|&quot;Can&squot;t allocate mem for new packet&quot;
)paren
suffix:semicolon
id|bcsp-&gt;rx_state
op_assign
id|BCSP_W4_PKT_DELIMITER
suffix:semicolon
id|bcsp-&gt;rx_count
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|bcsp-&gt;rx_skb-&gt;dev
op_assign
(paren
r_void
op_star
)paren
id|hu-&gt;hdev
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
)brace
r_return
id|count
suffix:semicolon
)brace
multiline_comment|/* Arrange to retransmit all messages in the relq. */
DECL|function|bcsp_timed_event
r_static
r_void
id|bcsp_timed_event
c_func
(paren
r_int
r_int
id|arg
)paren
(brace
r_struct
id|hci_uart
op_star
id|hu
op_assign
(paren
r_struct
id|hci_uart
op_star
)paren
id|arg
suffix:semicolon
r_struct
id|bcsp_struct
op_star
id|bcsp
op_assign
id|hu-&gt;priv
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|BT_DBG
c_func
(paren
l_string|&quot;hu %p retransmitting %u pkts&quot;
comma
id|hu
comma
id|bcsp-&gt;unack.qlen
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|bcsp-&gt;unack.lock
comma
id|flags
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|skb
op_assign
id|__skb_dequeue_tail
c_func
(paren
op_amp
id|bcsp-&gt;unack
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|bcsp-&gt;msgq_txseq
op_assign
(paren
id|bcsp-&gt;msgq_txseq
op_minus
l_int|1
)paren
op_amp
l_int|0x07
suffix:semicolon
id|skb_queue_head
c_func
(paren
op_amp
id|bcsp-&gt;rel
comma
id|skb
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|bcsp-&gt;unack.lock
comma
id|flags
)paren
suffix:semicolon
id|hci_uart_tx_wakeup
c_func
(paren
id|hu
)paren
suffix:semicolon
)brace
DECL|function|bcsp_open
r_static
r_int
id|bcsp_open
c_func
(paren
r_struct
id|hci_uart
op_star
id|hu
)paren
(brace
r_struct
id|bcsp_struct
op_star
id|bcsp
suffix:semicolon
id|BT_DBG
c_func
(paren
l_string|&quot;hu %p&quot;
comma
id|hu
)paren
suffix:semicolon
id|bcsp
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|bcsp
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bcsp
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|bcsp
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|bcsp
)paren
)paren
suffix:semicolon
id|hu-&gt;priv
op_assign
id|bcsp
suffix:semicolon
id|skb_queue_head_init
c_func
(paren
op_amp
id|bcsp-&gt;unack
)paren
suffix:semicolon
id|skb_queue_head_init
c_func
(paren
op_amp
id|bcsp-&gt;rel
)paren
suffix:semicolon
id|skb_queue_head_init
c_func
(paren
op_amp
id|bcsp-&gt;unrel
)paren
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|bcsp-&gt;tbcsp
)paren
suffix:semicolon
id|bcsp-&gt;tbcsp.function
op_assign
id|bcsp_timed_event
suffix:semicolon
id|bcsp-&gt;tbcsp.data
op_assign
(paren
id|u_long
)paren
id|hu
suffix:semicolon
id|bcsp-&gt;rx_state
op_assign
id|BCSP_W4_PKT_DELIMITER
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|bcsp_close
r_static
r_int
id|bcsp_close
c_func
(paren
r_struct
id|hci_uart
op_star
id|hu
)paren
(brace
r_struct
id|bcsp_struct
op_star
id|bcsp
op_assign
id|hu-&gt;priv
suffix:semicolon
id|hu-&gt;priv
op_assign
l_int|NULL
suffix:semicolon
id|BT_DBG
c_func
(paren
l_string|&quot;hu %p&quot;
comma
id|hu
)paren
suffix:semicolon
id|skb_queue_purge
c_func
(paren
op_amp
id|bcsp-&gt;unack
)paren
suffix:semicolon
id|skb_queue_purge
c_func
(paren
op_amp
id|bcsp-&gt;rel
)paren
suffix:semicolon
id|skb_queue_purge
c_func
(paren
op_amp
id|bcsp-&gt;unrel
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|bcsp-&gt;tbcsp
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|bcsp
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|bcsp
r_static
r_struct
id|hci_uart_proto
id|bcsp
op_assign
(brace
dot
id|id
op_assign
id|HCI_UART_BCSP
comma
dot
id|open
op_assign
id|bcsp_open
comma
dot
id|close
op_assign
id|bcsp_close
comma
dot
id|enqueue
op_assign
id|bcsp_enqueue
comma
dot
id|dequeue
op_assign
id|bcsp_dequeue
comma
dot
id|recv
op_assign
id|bcsp_recv
comma
dot
id|flush
op_assign
id|bcsp_flush
)brace
suffix:semicolon
DECL|function|bcsp_init
r_int
id|bcsp_init
c_func
(paren
r_void
)paren
(brace
r_int
id|err
op_assign
id|hci_uart_register_proto
c_func
(paren
op_amp
id|bcsp
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|err
)paren
id|BT_INFO
c_func
(paren
l_string|&quot;HCI BCSP protocol initialized&quot;
)paren
suffix:semicolon
r_else
id|BT_ERR
c_func
(paren
l_string|&quot;HCI BCSP protocol registration failed&quot;
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|bcsp_deinit
r_int
id|bcsp_deinit
c_func
(paren
r_void
)paren
(brace
r_return
id|hci_uart_unregister_proto
c_func
(paren
op_amp
id|bcsp
)paren
suffix:semicolon
)brace
eof
