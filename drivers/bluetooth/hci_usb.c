multiline_comment|/* &n;   BlueZ - Bluetooth protocol stack for Linux&n;   Copyright (C) 2000-2001 Qualcomm Incorporated&n;&n;   Written 2000,2001 by Maxim Krasnyansky &lt;maxk@qualcomm.com&gt;&n;&n;   This program is free software; you can redistribute it and/or modify&n;   it under the terms of the GNU General Public License version 2 as&n;   published by the Free Software Foundation;&n;&n;   THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS&n;   OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,&n;   FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT OF THIRD PARTY RIGHTS.&n;   IN NO EVENT SHALL THE COPYRIGHT HOLDER(S) AND AUTHOR(S) BE LIABLE FOR ANY&n;   CLAIM, OR ANY SPECIAL INDIRECT OR CONSEQUENTIAL DAMAGES, OR ANY DAMAGES &n;   WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN &n;   ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF &n;   OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.&n;&n;   ALL LIABILITY, INCLUDING LIABILITY FOR INFRINGEMENT OF ANY PATENTS, &n;   COPYRIGHTS, TRADEMARKS OR OTHER RIGHTS, RELATING TO USE OF THIS &n;   SOFTWARE IS DISCLAIMED.&n;*/
multiline_comment|/*&n; * BlueZ HCI USB driver.&n; * Based on original USB Bluetooth driver for Linux kernel&n; *    Copyright (c) 2000 Greg Kroah-Hartman        &lt;greg@kroah.com&gt;&n; *    Copyright (c) 2000 Mark Douglas Corner       &lt;mcorner@umich.edu&gt;&n; *&n; * $Id: hci_usb.c,v 1.5 2001/07/05 18:42:44 maxk Exp $    &n; */
DECL|macro|VERSION
mdefine_line|#define VERSION &quot;1.0&quot;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/poll.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/signal.h&gt;
macro_line|#include &lt;linux/ioctl.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/usb.h&gt;
macro_line|#include &lt;net/bluetooth/bluetooth.h&gt;
macro_line|#include &lt;net/bluetooth/bluez.h&gt;
macro_line|#include &lt;net/bluetooth/hci_core.h&gt;
macro_line|#include &lt;net/bluetooth/hci_usb.h&gt;
macro_line|#ifndef HCI_USB_DEBUG
DECL|macro|DBG
macro_line|#undef  DBG
DECL|macro|DBG
mdefine_line|#define DBG( A... )
DECL|macro|DMP
macro_line|#undef  DMP
DECL|macro|DMP
mdefine_line|#define DMP( A... )
macro_line|#endif
DECL|variable|usb_bluetooth_ids
r_static
r_struct
id|usb_device_id
id|usb_bluetooth_ids
(braket
)braket
op_assign
(brace
(brace
id|USB_DEVICE_INFO
c_func
(paren
id|HCI_DEV_CLASS
comma
id|HCI_DEV_SUBCLASS
comma
id|HCI_DEV_PROTOCOL
)paren
)brace
comma
(brace
)brace
multiline_comment|/* Terminating entry */
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
(paren
id|usb
comma
id|usb_bluetooth_ids
)paren
suffix:semicolon
r_static
r_int
id|hci_usb_ctrl_msg
c_func
(paren
r_struct
id|hci_usb
op_star
id|husb
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
suffix:semicolon
r_static
r_int
id|hci_usb_write_msg
c_func
(paren
r_struct
id|hci_usb
op_star
id|husb
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
suffix:semicolon
DECL|function|hci_usb_unlink_urbs
r_static
r_void
id|hci_usb_unlink_urbs
c_func
(paren
r_struct
id|hci_usb
op_star
id|husb
)paren
(brace
id|usb_unlink_urb
c_func
(paren
id|husb-&gt;read_urb
)paren
suffix:semicolon
id|usb_unlink_urb
c_func
(paren
id|husb-&gt;intr_urb
)paren
suffix:semicolon
id|usb_unlink_urb
c_func
(paren
id|husb-&gt;ctrl_urb
)paren
suffix:semicolon
id|usb_unlink_urb
c_func
(paren
id|husb-&gt;write_urb
)paren
suffix:semicolon
)brace
DECL|function|hci_usb_free_bufs
r_static
r_void
id|hci_usb_free_bufs
c_func
(paren
r_struct
id|hci_usb
op_star
id|husb
)paren
(brace
r_if
c_cond
(paren
id|husb-&gt;read_urb
)paren
(brace
r_if
c_cond
(paren
id|husb-&gt;read_urb-&gt;transfer_buffer
)paren
id|kfree
c_func
(paren
id|husb-&gt;read_urb-&gt;transfer_buffer
)paren
suffix:semicolon
id|usb_free_urb
c_func
(paren
id|husb-&gt;read_urb
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|husb-&gt;intr_urb
)paren
(brace
r_if
c_cond
(paren
id|husb-&gt;intr_urb-&gt;transfer_buffer
)paren
id|kfree
c_func
(paren
id|husb-&gt;intr_urb-&gt;transfer_buffer
)paren
suffix:semicolon
id|usb_free_urb
c_func
(paren
id|husb-&gt;intr_urb
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|husb-&gt;ctrl_urb
)paren
id|usb_free_urb
c_func
(paren
id|husb-&gt;ctrl_urb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|husb-&gt;write_urb
)paren
id|usb_free_urb
c_func
(paren
id|husb-&gt;write_urb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|husb-&gt;intr_skb
)paren
id|kfree_skb
c_func
(paren
id|husb-&gt;intr_skb
)paren
suffix:semicolon
)brace
multiline_comment|/* ------- Interface to HCI layer ------ */
multiline_comment|/* Initialize device */
DECL|function|hci_usb_open
r_int
id|hci_usb_open
c_func
(paren
r_struct
id|hci_dev
op_star
id|hdev
)paren
(brace
r_struct
id|hci_usb
op_star
id|husb
op_assign
(paren
r_struct
id|hci_usb
op_star
)paren
id|hdev-&gt;driver_data
suffix:semicolon
r_int
id|status
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;%s&quot;
comma
id|hdev-&gt;name
)paren
suffix:semicolon
id|husb-&gt;read_urb-&gt;dev
op_assign
id|husb-&gt;udev
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_assign
id|usb_submit_urb
c_func
(paren
id|husb-&gt;read_urb
)paren
)paren
)paren
id|DBG
c_func
(paren
l_string|&quot;read submit failed. %d&quot;
comma
id|status
)paren
suffix:semicolon
id|husb-&gt;intr_urb-&gt;dev
op_assign
id|husb-&gt;udev
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_assign
id|usb_submit_urb
c_func
(paren
id|husb-&gt;intr_urb
)paren
)paren
)paren
id|DBG
c_func
(paren
l_string|&quot;interrupt submit failed. %d&quot;
comma
id|status
)paren
suffix:semicolon
id|hdev-&gt;flags
op_or_assign
id|HCI_RUNNING
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Reset device */
DECL|function|hci_usb_flush
r_int
id|hci_usb_flush
c_func
(paren
r_struct
id|hci_dev
op_star
id|hdev
)paren
(brace
r_struct
id|hci_usb
op_star
id|husb
op_assign
(paren
r_struct
id|hci_usb
op_star
)paren
id|hdev-&gt;driver_data
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;%s&quot;
comma
id|hdev-&gt;name
)paren
suffix:semicolon
multiline_comment|/* Drop TX queues */
id|skb_queue_purge
c_func
(paren
op_amp
id|husb-&gt;tx_ctrl_q
)paren
suffix:semicolon
id|skb_queue_purge
c_func
(paren
op_amp
id|husb-&gt;tx_write_q
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Close device */
DECL|function|hci_usb_close
r_int
id|hci_usb_close
c_func
(paren
r_struct
id|hci_dev
op_star
id|hdev
)paren
(brace
r_struct
id|hci_usb
op_star
id|husb
op_assign
(paren
r_struct
id|hci_usb
op_star
)paren
id|hdev-&gt;driver_data
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;%s&quot;
comma
id|hdev-&gt;name
)paren
suffix:semicolon
id|hdev-&gt;flags
op_and_assign
op_complement
id|HCI_RUNNING
suffix:semicolon
id|hci_usb_unlink_urbs
c_func
(paren
id|husb
)paren
suffix:semicolon
id|hci_usb_flush
c_func
(paren
id|hdev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|hci_usb_ctrl_wakeup
r_void
id|hci_usb_ctrl_wakeup
c_func
(paren
r_struct
id|hci_usb
op_star
id|husb
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
id|HCI_TX_CTRL
comma
op_amp
id|husb-&gt;tx_state
)paren
)paren
r_return
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;%s&quot;
comma
id|husb-&gt;hdev.name
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|husb-&gt;tx_ctrl_q
)paren
)paren
)paren
r_goto
id|done
suffix:semicolon
r_if
c_cond
(paren
id|hci_usb_ctrl_msg
c_func
(paren
id|husb
comma
id|skb
)paren
)paren
(brace
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_goto
id|done
suffix:semicolon
)brace
id|DMP
c_func
(paren
id|skb-&gt;data
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|husb-&gt;hdev.stat.byte_tx
op_add_assign
id|skb-&gt;len
suffix:semicolon
r_return
suffix:semicolon
id|done
suffix:colon
id|clear_bit
c_func
(paren
id|HCI_TX_CTRL
comma
op_amp
id|husb-&gt;tx_state
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|hci_usb_write_wakeup
r_void
id|hci_usb_write_wakeup
c_func
(paren
r_struct
id|hci_usb
op_star
id|husb
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
id|HCI_TX_WRITE
comma
op_amp
id|husb-&gt;tx_state
)paren
)paren
r_return
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;%s&quot;
comma
id|husb-&gt;hdev.name
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|husb-&gt;tx_write_q
)paren
)paren
)paren
r_goto
id|done
suffix:semicolon
r_if
c_cond
(paren
id|hci_usb_write_msg
c_func
(paren
id|husb
comma
id|skb
)paren
)paren
(brace
id|skb_queue_head
c_func
(paren
op_amp
id|husb-&gt;tx_write_q
comma
id|skb
)paren
suffix:semicolon
r_goto
id|done
suffix:semicolon
)brace
id|DMP
c_func
(paren
id|skb-&gt;data
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|husb-&gt;hdev.stat.byte_tx
op_add_assign
id|skb-&gt;len
suffix:semicolon
r_return
suffix:semicolon
id|done
suffix:colon
id|clear_bit
c_func
(paren
id|HCI_TX_WRITE
comma
op_amp
id|husb-&gt;tx_state
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Send frames from HCI layer */
DECL|function|hci_usb_send_frame
r_int
id|hci_usb_send_frame
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|hci_dev
op_star
id|hdev
op_assign
(paren
r_struct
id|hci_dev
op_star
)paren
id|skb-&gt;dev
suffix:semicolon
r_struct
id|hci_usb
op_star
id|husb
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hdev
)paren
(brace
id|ERR
c_func
(paren
l_string|&quot;frame for uknown device (hdev=NULL)&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|hdev-&gt;flags
op_amp
id|HCI_RUNNING
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|husb
op_assign
(paren
r_struct
id|hci_usb
op_star
)paren
id|hdev-&gt;driver_data
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;%s type %d len %d&quot;
comma
id|hdev-&gt;name
comma
id|skb-&gt;pkt_type
comma
id|skb-&gt;len
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|skb-&gt;pkt_type
)paren
(brace
r_case
id|HCI_COMMAND_PKT
suffix:colon
id|skb_queue_tail
c_func
(paren
op_amp
id|husb-&gt;tx_ctrl_q
comma
id|skb
)paren
suffix:semicolon
id|hci_usb_ctrl_wakeup
c_func
(paren
id|husb
)paren
suffix:semicolon
id|hdev-&gt;stat.cmd_tx
op_increment
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|HCI_ACLDATA_PKT
suffix:colon
id|skb_queue_tail
c_func
(paren
op_amp
id|husb-&gt;tx_write_q
comma
id|skb
)paren
suffix:semicolon
id|hci_usb_write_wakeup
c_func
(paren
id|husb
)paren
suffix:semicolon
id|hdev-&gt;stat.acl_tx
op_increment
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|HCI_SCODATA_PKT
suffix:colon
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* ---------- USB ------------- */
DECL|function|hci_usb_ctrl
r_static
r_void
id|hci_usb_ctrl
c_func
(paren
r_struct
id|urb
op_star
id|urb
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
op_assign
(paren
r_struct
id|sk_buff
op_star
)paren
id|urb-&gt;context
suffix:semicolon
r_struct
id|hci_dev
op_star
id|hdev
suffix:semicolon
r_struct
id|hci_usb
op_star
id|husb
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
r_return
suffix:semicolon
id|hdev
op_assign
(paren
r_struct
id|hci_dev
op_star
)paren
id|skb-&gt;dev
suffix:semicolon
id|husb
op_assign
(paren
r_struct
id|hci_usb
op_star
)paren
id|hdev-&gt;driver_data
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;%s&quot;
comma
id|hdev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;status
)paren
id|DBG
c_func
(paren
l_string|&quot;%s ctrl status: %d&quot;
comma
id|hdev-&gt;name
comma
id|urb-&gt;status
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|HCI_TX_CTRL
comma
op_amp
id|husb-&gt;tx_state
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
multiline_comment|/* Wake up device */
id|hci_usb_ctrl_wakeup
c_func
(paren
id|husb
)paren
suffix:semicolon
)brace
DECL|function|hci_usb_bulk_write
r_static
r_void
id|hci_usb_bulk_write
c_func
(paren
r_struct
id|urb
op_star
id|urb
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
op_assign
(paren
r_struct
id|sk_buff
op_star
)paren
id|urb-&gt;context
suffix:semicolon
r_struct
id|hci_dev
op_star
id|hdev
suffix:semicolon
r_struct
id|hci_usb
op_star
id|husb
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
r_return
suffix:semicolon
id|hdev
op_assign
(paren
r_struct
id|hci_dev
op_star
)paren
id|skb-&gt;dev
suffix:semicolon
id|husb
op_assign
(paren
r_struct
id|hci_usb
op_star
)paren
id|hdev-&gt;driver_data
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;%s&quot;
comma
id|hdev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;status
)paren
id|DBG
c_func
(paren
l_string|&quot;%s bulk write status: %d&quot;
comma
id|hdev-&gt;name
comma
id|urb-&gt;status
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|HCI_TX_WRITE
comma
op_amp
id|husb-&gt;tx_state
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
multiline_comment|/* Wake up device */
id|hci_usb_write_wakeup
c_func
(paren
id|husb
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|hci_usb_intr
r_static
r_void
id|hci_usb_intr
c_func
(paren
r_struct
id|urb
op_star
id|urb
)paren
(brace
r_struct
id|hci_usb
op_star
id|husb
op_assign
(paren
r_struct
id|hci_usb
op_star
)paren
id|urb-&gt;context
suffix:semicolon
r_int
r_char
op_star
id|data
op_assign
id|urb-&gt;transfer_buffer
suffix:semicolon
r_register
r_int
id|count
op_assign
id|urb-&gt;actual_length
suffix:semicolon
r_register
r_struct
id|sk_buff
op_star
id|skb
op_assign
id|husb-&gt;intr_skb
suffix:semicolon
id|hci_event_hdr
op_star
id|eh
suffix:semicolon
r_register
r_int
id|len
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|husb
)paren
r_return
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;%s count %d&quot;
comma
id|husb-&gt;hdev.name
comma
id|count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;status
op_logical_or
op_logical_neg
id|count
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;%s intr status %d, count %d&quot;
comma
id|husb-&gt;hdev.name
comma
id|urb-&gt;status
comma
id|count
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Do we really have to handle continuations here ? */
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
(brace
multiline_comment|/* New frame */
r_if
c_cond
(paren
id|count
OL
id|HCI_EVENT_HDR_SIZE
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;%s bad frame len %d&quot;
comma
id|husb-&gt;hdev.name
comma
id|count
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|eh
op_assign
(paren
id|hci_event_hdr
op_star
)paren
id|data
suffix:semicolon
id|len
op_assign
id|eh-&gt;plen
op_plus
id|HCI_EVENT_HDR_SIZE
suffix:semicolon
r_if
c_cond
(paren
id|count
OG
id|len
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;%s corrupted frame, len %d&quot;
comma
id|husb-&gt;hdev.name
comma
id|count
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Allocate skb */
r_if
c_cond
(paren
op_logical_neg
(paren
id|skb
op_assign
id|bluez_skb_alloc
c_func
(paren
id|len
comma
id|GFP_ATOMIC
)paren
)paren
)paren
(brace
id|ERR
c_func
(paren
l_string|&quot;Can&squot;t allocate mem for new packet&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|skb-&gt;dev
op_assign
(paren
r_void
op_star
)paren
op_amp
id|husb-&gt;hdev
suffix:semicolon
id|skb-&gt;pkt_type
op_assign
id|HCI_EVENT_PKT
suffix:semicolon
id|husb-&gt;intr_skb
op_assign
id|skb
suffix:semicolon
id|husb-&gt;intr_count
op_assign
id|len
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Continuation */
r_if
c_cond
(paren
id|count
OG
id|husb-&gt;intr_count
)paren
(brace
id|ERR
c_func
(paren
l_string|&quot;%s bad frame len %d (expected %d)&quot;
comma
id|husb-&gt;hdev.name
comma
id|count
comma
id|husb-&gt;intr_count
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|husb-&gt;intr_skb
op_assign
l_int|NULL
suffix:semicolon
id|husb-&gt;intr_count
op_assign
l_int|0
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|count
)paren
comma
id|data
comma
id|count
)paren
suffix:semicolon
id|husb-&gt;intr_count
op_sub_assign
id|count
suffix:semicolon
id|DMP
c_func
(paren
id|data
comma
id|count
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|husb-&gt;intr_count
)paren
(brace
multiline_comment|/* Got complete frame */
id|husb-&gt;hdev.stat.byte_rx
op_add_assign
id|skb-&gt;len
suffix:semicolon
id|hci_recv_frame
c_func
(paren
id|skb
)paren
suffix:semicolon
id|husb-&gt;intr_skb
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
DECL|function|hci_usb_bulk_read
r_static
r_void
id|hci_usb_bulk_read
c_func
(paren
r_struct
id|urb
op_star
id|urb
)paren
(brace
r_struct
id|hci_usb
op_star
id|husb
op_assign
(paren
r_struct
id|hci_usb
op_star
)paren
id|urb-&gt;context
suffix:semicolon
r_int
r_char
op_star
id|data
op_assign
id|urb-&gt;transfer_buffer
suffix:semicolon
r_int
id|count
op_assign
id|urb-&gt;actual_length
comma
id|status
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|hci_acl_hdr
op_star
id|ah
suffix:semicolon
r_register
id|__u16
id|dlen
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|husb
)paren
r_return
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;%s status %d, count %d, flags %x&quot;
comma
id|husb-&gt;hdev.name
comma
id|urb-&gt;status
comma
id|count
comma
id|urb-&gt;transfer_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;status
)paren
(brace
multiline_comment|/* Do not re-submit URB on critical errors */
r_switch
c_cond
(paren
id|urb-&gt;status
)paren
(brace
r_case
op_minus
id|ENOENT
suffix:colon
r_return
suffix:semicolon
r_default
suffix:colon
r_goto
id|resubmit
suffix:semicolon
)brace
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|count
)paren
r_goto
id|resubmit
suffix:semicolon
id|DMP
c_func
(paren
id|data
comma
id|count
)paren
suffix:semicolon
id|ah
op_assign
(paren
id|hci_acl_hdr
op_star
)paren
id|data
suffix:semicolon
id|dlen
op_assign
id|le16_to_cpu
c_func
(paren
id|ah-&gt;dlen
)paren
suffix:semicolon
multiline_comment|/* Verify frame len and completeness */
r_if
c_cond
(paren
(paren
id|count
op_minus
id|HCI_ACL_HDR_SIZE
)paren
op_ne
id|dlen
)paren
(brace
id|ERR
c_func
(paren
l_string|&quot;%s corrupted ACL packet: count %d, plen %d&quot;
comma
id|husb-&gt;hdev.name
comma
id|count
comma
id|dlen
)paren
suffix:semicolon
r_goto
id|resubmit
suffix:semicolon
)brace
multiline_comment|/* Allocate packet */
r_if
c_cond
(paren
op_logical_neg
(paren
id|skb
op_assign
id|bluez_skb_alloc
c_func
(paren
id|count
comma
id|GFP_ATOMIC
)paren
)paren
)paren
(brace
id|ERR
c_func
(paren
l_string|&quot;Can&squot;t allocate mem for new packet&quot;
)paren
suffix:semicolon
r_goto
id|resubmit
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|count
)paren
comma
id|data
comma
id|count
)paren
suffix:semicolon
id|skb-&gt;dev
op_assign
(paren
r_void
op_star
)paren
op_amp
id|husb-&gt;hdev
suffix:semicolon
id|skb-&gt;pkt_type
op_assign
id|HCI_ACLDATA_PKT
suffix:semicolon
id|husb-&gt;hdev.stat.byte_rx
op_add_assign
id|skb-&gt;len
suffix:semicolon
id|hci_recv_frame
c_func
(paren
id|skb
)paren
suffix:semicolon
id|resubmit
suffix:colon
id|husb-&gt;read_urb-&gt;dev
op_assign
id|husb-&gt;udev
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_assign
id|usb_submit_urb
c_func
(paren
id|husb-&gt;read_urb
)paren
)paren
)paren
id|DBG
c_func
(paren
l_string|&quot;%s read URB submit failed %d&quot;
comma
id|husb-&gt;hdev.name
comma
id|status
)paren
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;%s read URB re-submited&quot;
comma
id|husb-&gt;hdev.name
)paren
suffix:semicolon
)brace
DECL|function|hci_usb_ctrl_msg
r_static
r_int
id|hci_usb_ctrl_msg
c_func
(paren
r_struct
id|hci_usb
op_star
id|husb
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|urb
op_star
id|urb
op_assign
id|husb-&gt;ctrl_urb
suffix:semicolon
id|devrequest
op_star
id|dr
op_assign
op_amp
id|husb-&gt;dev_req
suffix:semicolon
r_int
id|pipe
comma
id|status
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;%s len %d&quot;
comma
id|husb-&gt;hdev.name
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|pipe
op_assign
id|usb_sndctrlpipe
c_func
(paren
id|husb-&gt;udev
comma
l_int|0
)paren
suffix:semicolon
id|dr-&gt;requesttype
op_assign
id|HCI_CTRL_REQ
suffix:semicolon
id|dr-&gt;request
op_assign
l_int|0
suffix:semicolon
id|dr-&gt;index
op_assign
l_int|0
suffix:semicolon
id|dr-&gt;value
op_assign
l_int|0
suffix:semicolon
id|dr-&gt;length
op_assign
id|cpu_to_le16
c_func
(paren
id|skb-&gt;len
)paren
suffix:semicolon
id|FILL_CONTROL_URB
c_func
(paren
id|urb
comma
id|husb-&gt;udev
comma
id|pipe
comma
(paren
r_void
op_star
)paren
id|dr
comma
id|skb-&gt;data
comma
id|skb-&gt;len
comma
id|hci_usb_ctrl
comma
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_assign
id|usb_submit_urb
c_func
(paren
id|urb
)paren
)paren
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;%s control URB submit failed %d&quot;
comma
id|husb-&gt;hdev.name
comma
id|status
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|hci_usb_write_msg
r_static
r_int
id|hci_usb_write_msg
c_func
(paren
r_struct
id|hci_usb
op_star
id|husb
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|urb
op_star
id|urb
op_assign
id|husb-&gt;write_urb
suffix:semicolon
r_int
id|pipe
comma
id|status
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;%s len %d&quot;
comma
id|husb-&gt;hdev.name
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|pipe
op_assign
id|usb_sndbulkpipe
c_func
(paren
id|husb-&gt;udev
comma
id|husb-&gt;bulk_out_ep_addr
)paren
suffix:semicolon
id|FILL_BULK_URB
c_func
(paren
id|urb
comma
id|husb-&gt;udev
comma
id|pipe
comma
id|skb-&gt;data
comma
id|skb-&gt;len
comma
id|hci_usb_bulk_write
comma
id|skb
)paren
suffix:semicolon
id|urb-&gt;transfer_flags
op_or_assign
id|USB_QUEUE_BULK
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_assign
id|usb_submit_urb
c_func
(paren
id|urb
)paren
)paren
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;%s write URB submit failed %d&quot;
comma
id|husb-&gt;hdev.name
comma
id|status
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|hci_usb_probe
r_static
r_void
op_star
id|hci_usb_probe
c_func
(paren
r_struct
id|usb_device
op_star
id|udev
comma
r_int
r_int
id|ifnum
comma
r_const
r_struct
id|usb_device_id
op_star
id|id
)paren
(brace
r_struct
id|usb_endpoint_descriptor
op_star
id|bulk_out_ep
comma
op_star
id|intr_in_ep
comma
op_star
id|bulk_in_ep
suffix:semicolon
r_struct
id|usb_interface_descriptor
op_star
id|uif
suffix:semicolon
r_struct
id|usb_endpoint_descriptor
op_star
id|ep
suffix:semicolon
r_struct
id|hci_usb
op_star
id|husb
suffix:semicolon
r_struct
id|hci_dev
op_star
id|hdev
suffix:semicolon
r_int
id|i
comma
id|size
comma
id|pipe
suffix:semicolon
id|__u8
op_star
id|buf
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;udev %p ifnum %d&quot;
comma
id|udev
comma
id|ifnum
)paren
suffix:semicolon
multiline_comment|/* Check device signature */
r_if
c_cond
(paren
(paren
id|udev-&gt;descriptor.bDeviceClass
op_ne
id|HCI_DEV_CLASS
)paren
op_logical_or
(paren
id|udev-&gt;descriptor.bDeviceSubClass
op_ne
id|HCI_DEV_SUBCLASS
)paren
op_logical_or
(paren
id|udev-&gt;descriptor.bDeviceProtocol
op_ne
id|HCI_DEV_PROTOCOL
)paren
)paren
r_return
l_int|NULL
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
id|uif
op_assign
op_amp
id|udev-&gt;actconfig-&gt;interface
(braket
id|ifnum
)braket
dot
id|altsetting
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|uif-&gt;bNumEndpoints
op_ne
l_int|3
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;Wrong number of endpoints %d&quot;
comma
id|uif-&gt;bNumEndpoints
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|bulk_out_ep
op_assign
id|intr_in_ep
op_assign
id|bulk_in_ep
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Find endpoints that we need */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|uif-&gt;bNumEndpoints
suffix:semicolon
op_increment
id|i
)paren
(brace
id|ep
op_assign
op_amp
id|uif-&gt;endpoint
(braket
id|i
)braket
suffix:semicolon
r_switch
c_cond
(paren
id|ep-&gt;bmAttributes
op_amp
id|USB_ENDPOINT_XFERTYPE_MASK
)paren
(brace
r_case
id|USB_ENDPOINT_XFER_BULK
suffix:colon
r_if
c_cond
(paren
id|ep-&gt;bEndpointAddress
op_amp
id|USB_DIR_IN
)paren
id|bulk_in_ep
op_assign
id|ep
suffix:semicolon
r_else
id|bulk_out_ep
op_assign
id|ep
suffix:semicolon
r_break
suffix:semicolon
r_case
id|USB_ENDPOINT_XFER_INT
suffix:colon
id|intr_in_ep
op_assign
id|ep
suffix:semicolon
r_break
suffix:semicolon
)brace
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|bulk_in_ep
op_logical_or
op_logical_neg
id|bulk_out_ep
op_logical_or
op_logical_neg
id|intr_in_ep
)paren
(brace
id|DBG
c_func
(paren
l_string|&quot;Endpoints not found: %p %p %p&quot;
comma
id|bulk_in_ep
comma
id|bulk_out_ep
comma
id|intr_in_ep
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|husb
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|hci_usb
)paren
comma
id|GFP_KERNEL
)paren
)paren
)paren
(brace
id|ERR
c_func
(paren
l_string|&quot;Can&squot;t allocate: control structure&quot;
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|memset
c_func
(paren
id|husb
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|hci_usb
)paren
)paren
suffix:semicolon
id|husb-&gt;udev
op_assign
id|udev
suffix:semicolon
id|husb-&gt;bulk_out_ep_addr
op_assign
id|bulk_out_ep-&gt;bEndpointAddress
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|husb-&gt;ctrl_urb
op_assign
id|usb_alloc_urb
c_func
(paren
l_int|0
)paren
)paren
)paren
(brace
id|ERR
c_func
(paren
l_string|&quot;Can&squot;t allocate: control URB&quot;
)paren
suffix:semicolon
r_goto
id|probe_error
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|husb-&gt;write_urb
op_assign
id|usb_alloc_urb
c_func
(paren
l_int|0
)paren
)paren
)paren
(brace
id|ERR
c_func
(paren
l_string|&quot;Can&squot;t allocate: write URB&quot;
)paren
suffix:semicolon
r_goto
id|probe_error
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|husb-&gt;read_urb
op_assign
id|usb_alloc_urb
c_func
(paren
l_int|0
)paren
)paren
)paren
(brace
id|ERR
c_func
(paren
l_string|&quot;Can&squot;t allocate: read URB&quot;
)paren
suffix:semicolon
r_goto
id|probe_error
suffix:semicolon
)brace
id|ep
op_assign
id|bulk_in_ep
suffix:semicolon
id|pipe
op_assign
id|usb_rcvbulkpipe
c_func
(paren
id|udev
comma
id|ep-&gt;bEndpointAddress
)paren
suffix:semicolon
id|size
op_assign
id|HCI_MAX_FRAME_SIZE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|buf
op_assign
id|kmalloc
c_func
(paren
id|size
comma
id|GFP_KERNEL
)paren
)paren
)paren
(brace
id|ERR
c_func
(paren
l_string|&quot;Can&squot;t allocate: read buffer&quot;
)paren
suffix:semicolon
r_goto
id|probe_error
suffix:semicolon
)brace
id|FILL_BULK_URB
c_func
(paren
id|husb-&gt;read_urb
comma
id|udev
comma
id|pipe
comma
id|buf
comma
id|size
comma
id|hci_usb_bulk_read
comma
id|husb
)paren
suffix:semicolon
id|husb-&gt;read_urb-&gt;transfer_flags
op_or_assign
id|USB_QUEUE_BULK
suffix:semicolon
id|ep
op_assign
id|intr_in_ep
suffix:semicolon
id|pipe
op_assign
id|usb_rcvintpipe
c_func
(paren
id|udev
comma
id|ep-&gt;bEndpointAddress
)paren
suffix:semicolon
id|size
op_assign
id|usb_maxpacket
c_func
(paren
id|udev
comma
id|pipe
comma
id|usb_pipeout
c_func
(paren
id|pipe
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|husb-&gt;intr_urb
op_assign
id|usb_alloc_urb
c_func
(paren
l_int|0
)paren
)paren
)paren
(brace
id|ERR
c_func
(paren
l_string|&quot;Can&squot;t allocate: interrupt URB&quot;
)paren
suffix:semicolon
r_goto
id|probe_error
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|buf
op_assign
id|kmalloc
c_func
(paren
id|size
comma
id|GFP_KERNEL
)paren
)paren
)paren
(brace
id|ERR
c_func
(paren
l_string|&quot;Can&squot;t allocate: interrupt buffer&quot;
)paren
suffix:semicolon
r_goto
id|probe_error
suffix:semicolon
)brace
id|FILL_INT_URB
c_func
(paren
id|husb-&gt;intr_urb
comma
id|udev
comma
id|pipe
comma
id|buf
comma
id|size
comma
id|hci_usb_intr
comma
id|husb
comma
id|ep-&gt;bInterval
)paren
suffix:semicolon
id|skb_queue_head_init
c_func
(paren
op_amp
id|husb-&gt;tx_ctrl_q
)paren
suffix:semicolon
id|skb_queue_head_init
c_func
(paren
op_amp
id|husb-&gt;tx_write_q
)paren
suffix:semicolon
multiline_comment|/* Initialize and register HCI device */
id|hdev
op_assign
op_amp
id|husb-&gt;hdev
suffix:semicolon
id|hdev-&gt;type
op_assign
id|HCI_USB
suffix:semicolon
id|hdev-&gt;driver_data
op_assign
id|husb
suffix:semicolon
id|hdev-&gt;open
op_assign
id|hci_usb_open
suffix:semicolon
id|hdev-&gt;close
op_assign
id|hci_usb_close
suffix:semicolon
id|hdev-&gt;flush
op_assign
id|hci_usb_flush
suffix:semicolon
id|hdev-&gt;send
op_assign
id|hci_usb_send_frame
suffix:semicolon
r_if
c_cond
(paren
id|hci_register_dev
c_func
(paren
id|hdev
)paren
OL
l_int|0
)paren
(brace
id|ERR
c_func
(paren
l_string|&quot;Can&squot;t register HCI device %s&quot;
comma
id|hdev-&gt;name
)paren
suffix:semicolon
r_goto
id|probe_error
suffix:semicolon
)brace
r_return
id|husb
suffix:semicolon
id|probe_error
suffix:colon
id|hci_usb_free_bufs
c_func
(paren
id|husb
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|husb
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|hci_usb_disconnect
r_static
r_void
id|hci_usb_disconnect
c_func
(paren
r_struct
id|usb_device
op_star
id|udev
comma
r_void
op_star
id|ptr
)paren
(brace
r_struct
id|hci_usb
op_star
id|husb
op_assign
(paren
r_struct
id|hci_usb
op_star
)paren
id|ptr
suffix:semicolon
r_struct
id|hci_dev
op_star
id|hdev
op_assign
op_amp
id|husb-&gt;hdev
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|husb
)paren
r_return
suffix:semicolon
id|DBG
c_func
(paren
l_string|&quot;%s&quot;
comma
id|hdev-&gt;name
)paren
suffix:semicolon
id|hci_usb_close
c_func
(paren
id|hdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hci_unregister_dev
c_func
(paren
id|hdev
)paren
OL
l_int|0
)paren
(brace
id|ERR
c_func
(paren
l_string|&quot;Can&squot;t unregister HCI device %s&quot;
comma
id|hdev-&gt;name
)paren
suffix:semicolon
)brace
id|hci_usb_free_bufs
c_func
(paren
id|husb
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|husb
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
DECL|variable|hci_usb_driver
r_static
r_struct
id|usb_driver
id|hci_usb_driver
op_assign
(brace
id|name
suffix:colon
l_string|&quot;hci_usb&quot;
comma
id|probe
suffix:colon
id|hci_usb_probe
comma
id|disconnect
suffix:colon
id|hci_usb_disconnect
comma
id|id_table
suffix:colon
id|usb_bluetooth_ids
comma
)brace
suffix:semicolon
DECL|function|hci_usb_init
r_int
id|hci_usb_init
c_func
(paren
r_void
)paren
(brace
r_int
id|err
suffix:semicolon
id|INF
c_func
(paren
l_string|&quot;BlueZ HCI USB driver ver %s Copyright (C) 2000,2001 Qualcomm Inc&quot;
comma
id|VERSION
)paren
suffix:semicolon
id|INF
c_func
(paren
l_string|&quot;Written 2000,2001 by Maxim Krasnyansky &lt;maxk@qualcomm.com&gt;&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|usb_register
c_func
(paren
op_amp
id|hci_usb_driver
)paren
)paren
OL
l_int|0
)paren
id|ERR
c_func
(paren
l_string|&quot;Failed to register HCI USB driver&quot;
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|hci_usb_cleanup
r_void
id|hci_usb_cleanup
c_func
(paren
r_void
)paren
(brace
id|usb_deregister
c_func
(paren
op_amp
id|hci_usb_driver
)paren
suffix:semicolon
)brace
DECL|variable|hci_usb_init
id|module_init
c_func
(paren
id|hci_usb_init
)paren
suffix:semicolon
DECL|variable|hci_usb_cleanup
id|module_exit
c_func
(paren
id|hci_usb_cleanup
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Maxim Krasnyansky &lt;maxk@qualcomm.com&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;BlueZ HCI USB driver ver &quot;
id|VERSION
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
eof
