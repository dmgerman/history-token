multiline_comment|/*&n; *  linux/drivers/cpufreq/cpufreq_userspace.c&n; *&n; *  Copyright (C)  2001 Russell King&n; *            (C)  2002 - 2004 Dominik Brodowski &lt;linux@brodo.de&gt;&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License version 2 as&n; * published by the Free Software Foundation.&n; *&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/smp.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/cpufreq.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/sysfs.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
multiline_comment|/**&n; * A few values needed by the userspace governor&n; */
DECL|variable|cpu_max_freq
r_static
r_int
r_int
id|cpu_max_freq
(braket
id|NR_CPUS
)braket
suffix:semicolon
DECL|variable|cpu_min_freq
r_static
r_int
r_int
id|cpu_min_freq
(braket
id|NR_CPUS
)braket
suffix:semicolon
DECL|variable|cpu_cur_freq
r_static
r_int
r_int
id|cpu_cur_freq
(braket
id|NR_CPUS
)braket
suffix:semicolon
multiline_comment|/* current CPU freq */
DECL|variable|cpu_set_freq
r_static
r_int
r_int
id|cpu_set_freq
(braket
id|NR_CPUS
)braket
suffix:semicolon
multiline_comment|/* CPU freq desired by userspace */
DECL|variable|cpu_is_managed
r_static
r_int
r_int
id|cpu_is_managed
(braket
id|NR_CPUS
)braket
suffix:semicolon
DECL|variable|current_policy
r_static
r_struct
id|cpufreq_policy
id|current_policy
(braket
id|NR_CPUS
)braket
suffix:semicolon
r_static
id|DECLARE_MUTEX
(paren
id|userspace_sem
)paren
suffix:semicolon
DECL|macro|dprintk
mdefine_line|#define dprintk(msg...) cpufreq_debug_printk(CPUFREQ_DEBUG_GOVERNOR, &quot;userspace&quot;, msg)
multiline_comment|/* keep track of frequency transitions */
r_static
r_int
DECL|function|userspace_cpufreq_notifier
id|userspace_cpufreq_notifier
c_func
(paren
r_struct
id|notifier_block
op_star
id|nb
comma
r_int
r_int
id|val
comma
r_void
op_star
id|data
)paren
(brace
r_struct
id|cpufreq_freqs
op_star
id|freq
op_assign
id|data
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;saving cpu_cur_freq of cpu %u to be %u kHz&bslash;n&quot;
comma
id|freq-&gt;cpu
comma
id|freq
op_member_access_from_pointer
r_new
)paren
suffix:semicolon
id|cpu_cur_freq
(braket
id|freq-&gt;cpu
)braket
op_assign
id|freq
op_member_access_from_pointer
r_new
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|userspace_cpufreq_notifier_block
r_static
r_struct
id|notifier_block
id|userspace_cpufreq_notifier_block
op_assign
(brace
dot
id|notifier_call
op_assign
id|userspace_cpufreq_notifier
)brace
suffix:semicolon
multiline_comment|/** &n; * cpufreq_set - set the CPU frequency&n; * @freq: target frequency in kHz&n; * @cpu: CPU for which the frequency is to be set&n; *&n; * Sets the CPU frequency to freq.&n; */
DECL|function|cpufreq_set
r_static
r_int
id|cpufreq_set
c_func
(paren
r_int
r_int
id|freq
comma
r_int
r_int
id|cpu
)paren
(brace
r_int
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;cpufreq_set for cpu %u, freq %u kHz&bslash;n&quot;
comma
id|cpu
comma
id|freq
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|userspace_sem
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cpu_is_managed
(braket
id|cpu
)braket
)paren
r_goto
id|err
suffix:semicolon
id|cpu_set_freq
(braket
id|cpu
)braket
op_assign
id|freq
suffix:semicolon
r_if
c_cond
(paren
id|freq
OL
id|cpu_min_freq
(braket
id|cpu
)braket
)paren
id|freq
op_assign
id|cpu_min_freq
(braket
id|cpu
)braket
suffix:semicolon
r_if
c_cond
(paren
id|freq
OG
id|cpu_max_freq
(braket
id|cpu
)braket
)paren
id|freq
op_assign
id|cpu_max_freq
(braket
id|cpu
)braket
suffix:semicolon
multiline_comment|/*&n;&t; * We&squot;re safe from concurrent calls to -&gt;target() here&n;&t; * as we hold the userspace_sem lock. If we were calling&n;&t; * cpufreq_driver_target, a deadlock situation might occur:&n;&t; * A: cpufreq_set (lock userspace_sem) -&gt; cpufreq_driver_target(lock policy-&gt;lock)&n;&t; * B: cpufreq_set_policy(lock policy-&gt;lock) -&gt; __cpufreq_governor -&gt; cpufreq_governor_userspace (lock userspace_sem)&n;&t; */
id|ret
op_assign
id|__cpufreq_driver_target
c_func
(paren
op_amp
id|current_policy
(braket
id|cpu
)braket
comma
id|freq
comma
id|CPUFREQ_RELATION_L
)paren
suffix:semicolon
id|err
suffix:colon
id|up
c_func
(paren
op_amp
id|userspace_sem
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/************************** sysfs interface ************************/
DECL|function|show_speed
r_static
id|ssize_t
id|show_speed
(paren
r_struct
id|cpufreq_policy
op_star
id|policy
comma
r_char
op_star
id|buf
)paren
(brace
r_return
id|sprintf
(paren
id|buf
comma
l_string|&quot;%u&bslash;n&quot;
comma
id|cpu_cur_freq
(braket
id|policy-&gt;cpu
)braket
)paren
suffix:semicolon
)brace
r_static
id|ssize_t
DECL|function|store_speed
id|store_speed
(paren
r_struct
id|cpufreq_policy
op_star
id|policy
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_int
r_int
id|freq
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|ret
suffix:semicolon
id|ret
op_assign
id|sscanf
(paren
id|buf
comma
l_string|&quot;%u&quot;
comma
op_amp
id|freq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ne
l_int|1
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|cpufreq_set
c_func
(paren
id|freq
comma
id|policy-&gt;cpu
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
DECL|variable|freq_attr_scaling_setspeed
r_static
r_struct
id|freq_attr
id|freq_attr_scaling_setspeed
op_assign
(brace
dot
id|attr
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;scaling_setspeed&quot;
comma
dot
id|mode
op_assign
l_int|0644
comma
dot
id|owner
op_assign
id|THIS_MODULE
)brace
comma
dot
id|show
op_assign
id|show_speed
comma
dot
id|store
op_assign
id|store_speed
comma
)brace
suffix:semicolon
DECL|function|cpufreq_governor_userspace
r_static
r_int
id|cpufreq_governor_userspace
c_func
(paren
r_struct
id|cpufreq_policy
op_star
id|policy
comma
r_int
r_int
id|event
)paren
(brace
r_int
r_int
id|cpu
op_assign
id|policy-&gt;cpu
suffix:semicolon
r_switch
c_cond
(paren
id|event
)paren
(brace
r_case
id|CPUFREQ_GOV_START
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|cpu_online
c_func
(paren
id|cpu
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|BUG_ON
c_func
(paren
op_logical_neg
id|policy-&gt;cur
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|userspace_sem
)paren
suffix:semicolon
id|cpu_is_managed
(braket
id|cpu
)braket
op_assign
l_int|1
suffix:semicolon
id|cpu_min_freq
(braket
id|cpu
)braket
op_assign
id|policy-&gt;min
suffix:semicolon
id|cpu_max_freq
(braket
id|cpu
)braket
op_assign
id|policy-&gt;max
suffix:semicolon
id|cpu_cur_freq
(braket
id|cpu
)braket
op_assign
id|policy-&gt;cur
suffix:semicolon
id|cpu_set_freq
(braket
id|cpu
)braket
op_assign
id|policy-&gt;cur
suffix:semicolon
id|sysfs_create_file
(paren
op_amp
id|policy-&gt;kobj
comma
op_amp
id|freq_attr_scaling_setspeed.attr
)paren
suffix:semicolon
id|memcpy
(paren
op_amp
id|current_policy
(braket
id|cpu
)braket
comma
id|policy
comma
r_sizeof
(paren
r_struct
id|cpufreq_policy
)paren
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;managing cpu %u started (%u - %u kHz, currently %u kHz)&bslash;n&quot;
comma
id|cpu
comma
id|cpu_min_freq
(braket
id|cpu
)braket
comma
id|cpu_max_freq
(braket
id|cpu
)braket
comma
id|cpu_cur_freq
(braket
id|cpu
)braket
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|userspace_sem
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CPUFREQ_GOV_STOP
suffix:colon
id|down
c_func
(paren
op_amp
id|userspace_sem
)paren
suffix:semicolon
id|cpu_is_managed
(braket
id|cpu
)braket
op_assign
l_int|0
suffix:semicolon
id|cpu_min_freq
(braket
id|cpu
)braket
op_assign
l_int|0
suffix:semicolon
id|cpu_max_freq
(braket
id|cpu
)braket
op_assign
l_int|0
suffix:semicolon
id|cpu_set_freq
(braket
id|cpu
)braket
op_assign
l_int|0
suffix:semicolon
id|sysfs_remove_file
(paren
op_amp
id|policy-&gt;kobj
comma
op_amp
id|freq_attr_scaling_setspeed.attr
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;managing cpu %u stopped&bslash;n&quot;
comma
id|cpu
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|userspace_sem
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CPUFREQ_GOV_LIMITS
suffix:colon
id|down
c_func
(paren
op_amp
id|userspace_sem
)paren
suffix:semicolon
id|cpu_min_freq
(braket
id|cpu
)braket
op_assign
id|policy-&gt;min
suffix:semicolon
id|cpu_max_freq
(braket
id|cpu
)braket
op_assign
id|policy-&gt;max
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;limit event for cpu %u: %u - %u kHz, currently %u kHz, last set to %u kHz&bslash;n&quot;
comma
id|cpu
comma
id|cpu_min_freq
(braket
id|cpu
)braket
comma
id|cpu_max_freq
(braket
id|cpu
)braket
comma
id|cpu_cur_freq
(braket
id|cpu
)braket
comma
id|cpu_set_freq
(braket
id|cpu
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|policy-&gt;max
OL
id|cpu_set_freq
(braket
id|cpu
)braket
)paren
(brace
id|__cpufreq_driver_target
c_func
(paren
op_amp
id|current_policy
(braket
id|cpu
)braket
comma
id|policy-&gt;max
comma
id|CPUFREQ_RELATION_H
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|policy-&gt;min
OG
id|cpu_set_freq
(braket
id|cpu
)braket
)paren
(brace
id|__cpufreq_driver_target
c_func
(paren
op_amp
id|current_policy
(braket
id|cpu
)braket
comma
id|policy-&gt;min
comma
id|CPUFREQ_RELATION_L
)paren
suffix:semicolon
)brace
r_else
(brace
id|__cpufreq_driver_target
c_func
(paren
op_amp
id|current_policy
(braket
id|cpu
)braket
comma
id|cpu_set_freq
(braket
id|cpu
)braket
comma
id|CPUFREQ_RELATION_L
)paren
suffix:semicolon
)brace
id|memcpy
(paren
op_amp
id|current_policy
(braket
id|cpu
)braket
comma
id|policy
comma
r_sizeof
(paren
r_struct
id|cpufreq_policy
)paren
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|userspace_sem
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|cpufreq_gov_userspace
r_struct
id|cpufreq_governor
id|cpufreq_gov_userspace
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;userspace&quot;
comma
dot
id|governor
op_assign
id|cpufreq_governor_userspace
comma
dot
id|owner
op_assign
id|THIS_MODULE
comma
)brace
suffix:semicolon
DECL|variable|cpufreq_gov_userspace
id|EXPORT_SYMBOL
c_func
(paren
id|cpufreq_gov_userspace
)paren
suffix:semicolon
DECL|function|cpufreq_gov_userspace_init
r_static
r_int
id|__init
id|cpufreq_gov_userspace_init
c_func
(paren
r_void
)paren
(brace
id|cpufreq_register_notifier
c_func
(paren
op_amp
id|userspace_cpufreq_notifier_block
comma
id|CPUFREQ_TRANSITION_NOTIFIER
)paren
suffix:semicolon
r_return
id|cpufreq_register_governor
c_func
(paren
op_amp
id|cpufreq_gov_userspace
)paren
suffix:semicolon
)brace
DECL|function|cpufreq_gov_userspace_exit
r_static
r_void
id|__exit
id|cpufreq_gov_userspace_exit
c_func
(paren
r_void
)paren
(brace
id|cpufreq_unregister_governor
c_func
(paren
op_amp
id|cpufreq_gov_userspace
)paren
suffix:semicolon
id|cpufreq_unregister_notifier
c_func
(paren
op_amp
id|userspace_cpufreq_notifier_block
comma
id|CPUFREQ_TRANSITION_NOTIFIER
)paren
suffix:semicolon
)brace
id|MODULE_AUTHOR
(paren
l_string|&quot;Dominik Brodowski &lt;linux@brodo.de&gt;, Russell King &lt;rmk@arm.linux.org.uk&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
(paren
l_string|&quot;CPUfreq policy governor &squot;userspace&squot;&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
DECL|variable|cpufreq_gov_userspace_init
id|fs_initcall
c_func
(paren
id|cpufreq_gov_userspace_init
)paren
suffix:semicolon
DECL|variable|cpufreq_gov_userspace_exit
id|module_exit
c_func
(paren
id|cpufreq_gov_userspace_exit
)paren
suffix:semicolon
eof
