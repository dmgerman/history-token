multiline_comment|/*&n; * sbp2.c - SBP-2 protocol driver for IEEE-1394&n; *&n; * Copyright (C) 2000 James Goodwin, Filanet Corporation (www.filanet.com)&n; * jamesg@filanet.com (JSG)&n; *&n; * Copyright (C) 2003 Ben Collins &lt;bcollins@debian.org&gt;&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or&n; * (at your option) any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software Foundation,&n; * Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.&n; */
multiline_comment|/*&n; * Brief Description:&n; *&n; * This driver implements the Serial Bus Protocol 2 (SBP-2) over IEEE-1394&n; * under Linux. The SBP-2 driver is implemented as an IEEE-1394 high-level&n; * driver. It also registers as a SCSI lower-level driver in order to accept&n; * SCSI commands for transport using SBP-2.&n; *&n; * You may access any attached SBP-2 storage devices as if they were SCSI&n; * devices (e.g. mount /dev/sda1,  fdisk, mkfs, etc.).&n; *&n; * Current Issues:&n; *&n; *&t;- Error Handling: SCSI aborts and bus reset requests are handled somewhat&n; *&t;  but the code needs additional debugging.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/list.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/poll.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/moduleparam.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/blkdev.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;asm/current.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/byteorder.h&gt;
macro_line|#include &lt;asm/atomic.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/scatterlist.h&gt;
macro_line|#include &quot;../scsi/scsi.h&quot;
macro_line|#include &quot;../scsi/hosts.h&quot;
macro_line|#include &quot;ieee1394.h&quot;
macro_line|#include &quot;ieee1394_types.h&quot;
macro_line|#include &quot;ieee1394_core.h&quot;
macro_line|#include &quot;nodemgr.h&quot;
macro_line|#include &quot;hosts.h&quot;
macro_line|#include &quot;nodemgr.h&quot;
macro_line|#include &quot;highlevel.h&quot;
macro_line|#include &quot;ieee1394_transactions.h&quot;
macro_line|#include &quot;sbp2.h&quot;
DECL|variable|__devinitdata
r_static
r_char
id|version
(braket
)braket
id|__devinitdata
op_assign
l_string|&quot;$Rev: 1034 $ Ben Collins &lt;bcollins@debian.org&gt;&quot;
suffix:semicolon
multiline_comment|/*&n; * Module load parameter definitions&n; */
multiline_comment|/*&n; * Change max_speed on module load if you have a bad IEEE-1394&n; * controller that has trouble running 2KB packets at 400mb.&n; *&n; * NOTE: On certain OHCI parts I have seen short packets on async transmit&n; * (probably due to PCI latency/throughput issues with the part). You can&n; * bump down the speed if you are running into problems.&n; */
DECL|variable|max_speed
r_static
r_int
id|max_speed
op_assign
id|IEEE1394_SPEED_MAX
suffix:semicolon
id|module_param
c_func
(paren
id|max_speed
comma
r_int
comma
l_int|0644
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|max_speed
comma
l_string|&quot;Force max speed (3 = 800mb, 2 = 400mb default, 1 = 200mb, 0 = 100mb)&quot;
)paren
suffix:semicolon
multiline_comment|/*&n; * Set serialize_io to 1 if you&squot;d like only one scsi command sent&n; * down to us at a time (debugging). This might be necessary for very&n; * badly behaved sbp2 devices.&n; */
DECL|variable|serialize_io
r_static
r_int
id|serialize_io
op_assign
l_int|0
suffix:semicolon
id|module_param
c_func
(paren
id|serialize_io
comma
r_int
comma
l_int|0444
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|serialize_io
comma
l_string|&quot;Serialize all I/O coming down from the scsi drivers (default = 0)&quot;
)paren
suffix:semicolon
multiline_comment|/*&n; * Bump up max_sectors if you&squot;d like to support very large sized&n; * transfers. Please note that some older sbp2 bridge chips are broken for&n; * transfers greater or equal to 128KB.  Default is a value of 255&n; * sectors, or just under 128KB (at 512 byte sector size). I can note that&n; * the Oxsemi sbp2 chipsets have no problems supporting very large&n; * transfer sizes.&n; */
DECL|variable|max_sectors
r_static
r_int
id|max_sectors
op_assign
id|SBP2_MAX_SECTORS
suffix:semicolon
id|module_param
c_func
(paren
id|max_sectors
comma
r_int
comma
l_int|0444
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|max_sectors
comma
l_string|&quot;Change max sectors per I/O supported (default = 255)&quot;
)paren
suffix:semicolon
multiline_comment|/*&n; * Exclusive login to sbp2 device? In most cases, the sbp2 driver should&n; * do an exclusive login, as it&squot;s generally unsafe to have two hosts&n; * talking to a single sbp2 device at the same time (filesystem coherency,&n; * etc.). If you&squot;re running an sbp2 device that supports multiple logins,&n; * and you&squot;re either running read-only filesystems or some sort of special&n; * filesystem supporting multiple hosts (one such filesystem is OpenGFS,&n; * see opengfs.sourceforge.net for more info), then set exclusive_login&n; * to zero. Note: The Oxsemi OXFW911 sbp2 chipset supports up to four&n; * concurrent logins.&n; */
DECL|variable|exclusive_login
r_static
r_int
id|exclusive_login
op_assign
l_int|1
suffix:semicolon
id|module_param
c_func
(paren
id|exclusive_login
comma
r_int
comma
l_int|0644
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|exclusive_login
comma
l_string|&quot;Exclusive login to sbp2 device (default = 1)&quot;
)paren
suffix:semicolon
multiline_comment|/*&n; * SCSI inquiry hack for really badly behaved sbp2 devices. Turn this on&n; * if your sbp2 device is not properly handling the SCSI inquiry command.&n; * This hack makes the inquiry look more like a typical MS Windows&n; * inquiry.&n; * &n; * If force_inquiry_hack=1 is required for your device to work,&n; * please submit the logged sbp2_firmware_revision value of this device to&n; * the linux1394-devel mailing list.&n; */
DECL|variable|force_inquiry_hack
r_static
r_int
id|force_inquiry_hack
op_assign
l_int|0
suffix:semicolon
id|module_param
c_func
(paren
id|force_inquiry_hack
comma
r_int
comma
l_int|0444
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|force_inquiry_hack
comma
l_string|&quot;Force SCSI inquiry hack (default = 0)&quot;
)paren
suffix:semicolon
multiline_comment|/*&n; * Export information about protocols/devices supported by this driver.&n; */
DECL|variable|sbp2_id_table
r_static
r_struct
id|ieee1394_device_id
id|sbp2_id_table
(braket
)braket
op_assign
(brace
(brace
dot
id|match_flags
op_assign
id|IEEE1394_MATCH_SPECIFIER_ID
op_or
id|IEEE1394_MATCH_VERSION
comma
dot
id|specifier_id
op_assign
id|SBP2_UNIT_SPEC_ID_ENTRY
op_amp
l_int|0xffffff
comma
dot
id|version
op_assign
id|SBP2_SW_VERSION_ENTRY
op_amp
l_int|0xffffff
)brace
comma
(brace
)brace
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|ieee1394
comma
id|sbp2_id_table
)paren
suffix:semicolon
multiline_comment|/*&n; * Debug levels, configured via kernel config, or enable here.&n; */
multiline_comment|/* #define CONFIG_IEEE1394_SBP2_DEBUG_ORBS */
multiline_comment|/* #define CONFIG_IEEE1394_SBP2_DEBUG_DMA */
multiline_comment|/* #define CONFIG_IEEE1394_SBP2_DEBUG 1 */
multiline_comment|/* #define CONFIG_IEEE1394_SBP2_DEBUG 2 */
multiline_comment|/* #define CONFIG_IEEE1394_SBP2_PACKET_DUMP */
macro_line|#ifdef CONFIG_IEEE1394_SBP2_DEBUG_ORBS
DECL|macro|SBP2_ORB_DEBUG
mdefine_line|#define SBP2_ORB_DEBUG(fmt, args...)&t;HPSB_ERR(&quot;sbp2(%s): &quot;fmt, __FUNCTION__, ## args)
DECL|variable|global_outstanding_command_orbs
r_static
id|u32
id|global_outstanding_command_orbs
op_assign
l_int|0
suffix:semicolon
DECL|macro|outstanding_orb_incr
mdefine_line|#define outstanding_orb_incr global_outstanding_command_orbs++
DECL|macro|outstanding_orb_decr
mdefine_line|#define outstanding_orb_decr global_outstanding_command_orbs--
macro_line|#else
DECL|macro|SBP2_ORB_DEBUG
mdefine_line|#define SBP2_ORB_DEBUG(fmt, args...)
DECL|macro|outstanding_orb_incr
mdefine_line|#define outstanding_orb_incr
DECL|macro|outstanding_orb_decr
mdefine_line|#define outstanding_orb_decr
macro_line|#endif
macro_line|#ifdef CONFIG_IEEE1394_SBP2_DEBUG_DMA
DECL|macro|SBP2_DMA_ALLOC
mdefine_line|#define SBP2_DMA_ALLOC(fmt, args...) &bslash;&n;&t;HPSB_ERR(&quot;sbp2(%s)alloc(%d): &quot;fmt, __FUNCTION__, &bslash;&n;&t;&t; ++global_outstanding_dmas, ## args)
DECL|macro|SBP2_DMA_FREE
mdefine_line|#define SBP2_DMA_FREE(fmt, args...) &bslash;&n;&t;HPSB_ERR(&quot;sbp2(%s)free(%d): &quot;fmt, __FUNCTION__, &bslash;&n;&t;&t; --global_outstanding_dmas, ## args)
DECL|variable|global_outstanding_dmas
r_static
id|u32
id|global_outstanding_dmas
op_assign
l_int|0
suffix:semicolon
macro_line|#else
DECL|macro|SBP2_DMA_ALLOC
mdefine_line|#define SBP2_DMA_ALLOC(fmt, args...)
DECL|macro|SBP2_DMA_FREE
mdefine_line|#define SBP2_DMA_FREE(fmt, args...)
macro_line|#endif
macro_line|#if CONFIG_IEEE1394_SBP2_DEBUG &gt;= 2
DECL|macro|SBP2_DEBUG
mdefine_line|#define SBP2_DEBUG(fmt, args...)&t;HPSB_ERR(&quot;sbp2: &quot;fmt, ## args)
DECL|macro|SBP2_INFO
mdefine_line|#define SBP2_INFO(fmt, args...)&t;&t;HPSB_ERR(&quot;sbp2: &quot;fmt, ## args)
DECL|macro|SBP2_NOTICE
mdefine_line|#define SBP2_NOTICE(fmt, args...)&t;HPSB_ERR(&quot;sbp2: &quot;fmt, ## args)
DECL|macro|SBP2_WARN
mdefine_line|#define SBP2_WARN(fmt, args...)&t;&t;HPSB_ERR(&quot;sbp2: &quot;fmt, ## args)
macro_line|#elif CONFIG_IEEE1394_SBP2_DEBUG == 1
DECL|macro|SBP2_DEBUG
mdefine_line|#define SBP2_DEBUG(fmt, args...)&t;HPSB_DEBUG(&quot;sbp2: &quot;fmt, ## args)
DECL|macro|SBP2_INFO
mdefine_line|#define SBP2_INFO(fmt, args...)&t;&t;HPSB_INFO(&quot;sbp2: &quot;fmt, ## args)
DECL|macro|SBP2_NOTICE
mdefine_line|#define SBP2_NOTICE(fmt, args...)&t;HPSB_NOTICE(&quot;sbp2: &quot;fmt, ## args)
DECL|macro|SBP2_WARN
mdefine_line|#define SBP2_WARN(fmt, args...)&t;&t;HPSB_WARN(&quot;sbp2: &quot;fmt, ## args)
macro_line|#else 
DECL|macro|SBP2_DEBUG
mdefine_line|#define SBP2_DEBUG(fmt, args...)
DECL|macro|SBP2_INFO
mdefine_line|#define SBP2_INFO(fmt, args...)&t;&t;HPSB_INFO(&quot;sbp2: &quot;fmt, ## args)
DECL|macro|SBP2_NOTICE
mdefine_line|#define SBP2_NOTICE(fmt, args...)       HPSB_NOTICE(&quot;sbp2: &quot;fmt, ## args)
DECL|macro|SBP2_WARN
mdefine_line|#define SBP2_WARN(fmt, args...)         HPSB_WARN(&quot;sbp2: &quot;fmt, ## args)
macro_line|#endif
DECL|macro|SBP2_ERR
mdefine_line|#define SBP2_ERR(fmt, args...)&t;&t;HPSB_ERR(&quot;sbp2: &quot;fmt, ## args)
multiline_comment|/*&n; * Globals&n; */
r_static
r_void
id|sbp2scsi_complete_all_commands
c_func
(paren
r_struct
id|scsi_id_instance_data
op_star
id|scsi_id
comma
id|u32
id|status
)paren
suffix:semicolon
r_static
r_void
id|sbp2scsi_complete_command
c_func
(paren
r_struct
id|scsi_id_instance_data
op_star
id|scsi_id
comma
id|u32
id|scsi_status
comma
id|Scsi_Cmnd
op_star
id|SCpnt
comma
r_void
(paren
op_star
id|done
)paren
(paren
id|Scsi_Cmnd
op_star
)paren
)paren
suffix:semicolon
DECL|variable|scsi_driver_template
r_static
id|Scsi_Host_Template
id|scsi_driver_template
suffix:semicolon
DECL|variable|sbp2_speedto_max_payload
r_const
id|u8
id|sbp2_speedto_max_payload
(braket
)braket
op_assign
(brace
l_int|0x7
comma
l_int|0x8
comma
l_int|0x9
comma
l_int|0xA
comma
l_int|0xB
comma
l_int|0xC
)brace
suffix:semicolon
DECL|variable|sbp2_highlevel
r_static
r_struct
id|hpsb_highlevel
id|sbp2_highlevel
op_assign
(brace
dot
id|name
op_assign
id|SBP2_DEVICE_NAME
comma
dot
id|remove_host
op_assign
id|sbp2_remove_host
comma
)brace
suffix:semicolon
DECL|variable|sbp2_ops
r_static
r_struct
id|hpsb_address_ops
id|sbp2_ops
op_assign
(brace
dot
id|write
op_assign
id|sbp2_handle_status_write
)brace
suffix:semicolon
macro_line|#ifdef CONFIG_IEEE1394_SBP2_PHYS_DMA
DECL|variable|sbp2_physdma_ops
r_static
r_struct
id|hpsb_address_ops
id|sbp2_physdma_ops
op_assign
(brace
dot
id|read
op_assign
id|sbp2_handle_physdma_read
comma
dot
id|write
op_assign
id|sbp2_handle_physdma_write
comma
)brace
suffix:semicolon
macro_line|#endif
DECL|variable|sbp2_driver
r_static
r_struct
id|hpsb_protocol_driver
id|sbp2_driver
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;SBP2 Driver&quot;
comma
dot
id|id_table
op_assign
id|sbp2_id_table
comma
dot
id|update
op_assign
id|sbp2_update
comma
dot
id|driver
op_assign
(brace
dot
id|name
op_assign
id|SBP2_DEVICE_NAME
comma
dot
id|bus
op_assign
op_amp
id|ieee1394_bus_type
comma
dot
id|probe
op_assign
id|sbp2_probe
comma
dot
id|remove
op_assign
id|sbp2_remove
comma
)brace
comma
)brace
suffix:semicolon
multiline_comment|/* List of device firmware&squot;s that require a forced 36 byte inquiry.  */
DECL|variable|sbp2_broken_inquiry_list
r_static
id|u32
id|sbp2_broken_inquiry_list
(braket
)braket
op_assign
(brace
l_int|0x00002800
comma
multiline_comment|/* Stefan Richter &lt;richtest@bauwesen.tu-cottbus.de&gt; */
multiline_comment|/* DViCO Momobay CX-1 */
l_int|0x00000200
multiline_comment|/* Andreas Plesch &lt;plesch@fas.harvard.edu&gt; */
multiline_comment|/* QPS Fire DVDBurner */
)brace
suffix:semicolon
DECL|macro|NUM_BROKEN_INQUIRY_DEVS
mdefine_line|#define NUM_BROKEN_INQUIRY_DEVS &bslash;&n;&t;(sizeof(sbp2_broken_inquiry_list)/sizeof(*sbp2_broken_inquiry_list))
multiline_comment|/**************************************&n; * General utility functions&n; **************************************/
macro_line|#ifndef __BIG_ENDIAN
multiline_comment|/*&n; * Converts a buffer from be32 to cpu byte ordering. Length is in bytes.&n; */
DECL|function|sbp2util_be32_to_cpu_buffer
r_static
id|__inline__
r_void
id|sbp2util_be32_to_cpu_buffer
c_func
(paren
r_void
op_star
id|buffer
comma
r_int
id|length
)paren
(brace
id|u32
op_star
id|temp
op_assign
id|buffer
suffix:semicolon
r_for
c_loop
(paren
id|length
op_assign
(paren
id|length
op_rshift
l_int|2
)paren
suffix:semicolon
id|length
op_decrement
suffix:semicolon
)paren
id|temp
(braket
id|length
)braket
op_assign
id|be32_to_cpu
c_func
(paren
id|temp
(braket
id|length
)braket
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * Converts a buffer from cpu to be32 byte ordering. Length is in bytes.&n; */
DECL|function|sbp2util_cpu_to_be32_buffer
r_static
id|__inline__
r_void
id|sbp2util_cpu_to_be32_buffer
c_func
(paren
r_void
op_star
id|buffer
comma
r_int
id|length
)paren
(brace
id|u32
op_star
id|temp
op_assign
id|buffer
suffix:semicolon
r_for
c_loop
(paren
id|length
op_assign
(paren
id|length
op_rshift
l_int|2
)paren
suffix:semicolon
id|length
op_decrement
suffix:semicolon
)paren
id|temp
(braket
id|length
)braket
op_assign
id|cpu_to_be32
c_func
(paren
id|temp
(braket
id|length
)braket
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#else /* BIG_ENDIAN */
multiline_comment|/* Why waste the cpu cycles? */
DECL|macro|sbp2util_be32_to_cpu_buffer
mdefine_line|#define sbp2util_be32_to_cpu_buffer(x,y)
DECL|macro|sbp2util_cpu_to_be32_buffer
mdefine_line|#define sbp2util_cpu_to_be32_buffer(x,y)
macro_line|#endif
macro_line|#ifdef CONFIG_IEEE1394_SBP2_PACKET_DUMP
multiline_comment|/*&n; * Debug packet dump routine. Length is in bytes.&n; */
DECL|function|sbp2util_packet_dump
r_static
r_void
id|sbp2util_packet_dump
c_func
(paren
r_void
op_star
id|buffer
comma
r_int
id|length
comma
r_char
op_star
id|dump_name
comma
id|u32
id|dump_phys_addr
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
r_char
op_star
id|dump
op_assign
id|buffer
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dump
op_logical_or
op_logical_neg
id|length
op_logical_or
op_logical_neg
id|dump_name
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|dump_phys_addr
)paren
id|printk
c_func
(paren
l_string|&quot;[%s, 0x%x]&quot;
comma
id|dump_name
comma
id|dump_phys_addr
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
l_string|&quot;[%s]&quot;
comma
id|dump_name
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|length
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|i
OG
l_int|0x3f
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n   ...&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|i
op_amp
l_int|0x3
)paren
op_eq
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;  &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
op_amp
l_int|0xf
)paren
op_eq
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;&bslash;n   &quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%02x &quot;
comma
(paren
r_int
)paren
id|dump
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#else
DECL|macro|sbp2util_packet_dump
mdefine_line|#define sbp2util_packet_dump(w,x,y,z)
macro_line|#endif
multiline_comment|/*&n; * Goofy routine that basically does a down_timeout function.&n; */
DECL|function|sbp2util_down_timeout
r_static
r_int
id|sbp2util_down_timeout
c_func
(paren
id|atomic_t
op_star
id|done
comma
r_int
id|timeout
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|timeout
suffix:semicolon
(paren
id|i
OG
l_int|0
op_logical_and
id|atomic_read
c_func
(paren
id|done
)paren
op_eq
l_int|0
)paren
suffix:semicolon
id|i
op_sub_assign
id|HZ
op_div
l_int|10
)paren
(brace
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|schedule_timeout
c_func
(paren
id|HZ
op_div
l_int|10
)paren
)paren
multiline_comment|/* 100ms */
r_return
l_int|1
suffix:semicolon
)brace
r_return
(paren
(paren
id|i
OG
l_int|0
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/* Free&squot;s an allocated packet */
DECL|function|sbp2_free_packet
r_static
r_void
id|sbp2_free_packet
c_func
(paren
r_struct
id|hpsb_packet
op_star
id|packet
)paren
(brace
id|hpsb_free_tlabel
c_func
(paren
id|packet
)paren
suffix:semicolon
id|free_hpsb_packet
c_func
(paren
id|packet
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * This function is called to retrieve a block write packet from our&n; * packet pool. This function is used in place of calling&n; * alloc_hpsb_packet (which costs us three kmallocs). Instead we just pull&n; * out a free request packet and re-initialize values in it. I&squot;m sure this&n; * can still stand some more optimization.&n; */
r_static
r_struct
id|hpsb_packet
op_star
DECL|function|sbp2util_allocate_write_packet
id|sbp2util_allocate_write_packet
c_func
(paren
r_struct
id|sbp2scsi_host_info
op_star
id|hi
comma
r_struct
id|node_entry
op_star
id|ne
comma
id|u64
id|addr
comma
r_int
id|data_size
comma
id|quadlet_t
op_star
id|data
)paren
(brace
r_struct
id|hpsb_packet
op_star
id|packet
suffix:semicolon
id|packet
op_assign
id|hpsb_make_writepacket
c_func
(paren
id|hi-&gt;host
comma
id|ne-&gt;nodeid
comma
id|addr
comma
id|data
comma
id|data_size
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|packet
)paren
r_return
l_int|NULL
suffix:semicolon
id|hpsb_set_packet_complete_task
c_func
(paren
id|packet
comma
(paren
r_void
(paren
op_star
)paren
(paren
r_void
op_star
)paren
)paren
id|sbp2_free_packet
comma
id|packet
)paren
suffix:semicolon
id|hpsb_node_fill_packet
c_func
(paren
id|ne
comma
id|packet
)paren
suffix:semicolon
r_return
id|packet
suffix:semicolon
)brace
multiline_comment|/*&n; * This function is called to create a pool of command orbs used for&n; * command processing. It is called when a new sbp2 device is detected.&n; */
DECL|function|sbp2util_create_command_orb_pool
r_static
r_int
id|sbp2util_create_command_orb_pool
c_func
(paren
r_struct
id|scsi_id_instance_data
op_star
id|scsi_id
)paren
(brace
r_struct
id|sbp2scsi_host_info
op_star
id|hi
op_assign
id|scsi_id-&gt;hi
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
r_int
id|flags
comma
id|orbs
suffix:semicolon
r_struct
id|sbp2_command_info
op_star
id|command
suffix:semicolon
id|orbs
op_assign
id|serialize_io
ques
c_cond
l_int|2
suffix:colon
id|SBP2_MAX_COMMAND_ORBS
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|scsi_id-&gt;sbp2_command_orb_lock
comma
id|flags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|orbs
suffix:semicolon
id|i
op_increment
)paren
(brace
id|command
op_assign
(paren
r_struct
id|sbp2_command_info
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|sbp2_command_info
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|command
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|scsi_id-&gt;sbp2_command_orb_lock
comma
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|command
comma
l_char|&squot;&bslash;0&squot;
comma
r_sizeof
(paren
r_struct
id|sbp2_command_info
)paren
)paren
suffix:semicolon
id|command-&gt;command_orb_dma
op_assign
id|pci_map_single
(paren
id|hi-&gt;host-&gt;pdev
comma
op_amp
id|command-&gt;command_orb
comma
r_sizeof
(paren
r_struct
id|sbp2_command_orb
)paren
comma
id|PCI_DMA_BIDIRECTIONAL
)paren
suffix:semicolon
id|SBP2_DMA_ALLOC
c_func
(paren
l_string|&quot;single command orb DMA&quot;
)paren
suffix:semicolon
id|command-&gt;sge_dma
op_assign
id|pci_map_single
(paren
id|hi-&gt;host-&gt;pdev
comma
op_amp
id|command-&gt;scatter_gather_element
comma
r_sizeof
(paren
id|command-&gt;scatter_gather_element
)paren
comma
id|PCI_DMA_BIDIRECTIONAL
)paren
suffix:semicolon
id|SBP2_DMA_ALLOC
c_func
(paren
l_string|&quot;scatter_gather_element&quot;
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|command-&gt;list
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|command-&gt;list
comma
op_amp
id|scsi_id-&gt;sbp2_command_orb_completed
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|scsi_id-&gt;sbp2_command_orb_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * This function is called to delete a pool of command orbs.&n; */
DECL|function|sbp2util_remove_command_orb_pool
r_static
r_void
id|sbp2util_remove_command_orb_pool
c_func
(paren
r_struct
id|scsi_id_instance_data
op_star
id|scsi_id
)paren
(brace
r_struct
id|hpsb_host
op_star
id|host
op_assign
id|scsi_id-&gt;hi-&gt;host
suffix:semicolon
r_struct
id|list_head
op_star
id|lh
comma
op_star
id|next
suffix:semicolon
r_struct
id|sbp2_command_info
op_star
id|command
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|scsi_id-&gt;sbp2_command_orb_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|scsi_id-&gt;sbp2_command_orb_completed
)paren
)paren
(brace
id|list_for_each_safe
c_func
(paren
id|lh
comma
id|next
comma
op_amp
id|scsi_id-&gt;sbp2_command_orb_completed
)paren
(brace
id|command
op_assign
id|list_entry
c_func
(paren
id|lh
comma
r_struct
id|sbp2_command_info
comma
id|list
)paren
suffix:semicolon
multiline_comment|/* Release our generic DMA&squot;s */
id|pci_unmap_single
c_func
(paren
id|host-&gt;pdev
comma
id|command-&gt;command_orb_dma
comma
r_sizeof
(paren
r_struct
id|sbp2_command_orb
)paren
comma
id|PCI_DMA_BIDIRECTIONAL
)paren
suffix:semicolon
id|SBP2_DMA_FREE
c_func
(paren
l_string|&quot;single command orb DMA&quot;
)paren
suffix:semicolon
id|pci_unmap_single
c_func
(paren
id|host-&gt;pdev
comma
id|command-&gt;sge_dma
comma
r_sizeof
(paren
id|command-&gt;scatter_gather_element
)paren
comma
id|PCI_DMA_BIDIRECTIONAL
)paren
suffix:semicolon
id|SBP2_DMA_FREE
c_func
(paren
l_string|&quot;scatter_gather_element&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|command
)paren
suffix:semicolon
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|scsi_id-&gt;sbp2_command_orb_lock
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* &n; * This function finds the sbp2_command for a given outstanding command&n; * orb.Only looks at the inuse list.&n; */
DECL|function|sbp2util_find_command_for_orb
r_static
r_struct
id|sbp2_command_info
op_star
id|sbp2util_find_command_for_orb
c_func
(paren
r_struct
id|scsi_id_instance_data
op_star
id|scsi_id
comma
id|dma_addr_t
id|orb
)paren
(brace
r_struct
id|list_head
op_star
id|lh
suffix:semicolon
r_struct
id|sbp2_command_info
op_star
id|command
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|scsi_id-&gt;sbp2_command_orb_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|scsi_id-&gt;sbp2_command_orb_inuse
)paren
)paren
(brace
id|list_for_each
c_func
(paren
id|lh
comma
op_amp
id|scsi_id-&gt;sbp2_command_orb_inuse
)paren
(brace
id|command
op_assign
id|list_entry
c_func
(paren
id|lh
comma
r_struct
id|sbp2_command_info
comma
id|list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|command-&gt;command_orb_dma
op_eq
id|orb
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|scsi_id-&gt;sbp2_command_orb_lock
comma
id|flags
)paren
suffix:semicolon
r_return
(paren
id|command
)paren
suffix:semicolon
)brace
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|scsi_id-&gt;sbp2_command_orb_lock
comma
id|flags
)paren
suffix:semicolon
id|SBP2_ORB_DEBUG
c_func
(paren
l_string|&quot;could not match command orb %x&quot;
comma
(paren
r_int
r_int
)paren
id|orb
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* &n; * This function finds the sbp2_command for a given outstanding SCpnt.&n; * Only looks at the inuse list.&n; */
DECL|function|sbp2util_find_command_for_SCpnt
r_static
r_struct
id|sbp2_command_info
op_star
id|sbp2util_find_command_for_SCpnt
c_func
(paren
r_struct
id|scsi_id_instance_data
op_star
id|scsi_id
comma
r_void
op_star
id|SCpnt
)paren
(brace
r_struct
id|list_head
op_star
id|lh
suffix:semicolon
r_struct
id|sbp2_command_info
op_star
id|command
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|scsi_id-&gt;sbp2_command_orb_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|scsi_id-&gt;sbp2_command_orb_inuse
)paren
)paren
(brace
id|list_for_each
c_func
(paren
id|lh
comma
op_amp
id|scsi_id-&gt;sbp2_command_orb_inuse
)paren
(brace
id|command
op_assign
id|list_entry
c_func
(paren
id|lh
comma
r_struct
id|sbp2_command_info
comma
id|list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|command-&gt;Current_SCpnt
op_eq
id|SCpnt
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|scsi_id-&gt;sbp2_command_orb_lock
comma
id|flags
)paren
suffix:semicolon
r_return
(paren
id|command
)paren
suffix:semicolon
)brace
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|scsi_id-&gt;sbp2_command_orb_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; * This function allocates a command orb used to send a scsi command.&n; */
DECL|function|sbp2util_allocate_command_orb
r_static
r_struct
id|sbp2_command_info
op_star
id|sbp2util_allocate_command_orb
c_func
(paren
r_struct
id|scsi_id_instance_data
op_star
id|scsi_id
comma
id|Scsi_Cmnd
op_star
id|Current_SCpnt
comma
r_void
(paren
op_star
id|Current_done
)paren
(paren
id|Scsi_Cmnd
op_star
)paren
)paren
(brace
r_struct
id|list_head
op_star
id|lh
suffix:semicolon
r_struct
id|sbp2_command_info
op_star
id|command
op_assign
l_int|NULL
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|scsi_id-&gt;sbp2_command_orb_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|scsi_id-&gt;sbp2_command_orb_completed
)paren
)paren
(brace
id|lh
op_assign
id|scsi_id-&gt;sbp2_command_orb_completed.next
suffix:semicolon
id|list_del
c_func
(paren
id|lh
)paren
suffix:semicolon
id|command
op_assign
id|list_entry
c_func
(paren
id|lh
comma
r_struct
id|sbp2_command_info
comma
id|list
)paren
suffix:semicolon
id|command-&gt;Current_done
op_assign
id|Current_done
suffix:semicolon
id|command-&gt;Current_SCpnt
op_assign
id|Current_SCpnt
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|command-&gt;list
comma
op_amp
id|scsi_id-&gt;sbp2_command_orb_inuse
)paren
suffix:semicolon
)brace
r_else
(brace
id|SBP2_ERR
c_func
(paren
l_string|&quot;sbp2util_allocate_command_orb - No orbs available!&quot;
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|scsi_id-&gt;sbp2_command_orb_lock
comma
id|flags
)paren
suffix:semicolon
r_return
(paren
id|command
)paren
suffix:semicolon
)brace
multiline_comment|/* Free our DMA&squot;s */
DECL|function|sbp2util_free_command_dma
r_static
r_void
id|sbp2util_free_command_dma
c_func
(paren
r_struct
id|sbp2_command_info
op_star
id|command
)paren
(brace
r_struct
id|hpsb_host
op_star
id|host
suffix:semicolon
id|host
op_assign
id|hpsb_get_host_bykey
c_func
(paren
op_amp
id|sbp2_highlevel
comma
(paren
r_int
r_int
)paren
id|command-&gt;Current_SCpnt-&gt;device-&gt;host
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|host
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: host == NULL&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|command-&gt;cmd_dma
)paren
(brace
r_if
c_cond
(paren
id|command-&gt;dma_type
op_eq
id|CMD_DMA_SINGLE
)paren
(brace
id|pci_unmap_single
c_func
(paren
id|host-&gt;pdev
comma
id|command-&gt;cmd_dma
comma
id|command-&gt;dma_size
comma
id|command-&gt;dma_dir
)paren
suffix:semicolon
id|SBP2_DMA_FREE
c_func
(paren
l_string|&quot;single bulk&quot;
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|command-&gt;dma_type
op_eq
id|CMD_DMA_PAGE
)paren
(brace
id|pci_unmap_page
c_func
(paren
id|host-&gt;pdev
comma
id|command-&gt;cmd_dma
comma
id|command-&gt;dma_size
comma
id|command-&gt;dma_dir
)paren
suffix:semicolon
id|SBP2_DMA_FREE
c_func
(paren
l_string|&quot;single page&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* XXX: Check for CMD_DMA_NONE bug */
id|command-&gt;dma_type
op_assign
id|CMD_DMA_NONE
suffix:semicolon
id|command-&gt;cmd_dma
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|command-&gt;sge_buffer
)paren
(brace
id|pci_unmap_sg
c_func
(paren
id|host-&gt;pdev
comma
id|command-&gt;sge_buffer
comma
id|command-&gt;dma_size
comma
id|command-&gt;dma_dir
)paren
suffix:semicolon
id|SBP2_DMA_FREE
c_func
(paren
l_string|&quot;scatter list&quot;
)paren
suffix:semicolon
id|command-&gt;sge_buffer
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * This function moves a command to the completed orb list.&n; */
DECL|function|sbp2util_mark_command_completed
r_static
r_void
id|sbp2util_mark_command_completed
c_func
(paren
r_struct
id|scsi_id_instance_data
op_star
id|scsi_id
comma
r_struct
id|sbp2_command_info
op_star
id|command
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|scsi_id-&gt;sbp2_command_orb_lock
comma
id|flags
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|command-&gt;list
)paren
suffix:semicolon
id|sbp2util_free_command_dma
c_func
(paren
id|command
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|command-&gt;list
comma
op_amp
id|scsi_id-&gt;sbp2_command_orb_completed
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|scsi_id-&gt;sbp2_command_orb_lock
comma
id|flags
)paren
suffix:semicolon
)brace
"&f;"
multiline_comment|/*********************************************&n; * IEEE-1394 core driver stack related section&n; *********************************************/
DECL|function|sbp2_probe
r_static
r_int
id|sbp2_probe
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|unit_directory
op_star
id|ud
suffix:semicolon
r_struct
id|sbp2scsi_host_info
op_star
id|hi
suffix:semicolon
id|SBP2_DEBUG
c_func
(paren
id|__FUNCTION__
)paren
suffix:semicolon
id|ud
op_assign
id|container_of
c_func
(paren
id|dev
comma
r_struct
id|unit_directory
comma
id|device
)paren
suffix:semicolon
multiline_comment|/* Don&squot;t probe UD&squot;s that have the LUN flag. We&squot;ll probe the LUN(s)&n;&t; * instead. */
r_if
c_cond
(paren
id|ud-&gt;flags
op_amp
id|UNIT_DIRECTORY_HAS_LUN_DIRECTORY
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
multiline_comment|/* This will only add it if it doesn&squot;t exist */
id|hi
op_assign
id|sbp2_add_host
c_func
(paren
id|ud-&gt;ne-&gt;host
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hi
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_return
id|sbp2_start_ud
c_func
(paren
id|hi
comma
id|ud
)paren
suffix:semicolon
)brace
DECL|function|sbp2_remove
r_static
r_int
id|sbp2_remove
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|scsi_id_group
op_star
id|scsi_group
suffix:semicolon
r_struct
id|list_head
op_star
id|lh
comma
op_star
id|next
suffix:semicolon
r_struct
id|unit_directory
op_star
id|ud
suffix:semicolon
r_struct
id|scsi_id_instance_data
op_star
id|scsi_id
suffix:semicolon
id|SBP2_DEBUG
c_func
(paren
id|__FUNCTION__
)paren
suffix:semicolon
id|ud
op_assign
id|container_of
c_func
(paren
id|dev
comma
r_struct
id|unit_directory
comma
id|device
)paren
suffix:semicolon
id|scsi_group
op_assign
id|ud-&gt;device.driver_data
suffix:semicolon
id|ud-&gt;device.driver_data
op_assign
l_int|NULL
suffix:semicolon
id|list_for_each_safe
(paren
id|lh
comma
id|next
comma
op_amp
id|scsi_group-&gt;scsi_id_list
)paren
(brace
id|scsi_id
op_assign
id|list_entry
c_func
(paren
id|lh
comma
r_struct
id|scsi_id_instance_data
comma
id|list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|scsi_id
op_ne
l_int|NULL
)paren
(brace
id|sbp2_logout_device
c_func
(paren
id|scsi_id
)paren
suffix:semicolon
id|sbp2_remove_device
c_func
(paren
id|scsi_id
)paren
suffix:semicolon
)brace
)brace
id|kfree
c_func
(paren
id|scsi_group
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sbp2_update
r_static
r_void
id|sbp2_update
c_func
(paren
r_struct
id|unit_directory
op_star
id|ud
)paren
(brace
r_struct
id|sbp2scsi_host_info
op_star
id|hi
suffix:semicolon
r_struct
id|scsi_id_group
op_star
id|scsi_group
op_assign
id|ud-&gt;device.driver_data
suffix:semicolon
r_struct
id|list_head
op_star
id|lh
comma
op_star
id|next
suffix:semicolon
r_struct
id|scsi_id_instance_data
op_star
id|scsi_id
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|SBP2_DEBUG
c_func
(paren
l_string|&quot;sbp2_update&quot;
)paren
suffix:semicolon
id|list_for_each_safe
(paren
id|lh
comma
id|next
comma
op_amp
id|scsi_group-&gt;scsi_id_list
)paren
(brace
id|scsi_id
op_assign
id|list_entry
c_func
(paren
id|lh
comma
r_struct
id|scsi_id_instance_data
comma
id|list
)paren
suffix:semicolon
id|hi
op_assign
id|scsi_id-&gt;hi
suffix:semicolon
r_if
c_cond
(paren
id|sbp2_reconnect_device
c_func
(paren
id|scsi_id
)paren
)paren
(brace
multiline_comment|/* &n;&t;&t;&t; * Ok, reconnect has failed. Perhaps we didn&squot;t&n;&t;&t;&t; * reconnect fast enough. Try doing a regular login.&n;&t;&t;&t; */
r_if
c_cond
(paren
id|sbp2_login_device
c_func
(paren
id|scsi_id
)paren
)paren
(brace
multiline_comment|/* Login failed too, just remove the device. */
id|SBP2_ERR
c_func
(paren
l_string|&quot;sbp2_reconnect_device failed!&quot;
)paren
suffix:semicolon
id|sbp2_remove_device
c_func
(paren
id|scsi_id
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
multiline_comment|/* Set max retries to something large on the device. */
id|sbp2_set_busy_timeout
c_func
(paren
id|scsi_id
)paren
suffix:semicolon
multiline_comment|/* Do a SBP-2 fetch agent reset. */
id|sbp2_agent_reset
c_func
(paren
id|scsi_id
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Get the max speed and packet size that we can use. */
id|sbp2_max_speed_and_size
c_func
(paren
id|scsi_id
)paren
suffix:semicolon
multiline_comment|/* Complete any pending commands with busy (so they get&n;&t;&t; * retried) and remove them from our queue&n;&t;&t; */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|hi-&gt;sbp2_command_lock
comma
id|flags
)paren
suffix:semicolon
id|sbp2scsi_complete_all_commands
c_func
(paren
id|scsi_id
comma
id|DID_BUS_BUSY
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|hi-&gt;sbp2_command_lock
comma
id|flags
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* This functions is called by the sbp2_probe, for each new device. If the&n; * host_info already exists, it will return it. If not, it allocated a new&n; * host_info entry and a corresponding scsi_host. */
DECL|function|sbp2_add_host
r_static
r_struct
id|sbp2scsi_host_info
op_star
id|sbp2_add_host
c_func
(paren
r_struct
id|hpsb_host
op_star
id|host
)paren
(brace
r_struct
id|sbp2scsi_host_info
op_star
id|hi
suffix:semicolon
r_struct
id|Scsi_Host
op_star
id|scsi_host
suffix:semicolon
id|SBP2_DEBUG
c_func
(paren
l_string|&quot;sbp2_add_host&quot;
)paren
suffix:semicolon
id|hi
op_assign
id|hpsb_get_hostinfo
c_func
(paren
op_amp
id|sbp2_highlevel
comma
id|host
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hi
)paren
r_return
id|hi
suffix:semicolon
multiline_comment|/* Register our host with the SCSI stack. */
id|scsi_host
op_assign
id|scsi_host_alloc
c_func
(paren
op_amp
id|scsi_driver_template
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|scsi_host
)paren
(brace
id|SBP2_ERR
c_func
(paren
l_string|&quot;failed to register scsi host&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|hi
op_assign
id|hpsb_create_hostinfo
c_func
(paren
op_amp
id|sbp2_highlevel
comma
id|host
comma
r_sizeof
(paren
op_star
id|hi
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hi
)paren
(brace
id|SBP2_ERR
c_func
(paren
l_string|&quot;failed to allocate hostinfo&quot;
)paren
suffix:semicolon
id|scsi_host_put
c_func
(paren
id|hi-&gt;scsi_host
)paren
suffix:semicolon
)brace
id|hpsb_set_hostinfo_key
c_func
(paren
op_amp
id|sbp2_highlevel
comma
id|host
comma
(paren
r_int
r_int
)paren
id|scsi_host
)paren
suffix:semicolon
id|hi-&gt;scsi_host
op_assign
id|scsi_host
suffix:semicolon
id|hi-&gt;host
op_assign
id|host
suffix:semicolon
id|hi-&gt;sbp2_command_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
id|hi-&gt;scsi_host-&gt;max_id
op_assign
id|SBP2SCSI_MAX_SCSI_IDS
suffix:semicolon
multiline_comment|/* XXX We need a device to pass here as the scsi-host class. Can&squot;t&n;&t; * use the PCI device, since it is already bound to the ieee1394&n;&t; * host. Can&squot;t use the fw-host device since it is multi-class&n;&t; * enabled (scsi-host uses classdata member of the device). */
r_if
c_cond
(paren
id|scsi_add_host
c_func
(paren
id|hi-&gt;scsi_host
comma
l_int|NULL
)paren
)paren
(brace
id|SBP2_ERR
c_func
(paren
l_string|&quot;failed to add scsi host&quot;
)paren
suffix:semicolon
id|scsi_host_put
c_func
(paren
id|hi-&gt;scsi_host
)paren
suffix:semicolon
id|hpsb_destroy_hostinfo
c_func
(paren
op_amp
id|sbp2_highlevel
comma
id|host
)paren
suffix:semicolon
)brace
r_return
id|hi
suffix:semicolon
)brace
multiline_comment|/*&n; * This function is called when a host is removed.&n; */
DECL|function|sbp2_remove_host
r_static
r_void
id|sbp2_remove_host
c_func
(paren
r_struct
id|hpsb_host
op_star
id|host
)paren
(brace
r_struct
id|sbp2scsi_host_info
op_star
id|hi
suffix:semicolon
id|SBP2_DEBUG
c_func
(paren
l_string|&quot;sbp2_remove_host&quot;
)paren
suffix:semicolon
id|hi
op_assign
id|hpsb_get_hostinfo
c_func
(paren
op_amp
id|sbp2_highlevel
comma
id|host
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hi
)paren
(brace
id|scsi_remove_host
c_func
(paren
id|hi-&gt;scsi_host
)paren
suffix:semicolon
id|scsi_host_put
c_func
(paren
id|hi-&gt;scsi_host
)paren
suffix:semicolon
)brace
)brace
DECL|function|sbp2_start_ud
r_static
r_int
id|sbp2_start_ud
c_func
(paren
r_struct
id|sbp2scsi_host_info
op_star
id|hi
comma
r_struct
id|unit_directory
op_star
id|ud
)paren
(brace
r_struct
id|scsi_id_instance_data
op_star
id|scsi_id
suffix:semicolon
r_struct
id|scsi_id_group
op_star
id|scsi_group
suffix:semicolon
r_struct
id|list_head
op_star
id|lh
comma
op_star
id|next
suffix:semicolon
id|SBP2_DEBUG
c_func
(paren
l_string|&quot;sbp2_start_ud&quot;
)paren
suffix:semicolon
id|scsi_group
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|scsi_group
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|scsi_group
)paren
(brace
id|SBP2_ERR
(paren
l_string|&quot;Could not allocate memory for scsi_group&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|scsi_group-&gt;scsi_id_list
)paren
suffix:semicolon
id|ud-&gt;device.driver_data
op_assign
id|scsi_group
suffix:semicolon
id|sbp2_parse_unit_directory
c_func
(paren
id|scsi_group
comma
id|ud
)paren
suffix:semicolon
id|list_for_each_safe
(paren
id|lh
comma
id|next
comma
op_amp
id|scsi_group-&gt;scsi_id_list
)paren
(brace
id|scsi_id
op_assign
id|list_entry
c_func
(paren
id|lh
comma
r_struct
id|scsi_id_instance_data
comma
id|list
)paren
suffix:semicolon
id|scsi_id-&gt;ne
op_assign
id|ud-&gt;ne
suffix:semicolon
id|scsi_id-&gt;hi
op_assign
id|hi
suffix:semicolon
id|scsi_id-&gt;speed_code
op_assign
id|IEEE1394_SPEED_100
suffix:semicolon
id|scsi_id-&gt;max_payload_size
op_assign
id|sbp2_speedto_max_payload
(braket
id|IEEE1394_SPEED_100
)braket
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|scsi_id-&gt;sbp2_login_complete
comma
l_int|0
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|scsi_id-&gt;sbp2_command_orb_inuse
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|scsi_id-&gt;sbp2_command_orb_completed
)paren
suffix:semicolon
id|scsi_id-&gt;sbp2_command_orb_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
id|sbp2_start_device
c_func
(paren
id|scsi_id
)paren
suffix:semicolon
)brace
multiline_comment|/* Check to see if any of our devices survived the ordeal */
r_if
c_cond
(paren
id|list_empty
c_func
(paren
op_amp
id|scsi_group-&gt;scsi_id_list
)paren
)paren
(brace
id|kfree
c_func
(paren
id|scsi_group
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * This function is where we first pull the node unique ids, and then&n; * allocate memory and register a SBP-2 device.&n; */
DECL|function|sbp2_start_device
r_static
r_int
id|sbp2_start_device
c_func
(paren
r_struct
id|scsi_id_instance_data
op_star
id|scsi_id
)paren
(brace
r_struct
id|sbp2scsi_host_info
op_star
id|hi
op_assign
id|scsi_id-&gt;hi
suffix:semicolon
r_struct
id|scsi_device
op_star
id|sdev
suffix:semicolon
r_int
id|i
suffix:semicolon
id|SBP2_DEBUG
c_func
(paren
l_string|&quot;sbp2_start_device&quot;
)paren
suffix:semicolon
multiline_comment|/* Login FIFO DMA */
id|scsi_id-&gt;login_response
op_assign
id|pci_alloc_consistent
c_func
(paren
id|hi-&gt;host-&gt;pdev
comma
r_sizeof
(paren
r_struct
id|sbp2_login_response
)paren
comma
op_amp
id|scsi_id-&gt;login_response_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|scsi_id-&gt;login_response
)paren
r_goto
id|alloc_fail
suffix:semicolon
id|SBP2_DMA_ALLOC
c_func
(paren
l_string|&quot;consistent DMA region for login FIFO&quot;
)paren
suffix:semicolon
multiline_comment|/* Query logins ORB DMA */
id|scsi_id-&gt;query_logins_orb
op_assign
id|pci_alloc_consistent
c_func
(paren
id|hi-&gt;host-&gt;pdev
comma
r_sizeof
(paren
r_struct
id|sbp2_query_logins_orb
)paren
comma
op_amp
id|scsi_id-&gt;query_logins_orb_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|scsi_id-&gt;query_logins_orb
)paren
r_goto
id|alloc_fail
suffix:semicolon
id|SBP2_DMA_ALLOC
c_func
(paren
l_string|&quot;consistent DMA region for query logins ORB&quot;
)paren
suffix:semicolon
multiline_comment|/* Query logins response DMA */
id|scsi_id-&gt;query_logins_response
op_assign
id|pci_alloc_consistent
c_func
(paren
id|hi-&gt;host-&gt;pdev
comma
r_sizeof
(paren
r_struct
id|sbp2_query_logins_response
)paren
comma
op_amp
id|scsi_id-&gt;query_logins_response_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|scsi_id-&gt;query_logins_response
)paren
r_goto
id|alloc_fail
suffix:semicolon
id|SBP2_DMA_ALLOC
c_func
(paren
l_string|&quot;consistent DMA region for query logins response&quot;
)paren
suffix:semicolon
multiline_comment|/* Reconnect ORB DMA */
id|scsi_id-&gt;reconnect_orb
op_assign
id|pci_alloc_consistent
c_func
(paren
id|hi-&gt;host-&gt;pdev
comma
r_sizeof
(paren
r_struct
id|sbp2_reconnect_orb
)paren
comma
op_amp
id|scsi_id-&gt;reconnect_orb_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|scsi_id-&gt;reconnect_orb
)paren
r_goto
id|alloc_fail
suffix:semicolon
id|SBP2_DMA_ALLOC
c_func
(paren
l_string|&quot;consistent DMA region for reconnect ORB&quot;
)paren
suffix:semicolon
multiline_comment|/* Logout ORB DMA */
id|scsi_id-&gt;logout_orb
op_assign
id|pci_alloc_consistent
c_func
(paren
id|hi-&gt;host-&gt;pdev
comma
r_sizeof
(paren
r_struct
id|sbp2_logout_orb
)paren
comma
op_amp
id|scsi_id-&gt;logout_orb_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|scsi_id-&gt;logout_orb
)paren
r_goto
id|alloc_fail
suffix:semicolon
id|SBP2_DMA_ALLOC
c_func
(paren
l_string|&quot;consistent DMA region for logout ORB&quot;
)paren
suffix:semicolon
multiline_comment|/* Login ORB DMA */
id|scsi_id-&gt;login_orb
op_assign
id|pci_alloc_consistent
c_func
(paren
id|hi-&gt;host-&gt;pdev
comma
r_sizeof
(paren
r_struct
id|sbp2_login_orb
)paren
comma
op_amp
id|scsi_id-&gt;login_orb_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|scsi_id-&gt;login_orb
)paren
(brace
id|alloc_fail
suffix:colon
r_if
c_cond
(paren
id|scsi_id-&gt;query_logins_response
)paren
(brace
id|pci_free_consistent
c_func
(paren
id|hi-&gt;host-&gt;pdev
comma
r_sizeof
(paren
r_struct
id|sbp2_query_logins_response
)paren
comma
id|scsi_id-&gt;query_logins_response
comma
id|scsi_id-&gt;query_logins_response_dma
)paren
suffix:semicolon
id|SBP2_DMA_FREE
c_func
(paren
l_string|&quot;query logins response DMA&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|scsi_id-&gt;query_logins_orb
)paren
(brace
id|pci_free_consistent
c_func
(paren
id|hi-&gt;host-&gt;pdev
comma
r_sizeof
(paren
r_struct
id|sbp2_query_logins_orb
)paren
comma
id|scsi_id-&gt;query_logins_orb
comma
id|scsi_id-&gt;query_logins_orb_dma
)paren
suffix:semicolon
id|SBP2_DMA_FREE
c_func
(paren
l_string|&quot;query logins ORB DMA&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|scsi_id-&gt;logout_orb
)paren
(brace
id|pci_free_consistent
c_func
(paren
id|hi-&gt;host-&gt;pdev
comma
r_sizeof
(paren
r_struct
id|sbp2_logout_orb
)paren
comma
id|scsi_id-&gt;logout_orb
comma
id|scsi_id-&gt;logout_orb_dma
)paren
suffix:semicolon
id|SBP2_DMA_FREE
c_func
(paren
l_string|&quot;logout ORB DMA&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|scsi_id-&gt;reconnect_orb
)paren
(brace
id|pci_free_consistent
c_func
(paren
id|hi-&gt;host-&gt;pdev
comma
r_sizeof
(paren
r_struct
id|sbp2_reconnect_orb
)paren
comma
id|scsi_id-&gt;reconnect_orb
comma
id|scsi_id-&gt;reconnect_orb_dma
)paren
suffix:semicolon
id|SBP2_DMA_FREE
c_func
(paren
l_string|&quot;reconnect ORB DMA&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|scsi_id-&gt;login_response
)paren
(brace
id|pci_free_consistent
c_func
(paren
id|hi-&gt;host-&gt;pdev
comma
r_sizeof
(paren
r_struct
id|sbp2_login_response
)paren
comma
id|scsi_id-&gt;login_response
comma
id|scsi_id-&gt;login_response_dma
)paren
suffix:semicolon
id|SBP2_DMA_FREE
c_func
(paren
l_string|&quot;login FIFO DMA&quot;
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|scsi_id
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|scsi_id-&gt;list
)paren
suffix:semicolon
id|SBP2_ERR
(paren
l_string|&quot;Could not allocate memory for scsi_id&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|SBP2_DMA_ALLOC
c_func
(paren
l_string|&quot;consistent DMA region for login ORB&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Find an empty spot to stick our scsi id instance data. &n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|hi-&gt;scsi_host-&gt;max_id
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|hi-&gt;scsi_id
(braket
id|i
)braket
)paren
(brace
id|hi-&gt;scsi_id
(braket
id|i
)braket
op_assign
id|scsi_id
suffix:semicolon
id|scsi_id-&gt;id
op_assign
id|i
suffix:semicolon
id|SBP2_DEBUG
c_func
(paren
l_string|&quot;New SBP-2 device inserted, SCSI ID = %x&quot;
comma
(paren
r_int
r_int
)paren
id|i
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t; * Create our command orb pool&n;&t; */
r_if
c_cond
(paren
id|sbp2util_create_command_orb_pool
c_func
(paren
id|scsi_id
)paren
)paren
(brace
id|SBP2_ERR
c_func
(paren
l_string|&quot;sbp2util_create_command_orb_pool failed!&quot;
)paren
suffix:semicolon
id|sbp2_remove_device
c_func
(paren
id|scsi_id
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Make sure we are not out of space&n;&t; */
r_if
c_cond
(paren
id|i
op_eq
id|hi-&gt;scsi_host-&gt;max_id
)paren
(brace
id|SBP2_ERR
c_func
(paren
l_string|&quot;No slots left for SBP-2 device&quot;
)paren
suffix:semicolon
id|sbp2_remove_device
c_func
(paren
id|scsi_id
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
multiline_comment|/* Schedule a timeout here. The reason is that we may be so close&n;&t; * to a bus reset, that the device is not available for logins.&n;&t; * This can happen when the bus reset is caused by the host&n;&t; * connected to the sbp2 device being removed. That host would&n;&t; * have a certain amount of time to relogin before the sbp2 device&n;&t; * allows someone else to login instead. One second makes sense. */
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|HZ
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Login to the sbp-2 device&n;&t; */
r_if
c_cond
(paren
id|sbp2_login_device
c_func
(paren
id|scsi_id
)paren
)paren
(brace
multiline_comment|/* Login failed, just remove the device. */
id|sbp2_remove_device
c_func
(paren
id|scsi_id
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Set max retries to something large on the device&n;&t; */
id|sbp2_set_busy_timeout
c_func
(paren
id|scsi_id
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Do a SBP-2 fetch agent reset&n;&t; */
id|sbp2_agent_reset
c_func
(paren
id|scsi_id
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Get the max speed and packet size that we can use&n;&t; */
id|sbp2_max_speed_and_size
c_func
(paren
id|scsi_id
)paren
suffix:semicolon
multiline_comment|/* Add this device to the scsi layer now */
id|sdev
op_assign
id|scsi_add_device
c_func
(paren
id|hi-&gt;scsi_host
comma
l_int|0
comma
id|scsi_id-&gt;id
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|sdev
)paren
)paren
(brace
id|SBP2_ERR
c_func
(paren
l_string|&quot;scsi_add_device failed&quot;
)paren
suffix:semicolon
r_return
id|PTR_ERR
c_func
(paren
id|sdev
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * This function removes an sbp2 device from the sbp2scsi_host_info struct.&n; */
DECL|function|sbp2_remove_device
r_static
r_void
id|sbp2_remove_device
c_func
(paren
r_struct
id|scsi_id_instance_data
op_star
id|scsi_id
)paren
(brace
r_struct
id|sbp2scsi_host_info
op_star
id|hi
op_assign
id|scsi_id-&gt;hi
suffix:semicolon
r_struct
id|scsi_device
op_star
id|sdev
op_assign
id|scsi_find_device
c_func
(paren
id|hi-&gt;scsi_host
comma
l_int|0
comma
id|scsi_id-&gt;id
comma
l_int|0
)paren
suffix:semicolon
id|SBP2_DEBUG
c_func
(paren
l_string|&quot;sbp2_remove_device&quot;
)paren
suffix:semicolon
multiline_comment|/* Complete any pending commands with selection timeout */
id|sbp2scsi_complete_all_commands
c_func
(paren
id|scsi_id
comma
id|DID_NO_CONNECT
)paren
suffix:semicolon
multiline_comment|/* Remove it from the scsi layer now */
r_if
c_cond
(paren
id|sdev
)paren
id|scsi_remove_device
c_func
(paren
id|sdev
)paren
suffix:semicolon
id|sbp2util_remove_command_orb_pool
c_func
(paren
id|scsi_id
)paren
suffix:semicolon
id|hi-&gt;scsi_id
(braket
id|scsi_id-&gt;id
)braket
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|scsi_id-&gt;login_response
)paren
(brace
id|pci_free_consistent
c_func
(paren
id|hi-&gt;host-&gt;pdev
comma
r_sizeof
(paren
r_struct
id|sbp2_login_response
)paren
comma
id|scsi_id-&gt;login_response
comma
id|scsi_id-&gt;login_response_dma
)paren
suffix:semicolon
id|SBP2_DMA_FREE
c_func
(paren
l_string|&quot;single login FIFO&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|scsi_id-&gt;login_orb
)paren
(brace
id|pci_free_consistent
c_func
(paren
id|hi-&gt;host-&gt;pdev
comma
r_sizeof
(paren
r_struct
id|sbp2_login_orb
)paren
comma
id|scsi_id-&gt;login_orb
comma
id|scsi_id-&gt;login_orb_dma
)paren
suffix:semicolon
id|SBP2_DMA_FREE
c_func
(paren
l_string|&quot;single login ORB&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|scsi_id-&gt;reconnect_orb
)paren
(brace
id|pci_free_consistent
c_func
(paren
id|hi-&gt;host-&gt;pdev
comma
r_sizeof
(paren
r_struct
id|sbp2_reconnect_orb
)paren
comma
id|scsi_id-&gt;reconnect_orb
comma
id|scsi_id-&gt;reconnect_orb_dma
)paren
suffix:semicolon
id|SBP2_DMA_FREE
c_func
(paren
l_string|&quot;single reconnect orb&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|scsi_id-&gt;logout_orb
)paren
(brace
id|pci_free_consistent
c_func
(paren
id|hi-&gt;host-&gt;pdev
comma
r_sizeof
(paren
r_struct
id|sbp2_logout_orb
)paren
comma
id|scsi_id-&gt;logout_orb
comma
id|scsi_id-&gt;logout_orb_dma
)paren
suffix:semicolon
id|SBP2_DMA_FREE
c_func
(paren
l_string|&quot;single logout orb&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|scsi_id-&gt;query_logins_orb
)paren
(brace
id|pci_free_consistent
c_func
(paren
id|hi-&gt;host-&gt;pdev
comma
r_sizeof
(paren
r_struct
id|sbp2_query_logins_orb
)paren
comma
id|scsi_id-&gt;query_logins_orb
comma
id|scsi_id-&gt;query_logins_orb_dma
)paren
suffix:semicolon
id|SBP2_DMA_FREE
c_func
(paren
l_string|&quot;single query logins orb&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|scsi_id-&gt;query_logins_response
)paren
(brace
id|pci_free_consistent
c_func
(paren
id|hi-&gt;host-&gt;pdev
comma
r_sizeof
(paren
r_struct
id|sbp2_query_logins_response
)paren
comma
id|scsi_id-&gt;query_logins_response
comma
id|scsi_id-&gt;query_logins_response_dma
)paren
suffix:semicolon
id|SBP2_DMA_FREE
c_func
(paren
l_string|&quot;single query logins data&quot;
)paren
suffix:semicolon
)brace
id|SBP2_DEBUG
c_func
(paren
l_string|&quot;SBP-2 device removed, SCSI ID = %d&quot;
comma
id|scsi_id-&gt;id
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|scsi_id-&gt;list
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|scsi_id
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_IEEE1394_SBP2_PHYS_DMA
multiline_comment|/*&n; * This function deals with physical dma write requests (for adapters that do not support&n; * physical dma in hardware). Mostly just here for debugging...&n; */
DECL|function|sbp2_handle_physdma_write
r_static
r_int
id|sbp2_handle_physdma_write
c_func
(paren
r_struct
id|hpsb_host
op_star
id|host
comma
r_int
id|nodeid
comma
r_int
id|destid
comma
id|quadlet_t
op_star
id|data
comma
id|u64
id|addr
comma
r_int
id|length
comma
id|u16
id|flags
)paren
(brace
multiline_comment|/*&n;         * Manually put the data in the right place.&n;         */
id|memcpy
c_func
(paren
id|bus_to_virt
c_func
(paren
(paren
id|u32
)paren
id|addr
)paren
comma
id|data
comma
id|length
)paren
suffix:semicolon
id|sbp2util_packet_dump
c_func
(paren
id|data
comma
id|length
comma
l_string|&quot;sbp2 phys dma write by device&quot;
comma
(paren
id|u32
)paren
id|addr
)paren
suffix:semicolon
r_return
id|RCODE_COMPLETE
suffix:semicolon
)brace
multiline_comment|/*&n; * This function deals with physical dma read requests (for adapters that do not support&n; * physical dma in hardware). Mostly just here for debugging...&n; */
DECL|function|sbp2_handle_physdma_read
r_static
r_int
id|sbp2_handle_physdma_read
c_func
(paren
r_struct
id|hpsb_host
op_star
id|host
comma
r_int
id|nodeid
comma
id|quadlet_t
op_star
id|data
comma
id|u64
id|addr
comma
r_int
id|length
comma
id|u16
id|flags
)paren
(brace
multiline_comment|/*&n;         * Grab data from memory and send a read response.&n;         */
id|memcpy
c_func
(paren
id|data
comma
id|bus_to_virt
c_func
(paren
(paren
id|u32
)paren
id|addr
)paren
comma
id|length
)paren
suffix:semicolon
id|sbp2util_packet_dump
c_func
(paren
id|data
comma
id|length
comma
l_string|&quot;sbp2 phys dma read by device&quot;
comma
(paren
id|u32
)paren
id|addr
)paren
suffix:semicolon
r_return
id|RCODE_COMPLETE
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/**************************************&n; * SBP-2 protocol related section&n; **************************************/
multiline_comment|/*&n; * This function determines if we should convert scsi commands for a particular sbp2 device type&n; */
DECL|function|sbp2_command_conversion_device_type
r_static
id|__inline__
r_int
id|sbp2_command_conversion_device_type
c_func
(paren
id|u8
id|device_type
)paren
(brace
r_return
(paren
(paren
(paren
id|device_type
op_eq
id|TYPE_DISK
)paren
op_logical_or
(paren
id|device_type
op_eq
id|TYPE_SDAD
)paren
op_logical_or
(paren
id|device_type
op_eq
id|TYPE_ROM
)paren
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * This function queries the device for the maximum concurrent logins it&n; * supports.&n; */
DECL|function|sbp2_query_logins
r_static
r_int
id|sbp2_query_logins
c_func
(paren
r_struct
id|scsi_id_instance_data
op_star
id|scsi_id
)paren
(brace
r_struct
id|sbp2scsi_host_info
op_star
id|hi
op_assign
id|scsi_id-&gt;hi
suffix:semicolon
id|quadlet_t
id|data
(braket
l_int|2
)braket
suffix:semicolon
r_int
id|max_logins
suffix:semicolon
r_int
id|active_logins
suffix:semicolon
id|SBP2_DEBUG
c_func
(paren
l_string|&quot;sbp2_query_logins&quot;
)paren
suffix:semicolon
id|scsi_id-&gt;query_logins_orb-&gt;reserved1
op_assign
l_int|0x0
suffix:semicolon
id|scsi_id-&gt;query_logins_orb-&gt;reserved2
op_assign
l_int|0x0
suffix:semicolon
id|scsi_id-&gt;query_logins_orb-&gt;query_response_lo
op_assign
id|scsi_id-&gt;query_logins_response_dma
suffix:semicolon
id|scsi_id-&gt;query_logins_orb-&gt;query_response_hi
op_assign
id|ORB_SET_NODE_ID
c_func
(paren
id|hi-&gt;host-&gt;node_id
)paren
suffix:semicolon
id|SBP2_DEBUG
c_func
(paren
l_string|&quot;sbp2_query_logins: query_response_hi/lo initialized&quot;
)paren
suffix:semicolon
id|scsi_id-&gt;query_logins_orb-&gt;lun_misc
op_assign
id|ORB_SET_FUNCTION
c_func
(paren
id|QUERY_LOGINS_REQUEST
)paren
suffix:semicolon
id|scsi_id-&gt;query_logins_orb-&gt;lun_misc
op_or_assign
id|ORB_SET_NOTIFY
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|scsi_id-&gt;sbp2_device_type_and_lun
op_ne
id|SBP2_DEVICE_TYPE_LUN_UNINITIALIZED
)paren
(brace
id|scsi_id-&gt;query_logins_orb-&gt;lun_misc
op_or_assign
id|ORB_SET_LUN
c_func
(paren
id|scsi_id-&gt;sbp2_device_type_and_lun
)paren
suffix:semicolon
id|SBP2_DEBUG
c_func
(paren
l_string|&quot;sbp2_query_logins: set lun to %d&quot;
comma
id|ORB_SET_LUN
c_func
(paren
id|scsi_id-&gt;sbp2_device_type_and_lun
)paren
)paren
suffix:semicolon
)brace
id|SBP2_DEBUG
c_func
(paren
l_string|&quot;sbp2_query_logins: lun_misc initialized&quot;
)paren
suffix:semicolon
id|scsi_id-&gt;query_logins_orb-&gt;reserved_resp_length
op_assign
id|ORB_SET_QUERY_LOGINS_RESP_LENGTH
c_func
(paren
r_sizeof
(paren
r_struct
id|sbp2_query_logins_response
)paren
)paren
suffix:semicolon
id|SBP2_DEBUG
c_func
(paren
l_string|&quot;sbp2_query_logins: reserved_resp_length initialized&quot;
)paren
suffix:semicolon
id|scsi_id-&gt;query_logins_orb-&gt;status_FIFO_lo
op_assign
id|SBP2_STATUS_FIFO_ADDRESS_LO
op_plus
id|SBP2_STATUS_FIFO_ENTRY_TO_OFFSET
c_func
(paren
id|scsi_id-&gt;id
)paren
suffix:semicolon
id|scsi_id-&gt;query_logins_orb-&gt;status_FIFO_hi
op_assign
(paren
id|ORB_SET_NODE_ID
c_func
(paren
id|hi-&gt;host-&gt;node_id
)paren
op_or
id|SBP2_STATUS_FIFO_ADDRESS_HI
)paren
suffix:semicolon
id|SBP2_DEBUG
c_func
(paren
l_string|&quot;sbp2_query_logins: status FIFO initialized&quot;
)paren
suffix:semicolon
id|sbp2util_cpu_to_be32_buffer
c_func
(paren
id|scsi_id-&gt;query_logins_orb
comma
r_sizeof
(paren
r_struct
id|sbp2_query_logins_orb
)paren
)paren
suffix:semicolon
id|SBP2_DEBUG
c_func
(paren
l_string|&quot;sbp2_query_logins: orb byte-swapped&quot;
)paren
suffix:semicolon
id|sbp2util_packet_dump
c_func
(paren
id|scsi_id-&gt;query_logins_orb
comma
r_sizeof
(paren
r_struct
id|sbp2_query_logins_orb
)paren
comma
l_string|&quot;sbp2 query logins orb&quot;
comma
id|scsi_id-&gt;query_logins_orb_dma
)paren
suffix:semicolon
id|memset
c_func
(paren
id|scsi_id-&gt;query_logins_response
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|sbp2_query_logins_response
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|scsi_id-&gt;status_block
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|sbp2_status_block
)paren
)paren
suffix:semicolon
id|SBP2_DEBUG
c_func
(paren
l_string|&quot;sbp2_query_logins: query_logins_response/status FIFO memset&quot;
)paren
suffix:semicolon
id|data
(braket
l_int|0
)braket
op_assign
id|ORB_SET_NODE_ID
c_func
(paren
id|hi-&gt;host-&gt;node_id
)paren
suffix:semicolon
id|data
(braket
l_int|1
)braket
op_assign
id|scsi_id-&gt;query_logins_orb_dma
suffix:semicolon
id|sbp2util_cpu_to_be32_buffer
c_func
(paren
id|data
comma
l_int|8
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|scsi_id-&gt;sbp2_login_complete
comma
l_int|0
)paren
suffix:semicolon
id|SBP2_DEBUG
c_func
(paren
l_string|&quot;sbp2_query_logins: prepared to write&quot;
)paren
suffix:semicolon
id|hpsb_node_write
c_func
(paren
id|scsi_id-&gt;ne
comma
id|scsi_id-&gt;sbp2_management_agent_addr
comma
id|data
comma
l_int|8
)paren
suffix:semicolon
id|SBP2_DEBUG
c_func
(paren
l_string|&quot;sbp2_query_logins: written&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sbp2util_down_timeout
c_func
(paren
op_amp
id|scsi_id-&gt;sbp2_login_complete
comma
l_int|2
op_star
id|HZ
)paren
)paren
(brace
id|SBP2_ERR
c_func
(paren
l_string|&quot;Error querying logins to SBP-2 device - timed out&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_if
c_cond
(paren
id|scsi_id-&gt;status_block.ORB_offset_lo
op_ne
id|scsi_id-&gt;query_logins_orb_dma
)paren
(brace
id|SBP2_ERR
c_func
(paren
l_string|&quot;Error querying logins to SBP-2 device - timed out&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_if
c_cond
(paren
id|STATUS_GET_RESP
c_func
(paren
id|scsi_id-&gt;status_block.ORB_offset_hi_misc
)paren
op_logical_or
id|STATUS_GET_DEAD_BIT
c_func
(paren
id|scsi_id-&gt;status_block.ORB_offset_hi_misc
)paren
op_logical_or
id|STATUS_GET_SBP_STATUS
c_func
(paren
id|scsi_id-&gt;status_block.ORB_offset_hi_misc
)paren
)paren
(brace
id|SBP2_ERR
c_func
(paren
l_string|&quot;Error querying logins to SBP-2 device - timed out&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|sbp2util_cpu_to_be32_buffer
c_func
(paren
id|scsi_id-&gt;query_logins_response
comma
r_sizeof
(paren
r_struct
id|sbp2_query_logins_response
)paren
)paren
suffix:semicolon
id|SBP2_DEBUG
c_func
(paren
l_string|&quot;length_max_logins = %x&quot;
comma
(paren
r_int
r_int
)paren
id|scsi_id-&gt;query_logins_response-&gt;length_max_logins
)paren
suffix:semicolon
id|SBP2_INFO
c_func
(paren
l_string|&quot;Query logins to SBP-2 device successful&quot;
)paren
suffix:semicolon
id|max_logins
op_assign
id|RESPONSE_GET_MAX_LOGINS
c_func
(paren
id|scsi_id-&gt;query_logins_response-&gt;length_max_logins
)paren
suffix:semicolon
id|SBP2_INFO
c_func
(paren
l_string|&quot;Maximum concurrent logins supported: %d&quot;
comma
id|max_logins
)paren
suffix:semicolon
id|active_logins
op_assign
id|RESPONSE_GET_ACTIVE_LOGINS
c_func
(paren
id|scsi_id-&gt;query_logins_response-&gt;length_max_logins
)paren
suffix:semicolon
id|SBP2_INFO
c_func
(paren
l_string|&quot;Number of active logins: %d&quot;
comma
id|active_logins
)paren
suffix:semicolon
r_if
c_cond
(paren
id|active_logins
op_ge
id|max_logins
)paren
(brace
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * This function is called in order to login to a particular SBP-2 device,&n; * after a bus reset.&n; */
DECL|function|sbp2_login_device
r_static
r_int
id|sbp2_login_device
c_func
(paren
r_struct
id|scsi_id_instance_data
op_star
id|scsi_id
)paren
(brace
r_struct
id|sbp2scsi_host_info
op_star
id|hi
op_assign
id|scsi_id-&gt;hi
suffix:semicolon
id|quadlet_t
id|data
(braket
l_int|2
)braket
suffix:semicolon
id|SBP2_DEBUG
c_func
(paren
l_string|&quot;sbp2_login_device&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|scsi_id-&gt;login_orb
)paren
(brace
id|SBP2_DEBUG
c_func
(paren
l_string|&quot;sbp2_login_device: login_orb not alloc&squot;d!&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|exclusive_login
)paren
(brace
r_if
c_cond
(paren
id|sbp2_query_logins
c_func
(paren
id|scsi_id
)paren
)paren
(brace
id|SBP2_ERR
c_func
(paren
l_string|&quot;Device does not support any more concurrent logins&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
)brace
multiline_comment|/* Set-up login ORB, assume no password */
id|scsi_id-&gt;login_orb-&gt;password_hi
op_assign
l_int|0
suffix:semicolon
id|scsi_id-&gt;login_orb-&gt;password_lo
op_assign
l_int|0
suffix:semicolon
id|SBP2_DEBUG
c_func
(paren
l_string|&quot;sbp2_login_device: password_hi/lo initialized&quot;
)paren
suffix:semicolon
id|scsi_id-&gt;login_orb-&gt;login_response_lo
op_assign
id|scsi_id-&gt;login_response_dma
suffix:semicolon
id|scsi_id-&gt;login_orb-&gt;login_response_hi
op_assign
id|ORB_SET_NODE_ID
c_func
(paren
id|hi-&gt;host-&gt;node_id
)paren
suffix:semicolon
id|SBP2_DEBUG
c_func
(paren
l_string|&quot;sbp2_login_device: login_response_hi/lo initialized&quot;
)paren
suffix:semicolon
id|scsi_id-&gt;login_orb-&gt;lun_misc
op_assign
id|ORB_SET_FUNCTION
c_func
(paren
id|LOGIN_REQUEST
)paren
suffix:semicolon
id|scsi_id-&gt;login_orb-&gt;lun_misc
op_or_assign
id|ORB_SET_RECONNECT
c_func
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* One second reconnect time */
id|scsi_id-&gt;login_orb-&gt;lun_misc
op_or_assign
id|ORB_SET_EXCLUSIVE
c_func
(paren
id|exclusive_login
)paren
suffix:semicolon
multiline_comment|/* Exclusive access to device */
id|scsi_id-&gt;login_orb-&gt;lun_misc
op_or_assign
id|ORB_SET_NOTIFY
c_func
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Notify us of login complete */
multiline_comment|/* Set the lun if we were able to pull it from the device&squot;s unit directory */
r_if
c_cond
(paren
id|scsi_id-&gt;sbp2_device_type_and_lun
op_ne
id|SBP2_DEVICE_TYPE_LUN_UNINITIALIZED
)paren
(brace
id|scsi_id-&gt;login_orb-&gt;lun_misc
op_or_assign
id|ORB_SET_LUN
c_func
(paren
id|scsi_id-&gt;sbp2_device_type_and_lun
)paren
suffix:semicolon
id|SBP2_DEBUG
c_func
(paren
l_string|&quot;sbp2_query_logins: set lun to %d&quot;
comma
id|ORB_SET_LUN
c_func
(paren
id|scsi_id-&gt;sbp2_device_type_and_lun
)paren
)paren
suffix:semicolon
)brace
id|SBP2_DEBUG
c_func
(paren
l_string|&quot;sbp2_login_device: lun_misc initialized&quot;
)paren
suffix:semicolon
id|scsi_id-&gt;login_orb-&gt;passwd_resp_lengths
op_assign
id|ORB_SET_LOGIN_RESP_LENGTH
c_func
(paren
r_sizeof
(paren
r_struct
id|sbp2_login_response
)paren
)paren
suffix:semicolon
id|SBP2_DEBUG
c_func
(paren
l_string|&quot;sbp2_login_device: passwd_resp_lengths initialized&quot;
)paren
suffix:semicolon
id|scsi_id-&gt;login_orb-&gt;status_FIFO_lo
op_assign
id|SBP2_STATUS_FIFO_ADDRESS_LO
op_plus
id|SBP2_STATUS_FIFO_ENTRY_TO_OFFSET
c_func
(paren
id|scsi_id-&gt;id
)paren
suffix:semicolon
id|scsi_id-&gt;login_orb-&gt;status_FIFO_hi
op_assign
(paren
id|ORB_SET_NODE_ID
c_func
(paren
id|hi-&gt;host-&gt;node_id
)paren
op_or
id|SBP2_STATUS_FIFO_ADDRESS_HI
)paren
suffix:semicolon
id|SBP2_DEBUG
c_func
(paren
l_string|&quot;sbp2_login_device: status FIFO initialized&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Byte swap ORB if necessary&n;&t; */
id|sbp2util_cpu_to_be32_buffer
c_func
(paren
id|scsi_id-&gt;login_orb
comma
r_sizeof
(paren
r_struct
id|sbp2_login_orb
)paren
)paren
suffix:semicolon
id|SBP2_DEBUG
c_func
(paren
l_string|&quot;sbp2_login_device: orb byte-swapped&quot;
)paren
suffix:semicolon
id|sbp2util_packet_dump
c_func
(paren
id|scsi_id-&gt;login_orb
comma
r_sizeof
(paren
r_struct
id|sbp2_login_orb
)paren
comma
l_string|&quot;sbp2 login orb&quot;
comma
id|scsi_id-&gt;login_orb_dma
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Initialize login response and status fifo&n;&t; */
id|memset
c_func
(paren
id|scsi_id-&gt;login_response
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|sbp2_login_response
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|scsi_id-&gt;status_block
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|sbp2_status_block
)paren
)paren
suffix:semicolon
id|SBP2_DEBUG
c_func
(paren
l_string|&quot;sbp2_login_device: login_response/status FIFO memset&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Ok, let&squot;s write to the target&squot;s management agent register&n;&t; */
id|data
(braket
l_int|0
)braket
op_assign
id|ORB_SET_NODE_ID
c_func
(paren
id|hi-&gt;host-&gt;node_id
)paren
suffix:semicolon
id|data
(braket
l_int|1
)braket
op_assign
id|scsi_id-&gt;login_orb_dma
suffix:semicolon
id|sbp2util_cpu_to_be32_buffer
c_func
(paren
id|data
comma
l_int|8
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|scsi_id-&gt;sbp2_login_complete
comma
l_int|0
)paren
suffix:semicolon
id|SBP2_DEBUG
c_func
(paren
l_string|&quot;sbp2_login_device: prepared to write to %08x&quot;
comma
(paren
r_int
r_int
)paren
id|scsi_id-&gt;sbp2_management_agent_addr
)paren
suffix:semicolon
id|hpsb_node_write
c_func
(paren
id|scsi_id-&gt;ne
comma
id|scsi_id-&gt;sbp2_management_agent_addr
comma
id|data
comma
l_int|8
)paren
suffix:semicolon
id|SBP2_DEBUG
c_func
(paren
l_string|&quot;sbp2_login_device: written&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Wait for login status (up to 20 seconds)... &n;&t; */
r_if
c_cond
(paren
id|sbp2util_down_timeout
c_func
(paren
op_amp
id|scsi_id-&gt;sbp2_login_complete
comma
l_int|20
op_star
id|HZ
)paren
)paren
(brace
id|SBP2_ERR
c_func
(paren
l_string|&quot;Error logging into SBP-2 device - login timed-out&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Sanity. Make sure status returned matches login orb.&n;&t; */
r_if
c_cond
(paren
id|scsi_id-&gt;status_block.ORB_offset_lo
op_ne
id|scsi_id-&gt;login_orb_dma
)paren
(brace
id|SBP2_ERR
c_func
(paren
l_string|&quot;Error logging into SBP-2 device - login timed-out&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Check status&n;&t; */
r_if
c_cond
(paren
id|STATUS_GET_RESP
c_func
(paren
id|scsi_id-&gt;status_block.ORB_offset_hi_misc
)paren
op_logical_or
id|STATUS_GET_DEAD_BIT
c_func
(paren
id|scsi_id-&gt;status_block.ORB_offset_hi_misc
)paren
op_logical_or
id|STATUS_GET_SBP_STATUS
c_func
(paren
id|scsi_id-&gt;status_block.ORB_offset_hi_misc
)paren
)paren
(brace
id|SBP2_ERR
c_func
(paren
l_string|&quot;Error logging into SBP-2 device - login failed&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Byte swap the login response, for use when reconnecting or&n;&t; * logging out.&n;&t; */
id|sbp2util_cpu_to_be32_buffer
c_func
(paren
id|scsi_id-&gt;login_response
comma
r_sizeof
(paren
r_struct
id|sbp2_login_response
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Grab our command block agent address from the login response.&n;&t; */
id|SBP2_DEBUG
c_func
(paren
l_string|&quot;command_block_agent_hi = %x&quot;
comma
(paren
r_int
r_int
)paren
id|scsi_id-&gt;login_response-&gt;command_block_agent_hi
)paren
suffix:semicolon
id|SBP2_DEBUG
c_func
(paren
l_string|&quot;command_block_agent_lo = %x&quot;
comma
(paren
r_int
r_int
)paren
id|scsi_id-&gt;login_response-&gt;command_block_agent_lo
)paren
suffix:semicolon
id|scsi_id-&gt;sbp2_command_block_agent_addr
op_assign
(paren
(paren
id|u64
)paren
id|scsi_id-&gt;login_response-&gt;command_block_agent_hi
)paren
op_lshift
l_int|32
suffix:semicolon
id|scsi_id-&gt;sbp2_command_block_agent_addr
op_or_assign
(paren
(paren
id|u64
)paren
id|scsi_id-&gt;login_response-&gt;command_block_agent_lo
)paren
suffix:semicolon
id|scsi_id-&gt;sbp2_command_block_agent_addr
op_and_assign
l_int|0x0000ffffffffffffULL
suffix:semicolon
id|SBP2_INFO
c_func
(paren
l_string|&quot;Logged into SBP-2 device&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * This function is called in order to logout from a particular SBP-2&n; * device, usually called during driver unload.&n; */
DECL|function|sbp2_logout_device
r_static
r_int
id|sbp2_logout_device
c_func
(paren
r_struct
id|scsi_id_instance_data
op_star
id|scsi_id
)paren
(brace
r_struct
id|sbp2scsi_host_info
op_star
id|hi
op_assign
id|scsi_id-&gt;hi
suffix:semicolon
id|quadlet_t
id|data
(braket
l_int|2
)braket
suffix:semicolon
id|SBP2_DEBUG
c_func
(paren
l_string|&quot;sbp2_logout_device&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Set-up logout ORB&n;&t; */
id|scsi_id-&gt;logout_orb-&gt;reserved1
op_assign
l_int|0x0
suffix:semicolon
id|scsi_id-&gt;logout_orb-&gt;reserved2
op_assign
l_int|0x0
suffix:semicolon
id|scsi_id-&gt;logout_orb-&gt;reserved3
op_assign
l_int|0x0
suffix:semicolon
id|scsi_id-&gt;logout_orb-&gt;reserved4
op_assign
l_int|0x0
suffix:semicolon
id|scsi_id-&gt;logout_orb-&gt;login_ID_misc
op_assign
id|ORB_SET_FUNCTION
c_func
(paren
id|LOGOUT_REQUEST
)paren
suffix:semicolon
id|scsi_id-&gt;logout_orb-&gt;login_ID_misc
op_or_assign
id|ORB_SET_LOGIN_ID
c_func
(paren
id|scsi_id-&gt;login_response-&gt;length_login_ID
)paren
suffix:semicolon
multiline_comment|/* Notify us when complete */
id|scsi_id-&gt;logout_orb-&gt;login_ID_misc
op_or_assign
id|ORB_SET_NOTIFY
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|scsi_id-&gt;logout_orb-&gt;reserved5
op_assign
l_int|0x0
suffix:semicolon
id|scsi_id-&gt;logout_orb-&gt;status_FIFO_lo
op_assign
id|SBP2_STATUS_FIFO_ADDRESS_LO
op_plus
id|SBP2_STATUS_FIFO_ENTRY_TO_OFFSET
c_func
(paren
id|scsi_id-&gt;id
)paren
suffix:semicolon
id|scsi_id-&gt;logout_orb-&gt;status_FIFO_hi
op_assign
(paren
id|ORB_SET_NODE_ID
c_func
(paren
id|hi-&gt;host-&gt;node_id
)paren
op_or
id|SBP2_STATUS_FIFO_ADDRESS_HI
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Byte swap ORB if necessary&n;&t; */
id|sbp2util_cpu_to_be32_buffer
c_func
(paren
id|scsi_id-&gt;logout_orb
comma
r_sizeof
(paren
r_struct
id|sbp2_logout_orb
)paren
)paren
suffix:semicolon
id|sbp2util_packet_dump
c_func
(paren
id|scsi_id-&gt;logout_orb
comma
r_sizeof
(paren
r_struct
id|sbp2_logout_orb
)paren
comma
l_string|&quot;sbp2 logout orb&quot;
comma
id|scsi_id-&gt;logout_orb_dma
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Ok, let&squot;s write to the target&squot;s management agent register&n;&t; */
id|data
(braket
l_int|0
)braket
op_assign
id|ORB_SET_NODE_ID
c_func
(paren
id|hi-&gt;host-&gt;node_id
)paren
suffix:semicolon
id|data
(braket
l_int|1
)braket
op_assign
id|scsi_id-&gt;logout_orb_dma
suffix:semicolon
id|sbp2util_cpu_to_be32_buffer
c_func
(paren
id|data
comma
l_int|8
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|scsi_id-&gt;sbp2_login_complete
comma
l_int|0
)paren
suffix:semicolon
id|hpsb_node_write
c_func
(paren
id|scsi_id-&gt;ne
comma
id|scsi_id-&gt;sbp2_management_agent_addr
comma
id|data
comma
l_int|8
)paren
suffix:semicolon
multiline_comment|/* Wait for device to logout...1 second. */
id|sbp2util_down_timeout
c_func
(paren
op_amp
id|scsi_id-&gt;sbp2_login_complete
comma
id|HZ
)paren
suffix:semicolon
id|SBP2_INFO
c_func
(paren
l_string|&quot;Logged out of SBP-2 device&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * This function is called in order to reconnect to a particular SBP-2&n; * device, after a bus reset.&n; */
DECL|function|sbp2_reconnect_device
r_static
r_int
id|sbp2_reconnect_device
c_func
(paren
r_struct
id|scsi_id_instance_data
op_star
id|scsi_id
)paren
(brace
r_struct
id|sbp2scsi_host_info
op_star
id|hi
op_assign
id|scsi_id-&gt;hi
suffix:semicolon
id|quadlet_t
id|data
(braket
l_int|2
)braket
suffix:semicolon
id|SBP2_DEBUG
c_func
(paren
l_string|&quot;sbp2_reconnect_device&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Set-up reconnect ORB&n;&t; */
id|scsi_id-&gt;reconnect_orb-&gt;reserved1
op_assign
l_int|0x0
suffix:semicolon
id|scsi_id-&gt;reconnect_orb-&gt;reserved2
op_assign
l_int|0x0
suffix:semicolon
id|scsi_id-&gt;reconnect_orb-&gt;reserved3
op_assign
l_int|0x0
suffix:semicolon
id|scsi_id-&gt;reconnect_orb-&gt;reserved4
op_assign
l_int|0x0
suffix:semicolon
id|scsi_id-&gt;reconnect_orb-&gt;login_ID_misc
op_assign
id|ORB_SET_FUNCTION
c_func
(paren
id|RECONNECT_REQUEST
)paren
suffix:semicolon
id|scsi_id-&gt;reconnect_orb-&gt;login_ID_misc
op_or_assign
id|ORB_SET_LOGIN_ID
c_func
(paren
id|scsi_id-&gt;login_response-&gt;length_login_ID
)paren
suffix:semicolon
multiline_comment|/* Notify us when complete */
id|scsi_id-&gt;reconnect_orb-&gt;login_ID_misc
op_or_assign
id|ORB_SET_NOTIFY
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|scsi_id-&gt;reconnect_orb-&gt;reserved5
op_assign
l_int|0x0
suffix:semicolon
id|scsi_id-&gt;reconnect_orb-&gt;status_FIFO_lo
op_assign
id|SBP2_STATUS_FIFO_ADDRESS_LO
op_plus
id|SBP2_STATUS_FIFO_ENTRY_TO_OFFSET
c_func
(paren
id|scsi_id-&gt;id
)paren
suffix:semicolon
id|scsi_id-&gt;reconnect_orb-&gt;status_FIFO_hi
op_assign
(paren
id|ORB_SET_NODE_ID
c_func
(paren
id|hi-&gt;host-&gt;node_id
)paren
op_or
id|SBP2_STATUS_FIFO_ADDRESS_HI
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Byte swap ORB if necessary&n;&t; */
id|sbp2util_cpu_to_be32_buffer
c_func
(paren
id|scsi_id-&gt;reconnect_orb
comma
r_sizeof
(paren
r_struct
id|sbp2_reconnect_orb
)paren
)paren
suffix:semicolon
id|sbp2util_packet_dump
c_func
(paren
id|scsi_id-&gt;reconnect_orb
comma
r_sizeof
(paren
r_struct
id|sbp2_reconnect_orb
)paren
comma
l_string|&quot;sbp2 reconnect orb&quot;
comma
id|scsi_id-&gt;reconnect_orb_dma
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Initialize status fifo&n;&t; */
id|memset
c_func
(paren
op_amp
id|scsi_id-&gt;status_block
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|sbp2_status_block
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Ok, let&squot;s write to the target&squot;s management agent register&n;&t; */
id|data
(braket
l_int|0
)braket
op_assign
id|ORB_SET_NODE_ID
c_func
(paren
id|hi-&gt;host-&gt;node_id
)paren
suffix:semicolon
id|data
(braket
l_int|1
)braket
op_assign
id|scsi_id-&gt;reconnect_orb_dma
suffix:semicolon
id|sbp2util_cpu_to_be32_buffer
c_func
(paren
id|data
comma
l_int|8
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|scsi_id-&gt;sbp2_login_complete
comma
l_int|0
)paren
suffix:semicolon
id|hpsb_node_write
c_func
(paren
id|scsi_id-&gt;ne
comma
id|scsi_id-&gt;sbp2_management_agent_addr
comma
id|data
comma
l_int|8
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Wait for reconnect status (up to 1 second)...&n;&t; */
r_if
c_cond
(paren
id|sbp2util_down_timeout
c_func
(paren
op_amp
id|scsi_id-&gt;sbp2_login_complete
comma
id|HZ
)paren
)paren
(brace
id|SBP2_ERR
c_func
(paren
l_string|&quot;Error reconnecting to SBP-2 device - reconnect timed-out&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Sanity. Make sure status returned matches reconnect orb.&n;&t; */
r_if
c_cond
(paren
id|scsi_id-&gt;status_block.ORB_offset_lo
op_ne
id|scsi_id-&gt;reconnect_orb_dma
)paren
(brace
id|SBP2_ERR
c_func
(paren
l_string|&quot;Error reconnecting to SBP-2 device - reconnect timed-out&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Check status&n;&t; */
r_if
c_cond
(paren
id|STATUS_GET_RESP
c_func
(paren
id|scsi_id-&gt;status_block.ORB_offset_hi_misc
)paren
op_logical_or
id|STATUS_GET_DEAD_BIT
c_func
(paren
id|scsi_id-&gt;status_block.ORB_offset_hi_misc
)paren
op_logical_or
id|STATUS_GET_SBP_STATUS
c_func
(paren
id|scsi_id-&gt;status_block.ORB_offset_hi_misc
)paren
)paren
(brace
id|SBP2_ERR
c_func
(paren
l_string|&quot;Error reconnecting to SBP-2 device - reconnect failed&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|SBP2_INFO
c_func
(paren
l_string|&quot;Reconnected to SBP-2 device&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * This function is called in order to set the busy timeout (number of&n; * retries to attempt) on the sbp2 device. &n; */
DECL|function|sbp2_set_busy_timeout
r_static
r_int
id|sbp2_set_busy_timeout
c_func
(paren
r_struct
id|scsi_id_instance_data
op_star
id|scsi_id
)paren
(brace
id|quadlet_t
id|data
suffix:semicolon
id|SBP2_DEBUG
c_func
(paren
l_string|&quot;sbp2_set_busy_timeout&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Ok, let&squot;s write to the target&squot;s busy timeout register&n;&t; */
id|data
op_assign
id|cpu_to_be32
c_func
(paren
id|SBP2_BUSY_TIMEOUT_VALUE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hpsb_node_write
c_func
(paren
id|scsi_id-&gt;ne
comma
id|SBP2_BUSY_TIMEOUT_ADDRESS
comma
op_amp
id|data
comma
l_int|4
)paren
)paren
(brace
id|SBP2_ERR
c_func
(paren
l_string|&quot;sbp2_set_busy_timeout error&quot;
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * This function is called to parse sbp2 device&squot;s config rom unit&n; * directory. Used to determine things like sbp2 management agent offset,&n; * and command set used (SCSI or RBC). &n; */
DECL|function|sbp2_parse_unit_directory
r_static
r_void
id|sbp2_parse_unit_directory
c_func
(paren
r_struct
id|scsi_id_group
op_star
id|scsi_group
comma
r_struct
id|unit_directory
op_star
id|ud
)paren
(brace
r_struct
id|scsi_id_instance_data
op_star
id|scsi_id
suffix:semicolon
r_struct
id|list_head
op_star
id|lh
suffix:semicolon
id|u64
id|management_agent_addr
suffix:semicolon
id|u32
id|command_set_spec_id
comma
id|command_set
comma
id|unit_characteristics
comma
id|firmware_revision
comma
id|workarounds
suffix:semicolon
r_int
id|i
suffix:semicolon
id|SBP2_DEBUG
c_func
(paren
l_string|&quot;sbp2_parse_unit_directory&quot;
)paren
suffix:semicolon
id|management_agent_addr
op_assign
l_int|0x0
suffix:semicolon
id|command_set_spec_id
op_assign
l_int|0x0
suffix:semicolon
id|command_set
op_assign
l_int|0x0
suffix:semicolon
id|unit_characteristics
op_assign
l_int|0x0
suffix:semicolon
id|firmware_revision
op_assign
l_int|0x0
suffix:semicolon
multiline_comment|/* Handle different fields in the unit directory, based on keys */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ud-&gt;length
suffix:semicolon
id|i
op_increment
)paren
(brace
r_switch
c_cond
(paren
id|CONFIG_ROM_KEY
c_func
(paren
id|ud-&gt;quadlets
(braket
id|i
)braket
)paren
)paren
(brace
r_case
id|SBP2_CSR_OFFSET_KEY
suffix:colon
multiline_comment|/* Save off the management agent address */
id|management_agent_addr
op_assign
id|CSR_REGISTER_BASE
op_plus
(paren
id|CONFIG_ROM_VALUE
c_func
(paren
id|ud-&gt;quadlets
(braket
id|i
)braket
)paren
op_lshift
l_int|2
)paren
suffix:semicolon
id|SBP2_DEBUG
c_func
(paren
l_string|&quot;sbp2_management_agent_addr = %x&quot;
comma
(paren
r_int
r_int
)paren
id|management_agent_addr
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SBP2_COMMAND_SET_SPEC_ID_KEY
suffix:colon
multiline_comment|/* Command spec organization */
id|command_set_spec_id
op_assign
id|CONFIG_ROM_VALUE
c_func
(paren
id|ud-&gt;quadlets
(braket
id|i
)braket
)paren
suffix:semicolon
id|SBP2_DEBUG
c_func
(paren
l_string|&quot;sbp2_command_set_spec_id = %x&quot;
comma
(paren
r_int
r_int
)paren
id|command_set_spec_id
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SBP2_COMMAND_SET_KEY
suffix:colon
multiline_comment|/* Command set used by sbp2 device */
id|command_set
op_assign
id|CONFIG_ROM_VALUE
c_func
(paren
id|ud-&gt;quadlets
(braket
id|i
)braket
)paren
suffix:semicolon
id|SBP2_DEBUG
c_func
(paren
l_string|&quot;sbp2_command_set = %x&quot;
comma
(paren
r_int
r_int
)paren
id|command_set
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SBP2_UNIT_CHARACTERISTICS_KEY
suffix:colon
multiline_comment|/*&n;&t;&t;&t; * Unit characterisitcs (orb related stuff&n;&t;&t;&t; * that I&squot;m not yet paying attention to)&n;&t;&t;&t; */
id|unit_characteristics
op_assign
id|CONFIG_ROM_VALUE
c_func
(paren
id|ud-&gt;quadlets
(braket
id|i
)braket
)paren
suffix:semicolon
id|SBP2_DEBUG
c_func
(paren
l_string|&quot;sbp2_unit_characteristics = %x&quot;
comma
(paren
r_int
r_int
)paren
id|unit_characteristics
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SBP2_DEVICE_TYPE_AND_LUN_KEY
suffix:colon
multiline_comment|/*&n;&t;&t;&t; * Device type and lun (used for&n;&t;&t;&t; * detemining type of sbp2 device)&n;&t;&t;&t; */
id|scsi_id
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|scsi_id
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|scsi_id
)paren
(brace
id|SBP2_ERR
c_func
(paren
l_string|&quot;Out of memory adding scsi_id, not all LUN&squot;s will be added&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|memset
c_func
(paren
id|scsi_id
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|scsi_id
)paren
)paren
suffix:semicolon
id|scsi_id-&gt;sbp2_device_type_and_lun
op_assign
id|CONFIG_ROM_VALUE
c_func
(paren
id|ud-&gt;quadlets
(braket
id|i
)braket
)paren
suffix:semicolon
id|SBP2_DEBUG
c_func
(paren
l_string|&quot;sbp2_device_type_and_lun = %x&quot;
comma
(paren
r_int
r_int
)paren
id|scsi_id-&gt;sbp2_device_type_and_lun
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|scsi_id-&gt;list
comma
op_amp
id|scsi_group-&gt;scsi_id_list
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SBP2_FIRMWARE_REVISION_KEY
suffix:colon
multiline_comment|/* Firmware revision */
id|firmware_revision
op_assign
id|CONFIG_ROM_VALUE
c_func
(paren
id|ud-&gt;quadlets
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|force_inquiry_hack
)paren
id|SBP2_INFO
c_func
(paren
l_string|&quot;sbp2_firmware_revision = %x&quot;
comma
(paren
r_int
r_int
)paren
id|firmware_revision
)paren
suffix:semicolon
r_else
id|SBP2_DEBUG
c_func
(paren
l_string|&quot;sbp2_firmware_revision = %x&quot;
comma
(paren
r_int
r_int
)paren
id|firmware_revision
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* This is the start of our broken device checking. We try to hack&n;&t; * around oddities and known defects.  */
id|workarounds
op_assign
l_int|0x0
suffix:semicolon
multiline_comment|/* If the vendor id is 0xa0b8 (Symbios vendor id), then we have a&n;&t; * bridge with 128KB max transfer size limitation. For sanity, we&n;&t; * only voice this when the current max_sectors setting&n;&t; * exceeds the 128k limit. By default, that is not the case.&n;&t; *&n;&t; * It would be really nice if we could detect this before the scsi&n;&t; * host gets initialized. That way we can down-force the&n;&t; * max_sectors to account for it. That is not currently&n;&t; * possible.  */
r_if
c_cond
(paren
(paren
id|firmware_revision
op_amp
l_int|0xffff00
)paren
op_eq
id|SBP2_128KB_BROKEN_FIRMWARE
op_logical_and
(paren
id|max_sectors
op_star
l_int|512
)paren
OG
(paren
l_int|128
op_star
l_int|1024
)paren
)paren
(brace
id|SBP2_WARN
c_func
(paren
l_string|&quot;Node &quot;
id|NODE_BUS_FMT
l_string|&quot;: Bridge only supports 128KB max transfer size.&quot;
comma
id|NODE_BUS_ARGS
c_func
(paren
id|ud-&gt;ne-&gt;host
comma
id|ud-&gt;ne-&gt;nodeid
)paren
)paren
suffix:semicolon
id|SBP2_WARN
c_func
(paren
l_string|&quot;WARNING: Current max_sectors setting is larger than 128KB (%d sectors)!&quot;
comma
id|max_sectors
)paren
suffix:semicolon
id|workarounds
op_or_assign
id|SBP2_BREAKAGE_128K_MAX_TRANSFER
suffix:semicolon
)brace
multiline_comment|/* Check for a blacklisted set of devices that require us to force&n;&t; * a 36 byte host inquiry. This can be overriden as a module param&n;&t; * (to force all hosts).  */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_BROKEN_INQUIRY_DEVS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|firmware_revision
op_amp
l_int|0xffff00
)paren
op_eq
id|sbp2_broken_inquiry_list
(braket
id|i
)braket
)paren
(brace
id|SBP2_WARN
c_func
(paren
l_string|&quot;Node &quot;
id|NODE_BUS_FMT
l_string|&quot;: Using 36byte inquiry workaround&quot;
comma
id|NODE_BUS_ARGS
c_func
(paren
id|ud-&gt;ne-&gt;host
comma
id|ud-&gt;ne-&gt;nodeid
)paren
)paren
suffix:semicolon
id|workarounds
op_or_assign
id|SBP2_BREAKAGE_INQUIRY_HACK
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* No need to continue. */
)brace
)brace
multiline_comment|/* If this is a logical unit directory entry, process the parent&n;&t; * to get the common values. */
r_if
c_cond
(paren
id|ud-&gt;flags
op_amp
id|UNIT_DIRECTORY_LUN_DIRECTORY
)paren
(brace
r_struct
id|unit_directory
op_star
id|parent_ud
op_assign
id|container_of
c_func
(paren
id|ud-&gt;device.parent
comma
r_struct
id|unit_directory
comma
id|device
)paren
suffix:semicolon
id|sbp2_parse_unit_directory
c_func
(paren
id|scsi_group
comma
id|parent_ud
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* If our list is empty, add a base scsi_id (happens in a normal&n;&t;&t; * case where there is no logical_unit_number entry */
r_if
c_cond
(paren
id|list_empty
c_func
(paren
op_amp
id|scsi_group-&gt;scsi_id_list
)paren
)paren
(brace
id|scsi_id
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|scsi_id
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|scsi_id
)paren
(brace
id|SBP2_ERR
c_func
(paren
l_string|&quot;Out of memory adding scsi_id&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|memset
c_func
(paren
id|scsi_id
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|scsi_id
)paren
)paren
suffix:semicolon
id|scsi_id-&gt;sbp2_device_type_and_lun
op_assign
id|SBP2_DEVICE_TYPE_LUN_UNINITIALIZED
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|scsi_id-&gt;list
comma
op_amp
id|scsi_group-&gt;scsi_id_list
)paren
suffix:semicolon
)brace
multiline_comment|/* Update the generic fields in all the LUN&squot;s */
id|list_for_each
(paren
id|lh
comma
op_amp
id|scsi_group-&gt;scsi_id_list
)paren
(brace
id|scsi_id
op_assign
id|list_entry
c_func
(paren
id|lh
comma
r_struct
id|scsi_id_instance_data
comma
id|list
)paren
suffix:semicolon
id|scsi_id-&gt;sbp2_management_agent_addr
op_assign
id|management_agent_addr
suffix:semicolon
id|scsi_id-&gt;sbp2_command_set_spec_id
op_assign
id|command_set_spec_id
suffix:semicolon
id|scsi_id-&gt;sbp2_command_set
op_assign
id|command_set
suffix:semicolon
id|scsi_id-&gt;sbp2_unit_characteristics
op_assign
id|unit_characteristics
suffix:semicolon
id|scsi_id-&gt;sbp2_firmware_revision
op_assign
id|firmware_revision
suffix:semicolon
id|scsi_id-&gt;workarounds
op_assign
id|workarounds
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*&n; * This function is called in order to determine the max speed and packet&n; * size we can use in our ORBs. Note, that we (the driver and host) only&n; * initiate the transaction. The SBP-2 device actually transfers the data&n; * (by reading from the DMA area we tell it). This means that the SBP-2&n; * device decides the actual maximum data it can transfer. We just tell it&n; * the speed that it needs to use, and the max_rec the host supports, and&n; * it takes care of the rest.&n; */
DECL|function|sbp2_max_speed_and_size
r_static
r_int
id|sbp2_max_speed_and_size
c_func
(paren
r_struct
id|scsi_id_instance_data
op_star
id|scsi_id
)paren
(brace
r_struct
id|sbp2scsi_host_info
op_star
id|hi
op_assign
id|scsi_id-&gt;hi
suffix:semicolon
id|SBP2_DEBUG
c_func
(paren
l_string|&quot;sbp2_max_speed_and_size&quot;
)paren
suffix:semicolon
multiline_comment|/* Initial setting comes from the hosts speed map */
id|scsi_id-&gt;speed_code
op_assign
id|hi-&gt;host-&gt;speed_map
(braket
id|NODEID_TO_NODE
c_func
(paren
id|hi-&gt;host-&gt;node_id
)paren
op_star
l_int|64
op_plus
id|NODEID_TO_NODE
c_func
(paren
id|scsi_id-&gt;ne-&gt;nodeid
)paren
)braket
suffix:semicolon
multiline_comment|/* Bump down our speed if the user requested it */
r_if
c_cond
(paren
id|scsi_id-&gt;speed_code
OG
id|max_speed
)paren
(brace
id|scsi_id-&gt;speed_code
op_assign
id|max_speed
suffix:semicolon
id|SBP2_ERR
c_func
(paren
l_string|&quot;Forcing SBP-2 max speed down to %s&quot;
comma
id|hpsb_speedto_str
(braket
id|scsi_id-&gt;speed_code
)braket
)paren
suffix:semicolon
)brace
multiline_comment|/* Payload size is the lesser of what our speed supports and what&n;&t; * our host supports.  */
id|scsi_id-&gt;max_payload_size
op_assign
id|min
c_func
(paren
id|sbp2_speedto_max_payload
(braket
id|scsi_id-&gt;speed_code
)braket
comma
(paren
id|u8
)paren
(paren
(paren
(paren
id|be32_to_cpu
c_func
(paren
id|hi-&gt;host-&gt;csr.rom
(braket
l_int|2
)braket
)paren
op_rshift
l_int|12
)paren
op_amp
l_int|0xf
)paren
op_minus
l_int|1
)paren
)paren
suffix:semicolon
id|SBP2_ERR
c_func
(paren
l_string|&quot;Node &quot;
id|NODE_BUS_FMT
l_string|&quot;: Max speed [%s] - Max payload [%u]&quot;
comma
id|NODE_BUS_ARGS
c_func
(paren
id|hi-&gt;host
comma
id|scsi_id-&gt;ne-&gt;nodeid
)paren
comma
id|hpsb_speedto_str
(braket
id|scsi_id-&gt;speed_code
)braket
comma
l_int|1
op_lshift
(paren
(paren
id|u32
)paren
id|scsi_id-&gt;max_payload_size
op_plus
l_int|2
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * This function is called in order to perform a SBP-2 agent reset. &n; */
DECL|function|sbp2_agent_reset
r_static
r_int
id|sbp2_agent_reset
c_func
(paren
r_struct
id|scsi_id_instance_data
op_star
id|scsi_id
comma
r_int
id|wait
)paren
(brace
r_struct
id|sbp2scsi_host_info
op_star
id|hi
op_assign
id|scsi_id-&gt;hi
suffix:semicolon
r_struct
id|hpsb_packet
op_star
id|packet
suffix:semicolon
id|quadlet_t
id|data
suffix:semicolon
id|SBP2_DEBUG
c_func
(paren
l_string|&quot;sbp2_agent_reset&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Ok, let&squot;s write to the target&squot;s management agent register&n;&t; */
id|data
op_assign
id|ntohl
c_func
(paren
id|SBP2_AGENT_RESET_DATA
)paren
suffix:semicolon
id|packet
op_assign
id|sbp2util_allocate_write_packet
c_func
(paren
id|hi
comma
id|scsi_id-&gt;ne
comma
id|scsi_id-&gt;sbp2_command_block_agent_addr
op_plus
id|SBP2_AGENT_RESET_OFFSET
comma
l_int|4
comma
op_amp
id|data
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|packet
)paren
(brace
id|SBP2_ERR
c_func
(paren
l_string|&quot;sbp2util_allocate_write_packet failed&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|hpsb_send_packet
c_func
(paren
id|packet
)paren
)paren
(brace
id|SBP2_ERR
c_func
(paren
l_string|&quot;hpsb_send_packet failed&quot;
)paren
suffix:semicolon
id|sbp2_free_packet
c_func
(paren
id|packet
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_if
c_cond
(paren
id|wait
)paren
(brace
id|down
c_func
(paren
op_amp
id|packet-&gt;state_change
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|packet-&gt;state_change
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Need to make sure orb pointer is written on next command&n;&t; */
id|scsi_id-&gt;last_orb
op_assign
l_int|NULL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * This function is called to create the actual command orb and s/g list&n; * out of the scsi command itself.&n; */
DECL|function|sbp2_create_command_orb
r_static
r_int
id|sbp2_create_command_orb
c_func
(paren
r_struct
id|scsi_id_instance_data
op_star
id|scsi_id
comma
r_struct
id|sbp2_command_info
op_star
id|command
comma
id|unchar
op_star
id|scsi_cmd
comma
r_int
r_int
id|scsi_use_sg
comma
r_int
r_int
id|scsi_request_bufflen
comma
r_void
op_star
id|scsi_request_buffer
comma
r_int
r_char
id|scsi_dir
)paren
(brace
r_struct
id|sbp2scsi_host_info
op_star
id|hi
op_assign
id|scsi_id-&gt;hi
suffix:semicolon
r_struct
id|scatterlist
op_star
id|sgpnt
op_assign
(paren
r_struct
id|scatterlist
op_star
)paren
id|scsi_request_buffer
suffix:semicolon
r_struct
id|sbp2_command_orb
op_star
id|command_orb
op_assign
op_amp
id|command-&gt;command_orb
suffix:semicolon
r_struct
id|sbp2_unrestricted_page_table
op_star
id|scatter_gather_element
op_assign
op_amp
id|command-&gt;scatter_gather_element
(braket
l_int|0
)braket
suffix:semicolon
r_int
id|dma_dir
op_assign
id|scsi_to_pci_dma_dir
(paren
id|scsi_dir
)paren
suffix:semicolon
id|u32
id|sg_count
comma
id|sg_len
comma
id|orb_direction
suffix:semicolon
id|dma_addr_t
id|sg_addr
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/*&n;&t; * Set-up our command ORB..&n;&t; *&n;&t; * NOTE: We&squot;re doing unrestricted page tables (s/g), as this is&n;&t; * best performance (at least with the devices I have). This means&n;&t; * that data_size becomes the number of s/g elements, and&n;&t; * page_size should be zero (for unrestricted).&n;&t; */
id|command_orb-&gt;next_ORB_hi
op_assign
id|ORB_SET_NULL_PTR
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|command_orb-&gt;next_ORB_lo
op_assign
l_int|0x0
suffix:semicolon
id|command_orb-&gt;misc
op_assign
id|ORB_SET_MAX_PAYLOAD
c_func
(paren
id|scsi_id-&gt;max_payload_size
)paren
suffix:semicolon
id|command_orb-&gt;misc
op_or_assign
id|ORB_SET_SPEED
c_func
(paren
id|scsi_id-&gt;speed_code
)paren
suffix:semicolon
id|command_orb-&gt;misc
op_or_assign
id|ORB_SET_NOTIFY
c_func
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Notify us when complete */
multiline_comment|/*&n;&t; * Get the direction of the transfer. If the direction is unknown, then use our&n;&t; * goofy table as a back-up.&n;&t; */
r_switch
c_cond
(paren
id|scsi_dir
)paren
(brace
r_case
id|SCSI_DATA_NONE
suffix:colon
id|orb_direction
op_assign
id|ORB_DIRECTION_NO_DATA_TRANSFER
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SCSI_DATA_WRITE
suffix:colon
id|orb_direction
op_assign
id|ORB_DIRECTION_WRITE_TO_MEDIA
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SCSI_DATA_READ
suffix:colon
id|orb_direction
op_assign
id|ORB_DIRECTION_READ_FROM_MEDIA
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SCSI_DATA_UNKNOWN
suffix:colon
r_default
suffix:colon
id|SBP2_ERR
c_func
(paren
l_string|&quot;SCSI data transfer direction not specified. &quot;
l_string|&quot;Update the SBP2 direction table in sbp2.h if &quot;
l_string|&quot;necessary for your application&quot;
)paren
suffix:semicolon
id|print_command
(paren
id|scsi_cmd
)paren
suffix:semicolon
id|orb_direction
op_assign
id|sbp2scsi_direction_table
(braket
op_star
id|scsi_cmd
)braket
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Set-up our pagetable stuff... unfortunately, this has become&n;&t; * messier than I&squot;d like. Need to clean this up a bit.   ;-)&n;&t; */
r_if
c_cond
(paren
id|orb_direction
op_eq
id|ORB_DIRECTION_NO_DATA_TRANSFER
)paren
(brace
id|SBP2_DEBUG
c_func
(paren
l_string|&quot;No data transfer&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Handle no data transfer&n;&t;&t; */
id|command_orb-&gt;data_descriptor_hi
op_assign
l_int|0x0
suffix:semicolon
id|command_orb-&gt;data_descriptor_lo
op_assign
l_int|0x0
suffix:semicolon
id|command_orb-&gt;misc
op_or_assign
id|ORB_SET_DIRECTION
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|scsi_use_sg
)paren
(brace
id|SBP2_DEBUG
c_func
(paren
l_string|&quot;Use scatter/gather&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Special case if only one element (and less than 64KB in size)&n;&t;&t; */
r_if
c_cond
(paren
(paren
id|scsi_use_sg
op_eq
l_int|1
)paren
op_logical_and
(paren
id|sgpnt
(braket
l_int|0
)braket
dot
id|length
op_le
id|SBP2_MAX_SG_ELEMENT_LENGTH
)paren
)paren
(brace
id|SBP2_DEBUG
c_func
(paren
l_string|&quot;Only one s/g element&quot;
)paren
suffix:semicolon
id|command-&gt;dma_dir
op_assign
id|dma_dir
suffix:semicolon
id|command-&gt;dma_size
op_assign
id|sgpnt
(braket
l_int|0
)braket
dot
id|length
suffix:semicolon
id|command-&gt;dma_type
op_assign
id|CMD_DMA_PAGE
suffix:semicolon
id|command-&gt;cmd_dma
op_assign
id|pci_map_page
c_func
(paren
id|hi-&gt;host-&gt;pdev
comma
id|sgpnt
(braket
l_int|0
)braket
dot
id|page
comma
id|sgpnt
(braket
l_int|0
)braket
dot
id|offset
comma
id|command-&gt;dma_size
comma
id|command-&gt;dma_dir
)paren
suffix:semicolon
id|SBP2_DMA_ALLOC
c_func
(paren
l_string|&quot;single page scatter element&quot;
)paren
suffix:semicolon
id|command_orb-&gt;data_descriptor_hi
op_assign
id|ORB_SET_NODE_ID
c_func
(paren
id|hi-&gt;host-&gt;node_id
)paren
suffix:semicolon
id|command_orb-&gt;data_descriptor_lo
op_assign
id|command-&gt;cmd_dma
suffix:semicolon
id|command_orb-&gt;misc
op_or_assign
id|ORB_SET_DATA_SIZE
c_func
(paren
id|command-&gt;dma_size
)paren
suffix:semicolon
id|command_orb-&gt;misc
op_or_assign
id|ORB_SET_DIRECTION
c_func
(paren
id|orb_direction
)paren
suffix:semicolon
)brace
r_else
(brace
r_int
id|count
op_assign
id|pci_map_sg
c_func
(paren
id|hi-&gt;host-&gt;pdev
comma
id|sgpnt
comma
id|scsi_use_sg
comma
id|dma_dir
)paren
suffix:semicolon
id|SBP2_DMA_ALLOC
c_func
(paren
l_string|&quot;scatter list&quot;
)paren
suffix:semicolon
id|command-&gt;dma_size
op_assign
id|scsi_use_sg
suffix:semicolon
id|command-&gt;dma_dir
op_assign
id|dma_dir
suffix:semicolon
id|command-&gt;sge_buffer
op_assign
id|sgpnt
suffix:semicolon
multiline_comment|/* use page tables (s/g) */
id|command_orb-&gt;misc
op_or_assign
id|ORB_SET_PAGE_TABLE_PRESENT
c_func
(paren
l_int|0x1
)paren
suffix:semicolon
id|command_orb-&gt;misc
op_or_assign
id|ORB_SET_DIRECTION
c_func
(paren
id|orb_direction
)paren
suffix:semicolon
id|command_orb-&gt;data_descriptor_hi
op_assign
id|ORB_SET_NODE_ID
c_func
(paren
id|hi-&gt;host-&gt;node_id
)paren
suffix:semicolon
id|command_orb-&gt;data_descriptor_lo
op_assign
id|command-&gt;sge_dma
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * Loop through and fill out our sbp-2 page tables&n;&t;&t;&t; * (and split up anything too large)&n;&t;&t;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|sg_count
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
suffix:semicolon
id|i
op_increment
comma
id|sgpnt
op_increment
)paren
(brace
id|sg_len
op_assign
id|sg_dma_len
c_func
(paren
id|sgpnt
)paren
suffix:semicolon
id|sg_addr
op_assign
id|sg_dma_address
c_func
(paren
id|sgpnt
)paren
suffix:semicolon
r_while
c_loop
(paren
id|sg_len
)paren
(brace
id|scatter_gather_element
(braket
id|sg_count
)braket
dot
id|segment_base_lo
op_assign
id|sg_addr
suffix:semicolon
r_if
c_cond
(paren
id|sg_len
OG
id|SBP2_MAX_SG_ELEMENT_LENGTH
)paren
(brace
id|scatter_gather_element
(braket
id|sg_count
)braket
dot
id|length_segment_base_hi
op_assign
id|PAGE_TABLE_SET_SEGMENT_LENGTH
c_func
(paren
id|SBP2_MAX_SG_ELEMENT_LENGTH
)paren
suffix:semicolon
id|sg_addr
op_add_assign
id|SBP2_MAX_SG_ELEMENT_LENGTH
suffix:semicolon
id|sg_len
op_sub_assign
id|SBP2_MAX_SG_ELEMENT_LENGTH
suffix:semicolon
)brace
r_else
(brace
id|scatter_gather_element
(braket
id|sg_count
)braket
dot
id|length_segment_base_hi
op_assign
id|PAGE_TABLE_SET_SEGMENT_LENGTH
c_func
(paren
id|sg_len
)paren
suffix:semicolon
id|sg_len
op_assign
l_int|0
suffix:semicolon
)brace
id|sg_count
op_increment
suffix:semicolon
)brace
)brace
multiline_comment|/* Number of page table (s/g) elements */
id|command_orb-&gt;misc
op_or_assign
id|ORB_SET_DATA_SIZE
c_func
(paren
id|sg_count
)paren
suffix:semicolon
id|sbp2util_packet_dump
c_func
(paren
id|scatter_gather_element
comma
(paren
r_sizeof
(paren
r_struct
id|sbp2_unrestricted_page_table
)paren
)paren
op_star
id|sg_count
comma
l_string|&quot;sbp2 s/g list&quot;
comma
id|command-&gt;sge_dma
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * Byte swap page tables if necessary&n;&t;&t;&t; */
id|sbp2util_cpu_to_be32_buffer
c_func
(paren
id|scatter_gather_element
comma
(paren
r_sizeof
(paren
r_struct
id|sbp2_unrestricted_page_table
)paren
)paren
op_star
id|sg_count
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|SBP2_DEBUG
c_func
(paren
l_string|&quot;No scatter/gather&quot;
)paren
suffix:semicolon
id|command-&gt;dma_dir
op_assign
id|dma_dir
suffix:semicolon
id|command-&gt;dma_size
op_assign
id|scsi_request_bufflen
suffix:semicolon
id|command-&gt;dma_type
op_assign
id|CMD_DMA_SINGLE
suffix:semicolon
id|command-&gt;cmd_dma
op_assign
id|pci_map_single
(paren
id|hi-&gt;host-&gt;pdev
comma
id|scsi_request_buffer
comma
id|command-&gt;dma_size
comma
id|command-&gt;dma_dir
)paren
suffix:semicolon
id|SBP2_DMA_ALLOC
c_func
(paren
l_string|&quot;single bulk&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Handle case where we get a command w/o s/g enabled (but&n;&t;&t; * check for transfers larger than 64K)&n;&t;&t; */
r_if
c_cond
(paren
id|scsi_request_bufflen
op_le
id|SBP2_MAX_SG_ELEMENT_LENGTH
)paren
(brace
id|command_orb-&gt;data_descriptor_hi
op_assign
id|ORB_SET_NODE_ID
c_func
(paren
id|hi-&gt;host-&gt;node_id
)paren
suffix:semicolon
id|command_orb-&gt;data_descriptor_lo
op_assign
id|command-&gt;cmd_dma
suffix:semicolon
id|command_orb-&gt;misc
op_or_assign
id|ORB_SET_DATA_SIZE
c_func
(paren
id|scsi_request_bufflen
)paren
suffix:semicolon
id|command_orb-&gt;misc
op_or_assign
id|ORB_SET_DIRECTION
c_func
(paren
id|orb_direction
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * Sanity, in case our direction table is not&n;&t;&t;&t; * up-to-date&n;&t;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
id|scsi_request_bufflen
)paren
(brace
id|command_orb-&gt;data_descriptor_hi
op_assign
l_int|0x0
suffix:semicolon
id|command_orb-&gt;data_descriptor_lo
op_assign
l_int|0x0
suffix:semicolon
id|command_orb-&gt;misc
op_or_assign
id|ORB_SET_DIRECTION
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t;&t; * Need to turn this into page tables, since the&n;&t;&t;&t; * buffer is too large.&n;&t;&t;&t; */
id|command_orb-&gt;data_descriptor_hi
op_assign
id|ORB_SET_NODE_ID
c_func
(paren
id|hi-&gt;host-&gt;node_id
)paren
suffix:semicolon
id|command_orb-&gt;data_descriptor_lo
op_assign
id|command-&gt;sge_dma
suffix:semicolon
multiline_comment|/* Use page tables (s/g) */
id|command_orb-&gt;misc
op_or_assign
id|ORB_SET_PAGE_TABLE_PRESENT
c_func
(paren
l_int|0x1
)paren
suffix:semicolon
id|command_orb-&gt;misc
op_or_assign
id|ORB_SET_DIRECTION
c_func
(paren
id|orb_direction
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * fill out our sbp-2 page tables (and split up&n;&t;&t;&t; * the large buffer)&n;&t;&t;&t; */
id|sg_count
op_assign
l_int|0
suffix:semicolon
id|sg_len
op_assign
id|scsi_request_bufflen
suffix:semicolon
id|sg_addr
op_assign
id|command-&gt;cmd_dma
suffix:semicolon
r_while
c_loop
(paren
id|sg_len
)paren
(brace
id|scatter_gather_element
(braket
id|sg_count
)braket
dot
id|segment_base_lo
op_assign
id|sg_addr
suffix:semicolon
r_if
c_cond
(paren
id|sg_len
OG
id|SBP2_MAX_SG_ELEMENT_LENGTH
)paren
(brace
id|scatter_gather_element
(braket
id|sg_count
)braket
dot
id|length_segment_base_hi
op_assign
id|PAGE_TABLE_SET_SEGMENT_LENGTH
c_func
(paren
id|SBP2_MAX_SG_ELEMENT_LENGTH
)paren
suffix:semicolon
id|sg_addr
op_add_assign
id|SBP2_MAX_SG_ELEMENT_LENGTH
suffix:semicolon
id|sg_len
op_sub_assign
id|SBP2_MAX_SG_ELEMENT_LENGTH
suffix:semicolon
)brace
r_else
(brace
id|scatter_gather_element
(braket
id|sg_count
)braket
dot
id|length_segment_base_hi
op_assign
id|PAGE_TABLE_SET_SEGMENT_LENGTH
c_func
(paren
id|sg_len
)paren
suffix:semicolon
id|sg_len
op_assign
l_int|0
suffix:semicolon
)brace
id|sg_count
op_increment
suffix:semicolon
)brace
multiline_comment|/* Number of page table (s/g) elements */
id|command_orb-&gt;misc
op_or_assign
id|ORB_SET_DATA_SIZE
c_func
(paren
id|sg_count
)paren
suffix:semicolon
id|sbp2util_packet_dump
c_func
(paren
id|scatter_gather_element
comma
(paren
r_sizeof
(paren
r_struct
id|sbp2_unrestricted_page_table
)paren
)paren
op_star
id|sg_count
comma
l_string|&quot;sbp2 s/g list&quot;
comma
id|command-&gt;sge_dma
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * Byte swap page tables if necessary&n;&t;&t;&t; */
id|sbp2util_cpu_to_be32_buffer
c_func
(paren
id|scatter_gather_element
comma
(paren
r_sizeof
(paren
r_struct
id|sbp2_unrestricted_page_table
)paren
)paren
op_star
id|sg_count
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t; * Byte swap command ORB if necessary&n;&t; */
id|sbp2util_cpu_to_be32_buffer
c_func
(paren
id|command_orb
comma
r_sizeof
(paren
r_struct
id|sbp2_command_orb
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Put our scsi command in the command ORB&n;&t; */
id|memset
c_func
(paren
id|command_orb-&gt;cdb
comma
l_int|0
comma
l_int|12
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|command_orb-&gt;cdb
comma
id|scsi_cmd
comma
id|COMMAND_SIZE
c_func
(paren
op_star
id|scsi_cmd
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * This function is called in order to begin a regular SBP-2 command. &n; */
DECL|function|sbp2_link_orb_command
r_static
r_int
id|sbp2_link_orb_command
c_func
(paren
r_struct
id|scsi_id_instance_data
op_star
id|scsi_id
comma
r_struct
id|sbp2_command_info
op_star
id|command
)paren
(brace
r_struct
id|sbp2scsi_host_info
op_star
id|hi
op_assign
id|scsi_id-&gt;hi
suffix:semicolon
r_struct
id|hpsb_packet
op_star
id|packet
suffix:semicolon
r_struct
id|sbp2_command_orb
op_star
id|command_orb
op_assign
op_amp
id|command-&gt;command_orb
suffix:semicolon
id|outstanding_orb_incr
suffix:semicolon
id|SBP2_ORB_DEBUG
c_func
(paren
l_string|&quot;sending command orb %p, total orbs = %x&quot;
comma
id|command_orb
comma
id|global_outstanding_command_orbs
)paren
suffix:semicolon
id|pci_dma_sync_single
c_func
(paren
id|hi-&gt;host-&gt;pdev
comma
id|command-&gt;command_orb_dma
comma
r_sizeof
(paren
r_struct
id|sbp2_command_orb
)paren
comma
id|PCI_DMA_BIDIRECTIONAL
)paren
suffix:semicolon
id|pci_dma_sync_single
c_func
(paren
id|hi-&gt;host-&gt;pdev
comma
id|command-&gt;sge_dma
comma
r_sizeof
(paren
id|command-&gt;scatter_gather_element
)paren
comma
id|PCI_DMA_BIDIRECTIONAL
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Check to see if there are any previous orbs to use&n;&t; */
r_if
c_cond
(paren
id|scsi_id-&gt;last_orb
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/*&n;&t;&t; * Ok, let&squot;s write to the target&squot;s management agent register&n;&t;&t; */
r_if
c_cond
(paren
id|hpsb_node_entry_valid
c_func
(paren
id|scsi_id-&gt;ne
)paren
)paren
(brace
id|packet
op_assign
id|sbp2util_allocate_write_packet
c_func
(paren
id|hi
comma
id|scsi_id-&gt;ne
comma
id|scsi_id-&gt;sbp2_command_block_agent_addr
op_plus
id|SBP2_ORB_POINTER_OFFSET
comma
l_int|8
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|packet
)paren
(brace
id|SBP2_ERR
c_func
(paren
l_string|&quot;sbp2util_allocate_write_packet failed&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|packet-&gt;data
(braket
l_int|0
)braket
op_assign
id|ORB_SET_NODE_ID
c_func
(paren
id|hi-&gt;host-&gt;node_id
)paren
suffix:semicolon
id|packet-&gt;data
(braket
l_int|1
)braket
op_assign
id|command-&gt;command_orb_dma
suffix:semicolon
id|sbp2util_cpu_to_be32_buffer
c_func
(paren
id|packet-&gt;data
comma
l_int|8
)paren
suffix:semicolon
id|SBP2_ORB_DEBUG
c_func
(paren
l_string|&quot;write command agent, command orb %p&quot;
comma
id|command_orb
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hpsb_send_packet
c_func
(paren
id|packet
)paren
)paren
(brace
id|SBP2_ERR
c_func
(paren
l_string|&quot;hpsb_send_packet failed&quot;
)paren
suffix:semicolon
id|sbp2_free_packet
c_func
(paren
id|packet
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|SBP2_ORB_DEBUG
c_func
(paren
l_string|&quot;write command agent complete&quot;
)paren
suffix:semicolon
)brace
id|scsi_id-&gt;last_orb
op_assign
id|command_orb
suffix:semicolon
id|scsi_id-&gt;last_orb_dma
op_assign
id|command-&gt;command_orb_dma
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t; * We have an orb already sent (maybe or maybe not&n;&t;&t; * processed) that we can append this orb to. So do so,&n;&t;&t; * and ring the doorbell. Have to be very careful&n;&t;&t; * modifying these next orb pointers, as they are accessed&n;&t;&t; * both by the sbp2 device and us.&n;&t;&t; */
id|scsi_id-&gt;last_orb-&gt;next_ORB_lo
op_assign
id|cpu_to_be32
c_func
(paren
id|command-&gt;command_orb_dma
)paren
suffix:semicolon
multiline_comment|/* Tells hardware that this pointer is valid */
id|scsi_id-&gt;last_orb-&gt;next_ORB_hi
op_assign
l_int|0x0
suffix:semicolon
id|pci_dma_sync_single
c_func
(paren
id|hi-&gt;host-&gt;pdev
comma
id|scsi_id-&gt;last_orb_dma
comma
r_sizeof
(paren
r_struct
id|sbp2_command_orb
)paren
comma
id|PCI_DMA_BIDIRECTIONAL
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Ring the doorbell&n;&t;&t; */
r_if
c_cond
(paren
id|hpsb_node_entry_valid
c_func
(paren
id|scsi_id-&gt;ne
)paren
)paren
(brace
id|quadlet_t
id|data
op_assign
id|cpu_to_be32
c_func
(paren
id|command-&gt;command_orb_dma
)paren
suffix:semicolon
id|packet
op_assign
id|sbp2util_allocate_write_packet
c_func
(paren
id|hi
comma
id|scsi_id-&gt;ne
comma
id|scsi_id-&gt;sbp2_command_block_agent_addr
op_plus
id|SBP2_DOORBELL_OFFSET
comma
l_int|4
comma
op_amp
id|data
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|packet
)paren
(brace
id|SBP2_ERR
c_func
(paren
l_string|&quot;sbp2util_allocate_write_packet failed&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|SBP2_ORB_DEBUG
c_func
(paren
l_string|&quot;ring doorbell, command orb %p&quot;
comma
id|command_orb
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hpsb_send_packet
c_func
(paren
id|packet
)paren
)paren
(brace
id|SBP2_ERR
c_func
(paren
l_string|&quot;hpsb_send_packet failed&quot;
)paren
suffix:semicolon
id|sbp2_free_packet
c_func
(paren
id|packet
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
)brace
id|scsi_id-&gt;last_orb
op_assign
id|command_orb
suffix:semicolon
id|scsi_id-&gt;last_orb_dma
op_assign
id|command-&gt;command_orb_dma
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * This function is called in order to begin a regular SBP-2 command. &n; */
DECL|function|sbp2_send_command
r_static
r_int
id|sbp2_send_command
c_func
(paren
r_struct
id|scsi_id_instance_data
op_star
id|scsi_id
comma
id|Scsi_Cmnd
op_star
id|SCpnt
comma
r_void
(paren
op_star
id|done
)paren
(paren
id|Scsi_Cmnd
op_star
)paren
)paren
(brace
id|unchar
op_star
id|cmd
op_assign
(paren
id|unchar
op_star
)paren
id|SCpnt-&gt;cmnd
suffix:semicolon
r_int
r_int
id|request_bufflen
op_assign
id|SCpnt-&gt;request_bufflen
suffix:semicolon
r_struct
id|sbp2_command_info
op_star
id|command
suffix:semicolon
id|SBP2_DEBUG
c_func
(paren
l_string|&quot;sbp2_send_command&quot;
)paren
suffix:semicolon
macro_line|#if (CONFIG_IEEE1394_SBP2_DEBUG &gt;= 2) || defined(CONFIG_IEEE1394_SBP2_PACKET_DUMP)
id|printk
c_func
(paren
l_string|&quot;[scsi command]&bslash;n   &quot;
)paren
suffix:semicolon
id|print_command
(paren
id|cmd
)paren
suffix:semicolon
macro_line|#endif
id|SBP2_DEBUG
c_func
(paren
l_string|&quot;SCSI transfer size = %x&quot;
comma
id|request_bufflen
)paren
suffix:semicolon
id|SBP2_DEBUG
c_func
(paren
l_string|&quot;SCSI s/g elements = %x&quot;
comma
(paren
r_int
r_int
)paren
id|SCpnt-&gt;use_sg
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Allocate a command orb and s/g structure&n;&t; */
id|command
op_assign
id|sbp2util_allocate_command_orb
c_func
(paren
id|scsi_id
comma
id|SCpnt
comma
id|done
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|command
)paren
(brace
r_return
op_minus
id|EIO
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * The scsi stack sends down a request_bufflen which does not match the&n;&t; * length field in the scsi cdb. This causes some sbp2 devices to &n;&t; * reject this inquiry command. Fix the request_bufflen. &n;&t; */
r_if
c_cond
(paren
op_star
id|cmd
op_eq
id|INQUIRY
)paren
(brace
r_if
c_cond
(paren
id|force_inquiry_hack
op_logical_or
id|scsi_id-&gt;workarounds
op_amp
id|SBP2_BREAKAGE_INQUIRY_HACK
)paren
id|request_bufflen
op_assign
id|cmd
(braket
l_int|4
)braket
op_assign
l_int|0x24
suffix:semicolon
r_else
id|request_bufflen
op_assign
id|cmd
(braket
l_int|4
)braket
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Now actually fill in the comamnd orb and sbp2 s/g list&n;&t; */
id|sbp2_create_command_orb
c_func
(paren
id|scsi_id
comma
id|command
comma
id|cmd
comma
id|SCpnt-&gt;use_sg
comma
id|request_bufflen
comma
id|SCpnt-&gt;request_buffer
comma
id|SCpnt-&gt;sc_data_direction
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Update our cdb if necessary (to handle sbp2 RBC command set&n;&t; * differences). This is where the command set hacks go!   =)&n;&t; */
id|sbp2_check_sbp2_command
c_func
(paren
id|scsi_id
comma
id|command-&gt;command_orb.cdb
)paren
suffix:semicolon
id|sbp2util_packet_dump
c_func
(paren
op_amp
id|command-&gt;command_orb
comma
r_sizeof
(paren
r_struct
id|sbp2_command_orb
)paren
comma
l_string|&quot;sbp2 command orb&quot;
comma
id|command-&gt;command_orb_dma
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Initialize status fifo&n;&t; */
id|memset
c_func
(paren
op_amp
id|scsi_id-&gt;status_block
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|sbp2_status_block
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Link up the orb, and ring the doorbell if needed&n;&t; */
id|sbp2_link_orb_command
c_func
(paren
id|scsi_id
comma
id|command
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * This function deals with command set differences between Linux scsi&n; * command set and sbp2 RBC command set.&n; */
DECL|function|sbp2_check_sbp2_command
r_static
r_void
id|sbp2_check_sbp2_command
c_func
(paren
r_struct
id|scsi_id_instance_data
op_star
id|scsi_id
comma
id|unchar
op_star
id|cmd
)paren
(brace
id|unchar
id|new_cmd
(braket
l_int|16
)braket
suffix:semicolon
id|u8
id|device_type
op_assign
id|SBP2_DEVICE_TYPE
(paren
id|scsi_id-&gt;sbp2_device_type_and_lun
)paren
suffix:semicolon
id|SBP2_DEBUG
c_func
(paren
l_string|&quot;sbp2_check_sbp2_command&quot;
)paren
suffix:semicolon
r_switch
c_cond
(paren
op_star
id|cmd
)paren
(brace
r_case
id|READ_6
suffix:colon
r_if
c_cond
(paren
id|sbp2_command_conversion_device_type
c_func
(paren
id|device_type
)paren
)paren
(brace
id|SBP2_DEBUG
c_func
(paren
l_string|&quot;Convert READ_6 to READ_10&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t; * Need to turn read_6 into read_10&n;&t;&t;&t;&t; */
id|new_cmd
(braket
l_int|0
)braket
op_assign
l_int|0x28
suffix:semicolon
id|new_cmd
(braket
l_int|1
)braket
op_assign
(paren
id|cmd
(braket
l_int|1
)braket
op_amp
l_int|0xe0
)paren
suffix:semicolon
id|new_cmd
(braket
l_int|2
)braket
op_assign
l_int|0x0
suffix:semicolon
id|new_cmd
(braket
l_int|3
)braket
op_assign
(paren
id|cmd
(braket
l_int|1
)braket
op_amp
l_int|0x1f
)paren
suffix:semicolon
id|new_cmd
(braket
l_int|4
)braket
op_assign
id|cmd
(braket
l_int|2
)braket
suffix:semicolon
id|new_cmd
(braket
l_int|5
)braket
op_assign
id|cmd
(braket
l_int|3
)braket
suffix:semicolon
id|new_cmd
(braket
l_int|6
)braket
op_assign
l_int|0x0
suffix:semicolon
id|new_cmd
(braket
l_int|7
)braket
op_assign
l_int|0x0
suffix:semicolon
id|new_cmd
(braket
l_int|8
)braket
op_assign
id|cmd
(braket
l_int|4
)braket
suffix:semicolon
id|new_cmd
(braket
l_int|9
)braket
op_assign
id|cmd
(braket
l_int|5
)braket
suffix:semicolon
id|memcpy
c_func
(paren
id|cmd
comma
id|new_cmd
comma
l_int|10
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|WRITE_6
suffix:colon
r_if
c_cond
(paren
id|sbp2_command_conversion_device_type
c_func
(paren
id|device_type
)paren
)paren
(brace
id|SBP2_DEBUG
c_func
(paren
l_string|&quot;Convert WRITE_6 to WRITE_10&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t; * Need to turn write_6 into write_10&n;&t;&t;&t;&t; */
id|new_cmd
(braket
l_int|0
)braket
op_assign
l_int|0x2a
suffix:semicolon
id|new_cmd
(braket
l_int|1
)braket
op_assign
(paren
id|cmd
(braket
l_int|1
)braket
op_amp
l_int|0xe0
)paren
suffix:semicolon
id|new_cmd
(braket
l_int|2
)braket
op_assign
l_int|0x0
suffix:semicolon
id|new_cmd
(braket
l_int|3
)braket
op_assign
(paren
id|cmd
(braket
l_int|1
)braket
op_amp
l_int|0x1f
)paren
suffix:semicolon
id|new_cmd
(braket
l_int|4
)braket
op_assign
id|cmd
(braket
l_int|2
)braket
suffix:semicolon
id|new_cmd
(braket
l_int|5
)braket
op_assign
id|cmd
(braket
l_int|3
)braket
suffix:semicolon
id|new_cmd
(braket
l_int|6
)braket
op_assign
l_int|0x0
suffix:semicolon
id|new_cmd
(braket
l_int|7
)braket
op_assign
l_int|0x0
suffix:semicolon
id|new_cmd
(braket
l_int|8
)braket
op_assign
id|cmd
(braket
l_int|4
)braket
suffix:semicolon
id|new_cmd
(braket
l_int|9
)braket
op_assign
id|cmd
(braket
l_int|5
)braket
suffix:semicolon
id|memcpy
c_func
(paren
id|cmd
comma
id|new_cmd
comma
l_int|10
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|MODE_SENSE
suffix:colon
r_if
c_cond
(paren
id|sbp2_command_conversion_device_type
c_func
(paren
id|device_type
)paren
)paren
(brace
id|SBP2_DEBUG
c_func
(paren
l_string|&quot;Convert MODE_SENSE_6 to MODE_SENSE_10&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t; * Need to turn mode_sense_6 into mode_sense_10&n;&t;&t;&t;&t; */
id|new_cmd
(braket
l_int|0
)braket
op_assign
l_int|0x5a
suffix:semicolon
id|new_cmd
(braket
l_int|1
)braket
op_assign
id|cmd
(braket
l_int|1
)braket
suffix:semicolon
id|new_cmd
(braket
l_int|2
)braket
op_assign
id|cmd
(braket
l_int|2
)braket
suffix:semicolon
id|new_cmd
(braket
l_int|3
)braket
op_assign
l_int|0x0
suffix:semicolon
id|new_cmd
(braket
l_int|4
)braket
op_assign
l_int|0x0
suffix:semicolon
id|new_cmd
(braket
l_int|5
)braket
op_assign
l_int|0x0
suffix:semicolon
id|new_cmd
(braket
l_int|6
)braket
op_assign
l_int|0x0
suffix:semicolon
id|new_cmd
(braket
l_int|7
)braket
op_assign
l_int|0x0
suffix:semicolon
id|new_cmd
(braket
l_int|8
)braket
op_assign
id|cmd
(braket
l_int|4
)braket
suffix:semicolon
id|new_cmd
(braket
l_int|9
)braket
op_assign
id|cmd
(braket
l_int|5
)braket
suffix:semicolon
id|memcpy
c_func
(paren
id|cmd
comma
id|new_cmd
comma
l_int|10
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|MODE_SELECT
suffix:colon
multiline_comment|/*&n;&t;&t;&t; * TODO. Probably need to change mode select to 10 byte version&n;&t;&t;&t; */
r_default
suffix:colon
r_break
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * Translates SBP-2 status into SCSI sense data for check conditions&n; */
DECL|function|sbp2_status_to_sense_data
r_static
r_int
r_int
id|sbp2_status_to_sense_data
c_func
(paren
id|unchar
op_star
id|sbp2_status
comma
id|unchar
op_star
id|sense_data
)paren
(brace
id|SBP2_DEBUG
c_func
(paren
l_string|&quot;sbp2_status_to_sense_data&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Ok, it&squot;s pretty ugly...   ;-)&n;&t; */
id|sense_data
(braket
l_int|0
)braket
op_assign
l_int|0x70
suffix:semicolon
id|sense_data
(braket
l_int|1
)braket
op_assign
l_int|0x0
suffix:semicolon
id|sense_data
(braket
l_int|2
)braket
op_assign
id|sbp2_status
(braket
l_int|9
)braket
suffix:semicolon
id|sense_data
(braket
l_int|3
)braket
op_assign
id|sbp2_status
(braket
l_int|12
)braket
suffix:semicolon
id|sense_data
(braket
l_int|4
)braket
op_assign
id|sbp2_status
(braket
l_int|13
)braket
suffix:semicolon
id|sense_data
(braket
l_int|5
)braket
op_assign
id|sbp2_status
(braket
l_int|14
)braket
suffix:semicolon
id|sense_data
(braket
l_int|6
)braket
op_assign
id|sbp2_status
(braket
l_int|15
)braket
suffix:semicolon
id|sense_data
(braket
l_int|7
)braket
op_assign
l_int|10
suffix:semicolon
id|sense_data
(braket
l_int|8
)braket
op_assign
id|sbp2_status
(braket
l_int|16
)braket
suffix:semicolon
id|sense_data
(braket
l_int|9
)braket
op_assign
id|sbp2_status
(braket
l_int|17
)braket
suffix:semicolon
id|sense_data
(braket
l_int|10
)braket
op_assign
id|sbp2_status
(braket
l_int|18
)braket
suffix:semicolon
id|sense_data
(braket
l_int|11
)braket
op_assign
id|sbp2_status
(braket
l_int|19
)braket
suffix:semicolon
id|sense_data
(braket
l_int|12
)braket
op_assign
id|sbp2_status
(braket
l_int|10
)braket
suffix:semicolon
id|sense_data
(braket
l_int|13
)braket
op_assign
id|sbp2_status
(braket
l_int|11
)braket
suffix:semicolon
id|sense_data
(braket
l_int|14
)braket
op_assign
id|sbp2_status
(braket
l_int|20
)braket
suffix:semicolon
id|sense_data
(braket
l_int|15
)braket
op_assign
id|sbp2_status
(braket
l_int|21
)braket
suffix:semicolon
r_return
id|sbp2_status
(braket
l_int|8
)braket
op_amp
l_int|0x3f
suffix:semicolon
multiline_comment|/* return scsi status */
)brace
multiline_comment|/*&n; * This function is called after a command is completed, in order to do any necessary SBP-2&n; * response data translations for the SCSI stack&n; */
DECL|function|sbp2_check_sbp2_response
r_static
r_void
id|sbp2_check_sbp2_response
c_func
(paren
r_struct
id|scsi_id_instance_data
op_star
id|scsi_id
comma
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
id|u8
op_star
id|scsi_buf
op_assign
id|SCpnt-&gt;request_buffer
suffix:semicolon
id|u8
id|device_type
op_assign
id|SBP2_DEVICE_TYPE
(paren
id|scsi_id-&gt;sbp2_device_type_and_lun
)paren
suffix:semicolon
id|SBP2_DEBUG
c_func
(paren
l_string|&quot;sbp2_check_sbp2_response&quot;
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|SCpnt-&gt;cmnd
(braket
l_int|0
)braket
)paren
(brace
r_case
id|INQUIRY
suffix:colon
multiline_comment|/*&n;&t;&t;&t; * If scsi_id-&gt;sbp2_device_type_and_lun is uninitialized, then fill &n;&t;&t;&t; * this information in from the inquiry response data. Lun is set to zero.&n;&t;&t;&t; */
r_if
c_cond
(paren
id|scsi_id-&gt;sbp2_device_type_and_lun
op_eq
id|SBP2_DEVICE_TYPE_LUN_UNINITIALIZED
)paren
(brace
id|SBP2_DEBUG
c_func
(paren
l_string|&quot;Creating sbp2_device_type_and_lun from scsi inquiry data&quot;
)paren
suffix:semicolon
id|scsi_id-&gt;sbp2_device_type_and_lun
op_assign
(paren
id|scsi_buf
(braket
l_int|0
)braket
op_amp
l_int|0x1f
)paren
op_lshift
l_int|16
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t;&t; * Make sure data length is ok. Minimum length is 36 bytes&n;&t;&t;&t; */
r_if
c_cond
(paren
id|scsi_buf
(braket
l_int|4
)braket
op_eq
l_int|0
)paren
(brace
id|scsi_buf
(braket
l_int|4
)braket
op_assign
l_int|36
op_minus
l_int|5
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t;&t; * Check for Simple Direct Access Device and change it to TYPE_DISK&n;&t;&t;&t; */
r_if
c_cond
(paren
(paren
id|scsi_buf
(braket
l_int|0
)braket
op_amp
l_int|0x1f
)paren
op_eq
id|TYPE_SDAD
)paren
(brace
id|SBP2_DEBUG
c_func
(paren
l_string|&quot;Changing TYPE_SDAD to TYPE_DISK&quot;
)paren
suffix:semicolon
id|scsi_buf
(braket
l_int|0
)braket
op_and_assign
l_int|0xe0
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t;&t; * Fix ansi revision and response data format&n;&t;&t;&t; */
id|scsi_buf
(braket
l_int|2
)braket
op_or_assign
l_int|2
suffix:semicolon
id|scsi_buf
(braket
l_int|3
)braket
op_assign
(paren
id|scsi_buf
(braket
l_int|3
)braket
op_amp
l_int|0xf0
)paren
op_or
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MODE_SENSE
suffix:colon
r_if
c_cond
(paren
id|sbp2_command_conversion_device_type
c_func
(paren
id|device_type
)paren
)paren
(brace
id|SBP2_DEBUG
c_func
(paren
l_string|&quot;Modify mode sense response (10 byte version)&quot;
)paren
suffix:semicolon
id|scsi_buf
(braket
l_int|0
)braket
op_assign
id|scsi_buf
(braket
l_int|1
)braket
suffix:semicolon
multiline_comment|/* Mode data length */
id|scsi_buf
(braket
l_int|1
)braket
op_assign
id|scsi_buf
(braket
l_int|2
)braket
suffix:semicolon
multiline_comment|/* Medium type */
id|scsi_buf
(braket
l_int|2
)braket
op_assign
id|scsi_buf
(braket
l_int|3
)braket
suffix:semicolon
multiline_comment|/* Device specific parameter */
id|scsi_buf
(braket
l_int|3
)braket
op_assign
id|scsi_buf
(braket
l_int|7
)braket
suffix:semicolon
multiline_comment|/* Block descriptor length */
id|memcpy
c_func
(paren
id|scsi_buf
op_plus
l_int|4
comma
id|scsi_buf
op_plus
l_int|8
comma
id|scsi_buf
(braket
l_int|0
)braket
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|MODE_SELECT
suffix:colon
multiline_comment|/*&n;&t;&t;&t; * TODO. Probably need to change mode select to 10 byte version&n;&t;&t;&t; */
r_default
suffix:colon
r_break
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * This function deals with status writes from the SBP-2 device&n; */
DECL|function|sbp2_handle_status_write
r_static
r_int
id|sbp2_handle_status_write
c_func
(paren
r_struct
id|hpsb_host
op_star
id|host
comma
r_int
id|nodeid
comma
r_int
id|destid
comma
id|quadlet_t
op_star
id|data
comma
id|u64
id|addr
comma
r_int
id|length
comma
id|u16
id|fl
)paren
(brace
r_struct
id|sbp2scsi_host_info
op_star
id|hi
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|scsi_id_instance_data
op_star
id|scsi_id
op_assign
l_int|NULL
suffix:semicolon
id|u32
id|id
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|Scsi_Cmnd
op_star
id|SCpnt
op_assign
l_int|NULL
suffix:semicolon
id|u32
id|scsi_status
op_assign
id|SBP2_SCSI_STATUS_GOOD
suffix:semicolon
r_struct
id|sbp2_command_info
op_star
id|command
suffix:semicolon
id|SBP2_DEBUG
c_func
(paren
l_string|&quot;sbp2_handle_status_write&quot;
)paren
suffix:semicolon
id|sbp2util_packet_dump
c_func
(paren
id|data
comma
id|length
comma
l_string|&quot;sbp2 status write by device&quot;
comma
(paren
id|u32
)paren
id|addr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|host
)paren
(brace
id|SBP2_ERR
c_func
(paren
l_string|&quot;host is NULL - this is bad!&quot;
)paren
suffix:semicolon
r_return
id|RCODE_ADDRESS_ERROR
suffix:semicolon
)brace
id|hi
op_assign
id|hpsb_get_hostinfo
c_func
(paren
op_amp
id|sbp2_highlevel
comma
id|host
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hi
)paren
(brace
id|SBP2_ERR
c_func
(paren
l_string|&quot;host info is NULL - this is bad!&quot;
)paren
suffix:semicolon
r_return
id|RCODE_ADDRESS_ERROR
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|hi-&gt;sbp2_command_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Find our scsi_id structure by looking at the status fifo address written to by&n;&t; * the sbp2 device.&n;&t; */
id|id
op_assign
id|SBP2_STATUS_FIFO_OFFSET_TO_ENTRY
c_func
(paren
(paren
id|u32
)paren
(paren
id|addr
op_minus
id|SBP2_STATUS_FIFO_ADDRESS
)paren
)paren
suffix:semicolon
id|scsi_id
op_assign
id|hi-&gt;scsi_id
(braket
id|id
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|scsi_id
)paren
(brace
id|SBP2_ERR
c_func
(paren
l_string|&quot;scsi_id is NULL - device is gone?&quot;
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|hi-&gt;sbp2_command_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|RCODE_ADDRESS_ERROR
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Put response into scsi_id status fifo... &n;&t; */
id|memcpy
c_func
(paren
op_amp
id|scsi_id-&gt;status_block
comma
id|data
comma
id|length
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Byte swap first two quadlets (8 bytes) of status for processing&n;&t; */
id|sbp2util_be32_to_cpu_buffer
c_func
(paren
op_amp
id|scsi_id-&gt;status_block
comma
l_int|8
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Handle command ORB status here if necessary. First, need to match status with command.&n;&t; */
id|command
op_assign
id|sbp2util_find_command_for_orb
c_func
(paren
id|scsi_id
comma
id|scsi_id-&gt;status_block.ORB_offset_lo
)paren
suffix:semicolon
r_if
c_cond
(paren
id|command
)paren
(brace
id|SBP2_DEBUG
c_func
(paren
l_string|&quot;Found status for command ORB&quot;
)paren
suffix:semicolon
id|pci_dma_sync_single
c_func
(paren
id|hi-&gt;host-&gt;pdev
comma
id|command-&gt;command_orb_dma
comma
r_sizeof
(paren
r_struct
id|sbp2_command_orb
)paren
comma
id|PCI_DMA_BIDIRECTIONAL
)paren
suffix:semicolon
id|pci_dma_sync_single
c_func
(paren
id|hi-&gt;host-&gt;pdev
comma
id|command-&gt;sge_dma
comma
r_sizeof
(paren
id|command-&gt;scatter_gather_element
)paren
comma
id|PCI_DMA_BIDIRECTIONAL
)paren
suffix:semicolon
id|SBP2_ORB_DEBUG
c_func
(paren
l_string|&quot;matched command orb %p&quot;
comma
op_amp
id|command-&gt;command_orb
)paren
suffix:semicolon
id|outstanding_orb_decr
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Matched status with command, now grab scsi command pointers and check status&n;&t;&t; */
id|SCpnt
op_assign
id|command-&gt;Current_SCpnt
suffix:semicolon
id|sbp2util_mark_command_completed
c_func
(paren
id|scsi_id
comma
id|command
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SCpnt
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * See if the target stored any scsi status information&n;&t;&t;&t; */
r_if
c_cond
(paren
id|STATUS_GET_LENGTH
c_func
(paren
id|scsi_id-&gt;status_block.ORB_offset_hi_misc
)paren
OG
l_int|1
)paren
(brace
multiline_comment|/*&n;&t;&t;&t;&t; * Translate SBP-2 status to SCSI sense data&n;&t;&t;&t;&t; */
id|SBP2_DEBUG
c_func
(paren
l_string|&quot;CHECK CONDITION&quot;
)paren
suffix:semicolon
id|scsi_status
op_assign
id|sbp2_status_to_sense_data
c_func
(paren
(paren
id|unchar
op_star
)paren
op_amp
id|scsi_id-&gt;status_block
comma
id|SCpnt-&gt;sense_buffer
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t;&t; * Check to see if the dead bit is set. If so, we&squot;ll have to initiate&n;&t;&t;&t; * a fetch agent reset.&n;&t;&t;&t; */
r_if
c_cond
(paren
id|STATUS_GET_DEAD_BIT
c_func
(paren
id|scsi_id-&gt;status_block.ORB_offset_hi_misc
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t;&t;&t; * Initiate a fetch agent reset. &n;&t;&t;&t;&t; */
id|SBP2_DEBUG
c_func
(paren
l_string|&quot;Dead bit set - initiating fetch agent reset&quot;
)paren
suffix:semicolon
id|sbp2_agent_reset
c_func
(paren
id|scsi_id
comma
l_int|0
)paren
suffix:semicolon
)brace
id|SBP2_ORB_DEBUG
c_func
(paren
l_string|&quot;completing command orb %p&quot;
comma
op_amp
id|command-&gt;command_orb
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * Check here to see if there are no commands in-use. If there are none, we can&n;&t;&t; * null out last orb so that next time around we write directly to the orb pointer... &n;&t;&t; * Quick start saves one 1394 bus transaction.&n;&t;&t; */
r_if
c_cond
(paren
id|list_empty
c_func
(paren
op_amp
id|scsi_id-&gt;sbp2_command_orb_inuse
)paren
)paren
(brace
id|scsi_id-&gt;last_orb
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* &n;&t;&t; * It&squot;s probably a login/logout/reconnect status.&n;&t;&t; */
r_if
c_cond
(paren
(paren
id|scsi_id-&gt;login_orb_dma
op_eq
id|scsi_id-&gt;status_block.ORB_offset_lo
)paren
op_logical_or
(paren
id|scsi_id-&gt;query_logins_orb_dma
op_eq
id|scsi_id-&gt;status_block.ORB_offset_lo
)paren
op_logical_or
(paren
id|scsi_id-&gt;reconnect_orb_dma
op_eq
id|scsi_id-&gt;status_block.ORB_offset_lo
)paren
op_logical_or
(paren
id|scsi_id-&gt;logout_orb_dma
op_eq
id|scsi_id-&gt;status_block.ORB_offset_lo
)paren
)paren
(brace
id|atomic_set
c_func
(paren
op_amp
id|scsi_id-&gt;sbp2_login_complete
comma
l_int|1
)paren
suffix:semicolon
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|hi-&gt;sbp2_command_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SCpnt
)paren
(brace
multiline_comment|/*&n;&t;&t; * Complete the SCSI command.&n;&t;&t; *&n;&t;&t; * Only do it after we&squot;ve released the sbp2_command_lock,&n;&t;&t; * as it might otherwise deadlock with the &n;&t;&t; * io_request_lock (in sbp2scsi_queuecommand).&n;&t;&t; */
id|SBP2_DEBUG
c_func
(paren
l_string|&quot;Completing SCSI command&quot;
)paren
suffix:semicolon
id|sbp2scsi_complete_command
c_func
(paren
id|scsi_id
comma
id|scsi_status
comma
id|SCpnt
comma
id|command-&gt;Current_done
)paren
suffix:semicolon
id|SBP2_ORB_DEBUG
c_func
(paren
l_string|&quot;command orb completed&quot;
)paren
suffix:semicolon
)brace
r_return
id|RCODE_COMPLETE
suffix:semicolon
)brace
multiline_comment|/**************************************&n; * SCSI interface related section&n; **************************************/
multiline_comment|/*&n; * This routine is the main request entry routine for doing I/O. It is &n; * called from the scsi stack directly.&n; */
DECL|function|sbp2scsi_queuecommand
r_static
r_int
id|sbp2scsi_queuecommand
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
comma
r_void
(paren
op_star
id|done
)paren
(paren
id|Scsi_Cmnd
op_star
)paren
)paren
(brace
r_struct
id|sbp2scsi_host_info
op_star
id|hi
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|scsi_id_instance_data
op_star
id|scsi_id
op_assign
l_int|NULL
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|SBP2_DEBUG
c_func
(paren
l_string|&quot;sbp2scsi_queuecommand&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Pull our host info and scsi id instance data from the scsi command&n;&t; */
id|hi
op_assign
id|hpsb_get_hostinfo_bykey
c_func
(paren
op_amp
id|sbp2_highlevel
comma
(paren
r_int
r_int
)paren
id|SCpnt-&gt;device-&gt;host
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hi
)paren
(brace
id|SBP2_ERR
c_func
(paren
l_string|&quot;sbp2scsi_host_info is NULL - this is bad!&quot;
)paren
suffix:semicolon
id|SCpnt-&gt;result
op_assign
id|DID_NO_CONNECT
op_lshift
l_int|16
suffix:semicolon
id|done
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|scsi_id
op_assign
id|hi-&gt;scsi_id
(braket
id|SCpnt-&gt;device-&gt;id
)braket
suffix:semicolon
multiline_comment|/*&n;&t; * If scsi_id is null, it means there is no device in this slot,&n;&t; * so we should return selection timeout.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|scsi_id
)paren
(brace
id|SCpnt-&gt;result
op_assign
id|DID_NO_CONNECT
op_lshift
l_int|16
suffix:semicolon
id|done
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Until we handle multiple luns, just return selection time-out&n;&t; * to any IO directed at non-zero LUNs&n;&t; */
r_if
c_cond
(paren
id|SCpnt-&gt;device-&gt;lun
)paren
(brace
id|SCpnt-&gt;result
op_assign
id|DID_NO_CONNECT
op_lshift
l_int|16
suffix:semicolon
id|done
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Check for request sense command, and handle it here&n;&t; * (autorequest sense)&n;&t; */
r_if
c_cond
(paren
id|SCpnt-&gt;cmnd
(braket
l_int|0
)braket
op_eq
id|REQUEST_SENSE
)paren
(brace
id|SBP2_DEBUG
c_func
(paren
l_string|&quot;REQUEST_SENSE&quot;
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|SCpnt-&gt;request_buffer
comma
id|SCpnt-&gt;sense_buffer
comma
id|SCpnt-&gt;request_bufflen
)paren
suffix:semicolon
id|memset
c_func
(paren
id|SCpnt-&gt;sense_buffer
comma
l_int|0
comma
r_sizeof
(paren
id|SCpnt-&gt;sense_buffer
)paren
)paren
suffix:semicolon
id|sbp2scsi_complete_command
c_func
(paren
id|scsi_id
comma
id|SBP2_SCSI_STATUS_GOOD
comma
id|SCpnt
comma
id|done
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Check to see if we are in the middle of a bus reset.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|hpsb_node_entry_valid
c_func
(paren
id|scsi_id-&gt;ne
)paren
)paren
(brace
id|SBP2_ERR
c_func
(paren
l_string|&quot;Bus reset in progress - rejecting command&quot;
)paren
suffix:semicolon
id|SCpnt-&gt;result
op_assign
id|DID_BUS_BUSY
op_lshift
l_int|16
suffix:semicolon
id|done
(paren
id|SCpnt
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Try and send our SCSI command&n;&t; */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|hi-&gt;sbp2_command_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sbp2_send_command
c_func
(paren
id|scsi_id
comma
id|SCpnt
comma
id|done
)paren
)paren
(brace
id|SBP2_ERR
c_func
(paren
l_string|&quot;Error sending SCSI command&quot;
)paren
suffix:semicolon
id|sbp2scsi_complete_command
c_func
(paren
id|scsi_id
comma
id|SBP2_SCSI_STATUS_SELECTION_TIMEOUT
comma
id|SCpnt
comma
id|done
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|hi-&gt;sbp2_command_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * This function is called in order to complete all outstanding SBP-2&n; * commands (in case of resets, etc.).&n; */
DECL|function|sbp2scsi_complete_all_commands
r_static
r_void
id|sbp2scsi_complete_all_commands
c_func
(paren
r_struct
id|scsi_id_instance_data
op_star
id|scsi_id
comma
id|u32
id|status
)paren
(brace
r_struct
id|sbp2scsi_host_info
op_star
id|hi
op_assign
id|scsi_id-&gt;hi
suffix:semicolon
r_struct
id|list_head
op_star
id|lh
suffix:semicolon
r_struct
id|sbp2_command_info
op_star
id|command
suffix:semicolon
id|SBP2_DEBUG
c_func
(paren
l_string|&quot;sbp2_complete_all_commands&quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|scsi_id-&gt;sbp2_command_orb_inuse
)paren
)paren
(brace
id|SBP2_DEBUG
c_func
(paren
l_string|&quot;Found pending command to complete&quot;
)paren
suffix:semicolon
id|lh
op_assign
id|scsi_id-&gt;sbp2_command_orb_inuse.next
suffix:semicolon
id|command
op_assign
id|list_entry
c_func
(paren
id|lh
comma
r_struct
id|sbp2_command_info
comma
id|list
)paren
suffix:semicolon
id|pci_dma_sync_single
c_func
(paren
id|hi-&gt;host-&gt;pdev
comma
id|command-&gt;command_orb_dma
comma
r_sizeof
(paren
r_struct
id|sbp2_command_orb
)paren
comma
id|PCI_DMA_BIDIRECTIONAL
)paren
suffix:semicolon
id|pci_dma_sync_single
c_func
(paren
id|hi-&gt;host-&gt;pdev
comma
id|command-&gt;sge_dma
comma
r_sizeof
(paren
id|command-&gt;scatter_gather_element
)paren
comma
id|PCI_DMA_BIDIRECTIONAL
)paren
suffix:semicolon
id|sbp2util_mark_command_completed
c_func
(paren
id|scsi_id
comma
id|command
)paren
suffix:semicolon
r_if
c_cond
(paren
id|command-&gt;Current_SCpnt
)paren
(brace
r_void
(paren
op_star
id|done
)paren
(paren
id|Scsi_Cmnd
op_star
)paren
op_assign
id|command-&gt;Current_done
suffix:semicolon
id|command-&gt;Current_SCpnt-&gt;result
op_assign
id|status
op_lshift
l_int|16
suffix:semicolon
id|done
(paren
id|command-&gt;Current_SCpnt
)paren
suffix:semicolon
)brace
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * This function is called in order to complete a regular SBP-2 command.&n; *&n; * This can be called in interrupt context.&n; */
DECL|function|sbp2scsi_complete_command
r_static
r_void
id|sbp2scsi_complete_command
c_func
(paren
r_struct
id|scsi_id_instance_data
op_star
id|scsi_id
comma
id|u32
id|scsi_status
comma
id|Scsi_Cmnd
op_star
id|SCpnt
comma
r_void
(paren
op_star
id|done
)paren
(paren
id|Scsi_Cmnd
op_star
)paren
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|SBP2_DEBUG
c_func
(paren
l_string|&quot;sbp2scsi_complete_command&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Sanity&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|SCpnt
)paren
(brace
id|SBP2_ERR
c_func
(paren
l_string|&quot;SCpnt is NULL&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * If a bus reset is in progress and there was an error, don&squot;t&n;&t; * complete the command, just let it get retried at the end of the&n;&t; * bus reset.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|hpsb_node_entry_valid
c_func
(paren
id|scsi_id-&gt;ne
)paren
op_logical_and
(paren
id|scsi_status
op_ne
id|SBP2_SCSI_STATUS_GOOD
)paren
)paren
(brace
id|SBP2_ERR
c_func
(paren
l_string|&quot;Bus reset in progress - retry command later&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Switch on scsi status&n;&t; */
r_switch
c_cond
(paren
id|scsi_status
)paren
(brace
r_case
id|SBP2_SCSI_STATUS_GOOD
suffix:colon
id|SCpnt-&gt;result
op_assign
id|DID_OK
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SBP2_SCSI_STATUS_BUSY
suffix:colon
id|SBP2_ERR
c_func
(paren
l_string|&quot;SBP2_SCSI_STATUS_BUSY&quot;
)paren
suffix:semicolon
id|SCpnt-&gt;result
op_assign
id|DID_BUS_BUSY
op_lshift
l_int|16
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SBP2_SCSI_STATUS_CHECK_CONDITION
suffix:colon
id|SBP2_DEBUG
c_func
(paren
l_string|&quot;SBP2_SCSI_STATUS_CHECK_CONDITION&quot;
)paren
suffix:semicolon
id|SCpnt-&gt;result
op_assign
id|CHECK_CONDITION
op_lshift
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * Debug stuff&n;&t;&t;&t; */
macro_line|#if CONFIG_IEEE1394_SBP2_DEBUG &gt;= 1
id|print_command
(paren
id|SCpnt-&gt;cmnd
)paren
suffix:semicolon
id|print_sense
c_func
(paren
l_string|&quot;bh&quot;
comma
id|SCpnt
)paren
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
r_case
id|SBP2_SCSI_STATUS_SELECTION_TIMEOUT
suffix:colon
id|SBP2_ERR
c_func
(paren
l_string|&quot;SBP2_SCSI_STATUS_SELECTION_TIMEOUT&quot;
)paren
suffix:semicolon
id|SCpnt-&gt;result
op_assign
id|DID_NO_CONNECT
op_lshift
l_int|16
suffix:semicolon
id|print_command
(paren
id|SCpnt-&gt;cmnd
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SBP2_SCSI_STATUS_CONDITION_MET
suffix:colon
r_case
id|SBP2_SCSI_STATUS_RESERVATION_CONFLICT
suffix:colon
r_case
id|SBP2_SCSI_STATUS_COMMAND_TERMINATED
suffix:colon
id|SBP2_ERR
c_func
(paren
l_string|&quot;Bad SCSI status = %x&quot;
comma
id|scsi_status
)paren
suffix:semicolon
id|SCpnt-&gt;result
op_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
id|print_command
(paren
id|SCpnt-&gt;cmnd
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|SBP2_ERR
c_func
(paren
l_string|&quot;Unsupported SCSI status = %x&quot;
comma
id|scsi_status
)paren
suffix:semicolon
id|SCpnt-&gt;result
op_assign
id|DID_ERROR
op_lshift
l_int|16
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Take care of any sbp2 response data mucking here (RBC stuff, etc.)&n;&t; */
r_if
c_cond
(paren
id|SCpnt-&gt;result
op_eq
id|DID_OK
)paren
(brace
id|sbp2_check_sbp2_response
c_func
(paren
id|scsi_id
comma
id|SCpnt
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * If a bus reset is in progress and there was an error, complete&n;&t; * the command as busy so that it will get retried.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|hpsb_node_entry_valid
c_func
(paren
id|scsi_id-&gt;ne
)paren
op_logical_and
(paren
id|scsi_status
op_ne
id|SBP2_SCSI_STATUS_GOOD
)paren
)paren
(brace
id|SBP2_ERR
c_func
(paren
l_string|&quot;Completing command with busy (bus reset)&quot;
)paren
suffix:semicolon
id|SCpnt-&gt;result
op_assign
id|DID_BUS_BUSY
op_lshift
l_int|16
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * If a unit attention occurs, return busy status so it gets&n;&t; * retried... it could have happened because of a 1394 bus reset&n;&t; * or hot-plug...&n;&t; */
macro_line|#if 0
r_if
c_cond
(paren
(paren
id|scsi_status
op_eq
id|SBP2_SCSI_STATUS_CHECK_CONDITION
)paren
op_logical_and
(paren
id|SCpnt-&gt;sense_buffer
(braket
l_int|2
)braket
op_eq
id|UNIT_ATTENTION
)paren
)paren
(brace
id|SBP2_DEBUG
c_func
(paren
l_string|&quot;UNIT ATTENTION - return busy&quot;
)paren
suffix:semicolon
id|SCpnt-&gt;result
op_assign
id|DID_BUS_BUSY
op_lshift
l_int|16
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n;&t; * Tell scsi stack that we&squot;re done with this command&n;&t; */
id|spin_lock_irqsave
c_func
(paren
id|scsi_id-&gt;hi-&gt;scsi_host-&gt;host_lock
comma
id|flags
)paren
suffix:semicolon
id|done
(paren
id|SCpnt
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
id|scsi_id-&gt;hi-&gt;scsi_host-&gt;host_lock
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * Called by scsi stack when something has really gone wrong.  Usually&n; * called when a command has timed-out for some reason.&n; */
DECL|function|sbp2scsi_abort
r_static
r_int
id|sbp2scsi_abort
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
r_struct
id|sbp2scsi_host_info
op_star
id|hi
op_assign
id|hpsb_get_hostinfo_bykey
c_func
(paren
op_amp
id|sbp2_highlevel
comma
(paren
r_int
r_int
)paren
id|SCpnt-&gt;device-&gt;host
)paren
suffix:semicolon
r_struct
id|scsi_id_instance_data
op_star
id|scsi_id
op_assign
id|hi-&gt;scsi_id
(braket
id|SCpnt-&gt;device-&gt;id
)braket
suffix:semicolon
r_struct
id|sbp2_command_info
op_star
id|command
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|SBP2_ERR
c_func
(paren
l_string|&quot;aborting sbp2 command&quot;
)paren
suffix:semicolon
id|print_command
(paren
id|SCpnt-&gt;cmnd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|scsi_id
)paren
(brace
multiline_comment|/*&n;&t;&t; * Right now, just return any matching command structures&n;&t;&t; * to the free pool.&n;&t;&t; */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|hi-&gt;sbp2_command_lock
comma
id|flags
)paren
suffix:semicolon
id|command
op_assign
id|sbp2util_find_command_for_SCpnt
c_func
(paren
id|scsi_id
comma
id|SCpnt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|command
)paren
(brace
id|SBP2_DEBUG
c_func
(paren
l_string|&quot;Found command to abort&quot;
)paren
suffix:semicolon
id|pci_dma_sync_single
c_func
(paren
id|hi-&gt;host-&gt;pdev
comma
id|command-&gt;command_orb_dma
comma
r_sizeof
(paren
r_struct
id|sbp2_command_orb
)paren
comma
id|PCI_DMA_BIDIRECTIONAL
)paren
suffix:semicolon
id|pci_dma_sync_single
c_func
(paren
id|hi-&gt;host-&gt;pdev
comma
id|command-&gt;sge_dma
comma
r_sizeof
(paren
id|command-&gt;scatter_gather_element
)paren
comma
id|PCI_DMA_BIDIRECTIONAL
)paren
suffix:semicolon
id|sbp2util_mark_command_completed
c_func
(paren
id|scsi_id
comma
id|command
)paren
suffix:semicolon
r_if
c_cond
(paren
id|command-&gt;Current_SCpnt
)paren
(brace
r_void
(paren
op_star
id|done
)paren
(paren
id|Scsi_Cmnd
op_star
)paren
op_assign
id|command-&gt;Current_done
suffix:semicolon
id|command-&gt;Current_SCpnt-&gt;result
op_assign
id|DID_ABORT
op_lshift
l_int|16
suffix:semicolon
id|done
(paren
id|command-&gt;Current_SCpnt
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t;&t; * Initiate a fetch agent reset. &n;&t;&t; */
id|sbp2_agent_reset
c_func
(paren
id|scsi_id
comma
l_int|0
)paren
suffix:semicolon
id|sbp2scsi_complete_all_commands
c_func
(paren
id|scsi_id
comma
id|DID_BUS_BUSY
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|hi-&gt;sbp2_command_lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_return
id|SUCCESS
suffix:semicolon
)brace
multiline_comment|/*&n; * Called by scsi stack when something has really gone wrong.&n; */
DECL|function|sbp2scsi_reset
r_static
r_int
id|sbp2scsi_reset
(paren
id|Scsi_Cmnd
op_star
id|SCpnt
)paren
(brace
r_struct
id|sbp2scsi_host_info
op_star
id|hi
op_assign
id|hpsb_get_hostinfo_bykey
c_func
(paren
op_amp
id|sbp2_highlevel
comma
(paren
r_int
r_int
)paren
id|SCpnt-&gt;device-&gt;host
)paren
suffix:semicolon
r_struct
id|scsi_id_instance_data
op_star
id|scsi_id
op_assign
id|hi-&gt;scsi_id
(braket
id|SCpnt-&gt;device-&gt;id
)braket
suffix:semicolon
id|SBP2_ERR
c_func
(paren
l_string|&quot;reset requested&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|scsi_id
)paren
(brace
id|SBP2_ERR
c_func
(paren
l_string|&quot;Generating sbp2 fetch agent reset&quot;
)paren
suffix:semicolon
id|sbp2_agent_reset
c_func
(paren
id|scsi_id
comma
l_int|0
)paren
suffix:semicolon
)brace
r_return
id|SUCCESS
suffix:semicolon
)brace
DECL|function|sbp2scsi_info
r_static
r_const
r_char
op_star
id|sbp2scsi_info
(paren
r_struct
id|Scsi_Host
op_star
id|host
)paren
(brace
r_return
l_string|&quot;SCSI emulation for IEEE-1394 SBP-2 Devices&quot;
suffix:semicolon
)brace
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Ben Collins &lt;bcollins@debian.org&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;IEEE-1394 SBP-2 protocol driver&quot;
)paren
suffix:semicolon
DECL|variable|SBP2_DEVICE_NAME
id|MODULE_SUPPORTED_DEVICE
c_func
(paren
id|SBP2_DEVICE_NAME
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
multiline_comment|/* SCSI host template */
DECL|variable|scsi_driver_template
r_static
id|Scsi_Host_Template
id|scsi_driver_template
op_assign
(brace
dot
id|module
op_assign
id|THIS_MODULE
comma
dot
id|name
op_assign
l_string|&quot;SBP-2 IEEE-1394&quot;
comma
dot
id|proc_name
op_assign
id|SBP2_DEVICE_NAME
comma
dot
id|info
op_assign
id|sbp2scsi_info
comma
dot
id|queuecommand
op_assign
id|sbp2scsi_queuecommand
comma
dot
id|eh_abort_handler
op_assign
id|sbp2scsi_abort
comma
dot
id|eh_device_reset_handler
op_assign
id|sbp2scsi_reset
comma
dot
id|eh_bus_reset_handler
op_assign
id|sbp2scsi_reset
comma
dot
id|eh_host_reset_handler
op_assign
id|sbp2scsi_reset
comma
dot
id|this_id
op_assign
op_minus
l_int|1
comma
dot
id|sg_tablesize
op_assign
id|SG_ALL
comma
dot
id|use_clustering
op_assign
id|ENABLE_CLUSTERING
comma
dot
id|cmd_per_lun
op_assign
id|SBP2_MAX_CMDS_PER_LUN
comma
dot
id|can_queue
op_assign
id|SBP2_MAX_SCSI_QUEUE
comma
dot
id|emulated
op_assign
l_int|1
comma
)brace
suffix:semicolon
DECL|function|sbp2_module_init
r_static
r_int
id|sbp2_module_init
c_func
(paren
r_void
)paren
(brace
id|SBP2_DEBUG
c_func
(paren
l_string|&quot;sbp2_module_init&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;sbp2: %s&bslash;n&quot;
comma
id|version
)paren
suffix:semicolon
multiline_comment|/* Module load debug option to force one command at a time (serializing I/O) */
r_if
c_cond
(paren
id|serialize_io
)paren
(brace
id|SBP2_ERR
c_func
(paren
l_string|&quot;Driver forced to serialize I/O (serialize_io = 1)&quot;
)paren
suffix:semicolon
id|scsi_driver_template.can_queue
op_assign
l_int|1
suffix:semicolon
id|scsi_driver_template.cmd_per_lun
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Set max sectors (module load option). Default is 255 sectors. */
id|scsi_driver_template.max_sectors
op_assign
id|max_sectors
suffix:semicolon
multiline_comment|/* Register our high level driver with 1394 stack */
id|hpsb_register_highlevel
c_func
(paren
op_amp
id|sbp2_highlevel
)paren
suffix:semicolon
multiline_comment|/* Register our sbp2 status address space... */
id|hpsb_register_addrspace
c_func
(paren
op_amp
id|sbp2_highlevel
comma
op_amp
id|sbp2_ops
comma
id|SBP2_STATUS_FIFO_ADDRESS
comma
id|SBP2_STATUS_FIFO_ADDRESS
op_plus
id|SBP2_STATUS_FIFO_ENTRY_TO_OFFSET
c_func
(paren
id|SBP2SCSI_MAX_SCSI_IDS
op_plus
l_int|1
)paren
)paren
suffix:semicolon
multiline_comment|/* Handle data movement if physical dma is not enabled/supported&n;&t; * on host controller */
macro_line|#ifdef CONFIG_IEEE1394_SBP2_PHYS_DMA
id|hpsb_register_addrspace
c_func
(paren
op_amp
id|sbp2_highlevel
comma
op_amp
id|sbp2_physdma_ops
comma
l_int|0x0ULL
comma
l_int|0xfffffffcULL
)paren
suffix:semicolon
macro_line|#endif
id|hpsb_register_protocol
c_func
(paren
op_amp
id|sbp2_driver
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sbp2_module_exit
r_static
r_void
id|__exit
id|sbp2_module_exit
c_func
(paren
r_void
)paren
(brace
id|SBP2_DEBUG
c_func
(paren
l_string|&quot;sbp2_module_exit&quot;
)paren
suffix:semicolon
id|hpsb_unregister_protocol
c_func
(paren
op_amp
id|sbp2_driver
)paren
suffix:semicolon
id|hpsb_unregister_highlevel
c_func
(paren
op_amp
id|sbp2_highlevel
)paren
suffix:semicolon
)brace
DECL|variable|sbp2_module_init
id|module_init
c_func
(paren
id|sbp2_module_init
)paren
suffix:semicolon
DECL|variable|sbp2_module_exit
id|module_exit
c_func
(paren
id|sbp2_module_exit
)paren
suffix:semicolon
eof
