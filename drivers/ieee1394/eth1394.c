multiline_comment|/*&n; * eth1394.c -- Ethernet driver for Linux IEEE-1394 Subsystem&n; * &n; * Copyright (C) 2001 Ben Collins &lt;bcollins@debian.org&gt;&n; *               2000 Bonin Franck &lt;boninf@free.fr&gt;&n; *&n; * Mainly based on work by Emanuel Pirker and Andreas E. Bombe&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or&n; * (at your option) any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software Foundation,&n; * Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.&n; */
multiline_comment|/* State of this driver:&n; *&n; * This driver intends to support RFC 2734, which describes a method for&n; * transporting IPv4 datagrams over IEEE-1394 serial busses. This driver&n; * will ultimately support that method, but currently falls short in&n; * several areas. A few issues are:&n; *&n; *   - Does not support send/recv over Async streams using GASP&n; *     packet formats, as per the RFC for ARP requests.&n; *   - Does not yet support fragmented packets.&n; *   - Relies on hardware address being equal to the nodeid for some things.&n; *   - Does not support multicast&n; *   - Hardcoded address for sending packets, instead of using discovery&n; *     (ARP, see first item)&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/inetdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/if_arp.h&gt;
macro_line|#include &lt;linux/if_ether.h&gt;
macro_line|#include &lt;linux/ip.h&gt;
macro_line|#include &lt;linux/tcp.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;asm/delay.h&gt;
macro_line|#include &lt;asm/semaphore.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;net/arp.h&gt;
macro_line|#include &quot;ieee1394_types.h&quot;
macro_line|#include &quot;ieee1394_core.h&quot;
macro_line|#include &quot;ieee1394_transactions.h&quot;
macro_line|#include &quot;ieee1394.h&quot;
macro_line|#include &quot;highlevel.h&quot;
macro_line|#include &quot;eth1394.h&quot;
DECL|macro|ETH1394_PRINT_G
mdefine_line|#define ETH1394_PRINT_G(level, fmt, args...) &bslash;&n;&t;printk(level ETHER1394_DRIVER_NAME&quot;: &quot;fmt, ## args)
DECL|macro|ETH1394_PRINT
mdefine_line|#define ETH1394_PRINT(level, dev_name, fmt, args...) &bslash;&n;&t;printk(level ETHER1394_DRIVER_NAME&quot;: %s: &quot; fmt, dev_name, ## args)
DECL|macro|DEBUG
mdefine_line|#define DEBUG(fmt, args...) &bslash;&n;&t;printk(KERN_ERR fmt, ## args)
DECL|variable|__devinitdata
r_static
r_char
id|version
(braket
)braket
id|__devinitdata
op_assign
l_string|&quot;$Rev: 546 $ Ben Collins &lt;bcollins@debian.org&gt;&quot;
suffix:semicolon
multiline_comment|/* Our ieee1394 highlevel driver */
DECL|macro|ETHER1394_DRIVER_NAME
mdefine_line|#define ETHER1394_DRIVER_NAME &quot;ether1394&quot;
DECL|variable|packet_task_cache
r_static
id|kmem_cache_t
op_star
id|packet_task_cache
suffix:semicolon
DECL|variable|hl_handle
r_static
r_struct
id|hpsb_highlevel
op_star
id|hl_handle
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Card handling */
r_static
id|LIST_HEAD
(paren
id|host_info_list
)paren
suffix:semicolon
DECL|variable|host_info_lock
r_static
id|spinlock_t
id|host_info_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
multiline_comment|/* Use common.lf to determine header len */
DECL|variable|hdr_type_len
r_static
r_int
id|hdr_type_len
(braket
)braket
op_assign
(brace
r_sizeof
(paren
r_struct
id|eth1394_uf_hdr
)paren
comma
r_sizeof
(paren
r_struct
id|eth1394_ff_hdr
)paren
comma
r_sizeof
(paren
r_struct
id|eth1394_sf_hdr
)paren
comma
r_sizeof
(paren
r_struct
id|eth1394_sf_hdr
)paren
)brace
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Ben Collins (bcollins@debian.org)&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;IEEE 1394 IPv4 Driver (IPv4-over-1394 as per RFC 2734)&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
multiline_comment|/* Find our host_info struct for a given host pointer. Must be called&n; * under spinlock.  */
DECL|function|find_host_info
r_static
r_inline
r_struct
id|host_info
op_star
id|find_host_info
(paren
r_struct
id|hpsb_host
op_star
id|host
)paren
(brace
r_struct
id|list_head
op_star
id|lh
suffix:semicolon
r_struct
id|host_info
op_star
id|hi
suffix:semicolon
id|lh
op_assign
id|host_info_list.next
suffix:semicolon
r_while
c_loop
(paren
id|lh
op_ne
op_amp
id|host_info_list
)paren
(brace
id|hi
op_assign
id|list_entry
(paren
id|lh
comma
r_struct
id|host_info
comma
id|list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hi-&gt;host
op_eq
id|host
)paren
r_return
id|hi
suffix:semicolon
id|lh
op_assign
id|lh-&gt;next
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* Find the network device for our host */
DECL|function|ether1394_find_dev
r_static
r_inline
r_struct
id|net_device
op_star
id|ether1394_find_dev
(paren
r_struct
id|hpsb_host
op_star
id|host
)paren
(brace
r_struct
id|host_info
op_star
id|hi
suffix:semicolon
id|spin_lock_irq
(paren
op_amp
id|host_info_lock
)paren
suffix:semicolon
id|hi
op_assign
id|find_host_info
(paren
id|host
)paren
suffix:semicolon
id|spin_unlock_irq
(paren
op_amp
id|host_info_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hi
op_eq
l_int|NULL
)paren
r_return
l_int|NULL
suffix:semicolon
r_return
id|hi-&gt;dev
suffix:semicolon
)brace
multiline_comment|/* This is called after an &quot;ifup&quot; */
DECL|function|ether1394_open
r_static
r_int
id|ether1394_open
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|eth1394_priv
op_star
id|priv
op_assign
(paren
r_struct
id|eth1394_priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
multiline_comment|/* Set the spinlock before grabbing IRQ! */
id|priv-&gt;lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
id|netif_start_queue
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* This is called after an &quot;ifdown&quot; */
DECL|function|ether1394_stop
r_static
r_int
id|ether1394_stop
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|netif_stop_queue
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Return statistics to the caller */
DECL|function|ether1394_stats
r_static
r_struct
id|net_device_stats
op_star
id|ether1394_stats
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_return
op_amp
(paren
(paren
(paren
r_struct
id|eth1394_priv
op_star
)paren
id|dev-&gt;priv
)paren
op_member_access_from_pointer
id|stats
)paren
suffix:semicolon
)brace
multiline_comment|/* What to do if we timeout. I think a host reset is probably in order, so&n; * that&squot;s what we do. Should we increment the stat counters too?  */
DECL|function|ether1394_tx_timeout
r_static
r_void
id|ether1394_tx_timeout
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|ETH1394_PRINT
(paren
id|KERN_ERR
comma
id|dev-&gt;name
comma
l_string|&quot;Timeout, resetting host %s&bslash;n&quot;
comma
(paren
(paren
r_struct
id|eth1394_priv
op_star
)paren
(paren
id|dev-&gt;priv
)paren
)paren
op_member_access_from_pointer
id|host-&gt;driver-&gt;name
)paren
suffix:semicolon
id|highlevel_host_reset
(paren
(paren
(paren
r_struct
id|eth1394_priv
op_star
)paren
(paren
id|dev-&gt;priv
)paren
)paren
op_member_access_from_pointer
id|host
)paren
suffix:semicolon
id|netif_wake_queue
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/* We need to encapsulate the standard header with our own. We use the&n; * ethernet header&squot;s proto for our own.&n; *&n; * XXX: This is where we need to create a list of skb&squot;s for fragmented&n; * packets.  */
DECL|function|ether1394_encapsulate
r_static
r_inline
r_void
id|ether1394_encapsulate
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|proto
)paren
(brace
r_union
id|eth1394_hdr
op_star
id|hdr
op_assign
(paren
r_union
id|eth1394_hdr
op_star
)paren
id|skb_push
(paren
id|skb
comma
id|hdr_type_len
(braket
id|ETH1394_HDR_LF_UF
)braket
)paren
suffix:semicolon
id|hdr-&gt;common.lf
op_assign
id|ETH1394_HDR_LF_UF
suffix:semicolon
id|hdr-&gt;words.word1
op_assign
id|htons
c_func
(paren
id|hdr-&gt;words.word1
)paren
suffix:semicolon
id|hdr-&gt;uf.ether_type
op_assign
id|proto
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Convert a standard ARP packet to 1394 ARP. The first 8 bytes (the&n; * entire arphdr) is the same format as the ip1394 header, so they&n; * overlap. The rest needs to be munged a bit. The remainder of the&n; * arphdr is formatted based on hwaddr len and ipaddr len. We know what&n; * they&squot;ll be, so it&squot;s easy to judge.  */
DECL|function|ether1394_arp_to_1394arp
r_static
r_inline
r_void
id|ether1394_arp_to_1394arp
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|eth1394_priv
op_star
id|priv
op_assign
(paren
r_struct
id|eth1394_priv
op_star
)paren
(paren
id|dev-&gt;priv
)paren
suffix:semicolon
id|u16
id|phy_id
op_assign
id|priv-&gt;host-&gt;node_id
op_amp
id|NODE_MASK
suffix:semicolon
r_int
r_char
op_star
id|arp_ptr
op_assign
(paren
r_int
r_char
op_star
)paren
id|skb-&gt;data
suffix:semicolon
r_struct
id|eth1394_arp
op_star
id|arp1394
op_assign
(paren
r_struct
id|eth1394_arp
op_star
)paren
id|skb-&gt;data
suffix:semicolon
r_int
r_char
id|arp_data
(braket
l_int|2
op_star
(paren
id|dev-&gt;addr_len
op_plus
l_int|4
)paren
)braket
suffix:semicolon
multiline_comment|/* Copy the main data that we need */
id|arp_ptr
op_assign
id|memcpy
(paren
id|arp_data
comma
id|arp_ptr
op_plus
r_sizeof
(paren
r_struct
id|arphdr
)paren
comma
r_sizeof
(paren
id|arp_data
)paren
)paren
suffix:semicolon
multiline_comment|/* Extend the buffer enough for our new header */
id|skb_put
(paren
id|skb
comma
r_sizeof
(paren
r_struct
id|eth1394_arp
)paren
op_minus
(paren
r_sizeof
(paren
id|arp_data
)paren
op_plus
r_sizeof
(paren
r_struct
id|arphdr
)paren
)paren
)paren
suffix:semicolon
DECL|macro|PROCESS_MEMBER
mdefine_line|#define PROCESS_MEMBER(ptr,val,len) &bslash;&n;  memcpy (val, ptr, len); ptr += len
id|arp_ptr
op_add_assign
id|arp1394-&gt;hw_addr_len
suffix:semicolon
id|PROCESS_MEMBER
(paren
id|arp_ptr
comma
op_amp
id|arp1394-&gt;sip
comma
id|arp1394-&gt;ip_addr_len
)paren
suffix:semicolon
id|arp_ptr
op_add_assign
id|arp1394-&gt;hw_addr_len
suffix:semicolon
id|PROCESS_MEMBER
(paren
id|arp_ptr
comma
op_amp
id|arp1394-&gt;tip
comma
id|arp1394-&gt;ip_addr_len
)paren
suffix:semicolon
DECL|macro|PROCESS_MEMBER
macro_line|#undef PROCESS_MEMBER
multiline_comment|/* Now add our own flavor of arp header fields to the orig one */
id|arp1394-&gt;hw_addr_len
op_assign
id|IP1394_HW_ADDR_LEN
suffix:semicolon
id|arp1394-&gt;hw_type
op_assign
id|__constant_htons
(paren
id|ARPHRD_IEEE1394
)paren
suffix:semicolon
id|arp1394-&gt;s_uniq_id
op_assign
id|cpu_to_le64
(paren
id|priv-&gt;eui
(braket
id|phy_id
)braket
)paren
suffix:semicolon
id|arp1394-&gt;max_rec
op_assign
id|priv-&gt;max_rec
(braket
id|phy_id
)braket
suffix:semicolon
id|arp1394-&gt;sspd
op_assign
id|priv-&gt;sspd
(braket
id|phy_id
)braket
suffix:semicolon
id|arp1394-&gt;fifo_hi
op_assign
id|htons
(paren
id|priv-&gt;fifo_hi
(braket
id|phy_id
)braket
)paren
suffix:semicolon
id|arp1394-&gt;fifo_lo
op_assign
id|htonl
(paren
id|priv-&gt;fifo_lo
(braket
id|phy_id
)braket
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|ether1394_change_mtu
r_static
r_int
id|ether1394_change_mtu
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|new_mtu
)paren
(brace
r_if
c_cond
(paren
(paren
id|new_mtu
OL
l_int|68
)paren
op_logical_or
(paren
id|new_mtu
OG
id|ETHER1394_REGION_ADDR_LEN
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|dev-&gt;mtu
op_assign
id|new_mtu
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ether1394_register_limits
r_static
r_inline
r_void
id|ether1394_register_limits
(paren
r_int
id|nodeid
comma
r_int
r_char
id|max_rec
comma
r_int
r_char
id|sspd
comma
id|u64
id|eui
comma
id|u16
id|fifo_hi
comma
id|u32
id|fifo_lo
comma
r_struct
id|eth1394_priv
op_star
id|priv
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|nodeid
OL
l_int|0
op_logical_or
id|nodeid
op_ge
id|ALL_NODES
)paren
(brace
id|ETH1394_PRINT_G
(paren
id|KERN_ERR
comma
l_string|&quot;Cannot register invalid nodeid %d&bslash;n&quot;
comma
id|nodeid
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|priv-&gt;max_rec
(braket
id|nodeid
)braket
op_assign
id|max_rec
suffix:semicolon
id|priv-&gt;sspd
(braket
id|nodeid
)braket
op_assign
id|sspd
suffix:semicolon
id|priv-&gt;fifo_hi
(braket
id|nodeid
)braket
op_assign
id|fifo_hi
suffix:semicolon
id|priv-&gt;fifo_lo
(braket
id|nodeid
)braket
op_assign
id|fifo_lo
suffix:semicolon
id|priv-&gt;eui
(braket
id|nodeid
)braket
op_assign
id|eui
suffix:semicolon
multiline_comment|/* 63 is used for broadcasts to all hosts. It is equal to the&n;&t; * minimum of all registered nodes. A registered node is one with&n;&t; * a nonzero offset. Set the values rediculously high to start. We&n;&t; * know we have atleast one to change the default to.  */
id|sspd
op_assign
l_int|0xff
suffix:semicolon
id|max_rec
op_assign
l_int|0xff
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ALL_NODES
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|priv-&gt;fifo_hi
op_logical_and
op_logical_neg
id|priv-&gt;fifo_lo
)paren
r_continue
suffix:semicolon
multiline_comment|/* Unregistered */
r_if
c_cond
(paren
id|priv-&gt;max_rec
(braket
id|i
)braket
OL
id|max_rec
)paren
id|max_rec
op_assign
id|priv-&gt;max_rec
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;sspd
(braket
id|i
)braket
OL
id|sspd
)paren
id|sspd
op_assign
id|priv-&gt;sspd
(braket
id|i
)braket
suffix:semicolon
)brace
id|priv-&gt;max_rec
(braket
id|ALL_NODES
)braket
op_assign
id|max_rec
suffix:semicolon
id|priv-&gt;sspd
(braket
id|ALL_NODES
)braket
op_assign
id|sspd
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|ether1394_reset_priv
r_static
r_void
id|ether1394_reset_priv
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|set_mtu
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|eth1394_priv
op_star
id|priv
op_assign
(paren
r_struct
id|eth1394_priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|phy_id
op_assign
id|priv-&gt;host-&gt;node_id
op_amp
id|NODE_MASK
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Clear the speed/payload/offset tables */
id|memset
(paren
id|priv-&gt;max_rec
comma
l_int|0
comma
r_sizeof
(paren
id|priv-&gt;max_rec
)paren
)paren
suffix:semicolon
id|memset
(paren
id|priv-&gt;sspd
comma
l_int|0
comma
r_sizeof
(paren
id|priv-&gt;sspd
)paren
)paren
suffix:semicolon
id|memset
(paren
id|priv-&gt;fifo_hi
comma
l_int|0
comma
r_sizeof
(paren
id|priv-&gt;fifo_hi
)paren
)paren
suffix:semicolon
id|memset
(paren
id|priv-&gt;fifo_lo
comma
l_int|0
comma
r_sizeof
(paren
id|priv-&gt;fifo_lo
)paren
)paren
suffix:semicolon
multiline_comment|/* Register our limits now */
id|ether1394_register_limits
(paren
id|phy_id
comma
(paren
id|be32_to_cpu
c_func
(paren
id|priv-&gt;host-&gt;csr.rom
(braket
l_int|2
)braket
)paren
op_rshift
l_int|12
)paren
op_amp
l_int|0xf
comma
id|priv-&gt;host-&gt;speed_map
(braket
(paren
id|phy_id
op_lshift
l_int|6
)paren
op_plus
id|phy_id
)braket
comma
(paren
id|u64
)paren
(paren
(paren
(paren
id|u64
)paren
id|be32_to_cpu
c_func
(paren
id|priv-&gt;host-&gt;csr.rom
(braket
l_int|3
)braket
)paren
op_lshift
l_int|32
)paren
op_or
id|be32_to_cpu
c_func
(paren
id|priv-&gt;host-&gt;csr.rom
(braket
l_int|4
)braket
)paren
)paren
comma
id|ETHER1394_REGION_ADDR
op_rshift
l_int|32
comma
id|ETHER1394_REGION_ADDR
op_amp
l_int|0xffffffff
comma
id|priv
)paren
suffix:semicolon
multiline_comment|/* We&squot;ll use our max_rec as the default mtu */
r_if
c_cond
(paren
id|set_mtu
)paren
id|dev-&gt;mtu
op_assign
(paren
l_int|1
op_lshift
(paren
id|priv-&gt;max_rec
(braket
id|phy_id
)braket
op_plus
l_int|1
)paren
)paren
op_minus
r_sizeof
(paren
r_union
id|eth1394_hdr
)paren
suffix:semicolon
multiline_comment|/* Set our hardware address while we&squot;re at it */
op_star
(paren
id|nodeid_t
op_star
)paren
id|dev-&gt;dev_addr
op_assign
id|htons
(paren
id|priv-&gt;host-&gt;node_id
)paren
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_static
r_int
id|ether1394_tx
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
multiline_comment|/* This function is called by register_netdev */
DECL|function|ether1394_init_dev
r_static
r_int
id|ether1394_init_dev
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
multiline_comment|/* Our functions */
id|dev-&gt;open
op_assign
id|ether1394_open
suffix:semicolon
id|dev-&gt;stop
op_assign
id|ether1394_stop
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
id|ether1394_tx
suffix:semicolon
id|dev-&gt;get_stats
op_assign
id|ether1394_stats
suffix:semicolon
id|dev-&gt;tx_timeout
op_assign
id|ether1394_tx_timeout
suffix:semicolon
id|dev-&gt;change_mtu
op_assign
id|ether1394_change_mtu
suffix:semicolon
multiline_comment|/* Some constants */
id|dev-&gt;watchdog_timeo
op_assign
id|ETHER1394_TIMEOUT
suffix:semicolon
id|dev-&gt;flags
op_assign
id|IFF_BROADCAST
suffix:semicolon
multiline_comment|/* TODO: Support MCAP */
id|dev-&gt;features
op_assign
id|NETIF_F_NO_CSUM
op_or
id|NETIF_F_SG
op_or
id|NETIF_F_HIGHDMA
op_or
id|NETIF_F_FRAGLIST
suffix:semicolon
id|dev-&gt;addr_len
op_assign
l_int|2
suffix:semicolon
id|ether1394_reset_priv
(paren
id|dev
comma
l_int|1
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * This function is called every time a card is found. It is generally called&n; * when the module is installed. This is where we add all of our ethernet&n; * devices. One for each host.&n; */
DECL|function|ether1394_add_host
r_static
r_void
id|ether1394_add_host
(paren
r_struct
id|hpsb_host
op_star
id|host
)paren
(brace
r_struct
id|host_info
op_star
id|hi
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|eth1394_priv
op_star
id|priv
suffix:semicolon
r_static
r_int
id|version_printed
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|version_printed
op_increment
op_eq
l_int|0
)paren
id|ETH1394_PRINT_G
(paren
id|KERN_INFO
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|version
)paren
suffix:semicolon
id|dev
op_assign
id|alloc_etherdev
c_func
(paren
r_sizeof
(paren
r_struct
id|eth1394_priv
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
r_goto
id|out
suffix:semicolon
id|SET_MODULE_OWNER
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dev-&gt;init
op_assign
id|ether1394_init_dev
suffix:semicolon
id|priv
op_assign
(paren
r_struct
id|eth1394_priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
id|priv-&gt;host
op_assign
id|host
suffix:semicolon
id|hi
op_assign
(paren
r_struct
id|host_info
op_star
)paren
id|kmalloc
(paren
r_sizeof
(paren
r_struct
id|host_info
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hi
op_eq
l_int|NULL
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|register_netdev
(paren
id|dev
)paren
)paren
(brace
id|ETH1394_PRINT
(paren
id|KERN_ERR
comma
id|dev-&gt;name
comma
l_string|&quot;Error registering network driver&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
(paren
id|dev
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|ETH1394_PRINT
(paren
id|KERN_ERR
comma
id|dev-&gt;name
comma
l_string|&quot;IEEE-1394 IPv4 over 1394 Ethernet (%s)&bslash;n&quot;
comma
id|host-&gt;driver-&gt;name
)paren
suffix:semicolon
id|INIT_LIST_HEAD
(paren
op_amp
id|hi-&gt;list
)paren
suffix:semicolon
id|hi-&gt;host
op_assign
id|host
suffix:semicolon
id|hi-&gt;dev
op_assign
id|dev
suffix:semicolon
id|spin_lock_irq
(paren
op_amp
id|host_info_lock
)paren
suffix:semicolon
id|list_add_tail
(paren
op_amp
id|hi-&gt;list
comma
op_amp
id|host_info_list
)paren
suffix:semicolon
id|spin_unlock_irq
(paren
op_amp
id|host_info_lock
)paren
suffix:semicolon
r_return
suffix:semicolon
id|out
suffix:colon
r_if
c_cond
(paren
id|dev
op_ne
l_int|NULL
)paren
id|kfree
(paren
id|dev
)paren
suffix:semicolon
id|ETH1394_PRINT_G
(paren
id|KERN_ERR
comma
l_string|&quot;Out of memory&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Remove a card from our list */
DECL|function|ether1394_remove_host
r_static
r_void
id|ether1394_remove_host
(paren
r_struct
id|hpsb_host
op_star
id|host
)paren
(brace
r_struct
id|host_info
op_star
id|hi
suffix:semicolon
id|spin_lock_irq
(paren
op_amp
id|host_info_lock
)paren
suffix:semicolon
id|hi
op_assign
id|find_host_info
(paren
id|host
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hi
op_ne
l_int|NULL
)paren
(brace
id|unregister_netdev
(paren
id|hi-&gt;dev
)paren
suffix:semicolon
id|kfree
(paren
id|hi-&gt;dev
)paren
suffix:semicolon
id|list_del
(paren
op_amp
id|hi-&gt;list
)paren
suffix:semicolon
id|kfree
(paren
id|hi
)paren
suffix:semicolon
)brace
id|spin_unlock_irq
(paren
op_amp
id|host_info_lock
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* A reset has just arisen */
DECL|function|ether1394_host_reset
r_static
r_void
id|ether1394_host_reset
(paren
r_struct
id|hpsb_host
op_star
id|host
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|ether1394_find_dev
c_func
(paren
id|host
)paren
suffix:semicolon
multiline_comment|/* This can happen for hosts that we don&squot;t use */
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
multiline_comment|/* Reset our private host data, but not our mtu */
id|netif_stop_queue
(paren
id|dev
)paren
suffix:semicolon
id|ether1394_reset_priv
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
id|netif_wake_queue
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/* Copied from net/ethernet/eth.c */
DECL|function|ether1394_type_trans
r_static
r_inline
r_int
r_int
id|ether1394_type_trans
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|ethhdr
op_star
id|eth
suffix:semicolon
r_int
r_char
op_star
id|rawp
suffix:semicolon
id|skb-&gt;mac.raw
op_assign
id|skb-&gt;data
suffix:semicolon
id|skb_pull
(paren
id|skb
comma
id|ETH_HLEN
)paren
suffix:semicolon
id|eth
op_assign
id|skb-&gt;mac.ethernet
suffix:semicolon
macro_line|#if 0
r_if
c_cond
(paren
op_star
id|eth-&gt;h_dest
op_amp
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|memcmp
c_func
(paren
id|eth-&gt;h_dest
comma
id|dev-&gt;broadcast
comma
id|dev-&gt;addr_len
)paren
op_eq
l_int|0
)paren
(brace
id|skb-&gt;pkt_type
op_assign
id|PACKET_BROADCAST
suffix:semicolon
)brace
r_else
id|skb-&gt;pkt_type
op_assign
id|PACKET_MULTICAST
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|memcmp
c_func
(paren
id|eth-&gt;h_dest
comma
id|dev-&gt;dev_addr
comma
id|dev-&gt;addr_len
)paren
)paren
(brace
id|skb-&gt;pkt_type
op_assign
id|PACKET_OTHERHOST
suffix:semicolon
)brace
)brace
macro_line|#endif
r_if
c_cond
(paren
id|ntohs
(paren
id|eth-&gt;h_proto
)paren
op_ge
l_int|1536
)paren
r_return
id|eth-&gt;h_proto
suffix:semicolon
id|rawp
op_assign
id|skb-&gt;data
suffix:semicolon
r_if
c_cond
(paren
op_star
(paren
r_int
r_int
op_star
)paren
id|rawp
op_eq
l_int|0xFFFF
)paren
r_return
id|htons
(paren
id|ETH_P_802_3
)paren
suffix:semicolon
r_return
id|htons
(paren
id|ETH_P_802_2
)paren
suffix:semicolon
)brace
multiline_comment|/* Parse an encapsulated IP1394 header into an ethernet frame packet.&n; * We also perform ARP translation here, if need be.  */
DECL|function|ether1394_parse_encap
r_static
r_inline
r_int
r_int
id|ether1394_parse_encap
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
comma
id|nodeid_t
id|srcid
comma
id|nodeid_t
id|destid
)paren
(brace
r_union
id|eth1394_hdr
op_star
id|hdr
op_assign
(paren
r_union
id|eth1394_hdr
op_star
)paren
id|skb-&gt;data
suffix:semicolon
r_int
r_char
id|src_hw
(braket
id|ETH_ALEN
)braket
comma
id|dest_hw
(braket
id|ETH_ALEN
)braket
suffix:semicolon
r_int
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Setup our hw addresses. We use these to build the&n;&t; * ethernet header.  */
op_star
(paren
id|u16
op_star
)paren
id|dest_hw
op_assign
id|htons
c_func
(paren
id|destid
)paren
suffix:semicolon
op_star
(paren
id|u16
op_star
)paren
id|src_hw
op_assign
id|htons
c_func
(paren
id|srcid
)paren
suffix:semicolon
multiline_comment|/* Remove the encapsulation header */
id|hdr-&gt;words.word1
op_assign
id|ntohs
c_func
(paren
id|hdr-&gt;words.word1
)paren
suffix:semicolon
id|skb_pull
(paren
id|skb
comma
id|hdr_type_len
(braket
id|hdr-&gt;common.lf
)braket
)paren
suffix:semicolon
multiline_comment|/* If this is an ARP packet, convert it. First, we want to make&n;&t; * use of some of the fields, since they tell us a little bit&n;&t; * about the sending machine.  */
r_if
c_cond
(paren
id|hdr-&gt;uf.ether_type
op_eq
id|__constant_htons
(paren
id|ETH_P_ARP
)paren
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|u16
id|phy_id
op_assign
id|srcid
op_amp
id|NODE_MASK
suffix:semicolon
r_struct
id|eth1394_priv
op_star
id|priv
op_assign
(paren
r_struct
id|eth1394_priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_struct
id|eth1394_arp
id|arp1394
suffix:semicolon
r_struct
id|arphdr
op_star
id|arp
op_assign
(paren
r_struct
id|arphdr
op_star
)paren
id|skb-&gt;data
suffix:semicolon
r_int
r_char
op_star
id|arp_ptr
op_assign
(paren
r_int
r_char
op_star
)paren
(paren
id|arp
op_plus
l_int|1
)paren
suffix:semicolon
id|memcpy
(paren
op_amp
id|arp1394
comma
id|arp
comma
r_sizeof
(paren
r_struct
id|eth1394_arp
)paren
)paren
suffix:semicolon
multiline_comment|/* Update our speed/payload/fifo_offset table */
id|spin_lock_irqsave
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|ether1394_register_limits
(paren
id|phy_id
comma
id|arp1394.max_rec
comma
id|arp1394.sspd
comma
id|le64_to_cpu
(paren
id|arp1394.s_uniq_id
)paren
comma
id|ntohs
(paren
id|arp1394.fifo_hi
)paren
comma
id|ntohl
(paren
id|arp1394.fifo_lo
)paren
comma
id|priv
)paren
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
DECL|macro|PROCESS_MEMBER
mdefine_line|#define PROCESS_MEMBER(ptr,val,len) &bslash;&n;  ptr = memcpy (ptr, val, len) + len
id|PROCESS_MEMBER
(paren
id|arp_ptr
comma
id|src_hw
comma
id|dev-&gt;addr_len
)paren
suffix:semicolon
id|PROCESS_MEMBER
(paren
id|arp_ptr
comma
op_amp
id|arp1394.sip
comma
l_int|4
)paren
suffix:semicolon
id|PROCESS_MEMBER
(paren
id|arp_ptr
comma
id|dest_hw
comma
id|dev-&gt;addr_len
)paren
suffix:semicolon
id|PROCESS_MEMBER
(paren
id|arp_ptr
comma
op_amp
id|arp1394.tip
comma
l_int|4
)paren
suffix:semicolon
DECL|macro|PROCESS_MEMBER
macro_line|#undef PROCESS_MEMBER
id|arp-&gt;ar_hln
op_assign
id|dev-&gt;addr_len
suffix:semicolon
id|arp-&gt;ar_hrd
op_assign
id|__constant_htons
(paren
id|ARPHRD_ETHER
)paren
suffix:semicolon
id|skb_trim
(paren
id|skb
comma
r_sizeof
(paren
r_struct
id|arphdr
)paren
op_plus
l_int|2
op_star
(paren
id|dev-&gt;addr_len
op_plus
l_int|4
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Now add the ethernet header. */
r_if
c_cond
(paren
id|dev-&gt;hard_header
(paren
id|skb
comma
id|dev
comma
id|__constant_ntohs
(paren
id|hdr-&gt;uf.ether_type
)paren
comma
id|dest_hw
comma
id|src_hw
comma
id|skb-&gt;len
)paren
op_ge
l_int|0
)paren
id|ret
op_assign
id|ether1394_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* Packet reception. We convert the IP1394 encapsulation header to an&n; * ethernet header, and fill it with some of our other fields. This is&n; * an incoming packet from the 1394 bus.  */
DECL|function|ether1394_write
r_static
r_int
id|ether1394_write
(paren
r_struct
id|hpsb_host
op_star
id|host
comma
r_int
id|srcid
comma
r_int
id|destid
comma
id|quadlet_t
op_star
id|data
comma
id|u64
id|addr
comma
r_int
r_int
id|len
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_char
op_star
id|buf
op_assign
(paren
r_char
op_star
)paren
id|data
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
id|ether1394_find_dev
(paren
id|host
)paren
suffix:semicolon
r_struct
id|eth1394_priv
op_star
id|priv
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
(brace
id|ETH1394_PRINT_G
(paren
id|KERN_ERR
comma
l_string|&quot;Could not find net device for host %p&bslash;n&quot;
comma
id|host
)paren
suffix:semicolon
r_return
id|RCODE_ADDRESS_ERROR
suffix:semicolon
)brace
id|priv
op_assign
(paren
r_struct
id|eth1394_priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
multiline_comment|/* A packet has been received by the ieee1394 bus. Build an skbuff&n;&t; * around it so we can pass it to the high level network layer. */
id|skb
op_assign
id|dev_alloc_skb
(paren
id|len
op_plus
id|dev-&gt;hard_header_len
op_plus
l_int|15
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
(brace
id|HPSB_PRINT
(paren
id|KERN_ERR
comma
l_string|&quot;ether1394 rx: low on mem&bslash;n&quot;
)paren
suffix:semicolon
id|priv-&gt;stats.rx_dropped
op_increment
suffix:semicolon
r_return
id|RCODE_ADDRESS_ERROR
suffix:semicolon
)brace
id|skb_reserve
c_func
(paren
id|skb
comma
(paren
id|dev-&gt;hard_header_len
op_plus
l_int|15
)paren
op_amp
op_complement
l_int|15
)paren
suffix:semicolon
id|memcpy
(paren
id|skb_put
(paren
id|skb
comma
id|len
)paren
comma
id|buf
comma
id|len
)paren
suffix:semicolon
multiline_comment|/* Write metadata, and then pass to the receive level */
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb-&gt;ip_summed
op_assign
id|CHECKSUM_UNNECESSARY
suffix:semicolon
multiline_comment|/* don&squot;t check it */
multiline_comment|/* Parse the encapsulation header. This actually does the job of&n;&t; * converting to an ethernet frame header, aswell as arp&n;&t; * conversion if needed. ARP conversion is easier in this&n;&t; * direction, since we are using ethernet as our backend.  */
id|skb-&gt;protocol
op_assign
id|ether1394_parse_encap
(paren
id|skb
comma
id|dev
comma
id|srcid
comma
id|destid
)paren
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb-&gt;protocol
)paren
(brace
id|priv-&gt;stats.rx_errors
op_increment
suffix:semicolon
id|priv-&gt;stats.rx_dropped
op_increment
suffix:semicolon
id|dev_kfree_skb_any
c_func
(paren
id|skb
)paren
suffix:semicolon
r_goto
id|bad_proto
suffix:semicolon
)brace
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|netif_rx
(paren
id|skb
)paren
op_eq
id|NET_RX_DROP
)paren
(brace
id|priv-&gt;stats.rx_errors
op_increment
suffix:semicolon
id|priv-&gt;stats.rx_dropped
op_increment
suffix:semicolon
r_goto
id|bad_proto
suffix:semicolon
)brace
multiline_comment|/* Statistics */
id|priv-&gt;stats.rx_packets
op_increment
suffix:semicolon
id|priv-&gt;stats.rx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
id|bad_proto
suffix:colon
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|dev-&gt;last_rx
op_assign
id|jiffies
suffix:semicolon
r_return
id|RCODE_COMPLETE
suffix:semicolon
)brace
multiline_comment|/* This function is our scheduled write */
DECL|function|hpsb_write_sched
r_static
r_void
id|hpsb_write_sched
(paren
r_void
op_star
id|__ptask
)paren
(brace
r_struct
id|packet_task
op_star
id|ptask
op_assign
(paren
r_struct
id|packet_task
op_star
)paren
id|__ptask
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
op_assign
id|ptask-&gt;skb
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
id|ptask-&gt;skb-&gt;dev
suffix:semicolon
r_struct
id|eth1394_priv
op_star
id|priv
op_assign
(paren
r_struct
id|eth1394_priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/* Statistics */
id|spin_lock_irqsave
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hpsb_write
c_func
(paren
id|priv-&gt;host
comma
id|ptask-&gt;dest_node
comma
id|get_hpsb_generation
c_func
(paren
id|priv-&gt;host
)paren
comma
id|ptask-&gt;addr
comma
(paren
id|quadlet_t
op_star
)paren
id|skb-&gt;data
comma
id|skb-&gt;len
)paren
)paren
(brace
id|priv-&gt;stats.tx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
id|priv-&gt;stats.tx_packets
op_increment
suffix:semicolon
)brace
r_else
(brace
singleline_comment|//printk(&quot;Failed in hpsb_write_sched&bslash;n&quot;);
id|priv-&gt;stats.tx_dropped
op_increment
suffix:semicolon
id|priv-&gt;stats.tx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|netif_queue_stopped
(paren
id|dev
)paren
)paren
id|netif_wake_queue
(paren
id|dev
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|kmem_cache_free
c_func
(paren
id|packet_task_cache
comma
id|ptask
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Transmit a packet (called by kernel) */
DECL|function|ether1394_tx
r_static
r_int
id|ether1394_tx
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|kmflags
op_assign
id|in_interrupt
(paren
)paren
ques
c_cond
id|GFP_ATOMIC
suffix:colon
id|GFP_KERNEL
suffix:semicolon
r_struct
id|ethhdr
op_star
id|eth
suffix:semicolon
r_struct
id|eth1394_priv
op_star
id|priv
op_assign
(paren
r_struct
id|eth1394_priv
op_star
)paren
id|dev-&gt;priv
suffix:semicolon
r_int
id|proto
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|nodeid_t
id|dest_node
suffix:semicolon
id|u64
id|addr
suffix:semicolon
r_struct
id|packet_task
op_star
id|ptask
op_assign
l_int|NULL
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|skb
op_assign
id|skb_share_check
(paren
id|skb
comma
id|kmflags
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|fail
suffix:semicolon
)brace
multiline_comment|/* Get rid of the ethernet header, but save a pointer */
id|eth
op_assign
(paren
r_struct
id|ethhdr
op_star
)paren
id|skb-&gt;data
suffix:semicolon
id|skb_pull
(paren
id|skb
comma
id|ETH_HLEN
)paren
suffix:semicolon
multiline_comment|/* Save the destination id, and proto for our encapsulation, then&n;&t; * toss the ethernet header aside like the cheap whore it is.  */
id|dest_node
op_assign
id|ntohs
(paren
op_star
(paren
id|nodeid_t
op_star
)paren
(paren
id|eth-&gt;h_dest
)paren
)paren
suffix:semicolon
id|proto
op_assign
id|eth-&gt;h_proto
suffix:semicolon
multiline_comment|/* If this is an ARP packet, convert it */
r_if
c_cond
(paren
id|proto
op_eq
id|__constant_htons
(paren
id|ETH_P_ARP
)paren
)paren
id|ether1394_arp_to_1394arp
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
multiline_comment|/* Now add our encapsulation header */
id|ether1394_encapsulate
(paren
id|skb
comma
id|dev
comma
id|proto
)paren
suffix:semicolon
multiline_comment|/* TODO: The above encapsulate function needs to recognize when a&n;&t; * packet needs to be split for a specified node. It should create&n;&t; * a list of skb&squot;s that we could then iterate over for the below&n;&t; * call to schedule our writes.  */
multiline_comment|/* XXX: Right now we accept that we don&squot;t exactly follow RFC. When&n;&t; * we do, we will send ARP requests via GASP format, and so we wont&n;&t; * need this hack.  */
id|spin_lock_irqsave
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|addr
op_assign
(paren
id|u64
)paren
id|priv-&gt;fifo_hi
(braket
id|dest_node
op_amp
id|NODE_MASK
)braket
op_lshift
l_int|32
op_or
id|priv-&gt;fifo_lo
(braket
id|dest_node
op_amp
id|NODE_MASK
)braket
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|addr
)paren
id|addr
op_assign
id|ETHER1394_REGION_ADDR
suffix:semicolon
id|ptask
op_assign
id|kmem_cache_alloc
c_func
(paren
id|packet_task_cache
comma
id|kmflags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ptask
op_eq
l_int|NULL
)paren
(brace
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|fail
suffix:semicolon
)brace
id|ptask-&gt;skb
op_assign
id|skb
suffix:semicolon
id|ptask-&gt;addr
op_assign
id|addr
suffix:semicolon
id|ptask-&gt;dest_node
op_assign
id|dest_node
suffix:semicolon
id|INIT_TQUEUE
c_func
(paren
op_amp
id|ptask-&gt;tq
comma
id|hpsb_write_sched
comma
id|ptask
)paren
suffix:semicolon
id|schedule_task
c_func
(paren
op_amp
id|ptask-&gt;tq
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|fail
suffix:colon
id|printk
c_func
(paren
l_string|&quot;Failed in ether1394_tx&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_ne
l_int|NULL
)paren
id|dev_kfree_skb
(paren
id|skb
)paren
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|priv-&gt;stats.tx_dropped
op_increment
suffix:semicolon
id|priv-&gt;stats.tx_errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|netif_queue_stopped
(paren
id|dev
)paren
)paren
id|netif_wake_queue
(paren
id|dev
)paren
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* Function for incoming 1394 packets */
DECL|variable|addr_ops
r_static
r_struct
id|hpsb_address_ops
id|addr_ops
op_assign
(brace
dot
id|write
op_assign
id|ether1394_write
comma
)brace
suffix:semicolon
multiline_comment|/* Ieee1394 highlevel driver functions */
DECL|variable|hl_ops
r_static
r_struct
id|hpsb_highlevel_ops
id|hl_ops
op_assign
(brace
dot
id|add_host
op_assign
id|ether1394_add_host
comma
dot
id|remove_host
op_assign
id|ether1394_remove_host
comma
dot
id|host_reset
op_assign
id|ether1394_host_reset
comma
)brace
suffix:semicolon
DECL|function|ether1394_init_module
r_static
r_int
id|__init
id|ether1394_init_module
(paren
r_void
)paren
(brace
id|packet_task_cache
op_assign
id|kmem_cache_create
c_func
(paren
l_string|&quot;packet_task&quot;
comma
r_sizeof
(paren
r_struct
id|packet_task
)paren
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/* Register ourselves as a highlevel driver */
id|hl_handle
op_assign
id|hpsb_register_highlevel
(paren
id|ETHER1394_DRIVER_NAME
comma
op_amp
id|hl_ops
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hl_handle
op_eq
l_int|NULL
)paren
(brace
id|ETH1394_PRINT_G
(paren
id|KERN_ERR
comma
l_string|&quot;No more memory for driver&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|hpsb_register_addrspace
(paren
id|hl_handle
comma
op_amp
id|addr_ops
comma
id|ETHER1394_REGION_ADDR
comma
id|ETHER1394_REGION_ADDR_END
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ether1394_exit_module
r_static
r_void
id|__exit
id|ether1394_exit_module
(paren
r_void
)paren
(brace
id|hpsb_unregister_highlevel
(paren
id|hl_handle
)paren
suffix:semicolon
id|kmem_cache_destroy
c_func
(paren
id|packet_task_cache
)paren
suffix:semicolon
)brace
DECL|variable|ether1394_init_module
id|module_init
c_func
(paren
id|ether1394_init_module
)paren
suffix:semicolon
DECL|variable|ether1394_exit_module
id|module_exit
c_func
(paren
id|ether1394_exit_module
)paren
suffix:semicolon
eof
