multiline_comment|/*&n; * eth1394.c -- Ethernet driver for Linux IEEE-1394 Subsystem&n; *&n; * Copyright (C) 2001-2003 Ben Collins &lt;bcollins@debian.org&gt;&n; *               2000 Bonin Franck &lt;boninf@free.fr&gt;&n; *               2003 Steve Kinneberg &lt;kinnebergsteve@acmsystems.com&gt;&n; *&n; * Mainly based on work by Emanuel Pirker and Andreas E. Bombe&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or&n; * (at your option) any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software Foundation,&n; * Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.&n; */
multiline_comment|/* This driver intends to support RFC 2734, which describes a method for&n; * transporting IPv4 datagrams over IEEE-1394 serial busses. This driver&n; * will ultimately support that method, but currently falls short in&n; * several areas.&n; *&n; * TODO:&n; * RFC 2734 related:&n; * - Add MCAP. Limited Multicast exists only to 224.0.0.1 and 224.0.0.2.&n; *&n; * Non-RFC 2734 related:&n; * - Handle fragmented skb&squot;s coming from the networking layer.&n; * - Move generic GASP reception to core 1394 code&n; * - Convert kmalloc/kfree for link fragments to use kmem_cache_* instead&n; * - Stability improvements&n; * - Performance enhancements&n; * - Consider garbage collecting old partial datagrams after X amount of time&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/inetdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/if_arp.h&gt;
macro_line|#include &lt;linux/if_ether.h&gt;
macro_line|#include &lt;linux/ip.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/tcp.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/bitops.h&gt;
macro_line|#include &lt;linux/ethtool.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/delay.h&gt;
macro_line|#include &lt;asm/semaphore.h&gt;
macro_line|#include &lt;net/arp.h&gt;
macro_line|#include &quot;csr1212.h&quot;
macro_line|#include &quot;ieee1394_types.h&quot;
macro_line|#include &quot;ieee1394_core.h&quot;
macro_line|#include &quot;ieee1394_transactions.h&quot;
macro_line|#include &quot;ieee1394.h&quot;
macro_line|#include &quot;highlevel.h&quot;
macro_line|#include &quot;iso.h&quot;
macro_line|#include &quot;nodemgr.h&quot;
macro_line|#include &quot;eth1394.h&quot;
macro_line|#include &quot;config_roms.h&quot;
DECL|macro|ETH1394_PRINT_G
mdefine_line|#define ETH1394_PRINT_G(level, fmt, args...) &bslash;&n;&t;printk(level &quot;%s: &quot; fmt, driver_name, ## args)
DECL|macro|ETH1394_PRINT
mdefine_line|#define ETH1394_PRINT(level, dev_name, fmt, args...) &bslash;&n;&t;printk(level &quot;%s: %s: &quot; fmt, driver_name, dev_name, ## args)
DECL|macro|DEBUG
mdefine_line|#define DEBUG(fmt, args...) &bslash;&n;&t;printk(KERN_ERR &quot;%s:%s[%d]: &quot; fmt &quot;&bslash;n&quot;, driver_name, __FUNCTION__, __LINE__, ## args)
DECL|macro|TRACE
mdefine_line|#define TRACE() printk(KERN_ERR &quot;%s:%s[%d] ---- TRACE&bslash;n&quot;, driver_name, __FUNCTION__, __LINE__)
DECL|variable|__devinitdata
r_static
r_char
id|version
(braket
)braket
id|__devinitdata
op_assign
l_string|&quot;$Rev: 1224 $ Ben Collins &lt;bcollins@debian.org&gt;&quot;
suffix:semicolon
DECL|struct|fragment_info
r_struct
id|fragment_info
(brace
DECL|member|list
r_struct
id|list_head
id|list
suffix:semicolon
DECL|member|offset
r_int
id|offset
suffix:semicolon
DECL|member|len
r_int
id|len
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|partial_datagram
r_struct
id|partial_datagram
(brace
DECL|member|list
r_struct
id|list_head
id|list
suffix:semicolon
DECL|member|dgl
id|u16
id|dgl
suffix:semicolon
DECL|member|dg_size
id|u16
id|dg_size
suffix:semicolon
DECL|member|ether_type
id|u16
id|ether_type
suffix:semicolon
DECL|member|skb
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
DECL|member|pbuf
r_char
op_star
id|pbuf
suffix:semicolon
DECL|member|frag_info
r_struct
id|list_head
id|frag_info
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|pdg_list
r_struct
id|pdg_list
(brace
DECL|member|list
r_struct
id|list_head
id|list
suffix:semicolon
multiline_comment|/* partial datagram list per node&t;*/
DECL|member|sz
r_int
r_int
id|sz
suffix:semicolon
multiline_comment|/* partial datagram list size per node&t;*/
DECL|member|lock
id|spinlock_t
id|lock
suffix:semicolon
multiline_comment|/* partial datagram lock&t;&t;*/
)brace
suffix:semicolon
DECL|struct|eth1394_host_info
r_struct
id|eth1394_host_info
(brace
DECL|member|host
r_struct
id|hpsb_host
op_star
id|host
suffix:semicolon
DECL|member|dev
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|eth1394_node_ref
r_struct
id|eth1394_node_ref
(brace
DECL|member|ud
r_struct
id|unit_directory
op_star
id|ud
suffix:semicolon
DECL|member|list
r_struct
id|list_head
id|list
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|eth1394_node_info
r_struct
id|eth1394_node_info
(brace
DECL|member|maxpayload
id|u16
id|maxpayload
suffix:semicolon
multiline_comment|/* Max payload&t;&t;&t;*/
DECL|member|sspd
id|u8
id|sspd
suffix:semicolon
multiline_comment|/* Max speed&t;&t;&t;*/
DECL|member|fifo
id|u64
id|fifo
suffix:semicolon
multiline_comment|/* FIFO address&t;&t;&t;*/
DECL|member|pdg
r_struct
id|pdg_list
id|pdg
suffix:semicolon
multiline_comment|/* partial RX datagram lists&t;*/
DECL|member|dgl
r_int
id|dgl
suffix:semicolon
multiline_comment|/* Outgoing datagram label&t;*/
)brace
suffix:semicolon
multiline_comment|/* Our ieee1394 highlevel driver */
DECL|macro|ETH1394_DRIVER_NAME
mdefine_line|#define ETH1394_DRIVER_NAME &quot;eth1394&quot;
DECL|variable|driver_name
r_static
r_const
r_char
id|driver_name
(braket
)braket
op_assign
id|ETH1394_DRIVER_NAME
suffix:semicolon
DECL|variable|packet_task_cache
r_static
id|kmem_cache_t
op_star
id|packet_task_cache
suffix:semicolon
DECL|variable|eth1394_highlevel
r_static
r_struct
id|hpsb_highlevel
id|eth1394_highlevel
suffix:semicolon
multiline_comment|/* Use common.lf to determine header len */
DECL|variable|hdr_type_len
r_static
r_const
r_int
id|hdr_type_len
(braket
)braket
op_assign
(brace
r_sizeof
(paren
r_struct
id|eth1394_uf_hdr
)paren
comma
r_sizeof
(paren
r_struct
id|eth1394_ff_hdr
)paren
comma
r_sizeof
(paren
r_struct
id|eth1394_sf_hdr
)paren
comma
r_sizeof
(paren
r_struct
id|eth1394_sf_hdr
)paren
)brace
suffix:semicolon
multiline_comment|/* Change this to IEEE1394_SPEED_S100 to make testing easier */
DECL|macro|ETH1394_SPEED_DEF
mdefine_line|#define ETH1394_SPEED_DEF&t;IEEE1394_SPEED_MAX
multiline_comment|/* For now, this needs to be 1500, so that XP works with us */
DECL|macro|ETH1394_DATA_LEN
mdefine_line|#define ETH1394_DATA_LEN&t;ETH_DATA_LEN
DECL|variable|eth1394_speedto_maxpayload
r_static
r_const
id|u16
id|eth1394_speedto_maxpayload
(braket
)braket
op_assign
(brace
multiline_comment|/*     S100, S200, S400, S800, S1600, S3200 */
l_int|512
comma
l_int|1024
comma
l_int|2048
comma
l_int|4096
comma
l_int|4096
comma
l_int|4096
)brace
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Ben Collins (bcollins@debian.org)&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;IEEE 1394 IPv4 Driver (IPv4-over-1394 as per RFC 2734)&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
multiline_comment|/* The max_partial_datagrams parameter is the maximum number of fragmented&n; * datagrams per node that eth1394 will keep in memory.  Providing an upper&n; * bound allows us to limit the amount of memory that partial datagrams&n; * consume in the event that some partial datagrams are never completed.  This&n; * should probably change to a sysctl item or the like if possible.&n; */
DECL|variable|max_partial_datagrams
r_static
r_int
id|max_partial_datagrams
op_assign
l_int|25
suffix:semicolon
id|module_param
c_func
(paren
id|max_partial_datagrams
comma
r_int
comma
id|S_IRUGO
op_or
id|S_IWUSR
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|max_partial_datagrams
comma
l_string|&quot;Maximum number of partially received fragmented datagrams &quot;
l_string|&quot;(default = 25).&quot;
)paren
suffix:semicolon
r_static
r_int
id|ether1394_header
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
comma
r_int
r_int
id|type
comma
r_void
op_star
id|daddr
comma
r_void
op_star
id|saddr
comma
r_int
id|len
)paren
suffix:semicolon
r_static
r_int
id|ether1394_rebuild_header
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
suffix:semicolon
r_static
r_int
id|ether1394_header_parse
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_int
r_char
op_star
id|haddr
)paren
suffix:semicolon
r_static
r_int
id|ether1394_header_cache
c_func
(paren
r_struct
id|neighbour
op_star
id|neigh
comma
r_struct
id|hh_cache
op_star
id|hh
)paren
suffix:semicolon
r_static
r_void
id|ether1394_header_cache_update
c_func
(paren
r_struct
id|hh_cache
op_star
id|hh
comma
r_struct
id|net_device
op_star
id|dev
comma
r_int
r_char
op_star
id|haddr
)paren
suffix:semicolon
r_static
r_int
id|ether1394_mac_addr
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_void
op_star
id|p
)paren
suffix:semicolon
r_static
r_inline
r_void
id|purge_partial_datagram
c_func
(paren
r_struct
id|list_head
op_star
id|old
)paren
suffix:semicolon
r_static
r_int
id|ether1394_tx
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|ether1394_iso
c_func
(paren
r_struct
id|hpsb_iso
op_star
id|iso
)paren
suffix:semicolon
DECL|variable|ethtool_ops
r_static
r_struct
id|ethtool_ops
id|ethtool_ops
suffix:semicolon
r_static
r_int
id|ether1394_write
c_func
(paren
r_struct
id|hpsb_host
op_star
id|host
comma
r_int
id|srcid
comma
r_int
id|destid
comma
id|quadlet_t
op_star
id|data
comma
id|u64
id|addr
comma
r_int
id|len
comma
id|u16
id|flags
)paren
suffix:semicolon
r_static
r_void
id|ether1394_add_host
(paren
r_struct
id|hpsb_host
op_star
id|host
)paren
suffix:semicolon
r_static
r_void
id|ether1394_remove_host
(paren
r_struct
id|hpsb_host
op_star
id|host
)paren
suffix:semicolon
r_static
r_void
id|ether1394_host_reset
(paren
r_struct
id|hpsb_host
op_star
id|host
)paren
suffix:semicolon
multiline_comment|/* Function for incoming 1394 packets */
DECL|variable|addr_ops
r_static
r_struct
id|hpsb_address_ops
id|addr_ops
op_assign
(brace
dot
id|write
op_assign
id|ether1394_write
comma
)brace
suffix:semicolon
multiline_comment|/* Ieee1394 highlevel driver functions */
DECL|variable|eth1394_highlevel
r_static
r_struct
id|hpsb_highlevel
id|eth1394_highlevel
op_assign
(brace
dot
id|name
op_assign
id|driver_name
comma
dot
id|add_host
op_assign
id|ether1394_add_host
comma
dot
id|remove_host
op_assign
id|ether1394_remove_host
comma
dot
id|host_reset
op_assign
id|ether1394_host_reset
comma
)brace
suffix:semicolon
multiline_comment|/* This is called after an &quot;ifup&quot; */
DECL|function|ether1394_open
r_static
r_int
id|ether1394_open
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|eth1394_priv
op_star
id|priv
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Something bad happened, don&squot;t even try */
r_if
c_cond
(paren
id|priv-&gt;bc_state
op_eq
id|ETHER1394_BC_ERROR
)paren
(brace
multiline_comment|/* we&squot;ll try again */
id|priv-&gt;iso
op_assign
id|hpsb_iso_recv_init
c_func
(paren
id|priv-&gt;host
comma
id|ETHER1394_GASP_BUFFERS
op_star
l_int|2
op_star
(paren
l_int|1
op_lshift
(paren
id|priv-&gt;host-&gt;csr.max_rec
op_plus
l_int|1
)paren
)paren
comma
id|ETHER1394_GASP_BUFFERS
comma
id|priv-&gt;broadcast_channel
comma
id|HPSB_ISO_DMA_PACKET_PER_BUFFER
comma
l_int|1
comma
id|ether1394_iso
)paren
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;iso
op_eq
l_int|NULL
)paren
(brace
id|ETH1394_PRINT
c_func
(paren
id|KERN_ERR
comma
id|dev-&gt;name
comma
l_string|&quot;Could not allocate isochronous receive &quot;
l_string|&quot;context for the broadcast channel&bslash;n&quot;
)paren
suffix:semicolon
id|priv-&gt;bc_state
op_assign
id|ETHER1394_BC_ERROR
suffix:semicolon
id|ret
op_assign
op_minus
id|EAGAIN
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|hpsb_iso_recv_start
c_func
(paren
id|priv-&gt;iso
comma
op_minus
l_int|1
comma
(paren
l_int|1
op_lshift
l_int|3
)paren
comma
op_minus
l_int|1
)paren
OL
l_int|0
)paren
id|priv-&gt;bc_state
op_assign
id|ETHER1394_BC_STOPPED
suffix:semicolon
r_else
id|priv-&gt;bc_state
op_assign
id|ETHER1394_BC_RUNNING
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|ret
)paren
r_return
id|ret
suffix:semicolon
id|netif_start_queue
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* This is called after an &quot;ifdown&quot; */
DECL|function|ether1394_stop
r_static
r_int
id|ether1394_stop
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|netif_stop_queue
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Return statistics to the caller */
DECL|function|ether1394_stats
r_static
r_struct
id|net_device_stats
op_star
id|ether1394_stats
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_return
op_amp
(paren
(paren
(paren
r_struct
id|eth1394_priv
op_star
)paren
id|netdev_priv
c_func
(paren
id|dev
)paren
)paren
op_member_access_from_pointer
id|stats
)paren
suffix:semicolon
)brace
multiline_comment|/* What to do if we timeout. I think a host reset is probably in order, so&n; * that&squot;s what we do. Should we increment the stat counters too?  */
DECL|function|ether1394_tx_timeout
r_static
r_void
id|ether1394_tx_timeout
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|ETH1394_PRINT
(paren
id|KERN_ERR
comma
id|dev-&gt;name
comma
l_string|&quot;Timeout, resetting host %s&bslash;n&quot;
comma
(paren
(paren
r_struct
id|eth1394_priv
op_star
)paren
id|netdev_priv
c_func
(paren
id|dev
)paren
)paren
op_member_access_from_pointer
id|host-&gt;driver-&gt;name
)paren
suffix:semicolon
id|highlevel_host_reset
(paren
(paren
(paren
r_struct
id|eth1394_priv
op_star
)paren
id|netdev_priv
c_func
(paren
id|dev
)paren
)paren
op_member_access_from_pointer
id|host
)paren
suffix:semicolon
id|netif_wake_queue
(paren
id|dev
)paren
suffix:semicolon
)brace
DECL|function|ether1394_change_mtu
r_static
r_int
id|ether1394_change_mtu
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|new_mtu
)paren
(brace
r_struct
id|eth1394_priv
op_star
id|priv
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|new_mtu
OL
l_int|68
)paren
op_logical_or
(paren
id|new_mtu
OG
id|min
c_func
(paren
id|ETH1394_DATA_LEN
comma
(paren
r_int
)paren
(paren
(paren
l_int|1
op_lshift
(paren
id|priv-&gt;host-&gt;csr.max_rec
op_plus
l_int|1
)paren
)paren
op_minus
(paren
r_sizeof
(paren
r_union
id|eth1394_hdr
)paren
op_plus
id|ETHER1394_GASP_OVERHEAD
)paren
)paren
)paren
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|dev-&gt;mtu
op_assign
id|new_mtu
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|purge_partial_datagram
r_static
r_inline
r_void
id|purge_partial_datagram
c_func
(paren
r_struct
id|list_head
op_star
id|old
)paren
(brace
r_struct
id|partial_datagram
op_star
id|pd
op_assign
id|list_entry
c_func
(paren
id|old
comma
r_struct
id|partial_datagram
comma
id|list
)paren
suffix:semicolon
r_struct
id|list_head
op_star
id|lh
comma
op_star
id|n
suffix:semicolon
id|list_for_each_safe
c_func
(paren
id|lh
comma
id|n
comma
op_amp
id|pd-&gt;frag_info
)paren
(brace
r_struct
id|fragment_info
op_star
id|fi
op_assign
id|list_entry
c_func
(paren
id|lh
comma
r_struct
id|fragment_info
comma
id|list
)paren
suffix:semicolon
id|list_del
c_func
(paren
id|lh
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|fi
)paren
suffix:semicolon
)brace
id|list_del
c_func
(paren
id|old
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|pd-&gt;skb
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|pd
)paren
suffix:semicolon
)brace
multiline_comment|/******************************************&n; * 1394 bus activity functions&n; ******************************************/
DECL|function|eth1394_find_node
r_static
r_struct
id|eth1394_node_ref
op_star
id|eth1394_find_node
c_func
(paren
r_struct
id|list_head
op_star
id|inl
comma
r_struct
id|unit_directory
op_star
id|ud
)paren
(brace
r_struct
id|eth1394_node_ref
op_star
id|node
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|node
comma
id|inl
comma
id|list
)paren
r_if
c_cond
(paren
id|node-&gt;ud
op_eq
id|ud
)paren
r_return
id|node
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|eth1394_find_node_guid
r_static
r_struct
id|eth1394_node_ref
op_star
id|eth1394_find_node_guid
c_func
(paren
r_struct
id|list_head
op_star
id|inl
comma
id|u64
id|guid
)paren
(brace
r_struct
id|eth1394_node_ref
op_star
id|node
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|node
comma
id|inl
comma
id|list
)paren
r_if
c_cond
(paren
id|node-&gt;ud-&gt;ne-&gt;guid
op_eq
id|guid
)paren
r_return
id|node
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|eth1394_find_node_nodeid
r_static
r_struct
id|eth1394_node_ref
op_star
id|eth1394_find_node_nodeid
c_func
(paren
r_struct
id|list_head
op_star
id|inl
comma
id|nodeid_t
id|nodeid
)paren
(brace
r_struct
id|eth1394_node_ref
op_star
id|node
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|node
comma
id|inl
comma
id|list
)paren
(brace
r_if
c_cond
(paren
id|node-&gt;ud-&gt;ne-&gt;nodeid
op_eq
id|nodeid
)paren
r_return
id|node
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|eth1394_probe
r_static
r_int
id|eth1394_probe
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|unit_directory
op_star
id|ud
suffix:semicolon
r_struct
id|eth1394_host_info
op_star
id|hi
suffix:semicolon
r_struct
id|eth1394_priv
op_star
id|priv
suffix:semicolon
r_struct
id|eth1394_node_ref
op_star
id|new_node
suffix:semicolon
r_struct
id|eth1394_node_info
op_star
id|node_info
suffix:semicolon
id|ud
op_assign
id|container_of
c_func
(paren
id|dev
comma
r_struct
id|unit_directory
comma
id|device
)paren
suffix:semicolon
id|hi
op_assign
id|hpsb_get_hostinfo
c_func
(paren
op_amp
id|eth1394_highlevel
comma
id|ud-&gt;ne-&gt;host
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hi
)paren
r_return
op_minus
id|ENOENT
suffix:semicolon
id|new_node
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|eth1394_node_ref
)paren
comma
id|in_interrupt
c_func
(paren
)paren
ques
c_cond
id|GFP_ATOMIC
suffix:colon
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|new_node
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|node_info
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|eth1394_node_info
)paren
comma
id|in_interrupt
c_func
(paren
)paren
ques
c_cond
id|GFP_ATOMIC
suffix:colon
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|node_info
)paren
(brace
id|kfree
c_func
(paren
id|new_node
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|spin_lock_init
c_func
(paren
op_amp
id|node_info-&gt;pdg.lock
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|node_info-&gt;pdg.list
)paren
suffix:semicolon
id|node_info-&gt;pdg.sz
op_assign
l_int|0
suffix:semicolon
id|node_info-&gt;fifo
op_assign
id|ETHER1394_INVALID_ADDR
suffix:semicolon
id|ud-&gt;device.driver_data
op_assign
id|node_info
suffix:semicolon
id|new_node-&gt;ud
op_assign
id|ud
suffix:semicolon
id|priv
op_assign
id|netdev_priv
c_func
(paren
id|hi-&gt;dev
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|new_node-&gt;list
comma
op_amp
id|priv-&gt;ip_node_list
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|eth1394_remove
r_static
r_int
id|eth1394_remove
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|unit_directory
op_star
id|ud
suffix:semicolon
r_struct
id|eth1394_host_info
op_star
id|hi
suffix:semicolon
r_struct
id|eth1394_priv
op_star
id|priv
suffix:semicolon
r_struct
id|eth1394_node_ref
op_star
id|old_node
suffix:semicolon
r_struct
id|eth1394_node_info
op_star
id|node_info
suffix:semicolon
r_struct
id|list_head
op_star
id|lh
comma
op_star
id|n
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|ud
op_assign
id|container_of
c_func
(paren
id|dev
comma
r_struct
id|unit_directory
comma
id|device
)paren
suffix:semicolon
id|hi
op_assign
id|hpsb_get_hostinfo
c_func
(paren
op_amp
id|eth1394_highlevel
comma
id|ud-&gt;ne-&gt;host
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hi
)paren
r_return
op_minus
id|ENOENT
suffix:semicolon
id|priv
op_assign
id|netdev_priv
c_func
(paren
id|hi-&gt;dev
)paren
suffix:semicolon
id|old_node
op_assign
id|eth1394_find_node
c_func
(paren
op_amp
id|priv-&gt;ip_node_list
comma
id|ud
)paren
suffix:semicolon
r_if
c_cond
(paren
id|old_node
)paren
(brace
id|list_del
c_func
(paren
op_amp
id|old_node-&gt;list
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|old_node
)paren
suffix:semicolon
id|node_info
op_assign
(paren
r_struct
id|eth1394_node_info
op_star
)paren
id|ud-&gt;device.driver_data
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|node_info-&gt;pdg.lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* The partial datagram list should be empty, but we&squot;ll just&n;&t;&t; * make sure anyway... */
id|list_for_each_safe
c_func
(paren
id|lh
comma
id|n
comma
op_amp
id|node_info-&gt;pdg.list
)paren
(brace
id|purge_partial_datagram
c_func
(paren
id|lh
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|node_info-&gt;pdg.lock
comma
id|flags
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|node_info
)paren
suffix:semicolon
id|ud-&gt;device.driver_data
op_assign
l_int|NULL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|eth1394_update
r_static
r_int
id|eth1394_update
c_func
(paren
r_struct
id|unit_directory
op_star
id|ud
)paren
(brace
r_struct
id|eth1394_host_info
op_star
id|hi
suffix:semicolon
r_struct
id|eth1394_priv
op_star
id|priv
suffix:semicolon
r_struct
id|eth1394_node_ref
op_star
id|node
suffix:semicolon
r_struct
id|eth1394_node_info
op_star
id|node_info
suffix:semicolon
id|hi
op_assign
id|hpsb_get_hostinfo
c_func
(paren
op_amp
id|eth1394_highlevel
comma
id|ud-&gt;ne-&gt;host
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hi
)paren
r_return
op_minus
id|ENOENT
suffix:semicolon
id|priv
op_assign
id|netdev_priv
c_func
(paren
id|hi-&gt;dev
)paren
suffix:semicolon
id|node
op_assign
id|eth1394_find_node
c_func
(paren
op_amp
id|priv-&gt;ip_node_list
comma
id|ud
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|node
)paren
(brace
id|node
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|eth1394_node_ref
)paren
comma
id|in_interrupt
c_func
(paren
)paren
ques
c_cond
id|GFP_ATOMIC
suffix:colon
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|node
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|node_info
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|eth1394_node_info
)paren
comma
id|in_interrupt
c_func
(paren
)paren
ques
c_cond
id|GFP_ATOMIC
suffix:colon
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|node_info
)paren
(brace
id|kfree
c_func
(paren
id|node
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|spin_lock_init
c_func
(paren
op_amp
id|node_info-&gt;pdg.lock
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|node_info-&gt;pdg.list
)paren
suffix:semicolon
id|node_info-&gt;pdg.sz
op_assign
l_int|0
suffix:semicolon
id|ud-&gt;device.driver_data
op_assign
id|node_info
suffix:semicolon
id|node-&gt;ud
op_assign
id|ud
suffix:semicolon
id|priv
op_assign
id|netdev_priv
c_func
(paren
id|hi-&gt;dev
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|node-&gt;list
comma
op_amp
id|priv-&gt;ip_node_list
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|eth1394_id_table
r_static
r_struct
id|ieee1394_device_id
id|eth1394_id_table
(braket
)braket
op_assign
(brace
(brace
dot
id|match_flags
op_assign
(paren
id|IEEE1394_MATCH_SPECIFIER_ID
op_or
id|IEEE1394_MATCH_VERSION
)paren
comma
dot
id|specifier_id
op_assign
id|ETHER1394_GASP_SPECIFIER_ID
comma
dot
id|version
op_assign
id|ETHER1394_GASP_VERSION
comma
)brace
comma
(brace
)brace
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|ieee1394
comma
id|eth1394_id_table
)paren
suffix:semicolon
DECL|variable|eth1394_proto_driver
r_static
r_struct
id|hpsb_protocol_driver
id|eth1394_proto_driver
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;IPv4 over 1394 Driver&quot;
comma
dot
id|id_table
op_assign
id|eth1394_id_table
comma
dot
id|update
op_assign
id|eth1394_update
comma
dot
id|driver
op_assign
(brace
dot
id|name
op_assign
id|ETH1394_DRIVER_NAME
comma
dot
id|bus
op_assign
op_amp
id|ieee1394_bus_type
comma
dot
id|probe
op_assign
id|eth1394_probe
comma
dot
id|remove
op_assign
id|eth1394_remove
comma
)brace
comma
)brace
suffix:semicolon
DECL|function|ether1394_reset_priv
r_static
r_void
id|ether1394_reset_priv
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|set_mtu
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|i
suffix:semicolon
r_struct
id|eth1394_priv
op_star
id|priv
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|hpsb_host
op_star
id|host
op_assign
id|priv-&gt;host
suffix:semicolon
id|u64
id|guid
op_assign
op_star
(paren
(paren
id|u64
op_star
)paren
op_amp
(paren
id|host-&gt;csr.rom-&gt;bus_info_data
(braket
l_int|3
)braket
)paren
)paren
suffix:semicolon
id|u16
id|maxpayload
op_assign
l_int|1
op_lshift
(paren
id|host-&gt;csr.max_rec
op_plus
l_int|1
)paren
suffix:semicolon
r_int
id|max_speed
op_assign
id|IEEE1394_SPEED_MAX
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|memset
c_func
(paren
id|priv-&gt;ud_list
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|node_entry
op_star
)paren
op_star
id|ALL_NODES
)paren
suffix:semicolon
id|priv-&gt;bc_maxpayload
op_assign
l_int|512
suffix:semicolon
multiline_comment|/* Determine speed limit */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|host-&gt;node_count
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|max_speed
OG
id|host-&gt;speed_map
(braket
id|NODEID_TO_NODE
c_func
(paren
id|host-&gt;node_id
)paren
op_star
l_int|64
op_plus
id|i
)braket
)paren
id|max_speed
op_assign
id|host-&gt;speed_map
(braket
id|NODEID_TO_NODE
c_func
(paren
id|host-&gt;node_id
)paren
op_star
l_int|64
op_plus
id|i
)braket
suffix:semicolon
id|priv-&gt;bc_sspd
op_assign
id|max_speed
suffix:semicolon
multiline_comment|/* We&squot;ll use our maxpayload as the default mtu */
r_if
c_cond
(paren
id|set_mtu
)paren
(brace
id|dev-&gt;mtu
op_assign
id|min
c_func
(paren
id|ETH1394_DATA_LEN
comma
(paren
r_int
)paren
(paren
id|maxpayload
op_minus
(paren
r_sizeof
(paren
r_union
id|eth1394_hdr
)paren
op_plus
id|ETHER1394_GASP_OVERHEAD
)paren
)paren
)paren
suffix:semicolon
multiline_comment|/* Set our hardware address while we&squot;re at it */
op_star
(paren
id|u64
op_star
)paren
id|dev-&gt;dev_addr
op_assign
id|guid
suffix:semicolon
op_star
(paren
id|u64
op_star
)paren
id|dev-&gt;broadcast
op_assign
op_complement
l_int|0x0ULL
suffix:semicolon
)brace
id|spin_unlock_irqrestore
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* This function is called right before register_netdev */
DECL|function|ether1394_init_dev
r_static
r_void
id|ether1394_init_dev
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
multiline_comment|/* Our functions */
id|dev-&gt;open
op_assign
id|ether1394_open
suffix:semicolon
id|dev-&gt;stop
op_assign
id|ether1394_stop
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
id|ether1394_tx
suffix:semicolon
id|dev-&gt;get_stats
op_assign
id|ether1394_stats
suffix:semicolon
id|dev-&gt;tx_timeout
op_assign
id|ether1394_tx_timeout
suffix:semicolon
id|dev-&gt;change_mtu
op_assign
id|ether1394_change_mtu
suffix:semicolon
id|dev-&gt;hard_header
op_assign
id|ether1394_header
suffix:semicolon
id|dev-&gt;rebuild_header
op_assign
id|ether1394_rebuild_header
suffix:semicolon
id|dev-&gt;hard_header_cache
op_assign
id|ether1394_header_cache
suffix:semicolon
id|dev-&gt;header_cache_update
op_assign
id|ether1394_header_cache_update
suffix:semicolon
id|dev-&gt;hard_header_parse
op_assign
id|ether1394_header_parse
suffix:semicolon
id|dev-&gt;set_mac_address
op_assign
id|ether1394_mac_addr
suffix:semicolon
id|SET_ETHTOOL_OPS
c_func
(paren
id|dev
comma
op_amp
id|ethtool_ops
)paren
suffix:semicolon
multiline_comment|/* Some constants */
id|dev-&gt;watchdog_timeo
op_assign
id|ETHER1394_TIMEOUT
suffix:semicolon
id|dev-&gt;flags
op_assign
id|IFF_BROADCAST
op_or
id|IFF_MULTICAST
suffix:semicolon
id|dev-&gt;features
op_assign
id|NETIF_F_HIGHDMA
suffix:semicolon
id|dev-&gt;addr_len
op_assign
id|ETH1394_ALEN
suffix:semicolon
id|dev-&gt;hard_header_len
op_assign
id|ETH1394_HLEN
suffix:semicolon
id|dev-&gt;type
op_assign
id|ARPHRD_IEEE1394
suffix:semicolon
id|ether1394_reset_priv
(paren
id|dev
comma
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * This function is called every time a card is found. It is generally called&n; * when the module is installed. This is where we add all of our ethernet&n; * devices. One for each host.&n; */
DECL|function|ether1394_add_host
r_static
r_void
id|ether1394_add_host
(paren
r_struct
id|hpsb_host
op_star
id|host
)paren
(brace
r_struct
id|eth1394_host_info
op_star
id|hi
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|eth1394_priv
op_star
id|priv
suffix:semicolon
r_static
r_int
id|version_printed
op_assign
l_int|0
suffix:semicolon
id|u64
id|fifo_addr
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|host-&gt;config_roms
op_amp
id|HPSB_CONFIG_ROM_ENTRY_IP1394
)paren
)paren
r_return
suffix:semicolon
id|fifo_addr
op_assign
id|hpsb_allocate_and_register_addrspace
c_func
(paren
op_amp
id|eth1394_highlevel
comma
id|host
comma
op_amp
id|addr_ops
comma
id|ETHER1394_REGION_ADDR_LEN
comma
id|ETHER1394_REGION_ADDR_LEN
comma
op_minus
l_int|1
comma
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fifo_addr
op_eq
op_complement
l_int|0ULL
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|version_printed
op_increment
op_eq
l_int|0
)paren
id|ETH1394_PRINT_G
(paren
id|KERN_INFO
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|version
)paren
suffix:semicolon
multiline_comment|/* We should really have our own alloc_hpsbdev() function in&n;&t; * net_init.c instead of calling the one for ethernet then hijacking&n;&t; * it for ourselves.  That way we&squot;d be a real networking device. */
id|dev
op_assign
id|alloc_etherdev
c_func
(paren
r_sizeof
(paren
r_struct
id|eth1394_priv
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_eq
l_int|NULL
)paren
(brace
id|ETH1394_PRINT_G
(paren
id|KERN_ERR
comma
l_string|&quot;Out of memory trying to allocate &quot;
l_string|&quot;etherdevice for IEEE 1394 device %s-%d&bslash;n&quot;
comma
id|host-&gt;driver-&gt;name
comma
id|host-&gt;id
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|SET_MODULE_OWNER
c_func
(paren
id|dev
)paren
suffix:semicolon
id|SET_NETDEV_DEV
c_func
(paren
id|dev
comma
op_amp
id|host-&gt;device
)paren
suffix:semicolon
id|priv
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|priv-&gt;ip_node_list
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|priv-&gt;lock
)paren
suffix:semicolon
id|priv-&gt;host
op_assign
id|host
suffix:semicolon
id|priv-&gt;local_fifo
op_assign
id|fifo_addr
suffix:semicolon
id|hi
op_assign
id|hpsb_create_hostinfo
c_func
(paren
op_amp
id|eth1394_highlevel
comma
id|host
comma
r_sizeof
(paren
op_star
id|hi
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hi
op_eq
l_int|NULL
)paren
(brace
id|ETH1394_PRINT_G
(paren
id|KERN_ERR
comma
l_string|&quot;Out of memory trying to create &quot;
l_string|&quot;hostinfo for IEEE 1394 device %s-%d&bslash;n&quot;
comma
id|host-&gt;driver-&gt;name
comma
id|host-&gt;id
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|ether1394_init_dev
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|register_netdev
(paren
id|dev
)paren
)paren
(brace
id|ETH1394_PRINT
(paren
id|KERN_ERR
comma
id|dev-&gt;name
comma
l_string|&quot;Error registering network driver&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|ETH1394_PRINT
(paren
id|KERN_ERR
comma
id|dev-&gt;name
comma
l_string|&quot;IEEE-1394 IPv4 over 1394 Ethernet (fw-host%d)&bslash;n&quot;
comma
id|host-&gt;id
)paren
suffix:semicolon
id|hi-&gt;host
op_assign
id|host
suffix:semicolon
id|hi-&gt;dev
op_assign
id|dev
suffix:semicolon
multiline_comment|/* Ignore validity in hopes that it will be set in the future.  It&squot;ll&n;&t; * be checked when the eth device is opened. */
id|priv-&gt;broadcast_channel
op_assign
id|host-&gt;csr.broadcast_channel
op_amp
l_int|0x3f
suffix:semicolon
id|priv-&gt;iso
op_assign
id|hpsb_iso_recv_init
c_func
(paren
id|host
comma
(paren
id|ETHER1394_GASP_BUFFERS
op_star
l_int|2
op_star
(paren
l_int|1
op_lshift
(paren
id|host-&gt;csr.max_rec
op_plus
l_int|1
)paren
)paren
)paren
comma
id|ETHER1394_GASP_BUFFERS
comma
id|priv-&gt;broadcast_channel
comma
id|HPSB_ISO_DMA_PACKET_PER_BUFFER
comma
l_int|1
comma
id|ether1394_iso
)paren
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;iso
op_eq
l_int|NULL
)paren
(brace
id|ETH1394_PRINT
c_func
(paren
id|KERN_ERR
comma
id|dev-&gt;name
comma
l_string|&quot;Could not allocate isochronous receive context &quot;
l_string|&quot;for the broadcast channel&bslash;n&quot;
)paren
suffix:semicolon
id|priv-&gt;bc_state
op_assign
id|ETHER1394_BC_ERROR
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|hpsb_iso_recv_start
c_func
(paren
id|priv-&gt;iso
comma
op_minus
l_int|1
comma
(paren
l_int|1
op_lshift
l_int|3
)paren
comma
op_minus
l_int|1
)paren
OL
l_int|0
)paren
id|priv-&gt;bc_state
op_assign
id|ETHER1394_BC_STOPPED
suffix:semicolon
r_else
id|priv-&gt;bc_state
op_assign
id|ETHER1394_BC_RUNNING
suffix:semicolon
)brace
r_return
suffix:semicolon
id|out
suffix:colon
r_if
c_cond
(paren
id|dev
op_ne
l_int|NULL
)paren
id|free_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hi
)paren
id|hpsb_destroy_hostinfo
c_func
(paren
op_amp
id|eth1394_highlevel
comma
id|host
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Remove a card from our list */
DECL|function|ether1394_remove_host
r_static
r_void
id|ether1394_remove_host
(paren
r_struct
id|hpsb_host
op_star
id|host
)paren
(brace
r_struct
id|eth1394_host_info
op_star
id|hi
suffix:semicolon
id|hi
op_assign
id|hpsb_get_hostinfo
c_func
(paren
op_amp
id|eth1394_highlevel
comma
id|host
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hi
op_ne
l_int|NULL
)paren
(brace
r_struct
id|eth1394_priv
op_star
id|priv
op_assign
id|netdev_priv
c_func
(paren
id|hi-&gt;dev
)paren
suffix:semicolon
id|hpsb_unregister_addrspace
c_func
(paren
op_amp
id|eth1394_highlevel
comma
id|host
comma
id|priv-&gt;local_fifo
)paren
suffix:semicolon
r_if
c_cond
(paren
id|priv-&gt;iso
op_ne
l_int|NULL
)paren
id|hpsb_iso_shutdown
c_func
(paren
id|priv-&gt;iso
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hi-&gt;dev
)paren
(brace
id|unregister_netdev
(paren
id|hi-&gt;dev
)paren
suffix:semicolon
id|free_netdev
c_func
(paren
id|hi-&gt;dev
)paren
suffix:semicolon
)brace
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/* A reset has just arisen */
DECL|function|ether1394_host_reset
r_static
r_void
id|ether1394_host_reset
(paren
r_struct
id|hpsb_host
op_star
id|host
)paren
(brace
r_struct
id|eth1394_host_info
op_star
id|hi
suffix:semicolon
r_struct
id|eth1394_priv
op_star
id|priv
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_struct
id|list_head
op_star
id|lh
comma
op_star
id|n
suffix:semicolon
r_struct
id|eth1394_node_ref
op_star
id|node
suffix:semicolon
r_struct
id|eth1394_node_info
op_star
id|node_info
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|hi
op_assign
id|hpsb_get_hostinfo
c_func
(paren
op_amp
id|eth1394_highlevel
comma
id|host
)paren
suffix:semicolon
multiline_comment|/* This can happen for hosts that we don&squot;t use */
r_if
c_cond
(paren
id|hi
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|dev
op_assign
id|hi-&gt;dev
suffix:semicolon
id|priv
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Reset our private host data, but not our mtu */
id|netif_stop_queue
(paren
id|dev
)paren
suffix:semicolon
id|ether1394_reset_priv
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|node
comma
op_amp
id|priv-&gt;ip_node_list
comma
id|list
)paren
(brace
id|node_info
op_assign
(paren
r_struct
id|eth1394_node_info
op_star
)paren
id|node-&gt;ud-&gt;device.driver_data
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|node_info-&gt;pdg.lock
comma
id|flags
)paren
suffix:semicolon
id|list_for_each_safe
c_func
(paren
id|lh
comma
id|n
comma
op_amp
id|node_info-&gt;pdg.list
)paren
(brace
id|purge_partial_datagram
c_func
(paren
id|lh
)paren
suffix:semicolon
)brace
id|INIT_LIST_HEAD
c_func
(paren
op_amp
(paren
id|node_info-&gt;pdg.list
)paren
)paren
suffix:semicolon
id|node_info-&gt;pdg.sz
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|node_info-&gt;pdg.lock
comma
id|flags
)paren
suffix:semicolon
)brace
id|netif_wake_queue
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/******************************************&n; * HW Header net device functions&n; ******************************************/
multiline_comment|/* These functions have been adapted from net/ethernet/eth.c */
multiline_comment|/* Create a fake MAC header for an arbitrary protocol layer.&n; * saddr=NULL means use device source address&n; * daddr=NULL means leave destination address (eg unresolved arp). */
DECL|function|ether1394_header
r_static
r_int
id|ether1394_header
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
comma
r_int
r_int
id|type
comma
r_void
op_star
id|daddr
comma
r_void
op_star
id|saddr
comma
r_int
id|len
)paren
(brace
r_struct
id|eth1394hdr
op_star
id|eth
op_assign
(paren
r_struct
id|eth1394hdr
op_star
)paren
id|skb_push
c_func
(paren
id|skb
comma
id|ETH1394_HLEN
)paren
suffix:semicolon
id|eth-&gt;h_proto
op_assign
id|htons
c_func
(paren
id|type
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
(paren
id|IFF_LOOPBACK
op_or
id|IFF_NOARP
)paren
)paren
(brace
id|memset
c_func
(paren
id|eth-&gt;h_dest
comma
l_int|0
comma
id|dev-&gt;addr_len
)paren
suffix:semicolon
r_return
id|dev-&gt;hard_header_len
suffix:semicolon
)brace
r_if
c_cond
(paren
id|daddr
)paren
(brace
id|memcpy
c_func
(paren
id|eth-&gt;h_dest
comma
id|daddr
comma
id|dev-&gt;addr_len
)paren
suffix:semicolon
r_return
id|dev-&gt;hard_header_len
suffix:semicolon
)brace
r_return
op_minus
id|dev-&gt;hard_header_len
suffix:semicolon
)brace
multiline_comment|/* Rebuild the faked MAC header. This is called after an ARP&n; * (or in future other address resolution) has completed on this&n; * sk_buff. We now let ARP fill in the other fields.&n; *&n; * This routine CANNOT use cached dst-&gt;neigh!&n; * Really, it is used only when dst-&gt;neigh is wrong.&n; */
DECL|function|ether1394_rebuild_header
r_static
r_int
id|ether1394_rebuild_header
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|eth1394hdr
op_star
id|eth
op_assign
(paren
r_struct
id|eth1394hdr
op_star
)paren
id|skb-&gt;data
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
id|skb-&gt;dev
suffix:semicolon
r_switch
c_cond
(paren
id|eth-&gt;h_proto
)paren
(brace
macro_line|#ifdef CONFIG_INET
r_case
id|__constant_htons
c_func
(paren
id|ETH_P_IP
)paren
suffix:colon
r_return
id|arp_find
c_func
(paren
(paren
r_int
r_char
op_star
)paren
op_amp
id|eth-&gt;h_dest
comma
id|skb
)paren
suffix:semicolon
macro_line|#endif
r_default
suffix:colon
id|ETH1394_PRINT
c_func
(paren
id|KERN_DEBUG
comma
id|dev-&gt;name
comma
l_string|&quot;unable to resolve type %04x addresses.&bslash;n&quot;
comma
id|eth-&gt;h_proto
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ether1394_header_parse
r_static
r_int
id|ether1394_header_parse
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_int
r_char
op_star
id|haddr
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|skb-&gt;dev
suffix:semicolon
id|memcpy
c_func
(paren
id|haddr
comma
id|dev-&gt;dev_addr
comma
id|ETH1394_ALEN
)paren
suffix:semicolon
r_return
id|ETH1394_ALEN
suffix:semicolon
)brace
DECL|function|ether1394_header_cache
r_static
r_int
id|ether1394_header_cache
c_func
(paren
r_struct
id|neighbour
op_star
id|neigh
comma
r_struct
id|hh_cache
op_star
id|hh
)paren
(brace
r_int
r_int
id|type
op_assign
id|hh-&gt;hh_type
suffix:semicolon
r_struct
id|eth1394hdr
op_star
id|eth
op_assign
(paren
r_struct
id|eth1394hdr
op_star
)paren
(paren
(paren
(paren
id|u8
op_star
)paren
id|hh-&gt;hh_data
)paren
op_plus
(paren
l_int|16
op_minus
id|ETH1394_HLEN
)paren
)paren
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
id|neigh-&gt;dev
suffix:semicolon
r_if
c_cond
(paren
id|type
op_eq
id|__constant_htons
c_func
(paren
id|ETH_P_802_3
)paren
)paren
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|eth-&gt;h_proto
op_assign
id|type
suffix:semicolon
id|memcpy
c_func
(paren
id|eth-&gt;h_dest
comma
id|neigh-&gt;ha
comma
id|dev-&gt;addr_len
)paren
suffix:semicolon
id|hh-&gt;hh_len
op_assign
id|ETH1394_HLEN
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Called by Address Resolution module to notify changes in address. */
DECL|function|ether1394_header_cache_update
r_static
r_void
id|ether1394_header_cache_update
c_func
(paren
r_struct
id|hh_cache
op_star
id|hh
comma
r_struct
id|net_device
op_star
id|dev
comma
r_int
r_char
op_star
id|haddr
)paren
(brace
id|memcpy
c_func
(paren
(paren
(paren
id|u8
op_star
)paren
id|hh-&gt;hh_data
)paren
op_plus
(paren
l_int|16
op_minus
id|ETH1394_HLEN
)paren
comma
id|haddr
comma
id|dev-&gt;addr_len
)paren
suffix:semicolon
)brace
DECL|function|ether1394_mac_addr
r_static
r_int
id|ether1394_mac_addr
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_void
op_star
id|p
)paren
(brace
r_if
c_cond
(paren
id|netif_running
c_func
(paren
id|dev
)paren
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
multiline_comment|/* Not going to allow setting the MAC address, we really need to use&n;&t; * the real one supplied by the hardware */
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/******************************************&n; * Datagram reception code&n; ******************************************/
multiline_comment|/* Copied from net/ethernet/eth.c */
DECL|function|ether1394_type_trans
r_static
r_inline
id|u16
id|ether1394_type_trans
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|eth1394hdr
op_star
id|eth
suffix:semicolon
r_int
r_char
op_star
id|rawp
suffix:semicolon
id|skb-&gt;mac.raw
op_assign
id|skb-&gt;data
suffix:semicolon
id|skb_pull
(paren
id|skb
comma
id|ETH1394_HLEN
)paren
suffix:semicolon
id|eth
op_assign
id|eth1394_hdr
c_func
(paren
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|eth-&gt;h_dest
op_amp
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|memcmp
c_func
(paren
id|eth-&gt;h_dest
comma
id|dev-&gt;broadcast
comma
id|dev-&gt;addr_len
)paren
op_eq
l_int|0
)paren
id|skb-&gt;pkt_type
op_assign
id|PACKET_BROADCAST
suffix:semicolon
macro_line|#if 0
r_else
id|skb-&gt;pkt_type
op_assign
id|PACKET_MULTICAST
suffix:semicolon
macro_line|#endif
)brace
r_else
(brace
r_if
c_cond
(paren
id|memcmp
c_func
(paren
id|eth-&gt;h_dest
comma
id|dev-&gt;dev_addr
comma
id|dev-&gt;addr_len
)paren
)paren
id|skb-&gt;pkt_type
op_assign
id|PACKET_OTHERHOST
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ntohs
(paren
id|eth-&gt;h_proto
)paren
op_ge
l_int|1536
)paren
r_return
id|eth-&gt;h_proto
suffix:semicolon
id|rawp
op_assign
id|skb-&gt;data
suffix:semicolon
r_if
c_cond
(paren
op_star
(paren
r_int
r_int
op_star
)paren
id|rawp
op_eq
l_int|0xFFFF
)paren
r_return
id|htons
(paren
id|ETH_P_802_3
)paren
suffix:semicolon
r_return
id|htons
(paren
id|ETH_P_802_2
)paren
suffix:semicolon
)brace
multiline_comment|/* Parse an encapsulated IP1394 header into an ethernet frame packet.&n; * We also perform ARP translation here, if need be.  */
DECL|function|ether1394_parse_encap
r_static
r_inline
id|u16
id|ether1394_parse_encap
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
comma
id|nodeid_t
id|srcid
comma
id|nodeid_t
id|destid
comma
id|u16
id|ether_type
)paren
(brace
r_struct
id|eth1394_priv
op_star
id|priv
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
id|u64
id|dest_hw
suffix:semicolon
r_int
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Setup our hw addresses. We use these to build the&n;&t; * ethernet header.  */
r_if
c_cond
(paren
id|destid
op_eq
(paren
id|LOCAL_BUS
op_or
id|ALL_NODES
)paren
)paren
id|dest_hw
op_assign
op_complement
l_int|0ULL
suffix:semicolon
multiline_comment|/* broadcast */
r_else
id|dest_hw
op_assign
id|cpu_to_be64
c_func
(paren
(paren
(paren
(paren
id|u64
)paren
id|priv-&gt;host-&gt;csr.guid_hi
)paren
op_lshift
l_int|32
)paren
op_or
id|priv-&gt;host-&gt;csr.guid_lo
)paren
suffix:semicolon
multiline_comment|/* If this is an ARP packet, convert it. First, we want to make&n;&t; * use of some of the fields, since they tell us a little bit&n;&t; * about the sending machine.  */
r_if
c_cond
(paren
id|ether_type
op_eq
id|__constant_htons
(paren
id|ETH_P_ARP
)paren
)paren
(brace
r_struct
id|eth1394_arp
op_star
id|arp1394
op_assign
(paren
r_struct
id|eth1394_arp
op_star
)paren
id|skb-&gt;data
suffix:semicolon
r_struct
id|arphdr
op_star
id|arp
op_assign
(paren
r_struct
id|arphdr
op_star
)paren
id|skb-&gt;data
suffix:semicolon
r_int
r_char
op_star
id|arp_ptr
op_assign
(paren
r_int
r_char
op_star
)paren
(paren
id|arp
op_plus
l_int|1
)paren
suffix:semicolon
id|u64
id|fifo_addr
op_assign
(paren
id|u64
)paren
id|ntohs
c_func
(paren
id|arp1394-&gt;fifo_hi
)paren
op_lshift
l_int|32
op_or
id|ntohl
c_func
(paren
id|arp1394-&gt;fifo_lo
)paren
suffix:semicolon
id|u8
id|max_rec
op_assign
id|min
c_func
(paren
id|priv-&gt;host-&gt;csr.max_rec
comma
(paren
id|u8
)paren
(paren
id|arp1394-&gt;max_rec
)paren
)paren
suffix:semicolon
r_int
id|sspd
op_assign
id|arp1394-&gt;sspd
suffix:semicolon
id|u16
id|maxpayload
suffix:semicolon
r_struct
id|eth1394_node_ref
op_star
id|node
suffix:semicolon
r_struct
id|eth1394_node_info
op_star
id|node_info
suffix:semicolon
multiline_comment|/* Sanity check. MacOSX seems to be sending us 131 in this&n;&t;&t; * field (atleast on my Panther G5). Not sure why. */
r_if
c_cond
(paren
id|sspd
OG
l_int|5
op_logical_or
id|sspd
OL
l_int|0
)paren
id|sspd
op_assign
l_int|0
suffix:semicolon
id|maxpayload
op_assign
id|min
c_func
(paren
id|eth1394_speedto_maxpayload
(braket
id|sspd
)braket
comma
(paren
id|u16
)paren
(paren
l_int|1
op_lshift
(paren
id|max_rec
op_plus
l_int|1
)paren
)paren
)paren
suffix:semicolon
id|node
op_assign
id|eth1394_find_node_guid
c_func
(paren
op_amp
id|priv-&gt;ip_node_list
comma
id|be64_to_cpu
c_func
(paren
id|arp1394-&gt;s_uniq_id
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|node
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|node_info
op_assign
(paren
r_struct
id|eth1394_node_info
op_star
)paren
id|node-&gt;ud-&gt;device.driver_data
suffix:semicolon
multiline_comment|/* Update our speed/payload/fifo_offset table */
id|node_info-&gt;maxpayload
op_assign
id|maxpayload
suffix:semicolon
id|node_info-&gt;sspd
op_assign
id|sspd
suffix:semicolon
id|node_info-&gt;fifo
op_assign
id|fifo_addr
suffix:semicolon
multiline_comment|/* Now that we&squot;re done with the 1394 specific stuff, we&squot;ll&n;&t;&t; * need to alter some of the data.  Believe it or not, all&n;&t;&t; * that needs to be done is sender_IP_address needs to be&n;&t;&t; * moved, the destination hardware address get stuffed&n;&t;&t; * in and the hardware address length set to 8.&n;&t;&t; *&n;&t;&t; * IMPORTANT: The code below overwrites 1394 specific data&n;&t;&t; * needed above so keep the munging of the data for the&n;&t;&t; * higher level IP stack last. */
id|arp-&gt;ar_hln
op_assign
l_int|8
suffix:semicolon
id|arp_ptr
op_add_assign
id|arp-&gt;ar_hln
suffix:semicolon
multiline_comment|/* skip over sender unique id */
op_star
(paren
id|u32
op_star
)paren
id|arp_ptr
op_assign
id|arp1394-&gt;sip
suffix:semicolon
multiline_comment|/* move sender IP addr */
id|arp_ptr
op_add_assign
id|arp-&gt;ar_pln
suffix:semicolon
multiline_comment|/* skip over sender IP addr */
r_if
c_cond
(paren
id|arp-&gt;ar_op
op_eq
l_int|1
)paren
multiline_comment|/* just set ARP req target unique ID to 0 */
op_star
(paren
(paren
id|u64
op_star
)paren
id|arp_ptr
)paren
op_assign
l_int|0
suffix:semicolon
r_else
op_star
(paren
(paren
id|u64
op_star
)paren
id|arp_ptr
)paren
op_assign
op_star
(paren
(paren
id|u64
op_star
)paren
id|dev-&gt;dev_addr
)paren
suffix:semicolon
)brace
multiline_comment|/* Now add the ethernet header. */
r_if
c_cond
(paren
id|dev-&gt;hard_header
(paren
id|skb
comma
id|dev
comma
id|__constant_ntohs
(paren
id|ether_type
)paren
comma
op_amp
id|dest_hw
comma
l_int|NULL
comma
id|skb-&gt;len
)paren
op_ge
l_int|0
)paren
id|ret
op_assign
id|ether1394_type_trans
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|fragment_overlap
r_static
r_inline
r_int
id|fragment_overlap
c_func
(paren
r_struct
id|list_head
op_star
id|frag_list
comma
r_int
id|offset
comma
r_int
id|len
)paren
(brace
r_struct
id|fragment_info
op_star
id|fi
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|fi
comma
id|frag_list
comma
id|list
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
(paren
id|offset
OG
(paren
id|fi-&gt;offset
op_plus
id|fi-&gt;len
op_minus
l_int|1
)paren
)paren
op_logical_or
(paren
(paren
id|offset
op_plus
id|len
op_minus
l_int|1
)paren
OL
id|fi-&gt;offset
)paren
)paren
)paren
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|find_partial_datagram
r_static
r_inline
r_struct
id|list_head
op_star
id|find_partial_datagram
c_func
(paren
r_struct
id|list_head
op_star
id|pdgl
comma
r_int
id|dgl
)paren
(brace
r_struct
id|partial_datagram
op_star
id|pd
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|pd
comma
id|pdgl
comma
id|list
)paren
(brace
r_if
c_cond
(paren
id|pd-&gt;dgl
op_eq
id|dgl
)paren
r_return
op_amp
id|pd-&gt;list
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* Assumes that new fragment does not overlap any existing fragments */
DECL|function|new_fragment
r_static
r_inline
r_int
id|new_fragment
c_func
(paren
r_struct
id|list_head
op_star
id|frag_info
comma
r_int
id|offset
comma
r_int
id|len
)paren
(brace
r_struct
id|list_head
op_star
id|lh
suffix:semicolon
r_struct
id|fragment_info
op_star
id|fi
comma
op_star
id|fi2
comma
op_star
r_new
suffix:semicolon
id|list_for_each
c_func
(paren
id|lh
comma
id|frag_info
)paren
(brace
id|fi
op_assign
id|list_entry
c_func
(paren
id|lh
comma
r_struct
id|fragment_info
comma
id|list
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|fi-&gt;offset
op_plus
id|fi-&gt;len
)paren
op_eq
id|offset
)paren
(brace
multiline_comment|/* The new fragment can be tacked on to the end */
id|fi-&gt;len
op_add_assign
id|len
suffix:semicolon
multiline_comment|/* Did the new fragment plug a hole? */
id|fi2
op_assign
id|list_entry
c_func
(paren
id|lh-&gt;next
comma
r_struct
id|fragment_info
comma
id|list
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|fi-&gt;offset
op_plus
id|fi-&gt;len
)paren
op_eq
id|fi2-&gt;offset
)paren
(brace
multiline_comment|/* glue fragments together */
id|fi-&gt;len
op_add_assign
id|fi2-&gt;len
suffix:semicolon
id|list_del
c_func
(paren
id|lh-&gt;next
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|fi2
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|offset
op_plus
id|len
)paren
op_eq
id|fi-&gt;offset
)paren
(brace
multiline_comment|/* The new fragment can be tacked on to the beginning */
id|fi-&gt;offset
op_assign
id|offset
suffix:semicolon
id|fi-&gt;len
op_add_assign
id|len
suffix:semicolon
multiline_comment|/* Did the new fragment plug a hole? */
id|fi2
op_assign
id|list_entry
c_func
(paren
id|lh-&gt;prev
comma
r_struct
id|fragment_info
comma
id|list
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|fi2-&gt;offset
op_plus
id|fi2-&gt;len
)paren
op_eq
id|fi-&gt;offset
)paren
(brace
multiline_comment|/* glue fragments together */
id|fi2-&gt;len
op_add_assign
id|fi-&gt;len
suffix:semicolon
id|list_del
c_func
(paren
id|lh
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|fi
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|offset
OG
(paren
id|fi-&gt;offset
op_plus
id|fi-&gt;len
)paren
)paren
(brace
r_break
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|offset
op_plus
id|len
)paren
OL
id|fi-&gt;offset
)paren
(brace
id|lh
op_assign
id|lh-&gt;prev
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_new
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|fragment_info
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
r_new
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
r_new
op_member_access_from_pointer
id|offset
op_assign
id|offset
suffix:semicolon
r_new
op_member_access_from_pointer
id|len
op_assign
id|len
suffix:semicolon
id|list_add
c_func
(paren
op_amp
r_new
op_member_access_from_pointer
id|list
comma
id|lh
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|new_partial_datagram
r_static
r_inline
r_int
id|new_partial_datagram
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|list_head
op_star
id|pdgl
comma
r_int
id|dgl
comma
r_int
id|dg_size
comma
r_char
op_star
id|frag_buf
comma
r_int
id|frag_off
comma
r_int
id|frag_len
)paren
(brace
r_struct
id|partial_datagram
op_star
r_new
suffix:semicolon
r_new
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|partial_datagram
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
r_new
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
r_new
op_member_access_from_pointer
id|frag_info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|new_fragment
c_func
(paren
op_amp
r_new
op_member_access_from_pointer
id|frag_info
comma
id|frag_off
comma
id|frag_len
)paren
OL
l_int|0
)paren
(brace
id|kfree
c_func
(paren
r_new
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_new
op_member_access_from_pointer
id|dgl
op_assign
id|dgl
suffix:semicolon
r_new
op_member_access_from_pointer
id|dg_size
op_assign
id|dg_size
suffix:semicolon
r_new
op_member_access_from_pointer
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|dg_size
op_plus
id|dev-&gt;hard_header_len
op_plus
l_int|15
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
r_new
op_member_access_from_pointer
id|skb
)paren
(brace
r_struct
id|fragment_info
op_star
id|fi
op_assign
id|list_entry
c_func
(paren
r_new
op_member_access_from_pointer
id|frag_info.next
comma
r_struct
id|fragment_info
comma
id|list
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|fi
)paren
suffix:semicolon
id|kfree
c_func
(paren
r_new
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|skb_reserve
c_func
(paren
r_new
op_member_access_from_pointer
id|skb
comma
(paren
id|dev-&gt;hard_header_len
op_plus
l_int|15
)paren
op_amp
op_complement
l_int|15
)paren
suffix:semicolon
r_new
op_member_access_from_pointer
id|pbuf
op_assign
id|skb_put
c_func
(paren
r_new
op_member_access_from_pointer
id|skb
comma
id|dg_size
)paren
suffix:semicolon
id|memcpy
c_func
(paren
r_new
op_member_access_from_pointer
id|pbuf
op_plus
id|frag_off
comma
id|frag_buf
comma
id|frag_len
)paren
suffix:semicolon
id|list_add
c_func
(paren
op_amp
r_new
op_member_access_from_pointer
id|list
comma
id|pdgl
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|update_partial_datagram
r_static
r_inline
r_int
id|update_partial_datagram
c_func
(paren
r_struct
id|list_head
op_star
id|pdgl
comma
r_struct
id|list_head
op_star
id|lh
comma
r_char
op_star
id|frag_buf
comma
r_int
id|frag_off
comma
r_int
id|frag_len
)paren
(brace
r_struct
id|partial_datagram
op_star
id|pd
op_assign
id|list_entry
c_func
(paren
id|lh
comma
r_struct
id|partial_datagram
comma
id|list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|new_fragment
c_func
(paren
op_amp
id|pd-&gt;frag_info
comma
id|frag_off
comma
id|frag_len
)paren
OL
l_int|0
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|pd-&gt;pbuf
op_plus
id|frag_off
comma
id|frag_buf
comma
id|frag_len
)paren
suffix:semicolon
multiline_comment|/* Move list entry to beginnig of list so that oldest partial&n;&t; * datagrams percolate to the end of the list */
id|list_del
c_func
(paren
id|lh
)paren
suffix:semicolon
id|list_add
c_func
(paren
id|lh
comma
id|pdgl
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|is_datagram_complete
r_static
r_inline
r_int
id|is_datagram_complete
c_func
(paren
r_struct
id|list_head
op_star
id|lh
comma
r_int
id|dg_size
)paren
(brace
r_struct
id|partial_datagram
op_star
id|pd
op_assign
id|list_entry
c_func
(paren
id|lh
comma
r_struct
id|partial_datagram
comma
id|list
)paren
suffix:semicolon
r_struct
id|fragment_info
op_star
id|fi
op_assign
id|list_entry
c_func
(paren
id|pd-&gt;frag_info.next
comma
r_struct
id|fragment_info
comma
id|list
)paren
suffix:semicolon
r_return
(paren
id|fi-&gt;len
op_eq
id|dg_size
)paren
suffix:semicolon
)brace
multiline_comment|/* Packet reception. We convert the IP1394 encapsulation header to an&n; * ethernet header, and fill it with some of our other fields. This is&n; * an incoming packet from the 1394 bus.  */
DECL|function|ether1394_data_handler
r_static
r_int
id|ether1394_data_handler
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
id|srcid
comma
r_int
id|destid
comma
r_char
op_star
id|buf
comma
r_int
id|len
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|eth1394_priv
op_star
id|priv
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_union
id|eth1394_hdr
op_star
id|hdr
op_assign
(paren
r_union
id|eth1394_hdr
op_star
)paren
id|buf
suffix:semicolon
id|u16
id|ether_type
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* initialized to clear warning */
r_int
id|hdr_len
suffix:semicolon
r_struct
id|unit_directory
op_star
id|ud
op_assign
id|priv-&gt;ud_list
(braket
id|NODEID_TO_NODE
c_func
(paren
id|srcid
)paren
)braket
suffix:semicolon
r_struct
id|eth1394_node_info
op_star
id|node_info
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ud
)paren
(brace
r_struct
id|eth1394_node_ref
op_star
id|node
suffix:semicolon
id|node
op_assign
id|eth1394_find_node_nodeid
c_func
(paren
op_amp
id|priv-&gt;ip_node_list
comma
id|srcid
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|node
)paren
(brace
id|HPSB_PRINT
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;ether1394 rx: sender nodeid &quot;
l_string|&quot;lookup failure: &quot;
id|NODE_BUS_FMT
comma
id|NODE_BUS_ARGS
c_func
(paren
id|priv-&gt;host
comma
id|srcid
)paren
)paren
suffix:semicolon
id|priv-&gt;stats.rx_dropped
op_increment
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|ud
op_assign
id|node-&gt;ud
suffix:semicolon
id|priv-&gt;ud_list
(braket
id|NODEID_TO_NODE
c_func
(paren
id|srcid
)paren
)braket
op_assign
id|ud
suffix:semicolon
)brace
id|node_info
op_assign
(paren
r_struct
id|eth1394_node_info
op_star
)paren
id|ud-&gt;device.driver_data
suffix:semicolon
multiline_comment|/* First, did we receive a fragmented or unfragmented datagram? */
id|hdr-&gt;words.word1
op_assign
id|ntohs
c_func
(paren
id|hdr-&gt;words.word1
)paren
suffix:semicolon
id|hdr_len
op_assign
id|hdr_type_len
(braket
id|hdr-&gt;common.lf
)braket
suffix:semicolon
r_if
c_cond
(paren
id|hdr-&gt;common.lf
op_eq
id|ETH1394_HDR_LF_UF
)paren
(brace
multiline_comment|/* An unfragmented datagram has been received by the ieee1394&n;&t;&t; * bus. Build an skbuff around it so we can pass it to the&n;&t;&t; * high level network layer. */
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|len
op_plus
id|dev-&gt;hard_header_len
op_plus
l_int|15
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
(brace
id|HPSB_PRINT
(paren
id|KERN_ERR
comma
l_string|&quot;ether1394 rx: low on mem&bslash;n&quot;
)paren
suffix:semicolon
id|priv-&gt;stats.rx_dropped
op_increment
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|skb_reserve
c_func
(paren
id|skb
comma
(paren
id|dev-&gt;hard_header_len
op_plus
l_int|15
)paren
op_amp
op_complement
l_int|15
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|len
op_minus
id|hdr_len
)paren
comma
id|buf
op_plus
id|hdr_len
comma
id|len
op_minus
id|hdr_len
)paren
suffix:semicolon
id|ether_type
op_assign
id|hdr-&gt;uf.ether_type
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* A datagram fragment has been received, now the fun begins. */
r_struct
id|list_head
op_star
id|pdgl
comma
op_star
id|lh
suffix:semicolon
r_struct
id|partial_datagram
op_star
id|pd
suffix:semicolon
r_int
id|fg_off
suffix:semicolon
r_int
id|fg_len
op_assign
id|len
op_minus
id|hdr_len
suffix:semicolon
r_int
id|dg_size
suffix:semicolon
r_int
id|dgl
suffix:semicolon
r_int
id|retval
suffix:semicolon
r_struct
id|pdg_list
op_star
id|pdg
op_assign
op_amp
(paren
id|node_info-&gt;pdg
)paren
suffix:semicolon
id|hdr-&gt;words.word3
op_assign
id|ntohs
c_func
(paren
id|hdr-&gt;words.word3
)paren
suffix:semicolon
multiline_comment|/* The 4th header word is reserved so no need to do ntohs() */
r_if
c_cond
(paren
id|hdr-&gt;common.lf
op_eq
id|ETH1394_HDR_LF_FF
)paren
(brace
id|ether_type
op_assign
id|hdr-&gt;ff.ether_type
suffix:semicolon
id|dgl
op_assign
id|hdr-&gt;ff.dgl
suffix:semicolon
id|dg_size
op_assign
id|hdr-&gt;ff.dg_size
op_plus
l_int|1
suffix:semicolon
id|fg_off
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|hdr-&gt;words.word2
op_assign
id|ntohs
c_func
(paren
id|hdr-&gt;words.word2
)paren
suffix:semicolon
id|dgl
op_assign
id|hdr-&gt;sf.dgl
suffix:semicolon
id|dg_size
op_assign
id|hdr-&gt;sf.dg_size
op_plus
l_int|1
suffix:semicolon
id|fg_off
op_assign
id|hdr-&gt;sf.fg_off
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|pdg-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|pdgl
op_assign
op_amp
(paren
id|pdg-&gt;list
)paren
suffix:semicolon
id|lh
op_assign
id|find_partial_datagram
c_func
(paren
id|pdgl
comma
id|dgl
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lh
op_eq
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|pdg-&gt;sz
op_eq
id|max_partial_datagrams
)paren
(brace
multiline_comment|/* remove the oldest */
id|purge_partial_datagram
c_func
(paren
id|pdgl-&gt;prev
)paren
suffix:semicolon
id|pdg-&gt;sz
op_decrement
suffix:semicolon
)brace
id|retval
op_assign
id|new_partial_datagram
c_func
(paren
id|dev
comma
id|pdgl
comma
id|dgl
comma
id|dg_size
comma
id|buf
op_plus
id|hdr_len
comma
id|fg_off
comma
id|fg_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
OL
l_int|0
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|pdg-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_goto
id|bad_proto
suffix:semicolon
)brace
id|pdg-&gt;sz
op_increment
suffix:semicolon
id|lh
op_assign
id|find_partial_datagram
c_func
(paren
id|pdgl
comma
id|dgl
)paren
suffix:semicolon
)brace
r_else
(brace
r_struct
id|partial_datagram
op_star
id|pd
suffix:semicolon
id|pd
op_assign
id|list_entry
c_func
(paren
id|lh
comma
r_struct
id|partial_datagram
comma
id|list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fragment_overlap
c_func
(paren
op_amp
id|pd-&gt;frag_info
comma
id|fg_off
comma
id|fg_len
)paren
)paren
(brace
multiline_comment|/* Overlapping fragments, obliterate old&n;&t;&t;&t;&t; * datagram and start new one. */
id|purge_partial_datagram
c_func
(paren
id|lh
)paren
suffix:semicolon
id|retval
op_assign
id|new_partial_datagram
c_func
(paren
id|dev
comma
id|pdgl
comma
id|dgl
comma
id|dg_size
comma
id|buf
op_plus
id|hdr_len
comma
id|fg_off
comma
id|fg_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
OL
l_int|0
)paren
(brace
id|pdg-&gt;sz
op_decrement
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|pdg-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_goto
id|bad_proto
suffix:semicolon
)brace
)brace
r_else
(brace
id|retval
op_assign
id|update_partial_datagram
c_func
(paren
id|pdgl
comma
id|lh
comma
id|buf
op_plus
id|hdr_len
comma
id|fg_off
comma
id|fg_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
OL
l_int|0
)paren
(brace
multiline_comment|/* Couldn&squot;t save off fragment anyway&n;&t;&t;&t;&t;&t; * so might as well obliterate the&n;&t;&t;&t;&t;&t; * datagram now. */
id|purge_partial_datagram
c_func
(paren
id|lh
)paren
suffix:semicolon
id|pdg-&gt;sz
op_decrement
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|pdg-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_goto
id|bad_proto
suffix:semicolon
)brace
)brace
multiline_comment|/* fragment overlap */
)brace
multiline_comment|/* new datagram or add to existing one */
id|pd
op_assign
id|list_entry
c_func
(paren
id|lh
comma
r_struct
id|partial_datagram
comma
id|list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hdr-&gt;common.lf
op_eq
id|ETH1394_HDR_LF_FF
)paren
(brace
id|pd-&gt;ether_type
op_assign
id|ether_type
suffix:semicolon
)brace
r_if
c_cond
(paren
id|is_datagram_complete
c_func
(paren
id|lh
comma
id|dg_size
)paren
)paren
(brace
id|ether_type
op_assign
id|pd-&gt;ether_type
suffix:semicolon
id|pdg-&gt;sz
op_decrement
suffix:semicolon
id|skb
op_assign
id|skb_get
c_func
(paren
id|pd-&gt;skb
)paren
suffix:semicolon
id|purge_partial_datagram
c_func
(paren
id|lh
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|pdg-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Datagram is not complete, we&squot;re done for the&n;&t;&t;&t; * moment. */
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|pdg-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/* unframgented datagram or fragmented one */
multiline_comment|/* Write metadata, and then pass to the receive level */
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb-&gt;ip_summed
op_assign
id|CHECKSUM_UNNECESSARY
suffix:semicolon
multiline_comment|/* don&squot;t check it */
multiline_comment|/* Parse the encapsulation header. This actually does the job of&n;&t; * converting to an ethernet frame header, aswell as arp&n;&t; * conversion if needed. ARP conversion is easier in this&n;&t; * direction, since we are using ethernet as our backend.  */
id|skb-&gt;protocol
op_assign
id|ether1394_parse_encap
c_func
(paren
id|skb
comma
id|dev
comma
id|srcid
comma
id|destid
comma
id|ether_type
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb-&gt;protocol
)paren
(brace
id|priv-&gt;stats.rx_errors
op_increment
suffix:semicolon
id|priv-&gt;stats.rx_dropped
op_increment
suffix:semicolon
id|dev_kfree_skb_any
c_func
(paren
id|skb
)paren
suffix:semicolon
r_goto
id|bad_proto
suffix:semicolon
)brace
r_if
c_cond
(paren
id|netif_rx
c_func
(paren
id|skb
)paren
op_eq
id|NET_RX_DROP
)paren
(brace
id|priv-&gt;stats.rx_errors
op_increment
suffix:semicolon
id|priv-&gt;stats.rx_dropped
op_increment
suffix:semicolon
r_goto
id|bad_proto
suffix:semicolon
)brace
multiline_comment|/* Statistics */
id|priv-&gt;stats.rx_packets
op_increment
suffix:semicolon
id|priv-&gt;stats.rx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
id|bad_proto
suffix:colon
r_if
c_cond
(paren
id|netif_queue_stopped
c_func
(paren
id|dev
)paren
)paren
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|dev-&gt;last_rx
op_assign
id|jiffies
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ether1394_write
r_static
r_int
id|ether1394_write
c_func
(paren
r_struct
id|hpsb_host
op_star
id|host
comma
r_int
id|srcid
comma
r_int
id|destid
comma
id|quadlet_t
op_star
id|data
comma
id|u64
id|addr
comma
r_int
id|len
comma
id|u16
id|flags
)paren
(brace
r_struct
id|eth1394_host_info
op_star
id|hi
suffix:semicolon
id|hi
op_assign
id|hpsb_get_hostinfo
c_func
(paren
op_amp
id|eth1394_highlevel
comma
id|host
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hi
op_eq
l_int|NULL
)paren
(brace
id|ETH1394_PRINT_G
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;Could not find net device for host %s&bslash;n&quot;
comma
id|host-&gt;driver-&gt;name
)paren
suffix:semicolon
r_return
id|RCODE_ADDRESS_ERROR
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ether1394_data_handler
c_func
(paren
id|hi-&gt;dev
comma
id|srcid
comma
id|destid
comma
(paren
r_char
op_star
)paren
id|data
comma
id|len
)paren
)paren
r_return
id|RCODE_ADDRESS_ERROR
suffix:semicolon
r_else
r_return
id|RCODE_COMPLETE
suffix:semicolon
)brace
DECL|function|ether1394_iso
r_static
r_void
id|ether1394_iso
c_func
(paren
r_struct
id|hpsb_iso
op_star
id|iso
)paren
(brace
id|quadlet_t
op_star
id|data
suffix:semicolon
r_char
op_star
id|buf
suffix:semicolon
r_struct
id|eth1394_host_info
op_star
id|hi
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_struct
id|eth1394_priv
op_star
id|priv
suffix:semicolon
r_int
r_int
id|len
suffix:semicolon
id|u32
id|specifier_id
suffix:semicolon
id|u16
id|source_id
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|nready
suffix:semicolon
id|hi
op_assign
id|hpsb_get_hostinfo
c_func
(paren
op_amp
id|eth1394_highlevel
comma
id|iso-&gt;host
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hi
op_eq
l_int|NULL
)paren
(brace
id|ETH1394_PRINT_G
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;Could not find net device for host %s&bslash;n&quot;
comma
id|iso-&gt;host-&gt;driver-&gt;name
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|dev
op_assign
id|hi-&gt;dev
suffix:semicolon
id|nready
op_assign
id|hpsb_iso_n_ready
c_func
(paren
id|iso
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|nready
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|hpsb_iso_packet_info
op_star
id|info
op_assign
op_amp
id|iso-&gt;infos
(braket
(paren
id|iso-&gt;first_packet
op_plus
id|i
)paren
op_mod
id|iso-&gt;buf_packets
)braket
suffix:semicolon
id|data
op_assign
(paren
id|quadlet_t
op_star
)paren
(paren
id|iso-&gt;data_buf.kvirt
op_plus
id|info-&gt;offset
)paren
suffix:semicolon
multiline_comment|/* skip over GASP header */
id|buf
op_assign
(paren
r_char
op_star
)paren
id|data
op_plus
l_int|8
suffix:semicolon
id|len
op_assign
id|info-&gt;len
op_minus
l_int|8
suffix:semicolon
id|specifier_id
op_assign
(paren
(paren
(paren
id|be32_to_cpu
c_func
(paren
id|data
(braket
l_int|0
)braket
)paren
op_amp
l_int|0xffff
)paren
op_lshift
l_int|8
)paren
op_or
(paren
(paren
id|be32_to_cpu
c_func
(paren
id|data
(braket
l_int|1
)braket
)paren
op_amp
l_int|0xff000000
)paren
op_rshift
l_int|24
)paren
)paren
suffix:semicolon
id|source_id
op_assign
id|be32_to_cpu
c_func
(paren
id|data
(braket
l_int|0
)braket
)paren
op_rshift
l_int|16
suffix:semicolon
id|priv
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;channel
op_ne
(paren
id|iso-&gt;host-&gt;csr.broadcast_channel
op_amp
l_int|0x3f
)paren
op_logical_or
id|specifier_id
op_ne
id|ETHER1394_GASP_SPECIFIER_ID
)paren
(brace
multiline_comment|/* This packet is not for us */
r_continue
suffix:semicolon
)brace
id|ether1394_data_handler
c_func
(paren
id|dev
comma
id|source_id
comma
id|LOCAL_BUS
op_or
id|ALL_NODES
comma
id|buf
comma
id|len
)paren
suffix:semicolon
)brace
id|hpsb_iso_recv_release_packets
c_func
(paren
id|iso
comma
id|i
)paren
suffix:semicolon
id|dev-&gt;last_rx
op_assign
id|jiffies
suffix:semicolon
)brace
multiline_comment|/******************************************&n; * Datagram transmission code&n; ******************************************/
multiline_comment|/* Convert a standard ARP packet to 1394 ARP. The first 8 bytes (the entire&n; * arphdr) is the same format as the ip1394 header, so they overlap.  The rest&n; * needs to be munged a bit.  The remainder of the arphdr is formatted based&n; * on hwaddr len and ipaddr len.  We know what they&squot;ll be, so it&squot;s easy to&n; * judge.&n; *&n; * Now that the EUI is used for the hardware address all we need to do to make&n; * this work for 1394 is to insert 2 quadlets that contain max_rec size,&n; * speed, and unicast FIFO address information between the sender_unique_id&n; * and the IP addresses.&n; */
DECL|function|ether1394_arp_to_1394arp
r_static
r_inline
r_void
id|ether1394_arp_to_1394arp
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|eth1394_priv
op_star
id|priv
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|arphdr
op_star
id|arp
op_assign
(paren
r_struct
id|arphdr
op_star
)paren
id|skb-&gt;data
suffix:semicolon
r_int
r_char
op_star
id|arp_ptr
op_assign
(paren
r_int
r_char
op_star
)paren
(paren
id|arp
op_plus
l_int|1
)paren
suffix:semicolon
r_struct
id|eth1394_arp
op_star
id|arp1394
op_assign
(paren
r_struct
id|eth1394_arp
op_star
)paren
id|skb-&gt;data
suffix:semicolon
multiline_comment|/* Believe it or not, all that need to happen is sender IP get moved&n;&t; * and set hw_addr_len, max_rec, sspd, fifo_hi and fifo_lo.  */
id|arp1394-&gt;hw_addr_len
op_assign
l_int|16
suffix:semicolon
id|arp1394-&gt;sip
op_assign
op_star
(paren
id|u32
op_star
)paren
(paren
id|arp_ptr
op_plus
id|ETH1394_ALEN
)paren
suffix:semicolon
id|arp1394-&gt;max_rec
op_assign
id|priv-&gt;host-&gt;csr.max_rec
suffix:semicolon
id|arp1394-&gt;sspd
op_assign
id|priv-&gt;host-&gt;csr.lnk_spd
suffix:semicolon
id|arp1394-&gt;fifo_hi
op_assign
id|htons
(paren
id|priv-&gt;local_fifo
op_rshift
l_int|32
)paren
suffix:semicolon
id|arp1394-&gt;fifo_lo
op_assign
id|htonl
(paren
id|priv-&gt;local_fifo
op_amp
op_complement
l_int|0x0
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* We need to encapsulate the standard header with our own. We use the&n; * ethernet header&squot;s proto for our own. */
DECL|function|ether1394_encapsulate_prep
r_static
r_inline
r_int
r_int
id|ether1394_encapsulate_prep
c_func
(paren
r_int
r_int
id|max_payload
comma
r_int
id|proto
comma
r_union
id|eth1394_hdr
op_star
id|hdr
comma
id|u16
id|dg_size
comma
id|u16
id|dgl
)paren
(brace
r_int
r_int
id|adj_max_payload
op_assign
id|max_payload
op_minus
id|hdr_type_len
(braket
id|ETH1394_HDR_LF_UF
)braket
suffix:semicolon
multiline_comment|/* Does it all fit in one packet? */
r_if
c_cond
(paren
id|dg_size
op_le
id|adj_max_payload
)paren
(brace
id|hdr-&gt;uf.lf
op_assign
id|ETH1394_HDR_LF_UF
suffix:semicolon
id|hdr-&gt;uf.ether_type
op_assign
id|proto
suffix:semicolon
)brace
r_else
(brace
id|hdr-&gt;ff.lf
op_assign
id|ETH1394_HDR_LF_FF
suffix:semicolon
id|hdr-&gt;ff.ether_type
op_assign
id|proto
suffix:semicolon
id|hdr-&gt;ff.dg_size
op_assign
id|dg_size
op_minus
l_int|1
suffix:semicolon
id|hdr-&gt;ff.dgl
op_assign
id|dgl
suffix:semicolon
id|adj_max_payload
op_assign
id|max_payload
op_minus
id|hdr_type_len
(braket
id|ETH1394_HDR_LF_FF
)braket
suffix:semicolon
)brace
r_return
(paren
id|dg_size
op_plus
(paren
id|adj_max_payload
op_minus
l_int|1
)paren
)paren
op_div
id|adj_max_payload
suffix:semicolon
)brace
DECL|function|ether1394_encapsulate
r_static
r_inline
r_int
r_int
id|ether1394_encapsulate
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_int
r_int
id|max_payload
comma
r_union
id|eth1394_hdr
op_star
id|hdr
)paren
(brace
r_union
id|eth1394_hdr
op_star
id|bufhdr
suffix:semicolon
r_int
id|ftype
op_assign
id|hdr-&gt;common.lf
suffix:semicolon
r_int
id|hdrsz
op_assign
id|hdr_type_len
(braket
id|ftype
)braket
suffix:semicolon
r_int
r_int
id|adj_max_payload
op_assign
id|max_payload
op_minus
id|hdrsz
suffix:semicolon
r_switch
c_cond
(paren
id|ftype
)paren
(brace
r_case
id|ETH1394_HDR_LF_UF
suffix:colon
id|bufhdr
op_assign
(paren
r_union
id|eth1394_hdr
op_star
)paren
id|skb_push
c_func
(paren
id|skb
comma
id|hdrsz
)paren
suffix:semicolon
id|bufhdr-&gt;words.word1
op_assign
id|htons
c_func
(paren
id|hdr-&gt;words.word1
)paren
suffix:semicolon
id|bufhdr-&gt;words.word2
op_assign
id|hdr-&gt;words.word2
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ETH1394_HDR_LF_FF
suffix:colon
id|bufhdr
op_assign
(paren
r_union
id|eth1394_hdr
op_star
)paren
id|skb_push
c_func
(paren
id|skb
comma
id|hdrsz
)paren
suffix:semicolon
id|bufhdr-&gt;words.word1
op_assign
id|htons
c_func
(paren
id|hdr-&gt;words.word1
)paren
suffix:semicolon
id|bufhdr-&gt;words.word2
op_assign
id|hdr-&gt;words.word2
suffix:semicolon
id|bufhdr-&gt;words.word3
op_assign
id|htons
c_func
(paren
id|hdr-&gt;words.word3
)paren
suffix:semicolon
id|bufhdr-&gt;words.word4
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Set frag type here for future interior fragments */
id|hdr-&gt;common.lf
op_assign
id|ETH1394_HDR_LF_IF
suffix:semicolon
id|hdr-&gt;sf.fg_off
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|hdr-&gt;sf.fg_off
op_add_assign
id|adj_max_payload
suffix:semicolon
id|bufhdr
op_assign
(paren
r_union
id|eth1394_hdr
op_star
)paren
id|skb_pull
c_func
(paren
id|skb
comma
id|adj_max_payload
)paren
suffix:semicolon
r_if
c_cond
(paren
id|max_payload
op_ge
id|skb-&gt;len
)paren
id|hdr-&gt;common.lf
op_assign
id|ETH1394_HDR_LF_LF
suffix:semicolon
id|bufhdr-&gt;words.word1
op_assign
id|htons
c_func
(paren
id|hdr-&gt;words.word1
)paren
suffix:semicolon
id|bufhdr-&gt;words.word2
op_assign
id|htons
c_func
(paren
id|hdr-&gt;words.word2
)paren
suffix:semicolon
id|bufhdr-&gt;words.word3
op_assign
id|htons
c_func
(paren
id|hdr-&gt;words.word3
)paren
suffix:semicolon
id|bufhdr-&gt;words.word4
op_assign
l_int|0
suffix:semicolon
)brace
r_return
id|min
c_func
(paren
id|max_payload
comma
id|skb-&gt;len
)paren
suffix:semicolon
)brace
DECL|function|ether1394_alloc_common_packet
r_static
r_inline
r_struct
id|hpsb_packet
op_star
id|ether1394_alloc_common_packet
c_func
(paren
r_struct
id|hpsb_host
op_star
id|host
)paren
(brace
r_struct
id|hpsb_packet
op_star
id|p
suffix:semicolon
id|p
op_assign
id|hpsb_alloc_packet
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p
)paren
(brace
id|p-&gt;host
op_assign
id|host
suffix:semicolon
id|p-&gt;generation
op_assign
id|get_hpsb_generation
c_func
(paren
id|host
)paren
suffix:semicolon
id|p-&gt;type
op_assign
id|hpsb_async
suffix:semicolon
)brace
r_return
id|p
suffix:semicolon
)brace
DECL|function|ether1394_prep_write_packet
r_static
r_inline
r_int
id|ether1394_prep_write_packet
c_func
(paren
r_struct
id|hpsb_packet
op_star
id|p
comma
r_struct
id|hpsb_host
op_star
id|host
comma
id|nodeid_t
id|node
comma
id|u64
id|addr
comma
r_void
op_star
id|data
comma
r_int
id|tx_len
)paren
(brace
id|p-&gt;node_id
op_assign
id|node
suffix:semicolon
id|p-&gt;data
op_assign
l_int|NULL
suffix:semicolon
id|p-&gt;tcode
op_assign
id|TCODE_WRITEB
suffix:semicolon
id|p-&gt;header
(braket
l_int|1
)braket
op_assign
(paren
id|host-&gt;node_id
op_lshift
l_int|16
)paren
op_or
(paren
id|addr
op_rshift
l_int|32
)paren
suffix:semicolon
id|p-&gt;header
(braket
l_int|2
)braket
op_assign
id|addr
op_amp
l_int|0xffffffff
suffix:semicolon
id|p-&gt;header_size
op_assign
l_int|16
suffix:semicolon
id|p-&gt;expect_response
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|hpsb_get_tlabel
c_func
(paren
id|p
)paren
)paren
(brace
id|ETH1394_PRINT_G
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;No more tlabels left while sending &quot;
l_string|&quot;to node &quot;
id|NODE_BUS_FMT
l_string|&quot;&bslash;n&quot;
comma
id|NODE_BUS_ARGS
c_func
(paren
id|host
comma
id|node
)paren
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|p-&gt;header
(braket
l_int|0
)braket
op_assign
(paren
id|p-&gt;node_id
op_lshift
l_int|16
)paren
op_or
(paren
id|p-&gt;tlabel
op_lshift
l_int|10
)paren
op_or
(paren
l_int|1
op_lshift
l_int|8
)paren
op_or
(paren
id|TCODE_WRITEB
op_lshift
l_int|4
)paren
suffix:semicolon
id|p-&gt;header
(braket
l_int|3
)braket
op_assign
id|tx_len
op_lshift
l_int|16
suffix:semicolon
id|p-&gt;data_size
op_assign
(paren
id|tx_len
op_plus
l_int|3
)paren
op_amp
op_complement
l_int|3
suffix:semicolon
id|p-&gt;data
op_assign
(paren
id|quadlet_t
op_star
)paren
id|data
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ether1394_prep_gasp_packet
r_static
r_inline
r_void
id|ether1394_prep_gasp_packet
c_func
(paren
r_struct
id|hpsb_packet
op_star
id|p
comma
r_struct
id|eth1394_priv
op_star
id|priv
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_int
id|length
)paren
(brace
id|p-&gt;header_size
op_assign
l_int|4
suffix:semicolon
id|p-&gt;tcode
op_assign
id|TCODE_STREAM_DATA
suffix:semicolon
id|p-&gt;header
(braket
l_int|0
)braket
op_assign
(paren
id|length
op_lshift
l_int|16
)paren
op_or
(paren
l_int|3
op_lshift
l_int|14
)paren
op_or
(paren
(paren
id|priv-&gt;broadcast_channel
)paren
op_lshift
l_int|8
)paren
op_or
(paren
id|TCODE_STREAM_DATA
op_lshift
l_int|4
)paren
suffix:semicolon
id|p-&gt;data_size
op_assign
id|length
suffix:semicolon
id|p-&gt;data
op_assign
(paren
(paren
id|quadlet_t
op_star
)paren
id|skb-&gt;data
)paren
op_minus
l_int|2
suffix:semicolon
id|p-&gt;data
(braket
l_int|0
)braket
op_assign
id|cpu_to_be32
c_func
(paren
(paren
id|priv-&gt;host-&gt;node_id
op_lshift
l_int|16
)paren
op_or
id|ETHER1394_GASP_SPECIFIER_ID_HI
)paren
suffix:semicolon
id|p-&gt;data
(braket
l_int|1
)braket
op_assign
id|__constant_cpu_to_be32
c_func
(paren
(paren
id|ETHER1394_GASP_SPECIFIER_ID_LO
op_lshift
l_int|24
)paren
op_or
id|ETHER1394_GASP_VERSION
)paren
suffix:semicolon
multiline_comment|/* Setting the node id to ALL_NODES (not LOCAL_BUS | ALL_NODES)&n;&t; * prevents hpsb_send_packet() from setting the speed to an arbitrary&n;&t; * value based on packet-&gt;node_id if packet-&gt;node_id is not set. */
id|p-&gt;node_id
op_assign
id|ALL_NODES
suffix:semicolon
id|p-&gt;speed_code
op_assign
id|priv-&gt;bc_sspd
suffix:semicolon
)brace
DECL|function|ether1394_free_packet
r_static
r_inline
r_void
id|ether1394_free_packet
c_func
(paren
r_struct
id|hpsb_packet
op_star
id|packet
)paren
(brace
r_if
c_cond
(paren
id|packet-&gt;tcode
op_ne
id|TCODE_STREAM_DATA
)paren
id|hpsb_free_tlabel
c_func
(paren
id|packet
)paren
suffix:semicolon
id|hpsb_free_packet
c_func
(paren
id|packet
)paren
suffix:semicolon
)brace
r_static
r_void
id|ether1394_complete_cb
c_func
(paren
r_void
op_star
id|__ptask
)paren
suffix:semicolon
DECL|function|ether1394_send_packet
r_static
r_int
id|ether1394_send_packet
c_func
(paren
r_struct
id|packet_task
op_star
id|ptask
comma
r_int
r_int
id|tx_len
)paren
(brace
r_struct
id|eth1394_priv
op_star
id|priv
op_assign
id|ptask-&gt;priv
suffix:semicolon
r_struct
id|hpsb_packet
op_star
id|packet
op_assign
l_int|NULL
suffix:semicolon
id|packet
op_assign
id|ether1394_alloc_common_packet
c_func
(paren
id|priv-&gt;host
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|packet
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|ptask-&gt;tx_type
op_eq
id|ETH1394_GASP
)paren
(brace
r_int
id|length
op_assign
id|tx_len
op_plus
(paren
l_int|2
op_star
r_sizeof
(paren
id|quadlet_t
)paren
)paren
suffix:semicolon
id|ether1394_prep_gasp_packet
c_func
(paren
id|packet
comma
id|priv
comma
id|ptask-&gt;skb
comma
id|length
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ether1394_prep_write_packet
c_func
(paren
id|packet
comma
id|priv-&gt;host
comma
id|ptask-&gt;dest_node
comma
id|ptask-&gt;addr
comma
id|ptask-&gt;skb-&gt;data
comma
id|tx_len
)paren
)paren
(brace
id|hpsb_free_packet
c_func
(paren
id|packet
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|ptask-&gt;packet
op_assign
id|packet
suffix:semicolon
id|hpsb_set_packet_complete_task
c_func
(paren
id|ptask-&gt;packet
comma
id|ether1394_complete_cb
comma
id|ptask
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hpsb_send_packet
c_func
(paren
id|packet
)paren
OL
l_int|0
)paren
(brace
id|ether1394_free_packet
c_func
(paren
id|packet
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Task function to be run when a datagram transmission is completed */
DECL|function|ether1394_dg_complete
r_static
r_inline
r_void
id|ether1394_dg_complete
c_func
(paren
r_struct
id|packet_task
op_star
id|ptask
comma
r_int
id|fail
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
op_assign
id|ptask-&gt;skb
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
id|skb-&gt;dev
suffix:semicolon
r_struct
id|eth1394_priv
op_star
id|priv
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/* Statistics */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fail
)paren
(brace
id|priv-&gt;stats.tx_dropped
op_increment
suffix:semicolon
id|priv-&gt;stats.tx_errors
op_increment
suffix:semicolon
)brace
r_else
(brace
id|priv-&gt;stats.tx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
id|priv-&gt;stats.tx_packets
op_increment
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|dev_kfree_skb_any
c_func
(paren
id|skb
)paren
suffix:semicolon
id|kmem_cache_free
c_func
(paren
id|packet_task_cache
comma
id|ptask
)paren
suffix:semicolon
)brace
multiline_comment|/* Callback for when a packet has been sent and the status of that packet is&n; * known */
DECL|function|ether1394_complete_cb
r_static
r_void
id|ether1394_complete_cb
c_func
(paren
r_void
op_star
id|__ptask
)paren
(brace
r_struct
id|packet_task
op_star
id|ptask
op_assign
(paren
r_struct
id|packet_task
op_star
)paren
id|__ptask
suffix:semicolon
r_struct
id|hpsb_packet
op_star
id|packet
op_assign
id|ptask-&gt;packet
suffix:semicolon
r_int
id|fail
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|packet-&gt;tcode
op_ne
id|TCODE_STREAM_DATA
)paren
id|fail
op_assign
id|hpsb_packet_success
c_func
(paren
id|packet
)paren
suffix:semicolon
id|ether1394_free_packet
c_func
(paren
id|packet
)paren
suffix:semicolon
id|ptask-&gt;outstanding_pkts
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|ptask-&gt;outstanding_pkts
OG
l_int|0
op_logical_and
op_logical_neg
id|fail
)paren
(brace
r_int
id|tx_len
suffix:semicolon
multiline_comment|/* Add the encapsulation header to the fragment */
id|tx_len
op_assign
id|ether1394_encapsulate
c_func
(paren
id|ptask-&gt;skb
comma
id|ptask-&gt;max_payload
comma
op_amp
id|ptask-&gt;hdr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ether1394_send_packet
c_func
(paren
id|ptask
comma
id|tx_len
)paren
)paren
id|ether1394_dg_complete
c_func
(paren
id|ptask
comma
l_int|1
)paren
suffix:semicolon
)brace
r_else
(brace
id|ether1394_dg_complete
c_func
(paren
id|ptask
comma
id|fail
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Transmit a packet (called by kernel) */
DECL|function|ether1394_tx
r_static
r_int
id|ether1394_tx
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_int
id|kmflags
op_assign
id|in_interrupt
c_func
(paren
)paren
ques
c_cond
id|GFP_ATOMIC
suffix:colon
id|GFP_KERNEL
suffix:semicolon
r_struct
id|eth1394hdr
op_star
id|eth
suffix:semicolon
r_struct
id|eth1394_priv
op_star
id|priv
op_assign
id|netdev_priv
c_func
(paren
id|dev
)paren
suffix:semicolon
r_int
id|proto
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|nodeid_t
id|dest_node
suffix:semicolon
id|eth1394_tx_type
id|tx_type
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|tx_len
suffix:semicolon
r_int
r_int
id|max_payload
suffix:semicolon
id|u16
id|dg_size
suffix:semicolon
id|u16
id|dgl
suffix:semicolon
r_struct
id|packet_task
op_star
id|ptask
suffix:semicolon
r_struct
id|eth1394_node_ref
op_star
id|node
suffix:semicolon
r_struct
id|eth1394_node_info
op_star
id|node_info
op_assign
l_int|NULL
suffix:semicolon
id|ptask
op_assign
id|kmem_cache_alloc
c_func
(paren
id|packet_task_cache
comma
id|kmflags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ptask
op_eq
l_int|NULL
)paren
(brace
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|fail
suffix:semicolon
)brace
multiline_comment|/* XXX Ignore this for now. Noticed that when MacOSX is the IRM,&n;&t; * it does not set our validity bit. We need to compensate for&n;&t; * that somewhere else, but not in eth1394. */
macro_line|#if 0
r_if
c_cond
(paren
(paren
id|priv-&gt;host-&gt;csr.broadcast_channel
op_amp
l_int|0xc0000000
)paren
op_ne
l_int|0xc0000000
)paren
(brace
id|ret
op_assign
op_minus
id|EAGAIN
suffix:semicolon
r_goto
id|fail
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
(paren
id|skb
op_assign
id|skb_share_check
(paren
id|skb
comma
id|kmflags
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|fail
suffix:semicolon
)brace
multiline_comment|/* Get rid of the fake eth1394 header, but save a pointer */
id|eth
op_assign
(paren
r_struct
id|eth1394hdr
op_star
)paren
id|skb-&gt;data
suffix:semicolon
id|skb_pull
c_func
(paren
id|skb
comma
id|ETH1394_HLEN
)paren
suffix:semicolon
id|proto
op_assign
id|eth-&gt;h_proto
suffix:semicolon
id|dg_size
op_assign
id|skb-&gt;len
suffix:semicolon
multiline_comment|/* Set the transmission type for the packet.  ARP packets and IP&n;&t; * broadcast packets are sent via GASP. */
r_if
c_cond
(paren
id|memcmp
c_func
(paren
id|eth-&gt;h_dest
comma
id|dev-&gt;broadcast
comma
id|ETH1394_ALEN
)paren
op_eq
l_int|0
op_logical_or
id|proto
op_eq
id|__constant_htons
c_func
(paren
id|ETH_P_ARP
)paren
op_logical_or
(paren
id|proto
op_eq
id|__constant_htons
c_func
(paren
id|ETH_P_IP
)paren
op_logical_and
id|IN_MULTICAST
c_func
(paren
id|__constant_ntohl
c_func
(paren
id|skb-&gt;nh.iph-&gt;daddr
)paren
)paren
)paren
)paren
(brace
id|tx_type
op_assign
id|ETH1394_GASP
suffix:semicolon
id|dest_node
op_assign
id|LOCAL_BUS
op_or
id|ALL_NODES
suffix:semicolon
id|max_payload
op_assign
id|priv-&gt;bc_maxpayload
op_minus
id|ETHER1394_GASP_OVERHEAD
suffix:semicolon
id|BUG_ON
c_func
(paren
id|max_payload
OL
(paren
l_int|512
op_minus
id|ETHER1394_GASP_OVERHEAD
)paren
)paren
suffix:semicolon
id|dgl
op_assign
id|priv-&gt;bc_dgl
suffix:semicolon
r_if
c_cond
(paren
id|max_payload
OL
id|dg_size
op_plus
id|hdr_type_len
(braket
id|ETH1394_HDR_LF_UF
)braket
)paren
id|priv-&gt;bc_dgl
op_increment
suffix:semicolon
)brace
r_else
(brace
id|node
op_assign
id|eth1394_find_node_guid
c_func
(paren
op_amp
id|priv-&gt;ip_node_list
comma
id|be64_to_cpu
c_func
(paren
op_star
(paren
id|u64
op_star
)paren
id|eth-&gt;h_dest
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|node
)paren
(brace
id|ret
op_assign
op_minus
id|EAGAIN
suffix:semicolon
r_goto
id|fail
suffix:semicolon
)brace
id|node_info
op_assign
(paren
r_struct
id|eth1394_node_info
op_star
)paren
id|node-&gt;ud-&gt;device.driver_data
suffix:semicolon
r_if
c_cond
(paren
id|node_info-&gt;fifo
op_eq
id|ETHER1394_INVALID_ADDR
)paren
(brace
id|ret
op_assign
op_minus
id|EAGAIN
suffix:semicolon
r_goto
id|fail
suffix:semicolon
)brace
id|dest_node
op_assign
id|node-&gt;ud-&gt;ne-&gt;nodeid
suffix:semicolon
id|max_payload
op_assign
id|node_info-&gt;maxpayload
suffix:semicolon
id|BUG_ON
c_func
(paren
id|max_payload
OL
(paren
l_int|512
op_minus
id|ETHER1394_GASP_OVERHEAD
)paren
)paren
suffix:semicolon
id|dgl
op_assign
id|node_info-&gt;dgl
suffix:semicolon
r_if
c_cond
(paren
id|max_payload
OL
id|dg_size
op_plus
id|hdr_type_len
(braket
id|ETH1394_HDR_LF_UF
)braket
)paren
id|node_info-&gt;dgl
op_increment
suffix:semicolon
id|tx_type
op_assign
id|ETH1394_WRREQ
suffix:semicolon
)brace
multiline_comment|/* If this is an ARP packet, convert it */
r_if
c_cond
(paren
id|proto
op_eq
id|__constant_htons
(paren
id|ETH_P_ARP
)paren
)paren
id|ether1394_arp_to_1394arp
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
id|ptask-&gt;hdr.words.word1
op_assign
l_int|0
suffix:semicolon
id|ptask-&gt;hdr.words.word2
op_assign
l_int|0
suffix:semicolon
id|ptask-&gt;hdr.words.word3
op_assign
l_int|0
suffix:semicolon
id|ptask-&gt;hdr.words.word4
op_assign
l_int|0
suffix:semicolon
id|ptask-&gt;skb
op_assign
id|skb
suffix:semicolon
id|ptask-&gt;priv
op_assign
id|priv
suffix:semicolon
id|ptask-&gt;tx_type
op_assign
id|tx_type
suffix:semicolon
r_if
c_cond
(paren
id|tx_type
op_ne
id|ETH1394_GASP
)paren
(brace
id|u64
id|addr
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|addr
op_assign
id|node_info-&gt;fifo
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|ptask-&gt;addr
op_assign
id|addr
suffix:semicolon
id|ptask-&gt;dest_node
op_assign
id|dest_node
suffix:semicolon
)brace
id|ptask-&gt;tx_type
op_assign
id|tx_type
suffix:semicolon
id|ptask-&gt;max_payload
op_assign
id|max_payload
suffix:semicolon
id|ptask-&gt;outstanding_pkts
op_assign
id|ether1394_encapsulate_prep
c_func
(paren
id|max_payload
comma
id|proto
comma
op_amp
id|ptask-&gt;hdr
comma
id|dg_size
comma
id|dgl
)paren
suffix:semicolon
multiline_comment|/* Add the encapsulation header to the fragment */
id|tx_len
op_assign
id|ether1394_encapsulate
c_func
(paren
id|skb
comma
id|max_payload
comma
op_amp
id|ptask-&gt;hdr
)paren
suffix:semicolon
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
r_if
c_cond
(paren
id|ether1394_send_packet
c_func
(paren
id|ptask
comma
id|tx_len
)paren
)paren
r_goto
id|fail
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|fail
suffix:colon
r_if
c_cond
(paren
id|ptask
)paren
id|kmem_cache_free
c_func
(paren
id|packet_task_cache
comma
id|ptask
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_ne
l_int|NULL
)paren
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|priv-&gt;stats.tx_dropped
op_increment
suffix:semicolon
id|priv-&gt;stats.tx_errors
op_increment
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|priv-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|netif_queue_stopped
c_func
(paren
id|dev
)paren
)paren
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* returning non-zero causes serious problems */
)brace
DECL|function|ether1394_get_drvinfo
r_static
r_void
id|ether1394_get_drvinfo
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ethtool_drvinfo
op_star
id|info
)paren
(brace
id|strcpy
(paren
id|info-&gt;driver
comma
id|driver_name
)paren
suffix:semicolon
id|strcpy
(paren
id|info-&gt;version
comma
l_string|&quot;$Rev: 1224 $&quot;
)paren
suffix:semicolon
multiline_comment|/* FIXME XXX provide sane businfo */
id|strcpy
(paren
id|info-&gt;bus_info
comma
l_string|&quot;ieee1394&quot;
)paren
suffix:semicolon
)brace
DECL|variable|ethtool_ops
r_static
r_struct
id|ethtool_ops
id|ethtool_ops
op_assign
(brace
dot
id|get_drvinfo
op_assign
id|ether1394_get_drvinfo
)brace
suffix:semicolon
DECL|function|ether1394_init_module
r_static
r_int
id|__init
id|ether1394_init_module
(paren
r_void
)paren
(brace
id|packet_task_cache
op_assign
id|kmem_cache_create
c_func
(paren
l_string|&quot;packet_task&quot;
comma
r_sizeof
(paren
r_struct
id|packet_task
)paren
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/* Register ourselves as a highlevel driver */
id|hpsb_register_highlevel
c_func
(paren
op_amp
id|eth1394_highlevel
)paren
suffix:semicolon
r_return
id|hpsb_register_protocol
c_func
(paren
op_amp
id|eth1394_proto_driver
)paren
suffix:semicolon
)brace
DECL|function|ether1394_exit_module
r_static
r_void
id|__exit
id|ether1394_exit_module
(paren
r_void
)paren
(brace
id|hpsb_unregister_protocol
c_func
(paren
op_amp
id|eth1394_proto_driver
)paren
suffix:semicolon
id|hpsb_unregister_highlevel
c_func
(paren
op_amp
id|eth1394_highlevel
)paren
suffix:semicolon
id|kmem_cache_destroy
c_func
(paren
id|packet_task_cache
)paren
suffix:semicolon
)brace
DECL|variable|ether1394_init_module
id|module_init
c_func
(paren
id|ether1394_init_module
)paren
suffix:semicolon
DECL|variable|ether1394_exit_module
id|module_exit
c_func
(paren
id|ether1394_exit_module
)paren
suffix:semicolon
eof
