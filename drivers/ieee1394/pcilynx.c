multiline_comment|/*&n; * pcilynx.c - Texas Instruments PCILynx driver&n; * Copyright (C) 1999,2000 Andreas Bombe &lt;andreas.bombe@munich.netsurf.de&gt;,&n; *                         Stephan Linz &lt;linz@mazet.de&gt;&n; *                         Manfred Weihs &lt;weihs@ict.tuwien.ac.at&gt;&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or&n; * (at your option) any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software Foundation,&n; * Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.&n; */
multiline_comment|/*&n; * Contributions:&n; *&n; * Manfred Weihs &lt;weihs@ict.tuwien.ac.at&gt;&n; *        reading bus info block (containing GUID) from serial&n; *            eeprom via i2c and storing it in config ROM&n; *        Reworked code for initiating bus resets&n; *            (long, short, with or without hold-off)&n; *        Enhancements in async and iso send code&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/wait.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/moduleparam.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/poll.h&gt;
macro_line|#include &lt;linux/kdev_t.h&gt;
macro_line|#include &lt;asm/byteorder.h&gt;
macro_line|#include &lt;asm/atomic.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &quot;csr1212.h&quot;
macro_line|#include &quot;ieee1394.h&quot;
macro_line|#include &quot;ieee1394_types.h&quot;
macro_line|#include &quot;hosts.h&quot;
macro_line|#include &quot;ieee1394_core.h&quot;
macro_line|#include &quot;highlevel.h&quot;
macro_line|#include &quot;pcilynx.h&quot;
macro_line|#include &lt;linux/i2c.h&gt;
macro_line|#include &lt;linux/i2c-algo-bit.h&gt;
multiline_comment|/* print general (card independent) information */
DECL|macro|PRINT_G
mdefine_line|#define PRINT_G(level, fmt, args...) printk(level &quot;pcilynx: &quot; fmt &quot;&bslash;n&quot; , ## args)
multiline_comment|/* print card specific information */
DECL|macro|PRINT
mdefine_line|#define PRINT(level, card, fmt, args...) printk(level &quot;pcilynx%d: &quot; fmt &quot;&bslash;n&quot; , card , ## args)
macro_line|#ifdef CONFIG_IEEE1394_VERBOSEDEBUG
DECL|macro|PRINT_GD
mdefine_line|#define PRINT_GD(level, fmt, args...) printk(level &quot;pcilynx: &quot; fmt &quot;&bslash;n&quot; , ## args)
DECL|macro|PRINTD
mdefine_line|#define PRINTD(level, card, fmt, args...) printk(level &quot;pcilynx%d: &quot; fmt &quot;&bslash;n&quot; , card , ## args)
macro_line|#else
DECL|macro|PRINT_GD
mdefine_line|#define PRINT_GD(level, fmt, args...) do {} while (0)
DECL|macro|PRINTD
mdefine_line|#define PRINTD(level, card, fmt, args...) do {} while (0)
macro_line|#endif
multiline_comment|/* Module Parameters */
DECL|variable|skip_eeprom
r_static
r_int
id|skip_eeprom
op_assign
l_int|0
suffix:semicolon
id|module_param
c_func
(paren
id|skip_eeprom
comma
r_int
comma
l_int|0444
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|skip_eeprom
comma
l_string|&quot;Use generic bus info block instead of serial eeprom (default = 0).&quot;
)paren
suffix:semicolon
DECL|variable|lynx_driver
r_static
r_struct
id|hpsb_host_driver
id|lynx_driver
suffix:semicolon
DECL|variable|card_id
r_static
r_int
r_int
id|card_id
suffix:semicolon
multiline_comment|/*&n; * I2C stuff&n; */
multiline_comment|/* the i2c stuff was inspired by i2c-philips-par.c */
DECL|function|bit_setscl
r_static
r_void
id|bit_setscl
c_func
(paren
r_void
op_star
id|data
comma
r_int
id|state
)paren
(brace
r_if
c_cond
(paren
id|state
)paren
(brace
(paren
(paren
r_struct
id|ti_lynx
op_star
)paren
id|data
)paren
op_member_access_from_pointer
id|i2c_driven_state
op_or_assign
l_int|0x00000040
suffix:semicolon
)brace
r_else
(brace
(paren
(paren
r_struct
id|ti_lynx
op_star
)paren
id|data
)paren
op_member_access_from_pointer
id|i2c_driven_state
op_and_assign
op_complement
l_int|0x00000040
suffix:semicolon
)brace
id|reg_write
c_func
(paren
(paren
r_struct
id|ti_lynx
op_star
)paren
id|data
comma
id|SERIAL_EEPROM_CONTROL
comma
(paren
(paren
r_struct
id|ti_lynx
op_star
)paren
id|data
)paren
op_member_access_from_pointer
id|i2c_driven_state
)paren
suffix:semicolon
)brace
DECL|function|bit_setsda
r_static
r_void
id|bit_setsda
c_func
(paren
r_void
op_star
id|data
comma
r_int
id|state
)paren
(brace
r_if
c_cond
(paren
id|state
)paren
(brace
(paren
(paren
r_struct
id|ti_lynx
op_star
)paren
id|data
)paren
op_member_access_from_pointer
id|i2c_driven_state
op_or_assign
l_int|0x00000010
suffix:semicolon
)brace
r_else
(brace
(paren
(paren
r_struct
id|ti_lynx
op_star
)paren
id|data
)paren
op_member_access_from_pointer
id|i2c_driven_state
op_and_assign
op_complement
l_int|0x00000010
suffix:semicolon
)brace
id|reg_write
c_func
(paren
(paren
r_struct
id|ti_lynx
op_star
)paren
id|data
comma
id|SERIAL_EEPROM_CONTROL
comma
(paren
(paren
r_struct
id|ti_lynx
op_star
)paren
id|data
)paren
op_member_access_from_pointer
id|i2c_driven_state
)paren
suffix:semicolon
)brace
DECL|function|bit_getscl
r_static
r_int
id|bit_getscl
c_func
(paren
r_void
op_star
id|data
)paren
(brace
r_return
id|reg_read
c_func
(paren
(paren
r_struct
id|ti_lynx
op_star
)paren
id|data
comma
id|SERIAL_EEPROM_CONTROL
)paren
op_amp
l_int|0x00000040
suffix:semicolon
)brace
DECL|function|bit_getsda
r_static
r_int
id|bit_getsda
c_func
(paren
r_void
op_star
id|data
)paren
(brace
r_return
id|reg_read
c_func
(paren
(paren
r_struct
id|ti_lynx
op_star
)paren
id|data
comma
id|SERIAL_EEPROM_CONTROL
)paren
op_amp
l_int|0x00000010
suffix:semicolon
)brace
DECL|function|bit_reg
r_static
r_int
id|bit_reg
c_func
(paren
r_struct
id|i2c_client
op_star
id|client
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|bit_unreg
r_static
r_int
id|bit_unreg
c_func
(paren
r_struct
id|i2c_client
op_star
id|client
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|bit_data
r_static
r_struct
id|i2c_algo_bit_data
id|bit_data
op_assign
(brace
dot
id|setsda
op_assign
id|bit_setsda
comma
dot
id|setscl
op_assign
id|bit_setscl
comma
dot
id|getsda
op_assign
id|bit_getsda
comma
dot
id|getscl
op_assign
id|bit_getscl
comma
dot
id|udelay
op_assign
l_int|5
comma
dot
id|mdelay
op_assign
l_int|5
comma
dot
id|timeout
op_assign
l_int|100
comma
)brace
suffix:semicolon
DECL|variable|bit_ops
r_static
r_struct
id|i2c_adapter
id|bit_ops
op_assign
(brace
dot
id|id
op_assign
l_int|0xAA
comma
singleline_comment|//FIXME: probably we should get an id in i2c-id.h
dot
id|client_register
op_assign
id|bit_reg
comma
dot
id|client_unregister
op_assign
id|bit_unreg
comma
dot
id|name
op_assign
l_string|&quot;PCILynx I2C&quot;
comma
)brace
suffix:semicolon
multiline_comment|/*&n; * PCL handling functions.&n; */
DECL|function|alloc_pcl
r_static
id|pcl_t
id|alloc_pcl
c_func
(paren
r_struct
id|ti_lynx
op_star
id|lynx
)paren
(brace
id|u8
id|m
suffix:semicolon
r_int
id|i
comma
id|j
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|lynx-&gt;lock
)paren
suffix:semicolon
multiline_comment|/* FIXME - use ffz() to make this readable */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|LOCALRAM_SIZE
op_div
l_int|1024
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|m
op_assign
id|lynx-&gt;pcl_bmap
(braket
id|i
)braket
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|8
suffix:semicolon
id|j
op_increment
)paren
(brace
r_if
c_cond
(paren
id|m
op_amp
l_int|1
op_lshift
id|j
)paren
(brace
r_continue
suffix:semicolon
)brace
id|m
op_or_assign
l_int|1
op_lshift
id|j
suffix:semicolon
id|lynx-&gt;pcl_bmap
(braket
id|i
)braket
op_assign
id|m
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|lynx-&gt;lock
)paren
suffix:semicolon
r_return
l_int|8
op_star
id|i
op_plus
id|j
suffix:semicolon
)brace
)brace
id|spin_unlock
c_func
(paren
op_amp
id|lynx-&gt;lock
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
macro_line|#if 0
r_static
r_void
id|free_pcl
c_func
(paren
r_struct
id|ti_lynx
op_star
id|lynx
comma
id|pcl_t
id|pclid
)paren
(brace
r_int
id|off
comma
id|bit
suffix:semicolon
id|off
op_assign
id|pclid
op_div
l_int|8
suffix:semicolon
id|bit
op_assign
id|pclid
op_mod
l_int|8
suffix:semicolon
r_if
c_cond
(paren
id|pclid
OL
l_int|0
)paren
(brace
r_return
suffix:semicolon
)brace
id|spin_lock
c_func
(paren
op_amp
id|lynx-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lynx-&gt;pcl_bmap
(braket
id|off
)braket
op_amp
l_int|1
op_lshift
id|bit
)paren
(brace
id|lynx-&gt;pcl_bmap
(braket
id|off
)braket
op_and_assign
op_complement
(paren
l_int|1
op_lshift
id|bit
)paren
suffix:semicolon
)brace
r_else
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|lynx-&gt;id
comma
l_string|&quot;attempted to free unallocated PCL %d&quot;
comma
id|pclid
)paren
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|lynx-&gt;lock
)paren
suffix:semicolon
)brace
multiline_comment|/* functions useful for debugging */
r_static
r_void
id|pretty_print_pcl
c_func
(paren
r_const
r_struct
id|ti_pcl
op_star
id|pcl
)paren
(brace
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;PCL next %08x, userdata %08x, status %08x, remtrans %08x, nextbuf %08x&bslash;n&quot;
comma
id|pcl-&gt;next
comma
id|pcl-&gt;user_data
comma
id|pcl-&gt;pcl_status
comma
id|pcl-&gt;remaining_transfer_count
comma
id|pcl-&gt;next_data_buffer
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;PCL&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|13
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot; c%x:%08x d%x:%08x&quot;
comma
id|i
comma
id|pcl-&gt;buffer
(braket
id|i
)braket
dot
id|control
comma
id|i
comma
id|pcl-&gt;buffer
(braket
id|i
)braket
dot
id|pointer
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|i
op_amp
l_int|0x3
)paren
op_logical_and
(paren
id|i
op_ne
l_int|12
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;&bslash;nPCL&quot;
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_static
r_void
id|print_pcl
c_func
(paren
r_const
r_struct
id|ti_lynx
op_star
id|lynx
comma
id|pcl_t
id|pclid
)paren
(brace
r_struct
id|ti_pcl
id|pcl
suffix:semicolon
id|get_pcl
c_func
(paren
id|lynx
comma
id|pclid
comma
op_amp
id|pcl
)paren
suffix:semicolon
id|pretty_print_pcl
c_func
(paren
op_amp
id|pcl
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/***********************************&n; * IEEE-1394 functionality section *&n; ***********************************/
DECL|function|get_phy_reg
r_static
r_int
id|get_phy_reg
c_func
(paren
r_struct
id|ti_lynx
op_star
id|lynx
comma
r_int
id|addr
)paren
(brace
r_int
id|retval
suffix:semicolon
r_int
id|i
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|addr
OG
l_int|15
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|lynx-&gt;id
comma
l_string|&quot;%s: PHY register address %d out of range&quot;
comma
id|__FUNCTION__
comma
id|addr
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|lynx-&gt;phy_reg_lock
comma
id|flags
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|lynx
comma
id|LINK_PHY
comma
id|LINK_PHY_READ
op_or
id|LINK_PHY_ADDR
c_func
(paren
id|addr
)paren
)paren
suffix:semicolon
r_do
(brace
id|retval
op_assign
id|reg_read
c_func
(paren
id|lynx
comma
id|LINK_PHY
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OG
l_int|10000
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|lynx-&gt;id
comma
l_string|&quot;%s: runaway loop, aborting&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|retval
op_assign
op_minus
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
id|i
op_increment
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|retval
op_amp
l_int|0xf00
)paren
op_ne
id|LINK_PHY_RADDR
c_func
(paren
id|addr
)paren
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|lynx
comma
id|LINK_INT_STATUS
comma
id|LINK_INT_PHY_REG_RCVD
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|lynx-&gt;phy_reg_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
op_ne
op_minus
l_int|1
)paren
(brace
r_return
id|retval
op_amp
l_int|0xff
suffix:semicolon
)brace
r_else
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
)brace
DECL|function|set_phy_reg
r_static
r_int
id|set_phy_reg
c_func
(paren
r_struct
id|ti_lynx
op_star
id|lynx
comma
r_int
id|addr
comma
r_int
id|val
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|addr
OG
l_int|15
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|lynx-&gt;id
comma
l_string|&quot;%s: PHY register address %d out of range&quot;
comma
id|__FUNCTION__
comma
id|addr
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|val
OG
l_int|0xff
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|lynx-&gt;id
comma
l_string|&quot;%s: PHY register value %d out of range&quot;
comma
id|__FUNCTION__
comma
id|val
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|lynx-&gt;phy_reg_lock
comma
id|flags
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|lynx
comma
id|LINK_PHY
comma
id|LINK_PHY_WRITE
op_or
id|LINK_PHY_ADDR
c_func
(paren
id|addr
)paren
op_or
id|LINK_PHY_WDATA
c_func
(paren
id|val
)paren
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|lynx-&gt;phy_reg_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sel_phy_reg_page
r_static
r_int
id|sel_phy_reg_page
c_func
(paren
r_struct
id|ti_lynx
op_star
id|lynx
comma
r_int
id|page
)paren
(brace
r_int
id|reg
suffix:semicolon
r_if
c_cond
(paren
id|page
OG
l_int|7
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|lynx-&gt;id
comma
l_string|&quot;%s: PHY page %d out of range&quot;
comma
id|__FUNCTION__
comma
id|page
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|reg
op_assign
id|get_phy_reg
c_func
(paren
id|lynx
comma
l_int|7
)paren
suffix:semicolon
r_if
c_cond
(paren
id|reg
op_ne
op_minus
l_int|1
)paren
(brace
id|reg
op_and_assign
l_int|0x1f
suffix:semicolon
id|reg
op_or_assign
(paren
id|page
op_lshift
l_int|5
)paren
suffix:semicolon
id|set_phy_reg
c_func
(paren
id|lynx
comma
l_int|7
comma
id|reg
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
)brace
macro_line|#if 0 /* not needed at this time */
r_static
r_int
id|sel_phy_reg_port
c_func
(paren
r_struct
id|ti_lynx
op_star
id|lynx
comma
r_int
id|port
)paren
(brace
r_int
id|reg
suffix:semicolon
r_if
c_cond
(paren
id|port
OG
l_int|15
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|lynx-&gt;id
comma
l_string|&quot;%s: PHY port %d out of range&quot;
comma
id|__FUNCTION__
comma
id|port
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|reg
op_assign
id|get_phy_reg
c_func
(paren
id|lynx
comma
l_int|7
)paren
suffix:semicolon
r_if
c_cond
(paren
id|reg
op_ne
op_minus
l_int|1
)paren
(brace
id|reg
op_and_assign
l_int|0xf0
suffix:semicolon
id|reg
op_or_assign
id|port
suffix:semicolon
id|set_phy_reg
c_func
(paren
id|lynx
comma
l_int|7
comma
id|reg
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
)brace
macro_line|#endif
DECL|function|get_phy_vendorid
r_static
id|u32
id|get_phy_vendorid
c_func
(paren
r_struct
id|ti_lynx
op_star
id|lynx
)paren
(brace
id|u32
id|pvid
op_assign
l_int|0
suffix:semicolon
id|sel_phy_reg_page
c_func
(paren
id|lynx
comma
l_int|1
)paren
suffix:semicolon
id|pvid
op_or_assign
(paren
id|get_phy_reg
c_func
(paren
id|lynx
comma
l_int|10
)paren
op_lshift
l_int|16
)paren
suffix:semicolon
id|pvid
op_or_assign
(paren
id|get_phy_reg
c_func
(paren
id|lynx
comma
l_int|11
)paren
op_lshift
l_int|8
)paren
suffix:semicolon
id|pvid
op_or_assign
id|get_phy_reg
c_func
(paren
id|lynx
comma
l_int|12
)paren
suffix:semicolon
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|lynx-&gt;id
comma
l_string|&quot;PHY vendor id 0x%06x&quot;
comma
id|pvid
)paren
suffix:semicolon
r_return
id|pvid
suffix:semicolon
)brace
DECL|function|get_phy_productid
r_static
id|u32
id|get_phy_productid
c_func
(paren
r_struct
id|ti_lynx
op_star
id|lynx
)paren
(brace
id|u32
id|id
op_assign
l_int|0
suffix:semicolon
id|sel_phy_reg_page
c_func
(paren
id|lynx
comma
l_int|1
)paren
suffix:semicolon
id|id
op_or_assign
(paren
id|get_phy_reg
c_func
(paren
id|lynx
comma
l_int|13
)paren
op_lshift
l_int|16
)paren
suffix:semicolon
id|id
op_or_assign
(paren
id|get_phy_reg
c_func
(paren
id|lynx
comma
l_int|14
)paren
op_lshift
l_int|8
)paren
suffix:semicolon
id|id
op_or_assign
id|get_phy_reg
c_func
(paren
id|lynx
comma
l_int|15
)paren
suffix:semicolon
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|lynx-&gt;id
comma
l_string|&quot;PHY product id 0x%06x&quot;
comma
id|id
)paren
suffix:semicolon
r_return
id|id
suffix:semicolon
)brace
DECL|function|generate_own_selfid
r_static
id|quadlet_t
id|generate_own_selfid
c_func
(paren
r_struct
id|ti_lynx
op_star
id|lynx
comma
r_struct
id|hpsb_host
op_star
id|host
)paren
(brace
id|quadlet_t
id|lsid
suffix:semicolon
r_char
id|phyreg
(braket
l_int|7
)braket
suffix:semicolon
r_int
id|i
suffix:semicolon
id|phyreg
(braket
l_int|0
)braket
op_assign
id|lynx-&gt;phy_reg0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
l_int|7
suffix:semicolon
id|i
op_increment
)paren
(brace
id|phyreg
(braket
id|i
)braket
op_assign
id|get_phy_reg
c_func
(paren
id|lynx
comma
id|i
)paren
suffix:semicolon
)brace
multiline_comment|/* FIXME? We assume a TSB21LV03A phy here.  This code doesn&squot;t support&n;           more than 3 ports on the PHY anyway. */
id|lsid
op_assign
l_int|0x80400000
op_or
(paren
(paren
id|phyreg
(braket
l_int|0
)braket
op_amp
l_int|0xfc
)paren
op_lshift
l_int|22
)paren
suffix:semicolon
id|lsid
op_or_assign
(paren
id|phyreg
(braket
l_int|1
)braket
op_amp
l_int|0x3f
)paren
op_lshift
l_int|16
suffix:semicolon
multiline_comment|/* gap count */
id|lsid
op_or_assign
(paren
id|phyreg
(braket
l_int|2
)braket
op_amp
l_int|0xc0
)paren
op_lshift
l_int|8
suffix:semicolon
multiline_comment|/* max speed */
r_if
c_cond
(paren
op_logical_neg
id|hpsb_disable_irm
)paren
id|lsid
op_or_assign
(paren
id|phyreg
(braket
l_int|6
)braket
op_amp
l_int|0x01
)paren
op_lshift
l_int|11
suffix:semicolon
multiline_comment|/* contender (phy dependent) */
multiline_comment|/* lsid |= 1 &lt;&lt; 11; */
multiline_comment|/* set contender (hack) */
id|lsid
op_or_assign
(paren
id|phyreg
(braket
l_int|6
)braket
op_amp
l_int|0x10
)paren
op_rshift
l_int|3
suffix:semicolon
multiline_comment|/* initiated reset */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|phyreg
(braket
l_int|2
)braket
op_amp
l_int|0xf
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* ports */
r_if
c_cond
(paren
id|phyreg
(braket
l_int|3
op_plus
id|i
)braket
op_amp
l_int|0x4
)paren
(brace
id|lsid
op_or_assign
(paren
(paren
(paren
id|phyreg
(braket
l_int|3
op_plus
id|i
)braket
op_amp
l_int|0x8
)paren
op_or
l_int|0x10
)paren
op_rshift
l_int|3
)paren
op_lshift
(paren
l_int|6
op_minus
id|i
op_star
l_int|2
)paren
suffix:semicolon
)brace
r_else
(brace
id|lsid
op_or_assign
l_int|1
op_lshift
(paren
l_int|6
op_minus
id|i
op_star
l_int|2
)paren
suffix:semicolon
)brace
)brace
id|cpu_to_be32s
c_func
(paren
op_amp
id|lsid
)paren
suffix:semicolon
id|PRINT
c_func
(paren
id|KERN_DEBUG
comma
id|lynx-&gt;id
comma
l_string|&quot;generated own selfid 0x%x&quot;
comma
id|lsid
)paren
suffix:semicolon
r_return
id|lsid
suffix:semicolon
)brace
DECL|function|handle_selfid
r_static
r_void
id|handle_selfid
c_func
(paren
r_struct
id|ti_lynx
op_star
id|lynx
comma
r_struct
id|hpsb_host
op_star
id|host
)paren
(brace
id|quadlet_t
op_star
id|q
op_assign
id|lynx-&gt;rcv_page
suffix:semicolon
r_int
id|phyid
comma
id|isroot
comma
id|size
suffix:semicolon
id|quadlet_t
id|lsid
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|lynx-&gt;phy_reg0
op_eq
op_minus
l_int|1
op_logical_or
id|lynx-&gt;selfid_size
op_eq
op_minus
l_int|1
)paren
r_return
suffix:semicolon
id|size
op_assign
id|lynx-&gt;selfid_size
suffix:semicolon
id|phyid
op_assign
id|lynx-&gt;phy_reg0
suffix:semicolon
id|i
op_assign
(paren
id|size
OG
l_int|16
ques
c_cond
l_int|16
suffix:colon
id|size
)paren
op_div
l_int|4
op_minus
l_int|1
suffix:semicolon
r_while
c_loop
(paren
id|i
op_ge
l_int|0
)paren
(brace
id|cpu_to_be32s
c_func
(paren
op_amp
id|q
(braket
id|i
)braket
)paren
suffix:semicolon
id|i
op_decrement
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|lynx-&gt;phyic.reg_1394a
)paren
(brace
id|lsid
op_assign
id|generate_own_selfid
c_func
(paren
id|lynx
comma
id|host
)paren
suffix:semicolon
)brace
id|isroot
op_assign
(paren
id|phyid
op_amp
l_int|2
)paren
op_ne
l_int|0
suffix:semicolon
id|phyid
op_rshift_assign
l_int|2
suffix:semicolon
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|lynx-&gt;id
comma
l_string|&quot;SelfID process finished (phyid %d, %s)&quot;
comma
id|phyid
comma
(paren
id|isroot
ques
c_cond
l_string|&quot;root&quot;
suffix:colon
l_string|&quot;not root&quot;
)paren
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|lynx
comma
id|LINK_ID
comma
(paren
l_int|0xffc0
op_or
id|phyid
)paren
op_lshift
l_int|16
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|lynx-&gt;phyic.reg_1394a
op_logical_and
op_logical_neg
id|size
)paren
(brace
id|hpsb_selfid_received
c_func
(paren
id|host
comma
id|lsid
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|size
OG
l_int|0
)paren
(brace
r_struct
id|selfid
op_star
id|sid
op_assign
(paren
r_struct
id|selfid
op_star
)paren
id|q
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|lynx-&gt;phyic.reg_1394a
op_logical_and
op_logical_neg
id|sid-&gt;extended
op_logical_and
(paren
id|sid-&gt;phy_id
op_eq
(paren
id|phyid
op_plus
l_int|1
)paren
)paren
)paren
(brace
id|hpsb_selfid_received
c_func
(paren
id|host
comma
id|lsid
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|q
(braket
l_int|0
)braket
op_eq
op_complement
id|q
(braket
l_int|1
)braket
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_DEBUG
comma
id|lynx-&gt;id
comma
l_string|&quot;SelfID packet 0x%x rcvd&quot;
comma
id|q
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|hpsb_selfid_received
c_func
(paren
id|host
comma
id|q
(braket
l_int|0
)braket
)paren
suffix:semicolon
)brace
r_else
(brace
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|lynx-&gt;id
comma
l_string|&quot;inconsistent selfid 0x%x/0x%x&quot;
comma
id|q
(braket
l_int|0
)braket
comma
id|q
(braket
l_int|1
)braket
)paren
suffix:semicolon
)brace
id|q
op_add_assign
l_int|2
suffix:semicolon
id|size
op_sub_assign
l_int|8
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|lynx-&gt;phyic.reg_1394a
op_logical_and
id|isroot
op_logical_and
id|phyid
op_ne
l_int|0
)paren
(brace
id|hpsb_selfid_received
c_func
(paren
id|host
comma
id|lsid
)paren
suffix:semicolon
)brace
id|hpsb_selfid_complete
c_func
(paren
id|host
comma
id|phyid
comma
id|isroot
)paren
suffix:semicolon
r_if
c_cond
(paren
id|host-&gt;in_bus_reset
)paren
r_return
suffix:semicolon
multiline_comment|/* in bus reset again */
r_if
c_cond
(paren
id|isroot
)paren
id|reg_set_bits
c_func
(paren
id|lynx
comma
id|LINK_CONTROL
comma
id|LINK_CONTROL_CYCMASTER
)paren
suffix:semicolon
singleline_comment|//FIXME: I do not think, we need this here
id|reg_set_bits
c_func
(paren
id|lynx
comma
id|LINK_CONTROL
comma
id|LINK_CONTROL_RCV_CMP_VALID
op_or
id|LINK_CONTROL_TX_ASYNC_EN
op_or
id|LINK_CONTROL_RX_ASYNC_EN
op_or
id|LINK_CONTROL_CYCTIMEREN
)paren
suffix:semicolon
)brace
multiline_comment|/* This must be called with the respective queue_lock held. */
DECL|function|send_next
r_static
r_void
id|send_next
c_func
(paren
r_struct
id|ti_lynx
op_star
id|lynx
comma
r_int
id|what
)paren
(brace
r_struct
id|ti_pcl
id|pcl
suffix:semicolon
r_struct
id|lynx_send_data
op_star
id|d
suffix:semicolon
r_struct
id|hpsb_packet
op_star
id|packet
suffix:semicolon
id|d
op_assign
(paren
id|what
op_eq
id|hpsb_iso
ques
c_cond
op_amp
id|lynx-&gt;iso_send
suffix:colon
op_amp
id|lynx-&gt;async
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|d-&gt;pcl_queue
)paren
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|lynx-&gt;id
comma
l_string|&quot;trying to queue a new packet in nonempty fifo&quot;
)paren
suffix:semicolon
id|BUG
c_func
(paren
)paren
suffix:semicolon
)brace
id|packet
op_assign
id|driver_packet
c_func
(paren
id|d-&gt;queue.next
)paren
suffix:semicolon
id|list_move_tail
c_func
(paren
op_amp
id|packet-&gt;driver_list
comma
op_amp
id|d-&gt;pcl_queue
)paren
suffix:semicolon
id|d-&gt;header_dma
op_assign
id|pci_map_single
c_func
(paren
id|lynx-&gt;dev
comma
id|packet-&gt;header
comma
id|packet-&gt;header_size
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|packet-&gt;data_size
)paren
(brace
id|d-&gt;data_dma
op_assign
id|pci_map_single
c_func
(paren
id|lynx-&gt;dev
comma
id|packet-&gt;data
comma
id|packet-&gt;data_size
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
)brace
r_else
(brace
id|d-&gt;data_dma
op_assign
l_int|0
suffix:semicolon
)brace
id|pcl.next
op_assign
id|PCL_NEXT_INVALID
suffix:semicolon
id|pcl.async_error_next
op_assign
id|PCL_NEXT_INVALID
suffix:semicolon
id|pcl.pcl_status
op_assign
l_int|0
suffix:semicolon
id|pcl.buffer
(braket
l_int|0
)braket
dot
id|control
op_assign
id|packet-&gt;speed_code
op_lshift
l_int|14
op_or
id|packet-&gt;header_size
suffix:semicolon
macro_line|#ifndef __BIG_ENDIAN
id|pcl.buffer
(braket
l_int|0
)braket
dot
id|control
op_or_assign
id|PCL_BIGENDIAN
suffix:semicolon
macro_line|#endif
id|pcl.buffer
(braket
l_int|0
)braket
dot
id|pointer
op_assign
id|d-&gt;header_dma
suffix:semicolon
id|pcl.buffer
(braket
l_int|1
)braket
dot
id|control
op_assign
id|PCL_LAST_BUFF
op_or
id|packet-&gt;data_size
suffix:semicolon
id|pcl.buffer
(braket
l_int|1
)braket
dot
id|pointer
op_assign
id|d-&gt;data_dma
suffix:semicolon
r_switch
c_cond
(paren
id|packet-&gt;type
)paren
(brace
r_case
id|hpsb_async
suffix:colon
id|pcl.buffer
(braket
l_int|0
)braket
dot
id|control
op_or_assign
id|PCL_CMD_XMT
suffix:semicolon
r_break
suffix:semicolon
r_case
id|hpsb_iso
suffix:colon
id|pcl.buffer
(braket
l_int|0
)braket
dot
id|control
op_or_assign
id|PCL_CMD_XMT
op_or
id|PCL_ISOMODE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|hpsb_raw
suffix:colon
id|pcl.buffer
(braket
l_int|0
)braket
dot
id|control
op_or_assign
id|PCL_CMD_UNFXMT
suffix:semicolon
r_break
suffix:semicolon
)brace
id|put_pcl
c_func
(paren
id|lynx
comma
id|d-&gt;pcl
comma
op_amp
id|pcl
)paren
suffix:semicolon
id|run_pcl
c_func
(paren
id|lynx
comma
id|d-&gt;pcl_start
comma
id|d-&gt;channel
)paren
suffix:semicolon
)brace
multiline_comment|/* called from subsystem core */
DECL|function|lynx_transmit
r_static
r_int
id|lynx_transmit
c_func
(paren
r_struct
id|hpsb_host
op_star
id|host
comma
r_struct
id|hpsb_packet
op_star
id|packet
)paren
(brace
r_struct
id|ti_lynx
op_star
id|lynx
op_assign
id|host-&gt;hostdata
suffix:semicolon
r_struct
id|lynx_send_data
op_star
id|d
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|packet-&gt;data_size
op_ge
l_int|4096
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|lynx-&gt;id
comma
l_string|&quot;transmit packet data too big (%Zd)&quot;
comma
id|packet-&gt;data_size
)paren
suffix:semicolon
r_return
op_minus
id|EOVERFLOW
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|packet-&gt;type
)paren
(brace
r_case
id|hpsb_async
suffix:colon
r_case
id|hpsb_raw
suffix:colon
id|d
op_assign
op_amp
id|lynx-&gt;async
suffix:semicolon
r_break
suffix:semicolon
r_case
id|hpsb_iso
suffix:colon
id|d
op_assign
op_amp
id|lynx-&gt;iso_send
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|lynx-&gt;id
comma
l_string|&quot;invalid packet type %d&quot;
comma
id|packet-&gt;type
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|packet-&gt;tcode
op_eq
id|TCODE_WRITEQ
op_logical_or
id|packet-&gt;tcode
op_eq
id|TCODE_READQ_RESPONSE
)paren
(brace
id|cpu_to_be32s
c_func
(paren
op_amp
id|packet-&gt;header
(braket
l_int|3
)braket
)paren
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|d-&gt;queue_lock
comma
id|flags
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|packet-&gt;driver_list
comma
op_amp
id|d-&gt;queue
)paren
suffix:semicolon
r_if
c_cond
(paren
id|list_empty
c_func
(paren
op_amp
id|d-&gt;pcl_queue
)paren
)paren
id|send_next
c_func
(paren
id|lynx
comma
id|packet-&gt;type
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|d-&gt;queue_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* called from subsystem core */
DECL|function|lynx_devctl
r_static
r_int
id|lynx_devctl
c_func
(paren
r_struct
id|hpsb_host
op_star
id|host
comma
r_enum
id|devctl_cmd
id|cmd
comma
r_int
id|arg
)paren
(brace
r_struct
id|ti_lynx
op_star
id|lynx
op_assign
id|host-&gt;hostdata
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_struct
id|hpsb_packet
op_star
id|packet
suffix:semicolon
id|LIST_HEAD
c_func
(paren
id|packet_list
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|phy_reg
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|RESET_BUS
suffix:colon
r_if
c_cond
(paren
id|reg_read
c_func
(paren
id|lynx
comma
id|LINK_INT_STATUS
)paren
op_amp
id|LINK_INT_PHY_BUSRESET
)paren
(brace
id|retval
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|arg
)paren
(brace
r_case
id|SHORT_RESET
suffix:colon
r_if
c_cond
(paren
id|lynx-&gt;phyic.reg_1394a
)paren
(brace
id|phy_reg
op_assign
id|get_phy_reg
c_func
(paren
id|lynx
comma
l_int|5
)paren
suffix:semicolon
r_if
c_cond
(paren
id|phy_reg
op_eq
op_minus
l_int|1
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|lynx-&gt;id
comma
l_string|&quot;cannot reset bus, because read phy reg failed&quot;
)paren
suffix:semicolon
id|retval
op_assign
op_minus
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
id|phy_reg
op_or_assign
l_int|0x40
suffix:semicolon
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|lynx-&gt;id
comma
l_string|&quot;resetting bus (short bus reset) on request&quot;
)paren
suffix:semicolon
id|lynx-&gt;selfid_size
op_assign
op_minus
l_int|1
suffix:semicolon
id|lynx-&gt;phy_reg0
op_assign
op_minus
l_int|1
suffix:semicolon
id|set_phy_reg
c_func
(paren
id|lynx
comma
l_int|5
comma
id|phy_reg
)paren
suffix:semicolon
multiline_comment|/* set ISBR */
r_break
suffix:semicolon
)brace
r_else
(brace
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|lynx-&gt;id
comma
l_string|&quot;cannot do short bus reset, because of old phy&quot;
)paren
suffix:semicolon
multiline_comment|/* fall through to long bus reset */
)brace
r_case
id|LONG_RESET
suffix:colon
id|phy_reg
op_assign
id|get_phy_reg
c_func
(paren
id|lynx
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|phy_reg
op_eq
op_minus
l_int|1
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|lynx-&gt;id
comma
l_string|&quot;cannot reset bus, because read phy reg failed&quot;
)paren
suffix:semicolon
id|retval
op_assign
op_minus
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
id|phy_reg
op_or_assign
l_int|0x40
suffix:semicolon
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|lynx-&gt;id
comma
l_string|&quot;resetting bus (long bus reset) on request&quot;
)paren
suffix:semicolon
id|lynx-&gt;selfid_size
op_assign
op_minus
l_int|1
suffix:semicolon
id|lynx-&gt;phy_reg0
op_assign
op_minus
l_int|1
suffix:semicolon
id|set_phy_reg
c_func
(paren
id|lynx
comma
l_int|1
comma
id|phy_reg
)paren
suffix:semicolon
multiline_comment|/* clear RHB, set IBR */
r_break
suffix:semicolon
r_case
id|SHORT_RESET_NO_FORCE_ROOT
suffix:colon
r_if
c_cond
(paren
id|lynx-&gt;phyic.reg_1394a
)paren
(brace
id|phy_reg
op_assign
id|get_phy_reg
c_func
(paren
id|lynx
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|phy_reg
op_eq
op_minus
l_int|1
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|lynx-&gt;id
comma
l_string|&quot;cannot reset bus, because read phy reg failed&quot;
)paren
suffix:semicolon
id|retval
op_assign
op_minus
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|phy_reg
op_amp
l_int|0x80
)paren
(brace
id|phy_reg
op_and_assign
op_complement
l_int|0x80
suffix:semicolon
id|set_phy_reg
c_func
(paren
id|lynx
comma
l_int|1
comma
id|phy_reg
)paren
suffix:semicolon
multiline_comment|/* clear RHB */
)brace
id|phy_reg
op_assign
id|get_phy_reg
c_func
(paren
id|lynx
comma
l_int|5
)paren
suffix:semicolon
r_if
c_cond
(paren
id|phy_reg
op_eq
op_minus
l_int|1
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|lynx-&gt;id
comma
l_string|&quot;cannot reset bus, because read phy reg failed&quot;
)paren
suffix:semicolon
id|retval
op_assign
op_minus
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
id|phy_reg
op_or_assign
l_int|0x40
suffix:semicolon
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|lynx-&gt;id
comma
l_string|&quot;resetting bus (short bus reset, no force_root) on request&quot;
)paren
suffix:semicolon
id|lynx-&gt;selfid_size
op_assign
op_minus
l_int|1
suffix:semicolon
id|lynx-&gt;phy_reg0
op_assign
op_minus
l_int|1
suffix:semicolon
id|set_phy_reg
c_func
(paren
id|lynx
comma
l_int|5
comma
id|phy_reg
)paren
suffix:semicolon
multiline_comment|/* set ISBR */
r_break
suffix:semicolon
)brace
r_else
(brace
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|lynx-&gt;id
comma
l_string|&quot;cannot do short bus reset, because of old phy&quot;
)paren
suffix:semicolon
multiline_comment|/* fall through to long bus reset */
)brace
r_case
id|LONG_RESET_NO_FORCE_ROOT
suffix:colon
id|phy_reg
op_assign
id|get_phy_reg
c_func
(paren
id|lynx
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|phy_reg
op_eq
op_minus
l_int|1
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|lynx-&gt;id
comma
l_string|&quot;cannot reset bus, because read phy reg failed&quot;
)paren
suffix:semicolon
id|retval
op_assign
op_minus
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
id|phy_reg
op_and_assign
op_complement
l_int|0x80
suffix:semicolon
id|phy_reg
op_or_assign
l_int|0x40
suffix:semicolon
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|lynx-&gt;id
comma
l_string|&quot;resetting bus (long bus reset, no force_root) on request&quot;
)paren
suffix:semicolon
id|lynx-&gt;selfid_size
op_assign
op_minus
l_int|1
suffix:semicolon
id|lynx-&gt;phy_reg0
op_assign
op_minus
l_int|1
suffix:semicolon
id|set_phy_reg
c_func
(paren
id|lynx
comma
l_int|1
comma
id|phy_reg
)paren
suffix:semicolon
multiline_comment|/* clear RHB, set IBR */
r_break
suffix:semicolon
r_case
id|SHORT_RESET_FORCE_ROOT
suffix:colon
r_if
c_cond
(paren
id|lynx-&gt;phyic.reg_1394a
)paren
(brace
id|phy_reg
op_assign
id|get_phy_reg
c_func
(paren
id|lynx
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|phy_reg
op_eq
op_minus
l_int|1
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|lynx-&gt;id
comma
l_string|&quot;cannot reset bus, because read phy reg failed&quot;
)paren
suffix:semicolon
id|retval
op_assign
op_minus
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|phy_reg
op_amp
l_int|0x80
)paren
)paren
(brace
id|phy_reg
op_or_assign
l_int|0x80
suffix:semicolon
id|set_phy_reg
c_func
(paren
id|lynx
comma
l_int|1
comma
id|phy_reg
)paren
suffix:semicolon
multiline_comment|/* set RHB */
)brace
id|phy_reg
op_assign
id|get_phy_reg
c_func
(paren
id|lynx
comma
l_int|5
)paren
suffix:semicolon
r_if
c_cond
(paren
id|phy_reg
op_eq
op_minus
l_int|1
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|lynx-&gt;id
comma
l_string|&quot;cannot reset bus, because read phy reg failed&quot;
)paren
suffix:semicolon
id|retval
op_assign
op_minus
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
id|phy_reg
op_or_assign
l_int|0x40
suffix:semicolon
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|lynx-&gt;id
comma
l_string|&quot;resetting bus (short bus reset, force_root set) on request&quot;
)paren
suffix:semicolon
id|lynx-&gt;selfid_size
op_assign
op_minus
l_int|1
suffix:semicolon
id|lynx-&gt;phy_reg0
op_assign
op_minus
l_int|1
suffix:semicolon
id|set_phy_reg
c_func
(paren
id|lynx
comma
l_int|5
comma
id|phy_reg
)paren
suffix:semicolon
multiline_comment|/* set ISBR */
r_break
suffix:semicolon
)brace
r_else
(brace
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|lynx-&gt;id
comma
l_string|&quot;cannot do short bus reset, because of old phy&quot;
)paren
suffix:semicolon
multiline_comment|/* fall through to long bus reset */
)brace
r_case
id|LONG_RESET_FORCE_ROOT
suffix:colon
id|phy_reg
op_assign
id|get_phy_reg
c_func
(paren
id|lynx
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|phy_reg
op_eq
op_minus
l_int|1
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|lynx-&gt;id
comma
l_string|&quot;cannot reset bus, because read phy reg failed&quot;
)paren
suffix:semicolon
id|retval
op_assign
op_minus
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
id|phy_reg
op_or_assign
l_int|0xc0
suffix:semicolon
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|lynx-&gt;id
comma
l_string|&quot;resetting bus (long bus reset, force_root set) on request&quot;
)paren
suffix:semicolon
id|lynx-&gt;selfid_size
op_assign
op_minus
l_int|1
suffix:semicolon
id|lynx-&gt;phy_reg0
op_assign
op_minus
l_int|1
suffix:semicolon
id|set_phy_reg
c_func
(paren
id|lynx
comma
l_int|1
comma
id|phy_reg
)paren
suffix:semicolon
multiline_comment|/* set IBR and RHB */
r_break
suffix:semicolon
r_default
suffix:colon
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|lynx-&gt;id
comma
l_string|&quot;unknown argument for reset_bus command %d&quot;
comma
id|arg
)paren
suffix:semicolon
id|retval
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|GET_CYCLE_COUNTER
suffix:colon
id|retval
op_assign
id|reg_read
c_func
(paren
id|lynx
comma
id|CYCLE_TIMER
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SET_CYCLE_COUNTER
suffix:colon
id|reg_write
c_func
(paren
id|lynx
comma
id|CYCLE_TIMER
comma
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SET_BUS_ID
suffix:colon
id|reg_write
c_func
(paren
id|lynx
comma
id|LINK_ID
comma
(paren
id|arg
op_lshift
l_int|22
)paren
op_or
(paren
id|reg_read
c_func
(paren
id|lynx
comma
id|LINK_ID
)paren
op_amp
l_int|0x003f0000
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACT_CYCLE_MASTER
suffix:colon
r_if
c_cond
(paren
id|arg
)paren
(brace
id|reg_set_bits
c_func
(paren
id|lynx
comma
id|LINK_CONTROL
comma
id|LINK_CONTROL_CYCMASTER
)paren
suffix:semicolon
)brace
r_else
(brace
id|reg_clear_bits
c_func
(paren
id|lynx
comma
id|LINK_CONTROL
comma
id|LINK_CONTROL_CYCMASTER
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|CANCEL_REQUESTS
suffix:colon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|lynx-&gt;async.queue_lock
comma
id|flags
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|lynx
comma
id|DMA_CHAN_CTRL
c_func
(paren
id|CHANNEL_ASYNC_SEND
)paren
comma
l_int|0
)paren
suffix:semicolon
id|list_splice
c_func
(paren
op_amp
id|lynx-&gt;async.queue
comma
op_amp
id|packet_list
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|lynx-&gt;async.queue
)paren
suffix:semicolon
r_if
c_cond
(paren
id|list_empty
c_func
(paren
op_amp
id|lynx-&gt;async.pcl_queue
)paren
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|lynx-&gt;async.queue_lock
comma
id|flags
)paren
suffix:semicolon
id|PRINTD
c_func
(paren
id|KERN_DEBUG
comma
id|lynx-&gt;id
comma
l_string|&quot;no async packet in PCL to cancel&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
r_struct
id|ti_pcl
id|pcl
suffix:semicolon
id|u32
id|ack
suffix:semicolon
r_struct
id|hpsb_packet
op_star
id|packet
suffix:semicolon
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|lynx-&gt;id
comma
l_string|&quot;cancelling async packet, that was already in PCL&quot;
)paren
suffix:semicolon
id|get_pcl
c_func
(paren
id|lynx
comma
id|lynx-&gt;async.pcl
comma
op_amp
id|pcl
)paren
suffix:semicolon
id|packet
op_assign
id|driver_packet
c_func
(paren
id|lynx-&gt;async.pcl_queue.next
)paren
suffix:semicolon
id|list_del_init
c_func
(paren
op_amp
id|packet-&gt;driver_list
)paren
suffix:semicolon
id|pci_unmap_single
c_func
(paren
id|lynx-&gt;dev
comma
id|lynx-&gt;async.header_dma
comma
id|packet-&gt;header_size
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|packet-&gt;data_size
)paren
(brace
id|pci_unmap_single
c_func
(paren
id|lynx-&gt;dev
comma
id|lynx-&gt;async.data_dma
comma
id|packet-&gt;data_size
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|lynx-&gt;async.queue_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pcl.pcl_status
op_amp
id|DMA_CHAN_STAT_PKTCMPL
)paren
(brace
r_if
c_cond
(paren
id|pcl.pcl_status
op_amp
id|DMA_CHAN_STAT_SPECIALACK
)paren
(brace
id|ack
op_assign
(paren
id|pcl.pcl_status
op_rshift
l_int|15
)paren
op_amp
l_int|0xf
suffix:semicolon
id|PRINTD
c_func
(paren
id|KERN_INFO
comma
id|lynx-&gt;id
comma
l_string|&quot;special ack %d&quot;
comma
id|ack
)paren
suffix:semicolon
id|ack
op_assign
(paren
id|ack
op_eq
l_int|1
ques
c_cond
id|ACKX_TIMEOUT
suffix:colon
id|ACKX_SEND_ERROR
)paren
suffix:semicolon
)brace
r_else
(brace
id|ack
op_assign
(paren
id|pcl.pcl_status
op_rshift
l_int|15
)paren
op_amp
l_int|0xf
suffix:semicolon
)brace
)brace
r_else
(brace
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|lynx-&gt;id
comma
l_string|&quot;async packet was not completed&quot;
)paren
suffix:semicolon
id|ack
op_assign
id|ACKX_ABORTED
suffix:semicolon
)brace
id|hpsb_packet_sent
c_func
(paren
id|host
comma
id|packet
comma
id|ack
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|packet_list
)paren
)paren
(brace
id|packet
op_assign
id|driver_packet
c_func
(paren
id|packet_list.next
)paren
suffix:semicolon
id|list_del_init
c_func
(paren
op_amp
id|packet-&gt;driver_list
)paren
suffix:semicolon
id|hpsb_packet_sent
c_func
(paren
id|host
comma
id|packet
comma
id|ACKX_ABORTED
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ISO_LISTEN_CHANNEL
suffix:colon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|lynx-&gt;iso_rcv.lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lynx-&gt;iso_rcv.chan_count
op_increment
op_eq
l_int|0
)paren
(brace
id|reg_write
c_func
(paren
id|lynx
comma
id|DMA_WORD1_CMP_ENABLE
c_func
(paren
id|CHANNEL_ISO_RCV
)paren
comma
id|DMA_WORD1_CMP_ENABLE_MASTER
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|lynx-&gt;iso_rcv.lock
comma
id|flags
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ISO_UNLISTEN_CHANNEL
suffix:colon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|lynx-&gt;iso_rcv.lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|lynx-&gt;iso_rcv.chan_count
op_eq
l_int|0
)paren
(brace
id|reg_write
c_func
(paren
id|lynx
comma
id|DMA_WORD1_CMP_ENABLE
c_func
(paren
id|CHANNEL_ISO_RCV
)paren
comma
l_int|0
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|lynx-&gt;iso_rcv.lock
comma
id|flags
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|lynx-&gt;id
comma
l_string|&quot;unknown devctl command %d&quot;
comma
id|cmd
)paren
suffix:semicolon
id|retval
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/***************************************&n; * IEEE-1394 functionality section END *&n; ***************************************/
macro_line|#ifdef CONFIG_IEEE1394_PCILYNX_PORTS
multiline_comment|/* VFS functions for local bus / aux device access.  Access to those&n; * is implemented as a character device instead of block devices&n; * because buffers are not wanted for this.  Therefore llseek (from&n; * VFS) can be used for these char devices with obvious effects.&n; */
r_static
r_int
id|mem_open
c_func
(paren
r_struct
id|inode
op_star
comma
r_struct
id|file
op_star
)paren
suffix:semicolon
r_static
r_int
id|mem_release
c_func
(paren
r_struct
id|inode
op_star
comma
r_struct
id|file
op_star
)paren
suffix:semicolon
r_static
r_int
r_int
id|aux_poll
c_func
(paren
r_struct
id|file
op_star
comma
r_struct
id|poll_table_struct
op_star
)paren
suffix:semicolon
r_static
id|loff_t
id|mem_llseek
c_func
(paren
r_struct
id|file
op_star
comma
id|loff_t
comma
r_int
)paren
suffix:semicolon
r_static
id|ssize_t
id|mem_read
(paren
r_struct
id|file
op_star
comma
r_char
op_star
comma
r_int
comma
id|loff_t
op_star
)paren
suffix:semicolon
r_static
id|ssize_t
id|mem_write
c_func
(paren
r_struct
id|file
op_star
comma
r_const
r_char
op_star
comma
r_int
comma
id|loff_t
op_star
)paren
suffix:semicolon
DECL|variable|aux_ops
r_static
r_struct
id|file_operations
id|aux_ops
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|read
op_assign
id|mem_read
comma
dot
id|write
op_assign
id|mem_write
comma
dot
id|poll
op_assign
id|aux_poll
comma
dot
id|llseek
op_assign
id|mem_llseek
comma
dot
id|open
op_assign
id|mem_open
comma
dot
id|release
op_assign
id|mem_release
comma
)brace
suffix:semicolon
DECL|function|aux_setup_pcls
r_static
r_void
id|aux_setup_pcls
c_func
(paren
r_struct
id|ti_lynx
op_star
id|lynx
)paren
(brace
r_struct
id|ti_pcl
id|pcl
suffix:semicolon
id|pcl.next
op_assign
id|PCL_NEXT_INVALID
suffix:semicolon
id|pcl.user_data
op_assign
id|pcl_bus
c_func
(paren
id|lynx
comma
id|lynx-&gt;dmem_pcl
)paren
suffix:semicolon
id|put_pcl
c_func
(paren
id|lynx
comma
id|lynx-&gt;dmem_pcl
comma
op_amp
id|pcl
)paren
suffix:semicolon
)brace
DECL|function|mem_open
r_static
r_int
id|mem_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_int
id|cid
op_assign
id|iminor
c_func
(paren
id|inode
)paren
suffix:semicolon
r_enum
(brace
id|t_rom
comma
id|t_aux
comma
id|t_ram
)brace
id|type
suffix:semicolon
r_struct
id|memdata
op_star
id|md
suffix:semicolon
r_if
c_cond
(paren
id|cid
OL
id|PCILYNX_MINOR_AUX_START
)paren
(brace
multiline_comment|/* just for completeness */
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|cid
OL
id|PCILYNX_MINOR_ROM_START
)paren
(brace
id|cid
op_sub_assign
id|PCILYNX_MINOR_AUX_START
suffix:semicolon
r_if
c_cond
(paren
id|cid
op_ge
id|num_of_cards
op_logical_or
op_logical_neg
id|cards
(braket
id|cid
)braket
dot
id|aux_port
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
id|type
op_assign
id|t_aux
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|cid
OL
id|PCILYNX_MINOR_RAM_START
)paren
(brace
id|cid
op_sub_assign
id|PCILYNX_MINOR_ROM_START
suffix:semicolon
r_if
c_cond
(paren
id|cid
op_ge
id|num_of_cards
op_logical_or
op_logical_neg
id|cards
(braket
id|cid
)braket
dot
id|local_rom
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
id|type
op_assign
id|t_rom
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* WARNING: Know what you are doing when opening RAM.&n;                 * It is currently used inside the driver! */
id|cid
op_sub_assign
id|PCILYNX_MINOR_RAM_START
suffix:semicolon
r_if
c_cond
(paren
id|cid
op_ge
id|num_of_cards
op_logical_or
op_logical_neg
id|cards
(braket
id|cid
)braket
dot
id|local_ram
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
id|type
op_assign
id|t_ram
suffix:semicolon
)brace
id|md
op_assign
(paren
r_struct
id|memdata
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|memdata
)paren
comma
id|SLAB_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|md
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|md-&gt;lynx
op_assign
op_amp
id|cards
(braket
id|cid
)braket
suffix:semicolon
id|md-&gt;cid
op_assign
id|cid
suffix:semicolon
r_switch
c_cond
(paren
id|type
)paren
(brace
r_case
id|t_rom
suffix:colon
id|md-&gt;type
op_assign
id|rom
suffix:semicolon
r_break
suffix:semicolon
r_case
id|t_ram
suffix:colon
id|md-&gt;type
op_assign
id|ram
suffix:semicolon
r_break
suffix:semicolon
r_case
id|t_aux
suffix:colon
id|atomic_set
c_func
(paren
op_amp
id|md-&gt;aux_intr_last_seen
comma
id|atomic_read
c_func
(paren
op_amp
id|cards
(braket
id|cid
)braket
dot
id|aux_intr_seen
)paren
)paren
suffix:semicolon
id|md-&gt;type
op_assign
id|aux
suffix:semicolon
r_break
suffix:semicolon
)brace
id|file-&gt;private_data
op_assign
id|md
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|mem_release
r_static
r_int
id|mem_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
id|kfree
c_func
(paren
id|file-&gt;private_data
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|aux_poll
r_static
r_int
r_int
id|aux_poll
c_func
(paren
r_struct
id|file
op_star
id|file
comma
id|poll_table
op_star
id|pt
)paren
(brace
r_struct
id|memdata
op_star
id|md
op_assign
(paren
r_struct
id|memdata
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
r_int
id|cid
op_assign
id|md-&gt;cid
suffix:semicolon
r_int
r_int
id|mask
suffix:semicolon
multiline_comment|/* reading and writing is always allowed */
id|mask
op_assign
id|POLLIN
op_or
id|POLLRDNORM
op_or
id|POLLOUT
op_or
id|POLLWRNORM
suffix:semicolon
r_if
c_cond
(paren
id|md-&gt;type
op_eq
id|aux
)paren
(brace
id|poll_wait
c_func
(paren
id|file
comma
op_amp
id|cards
(braket
id|cid
)braket
dot
id|aux_intr_wait
comma
id|pt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|md-&gt;aux_intr_last_seen
)paren
op_ne
id|atomic_read
c_func
(paren
op_amp
id|cards
(braket
id|cid
)braket
dot
id|aux_intr_seen
)paren
)paren
(brace
id|mask
op_or_assign
id|POLLPRI
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|md-&gt;aux_intr_last_seen
)paren
suffix:semicolon
)brace
)brace
r_return
id|mask
suffix:semicolon
)brace
DECL|function|mem_llseek
id|loff_t
id|mem_llseek
c_func
(paren
r_struct
id|file
op_star
id|file
comma
id|loff_t
id|offs
comma
r_int
id|orig
)paren
(brace
id|loff_t
id|newoffs
suffix:semicolon
r_switch
c_cond
(paren
id|orig
)paren
(brace
r_case
l_int|0
suffix:colon
id|newoffs
op_assign
id|offs
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|newoffs
op_assign
id|offs
op_plus
id|file-&gt;f_pos
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|newoffs
op_assign
id|PCILYNX_MAX_MEMORY
op_plus
l_int|1
op_plus
id|offs
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|newoffs
template_param
id|PCILYNX_MAX_MEMORY
op_plus
l_int|1
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|file-&gt;f_pos
op_assign
id|newoffs
suffix:semicolon
r_return
id|newoffs
suffix:semicolon
)brace
multiline_comment|/*&n; * do not DMA if count is too small because this will have a serious impact&n; * on performance - the value 2400 was found by experiment and may not work&n; * everywhere as good as here - use mem_mindma option for modules to change&n; */
DECL|variable|mem_mindma
r_static
r_int
id|mem_mindma
op_assign
l_int|2400
suffix:semicolon
id|module_param
c_func
(paren
id|mem_mindma
comma
r_int
comma
l_int|0444
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|mem_mindma
comma
l_string|&quot;Minimum amount of data required to use DMA&quot;
)paren
suffix:semicolon
DECL|function|mem_dmaread
r_static
id|ssize_t
id|mem_dmaread
c_func
(paren
r_struct
id|memdata
op_star
id|md
comma
id|u32
id|physbuf
comma
id|ssize_t
id|count
comma
r_int
id|offset
)paren
(brace
id|pcltmp_t
id|pcltmp
suffix:semicolon
r_struct
id|ti_pcl
op_star
id|pcl
suffix:semicolon
r_int
id|retval
suffix:semicolon
r_int
id|i
suffix:semicolon
id|DECLARE_WAITQUEUE
c_func
(paren
id|wait
comma
id|current
)paren
suffix:semicolon
id|count
op_and_assign
op_complement
l_int|3
suffix:semicolon
id|count
op_assign
id|min
c_func
(paren
id|count
comma
l_int|53196
)paren
suffix:semicolon
id|retval
op_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
id|reg_read
c_func
(paren
id|md-&gt;lynx
comma
id|DMA_CHAN_CTRL
c_func
(paren
id|CHANNEL_LOCALBUS
)paren
)paren
op_amp
id|DMA_CHAN_CTRL_BUSY
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_WARNING
comma
id|md-&gt;lynx-&gt;id
comma
l_string|&quot;DMA ALREADY ACTIVE!&quot;
)paren
suffix:semicolon
)brace
id|reg_write
c_func
(paren
id|md-&gt;lynx
comma
id|LBUS_ADDR
comma
id|md-&gt;type
op_or
id|offset
)paren
suffix:semicolon
id|pcl
op_assign
id|edit_pcl
c_func
(paren
id|md-&gt;lynx
comma
id|md-&gt;lynx-&gt;dmem_pcl
comma
op_amp
id|pcltmp
)paren
suffix:semicolon
id|pcl-&gt;buffer
(braket
l_int|0
)braket
dot
id|control
op_assign
id|PCL_CMD_LBUS_TO_PCI
op_or
id|min
c_func
(paren
id|count
comma
l_int|4092
)paren
suffix:semicolon
id|pcl-&gt;buffer
(braket
l_int|0
)braket
dot
id|pointer
op_assign
id|physbuf
suffix:semicolon
id|count
op_sub_assign
l_int|4092
suffix:semicolon
id|i
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|count
OG
l_int|0
)paren
(brace
id|i
op_increment
suffix:semicolon
id|pcl-&gt;buffer
(braket
id|i
)braket
dot
id|control
op_assign
id|min
c_func
(paren
id|count
comma
l_int|4092
)paren
suffix:semicolon
id|pcl-&gt;buffer
(braket
id|i
)braket
dot
id|pointer
op_assign
id|physbuf
op_plus
id|i
op_star
l_int|4092
suffix:semicolon
id|count
op_sub_assign
l_int|4092
suffix:semicolon
)brace
id|pcl-&gt;buffer
(braket
id|i
)braket
dot
id|control
op_or_assign
id|PCL_LAST_BUFF
suffix:semicolon
id|commit_pcl
c_func
(paren
id|md-&gt;lynx
comma
id|md-&gt;lynx-&gt;dmem_pcl
comma
op_amp
id|pcltmp
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|add_wait_queue
c_func
(paren
op_amp
id|md-&gt;lynx-&gt;mem_dma_intr_wait
comma
op_amp
id|wait
)paren
suffix:semicolon
id|run_sub_pcl
c_func
(paren
id|md-&gt;lynx
comma
id|md-&gt;lynx-&gt;dmem_pcl
comma
l_int|2
comma
id|CHANNEL_LOCALBUS
)paren
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|reg_read
c_func
(paren
id|md-&gt;lynx
comma
id|DMA_CHAN_CTRL
c_func
(paren
id|CHANNEL_LOCALBUS
)paren
)paren
op_amp
id|DMA_CHAN_CTRL_BUSY
)paren
(brace
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
id|retval
op_assign
op_minus
id|EINTR
suffix:semicolon
r_break
suffix:semicolon
)brace
id|schedule
c_func
(paren
)paren
suffix:semicolon
)brace
id|reg_write
c_func
(paren
id|md-&gt;lynx
comma
id|DMA_CHAN_CTRL
c_func
(paren
id|CHANNEL_LOCALBUS
)paren
comma
l_int|0
)paren
suffix:semicolon
id|remove_wait_queue
c_func
(paren
op_amp
id|md-&gt;lynx-&gt;mem_dma_intr_wait
comma
op_amp
id|wait
)paren
suffix:semicolon
r_if
c_cond
(paren
id|reg_read
c_func
(paren
id|md-&gt;lynx
comma
id|DMA_CHAN_CTRL
c_func
(paren
id|CHANNEL_LOCALBUS
)paren
)paren
op_amp
id|DMA_CHAN_CTRL_BUSY
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|md-&gt;lynx-&gt;id
comma
l_string|&quot;DMA STILL ACTIVE!&quot;
)paren
suffix:semicolon
)brace
r_return
id|retval
suffix:semicolon
)brace
DECL|function|mem_read
r_static
id|ssize_t
id|mem_read
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_char
op_star
id|buffer
comma
r_int
id|count
comma
id|loff_t
op_star
id|offset
)paren
(brace
r_struct
id|memdata
op_star
id|md
op_assign
(paren
r_struct
id|memdata
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
id|ssize_t
id|bcount
suffix:semicolon
r_int
id|alignfix
suffix:semicolon
id|loff_t
id|off
op_assign
op_star
id|offset
suffix:semicolon
multiline_comment|/* avoid useless 64bit-arithmetic */
id|ssize_t
id|retval
suffix:semicolon
r_void
op_star
id|membase
suffix:semicolon
r_if
c_cond
(paren
(paren
id|off
op_plus
id|count
)paren
OG
id|PCILYNX_MAX_MEMORY
op_plus
l_int|1
)paren
(brace
id|count
op_assign
id|PCILYNX_MAX_MEMORY
op_plus
l_int|1
op_minus
id|off
suffix:semicolon
)brace
r_if
c_cond
(paren
id|count
op_eq
l_int|0
op_logical_or
id|off
OG
id|PCILYNX_MAX_MEMORY
)paren
(brace
r_return
op_minus
id|ENOSPC
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|md-&gt;type
)paren
(brace
r_case
id|rom
suffix:colon
id|membase
op_assign
id|md-&gt;lynx-&gt;local_rom
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ram
suffix:colon
id|membase
op_assign
id|md-&gt;lynx-&gt;local_ram
suffix:semicolon
r_break
suffix:semicolon
r_case
id|aux
suffix:colon
id|membase
op_assign
id|md-&gt;lynx-&gt;aux_port
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|panic
c_func
(paren
l_string|&quot;pcilynx%d: unsupported md-&gt;type %d in %s&quot;
comma
id|md-&gt;lynx-&gt;id
comma
id|md-&gt;type
comma
id|__FUNCTION__
)paren
suffix:semicolon
)brace
id|down
c_func
(paren
op_amp
id|md-&gt;lynx-&gt;mem_dma_mutex
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
OL
id|mem_mindma
)paren
(brace
id|memcpy_fromio
c_func
(paren
id|md-&gt;lynx-&gt;mem_dma_buffer
comma
id|membase
op_plus
id|off
comma
id|count
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|bcount
op_assign
id|count
suffix:semicolon
id|alignfix
op_assign
l_int|4
op_minus
(paren
id|off
op_mod
l_int|4
)paren
suffix:semicolon
r_if
c_cond
(paren
id|alignfix
op_ne
l_int|4
)paren
(brace
r_if
c_cond
(paren
id|bcount
OL
id|alignfix
)paren
(brace
id|alignfix
op_assign
id|bcount
suffix:semicolon
)brace
id|memcpy_fromio
c_func
(paren
id|md-&gt;lynx-&gt;mem_dma_buffer
comma
id|membase
op_plus
id|off
comma
id|alignfix
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bcount
op_eq
id|alignfix
)paren
(brace
r_goto
id|out
suffix:semicolon
)brace
id|bcount
op_sub_assign
id|alignfix
suffix:semicolon
id|off
op_add_assign
id|alignfix
suffix:semicolon
)brace
r_while
c_loop
(paren
id|bcount
op_ge
l_int|4
)paren
(brace
id|retval
op_assign
id|mem_dmaread
c_func
(paren
id|md
comma
id|md-&gt;lynx-&gt;mem_dma_buffer_dma
op_plus
id|count
op_minus
id|bcount
comma
id|bcount
comma
id|off
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
OL
l_int|0
)paren
r_return
id|retval
suffix:semicolon
id|bcount
op_sub_assign
id|retval
suffix:semicolon
id|off
op_add_assign
id|retval
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bcount
)paren
(brace
id|memcpy_fromio
c_func
(paren
id|md-&gt;lynx-&gt;mem_dma_buffer
op_plus
id|count
op_minus
id|bcount
comma
id|membase
op_plus
id|off
comma
id|bcount
)paren
suffix:semicolon
)brace
id|out
suffix:colon
id|retval
op_assign
id|copy_to_user
c_func
(paren
id|buffer
comma
id|md-&gt;lynx-&gt;mem_dma_buffer
comma
id|count
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|md-&gt;lynx-&gt;mem_dma_mutex
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
op_star
id|offset
op_add_assign
id|count
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
DECL|function|mem_write
r_static
id|ssize_t
id|mem_write
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buffer
comma
r_int
id|count
comma
id|loff_t
op_star
id|offset
)paren
(brace
r_struct
id|memdata
op_star
id|md
op_assign
(paren
r_struct
id|memdata
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
op_star
id|offset
)paren
op_plus
id|count
)paren
OG
id|PCILYNX_MAX_MEMORY
op_plus
l_int|1
)paren
(brace
id|count
op_assign
id|PCILYNX_MAX_MEMORY
op_plus
l_int|1
op_minus
op_star
id|offset
suffix:semicolon
)brace
r_if
c_cond
(paren
id|count
op_eq
l_int|0
op_logical_or
op_star
id|offset
OG
id|PCILYNX_MAX_MEMORY
)paren
(brace
r_return
op_minus
id|ENOSPC
suffix:semicolon
)brace
multiline_comment|/* FIXME: dereferencing pointers to PCI mem doesn&squot;t work everywhere */
r_switch
c_cond
(paren
id|md-&gt;type
)paren
(brace
r_case
id|aux
suffix:colon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|md-&gt;lynx-&gt;aux_port
op_plus
(paren
op_star
id|offset
)paren
comma
id|buffer
comma
id|count
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ram
suffix:colon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|md-&gt;lynx-&gt;local_ram
op_plus
(paren
op_star
id|offset
)paren
comma
id|buffer
comma
id|count
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
r_case
id|rom
suffix:colon
multiline_comment|/* the ROM may be writeable */
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|md-&gt;lynx-&gt;local_rom
op_plus
(paren
op_star
id|offset
)paren
comma
id|buffer
comma
id|count
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
)brace
id|file-&gt;f_pos
op_add_assign
id|count
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_IEEE1394_PCILYNX_PORTS */
multiline_comment|/********************************************************&n; * Global stuff (interrupt handler, init/shutdown code) *&n; ********************************************************/
DECL|function|lynx_irq_handler
r_static
id|irqreturn_t
id|lynx_irq_handler
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs_are_unused
)paren
(brace
r_struct
id|ti_lynx
op_star
id|lynx
op_assign
(paren
r_struct
id|ti_lynx
op_star
)paren
id|dev_id
suffix:semicolon
r_struct
id|hpsb_host
op_star
id|host
op_assign
id|lynx-&gt;host
suffix:semicolon
id|u32
id|intmask
suffix:semicolon
id|u32
id|linkint
suffix:semicolon
id|linkint
op_assign
id|reg_read
c_func
(paren
id|lynx
comma
id|LINK_INT_STATUS
)paren
suffix:semicolon
id|intmask
op_assign
id|reg_read
c_func
(paren
id|lynx
comma
id|PCI_INT_STATUS
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|intmask
op_amp
id|PCI_INT_INT_PEND
)paren
)paren
r_return
id|IRQ_NONE
suffix:semicolon
id|PRINTD
c_func
(paren
id|KERN_DEBUG
comma
id|lynx-&gt;id
comma
l_string|&quot;interrupt: 0x%08x / 0x%08x&quot;
comma
id|intmask
comma
id|linkint
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|lynx
comma
id|LINK_INT_STATUS
comma
id|linkint
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|lynx
comma
id|PCI_INT_STATUS
comma
id|intmask
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_IEEE1394_PCILYNX_PORTS
r_if
c_cond
(paren
id|intmask
op_amp
id|PCI_INT_AUX_INT
)paren
(brace
id|atomic_inc
c_func
(paren
op_amp
id|lynx-&gt;aux_intr_seen
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|lynx-&gt;aux_intr_wait
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|intmask
op_amp
id|PCI_INT_DMA_HLT
c_func
(paren
id|CHANNEL_LOCALBUS
)paren
)paren
(brace
id|wake_up_interruptible
c_func
(paren
op_amp
id|lynx-&gt;mem_dma_intr_wait
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|intmask
op_amp
id|PCI_INT_1394
)paren
(brace
r_if
c_cond
(paren
id|linkint
op_amp
id|LINK_INT_PHY_TIMEOUT
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|lynx-&gt;id
comma
l_string|&quot;PHY timeout occurred&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|linkint
op_amp
id|LINK_INT_PHY_BUSRESET
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|lynx-&gt;id
comma
l_string|&quot;bus reset interrupt&quot;
)paren
suffix:semicolon
id|lynx-&gt;selfid_size
op_assign
op_minus
l_int|1
suffix:semicolon
id|lynx-&gt;phy_reg0
op_assign
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|host-&gt;in_bus_reset
)paren
id|hpsb_bus_reset
c_func
(paren
id|host
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|linkint
op_amp
id|LINK_INT_PHY_REG_RCVD
)paren
(brace
id|u32
id|reg
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|lynx-&gt;phy_reg_lock
)paren
suffix:semicolon
id|reg
op_assign
id|reg_read
c_func
(paren
id|lynx
comma
id|LINK_PHY
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|lynx-&gt;phy_reg_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|host-&gt;in_bus_reset
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|lynx-&gt;id
comma
l_string|&quot;phy reg received without reset&quot;
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|reg
op_amp
l_int|0xf00
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|lynx-&gt;id
comma
l_string|&quot;unsolicited phy reg %d received&quot;
comma
(paren
id|reg
op_rshift
l_int|8
)paren
op_amp
l_int|0xf
)paren
suffix:semicolon
)brace
r_else
(brace
id|lynx-&gt;phy_reg0
op_assign
id|reg
op_amp
l_int|0xff
suffix:semicolon
id|handle_selfid
c_func
(paren
id|lynx
comma
id|host
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|linkint
op_amp
id|LINK_INT_ISO_STUCK
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|lynx-&gt;id
comma
l_string|&quot;isochronous transmitter stuck&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|linkint
op_amp
id|LINK_INT_ASYNC_STUCK
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|lynx-&gt;id
comma
l_string|&quot;asynchronous transmitter stuck&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|linkint
op_amp
id|LINK_INT_SENT_REJECT
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|lynx-&gt;id
comma
l_string|&quot;sent reject&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|linkint
op_amp
id|LINK_INT_TX_INVALID_TC
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|lynx-&gt;id
comma
l_string|&quot;invalid transaction code&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|linkint
op_amp
id|LINK_INT_GRF_OVERFLOW
)paren
(brace
multiline_comment|/* flush FIFO if overflow happens during reset */
r_if
c_cond
(paren
id|host-&gt;in_bus_reset
)paren
id|reg_write
c_func
(paren
id|lynx
comma
id|FIFO_CONTROL
comma
id|FIFO_CONTROL_GRF_FLUSH
)paren
suffix:semicolon
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|lynx-&gt;id
comma
l_string|&quot;GRF overflow&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|linkint
op_amp
id|LINK_INT_ITF_UNDERFLOW
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|lynx-&gt;id
comma
l_string|&quot;ITF underflow&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|linkint
op_amp
id|LINK_INT_ATF_UNDERFLOW
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|lynx-&gt;id
comma
l_string|&quot;ATF underflow&quot;
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|intmask
op_amp
id|PCI_INT_DMA_HLT
c_func
(paren
id|CHANNEL_ISO_RCV
)paren
)paren
(brace
id|PRINTD
c_func
(paren
id|KERN_DEBUG
comma
id|lynx-&gt;id
comma
l_string|&quot;iso receive&quot;
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|lynx-&gt;iso_rcv.lock
)paren
suffix:semicolon
id|lynx-&gt;iso_rcv.stat
(braket
id|lynx-&gt;iso_rcv.next
)braket
op_assign
id|reg_read
c_func
(paren
id|lynx
comma
id|DMA_CHAN_STAT
c_func
(paren
id|CHANNEL_ISO_RCV
)paren
)paren
suffix:semicolon
id|lynx-&gt;iso_rcv.used
op_increment
suffix:semicolon
id|lynx-&gt;iso_rcv.next
op_assign
(paren
id|lynx-&gt;iso_rcv.next
op_plus
l_int|1
)paren
op_mod
id|NUM_ISORCV_PCL
suffix:semicolon
r_if
c_cond
(paren
(paren
id|lynx-&gt;iso_rcv.next
op_eq
id|lynx-&gt;iso_rcv.last
)paren
op_logical_or
op_logical_neg
id|lynx-&gt;iso_rcv.chan_count
)paren
(brace
id|PRINTD
c_func
(paren
id|KERN_DEBUG
comma
id|lynx-&gt;id
comma
l_string|&quot;stopped&quot;
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|lynx
comma
id|DMA_WORD1_CMP_ENABLE
c_func
(paren
id|CHANNEL_ISO_RCV
)paren
comma
l_int|0
)paren
suffix:semicolon
)brace
id|run_sub_pcl
c_func
(paren
id|lynx
comma
id|lynx-&gt;iso_rcv.pcl_start
comma
id|lynx-&gt;iso_rcv.next
comma
id|CHANNEL_ISO_RCV
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|lynx-&gt;iso_rcv.lock
)paren
suffix:semicolon
id|tasklet_schedule
c_func
(paren
op_amp
id|lynx-&gt;iso_rcv.tq
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|intmask
op_amp
id|PCI_INT_DMA_HLT
c_func
(paren
id|CHANNEL_ASYNC_SEND
)paren
)paren
(brace
id|PRINTD
c_func
(paren
id|KERN_DEBUG
comma
id|lynx-&gt;id
comma
l_string|&quot;async sent&quot;
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|lynx-&gt;async.queue_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|list_empty
c_func
(paren
op_amp
id|lynx-&gt;async.pcl_queue
)paren
)paren
(brace
id|spin_unlock
c_func
(paren
op_amp
id|lynx-&gt;async.queue_lock
)paren
suffix:semicolon
id|PRINT
c_func
(paren
id|KERN_WARNING
comma
id|lynx-&gt;id
comma
l_string|&quot;async dma halted, but no queued packet (maybe it was cancelled)&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
r_struct
id|ti_pcl
id|pcl
suffix:semicolon
id|u32
id|ack
suffix:semicolon
r_struct
id|hpsb_packet
op_star
id|packet
suffix:semicolon
id|get_pcl
c_func
(paren
id|lynx
comma
id|lynx-&gt;async.pcl
comma
op_amp
id|pcl
)paren
suffix:semicolon
id|packet
op_assign
id|driver_packet
c_func
(paren
id|lynx-&gt;async.pcl_queue.next
)paren
suffix:semicolon
id|list_del_init
c_func
(paren
op_amp
id|packet-&gt;driver_list
)paren
suffix:semicolon
id|pci_unmap_single
c_func
(paren
id|lynx-&gt;dev
comma
id|lynx-&gt;async.header_dma
comma
id|packet-&gt;header_size
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|packet-&gt;data_size
)paren
(brace
id|pci_unmap_single
c_func
(paren
id|lynx-&gt;dev
comma
id|lynx-&gt;async.data_dma
comma
id|packet-&gt;data_size
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|lynx-&gt;async.queue
)paren
)paren
(brace
id|send_next
c_func
(paren
id|lynx
comma
id|hpsb_async
)paren
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|lynx-&gt;async.queue_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pcl.pcl_status
op_amp
id|DMA_CHAN_STAT_PKTCMPL
)paren
(brace
r_if
c_cond
(paren
id|pcl.pcl_status
op_amp
id|DMA_CHAN_STAT_SPECIALACK
)paren
(brace
id|ack
op_assign
(paren
id|pcl.pcl_status
op_rshift
l_int|15
)paren
op_amp
l_int|0xf
suffix:semicolon
id|PRINTD
c_func
(paren
id|KERN_INFO
comma
id|lynx-&gt;id
comma
l_string|&quot;special ack %d&quot;
comma
id|ack
)paren
suffix:semicolon
id|ack
op_assign
(paren
id|ack
op_eq
l_int|1
ques
c_cond
id|ACKX_TIMEOUT
suffix:colon
id|ACKX_SEND_ERROR
)paren
suffix:semicolon
)brace
r_else
(brace
id|ack
op_assign
(paren
id|pcl.pcl_status
op_rshift
l_int|15
)paren
op_amp
l_int|0xf
suffix:semicolon
)brace
)brace
r_else
(brace
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|lynx-&gt;id
comma
l_string|&quot;async packet was not completed&quot;
)paren
suffix:semicolon
id|ack
op_assign
id|ACKX_SEND_ERROR
suffix:semicolon
)brace
id|hpsb_packet_sent
c_func
(paren
id|host
comma
id|packet
comma
id|ack
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|intmask
op_amp
id|PCI_INT_DMA_HLT
c_func
(paren
id|CHANNEL_ISO_SEND
)paren
)paren
(brace
id|PRINTD
c_func
(paren
id|KERN_DEBUG
comma
id|lynx-&gt;id
comma
l_string|&quot;iso sent&quot;
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|lynx-&gt;iso_send.queue_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|list_empty
c_func
(paren
op_amp
id|lynx-&gt;iso_send.pcl_queue
)paren
)paren
(brace
id|spin_unlock
c_func
(paren
op_amp
id|lynx-&gt;iso_send.queue_lock
)paren
suffix:semicolon
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|lynx-&gt;id
comma
l_string|&quot;iso send dma halted, but no queued packet&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
r_struct
id|ti_pcl
id|pcl
suffix:semicolon
id|u32
id|ack
suffix:semicolon
r_struct
id|hpsb_packet
op_star
id|packet
suffix:semicolon
id|get_pcl
c_func
(paren
id|lynx
comma
id|lynx-&gt;iso_send.pcl
comma
op_amp
id|pcl
)paren
suffix:semicolon
id|packet
op_assign
id|driver_packet
c_func
(paren
id|lynx-&gt;iso_send.pcl_queue.next
)paren
suffix:semicolon
id|list_del_init
c_func
(paren
op_amp
id|packet-&gt;driver_list
)paren
suffix:semicolon
id|pci_unmap_single
c_func
(paren
id|lynx-&gt;dev
comma
id|lynx-&gt;iso_send.header_dma
comma
id|packet-&gt;header_size
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|packet-&gt;data_size
)paren
(brace
id|pci_unmap_single
c_func
(paren
id|lynx-&gt;dev
comma
id|lynx-&gt;iso_send.data_dma
comma
id|packet-&gt;data_size
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|lynx-&gt;iso_send.queue
)paren
)paren
(brace
id|send_next
c_func
(paren
id|lynx
comma
id|hpsb_iso
)paren
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|lynx-&gt;iso_send.queue_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pcl.pcl_status
op_amp
id|DMA_CHAN_STAT_PKTCMPL
)paren
(brace
r_if
c_cond
(paren
id|pcl.pcl_status
op_amp
id|DMA_CHAN_STAT_SPECIALACK
)paren
(brace
id|ack
op_assign
(paren
id|pcl.pcl_status
op_rshift
l_int|15
)paren
op_amp
l_int|0xf
suffix:semicolon
id|PRINTD
c_func
(paren
id|KERN_INFO
comma
id|lynx-&gt;id
comma
l_string|&quot;special ack %d&quot;
comma
id|ack
)paren
suffix:semicolon
id|ack
op_assign
(paren
id|ack
op_eq
l_int|1
ques
c_cond
id|ACKX_TIMEOUT
suffix:colon
id|ACKX_SEND_ERROR
)paren
suffix:semicolon
)brace
r_else
(brace
id|ack
op_assign
(paren
id|pcl.pcl_status
op_rshift
l_int|15
)paren
op_amp
l_int|0xf
suffix:semicolon
)brace
)brace
r_else
(brace
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|lynx-&gt;id
comma
l_string|&quot;iso send packet was not completed&quot;
)paren
suffix:semicolon
id|ack
op_assign
id|ACKX_SEND_ERROR
suffix:semicolon
)brace
id|hpsb_packet_sent
c_func
(paren
id|host
comma
id|packet
comma
id|ack
)paren
suffix:semicolon
singleline_comment|//FIXME: maybe we should just use ACK_COMPLETE and ACKX_SEND_ERROR
)brace
)brace
r_if
c_cond
(paren
id|intmask
op_amp
id|PCI_INT_DMA_HLT
c_func
(paren
id|CHANNEL_ASYNC_RCV
)paren
)paren
(brace
multiline_comment|/* general receive DMA completed */
r_int
id|stat
op_assign
id|reg_read
c_func
(paren
id|lynx
comma
id|DMA_CHAN_STAT
c_func
(paren
id|CHANNEL_ASYNC_RCV
)paren
)paren
suffix:semicolon
id|PRINTD
c_func
(paren
id|KERN_DEBUG
comma
id|lynx-&gt;id
comma
l_string|&quot;received packet size %d&quot;
comma
id|stat
op_amp
l_int|0x1fff
)paren
suffix:semicolon
r_if
c_cond
(paren
id|stat
op_amp
id|DMA_CHAN_STAT_SELFID
)paren
(brace
id|lynx-&gt;selfid_size
op_assign
id|stat
op_amp
l_int|0x1fff
suffix:semicolon
id|handle_selfid
c_func
(paren
id|lynx
comma
id|host
)paren
suffix:semicolon
)brace
r_else
(brace
id|quadlet_t
op_star
id|q_data
op_assign
id|lynx-&gt;rcv_page
suffix:semicolon
r_if
c_cond
(paren
(paren
op_star
id|q_data
op_rshift
l_int|4
op_amp
l_int|0xf
)paren
op_eq
id|TCODE_READQ_RESPONSE
op_logical_or
(paren
op_star
id|q_data
op_rshift
l_int|4
op_amp
l_int|0xf
)paren
op_eq
id|TCODE_WRITEQ
)paren
(brace
id|cpu_to_be32s
c_func
(paren
id|q_data
op_plus
l_int|3
)paren
suffix:semicolon
)brace
id|hpsb_packet_received
c_func
(paren
id|host
comma
id|q_data
comma
id|stat
op_amp
l_int|0x1fff
comma
l_int|0
)paren
suffix:semicolon
)brace
id|run_pcl
c_func
(paren
id|lynx
comma
id|lynx-&gt;rcv_pcl_start
comma
id|CHANNEL_ASYNC_RCV
)paren
suffix:semicolon
)brace
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
DECL|function|iso_rcv_bh
r_static
r_void
id|iso_rcv_bh
c_func
(paren
r_struct
id|ti_lynx
op_star
id|lynx
)paren
(brace
r_int
r_int
id|idx
suffix:semicolon
id|quadlet_t
op_star
id|data
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|lynx-&gt;iso_rcv.lock
comma
id|flags
)paren
suffix:semicolon
r_while
c_loop
(paren
id|lynx-&gt;iso_rcv.used
)paren
(brace
id|idx
op_assign
id|lynx-&gt;iso_rcv.last
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|lynx-&gt;iso_rcv.lock
comma
id|flags
)paren
suffix:semicolon
id|data
op_assign
id|lynx-&gt;iso_rcv.page
(braket
id|idx
op_div
id|ISORCV_PER_PAGE
)braket
op_plus
(paren
id|idx
op_mod
id|ISORCV_PER_PAGE
)paren
op_star
id|MAX_ISORCV_SIZE
suffix:semicolon
r_if
c_cond
(paren
(paren
op_star
id|data
op_rshift
l_int|16
)paren
op_plus
l_int|4
op_ne
(paren
id|lynx-&gt;iso_rcv.stat
(braket
id|idx
)braket
op_amp
l_int|0x1fff
)paren
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|lynx-&gt;id
comma
l_string|&quot;iso length mismatch 0x%08x/0x%08x&quot;
comma
op_star
id|data
comma
id|lynx-&gt;iso_rcv.stat
(braket
id|idx
)braket
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|lynx-&gt;iso_rcv.stat
(braket
id|idx
)braket
op_amp
(paren
id|DMA_CHAN_STAT_PCIERR
op_or
id|DMA_CHAN_STAT_PKTERR
)paren
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|lynx-&gt;id
comma
l_string|&quot;iso receive error on %d to 0x%p&quot;
comma
id|idx
comma
id|data
)paren
suffix:semicolon
)brace
r_else
(brace
id|hpsb_packet_received
c_func
(paren
id|lynx-&gt;host
comma
id|data
comma
id|lynx-&gt;iso_rcv.stat
(braket
id|idx
)braket
op_amp
l_int|0x1fff
comma
l_int|0
)paren
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|lynx-&gt;iso_rcv.lock
comma
id|flags
)paren
suffix:semicolon
id|lynx-&gt;iso_rcv.last
op_assign
(paren
id|idx
op_plus
l_int|1
)paren
op_mod
id|NUM_ISORCV_PCL
suffix:semicolon
id|lynx-&gt;iso_rcv.used
op_decrement
suffix:semicolon
)brace
r_if
c_cond
(paren
id|lynx-&gt;iso_rcv.chan_count
)paren
(brace
id|reg_write
c_func
(paren
id|lynx
comma
id|DMA_WORD1_CMP_ENABLE
c_func
(paren
id|CHANNEL_ISO_RCV
)paren
comma
id|DMA_WORD1_CMP_ENABLE_MASTER
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|lynx-&gt;iso_rcv.lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|remove_card
r_static
r_void
id|remove_card
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
r_struct
id|ti_lynx
op_star
id|lynx
suffix:semicolon
r_struct
id|device
op_star
id|lynx_dev
suffix:semicolon
r_int
id|i
suffix:semicolon
id|lynx
op_assign
id|pci_get_drvdata
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|lynx
)paren
r_return
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|dev
comma
l_int|NULL
)paren
suffix:semicolon
id|lynx_dev
op_assign
id|get_device
c_func
(paren
op_amp
id|lynx-&gt;host-&gt;device
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|lynx-&gt;state
)paren
(brace
r_case
id|is_host
suffix:colon
id|reg_write
c_func
(paren
id|lynx
comma
id|PCI_INT_ENABLE
comma
l_int|0
)paren
suffix:semicolon
id|hpsb_remove_host
c_func
(paren
id|lynx-&gt;host
)paren
suffix:semicolon
r_case
id|have_intr
suffix:colon
id|reg_write
c_func
(paren
id|lynx
comma
id|PCI_INT_ENABLE
comma
l_int|0
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|lynx-&gt;dev-&gt;irq
comma
id|lynx
)paren
suffix:semicolon
multiline_comment|/* Disable IRM Contender and LCtrl */
r_if
c_cond
(paren
id|lynx-&gt;phyic.reg_1394a
)paren
id|set_phy_reg
c_func
(paren
id|lynx
comma
l_int|4
comma
op_complement
l_int|0xc0
op_amp
id|get_phy_reg
c_func
(paren
id|lynx
comma
l_int|4
)paren
)paren
suffix:semicolon
multiline_comment|/* Let all other nodes know to ignore us */
id|lynx_devctl
c_func
(paren
id|lynx-&gt;host
comma
id|RESET_BUS
comma
id|LONG_RESET_NO_FORCE_ROOT
)paren
suffix:semicolon
r_case
id|have_iomappings
suffix:colon
id|reg_set_bits
c_func
(paren
id|lynx
comma
id|MISC_CONTROL
comma
id|MISC_CONTROL_SWRESET
)paren
suffix:semicolon
multiline_comment|/* Fix buggy cards with autoboot pin not tied low: */
id|reg_write
c_func
(paren
id|lynx
comma
id|DMA0_CHAN_CTRL
comma
l_int|0
)paren
suffix:semicolon
id|iounmap
c_func
(paren
id|lynx-&gt;registers
)paren
suffix:semicolon
id|iounmap
c_func
(paren
id|lynx-&gt;local_rom
)paren
suffix:semicolon
id|iounmap
c_func
(paren
id|lynx-&gt;local_ram
)paren
suffix:semicolon
id|iounmap
c_func
(paren
id|lynx-&gt;aux_port
)paren
suffix:semicolon
r_case
id|have_1394_buffers
suffix:colon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ISORCV_PAGES
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|lynx-&gt;iso_rcv.page
(braket
id|i
)braket
)paren
(brace
id|pci_free_consistent
c_func
(paren
id|lynx-&gt;dev
comma
id|PAGE_SIZE
comma
id|lynx-&gt;iso_rcv.page
(braket
id|i
)braket
comma
id|lynx-&gt;iso_rcv.page_dma
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
)brace
id|pci_free_consistent
c_func
(paren
id|lynx-&gt;dev
comma
id|PAGE_SIZE
comma
id|lynx-&gt;rcv_page
comma
id|lynx-&gt;rcv_page_dma
)paren
suffix:semicolon
r_case
id|have_aux_buf
suffix:colon
macro_line|#ifdef CONFIG_IEEE1394_PCILYNX_PORTS
id|pci_free_consistent
c_func
(paren
id|lynx-&gt;dev
comma
l_int|65536
comma
id|lynx-&gt;mem_dma_buffer
comma
id|lynx-&gt;mem_dma_buffer_dma
)paren
suffix:semicolon
macro_line|#endif
r_case
id|have_pcl_mem
suffix:colon
macro_line|#ifndef CONFIG_IEEE1394_PCILYNX_LOCALRAM
id|pci_free_consistent
c_func
(paren
id|lynx-&gt;dev
comma
id|LOCALRAM_SIZE
comma
id|lynx-&gt;pcl_mem
comma
id|lynx-&gt;pcl_mem_dma
)paren
suffix:semicolon
macro_line|#endif
r_case
id|clear
suffix:colon
multiline_comment|/* do nothing - already freed */
suffix:semicolon
)brace
id|tasklet_kill
c_func
(paren
op_amp
id|lynx-&gt;iso_rcv.tq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lynx_dev
)paren
id|put_device
c_func
(paren
id|lynx_dev
)paren
suffix:semicolon
)brace
DECL|function|add_card
r_static
r_int
id|__devinit
id|add_card
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_const
r_struct
id|pci_device_id
op_star
id|devid_is_unused
)paren
(brace
DECL|macro|FAIL
mdefine_line|#define FAIL(fmt, args...) do { &bslash;&n;        PRINT_G(KERN_ERR, fmt , ## args); &bslash;&n;        remove_card(dev); &bslash;&n;        return error; &bslash;&n;        } while (0)
r_char
id|irq_buf
(braket
l_int|16
)braket
suffix:semicolon
r_struct
id|hpsb_host
op_star
id|host
suffix:semicolon
r_struct
id|ti_lynx
op_star
id|lynx
suffix:semicolon
multiline_comment|/* shortcut to currently handled device */
r_struct
id|ti_pcl
id|pcl
suffix:semicolon
id|u32
op_star
id|pcli
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|error
suffix:semicolon
id|error
op_assign
op_minus
id|ENXIO
suffix:semicolon
r_if
c_cond
(paren
id|pci_set_dma_mask
c_func
(paren
id|dev
comma
l_int|0xffffffff
)paren
)paren
id|FAIL
c_func
(paren
l_string|&quot;DMA address limits not supported for PCILynx hardware&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_enable_device
c_func
(paren
id|dev
)paren
)paren
id|FAIL
c_func
(paren
l_string|&quot;failed to enable PCILynx hardware&quot;
)paren
suffix:semicolon
id|pci_set_master
c_func
(paren
id|dev
)paren
suffix:semicolon
id|error
op_assign
op_minus
id|ENOMEM
suffix:semicolon
id|host
op_assign
id|hpsb_alloc_host
c_func
(paren
op_amp
id|lynx_driver
comma
r_sizeof
(paren
r_struct
id|ti_lynx
)paren
comma
op_amp
id|dev-&gt;dev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|host
)paren
id|FAIL
c_func
(paren
l_string|&quot;failed to allocate control structure memory&quot;
)paren
suffix:semicolon
id|lynx
op_assign
id|host-&gt;hostdata
suffix:semicolon
id|lynx-&gt;id
op_assign
id|card_id
op_increment
suffix:semicolon
id|lynx-&gt;dev
op_assign
id|dev
suffix:semicolon
id|lynx-&gt;state
op_assign
id|clear
suffix:semicolon
id|lynx-&gt;host
op_assign
id|host
suffix:semicolon
id|host-&gt;pdev
op_assign
id|dev
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|dev
comma
id|lynx
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|lynx-&gt;lock
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|lynx-&gt;phy_reg_lock
)paren
suffix:semicolon
macro_line|#ifndef CONFIG_IEEE1394_PCILYNX_LOCALRAM
id|lynx-&gt;pcl_mem
op_assign
id|pci_alloc_consistent
c_func
(paren
id|dev
comma
id|LOCALRAM_SIZE
comma
op_amp
id|lynx-&gt;pcl_mem_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lynx-&gt;pcl_mem
op_ne
l_int|NULL
)paren
(brace
id|lynx-&gt;state
op_assign
id|have_pcl_mem
suffix:semicolon
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|lynx-&gt;id
comma
l_string|&quot;allocated PCL memory %d Bytes @ 0x%p&quot;
comma
id|LOCALRAM_SIZE
comma
id|lynx-&gt;pcl_mem
)paren
suffix:semicolon
)brace
r_else
(brace
id|FAIL
c_func
(paren
l_string|&quot;failed to allocate PCL memory area&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifdef CONFIG_IEEE1394_PCILYNX_PORTS
id|lynx-&gt;mem_dma_buffer
op_assign
id|pci_alloc_consistent
c_func
(paren
id|dev
comma
l_int|65536
comma
op_amp
id|lynx-&gt;mem_dma_buffer_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lynx-&gt;mem_dma_buffer
op_eq
l_int|NULL
)paren
(brace
id|FAIL
c_func
(paren
l_string|&quot;failed to allocate DMA buffer for aux&quot;
)paren
suffix:semicolon
)brace
id|lynx-&gt;state
op_assign
id|have_aux_buf
suffix:semicolon
macro_line|#endif
id|lynx-&gt;rcv_page
op_assign
id|pci_alloc_consistent
c_func
(paren
id|dev
comma
id|PAGE_SIZE
comma
op_amp
id|lynx-&gt;rcv_page_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lynx-&gt;rcv_page
op_eq
l_int|NULL
)paren
(brace
id|FAIL
c_func
(paren
l_string|&quot;failed to allocate receive buffer&quot;
)paren
suffix:semicolon
)brace
id|lynx-&gt;state
op_assign
id|have_1394_buffers
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ISORCV_PAGES
suffix:semicolon
id|i
op_increment
)paren
(brace
id|lynx-&gt;iso_rcv.page
(braket
id|i
)braket
op_assign
id|pci_alloc_consistent
c_func
(paren
id|dev
comma
id|PAGE_SIZE
comma
op_amp
id|lynx-&gt;iso_rcv.page_dma
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lynx-&gt;iso_rcv.page
(braket
id|i
)braket
op_eq
l_int|NULL
)paren
(brace
id|FAIL
c_func
(paren
l_string|&quot;failed to allocate iso receive buffers&quot;
)paren
suffix:semicolon
)brace
)brace
id|lynx-&gt;registers
op_assign
id|ioremap_nocache
c_func
(paren
id|pci_resource_start
c_func
(paren
id|dev
comma
l_int|0
)paren
comma
id|PCILYNX_MAX_REGISTER
)paren
suffix:semicolon
id|lynx-&gt;local_ram
op_assign
id|ioremap
c_func
(paren
id|pci_resource_start
c_func
(paren
id|dev
comma
l_int|1
)paren
comma
id|PCILYNX_MAX_MEMORY
)paren
suffix:semicolon
id|lynx-&gt;aux_port
op_assign
id|ioremap
c_func
(paren
id|pci_resource_start
c_func
(paren
id|dev
comma
l_int|2
)paren
comma
id|PCILYNX_MAX_MEMORY
)paren
suffix:semicolon
id|lynx-&gt;local_rom
op_assign
id|ioremap
c_func
(paren
id|pci_resource_start
c_func
(paren
id|dev
comma
id|PCI_ROM_RESOURCE
)paren
comma
id|PCILYNX_MAX_MEMORY
)paren
suffix:semicolon
id|lynx-&gt;state
op_assign
id|have_iomappings
suffix:semicolon
r_if
c_cond
(paren
id|lynx-&gt;registers
op_eq
l_int|NULL
)paren
(brace
id|FAIL
c_func
(paren
l_string|&quot;failed to remap registers - card not accessible&quot;
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_IEEE1394_PCILYNX_LOCALRAM
r_if
c_cond
(paren
id|lynx-&gt;local_ram
op_eq
l_int|NULL
)paren
(brace
id|FAIL
c_func
(paren
l_string|&quot;failed to remap local RAM which is required for &quot;
l_string|&quot;operation&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
id|reg_set_bits
c_func
(paren
id|lynx
comma
id|MISC_CONTROL
comma
id|MISC_CONTROL_SWRESET
)paren
suffix:semicolon
multiline_comment|/* Fix buggy cards with autoboot pin not tied low: */
id|reg_write
c_func
(paren
id|lynx
comma
id|DMA0_CHAN_CTRL
comma
l_int|0
)paren
suffix:semicolon
macro_line|#ifndef __sparc__
id|sprintf
(paren
id|irq_buf
comma
l_string|&quot;%d&quot;
comma
id|dev-&gt;irq
)paren
suffix:semicolon
macro_line|#else
id|sprintf
(paren
id|irq_buf
comma
l_string|&quot;%s&quot;
comma
id|__irq_itoa
c_func
(paren
id|dev-&gt;irq
)paren
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
id|lynx_irq_handler
comma
id|SA_SHIRQ
comma
id|PCILYNX_DRIVER_NAME
comma
id|lynx
)paren
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|lynx-&gt;id
comma
l_string|&quot;allocated interrupt %s&quot;
comma
id|irq_buf
)paren
suffix:semicolon
id|lynx-&gt;state
op_assign
id|have_intr
suffix:semicolon
)brace
r_else
(brace
id|FAIL
c_func
(paren
l_string|&quot;failed to allocate shared interrupt %s&quot;
comma
id|irq_buf
)paren
suffix:semicolon
)brace
multiline_comment|/* alloc_pcl return values are not checked, it is expected that the&n;         * provided PCL space is sufficient for the initial allocations */
macro_line|#ifdef CONFIG_IEEE1394_PCILYNX_PORTS
r_if
c_cond
(paren
id|lynx-&gt;aux_port
op_ne
l_int|NULL
)paren
(brace
id|lynx-&gt;dmem_pcl
op_assign
id|alloc_pcl
c_func
(paren
id|lynx
)paren
suffix:semicolon
id|aux_setup_pcls
c_func
(paren
id|lynx
)paren
suffix:semicolon
id|sema_init
c_func
(paren
op_amp
id|lynx-&gt;mem_dma_mutex
comma
l_int|1
)paren
suffix:semicolon
)brace
macro_line|#endif
id|lynx-&gt;rcv_pcl
op_assign
id|alloc_pcl
c_func
(paren
id|lynx
)paren
suffix:semicolon
id|lynx-&gt;rcv_pcl_start
op_assign
id|alloc_pcl
c_func
(paren
id|lynx
)paren
suffix:semicolon
id|lynx-&gt;async.pcl
op_assign
id|alloc_pcl
c_func
(paren
id|lynx
)paren
suffix:semicolon
id|lynx-&gt;async.pcl_start
op_assign
id|alloc_pcl
c_func
(paren
id|lynx
)paren
suffix:semicolon
id|lynx-&gt;iso_send.pcl
op_assign
id|alloc_pcl
c_func
(paren
id|lynx
)paren
suffix:semicolon
id|lynx-&gt;iso_send.pcl_start
op_assign
id|alloc_pcl
c_func
(paren
id|lynx
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_ISORCV_PCL
suffix:semicolon
id|i
op_increment
)paren
(brace
id|lynx-&gt;iso_rcv.pcl
(braket
id|i
)braket
op_assign
id|alloc_pcl
c_func
(paren
id|lynx
)paren
suffix:semicolon
)brace
id|lynx-&gt;iso_rcv.pcl_start
op_assign
id|alloc_pcl
c_func
(paren
id|lynx
)paren
suffix:semicolon
multiline_comment|/* all allocations successful - simple init stuff follows */
id|reg_write
c_func
(paren
id|lynx
comma
id|PCI_INT_ENABLE
comma
id|PCI_INT_DMA_ALL
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_IEEE1394_PCILYNX_PORTS
id|reg_set_bits
c_func
(paren
id|lynx
comma
id|PCI_INT_ENABLE
comma
id|PCI_INT_AUX_INT
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|lynx-&gt;mem_dma_intr_wait
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|lynx-&gt;aux_intr_wait
)paren
suffix:semicolon
macro_line|#endif
id|tasklet_init
c_func
(paren
op_amp
id|lynx-&gt;iso_rcv.tq
comma
(paren
r_void
(paren
op_star
)paren
(paren
r_int
r_int
)paren
)paren
id|iso_rcv_bh
comma
(paren
r_int
r_int
)paren
id|lynx
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|lynx-&gt;iso_rcv.lock
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|lynx-&gt;async.queue_lock
)paren
suffix:semicolon
id|lynx-&gt;async.channel
op_assign
id|CHANNEL_ASYNC_SEND
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|lynx-&gt;iso_send.queue_lock
)paren
suffix:semicolon
id|lynx-&gt;iso_send.channel
op_assign
id|CHANNEL_ISO_SEND
suffix:semicolon
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|lynx-&gt;id
comma
l_string|&quot;remapped memory spaces reg 0x%p, rom 0x%p, &quot;
l_string|&quot;ram 0x%p, aux 0x%p&quot;
comma
id|lynx-&gt;registers
comma
id|lynx-&gt;local_rom
comma
id|lynx-&gt;local_ram
comma
id|lynx-&gt;aux_port
)paren
suffix:semicolon
multiline_comment|/* now, looking for PHY register set */
r_if
c_cond
(paren
(paren
id|get_phy_reg
c_func
(paren
id|lynx
comma
l_int|2
)paren
op_amp
l_int|0xe0
)paren
op_eq
l_int|0xe0
)paren
(brace
id|lynx-&gt;phyic.reg_1394a
op_assign
l_int|1
suffix:semicolon
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|lynx-&gt;id
comma
l_string|&quot;found 1394a conform PHY (using extended register set)&quot;
)paren
suffix:semicolon
id|lynx-&gt;phyic.vendor
op_assign
id|get_phy_vendorid
c_func
(paren
id|lynx
)paren
suffix:semicolon
id|lynx-&gt;phyic.product
op_assign
id|get_phy_productid
c_func
(paren
id|lynx
)paren
suffix:semicolon
)brace
r_else
(brace
id|lynx-&gt;phyic.reg_1394a
op_assign
l_int|0
suffix:semicolon
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|lynx-&gt;id
comma
l_string|&quot;found old 1394 PHY&quot;
)paren
suffix:semicolon
)brace
id|lynx-&gt;selfid_size
op_assign
op_minus
l_int|1
suffix:semicolon
id|lynx-&gt;phy_reg0
op_assign
op_minus
l_int|1
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|lynx-&gt;async.queue
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|lynx-&gt;async.pcl_queue
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|lynx-&gt;iso_send.queue
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|lynx-&gt;iso_send.pcl_queue
)paren
suffix:semicolon
id|pcl.next
op_assign
id|pcl_bus
c_func
(paren
id|lynx
comma
id|lynx-&gt;rcv_pcl
)paren
suffix:semicolon
id|put_pcl
c_func
(paren
id|lynx
comma
id|lynx-&gt;rcv_pcl_start
comma
op_amp
id|pcl
)paren
suffix:semicolon
id|pcl.next
op_assign
id|PCL_NEXT_INVALID
suffix:semicolon
id|pcl.async_error_next
op_assign
id|PCL_NEXT_INVALID
suffix:semicolon
id|pcl.buffer
(braket
l_int|0
)braket
dot
id|control
op_assign
id|PCL_CMD_RCV
op_or
l_int|16
suffix:semicolon
macro_line|#ifndef __BIG_ENDIAN
id|pcl.buffer
(braket
l_int|0
)braket
dot
id|control
op_or_assign
id|PCL_BIGENDIAN
suffix:semicolon
macro_line|#endif
id|pcl.buffer
(braket
l_int|1
)braket
dot
id|control
op_assign
id|PCL_LAST_BUFF
op_or
l_int|4080
suffix:semicolon
id|pcl.buffer
(braket
l_int|0
)braket
dot
id|pointer
op_assign
id|lynx-&gt;rcv_page_dma
suffix:semicolon
id|pcl.buffer
(braket
l_int|1
)braket
dot
id|pointer
op_assign
id|lynx-&gt;rcv_page_dma
op_plus
l_int|16
suffix:semicolon
id|put_pcl
c_func
(paren
id|lynx
comma
id|lynx-&gt;rcv_pcl
comma
op_amp
id|pcl
)paren
suffix:semicolon
id|pcl.next
op_assign
id|pcl_bus
c_func
(paren
id|lynx
comma
id|lynx-&gt;async.pcl
)paren
suffix:semicolon
id|pcl.async_error_next
op_assign
id|pcl_bus
c_func
(paren
id|lynx
comma
id|lynx-&gt;async.pcl
)paren
suffix:semicolon
id|put_pcl
c_func
(paren
id|lynx
comma
id|lynx-&gt;async.pcl_start
comma
op_amp
id|pcl
)paren
suffix:semicolon
id|pcl.next
op_assign
id|pcl_bus
c_func
(paren
id|lynx
comma
id|lynx-&gt;iso_send.pcl
)paren
suffix:semicolon
id|pcl.async_error_next
op_assign
id|PCL_NEXT_INVALID
suffix:semicolon
id|put_pcl
c_func
(paren
id|lynx
comma
id|lynx-&gt;iso_send.pcl_start
comma
op_amp
id|pcl
)paren
suffix:semicolon
id|pcl.next
op_assign
id|PCL_NEXT_INVALID
suffix:semicolon
id|pcl.async_error_next
op_assign
id|PCL_NEXT_INVALID
suffix:semicolon
id|pcl.buffer
(braket
l_int|0
)braket
dot
id|control
op_assign
id|PCL_CMD_RCV
op_or
l_int|4
suffix:semicolon
macro_line|#ifndef __BIG_ENDIAN
id|pcl.buffer
(braket
l_int|0
)braket
dot
id|control
op_or_assign
id|PCL_BIGENDIAN
suffix:semicolon
macro_line|#endif
id|pcl.buffer
(braket
l_int|1
)braket
dot
id|control
op_assign
id|PCL_LAST_BUFF
op_or
l_int|2044
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_ISORCV_PCL
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
id|page
op_assign
id|i
op_div
id|ISORCV_PER_PAGE
suffix:semicolon
r_int
id|sec
op_assign
id|i
op_mod
id|ISORCV_PER_PAGE
suffix:semicolon
id|pcl.buffer
(braket
l_int|0
)braket
dot
id|pointer
op_assign
id|lynx-&gt;iso_rcv.page_dma
(braket
id|page
)braket
op_plus
id|sec
op_star
id|MAX_ISORCV_SIZE
suffix:semicolon
id|pcl.buffer
(braket
l_int|1
)braket
dot
id|pointer
op_assign
id|pcl.buffer
(braket
l_int|0
)braket
dot
id|pointer
op_plus
l_int|4
suffix:semicolon
id|put_pcl
c_func
(paren
id|lynx
comma
id|lynx-&gt;iso_rcv.pcl
(braket
id|i
)braket
comma
op_amp
id|pcl
)paren
suffix:semicolon
)brace
id|pcli
op_assign
(paren
id|u32
op_star
)paren
op_amp
id|pcl
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_ISORCV_PCL
suffix:semicolon
id|i
op_increment
)paren
(brace
id|pcli
(braket
id|i
)braket
op_assign
id|pcl_bus
c_func
(paren
id|lynx
comma
id|lynx-&gt;iso_rcv.pcl
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|put_pcl
c_func
(paren
id|lynx
comma
id|lynx-&gt;iso_rcv.pcl_start
comma
op_amp
id|pcl
)paren
suffix:semicolon
multiline_comment|/* FIFO sizes from left to right: ITF=48 ATF=48 GRF=160 */
id|reg_write
c_func
(paren
id|lynx
comma
id|FIFO_SIZES
comma
l_int|0x003030a0
)paren
suffix:semicolon
multiline_comment|/* 20 byte threshold before triggering PCI transfer */
id|reg_write
c_func
(paren
id|lynx
comma
id|DMA_GLOBAL_REGISTER
comma
l_int|0x2
op_lshift
l_int|24
)paren
suffix:semicolon
multiline_comment|/* threshold on both send FIFOs before transmitting:&n;           FIFO size - cache line size - 1 */
id|i
op_assign
id|reg_read
c_func
(paren
id|lynx
comma
id|PCI_LATENCY_CACHELINE
)paren
op_amp
l_int|0xff
suffix:semicolon
id|i
op_assign
l_int|0x30
op_minus
id|i
op_minus
l_int|1
suffix:semicolon
id|reg_write
c_func
(paren
id|lynx
comma
id|FIFO_XMIT_THRESHOLD
comma
(paren
id|i
op_lshift
l_int|8
)paren
op_or
id|i
)paren
suffix:semicolon
id|reg_set_bits
c_func
(paren
id|lynx
comma
id|PCI_INT_ENABLE
comma
id|PCI_INT_1394
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|lynx
comma
id|LINK_INT_ENABLE
comma
id|LINK_INT_PHY_TIMEOUT
op_or
id|LINK_INT_PHY_REG_RCVD
op_or
id|LINK_INT_PHY_BUSRESET
op_or
id|LINK_INT_ISO_STUCK
op_or
id|LINK_INT_ASYNC_STUCK
op_or
id|LINK_INT_SENT_REJECT
op_or
id|LINK_INT_TX_INVALID_TC
op_or
id|LINK_INT_GRF_OVERFLOW
op_or
id|LINK_INT_ITF_UNDERFLOW
op_or
id|LINK_INT_ATF_UNDERFLOW
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|lynx
comma
id|DMA_WORD0_CMP_VALUE
c_func
(paren
id|CHANNEL_ASYNC_RCV
)paren
comma
l_int|0
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|lynx
comma
id|DMA_WORD0_CMP_ENABLE
c_func
(paren
id|CHANNEL_ASYNC_RCV
)paren
comma
l_int|0xa
op_lshift
l_int|4
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|lynx
comma
id|DMA_WORD1_CMP_VALUE
c_func
(paren
id|CHANNEL_ASYNC_RCV
)paren
comma
l_int|0
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|lynx
comma
id|DMA_WORD1_CMP_ENABLE
c_func
(paren
id|CHANNEL_ASYNC_RCV
)paren
comma
id|DMA_WORD1_CMP_MATCH_LOCAL_NODE
op_or
id|DMA_WORD1_CMP_MATCH_BROADCAST
op_or
id|DMA_WORD1_CMP_MATCH_EXACT
op_or
id|DMA_WORD1_CMP_MATCH_BUS_BCAST
op_or
id|DMA_WORD1_CMP_ENABLE_SELF_ID
op_or
id|DMA_WORD1_CMP_ENABLE_MASTER
)paren
suffix:semicolon
id|run_pcl
c_func
(paren
id|lynx
comma
id|lynx-&gt;rcv_pcl_start
comma
id|CHANNEL_ASYNC_RCV
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|lynx
comma
id|DMA_WORD0_CMP_VALUE
c_func
(paren
id|CHANNEL_ISO_RCV
)paren
comma
l_int|0
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|lynx
comma
id|DMA_WORD0_CMP_ENABLE
c_func
(paren
id|CHANNEL_ISO_RCV
)paren
comma
l_int|0x9
op_lshift
l_int|4
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|lynx
comma
id|DMA_WORD1_CMP_VALUE
c_func
(paren
id|CHANNEL_ISO_RCV
)paren
comma
l_int|0
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|lynx
comma
id|DMA_WORD1_CMP_ENABLE
c_func
(paren
id|CHANNEL_ISO_RCV
)paren
comma
l_int|0
)paren
suffix:semicolon
id|run_sub_pcl
c_func
(paren
id|lynx
comma
id|lynx-&gt;iso_rcv.pcl_start
comma
l_int|0
comma
id|CHANNEL_ISO_RCV
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|lynx
comma
id|LINK_CONTROL
comma
id|LINK_CONTROL_RCV_CMP_VALID
op_or
id|LINK_CONTROL_TX_ISO_EN
op_or
id|LINK_CONTROL_RX_ISO_EN
op_or
id|LINK_CONTROL_TX_ASYNC_EN
op_or
id|LINK_CONTROL_RX_ASYNC_EN
op_or
id|LINK_CONTROL_RESET_TX
op_or
id|LINK_CONTROL_RESET_RX
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|lynx-&gt;phyic.reg_1394a
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|hpsb_disable_irm
)paren
(brace
multiline_comment|/* attempt to enable contender bit -FIXME- would this&n;&t;&t;&t; * work elsewhere? */
id|reg_set_bits
c_func
(paren
id|lynx
comma
id|GPIO_CTRL_A
comma
l_int|0x1
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|lynx
comma
id|GPIO_DATA_BASE
op_plus
l_int|0x3c
comma
l_int|0x1
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* set the contender (if appropriate) and LCtrl bit in the&n;&t;&t; * extended PHY register set. (Should check that PHY_02_EXTENDED&n;&t;&t; * is set in register 2?)&n;&t;&t; */
id|i
op_assign
id|get_phy_reg
c_func
(paren
id|lynx
comma
l_int|4
)paren
suffix:semicolon
id|i
op_or_assign
id|PHY_04_LCTRL
suffix:semicolon
r_if
c_cond
(paren
id|hpsb_disable_irm
)paren
id|i
op_and_assign
op_logical_neg
id|PHY_04_CONTENDER
suffix:semicolon
r_else
id|i
op_or_assign
id|PHY_04_CONTENDER
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ne
op_minus
l_int|1
)paren
id|set_phy_reg
c_func
(paren
id|lynx
comma
l_int|4
comma
id|i
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|skip_eeprom
)paren
(brace
multiline_comment|/* needed for i2c communication with serial eeprom */
r_struct
id|i2c_adapter
op_star
id|i2c_ad
suffix:semicolon
r_struct
id|i2c_algo_bit_data
id|i2c_adapter_data
suffix:semicolon
id|error
op_assign
op_minus
id|ENOMEM
suffix:semicolon
id|i2c_ad
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|i2c_adapter
)paren
comma
id|SLAB_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|i2c_ad
)paren
id|FAIL
c_func
(paren
l_string|&quot;failed to allocate I2C adapter memory&quot;
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|i2c_ad
comma
op_amp
id|bit_ops
comma
r_sizeof
(paren
r_struct
id|i2c_adapter
)paren
)paren
suffix:semicolon
id|i2c_adapter_data
op_assign
id|bit_data
suffix:semicolon
id|i2c_ad-&gt;algo_data
op_assign
op_amp
id|i2c_adapter_data
suffix:semicolon
id|i2c_adapter_data.data
op_assign
id|lynx
suffix:semicolon
id|PRINTD
c_func
(paren
id|KERN_DEBUG
comma
id|lynx-&gt;id
comma
l_string|&quot;original eeprom control: %d&quot;
comma
id|reg_read
c_func
(paren
id|lynx
comma
id|SERIAL_EEPROM_CONTROL
)paren
)paren
suffix:semicolon
multiline_comment|/* reset hardware to sane state */
id|lynx-&gt;i2c_driven_state
op_assign
l_int|0x00000070
suffix:semicolon
id|reg_write
c_func
(paren
id|lynx
comma
id|SERIAL_EEPROM_CONTROL
comma
id|lynx-&gt;i2c_driven_state
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i2c_bit_add_bus
c_func
(paren
id|i2c_ad
)paren
OL
l_int|0
)paren
(brace
id|kfree
c_func
(paren
id|i2c_ad
)paren
suffix:semicolon
id|error
op_assign
op_minus
id|ENXIO
suffix:semicolon
id|FAIL
c_func
(paren
l_string|&quot;unable to register i2c&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* do i2c stuff */
r_int
r_char
id|i2c_cmd
op_assign
l_int|0x10
suffix:semicolon
r_struct
id|i2c_msg
id|msg
(braket
l_int|2
)braket
op_assign
(brace
(brace
l_int|0x50
comma
l_int|0
comma
l_int|1
comma
op_amp
id|i2c_cmd
)brace
comma
(brace
l_int|0x50
comma
id|I2C_M_RD
comma
l_int|20
comma
(paren
r_int
r_char
op_star
)paren
id|lynx-&gt;bus_info_block
)brace
)brace
suffix:semicolon
macro_line|#ifdef CONFIG_IEEE1394_VERBOSEDEBUG
r_union
id|i2c_smbus_data
id|data
suffix:semicolon
r_if
c_cond
(paren
id|i2c_smbus_xfer
c_func
(paren
id|i2c_ad
comma
l_int|80
comma
l_int|0
comma
id|I2C_SMBUS_WRITE
comma
l_int|0
comma
id|I2C_SMBUS_BYTE
comma
l_int|NULL
)paren
)paren
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|lynx-&gt;id
comma
l_string|&quot;eeprom read start has failed&quot;
)paren
suffix:semicolon
r_else
(brace
id|u16
id|addr
suffix:semicolon
r_for
c_loop
(paren
id|addr
op_assign
l_int|0x00
suffix:semicolon
id|addr
OL
l_int|0x100
suffix:semicolon
id|addr
op_increment
)paren
(brace
r_if
c_cond
(paren
id|i2c_smbus_xfer
c_func
(paren
id|i2c_ad
comma
l_int|80
comma
l_int|0
comma
id|I2C_SMBUS_READ
comma
l_int|0
comma
id|I2C_SMBUS_BYTE
comma
op_amp
id|data
)paren
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|lynx-&gt;id
comma
l_string|&quot;unable to read i2c %x&quot;
comma
id|addr
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_else
id|PRINT
c_func
(paren
id|KERN_DEBUG
comma
id|lynx-&gt;id
comma
l_string|&quot;got serial eeprom data at %x: %x&quot;
comma
id|addr
comma
id|data.byte
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
multiline_comment|/* we use i2c_transfer, because i2c_smbus_read_block_data does not work properly and we&n;                           do it more efficiently in one transaction rather then using several reads */
r_if
c_cond
(paren
id|i2c_transfer
c_func
(paren
id|i2c_ad
comma
id|msg
comma
l_int|2
)paren
OL
l_int|0
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|lynx-&gt;id
comma
l_string|&quot;unable to read bus info block from i2c&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
r_int
id|i
suffix:semicolon
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|lynx-&gt;id
comma
l_string|&quot;got bus info block from serial eeprom&quot;
)paren
suffix:semicolon
multiline_comment|/* FIXME: probably we shoud rewrite the max_rec, max_ROM(1394a),&n;&t;&t;&t;&t; * generation(1394a) and link_spd(1394a) field and recalculate&n;&t;&t;&t;&t; * the CRC */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|5
suffix:semicolon
id|i
op_increment
)paren
id|PRINTD
c_func
(paren
id|KERN_DEBUG
comma
id|lynx-&gt;id
comma
l_string|&quot;Businfo block quadlet %i: %08x&quot;
comma
id|i
comma
id|be32_to_cpu
c_func
(paren
id|lynx-&gt;bus_info_block
(braket
id|i
)braket
)paren
)paren
suffix:semicolon
multiline_comment|/* info_length, crc_length and 1394 magic number to check, if it is really a bus info block */
r_if
c_cond
(paren
(paren
(paren
id|be32_to_cpu
c_func
(paren
id|lynx-&gt;bus_info_block
(braket
l_int|0
)braket
)paren
op_amp
l_int|0xffff0000
)paren
op_eq
l_int|0x04040000
)paren
op_logical_and
(paren
id|lynx-&gt;bus_info_block
(braket
l_int|1
)braket
op_eq
id|__constant_cpu_to_be32
c_func
(paren
l_int|0x31333934
)paren
)paren
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_DEBUG
comma
id|lynx-&gt;id
comma
l_string|&quot;read a valid bus info block from&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|kfree
c_func
(paren
id|i2c_ad
)paren
suffix:semicolon
id|error
op_assign
op_minus
id|ENXIO
suffix:semicolon
id|FAIL
c_func
(paren
l_string|&quot;read something from serial eeprom, but it does not seem to be a valid bus info block&quot;
)paren
suffix:semicolon
)brace
)brace
id|i2c_bit_del_bus
c_func
(paren
id|i2c_ad
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|i2c_ad
)paren
suffix:semicolon
)brace
)brace
id|host-&gt;csr.guid_hi
op_assign
id|be32_to_cpu
c_func
(paren
id|lynx-&gt;bus_info_block
(braket
l_int|3
)braket
)paren
suffix:semicolon
id|host-&gt;csr.guid_lo
op_assign
id|be32_to_cpu
c_func
(paren
id|lynx-&gt;bus_info_block
(braket
l_int|4
)braket
)paren
suffix:semicolon
id|host-&gt;csr.cyc_clk_acc
op_assign
(paren
id|be32_to_cpu
c_func
(paren
id|lynx-&gt;bus_info_block
(braket
l_int|2
)braket
)paren
op_rshift
l_int|16
)paren
op_amp
l_int|0xff
suffix:semicolon
id|host-&gt;csr.max_rec
op_assign
(paren
id|be32_to_cpu
c_func
(paren
id|lynx-&gt;bus_info_block
(braket
l_int|2
)braket
)paren
op_rshift
l_int|12
)paren
op_amp
l_int|0xf
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|lynx-&gt;phyic.reg_1394a
)paren
id|host-&gt;csr.lnk_spd
op_assign
(paren
id|get_phy_reg
c_func
(paren
id|lynx
comma
l_int|2
)paren
op_amp
l_int|0xc0
)paren
op_rshift
l_int|6
suffix:semicolon
r_else
id|host-&gt;csr.lnk_spd
op_assign
id|be32_to_cpu
c_func
(paren
id|lynx-&gt;bus_info_block
(braket
l_int|2
)braket
)paren
op_amp
l_int|0x7
suffix:semicolon
r_if
c_cond
(paren
id|hpsb_add_host
c_func
(paren
id|host
)paren
)paren
(brace
id|error
op_assign
op_minus
id|ENOMEM
suffix:semicolon
id|FAIL
c_func
(paren
l_string|&quot;Failed to register host with highlevel&quot;
)paren
suffix:semicolon
)brace
id|lynx-&gt;state
op_assign
id|is_host
suffix:semicolon
r_return
l_int|0
suffix:semicolon
DECL|macro|FAIL
macro_line|#undef FAIL
)brace
DECL|variable|pci_table
r_static
r_struct
id|pci_device_id
id|pci_table
(braket
)braket
op_assign
(brace
(brace
dot
id|vendor
op_assign
id|PCI_VENDOR_ID_TI
comma
dot
id|device
op_assign
id|PCI_DEVICE_ID_TI_PCILYNX
comma
dot
id|subvendor
op_assign
id|PCI_ANY_ID
comma
dot
id|subdevice
op_assign
id|PCI_ANY_ID
comma
)brace
comma
(brace
)brace
multiline_comment|/* Terminating entry */
)brace
suffix:semicolon
DECL|variable|lynx_pci_driver
r_static
r_struct
id|pci_driver
id|lynx_pci_driver
op_assign
(brace
dot
id|name
op_assign
id|PCILYNX_DRIVER_NAME
comma
dot
id|id_table
op_assign
id|pci_table
comma
dot
id|probe
op_assign
id|add_card
comma
dot
id|remove
op_assign
id|remove_card
comma
)brace
suffix:semicolon
DECL|variable|lynx_driver
r_static
r_struct
id|hpsb_host_driver
id|lynx_driver
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|name
op_assign
id|PCILYNX_DRIVER_NAME
comma
dot
id|set_hw_config_rom
op_assign
l_int|NULL
comma
dot
id|transmit_packet
op_assign
id|lynx_transmit
comma
dot
id|devctl
op_assign
id|lynx_devctl
comma
dot
id|isoctl
op_assign
l_int|NULL
comma
)brace
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Andreas E. Bombe &lt;andreas.bombe@munich.netsurf.de&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;driver for Texas Instruments PCI Lynx IEEE-1394 controller&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|MODULE_SUPPORTED_DEVICE
c_func
(paren
l_string|&quot;pcilynx&quot;
)paren
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|pci
comma
id|pci_table
)paren
suffix:semicolon
DECL|function|pcilynx_init
r_static
r_int
id|__init
id|pcilynx_init
c_func
(paren
r_void
)paren
(brace
r_int
id|ret
suffix:semicolon
macro_line|#ifdef CONFIG_IEEE1394_PCILYNX_PORTS
r_if
c_cond
(paren
id|register_chrdev
c_func
(paren
id|PCILYNX_MAJOR
comma
id|PCILYNX_DRIVER_NAME
comma
op_amp
id|aux_ops
)paren
)paren
(brace
id|PRINT_G
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;allocation of char major number %d failed&quot;
comma
id|PCILYNX_MAJOR
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
macro_line|#endif
id|ret
op_assign
id|pci_module_init
c_func
(paren
op_amp
id|lynx_pci_driver
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
id|PRINT_G
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;PCI module init failed&quot;
)paren
suffix:semicolon
r_goto
id|free_char_dev
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
id|free_char_dev
suffix:colon
macro_line|#ifdef CONFIG_IEEE1394_PCILYNX_PORTS
id|unregister_chrdev
c_func
(paren
id|PCILYNX_MAJOR
comma
id|PCILYNX_DRIVER_NAME
)paren
suffix:semicolon
macro_line|#endif
r_return
id|ret
suffix:semicolon
)brace
DECL|function|pcilynx_cleanup
r_static
r_void
id|__exit
id|pcilynx_cleanup
c_func
(paren
r_void
)paren
(brace
id|pci_unregister_driver
c_func
(paren
op_amp
id|lynx_pci_driver
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_IEEE1394_PCILYNX_PORTS
id|unregister_chrdev
c_func
(paren
id|PCILYNX_MAJOR
comma
id|PCILYNX_DRIVER_NAME
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|variable|pcilynx_init
id|module_init
c_func
(paren
id|pcilynx_init
)paren
suffix:semicolon
DECL|variable|pcilynx_cleanup
id|module_exit
c_func
(paren
id|pcilynx_cleanup
)paren
suffix:semicolon
eof
