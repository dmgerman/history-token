multiline_comment|/*&n; * dv1394.c - DV input/output over IEEE 1394 on OHCI chips&n; *   Copyright (C)2001 Daniel Maas &lt;dmaas@dcine.com&gt;&n; *     receive by Dan Dennedy &lt;dan@dennedy.org&gt;&n; *&n; * based on:&n; *  video1394.c - video driver for OHCI 1394 boards&n; *  Copyright (C)1999,2000 Sebastien Rougeaux &lt;sebastien.rougeaux@anu.edu.au&gt;&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or&n; * (at your option) any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software Foundation,&n; * Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.&n; */
multiline_comment|/*&n;  OVERVIEW&n;&n;  I designed dv1394 as a &quot;pipe&quot; that you can use to shoot DV onto a&n;  FireWire bus. In transmission mode, dv1394 does the following:&n;&n;   1. accepts contiguous frames of DV data from user-space, via write()&n;      or mmap() (see dv1394.h for the complete API)&n;   2. wraps IEC 61883 packets around the DV data, inserting&n;      empty synchronization packets as necessary&n;   3. assigns accurate SYT timestamps to the outgoing packets&n;   4. shoots them out using the OHCI card&squot;s IT DMA engine&n;&n;   Thanks to Dan Dennedy, we now have a receive mode that does the following:&n;&n;   1. accepts raw IEC 61883 packets from the OHCI card&n;   2. re-assembles the DV data payloads into contiguous frames,&n;      discarding empty packets&n;   3. sends the DV data to user-space via read() or mmap()&n;*/
multiline_comment|/*&n;  TODO:&n;&n;  - tunable frame-drop behavior: either loop last frame, or halt transmission&n;&n;  - use a scatter/gather buffer for DMA programs (f-&gt;descriptor_pool)&n;    so that we don&squot;t rely on allocating 64KB of contiguous kernel memory&n;    via pci_alloc_consistent()&n;&n;  DONE:&n;  - during reception, better handling of dropped frames and continuity errors&n;  - during reception, prevent DMA from bypassing the irq tasklets&n;  - reduce irq rate during reception (1/250 packets).&n;  - add many more internal buffers during reception with scatter/gather dma.&n;  - add dbc (continuity) checking on receive, increment status.dropped_frames&n;    if not continuous.&n;  - restart IT DMA after a bus reset&n;  - safely obtain and release ISO Tx channels in cooperation with OHCI driver&n;  - map received DIF blocks to their proper location in DV frame (ensure&n;    recovery if dropped packet)&n;  - handle bus resets gracefully (OHCI card seems to take care of this itself(!))&n;  - do not allow resizing the user_buf once allocated; eliminate nuke_buffer_mappings&n;  - eliminated #ifdef DV1394_DEBUG_LEVEL by inventing macros debug_printk and irq_printk&n;  - added wmb() and mb() to places where PCI read/write ordering needs to be enforced&n;  - set video-&gt;id correctly&n;  - store video_cards in an array indexed by OHCI card ID, rather than a list&n;  - implement DMA context allocation to cooperate with other users of the OHCI&n;  - fix all XXX showstoppers&n;  - disable IR/IT DMA interrupts on shutdown&n;  - flush pci writes to the card by issuing a read&n;  - devfs and character device dispatching (* needs testing with Linux 2.2.x)&n;  - switch over to the new kernel DMA API (pci_map_*()) (* needs testing on platforms with IOMMU!)&n;  - keep all video_cards in a list (for open() via chardev), set file-&gt;private_data = video&n;  - dv1394_poll should indicate POLLIN when receiving buffers are available&n;  - add proc fs interface to set cip_n, cip_d, syt_offset, and video signal&n;  - expose xmit and recv as separate devices (not exclusive)&n;  - expose NTSC and PAL as separate devices (can be overridden)&n;&n;*/
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/list.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/wait.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/poll.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/bitops.h&gt;
macro_line|#include &lt;asm/byteorder.h&gt;
macro_line|#include &lt;asm/atomic.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/page.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/vmalloc.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/ioctl32.h&gt;
macro_line|#include &lt;linux/compat.h&gt;
macro_line|#include &lt;linux/cdev.h&gt;
macro_line|#include &quot;ieee1394.h&quot;
macro_line|#include &quot;ieee1394_types.h&quot;
macro_line|#include &quot;nodemgr.h&quot;
macro_line|#include &quot;hosts.h&quot;
macro_line|#include &quot;ieee1394_core.h&quot;
macro_line|#include &quot;highlevel.h&quot;
macro_line|#include &quot;dv1394.h&quot;
macro_line|#include &quot;dv1394-private.h&quot;
macro_line|#include &quot;ohci1394.h&quot;
macro_line|#ifndef virt_to_page
DECL|macro|virt_to_page
mdefine_line|#define virt_to_page(x) MAP_NR(x)
macro_line|#endif
macro_line|#ifndef vmalloc_32
DECL|macro|vmalloc_32
mdefine_line|#define vmalloc_32(x) vmalloc(x)
macro_line|#endif
multiline_comment|/* DEBUG LEVELS:&n;   0 - no debugging messages&n;   1 - some debugging messages, but none during DMA frame transmission&n;   2 - lots of messages, including during DMA frame transmission&n;       (will cause undeflows if your machine is too slow!)&n;*/
DECL|macro|DV1394_DEBUG_LEVEL
mdefine_line|#define DV1394_DEBUG_LEVEL 0
multiline_comment|/* for debugging use ONLY: allow more than one open() of the device */
multiline_comment|/* #define DV1394_ALLOW_MORE_THAN_ONE_OPEN 1 */
macro_line|#if DV1394_DEBUG_LEVEL &gt;= 2
DECL|macro|irq_printk
mdefine_line|#define irq_printk( args... ) printk( args )
macro_line|#else
DECL|macro|irq_printk
mdefine_line|#define irq_printk( args... )
macro_line|#endif
macro_line|#if DV1394_DEBUG_LEVEL &gt;= 1
DECL|macro|debug_printk
mdefine_line|#define debug_printk( args... ) printk( args)
macro_line|#else
DECL|macro|debug_printk
mdefine_line|#define debug_printk( args... )
macro_line|#endif
multiline_comment|/* issue a dummy PCI read to force the preceding write&n;   to be posted to the PCI bus immediately */
DECL|function|flush_pci_write
r_static
r_inline
r_void
id|flush_pci_write
c_func
(paren
r_struct
id|ti_ohci
op_star
id|ohci
)paren
(brace
id|mb
c_func
(paren
)paren
suffix:semicolon
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_IsochronousCycleTimer
)paren
suffix:semicolon
)brace
r_static
r_void
id|it_tasklet_func
c_func
(paren
r_int
r_int
id|data
)paren
suffix:semicolon
r_static
r_void
id|ir_tasklet_func
c_func
(paren
r_int
r_int
id|data
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_COMPAT
r_static
r_int
id|dv1394_compat_ioctl
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* GLOBAL DATA */
multiline_comment|/* list of all video_cards */
r_static
id|LIST_HEAD
c_func
(paren
id|dv1394_cards
)paren
suffix:semicolon
DECL|variable|dv1394_cards_lock
r_static
id|spinlock_t
id|dv1394_cards_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
multiline_comment|/* translate from a struct file* to the corresponding struct video_card* */
DECL|function|file_to_video_card
r_static
r_inline
r_struct
id|video_card
op_star
id|file_to_video_card
c_func
(paren
r_struct
id|file
op_star
id|file
)paren
(brace
r_return
(paren
r_struct
id|video_card
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
)brace
multiline_comment|/*** FRAME METHODS *********************************************************/
DECL|function|frame_reset
r_static
r_void
id|frame_reset
c_func
(paren
r_struct
id|frame
op_star
id|f
)paren
(brace
id|f-&gt;state
op_assign
id|FRAME_CLEAR
suffix:semicolon
id|f-&gt;done
op_assign
l_int|0
suffix:semicolon
id|f-&gt;n_packets
op_assign
l_int|0
suffix:semicolon
id|f-&gt;frame_begin_timestamp
op_assign
l_int|NULL
suffix:semicolon
id|f-&gt;assigned_timestamp
op_assign
l_int|0
suffix:semicolon
id|f-&gt;cip_syt1
op_assign
l_int|NULL
suffix:semicolon
id|f-&gt;cip_syt2
op_assign
l_int|NULL
suffix:semicolon
id|f-&gt;mid_frame_timestamp
op_assign
l_int|NULL
suffix:semicolon
id|f-&gt;frame_end_timestamp
op_assign
l_int|NULL
suffix:semicolon
id|f-&gt;frame_end_branch
op_assign
l_int|NULL
suffix:semicolon
)brace
DECL|function|frame_new
r_static
r_struct
id|frame
op_star
id|frame_new
c_func
(paren
r_int
r_int
id|frame_num
comma
r_struct
id|video_card
op_star
id|video
)paren
(brace
r_struct
id|frame
op_star
id|f
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|f
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|f
)paren
r_return
l_int|NULL
suffix:semicolon
id|f-&gt;video
op_assign
id|video
suffix:semicolon
id|f-&gt;frame_num
op_assign
id|frame_num
suffix:semicolon
id|f-&gt;header_pool
op_assign
id|pci_alloc_consistent
c_func
(paren
id|f-&gt;video-&gt;ohci-&gt;dev
comma
id|PAGE_SIZE
comma
op_amp
id|f-&gt;header_pool_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|f-&gt;header_pool
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;dv1394: failed to allocate CIP header pool&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|f
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|debug_printk
c_func
(paren
l_string|&quot;dv1394: frame_new: allocated CIP header pool at virt 0x%08lx (contig) dma 0x%08lx size %ld&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|f-&gt;header_pool
comma
(paren
r_int
r_int
)paren
id|f-&gt;header_pool_dma
comma
id|PAGE_SIZE
)paren
suffix:semicolon
id|f-&gt;descriptor_pool_size
op_assign
id|MAX_PACKETS
op_star
r_sizeof
(paren
r_struct
id|DMA_descriptor_block
)paren
suffix:semicolon
multiline_comment|/* make it an even # of pages */
id|f-&gt;descriptor_pool_size
op_add_assign
id|PAGE_SIZE
op_minus
(paren
id|f-&gt;descriptor_pool_size
op_mod
id|PAGE_SIZE
)paren
suffix:semicolon
id|f-&gt;descriptor_pool
op_assign
id|pci_alloc_consistent
c_func
(paren
id|f-&gt;video-&gt;ohci-&gt;dev
comma
id|f-&gt;descriptor_pool_size
comma
op_amp
id|f-&gt;descriptor_pool_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|f-&gt;descriptor_pool
)paren
(brace
id|pci_free_consistent
c_func
(paren
id|f-&gt;video-&gt;ohci-&gt;dev
comma
id|PAGE_SIZE
comma
id|f-&gt;header_pool
comma
id|f-&gt;header_pool_dma
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|f
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|debug_printk
c_func
(paren
l_string|&quot;dv1394: frame_new: allocated DMA program memory at virt 0x%08lx (contig) dma 0x%08lx size %ld&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|f-&gt;descriptor_pool
comma
(paren
r_int
r_int
)paren
id|f-&gt;descriptor_pool_dma
comma
id|f-&gt;descriptor_pool_size
)paren
suffix:semicolon
id|f-&gt;data
op_assign
l_int|0
suffix:semicolon
id|frame_reset
c_func
(paren
id|f
)paren
suffix:semicolon
r_return
id|f
suffix:semicolon
)brace
DECL|function|frame_delete
r_static
r_void
id|frame_delete
c_func
(paren
r_struct
id|frame
op_star
id|f
)paren
(brace
id|pci_free_consistent
c_func
(paren
id|f-&gt;video-&gt;ohci-&gt;dev
comma
id|PAGE_SIZE
comma
id|f-&gt;header_pool
comma
id|f-&gt;header_pool_dma
)paren
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|f-&gt;video-&gt;ohci-&gt;dev
comma
id|f-&gt;descriptor_pool_size
comma
id|f-&gt;descriptor_pool
comma
id|f-&gt;descriptor_pool_dma
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|f
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;   frame_prepare() - build the DMA program for transmitting&n;&n;   Frame_prepare() must be called OUTSIDE the video-&gt;spinlock.&n;   However, frame_prepare() must still be serialized, so&n;   it should be called WITH the video-&gt;sem taken.&n; */
DECL|function|frame_prepare
r_static
r_void
id|frame_prepare
c_func
(paren
r_struct
id|video_card
op_star
id|video
comma
r_int
r_int
id|this_frame
)paren
(brace
r_struct
id|frame
op_star
id|f
op_assign
id|video-&gt;frames
(braket
id|this_frame
)braket
suffix:semicolon
r_int
id|last_frame
suffix:semicolon
r_struct
id|DMA_descriptor_block
op_star
id|block
suffix:semicolon
id|dma_addr_t
id|block_dma
suffix:semicolon
r_struct
id|CIP_header
op_star
id|cip
suffix:semicolon
id|dma_addr_t
id|cip_dma
suffix:semicolon
r_int
r_int
id|n_descriptors
comma
id|full_packets
comma
id|packets_per_frame
comma
id|payload_size
suffix:semicolon
multiline_comment|/* these flags denote packets that need special attention */
r_int
id|empty_packet
comma
id|first_packet
comma
id|last_packet
comma
id|mid_packet
suffix:semicolon
id|u32
op_star
id|branch_address
comma
op_star
id|last_branch_address
op_assign
l_int|NULL
suffix:semicolon
r_int
r_int
id|data_p
suffix:semicolon
r_int
id|first_packet_empty
op_assign
l_int|0
suffix:semicolon
id|u32
id|cycleTimer
comma
id|ct_sec
comma
id|ct_cyc
comma
id|ct_off
suffix:semicolon
r_int
r_int
id|irq_flags
suffix:semicolon
id|irq_printk
c_func
(paren
l_string|&quot;frame_prepare( %d ) ---------------------&bslash;n&quot;
comma
id|this_frame
)paren
suffix:semicolon
id|full_packets
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|video-&gt;pal_or_ntsc
op_eq
id|DV1394_PAL
)paren
id|packets_per_frame
op_assign
id|DV1394_PAL_PACKETS_PER_FRAME
suffix:semicolon
r_else
id|packets_per_frame
op_assign
id|DV1394_NTSC_PACKETS_PER_FRAME
suffix:semicolon
r_while
c_loop
(paren
id|full_packets
OL
id|packets_per_frame
)paren
(brace
id|empty_packet
op_assign
id|first_packet
op_assign
id|last_packet
op_assign
id|mid_packet
op_assign
l_int|0
suffix:semicolon
id|data_p
op_assign
id|f-&gt;data
op_plus
id|full_packets
op_star
l_int|480
suffix:semicolon
multiline_comment|/************************************************/
multiline_comment|/* allocate a descriptor block and a CIP header */
multiline_comment|/************************************************/
multiline_comment|/* note: these should NOT cross a page boundary (DMA restriction) */
r_if
c_cond
(paren
id|f-&gt;n_packets
op_ge
id|MAX_PACKETS
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;dv1394: FATAL ERROR: max packet count exceeded&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* the block surely won&squot;t cross a page boundary,&n;&t;&t;   since an even number of descriptor_blocks fit on a page */
id|block
op_assign
op_amp
(paren
id|f-&gt;descriptor_pool
(braket
id|f-&gt;n_packets
)braket
)paren
suffix:semicolon
multiline_comment|/* DMA address of the block = offset of block relative&n;&t;&t;    to the kernel base address of the descriptor pool&n;&t;&t;    + DMA base address of the descriptor pool */
id|block_dma
op_assign
(paren
(paren
r_int
r_int
)paren
id|block
op_minus
(paren
r_int
r_int
)paren
id|f-&gt;descriptor_pool
)paren
op_plus
id|f-&gt;descriptor_pool_dma
suffix:semicolon
multiline_comment|/* the whole CIP pool fits on one page, so no worries about boundaries */
r_if
c_cond
(paren
(paren
(paren
r_int
r_int
)paren
op_amp
(paren
id|f-&gt;header_pool
(braket
id|f-&gt;n_packets
)braket
)paren
op_minus
(paren
r_int
r_int
)paren
id|f-&gt;header_pool
)paren
OG
id|PAGE_SIZE
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;dv1394: FATAL ERROR: no room to allocate CIP header&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|cip
op_assign
op_amp
(paren
id|f-&gt;header_pool
(braket
id|f-&gt;n_packets
)braket
)paren
suffix:semicolon
multiline_comment|/* DMA address of the CIP header = offset of cip&n;&t;&t;   relative to kernel base address of the header pool&n;&t;&t;   + DMA base address of the header pool */
id|cip_dma
op_assign
(paren
r_int
r_int
)paren
id|cip
op_mod
id|PAGE_SIZE
op_plus
id|f-&gt;header_pool_dma
suffix:semicolon
multiline_comment|/* is this an empty packet? */
r_if
c_cond
(paren
id|video-&gt;cip_accum
OG
(paren
id|video-&gt;cip_d
op_minus
id|video-&gt;cip_n
)paren
)paren
(brace
id|empty_packet
op_assign
l_int|1
suffix:semicolon
id|payload_size
op_assign
l_int|8
suffix:semicolon
id|video-&gt;cip_accum
op_sub_assign
(paren
id|video-&gt;cip_d
op_minus
id|video-&gt;cip_n
)paren
suffix:semicolon
)brace
r_else
(brace
id|payload_size
op_assign
l_int|488
suffix:semicolon
id|video-&gt;cip_accum
op_add_assign
id|video-&gt;cip_n
suffix:semicolon
)brace
multiline_comment|/* there are three important packets each frame:&n;&n;&t;&t;   the first packet in the frame - we ask the card to record the timestamp when&n;&t;&t;                                   this packet is actually sent, so we can monitor&n;&t;&t;&t;&t;&t;&t;   how accurate our timestamps are. Also, the first&n;&t;&t;&t;&t;&t;&t;   packet serves as a semaphore to let us know that&n;&t;&t;&t;&t;&t;&t;   it&squot;s OK to free the *previous* frame&squot;s DMA buffer&n;&n;&t;&t;   the last packet in the frame -  this packet is used to detect buffer underflows.&n;&t;&t;                                   if this is the last ready frame, the last DMA block&n;&t;&t;&t;&t;&t;&t;   will have a branch back to the beginning of the frame&n;&t;&t;&t;&t;&t;&t;   (so that the card will re-send the frame on underflow).&n;&t;&t;&t;&t;&t;&t;   if this branch gets taken, we know that at least one&n;&t;&t;&t;&t;&t;&t;   frame has been dropped. When the next frame is ready,&n;&t;&t;&t;&t;&t;&t;   the branch is pointed to its first packet, and the&n;&t;&t;&t;&t;&t;&t;   semaphore is disabled.&n;&n;&t;&t;   a &quot;mid&quot; packet slightly before the end of the frame - this packet should trigger&n;&t;&t;                   an interrupt so we can go and assign a timestamp to the first packet&n;&t;&t;&t;&t;   in the next frame. We don&squot;t use the very last packet in the frame&n;&t;&t;&t;&t;   for this purpose, because that would leave very little time to set&n;&t;&t;&t;&t;   the timestamp before DMA starts on the next frame.&n;&t;&t;*/
r_if
c_cond
(paren
id|f-&gt;n_packets
op_eq
l_int|0
)paren
(brace
id|first_packet
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|full_packets
op_eq
(paren
id|packets_per_frame
op_minus
l_int|1
)paren
)paren
(brace
id|last_packet
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|f-&gt;n_packets
op_eq
id|packets_per_frame
)paren
(brace
id|mid_packet
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/********************/
multiline_comment|/* setup CIP header */
multiline_comment|/********************/
multiline_comment|/* the timestamp will be written later from the&n;&t;&t;   mid-frame interrupt handler. For now we just&n;&t;&t;   store the address of the CIP header(s) that&n;&t;&t;   need a timestamp. */
multiline_comment|/* first packet in the frame needs a timestamp */
r_if
c_cond
(paren
id|first_packet
)paren
(brace
id|f-&gt;cip_syt1
op_assign
id|cip
suffix:semicolon
r_if
c_cond
(paren
id|empty_packet
)paren
id|first_packet_empty
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|first_packet_empty
op_logical_and
(paren
id|f-&gt;n_packets
op_eq
l_int|1
)paren
)paren
(brace
multiline_comment|/* if the first packet was empty, the second&n;&t;&t;&t;   packet&squot;s CIP header also needs a timestamp */
id|f-&gt;cip_syt2
op_assign
id|cip
suffix:semicolon
)brace
id|fill_cip_header
c_func
(paren
id|cip
comma
multiline_comment|/* the node ID number of the OHCI card */
id|reg_read
c_func
(paren
id|video-&gt;ohci
comma
id|OHCI1394_NodeID
)paren
op_amp
l_int|0x3F
comma
id|video-&gt;continuity_counter
comma
id|video-&gt;pal_or_ntsc
comma
l_int|0xFFFF
multiline_comment|/* the timestamp is filled in later */
)paren
suffix:semicolon
multiline_comment|/* advance counter, only for full packets */
r_if
c_cond
(paren
op_logical_neg
id|empty_packet
)paren
id|video-&gt;continuity_counter
op_increment
suffix:semicolon
multiline_comment|/******************************/
multiline_comment|/* setup DMA descriptor block */
multiline_comment|/******************************/
multiline_comment|/* first descriptor - OUTPUT_MORE_IMMEDIATE, for the controller&squot;s IT header */
id|fill_output_more_immediate
c_func
(paren
op_amp
(paren
id|block-&gt;u.out.omi
)paren
comma
l_int|1
comma
id|video-&gt;channel
comma
l_int|0
comma
id|payload_size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|empty_packet
)paren
(brace
multiline_comment|/* second descriptor - OUTPUT_LAST for CIP header */
id|fill_output_last
c_func
(paren
op_amp
(paren
id|block-&gt;u.out.u.empty.ol
)paren
comma
multiline_comment|/* want completion status on all interesting packets */
(paren
id|first_packet
op_logical_or
id|mid_packet
op_logical_or
id|last_packet
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
comma
multiline_comment|/* want interrupts on all interesting packets */
(paren
id|first_packet
op_logical_or
id|mid_packet
op_logical_or
id|last_packet
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
comma
r_sizeof
(paren
r_struct
id|CIP_header
)paren
comma
multiline_comment|/* data size */
id|cip_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|first_packet
)paren
id|f-&gt;frame_begin_timestamp
op_assign
op_amp
(paren
id|block-&gt;u.out.u.empty.ol.q
(braket
l_int|3
)braket
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|mid_packet
)paren
id|f-&gt;mid_frame_timestamp
op_assign
op_amp
(paren
id|block-&gt;u.out.u.empty.ol.q
(braket
l_int|3
)braket
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|last_packet
)paren
(brace
id|f-&gt;frame_end_timestamp
op_assign
op_amp
(paren
id|block-&gt;u.out.u.empty.ol.q
(braket
l_int|3
)braket
)paren
suffix:semicolon
id|f-&gt;frame_end_branch
op_assign
op_amp
(paren
id|block-&gt;u.out.u.empty.ol.q
(braket
l_int|2
)braket
)paren
suffix:semicolon
)brace
id|branch_address
op_assign
op_amp
(paren
id|block-&gt;u.out.u.empty.ol.q
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|n_descriptors
op_assign
l_int|3
suffix:semicolon
r_if
c_cond
(paren
id|first_packet
)paren
id|f-&gt;first_n_descriptors
op_assign
id|n_descriptors
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* full packet */
multiline_comment|/* second descriptor - OUTPUT_MORE for CIP header */
id|fill_output_more
c_func
(paren
op_amp
(paren
id|block-&gt;u.out.u.full.om
)paren
comma
r_sizeof
(paren
r_struct
id|CIP_header
)paren
comma
multiline_comment|/* data size */
id|cip_dma
)paren
suffix:semicolon
multiline_comment|/* third (and possibly fourth) descriptor - for DV data */
multiline_comment|/* the 480-byte payload can cross a page boundary; if so,&n;&t;&t;&t;   we need to split it into two DMA descriptors */
multiline_comment|/* does the 480-byte data payload cross a page boundary? */
r_if
c_cond
(paren
(paren
id|PAGE_SIZE
op_minus
(paren
(paren
r_int
r_int
)paren
id|data_p
op_mod
id|PAGE_SIZE
)paren
)paren
OL
l_int|480
)paren
(brace
multiline_comment|/* page boundary crossed */
id|fill_output_more
c_func
(paren
op_amp
(paren
id|block-&gt;u.out.u.full.u.cross.om
)paren
comma
multiline_comment|/* data size - how much of data_p fits on the first page */
id|PAGE_SIZE
op_minus
(paren
id|data_p
op_mod
id|PAGE_SIZE
)paren
comma
multiline_comment|/* DMA address of data_p */
id|dma_region_offset_to_bus
c_func
(paren
op_amp
id|video-&gt;dv_buf
comma
id|data_p
op_minus
(paren
r_int
r_int
)paren
id|video-&gt;dv_buf.kvirt
)paren
)paren
suffix:semicolon
id|fill_output_last
c_func
(paren
op_amp
(paren
id|block-&gt;u.out.u.full.u.cross.ol
)paren
comma
multiline_comment|/* want completion status on all interesting packets */
(paren
id|first_packet
op_logical_or
id|mid_packet
op_logical_or
id|last_packet
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
comma
multiline_comment|/* want interrupt on all interesting packets */
(paren
id|first_packet
op_logical_or
id|mid_packet
op_logical_or
id|last_packet
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
comma
multiline_comment|/* data size - remaining portion of data_p */
l_int|480
op_minus
(paren
id|PAGE_SIZE
op_minus
(paren
id|data_p
op_mod
id|PAGE_SIZE
)paren
)paren
comma
multiline_comment|/* DMA address of data_p + PAGE_SIZE - (data_p % PAGE_SIZE) */
id|dma_region_offset_to_bus
c_func
(paren
op_amp
id|video-&gt;dv_buf
comma
id|data_p
op_plus
id|PAGE_SIZE
op_minus
(paren
id|data_p
op_mod
id|PAGE_SIZE
)paren
op_minus
(paren
r_int
r_int
)paren
id|video-&gt;dv_buf.kvirt
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|first_packet
)paren
id|f-&gt;frame_begin_timestamp
op_assign
op_amp
(paren
id|block-&gt;u.out.u.full.u.cross.ol.q
(braket
l_int|3
)braket
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|mid_packet
)paren
id|f-&gt;mid_frame_timestamp
op_assign
op_amp
(paren
id|block-&gt;u.out.u.full.u.cross.ol.q
(braket
l_int|3
)braket
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|last_packet
)paren
(brace
id|f-&gt;frame_end_timestamp
op_assign
op_amp
(paren
id|block-&gt;u.out.u.full.u.cross.ol.q
(braket
l_int|3
)braket
)paren
suffix:semicolon
id|f-&gt;frame_end_branch
op_assign
op_amp
(paren
id|block-&gt;u.out.u.full.u.cross.ol.q
(braket
l_int|2
)braket
)paren
suffix:semicolon
)brace
id|branch_address
op_assign
op_amp
(paren
id|block-&gt;u.out.u.full.u.cross.ol.q
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|n_descriptors
op_assign
l_int|5
suffix:semicolon
r_if
c_cond
(paren
id|first_packet
)paren
id|f-&gt;first_n_descriptors
op_assign
id|n_descriptors
suffix:semicolon
id|full_packets
op_increment
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* fits on one page */
id|fill_output_last
c_func
(paren
op_amp
(paren
id|block-&gt;u.out.u.full.u.nocross.ol
)paren
comma
multiline_comment|/* want completion status on all interesting packets */
(paren
id|first_packet
op_logical_or
id|mid_packet
op_logical_or
id|last_packet
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
comma
multiline_comment|/* want interrupt on all interesting packets */
(paren
id|first_packet
op_logical_or
id|mid_packet
op_logical_or
id|last_packet
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
comma
l_int|480
comma
multiline_comment|/* data size (480 bytes of DV data) */
multiline_comment|/* DMA address of data_p */
id|dma_region_offset_to_bus
c_func
(paren
op_amp
id|video-&gt;dv_buf
comma
id|data_p
op_minus
(paren
r_int
r_int
)paren
id|video-&gt;dv_buf.kvirt
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|first_packet
)paren
id|f-&gt;frame_begin_timestamp
op_assign
op_amp
(paren
id|block-&gt;u.out.u.full.u.nocross.ol.q
(braket
l_int|3
)braket
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|mid_packet
)paren
id|f-&gt;mid_frame_timestamp
op_assign
op_amp
(paren
id|block-&gt;u.out.u.full.u.nocross.ol.q
(braket
l_int|3
)braket
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|last_packet
)paren
(brace
id|f-&gt;frame_end_timestamp
op_assign
op_amp
(paren
id|block-&gt;u.out.u.full.u.nocross.ol.q
(braket
l_int|3
)braket
)paren
suffix:semicolon
id|f-&gt;frame_end_branch
op_assign
op_amp
(paren
id|block-&gt;u.out.u.full.u.nocross.ol.q
(braket
l_int|2
)braket
)paren
suffix:semicolon
)brace
id|branch_address
op_assign
op_amp
(paren
id|block-&gt;u.out.u.full.u.nocross.ol.q
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|n_descriptors
op_assign
l_int|4
suffix:semicolon
r_if
c_cond
(paren
id|first_packet
)paren
id|f-&gt;first_n_descriptors
op_assign
id|n_descriptors
suffix:semicolon
id|full_packets
op_increment
suffix:semicolon
)brace
)brace
multiline_comment|/* link this descriptor block into the DMA program by filling in&n;&t;&t;   the branch address of the previous block */
multiline_comment|/* note: we are not linked into the active DMA chain yet */
r_if
c_cond
(paren
id|last_branch_address
)paren
(brace
op_star
(paren
id|last_branch_address
)paren
op_assign
id|cpu_to_le32
c_func
(paren
id|block_dma
op_or
id|n_descriptors
)paren
suffix:semicolon
)brace
id|last_branch_address
op_assign
id|branch_address
suffix:semicolon
id|f-&gt;n_packets
op_increment
suffix:semicolon
)brace
multiline_comment|/* when we first assemble a new frame, set the final branch&n;&t;   to loop back up to the top */
op_star
(paren
id|f-&gt;frame_end_branch
)paren
op_assign
id|cpu_to_le32
c_func
(paren
id|f-&gt;descriptor_pool_dma
op_or
id|f-&gt;first_n_descriptors
)paren
suffix:semicolon
multiline_comment|/* make the latest version of this frame visible to the PCI card */
id|dma_region_sync_for_device
c_func
(paren
op_amp
id|video-&gt;dv_buf
comma
id|f-&gt;data
op_minus
(paren
r_int
r_int
)paren
id|video-&gt;dv_buf.kvirt
comma
id|video-&gt;frame_size
)paren
suffix:semicolon
multiline_comment|/* lock against DMA interrupt */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|video-&gt;spinlock
comma
id|irq_flags
)paren
suffix:semicolon
id|f-&gt;state
op_assign
id|FRAME_READY
suffix:semicolon
id|video-&gt;n_clear_frames
op_decrement
suffix:semicolon
id|last_frame
op_assign
id|video-&gt;first_clear_frame
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|last_frame
op_eq
op_minus
l_int|1
)paren
id|last_frame
op_assign
id|video-&gt;n_frames
op_minus
l_int|1
suffix:semicolon
id|video-&gt;first_clear_frame
op_assign
(paren
id|video-&gt;first_clear_frame
op_plus
l_int|1
)paren
op_mod
id|video-&gt;n_frames
suffix:semicolon
id|irq_printk
c_func
(paren
l_string|&quot;   frame %d prepared, active_frame = %d, n_clear_frames = %d, first_clear_frame = %d&bslash;n last=%d&bslash;n&quot;
comma
id|this_frame
comma
id|video-&gt;active_frame
comma
id|video-&gt;n_clear_frames
comma
id|video-&gt;first_clear_frame
comma
id|last_frame
)paren
suffix:semicolon
id|irq_printk
c_func
(paren
l_string|&quot;   begin_ts %08lx mid_ts %08lx end_ts %08lx end_br %08lx&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|f-&gt;frame_begin_timestamp
comma
(paren
r_int
r_int
)paren
id|f-&gt;mid_frame_timestamp
comma
(paren
r_int
r_int
)paren
id|f-&gt;frame_end_timestamp
comma
(paren
r_int
r_int
)paren
id|f-&gt;frame_end_branch
)paren
suffix:semicolon
r_if
c_cond
(paren
id|video-&gt;active_frame
op_ne
op_minus
l_int|1
)paren
(brace
multiline_comment|/* if DMA is already active, we are almost done */
multiline_comment|/* just link us onto the active DMA chain */
r_if
c_cond
(paren
id|video-&gt;frames
(braket
id|last_frame
)braket
op_member_access_from_pointer
id|frame_end_branch
)paren
(brace
id|u32
id|temp
suffix:semicolon
multiline_comment|/* point the previous frame&squot;s tail to this frame&squot;s head */
op_star
(paren
id|video-&gt;frames
(braket
id|last_frame
)braket
op_member_access_from_pointer
id|frame_end_branch
)paren
op_assign
id|cpu_to_le32
c_func
(paren
id|f-&gt;descriptor_pool_dma
op_or
id|f-&gt;first_n_descriptors
)paren
suffix:semicolon
multiline_comment|/* this write MUST precede the next one, or we could silently drop frames */
id|wmb
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* disable the want_status semaphore on the last packet */
id|temp
op_assign
id|le32_to_cpu
c_func
(paren
op_star
(paren
id|video-&gt;frames
(braket
id|last_frame
)braket
op_member_access_from_pointer
id|frame_end_branch
op_minus
l_int|2
)paren
)paren
suffix:semicolon
id|temp
op_and_assign
l_int|0xF7CFFFFF
suffix:semicolon
op_star
(paren
id|video-&gt;frames
(braket
id|last_frame
)braket
op_member_access_from_pointer
id|frame_end_branch
op_minus
l_int|2
)paren
op_assign
id|cpu_to_le32
c_func
(paren
id|temp
)paren
suffix:semicolon
multiline_comment|/* flush these writes to memory ASAP */
id|flush_pci_write
c_func
(paren
id|video-&gt;ohci
)paren
suffix:semicolon
multiline_comment|/* NOTE:&n;&t;&t;&t;   ideally the writes should be &quot;atomic&quot;: if&n;&t;&t;&t;   the OHCI card reads the want_status flag in&n;&t;&t;&t;   between them, we&squot;ll falsely report a&n;&t;&t;&t;   dropped frame. Hopefully this window is too&n;&t;&t;&t;   small to really matter, and the consequence&n;&t;&t;&t;   is rather harmless. */
id|irq_printk
c_func
(paren
l_string|&quot;     new frame %d linked onto DMA chain&bslash;n&quot;
comma
id|this_frame
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;dv1394: last frame not ready???&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|u32
id|transmit_sec
comma
id|transmit_cyc
suffix:semicolon
id|u32
id|ts_cyc
comma
id|ts_off
suffix:semicolon
multiline_comment|/* DMA is stopped, so this is the very first frame */
id|video-&gt;active_frame
op_assign
id|this_frame
suffix:semicolon
multiline_comment|/* set CommandPtr to address and size of first descriptor block */
id|reg_write
c_func
(paren
id|video-&gt;ohci
comma
id|video-&gt;ohci_IsoXmitCommandPtr
comma
id|video-&gt;frames
(braket
id|video-&gt;active_frame
)braket
op_member_access_from_pointer
id|descriptor_pool_dma
op_or
id|f-&gt;first_n_descriptors
)paren
suffix:semicolon
multiline_comment|/* assign a timestamp based on the current cycle time...&n;&t;&t;   We&squot;ll tell the card to begin DMA 100 cycles from now,&n;&t;&t;   and assign a timestamp 103 cycles from now */
id|cycleTimer
op_assign
id|reg_read
c_func
(paren
id|video-&gt;ohci
comma
id|OHCI1394_IsochronousCycleTimer
)paren
suffix:semicolon
id|ct_sec
op_assign
id|cycleTimer
op_rshift
l_int|25
suffix:semicolon
id|ct_cyc
op_assign
(paren
id|cycleTimer
op_rshift
l_int|12
)paren
op_amp
l_int|0x1FFF
suffix:semicolon
id|ct_off
op_assign
id|cycleTimer
op_amp
l_int|0xFFF
suffix:semicolon
id|transmit_sec
op_assign
id|ct_sec
suffix:semicolon
id|transmit_cyc
op_assign
id|ct_cyc
op_plus
l_int|100
suffix:semicolon
id|transmit_sec
op_add_assign
id|transmit_cyc
op_div
l_int|8000
suffix:semicolon
id|transmit_cyc
op_mod_assign
l_int|8000
suffix:semicolon
id|ts_off
op_assign
id|ct_off
suffix:semicolon
id|ts_cyc
op_assign
id|transmit_cyc
op_plus
l_int|3
suffix:semicolon
id|ts_cyc
op_mod_assign
l_int|8000
suffix:semicolon
id|f-&gt;assigned_timestamp
op_assign
(paren
id|ts_cyc
op_amp
l_int|0xF
)paren
op_lshift
l_int|12
suffix:semicolon
multiline_comment|/* now actually write the timestamp into the appropriate CIP headers */
r_if
c_cond
(paren
id|f-&gt;cip_syt1
)paren
(brace
id|f-&gt;cip_syt1-&gt;b
(braket
l_int|6
)braket
op_assign
id|f-&gt;assigned_timestamp
op_rshift
l_int|8
suffix:semicolon
id|f-&gt;cip_syt1-&gt;b
(braket
l_int|7
)braket
op_assign
id|f-&gt;assigned_timestamp
op_amp
l_int|0xFF
suffix:semicolon
)brace
r_if
c_cond
(paren
id|f-&gt;cip_syt2
)paren
(brace
id|f-&gt;cip_syt2-&gt;b
(braket
l_int|6
)braket
op_assign
id|f-&gt;assigned_timestamp
op_rshift
l_int|8
suffix:semicolon
id|f-&gt;cip_syt2-&gt;b
(braket
l_int|7
)braket
op_assign
id|f-&gt;assigned_timestamp
op_amp
l_int|0xFF
suffix:semicolon
)brace
multiline_comment|/* --- start DMA --- */
multiline_comment|/* clear all bits in ContextControl register */
id|reg_write
c_func
(paren
id|video-&gt;ohci
comma
id|video-&gt;ohci_IsoXmitContextControlClear
comma
l_int|0xFFFFFFFF
)paren
suffix:semicolon
id|wmb
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* the OHCI card has the ability to start ISO transmission on a&n;&t;&t;   particular cycle (start-on-cycle). This way we can ensure that&n;&t;&t;   the first DV frame will have an accurate timestamp.&n;&n;&t;&t;   However, start-on-cycle only appears to work if the OHCI card&n;&t;&t;   is cycle master! Since the consequences of messing up the first&n;&t;&t;   timestamp are minimal*, just disable start-on-cycle for now.&n;&n;&t;&t;   * my DV deck drops the first few frames before it &quot;locks in;&quot;&n;&t;&t;     so the first frame having an incorrect timestamp is inconsequential.&n;&t;&t;*/
macro_line|#if 0
id|reg_write
c_func
(paren
id|video-&gt;ohci
comma
id|video-&gt;ohci_IsoXmitContextControlSet
comma
(paren
l_int|1
op_lshift
l_int|31
)paren
multiline_comment|/* enable start-on-cycle */
op_or
(paren
(paren
id|transmit_sec
op_amp
l_int|0x3
)paren
op_lshift
l_int|29
)paren
op_or
(paren
id|transmit_cyc
op_lshift
l_int|16
)paren
)paren
suffix:semicolon
id|wmb
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
id|video-&gt;dma_running
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* set the &squot;run&squot; bit */
id|reg_write
c_func
(paren
id|video-&gt;ohci
comma
id|video-&gt;ohci_IsoXmitContextControlSet
comma
l_int|0x8000
)paren
suffix:semicolon
id|flush_pci_write
c_func
(paren
id|video-&gt;ohci
)paren
suffix:semicolon
multiline_comment|/* --- DMA should be running now --- */
id|debug_printk
c_func
(paren
l_string|&quot;    Cycle = %4u ContextControl = %08x CmdPtr = %08x&bslash;n&quot;
comma
(paren
id|reg_read
c_func
(paren
id|video-&gt;ohci
comma
id|OHCI1394_IsochronousCycleTimer
)paren
op_rshift
l_int|12
)paren
op_amp
l_int|0x1FFF
comma
id|reg_read
c_func
(paren
id|video-&gt;ohci
comma
id|video-&gt;ohci_IsoXmitContextControlSet
)paren
comma
id|reg_read
c_func
(paren
id|video-&gt;ohci
comma
id|video-&gt;ohci_IsoXmitCommandPtr
)paren
)paren
suffix:semicolon
id|debug_printk
c_func
(paren
l_string|&quot;    DMA start - current cycle %4u, transmit cycle %4u (%2u), assigning ts cycle %2u&bslash;n&quot;
comma
id|ct_cyc
comma
id|transmit_cyc
comma
id|transmit_cyc
op_amp
l_int|0xF
comma
id|ts_cyc
op_amp
l_int|0xF
)paren
suffix:semicolon
macro_line|#if DV1394_DEBUG_LEVEL &gt;= 2
(brace
multiline_comment|/* check if DMA is really running */
r_int
id|i
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|i
OL
l_int|20
)paren
(brace
id|mb
c_func
(paren
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|reg_read
c_func
(paren
id|video-&gt;ohci
comma
id|video-&gt;ohci_IsoXmitContextControlSet
)paren
op_amp
(paren
l_int|1
op_lshift
l_int|10
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DMA ACTIVE after %d msec&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|i
op_increment
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;set = %08x, cmdPtr = %08x&bslash;n&quot;
comma
id|reg_read
c_func
(paren
id|video-&gt;ohci
comma
id|video-&gt;ohci_IsoXmitContextControlSet
)paren
comma
id|reg_read
c_func
(paren
id|video-&gt;ohci
comma
id|video-&gt;ohci_IsoXmitCommandPtr
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|reg_read
c_func
(paren
id|video-&gt;ohci
comma
id|video-&gt;ohci_IsoXmitContextControlSet
)paren
op_amp
(paren
l_int|1
op_lshift
l_int|10
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DMA did NOT go active after 20ms, event = %x&bslash;n&quot;
comma
id|reg_read
c_func
(paren
id|video-&gt;ohci
comma
id|video-&gt;ohci_IsoXmitContextControlSet
)paren
op_amp
l_int|0x1F
)paren
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;DMA is RUNNING!&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|video-&gt;spinlock
comma
id|irq_flags
)paren
suffix:semicolon
)brace
multiline_comment|/*** RECEIVE FUNCTIONS *****************************************************/
multiline_comment|/*&n;&t;frame method put_packet&n;&n;&t;map and copy the packet data to its location in the frame&n;&t;based upon DIF section and sequence&n;*/
r_static
r_void
r_inline
DECL|function|frame_put_packet
id|frame_put_packet
(paren
r_struct
id|frame
op_star
id|f
comma
r_struct
id|packet
op_star
id|p
)paren
(brace
r_int
id|section_type
op_assign
id|p-&gt;data
(braket
l_int|0
)braket
op_rshift
l_int|5
suffix:semicolon
multiline_comment|/* section type is in bits 5 - 7 */
r_int
id|dif_sequence
op_assign
id|p-&gt;data
(braket
l_int|1
)braket
op_rshift
l_int|4
suffix:semicolon
multiline_comment|/* dif sequence number is in bits 4 - 7 */
r_int
id|dif_block
op_assign
id|p-&gt;data
(braket
l_int|2
)braket
suffix:semicolon
multiline_comment|/* sanity check */
r_if
c_cond
(paren
id|dif_sequence
OG
l_int|11
op_logical_or
id|dif_block
OG
l_int|149
)paren
r_return
suffix:semicolon
r_switch
c_cond
(paren
id|section_type
)paren
(brace
r_case
l_int|0
suffix:colon
multiline_comment|/* 1 Header block */
id|memcpy
c_func
(paren
(paren
r_void
op_star
)paren
id|f-&gt;data
op_plus
id|dif_sequence
op_star
l_int|150
op_star
l_int|80
comma
id|p-&gt;data
comma
l_int|480
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
multiline_comment|/* 2 Subcode blocks */
id|memcpy
c_func
(paren
(paren
r_void
op_star
)paren
id|f-&gt;data
op_plus
id|dif_sequence
op_star
l_int|150
op_star
l_int|80
op_plus
(paren
l_int|1
op_plus
id|dif_block
)paren
op_star
l_int|80
comma
id|p-&gt;data
comma
l_int|480
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
multiline_comment|/* 3 VAUX blocks */
id|memcpy
c_func
(paren
(paren
r_void
op_star
)paren
id|f-&gt;data
op_plus
id|dif_sequence
op_star
l_int|150
op_star
l_int|80
op_plus
(paren
l_int|3
op_plus
id|dif_block
)paren
op_star
l_int|80
comma
id|p-&gt;data
comma
l_int|480
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
multiline_comment|/* 9 Audio blocks interleaved with video */
id|memcpy
c_func
(paren
(paren
r_void
op_star
)paren
id|f-&gt;data
op_plus
id|dif_sequence
op_star
l_int|150
op_star
l_int|80
op_plus
(paren
l_int|6
op_plus
id|dif_block
op_star
l_int|16
)paren
op_star
l_int|80
comma
id|p-&gt;data
comma
l_int|480
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
multiline_comment|/* 135 Video blocks interleaved with audio */
id|memcpy
c_func
(paren
(paren
r_void
op_star
)paren
id|f-&gt;data
op_plus
id|dif_sequence
op_star
l_int|150
op_star
l_int|80
op_plus
(paren
l_int|7
op_plus
(paren
id|dif_block
op_div
l_int|15
)paren
op_plus
id|dif_block
)paren
op_star
l_int|80
comma
id|p-&gt;data
comma
l_int|480
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* we can not handle any other data */
r_break
suffix:semicolon
)brace
)brace
DECL|function|start_dma_receive
r_static
r_void
id|start_dma_receive
c_func
(paren
r_struct
id|video_card
op_star
id|video
)paren
(brace
r_if
c_cond
(paren
id|video-&gt;first_run
op_eq
l_int|1
)paren
(brace
id|video-&gt;first_run
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* start DMA once all of the frames are READY */
id|video-&gt;n_clear_frames
op_assign
l_int|0
suffix:semicolon
id|video-&gt;first_clear_frame
op_assign
op_minus
l_int|1
suffix:semicolon
id|video-&gt;current_packet
op_assign
l_int|0
suffix:semicolon
id|video-&gt;active_frame
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* reset iso recv control register */
id|reg_write
c_func
(paren
id|video-&gt;ohci
comma
id|video-&gt;ohci_IsoRcvContextControlClear
comma
l_int|0xFFFFFFFF
)paren
suffix:semicolon
id|wmb
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* clear bufferFill, set isochHeader and speed (0=100) */
id|reg_write
c_func
(paren
id|video-&gt;ohci
comma
id|video-&gt;ohci_IsoRcvContextControlSet
comma
l_int|0x40000000
)paren
suffix:semicolon
multiline_comment|/* match on all tags, listen on channel */
id|reg_write
c_func
(paren
id|video-&gt;ohci
comma
id|video-&gt;ohci_IsoRcvContextMatch
comma
l_int|0xf0000000
op_or
id|video-&gt;channel
)paren
suffix:semicolon
multiline_comment|/* address and first descriptor block + Z=1 */
id|reg_write
c_func
(paren
id|video-&gt;ohci
comma
id|video-&gt;ohci_IsoRcvCommandPtr
comma
id|video-&gt;frames
(braket
l_int|0
)braket
op_member_access_from_pointer
id|descriptor_pool_dma
op_or
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Z=1 */
id|wmb
c_func
(paren
)paren
suffix:semicolon
id|video-&gt;dma_running
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* run */
id|reg_write
c_func
(paren
id|video-&gt;ohci
comma
id|video-&gt;ohci_IsoRcvContextControlSet
comma
l_int|0x8000
)paren
suffix:semicolon
id|flush_pci_write
c_func
(paren
id|video-&gt;ohci
)paren
suffix:semicolon
id|debug_printk
c_func
(paren
l_string|&quot;dv1394: DMA started&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#if DV1394_DEBUG_LEVEL &gt;= 2
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|1000
suffix:semicolon
op_increment
id|i
)paren
(brace
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|reg_read
c_func
(paren
id|video-&gt;ohci
comma
id|video-&gt;ohci_IsoRcvContextControlSet
)paren
op_amp
(paren
l_int|1
op_lshift
l_int|10
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DMA ACTIVE after %d msec&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|reg_read
c_func
(paren
id|video-&gt;ohci
comma
id|video-&gt;ohci_IsoRcvContextControlSet
)paren
op_amp
(paren
l_int|1
op_lshift
l_int|11
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;DEAD, event = %x&bslash;n&quot;
comma
id|reg_read
c_func
(paren
id|video-&gt;ohci
comma
id|video-&gt;ohci_IsoRcvContextControlSet
)paren
op_amp
l_int|0x1F
)paren
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;RUNNING!&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
)brace
r_else
r_if
c_cond
(paren
id|reg_read
c_func
(paren
id|video-&gt;ohci
comma
id|video-&gt;ohci_IsoRcvContextControlSet
)paren
op_amp
(paren
l_int|1
op_lshift
l_int|11
)paren
)paren
(brace
id|debug_printk
c_func
(paren
l_string|&quot;DEAD, event = %x&bslash;n&quot;
comma
id|reg_read
c_func
(paren
id|video-&gt;ohci
comma
id|video-&gt;ohci_IsoRcvContextControlSet
)paren
op_amp
l_int|0x1F
)paren
suffix:semicolon
multiline_comment|/* wake */
id|reg_write
c_func
(paren
id|video-&gt;ohci
comma
id|video-&gt;ohci_IsoRcvContextControlSet
comma
(paren
l_int|1
op_lshift
l_int|12
)paren
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;   receive_packets() - build the DMA program for receiving&n;*/
DECL|function|receive_packets
r_static
r_void
id|receive_packets
c_func
(paren
r_struct
id|video_card
op_star
id|video
)paren
(brace
r_struct
id|DMA_descriptor_block
op_star
id|block
op_assign
l_int|NULL
suffix:semicolon
id|dma_addr_t
id|block_dma
op_assign
l_int|0
suffix:semicolon
r_struct
id|packet
op_star
id|data
op_assign
l_int|NULL
suffix:semicolon
id|dma_addr_t
id|data_dma
op_assign
l_int|0
suffix:semicolon
id|u32
op_star
id|last_branch_address
op_assign
l_int|NULL
suffix:semicolon
r_int
r_int
id|irq_flags
suffix:semicolon
r_int
id|want_interrupt
op_assign
l_int|0
suffix:semicolon
r_struct
id|frame
op_star
id|f
op_assign
l_int|NULL
suffix:semicolon
r_int
id|i
comma
id|j
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|video-&gt;spinlock
comma
id|irq_flags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|video-&gt;n_frames
suffix:semicolon
id|j
op_increment
)paren
(brace
multiline_comment|/* connect frames */
r_if
c_cond
(paren
id|j
OG
l_int|0
op_logical_and
id|f
op_ne
l_int|NULL
op_logical_and
id|f-&gt;frame_end_branch
op_ne
l_int|NULL
)paren
op_star
(paren
id|f-&gt;frame_end_branch
)paren
op_assign
id|cpu_to_le32
c_func
(paren
id|video-&gt;frames
(braket
id|j
)braket
op_member_access_from_pointer
id|descriptor_pool_dma
op_or
l_int|1
)paren
suffix:semicolon
multiline_comment|/* set Z=1 */
id|f
op_assign
id|video-&gt;frames
(braket
id|j
)braket
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_PACKETS
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* locate a descriptor block and packet from the buffer */
id|block
op_assign
op_amp
(paren
id|f-&gt;descriptor_pool
(braket
id|i
)braket
)paren
suffix:semicolon
id|block_dma
op_assign
(paren
(paren
r_int
r_int
)paren
id|block
op_minus
(paren
r_int
r_int
)paren
id|f-&gt;descriptor_pool
)paren
op_plus
id|f-&gt;descriptor_pool_dma
suffix:semicolon
id|data
op_assign
(paren
(paren
r_struct
id|packet
op_star
)paren
id|video-&gt;packet_buf.kvirt
)paren
op_plus
id|f-&gt;frame_num
op_star
id|MAX_PACKETS
op_plus
id|i
suffix:semicolon
id|data_dma
op_assign
id|dma_region_offset_to_bus
c_func
(paren
op_amp
id|video-&gt;packet_buf
comma
(paren
(paren
r_int
r_int
)paren
id|data
op_minus
(paren
r_int
r_int
)paren
id|video-&gt;packet_buf.kvirt
)paren
)paren
suffix:semicolon
multiline_comment|/* setup DMA descriptor block */
id|want_interrupt
op_assign
(paren
(paren
id|i
op_mod
(paren
id|MAX_PACKETS
op_div
l_int|2
)paren
)paren
op_eq
l_int|0
op_logical_or
id|i
op_eq
(paren
id|MAX_PACKETS
op_minus
l_int|1
)paren
)paren
suffix:semicolon
id|fill_input_last
c_func
(paren
op_amp
(paren
id|block-&gt;u.in.il
)paren
comma
id|want_interrupt
comma
l_int|512
comma
id|data_dma
)paren
suffix:semicolon
multiline_comment|/* link descriptors */
id|last_branch_address
op_assign
id|f-&gt;frame_end_branch
suffix:semicolon
r_if
c_cond
(paren
id|last_branch_address
op_ne
l_int|NULL
)paren
op_star
(paren
id|last_branch_address
)paren
op_assign
id|cpu_to_le32
c_func
(paren
id|block_dma
op_or
l_int|1
)paren
suffix:semicolon
multiline_comment|/* set Z=1 */
id|f-&gt;frame_end_branch
op_assign
op_amp
(paren
id|block-&gt;u.in.il.q
(braket
l_int|2
)braket
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* next j */
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|video-&gt;spinlock
comma
id|irq_flags
)paren
suffix:semicolon
)brace
multiline_comment|/*** MANAGEMENT FUNCTIONS **************************************************/
DECL|function|do_dv1394_init
r_static
r_int
id|do_dv1394_init
c_func
(paren
r_struct
id|video_card
op_star
id|video
comma
r_struct
id|dv1394_init
op_star
id|init
)paren
(brace
r_int
r_int
id|flags
comma
id|new_buf_size
suffix:semicolon
r_int
id|i
suffix:semicolon
id|u64
id|chan_mask
suffix:semicolon
r_int
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
id|debug_printk
c_func
(paren
l_string|&quot;dv1394: initialising %d&bslash;n&quot;
comma
id|video-&gt;id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|init-&gt;api_version
op_ne
id|DV1394_API_VERSION
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* first sanitize all the parameters */
r_if
c_cond
(paren
(paren
id|init-&gt;n_frames
OL
l_int|2
)paren
op_logical_or
(paren
id|init-&gt;n_frames
OG
id|DV1394_MAX_FRAMES
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
(paren
id|init-&gt;format
op_ne
id|DV1394_NTSC
)paren
op_logical_and
(paren
id|init-&gt;format
op_ne
id|DV1394_PAL
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
(paren
id|init-&gt;syt_offset
op_eq
l_int|0
)paren
op_logical_or
(paren
id|init-&gt;syt_offset
OG
l_int|50
)paren
)paren
multiline_comment|/* default SYT offset is 3 cycles */
id|init-&gt;syt_offset
op_assign
l_int|3
suffix:semicolon
r_if
c_cond
(paren
(paren
id|init-&gt;channel
OG
l_int|63
)paren
op_logical_or
(paren
id|init-&gt;channel
OL
l_int|0
)paren
)paren
id|init-&gt;channel
op_assign
l_int|63
suffix:semicolon
id|chan_mask
op_assign
(paren
id|u64
)paren
l_int|1
op_lshift
id|init-&gt;channel
suffix:semicolon
multiline_comment|/* calculate what size DMA buffer is needed */
r_if
c_cond
(paren
id|init-&gt;format
op_eq
id|DV1394_NTSC
)paren
id|new_buf_size
op_assign
id|DV1394_NTSC_FRAME_SIZE
op_star
id|init-&gt;n_frames
suffix:semicolon
r_else
id|new_buf_size
op_assign
id|DV1394_PAL_FRAME_SIZE
op_star
id|init-&gt;n_frames
suffix:semicolon
multiline_comment|/* round up to PAGE_SIZE */
r_if
c_cond
(paren
id|new_buf_size
op_mod
id|PAGE_SIZE
)paren
id|new_buf_size
op_add_assign
id|PAGE_SIZE
op_minus
(paren
id|new_buf_size
op_mod
id|PAGE_SIZE
)paren
suffix:semicolon
multiline_comment|/* don&squot;t allow the user to allocate the DMA buffer more than once */
r_if
c_cond
(paren
id|video-&gt;dv_buf.kvirt
op_logical_and
id|video-&gt;dv_buf_size
op_ne
id|new_buf_size
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;dv1394: re-sizing the DMA buffer is not allowed&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* shutdown the card if it&squot;s currently active */
multiline_comment|/* (the card should not be reset if the parameters are screwy) */
id|do_dv1394_shutdown
c_func
(paren
id|video
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* try to claim the ISO channel */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|video-&gt;ohci-&gt;IR_channel_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|video-&gt;ohci-&gt;ISO_channel_usage
op_amp
id|chan_mask
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|video-&gt;ohci-&gt;IR_channel_lock
comma
id|flags
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_goto
id|err
suffix:semicolon
)brace
id|video-&gt;ohci-&gt;ISO_channel_usage
op_or_assign
id|chan_mask
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|video-&gt;ohci-&gt;IR_channel_lock
comma
id|flags
)paren
suffix:semicolon
id|video-&gt;channel
op_assign
id|init-&gt;channel
suffix:semicolon
multiline_comment|/* initialize misc. fields of video */
id|video-&gt;n_frames
op_assign
id|init-&gt;n_frames
suffix:semicolon
id|video-&gt;pal_or_ntsc
op_assign
id|init-&gt;format
suffix:semicolon
id|video-&gt;cip_accum
op_assign
l_int|0
suffix:semicolon
id|video-&gt;continuity_counter
op_assign
l_int|0
suffix:semicolon
id|video-&gt;active_frame
op_assign
op_minus
l_int|1
suffix:semicolon
id|video-&gt;first_clear_frame
op_assign
l_int|0
suffix:semicolon
id|video-&gt;n_clear_frames
op_assign
id|video-&gt;n_frames
suffix:semicolon
id|video-&gt;dropped_frames
op_assign
l_int|0
suffix:semicolon
id|video-&gt;write_off
op_assign
l_int|0
suffix:semicolon
id|video-&gt;first_run
op_assign
l_int|1
suffix:semicolon
id|video-&gt;current_packet
op_assign
op_minus
l_int|1
suffix:semicolon
id|video-&gt;first_frame
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|video-&gt;pal_or_ntsc
op_eq
id|DV1394_NTSC
)paren
(brace
id|video-&gt;cip_n
op_assign
id|init-&gt;cip_n
op_ne
l_int|0
ques
c_cond
id|init-&gt;cip_n
suffix:colon
id|CIP_N_NTSC
suffix:semicolon
id|video-&gt;cip_d
op_assign
id|init-&gt;cip_d
op_ne
l_int|0
ques
c_cond
id|init-&gt;cip_d
suffix:colon
id|CIP_D_NTSC
suffix:semicolon
id|video-&gt;frame_size
op_assign
id|DV1394_NTSC_FRAME_SIZE
suffix:semicolon
)brace
r_else
(brace
id|video-&gt;cip_n
op_assign
id|init-&gt;cip_n
op_ne
l_int|0
ques
c_cond
id|init-&gt;cip_n
suffix:colon
id|CIP_N_PAL
suffix:semicolon
id|video-&gt;cip_d
op_assign
id|init-&gt;cip_d
op_ne
l_int|0
ques
c_cond
id|init-&gt;cip_d
suffix:colon
id|CIP_D_PAL
suffix:semicolon
id|video-&gt;frame_size
op_assign
id|DV1394_PAL_FRAME_SIZE
suffix:semicolon
)brace
id|video-&gt;syt_offset
op_assign
id|init-&gt;syt_offset
suffix:semicolon
multiline_comment|/* find and claim DMA contexts on the OHCI card */
r_if
c_cond
(paren
id|video-&gt;ohci_it_ctx
op_eq
op_minus
l_int|1
)paren
(brace
id|ohci1394_init_iso_tasklet
c_func
(paren
op_amp
id|video-&gt;it_tasklet
comma
id|OHCI_ISO_TRANSMIT
comma
id|it_tasklet_func
comma
(paren
r_int
r_int
)paren
id|video
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ohci1394_register_iso_tasklet
c_func
(paren
id|video-&gt;ohci
comma
op_amp
id|video-&gt;it_tasklet
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;dv1394: could not find an available IT DMA context&bslash;n&quot;
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_goto
id|err
suffix:semicolon
)brace
id|video-&gt;ohci_it_ctx
op_assign
id|video-&gt;it_tasklet.context
suffix:semicolon
id|debug_printk
c_func
(paren
l_string|&quot;dv1394: claimed IT DMA context %d&bslash;n&quot;
comma
id|video-&gt;ohci_it_ctx
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|video-&gt;ohci_ir_ctx
op_eq
op_minus
l_int|1
)paren
(brace
id|ohci1394_init_iso_tasklet
c_func
(paren
op_amp
id|video-&gt;ir_tasklet
comma
id|OHCI_ISO_RECEIVE
comma
id|ir_tasklet_func
comma
(paren
r_int
r_int
)paren
id|video
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ohci1394_register_iso_tasklet
c_func
(paren
id|video-&gt;ohci
comma
op_amp
id|video-&gt;ir_tasklet
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;dv1394: could not find an available IR DMA context&bslash;n&quot;
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_goto
id|err
suffix:semicolon
)brace
id|video-&gt;ohci_ir_ctx
op_assign
id|video-&gt;ir_tasklet.context
suffix:semicolon
id|debug_printk
c_func
(paren
l_string|&quot;dv1394: claimed IR DMA context %d&bslash;n&quot;
comma
id|video-&gt;ohci_ir_ctx
)paren
suffix:semicolon
)brace
multiline_comment|/* allocate struct frames */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|init-&gt;n_frames
suffix:semicolon
id|i
op_increment
)paren
(brace
id|video-&gt;frames
(braket
id|i
)braket
op_assign
id|frame_new
c_func
(paren
id|i
comma
id|video
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|video-&gt;frames
(braket
id|i
)braket
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;dv1394: Cannot allocate frame structs&bslash;n&quot;
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|err
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|video-&gt;dv_buf.kvirt
)paren
(brace
multiline_comment|/* allocate the ringbuffer */
id|retval
op_assign
id|dma_region_alloc
c_func
(paren
op_amp
id|video-&gt;dv_buf
comma
id|new_buf_size
comma
id|video-&gt;ohci-&gt;dev
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
r_goto
id|err
suffix:semicolon
id|video-&gt;dv_buf_size
op_assign
id|new_buf_size
suffix:semicolon
id|debug_printk
c_func
(paren
l_string|&quot;dv1394: Allocated %d frame buffers, total %u pages (%u DMA pages), %lu bytes&bslash;n&quot;
comma
id|video-&gt;n_frames
comma
id|video-&gt;dv_buf.n_pages
comma
id|video-&gt;dv_buf.n_dma_pages
comma
id|video-&gt;dv_buf_size
)paren
suffix:semicolon
)brace
multiline_comment|/* set up the frame-&gt;data pointers */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|video-&gt;n_frames
suffix:semicolon
id|i
op_increment
)paren
id|video-&gt;frames
(braket
id|i
)braket
op_member_access_from_pointer
id|data
op_assign
(paren
r_int
r_int
)paren
id|video-&gt;dv_buf.kvirt
op_plus
id|i
op_star
id|video-&gt;frame_size
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|video-&gt;packet_buf.kvirt
)paren
(brace
multiline_comment|/* allocate packet buffer */
id|video-&gt;packet_buf_size
op_assign
r_sizeof
(paren
r_struct
id|packet
)paren
op_star
id|video-&gt;n_frames
op_star
id|MAX_PACKETS
suffix:semicolon
r_if
c_cond
(paren
id|video-&gt;packet_buf_size
op_mod
id|PAGE_SIZE
)paren
id|video-&gt;packet_buf_size
op_add_assign
id|PAGE_SIZE
op_minus
(paren
id|video-&gt;packet_buf_size
op_mod
id|PAGE_SIZE
)paren
suffix:semicolon
id|retval
op_assign
id|dma_region_alloc
c_func
(paren
op_amp
id|video-&gt;packet_buf
comma
id|video-&gt;packet_buf_size
comma
id|video-&gt;ohci-&gt;dev
comma
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
r_goto
id|err
suffix:semicolon
id|debug_printk
c_func
(paren
l_string|&quot;dv1394: Allocated %d packets in buffer, total %u pages (%u DMA pages), %lu bytes&bslash;n&quot;
comma
id|video-&gt;n_frames
op_star
id|MAX_PACKETS
comma
id|video-&gt;packet_buf.n_pages
comma
id|video-&gt;packet_buf.n_dma_pages
comma
id|video-&gt;packet_buf_size
)paren
suffix:semicolon
)brace
multiline_comment|/* set up register offsets for IT context */
multiline_comment|/* IT DMA context registers are spaced 16 bytes apart */
id|video-&gt;ohci_IsoXmitContextControlSet
op_assign
id|OHCI1394_IsoXmitContextControlSet
op_plus
l_int|16
op_star
id|video-&gt;ohci_it_ctx
suffix:semicolon
id|video-&gt;ohci_IsoXmitContextControlClear
op_assign
id|OHCI1394_IsoXmitContextControlClear
op_plus
l_int|16
op_star
id|video-&gt;ohci_it_ctx
suffix:semicolon
id|video-&gt;ohci_IsoXmitCommandPtr
op_assign
id|OHCI1394_IsoXmitCommandPtr
op_plus
l_int|16
op_star
id|video-&gt;ohci_it_ctx
suffix:semicolon
multiline_comment|/* enable interrupts for IT context */
id|reg_write
c_func
(paren
id|video-&gt;ohci
comma
id|OHCI1394_IsoXmitIntMaskSet
comma
(paren
l_int|1
op_lshift
id|video-&gt;ohci_it_ctx
)paren
)paren
suffix:semicolon
id|debug_printk
c_func
(paren
l_string|&quot;dv1394: interrupts enabled for IT context %d&bslash;n&quot;
comma
id|video-&gt;ohci_it_ctx
)paren
suffix:semicolon
multiline_comment|/* set up register offsets for IR context */
multiline_comment|/* IR DMA context registers are spaced 32 bytes apart */
id|video-&gt;ohci_IsoRcvContextControlSet
op_assign
id|OHCI1394_IsoRcvContextControlSet
op_plus
l_int|32
op_star
id|video-&gt;ohci_ir_ctx
suffix:semicolon
id|video-&gt;ohci_IsoRcvContextControlClear
op_assign
id|OHCI1394_IsoRcvContextControlClear
op_plus
l_int|32
op_star
id|video-&gt;ohci_ir_ctx
suffix:semicolon
id|video-&gt;ohci_IsoRcvCommandPtr
op_assign
id|OHCI1394_IsoRcvCommandPtr
op_plus
l_int|32
op_star
id|video-&gt;ohci_ir_ctx
suffix:semicolon
id|video-&gt;ohci_IsoRcvContextMatch
op_assign
id|OHCI1394_IsoRcvContextMatch
op_plus
l_int|32
op_star
id|video-&gt;ohci_ir_ctx
suffix:semicolon
multiline_comment|/* enable interrupts for IR context */
id|reg_write
c_func
(paren
id|video-&gt;ohci
comma
id|OHCI1394_IsoRecvIntMaskSet
comma
(paren
l_int|1
op_lshift
id|video-&gt;ohci_ir_ctx
)paren
)paren
suffix:semicolon
id|debug_printk
c_func
(paren
l_string|&quot;dv1394: interrupts enabled for IR context %d&bslash;n&quot;
comma
id|video-&gt;ohci_ir_ctx
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|err
suffix:colon
id|do_dv1394_shutdown
c_func
(paren
id|video
comma
l_int|1
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* if the user doesn&squot;t bother to call ioctl(INIT) before starting&n;   mmap() or read()/write(), just give him some default values */
DECL|function|do_dv1394_init_default
r_static
r_int
id|do_dv1394_init_default
c_func
(paren
r_struct
id|video_card
op_star
id|video
)paren
(brace
r_struct
id|dv1394_init
id|init
suffix:semicolon
id|init.api_version
op_assign
id|DV1394_API_VERSION
suffix:semicolon
id|init.n_frames
op_assign
id|DV1394_MAX_FRAMES
op_div
l_int|4
suffix:semicolon
multiline_comment|/* the following are now set via devfs */
id|init.channel
op_assign
id|video-&gt;channel
suffix:semicolon
id|init.format
op_assign
id|video-&gt;pal_or_ntsc
suffix:semicolon
id|init.cip_n
op_assign
id|video-&gt;cip_n
suffix:semicolon
id|init.cip_d
op_assign
id|video-&gt;cip_d
suffix:semicolon
id|init.syt_offset
op_assign
id|video-&gt;syt_offset
suffix:semicolon
r_return
id|do_dv1394_init
c_func
(paren
id|video
comma
op_amp
id|init
)paren
suffix:semicolon
)brace
multiline_comment|/* do NOT call from interrupt context */
DECL|function|stop_dma
r_static
r_void
id|stop_dma
c_func
(paren
r_struct
id|video_card
op_star
id|video
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* no interrupts */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|video-&gt;spinlock
comma
id|flags
)paren
suffix:semicolon
id|video-&gt;dma_running
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|video-&gt;ohci_it_ctx
op_eq
op_minus
l_int|1
)paren
op_logical_and
(paren
id|video-&gt;ohci_ir_ctx
op_eq
op_minus
l_int|1
)paren
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* stop DMA if in progress */
r_if
c_cond
(paren
(paren
id|video-&gt;active_frame
op_ne
op_minus
l_int|1
)paren
op_logical_or
(paren
id|reg_read
c_func
(paren
id|video-&gt;ohci
comma
id|video-&gt;ohci_IsoXmitContextControlClear
)paren
op_amp
(paren
l_int|1
op_lshift
l_int|10
)paren
)paren
op_logical_or
(paren
id|reg_read
c_func
(paren
id|video-&gt;ohci
comma
id|video-&gt;ohci_IsoRcvContextControlClear
)paren
op_amp
(paren
l_int|1
op_lshift
l_int|10
)paren
)paren
)paren
(brace
multiline_comment|/* clear the .run bits */
id|reg_write
c_func
(paren
id|video-&gt;ohci
comma
id|video-&gt;ohci_IsoXmitContextControlClear
comma
(paren
l_int|1
op_lshift
l_int|15
)paren
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|video-&gt;ohci
comma
id|video-&gt;ohci_IsoRcvContextControlClear
comma
(paren
l_int|1
op_lshift
l_int|15
)paren
)paren
suffix:semicolon
id|flush_pci_write
c_func
(paren
id|video-&gt;ohci
)paren
suffix:semicolon
id|video-&gt;active_frame
op_assign
op_minus
l_int|1
suffix:semicolon
id|video-&gt;first_run
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* wait until DMA really stops */
id|i
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|i
OL
l_int|1000
)paren
(brace
multiline_comment|/* wait 0.1 millisecond */
id|udelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|reg_read
c_func
(paren
id|video-&gt;ohci
comma
id|video-&gt;ohci_IsoXmitContextControlClear
)paren
op_amp
(paren
l_int|1
op_lshift
l_int|10
)paren
)paren
op_logical_or
(paren
id|reg_read
c_func
(paren
id|video-&gt;ohci
comma
id|video-&gt;ohci_IsoRcvContextControlClear
)paren
op_amp
(paren
l_int|1
op_lshift
l_int|10
)paren
)paren
)paren
(brace
multiline_comment|/* still active */
id|debug_printk
c_func
(paren
l_string|&quot;dv1394: stop_dma: DMA not stopped yet&bslash;n&quot;
)paren
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|debug_printk
c_func
(paren
l_string|&quot;dv1394: stop_dma: DMA stopped safely after %d ms&bslash;n&quot;
comma
id|i
op_div
l_int|10
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|i
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_eq
l_int|1000
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;dv1394: stop_dma: DMA still going after %d ms!&bslash;n&quot;
comma
id|i
op_div
l_int|10
)paren
suffix:semicolon
)brace
)brace
r_else
id|debug_printk
c_func
(paren
l_string|&quot;dv1394: stop_dma: already stopped.&bslash;n&quot;
)paren
suffix:semicolon
id|out
suffix:colon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|video-&gt;spinlock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|do_dv1394_shutdown
r_static
r_void
id|do_dv1394_shutdown
c_func
(paren
r_struct
id|video_card
op_star
id|video
comma
r_int
id|free_dv_buf
)paren
(brace
r_int
id|i
suffix:semicolon
id|debug_printk
c_func
(paren
l_string|&quot;dv1394: shutdown...&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* stop DMA if in progress */
id|stop_dma
c_func
(paren
id|video
)paren
suffix:semicolon
multiline_comment|/* release the DMA contexts */
r_if
c_cond
(paren
id|video-&gt;ohci_it_ctx
op_ne
op_minus
l_int|1
)paren
(brace
id|video-&gt;ohci_IsoXmitContextControlSet
op_assign
l_int|0
suffix:semicolon
id|video-&gt;ohci_IsoXmitContextControlClear
op_assign
l_int|0
suffix:semicolon
id|video-&gt;ohci_IsoXmitCommandPtr
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* disable interrupts for IT context */
id|reg_write
c_func
(paren
id|video-&gt;ohci
comma
id|OHCI1394_IsoXmitIntMaskClear
comma
(paren
l_int|1
op_lshift
id|video-&gt;ohci_it_ctx
)paren
)paren
suffix:semicolon
multiline_comment|/* remove tasklet */
id|ohci1394_unregister_iso_tasklet
c_func
(paren
id|video-&gt;ohci
comma
op_amp
id|video-&gt;it_tasklet
)paren
suffix:semicolon
id|debug_printk
c_func
(paren
l_string|&quot;dv1394: IT context %d released&bslash;n&quot;
comma
id|video-&gt;ohci_it_ctx
)paren
suffix:semicolon
id|video-&gt;ohci_it_ctx
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|video-&gt;ohci_ir_ctx
op_ne
op_minus
l_int|1
)paren
(brace
id|video-&gt;ohci_IsoRcvContextControlSet
op_assign
l_int|0
suffix:semicolon
id|video-&gt;ohci_IsoRcvContextControlClear
op_assign
l_int|0
suffix:semicolon
id|video-&gt;ohci_IsoRcvCommandPtr
op_assign
l_int|0
suffix:semicolon
id|video-&gt;ohci_IsoRcvContextMatch
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* disable interrupts for IR context */
id|reg_write
c_func
(paren
id|video-&gt;ohci
comma
id|OHCI1394_IsoRecvIntMaskClear
comma
(paren
l_int|1
op_lshift
id|video-&gt;ohci_ir_ctx
)paren
)paren
suffix:semicolon
multiline_comment|/* remove tasklet */
id|ohci1394_unregister_iso_tasklet
c_func
(paren
id|video-&gt;ohci
comma
op_amp
id|video-&gt;ir_tasklet
)paren
suffix:semicolon
id|debug_printk
c_func
(paren
l_string|&quot;dv1394: IR context %d released&bslash;n&quot;
comma
id|video-&gt;ohci_ir_ctx
)paren
suffix:semicolon
id|video-&gt;ohci_ir_ctx
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* release the ISO channel */
r_if
c_cond
(paren
id|video-&gt;channel
op_ne
op_minus
l_int|1
)paren
(brace
id|u64
id|chan_mask
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|chan_mask
op_assign
(paren
id|u64
)paren
l_int|1
op_lshift
id|video-&gt;channel
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|video-&gt;ohci-&gt;IR_channel_lock
comma
id|flags
)paren
suffix:semicolon
id|video-&gt;ohci-&gt;ISO_channel_usage
op_and_assign
op_complement
(paren
id|chan_mask
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|video-&gt;ohci-&gt;IR_channel_lock
comma
id|flags
)paren
suffix:semicolon
id|video-&gt;channel
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* free the frame structs */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|DV1394_MAX_FRAMES
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|video-&gt;frames
(braket
id|i
)braket
)paren
id|frame_delete
c_func
(paren
id|video-&gt;frames
(braket
id|i
)braket
)paren
suffix:semicolon
id|video-&gt;frames
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
id|video-&gt;n_frames
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* we can&squot;t free the DMA buffer unless it is guaranteed that&n;&t;   no more user-space mappings exist */
r_if
c_cond
(paren
id|free_dv_buf
)paren
(brace
id|dma_region_free
c_func
(paren
op_amp
id|video-&gt;dv_buf
)paren
suffix:semicolon
id|video-&gt;dv_buf_size
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* free packet buffer */
id|dma_region_free
c_func
(paren
op_amp
id|video-&gt;packet_buf
)paren
suffix:semicolon
id|video-&gt;packet_buf_size
op_assign
l_int|0
suffix:semicolon
id|debug_printk
c_func
(paren
l_string|&quot;dv1394: shutdown OK&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;       **********************************&n;       *** MMAP() THEORY OF OPERATION ***&n;       **********************************&n;&n;        The ringbuffer cannot be re-allocated or freed while&n;        a user program maintains a mapping of it. (note that a mapping&n;&t;can persist even after the device fd is closed!)&n;&n;&t;So, only let the user process allocate the DMA buffer once.&n;&t;To resize or deallocate it, you must close the device file&n;&t;and open it again.&n;&n;&t;Previously Dan M. hacked out a scheme that allowed the DMA&n;&t;buffer to change by forcefully unmapping it from the user&squot;s&n;&t;address space. It was prone to error because it&squot;s very hard to&n;&t;track all the places the buffer could have been mapped (we&n;&t;would have had to walk the vma list of every process in the&n;&t;system to be sure we found all the mappings!). Instead, we&n;&t;force the user to choose one buffer size and stick with&n;&t;it. This small sacrifice is worth the huge reduction in&n;&t;error-prone code in dv1394.&n;*/
DECL|function|dv1394_mmap
r_int
id|dv1394_mmap
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_struct
id|vm_area_struct
op_star
id|vma
)paren
(brace
r_struct
id|video_card
op_star
id|video
op_assign
id|file_to_video_card
c_func
(paren
id|file
)paren
suffix:semicolon
r_int
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* serialize mmap */
id|down
c_func
(paren
op_amp
id|video-&gt;sem
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|video_card_initialized
c_func
(paren
id|video
)paren
)paren
(brace
id|retval
op_assign
id|do_dv1394_init_default
c_func
(paren
id|video
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
r_goto
id|out
suffix:semicolon
)brace
id|retval
op_assign
id|dma_region_mmap
c_func
(paren
op_amp
id|video-&gt;dv_buf
comma
id|file
comma
id|vma
)paren
suffix:semicolon
id|out
suffix:colon
id|up
c_func
(paren
op_amp
id|video-&gt;sem
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*** DEVICE FILE INTERFACE *************************************************/
multiline_comment|/* no need to serialize, multiple threads OK */
DECL|function|dv1394_poll
r_static
r_int
r_int
id|dv1394_poll
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_struct
id|poll_table_struct
op_star
id|wait
)paren
(brace
r_struct
id|video_card
op_star
id|video
op_assign
id|file_to_video_card
c_func
(paren
id|file
)paren
suffix:semicolon
r_int
r_int
id|mask
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|poll_wait
c_func
(paren
id|file
comma
op_amp
id|video-&gt;waitq
comma
id|wait
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|video-&gt;spinlock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|video-&gt;n_frames
op_eq
l_int|0
)paren
(brace
)brace
r_else
r_if
c_cond
(paren
id|video-&gt;active_frame
op_eq
op_minus
l_int|1
)paren
(brace
multiline_comment|/* nothing going on */
id|mask
op_or_assign
id|POLLOUT
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* any clear/ready buffers? */
r_if
c_cond
(paren
id|video-&gt;n_clear_frames
OG
l_int|0
)paren
id|mask
op_or_assign
id|POLLOUT
op_or
id|POLLIN
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|video-&gt;spinlock
comma
id|flags
)paren
suffix:semicolon
r_return
id|mask
suffix:semicolon
)brace
DECL|function|dv1394_fasync
r_static
r_int
id|dv1394_fasync
c_func
(paren
r_int
id|fd
comma
r_struct
id|file
op_star
id|file
comma
r_int
id|on
)paren
(brace
multiline_comment|/* I just copied this code verbatim from Alan Cox&squot;s mouse driver example&n;&t;   (Documentation/DocBook/) */
r_struct
id|video_card
op_star
id|video
op_assign
id|file_to_video_card
c_func
(paren
id|file
)paren
suffix:semicolon
r_int
id|retval
op_assign
id|fasync_helper
c_func
(paren
id|fd
comma
id|file
comma
id|on
comma
op_amp
id|video-&gt;fasync
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
OL
l_int|0
)paren
r_return
id|retval
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dv1394_write
r_static
id|ssize_t
id|dv1394_write
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
id|__user
op_star
id|buffer
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_struct
id|video_card
op_star
id|video
op_assign
id|file_to_video_card
c_func
(paren
id|file
)paren
suffix:semicolon
id|DECLARE_WAITQUEUE
c_func
(paren
id|wait
comma
id|current
)paren
suffix:semicolon
id|ssize_t
id|ret
suffix:semicolon
r_int
id|cnt
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|target_frame
suffix:semicolon
multiline_comment|/* serialize this to prevent multi-threaded mayhem */
r_if
c_cond
(paren
id|file-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
(brace
r_if
c_cond
(paren
id|down_trylock
c_func
(paren
op_amp
id|video-&gt;sem
)paren
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|down_interruptible
c_func
(paren
op_amp
id|video-&gt;sem
)paren
)paren
r_return
op_minus
id|ERESTARTSYS
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|video_card_initialized
c_func
(paren
id|video
)paren
)paren
(brace
id|ret
op_assign
id|do_dv1394_init_default
c_func
(paren
id|video
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|up
c_func
(paren
op_amp
id|video-&gt;sem
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
)brace
id|ret
op_assign
l_int|0
suffix:semicolon
id|add_wait_queue
c_func
(paren
op_amp
id|video-&gt;waitq
comma
op_amp
id|wait
)paren
suffix:semicolon
r_while
c_loop
(paren
id|count
OG
l_int|0
)paren
(brace
multiline_comment|/* must set TASK_INTERRUPTIBLE *before* checking for free&n;&t;&t;   buffers; otherwise we could miss a wakeup if the interrupt&n;&t;&t;   fires between the check and the schedule() */
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|video-&gt;spinlock
comma
id|flags
)paren
suffix:semicolon
id|target_frame
op_assign
id|video-&gt;first_clear_frame
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|video-&gt;spinlock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|video-&gt;frames
(braket
id|target_frame
)braket
op_member_access_from_pointer
id|state
op_eq
id|FRAME_CLEAR
)paren
(brace
multiline_comment|/* how much room is left in the target frame buffer */
id|cnt
op_assign
id|video-&gt;frame_size
op_minus
(paren
id|video-&gt;write_off
op_minus
id|target_frame
op_star
id|video-&gt;frame_size
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* buffer is already used */
id|cnt
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cnt
OG
id|count
)paren
id|cnt
op_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
id|cnt
op_le
l_int|0
)paren
(brace
multiline_comment|/* no room left, gotta wait */
r_if
c_cond
(paren
id|file-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
id|ret
op_assign
op_minus
id|EAGAIN
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
id|ret
op_assign
op_minus
id|ERESTARTSYS
suffix:semicolon
r_break
suffix:semicolon
)brace
id|schedule
c_func
(paren
)paren
suffix:semicolon
r_continue
suffix:semicolon
multiline_comment|/* start over from &squot;while(count &gt; 0)...&squot; */
)brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|video-&gt;dv_buf.kvirt
op_plus
id|video-&gt;write_off
comma
id|buffer
comma
id|cnt
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
)brace
id|video-&gt;write_off
op_assign
(paren
id|video-&gt;write_off
op_plus
id|cnt
)paren
op_mod
(paren
id|video-&gt;n_frames
op_star
id|video-&gt;frame_size
)paren
suffix:semicolon
id|count
op_sub_assign
id|cnt
suffix:semicolon
id|buffer
op_add_assign
id|cnt
suffix:semicolon
id|ret
op_add_assign
id|cnt
suffix:semicolon
r_if
c_cond
(paren
id|video-&gt;write_off
op_eq
id|video-&gt;frame_size
op_star
(paren
(paren
id|target_frame
op_plus
l_int|1
)paren
op_mod
id|video-&gt;n_frames
)paren
)paren
id|frame_prepare
c_func
(paren
id|video
comma
id|target_frame
)paren
suffix:semicolon
)brace
id|remove_wait_queue
c_func
(paren
op_amp
id|video-&gt;waitq
comma
op_amp
id|wait
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_RUNNING
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|video-&gt;sem
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|dv1394_read
r_static
id|ssize_t
id|dv1394_read
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_char
id|__user
op_star
id|buffer
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_struct
id|video_card
op_star
id|video
op_assign
id|file_to_video_card
c_func
(paren
id|file
)paren
suffix:semicolon
id|DECLARE_WAITQUEUE
c_func
(paren
id|wait
comma
id|current
)paren
suffix:semicolon
id|ssize_t
id|ret
suffix:semicolon
r_int
id|cnt
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|target_frame
suffix:semicolon
multiline_comment|/* serialize this to prevent multi-threaded mayhem */
r_if
c_cond
(paren
id|file-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
(brace
r_if
c_cond
(paren
id|down_trylock
c_func
(paren
op_amp
id|video-&gt;sem
)paren
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|down_interruptible
c_func
(paren
op_amp
id|video-&gt;sem
)paren
)paren
r_return
op_minus
id|ERESTARTSYS
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|video_card_initialized
c_func
(paren
id|video
)paren
)paren
(brace
id|ret
op_assign
id|do_dv1394_init_default
c_func
(paren
id|video
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|up
c_func
(paren
op_amp
id|video-&gt;sem
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
id|video-&gt;continuity_counter
op_assign
op_minus
l_int|1
suffix:semicolon
id|receive_packets
c_func
(paren
id|video
)paren
suffix:semicolon
id|start_dma_receive
c_func
(paren
id|video
)paren
suffix:semicolon
)brace
id|ret
op_assign
l_int|0
suffix:semicolon
id|add_wait_queue
c_func
(paren
op_amp
id|video-&gt;waitq
comma
op_amp
id|wait
)paren
suffix:semicolon
r_while
c_loop
(paren
id|count
OG
l_int|0
)paren
(brace
multiline_comment|/* must set TASK_INTERRUPTIBLE *before* checking for free&n;&t;&t;   buffers; otherwise we could miss a wakeup if the interrupt&n;&t;&t;   fires between the check and the schedule() */
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|video-&gt;spinlock
comma
id|flags
)paren
suffix:semicolon
id|target_frame
op_assign
id|video-&gt;first_clear_frame
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|video-&gt;spinlock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|target_frame
op_ge
l_int|0
op_logical_and
id|video-&gt;n_clear_frames
OG
l_int|0
op_logical_and
id|video-&gt;frames
(braket
id|target_frame
)braket
op_member_access_from_pointer
id|state
op_eq
id|FRAME_CLEAR
)paren
(brace
multiline_comment|/* how much room is left in the target frame buffer */
id|cnt
op_assign
id|video-&gt;frame_size
op_minus
(paren
id|video-&gt;write_off
op_minus
id|target_frame
op_star
id|video-&gt;frame_size
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* buffer is already used */
id|cnt
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cnt
OG
id|count
)paren
id|cnt
op_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
id|cnt
op_le
l_int|0
)paren
(brace
multiline_comment|/* no room left, gotta wait */
r_if
c_cond
(paren
id|file-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
id|ret
op_assign
op_minus
id|EAGAIN
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
id|ret
op_assign
op_minus
id|ERESTARTSYS
suffix:semicolon
r_break
suffix:semicolon
)brace
id|schedule
c_func
(paren
)paren
suffix:semicolon
r_continue
suffix:semicolon
multiline_comment|/* start over from &squot;while(count &gt; 0)...&squot; */
)brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|buffer
comma
id|video-&gt;dv_buf.kvirt
op_plus
id|video-&gt;write_off
comma
id|cnt
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
)brace
id|video-&gt;write_off
op_assign
(paren
id|video-&gt;write_off
op_plus
id|cnt
)paren
op_mod
(paren
id|video-&gt;n_frames
op_star
id|video-&gt;frame_size
)paren
suffix:semicolon
id|count
op_sub_assign
id|cnt
suffix:semicolon
id|buffer
op_add_assign
id|cnt
suffix:semicolon
id|ret
op_add_assign
id|cnt
suffix:semicolon
r_if
c_cond
(paren
id|video-&gt;write_off
op_eq
id|video-&gt;frame_size
op_star
(paren
(paren
id|target_frame
op_plus
l_int|1
)paren
op_mod
id|video-&gt;n_frames
)paren
)paren
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|video-&gt;spinlock
comma
id|flags
)paren
suffix:semicolon
id|video-&gt;n_clear_frames
op_decrement
suffix:semicolon
id|video-&gt;first_clear_frame
op_assign
(paren
id|video-&gt;first_clear_frame
op_plus
l_int|1
)paren
op_mod
id|video-&gt;n_frames
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|video-&gt;spinlock
comma
id|flags
)paren
suffix:semicolon
)brace
)brace
id|remove_wait_queue
c_func
(paren
op_amp
id|video-&gt;waitq
comma
op_amp
id|wait
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_RUNNING
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|video-&gt;sem
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*** DEVICE IOCTL INTERFACE ************************************************/
DECL|function|dv1394_ioctl
r_static
r_int
id|dv1394_ioctl
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_struct
id|video_card
op_star
id|video
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_void
id|__user
op_star
id|argp
op_assign
(paren
r_void
id|__user
op_star
)paren
id|arg
suffix:semicolon
id|DECLARE_WAITQUEUE
c_func
(paren
id|wait
comma
id|current
)paren
suffix:semicolon
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
id|video
op_assign
id|file_to_video_card
c_func
(paren
id|file
)paren
suffix:semicolon
multiline_comment|/* serialize this to prevent multi-threaded mayhem */
r_if
c_cond
(paren
id|file-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
(brace
r_if
c_cond
(paren
id|down_trylock
c_func
(paren
op_amp
id|video-&gt;sem
)paren
)paren
(brace
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|down_interruptible
c_func
(paren
op_amp
id|video-&gt;sem
)paren
)paren
(brace
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
r_return
op_minus
id|ERESTARTSYS
suffix:semicolon
)brace
)brace
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|DV1394_IOC_SUBMIT_FRAMES
suffix:colon
(brace
r_int
r_int
id|n_submit
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|video_card_initialized
c_func
(paren
id|video
)paren
)paren
(brace
id|ret
op_assign
id|do_dv1394_init_default
c_func
(paren
id|video
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_goto
id|out
suffix:semicolon
)brace
id|n_submit
op_assign
(paren
r_int
r_int
)paren
id|arg
suffix:semicolon
r_if
c_cond
(paren
id|n_submit
OG
id|video-&gt;n_frames
)paren
(brace
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_while
c_loop
(paren
id|n_submit
OG
l_int|0
)paren
(brace
id|add_wait_queue
c_func
(paren
op_amp
id|video-&gt;waitq
comma
op_amp
id|wait
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|video-&gt;spinlock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* wait until video-&gt;first_clear_frame is really CLEAR */
r_while
c_loop
(paren
id|video-&gt;frames
(braket
id|video-&gt;first_clear_frame
)braket
op_member_access_from_pointer
id|state
op_ne
id|FRAME_CLEAR
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|video-&gt;spinlock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
id|remove_wait_queue
c_func
(paren
op_amp
id|video-&gt;waitq
comma
op_amp
id|wait
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_RUNNING
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|EINTR
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|schedule
c_func
(paren
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|video-&gt;spinlock
comma
id|flags
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|video-&gt;spinlock
comma
id|flags
)paren
suffix:semicolon
id|remove_wait_queue
c_func
(paren
op_amp
id|video-&gt;waitq
comma
op_amp
id|wait
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_RUNNING
)paren
suffix:semicolon
id|frame_prepare
c_func
(paren
id|video
comma
id|video-&gt;first_clear_frame
)paren
suffix:semicolon
id|n_submit
op_decrement
suffix:semicolon
)brace
id|ret
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
id|DV1394_IOC_WAIT_FRAMES
suffix:colon
(brace
r_int
r_int
id|n_wait
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|video_card_initialized
c_func
(paren
id|video
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|n_wait
op_assign
(paren
r_int
r_int
)paren
id|arg
suffix:semicolon
multiline_comment|/* since we re-run the last frame on underflow, we will&n;&t;&t;   never actually have n_frames clear frames; at most only&n;&t;&t;   n_frames - 1 */
r_if
c_cond
(paren
id|n_wait
OG
(paren
id|video-&gt;n_frames
op_minus
l_int|1
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|add_wait_queue
c_func
(paren
op_amp
id|video-&gt;waitq
comma
op_amp
id|wait
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|video-&gt;spinlock
comma
id|flags
)paren
suffix:semicolon
r_while
c_loop
(paren
id|video-&gt;n_clear_frames
OL
id|n_wait
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|video-&gt;spinlock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
id|remove_wait_queue
c_func
(paren
op_amp
id|video-&gt;waitq
comma
op_amp
id|wait
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_RUNNING
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|EINTR
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|schedule
c_func
(paren
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|video-&gt;spinlock
comma
id|flags
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|video-&gt;spinlock
comma
id|flags
)paren
suffix:semicolon
id|remove_wait_queue
c_func
(paren
op_amp
id|video-&gt;waitq
comma
op_amp
id|wait
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_RUNNING
)paren
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
id|DV1394_IOC_RECEIVE_FRAMES
suffix:colon
(brace
r_int
r_int
id|n_recv
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|video_card_initialized
c_func
(paren
id|video
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|n_recv
op_assign
(paren
r_int
r_int
)paren
id|arg
suffix:semicolon
multiline_comment|/* at least one frame must be active */
r_if
c_cond
(paren
id|n_recv
OG
(paren
id|video-&gt;n_frames
op_minus
l_int|1
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|video-&gt;spinlock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* release the clear frames */
id|video-&gt;n_clear_frames
op_sub_assign
id|n_recv
suffix:semicolon
multiline_comment|/* advance the clear frame cursor */
id|video-&gt;first_clear_frame
op_assign
(paren
id|video-&gt;first_clear_frame
op_plus
id|n_recv
)paren
op_mod
id|video-&gt;n_frames
suffix:semicolon
multiline_comment|/* reset dropped_frames */
id|video-&gt;dropped_frames
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|video-&gt;spinlock
comma
id|flags
)paren
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
id|DV1394_IOC_START_RECEIVE
suffix:colon
(brace
r_if
c_cond
(paren
op_logical_neg
id|video_card_initialized
c_func
(paren
id|video
)paren
)paren
(brace
id|ret
op_assign
id|do_dv1394_init_default
c_func
(paren
id|video
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_goto
id|out
suffix:semicolon
)brace
id|video-&gt;continuity_counter
op_assign
op_minus
l_int|1
suffix:semicolon
id|receive_packets
c_func
(paren
id|video
)paren
suffix:semicolon
id|start_dma_receive
c_func
(paren
id|video
)paren
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
id|DV1394_IOC_INIT
suffix:colon
(brace
r_struct
id|dv1394_init
id|init
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|argp
)paren
(brace
id|ret
op_assign
id|do_dv1394_init_default
c_func
(paren
id|video
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|init
comma
id|argp
comma
r_sizeof
(paren
id|init
)paren
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|ret
op_assign
id|do_dv1394_init
c_func
(paren
id|video
comma
op_amp
id|init
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_case
id|DV1394_IOC_SHUTDOWN
suffix:colon
id|do_dv1394_shutdown
c_func
(paren
id|video
comma
l_int|0
)paren
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DV1394_IOC_GET_STATUS
suffix:colon
(brace
r_struct
id|dv1394_status
id|status
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|video_card_initialized
c_func
(paren
id|video
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|status.init.api_version
op_assign
id|DV1394_API_VERSION
suffix:semicolon
id|status.init.channel
op_assign
id|video-&gt;channel
suffix:semicolon
id|status.init.n_frames
op_assign
id|video-&gt;n_frames
suffix:semicolon
id|status.init.format
op_assign
id|video-&gt;pal_or_ntsc
suffix:semicolon
id|status.init.cip_n
op_assign
id|video-&gt;cip_n
suffix:semicolon
id|status.init.cip_d
op_assign
id|video-&gt;cip_d
suffix:semicolon
id|status.init.syt_offset
op_assign
id|video-&gt;syt_offset
suffix:semicolon
id|status.first_clear_frame
op_assign
id|video-&gt;first_clear_frame
suffix:semicolon
multiline_comment|/* the rest of the fields need to be locked against the interrupt */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|video-&gt;spinlock
comma
id|flags
)paren
suffix:semicolon
id|status.active_frame
op_assign
id|video-&gt;active_frame
suffix:semicolon
id|status.n_clear_frames
op_assign
id|video-&gt;n_clear_frames
suffix:semicolon
id|status.dropped_frames
op_assign
id|video-&gt;dropped_frames
suffix:semicolon
multiline_comment|/* reset dropped_frames */
id|video-&gt;dropped_frames
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|video-&gt;spinlock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|argp
comma
op_amp
id|status
comma
r_sizeof
(paren
id|status
)paren
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|ret
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
r_default
suffix:colon
r_break
suffix:semicolon
)brace
id|out
suffix:colon
id|up
c_func
(paren
op_amp
id|video-&gt;sem
)paren
suffix:semicolon
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*** DEVICE FILE INTERFACE CONTINUED ***************************************/
DECL|function|dv1394_open
r_static
r_int
id|dv1394_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|video_card
op_star
id|video
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* if the device was opened through devfs, then file-&gt;private_data&n;&t;   has already been set to video by devfs */
r_if
c_cond
(paren
id|file-&gt;private_data
)paren
(brace
id|video
op_assign
(paren
r_struct
id|video_card
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* look up the card by ID */
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|dv1394_cards_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|dv1394_cards
)paren
)paren
(brace
r_struct
id|video_card
op_star
id|p
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|p
comma
op_amp
id|dv1394_cards
comma
id|list
)paren
(brace
r_if
c_cond
(paren
(paren
id|p-&gt;id
)paren
op_eq
id|ieee1394_file_to_instance
c_func
(paren
id|file
)paren
)paren
(brace
id|video
op_assign
id|p
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|dv1394_cards_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|video
)paren
(brace
id|debug_printk
c_func
(paren
l_string|&quot;dv1394: OHCI card %d not found&quot;
comma
id|ieee1394_file_to_instance
c_func
(paren
id|file
)paren
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|file-&gt;private_data
op_assign
(paren
r_void
op_star
)paren
id|video
suffix:semicolon
)brace
macro_line|#ifndef DV1394_ALLOW_MORE_THAN_ONE_OPEN
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
l_int|0
comma
op_amp
id|video-&gt;open
)paren
)paren
(brace
multiline_comment|/* video is already open by someone else */
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dv1394_release
r_static
r_int
id|dv1394_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|video_card
op_star
id|video
op_assign
id|file_to_video_card
c_func
(paren
id|file
)paren
suffix:semicolon
multiline_comment|/* OK to free the DMA buffer, no more mappings can exist */
id|do_dv1394_shutdown
c_func
(paren
id|video
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* clean up async I/O users */
id|dv1394_fasync
c_func
(paren
op_minus
l_int|1
comma
id|file
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* give someone else a turn */
id|clear_bit
c_func
(paren
l_int|0
comma
op_amp
id|video-&gt;open
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*** DEVICE DRIVER HANDLERS ************************************************/
DECL|function|it_tasklet_func
r_static
r_void
id|it_tasklet_func
c_func
(paren
r_int
r_int
id|data
)paren
(brace
r_int
id|wake
op_assign
l_int|0
suffix:semicolon
r_struct
id|video_card
op_star
id|video
op_assign
(paren
r_struct
id|video_card
op_star
)paren
id|data
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|video-&gt;spinlock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|video-&gt;dma_running
)paren
r_goto
id|out
suffix:semicolon
id|irq_printk
c_func
(paren
l_string|&quot;ContextControl = %08x, CommandPtr = %08x&bslash;n&quot;
comma
id|reg_read
c_func
(paren
id|video-&gt;ohci
comma
id|video-&gt;ohci_IsoXmitContextControlSet
)paren
comma
id|reg_read
c_func
(paren
id|video-&gt;ohci
comma
id|video-&gt;ohci_IsoXmitCommandPtr
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|video-&gt;ohci_it_ctx
op_ne
op_minus
l_int|1
)paren
op_logical_and
(paren
id|reg_read
c_func
(paren
id|video-&gt;ohci
comma
id|video-&gt;ohci_IsoXmitContextControlSet
)paren
op_amp
(paren
l_int|1
op_lshift
l_int|10
)paren
)paren
)paren
(brace
r_struct
id|frame
op_star
id|f
suffix:semicolon
r_int
r_int
id|frame
comma
id|i
suffix:semicolon
r_if
c_cond
(paren
id|video-&gt;active_frame
op_eq
op_minus
l_int|1
)paren
id|frame
op_assign
l_int|0
suffix:semicolon
r_else
id|frame
op_assign
id|video-&gt;active_frame
suffix:semicolon
multiline_comment|/* check all the DMA-able frames */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|video-&gt;n_frames
suffix:semicolon
id|i
op_increment
comma
id|frame
op_assign
(paren
id|frame
op_plus
l_int|1
)paren
op_mod
id|video-&gt;n_frames
)paren
(brace
id|irq_printk
c_func
(paren
l_string|&quot;IRQ checking frame %d...&quot;
comma
id|frame
)paren
suffix:semicolon
id|f
op_assign
id|video-&gt;frames
(braket
id|frame
)braket
suffix:semicolon
r_if
c_cond
(paren
id|f-&gt;state
op_ne
id|FRAME_READY
)paren
(brace
id|irq_printk
c_func
(paren
l_string|&quot;clear, skipping&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* we don&squot;t own this frame */
r_continue
suffix:semicolon
)brace
id|irq_printk
c_func
(paren
l_string|&quot;DMA&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* check the frame begin semaphore to see if we can free the previous frame */
r_if
c_cond
(paren
op_star
(paren
id|f-&gt;frame_begin_timestamp
)paren
)paren
(brace
r_int
id|prev_frame
suffix:semicolon
r_struct
id|frame
op_star
id|prev_f
suffix:semicolon
multiline_comment|/* don&squot;t reset, need this later *(f-&gt;frame_begin_timestamp) = 0; */
id|irq_printk
c_func
(paren
l_string|&quot;  BEGIN&bslash;n&quot;
)paren
suffix:semicolon
id|prev_frame
op_assign
id|frame
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|prev_frame
op_eq
op_minus
l_int|1
)paren
id|prev_frame
op_add_assign
id|video-&gt;n_frames
suffix:semicolon
id|prev_f
op_assign
id|video-&gt;frames
(braket
id|prev_frame
)braket
suffix:semicolon
multiline_comment|/* make sure we can actually garbage collect&n;&t;&t;&t;&t;   this frame */
r_if
c_cond
(paren
(paren
id|prev_f-&gt;state
op_eq
id|FRAME_READY
)paren
op_logical_and
id|prev_f-&gt;done
op_logical_and
(paren
op_logical_neg
id|f-&gt;done
)paren
)paren
(brace
id|frame_reset
c_func
(paren
id|prev_f
)paren
suffix:semicolon
id|video-&gt;n_clear_frames
op_increment
suffix:semicolon
id|wake
op_assign
l_int|1
suffix:semicolon
id|video-&gt;active_frame
op_assign
id|frame
suffix:semicolon
id|irq_printk
c_func
(paren
l_string|&quot;  BEGIN - freeing previous frame %d, new active frame is %d&bslash;n&quot;
comma
id|prev_frame
comma
id|frame
)paren
suffix:semicolon
)brace
r_else
(brace
id|irq_printk
c_func
(paren
l_string|&quot;  BEGIN - can&squot;t free yet&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|f-&gt;done
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* see if we need to set the timestamp for the next frame */
r_if
c_cond
(paren
op_star
(paren
id|f-&gt;mid_frame_timestamp
)paren
)paren
(brace
r_struct
id|frame
op_star
id|next_frame
suffix:semicolon
id|u32
id|begin_ts
comma
id|ts_cyc
comma
id|ts_off
suffix:semicolon
op_star
(paren
id|f-&gt;mid_frame_timestamp
)paren
op_assign
l_int|0
suffix:semicolon
id|begin_ts
op_assign
id|le32_to_cpu
c_func
(paren
op_star
(paren
id|f-&gt;frame_begin_timestamp
)paren
)paren
suffix:semicolon
id|irq_printk
c_func
(paren
l_string|&quot;  MIDDLE - first packet was sent at cycle %4u (%2u), assigned timestamp was (%2u) %4u&bslash;n&quot;
comma
id|begin_ts
op_amp
l_int|0x1FFF
comma
id|begin_ts
op_amp
l_int|0xF
comma
id|f-&gt;assigned_timestamp
op_rshift
l_int|12
comma
id|f-&gt;assigned_timestamp
op_amp
l_int|0xFFF
)paren
suffix:semicolon
multiline_comment|/* prepare next frame and assign timestamp */
id|next_frame
op_assign
id|video-&gt;frames
(braket
(paren
id|frame
op_plus
l_int|1
)paren
op_mod
id|video-&gt;n_frames
)braket
suffix:semicolon
r_if
c_cond
(paren
id|next_frame-&gt;state
op_eq
id|FRAME_READY
)paren
(brace
id|irq_printk
c_func
(paren
l_string|&quot;  MIDDLE - next frame is ready, good&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|debug_printk
c_func
(paren
l_string|&quot;dv1394: Underflow! At least one frame has been dropped.&bslash;n&quot;
)paren
suffix:semicolon
id|next_frame
op_assign
id|f
suffix:semicolon
)brace
multiline_comment|/* set the timestamp to the timestamp of the last frame sent,&n;&t;&t;&t;&t;   plus the length of the last frame sent, plus the syt latency */
id|ts_cyc
op_assign
id|begin_ts
op_amp
l_int|0xF
suffix:semicolon
multiline_comment|/* advance one frame, plus syt latency (typically 2-3) */
id|ts_cyc
op_add_assign
id|f-&gt;n_packets
op_plus
id|video-&gt;syt_offset
suffix:semicolon
id|ts_off
op_assign
l_int|0
suffix:semicolon
id|ts_cyc
op_add_assign
id|ts_off
op_div
l_int|3072
suffix:semicolon
id|ts_off
op_mod_assign
l_int|3072
suffix:semicolon
id|next_frame-&gt;assigned_timestamp
op_assign
(paren
(paren
id|ts_cyc
op_amp
l_int|0xF
)paren
op_lshift
l_int|12
)paren
op_plus
id|ts_off
suffix:semicolon
r_if
c_cond
(paren
id|next_frame-&gt;cip_syt1
)paren
(brace
id|next_frame-&gt;cip_syt1-&gt;b
(braket
l_int|6
)braket
op_assign
id|next_frame-&gt;assigned_timestamp
op_rshift
l_int|8
suffix:semicolon
id|next_frame-&gt;cip_syt1-&gt;b
(braket
l_int|7
)braket
op_assign
id|next_frame-&gt;assigned_timestamp
op_amp
l_int|0xFF
suffix:semicolon
)brace
r_if
c_cond
(paren
id|next_frame-&gt;cip_syt2
)paren
(brace
id|next_frame-&gt;cip_syt2-&gt;b
(braket
l_int|6
)braket
op_assign
id|next_frame-&gt;assigned_timestamp
op_rshift
l_int|8
suffix:semicolon
id|next_frame-&gt;cip_syt2-&gt;b
(braket
l_int|7
)braket
op_assign
id|next_frame-&gt;assigned_timestamp
op_amp
l_int|0xFF
suffix:semicolon
)brace
)brace
multiline_comment|/* see if the frame looped */
r_if
c_cond
(paren
op_star
(paren
id|f-&gt;frame_end_timestamp
)paren
)paren
(brace
op_star
(paren
id|f-&gt;frame_end_timestamp
)paren
op_assign
l_int|0
suffix:semicolon
id|debug_printk
c_func
(paren
l_string|&quot;  END - the frame looped at least once&bslash;n&quot;
)paren
suffix:semicolon
id|video-&gt;dropped_frames
op_increment
suffix:semicolon
)brace
)brace
multiline_comment|/* for (each frame) */
)brace
r_if
c_cond
(paren
id|wake
)paren
(brace
id|kill_fasync
c_func
(paren
op_amp
id|video-&gt;fasync
comma
id|SIGIO
comma
id|POLL_OUT
)paren
suffix:semicolon
multiline_comment|/* wake readers/writers/ioctl&squot;ers */
id|wake_up_interruptible
c_func
(paren
op_amp
id|video-&gt;waitq
)paren
suffix:semicolon
)brace
id|out
suffix:colon
id|spin_unlock
c_func
(paren
op_amp
id|video-&gt;spinlock
)paren
suffix:semicolon
)brace
DECL|function|ir_tasklet_func
r_static
r_void
id|ir_tasklet_func
c_func
(paren
r_int
r_int
id|data
)paren
(brace
r_int
id|wake
op_assign
l_int|0
suffix:semicolon
r_struct
id|video_card
op_star
id|video
op_assign
(paren
r_struct
id|video_card
op_star
)paren
id|data
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|video-&gt;spinlock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|video-&gt;dma_running
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
(paren
id|video-&gt;ohci_ir_ctx
op_ne
op_minus
l_int|1
)paren
op_logical_and
(paren
id|reg_read
c_func
(paren
id|video-&gt;ohci
comma
id|video-&gt;ohci_IsoRcvContextControlSet
)paren
op_amp
(paren
l_int|1
op_lshift
l_int|10
)paren
)paren
)paren
(brace
r_int
id|sof
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* start-of-frame flag */
r_struct
id|frame
op_star
id|f
suffix:semicolon
id|u16
id|packet_length
comma
id|packet_time
suffix:semicolon
r_int
id|i
comma
id|dbc
op_assign
l_int|0
suffix:semicolon
r_struct
id|DMA_descriptor_block
op_star
id|block
op_assign
l_int|NULL
suffix:semicolon
id|u16
id|xferstatus
suffix:semicolon
r_int
id|next_i
comma
id|prev_i
suffix:semicolon
r_struct
id|DMA_descriptor_block
op_star
id|next
op_assign
l_int|NULL
suffix:semicolon
id|dma_addr_t
id|next_dma
op_assign
l_int|0
suffix:semicolon
r_struct
id|DMA_descriptor_block
op_star
id|prev
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* loop over all descriptors in all frames */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|video-&gt;n_frames
op_star
id|MAX_PACKETS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|packet
op_star
id|p
op_assign
id|dma_region_i
c_func
(paren
op_amp
id|video-&gt;packet_buf
comma
r_struct
id|packet
comma
id|video-&gt;current_packet
)paren
suffix:semicolon
multiline_comment|/* make sure we are seeing the latest changes to p */
id|dma_region_sync_for_cpu
c_func
(paren
op_amp
id|video-&gt;packet_buf
comma
(paren
r_int
r_int
)paren
id|p
op_minus
(paren
r_int
r_int
)paren
id|video-&gt;packet_buf.kvirt
comma
r_sizeof
(paren
r_struct
id|packet
)paren
)paren
suffix:semicolon
id|packet_length
op_assign
id|le16_to_cpu
c_func
(paren
id|p-&gt;data_length
)paren
suffix:semicolon
id|packet_time
op_assign
id|le16_to_cpu
c_func
(paren
id|p-&gt;timestamp
)paren
suffix:semicolon
id|irq_printk
c_func
(paren
l_string|&quot;received packet %02d, timestamp=%04x, length=%04x, sof=%02x%02x&bslash;n&quot;
comma
id|video-&gt;current_packet
comma
id|packet_time
comma
id|packet_length
comma
id|p-&gt;data
(braket
l_int|0
)braket
comma
id|p-&gt;data
(braket
l_int|1
)braket
)paren
suffix:semicolon
multiline_comment|/* get the descriptor based on packet_buffer cursor */
id|f
op_assign
id|video-&gt;frames
(braket
id|video-&gt;current_packet
op_div
id|MAX_PACKETS
)braket
suffix:semicolon
id|block
op_assign
op_amp
(paren
id|f-&gt;descriptor_pool
(braket
id|video-&gt;current_packet
op_mod
id|MAX_PACKETS
)braket
)paren
suffix:semicolon
id|xferstatus
op_assign
id|le32_to_cpu
c_func
(paren
id|block-&gt;u.in.il.q
(braket
l_int|3
)braket
)paren
op_rshift
l_int|16
suffix:semicolon
id|xferstatus
op_and_assign
l_int|0x1F
suffix:semicolon
id|irq_printk
c_func
(paren
l_string|&quot;ir_tasklet_func: xferStatus/resCount [%d] = 0x%08x&bslash;n&quot;
comma
id|i
comma
id|le32_to_cpu
c_func
(paren
id|block-&gt;u.in.il.q
(braket
l_int|3
)braket
)paren
)paren
suffix:semicolon
multiline_comment|/* get the current frame */
id|f
op_assign
id|video-&gt;frames
(braket
id|video-&gt;active_frame
)braket
suffix:semicolon
multiline_comment|/* exclude empty packet */
r_if
c_cond
(paren
id|packet_length
OG
l_int|8
op_logical_and
id|xferstatus
op_eq
l_int|0x11
)paren
(brace
multiline_comment|/* check for start of frame */
multiline_comment|/* DRD&gt; Changed to check section type ([0]&gt;&gt;5==0)&n;&t;&t;&t;&t;   and dif sequence ([1]&gt;&gt;4==0) */
id|sof
op_assign
(paren
(paren
id|p-&gt;data
(braket
l_int|0
)braket
op_rshift
l_int|5
)paren
op_eq
l_int|0
op_logical_and
(paren
id|p-&gt;data
(braket
l_int|1
)braket
op_rshift
l_int|4
)paren
op_eq
l_int|0
)paren
suffix:semicolon
id|dbc
op_assign
(paren
r_int
)paren
(paren
id|p-&gt;cip_h1
op_rshift
l_int|24
)paren
suffix:semicolon
r_if
c_cond
(paren
id|video-&gt;continuity_counter
op_ne
op_minus
l_int|1
op_logical_and
id|dbc
OG
(paren
(paren
id|video-&gt;continuity_counter
op_plus
l_int|1
)paren
op_mod
l_int|256
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;dv1394: discontinuity detected, dropping all frames&bslash;n&quot;
)paren
suffix:semicolon
id|video-&gt;dropped_frames
op_add_assign
id|video-&gt;n_clear_frames
op_plus
l_int|1
suffix:semicolon
id|video-&gt;first_frame
op_assign
l_int|0
suffix:semicolon
id|video-&gt;n_clear_frames
op_assign
l_int|0
suffix:semicolon
id|video-&gt;first_clear_frame
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
id|video-&gt;continuity_counter
op_assign
id|dbc
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|video-&gt;first_frame
)paren
(brace
r_if
c_cond
(paren
id|sof
)paren
(brace
id|video-&gt;first_frame
op_assign
l_int|1
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|sof
)paren
(brace
multiline_comment|/* close current frame */
id|frame_reset
c_func
(paren
id|f
)paren
suffix:semicolon
multiline_comment|/* f-&gt;state = STATE_CLEAR */
id|video-&gt;n_clear_frames
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|video-&gt;n_clear_frames
OG
id|video-&gt;n_frames
)paren
(brace
id|video-&gt;dropped_frames
op_increment
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;dv1394: dropped a frame during reception&bslash;n&quot;
)paren
suffix:semicolon
id|video-&gt;n_clear_frames
op_assign
id|video-&gt;n_frames
op_minus
l_int|1
suffix:semicolon
id|video-&gt;first_clear_frame
op_assign
(paren
id|video-&gt;first_clear_frame
op_plus
l_int|1
)paren
op_mod
id|video-&gt;n_frames
suffix:semicolon
)brace
r_if
c_cond
(paren
id|video-&gt;first_clear_frame
op_eq
op_minus
l_int|1
)paren
id|video-&gt;first_clear_frame
op_assign
id|video-&gt;active_frame
suffix:semicolon
multiline_comment|/* get the next frame */
id|video-&gt;active_frame
op_assign
(paren
id|video-&gt;active_frame
op_plus
l_int|1
)paren
op_mod
id|video-&gt;n_frames
suffix:semicolon
id|f
op_assign
id|video-&gt;frames
(braket
id|video-&gt;active_frame
)braket
suffix:semicolon
id|irq_printk
c_func
(paren
l_string|&quot;   frame received, active_frame = %d, n_clear_frames = %d, first_clear_frame = %d&bslash;n&quot;
comma
id|video-&gt;active_frame
comma
id|video-&gt;n_clear_frames
comma
id|video-&gt;first_clear_frame
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|video-&gt;first_frame
)paren
(brace
r_if
c_cond
(paren
id|sof
)paren
(brace
multiline_comment|/* open next frame */
id|f-&gt;state
op_assign
id|FRAME_READY
suffix:semicolon
)brace
multiline_comment|/* copy to buffer */
r_if
c_cond
(paren
id|f-&gt;n_packets
OG
(paren
id|video-&gt;frame_size
op_div
l_int|480
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;frame buffer overflow during receive&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|frame_put_packet
c_func
(paren
id|f
comma
id|p
)paren
suffix:semicolon
)brace
multiline_comment|/* first_frame */
)brace
multiline_comment|/* stop, end of ready packets */
r_else
r_if
c_cond
(paren
id|xferstatus
op_eq
l_int|0
)paren
(brace
r_break
suffix:semicolon
)brace
multiline_comment|/* reset xferStatus &amp; resCount */
id|block-&gt;u.in.il.q
(braket
l_int|3
)braket
op_assign
id|cpu_to_le32
c_func
(paren
l_int|512
)paren
suffix:semicolon
multiline_comment|/* terminate dma chain at this (next) packet */
id|next_i
op_assign
id|video-&gt;current_packet
suffix:semicolon
id|f
op_assign
id|video-&gt;frames
(braket
id|next_i
op_div
id|MAX_PACKETS
)braket
suffix:semicolon
id|next
op_assign
op_amp
(paren
id|f-&gt;descriptor_pool
(braket
id|next_i
op_mod
id|MAX_PACKETS
)braket
)paren
suffix:semicolon
id|next_dma
op_assign
(paren
(paren
r_int
r_int
)paren
id|block
op_minus
(paren
r_int
r_int
)paren
id|f-&gt;descriptor_pool
)paren
op_plus
id|f-&gt;descriptor_pool_dma
suffix:semicolon
id|next-&gt;u.in.il.q
(braket
l_int|0
)braket
op_or_assign
l_int|3
op_lshift
l_int|20
suffix:semicolon
multiline_comment|/* enable interrupt */
id|next-&gt;u.in.il.q
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* disable branch */
multiline_comment|/* link previous to next */
id|prev_i
op_assign
(paren
id|next_i
op_eq
l_int|0
)paren
ques
c_cond
(paren
id|MAX_PACKETS
op_star
id|video-&gt;n_frames
op_minus
l_int|1
)paren
suffix:colon
(paren
id|next_i
op_minus
l_int|1
)paren
suffix:semicolon
id|f
op_assign
id|video-&gt;frames
(braket
id|prev_i
op_div
id|MAX_PACKETS
)braket
suffix:semicolon
id|prev
op_assign
op_amp
(paren
id|f-&gt;descriptor_pool
(braket
id|prev_i
op_mod
id|MAX_PACKETS
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|prev_i
op_mod
(paren
id|MAX_PACKETS
op_div
l_int|2
)paren
)paren
(brace
id|prev-&gt;u.in.il.q
(braket
l_int|0
)braket
op_and_assign
op_complement
(paren
l_int|3
op_lshift
l_int|20
)paren
suffix:semicolon
multiline_comment|/* no interrupt */
)brace
r_else
(brace
id|prev-&gt;u.in.il.q
(braket
l_int|0
)braket
op_or_assign
l_int|3
op_lshift
l_int|20
suffix:semicolon
multiline_comment|/* enable interrupt */
)brace
id|prev-&gt;u.in.il.q
(braket
l_int|2
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|next_dma
op_or
l_int|1
)paren
suffix:semicolon
multiline_comment|/* set Z=1 */
id|wmb
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* wake up DMA in case it fell asleep */
id|reg_write
c_func
(paren
id|video-&gt;ohci
comma
id|video-&gt;ohci_IsoRcvContextControlSet
comma
(paren
l_int|1
op_lshift
l_int|12
)paren
)paren
suffix:semicolon
multiline_comment|/* advance packet_buffer cursor */
id|video-&gt;current_packet
op_assign
(paren
id|video-&gt;current_packet
op_plus
l_int|1
)paren
op_mod
(paren
id|MAX_PACKETS
op_star
id|video-&gt;n_frames
)paren
suffix:semicolon
)brace
multiline_comment|/* for all packets */
id|wake
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* why the hell not? */
)brace
multiline_comment|/* receive interrupt */
r_if
c_cond
(paren
id|wake
)paren
(brace
id|kill_fasync
c_func
(paren
op_amp
id|video-&gt;fasync
comma
id|SIGIO
comma
id|POLL_IN
)paren
suffix:semicolon
multiline_comment|/* wake readers/writers/ioctl&squot;ers */
id|wake_up_interruptible
c_func
(paren
op_amp
id|video-&gt;waitq
)paren
suffix:semicolon
)brace
id|out
suffix:colon
id|spin_unlock
c_func
(paren
op_amp
id|video-&gt;spinlock
)paren
suffix:semicolon
)brace
DECL|variable|dv1394_cdev
r_static
r_struct
id|cdev
id|dv1394_cdev
suffix:semicolon
DECL|variable|dv1394_fops
r_static
r_struct
id|file_operations
id|dv1394_fops
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|poll
op_assign
id|dv1394_poll
comma
dot
id|unlocked_ioctl
op_assign
id|dv1394_ioctl
comma
macro_line|#ifdef CONFIG_COMPAT
dot
id|compat_ioctl
op_assign
id|dv1394_compat_ioctl
comma
macro_line|#endif
dot
id|mmap
op_assign
id|dv1394_mmap
comma
dot
id|open
op_assign
id|dv1394_open
comma
dot
id|write
op_assign
id|dv1394_write
comma
dot
id|read
op_assign
id|dv1394_read
comma
dot
id|release
op_assign
id|dv1394_release
comma
dot
id|fasync
op_assign
id|dv1394_fasync
comma
)brace
suffix:semicolon
multiline_comment|/*** HOTPLUG STUFF **********************************************************/
multiline_comment|/*&n; * Export information about protocols/devices supported by this driver.&n; */
DECL|variable|dv1394_id_table
r_static
r_struct
id|ieee1394_device_id
id|dv1394_id_table
(braket
)braket
op_assign
(brace
(brace
dot
id|match_flags
op_assign
id|IEEE1394_MATCH_SPECIFIER_ID
op_or
id|IEEE1394_MATCH_VERSION
comma
dot
id|specifier_id
op_assign
id|AVC_UNIT_SPEC_ID_ENTRY
op_amp
l_int|0xffffff
comma
dot
id|version
op_assign
id|AVC_SW_VERSION_ENTRY
op_amp
l_int|0xffffff
)brace
comma
(brace
)brace
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|ieee1394
comma
id|dv1394_id_table
)paren
suffix:semicolon
DECL|variable|dv1394_driver
r_static
r_struct
id|hpsb_protocol_driver
id|dv1394_driver
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;DV/1394 Driver&quot;
comma
dot
id|id_table
op_assign
id|dv1394_id_table
comma
dot
id|driver
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;dv1394&quot;
comma
dot
id|bus
op_assign
op_amp
id|ieee1394_bus_type
comma
)brace
comma
)brace
suffix:semicolon
multiline_comment|/*** IEEE1394 HPSB CALLBACKS ***********************************************/
DECL|function|dv1394_init
r_static
r_int
id|dv1394_init
c_func
(paren
r_struct
id|ti_ohci
op_star
id|ohci
comma
r_enum
id|pal_or_ntsc
id|format
comma
r_enum
id|modes
id|mode
)paren
(brace
r_struct
id|video_card
op_star
id|video
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|i
suffix:semicolon
id|video
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|video_card
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|video
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;dv1394: cannot allocate video_card&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|err
suffix:semicolon
)brace
id|memset
c_func
(paren
id|video
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|video_card
)paren
)paren
suffix:semicolon
id|video-&gt;ohci
op_assign
id|ohci
suffix:semicolon
multiline_comment|/* lower 2 bits of id indicate which of four &quot;plugs&quot;&n;&t;   per host */
id|video-&gt;id
op_assign
id|ohci-&gt;host-&gt;id
op_lshift
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|format
op_eq
id|DV1394_NTSC
)paren
id|video-&gt;id
op_or_assign
id|mode
suffix:semicolon
r_else
id|video-&gt;id
op_or_assign
l_int|2
op_plus
id|mode
suffix:semicolon
id|video-&gt;ohci_it_ctx
op_assign
op_minus
l_int|1
suffix:semicolon
id|video-&gt;ohci_ir_ctx
op_assign
op_minus
l_int|1
suffix:semicolon
id|video-&gt;ohci_IsoXmitContextControlSet
op_assign
l_int|0
suffix:semicolon
id|video-&gt;ohci_IsoXmitContextControlClear
op_assign
l_int|0
suffix:semicolon
id|video-&gt;ohci_IsoXmitCommandPtr
op_assign
l_int|0
suffix:semicolon
id|video-&gt;ohci_IsoRcvContextControlSet
op_assign
l_int|0
suffix:semicolon
id|video-&gt;ohci_IsoRcvContextControlClear
op_assign
l_int|0
suffix:semicolon
id|video-&gt;ohci_IsoRcvCommandPtr
op_assign
l_int|0
suffix:semicolon
id|video-&gt;ohci_IsoRcvContextMatch
op_assign
l_int|0
suffix:semicolon
id|video-&gt;n_frames
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* flag that video is not initialized */
id|video-&gt;channel
op_assign
l_int|63
suffix:semicolon
multiline_comment|/* default to broadcast channel */
id|video-&gt;active_frame
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* initialize the following */
id|video-&gt;pal_or_ntsc
op_assign
id|format
suffix:semicolon
id|video-&gt;cip_n
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* 0 = use builtin default */
id|video-&gt;cip_d
op_assign
l_int|0
suffix:semicolon
id|video-&gt;syt_offset
op_assign
l_int|0
suffix:semicolon
id|video-&gt;mode
op_assign
id|mode
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|DV1394_MAX_FRAMES
suffix:semicolon
id|i
op_increment
)paren
id|video-&gt;frames
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
id|dma_region_init
c_func
(paren
op_amp
id|video-&gt;dv_buf
)paren
suffix:semicolon
id|video-&gt;dv_buf_size
op_assign
l_int|0
suffix:semicolon
id|dma_region_init
c_func
(paren
op_amp
id|video-&gt;packet_buf
)paren
suffix:semicolon
id|video-&gt;packet_buf_size
op_assign
l_int|0
suffix:semicolon
id|clear_bit
c_func
(paren
l_int|0
comma
op_amp
id|video-&gt;open
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|video-&gt;spinlock
)paren
suffix:semicolon
id|video-&gt;dma_running
op_assign
l_int|0
suffix:semicolon
id|init_MUTEX
c_func
(paren
op_amp
id|video-&gt;sem
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|video-&gt;waitq
)paren
suffix:semicolon
id|video-&gt;fasync
op_assign
l_int|NULL
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|dv1394_cards_lock
comma
id|flags
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|video-&gt;list
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|video-&gt;list
comma
op_amp
id|dv1394_cards
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|dv1394_cards_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|devfs_mk_cdev
c_func
(paren
id|MKDEV
c_func
(paren
id|IEEE1394_MAJOR
comma
id|IEEE1394_MINOR_BLOCK_DV1394
op_star
l_int|16
op_plus
id|video-&gt;id
)paren
comma
id|S_IFCHR
op_or
id|S_IRUGO
op_or
id|S_IWUGO
comma
l_string|&quot;ieee1394/dv/host%d/%s/%s&quot;
comma
(paren
id|video-&gt;id
op_rshift
l_int|2
)paren
comma
(paren
id|video-&gt;pal_or_ntsc
op_eq
id|DV1394_NTSC
ques
c_cond
l_string|&quot;NTSC&quot;
suffix:colon
l_string|&quot;PAL&quot;
)paren
comma
(paren
id|video-&gt;mode
op_eq
id|MODE_RECEIVE
ques
c_cond
l_string|&quot;in&quot;
suffix:colon
l_string|&quot;out&quot;
)paren
)paren
OL
l_int|0
)paren
r_goto
id|err_free
suffix:semicolon
id|debug_printk
c_func
(paren
l_string|&quot;dv1394: dv1394_init() OK on ID %d&bslash;n&quot;
comma
id|video-&gt;id
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|err_free
suffix:colon
id|kfree
c_func
(paren
id|video
)paren
suffix:semicolon
id|err
suffix:colon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
DECL|function|dv1394_un_init
r_static
r_void
id|dv1394_un_init
c_func
(paren
r_struct
id|video_card
op_star
id|video
)paren
(brace
r_char
id|buf
(braket
l_int|32
)braket
suffix:semicolon
multiline_comment|/* obviously nobody has the driver open at this point */
id|do_dv1394_shutdown
c_func
(paren
id|video
comma
l_int|1
)paren
suffix:semicolon
id|snprintf
c_func
(paren
id|buf
comma
r_sizeof
(paren
id|buf
)paren
comma
l_string|&quot;dv/host%d/%s/%s&quot;
comma
(paren
id|video-&gt;id
op_rshift
l_int|2
)paren
comma
(paren
id|video-&gt;pal_or_ntsc
op_eq
id|DV1394_NTSC
ques
c_cond
l_string|&quot;NTSC&quot;
suffix:colon
l_string|&quot;PAL&quot;
)paren
comma
(paren
id|video-&gt;mode
op_eq
id|MODE_RECEIVE
ques
c_cond
l_string|&quot;in&quot;
suffix:colon
l_string|&quot;out&quot;
)paren
)paren
suffix:semicolon
id|devfs_remove
c_func
(paren
l_string|&quot;ieee1394/%s&quot;
comma
id|buf
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|video
)paren
suffix:semicolon
)brace
DECL|function|dv1394_remove_host
r_static
r_void
id|dv1394_remove_host
(paren
r_struct
id|hpsb_host
op_star
id|host
)paren
(brace
r_struct
id|video_card
op_star
id|video
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|id
op_assign
id|host-&gt;id
suffix:semicolon
multiline_comment|/* We only work with the OHCI-1394 driver */
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|host-&gt;driver-&gt;name
comma
id|OHCI1394_DRIVER_NAME
)paren
)paren
r_return
suffix:semicolon
multiline_comment|/* find the corresponding video_cards */
r_do
(brace
r_struct
id|video_card
op_star
id|tmp_vid
suffix:semicolon
id|video
op_assign
l_int|NULL
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|dv1394_cards_lock
comma
id|flags
)paren
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|tmp_vid
comma
op_amp
id|dv1394_cards
comma
id|list
)paren
(brace
r_if
c_cond
(paren
(paren
id|tmp_vid-&gt;id
op_rshift
l_int|2
)paren
op_eq
id|id
)paren
(brace
id|list_del
c_func
(paren
op_amp
id|tmp_vid-&gt;list
)paren
suffix:semicolon
id|video
op_assign
id|tmp_vid
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|dv1394_cards_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|video
)paren
id|dv1394_un_init
c_func
(paren
id|video
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|video
op_ne
l_int|NULL
)paren
suffix:semicolon
id|devfs_remove
c_func
(paren
l_string|&quot;ieee1394/dv/host%d/NTSC&quot;
comma
id|id
)paren
suffix:semicolon
id|devfs_remove
c_func
(paren
l_string|&quot;ieee1394/dv/host%d/PAL&quot;
comma
id|id
)paren
suffix:semicolon
id|devfs_remove
c_func
(paren
l_string|&quot;ieee1394/dv/host%d&quot;
comma
id|id
)paren
suffix:semicolon
)brace
DECL|function|dv1394_add_host
r_static
r_void
id|dv1394_add_host
(paren
r_struct
id|hpsb_host
op_star
id|host
)paren
(brace
r_struct
id|ti_ohci
op_star
id|ohci
suffix:semicolon
r_int
id|id
op_assign
id|host-&gt;id
suffix:semicolon
multiline_comment|/* We only work with the OHCI-1394 driver */
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|host-&gt;driver-&gt;name
comma
id|OHCI1394_DRIVER_NAME
)paren
)paren
r_return
suffix:semicolon
id|ohci
op_assign
(paren
r_struct
id|ti_ohci
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
id|devfs_mk_dir
c_func
(paren
l_string|&quot;ieee1394/dv/host%d&quot;
comma
id|id
)paren
suffix:semicolon
id|devfs_mk_dir
c_func
(paren
l_string|&quot;ieee1394/dv/host%d/NTSC&quot;
comma
id|id
)paren
suffix:semicolon
id|devfs_mk_dir
c_func
(paren
l_string|&quot;ieee1394/dv/host%d/PAL&quot;
comma
id|id
)paren
suffix:semicolon
id|dv1394_init
c_func
(paren
id|ohci
comma
id|DV1394_NTSC
comma
id|MODE_RECEIVE
)paren
suffix:semicolon
id|dv1394_init
c_func
(paren
id|ohci
comma
id|DV1394_NTSC
comma
id|MODE_TRANSMIT
)paren
suffix:semicolon
id|dv1394_init
c_func
(paren
id|ohci
comma
id|DV1394_PAL
comma
id|MODE_RECEIVE
)paren
suffix:semicolon
id|dv1394_init
c_func
(paren
id|ohci
comma
id|DV1394_PAL
comma
id|MODE_TRANSMIT
)paren
suffix:semicolon
)brace
multiline_comment|/* Bus reset handler. In the event of a bus reset, we may need to&n;   re-start the DMA contexts - otherwise the user program would&n;   end up waiting forever.&n;*/
DECL|function|dv1394_host_reset
r_static
r_void
id|dv1394_host_reset
c_func
(paren
r_struct
id|hpsb_host
op_star
id|host
)paren
(brace
r_struct
id|ti_ohci
op_star
id|ohci
suffix:semicolon
r_struct
id|video_card
op_star
id|video
op_assign
l_int|NULL
comma
op_star
id|tmp_vid
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/* We only work with the OHCI-1394 driver */
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|host-&gt;driver-&gt;name
comma
id|OHCI1394_DRIVER_NAME
)paren
)paren
r_return
suffix:semicolon
id|ohci
op_assign
(paren
r_struct
id|ti_ohci
op_star
)paren
id|host-&gt;hostdata
suffix:semicolon
multiline_comment|/* find the corresponding video_cards */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|dv1394_cards_lock
comma
id|flags
)paren
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|tmp_vid
comma
op_amp
id|dv1394_cards
comma
id|list
)paren
(brace
r_if
c_cond
(paren
(paren
id|tmp_vid-&gt;id
op_rshift
l_int|2
)paren
op_eq
id|host-&gt;id
)paren
(brace
id|video
op_assign
id|tmp_vid
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|dv1394_cards_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|video
)paren
r_return
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|video-&gt;spinlock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|video-&gt;dma_running
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* check IT context */
r_if
c_cond
(paren
id|video-&gt;ohci_it_ctx
op_ne
op_minus
l_int|1
)paren
(brace
id|u32
id|ctx
suffix:semicolon
id|ctx
op_assign
id|reg_read
c_func
(paren
id|video-&gt;ohci
comma
id|video-&gt;ohci_IsoXmitContextControlSet
)paren
suffix:semicolon
multiline_comment|/* if (RUN but not ACTIVE) */
r_if
c_cond
(paren
(paren
id|ctx
op_amp
(paren
l_int|1
op_lshift
l_int|15
)paren
)paren
op_logical_and
op_logical_neg
(paren
id|ctx
op_amp
(paren
l_int|1
op_lshift
l_int|10
)paren
)paren
)paren
(brace
id|debug_printk
c_func
(paren
l_string|&quot;dv1394: IT context stopped due to bus reset; waking it up&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* to be safe, assume a frame has been dropped. User-space programs&n;&t;&t;&t;   should handle this condition like an underflow. */
id|video-&gt;dropped_frames
op_increment
suffix:semicolon
multiline_comment|/* for some reason you must clear, then re-set the RUN bit to restart DMA */
multiline_comment|/* clear RUN */
id|reg_write
c_func
(paren
id|video-&gt;ohci
comma
id|video-&gt;ohci_IsoXmitContextControlClear
comma
(paren
l_int|1
op_lshift
l_int|15
)paren
)paren
suffix:semicolon
id|flush_pci_write
c_func
(paren
id|video-&gt;ohci
)paren
suffix:semicolon
multiline_comment|/* set RUN */
id|reg_write
c_func
(paren
id|video-&gt;ohci
comma
id|video-&gt;ohci_IsoXmitContextControlSet
comma
(paren
l_int|1
op_lshift
l_int|15
)paren
)paren
suffix:semicolon
id|flush_pci_write
c_func
(paren
id|video-&gt;ohci
)paren
suffix:semicolon
multiline_comment|/* set the WAKE bit (just in case; this isn&squot;t strictly necessary) */
id|reg_write
c_func
(paren
id|video-&gt;ohci
comma
id|video-&gt;ohci_IsoXmitContextControlSet
comma
(paren
l_int|1
op_lshift
l_int|12
)paren
)paren
suffix:semicolon
id|flush_pci_write
c_func
(paren
id|video-&gt;ohci
)paren
suffix:semicolon
id|irq_printk
c_func
(paren
l_string|&quot;dv1394: AFTER IT restart ctx 0x%08x ptr 0x%08x&bslash;n&quot;
comma
id|reg_read
c_func
(paren
id|video-&gt;ohci
comma
id|video-&gt;ohci_IsoXmitContextControlSet
)paren
comma
id|reg_read
c_func
(paren
id|video-&gt;ohci
comma
id|video-&gt;ohci_IsoXmitCommandPtr
)paren
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* check IR context */
r_if
c_cond
(paren
id|video-&gt;ohci_ir_ctx
op_ne
op_minus
l_int|1
)paren
(brace
id|u32
id|ctx
suffix:semicolon
id|ctx
op_assign
id|reg_read
c_func
(paren
id|video-&gt;ohci
comma
id|video-&gt;ohci_IsoRcvContextControlSet
)paren
suffix:semicolon
multiline_comment|/* if (RUN but not ACTIVE) */
r_if
c_cond
(paren
(paren
id|ctx
op_amp
(paren
l_int|1
op_lshift
l_int|15
)paren
)paren
op_logical_and
op_logical_neg
(paren
id|ctx
op_amp
(paren
l_int|1
op_lshift
l_int|10
)paren
)paren
)paren
(brace
id|debug_printk
c_func
(paren
l_string|&quot;dv1394: IR context stopped due to bus reset; waking it up&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* to be safe, assume a frame has been dropped. User-space programs&n;&t;&t;&t;   should handle this condition like an overflow. */
id|video-&gt;dropped_frames
op_increment
suffix:semicolon
multiline_comment|/* for some reason you must clear, then re-set the RUN bit to restart DMA */
multiline_comment|/* XXX this doesn&squot;t work for me, I can&squot;t get IR DMA to restart :[ */
multiline_comment|/* clear RUN */
id|reg_write
c_func
(paren
id|video-&gt;ohci
comma
id|video-&gt;ohci_IsoRcvContextControlClear
comma
(paren
l_int|1
op_lshift
l_int|15
)paren
)paren
suffix:semicolon
id|flush_pci_write
c_func
(paren
id|video-&gt;ohci
)paren
suffix:semicolon
multiline_comment|/* set RUN */
id|reg_write
c_func
(paren
id|video-&gt;ohci
comma
id|video-&gt;ohci_IsoRcvContextControlSet
comma
(paren
l_int|1
op_lshift
l_int|15
)paren
)paren
suffix:semicolon
id|flush_pci_write
c_func
(paren
id|video-&gt;ohci
)paren
suffix:semicolon
multiline_comment|/* set the WAKE bit (just in case; this isn&squot;t strictly necessary) */
id|reg_write
c_func
(paren
id|video-&gt;ohci
comma
id|video-&gt;ohci_IsoRcvContextControlSet
comma
(paren
l_int|1
op_lshift
l_int|12
)paren
)paren
suffix:semicolon
id|flush_pci_write
c_func
(paren
id|video-&gt;ohci
)paren
suffix:semicolon
id|irq_printk
c_func
(paren
l_string|&quot;dv1394: AFTER IR restart ctx 0x%08x ptr 0x%08x&bslash;n&quot;
comma
id|reg_read
c_func
(paren
id|video-&gt;ohci
comma
id|video-&gt;ohci_IsoRcvContextControlSet
)paren
comma
id|reg_read
c_func
(paren
id|video-&gt;ohci
comma
id|video-&gt;ohci_IsoRcvCommandPtr
)paren
)paren
suffix:semicolon
)brace
)brace
id|out
suffix:colon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|video-&gt;spinlock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* wake readers/writers/ioctl&squot;ers */
id|wake_up_interruptible
c_func
(paren
op_amp
id|video-&gt;waitq
)paren
suffix:semicolon
)brace
DECL|variable|dv1394_highlevel
r_static
r_struct
id|hpsb_highlevel
id|dv1394_highlevel
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;dv1394&quot;
comma
dot
id|add_host
op_assign
id|dv1394_add_host
comma
dot
id|remove_host
op_assign
id|dv1394_remove_host
comma
dot
id|host_reset
op_assign
id|dv1394_host_reset
comma
)brace
suffix:semicolon
macro_line|#ifdef CONFIG_COMPAT
DECL|macro|DV1394_IOC32_INIT
mdefine_line|#define DV1394_IOC32_INIT       _IOW(&squot;#&squot;, 0x06, struct dv1394_init32)
DECL|macro|DV1394_IOC32_GET_STATUS
mdefine_line|#define DV1394_IOC32_GET_STATUS _IOR(&squot;#&squot;, 0x0c, struct dv1394_status32)
DECL|struct|dv1394_init32
r_struct
id|dv1394_init32
(brace
DECL|member|api_version
id|u32
id|api_version
suffix:semicolon
DECL|member|channel
id|u32
id|channel
suffix:semicolon
DECL|member|n_frames
id|u32
id|n_frames
suffix:semicolon
DECL|member|format
id|u32
id|format
suffix:semicolon
DECL|member|cip_n
id|u32
id|cip_n
suffix:semicolon
DECL|member|cip_d
id|u32
id|cip_d
suffix:semicolon
DECL|member|syt_offset
id|u32
id|syt_offset
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|dv1394_status32
r_struct
id|dv1394_status32
(brace
DECL|member|init
r_struct
id|dv1394_init32
id|init
suffix:semicolon
DECL|member|active_frame
id|s32
id|active_frame
suffix:semicolon
DECL|member|first_clear_frame
id|u32
id|first_clear_frame
suffix:semicolon
DECL|member|n_clear_frames
id|u32
id|n_clear_frames
suffix:semicolon
DECL|member|dropped_frames
id|u32
id|dropped_frames
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* RED-PEN: this should use compat_alloc_userspace instead */
DECL|function|handle_dv1394_init
r_static
r_int
id|handle_dv1394_init
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_struct
id|dv1394_init32
id|dv32
suffix:semicolon
r_struct
id|dv1394_init
id|dv
suffix:semicolon
id|mm_segment_t
id|old_fs
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_op-&gt;ioctl
op_ne
id|dv1394_ioctl
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|dv32
comma
(paren
r_void
id|__user
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|dv32
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|dv.api_version
op_assign
id|dv32.api_version
suffix:semicolon
id|dv.channel
op_assign
id|dv32.channel
suffix:semicolon
id|dv.n_frames
op_assign
id|dv32.n_frames
suffix:semicolon
id|dv.format
op_assign
id|dv32.format
suffix:semicolon
id|dv.cip_n
op_assign
(paren
r_int
r_int
)paren
id|dv32.cip_n
suffix:semicolon
id|dv.cip_d
op_assign
(paren
r_int
r_int
)paren
id|dv32.cip_d
suffix:semicolon
id|dv.syt_offset
op_assign
id|dv32.syt_offset
suffix:semicolon
id|old_fs
op_assign
id|get_fs
c_func
(paren
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|KERNEL_DS
)paren
suffix:semicolon
id|ret
op_assign
id|dv1394_ioctl
c_func
(paren
id|file
comma
id|DV1394_IOC_INIT
comma
(paren
r_int
r_int
)paren
op_amp
id|dv
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|old_fs
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|handle_dv1394_get_status
r_static
r_int
id|handle_dv1394_get_status
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_struct
id|dv1394_status32
id|dv32
suffix:semicolon
r_struct
id|dv1394_status
id|dv
suffix:semicolon
id|mm_segment_t
id|old_fs
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_op-&gt;ioctl
op_ne
id|dv1394_ioctl
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|old_fs
op_assign
id|get_fs
c_func
(paren
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|KERNEL_DS
)paren
suffix:semicolon
id|ret
op_assign
id|dv1394_ioctl
c_func
(paren
id|file
comma
id|DV1394_IOC_GET_STATUS
comma
(paren
r_int
r_int
)paren
op_amp
id|dv
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|old_fs
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
(brace
id|dv32.init.api_version
op_assign
id|dv.init.api_version
suffix:semicolon
id|dv32.init.channel
op_assign
id|dv.init.channel
suffix:semicolon
id|dv32.init.n_frames
op_assign
id|dv.init.n_frames
suffix:semicolon
id|dv32.init.format
op_assign
id|dv.init.format
suffix:semicolon
id|dv32.init.cip_n
op_assign
(paren
id|u32
)paren
id|dv.init.cip_n
suffix:semicolon
id|dv32.init.cip_d
op_assign
(paren
id|u32
)paren
id|dv.init.cip_d
suffix:semicolon
id|dv32.init.syt_offset
op_assign
id|dv.init.syt_offset
suffix:semicolon
id|dv32.active_frame
op_assign
id|dv.active_frame
suffix:semicolon
id|dv32.first_clear_frame
op_assign
id|dv.first_clear_frame
suffix:semicolon
id|dv32.n_clear_frames
op_assign
id|dv.n_clear_frames
suffix:semicolon
id|dv32.dropped_frames
op_assign
id|dv.dropped_frames
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_struct
id|dv1394_status32
id|__user
op_star
)paren
id|arg
comma
op_amp
id|dv32
comma
r_sizeof
(paren
id|dv32
)paren
)paren
)paren
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|function|dv1394_compat_ioctl
r_static
r_int
id|dv1394_compat_ioctl
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_int
id|err
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|DV1394_IOC_SHUTDOWN
suffix:colon
r_case
id|DV1394_IOC_SUBMIT_FRAMES
suffix:colon
r_case
id|DV1394_IOC_WAIT_FRAMES
suffix:colon
r_case
id|DV1394_IOC_RECEIVE_FRAMES
suffix:colon
r_case
id|DV1394_IOC_START_RECEIVE
suffix:colon
r_return
id|dv1394_ioctl
c_func
(paren
id|file
comma
id|cmd
comma
id|arg
)paren
suffix:semicolon
r_case
id|DV1394_IOC32_INIT
suffix:colon
r_return
id|handle_dv1394_init
c_func
(paren
id|file
comma
id|cmd
comma
id|arg
)paren
suffix:semicolon
r_case
id|DV1394_IOC32_GET_STATUS
suffix:colon
r_return
id|handle_dv1394_get_status
c_func
(paren
id|file
comma
id|cmd
comma
id|arg
)paren
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
)brace
)brace
macro_line|#endif /* CONFIG_COMPAT */
multiline_comment|/*** KERNEL MODULE HANDLERS ************************************************/
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Dan Maas &lt;dmaas@dcine.com&gt;, Dan Dennedy &lt;dan@dennedy.org&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;driver for DV input/output on OHCI board&quot;
)paren
suffix:semicolon
id|MODULE_SUPPORTED_DEVICE
c_func
(paren
l_string|&quot;dv1394&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
DECL|function|dv1394_exit_module
r_static
r_void
id|__exit
id|dv1394_exit_module
c_func
(paren
r_void
)paren
(brace
id|hpsb_unregister_protocol
c_func
(paren
op_amp
id|dv1394_driver
)paren
suffix:semicolon
id|hpsb_unregister_highlevel
c_func
(paren
op_amp
id|dv1394_highlevel
)paren
suffix:semicolon
id|cdev_del
c_func
(paren
op_amp
id|dv1394_cdev
)paren
suffix:semicolon
id|devfs_remove
c_func
(paren
l_string|&quot;ieee1394/dv&quot;
)paren
suffix:semicolon
)brace
DECL|function|dv1394_init_module
r_static
r_int
id|__init
id|dv1394_init_module
c_func
(paren
r_void
)paren
(brace
r_int
id|ret
suffix:semicolon
id|cdev_init
c_func
(paren
op_amp
id|dv1394_cdev
comma
op_amp
id|dv1394_fops
)paren
suffix:semicolon
id|dv1394_cdev.owner
op_assign
id|THIS_MODULE
suffix:semicolon
id|kobject_set_name
c_func
(paren
op_amp
id|dv1394_cdev.kobj
comma
l_string|&quot;dv1394&quot;
)paren
suffix:semicolon
id|ret
op_assign
id|cdev_add
c_func
(paren
op_amp
id|dv1394_cdev
comma
id|IEEE1394_DV1394_DEV
comma
l_int|16
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;dv1394: unable to register character device&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
id|devfs_mk_dir
c_func
(paren
l_string|&quot;ieee1394/dv&quot;
)paren
suffix:semicolon
id|hpsb_register_highlevel
c_func
(paren
op_amp
id|dv1394_highlevel
)paren
suffix:semicolon
id|ret
op_assign
id|hpsb_register_protocol
c_func
(paren
op_amp
id|dv1394_driver
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;dv1394: failed to register protocol&bslash;n&quot;
)paren
suffix:semicolon
id|hpsb_unregister_highlevel
c_func
(paren
op_amp
id|dv1394_highlevel
)paren
suffix:semicolon
id|devfs_remove
c_func
(paren
l_string|&quot;ieee1394/dv&quot;
)paren
suffix:semicolon
id|cdev_del
c_func
(paren
op_amp
id|dv1394_cdev
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|dv1394_init_module
id|module_init
c_func
(paren
id|dv1394_init_module
)paren
suffix:semicolon
DECL|variable|dv1394_exit_module
id|module_exit
c_func
(paren
id|dv1394_exit_module
)paren
suffix:semicolon
id|MODULE_ALIAS_CHARDEV
c_func
(paren
id|IEEE1394_MAJOR
comma
id|IEEE1394_MINOR_BLOCK_DV1394
op_star
l_int|16
)paren
suffix:semicolon
eof
