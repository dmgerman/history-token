multiline_comment|/*&n; * ohci1394.c - driver for OHCI 1394 boards&n; * Copyright (C)1999,2000 Sebastien Rougeaux &lt;sebastien.rougeaux@anu.edu.au&gt;&n; *                        Gord Peters &lt;GordPeters@smarttech.com&gt;&n; *              2001      Ben Collins &lt;bcollins@debian.org&gt;&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or&n; * (at your option) any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software Foundation,&n; * Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.&n; */
multiline_comment|/*&n; * Things known to be working:&n; * . Async Request Transmit&n; * . Async Response Receive&n; * . Async Request Receive&n; * . Async Response Transmit&n; * . Iso Receive&n; * . DMA mmap for iso receive&n; * . Config ROM generation&n; *&n; * Things implemented, but still in test phase:&n; * . Iso Transmit&n; * &n; * Things not implemented:&n; * . Async Stream Packets&n; * . DMA error recovery&n; *&n; * Things to be fixed:&n; * . Latency problems on UltraSPARC&n; *&n; * Known bugs:&n; * . SelfID are sometimes not received properly &n; *   if card is initialized with no other nodes &n; *   on the bus&n; * . Apple PowerBook detected but not working yet&n; */
multiline_comment|/* &n; * Acknowledgments:&n; *&n; * Adam J Richter &lt;adam@yggdrasil.com&gt;&n; *  . Use of pci_class to find device&n; *&n; * Andreas Tobler &lt;toa@pop.agri.ch&gt;&n; *  . Updated proc_fs calls&n; *&n; * Emilie Chung&t;&lt;emilie.chung@axis.com&gt;&n; *  . Tip on Async Request Filter&n; *&n; * Pascal Drolet &lt;pascal.drolet@informission.ca&gt;&n; *  . Various tips for optimization and functionnalities&n; *&n; * Robert Ficklin &lt;rficklin@westengineering.com&gt;&n; *  . Loop in irq_handler&n; *&n; * James Goodwin &lt;jamesg@Filanet.com&gt;&n; *  . Various tips on initialization, self-id reception, etc.&n; *&n; * Albrecht Dress &lt;ad@mpifr-bonn.mpg.de&gt;&n; *  . Apple PowerBook detection&n; *&n; * Daniel Kobras &lt;daniel.kobras@student.uni-tuebingen.de&gt;&n; *  . Reset the board properly before leaving + misc cleanups&n; *&n; * Leon van Stuivenberg &lt;leonvs@iae.nl&gt;&n; *  . Bug fixes&n; *&n; * Ben Collins &lt;bcollins@debian.org&gt;&n; *  . Working big-endian support&n; *  . Updated to 2.4.x module scheme (PCI aswell)&n; *  . Removed procfs support since it trashes random mem&n; *  . Config ROM generation&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/list.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/wait.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/poll.h&gt;
macro_line|#include &lt;asm/byteorder.h&gt;
macro_line|#include &lt;asm/atomic.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/tqueue.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/page.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;asm/segment.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/wrapper.h&gt;
macro_line|#include &lt;linux/vmalloc.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &quot;ieee1394.h&quot;
macro_line|#include &quot;ieee1394_types.h&quot;
macro_line|#include &quot;hosts.h&quot;
macro_line|#include &quot;ieee1394_core.h&quot;
macro_line|#include &quot;highlevel.h&quot;
macro_line|#include &quot;ohci1394.h&quot;
macro_line|#ifdef CONFIG_IEEE1394_VERBOSEDEBUG
DECL|macro|OHCI1394_DEBUG
mdefine_line|#define OHCI1394_DEBUG
macro_line|#endif
macro_line|#ifdef DBGMSG
DECL|macro|DBGMSG
macro_line|#undef DBGMSG
macro_line|#endif
macro_line|#ifdef OHCI1394_DEBUG
DECL|macro|DBGMSG
mdefine_line|#define DBGMSG(card, fmt, args...) &bslash;&n;printk(KERN_INFO &quot;ohci1394_%d: &quot; fmt &quot;&bslash;n&quot; , card , ## args)
macro_line|#else
DECL|macro|DBGMSG
mdefine_line|#define DBGMSG(card, fmt, args...)
macro_line|#endif
macro_line|#ifdef CONFIG_IEEE1394_OHCI_DMA_DEBUG
DECL|macro|OHCI_DMA_ALLOC
mdefine_line|#define OHCI_DMA_ALLOC(fmt, args...) &bslash;&n;&t;HPSB_ERR(&quot;ohci1394(&quot;__FUNCTION__&quot;)alloc(%d): &quot;fmt, &bslash;&n;&t;&t;++global_outstanding_dmas, ## args)
DECL|macro|OHCI_DMA_FREE
mdefine_line|#define OHCI_DMA_FREE(fmt, args...) &bslash;&n;&t;HPSB_ERR(&quot;ohci1394(&quot;__FUNCTION__&quot;)free(%d): &quot;fmt, &bslash;&n;&t;&t;--global_outstanding_dmas, ## args)
DECL|variable|global_outstanding_dmas
id|u32
id|global_outstanding_dmas
op_assign
l_int|0
suffix:semicolon
macro_line|#else
DECL|macro|OHCI_DMA_ALLOC
mdefine_line|#define OHCI_DMA_ALLOC(fmt, args...)
DECL|macro|OHCI_DMA_FREE
mdefine_line|#define OHCI_DMA_FREE(fmt, args...)
macro_line|#endif
multiline_comment|/* print general (card independent) information */
DECL|macro|PRINT_G
mdefine_line|#define PRINT_G(level, fmt, args...) &bslash;&n;printk(level &quot;ohci1394: &quot; fmt &quot;&bslash;n&quot; , ## args)
multiline_comment|/* print card specific information */
DECL|macro|PRINT
mdefine_line|#define PRINT(level, card, fmt, args...) &bslash;&n;printk(level &quot;ohci1394_%d: &quot; fmt &quot;&bslash;n&quot; , card , ## args)
DECL|macro|FAIL
mdefine_line|#define FAIL(fmt, args...)&t;&t;&t;&t;&bslash;&n;do {&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;PRINT_G(KERN_ERR, fmt , ## args);&t;&t;&bslash;&n;&t;remove_card(ohci);&t;&t;&t;&t;&bslash;&n;&t;return 1;&t;&t;&t;&t;&t;&bslash;&n;} while(0)
DECL|macro|PCI_CLASS_FIREWIRE_OHCI
mdefine_line|#define PCI_CLASS_FIREWIRE_OHCI     ((PCI_CLASS_SERIAL_FIREWIRE &lt;&lt; 8) | 0x10)
DECL|variable|__devinitdata
r_static
r_struct
id|pci_device_id
id|ohci1394_pci_tbl
(braket
)braket
id|__devinitdata
op_assign
(brace
(brace
r_class
suffix:colon
id|PCI_CLASS_FIREWIRE_OHCI
comma
id|class_mask
suffix:colon
l_int|0x00ffffff
comma
id|vendor
suffix:colon
id|PCI_ANY_ID
comma
id|device
suffix:colon
id|PCI_ANY_ID
comma
id|subvendor
suffix:colon
id|PCI_ANY_ID
comma
id|subdevice
suffix:colon
id|PCI_ANY_ID
comma
)brace
comma
(brace
l_int|0
comma
)brace
comma
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|pci
comma
id|ohci1394_pci_tbl
)paren
suffix:semicolon
DECL|variable|__devinitdata
r_static
r_char
id|version
(braket
)braket
id|__devinitdata
op_assign
l_string|&quot;v0.50 15/Jul/01 Ben Collins &lt;bcollins@debian.org&gt;&quot;
suffix:semicolon
multiline_comment|/* Module Parameters */
id|MODULE_PARM
c_func
(paren
id|attempt_root
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|attempt_root
comma
l_string|&quot;Attempt to make the host root.&quot;
)paren
suffix:semicolon
DECL|variable|attempt_root
r_static
r_int
id|attempt_root
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef __LITTLE_ENDIAN
multiline_comment|/* Don&squot;t waste cycles on same sex byte swaps */
DECL|macro|packet_swab
mdefine_line|#define packet_swab(w,x,y,z)
DECL|macro|block_swab32
mdefine_line|#define block_swab32(x,y)
macro_line|#else
r_static
r_void
id|packet_swab
c_func
(paren
id|quadlet_t
op_star
id|data
comma
r_char
id|tcode
comma
r_int
id|len
comma
r_int
id|payload_swap
)paren
suffix:semicolon
r_static
id|__inline__
r_void
id|block_swab32
c_func
(paren
id|quadlet_t
op_star
id|data
comma
r_int
id|size
)paren
suffix:semicolon
macro_line|#endif
DECL|variable|card_id_counter
r_static
r_int
r_int
id|card_id_counter
op_assign
l_int|0
suffix:semicolon
r_static
r_void
id|dma_trm_tasklet
c_func
(paren
r_int
r_int
id|data
)paren
suffix:semicolon
r_static
r_void
id|remove_card
c_func
(paren
r_struct
id|ti_ohci
op_star
id|ohci
)paren
suffix:semicolon
r_static
r_void
id|dma_trm_reset
c_func
(paren
r_struct
id|dma_trm_ctx
op_star
id|d
)paren
suffix:semicolon
multiline_comment|/***********************************&n; * IEEE-1394 functionality section *&n; ***********************************/
DECL|function|get_phy_reg
r_static
id|u8
id|get_phy_reg
c_func
(paren
r_struct
id|ti_ohci
op_star
id|ohci
comma
id|u8
id|addr
)paren
(brace
r_int
id|i
comma
id|flags
suffix:semicolon
id|quadlet_t
id|r
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|ohci-&gt;phy_reg_lock
comma
id|flags
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_PhyControl
comma
(paren
(paren
(paren
id|u16
)paren
id|addr
op_lshift
l_int|8
)paren
op_amp
l_int|0x00000f00
)paren
op_or
l_int|0x00008000
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|OHCI_LOOP_COUNT
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_PhyControl
)paren
op_amp
l_int|0x80000000
)paren
r_break
suffix:semicolon
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
id|r
op_assign
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_PhyControl
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ge
id|OHCI_LOOP_COUNT
)paren
id|PRINT
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;Get PHY Reg timeout [0x%08x/0x%08x/%d]&bslash;n&quot;
comma
id|r
comma
id|r
op_amp
l_int|0x80000000
comma
id|i
)paren
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|ohci-&gt;phy_reg_lock
comma
id|flags
)paren
suffix:semicolon
r_return
(paren
id|r
op_amp
l_int|0x00ff0000
)paren
op_rshift
l_int|16
suffix:semicolon
)brace
DECL|function|set_phy_reg
r_static
r_void
id|set_phy_reg
c_func
(paren
r_struct
id|ti_ohci
op_star
id|ohci
comma
id|u8
id|addr
comma
id|u8
id|data
)paren
(brace
r_int
id|i
comma
id|flags
suffix:semicolon
id|u32
id|r
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|ohci-&gt;phy_reg_lock
comma
id|flags
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_PhyControl
comma
l_int|0x00004000
op_or
(paren
(paren
(paren
id|u16
)paren
id|addr
op_lshift
l_int|8
)paren
op_amp
l_int|0x00000f00
)paren
op_or
id|data
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|OHCI_LOOP_COUNT
suffix:semicolon
id|i
op_increment
)paren
(brace
id|r
op_assign
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_PhyControl
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|r
op_amp
l_int|0x00004000
)paren
)paren
r_break
suffix:semicolon
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_eq
id|OHCI_LOOP_COUNT
)paren
id|PRINT
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;Set PHY Reg timeout [0x%08x/0x%08x/%d]&bslash;n&quot;
comma
id|r
comma
id|r
op_amp
l_int|0x00004000
comma
id|i
)paren
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|ohci-&gt;phy_reg_lock
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Or&squot;s our value into the current value */
DECL|function|set_phy_reg_mask
r_static
r_void
id|set_phy_reg_mask
c_func
(paren
r_struct
id|ti_ohci
op_star
id|ohci
comma
id|u8
id|addr
comma
id|u8
id|data
)paren
(brace
id|u8
id|old
suffix:semicolon
id|old
op_assign
id|get_phy_reg
(paren
id|ohci
comma
id|addr
)paren
suffix:semicolon
id|old
op_or_assign
id|data
suffix:semicolon
id|set_phy_reg
(paren
id|ohci
comma
id|addr
comma
id|old
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|handle_selfid
r_static
r_int
id|handle_selfid
c_func
(paren
r_struct
id|ti_ohci
op_star
id|ohci
comma
r_struct
id|hpsb_host
op_star
id|host
comma
r_int
id|phyid
comma
r_int
id|isroot
)paren
(brace
id|quadlet_t
op_star
id|q
op_assign
id|ohci-&gt;selfid_buf_cpu
suffix:semicolon
id|quadlet_t
id|self_id_count
op_assign
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_SelfIDCount
)paren
suffix:semicolon
r_int
id|size
suffix:semicolon
id|quadlet_t
id|q0
comma
id|q1
suffix:semicolon
multiline_comment|/* SelfID handling seems much easier than for the aic5800 chip.&n;&t;   All the self-id packets, including this devices own self-id,&n;&t;   should be correctly arranged in the selfid buffer at this&n;&t;   stage */
multiline_comment|/* Check status of self-id reception */
r_if
c_cond
(paren
id|ohci-&gt;selfid_swap
)paren
id|q0
op_assign
id|le32_to_cpu
c_func
(paren
id|q
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_else
id|q0
op_assign
id|q
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|self_id_count
op_amp
l_int|0x80000000
)paren
op_logical_or
(paren
(paren
id|self_id_count
op_amp
l_int|0x00FF0000
)paren
op_ne
(paren
id|q0
op_amp
l_int|0x00FF0000
)paren
)paren
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;Error in reception of SelfID packets [0x%08x/0x%08x]&quot;
comma
id|self_id_count
comma
id|q0
)paren
suffix:semicolon
multiline_comment|/* Tip by James Goodwin &lt;jamesg@Filanet.com&gt;:&n;&t;&t; * We had an error, generate another bus reset in response.  */
r_if
c_cond
(paren
id|ohci-&gt;self_id_errors
OL
id|OHCI1394_MAX_SELF_ID_ERRORS
)paren
(brace
id|set_phy_reg_mask
(paren
id|ohci
comma
l_int|1
comma
l_int|0x40
)paren
suffix:semicolon
id|ohci-&gt;self_id_errors
op_increment
suffix:semicolon
)brace
r_else
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;Too many errors on SelfID error reception, giving up!&quot;
)paren
suffix:semicolon
)brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|size
op_assign
(paren
(paren
id|self_id_count
op_amp
l_int|0x00001FFC
)paren
op_rshift
l_int|2
)paren
op_minus
l_int|1
suffix:semicolon
id|q
op_increment
suffix:semicolon
r_while
c_loop
(paren
id|size
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|ohci-&gt;selfid_swap
)paren
(brace
id|q0
op_assign
id|le32_to_cpu
c_func
(paren
id|q
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|q1
op_assign
id|le32_to_cpu
c_func
(paren
id|q
(braket
l_int|1
)braket
)paren
suffix:semicolon
)brace
r_else
(brace
id|q0
op_assign
id|q
(braket
l_int|0
)braket
suffix:semicolon
id|q1
op_assign
id|q
(braket
l_int|1
)braket
suffix:semicolon
)brace
r_if
c_cond
(paren
id|q0
op_eq
op_complement
id|q1
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_DEBUG
comma
id|ohci-&gt;id
comma
l_string|&quot;SelfID packet 0x%x received&quot;
comma
id|q0
)paren
suffix:semicolon
id|hpsb_selfid_received
c_func
(paren
id|host
comma
id|cpu_to_be32
c_func
(paren
id|q0
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|q0
op_amp
l_int|0x3f000000
)paren
op_rshift
l_int|24
)paren
op_eq
id|phyid
)paren
id|DBGMSG
(paren
id|ohci-&gt;id
comma
l_string|&quot;SelfID for this node is 0x%08x&quot;
comma
id|q0
)paren
suffix:semicolon
)brace
r_else
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;SelfID is inconsistent [0x%08x/0x%08x]&quot;
comma
id|q0
comma
id|q1
)paren
suffix:semicolon
)brace
id|q
op_add_assign
l_int|2
suffix:semicolon
id|size
op_sub_assign
l_int|2
suffix:semicolon
)brace
id|PRINT
c_func
(paren
id|KERN_DEBUG
comma
id|ohci-&gt;id
comma
l_string|&quot;SelfID complete&quot;
)paren
suffix:semicolon
id|hpsb_selfid_complete
c_func
(paren
id|host
comma
id|phyid
comma
id|isroot
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ohci_soft_reset
r_static
r_int
id|ohci_soft_reset
c_func
(paren
r_struct
id|ti_ohci
op_star
id|ohci
)paren
(brace
r_int
id|i
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_HCControlSet
comma
l_int|0x00010000
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|OHCI_LOOP_COUNT
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_HCControlSet
)paren
op_amp
l_int|0x00010000
)paren
r_break
suffix:semicolon
id|mdelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
id|PRINT
c_func
(paren
id|KERN_DEBUG
comma
id|ohci-&gt;id
comma
l_string|&quot;Soft reset finished&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|run_context
r_static
r_int
id|run_context
c_func
(paren
r_struct
id|ti_ohci
op_star
id|ohci
comma
r_int
id|reg
comma
r_char
op_star
id|msg
)paren
(brace
id|u32
id|nodeId
suffix:semicolon
multiline_comment|/* check that the node id is valid */
id|nodeId
op_assign
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_NodeID
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|nodeId
op_amp
l_int|0x80000000
)paren
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;Running dma failed because Node ID is not valid&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* check that the node number != 63 */
r_if
c_cond
(paren
(paren
id|nodeId
op_amp
l_int|0x3f
)paren
op_eq
l_int|63
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;Running dma failed because Node ID == 63&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Run the dma context */
id|reg_write
c_func
(paren
id|ohci
comma
id|reg
comma
l_int|0x8000
)paren
suffix:semicolon
r_if
c_cond
(paren
id|msg
)paren
id|PRINT
c_func
(paren
id|KERN_DEBUG
comma
id|ohci-&gt;id
comma
l_string|&quot;%s&quot;
comma
id|msg
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Generate the dma receive prgs and start the context */
DECL|function|initialize_dma_rcv_ctx
r_static
r_void
id|initialize_dma_rcv_ctx
c_func
(paren
r_struct
id|dma_rcv_ctx
op_star
id|d
)paren
(brace
r_struct
id|ti_ohci
op_star
id|ohci
op_assign
(paren
r_struct
id|ti_ohci
op_star
)paren
(paren
id|d-&gt;ohci
)paren
suffix:semicolon
r_int
id|i
suffix:semicolon
id|ohci1394_stop_context
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlClear
comma
l_int|NULL
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|d-&gt;num_desc
suffix:semicolon
id|i
op_increment
)paren
(brace
id|d-&gt;prg_cpu
(braket
id|i
)braket
op_member_access_from_pointer
id|control
op_assign
id|cpu_to_le32
c_func
(paren
(paren
l_int|0x280C
op_lshift
l_int|16
)paren
op_or
id|d-&gt;buf_size
)paren
suffix:semicolon
multiline_comment|/* End of descriptor list? */
r_if
c_cond
(paren
(paren
id|i
op_plus
l_int|1
)paren
OL
id|d-&gt;num_desc
)paren
(brace
id|d-&gt;prg_cpu
(braket
id|i
)braket
op_member_access_from_pointer
id|branchAddress
op_assign
id|cpu_to_le32
c_func
(paren
(paren
id|d-&gt;prg_bus
(braket
id|i
op_plus
l_int|1
)braket
op_amp
l_int|0xfffffff0
)paren
op_or
l_int|0x1
)paren
suffix:semicolon
)brace
r_else
(brace
id|d-&gt;prg_cpu
(braket
id|i
)braket
op_member_access_from_pointer
id|branchAddress
op_assign
id|cpu_to_le32
c_func
(paren
(paren
id|d-&gt;prg_bus
(braket
l_int|0
)braket
op_amp
l_int|0xfffffff0
)paren
)paren
suffix:semicolon
)brace
id|d-&gt;prg_cpu
(braket
id|i
)braket
op_member_access_from_pointer
id|address
op_assign
id|cpu_to_le32
c_func
(paren
id|d-&gt;buf_bus
(braket
id|i
)braket
)paren
suffix:semicolon
id|d-&gt;prg_cpu
(braket
id|i
)braket
op_member_access_from_pointer
id|status
op_assign
id|cpu_to_le32
c_func
(paren
id|d-&gt;buf_size
)paren
suffix:semicolon
)brace
id|d-&gt;buf_ind
op_assign
l_int|0
suffix:semicolon
id|d-&gt;buf_offset
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Tell the controller where the first AR program is */
id|reg_write
c_func
(paren
id|ohci
comma
id|d-&gt;cmdPtr
comma
id|d-&gt;prg_bus
(braket
l_int|0
)braket
op_or
l_int|0x1
)paren
suffix:semicolon
multiline_comment|/* Run AR context */
id|reg_write
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlSet
comma
l_int|0x00008000
)paren
suffix:semicolon
id|DBGMSG
c_func
(paren
id|ohci-&gt;id
comma
l_string|&quot;Receive DMA ctx=%d initialized&quot;
comma
id|d-&gt;ctx
)paren
suffix:semicolon
)brace
multiline_comment|/* Initialize the dma transmit context */
DECL|function|initialize_dma_trm_ctx
r_static
r_void
id|initialize_dma_trm_ctx
c_func
(paren
r_struct
id|dma_trm_ctx
op_star
id|d
)paren
(brace
r_struct
id|ti_ohci
op_star
id|ohci
op_assign
(paren
r_struct
id|ti_ohci
op_star
)paren
(paren
id|d-&gt;ohci
)paren
suffix:semicolon
multiline_comment|/* Stop the context */
id|ohci1394_stop_context
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlClear
comma
l_int|NULL
)paren
suffix:semicolon
id|d-&gt;prg_ind
op_assign
l_int|0
suffix:semicolon
id|d-&gt;sent_ind
op_assign
l_int|0
suffix:semicolon
id|d-&gt;free_prgs
op_assign
id|d-&gt;num_desc
suffix:semicolon
id|d-&gt;branchAddrPtr
op_assign
l_int|NULL
suffix:semicolon
id|d-&gt;fifo_first
op_assign
l_int|NULL
suffix:semicolon
id|d-&gt;fifo_last
op_assign
l_int|NULL
suffix:semicolon
id|d-&gt;pending_first
op_assign
l_int|NULL
suffix:semicolon
id|d-&gt;pending_last
op_assign
l_int|NULL
suffix:semicolon
id|DBGMSG
c_func
(paren
id|ohci-&gt;id
comma
l_string|&quot;Transmit dma ctx=%d initialized&quot;
comma
id|d-&gt;ctx
)paren
suffix:semicolon
)brace
multiline_comment|/* Count the number of available iso contexts */
DECL|function|get_nb_iso_ctx
r_static
r_int
id|get_nb_iso_ctx
c_func
(paren
r_struct
id|ti_ohci
op_star
id|ohci
comma
r_int
id|reg
)paren
(brace
r_int
id|i
comma
id|ctx
op_assign
l_int|0
suffix:semicolon
id|u32
id|tmp
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|reg
comma
l_int|0xffffffff
)paren
suffix:semicolon
id|tmp
op_assign
id|reg_read
c_func
(paren
id|ohci
comma
id|reg
)paren
suffix:semicolon
id|DBGMSG
c_func
(paren
id|ohci-&gt;id
comma
l_string|&quot;Iso contexts reg: %08x implemented: %08x&quot;
comma
id|reg
comma
id|tmp
)paren
suffix:semicolon
multiline_comment|/* Count the number of contexts */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|tmp
op_amp
l_int|1
)paren
(brace
id|ctx
op_increment
suffix:semicolon
)brace
id|tmp
op_rshift_assign
l_int|1
suffix:semicolon
)brace
r_return
id|ctx
suffix:semicolon
)brace
multiline_comment|/* Global initialization */
DECL|function|ohci_initialize
r_static
r_int
id|ohci_initialize
c_func
(paren
r_struct
id|hpsb_host
op_star
id|host
)paren
(brace
r_struct
id|ti_ohci
op_star
id|ohci
op_assign
id|host-&gt;hostdata
suffix:semicolon
r_int
id|retval
comma
id|i
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|ohci-&gt;phy_reg_lock
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|ohci-&gt;event_lock
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Tip by James Goodwin &lt;jamesg@Filanet.com&gt;:&n;&t; * We need to add delays after the soft reset, setting LPS, and&n;&t; * enabling our link. This might fixes the self-id reception &n;&t; * problem at initialization.&n;&t; */
multiline_comment|/* Soft reset */
r_if
c_cond
(paren
(paren
id|retval
op_assign
id|ohci_soft_reset
c_func
(paren
id|ohci
)paren
)paren
OL
l_int|0
)paren
r_return
id|retval
suffix:semicolon
multiline_comment|/* &n;&t; * Delay after soft reset to make sure everything has settled&n;&t; * down (sanity)&n;&t; */
id|mdelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
multiline_comment|/* Set Link Power Status (LPS) */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_HCControlSet
comma
l_int|0x00080000
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Delay after setting LPS in order to make sure link/phy&n;&t; * communication is established&n;&t; */
id|mdelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
multiline_comment|/* Set the bus number */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_NodeID
comma
l_int|0x0000ffc0
)paren
suffix:semicolon
multiline_comment|/* Enable posted writes */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_HCControlSet
comma
l_int|0x00040000
)paren
suffix:semicolon
multiline_comment|/* Clear link control register */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_LinkControlClear
comma
l_int|0xffffffff
)paren
suffix:semicolon
multiline_comment|/* Enable cycle timer and cycle master */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_LinkControlSet
comma
l_int|0x00300000
)paren
suffix:semicolon
multiline_comment|/* Clear interrupt registers */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IntMaskClear
comma
l_int|0xffffffff
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IntEventClear
comma
l_int|0xffffffff
)paren
suffix:semicolon
multiline_comment|/* Set up self-id dma buffer */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_SelfIDBuffer
comma
id|ohci-&gt;selfid_buf_bus
)paren
suffix:semicolon
multiline_comment|/* enable self-id dma */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_LinkControlSet
comma
l_int|0x00000200
)paren
suffix:semicolon
multiline_comment|/* Set the configuration ROM mapping register */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_ConfigROMmap
comma
id|ohci-&gt;csr_config_rom_bus
)paren
suffix:semicolon
id|ohci-&gt;max_packet_size
op_assign
l_int|1
op_lshift
(paren
(paren
(paren
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_BusOptions
)paren
op_rshift
l_int|12
)paren
op_amp
l_int|0xf
)paren
op_plus
l_int|1
)paren
suffix:semicolon
id|PRINT
c_func
(paren
id|KERN_DEBUG
comma
id|ohci-&gt;id
comma
l_string|&quot;Max packet size = %d bytes&quot;
comma
id|ohci-&gt;max_packet_size
)paren
suffix:semicolon
multiline_comment|/* Don&squot;t accept phy packets into AR request context */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_LinkControlClear
comma
l_int|0x00000400
)paren
suffix:semicolon
multiline_comment|/* Initialize IR dma */
id|ohci-&gt;nb_iso_rcv_ctx
op_assign
id|get_nb_iso_ctx
c_func
(paren
id|ohci
comma
id|OHCI1394_IsoRecvIntMaskSet
)paren
suffix:semicolon
id|DBGMSG
c_func
(paren
id|ohci-&gt;id
comma
l_string|&quot;%d iso receive contexts available&quot;
comma
id|ohci-&gt;nb_iso_rcv_ctx
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ohci-&gt;nb_iso_rcv_ctx
suffix:semicolon
id|i
op_increment
)paren
(brace
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IsoRcvContextControlClear
op_plus
l_int|32
op_star
id|i
comma
l_int|0xffffffff
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IsoRcvContextMatch
op_plus
l_int|32
op_star
id|i
comma
l_int|0
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IsoRcvCommandPtr
op_plus
l_int|32
op_star
id|i
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* Set bufferFill, isochHeader, multichannel for IR context */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IsoRcvContextControlSet
comma
l_int|0xd0000000
)paren
suffix:semicolon
multiline_comment|/* Set the context match register to match on all tags */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IsoRcvContextMatch
comma
l_int|0xf0000000
)paren
suffix:semicolon
multiline_comment|/* Clear the interrupt mask */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IsoRecvIntMaskClear
comma
l_int|0xffffffff
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IsoRecvIntEventClear
comma
l_int|0xffffffff
)paren
suffix:semicolon
multiline_comment|/* Initialize IT dma */
id|ohci-&gt;nb_iso_xmit_ctx
op_assign
id|get_nb_iso_ctx
c_func
(paren
id|ohci
comma
id|OHCI1394_IsoXmitIntMaskSet
)paren
suffix:semicolon
id|DBGMSG
c_func
(paren
id|ohci-&gt;id
comma
l_string|&quot;%d iso transmit contexts available&quot;
comma
id|ohci-&gt;nb_iso_xmit_ctx
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ohci-&gt;nb_iso_xmit_ctx
suffix:semicolon
id|i
op_increment
)paren
(brace
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IsoXmitContextControlClear
op_plus
l_int|32
op_star
id|i
comma
l_int|0xffffffff
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IsoXmitCommandPtr
op_plus
l_int|32
op_star
id|i
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* Clear the interrupt mask */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IsoXmitIntMaskClear
comma
l_int|0xffffffff
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IsoXmitIntEventClear
comma
l_int|0xffffffff
)paren
suffix:semicolon
multiline_comment|/* Clear the multi channel mask high and low registers */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IRMultiChanMaskHiClear
comma
l_int|0xffffffff
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IRMultiChanMaskLoClear
comma
l_int|0xffffffff
)paren
suffix:semicolon
multiline_comment|/* Initialize AR dma */
id|initialize_dma_rcv_ctx
c_func
(paren
id|ohci-&gt;ar_req_context
)paren
suffix:semicolon
id|initialize_dma_rcv_ctx
c_func
(paren
id|ohci-&gt;ar_resp_context
)paren
suffix:semicolon
multiline_comment|/* Initialize AT dma */
id|initialize_dma_trm_ctx
c_func
(paren
id|ohci-&gt;at_req_context
)paren
suffix:semicolon
id|initialize_dma_trm_ctx
c_func
(paren
id|ohci-&gt;at_resp_context
)paren
suffix:semicolon
multiline_comment|/* Initialize IR dma */
id|initialize_dma_rcv_ctx
c_func
(paren
id|ohci-&gt;ir_context
)paren
suffix:semicolon
multiline_comment|/* Initialize IT dma */
id|initialize_dma_trm_ctx
c_func
(paren
id|ohci-&gt;it_context
)paren
suffix:semicolon
multiline_comment|/* Set up isoRecvIntMask to generate interrupts for context 0&n;&t;   (thanks to Michael Greger for seeing that I forgot this) */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IsoRecvIntMaskSet
comma
l_int|0x00000001
)paren
suffix:semicolon
multiline_comment|/* Set up isoXmitIntMask to generate interrupts for context 0 */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IsoXmitIntMaskSet
comma
l_int|0x00000001
)paren
suffix:semicolon
multiline_comment|/* &n;&t; * Accept AT requests from all nodes. This probably &n;&t; * will have to be controlled from the subsystem&n;&t; * on a per node basis.&n;&t; */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_AsReqFilterHiSet
comma
l_int|0x80000000
)paren
suffix:semicolon
multiline_comment|/* Specify AT retries */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_ATRetries
comma
id|OHCI1394_MAX_AT_REQ_RETRIES
op_or
(paren
id|OHCI1394_MAX_AT_RESP_RETRIES
op_lshift
l_int|4
)paren
op_or
(paren
id|OHCI1394_MAX_PHYS_RESP_RETRIES
op_lshift
l_int|8
)paren
)paren
suffix:semicolon
multiline_comment|/* We don&squot;t want hardware swapping */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_HCControlClear
comma
l_int|0x40000000
)paren
suffix:semicolon
multiline_comment|/* Enable interrupts */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IntMaskSet
comma
id|OHCI1394_masterIntEnable
op_or
id|OHCI1394_phyRegRcvd
op_or
id|OHCI1394_busReset
op_or
id|OHCI1394_selfIDComplete
op_or
id|OHCI1394_RSPkt
op_or
id|OHCI1394_RQPkt
op_or
id|OHCI1394_respTxComplete
op_or
id|OHCI1394_reqTxComplete
op_or
id|OHCI1394_isochRx
op_or
id|OHCI1394_isochTx
op_or
id|OHCI1394_unrecoverableError
)paren
suffix:semicolon
multiline_comment|/* Enable link */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_HCControlSet
comma
l_int|0x00020000
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|ohci_remove
r_static
r_void
id|ohci_remove
c_func
(paren
r_struct
id|hpsb_host
op_star
id|host
)paren
(brace
r_struct
id|ti_ohci
op_star
id|ohci
suffix:semicolon
r_if
c_cond
(paren
id|host
op_ne
l_int|NULL
)paren
(brace
id|ohci
op_assign
id|host-&gt;hostdata
suffix:semicolon
id|remove_card
c_func
(paren
id|ohci
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* &n; * Insert a packet in the AT DMA fifo and generate the DMA prg&n; * FIXME: rewrite the program in order to accept packets crossing&n; *        page boundaries.&n; *        check also that a single dma descriptor doesn&squot;t cross a &n; *        page boundary.&n; */
DECL|function|insert_packet
r_static
r_void
id|insert_packet
c_func
(paren
r_struct
id|ti_ohci
op_star
id|ohci
comma
r_struct
id|dma_trm_ctx
op_star
id|d
comma
r_struct
id|hpsb_packet
op_star
id|packet
)paren
(brace
id|u32
id|cycleTimer
suffix:semicolon
r_int
id|idx
op_assign
id|d-&gt;prg_ind
suffix:semicolon
id|DBGMSG
c_func
(paren
id|ohci-&gt;id
comma
l_string|&quot;Inserting packet for node %d, tlabel=%d, tcode=0x%x, speed=%d&bslash;n&quot;
comma
id|packet-&gt;node_id
comma
id|packet-&gt;tlabel
comma
id|packet-&gt;tcode
comma
id|packet-&gt;speed_code
)paren
suffix:semicolon
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|begin.address
op_assign
l_int|0
suffix:semicolon
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|begin.branchAddress
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;ctx
op_eq
l_int|1
)paren
(brace
multiline_comment|/* &n;&t;&t; * For response packets, we need to put a timeout value in&n;&t;&t; * the 16 lower bits of the status... let&squot;s try 1 sec timeout &n;&t;&t; */
id|cycleTimer
op_assign
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_IsochronousCycleTimer
)paren
suffix:semicolon
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|begin.status
op_assign
id|cpu_to_le32
c_func
(paren
(paren
(paren
(paren
(paren
(paren
id|cycleTimer
op_rshift
l_int|25
)paren
op_amp
l_int|0x7
)paren
op_plus
l_int|1
)paren
op_amp
l_int|0x7
)paren
op_lshift
l_int|13
)paren
op_or
(paren
(paren
id|cycleTimer
op_amp
l_int|0x01fff000
)paren
op_rshift
l_int|12
)paren
)paren
suffix:semicolon
id|DBGMSG
c_func
(paren
id|ohci-&gt;id
comma
l_string|&quot;cycleTimer: %08x timeStamp: %08x&quot;
comma
id|cycleTimer
comma
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|begin.status
)paren
suffix:semicolon
)brace
r_else
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|begin.status
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|packet-&gt;type
op_eq
id|async
)paren
op_logical_or
(paren
id|packet-&gt;type
op_eq
id|raw
)paren
)paren
(brace
r_if
c_cond
(paren
id|packet-&gt;type
op_eq
id|raw
)paren
(brace
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|data
(braket
l_int|0
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|OHCI1394_TCODE_PHY
op_lshift
l_int|4
)paren
suffix:semicolon
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|data
(braket
l_int|1
)braket
op_assign
id|packet-&gt;header
(braket
l_int|0
)braket
suffix:semicolon
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|data
(braket
l_int|2
)braket
op_assign
id|packet-&gt;header
(braket
l_int|1
)braket
suffix:semicolon
)brace
r_else
(brace
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|data
(braket
l_int|0
)braket
op_assign
id|packet-&gt;speed_code
op_lshift
l_int|16
op_or
(paren
id|packet-&gt;header
(braket
l_int|0
)braket
op_amp
l_int|0xFFFF
)paren
suffix:semicolon
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|data
(braket
l_int|1
)braket
op_assign
(paren
id|packet-&gt;header
(braket
l_int|1
)braket
op_amp
l_int|0xFFFF
)paren
op_or
(paren
id|packet-&gt;header
(braket
l_int|0
)braket
op_amp
l_int|0xFFFF0000
)paren
suffix:semicolon
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|data
(braket
l_int|2
)braket
op_assign
id|packet-&gt;header
(braket
l_int|2
)braket
suffix:semicolon
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|data
(braket
l_int|3
)braket
op_assign
id|packet-&gt;header
(braket
l_int|3
)braket
suffix:semicolon
id|packet_swab
c_func
(paren
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|data
comma
id|packet-&gt;tcode
comma
id|packet-&gt;header_size
op_rshift
l_int|2
comma
id|ohci-&gt;payload_swap
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|packet-&gt;data_size
)paren
(brace
multiline_comment|/* block transmit */
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|begin.control
op_assign
id|cpu_to_le32
c_func
(paren
id|OUTPUT_MORE_IMMEDIATE
op_or
l_int|0x10
)paren
suffix:semicolon
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|end.control
op_assign
id|cpu_to_le32
c_func
(paren
id|OUTPUT_LAST
op_or
id|packet-&gt;data_size
)paren
suffix:semicolon
multiline_comment|/* &n;                         * Check that the packet data buffer&n;                         * does not cross a page boundary.&n;                         */
r_if
c_cond
(paren
id|cross_bound
c_func
(paren
(paren
r_int
r_int
)paren
id|packet-&gt;data
comma
id|packet-&gt;data_size
)paren
OG
l_int|0
)paren
(brace
multiline_comment|/* FIXME: do something about it */
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
id|__FUNCTION__
l_string|&quot;: packet data addr: %p size %Zd bytes &quot;
l_string|&quot;cross page boundary&quot;
comma
id|packet-&gt;data
comma
id|packet-&gt;data_size
)paren
suffix:semicolon
)brace
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|end.address
op_assign
id|cpu_to_le32
c_func
(paren
id|pci_map_single
c_func
(paren
id|ohci-&gt;dev
comma
id|packet-&gt;data
comma
id|packet-&gt;data_size
comma
id|PCI_DMA_TODEVICE
)paren
)paren
suffix:semicolon
id|OHCI_DMA_ALLOC
c_func
(paren
l_string|&quot;single, block transmit packet&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ohci-&gt;payload_swap
)paren
id|block_swab32
c_func
(paren
id|packet-&gt;data
comma
id|packet-&gt;data_size
op_rshift
l_int|2
)paren
suffix:semicolon
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|end.branchAddress
op_assign
l_int|0
suffix:semicolon
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|end.status
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;branchAddrPtr
)paren
op_star
(paren
id|d-&gt;branchAddrPtr
)paren
op_assign
id|cpu_to_le32
c_func
(paren
id|d-&gt;prg_bus
(braket
id|idx
)braket
op_or
l_int|0x3
)paren
suffix:semicolon
id|d-&gt;branchAddrPtr
op_assign
op_amp
(paren
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|end.branchAddress
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* quadlet transmit */
r_if
c_cond
(paren
id|packet-&gt;type
op_eq
id|raw
)paren
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|begin.control
op_assign
id|cpu_to_le32
c_func
(paren
id|OUTPUT_LAST_IMMEDIATE
op_or
(paren
id|packet-&gt;header_size
op_plus
l_int|4
)paren
)paren
suffix:semicolon
r_else
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|begin.control
op_assign
id|cpu_to_le32
c_func
(paren
id|OUTPUT_LAST_IMMEDIATE
op_or
id|packet-&gt;header_size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;branchAddrPtr
)paren
op_star
(paren
id|d-&gt;branchAddrPtr
)paren
op_assign
id|cpu_to_le32
c_func
(paren
id|d-&gt;prg_bus
(braket
id|idx
)braket
op_or
l_int|0x2
)paren
suffix:semicolon
id|d-&gt;branchAddrPtr
op_assign
op_amp
(paren
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|begin.branchAddress
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* iso packet */
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|data
(braket
l_int|0
)braket
op_assign
id|packet-&gt;speed_code
op_lshift
l_int|16
op_or
(paren
id|packet-&gt;header
(braket
l_int|0
)braket
op_amp
l_int|0xFFFF
)paren
suffix:semicolon
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|data
(braket
l_int|1
)braket
op_assign
id|packet-&gt;header
(braket
l_int|0
)braket
op_amp
l_int|0xFFFF0000
suffix:semicolon
id|packet_swab
c_func
(paren
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|data
comma
id|packet-&gt;tcode
comma
id|packet-&gt;header_size
op_rshift
l_int|2
comma
id|ohci-&gt;payload_swap
)paren
suffix:semicolon
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|begin.control
op_assign
id|cpu_to_le32
c_func
(paren
id|OUTPUT_MORE_IMMEDIATE
op_or
l_int|0x8
)paren
suffix:semicolon
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|end.control
op_assign
id|cpu_to_le32
c_func
(paren
id|OUTPUT_LAST
op_or
l_int|0x08000000
op_or
id|packet-&gt;data_size
)paren
suffix:semicolon
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|end.address
op_assign
id|cpu_to_le32
c_func
(paren
id|pci_map_single
c_func
(paren
id|ohci-&gt;dev
comma
id|packet-&gt;data
comma
id|packet-&gt;data_size
comma
id|PCI_DMA_TODEVICE
)paren
)paren
suffix:semicolon
id|OHCI_DMA_ALLOC
c_func
(paren
l_string|&quot;single, iso transmit packet&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ohci-&gt;payload_swap
)paren
id|block_swab32
c_func
(paren
id|packet-&gt;data
comma
id|packet-&gt;data_size
op_rshift
l_int|2
)paren
suffix:semicolon
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|end.branchAddress
op_assign
l_int|0
suffix:semicolon
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|end.status
op_assign
l_int|0
suffix:semicolon
id|DBGMSG
c_func
(paren
id|ohci-&gt;id
comma
l_string|&quot;iso xmit context info: header[%08x %08x]&bslash;n&quot;
l_string|&quot;                       begin=%08x %08x %08x %08x&bslash;n&quot;
l_string|&quot;                             %08x %08x %08x %08x&bslash;n&quot;
l_string|&quot;                       end  =%08x %08x %08x %08x&quot;
comma
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|data
(braket
l_int|0
)braket
comma
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|data
(braket
l_int|1
)braket
comma
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|begin.control
comma
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|begin.address
comma
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|begin.branchAddress
comma
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|begin.status
comma
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|data
(braket
l_int|0
)braket
comma
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|data
(braket
l_int|1
)braket
comma
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|data
(braket
l_int|2
)braket
comma
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|data
(braket
l_int|3
)braket
comma
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|end.control
comma
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|end.address
comma
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|end.branchAddress
comma
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|end.status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;branchAddrPtr
)paren
op_star
(paren
id|d-&gt;branchAddrPtr
)paren
op_assign
id|cpu_to_le32
c_func
(paren
id|d-&gt;prg_bus
(braket
id|idx
)braket
op_or
l_int|0x3
)paren
suffix:semicolon
id|d-&gt;branchAddrPtr
op_assign
op_amp
(paren
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|end.branchAddress
)paren
suffix:semicolon
)brace
id|d-&gt;free_prgs
op_decrement
suffix:semicolon
multiline_comment|/* queue the packet in the appropriate context queue */
r_if
c_cond
(paren
id|d-&gt;fifo_last
)paren
(brace
id|d-&gt;fifo_last-&gt;xnext
op_assign
id|packet
suffix:semicolon
id|d-&gt;fifo_last
op_assign
id|packet
suffix:semicolon
)brace
r_else
(brace
id|d-&gt;fifo_first
op_assign
id|packet
suffix:semicolon
id|d-&gt;fifo_last
op_assign
id|packet
suffix:semicolon
)brace
id|d-&gt;prg_ind
op_assign
(paren
id|d-&gt;prg_ind
op_plus
l_int|1
)paren
op_mod
id|d-&gt;num_desc
suffix:semicolon
)brace
multiline_comment|/*&n; * This function fills the AT FIFO with the (eventual) pending packets&n; * and runs or wakes up the AT DMA prg if necessary.&n; *&n; * The function MUST be called with the d-&gt;lock held.&n; */
DECL|function|dma_trm_flush
r_static
r_int
id|dma_trm_flush
c_func
(paren
r_struct
id|ti_ohci
op_star
id|ohci
comma
r_struct
id|dma_trm_ctx
op_star
id|d
)paren
(brace
r_int
id|idx
comma
id|z
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;pending_first
op_eq
l_int|NULL
op_logical_or
id|d-&gt;free_prgs
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
id|idx
op_assign
id|d-&gt;prg_ind
suffix:semicolon
id|z
op_assign
(paren
id|d-&gt;pending_first-&gt;data_size
)paren
ques
c_cond
l_int|3
suffix:colon
l_int|2
suffix:semicolon
multiline_comment|/* insert the packets into the at dma fifo */
r_while
c_loop
(paren
id|d-&gt;free_prgs
OG
l_int|0
op_logical_and
id|d-&gt;pending_first
)paren
(brace
id|insert_packet
c_func
(paren
id|ohci
comma
id|d
comma
id|d-&gt;pending_first
)paren
suffix:semicolon
id|d-&gt;pending_first
op_assign
id|d-&gt;pending_first-&gt;xnext
suffix:semicolon
)brace
r_if
c_cond
(paren
id|d-&gt;pending_first
op_eq
l_int|NULL
)paren
id|d-&gt;pending_last
op_assign
l_int|NULL
suffix:semicolon
r_else
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|ohci-&gt;id
comma
l_string|&quot;Transmit DMA FIFO ctx=%d is full... waiting&quot;
comma
id|d-&gt;ctx
)paren
suffix:semicolon
multiline_comment|/* Is the context running ? (should be unless it is &n;&t;   the first packet to be sent in this context) */
r_if
c_cond
(paren
op_logical_neg
(paren
id|reg_read
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlSet
)paren
op_amp
l_int|0x8000
)paren
)paren
(brace
id|DBGMSG
c_func
(paren
id|ohci-&gt;id
comma
l_string|&quot;Starting transmit DMA ctx=%d&quot;
comma
id|d-&gt;ctx
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|d-&gt;cmdPtr
comma
id|d-&gt;prg_bus
(braket
id|idx
)braket
op_or
id|z
)paren
suffix:semicolon
id|run_context
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlSet
comma
l_int|NULL
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Wake up the dma context if necessary */
r_if
c_cond
(paren
op_logical_neg
(paren
id|reg_read
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlSet
)paren
op_amp
l_int|0x400
)paren
)paren
(brace
id|DBGMSG
c_func
(paren
id|ohci-&gt;id
comma
l_string|&quot;Waking transmit DMA ctx=%d&quot;
comma
id|d-&gt;ctx
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlSet
comma
l_int|0x1000
)paren
suffix:semicolon
)brace
)brace
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Transmission of an async packet */
DECL|function|ohci_transmit
r_static
r_int
id|ohci_transmit
c_func
(paren
r_struct
id|hpsb_host
op_star
id|host
comma
r_struct
id|hpsb_packet
op_star
id|packet
)paren
(brace
r_struct
id|ti_ohci
op_star
id|ohci
op_assign
id|host-&gt;hostdata
suffix:semicolon
r_struct
id|dma_trm_ctx
op_star
id|d
suffix:semicolon
r_int
r_char
id|tcode
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|packet-&gt;data_size
OG
id|ohci-&gt;max_packet_size
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;Transmit packet size %Zd is too big&quot;
comma
id|packet-&gt;data_size
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|packet-&gt;xnext
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Decide wether we have an iso, a request, or a response packet */
id|tcode
op_assign
(paren
id|packet-&gt;header
(braket
l_int|0
)braket
op_rshift
l_int|4
)paren
op_amp
l_int|0xf
suffix:semicolon
r_if
c_cond
(paren
id|tcode
op_eq
id|TCODE_ISO_DATA
)paren
id|d
op_assign
id|ohci-&gt;it_context
suffix:semicolon
r_else
r_if
c_cond
(paren
id|tcode
op_amp
l_int|0x02
)paren
id|d
op_assign
id|ohci-&gt;at_resp_context
suffix:semicolon
r_else
id|d
op_assign
id|ohci-&gt;at_req_context
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|d-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* queue the packet for later insertion into the dma fifo */
r_if
c_cond
(paren
id|d-&gt;pending_last
)paren
(brace
id|d-&gt;pending_last-&gt;xnext
op_assign
id|packet
suffix:semicolon
id|d-&gt;pending_last
op_assign
id|packet
suffix:semicolon
)brace
r_else
(brace
id|d-&gt;pending_first
op_assign
id|packet
suffix:semicolon
id|d-&gt;pending_last
op_assign
id|packet
suffix:semicolon
)brace
id|dma_trm_flush
c_func
(paren
id|ohci
comma
id|d
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|d-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|ohci_devctl
r_static
r_int
id|ohci_devctl
c_func
(paren
r_struct
id|hpsb_host
op_star
id|host
comma
r_enum
id|devctl_cmd
id|cmd
comma
r_int
id|arg
)paren
(brace
r_struct
id|ti_ohci
op_star
id|ohci
op_assign
id|host-&gt;hostdata
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|RESET_BUS
suffix:colon
id|PRINT
(paren
id|KERN_DEBUG
comma
id|ohci-&gt;id
comma
l_string|&quot;Resetting bus on request%s&quot;
comma
(paren
(paren
id|host-&gt;attempt_root
op_logical_or
id|attempt_root
)paren
ques
c_cond
l_string|&quot; and attempting to become root&quot;
suffix:colon
l_string|&quot;&quot;
)paren
)paren
suffix:semicolon
id|set_phy_reg_mask
(paren
id|ohci
comma
l_int|1
comma
l_int|0x40
op_or
(paren
(paren
id|host-&gt;attempt_root
op_logical_or
id|attempt_root
)paren
ques
c_cond
l_int|0x80
suffix:colon
l_int|0
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|GET_CYCLE_COUNTER
suffix:colon
id|retval
op_assign
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_IsochronousCycleTimer
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SET_CYCLE_COUNTER
suffix:colon
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IsochronousCycleTimer
comma
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SET_BUS_ID
suffix:colon
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;devctl command SET_BUS_ID err&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACT_CYCLE_MASTER
suffix:colon
r_if
c_cond
(paren
id|arg
)paren
(brace
multiline_comment|/* check if we are root and other nodes are present */
id|u32
id|nodeId
op_assign
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_NodeID
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|nodeId
op_amp
(paren
l_int|1
op_lshift
l_int|30
)paren
)paren
op_logical_and
(paren
id|nodeId
op_amp
l_int|0x3f
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t;&t;&t; * enable cycleTimer, cycleMaster&n;&t;&t;&t;&t; */
id|DBGMSG
c_func
(paren
id|ohci-&gt;id
comma
l_string|&quot;Cycle master enabled&quot;
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_LinkControlSet
comma
l_int|0x00300000
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* disable cycleTimer, cycleMaster, cycleSource */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_LinkControlClear
comma
l_int|0x00700000
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|CANCEL_REQUESTS
suffix:colon
id|DBGMSG
c_func
(paren
id|ohci-&gt;id
comma
l_string|&quot;Cancel request received&quot;
)paren
suffix:semicolon
id|dma_trm_reset
c_func
(paren
id|ohci-&gt;at_req_context
)paren
suffix:semicolon
id|dma_trm_reset
c_func
(paren
id|ohci-&gt;at_resp_context
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MODIFY_USAGE
suffix:colon
r_if
c_cond
(paren
id|arg
)paren
(brace
id|MOD_INC_USE_COUNT
suffix:semicolon
)brace
r_else
(brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ISO_LISTEN_CHANNEL
suffix:colon
(brace
id|u64
id|mask
suffix:semicolon
r_if
c_cond
(paren
id|arg
l_int|63
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
id|__FUNCTION__
l_string|&quot;IS0 listne channel %d is out of range&quot;
comma
id|arg
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|mask
op_assign
(paren
id|u64
)paren
l_int|0x1
op_lshift
id|arg
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ohci-&gt;IR_channel_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ohci-&gt;ISO_channel_usage
op_amp
id|mask
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
id|__FUNCTION__
l_string|&quot;IS0 listen channel %d is already used&quot;
comma
id|arg
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ohci-&gt;IR_channel_lock
comma
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|ohci-&gt;ISO_channel_usage
op_or_assign
id|mask
suffix:semicolon
r_if
c_cond
(paren
id|arg
OG
l_int|31
)paren
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IRMultiChanMaskHiSet
comma
l_int|1
op_lshift
(paren
id|arg
op_minus
l_int|32
)paren
)paren
suffix:semicolon
r_else
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IRMultiChanMaskLoSet
comma
l_int|1
op_lshift
id|arg
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ohci-&gt;IR_channel_lock
comma
id|flags
)paren
suffix:semicolon
id|DBGMSG
c_func
(paren
id|ohci-&gt;id
comma
l_string|&quot;Listening enabled on channel %d&quot;
comma
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
id|ISO_UNLISTEN_CHANNEL
suffix:colon
(brace
id|u64
id|mask
suffix:semicolon
r_if
c_cond
(paren
id|arg
l_int|63
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
id|__FUNCTION__
l_string|&quot;IS0 unlisten channel %d is out of range&quot;
comma
id|arg
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|mask
op_assign
(paren
id|u64
)paren
l_int|0x1
op_lshift
id|arg
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ohci-&gt;IR_channel_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|ohci-&gt;ISO_channel_usage
op_amp
id|mask
)paren
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
id|__FUNCTION__
l_string|&quot;IS0 unlisten channel %d is not used&quot;
comma
id|arg
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ohci-&gt;IR_channel_lock
comma
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|ohci-&gt;ISO_channel_usage
op_and_assign
op_complement
id|mask
suffix:semicolon
r_if
c_cond
(paren
id|arg
OG
l_int|31
)paren
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IRMultiChanMaskHiClear
comma
l_int|1
op_lshift
(paren
id|arg
op_minus
l_int|32
)paren
)paren
suffix:semicolon
r_else
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IRMultiChanMaskLoClear
comma
l_int|1
op_lshift
id|arg
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ohci-&gt;IR_channel_lock
comma
id|flags
)paren
suffix:semicolon
id|DBGMSG
c_func
(paren
id|ohci-&gt;id
comma
l_string|&quot;Listening disabled on channel %d&quot;
comma
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_default
suffix:colon
id|PRINT_G
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;ohci_devctl cmd %d not implemented yet&quot;
comma
id|cmd
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/***************************************&n; * IEEE-1394 functionality section END *&n; ***************************************/
multiline_comment|/********************************************************&n; * Global stuff (interrupt handler, init/shutdown code) *&n; ********************************************************/
DECL|function|dma_trm_reset
r_static
r_void
id|dma_trm_reset
c_func
(paren
r_struct
id|dma_trm_ctx
op_star
id|d
)paren
(brace
r_struct
id|ti_ohci
op_star
id|ohci
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|hpsb_packet
op_star
id|nextpacket
suffix:semicolon
r_if
c_cond
(paren
id|d
op_eq
l_int|NULL
)paren
(brace
id|PRINT_G
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;dma_trm_reset called with NULL arg&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|ohci
op_assign
(paren
r_struct
id|ti_ohci
op_star
)paren
(paren
id|d-&gt;ohci
)paren
suffix:semicolon
id|ohci1394_stop_context
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlClear
comma
l_int|NULL
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|d-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Is there still any packet pending in the fifo ? */
r_while
c_loop
(paren
id|d-&gt;fifo_first
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|ohci-&gt;id
comma
l_string|&quot;AT dma reset ctx=%d, aborting transmission&quot;
comma
id|d-&gt;ctx
)paren
suffix:semicolon
id|nextpacket
op_assign
id|d-&gt;fifo_first-&gt;xnext
suffix:semicolon
id|hpsb_packet_sent
c_func
(paren
id|ohci-&gt;host
comma
id|d-&gt;fifo_first
comma
id|ACKX_ABORTED
)paren
suffix:semicolon
id|d-&gt;fifo_first
op_assign
id|nextpacket
suffix:semicolon
)brace
id|d-&gt;fifo_first
op_assign
id|d-&gt;fifo_last
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* is there still any packet pending ? */
r_while
c_loop
(paren
id|d-&gt;pending_first
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|ohci-&gt;id
comma
l_string|&quot;AT dma reset ctx=%d, aborting transmission&quot;
comma
id|d-&gt;ctx
)paren
suffix:semicolon
id|nextpacket
op_assign
id|d-&gt;pending_first-&gt;xnext
suffix:semicolon
id|hpsb_packet_sent
c_func
(paren
id|ohci-&gt;host
comma
id|d-&gt;pending_first
comma
id|ACKX_ABORTED
)paren
suffix:semicolon
id|d-&gt;pending_first
op_assign
id|nextpacket
suffix:semicolon
)brace
id|d-&gt;pending_first
op_assign
id|d-&gt;pending_last
op_assign
l_int|NULL
suffix:semicolon
id|d-&gt;branchAddrPtr
op_assign
l_int|NULL
suffix:semicolon
id|d-&gt;sent_ind
op_assign
id|d-&gt;prg_ind
suffix:semicolon
id|d-&gt;free_prgs
op_assign
id|d-&gt;num_desc
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|d-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|ohci_irq_handler
r_static
r_void
id|ohci_irq_handler
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs_are_unused
)paren
(brace
id|quadlet_t
id|event
comma
id|node_id
suffix:semicolon
r_struct
id|ti_ohci
op_star
id|ohci
op_assign
(paren
r_struct
id|ti_ohci
op_star
)paren
id|dev_id
suffix:semicolon
r_struct
id|hpsb_host
op_star
id|host
op_assign
id|ohci-&gt;host
suffix:semicolon
r_int
id|phyid
op_assign
op_minus
l_int|1
comma
id|isroot
op_assign
l_int|0
comma
id|flags
suffix:semicolon
multiline_comment|/* Read the interrupt event register */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ohci-&gt;event_lock
comma
id|flags
)paren
suffix:semicolon
id|event
op_assign
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_IntEventClear
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IntEventClear
comma
id|event
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ohci-&gt;event_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|event
)paren
r_return
suffix:semicolon
id|DBGMSG
c_func
(paren
id|ohci-&gt;id
comma
l_string|&quot;IntEvent: %08x&quot;
comma
id|event
)paren
suffix:semicolon
multiline_comment|/* Die right here an now */
r_if
c_cond
(paren
id|event
op_amp
id|OHCI1394_unrecoverableError
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;Unrecoverable error, shutting down card!&quot;
)paren
suffix:semicolon
id|remove_card
c_func
(paren
id|ohci
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Someone wants a bus reset. Better watch what you wish for...&n;&t; *&n;&t; * XXX: Read 6.1.1 of the OHCI1394 spec. We need to take special&n;&t; * care with the BusReset Interrupt, before and until the SelfID&n;&t; * phase is over. This is why the SelfID phase sometimes fails for&n;&t; * this driver.  */
r_if
c_cond
(paren
id|event
op_amp
id|OHCI1394_busReset
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|host-&gt;in_bus_reset
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_DEBUG
comma
id|ohci-&gt;id
comma
l_string|&quot;Bus reset requested&quot;
)paren
suffix:semicolon
multiline_comment|/* Wait for the AT fifo to be flushed */
id|dma_trm_reset
c_func
(paren
id|ohci-&gt;at_req_context
)paren
suffix:semicolon
id|dma_trm_reset
c_func
(paren
id|ohci-&gt;at_resp_context
)paren
suffix:semicolon
multiline_comment|/* Subsystem call */
id|hpsb_bus_reset
c_func
(paren
id|ohci-&gt;host
)paren
suffix:semicolon
id|ohci-&gt;NumBusResets
op_increment
suffix:semicolon
)brace
id|event
op_and_assign
op_complement
id|OHCI1394_busReset
suffix:semicolon
)brace
multiline_comment|/* XXX: We need a way to also queue the OHCI1394_reqTxComplete,&n;&t; * but for right now we simply run it upon reception, to make sure&n;&t; * we get sent acks before response packets. This sucks mainly&n;&t; * because it halts the interrupt handler.  */
r_if
c_cond
(paren
id|event
op_amp
id|OHCI1394_reqTxComplete
)paren
(brace
r_struct
id|dma_trm_ctx
op_star
id|d
op_assign
id|ohci-&gt;at_req_context
suffix:semicolon
id|DBGMSG
c_func
(paren
id|ohci-&gt;id
comma
l_string|&quot;Got reqTxComplete interrupt &quot;
l_string|&quot;status=0x%08X&quot;
comma
id|reg_read
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlSet
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|reg_read
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlSet
)paren
op_amp
l_int|0x800
)paren
id|ohci1394_stop_context
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlClear
comma
l_string|&quot;reqTxComplete&quot;
)paren
suffix:semicolon
r_else
id|dma_trm_tasklet
(paren
(paren
r_int
r_int
)paren
id|d
)paren
suffix:semicolon
id|event
op_and_assign
op_complement
id|OHCI1394_reqTxComplete
suffix:semicolon
)brace
r_if
c_cond
(paren
id|event
op_amp
id|OHCI1394_respTxComplete
)paren
(brace
r_struct
id|dma_trm_ctx
op_star
id|d
op_assign
id|ohci-&gt;at_resp_context
suffix:semicolon
id|DBGMSG
c_func
(paren
id|ohci-&gt;id
comma
l_string|&quot;Got respTxComplete interrupt &quot;
l_string|&quot;status=0x%08X&quot;
comma
id|reg_read
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlSet
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|reg_read
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlSet
)paren
op_amp
l_int|0x800
)paren
id|ohci1394_stop_context
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlClear
comma
l_string|&quot;respTxComplete&quot;
)paren
suffix:semicolon
r_else
id|tasklet_schedule
c_func
(paren
op_amp
id|d-&gt;task
)paren
suffix:semicolon
id|event
op_and_assign
op_complement
id|OHCI1394_respTxComplete
suffix:semicolon
)brace
r_if
c_cond
(paren
id|event
op_amp
id|OHCI1394_RQPkt
)paren
(brace
r_struct
id|dma_rcv_ctx
op_star
id|d
op_assign
id|ohci-&gt;ar_req_context
suffix:semicolon
id|DBGMSG
c_func
(paren
id|ohci-&gt;id
comma
l_string|&quot;Got RQPkt interrupt status=0x%08X&quot;
comma
id|reg_read
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlSet
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|reg_read
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlSet
)paren
op_amp
l_int|0x800
)paren
id|ohci1394_stop_context
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlClear
comma
l_string|&quot;RQPkt&quot;
)paren
suffix:semicolon
r_else
id|tasklet_schedule
c_func
(paren
op_amp
id|d-&gt;task
)paren
suffix:semicolon
id|event
op_and_assign
op_complement
id|OHCI1394_RQPkt
suffix:semicolon
)brace
r_if
c_cond
(paren
id|event
op_amp
id|OHCI1394_RSPkt
)paren
(brace
r_struct
id|dma_rcv_ctx
op_star
id|d
op_assign
id|ohci-&gt;ar_resp_context
suffix:semicolon
id|DBGMSG
c_func
(paren
id|ohci-&gt;id
comma
l_string|&quot;Got RSPkt interrupt status=0x%08X&quot;
comma
id|reg_read
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlSet
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|reg_read
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlSet
)paren
op_amp
l_int|0x800
)paren
id|ohci1394_stop_context
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlClear
comma
l_string|&quot;RSPkt&quot;
)paren
suffix:semicolon
r_else
id|tasklet_schedule
c_func
(paren
op_amp
id|d-&gt;task
)paren
suffix:semicolon
id|event
op_and_assign
op_complement
id|OHCI1394_RSPkt
suffix:semicolon
)brace
r_if
c_cond
(paren
id|event
op_amp
id|OHCI1394_isochRx
)paren
(brace
id|quadlet_t
id|isoRecvIntEvent
suffix:semicolon
r_struct
id|dma_rcv_ctx
op_star
id|d
op_assign
id|ohci-&gt;ir_context
suffix:semicolon
id|isoRecvIntEvent
op_assign
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_IsoRecvIntEventSet
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IsoRecvIntEventClear
comma
id|isoRecvIntEvent
)paren
suffix:semicolon
id|DBGMSG
c_func
(paren
id|ohci-&gt;id
comma
l_string|&quot;Got isochRx interrupt &quot;
l_string|&quot;status=0x%08X isoRecvIntEvent=%08x&quot;
comma
id|reg_read
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlSet
)paren
comma
id|isoRecvIntEvent
)paren
suffix:semicolon
r_if
c_cond
(paren
id|isoRecvIntEvent
op_amp
l_int|0x1
)paren
(brace
r_if
c_cond
(paren
id|reg_read
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlSet
)paren
op_amp
l_int|0x800
)paren
id|ohci1394_stop_context
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlClear
comma
l_string|&quot;isochRx&quot;
)paren
suffix:semicolon
r_else
id|tasklet_schedule
c_func
(paren
op_amp
id|d-&gt;task
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ohci-&gt;video_tmpl
)paren
id|ohci-&gt;video_tmpl
op_member_access_from_pointer
id|irq_handler
c_func
(paren
id|ohci-&gt;id
comma
id|isoRecvIntEvent
comma
l_int|0
)paren
suffix:semicolon
id|event
op_and_assign
op_complement
id|OHCI1394_isochRx
suffix:semicolon
)brace
r_if
c_cond
(paren
id|event
op_amp
id|OHCI1394_isochTx
)paren
(brace
id|quadlet_t
id|isoXmitIntEvent
suffix:semicolon
r_struct
id|dma_trm_ctx
op_star
id|d
op_assign
id|ohci-&gt;it_context
suffix:semicolon
id|isoXmitIntEvent
op_assign
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_IsoXmitIntEventSet
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IsoXmitIntEventClear
comma
id|isoXmitIntEvent
)paren
suffix:semicolon
id|DBGMSG
c_func
(paren
id|ohci-&gt;id
comma
l_string|&quot;Got isochTx interrupt &quot;
l_string|&quot;status=0x%08x isoXmitIntEvent=%08x&quot;
comma
id|reg_read
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlSet
)paren
comma
id|isoXmitIntEvent
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ohci-&gt;video_tmpl
)paren
id|ohci-&gt;video_tmpl
op_member_access_from_pointer
id|irq_handler
c_func
(paren
id|ohci-&gt;id
comma
l_int|0
comma
id|isoXmitIntEvent
)paren
suffix:semicolon
r_if
c_cond
(paren
id|isoXmitIntEvent
op_amp
l_int|0x1
)paren
(brace
r_if
c_cond
(paren
id|reg_read
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlSet
)paren
op_amp
l_int|0x800
)paren
id|ohci1394_stop_context
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlClear
comma
l_string|&quot;isochTx&quot;
)paren
suffix:semicolon
r_else
id|tasklet_schedule
c_func
(paren
op_amp
id|d-&gt;task
)paren
suffix:semicolon
)brace
id|event
op_and_assign
op_complement
id|OHCI1394_isochTx
suffix:semicolon
)brace
r_if
c_cond
(paren
id|event
op_amp
id|OHCI1394_selfIDComplete
)paren
(brace
r_if
c_cond
(paren
id|host-&gt;in_bus_reset
)paren
(brace
id|node_id
op_assign
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_NodeID
)paren
suffix:semicolon
multiline_comment|/* If our nodeid is not valid, give a msec delay&n;&t;&t;&t; * to let it settle in and try again.  */
r_if
c_cond
(paren
op_logical_neg
(paren
id|node_id
op_amp
l_int|0x80000000
)paren
)paren
(brace
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|node_id
op_assign
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_NodeID
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|node_id
op_amp
l_int|0x80000000
)paren
(brace
multiline_comment|/* NodeID valid */
id|phyid
op_assign
id|node_id
op_amp
l_int|0x0000003f
suffix:semicolon
id|isroot
op_assign
(paren
id|node_id
op_amp
l_int|0x40000000
)paren
op_ne
l_int|0
suffix:semicolon
id|PRINT
c_func
(paren
id|KERN_DEBUG
comma
id|ohci-&gt;id
comma
l_string|&quot;SelfID interrupt received &quot;
l_string|&quot;(phyid %d, %s)&quot;
comma
id|phyid
comma
(paren
id|isroot
ques
c_cond
l_string|&quot;root&quot;
suffix:colon
l_string|&quot;not root&quot;
)paren
)paren
suffix:semicolon
id|handle_selfid
c_func
(paren
id|ohci
comma
id|host
comma
id|phyid
comma
id|isroot
)paren
suffix:semicolon
)brace
r_else
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;SelfID interrupt received, but &quot;
l_string|&quot;NodeID is not valid: %08X&quot;
comma
id|node_id
)paren
suffix:semicolon
multiline_comment|/* Accept Physical requests from all nodes. */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_AsReqFilterHiSet
comma
l_int|0xffffffff
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_AsReqFilterLoSet
comma
l_int|0xffffffff
)paren
suffix:semicolon
multiline_comment|/* Turn on phys dma reception. We should&n;&t;&t;&t; * probably manage the filtering somehow, &n;&t;&t;&t; * instead of blindly turning it on.  */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_PhyReqFilterHiSet
comma
l_int|0xffffffff
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_PhyReqFilterLoSet
comma
l_int|0xffffffff
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_PhyUpperBound
comma
l_int|0xffff0000
)paren
suffix:semicolon
)brace
r_else
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;SelfID received outside of bus reset sequence&quot;
)paren
suffix:semicolon
id|event
op_and_assign
op_complement
id|OHCI1394_selfIDComplete
suffix:semicolon
)brace
r_if
c_cond
(paren
id|event
op_amp
id|OHCI1394_phyRegRcvd
)paren
(brace
r_if
c_cond
(paren
id|host-&gt;in_bus_reset
)paren
(brace
id|DBGMSG
(paren
id|ohci-&gt;id
comma
l_string|&quot;PhyControl: %08X&quot;
comma
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_PhyControl
)paren
)paren
suffix:semicolon
)brace
r_else
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;Physical register received outside of bus reset sequence&quot;
)paren
suffix:semicolon
id|event
op_and_assign
op_complement
id|OHCI1394_phyRegRcvd
suffix:semicolon
)brace
r_if
c_cond
(paren
id|event
)paren
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;Unhandled interrupt(s) 0x%08x&bslash;n&quot;
comma
id|event
)paren
suffix:semicolon
)brace
multiline_comment|/* Put the buffer back into the dma context */
DECL|function|insert_dma_buffer
r_static
r_void
id|insert_dma_buffer
c_func
(paren
r_struct
id|dma_rcv_ctx
op_star
id|d
comma
r_int
id|idx
)paren
(brace
r_struct
id|ti_ohci
op_star
id|ohci
op_assign
(paren
r_struct
id|ti_ohci
op_star
)paren
(paren
id|d-&gt;ohci
)paren
suffix:semicolon
id|DBGMSG
c_func
(paren
id|ohci-&gt;id
comma
l_string|&quot;Inserting dma buf ctx=%d idx=%d&quot;
comma
id|d-&gt;ctx
comma
id|idx
)paren
suffix:semicolon
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|status
op_assign
id|cpu_to_le32
c_func
(paren
id|d-&gt;buf_size
)paren
suffix:semicolon
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|branchAddress
op_and_assign
id|le32_to_cpu
c_func
(paren
l_int|0xfffffff0
)paren
suffix:semicolon
id|idx
op_assign
(paren
id|idx
op_plus
id|d-&gt;num_desc
op_minus
l_int|1
)paren
op_mod
id|d-&gt;num_desc
suffix:semicolon
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|branchAddress
op_or_assign
id|le32_to_cpu
c_func
(paren
l_int|0x00000001
)paren
suffix:semicolon
multiline_comment|/* wake up the dma context if necessary */
r_if
c_cond
(paren
op_logical_neg
(paren
id|reg_read
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlSet
)paren
op_amp
l_int|0x400
)paren
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|ohci-&gt;id
comma
l_string|&quot;Waking dma ctx=%d ... processing is probably too slow&quot;
comma
id|d-&gt;ctx
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlSet
comma
l_int|0x1000
)paren
suffix:semicolon
)brace
)brace
DECL|macro|cond_le32_to_cpu
mdefine_line|#define cond_le32_to_cpu(data, noswap) &bslash;&n;&t;(noswap ? data : le32_to_cpu(data))
DECL|variable|TCODE_SIZE
r_static
r_const
r_int
id|TCODE_SIZE
(braket
l_int|16
)braket
op_assign
(brace
l_int|20
comma
l_int|0
comma
l_int|16
comma
op_minus
l_int|1
comma
l_int|16
comma
l_int|20
comma
l_int|20
comma
l_int|0
comma
op_minus
l_int|1
comma
l_int|0
comma
op_minus
l_int|1
comma
l_int|0
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
l_int|16
comma
op_minus
l_int|1
)brace
suffix:semicolon
multiline_comment|/* &n; * Determine the length of a packet in the buffer&n; * Optimization suggested by Pascal Drolet &lt;pascal.drolet@informission.ca&gt;&n; */
DECL|function|packet_length
r_static
id|__inline__
r_int
id|packet_length
c_func
(paren
r_struct
id|dma_rcv_ctx
op_star
id|d
comma
r_int
id|idx
comma
id|quadlet_t
op_star
id|buf_ptr
comma
r_int
id|offset
comma
r_int
r_char
id|tcode
comma
r_int
id|noswap
)paren
(brace
r_int
id|length
op_assign
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;ctx
OL
l_int|2
)paren
(brace
multiline_comment|/* Async Receive Response/Request */
id|length
op_assign
id|TCODE_SIZE
(braket
id|tcode
)braket
suffix:semicolon
r_if
c_cond
(paren
id|length
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|offset
op_plus
l_int|12
op_ge
id|d-&gt;buf_size
)paren
(brace
id|length
op_assign
(paren
id|cond_le32_to_cpu
c_func
(paren
id|d-&gt;buf_cpu
(braket
(paren
id|idx
op_plus
l_int|1
)paren
op_mod
id|d-&gt;num_desc
)braket
(braket
l_int|3
op_minus
(paren
(paren
id|d-&gt;buf_size
op_minus
id|offset
)paren
op_rshift
l_int|2
)paren
)braket
comma
id|noswap
)paren
op_rshift
l_int|16
)paren
suffix:semicolon
)brace
r_else
(brace
id|length
op_assign
(paren
id|cond_le32_to_cpu
c_func
(paren
id|buf_ptr
(braket
l_int|3
)braket
comma
id|noswap
)paren
op_rshift
l_int|16
)paren
suffix:semicolon
)brace
id|length
op_add_assign
l_int|20
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|d-&gt;ctx
op_eq
l_int|2
)paren
(brace
multiline_comment|/* Iso receive */
multiline_comment|/* Assumption: buffer fill mode with header/trailer */
id|length
op_assign
(paren
id|cond_le32_to_cpu
c_func
(paren
id|buf_ptr
(braket
l_int|0
)braket
comma
id|noswap
)paren
op_rshift
l_int|16
)paren
op_plus
l_int|8
suffix:semicolon
)brace
r_if
c_cond
(paren
id|length
OG
l_int|0
op_logical_and
id|length
op_mod
l_int|4
)paren
id|length
op_add_assign
l_int|4
op_minus
(paren
id|length
op_mod
l_int|4
)paren
suffix:semicolon
r_return
id|length
suffix:semicolon
)brace
multiline_comment|/* Tasklet that processes dma receive buffers */
DECL|function|dma_rcv_tasklet
r_static
r_void
id|dma_rcv_tasklet
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|dma_rcv_ctx
op_star
id|d
op_assign
(paren
r_struct
id|dma_rcv_ctx
op_star
)paren
id|data
suffix:semicolon
r_struct
id|ti_ohci
op_star
id|ohci
op_assign
(paren
r_struct
id|ti_ohci
op_star
)paren
(paren
id|d-&gt;ohci
)paren
suffix:semicolon
r_int
r_int
id|split_left
comma
id|idx
comma
id|offset
comma
id|rescount
suffix:semicolon
r_int
r_char
id|tcode
suffix:semicolon
r_int
id|length
comma
id|bytes_left
comma
id|ack
comma
id|flags
suffix:semicolon
id|quadlet_t
op_star
id|buf_ptr
suffix:semicolon
r_char
op_star
id|split_ptr
suffix:semicolon
r_char
id|msg
(braket
l_int|256
)braket
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|d-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|idx
op_assign
id|d-&gt;buf_ind
suffix:semicolon
id|offset
op_assign
id|d-&gt;buf_offset
suffix:semicolon
id|buf_ptr
op_assign
id|d-&gt;buf_cpu
(braket
id|idx
)braket
op_plus
id|offset
op_div
l_int|4
suffix:semicolon
id|dma_cache_wback_inv
c_func
(paren
op_amp
(paren
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|status
)paren
comma
r_sizeof
(paren
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|status
)paren
)paren
suffix:semicolon
id|rescount
op_assign
id|le32_to_cpu
c_func
(paren
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|status
)paren
op_amp
l_int|0xffff
suffix:semicolon
id|bytes_left
op_assign
id|d-&gt;buf_size
op_minus
id|rescount
op_minus
id|offset
suffix:semicolon
id|dma_cache_wback_inv
c_func
(paren
id|buf_ptr
comma
id|bytes_left
)paren
suffix:semicolon
r_while
c_loop
(paren
id|bytes_left
OG
l_int|0
)paren
(brace
id|tcode
op_assign
(paren
id|cond_le32_to_cpu
c_func
(paren
id|buf_ptr
(braket
l_int|0
)braket
comma
id|ohci-&gt;payload_swap
)paren
op_rshift
l_int|4
)paren
op_amp
l_int|0xf
suffix:semicolon
multiline_comment|/* packet_length() will return &lt; 4 for an error */
id|length
op_assign
id|packet_length
c_func
(paren
id|d
comma
id|idx
comma
id|buf_ptr
comma
id|offset
comma
id|tcode
comma
id|ohci-&gt;payload_swap
)paren
suffix:semicolon
r_if
c_cond
(paren
id|length
OL
l_int|4
)paren
(brace
multiline_comment|/* something is wrong */
id|sprintf
c_func
(paren
id|msg
comma
l_string|&quot;Unexpected tcode 0x%x(0x%08x) in AR ctx=%d, length=%d&quot;
comma
id|tcode
comma
id|cond_le32_to_cpu
c_func
(paren
id|buf_ptr
(braket
l_int|0
)braket
comma
id|ohci-&gt;payload_swap
)paren
comma
id|d-&gt;ctx
comma
id|length
)paren
suffix:semicolon
id|ohci1394_stop_context
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlClear
comma
id|msg
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|d-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* The first case is where we have a packet that crosses&n;&t;&t; * over more than one descriptor. The next case is where&n;&t;&t; * it&squot;s all in the first descriptor.  */
r_if
c_cond
(paren
(paren
id|offset
op_plus
id|length
)paren
OG
id|d-&gt;buf_size
)paren
(brace
id|DBGMSG
c_func
(paren
id|ohci-&gt;id
comma
l_string|&quot;Split packet rcv&squot;d&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|length
OG
id|d-&gt;split_buf_size
)paren
(brace
id|ohci1394_stop_context
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlClear
comma
l_string|&quot;Split packet size exceeded&quot;
)paren
suffix:semicolon
id|d-&gt;buf_ind
op_assign
id|idx
suffix:semicolon
id|d-&gt;buf_offset
op_assign
id|offset
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|d-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#if 0
r_if
c_cond
(paren
id|le32_to_cpu
c_func
(paren
id|d-&gt;prg_cpu
(braket
(paren
id|idx
op_plus
l_int|1
)paren
op_mod
id|d-&gt;num_desc
)braket
op_member_access_from_pointer
id|status
)paren
op_eq
id|d-&gt;buf_size
)paren
(brace
multiline_comment|/* Other part of packet not written yet.&n;&t;&t;&t;&t; * this should never happen I think&n;&t;&t;&t;&t; * anyway we&squot;ll get it on the next call.  */
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|ohci-&gt;id
comma
l_string|&quot;Got only half a packet!&quot;
)paren
suffix:semicolon
id|d-&gt;buf_ind
op_assign
id|idx
suffix:semicolon
id|d-&gt;buf_offset
op_assign
id|offset
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|d-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#endif
id|split_left
op_assign
id|length
suffix:semicolon
id|split_ptr
op_assign
(paren
r_char
op_star
)paren
id|d-&gt;spb
suffix:semicolon
id|memcpy
c_func
(paren
id|split_ptr
comma
id|buf_ptr
comma
id|d-&gt;buf_size
op_minus
id|offset
)paren
suffix:semicolon
id|split_left
op_sub_assign
id|d-&gt;buf_size
op_minus
id|offset
suffix:semicolon
id|split_ptr
op_add_assign
id|d-&gt;buf_size
op_minus
id|offset
suffix:semicolon
id|insert_dma_buffer
c_func
(paren
id|d
comma
id|idx
)paren
suffix:semicolon
id|idx
op_assign
(paren
id|idx
op_plus
l_int|1
)paren
op_mod
id|d-&gt;num_desc
suffix:semicolon
id|buf_ptr
op_assign
id|d-&gt;buf_cpu
(braket
id|idx
)braket
suffix:semicolon
id|dma_cache_wback_inv
c_func
(paren
id|buf_ptr
comma
id|d-&gt;buf_size
)paren
suffix:semicolon
id|offset
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|split_left
op_ge
id|d-&gt;buf_size
)paren
(brace
id|memcpy
c_func
(paren
id|split_ptr
comma
id|buf_ptr
comma
id|d-&gt;buf_size
)paren
suffix:semicolon
id|split_ptr
op_add_assign
id|d-&gt;buf_size
suffix:semicolon
id|split_left
op_sub_assign
id|d-&gt;buf_size
suffix:semicolon
id|insert_dma_buffer
c_func
(paren
id|d
comma
id|idx
)paren
suffix:semicolon
id|idx
op_assign
(paren
id|idx
op_plus
l_int|1
)paren
op_mod
id|d-&gt;num_desc
suffix:semicolon
id|buf_ptr
op_assign
id|d-&gt;buf_cpu
(braket
id|idx
)braket
suffix:semicolon
id|dma_cache_wback_inv
c_func
(paren
id|buf_ptr
comma
id|d-&gt;buf_size
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|split_left
OG
l_int|0
)paren
(brace
id|memcpy
c_func
(paren
id|split_ptr
comma
id|buf_ptr
comma
id|split_left
)paren
suffix:semicolon
id|offset
op_assign
id|split_left
suffix:semicolon
id|buf_ptr
op_add_assign
id|offset
op_div
l_int|4
suffix:semicolon
)brace
)brace
r_else
(brace
id|DBGMSG
c_func
(paren
id|ohci-&gt;id
comma
l_string|&quot;Single packet rcv&squot;d&bslash;n&quot;
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|d-&gt;spb
comma
id|buf_ptr
comma
id|length
)paren
suffix:semicolon
id|offset
op_add_assign
id|length
suffix:semicolon
id|buf_ptr
op_add_assign
id|length
op_div
l_int|4
suffix:semicolon
r_if
c_cond
(paren
id|offset
op_eq
id|d-&gt;buf_size
)paren
(brace
id|insert_dma_buffer
c_func
(paren
id|d
comma
id|idx
)paren
suffix:semicolon
id|idx
op_assign
(paren
id|idx
op_plus
l_int|1
)paren
op_mod
id|d-&gt;num_desc
suffix:semicolon
id|buf_ptr
op_assign
id|d-&gt;buf_cpu
(braket
id|idx
)braket
suffix:semicolon
id|offset
op_assign
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/* We get one phy packet to the async descriptor for each&n;&t;&t; * bus reset. We always ignore it.  */
r_if
c_cond
(paren
id|tcode
op_ne
id|OHCI1394_TCODE_PHY
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ohci-&gt;payload_swap
)paren
id|packet_swab
c_func
(paren
id|d-&gt;spb
comma
id|tcode
comma
(paren
id|length
op_minus
l_int|4
)paren
op_rshift
l_int|2
comma
l_int|0
)paren
suffix:semicolon
id|DBGMSG
c_func
(paren
id|ohci-&gt;id
comma
l_string|&quot;Packet received from node&quot;
l_string|&quot; %d ack=0x%02X spd=%d tcode=0x%X&quot;
l_string|&quot; length=%d ctx=%d tlabel=%d&quot;
comma
(paren
id|d-&gt;spb
(braket
l_int|1
)braket
op_rshift
l_int|16
)paren
op_amp
l_int|0x3f
comma
(paren
id|cond_le32_to_cpu
c_func
(paren
id|d-&gt;spb
(braket
id|length
op_div
l_int|4
op_minus
l_int|1
)braket
comma
id|ohci-&gt;payload_swap
)paren
op_rshift
l_int|16
)paren
op_amp
l_int|0x1f
comma
(paren
id|cond_le32_to_cpu
c_func
(paren
id|d-&gt;spb
(braket
id|length
op_div
l_int|4
op_minus
l_int|1
)braket
comma
id|ohci-&gt;payload_swap
)paren
op_rshift
l_int|21
)paren
op_amp
l_int|0x3
comma
id|tcode
comma
id|length
comma
id|d-&gt;ctx
comma
(paren
id|cond_le32_to_cpu
c_func
(paren
id|d-&gt;spb
(braket
id|length
op_div
l_int|4
op_minus
l_int|1
)braket
comma
id|ohci-&gt;payload_swap
)paren
op_rshift
l_int|10
)paren
op_amp
l_int|0x3f
)paren
suffix:semicolon
id|ack
op_assign
(paren
(paren
(paren
id|cond_le32_to_cpu
c_func
(paren
id|d-&gt;spb
(braket
id|length
op_div
l_int|4
op_minus
l_int|1
)braket
comma
id|ohci-&gt;payload_swap
)paren
op_rshift
l_int|16
)paren
op_amp
l_int|0x1f
)paren
op_eq
l_int|0x11
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|hpsb_packet_received
c_func
(paren
id|ohci-&gt;host
comma
id|d-&gt;spb
comma
id|length
op_minus
l_int|4
comma
id|ack
)paren
suffix:semicolon
)brace
macro_line|#if OHCI1394_DEBUG
r_else
id|PRINT
(paren
id|KERN_DEBUG
comma
id|ohci-&gt;id
comma
l_string|&quot;Got phy packet ctx=%d ... discarded&quot;
comma
id|d-&gt;ctx
)paren
suffix:semicolon
macro_line|#endif
id|dma_cache_wback_inv
c_func
(paren
op_amp
(paren
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|status
)paren
comma
r_sizeof
(paren
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|status
)paren
)paren
suffix:semicolon
id|rescount
op_assign
id|le32_to_cpu
c_func
(paren
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|status
)paren
op_amp
l_int|0xffff
suffix:semicolon
id|bytes_left
op_assign
id|d-&gt;buf_size
op_minus
id|rescount
op_minus
id|offset
suffix:semicolon
)brace
id|d-&gt;buf_ind
op_assign
id|idx
suffix:semicolon
id|d-&gt;buf_offset
op_assign
id|offset
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|d-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* Bottom half that processes sent packets */
DECL|function|dma_trm_tasklet
r_static
r_void
id|dma_trm_tasklet
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|dma_trm_ctx
op_star
id|d
op_assign
(paren
r_struct
id|dma_trm_ctx
op_star
)paren
id|data
suffix:semicolon
r_struct
id|ti_ohci
op_star
id|ohci
op_assign
(paren
r_struct
id|ti_ohci
op_star
)paren
(paren
id|d-&gt;ohci
)paren
suffix:semicolon
r_struct
id|hpsb_packet
op_star
id|packet
comma
op_star
id|nextpacket
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|u32
id|ack
suffix:semicolon
r_int
id|datasize
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|d-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;fifo_first
op_eq
l_int|NULL
)paren
(brace
macro_line|#if 0
id|ohci1394_stop_context
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlClear
comma
l_string|&quot;Packet sent ack received but queue is empty&quot;
)paren
suffix:semicolon
macro_line|#endif
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|d-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_while
c_loop
(paren
id|d-&gt;fifo_first
)paren
(brace
id|packet
op_assign
id|d-&gt;fifo_first
suffix:semicolon
id|datasize
op_assign
id|d-&gt;fifo_first-&gt;data_size
suffix:semicolon
r_if
c_cond
(paren
id|datasize
op_logical_and
id|packet-&gt;type
op_ne
id|raw
)paren
id|ack
op_assign
id|le32_to_cpu
c_func
(paren
id|d-&gt;prg_cpu
(braket
id|d-&gt;sent_ind
)braket
op_member_access_from_pointer
id|end.status
)paren
op_rshift
l_int|16
suffix:semicolon
r_else
id|ack
op_assign
id|le32_to_cpu
c_func
(paren
id|d-&gt;prg_cpu
(braket
id|d-&gt;sent_ind
)braket
op_member_access_from_pointer
id|begin.status
)paren
op_rshift
l_int|16
suffix:semicolon
r_if
c_cond
(paren
id|ack
op_eq
l_int|0
)paren
multiline_comment|/* this packet hasn&squot;t been sent yet*/
r_break
suffix:semicolon
macro_line|#ifdef OHCI1394_DEBUG
r_if
c_cond
(paren
id|datasize
)paren
id|DBGMSG
c_func
(paren
id|ohci-&gt;id
comma
l_string|&quot;Packet sent to node %d tcode=0x%X tLabel=&quot;
l_string|&quot;0x%02X ack=0x%X spd=%d dataLength=%d ctx=%d&quot;
comma
(paren
id|le32_to_cpu
c_func
(paren
id|d-&gt;prg_cpu
(braket
id|d-&gt;sent_ind
)braket
op_member_access_from_pointer
id|data
(braket
l_int|1
)braket
)paren
op_rshift
l_int|16
)paren
op_amp
l_int|0x3f
comma
(paren
id|le32_to_cpu
c_func
(paren
id|d-&gt;prg_cpu
(braket
id|d-&gt;sent_ind
)braket
op_member_access_from_pointer
id|data
(braket
l_int|0
)braket
)paren
op_rshift
l_int|4
)paren
op_amp
l_int|0xf
comma
(paren
id|le32_to_cpu
c_func
(paren
id|d-&gt;prg_cpu
(braket
id|d-&gt;sent_ind
)braket
op_member_access_from_pointer
id|data
(braket
l_int|0
)braket
)paren
op_rshift
l_int|10
)paren
op_amp
l_int|0x3f
comma
id|ack
op_amp
l_int|0x1f
comma
(paren
id|ack
op_rshift
l_int|5
)paren
op_amp
l_int|0x3
comma
id|le32_to_cpu
c_func
(paren
id|d-&gt;prg_cpu
(braket
id|d-&gt;sent_ind
)braket
op_member_access_from_pointer
id|data
(braket
l_int|3
)braket
)paren
op_rshift
l_int|16
comma
id|d-&gt;ctx
)paren
suffix:semicolon
r_else
id|DBGMSG
c_func
(paren
id|ohci-&gt;id
comma
l_string|&quot;Packet sent to node %d tcode=0x%X tLabel=&quot;
l_string|&quot;0x%02X ack=0x%X spd=%d data=0x%08X ctx=%d&quot;
comma
(paren
id|le32_to_cpu
c_func
(paren
id|d-&gt;prg_cpu
(braket
id|d-&gt;sent_ind
)braket
op_member_access_from_pointer
id|data
(braket
l_int|1
)braket
)paren
op_rshift
l_int|16
)paren
op_amp
l_int|0x3f
comma
(paren
id|le32_to_cpu
c_func
(paren
id|d-&gt;prg_cpu
(braket
id|d-&gt;sent_ind
)braket
op_member_access_from_pointer
id|data
(braket
l_int|0
)braket
)paren
op_rshift
l_int|4
)paren
op_amp
l_int|0xf
comma
(paren
id|le32_to_cpu
c_func
(paren
id|d-&gt;prg_cpu
(braket
id|d-&gt;sent_ind
)braket
op_member_access_from_pointer
id|data
(braket
l_int|0
)braket
)paren
op_rshift
l_int|10
)paren
op_amp
l_int|0x3f
comma
id|ack
op_amp
l_int|0x1f
comma
(paren
id|ack
op_rshift
l_int|5
)paren
op_amp
l_int|0x3
comma
id|le32_to_cpu
c_func
(paren
id|d-&gt;prg_cpu
(braket
id|d-&gt;sent_ind
)braket
op_member_access_from_pointer
id|data
(braket
l_int|3
)braket
)paren
comma
id|d-&gt;ctx
)paren
suffix:semicolon
macro_line|#endif&t;&t;
id|nextpacket
op_assign
id|packet-&gt;xnext
suffix:semicolon
id|hpsb_packet_sent
c_func
(paren
id|ohci-&gt;host
comma
id|packet
comma
id|ack
op_amp
l_int|0xf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|datasize
)paren
(brace
id|pci_unmap_single
c_func
(paren
id|ohci-&gt;dev
comma
id|cpu_to_le32
c_func
(paren
id|d-&gt;prg_cpu
(braket
id|d-&gt;sent_ind
)braket
op_member_access_from_pointer
id|end.address
)paren
comma
id|datasize
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
id|OHCI_DMA_FREE
c_func
(paren
l_string|&quot;single Xmit data packet&quot;
)paren
suffix:semicolon
)brace
id|d-&gt;sent_ind
op_assign
(paren
id|d-&gt;sent_ind
op_plus
l_int|1
)paren
op_mod
id|d-&gt;num_desc
suffix:semicolon
id|d-&gt;free_prgs
op_increment
suffix:semicolon
id|d-&gt;fifo_first
op_assign
id|nextpacket
suffix:semicolon
)brace
r_if
c_cond
(paren
id|d-&gt;fifo_first
op_eq
l_int|NULL
)paren
id|d-&gt;fifo_last
op_assign
l_int|NULL
suffix:semicolon
id|dma_trm_flush
c_func
(paren
id|ohci
comma
id|d
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|d-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|free_dma_rcv_ctx
r_static
r_int
id|free_dma_rcv_ctx
c_func
(paren
r_struct
id|dma_rcv_ctx
op_star
op_star
id|d
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|ti_ohci
op_star
id|ohci
suffix:semicolon
r_if
c_cond
(paren
op_star
id|d
op_eq
l_int|NULL
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|ohci
op_assign
(paren
r_struct
id|ti_ohci
op_star
)paren
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|ohci
suffix:semicolon
id|DBGMSG
c_func
(paren
id|ohci-&gt;id
comma
l_string|&quot;Freeing dma_rcv_ctx %d&quot;
comma
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|ctx
)paren
suffix:semicolon
id|ohci1394_stop_context
c_func
(paren
id|ohci
comma
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|ctrlClear
comma
l_int|NULL
)paren
suffix:semicolon
id|tasklet_kill
c_func
(paren
op_amp
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|task
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|buf_cpu
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|num_desc
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|buf_cpu
(braket
id|i
)braket
op_logical_and
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|buf_bus
(braket
id|i
)braket
)paren
(brace
id|pci_free_consistent
c_func
(paren
id|ohci-&gt;dev
comma
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|buf_size
comma
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|buf_cpu
(braket
id|i
)braket
comma
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|buf_bus
(braket
id|i
)braket
)paren
suffix:semicolon
id|OHCI_DMA_FREE
c_func
(paren
l_string|&quot;consistent dma_rcv buf[%d]&quot;
comma
id|i
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|buf_cpu
)paren
suffix:semicolon
id|kfree
c_func
(paren
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|buf_bus
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|prg_cpu
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|num_desc
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|prg_cpu
(braket
id|i
)braket
op_logical_and
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|prg_bus
(braket
id|i
)braket
)paren
(brace
id|pci_free_consistent
c_func
(paren
id|ohci-&gt;dev
comma
r_sizeof
(paren
r_struct
id|dma_cmd
)paren
comma
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|prg_cpu
(braket
id|i
)braket
comma
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|prg_bus
(braket
id|i
)braket
)paren
suffix:semicolon
id|OHCI_DMA_FREE
c_func
(paren
l_string|&quot;consistent dma_rcv prg[%d]&quot;
comma
id|i
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|prg_cpu
)paren
suffix:semicolon
id|kfree
c_func
(paren
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|prg_bus
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|spb
)paren
id|kfree
c_func
(paren
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|spb
)paren
suffix:semicolon
id|kfree
c_func
(paren
op_star
id|d
)paren
suffix:semicolon
op_star
id|d
op_assign
l_int|NULL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_struct
id|dma_rcv_ctx
op_star
DECL|function|alloc_dma_rcv_ctx
id|alloc_dma_rcv_ctx
c_func
(paren
r_struct
id|ti_ohci
op_star
id|ohci
comma
r_int
id|ctx
comma
r_int
id|num_desc
comma
r_int
id|buf_size
comma
r_int
id|split_buf_size
comma
r_int
id|ctrlSet
comma
r_int
id|ctrlClear
comma
r_int
id|cmdPtr
)paren
(brace
r_struct
id|dma_rcv_ctx
op_star
id|d
op_assign
l_int|NULL
suffix:semicolon
r_int
id|i
suffix:semicolon
id|d
op_assign
(paren
r_struct
id|dma_rcv_ctx
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|dma_rcv_ctx
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|d
op_eq
l_int|NULL
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;Failed to allocate dma_rcv_ctx&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|memset
(paren
id|d
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|dma_rcv_ctx
)paren
)paren
suffix:semicolon
id|d-&gt;ohci
op_assign
(paren
r_void
op_star
)paren
id|ohci
suffix:semicolon
id|d-&gt;ctx
op_assign
id|ctx
suffix:semicolon
id|d-&gt;num_desc
op_assign
id|num_desc
suffix:semicolon
id|d-&gt;buf_size
op_assign
id|buf_size
suffix:semicolon
id|d-&gt;split_buf_size
op_assign
id|split_buf_size
suffix:semicolon
id|d-&gt;ctrlSet
op_assign
id|ctrlSet
suffix:semicolon
id|d-&gt;ctrlClear
op_assign
id|ctrlClear
suffix:semicolon
id|d-&gt;cmdPtr
op_assign
id|cmdPtr
suffix:semicolon
id|d-&gt;buf_cpu
op_assign
l_int|NULL
suffix:semicolon
id|d-&gt;buf_bus
op_assign
l_int|NULL
suffix:semicolon
id|d-&gt;prg_cpu
op_assign
l_int|NULL
suffix:semicolon
id|d-&gt;prg_bus
op_assign
l_int|NULL
suffix:semicolon
id|d-&gt;spb
op_assign
l_int|NULL
suffix:semicolon
id|d-&gt;buf_cpu
op_assign
id|kmalloc
c_func
(paren
id|d-&gt;num_desc
op_star
r_sizeof
(paren
id|quadlet_t
op_star
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|d-&gt;buf_bus
op_assign
id|kmalloc
c_func
(paren
id|d-&gt;num_desc
op_star
r_sizeof
(paren
id|dma_addr_t
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;buf_cpu
op_eq
l_int|NULL
op_logical_or
id|d-&gt;buf_bus
op_eq
l_int|NULL
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;Failed to allocate dma buffer&quot;
)paren
suffix:semicolon
id|free_dma_rcv_ctx
c_func
(paren
op_amp
id|d
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|memset
c_func
(paren
id|d-&gt;buf_cpu
comma
l_int|0
comma
id|d-&gt;num_desc
op_star
r_sizeof
(paren
id|quadlet_t
op_star
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
id|d-&gt;buf_bus
comma
l_int|0
comma
id|d-&gt;num_desc
op_star
r_sizeof
(paren
id|dma_addr_t
)paren
)paren
suffix:semicolon
id|d-&gt;prg_cpu
op_assign
id|kmalloc
c_func
(paren
id|d-&gt;num_desc
op_star
r_sizeof
(paren
r_struct
id|dma_cmd
op_star
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|d-&gt;prg_bus
op_assign
id|kmalloc
c_func
(paren
id|d-&gt;num_desc
op_star
r_sizeof
(paren
id|dma_addr_t
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;prg_cpu
op_eq
l_int|NULL
op_logical_or
id|d-&gt;prg_bus
op_eq
l_int|NULL
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;Failed to allocate dma prg&quot;
)paren
suffix:semicolon
id|free_dma_rcv_ctx
c_func
(paren
op_amp
id|d
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|memset
c_func
(paren
id|d-&gt;prg_cpu
comma
l_int|0
comma
id|d-&gt;num_desc
op_star
r_sizeof
(paren
r_struct
id|dma_cmd
op_star
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
id|d-&gt;prg_bus
comma
l_int|0
comma
id|d-&gt;num_desc
op_star
r_sizeof
(paren
id|dma_addr_t
)paren
)paren
suffix:semicolon
id|d-&gt;spb
op_assign
id|kmalloc
c_func
(paren
id|d-&gt;split_buf_size
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;spb
op_eq
l_int|NULL
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;Failed to allocate split buffer&quot;
)paren
suffix:semicolon
id|free_dma_rcv_ctx
c_func
(paren
op_amp
id|d
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|d-&gt;num_desc
suffix:semicolon
id|i
op_increment
)paren
(brace
id|d-&gt;buf_cpu
(braket
id|i
)braket
op_assign
id|pci_alloc_consistent
c_func
(paren
id|ohci-&gt;dev
comma
id|d-&gt;buf_size
comma
id|d-&gt;buf_bus
op_plus
id|i
)paren
suffix:semicolon
id|OHCI_DMA_ALLOC
c_func
(paren
l_string|&quot;consistent dma_rcv buf[%d]&quot;
comma
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;buf_cpu
(braket
id|i
)braket
op_ne
l_int|NULL
)paren
(brace
id|memset
c_func
(paren
id|d-&gt;buf_cpu
(braket
id|i
)braket
comma
l_int|0
comma
id|d-&gt;buf_size
)paren
suffix:semicolon
)brace
r_else
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;Failed to allocate dma buffer&quot;
)paren
suffix:semicolon
id|free_dma_rcv_ctx
c_func
(paren
op_amp
id|d
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|d-&gt;prg_cpu
(braket
id|i
)braket
op_assign
id|pci_alloc_consistent
c_func
(paren
id|ohci-&gt;dev
comma
r_sizeof
(paren
r_struct
id|dma_cmd
)paren
comma
id|d-&gt;prg_bus
op_plus
id|i
)paren
suffix:semicolon
id|OHCI_DMA_ALLOC
c_func
(paren
l_string|&quot;consistent dma_rcv prg[%d]&quot;
comma
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;prg_cpu
(braket
id|i
)braket
op_ne
l_int|NULL
)paren
(brace
id|memset
c_func
(paren
id|d-&gt;prg_cpu
(braket
id|i
)braket
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|dma_cmd
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;Failed to allocate dma prg&quot;
)paren
suffix:semicolon
id|free_dma_rcv_ctx
c_func
(paren
op_amp
id|d
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
)brace
id|spin_lock_init
c_func
(paren
op_amp
id|d-&gt;lock
)paren
suffix:semicolon
multiline_comment|/* initialize tasklet */
id|tasklet_init
(paren
op_amp
id|d-&gt;task
comma
id|dma_rcv_tasklet
comma
(paren
r_int
r_int
)paren
id|d
)paren
suffix:semicolon
r_return
id|d
suffix:semicolon
)brace
DECL|function|free_dma_trm_ctx
r_static
r_int
id|free_dma_trm_ctx
c_func
(paren
r_struct
id|dma_trm_ctx
op_star
op_star
id|d
)paren
(brace
r_struct
id|ti_ohci
op_star
id|ohci
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
op_star
id|d
op_eq
l_int|NULL
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|ohci
op_assign
(paren
r_struct
id|ti_ohci
op_star
)paren
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|ohci
suffix:semicolon
id|DBGMSG
c_func
(paren
id|ohci-&gt;id
comma
l_string|&quot;Freeing dma_trm_ctx %d&quot;
comma
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|ctx
)paren
suffix:semicolon
id|ohci1394_stop_context
c_func
(paren
id|ohci
comma
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|ctrlClear
comma
l_int|NULL
)paren
suffix:semicolon
id|tasklet_kill
c_func
(paren
op_amp
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|task
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|prg_cpu
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|num_desc
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|prg_cpu
(braket
id|i
)braket
op_logical_and
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|prg_bus
(braket
id|i
)braket
)paren
(brace
id|pci_free_consistent
c_func
(paren
id|ohci-&gt;dev
comma
r_sizeof
(paren
r_struct
id|at_dma_prg
)paren
comma
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|prg_cpu
(braket
id|i
)braket
comma
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|prg_bus
(braket
id|i
)braket
)paren
suffix:semicolon
id|OHCI_DMA_FREE
c_func
(paren
l_string|&quot;consistent dma_trm prg[%d]&quot;
comma
id|i
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|prg_cpu
)paren
suffix:semicolon
id|kfree
c_func
(paren
(paren
op_star
id|d
)paren
op_member_access_from_pointer
id|prg_bus
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
op_star
id|d
)paren
suffix:semicolon
op_star
id|d
op_assign
l_int|NULL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_struct
id|dma_trm_ctx
op_star
DECL|function|alloc_dma_trm_ctx
id|alloc_dma_trm_ctx
c_func
(paren
r_struct
id|ti_ohci
op_star
id|ohci
comma
r_int
id|ctx
comma
r_int
id|num_desc
comma
r_int
id|ctrlSet
comma
r_int
id|ctrlClear
comma
r_int
id|cmdPtr
)paren
(brace
r_struct
id|dma_trm_ctx
op_star
id|d
op_assign
l_int|NULL
suffix:semicolon
r_int
id|i
suffix:semicolon
id|d
op_assign
(paren
r_struct
id|dma_trm_ctx
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|dma_trm_ctx
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|d
op_eq
l_int|NULL
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;Failed to allocate dma_trm_ctx&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|memset
(paren
id|d
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|dma_trm_ctx
)paren
)paren
suffix:semicolon
id|d-&gt;ohci
op_assign
(paren
r_void
op_star
)paren
id|ohci
suffix:semicolon
id|d-&gt;ctx
op_assign
id|ctx
suffix:semicolon
id|d-&gt;num_desc
op_assign
id|num_desc
suffix:semicolon
id|d-&gt;ctrlSet
op_assign
id|ctrlSet
suffix:semicolon
id|d-&gt;ctrlClear
op_assign
id|ctrlClear
suffix:semicolon
id|d-&gt;cmdPtr
op_assign
id|cmdPtr
suffix:semicolon
id|d-&gt;prg_cpu
op_assign
l_int|NULL
suffix:semicolon
id|d-&gt;prg_bus
op_assign
l_int|NULL
suffix:semicolon
id|d-&gt;prg_cpu
op_assign
id|kmalloc
c_func
(paren
id|d-&gt;num_desc
op_star
r_sizeof
(paren
r_struct
id|at_dma_prg
op_star
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|d-&gt;prg_bus
op_assign
id|kmalloc
c_func
(paren
id|d-&gt;num_desc
op_star
r_sizeof
(paren
id|dma_addr_t
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;prg_cpu
op_eq
l_int|NULL
op_logical_or
id|d-&gt;prg_bus
op_eq
l_int|NULL
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;Failed to allocate at dma prg&quot;
)paren
suffix:semicolon
id|free_dma_trm_ctx
c_func
(paren
op_amp
id|d
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|memset
c_func
(paren
id|d-&gt;prg_cpu
comma
l_int|0
comma
id|d-&gt;num_desc
op_star
r_sizeof
(paren
r_struct
id|at_dma_prg
op_star
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
id|d-&gt;prg_bus
comma
l_int|0
comma
id|d-&gt;num_desc
op_star
r_sizeof
(paren
id|dma_addr_t
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|d-&gt;num_desc
suffix:semicolon
id|i
op_increment
)paren
(brace
id|d-&gt;prg_cpu
(braket
id|i
)braket
op_assign
id|pci_alloc_consistent
c_func
(paren
id|ohci-&gt;dev
comma
r_sizeof
(paren
r_struct
id|at_dma_prg
)paren
comma
id|d-&gt;prg_bus
op_plus
id|i
)paren
suffix:semicolon
id|OHCI_DMA_ALLOC
c_func
(paren
l_string|&quot;consistent dma_trm prg[%d]&quot;
comma
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;prg_cpu
(braket
id|i
)braket
op_ne
l_int|NULL
)paren
(brace
id|memset
c_func
(paren
id|d-&gt;prg_cpu
(braket
id|i
)braket
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|at_dma_prg
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;Failed to allocate at dma prg&quot;
)paren
suffix:semicolon
id|free_dma_trm_ctx
c_func
(paren
op_amp
id|d
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
)brace
id|spin_lock_init
c_func
(paren
op_amp
id|d-&gt;lock
)paren
suffix:semicolon
multiline_comment|/* initialize bottom handler */
id|tasklet_init
(paren
op_amp
id|d-&gt;task
comma
id|dma_trm_tasklet
comma
(paren
r_int
r_int
)paren
id|d
)paren
suffix:semicolon
r_return
id|d
suffix:semicolon
)brace
DECL|function|ohci_crc16
r_static
id|u16
id|ohci_crc16
(paren
id|u32
op_star
id|ptr
comma
r_int
id|length
)paren
(brace
r_int
id|shift
suffix:semicolon
id|u32
id|crc
comma
id|sum
comma
id|data
suffix:semicolon
id|crc
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|length
OG
l_int|0
suffix:semicolon
id|length
op_decrement
)paren
(brace
id|data
op_assign
op_star
id|ptr
op_increment
suffix:semicolon
r_for
c_loop
(paren
id|shift
op_assign
l_int|28
suffix:semicolon
id|shift
op_ge
l_int|0
suffix:semicolon
id|shift
op_sub_assign
l_int|4
)paren
(brace
id|sum
op_assign
(paren
(paren
id|crc
op_rshift
l_int|12
)paren
op_xor
(paren
id|data
op_rshift
id|shift
)paren
)paren
op_amp
l_int|0x000f
suffix:semicolon
id|crc
op_assign
(paren
id|crc
op_lshift
l_int|4
)paren
op_xor
(paren
id|sum
op_lshift
l_int|12
)paren
op_xor
(paren
id|sum
op_lshift
l_int|5
)paren
op_xor
id|sum
suffix:semicolon
)brace
id|crc
op_and_assign
l_int|0xffff
suffix:semicolon
)brace
r_return
id|crc
suffix:semicolon
)brace
multiline_comment|/* Config ROM macro implementation influenced by NetBSD OHCI driver */
DECL|struct|config_rom_unit
r_struct
id|config_rom_unit
(brace
DECL|member|start
id|u32
op_star
id|start
suffix:semicolon
DECL|member|refer
id|u32
op_star
id|refer
suffix:semicolon
DECL|member|length
r_int
id|length
suffix:semicolon
DECL|member|refunit
r_int
id|refunit
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|config_rom_ptr
r_struct
id|config_rom_ptr
(brace
DECL|member|data
id|u32
op_star
id|data
suffix:semicolon
DECL|member|unitnum
r_int
id|unitnum
suffix:semicolon
DECL|member|unitdir
r_struct
id|config_rom_unit
id|unitdir
(braket
l_int|10
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|macro|cf_put_1quad
mdefine_line|#define cf_put_1quad(cr, q) (((cr)-&gt;data++)[0] = cpu_to_be32(q))
DECL|macro|cf_put_4bytes
mdefine_line|#define cf_put_4bytes(cr, b1, b2, b3, b4) &bslash;&n;&t;(((cr)-&gt;data++)[0] = cpu_to_be32(((b1) &lt;&lt; 24) | ((b2) &lt;&lt; 16) | ((b3) &lt;&lt; 8) | (b4)))
DECL|macro|cf_put_keyval
mdefine_line|#define cf_put_keyval(cr, key, val) (((cr)-&gt;data++)[0] = cpu_to_be32((key) &lt;&lt; 24) | (val))
DECL|macro|cf_put_crc16
mdefine_line|#define cf_put_crc16(cr, unit) &bslash;&n;&t;(*(cr)-&gt;unitdir[unit].start = cpu_to_be32(((cr)-&gt;unitdir[unit].length &lt;&lt; 16) | &bslash;&n;&t; ohci_crc16((cr)-&gt;unitdir[unit].start + 1, (cr)-&gt;unitdir[unit].length)))
DECL|macro|cf_unit_begin
mdefine_line|#define cf_unit_begin(cr, unit)&t;&t;&t;&t;&t;&bslash;&n;do {&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;if ((cr)-&gt;unitdir[unit].refer != NULL) {&t;&t;&bslash;&n;&t;&t;*(cr)-&gt;unitdir[unit].refer |=&t;&t;&t;&bslash;&n;&t;&t;&t;(cr)-&gt;data - (cr)-&gt;unitdir[unit].refer;&t;&bslash;&n;&t;&t;cf_put_crc16(cr, (cr)-&gt;unitdir[unit].refunit);&t;&bslash;&n;        }&t;&t;&t;&t;&t;&t;&t;&bslash;&n;        (cr)-&gt;unitnum = (unit);&t;&t;&t;&t;&t;&bslash;&n;        (cr)-&gt;unitdir[unit].start = (cr)-&gt;data++;&t;&t;&bslash;&n;} while (0)
DECL|macro|cf_put_refer
mdefine_line|#define cf_put_refer(cr, key, unit)&t;&t;&t;&bslash;&n;do {&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;(cr)-&gt;unitdir[unit].refer = (cr)-&gt;data;&t;&t;&bslash;&n;&t;(cr)-&gt;unitdir[unit].refunit = (cr)-&gt;unitnum;&t;&bslash;&n;&t;((cr)-&gt;data++)[0] = cpu_to_be32((key) &lt;&lt; 24);&t;&t;&bslash;&n;} while(0)
DECL|macro|cf_unit_end
mdefine_line|#define cf_unit_end(cr)&t;&t;&t;&t;&t;&t;&bslash;&n;do {&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;(cr)-&gt;unitdir[(cr)-&gt;unitnum].length = (cr)-&gt;data -&t;&bslash;&n;&t;&t;((cr)-&gt;unitdir[(cr)-&gt;unitnum].start + 1);&t;&bslash;&n;&t;cf_put_crc16((cr), (cr)-&gt;unitnum);&t;&t;&t;&bslash;&n;} while(0)
DECL|function|ohci_init_config_rom
r_static
r_void
id|ohci_init_config_rom
c_func
(paren
r_struct
id|ti_ohci
op_star
id|ohci
)paren
(brace
r_struct
id|config_rom_ptr
id|cr
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|cr
comma
l_int|0
comma
r_sizeof
(paren
id|cr
)paren
)paren
suffix:semicolon
id|memset
(paren
id|ohci-&gt;csr_config_rom_cpu
comma
l_int|0
comma
r_sizeof
(paren
id|ohci-&gt;csr_config_rom_cpu
)paren
)paren
suffix:semicolon
id|cr.data
op_assign
id|ohci-&gt;csr_config_rom_cpu
suffix:semicolon
multiline_comment|/* Bus info block */
id|cf_unit_begin
c_func
(paren
op_amp
id|cr
comma
l_int|0
)paren
suffix:semicolon
id|cf_put_1quad
c_func
(paren
op_amp
id|cr
comma
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_BusID
)paren
)paren
suffix:semicolon
id|cf_put_1quad
c_func
(paren
op_amp
id|cr
comma
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_BusOptions
)paren
)paren
suffix:semicolon
id|cf_put_1quad
c_func
(paren
op_amp
id|cr
comma
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_GUIDHi
)paren
)paren
suffix:semicolon
id|cf_put_1quad
c_func
(paren
op_amp
id|cr
comma
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_GUIDLo
)paren
)paren
suffix:semicolon
id|cf_unit_end
c_func
(paren
op_amp
id|cr
)paren
suffix:semicolon
id|DBGMSG
c_func
(paren
id|ohci-&gt;id
comma
l_string|&quot;GUID: %08x:%08x&bslash;n&quot;
comma
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_GUIDHi
)paren
comma
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_GUIDLo
)paren
)paren
suffix:semicolon
multiline_comment|/* IEEE P1212 suggests the initial ROM header CRC should only&n;&t; * cover the header itself (and not the entire ROM). Since we use&n;&t; * this, then we can make our bus_info_len the same as the CRC&n;&t; * length.  */
id|ohci-&gt;csr_config_rom_cpu
(braket
l_int|0
)braket
op_or_assign
id|cpu_to_be32
c_func
(paren
(paren
id|be32_to_cpu
c_func
(paren
id|ohci-&gt;csr_config_rom_cpu
(braket
l_int|0
)braket
)paren
op_amp
l_int|0x00ff0000
)paren
op_lshift
l_int|8
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_ConfigROMhdr
comma
id|be32_to_cpu
c_func
(paren
id|ohci-&gt;csr_config_rom_cpu
(braket
l_int|0
)braket
)paren
)paren
suffix:semicolon
multiline_comment|/* Root directory */
id|cf_unit_begin
c_func
(paren
op_amp
id|cr
comma
l_int|1
)paren
suffix:semicolon
id|cf_put_keyval
c_func
(paren
op_amp
id|cr
comma
l_int|0x03
comma
l_int|0x00005e
)paren
suffix:semicolon
multiline_comment|/* Vendor ID */
id|cf_put_refer
c_func
(paren
op_amp
id|cr
comma
l_int|0x81
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* Textual description unit */
id|cf_put_keyval
c_func
(paren
op_amp
id|cr
comma
l_int|0x0c
comma
l_int|0x0083c0
)paren
suffix:semicolon
multiline_comment|/* Node capabilities */
id|cf_put_refer
c_func
(paren
op_amp
id|cr
comma
l_int|0xd1
comma
l_int|3
)paren
suffix:semicolon
multiline_comment|/* IPv4 unit directory */
id|cf_put_refer
c_func
(paren
op_amp
id|cr
comma
l_int|0xd1
comma
l_int|4
)paren
suffix:semicolon
multiline_comment|/* IPv6 unit directory */
multiline_comment|/* NOTE: Add other unit referers here, and append at bottom */
id|cf_unit_end
c_func
(paren
op_amp
id|cr
)paren
suffix:semicolon
multiline_comment|/* Textual description - &quot;Linux 1394&quot; */
id|cf_unit_begin
c_func
(paren
op_amp
id|cr
comma
l_int|2
)paren
suffix:semicolon
id|cf_put_keyval
c_func
(paren
op_amp
id|cr
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|cf_put_1quad
c_func
(paren
op_amp
id|cr
comma
l_int|0
)paren
suffix:semicolon
id|cf_put_4bytes
c_func
(paren
op_amp
id|cr
comma
l_char|&squot;L&squot;
comma
l_char|&squot;i&squot;
comma
l_char|&squot;n&squot;
comma
l_char|&squot;u&squot;
)paren
suffix:semicolon
id|cf_put_4bytes
c_func
(paren
op_amp
id|cr
comma
l_char|&squot;x&squot;
comma
l_char|&squot; &squot;
comma
l_char|&squot;1&squot;
comma
l_char|&squot;3&squot;
)paren
suffix:semicolon
id|cf_put_4bytes
c_func
(paren
op_amp
id|cr
comma
l_char|&squot;9&squot;
comma
l_char|&squot;4&squot;
comma
l_int|0x0
comma
l_int|0x0
)paren
suffix:semicolon
id|cf_unit_end
c_func
(paren
op_amp
id|cr
)paren
suffix:semicolon
multiline_comment|/* IPv4 unit directory, RFC 2734 */
id|cf_unit_begin
c_func
(paren
op_amp
id|cr
comma
l_int|3
)paren
suffix:semicolon
id|cf_put_keyval
c_func
(paren
op_amp
id|cr
comma
l_int|0x12
comma
l_int|0x00005e
)paren
suffix:semicolon
multiline_comment|/* Unit spec ID */
id|cf_put_refer
c_func
(paren
op_amp
id|cr
comma
l_int|0x81
comma
l_int|6
)paren
suffix:semicolon
multiline_comment|/* Textual description unit */
id|cf_put_keyval
c_func
(paren
op_amp
id|cr
comma
l_int|0x13
comma
l_int|0x000001
)paren
suffix:semicolon
multiline_comment|/* Unit software version */
id|cf_put_refer
c_func
(paren
op_amp
id|cr
comma
l_int|0x81
comma
l_int|7
)paren
suffix:semicolon
multiline_comment|/* Textual description unit */
id|cf_unit_end
c_func
(paren
op_amp
id|cr
)paren
suffix:semicolon
id|cf_unit_begin
c_func
(paren
op_amp
id|cr
comma
l_int|6
)paren
suffix:semicolon
id|cf_put_keyval
c_func
(paren
op_amp
id|cr
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|cf_put_1quad
c_func
(paren
op_amp
id|cr
comma
l_int|0
)paren
suffix:semicolon
id|cf_put_4bytes
c_func
(paren
op_amp
id|cr
comma
l_char|&squot;I&squot;
comma
l_char|&squot;A&squot;
comma
l_char|&squot;N&squot;
comma
l_char|&squot;A&squot;
)paren
suffix:semicolon
id|cf_unit_end
c_func
(paren
op_amp
id|cr
)paren
suffix:semicolon
id|cf_unit_begin
c_func
(paren
op_amp
id|cr
comma
l_int|7
)paren
suffix:semicolon
id|cf_put_keyval
c_func
(paren
op_amp
id|cr
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|cf_put_1quad
c_func
(paren
op_amp
id|cr
comma
l_int|0
)paren
suffix:semicolon
id|cf_put_4bytes
c_func
(paren
op_amp
id|cr
comma
l_char|&squot;I&squot;
comma
l_char|&squot;P&squot;
comma
l_char|&squot;v&squot;
comma
l_char|&squot;4&squot;
)paren
suffix:semicolon
id|cf_unit_end
c_func
(paren
op_amp
id|cr
)paren
suffix:semicolon
multiline_comment|/* IPv6 unit directory, draft-ietf-ipngwg-1394-01.txt */
id|cf_unit_begin
c_func
(paren
op_amp
id|cr
comma
l_int|4
)paren
suffix:semicolon
id|cf_put_keyval
c_func
(paren
op_amp
id|cr
comma
l_int|0x12
comma
l_int|0x00005e
)paren
suffix:semicolon
multiline_comment|/* Unit spec ID */
id|cf_put_refer
c_func
(paren
op_amp
id|cr
comma
l_int|0x81
comma
l_int|8
)paren
suffix:semicolon
multiline_comment|/* Textual description unit */
id|cf_put_keyval
c_func
(paren
op_amp
id|cr
comma
l_int|0x13
comma
l_int|0x000002
)paren
suffix:semicolon
multiline_comment|/* (Proposed) Unit software version */
id|cf_put_refer
c_func
(paren
op_amp
id|cr
comma
l_int|0x81
comma
l_int|9
)paren
suffix:semicolon
multiline_comment|/* Textual description unit */
id|cf_unit_end
c_func
(paren
op_amp
id|cr
)paren
suffix:semicolon
id|cf_unit_begin
c_func
(paren
op_amp
id|cr
comma
l_int|8
)paren
suffix:semicolon
id|cf_put_keyval
c_func
(paren
op_amp
id|cr
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|cf_put_1quad
c_func
(paren
op_amp
id|cr
comma
l_int|0
)paren
suffix:semicolon
id|cf_put_4bytes
c_func
(paren
op_amp
id|cr
comma
l_char|&squot;I&squot;
comma
l_char|&squot;A&squot;
comma
l_char|&squot;N&squot;
comma
l_char|&squot;A&squot;
)paren
suffix:semicolon
id|cf_unit_end
c_func
(paren
op_amp
id|cr
)paren
suffix:semicolon
id|cf_unit_begin
c_func
(paren
op_amp
id|cr
comma
l_int|9
)paren
suffix:semicolon
id|cf_put_keyval
c_func
(paren
op_amp
id|cr
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|cf_put_1quad
c_func
(paren
op_amp
id|cr
comma
l_int|0
)paren
suffix:semicolon
id|cf_put_4bytes
c_func
(paren
op_amp
id|cr
comma
l_char|&squot;I&squot;
comma
l_char|&squot;P&squot;
comma
l_char|&squot;v&squot;
comma
l_char|&squot;6&squot;
)paren
suffix:semicolon
id|cf_unit_end
c_func
(paren
op_amp
id|cr
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|get_ohci_rom
r_static
r_int
id|get_ohci_rom
c_func
(paren
r_struct
id|hpsb_host
op_star
id|host
comma
r_const
id|quadlet_t
op_star
op_star
id|ptr
)paren
(brace
r_struct
id|ti_ohci
op_star
id|ohci
op_assign
id|host-&gt;hostdata
suffix:semicolon
id|DBGMSG
c_func
(paren
id|ohci-&gt;id
comma
l_string|&quot;request csr_rom address: %p&quot;
comma
id|ohci-&gt;csr_config_rom_cpu
)paren
suffix:semicolon
op_star
id|ptr
op_assign
id|ohci-&gt;csr_config_rom_cpu
suffix:semicolon
r_return
r_sizeof
(paren
id|ohci-&gt;csr_config_rom_cpu
)paren
suffix:semicolon
)brace
DECL|function|ohci_compare_swap
r_int
id|ohci_compare_swap
c_func
(paren
r_struct
id|ti_ohci
op_star
id|ohci
comma
id|quadlet_t
op_star
id|data
comma
id|quadlet_t
id|compare
comma
r_int
id|sel
)paren
(brace
r_int
id|i
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_CSRData
comma
op_star
id|data
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_CSRCompareData
comma
id|compare
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_CSRControl
comma
id|sel
op_amp
l_int|0x3
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|OHCI_LOOP_COUNT
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_CSRControl
)paren
op_amp
l_int|0x80000000
)paren
r_break
suffix:semicolon
id|mdelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
op_star
id|data
op_assign
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_CSRData
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ohci_hw_csr_reg
r_static
id|quadlet_t
id|ohci_hw_csr_reg
c_func
(paren
r_struct
id|hpsb_host
op_star
id|host
comma
r_int
id|reg
comma
id|quadlet_t
id|data
comma
id|quadlet_t
id|compare
)paren
(brace
r_struct
id|ti_ohci
op_star
id|ohci
op_assign
id|host-&gt;hostdata
suffix:semicolon
id|ohci_compare_swap
(paren
id|ohci
comma
op_amp
id|data
comma
id|compare
comma
id|reg
)paren
suffix:semicolon
r_return
id|data
suffix:semicolon
)brace
DECL|function|get_ohci_template
r_struct
id|hpsb_host_template
op_star
id|get_ohci_template
c_func
(paren
r_void
)paren
(brace
r_static
r_struct
id|hpsb_host_template
id|tmpl
suffix:semicolon
r_static
r_int
id|initialized
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|initialized
)paren
(brace
id|memset
(paren
op_amp
id|tmpl
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|hpsb_host_template
)paren
)paren
suffix:semicolon
multiline_comment|/* Initialize by field names so that a template structure&n;&t;&t; * reorganization does not influence this code. */
id|tmpl.name
op_assign
l_string|&quot;ohci1394&quot;
suffix:semicolon
id|tmpl.initialize_host
op_assign
id|ohci_initialize
suffix:semicolon
id|tmpl.release_host
op_assign
id|ohci_remove
suffix:semicolon
id|tmpl.get_rom
op_assign
id|get_ohci_rom
suffix:semicolon
id|tmpl.transmit_packet
op_assign
id|ohci_transmit
suffix:semicolon
id|tmpl.devctl
op_assign
id|ohci_devctl
suffix:semicolon
id|tmpl.hw_csr_reg
op_assign
id|ohci_hw_csr_reg
suffix:semicolon
id|initialized
op_assign
l_int|1
suffix:semicolon
)brace
r_return
op_amp
id|tmpl
suffix:semicolon
)brace
DECL|function|ohci1394_add_one
r_static
r_int
id|__devinit
id|ohci1394_add_one
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_const
r_struct
id|pci_device_id
op_star
id|ent
)paren
(brace
r_struct
id|ti_ohci
op_star
id|ohci
suffix:semicolon
multiline_comment|/* shortcut to currently handled device */
r_struct
id|hpsb_host
op_star
id|host
suffix:semicolon
r_int
r_int
id|ohci_base
comma
id|ohci_len
suffix:semicolon
r_static
r_int
id|version_printed
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|version_printed
op_increment
op_eq
l_int|0
)paren
id|PRINT_G
c_func
(paren
id|KERN_INFO
comma
l_string|&quot;%s&quot;
comma
id|version
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_enable_device
c_func
(paren
id|dev
)paren
)paren
(brace
multiline_comment|/* Skip ID&squot;s that fail */
id|PRINT_G
c_func
(paren
id|KERN_NOTICE
comma
l_string|&quot;Failed to enable OHCI hardware %d&quot;
comma
id|card_id_counter
op_increment
)paren
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
id|pci_set_master
c_func
(paren
id|dev
)paren
suffix:semicolon
id|host
op_assign
id|hpsb_get_host
c_func
(paren
id|get_ohci_template
c_func
(paren
)paren
comma
r_sizeof
(paren
r_struct
id|ti_ohci
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|host
)paren
(brace
id|PRINT_G
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;Out of memory trying to allocate host structure&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|ohci
op_assign
id|host-&gt;hostdata
suffix:semicolon
id|ohci-&gt;host
op_assign
id|host
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|ohci-&gt;list
)paren
suffix:semicolon
id|ohci-&gt;id
op_assign
id|card_id_counter
op_increment
suffix:semicolon
id|ohci-&gt;dev
op_assign
id|dev
suffix:semicolon
id|host-&gt;pdev
op_assign
id|dev
suffix:semicolon
id|ohci-&gt;host
op_assign
id|host
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|dev
comma
id|ohci
)paren
suffix:semicolon
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|ohci-&gt;id
comma
l_string|&quot;OHCI (PCI) IEEE-1394 Controller&quot;
)paren
suffix:semicolon
multiline_comment|/* We don&squot;t want hardware swapping */
id|pci_write_config_dword
c_func
(paren
id|dev
comma
id|OHCI1394_PCI_HCI_Control
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Some oddball Apple controllers do not order the selfid&n;&t; * properly, so we make up for it here.  */
macro_line|#ifndef __LITTLE_ENDIAN
multiline_comment|/* XXX: Need a better way to check this. I&squot;m wondering if we can&n;&t; * read the values of the OHCI1394_PCI_HCI_Control and the&n;&t; * noByteSwapData registers to see if they were not cleared to&n;&t; * zero. Should this work? Obviously it&squot;s not defined what these&n;&t; * registers will read when they aren&squot;t supported. Bleh! */
r_if
c_cond
(paren
id|dev-&gt;vendor
op_eq
id|PCI_VENDOR_ID_APPLE
)paren
(brace
id|ohci-&gt;payload_swap
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;device
op_ne
id|PCI_DEVICE_ID_APPLE_UNI_N_FW
)paren
id|ohci-&gt;selfid_swap
op_assign
l_int|1
suffix:semicolon
)brace
r_else
id|ohci-&gt;selfid_swap
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
multiline_comment|/* csr_config rom allocation */
id|ohci-&gt;csr_config_rom_cpu
op_assign
id|pci_alloc_consistent
c_func
(paren
id|ohci-&gt;dev
comma
id|OHCI_CONFIG_ROM_LEN
comma
op_amp
id|ohci-&gt;csr_config_rom_bus
)paren
suffix:semicolon
id|OHCI_DMA_ALLOC
c_func
(paren
l_string|&quot;consistent csr_config_rom&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ohci-&gt;csr_config_rom_cpu
op_eq
l_int|NULL
)paren
id|FAIL
c_func
(paren
l_string|&quot;Failed to allocate buffer config rom&quot;
)paren
suffix:semicolon
multiline_comment|/* &n;&t; * self-id dma buffer allocation&n;&t; */
id|ohci-&gt;selfid_buf_cpu
op_assign
id|pci_alloc_consistent
c_func
(paren
id|ohci-&gt;dev
comma
id|OHCI1394_SI_DMA_BUF_SIZE
comma
op_amp
id|ohci-&gt;selfid_buf_bus
)paren
suffix:semicolon
id|OHCI_DMA_ALLOC
c_func
(paren
l_string|&quot;consistent selfid_buf&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ohci-&gt;selfid_buf_cpu
op_eq
l_int|NULL
)paren
id|FAIL
c_func
(paren
l_string|&quot;Failed to allocate DMA buffer for self-id packets&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
r_int
r_int
)paren
id|ohci-&gt;selfid_buf_cpu
op_amp
l_int|0x1fff
)paren
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|ohci-&gt;id
comma
l_string|&quot;SelfID buffer %p is not aligned on &quot;
l_string|&quot;8Kb boundary... may cause problems on some CXD3222 chip&quot;
comma
id|ohci-&gt;selfid_buf_cpu
)paren
suffix:semicolon
id|ohci-&gt;it_context
op_assign
id|alloc_dma_trm_ctx
c_func
(paren
id|ohci
comma
l_int|2
comma
id|IT_NUM_DESC
comma
id|OHCI1394_IsoXmitContextControlSet
comma
id|OHCI1394_IsoXmitContextControlClear
comma
id|OHCI1394_IsoXmitCommandPtr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ohci-&gt;it_context
op_eq
l_int|NULL
)paren
id|FAIL
c_func
(paren
l_string|&quot;Failed to allocate IT context&quot;
)paren
suffix:semicolon
id|ohci_base
op_assign
id|pci_resource_start
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
id|ohci_len
op_assign
id|pci_resource_len
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|request_mem_region
(paren
id|ohci_base
comma
id|ohci_len
comma
id|host
op_member_access_from_pointer
r_template
op_member_access_from_pointer
id|name
)paren
)paren
id|FAIL
c_func
(paren
l_string|&quot;MMIO resource (0x%lx@0x%lx) unavailable, aborting.&quot;
comma
id|ohci_base
comma
id|ohci_len
)paren
suffix:semicolon
id|ohci-&gt;registers
op_assign
id|ioremap
c_func
(paren
id|ohci_base
comma
id|ohci_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ohci-&gt;registers
op_eq
l_int|NULL
)paren
id|FAIL
c_func
(paren
l_string|&quot;Failed to remap registers - card not accessible&quot;
)paren
suffix:semicolon
id|DBGMSG
c_func
(paren
id|ohci-&gt;id
comma
l_string|&quot;Remapped memory spaces reg 0x%p&quot;
comma
id|ohci-&gt;registers
)paren
suffix:semicolon
id|ohci-&gt;ar_req_context
op_assign
id|alloc_dma_rcv_ctx
c_func
(paren
id|ohci
comma
l_int|0
comma
id|AR_REQ_NUM_DESC
comma
id|AR_REQ_BUF_SIZE
comma
id|AR_REQ_SPLIT_BUF_SIZE
comma
id|OHCI1394_AsReqRcvContextControlSet
comma
id|OHCI1394_AsReqRcvContextControlClear
comma
id|OHCI1394_AsReqRcvCommandPtr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ohci-&gt;ar_req_context
op_eq
l_int|NULL
)paren
id|FAIL
c_func
(paren
l_string|&quot;Failed to allocate AR Req context&quot;
)paren
suffix:semicolon
id|ohci-&gt;ar_resp_context
op_assign
id|alloc_dma_rcv_ctx
c_func
(paren
id|ohci
comma
l_int|1
comma
id|AR_RESP_NUM_DESC
comma
id|AR_RESP_BUF_SIZE
comma
id|AR_RESP_SPLIT_BUF_SIZE
comma
id|OHCI1394_AsRspRcvContextControlSet
comma
id|OHCI1394_AsRspRcvContextControlClear
comma
id|OHCI1394_AsRspRcvCommandPtr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ohci-&gt;ar_resp_context
op_eq
l_int|NULL
)paren
id|FAIL
c_func
(paren
l_string|&quot;Failed to allocate AR Resp context&quot;
)paren
suffix:semicolon
id|ohci-&gt;at_req_context
op_assign
id|alloc_dma_trm_ctx
c_func
(paren
id|ohci
comma
l_int|0
comma
id|AT_REQ_NUM_DESC
comma
id|OHCI1394_AsReqTrContextControlSet
comma
id|OHCI1394_AsReqTrContextControlClear
comma
id|OHCI1394_AsReqTrCommandPtr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ohci-&gt;at_req_context
op_eq
l_int|NULL
)paren
id|FAIL
c_func
(paren
l_string|&quot;Failed to allocate AT Req context&quot;
)paren
suffix:semicolon
id|ohci-&gt;at_resp_context
op_assign
id|alloc_dma_trm_ctx
c_func
(paren
id|ohci
comma
l_int|1
comma
id|AT_RESP_NUM_DESC
comma
id|OHCI1394_AsRspTrContextControlSet
comma
id|OHCI1394_AsRspTrContextControlClear
comma
id|OHCI1394_AsRspTrCommandPtr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ohci-&gt;at_resp_context
op_eq
l_int|NULL
)paren
id|FAIL
c_func
(paren
l_string|&quot;Failed to allocate AT Resp context&quot;
)paren
suffix:semicolon
id|ohci-&gt;ir_context
op_assign
id|alloc_dma_rcv_ctx
c_func
(paren
id|ohci
comma
l_int|2
comma
id|IR_NUM_DESC
comma
id|IR_BUF_SIZE
comma
id|IR_SPLIT_BUF_SIZE
comma
id|OHCI1394_IsoRcvContextControlSet
comma
id|OHCI1394_IsoRcvContextControlClear
comma
id|OHCI1394_IsoRcvCommandPtr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ohci-&gt;ir_context
op_eq
l_int|NULL
)paren
id|FAIL
c_func
(paren
l_string|&quot;Failed to allocate IR context&quot;
)paren
suffix:semicolon
id|ohci-&gt;ISO_channel_usage
op_assign
l_int|0
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|ohci-&gt;IR_channel_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
id|ohci_irq_handler
comma
id|SA_SHIRQ
comma
id|OHCI1394_DRIVER_NAME
comma
id|ohci
)paren
)paren
id|PRINT
c_func
(paren
id|KERN_DEBUG
comma
id|ohci-&gt;id
comma
l_string|&quot;Allocated interrupt %d&quot;
comma
id|dev-&gt;irq
)paren
suffix:semicolon
r_else
id|FAIL
c_func
(paren
l_string|&quot;Failed to allocate shared interrupt %d&quot;
comma
id|dev-&gt;irq
)paren
suffix:semicolon
id|ohci_init_config_rom
c_func
(paren
id|ohci
)paren
suffix:semicolon
multiline_comment|/* Tell the highlevel this host is ready */
id|highlevel_add_one_host
(paren
id|host
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
DECL|macro|FAIL
macro_line|#undef FAIL
)brace
DECL|function|remove_card
r_static
r_void
id|remove_card
c_func
(paren
r_struct
id|ti_ohci
op_star
id|ohci
)paren
(brace
multiline_comment|/* Reset the board properly before leaving */
id|ohci_soft_reset
c_func
(paren
id|ohci
)paren
suffix:semicolon
multiline_comment|/* Free AR dma */
id|free_dma_rcv_ctx
c_func
(paren
op_amp
id|ohci-&gt;ar_req_context
)paren
suffix:semicolon
id|free_dma_rcv_ctx
c_func
(paren
op_amp
id|ohci-&gt;ar_resp_context
)paren
suffix:semicolon
multiline_comment|/* Free AT dma */
id|free_dma_trm_ctx
c_func
(paren
op_amp
id|ohci-&gt;at_req_context
)paren
suffix:semicolon
id|free_dma_trm_ctx
c_func
(paren
op_amp
id|ohci-&gt;at_resp_context
)paren
suffix:semicolon
multiline_comment|/* Free IR dma */
id|free_dma_rcv_ctx
c_func
(paren
op_amp
id|ohci-&gt;ir_context
)paren
suffix:semicolon
multiline_comment|/* Free IT dma */
id|free_dma_trm_ctx
c_func
(paren
op_amp
id|ohci-&gt;it_context
)paren
suffix:semicolon
multiline_comment|/* Free self-id buffer */
r_if
c_cond
(paren
id|ohci-&gt;selfid_buf_cpu
)paren
(brace
id|pci_free_consistent
c_func
(paren
id|ohci-&gt;dev
comma
id|OHCI1394_SI_DMA_BUF_SIZE
comma
id|ohci-&gt;selfid_buf_cpu
comma
id|ohci-&gt;selfid_buf_bus
)paren
suffix:semicolon
id|OHCI_DMA_FREE
c_func
(paren
l_string|&quot;consistent selfid_buf&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* Free config rom */
r_if
c_cond
(paren
id|ohci-&gt;csr_config_rom_cpu
)paren
(brace
id|pci_free_consistent
c_func
(paren
id|ohci-&gt;dev
comma
id|OHCI_CONFIG_ROM_LEN
comma
id|ohci-&gt;csr_config_rom_cpu
comma
id|ohci-&gt;csr_config_rom_bus
)paren
suffix:semicolon
id|OHCI_DMA_FREE
c_func
(paren
l_string|&quot;consistent csr_config_rom&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* Free the IRQ */
id|free_irq
c_func
(paren
id|ohci-&gt;dev-&gt;irq
comma
id|ohci
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ohci-&gt;registers
)paren
id|iounmap
c_func
(paren
id|ohci-&gt;registers
)paren
suffix:semicolon
id|release_mem_region
(paren
id|pci_resource_start
c_func
(paren
id|ohci-&gt;dev
comma
l_int|0
)paren
comma
id|pci_resource_len
c_func
(paren
id|ohci-&gt;dev
comma
l_int|0
)paren
)paren
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|ohci-&gt;dev
comma
l_int|NULL
)paren
suffix:semicolon
)brace
DECL|function|ohci1394_stop_context
r_void
id|ohci1394_stop_context
c_func
(paren
r_struct
id|ti_ohci
op_star
id|ohci
comma
r_int
id|reg
comma
r_char
op_star
id|msg
)paren
(brace
r_int
id|i
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* stop the channel program if it&squot;s still running */
id|reg_write
c_func
(paren
id|ohci
comma
id|reg
comma
l_int|0x8000
)paren
suffix:semicolon
multiline_comment|/* Wait until it effectively stops */
r_while
c_loop
(paren
id|reg_read
c_func
(paren
id|ohci
comma
id|reg
)paren
op_amp
l_int|0x400
)paren
(brace
id|i
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|i
OG
l_int|5000
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;Runaway loop while stopping context...&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|msg
)paren
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;%s: dma prg stopped&quot;
comma
id|msg
)paren
suffix:semicolon
)brace
DECL|function|ohci1394_register_video
r_int
id|ohci1394_register_video
c_func
(paren
r_struct
id|ti_ohci
op_star
id|ohci
comma
r_struct
id|video_template
op_star
id|tmpl
)paren
(brace
r_if
c_cond
(paren
id|ohci-&gt;video_tmpl
)paren
r_return
op_minus
id|ENFILE
suffix:semicolon
id|ohci-&gt;video_tmpl
op_assign
id|tmpl
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ohci1394_unregister_video
r_void
id|ohci1394_unregister_video
c_func
(paren
r_struct
id|ti_ohci
op_star
id|ohci
comma
r_struct
id|video_template
op_star
id|tmpl
)paren
(brace
r_if
c_cond
(paren
id|ohci-&gt;video_tmpl
op_ne
id|tmpl
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
id|ohci-&gt;id
comma
l_string|&quot;Trying to unregister wrong video device&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|ohci-&gt;video_tmpl
op_assign
l_int|NULL
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
)brace
macro_line|#ifndef __LITTLE_ENDIAN
multiline_comment|/* Swap a series of quads inplace. */
DECL|function|block_swab32
r_static
id|__inline__
r_void
id|block_swab32
c_func
(paren
id|quadlet_t
op_star
id|data
comma
r_int
id|size
)paren
(brace
r_while
c_loop
(paren
id|size
op_decrement
)paren
id|data
(braket
id|size
)braket
op_assign
id|swab32
c_func
(paren
id|data
(braket
id|size
)braket
)paren
suffix:semicolon
)brace
multiline_comment|/* Swap headers and sometimes data too */
DECL|function|packet_swab
r_static
r_void
id|packet_swab
c_func
(paren
id|quadlet_t
op_star
id|data
comma
r_char
id|tcode
comma
r_int
id|len
comma
r_int
id|payload_swap
)paren
(brace
r_if
c_cond
(paren
id|payload_swap
)paren
(brace
id|block_swab32
c_func
(paren
id|data
comma
id|len
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|tcode
)paren
(brace
multiline_comment|/* 4 quad header */
r_case
id|TCODE_READB_RESPONSE
suffix:colon
r_case
id|TCODE_LOCK_RESPONSE
suffix:colon
r_case
id|TCODE_LOCK_REQUEST
suffix:colon
r_case
id|TCODE_WRITEB
suffix:colon
r_case
id|TCODE_READB
suffix:colon
id|block_swab32
c_func
(paren
id|data
comma
l_int|4
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* 3 quad header, 1 quad payload */
r_case
id|TCODE_WRITEQ
suffix:colon
r_case
id|TCODE_READQ_RESPONSE
suffix:colon
id|block_swab32
c_func
(paren
id|data
comma
l_int|3
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* 3 quad header */
r_case
id|TCODE_WRITE_RESPONSE
suffix:colon
r_case
id|TCODE_READQ
suffix:colon
id|block_swab32
c_func
(paren
id|data
comma
l_int|3
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* 2 quad header */
r_case
id|TCODE_ISO_DATA
suffix:colon
id|block_swab32
c_func
(paren
id|data
comma
l_int|2
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|OHCI1394_TCODE_PHY
suffix:colon
r_break
suffix:semicolon
multiline_comment|/* should never happen anyway */
r_case
id|TCODE_CYCLE_START
suffix:colon
id|PRINT_G
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;Unhandled tcode in packet_swab (0x%x)&quot;
comma
id|tcode
)paren
suffix:semicolon
multiline_comment|/* Atleast swap one quad */
id|block_swab32
c_func
(paren
id|data
comma
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|PRINT_G
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;Invalid tcode in packet_swab (0x%x)&bslash;n&quot;
comma
id|tcode
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
macro_line|#endif /* !LITTLE_ENDIAN */
macro_line|#if 0
r_int
id|ohci1394_request_channel
c_func
(paren
r_struct
id|ti_ohci
op_star
id|ohci
comma
r_int
id|channel
)paren
(brace
r_int
id|csrSel
suffix:semicolon
id|quadlet_t
id|chan
comma
id|data1
op_assign
l_int|0
comma
id|data2
op_assign
l_int|0
suffix:semicolon
r_int
id|timeout
op_assign
l_int|32
suffix:semicolon
r_if
c_cond
(paren
id|channel
OL
l_int|32
)paren
(brace
id|chan
op_assign
l_int|1
op_lshift
id|channel
suffix:semicolon
id|csrSel
op_assign
l_int|2
suffix:semicolon
)brace
r_else
(brace
id|chan
op_assign
l_int|1
op_lshift
(paren
id|channel
op_minus
l_int|32
)paren
suffix:semicolon
id|csrSel
op_assign
l_int|3
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ohci_compare_swap
c_func
(paren
id|ohci
comma
op_amp
id|data1
comma
l_int|0
comma
id|csrSel
)paren
OL
l_int|0
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|ohci-&gt;id
comma
l_string|&quot;request_channel timeout&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_while
c_loop
(paren
id|timeout
op_decrement
)paren
(brace
r_if
c_cond
(paren
id|data1
op_amp
id|chan
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|ohci-&gt;id
comma
l_string|&quot;request channel %d failed&quot;
comma
id|channel
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|data2
op_assign
id|data1
suffix:semicolon
id|data1
op_or_assign
id|chan
suffix:semicolon
r_if
c_cond
(paren
id|ohci_compare_swap
c_func
(paren
id|ohci
comma
op_amp
id|data1
comma
id|data2
comma
id|csrSel
)paren
OL
l_int|0
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|ohci-&gt;id
comma
l_string|&quot;request_channel timeout&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|data1
op_eq
id|data2
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|ohci-&gt;id
comma
l_string|&quot;request channel %d succeded&quot;
comma
id|channel
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
id|PRINT
c_func
(paren
id|KERN_INFO
comma
id|ohci-&gt;id
comma
l_string|&quot;request channel %d failed&quot;
comma
id|channel
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
macro_line|#endif
DECL|variable|ohci1394_stop_context
id|EXPORT_SYMBOL
c_func
(paren
id|ohci1394_stop_context
)paren
suffix:semicolon
DECL|variable|ohci1394_register_video
id|EXPORT_SYMBOL
c_func
(paren
id|ohci1394_register_video
)paren
suffix:semicolon
DECL|variable|ohci1394_unregister_video
id|EXPORT_SYMBOL
c_func
(paren
id|ohci1394_unregister_video
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Sebastien Rougeaux &lt;sebastien.rougeaux@anu.edu.au&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Driver for PCI OHCI IEEE-1394 controllers&quot;
)paren
suffix:semicolon
DECL|function|ohci1394_remove_one
r_static
r_void
id|__devexit
id|ohci1394_remove_one
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
r_struct
id|ti_ohci
op_star
id|ohci
op_assign
id|pci_get_drvdata
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ohci
)paren
(brace
id|remove_card
(paren
id|ohci
)paren
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|pdev
comma
l_int|NULL
)paren
suffix:semicolon
)brace
)brace
DECL|variable|ohci1394_driver
r_static
r_struct
id|pci_driver
id|ohci1394_driver
op_assign
(brace
id|name
suffix:colon
l_string|&quot;ohci1394&quot;
comma
id|id_table
suffix:colon
id|ohci1394_pci_tbl
comma
id|probe
suffix:colon
id|ohci1394_add_one
comma
id|remove
suffix:colon
id|ohci1394_remove_one
comma
)brace
suffix:semicolon
DECL|function|ohci1394_cleanup
r_static
r_void
id|__exit
id|ohci1394_cleanup
(paren
r_void
)paren
(brace
id|hpsb_unregister_lowlevel
c_func
(paren
id|get_ohci_template
c_func
(paren
)paren
)paren
suffix:semicolon
id|pci_unregister_driver
c_func
(paren
op_amp
id|ohci1394_driver
)paren
suffix:semicolon
)brace
DECL|function|ohci1394_init
r_static
r_int
id|__init
id|ohci1394_init
c_func
(paren
r_void
)paren
(brace
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
id|hpsb_register_lowlevel
c_func
(paren
id|get_ohci_template
c_func
(paren
)paren
)paren
)paren
(brace
id|PRINT_G
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;Registering failed&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|pci_module_init
c_func
(paren
op_amp
id|ohci1394_driver
)paren
)paren
)paren
(brace
id|PRINT_G
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;PCI module init failed&bslash;n&quot;
)paren
suffix:semicolon
id|hpsb_unregister_lowlevel
c_func
(paren
id|get_ohci_template
c_func
(paren
)paren
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|variable|ohci1394_init
id|module_init
c_func
(paren
id|ohci1394_init
)paren
suffix:semicolon
DECL|variable|ohci1394_cleanup
id|module_exit
c_func
(paren
id|ohci1394_cleanup
)paren
suffix:semicolon
eof
