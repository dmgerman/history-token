multiline_comment|/*&n; * ohci1394.c - driver for OHCI 1394 boards&n; * Copyright (C)1999,2000 Sebastien Rougeaux &lt;sebastien.rougeaux@anu.edu.au&gt;&n; *                        Gord Peters &lt;GordPeters@smarttech.com&gt;&n; *              2001      Ben Collins &lt;bcollins@debian.org&gt;&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or&n; * (at your option) any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software Foundation,&n; * Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.&n; */
multiline_comment|/*&n; * Things known to be working:&n; * . Async Request Transmit&n; * . Async Response Receive&n; * . Async Request Receive&n; * . Async Response Transmit&n; * . Iso Receive&n; * . DMA mmap for iso receive&n; * . Config ROM generation&n; *&n; * Things implemented, but still in test phase:&n; * . Iso Transmit&n; * . Async Stream Packets Transmit (Receive done via Iso interface)&n; *&n; * Things not implemented:&n; * . DMA error recovery&n; *&n; * Known bugs:&n; * . devctl BUS_RESET arg confusion (reset type or root holdoff?)&n; *   added LONG_RESET_ROOT and SHORT_RESET_ROOT for root holdoff --kk&n; */
multiline_comment|/*&n; * Acknowledgments:&n; *&n; * Adam J Richter &lt;adam@yggdrasil.com&gt;&n; *  . Use of pci_class to find device&n; *&n; * Emilie Chung&t;&lt;emilie.chung@axis.com&gt;&n; *  . Tip on Async Request Filter&n; *&n; * Pascal Drolet &lt;pascal.drolet@informission.ca&gt;&n; *  . Various tips for optimization and functionnalities&n; *&n; * Robert Ficklin &lt;rficklin@westengineering.com&gt;&n; *  . Loop in irq_handler&n; *&n; * James Goodwin &lt;jamesg@Filanet.com&gt;&n; *  . Various tips on initialization, self-id reception, etc.&n; *&n; * Albrecht Dress &lt;ad@mpifr-bonn.mpg.de&gt;&n; *  . Apple PowerBook detection&n; *&n; * Daniel Kobras &lt;daniel.kobras@student.uni-tuebingen.de&gt;&n; *  . Reset the board properly before leaving + misc cleanups&n; *&n; * Leon van Stuivenberg &lt;leonvs@iae.nl&gt;&n; *  . Bug fixes&n; *&n; * Ben Collins &lt;bcollins@debian.org&gt;&n; *  . Working big-endian support&n; *  . Updated to 2.4.x module scheme (PCI aswell)&n; *  . Config ROM generation&n; *&n; * Manfred Weihs &lt;weihs@ict.tuwien.ac.at&gt;&n; *  . Reworked code for initiating bus resets&n; *    (long, short, with or without hold-off)&n; *&n; * Nandu Santhi &lt;contactnandu@users.sourceforge.net&gt;&n; *  . Added support for nVidia nForce2 onboard Firewire chipset&n; *&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/list.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/wait.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/moduleparam.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/poll.h&gt;
macro_line|#include &lt;asm/byteorder.h&gt;
macro_line|#include &lt;asm/atomic.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/page.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/vmalloc.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#ifdef CONFIG_PPC_PMAC
macro_line|#include &lt;asm/machdep.h&gt;
macro_line|#include &lt;asm/pmac_feature.h&gt;
macro_line|#include &lt;asm/prom.h&gt;
macro_line|#include &lt;asm/pci-bridge.h&gt;
macro_line|#endif
macro_line|#include &quot;csr1212.h&quot;
macro_line|#include &quot;ieee1394.h&quot;
macro_line|#include &quot;ieee1394_types.h&quot;
macro_line|#include &quot;hosts.h&quot;
macro_line|#include &quot;dma.h&quot;
macro_line|#include &quot;iso.h&quot;
macro_line|#include &quot;ieee1394_core.h&quot;
macro_line|#include &quot;highlevel.h&quot;
macro_line|#include &quot;ohci1394.h&quot;
macro_line|#ifdef CONFIG_IEEE1394_VERBOSEDEBUG
DECL|macro|OHCI1394_DEBUG
mdefine_line|#define OHCI1394_DEBUG
macro_line|#endif
macro_line|#ifdef DBGMSG
DECL|macro|DBGMSG
macro_line|#undef DBGMSG
macro_line|#endif
macro_line|#ifdef OHCI1394_DEBUG
DECL|macro|DBGMSG
mdefine_line|#define DBGMSG(fmt, args...) &bslash;&n;printk(KERN_INFO &quot;%s: fw-host%d: &quot; fmt &quot;&bslash;n&quot; , OHCI1394_DRIVER_NAME, ohci-&gt;host-&gt;id , ## args)
macro_line|#else
DECL|macro|DBGMSG
mdefine_line|#define DBGMSG(fmt, args...)
macro_line|#endif
macro_line|#ifdef CONFIG_IEEE1394_OHCI_DMA_DEBUG
DECL|macro|OHCI_DMA_ALLOC
mdefine_line|#define OHCI_DMA_ALLOC(fmt, args...) &bslash;&n;&t;HPSB_ERR(&quot;%s(%s)alloc(%d): &quot;fmt, OHCI1394_DRIVER_NAME, __FUNCTION__, &bslash;&n;&t;&t;++global_outstanding_dmas, ## args)
DECL|macro|OHCI_DMA_FREE
mdefine_line|#define OHCI_DMA_FREE(fmt, args...) &bslash;&n;&t;HPSB_ERR(&quot;%s(%s)free(%d): &quot;fmt, OHCI1394_DRIVER_NAME, __FUNCTION__, &bslash;&n;&t;&t;--global_outstanding_dmas, ## args)
DECL|variable|global_outstanding_dmas
r_static
r_int
id|global_outstanding_dmas
op_assign
l_int|0
suffix:semicolon
macro_line|#else
DECL|macro|OHCI_DMA_ALLOC
mdefine_line|#define OHCI_DMA_ALLOC(fmt, args...)
DECL|macro|OHCI_DMA_FREE
mdefine_line|#define OHCI_DMA_FREE(fmt, args...)
macro_line|#endif
multiline_comment|/* print general (card independent) information */
DECL|macro|PRINT_G
mdefine_line|#define PRINT_G(level, fmt, args...) &bslash;&n;printk(level &quot;%s: &quot; fmt &quot;&bslash;n&quot; , OHCI1394_DRIVER_NAME , ## args)
multiline_comment|/* print card specific information */
DECL|macro|PRINT
mdefine_line|#define PRINT(level, fmt, args...) &bslash;&n;printk(level &quot;%s: fw-host%d: &quot; fmt &quot;&bslash;n&quot; , OHCI1394_DRIVER_NAME, ohci-&gt;host-&gt;id , ## args)
DECL|variable|__devinitdata
r_static
r_char
id|version
(braket
)braket
id|__devinitdata
op_assign
l_string|&quot;$Rev: 1223 $ Ben Collins &lt;bcollins@debian.org&gt;&quot;
suffix:semicolon
multiline_comment|/* Module Parameters */
DECL|variable|phys_dma
r_static
r_int
id|phys_dma
op_assign
l_int|1
suffix:semicolon
id|module_param
c_func
(paren
id|phys_dma
comma
r_int
comma
l_int|0644
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|phys_dma
comma
l_string|&quot;Enable physical dma (default = 1).&quot;
)paren
suffix:semicolon
r_static
r_void
id|dma_trm_tasklet
c_func
(paren
r_int
r_int
id|data
)paren
suffix:semicolon
r_static
r_void
id|dma_trm_reset
c_func
(paren
r_struct
id|dma_trm_ctx
op_star
id|d
)paren
suffix:semicolon
r_static
r_int
id|alloc_dma_rcv_ctx
c_func
(paren
r_struct
id|ti_ohci
op_star
id|ohci
comma
r_struct
id|dma_rcv_ctx
op_star
id|d
comma
r_enum
id|context_type
id|type
comma
r_int
id|ctx
comma
r_int
id|num_desc
comma
r_int
id|buf_size
comma
r_int
id|split_buf_size
comma
r_int
id|context_base
)paren
suffix:semicolon
r_static
r_void
id|stop_dma_rcv_ctx
c_func
(paren
r_struct
id|dma_rcv_ctx
op_star
id|d
)paren
suffix:semicolon
r_static
r_void
id|free_dma_rcv_ctx
c_func
(paren
r_struct
id|dma_rcv_ctx
op_star
id|d
)paren
suffix:semicolon
r_static
r_int
id|alloc_dma_trm_ctx
c_func
(paren
r_struct
id|ti_ohci
op_star
id|ohci
comma
r_struct
id|dma_trm_ctx
op_star
id|d
comma
r_enum
id|context_type
id|type
comma
r_int
id|ctx
comma
r_int
id|num_desc
comma
r_int
id|context_base
)paren
suffix:semicolon
r_static
r_void
id|ohci1394_pci_remove
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
suffix:semicolon
macro_line|#ifndef __LITTLE_ENDIAN
DECL|variable|hdr_sizes
r_static
r_int
id|hdr_sizes
(braket
)braket
op_assign
(brace
l_int|3
comma
multiline_comment|/* TCODE_WRITEQ */
l_int|4
comma
multiline_comment|/* TCODE_WRITEB */
l_int|3
comma
multiline_comment|/* TCODE_WRITE_RESPONSE */
l_int|0
comma
multiline_comment|/* ??? */
l_int|3
comma
multiline_comment|/* TCODE_READQ */
l_int|4
comma
multiline_comment|/* TCODE_READB */
l_int|3
comma
multiline_comment|/* TCODE_READQ_RESPONSE */
l_int|4
comma
multiline_comment|/* TCODE_READB_RESPONSE */
l_int|1
comma
multiline_comment|/* TCODE_CYCLE_START (???) */
l_int|4
comma
multiline_comment|/* TCODE_LOCK_REQUEST */
l_int|2
comma
multiline_comment|/* TCODE_ISO_DATA */
l_int|4
comma
multiline_comment|/* TCODE_LOCK_RESPONSE */
)brace
suffix:semicolon
multiline_comment|/* Swap headers */
DECL|function|packet_swab
r_static
r_inline
r_void
id|packet_swab
c_func
(paren
id|quadlet_t
op_star
id|data
comma
r_int
id|tcode
)paren
(brace
r_int
id|size
op_assign
id|hdr_sizes
(braket
id|tcode
)braket
suffix:semicolon
r_if
c_cond
(paren
id|tcode
OG
id|TCODE_LOCK_RESPONSE
op_logical_or
id|hdr_sizes
(braket
id|tcode
)braket
op_eq
l_int|0
)paren
r_return
suffix:semicolon
r_while
c_loop
(paren
id|size
op_decrement
)paren
id|data
(braket
id|size
)braket
op_assign
id|swab32
c_func
(paren
id|data
(braket
id|size
)braket
)paren
suffix:semicolon
)brace
macro_line|#else
multiline_comment|/* Don&squot;t waste cycles on same sex byte swaps */
DECL|macro|packet_swab
mdefine_line|#define packet_swab(w,x)
macro_line|#endif /* !LITTLE_ENDIAN */
multiline_comment|/***********************************&n; * IEEE-1394 functionality section *&n; ***********************************/
DECL|function|get_phy_reg
r_static
id|u8
id|get_phy_reg
c_func
(paren
r_struct
id|ti_ohci
op_star
id|ohci
comma
id|u8
id|addr
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|quadlet_t
id|r
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|ohci-&gt;phy_reg_lock
comma
id|flags
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_PhyControl
comma
(paren
id|addr
op_lshift
l_int|8
)paren
op_or
l_int|0x00008000
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|OHCI_LOOP_COUNT
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_PhyControl
)paren
op_amp
l_int|0x80000000
)paren
r_break
suffix:semicolon
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
id|r
op_assign
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_PhyControl
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ge
id|OHCI_LOOP_COUNT
)paren
id|PRINT
(paren
id|KERN_ERR
comma
l_string|&quot;Get PHY Reg timeout [0x%08x/0x%08x/%d]&quot;
comma
id|r
comma
id|r
op_amp
l_int|0x80000000
comma
id|i
)paren
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|ohci-&gt;phy_reg_lock
comma
id|flags
)paren
suffix:semicolon
r_return
(paren
id|r
op_amp
l_int|0x00ff0000
)paren
op_rshift
l_int|16
suffix:semicolon
)brace
DECL|function|set_phy_reg
r_static
r_void
id|set_phy_reg
c_func
(paren
r_struct
id|ti_ohci
op_star
id|ohci
comma
id|u8
id|addr
comma
id|u8
id|data
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|u32
id|r
op_assign
l_int|0
suffix:semicolon
id|spin_lock_irqsave
(paren
op_amp
id|ohci-&gt;phy_reg_lock
comma
id|flags
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_PhyControl
comma
(paren
id|addr
op_lshift
l_int|8
)paren
op_or
id|data
op_or
l_int|0x00004000
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|OHCI_LOOP_COUNT
suffix:semicolon
id|i
op_increment
)paren
(brace
id|r
op_assign
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_PhyControl
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|r
op_amp
l_int|0x00004000
)paren
)paren
r_break
suffix:semicolon
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_eq
id|OHCI_LOOP_COUNT
)paren
id|PRINT
(paren
id|KERN_ERR
comma
l_string|&quot;Set PHY Reg timeout [0x%08x/0x%08x/%d]&quot;
comma
id|r
comma
id|r
op_amp
l_int|0x00004000
comma
id|i
)paren
suffix:semicolon
id|spin_unlock_irqrestore
(paren
op_amp
id|ohci-&gt;phy_reg_lock
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Or&squot;s our value into the current value */
DECL|function|set_phy_reg_mask
r_static
r_void
id|set_phy_reg_mask
c_func
(paren
r_struct
id|ti_ohci
op_star
id|ohci
comma
id|u8
id|addr
comma
id|u8
id|data
)paren
(brace
id|u8
id|old
suffix:semicolon
id|old
op_assign
id|get_phy_reg
(paren
id|ohci
comma
id|addr
)paren
suffix:semicolon
id|old
op_or_assign
id|data
suffix:semicolon
id|set_phy_reg
(paren
id|ohci
comma
id|addr
comma
id|old
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|handle_selfid
r_static
r_void
id|handle_selfid
c_func
(paren
r_struct
id|ti_ohci
op_star
id|ohci
comma
r_struct
id|hpsb_host
op_star
id|host
comma
r_int
id|phyid
comma
r_int
id|isroot
)paren
(brace
id|quadlet_t
op_star
id|q
op_assign
id|ohci-&gt;selfid_buf_cpu
suffix:semicolon
id|quadlet_t
id|self_id_count
op_assign
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_SelfIDCount
)paren
suffix:semicolon
r_int
id|size
suffix:semicolon
id|quadlet_t
id|q0
comma
id|q1
suffix:semicolon
multiline_comment|/* Check status of self-id reception */
r_if
c_cond
(paren
id|ohci-&gt;selfid_swap
)paren
id|q0
op_assign
id|le32_to_cpu
c_func
(paren
id|q
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_else
id|q0
op_assign
id|q
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|self_id_count
op_amp
l_int|0x80000000
)paren
op_logical_or
(paren
(paren
id|self_id_count
op_amp
l_int|0x00FF0000
)paren
op_ne
(paren
id|q0
op_amp
l_int|0x00FF0000
)paren
)paren
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;Error in reception of SelfID packets [0x%08x/0x%08x] (count: %d)&quot;
comma
id|self_id_count
comma
id|q0
comma
id|ohci-&gt;self_id_errors
)paren
suffix:semicolon
multiline_comment|/* Tip by James Goodwin &lt;jamesg@Filanet.com&gt;:&n;&t;&t; * We had an error, generate another bus reset in response.  */
r_if
c_cond
(paren
id|ohci-&gt;self_id_errors
OL
id|OHCI1394_MAX_SELF_ID_ERRORS
)paren
(brace
id|set_phy_reg_mask
(paren
id|ohci
comma
l_int|1
comma
l_int|0x40
)paren
suffix:semicolon
id|ohci-&gt;self_id_errors
op_increment
suffix:semicolon
)brace
r_else
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;Too many errors on SelfID error reception, giving up!&quot;
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/* SelfID Ok, reset error counter. */
id|ohci-&gt;self_id_errors
op_assign
l_int|0
suffix:semicolon
id|size
op_assign
(paren
(paren
id|self_id_count
op_amp
l_int|0x00001FFC
)paren
op_rshift
l_int|2
)paren
op_minus
l_int|1
suffix:semicolon
id|q
op_increment
suffix:semicolon
r_while
c_loop
(paren
id|size
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|ohci-&gt;selfid_swap
)paren
(brace
id|q0
op_assign
id|le32_to_cpu
c_func
(paren
id|q
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|q1
op_assign
id|le32_to_cpu
c_func
(paren
id|q
(braket
l_int|1
)braket
)paren
suffix:semicolon
)brace
r_else
(brace
id|q0
op_assign
id|q
(braket
l_int|0
)braket
suffix:semicolon
id|q1
op_assign
id|q
(braket
l_int|1
)braket
suffix:semicolon
)brace
r_if
c_cond
(paren
id|q0
op_eq
op_complement
id|q1
)paren
(brace
id|DBGMSG
(paren
l_string|&quot;SelfID packet 0x%x received&quot;
comma
id|q0
)paren
suffix:semicolon
id|hpsb_selfid_received
c_func
(paren
id|host
comma
id|cpu_to_be32
c_func
(paren
id|q0
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|q0
op_amp
l_int|0x3f000000
)paren
op_rshift
l_int|24
)paren
op_eq
id|phyid
)paren
id|DBGMSG
(paren
l_string|&quot;SelfID for this node is 0x%08x&quot;
comma
id|q0
)paren
suffix:semicolon
)brace
r_else
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;SelfID is inconsistent [0x%08x/0x%08x]&quot;
comma
id|q0
comma
id|q1
)paren
suffix:semicolon
)brace
id|q
op_add_assign
l_int|2
suffix:semicolon
id|size
op_sub_assign
l_int|2
suffix:semicolon
)brace
id|DBGMSG
c_func
(paren
l_string|&quot;SelfID complete&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|ohci_soft_reset
r_static
r_void
id|ohci_soft_reset
c_func
(paren
r_struct
id|ti_ohci
op_star
id|ohci
)paren
(brace
r_int
id|i
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_HCControlSet
comma
id|OHCI1394_HCControl_softReset
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|OHCI_LOOP_COUNT
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_HCControlSet
)paren
op_amp
id|OHCI1394_HCControl_softReset
)paren
)paren
r_break
suffix:semicolon
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
id|DBGMSG
(paren
l_string|&quot;Soft reset finished&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* Generate the dma receive prgs and start the context */
DECL|function|initialize_dma_rcv_ctx
r_static
r_void
id|initialize_dma_rcv_ctx
c_func
(paren
r_struct
id|dma_rcv_ctx
op_star
id|d
comma
r_int
id|generate_irq
)paren
(brace
r_struct
id|ti_ohci
op_star
id|ohci
op_assign
(paren
r_struct
id|ti_ohci
op_star
)paren
(paren
id|d-&gt;ohci
)paren
suffix:semicolon
r_int
id|i
suffix:semicolon
id|ohci1394_stop_context
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlClear
comma
l_int|NULL
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|d-&gt;num_desc
suffix:semicolon
id|i
op_increment
)paren
(brace
id|u32
id|c
suffix:semicolon
id|c
op_assign
id|DMA_CTL_INPUT_MORE
op_or
id|DMA_CTL_UPDATE
op_or
id|DMA_CTL_BRANCH
suffix:semicolon
r_if
c_cond
(paren
id|generate_irq
)paren
id|c
op_or_assign
id|DMA_CTL_IRQ
suffix:semicolon
id|d-&gt;prg_cpu
(braket
id|i
)braket
op_member_access_from_pointer
id|control
op_assign
id|cpu_to_le32
c_func
(paren
id|c
op_or
id|d-&gt;buf_size
)paren
suffix:semicolon
multiline_comment|/* End of descriptor list? */
r_if
c_cond
(paren
id|i
op_plus
l_int|1
OL
id|d-&gt;num_desc
)paren
(brace
id|d-&gt;prg_cpu
(braket
id|i
)braket
op_member_access_from_pointer
id|branchAddress
op_assign
id|cpu_to_le32
c_func
(paren
(paren
id|d-&gt;prg_bus
(braket
id|i
op_plus
l_int|1
)braket
op_amp
l_int|0xfffffff0
)paren
op_or
l_int|0x1
)paren
suffix:semicolon
)brace
r_else
(brace
id|d-&gt;prg_cpu
(braket
id|i
)braket
op_member_access_from_pointer
id|branchAddress
op_assign
id|cpu_to_le32
c_func
(paren
(paren
id|d-&gt;prg_bus
(braket
l_int|0
)braket
op_amp
l_int|0xfffffff0
)paren
)paren
suffix:semicolon
)brace
id|d-&gt;prg_cpu
(braket
id|i
)braket
op_member_access_from_pointer
id|address
op_assign
id|cpu_to_le32
c_func
(paren
id|d-&gt;buf_bus
(braket
id|i
)braket
)paren
suffix:semicolon
id|d-&gt;prg_cpu
(braket
id|i
)braket
op_member_access_from_pointer
id|status
op_assign
id|cpu_to_le32
c_func
(paren
id|d-&gt;buf_size
)paren
suffix:semicolon
)brace
id|d-&gt;buf_ind
op_assign
l_int|0
suffix:semicolon
id|d-&gt;buf_offset
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;type
op_eq
id|DMA_CTX_ISO
)paren
(brace
multiline_comment|/* Clear contextControl */
id|reg_write
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlClear
comma
l_int|0xffffffff
)paren
suffix:semicolon
multiline_comment|/* Set bufferFill, isochHeader, multichannel for IR context */
id|reg_write
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlSet
comma
l_int|0xd0000000
)paren
suffix:semicolon
multiline_comment|/* Set the context match register to match on all tags */
id|reg_write
c_func
(paren
id|ohci
comma
id|d-&gt;ctxtMatch
comma
l_int|0xf0000000
)paren
suffix:semicolon
multiline_comment|/* Clear the multi channel mask high and low registers */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IRMultiChanMaskHiClear
comma
l_int|0xffffffff
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IRMultiChanMaskLoClear
comma
l_int|0xffffffff
)paren
suffix:semicolon
multiline_comment|/* Set up isoRecvIntMask to generate interrupts */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IsoRecvIntMaskSet
comma
l_int|1
op_lshift
id|d-&gt;ctx
)paren
suffix:semicolon
)brace
multiline_comment|/* Tell the controller where the first AR program is */
id|reg_write
c_func
(paren
id|ohci
comma
id|d-&gt;cmdPtr
comma
id|d-&gt;prg_bus
(braket
l_int|0
)braket
op_or
l_int|0x1
)paren
suffix:semicolon
multiline_comment|/* Run context */
id|reg_write
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlSet
comma
l_int|0x00008000
)paren
suffix:semicolon
id|DBGMSG
c_func
(paren
l_string|&quot;Receive DMA ctx=%d initialized&quot;
comma
id|d-&gt;ctx
)paren
suffix:semicolon
)brace
multiline_comment|/* Initialize the dma transmit context */
DECL|function|initialize_dma_trm_ctx
r_static
r_void
id|initialize_dma_trm_ctx
c_func
(paren
r_struct
id|dma_trm_ctx
op_star
id|d
)paren
(brace
r_struct
id|ti_ohci
op_star
id|ohci
op_assign
(paren
r_struct
id|ti_ohci
op_star
)paren
(paren
id|d-&gt;ohci
)paren
suffix:semicolon
multiline_comment|/* Stop the context */
id|ohci1394_stop_context
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlClear
comma
l_int|NULL
)paren
suffix:semicolon
id|d-&gt;prg_ind
op_assign
l_int|0
suffix:semicolon
id|d-&gt;sent_ind
op_assign
l_int|0
suffix:semicolon
id|d-&gt;free_prgs
op_assign
id|d-&gt;num_desc
suffix:semicolon
id|d-&gt;branchAddrPtr
op_assign
l_int|NULL
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|d-&gt;fifo_list
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|d-&gt;pending_list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;type
op_eq
id|DMA_CTX_ISO
)paren
(brace
multiline_comment|/* enable interrupts */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IsoXmitIntMaskSet
comma
l_int|1
op_lshift
id|d-&gt;ctx
)paren
suffix:semicolon
)brace
id|DBGMSG
c_func
(paren
l_string|&quot;Transmit DMA ctx=%d initialized&quot;
comma
id|d-&gt;ctx
)paren
suffix:semicolon
)brace
multiline_comment|/* Count the number of available iso contexts */
DECL|function|get_nb_iso_ctx
r_static
r_int
id|get_nb_iso_ctx
c_func
(paren
r_struct
id|ti_ohci
op_star
id|ohci
comma
r_int
id|reg
)paren
(brace
r_int
id|i
comma
id|ctx
op_assign
l_int|0
suffix:semicolon
id|u32
id|tmp
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|reg
comma
l_int|0xffffffff
)paren
suffix:semicolon
id|tmp
op_assign
id|reg_read
c_func
(paren
id|ohci
comma
id|reg
)paren
suffix:semicolon
id|DBGMSG
c_func
(paren
l_string|&quot;Iso contexts reg: %08x implemented: %08x&quot;
comma
id|reg
comma
id|tmp
)paren
suffix:semicolon
multiline_comment|/* Count the number of contexts */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|tmp
op_amp
l_int|1
)paren
id|ctx
op_increment
suffix:semicolon
id|tmp
op_rshift_assign
l_int|1
suffix:semicolon
)brace
r_return
id|ctx
suffix:semicolon
)brace
multiline_comment|/* Global initialization */
DECL|function|ohci_initialize
r_static
r_void
id|ohci_initialize
c_func
(paren
r_struct
id|ti_ohci
op_star
id|ohci
)paren
(brace
r_char
id|irq_buf
(braket
l_int|16
)braket
suffix:semicolon
id|quadlet_t
id|buf
suffix:semicolon
r_int
id|num_ports
comma
id|i
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|ohci-&gt;phy_reg_lock
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|ohci-&gt;event_lock
)paren
suffix:semicolon
multiline_comment|/* Put some defaults to these undefined bus options */
id|buf
op_assign
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_BusOptions
)paren
suffix:semicolon
id|buf
op_or_assign
l_int|0xE0000000
suffix:semicolon
multiline_comment|/* Enable IRMC, CMC and ISC */
id|buf
op_and_assign
op_complement
l_int|0x00ff0000
suffix:semicolon
multiline_comment|/* XXX: Set cyc_clk_acc to zero for now */
id|buf
op_and_assign
op_complement
l_int|0x18000000
suffix:semicolon
multiline_comment|/* Disable PMC and BMC */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_BusOptions
comma
id|buf
)paren
suffix:semicolon
multiline_comment|/* Set the bus number */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_NodeID
comma
l_int|0x0000ffc0
)paren
suffix:semicolon
multiline_comment|/* Enable posted writes */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_HCControlSet
comma
id|OHCI1394_HCControl_postedWriteEnable
)paren
suffix:semicolon
multiline_comment|/* Clear link control register */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_LinkControlClear
comma
l_int|0xffffffff
)paren
suffix:semicolon
multiline_comment|/* Enable cycle timer and cycle master and set the IRM&n;&t; * contender bit in our self ID packets. */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_LinkControlSet
comma
id|OHCI1394_LinkControl_CycleTimerEnable
op_or
id|OHCI1394_LinkControl_CycleMaster
)paren
suffix:semicolon
id|set_phy_reg_mask
c_func
(paren
id|ohci
comma
l_int|4
comma
l_int|0xc0
)paren
suffix:semicolon
multiline_comment|/* Set up self-id dma buffer */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_SelfIDBuffer
comma
id|ohci-&gt;selfid_buf_bus
)paren
suffix:semicolon
multiline_comment|/* enable self-id and phys */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_LinkControlSet
comma
id|OHCI1394_LinkControl_RcvSelfID
op_or
id|OHCI1394_LinkControl_RcvPhyPkt
)paren
suffix:semicolon
multiline_comment|/* Set the Config ROM mapping register */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_ConfigROMmap
comma
id|ohci-&gt;csr_config_rom_bus
)paren
suffix:semicolon
multiline_comment|/* Now get our max packet size */
id|ohci-&gt;max_packet_size
op_assign
l_int|1
op_lshift
(paren
(paren
(paren
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_BusOptions
)paren
op_rshift
l_int|12
)paren
op_amp
l_int|0xf
)paren
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ohci-&gt;max_packet_size
OL
l_int|512
)paren
(brace
id|HPSB_ERR
c_func
(paren
l_string|&quot;warning: Invalid max packet size of %d, setting to 512&quot;
comma
id|ohci-&gt;max_packet_size
)paren
suffix:semicolon
id|ohci-&gt;max_packet_size
op_assign
l_int|512
suffix:semicolon
)brace
multiline_comment|/* Don&squot;t accept phy packets into AR request context */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_LinkControlClear
comma
l_int|0x00000400
)paren
suffix:semicolon
multiline_comment|/* Clear the interrupt mask */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IsoRecvIntMaskClear
comma
l_int|0xffffffff
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IsoRecvIntEventClear
comma
l_int|0xffffffff
)paren
suffix:semicolon
multiline_comment|/* Clear the interrupt mask */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IsoXmitIntMaskClear
comma
l_int|0xffffffff
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IsoXmitIntEventClear
comma
l_int|0xffffffff
)paren
suffix:semicolon
multiline_comment|/* Initialize AR dma */
id|initialize_dma_rcv_ctx
c_func
(paren
op_amp
id|ohci-&gt;ar_req_context
comma
l_int|0
)paren
suffix:semicolon
id|initialize_dma_rcv_ctx
c_func
(paren
op_amp
id|ohci-&gt;ar_resp_context
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Initialize AT dma */
id|initialize_dma_trm_ctx
c_func
(paren
op_amp
id|ohci-&gt;at_req_context
)paren
suffix:semicolon
id|initialize_dma_trm_ctx
c_func
(paren
op_amp
id|ohci-&gt;at_resp_context
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Accept AT requests from all nodes. This probably&n;&t; * will have to be controlled from the subsystem&n;&t; * on a per node basis.&n;&t; */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_AsReqFilterHiSet
comma
l_int|0x80000000
)paren
suffix:semicolon
multiline_comment|/* Specify AT retries */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_ATRetries
comma
id|OHCI1394_MAX_AT_REQ_RETRIES
op_or
(paren
id|OHCI1394_MAX_AT_RESP_RETRIES
op_lshift
l_int|4
)paren
op_or
(paren
id|OHCI1394_MAX_PHYS_RESP_RETRIES
op_lshift
l_int|8
)paren
)paren
suffix:semicolon
multiline_comment|/* We don&squot;t want hardware swapping */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_HCControlClear
comma
id|OHCI1394_HCControl_noByteSwap
)paren
suffix:semicolon
multiline_comment|/* Enable interrupts */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IntMaskSet
comma
id|OHCI1394_unrecoverableError
op_or
id|OHCI1394_masterIntEnable
op_or
id|OHCI1394_busReset
op_or
id|OHCI1394_selfIDComplete
op_or
id|OHCI1394_RSPkt
op_or
id|OHCI1394_RQPkt
op_or
id|OHCI1394_respTxComplete
op_or
id|OHCI1394_reqTxComplete
op_or
id|OHCI1394_isochRx
op_or
id|OHCI1394_isochTx
op_or
id|OHCI1394_cycleInconsistent
)paren
suffix:semicolon
multiline_comment|/* Enable link */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_HCControlSet
comma
id|OHCI1394_HCControl_linkEnable
)paren
suffix:semicolon
id|buf
op_assign
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_Version
)paren
suffix:semicolon
macro_line|#ifndef __sparc__
id|sprintf
(paren
id|irq_buf
comma
l_string|&quot;%d&quot;
comma
id|ohci-&gt;dev-&gt;irq
)paren
suffix:semicolon
macro_line|#else
id|sprintf
(paren
id|irq_buf
comma
l_string|&quot;%s&quot;
comma
id|__irq_itoa
c_func
(paren
id|ohci-&gt;dev-&gt;irq
)paren
)paren
suffix:semicolon
macro_line|#endif
id|PRINT
c_func
(paren
id|KERN_INFO
comma
l_string|&quot;OHCI-1394 %d.%d (PCI): IRQ=[%s]  &quot;
l_string|&quot;MMIO=[%lx-%lx]  Max Packet=[%d]&quot;
comma
(paren
(paren
(paren
(paren
id|buf
)paren
op_rshift
l_int|16
)paren
op_amp
l_int|0xf
)paren
op_plus
(paren
(paren
(paren
id|buf
)paren
op_rshift
l_int|20
)paren
op_amp
l_int|0xf
)paren
op_star
l_int|10
)paren
comma
(paren
(paren
(paren
(paren
id|buf
)paren
op_rshift
l_int|4
)paren
op_amp
l_int|0xf
)paren
op_plus
(paren
(paren
id|buf
)paren
op_amp
l_int|0xf
)paren
op_star
l_int|10
)paren
comma
id|irq_buf
comma
id|pci_resource_start
c_func
(paren
id|ohci-&gt;dev
comma
l_int|0
)paren
comma
id|pci_resource_start
c_func
(paren
id|ohci-&gt;dev
comma
l_int|0
)paren
op_plus
id|OHCI1394_REGISTER_SIZE
op_minus
l_int|1
comma
id|ohci-&gt;max_packet_size
)paren
suffix:semicolon
multiline_comment|/* Check all of our ports to make sure that if anything is&n;&t; * connected, we enable that port. */
id|num_ports
op_assign
id|get_phy_reg
c_func
(paren
id|ohci
comma
l_int|2
)paren
op_amp
l_int|0xf
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_ports
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
r_int
id|status
suffix:semicolon
id|set_phy_reg
c_func
(paren
id|ohci
comma
l_int|7
comma
id|i
)paren
suffix:semicolon
id|status
op_assign
id|get_phy_reg
c_func
(paren
id|ohci
comma
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
l_int|0x20
)paren
id|set_phy_reg
c_func
(paren
id|ohci
comma
l_int|8
comma
id|status
op_amp
op_complement
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/* Serial EEPROM Sanity check. */
r_if
c_cond
(paren
(paren
id|ohci-&gt;max_packet_size
OL
l_int|512
)paren
op_logical_or
(paren
id|ohci-&gt;max_packet_size
OG
l_int|4096
)paren
)paren
(brace
multiline_comment|/* Serial EEPROM contents are suspect, set a sane max packet&n;&t;&t; * size and print the raw contents for bug reports if verbose&n;&t;&t; * debug is enabled. */
macro_line|#ifdef CONFIG_IEEE1394_VERBOSEDEBUG
r_int
id|i
suffix:semicolon
macro_line|#endif
id|PRINT
c_func
(paren
id|KERN_DEBUG
comma
l_string|&quot;Serial EEPROM has suspicious values, &quot;
l_string|&quot;attempting to setting max_packet_size to 512 bytes&quot;
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_BusOptions
comma
(paren
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_BusOptions
)paren
op_amp
l_int|0xf007
)paren
op_or
l_int|0x8002
)paren
suffix:semicolon
id|ohci-&gt;max_packet_size
op_assign
l_int|512
suffix:semicolon
macro_line|#ifdef CONFIG_IEEE1394_VERBOSEDEBUG
id|PRINT
c_func
(paren
id|KERN_DEBUG
comma
l_string|&quot;    EEPROM Present: %d&quot;
comma
(paren
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_Version
)paren
op_rshift
l_int|24
)paren
op_amp
l_int|0x1
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_GUID_ROM
comma
l_int|0x80000000
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
(paren
id|i
OL
l_int|1000
)paren
op_logical_and
(paren
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_GUID_ROM
)paren
op_amp
l_int|0x80000000
)paren
)paren
suffix:semicolon
id|i
op_increment
)paren
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|0x20
suffix:semicolon
id|i
op_increment
)paren
(brace
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_GUID_ROM
comma
l_int|0x02000000
)paren
suffix:semicolon
id|PRINT
c_func
(paren
id|KERN_DEBUG
comma
l_string|&quot;    EEPROM %02x: %02x&quot;
comma
id|i
comma
(paren
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_GUID_ROM
)paren
op_rshift
l_int|16
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
)brace
macro_line|#endif
)brace
)brace
multiline_comment|/*&n; * Insert a packet in the DMA fifo and generate the DMA prg&n; * FIXME: rewrite the program in order to accept packets crossing&n; *        page boundaries.&n; *        check also that a single dma descriptor doesn&squot;t cross a&n; *        page boundary.&n; */
DECL|function|insert_packet
r_static
r_void
id|insert_packet
c_func
(paren
r_struct
id|ti_ohci
op_star
id|ohci
comma
r_struct
id|dma_trm_ctx
op_star
id|d
comma
r_struct
id|hpsb_packet
op_star
id|packet
)paren
(brace
id|u32
id|cycleTimer
suffix:semicolon
r_int
id|idx
op_assign
id|d-&gt;prg_ind
suffix:semicolon
id|DBGMSG
c_func
(paren
l_string|&quot;Inserting packet for node &quot;
id|NODE_BUS_FMT
l_string|&quot;, tlabel=%d, tcode=0x%x, speed=%d&quot;
comma
id|NODE_BUS_ARGS
c_func
(paren
id|ohci-&gt;host
comma
id|packet-&gt;node_id
)paren
comma
id|packet-&gt;tlabel
comma
id|packet-&gt;tcode
comma
id|packet-&gt;speed_code
)paren
suffix:semicolon
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|begin.address
op_assign
l_int|0
suffix:semicolon
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|begin.branchAddress
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;type
op_eq
id|DMA_CTX_ASYNC_RESP
)paren
(brace
multiline_comment|/*&n;&t;&t; * For response packets, we need to put a timeout value in&n;&t;&t; * the 16 lower bits of the status... let&squot;s try 1 sec timeout&n;&t;&t; */
id|cycleTimer
op_assign
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_IsochronousCycleTimer
)paren
suffix:semicolon
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|begin.status
op_assign
id|cpu_to_le32
c_func
(paren
(paren
(paren
(paren
(paren
(paren
id|cycleTimer
op_rshift
l_int|25
)paren
op_amp
l_int|0x7
)paren
op_plus
l_int|1
)paren
op_amp
l_int|0x7
)paren
op_lshift
l_int|13
)paren
op_or
(paren
(paren
id|cycleTimer
op_amp
l_int|0x01fff000
)paren
op_rshift
l_int|12
)paren
)paren
suffix:semicolon
id|DBGMSG
c_func
(paren
l_string|&quot;cycleTimer: %08x timeStamp: %08x&quot;
comma
id|cycleTimer
comma
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|begin.status
)paren
suffix:semicolon
)brace
r_else
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|begin.status
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|packet-&gt;type
op_eq
id|hpsb_async
)paren
op_logical_or
(paren
id|packet-&gt;type
op_eq
id|hpsb_raw
)paren
)paren
(brace
r_if
c_cond
(paren
id|packet-&gt;type
op_eq
id|hpsb_raw
)paren
(brace
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|data
(braket
l_int|0
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|OHCI1394_TCODE_PHY
op_lshift
l_int|4
)paren
suffix:semicolon
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|data
(braket
l_int|1
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|packet-&gt;header
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|data
(braket
l_int|2
)braket
op_assign
id|cpu_to_le32
c_func
(paren
id|packet-&gt;header
(braket
l_int|1
)braket
)paren
suffix:semicolon
)brace
r_else
(brace
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|data
(braket
l_int|0
)braket
op_assign
id|packet-&gt;speed_code
op_lshift
l_int|16
op_or
(paren
id|packet-&gt;header
(braket
l_int|0
)braket
op_amp
l_int|0xFFFF
)paren
suffix:semicolon
r_if
c_cond
(paren
id|packet-&gt;tcode
op_eq
id|TCODE_ISO_DATA
)paren
(brace
multiline_comment|/* Sending an async stream packet */
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|data
(braket
l_int|1
)braket
op_assign
id|packet-&gt;header
(braket
l_int|0
)braket
op_amp
l_int|0xFFFF0000
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Sending a normal async request or response */
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|data
(braket
l_int|1
)braket
op_assign
(paren
id|packet-&gt;header
(braket
l_int|1
)braket
op_amp
l_int|0xFFFF
)paren
op_or
(paren
id|packet-&gt;header
(braket
l_int|0
)braket
op_amp
l_int|0xFFFF0000
)paren
suffix:semicolon
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|data
(braket
l_int|2
)braket
op_assign
id|packet-&gt;header
(braket
l_int|2
)braket
suffix:semicolon
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|data
(braket
l_int|3
)braket
op_assign
id|packet-&gt;header
(braket
l_int|3
)braket
suffix:semicolon
)brace
id|packet_swab
c_func
(paren
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|data
comma
id|packet-&gt;tcode
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|packet-&gt;data_size
)paren
(brace
multiline_comment|/* block transmit */
r_if
c_cond
(paren
id|packet-&gt;tcode
op_eq
id|TCODE_STREAM_DATA
)paren
(brace
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|begin.control
op_assign
id|cpu_to_le32
c_func
(paren
id|DMA_CTL_OUTPUT_MORE
op_or
id|DMA_CTL_IMMEDIATE
op_or
l_int|0x8
)paren
suffix:semicolon
)brace
r_else
(brace
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|begin.control
op_assign
id|cpu_to_le32
c_func
(paren
id|DMA_CTL_OUTPUT_MORE
op_or
id|DMA_CTL_IMMEDIATE
op_or
l_int|0x10
)paren
suffix:semicolon
)brace
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|end.control
op_assign
id|cpu_to_le32
c_func
(paren
id|DMA_CTL_OUTPUT_LAST
op_or
id|DMA_CTL_IRQ
op_or
id|DMA_CTL_BRANCH
op_or
id|packet-&gt;data_size
)paren
suffix:semicolon
multiline_comment|/*&n;                         * Check that the packet data buffer&n;                         * does not cross a page boundary.&n;&t;&t;&t; *&n;&t;&t;&t; * XXX Fix this some day. eth1394 seems to trigger&n;&t;&t;&t; * it, but ignoring it doesn&squot;t seem to cause a&n;&t;&t;&t; * problem.&n;                         */
macro_line|#if 0
r_if
c_cond
(paren
id|cross_bound
c_func
(paren
(paren
r_int
r_int
)paren
id|packet-&gt;data
comma
id|packet-&gt;data_size
)paren
OG
l_int|0
)paren
(brace
multiline_comment|/* FIXME: do something about it */
id|PRINT
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;%s: packet data addr: %p size %Zd bytes &quot;
l_string|&quot;cross page boundary&quot;
comma
id|__FUNCTION__
comma
id|packet-&gt;data
comma
id|packet-&gt;data_size
)paren
suffix:semicolon
)brace
macro_line|#endif
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|end.address
op_assign
id|cpu_to_le32
c_func
(paren
id|pci_map_single
c_func
(paren
id|ohci-&gt;dev
comma
id|packet-&gt;data
comma
id|packet-&gt;data_size
comma
id|PCI_DMA_TODEVICE
)paren
)paren
suffix:semicolon
id|OHCI_DMA_ALLOC
c_func
(paren
l_string|&quot;single, block transmit packet&quot;
)paren
suffix:semicolon
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|end.branchAddress
op_assign
l_int|0
suffix:semicolon
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|end.status
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;branchAddrPtr
)paren
op_star
(paren
id|d-&gt;branchAddrPtr
)paren
op_assign
id|cpu_to_le32
c_func
(paren
id|d-&gt;prg_bus
(braket
id|idx
)braket
op_or
l_int|0x3
)paren
suffix:semicolon
id|d-&gt;branchAddrPtr
op_assign
op_amp
(paren
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|end.branchAddress
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* quadlet transmit */
r_if
c_cond
(paren
id|packet-&gt;type
op_eq
id|hpsb_raw
)paren
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|begin.control
op_assign
id|cpu_to_le32
c_func
(paren
id|DMA_CTL_OUTPUT_LAST
op_or
id|DMA_CTL_IMMEDIATE
op_or
id|DMA_CTL_IRQ
op_or
id|DMA_CTL_BRANCH
op_or
(paren
id|packet-&gt;header_size
op_plus
l_int|4
)paren
)paren
suffix:semicolon
r_else
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|begin.control
op_assign
id|cpu_to_le32
c_func
(paren
id|DMA_CTL_OUTPUT_LAST
op_or
id|DMA_CTL_IMMEDIATE
op_or
id|DMA_CTL_IRQ
op_or
id|DMA_CTL_BRANCH
op_or
id|packet-&gt;header_size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;branchAddrPtr
)paren
op_star
(paren
id|d-&gt;branchAddrPtr
)paren
op_assign
id|cpu_to_le32
c_func
(paren
id|d-&gt;prg_bus
(braket
id|idx
)braket
op_or
l_int|0x2
)paren
suffix:semicolon
id|d-&gt;branchAddrPtr
op_assign
op_amp
(paren
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|begin.branchAddress
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* iso packet */
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|data
(braket
l_int|0
)braket
op_assign
id|packet-&gt;speed_code
op_lshift
l_int|16
op_or
(paren
id|packet-&gt;header
(braket
l_int|0
)braket
op_amp
l_int|0xFFFF
)paren
suffix:semicolon
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|data
(braket
l_int|1
)braket
op_assign
id|packet-&gt;header
(braket
l_int|0
)braket
op_amp
l_int|0xFFFF0000
suffix:semicolon
id|packet_swab
c_func
(paren
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|data
comma
id|packet-&gt;tcode
)paren
suffix:semicolon
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|begin.control
op_assign
id|cpu_to_le32
c_func
(paren
id|DMA_CTL_OUTPUT_MORE
op_or
id|DMA_CTL_IMMEDIATE
op_or
l_int|0x8
)paren
suffix:semicolon
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|end.control
op_assign
id|cpu_to_le32
c_func
(paren
id|DMA_CTL_OUTPUT_LAST
op_or
id|DMA_CTL_UPDATE
op_or
id|DMA_CTL_IRQ
op_or
id|DMA_CTL_BRANCH
op_or
id|packet-&gt;data_size
)paren
suffix:semicolon
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|end.address
op_assign
id|cpu_to_le32
c_func
(paren
id|pci_map_single
c_func
(paren
id|ohci-&gt;dev
comma
id|packet-&gt;data
comma
id|packet-&gt;data_size
comma
id|PCI_DMA_TODEVICE
)paren
)paren
suffix:semicolon
id|OHCI_DMA_ALLOC
c_func
(paren
l_string|&quot;single, iso transmit packet&quot;
)paren
suffix:semicolon
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|end.branchAddress
op_assign
l_int|0
suffix:semicolon
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|end.status
op_assign
l_int|0
suffix:semicolon
id|DBGMSG
c_func
(paren
l_string|&quot;Iso xmit context info: header[%08x %08x]&bslash;n&quot;
l_string|&quot;                       begin=%08x %08x %08x %08x&bslash;n&quot;
l_string|&quot;                             %08x %08x %08x %08x&bslash;n&quot;
l_string|&quot;                       end  =%08x %08x %08x %08x&quot;
comma
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|data
(braket
l_int|0
)braket
comma
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|data
(braket
l_int|1
)braket
comma
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|begin.control
comma
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|begin.address
comma
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|begin.branchAddress
comma
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|begin.status
comma
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|data
(braket
l_int|0
)braket
comma
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|data
(braket
l_int|1
)braket
comma
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|data
(braket
l_int|2
)braket
comma
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|data
(braket
l_int|3
)braket
comma
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|end.control
comma
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|end.address
comma
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|end.branchAddress
comma
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|end.status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;branchAddrPtr
)paren
op_star
(paren
id|d-&gt;branchAddrPtr
)paren
op_assign
id|cpu_to_le32
c_func
(paren
id|d-&gt;prg_bus
(braket
id|idx
)braket
op_or
l_int|0x3
)paren
suffix:semicolon
id|d-&gt;branchAddrPtr
op_assign
op_amp
(paren
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|end.branchAddress
)paren
suffix:semicolon
)brace
id|d-&gt;free_prgs
op_decrement
suffix:semicolon
multiline_comment|/* queue the packet in the appropriate context queue */
id|list_add_tail
c_func
(paren
op_amp
id|packet-&gt;driver_list
comma
op_amp
id|d-&gt;fifo_list
)paren
suffix:semicolon
id|d-&gt;prg_ind
op_assign
(paren
id|d-&gt;prg_ind
op_plus
l_int|1
)paren
op_mod
id|d-&gt;num_desc
suffix:semicolon
)brace
multiline_comment|/*&n; * This function fills the FIFO with the (eventual) pending packets&n; * and runs or wakes up the DMA prg if necessary.&n; *&n; * The function MUST be called with the d-&gt;lock held.&n; */
DECL|function|dma_trm_flush
r_static
r_void
id|dma_trm_flush
c_func
(paren
r_struct
id|ti_ohci
op_star
id|ohci
comma
r_struct
id|dma_trm_ctx
op_star
id|d
)paren
(brace
r_struct
id|hpsb_packet
op_star
id|packet
comma
op_star
id|ptmp
suffix:semicolon
r_int
id|idx
op_assign
id|d-&gt;prg_ind
suffix:semicolon
r_int
id|z
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* insert the packets into the dma fifo */
id|list_for_each_entry_safe
c_func
(paren
id|packet
comma
id|ptmp
comma
op_amp
id|d-&gt;pending_list
comma
id|driver_list
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|d-&gt;free_prgs
)paren
r_break
suffix:semicolon
multiline_comment|/* For the first packet only */
r_if
c_cond
(paren
op_logical_neg
id|z
)paren
id|z
op_assign
(paren
id|packet-&gt;data_size
)paren
ques
c_cond
l_int|3
suffix:colon
l_int|2
suffix:semicolon
multiline_comment|/* Insert the packet */
id|list_del_init
c_func
(paren
op_amp
id|packet-&gt;driver_list
)paren
suffix:semicolon
id|insert_packet
c_func
(paren
id|ohci
comma
id|d
comma
id|packet
)paren
suffix:semicolon
)brace
multiline_comment|/* Nothing must have been done, either no free_prgs or no packets */
r_if
c_cond
(paren
id|z
op_eq
l_int|0
)paren
r_return
suffix:semicolon
multiline_comment|/* Is the context running ? (should be unless it is&n;&t;   the first packet to be sent in this context) */
r_if
c_cond
(paren
op_logical_neg
(paren
id|reg_read
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlSet
)paren
op_amp
l_int|0x8000
)paren
)paren
(brace
id|u32
id|nodeId
op_assign
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_NodeID
)paren
suffix:semicolon
id|DBGMSG
c_func
(paren
l_string|&quot;Starting transmit DMA ctx=%d&quot;
comma
id|d-&gt;ctx
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|d-&gt;cmdPtr
comma
id|d-&gt;prg_bus
(braket
id|idx
)braket
op_or
id|z
)paren
suffix:semicolon
multiline_comment|/* Check that the node id is valid, and not 63 */
r_if
c_cond
(paren
op_logical_neg
(paren
id|nodeId
op_amp
l_int|0x80000000
)paren
op_logical_or
(paren
id|nodeId
op_amp
l_int|0x3f
)paren
op_eq
l_int|63
)paren
id|PRINT
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;Running dma failed because Node ID is not valid&quot;
)paren
suffix:semicolon
r_else
id|reg_write
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlSet
comma
l_int|0x8000
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Wake up the dma context if necessary */
r_if
c_cond
(paren
op_logical_neg
(paren
id|reg_read
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlSet
)paren
op_amp
l_int|0x400
)paren
)paren
id|DBGMSG
c_func
(paren
l_string|&quot;Waking transmit DMA ctx=%d&quot;
comma
id|d-&gt;ctx
)paren
suffix:semicolon
multiline_comment|/* do this always, to avoid race condition */
id|reg_write
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlSet
comma
l_int|0x1000
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/* Transmission of an async or iso packet */
DECL|function|ohci_transmit
r_static
r_int
id|ohci_transmit
c_func
(paren
r_struct
id|hpsb_host
op_star
id|host
comma
r_struct
id|hpsb_packet
op_star
id|packet
)paren
(brace
r_struct
id|ti_ohci
op_star
id|ohci
op_assign
id|host-&gt;hostdata
suffix:semicolon
r_struct
id|dma_trm_ctx
op_star
id|d
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|packet-&gt;data_size
OG
id|ohci-&gt;max_packet_size
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;Transmit packet size %Zd is too big&quot;
comma
id|packet-&gt;data_size
)paren
suffix:semicolon
r_return
op_minus
id|EOVERFLOW
suffix:semicolon
)brace
multiline_comment|/* Decide whether we have an iso, a request, or a response packet */
r_if
c_cond
(paren
id|packet-&gt;type
op_eq
id|hpsb_raw
)paren
id|d
op_assign
op_amp
id|ohci-&gt;at_req_context
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|packet-&gt;tcode
op_eq
id|TCODE_ISO_DATA
)paren
op_logical_and
(paren
id|packet-&gt;type
op_eq
id|hpsb_iso
)paren
)paren
(brace
multiline_comment|/* The legacy IT DMA context is initialized on first&n;&t;&t; * use.  However, the alloc cannot be run from&n;&t;&t; * interrupt context, so we bail out if that is the&n;&t;&t; * case. I don&squot;t see anyone sending ISO packets from&n;&t;&t; * interrupt context anyway... */
r_if
c_cond
(paren
id|ohci-&gt;it_legacy_context.ohci
op_eq
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|in_interrupt
c_func
(paren
)paren
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;legacy IT context cannot be initialized during interrupt&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|alloc_dma_trm_ctx
c_func
(paren
id|ohci
comma
op_amp
id|ohci-&gt;it_legacy_context
comma
id|DMA_CTX_ISO
comma
l_int|0
comma
id|IT_NUM_DESC
comma
id|OHCI1394_IsoXmitContextBase
)paren
OL
l_int|0
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;error initializing legacy IT context&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|initialize_dma_trm_ctx
c_func
(paren
op_amp
id|ohci-&gt;it_legacy_context
)paren
suffix:semicolon
)brace
id|d
op_assign
op_amp
id|ohci-&gt;it_legacy_context
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|packet-&gt;tcode
op_amp
l_int|0x02
)paren
op_logical_and
(paren
id|packet-&gt;tcode
op_ne
id|TCODE_ISO_DATA
)paren
)paren
id|d
op_assign
op_amp
id|ohci-&gt;at_resp_context
suffix:semicolon
r_else
id|d
op_assign
op_amp
id|ohci-&gt;at_req_context
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|d-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|packet-&gt;driver_list
comma
op_amp
id|d-&gt;pending_list
)paren
suffix:semicolon
id|dma_trm_flush
c_func
(paren
id|ohci
comma
id|d
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|d-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ohci_devctl
r_static
r_int
id|ohci_devctl
c_func
(paren
r_struct
id|hpsb_host
op_star
id|host
comma
r_enum
id|devctl_cmd
id|cmd
comma
r_int
id|arg
)paren
(brace
r_struct
id|ti_ohci
op_star
id|ohci
op_assign
id|host-&gt;hostdata
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|phy_reg
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|RESET_BUS
suffix:colon
r_switch
c_cond
(paren
id|arg
)paren
(brace
r_case
id|SHORT_RESET
suffix:colon
id|phy_reg
op_assign
id|get_phy_reg
c_func
(paren
id|ohci
comma
l_int|5
)paren
suffix:semicolon
id|phy_reg
op_or_assign
l_int|0x40
suffix:semicolon
id|set_phy_reg
c_func
(paren
id|ohci
comma
l_int|5
comma
id|phy_reg
)paren
suffix:semicolon
multiline_comment|/* set ISBR */
r_break
suffix:semicolon
r_case
id|LONG_RESET
suffix:colon
id|phy_reg
op_assign
id|get_phy_reg
c_func
(paren
id|ohci
comma
l_int|1
)paren
suffix:semicolon
id|phy_reg
op_or_assign
l_int|0x40
suffix:semicolon
id|set_phy_reg
c_func
(paren
id|ohci
comma
l_int|1
comma
id|phy_reg
)paren
suffix:semicolon
multiline_comment|/* set IBR */
r_break
suffix:semicolon
r_case
id|SHORT_RESET_NO_FORCE_ROOT
suffix:colon
id|phy_reg
op_assign
id|get_phy_reg
c_func
(paren
id|ohci
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|phy_reg
op_amp
l_int|0x80
)paren
(brace
id|phy_reg
op_and_assign
op_complement
l_int|0x80
suffix:semicolon
id|set_phy_reg
c_func
(paren
id|ohci
comma
l_int|1
comma
id|phy_reg
)paren
suffix:semicolon
multiline_comment|/* clear RHB */
)brace
id|phy_reg
op_assign
id|get_phy_reg
c_func
(paren
id|ohci
comma
l_int|5
)paren
suffix:semicolon
id|phy_reg
op_or_assign
l_int|0x40
suffix:semicolon
id|set_phy_reg
c_func
(paren
id|ohci
comma
l_int|5
comma
id|phy_reg
)paren
suffix:semicolon
multiline_comment|/* set ISBR */
r_break
suffix:semicolon
r_case
id|LONG_RESET_NO_FORCE_ROOT
suffix:colon
id|phy_reg
op_assign
id|get_phy_reg
c_func
(paren
id|ohci
comma
l_int|1
)paren
suffix:semicolon
id|phy_reg
op_and_assign
op_complement
l_int|0x80
suffix:semicolon
id|phy_reg
op_or_assign
l_int|0x40
suffix:semicolon
id|set_phy_reg
c_func
(paren
id|ohci
comma
l_int|1
comma
id|phy_reg
)paren
suffix:semicolon
multiline_comment|/* clear RHB, set IBR */
r_break
suffix:semicolon
r_case
id|SHORT_RESET_FORCE_ROOT
suffix:colon
id|phy_reg
op_assign
id|get_phy_reg
c_func
(paren
id|ohci
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|phy_reg
op_amp
l_int|0x80
)paren
)paren
(brace
id|phy_reg
op_or_assign
l_int|0x80
suffix:semicolon
id|set_phy_reg
c_func
(paren
id|ohci
comma
l_int|1
comma
id|phy_reg
)paren
suffix:semicolon
multiline_comment|/* set RHB */
)brace
id|phy_reg
op_assign
id|get_phy_reg
c_func
(paren
id|ohci
comma
l_int|5
)paren
suffix:semicolon
id|phy_reg
op_or_assign
l_int|0x40
suffix:semicolon
id|set_phy_reg
c_func
(paren
id|ohci
comma
l_int|5
comma
id|phy_reg
)paren
suffix:semicolon
multiline_comment|/* set ISBR */
r_break
suffix:semicolon
r_case
id|LONG_RESET_FORCE_ROOT
suffix:colon
id|phy_reg
op_assign
id|get_phy_reg
c_func
(paren
id|ohci
comma
l_int|1
)paren
suffix:semicolon
id|phy_reg
op_or_assign
l_int|0xc0
suffix:semicolon
id|set_phy_reg
c_func
(paren
id|ohci
comma
l_int|1
comma
id|phy_reg
)paren
suffix:semicolon
multiline_comment|/* set RHB and IBR */
r_break
suffix:semicolon
r_default
suffix:colon
id|retval
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|GET_CYCLE_COUNTER
suffix:colon
id|retval
op_assign
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_IsochronousCycleTimer
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SET_CYCLE_COUNTER
suffix:colon
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IsochronousCycleTimer
comma
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SET_BUS_ID
suffix:colon
id|PRINT
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;devctl command SET_BUS_ID err&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACT_CYCLE_MASTER
suffix:colon
r_if
c_cond
(paren
id|arg
)paren
(brace
multiline_comment|/* check if we are root and other nodes are present */
id|u32
id|nodeId
op_assign
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_NodeID
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|nodeId
op_amp
(paren
l_int|1
op_lshift
l_int|30
)paren
)paren
op_logical_and
(paren
id|nodeId
op_amp
l_int|0x3f
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t;&t;&t; * enable cycleTimer, cycleMaster&n;&t;&t;&t;&t; */
id|DBGMSG
c_func
(paren
l_string|&quot;Cycle master enabled&quot;
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_LinkControlSet
comma
id|OHCI1394_LinkControl_CycleTimerEnable
op_or
id|OHCI1394_LinkControl_CycleMaster
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* disable cycleTimer, cycleMaster, cycleSource */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_LinkControlClear
comma
id|OHCI1394_LinkControl_CycleTimerEnable
op_or
id|OHCI1394_LinkControl_CycleMaster
op_or
id|OHCI1394_LinkControl_CycleSource
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|CANCEL_REQUESTS
suffix:colon
id|DBGMSG
c_func
(paren
l_string|&quot;Cancel request received&quot;
)paren
suffix:semicolon
id|dma_trm_reset
c_func
(paren
op_amp
id|ohci-&gt;at_req_context
)paren
suffix:semicolon
id|dma_trm_reset
c_func
(paren
op_amp
id|ohci-&gt;at_resp_context
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ISO_LISTEN_CHANNEL
suffix:colon
(brace
id|u64
id|mask
suffix:semicolon
r_if
c_cond
(paren
id|arg
l_int|63
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;%s: IS0 listen channel %d is out of range&quot;
comma
id|__FUNCTION__
comma
id|arg
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
multiline_comment|/* activate the legacy IR context */
r_if
c_cond
(paren
id|ohci-&gt;ir_legacy_context.ohci
op_eq
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|alloc_dma_rcv_ctx
c_func
(paren
id|ohci
comma
op_amp
id|ohci-&gt;ir_legacy_context
comma
id|DMA_CTX_ISO
comma
l_int|0
comma
id|IR_NUM_DESC
comma
id|IR_BUF_SIZE
comma
id|IR_SPLIT_BUF_SIZE
comma
id|OHCI1394_IsoRcvContextBase
)paren
OL
l_int|0
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;%s: failed to allocate an IR context&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|ohci-&gt;ir_legacy_channels
op_assign
l_int|0
suffix:semicolon
id|initialize_dma_rcv_ctx
c_func
(paren
op_amp
id|ohci-&gt;ir_legacy_context
comma
l_int|1
)paren
suffix:semicolon
id|DBGMSG
c_func
(paren
l_string|&quot;ISO receive legacy context activated&quot;
)paren
suffix:semicolon
)brace
id|mask
op_assign
(paren
id|u64
)paren
l_int|0x1
op_lshift
id|arg
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ohci-&gt;IR_channel_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ohci-&gt;ISO_channel_usage
op_amp
id|mask
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;%s: IS0 listen channel %d is already used&quot;
comma
id|__FUNCTION__
comma
id|arg
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ohci-&gt;IR_channel_lock
comma
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|ohci-&gt;ISO_channel_usage
op_or_assign
id|mask
suffix:semicolon
id|ohci-&gt;ir_legacy_channels
op_or_assign
id|mask
suffix:semicolon
r_if
c_cond
(paren
id|arg
OG
l_int|31
)paren
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IRMultiChanMaskHiSet
comma
l_int|1
op_lshift
(paren
id|arg
op_minus
l_int|32
)paren
)paren
suffix:semicolon
r_else
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IRMultiChanMaskLoSet
comma
l_int|1
op_lshift
id|arg
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ohci-&gt;IR_channel_lock
comma
id|flags
)paren
suffix:semicolon
id|DBGMSG
c_func
(paren
l_string|&quot;Listening enabled on channel %d&quot;
comma
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
id|ISO_UNLISTEN_CHANNEL
suffix:colon
(brace
id|u64
id|mask
suffix:semicolon
r_if
c_cond
(paren
id|arg
l_int|63
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;%s: IS0 unlisten channel %d is out of range&quot;
comma
id|__FUNCTION__
comma
id|arg
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|mask
op_assign
(paren
id|u64
)paren
l_int|0x1
op_lshift
id|arg
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ohci-&gt;IR_channel_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|ohci-&gt;ISO_channel_usage
op_amp
id|mask
)paren
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;%s: IS0 unlisten channel %d is not used&quot;
comma
id|__FUNCTION__
comma
id|arg
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ohci-&gt;IR_channel_lock
comma
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|ohci-&gt;ISO_channel_usage
op_and_assign
op_complement
id|mask
suffix:semicolon
id|ohci-&gt;ir_legacy_channels
op_and_assign
op_complement
id|mask
suffix:semicolon
r_if
c_cond
(paren
id|arg
OG
l_int|31
)paren
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IRMultiChanMaskHiClear
comma
l_int|1
op_lshift
(paren
id|arg
op_minus
l_int|32
)paren
)paren
suffix:semicolon
r_else
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IRMultiChanMaskLoClear
comma
l_int|1
op_lshift
id|arg
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ohci-&gt;IR_channel_lock
comma
id|flags
)paren
suffix:semicolon
id|DBGMSG
c_func
(paren
l_string|&quot;Listening disabled on channel %d&quot;
comma
id|arg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ohci-&gt;ir_legacy_channels
op_eq
l_int|0
)paren
(brace
id|stop_dma_rcv_ctx
c_func
(paren
op_amp
id|ohci-&gt;ir_legacy_context
)paren
suffix:semicolon
id|free_dma_rcv_ctx
c_func
(paren
op_amp
id|ohci-&gt;ir_legacy_context
)paren
suffix:semicolon
id|DBGMSG
c_func
(paren
l_string|&quot;ISO receive legacy context deactivated&quot;
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_default
suffix:colon
id|PRINT_G
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;ohci_devctl cmd %d not implemented yet&quot;
comma
id|cmd
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/***********************************&n; * rawiso ISO reception            *&n; ***********************************/
multiline_comment|/*&n;  We use either buffer-fill or packet-per-buffer DMA mode. The DMA&n;  buffer is split into &quot;blocks&quot; (regions described by one DMA&n;  descriptor). Each block must be one page or less in size, and&n;  must not cross a page boundary.&n;&n;  There is one little wrinkle with buffer-fill mode: a packet that&n;  starts in the final block may wrap around into the first block. But&n;  the user API expects all packets to be contiguous. Our solution is&n;  to keep the very last page of the DMA buffer in reserve - if a&n;  packet spans the gap, we copy its tail into this page.&n;*/
DECL|struct|ohci_iso_recv
r_struct
id|ohci_iso_recv
(brace
DECL|member|ohci
r_struct
id|ti_ohci
op_star
id|ohci
suffix:semicolon
DECL|member|task
r_struct
id|ohci1394_iso_tasklet
id|task
suffix:semicolon
DECL|member|task_active
r_int
id|task_active
suffix:semicolon
DECL|enumerator|BUFFER_FILL_MODE
r_enum
(brace
id|BUFFER_FILL_MODE
op_assign
l_int|0
comma
DECL|enumerator|PACKET_PER_BUFFER_MODE
DECL|member|dma_mode
id|PACKET_PER_BUFFER_MODE
op_assign
l_int|1
)brace
id|dma_mode
suffix:semicolon
multiline_comment|/* memory and PCI mapping for the DMA descriptors */
DECL|member|prog
r_struct
id|dma_prog_region
id|prog
suffix:semicolon
DECL|member|block
r_struct
id|dma_cmd
op_star
id|block
suffix:semicolon
multiline_comment|/* = (struct dma_cmd*) prog.virt */
multiline_comment|/* how many DMA blocks fit in the buffer */
DECL|member|nblocks
r_int
r_int
id|nblocks
suffix:semicolon
multiline_comment|/* stride of DMA blocks */
DECL|member|buf_stride
r_int
r_int
id|buf_stride
suffix:semicolon
multiline_comment|/* number of blocks to batch between interrupts */
DECL|member|block_irq_interval
r_int
id|block_irq_interval
suffix:semicolon
multiline_comment|/* block that DMA will finish next */
DECL|member|block_dma
r_int
id|block_dma
suffix:semicolon
multiline_comment|/* (buffer-fill only) block that the reader will release next */
DECL|member|block_reader
r_int
id|block_reader
suffix:semicolon
multiline_comment|/* (buffer-fill only) bytes of buffer the reader has released,&n;&t;   less than one block */
DECL|member|released_bytes
r_int
id|released_bytes
suffix:semicolon
multiline_comment|/* (buffer-fill only) buffer offset at which the next packet will appear */
DECL|member|dma_offset
r_int
id|dma_offset
suffix:semicolon
multiline_comment|/* OHCI DMA context control registers */
DECL|member|ContextControlSet
id|u32
id|ContextControlSet
suffix:semicolon
DECL|member|ContextControlClear
id|u32
id|ContextControlClear
suffix:semicolon
DECL|member|CommandPtr
id|u32
id|CommandPtr
suffix:semicolon
DECL|member|ContextMatch
id|u32
id|ContextMatch
suffix:semicolon
)brace
suffix:semicolon
r_static
r_void
id|ohci_iso_recv_task
c_func
(paren
r_int
r_int
id|data
)paren
suffix:semicolon
r_static
r_void
id|ohci_iso_recv_stop
c_func
(paren
r_struct
id|hpsb_iso
op_star
id|iso
)paren
suffix:semicolon
r_static
r_void
id|ohci_iso_recv_shutdown
c_func
(paren
r_struct
id|hpsb_iso
op_star
id|iso
)paren
suffix:semicolon
r_static
r_int
id|ohci_iso_recv_start
c_func
(paren
r_struct
id|hpsb_iso
op_star
id|iso
comma
r_int
id|cycle
comma
r_int
id|tag_mask
comma
r_int
id|sync
)paren
suffix:semicolon
r_static
r_void
id|ohci_iso_recv_program
c_func
(paren
r_struct
id|hpsb_iso
op_star
id|iso
)paren
suffix:semicolon
DECL|function|ohci_iso_recv_init
r_static
r_int
id|ohci_iso_recv_init
c_func
(paren
r_struct
id|hpsb_iso
op_star
id|iso
)paren
(brace
r_struct
id|ti_ohci
op_star
id|ohci
op_assign
id|iso-&gt;host-&gt;hostdata
suffix:semicolon
r_struct
id|ohci_iso_recv
op_star
id|recv
suffix:semicolon
r_int
id|ctx
suffix:semicolon
r_int
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
id|recv
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|recv
)paren
comma
id|SLAB_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|recv
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|iso-&gt;hostdata
op_assign
id|recv
suffix:semicolon
id|recv-&gt;ohci
op_assign
id|ohci
suffix:semicolon
id|recv-&gt;task_active
op_assign
l_int|0
suffix:semicolon
id|dma_prog_region_init
c_func
(paren
op_amp
id|recv-&gt;prog
)paren
suffix:semicolon
id|recv-&gt;block
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* use buffer-fill mode, unless irq_interval is 1&n;&t;   (note: multichannel requires buffer-fill) */
r_if
c_cond
(paren
(paren
(paren
id|iso-&gt;irq_interval
op_eq
l_int|1
op_logical_and
id|iso-&gt;dma_mode
op_eq
id|HPSB_ISO_DMA_OLD_ABI
)paren
op_logical_or
id|iso-&gt;dma_mode
op_eq
id|HPSB_ISO_DMA_PACKET_PER_BUFFER
)paren
op_logical_and
id|iso-&gt;channel
op_ne
op_minus
l_int|1
)paren
(brace
id|recv-&gt;dma_mode
op_assign
id|PACKET_PER_BUFFER_MODE
suffix:semicolon
)brace
r_else
(brace
id|recv-&gt;dma_mode
op_assign
id|BUFFER_FILL_MODE
suffix:semicolon
)brace
multiline_comment|/* set nblocks, buf_stride, block_irq_interval */
r_if
c_cond
(paren
id|recv-&gt;dma_mode
op_eq
id|BUFFER_FILL_MODE
)paren
(brace
id|recv-&gt;buf_stride
op_assign
id|PAGE_SIZE
suffix:semicolon
multiline_comment|/* one block per page of data in the DMA buffer, minus the final guard page */
id|recv-&gt;nblocks
op_assign
id|iso-&gt;buf_size
op_div
id|PAGE_SIZE
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|recv-&gt;nblocks
OL
l_int|3
)paren
(brace
id|DBGMSG
c_func
(paren
l_string|&quot;ohci_iso_recv_init: DMA buffer too small&quot;
)paren
suffix:semicolon
r_goto
id|err
suffix:semicolon
)brace
multiline_comment|/* iso-&gt;irq_interval is in packets - translate that to blocks */
r_if
c_cond
(paren
id|iso-&gt;irq_interval
op_eq
l_int|1
)paren
id|recv-&gt;block_irq_interval
op_assign
l_int|1
suffix:semicolon
r_else
id|recv-&gt;block_irq_interval
op_assign
id|iso-&gt;irq_interval
op_star
(paren
(paren
id|recv-&gt;nblocks
op_plus
l_int|1
)paren
op_div
id|iso-&gt;buf_packets
)paren
suffix:semicolon
r_if
c_cond
(paren
id|recv-&gt;block_irq_interval
op_star
l_int|4
OG
id|recv-&gt;nblocks
)paren
id|recv-&gt;block_irq_interval
op_assign
id|recv-&gt;nblocks
op_div
l_int|4
suffix:semicolon
r_if
c_cond
(paren
id|recv-&gt;block_irq_interval
OL
l_int|1
)paren
id|recv-&gt;block_irq_interval
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
r_int
id|max_packet_size
suffix:semicolon
id|recv-&gt;nblocks
op_assign
id|iso-&gt;buf_packets
suffix:semicolon
id|recv-&gt;block_irq_interval
op_assign
id|iso-&gt;irq_interval
suffix:semicolon
r_if
c_cond
(paren
id|recv-&gt;block_irq_interval
op_star
l_int|4
OG
id|iso-&gt;buf_packets
)paren
id|recv-&gt;block_irq_interval
op_assign
id|iso-&gt;buf_packets
op_div
l_int|4
suffix:semicolon
r_if
c_cond
(paren
id|recv-&gt;block_irq_interval
OL
l_int|1
)paren
id|recv-&gt;block_irq_interval
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* choose a buffer stride */
multiline_comment|/* must be a power of 2, and &lt;= PAGE_SIZE */
id|max_packet_size
op_assign
id|iso-&gt;buf_size
op_div
id|iso-&gt;buf_packets
suffix:semicolon
r_for
c_loop
(paren
id|recv-&gt;buf_stride
op_assign
l_int|8
suffix:semicolon
id|recv-&gt;buf_stride
OL
id|max_packet_size
suffix:semicolon
id|recv-&gt;buf_stride
op_mul_assign
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|recv-&gt;buf_stride
op_star
id|iso-&gt;buf_packets
OG
id|iso-&gt;buf_size
op_logical_or
id|recv-&gt;buf_stride
OG
id|PAGE_SIZE
)paren
(brace
multiline_comment|/* this shouldn&squot;t happen, but anyway... */
id|DBGMSG
c_func
(paren
l_string|&quot;ohci_iso_recv_init: problem choosing a buffer stride&quot;
)paren
suffix:semicolon
r_goto
id|err
suffix:semicolon
)brace
)brace
id|recv-&gt;block_reader
op_assign
l_int|0
suffix:semicolon
id|recv-&gt;released_bytes
op_assign
l_int|0
suffix:semicolon
id|recv-&gt;block_dma
op_assign
l_int|0
suffix:semicolon
id|recv-&gt;dma_offset
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* size of DMA program = one descriptor per block */
r_if
c_cond
(paren
id|dma_prog_region_alloc
c_func
(paren
op_amp
id|recv-&gt;prog
comma
r_sizeof
(paren
r_struct
id|dma_cmd
)paren
op_star
id|recv-&gt;nblocks
comma
id|recv-&gt;ohci-&gt;dev
)paren
)paren
r_goto
id|err
suffix:semicolon
id|recv-&gt;block
op_assign
(paren
r_struct
id|dma_cmd
op_star
)paren
id|recv-&gt;prog.kvirt
suffix:semicolon
id|ohci1394_init_iso_tasklet
c_func
(paren
op_amp
id|recv-&gt;task
comma
id|iso-&gt;channel
op_eq
op_minus
l_int|1
ques
c_cond
id|OHCI_ISO_MULTICHANNEL_RECEIVE
suffix:colon
id|OHCI_ISO_RECEIVE
comma
id|ohci_iso_recv_task
comma
(paren
r_int
r_int
)paren
id|iso
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ohci1394_register_iso_tasklet
c_func
(paren
id|recv-&gt;ohci
comma
op_amp
id|recv-&gt;task
)paren
OL
l_int|0
)paren
r_goto
id|err
suffix:semicolon
id|recv-&gt;task_active
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* recv context registers are spaced 32 bytes apart */
id|ctx
op_assign
id|recv-&gt;task.context
suffix:semicolon
id|recv-&gt;ContextControlSet
op_assign
id|OHCI1394_IsoRcvContextControlSet
op_plus
l_int|32
op_star
id|ctx
suffix:semicolon
id|recv-&gt;ContextControlClear
op_assign
id|OHCI1394_IsoRcvContextControlClear
op_plus
l_int|32
op_star
id|ctx
suffix:semicolon
id|recv-&gt;CommandPtr
op_assign
id|OHCI1394_IsoRcvCommandPtr
op_plus
l_int|32
op_star
id|ctx
suffix:semicolon
id|recv-&gt;ContextMatch
op_assign
id|OHCI1394_IsoRcvContextMatch
op_plus
l_int|32
op_star
id|ctx
suffix:semicolon
r_if
c_cond
(paren
id|iso-&gt;channel
op_eq
op_minus
l_int|1
)paren
(brace
multiline_comment|/* clear multi-channel selection mask */
id|reg_write
c_func
(paren
id|recv-&gt;ohci
comma
id|OHCI1394_IRMultiChanMaskHiClear
comma
l_int|0xFFFFFFFF
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|recv-&gt;ohci
comma
id|OHCI1394_IRMultiChanMaskLoClear
comma
l_int|0xFFFFFFFF
)paren
suffix:semicolon
)brace
multiline_comment|/* write the DMA program */
id|ohci_iso_recv_program
c_func
(paren
id|iso
)paren
suffix:semicolon
id|DBGMSG
c_func
(paren
l_string|&quot;ohci_iso_recv_init: %s mode, DMA buffer is %lu pages&quot;
l_string|&quot; (%u bytes), using %u blocks, buf_stride %u, block_irq_interval %d&quot;
comma
id|recv-&gt;dma_mode
op_eq
id|BUFFER_FILL_MODE
ques
c_cond
l_string|&quot;buffer-fill&quot;
suffix:colon
l_string|&quot;packet-per-buffer&quot;
comma
id|iso-&gt;buf_size
op_div
id|PAGE_SIZE
comma
id|iso-&gt;buf_size
comma
id|recv-&gt;nblocks
comma
id|recv-&gt;buf_stride
comma
id|recv-&gt;block_irq_interval
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|err
suffix:colon
id|ohci_iso_recv_shutdown
c_func
(paren
id|iso
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|ohci_iso_recv_stop
r_static
r_void
id|ohci_iso_recv_stop
c_func
(paren
r_struct
id|hpsb_iso
op_star
id|iso
)paren
(brace
r_struct
id|ohci_iso_recv
op_star
id|recv
op_assign
id|iso-&gt;hostdata
suffix:semicolon
multiline_comment|/* disable interrupts */
id|reg_write
c_func
(paren
id|recv-&gt;ohci
comma
id|OHCI1394_IsoRecvIntMaskClear
comma
l_int|1
op_lshift
id|recv-&gt;task.context
)paren
suffix:semicolon
multiline_comment|/* halt DMA */
id|ohci1394_stop_context
c_func
(paren
id|recv-&gt;ohci
comma
id|recv-&gt;ContextControlClear
comma
l_int|NULL
)paren
suffix:semicolon
)brace
DECL|function|ohci_iso_recv_shutdown
r_static
r_void
id|ohci_iso_recv_shutdown
c_func
(paren
r_struct
id|hpsb_iso
op_star
id|iso
)paren
(brace
r_struct
id|ohci_iso_recv
op_star
id|recv
op_assign
id|iso-&gt;hostdata
suffix:semicolon
r_if
c_cond
(paren
id|recv-&gt;task_active
)paren
(brace
id|ohci_iso_recv_stop
c_func
(paren
id|iso
)paren
suffix:semicolon
id|ohci1394_unregister_iso_tasklet
c_func
(paren
id|recv-&gt;ohci
comma
op_amp
id|recv-&gt;task
)paren
suffix:semicolon
id|recv-&gt;task_active
op_assign
l_int|0
suffix:semicolon
)brace
id|dma_prog_region_free
c_func
(paren
op_amp
id|recv-&gt;prog
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|recv
)paren
suffix:semicolon
id|iso-&gt;hostdata
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* set up a &quot;gapped&quot; ring buffer DMA program */
DECL|function|ohci_iso_recv_program
r_static
r_void
id|ohci_iso_recv_program
c_func
(paren
r_struct
id|hpsb_iso
op_star
id|iso
)paren
(brace
r_struct
id|ohci_iso_recv
op_star
id|recv
op_assign
id|iso-&gt;hostdata
suffix:semicolon
r_int
id|blk
suffix:semicolon
multiline_comment|/* address of &squot;branch&squot; field in previous DMA descriptor */
id|u32
op_star
id|prev_branch
op_assign
l_int|NULL
suffix:semicolon
r_for
c_loop
(paren
id|blk
op_assign
l_int|0
suffix:semicolon
id|blk
OL
id|recv-&gt;nblocks
suffix:semicolon
id|blk
op_increment
)paren
(brace
id|u32
id|control
suffix:semicolon
multiline_comment|/* the DMA descriptor */
r_struct
id|dma_cmd
op_star
id|cmd
op_assign
op_amp
id|recv-&gt;block
(braket
id|blk
)braket
suffix:semicolon
multiline_comment|/* offset of the DMA descriptor relative to the DMA prog buffer */
r_int
r_int
id|prog_offset
op_assign
id|blk
op_star
r_sizeof
(paren
r_struct
id|dma_cmd
)paren
suffix:semicolon
multiline_comment|/* offset of this packet&squot;s data within the DMA buffer */
r_int
r_int
id|buf_offset
op_assign
id|blk
op_star
id|recv-&gt;buf_stride
suffix:semicolon
r_if
c_cond
(paren
id|recv-&gt;dma_mode
op_eq
id|BUFFER_FILL_MODE
)paren
(brace
id|control
op_assign
l_int|2
op_lshift
l_int|28
suffix:semicolon
multiline_comment|/* INPUT_MORE */
)brace
r_else
(brace
id|control
op_assign
l_int|3
op_lshift
l_int|28
suffix:semicolon
multiline_comment|/* INPUT_LAST */
)brace
id|control
op_or_assign
l_int|8
op_lshift
l_int|24
suffix:semicolon
multiline_comment|/* s = 1, update xferStatus and resCount */
multiline_comment|/* interrupt on last block, and at intervals */
r_if
c_cond
(paren
id|blk
op_eq
id|recv-&gt;nblocks
op_minus
l_int|1
op_logical_or
(paren
id|blk
op_mod
id|recv-&gt;block_irq_interval
)paren
op_eq
l_int|0
)paren
(brace
id|control
op_or_assign
l_int|3
op_lshift
l_int|20
suffix:semicolon
multiline_comment|/* want interrupt */
)brace
id|control
op_or_assign
l_int|3
op_lshift
l_int|18
suffix:semicolon
multiline_comment|/* enable branch to address */
id|control
op_or_assign
id|recv-&gt;buf_stride
suffix:semicolon
id|cmd-&gt;control
op_assign
id|cpu_to_le32
c_func
(paren
id|control
)paren
suffix:semicolon
id|cmd-&gt;address
op_assign
id|cpu_to_le32
c_func
(paren
id|dma_region_offset_to_bus
c_func
(paren
op_amp
id|iso-&gt;data_buf
comma
id|buf_offset
)paren
)paren
suffix:semicolon
id|cmd-&gt;branchAddress
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* filled in on next loop */
id|cmd-&gt;status
op_assign
id|cpu_to_le32
c_func
(paren
id|recv-&gt;buf_stride
)paren
suffix:semicolon
multiline_comment|/* link the previous descriptor to this one */
r_if
c_cond
(paren
id|prev_branch
)paren
(brace
op_star
id|prev_branch
op_assign
id|cpu_to_le32
c_func
(paren
id|dma_prog_region_offset_to_bus
c_func
(paren
op_amp
id|recv-&gt;prog
comma
id|prog_offset
)paren
op_or
l_int|1
)paren
suffix:semicolon
)brace
id|prev_branch
op_assign
op_amp
id|cmd-&gt;branchAddress
suffix:semicolon
)brace
multiline_comment|/* the final descriptor&squot;s branch address and Z should be left at 0 */
)brace
multiline_comment|/* listen or unlisten to a specific channel (multi-channel mode only) */
DECL|function|ohci_iso_recv_change_channel
r_static
r_void
id|ohci_iso_recv_change_channel
c_func
(paren
r_struct
id|hpsb_iso
op_star
id|iso
comma
r_int
r_char
id|channel
comma
r_int
id|listen
)paren
(brace
r_struct
id|ohci_iso_recv
op_star
id|recv
op_assign
id|iso-&gt;hostdata
suffix:semicolon
r_int
id|reg
comma
id|i
suffix:semicolon
r_if
c_cond
(paren
id|channel
OL
l_int|32
)paren
(brace
id|reg
op_assign
id|listen
ques
c_cond
id|OHCI1394_IRMultiChanMaskLoSet
suffix:colon
id|OHCI1394_IRMultiChanMaskLoClear
suffix:semicolon
id|i
op_assign
id|channel
suffix:semicolon
)brace
r_else
(brace
id|reg
op_assign
id|listen
ques
c_cond
id|OHCI1394_IRMultiChanMaskHiSet
suffix:colon
id|OHCI1394_IRMultiChanMaskHiClear
suffix:semicolon
id|i
op_assign
id|channel
op_minus
l_int|32
suffix:semicolon
)brace
id|reg_write
c_func
(paren
id|recv-&gt;ohci
comma
id|reg
comma
(paren
l_int|1
op_lshift
id|i
)paren
)paren
suffix:semicolon
multiline_comment|/* issue a dummy read to force all PCI writes to be posted immediately */
id|mb
c_func
(paren
)paren
suffix:semicolon
id|reg_read
c_func
(paren
id|recv-&gt;ohci
comma
id|OHCI1394_IsochronousCycleTimer
)paren
suffix:semicolon
)brace
DECL|function|ohci_iso_recv_set_channel_mask
r_static
r_void
id|ohci_iso_recv_set_channel_mask
c_func
(paren
r_struct
id|hpsb_iso
op_star
id|iso
comma
id|u64
id|mask
)paren
(brace
r_struct
id|ohci_iso_recv
op_star
id|recv
op_assign
id|iso-&gt;hostdata
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|64
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|mask
op_amp
(paren
l_int|1ULL
op_lshift
id|i
)paren
)paren
(brace
r_if
c_cond
(paren
id|i
OL
l_int|32
)paren
id|reg_write
c_func
(paren
id|recv-&gt;ohci
comma
id|OHCI1394_IRMultiChanMaskLoSet
comma
(paren
l_int|1
op_lshift
id|i
)paren
)paren
suffix:semicolon
r_else
id|reg_write
c_func
(paren
id|recv-&gt;ohci
comma
id|OHCI1394_IRMultiChanMaskHiSet
comma
(paren
l_int|1
op_lshift
(paren
id|i
op_minus
l_int|32
)paren
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|i
OL
l_int|32
)paren
id|reg_write
c_func
(paren
id|recv-&gt;ohci
comma
id|OHCI1394_IRMultiChanMaskLoClear
comma
(paren
l_int|1
op_lshift
id|i
)paren
)paren
suffix:semicolon
r_else
id|reg_write
c_func
(paren
id|recv-&gt;ohci
comma
id|OHCI1394_IRMultiChanMaskHiClear
comma
(paren
l_int|1
op_lshift
(paren
id|i
op_minus
l_int|32
)paren
)paren
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* issue a dummy read to force all PCI writes to be posted immediately */
id|mb
c_func
(paren
)paren
suffix:semicolon
id|reg_read
c_func
(paren
id|recv-&gt;ohci
comma
id|OHCI1394_IsochronousCycleTimer
)paren
suffix:semicolon
)brace
DECL|function|ohci_iso_recv_start
r_static
r_int
id|ohci_iso_recv_start
c_func
(paren
r_struct
id|hpsb_iso
op_star
id|iso
comma
r_int
id|cycle
comma
r_int
id|tag_mask
comma
r_int
id|sync
)paren
(brace
r_struct
id|ohci_iso_recv
op_star
id|recv
op_assign
id|iso-&gt;hostdata
suffix:semicolon
r_struct
id|ti_ohci
op_star
id|ohci
op_assign
id|recv-&gt;ohci
suffix:semicolon
id|u32
id|command
comma
id|contextMatch
suffix:semicolon
id|reg_write
c_func
(paren
id|recv-&gt;ohci
comma
id|recv-&gt;ContextControlClear
comma
l_int|0xFFFFFFFF
)paren
suffix:semicolon
id|wmb
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* always keep ISO headers */
id|command
op_assign
(paren
l_int|1
op_lshift
l_int|30
)paren
suffix:semicolon
r_if
c_cond
(paren
id|recv-&gt;dma_mode
op_eq
id|BUFFER_FILL_MODE
)paren
id|command
op_or_assign
(paren
l_int|1
op_lshift
l_int|31
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|recv-&gt;ohci
comma
id|recv-&gt;ContextControlSet
comma
id|command
)paren
suffix:semicolon
multiline_comment|/* match on specified tags */
id|contextMatch
op_assign
id|tag_mask
op_lshift
l_int|28
suffix:semicolon
r_if
c_cond
(paren
id|iso-&gt;channel
op_eq
op_minus
l_int|1
)paren
(brace
multiline_comment|/* enable multichannel reception */
id|reg_write
c_func
(paren
id|recv-&gt;ohci
comma
id|recv-&gt;ContextControlSet
comma
(paren
l_int|1
op_lshift
l_int|28
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* listen on channel */
id|contextMatch
op_or_assign
id|iso-&gt;channel
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cycle
op_ne
op_minus
l_int|1
)paren
(brace
id|u32
id|seconds
suffix:semicolon
multiline_comment|/* enable cycleMatch */
id|reg_write
c_func
(paren
id|recv-&gt;ohci
comma
id|recv-&gt;ContextControlSet
comma
(paren
l_int|1
op_lshift
l_int|29
)paren
)paren
suffix:semicolon
multiline_comment|/* set starting cycle */
id|cycle
op_and_assign
l_int|0x1FFF
suffix:semicolon
multiline_comment|/* &squot;cycle&squot; is only mod 8000, but we also need two &squot;seconds&squot; bits -&n;&t;&t;   just snarf them from the current time */
id|seconds
op_assign
id|reg_read
c_func
(paren
id|recv-&gt;ohci
comma
id|OHCI1394_IsochronousCycleTimer
)paren
op_rshift
l_int|25
suffix:semicolon
multiline_comment|/* advance one second to give some extra time for DMA to start */
id|seconds
op_add_assign
l_int|1
suffix:semicolon
id|cycle
op_or_assign
(paren
id|seconds
op_amp
l_int|3
)paren
op_lshift
l_int|13
suffix:semicolon
id|contextMatch
op_or_assign
id|cycle
op_lshift
l_int|12
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sync
op_ne
op_minus
l_int|1
)paren
(brace
multiline_comment|/* set sync flag on first DMA descriptor */
r_struct
id|dma_cmd
op_star
id|cmd
op_assign
op_amp
id|recv-&gt;block
(braket
id|recv-&gt;block_dma
)braket
suffix:semicolon
id|cmd-&gt;control
op_or_assign
id|cpu_to_le32
c_func
(paren
id|DMA_CTL_WAIT
)paren
suffix:semicolon
multiline_comment|/* match sync field */
id|contextMatch
op_or_assign
(paren
id|sync
op_amp
l_int|0xf
)paren
op_lshift
l_int|8
suffix:semicolon
)brace
id|reg_write
c_func
(paren
id|recv-&gt;ohci
comma
id|recv-&gt;ContextMatch
comma
id|contextMatch
)paren
suffix:semicolon
multiline_comment|/* address of first descriptor block */
id|command
op_assign
id|dma_prog_region_offset_to_bus
c_func
(paren
op_amp
id|recv-&gt;prog
comma
id|recv-&gt;block_dma
op_star
r_sizeof
(paren
r_struct
id|dma_cmd
)paren
)paren
suffix:semicolon
id|command
op_or_assign
l_int|1
suffix:semicolon
multiline_comment|/* Z=1 */
id|reg_write
c_func
(paren
id|recv-&gt;ohci
comma
id|recv-&gt;CommandPtr
comma
id|command
)paren
suffix:semicolon
multiline_comment|/* enable interrupts */
id|reg_write
c_func
(paren
id|recv-&gt;ohci
comma
id|OHCI1394_IsoRecvIntMaskSet
comma
l_int|1
op_lshift
id|recv-&gt;task.context
)paren
suffix:semicolon
id|wmb
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* run */
id|reg_write
c_func
(paren
id|recv-&gt;ohci
comma
id|recv-&gt;ContextControlSet
comma
l_int|0x8000
)paren
suffix:semicolon
multiline_comment|/* issue a dummy read of the cycle timer register to force&n;&t;   all PCI writes to be posted immediately */
id|mb
c_func
(paren
)paren
suffix:semicolon
id|reg_read
c_func
(paren
id|recv-&gt;ohci
comma
id|OHCI1394_IsochronousCycleTimer
)paren
suffix:semicolon
multiline_comment|/* check RUN */
r_if
c_cond
(paren
op_logical_neg
(paren
id|reg_read
c_func
(paren
id|recv-&gt;ohci
comma
id|recv-&gt;ContextControlSet
)paren
op_amp
l_int|0x8000
)paren
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;Error starting IR DMA (ContextControl 0x%08x)&bslash;n&quot;
comma
id|reg_read
c_func
(paren
id|recv-&gt;ohci
comma
id|recv-&gt;ContextControlSet
)paren
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ohci_iso_recv_release_block
r_static
r_void
id|ohci_iso_recv_release_block
c_func
(paren
r_struct
id|ohci_iso_recv
op_star
id|recv
comma
r_int
id|block
)paren
(brace
multiline_comment|/* re-use the DMA descriptor for the block */
multiline_comment|/* by linking the previous descriptor to it */
r_int
id|next_i
op_assign
id|block
suffix:semicolon
r_int
id|prev_i
op_assign
(paren
id|next_i
op_eq
l_int|0
)paren
ques
c_cond
(paren
id|recv-&gt;nblocks
op_minus
l_int|1
)paren
suffix:colon
(paren
id|next_i
op_minus
l_int|1
)paren
suffix:semicolon
r_struct
id|dma_cmd
op_star
id|next
op_assign
op_amp
id|recv-&gt;block
(braket
id|next_i
)braket
suffix:semicolon
r_struct
id|dma_cmd
op_star
id|prev
op_assign
op_amp
id|recv-&gt;block
(braket
id|prev_i
)braket
suffix:semicolon
multiline_comment|/* &squot;next&squot; becomes the new end of the DMA chain,&n;&t;   so disable branch and enable interrupt */
id|next-&gt;branchAddress
op_assign
l_int|0
suffix:semicolon
id|next-&gt;control
op_or_assign
id|cpu_to_le32
c_func
(paren
l_int|3
op_lshift
l_int|20
)paren
suffix:semicolon
id|next-&gt;status
op_assign
id|cpu_to_le32
c_func
(paren
id|recv-&gt;buf_stride
)paren
suffix:semicolon
multiline_comment|/* link prev to next */
id|prev-&gt;branchAddress
op_assign
id|cpu_to_le32
c_func
(paren
id|dma_prog_region_offset_to_bus
c_func
(paren
op_amp
id|recv-&gt;prog
comma
r_sizeof
(paren
r_struct
id|dma_cmd
)paren
op_star
id|next_i
)paren
op_or
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Z=1 */
multiline_comment|/* disable interrupt on previous DMA descriptor, except at intervals */
r_if
c_cond
(paren
(paren
id|prev_i
op_mod
id|recv-&gt;block_irq_interval
)paren
op_eq
l_int|0
)paren
(brace
id|prev-&gt;control
op_or_assign
id|cpu_to_le32
c_func
(paren
l_int|3
op_lshift
l_int|20
)paren
suffix:semicolon
multiline_comment|/* enable interrupt */
)brace
r_else
(brace
id|prev-&gt;control
op_and_assign
id|cpu_to_le32
c_func
(paren
op_complement
(paren
l_int|3
op_lshift
l_int|20
)paren
)paren
suffix:semicolon
multiline_comment|/* disable interrupt */
)brace
id|wmb
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* wake up DMA in case it fell asleep */
id|reg_write
c_func
(paren
id|recv-&gt;ohci
comma
id|recv-&gt;ContextControlSet
comma
(paren
l_int|1
op_lshift
l_int|12
)paren
)paren
suffix:semicolon
)brace
DECL|function|ohci_iso_recv_bufferfill_release
r_static
r_void
id|ohci_iso_recv_bufferfill_release
c_func
(paren
r_struct
id|ohci_iso_recv
op_star
id|recv
comma
r_struct
id|hpsb_iso_packet_info
op_star
id|info
)paren
(brace
r_int
id|len
suffix:semicolon
multiline_comment|/* release the memory where the packet was */
id|len
op_assign
id|info-&gt;len
suffix:semicolon
multiline_comment|/* add the wasted space for padding to 4 bytes */
r_if
c_cond
(paren
id|len
op_mod
l_int|4
)paren
id|len
op_add_assign
l_int|4
op_minus
(paren
id|len
op_mod
l_int|4
)paren
suffix:semicolon
multiline_comment|/* add 8 bytes for the OHCI DMA data format overhead */
id|len
op_add_assign
l_int|8
suffix:semicolon
id|recv-&gt;released_bytes
op_add_assign
id|len
suffix:semicolon
multiline_comment|/* have we released enough memory for one block? */
r_while
c_loop
(paren
id|recv-&gt;released_bytes
OG
id|recv-&gt;buf_stride
)paren
(brace
id|ohci_iso_recv_release_block
c_func
(paren
id|recv
comma
id|recv-&gt;block_reader
)paren
suffix:semicolon
id|recv-&gt;block_reader
op_assign
(paren
id|recv-&gt;block_reader
op_plus
l_int|1
)paren
op_mod
id|recv-&gt;nblocks
suffix:semicolon
id|recv-&gt;released_bytes
op_sub_assign
id|recv-&gt;buf_stride
suffix:semicolon
)brace
)brace
DECL|function|ohci_iso_recv_release
r_static
r_inline
r_void
id|ohci_iso_recv_release
c_func
(paren
r_struct
id|hpsb_iso
op_star
id|iso
comma
r_struct
id|hpsb_iso_packet_info
op_star
id|info
)paren
(brace
r_struct
id|ohci_iso_recv
op_star
id|recv
op_assign
id|iso-&gt;hostdata
suffix:semicolon
r_if
c_cond
(paren
id|recv-&gt;dma_mode
op_eq
id|BUFFER_FILL_MODE
)paren
(brace
id|ohci_iso_recv_bufferfill_release
c_func
(paren
id|recv
comma
id|info
)paren
suffix:semicolon
)brace
r_else
(brace
id|ohci_iso_recv_release_block
c_func
(paren
id|recv
comma
id|info
op_minus
id|iso-&gt;infos
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* parse all packets from blocks that have been fully received */
DECL|function|ohci_iso_recv_bufferfill_parse
r_static
r_void
id|ohci_iso_recv_bufferfill_parse
c_func
(paren
r_struct
id|hpsb_iso
op_star
id|iso
comma
r_struct
id|ohci_iso_recv
op_star
id|recv
)paren
(brace
r_int
id|wake
op_assign
l_int|0
suffix:semicolon
r_int
id|runaway
op_assign
l_int|0
suffix:semicolon
r_struct
id|ti_ohci
op_star
id|ohci
op_assign
id|recv-&gt;ohci
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
multiline_comment|/* we expect the next parsable packet to begin at recv-&gt;dma_offset */
multiline_comment|/* note: packet layout is as shown in section 10.6.1.1 of the OHCI spec */
r_int
r_int
id|offset
suffix:semicolon
r_int
r_int
id|len
comma
id|cycle
suffix:semicolon
r_int
r_char
id|channel
comma
id|tag
comma
id|sy
suffix:semicolon
r_int
r_char
op_star
id|p
op_assign
id|iso-&gt;data_buf.kvirt
suffix:semicolon
r_int
r_int
id|this_block
op_assign
id|recv-&gt;dma_offset
op_div
id|recv-&gt;buf_stride
suffix:semicolon
multiline_comment|/* don&squot;t loop indefinitely */
r_if
c_cond
(paren
id|runaway
op_increment
OG
l_int|100000
)paren
(brace
id|atomic_inc
c_func
(paren
op_amp
id|iso-&gt;overflows
)paren
suffix:semicolon
id|PRINT
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;IR DMA error - Runaway during buffer parsing!&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* stop parsing once we arrive at block_dma (i.e. don&squot;t get ahead of DMA) */
r_if
c_cond
(paren
id|this_block
op_eq
id|recv-&gt;block_dma
)paren
r_break
suffix:semicolon
id|wake
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* parse data length, tag, channel, and sy */
multiline_comment|/* note: we keep our own local copies of &squot;len&squot; and &squot;offset&squot;&n;&t;&t;   so the user can&squot;t mess with them by poking in the mmap area */
id|len
op_assign
id|p
(braket
id|recv-&gt;dma_offset
op_plus
l_int|2
)braket
op_or
(paren
id|p
(braket
id|recv-&gt;dma_offset
op_plus
l_int|3
)braket
op_lshift
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
l_int|4096
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;IR DMA error - bogus &squot;len&squot; value %u&bslash;n&quot;
comma
id|len
)paren
suffix:semicolon
)brace
id|channel
op_assign
id|p
(braket
id|recv-&gt;dma_offset
op_plus
l_int|1
)braket
op_amp
l_int|0x3F
suffix:semicolon
id|tag
op_assign
id|p
(braket
id|recv-&gt;dma_offset
op_plus
l_int|1
)braket
op_rshift
l_int|6
suffix:semicolon
id|sy
op_assign
id|p
(braket
id|recv-&gt;dma_offset
op_plus
l_int|0
)braket
op_amp
l_int|0xF
suffix:semicolon
multiline_comment|/* advance to data payload */
id|recv-&gt;dma_offset
op_add_assign
l_int|4
suffix:semicolon
multiline_comment|/* check for wrap-around */
r_if
c_cond
(paren
id|recv-&gt;dma_offset
op_ge
id|recv-&gt;buf_stride
op_star
id|recv-&gt;nblocks
)paren
(brace
id|recv-&gt;dma_offset
op_sub_assign
id|recv-&gt;buf_stride
op_star
id|recv-&gt;nblocks
suffix:semicolon
)brace
multiline_comment|/* dma_offset now points to the first byte of the data payload */
id|offset
op_assign
id|recv-&gt;dma_offset
suffix:semicolon
multiline_comment|/* advance to xferStatus/timeStamp */
id|recv-&gt;dma_offset
op_add_assign
id|len
suffix:semicolon
multiline_comment|/* payload is padded to 4 bytes */
r_if
c_cond
(paren
id|len
op_mod
l_int|4
)paren
(brace
id|recv-&gt;dma_offset
op_add_assign
l_int|4
op_minus
(paren
id|len
op_mod
l_int|4
)paren
suffix:semicolon
)brace
multiline_comment|/* check for wrap-around */
r_if
c_cond
(paren
id|recv-&gt;dma_offset
op_ge
id|recv-&gt;buf_stride
op_star
id|recv-&gt;nblocks
)paren
(brace
multiline_comment|/* uh oh, the packet data wraps from the last&n;                           to the first DMA block - make the packet&n;                           contiguous by copying its &quot;tail&quot; into the&n;                           guard page */
r_int
id|guard_off
op_assign
id|recv-&gt;buf_stride
op_star
id|recv-&gt;nblocks
suffix:semicolon
r_int
id|tail_len
op_assign
id|len
op_minus
(paren
id|guard_off
op_minus
id|offset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tail_len
OG
l_int|0
op_logical_and
id|tail_len
OL
id|recv-&gt;buf_stride
)paren
(brace
id|memcpy
c_func
(paren
id|iso-&gt;data_buf.kvirt
op_plus
id|guard_off
comma
id|iso-&gt;data_buf.kvirt
comma
id|tail_len
)paren
suffix:semicolon
)brace
id|recv-&gt;dma_offset
op_sub_assign
id|recv-&gt;buf_stride
op_star
id|recv-&gt;nblocks
suffix:semicolon
)brace
multiline_comment|/* parse timestamp */
id|cycle
op_assign
id|p
(braket
id|recv-&gt;dma_offset
op_plus
l_int|0
)braket
op_or
(paren
id|p
(braket
id|recv-&gt;dma_offset
op_plus
l_int|1
)braket
op_lshift
l_int|8
)paren
suffix:semicolon
id|cycle
op_and_assign
l_int|0x1FFF
suffix:semicolon
multiline_comment|/* advance to next packet */
id|recv-&gt;dma_offset
op_add_assign
l_int|4
suffix:semicolon
multiline_comment|/* check for wrap-around */
r_if
c_cond
(paren
id|recv-&gt;dma_offset
op_ge
id|recv-&gt;buf_stride
op_star
id|recv-&gt;nblocks
)paren
(brace
id|recv-&gt;dma_offset
op_sub_assign
id|recv-&gt;buf_stride
op_star
id|recv-&gt;nblocks
suffix:semicolon
)brace
id|hpsb_iso_packet_received
c_func
(paren
id|iso
comma
id|offset
comma
id|len
comma
id|cycle
comma
id|channel
comma
id|tag
comma
id|sy
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|wake
)paren
id|hpsb_iso_wake
c_func
(paren
id|iso
)paren
suffix:semicolon
)brace
DECL|function|ohci_iso_recv_bufferfill_task
r_static
r_void
id|ohci_iso_recv_bufferfill_task
c_func
(paren
r_struct
id|hpsb_iso
op_star
id|iso
comma
r_struct
id|ohci_iso_recv
op_star
id|recv
)paren
(brace
r_int
id|loop
suffix:semicolon
r_struct
id|ti_ohci
op_star
id|ohci
op_assign
id|recv-&gt;ohci
suffix:semicolon
multiline_comment|/* loop over all blocks */
r_for
c_loop
(paren
id|loop
op_assign
l_int|0
suffix:semicolon
id|loop
OL
id|recv-&gt;nblocks
suffix:semicolon
id|loop
op_increment
)paren
(brace
multiline_comment|/* check block_dma to see if it&squot;s done */
r_struct
id|dma_cmd
op_star
id|im
op_assign
op_amp
id|recv-&gt;block
(braket
id|recv-&gt;block_dma
)braket
suffix:semicolon
multiline_comment|/* check the DMA descriptor for new writes to xferStatus */
id|u16
id|xferstatus
op_assign
id|le32_to_cpu
c_func
(paren
id|im-&gt;status
)paren
op_rshift
l_int|16
suffix:semicolon
multiline_comment|/* rescount is the number of bytes *remaining to be written* in the block */
id|u16
id|rescount
op_assign
id|le32_to_cpu
c_func
(paren
id|im-&gt;status
)paren
op_amp
l_int|0xFFFF
suffix:semicolon
r_int
r_char
id|event
op_assign
id|xferstatus
op_amp
l_int|0x1F
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|event
)paren
(brace
multiline_comment|/* nothing has happened to this block yet */
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|event
op_ne
l_int|0x11
)paren
(brace
id|atomic_inc
c_func
(paren
op_amp
id|iso-&gt;overflows
)paren
suffix:semicolon
id|PRINT
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;IR DMA error - OHCI error code 0x%02x&bslash;n&quot;
comma
id|event
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rescount
op_ne
l_int|0
)paren
(brace
multiline_comment|/* the card is still writing to this block;&n;&t;&t;&t;   we can&squot;t touch it until it&squot;s done */
r_break
suffix:semicolon
)brace
multiline_comment|/* OK, the block is finished... */
multiline_comment|/* sync our view of the block */
id|dma_region_sync_for_cpu
c_func
(paren
op_amp
id|iso-&gt;data_buf
comma
id|recv-&gt;block_dma
op_star
id|recv-&gt;buf_stride
comma
id|recv-&gt;buf_stride
)paren
suffix:semicolon
multiline_comment|/* reset the DMA descriptor */
id|im-&gt;status
op_assign
id|recv-&gt;buf_stride
suffix:semicolon
multiline_comment|/* advance block_dma */
id|recv-&gt;block_dma
op_assign
(paren
id|recv-&gt;block_dma
op_plus
l_int|1
)paren
op_mod
id|recv-&gt;nblocks
suffix:semicolon
r_if
c_cond
(paren
(paren
id|recv-&gt;block_dma
op_plus
l_int|1
)paren
op_mod
id|recv-&gt;nblocks
op_eq
id|recv-&gt;block_reader
)paren
(brace
id|atomic_inc
c_func
(paren
op_amp
id|iso-&gt;overflows
)paren
suffix:semicolon
id|DBGMSG
c_func
(paren
l_string|&quot;ISO reception overflow - &quot;
l_string|&quot;ran out of DMA blocks&quot;
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* parse any packets that have arrived */
id|ohci_iso_recv_bufferfill_parse
c_func
(paren
id|iso
comma
id|recv
)paren
suffix:semicolon
)brace
DECL|function|ohci_iso_recv_packetperbuf_task
r_static
r_void
id|ohci_iso_recv_packetperbuf_task
c_func
(paren
r_struct
id|hpsb_iso
op_star
id|iso
comma
r_struct
id|ohci_iso_recv
op_star
id|recv
)paren
(brace
r_int
id|count
suffix:semicolon
r_int
id|wake
op_assign
l_int|0
suffix:semicolon
r_struct
id|ti_ohci
op_star
id|ohci
op_assign
id|recv-&gt;ohci
suffix:semicolon
multiline_comment|/* loop over the entire buffer */
r_for
c_loop
(paren
id|count
op_assign
l_int|0
suffix:semicolon
id|count
OL
id|recv-&gt;nblocks
suffix:semicolon
id|count
op_increment
)paren
(brace
id|u32
id|packet_len
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* pointer to the DMA descriptor */
r_struct
id|dma_cmd
op_star
id|il
op_assign
(paren
(paren
r_struct
id|dma_cmd
op_star
)paren
id|recv-&gt;prog.kvirt
)paren
op_plus
id|iso-&gt;pkt_dma
suffix:semicolon
multiline_comment|/* check the DMA descriptor for new writes to xferStatus */
id|u16
id|xferstatus
op_assign
id|le32_to_cpu
c_func
(paren
id|il-&gt;status
)paren
op_rshift
l_int|16
suffix:semicolon
id|u16
id|rescount
op_assign
id|le32_to_cpu
c_func
(paren
id|il-&gt;status
)paren
op_amp
l_int|0xFFFF
suffix:semicolon
r_int
r_char
id|event
op_assign
id|xferstatus
op_amp
l_int|0x1F
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|event
)paren
(brace
multiline_comment|/* this packet hasn&squot;t come in yet; we are done for now */
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|event
op_eq
l_int|0x11
)paren
(brace
multiline_comment|/* packet received successfully! */
multiline_comment|/* rescount is the number of bytes *remaining* in the packet buffer,&n;&t;&t;&t;   after the packet was written */
id|packet_len
op_assign
id|recv-&gt;buf_stride
op_minus
id|rescount
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|event
op_eq
l_int|0x02
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;IR DMA error - packet too long for buffer&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|event
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;IR DMA error - OHCI error code 0x%02x&bslash;n&quot;
comma
id|event
)paren
suffix:semicolon
)brace
multiline_comment|/* sync our view of the buffer */
id|dma_region_sync_for_cpu
c_func
(paren
op_amp
id|iso-&gt;data_buf
comma
id|iso-&gt;pkt_dma
op_star
id|recv-&gt;buf_stride
comma
id|recv-&gt;buf_stride
)paren
suffix:semicolon
multiline_comment|/* record the per-packet info */
(brace
multiline_comment|/* iso header is 8 bytes ahead of the data payload */
r_int
r_char
op_star
id|hdr
suffix:semicolon
r_int
r_int
id|offset
suffix:semicolon
r_int
r_int
id|cycle
suffix:semicolon
r_int
r_char
id|channel
comma
id|tag
comma
id|sy
suffix:semicolon
id|offset
op_assign
id|iso-&gt;pkt_dma
op_star
id|recv-&gt;buf_stride
suffix:semicolon
id|hdr
op_assign
id|iso-&gt;data_buf.kvirt
op_plus
id|offset
suffix:semicolon
multiline_comment|/* skip iso header */
id|offset
op_add_assign
l_int|8
suffix:semicolon
id|packet_len
op_sub_assign
l_int|8
suffix:semicolon
id|cycle
op_assign
(paren
id|hdr
(braket
l_int|0
)braket
op_or
(paren
id|hdr
(braket
l_int|1
)braket
op_lshift
l_int|8
)paren
)paren
op_amp
l_int|0x1FFF
suffix:semicolon
id|channel
op_assign
id|hdr
(braket
l_int|5
)braket
op_amp
l_int|0x3F
suffix:semicolon
id|tag
op_assign
id|hdr
(braket
l_int|5
)braket
op_rshift
l_int|6
suffix:semicolon
id|sy
op_assign
id|hdr
(braket
l_int|4
)braket
op_amp
l_int|0xF
suffix:semicolon
id|hpsb_iso_packet_received
c_func
(paren
id|iso
comma
id|offset
comma
id|packet_len
comma
id|cycle
comma
id|channel
comma
id|tag
comma
id|sy
)paren
suffix:semicolon
)brace
multiline_comment|/* reset the DMA descriptor */
id|il-&gt;status
op_assign
id|recv-&gt;buf_stride
suffix:semicolon
id|wake
op_assign
l_int|1
suffix:semicolon
id|recv-&gt;block_dma
op_assign
id|iso-&gt;pkt_dma
suffix:semicolon
)brace
id|out
suffix:colon
r_if
c_cond
(paren
id|wake
)paren
id|hpsb_iso_wake
c_func
(paren
id|iso
)paren
suffix:semicolon
)brace
DECL|function|ohci_iso_recv_task
r_static
r_void
id|ohci_iso_recv_task
c_func
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|hpsb_iso
op_star
id|iso
op_assign
(paren
r_struct
id|hpsb_iso
op_star
)paren
id|data
suffix:semicolon
r_struct
id|ohci_iso_recv
op_star
id|recv
op_assign
id|iso-&gt;hostdata
suffix:semicolon
r_if
c_cond
(paren
id|recv-&gt;dma_mode
op_eq
id|BUFFER_FILL_MODE
)paren
id|ohci_iso_recv_bufferfill_task
c_func
(paren
id|iso
comma
id|recv
)paren
suffix:semicolon
r_else
id|ohci_iso_recv_packetperbuf_task
c_func
(paren
id|iso
comma
id|recv
)paren
suffix:semicolon
)brace
multiline_comment|/***********************************&n; * rawiso ISO transmission         *&n; ***********************************/
DECL|struct|ohci_iso_xmit
r_struct
id|ohci_iso_xmit
(brace
DECL|member|ohci
r_struct
id|ti_ohci
op_star
id|ohci
suffix:semicolon
DECL|member|prog
r_struct
id|dma_prog_region
id|prog
suffix:semicolon
DECL|member|task
r_struct
id|ohci1394_iso_tasklet
id|task
suffix:semicolon
DECL|member|task_active
r_int
id|task_active
suffix:semicolon
DECL|member|ContextControlSet
id|u32
id|ContextControlSet
suffix:semicolon
DECL|member|ContextControlClear
id|u32
id|ContextControlClear
suffix:semicolon
DECL|member|CommandPtr
id|u32
id|CommandPtr
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* transmission DMA program:&n;   one OUTPUT_MORE_IMMEDIATE for the IT header&n;   one OUTPUT_LAST for the buffer data */
DECL|struct|iso_xmit_cmd
r_struct
id|iso_xmit_cmd
(brace
DECL|member|output_more_immediate
r_struct
id|dma_cmd
id|output_more_immediate
suffix:semicolon
DECL|member|iso_hdr
id|u8
id|iso_hdr
(braket
l_int|8
)braket
suffix:semicolon
DECL|member|unused
id|u32
id|unused
(braket
l_int|2
)braket
suffix:semicolon
DECL|member|output_last
r_struct
id|dma_cmd
id|output_last
suffix:semicolon
)brace
suffix:semicolon
r_static
r_int
id|ohci_iso_xmit_init
c_func
(paren
r_struct
id|hpsb_iso
op_star
id|iso
)paren
suffix:semicolon
r_static
r_int
id|ohci_iso_xmit_start
c_func
(paren
r_struct
id|hpsb_iso
op_star
id|iso
comma
r_int
id|cycle
)paren
suffix:semicolon
r_static
r_void
id|ohci_iso_xmit_shutdown
c_func
(paren
r_struct
id|hpsb_iso
op_star
id|iso
)paren
suffix:semicolon
r_static
r_void
id|ohci_iso_xmit_task
c_func
(paren
r_int
r_int
id|data
)paren
suffix:semicolon
DECL|function|ohci_iso_xmit_init
r_static
r_int
id|ohci_iso_xmit_init
c_func
(paren
r_struct
id|hpsb_iso
op_star
id|iso
)paren
(brace
r_struct
id|ohci_iso_xmit
op_star
id|xmit
suffix:semicolon
r_int
r_int
id|prog_size
suffix:semicolon
r_int
id|ctx
suffix:semicolon
r_int
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
id|xmit
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|xmit
)paren
comma
id|SLAB_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|xmit
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|iso-&gt;hostdata
op_assign
id|xmit
suffix:semicolon
id|xmit-&gt;ohci
op_assign
id|iso-&gt;host-&gt;hostdata
suffix:semicolon
id|xmit-&gt;task_active
op_assign
l_int|0
suffix:semicolon
id|dma_prog_region_init
c_func
(paren
op_amp
id|xmit-&gt;prog
)paren
suffix:semicolon
id|prog_size
op_assign
r_sizeof
(paren
r_struct
id|iso_xmit_cmd
)paren
op_star
id|iso-&gt;buf_packets
suffix:semicolon
r_if
c_cond
(paren
id|dma_prog_region_alloc
c_func
(paren
op_amp
id|xmit-&gt;prog
comma
id|prog_size
comma
id|xmit-&gt;ohci-&gt;dev
)paren
)paren
r_goto
id|err
suffix:semicolon
id|ohci1394_init_iso_tasklet
c_func
(paren
op_amp
id|xmit-&gt;task
comma
id|OHCI_ISO_TRANSMIT
comma
id|ohci_iso_xmit_task
comma
(paren
r_int
r_int
)paren
id|iso
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ohci1394_register_iso_tasklet
c_func
(paren
id|xmit-&gt;ohci
comma
op_amp
id|xmit-&gt;task
)paren
OL
l_int|0
)paren
r_goto
id|err
suffix:semicolon
id|xmit-&gt;task_active
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* xmit context registers are spaced 16 bytes apart */
id|ctx
op_assign
id|xmit-&gt;task.context
suffix:semicolon
id|xmit-&gt;ContextControlSet
op_assign
id|OHCI1394_IsoXmitContextControlSet
op_plus
l_int|16
op_star
id|ctx
suffix:semicolon
id|xmit-&gt;ContextControlClear
op_assign
id|OHCI1394_IsoXmitContextControlClear
op_plus
l_int|16
op_star
id|ctx
suffix:semicolon
id|xmit-&gt;CommandPtr
op_assign
id|OHCI1394_IsoXmitCommandPtr
op_plus
l_int|16
op_star
id|ctx
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|err
suffix:colon
id|ohci_iso_xmit_shutdown
c_func
(paren
id|iso
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|ohci_iso_xmit_stop
r_static
r_void
id|ohci_iso_xmit_stop
c_func
(paren
r_struct
id|hpsb_iso
op_star
id|iso
)paren
(brace
r_struct
id|ohci_iso_xmit
op_star
id|xmit
op_assign
id|iso-&gt;hostdata
suffix:semicolon
r_struct
id|ti_ohci
op_star
id|ohci
op_assign
id|xmit-&gt;ohci
suffix:semicolon
multiline_comment|/* disable interrupts */
id|reg_write
c_func
(paren
id|xmit-&gt;ohci
comma
id|OHCI1394_IsoXmitIntMaskClear
comma
l_int|1
op_lshift
id|xmit-&gt;task.context
)paren
suffix:semicolon
multiline_comment|/* halt DMA */
r_if
c_cond
(paren
id|ohci1394_stop_context
c_func
(paren
id|xmit-&gt;ohci
comma
id|xmit-&gt;ContextControlClear
comma
l_int|NULL
)paren
)paren
(brace
multiline_comment|/* XXX the DMA context will lock up if you try to send too much data! */
id|PRINT
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;you probably exceeded the OHCI card&squot;s bandwidth limit - &quot;
l_string|&quot;reload the module and reduce xmit bandwidth&quot;
)paren
suffix:semicolon
)brace
)brace
DECL|function|ohci_iso_xmit_shutdown
r_static
r_void
id|ohci_iso_xmit_shutdown
c_func
(paren
r_struct
id|hpsb_iso
op_star
id|iso
)paren
(brace
r_struct
id|ohci_iso_xmit
op_star
id|xmit
op_assign
id|iso-&gt;hostdata
suffix:semicolon
r_if
c_cond
(paren
id|xmit-&gt;task_active
)paren
(brace
id|ohci_iso_xmit_stop
c_func
(paren
id|iso
)paren
suffix:semicolon
id|ohci1394_unregister_iso_tasklet
c_func
(paren
id|xmit-&gt;ohci
comma
op_amp
id|xmit-&gt;task
)paren
suffix:semicolon
id|xmit-&gt;task_active
op_assign
l_int|0
suffix:semicolon
)brace
id|dma_prog_region_free
c_func
(paren
op_amp
id|xmit-&gt;prog
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|xmit
)paren
suffix:semicolon
id|iso-&gt;hostdata
op_assign
l_int|NULL
suffix:semicolon
)brace
DECL|function|ohci_iso_xmit_task
r_static
r_void
id|ohci_iso_xmit_task
c_func
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|hpsb_iso
op_star
id|iso
op_assign
(paren
r_struct
id|hpsb_iso
op_star
)paren
id|data
suffix:semicolon
r_struct
id|ohci_iso_xmit
op_star
id|xmit
op_assign
id|iso-&gt;hostdata
suffix:semicolon
r_struct
id|ti_ohci
op_star
id|ohci
op_assign
id|xmit-&gt;ohci
suffix:semicolon
r_int
id|wake
op_assign
l_int|0
suffix:semicolon
r_int
id|count
suffix:semicolon
multiline_comment|/* check the whole buffer if necessary, starting at pkt_dma */
r_for
c_loop
(paren
id|count
op_assign
l_int|0
suffix:semicolon
id|count
OL
id|iso-&gt;buf_packets
suffix:semicolon
id|count
op_increment
)paren
(brace
r_int
id|cycle
suffix:semicolon
multiline_comment|/* DMA descriptor */
r_struct
id|iso_xmit_cmd
op_star
id|cmd
op_assign
id|dma_region_i
c_func
(paren
op_amp
id|xmit-&gt;prog
comma
r_struct
id|iso_xmit_cmd
comma
id|iso-&gt;pkt_dma
)paren
suffix:semicolon
multiline_comment|/* check for new writes to xferStatus */
id|u16
id|xferstatus
op_assign
id|le32_to_cpu
c_func
(paren
id|cmd-&gt;output_last.status
)paren
op_rshift
l_int|16
suffix:semicolon
id|u8
id|event
op_assign
id|xferstatus
op_amp
l_int|0x1F
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|event
)paren
(brace
multiline_comment|/* packet hasn&squot;t been sent yet; we are done for now */
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|event
op_ne
l_int|0x11
)paren
id|PRINT
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;IT DMA error - OHCI error code 0x%02x&bslash;n&quot;
comma
id|event
)paren
suffix:semicolon
multiline_comment|/* at least one packet went out, so wake up the writer */
id|wake
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* parse cycle */
id|cycle
op_assign
id|le32_to_cpu
c_func
(paren
id|cmd-&gt;output_last.status
)paren
op_amp
l_int|0x1FFF
suffix:semicolon
multiline_comment|/* tell the subsystem the packet has gone out */
id|hpsb_iso_packet_sent
c_func
(paren
id|iso
comma
id|cycle
comma
id|event
op_ne
l_int|0x11
)paren
suffix:semicolon
multiline_comment|/* reset the DMA descriptor for next time */
id|cmd-&gt;output_last.status
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|wake
)paren
id|hpsb_iso_wake
c_func
(paren
id|iso
)paren
suffix:semicolon
)brace
DECL|function|ohci_iso_xmit_queue
r_static
r_int
id|ohci_iso_xmit_queue
c_func
(paren
r_struct
id|hpsb_iso
op_star
id|iso
comma
r_struct
id|hpsb_iso_packet_info
op_star
id|info
)paren
(brace
r_struct
id|ohci_iso_xmit
op_star
id|xmit
op_assign
id|iso-&gt;hostdata
suffix:semicolon
r_struct
id|ti_ohci
op_star
id|ohci
op_assign
id|xmit-&gt;ohci
suffix:semicolon
r_int
id|next_i
comma
id|prev_i
suffix:semicolon
r_struct
id|iso_xmit_cmd
op_star
id|next
comma
op_star
id|prev
suffix:semicolon
r_int
r_int
id|offset
suffix:semicolon
r_int
r_int
id|len
suffix:semicolon
r_int
r_char
id|tag
comma
id|sy
suffix:semicolon
multiline_comment|/* check that the packet doesn&squot;t cross a page boundary&n;&t;   (we could allow this if we added OUTPUT_MORE descriptor support) */
r_if
c_cond
(paren
id|cross_bound
c_func
(paren
id|info-&gt;offset
comma
id|info-&gt;len
)paren
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;rawiso xmit: packet %u crosses a page boundary&quot;
comma
id|iso-&gt;first_packet
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|offset
op_assign
id|info-&gt;offset
suffix:semicolon
id|len
op_assign
id|info-&gt;len
suffix:semicolon
id|tag
op_assign
id|info-&gt;tag
suffix:semicolon
id|sy
op_assign
id|info-&gt;sy
suffix:semicolon
multiline_comment|/* sync up the card&squot;s view of the buffer */
id|dma_region_sync_for_device
c_func
(paren
op_amp
id|iso-&gt;data_buf
comma
id|offset
comma
id|len
)paren
suffix:semicolon
multiline_comment|/* append first_packet to the DMA chain */
multiline_comment|/* by linking the previous descriptor to it */
multiline_comment|/* (next will become the new end of the DMA chain) */
id|next_i
op_assign
id|iso-&gt;first_packet
suffix:semicolon
id|prev_i
op_assign
(paren
id|next_i
op_eq
l_int|0
)paren
ques
c_cond
(paren
id|iso-&gt;buf_packets
op_minus
l_int|1
)paren
suffix:colon
(paren
id|next_i
op_minus
l_int|1
)paren
suffix:semicolon
id|next
op_assign
id|dma_region_i
c_func
(paren
op_amp
id|xmit-&gt;prog
comma
r_struct
id|iso_xmit_cmd
comma
id|next_i
)paren
suffix:semicolon
id|prev
op_assign
id|dma_region_i
c_func
(paren
op_amp
id|xmit-&gt;prog
comma
r_struct
id|iso_xmit_cmd
comma
id|prev_i
)paren
suffix:semicolon
multiline_comment|/* set up the OUTPUT_MORE_IMMEDIATE descriptor */
id|memset
c_func
(paren
id|next
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|iso_xmit_cmd
)paren
)paren
suffix:semicolon
id|next-&gt;output_more_immediate.control
op_assign
id|cpu_to_le32
c_func
(paren
l_int|0x02000008
)paren
suffix:semicolon
multiline_comment|/* ISO packet header is embedded in the OUTPUT_MORE_IMMEDIATE */
multiline_comment|/* tcode = 0xA, and sy */
id|next-&gt;iso_hdr
(braket
l_int|0
)braket
op_assign
l_int|0xA0
op_or
(paren
id|sy
op_amp
l_int|0xF
)paren
suffix:semicolon
multiline_comment|/* tag and channel number */
id|next-&gt;iso_hdr
(braket
l_int|1
)braket
op_assign
(paren
id|tag
op_lshift
l_int|6
)paren
op_or
(paren
id|iso-&gt;channel
op_amp
l_int|0x3F
)paren
suffix:semicolon
multiline_comment|/* transmission speed */
id|next-&gt;iso_hdr
(braket
l_int|2
)braket
op_assign
id|iso-&gt;speed
op_amp
l_int|0x7
suffix:semicolon
multiline_comment|/* payload size */
id|next-&gt;iso_hdr
(braket
l_int|6
)braket
op_assign
id|len
op_amp
l_int|0xFF
suffix:semicolon
id|next-&gt;iso_hdr
(braket
l_int|7
)braket
op_assign
id|len
op_rshift
l_int|8
suffix:semicolon
multiline_comment|/* set up the OUTPUT_LAST */
id|next-&gt;output_last.control
op_assign
id|cpu_to_le32
c_func
(paren
l_int|1
op_lshift
l_int|28
)paren
suffix:semicolon
id|next-&gt;output_last.control
op_or_assign
id|cpu_to_le32
c_func
(paren
l_int|1
op_lshift
l_int|27
)paren
suffix:semicolon
multiline_comment|/* update timeStamp */
id|next-&gt;output_last.control
op_or_assign
id|cpu_to_le32
c_func
(paren
l_int|3
op_lshift
l_int|20
)paren
suffix:semicolon
multiline_comment|/* want interrupt */
id|next-&gt;output_last.control
op_or_assign
id|cpu_to_le32
c_func
(paren
l_int|3
op_lshift
l_int|18
)paren
suffix:semicolon
multiline_comment|/* enable branch */
id|next-&gt;output_last.control
op_or_assign
id|cpu_to_le32
c_func
(paren
id|len
)paren
suffix:semicolon
multiline_comment|/* payload bus address */
id|next-&gt;output_last.address
op_assign
id|cpu_to_le32
c_func
(paren
id|dma_region_offset_to_bus
c_func
(paren
op_amp
id|iso-&gt;data_buf
comma
id|offset
)paren
)paren
suffix:semicolon
multiline_comment|/* leave branchAddress at zero for now */
multiline_comment|/* re-write the previous DMA descriptor to chain to this one */
multiline_comment|/* set prev branch address to point to next (Z=3) */
id|prev-&gt;output_last.branchAddress
op_assign
id|cpu_to_le32
c_func
(paren
id|dma_prog_region_offset_to_bus
c_func
(paren
op_amp
id|xmit-&gt;prog
comma
r_sizeof
(paren
r_struct
id|iso_xmit_cmd
)paren
op_star
id|next_i
)paren
op_or
l_int|3
)paren
suffix:semicolon
multiline_comment|/* disable interrupt, unless required by the IRQ interval */
r_if
c_cond
(paren
id|prev_i
op_mod
id|iso-&gt;irq_interval
)paren
(brace
id|prev-&gt;output_last.control
op_and_assign
id|cpu_to_le32
c_func
(paren
op_complement
(paren
l_int|3
op_lshift
l_int|20
)paren
)paren
suffix:semicolon
multiline_comment|/* no interrupt */
)brace
r_else
(brace
id|prev-&gt;output_last.control
op_or_assign
id|cpu_to_le32
c_func
(paren
l_int|3
op_lshift
l_int|20
)paren
suffix:semicolon
multiline_comment|/* enable interrupt */
)brace
id|wmb
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* wake DMA in case it is sleeping */
id|reg_write
c_func
(paren
id|xmit-&gt;ohci
comma
id|xmit-&gt;ContextControlSet
comma
l_int|1
op_lshift
l_int|12
)paren
suffix:semicolon
multiline_comment|/* issue a dummy read of the cycle timer to force all PCI&n;&t;   writes to be posted immediately */
id|mb
c_func
(paren
)paren
suffix:semicolon
id|reg_read
c_func
(paren
id|xmit-&gt;ohci
comma
id|OHCI1394_IsochronousCycleTimer
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ohci_iso_xmit_start
r_static
r_int
id|ohci_iso_xmit_start
c_func
(paren
r_struct
id|hpsb_iso
op_star
id|iso
comma
r_int
id|cycle
)paren
(brace
r_struct
id|ohci_iso_xmit
op_star
id|xmit
op_assign
id|iso-&gt;hostdata
suffix:semicolon
r_struct
id|ti_ohci
op_star
id|ohci
op_assign
id|xmit-&gt;ohci
suffix:semicolon
multiline_comment|/* clear out the control register */
id|reg_write
c_func
(paren
id|xmit-&gt;ohci
comma
id|xmit-&gt;ContextControlClear
comma
l_int|0xFFFFFFFF
)paren
suffix:semicolon
id|wmb
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* address and length of first descriptor block (Z=3) */
id|reg_write
c_func
(paren
id|xmit-&gt;ohci
comma
id|xmit-&gt;CommandPtr
comma
id|dma_prog_region_offset_to_bus
c_func
(paren
op_amp
id|xmit-&gt;prog
comma
id|iso-&gt;pkt_dma
op_star
r_sizeof
(paren
r_struct
id|iso_xmit_cmd
)paren
)paren
op_or
l_int|3
)paren
suffix:semicolon
multiline_comment|/* cycle match */
r_if
c_cond
(paren
id|cycle
op_ne
op_minus
l_int|1
)paren
(brace
id|u32
id|start
op_assign
id|cycle
op_amp
l_int|0x1FFF
suffix:semicolon
multiline_comment|/* &squot;cycle&squot; is only mod 8000, but we also need two &squot;seconds&squot; bits -&n;&t;&t;   just snarf them from the current time */
id|u32
id|seconds
op_assign
id|reg_read
c_func
(paren
id|xmit-&gt;ohci
comma
id|OHCI1394_IsochronousCycleTimer
)paren
op_rshift
l_int|25
suffix:semicolon
multiline_comment|/* advance one second to give some extra time for DMA to start */
id|seconds
op_add_assign
l_int|1
suffix:semicolon
id|start
op_or_assign
(paren
id|seconds
op_amp
l_int|3
)paren
op_lshift
l_int|13
suffix:semicolon
id|reg_write
c_func
(paren
id|xmit-&gt;ohci
comma
id|xmit-&gt;ContextControlSet
comma
l_int|0x80000000
op_or
(paren
id|start
op_lshift
l_int|16
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* enable interrupts */
id|reg_write
c_func
(paren
id|xmit-&gt;ohci
comma
id|OHCI1394_IsoXmitIntMaskSet
comma
l_int|1
op_lshift
id|xmit-&gt;task.context
)paren
suffix:semicolon
multiline_comment|/* run */
id|reg_write
c_func
(paren
id|xmit-&gt;ohci
comma
id|xmit-&gt;ContextControlSet
comma
l_int|0x8000
)paren
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* wait 100 usec to give the card time to go active */
id|udelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
multiline_comment|/* check the RUN bit */
r_if
c_cond
(paren
op_logical_neg
(paren
id|reg_read
c_func
(paren
id|xmit-&gt;ohci
comma
id|xmit-&gt;ContextControlSet
)paren
op_amp
l_int|0x8000
)paren
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;Error starting IT DMA (ContextControl 0x%08x)&bslash;n&quot;
comma
id|reg_read
c_func
(paren
id|xmit-&gt;ohci
comma
id|xmit-&gt;ContextControlSet
)paren
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ohci_isoctl
r_static
r_int
id|ohci_isoctl
c_func
(paren
r_struct
id|hpsb_iso
op_star
id|iso
comma
r_enum
id|isoctl_cmd
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|XMIT_INIT
suffix:colon
r_return
id|ohci_iso_xmit_init
c_func
(paren
id|iso
)paren
suffix:semicolon
r_case
id|XMIT_START
suffix:colon
r_return
id|ohci_iso_xmit_start
c_func
(paren
id|iso
comma
id|arg
)paren
suffix:semicolon
r_case
id|XMIT_STOP
suffix:colon
id|ohci_iso_xmit_stop
c_func
(paren
id|iso
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|XMIT_QUEUE
suffix:colon
r_return
id|ohci_iso_xmit_queue
c_func
(paren
id|iso
comma
(paren
r_struct
id|hpsb_iso_packet_info
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|XMIT_SHUTDOWN
suffix:colon
id|ohci_iso_xmit_shutdown
c_func
(paren
id|iso
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|RECV_INIT
suffix:colon
r_return
id|ohci_iso_recv_init
c_func
(paren
id|iso
)paren
suffix:semicolon
r_case
id|RECV_START
suffix:colon
(brace
r_int
op_star
id|args
op_assign
(paren
r_int
op_star
)paren
id|arg
suffix:semicolon
r_return
id|ohci_iso_recv_start
c_func
(paren
id|iso
comma
id|args
(braket
l_int|0
)braket
comma
id|args
(braket
l_int|1
)braket
comma
id|args
(braket
l_int|2
)braket
)paren
suffix:semicolon
)brace
r_case
id|RECV_STOP
suffix:colon
id|ohci_iso_recv_stop
c_func
(paren
id|iso
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|RECV_RELEASE
suffix:colon
id|ohci_iso_recv_release
c_func
(paren
id|iso
comma
(paren
r_struct
id|hpsb_iso_packet_info
op_star
)paren
id|arg
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|RECV_FLUSH
suffix:colon
id|ohci_iso_recv_task
c_func
(paren
(paren
r_int
r_int
)paren
id|iso
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|RECV_SHUTDOWN
suffix:colon
id|ohci_iso_recv_shutdown
c_func
(paren
id|iso
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|RECV_LISTEN_CHANNEL
suffix:colon
id|ohci_iso_recv_change_channel
c_func
(paren
id|iso
comma
id|arg
comma
l_int|1
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|RECV_UNLISTEN_CHANNEL
suffix:colon
id|ohci_iso_recv_change_channel
c_func
(paren
id|iso
comma
id|arg
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|RECV_SET_CHANNEL_MASK
suffix:colon
id|ohci_iso_recv_set_channel_mask
c_func
(paren
id|iso
comma
op_star
(paren
(paren
id|u64
op_star
)paren
id|arg
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_default
suffix:colon
id|PRINT_G
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;ohci_isoctl cmd %d not implemented yet&quot;
comma
id|cmd
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/***************************************&n; * IEEE-1394 functionality section END *&n; ***************************************/
multiline_comment|/********************************************************&n; * Global stuff (interrupt handler, init/shutdown code) *&n; ********************************************************/
DECL|function|dma_trm_reset
r_static
r_void
id|dma_trm_reset
c_func
(paren
r_struct
id|dma_trm_ctx
op_star
id|d
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|LIST_HEAD
c_func
(paren
id|packet_list
)paren
suffix:semicolon
r_struct
id|ti_ohci
op_star
id|ohci
op_assign
id|d-&gt;ohci
suffix:semicolon
r_struct
id|hpsb_packet
op_star
id|packet
comma
op_star
id|ptmp
suffix:semicolon
id|ohci1394_stop_context
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlClear
comma
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/* Lock the context, reset it and release it. Move the packets&n;&t; * that were pending in the context to packet_list and free&n;&t; * them after releasing the lock. */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|d-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|list_splice
c_func
(paren
op_amp
id|d-&gt;fifo_list
comma
op_amp
id|packet_list
)paren
suffix:semicolon
id|list_splice
c_func
(paren
op_amp
id|d-&gt;pending_list
comma
op_amp
id|packet_list
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|d-&gt;fifo_list
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|d-&gt;pending_list
)paren
suffix:semicolon
id|d-&gt;branchAddrPtr
op_assign
l_int|NULL
suffix:semicolon
id|d-&gt;sent_ind
op_assign
id|d-&gt;prg_ind
suffix:semicolon
id|d-&gt;free_prgs
op_assign
id|d-&gt;num_desc
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|d-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|list_empty
c_func
(paren
op_amp
id|packet_list
)paren
)paren
r_return
suffix:semicolon
id|PRINT
c_func
(paren
id|KERN_INFO
comma
l_string|&quot;AT dma reset ctx=%d, aborting transmission&quot;
comma
id|d-&gt;ctx
)paren
suffix:semicolon
multiline_comment|/* Now process subsystem callbacks for the packets from this&n;&t; * context. */
id|list_for_each_entry_safe
c_func
(paren
id|packet
comma
id|ptmp
comma
op_amp
id|packet_list
comma
id|driver_list
)paren
(brace
id|list_del_init
c_func
(paren
op_amp
id|packet-&gt;driver_list
)paren
suffix:semicolon
id|hpsb_packet_sent
c_func
(paren
id|ohci-&gt;host
comma
id|packet
comma
id|ACKX_ABORTED
)paren
suffix:semicolon
)brace
)brace
DECL|function|ohci_schedule_iso_tasklets
r_static
r_void
id|ohci_schedule_iso_tasklets
c_func
(paren
r_struct
id|ti_ohci
op_star
id|ohci
comma
id|quadlet_t
id|rx_event
comma
id|quadlet_t
id|tx_event
)paren
(brace
r_struct
id|ohci1394_iso_tasklet
op_star
id|t
suffix:semicolon
r_int
r_int
id|mask
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|ohci-&gt;iso_tasklet_list_lock
)paren
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|t
comma
op_amp
id|ohci-&gt;iso_tasklet_list
comma
id|link
)paren
(brace
id|mask
op_assign
l_int|1
op_lshift
id|t-&gt;context
suffix:semicolon
r_if
c_cond
(paren
id|t-&gt;type
op_eq
id|OHCI_ISO_TRANSMIT
op_logical_and
id|tx_event
op_amp
id|mask
)paren
id|tasklet_schedule
c_func
(paren
op_amp
id|t-&gt;tasklet
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|rx_event
op_amp
id|mask
)paren
id|tasklet_schedule
c_func
(paren
op_amp
id|t-&gt;tasklet
)paren
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|ohci-&gt;iso_tasklet_list_lock
)paren
suffix:semicolon
)brace
DECL|function|ohci_irq_handler
r_static
id|irqreturn_t
id|ohci_irq_handler
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs_are_unused
)paren
(brace
id|quadlet_t
id|event
comma
id|node_id
suffix:semicolon
r_struct
id|ti_ohci
op_star
id|ohci
op_assign
(paren
r_struct
id|ti_ohci
op_star
)paren
id|dev_id
suffix:semicolon
r_struct
id|hpsb_host
op_star
id|host
op_assign
id|ohci-&gt;host
suffix:semicolon
r_int
id|phyid
op_assign
op_minus
l_int|1
comma
id|isroot
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/* Read and clear the interrupt event register.  Don&squot;t clear&n;&t; * the busReset event, though. This is done when we get the&n;&t; * selfIDComplete interrupt. */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ohci-&gt;event_lock
comma
id|flags
)paren
suffix:semicolon
id|event
op_assign
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_IntEventClear
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IntEventClear
comma
id|event
op_amp
op_complement
id|OHCI1394_busReset
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ohci-&gt;event_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|event
)paren
r_return
id|IRQ_NONE
suffix:semicolon
multiline_comment|/* If event is ~(u32)0 cardbus card was ejected.  In this case&n;&t; * we just return, and clean up in the ohci1394_pci_remove&n;&t; * function. */
r_if
c_cond
(paren
id|event
op_eq
op_complement
(paren
id|u32
)paren
l_int|0
)paren
(brace
id|DBGMSG
c_func
(paren
l_string|&quot;Device removed.&quot;
)paren
suffix:semicolon
r_return
id|IRQ_NONE
suffix:semicolon
)brace
id|DBGMSG
c_func
(paren
l_string|&quot;IntEvent: %08x&quot;
comma
id|event
)paren
suffix:semicolon
r_if
c_cond
(paren
id|event
op_amp
id|OHCI1394_unrecoverableError
)paren
(brace
r_int
id|ctx
suffix:semicolon
id|PRINT
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;Unrecoverable error!&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_AsReqTrContextControlSet
)paren
op_amp
l_int|0x800
)paren
id|PRINT
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;Async Req Tx Context died: &quot;
l_string|&quot;ctrl[%08x] cmdptr[%08x]&quot;
comma
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_AsReqTrContextControlSet
)paren
comma
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_AsReqTrCommandPtr
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_AsRspTrContextControlSet
)paren
op_amp
l_int|0x800
)paren
id|PRINT
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;Async Rsp Tx Context died: &quot;
l_string|&quot;ctrl[%08x] cmdptr[%08x]&quot;
comma
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_AsRspTrContextControlSet
)paren
comma
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_AsRspTrCommandPtr
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_AsReqRcvContextControlSet
)paren
op_amp
l_int|0x800
)paren
id|PRINT
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;Async Req Rcv Context died: &quot;
l_string|&quot;ctrl[%08x] cmdptr[%08x]&quot;
comma
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_AsReqRcvContextControlSet
)paren
comma
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_AsReqRcvCommandPtr
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_AsRspRcvContextControlSet
)paren
op_amp
l_int|0x800
)paren
id|PRINT
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;Async Rsp Rcv Context died: &quot;
l_string|&quot;ctrl[%08x] cmdptr[%08x]&quot;
comma
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_AsRspRcvContextControlSet
)paren
comma
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_AsRspRcvCommandPtr
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|ctx
op_assign
l_int|0
suffix:semicolon
id|ctx
OL
id|ohci-&gt;nb_iso_xmit_ctx
suffix:semicolon
id|ctx
op_increment
)paren
(brace
r_if
c_cond
(paren
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_IsoXmitContextControlSet
op_plus
(paren
l_int|16
op_star
id|ctx
)paren
)paren
op_amp
l_int|0x800
)paren
id|PRINT
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;Iso Xmit %d Context died: &quot;
l_string|&quot;ctrl[%08x] cmdptr[%08x]&quot;
comma
id|ctx
comma
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_IsoXmitContextControlSet
op_plus
(paren
l_int|16
op_star
id|ctx
)paren
)paren
comma
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_IsoXmitCommandPtr
op_plus
(paren
l_int|16
op_star
id|ctx
)paren
)paren
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|ctx
op_assign
l_int|0
suffix:semicolon
id|ctx
OL
id|ohci-&gt;nb_iso_rcv_ctx
suffix:semicolon
id|ctx
op_increment
)paren
(brace
r_if
c_cond
(paren
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_IsoRcvContextControlSet
op_plus
(paren
l_int|32
op_star
id|ctx
)paren
)paren
op_amp
l_int|0x800
)paren
id|PRINT
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;Iso Recv %d Context died: &quot;
l_string|&quot;ctrl[%08x] cmdptr[%08x] match[%08x]&quot;
comma
id|ctx
comma
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_IsoRcvContextControlSet
op_plus
(paren
l_int|32
op_star
id|ctx
)paren
)paren
comma
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_IsoRcvCommandPtr
op_plus
(paren
l_int|32
op_star
id|ctx
)paren
)paren
comma
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_IsoRcvContextMatch
op_plus
(paren
l_int|32
op_star
id|ctx
)paren
)paren
)paren
suffix:semicolon
)brace
id|event
op_and_assign
op_complement
id|OHCI1394_unrecoverableError
suffix:semicolon
)brace
r_if
c_cond
(paren
id|event
op_amp
id|OHCI1394_cycleInconsistent
)paren
(brace
multiline_comment|/* We subscribe to the cycleInconsistent event only to&n;&t;&t; * clear the corresponding event bit... otherwise,&n;&t;&t; * isochronous cycleMatch DMA won&squot;t work. */
id|DBGMSG
c_func
(paren
l_string|&quot;OHCI1394_cycleInconsistent&quot;
)paren
suffix:semicolon
id|event
op_and_assign
op_complement
id|OHCI1394_cycleInconsistent
suffix:semicolon
)brace
r_if
c_cond
(paren
id|event
op_amp
id|OHCI1394_busReset
)paren
(brace
multiline_comment|/* The busReset event bit can&squot;t be cleared during the&n;&t;&t; * selfID phase, so we disable busReset interrupts, to&n;&t;&t; * avoid burying the cpu in interrupt requests. */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ohci-&gt;event_lock
comma
id|flags
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IntMaskClear
comma
id|OHCI1394_busReset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ohci-&gt;check_busreset
)paren
(brace
r_int
id|loop_count
op_assign
l_int|0
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
r_while
c_loop
(paren
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_IntEventSet
)paren
op_amp
id|OHCI1394_busReset
)paren
(brace
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IntEventClear
comma
id|OHCI1394_busReset
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ohci-&gt;event_lock
comma
id|flags
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ohci-&gt;event_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* The loop counter check is to prevent the driver&n;&t;&t;&t;&t; * from remaining in this state forever. For the&n;&t;&t;&t;&t; * initial bus reset, the loop continues for ever&n;&t;&t;&t;&t; * and the system hangs, until some device is plugged-in&n;&t;&t;&t;&t; * or out manually into a port! The forced reset seems&n;&t;&t;&t;&t; * to solve this problem. This mainly effects nForce2. */
r_if
c_cond
(paren
id|loop_count
OG
l_int|10000
)paren
(brace
id|ohci_devctl
c_func
(paren
id|host
comma
id|RESET_BUS
comma
id|LONG_RESET
)paren
suffix:semicolon
id|DBGMSG
c_func
(paren
l_string|&quot;Detected bus-reset loop. Forced a bus reset!&quot;
)paren
suffix:semicolon
id|loop_count
op_assign
l_int|0
suffix:semicolon
)brace
id|loop_count
op_increment
suffix:semicolon
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ohci-&gt;event_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|host-&gt;in_bus_reset
)paren
(brace
id|DBGMSG
c_func
(paren
l_string|&quot;irq_handler: Bus reset requested&quot;
)paren
suffix:semicolon
multiline_comment|/* Subsystem call */
id|hpsb_bus_reset
c_func
(paren
id|ohci-&gt;host
)paren
suffix:semicolon
)brace
id|event
op_and_assign
op_complement
id|OHCI1394_busReset
suffix:semicolon
)brace
r_if
c_cond
(paren
id|event
op_amp
id|OHCI1394_reqTxComplete
)paren
(brace
r_struct
id|dma_trm_ctx
op_star
id|d
op_assign
op_amp
id|ohci-&gt;at_req_context
suffix:semicolon
id|DBGMSG
c_func
(paren
l_string|&quot;Got reqTxComplete interrupt &quot;
l_string|&quot;status=0x%08X&quot;
comma
id|reg_read
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlSet
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|reg_read
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlSet
)paren
op_amp
l_int|0x800
)paren
id|ohci1394_stop_context
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlClear
comma
l_string|&quot;reqTxComplete&quot;
)paren
suffix:semicolon
r_else
id|dma_trm_tasklet
c_func
(paren
(paren
r_int
r_int
)paren
id|d
)paren
suffix:semicolon
singleline_comment|//tasklet_schedule(&amp;d-&gt;task);
id|event
op_and_assign
op_complement
id|OHCI1394_reqTxComplete
suffix:semicolon
)brace
r_if
c_cond
(paren
id|event
op_amp
id|OHCI1394_respTxComplete
)paren
(brace
r_struct
id|dma_trm_ctx
op_star
id|d
op_assign
op_amp
id|ohci-&gt;at_resp_context
suffix:semicolon
id|DBGMSG
c_func
(paren
l_string|&quot;Got respTxComplete interrupt &quot;
l_string|&quot;status=0x%08X&quot;
comma
id|reg_read
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlSet
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|reg_read
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlSet
)paren
op_amp
l_int|0x800
)paren
id|ohci1394_stop_context
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlClear
comma
l_string|&quot;respTxComplete&quot;
)paren
suffix:semicolon
r_else
id|tasklet_schedule
c_func
(paren
op_amp
id|d-&gt;task
)paren
suffix:semicolon
id|event
op_and_assign
op_complement
id|OHCI1394_respTxComplete
suffix:semicolon
)brace
r_if
c_cond
(paren
id|event
op_amp
id|OHCI1394_RQPkt
)paren
(brace
r_struct
id|dma_rcv_ctx
op_star
id|d
op_assign
op_amp
id|ohci-&gt;ar_req_context
suffix:semicolon
id|DBGMSG
c_func
(paren
l_string|&quot;Got RQPkt interrupt status=0x%08X&quot;
comma
id|reg_read
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlSet
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|reg_read
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlSet
)paren
op_amp
l_int|0x800
)paren
id|ohci1394_stop_context
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlClear
comma
l_string|&quot;RQPkt&quot;
)paren
suffix:semicolon
r_else
id|tasklet_schedule
c_func
(paren
op_amp
id|d-&gt;task
)paren
suffix:semicolon
id|event
op_and_assign
op_complement
id|OHCI1394_RQPkt
suffix:semicolon
)brace
r_if
c_cond
(paren
id|event
op_amp
id|OHCI1394_RSPkt
)paren
(brace
r_struct
id|dma_rcv_ctx
op_star
id|d
op_assign
op_amp
id|ohci-&gt;ar_resp_context
suffix:semicolon
id|DBGMSG
c_func
(paren
l_string|&quot;Got RSPkt interrupt status=0x%08X&quot;
comma
id|reg_read
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlSet
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|reg_read
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlSet
)paren
op_amp
l_int|0x800
)paren
id|ohci1394_stop_context
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlClear
comma
l_string|&quot;RSPkt&quot;
)paren
suffix:semicolon
r_else
id|tasklet_schedule
c_func
(paren
op_amp
id|d-&gt;task
)paren
suffix:semicolon
id|event
op_and_assign
op_complement
id|OHCI1394_RSPkt
suffix:semicolon
)brace
r_if
c_cond
(paren
id|event
op_amp
id|OHCI1394_isochRx
)paren
(brace
id|quadlet_t
id|rx_event
suffix:semicolon
id|rx_event
op_assign
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_IsoRecvIntEventSet
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IsoRecvIntEventClear
comma
id|rx_event
)paren
suffix:semicolon
id|ohci_schedule_iso_tasklets
c_func
(paren
id|ohci
comma
id|rx_event
comma
l_int|0
)paren
suffix:semicolon
id|event
op_and_assign
op_complement
id|OHCI1394_isochRx
suffix:semicolon
)brace
r_if
c_cond
(paren
id|event
op_amp
id|OHCI1394_isochTx
)paren
(brace
id|quadlet_t
id|tx_event
suffix:semicolon
id|tx_event
op_assign
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_IsoXmitIntEventSet
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IsoXmitIntEventClear
comma
id|tx_event
)paren
suffix:semicolon
id|ohci_schedule_iso_tasklets
c_func
(paren
id|ohci
comma
l_int|0
comma
id|tx_event
)paren
suffix:semicolon
id|event
op_and_assign
op_complement
id|OHCI1394_isochTx
suffix:semicolon
)brace
r_if
c_cond
(paren
id|event
op_amp
id|OHCI1394_selfIDComplete
)paren
(brace
r_if
c_cond
(paren
id|host-&gt;in_bus_reset
)paren
(brace
id|node_id
op_assign
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_NodeID
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|node_id
op_amp
l_int|0x80000000
)paren
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;SelfID received, but NodeID invalid &quot;
l_string|&quot;(probably new bus reset occurred): %08X&quot;
comma
id|node_id
)paren
suffix:semicolon
r_goto
id|selfid_not_valid
suffix:semicolon
)brace
id|phyid
op_assign
id|node_id
op_amp
l_int|0x0000003f
suffix:semicolon
id|isroot
op_assign
(paren
id|node_id
op_amp
l_int|0x40000000
)paren
op_ne
l_int|0
suffix:semicolon
id|DBGMSG
c_func
(paren
l_string|&quot;SelfID interrupt received &quot;
l_string|&quot;(phyid %d, %s)&quot;
comma
id|phyid
comma
(paren
id|isroot
ques
c_cond
l_string|&quot;root&quot;
suffix:colon
l_string|&quot;not root&quot;
)paren
)paren
suffix:semicolon
id|handle_selfid
c_func
(paren
id|ohci
comma
id|host
comma
id|phyid
comma
id|isroot
)paren
suffix:semicolon
multiline_comment|/* Clear the bus reset event and re-enable the&n;&t;&t;&t; * busReset interrupt.  */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ohci-&gt;event_lock
comma
id|flags
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IntEventClear
comma
id|OHCI1394_busReset
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IntMaskSet
comma
id|OHCI1394_busReset
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ohci-&gt;event_lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Accept Physical requests from all nodes. */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_AsReqFilterHiSet
comma
l_int|0xffffffff
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_AsReqFilterLoSet
comma
l_int|0xffffffff
)paren
suffix:semicolon
multiline_comment|/* Turn on phys dma reception.&n;&t;&t;&t; *&n;&t;&t;&t; * TODO: Enable some sort of filtering management.&n;&t;&t;&t; */
r_if
c_cond
(paren
id|phys_dma
)paren
(brace
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_PhyReqFilterHiSet
comma
l_int|0xffffffff
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_PhyReqFilterLoSet
comma
l_int|0xffffffff
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_PhyUpperBound
comma
l_int|0xffff0000
)paren
suffix:semicolon
)brace
r_else
(brace
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_PhyReqFilterHiSet
comma
l_int|0x00000000
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_PhyReqFilterLoSet
comma
l_int|0x00000000
)paren
suffix:semicolon
)brace
id|DBGMSG
c_func
(paren
l_string|&quot;PhyReqFilter=%08x%08x&quot;
comma
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_PhyReqFilterHiSet
)paren
comma
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_PhyReqFilterLoSet
)paren
)paren
suffix:semicolon
id|hpsb_selfid_complete
c_func
(paren
id|host
comma
id|phyid
comma
id|isroot
)paren
suffix:semicolon
)brace
r_else
id|PRINT
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;SelfID received outside of bus reset sequence&quot;
)paren
suffix:semicolon
id|selfid_not_valid
suffix:colon
id|event
op_and_assign
op_complement
id|OHCI1394_selfIDComplete
suffix:semicolon
)brace
multiline_comment|/* Make sure we handle everything, just in case we accidentally&n;&t; * enabled an interrupt that we didn&squot;t write a handler for.  */
r_if
c_cond
(paren
id|event
)paren
id|PRINT
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;Unhandled interrupt(s) 0x%08x&quot;
comma
id|event
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
multiline_comment|/* Put the buffer back into the dma context */
DECL|function|insert_dma_buffer
r_static
r_void
id|insert_dma_buffer
c_func
(paren
r_struct
id|dma_rcv_ctx
op_star
id|d
comma
r_int
id|idx
)paren
(brace
r_struct
id|ti_ohci
op_star
id|ohci
op_assign
(paren
r_struct
id|ti_ohci
op_star
)paren
(paren
id|d-&gt;ohci
)paren
suffix:semicolon
id|DBGMSG
c_func
(paren
l_string|&quot;Inserting dma buf ctx=%d idx=%d&quot;
comma
id|d-&gt;ctx
comma
id|idx
)paren
suffix:semicolon
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|status
op_assign
id|cpu_to_le32
c_func
(paren
id|d-&gt;buf_size
)paren
suffix:semicolon
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|branchAddress
op_and_assign
id|le32_to_cpu
c_func
(paren
l_int|0xfffffff0
)paren
suffix:semicolon
id|idx
op_assign
(paren
id|idx
op_plus
id|d-&gt;num_desc
op_minus
l_int|1
)paren
op_mod
id|d-&gt;num_desc
suffix:semicolon
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|branchAddress
op_or_assign
id|le32_to_cpu
c_func
(paren
l_int|0x00000001
)paren
suffix:semicolon
multiline_comment|/* wake up the dma context if necessary */
r_if
c_cond
(paren
op_logical_neg
(paren
id|reg_read
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlSet
)paren
op_amp
l_int|0x400
)paren
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_INFO
comma
l_string|&quot;Waking dma ctx=%d ... processing is probably too slow&quot;
comma
id|d-&gt;ctx
)paren
suffix:semicolon
)brace
multiline_comment|/* do this always, to avoid race condition */
id|reg_write
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlSet
comma
l_int|0x1000
)paren
suffix:semicolon
)brace
DECL|macro|cond_le32_to_cpu
mdefine_line|#define cond_le32_to_cpu(data, noswap) &bslash;&n;&t;(noswap ? data : le32_to_cpu(data))
DECL|variable|TCODE_SIZE
r_static
r_const
r_int
id|TCODE_SIZE
(braket
l_int|16
)braket
op_assign
(brace
l_int|20
comma
l_int|0
comma
l_int|16
comma
op_minus
l_int|1
comma
l_int|16
comma
l_int|20
comma
l_int|20
comma
l_int|0
comma
op_minus
l_int|1
comma
l_int|0
comma
op_minus
l_int|1
comma
l_int|0
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
l_int|16
comma
op_minus
l_int|1
)brace
suffix:semicolon
multiline_comment|/*&n; * Determine the length of a packet in the buffer&n; * Optimization suggested by Pascal Drolet &lt;pascal.drolet@informission.ca&gt;&n; */
DECL|function|packet_length
r_static
id|__inline__
r_int
id|packet_length
c_func
(paren
r_struct
id|dma_rcv_ctx
op_star
id|d
comma
r_int
id|idx
comma
id|quadlet_t
op_star
id|buf_ptr
comma
r_int
id|offset
comma
r_int
r_char
id|tcode
comma
r_int
id|noswap
)paren
(brace
r_int
id|length
op_assign
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;type
op_eq
id|DMA_CTX_ASYNC_REQ
op_logical_or
id|d-&gt;type
op_eq
id|DMA_CTX_ASYNC_RESP
)paren
(brace
id|length
op_assign
id|TCODE_SIZE
(braket
id|tcode
)braket
suffix:semicolon
r_if
c_cond
(paren
id|length
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|offset
op_plus
l_int|12
op_ge
id|d-&gt;buf_size
)paren
(brace
id|length
op_assign
(paren
id|cond_le32_to_cpu
c_func
(paren
id|d-&gt;buf_cpu
(braket
(paren
id|idx
op_plus
l_int|1
)paren
op_mod
id|d-&gt;num_desc
)braket
(braket
l_int|3
op_minus
(paren
(paren
id|d-&gt;buf_size
op_minus
id|offset
)paren
op_rshift
l_int|2
)paren
)braket
comma
id|noswap
)paren
op_rshift
l_int|16
)paren
suffix:semicolon
)brace
r_else
(brace
id|length
op_assign
(paren
id|cond_le32_to_cpu
c_func
(paren
id|buf_ptr
(braket
l_int|3
)braket
comma
id|noswap
)paren
op_rshift
l_int|16
)paren
suffix:semicolon
)brace
id|length
op_add_assign
l_int|20
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|d-&gt;type
op_eq
id|DMA_CTX_ISO
)paren
(brace
multiline_comment|/* Assumption: buffer fill mode with header/trailer */
id|length
op_assign
(paren
id|cond_le32_to_cpu
c_func
(paren
id|buf_ptr
(braket
l_int|0
)braket
comma
id|noswap
)paren
op_rshift
l_int|16
)paren
op_plus
l_int|8
suffix:semicolon
)brace
r_if
c_cond
(paren
id|length
OG
l_int|0
op_logical_and
id|length
op_mod
l_int|4
)paren
id|length
op_add_assign
l_int|4
op_minus
(paren
id|length
op_mod
l_int|4
)paren
suffix:semicolon
r_return
id|length
suffix:semicolon
)brace
multiline_comment|/* Tasklet that processes dma receive buffers */
DECL|function|dma_rcv_tasklet
r_static
r_void
id|dma_rcv_tasklet
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|dma_rcv_ctx
op_star
id|d
op_assign
(paren
r_struct
id|dma_rcv_ctx
op_star
)paren
id|data
suffix:semicolon
r_struct
id|ti_ohci
op_star
id|ohci
op_assign
(paren
r_struct
id|ti_ohci
op_star
)paren
(paren
id|d-&gt;ohci
)paren
suffix:semicolon
r_int
r_int
id|split_left
comma
id|idx
comma
id|offset
comma
id|rescount
suffix:semicolon
r_int
r_char
id|tcode
suffix:semicolon
r_int
id|length
comma
id|bytes_left
comma
id|ack
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|quadlet_t
op_star
id|buf_ptr
suffix:semicolon
r_char
op_star
id|split_ptr
suffix:semicolon
r_char
id|msg
(braket
l_int|256
)braket
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|d-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|idx
op_assign
id|d-&gt;buf_ind
suffix:semicolon
id|offset
op_assign
id|d-&gt;buf_offset
suffix:semicolon
id|buf_ptr
op_assign
id|d-&gt;buf_cpu
(braket
id|idx
)braket
op_plus
id|offset
op_div
l_int|4
suffix:semicolon
id|rescount
op_assign
id|le32_to_cpu
c_func
(paren
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|status
)paren
op_amp
l_int|0xffff
suffix:semicolon
id|bytes_left
op_assign
id|d-&gt;buf_size
op_minus
id|rescount
op_minus
id|offset
suffix:semicolon
r_while
c_loop
(paren
id|bytes_left
OG
l_int|0
)paren
(brace
id|tcode
op_assign
(paren
id|cond_le32_to_cpu
c_func
(paren
id|buf_ptr
(braket
l_int|0
)braket
comma
id|ohci-&gt;no_swap_incoming
)paren
op_rshift
l_int|4
)paren
op_amp
l_int|0xf
suffix:semicolon
multiline_comment|/* packet_length() will return &lt; 4 for an error */
id|length
op_assign
id|packet_length
c_func
(paren
id|d
comma
id|idx
comma
id|buf_ptr
comma
id|offset
comma
id|tcode
comma
id|ohci-&gt;no_swap_incoming
)paren
suffix:semicolon
r_if
c_cond
(paren
id|length
OL
l_int|4
)paren
(brace
multiline_comment|/* something is wrong */
id|sprintf
c_func
(paren
id|msg
comma
l_string|&quot;Unexpected tcode 0x%x(0x%08x) in AR ctx=%d, length=%d&quot;
comma
id|tcode
comma
id|cond_le32_to_cpu
c_func
(paren
id|buf_ptr
(braket
l_int|0
)braket
comma
id|ohci-&gt;no_swap_incoming
)paren
comma
id|d-&gt;ctx
comma
id|length
)paren
suffix:semicolon
id|ohci1394_stop_context
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlClear
comma
id|msg
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|d-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* The first case is where we have a packet that crosses&n;&t;&t; * over more than one descriptor. The next case is where&n;&t;&t; * it&squot;s all in the first descriptor.  */
r_if
c_cond
(paren
(paren
id|offset
op_plus
id|length
)paren
OG
id|d-&gt;buf_size
)paren
(brace
id|DBGMSG
c_func
(paren
l_string|&quot;Split packet rcv&squot;d&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|length
OG
id|d-&gt;split_buf_size
)paren
(brace
id|ohci1394_stop_context
c_func
(paren
id|ohci
comma
id|d-&gt;ctrlClear
comma
l_string|&quot;Split packet size exceeded&quot;
)paren
suffix:semicolon
id|d-&gt;buf_ind
op_assign
id|idx
suffix:semicolon
id|d-&gt;buf_offset
op_assign
id|offset
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|d-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|le32_to_cpu
c_func
(paren
id|d-&gt;prg_cpu
(braket
(paren
id|idx
op_plus
l_int|1
)paren
op_mod
id|d-&gt;num_desc
)braket
op_member_access_from_pointer
id|status
)paren
op_eq
id|d-&gt;buf_size
)paren
(brace
multiline_comment|/* Other part of packet not written yet.&n;&t;&t;&t;&t; * this should never happen I think&n;&t;&t;&t;&t; * anyway we&squot;ll get it on the next call.  */
id|PRINT
c_func
(paren
id|KERN_INFO
comma
l_string|&quot;Got only half a packet!&quot;
)paren
suffix:semicolon
id|d-&gt;buf_ind
op_assign
id|idx
suffix:semicolon
id|d-&gt;buf_offset
op_assign
id|offset
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|d-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|split_left
op_assign
id|length
suffix:semicolon
id|split_ptr
op_assign
(paren
r_char
op_star
)paren
id|d-&gt;spb
suffix:semicolon
id|memcpy
c_func
(paren
id|split_ptr
comma
id|buf_ptr
comma
id|d-&gt;buf_size
op_minus
id|offset
)paren
suffix:semicolon
id|split_left
op_sub_assign
id|d-&gt;buf_size
op_minus
id|offset
suffix:semicolon
id|split_ptr
op_add_assign
id|d-&gt;buf_size
op_minus
id|offset
suffix:semicolon
id|insert_dma_buffer
c_func
(paren
id|d
comma
id|idx
)paren
suffix:semicolon
id|idx
op_assign
(paren
id|idx
op_plus
l_int|1
)paren
op_mod
id|d-&gt;num_desc
suffix:semicolon
id|buf_ptr
op_assign
id|d-&gt;buf_cpu
(braket
id|idx
)braket
suffix:semicolon
id|offset
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|split_left
op_ge
id|d-&gt;buf_size
)paren
(brace
id|memcpy
c_func
(paren
id|split_ptr
comma
id|buf_ptr
comma
id|d-&gt;buf_size
)paren
suffix:semicolon
id|split_ptr
op_add_assign
id|d-&gt;buf_size
suffix:semicolon
id|split_left
op_sub_assign
id|d-&gt;buf_size
suffix:semicolon
id|insert_dma_buffer
c_func
(paren
id|d
comma
id|idx
)paren
suffix:semicolon
id|idx
op_assign
(paren
id|idx
op_plus
l_int|1
)paren
op_mod
id|d-&gt;num_desc
suffix:semicolon
id|buf_ptr
op_assign
id|d-&gt;buf_cpu
(braket
id|idx
)braket
suffix:semicolon
)brace
r_if
c_cond
(paren
id|split_left
OG
l_int|0
)paren
(brace
id|memcpy
c_func
(paren
id|split_ptr
comma
id|buf_ptr
comma
id|split_left
)paren
suffix:semicolon
id|offset
op_assign
id|split_left
suffix:semicolon
id|buf_ptr
op_add_assign
id|offset
op_div
l_int|4
suffix:semicolon
)brace
)brace
r_else
(brace
id|DBGMSG
c_func
(paren
l_string|&quot;Single packet rcv&squot;d&quot;
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|d-&gt;spb
comma
id|buf_ptr
comma
id|length
)paren
suffix:semicolon
id|offset
op_add_assign
id|length
suffix:semicolon
id|buf_ptr
op_add_assign
id|length
op_div
l_int|4
suffix:semicolon
r_if
c_cond
(paren
id|offset
op_eq
id|d-&gt;buf_size
)paren
(brace
id|insert_dma_buffer
c_func
(paren
id|d
comma
id|idx
)paren
suffix:semicolon
id|idx
op_assign
(paren
id|idx
op_plus
l_int|1
)paren
op_mod
id|d-&gt;num_desc
suffix:semicolon
id|buf_ptr
op_assign
id|d-&gt;buf_cpu
(braket
id|idx
)braket
suffix:semicolon
id|offset
op_assign
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/* We get one phy packet to the async descriptor for each&n;&t;&t; * bus reset. We always ignore it.  */
r_if
c_cond
(paren
id|tcode
op_ne
id|OHCI1394_TCODE_PHY
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ohci-&gt;no_swap_incoming
)paren
id|packet_swab
c_func
(paren
id|d-&gt;spb
comma
id|tcode
)paren
suffix:semicolon
id|DBGMSG
c_func
(paren
l_string|&quot;Packet received from node&quot;
l_string|&quot; %d ack=0x%02X spd=%d tcode=0x%X&quot;
l_string|&quot; length=%d ctx=%d tlabel=%d&quot;
comma
(paren
id|d-&gt;spb
(braket
l_int|1
)braket
op_rshift
l_int|16
)paren
op_amp
l_int|0x3f
comma
(paren
id|cond_le32_to_cpu
c_func
(paren
id|d-&gt;spb
(braket
id|length
op_div
l_int|4
op_minus
l_int|1
)braket
comma
id|ohci-&gt;no_swap_incoming
)paren
op_rshift
l_int|16
)paren
op_amp
l_int|0x1f
comma
(paren
id|cond_le32_to_cpu
c_func
(paren
id|d-&gt;spb
(braket
id|length
op_div
l_int|4
op_minus
l_int|1
)braket
comma
id|ohci-&gt;no_swap_incoming
)paren
op_rshift
l_int|21
)paren
op_amp
l_int|0x3
comma
id|tcode
comma
id|length
comma
id|d-&gt;ctx
comma
(paren
id|cond_le32_to_cpu
c_func
(paren
id|d-&gt;spb
(braket
id|length
op_div
l_int|4
op_minus
l_int|1
)braket
comma
id|ohci-&gt;no_swap_incoming
)paren
op_rshift
l_int|10
)paren
op_amp
l_int|0x3f
)paren
suffix:semicolon
id|ack
op_assign
(paren
(paren
(paren
id|cond_le32_to_cpu
c_func
(paren
id|d-&gt;spb
(braket
id|length
op_div
l_int|4
op_minus
l_int|1
)braket
comma
id|ohci-&gt;no_swap_incoming
)paren
op_rshift
l_int|16
)paren
op_amp
l_int|0x1f
)paren
op_eq
l_int|0x11
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|hpsb_packet_received
c_func
(paren
id|ohci-&gt;host
comma
id|d-&gt;spb
comma
id|length
op_minus
l_int|4
comma
id|ack
)paren
suffix:semicolon
)brace
macro_line|#ifdef OHCI1394_DEBUG
r_else
id|PRINT
(paren
id|KERN_DEBUG
comma
l_string|&quot;Got phy packet ctx=%d ... discarded&quot;
comma
id|d-&gt;ctx
)paren
suffix:semicolon
macro_line|#endif
id|rescount
op_assign
id|le32_to_cpu
c_func
(paren
id|d-&gt;prg_cpu
(braket
id|idx
)braket
op_member_access_from_pointer
id|status
)paren
op_amp
l_int|0xffff
suffix:semicolon
id|bytes_left
op_assign
id|d-&gt;buf_size
op_minus
id|rescount
op_minus
id|offset
suffix:semicolon
)brace
id|d-&gt;buf_ind
op_assign
id|idx
suffix:semicolon
id|d-&gt;buf_offset
op_assign
id|offset
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|d-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* Bottom half that processes sent packets */
DECL|function|dma_trm_tasklet
r_static
r_void
id|dma_trm_tasklet
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|dma_trm_ctx
op_star
id|d
op_assign
(paren
r_struct
id|dma_trm_ctx
op_star
)paren
id|data
suffix:semicolon
r_struct
id|ti_ohci
op_star
id|ohci
op_assign
(paren
r_struct
id|ti_ohci
op_star
)paren
(paren
id|d-&gt;ohci
)paren
suffix:semicolon
r_struct
id|hpsb_packet
op_star
id|packet
comma
op_star
id|ptmp
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|u32
id|status
comma
id|ack
suffix:semicolon
r_int
id|datasize
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|d-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|list_for_each_entry_safe
c_func
(paren
id|packet
comma
id|ptmp
comma
op_amp
id|d-&gt;fifo_list
comma
id|driver_list
)paren
(brace
id|datasize
op_assign
id|packet-&gt;data_size
suffix:semicolon
r_if
c_cond
(paren
id|datasize
op_logical_and
id|packet-&gt;type
op_ne
id|hpsb_raw
)paren
id|status
op_assign
id|le32_to_cpu
c_func
(paren
id|d-&gt;prg_cpu
(braket
id|d-&gt;sent_ind
)braket
op_member_access_from_pointer
id|end.status
)paren
op_rshift
l_int|16
suffix:semicolon
r_else
id|status
op_assign
id|le32_to_cpu
c_func
(paren
id|d-&gt;prg_cpu
(braket
id|d-&gt;sent_ind
)braket
op_member_access_from_pointer
id|begin.status
)paren
op_rshift
l_int|16
suffix:semicolon
r_if
c_cond
(paren
id|status
op_eq
l_int|0
)paren
multiline_comment|/* this packet hasn&squot;t been sent yet*/
r_break
suffix:semicolon
macro_line|#ifdef OHCI1394_DEBUG
r_if
c_cond
(paren
id|datasize
)paren
r_if
c_cond
(paren
(paren
(paren
id|le32_to_cpu
c_func
(paren
id|d-&gt;prg_cpu
(braket
id|d-&gt;sent_ind
)braket
op_member_access_from_pointer
id|data
(braket
l_int|0
)braket
)paren
op_rshift
l_int|4
)paren
op_amp
l_int|0xf
)paren
op_eq
l_int|0xa
)paren
id|DBGMSG
c_func
(paren
l_string|&quot;Stream packet sent to channel %d tcode=0x%X &quot;
l_string|&quot;ack=0x%X spd=%d dataLength=%d ctx=%d&quot;
comma
(paren
id|le32_to_cpu
c_func
(paren
id|d-&gt;prg_cpu
(braket
id|d-&gt;sent_ind
)braket
op_member_access_from_pointer
id|data
(braket
l_int|0
)braket
)paren
op_rshift
l_int|8
)paren
op_amp
l_int|0x3f
comma
(paren
id|le32_to_cpu
c_func
(paren
id|d-&gt;prg_cpu
(braket
id|d-&gt;sent_ind
)braket
op_member_access_from_pointer
id|data
(braket
l_int|0
)braket
)paren
op_rshift
l_int|4
)paren
op_amp
l_int|0xf
comma
id|status
op_amp
l_int|0x1f
comma
(paren
id|status
op_rshift
l_int|5
)paren
op_amp
l_int|0x3
comma
id|le32_to_cpu
c_func
(paren
id|d-&gt;prg_cpu
(braket
id|d-&gt;sent_ind
)braket
op_member_access_from_pointer
id|data
(braket
l_int|1
)braket
)paren
op_rshift
l_int|16
comma
id|d-&gt;ctx
)paren
suffix:semicolon
r_else
id|DBGMSG
c_func
(paren
l_string|&quot;Packet sent to node %d tcode=0x%X tLabel=&quot;
l_string|&quot;0x%02X ack=0x%X spd=%d dataLength=%d ctx=%d&quot;
comma
(paren
id|le32_to_cpu
c_func
(paren
id|d-&gt;prg_cpu
(braket
id|d-&gt;sent_ind
)braket
op_member_access_from_pointer
id|data
(braket
l_int|1
)braket
)paren
op_rshift
l_int|16
)paren
op_amp
l_int|0x3f
comma
(paren
id|le32_to_cpu
c_func
(paren
id|d-&gt;prg_cpu
(braket
id|d-&gt;sent_ind
)braket
op_member_access_from_pointer
id|data
(braket
l_int|0
)braket
)paren
op_rshift
l_int|4
)paren
op_amp
l_int|0xf
comma
(paren
id|le32_to_cpu
c_func
(paren
id|d-&gt;prg_cpu
(braket
id|d-&gt;sent_ind
)braket
op_member_access_from_pointer
id|data
(braket
l_int|0
)braket
)paren
op_rshift
l_int|10
)paren
op_amp
l_int|0x3f
comma
id|status
op_amp
l_int|0x1f
comma
(paren
id|status
op_rshift
l_int|5
)paren
op_amp
l_int|0x3
comma
id|le32_to_cpu
c_func
(paren
id|d-&gt;prg_cpu
(braket
id|d-&gt;sent_ind
)braket
op_member_access_from_pointer
id|data
(braket
l_int|3
)braket
)paren
op_rshift
l_int|16
comma
id|d-&gt;ctx
)paren
suffix:semicolon
r_else
id|DBGMSG
c_func
(paren
l_string|&quot;Packet sent to node %d tcode=0x%X tLabel=&quot;
l_string|&quot;0x%02X ack=0x%X spd=%d data=0x%08X ctx=%d&quot;
comma
(paren
id|le32_to_cpu
c_func
(paren
id|d-&gt;prg_cpu
(braket
id|d-&gt;sent_ind
)braket
op_member_access_from_pointer
id|data
(braket
l_int|1
)braket
)paren
op_rshift
l_int|16
)paren
op_amp
l_int|0x3f
comma
(paren
id|le32_to_cpu
c_func
(paren
id|d-&gt;prg_cpu
(braket
id|d-&gt;sent_ind
)braket
op_member_access_from_pointer
id|data
(braket
l_int|0
)braket
)paren
op_rshift
l_int|4
)paren
op_amp
l_int|0xf
comma
(paren
id|le32_to_cpu
c_func
(paren
id|d-&gt;prg_cpu
(braket
id|d-&gt;sent_ind
)braket
op_member_access_from_pointer
id|data
(braket
l_int|0
)braket
)paren
op_rshift
l_int|10
)paren
op_amp
l_int|0x3f
comma
id|status
op_amp
l_int|0x1f
comma
(paren
id|status
op_rshift
l_int|5
)paren
op_amp
l_int|0x3
comma
id|le32_to_cpu
c_func
(paren
id|d-&gt;prg_cpu
(braket
id|d-&gt;sent_ind
)braket
op_member_access_from_pointer
id|data
(braket
l_int|3
)braket
)paren
comma
id|d-&gt;ctx
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|status
op_amp
l_int|0x10
)paren
(brace
id|ack
op_assign
id|status
op_amp
l_int|0xf
suffix:semicolon
)brace
r_else
(brace
r_switch
c_cond
(paren
id|status
op_amp
l_int|0x1f
)paren
(brace
r_case
id|EVT_NO_STATUS
suffix:colon
multiline_comment|/* that should never happen */
r_case
id|EVT_RESERVED_A
suffix:colon
multiline_comment|/* that should never happen */
r_case
id|EVT_LONG_PACKET
suffix:colon
multiline_comment|/* that should never happen */
id|PRINT
c_func
(paren
id|KERN_WARNING
comma
l_string|&quot;Received OHCI evt_* error 0x%x&quot;
comma
id|status
op_amp
l_int|0x1f
)paren
suffix:semicolon
id|ack
op_assign
id|ACKX_SEND_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|EVT_MISSING_ACK
suffix:colon
id|ack
op_assign
id|ACKX_TIMEOUT
suffix:semicolon
r_break
suffix:semicolon
r_case
id|EVT_UNDERRUN
suffix:colon
id|ack
op_assign
id|ACKX_SEND_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|EVT_OVERRUN
suffix:colon
multiline_comment|/* that should never happen */
id|PRINT
c_func
(paren
id|KERN_WARNING
comma
l_string|&quot;Received OHCI evt_* error 0x%x&quot;
comma
id|status
op_amp
l_int|0x1f
)paren
suffix:semicolon
id|ack
op_assign
id|ACKX_SEND_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|EVT_DESCRIPTOR_READ
suffix:colon
r_case
id|EVT_DATA_READ
suffix:colon
r_case
id|EVT_DATA_WRITE
suffix:colon
id|ack
op_assign
id|ACKX_SEND_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|EVT_BUS_RESET
suffix:colon
multiline_comment|/* that should never happen */
id|PRINT
c_func
(paren
id|KERN_WARNING
comma
l_string|&quot;Received OHCI evt_* error 0x%x&quot;
comma
id|status
op_amp
l_int|0x1f
)paren
suffix:semicolon
id|ack
op_assign
id|ACKX_SEND_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|EVT_TIMEOUT
suffix:colon
id|ack
op_assign
id|ACKX_TIMEOUT
suffix:semicolon
r_break
suffix:semicolon
r_case
id|EVT_TCODE_ERR
suffix:colon
id|ack
op_assign
id|ACKX_SEND_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|EVT_RESERVED_B
suffix:colon
multiline_comment|/* that should never happen */
r_case
id|EVT_RESERVED_C
suffix:colon
multiline_comment|/* that should never happen */
id|PRINT
c_func
(paren
id|KERN_WARNING
comma
l_string|&quot;Received OHCI evt_* error 0x%x&quot;
comma
id|status
op_amp
l_int|0x1f
)paren
suffix:semicolon
id|ack
op_assign
id|ACKX_SEND_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|EVT_UNKNOWN
suffix:colon
r_case
id|EVT_FLUSHED
suffix:colon
id|ack
op_assign
id|ACKX_SEND_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|PRINT
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;Unhandled OHCI evt_* error 0x%x&quot;
comma
id|status
op_amp
l_int|0x1f
)paren
suffix:semicolon
id|ack
op_assign
id|ACKX_SEND_ERROR
suffix:semicolon
id|BUG
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
id|list_del_init
c_func
(paren
op_amp
id|packet-&gt;driver_list
)paren
suffix:semicolon
id|hpsb_packet_sent
c_func
(paren
id|ohci-&gt;host
comma
id|packet
comma
id|ack
)paren
suffix:semicolon
r_if
c_cond
(paren
id|datasize
)paren
(brace
id|pci_unmap_single
c_func
(paren
id|ohci-&gt;dev
comma
id|cpu_to_le32
c_func
(paren
id|d-&gt;prg_cpu
(braket
id|d-&gt;sent_ind
)braket
op_member_access_from_pointer
id|end.address
)paren
comma
id|datasize
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
id|OHCI_DMA_FREE
c_func
(paren
l_string|&quot;single Xmit data packet&quot;
)paren
suffix:semicolon
)brace
id|d-&gt;sent_ind
op_assign
(paren
id|d-&gt;sent_ind
op_plus
l_int|1
)paren
op_mod
id|d-&gt;num_desc
suffix:semicolon
id|d-&gt;free_prgs
op_increment
suffix:semicolon
)brace
id|dma_trm_flush
c_func
(paren
id|ohci
comma
id|d
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|d-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|stop_dma_rcv_ctx
r_static
r_void
id|stop_dma_rcv_ctx
c_func
(paren
r_struct
id|dma_rcv_ctx
op_star
id|d
)paren
(brace
r_if
c_cond
(paren
id|d-&gt;ctrlClear
)paren
(brace
id|ohci1394_stop_context
c_func
(paren
id|d-&gt;ohci
comma
id|d-&gt;ctrlClear
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;type
op_eq
id|DMA_CTX_ISO
)paren
(brace
multiline_comment|/* disable interrupts */
id|reg_write
c_func
(paren
id|d-&gt;ohci
comma
id|OHCI1394_IsoRecvIntMaskClear
comma
l_int|1
op_lshift
id|d-&gt;ctx
)paren
suffix:semicolon
id|ohci1394_unregister_iso_tasklet
c_func
(paren
id|d-&gt;ohci
comma
op_amp
id|d-&gt;ohci-&gt;ir_legacy_tasklet
)paren
suffix:semicolon
)brace
r_else
(brace
id|tasklet_kill
c_func
(paren
op_amp
id|d-&gt;task
)paren
suffix:semicolon
)brace
)brace
)brace
DECL|function|free_dma_rcv_ctx
r_static
r_void
id|free_dma_rcv_ctx
c_func
(paren
r_struct
id|dma_rcv_ctx
op_star
id|d
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|ti_ohci
op_star
id|ohci
op_assign
id|d-&gt;ohci
suffix:semicolon
r_if
c_cond
(paren
id|ohci
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|DBGMSG
c_func
(paren
l_string|&quot;Freeing dma_rcv_ctx %d&quot;
comma
id|d-&gt;ctx
)paren
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;buf_cpu
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|d-&gt;num_desc
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|d-&gt;buf_cpu
(braket
id|i
)braket
op_logical_and
id|d-&gt;buf_bus
(braket
id|i
)braket
)paren
(brace
id|pci_free_consistent
c_func
(paren
id|ohci-&gt;dev
comma
id|d-&gt;buf_size
comma
id|d-&gt;buf_cpu
(braket
id|i
)braket
comma
id|d-&gt;buf_bus
(braket
id|i
)braket
)paren
suffix:semicolon
id|OHCI_DMA_FREE
c_func
(paren
l_string|&quot;consistent dma_rcv buf[%d]&quot;
comma
id|i
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|d-&gt;buf_cpu
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|d-&gt;buf_bus
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|d-&gt;prg_cpu
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|d-&gt;num_desc
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|d-&gt;prg_cpu
(braket
id|i
)braket
op_logical_and
id|d-&gt;prg_bus
(braket
id|i
)braket
)paren
(brace
id|pci_pool_free
c_func
(paren
id|d-&gt;prg_pool
comma
id|d-&gt;prg_cpu
(braket
id|i
)braket
comma
id|d-&gt;prg_bus
(braket
id|i
)braket
)paren
suffix:semicolon
id|OHCI_DMA_FREE
c_func
(paren
l_string|&quot;consistent dma_rcv prg[%d]&quot;
comma
id|i
)paren
suffix:semicolon
)brace
id|pci_pool_destroy
c_func
(paren
id|d-&gt;prg_pool
)paren
suffix:semicolon
id|OHCI_DMA_FREE
c_func
(paren
l_string|&quot;dma_rcv prg pool&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|d-&gt;prg_cpu
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|d-&gt;prg_bus
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|d-&gt;spb
)paren
id|kfree
c_func
(paren
id|d-&gt;spb
)paren
suffix:semicolon
multiline_comment|/* Mark this context as freed. */
id|d-&gt;ohci
op_assign
l_int|NULL
suffix:semicolon
)brace
r_static
r_int
DECL|function|alloc_dma_rcv_ctx
id|alloc_dma_rcv_ctx
c_func
(paren
r_struct
id|ti_ohci
op_star
id|ohci
comma
r_struct
id|dma_rcv_ctx
op_star
id|d
comma
r_enum
id|context_type
id|type
comma
r_int
id|ctx
comma
r_int
id|num_desc
comma
r_int
id|buf_size
comma
r_int
id|split_buf_size
comma
r_int
id|context_base
)paren
(brace
r_int
id|i
suffix:semicolon
id|d-&gt;ohci
op_assign
id|ohci
suffix:semicolon
id|d-&gt;type
op_assign
id|type
suffix:semicolon
id|d-&gt;ctx
op_assign
id|ctx
suffix:semicolon
id|d-&gt;num_desc
op_assign
id|num_desc
suffix:semicolon
id|d-&gt;buf_size
op_assign
id|buf_size
suffix:semicolon
id|d-&gt;split_buf_size
op_assign
id|split_buf_size
suffix:semicolon
id|d-&gt;ctrlSet
op_assign
l_int|0
suffix:semicolon
id|d-&gt;ctrlClear
op_assign
l_int|0
suffix:semicolon
id|d-&gt;cmdPtr
op_assign
l_int|0
suffix:semicolon
id|d-&gt;buf_cpu
op_assign
id|kmalloc
c_func
(paren
id|d-&gt;num_desc
op_star
r_sizeof
(paren
id|quadlet_t
op_star
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
id|d-&gt;buf_bus
op_assign
id|kmalloc
c_func
(paren
id|d-&gt;num_desc
op_star
r_sizeof
(paren
id|dma_addr_t
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;buf_cpu
op_eq
l_int|NULL
op_logical_or
id|d-&gt;buf_bus
op_eq
l_int|NULL
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;Failed to allocate dma buffer&quot;
)paren
suffix:semicolon
id|free_dma_rcv_ctx
c_func
(paren
id|d
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|d-&gt;buf_cpu
comma
l_int|0
comma
id|d-&gt;num_desc
op_star
r_sizeof
(paren
id|quadlet_t
op_star
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
id|d-&gt;buf_bus
comma
l_int|0
comma
id|d-&gt;num_desc
op_star
r_sizeof
(paren
id|dma_addr_t
)paren
)paren
suffix:semicolon
id|d-&gt;prg_cpu
op_assign
id|kmalloc
c_func
(paren
id|d-&gt;num_desc
op_star
r_sizeof
(paren
r_struct
id|dma_cmd
op_star
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
id|d-&gt;prg_bus
op_assign
id|kmalloc
c_func
(paren
id|d-&gt;num_desc
op_star
r_sizeof
(paren
id|dma_addr_t
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;prg_cpu
op_eq
l_int|NULL
op_logical_or
id|d-&gt;prg_bus
op_eq
l_int|NULL
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;Failed to allocate dma prg&quot;
)paren
suffix:semicolon
id|free_dma_rcv_ctx
c_func
(paren
id|d
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|d-&gt;prg_cpu
comma
l_int|0
comma
id|d-&gt;num_desc
op_star
r_sizeof
(paren
r_struct
id|dma_cmd
op_star
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
id|d-&gt;prg_bus
comma
l_int|0
comma
id|d-&gt;num_desc
op_star
r_sizeof
(paren
id|dma_addr_t
)paren
)paren
suffix:semicolon
id|d-&gt;spb
op_assign
id|kmalloc
c_func
(paren
id|d-&gt;split_buf_size
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;spb
op_eq
l_int|NULL
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;Failed to allocate split buffer&quot;
)paren
suffix:semicolon
id|free_dma_rcv_ctx
c_func
(paren
id|d
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|d-&gt;prg_pool
op_assign
id|pci_pool_create
c_func
(paren
l_string|&quot;ohci1394 rcv prg&quot;
comma
id|ohci-&gt;dev
comma
r_sizeof
(paren
r_struct
id|dma_cmd
)paren
comma
l_int|4
comma
l_int|0
)paren
suffix:semicolon
id|OHCI_DMA_ALLOC
c_func
(paren
l_string|&quot;dma_rcv prg pool&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|d-&gt;num_desc
suffix:semicolon
id|i
op_increment
)paren
(brace
id|d-&gt;buf_cpu
(braket
id|i
)braket
op_assign
id|pci_alloc_consistent
c_func
(paren
id|ohci-&gt;dev
comma
id|d-&gt;buf_size
comma
id|d-&gt;buf_bus
op_plus
id|i
)paren
suffix:semicolon
id|OHCI_DMA_ALLOC
c_func
(paren
l_string|&quot;consistent dma_rcv buf[%d]&quot;
comma
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;buf_cpu
(braket
id|i
)braket
op_ne
l_int|NULL
)paren
(brace
id|memset
c_func
(paren
id|d-&gt;buf_cpu
(braket
id|i
)braket
comma
l_int|0
comma
id|d-&gt;buf_size
)paren
suffix:semicolon
)brace
r_else
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;Failed to allocate dma buffer&quot;
)paren
suffix:semicolon
id|free_dma_rcv_ctx
c_func
(paren
id|d
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|d-&gt;prg_cpu
(braket
id|i
)braket
op_assign
id|pci_pool_alloc
c_func
(paren
id|d-&gt;prg_pool
comma
id|SLAB_KERNEL
comma
id|d-&gt;prg_bus
op_plus
id|i
)paren
suffix:semicolon
id|OHCI_DMA_ALLOC
c_func
(paren
l_string|&quot;pool dma_rcv prg[%d]&quot;
comma
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;prg_cpu
(braket
id|i
)braket
op_ne
l_int|NULL
)paren
(brace
id|memset
c_func
(paren
id|d-&gt;prg_cpu
(braket
id|i
)braket
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|dma_cmd
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;Failed to allocate dma prg&quot;
)paren
suffix:semicolon
id|free_dma_rcv_ctx
c_func
(paren
id|d
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
)brace
id|spin_lock_init
c_func
(paren
op_amp
id|d-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|type
op_eq
id|DMA_CTX_ISO
)paren
(brace
id|ohci1394_init_iso_tasklet
c_func
(paren
op_amp
id|ohci-&gt;ir_legacy_tasklet
comma
id|OHCI_ISO_MULTICHANNEL_RECEIVE
comma
id|dma_rcv_tasklet
comma
(paren
r_int
r_int
)paren
id|d
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ohci1394_register_iso_tasklet
c_func
(paren
id|ohci
comma
op_amp
id|ohci-&gt;ir_legacy_tasklet
)paren
OL
l_int|0
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;No IR DMA context available&quot;
)paren
suffix:semicolon
id|free_dma_rcv_ctx
c_func
(paren
id|d
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
multiline_comment|/* the IR context can be assigned to any DMA context&n;&t;&t; * by ohci1394_register_iso_tasklet */
id|d-&gt;ctx
op_assign
id|ohci-&gt;ir_legacy_tasklet.context
suffix:semicolon
id|d-&gt;ctrlSet
op_assign
id|OHCI1394_IsoRcvContextControlSet
op_plus
l_int|32
op_star
id|d-&gt;ctx
suffix:semicolon
id|d-&gt;ctrlClear
op_assign
id|OHCI1394_IsoRcvContextControlClear
op_plus
l_int|32
op_star
id|d-&gt;ctx
suffix:semicolon
id|d-&gt;cmdPtr
op_assign
id|OHCI1394_IsoRcvCommandPtr
op_plus
l_int|32
op_star
id|d-&gt;ctx
suffix:semicolon
id|d-&gt;ctxtMatch
op_assign
id|OHCI1394_IsoRcvContextMatch
op_plus
l_int|32
op_star
id|d-&gt;ctx
suffix:semicolon
)brace
r_else
(brace
id|d-&gt;ctrlSet
op_assign
id|context_base
op_plus
id|OHCI1394_ContextControlSet
suffix:semicolon
id|d-&gt;ctrlClear
op_assign
id|context_base
op_plus
id|OHCI1394_ContextControlClear
suffix:semicolon
id|d-&gt;cmdPtr
op_assign
id|context_base
op_plus
id|OHCI1394_ContextCommandPtr
suffix:semicolon
id|tasklet_init
(paren
op_amp
id|d-&gt;task
comma
id|dma_rcv_tasklet
comma
(paren
r_int
r_int
)paren
id|d
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|free_dma_trm_ctx
r_static
r_void
id|free_dma_trm_ctx
c_func
(paren
r_struct
id|dma_trm_ctx
op_star
id|d
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|ti_ohci
op_star
id|ohci
op_assign
id|d-&gt;ohci
suffix:semicolon
r_if
c_cond
(paren
id|ohci
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|DBGMSG
c_func
(paren
l_string|&quot;Freeing dma_trm_ctx %d&quot;
comma
id|d-&gt;ctx
)paren
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;prg_cpu
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|d-&gt;num_desc
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|d-&gt;prg_cpu
(braket
id|i
)braket
op_logical_and
id|d-&gt;prg_bus
(braket
id|i
)braket
)paren
(brace
id|pci_pool_free
c_func
(paren
id|d-&gt;prg_pool
comma
id|d-&gt;prg_cpu
(braket
id|i
)braket
comma
id|d-&gt;prg_bus
(braket
id|i
)braket
)paren
suffix:semicolon
id|OHCI_DMA_FREE
c_func
(paren
l_string|&quot;pool dma_trm prg[%d]&quot;
comma
id|i
)paren
suffix:semicolon
)brace
id|pci_pool_destroy
c_func
(paren
id|d-&gt;prg_pool
)paren
suffix:semicolon
id|OHCI_DMA_FREE
c_func
(paren
l_string|&quot;dma_trm prg pool&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|d-&gt;prg_cpu
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|d-&gt;prg_bus
)paren
suffix:semicolon
)brace
multiline_comment|/* Mark this context as freed. */
id|d-&gt;ohci
op_assign
l_int|NULL
suffix:semicolon
)brace
r_static
r_int
DECL|function|alloc_dma_trm_ctx
id|alloc_dma_trm_ctx
c_func
(paren
r_struct
id|ti_ohci
op_star
id|ohci
comma
r_struct
id|dma_trm_ctx
op_star
id|d
comma
r_enum
id|context_type
id|type
comma
r_int
id|ctx
comma
r_int
id|num_desc
comma
r_int
id|context_base
)paren
(brace
r_int
id|i
suffix:semicolon
id|d-&gt;ohci
op_assign
id|ohci
suffix:semicolon
id|d-&gt;type
op_assign
id|type
suffix:semicolon
id|d-&gt;ctx
op_assign
id|ctx
suffix:semicolon
id|d-&gt;num_desc
op_assign
id|num_desc
suffix:semicolon
id|d-&gt;ctrlSet
op_assign
l_int|0
suffix:semicolon
id|d-&gt;ctrlClear
op_assign
l_int|0
suffix:semicolon
id|d-&gt;cmdPtr
op_assign
l_int|0
suffix:semicolon
id|d-&gt;prg_cpu
op_assign
id|kmalloc
c_func
(paren
id|d-&gt;num_desc
op_star
r_sizeof
(paren
r_struct
id|at_dma_prg
op_star
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|d-&gt;prg_bus
op_assign
id|kmalloc
c_func
(paren
id|d-&gt;num_desc
op_star
r_sizeof
(paren
id|dma_addr_t
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;prg_cpu
op_eq
l_int|NULL
op_logical_or
id|d-&gt;prg_bus
op_eq
l_int|NULL
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;Failed to allocate at dma prg&quot;
)paren
suffix:semicolon
id|free_dma_trm_ctx
c_func
(paren
id|d
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|d-&gt;prg_cpu
comma
l_int|0
comma
id|d-&gt;num_desc
op_star
r_sizeof
(paren
r_struct
id|at_dma_prg
op_star
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
id|d-&gt;prg_bus
comma
l_int|0
comma
id|d-&gt;num_desc
op_star
r_sizeof
(paren
id|dma_addr_t
)paren
)paren
suffix:semicolon
id|d-&gt;prg_pool
op_assign
id|pci_pool_create
c_func
(paren
l_string|&quot;ohci1394 trm prg&quot;
comma
id|ohci-&gt;dev
comma
r_sizeof
(paren
r_struct
id|at_dma_prg
)paren
comma
l_int|4
comma
l_int|0
)paren
suffix:semicolon
id|OHCI_DMA_ALLOC
c_func
(paren
l_string|&quot;dma_rcv prg pool&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|d-&gt;num_desc
suffix:semicolon
id|i
op_increment
)paren
(brace
id|d-&gt;prg_cpu
(braket
id|i
)braket
op_assign
id|pci_pool_alloc
c_func
(paren
id|d-&gt;prg_pool
comma
id|SLAB_KERNEL
comma
id|d-&gt;prg_bus
op_plus
id|i
)paren
suffix:semicolon
id|OHCI_DMA_ALLOC
c_func
(paren
l_string|&quot;pool dma_trm prg[%d]&quot;
comma
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;prg_cpu
(braket
id|i
)braket
op_ne
l_int|NULL
)paren
(brace
id|memset
c_func
(paren
id|d-&gt;prg_cpu
(braket
id|i
)braket
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|at_dma_prg
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;Failed to allocate at dma prg&quot;
)paren
suffix:semicolon
id|free_dma_trm_ctx
c_func
(paren
id|d
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
)brace
id|spin_lock_init
c_func
(paren
op_amp
id|d-&gt;lock
)paren
suffix:semicolon
multiline_comment|/* initialize tasklet */
r_if
c_cond
(paren
id|type
op_eq
id|DMA_CTX_ISO
)paren
(brace
id|ohci1394_init_iso_tasklet
c_func
(paren
op_amp
id|ohci-&gt;it_legacy_tasklet
comma
id|OHCI_ISO_TRANSMIT
comma
id|dma_trm_tasklet
comma
(paren
r_int
r_int
)paren
id|d
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ohci1394_register_iso_tasklet
c_func
(paren
id|ohci
comma
op_amp
id|ohci-&gt;it_legacy_tasklet
)paren
OL
l_int|0
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;No IT DMA context available&quot;
)paren
suffix:semicolon
id|free_dma_trm_ctx
c_func
(paren
id|d
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
multiline_comment|/* IT can be assigned to any context by register_iso_tasklet */
id|d-&gt;ctx
op_assign
id|ohci-&gt;it_legacy_tasklet.context
suffix:semicolon
id|d-&gt;ctrlSet
op_assign
id|OHCI1394_IsoXmitContextControlSet
op_plus
l_int|16
op_star
id|d-&gt;ctx
suffix:semicolon
id|d-&gt;ctrlClear
op_assign
id|OHCI1394_IsoXmitContextControlClear
op_plus
l_int|16
op_star
id|d-&gt;ctx
suffix:semicolon
id|d-&gt;cmdPtr
op_assign
id|OHCI1394_IsoXmitCommandPtr
op_plus
l_int|16
op_star
id|d-&gt;ctx
suffix:semicolon
)brace
r_else
(brace
id|d-&gt;ctrlSet
op_assign
id|context_base
op_plus
id|OHCI1394_ContextControlSet
suffix:semicolon
id|d-&gt;ctrlClear
op_assign
id|context_base
op_plus
id|OHCI1394_ContextControlClear
suffix:semicolon
id|d-&gt;cmdPtr
op_assign
id|context_base
op_plus
id|OHCI1394_ContextCommandPtr
suffix:semicolon
id|tasklet_init
(paren
op_amp
id|d-&gt;task
comma
id|dma_trm_tasklet
comma
(paren
r_int
r_int
)paren
id|d
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ohci_set_hw_config_rom
r_static
r_void
id|ohci_set_hw_config_rom
c_func
(paren
r_struct
id|hpsb_host
op_star
id|host
comma
id|quadlet_t
op_star
id|config_rom
)paren
(brace
r_struct
id|ti_ohci
op_star
id|ohci
op_assign
id|host-&gt;hostdata
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_ConfigROMhdr
comma
id|be32_to_cpu
c_func
(paren
id|config_rom
(braket
l_int|0
)braket
)paren
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_BusOptions
comma
id|be32_to_cpu
c_func
(paren
id|config_rom
(braket
l_int|2
)braket
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|ohci-&gt;csr_config_rom_cpu
comma
id|config_rom
comma
id|OHCI_CONFIG_ROM_LEN
)paren
suffix:semicolon
)brace
DECL|function|ohci_hw_csr_reg
r_static
id|quadlet_t
id|ohci_hw_csr_reg
c_func
(paren
r_struct
id|hpsb_host
op_star
id|host
comma
r_int
id|reg
comma
id|quadlet_t
id|data
comma
id|quadlet_t
id|compare
)paren
(brace
r_struct
id|ti_ohci
op_star
id|ohci
op_assign
id|host-&gt;hostdata
suffix:semicolon
r_int
id|i
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_CSRData
comma
id|data
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_CSRCompareData
comma
id|compare
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_CSRControl
comma
id|reg
op_amp
l_int|0x3
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|OHCI_LOOP_COUNT
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_CSRControl
)paren
op_amp
l_int|0x80000000
)paren
r_break
suffix:semicolon
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_return
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_CSRData
)paren
suffix:semicolon
)brace
DECL|variable|ohci1394_driver
r_static
r_struct
id|hpsb_host_driver
id|ohci1394_driver
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|name
op_assign
id|OHCI1394_DRIVER_NAME
comma
dot
id|set_hw_config_rom
op_assign
id|ohci_set_hw_config_rom
comma
dot
id|transmit_packet
op_assign
id|ohci_transmit
comma
dot
id|devctl
op_assign
id|ohci_devctl
comma
dot
id|isoctl
op_assign
id|ohci_isoctl
comma
dot
id|hw_csr_reg
op_assign
id|ohci_hw_csr_reg
comma
)brace
suffix:semicolon
"&f;"
multiline_comment|/***********************************&n; * PCI Driver Interface functions  *&n; ***********************************/
DECL|macro|FAIL
mdefine_line|#define FAIL(err, fmt, args...)&t;&t;&t;&bslash;&n;do {&t;&t;&t;&t;&t;&t;&bslash;&n;&t;PRINT_G(KERN_ERR, fmt , ## args);&t;&bslash;&n;        ohci1394_pci_remove(dev);               &bslash;&n;&t;return err;&t;&t;&t;&t;&bslash;&n;} while (0)
DECL|function|ohci1394_pci_probe
r_static
r_int
id|__devinit
id|ohci1394_pci_probe
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_const
r_struct
id|pci_device_id
op_star
id|ent
)paren
(brace
r_static
r_int
id|version_printed
op_assign
l_int|0
suffix:semicolon
r_struct
id|hpsb_host
op_star
id|host
suffix:semicolon
r_struct
id|ti_ohci
op_star
id|ohci
suffix:semicolon
multiline_comment|/* shortcut to currently handled device */
r_int
r_int
id|ohci_base
suffix:semicolon
r_if
c_cond
(paren
id|version_printed
op_increment
op_eq
l_int|0
)paren
id|PRINT_G
c_func
(paren
id|KERN_INFO
comma
l_string|&quot;%s&quot;
comma
id|version
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_enable_device
c_func
(paren
id|dev
)paren
)paren
id|FAIL
c_func
(paren
op_minus
id|ENXIO
comma
l_string|&quot;Failed to enable OHCI hardware&quot;
)paren
suffix:semicolon
id|pci_set_master
c_func
(paren
id|dev
)paren
suffix:semicolon
id|host
op_assign
id|hpsb_alloc_host
c_func
(paren
op_amp
id|ohci1394_driver
comma
r_sizeof
(paren
r_struct
id|ti_ohci
)paren
comma
op_amp
id|dev-&gt;dev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|host
)paren
id|FAIL
c_func
(paren
op_minus
id|ENOMEM
comma
l_string|&quot;Failed to allocate host structure&quot;
)paren
suffix:semicolon
id|ohci
op_assign
id|host-&gt;hostdata
suffix:semicolon
id|ohci-&gt;dev
op_assign
id|dev
suffix:semicolon
id|ohci-&gt;host
op_assign
id|host
suffix:semicolon
id|ohci-&gt;init_state
op_assign
id|OHCI_INIT_ALLOC_HOST
suffix:semicolon
id|host-&gt;pdev
op_assign
id|dev
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|dev
comma
id|ohci
)paren
suffix:semicolon
multiline_comment|/* We don&squot;t want hardware swapping */
id|pci_write_config_dword
c_func
(paren
id|dev
comma
id|OHCI1394_PCI_HCI_Control
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Some oddball Apple controllers do not order the selfid&n;&t; * properly, so we make up for it here.  */
macro_line|#ifndef __LITTLE_ENDIAN
multiline_comment|/* XXX: Need a better way to check this. I&squot;m wondering if we can&n;&t; * read the values of the OHCI1394_PCI_HCI_Control and the&n;&t; * noByteSwapData registers to see if they were not cleared to&n;&t; * zero. Should this work? Obviously it&squot;s not defined what these&n;&t; * registers will read when they aren&squot;t supported. Bleh! */
r_if
c_cond
(paren
id|dev-&gt;vendor
op_eq
id|PCI_VENDOR_ID_APPLE
op_logical_and
id|dev-&gt;device
op_eq
id|PCI_DEVICE_ID_APPLE_UNI_N_FW
)paren
(brace
id|ohci-&gt;no_swap_incoming
op_assign
l_int|1
suffix:semicolon
id|ohci-&gt;selfid_swap
op_assign
l_int|0
suffix:semicolon
)brace
r_else
id|ohci-&gt;selfid_swap
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
macro_line|#ifndef PCI_DEVICE_ID_NVIDIA_NFORCE2_FW
DECL|macro|PCI_DEVICE_ID_NVIDIA_NFORCE2_FW
mdefine_line|#define PCI_DEVICE_ID_NVIDIA_NFORCE2_FW 0x006e
macro_line|#endif
multiline_comment|/* These chipsets require a bit of extra care when checking after&n;&t; * a busreset.  */
r_if
c_cond
(paren
(paren
id|dev-&gt;vendor
op_eq
id|PCI_VENDOR_ID_APPLE
op_logical_and
id|dev-&gt;device
op_eq
id|PCI_DEVICE_ID_APPLE_UNI_N_FW
)paren
op_logical_or
(paren
id|dev-&gt;vendor
op_eq
id|PCI_VENDOR_ID_NVIDIA
op_logical_and
id|dev-&gt;device
op_eq
id|PCI_DEVICE_ID_NVIDIA_NFORCE2_FW
)paren
)paren
id|ohci-&gt;check_busreset
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* We hardwire the MMIO length, since some CardBus adaptors&n;&t; * fail to report the right length.  Anyway, the ohci spec&n;&t; * clearly says it&squot;s 2kb, so this shouldn&squot;t be a problem. */
id|ohci_base
op_assign
id|pci_resource_start
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_resource_len
c_func
(paren
id|dev
comma
l_int|0
)paren
op_ne
id|OHCI1394_REGISTER_SIZE
)paren
id|PRINT
c_func
(paren
id|KERN_WARNING
comma
l_string|&quot;Unexpected PCI resource length of %lx!&quot;
comma
id|pci_resource_len
c_func
(paren
id|dev
comma
l_int|0
)paren
)paren
suffix:semicolon
multiline_comment|/* Seems PCMCIA handles this internally. Not sure why. Seems&n;&t; * pretty bogus to force a driver to special case this.  */
macro_line|#ifndef PCMCIA
r_if
c_cond
(paren
op_logical_neg
id|request_mem_region
(paren
id|ohci_base
comma
id|OHCI1394_REGISTER_SIZE
comma
id|OHCI1394_DRIVER_NAME
)paren
)paren
id|FAIL
c_func
(paren
op_minus
id|ENOMEM
comma
l_string|&quot;MMIO resource (0x%lx - 0x%lx) unavailable&quot;
comma
id|ohci_base
comma
id|ohci_base
op_plus
id|OHCI1394_REGISTER_SIZE
)paren
suffix:semicolon
macro_line|#endif
id|ohci-&gt;init_state
op_assign
id|OHCI_INIT_HAVE_MEM_REGION
suffix:semicolon
id|ohci-&gt;registers
op_assign
id|ioremap
c_func
(paren
id|ohci_base
comma
id|OHCI1394_REGISTER_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ohci-&gt;registers
op_eq
l_int|NULL
)paren
id|FAIL
c_func
(paren
op_minus
id|ENXIO
comma
l_string|&quot;Failed to remap registers - card not accessible&quot;
)paren
suffix:semicolon
id|ohci-&gt;init_state
op_assign
id|OHCI_INIT_HAVE_IOMAPPING
suffix:semicolon
id|DBGMSG
c_func
(paren
l_string|&quot;Remapped memory spaces reg 0x%p&quot;
comma
id|ohci-&gt;registers
)paren
suffix:semicolon
multiline_comment|/* csr_config rom allocation */
id|ohci-&gt;csr_config_rom_cpu
op_assign
id|pci_alloc_consistent
c_func
(paren
id|ohci-&gt;dev
comma
id|OHCI_CONFIG_ROM_LEN
comma
op_amp
id|ohci-&gt;csr_config_rom_bus
)paren
suffix:semicolon
id|OHCI_DMA_ALLOC
c_func
(paren
l_string|&quot;consistent csr_config_rom&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ohci-&gt;csr_config_rom_cpu
op_eq
l_int|NULL
)paren
id|FAIL
c_func
(paren
op_minus
id|ENOMEM
comma
l_string|&quot;Failed to allocate buffer config rom&quot;
)paren
suffix:semicolon
id|ohci-&gt;init_state
op_assign
id|OHCI_INIT_HAVE_CONFIG_ROM_BUFFER
suffix:semicolon
multiline_comment|/* self-id dma buffer allocation */
id|ohci-&gt;selfid_buf_cpu
op_assign
id|pci_alloc_consistent
c_func
(paren
id|ohci-&gt;dev
comma
id|OHCI1394_SI_DMA_BUF_SIZE
comma
op_amp
id|ohci-&gt;selfid_buf_bus
)paren
suffix:semicolon
id|OHCI_DMA_ALLOC
c_func
(paren
l_string|&quot;consistent selfid_buf&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ohci-&gt;selfid_buf_cpu
op_eq
l_int|NULL
)paren
id|FAIL
c_func
(paren
op_minus
id|ENOMEM
comma
l_string|&quot;Failed to allocate DMA buffer for self-id packets&quot;
)paren
suffix:semicolon
id|ohci-&gt;init_state
op_assign
id|OHCI_INIT_HAVE_SELFID_BUFFER
suffix:semicolon
r_if
c_cond
(paren
(paren
r_int
r_int
)paren
id|ohci-&gt;selfid_buf_cpu
op_amp
l_int|0x1fff
)paren
id|PRINT
c_func
(paren
id|KERN_INFO
comma
l_string|&quot;SelfID buffer %p is not aligned on &quot;
l_string|&quot;8Kb boundary... may cause problems on some CXD3222 chip&quot;
comma
id|ohci-&gt;selfid_buf_cpu
)paren
suffix:semicolon
multiline_comment|/* No self-id errors at startup */
id|ohci-&gt;self_id_errors
op_assign
l_int|0
suffix:semicolon
id|ohci-&gt;init_state
op_assign
id|OHCI_INIT_HAVE_TXRX_BUFFERS__MAYBE
suffix:semicolon
multiline_comment|/* AR DMA request context allocation */
r_if
c_cond
(paren
id|alloc_dma_rcv_ctx
c_func
(paren
id|ohci
comma
op_amp
id|ohci-&gt;ar_req_context
comma
id|DMA_CTX_ASYNC_REQ
comma
l_int|0
comma
id|AR_REQ_NUM_DESC
comma
id|AR_REQ_BUF_SIZE
comma
id|AR_REQ_SPLIT_BUF_SIZE
comma
id|OHCI1394_AsReqRcvContextBase
)paren
OL
l_int|0
)paren
id|FAIL
c_func
(paren
op_minus
id|ENOMEM
comma
l_string|&quot;Failed to allocate AR Req context&quot;
)paren
suffix:semicolon
multiline_comment|/* AR DMA response context allocation */
r_if
c_cond
(paren
id|alloc_dma_rcv_ctx
c_func
(paren
id|ohci
comma
op_amp
id|ohci-&gt;ar_resp_context
comma
id|DMA_CTX_ASYNC_RESP
comma
l_int|0
comma
id|AR_RESP_NUM_DESC
comma
id|AR_RESP_BUF_SIZE
comma
id|AR_RESP_SPLIT_BUF_SIZE
comma
id|OHCI1394_AsRspRcvContextBase
)paren
OL
l_int|0
)paren
id|FAIL
c_func
(paren
op_minus
id|ENOMEM
comma
l_string|&quot;Failed to allocate AR Resp context&quot;
)paren
suffix:semicolon
multiline_comment|/* AT DMA request context */
r_if
c_cond
(paren
id|alloc_dma_trm_ctx
c_func
(paren
id|ohci
comma
op_amp
id|ohci-&gt;at_req_context
comma
id|DMA_CTX_ASYNC_REQ
comma
l_int|0
comma
id|AT_REQ_NUM_DESC
comma
id|OHCI1394_AsReqTrContextBase
)paren
OL
l_int|0
)paren
id|FAIL
c_func
(paren
op_minus
id|ENOMEM
comma
l_string|&quot;Failed to allocate AT Req context&quot;
)paren
suffix:semicolon
multiline_comment|/* AT DMA response context */
r_if
c_cond
(paren
id|alloc_dma_trm_ctx
c_func
(paren
id|ohci
comma
op_amp
id|ohci-&gt;at_resp_context
comma
id|DMA_CTX_ASYNC_RESP
comma
l_int|1
comma
id|AT_RESP_NUM_DESC
comma
id|OHCI1394_AsRspTrContextBase
)paren
OL
l_int|0
)paren
id|FAIL
c_func
(paren
op_minus
id|ENOMEM
comma
l_string|&quot;Failed to allocate AT Resp context&quot;
)paren
suffix:semicolon
multiline_comment|/* Start off with a soft reset, to clear everything to a sane&n;&t; * state. */
id|ohci_soft_reset
c_func
(paren
id|ohci
)paren
suffix:semicolon
multiline_comment|/* Now enable LPS, which we need in order to start accessing&n;&t; * most of the registers.  In fact, on some cards (ALI M5251),&n;&t; * accessing registers in the SClk domain without LPS enabled&n;&t; * will lock up the machine.  Wait 50msec to make sure we have&n;&t; * full link enabled.  */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_HCControlSet
comma
id|OHCI1394_HCControl_LPS
)paren
suffix:semicolon
multiline_comment|/* Disable and clear interrupts */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IntEventClear
comma
l_int|0xffffffff
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IntMaskClear
comma
l_int|0xffffffff
)paren
suffix:semicolon
id|mdelay
c_func
(paren
l_int|50
)paren
suffix:semicolon
multiline_comment|/* Determine the number of available IR and IT contexts. */
id|ohci-&gt;nb_iso_rcv_ctx
op_assign
id|get_nb_iso_ctx
c_func
(paren
id|ohci
comma
id|OHCI1394_IsoRecvIntMaskSet
)paren
suffix:semicolon
id|DBGMSG
c_func
(paren
l_string|&quot;%d iso receive contexts available&quot;
comma
id|ohci-&gt;nb_iso_rcv_ctx
)paren
suffix:semicolon
id|ohci-&gt;nb_iso_xmit_ctx
op_assign
id|get_nb_iso_ctx
c_func
(paren
id|ohci
comma
id|OHCI1394_IsoXmitIntMaskSet
)paren
suffix:semicolon
id|DBGMSG
c_func
(paren
l_string|&quot;%d iso transmit contexts available&quot;
comma
id|ohci-&gt;nb_iso_xmit_ctx
)paren
suffix:semicolon
multiline_comment|/* Set the usage bits for non-existent contexts so they can&squot;t&n;&t; * be allocated */
id|ohci-&gt;ir_ctx_usage
op_assign
op_complement
l_int|0
op_lshift
id|ohci-&gt;nb_iso_rcv_ctx
suffix:semicolon
id|ohci-&gt;it_ctx_usage
op_assign
op_complement
l_int|0
op_lshift
id|ohci-&gt;nb_iso_xmit_ctx
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|ohci-&gt;iso_tasklet_list
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|ohci-&gt;iso_tasklet_list_lock
)paren
suffix:semicolon
id|ohci-&gt;ISO_channel_usage
op_assign
l_int|0
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|ohci-&gt;IR_channel_lock
)paren
suffix:semicolon
multiline_comment|/* the IR DMA context is allocated on-demand; mark it inactive */
id|ohci-&gt;ir_legacy_context.ohci
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* same for the IT DMA context */
id|ohci-&gt;it_legacy_context.ohci
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
id|ohci_irq_handler
comma
id|SA_SHIRQ
comma
id|OHCI1394_DRIVER_NAME
comma
id|ohci
)paren
)paren
id|FAIL
c_func
(paren
op_minus
id|ENOMEM
comma
l_string|&quot;Failed to allocate shared interrupt %d&quot;
comma
id|dev-&gt;irq
)paren
suffix:semicolon
id|ohci-&gt;init_state
op_assign
id|OHCI_INIT_HAVE_IRQ
suffix:semicolon
id|ohci_initialize
c_func
(paren
id|ohci
)paren
suffix:semicolon
multiline_comment|/* Set certain csr values */
id|host-&gt;csr.guid_hi
op_assign
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_GUIDHi
)paren
suffix:semicolon
id|host-&gt;csr.guid_lo
op_assign
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_GUIDLo
)paren
suffix:semicolon
id|host-&gt;csr.cyc_clk_acc
op_assign
l_int|100
suffix:semicolon
multiline_comment|/* how do we determine clk accuracy? */
id|host-&gt;csr.max_rec
op_assign
(paren
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_BusOptions
)paren
op_rshift
l_int|12
)paren
op_amp
l_int|0xf
suffix:semicolon
id|host-&gt;csr.lnk_spd
op_assign
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_BusOptions
)paren
op_amp
l_int|0x7
suffix:semicolon
multiline_comment|/* Tell the highlevel this host is ready */
r_if
c_cond
(paren
id|hpsb_add_host
c_func
(paren
id|host
)paren
)paren
id|FAIL
c_func
(paren
op_minus
id|ENOMEM
comma
l_string|&quot;Failed to register host with highlevel&quot;
)paren
suffix:semicolon
id|ohci-&gt;init_state
op_assign
id|OHCI_INIT_DONE
suffix:semicolon
r_return
l_int|0
suffix:semicolon
DECL|macro|FAIL
macro_line|#undef FAIL
)brace
DECL|function|ohci1394_pci_remove
r_static
r_void
id|ohci1394_pci_remove
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
r_struct
id|ti_ohci
op_star
id|ohci
suffix:semicolon
r_struct
id|device
op_star
id|dev
suffix:semicolon
id|ohci
op_assign
id|pci_get_drvdata
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ohci
)paren
r_return
suffix:semicolon
id|dev
op_assign
id|get_device
c_func
(paren
op_amp
id|ohci-&gt;host-&gt;device
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|ohci-&gt;init_state
)paren
(brace
r_case
id|OHCI_INIT_DONE
suffix:colon
id|hpsb_remove_host
c_func
(paren
id|ohci-&gt;host
)paren
suffix:semicolon
multiline_comment|/* Clear out BUS Options */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_ConfigROMhdr
comma
l_int|0
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_BusOptions
comma
(paren
id|reg_read
c_func
(paren
id|ohci
comma
id|OHCI1394_BusOptions
)paren
op_amp
l_int|0x0000f007
)paren
op_or
l_int|0x00ff0000
)paren
suffix:semicolon
id|memset
c_func
(paren
id|ohci-&gt;csr_config_rom_cpu
comma
l_int|0
comma
id|OHCI_CONFIG_ROM_LEN
)paren
suffix:semicolon
r_case
id|OHCI_INIT_HAVE_IRQ
suffix:colon
multiline_comment|/* Clear interrupt registers */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IntMaskClear
comma
l_int|0xffffffff
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IntEventClear
comma
l_int|0xffffffff
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IsoXmitIntMaskClear
comma
l_int|0xffffffff
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IsoXmitIntEventClear
comma
l_int|0xffffffff
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IsoRecvIntMaskClear
comma
l_int|0xffffffff
)paren
suffix:semicolon
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_IsoRecvIntEventClear
comma
l_int|0xffffffff
)paren
suffix:semicolon
multiline_comment|/* Disable IRM Contender */
id|set_phy_reg
c_func
(paren
id|ohci
comma
l_int|4
comma
op_complement
l_int|0xc0
op_amp
id|get_phy_reg
c_func
(paren
id|ohci
comma
l_int|4
)paren
)paren
suffix:semicolon
multiline_comment|/* Clear link control register */
id|reg_write
c_func
(paren
id|ohci
comma
id|OHCI1394_LinkControlClear
comma
l_int|0xffffffff
)paren
suffix:semicolon
multiline_comment|/* Let all other nodes know to ignore us */
id|ohci_devctl
c_func
(paren
id|ohci-&gt;host
comma
id|RESET_BUS
comma
id|LONG_RESET_NO_FORCE_ROOT
)paren
suffix:semicolon
multiline_comment|/* Soft reset before we start - this disables&n;&t;&t; * interrupts and clears linkEnable and LPS. */
id|ohci_soft_reset
c_func
(paren
id|ohci
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|ohci-&gt;dev-&gt;irq
comma
id|ohci
)paren
suffix:semicolon
r_case
id|OHCI_INIT_HAVE_TXRX_BUFFERS__MAYBE
suffix:colon
multiline_comment|/* The ohci_soft_reset() stops all DMA contexts, so we&n;&t;&t; * dont need to do this.  */
multiline_comment|/* Free AR dma */
id|free_dma_rcv_ctx
c_func
(paren
op_amp
id|ohci-&gt;ar_req_context
)paren
suffix:semicolon
id|free_dma_rcv_ctx
c_func
(paren
op_amp
id|ohci-&gt;ar_resp_context
)paren
suffix:semicolon
multiline_comment|/* Free AT dma */
id|free_dma_trm_ctx
c_func
(paren
op_amp
id|ohci-&gt;at_req_context
)paren
suffix:semicolon
id|free_dma_trm_ctx
c_func
(paren
op_amp
id|ohci-&gt;at_resp_context
)paren
suffix:semicolon
multiline_comment|/* Free IR dma */
id|free_dma_rcv_ctx
c_func
(paren
op_amp
id|ohci-&gt;ir_legacy_context
)paren
suffix:semicolon
multiline_comment|/* Free IT dma */
id|free_dma_trm_ctx
c_func
(paren
op_amp
id|ohci-&gt;it_legacy_context
)paren
suffix:semicolon
r_case
id|OHCI_INIT_HAVE_SELFID_BUFFER
suffix:colon
id|pci_free_consistent
c_func
(paren
id|ohci-&gt;dev
comma
id|OHCI1394_SI_DMA_BUF_SIZE
comma
id|ohci-&gt;selfid_buf_cpu
comma
id|ohci-&gt;selfid_buf_bus
)paren
suffix:semicolon
id|OHCI_DMA_FREE
c_func
(paren
l_string|&quot;consistent selfid_buf&quot;
)paren
suffix:semicolon
r_case
id|OHCI_INIT_HAVE_CONFIG_ROM_BUFFER
suffix:colon
id|pci_free_consistent
c_func
(paren
id|ohci-&gt;dev
comma
id|OHCI_CONFIG_ROM_LEN
comma
id|ohci-&gt;csr_config_rom_cpu
comma
id|ohci-&gt;csr_config_rom_bus
)paren
suffix:semicolon
id|OHCI_DMA_FREE
c_func
(paren
l_string|&quot;consistent csr_config_rom&quot;
)paren
suffix:semicolon
r_case
id|OHCI_INIT_HAVE_IOMAPPING
suffix:colon
id|iounmap
c_func
(paren
id|ohci-&gt;registers
)paren
suffix:semicolon
r_case
id|OHCI_INIT_HAVE_MEM_REGION
suffix:colon
macro_line|#ifndef PCMCIA
id|release_mem_region
c_func
(paren
id|pci_resource_start
c_func
(paren
id|ohci-&gt;dev
comma
l_int|0
)paren
comma
id|OHCI1394_REGISTER_SIZE
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_PPC_PMAC
multiline_comment|/* On UniNorth, power down the cable and turn off the chip&n;&t; * clock when the module is removed to save power on&n;&t; * laptops. Turning it back ON is done by the arch code when&n;&t; * pci_enable_device() is called */
(brace
r_struct
id|device_node
op_star
id|of_node
suffix:semicolon
id|of_node
op_assign
id|pci_device_to_OF_node
c_func
(paren
id|ohci-&gt;dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|of_node
)paren
(brace
id|pmac_call_feature
c_func
(paren
id|PMAC_FTR_1394_ENABLE
comma
id|of_node
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|pmac_call_feature
c_func
(paren
id|PMAC_FTR_1394_CABLE_POWER
comma
id|of_node
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif /* CONFIG_PPC_PMAC */
r_case
id|OHCI_INIT_ALLOC_HOST
suffix:colon
id|pci_set_drvdata
c_func
(paren
id|ohci-&gt;dev
comma
l_int|NULL
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev
)paren
id|put_device
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
DECL|function|ohci1394_pci_resume
r_static
r_int
id|ohci1394_pci_resume
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
macro_line|#ifdef CONFIG_PMAC_PBOOK
(brace
r_struct
id|device_node
op_star
id|of_node
suffix:semicolon
multiline_comment|/* Re-enable 1394 */
id|of_node
op_assign
id|pci_device_to_OF_node
(paren
id|pdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|of_node
)paren
id|pmac_call_feature
(paren
id|PMAC_FTR_1394_ENABLE
comma
id|of_node
comma
l_int|0
comma
l_int|1
)paren
suffix:semicolon
)brace
macro_line|#endif
id|pci_enable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ohci1394_pci_suspend
r_static
r_int
id|ohci1394_pci_suspend
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
id|u32
id|state
)paren
(brace
macro_line|#ifdef CONFIG_PMAC_PBOOK
(brace
r_struct
id|device_node
op_star
id|of_node
suffix:semicolon
multiline_comment|/* Disable 1394 */
id|of_node
op_assign
id|pci_device_to_OF_node
(paren
id|pdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|of_node
)paren
id|pmac_call_feature
c_func
(paren
id|PMAC_FTR_1394_ENABLE
comma
id|of_node
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
)brace
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
DECL|macro|PCI_CLASS_FIREWIRE_OHCI
mdefine_line|#define PCI_CLASS_FIREWIRE_OHCI     ((PCI_CLASS_SERIAL_FIREWIRE &lt;&lt; 8) | 0x10)
DECL|variable|ohci1394_pci_tbl
r_static
r_struct
id|pci_device_id
id|ohci1394_pci_tbl
(braket
)braket
op_assign
(brace
(brace
dot
r_class
op_assign
id|PCI_CLASS_FIREWIRE_OHCI
comma
dot
id|class_mask
op_assign
id|PCI_ANY_ID
comma
dot
id|vendor
op_assign
id|PCI_ANY_ID
comma
dot
id|device
op_assign
id|PCI_ANY_ID
comma
dot
id|subvendor
op_assign
id|PCI_ANY_ID
comma
dot
id|subdevice
op_assign
id|PCI_ANY_ID
comma
)brace
comma
(brace
l_int|0
comma
)brace
comma
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|pci
comma
id|ohci1394_pci_tbl
)paren
suffix:semicolon
DECL|variable|ohci1394_pci_driver
r_static
r_struct
id|pci_driver
id|ohci1394_pci_driver
op_assign
(brace
dot
id|name
op_assign
id|OHCI1394_DRIVER_NAME
comma
dot
id|id_table
op_assign
id|ohci1394_pci_tbl
comma
dot
id|probe
op_assign
id|ohci1394_pci_probe
comma
dot
id|remove
op_assign
id|ohci1394_pci_remove
comma
dot
id|resume
op_assign
id|ohci1394_pci_resume
comma
dot
id|suspend
op_assign
id|ohci1394_pci_suspend
comma
)brace
suffix:semicolon
"&f;"
multiline_comment|/***********************************&n; * OHCI1394 Video Interface        *&n; ***********************************/
multiline_comment|/* essentially the only purpose of this code is to allow another&n;   module to hook into ohci&squot;s interrupt handler */
DECL|function|ohci1394_stop_context
r_int
id|ohci1394_stop_context
c_func
(paren
r_struct
id|ti_ohci
op_star
id|ohci
comma
r_int
id|reg
comma
r_char
op_star
id|msg
)paren
(brace
r_int
id|i
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* stop the channel program if it&squot;s still running */
id|reg_write
c_func
(paren
id|ohci
comma
id|reg
comma
l_int|0x8000
)paren
suffix:semicolon
multiline_comment|/* Wait until it effectively stops */
r_while
c_loop
(paren
id|reg_read
c_func
(paren
id|ohci
comma
id|reg
)paren
op_amp
l_int|0x400
)paren
(brace
id|i
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|i
OG
l_int|5000
)paren
(brace
id|PRINT
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;Runaway loop while stopping context: %s...&quot;
comma
id|msg
ques
c_cond
id|msg
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|mb
c_func
(paren
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|msg
)paren
id|PRINT
c_func
(paren
id|KERN_ERR
comma
l_string|&quot;%s: dma prg stopped&quot;
comma
id|msg
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ohci1394_init_iso_tasklet
r_void
id|ohci1394_init_iso_tasklet
c_func
(paren
r_struct
id|ohci1394_iso_tasklet
op_star
id|tasklet
comma
r_int
id|type
comma
r_void
(paren
op_star
id|func
)paren
(paren
r_int
r_int
)paren
comma
r_int
r_int
id|data
)paren
(brace
id|tasklet_init
c_func
(paren
op_amp
id|tasklet-&gt;tasklet
comma
id|func
comma
id|data
)paren
suffix:semicolon
id|tasklet-&gt;type
op_assign
id|type
suffix:semicolon
multiline_comment|/* We init the tasklet-&gt;link field, so we can list_del() it&n;&t; * without worrying whether it was added to the list or not. */
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|tasklet-&gt;link
)paren
suffix:semicolon
)brace
DECL|function|ohci1394_register_iso_tasklet
r_int
id|ohci1394_register_iso_tasklet
c_func
(paren
r_struct
id|ti_ohci
op_star
id|ohci
comma
r_struct
id|ohci1394_iso_tasklet
op_star
id|tasklet
)paren
(brace
r_int
r_int
id|flags
comma
op_star
id|usage
suffix:semicolon
r_int
id|n
comma
id|i
comma
id|r
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_if
c_cond
(paren
id|tasklet-&gt;type
op_eq
id|OHCI_ISO_TRANSMIT
)paren
(brace
id|n
op_assign
id|ohci-&gt;nb_iso_xmit_ctx
suffix:semicolon
id|usage
op_assign
op_amp
id|ohci-&gt;it_ctx_usage
suffix:semicolon
)brace
r_else
(brace
id|n
op_assign
id|ohci-&gt;nb_iso_rcv_ctx
suffix:semicolon
id|usage
op_assign
op_amp
id|ohci-&gt;ir_ctx_usage
suffix:semicolon
multiline_comment|/* only one receive context can be multichannel (OHCI sec 10.4.1) */
r_if
c_cond
(paren
id|tasklet-&gt;type
op_eq
id|OHCI_ISO_MULTICHANNEL_RECEIVE
)paren
(brace
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
l_int|0
comma
op_amp
id|ohci-&gt;ir_multichannel_used
)paren
)paren
(brace
r_return
id|r
suffix:semicolon
)brace
)brace
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ohci-&gt;iso_tasklet_list_lock
comma
id|flags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|n
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
op_logical_neg
id|test_and_set_bit
c_func
(paren
id|i
comma
id|usage
)paren
)paren
(brace
id|tasklet-&gt;context
op_assign
id|i
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|tasklet-&gt;link
comma
op_amp
id|ohci-&gt;iso_tasklet_list
)paren
suffix:semicolon
id|r
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ohci-&gt;iso_tasklet_list_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|r
suffix:semicolon
)brace
DECL|function|ohci1394_unregister_iso_tasklet
r_void
id|ohci1394_unregister_iso_tasklet
c_func
(paren
r_struct
id|ti_ohci
op_star
id|ohci
comma
r_struct
id|ohci1394_iso_tasklet
op_star
id|tasklet
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|tasklet_kill
c_func
(paren
op_amp
id|tasklet-&gt;tasklet
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|ohci-&gt;iso_tasklet_list_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tasklet-&gt;type
op_eq
id|OHCI_ISO_TRANSMIT
)paren
id|clear_bit
c_func
(paren
id|tasklet-&gt;context
comma
op_amp
id|ohci-&gt;it_ctx_usage
)paren
suffix:semicolon
r_else
(brace
id|clear_bit
c_func
(paren
id|tasklet-&gt;context
comma
op_amp
id|ohci-&gt;ir_ctx_usage
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tasklet-&gt;type
op_eq
id|OHCI_ISO_MULTICHANNEL_RECEIVE
)paren
(brace
id|clear_bit
c_func
(paren
l_int|0
comma
op_amp
id|ohci-&gt;ir_multichannel_used
)paren
suffix:semicolon
)brace
)brace
id|list_del
c_func
(paren
op_amp
id|tasklet-&gt;link
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|ohci-&gt;iso_tasklet_list_lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|variable|ohci1394_stop_context
id|EXPORT_SYMBOL
c_func
(paren
id|ohci1394_stop_context
)paren
suffix:semicolon
DECL|variable|ohci1394_init_iso_tasklet
id|EXPORT_SYMBOL
c_func
(paren
id|ohci1394_init_iso_tasklet
)paren
suffix:semicolon
DECL|variable|ohci1394_register_iso_tasklet
id|EXPORT_SYMBOL
c_func
(paren
id|ohci1394_register_iso_tasklet
)paren
suffix:semicolon
DECL|variable|ohci1394_unregister_iso_tasklet
id|EXPORT_SYMBOL
c_func
(paren
id|ohci1394_unregister_iso_tasklet
)paren
suffix:semicolon
multiline_comment|/***********************************&n; * General module initialization   *&n; ***********************************/
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Sebastien Rougeaux &lt;sebastien.rougeaux@anu.edu.au&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Driver for PCI OHCI IEEE-1394 controllers&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
DECL|function|ohci1394_cleanup
r_static
r_void
id|__exit
id|ohci1394_cleanup
(paren
r_void
)paren
(brace
id|pci_unregister_driver
c_func
(paren
op_amp
id|ohci1394_pci_driver
)paren
suffix:semicolon
)brace
DECL|function|ohci1394_init
r_static
r_int
id|__init
id|ohci1394_init
c_func
(paren
r_void
)paren
(brace
r_return
id|pci_module_init
c_func
(paren
op_amp
id|ohci1394_pci_driver
)paren
suffix:semicolon
)brace
DECL|variable|ohci1394_init
id|module_init
c_func
(paren
id|ohci1394_init
)paren
suffix:semicolon
DECL|variable|ohci1394_cleanup
id|module_exit
c_func
(paren
id|ohci1394_cleanup
)paren
suffix:semicolon
eof
