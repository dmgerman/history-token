multiline_comment|/*&n; * IEEE 1394 for Linux&n; *&n; * Low level (host adapter) management.&n; *&n; * Copyright (C) 1999 Andreas E. Bombe&n; * Copyright (C) 1999 Emanuel Pirker&n; *&n; * This code is licensed under the GPL.  See the file COPYING in the root&n; * directory of the kernel sources for details.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/list.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &quot;ieee1394_types.h&quot;
macro_line|#include &quot;hosts.h&quot;
macro_line|#include &quot;ieee1394_core.h&quot;
macro_line|#include &quot;highlevel.h&quot;
DECL|variable|hosts
r_static
r_struct
id|list_head
id|hosts
op_assign
id|LIST_HEAD_INIT
c_func
(paren
id|hosts
)paren
suffix:semicolon
DECL|variable|host_drivers
r_static
r_struct
id|list_head
id|host_drivers
op_assign
id|LIST_HEAD_INIT
c_func
(paren
id|host_drivers
)paren
suffix:semicolon
DECL|variable|hosts_lock
id|spinlock_t
id|hosts_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
DECL|variable|host_drivers_lock
id|spinlock_t
id|host_drivers_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
DECL|function|dummy_transmit_packet
r_static
r_int
id|dummy_transmit_packet
c_func
(paren
r_struct
id|hpsb_host
op_star
id|h
comma
r_struct
id|hpsb_packet
op_star
id|p
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dummy_devctl
r_static
r_int
id|dummy_devctl
c_func
(paren
r_struct
id|hpsb_host
op_star
id|h
comma
r_enum
id|devctl_cmd
id|c
comma
r_int
id|arg
)paren
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
DECL|function|dummy_isoctl
r_static
r_int
id|dummy_isoctl
c_func
(paren
r_struct
id|hpsb_iso
op_star
id|iso
comma
r_enum
id|isoctl_cmd
id|command
comma
r_int
r_int
id|arg
)paren
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
DECL|variable|dummy_driver
r_static
r_struct
id|hpsb_host_driver
id|dummy_driver
op_assign
(brace
dot
id|transmit_packet
op_assign
id|dummy_transmit_packet
comma
dot
id|devctl
op_assign
id|dummy_devctl
comma
dot
id|isoctl
op_assign
id|dummy_isoctl
)brace
suffix:semicolon
multiline_comment|/**&n; * hpsb_ref_host - increase reference count for host controller.&n; * @host: the host controller&n; *&n; * Increase the reference count for the specified host controller.&n; * When holding a reference to a host, the memory allocated for the&n; * host struct will not be freed and the host is guaranteed to be in a&n; * consistent state.  The driver may be unloaded or the controller may&n; * be removed (PCMCIA), but the host struct will remain valid.&n; */
DECL|function|hpsb_ref_host
r_int
id|hpsb_ref_host
c_func
(paren
r_struct
id|hpsb_host
op_star
id|host
)paren
(brace
r_struct
id|list_head
op_star
id|lh
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|hosts_lock
comma
id|flags
)paren
suffix:semicolon
id|list_for_each
c_func
(paren
id|lh
comma
op_amp
id|hosts
)paren
(brace
r_if
c_cond
(paren
id|host
op_eq
id|list_entry
c_func
(paren
id|lh
comma
r_struct
id|hpsb_host
comma
id|host_list
)paren
)paren
(brace
r_if
c_cond
(paren
id|try_module_get
c_func
(paren
id|host-&gt;driver-&gt;owner
)paren
)paren
(brace
multiline_comment|/* we&squot;re doing this twice and don&squot;t seem&n;&t;&t;&t;&t;   to undo it..  --hch */
(paren
r_void
)paren
id|try_module_get
c_func
(paren
id|host-&gt;driver-&gt;owner
)paren
suffix:semicolon
id|host-&gt;refcount
op_increment
suffix:semicolon
id|retval
op_assign
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|hosts_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/**&n; * hpsb_unref_host - decrease reference count for host controller.&n; * @host: the host controller&n; *&n; * Decrease the reference count for the specified host controller.&n; * When the reference count reaches zero, the memory allocated for the&n; * &amp;hpsb_host will be freed.&n; */
DECL|function|hpsb_unref_host
r_void
id|hpsb_unref_host
c_func
(paren
r_struct
id|hpsb_host
op_star
id|host
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|module_put
c_func
(paren
id|host-&gt;driver-&gt;owner
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|hosts_lock
comma
id|flags
)paren
suffix:semicolon
id|host-&gt;refcount
op_decrement
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|host-&gt;refcount
op_logical_and
id|host-&gt;is_shutdown
)paren
id|kfree
c_func
(paren
id|host
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|hosts_lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * hpsb_alloc_host - allocate a new host controller.&n; * @drv: the driver that will manage the host controller&n; * @extra: number of extra bytes to allocate for the driver&n; *&n; * Allocate a &amp;hpsb_host and initialize the general subsystem specific&n; * fields.  If the driver needs to store per host data, as drivers&n; * usually do, the amount of memory required can be specified by the&n; * @extra parameter.  Once allocated, the driver should initialize the&n; * driver specific parts, enable the controller and make it available&n; * to the general subsystem using hpsb_add_host().&n; *&n; * The &amp;hpsb_host is allocated with an single initial reference&n; * belonging to the driver.  Once the driver is done with the struct,&n; * for example, when the driver is unloaded, it should release this&n; * reference using hpsb_unref_host().&n; *&n; * Return Value: a pointer to the &amp;hpsb_host if succesful, %NULL if&n; * no memory was available.&n; */
DECL|function|hpsb_alloc_host
r_struct
id|hpsb_host
op_star
id|hpsb_alloc_host
c_func
(paren
r_struct
id|hpsb_host_driver
op_star
id|drv
comma
r_int
id|extra
)paren
(brace
r_struct
id|hpsb_host
op_star
id|h
suffix:semicolon
r_int
id|i
suffix:semicolon
id|h
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|hpsb_host
)paren
op_plus
id|extra
comma
id|SLAB_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|h
)paren
r_return
l_int|NULL
suffix:semicolon
id|memset
c_func
(paren
id|h
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|hpsb_host
)paren
op_plus
id|extra
)paren
suffix:semicolon
id|h-&gt;hostdata
op_assign
id|h
op_plus
l_int|1
suffix:semicolon
id|h-&gt;driver
op_assign
id|drv
suffix:semicolon
id|h-&gt;refcount
op_assign
l_int|1
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|h-&gt;pending_packets
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|h-&gt;pending_pkt_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ARRAY_SIZE
c_func
(paren
id|h-&gt;tpool
)paren
suffix:semicolon
id|i
op_increment
)paren
id|HPSB_TPOOL_INIT
c_func
(paren
op_amp
id|h-&gt;tpool
(braket
id|i
)braket
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|h-&gt;generation
comma
l_int|0
)paren
suffix:semicolon
id|HPSB_INIT_WORK
c_func
(paren
op_amp
id|h-&gt;timeout_tq
comma
(paren
r_void
(paren
op_star
)paren
(paren
r_void
op_star
)paren
)paren
id|abort_timedouts
comma
id|h
)paren
suffix:semicolon
id|h-&gt;topology_map
op_assign
id|h-&gt;csr.topology_map
op_plus
l_int|3
suffix:semicolon
id|h-&gt;speed_map
op_assign
(paren
id|u8
op_star
)paren
(paren
id|h-&gt;csr.speed_map
op_plus
l_int|2
)paren
suffix:semicolon
r_return
id|h
suffix:semicolon
)brace
DECL|function|hpsb_add_host
r_void
id|hpsb_add_host
c_func
(paren
r_struct
id|hpsb_host
op_star
id|host
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|hosts_lock
comma
id|flags
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|host-&gt;host_list
comma
op_amp
id|hosts
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|hosts_lock
comma
id|flags
)paren
suffix:semicolon
id|highlevel_add_host
c_func
(paren
id|host
)paren
suffix:semicolon
id|host-&gt;driver
op_member_access_from_pointer
id|devctl
c_func
(paren
id|host
comma
id|RESET_BUS
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|hpsb_remove_host
r_void
id|hpsb_remove_host
c_func
(paren
r_struct
id|hpsb_host
op_star
id|host
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|host-&gt;is_shutdown
op_assign
l_int|1
suffix:semicolon
id|host-&gt;driver
op_assign
op_amp
id|dummy_driver
suffix:semicolon
id|highlevel_remove_host
c_func
(paren
id|host
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|hosts_lock
comma
id|flags
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|host-&gt;host_list
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|hosts_lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * This function calls the given function for every host currently registered.&n; */
DECL|function|hl_all_hosts
r_void
id|hl_all_hosts
c_func
(paren
r_void
(paren
op_star
id|function
)paren
(paren
r_struct
id|hpsb_host
op_star
)paren
)paren
(brace
r_struct
id|list_head
op_star
id|lh
suffix:semicolon
r_struct
id|hpsb_host
op_star
id|host
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|hosts_lock
)paren
suffix:semicolon
id|list_for_each
(paren
id|lh
comma
op_amp
id|hosts
)paren
(brace
id|host
op_assign
id|list_entry
c_func
(paren
id|lh
comma
r_struct
id|hpsb_host
comma
id|host_list
)paren
suffix:semicolon
id|function
c_func
(paren
id|host
)paren
suffix:semicolon
)brace
id|spin_unlock_irq
c_func
(paren
op_amp
id|hosts_lock
)paren
suffix:semicolon
)brace
eof
