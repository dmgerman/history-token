multiline_comment|/* -*- linux-c -*-&n; *  drivers/char/viotape.c&n; *&n; *  iSeries Virtual Tape&n; *&n; *  Authors: Dave Boutcher &lt;boutcher@us.ibm.com&gt;&n; *           Ryan Arnold &lt;ryanarn@us.ibm.com&gt;&n; *           Colin Devilbiss &lt;devilbis@us.ibm.com&gt;&n; *           Stephen Rothwell &lt;sfr@au1.ibm.com&gt;&n; *&n; * (C) Copyright 2000-2004 IBM Corporation&n; *&n; * This program is free software;  you can redistribute it and/or&n; * modify it under the terms of the GNU General Public License as&n; * published by the Free Software Foundation; either version 2 of the&n; * License, or (at your option) anyu later version.&n; *&n; * This program is distributed in the hope that it will be useful, but&n; * WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU&n; * General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software Foundation,&n; * Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA&n; *&n; * This routine provides access to tape drives owned and managed by an OS/400&n; * partition running on the same box as this Linux partition.&n; *&n; * All tape operations are performed by sending messages back and forth to&n; * the OS/400 partition.  The format of the messages is defined in&n; * iSeries/vio.h&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/wait.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/mtio.h&gt;
macro_line|#include &lt;linux/device.h&gt;
macro_line|#include &lt;linux/dma-mapping.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/cdev.h&gt;
macro_line|#include &lt;linux/devfs_fs_kernel.h&gt;
macro_line|#include &lt;linux/major.h&gt;
macro_line|#include &lt;linux/completion.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/seq_file.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/ioctls.h&gt;
macro_line|#include &lt;asm/vio.h&gt;
macro_line|#include &lt;asm/iSeries/vio.h&gt;
macro_line|#include &lt;asm/iSeries/HvLpEvent.h&gt;
macro_line|#include &lt;asm/iSeries/HvCallEvent.h&gt;
macro_line|#include &lt;asm/iSeries/HvLpConfig.h&gt;
DECL|macro|VIOTAPE_VERSION
mdefine_line|#define VIOTAPE_VERSION&t;&t;&quot;1.2&quot;
DECL|macro|VIOTAPE_MAXREQ
mdefine_line|#define VIOTAPE_MAXREQ&t;&t;1
DECL|macro|VIOTAPE_KERN_WARN
mdefine_line|#define VIOTAPE_KERN_WARN&t;KERN_WARNING &quot;viotape: &quot;
DECL|macro|VIOTAPE_KERN_INFO
mdefine_line|#define VIOTAPE_KERN_INFO&t;KERN_INFO &quot;viotape: &quot;
DECL|variable|viotape_numdev
r_static
r_int
id|viotape_numdev
suffix:semicolon
multiline_comment|/*&n; * The minor number follows the conventions of the SCSI tape drives.  The&n; * rewind and mode are encoded in the minor #.  We use this struct to break&n; * them out&n; */
DECL|struct|viot_devinfo_struct
r_struct
id|viot_devinfo_struct
(brace
DECL|member|devno
r_int
id|devno
suffix:semicolon
DECL|member|mode
r_int
id|mode
suffix:semicolon
DECL|member|rewind
r_int
id|rewind
suffix:semicolon
)brace
suffix:semicolon
DECL|macro|VIOTAPOP_RESET
mdefine_line|#define VIOTAPOP_RESET          0
DECL|macro|VIOTAPOP_FSF
mdefine_line|#define VIOTAPOP_FSF&t;        1
DECL|macro|VIOTAPOP_BSF
mdefine_line|#define VIOTAPOP_BSF&t;        2
DECL|macro|VIOTAPOP_FSR
mdefine_line|#define VIOTAPOP_FSR&t;        3
DECL|macro|VIOTAPOP_BSR
mdefine_line|#define VIOTAPOP_BSR&t;        4
DECL|macro|VIOTAPOP_WEOF
mdefine_line|#define VIOTAPOP_WEOF&t;        5
DECL|macro|VIOTAPOP_REW
mdefine_line|#define VIOTAPOP_REW&t;        6
DECL|macro|VIOTAPOP_NOP
mdefine_line|#define VIOTAPOP_NOP&t;        7
DECL|macro|VIOTAPOP_EOM
mdefine_line|#define VIOTAPOP_EOM&t;        8
DECL|macro|VIOTAPOP_ERASE
mdefine_line|#define VIOTAPOP_ERASE          9
DECL|macro|VIOTAPOP_SETBLK
mdefine_line|#define VIOTAPOP_SETBLK        10
DECL|macro|VIOTAPOP_SETDENSITY
mdefine_line|#define VIOTAPOP_SETDENSITY    11
DECL|macro|VIOTAPOP_SETPOS
mdefine_line|#define VIOTAPOP_SETPOS&t;       12
DECL|macro|VIOTAPOP_GETPOS
mdefine_line|#define VIOTAPOP_GETPOS&t;       13
DECL|macro|VIOTAPOP_SETPART
mdefine_line|#define VIOTAPOP_SETPART       14
DECL|macro|VIOTAPOP_UNLOAD
mdefine_line|#define VIOTAPOP_UNLOAD        15
DECL|struct|viotapelpevent
r_struct
id|viotapelpevent
(brace
DECL|member|event
r_struct
id|HvLpEvent
id|event
suffix:semicolon
DECL|member|reserved
id|u32
id|reserved
suffix:semicolon
DECL|member|version
id|u16
id|version
suffix:semicolon
DECL|member|sub_type_result
id|u16
id|sub_type_result
suffix:semicolon
DECL|member|tape
id|u16
id|tape
suffix:semicolon
DECL|member|flags
id|u16
id|flags
suffix:semicolon
DECL|member|token
id|u32
id|token
suffix:semicolon
DECL|member|len
id|u64
id|len
suffix:semicolon
r_union
(brace
r_struct
(brace
DECL|member|tape_op
id|u32
id|tape_op
suffix:semicolon
DECL|member|count
id|u32
id|count
suffix:semicolon
DECL|member|op
)brace
id|op
suffix:semicolon
r_struct
(brace
DECL|member|type
id|u32
id|type
suffix:semicolon
DECL|member|resid
id|u32
id|resid
suffix:semicolon
DECL|member|dsreg
id|u32
id|dsreg
suffix:semicolon
DECL|member|gstat
id|u32
id|gstat
suffix:semicolon
DECL|member|erreg
id|u32
id|erreg
suffix:semicolon
DECL|member|file_no
id|u32
id|file_no
suffix:semicolon
DECL|member|block_no
id|u32
id|block_no
suffix:semicolon
DECL|member|get_status
)brace
id|get_status
suffix:semicolon
r_struct
(brace
DECL|member|block_no
id|u32
id|block_no
suffix:semicolon
DECL|member|get_pos
)brace
id|get_pos
suffix:semicolon
DECL|member|u
)brace
id|u
suffix:semicolon
)brace
suffix:semicolon
DECL|enum|viotapesubtype
r_enum
id|viotapesubtype
(brace
DECL|enumerator|viotapeopen
id|viotapeopen
op_assign
l_int|0x0001
comma
DECL|enumerator|viotapeclose
id|viotapeclose
op_assign
l_int|0x0002
comma
DECL|enumerator|viotaperead
id|viotaperead
op_assign
l_int|0x0003
comma
DECL|enumerator|viotapewrite
id|viotapewrite
op_assign
l_int|0x0004
comma
DECL|enumerator|viotapegetinfo
id|viotapegetinfo
op_assign
l_int|0x0005
comma
DECL|enumerator|viotapeop
id|viotapeop
op_assign
l_int|0x0006
comma
DECL|enumerator|viotapegetpos
id|viotapegetpos
op_assign
l_int|0x0007
comma
DECL|enumerator|viotapesetpos
id|viotapesetpos
op_assign
l_int|0x0008
comma
DECL|enumerator|viotapegetstatus
id|viotapegetstatus
op_assign
l_int|0x0009
)brace
suffix:semicolon
DECL|enum|viotaperc
r_enum
id|viotaperc
(brace
DECL|enumerator|viotape_InvalidRange
id|viotape_InvalidRange
op_assign
l_int|0x0601
comma
DECL|enumerator|viotape_InvalidToken
id|viotape_InvalidToken
op_assign
l_int|0x0602
comma
DECL|enumerator|viotape_DMAError
id|viotape_DMAError
op_assign
l_int|0x0603
comma
DECL|enumerator|viotape_UseError
id|viotape_UseError
op_assign
l_int|0x0604
comma
DECL|enumerator|viotape_ReleaseError
id|viotape_ReleaseError
op_assign
l_int|0x0605
comma
DECL|enumerator|viotape_InvalidTape
id|viotape_InvalidTape
op_assign
l_int|0x0606
comma
DECL|enumerator|viotape_InvalidOp
id|viotape_InvalidOp
op_assign
l_int|0x0607
comma
DECL|enumerator|viotape_TapeErr
id|viotape_TapeErr
op_assign
l_int|0x0608
comma
DECL|enumerator|viotape_AllocTimedOut
id|viotape_AllocTimedOut
op_assign
l_int|0x0640
comma
DECL|enumerator|viotape_BOTEnc
id|viotape_BOTEnc
op_assign
l_int|0x0641
comma
DECL|enumerator|viotape_BlankTape
id|viotape_BlankTape
op_assign
l_int|0x0642
comma
DECL|enumerator|viotape_BufferEmpty
id|viotape_BufferEmpty
op_assign
l_int|0x0643
comma
DECL|enumerator|viotape_CleanCartFound
id|viotape_CleanCartFound
op_assign
l_int|0x0644
comma
DECL|enumerator|viotape_CmdNotAllowed
id|viotape_CmdNotAllowed
op_assign
l_int|0x0645
comma
DECL|enumerator|viotape_CmdNotSupported
id|viotape_CmdNotSupported
op_assign
l_int|0x0646
comma
DECL|enumerator|viotape_DataCheck
id|viotape_DataCheck
op_assign
l_int|0x0647
comma
DECL|enumerator|viotape_DecompressErr
id|viotape_DecompressErr
op_assign
l_int|0x0648
comma
DECL|enumerator|viotape_DeviceTimeout
id|viotape_DeviceTimeout
op_assign
l_int|0x0649
comma
DECL|enumerator|viotape_DeviceUnavail
id|viotape_DeviceUnavail
op_assign
l_int|0x064a
comma
DECL|enumerator|viotape_DeviceBusy
id|viotape_DeviceBusy
op_assign
l_int|0x064b
comma
DECL|enumerator|viotape_EndOfMedia
id|viotape_EndOfMedia
op_assign
l_int|0x064c
comma
DECL|enumerator|viotape_EndOfTape
id|viotape_EndOfTape
op_assign
l_int|0x064d
comma
DECL|enumerator|viotape_EquipCheck
id|viotape_EquipCheck
op_assign
l_int|0x064e
comma
DECL|enumerator|viotape_InsufficientRs
id|viotape_InsufficientRs
op_assign
l_int|0x064f
comma
DECL|enumerator|viotape_InvalidLogBlk
id|viotape_InvalidLogBlk
op_assign
l_int|0x0650
comma
DECL|enumerator|viotape_LengthError
id|viotape_LengthError
op_assign
l_int|0x0651
comma
DECL|enumerator|viotape_LibDoorOpen
id|viotape_LibDoorOpen
op_assign
l_int|0x0652
comma
DECL|enumerator|viotape_LoadFailure
id|viotape_LoadFailure
op_assign
l_int|0x0653
comma
DECL|enumerator|viotape_NotCapable
id|viotape_NotCapable
op_assign
l_int|0x0654
comma
DECL|enumerator|viotape_NotOperational
id|viotape_NotOperational
op_assign
l_int|0x0655
comma
DECL|enumerator|viotape_NotReady
id|viotape_NotReady
op_assign
l_int|0x0656
comma
DECL|enumerator|viotape_OpCancelled
id|viotape_OpCancelled
op_assign
l_int|0x0657
comma
DECL|enumerator|viotape_PhyLinkErr
id|viotape_PhyLinkErr
op_assign
l_int|0x0658
comma
DECL|enumerator|viotape_RdyNotBOT
id|viotape_RdyNotBOT
op_assign
l_int|0x0659
comma
DECL|enumerator|viotape_TapeMark
id|viotape_TapeMark
op_assign
l_int|0x065a
comma
DECL|enumerator|viotape_WriteProt
id|viotape_WriteProt
op_assign
l_int|0x065b
)brace
suffix:semicolon
DECL|variable|viotape_err_table
r_static
r_const
r_struct
id|vio_error_entry
id|viotape_err_table
(braket
)braket
op_assign
(brace
(brace
id|viotape_InvalidRange
comma
id|EIO
comma
l_string|&quot;Internal error&quot;
)brace
comma
(brace
id|viotape_InvalidToken
comma
id|EIO
comma
l_string|&quot;Internal error&quot;
)brace
comma
(brace
id|viotape_DMAError
comma
id|EIO
comma
l_string|&quot;DMA error&quot;
)brace
comma
(brace
id|viotape_UseError
comma
id|EIO
comma
l_string|&quot;Internal error&quot;
)brace
comma
(brace
id|viotape_ReleaseError
comma
id|EIO
comma
l_string|&quot;Internal error&quot;
)brace
comma
(brace
id|viotape_InvalidTape
comma
id|EIO
comma
l_string|&quot;Invalid tape device&quot;
)brace
comma
(brace
id|viotape_InvalidOp
comma
id|EIO
comma
l_string|&quot;Invalid operation&quot;
)brace
comma
(brace
id|viotape_TapeErr
comma
id|EIO
comma
l_string|&quot;Tape error&quot;
)brace
comma
(brace
id|viotape_AllocTimedOut
comma
id|EBUSY
comma
l_string|&quot;Allocate timed out&quot;
)brace
comma
(brace
id|viotape_BOTEnc
comma
id|EIO
comma
l_string|&quot;Beginning of tape encountered&quot;
)brace
comma
(brace
id|viotape_BlankTape
comma
id|EIO
comma
l_string|&quot;Blank tape&quot;
)brace
comma
(brace
id|viotape_BufferEmpty
comma
id|EIO
comma
l_string|&quot;Buffer empty&quot;
)brace
comma
(brace
id|viotape_CleanCartFound
comma
id|ENOMEDIUM
comma
l_string|&quot;Cleaning cartridge found&quot;
)brace
comma
(brace
id|viotape_CmdNotAllowed
comma
id|EIO
comma
l_string|&quot;Command not allowed&quot;
)brace
comma
(brace
id|viotape_CmdNotSupported
comma
id|EIO
comma
l_string|&quot;Command not supported&quot;
)brace
comma
(brace
id|viotape_DataCheck
comma
id|EIO
comma
l_string|&quot;Data check&quot;
)brace
comma
(brace
id|viotape_DecompressErr
comma
id|EIO
comma
l_string|&quot;Decompression error&quot;
)brace
comma
(brace
id|viotape_DeviceTimeout
comma
id|EBUSY
comma
l_string|&quot;Device timeout&quot;
)brace
comma
(brace
id|viotape_DeviceUnavail
comma
id|EIO
comma
l_string|&quot;Device unavailable&quot;
)brace
comma
(brace
id|viotape_DeviceBusy
comma
id|EBUSY
comma
l_string|&quot;Device busy&quot;
)brace
comma
(brace
id|viotape_EndOfMedia
comma
id|ENOSPC
comma
l_string|&quot;End of media&quot;
)brace
comma
(brace
id|viotape_EndOfTape
comma
id|ENOSPC
comma
l_string|&quot;End of tape&quot;
)brace
comma
(brace
id|viotape_EquipCheck
comma
id|EIO
comma
l_string|&quot;Equipment check&quot;
)brace
comma
(brace
id|viotape_InsufficientRs
comma
id|EOVERFLOW
comma
l_string|&quot;Insufficient tape resources&quot;
)brace
comma
(brace
id|viotape_InvalidLogBlk
comma
id|EIO
comma
l_string|&quot;Invalid logical block location&quot;
)brace
comma
(brace
id|viotape_LengthError
comma
id|EOVERFLOW
comma
l_string|&quot;Length error&quot;
)brace
comma
(brace
id|viotape_LibDoorOpen
comma
id|EBUSY
comma
l_string|&quot;Door open&quot;
)brace
comma
(brace
id|viotape_LoadFailure
comma
id|ENOMEDIUM
comma
l_string|&quot;Load failure&quot;
)brace
comma
(brace
id|viotape_NotCapable
comma
id|EIO
comma
l_string|&quot;Not capable&quot;
)brace
comma
(brace
id|viotape_NotOperational
comma
id|EIO
comma
l_string|&quot;Not operational&quot;
)brace
comma
(brace
id|viotape_NotReady
comma
id|EIO
comma
l_string|&quot;Not ready&quot;
)brace
comma
(brace
id|viotape_OpCancelled
comma
id|EIO
comma
l_string|&quot;Operation cancelled&quot;
)brace
comma
(brace
id|viotape_PhyLinkErr
comma
id|EIO
comma
l_string|&quot;Physical link error&quot;
)brace
comma
(brace
id|viotape_RdyNotBOT
comma
id|EIO
comma
l_string|&quot;Ready but not beginning of tape&quot;
)brace
comma
(brace
id|viotape_TapeMark
comma
id|EIO
comma
l_string|&quot;Tape mark&quot;
)brace
comma
(brace
id|viotape_WriteProt
comma
id|EROFS
comma
l_string|&quot;Write protection error&quot;
)brace
comma
(brace
l_int|0
comma
l_int|0
comma
l_int|NULL
)brace
comma
)brace
suffix:semicolon
multiline_comment|/* Maximum number of tapes we support */
DECL|macro|VIOTAPE_MAX_TAPE
mdefine_line|#define VIOTAPE_MAX_TAPE&t;HVMAXARCHITECTEDVIRTUALTAPES
DECL|macro|MAX_PARTITIONS
mdefine_line|#define MAX_PARTITIONS&t;&t;4
multiline_comment|/* defines for current tape state */
DECL|macro|VIOT_IDLE
mdefine_line|#define VIOT_IDLE&t;&t;0
DECL|macro|VIOT_READING
mdefine_line|#define VIOT_READING&t;&t;1
DECL|macro|VIOT_WRITING
mdefine_line|#define VIOT_WRITING&t;&t;2
multiline_comment|/* Our info on the tapes */
DECL|struct|tape_descr
r_struct
id|tape_descr
(brace
DECL|member|rsrcname
r_char
id|rsrcname
(braket
l_int|10
)braket
suffix:semicolon
DECL|member|type
r_char
id|type
(braket
l_int|4
)braket
suffix:semicolon
DECL|member|model
r_char
id|model
(braket
l_int|3
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|viotape_unitinfo
r_static
r_struct
id|tape_descr
op_star
id|viotape_unitinfo
suffix:semicolon
DECL|variable|viotape_unitinfo_token
r_static
id|dma_addr_t
id|viotape_unitinfo_token
suffix:semicolon
DECL|variable|viomtget
r_static
r_struct
id|mtget
id|viomtget
(braket
id|VIOTAPE_MAX_TAPE
)braket
suffix:semicolon
DECL|variable|tape_class
r_static
r_struct
id|class_simple
op_star
id|tape_class
suffix:semicolon
DECL|variable|tape_device
r_static
r_struct
id|device
op_star
id|tape_device
(braket
id|VIOTAPE_MAX_TAPE
)braket
suffix:semicolon
multiline_comment|/*&n; * maintain the current state of each tape (and partition)&n; * so that we know when to write EOF marks.&n; */
r_static
r_struct
(brace
DECL|member|cur_part
r_int
r_char
id|cur_part
suffix:semicolon
DECL|member|dev_handle
r_int
id|dev_handle
suffix:semicolon
DECL|member|part_stat_rwi
r_int
r_char
id|part_stat_rwi
(braket
id|MAX_PARTITIONS
)braket
suffix:semicolon
DECL|variable|state
)brace
id|state
(braket
id|VIOTAPE_MAX_TAPE
)braket
suffix:semicolon
multiline_comment|/* We single-thread */
DECL|variable|reqSem
r_static
r_struct
id|semaphore
id|reqSem
suffix:semicolon
multiline_comment|/*&n; * When we send a request, we use this struct to get the response back&n; * from the interrupt handler&n; */
DECL|struct|op_struct
r_struct
id|op_struct
(brace
DECL|member|buffer
r_void
op_star
id|buffer
suffix:semicolon
DECL|member|dmaaddr
id|dma_addr_t
id|dmaaddr
suffix:semicolon
DECL|member|count
r_int
id|count
suffix:semicolon
DECL|member|rc
r_int
id|rc
suffix:semicolon
DECL|member|non_blocking
r_int
id|non_blocking
suffix:semicolon
DECL|member|com
r_struct
id|completion
id|com
suffix:semicolon
DECL|member|dev
r_struct
id|device
op_star
id|dev
suffix:semicolon
DECL|member|next
r_struct
id|op_struct
op_star
id|next
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|op_struct_list_lock
r_static
id|spinlock_t
id|op_struct_list_lock
suffix:semicolon
DECL|variable|op_struct_list
r_static
r_struct
id|op_struct
op_star
id|op_struct_list
suffix:semicolon
multiline_comment|/* forward declaration to resolve interdependence */
r_static
r_int
id|chg_state
c_func
(paren
r_int
id|index
comma
r_int
r_char
id|new_state
comma
r_struct
id|file
op_star
id|file
)paren
suffix:semicolon
multiline_comment|/* procfs support */
DECL|function|proc_viotape_show
r_static
r_int
id|proc_viotape_show
c_func
(paren
r_struct
id|seq_file
op_star
id|m
comma
r_void
op_star
id|v
)paren
(brace
r_int
id|i
suffix:semicolon
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;viotape driver version &quot;
id|VIOTAPE_VERSION
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|viotape_numdev
suffix:semicolon
id|i
op_increment
)paren
(brace
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;viotape device %d is iSeries resource %10.10s&quot;
l_string|&quot;type %4.4s, model %3.3s&bslash;n&quot;
comma
id|i
comma
id|viotape_unitinfo
(braket
id|i
)braket
dot
id|rsrcname
comma
id|viotape_unitinfo
(braket
id|i
)braket
dot
id|type
comma
id|viotape_unitinfo
(braket
id|i
)braket
dot
id|model
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|proc_viotape_open
r_static
r_int
id|proc_viotape_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_return
id|single_open
c_func
(paren
id|file
comma
id|proc_viotape_show
comma
l_int|NULL
)paren
suffix:semicolon
)brace
DECL|variable|proc_viotape_operations
r_static
r_struct
id|file_operations
id|proc_viotape_operations
op_assign
(brace
dot
id|open
op_assign
id|proc_viotape_open
comma
dot
id|read
op_assign
id|seq_read
comma
dot
id|llseek
op_assign
id|seq_lseek
comma
dot
id|release
op_assign
id|single_release
comma
)brace
suffix:semicolon
multiline_comment|/* Decode the device minor number into its parts */
DECL|function|get_dev_info
r_void
id|get_dev_info
c_func
(paren
r_struct
id|inode
op_star
id|ino
comma
r_struct
id|viot_devinfo_struct
op_star
id|devi
)paren
(brace
id|devi-&gt;devno
op_assign
id|iminor
c_func
(paren
id|ino
)paren
op_amp
l_int|0x1F
suffix:semicolon
id|devi-&gt;mode
op_assign
(paren
id|iminor
c_func
(paren
id|ino
)paren
op_amp
l_int|0x60
)paren
op_rshift
l_int|5
suffix:semicolon
multiline_comment|/* if bit is set in the minor, do _not_ rewind automatically */
id|devi-&gt;rewind
op_assign
(paren
id|iminor
c_func
(paren
id|ino
)paren
op_amp
l_int|0x80
)paren
op_eq
l_int|0
suffix:semicolon
)brace
multiline_comment|/* This is called only from the exit and init paths, so no need for locking */
DECL|function|clear_op_struct_pool
r_static
r_void
id|clear_op_struct_pool
c_func
(paren
r_void
)paren
(brace
r_while
c_loop
(paren
id|op_struct_list
)paren
(brace
r_struct
id|op_struct
op_star
id|toFree
op_assign
id|op_struct_list
suffix:semicolon
id|op_struct_list
op_assign
id|op_struct_list-&gt;next
suffix:semicolon
id|kfree
c_func
(paren
id|toFree
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Likewise, this is only called from the init path */
DECL|function|add_op_structs
r_static
r_int
id|add_op_structs
c_func
(paren
r_int
id|structs
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|structs
suffix:semicolon
op_increment
id|i
)paren
(brace
r_struct
id|op_struct
op_star
id|new_struct
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|new_struct
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|new_struct
)paren
(brace
id|clear_op_struct_pool
c_func
(paren
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|new_struct-&gt;next
op_assign
id|op_struct_list
suffix:semicolon
id|op_struct_list
op_assign
id|new_struct
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Allocate an op structure from our pool */
DECL|function|get_op_struct
r_static
r_struct
id|op_struct
op_star
id|get_op_struct
c_func
(paren
r_void
)paren
(brace
r_struct
id|op_struct
op_star
id|retval
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|op_struct_list_lock
comma
id|flags
)paren
suffix:semicolon
id|retval
op_assign
id|op_struct_list
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
id|op_struct_list
op_assign
id|retval-&gt;next
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|op_struct_list_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|memset
c_func
(paren
id|retval
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|retval
)paren
)paren
suffix:semicolon
id|init_completion
c_func
(paren
op_amp
id|retval-&gt;com
)paren
suffix:semicolon
)brace
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* Return an op structure to our pool */
DECL|function|free_op_struct
r_static
r_void
id|free_op_struct
c_func
(paren
r_struct
id|op_struct
op_star
id|op_struct
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|op_struct_list_lock
comma
id|flags
)paren
suffix:semicolon
id|op_struct-&gt;next
op_assign
id|op_struct_list
suffix:semicolon
id|op_struct_list
op_assign
id|op_struct
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|op_struct_list_lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* Map our tape return codes to errno values */
DECL|function|tape_rc_to_errno
r_int
id|tape_rc_to_errno
c_func
(paren
r_int
id|tape_rc
comma
r_char
op_star
id|operation
comma
r_int
id|tapeno
)paren
(brace
r_const
r_struct
id|vio_error_entry
op_star
id|err
suffix:semicolon
r_if
c_cond
(paren
id|tape_rc
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
id|err
op_assign
id|vio_lookup_rc
c_func
(paren
id|viotape_err_table
comma
id|tape_rc
)paren
suffix:semicolon
id|printk
c_func
(paren
id|VIOTAPE_KERN_WARN
l_string|&quot;error(%s) 0x%04x on Device %d (%-10s): %s&bslash;n&quot;
comma
id|operation
comma
id|tape_rc
comma
id|tapeno
comma
id|viotape_unitinfo
(braket
id|tapeno
)braket
dot
id|rsrcname
comma
id|err-&gt;msg
)paren
suffix:semicolon
r_return
op_minus
id|err-&gt;errno
suffix:semicolon
)brace
multiline_comment|/* Get info on all tapes from OS/400 */
DECL|function|get_viotape_info
r_static
r_int
id|get_viotape_info
c_func
(paren
r_void
)paren
(brace
id|HvLpEvent_Rc
id|hvrc
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|len
op_assign
r_sizeof
(paren
op_star
id|viotape_unitinfo
)paren
op_star
id|VIOTAPE_MAX_TAPE
suffix:semicolon
r_struct
id|op_struct
op_star
id|op
op_assign
id|get_op_struct
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|op
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|viotape_unitinfo
op_assign
id|dma_alloc_coherent
c_func
(paren
id|iSeries_vio_dev
comma
id|len
comma
op_amp
id|viotape_unitinfo_token
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|viotape_unitinfo
op_eq
l_int|NULL
)paren
(brace
id|free_op_struct
c_func
(paren
id|op
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|viotape_unitinfo
comma
l_int|0
comma
id|len
)paren
suffix:semicolon
id|hvrc
op_assign
id|HvCallEvent_signalLpEventFast
c_func
(paren
id|viopath_hostLp
comma
id|HvLpEvent_Type_VirtualIo
comma
id|viomajorsubtype_tape
op_or
id|viotapegetinfo
comma
id|HvLpEvent_AckInd_DoAck
comma
id|HvLpEvent_AckType_ImmediateAck
comma
id|viopath_sourceinst
c_func
(paren
id|viopath_hostLp
)paren
comma
id|viopath_targetinst
c_func
(paren
id|viopath_hostLp
)paren
comma
(paren
id|u64
)paren
(paren
r_int
r_int
)paren
id|op
comma
id|VIOVERSION
op_lshift
l_int|16
comma
id|viotape_unitinfo_token
comma
id|len
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hvrc
op_ne
id|HvLpEvent_Rc_Good
)paren
(brace
id|printk
c_func
(paren
id|VIOTAPE_KERN_WARN
l_string|&quot;hv error on op %d&bslash;n&quot;
comma
(paren
r_int
)paren
id|hvrc
)paren
suffix:semicolon
id|free_op_struct
c_func
(paren
id|op
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|wait_for_completion
c_func
(paren
op_amp
id|op-&gt;com
)paren
suffix:semicolon
id|free_op_struct
c_func
(paren
id|op
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
(paren
id|i
OL
id|VIOTAPE_MAX_TAPE
)paren
op_logical_and
(paren
id|viotape_unitinfo
(braket
id|i
)braket
dot
id|rsrcname
(braket
l_int|0
)braket
)paren
)paren
suffix:semicolon
id|i
op_increment
)paren
id|viotape_numdev
op_increment
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Write */
DECL|function|viotap_write
r_static
id|ssize_t
id|viotap_write
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
id|HvLpEvent_Rc
id|hvrc
suffix:semicolon
r_int
r_int
id|flags
op_assign
id|file-&gt;f_flags
suffix:semicolon
r_int
id|noblock
op_assign
(paren
(paren
id|flags
op_amp
id|O_NONBLOCK
)paren
op_ne
l_int|0
)paren
suffix:semicolon
id|ssize_t
id|ret
suffix:semicolon
r_struct
id|viot_devinfo_struct
id|devi
suffix:semicolon
r_struct
id|op_struct
op_star
id|op
op_assign
id|get_op_struct
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|op
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|get_dev_info
c_func
(paren
id|file-&gt;f_dentry-&gt;d_inode
comma
op_amp
id|devi
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * We need to make sure we can send a request.  We use&n;&t; * a semaphore to keep track of # requests in use.  If&n;&t; * we are non-blocking, make sure we don&squot;t block on the&n;&t; * semaphore&n;&t; */
r_if
c_cond
(paren
id|noblock
)paren
(brace
r_if
c_cond
(paren
id|down_trylock
c_func
(paren
op_amp
id|reqSem
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|EWOULDBLOCK
suffix:semicolon
r_goto
id|free_op
suffix:semicolon
)brace
)brace
r_else
id|down
c_func
(paren
op_amp
id|reqSem
)paren
suffix:semicolon
multiline_comment|/* Allocate a DMA buffer */
id|op-&gt;dev
op_assign
id|tape_device
(braket
id|devi.devno
)braket
suffix:semicolon
id|op-&gt;buffer
op_assign
id|dma_alloc_coherent
c_func
(paren
id|op-&gt;dev
comma
id|count
comma
op_amp
id|op-&gt;dmaaddr
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|op-&gt;buffer
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|VIOTAPE_KERN_WARN
l_string|&quot;error allocating dma buffer for len %ld&bslash;n&quot;
comma
id|count
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
id|up_sem
suffix:semicolon
)brace
multiline_comment|/* Copy the data into the buffer */
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|op-&gt;buffer
comma
id|buf
comma
id|count
)paren
)paren
(brace
id|printk
c_func
(paren
id|VIOTAPE_KERN_WARN
l_string|&quot;tape: error on copy from user&bslash;n&quot;
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
id|free_dma
suffix:semicolon
)brace
id|op-&gt;non_blocking
op_assign
id|noblock
suffix:semicolon
id|init_completion
c_func
(paren
op_amp
id|op-&gt;com
)paren
suffix:semicolon
id|op-&gt;count
op_assign
id|count
suffix:semicolon
id|hvrc
op_assign
id|HvCallEvent_signalLpEventFast
c_func
(paren
id|viopath_hostLp
comma
id|HvLpEvent_Type_VirtualIo
comma
id|viomajorsubtype_tape
op_or
id|viotapewrite
comma
id|HvLpEvent_AckInd_DoAck
comma
id|HvLpEvent_AckType_ImmediateAck
comma
id|viopath_sourceinst
c_func
(paren
id|viopath_hostLp
)paren
comma
id|viopath_targetinst
c_func
(paren
id|viopath_hostLp
)paren
comma
(paren
id|u64
)paren
(paren
r_int
r_int
)paren
id|op
comma
id|VIOVERSION
op_lshift
l_int|16
comma
(paren
(paren
id|u64
)paren
id|devi.devno
op_lshift
l_int|48
)paren
op_or
id|op-&gt;dmaaddr
comma
id|count
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hvrc
op_ne
id|HvLpEvent_Rc_Good
)paren
(brace
id|printk
c_func
(paren
id|VIOTAPE_KERN_WARN
l_string|&quot;hv error on op %d&bslash;n&quot;
comma
(paren
r_int
)paren
id|hvrc
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|free_dma
suffix:semicolon
)brace
r_if
c_cond
(paren
id|noblock
)paren
r_return
id|count
suffix:semicolon
id|wait_for_completion
c_func
(paren
op_amp
id|op-&gt;com
)paren
suffix:semicolon
r_if
c_cond
(paren
id|op-&gt;rc
)paren
id|ret
op_assign
id|tape_rc_to_errno
c_func
(paren
id|op-&gt;rc
comma
l_string|&quot;write&quot;
comma
id|devi.devno
)paren
suffix:semicolon
r_else
(brace
id|chg_state
c_func
(paren
id|devi.devno
comma
id|VIOT_WRITING
comma
id|file
)paren
suffix:semicolon
id|ret
op_assign
id|op-&gt;count
suffix:semicolon
)brace
id|free_dma
suffix:colon
id|dma_free_coherent
c_func
(paren
id|op-&gt;dev
comma
id|count
comma
id|op-&gt;buffer
comma
id|op-&gt;dmaaddr
)paren
suffix:semicolon
id|up_sem
suffix:colon
id|up
c_func
(paren
op_amp
id|reqSem
)paren
suffix:semicolon
id|free_op
suffix:colon
id|free_op_struct
c_func
(paren
id|op
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* read */
DECL|function|viotap_read
r_static
id|ssize_t
id|viotap_read
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ptr
)paren
(brace
id|HvLpEvent_Rc
id|hvrc
suffix:semicolon
r_int
r_int
id|flags
op_assign
id|file-&gt;f_flags
suffix:semicolon
r_struct
id|op_struct
op_star
id|op
op_assign
id|get_op_struct
c_func
(paren
)paren
suffix:semicolon
r_int
id|noblock
op_assign
(paren
(paren
id|flags
op_amp
id|O_NONBLOCK
)paren
op_ne
l_int|0
)paren
suffix:semicolon
id|ssize_t
id|ret
suffix:semicolon
r_struct
id|viot_devinfo_struct
id|devi
suffix:semicolon
r_if
c_cond
(paren
id|op
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|get_dev_info
c_func
(paren
id|file-&gt;f_dentry-&gt;d_inode
comma
op_amp
id|devi
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * We need to make sure we can send a request.  We use&n;&t; * a semaphore to keep track of # requests in use.  If&n;&t; * we are non-blocking, make sure we don&squot;t block on the&n;&t; * semaphore&n;&t; */
r_if
c_cond
(paren
id|noblock
)paren
(brace
r_if
c_cond
(paren
id|down_trylock
c_func
(paren
op_amp
id|reqSem
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|EWOULDBLOCK
suffix:semicolon
r_goto
id|free_op
suffix:semicolon
)brace
)brace
r_else
id|down
c_func
(paren
op_amp
id|reqSem
)paren
suffix:semicolon
id|chg_state
c_func
(paren
id|devi.devno
comma
id|VIOT_READING
comma
id|file
)paren
suffix:semicolon
multiline_comment|/* Allocate a DMA buffer */
id|op-&gt;dev
op_assign
id|tape_device
(braket
id|devi.devno
)braket
suffix:semicolon
id|op-&gt;buffer
op_assign
id|dma_alloc_coherent
c_func
(paren
id|op-&gt;dev
comma
id|count
comma
op_amp
id|op-&gt;dmaaddr
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|op-&gt;buffer
op_eq
l_int|NULL
)paren
(brace
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
id|up_sem
suffix:semicolon
)brace
id|op-&gt;count
op_assign
id|count
suffix:semicolon
id|init_completion
c_func
(paren
op_amp
id|op-&gt;com
)paren
suffix:semicolon
id|hvrc
op_assign
id|HvCallEvent_signalLpEventFast
c_func
(paren
id|viopath_hostLp
comma
id|HvLpEvent_Type_VirtualIo
comma
id|viomajorsubtype_tape
op_or
id|viotaperead
comma
id|HvLpEvent_AckInd_DoAck
comma
id|HvLpEvent_AckType_ImmediateAck
comma
id|viopath_sourceinst
c_func
(paren
id|viopath_hostLp
)paren
comma
id|viopath_targetinst
c_func
(paren
id|viopath_hostLp
)paren
comma
(paren
id|u64
)paren
(paren
r_int
r_int
)paren
id|op
comma
id|VIOVERSION
op_lshift
l_int|16
comma
(paren
(paren
id|u64
)paren
id|devi.devno
op_lshift
l_int|48
)paren
op_or
id|op-&gt;dmaaddr
comma
id|count
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hvrc
op_ne
id|HvLpEvent_Rc_Good
)paren
(brace
id|printk
c_func
(paren
id|VIOTAPE_KERN_WARN
l_string|&quot;tape hv error on op %d&bslash;n&quot;
comma
(paren
r_int
)paren
id|hvrc
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|free_dma
suffix:semicolon
)brace
id|wait_for_completion
c_func
(paren
op_amp
id|op-&gt;com
)paren
suffix:semicolon
r_if
c_cond
(paren
id|op-&gt;rc
)paren
id|ret
op_assign
id|tape_rc_to_errno
c_func
(paren
id|op-&gt;rc
comma
l_string|&quot;read&quot;
comma
id|devi.devno
)paren
suffix:semicolon
r_else
(brace
id|ret
op_assign
id|op-&gt;count
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_logical_and
id|copy_to_user
c_func
(paren
id|buf
comma
id|op-&gt;buffer
comma
id|ret
)paren
)paren
(brace
id|printk
c_func
(paren
id|VIOTAPE_KERN_WARN
l_string|&quot;error on copy_to_user&bslash;n&quot;
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
)brace
)brace
id|free_dma
suffix:colon
id|dma_free_coherent
c_func
(paren
id|op-&gt;dev
comma
id|count
comma
id|op-&gt;buffer
comma
id|op-&gt;dmaaddr
)paren
suffix:semicolon
id|up_sem
suffix:colon
id|up
c_func
(paren
op_amp
id|reqSem
)paren
suffix:semicolon
id|free_op
suffix:colon
id|free_op_struct
c_func
(paren
id|op
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* ioctl */
DECL|function|viotap_ioctl
r_static
r_int
id|viotap_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
id|HvLpEvent_Rc
id|hvrc
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_struct
id|viot_devinfo_struct
id|devi
suffix:semicolon
r_struct
id|mtop
id|mtc
suffix:semicolon
id|u32
id|myOp
suffix:semicolon
r_struct
id|op_struct
op_star
id|op
op_assign
id|get_op_struct
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|op
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|get_dev_info
c_func
(paren
id|file-&gt;f_dentry-&gt;d_inode
comma
op_amp
id|devi
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|reqSem
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|MTIOCTOP
suffix:colon
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
multiline_comment|/*&n;&t;&t; * inode is null if and only if we (the kernel)&n;&t;&t; * made the request&n;&t;&t; */
r_if
c_cond
(paren
id|inode
op_eq
l_int|NULL
)paren
id|memcpy
c_func
(paren
op_amp
id|mtc
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|mtop
)paren
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
(paren
r_char
op_star
)paren
op_amp
id|mtc
comma
(paren
r_char
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|mtop
)paren
)paren
)paren
r_goto
id|free_op
suffix:semicolon
id|ret
op_assign
op_minus
id|EIO
suffix:semicolon
r_switch
c_cond
(paren
id|mtc.mt_op
)paren
(brace
r_case
id|MTRESET
suffix:colon
id|myOp
op_assign
id|VIOTAPOP_RESET
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTFSF
suffix:colon
id|myOp
op_assign
id|VIOTAPOP_FSF
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTBSF
suffix:colon
id|myOp
op_assign
id|VIOTAPOP_BSF
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTFSR
suffix:colon
id|myOp
op_assign
id|VIOTAPOP_FSR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTBSR
suffix:colon
id|myOp
op_assign
id|VIOTAPOP_BSR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTWEOF
suffix:colon
id|myOp
op_assign
id|VIOTAPOP_WEOF
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTREW
suffix:colon
id|myOp
op_assign
id|VIOTAPOP_REW
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTNOP
suffix:colon
id|myOp
op_assign
id|VIOTAPOP_NOP
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTEOM
suffix:colon
id|myOp
op_assign
id|VIOTAPOP_EOM
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTERASE
suffix:colon
id|myOp
op_assign
id|VIOTAPOP_ERASE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTSETBLK
suffix:colon
id|myOp
op_assign
id|VIOTAPOP_SETBLK
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTSETDENSITY
suffix:colon
id|myOp
op_assign
id|VIOTAPOP_SETDENSITY
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTTELL
suffix:colon
id|myOp
op_assign
id|VIOTAPOP_GETPOS
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTSEEK
suffix:colon
id|myOp
op_assign
id|VIOTAPOP_SETPOS
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTSETPART
suffix:colon
id|myOp
op_assign
id|VIOTAPOP_SETPART
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MTOFFL
suffix:colon
id|myOp
op_assign
id|VIOTAPOP_UNLOAD
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|VIOTAPE_KERN_WARN
l_string|&quot;MTIOCTOP called &quot;
l_string|&quot;with invalid op 0x%x&bslash;n&quot;
comma
id|mtc.mt_op
)paren
suffix:semicolon
r_goto
id|free_op
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * if we moved the head, we are no longer&n;&t;&t; * reading or writing&n;&t;&t; */
r_switch
c_cond
(paren
id|mtc.mt_op
)paren
(brace
r_case
id|MTFSF
suffix:colon
r_case
id|MTBSF
suffix:colon
r_case
id|MTFSR
suffix:colon
r_case
id|MTBSR
suffix:colon
r_case
id|MTTELL
suffix:colon
r_case
id|MTSEEK
suffix:colon
r_case
id|MTREW
suffix:colon
id|chg_state
c_func
(paren
id|devi.devno
comma
id|VIOT_IDLE
comma
id|file
)paren
suffix:semicolon
)brace
id|init_completion
c_func
(paren
op_amp
id|op-&gt;com
)paren
suffix:semicolon
id|hvrc
op_assign
id|HvCallEvent_signalLpEventFast
c_func
(paren
id|viopath_hostLp
comma
id|HvLpEvent_Type_VirtualIo
comma
id|viomajorsubtype_tape
op_or
id|viotapeop
comma
id|HvLpEvent_AckInd_DoAck
comma
id|HvLpEvent_AckType_ImmediateAck
comma
id|viopath_sourceinst
c_func
(paren
id|viopath_hostLp
)paren
comma
id|viopath_targetinst
c_func
(paren
id|viopath_hostLp
)paren
comma
(paren
id|u64
)paren
(paren
r_int
r_int
)paren
id|op
comma
id|VIOVERSION
op_lshift
l_int|16
comma
(paren
(paren
id|u64
)paren
id|devi.devno
op_lshift
l_int|48
)paren
comma
l_int|0
comma
(paren
(paren
(paren
id|u64
)paren
id|myOp
)paren
op_lshift
l_int|32
)paren
op_or
id|mtc.mt_count
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hvrc
op_ne
id|HvLpEvent_Rc_Good
)paren
(brace
id|printk
c_func
(paren
id|VIOTAPE_KERN_WARN
l_string|&quot;hv error on op %d&bslash;n&quot;
comma
(paren
r_int
)paren
id|hvrc
)paren
suffix:semicolon
r_goto
id|free_op
suffix:semicolon
)brace
id|wait_for_completion
c_func
(paren
op_amp
id|op-&gt;com
)paren
suffix:semicolon
id|ret
op_assign
id|tape_rc_to_errno
c_func
(paren
id|op-&gt;rc
comma
l_string|&quot;tape operation&quot;
comma
id|devi.devno
)paren
suffix:semicolon
r_goto
id|free_op
suffix:semicolon
r_case
id|MTIOCGET
suffix:colon
id|ret
op_assign
op_minus
id|EIO
suffix:semicolon
id|init_completion
c_func
(paren
op_amp
id|op-&gt;com
)paren
suffix:semicolon
id|hvrc
op_assign
id|HvCallEvent_signalLpEventFast
c_func
(paren
id|viopath_hostLp
comma
id|HvLpEvent_Type_VirtualIo
comma
id|viomajorsubtype_tape
op_or
id|viotapegetstatus
comma
id|HvLpEvent_AckInd_DoAck
comma
id|HvLpEvent_AckType_ImmediateAck
comma
id|viopath_sourceinst
c_func
(paren
id|viopath_hostLp
)paren
comma
id|viopath_targetinst
c_func
(paren
id|viopath_hostLp
)paren
comma
(paren
id|u64
)paren
(paren
r_int
r_int
)paren
id|op
comma
id|VIOVERSION
op_lshift
l_int|16
comma
(paren
(paren
id|u64
)paren
id|devi.devno
op_lshift
l_int|48
)paren
comma
l_int|0
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hvrc
op_ne
id|HvLpEvent_Rc_Good
)paren
(brace
id|printk
c_func
(paren
id|VIOTAPE_KERN_WARN
l_string|&quot;hv error on op %d&bslash;n&quot;
comma
(paren
r_int
)paren
id|hvrc
)paren
suffix:semicolon
r_goto
id|free_op
suffix:semicolon
)brace
id|wait_for_completion
c_func
(paren
op_amp
id|op-&gt;com
)paren
suffix:semicolon
multiline_comment|/* Operation is complete - grab the error code */
id|ret
op_assign
id|tape_rc_to_errno
c_func
(paren
id|op-&gt;rc
comma
l_string|&quot;get status&quot;
comma
id|devi.devno
)paren
suffix:semicolon
id|free_op_struct
c_func
(paren
id|op
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|reqSem
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_eq
l_int|0
)paren
op_logical_and
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|viomtget
(braket
id|devi.devno
)braket
comma
r_sizeof
(paren
id|viomtget
(braket
l_int|0
)braket
)paren
)paren
)paren
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_return
id|ret
suffix:semicolon
r_case
id|MTIOCPOS
suffix:colon
id|printk
c_func
(paren
id|VIOTAPE_KERN_WARN
l_string|&quot;Got an (unsupported) MTIOCPOS&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|VIOTAPE_KERN_WARN
l_string|&quot;got an unsupported ioctl 0x%0x&bslash;n&quot;
comma
id|cmd
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|free_op
suffix:colon
id|free_op_struct
c_func
(paren
id|op
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|reqSem
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|viotap_open
r_static
r_int
id|viotap_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
id|HvLpEvent_Rc
id|hvrc
suffix:semicolon
r_struct
id|viot_devinfo_struct
id|devi
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_struct
id|op_struct
op_star
id|op
op_assign
id|get_op_struct
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|op
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|get_dev_info
c_func
(paren
id|file-&gt;f_dentry-&gt;d_inode
comma
op_amp
id|devi
)paren
suffix:semicolon
multiline_comment|/* Note: We currently only support one mode! */
r_if
c_cond
(paren
(paren
id|devi.devno
op_ge
id|viotape_numdev
)paren
op_logical_or
(paren
id|devi.mode
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|free_op
suffix:semicolon
)brace
id|init_completion
c_func
(paren
op_amp
id|op-&gt;com
)paren
suffix:semicolon
id|hvrc
op_assign
id|HvCallEvent_signalLpEventFast
c_func
(paren
id|viopath_hostLp
comma
id|HvLpEvent_Type_VirtualIo
comma
id|viomajorsubtype_tape
op_or
id|viotapeopen
comma
id|HvLpEvent_AckInd_DoAck
comma
id|HvLpEvent_AckType_ImmediateAck
comma
id|viopath_sourceinst
c_func
(paren
id|viopath_hostLp
)paren
comma
id|viopath_targetinst
c_func
(paren
id|viopath_hostLp
)paren
comma
(paren
id|u64
)paren
(paren
r_int
r_int
)paren
id|op
comma
id|VIOVERSION
op_lshift
l_int|16
comma
(paren
(paren
id|u64
)paren
id|devi.devno
op_lshift
l_int|48
)paren
comma
l_int|0
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hvrc
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|VIOTAPE_KERN_WARN
l_string|&quot;bad rc on signalLpEvent %d&bslash;n&quot;
comma
(paren
r_int
)paren
id|hvrc
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|free_op
suffix:semicolon
)brace
id|wait_for_completion
c_func
(paren
op_amp
id|op-&gt;com
)paren
suffix:semicolon
id|ret
op_assign
id|tape_rc_to_errno
c_func
(paren
id|op-&gt;rc
comma
l_string|&quot;open&quot;
comma
id|devi.devno
)paren
suffix:semicolon
id|free_op
suffix:colon
id|free_op_struct
c_func
(paren
id|op
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|viotap_release
r_static
r_int
id|viotap_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
id|HvLpEvent_Rc
id|hvrc
suffix:semicolon
r_struct
id|viot_devinfo_struct
id|devi
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_struct
id|op_struct
op_star
id|op
op_assign
id|get_op_struct
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|op
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|init_completion
c_func
(paren
op_amp
id|op-&gt;com
)paren
suffix:semicolon
id|get_dev_info
c_func
(paren
id|file-&gt;f_dentry-&gt;d_inode
comma
op_amp
id|devi
)paren
suffix:semicolon
r_if
c_cond
(paren
id|devi.devno
op_ge
id|viotape_numdev
)paren
(brace
id|ret
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|free_op
suffix:semicolon
)brace
id|chg_state
c_func
(paren
id|devi.devno
comma
id|VIOT_IDLE
comma
id|file
)paren
suffix:semicolon
r_if
c_cond
(paren
id|devi.rewind
)paren
(brace
id|hvrc
op_assign
id|HvCallEvent_signalLpEventFast
c_func
(paren
id|viopath_hostLp
comma
id|HvLpEvent_Type_VirtualIo
comma
id|viomajorsubtype_tape
op_or
id|viotapeop
comma
id|HvLpEvent_AckInd_DoAck
comma
id|HvLpEvent_AckType_ImmediateAck
comma
id|viopath_sourceinst
c_func
(paren
id|viopath_hostLp
)paren
comma
id|viopath_targetinst
c_func
(paren
id|viopath_hostLp
)paren
comma
(paren
id|u64
)paren
(paren
r_int
r_int
)paren
id|op
comma
id|VIOVERSION
op_lshift
l_int|16
comma
(paren
(paren
id|u64
)paren
id|devi.devno
op_lshift
l_int|48
)paren
comma
l_int|0
comma
(paren
(paren
id|u64
)paren
id|VIOTAPOP_REW
)paren
op_lshift
l_int|32
comma
l_int|0
)paren
suffix:semicolon
id|wait_for_completion
c_func
(paren
op_amp
id|op-&gt;com
)paren
suffix:semicolon
id|tape_rc_to_errno
c_func
(paren
id|op-&gt;rc
comma
l_string|&quot;rewind&quot;
comma
id|devi.devno
)paren
suffix:semicolon
)brace
id|hvrc
op_assign
id|HvCallEvent_signalLpEventFast
c_func
(paren
id|viopath_hostLp
comma
id|HvLpEvent_Type_VirtualIo
comma
id|viomajorsubtype_tape
op_or
id|viotapeclose
comma
id|HvLpEvent_AckInd_DoAck
comma
id|HvLpEvent_AckType_ImmediateAck
comma
id|viopath_sourceinst
c_func
(paren
id|viopath_hostLp
)paren
comma
id|viopath_targetinst
c_func
(paren
id|viopath_hostLp
)paren
comma
(paren
id|u64
)paren
(paren
r_int
r_int
)paren
id|op
comma
id|VIOVERSION
op_lshift
l_int|16
comma
(paren
(paren
id|u64
)paren
id|devi.devno
op_lshift
l_int|48
)paren
comma
l_int|0
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hvrc
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|VIOTAPE_KERN_WARN
l_string|&quot;bad rc on signalLpEvent %d&bslash;n&quot;
comma
(paren
r_int
)paren
id|hvrc
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|free_op
suffix:semicolon
)brace
id|wait_for_completion
c_func
(paren
op_amp
id|op-&gt;com
)paren
suffix:semicolon
r_if
c_cond
(paren
id|op-&gt;rc
)paren
id|printk
c_func
(paren
id|VIOTAPE_KERN_WARN
l_string|&quot;close failed&bslash;n&quot;
)paren
suffix:semicolon
id|free_op
suffix:colon
id|free_op_struct
c_func
(paren
id|op
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|variable|viotap_fops
r_struct
id|file_operations
id|viotap_fops
op_assign
(brace
id|owner
suffix:colon
id|THIS_MODULE
comma
id|read
suffix:colon
id|viotap_read
comma
id|write
suffix:colon
id|viotap_write
comma
id|ioctl
suffix:colon
id|viotap_ioctl
comma
id|open
suffix:colon
id|viotap_open
comma
id|release
suffix:colon
id|viotap_release
comma
)brace
suffix:semicolon
multiline_comment|/* Handle interrupt events for tape */
DECL|function|vioHandleTapeEvent
r_static
r_void
id|vioHandleTapeEvent
c_func
(paren
r_struct
id|HvLpEvent
op_star
id|event
)paren
(brace
r_int
id|tapeminor
suffix:semicolon
r_struct
id|op_struct
op_star
id|op
suffix:semicolon
r_struct
id|viotapelpevent
op_star
id|tevent
op_assign
(paren
r_struct
id|viotapelpevent
op_star
)paren
id|event
suffix:semicolon
r_if
c_cond
(paren
id|event
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* Notification that a partition went away! */
r_if
c_cond
(paren
op_logical_neg
id|viopath_isactive
c_func
(paren
id|viopath_hostLp
)paren
)paren
(brace
multiline_comment|/* TODO! Clean up */
)brace
r_return
suffix:semicolon
)brace
id|tapeminor
op_assign
id|event-&gt;xSubtype
op_amp
id|VIOMINOR_SUBTYPE_MASK
suffix:semicolon
id|op
op_assign
(paren
r_struct
id|op_struct
op_star
)paren
id|event-&gt;xCorrelationToken
suffix:semicolon
r_switch
c_cond
(paren
id|tapeminor
)paren
(brace
r_case
id|viotapegetinfo
suffix:colon
r_case
id|viotapeopen
suffix:colon
r_case
id|viotapeclose
suffix:colon
id|op-&gt;rc
op_assign
id|tevent-&gt;sub_type_result
suffix:semicolon
id|complete
c_func
(paren
op_amp
id|op-&gt;com
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|viotaperead
suffix:colon
id|op-&gt;rc
op_assign
id|tevent-&gt;sub_type_result
suffix:semicolon
id|op-&gt;count
op_assign
id|tevent-&gt;len
suffix:semicolon
id|complete
c_func
(paren
op_amp
id|op-&gt;com
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|viotapewrite
suffix:colon
r_if
c_cond
(paren
id|op-&gt;non_blocking
)paren
(brace
id|dma_free_coherent
c_func
(paren
id|op-&gt;dev
comma
id|op-&gt;count
comma
id|op-&gt;buffer
comma
id|op-&gt;dmaaddr
)paren
suffix:semicolon
id|free_op_struct
c_func
(paren
id|op
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|reqSem
)paren
suffix:semicolon
)brace
r_else
(brace
id|op-&gt;rc
op_assign
id|tevent-&gt;sub_type_result
suffix:semicolon
id|op-&gt;count
op_assign
id|tevent-&gt;len
suffix:semicolon
id|complete
c_func
(paren
op_amp
id|op-&gt;com
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|viotapeop
suffix:colon
r_case
id|viotapegetpos
suffix:colon
r_case
id|viotapesetpos
suffix:colon
r_case
id|viotapegetstatus
suffix:colon
r_if
c_cond
(paren
id|op
)paren
(brace
id|op-&gt;count
op_assign
id|tevent-&gt;u.op.count
suffix:semicolon
id|op-&gt;rc
op_assign
id|tevent-&gt;sub_type_result
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|op-&gt;non_blocking
)paren
id|complete
c_func
(paren
op_amp
id|op-&gt;com
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|VIOTAPE_KERN_WARN
l_string|&quot;weird ack&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
DECL|function|viotape_probe
r_static
r_int
id|viotape_probe
c_func
(paren
r_struct
id|vio_dev
op_star
id|vdev
comma
r_const
r_struct
id|vio_device_id
op_star
id|id
)paren
(brace
r_char
id|tapename
(braket
l_int|32
)braket
suffix:semicolon
r_int
id|i
op_assign
id|vdev-&gt;unit_address
suffix:semicolon
r_int
id|j
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ge
id|viotape_numdev
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|tape_device
(braket
id|i
)braket
op_assign
op_amp
id|vdev-&gt;dev
suffix:semicolon
id|state
(braket
id|i
)braket
dot
id|cur_part
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|MAX_PARTITIONS
suffix:semicolon
op_increment
id|j
)paren
id|state
(braket
id|i
)braket
dot
id|part_stat_rwi
(braket
id|j
)braket
op_assign
id|VIOT_IDLE
suffix:semicolon
id|class_simple_device_add
c_func
(paren
id|tape_class
comma
id|MKDEV
c_func
(paren
id|VIOTAPE_MAJOR
comma
id|i
)paren
comma
l_int|NULL
comma
l_string|&quot;iseries!vt%d&quot;
comma
id|i
)paren
suffix:semicolon
id|class_simple_device_add
c_func
(paren
id|tape_class
comma
id|MKDEV
c_func
(paren
id|VIOTAPE_MAJOR
comma
id|i
op_or
l_int|0x80
)paren
comma
l_int|NULL
comma
l_string|&quot;iseries!nvt%d&quot;
comma
id|i
)paren
suffix:semicolon
id|devfs_mk_cdev
c_func
(paren
id|MKDEV
c_func
(paren
id|VIOTAPE_MAJOR
comma
id|i
)paren
comma
id|S_IFCHR
op_or
id|S_IRUSR
op_or
id|S_IWUSR
comma
l_string|&quot;iseries/vt%d&quot;
comma
id|i
)paren
suffix:semicolon
id|devfs_mk_cdev
c_func
(paren
id|MKDEV
c_func
(paren
id|VIOTAPE_MAJOR
comma
id|i
op_or
l_int|0x80
)paren
comma
id|S_IFCHR
op_or
id|S_IRUSR
op_or
id|S_IWUSR
comma
l_string|&quot;iseries/nvt%d&quot;
comma
id|i
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|tapename
comma
l_string|&quot;iseries/vt%d&quot;
comma
id|i
)paren
suffix:semicolon
id|state
(braket
id|i
)braket
dot
id|dev_handle
op_assign
id|devfs_register_tape
c_func
(paren
id|tapename
)paren
suffix:semicolon
id|printk
c_func
(paren
id|VIOTAPE_KERN_INFO
l_string|&quot;tape %s is iSeries &quot;
l_string|&quot;resource %10.10s type %4.4s, model %3.3s&bslash;n&quot;
comma
id|tapename
comma
id|viotape_unitinfo
(braket
id|i
)braket
dot
id|rsrcname
comma
id|viotape_unitinfo
(braket
id|i
)braket
dot
id|type
comma
id|viotape_unitinfo
(braket
id|i
)braket
dot
id|model
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|viotape_remove
r_static
r_int
id|viotape_remove
c_func
(paren
r_struct
id|vio_dev
op_star
id|vdev
)paren
(brace
r_int
id|i
op_assign
id|vdev-&gt;unit_address
suffix:semicolon
id|devfs_remove
c_func
(paren
l_string|&quot;iseries/nvt%d&quot;
comma
id|i
)paren
suffix:semicolon
id|devfs_remove
c_func
(paren
l_string|&quot;iseries/vt%d&quot;
comma
id|i
)paren
suffix:semicolon
id|devfs_unregister_tape
c_func
(paren
id|state
(braket
id|i
)braket
dot
id|dev_handle
)paren
suffix:semicolon
id|class_simple_device_remove
c_func
(paren
id|MKDEV
c_func
(paren
id|VIOTAPE_MAJOR
comma
id|i
op_or
l_int|0x80
)paren
)paren
suffix:semicolon
id|class_simple_device_remove
c_func
(paren
id|MKDEV
c_func
(paren
id|VIOTAPE_MAJOR
comma
id|i
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * viotape_device_table: Used by vio.c to match devices that we&n; * support.&n; */
DECL|variable|__devinitdata
r_static
r_struct
id|vio_device_id
id|viotape_device_table
(braket
)braket
id|__devinitdata
op_assign
(brace
(brace
l_string|&quot;viotape&quot;
comma
l_string|&quot;&quot;
)brace
comma
(brace
l_int|0
comma
)brace
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|vio
comma
id|viotape_device_table
)paren
suffix:semicolon
DECL|variable|viotape_driver
r_static
r_struct
id|vio_driver
id|viotape_driver
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;viotape&quot;
comma
dot
id|id_table
op_assign
id|viotape_device_table
comma
dot
id|probe
op_assign
id|viotape_probe
comma
dot
id|remove
op_assign
id|viotape_remove
)brace
suffix:semicolon
DECL|function|viotap_init
r_int
id|__init
id|viotap_init
c_func
(paren
r_void
)paren
(brace
r_int
id|ret
suffix:semicolon
r_struct
id|proc_dir_entry
op_star
id|e
suffix:semicolon
id|op_struct_list
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|add_op_structs
c_func
(paren
id|VIOTAPE_MAXREQ
)paren
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|VIOTAPE_KERN_WARN
l_string|&quot;couldn&squot;t allocate op structs&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
id|spin_lock_init
c_func
(paren
op_amp
id|op_struct_list_lock
)paren
suffix:semicolon
id|sema_init
c_func
(paren
op_amp
id|reqSem
comma
id|VIOTAPE_MAXREQ
)paren
suffix:semicolon
r_if
c_cond
(paren
id|viopath_hostLp
op_eq
id|HvLpIndexInvalid
)paren
(brace
id|vio_set_hostlp
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|viopath_hostLp
op_eq
id|HvLpIndexInvalid
)paren
(brace
id|ret
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|clear_op
suffix:semicolon
)brace
)brace
id|ret
op_assign
id|viopath_open
c_func
(paren
id|viopath_hostLp
comma
id|viomajorsubtype_tape
comma
id|VIOTAPE_MAXREQ
op_plus
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|printk
c_func
(paren
id|VIOTAPE_KERN_WARN
l_string|&quot;error on viopath_open to hostlp %d&bslash;n&quot;
comma
id|ret
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|clear_op
suffix:semicolon
)brace
id|printk
c_func
(paren
id|VIOTAPE_KERN_INFO
l_string|&quot;vers &quot;
id|VIOTAPE_VERSION
l_string|&quot;, hosting partition %d&bslash;n&quot;
comma
id|viopath_hostLp
)paren
suffix:semicolon
id|vio_setHandler
c_func
(paren
id|viomajorsubtype_tape
comma
id|vioHandleTapeEvent
)paren
suffix:semicolon
id|ret
op_assign
id|register_chrdev
c_func
(paren
id|VIOTAPE_MAJOR
comma
l_string|&quot;viotape&quot;
comma
op_amp
id|viotap_fops
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|VIOTAPE_KERN_WARN
l_string|&quot;Error registering viotape device&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|clear_handler
suffix:semicolon
)brace
id|tape_class
op_assign
id|class_simple_create
c_func
(paren
id|THIS_MODULE
comma
l_string|&quot;tape&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|tape_class
)paren
)paren
(brace
id|printk
c_func
(paren
id|VIOTAPE_KERN_WARN
l_string|&quot;Unable to allocat class&bslash;n&quot;
)paren
suffix:semicolon
id|ret
op_assign
id|PTR_ERR
c_func
(paren
id|tape_class
)paren
suffix:semicolon
r_goto
id|unreg_chrdev
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|get_viotape_info
c_func
(paren
)paren
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|VIOTAPE_KERN_WARN
l_string|&quot;Unable to obtain virtual device information&quot;
)paren
suffix:semicolon
r_goto
id|unreg_class
suffix:semicolon
)brace
id|ret
op_assign
id|vio_register_driver
c_func
(paren
op_amp
id|viotape_driver
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_goto
id|unreg_class
suffix:semicolon
id|e
op_assign
id|create_proc_entry
c_func
(paren
l_string|&quot;iSeries/viotape&quot;
comma
id|S_IFREG
op_or
id|S_IRUGO
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|e
)paren
(brace
id|e-&gt;owner
op_assign
id|THIS_MODULE
suffix:semicolon
id|e-&gt;proc_fops
op_assign
op_amp
id|proc_viotape_operations
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
id|unreg_class
suffix:colon
id|class_simple_destroy
c_func
(paren
id|tape_class
)paren
suffix:semicolon
id|unreg_chrdev
suffix:colon
id|unregister_chrdev
c_func
(paren
id|VIOTAPE_MAJOR
comma
l_string|&quot;viotape&quot;
)paren
suffix:semicolon
id|clear_handler
suffix:colon
id|vio_clearHandler
c_func
(paren
id|viomajorsubtype_tape
)paren
suffix:semicolon
id|viopath_close
c_func
(paren
id|viopath_hostLp
comma
id|viomajorsubtype_tape
comma
id|VIOTAPE_MAXREQ
op_plus
l_int|2
)paren
suffix:semicolon
id|clear_op
suffix:colon
id|clear_op_struct_pool
c_func
(paren
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* Give a new state to the tape object */
DECL|function|chg_state
r_static
r_int
id|chg_state
c_func
(paren
r_int
id|index
comma
r_int
r_char
id|new_state
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_int
r_char
op_star
id|cur_state
op_assign
op_amp
id|state
(braket
id|index
)braket
dot
id|part_stat_rwi
(braket
id|state
(braket
id|index
)braket
dot
id|cur_part
)braket
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* if the same state, don&squot;t bother */
r_if
c_cond
(paren
op_star
id|cur_state
op_eq
id|new_state
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* write an EOF if changing from writing to some other state */
r_if
c_cond
(paren
op_star
id|cur_state
op_eq
id|VIOT_WRITING
)paren
(brace
r_struct
id|mtop
id|write_eof
op_assign
(brace
id|MTWEOF
comma
l_int|1
)brace
suffix:semicolon
id|rc
op_assign
id|viotap_ioctl
c_func
(paren
l_int|NULL
comma
id|file
comma
id|MTIOCTOP
comma
(paren
r_int
r_int
)paren
op_amp
id|write_eof
)paren
suffix:semicolon
)brace
op_star
id|cur_state
op_assign
id|new_state
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/* Cleanup */
DECL|function|viotap_exit
r_static
r_void
id|__exit
id|viotap_exit
c_func
(paren
r_void
)paren
(brace
r_int
id|ret
suffix:semicolon
id|remove_proc_entry
c_func
(paren
l_string|&quot;iSeries/viotape&quot;
comma
l_int|NULL
)paren
suffix:semicolon
id|vio_unregister_driver
c_func
(paren
op_amp
id|viotape_driver
)paren
suffix:semicolon
id|class_simple_destroy
c_func
(paren
id|tape_class
)paren
suffix:semicolon
id|ret
op_assign
id|unregister_chrdev
c_func
(paren
id|VIOTAPE_MAJOR
comma
l_string|&quot;viotape&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
id|printk
c_func
(paren
id|VIOTAPE_KERN_WARN
l_string|&quot;Error unregistering device: %d&bslash;n&quot;
comma
id|ret
)paren
suffix:semicolon
r_if
c_cond
(paren
id|viotape_unitinfo
)paren
id|dma_free_coherent
c_func
(paren
id|iSeries_vio_dev
comma
r_sizeof
(paren
id|viotape_unitinfo
(braket
l_int|0
)braket
)paren
op_star
id|VIOTAPE_MAX_TAPE
comma
id|viotape_unitinfo
comma
id|viotape_unitinfo_token
)paren
suffix:semicolon
id|viopath_close
c_func
(paren
id|viopath_hostLp
comma
id|viomajorsubtype_tape
comma
id|VIOTAPE_MAXREQ
op_plus
l_int|2
)paren
suffix:semicolon
id|vio_clearHandler
c_func
(paren
id|viomajorsubtype_tape
)paren
suffix:semicolon
id|clear_op_struct_pool
c_func
(paren
)paren
suffix:semicolon
)brace
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
DECL|variable|viotap_init
id|module_init
c_func
(paren
id|viotap_init
)paren
suffix:semicolon
DECL|variable|viotap_exit
id|module_exit
c_func
(paren
id|viotap_exit
)paren
suffix:semicolon
eof
