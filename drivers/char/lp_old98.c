multiline_comment|/*&n; *&t;linux/drivers/char/lp_old98.c&n; *&n; * printer port driver for ancient PC-9800s with no bidirectional port support&n; *&n; * Copyright (C)  1998,99  Kousuke Takai &lt;tak@kmc.kyoto-u.ac.jp&gt;,&n; *&t;&t;&t;   Kyoto University Microcomputer Club&n; *&n; * This driver is based on and has compatibility with `lp.c&squot;,&n; * generic PC printer port driver.&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/major.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/console.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;linux/lp.h&gt;
multiline_comment|/*&n; *  I/O port numbers&n; */
DECL|macro|LP_PORT_DATA
mdefine_line|#define&t;LP_PORT_DATA&t;0x40
DECL|macro|LP_PORT_STATUS
mdefine_line|#define&t;LP_PORT_STATUS&t;(LP_PORT_DATA + 2)
DECL|macro|LP_PORT_STROBE
mdefine_line|#define&t;LP_PORT_STROBE&t;(LP_PORT_DATA + 4)
DECL|macro|LP_PORT_CONTROL
mdefine_line|#define LP_PORT_CONTROL&t;(LP_PORT_DATA + 6)
DECL|macro|LP_PORT_H98MODE
mdefine_line|#define&t;LP_PORT_H98MODE&t;0x0448
DECL|macro|LP_PORT_EXTMODE
mdefine_line|#define&t;LP_PORT_EXTMODE&t;0x0149
multiline_comment|/*&n; *  bit mask for I/O&n; */
DECL|macro|LP_MASK_nBUSY
mdefine_line|#define&t;LP_MASK_nBUSY&t;(1 &lt;&lt; 2)
DECL|macro|LP_MASK_nSTROBE
mdefine_line|#define&t;LP_MASK_nSTROBE&t;(1 &lt;&lt; 7)
DECL|macro|LP_CONTROL_ASSERT_STROBE
mdefine_line|#define LP_CONTROL_ASSERT_STROBE&t;(0x0e)
DECL|macro|LP_CONTROL_NEGATE_STROBE
mdefine_line|#define LP_CONTROL_NEGATE_STROBE&t;(0x0f)
multiline_comment|/*&n; *  Acceptable maximum value for non-privileged user for LPCHARS ioctl.&n; */
DECL|macro|LP_CHARS_NOPRIV_MAX
mdefine_line|#define LP_CHARS_NOPRIV_MAX&t;65535
DECL|macro|DC1
mdefine_line|#define&t;DC1&t;&squot;&bslash;x11&squot;
DECL|macro|DC3
mdefine_line|#define&t;DC3&t;&squot;&bslash;x13&squot;
multiline_comment|/* PC-9800s have at least and at most one old-style printer port. */
DECL|variable|lp
r_static
r_struct
id|lp_struct
id|lp
op_assign
(brace
dot
id|flags
op_assign
id|LP_EXIST
op_or
id|LP_ABORTOPEN
comma
dot
id|chars
op_assign
id|LP_INIT_CHAR
comma
dot
id|time
op_assign
id|LP_INIT_TIME
comma
dot
id|wait
op_assign
id|LP_INIT_WAIT
comma
)brace
suffix:semicolon
DECL|variable|dc1_check
r_static
r_int
id|dc1_check
suffix:semicolon
DECL|variable|lp_old98_lock
r_static
id|spinlock_t
id|lp_old98_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
DECL|macro|LP_OLD98_DEBUG
macro_line|#undef LP_OLD98_DEBUG
macro_line|#ifdef CONFIG_PC9800_OLDLP_CONSOLE
DECL|variable|lp_old98_console
r_static
r_struct
id|console
id|lp_old98_console
suffix:semicolon
multiline_comment|/* defined later */
DECL|variable|saved_console_flags
r_static
r_int
id|saved_console_flags
suffix:semicolon
macro_line|#endif
r_static
id|DECLARE_WAIT_QUEUE_HEAD
(paren
id|lp_old98_waitq
)paren
suffix:semicolon
DECL|function|lp_old98_timer_function
r_static
r_void
id|lp_old98_timer_function
c_func
(paren
r_int
r_int
id|data
)paren
(brace
r_if
c_cond
(paren
id|inb
c_func
(paren
id|LP_PORT_STATUS
)paren
op_amp
id|LP_MASK_nBUSY
)paren
id|wake_up_interruptible
c_func
(paren
op_amp
id|lp_old98_waitq
)paren
suffix:semicolon
r_else
(brace
r_struct
id|timer_list
op_star
id|t
op_assign
(paren
r_struct
id|timer_list
op_star
)paren
id|data
suffix:semicolon
id|t-&gt;expires
op_assign
id|jiffies
op_plus
l_int|1
suffix:semicolon
id|add_timer
c_func
(paren
id|t
)paren
suffix:semicolon
)brace
)brace
DECL|function|lp_old98_wait_ready
r_static
r_inline
r_int
id|lp_old98_wait_ready
c_func
(paren
r_void
)paren
(brace
r_struct
id|timer_list
id|timer
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|timer
)paren
suffix:semicolon
id|timer.function
op_assign
id|lp_old98_timer_function
suffix:semicolon
id|timer.expires
op_assign
id|jiffies
op_plus
l_int|1
suffix:semicolon
id|timer.data
op_assign
(paren
r_int
r_int
)paren
op_amp
id|timer
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|timer
)paren
suffix:semicolon
id|interruptible_sleep_on
c_func
(paren
op_amp
id|lp_old98_waitq
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|timer
)paren
suffix:semicolon
r_return
id|signal_pending
c_func
(paren
id|current
)paren
suffix:semicolon
)brace
DECL|function|lp_old98_char
r_static
r_inline
r_int
id|lp_old98_char
c_func
(paren
r_char
id|lpchar
)paren
(brace
r_int
r_int
id|count
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef LP_STATS
r_int
id|tmp
suffix:semicolon
macro_line|#endif
r_while
c_loop
(paren
op_logical_neg
(paren
id|inb
c_func
(paren
id|LP_PORT_STATUS
)paren
op_amp
id|LP_MASK_nBUSY
)paren
)paren
(brace
id|count
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|count
op_ge
id|lp.chars
)paren
r_return
l_int|0
suffix:semicolon
)brace
id|outb
c_func
(paren
id|lpchar
comma
id|LP_PORT_DATA
)paren
suffix:semicolon
macro_line|#ifdef LP_STATS
multiline_comment|/*&n;&t; *  Update lp statsistics here (and between next two outb()&squot;s).&n;&t; *  Time to compute it is part of storobe delay.&n;&t; */
r_if
c_cond
(paren
id|count
OG
id|lp.stats.maxwait
)paren
(brace
macro_line|#ifdef LP_OLD98_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;lp_old98: success after %d counts.&bslash;n&quot;
comma
id|count
)paren
suffix:semicolon
macro_line|#endif
id|lp.stats.maxwait
op_assign
id|count
suffix:semicolon
)brace
id|count
op_mul_assign
l_int|256
suffix:semicolon
id|tmp
op_assign
id|count
op_minus
id|lp.stats.meanwait
suffix:semicolon
r_if
c_cond
(paren
id|tmp
OL
l_int|0
)paren
id|tmp
op_assign
op_minus
id|tmp
suffix:semicolon
macro_line|#endif
id|ndelay
c_func
(paren
id|lp.wait
)paren
suffix:semicolon
multiline_comment|/* negate PSTB# (activate strobe)&t;*/
id|outb
c_func
(paren
id|LP_CONTROL_ASSERT_STROBE
comma
id|LP_PORT_CONTROL
)paren
suffix:semicolon
macro_line|#ifdef LP_STATS
id|lp.stats.meanwait
op_assign
(paren
l_int|255
op_star
id|lp.stats.meanwait
op_plus
id|count
op_plus
l_int|128
)paren
op_div
l_int|256
suffix:semicolon
id|lp.stats.mdev
op_assign
(paren
l_int|127
op_star
id|lp.stats.mdev
op_plus
id|tmp
op_plus
l_int|64
)paren
op_div
l_int|128
suffix:semicolon
id|lp.stats.chars
op_increment
suffix:semicolon
macro_line|#endif
id|ndelay
c_func
(paren
id|lp.wait
)paren
suffix:semicolon
multiline_comment|/* assert PSTB# (deactivate strobe)&t;*/
id|outb
c_func
(paren
id|LP_CONTROL_NEGATE_STROBE
comma
id|LP_PORT_CONTROL
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|lp_old98_write
r_static
id|ssize_t
id|lp_old98_write
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|dummy
)paren
(brace
r_int
r_int
id|total_bytes_written
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|access_ok
c_func
(paren
id|VERIFY_READ
comma
id|buf
comma
id|count
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
macro_line|#ifdef LP_STATS
r_if
c_cond
(paren
id|jiffies
op_minus
id|lp.lastcall
OG
id|lp.time
)paren
id|lp.runchars
op_assign
l_int|0
suffix:semicolon
id|lp.lastcall
op_assign
id|jiffies
suffix:semicolon
macro_line|#endif
r_do
(brace
r_int
r_int
id|bytes_written
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|copy_size
op_assign
(paren
id|count
OL
id|LP_BUFFER_SIZE
ques
c_cond
id|count
suffix:colon
id|LP_BUFFER_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|__copy_from_user
c_func
(paren
id|lp.lp_buffer
comma
id|buf
comma
id|copy_size
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_while
c_loop
(paren
id|bytes_written
OL
id|copy_size
)paren
(brace
r_if
c_cond
(paren
id|lp_old98_char
c_func
(paren
id|lp.lp_buffer
(braket
id|bytes_written
)braket
)paren
)paren
id|bytes_written
op_increment
suffix:semicolon
r_else
(brace
macro_line|#ifdef LP_STATS
r_int
id|rc
op_assign
id|lp.runchars
op_plus
id|bytes_written
suffix:semicolon
r_if
c_cond
(paren
id|rc
OG
id|lp.stats.maxrun
)paren
id|lp.stats.maxrun
op_assign
id|rc
suffix:semicolon
id|lp.stats.sleeps
op_increment
suffix:semicolon
macro_line|#endif
macro_line|#ifdef LP_OLD98_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;lp_old98: sleeping at %d characters&quot;
l_string|&quot; for %d jiffies&bslash;n&quot;
comma
id|lp.runchars
comma
id|lp.time
)paren
suffix:semicolon
id|lp.runchars
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|lp_old98_wait_ready
c_func
(paren
)paren
)paren
r_return
(paren
(paren
id|total_bytes_written
op_plus
id|bytes_written
)paren
ques
c_cond
suffix:colon
op_minus
id|EINTR
)paren
suffix:semicolon
)brace
)brace
id|total_bytes_written
op_add_assign
id|bytes_written
suffix:semicolon
id|buf
op_add_assign
id|bytes_written
suffix:semicolon
macro_line|#ifdef LP_STATS
id|lp.runchars
op_add_assign
id|bytes_written
suffix:semicolon
macro_line|#endif
id|count
op_sub_assign
id|bytes_written
suffix:semicolon
)brace
r_while
c_loop
(paren
id|count
OG
l_int|0
)paren
suffix:semicolon
r_return
id|total_bytes_written
suffix:semicolon
)brace
DECL|function|lp_old98_open
r_static
r_int
id|lp_old98_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_if
c_cond
(paren
id|iminor
c_func
(paren
id|inode
)paren
op_ne
l_int|0
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
r_if
c_cond
(paren
id|lp.flags
op_amp
id|LP_BUSY
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
r_if
c_cond
(paren
id|dc1_check
op_logical_and
(paren
id|lp.flags
op_amp
id|LP_ABORTOPEN
)paren
op_logical_and
op_logical_neg
(paren
id|file-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t; *  Check whether printer is on-line.&n;&t;&t; *  PC-9800&squot;s old style port have only BUSY# as status input,&n;&t;&t; *  so that it is impossible to distinguish that the printer is&n;&t;&t; *  ready and that the printer is off-line or not connected&n;&t;&t; *  (in both case BUSY# is in the same state). So:&n;&t;&t; *&n;&t;&t; *    (1) output DC1 (0x11) to printer port and do strobe.&n;&t;&t; *    (2) watch BUSY# line for a while. If BUSY# is pulled&n;&t;&t; *&t;  down, the printer will be ready. Otherwise,&n;&t;&t; *&t;  it will be off-line (or not connected, or power-off,&n;&t;&t; *&t;   ...).&n;&t;&t; *&n;&t;&t; *  The source of this procedure:&n;&t;&t; *&t;Terumasa KODAKA, Kazufumi SHIMIZU, Yu HAYAMI:&n;&t;&t; *&t;&t;`PC-9801 Super Technique&squot;, Ascii, 1992.&n;&t;&t; */
r_int
id|count
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/* interrupts while check is fairly bad */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|lp_old98_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|lp_old98_char
c_func
(paren
id|DC1
)paren
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|lp_old98_lock
comma
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|count
op_assign
(paren
r_int
r_int
)paren
id|dc1_check
OG
l_int|10000
ques
c_cond
l_int|10000
suffix:colon
id|dc1_check
suffix:semicolon
r_while
c_loop
(paren
id|inb
c_func
(paren
id|LP_PORT_STATUS
)paren
op_amp
id|LP_MASK_nBUSY
)paren
(brace
r_if
c_cond
(paren
op_decrement
id|count
op_eq
l_int|0
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|lp_old98_lock
comma
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|lp_old98_lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|lp.lp_buffer
op_assign
id|kmalloc
c_func
(paren
id|LP_BUFFER_SIZE
comma
id|GFP_KERNEL
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|lp.flags
op_or_assign
id|LP_BUSY
suffix:semicolon
macro_line|#ifdef CONFIG_PC9800_OLDLP_CONSOLE
id|saved_console_flags
op_assign
id|lp_old98_console.flags
suffix:semicolon
id|lp_old98_console.flags
op_and_assign
op_complement
id|CON_ENABLED
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|lp_old98_release
r_static
r_int
id|lp_old98_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
id|kfree
c_func
(paren
id|lp.lp_buffer
)paren
suffix:semicolon
id|lp.lp_buffer
op_assign
l_int|NULL
suffix:semicolon
id|lp.flags
op_and_assign
op_complement
id|LP_BUSY
suffix:semicolon
macro_line|#ifdef CONFIG_PC9800_OLDLP_CONSOLE
id|lp_old98_console.flags
op_assign
id|saved_console_flags
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|lp_old98_init_device
r_static
r_int
id|lp_old98_init_device
c_func
(paren
r_void
)paren
(brace
r_int
r_char
id|data
suffix:semicolon
r_if
c_cond
(paren
(paren
id|data
op_assign
id|inb
c_func
(paren
id|LP_PORT_EXTMODE
)paren
)paren
op_ne
l_int|0xFF
op_logical_and
(paren
id|data
op_amp
l_int|0x10
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;lp_old98: shutting down extended parallel port mode...&bslash;n&quot;
)paren
suffix:semicolon
id|outb
c_func
(paren
id|data
op_amp
op_complement
l_int|0x10
comma
id|LP_PORT_EXTMODE
)paren
suffix:semicolon
)brace
macro_line|#ifdef&t;PC98_HW_H98
r_if
c_cond
(paren
(paren
id|pc98_hw_flags
op_amp
id|PC98_HW_H98
)paren
op_logical_and
(paren
(paren
id|data
op_assign
id|inb
c_func
(paren
id|LP_PORT_H98MODE
)paren
)paren
op_amp
l_int|0x01
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;lp_old98: shutting down H98 full centronics mode...&bslash;n&quot;
)paren
suffix:semicolon
id|outb
c_func
(paren
id|data
op_amp
op_complement
l_int|0x01
comma
id|LP_PORT_H98MODE
)paren
suffix:semicolon
)brace
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|lp_old98_ioctl
r_static
r_int
id|lp_old98_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|command
comma
r_int
r_int
id|arg
)paren
(brace
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|command
)paren
(brace
r_case
id|LPTIME
suffix:colon
id|lp.time
op_assign
id|arg
op_star
id|HZ
op_div
l_int|100
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LPCHAR
suffix:colon
id|lp.chars
op_assign
id|arg
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LPABORT
suffix:colon
r_if
c_cond
(paren
id|arg
)paren
id|lp.flags
op_or_assign
id|LP_ABORT
suffix:semicolon
r_else
id|lp.flags
op_and_assign
op_complement
id|LP_ABORT
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LPABORTOPEN
suffix:colon
r_if
c_cond
(paren
id|arg
)paren
id|lp.flags
op_or_assign
id|LP_ABORTOPEN
suffix:semicolon
r_else
id|lp.flags
op_and_assign
op_complement
id|LP_ABORTOPEN
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LPCAREFUL
suffix:colon
multiline_comment|/* do nothing */
r_break
suffix:semicolon
r_case
id|LPWAIT
suffix:colon
id|lp.wait
op_assign
id|arg
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LPGETIRQ
suffix:colon
id|retval
op_assign
id|put_user
c_func
(paren
l_int|0
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LPGETSTATUS
suffix:colon
multiline_comment|/*&n;&t;&t; * convert PC-9800&squot;s status to IBM PC&squot;s one, so that tunelp(8)&n;&t;&t; * works in the same way on this driver.&n;&t;&t; */
id|retval
op_assign
id|put_user
c_func
(paren
(paren
id|inb
c_func
(paren
id|LP_PORT_STATUS
)paren
op_amp
id|LP_MASK_nBUSY
)paren
ques
c_cond
(paren
id|LP_PBUSY
op_or
id|LP_PERRORP
)paren
suffix:colon
id|LP_PERRORP
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LPRESET
suffix:colon
id|retval
op_assign
id|lp_old98_init_device
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#ifdef LP_STATS
r_case
id|LPGETSTATS
suffix:colon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_struct
id|lp_stats
op_star
)paren
id|arg
comma
op_amp
id|lp.stats
comma
r_sizeof
(paren
r_struct
id|lp_stats
)paren
)paren
)paren
id|retval
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_else
r_if
c_cond
(paren
id|suser
c_func
(paren
)paren
)paren
id|memset
c_func
(paren
op_amp
id|lp.stats
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|lp_stats
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_case
id|LPGETFLAGS
suffix:colon
id|retval
op_assign
id|put_user
c_func
(paren
id|lp.flags
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LPSETIRQ
suffix:colon
r_default
suffix:colon
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
id|retval
suffix:semicolon
)brace
DECL|variable|lp_old98_fops
r_static
r_struct
id|file_operations
id|lp_old98_fops
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|write
op_assign
id|lp_old98_write
comma
dot
id|ioctl
op_assign
id|lp_old98_ioctl
comma
dot
id|open
op_assign
id|lp_old98_open
comma
dot
id|release
op_assign
id|lp_old98_release
comma
)brace
suffix:semicolon
multiline_comment|/*&n; *  Support for console on lp_old98&n; */
macro_line|#ifdef CONFIG_PC9800_OLDLP_CONSOLE
DECL|function|io_delay
r_static
r_inline
r_void
id|io_delay
c_func
(paren
r_void
)paren
(brace
r_int
r_char
id|dummy
suffix:semicolon
multiline_comment|/* actually not output */
id|asm
r_volatile
(paren
l_string|&quot;out%B0 %0,%1&quot;
suffix:colon
l_string|&quot;=a&quot;
(paren
id|dummy
)paren
suffix:colon
l_string|&quot;N&quot;
(paren
l_int|0x5f
)paren
)paren
suffix:semicolon
)brace
DECL|function|lp_old98_console_write
r_static
r_void
id|lp_old98_console_write
c_func
(paren
r_struct
id|console
op_star
id|console
comma
r_const
r_char
op_star
id|s
comma
r_int
r_int
id|count
)paren
(brace
r_int
id|i
suffix:semicolon
r_static
r_int
r_int
id|timeout_run
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|count
)paren
(brace
multiline_comment|/* wait approx 1.2 seconds */
r_for
c_loop
(paren
id|i
op_assign
l_int|2000000
suffix:semicolon
op_logical_neg
(paren
id|inb
c_func
(paren
id|LP_PORT_STATUS
)paren
op_amp
id|LP_MASK_nBUSY
)paren
suffix:semicolon
id|io_delay
c_func
(paren
)paren
)paren
r_if
c_cond
(paren
op_logical_neg
op_decrement
id|i
)paren
(brace
r_if
c_cond
(paren
op_increment
id|timeout_run
op_ge
l_int|10
)paren
multiline_comment|/* disable forever... */
id|console-&gt;flags
op_and_assign
op_complement
id|CON_ENABLED
suffix:semicolon
r_return
suffix:semicolon
)brace
id|timeout_run
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_star
id|s
op_eq
l_char|&squot;&bslash;n&squot;
)paren
(brace
id|outb
c_func
(paren
l_char|&squot;&bslash;r&squot;
comma
id|LP_PORT_DATA
)paren
suffix:semicolon
id|io_delay
c_func
(paren
)paren
suffix:semicolon
id|io_delay
c_func
(paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|LP_CONTROL_ASSERT_STROBE
comma
id|LP_PORT_CONTROL
)paren
suffix:semicolon
id|io_delay
c_func
(paren
)paren
suffix:semicolon
id|io_delay
c_func
(paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|LP_CONTROL_NEGATE_STROBE
comma
id|LP_PORT_CONTROL
)paren
suffix:semicolon
id|io_delay
c_func
(paren
)paren
suffix:semicolon
id|io_delay
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1000000
suffix:semicolon
op_logical_neg
(paren
id|inb
c_func
(paren
id|LP_PORT_STATUS
)paren
op_amp
id|LP_MASK_nBUSY
)paren
suffix:semicolon
id|io_delay
c_func
(paren
)paren
)paren
r_if
c_cond
(paren
op_logical_neg
op_decrement
id|i
)paren
r_return
suffix:semicolon
)brace
id|outb
c_func
(paren
op_star
id|s
op_increment
comma
id|LP_PORT_DATA
)paren
suffix:semicolon
id|io_delay
c_func
(paren
)paren
suffix:semicolon
id|io_delay
c_func
(paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|LP_CONTROL_ASSERT_STROBE
comma
id|LP_PORT_CONTROL
)paren
suffix:semicolon
id|io_delay
c_func
(paren
)paren
suffix:semicolon
id|io_delay
c_func
(paren
)paren
suffix:semicolon
id|outb
c_func
(paren
id|LP_CONTROL_NEGATE_STROBE
comma
id|LP_PORT_CONTROL
)paren
suffix:semicolon
id|io_delay
c_func
(paren
)paren
suffix:semicolon
id|io_delay
c_func
(paren
)paren
suffix:semicolon
op_decrement
id|count
suffix:semicolon
)brace
)brace
DECL|variable|lp_old98_console
r_static
r_struct
id|console
id|lp_old98_console
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;lp_old98&quot;
comma
dot
id|write
op_assign
id|lp_old98_console_write
comma
dot
id|flags
op_assign
id|CON_PRINTBUFFER
comma
dot
id|index
op_assign
op_minus
l_int|1
comma
)brace
suffix:semicolon
macro_line|#endif&t;/* console on lp_old98 */
DECL|function|lp_old98_init
r_static
r_int
id|__init
id|lp_old98_init
c_func
(paren
r_void
)paren
(brace
r_char
op_star
id|errmsg
op_assign
l_string|&quot;I/O ports already occupied, giving up.&quot;
suffix:semicolon
macro_line|#ifdef&t;PC98_HW_H98
r_if
c_cond
(paren
id|pc98_hw_flags
op_amp
id|PC98_HW_H98
)paren
r_if
c_cond
(paren
op_logical_neg
id|request_region
c_func
(paren
id|LP_PORT_H98MODE
comma
l_int|1
comma
l_string|&quot;lp_old98&quot;
)paren
r_goto
id|err1
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|request_region
c_func
(paren
id|LP_PORT_DATA
comma
l_int|1
comma
l_string|&quot;lp_old98&quot;
)paren
)paren
r_goto
id|err2
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|request_region
c_func
(paren
id|LP_PORT_STATUS
comma
l_int|1
comma
l_string|&quot;lp_old98&quot;
)paren
)paren
r_goto
id|err3
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|request_region
c_func
(paren
id|LP_PORT_STROBE
comma
l_int|1
comma
l_string|&quot;lp_old98&quot;
)paren
)paren
r_goto
id|err4
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|request_region
c_func
(paren
id|LP_PORT_EXTMODE
comma
l_int|1
comma
l_string|&quot;lp_old98&quot;
)paren
)paren
r_goto
id|err5
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|register_chrdev
c_func
(paren
id|LP_MAJOR
comma
l_string|&quot;lp&quot;
comma
op_amp
id|lp_old98_fops
)paren
)paren
(brace
macro_line|#ifdef CONFIG_PC9800_OLDLP_CONSOLE
id|register_console
c_func
(paren
op_amp
id|lp_old98_console
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;lp_old98: console ready&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;&t;&t; * rest are not needed by this driver,&n;&t;&t; * but for locking out other printer drivers...&n;&t;&t; */
id|lp_old98_init_device
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
id|errmsg
op_assign
l_string|&quot;unable to register device&quot;
suffix:semicolon
id|release_region
c_func
(paren
id|LP_PORT_EXTMODE
comma
l_int|1
)paren
suffix:semicolon
id|err5
suffix:colon
id|release_region
c_func
(paren
id|LP_PORT_STROBE
comma
l_int|1
)paren
suffix:semicolon
id|err4
suffix:colon
id|release_region
c_func
(paren
id|LP_PORT_STATUS
comma
l_int|1
)paren
suffix:semicolon
id|err3
suffix:colon
id|release_region
c_func
(paren
id|LP_PORT_DATA
comma
l_int|1
)paren
suffix:semicolon
id|err2
suffix:colon
macro_line|#ifdef&t;PC98_HW_H98
r_if
c_cond
(paren
id|pc98_hw_flags
op_amp
id|PC98_HW_H98
)paren
id|release_region
c_func
(paren
id|LP_PORT_H98MODE
comma
l_int|1
)paren
suffix:semicolon
id|err1
suffix:colon
macro_line|#endif
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;lp_old98: %s&bslash;n&quot;
comma
id|errmsg
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
DECL|function|lp_old98_exit
r_static
r_void
id|__exit
id|lp_old98_exit
c_func
(paren
r_void
)paren
(brace
macro_line|#ifdef CONFIG_PC9800_OLDLP_CONSOLE
id|unregister_console
c_func
(paren
op_amp
id|lp_old98_console
)paren
suffix:semicolon
macro_line|#endif
id|unregister_chrdev
c_func
(paren
id|LP_MAJOR
comma
l_string|&quot;lp&quot;
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|LP_PORT_DATA
comma
l_int|1
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|LP_PORT_STATUS
comma
l_int|1
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|LP_PORT_STROBE
comma
l_int|1
)paren
suffix:semicolon
macro_line|#ifdef&t;PC98_HW_H98
r_if
c_cond
(paren
id|pc98_hw_flags
op_amp
id|PC98_HW_H98
)paren
id|release_region
c_func
(paren
id|LP_PORT_H98MODE
comma
l_int|1
)paren
suffix:semicolon
macro_line|#endif
id|release_region
c_func
(paren
id|LP_PORT_EXTMODE
comma
l_int|1
)paren
suffix:semicolon
)brace
macro_line|#ifndef MODULE
DECL|function|lp_old98_setup
r_static
r_int
id|__init
id|lp_old98_setup
c_func
(paren
r_char
op_star
id|str
)paren
(brace
r_int
id|ints
(braket
l_int|4
)braket
suffix:semicolon
id|str
op_assign
id|get_options
c_func
(paren
id|str
comma
id|ARRAY_SIZE
c_func
(paren
id|ints
)paren
comma
id|ints
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ints
(braket
l_int|0
)braket
OG
l_int|0
)paren
id|dc1_check
op_assign
id|ints
(braket
l_int|1
)braket
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|__setup
c_func
(paren
l_string|&quot;lp_old98_dc1_check=&quot;
comma
id|lp_old98_setup
)paren
suffix:semicolon
macro_line|#endif
id|MODULE_PARM
c_func
(paren
id|dc1_check
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Kousuke Takai &lt;tak@kmc.kyoto-u.ac.jp&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;PC-9800 old printer port driver&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
DECL|variable|lp_old98_init
id|module_init
c_func
(paren
id|lp_old98_init
)paren
suffix:semicolon
DECL|variable|lp_old98_exit
id|module_exit
c_func
(paren
id|lp_old98_exit
)paren
suffix:semicolon
eof
