multiline_comment|/* drivers/char/ser_a2232.c */
multiline_comment|/* $Id: ser_a2232.c,v 0.4 2000/01/25 12:00:00 ehaase Exp $ */
multiline_comment|/* Linux serial driver for the Amiga A2232 board */
multiline_comment|/* This driver is MAINTAINED. Before applying any changes, please contact&n; * the author.&n; */
multiline_comment|/* Copyright (c) 2000-2001 Enver Haase    &lt;ehaase@inf.fu-berlin.de&gt;&n; *                   alias The A2232 driver project &lt;A2232@gmx.net&gt;&n; * All rights reserved.&n; *&n; *   This program is free software; you can redistribute it and/or modify&n; *   it under the terms of the GNU General Public License as published by&n; *   the Free Software Foundation; either version 2 of the License, or&n; *   (at your option) any later version.&n; *&n; *   This program is distributed in the hope that it will be useful,&n; *   but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *   GNU General Public License for more details.&n; *&n; *   You should have received a copy of the GNU General Public License&n; *   along with this program; if not, write to the Free Software&n; *   Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; */
multiline_comment|/***************************** Documentation ************************/
multiline_comment|/*&n; * This driver is in EXPERIMENTAL state. That means I could not find&n; * someone with five A2232 boards with 35 ports running at 19200 bps&n; * at the same time and test the machine&squot;s behaviour.&n; * However, I know that you can performance-tweak this driver (see&n; * the source code).&n; * One thing to consider is the time this driver consumes during the&n; * Amiga&squot;s vertical blank interrupt. Everything that is to be done&n; * _IS DONE_ when entering the vertical blank interrupt handler of&n; * this driver.&n; * However, it would be more sane to only do the job for only ONE card&n; * instead of ALL cards at a time; or, more generally, to handle only&n; * SOME ports instead of ALL ports at a time.&n; * However, as long as no-one runs into problems I guess I shouldn&squot;t&n; * change the driver as it runs fine for me :) .&n; *&n; * Version history of this file:&n; * 0.4&t;Resolved licensing issues.&n; * 0.3&t;Inclusion in the Linux/m68k tree, small fixes.&n; * 0.2&t;Added documentation, minor typo fixes.&n; * 0.1&t;Initial release.&n; *&n; * TO DO:&n; * -&t;Handle incoming BREAK events. I guess &quot;Stevens: Advanced&n; *&t;Programming in the UNIX(R) Environment&quot; is a good reference&n; *&t;on what is to be done.&n; * -&t;When installing as a module, don&squot;t simply &squot;printk&squot; text, but&n; *&t;send it to the TTY used by the user.&n; *&n; * THANKS TO:&n; * -&t;Jukka Marin (65EC02 code).&n; * -&t;The other NetBSD developers on whose A2232 driver I had a&n; *&t;pretty close look. However, I didn&squot;t copy any code so it&n; *&t;is okay to put my code under the GPL and include it into&n; *&t;Linux.&n; */
multiline_comment|/***************************** End of Documentation *****************/
multiline_comment|/***************************** Defines ******************************/
multiline_comment|/*&n; * Enables experimental 115200 (normal) 230400 (turbo) baud rate.&n; * The A2232 specification states it can only operate at speeds up to&n; * 19200 bits per second, and I was not able to send a file via&n; * &quot;sz&quot;/&quot;rz&quot; and a null-modem cable from one A2232 port to another&n; * at 115200 bits per second.&n; * However, this might work for you.&n; */
DECL|macro|A2232_SPEEDHACK
macro_line|#undef A2232_SPEEDHACK
multiline_comment|/*&n; * Default is not to use RTS/CTS so you could be talked to death.&n; */
DECL|macro|A2232_SUPPRESS_RTSCTS_WARNING
mdefine_line|#define A2232_SUPPRESS_RTSCTS_WARNING
multiline_comment|/************************* End of Defines ***************************/
multiline_comment|/***************************** Includes *****************************/
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;asm/setup.h&gt;
macro_line|#include &lt;asm/amigaints.h&gt;
macro_line|#include &lt;asm/amigahw.h&gt;
macro_line|#include &lt;linux/zorro.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/semaphore.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/serial.h&gt;
macro_line|#include &lt;linux/generic_serial.h&gt;
macro_line|#include &quot;ser_a2232.h&quot;
macro_line|#include &quot;ser_a2232fw.h&quot;
multiline_comment|/************************* End of Includes **************************/
multiline_comment|/***************************** Prototypes ***************************/
multiline_comment|/* Helper functions */
r_static
id|__inline__
r_volatile
r_struct
id|a2232status
op_star
id|a2232stat
c_func
(paren
r_int
r_int
id|board
comma
r_int
r_int
id|portonboard
)paren
suffix:semicolon
r_static
id|__inline__
r_volatile
r_struct
id|a2232memory
op_star
id|a2232mem
(paren
r_int
r_int
id|board
)paren
suffix:semicolon
r_static
id|__inline__
r_void
id|a2232_receive_char
c_func
(paren
r_struct
id|a2232_port
op_star
id|port
comma
r_int
id|ch
comma
r_int
id|err
)paren
suffix:semicolon
multiline_comment|/* The interrupt service routine */
r_static
r_void
id|a2232_vbl_inter
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|data
comma
r_struct
id|pt_regs
op_star
id|fp
)paren
suffix:semicolon
multiline_comment|/* Initialize the port structures */
r_static
r_void
id|a2232_init_portstructs
c_func
(paren
r_void
)paren
suffix:semicolon
multiline_comment|/* Initialize and register TTY drivers. */
multiline_comment|/* returns 0 IFF successful */
r_static
r_int
id|a2232_init_drivers
c_func
(paren
r_void
)paren
suffix:semicolon
multiline_comment|/* Initialize all A2232 boards; main entry point. */
r_int
id|a2232board_init
c_func
(paren
r_void
)paren
suffix:semicolon
multiline_comment|/* BEGIN GENERIC_SERIAL PROTOTYPES */
r_static
r_void
id|a2232_disable_tx_interrupts
c_func
(paren
r_void
op_star
id|ptr
)paren
suffix:semicolon
r_static
r_void
id|a2232_enable_tx_interrupts
c_func
(paren
r_void
op_star
id|ptr
)paren
suffix:semicolon
r_static
r_void
id|a2232_disable_rx_interrupts
c_func
(paren
r_void
op_star
id|ptr
)paren
suffix:semicolon
r_static
r_void
id|a2232_enable_rx_interrupts
c_func
(paren
r_void
op_star
id|ptr
)paren
suffix:semicolon
r_static
r_int
id|a2232_get_CD
c_func
(paren
r_void
op_star
id|ptr
)paren
suffix:semicolon
r_static
r_void
id|a2232_shutdown_port
c_func
(paren
r_void
op_star
id|ptr
)paren
suffix:semicolon
r_static
r_int
id|a2232_set_real_termios
c_func
(paren
r_void
op_star
id|ptr
)paren
suffix:semicolon
r_static
r_int
id|a2232_chars_in_buffer
c_func
(paren
r_void
op_star
id|ptr
)paren
suffix:semicolon
r_static
r_void
id|a2232_close
c_func
(paren
r_void
op_star
id|ptr
)paren
suffix:semicolon
r_static
r_void
id|a2232_hungup
c_func
(paren
r_void
op_star
id|ptr
)paren
suffix:semicolon
multiline_comment|/* static void a2232_getserial (void *ptr, struct serial_struct *sp); */
multiline_comment|/* END GENERIC_SERIAL PROTOTYPES */
multiline_comment|/* Functions that the TTY driver struct expects */
r_static
r_int
id|a2232_ioctl
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
suffix:semicolon
r_static
r_void
id|a2232_throttle
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
suffix:semicolon
r_static
r_void
id|a2232_unthrottle
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
suffix:semicolon
r_static
r_int
id|a2232_open
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|filp
)paren
suffix:semicolon
multiline_comment|/************************* End of Prototypes ************************/
multiline_comment|/***************************** Global variables *********************/
multiline_comment|/*---------------------------------------------------------------------------&n; * Interface from generic_serial.c back here&n; *--------------------------------------------------------------------------*/
DECL|variable|a2232_real_driver
r_static
r_struct
id|real_driver
id|a2232_real_driver
op_assign
(brace
id|a2232_disable_tx_interrupts
comma
id|a2232_enable_tx_interrupts
comma
id|a2232_disable_rx_interrupts
comma
id|a2232_enable_rx_interrupts
comma
id|a2232_get_CD
comma
id|a2232_shutdown_port
comma
id|a2232_set_real_termios
comma
id|a2232_chars_in_buffer
comma
id|a2232_close
comma
id|a2232_hungup
comma
l_int|NULL
multiline_comment|/* a2232_getserial */
)brace
suffix:semicolon
DECL|variable|a2232_driver_ID
r_static
r_void
op_star
id|a2232_driver_ID
op_assign
op_amp
id|a2232_driver_ID
suffix:semicolon
singleline_comment|// Some memory address WE own.
multiline_comment|/* Ports structs */
DECL|variable|a2232_ports
r_static
r_struct
id|a2232_port
id|a2232_ports
(braket
id|MAX_A2232_BOARDS
op_star
id|NUMLINES
)braket
suffix:semicolon
multiline_comment|/* TTY driver structs */
DECL|variable|a2232_driver
r_static
r_struct
id|tty_driver
id|a2232_driver
suffix:semicolon
DECL|variable|a2232_callout_driver
r_static
r_struct
id|tty_driver
id|a2232_callout_driver
suffix:semicolon
multiline_comment|/* Variables used by the TTY driver */
DECL|variable|a2232_refcount
r_static
r_int
id|a2232_refcount
suffix:semicolon
DECL|variable|a2232_table
r_static
r_struct
id|tty_struct
op_star
id|a2232_table
(braket
id|MAX_A2232_BOARDS
op_star
id|NUMLINES
)braket
op_assign
(brace
l_int|NULL
comma
)brace
suffix:semicolon
DECL|variable|a2232_termios
r_static
r_struct
id|termios
op_star
id|a2232_termios
(braket
id|MAX_A2232_BOARDS
op_star
id|NUMLINES
)braket
suffix:semicolon
DECL|variable|a2232_termios_locked
r_static
r_struct
id|termios
op_star
id|a2232_termios_locked
(braket
id|MAX_A2232_BOARDS
op_star
id|NUMLINES
)braket
suffix:semicolon
multiline_comment|/* nr of cards completely (all ports) and correctly configured */
DECL|variable|nr_a2232
r_static
r_int
id|nr_a2232
suffix:semicolon
multiline_comment|/* zorro_dev structs for the A2232&squot;s */
DECL|variable|zd_a2232
r_static
r_struct
id|zorro_dev
op_star
id|zd_a2232
(braket
id|MAX_A2232_BOARDS
)braket
suffix:semicolon
multiline_comment|/***************************** End of Global variables **************/
multiline_comment|/***************************** Functions ****************************/
multiline_comment|/*** BEGIN OF REAL_DRIVER FUNCTIONS ***/
DECL|function|a2232_disable_tx_interrupts
r_static
r_void
id|a2232_disable_tx_interrupts
c_func
(paren
r_void
op_star
id|ptr
)paren
(brace
r_struct
id|a2232_port
op_star
id|port
suffix:semicolon
r_volatile
r_struct
id|a2232status
op_star
id|stat
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|port
op_assign
id|ptr
suffix:semicolon
id|stat
op_assign
id|a2232stat
c_func
(paren
id|port-&gt;which_a2232
comma
id|port-&gt;which_port_on_a2232
)paren
suffix:semicolon
id|stat-&gt;OutDisable
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Does this here really have to be? */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|port-&gt;gs.flags
op_and_assign
op_complement
id|GS_TX_INTEN
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|a2232_enable_tx_interrupts
r_static
r_void
id|a2232_enable_tx_interrupts
c_func
(paren
r_void
op_star
id|ptr
)paren
(brace
r_struct
id|a2232_port
op_star
id|port
suffix:semicolon
r_volatile
r_struct
id|a2232status
op_star
id|stat
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|port
op_assign
id|ptr
suffix:semicolon
id|stat
op_assign
id|a2232stat
c_func
(paren
id|port-&gt;which_a2232
comma
id|port-&gt;which_port_on_a2232
)paren
suffix:semicolon
id|stat-&gt;OutDisable
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Does this here really have to be? */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|port-&gt;gs.flags
op_or_assign
id|GS_TX_INTEN
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|a2232_disable_rx_interrupts
r_static
r_void
id|a2232_disable_rx_interrupts
c_func
(paren
r_void
op_star
id|ptr
)paren
(brace
r_struct
id|a2232_port
op_star
id|port
suffix:semicolon
id|port
op_assign
id|ptr
suffix:semicolon
id|port-&gt;disable_rx
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
DECL|function|a2232_enable_rx_interrupts
r_static
r_void
id|a2232_enable_rx_interrupts
c_func
(paren
r_void
op_star
id|ptr
)paren
(brace
r_struct
id|a2232_port
op_star
id|port
suffix:semicolon
id|port
op_assign
id|ptr
suffix:semicolon
id|port-&gt;disable_rx
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|a2232_get_CD
r_static
r_int
id|a2232_get_CD
c_func
(paren
r_void
op_star
id|ptr
)paren
(brace
r_return
(paren
(paren
r_struct
id|a2232_port
op_star
)paren
id|ptr
)paren
op_member_access_from_pointer
id|cd_status
suffix:semicolon
)brace
DECL|function|a2232_shutdown_port
r_static
r_void
id|a2232_shutdown_port
c_func
(paren
r_void
op_star
id|ptr
)paren
(brace
r_struct
id|a2232_port
op_star
id|port
suffix:semicolon
r_volatile
r_struct
id|a2232status
op_star
id|stat
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|port
op_assign
id|ptr
suffix:semicolon
id|stat
op_assign
id|a2232stat
c_func
(paren
id|port-&gt;which_a2232
comma
id|port-&gt;which_port_on_a2232
)paren
suffix:semicolon
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|port-&gt;gs.flags
op_and_assign
op_complement
id|GS_ACTIVE
suffix:semicolon
r_if
c_cond
(paren
id|port-&gt;gs.tty
op_logical_and
id|port-&gt;gs.tty-&gt;termios-&gt;c_cflag
op_amp
id|HUPCL
)paren
(brace
multiline_comment|/* Set DTR and RTS to Low, flush output.&n;&t;&t;   The NetBSD driver &quot;msc.c&quot; does it this way. */
id|stat-&gt;Command
op_assign
(paren
(paren
id|stat-&gt;Command
op_amp
op_complement
id|A2232CMD_CMask
)paren
op_or
id|A2232CMD_Close
)paren
suffix:semicolon
id|stat-&gt;OutFlush
op_assign
op_minus
l_int|1
suffix:semicolon
id|stat-&gt;Setup
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/* After analyzing control flow, I think a2232_shutdown_port&n;&t;&t;is actually the last call from the system when at application&n;&t;&t;level someone issues a &quot;echo Hello &gt;&gt;/dev/ttyY0&quot;.&n;&t;&t;Therefore I think the MOD_DEC_USE_COUNT should be here and&n;&t;&t;not in &quot;a2232_close()&quot;. See the comment in &quot;sx.c&quot;, too.&n;&t;&t;If you run into problems, compile this driver into the&n;&t;&t;kernel instead of compiling it as a module. */
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
DECL|function|a2232_set_real_termios
r_static
r_int
id|a2232_set_real_termios
c_func
(paren
r_void
op_star
id|ptr
)paren
(brace
r_int
r_int
id|cflag
comma
id|baud
comma
id|chsize
comma
id|stopb
comma
id|parity
comma
id|softflow
suffix:semicolon
r_int
id|rate
suffix:semicolon
r_int
id|a2232_param
comma
id|a2232_cmd
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|i
suffix:semicolon
r_struct
id|a2232_port
op_star
id|port
op_assign
id|ptr
suffix:semicolon
r_volatile
r_struct
id|a2232status
op_star
id|status
suffix:semicolon
r_volatile
r_struct
id|a2232memory
op_star
id|mem
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|port-&gt;gs.tty
op_logical_or
op_logical_neg
id|port-&gt;gs.tty-&gt;termios
)paren
r_return
l_int|0
suffix:semicolon
id|status
op_assign
id|a2232stat
c_func
(paren
id|port-&gt;which_a2232
comma
id|port-&gt;which_port_on_a2232
)paren
suffix:semicolon
id|mem
op_assign
id|a2232mem
c_func
(paren
id|port-&gt;which_a2232
)paren
suffix:semicolon
id|a2232_param
op_assign
id|a2232_cmd
op_assign
l_int|0
suffix:semicolon
singleline_comment|// get baud rate
id|baud
op_assign
id|port-&gt;gs.baud
suffix:semicolon
r_if
c_cond
(paren
id|baud
op_eq
l_int|0
)paren
(brace
multiline_comment|/* speed == 0 -&gt; drop DTR, do nothing else */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
singleline_comment|// Clear DTR (and RTS... mhhh).
id|status-&gt;Command
op_assign
(paren
(paren
id|status-&gt;Command
op_amp
op_complement
id|A2232CMD_CMask
)paren
op_or
id|A2232CMD_Close
)paren
suffix:semicolon
id|status-&gt;OutFlush
op_assign
op_minus
l_int|1
suffix:semicolon
id|status-&gt;Setup
op_assign
op_minus
l_int|1
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|rate
op_assign
id|A2232_BAUD_TABLE_NOAVAIL
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|A2232_BAUD_TABLE_NUM_RATES
op_star
l_int|3
suffix:semicolon
id|i
op_add_assign
l_int|3
)paren
(brace
r_if
c_cond
(paren
id|a2232_baud_table
(braket
id|i
)braket
op_eq
id|baud
)paren
(brace
r_if
c_cond
(paren
id|mem-&gt;Common.Crystal
op_eq
id|A2232_TURBO
)paren
id|rate
op_assign
id|a2232_baud_table
(braket
id|i
op_plus
l_int|2
)braket
suffix:semicolon
r_else
id|rate
op_assign
id|a2232_baud_table
(braket
id|i
op_plus
l_int|1
)braket
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|rate
op_eq
id|A2232_BAUD_TABLE_NOAVAIL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;a2232: Board %d Port %d unsupported baud rate: %d baud. Using another.&bslash;n&quot;
comma
id|port-&gt;which_a2232
comma
id|port-&gt;which_port_on_a2232
comma
id|baud
)paren
suffix:semicolon
singleline_comment|// This is useful for both (turbo or normal) Crystal versions.
id|rate
op_assign
id|A2232PARAM_B9600
suffix:semicolon
)brace
id|a2232_param
op_or_assign
id|rate
suffix:semicolon
id|cflag
op_assign
id|port-&gt;gs.tty-&gt;termios-&gt;c_cflag
suffix:semicolon
singleline_comment|// get character size
id|chsize
op_assign
id|cflag
op_amp
id|CSIZE
suffix:semicolon
r_switch
c_cond
(paren
id|chsize
)paren
(brace
r_case
id|CS8
suffix:colon
id|a2232_param
op_or_assign
id|A2232PARAM_8Bit
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS7
suffix:colon
id|a2232_param
op_or_assign
id|A2232PARAM_7Bit
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS6
suffix:colon
id|a2232_param
op_or_assign
id|A2232PARAM_6Bit
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS5
suffix:colon
id|a2232_param
op_or_assign
id|A2232PARAM_5Bit
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;a2232: Board %d Port %d unsupported character size: %d. Using 8 data bits.&bslash;n&quot;
comma
id|port-&gt;which_a2232
comma
id|port-&gt;which_port_on_a2232
comma
id|chsize
)paren
suffix:semicolon
id|a2232_param
op_or_assign
id|A2232PARAM_8Bit
suffix:semicolon
r_break
suffix:semicolon
)brace
singleline_comment|// get number of stop bits
id|stopb
op_assign
id|cflag
op_amp
id|CSTOPB
suffix:semicolon
r_if
c_cond
(paren
id|stopb
)paren
(brace
singleline_comment|// two stop bits instead of one
id|printk
c_func
(paren
l_string|&quot;a2232: Board %d Port %d 2 stop bits unsupported. Using 1 stop bit.&bslash;n&quot;
comma
id|port-&gt;which_a2232
comma
id|port-&gt;which_port_on_a2232
)paren
suffix:semicolon
)brace
singleline_comment|// Warn if RTS/CTS not wanted
r_if
c_cond
(paren
op_logical_neg
(paren
id|cflag
op_amp
id|CRTSCTS
)paren
)paren
(brace
macro_line|#ifndef A2232_SUPPRESS_RTSCTS_WARNING
id|printk
c_func
(paren
l_string|&quot;a2232: Board %d Port %d cannot switch off firmware-implemented RTS/CTS hardware flow control.&bslash;n&quot;
comma
id|port-&gt;which_a2232
comma
id|port-&gt;which_port_on_a2232
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*&t;I think this is correct.&n;&t;&t;However, IXOFF means _input_ flow control and I wonder&n;&t;&t;if one should care about IXON _output_ flow control,&n;&t;&t;too. If this makes problems, one should turn the A2232&n;&t;&t;firmware XON/XOFF &quot;SoftFlow&quot; flow control off and use&n;&t;&t;the conventional way of inserting START/STOP characters&n;&t;&t;by hand in throttle()/unthrottle().&n;&t;*/
id|softflow
op_assign
op_logical_neg
op_logical_neg
(paren
id|port-&gt;gs.tty-&gt;termios-&gt;c_iflag
op_amp
id|IXOFF
)paren
suffix:semicolon
singleline_comment|// get Parity (Enabled/Disabled? If Enabled, Odd or Even?)
id|parity
op_assign
id|cflag
op_amp
(paren
id|PARENB
op_or
id|PARODD
)paren
suffix:semicolon
r_if
c_cond
(paren
id|parity
op_amp
id|PARENB
)paren
(brace
r_if
c_cond
(paren
id|parity
op_amp
id|PARODD
)paren
(brace
id|a2232_cmd
op_or_assign
id|A2232CMD_OddParity
suffix:semicolon
)brace
r_else
(brace
id|a2232_cmd
op_or_assign
id|A2232CMD_EvenParity
suffix:semicolon
)brace
)brace
r_else
id|a2232_cmd
op_or_assign
id|A2232CMD_NoParity
suffix:semicolon
multiline_comment|/*&t;Hmm. Maybe an own a2232_port structure&n;&t;&t;member would be cleaner?&t;*/
r_if
c_cond
(paren
id|cflag
op_amp
id|CLOCAL
)paren
id|port-&gt;gs.flags
op_and_assign
op_complement
id|ASYNC_CHECK_CD
suffix:semicolon
r_else
id|port-&gt;gs.flags
op_or_assign
id|ASYNC_CHECK_CD
suffix:semicolon
multiline_comment|/* Now we have all parameters and can go to set them: */
id|save_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
id|cli
c_func
(paren
)paren
suffix:semicolon
id|status-&gt;Param
op_assign
id|a2232_param
op_or
id|A2232PARAM_RcvBaud
suffix:semicolon
id|status-&gt;Command
op_assign
id|a2232_cmd
op_or
id|A2232CMD_Open
op_or
id|A2232CMD_Enable
suffix:semicolon
id|status-&gt;SoftFlow
op_assign
id|softflow
suffix:semicolon
id|status-&gt;OutDisable
op_assign
l_int|0
suffix:semicolon
id|status-&gt;Setup
op_assign
op_minus
l_int|1
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|a2232_chars_in_buffer
r_static
r_int
id|a2232_chars_in_buffer
c_func
(paren
r_void
op_star
id|ptr
)paren
(brace
r_struct
id|a2232_port
op_star
id|port
suffix:semicolon
r_volatile
r_struct
id|a2232status
op_star
id|status
suffix:semicolon
r_int
r_char
id|ret
suffix:semicolon
multiline_comment|/* we need modulo-256 arithmetics */
id|port
op_assign
id|ptr
suffix:semicolon
id|status
op_assign
id|a2232stat
c_func
(paren
id|port-&gt;which_a2232
comma
id|port-&gt;which_port_on_a2232
)paren
suffix:semicolon
macro_line|#if A2232_IOBUFLEN != 256
macro_line|#error &quot;Re-Implement a2232_chars_in_buffer()!&quot;
macro_line|#endif
id|ret
op_assign
(paren
id|status-&gt;OutHead
op_minus
id|status-&gt;OutTail
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|a2232_close
r_static
r_void
id|a2232_close
c_func
(paren
r_void
op_star
id|ptr
)paren
(brace
id|a2232_disable_tx_interrupts
c_func
(paren
id|ptr
)paren
suffix:semicolon
id|a2232_disable_rx_interrupts
c_func
(paren
id|ptr
)paren
suffix:semicolon
multiline_comment|/* see the comment in a2232_shutdown_port above. */
multiline_comment|/* MOD_DEC_USE_COUNT; */
)brace
DECL|function|a2232_hungup
r_static
r_void
id|a2232_hungup
c_func
(paren
r_void
op_star
id|ptr
)paren
(brace
id|a2232_close
c_func
(paren
id|ptr
)paren
suffix:semicolon
)brace
multiline_comment|/*** END   OF REAL_DRIVER FUNCTIONS ***/
multiline_comment|/*** BEGIN  FUNCTIONS EXPECTED BY TTY DRIVER STRUCTS ***/
DECL|function|a2232_ioctl
r_static
r_int
id|a2232_ioctl
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
)brace
DECL|function|a2232_throttle
r_static
r_void
id|a2232_throttle
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
multiline_comment|/* Throttle: System cannot take another chars: Drop RTS or&n;             send the STOP char or whatever.&n;   The A2232 firmware does RTS/CTS anyway, and XON/XOFF&n;   if switched on. So the only thing we can do at this&n;   layer here is not taking any characters out of the&n;   A2232 buffer any more. */
r_struct
id|a2232_port
op_star
id|port
op_assign
(paren
r_struct
id|a2232_port
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
id|port-&gt;throttle_input
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
DECL|function|a2232_unthrottle
r_static
r_void
id|a2232_unthrottle
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
multiline_comment|/* Unthrottle: dual to &quot;throttle()&quot; above. */
r_struct
id|a2232_port
op_star
id|port
op_assign
(paren
r_struct
id|a2232_port
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
id|port-&gt;throttle_input
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|a2232_open
r_static
r_int
id|a2232_open
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
multiline_comment|/* More or less stolen from other drivers. */
r_int
id|line
suffix:semicolon
r_int
id|retval
suffix:semicolon
r_struct
id|a2232_port
op_star
id|port
suffix:semicolon
id|line
op_assign
id|MINOR
c_func
(paren
id|tty-&gt;device
)paren
suffix:semicolon
id|port
op_assign
op_amp
id|a2232_ports
(braket
id|line
)braket
suffix:semicolon
id|tty-&gt;driver_data
op_assign
id|port
suffix:semicolon
id|port-&gt;gs.tty
op_assign
id|tty
suffix:semicolon
id|port-&gt;gs.count
op_increment
suffix:semicolon
id|retval
op_assign
id|gs_init_port
c_func
(paren
op_amp
id|port-&gt;gs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|port-&gt;gs.count
op_decrement
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
id|port-&gt;gs.flags
op_or_assign
id|GS_ACTIVE
suffix:semicolon
r_if
c_cond
(paren
id|port-&gt;gs.count
op_eq
l_int|1
)paren
(brace
id|MOD_INC_USE_COUNT
suffix:semicolon
)brace
id|retval
op_assign
id|gs_block_til_ready
c_func
(paren
id|port
comma
id|filp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
id|port-&gt;gs.count
op_decrement
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|port-&gt;gs.count
op_eq
l_int|1
)paren
op_logical_and
(paren
id|port-&gt;gs.flags
op_amp
id|ASYNC_SPLIT_TERMIOS
)paren
)paren
(brace
r_if
c_cond
(paren
id|tty-&gt;driver.subtype
op_eq
id|A2232_TTY_SUBTYPE_NORMAL
)paren
op_star
id|tty-&gt;termios
op_assign
id|port-&gt;gs.normal_termios
suffix:semicolon
r_else
op_star
id|tty-&gt;termios
op_assign
id|port-&gt;gs.callout_termios
suffix:semicolon
id|a2232_set_real_termios
(paren
id|port
)paren
suffix:semicolon
)brace
id|port-&gt;gs.session
op_assign
id|current-&gt;session
suffix:semicolon
id|port-&gt;gs.pgrp
op_assign
id|current-&gt;pgrp
suffix:semicolon
id|a2232_enable_rx_interrupts
c_func
(paren
id|port
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*** END OF FUNCTIONS EXPECTED BY TTY DRIVER STRUCTS ***/
DECL|function|a2232stat
r_static
id|__inline__
r_volatile
r_struct
id|a2232status
op_star
id|a2232stat
c_func
(paren
r_int
r_int
id|board
comma
r_int
r_int
id|portonboard
)paren
(brace
r_volatile
r_struct
id|a2232memory
op_star
id|mem
op_assign
id|a2232mem
c_func
(paren
id|board
)paren
suffix:semicolon
r_return
op_amp
(paren
id|mem-&gt;Status
(braket
id|portonboard
)braket
)paren
suffix:semicolon
)brace
DECL|function|a2232mem
r_static
id|__inline__
r_volatile
r_struct
id|a2232memory
op_star
id|a2232mem
(paren
r_int
r_int
id|board
)paren
(brace
r_return
(paren
r_volatile
r_struct
id|a2232memory
op_star
)paren
id|ZTWO_VADDR
c_func
(paren
id|zd_a2232
(braket
id|board
)braket
op_member_access_from_pointer
id|resource.start
)paren
suffix:semicolon
)brace
DECL|function|a2232_receive_char
r_static
id|__inline__
r_void
id|a2232_receive_char
c_func
(paren
r_struct
id|a2232_port
op_star
id|port
comma
r_int
id|ch
comma
r_int
id|err
)paren
(brace
multiline_comment|/* &t;Mostly stolen from other drivers.&n;&t;Maybe one could implement a more efficient version by not only&n;&t;transferring one character at a time.&n;*/
r_struct
id|tty_struct
op_star
id|tty
op_assign
id|port-&gt;gs.tty
suffix:semicolon
r_if
c_cond
(paren
id|tty-&gt;flip.count
op_ge
id|TTY_FLIPBUF_SIZE
)paren
r_return
suffix:semicolon
id|tty-&gt;flip.count
op_increment
suffix:semicolon
macro_line|#if 0
r_switch
c_cond
(paren
id|err
)paren
(brace
r_case
id|TTY_BREAK
suffix:colon
r_break
suffix:semicolon
r_case
id|TTY_PARITY
suffix:colon
r_break
suffix:semicolon
r_case
id|TTY_OVERRUN
suffix:colon
r_break
suffix:semicolon
r_case
id|TTY_FRAME
suffix:colon
r_break
suffix:semicolon
)brace
macro_line|#endif
op_star
id|tty-&gt;flip.flag_buf_ptr
op_increment
op_assign
id|err
suffix:semicolon
op_star
id|tty-&gt;flip.char_buf_ptr
op_increment
op_assign
id|ch
suffix:semicolon
id|tty_flip_buffer_push
c_func
(paren
id|tty
)paren
suffix:semicolon
)brace
DECL|function|a2232_vbl_inter
r_static
r_void
id|a2232_vbl_inter
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|data
comma
r_struct
id|pt_regs
op_star
id|fp
)paren
(brace
macro_line|#if A2232_IOBUFLEN != 256
macro_line|#error &quot;Re-Implement a2232_vbl_inter()!&quot;
macro_line|#endif
r_struct
id|a2232_port
op_star
id|port
suffix:semicolon
r_volatile
r_struct
id|a2232memory
op_star
id|mem
suffix:semicolon
r_volatile
r_struct
id|a2232status
op_star
id|status
suffix:semicolon
r_int
r_char
id|newhead
suffix:semicolon
r_int
r_char
id|bufpos
suffix:semicolon
multiline_comment|/* Must be unsigned char. We need the modulo-256 arithmetics */
r_int
r_char
id|ncd
comma
id|ocd
comma
id|ccd
suffix:semicolon
multiline_comment|/* names consistent with the NetBSD driver */
r_volatile
id|u_char
op_star
id|ibuf
comma
op_star
id|cbuf
comma
op_star
id|obuf
suffix:semicolon
r_int
id|ch
comma
id|err
comma
id|n
comma
id|p
suffix:semicolon
r_for
c_loop
(paren
id|n
op_assign
l_int|0
suffix:semicolon
id|n
OL
id|nr_a2232
suffix:semicolon
id|n
op_increment
)paren
(brace
multiline_comment|/* for every completely initialized A2232 board */
id|mem
op_assign
id|a2232mem
c_func
(paren
id|n
)paren
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
l_int|0
suffix:semicolon
id|p
OL
id|NUMLINES
suffix:semicolon
id|p
op_increment
)paren
(brace
multiline_comment|/* for every port on this board */
id|err
op_assign
l_int|0
suffix:semicolon
id|port
op_assign
op_amp
id|a2232_ports
(braket
id|n
op_star
id|NUMLINES
op_plus
id|p
)braket
suffix:semicolon
r_if
c_cond
(paren
id|port-&gt;gs.flags
op_amp
id|GS_ACTIVE
)paren
(brace
multiline_comment|/* if the port is used */
id|status
op_assign
id|a2232stat
c_func
(paren
id|n
comma
id|p
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|port-&gt;disable_rx
op_logical_and
op_logical_neg
id|port-&gt;throttle_input
)paren
(brace
multiline_comment|/* If input is not disabled */
id|newhead
op_assign
id|status-&gt;InHead
suffix:semicolon
multiline_comment|/* 65EC02 write pointer */
id|bufpos
op_assign
id|status-&gt;InTail
suffix:semicolon
multiline_comment|/* check for input for this port */
r_if
c_cond
(paren
id|newhead
op_ne
id|bufpos
)paren
(brace
multiline_comment|/* buffer for input chars/events */
id|ibuf
op_assign
id|mem-&gt;InBuf
(braket
id|p
)braket
suffix:semicolon
multiline_comment|/* data types of bytes in ibuf */
id|cbuf
op_assign
id|mem-&gt;InCtl
(braket
id|p
)braket
suffix:semicolon
multiline_comment|/* do for all chars */
r_while
c_loop
(paren
id|bufpos
op_ne
id|newhead
)paren
(brace
multiline_comment|/* which type of input data? */
r_switch
c_cond
(paren
id|cbuf
(braket
id|bufpos
)braket
)paren
(brace
multiline_comment|/* switch on input event (CD, BREAK, etc.) */
r_case
id|A2232INCTL_EVENT
suffix:colon
r_switch
c_cond
(paren
id|ibuf
(braket
id|bufpos
op_increment
)braket
)paren
(brace
r_case
id|A2232EVENT_Break
suffix:colon
multiline_comment|/* TODO: Handle BREAK signal */
r_break
suffix:semicolon
multiline_comment|/*&t;A2232EVENT_CarrierOn and A2232EVENT_CarrierOff are&n;&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;handled in a separate queue and should not occur here. */
r_case
id|A2232EVENT_Sync
suffix:colon
id|printk
c_func
(paren
l_string|&quot;A2232: 65EC02 software sent SYNC event, don&squot;t know what to do. Ignoring.&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;A2232: 65EC02 software broken, unknown event type %d occured.&bslash;n&quot;
comma
id|ibuf
(braket
id|bufpos
op_minus
l_int|1
)braket
)paren
suffix:semicolon
)brace
multiline_comment|/* event type switch */
r_break
suffix:semicolon
r_case
id|A2232INCTL_CHAR
suffix:colon
multiline_comment|/* Receive incoming char */
id|a2232_receive_char
c_func
(paren
id|port
comma
id|ibuf
(braket
id|bufpos
)braket
comma
id|err
)paren
suffix:semicolon
id|bufpos
op_increment
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;A2232: 65EC02 software broken, unknown data type %d occured.&bslash;n&quot;
comma
id|cbuf
(braket
id|bufpos
)braket
)paren
suffix:semicolon
id|bufpos
op_increment
suffix:semicolon
)brace
multiline_comment|/* switch on input data type */
)brace
multiline_comment|/* while there&squot;s something in the buffer */
id|status-&gt;InTail
op_assign
id|bufpos
suffix:semicolon
multiline_comment|/* tell 65EC02 what we&squot;ve read */
)brace
multiline_comment|/* if there was something in the buffer */
)brace
multiline_comment|/* If input is not disabled */
multiline_comment|/* Now check if there&squot;s something to output */
id|obuf
op_assign
id|mem-&gt;OutBuf
(braket
id|p
)braket
suffix:semicolon
id|bufpos
op_assign
id|status-&gt;OutHead
suffix:semicolon
r_while
c_loop
(paren
(paren
id|port-&gt;gs.xmit_cnt
OG
l_int|0
)paren
op_logical_and
(paren
op_logical_neg
id|port-&gt;gs.tty-&gt;stopped
)paren
op_logical_and
(paren
op_logical_neg
id|port-&gt;gs.tty-&gt;hw_stopped
)paren
)paren
(brace
multiline_comment|/* While there are chars to transmit */
r_if
c_cond
(paren
(paren
(paren
id|bufpos
op_plus
l_int|1
)paren
op_amp
id|A2232_IOBUFLENMASK
)paren
op_ne
id|status-&gt;OutTail
)paren
(brace
multiline_comment|/* If the A2232 buffer is not full */
id|ch
op_assign
id|port-&gt;gs.xmit_buf
(braket
id|port-&gt;gs.xmit_tail
)braket
suffix:semicolon
multiline_comment|/* get the next char to transmit */
id|port-&gt;gs.xmit_tail
op_assign
(paren
id|port-&gt;gs.xmit_tail
op_plus
l_int|1
)paren
op_amp
(paren
id|SERIAL_XMIT_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* modulo-addition for the gs.xmit_buf ring-buffer */
id|obuf
(braket
id|bufpos
op_increment
)braket
op_assign
id|ch
suffix:semicolon
multiline_comment|/* put it into the A2232 buffer */
id|port-&gt;gs.xmit_cnt
op_decrement
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* If A2232 the buffer is full */
r_break
suffix:semicolon
multiline_comment|/* simply stop filling it. */
)brace
)brace
id|status-&gt;OutHead
op_assign
id|bufpos
suffix:semicolon
multiline_comment|/* WakeUp if output buffer runs low */
r_if
c_cond
(paren
(paren
id|port-&gt;gs.xmit_cnt
op_le
id|port-&gt;gs.wakeup_chars
)paren
op_logical_and
id|port-&gt;gs.tty
)paren
(brace
r_if
c_cond
(paren
(paren
id|port-&gt;gs.tty-&gt;flags
op_amp
(paren
l_int|1
op_lshift
id|TTY_DO_WRITE_WAKEUP
)paren
)paren
op_logical_and
id|port-&gt;gs.tty-&gt;ldisc.write_wakeup
)paren
(brace
(paren
id|port-&gt;gs.tty-&gt;ldisc.write_wakeup
)paren
(paren
id|port-&gt;gs.tty
)paren
suffix:semicolon
)brace
id|wake_up_interruptible
c_func
(paren
op_amp
id|port-&gt;gs.tty-&gt;write_wait
)paren
suffix:semicolon
)brace
)brace
singleline_comment|// if the port is used
)brace
singleline_comment|// for every port on the board
multiline_comment|/* Now check the CD message queue */
id|newhead
op_assign
id|mem-&gt;Common.CDHead
suffix:semicolon
id|bufpos
op_assign
id|mem-&gt;Common.CDTail
suffix:semicolon
r_if
c_cond
(paren
id|newhead
op_ne
id|bufpos
)paren
(brace
multiline_comment|/* There are CD events in queue */
id|ocd
op_assign
id|mem-&gt;Common.CDStatus
suffix:semicolon
multiline_comment|/* get old status bits */
r_while
c_loop
(paren
id|newhead
op_ne
id|bufpos
)paren
(brace
multiline_comment|/* read all events */
id|ncd
op_assign
id|mem-&gt;CDBuf
(braket
id|bufpos
op_increment
)braket
suffix:semicolon
multiline_comment|/* get one event */
id|ccd
op_assign
id|ncd
op_xor
id|ocd
suffix:semicolon
multiline_comment|/* mask of changed lines */
id|ocd
op_assign
id|ncd
suffix:semicolon
multiline_comment|/* save new status bits */
r_for
c_loop
(paren
id|p
op_assign
l_int|0
suffix:semicolon
id|p
OL
id|NUMLINES
suffix:semicolon
id|p
op_increment
)paren
(brace
multiline_comment|/* for all ports */
r_if
c_cond
(paren
id|ccd
op_amp
l_int|1
)paren
(brace
multiline_comment|/* this one changed */
r_struct
id|a2232_port
op_star
id|port
op_assign
op_amp
id|a2232_ports
(braket
id|n
op_star
l_int|7
op_plus
id|p
)braket
suffix:semicolon
id|port-&gt;cd_status
op_assign
op_logical_neg
(paren
id|ncd
op_amp
l_int|1
)paren
suffix:semicolon
multiline_comment|/* ncd&amp;1 &lt;=&gt; CD is now off */
r_if
c_cond
(paren
op_logical_neg
(paren
id|port-&gt;gs.flags
op_amp
id|ASYNC_CHECK_CD
)paren
)paren
suffix:semicolon
multiline_comment|/* Don&squot;t report DCD changes */
r_else
r_if
c_cond
(paren
id|port-&gt;cd_status
)paren
(brace
singleline_comment|// if DCD on: DCD went UP!
r_if
c_cond
(paren
op_complement
(paren
id|port-&gt;gs.flags
op_amp
id|ASYNC_NORMAL_ACTIVE
)paren
op_logical_or
op_complement
(paren
id|port-&gt;gs.flags
op_amp
id|ASYNC_CALLOUT_ACTIVE
)paren
)paren
(brace
multiline_comment|/* Are we blocking in open?*/
id|wake_up_interruptible
c_func
(paren
op_amp
id|port-&gt;gs.open_wait
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
singleline_comment|// if DCD off: DCD went DOWN!
r_if
c_cond
(paren
op_logical_neg
(paren
(paren
id|port-&gt;gs.flags
op_amp
id|ASYNC_CALLOUT_ACTIVE
)paren
op_logical_and
(paren
id|port-&gt;gs.flags
op_amp
id|ASYNC_CALLOUT_NOHUP
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|port-&gt;gs.tty
)paren
id|tty_hangup
(paren
id|port-&gt;gs.tty
)paren
suffix:semicolon
)brace
)brace
)brace
singleline_comment|// if CD changed for this port
id|ccd
op_rshift_assign
l_int|1
suffix:semicolon
id|ncd
op_rshift_assign
l_int|1
suffix:semicolon
multiline_comment|/* Shift bits for next line */
)brace
singleline_comment|// for every port
)brace
singleline_comment|// while CD events in queue
id|mem-&gt;Common.CDStatus
op_assign
id|ocd
suffix:semicolon
multiline_comment|/* save new status */
id|mem-&gt;Common.CDTail
op_assign
id|bufpos
suffix:semicolon
multiline_comment|/* remove events */
)brace
singleline_comment|// if events in CD queue
)brace
singleline_comment|// for every completely initialized A2232 board
)brace
DECL|function|a2232_init_portstructs
r_static
r_void
id|a2232_init_portstructs
c_func
(paren
r_void
)paren
(brace
r_struct
id|a2232_port
op_star
id|port
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_A2232_BOARDS
op_star
id|NUMLINES
suffix:semicolon
id|i
op_increment
)paren
(brace
id|port
op_assign
id|a2232_ports
op_plus
id|i
suffix:semicolon
id|port-&gt;which_a2232
op_assign
id|i
op_div
id|NUMLINES
suffix:semicolon
id|port-&gt;which_port_on_a2232
op_assign
id|i
op_mod
id|NUMLINES
suffix:semicolon
id|port-&gt;disable_rx
op_assign
id|port-&gt;throttle_input
op_assign
id|port-&gt;cd_status
op_assign
l_int|0
suffix:semicolon
id|port-&gt;gs.callout_termios
op_assign
id|tty_std_termios
suffix:semicolon
id|port-&gt;gs.normal_termios
op_assign
id|tty_std_termios
suffix:semicolon
id|port-&gt;gs.magic
op_assign
id|A2232_MAGIC
suffix:semicolon
id|port-&gt;gs.close_delay
op_assign
id|HZ
op_div
l_int|2
suffix:semicolon
id|port-&gt;gs.closing_wait
op_assign
l_int|30
op_star
id|HZ
suffix:semicolon
id|port-&gt;gs.rd
op_assign
op_amp
id|a2232_real_driver
suffix:semicolon
macro_line|#ifdef NEW_WRITE_LOCKING
id|init_MUTEX
c_func
(paren
op_amp
(paren
id|port-&gt;gs.port_write_sem
)paren
)paren
suffix:semicolon
macro_line|#endif
id|init_waitqueue_head
c_func
(paren
op_amp
id|port-&gt;gs.open_wait
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|port-&gt;gs.close_wait
)paren
suffix:semicolon
)brace
)brace
DECL|function|a2232_init_drivers
r_static
r_int
id|a2232_init_drivers
c_func
(paren
r_void
)paren
(brace
r_int
id|error
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|a2232_driver
comma
l_int|0
comma
r_sizeof
(paren
id|a2232_driver
)paren
)paren
suffix:semicolon
id|a2232_driver.magic
op_assign
id|TTY_DRIVER_MAGIC
suffix:semicolon
id|a2232_driver.driver_name
op_assign
l_string|&quot;commodore_a2232&quot;
suffix:semicolon
id|a2232_driver.name
op_assign
l_string|&quot;ttyY&quot;
suffix:semicolon
id|a2232_driver.major
op_assign
id|A2232_NORMAL_MAJOR
suffix:semicolon
id|a2232_driver.num
op_assign
id|NUMLINES
op_star
id|nr_a2232
suffix:semicolon
id|a2232_driver.type
op_assign
id|TTY_DRIVER_TYPE_SERIAL
suffix:semicolon
id|a2232_driver.subtype
op_assign
id|A2232_TTY_SUBTYPE_NORMAL
suffix:semicolon
id|a2232_driver.init_termios
op_assign
id|tty_std_termios
suffix:semicolon
id|a2232_driver.init_termios.c_cflag
op_assign
id|B9600
op_or
id|CS8
op_or
id|CREAD
op_or
id|HUPCL
op_or
id|CLOCAL
suffix:semicolon
id|a2232_driver.flags
op_assign
id|TTY_DRIVER_REAL_RAW
suffix:semicolon
id|a2232_driver.refcount
op_assign
op_amp
id|a2232_refcount
suffix:semicolon
id|a2232_driver.table
op_assign
id|a2232_table
suffix:semicolon
id|a2232_driver.termios
op_assign
id|a2232_termios
suffix:semicolon
id|a2232_driver.termios_locked
op_assign
id|a2232_termios_locked
suffix:semicolon
id|a2232_driver.open
op_assign
id|a2232_open
suffix:semicolon
id|a2232_driver.close
op_assign
id|gs_close
suffix:semicolon
id|a2232_driver.write
op_assign
id|gs_write
suffix:semicolon
id|a2232_driver.put_char
op_assign
id|gs_put_char
suffix:semicolon
id|a2232_driver.flush_chars
op_assign
id|gs_flush_chars
suffix:semicolon
id|a2232_driver.write_room
op_assign
id|gs_write_room
suffix:semicolon
id|a2232_driver.chars_in_buffer
op_assign
id|gs_chars_in_buffer
suffix:semicolon
id|a2232_driver.flush_buffer
op_assign
id|gs_flush_buffer
suffix:semicolon
id|a2232_driver.ioctl
op_assign
id|a2232_ioctl
suffix:semicolon
id|a2232_driver.throttle
op_assign
id|a2232_throttle
suffix:semicolon
id|a2232_driver.unthrottle
op_assign
id|a2232_unthrottle
suffix:semicolon
id|a2232_driver.set_termios
op_assign
id|gs_set_termios
suffix:semicolon
id|a2232_driver.stop
op_assign
id|gs_stop
suffix:semicolon
id|a2232_driver.start
op_assign
id|gs_start
suffix:semicolon
id|a2232_driver.hangup
op_assign
id|gs_hangup
suffix:semicolon
id|a2232_callout_driver
op_assign
id|a2232_driver
suffix:semicolon
id|a2232_callout_driver.name
op_assign
l_string|&quot;cuy&quot;
suffix:semicolon
id|a2232_callout_driver.major
op_assign
id|A2232_CALLOUT_MAJOR
suffix:semicolon
id|a2232_callout_driver.subtype
op_assign
id|A2232_TTY_SUBTYPE_CALLOUT
suffix:semicolon
r_if
c_cond
(paren
(paren
id|error
op_assign
id|tty_register_driver
c_func
(paren
op_amp
id|a2232_driver
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;A2232: Couldn&squot;t register A2232 driver, error = %d&bslash;n&quot;
comma
id|error
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|error
op_assign
id|tty_register_driver
c_func
(paren
op_amp
id|a2232_callout_driver
)paren
)paren
)paren
(brace
id|tty_unregister_driver
c_func
(paren
op_amp
id|a2232_driver
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;A2232: Couldn&squot;t register A2232 callout driver, error = %d&bslash;n&quot;
comma
id|error
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|a2232board_init
r_int
id|a2232board_init
c_func
(paren
r_void
)paren
(brace
r_struct
id|zorro_dev
op_star
id|z
suffix:semicolon
r_int
r_int
id|boardaddr
suffix:semicolon
r_int
id|bcount
suffix:semicolon
r_int
id|start
suffix:semicolon
id|u_char
op_star
id|from
suffix:semicolon
r_volatile
id|u_char
op_star
id|to
suffix:semicolon
r_volatile
r_struct
id|a2232memory
op_star
id|mem
suffix:semicolon
macro_line|#ifdef __SMP__
r_return
op_minus
id|ENODEV
suffix:semicolon
multiline_comment|/* This driver is not SMP aware. Is there an SMP ZorroII-bus-machine? */
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|MACH_IS_AMIGA
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;Commodore A2232 driver initializing.&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Say that we&squot;re alive. */
id|z
op_assign
l_int|NULL
suffix:semicolon
id|nr_a2232
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
id|z
op_assign
id|zorro_find_device
c_func
(paren
id|ZORRO_WILDCARD
comma
id|z
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|z-&gt;id
op_ne
id|ZORRO_PROD_CBM_A2232_PROTOTYPE
)paren
op_logical_and
(paren
id|z-&gt;id
op_ne
id|ZORRO_PROD_CBM_A2232
)paren
)paren
(brace
r_continue
suffix:semicolon
singleline_comment|// The board found was no A2232
)brace
r_if
c_cond
(paren
op_logical_neg
id|zorro_request_device
c_func
(paren
id|z
comma
l_string|&quot;A2232 driver&quot;
)paren
)paren
r_continue
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Commodore A2232 found (#%d).&bslash;n&quot;
comma
id|nr_a2232
)paren
suffix:semicolon
id|zd_a2232
(braket
id|nr_a2232
)braket
op_assign
id|z
suffix:semicolon
id|boardaddr
op_assign
id|ZTWO_VADDR
c_func
(paren
id|z-&gt;resource.start
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Board is located at address 0x%x, size is 0x%x.&bslash;n&quot;
comma
id|boardaddr
comma
(paren
r_int
r_int
)paren
(paren
(paren
id|z-&gt;resource.end
op_plus
l_int|1
)paren
op_minus
(paren
id|z-&gt;resource.start
)paren
)paren
)paren
suffix:semicolon
id|mem
op_assign
(paren
r_volatile
r_struct
id|a2232memory
op_star
)paren
id|boardaddr
suffix:semicolon
(paren
r_void
)paren
id|mem-&gt;Enable6502Reset
suffix:semicolon
multiline_comment|/* copy the code across to the board */
id|to
op_assign
(paren
id|u_char
op_star
)paren
id|mem
suffix:semicolon
id|from
op_assign
id|a2232_65EC02code
suffix:semicolon
id|bcount
op_assign
r_sizeof
(paren
id|a2232_65EC02code
)paren
op_minus
l_int|2
suffix:semicolon
id|start
op_assign
op_star
(paren
r_int
op_star
)paren
id|from
suffix:semicolon
id|from
op_add_assign
r_sizeof
(paren
id|start
)paren
suffix:semicolon
id|to
op_add_assign
id|start
suffix:semicolon
r_while
c_loop
(paren
id|bcount
op_decrement
)paren
(brace
op_star
id|to
op_increment
op_assign
op_star
id|from
op_increment
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;65EC02 software uploaded to the A2232 memory.&bslash;n&quot;
)paren
suffix:semicolon
id|mem-&gt;Common.Crystal
op_assign
id|A2232_UNKNOWN
suffix:semicolon
multiline_comment|/* use automatic speed check */
multiline_comment|/* start 6502 running */
(paren
r_void
)paren
id|mem-&gt;ResetBoard
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;A2232&squot;s 65EC02 CPU up and running.&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* wait until speed detector has finished */
r_for
c_loop
(paren
id|bcount
op_assign
l_int|0
suffix:semicolon
id|bcount
OL
l_int|2000
suffix:semicolon
id|bcount
op_increment
)paren
(brace
id|udelay
c_func
(paren
l_int|1000
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mem-&gt;Common.Crystal
)paren
r_break
suffix:semicolon
)brace
id|printk
c_func
(paren
(paren
id|mem-&gt;Common.Crystal
ques
c_cond
l_string|&quot;A2232 oscillator crystal detected by 65EC02 software: &quot;
suffix:colon
l_string|&quot;65EC02 software could not determine A2232 oscillator crystal: &quot;
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|mem-&gt;Common.Crystal
)paren
(brace
r_case
id|A2232_UNKNOWN
suffix:colon
id|printk
c_func
(paren
l_string|&quot;Unknown crystal.&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|A2232_NORMAL
suffix:colon
id|printk
(paren
l_string|&quot;Normal crystal.&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|A2232_TURBO
suffix:colon
id|printk
(paren
l_string|&quot;Turbo crystal.&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
(paren
l_string|&quot;0x%x. Huh?&bslash;n&quot;
comma
id|mem-&gt;Common.Crystal
)paren
suffix:semicolon
)brace
id|nr_a2232
op_increment
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;Total: %d A2232 boards initialized.&bslash;n.&quot;
comma
id|nr_a2232
)paren
suffix:semicolon
multiline_comment|/* Some status report if no card was found */
id|a2232_init_portstructs
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;a2232_init_drivers also registers the drivers. Must be here because all boards&n;&t;&t;have to be detected first.&n;&t;*/
r_if
c_cond
(paren
id|a2232_init_drivers
c_func
(paren
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
singleline_comment|// maybe we should use a different -Exxx?
id|request_irq
c_func
(paren
id|IRQ_AMIGA_VERTB
comma
id|a2232_vbl_inter
comma
l_int|0
comma
l_string|&quot;A2232 serial VBL&quot;
comma
id|a2232_driver_ID
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
r_return
id|a2232board_init
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|nr_a2232
suffix:semicolon
id|i
op_increment
)paren
(brace
id|zorro_release_device
c_func
(paren
id|zd_a2232
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|tty_unregister_driver
c_func
(paren
op_amp
id|a2232_driver
)paren
suffix:semicolon
id|tty_unregister_driver
c_func
(paren
op_amp
id|a2232_callout_driver
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|IRQ_AMIGA_VERTB
comma
id|a2232_driver_ID
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/***************************** End of Functions *********************/
eof
