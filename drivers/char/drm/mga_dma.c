multiline_comment|/* mga_dma.c -- DMA support for mga g200/g400 -*- linux-c -*-&n; * Created: Mon Dec 13 01:50:01 1999 by jhartmann@precisioninsight.com&n; *&n; * Copyright 1999 Precision Insight, Inc., Cedar Park, Texas.&n; * Copyright 2000 VA Linux Systems, Inc., Sunnyvale, California.&n; * All Rights Reserved.&n; *&n; * Permission is hereby granted, free of charge, to any person obtaining a&n; * copy of this software and associated documentation files (the &quot;Software&quot;),&n; * to deal in the Software without restriction, including without limitation&n; * the rights to use, copy, modify, merge, publish, distribute, sublicense,&n; * and/or sell copies of the Software, and to permit persons to whom the&n; * Software is furnished to do so, subject to the following conditions:&n; *&n; * The above copyright notice and this permission notice (including the next&n; * paragraph) shall be included in all copies or substantial portions of the&n; * Software.&n; *&n; * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR&n; * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,&n; * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL&n; * PRECISION INSIGHT AND/OR ITS SUPPLIERS BE LIABLE FOR ANY CLAIM, DAMAGES OR&n; * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,&n; * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER&n; * DEALINGS IN THE SOFTWARE.&n; *&n; * Authors:&n; *    Rickard E. (Rik) Faith &lt;faith@valinux.com&gt;&n; *    Jeff Hartmann &lt;jhartmann@valinux.com&gt;&n; *    Keith Whitwell &lt;keithw@valinux.com&gt;&n; *&n; * Rewritten by:&n; *    Gareth Hughes &lt;gareth@valinux.com&gt;&n; */
DECL|macro|__NO_VERSION__
mdefine_line|#define __NO_VERSION__
macro_line|#include &quot;mga.h&quot;
macro_line|#include &quot;drmP.h&quot;
macro_line|#include &quot;mga_drv.h&quot;
macro_line|#include &lt;linux/interrupt.h&gt;&t;/* For task queue support */
macro_line|#include &lt;linux/delay.h&gt;
DECL|macro|MGA_DEFAULT_USEC_TIMEOUT
mdefine_line|#define MGA_DEFAULT_USEC_TIMEOUT&t;10000
DECL|macro|MGA_FREELIST_DEBUG
mdefine_line|#define MGA_FREELIST_DEBUG&t;&t;0
multiline_comment|/* ================================================================&n; * Engine control&n; */
DECL|function|mga_do_wait_for_idle
r_int
id|mga_do_wait_for_idle
c_func
(paren
id|drm_mga_private_t
op_star
id|dev_priv
)paren
(brace
id|u32
id|status
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dev_priv-&gt;usec_timeout
suffix:semicolon
id|i
op_increment
)paren
(brace
id|status
op_assign
id|MGA_READ
c_func
(paren
id|MGA_STATUS
)paren
op_amp
id|MGA_ENGINE_IDLE_MASK
suffix:semicolon
r_if
c_cond
(paren
id|status
op_eq
id|MGA_ENDPRDMASTS
)paren
(brace
id|MGA_WRITE8
c_func
(paren
id|MGA_CRTC_INDEX
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
macro_line|#if MGA_DMA_DEBUG
id|DRM_ERROR
c_func
(paren
l_string|&quot;failed!&bslash;n&quot;
)paren
suffix:semicolon
id|DRM_INFO
c_func
(paren
l_string|&quot;   status=0x%08x&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
macro_line|#endif
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
DECL|function|mga_do_dma_idle
r_int
id|mga_do_dma_idle
c_func
(paren
id|drm_mga_private_t
op_star
id|dev_priv
)paren
(brace
id|u32
id|status
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dev_priv-&gt;usec_timeout
suffix:semicolon
id|i
op_increment
)paren
(brace
id|status
op_assign
id|MGA_READ
c_func
(paren
id|MGA_STATUS
)paren
op_amp
id|MGA_DMA_IDLE_MASK
suffix:semicolon
r_if
c_cond
(paren
id|status
op_eq
id|MGA_ENDPRDMASTS
)paren
r_return
l_int|0
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
macro_line|#if MGA_DMA_DEBUG
id|DRM_ERROR
c_func
(paren
l_string|&quot;failed! status=0x%08x&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
macro_line|#endif
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
DECL|function|mga_do_dma_reset
r_int
id|mga_do_dma_reset
c_func
(paren
id|drm_mga_private_t
op_star
id|dev_priv
)paren
(brace
id|drm_mga_sarea_t
op_star
id|sarea_priv
op_assign
id|dev_priv-&gt;sarea_priv
suffix:semicolon
id|drm_mga_primary_buffer_t
op_star
id|primary
op_assign
op_amp
id|dev_priv-&gt;prim
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
multiline_comment|/* The primary DMA stream should look like new right about now.&n;&t; */
id|primary-&gt;tail
op_assign
l_int|0
suffix:semicolon
id|primary-&gt;space
op_assign
id|primary-&gt;size
suffix:semicolon
id|primary-&gt;last_flush
op_assign
l_int|0
suffix:semicolon
id|sarea_priv-&gt;last_wrap
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* FIXME: Reset counters, buffer ages etc...&n;&t; */
multiline_comment|/* FIXME: What else do we need to reinitialize?  WARP stuff?&n;&t; */
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|mga_do_engine_reset
r_int
id|mga_do_engine_reset
c_func
(paren
id|drm_mga_private_t
op_star
id|dev_priv
)paren
(brace
id|DRM_DEBUG
c_func
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
multiline_comment|/* Okay, so we&squot;ve completely screwed up and locked the engine.&n;&t; * How about we clean up after ourselves?&n;&t; */
id|MGA_WRITE
c_func
(paren
id|MGA_RST
comma
id|MGA_SOFTRESET
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|15
)paren
suffix:semicolon
multiline_comment|/* Wait at least 10 usecs */
id|MGA_WRITE
c_func
(paren
id|MGA_RST
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Initialize the registers that get clobbered by the soft&n;&t; * reset.  Many of the core register values survive a reset,&n;&t; * but the drawing registers are basically all gone.&n;&t; *&n;&t; * 3D clients should probably die after calling this.  The X&n;&t; * server should reset the engine state to known values.&n;&t; */
macro_line|#if 0
id|MGA_WRITE
c_func
(paren
id|MGA_PRIMPTR
comma
id|virt_to_bus
c_func
(paren
(paren
r_void
op_star
)paren
id|dev_priv-&gt;prim.status_page
)paren
op_or
id|MGA_PRIMPTREN0
op_or
id|MGA_PRIMPTREN1
)paren
suffix:semicolon
macro_line|#endif
id|MGA_WRITE
c_func
(paren
id|MGA_ICLEAR
comma
id|MGA_SOFTRAPICLR
)paren
suffix:semicolon
id|MGA_WRITE
c_func
(paren
id|MGA_IEN
comma
id|MGA_SOFTRAPIEN
)paren
suffix:semicolon
multiline_comment|/* The primary DMA stream should look like new right about now.&n;&t; */
id|mga_do_dma_reset
c_func
(paren
id|dev_priv
)paren
suffix:semicolon
multiline_comment|/* This bad boy will never fail.&n;&t; */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* ================================================================&n; * Primary DMA stream&n; */
DECL|function|mga_do_dma_flush
r_void
id|mga_do_dma_flush
c_func
(paren
id|drm_mga_private_t
op_star
id|dev_priv
)paren
(brace
id|drm_mga_primary_buffer_t
op_star
id|primary
op_assign
op_amp
id|dev_priv-&gt;prim
suffix:semicolon
id|u32
id|head
comma
id|tail
suffix:semicolon
id|DMA_LOCALS
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;%s:&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_if
c_cond
(paren
id|primary-&gt;tail
op_eq
id|primary-&gt;last_flush
)paren
(brace
id|DRM_DEBUG
c_func
(paren
l_string|&quot;   bailing out...&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|tail
op_assign
id|primary-&gt;tail
op_plus
id|dev_priv-&gt;primary-&gt;offset
suffix:semicolon
multiline_comment|/* We need to pad the stream between flushes, as the card&n;&t; * actually (partially?) reads the first of these commands.&n;&t; * See page 4-16 in the G400 manual, middle of the page or so.&n;&t; */
id|BEGIN_DMA
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|DMA_BLOCK
c_func
(paren
id|MGA_DMAPAD
comma
l_int|0x00000000
comma
id|MGA_DMAPAD
comma
l_int|0x00000000
comma
id|MGA_DMAPAD
comma
l_int|0x00000000
comma
id|MGA_DMAPAD
comma
l_int|0x00000000
)paren
suffix:semicolon
id|ADVANCE_DMA
c_func
(paren
)paren
suffix:semicolon
id|primary-&gt;last_flush
op_assign
id|primary-&gt;tail
suffix:semicolon
id|head
op_assign
id|MGA_READ
c_func
(paren
id|MGA_PRIMADDRESS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|head
op_le
id|tail
)paren
(brace
id|primary-&gt;space
op_assign
id|primary-&gt;size
op_minus
id|primary-&gt;tail
suffix:semicolon
)brace
r_else
(brace
id|primary-&gt;space
op_assign
id|head
op_minus
id|tail
suffix:semicolon
)brace
id|DRM_DEBUG
c_func
(paren
l_string|&quot;   head = 0x%06lx&bslash;n&quot;
comma
id|head
op_minus
id|dev_priv-&gt;primary-&gt;offset
)paren
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;   tail = 0x%06lx&bslash;n&quot;
comma
id|tail
op_minus
id|dev_priv-&gt;primary-&gt;offset
)paren
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;  space = 0x%06x&bslash;n&quot;
comma
id|primary-&gt;space
)paren
suffix:semicolon
id|mga_flush_write_combine
c_func
(paren
)paren
suffix:semicolon
id|MGA_WRITE
c_func
(paren
id|MGA_PRIMEND
comma
id|tail
op_or
id|MGA_PAGPXFER
)paren
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;%s: done.&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
)brace
DECL|function|mga_do_dma_wrap_start
r_void
id|mga_do_dma_wrap_start
c_func
(paren
id|drm_mga_private_t
op_star
id|dev_priv
)paren
(brace
id|drm_mga_primary_buffer_t
op_star
id|primary
op_assign
op_amp
id|dev_priv-&gt;prim
suffix:semicolon
id|u32
id|head
comma
id|tail
suffix:semicolon
id|DMA_LOCALS
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;%s:&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|BEGIN_DMA_WRAP
c_func
(paren
)paren
suffix:semicolon
id|DMA_BLOCK
c_func
(paren
id|MGA_DMAPAD
comma
l_int|0x00000000
comma
id|MGA_DMAPAD
comma
l_int|0x00000000
comma
id|MGA_DMAPAD
comma
l_int|0x00000000
comma
id|MGA_DMAPAD
comma
l_int|0x00000000
)paren
suffix:semicolon
id|ADVANCE_DMA
c_func
(paren
)paren
suffix:semicolon
id|tail
op_assign
id|primary-&gt;tail
op_plus
id|dev_priv-&gt;primary-&gt;offset
suffix:semicolon
id|primary-&gt;tail
op_assign
l_int|0
suffix:semicolon
id|primary-&gt;last_flush
op_assign
l_int|0
suffix:semicolon
id|primary-&gt;last_wrap
op_increment
suffix:semicolon
id|head
op_assign
id|MGA_READ
c_func
(paren
id|MGA_PRIMADDRESS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|head
op_eq
id|dev_priv-&gt;primary-&gt;offset
)paren
(brace
id|primary-&gt;space
op_assign
id|primary-&gt;size
suffix:semicolon
)brace
r_else
(brace
id|primary-&gt;space
op_assign
id|head
op_minus
id|dev_priv-&gt;primary-&gt;offset
suffix:semicolon
)brace
id|DRM_DEBUG
c_func
(paren
l_string|&quot;   head = 0x%06lx&bslash;n&quot;
comma
id|head
op_minus
id|dev_priv-&gt;primary-&gt;offset
)paren
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;   tail = 0x%06x&bslash;n&quot;
comma
id|primary-&gt;tail
)paren
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;   wrap = %d&bslash;n&quot;
comma
id|primary-&gt;last_wrap
)paren
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;  space = 0x%06x&bslash;n&quot;
comma
id|primary-&gt;space
)paren
suffix:semicolon
id|mga_flush_write_combine
c_func
(paren
)paren
suffix:semicolon
id|MGA_WRITE
c_func
(paren
id|MGA_PRIMEND
comma
id|tail
op_or
id|MGA_PAGPXFER
)paren
suffix:semicolon
id|set_bit
c_func
(paren
l_int|0
comma
op_amp
id|primary-&gt;wrapped
)paren
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;%s: done.&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
)brace
DECL|function|mga_do_dma_wrap_end
r_void
id|mga_do_dma_wrap_end
c_func
(paren
id|drm_mga_private_t
op_star
id|dev_priv
)paren
(brace
id|drm_mga_primary_buffer_t
op_star
id|primary
op_assign
op_amp
id|dev_priv-&gt;prim
suffix:semicolon
id|drm_mga_sarea_t
op_star
id|sarea_priv
op_assign
id|dev_priv-&gt;sarea_priv
suffix:semicolon
id|u32
id|head
op_assign
id|dev_priv-&gt;primary-&gt;offset
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;%s:&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|sarea_priv-&gt;last_wrap
op_increment
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;   wrap = %d&bslash;n&quot;
comma
id|sarea_priv-&gt;last_wrap
)paren
suffix:semicolon
id|mga_flush_write_combine
c_func
(paren
)paren
suffix:semicolon
id|MGA_WRITE
c_func
(paren
id|MGA_PRIMADDRESS
comma
id|head
op_or
id|MGA_DMA_GENERAL
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
l_int|0
comma
op_amp
id|primary-&gt;wrapped
)paren
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;%s: done.&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
)brace
multiline_comment|/* ================================================================&n; * Freelist management&n; */
DECL|macro|MGA_BUFFER_USED
mdefine_line|#define MGA_BUFFER_USED&t;&t;~0
DECL|macro|MGA_BUFFER_FREE
mdefine_line|#define MGA_BUFFER_FREE&t;&t;0
macro_line|#if MGA_FREELIST_DEBUG
DECL|function|mga_freelist_print
r_static
r_void
id|mga_freelist_print
c_func
(paren
id|drm_device_t
op_star
id|dev
)paren
(brace
id|drm_mga_private_t
op_star
id|dev_priv
op_assign
id|dev-&gt;dev_private
suffix:semicolon
id|drm_mga_freelist_t
op_star
id|entry
suffix:semicolon
id|DRM_INFO
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|DRM_INFO
c_func
(paren
l_string|&quot;current dispatch: last=0x%x done=0x%x&bslash;n&quot;
comma
id|dev_priv-&gt;sarea_priv-&gt;last_dispatch
comma
(paren
r_int
r_int
)paren
(paren
id|MGA_READ
c_func
(paren
id|MGA_PRIMADDRESS
)paren
op_minus
id|dev_priv-&gt;primary-&gt;offset
)paren
)paren
suffix:semicolon
id|DRM_INFO
c_func
(paren
l_string|&quot;current freelist:&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|entry
op_assign
id|dev_priv-&gt;head-&gt;next
suffix:semicolon
id|entry
suffix:semicolon
id|entry
op_assign
id|entry-&gt;next
)paren
(brace
id|DRM_INFO
c_func
(paren
l_string|&quot;   %p   idx=%2d  age=0x%x 0x%06lx&bslash;n&quot;
comma
id|entry
comma
id|entry-&gt;buf-&gt;idx
comma
id|entry-&gt;age.head
comma
id|entry-&gt;age.head
op_minus
id|dev_priv-&gt;primary-&gt;offset
)paren
suffix:semicolon
)brace
id|DRM_INFO
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
DECL|function|mga_freelist_init
r_static
r_int
id|mga_freelist_init
c_func
(paren
id|drm_device_t
op_star
id|dev
comma
id|drm_mga_private_t
op_star
id|dev_priv
)paren
(brace
id|drm_device_dma_t
op_star
id|dma
op_assign
id|dev-&gt;dma
suffix:semicolon
id|drm_buf_t
op_star
id|buf
suffix:semicolon
id|drm_mga_buf_priv_t
op_star
id|buf_priv
suffix:semicolon
id|drm_mga_freelist_t
op_star
id|entry
suffix:semicolon
r_int
id|i
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;%s: count=%d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|dma-&gt;buf_count
)paren
suffix:semicolon
id|dev_priv-&gt;head
op_assign
id|DRM
c_func
(paren
id|alloc
)paren
(paren
r_sizeof
(paren
id|drm_mga_freelist_t
)paren
comma
id|DRM_MEM_DRIVER
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev_priv-&gt;head
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|dev_priv-&gt;head
comma
l_int|0
comma
r_sizeof
(paren
id|drm_mga_freelist_t
)paren
)paren
suffix:semicolon
id|SET_AGE
c_func
(paren
op_amp
id|dev_priv-&gt;head-&gt;age
comma
id|MGA_BUFFER_USED
comma
l_int|0
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dma-&gt;buf_count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|buf
op_assign
id|dma-&gt;buflist
(braket
id|i
)braket
suffix:semicolon
id|buf_priv
op_assign
id|buf-&gt;dev_private
suffix:semicolon
id|entry
op_assign
id|DRM
c_func
(paren
id|alloc
)paren
(paren
r_sizeof
(paren
id|drm_mga_freelist_t
)paren
comma
id|DRM_MEM_DRIVER
)paren
suffix:semicolon
r_if
c_cond
(paren
id|entry
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|entry
comma
l_int|0
comma
r_sizeof
(paren
id|drm_mga_freelist_t
)paren
)paren
suffix:semicolon
id|entry-&gt;next
op_assign
id|dev_priv-&gt;head-&gt;next
suffix:semicolon
id|entry-&gt;prev
op_assign
id|dev_priv-&gt;head
suffix:semicolon
id|SET_AGE
c_func
(paren
op_amp
id|entry-&gt;age
comma
id|MGA_BUFFER_FREE
comma
l_int|0
)paren
suffix:semicolon
id|entry-&gt;buf
op_assign
id|buf
suffix:semicolon
r_if
c_cond
(paren
id|dev_priv-&gt;head-&gt;next
op_ne
l_int|NULL
)paren
id|dev_priv-&gt;head-&gt;next-&gt;prev
op_assign
id|entry
suffix:semicolon
r_if
c_cond
(paren
id|entry-&gt;next
op_eq
l_int|NULL
)paren
id|dev_priv-&gt;tail
op_assign
id|entry
suffix:semicolon
id|buf_priv-&gt;list_entry
op_assign
id|entry
suffix:semicolon
id|buf_priv-&gt;discard
op_assign
l_int|0
suffix:semicolon
id|buf_priv-&gt;dispatched
op_assign
l_int|0
suffix:semicolon
id|dev_priv-&gt;head-&gt;next
op_assign
id|entry
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|mga_freelist_cleanup
r_static
r_void
id|mga_freelist_cleanup
c_func
(paren
id|drm_device_t
op_star
id|dev
)paren
(brace
id|drm_mga_private_t
op_star
id|dev_priv
op_assign
id|dev-&gt;dev_private
suffix:semicolon
id|drm_mga_freelist_t
op_star
id|entry
suffix:semicolon
id|drm_mga_freelist_t
op_star
id|next
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|entry
op_assign
id|dev_priv-&gt;head
suffix:semicolon
r_while
c_loop
(paren
id|entry
)paren
(brace
id|next
op_assign
id|entry-&gt;next
suffix:semicolon
id|DRM
c_func
(paren
id|free
)paren
(paren
id|entry
comma
r_sizeof
(paren
id|drm_mga_freelist_t
)paren
comma
id|DRM_MEM_DRIVER
)paren
suffix:semicolon
id|entry
op_assign
id|next
suffix:semicolon
)brace
id|dev_priv-&gt;head
op_assign
id|dev_priv-&gt;tail
op_assign
l_int|NULL
suffix:semicolon
)brace
macro_line|#if 0
multiline_comment|/* FIXME: Still needed?&n; */
r_static
r_void
id|mga_freelist_reset
c_func
(paren
id|drm_device_t
op_star
id|dev
)paren
(brace
id|drm_device_dma_t
op_star
id|dma
op_assign
id|dev-&gt;dma
suffix:semicolon
id|drm_buf_t
op_star
id|buf
suffix:semicolon
id|drm_mga_buf_priv_t
op_star
id|buf_priv
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dma-&gt;buf_count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|buf
op_assign
id|dma-&gt;buflist
(braket
id|i
)braket
suffix:semicolon
id|buf_priv
op_assign
id|buf-&gt;dev_private
suffix:semicolon
id|SET_AGE
c_func
(paren
op_amp
id|buf_priv-&gt;list_entry-&gt;age
comma
id|MGA_BUFFER_FREE
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
DECL|function|mga_freelist_get
r_static
id|drm_buf_t
op_star
id|mga_freelist_get
c_func
(paren
id|drm_device_t
op_star
id|dev
)paren
(brace
id|drm_mga_private_t
op_star
id|dev_priv
op_assign
id|dev-&gt;dev_private
suffix:semicolon
id|drm_mga_freelist_t
op_star
id|next
suffix:semicolon
id|drm_mga_freelist_t
op_star
id|prev
suffix:semicolon
id|drm_mga_freelist_t
op_star
id|tail
op_assign
id|dev_priv-&gt;tail
suffix:semicolon
id|u32
id|head
comma
id|wrap
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;%s:&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|head
op_assign
id|MGA_READ
c_func
(paren
id|MGA_PRIMADDRESS
)paren
suffix:semicolon
id|wrap
op_assign
id|dev_priv-&gt;sarea_priv-&gt;last_wrap
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;   tail=0x%06lx %d&bslash;n&quot;
comma
id|tail-&gt;age.head
ques
c_cond
id|tail-&gt;age.head
op_minus
id|dev_priv-&gt;primary-&gt;offset
suffix:colon
l_int|0
comma
id|tail-&gt;age.wrap
)paren
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;   head=0x%06lx %d&bslash;n&quot;
comma
id|head
op_minus
id|dev_priv-&gt;primary-&gt;offset
comma
id|wrap
)paren
suffix:semicolon
r_if
c_cond
(paren
id|TEST_AGE
c_func
(paren
op_amp
id|tail-&gt;age
comma
id|head
comma
id|wrap
)paren
)paren
(brace
id|prev
op_assign
id|dev_priv-&gt;tail-&gt;prev
suffix:semicolon
id|next
op_assign
id|dev_priv-&gt;tail
suffix:semicolon
id|prev-&gt;next
op_assign
l_int|NULL
suffix:semicolon
id|next-&gt;prev
op_assign
id|next-&gt;next
op_assign
l_int|NULL
suffix:semicolon
id|dev_priv-&gt;tail
op_assign
id|prev
suffix:semicolon
id|SET_AGE
c_func
(paren
op_amp
id|next-&gt;age
comma
id|MGA_BUFFER_USED
comma
l_int|0
)paren
suffix:semicolon
r_return
id|next-&gt;buf
suffix:semicolon
)brace
id|DRM_DEBUG
c_func
(paren
l_string|&quot;returning NULL!&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|mga_freelist_put
r_int
id|mga_freelist_put
c_func
(paren
id|drm_device_t
op_star
id|dev
comma
id|drm_buf_t
op_star
id|buf
)paren
(brace
id|drm_mga_private_t
op_star
id|dev_priv
op_assign
id|dev-&gt;dev_private
suffix:semicolon
id|drm_mga_buf_priv_t
op_star
id|buf_priv
op_assign
id|buf-&gt;dev_private
suffix:semicolon
id|drm_mga_freelist_t
op_star
id|head
comma
op_star
id|entry
comma
op_star
id|prev
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;%s: age=0x%06lx wrap=%d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|buf_priv-&gt;list_entry-&gt;age.head
op_minus
id|dev_priv-&gt;primary-&gt;offset
comma
id|buf_priv-&gt;list_entry-&gt;age.wrap
)paren
suffix:semicolon
id|entry
op_assign
id|buf_priv-&gt;list_entry
suffix:semicolon
id|head
op_assign
id|dev_priv-&gt;head
suffix:semicolon
r_if
c_cond
(paren
id|buf_priv-&gt;list_entry-&gt;age.head
op_eq
id|MGA_BUFFER_USED
)paren
(brace
id|SET_AGE
c_func
(paren
op_amp
id|entry-&gt;age
comma
id|MGA_BUFFER_FREE
comma
l_int|0
)paren
suffix:semicolon
id|prev
op_assign
id|dev_priv-&gt;tail
suffix:semicolon
id|prev-&gt;next
op_assign
id|entry
suffix:semicolon
id|entry-&gt;prev
op_assign
id|prev
suffix:semicolon
id|entry-&gt;next
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
(brace
id|prev
op_assign
id|head-&gt;next
suffix:semicolon
id|head-&gt;next
op_assign
id|entry
suffix:semicolon
id|prev-&gt;prev
op_assign
id|entry
suffix:semicolon
id|entry-&gt;prev
op_assign
id|head
suffix:semicolon
id|entry-&gt;next
op_assign
id|prev
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* ================================================================&n; * DMA initialization, cleanup&n; */
DECL|function|mga_do_init_dma
r_static
r_int
id|mga_do_init_dma
c_func
(paren
id|drm_device_t
op_star
id|dev
comma
id|drm_mga_init_t
op_star
id|init
)paren
(brace
id|drm_mga_private_t
op_star
id|dev_priv
suffix:semicolon
r_struct
id|list_head
op_star
id|list
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|dev_priv
op_assign
id|DRM
c_func
(paren
id|alloc
)paren
(paren
r_sizeof
(paren
id|drm_mga_private_t
)paren
comma
id|DRM_MEM_DRIVER
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev_priv
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|dev_priv
comma
l_int|0
comma
r_sizeof
(paren
id|drm_mga_private_t
)paren
)paren
suffix:semicolon
id|dev_priv-&gt;chipset
op_assign
id|init-&gt;chipset
suffix:semicolon
id|dev_priv-&gt;usec_timeout
op_assign
id|MGA_DEFAULT_USEC_TIMEOUT
suffix:semicolon
r_if
c_cond
(paren
id|init-&gt;sgram
)paren
(brace
id|dev_priv-&gt;clear_cmd
op_assign
id|MGA_DWGCTL_CLEAR
op_or
id|MGA_ATYPE_BLK
suffix:semicolon
)brace
r_else
(brace
id|dev_priv-&gt;clear_cmd
op_assign
id|MGA_DWGCTL_CLEAR
op_or
id|MGA_ATYPE_RSTR
suffix:semicolon
)brace
id|dev_priv-&gt;maccess
op_assign
id|init-&gt;maccess
suffix:semicolon
id|dev_priv-&gt;fb_cpp
op_assign
id|init-&gt;fb_cpp
suffix:semicolon
id|dev_priv-&gt;front_offset
op_assign
id|init-&gt;front_offset
suffix:semicolon
id|dev_priv-&gt;front_pitch
op_assign
id|init-&gt;front_pitch
suffix:semicolon
id|dev_priv-&gt;back_offset
op_assign
id|init-&gt;back_offset
suffix:semicolon
id|dev_priv-&gt;back_pitch
op_assign
id|init-&gt;back_pitch
suffix:semicolon
id|dev_priv-&gt;depth_cpp
op_assign
id|init-&gt;depth_cpp
suffix:semicolon
id|dev_priv-&gt;depth_offset
op_assign
id|init-&gt;depth_offset
suffix:semicolon
id|dev_priv-&gt;depth_pitch
op_assign
id|init-&gt;depth_pitch
suffix:semicolon
multiline_comment|/* FIXME: Need to support AGP textures...&n;&t; */
id|dev_priv-&gt;texture_offset
op_assign
id|init-&gt;texture_offset
(braket
l_int|0
)braket
suffix:semicolon
id|dev_priv-&gt;texture_size
op_assign
id|init-&gt;texture_size
(braket
l_int|0
)braket
suffix:semicolon
id|list_for_each
c_func
(paren
id|list
comma
op_amp
id|dev-&gt;maplist-&gt;head
)paren
(brace
id|drm_map_list_t
op_star
id|entry
op_assign
(paren
id|drm_map_list_t
op_star
)paren
id|list
suffix:semicolon
r_if
c_cond
(paren
id|entry-&gt;map
op_logical_and
id|entry-&gt;map-&gt;type
op_eq
id|_DRM_SHM
op_logical_and
(paren
id|entry-&gt;map-&gt;flags
op_amp
id|_DRM_CONTAINS_LOCK
)paren
)paren
(brace
id|dev_priv-&gt;sarea
op_assign
id|entry-&gt;map
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|dev_priv-&gt;sarea
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;failed to find sarea!&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Assign dev_private so we can do cleanup. */
id|dev-&gt;dev_private
op_assign
(paren
r_void
op_star
)paren
id|dev_priv
suffix:semicolon
id|mga_do_cleanup_dma
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|DRM_FIND_MAP
c_func
(paren
id|dev_priv-&gt;fb
comma
id|init-&gt;fb_offset
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev_priv-&gt;fb
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;failed to find framebuffer!&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Assign dev_private so we can do cleanup. */
id|dev-&gt;dev_private
op_assign
(paren
r_void
op_star
)paren
id|dev_priv
suffix:semicolon
id|mga_do_cleanup_dma
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|DRM_FIND_MAP
c_func
(paren
id|dev_priv-&gt;mmio
comma
id|init-&gt;mmio_offset
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev_priv-&gt;mmio
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;failed to find mmio region!&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Assign dev_private so we can do cleanup. */
id|dev-&gt;dev_private
op_assign
(paren
r_void
op_star
)paren
id|dev_priv
suffix:semicolon
id|mga_do_cleanup_dma
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|DRM_FIND_MAP
c_func
(paren
id|dev_priv-&gt;status
comma
id|init-&gt;status_offset
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev_priv-&gt;status
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;failed to find status page!&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Assign dev_private so we can do cleanup. */
id|dev-&gt;dev_private
op_assign
(paren
r_void
op_star
)paren
id|dev_priv
suffix:semicolon
id|mga_do_cleanup_dma
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|DRM_FIND_MAP
c_func
(paren
id|dev_priv-&gt;warp
comma
id|init-&gt;warp_offset
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev_priv-&gt;warp
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;failed to find warp microcode region!&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Assign dev_private so we can do cleanup. */
id|dev-&gt;dev_private
op_assign
(paren
r_void
op_star
)paren
id|dev_priv
suffix:semicolon
id|mga_do_cleanup_dma
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|DRM_FIND_MAP
c_func
(paren
id|dev_priv-&gt;primary
comma
id|init-&gt;primary_offset
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev_priv-&gt;primary
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;failed to find primary dma region!&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Assign dev_private so we can do cleanup. */
id|dev-&gt;dev_private
op_assign
(paren
r_void
op_star
)paren
id|dev_priv
suffix:semicolon
id|mga_do_cleanup_dma
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|DRM_FIND_MAP
c_func
(paren
id|dev_priv-&gt;buffers
comma
id|init-&gt;buffers_offset
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev_priv-&gt;buffers
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;failed to find dma buffer region!&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Assign dev_private so we can do cleanup. */
id|dev-&gt;dev_private
op_assign
(paren
r_void
op_star
)paren
id|dev_priv
suffix:semicolon
id|mga_do_cleanup_dma
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|dev_priv-&gt;sarea_priv
op_assign
(paren
id|drm_mga_sarea_t
op_star
)paren
(paren
(paren
id|u8
op_star
)paren
id|dev_priv-&gt;sarea-&gt;handle
op_plus
id|init-&gt;sarea_priv_offset
)paren
suffix:semicolon
id|DRM_IOREMAP
c_func
(paren
id|dev_priv-&gt;warp
)paren
suffix:semicolon
id|DRM_IOREMAP
c_func
(paren
id|dev_priv-&gt;primary
)paren
suffix:semicolon
id|DRM_IOREMAP
c_func
(paren
id|dev_priv-&gt;buffers
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev_priv-&gt;warp-&gt;handle
op_logical_or
op_logical_neg
id|dev_priv-&gt;primary-&gt;handle
op_logical_or
op_logical_neg
id|dev_priv-&gt;buffers-&gt;handle
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;failed to ioremap agp regions!&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Assign dev_private so we can do cleanup. */
id|dev-&gt;dev_private
op_assign
(paren
r_void
op_star
)paren
id|dev_priv
suffix:semicolon
id|mga_do_cleanup_dma
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|ret
op_assign
id|mga_warp_install_microcode
c_func
(paren
id|dev_priv
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;failed to install WARP ucode!&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Assign dev_private so we can do cleanup. */
id|dev-&gt;dev_private
op_assign
(paren
r_void
op_star
)paren
id|dev_priv
suffix:semicolon
id|mga_do_cleanup_dma
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
id|ret
op_assign
id|mga_warp_init
c_func
(paren
id|dev_priv
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;failed to init WARP engine!&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Assign dev_private so we can do cleanup. */
id|dev-&gt;dev_private
op_assign
(paren
r_void
op_star
)paren
id|dev_priv
suffix:semicolon
id|mga_do_cleanup_dma
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
id|dev_priv-&gt;prim.status
op_assign
(paren
id|u32
op_star
)paren
id|dev_priv-&gt;status-&gt;handle
suffix:semicolon
id|mga_do_wait_for_idle
c_func
(paren
id|dev_priv
)paren
suffix:semicolon
multiline_comment|/* Init the primary DMA registers.&n;&t; */
id|MGA_WRITE
c_func
(paren
id|MGA_PRIMADDRESS
comma
id|dev_priv-&gt;primary-&gt;offset
op_or
id|MGA_DMA_GENERAL
)paren
suffix:semicolon
macro_line|#if 0
id|MGA_WRITE
c_func
(paren
id|MGA_PRIMPTR
comma
id|virt_to_bus
c_func
(paren
(paren
r_void
op_star
)paren
id|dev_priv-&gt;prim.status
)paren
op_or
id|MGA_PRIMPTREN0
op_or
multiline_comment|/* Soft trap, SECEND, SETUPEND */
id|MGA_PRIMPTREN1
)paren
suffix:semicolon
multiline_comment|/* DWGSYNC */
macro_line|#endif
id|dev_priv-&gt;prim.start
op_assign
(paren
id|u8
op_star
)paren
id|dev_priv-&gt;primary-&gt;handle
suffix:semicolon
id|dev_priv-&gt;prim.end
op_assign
(paren
(paren
id|u8
op_star
)paren
id|dev_priv-&gt;primary-&gt;handle
op_plus
id|dev_priv-&gt;primary-&gt;size
)paren
suffix:semicolon
id|dev_priv-&gt;prim.size
op_assign
id|dev_priv-&gt;primary-&gt;size
suffix:semicolon
id|dev_priv-&gt;prim.tail
op_assign
l_int|0
suffix:semicolon
id|dev_priv-&gt;prim.space
op_assign
id|dev_priv-&gt;prim.size
suffix:semicolon
id|dev_priv-&gt;prim.wrapped
op_assign
l_int|0
suffix:semicolon
id|dev_priv-&gt;prim.last_flush
op_assign
l_int|0
suffix:semicolon
id|dev_priv-&gt;prim.last_wrap
op_assign
l_int|0
suffix:semicolon
id|dev_priv-&gt;prim.high_mark
op_assign
l_int|256
op_star
id|DMA_BLOCK_SIZE
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|dev_priv-&gt;prim.list_lock
)paren
suffix:semicolon
id|dev_priv-&gt;prim.status
(braket
l_int|0
)braket
op_assign
id|dev_priv-&gt;primary-&gt;offset
suffix:semicolon
id|dev_priv-&gt;prim.status
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|dev_priv-&gt;sarea_priv-&gt;last_wrap
op_assign
l_int|0
suffix:semicolon
id|dev_priv-&gt;sarea_priv-&gt;last_frame.head
op_assign
l_int|0
suffix:semicolon
id|dev_priv-&gt;sarea_priv-&gt;last_frame.wrap
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|mga_freelist_init
c_func
(paren
id|dev
comma
id|dev_priv
)paren
OL
l_int|0
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;could not initialize freelist&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Assign dev_private so we can do cleanup. */
id|dev-&gt;dev_private
op_assign
(paren
r_void
op_star
)paren
id|dev_priv
suffix:semicolon
id|mga_do_cleanup_dma
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/* Make dev_private visable to others. */
id|dev-&gt;dev_private
op_assign
(paren
r_void
op_star
)paren
id|dev_priv
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|mga_do_cleanup_dma
r_int
id|mga_do_cleanup_dma
c_func
(paren
id|drm_device_t
op_star
id|dev
)paren
(brace
id|DRM_DEBUG
c_func
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;dev_private
)paren
(brace
id|drm_mga_private_t
op_star
id|dev_priv
op_assign
id|dev-&gt;dev_private
suffix:semicolon
id|DRM_IOREMAPFREE
c_func
(paren
id|dev_priv-&gt;warp
)paren
suffix:semicolon
id|DRM_IOREMAPFREE
c_func
(paren
id|dev_priv-&gt;primary
)paren
suffix:semicolon
id|DRM_IOREMAPFREE
c_func
(paren
id|dev_priv-&gt;buffers
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev_priv-&gt;head
op_ne
l_int|NULL
)paren
(brace
id|mga_freelist_cleanup
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
id|DRM
c_func
(paren
id|free
)paren
(paren
id|dev-&gt;dev_private
comma
r_sizeof
(paren
id|drm_mga_private_t
)paren
comma
id|DRM_MEM_DRIVER
)paren
suffix:semicolon
id|dev-&gt;dev_private
op_assign
l_int|NULL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|mga_dma_init
r_int
id|mga_dma_init
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
id|drm_file_t
op_star
id|priv
op_assign
id|filp-&gt;private_data
suffix:semicolon
id|drm_device_t
op_star
id|dev
op_assign
id|priv-&gt;dev
suffix:semicolon
id|drm_mga_init_t
id|init
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|init
comma
(paren
id|drm_mga_init_t
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|init
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_switch
c_cond
(paren
id|init.func
)paren
(brace
r_case
id|MGA_INIT_DMA
suffix:colon
r_return
id|mga_do_init_dma
c_func
(paren
id|dev
comma
op_amp
id|init
)paren
suffix:semicolon
r_case
id|MGA_CLEANUP_DMA
suffix:colon
r_return
id|mga_do_cleanup_dma
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* ================================================================&n; * Primary DMA stream management&n; */
DECL|function|mga_dma_flush
r_int
id|mga_dma_flush
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
id|drm_file_t
op_star
id|priv
op_assign
id|filp-&gt;private_data
suffix:semicolon
id|drm_device_t
op_star
id|dev
op_assign
id|priv-&gt;dev
suffix:semicolon
id|drm_mga_private_t
op_star
id|dev_priv
op_assign
(paren
id|drm_mga_private_t
op_star
)paren
id|dev-&gt;dev_private
suffix:semicolon
id|drm_lock_t
id|lock
suffix:semicolon
id|LOCK_TEST_WITH_RETURN
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|lock
comma
(paren
id|drm_lock_t
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|lock
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;%s: %s%s%s&bslash;n&quot;
comma
id|__FUNCTION__
comma
(paren
id|lock.flags
op_amp
id|_DRM_LOCK_FLUSH
)paren
ques
c_cond
l_string|&quot;flush, &quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|lock.flags
op_amp
id|_DRM_LOCK_FLUSH_ALL
)paren
ques
c_cond
l_string|&quot;flush all, &quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|lock.flags
op_amp
id|_DRM_LOCK_QUIESCENT
)paren
ques
c_cond
l_string|&quot;idle, &quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
id|WRAP_WAIT_WITH_RETURN
c_func
(paren
id|dev_priv
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lock.flags
op_amp
(paren
id|_DRM_LOCK_FLUSH
op_or
id|_DRM_LOCK_FLUSH_ALL
)paren
)paren
(brace
id|mga_do_dma_flush
c_func
(paren
id|dev_priv
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|lock.flags
op_amp
id|_DRM_LOCK_QUIESCENT
)paren
(brace
macro_line|#if MGA_DMA_DEBUG
r_int
id|ret
op_assign
id|mga_do_wait_for_idle
c_func
(paren
id|dev_priv
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
id|DRM_INFO
c_func
(paren
id|__FUNCTION__
l_string|&quot;: -EBUSY&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
macro_line|#else
r_return
id|mga_do_wait_for_idle
c_func
(paren
id|dev_priv
)paren
suffix:semicolon
macro_line|#endif
)brace
r_else
(brace
r_return
l_int|0
suffix:semicolon
)brace
)brace
DECL|function|mga_dma_reset
r_int
id|mga_dma_reset
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
id|drm_file_t
op_star
id|priv
op_assign
id|filp-&gt;private_data
suffix:semicolon
id|drm_device_t
op_star
id|dev
op_assign
id|priv-&gt;dev
suffix:semicolon
id|drm_mga_private_t
op_star
id|dev_priv
op_assign
(paren
id|drm_mga_private_t
op_star
)paren
id|dev-&gt;dev_private
suffix:semicolon
id|LOCK_TEST_WITH_RETURN
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|mga_do_dma_reset
c_func
(paren
id|dev_priv
)paren
suffix:semicolon
)brace
multiline_comment|/* ================================================================&n; * DMA buffer management&n; */
DECL|function|mga_dma_get_buffers
r_static
r_int
id|mga_dma_get_buffers
c_func
(paren
id|drm_device_t
op_star
id|dev
comma
id|drm_dma_t
op_star
id|d
)paren
(brace
id|drm_buf_t
op_star
id|buf
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|d-&gt;granted_count
suffix:semicolon
id|i
OL
id|d-&gt;request_count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|buf
op_assign
id|mga_freelist_get
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|buf
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
id|buf-&gt;pid
op_assign
id|current-&gt;pid
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
op_amp
id|d-&gt;request_indices
(braket
id|i
)braket
comma
op_amp
id|buf-&gt;idx
comma
r_sizeof
(paren
id|buf-&gt;idx
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
op_amp
id|d-&gt;request_sizes
(braket
id|i
)braket
comma
op_amp
id|buf-&gt;total
comma
r_sizeof
(paren
id|buf-&gt;total
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|d-&gt;granted_count
op_increment
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|mga_dma_buffers
r_int
id|mga_dma_buffers
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
id|drm_file_t
op_star
id|priv
op_assign
id|filp-&gt;private_data
suffix:semicolon
id|drm_device_t
op_star
id|dev
op_assign
id|priv-&gt;dev
suffix:semicolon
id|drm_device_dma_t
op_star
id|dma
op_assign
id|dev-&gt;dma
suffix:semicolon
id|drm_mga_private_t
op_star
id|dev_priv
op_assign
(paren
id|drm_mga_private_t
op_star
)paren
id|dev-&gt;dev_private
suffix:semicolon
id|drm_dma_t
id|d
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
id|LOCK_TEST_WITH_RETURN
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|d
comma
(paren
id|drm_dma_t
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|d
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
multiline_comment|/* Please don&squot;t send us buffers.&n;&t; */
r_if
c_cond
(paren
id|d.send_count
op_ne
l_int|0
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;Process %d trying to send %d buffers via drmDMA&bslash;n&quot;
comma
id|current-&gt;pid
comma
id|d.send_count
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* We&squot;ll send you buffers.&n;&t; */
r_if
c_cond
(paren
id|d.request_count
template_param
id|dma-&gt;buf_count
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;Process %d trying to get %d buffers (of %d max)&bslash;n&quot;
comma
id|current-&gt;pid
comma
id|d.request_count
comma
id|dma-&gt;buf_count
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|WRAP_TEST_WITH_RETURN
c_func
(paren
id|dev_priv
)paren
suffix:semicolon
id|d.granted_count
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|d.request_count
)paren
(brace
id|ret
op_assign
id|mga_dma_get_buffers
c_func
(paren
id|dev
comma
op_amp
id|d
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
id|drm_dma_t
op_star
)paren
id|arg
comma
op_amp
id|d
comma
r_sizeof
(paren
id|d
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
eof
