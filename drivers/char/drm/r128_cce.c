multiline_comment|/* r128_cce.c -- ATI Rage 128 driver -*- linux-c -*-&n; * Created: Wed Apr  5 19:24:19 2000 by kevin@precisioninsight.com&n; *&n; * Copyright 2000 Precision Insight, Inc., Cedar Park, Texas.&n; * Copyright 2000 VA Linux Systems, Inc., Sunnyvale, California.&n; * All Rights Reserved.&n; *&n; * Permission is hereby granted, free of charge, to any person obtaining a&n; * copy of this software and associated documentation files (the &quot;Software&quot;),&n; * to deal in the Software without restriction, including without limitation&n; * the rights to use, copy, modify, merge, publish, distribute, sublicense,&n; * and/or sell copies of the Software, and to permit persons to whom the&n; * Software is furnished to do so, subject to the following conditions:&n; *&n; * The above copyright notice and this permission notice (including the next&n; * paragraph) shall be included in all copies or substantial portions of the&n; * Software.&n; *&n; * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR&n; * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,&n; * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL&n; * PRECISION INSIGHT AND/OR ITS SUPPLIERS BE LIABLE FOR ANY CLAIM, DAMAGES OR&n; * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,&n; * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER&n; * DEALINGS IN THE SOFTWARE.&n; *&n; * Authors:&n; *    Gareth Hughes &lt;gareth@valinux.com&gt;&n; */
macro_line|#include &quot;r128.h&quot;
macro_line|#include &quot;drmP.h&quot;
macro_line|#include &quot;drm.h&quot;
macro_line|#include &quot;r128_drm.h&quot;
macro_line|#include &quot;r128_drv.h&quot;
DECL|macro|R128_FIFO_DEBUG
mdefine_line|#define R128_FIFO_DEBUG&t;&t;0
multiline_comment|/* CCE microcode (from ATI) */
DECL|variable|r128_cce_microcode
r_static
id|u32
id|r128_cce_microcode
(braket
)braket
op_assign
(brace
l_int|0
comma
l_int|276838400
comma
l_int|0
comma
l_int|268449792
comma
l_int|2
comma
l_int|142
comma
l_int|2
comma
l_int|145
comma
l_int|0
comma
l_int|1076765731
comma
l_int|0
comma
l_int|1617039951
comma
l_int|0
comma
l_int|774592877
comma
l_int|0
comma
l_int|1987540286
comma
l_int|0
comma
l_int|2307490946U
comma
l_int|0
comma
l_int|599558925
comma
l_int|0
comma
l_int|589505315
comma
l_int|0
comma
l_int|596487092
comma
l_int|0
comma
l_int|589505315
comma
l_int|1
comma
l_int|11544576
comma
l_int|1
comma
l_int|206848
comma
l_int|1
comma
l_int|311296
comma
l_int|1
comma
l_int|198656
comma
l_int|2
comma
l_int|912273422
comma
l_int|11
comma
l_int|262144
comma
l_int|0
comma
l_int|0
comma
l_int|1
comma
l_int|33559837
comma
l_int|1
comma
l_int|7438
comma
l_int|1
comma
l_int|14809
comma
l_int|1
comma
l_int|6615
comma
l_int|12
comma
l_int|28
comma
l_int|1
comma
l_int|6614
comma
l_int|12
comma
l_int|28
comma
l_int|2
comma
l_int|23
comma
l_int|11
comma
l_int|18874368
comma
l_int|0
comma
l_int|16790922
comma
l_int|1
comma
l_int|409600
comma
l_int|9
comma
l_int|30
comma
l_int|1
comma
l_int|147854772
comma
l_int|16
comma
l_int|420483072
comma
l_int|3
comma
l_int|8192
comma
l_int|0
comma
l_int|10240
comma
l_int|1
comma
l_int|198656
comma
l_int|1
comma
l_int|15630
comma
l_int|1
comma
l_int|51200
comma
l_int|10
comma
l_int|34858
comma
l_int|9
comma
l_int|42
comma
l_int|1
comma
l_int|33559823
comma
l_int|2
comma
l_int|10276
comma
l_int|1
comma
l_int|15717
comma
l_int|1
comma
l_int|15718
comma
l_int|2
comma
l_int|43
comma
l_int|1
comma
l_int|15936948
comma
l_int|1
comma
l_int|570480831
comma
l_int|1
comma
l_int|14715071
comma
l_int|12
comma
l_int|322123831
comma
l_int|1
comma
l_int|33953125
comma
l_int|12
comma
l_int|55
comma
l_int|1
comma
l_int|33559908
comma
l_int|1
comma
l_int|15718
comma
l_int|2
comma
l_int|46
comma
l_int|4
comma
l_int|2099258
comma
l_int|1
comma
l_int|526336
comma
l_int|1
comma
l_int|442623
comma
l_int|4
comma
l_int|4194365
comma
l_int|1
comma
l_int|509952
comma
l_int|1
comma
l_int|459007
comma
l_int|3
comma
l_int|0
comma
l_int|12
comma
l_int|92
comma
l_int|2
comma
l_int|46
comma
l_int|12
comma
l_int|176
comma
l_int|1
comma
l_int|15734
comma
l_int|1
comma
l_int|206848
comma
l_int|1
comma
l_int|18432
comma
l_int|1
comma
l_int|133120
comma
l_int|1
comma
l_int|100670734
comma
l_int|1
comma
l_int|149504
comma
l_int|1
comma
l_int|165888
comma
l_int|1
comma
l_int|15975928
comma
l_int|1
comma
l_int|1048576
comma
l_int|6
comma
l_int|3145806
comma
l_int|1
comma
l_int|15715
comma
l_int|16
comma
l_int|2150645232U
comma
l_int|2
comma
l_int|268449859
comma
l_int|2
comma
l_int|10307
comma
l_int|12
comma
l_int|176
comma
l_int|1
comma
l_int|15734
comma
l_int|1
comma
l_int|15735
comma
l_int|1
comma
l_int|15630
comma
l_int|1
comma
l_int|15631
comma
l_int|1
comma
l_int|5253120
comma
l_int|6
comma
l_int|3145810
comma
l_int|16
comma
l_int|2150645232U
comma
l_int|1
comma
l_int|15864
comma
l_int|2
comma
l_int|82
comma
l_int|1
comma
l_int|343310
comma
l_int|1
comma
l_int|1064207
comma
l_int|2
comma
l_int|3145813
comma
l_int|1
comma
l_int|15728
comma
l_int|1
comma
l_int|7817
comma
l_int|1
comma
l_int|15729
comma
l_int|3
comma
l_int|15730
comma
l_int|12
comma
l_int|92
comma
l_int|2
comma
l_int|98
comma
l_int|1
comma
l_int|16168
comma
l_int|1
comma
l_int|16167
comma
l_int|1
comma
l_int|16002
comma
l_int|1
comma
l_int|16008
comma
l_int|1
comma
l_int|15974
comma
l_int|1
comma
l_int|15975
comma
l_int|1
comma
l_int|15990
comma
l_int|1
comma
l_int|15976
comma
l_int|1
comma
l_int|15977
comma
l_int|1
comma
l_int|15980
comma
l_int|0
comma
l_int|15981
comma
l_int|1
comma
l_int|10240
comma
l_int|1
comma
l_int|5253120
comma
l_int|1
comma
l_int|15720
comma
l_int|1
comma
l_int|198656
comma
l_int|6
comma
l_int|110
comma
l_int|1
comma
l_int|180224
comma
l_int|1
comma
l_int|103824738
comma
l_int|2
comma
l_int|112
comma
l_int|2
comma
l_int|3145839
comma
l_int|0
comma
l_int|536885440
comma
l_int|1
comma
l_int|114880
comma
l_int|14
comma
l_int|125
comma
l_int|12
comma
l_int|206975
comma
l_int|1
comma
l_int|33559995
comma
l_int|12
comma
l_int|198784
comma
l_int|0
comma
l_int|33570236
comma
l_int|1
comma
l_int|15803
comma
l_int|0
comma
l_int|15804
comma
l_int|3
comma
l_int|294912
comma
l_int|1
comma
l_int|294912
comma
l_int|3
comma
l_int|442370
comma
l_int|1
comma
l_int|11544576
comma
l_int|0
comma
l_int|811612160
comma
l_int|1
comma
l_int|12593152
comma
l_int|1
comma
l_int|11536384
comma
l_int|1
comma
l_int|14024704
comma
l_int|7
comma
l_int|310382726
comma
l_int|0
comma
l_int|10240
comma
l_int|1
comma
l_int|14796
comma
l_int|1
comma
l_int|14797
comma
l_int|1
comma
l_int|14793
comma
l_int|1
comma
l_int|14794
comma
l_int|0
comma
l_int|14795
comma
l_int|1
comma
l_int|268679168
comma
l_int|1
comma
l_int|9437184
comma
l_int|1
comma
l_int|268449792
comma
l_int|1
comma
l_int|198656
comma
l_int|1
comma
l_int|9452827
comma
l_int|1
comma
l_int|1075854602
comma
l_int|1
comma
l_int|1075854603
comma
l_int|1
comma
l_int|557056
comma
l_int|1
comma
l_int|114880
comma
l_int|14
comma
l_int|159
comma
l_int|12
comma
l_int|198784
comma
l_int|1
comma
l_int|1109409213
comma
l_int|12
comma
l_int|198783
comma
l_int|1
comma
l_int|1107312059
comma
l_int|12
comma
l_int|198784
comma
l_int|1
comma
l_int|1109409212
comma
l_int|2
comma
l_int|162
comma
l_int|1
comma
l_int|1075854781
comma
l_int|1
comma
l_int|1073757627
comma
l_int|1
comma
l_int|1075854780
comma
l_int|1
comma
l_int|540672
comma
l_int|1
comma
l_int|10485760
comma
l_int|6
comma
l_int|3145894
comma
l_int|16
comma
l_int|274741248
comma
l_int|9
comma
l_int|168
comma
l_int|3
comma
l_int|4194304
comma
l_int|3
comma
l_int|4209949
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|256
comma
l_int|14
comma
l_int|174
comma
l_int|1
comma
l_int|114857
comma
l_int|1
comma
l_int|33560007
comma
l_int|12
comma
l_int|176
comma
l_int|0
comma
l_int|10240
comma
l_int|1
comma
l_int|114858
comma
l_int|1
comma
l_int|33560018
comma
l_int|1
comma
l_int|114857
comma
l_int|3
comma
l_int|33560007
comma
l_int|1
comma
l_int|16008
comma
l_int|1
comma
l_int|114874
comma
l_int|1
comma
l_int|33560360
comma
l_int|1
comma
l_int|114875
comma
l_int|1
comma
l_int|33560154
comma
l_int|0
comma
l_int|15963
comma
l_int|0
comma
l_int|256
comma
l_int|0
comma
l_int|4096
comma
l_int|1
comma
l_int|409611
comma
l_int|9
comma
l_int|188
comma
l_int|0
comma
l_int|10240
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
DECL|function|R128_READ_PLL
r_int
id|R128_READ_PLL
c_func
(paren
id|drm_device_t
op_star
id|dev
comma
r_int
id|addr
)paren
(brace
id|drm_r128_private_t
op_star
id|dev_priv
op_assign
id|dev-&gt;dev_private
suffix:semicolon
id|R128_WRITE8
c_func
(paren
id|R128_CLOCK_CNTL_INDEX
comma
id|addr
op_amp
l_int|0x1f
)paren
suffix:semicolon
r_return
id|R128_READ
c_func
(paren
id|R128_CLOCK_CNTL_DATA
)paren
suffix:semicolon
)brace
macro_line|#if R128_FIFO_DEBUG
DECL|function|r128_status
r_static
r_void
id|r128_status
c_func
(paren
id|drm_r128_private_t
op_star
id|dev_priv
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;GUI_STAT           = 0x%08x&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|R128_READ
c_func
(paren
id|R128_GUI_STAT
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;PM4_STAT           = 0x%08x&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|R128_READ
c_func
(paren
id|R128_PM4_STAT
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;PM4_BUFFER_DL_WPTR = 0x%08x&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|R128_READ
c_func
(paren
id|R128_PM4_BUFFER_DL_WPTR
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;PM4_BUFFER_DL_RPTR = 0x%08x&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|R128_READ
c_func
(paren
id|R128_PM4_BUFFER_DL_RPTR
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;PM4_MICRO_CNTL     = 0x%08x&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|R128_READ
c_func
(paren
id|R128_PM4_MICRO_CNTL
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;PM4_BUFFER_CNTL    = 0x%08x&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|R128_READ
c_func
(paren
id|R128_PM4_BUFFER_CNTL
)paren
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* ================================================================&n; * Engine, FIFO control&n; */
DECL|function|r128_do_pixcache_flush
r_static
r_int
id|r128_do_pixcache_flush
c_func
(paren
id|drm_r128_private_t
op_star
id|dev_priv
)paren
(brace
id|u32
id|tmp
suffix:semicolon
r_int
id|i
suffix:semicolon
id|tmp
op_assign
id|R128_READ
c_func
(paren
id|R128_PC_NGUI_CTLSTAT
)paren
op_or
id|R128_PC_FLUSH_ALL
suffix:semicolon
id|R128_WRITE
c_func
(paren
id|R128_PC_NGUI_CTLSTAT
comma
id|tmp
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dev_priv-&gt;usec_timeout
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|R128_READ
c_func
(paren
id|R128_PC_NGUI_CTLSTAT
)paren
op_amp
id|R128_PC_BUSY
)paren
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|DRM_UDELAY
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
macro_line|#if R128_FIFO_DEBUG
id|DRM_ERROR
c_func
(paren
l_string|&quot;failed!&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
id|DRM_ERR
c_func
(paren
id|EBUSY
)paren
suffix:semicolon
)brace
DECL|function|r128_do_wait_for_fifo
r_static
r_int
id|r128_do_wait_for_fifo
c_func
(paren
id|drm_r128_private_t
op_star
id|dev_priv
comma
r_int
id|entries
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dev_priv-&gt;usec_timeout
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
id|slots
op_assign
id|R128_READ
c_func
(paren
id|R128_GUI_STAT
)paren
op_amp
id|R128_GUI_FIFOCNT_MASK
suffix:semicolon
r_if
c_cond
(paren
id|slots
op_ge
id|entries
)paren
r_return
l_int|0
suffix:semicolon
id|DRM_UDELAY
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
macro_line|#if R128_FIFO_DEBUG
id|DRM_ERROR
c_func
(paren
l_string|&quot;failed!&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
id|DRM_ERR
c_func
(paren
id|EBUSY
)paren
suffix:semicolon
)brace
DECL|function|r128_do_wait_for_idle
r_static
r_int
id|r128_do_wait_for_idle
c_func
(paren
id|drm_r128_private_t
op_star
id|dev_priv
)paren
(brace
r_int
id|i
comma
id|ret
suffix:semicolon
id|ret
op_assign
id|r128_do_wait_for_fifo
c_func
(paren
id|dev_priv
comma
l_int|64
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_return
id|ret
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dev_priv-&gt;usec_timeout
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|R128_READ
c_func
(paren
id|R128_GUI_STAT
)paren
op_amp
id|R128_GUI_ACTIVE
)paren
)paren
(brace
id|r128_do_pixcache_flush
c_func
(paren
id|dev_priv
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|DRM_UDELAY
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
macro_line|#if R128_FIFO_DEBUG
id|DRM_ERROR
c_func
(paren
l_string|&quot;failed!&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
id|DRM_ERR
c_func
(paren
id|EBUSY
)paren
suffix:semicolon
)brace
multiline_comment|/* ================================================================&n; * CCE control, initialization&n; */
multiline_comment|/* Load the microcode for the CCE */
DECL|function|r128_cce_load_microcode
r_static
r_void
id|r128_cce_load_microcode
c_func
(paren
id|drm_r128_private_t
op_star
id|dev_priv
)paren
(brace
r_int
id|i
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|r128_do_wait_for_idle
c_func
(paren
id|dev_priv
)paren
suffix:semicolon
id|R128_WRITE
c_func
(paren
id|R128_PM4_MICROCODE_ADDR
comma
l_int|0
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|256
suffix:semicolon
id|i
op_increment
)paren
(brace
id|R128_WRITE
c_func
(paren
id|R128_PM4_MICROCODE_DATAH
comma
id|r128_cce_microcode
(braket
id|i
op_star
l_int|2
)braket
)paren
suffix:semicolon
id|R128_WRITE
c_func
(paren
id|R128_PM4_MICROCODE_DATAL
comma
id|r128_cce_microcode
(braket
id|i
op_star
l_int|2
op_plus
l_int|1
)braket
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Flush any pending commands to the CCE.  This should only be used just&n; * prior to a wait for idle, as it informs the engine that the command&n; * stream is ending.&n; */
DECL|function|r128_do_cce_flush
r_static
r_void
id|r128_do_cce_flush
c_func
(paren
id|drm_r128_private_t
op_star
id|dev_priv
)paren
(brace
id|u32
id|tmp
suffix:semicolon
id|tmp
op_assign
id|R128_READ
c_func
(paren
id|R128_PM4_BUFFER_DL_WPTR
)paren
op_or
id|R128_PM4_BUFFER_DL_DONE
suffix:semicolon
id|R128_WRITE
c_func
(paren
id|R128_PM4_BUFFER_DL_WPTR
comma
id|tmp
)paren
suffix:semicolon
)brace
multiline_comment|/* Wait for the CCE to go idle.&n; */
DECL|function|r128_do_cce_idle
r_int
id|r128_do_cce_idle
c_func
(paren
id|drm_r128_private_t
op_star
id|dev_priv
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dev_priv-&gt;usec_timeout
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|GET_RING_HEAD
c_func
(paren
id|dev_priv
)paren
op_eq
id|dev_priv-&gt;ring.tail
)paren
(brace
r_int
id|pm4stat
op_assign
id|R128_READ
c_func
(paren
id|R128_PM4_STAT
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|pm4stat
op_amp
id|R128_PM4_FIFOCNT_MASK
)paren
op_ge
id|dev_priv-&gt;cce_fifo_size
)paren
op_logical_and
op_logical_neg
(paren
id|pm4stat
op_amp
(paren
id|R128_PM4_BUSY
op_or
id|R128_PM4_GUI_ACTIVE
)paren
)paren
)paren
(brace
r_return
id|r128_do_pixcache_flush
c_func
(paren
id|dev_priv
)paren
suffix:semicolon
)brace
)brace
id|DRM_UDELAY
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
macro_line|#if R128_FIFO_DEBUG
id|DRM_ERROR
c_func
(paren
l_string|&quot;failed!&bslash;n&quot;
)paren
suffix:semicolon
id|r128_status
c_func
(paren
id|dev_priv
)paren
suffix:semicolon
macro_line|#endif
r_return
id|DRM_ERR
c_func
(paren
id|EBUSY
)paren
suffix:semicolon
)brace
multiline_comment|/* Start the Concurrent Command Engine.&n; */
DECL|function|r128_do_cce_start
r_static
r_void
id|r128_do_cce_start
c_func
(paren
id|drm_r128_private_t
op_star
id|dev_priv
)paren
(brace
id|r128_do_wait_for_idle
c_func
(paren
id|dev_priv
)paren
suffix:semicolon
id|R128_WRITE
c_func
(paren
id|R128_PM4_BUFFER_CNTL
comma
id|dev_priv-&gt;cce_mode
op_or
id|dev_priv-&gt;ring.size_l2qw
op_or
id|R128_PM4_BUFFER_CNTL_NOUPDATE
)paren
suffix:semicolon
id|R128_READ
c_func
(paren
id|R128_PM4_BUFFER_ADDR
)paren
suffix:semicolon
multiline_comment|/* as per the sample code */
id|R128_WRITE
c_func
(paren
id|R128_PM4_MICRO_CNTL
comma
id|R128_PM4_MICRO_FREERUN
)paren
suffix:semicolon
id|dev_priv-&gt;cce_running
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Reset the Concurrent Command Engine.  This will not flush any pending&n; * commands, so you must wait for the CCE command stream to complete&n; * before calling this routine.&n; */
DECL|function|r128_do_cce_reset
r_static
r_void
id|r128_do_cce_reset
c_func
(paren
id|drm_r128_private_t
op_star
id|dev_priv
)paren
(brace
id|R128_WRITE
c_func
(paren
id|R128_PM4_BUFFER_DL_WPTR
comma
l_int|0
)paren
suffix:semicolon
id|R128_WRITE
c_func
(paren
id|R128_PM4_BUFFER_DL_RPTR
comma
l_int|0
)paren
suffix:semicolon
id|dev_priv-&gt;ring.tail
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Stop the Concurrent Command Engine.  This will not flush any pending&n; * commands, so you must flush the command stream and wait for the CCE&n; * to go idle before calling this routine.&n; */
DECL|function|r128_do_cce_stop
r_static
r_void
id|r128_do_cce_stop
c_func
(paren
id|drm_r128_private_t
op_star
id|dev_priv
)paren
(brace
id|R128_WRITE
c_func
(paren
id|R128_PM4_MICRO_CNTL
comma
l_int|0
)paren
suffix:semicolon
id|R128_WRITE
c_func
(paren
id|R128_PM4_BUFFER_CNTL
comma
id|R128_PM4_NONPM4
op_or
id|R128_PM4_BUFFER_CNTL_NOUPDATE
)paren
suffix:semicolon
id|dev_priv-&gt;cce_running
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Reset the engine.  This will stop the CCE if it is running.&n; */
DECL|function|r128_do_engine_reset
r_static
r_int
id|r128_do_engine_reset
c_func
(paren
id|drm_device_t
op_star
id|dev
)paren
(brace
id|drm_r128_private_t
op_star
id|dev_priv
op_assign
id|dev-&gt;dev_private
suffix:semicolon
id|u32
id|clock_cntl_index
comma
id|mclk_cntl
comma
id|gen_reset_cntl
suffix:semicolon
id|r128_do_pixcache_flush
c_func
(paren
id|dev_priv
)paren
suffix:semicolon
id|clock_cntl_index
op_assign
id|R128_READ
c_func
(paren
id|R128_CLOCK_CNTL_INDEX
)paren
suffix:semicolon
id|mclk_cntl
op_assign
id|R128_READ_PLL
c_func
(paren
id|dev
comma
id|R128_MCLK_CNTL
)paren
suffix:semicolon
id|R128_WRITE_PLL
c_func
(paren
id|R128_MCLK_CNTL
comma
id|mclk_cntl
op_or
id|R128_FORCE_GCP
op_or
id|R128_FORCE_PIPE3D_CP
)paren
suffix:semicolon
id|gen_reset_cntl
op_assign
id|R128_READ
c_func
(paren
id|R128_GEN_RESET_CNTL
)paren
suffix:semicolon
multiline_comment|/* Taken from the sample code - do not change */
id|R128_WRITE
c_func
(paren
id|R128_GEN_RESET_CNTL
comma
id|gen_reset_cntl
op_or
id|R128_SOFT_RESET_GUI
)paren
suffix:semicolon
id|R128_READ
c_func
(paren
id|R128_GEN_RESET_CNTL
)paren
suffix:semicolon
id|R128_WRITE
c_func
(paren
id|R128_GEN_RESET_CNTL
comma
id|gen_reset_cntl
op_amp
op_complement
id|R128_SOFT_RESET_GUI
)paren
suffix:semicolon
id|R128_READ
c_func
(paren
id|R128_GEN_RESET_CNTL
)paren
suffix:semicolon
id|R128_WRITE_PLL
c_func
(paren
id|R128_MCLK_CNTL
comma
id|mclk_cntl
)paren
suffix:semicolon
id|R128_WRITE
c_func
(paren
id|R128_CLOCK_CNTL_INDEX
comma
id|clock_cntl_index
)paren
suffix:semicolon
id|R128_WRITE
c_func
(paren
id|R128_GEN_RESET_CNTL
comma
id|gen_reset_cntl
)paren
suffix:semicolon
multiline_comment|/* Reset the CCE ring */
id|r128_do_cce_reset
c_func
(paren
id|dev_priv
)paren
suffix:semicolon
multiline_comment|/* The CCE is no longer running after an engine reset */
id|dev_priv-&gt;cce_running
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Reset any pending vertex, indirect buffers */
id|r128_freelist_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|r128_cce_init_ring_buffer
r_static
r_void
id|r128_cce_init_ring_buffer
c_func
(paren
id|drm_device_t
op_star
id|dev
comma
id|drm_r128_private_t
op_star
id|dev_priv
)paren
(brace
id|u32
id|ring_start
suffix:semicolon
id|u32
id|tmp
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* The manual (p. 2) says this address is in &quot;VM space&quot;.  This&n;&t; * means it&squot;s an offset from the start of AGP space.&n;&t; */
macro_line|#if __REALLY_HAVE_AGP
r_if
c_cond
(paren
op_logical_neg
id|dev_priv-&gt;is_pci
)paren
id|ring_start
op_assign
id|dev_priv-&gt;cce_ring-&gt;offset
op_minus
id|dev-&gt;agp-&gt;base
suffix:semicolon
r_else
macro_line|#endif
id|ring_start
op_assign
id|dev_priv-&gt;cce_ring-&gt;offset
op_minus
id|dev-&gt;sg-&gt;handle
suffix:semicolon
id|R128_WRITE
c_func
(paren
id|R128_PM4_BUFFER_OFFSET
comma
id|ring_start
op_or
id|R128_AGP_OFFSET
)paren
suffix:semicolon
id|R128_WRITE
c_func
(paren
id|R128_PM4_BUFFER_DL_WPTR
comma
l_int|0
)paren
suffix:semicolon
id|R128_WRITE
c_func
(paren
id|R128_PM4_BUFFER_DL_RPTR
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Set watermark control */
id|R128_WRITE
c_func
(paren
id|R128_PM4_BUFFER_WM_CNTL
comma
(paren
(paren
id|R128_WATERMARK_L
op_div
l_int|4
)paren
op_lshift
id|R128_WMA_SHIFT
)paren
op_or
(paren
(paren
id|R128_WATERMARK_M
op_div
l_int|4
)paren
op_lshift
id|R128_WMB_SHIFT
)paren
op_or
(paren
(paren
id|R128_WATERMARK_N
op_div
l_int|4
)paren
op_lshift
id|R128_WMC_SHIFT
)paren
op_or
(paren
(paren
id|R128_WATERMARK_K
op_div
l_int|64
)paren
op_lshift
id|R128_WB_WM_SHIFT
)paren
)paren
suffix:semicolon
multiline_comment|/* Force read.  Why?  Because it&squot;s in the examples... */
id|R128_READ
c_func
(paren
id|R128_PM4_BUFFER_ADDR
)paren
suffix:semicolon
multiline_comment|/* Turn on bus mastering */
id|tmp
op_assign
id|R128_READ
c_func
(paren
id|R128_BUS_CNTL
)paren
op_amp
op_complement
id|R128_BUS_MASTER_DIS
suffix:semicolon
id|R128_WRITE
c_func
(paren
id|R128_BUS_CNTL
comma
id|tmp
)paren
suffix:semicolon
)brace
DECL|function|r128_do_init_cce
r_static
r_int
id|r128_do_init_cce
c_func
(paren
id|drm_device_t
op_star
id|dev
comma
id|drm_r128_init_t
op_star
id|init
)paren
(brace
id|drm_r128_private_t
op_star
id|dev_priv
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|dev_priv
op_assign
id|DRM
c_func
(paren
id|alloc
)paren
(paren
r_sizeof
(paren
id|drm_r128_private_t
)paren
comma
id|DRM_MEM_DRIVER
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev_priv
op_eq
l_int|NULL
)paren
r_return
id|DRM_ERR
c_func
(paren
id|ENOMEM
)paren
suffix:semicolon
id|memset
c_func
(paren
id|dev_priv
comma
l_int|0
comma
r_sizeof
(paren
id|drm_r128_private_t
)paren
)paren
suffix:semicolon
id|dev_priv-&gt;is_pci
op_assign
id|init-&gt;is_pci
suffix:semicolon
r_if
c_cond
(paren
id|dev_priv-&gt;is_pci
op_logical_and
op_logical_neg
id|dev-&gt;sg
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;PCI GART memory not allocated!&bslash;n&quot;
)paren
suffix:semicolon
id|dev-&gt;dev_private
op_assign
(paren
r_void
op_star
)paren
id|dev_priv
suffix:semicolon
id|r128_do_cleanup_cce
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|DRM_ERR
c_func
(paren
id|EINVAL
)paren
suffix:semicolon
)brace
id|dev_priv-&gt;usec_timeout
op_assign
id|init-&gt;usec_timeout
suffix:semicolon
r_if
c_cond
(paren
id|dev_priv-&gt;usec_timeout
template_param
id|R128_MAX_USEC_TIMEOUT
)paren
(brace
id|DRM_DEBUG
c_func
(paren
l_string|&quot;TIMEOUT problem!&bslash;n&quot;
)paren
suffix:semicolon
id|dev-&gt;dev_private
op_assign
(paren
r_void
op_star
)paren
id|dev_priv
suffix:semicolon
id|r128_do_cleanup_cce
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|DRM_ERR
c_func
(paren
id|EINVAL
)paren
suffix:semicolon
)brace
id|dev_priv-&gt;cce_mode
op_assign
id|init-&gt;cce_mode
suffix:semicolon
multiline_comment|/* GH: Simple idle check.&n;&t; */
id|atomic_set
c_func
(paren
op_amp
id|dev_priv-&gt;idle_count
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* We don&squot;t support anything other than bus-mastering ring mode,&n;&t; * but the ring can be in either AGP or PCI space for the ring&n;&t; * read pointer.&n;&t; */
r_if
c_cond
(paren
(paren
id|init-&gt;cce_mode
op_ne
id|R128_PM4_192BM
)paren
op_logical_and
(paren
id|init-&gt;cce_mode
op_ne
id|R128_PM4_128BM_64INDBM
)paren
op_logical_and
(paren
id|init-&gt;cce_mode
op_ne
id|R128_PM4_64BM_128INDBM
)paren
op_logical_and
(paren
id|init-&gt;cce_mode
op_ne
id|R128_PM4_64BM_64VCBM_64INDBM
)paren
)paren
(brace
id|DRM_DEBUG
c_func
(paren
l_string|&quot;Bad cce_mode!&bslash;n&quot;
)paren
suffix:semicolon
id|dev-&gt;dev_private
op_assign
(paren
r_void
op_star
)paren
id|dev_priv
suffix:semicolon
id|r128_do_cleanup_cce
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|DRM_ERR
c_func
(paren
id|EINVAL
)paren
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|init-&gt;cce_mode
)paren
(brace
r_case
id|R128_PM4_NONPM4
suffix:colon
id|dev_priv-&gt;cce_fifo_size
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|R128_PM4_192PIO
suffix:colon
r_case
id|R128_PM4_192BM
suffix:colon
id|dev_priv-&gt;cce_fifo_size
op_assign
l_int|192
suffix:semicolon
r_break
suffix:semicolon
r_case
id|R128_PM4_128PIO_64INDBM
suffix:colon
r_case
id|R128_PM4_128BM_64INDBM
suffix:colon
id|dev_priv-&gt;cce_fifo_size
op_assign
l_int|128
suffix:semicolon
r_break
suffix:semicolon
r_case
id|R128_PM4_64PIO_128INDBM
suffix:colon
r_case
id|R128_PM4_64BM_128INDBM
suffix:colon
r_case
id|R128_PM4_64PIO_64VCBM_64INDBM
suffix:colon
r_case
id|R128_PM4_64BM_64VCBM_64INDBM
suffix:colon
r_case
id|R128_PM4_64PIO_64VCPIO_64INDPIO
suffix:colon
id|dev_priv-&gt;cce_fifo_size
op_assign
l_int|64
suffix:semicolon
r_break
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|init-&gt;fb_bpp
)paren
(brace
r_case
l_int|16
suffix:colon
id|dev_priv-&gt;color_fmt
op_assign
id|R128_DATATYPE_RGB565
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|32
suffix:colon
r_default
suffix:colon
id|dev_priv-&gt;color_fmt
op_assign
id|R128_DATATYPE_ARGB8888
suffix:semicolon
r_break
suffix:semicolon
)brace
id|dev_priv-&gt;front_offset
op_assign
id|init-&gt;front_offset
suffix:semicolon
id|dev_priv-&gt;front_pitch
op_assign
id|init-&gt;front_pitch
suffix:semicolon
id|dev_priv-&gt;back_offset
op_assign
id|init-&gt;back_offset
suffix:semicolon
id|dev_priv-&gt;back_pitch
op_assign
id|init-&gt;back_pitch
suffix:semicolon
r_switch
c_cond
(paren
id|init-&gt;depth_bpp
)paren
(brace
r_case
l_int|16
suffix:colon
id|dev_priv-&gt;depth_fmt
op_assign
id|R128_DATATYPE_RGB565
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|24
suffix:colon
r_case
l_int|32
suffix:colon
r_default
suffix:colon
id|dev_priv-&gt;depth_fmt
op_assign
id|R128_DATATYPE_ARGB8888
suffix:semicolon
r_break
suffix:semicolon
)brace
id|dev_priv-&gt;depth_offset
op_assign
id|init-&gt;depth_offset
suffix:semicolon
id|dev_priv-&gt;depth_pitch
op_assign
id|init-&gt;depth_pitch
suffix:semicolon
id|dev_priv-&gt;span_offset
op_assign
id|init-&gt;span_offset
suffix:semicolon
id|dev_priv-&gt;front_pitch_offset_c
op_assign
(paren
(paren
(paren
id|dev_priv-&gt;front_pitch
op_div
l_int|8
)paren
op_lshift
l_int|21
)paren
op_or
(paren
id|dev_priv-&gt;front_offset
op_rshift
l_int|5
)paren
)paren
suffix:semicolon
id|dev_priv-&gt;back_pitch_offset_c
op_assign
(paren
(paren
(paren
id|dev_priv-&gt;back_pitch
op_div
l_int|8
)paren
op_lshift
l_int|21
)paren
op_or
(paren
id|dev_priv-&gt;back_offset
op_rshift
l_int|5
)paren
)paren
suffix:semicolon
id|dev_priv-&gt;depth_pitch_offset_c
op_assign
(paren
(paren
(paren
id|dev_priv-&gt;depth_pitch
op_div
l_int|8
)paren
op_lshift
l_int|21
)paren
op_or
(paren
id|dev_priv-&gt;depth_offset
op_rshift
l_int|5
)paren
op_or
id|R128_DST_TILE
)paren
suffix:semicolon
id|dev_priv-&gt;span_pitch_offset_c
op_assign
(paren
(paren
(paren
id|dev_priv-&gt;depth_pitch
op_div
l_int|8
)paren
op_lshift
l_int|21
)paren
op_or
(paren
id|dev_priv-&gt;span_offset
op_rshift
l_int|5
)paren
)paren
suffix:semicolon
id|DRM_GETSAREA
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev_priv-&gt;sarea
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;could not find sarea!&bslash;n&quot;
)paren
suffix:semicolon
id|dev-&gt;dev_private
op_assign
(paren
r_void
op_star
)paren
id|dev_priv
suffix:semicolon
id|r128_do_cleanup_cce
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|DRM_ERR
c_func
(paren
id|EINVAL
)paren
suffix:semicolon
)brace
id|dev_priv-&gt;mmio
op_assign
id|drm_core_findmap
c_func
(paren
id|dev
comma
id|init-&gt;mmio_offset
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev_priv-&gt;mmio
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;could not find mmio region!&bslash;n&quot;
)paren
suffix:semicolon
id|dev-&gt;dev_private
op_assign
(paren
r_void
op_star
)paren
id|dev_priv
suffix:semicolon
id|r128_do_cleanup_cce
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|DRM_ERR
c_func
(paren
id|EINVAL
)paren
suffix:semicolon
)brace
id|dev_priv-&gt;cce_ring
op_assign
id|drm_core_findmap
c_func
(paren
id|dev
comma
id|init-&gt;ring_offset
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev_priv-&gt;cce_ring
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;could not find cce ring region!&bslash;n&quot;
)paren
suffix:semicolon
id|dev-&gt;dev_private
op_assign
(paren
r_void
op_star
)paren
id|dev_priv
suffix:semicolon
id|r128_do_cleanup_cce
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|DRM_ERR
c_func
(paren
id|EINVAL
)paren
suffix:semicolon
)brace
id|dev_priv-&gt;ring_rptr
op_assign
id|drm_core_findmap
c_func
(paren
id|dev
comma
id|init-&gt;ring_rptr_offset
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev_priv-&gt;ring_rptr
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;could not find ring read pointer!&bslash;n&quot;
)paren
suffix:semicolon
id|dev-&gt;dev_private
op_assign
(paren
r_void
op_star
)paren
id|dev_priv
suffix:semicolon
id|r128_do_cleanup_cce
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|DRM_ERR
c_func
(paren
id|EINVAL
)paren
suffix:semicolon
)brace
id|dev-&gt;agp_buffer_map
op_assign
id|drm_core_findmap
c_func
(paren
id|dev
comma
id|init-&gt;buffers_offset
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;agp_buffer_map
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;could not find dma buffer region!&bslash;n&quot;
)paren
suffix:semicolon
id|dev-&gt;dev_private
op_assign
(paren
r_void
op_star
)paren
id|dev_priv
suffix:semicolon
id|r128_do_cleanup_cce
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|DRM_ERR
c_func
(paren
id|EINVAL
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|dev_priv-&gt;is_pci
)paren
(brace
id|dev_priv-&gt;agp_textures
op_assign
id|drm_core_findmap
c_func
(paren
id|dev
comma
id|init-&gt;agp_textures_offset
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev_priv-&gt;agp_textures
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;could not find agp texture region!&bslash;n&quot;
)paren
suffix:semicolon
id|dev-&gt;dev_private
op_assign
(paren
r_void
op_star
)paren
id|dev_priv
suffix:semicolon
id|r128_do_cleanup_cce
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|DRM_ERR
c_func
(paren
id|EINVAL
)paren
suffix:semicolon
)brace
)brace
id|dev_priv-&gt;sarea_priv
op_assign
(paren
id|drm_r128_sarea_t
op_star
)paren
(paren
(paren
id|u8
op_star
)paren
id|dev_priv-&gt;sarea-&gt;handle
op_plus
id|init-&gt;sarea_priv_offset
)paren
suffix:semicolon
macro_line|#if __REALLY_HAVE_AGP
r_if
c_cond
(paren
op_logical_neg
id|dev_priv-&gt;is_pci
)paren
(brace
id|drm_core_ioremap
c_func
(paren
id|dev_priv-&gt;cce_ring
comma
id|dev
)paren
suffix:semicolon
id|drm_core_ioremap
c_func
(paren
id|dev_priv-&gt;ring_rptr
comma
id|dev
)paren
suffix:semicolon
id|drm_core_ioremap
c_func
(paren
id|dev-&gt;agp_buffer_map
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev_priv-&gt;cce_ring-&gt;handle
op_logical_or
op_logical_neg
id|dev_priv-&gt;ring_rptr-&gt;handle
op_logical_or
op_logical_neg
id|dev-&gt;agp_buffer_map-&gt;handle
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;Could not ioremap agp regions!&bslash;n&quot;
)paren
suffix:semicolon
id|dev-&gt;dev_private
op_assign
(paren
r_void
op_star
)paren
id|dev_priv
suffix:semicolon
id|r128_do_cleanup_cce
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|DRM_ERR
c_func
(paren
id|ENOMEM
)paren
suffix:semicolon
)brace
)brace
r_else
macro_line|#endif
(brace
id|dev_priv-&gt;cce_ring-&gt;handle
op_assign
(paren
r_void
op_star
)paren
id|dev_priv-&gt;cce_ring-&gt;offset
suffix:semicolon
id|dev_priv-&gt;ring_rptr-&gt;handle
op_assign
(paren
r_void
op_star
)paren
id|dev_priv-&gt;ring_rptr-&gt;offset
suffix:semicolon
id|dev-&gt;agp_buffer_map-&gt;handle
op_assign
(paren
r_void
op_star
)paren
id|dev-&gt;agp_buffer_map-&gt;offset
suffix:semicolon
)brace
macro_line|#if __REALLY_HAVE_AGP
r_if
c_cond
(paren
op_logical_neg
id|dev_priv-&gt;is_pci
)paren
id|dev_priv-&gt;cce_buffers_offset
op_assign
id|dev-&gt;agp-&gt;base
suffix:semicolon
r_else
macro_line|#endif
id|dev_priv-&gt;cce_buffers_offset
op_assign
id|dev-&gt;sg-&gt;handle
suffix:semicolon
id|dev_priv-&gt;ring.start
op_assign
(paren
id|u32
op_star
)paren
id|dev_priv-&gt;cce_ring-&gt;handle
suffix:semicolon
id|dev_priv-&gt;ring.end
op_assign
(paren
(paren
id|u32
op_star
)paren
id|dev_priv-&gt;cce_ring-&gt;handle
op_plus
id|init-&gt;ring_size
op_div
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
id|dev_priv-&gt;ring.size
op_assign
id|init-&gt;ring_size
suffix:semicolon
id|dev_priv-&gt;ring.size_l2qw
op_assign
id|DRM
c_func
(paren
id|order
)paren
(paren
id|init-&gt;ring_size
op_div
l_int|8
)paren
suffix:semicolon
id|dev_priv-&gt;ring.tail_mask
op_assign
(paren
id|dev_priv-&gt;ring.size
op_div
r_sizeof
(paren
id|u32
)paren
)paren
op_minus
l_int|1
suffix:semicolon
id|dev_priv-&gt;ring.high_mark
op_assign
l_int|128
suffix:semicolon
id|dev_priv-&gt;sarea_priv-&gt;last_frame
op_assign
l_int|0
suffix:semicolon
id|R128_WRITE
c_func
(paren
id|R128_LAST_FRAME_REG
comma
id|dev_priv-&gt;sarea_priv-&gt;last_frame
)paren
suffix:semicolon
id|dev_priv-&gt;sarea_priv-&gt;last_dispatch
op_assign
l_int|0
suffix:semicolon
id|R128_WRITE
c_func
(paren
id|R128_LAST_DISPATCH_REG
comma
id|dev_priv-&gt;sarea_priv-&gt;last_dispatch
)paren
suffix:semicolon
macro_line|#if __REALLY_HAVE_AGP
r_if
c_cond
(paren
id|dev_priv-&gt;is_pci
)paren
(brace
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|DRM
c_func
(paren
id|ati_pcigart_init
)paren
(paren
id|dev
comma
op_amp
id|dev_priv-&gt;phys_pci_gart
comma
op_amp
id|dev_priv-&gt;bus_pci_gart
)paren
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;failed to init PCI GART!&bslash;n&quot;
)paren
suffix:semicolon
id|dev-&gt;dev_private
op_assign
(paren
r_void
op_star
)paren
id|dev_priv
suffix:semicolon
id|r128_do_cleanup_cce
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|DRM_ERR
c_func
(paren
id|ENOMEM
)paren
suffix:semicolon
)brace
id|R128_WRITE
c_func
(paren
id|R128_PCI_GART_PAGE
comma
id|dev_priv-&gt;bus_pci_gart
)paren
suffix:semicolon
macro_line|#if __REALLY_HAVE_AGP
)brace
macro_line|#endif
id|r128_cce_init_ring_buffer
c_func
(paren
id|dev
comma
id|dev_priv
)paren
suffix:semicolon
id|r128_cce_load_microcode
c_func
(paren
id|dev_priv
)paren
suffix:semicolon
id|dev-&gt;dev_private
op_assign
(paren
r_void
op_star
)paren
id|dev_priv
suffix:semicolon
id|r128_do_engine_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|r128_do_cleanup_cce
r_int
id|r128_do_cleanup_cce
c_func
(paren
id|drm_device_t
op_star
id|dev
)paren
(brace
macro_line|#if __HAVE_IRQ
multiline_comment|/* Make sure interrupts are disabled here because the uninstall ioctl&n;&t; * may not have been called from userspace and after dev_private&n;&t; * is freed, it&squot;s too late.&n;&t; */
r_if
c_cond
(paren
id|dev-&gt;irq_enabled
)paren
id|DRM
c_func
(paren
id|irq_uninstall
)paren
(paren
id|dev
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|dev-&gt;dev_private
)paren
(brace
id|drm_r128_private_t
op_star
id|dev_priv
op_assign
id|dev-&gt;dev_private
suffix:semicolon
macro_line|#if __REALLY_HAVE_AGP
r_if
c_cond
(paren
op_logical_neg
id|dev_priv-&gt;is_pci
)paren
(brace
r_if
c_cond
(paren
id|dev_priv-&gt;cce_ring
op_ne
l_int|NULL
)paren
id|drm_core_ioremapfree
c_func
(paren
id|dev_priv-&gt;cce_ring
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev_priv-&gt;ring_rptr
op_ne
l_int|NULL
)paren
id|drm_core_ioremapfree
c_func
(paren
id|dev_priv-&gt;ring_rptr
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;agp_buffer_map
op_ne
l_int|NULL
)paren
id|drm_core_ioremapfree
c_func
(paren
id|dev-&gt;agp_buffer_map
comma
id|dev
)paren
suffix:semicolon
)brace
r_else
macro_line|#endif
(brace
r_if
c_cond
(paren
op_logical_neg
id|DRM
c_func
(paren
id|ati_pcigart_cleanup
)paren
(paren
id|dev
comma
id|dev_priv-&gt;phys_pci_gart
comma
id|dev_priv-&gt;bus_pci_gart
)paren
)paren
id|DRM_ERROR
c_func
(paren
l_string|&quot;failed to cleanup PCI GART!&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|DRM
c_func
(paren
id|free
)paren
(paren
id|dev-&gt;dev_private
comma
r_sizeof
(paren
id|drm_r128_private_t
)paren
comma
id|DRM_MEM_DRIVER
)paren
suffix:semicolon
id|dev-&gt;dev_private
op_assign
l_int|NULL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|r128_cce_init
r_int
id|r128_cce_init
c_func
(paren
id|DRM_IOCTL_ARGS
)paren
(brace
id|DRM_DEVICE
suffix:semicolon
id|drm_r128_init_t
id|init
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|LOCK_TEST_WITH_RETURN
c_func
(paren
id|dev
comma
id|filp
)paren
suffix:semicolon
id|DRM_COPY_FROM_USER_IOCTL
c_func
(paren
id|init
comma
(paren
id|drm_r128_init_t
id|__user
op_star
)paren
id|data
comma
r_sizeof
(paren
id|init
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|init.func
)paren
(brace
r_case
id|R128_INIT_CCE
suffix:colon
r_return
id|r128_do_init_cce
c_func
(paren
id|dev
comma
op_amp
id|init
)paren
suffix:semicolon
r_case
id|R128_CLEANUP_CCE
suffix:colon
r_return
id|r128_do_cleanup_cce
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_return
id|DRM_ERR
c_func
(paren
id|EINVAL
)paren
suffix:semicolon
)brace
DECL|function|r128_cce_start
r_int
id|r128_cce_start
c_func
(paren
id|DRM_IOCTL_ARGS
)paren
(brace
id|DRM_DEVICE
suffix:semicolon
id|drm_r128_private_t
op_star
id|dev_priv
op_assign
id|dev-&gt;dev_private
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|LOCK_TEST_WITH_RETURN
c_func
(paren
id|dev
comma
id|filp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev_priv-&gt;cce_running
op_logical_or
id|dev_priv-&gt;cce_mode
op_eq
id|R128_PM4_NONPM4
)paren
(brace
id|DRM_DEBUG
c_func
(paren
l_string|&quot;%s while CCE running&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|r128_do_cce_start
c_func
(paren
id|dev_priv
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Stop the CCE.  The engine must have been idled before calling this&n; * routine.&n; */
DECL|function|r128_cce_stop
r_int
id|r128_cce_stop
c_func
(paren
id|DRM_IOCTL_ARGS
)paren
(brace
id|DRM_DEVICE
suffix:semicolon
id|drm_r128_private_t
op_star
id|dev_priv
op_assign
id|dev-&gt;dev_private
suffix:semicolon
id|drm_r128_cce_stop_t
id|stop
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|LOCK_TEST_WITH_RETURN
c_func
(paren
id|dev
comma
id|filp
)paren
suffix:semicolon
id|DRM_COPY_FROM_USER_IOCTL
c_func
(paren
id|stop
comma
(paren
id|drm_r128_cce_stop_t
id|__user
op_star
)paren
id|data
comma
r_sizeof
(paren
id|stop
)paren
)paren
suffix:semicolon
multiline_comment|/* Flush any pending CCE commands.  This ensures any outstanding&n;&t; * commands are exectuted by the engine before we turn it off.&n;&t; */
r_if
c_cond
(paren
id|stop.flush
)paren
(brace
id|r128_do_cce_flush
c_func
(paren
id|dev_priv
)paren
suffix:semicolon
)brace
multiline_comment|/* If we fail to make the engine go idle, we return an error&n;&t; * code so that the DRM ioctl wrapper can try again.&n;&t; */
r_if
c_cond
(paren
id|stop.idle
)paren
(brace
id|ret
op_assign
id|r128_do_cce_idle
c_func
(paren
id|dev_priv
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* Finally, we can turn off the CCE.  If the engine isn&squot;t idle,&n;&t; * we will get some dropped triangles as they won&squot;t be fully&n;&t; * rendered before the CCE is shut down.&n;&t; */
id|r128_do_cce_stop
c_func
(paren
id|dev_priv
)paren
suffix:semicolon
multiline_comment|/* Reset the engine */
id|r128_do_engine_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Just reset the CCE ring.  Called as part of an X Server engine reset.&n; */
DECL|function|r128_cce_reset
r_int
id|r128_cce_reset
c_func
(paren
id|DRM_IOCTL_ARGS
)paren
(brace
id|DRM_DEVICE
suffix:semicolon
id|drm_r128_private_t
op_star
id|dev_priv
op_assign
id|dev-&gt;dev_private
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|LOCK_TEST_WITH_RETURN
c_func
(paren
id|dev
comma
id|filp
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev_priv
)paren
(brace
id|DRM_DEBUG
c_func
(paren
l_string|&quot;%s called before init done&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
id|DRM_ERR
c_func
(paren
id|EINVAL
)paren
suffix:semicolon
)brace
id|r128_do_cce_reset
c_func
(paren
id|dev_priv
)paren
suffix:semicolon
multiline_comment|/* The CCE is no longer running after an engine reset */
id|dev_priv-&gt;cce_running
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|r128_cce_idle
r_int
id|r128_cce_idle
c_func
(paren
id|DRM_IOCTL_ARGS
)paren
(brace
id|DRM_DEVICE
suffix:semicolon
id|drm_r128_private_t
op_star
id|dev_priv
op_assign
id|dev-&gt;dev_private
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|LOCK_TEST_WITH_RETURN
c_func
(paren
id|dev
comma
id|filp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev_priv-&gt;cce_running
)paren
(brace
id|r128_do_cce_flush
c_func
(paren
id|dev_priv
)paren
suffix:semicolon
)brace
r_return
id|r128_do_cce_idle
c_func
(paren
id|dev_priv
)paren
suffix:semicolon
)brace
DECL|function|r128_engine_reset
r_int
id|r128_engine_reset
c_func
(paren
id|DRM_IOCTL_ARGS
)paren
(brace
id|DRM_DEVICE
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|LOCK_TEST_WITH_RETURN
c_func
(paren
id|dev
comma
id|filp
)paren
suffix:semicolon
r_return
id|r128_do_engine_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
DECL|function|r128_fullscreen
r_int
id|r128_fullscreen
c_func
(paren
id|DRM_IOCTL_ARGS
)paren
(brace
r_return
id|DRM_ERR
c_func
(paren
id|EINVAL
)paren
suffix:semicolon
)brace
multiline_comment|/* ================================================================&n; * Freelist management&n; */
DECL|macro|R128_BUFFER_USED
mdefine_line|#define R128_BUFFER_USED&t;0xffffffff
DECL|macro|R128_BUFFER_FREE
mdefine_line|#define R128_BUFFER_FREE&t;0
macro_line|#if 0
r_static
r_int
id|r128_freelist_init
c_func
(paren
id|drm_device_t
op_star
id|dev
)paren
(brace
id|drm_device_dma_t
op_star
id|dma
op_assign
id|dev-&gt;dma
suffix:semicolon
id|drm_r128_private_t
op_star
id|dev_priv
op_assign
id|dev-&gt;dev_private
suffix:semicolon
id|drm_buf_t
op_star
id|buf
suffix:semicolon
id|drm_r128_buf_priv_t
op_star
id|buf_priv
suffix:semicolon
id|drm_r128_freelist_t
op_star
id|entry
suffix:semicolon
r_int
id|i
suffix:semicolon
id|dev_priv-&gt;head
op_assign
id|DRM
c_func
(paren
id|alloc
)paren
(paren
r_sizeof
(paren
id|drm_r128_freelist_t
)paren
comma
id|DRM_MEM_DRIVER
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev_priv-&gt;head
op_eq
l_int|NULL
)paren
r_return
id|DRM_ERR
c_func
(paren
id|ENOMEM
)paren
suffix:semicolon
id|memset
c_func
(paren
id|dev_priv-&gt;head
comma
l_int|0
comma
r_sizeof
(paren
id|drm_r128_freelist_t
)paren
)paren
suffix:semicolon
id|dev_priv-&gt;head-&gt;age
op_assign
id|R128_BUFFER_USED
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dma-&gt;buf_count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|buf
op_assign
id|dma-&gt;buflist
(braket
id|i
)braket
suffix:semicolon
id|buf_priv
op_assign
id|buf-&gt;dev_private
suffix:semicolon
id|entry
op_assign
id|DRM
c_func
(paren
id|alloc
)paren
(paren
r_sizeof
(paren
id|drm_r128_freelist_t
)paren
comma
id|DRM_MEM_DRIVER
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|entry
)paren
r_return
id|DRM_ERR
c_func
(paren
id|ENOMEM
)paren
suffix:semicolon
id|entry-&gt;age
op_assign
id|R128_BUFFER_FREE
suffix:semicolon
id|entry-&gt;buf
op_assign
id|buf
suffix:semicolon
id|entry-&gt;prev
op_assign
id|dev_priv-&gt;head
suffix:semicolon
id|entry-&gt;next
op_assign
id|dev_priv-&gt;head-&gt;next
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|entry-&gt;next
)paren
id|dev_priv-&gt;tail
op_assign
id|entry
suffix:semicolon
id|buf_priv-&gt;discard
op_assign
l_int|0
suffix:semicolon
id|buf_priv-&gt;dispatched
op_assign
l_int|0
suffix:semicolon
id|buf_priv-&gt;list_entry
op_assign
id|entry
suffix:semicolon
id|dev_priv-&gt;head-&gt;next
op_assign
id|entry
suffix:semicolon
r_if
c_cond
(paren
id|dev_priv-&gt;head-&gt;next
)paren
id|dev_priv-&gt;head-&gt;next-&gt;prev
op_assign
id|entry
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
DECL|function|r128_freelist_get
id|drm_buf_t
op_star
id|r128_freelist_get
c_func
(paren
id|drm_device_t
op_star
id|dev
)paren
(brace
id|drm_device_dma_t
op_star
id|dma
op_assign
id|dev-&gt;dma
suffix:semicolon
id|drm_r128_private_t
op_star
id|dev_priv
op_assign
id|dev-&gt;dev_private
suffix:semicolon
id|drm_r128_buf_priv_t
op_star
id|buf_priv
suffix:semicolon
id|drm_buf_t
op_star
id|buf
suffix:semicolon
r_int
id|i
comma
id|t
suffix:semicolon
multiline_comment|/* FIXME: Optimize -- use freelist code */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dma-&gt;buf_count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|buf
op_assign
id|dma-&gt;buflist
(braket
id|i
)braket
suffix:semicolon
id|buf_priv
op_assign
id|buf-&gt;dev_private
suffix:semicolon
r_if
c_cond
(paren
id|buf-&gt;filp
op_eq
l_int|0
)paren
r_return
id|buf
suffix:semicolon
)brace
r_for
c_loop
(paren
id|t
op_assign
l_int|0
suffix:semicolon
id|t
OL
id|dev_priv-&gt;usec_timeout
suffix:semicolon
id|t
op_increment
)paren
(brace
id|u32
id|done_age
op_assign
id|R128_READ
c_func
(paren
id|R128_LAST_DISPATCH_REG
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dma-&gt;buf_count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|buf
op_assign
id|dma-&gt;buflist
(braket
id|i
)braket
suffix:semicolon
id|buf_priv
op_assign
id|buf-&gt;dev_private
suffix:semicolon
r_if
c_cond
(paren
id|buf-&gt;pending
op_logical_and
id|buf_priv-&gt;age
op_le
id|done_age
)paren
(brace
multiline_comment|/* The buffer has been processed, so it&n;&t;&t;&t;&t; * can now be used.&n;&t;&t;&t;&t; */
id|buf-&gt;pending
op_assign
l_int|0
suffix:semicolon
r_return
id|buf
suffix:semicolon
)brace
)brace
id|DRM_UDELAY
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
id|DRM_DEBUG
c_func
(paren
l_string|&quot;returning NULL!&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|r128_freelist_reset
r_void
id|r128_freelist_reset
c_func
(paren
id|drm_device_t
op_star
id|dev
)paren
(brace
id|drm_device_dma_t
op_star
id|dma
op_assign
id|dev-&gt;dma
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dma-&gt;buf_count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|drm_buf_t
op_star
id|buf
op_assign
id|dma-&gt;buflist
(braket
id|i
)braket
suffix:semicolon
id|drm_r128_buf_priv_t
op_star
id|buf_priv
op_assign
id|buf-&gt;dev_private
suffix:semicolon
id|buf_priv-&gt;age
op_assign
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/* ================================================================&n; * CCE command submission&n; */
DECL|function|r128_wait_ring
r_int
id|r128_wait_ring
c_func
(paren
id|drm_r128_private_t
op_star
id|dev_priv
comma
r_int
id|n
)paren
(brace
id|drm_r128_ring_buffer_t
op_star
id|ring
op_assign
op_amp
id|dev_priv-&gt;ring
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dev_priv-&gt;usec_timeout
suffix:semicolon
id|i
op_increment
)paren
(brace
id|r128_update_ring_snapshot
c_func
(paren
id|dev_priv
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ring-&gt;space
op_ge
id|n
)paren
r_return
l_int|0
suffix:semicolon
id|DRM_UDELAY
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/* FIXME: This is being ignored... */
id|DRM_ERROR
c_func
(paren
l_string|&quot;failed!&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|DRM_ERR
c_func
(paren
id|EBUSY
)paren
suffix:semicolon
)brace
DECL|function|r128_cce_get_buffers
r_static
r_int
id|r128_cce_get_buffers
c_func
(paren
id|DRMFILE
id|filp
comma
id|drm_device_t
op_star
id|dev
comma
id|drm_dma_t
op_star
id|d
)paren
(brace
r_int
id|i
suffix:semicolon
id|drm_buf_t
op_star
id|buf
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|d-&gt;granted_count
suffix:semicolon
id|i
OL
id|d-&gt;request_count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|buf
op_assign
id|r128_freelist_get
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|buf
)paren
r_return
id|DRM_ERR
c_func
(paren
id|EAGAIN
)paren
suffix:semicolon
id|buf-&gt;filp
op_assign
id|filp
suffix:semicolon
r_if
c_cond
(paren
id|DRM_COPY_TO_USER
c_func
(paren
op_amp
id|d-&gt;request_indices
(braket
id|i
)braket
comma
op_amp
id|buf-&gt;idx
comma
r_sizeof
(paren
id|buf-&gt;idx
)paren
)paren
)paren
r_return
id|DRM_ERR
c_func
(paren
id|EFAULT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|DRM_COPY_TO_USER
c_func
(paren
op_amp
id|d-&gt;request_sizes
(braket
id|i
)braket
comma
op_amp
id|buf-&gt;total
comma
r_sizeof
(paren
id|buf-&gt;total
)paren
)paren
)paren
r_return
id|DRM_ERR
c_func
(paren
id|EFAULT
)paren
suffix:semicolon
id|d-&gt;granted_count
op_increment
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|r128_cce_buffers
r_int
id|r128_cce_buffers
c_func
(paren
id|DRM_IOCTL_ARGS
)paren
(brace
id|DRM_DEVICE
suffix:semicolon
id|drm_device_dma_t
op_star
id|dma
op_assign
id|dev-&gt;dma
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
id|drm_dma_t
id|__user
op_star
id|argp
op_assign
(paren
r_void
id|__user
op_star
)paren
id|data
suffix:semicolon
id|drm_dma_t
id|d
suffix:semicolon
id|LOCK_TEST_WITH_RETURN
c_func
(paren
id|dev
comma
id|filp
)paren
suffix:semicolon
id|DRM_COPY_FROM_USER_IOCTL
c_func
(paren
id|d
comma
id|argp
comma
r_sizeof
(paren
id|d
)paren
)paren
suffix:semicolon
multiline_comment|/* Please don&squot;t send us buffers.&n;&t; */
r_if
c_cond
(paren
id|d.send_count
op_ne
l_int|0
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;Process %d trying to send %d buffers via drmDMA&bslash;n&quot;
comma
id|DRM_CURRENTPID
comma
id|d.send_count
)paren
suffix:semicolon
r_return
id|DRM_ERR
c_func
(paren
id|EINVAL
)paren
suffix:semicolon
)brace
multiline_comment|/* We&squot;ll send you buffers.&n;&t; */
r_if
c_cond
(paren
id|d.request_count
template_param
id|dma-&gt;buf_count
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;Process %d trying to get %d buffers (of %d max)&bslash;n&quot;
comma
id|DRM_CURRENTPID
comma
id|d.request_count
comma
id|dma-&gt;buf_count
)paren
suffix:semicolon
r_return
id|DRM_ERR
c_func
(paren
id|EINVAL
)paren
suffix:semicolon
)brace
id|d.granted_count
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|d.request_count
)paren
(brace
id|ret
op_assign
id|r128_cce_get_buffers
c_func
(paren
id|filp
comma
id|dev
comma
op_amp
id|d
)paren
suffix:semicolon
)brace
id|DRM_COPY_TO_USER_IOCTL
c_func
(paren
id|argp
comma
id|d
comma
r_sizeof
(paren
id|d
)paren
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
eof
