multiline_comment|/**&n; * &bslash;file ati_pcigart.h &n; * ATI PCI GART support&n; *&n; * &bslash;author Gareth Hughes &lt;gareth@valinux.com&gt;&n; */
multiline_comment|/*&n; * Created: Wed Dec 13 21:52:19 2000 by gareth@valinux.com&n; *&n; * Copyright 2000 VA Linux Systems, Inc., Sunnyvale, California.&n; * All Rights Reserved.&n; *&n; * Permission is hereby granted, free of charge, to any person obtaining a&n; * copy of this software and associated documentation files (the &quot;Software&quot;),&n; * to deal in the Software without restriction, including without limitation&n; * the rights to use, copy, modify, merge, publish, distribute, sublicense,&n; * and/or sell copies of the Software, and to permit persons to whom the&n; * Software is furnished to do so, subject to the following conditions:&n; *&n; * The above copyright notice and this permission notice (including the next&n; * paragraph) shall be included in all copies or substantial portions of the&n; * Software.&n; *&n; * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR&n; * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,&n; * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL&n; * PRECISION INSIGHT AND/OR ITS SUPPLIERS BE LIABLE FOR ANY CLAIM, DAMAGES OR&n; * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,&n; * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER&n; * DEALINGS IN THE SOFTWARE.&n; */
macro_line|#include &quot;drmP.h&quot;
macro_line|#if PAGE_SIZE == 65536
DECL|macro|ATI_PCIGART_TABLE_ORDER
macro_line|# define ATI_PCIGART_TABLE_ORDER&t;0
DECL|macro|ATI_PCIGART_TABLE_PAGES
macro_line|# define ATI_PCIGART_TABLE_PAGES&t;(1 &lt;&lt; 0)
macro_line|#elif PAGE_SIZE == 16384
DECL|macro|ATI_PCIGART_TABLE_ORDER
macro_line|# define ATI_PCIGART_TABLE_ORDER&t;1
DECL|macro|ATI_PCIGART_TABLE_PAGES
macro_line|# define ATI_PCIGART_TABLE_PAGES&t;(1 &lt;&lt; 1)
macro_line|#elif PAGE_SIZE == 8192
DECL|macro|ATI_PCIGART_TABLE_ORDER
macro_line|# define ATI_PCIGART_TABLE_ORDER &t;2
DECL|macro|ATI_PCIGART_TABLE_PAGES
macro_line|# define ATI_PCIGART_TABLE_PAGES &t;(1 &lt;&lt; 2)
macro_line|#elif PAGE_SIZE == 4096
DECL|macro|ATI_PCIGART_TABLE_ORDER
macro_line|# define ATI_PCIGART_TABLE_ORDER &t;3
DECL|macro|ATI_PCIGART_TABLE_PAGES
macro_line|# define ATI_PCIGART_TABLE_PAGES &t;(1 &lt;&lt; 3)
macro_line|#else
macro_line|# error - PAGE_SIZE not 64K, 16K, 8K or 4K
macro_line|#endif
DECL|macro|ATI_MAX_PCIGART_PAGES
macro_line|# define ATI_MAX_PCIGART_PAGES&t;&t;8192&t;/**&lt; 32 MB aperture, 4K pages */
DECL|macro|ATI_PCIGART_PAGE_SIZE
macro_line|# define ATI_PCIGART_PAGE_SIZE&t;&t;4096&t;/**&lt; PCI GART page size */
DECL|function|drm_ati_alloc_pcigart_table
r_int
r_int
id|drm_ati_alloc_pcigart_table
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|address
suffix:semicolon
r_struct
id|page
op_star
id|page
suffix:semicolon
r_int
id|i
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|address
op_assign
id|__get_free_pages
c_func
(paren
id|GFP_KERNEL
comma
id|ATI_PCIGART_TABLE_ORDER
)paren
suffix:semicolon
r_if
c_cond
(paren
id|address
op_eq
l_int|0UL
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|page
op_assign
id|virt_to_page
c_func
(paren
id|address
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ATI_PCIGART_TABLE_PAGES
suffix:semicolon
id|i
op_increment
comma
id|page
op_increment
)paren
(brace
id|get_page
c_func
(paren
id|page
)paren
suffix:semicolon
id|SetPageReserved
c_func
(paren
id|page
)paren
suffix:semicolon
)brace
id|DRM_DEBUG
c_func
(paren
l_string|&quot;%s: returning 0x%08lx&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|address
)paren
suffix:semicolon
r_return
id|address
suffix:semicolon
)brace
DECL|function|drm_ati_free_pcigart_table
r_static
r_void
id|drm_ati_free_pcigart_table
c_func
(paren
r_int
r_int
id|address
)paren
(brace
r_struct
id|page
op_star
id|page
suffix:semicolon
r_int
id|i
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|page
op_assign
id|virt_to_page
c_func
(paren
id|address
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ATI_PCIGART_TABLE_PAGES
suffix:semicolon
id|i
op_increment
comma
id|page
op_increment
)paren
(brace
id|__put_page
c_func
(paren
id|page
)paren
suffix:semicolon
id|ClearPageReserved
c_func
(paren
id|page
)paren
suffix:semicolon
)brace
id|free_pages
c_func
(paren
id|address
comma
id|ATI_PCIGART_TABLE_ORDER
)paren
suffix:semicolon
)brace
DECL|function|drm_ati_pcigart_cleanup
r_int
id|drm_ati_pcigart_cleanup
c_func
(paren
id|drm_device_t
op_star
id|dev
comma
r_int
r_int
id|addr
comma
id|dma_addr_t
id|bus_addr
)paren
(brace
id|drm_sg_mem_t
op_star
id|entry
op_assign
id|dev-&gt;sg
suffix:semicolon
r_int
r_int
id|pages
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* we need to support large memory configurations */
r_if
c_cond
(paren
op_logical_neg
id|entry
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;no scatter/gather memory!&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bus_addr
)paren
(brace
id|pci_unmap_single
c_func
(paren
id|dev-&gt;pdev
comma
id|bus_addr
comma
id|ATI_PCIGART_TABLE_PAGES
op_star
id|PAGE_SIZE
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
id|pages
op_assign
(paren
id|entry-&gt;pages
op_le
id|ATI_MAX_PCIGART_PAGES
)paren
ques
c_cond
id|entry-&gt;pages
suffix:colon
id|ATI_MAX_PCIGART_PAGES
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|pages
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|entry-&gt;busaddr
(braket
id|i
)braket
)paren
r_break
suffix:semicolon
id|pci_unmap_single
c_func
(paren
id|dev-&gt;pdev
comma
id|entry-&gt;busaddr
(braket
id|i
)braket
comma
id|PAGE_SIZE
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|addr
)paren
(brace
id|drm_ati_free_pcigart_table
c_func
(paren
id|addr
)paren
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
DECL|variable|drm_ati_pcigart_cleanup
id|EXPORT_SYMBOL
c_func
(paren
id|drm_ati_pcigart_cleanup
)paren
suffix:semicolon
DECL|function|drm_ati_pcigart_init
r_int
id|drm_ati_pcigart_init
c_func
(paren
id|drm_device_t
op_star
id|dev
comma
r_int
r_int
op_star
id|addr
comma
id|dma_addr_t
op_star
id|bus_addr
)paren
(brace
id|drm_sg_mem_t
op_star
id|entry
op_assign
id|dev-&gt;sg
suffix:semicolon
r_int
r_int
id|address
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|pages
suffix:semicolon
id|u32
op_star
id|pci_gart
comma
id|page_base
comma
id|bus_address
op_assign
l_int|0
suffix:semicolon
r_int
id|i
comma
id|j
comma
id|ret
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|entry
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;no scatter/gather memory!&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|done
suffix:semicolon
)brace
id|address
op_assign
id|drm_ati_alloc_pcigart_table
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|address
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;cannot allocate PCI GART page!&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|done
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;pdev
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;PCI device unknown!&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|done
suffix:semicolon
)brace
id|bus_address
op_assign
id|pci_map_single
c_func
(paren
id|dev-&gt;pdev
comma
(paren
r_void
op_star
)paren
id|address
comma
id|ATI_PCIGART_TABLE_PAGES
op_star
id|PAGE_SIZE
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bus_address
op_eq
l_int|0
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;unable to map PCIGART pages!&bslash;n&quot;
)paren
suffix:semicolon
id|drm_ati_free_pcigart_table
c_func
(paren
id|address
)paren
suffix:semicolon
id|address
op_assign
l_int|0
suffix:semicolon
r_goto
id|done
suffix:semicolon
)brace
id|pci_gart
op_assign
(paren
id|u32
op_star
)paren
id|address
suffix:semicolon
id|pages
op_assign
(paren
id|entry-&gt;pages
op_le
id|ATI_MAX_PCIGART_PAGES
)paren
ques
c_cond
id|entry-&gt;pages
suffix:colon
id|ATI_MAX_PCIGART_PAGES
suffix:semicolon
id|memset
c_func
(paren
id|pci_gart
comma
l_int|0
comma
id|ATI_MAX_PCIGART_PAGES
op_star
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|pages
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* we need to support large memory configurations */
id|entry-&gt;busaddr
(braket
id|i
)braket
op_assign
id|pci_map_single
c_func
(paren
id|dev-&gt;pdev
comma
id|page_address
c_func
(paren
id|entry-&gt;pagelist
(braket
id|i
)braket
)paren
comma
id|PAGE_SIZE
comma
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|entry-&gt;busaddr
(braket
id|i
)braket
op_eq
l_int|0
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;unable to map PCIGART pages!&bslash;n&quot;
)paren
suffix:semicolon
id|drm_ati_pcigart_cleanup
c_func
(paren
id|dev
comma
id|address
comma
id|bus_address
)paren
suffix:semicolon
id|address
op_assign
l_int|0
suffix:semicolon
id|bus_address
op_assign
l_int|0
suffix:semicolon
r_goto
id|done
suffix:semicolon
)brace
id|page_base
op_assign
(paren
id|u32
)paren
id|entry-&gt;busaddr
(braket
id|i
)braket
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
(paren
id|PAGE_SIZE
op_div
id|ATI_PCIGART_PAGE_SIZE
)paren
suffix:semicolon
id|j
op_increment
)paren
(brace
op_star
id|pci_gart
op_increment
op_assign
id|cpu_to_le32
c_func
(paren
id|page_base
)paren
suffix:semicolon
id|page_base
op_add_assign
id|ATI_PCIGART_PAGE_SIZE
suffix:semicolon
)brace
)brace
id|ret
op_assign
l_int|1
suffix:semicolon
macro_line|#if defined(__i386__) || defined(__x86_64__)
id|asm
r_volatile
(paren
l_string|&quot;wbinvd&quot;
op_scope_resolution
suffix:colon
l_string|&quot;memory&quot;
)paren
suffix:semicolon
macro_line|#else
id|mb
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
id|done
suffix:colon
op_star
id|addr
op_assign
id|address
suffix:semicolon
op_star
id|bus_addr
op_assign
id|bus_address
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|variable|drm_ati_pcigart_init
id|EXPORT_SYMBOL
c_func
(paren
id|drm_ati_pcigart_init
)paren
suffix:semicolon
eof
