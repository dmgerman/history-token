multiline_comment|/**&n; * &bslash;file drm_stub.h&n; * Stub support&n; *&n; * &bslash;author Rickard E. (Rik) Faith &lt;faith@valinux.com&gt;&n; */
multiline_comment|/*&n; * Created: Fri Jan 19 10:48:35 2001 by faith@acm.org&n; *&n; * Copyright 2001 VA Linux Systems, Inc., Sunnyvale, California.&n; * All Rights Reserved.&n; *&n; * Permission is hereby granted, free of charge, to any person obtaining a&n; * copy of this software and associated documentation files (the &quot;Software&quot;),&n; * to deal in the Software without restriction, including without limitation&n; * the rights to use, copy, modify, merge, publish, distribute, sublicense,&n; * and/or sell copies of the Software, and to permit persons to whom the&n; * Software is furnished to do so, subject to the following conditions:&n; *&n; * The above copyright notice and this permission notice (including the next&n; * paragraph) shall be included in all copies or substantial portions of the&n; * Software.&n; *&n; * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR&n; * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,&n; * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL&n; * PRECISION INSIGHT AND/OR ITS SUPPLIERS BE LIABLE FOR ANY CLAIM, DAMAGES OR&n; * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,&n; * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER&n; * DEALINGS IN THE SOFTWARE.&n; */
macro_line|#include &quot;drmP.h&quot;
DECL|variable|cards_limit
r_static
r_int
r_int
id|cards_limit
op_assign
l_int|16
suffix:semicolon
multiline_comment|/* Enough for one machine */
DECL|variable|debug
r_static
r_int
r_int
id|debug
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* 1 to enable debug output */
DECL|variable|DRIVER_AUTHOR
id|MODULE_AUTHOR
c_func
(paren
id|DRIVER_AUTHOR
)paren
suffix:semicolon
DECL|variable|DRIVER_DESC
id|MODULE_DESCRIPTION
c_func
(paren
id|DRIVER_DESC
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL and additional rights&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|cards_limit
comma
l_string|&quot;Maximum number of graphics cards&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|debug
comma
l_string|&quot;Enable debug output&quot;
)paren
suffix:semicolon
id|module_param
c_func
(paren
id|cards_limit
comma
r_int
comma
l_int|0444
)paren
suffix:semicolon
id|module_param
c_func
(paren
id|debug
comma
r_int
comma
l_int|0666
)paren
suffix:semicolon
id|drm_global_t
op_star
id|DRM
c_func
(paren
id|global
)paren
suffix:semicolon
multiline_comment|/**&n; * File &bslash;c open operation.&n; *&n; * &bslash;param inode device inode.&n; * &bslash;param filp file pointer.&n; *&n; * Puts the dev-&gt;fops corresponding to the device minor number into&n; * &bslash;p filp, call the &bslash;c open method, and restore the file operations.&n; */
DECL|function|stub_open
r_static
r_int
id|stub_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
id|drm_device_t
op_star
id|dev
op_assign
l_int|NULL
suffix:semicolon
r_int
id|minor
op_assign
id|iminor
c_func
(paren
id|inode
)paren
suffix:semicolon
r_int
id|err
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_struct
id|file_operations
op_star
id|old_fops
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
(paren
id|minor
op_ge
l_int|0
)paren
op_logical_and
(paren
id|minor
OL
id|DRM
c_func
(paren
id|global
)paren
op_member_access_from_pointer
id|cards_limit
)paren
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|dev
op_assign
id|DRM
c_func
(paren
id|global
)paren
op_member_access_from_pointer
id|minors
(braket
id|minor
)braket
dot
id|dev
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|old_fops
op_assign
id|filp-&gt;f_op
suffix:semicolon
id|filp-&gt;f_op
op_assign
id|fops_get
c_func
(paren
id|dev-&gt;fops
)paren
suffix:semicolon
r_if
c_cond
(paren
id|filp-&gt;f_op-&gt;open
op_logical_and
(paren
id|err
op_assign
id|filp-&gt;f_op
op_member_access_from_pointer
id|open
c_func
(paren
id|inode
comma
id|filp
)paren
)paren
)paren
(brace
id|fops_put
c_func
(paren
id|filp-&gt;f_op
)paren
suffix:semicolon
id|filp-&gt;f_op
op_assign
id|fops_get
c_func
(paren
id|old_fops
)paren
suffix:semicolon
)brace
id|fops_put
c_func
(paren
id|old_fops
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/** File operations structure */
DECL|variable|stub_fops
r_static
r_struct
id|file_operations
id|DRM
c_func
(paren
id|stub_fops
)paren
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|open
op_assign
id|stub_open
)brace
suffix:semicolon
multiline_comment|/**&n; * Get a device minor number.&n; *&n; * &bslash;param pdev PCI device structure&n; * &bslash;param ent entry from the PCI ID table with device type flags&n; * &bslash;return negative number on failure.&n; *&n; * Search an empty entry and initialize it to the given parameters, and &n; * create the proc init entry via proc_init().&n; */
DECL|function|get_minor
r_static
r_int
id|get_minor
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_const
r_struct
id|pci_device_id
op_star
id|ent
)paren
(brace
r_struct
id|class_device
op_star
id|dev_class
suffix:semicolon
id|drm_device_t
op_star
id|dev
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_int
id|minor
suffix:semicolon
id|drm_minor_t
op_star
id|minors
op_assign
op_amp
id|DRM
c_func
(paren
id|global
)paren
op_member_access_from_pointer
id|minors
(braket
l_int|0
)braket
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|minor
op_assign
l_int|0
suffix:semicolon
id|minor
OL
id|DRM
c_func
(paren
id|global
)paren
op_member_access_from_pointer
id|cards_limit
suffix:semicolon
id|minor
op_increment
comma
id|minors
op_increment
)paren
(brace
r_if
c_cond
(paren
id|minors-&gt;type
op_eq
id|DRM_MINOR_FREE
)paren
(brace
id|DRM_DEBUG
c_func
(paren
l_string|&quot;assigning minor %d&bslash;n&quot;
comma
id|minor
)paren
suffix:semicolon
id|dev
op_assign
id|DRM
c_func
(paren
id|calloc
)paren
(paren
l_int|1
comma
r_sizeof
(paren
op_star
id|dev
)paren
comma
id|DRM_MEM_STUB
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
op_star
id|minors
op_assign
(paren
id|drm_minor_t
)paren
(brace
dot
id|dev
op_assign
id|dev
comma
dot
id|type
op_assign
id|DRM_MINOR_PRIMARY
)brace
suffix:semicolon
id|dev-&gt;minor
op_assign
id|minor
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|DRM
c_func
(paren
id|fill_in_dev
)paren
(paren
id|dev
comma
id|pdev
comma
id|ent
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;DRM: Fill_in_dev failed.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|err_g1
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|DRM
c_func
(paren
id|proc_init
)paren
(paren
id|dev
comma
id|minor
comma
id|DRM
c_func
(paren
id|global
)paren
op_member_access_from_pointer
id|proc_root
comma
op_amp
id|dev-&gt;dev_root
)paren
)paren
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;DRM: Failed to initialize /proc/dri.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|err_g1
suffix:semicolon
)brace
id|pci_enable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|dev_class
op_assign
id|class_simple_device_add
c_func
(paren
id|DRM
c_func
(paren
id|global
)paren
op_member_access_from_pointer
id|drm_class
comma
id|MKDEV
c_func
(paren
id|DRM_MAJOR
comma
id|minor
)paren
comma
op_amp
id|pdev-&gt;dev
comma
l_string|&quot;card%d&quot;
comma
id|minor
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|dev_class
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;DRM: Error class_simple_device_add.&bslash;n&quot;
)paren
suffix:semicolon
id|ret
op_assign
id|PTR_ERR
c_func
(paren
id|dev_class
)paren
suffix:semicolon
r_goto
id|err_g2
suffix:semicolon
)brace
id|DRM_DEBUG
c_func
(paren
l_string|&quot;new minor assigned %d&bslash;n&quot;
comma
id|minor
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;out of minors&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|err_g2
suffix:colon
id|DRM
c_func
(paren
id|proc_cleanup
)paren
(paren
id|minor
comma
id|DRM
c_func
(paren
id|global
)paren
op_member_access_from_pointer
id|proc_root
comma
id|minors-&gt;dev_root
)paren
suffix:semicolon
id|err_g1
suffix:colon
op_star
id|minors
op_assign
(paren
id|drm_minor_t
)paren
(brace
dot
id|dev
op_assign
l_int|NULL
comma
dot
id|type
op_assign
id|DRM_MINOR_FREE
)brace
suffix:semicolon
id|DRM
c_func
(paren
id|free
)paren
(paren
id|dev
comma
r_sizeof
(paren
op_star
id|dev
)paren
comma
id|DRM_MEM_STUB
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/**&n; * Put a device minor number.&n; *&n; * &bslash;param minor minor number.&n; * &bslash;return always zero.&n; *&n; * Cleans up the proc resources. If a minor is zero then release the foreign&n; * &quot;drm&quot; data, otherwise unregisters the &quot;drm&quot; data, frees the stub list and&n; * unregisters the character device. &n; */
DECL|function|put_minor
r_int
id|DRM
c_func
(paren
id|put_minor
)paren
(paren
id|drm_device_t
op_star
id|dev
)paren
(brace
id|drm_minor_t
op_star
id|minors
op_assign
op_amp
id|DRM
c_func
(paren
id|global
)paren
op_member_access_from_pointer
id|minors
(braket
id|dev-&gt;minor
)braket
suffix:semicolon
r_int
id|i
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;release minor %d&bslash;n&quot;
comma
id|dev-&gt;minor
)paren
suffix:semicolon
id|DRM
c_func
(paren
id|proc_cleanup
)paren
(paren
id|dev-&gt;minor
comma
id|DRM
c_func
(paren
id|global
)paren
op_member_access_from_pointer
id|proc_root
comma
id|dev-&gt;dev_root
)paren
suffix:semicolon
id|class_simple_device_remove
c_func
(paren
id|MKDEV
c_func
(paren
id|DRM_MAJOR
comma
id|dev-&gt;minor
)paren
)paren
suffix:semicolon
op_star
id|minors
op_assign
(paren
id|drm_minor_t
)paren
(brace
dot
id|dev
op_assign
l_int|NULL
comma
dot
id|type
op_assign
id|DRM_MINOR_FREE
)brace
suffix:semicolon
id|DRM
c_func
(paren
id|free
)paren
(paren
id|dev
comma
r_sizeof
(paren
op_star
id|dev
)paren
comma
id|DRM_MEM_STUB
)paren
suffix:semicolon
multiline_comment|/* if any device pointers are non-NULL we are not the last module */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|DRM
c_func
(paren
id|global
)paren
op_member_access_from_pointer
id|cards_limit
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|DRM
c_func
(paren
id|global
)paren
op_member_access_from_pointer
id|minors
(braket
id|i
)braket
dot
id|type
op_ne
id|DRM_MINOR_FREE
)paren
(brace
id|DRM_DEBUG
c_func
(paren
l_string|&quot;inter_module_put called&bslash;n&quot;
)paren
suffix:semicolon
id|inter_module_put
c_func
(paren
l_string|&quot;drm&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
id|DRM_DEBUG
c_func
(paren
l_string|&quot;unregistering inter_module.&bslash;n&quot;
)paren
suffix:semicolon
id|inter_module_unregister
c_func
(paren
l_string|&quot;drm&quot;
)paren
suffix:semicolon
id|remove_proc_entry
c_func
(paren
l_string|&quot;dri&quot;
comma
l_int|NULL
)paren
suffix:semicolon
id|class_simple_destroy
c_func
(paren
id|DRM
c_func
(paren
id|global
)paren
op_member_access_from_pointer
id|drm_class
)paren
suffix:semicolon
id|unregister_chrdev
c_func
(paren
id|DRM_MAJOR
comma
l_string|&quot;drm&quot;
)paren
suffix:semicolon
id|DRM
c_func
(paren
id|free
)paren
(paren
id|DRM
c_func
(paren
id|global
)paren
op_member_access_from_pointer
id|minors
comma
r_sizeof
(paren
op_star
id|DRM
c_func
(paren
id|global
)paren
op_member_access_from_pointer
id|minors
)paren
op_star
id|DRM
c_func
(paren
id|global
)paren
op_member_access_from_pointer
id|cards_limit
comma
id|DRM_MEM_STUB
)paren
suffix:semicolon
id|DRM
c_func
(paren
id|free
)paren
(paren
id|DRM
c_func
(paren
id|global
)paren
comma
r_sizeof
(paren
op_star
id|DRM
c_func
(paren
id|global
)paren
)paren
comma
id|DRM_MEM_STUB
)paren
suffix:semicolon
id|DRM
c_func
(paren
id|global
)paren
op_assign
l_int|NULL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * Register.&n; *&n; * &bslash;param pdev - PCI device structure&n; * &bslash;param ent entry from the PCI ID table with device type flags&n; * &bslash;return zero on success or a negative number on failure.&n; *&n; * Attempt to gets inter module &quot;drm&quot; information. If we are first&n; * then register the character device and inter module information.&n; * Try and register, if we fail to register, backout previous work.&n; */
DECL|function|probe
r_int
id|DRM
c_func
(paren
id|probe
)paren
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_const
r_struct
id|pci_device_id
op_star
id|ent
)paren
(brace
id|drm_global_t
op_star
id|global
suffix:semicolon
r_int
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* use the inter_module_get to check - as if the same module&n;&t;&t;registers chrdev twice it succeeds */
id|global
op_assign
(paren
id|drm_global_t
op_star
)paren
id|inter_module_get
c_func
(paren
l_string|&quot;drm&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|global
)paren
(brace
id|DRM
c_func
(paren
id|global
)paren
op_assign
id|global
suffix:semicolon
id|global
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
(brace
id|DRM_DEBUG
c_func
(paren
l_string|&quot;first probe&bslash;n&quot;
)paren
suffix:semicolon
id|global
op_assign
id|DRM
c_func
(paren
id|calloc
)paren
(paren
l_int|1
comma
r_sizeof
(paren
op_star
id|global
)paren
comma
id|DRM_MEM_STUB
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|global
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|global-&gt;cards_limit
op_assign
(paren
id|cards_limit
OL
id|DRM_MAX_MINOR
op_plus
l_int|1
ques
c_cond
id|cards_limit
suffix:colon
id|DRM_MAX_MINOR
op_plus
l_int|1
)paren
suffix:semicolon
id|global-&gt;minors
op_assign
id|DRM
c_func
(paren
id|calloc
)paren
(paren
id|global-&gt;cards_limit
comma
r_sizeof
(paren
op_star
id|global-&gt;minors
)paren
comma
id|DRM_MEM_STUB
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|global-&gt;minors
)paren
(brace
r_goto
id|err_p1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|register_chrdev
c_func
(paren
id|DRM_MAJOR
comma
l_string|&quot;drm&quot;
comma
op_amp
id|DRM
c_func
(paren
id|stub_fops
)paren
)paren
)paren
r_goto
id|err_p1
suffix:semicolon
id|global-&gt;drm_class
op_assign
id|class_simple_create
c_func
(paren
id|THIS_MODULE
comma
l_string|&quot;drm&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|global-&gt;drm_class
)paren
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;DRM: Error creating drm class.&bslash;n&quot;
)paren
suffix:semicolon
id|ret
op_assign
id|PTR_ERR
c_func
(paren
id|global-&gt;drm_class
)paren
suffix:semicolon
r_goto
id|err_p2
suffix:semicolon
)brace
id|global-&gt;proc_root
op_assign
id|create_proc_entry
c_func
(paren
l_string|&quot;dri&quot;
comma
id|S_IFDIR
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|global-&gt;proc_root
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;Cannot create /proc/dri&bslash;n&quot;
)paren
suffix:semicolon
id|ret
op_assign
op_minus
l_int|1
suffix:semicolon
r_goto
id|err_p3
suffix:semicolon
)brace
id|DRM_DEBUG
c_func
(paren
l_string|&quot;calling inter_module_register&bslash;n&quot;
)paren
suffix:semicolon
id|inter_module_register
c_func
(paren
l_string|&quot;drm&quot;
comma
id|THIS_MODULE
comma
id|global
)paren
suffix:semicolon
id|DRM
c_func
(paren
id|global
)paren
op_assign
id|global
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|get_minor
c_func
(paren
id|pdev
comma
id|ent
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|global
)paren
r_goto
id|err_p3
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
id|err_p3
suffix:colon
id|class_simple_destroy
c_func
(paren
id|global-&gt;drm_class
)paren
suffix:semicolon
id|err_p2
suffix:colon
id|unregister_chrdev
c_func
(paren
id|DRM_MAJOR
comma
l_string|&quot;drm&quot;
)paren
suffix:semicolon
id|DRM
c_func
(paren
id|free
)paren
(paren
id|global-&gt;minors
comma
r_sizeof
(paren
op_star
id|global-&gt;minors
)paren
op_star
id|global-&gt;cards_limit
comma
id|DRM_MEM_STUB
)paren
suffix:semicolon
id|err_p1
suffix:colon
id|DRM
c_func
(paren
id|free
)paren
(paren
id|global
comma
r_sizeof
(paren
op_star
id|global
)paren
comma
id|DRM_MEM_STUB
)paren
suffix:semicolon
id|DRM
c_func
(paren
id|global
)paren
op_assign
l_int|NULL
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
eof
