multiline_comment|/* r128_state.c -- State support for r128 -*- linux-c -*-&n; * Created: Thu Jan 27 02:53:43 2000 by gareth@valinux.com&n; *&n; * Copyright 2000 VA Linux Systems, Inc., Sunnyvale, California.&n; * All Rights Reserved.&n; *&n; * Permission is hereby granted, free of charge, to any person obtaining a&n; * copy of this software and associated documentation files (the &quot;Software&quot;),&n; * to deal in the Software without restriction, including without limitation&n; * the rights to use, copy, modify, merge, publish, distribute, sublicense,&n; * and/or sell copies of the Software, and to permit persons to whom the&n; * Software is furnished to do so, subject to the following conditions:&n; *&n; * The above copyright notice and this permission notice (including the next&n; * paragraph) shall be included in all copies or substantial portions of the&n; * Software.&n; *&n; * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR&n; * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,&n; * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL&n; * PRECISION INSIGHT AND/OR ITS SUPPLIERS BE LIABLE FOR ANY CLAIM, DAMAGES OR&n; * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,&n; * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER&n; * DEALINGS IN THE SOFTWARE.&n; *&n; * Authors:&n; *    Gareth Hughes &lt;gareth@valinux.com&gt;&n; *&n; */
DECL|macro|__NO_VERSION__
mdefine_line|#define __NO_VERSION__
macro_line|#include &quot;drmP.h&quot;
macro_line|#include &quot;r128_drv.h&quot;
macro_line|#include &quot;drm.h&quot;
multiline_comment|/* ================================================================&n; * CCE hardware state programming functions&n; */
DECL|function|r128_emit_clip_rects
r_static
r_void
id|r128_emit_clip_rects
c_func
(paren
id|drm_r128_private_t
op_star
id|dev_priv
comma
id|drm_clip_rect_t
op_star
id|boxes
comma
r_int
id|count
)paren
(brace
id|u32
id|aux_sc_cntl
op_assign
l_int|0x00000000
suffix:semicolon
id|RING_LOCALS
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;    %s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|BEGIN_RING
c_func
(paren
l_int|17
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
op_ge
l_int|1
)paren
(brace
id|OUT_RING
c_func
(paren
id|CCE_PACKET0
c_func
(paren
id|R128_AUX1_SC_LEFT
comma
l_int|3
)paren
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|boxes
(braket
l_int|0
)braket
dot
id|x1
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|boxes
(braket
l_int|0
)braket
dot
id|x2
op_minus
l_int|1
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|boxes
(braket
l_int|0
)braket
dot
id|y1
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|boxes
(braket
l_int|0
)braket
dot
id|y2
op_minus
l_int|1
)paren
suffix:semicolon
id|aux_sc_cntl
op_or_assign
(paren
id|R128_AUX1_SC_EN
op_or
id|R128_AUX1_SC_MODE_OR
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|count
op_ge
l_int|2
)paren
(brace
id|OUT_RING
c_func
(paren
id|CCE_PACKET0
c_func
(paren
id|R128_AUX2_SC_LEFT
comma
l_int|3
)paren
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|boxes
(braket
l_int|1
)braket
dot
id|x1
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|boxes
(braket
l_int|1
)braket
dot
id|x2
op_minus
l_int|1
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|boxes
(braket
l_int|1
)braket
dot
id|y1
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|boxes
(braket
l_int|1
)braket
dot
id|y2
op_minus
l_int|1
)paren
suffix:semicolon
id|aux_sc_cntl
op_or_assign
(paren
id|R128_AUX2_SC_EN
op_or
id|R128_AUX2_SC_MODE_OR
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|count
op_ge
l_int|3
)paren
(brace
id|OUT_RING
c_func
(paren
id|CCE_PACKET0
c_func
(paren
id|R128_AUX3_SC_LEFT
comma
l_int|3
)paren
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|boxes
(braket
l_int|2
)braket
dot
id|x1
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|boxes
(braket
l_int|2
)braket
dot
id|x2
op_minus
l_int|1
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|boxes
(braket
l_int|2
)braket
dot
id|y1
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|boxes
(braket
l_int|2
)braket
dot
id|y2
op_minus
l_int|1
)paren
suffix:semicolon
id|aux_sc_cntl
op_or_assign
(paren
id|R128_AUX3_SC_EN
op_or
id|R128_AUX3_SC_MODE_OR
)paren
suffix:semicolon
)brace
id|OUT_RING
c_func
(paren
id|CCE_PACKET0
c_func
(paren
id|R128_AUX_SC_CNTL
comma
l_int|0
)paren
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|aux_sc_cntl
)paren
suffix:semicolon
id|ADVANCE_RING
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|r128_emit_core
r_static
r_inline
r_void
id|r128_emit_core
c_func
(paren
id|drm_r128_private_t
op_star
id|dev_priv
)paren
(brace
id|drm_r128_sarea_t
op_star
id|sarea_priv
op_assign
id|dev_priv-&gt;sarea_priv
suffix:semicolon
id|drm_r128_context_regs_t
op_star
id|ctx
op_assign
op_amp
id|sarea_priv-&gt;context_state
suffix:semicolon
id|RING_LOCALS
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;    %s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|BEGIN_RING
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|CCE_PACKET0
c_func
(paren
id|R128_SCALE_3D_CNTL
comma
l_int|0
)paren
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|ctx-&gt;scale_3d_cntl
)paren
suffix:semicolon
id|ADVANCE_RING
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|r128_emit_context
r_static
r_inline
r_void
id|r128_emit_context
c_func
(paren
id|drm_r128_private_t
op_star
id|dev_priv
)paren
(brace
id|drm_r128_sarea_t
op_star
id|sarea_priv
op_assign
id|dev_priv-&gt;sarea_priv
suffix:semicolon
id|drm_r128_context_regs_t
op_star
id|ctx
op_assign
op_amp
id|sarea_priv-&gt;context_state
suffix:semicolon
id|RING_LOCALS
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;    %s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|BEGIN_RING
c_func
(paren
l_int|13
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|CCE_PACKET0
c_func
(paren
id|R128_DST_PITCH_OFFSET_C
comma
l_int|11
)paren
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|ctx-&gt;dst_pitch_offset_c
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|ctx-&gt;dp_gui_master_cntl_c
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|ctx-&gt;sc_top_left_c
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|ctx-&gt;sc_bottom_right_c
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|ctx-&gt;z_offset_c
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|ctx-&gt;z_pitch_c
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|ctx-&gt;z_sten_cntl_c
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|ctx-&gt;tex_cntl_c
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|ctx-&gt;misc_3d_state_cntl_reg
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|ctx-&gt;texture_clr_cmp_clr_c
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|ctx-&gt;texture_clr_cmp_msk_c
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|ctx-&gt;fog_color_c
)paren
suffix:semicolon
id|ADVANCE_RING
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|r128_emit_setup
r_static
r_inline
r_void
id|r128_emit_setup
c_func
(paren
id|drm_r128_private_t
op_star
id|dev_priv
)paren
(brace
id|drm_r128_sarea_t
op_star
id|sarea_priv
op_assign
id|dev_priv-&gt;sarea_priv
suffix:semicolon
id|drm_r128_context_regs_t
op_star
id|ctx
op_assign
op_amp
id|sarea_priv-&gt;context_state
suffix:semicolon
id|RING_LOCALS
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;    %s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|BEGIN_RING
c_func
(paren
l_int|3
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|CCE_PACKET1
c_func
(paren
id|R128_SETUP_CNTL
comma
id|R128_PM4_VC_FPU_SETUP
)paren
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|ctx-&gt;setup_cntl
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|ctx-&gt;pm4_vc_fpu_setup
)paren
suffix:semicolon
id|ADVANCE_RING
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|r128_emit_masks
r_static
r_inline
r_void
id|r128_emit_masks
c_func
(paren
id|drm_r128_private_t
op_star
id|dev_priv
)paren
(brace
id|drm_r128_sarea_t
op_star
id|sarea_priv
op_assign
id|dev_priv-&gt;sarea_priv
suffix:semicolon
id|drm_r128_context_regs_t
op_star
id|ctx
op_assign
op_amp
id|sarea_priv-&gt;context_state
suffix:semicolon
id|RING_LOCALS
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;    %s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|BEGIN_RING
c_func
(paren
l_int|5
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|CCE_PACKET0
c_func
(paren
id|R128_DP_WRITE_MASK
comma
l_int|0
)paren
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|ctx-&gt;dp_write_mask
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|CCE_PACKET0
c_func
(paren
id|R128_STEN_REF_MASK_C
comma
l_int|1
)paren
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|ctx-&gt;sten_ref_mask_c
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|ctx-&gt;plane_3d_mask_c
)paren
suffix:semicolon
id|ADVANCE_RING
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|r128_emit_window
r_static
r_inline
r_void
id|r128_emit_window
c_func
(paren
id|drm_r128_private_t
op_star
id|dev_priv
)paren
(brace
id|drm_r128_sarea_t
op_star
id|sarea_priv
op_assign
id|dev_priv-&gt;sarea_priv
suffix:semicolon
id|drm_r128_context_regs_t
op_star
id|ctx
op_assign
op_amp
id|sarea_priv-&gt;context_state
suffix:semicolon
id|RING_LOCALS
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;    %s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|BEGIN_RING
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|CCE_PACKET0
c_func
(paren
id|R128_WINDOW_XY_OFFSET
comma
l_int|0
)paren
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|ctx-&gt;window_xy_offset
)paren
suffix:semicolon
id|ADVANCE_RING
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|r128_emit_tex0
r_static
r_inline
r_void
id|r128_emit_tex0
c_func
(paren
id|drm_r128_private_t
op_star
id|dev_priv
)paren
(brace
id|drm_r128_sarea_t
op_star
id|sarea_priv
op_assign
id|dev_priv-&gt;sarea_priv
suffix:semicolon
id|drm_r128_context_regs_t
op_star
id|ctx
op_assign
op_amp
id|sarea_priv-&gt;context_state
suffix:semicolon
id|drm_r128_texture_regs_t
op_star
id|tex
op_assign
op_amp
id|sarea_priv-&gt;tex_state
(braket
l_int|0
)braket
suffix:semicolon
r_int
id|i
suffix:semicolon
id|RING_LOCALS
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;    %s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|BEGIN_RING
c_func
(paren
l_int|7
op_plus
id|R128_TEX_MAXLEVELS
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|CCE_PACKET0
c_func
(paren
id|R128_PRIM_TEX_CNTL_C
comma
l_int|2
op_plus
id|R128_TEX_MAXLEVELS
)paren
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|tex-&gt;tex_cntl
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|tex-&gt;tex_combine_cntl
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|ctx-&gt;tex_size_pitch_c
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|R128_TEX_MAXLEVELS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|OUT_RING
c_func
(paren
id|tex-&gt;tex_offset
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|OUT_RING
c_func
(paren
id|CCE_PACKET0
c_func
(paren
id|R128_CONSTANT_COLOR_C
comma
l_int|1
)paren
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|ctx-&gt;constant_color_c
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|tex-&gt;tex_border_color
)paren
suffix:semicolon
id|ADVANCE_RING
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|r128_emit_tex1
r_static
r_inline
r_void
id|r128_emit_tex1
c_func
(paren
id|drm_r128_private_t
op_star
id|dev_priv
)paren
(brace
id|drm_r128_sarea_t
op_star
id|sarea_priv
op_assign
id|dev_priv-&gt;sarea_priv
suffix:semicolon
id|drm_r128_texture_regs_t
op_star
id|tex
op_assign
op_amp
id|sarea_priv-&gt;tex_state
(braket
l_int|1
)braket
suffix:semicolon
r_int
id|i
suffix:semicolon
id|RING_LOCALS
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;    %s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|BEGIN_RING
c_func
(paren
l_int|5
op_plus
id|R128_TEX_MAXLEVELS
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|CCE_PACKET0
c_func
(paren
id|R128_SEC_TEX_CNTL_C
comma
l_int|1
op_plus
id|R128_TEX_MAXLEVELS
)paren
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|tex-&gt;tex_cntl
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|tex-&gt;tex_combine_cntl
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|R128_TEX_MAXLEVELS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|OUT_RING
c_func
(paren
id|tex-&gt;tex_offset
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|OUT_RING
c_func
(paren
id|CCE_PACKET0
c_func
(paren
id|R128_SEC_TEXTURE_BORDER_COLOR_C
comma
l_int|0
)paren
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|tex-&gt;tex_border_color
)paren
suffix:semicolon
id|ADVANCE_RING
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|r128_emit_state
r_static
r_inline
r_void
id|r128_emit_state
c_func
(paren
id|drm_r128_private_t
op_star
id|dev_priv
)paren
(brace
id|drm_r128_sarea_t
op_star
id|sarea_priv
op_assign
id|dev_priv-&gt;sarea_priv
suffix:semicolon
r_int
r_int
id|dirty
op_assign
id|sarea_priv-&gt;dirty
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;%s: dirty=0x%08x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|dirty
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dirty
op_amp
id|R128_UPLOAD_CORE
)paren
(brace
id|r128_emit_core
c_func
(paren
id|dev_priv
)paren
suffix:semicolon
id|sarea_priv-&gt;dirty
op_and_assign
op_complement
id|R128_UPLOAD_CORE
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dirty
op_amp
id|R128_UPLOAD_CONTEXT
)paren
(brace
id|r128_emit_context
c_func
(paren
id|dev_priv
)paren
suffix:semicolon
id|sarea_priv-&gt;dirty
op_and_assign
op_complement
id|R128_UPLOAD_CONTEXT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dirty
op_amp
id|R128_UPLOAD_SETUP
)paren
(brace
id|r128_emit_setup
c_func
(paren
id|dev_priv
)paren
suffix:semicolon
id|sarea_priv-&gt;dirty
op_and_assign
op_complement
id|R128_UPLOAD_SETUP
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dirty
op_amp
id|R128_UPLOAD_MASKS
)paren
(brace
id|r128_emit_masks
c_func
(paren
id|dev_priv
)paren
suffix:semicolon
id|sarea_priv-&gt;dirty
op_and_assign
op_complement
id|R128_UPLOAD_MASKS
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dirty
op_amp
id|R128_UPLOAD_WINDOW
)paren
(brace
id|r128_emit_window
c_func
(paren
id|dev_priv
)paren
suffix:semicolon
id|sarea_priv-&gt;dirty
op_and_assign
op_complement
id|R128_UPLOAD_WINDOW
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dirty
op_amp
id|R128_UPLOAD_TEX0
)paren
(brace
id|r128_emit_tex0
c_func
(paren
id|dev_priv
)paren
suffix:semicolon
id|sarea_priv-&gt;dirty
op_and_assign
op_complement
id|R128_UPLOAD_TEX0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dirty
op_amp
id|R128_UPLOAD_TEX1
)paren
(brace
id|r128_emit_tex1
c_func
(paren
id|dev_priv
)paren
suffix:semicolon
id|sarea_priv-&gt;dirty
op_and_assign
op_complement
id|R128_UPLOAD_TEX1
suffix:semicolon
)brace
multiline_comment|/* Turn off the texture cache flushing */
id|sarea_priv-&gt;context_state.tex_cntl_c
op_and_assign
op_complement
id|R128_TEX_CACHE_FLUSH
suffix:semicolon
id|sarea_priv-&gt;dirty
op_and_assign
op_complement
id|R128_REQUIRE_QUIESCENCE
suffix:semicolon
)brace
macro_line|#if R128_PERFORMANCE_BOXES
multiline_comment|/* ================================================================&n; * Performance monitoring functions&n; */
DECL|function|r128_clear_box
r_static
r_void
id|r128_clear_box
c_func
(paren
id|drm_r128_private_t
op_star
id|dev_priv
comma
r_int
id|x
comma
r_int
id|y
comma
r_int
id|w
comma
r_int
id|h
comma
r_int
id|r
comma
r_int
id|g
comma
r_int
id|b
)paren
(brace
id|u32
id|pitch
comma
id|offset
suffix:semicolon
id|u32
id|fb_bpp
comma
id|color
suffix:semicolon
id|RING_LOCALS
suffix:semicolon
r_switch
c_cond
(paren
id|dev_priv-&gt;fb_bpp
)paren
(brace
r_case
l_int|16
suffix:colon
id|fb_bpp
op_assign
id|R128_GMC_DST_16BPP
suffix:semicolon
id|color
op_assign
(paren
(paren
(paren
id|r
op_amp
l_int|0xf8
)paren
op_lshift
l_int|8
)paren
op_or
(paren
(paren
id|g
op_amp
l_int|0xfc
)paren
op_lshift
l_int|3
)paren
op_or
(paren
(paren
id|b
op_amp
l_int|0xf8
)paren
op_rshift
l_int|3
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|24
suffix:colon
id|fb_bpp
op_assign
id|R128_GMC_DST_24BPP
suffix:semicolon
id|color
op_assign
(paren
(paren
id|r
op_lshift
l_int|16
)paren
op_or
(paren
id|g
op_lshift
l_int|8
)paren
op_or
id|b
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|32
suffix:colon
id|fb_bpp
op_assign
id|R128_GMC_DST_32BPP
suffix:semicolon
id|color
op_assign
(paren
(paren
(paren
l_int|0xff
)paren
op_lshift
l_int|24
)paren
op_or
(paren
id|r
op_lshift
l_int|16
)paren
op_or
(paren
id|g
op_lshift
l_int|8
)paren
op_or
id|b
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
suffix:semicolon
)brace
id|offset
op_assign
id|dev_priv-&gt;back_offset
suffix:semicolon
id|pitch
op_assign
id|dev_priv-&gt;back_pitch
op_rshift
l_int|3
suffix:semicolon
id|BEGIN_RING
c_func
(paren
l_int|6
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|CCE_PACKET3
c_func
(paren
id|R128_CNTL_PAINT_MULTI
comma
l_int|4
)paren
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|R128_GMC_DST_PITCH_OFFSET_CNTL
op_or
id|R128_GMC_BRUSH_SOLID_COLOR
op_or
id|fb_bpp
op_or
id|R128_GMC_SRC_DATATYPE_COLOR
op_or
id|R128_ROP3_P
op_or
id|R128_GMC_CLR_CMP_CNTL_DIS
op_or
id|R128_GMC_AUX_CLIP_DIS
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
(paren
id|pitch
op_lshift
l_int|21
)paren
op_or
(paren
id|offset
op_rshift
l_int|5
)paren
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|color
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
(paren
id|x
op_lshift
l_int|16
)paren
op_or
id|y
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
(paren
id|w
op_lshift
l_int|16
)paren
op_or
id|h
)paren
suffix:semicolon
id|ADVANCE_RING
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|r128_cce_performance_boxes
r_static
r_void
id|r128_cce_performance_boxes
c_func
(paren
id|drm_r128_private_t
op_star
id|dev_priv
)paren
(brace
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|dev_priv-&gt;idle_count
)paren
op_eq
l_int|0
)paren
(brace
id|r128_clear_box
c_func
(paren
id|dev_priv
comma
l_int|64
comma
l_int|4
comma
l_int|8
comma
l_int|8
comma
l_int|0
comma
l_int|255
comma
l_int|0
)paren
suffix:semicolon
)brace
r_else
(brace
id|atomic_set
c_func
(paren
op_amp
id|dev_priv-&gt;idle_count
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
multiline_comment|/* ================================================================&n; * CCE command dispatch functions&n; */
DECL|function|r128_print_dirty
r_static
r_void
id|r128_print_dirty
c_func
(paren
r_const
r_char
op_star
id|msg
comma
r_int
r_int
id|flags
)paren
(brace
id|DRM_INFO
c_func
(paren
l_string|&quot;%s: (0x%x) %s%s%s%s%s%s%s%s%s&bslash;n&quot;
comma
id|msg
comma
id|flags
comma
(paren
id|flags
op_amp
id|R128_UPLOAD_CORE
)paren
ques
c_cond
l_string|&quot;core, &quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|flags
op_amp
id|R128_UPLOAD_CONTEXT
)paren
ques
c_cond
l_string|&quot;context, &quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|flags
op_amp
id|R128_UPLOAD_SETUP
)paren
ques
c_cond
l_string|&quot;setup, &quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|flags
op_amp
id|R128_UPLOAD_TEX0
)paren
ques
c_cond
l_string|&quot;tex0, &quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|flags
op_amp
id|R128_UPLOAD_TEX1
)paren
ques
c_cond
l_string|&quot;tex1, &quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|flags
op_amp
id|R128_UPLOAD_MASKS
)paren
ques
c_cond
l_string|&quot;masks, &quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|flags
op_amp
id|R128_UPLOAD_WINDOW
)paren
ques
c_cond
l_string|&quot;window, &quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|flags
op_amp
id|R128_UPLOAD_CLIPRECTS
)paren
ques
c_cond
l_string|&quot;cliprects, &quot;
suffix:colon
l_string|&quot;&quot;
comma
(paren
id|flags
op_amp
id|R128_REQUIRE_QUIESCENCE
)paren
ques
c_cond
l_string|&quot;quiescence, &quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
)brace
DECL|function|r128_cce_dispatch_clear
r_static
r_void
id|r128_cce_dispatch_clear
c_func
(paren
id|drm_device_t
op_star
id|dev
comma
r_int
r_int
id|flags
comma
r_int
id|cx
comma
r_int
id|cy
comma
r_int
id|cw
comma
r_int
id|ch
comma
r_int
r_int
id|clear_color
comma
r_int
r_int
id|clear_depth
)paren
(brace
id|drm_r128_private_t
op_star
id|dev_priv
op_assign
id|dev-&gt;dev_private
suffix:semicolon
id|drm_r128_sarea_t
op_star
id|sarea_priv
op_assign
id|dev_priv-&gt;sarea_priv
suffix:semicolon
r_int
id|nbox
op_assign
id|sarea_priv-&gt;nbox
suffix:semicolon
id|drm_clip_rect_t
op_star
id|pbox
op_assign
id|sarea_priv-&gt;boxes
suffix:semicolon
id|u32
id|fb_bpp
comma
id|depth_bpp
suffix:semicolon
r_int
id|i
suffix:semicolon
id|RING_LOCALS
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|r128_update_ring_snapshot
c_func
(paren
id|dev_priv
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|dev_priv-&gt;fb_bpp
)paren
(brace
r_case
l_int|16
suffix:colon
id|fb_bpp
op_assign
id|R128_GMC_DST_16BPP
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|32
suffix:colon
id|fb_bpp
op_assign
id|R128_GMC_DST_32BPP
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|dev_priv-&gt;depth_bpp
)paren
(brace
r_case
l_int|16
suffix:colon
id|depth_bpp
op_assign
id|R128_GMC_DST_16BPP
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|24
suffix:colon
r_case
l_int|32
suffix:colon
id|depth_bpp
op_assign
id|R128_GMC_DST_32BPP
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|nbox
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
id|x
op_assign
id|pbox
(braket
id|i
)braket
dot
id|x1
suffix:semicolon
r_int
id|y
op_assign
id|pbox
(braket
id|i
)braket
dot
id|y1
suffix:semicolon
r_int
id|w
op_assign
id|pbox
(braket
id|i
)braket
dot
id|x2
op_minus
id|x
suffix:semicolon
r_int
id|h
op_assign
id|pbox
(braket
id|i
)braket
dot
id|y2
op_minus
id|y
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;dispatch clear %d,%d-%d,%d flags 0x%x&bslash;n&quot;
comma
id|pbox
(braket
id|i
)braket
dot
id|x1
comma
id|pbox
(braket
id|i
)braket
dot
id|y1
comma
id|pbox
(braket
id|i
)braket
dot
id|x2
comma
id|pbox
(braket
id|i
)braket
dot
id|y2
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
(paren
id|R128_FRONT
op_or
id|R128_BACK
)paren
)paren
(brace
id|BEGIN_RING
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|CCE_PACKET0
c_func
(paren
id|R128_DP_WRITE_MASK
comma
l_int|0
)paren
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|sarea_priv-&gt;context_state.plane_3d_mask_c
)paren
suffix:semicolon
id|ADVANCE_RING
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|flags
op_amp
id|R128_FRONT
)paren
(brace
id|BEGIN_RING
c_func
(paren
l_int|6
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|CCE_PACKET3
c_func
(paren
id|R128_CNTL_PAINT_MULTI
comma
l_int|4
)paren
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|R128_GMC_DST_PITCH_OFFSET_CNTL
op_or
id|R128_GMC_BRUSH_SOLID_COLOR
op_or
id|fb_bpp
op_or
id|R128_GMC_SRC_DATATYPE_COLOR
op_or
id|R128_ROP3_P
op_or
id|R128_GMC_CLR_CMP_CNTL_DIS
op_or
id|R128_GMC_AUX_CLIP_DIS
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|dev_priv-&gt;front_pitch_offset_c
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|clear_color
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
(paren
id|x
op_lshift
l_int|16
)paren
op_or
id|y
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
(paren
id|w
op_lshift
l_int|16
)paren
op_or
id|h
)paren
suffix:semicolon
id|ADVANCE_RING
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|flags
op_amp
id|R128_BACK
)paren
(brace
id|BEGIN_RING
c_func
(paren
l_int|6
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|CCE_PACKET3
c_func
(paren
id|R128_CNTL_PAINT_MULTI
comma
l_int|4
)paren
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|R128_GMC_DST_PITCH_OFFSET_CNTL
op_or
id|R128_GMC_BRUSH_SOLID_COLOR
op_or
id|fb_bpp
op_or
id|R128_GMC_SRC_DATATYPE_COLOR
op_or
id|R128_ROP3_P
op_or
id|R128_GMC_CLR_CMP_CNTL_DIS
op_or
id|R128_GMC_AUX_CLIP_DIS
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|dev_priv-&gt;back_pitch_offset_c
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|clear_color
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
(paren
id|x
op_lshift
l_int|16
)paren
op_or
id|y
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
(paren
id|w
op_lshift
l_int|16
)paren
op_or
id|h
)paren
suffix:semicolon
id|ADVANCE_RING
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|flags
op_amp
id|R128_DEPTH
)paren
(brace
id|BEGIN_RING
c_func
(paren
l_int|6
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|CCE_PACKET3
c_func
(paren
id|R128_CNTL_PAINT_MULTI
comma
l_int|4
)paren
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|R128_GMC_DST_PITCH_OFFSET_CNTL
op_or
id|R128_GMC_BRUSH_SOLID_COLOR
op_or
id|depth_bpp
op_or
id|R128_GMC_SRC_DATATYPE_COLOR
op_or
id|R128_ROP3_P
op_or
id|R128_GMC_CLR_CMP_CNTL_DIS
op_or
id|R128_GMC_AUX_CLIP_DIS
op_or
id|R128_GMC_WR_MSK_DIS
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|dev_priv-&gt;depth_pitch_offset_c
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|clear_depth
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
(paren
id|x
op_lshift
l_int|16
)paren
op_or
id|y
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
(paren
id|w
op_lshift
l_int|16
)paren
op_or
id|h
)paren
suffix:semicolon
id|ADVANCE_RING
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
)brace
DECL|function|r128_cce_dispatch_swap
r_static
r_void
id|r128_cce_dispatch_swap
c_func
(paren
id|drm_device_t
op_star
id|dev
)paren
(brace
id|drm_r128_private_t
op_star
id|dev_priv
op_assign
id|dev-&gt;dev_private
suffix:semicolon
id|drm_r128_sarea_t
op_star
id|sarea_priv
op_assign
id|dev_priv-&gt;sarea_priv
suffix:semicolon
r_int
id|nbox
op_assign
id|sarea_priv-&gt;nbox
suffix:semicolon
id|drm_clip_rect_t
op_star
id|pbox
op_assign
id|sarea_priv-&gt;boxes
suffix:semicolon
id|u32
id|fb_bpp
suffix:semicolon
r_int
id|i
suffix:semicolon
id|RING_LOCALS
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|r128_update_ring_snapshot
c_func
(paren
id|dev_priv
)paren
suffix:semicolon
macro_line|#if R128_PERFORMANCE_BOXES
multiline_comment|/* Do some trivial performance monitoring...&n;&t; */
id|r128_cce_performance_boxes
c_func
(paren
id|dev_priv
)paren
suffix:semicolon
macro_line|#endif
r_switch
c_cond
(paren
id|dev_priv-&gt;fb_bpp
)paren
(brace
r_case
l_int|16
suffix:colon
id|fb_bpp
op_assign
id|R128_GMC_DST_16BPP
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|32
suffix:colon
r_default
suffix:colon
id|fb_bpp
op_assign
id|R128_GMC_DST_32BPP
suffix:semicolon
r_break
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|nbox
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
id|x
op_assign
id|pbox
(braket
id|i
)braket
dot
id|x1
suffix:semicolon
r_int
id|y
op_assign
id|pbox
(braket
id|i
)braket
dot
id|y1
suffix:semicolon
r_int
id|w
op_assign
id|pbox
(braket
id|i
)braket
dot
id|x2
op_minus
id|x
suffix:semicolon
r_int
id|h
op_assign
id|pbox
(braket
id|i
)braket
dot
id|y2
op_minus
id|y
suffix:semicolon
id|BEGIN_RING
c_func
(paren
l_int|7
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|CCE_PACKET3
c_func
(paren
id|R128_CNTL_BITBLT_MULTI
comma
l_int|5
)paren
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|R128_GMC_SRC_PITCH_OFFSET_CNTL
op_or
id|R128_GMC_DST_PITCH_OFFSET_CNTL
op_or
id|R128_GMC_BRUSH_NONE
op_or
id|fb_bpp
op_or
id|R128_GMC_SRC_DATATYPE_COLOR
op_or
id|R128_ROP3_S
op_or
id|R128_DP_SRC_SOURCE_MEMORY
op_or
id|R128_GMC_CLR_CMP_CNTL_DIS
op_or
id|R128_GMC_AUX_CLIP_DIS
op_or
id|R128_GMC_WR_MSK_DIS
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|dev_priv-&gt;back_pitch_offset_c
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|dev_priv-&gt;front_pitch_offset_c
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
(paren
id|x
op_lshift
l_int|16
)paren
op_or
id|y
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
(paren
id|x
op_lshift
l_int|16
)paren
op_or
id|y
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
(paren
id|w
op_lshift
l_int|16
)paren
op_or
id|h
)paren
suffix:semicolon
id|ADVANCE_RING
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Increment the frame counter.  The client-side 3D driver must&n;&t; * throttle the framerate by waiting for this value before&n;&t; * performing the swapbuffer ioctl.&n;&t; */
id|dev_priv-&gt;sarea_priv-&gt;last_frame
op_increment
suffix:semicolon
id|BEGIN_RING
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|CCE_PACKET0
c_func
(paren
id|R128_LAST_FRAME_REG
comma
l_int|0
)paren
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|dev_priv-&gt;sarea_priv-&gt;last_frame
)paren
suffix:semicolon
id|ADVANCE_RING
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|r128_cce_dispatch_vertex
r_static
r_void
id|r128_cce_dispatch_vertex
c_func
(paren
id|drm_device_t
op_star
id|dev
comma
id|drm_buf_t
op_star
id|buf
)paren
(brace
id|drm_r128_private_t
op_star
id|dev_priv
op_assign
id|dev-&gt;dev_private
suffix:semicolon
id|drm_r128_buf_priv_t
op_star
id|buf_priv
op_assign
id|buf-&gt;dev_private
suffix:semicolon
id|drm_r128_sarea_t
op_star
id|sarea_priv
op_assign
id|dev_priv-&gt;sarea_priv
suffix:semicolon
r_int
id|format
op_assign
id|sarea_priv-&gt;vc_format
suffix:semicolon
r_int
id|offset
op_assign
id|dev_priv-&gt;buffers-&gt;offset
op_plus
id|buf-&gt;offset
op_minus
id|dev-&gt;agp-&gt;base
suffix:semicolon
r_int
id|size
op_assign
id|buf-&gt;used
suffix:semicolon
r_int
id|prim
op_assign
id|buf_priv-&gt;prim
suffix:semicolon
r_int
id|i
op_assign
l_int|0
suffix:semicolon
id|RING_LOCALS
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;%s: buf=%d nbox=%d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|buf-&gt;idx
comma
id|sarea_priv-&gt;nbox
)paren
suffix:semicolon
id|r128_update_ring_snapshot
c_func
(paren
id|dev_priv
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|0
)paren
id|r128_print_dirty
c_func
(paren
l_string|&quot;dispatch_vertex&quot;
comma
id|sarea_priv-&gt;dirty
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buf-&gt;used
)paren
(brace
id|buf_priv-&gt;dispatched
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|sarea_priv-&gt;dirty
op_amp
op_complement
id|R128_UPLOAD_CLIPRECTS
)paren
(brace
id|r128_emit_state
c_func
(paren
id|dev_priv
)paren
suffix:semicolon
)brace
r_do
(brace
multiline_comment|/* Emit the next set of up to three cliprects */
r_if
c_cond
(paren
id|i
OL
id|sarea_priv-&gt;nbox
)paren
(brace
id|r128_emit_clip_rects
c_func
(paren
id|dev_priv
comma
op_amp
id|sarea_priv-&gt;boxes
(braket
id|i
)braket
comma
id|sarea_priv-&gt;nbox
op_minus
id|i
)paren
suffix:semicolon
)brace
multiline_comment|/* Emit the vertex buffer rendering commands */
id|BEGIN_RING
c_func
(paren
l_int|5
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|CCE_PACKET3
c_func
(paren
id|R128_3D_RNDR_GEN_INDX_PRIM
comma
l_int|3
)paren
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|offset
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|size
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|format
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|prim
op_or
id|R128_CCE_VC_CNTL_PRIM_WALK_LIST
op_or
(paren
id|size
op_lshift
id|R128_CCE_VC_CNTL_NUM_SHIFT
)paren
)paren
suffix:semicolon
id|ADVANCE_RING
c_func
(paren
)paren
suffix:semicolon
id|i
op_add_assign
l_int|3
suffix:semicolon
)brace
r_while
c_loop
(paren
id|i
OL
id|sarea_priv-&gt;nbox
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|buf_priv-&gt;discard
)paren
(brace
id|buf_priv-&gt;age
op_assign
id|dev_priv-&gt;sarea_priv-&gt;last_dispatch
suffix:semicolon
multiline_comment|/* Emit the vertex buffer age */
id|BEGIN_RING
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|CCE_PACKET0
c_func
(paren
id|R128_LAST_DISPATCH_REG
comma
l_int|0
)paren
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|buf_priv-&gt;age
)paren
suffix:semicolon
id|ADVANCE_RING
c_func
(paren
)paren
suffix:semicolon
id|buf-&gt;pending
op_assign
l_int|1
suffix:semicolon
id|buf-&gt;used
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* FIXME: Check dispatched field */
id|buf_priv-&gt;dispatched
op_assign
l_int|0
suffix:semicolon
)brace
id|dev_priv-&gt;sarea_priv-&gt;last_dispatch
op_increment
suffix:semicolon
macro_line|#if 0
r_if
c_cond
(paren
id|dev_priv-&gt;submit_age
op_eq
id|R128_MAX_VB_AGE
)paren
(brace
id|ret
op_assign
id|r128_do_cce_idle
c_func
(paren
id|dev_priv
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
r_return
id|ret
suffix:semicolon
id|dev_priv-&gt;submit_age
op_assign
l_int|0
suffix:semicolon
id|r128_freelist_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
macro_line|#endif
id|sarea_priv-&gt;dirty
op_and_assign
op_complement
id|R128_UPLOAD_CLIPRECTS
suffix:semicolon
id|sarea_priv-&gt;nbox
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|r128_cce_dispatch_indirect
r_static
r_void
id|r128_cce_dispatch_indirect
c_func
(paren
id|drm_device_t
op_star
id|dev
comma
id|drm_buf_t
op_star
id|buf
comma
r_int
id|start
comma
r_int
id|end
)paren
(brace
id|drm_r128_private_t
op_star
id|dev_priv
op_assign
id|dev-&gt;dev_private
suffix:semicolon
id|drm_r128_buf_priv_t
op_star
id|buf_priv
op_assign
id|buf-&gt;dev_private
suffix:semicolon
id|RING_LOCALS
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;indirect: buf=%d s=0x%x e=0x%x&bslash;n&quot;
comma
id|buf-&gt;idx
comma
id|start
comma
id|end
)paren
suffix:semicolon
id|r128_update_ring_snapshot
c_func
(paren
id|dev_priv
)paren
suffix:semicolon
r_if
c_cond
(paren
id|start
op_ne
id|end
)paren
(brace
r_int
id|offset
op_assign
(paren
id|dev_priv-&gt;buffers-&gt;offset
op_minus
id|dev-&gt;agp-&gt;base
op_plus
id|buf-&gt;offset
op_plus
id|start
)paren
suffix:semicolon
r_int
id|dwords
op_assign
(paren
id|end
op_minus
id|start
op_plus
l_int|3
)paren
op_div
r_sizeof
(paren
id|u32
)paren
suffix:semicolon
multiline_comment|/* Indirect buffer data must be an even number of&n;&t;&t; * dwords, so if we&squot;ve been given an odd number we must&n;&t;&t; * pad the data with a Type-2 CCE packet.&n;&t;&t; */
r_if
c_cond
(paren
id|dwords
op_amp
l_int|1
)paren
(brace
id|u32
op_star
id|data
op_assign
(paren
id|u32
op_star
)paren
(paren
(paren
r_char
op_star
)paren
id|dev_priv-&gt;buffers-&gt;handle
op_plus
id|buf-&gt;offset
op_plus
id|start
)paren
suffix:semicolon
id|data
(braket
id|dwords
op_increment
)braket
op_assign
id|R128_CCE_PACKET2
suffix:semicolon
)brace
id|buf_priv-&gt;dispatched
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Fire off the indirect buffer */
id|BEGIN_RING
c_func
(paren
l_int|3
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|CCE_PACKET0
c_func
(paren
id|R128_PM4_IW_INDOFF
comma
l_int|1
)paren
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|offset
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|dwords
)paren
suffix:semicolon
id|ADVANCE_RING
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|buf_priv-&gt;discard
)paren
(brace
id|buf_priv-&gt;age
op_assign
id|dev_priv-&gt;sarea_priv-&gt;last_dispatch
suffix:semicolon
multiline_comment|/* Emit the indirect buffer age */
id|BEGIN_RING
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|CCE_PACKET0
c_func
(paren
id|R128_LAST_DISPATCH_REG
comma
l_int|0
)paren
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|buf_priv-&gt;age
)paren
suffix:semicolon
id|ADVANCE_RING
c_func
(paren
)paren
suffix:semicolon
id|buf-&gt;pending
op_assign
l_int|1
suffix:semicolon
id|buf-&gt;used
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* FIXME: Check dispatched field */
id|buf_priv-&gt;dispatched
op_assign
l_int|0
suffix:semicolon
)brace
id|dev_priv-&gt;sarea_priv-&gt;last_dispatch
op_increment
suffix:semicolon
macro_line|#if 0
r_if
c_cond
(paren
id|dev_priv-&gt;submit_age
op_eq
id|R128_MAX_VB_AGE
)paren
(brace
id|ret
op_assign
id|r128_do_cce_idle
c_func
(paren
id|dev_priv
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
r_return
id|ret
suffix:semicolon
id|dev_priv-&gt;submit_age
op_assign
l_int|0
suffix:semicolon
id|r128_freelist_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
macro_line|#endif
)brace
DECL|function|r128_cce_dispatch_indices
r_static
r_void
id|r128_cce_dispatch_indices
c_func
(paren
id|drm_device_t
op_star
id|dev
comma
id|drm_buf_t
op_star
id|buf
comma
r_int
id|start
comma
r_int
id|end
comma
r_int
id|count
)paren
(brace
id|drm_r128_private_t
op_star
id|dev_priv
op_assign
id|dev-&gt;dev_private
suffix:semicolon
id|drm_r128_buf_priv_t
op_star
id|buf_priv
op_assign
id|buf-&gt;dev_private
suffix:semicolon
id|drm_r128_sarea_t
op_star
id|sarea_priv
op_assign
id|dev_priv-&gt;sarea_priv
suffix:semicolon
r_int
id|format
op_assign
id|sarea_priv-&gt;vc_format
suffix:semicolon
r_int
id|offset
op_assign
id|dev_priv-&gt;buffers-&gt;offset
op_minus
id|dev-&gt;agp-&gt;base
suffix:semicolon
r_int
id|prim
op_assign
id|buf_priv-&gt;prim
suffix:semicolon
id|u32
op_star
id|data
suffix:semicolon
r_int
id|dwords
suffix:semicolon
r_int
id|i
op_assign
l_int|0
suffix:semicolon
id|RING_LOCALS
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;indices: s=%d e=%d c=%d&bslash;n&quot;
comma
id|start
comma
id|end
comma
id|count
)paren
suffix:semicolon
id|r128_update_ring_snapshot
c_func
(paren
id|dev_priv
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|0
)paren
id|r128_print_dirty
c_func
(paren
l_string|&quot;dispatch_indices&quot;
comma
id|sarea_priv-&gt;dirty
)paren
suffix:semicolon
r_if
c_cond
(paren
id|start
op_ne
id|end
)paren
(brace
id|buf_priv-&gt;dispatched
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|sarea_priv-&gt;dirty
op_amp
op_complement
id|R128_UPLOAD_CLIPRECTS
)paren
(brace
id|r128_emit_state
c_func
(paren
id|dev_priv
)paren
suffix:semicolon
)brace
id|dwords
op_assign
(paren
id|end
op_minus
id|start
op_plus
l_int|3
)paren
op_div
r_sizeof
(paren
id|u32
)paren
suffix:semicolon
id|data
op_assign
(paren
id|u32
op_star
)paren
(paren
(paren
r_char
op_star
)paren
id|dev_priv-&gt;buffers-&gt;handle
op_plus
id|buf-&gt;offset
op_plus
id|start
)paren
suffix:semicolon
id|data
(braket
l_int|0
)braket
op_assign
id|CCE_PACKET3
c_func
(paren
id|R128_3D_RNDR_GEN_INDX_PRIM
comma
id|dwords
op_minus
l_int|2
)paren
suffix:semicolon
id|data
(braket
l_int|1
)braket
op_assign
id|offset
suffix:semicolon
id|data
(braket
l_int|2
)braket
op_assign
id|R128_MAX_VB_VERTS
suffix:semicolon
id|data
(braket
l_int|3
)braket
op_assign
id|format
suffix:semicolon
id|data
(braket
l_int|4
)braket
op_assign
(paren
id|prim
op_or
id|R128_CCE_VC_CNTL_PRIM_WALK_IND
op_or
(paren
id|count
op_lshift
l_int|16
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
op_amp
l_int|0x1
)paren
(brace
id|data
(braket
id|dwords
op_minus
l_int|1
)braket
op_and_assign
l_int|0x0000ffff
suffix:semicolon
)brace
r_do
(brace
multiline_comment|/* Emit the next set of up to three cliprects */
r_if
c_cond
(paren
id|i
OL
id|sarea_priv-&gt;nbox
)paren
(brace
id|r128_emit_clip_rects
c_func
(paren
id|dev_priv
comma
op_amp
id|sarea_priv-&gt;boxes
(braket
id|i
)braket
comma
id|sarea_priv-&gt;nbox
op_minus
id|i
)paren
suffix:semicolon
)brace
id|r128_cce_dispatch_indirect
c_func
(paren
id|dev
comma
id|buf
comma
id|start
comma
id|end
)paren
suffix:semicolon
id|i
op_add_assign
l_int|3
suffix:semicolon
)brace
r_while
c_loop
(paren
id|i
OL
id|sarea_priv-&gt;nbox
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|buf_priv-&gt;discard
)paren
(brace
id|buf_priv-&gt;age
op_assign
id|dev_priv-&gt;sarea_priv-&gt;last_dispatch
suffix:semicolon
multiline_comment|/* Emit the vertex buffer age */
id|BEGIN_RING
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|CCE_PACKET0
c_func
(paren
id|R128_LAST_DISPATCH_REG
comma
l_int|0
)paren
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|buf_priv-&gt;age
)paren
suffix:semicolon
id|ADVANCE_RING
c_func
(paren
)paren
suffix:semicolon
id|buf-&gt;pending
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* FIXME: Check dispatched field */
id|buf_priv-&gt;dispatched
op_assign
l_int|0
suffix:semicolon
)brace
id|dev_priv-&gt;sarea_priv-&gt;last_dispatch
op_increment
suffix:semicolon
macro_line|#if 0
r_if
c_cond
(paren
id|dev_priv-&gt;submit_age
op_eq
id|R128_MAX_VB_AGE
)paren
(brace
id|ret
op_assign
id|r128_do_cce_idle
c_func
(paren
id|dev_priv
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
r_return
id|ret
suffix:semicolon
id|dev_priv-&gt;submit_age
op_assign
l_int|0
suffix:semicolon
id|r128_freelist_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
macro_line|#endif
id|sarea_priv-&gt;dirty
op_and_assign
op_complement
id|R128_UPLOAD_CLIPRECTS
suffix:semicolon
id|sarea_priv-&gt;nbox
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|r128_cce_dispatch_blit
r_static
r_int
id|r128_cce_dispatch_blit
c_func
(paren
id|drm_device_t
op_star
id|dev
comma
id|drm_r128_blit_t
op_star
id|blit
)paren
(brace
id|drm_r128_private_t
op_star
id|dev_priv
op_assign
id|dev-&gt;dev_private
suffix:semicolon
id|drm_device_dma_t
op_star
id|dma
op_assign
id|dev-&gt;dma
suffix:semicolon
id|drm_buf_t
op_star
id|buf
suffix:semicolon
id|drm_r128_buf_priv_t
op_star
id|buf_priv
suffix:semicolon
id|u32
op_star
id|data
suffix:semicolon
r_int
id|dword_shift
comma
id|dwords
suffix:semicolon
id|RING_LOCALS
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|r128_update_ring_snapshot
c_func
(paren
id|dev_priv
)paren
suffix:semicolon
multiline_comment|/* The compiler won&squot;t optimize away a division by a variable,&n;&t; * even if the only legal values are powers of two.  Thus, we&squot;ll&n;&t; * use a shift instead.&n;&t; */
r_switch
c_cond
(paren
id|blit-&gt;format
)paren
(brace
r_case
id|R128_DATATYPE_ARGB1555
suffix:colon
r_case
id|R128_DATATYPE_RGB565
suffix:colon
r_case
id|R128_DATATYPE_ARGB4444
suffix:colon
id|dword_shift
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|R128_DATATYPE_ARGB8888
suffix:colon
id|dword_shift
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|DRM_ERROR
c_func
(paren
l_string|&quot;invalid blit format %d&bslash;n&quot;
comma
id|blit-&gt;format
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* Flush the pixel cache, and mark the contents as Read Invalid.&n;&t; * This ensures no pixel data gets mixed up with the texture&n;&t; * data from the host data blit, otherwise part of the texture&n;&t; * image may be corrupted.&n;&t; */
id|BEGIN_RING
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|CCE_PACKET0
c_func
(paren
id|R128_PC_GUI_CTLSTAT
comma
l_int|0
)paren
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|R128_PC_RI_GUI
op_or
id|R128_PC_FLUSH_GUI
)paren
suffix:semicolon
id|ADVANCE_RING
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Dispatch the indirect buffer.&n;&t; */
id|buf
op_assign
id|dma-&gt;buflist
(braket
id|blit-&gt;idx
)braket
suffix:semicolon
id|buf_priv
op_assign
id|buf-&gt;dev_private
suffix:semicolon
r_if
c_cond
(paren
id|buf-&gt;pid
op_ne
id|current-&gt;pid
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;process %d using buffer owned by %d&bslash;n&quot;
comma
id|current-&gt;pid
comma
id|buf-&gt;pid
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|buf-&gt;pending
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;sending pending buffer %d&bslash;n&quot;
comma
id|blit-&gt;idx
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|buf_priv-&gt;discard
op_assign
l_int|1
suffix:semicolon
id|dwords
op_assign
(paren
id|blit-&gt;width
op_star
id|blit-&gt;height
)paren
op_rshift
id|dword_shift
suffix:semicolon
id|data
op_assign
(paren
id|u32
op_star
)paren
(paren
(paren
r_char
op_star
)paren
id|dev_priv-&gt;buffers-&gt;handle
op_plus
id|buf-&gt;offset
)paren
suffix:semicolon
id|data
(braket
l_int|0
)braket
op_assign
id|CCE_PACKET3
c_func
(paren
id|R128_CNTL_HOSTDATA_BLT
comma
id|dwords
op_plus
l_int|6
)paren
suffix:semicolon
id|data
(braket
l_int|1
)braket
op_assign
(paren
id|R128_GMC_DST_PITCH_OFFSET_CNTL
op_or
id|R128_GMC_BRUSH_NONE
op_or
(paren
id|blit-&gt;format
op_lshift
l_int|8
)paren
op_or
id|R128_GMC_SRC_DATATYPE_COLOR
op_or
id|R128_ROP3_S
op_or
id|R128_DP_SRC_SOURCE_HOST_DATA
op_or
id|R128_GMC_CLR_CMP_CNTL_DIS
op_or
id|R128_GMC_AUX_CLIP_DIS
op_or
id|R128_GMC_WR_MSK_DIS
)paren
suffix:semicolon
id|data
(braket
l_int|2
)braket
op_assign
(paren
id|blit-&gt;pitch
op_lshift
l_int|21
)paren
op_or
(paren
id|blit-&gt;offset
op_rshift
l_int|5
)paren
suffix:semicolon
id|data
(braket
l_int|3
)braket
op_assign
l_int|0xffffffff
suffix:semicolon
id|data
(braket
l_int|4
)braket
op_assign
l_int|0xffffffff
suffix:semicolon
id|data
(braket
l_int|5
)braket
op_assign
(paren
id|blit-&gt;y
op_lshift
l_int|16
)paren
op_or
id|blit-&gt;x
suffix:semicolon
id|data
(braket
l_int|6
)braket
op_assign
(paren
id|blit-&gt;height
op_lshift
l_int|16
)paren
op_or
id|blit-&gt;width
suffix:semicolon
id|data
(braket
l_int|7
)braket
op_assign
id|dwords
suffix:semicolon
id|buf-&gt;used
op_assign
(paren
id|dwords
op_plus
l_int|8
)paren
op_star
r_sizeof
(paren
id|u32
)paren
suffix:semicolon
id|r128_cce_dispatch_indirect
c_func
(paren
id|dev
comma
id|buf
comma
l_int|0
comma
id|buf-&gt;used
)paren
suffix:semicolon
multiline_comment|/* Flush the pixel cache after the blit completes.  This ensures&n;&t; * the texture data is written out to memory before rendering&n;&t; * continues.&n;&t; */
id|BEGIN_RING
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|CCE_PACKET0
c_func
(paren
id|R128_PC_GUI_CTLSTAT
comma
l_int|0
)paren
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|R128_PC_FLUSH_GUI
)paren
suffix:semicolon
id|ADVANCE_RING
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* ================================================================&n; * Tiled depth buffer management&n; *&n; * FIXME: These should all set the destination write mask for when we&n; * have hardware stencil support.&n; */
DECL|function|r128_cce_dispatch_write_span
r_static
r_int
id|r128_cce_dispatch_write_span
c_func
(paren
id|drm_device_t
op_star
id|dev
comma
id|drm_r128_depth_t
op_star
id|depth
)paren
(brace
id|drm_r128_private_t
op_star
id|dev_priv
op_assign
id|dev-&gt;dev_private
suffix:semicolon
r_int
id|count
comma
id|x
comma
id|y
suffix:semicolon
id|u32
op_star
id|buffer
suffix:semicolon
id|u8
op_star
id|mask
suffix:semicolon
id|u32
id|depth_bpp
suffix:semicolon
r_int
id|i
suffix:semicolon
id|RING_LOCALS
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|r128_update_ring_snapshot
c_func
(paren
id|dev_priv
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|dev_priv-&gt;depth_bpp
)paren
(brace
r_case
l_int|16
suffix:colon
id|depth_bpp
op_assign
id|R128_GMC_DST_16BPP
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|24
suffix:colon
r_case
l_int|32
suffix:colon
id|depth_bpp
op_assign
id|R128_GMC_DST_32BPP
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|count
op_assign
id|depth-&gt;n
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|x
comma
id|depth-&gt;x
comma
r_sizeof
(paren
id|x
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|y
comma
id|depth-&gt;y
comma
r_sizeof
(paren
id|y
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|buffer
op_assign
id|kmalloc
c_func
(paren
id|depth-&gt;n
op_star
r_sizeof
(paren
id|u32
)paren
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buffer
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|buffer
comma
id|depth-&gt;buffer
comma
id|depth-&gt;n
op_star
r_sizeof
(paren
id|u32
)paren
)paren
)paren
(brace
id|kfree
c_func
(paren
id|buffer
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|depth-&gt;mask
)paren
(brace
id|mask
op_assign
id|kmalloc
c_func
(paren
id|depth-&gt;n
op_star
r_sizeof
(paren
id|u8
)paren
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mask
op_eq
l_int|NULL
)paren
(brace
id|kfree
c_func
(paren
id|buffer
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|mask
comma
id|depth-&gt;mask
comma
id|depth-&gt;n
op_star
r_sizeof
(paren
id|u8
)paren
)paren
)paren
(brace
id|kfree
c_func
(paren
id|buffer
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|mask
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
suffix:semicolon
id|i
op_increment
comma
id|x
op_increment
)paren
(brace
r_if
c_cond
(paren
id|mask
(braket
id|i
)braket
)paren
(brace
id|BEGIN_RING
c_func
(paren
l_int|6
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|CCE_PACKET3
c_func
(paren
id|R128_CNTL_PAINT_MULTI
comma
l_int|4
)paren
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|R128_GMC_DST_PITCH_OFFSET_CNTL
op_or
id|R128_GMC_BRUSH_SOLID_COLOR
op_or
id|depth_bpp
op_or
id|R128_GMC_SRC_DATATYPE_COLOR
op_or
id|R128_ROP3_P
op_or
id|R128_GMC_CLR_CMP_CNTL_DIS
op_or
id|R128_GMC_WR_MSK_DIS
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|dev_priv-&gt;depth_pitch_offset_c
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|buffer
(braket
id|i
)braket
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
(paren
id|x
op_lshift
l_int|16
)paren
op_or
id|y
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
(paren
l_int|1
op_lshift
l_int|16
)paren
op_or
l_int|1
)paren
suffix:semicolon
id|ADVANCE_RING
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
id|kfree
c_func
(paren
id|mask
)paren
suffix:semicolon
)brace
r_else
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
suffix:semicolon
id|i
op_increment
comma
id|x
op_increment
)paren
(brace
id|BEGIN_RING
c_func
(paren
l_int|6
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|CCE_PACKET3
c_func
(paren
id|R128_CNTL_PAINT_MULTI
comma
l_int|4
)paren
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|R128_GMC_DST_PITCH_OFFSET_CNTL
op_or
id|R128_GMC_BRUSH_SOLID_COLOR
op_or
id|depth_bpp
op_or
id|R128_GMC_SRC_DATATYPE_COLOR
op_or
id|R128_ROP3_P
op_or
id|R128_GMC_CLR_CMP_CNTL_DIS
op_or
id|R128_GMC_WR_MSK_DIS
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|dev_priv-&gt;depth_pitch_offset_c
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|buffer
(braket
id|i
)braket
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
(paren
id|x
op_lshift
l_int|16
)paren
op_or
id|y
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
(paren
l_int|1
op_lshift
l_int|16
)paren
op_or
l_int|1
)paren
suffix:semicolon
id|ADVANCE_RING
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
id|kfree
c_func
(paren
id|buffer
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|r128_cce_dispatch_write_pixels
r_static
r_int
id|r128_cce_dispatch_write_pixels
c_func
(paren
id|drm_device_t
op_star
id|dev
comma
id|drm_r128_depth_t
op_star
id|depth
)paren
(brace
id|drm_r128_private_t
op_star
id|dev_priv
op_assign
id|dev-&gt;dev_private
suffix:semicolon
r_int
id|count
comma
op_star
id|x
comma
op_star
id|y
suffix:semicolon
id|u32
op_star
id|buffer
suffix:semicolon
id|u8
op_star
id|mask
suffix:semicolon
id|u32
id|depth_bpp
suffix:semicolon
r_int
id|i
suffix:semicolon
id|RING_LOCALS
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|r128_update_ring_snapshot
c_func
(paren
id|dev_priv
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|dev_priv-&gt;depth_bpp
)paren
(brace
r_case
l_int|16
suffix:colon
id|depth_bpp
op_assign
id|R128_GMC_DST_16BPP
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|24
suffix:colon
r_case
l_int|32
suffix:colon
id|depth_bpp
op_assign
id|R128_GMC_DST_32BPP
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|count
op_assign
id|depth-&gt;n
suffix:semicolon
id|x
op_assign
id|kmalloc
c_func
(paren
id|count
op_star
r_sizeof
(paren
op_star
id|x
)paren
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|x
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|y
op_assign
id|kmalloc
c_func
(paren
id|count
op_star
r_sizeof
(paren
op_star
id|y
)paren
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|y
op_eq
l_int|NULL
)paren
(brace
id|kfree
c_func
(paren
id|x
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|x
comma
id|depth-&gt;x
comma
id|count
op_star
r_sizeof
(paren
r_int
)paren
)paren
)paren
(brace
id|kfree
c_func
(paren
id|x
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|y
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|y
comma
id|depth-&gt;y
comma
id|count
op_star
r_sizeof
(paren
r_int
)paren
)paren
)paren
(brace
id|kfree
c_func
(paren
id|x
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|y
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|buffer
op_assign
id|kmalloc
c_func
(paren
id|depth-&gt;n
op_star
r_sizeof
(paren
id|u32
)paren
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buffer
op_eq
l_int|NULL
)paren
(brace
id|kfree
c_func
(paren
id|x
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|y
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|buffer
comma
id|depth-&gt;buffer
comma
id|depth-&gt;n
op_star
r_sizeof
(paren
id|u32
)paren
)paren
)paren
(brace
id|kfree
c_func
(paren
id|x
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|y
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|buffer
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|depth-&gt;mask
)paren
(brace
id|mask
op_assign
id|kmalloc
c_func
(paren
id|depth-&gt;n
op_star
r_sizeof
(paren
id|u8
)paren
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mask
op_eq
l_int|NULL
)paren
(brace
id|kfree
c_func
(paren
id|x
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|y
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|buffer
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|mask
comma
id|depth-&gt;mask
comma
id|depth-&gt;n
op_star
r_sizeof
(paren
id|u8
)paren
)paren
)paren
(brace
id|kfree
c_func
(paren
id|x
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|y
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|buffer
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|mask
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|mask
(braket
id|i
)braket
)paren
(brace
id|BEGIN_RING
c_func
(paren
l_int|6
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|CCE_PACKET3
c_func
(paren
id|R128_CNTL_PAINT_MULTI
comma
l_int|4
)paren
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|R128_GMC_DST_PITCH_OFFSET_CNTL
op_or
id|R128_GMC_BRUSH_SOLID_COLOR
op_or
id|depth_bpp
op_or
id|R128_GMC_SRC_DATATYPE_COLOR
op_or
id|R128_ROP3_P
op_or
id|R128_GMC_CLR_CMP_CNTL_DIS
op_or
id|R128_GMC_WR_MSK_DIS
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|dev_priv-&gt;depth_pitch_offset_c
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|buffer
(braket
id|i
)braket
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
(paren
id|x
(braket
id|i
)braket
op_lshift
l_int|16
)paren
op_or
id|y
(braket
id|i
)braket
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
(paren
l_int|1
op_lshift
l_int|16
)paren
op_or
l_int|1
)paren
suffix:semicolon
id|ADVANCE_RING
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
id|kfree
c_func
(paren
id|mask
)paren
suffix:semicolon
)brace
r_else
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|BEGIN_RING
c_func
(paren
l_int|6
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|CCE_PACKET3
c_func
(paren
id|R128_CNTL_PAINT_MULTI
comma
l_int|4
)paren
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|R128_GMC_DST_PITCH_OFFSET_CNTL
op_or
id|R128_GMC_BRUSH_SOLID_COLOR
op_or
id|depth_bpp
op_or
id|R128_GMC_SRC_DATATYPE_COLOR
op_or
id|R128_ROP3_P
op_or
id|R128_GMC_CLR_CMP_CNTL_DIS
op_or
id|R128_GMC_WR_MSK_DIS
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|dev_priv-&gt;depth_pitch_offset_c
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|buffer
(braket
id|i
)braket
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
(paren
id|x
(braket
id|i
)braket
op_lshift
l_int|16
)paren
op_or
id|y
(braket
id|i
)braket
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
(paren
l_int|1
op_lshift
l_int|16
)paren
op_or
l_int|1
)paren
suffix:semicolon
id|ADVANCE_RING
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
id|kfree
c_func
(paren
id|x
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|y
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|buffer
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|r128_cce_dispatch_read_span
r_static
r_int
id|r128_cce_dispatch_read_span
c_func
(paren
id|drm_device_t
op_star
id|dev
comma
id|drm_r128_depth_t
op_star
id|depth
)paren
(brace
id|drm_r128_private_t
op_star
id|dev_priv
op_assign
id|dev-&gt;dev_private
suffix:semicolon
r_int
id|count
comma
id|x
comma
id|y
suffix:semicolon
id|u32
id|depth_bpp
suffix:semicolon
id|RING_LOCALS
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|r128_update_ring_snapshot
c_func
(paren
id|dev_priv
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|dev_priv-&gt;depth_bpp
)paren
(brace
r_case
l_int|16
suffix:colon
id|depth_bpp
op_assign
id|R128_GMC_DST_16BPP
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|24
suffix:colon
r_case
l_int|32
suffix:colon
id|depth_bpp
op_assign
id|R128_GMC_DST_32BPP
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|count
op_assign
id|depth-&gt;n
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|x
comma
id|depth-&gt;x
comma
r_sizeof
(paren
id|x
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|y
comma
id|depth-&gt;y
comma
r_sizeof
(paren
id|y
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|BEGIN_RING
c_func
(paren
l_int|7
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|CCE_PACKET3
c_func
(paren
id|R128_CNTL_BITBLT_MULTI
comma
l_int|5
)paren
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|R128_GMC_SRC_PITCH_OFFSET_CNTL
op_or
id|R128_GMC_DST_PITCH_OFFSET_CNTL
op_or
id|R128_GMC_BRUSH_NONE
op_or
id|depth_bpp
op_or
id|R128_GMC_SRC_DATATYPE_COLOR
op_or
id|R128_ROP3_S
op_or
id|R128_DP_SRC_SOURCE_MEMORY
op_or
id|R128_GMC_CLR_CMP_CNTL_DIS
op_or
id|R128_GMC_WR_MSK_DIS
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|dev_priv-&gt;depth_pitch_offset_c
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|dev_priv-&gt;span_pitch_offset_c
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
(paren
id|x
op_lshift
l_int|16
)paren
op_or
id|y
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
(paren
l_int|0
op_lshift
l_int|16
)paren
op_or
l_int|0
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
(paren
id|count
op_lshift
l_int|16
)paren
op_or
l_int|1
)paren
suffix:semicolon
id|ADVANCE_RING
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|r128_cce_dispatch_read_pixels
r_static
r_int
id|r128_cce_dispatch_read_pixels
c_func
(paren
id|drm_device_t
op_star
id|dev
comma
id|drm_r128_depth_t
op_star
id|depth
)paren
(brace
id|drm_r128_private_t
op_star
id|dev_priv
op_assign
id|dev-&gt;dev_private
suffix:semicolon
r_int
id|count
comma
op_star
id|x
comma
op_star
id|y
suffix:semicolon
id|u32
id|depth_bpp
suffix:semicolon
r_int
id|i
suffix:semicolon
id|RING_LOCALS
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|r128_update_ring_snapshot
c_func
(paren
id|dev_priv
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|dev_priv-&gt;depth_bpp
)paren
(brace
r_case
l_int|16
suffix:colon
id|depth_bpp
op_assign
id|R128_GMC_DST_16BPP
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|24
suffix:colon
r_case
l_int|32
suffix:colon
id|depth_bpp
op_assign
id|R128_GMC_DST_32BPP
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|count
op_assign
id|depth-&gt;n
suffix:semicolon
r_if
c_cond
(paren
id|count
OG
id|dev_priv-&gt;depth_pitch
)paren
(brace
id|count
op_assign
id|dev_priv-&gt;depth_pitch
suffix:semicolon
)brace
id|x
op_assign
id|kmalloc
c_func
(paren
id|count
op_star
r_sizeof
(paren
op_star
id|x
)paren
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|x
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|y
op_assign
id|kmalloc
c_func
(paren
id|count
op_star
r_sizeof
(paren
op_star
id|y
)paren
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|y
op_eq
l_int|NULL
)paren
(brace
id|kfree
c_func
(paren
id|x
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|x
comma
id|depth-&gt;x
comma
id|count
op_star
r_sizeof
(paren
r_int
)paren
)paren
)paren
(brace
id|kfree
c_func
(paren
id|x
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|y
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|y
comma
id|depth-&gt;y
comma
id|count
op_star
r_sizeof
(paren
r_int
)paren
)paren
)paren
(brace
id|kfree
c_func
(paren
id|x
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|y
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|BEGIN_RING
c_func
(paren
l_int|7
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|CCE_PACKET3
c_func
(paren
id|R128_CNTL_BITBLT_MULTI
comma
l_int|5
)paren
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|R128_GMC_SRC_PITCH_OFFSET_CNTL
op_or
id|R128_GMC_DST_PITCH_OFFSET_CNTL
op_or
id|R128_GMC_BRUSH_NONE
op_or
id|depth_bpp
op_or
id|R128_GMC_SRC_DATATYPE_COLOR
op_or
id|R128_ROP3_S
op_or
id|R128_DP_SRC_SOURCE_MEMORY
op_or
id|R128_GMC_CLR_CMP_CNTL_DIS
op_or
id|R128_GMC_WR_MSK_DIS
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|dev_priv-&gt;depth_pitch_offset_c
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|dev_priv-&gt;span_pitch_offset_c
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
(paren
id|x
(braket
id|i
)braket
op_lshift
l_int|16
)paren
op_or
id|y
(braket
id|i
)braket
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
(paren
id|i
op_lshift
l_int|16
)paren
op_or
l_int|0
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
(paren
l_int|1
op_lshift
l_int|16
)paren
op_or
l_int|1
)paren
suffix:semicolon
id|ADVANCE_RING
c_func
(paren
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|x
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|y
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* ================================================================&n; * Polygon stipple&n; */
DECL|function|r128_cce_dispatch_stipple
r_static
r_void
id|r128_cce_dispatch_stipple
c_func
(paren
id|drm_device_t
op_star
id|dev
comma
id|u32
op_star
id|stipple
)paren
(brace
id|drm_r128_private_t
op_star
id|dev_priv
op_assign
id|dev-&gt;dev_private
suffix:semicolon
r_int
id|i
suffix:semicolon
id|RING_LOCALS
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|r128_update_ring_snapshot
c_func
(paren
id|dev_priv
)paren
suffix:semicolon
id|BEGIN_RING
c_func
(paren
l_int|33
)paren
suffix:semicolon
id|OUT_RING
c_func
(paren
id|CCE_PACKET0
c_func
(paren
id|R128_BRUSH_DATA0
comma
l_int|31
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
(brace
id|OUT_RING
c_func
(paren
id|stipple
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|ADVANCE_RING
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* ================================================================&n; * IOCTL functions&n; */
DECL|function|r128_cce_clear
r_int
id|r128_cce_clear
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
id|drm_file_t
op_star
id|priv
op_assign
id|filp-&gt;private_data
suffix:semicolon
id|drm_device_t
op_star
id|dev
op_assign
id|priv-&gt;dev
suffix:semicolon
id|drm_r128_private_t
op_star
id|dev_priv
op_assign
id|dev-&gt;dev_private
suffix:semicolon
id|drm_r128_sarea_t
op_star
id|sarea_priv
op_assign
id|dev_priv-&gt;sarea_priv
suffix:semicolon
id|drm_r128_clear_t
id|clear
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|_DRM_LOCK_IS_HELD
c_func
(paren
id|dev-&gt;lock.hw_lock-&gt;lock
)paren
op_logical_or
id|dev-&gt;lock.pid
op_ne
id|current-&gt;pid
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;r128_cce_clear called without lock held&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|clear
comma
(paren
id|drm_r128_clear_t
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|clear
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|sarea_priv-&gt;nbox
OG
id|R128_NR_SAREA_CLIPRECTS
)paren
id|sarea_priv-&gt;nbox
op_assign
id|R128_NR_SAREA_CLIPRECTS
suffix:semicolon
id|r128_cce_dispatch_clear
c_func
(paren
id|dev
comma
id|clear.flags
comma
id|clear.x
comma
id|clear.y
comma
id|clear.w
comma
id|clear.h
comma
id|clear.clear_color
comma
id|clear.clear_depth
)paren
suffix:semicolon
multiline_comment|/* Make sure we restore the 3D state next time.&n;&t; */
id|dev_priv-&gt;sarea_priv-&gt;dirty
op_or_assign
id|R128_UPLOAD_CONTEXT
op_or
id|R128_UPLOAD_MASKS
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|r128_cce_swap
r_int
id|r128_cce_swap
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
id|drm_file_t
op_star
id|priv
op_assign
id|filp-&gt;private_data
suffix:semicolon
id|drm_device_t
op_star
id|dev
op_assign
id|priv-&gt;dev
suffix:semicolon
id|drm_r128_private_t
op_star
id|dev_priv
op_assign
id|dev-&gt;dev_private
suffix:semicolon
id|drm_r128_sarea_t
op_star
id|sarea_priv
op_assign
id|dev_priv-&gt;sarea_priv
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|_DRM_LOCK_IS_HELD
c_func
(paren
id|dev-&gt;lock.hw_lock-&gt;lock
)paren
op_logical_or
id|dev-&gt;lock.pid
op_ne
id|current-&gt;pid
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;r128_cce_swap called without lock held&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sarea_priv-&gt;nbox
OG
id|R128_NR_SAREA_CLIPRECTS
)paren
id|sarea_priv-&gt;nbox
op_assign
id|R128_NR_SAREA_CLIPRECTS
suffix:semicolon
id|r128_cce_dispatch_swap
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Make sure we restore the 3D state next time.&n;&t; */
id|dev_priv-&gt;sarea_priv-&gt;dirty
op_or_assign
id|R128_UPLOAD_CONTEXT
op_or
id|R128_UPLOAD_MASKS
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|r128_cce_vertex
r_int
id|r128_cce_vertex
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
id|drm_file_t
op_star
id|priv
op_assign
id|filp-&gt;private_data
suffix:semicolon
id|drm_device_t
op_star
id|dev
op_assign
id|priv-&gt;dev
suffix:semicolon
id|drm_r128_private_t
op_star
id|dev_priv
op_assign
id|dev-&gt;dev_private
suffix:semicolon
id|drm_device_dma_t
op_star
id|dma
op_assign
id|dev-&gt;dma
suffix:semicolon
id|drm_buf_t
op_star
id|buf
suffix:semicolon
id|drm_r128_buf_priv_t
op_star
id|buf_priv
suffix:semicolon
id|drm_r128_vertex_t
id|vertex
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|_DRM_LOCK_IS_HELD
c_func
(paren
id|dev-&gt;lock.hw_lock-&gt;lock
)paren
op_logical_or
id|dev-&gt;lock.pid
op_ne
id|current-&gt;pid
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;%s called without lock held&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|dev_priv
op_logical_or
id|dev_priv-&gt;is_pci
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;%s called with a PCI card&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|vertex
comma
(paren
id|drm_r128_vertex_t
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|vertex
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;%s: pid=%d index=%d count=%d discard=%d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|current-&gt;pid
comma
id|vertex.idx
comma
id|vertex.count
comma
id|vertex.discard
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vertex.idx
OL
l_int|0
op_logical_or
id|vertex.idx
op_ge
id|dma-&gt;buf_count
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;buffer index %d (of %d max)&bslash;n&quot;
comma
id|vertex.idx
comma
id|dma-&gt;buf_count
op_minus
l_int|1
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|vertex.prim
template_param
id|R128_CCE_VC_CNTL_PRIM_TYPE_TRI_TYPE2
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;buffer prim %d&bslash;n&quot;
comma
id|vertex.prim
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|buf
op_assign
id|dma-&gt;buflist
(braket
id|vertex.idx
)braket
suffix:semicolon
id|buf_priv
op_assign
id|buf-&gt;dev_private
suffix:semicolon
r_if
c_cond
(paren
id|buf-&gt;pid
op_ne
id|current-&gt;pid
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;process %d using buffer owned by %d&bslash;n&quot;
comma
id|current-&gt;pid
comma
id|buf-&gt;pid
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|buf-&gt;pending
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;sending pending buffer %d&bslash;n&quot;
comma
id|vertex.idx
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|buf-&gt;used
op_assign
id|vertex.count
suffix:semicolon
id|buf_priv-&gt;prim
op_assign
id|vertex.prim
suffix:semicolon
id|buf_priv-&gt;discard
op_assign
id|vertex.discard
suffix:semicolon
id|r128_cce_dispatch_vertex
c_func
(paren
id|dev
comma
id|buf
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|r128_cce_indices
r_int
id|r128_cce_indices
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
id|drm_file_t
op_star
id|priv
op_assign
id|filp-&gt;private_data
suffix:semicolon
id|drm_device_t
op_star
id|dev
op_assign
id|priv-&gt;dev
suffix:semicolon
id|drm_r128_private_t
op_star
id|dev_priv
op_assign
id|dev-&gt;dev_private
suffix:semicolon
id|drm_device_dma_t
op_star
id|dma
op_assign
id|dev-&gt;dma
suffix:semicolon
id|drm_buf_t
op_star
id|buf
suffix:semicolon
id|drm_r128_buf_priv_t
op_star
id|buf_priv
suffix:semicolon
id|drm_r128_indices_t
id|elts
suffix:semicolon
r_int
id|count
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|_DRM_LOCK_IS_HELD
c_func
(paren
id|dev-&gt;lock.hw_lock-&gt;lock
)paren
op_logical_or
id|dev-&gt;lock.pid
op_ne
id|current-&gt;pid
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;%s called without lock held&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|dev_priv
op_logical_or
id|dev_priv-&gt;is_pci
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;%s called with a PCI card&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|elts
comma
(paren
id|drm_r128_indices_t
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|elts
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;%s: pid=%d buf=%d s=%d e=%d d=%d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|current-&gt;pid
comma
id|elts.idx
comma
id|elts.start
comma
id|elts.end
comma
id|elts.discard
)paren
suffix:semicolon
r_if
c_cond
(paren
id|elts.idx
OL
l_int|0
op_logical_or
id|elts.idx
op_ge
id|dma-&gt;buf_count
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;buffer index %d (of %d max)&bslash;n&quot;
comma
id|elts.idx
comma
id|dma-&gt;buf_count
op_minus
l_int|1
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|elts.prim
template_param
id|R128_CCE_VC_CNTL_PRIM_TYPE_TRI_TYPE2
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;buffer prim %d&bslash;n&quot;
comma
id|elts.prim
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|buf
op_assign
id|dma-&gt;buflist
(braket
id|elts.idx
)braket
suffix:semicolon
id|buf_priv
op_assign
id|buf-&gt;dev_private
suffix:semicolon
r_if
c_cond
(paren
id|buf-&gt;pid
op_ne
id|current-&gt;pid
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;process %d using buffer owned by %d&bslash;n&quot;
comma
id|current-&gt;pid
comma
id|buf-&gt;pid
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|buf-&gt;pending
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;sending pending buffer %d&bslash;n&quot;
comma
id|elts.idx
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|count
op_assign
(paren
id|elts.end
op_minus
id|elts.start
)paren
op_div
r_sizeof
(paren
id|u16
)paren
suffix:semicolon
id|elts.start
op_sub_assign
id|R128_INDEX_PRIM_OFFSET
suffix:semicolon
r_if
c_cond
(paren
id|elts.start
op_amp
l_int|0x7
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;misaligned buffer 0x%x&bslash;n&quot;
comma
id|elts.start
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|elts.start
OL
id|buf-&gt;used
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;no header 0x%x - 0x%x&bslash;n&quot;
comma
id|elts.start
comma
id|buf-&gt;used
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|buf-&gt;used
op_assign
id|elts.end
suffix:semicolon
id|buf_priv-&gt;prim
op_assign
id|elts.prim
suffix:semicolon
id|buf_priv-&gt;discard
op_assign
id|elts.discard
suffix:semicolon
id|r128_cce_dispatch_indices
c_func
(paren
id|dev
comma
id|buf
comma
id|elts.start
comma
id|elts.end
comma
id|count
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|r128_cce_blit
r_int
id|r128_cce_blit
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
id|drm_file_t
op_star
id|priv
op_assign
id|filp-&gt;private_data
suffix:semicolon
id|drm_device_t
op_star
id|dev
op_assign
id|priv-&gt;dev
suffix:semicolon
id|drm_device_dma_t
op_star
id|dma
op_assign
id|dev-&gt;dma
suffix:semicolon
id|drm_r128_blit_t
id|blit
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|_DRM_LOCK_IS_HELD
c_func
(paren
id|dev-&gt;lock.hw_lock-&gt;lock
)paren
op_logical_or
id|dev-&gt;lock.pid
op_ne
id|current-&gt;pid
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;%s called without lock held&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|blit
comma
(paren
id|drm_r128_blit_t
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|blit
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;%s: pid=%d index=%d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|current-&gt;pid
comma
id|blit.idx
)paren
suffix:semicolon
r_if
c_cond
(paren
id|blit.idx
OL
l_int|0
op_logical_or
id|blit.idx
op_ge
id|dma-&gt;buf_count
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;buffer index %d (of %d max)&bslash;n&quot;
comma
id|blit.idx
comma
id|dma-&gt;buf_count
op_minus
l_int|1
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
id|r128_cce_dispatch_blit
c_func
(paren
id|dev
comma
op_amp
id|blit
)paren
suffix:semicolon
)brace
DECL|function|r128_cce_depth
r_int
id|r128_cce_depth
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
id|drm_file_t
op_star
id|priv
op_assign
id|filp-&gt;private_data
suffix:semicolon
id|drm_device_t
op_star
id|dev
op_assign
id|priv-&gt;dev
suffix:semicolon
id|drm_r128_depth_t
id|depth
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|_DRM_LOCK_IS_HELD
c_func
(paren
id|dev-&gt;lock.hw_lock-&gt;lock
)paren
op_logical_or
id|dev-&gt;lock.pid
op_ne
id|current-&gt;pid
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;%s called without lock held&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|depth
comma
(paren
id|drm_r128_depth_t
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|depth
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_switch
c_cond
(paren
id|depth.func
)paren
(brace
r_case
id|R128_WRITE_SPAN
suffix:colon
r_return
id|r128_cce_dispatch_write_span
c_func
(paren
id|dev
comma
op_amp
id|depth
)paren
suffix:semicolon
r_case
id|R128_WRITE_PIXELS
suffix:colon
r_return
id|r128_cce_dispatch_write_pixels
c_func
(paren
id|dev
comma
op_amp
id|depth
)paren
suffix:semicolon
r_case
id|R128_READ_SPAN
suffix:colon
r_return
id|r128_cce_dispatch_read_span
c_func
(paren
id|dev
comma
op_amp
id|depth
)paren
suffix:semicolon
r_case
id|R128_READ_PIXELS
suffix:colon
r_return
id|r128_cce_dispatch_read_pixels
c_func
(paren
id|dev
comma
op_amp
id|depth
)paren
suffix:semicolon
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|r128_cce_stipple
r_int
id|r128_cce_stipple
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
id|drm_file_t
op_star
id|priv
op_assign
id|filp-&gt;private_data
suffix:semicolon
id|drm_device_t
op_star
id|dev
op_assign
id|priv-&gt;dev
suffix:semicolon
id|drm_r128_stipple_t
id|stipple
suffix:semicolon
id|u32
id|mask
(braket
l_int|32
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|_DRM_LOCK_IS_HELD
c_func
(paren
id|dev-&gt;lock.hw_lock-&gt;lock
)paren
op_logical_or
id|dev-&gt;lock.pid
op_ne
id|current-&gt;pid
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;%s called without lock held&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|stipple
comma
(paren
id|drm_r128_stipple_t
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|stipple
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|mask
comma
id|stipple.mask
comma
l_int|32
op_star
r_sizeof
(paren
id|u32
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|r128_cce_dispatch_stipple
c_func
(paren
id|dev
comma
id|mask
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
eof
