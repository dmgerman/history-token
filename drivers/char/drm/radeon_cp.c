multiline_comment|/* radeon_cp.c -- CP support for Radeon -*- linux-c -*-&n; *&n; * Copyright 2000 Precision Insight, Inc., Cedar Park, Texas.&n; * Copyright 2000 VA Linux Systems, Inc., Fremont, California.&n; * All Rights Reserved.&n; *&n; * Permission is hereby granted, free of charge, to any person obtaining a&n; * copy of this software and associated documentation files (the &quot;Software&quot;),&n; * to deal in the Software without restriction, including without limitation&n; * the rights to use, copy, modify, merge, publish, distribute, sublicense,&n; * and/or sell copies of the Software, and to permit persons to whom the&n; * Software is furnished to do so, subject to the following conditions:&n; *&n; * The above copyright notice and this permission notice (including the next&n; * paragraph) shall be included in all copies or substantial portions of the&n; * Software.&n; *&n; * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR&n; * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,&n; * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL&n; * PRECISION INSIGHT AND/OR ITS SUPPLIERS BE LIABLE FOR ANY CLAIM, DAMAGES OR&n; * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,&n; * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER&n; * DEALINGS IN THE SOFTWARE.&n; *&n; * Authors:&n; *    Kevin E. Martin &lt;martin@valinux.com&gt;&n; *    Gareth Hughes &lt;gareth@valinux.com&gt;&n; */
DECL|macro|__NO_VERSION__
mdefine_line|#define __NO_VERSION__
macro_line|#include &quot;radeon.h&quot;
macro_line|#include &quot;drmP.h&quot;
macro_line|#include &quot;radeon_drv.h&quot;
macro_line|#include &lt;linux/interrupt.h&gt;&t;/* For task queue support */
macro_line|#include &lt;linux/delay.h&gt;
DECL|macro|RADEON_FIFO_DEBUG
mdefine_line|#define RADEON_FIFO_DEBUG&t;0
macro_line|#if defined(__alpha__)
DECL|macro|PCIGART_ENABLED
macro_line|# define PCIGART_ENABLED
macro_line|#else
DECL|macro|PCIGART_ENABLED
macro_line|# undef PCIGART_ENABLED
macro_line|#endif
multiline_comment|/* CP microcode (from ATI) */
DECL|variable|radeon_cp_microcode
r_static
id|u32
id|radeon_cp_microcode
(braket
)braket
(braket
l_int|2
)braket
op_assign
(brace
(brace
l_int|0x21007000
comma
l_int|0000000000
)brace
comma
(brace
l_int|0x20007000
comma
l_int|0000000000
)brace
comma
(brace
l_int|0x000000b4
comma
l_int|0x00000004
)brace
comma
(brace
l_int|0x000000b8
comma
l_int|0x00000004
)brace
comma
(brace
l_int|0x6f5b4d4c
comma
l_int|0000000000
)brace
comma
(brace
l_int|0x4c4c427f
comma
l_int|0000000000
)brace
comma
(brace
l_int|0x5b568a92
comma
l_int|0000000000
)brace
comma
(brace
l_int|0x4ca09c6d
comma
l_int|0000000000
)brace
comma
(brace
l_int|0xad4c4c4c
comma
l_int|0000000000
)brace
comma
(brace
l_int|0x4ce1af3d
comma
l_int|0000000000
)brace
comma
(brace
l_int|0xd8afafaf
comma
l_int|0000000000
)brace
comma
(brace
l_int|0xd64c4cdc
comma
l_int|0000000000
)brace
comma
(brace
l_int|0x4cd10d10
comma
l_int|0000000000
)brace
comma
(brace
l_int|0x000f0000
comma
l_int|0x00000016
)brace
comma
(brace
l_int|0x362f242d
comma
l_int|0000000000
)brace
comma
(brace
l_int|0x00000012
comma
l_int|0x00000004
)brace
comma
(brace
l_int|0x000f0000
comma
l_int|0x00000016
)brace
comma
(brace
l_int|0x362f282d
comma
l_int|0000000000
)brace
comma
(brace
l_int|0x000380e7
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x04002c97
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x000f0001
comma
l_int|0x00000016
)brace
comma
(brace
l_int|0x333a3730
comma
l_int|0000000000
)brace
comma
(brace
l_int|0x000077ef
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x00061000
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x00000021
comma
l_int|0x0000001a
)brace
comma
(brace
l_int|0x00004000
comma
l_int|0x0000001e
)brace
comma
(brace
l_int|0x00061000
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x00000021
comma
l_int|0x0000001a
)brace
comma
(brace
l_int|0x00004000
comma
l_int|0x0000001e
)brace
comma
(brace
l_int|0x00061000
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x00000021
comma
l_int|0x0000001a
)brace
comma
(brace
l_int|0x00004000
comma
l_int|0x0000001e
)brace
comma
(brace
l_int|0x00000017
comma
l_int|0x00000004
)brace
comma
(brace
l_int|0x0003802b
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x040067e0
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x00000017
comma
l_int|0x00000004
)brace
comma
(brace
l_int|0x000077e0
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x00065000
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x000037e1
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x040067e1
comma
l_int|0x00000006
)brace
comma
(brace
l_int|0x000077e0
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x000077e1
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x000077e1
comma
l_int|0x00000006
)brace
comma
(brace
l_int|0xffffffff
comma
l_int|0000000000
)brace
comma
(brace
l_int|0x10000000
comma
l_int|0000000000
)brace
comma
(brace
l_int|0x0003802b
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x040067e0
comma
l_int|0x00000006
)brace
comma
(brace
l_int|0x00007675
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x00007676
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x00007677
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x00007678
comma
l_int|0x00000006
)brace
comma
(brace
l_int|0x0003802c
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x04002676
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x00007677
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x00007678
comma
l_int|0x00000006
)brace
comma
(brace
l_int|0x0000002f
comma
l_int|0x00000018
)brace
comma
(brace
l_int|0x0000002f
comma
l_int|0x00000018
)brace
comma
(brace
l_int|0000000000
comma
l_int|0x00000006
)brace
comma
(brace
l_int|0x00000030
comma
l_int|0x00000018
)brace
comma
(brace
l_int|0x00000030
comma
l_int|0x00000018
)brace
comma
(brace
l_int|0000000000
comma
l_int|0x00000006
)brace
comma
(brace
l_int|0x01605000
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x00065000
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x00098000
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x00061000
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x64c0603e
comma
l_int|0x00000004
)brace
comma
(brace
l_int|0x000380e6
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x040025c5
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x00080000
comma
l_int|0x00000016
)brace
comma
(brace
l_int|0000000000
comma
l_int|0000000000
)brace
comma
(brace
l_int|0x0400251d
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x00007580
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x00067581
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x04002580
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x00067581
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x00000049
comma
l_int|0x00000004
)brace
comma
(brace
l_int|0x00005000
comma
l_int|0000000000
)brace
comma
(brace
l_int|0x000380e6
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x040025c5
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x00061000
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x0000750e
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x00019000
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x00011055
comma
l_int|0x00000014
)brace
comma
(brace
l_int|0x00000055
comma
l_int|0x00000012
)brace
comma
(brace
l_int|0x0400250f
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x0000504f
comma
l_int|0x00000004
)brace
comma
(brace
l_int|0x000380e6
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x040025c5
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x00007565
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x00007566
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x00000058
comma
l_int|0x00000004
)brace
comma
(brace
l_int|0x000380e6
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x040025c5
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x01e655b4
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x4401b0e4
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x01c110e4
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x26667066
comma
l_int|0x00000018
)brace
comma
(brace
l_int|0x040c2565
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x00000066
comma
l_int|0x00000018
)brace
comma
(brace
l_int|0x04002564
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x00007566
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x0000005d
comma
l_int|0x00000004
)brace
comma
(brace
l_int|0x00401069
comma
l_int|0x00000008
)brace
comma
(brace
l_int|0x00101000
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x000d80ff
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x0080006c
comma
l_int|0x00000008
)brace
comma
(brace
l_int|0x000f9000
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x000e00ff
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0000000000
comma
l_int|0x00000006
)brace
comma
(brace
l_int|0x0000008f
comma
l_int|0x00000018
)brace
comma
(brace
l_int|0x0000005b
comma
l_int|0x00000004
)brace
comma
(brace
l_int|0x000380e6
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x040025c5
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x00007576
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x00065000
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x00009000
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x00041000
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x0c00350e
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x00049000
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x00051000
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x01e785f8
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x00200000
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x0060007e
comma
l_int|0x0000000c
)brace
comma
(brace
l_int|0x00007563
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x006075f0
comma
l_int|0x00000021
)brace
comma
(brace
l_int|0x20007073
comma
l_int|0x00000004
)brace
comma
(brace
l_int|0x00005073
comma
l_int|0x00000004
)brace
comma
(brace
l_int|0x000380e6
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x040025c5
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x00007576
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x00007577
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x0000750e
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x0000750f
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x00a05000
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x00600083
comma
l_int|0x0000000c
)brace
comma
(brace
l_int|0x006075f0
comma
l_int|0x00000021
)brace
comma
(brace
l_int|0x000075f8
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x00000083
comma
l_int|0x00000004
)brace
comma
(brace
l_int|0x000a750e
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x000380e6
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x040025c5
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x0020750f
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x00600086
comma
l_int|0x00000004
)brace
comma
(brace
l_int|0x00007570
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x00007571
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x00007572
comma
l_int|0x00000006
)brace
comma
(brace
l_int|0x000380e6
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x040025c5
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x00005000
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x00a05000
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x00007568
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x00061000
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x00000095
comma
l_int|0x0000000c
)brace
comma
(brace
l_int|0x00058000
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x0c607562
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x00000097
comma
l_int|0x00000004
)brace
comma
(brace
l_int|0x000380e6
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x040025c5
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x00600096
comma
l_int|0x00000004
)brace
comma
(brace
l_int|0x400070e5
comma
l_int|0000000000
)brace
comma
(brace
l_int|0x000380e6
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x040025c5
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x000380e5
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x000000a8
comma
l_int|0x0000001c
)brace
comma
(brace
l_int|0x000650aa
comma
l_int|0x00000018
)brace
comma
(brace
l_int|0x040025bb
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x000610ab
comma
l_int|0x00000018
)brace
comma
(brace
l_int|0x040075bc
comma
l_int|0000000000
)brace
comma
(brace
l_int|0x000075bb
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x000075bc
comma
l_int|0000000000
)brace
comma
(brace
l_int|0x00090000
comma
l_int|0x00000006
)brace
comma
(brace
l_int|0x00090000
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x000d8002
comma
l_int|0x00000006
)brace
comma
(brace
l_int|0x00007832
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x00005000
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x000380e7
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x04002c97
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x00007820
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x00007821
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x00007800
comma
l_int|0000000000
)brace
comma
(brace
l_int|0x01200000
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x20077000
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x01200000
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x20007000
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x00061000
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x0120751b
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x8040750a
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x8040750b
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x00110000
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x000380e5
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x000000c6
comma
l_int|0x0000001c
)brace
comma
(brace
l_int|0x000610ab
comma
l_int|0x00000018
)brace
comma
(brace
l_int|0x844075bd
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x000610aa
comma
l_int|0x00000018
)brace
comma
(brace
l_int|0x840075bb
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x000610ab
comma
l_int|0x00000018
)brace
comma
(brace
l_int|0x844075bc
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x000000c9
comma
l_int|0x00000004
)brace
comma
(brace
l_int|0x804075bd
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x800075bb
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x804075bc
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x00108000
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x01400000
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x006000cd
comma
l_int|0x0000000c
)brace
comma
(brace
l_int|0x20c07000
comma
l_int|0x00000020
)brace
comma
(brace
l_int|0x000000cf
comma
l_int|0x00000012
)brace
comma
(brace
l_int|0x00800000
comma
l_int|0x00000006
)brace
comma
(brace
l_int|0x0080751d
comma
l_int|0x00000006
)brace
comma
(brace
l_int|0000000000
comma
l_int|0000000000
)brace
comma
(brace
l_int|0x0000775c
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x00a05000
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x00661000
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x0460275d
comma
l_int|0x00000020
)brace
comma
(brace
l_int|0x00004000
comma
l_int|0000000000
)brace
comma
(brace
l_int|0x01e00830
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x21007000
comma
l_int|0000000000
)brace
comma
(brace
l_int|0x6464614d
comma
l_int|0000000000
)brace
comma
(brace
l_int|0x69687420
comma
l_int|0000000000
)brace
comma
(brace
l_int|0x00000073
comma
l_int|0000000000
)brace
comma
(brace
l_int|0000000000
comma
l_int|0000000000
)brace
comma
(brace
l_int|0x00005000
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x000380d0
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x040025e0
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x000075e1
comma
l_int|0000000000
)brace
comma
(brace
l_int|0x00000001
comma
l_int|0000000000
)brace
comma
(brace
l_int|0x000380e0
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x04002394
comma
l_int|0x00000002
)brace
comma
(brace
l_int|0x00005000
comma
l_int|0000000000
)brace
comma
(brace
l_int|0000000000
comma
l_int|0000000000
)brace
comma
(brace
l_int|0000000000
comma
l_int|0000000000
)brace
comma
(brace
l_int|0x00000008
comma
l_int|0000000000
)brace
comma
(brace
l_int|0x00000004
comma
l_int|0000000000
)brace
comma
(brace
l_int|0000000000
comma
l_int|0000000000
)brace
comma
(brace
l_int|0000000000
comma
l_int|0000000000
)brace
comma
(brace
l_int|0000000000
comma
l_int|0000000000
)brace
comma
(brace
l_int|0000000000
comma
l_int|0000000000
)brace
comma
(brace
l_int|0000000000
comma
l_int|0000000000
)brace
comma
(brace
l_int|0000000000
comma
l_int|0000000000
)brace
comma
(brace
l_int|0000000000
comma
l_int|0000000000
)brace
comma
(brace
l_int|0000000000
comma
l_int|0000000000
)brace
comma
(brace
l_int|0000000000
comma
l_int|0000000000
)brace
comma
(brace
l_int|0000000000
comma
l_int|0000000000
)brace
comma
(brace
l_int|0000000000
comma
l_int|0000000000
)brace
comma
(brace
l_int|0000000000
comma
l_int|0000000000
)brace
comma
(brace
l_int|0000000000
comma
l_int|0000000000
)brace
comma
(brace
l_int|0000000000
comma
l_int|0000000000
)brace
comma
(brace
l_int|0000000000
comma
l_int|0000000000
)brace
comma
(brace
l_int|0000000000
comma
l_int|0000000000
)brace
comma
(brace
l_int|0000000000
comma
l_int|0000000000
)brace
comma
(brace
l_int|0000000000
comma
l_int|0000000000
)brace
comma
(brace
l_int|0000000000
comma
l_int|0000000000
)brace
comma
(brace
l_int|0000000000
comma
l_int|0000000000
)brace
comma
(brace
l_int|0000000000
comma
l_int|0000000000
)brace
comma
(brace
l_int|0000000000
comma
l_int|0000000000
)brace
comma
(brace
l_int|0000000000
comma
l_int|0000000000
)brace
comma
(brace
l_int|0000000000
comma
l_int|0000000000
)brace
comma
)brace
suffix:semicolon
DECL|function|RADEON_READ_PLL
r_int
id|RADEON_READ_PLL
c_func
(paren
id|drm_device_t
op_star
id|dev
comma
r_int
id|addr
)paren
(brace
id|drm_radeon_private_t
op_star
id|dev_priv
op_assign
id|dev-&gt;dev_private
suffix:semicolon
id|RADEON_WRITE8
c_func
(paren
id|RADEON_CLOCK_CNTL_INDEX
comma
id|addr
op_amp
l_int|0x1f
)paren
suffix:semicolon
r_return
id|RADEON_READ
c_func
(paren
id|RADEON_CLOCK_CNTL_DATA
)paren
suffix:semicolon
)brace
macro_line|#if RADEON_FIFO_DEBUG
DECL|function|radeon_status
r_static
r_void
id|radeon_status
c_func
(paren
id|drm_radeon_private_t
op_star
id|dev_priv
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s:&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;RBBM_STATUS = 0x%08x&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|RADEON_READ
c_func
(paren
id|RADEON_RBBM_STATUS
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;CP_RB_RTPR = 0x%08x&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|RADEON_READ
c_func
(paren
id|RADEON_CP_RB_RPTR
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;CP_RB_WTPR = 0x%08x&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|RADEON_READ
c_func
(paren
id|RADEON_CP_RB_WPTR
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;AIC_CNTL = 0x%08x&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|RADEON_READ
c_func
(paren
id|RADEON_AIC_CNTL
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;AIC_STAT = 0x%08x&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|RADEON_READ
c_func
(paren
id|RADEON_AIC_STAT
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;AIC_PT_BASE = 0x%08x&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|RADEON_READ
c_func
(paren
id|RADEON_AIC_PT_BASE
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;TLB_ADDR = 0x%08x&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|RADEON_READ
c_func
(paren
id|RADEON_AIC_TLB_ADDR
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;TLB_DATA = 0x%08x&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|RADEON_READ
c_func
(paren
id|RADEON_AIC_TLB_DATA
)paren
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* ================================================================&n; * Engine, FIFO control&n; */
DECL|function|radeon_do_pixcache_flush
r_static
r_int
id|radeon_do_pixcache_flush
c_func
(paren
id|drm_radeon_private_t
op_star
id|dev_priv
)paren
(brace
id|u32
id|tmp
suffix:semicolon
r_int
id|i
suffix:semicolon
id|tmp
op_assign
id|RADEON_READ
c_func
(paren
id|RADEON_RB2D_DSTCACHE_CTLSTAT
)paren
suffix:semicolon
id|tmp
op_or_assign
id|RADEON_RB2D_DC_FLUSH_ALL
suffix:semicolon
id|RADEON_WRITE
c_func
(paren
id|RADEON_RB2D_DSTCACHE_CTLSTAT
comma
id|tmp
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dev_priv-&gt;usec_timeout
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|RADEON_READ
c_func
(paren
id|RADEON_RB2D_DSTCACHE_CTLSTAT
)paren
op_amp
id|RADEON_RB2D_DC_BUSY
)paren
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
macro_line|#if RADEON_FIFO_DEBUG
id|DRM_ERROR
c_func
(paren
l_string|&quot;failed!&bslash;n&quot;
)paren
suffix:semicolon
id|radeon_status
c_func
(paren
id|dev_priv
)paren
suffix:semicolon
macro_line|#endif
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
DECL|function|radeon_do_wait_for_fifo
r_static
r_int
id|radeon_do_wait_for_fifo
c_func
(paren
id|drm_radeon_private_t
op_star
id|dev_priv
comma
r_int
id|entries
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dev_priv-&gt;usec_timeout
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
id|slots
op_assign
(paren
id|RADEON_READ
c_func
(paren
id|RADEON_RBBM_STATUS
)paren
op_amp
id|RADEON_RBBM_FIFOCNT_MASK
)paren
suffix:semicolon
r_if
c_cond
(paren
id|slots
op_ge
id|entries
)paren
r_return
l_int|0
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
macro_line|#if RADEON_FIFO_DEBUG
id|DRM_ERROR
c_func
(paren
l_string|&quot;failed!&bslash;n&quot;
)paren
suffix:semicolon
id|radeon_status
c_func
(paren
id|dev_priv
)paren
suffix:semicolon
macro_line|#endif
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
DECL|function|radeon_do_wait_for_idle
r_static
r_int
id|radeon_do_wait_for_idle
c_func
(paren
id|drm_radeon_private_t
op_star
id|dev_priv
)paren
(brace
r_int
id|i
comma
id|ret
suffix:semicolon
id|ret
op_assign
id|radeon_do_wait_for_fifo
c_func
(paren
id|dev_priv
comma
l_int|64
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
r_return
id|ret
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dev_priv-&gt;usec_timeout
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|RADEON_READ
c_func
(paren
id|RADEON_RBBM_STATUS
)paren
op_amp
id|RADEON_RBBM_ACTIVE
)paren
)paren
(brace
id|radeon_do_pixcache_flush
c_func
(paren
id|dev_priv
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
macro_line|#if RADEON_FIFO_DEBUG
id|DRM_ERROR
c_func
(paren
l_string|&quot;failed!&bslash;n&quot;
)paren
suffix:semicolon
id|radeon_status
c_func
(paren
id|dev_priv
)paren
suffix:semicolon
macro_line|#endif
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
multiline_comment|/* ================================================================&n; * CP control, initialization&n; */
multiline_comment|/* Load the microcode for the CP */
DECL|function|radeon_cp_load_microcode
r_static
r_void
id|radeon_cp_load_microcode
c_func
(paren
id|drm_radeon_private_t
op_star
id|dev_priv
)paren
(brace
r_int
id|i
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|radeon_do_wait_for_idle
c_func
(paren
id|dev_priv
)paren
suffix:semicolon
id|RADEON_WRITE
c_func
(paren
id|RADEON_CP_ME_RAM_ADDR
comma
l_int|0
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|256
suffix:semicolon
id|i
op_increment
)paren
(brace
id|RADEON_WRITE
c_func
(paren
id|RADEON_CP_ME_RAM_DATAH
comma
id|radeon_cp_microcode
(braket
id|i
)braket
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|RADEON_WRITE
c_func
(paren
id|RADEON_CP_ME_RAM_DATAL
comma
id|radeon_cp_microcode
(braket
id|i
)braket
(braket
l_int|0
)braket
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Flush any pending commands to the CP.  This should only be used just&n; * prior to a wait for idle, as it informs the engine that the command&n; * stream is ending.&n; */
DECL|function|radeon_do_cp_flush
r_static
r_void
id|radeon_do_cp_flush
c_func
(paren
id|drm_radeon_private_t
op_star
id|dev_priv
)paren
(brace
id|DRM_DEBUG
c_func
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
macro_line|#if 0
id|u32
id|tmp
suffix:semicolon
id|tmp
op_assign
id|RADEON_READ
c_func
(paren
id|RADEON_CP_RB_WPTR
)paren
op_or
(paren
l_int|1
op_lshift
l_int|31
)paren
suffix:semicolon
id|RADEON_WRITE
c_func
(paren
id|RADEON_CP_RB_WPTR
comma
id|tmp
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/* Wait for the CP to go idle.&n; */
DECL|function|radeon_do_cp_idle
r_int
id|radeon_do_cp_idle
c_func
(paren
id|drm_radeon_private_t
op_star
id|dev_priv
)paren
(brace
id|RING_LOCALS
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|BEGIN_RING
c_func
(paren
l_int|6
)paren
suffix:semicolon
id|RADEON_PURGE_CACHE
c_func
(paren
)paren
suffix:semicolon
id|RADEON_PURGE_ZCACHE
c_func
(paren
)paren
suffix:semicolon
id|RADEON_WAIT_UNTIL_IDLE
c_func
(paren
)paren
suffix:semicolon
id|ADVANCE_RING
c_func
(paren
)paren
suffix:semicolon
r_return
id|radeon_do_wait_for_idle
c_func
(paren
id|dev_priv
)paren
suffix:semicolon
)brace
multiline_comment|/* Start the Command Processor.&n; */
DECL|function|radeon_do_cp_start
r_static
r_void
id|radeon_do_cp_start
c_func
(paren
id|drm_radeon_private_t
op_star
id|dev_priv
)paren
(brace
id|RING_LOCALS
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|radeon_do_wait_for_idle
c_func
(paren
id|dev_priv
)paren
suffix:semicolon
id|RADEON_WRITE
c_func
(paren
id|RADEON_CP_CSQ_CNTL
comma
id|dev_priv-&gt;cp_mode
)paren
suffix:semicolon
id|dev_priv-&gt;cp_running
op_assign
l_int|1
suffix:semicolon
id|BEGIN_RING
c_func
(paren
l_int|6
)paren
suffix:semicolon
id|RADEON_PURGE_CACHE
c_func
(paren
)paren
suffix:semicolon
id|RADEON_PURGE_ZCACHE
c_func
(paren
)paren
suffix:semicolon
id|RADEON_WAIT_UNTIL_IDLE
c_func
(paren
)paren
suffix:semicolon
id|ADVANCE_RING
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Reset the Command Processor.  This will not flush any pending&n; * commands, so you must wait for the CP command stream to complete&n; * before calling this routine.&n; */
DECL|function|radeon_do_cp_reset
r_static
r_void
id|radeon_do_cp_reset
c_func
(paren
id|drm_radeon_private_t
op_star
id|dev_priv
)paren
(brace
id|u32
id|cur_read_ptr
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|cur_read_ptr
op_assign
id|RADEON_READ
c_func
(paren
id|RADEON_CP_RB_RPTR
)paren
suffix:semicolon
id|RADEON_WRITE
c_func
(paren
id|RADEON_CP_RB_WPTR
comma
id|cur_read_ptr
)paren
suffix:semicolon
op_star
id|dev_priv-&gt;ring.head
op_assign
id|cur_read_ptr
suffix:semicolon
id|dev_priv-&gt;ring.tail
op_assign
id|cur_read_ptr
suffix:semicolon
)brace
multiline_comment|/* Stop the Command Processor.  This will not flush any pending&n; * commands, so you must flush the command stream and wait for the CP&n; * to go idle before calling this routine.&n; */
DECL|function|radeon_do_cp_stop
r_static
r_void
id|radeon_do_cp_stop
c_func
(paren
id|drm_radeon_private_t
op_star
id|dev_priv
)paren
(brace
id|DRM_DEBUG
c_func
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|RADEON_WRITE
c_func
(paren
id|RADEON_CP_CSQ_CNTL
comma
id|RADEON_CSQ_PRIDIS_INDDIS
)paren
suffix:semicolon
id|dev_priv-&gt;cp_running
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Reset the engine.  This will stop the CP if it is running.&n; */
DECL|function|radeon_do_engine_reset
r_static
r_int
id|radeon_do_engine_reset
c_func
(paren
id|drm_device_t
op_star
id|dev
)paren
(brace
id|drm_radeon_private_t
op_star
id|dev_priv
op_assign
id|dev-&gt;dev_private
suffix:semicolon
id|u32
id|clock_cntl_index
comma
id|mclk_cntl
comma
id|rbbm_soft_reset
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|radeon_do_pixcache_flush
c_func
(paren
id|dev_priv
)paren
suffix:semicolon
id|clock_cntl_index
op_assign
id|RADEON_READ
c_func
(paren
id|RADEON_CLOCK_CNTL_INDEX
)paren
suffix:semicolon
id|mclk_cntl
op_assign
id|RADEON_READ_PLL
c_func
(paren
id|dev
comma
id|RADEON_MCLK_CNTL
)paren
suffix:semicolon
id|RADEON_WRITE_PLL
c_func
(paren
id|RADEON_MCLK_CNTL
comma
(paren
id|mclk_cntl
op_or
id|RADEON_FORCEON_MCLKA
op_or
id|RADEON_FORCEON_MCLKB
op_or
id|RADEON_FORCEON_YCLKA
op_or
id|RADEON_FORCEON_YCLKB
op_or
id|RADEON_FORCEON_MC
op_or
id|RADEON_FORCEON_AIC
)paren
)paren
suffix:semicolon
id|rbbm_soft_reset
op_assign
id|RADEON_READ
c_func
(paren
id|RADEON_RBBM_SOFT_RESET
)paren
suffix:semicolon
id|RADEON_WRITE
c_func
(paren
id|RADEON_RBBM_SOFT_RESET
comma
(paren
id|rbbm_soft_reset
op_or
id|RADEON_SOFT_RESET_CP
op_or
id|RADEON_SOFT_RESET_HI
op_or
id|RADEON_SOFT_RESET_SE
op_or
id|RADEON_SOFT_RESET_RE
op_or
id|RADEON_SOFT_RESET_PP
op_or
id|RADEON_SOFT_RESET_E2
op_or
id|RADEON_SOFT_RESET_RB
op_or
id|RADEON_SOFT_RESET_HDP
)paren
)paren
suffix:semicolon
id|RADEON_READ
c_func
(paren
id|RADEON_RBBM_SOFT_RESET
)paren
suffix:semicolon
id|RADEON_WRITE
c_func
(paren
id|RADEON_RBBM_SOFT_RESET
comma
(paren
id|rbbm_soft_reset
op_amp
op_complement
(paren
id|RADEON_SOFT_RESET_CP
op_or
id|RADEON_SOFT_RESET_HI
op_or
id|RADEON_SOFT_RESET_SE
op_or
id|RADEON_SOFT_RESET_RE
op_or
id|RADEON_SOFT_RESET_PP
op_or
id|RADEON_SOFT_RESET_E2
op_or
id|RADEON_SOFT_RESET_RB
op_or
id|RADEON_SOFT_RESET_HDP
)paren
)paren
)paren
suffix:semicolon
id|RADEON_READ
c_func
(paren
id|RADEON_RBBM_SOFT_RESET
)paren
suffix:semicolon
id|RADEON_WRITE_PLL
c_func
(paren
id|RADEON_MCLK_CNTL
comma
id|mclk_cntl
)paren
suffix:semicolon
id|RADEON_WRITE
c_func
(paren
id|RADEON_CLOCK_CNTL_INDEX
comma
id|clock_cntl_index
)paren
suffix:semicolon
id|RADEON_WRITE
c_func
(paren
id|RADEON_RBBM_SOFT_RESET
comma
id|rbbm_soft_reset
)paren
suffix:semicolon
multiline_comment|/* Reset the CP ring */
id|radeon_do_cp_reset
c_func
(paren
id|dev_priv
)paren
suffix:semicolon
multiline_comment|/* The CP is no longer running after an engine reset */
id|dev_priv-&gt;cp_running
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Reset any pending vertex, indirect buffers */
id|radeon_freelist_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|radeon_cp_init_ring_buffer
r_static
r_void
id|radeon_cp_init_ring_buffer
c_func
(paren
id|drm_device_t
op_star
id|dev
comma
id|drm_radeon_private_t
op_star
id|dev_priv
)paren
(brace
id|u32
id|ring_start
comma
id|cur_read_ptr
suffix:semicolon
id|u32
id|tmp
suffix:semicolon
multiline_comment|/* Initialize the memory controller */
id|RADEON_WRITE
c_func
(paren
id|RADEON_MC_FB_LOCATION
comma
(paren
id|dev_priv-&gt;agp_vm_start
op_minus
l_int|1
)paren
op_amp
l_int|0xffff0000
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev_priv-&gt;is_pci
)paren
(brace
id|RADEON_WRITE
c_func
(paren
id|RADEON_MC_AGP_LOCATION
comma
(paren
(paren
(paren
id|dev_priv-&gt;agp_vm_start
op_minus
l_int|1
op_plus
id|dev_priv-&gt;agp_size
)paren
op_amp
l_int|0xffff0000
)paren
op_or
(paren
id|dev_priv-&gt;agp_vm_start
op_rshift
l_int|16
)paren
)paren
)paren
suffix:semicolon
)brace
macro_line|#if __REALLY_HAVE_AGP
r_if
c_cond
(paren
op_logical_neg
id|dev_priv-&gt;is_pci
)paren
id|ring_start
op_assign
(paren
id|dev_priv-&gt;cp_ring-&gt;offset
op_minus
id|dev-&gt;agp-&gt;base
op_plus
id|dev_priv-&gt;agp_vm_start
)paren
suffix:semicolon
r_else
macro_line|#endif
id|ring_start
op_assign
(paren
id|dev_priv-&gt;cp_ring-&gt;offset
op_minus
id|dev-&gt;sg-&gt;handle
op_plus
id|dev_priv-&gt;agp_vm_start
)paren
suffix:semicolon
id|RADEON_WRITE
c_func
(paren
id|RADEON_CP_RB_BASE
comma
id|ring_start
)paren
suffix:semicolon
multiline_comment|/* Set the write pointer delay */
id|RADEON_WRITE
c_func
(paren
id|RADEON_CP_RB_WPTR_DELAY
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Initialize the ring buffer&squot;s read and write pointers */
id|cur_read_ptr
op_assign
id|RADEON_READ
c_func
(paren
id|RADEON_CP_RB_RPTR
)paren
suffix:semicolon
id|RADEON_WRITE
c_func
(paren
id|RADEON_CP_RB_WPTR
comma
id|cur_read_ptr
)paren
suffix:semicolon
op_star
id|dev_priv-&gt;ring.head
op_assign
id|cur_read_ptr
suffix:semicolon
id|dev_priv-&gt;ring.tail
op_assign
id|cur_read_ptr
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev_priv-&gt;is_pci
)paren
(brace
id|RADEON_WRITE
c_func
(paren
id|RADEON_CP_RB_RPTR_ADDR
comma
id|dev_priv-&gt;ring_rptr-&gt;offset
)paren
suffix:semicolon
)brace
r_else
(brace
id|drm_sg_mem_t
op_star
id|entry
op_assign
id|dev-&gt;sg
suffix:semicolon
r_int
r_int
id|tmp_ofs
comma
id|page_ofs
suffix:semicolon
id|tmp_ofs
op_assign
id|dev_priv-&gt;ring_rptr-&gt;offset
op_minus
id|dev-&gt;sg-&gt;handle
suffix:semicolon
id|page_ofs
op_assign
id|tmp_ofs
op_rshift
id|PAGE_SHIFT
suffix:semicolon
id|RADEON_WRITE
c_func
(paren
id|RADEON_CP_RB_RPTR_ADDR
comma
id|virt_to_bus
c_func
(paren
id|entry-&gt;pagelist
(braket
id|page_ofs
)braket
op_member_access_from_pointer
r_virtual
)paren
)paren
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;ring rptr: offset=0x%08lx handle=0x%08lx&bslash;n&quot;
comma
id|virt_to_bus
c_func
(paren
id|entry-&gt;pagelist
(braket
id|page_ofs
)braket
op_member_access_from_pointer
r_virtual
)paren
comma
id|entry-&gt;handle
op_plus
id|tmp_ofs
)paren
suffix:semicolon
)brace
multiline_comment|/* Set ring buffer size */
id|RADEON_WRITE
c_func
(paren
id|RADEON_CP_RB_CNTL
comma
id|dev_priv-&gt;ring.size_l2qw
)paren
suffix:semicolon
id|radeon_do_wait_for_idle
c_func
(paren
id|dev_priv
)paren
suffix:semicolon
multiline_comment|/* Turn on bus mastering */
id|tmp
op_assign
id|RADEON_READ
c_func
(paren
id|RADEON_BUS_CNTL
)paren
op_amp
op_complement
id|RADEON_BUS_MASTER_DIS
suffix:semicolon
id|RADEON_WRITE
c_func
(paren
id|RADEON_BUS_CNTL
comma
id|tmp
)paren
suffix:semicolon
multiline_comment|/* Sync everything up */
id|RADEON_WRITE
c_func
(paren
id|RADEON_ISYNC_CNTL
comma
(paren
id|RADEON_ISYNC_ANY2D_IDLE3D
op_or
id|RADEON_ISYNC_ANY3D_IDLE2D
op_or
id|RADEON_ISYNC_WAIT_IDLEGUI
op_or
id|RADEON_ISYNC_CPSCRATCH_IDLEGUI
)paren
)paren
suffix:semicolon
)brace
DECL|function|radeon_do_init_cp
r_static
r_int
id|radeon_do_init_cp
c_func
(paren
id|drm_device_t
op_star
id|dev
comma
id|drm_radeon_init_t
op_star
id|init
)paren
(brace
id|drm_radeon_private_t
op_star
id|dev_priv
suffix:semicolon
r_struct
id|list_head
op_star
id|list
suffix:semicolon
id|u32
id|tmp
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|dev_priv
op_assign
id|DRM
c_func
(paren
id|alloc
)paren
(paren
r_sizeof
(paren
id|drm_radeon_private_t
)paren
comma
id|DRM_MEM_DRIVER
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev_priv
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|dev_priv
comma
l_int|0
comma
r_sizeof
(paren
id|drm_radeon_private_t
)paren
)paren
suffix:semicolon
id|dev_priv-&gt;is_pci
op_assign
id|init-&gt;is_pci
suffix:semicolon
macro_line|#if !defined(PCIGART_ENABLED)
multiline_comment|/* PCI support is not 100% working, so we disable it here.&n;&t; */
r_if
c_cond
(paren
id|dev_priv-&gt;is_pci
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;PCI GART not yet supported for Radeon!&bslash;n&quot;
)paren
suffix:semicolon
id|dev-&gt;dev_private
op_assign
(paren
r_void
op_star
)paren
id|dev_priv
suffix:semicolon
id|radeon_do_cleanup_cp
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|dev_priv-&gt;is_pci
op_logical_and
op_logical_neg
id|dev-&gt;sg
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;PCI GART memory not allocated!&bslash;n&quot;
)paren
suffix:semicolon
id|dev-&gt;dev_private
op_assign
(paren
r_void
op_star
)paren
id|dev_priv
suffix:semicolon
id|radeon_do_cleanup_cp
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|dev_priv-&gt;usec_timeout
op_assign
id|init-&gt;usec_timeout
suffix:semicolon
r_if
c_cond
(paren
id|dev_priv-&gt;usec_timeout
template_param
id|RADEON_MAX_USEC_TIMEOUT
)paren
(brace
id|DRM_DEBUG
c_func
(paren
l_string|&quot;TIMEOUT problem!&bslash;n&quot;
)paren
suffix:semicolon
id|dev-&gt;dev_private
op_assign
(paren
r_void
op_star
)paren
id|dev_priv
suffix:semicolon
id|radeon_do_cleanup_cp
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|dev_priv-&gt;cp_mode
op_assign
id|init-&gt;cp_mode
suffix:semicolon
multiline_comment|/* Simple idle check.&n;&t; */
id|atomic_set
c_func
(paren
op_amp
id|dev_priv-&gt;idle_count
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* We don&squot;t support anything other than bus-mastering ring mode,&n;&t; * but the ring can be in either AGP or PCI space for the ring&n;&t; * read pointer.&n;&t; */
r_if
c_cond
(paren
(paren
id|init-&gt;cp_mode
op_ne
id|RADEON_CSQ_PRIBM_INDDIS
)paren
op_logical_and
(paren
id|init-&gt;cp_mode
op_ne
id|RADEON_CSQ_PRIBM_INDBM
)paren
)paren
(brace
id|DRM_DEBUG
c_func
(paren
l_string|&quot;BAD cp_mode (%x)!&bslash;n&quot;
comma
id|init-&gt;cp_mode
)paren
suffix:semicolon
id|dev-&gt;dev_private
op_assign
(paren
r_void
op_star
)paren
id|dev_priv
suffix:semicolon
id|radeon_do_cleanup_cp
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|init-&gt;fb_bpp
)paren
(brace
r_case
l_int|16
suffix:colon
id|dev_priv-&gt;color_fmt
op_assign
id|RADEON_COLOR_FORMAT_RGB565
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|32
suffix:colon
r_default
suffix:colon
id|dev_priv-&gt;color_fmt
op_assign
id|RADEON_COLOR_FORMAT_ARGB8888
suffix:semicolon
r_break
suffix:semicolon
)brace
id|dev_priv-&gt;front_offset
op_assign
id|init-&gt;front_offset
suffix:semicolon
id|dev_priv-&gt;front_pitch
op_assign
id|init-&gt;front_pitch
suffix:semicolon
id|dev_priv-&gt;back_offset
op_assign
id|init-&gt;back_offset
suffix:semicolon
id|dev_priv-&gt;back_pitch
op_assign
id|init-&gt;back_pitch
suffix:semicolon
r_switch
c_cond
(paren
id|init-&gt;depth_bpp
)paren
(brace
r_case
l_int|16
suffix:colon
id|dev_priv-&gt;depth_fmt
op_assign
id|RADEON_DEPTH_FORMAT_16BIT_INT_Z
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|32
suffix:colon
r_default
suffix:colon
id|dev_priv-&gt;depth_fmt
op_assign
id|RADEON_DEPTH_FORMAT_24BIT_INT_Z
suffix:semicolon
r_break
suffix:semicolon
)brace
id|dev_priv-&gt;depth_offset
op_assign
id|init-&gt;depth_offset
suffix:semicolon
id|dev_priv-&gt;depth_pitch
op_assign
id|init-&gt;depth_pitch
suffix:semicolon
id|dev_priv-&gt;front_pitch_offset
op_assign
(paren
(paren
(paren
id|dev_priv-&gt;front_pitch
op_div
l_int|64
)paren
op_lshift
l_int|22
)paren
op_or
(paren
id|dev_priv-&gt;front_offset
op_rshift
l_int|10
)paren
)paren
suffix:semicolon
id|dev_priv-&gt;back_pitch_offset
op_assign
(paren
(paren
(paren
id|dev_priv-&gt;back_pitch
op_div
l_int|64
)paren
op_lshift
l_int|22
)paren
op_or
(paren
id|dev_priv-&gt;back_offset
op_rshift
l_int|10
)paren
)paren
suffix:semicolon
id|dev_priv-&gt;depth_pitch_offset
op_assign
(paren
(paren
(paren
id|dev_priv-&gt;depth_pitch
op_div
l_int|64
)paren
op_lshift
l_int|22
)paren
op_or
(paren
id|dev_priv-&gt;depth_offset
op_rshift
l_int|10
)paren
)paren
suffix:semicolon
multiline_comment|/* Hardware state for depth clears.  Remove this if/when we no&n;&t; * longer clear the depth buffer with a 3D rectangle.  Hard-code&n;&t; * all values to prevent unwanted 3D state from slipping through&n;&t; * and screwing with the clear operation.&n;&t; */
id|dev_priv-&gt;depth_clear.rb3d_cntl
op_assign
(paren
id|RADEON_PLANE_MASK_ENABLE
op_or
id|RADEON_Z_ENABLE
op_or
(paren
id|dev_priv-&gt;color_fmt
op_lshift
l_int|10
)paren
op_or
id|RADEON_ZBLOCK16
)paren
suffix:semicolon
id|dev_priv-&gt;depth_clear.rb3d_zstencilcntl
op_assign
(paren
id|dev_priv-&gt;depth_fmt
op_or
id|RADEON_Z_TEST_ALWAYS
op_or
id|RADEON_STENCIL_TEST_ALWAYS
op_or
id|RADEON_STENCIL_S_FAIL_KEEP
op_or
id|RADEON_STENCIL_ZPASS_KEEP
op_or
id|RADEON_STENCIL_ZFAIL_KEEP
op_or
id|RADEON_Z_WRITE_ENABLE
)paren
suffix:semicolon
id|dev_priv-&gt;depth_clear.se_cntl
op_assign
(paren
id|RADEON_FFACE_CULL_CW
op_or
id|RADEON_BFACE_SOLID
op_or
id|RADEON_FFACE_SOLID
op_or
id|RADEON_FLAT_SHADE_VTX_LAST
op_or
id|RADEON_DIFFUSE_SHADE_FLAT
op_or
id|RADEON_ALPHA_SHADE_FLAT
op_or
id|RADEON_SPECULAR_SHADE_FLAT
op_or
id|RADEON_FOG_SHADE_FLAT
op_or
id|RADEON_VTX_PIX_CENTER_OGL
op_or
id|RADEON_ROUND_MODE_TRUNC
op_or
id|RADEON_ROUND_PREC_8TH_PIX
)paren
suffix:semicolon
id|list_for_each
c_func
(paren
id|list
comma
op_amp
id|dev-&gt;maplist-&gt;head
)paren
(brace
id|drm_map_list_t
op_star
id|r_list
op_assign
(paren
id|drm_map_list_t
op_star
)paren
id|list
suffix:semicolon
r_if
c_cond
(paren
id|r_list-&gt;map
op_logical_and
id|r_list-&gt;map-&gt;type
op_eq
id|_DRM_SHM
op_logical_and
id|r_list-&gt;map-&gt;flags
op_amp
id|_DRM_CONTAINS_LOCK
)paren
(brace
id|dev_priv-&gt;sarea
op_assign
id|r_list-&gt;map
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|dev_priv-&gt;sarea
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;could not find sarea!&bslash;n&quot;
)paren
suffix:semicolon
id|dev-&gt;dev_private
op_assign
(paren
r_void
op_star
)paren
id|dev_priv
suffix:semicolon
id|radeon_do_cleanup_cp
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|DRM_FIND_MAP
c_func
(paren
id|dev_priv-&gt;fb
comma
id|init-&gt;fb_offset
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev_priv-&gt;fb
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;could not find framebuffer!&bslash;n&quot;
)paren
suffix:semicolon
id|dev-&gt;dev_private
op_assign
(paren
r_void
op_star
)paren
id|dev_priv
suffix:semicolon
id|radeon_do_cleanup_cp
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|DRM_FIND_MAP
c_func
(paren
id|dev_priv-&gt;mmio
comma
id|init-&gt;mmio_offset
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev_priv-&gt;mmio
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;could not find mmio region!&bslash;n&quot;
)paren
suffix:semicolon
id|dev-&gt;dev_private
op_assign
(paren
r_void
op_star
)paren
id|dev_priv
suffix:semicolon
id|radeon_do_cleanup_cp
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|DRM_FIND_MAP
c_func
(paren
id|dev_priv-&gt;cp_ring
comma
id|init-&gt;ring_offset
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev_priv-&gt;cp_ring
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;could not find cp ring region!&bslash;n&quot;
)paren
suffix:semicolon
id|dev-&gt;dev_private
op_assign
(paren
r_void
op_star
)paren
id|dev_priv
suffix:semicolon
id|radeon_do_cleanup_cp
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|DRM_FIND_MAP
c_func
(paren
id|dev_priv-&gt;ring_rptr
comma
id|init-&gt;ring_rptr_offset
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev_priv-&gt;ring_rptr
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;could not find ring read pointer!&bslash;n&quot;
)paren
suffix:semicolon
id|dev-&gt;dev_private
op_assign
(paren
r_void
op_star
)paren
id|dev_priv
suffix:semicolon
id|radeon_do_cleanup_cp
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|DRM_FIND_MAP
c_func
(paren
id|dev_priv-&gt;buffers
comma
id|init-&gt;buffers_offset
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev_priv-&gt;buffers
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;could not find dma buffer region!&bslash;n&quot;
)paren
suffix:semicolon
id|dev-&gt;dev_private
op_assign
(paren
r_void
op_star
)paren
id|dev_priv
suffix:semicolon
id|radeon_do_cleanup_cp
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|dev_priv-&gt;is_pci
)paren
(brace
id|DRM_FIND_MAP
c_func
(paren
id|dev_priv-&gt;agp_textures
comma
id|init-&gt;agp_textures_offset
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev_priv-&gt;agp_textures
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;could not find agp texture region!&bslash;n&quot;
)paren
suffix:semicolon
id|dev-&gt;dev_private
op_assign
(paren
r_void
op_star
)paren
id|dev_priv
suffix:semicolon
id|radeon_do_cleanup_cp
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
id|dev_priv-&gt;sarea_priv
op_assign
(paren
id|drm_radeon_sarea_t
op_star
)paren
(paren
(paren
id|u8
op_star
)paren
id|dev_priv-&gt;sarea-&gt;handle
op_plus
id|init-&gt;sarea_priv_offset
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev_priv-&gt;is_pci
)paren
(brace
id|DRM_IOREMAP
c_func
(paren
id|dev_priv-&gt;cp_ring
)paren
suffix:semicolon
id|DRM_IOREMAP
c_func
(paren
id|dev_priv-&gt;ring_rptr
)paren
suffix:semicolon
id|DRM_IOREMAP
c_func
(paren
id|dev_priv-&gt;buffers
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev_priv-&gt;cp_ring-&gt;handle
op_logical_or
op_logical_neg
id|dev_priv-&gt;ring_rptr-&gt;handle
op_logical_or
op_logical_neg
id|dev_priv-&gt;buffers-&gt;handle
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;could not find ioremap agp regions!&bslash;n&quot;
)paren
suffix:semicolon
id|dev-&gt;dev_private
op_assign
(paren
r_void
op_star
)paren
id|dev_priv
suffix:semicolon
id|radeon_do_cleanup_cp
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
r_else
(brace
id|dev_priv-&gt;cp_ring-&gt;handle
op_assign
(paren
r_void
op_star
)paren
id|dev_priv-&gt;cp_ring-&gt;offset
suffix:semicolon
id|dev_priv-&gt;ring_rptr-&gt;handle
op_assign
(paren
r_void
op_star
)paren
id|dev_priv-&gt;ring_rptr-&gt;offset
suffix:semicolon
id|dev_priv-&gt;buffers-&gt;handle
op_assign
(paren
r_void
op_star
)paren
id|dev_priv-&gt;buffers-&gt;offset
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;dev_priv-&gt;cp_ring-&gt;handle %p&bslash;n&quot;
comma
id|dev_priv-&gt;cp_ring-&gt;handle
)paren
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;dev_priv-&gt;ring_rptr-&gt;handle %p&bslash;n&quot;
comma
id|dev_priv-&gt;ring_rptr-&gt;handle
)paren
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;dev_priv-&gt;buffers-&gt;handle %p&bslash;n&quot;
comma
id|dev_priv-&gt;buffers-&gt;handle
)paren
suffix:semicolon
)brace
id|dev_priv-&gt;agp_size
op_assign
id|init-&gt;agp_size
suffix:semicolon
id|dev_priv-&gt;agp_vm_start
op_assign
id|RADEON_READ
c_func
(paren
id|RADEON_CONFIG_APER_SIZE
)paren
suffix:semicolon
macro_line|#if __REALLY_HAVE_AGP
r_if
c_cond
(paren
op_logical_neg
id|dev_priv-&gt;is_pci
)paren
id|dev_priv-&gt;agp_buffers_offset
op_assign
(paren
id|dev_priv-&gt;buffers-&gt;offset
op_minus
id|dev-&gt;agp-&gt;base
op_plus
id|dev_priv-&gt;agp_vm_start
)paren
suffix:semicolon
r_else
macro_line|#endif
id|dev_priv-&gt;agp_buffers_offset
op_assign
(paren
id|dev_priv-&gt;buffers-&gt;offset
op_minus
id|dev-&gt;sg-&gt;handle
op_plus
id|dev_priv-&gt;agp_vm_start
)paren
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;dev_priv-&gt;agp_size %d&bslash;n&quot;
comma
id|dev_priv-&gt;agp_size
)paren
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;dev_priv-&gt;agp_vm_start 0x%x&bslash;n&quot;
comma
id|dev_priv-&gt;agp_vm_start
)paren
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;dev_priv-&gt;agp_buffers_offset 0x%lx&bslash;n&quot;
comma
id|dev_priv-&gt;agp_buffers_offset
)paren
suffix:semicolon
id|dev_priv-&gt;ring.head
op_assign
(paren
(paren
id|__volatile__
id|u32
op_star
)paren
id|dev_priv-&gt;ring_rptr-&gt;handle
)paren
suffix:semicolon
id|dev_priv-&gt;ring.start
op_assign
(paren
id|u32
op_star
)paren
id|dev_priv-&gt;cp_ring-&gt;handle
suffix:semicolon
id|dev_priv-&gt;ring.end
op_assign
(paren
(paren
id|u32
op_star
)paren
id|dev_priv-&gt;cp_ring-&gt;handle
op_plus
id|init-&gt;ring_size
op_div
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
id|dev_priv-&gt;ring.size
op_assign
id|init-&gt;ring_size
suffix:semicolon
id|dev_priv-&gt;ring.size_l2qw
op_assign
id|DRM
c_func
(paren
id|order
)paren
(paren
id|init-&gt;ring_size
op_div
l_int|8
)paren
suffix:semicolon
id|dev_priv-&gt;ring.tail_mask
op_assign
(paren
id|dev_priv-&gt;ring.size
op_div
r_sizeof
(paren
id|u32
)paren
)paren
op_minus
l_int|1
suffix:semicolon
id|dev_priv-&gt;ring.high_mark
op_assign
id|RADEON_RING_HIGH_MARK
suffix:semicolon
macro_line|#if 0
multiline_comment|/* Initialize the scratch register pointer.  This will cause&n;&t; * the scratch register values to be written out to memory&n;&t; * whenever they are updated.&n;&t; * FIXME: This doesn&squot;t quite work yet, so we&squot;re disabling it&n;&t; * for the release.&n;&t; */
id|RADEON_WRITE
c_func
(paren
id|RADEON_SCRATCH_ADDR
comma
(paren
id|dev_priv-&gt;ring_rptr-&gt;offset
op_plus
id|RADEON_SCRATCH_REG_OFFSET
)paren
)paren
suffix:semicolon
id|RADEON_WRITE
c_func
(paren
id|RADEON_SCRATCH_UMSK
comma
l_int|0x7
)paren
suffix:semicolon
macro_line|#endif
id|dev_priv-&gt;scratch
op_assign
(paren
(paren
id|__volatile__
id|u32
op_star
)paren
id|dev_priv-&gt;ring_rptr-&gt;handle
op_plus
(paren
id|RADEON_SCRATCH_REG_OFFSET
op_div
r_sizeof
(paren
id|u32
)paren
)paren
)paren
suffix:semicolon
id|dev_priv-&gt;sarea_priv-&gt;last_frame
op_assign
l_int|0
suffix:semicolon
id|RADEON_WRITE
c_func
(paren
id|RADEON_LAST_FRAME_REG
comma
id|dev_priv-&gt;sarea_priv-&gt;last_frame
)paren
suffix:semicolon
id|dev_priv-&gt;sarea_priv-&gt;last_dispatch
op_assign
l_int|0
suffix:semicolon
id|RADEON_WRITE
c_func
(paren
id|RADEON_LAST_DISPATCH_REG
comma
id|dev_priv-&gt;sarea_priv-&gt;last_dispatch
)paren
suffix:semicolon
id|dev_priv-&gt;sarea_priv-&gt;last_clear
op_assign
l_int|0
suffix:semicolon
id|RADEON_WRITE
c_func
(paren
id|RADEON_LAST_CLEAR_REG
comma
id|dev_priv-&gt;sarea_priv-&gt;last_clear
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev_priv-&gt;is_pci
)paren
(brace
id|dev_priv-&gt;phys_pci_gart
op_assign
id|DRM
c_func
(paren
id|ati_pcigart_init
)paren
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev_priv-&gt;phys_pci_gart
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;failed to init PCI GART!&bslash;n&quot;
)paren
suffix:semicolon
id|dev-&gt;dev_private
op_assign
(paren
r_void
op_star
)paren
id|dev_priv
suffix:semicolon
id|radeon_do_cleanup_cp
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/* Turn on PCI GART&n;&t;&t; */
id|tmp
op_assign
id|RADEON_READ
c_func
(paren
id|RADEON_AIC_CNTL
)paren
op_or
id|RADEON_PCIGART_TRANSLATE_EN
suffix:semicolon
id|RADEON_WRITE
c_func
(paren
id|RADEON_AIC_CNTL
comma
id|tmp
)paren
suffix:semicolon
multiline_comment|/* set PCI GART page-table base address&n;&t;&t; */
id|RADEON_WRITE
c_func
(paren
id|RADEON_AIC_PT_BASE
comma
id|virt_to_bus
c_func
(paren
(paren
r_void
op_star
)paren
id|dev_priv-&gt;phys_pci_gart
)paren
)paren
suffix:semicolon
multiline_comment|/* set address range for PCI address translate&n;&t;&t; */
id|RADEON_WRITE
c_func
(paren
id|RADEON_AIC_LO_ADDR
comma
id|dev_priv-&gt;agp_vm_start
)paren
suffix:semicolon
id|RADEON_WRITE
c_func
(paren
id|RADEON_AIC_HI_ADDR
comma
id|dev_priv-&gt;agp_vm_start
op_plus
id|dev_priv-&gt;agp_size
op_minus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Turn off AGP aperture -- is this required for PCIGART?&n;&t;&t; */
id|RADEON_WRITE
c_func
(paren
id|RADEON_MC_AGP_LOCATION
comma
l_int|0xffffffc0
)paren
suffix:semicolon
multiline_comment|/* ?? */
id|RADEON_WRITE
c_func
(paren
id|RADEON_AGP_COMMAND
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* clear AGP_COMMAND */
)brace
r_else
(brace
multiline_comment|/* Turn off PCI GART&n;&t;&t; */
id|tmp
op_assign
id|RADEON_READ
c_func
(paren
id|RADEON_AIC_CNTL
)paren
op_amp
op_complement
id|RADEON_PCIGART_TRANSLATE_EN
suffix:semicolon
id|RADEON_WRITE
c_func
(paren
id|RADEON_AIC_CNTL
comma
id|tmp
)paren
suffix:semicolon
)brace
id|radeon_cp_load_microcode
c_func
(paren
id|dev_priv
)paren
suffix:semicolon
id|radeon_cp_init_ring_buffer
c_func
(paren
id|dev
comma
id|dev_priv
)paren
suffix:semicolon
macro_line|#if ROTATE_BUFS
id|dev_priv-&gt;last_buf
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
id|dev-&gt;dev_private
op_assign
(paren
r_void
op_star
)paren
id|dev_priv
suffix:semicolon
id|radeon_do_engine_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|radeon_do_cleanup_cp
r_int
id|radeon_do_cleanup_cp
c_func
(paren
id|drm_device_t
op_star
id|dev
)paren
(brace
id|DRM_DEBUG
c_func
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;dev_private
)paren
(brace
id|drm_radeon_private_t
op_star
id|dev_priv
op_assign
id|dev-&gt;dev_private
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev_priv-&gt;is_pci
)paren
(brace
id|DRM_IOREMAPFREE
c_func
(paren
id|dev_priv-&gt;cp_ring
)paren
suffix:semicolon
id|DRM_IOREMAPFREE
c_func
(paren
id|dev_priv-&gt;ring_rptr
)paren
suffix:semicolon
id|DRM_IOREMAPFREE
c_func
(paren
id|dev_priv-&gt;buffers
)paren
suffix:semicolon
)brace
id|DRM
c_func
(paren
id|free
)paren
(paren
id|dev-&gt;dev_private
comma
r_sizeof
(paren
id|drm_radeon_private_t
)paren
comma
id|DRM_MEM_DRIVER
)paren
suffix:semicolon
id|dev-&gt;dev_private
op_assign
l_int|NULL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|radeon_cp_init
r_int
id|radeon_cp_init
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
id|drm_file_t
op_star
id|priv
op_assign
id|filp-&gt;private_data
suffix:semicolon
id|drm_device_t
op_star
id|dev
op_assign
id|priv-&gt;dev
suffix:semicolon
id|drm_radeon_init_t
id|init
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|init
comma
(paren
id|drm_radeon_init_t
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|init
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_switch
c_cond
(paren
id|init.func
)paren
(brace
r_case
id|RADEON_INIT_CP
suffix:colon
r_return
id|radeon_do_init_cp
c_func
(paren
id|dev
comma
op_amp
id|init
)paren
suffix:semicolon
r_case
id|RADEON_CLEANUP_CP
suffix:colon
r_return
id|radeon_do_cleanup_cp
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|radeon_cp_start
r_int
id|radeon_cp_start
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
id|drm_file_t
op_star
id|priv
op_assign
id|filp-&gt;private_data
suffix:semicolon
id|drm_device_t
op_star
id|dev
op_assign
id|priv-&gt;dev
suffix:semicolon
id|drm_radeon_private_t
op_star
id|dev_priv
op_assign
id|dev-&gt;dev_private
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|LOCK_TEST_WITH_RETURN
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev_priv-&gt;cp_running
)paren
(brace
id|DRM_DEBUG
c_func
(paren
l_string|&quot;%s while CP running&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev_priv-&gt;cp_mode
op_eq
id|RADEON_CSQ_PRIDIS_INDDIS
)paren
(brace
id|DRM_DEBUG
c_func
(paren
l_string|&quot;%s called with bogus CP mode (%d)&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|dev_priv-&gt;cp_mode
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|radeon_do_cp_start
c_func
(paren
id|dev_priv
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Stop the CP.  The engine must have been idled before calling this&n; * routine.&n; */
DECL|function|radeon_cp_stop
r_int
id|radeon_cp_stop
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
id|drm_file_t
op_star
id|priv
op_assign
id|filp-&gt;private_data
suffix:semicolon
id|drm_device_t
op_star
id|dev
op_assign
id|priv-&gt;dev
suffix:semicolon
id|drm_radeon_private_t
op_star
id|dev_priv
op_assign
id|dev-&gt;dev_private
suffix:semicolon
id|drm_radeon_cp_stop_t
id|stop
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|LOCK_TEST_WITH_RETURN
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|stop
comma
(paren
id|drm_radeon_init_t
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|stop
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
multiline_comment|/* Flush any pending CP commands.  This ensures any outstanding&n;&t; * commands are exectuted by the engine before we turn it off.&n;&t; */
r_if
c_cond
(paren
id|stop.flush
)paren
(brace
id|radeon_do_cp_flush
c_func
(paren
id|dev_priv
)paren
suffix:semicolon
)brace
multiline_comment|/* If we fail to make the engine go idle, we return an error&n;&t; * code so that the DRM ioctl wrapper can try again.&n;&t; */
r_if
c_cond
(paren
id|stop.idle
)paren
(brace
id|ret
op_assign
id|radeon_do_cp_idle
c_func
(paren
id|dev_priv
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* Finally, we can turn off the CP.  If the engine isn&squot;t idle,&n;&t; * we will get some dropped triangles as they won&squot;t be fully&n;&t; * rendered before the CP is shut down.&n;&t; */
id|radeon_do_cp_stop
c_func
(paren
id|dev_priv
)paren
suffix:semicolon
multiline_comment|/* Reset the engine */
id|radeon_do_engine_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Just reset the CP ring.  Called as part of an X Server engine reset.&n; */
DECL|function|radeon_cp_reset
r_int
id|radeon_cp_reset
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
id|drm_file_t
op_star
id|priv
op_assign
id|filp-&gt;private_data
suffix:semicolon
id|drm_device_t
op_star
id|dev
op_assign
id|priv-&gt;dev
suffix:semicolon
id|drm_radeon_private_t
op_star
id|dev_priv
op_assign
id|dev-&gt;dev_private
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|LOCK_TEST_WITH_RETURN
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev_priv
)paren
(brace
id|DRM_DEBUG
c_func
(paren
l_string|&quot;%s called before init done&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|radeon_do_cp_reset
c_func
(paren
id|dev_priv
)paren
suffix:semicolon
multiline_comment|/* The CP is no longer running after an engine reset */
id|dev_priv-&gt;cp_running
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|radeon_cp_idle
r_int
id|radeon_cp_idle
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
id|drm_file_t
op_star
id|priv
op_assign
id|filp-&gt;private_data
suffix:semicolon
id|drm_device_t
op_star
id|dev
op_assign
id|priv-&gt;dev
suffix:semicolon
id|drm_radeon_private_t
op_star
id|dev_priv
op_assign
id|dev-&gt;dev_private
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|LOCK_TEST_WITH_RETURN
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|radeon_do_cp_idle
c_func
(paren
id|dev_priv
)paren
suffix:semicolon
)brace
DECL|function|radeon_engine_reset
r_int
id|radeon_engine_reset
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
id|drm_file_t
op_star
id|priv
op_assign
id|filp-&gt;private_data
suffix:semicolon
id|drm_device_t
op_star
id|dev
op_assign
id|priv-&gt;dev
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|LOCK_TEST_WITH_RETURN
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|radeon_do_engine_reset
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/* ================================================================&n; * Fullscreen mode&n; */
DECL|function|radeon_do_init_pageflip
r_static
r_int
id|radeon_do_init_pageflip
c_func
(paren
id|drm_device_t
op_star
id|dev
)paren
(brace
id|drm_radeon_private_t
op_star
id|dev_priv
op_assign
id|dev-&gt;dev_private
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|dev_priv-&gt;crtc_offset
op_assign
id|RADEON_READ
c_func
(paren
id|RADEON_CRTC_OFFSET
)paren
suffix:semicolon
id|dev_priv-&gt;crtc_offset_cntl
op_assign
id|RADEON_READ
c_func
(paren
id|RADEON_CRTC_OFFSET_CNTL
)paren
suffix:semicolon
id|RADEON_WRITE
c_func
(paren
id|RADEON_CRTC_OFFSET
comma
id|dev_priv-&gt;front_offset
)paren
suffix:semicolon
id|RADEON_WRITE
c_func
(paren
id|RADEON_CRTC_OFFSET_CNTL
comma
id|dev_priv-&gt;crtc_offset_cntl
op_or
id|RADEON_CRTC_OFFSET_FLIP_CNTL
)paren
suffix:semicolon
id|dev_priv-&gt;page_flipping
op_assign
l_int|1
suffix:semicolon
id|dev_priv-&gt;current_page
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|radeon_do_cleanup_pageflip
r_int
id|radeon_do_cleanup_pageflip
c_func
(paren
id|drm_device_t
op_star
id|dev
)paren
(brace
id|drm_radeon_private_t
op_star
id|dev_priv
op_assign
id|dev-&gt;dev_private
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|RADEON_WRITE
c_func
(paren
id|RADEON_CRTC_OFFSET
comma
id|dev_priv-&gt;crtc_offset
)paren
suffix:semicolon
id|RADEON_WRITE
c_func
(paren
id|RADEON_CRTC_OFFSET_CNTL
comma
id|dev_priv-&gt;crtc_offset_cntl
)paren
suffix:semicolon
id|dev_priv-&gt;page_flipping
op_assign
l_int|0
suffix:semicolon
id|dev_priv-&gt;current_page
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|radeon_fullscreen
r_int
id|radeon_fullscreen
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
id|drm_file_t
op_star
id|priv
op_assign
id|filp-&gt;private_data
suffix:semicolon
id|drm_device_t
op_star
id|dev
op_assign
id|priv-&gt;dev
suffix:semicolon
id|drm_radeon_fullscreen_t
id|fs
suffix:semicolon
id|LOCK_TEST_WITH_RETURN
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|fs
comma
(paren
id|drm_radeon_fullscreen_t
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|fs
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_switch
c_cond
(paren
id|fs.func
)paren
(brace
r_case
id|RADEON_INIT_FULLSCREEN
suffix:colon
r_return
id|radeon_do_init_pageflip
c_func
(paren
id|dev
)paren
suffix:semicolon
r_case
id|RADEON_CLEANUP_FULLSCREEN
suffix:colon
r_return
id|radeon_do_cleanup_pageflip
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* ================================================================&n; * Freelist management&n; */
DECL|macro|RADEON_BUFFER_USED
mdefine_line|#define RADEON_BUFFER_USED&t;0xffffffff
DECL|macro|RADEON_BUFFER_FREE
mdefine_line|#define RADEON_BUFFER_FREE&t;0
macro_line|#if 0
r_static
r_int
id|radeon_freelist_init
c_func
(paren
id|drm_device_t
op_star
id|dev
)paren
(brace
id|drm_device_dma_t
op_star
id|dma
op_assign
id|dev-&gt;dma
suffix:semicolon
id|drm_radeon_private_t
op_star
id|dev_priv
op_assign
id|dev-&gt;dev_private
suffix:semicolon
id|drm_buf_t
op_star
id|buf
suffix:semicolon
id|drm_radeon_buf_priv_t
op_star
id|buf_priv
suffix:semicolon
id|drm_radeon_freelist_t
op_star
id|entry
suffix:semicolon
r_int
id|i
suffix:semicolon
id|dev_priv-&gt;head
op_assign
id|DRM
c_func
(paren
id|alloc
)paren
(paren
r_sizeof
(paren
id|drm_radeon_freelist_t
)paren
comma
id|DRM_MEM_DRIVER
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev_priv-&gt;head
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|dev_priv-&gt;head
comma
l_int|0
comma
r_sizeof
(paren
id|drm_radeon_freelist_t
)paren
)paren
suffix:semicolon
id|dev_priv-&gt;head-&gt;age
op_assign
id|RADEON_BUFFER_USED
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dma-&gt;buf_count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|buf
op_assign
id|dma-&gt;buflist
(braket
id|i
)braket
suffix:semicolon
id|buf_priv
op_assign
id|buf-&gt;dev_private
suffix:semicolon
id|entry
op_assign
id|DRM
c_func
(paren
id|alloc
)paren
(paren
r_sizeof
(paren
id|drm_radeon_freelist_t
)paren
comma
id|DRM_MEM_DRIVER
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|entry
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|entry-&gt;age
op_assign
id|RADEON_BUFFER_FREE
suffix:semicolon
id|entry-&gt;buf
op_assign
id|buf
suffix:semicolon
id|entry-&gt;prev
op_assign
id|dev_priv-&gt;head
suffix:semicolon
id|entry-&gt;next
op_assign
id|dev_priv-&gt;head-&gt;next
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|entry-&gt;next
)paren
id|dev_priv-&gt;tail
op_assign
id|entry
suffix:semicolon
id|buf_priv-&gt;discard
op_assign
l_int|0
suffix:semicolon
id|buf_priv-&gt;dispatched
op_assign
l_int|0
suffix:semicolon
id|buf_priv-&gt;list_entry
op_assign
id|entry
suffix:semicolon
id|dev_priv-&gt;head-&gt;next
op_assign
id|entry
suffix:semicolon
r_if
c_cond
(paren
id|dev_priv-&gt;head-&gt;next
)paren
id|dev_priv-&gt;head-&gt;next-&gt;prev
op_assign
id|entry
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
DECL|function|radeon_freelist_get
id|drm_buf_t
op_star
id|radeon_freelist_get
c_func
(paren
id|drm_device_t
op_star
id|dev
)paren
(brace
id|drm_device_dma_t
op_star
id|dma
op_assign
id|dev-&gt;dma
suffix:semicolon
id|drm_radeon_private_t
op_star
id|dev_priv
op_assign
id|dev-&gt;dev_private
suffix:semicolon
id|drm_radeon_buf_priv_t
op_star
id|buf_priv
suffix:semicolon
id|drm_buf_t
op_star
id|buf
suffix:semicolon
r_int
id|i
comma
id|t
suffix:semicolon
macro_line|#if ROTATE_BUFS
r_int
id|start
suffix:semicolon
macro_line|#endif
multiline_comment|/* FIXME: Optimize -- use freelist code */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dma-&gt;buf_count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|buf
op_assign
id|dma-&gt;buflist
(braket
id|i
)braket
suffix:semicolon
id|buf_priv
op_assign
id|buf-&gt;dev_private
suffix:semicolon
r_if
c_cond
(paren
id|buf-&gt;pid
op_eq
l_int|0
)paren
(brace
id|DRM_DEBUG
c_func
(paren
l_string|&quot;  ret buf=%d last=%d pid=0&bslash;n&quot;
comma
id|buf-&gt;idx
comma
id|dev_priv-&gt;last_buf
)paren
suffix:semicolon
r_return
id|buf
suffix:semicolon
)brace
id|DRM_DEBUG
c_func
(paren
l_string|&quot;    skipping buf=%d pid=%d&bslash;n&quot;
comma
id|buf-&gt;idx
comma
id|buf-&gt;pid
)paren
suffix:semicolon
)brace
macro_line|#if ROTATE_BUFS
r_if
c_cond
(paren
op_increment
id|dev_priv-&gt;last_buf
op_ge
id|dma-&gt;buf_count
)paren
id|dev_priv-&gt;last_buf
op_assign
l_int|0
suffix:semicolon
id|start
op_assign
id|dev_priv-&gt;last_buf
suffix:semicolon
macro_line|#endif
r_for
c_loop
(paren
id|t
op_assign
l_int|0
suffix:semicolon
id|t
OL
id|dev_priv-&gt;usec_timeout
suffix:semicolon
id|t
op_increment
)paren
(brace
macro_line|#if 0
multiline_comment|/* FIXME: Disable this for now */
id|u32
id|done_age
op_assign
id|dev_priv-&gt;scratch
(braket
id|RADEON_LAST_DISPATCH
)braket
suffix:semicolon
macro_line|#else
id|u32
id|done_age
op_assign
id|RADEON_READ
c_func
(paren
id|RADEON_LAST_DISPATCH_REG
)paren
suffix:semicolon
macro_line|#endif
macro_line|#if ROTATE_BUFS
r_for
c_loop
(paren
id|i
op_assign
id|start
suffix:semicolon
id|i
OL
id|dma-&gt;buf_count
suffix:semicolon
id|i
op_increment
)paren
(brace
macro_line|#else
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dma-&gt;buf_count
suffix:semicolon
id|i
op_increment
)paren
(brace
macro_line|#endif
id|buf
op_assign
id|dma-&gt;buflist
(braket
id|i
)braket
suffix:semicolon
id|buf_priv
op_assign
id|buf-&gt;dev_private
suffix:semicolon
r_if
c_cond
(paren
id|buf-&gt;pending
op_logical_and
id|buf_priv-&gt;age
op_le
id|done_age
)paren
(brace
multiline_comment|/* The buffer has been processed, so it&n;&t;&t;&t;&t; * can now be used.&n;&t;&t;&t;&t; */
id|buf-&gt;pending
op_assign
l_int|0
suffix:semicolon
id|DRM_DEBUG
c_func
(paren
l_string|&quot;  ret buf=%d last=%d age=%d done=%d&bslash;n&quot;
comma
id|buf-&gt;idx
comma
id|dev_priv-&gt;last_buf
comma
id|buf_priv-&gt;age
comma
id|done_age
)paren
suffix:semicolon
r_return
id|buf
suffix:semicolon
)brace
id|DRM_DEBUG
c_func
(paren
l_string|&quot;    skipping buf=%d age=%d done=%d&bslash;n&quot;
comma
id|buf-&gt;idx
comma
id|buf_priv-&gt;age
comma
id|done_age
)paren
suffix:semicolon
macro_line|#if ROTATE_BUFS
id|start
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
)brace
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;returning NULL!&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|radeon_freelist_reset
r_void
id|radeon_freelist_reset
c_func
(paren
id|drm_device_t
op_star
id|dev
)paren
(brace
id|drm_device_dma_t
op_star
id|dma
op_assign
id|dev-&gt;dma
suffix:semicolon
macro_line|#if ROTATE_BUFS
id|drm_radeon_private_t
op_star
id|dev_priv
op_assign
id|dev-&gt;dev_private
suffix:semicolon
macro_line|#endif
r_int
id|i
suffix:semicolon
macro_line|#if ROTATE_BUFS
id|dev_priv-&gt;last_buf
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dma-&gt;buf_count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|drm_buf_t
op_star
id|buf
op_assign
id|dma-&gt;buflist
(braket
id|i
)braket
suffix:semicolon
id|drm_radeon_buf_priv_t
op_star
id|buf_priv
op_assign
id|buf-&gt;dev_private
suffix:semicolon
id|buf_priv-&gt;age
op_assign
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/* ================================================================&n; * CP command submission&n; */
DECL|function|radeon_wait_ring
r_int
id|radeon_wait_ring
c_func
(paren
id|drm_radeon_private_t
op_star
id|dev_priv
comma
r_int
id|n
)paren
(brace
id|drm_radeon_ring_buffer_t
op_star
id|ring
op_assign
op_amp
id|dev_priv-&gt;ring
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dev_priv-&gt;usec_timeout
suffix:semicolon
id|i
op_increment
)paren
(brace
id|radeon_update_ring_snapshot
c_func
(paren
id|ring
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ring-&gt;space
OG
id|n
)paren
r_return
l_int|0
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/* FIXME: This return value is ignored in the BEGIN_RING macro! */
macro_line|#if RADEON_FIFO_DEBUG
id|radeon_status
c_func
(paren
id|dev_priv
)paren
suffix:semicolon
id|DRM_ERROR
c_func
(paren
l_string|&quot;failed!&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
DECL|function|radeon_cp_get_buffers
r_static
r_int
id|radeon_cp_get_buffers
c_func
(paren
id|drm_device_t
op_star
id|dev
comma
id|drm_dma_t
op_star
id|d
)paren
(brace
r_int
id|i
suffix:semicolon
id|drm_buf_t
op_star
id|buf
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|d-&gt;granted_count
suffix:semicolon
id|i
OL
id|d-&gt;request_count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|buf
op_assign
id|radeon_freelist_get
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|buf
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
id|buf-&gt;pid
op_assign
id|current-&gt;pid
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
op_amp
id|d-&gt;request_indices
(braket
id|i
)braket
comma
op_amp
id|buf-&gt;idx
comma
r_sizeof
(paren
id|buf-&gt;idx
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
op_amp
id|d-&gt;request_sizes
(braket
id|i
)braket
comma
op_amp
id|buf-&gt;total
comma
r_sizeof
(paren
id|buf-&gt;total
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|d-&gt;granted_count
op_increment
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|radeon_cp_buffers
r_int
id|radeon_cp_buffers
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
id|drm_file_t
op_star
id|priv
op_assign
id|filp-&gt;private_data
suffix:semicolon
id|drm_device_t
op_star
id|dev
op_assign
id|priv-&gt;dev
suffix:semicolon
id|drm_device_dma_t
op_star
id|dma
op_assign
id|dev-&gt;dma
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
id|drm_dma_t
id|d
suffix:semicolon
id|LOCK_TEST_WITH_RETURN
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|d
comma
(paren
id|drm_dma_t
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|d
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
multiline_comment|/* Please don&squot;t send us buffers.&n;&t; */
r_if
c_cond
(paren
id|d.send_count
op_ne
l_int|0
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;Process %d trying to send %d buffers via drmDMA&bslash;n&quot;
comma
id|current-&gt;pid
comma
id|d.send_count
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* We&squot;ll send you buffers.&n;&t; */
r_if
c_cond
(paren
id|d.request_count
template_param
id|dma-&gt;buf_count
)paren
(brace
id|DRM_ERROR
c_func
(paren
l_string|&quot;Process %d trying to get %d buffers (of %d max)&bslash;n&quot;
comma
id|current-&gt;pid
comma
id|d.request_count
comma
id|dma-&gt;buf_count
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|d.granted_count
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|d.request_count
)paren
(brace
id|ret
op_assign
id|radeon_cp_get_buffers
c_func
(paren
id|dev
comma
op_amp
id|d
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
id|drm_dma_t
op_star
)paren
id|arg
comma
op_amp
id|d
comma
r_sizeof
(paren
id|d
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
eof
