multiline_comment|/*&n; * PC Watchdog Driver&n; * by Ken Hollis (khollis@bitgate.com)&n; *&n; * Permission granted from Simon Machell (73244.1270@compuserve.com)&n; * Written for the Linux Kernel, and GPLed by Ken Hollis&n; *&n; * 960107&t;Added request_region routines, modulized the whole thing.&n; * 960108&t;Fixed end-of-file pointer (Thanks to Dan Hollis), added&n; *&t;&t;WD_TIMEOUT define.&n; * 960216&t;Added eof marker on the file, and changed verbose messages.&n; * 960716&t;Made functional and cosmetic changes to the source for&n; *&t;&t;inclusion in Linux 2.0.x kernels, thanks to Alan Cox.&n; * 960717&t;Removed read/seek routines, replaced with ioctl.  Also, added&n; *&t;&t;check_region command due to Alan&squot;s suggestion.&n; * 960821&t;Made changes to compile in newer 2.0.x kernels.  Added&n; *&t;&t;&quot;cold reboot sense&quot; entry.&n; * 960825&t;Made a few changes to code, deleted some defines and made&n; *&t;&t;typedefs to replace them.  Made heartbeat reset only available&n; *&t;&t;via ioctl, and removed the write routine.&n; * 960828&t;Added new items for PC Watchdog Rev.C card.&n; * 960829&t;Changed around all of the IOCTLs, added new features,&n; *&t;&t;added watchdog disable/re-enable routines.  Added firmware&n; *&t;&t;version reporting.  Added read routine for temperature.&n; *&t;&t;Removed some extra defines, added an autodetect Revision&n; *&t;&t;routine.&n; * 961006       Revised some documentation, fixed some cosmetic bugs.  Made&n; *              drivers to panic the system if it&squot;s overheating at bootup.&n; * 961118&t;Changed some verbiage on some of the output, tidied up&n; *&t;&t;code bits, and added compatibility to 2.1.x.&n; * 970912       Enabled board on open and disable on close.&n; * 971107&t;Took account of recent VFS changes (broke read).&n; * 971210       Disable board on initialisation in case board already ticking.&n; * 971222       Changed open/close for temperature handling&n; *              Michael Meskes &lt;meskes@debian.org&gt;.&n; * 980112       Used minor numbers from include/linux/miscdevice.h&n; * 990403       Clear reset status after reading control status register in&n; *              pcwd_showprevstate(). [Marc Boucher &lt;marc@mbsi.ca&gt;]&n; * 990605&t;Made changes to code to support Firmware 1.22a, added&n; *&t;&t;fairly useless proc entry.&n; * 990610&t;removed said useless proc code for the merge &lt;alan&gt;&n; * 000403&t;Removed last traces of proc code. &lt;davej&gt;&n; * 011214&t;Added nowayout module option to override CONFIG_WATCHDOG_NOWAYOUT &lt;Matt_Domsch@dell.com&gt;&n; *              Added timeout module option to override default&n; */
multiline_comment|/*&n; *&t;A bells and whistles driver is available from http://www.pcwd.de/&n; *&t;More info available at http://www.berkprod.com/ or http://www.pcwatchdog.com/&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/moduleparam.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/jiffies.h&gt;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/wait.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/miscdevice.h&gt;
macro_line|#include &lt;linux/watchdog.h&gt;
macro_line|#include &lt;linux/notifier.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/reboot.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/io.h&gt;
DECL|macro|WD_VER
mdefine_line|#define WD_VER                  &quot;1.16 (06/12/2004)&quot;
DECL|macro|PFX
mdefine_line|#define PFX&t;&t;&t;&quot;pcwd: &quot;
multiline_comment|/*&n; * It should be noted that PCWD_REVISION_B was removed because A and B&n; * are essentially the same types of card, with the exception that B&n; * has temperature reporting.  Since I didn&squot;t receive a Rev.B card,&n; * the Rev.B card is not supported.  (It&squot;s a good thing too, as they&n; * are no longer in production.)&n; */
DECL|macro|PCWD_REVISION_A
mdefine_line|#define&t;PCWD_REVISION_A&t;&t;1
DECL|macro|PCWD_REVISION_C
mdefine_line|#define&t;PCWD_REVISION_C&t;&t;2
multiline_comment|/*&n; * These are the defines that describe the control status bits for the&n; * PC Watchdog card, revision A.&n; */
DECL|macro|WD_WDRST
mdefine_line|#define WD_WDRST                0x01&t;/* Previously reset state */
DECL|macro|WD_T110
mdefine_line|#define WD_T110                 0x02&t;/* Temperature overheat sense */
DECL|macro|WD_HRTBT
mdefine_line|#define WD_HRTBT                0x04&t;/* Heartbeat sense */
DECL|macro|WD_RLY2
mdefine_line|#define WD_RLY2                 0x08&t;/* External relay triggered */
DECL|macro|WD_SRLY2
mdefine_line|#define WD_SRLY2                0x80&t;/* Software external relay triggered */
multiline_comment|/*&n; * These are the defines that describe the control status bits for the&n; * PC Watchdog card, revision C.&n; */
DECL|macro|WD_REVC_WTRP
mdefine_line|#define WD_REVC_WTRP            0x01&t;/* Watchdog Trip status */
DECL|macro|WD_REVC_HRBT
mdefine_line|#define WD_REVC_HRBT            0x02&t;/* Watchdog Heartbeat */
DECL|macro|WD_REVC_TTRP
mdefine_line|#define WD_REVC_TTRP            0x04&t;/* Temperature Trip status */
multiline_comment|/* max. time we give an ISA watchdog card to process a command */
multiline_comment|/* 500ms for each 4 bit response (according to spec.) */
DECL|macro|ISA_COMMAND_TIMEOUT
mdefine_line|#define ISA_COMMAND_TIMEOUT     1000
multiline_comment|/* Watchdog&squot;s internal commands */
DECL|macro|CMD_ISA_IDLE
mdefine_line|#define CMD_ISA_IDLE                    0x00
DECL|macro|CMD_ISA_VERSION_INTEGER
mdefine_line|#define CMD_ISA_VERSION_INTEGER         0x01
DECL|macro|CMD_ISA_VERSION_TENTH
mdefine_line|#define CMD_ISA_VERSION_TENTH           0x02
DECL|macro|CMD_ISA_VERSION_HUNDRETH
mdefine_line|#define CMD_ISA_VERSION_HUNDRETH        0x03
DECL|macro|CMD_ISA_VERSION_MINOR
mdefine_line|#define CMD_ISA_VERSION_MINOR           0x04
DECL|macro|CMD_ISA_SWITCH_SETTINGS
mdefine_line|#define CMD_ISA_SWITCH_SETTINGS         0x05
DECL|macro|CMD_ISA_DELAY_TIME_2SECS
mdefine_line|#define CMD_ISA_DELAY_TIME_2SECS        0x0A
DECL|macro|CMD_ISA_DELAY_TIME_4SECS
mdefine_line|#define CMD_ISA_DELAY_TIME_4SECS        0x0B
DECL|macro|CMD_ISA_DELAY_TIME_8SECS
mdefine_line|#define CMD_ISA_DELAY_TIME_8SECS        0x0C
multiline_comment|/*&n; * We are using an kernel timer to do the pinging of the watchdog&n; * every ~500ms. We try to set the internal heartbeat of the&n; * watchdog to 2 ms.&n; */
DECL|macro|WDT_INTERVAL
mdefine_line|#define WDT_INTERVAL (HZ/2+1)
multiline_comment|/* We can only use 1 card due to the /dev/watchdog restriction */
DECL|variable|cards_found
r_static
r_int
id|cards_found
suffix:semicolon
multiline_comment|/* internal variables */
DECL|variable|open_allowed
r_static
id|atomic_t
id|open_allowed
op_assign
id|ATOMIC_INIT
c_func
(paren
l_int|1
)paren
suffix:semicolon
DECL|variable|expect_close
r_static
r_char
id|expect_close
suffix:semicolon
DECL|variable|timer
r_static
r_struct
id|timer_list
id|timer
suffix:semicolon
DECL|variable|next_heartbeat
r_static
r_int
r_int
id|next_heartbeat
suffix:semicolon
DECL|variable|temp_panic
r_static
r_int
id|temp_panic
suffix:semicolon
DECL|variable|revision
r_static
r_int
id|revision
suffix:semicolon
multiline_comment|/* The card&squot;s revision */
DECL|variable|supports_temp
r_static
r_int
id|supports_temp
suffix:semicolon
multiline_comment|/* Wether or not the card has a temperature device */
DECL|variable|command_mode
r_static
r_int
id|command_mode
suffix:semicolon
multiline_comment|/* Wether or not the card is in command mode */
DECL|variable|initial_status
r_static
r_int
id|initial_status
suffix:semicolon
multiline_comment|/* The card&squot;s boot status */
DECL|variable|current_readport
r_static
r_int
id|current_readport
suffix:semicolon
multiline_comment|/* The cards I/O address */
DECL|variable|io_lock
r_static
id|spinlock_t
id|io_lock
suffix:semicolon
multiline_comment|/* module parameters */
DECL|macro|WATCHDOG_HEARTBEAT
mdefine_line|#define WATCHDOG_HEARTBEAT 60&t;&t;/* 60 sec default heartbeat */
DECL|variable|heartbeat
r_static
r_int
id|heartbeat
op_assign
id|WATCHDOG_HEARTBEAT
suffix:semicolon
id|module_param
c_func
(paren
id|heartbeat
comma
r_int
comma
l_int|0
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|heartbeat
comma
l_string|&quot;Watchdog heartbeat in seconds. (2&lt;=heartbeat&lt;=7200, default=&quot;
id|__MODULE_STRING
c_func
(paren
id|WATCHDOG_HEARTBEAT
)paren
l_string|&quot;)&quot;
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_WATCHDOG_NOWAYOUT
DECL|variable|nowayout
r_static
r_int
id|nowayout
op_assign
l_int|1
suffix:semicolon
macro_line|#else
DECL|variable|nowayout
r_static
r_int
id|nowayout
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
id|module_param
c_func
(paren
id|nowayout
comma
r_int
comma
l_int|0
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|nowayout
comma
l_string|&quot;Watchdog cannot be stopped once started (default=CONFIG_WATCHDOG_NOWAYOUT)&quot;
)paren
suffix:semicolon
multiline_comment|/*&n; *&t;Internal functions&n; */
DECL|function|send_isa_command
r_static
r_int
id|send_isa_command
c_func
(paren
r_int
id|cmd
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|control_status
suffix:semicolon
r_int
id|port0
comma
id|last_port0
suffix:semicolon
multiline_comment|/* Double read for stabilising */
multiline_comment|/* The WCMD bit must be 1 and the command is only 4 bits in size */
id|control_status
op_assign
(paren
id|cmd
op_amp
l_int|0x0F
)paren
op_or
l_int|0x80
suffix:semicolon
id|outb_p
c_func
(paren
id|control_status
comma
id|current_readport
op_plus
l_int|2
)paren
suffix:semicolon
id|udelay
c_func
(paren
id|ISA_COMMAND_TIMEOUT
)paren
suffix:semicolon
id|port0
op_assign
id|inb_p
c_func
(paren
id|current_readport
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|25
suffix:semicolon
op_increment
id|i
)paren
(brace
id|last_port0
op_assign
id|port0
suffix:semicolon
id|port0
op_assign
id|inb_p
c_func
(paren
id|current_readport
)paren
suffix:semicolon
r_if
c_cond
(paren
id|port0
op_eq
id|last_port0
)paren
r_break
suffix:semicolon
multiline_comment|/* Data is stable */
id|udelay
(paren
l_int|250
)paren
suffix:semicolon
)brace
r_return
id|port0
suffix:semicolon
)brace
DECL|function|set_command_mode
r_static
r_int
id|set_command_mode
c_func
(paren
r_void
)paren
(brace
r_int
id|i
comma
id|found
op_assign
l_int|0
comma
id|count
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Set the card into command mode */
id|spin_lock
c_func
(paren
op_amp
id|io_lock
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
op_logical_neg
id|found
)paren
op_logical_and
(paren
id|count
OL
l_int|3
)paren
)paren
(brace
id|i
op_assign
id|send_isa_command
c_func
(paren
id|CMD_ISA_IDLE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
l_int|0x00
)paren
id|found
op_assign
l_int|1
suffix:semicolon
r_else
r_if
c_cond
(paren
id|i
op_eq
l_int|0xF3
)paren
(brace
multiline_comment|/* Card does not like what we&squot;ve done to it */
id|outb_p
c_func
(paren
l_int|0x00
comma
id|current_readport
op_plus
l_int|2
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1200
)paren
suffix:semicolon
multiline_comment|/* Spec says wait 1ms */
id|outb_p
c_func
(paren
l_int|0x00
comma
id|current_readport
op_plus
l_int|2
)paren
suffix:semicolon
id|udelay
c_func
(paren
id|ISA_COMMAND_TIMEOUT
)paren
suffix:semicolon
)brace
id|count
op_increment
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|io_lock
)paren
suffix:semicolon
id|command_mode
op_assign
id|found
suffix:semicolon
r_return
id|found
suffix:semicolon
)brace
DECL|function|unset_command_mode
r_static
r_void
id|unset_command_mode
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* Set the card into normal mode */
id|spin_lock
c_func
(paren
op_amp
id|io_lock
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0x00
comma
id|current_readport
op_plus
l_int|2
)paren
suffix:semicolon
id|udelay
c_func
(paren
id|ISA_COMMAND_TIMEOUT
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|io_lock
)paren
suffix:semicolon
id|command_mode
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|pcwd_timer_ping
r_static
r_void
id|pcwd_timer_ping
c_func
(paren
r_int
r_int
id|data
)paren
(brace
r_int
id|wdrst_stat
suffix:semicolon
multiline_comment|/* If we got a heartbeat pulse within the WDT_INTERVAL&n;&t; * we agree to ping the WDT */
r_if
c_cond
(paren
id|time_before
c_func
(paren
id|jiffies
comma
id|next_heartbeat
)paren
)paren
(brace
multiline_comment|/* Ping the watchdog */
id|spin_lock
c_func
(paren
op_amp
id|io_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|revision
op_eq
id|PCWD_REVISION_A
)paren
(brace
multiline_comment|/*  Rev A cards are reset by setting the WD_WDRST bit in register 1 */
id|wdrst_stat
op_assign
id|inb_p
c_func
(paren
id|current_readport
)paren
suffix:semicolon
id|wdrst_stat
op_and_assign
l_int|0x0F
suffix:semicolon
id|wdrst_stat
op_or_assign
id|WD_WDRST
suffix:semicolon
id|outb_p
c_func
(paren
id|wdrst_stat
comma
id|current_readport
op_plus
l_int|1
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Re-trigger watchdog by writing to port 0 */
id|outb_p
c_func
(paren
l_int|0x00
comma
id|current_readport
)paren
suffix:semicolon
)brace
multiline_comment|/* Re-set the timer interval */
id|mod_timer
c_func
(paren
op_amp
id|timer
comma
id|jiffies
op_plus
id|WDT_INTERVAL
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|io_lock
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|PFX
l_string|&quot;Heartbeat lost! Will not ping the watchdog&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
DECL|function|pcwd_start
r_static
r_int
id|pcwd_start
c_func
(paren
r_void
)paren
(brace
r_int
id|stat_reg
suffix:semicolon
id|next_heartbeat
op_assign
id|jiffies
op_plus
(paren
id|heartbeat
op_star
id|HZ
)paren
suffix:semicolon
multiline_comment|/* Start the timer */
id|mod_timer
c_func
(paren
op_amp
id|timer
comma
id|jiffies
op_plus
id|WDT_INTERVAL
)paren
suffix:semicolon
multiline_comment|/* Enable the port */
r_if
c_cond
(paren
id|revision
op_eq
id|PCWD_REVISION_C
)paren
(brace
id|spin_lock
c_func
(paren
op_amp
id|io_lock
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0x00
comma
id|current_readport
op_plus
l_int|3
)paren
suffix:semicolon
id|udelay
c_func
(paren
id|ISA_COMMAND_TIMEOUT
)paren
suffix:semicolon
id|stat_reg
op_assign
id|inb_p
c_func
(paren
id|current_readport
op_plus
l_int|2
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|io_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|stat_reg
op_amp
l_int|0x10
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
id|PFX
l_string|&quot;Could not start watchdog&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pcwd_stop
r_static
r_int
id|pcwd_stop
c_func
(paren
r_void
)paren
(brace
r_int
id|stat_reg
suffix:semicolon
multiline_comment|/* Stop the timer */
id|del_timer
c_func
(paren
op_amp
id|timer
)paren
suffix:semicolon
multiline_comment|/*  Disable the board  */
r_if
c_cond
(paren
id|revision
op_eq
id|PCWD_REVISION_C
)paren
(brace
id|spin_lock
c_func
(paren
op_amp
id|io_lock
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0xA5
comma
id|current_readport
op_plus
l_int|3
)paren
suffix:semicolon
id|udelay
c_func
(paren
id|ISA_COMMAND_TIMEOUT
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0xA5
comma
id|current_readport
op_plus
l_int|3
)paren
suffix:semicolon
id|udelay
c_func
(paren
id|ISA_COMMAND_TIMEOUT
)paren
suffix:semicolon
id|stat_reg
op_assign
id|inb_p
c_func
(paren
id|current_readport
op_plus
l_int|2
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|io_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|stat_reg
op_amp
l_int|0x10
)paren
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
id|PFX
l_string|&quot;Could not stop watchdog&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pcwd_keepalive
r_static
r_int
id|pcwd_keepalive
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* user land ping */
id|next_heartbeat
op_assign
id|jiffies
op_plus
(paren
id|heartbeat
op_star
id|HZ
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pcwd_set_heartbeat
r_static
r_int
id|pcwd_set_heartbeat
c_func
(paren
r_int
id|t
)paren
(brace
r_if
c_cond
(paren
(paren
id|t
OL
l_int|2
)paren
op_logical_or
(paren
id|t
OG
l_int|7200
)paren
)paren
multiline_comment|/* arbitrary upper limit */
r_return
op_minus
id|EINVAL
suffix:semicolon
id|heartbeat
op_assign
id|t
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pcwd_get_status
r_static
r_int
id|pcwd_get_status
c_func
(paren
r_int
op_star
id|status
)paren
(brace
r_int
id|card_status
suffix:semicolon
op_star
id|status
op_assign
l_int|0
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|io_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|revision
op_eq
id|PCWD_REVISION_A
)paren
multiline_comment|/* Rev A cards return status information from&n;&t;&t; * the base register, which is used for the&n;&t;&t; * temperature in other cards. */
id|card_status
op_assign
id|inb
c_func
(paren
id|current_readport
)paren
suffix:semicolon
r_else
(brace
multiline_comment|/* Rev C cards return card status in the base&n;&t;&t; * address + 1 register. And use different bits&n;&t;&t; * to indicate a card initiated reset, and an&n;&t;&t; * over-temperature condition. And the reboot&n;&t;&t; * status can be reset. */
id|card_status
op_assign
id|inb
c_func
(paren
id|current_readport
op_plus
l_int|1
)paren
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|io_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|revision
op_eq
id|PCWD_REVISION_A
)paren
(brace
r_if
c_cond
(paren
id|card_status
op_amp
id|WD_WDRST
)paren
op_star
id|status
op_or_assign
id|WDIOF_CARDRESET
suffix:semicolon
r_if
c_cond
(paren
id|card_status
op_amp
id|WD_T110
)paren
(brace
op_star
id|status
op_or_assign
id|WDIOF_OVERHEAT
suffix:semicolon
r_if
c_cond
(paren
id|temp_panic
)paren
(brace
id|printk
(paren
id|KERN_INFO
id|PFX
l_string|&quot;Temperature overheat trip!&bslash;n&quot;
)paren
suffix:semicolon
id|machine_power_off
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|card_status
op_amp
id|WD_REVC_WTRP
)paren
op_star
id|status
op_or_assign
id|WDIOF_CARDRESET
suffix:semicolon
r_if
c_cond
(paren
id|card_status
op_amp
id|WD_REVC_TTRP
)paren
(brace
op_star
id|status
op_or_assign
id|WDIOF_OVERHEAT
suffix:semicolon
r_if
c_cond
(paren
id|temp_panic
)paren
(brace
id|printk
(paren
id|KERN_INFO
id|PFX
l_string|&quot;Temperature overheat trip!&bslash;n&quot;
)paren
suffix:semicolon
id|machine_power_off
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pcwd_clear_status
r_static
r_int
id|pcwd_clear_status
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|revision
op_eq
id|PCWD_REVISION_C
)paren
(brace
id|spin_lock
c_func
(paren
op_amp
id|io_lock
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0x00
comma
id|current_readport
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* clear reset status */
id|spin_unlock
c_func
(paren
op_amp
id|io_lock
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pcwd_get_temperature
r_static
r_int
id|pcwd_get_temperature
c_func
(paren
r_int
op_star
id|temperature
)paren
(brace
multiline_comment|/* check that port 0 gives temperature info and no command results */
r_if
c_cond
(paren
id|command_mode
)paren
r_return
op_minus
l_int|1
suffix:semicolon
op_star
id|temperature
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|supports_temp
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
multiline_comment|/*&n;&t; * Convert celsius to fahrenheit, since this was&n;&t; * the decided &squot;standard&squot; for this return value.&n;&t; */
id|spin_lock
c_func
(paren
op_amp
id|io_lock
)paren
suffix:semicolon
op_star
id|temperature
op_assign
(paren
(paren
id|inb
c_func
(paren
id|current_readport
)paren
)paren
op_star
l_int|9
op_div
l_int|5
)paren
op_plus
l_int|32
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|io_lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;/dev/watchdog handling&n; */
DECL|function|pcwd_ioctl
r_static
r_int
id|pcwd_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_int
id|rv
suffix:semicolon
r_int
id|status
suffix:semicolon
r_int
id|temperature
suffix:semicolon
r_int
id|new_heartbeat
suffix:semicolon
r_int
id|__user
op_star
id|argp
op_assign
(paren
r_int
id|__user
op_star
)paren
id|arg
suffix:semicolon
r_static
r_struct
id|watchdog_info
id|ident
op_assign
(brace
dot
id|options
op_assign
id|WDIOF_OVERHEAT
op_or
id|WDIOF_CARDRESET
op_or
id|WDIOF_KEEPALIVEPING
op_or
id|WDIOF_SETTIMEOUT
op_or
id|WDIOF_MAGICCLOSE
comma
dot
id|firmware_version
op_assign
l_int|1
comma
dot
id|identity
op_assign
l_string|&quot;PCWD&quot;
comma
)brace
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_default
suffix:colon
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
r_case
id|WDIOC_GETSUPPORT
suffix:colon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|argp
comma
op_amp
id|ident
comma
r_sizeof
(paren
id|ident
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
r_case
id|WDIOC_GETSTATUS
suffix:colon
id|pcwd_get_status
c_func
(paren
op_amp
id|status
)paren
suffix:semicolon
r_return
id|put_user
c_func
(paren
id|status
comma
id|argp
)paren
suffix:semicolon
r_case
id|WDIOC_GETBOOTSTATUS
suffix:colon
r_return
id|put_user
c_func
(paren
id|initial_status
comma
id|argp
)paren
suffix:semicolon
r_case
id|WDIOC_GETTEMP
suffix:colon
r_if
c_cond
(paren
id|pcwd_get_temperature
c_func
(paren
op_amp
id|temperature
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
id|put_user
c_func
(paren
id|temperature
comma
id|argp
)paren
suffix:semicolon
r_case
id|WDIOC_SETOPTIONS
suffix:colon
r_if
c_cond
(paren
id|revision
op_eq
id|PCWD_REVISION_C
)paren
(brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|rv
comma
id|argp
comma
r_sizeof
(paren
r_int
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rv
op_amp
id|WDIOS_DISABLECARD
)paren
(brace
r_return
id|pcwd_stop
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rv
op_amp
id|WDIOS_ENABLECARD
)paren
(brace
r_return
id|pcwd_start
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rv
op_amp
id|WDIOS_TEMPPANIC
)paren
(brace
id|temp_panic
op_assign
l_int|1
suffix:semicolon
)brace
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
r_case
id|WDIOC_KEEPALIVE
suffix:colon
id|pcwd_keepalive
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|WDIOC_SETTIMEOUT
suffix:colon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|new_heartbeat
comma
id|argp
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|pcwd_set_heartbeat
c_func
(paren
id|new_heartbeat
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|pcwd_keepalive
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Fall */
r_case
id|WDIOC_GETTIMEOUT
suffix:colon
r_return
id|put_user
c_func
(paren
id|heartbeat
comma
id|argp
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pcwd_write
r_static
id|ssize_t
id|pcwd_write
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
id|__user
op_star
id|buf
comma
r_int
id|len
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_if
c_cond
(paren
id|len
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|nowayout
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/* In case it was set long ago */
id|expect_close
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_ne
id|len
suffix:semicolon
id|i
op_increment
)paren
(brace
r_char
id|c
suffix:semicolon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|c
comma
id|buf
op_plus
id|i
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|c
op_eq
l_char|&squot;V&squot;
)paren
id|expect_close
op_assign
l_int|42
suffix:semicolon
)brace
)brace
id|pcwd_keepalive
c_func
(paren
)paren
suffix:semicolon
)brace
r_return
id|len
suffix:semicolon
)brace
DECL|function|pcwd_open
r_static
r_int
id|pcwd_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|atomic_dec_and_test
c_func
(paren
op_amp
id|open_allowed
)paren
)paren
(brace
id|atomic_inc
c_func
(paren
op_amp
id|open_allowed
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_if
c_cond
(paren
id|nowayout
)paren
id|__module_get
c_func
(paren
id|THIS_MODULE
)paren
suffix:semicolon
multiline_comment|/* Activate */
id|pcwd_start
c_func
(paren
)paren
suffix:semicolon
id|pcwd_keepalive
c_func
(paren
)paren
suffix:semicolon
r_return
id|nonseekable_open
c_func
(paren
id|inode
comma
id|file
)paren
suffix:semicolon
)brace
DECL|function|pcwd_close
r_static
r_int
id|pcwd_close
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_if
c_cond
(paren
id|expect_close
op_eq
l_int|42
)paren
(brace
id|pcwd_stop
c_func
(paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_CRIT
id|PFX
l_string|&quot;Unexpected close, not stopping watchdog!&bslash;n&quot;
)paren
suffix:semicolon
id|pcwd_keepalive
c_func
(paren
)paren
suffix:semicolon
)brace
id|expect_close
op_assign
l_int|0
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|open_allowed
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;/dev/temperature handling&n; */
DECL|function|pcwd_temp_read
r_static
id|ssize_t
id|pcwd_temp_read
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_char
id|__user
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_int
id|temperature
suffix:semicolon
r_if
c_cond
(paren
id|pcwd_get_temperature
c_func
(paren
op_amp
id|temperature
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|buf
comma
op_amp
id|temperature
comma
l_int|1
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|pcwd_temp_open
r_static
r_int
id|pcwd_temp_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|supports_temp
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_return
id|nonseekable_open
c_func
(paren
id|inode
comma
id|file
)paren
suffix:semicolon
)brace
DECL|function|pcwd_temp_close
r_static
r_int
id|pcwd_temp_close
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Notify system&n; */
DECL|function|pcwd_notify_sys
r_static
r_int
id|pcwd_notify_sys
c_func
(paren
r_struct
id|notifier_block
op_star
id|this
comma
r_int
r_int
id|code
comma
r_void
op_star
id|unused
)paren
(brace
r_if
c_cond
(paren
id|code
op_eq
id|SYS_DOWN
op_logical_or
id|code
op_eq
id|SYS_HALT
)paren
(brace
multiline_comment|/* Turn the WDT off */
id|pcwd_stop
c_func
(paren
)paren
suffix:semicolon
)brace
r_return
id|NOTIFY_DONE
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Kernel Interfaces&n; */
DECL|variable|pcwd_fops
r_static
r_struct
id|file_operations
id|pcwd_fops
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|llseek
op_assign
id|no_llseek
comma
dot
id|write
op_assign
id|pcwd_write
comma
dot
id|ioctl
op_assign
id|pcwd_ioctl
comma
dot
id|open
op_assign
id|pcwd_open
comma
dot
id|release
op_assign
id|pcwd_close
comma
)brace
suffix:semicolon
DECL|variable|pcwd_miscdev
r_static
r_struct
id|miscdevice
id|pcwd_miscdev
op_assign
(brace
dot
id|minor
op_assign
id|WATCHDOG_MINOR
comma
dot
id|name
op_assign
l_string|&quot;watchdog&quot;
comma
dot
id|fops
op_assign
op_amp
id|pcwd_fops
comma
)brace
suffix:semicolon
DECL|variable|pcwd_temp_fops
r_static
r_struct
id|file_operations
id|pcwd_temp_fops
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|llseek
op_assign
id|no_llseek
comma
dot
id|read
op_assign
id|pcwd_temp_read
comma
dot
id|open
op_assign
id|pcwd_temp_open
comma
dot
id|release
op_assign
id|pcwd_temp_close
comma
)brace
suffix:semicolon
DECL|variable|temp_miscdev
r_static
r_struct
id|miscdevice
id|temp_miscdev
op_assign
(brace
dot
id|minor
op_assign
id|TEMP_MINOR
comma
dot
id|name
op_assign
l_string|&quot;temperature&quot;
comma
dot
id|fops
op_assign
op_amp
id|pcwd_temp_fops
comma
)brace
suffix:semicolon
DECL|variable|pcwd_notifier
r_static
r_struct
id|notifier_block
id|pcwd_notifier
op_assign
(brace
dot
id|notifier_call
op_assign
id|pcwd_notify_sys
comma
)brace
suffix:semicolon
multiline_comment|/*&n; *&t;Init &amp; exit routines&n; */
DECL|function|get_support
r_static
r_inline
r_void
id|get_support
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|inb
c_func
(paren
id|current_readport
)paren
op_ne
l_int|0xF0
)paren
id|supports_temp
op_assign
l_int|1
suffix:semicolon
)brace
DECL|function|get_revision
r_static
r_inline
r_int
id|get_revision
c_func
(paren
r_void
)paren
(brace
r_int
id|r
op_assign
id|PCWD_REVISION_C
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|io_lock
)paren
suffix:semicolon
multiline_comment|/* REV A cards use only 2 io ports; test&n;&t; * presumes a floating bus reads as 0xff. */
r_if
c_cond
(paren
(paren
id|inb
c_func
(paren
id|current_readport
op_plus
l_int|2
)paren
op_eq
l_int|0xFF
)paren
op_logical_or
(paren
id|inb
c_func
(paren
id|current_readport
op_plus
l_int|3
)paren
op_eq
l_int|0xFF
)paren
)paren
id|r
op_assign
id|PCWD_REVISION_A
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|io_lock
)paren
suffix:semicolon
r_return
id|r
suffix:semicolon
)brace
DECL|function|get_firmware
r_static
r_inline
r_char
op_star
id|get_firmware
c_func
(paren
r_void
)paren
(brace
r_int
id|one
comma
id|ten
comma
id|hund
comma
id|minor
suffix:semicolon
r_char
op_star
id|ret
suffix:semicolon
id|ret
op_assign
id|kmalloc
c_func
(paren
l_int|6
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
l_int|NULL
)paren
(brace
r_return
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|set_command_mode
c_func
(paren
)paren
)paren
(brace
id|one
op_assign
id|send_isa_command
c_func
(paren
id|CMD_ISA_VERSION_INTEGER
)paren
suffix:semicolon
id|ten
op_assign
id|send_isa_command
c_func
(paren
id|CMD_ISA_VERSION_TENTH
)paren
suffix:semicolon
id|hund
op_assign
id|send_isa_command
c_func
(paren
id|CMD_ISA_VERSION_HUNDRETH
)paren
suffix:semicolon
id|minor
op_assign
id|send_isa_command
c_func
(paren
id|CMD_ISA_VERSION_MINOR
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|ret
comma
l_string|&quot;%c.%c%c%c&quot;
comma
id|one
comma
id|ten
comma
id|hund
comma
id|minor
)paren
suffix:semicolon
)brace
r_else
id|sprintf
c_func
(paren
id|ret
comma
l_string|&quot;ERROR&quot;
)paren
suffix:semicolon
id|unset_command_mode
c_func
(paren
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|get_option_switches
r_static
r_inline
r_int
id|get_option_switches
c_func
(paren
r_void
)paren
(brace
r_int
id|rv
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|set_command_mode
c_func
(paren
)paren
)paren
(brace
multiline_comment|/* Get switch settings */
id|rv
op_assign
id|send_isa_command
c_func
(paren
id|CMD_ISA_SWITCH_SETTINGS
)paren
suffix:semicolon
)brace
id|unset_command_mode
c_func
(paren
)paren
suffix:semicolon
r_return
id|rv
suffix:semicolon
)brace
DECL|function|pcwatchdog_init
r_static
r_int
id|__devinit
id|pcwatchdog_init
c_func
(paren
r_int
id|base_addr
)paren
(brace
r_int
id|ret
suffix:semicolon
r_char
op_star
id|firmware
suffix:semicolon
r_int
id|option_switches
suffix:semicolon
id|cards_found
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|cards_found
op_eq
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_INFO
id|PFX
l_string|&quot;v%s Ken Hollis (kenji@bitgate.com)&bslash;n&quot;
comma
id|WD_VER
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cards_found
OG
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;This driver only supports 1 device&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|base_addr
op_eq
l_int|0x0000
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;No I/O-Address for card detected&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|current_readport
op_assign
id|base_addr
suffix:semicolon
multiline_comment|/* Check card&squot;s revision */
id|revision
op_assign
id|get_revision
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|request_region
c_func
(paren
id|current_readport
comma
(paren
id|revision
op_eq
id|PCWD_REVISION_A
)paren
ques
c_cond
l_int|2
suffix:colon
l_int|4
comma
l_string|&quot;PCWD&quot;
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;I/O address 0x%04x already in use&bslash;n&quot;
comma
id|current_readport
)paren
suffix:semicolon
id|current_readport
op_assign
l_int|0x0000
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
multiline_comment|/* Initial variables */
id|supports_temp
op_assign
l_int|0
suffix:semicolon
id|temp_panic
op_assign
l_int|0
suffix:semicolon
id|initial_status
op_assign
l_int|0x0000
suffix:semicolon
multiline_comment|/* get the boot_status */
id|pcwd_get_status
c_func
(paren
op_amp
id|initial_status
)paren
suffix:semicolon
multiline_comment|/* clear the &quot;card caused reboot&quot; flag */
id|pcwd_clear_status
c_func
(paren
)paren
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|timer
)paren
suffix:semicolon
id|timer.function
op_assign
id|pcwd_timer_ping
suffix:semicolon
id|timer.data
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*  Disable the board  */
id|pcwd_stop
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*  Check whether or not the card supports the temperature device */
id|get_support
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Get some extra info from the hardware (in command/debug/diag mode) */
r_if
c_cond
(paren
id|revision
op_eq
id|PCWD_REVISION_A
)paren
id|printk
c_func
(paren
id|KERN_INFO
id|PFX
l_string|&quot;ISA-PC Watchdog (REV.A) detected at port 0x%04x&bslash;n&quot;
comma
id|current_readport
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|revision
op_eq
id|PCWD_REVISION_C
)paren
(brace
id|firmware
op_assign
id|get_firmware
c_func
(paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
id|PFX
l_string|&quot;ISA-PC Watchdog (REV.C) detected at port 0x%04x (Firmware version: %s)&bslash;n&quot;
comma
id|current_readport
comma
id|firmware
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|firmware
)paren
suffix:semicolon
id|option_switches
op_assign
id|get_option_switches
c_func
(paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
id|PFX
l_string|&quot;Option switches (0x%02x): Temperature Reset Enable=%s, Power On Delay=%s&bslash;n&quot;
comma
id|option_switches
comma
(paren
(paren
id|option_switches
op_amp
l_int|0x10
)paren
ques
c_cond
l_string|&quot;ON&quot;
suffix:colon
l_string|&quot;OFF&quot;
)paren
comma
(paren
(paren
id|option_switches
op_amp
l_int|0x08
)paren
ques
c_cond
l_string|&quot;ON&quot;
suffix:colon
l_string|&quot;OFF&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* Reprogram internal heartbeat to 2 seconds */
r_if
c_cond
(paren
id|set_command_mode
c_func
(paren
)paren
)paren
(brace
id|send_isa_command
c_func
(paren
id|CMD_ISA_DELAY_TIME_2SECS
)paren
suffix:semicolon
id|unset_command_mode
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* Should NEVER happen, unless get_revision() fails. */
id|printk
c_func
(paren
id|KERN_INFO
id|PFX
l_string|&quot;Unable to get revision&bslash;n&quot;
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|current_readport
comma
(paren
id|revision
op_eq
id|PCWD_REVISION_A
)paren
ques
c_cond
l_int|2
suffix:colon
l_int|4
)paren
suffix:semicolon
id|current_readport
op_assign
l_int|0x0000
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|supports_temp
)paren
id|printk
c_func
(paren
id|KERN_INFO
id|PFX
l_string|&quot;Temperature Option Detected&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|initial_status
op_amp
id|WDIOF_CARDRESET
)paren
id|printk
c_func
(paren
id|KERN_INFO
id|PFX
l_string|&quot;Previous reboot was caused by the card&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|initial_status
op_amp
id|WDIOF_OVERHEAT
)paren
(brace
id|printk
c_func
(paren
id|KERN_EMERG
id|PFX
l_string|&quot;Card senses a CPU Overheat. Panicking!&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_EMERG
id|PFX
l_string|&quot;CPU Overheat&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|initial_status
op_eq
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_INFO
id|PFX
l_string|&quot;No previous trip detected - Cold boot or reset&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Check that the heartbeat value is within it&squot;s range ; if not reset to the default */
r_if
c_cond
(paren
id|pcwd_set_heartbeat
c_func
(paren
id|heartbeat
)paren
)paren
(brace
id|pcwd_set_heartbeat
c_func
(paren
id|WATCHDOG_HEARTBEAT
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
id|PFX
l_string|&quot;heartbeat value must be 2&lt;=heartbeat&lt;=7200, using %d&bslash;n&quot;
comma
id|WATCHDOG_HEARTBEAT
)paren
suffix:semicolon
)brace
id|ret
op_assign
id|register_reboot_notifier
c_func
(paren
op_amp
id|pcwd_notifier
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;cannot register reboot notifier (err=%d)&bslash;n&quot;
comma
id|ret
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|current_readport
comma
(paren
id|revision
op_eq
id|PCWD_REVISION_A
)paren
ques
c_cond
l_int|2
suffix:colon
l_int|4
)paren
suffix:semicolon
id|current_readport
op_assign
l_int|0x0000
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
r_if
c_cond
(paren
id|supports_temp
)paren
(brace
id|ret
op_assign
id|misc_register
c_func
(paren
op_amp
id|temp_miscdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;cannot register miscdev on minor=%d (err=%d)&bslash;n&quot;
comma
id|TEMP_MINOR
comma
id|ret
)paren
suffix:semicolon
id|unregister_reboot_notifier
c_func
(paren
op_amp
id|pcwd_notifier
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|current_readport
comma
(paren
id|revision
op_eq
id|PCWD_REVISION_A
)paren
ques
c_cond
l_int|2
suffix:colon
l_int|4
)paren
suffix:semicolon
id|current_readport
op_assign
l_int|0x0000
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
)brace
id|ret
op_assign
id|misc_register
c_func
(paren
op_amp
id|pcwd_miscdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;cannot register miscdev on minor=%d (err=%d)&bslash;n&quot;
comma
id|WATCHDOG_MINOR
comma
id|ret
)paren
suffix:semicolon
r_if
c_cond
(paren
id|supports_temp
)paren
id|misc_deregister
c_func
(paren
op_amp
id|temp_miscdev
)paren
suffix:semicolon
id|unregister_reboot_notifier
c_func
(paren
op_amp
id|pcwd_notifier
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|current_readport
comma
(paren
id|revision
op_eq
id|PCWD_REVISION_A
)paren
ques
c_cond
l_int|2
suffix:colon
l_int|4
)paren
suffix:semicolon
id|current_readport
op_assign
l_int|0x0000
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
id|PFX
l_string|&quot;initialized. heartbeat=%d sec (nowayout=%d)&bslash;n&quot;
comma
id|heartbeat
comma
id|nowayout
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pcwatchdog_exit
r_static
r_void
id|__devexit
id|pcwatchdog_exit
c_func
(paren
r_void
)paren
(brace
multiline_comment|/*  Disable the board  */
r_if
c_cond
(paren
op_logical_neg
id|nowayout
)paren
id|pcwd_stop
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Deregister */
id|misc_deregister
c_func
(paren
op_amp
id|pcwd_miscdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|supports_temp
)paren
id|misc_deregister
c_func
(paren
op_amp
id|temp_miscdev
)paren
suffix:semicolon
id|unregister_reboot_notifier
c_func
(paren
op_amp
id|pcwd_notifier
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|current_readport
comma
(paren
id|revision
op_eq
id|PCWD_REVISION_A
)paren
ques
c_cond
l_int|2
suffix:colon
l_int|4
)paren
suffix:semicolon
id|current_readport
op_assign
l_int|0x0000
suffix:semicolon
)brace
multiline_comment|/*&n; *  The ISA cards have a heartbeat bit in one of the registers, which&n; *  register is card dependent.  The heartbeat bit is monitored, and if&n; *  found, is considered proof that a Berkshire card has been found.&n; *  The initial rate is once per second at board start up, then twice&n; *  per second for normal operation.&n; */
DECL|function|pcwd_checkcard
r_static
r_int
id|__init
id|pcwd_checkcard
c_func
(paren
r_int
id|base_addr
)paren
(brace
r_int
id|port0
comma
id|last_port0
suffix:semicolon
multiline_comment|/* Reg 0, in case it&squot;s REV A */
r_int
id|port1
comma
id|last_port1
suffix:semicolon
multiline_comment|/* Register 1 for REV C cards */
r_int
id|i
suffix:semicolon
r_int
id|retval
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|request_region
(paren
id|base_addr
comma
l_int|4
comma
l_string|&quot;PCWD&quot;
)paren
)paren
(brace
id|printk
(paren
id|KERN_INFO
id|PFX
l_string|&quot;Port 0x%04x unavailable&bslash;n&quot;
comma
id|base_addr
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|retval
op_assign
l_int|0
suffix:semicolon
id|port0
op_assign
id|inb_p
c_func
(paren
id|base_addr
)paren
suffix:semicolon
multiline_comment|/* For REV A boards */
id|port1
op_assign
id|inb_p
c_func
(paren
id|base_addr
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* For REV C boards */
r_if
c_cond
(paren
id|port0
op_ne
l_int|0xff
op_logical_or
id|port1
op_ne
l_int|0xff
)paren
(brace
multiline_comment|/* Not an &squot;ff&squot; from a floating bus, so must be a card! */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
op_increment
id|i
)paren
(brace
id|msleep
c_func
(paren
l_int|500
)paren
suffix:semicolon
id|last_port0
op_assign
id|port0
suffix:semicolon
id|last_port1
op_assign
id|port1
suffix:semicolon
id|port0
op_assign
id|inb_p
c_func
(paren
id|base_addr
)paren
suffix:semicolon
id|port1
op_assign
id|inb_p
c_func
(paren
id|base_addr
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Has either hearbeat bit changed?  */
r_if
c_cond
(paren
(paren
id|port0
op_xor
id|last_port0
)paren
op_amp
id|WD_HRTBT
op_logical_or
(paren
id|port1
op_xor
id|last_port1
)paren
op_amp
id|WD_REVC_HRBT
)paren
(brace
id|retval
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
id|release_region
(paren
id|base_addr
comma
l_int|4
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * These are the auto-probe addresses available.&n; *&n; * Revision A only uses ports 0x270 and 0x370.  Revision C introduced 0x350.&n; * Revision A has an address range of 2 addresses, while Revision C has 4.&n; */
DECL|variable|pcwd_ioports
r_static
r_int
id|pcwd_ioports
(braket
)braket
op_assign
(brace
l_int|0x270
comma
l_int|0x350
comma
l_int|0x370
comma
l_int|0x000
)brace
suffix:semicolon
DECL|function|pcwd_init_module
r_static
r_int
id|__init
id|pcwd_init_module
c_func
(paren
r_void
)paren
(brace
r_int
id|i
comma
id|found
op_assign
l_int|0
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|io_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|pcwd_ioports
(braket
id|i
)braket
op_ne
l_int|0
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|pcwd_checkcard
c_func
(paren
id|pcwd_ioports
(braket
id|i
)braket
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|pcwatchdog_init
c_func
(paren
id|pcwd_ioports
(braket
id|i
)braket
)paren
)paren
)paren
id|found
op_increment
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|found
)paren
(brace
id|printk
(paren
id|KERN_INFO
id|PFX
l_string|&quot;No card detected, or port not available&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pcwd_cleanup_module
r_static
r_void
id|__exit
id|pcwd_cleanup_module
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|current_readport
)paren
id|pcwatchdog_exit
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|variable|pcwd_init_module
id|module_init
c_func
(paren
id|pcwd_init_module
)paren
suffix:semicolon
DECL|variable|pcwd_cleanup_module
id|module_exit
c_func
(paren
id|pcwd_cleanup_module
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Ken Hollis &lt;kenji@bitgate.com&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Berkshire ISA-PC Watchdog driver&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
DECL|variable|WATCHDOG_MINOR
id|MODULE_ALIAS_MISCDEV
c_func
(paren
id|WATCHDOG_MINOR
)paren
suffix:semicolon
DECL|variable|TEMP_MINOR
id|MODULE_ALIAS_MISCDEV
c_func
(paren
id|TEMP_MINOR
)paren
suffix:semicolon
eof
