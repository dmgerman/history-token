multiline_comment|/*&n; *&t;Berkshire PCI-PC Watchdog Card Driver&n; *&n; *&t;(c) Copyright 2003 Wim Van Sebroeck &lt;wim@iguana.be&gt;.&n; *&n; *&t;Based on source code of the following authors:&n; *&t;  Ken Hollis &lt;kenji@bitgate.com&gt;,&n; *&t;  Lindsay Harris &lt;lindsay@bluegum.com&gt;,&n; *&t;  Alan Cox &lt;alan@redhat.com&gt;,&n; *&t;  Matt Domsch &lt;Matt_Domsch@dell.com&gt;,&n; *&t;  Rob Radez &lt;rob@osinvestor.com&gt;&n; *&n; *&t;This program is free software; you can redistribute it and/or&n; *&t;modify it under the terms of the GNU General Public License&n; *&t;as published by the Free Software Foundation; either version&n; *&t;2 of the License, or (at your option) any later version.&n; *&n; *&t;Neither Wim Van Sebroeck nor Iguana vzw. admit liability nor&n; *&t;provide warranty for any of this software. This material is&n; *&t;provided &quot;AS-IS&quot; and at no charge.&n; */
multiline_comment|/*&n; *&t;A bells and whistles driver is available from http://www.pcwd.de/&n; *&t;More info available at http://www.berkprod.com/ or http://www.pcwatchdog.com/&n; */
multiline_comment|/*&n; *&t;Includes, defines, variables, module parameters, ...&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/moduleparam.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/miscdevice.h&gt;
macro_line|#include &lt;linux/watchdog.h&gt;
macro_line|#include &lt;linux/notifier.h&gt;
macro_line|#include &lt;linux/reboot.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/io.h&gt;
multiline_comment|/* Module and version information */
DECL|macro|WATCHDOG_VERSION
mdefine_line|#define WATCHDOG_VERSION &quot;1.00&quot;
DECL|macro|WATCHDOG_DATE
mdefine_line|#define WATCHDOG_DATE &quot;12 Jun 2004&quot;
DECL|macro|WATCHDOG_DRIVER_NAME
mdefine_line|#define WATCHDOG_DRIVER_NAME &quot;PCI-PC Watchdog&quot;
DECL|macro|WATCHDOG_NAME
mdefine_line|#define WATCHDOG_NAME &quot;pcwd_pci&quot;
DECL|macro|PFX
mdefine_line|#define PFX WATCHDOG_NAME &quot;: &quot;
DECL|macro|DRIVER_VERSION
mdefine_line|#define DRIVER_VERSION WATCHDOG_DRIVER_NAME &quot; driver, v&quot; WATCHDOG_VERSION &quot; (&quot; WATCHDOG_DATE &quot;)&bslash;n&quot;
multiline_comment|/* Stuff for the PCI ID&squot;s  */
macro_line|#ifndef PCI_VENDOR_ID_QUICKLOGIC
DECL|macro|PCI_VENDOR_ID_QUICKLOGIC
mdefine_line|#define PCI_VENDOR_ID_QUICKLOGIC    0x11e3
macro_line|#endif
macro_line|#ifndef PCI_DEVICE_ID_WATCHDOG_PCIPCWD
DECL|macro|PCI_DEVICE_ID_WATCHDOG_PCIPCWD
mdefine_line|#define PCI_DEVICE_ID_WATCHDOG_PCIPCWD 0x5030
macro_line|#endif
multiline_comment|/*&n; * These are the defines that describe the control status bits for the&n; * PCI-PC Watchdog card.&n; */
DECL|macro|WD_PCI_WTRP
mdefine_line|#define WD_PCI_WTRP             0x01&t;/* Watchdog Trip status */
DECL|macro|WD_PCI_HRBT
mdefine_line|#define WD_PCI_HRBT             0x02&t;/* Watchdog Heartbeat */
DECL|macro|WD_PCI_TTRP
mdefine_line|#define WD_PCI_TTRP             0x04&t;/* Temperature Trip status */
multiline_comment|/* according to documentation max. time to process a command for the pci&n; * watchdog card is 100 ms, so we give it 150 ms to do it&squot;s job */
DECL|macro|PCI_COMMAND_TIMEOUT
mdefine_line|#define PCI_COMMAND_TIMEOUT&t;150
multiline_comment|/* Watchdog&squot;s internal commands */
DECL|macro|CMD_GET_STATUS
mdefine_line|#define CMD_GET_STATUS&t;&t;&t;0x04
DECL|macro|CMD_GET_FIRMWARE_VERSION
mdefine_line|#define CMD_GET_FIRMWARE_VERSION&t;0x08
DECL|macro|CMD_READ_WATCHDOG_TIMEOUT
mdefine_line|#define CMD_READ_WATCHDOG_TIMEOUT&t;0x18
DECL|macro|CMD_WRITE_WATCHDOG_TIMEOUT
mdefine_line|#define CMD_WRITE_WATCHDOG_TIMEOUT&t;0x19
multiline_comment|/* We can only use 1 card due to the /dev/watchdog restriction */
DECL|variable|cards_found
r_static
r_int
id|cards_found
suffix:semicolon
multiline_comment|/* internal variables */
DECL|variable|temp_panic
r_static
r_int
id|temp_panic
suffix:semicolon
DECL|variable|is_active
r_static
r_int
r_int
id|is_active
suffix:semicolon
DECL|variable|expect_release
r_static
r_char
id|expect_release
suffix:semicolon
r_static
r_struct
(brace
DECL|member|supports_temp
r_int
id|supports_temp
suffix:semicolon
multiline_comment|/* Wether or not the card has a temperature device */
DECL|member|boot_status
r_int
id|boot_status
suffix:semicolon
multiline_comment|/* The card&squot;s boot status */
DECL|member|io_addr
r_int
r_int
id|io_addr
suffix:semicolon
multiline_comment|/* The cards I/O address */
DECL|member|io_lock
id|spinlock_t
id|io_lock
suffix:semicolon
DECL|member|pdev
r_struct
id|pci_dev
op_star
id|pdev
suffix:semicolon
DECL|variable|pcipcwd_private
)brace
id|pcipcwd_private
suffix:semicolon
multiline_comment|/* module parameters */
DECL|macro|WATCHDOG_HEARTBEAT
mdefine_line|#define WATCHDOG_HEARTBEAT 2&t;/* 2 sec default heartbeat */
DECL|variable|heartbeat
r_static
r_int
id|heartbeat
op_assign
id|WATCHDOG_HEARTBEAT
suffix:semicolon
id|module_param
c_func
(paren
id|heartbeat
comma
r_int
comma
l_int|0
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|heartbeat
comma
l_string|&quot;Watchdog heartbeat in seconds. (0&lt;heartbeat&lt;65536, default=&quot;
id|__MODULE_STRING
c_func
(paren
id|WATCHDOG_HEARTBEAT
)paren
l_string|&quot;)&quot;
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_WATCHDOG_NOWAYOUT
DECL|variable|nowayout
r_static
r_int
id|nowayout
op_assign
l_int|1
suffix:semicolon
macro_line|#else
DECL|variable|nowayout
r_static
r_int
id|nowayout
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
id|module_param
c_func
(paren
id|nowayout
comma
r_int
comma
l_int|0
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|nowayout
comma
l_string|&quot;Watchdog cannot be stopped once started (default=CONFIG_WATCHDOG_NOWAYOUT)&quot;
)paren
suffix:semicolon
multiline_comment|/*&n; *&t;Internal functions&n; */
DECL|function|send_command
r_static
r_int
id|send_command
c_func
(paren
r_int
id|cmd
comma
r_int
op_star
id|msb
comma
r_int
op_star
id|lsb
)paren
(brace
r_int
id|got_response
comma
id|count
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|pcipcwd_private.io_lock
)paren
suffix:semicolon
multiline_comment|/* If a command requires data it should be written first.&n;&t; * Data for commands with 8 bits of data should be written to port 4.&n;&t; * Commands with 16 bits of data, should be written as LSB to port 4&n;&t; * and MSB to port 5.&n;&t; * After the required data has been written then write the command to&n;&t; * port 6. */
id|outb_p
c_func
(paren
op_star
id|lsb
comma
id|pcipcwd_private.io_addr
op_plus
l_int|4
)paren
suffix:semicolon
id|outb_p
c_func
(paren
op_star
id|msb
comma
id|pcipcwd_private.io_addr
op_plus
l_int|5
)paren
suffix:semicolon
id|outb_p
c_func
(paren
id|cmd
comma
id|pcipcwd_private.io_addr
op_plus
l_int|6
)paren
suffix:semicolon
multiline_comment|/* wait till the pci card processed the command, signaled by&n;&t; * the WRSP bit in port 2 and give it a max. timeout of&n;&t; * PCI_COMMAND_TIMEOUT to process */
id|got_response
op_assign
id|inb_p
c_func
(paren
id|pcipcwd_private.io_addr
op_plus
l_int|2
)paren
op_amp
l_int|0x40
suffix:semicolon
r_for
c_loop
(paren
id|count
op_assign
l_int|0
suffix:semicolon
(paren
id|count
OL
id|PCI_COMMAND_TIMEOUT
)paren
op_logical_and
(paren
op_logical_neg
id|got_response
)paren
suffix:semicolon
id|count
op_increment
)paren
(brace
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|got_response
op_assign
id|inb_p
c_func
(paren
id|pcipcwd_private.io_addr
op_plus
l_int|2
)paren
op_amp
l_int|0x40
suffix:semicolon
)brace
r_if
c_cond
(paren
id|got_response
)paren
(brace
multiline_comment|/* read back response */
op_star
id|lsb
op_assign
id|inb_p
c_func
(paren
id|pcipcwd_private.io_addr
op_plus
l_int|4
)paren
suffix:semicolon
op_star
id|msb
op_assign
id|inb_p
c_func
(paren
id|pcipcwd_private.io_addr
op_plus
l_int|5
)paren
suffix:semicolon
multiline_comment|/* clear WRSP bit */
id|inb_p
c_func
(paren
id|pcipcwd_private.io_addr
op_plus
l_int|6
)paren
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|pcipcwd_private.io_lock
)paren
suffix:semicolon
r_return
id|got_response
suffix:semicolon
)brace
DECL|function|pcipcwd_start
r_static
r_int
id|pcipcwd_start
c_func
(paren
r_void
)paren
(brace
r_int
id|stat_reg
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|pcipcwd_private.io_lock
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0x00
comma
id|pcipcwd_private.io_addr
op_plus
l_int|3
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1000
)paren
suffix:semicolon
id|stat_reg
op_assign
id|inb_p
c_func
(paren
id|pcipcwd_private.io_addr
op_plus
l_int|2
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|pcipcwd_private.io_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|stat_reg
op_amp
l_int|0x10
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;Card timer not enabled&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pcipcwd_stop
r_static
r_int
id|pcipcwd_stop
c_func
(paren
r_void
)paren
(brace
r_int
id|stat_reg
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|pcipcwd_private.io_lock
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0xA5
comma
id|pcipcwd_private.io_addr
op_plus
l_int|3
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1000
)paren
suffix:semicolon
id|outb_p
c_func
(paren
l_int|0xA5
comma
id|pcipcwd_private.io_addr
op_plus
l_int|3
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1000
)paren
suffix:semicolon
id|stat_reg
op_assign
id|inb_p
c_func
(paren
id|pcipcwd_private.io_addr
op_plus
l_int|2
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|pcipcwd_private.io_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|stat_reg
op_amp
l_int|0x10
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;Card did not acknowledge disable attempt&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pcipcwd_keepalive
r_static
r_int
id|pcipcwd_keepalive
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* Re-trigger watchdog by writing to port 0 */
id|outb_p
c_func
(paren
l_int|0x42
comma
id|pcipcwd_private.io_addr
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pcipcwd_set_heartbeat
r_static
r_int
id|pcipcwd_set_heartbeat
c_func
(paren
r_int
id|t
)paren
(brace
r_int
id|t_msb
op_assign
id|t
op_div
l_int|256
suffix:semicolon
r_int
id|t_lsb
op_assign
id|t
op_mod
l_int|256
suffix:semicolon
r_if
c_cond
(paren
(paren
id|t
OL
l_int|0x0001
)paren
op_logical_or
(paren
id|t
OG
l_int|0xFFFF
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* Write new heartbeat to watchdog */
id|send_command
c_func
(paren
id|CMD_WRITE_WATCHDOG_TIMEOUT
comma
op_amp
id|t_msb
comma
op_amp
id|t_lsb
)paren
suffix:semicolon
id|heartbeat
op_assign
id|t
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pcipcwd_get_status
r_static
r_int
id|pcipcwd_get_status
c_func
(paren
r_int
op_star
id|status
)paren
(brace
r_int
id|new_status
suffix:semicolon
op_star
id|status
op_assign
l_int|0
suffix:semicolon
id|new_status
op_assign
id|inb_p
c_func
(paren
id|pcipcwd_private.io_addr
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|new_status
op_amp
id|WD_PCI_WTRP
)paren
op_star
id|status
op_or_assign
id|WDIOF_CARDRESET
suffix:semicolon
r_if
c_cond
(paren
id|new_status
op_amp
id|WD_PCI_TTRP
)paren
(brace
op_star
id|status
op_or_assign
id|WDIOF_OVERHEAT
suffix:semicolon
r_if
c_cond
(paren
id|temp_panic
)paren
id|panic
c_func
(paren
id|PFX
l_string|&quot;Temperature overheat trip!&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pcipcwd_clear_status
r_static
r_int
id|pcipcwd_clear_status
c_func
(paren
r_void
)paren
(brace
id|outb_p
c_func
(paren
l_int|0x01
comma
id|pcipcwd_private.io_addr
op_plus
l_int|1
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pcipcwd_get_temperature
r_static
r_int
id|pcipcwd_get_temperature
c_func
(paren
r_int
op_star
id|temperature
)paren
(brace
op_star
id|temperature
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pcipcwd_private.supports_temp
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
multiline_comment|/*&n;&t; * Convert celsius to fahrenheit, since this was&n;&t; * the decided &squot;standard&squot; for this return value.&n;&t; */
op_star
id|temperature
op_assign
(paren
(paren
id|inb_p
c_func
(paren
id|pcipcwd_private.io_addr
)paren
)paren
op_star
l_int|9
op_div
l_int|5
)paren
op_plus
l_int|32
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;/dev/watchdog handling&n; */
DECL|function|pcipcwd_write
r_static
id|ssize_t
id|pcipcwd_write
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|data
comma
r_int
id|len
comma
id|loff_t
op_star
id|ppos
)paren
(brace
multiline_comment|/* Can&squot;t seek (pwrite) on this device  */
r_if
c_cond
(paren
id|ppos
op_ne
op_amp
id|file-&gt;f_pos
)paren
r_return
op_minus
id|ESPIPE
suffix:semicolon
multiline_comment|/* See if we got the magic character &squot;V&squot; and reload the timer */
r_if
c_cond
(paren
id|len
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|nowayout
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/* note: just in case someone wrote the magic character&n;&t;&t;&t; * five months ago... */
id|expect_release
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* scan to see whether or not we got the magic character */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_ne
id|len
suffix:semicolon
id|i
op_increment
)paren
(brace
r_char
id|c
suffix:semicolon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|c
comma
id|data
op_plus
id|i
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|c
op_eq
l_char|&squot;V&squot;
)paren
id|expect_release
op_assign
l_int|42
suffix:semicolon
)brace
)brace
multiline_comment|/* someone wrote to us, we should reload the timer */
id|pcipcwd_keepalive
c_func
(paren
)paren
suffix:semicolon
)brace
r_return
id|len
suffix:semicolon
)brace
DECL|function|pcipcwd_ioctl
r_static
r_int
id|pcipcwd_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_static
r_struct
id|watchdog_info
id|ident
op_assign
(brace
dot
id|options
op_assign
id|WDIOF_OVERHEAT
op_or
id|WDIOF_CARDRESET
op_or
id|WDIOF_KEEPALIVEPING
op_or
id|WDIOF_SETTIMEOUT
op_or
id|WDIOF_MAGICCLOSE
comma
dot
id|firmware_version
op_assign
l_int|1
comma
dot
id|identity
op_assign
id|WATCHDOG_DRIVER_NAME
comma
)brace
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|WDIOC_GETSUPPORT
suffix:colon
r_return
id|copy_to_user
c_func
(paren
(paren
r_struct
id|watchdog_info
op_star
)paren
id|arg
comma
op_amp
id|ident
comma
r_sizeof
(paren
id|ident
)paren
)paren
ques
c_cond
op_minus
id|EFAULT
suffix:colon
l_int|0
suffix:semicolon
r_case
id|WDIOC_GETSTATUS
suffix:colon
(brace
r_int
id|status
suffix:semicolon
id|pcipcwd_get_status
c_func
(paren
op_amp
id|status
)paren
suffix:semicolon
r_return
id|put_user
c_func
(paren
id|status
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
)brace
r_case
id|WDIOC_GETBOOTSTATUS
suffix:colon
r_return
id|put_user
c_func
(paren
id|pcipcwd_private.boot_status
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|WDIOC_GETTEMP
suffix:colon
(brace
r_int
id|temperature
suffix:semicolon
r_if
c_cond
(paren
id|pcipcwd_get_temperature
c_func
(paren
op_amp
id|temperature
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
id|put_user
c_func
(paren
id|temperature
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
)brace
r_case
id|WDIOC_KEEPALIVE
suffix:colon
id|pcipcwd_keepalive
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|WDIOC_SETOPTIONS
suffix:colon
(brace
r_int
id|new_options
comma
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|get_user
(paren
id|new_options
comma
(paren
r_int
op_star
)paren
id|arg
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|new_options
op_amp
id|WDIOS_DISABLECARD
)paren
(brace
id|pcipcwd_stop
c_func
(paren
)paren
suffix:semicolon
id|retval
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|new_options
op_amp
id|WDIOS_ENABLECARD
)paren
(brace
id|pcipcwd_start
c_func
(paren
)paren
suffix:semicolon
id|retval
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|new_options
op_amp
id|WDIOS_TEMPPANIC
)paren
(brace
id|temp_panic
op_assign
l_int|1
suffix:semicolon
id|retval
op_assign
l_int|0
suffix:semicolon
)brace
r_return
id|retval
suffix:semicolon
)brace
r_case
id|WDIOC_SETTIMEOUT
suffix:colon
(brace
r_int
id|new_heartbeat
suffix:semicolon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|new_heartbeat
comma
(paren
r_int
op_star
)paren
id|arg
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|pcipcwd_set_heartbeat
c_func
(paren
id|new_heartbeat
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|pcipcwd_keepalive
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Fall */
)brace
r_case
id|WDIOC_GETTIMEOUT
suffix:colon
r_return
id|put_user
c_func
(paren
id|heartbeat
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
)brace
)brace
DECL|function|pcipcwd_open
r_static
r_int
id|pcipcwd_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
multiline_comment|/* /dev/watchdog can only be opened once */
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
l_int|0
comma
op_amp
id|is_active
)paren
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
multiline_comment|/* Activate */
id|pcipcwd_start
c_func
(paren
)paren
suffix:semicolon
id|pcipcwd_keepalive
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pcipcwd_release
r_static
r_int
id|pcipcwd_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
multiline_comment|/*&n;&t; *      Shut off the timer.&n;&t; */
r_if
c_cond
(paren
id|expect_release
op_eq
l_int|42
)paren
(brace
id|pcipcwd_stop
c_func
(paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_CRIT
id|PFX
l_string|&quot;Unexpected close, not stopping watchdog!&bslash;n&quot;
)paren
suffix:semicolon
id|pcipcwd_keepalive
c_func
(paren
)paren
suffix:semicolon
)brace
id|expect_release
op_assign
l_int|0
suffix:semicolon
id|clear_bit
c_func
(paren
l_int|0
comma
op_amp
id|is_active
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;/dev/temperature handling&n; */
DECL|function|pcipcwd_temp_read
r_static
id|ssize_t
id|pcipcwd_temp_read
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_char
op_star
id|data
comma
r_int
id|len
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_int
id|temperature
suffix:semicolon
multiline_comment|/* Can&squot;t seek (pwrite) on this device  */
r_if
c_cond
(paren
id|ppos
op_ne
op_amp
id|file-&gt;f_pos
)paren
r_return
op_minus
id|ESPIPE
suffix:semicolon
r_if
c_cond
(paren
id|pcipcwd_get_temperature
c_func
(paren
op_amp
id|temperature
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
(paren
id|data
comma
op_amp
id|temperature
comma
l_int|1
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|pcipcwd_temp_open
r_static
r_int
id|pcipcwd_temp_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|pcipcwd_private.supports_temp
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pcipcwd_temp_release
r_static
r_int
id|pcipcwd_temp_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Notify system&n; */
DECL|function|pcipcwd_notify_sys
r_static
r_int
id|pcipcwd_notify_sys
c_func
(paren
r_struct
id|notifier_block
op_star
id|this
comma
r_int
r_int
id|code
comma
r_void
op_star
id|unused
)paren
(brace
r_if
c_cond
(paren
id|code
op_eq
id|SYS_DOWN
op_logical_or
id|code
op_eq
id|SYS_HALT
)paren
(brace
multiline_comment|/* Turn the WDT off */
id|pcipcwd_stop
c_func
(paren
)paren
suffix:semicolon
)brace
r_return
id|NOTIFY_DONE
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Kernel Interfaces&n; */
DECL|variable|pcipcwd_fops
r_static
r_struct
id|file_operations
id|pcipcwd_fops
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|llseek
op_assign
id|no_llseek
comma
dot
id|write
op_assign
id|pcipcwd_write
comma
dot
id|ioctl
op_assign
id|pcipcwd_ioctl
comma
dot
id|open
op_assign
id|pcipcwd_open
comma
dot
id|release
op_assign
id|pcipcwd_release
comma
)brace
suffix:semicolon
DECL|variable|pcipcwd_miscdev
r_static
r_struct
id|miscdevice
id|pcipcwd_miscdev
op_assign
(brace
dot
id|minor
op_assign
id|WATCHDOG_MINOR
comma
dot
id|name
op_assign
l_string|&quot;watchdog&quot;
comma
dot
id|fops
op_assign
op_amp
id|pcipcwd_fops
comma
)brace
suffix:semicolon
DECL|variable|pcipcwd_temp_fops
r_static
r_struct
id|file_operations
id|pcipcwd_temp_fops
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|llseek
op_assign
id|no_llseek
comma
dot
id|read
op_assign
id|pcipcwd_temp_read
comma
dot
id|open
op_assign
id|pcipcwd_temp_open
comma
dot
id|release
op_assign
id|pcipcwd_temp_release
comma
)brace
suffix:semicolon
DECL|variable|pcipcwd_temp_miscdev
r_static
r_struct
id|miscdevice
id|pcipcwd_temp_miscdev
op_assign
(brace
dot
id|minor
op_assign
id|TEMP_MINOR
comma
dot
id|name
op_assign
l_string|&quot;temperature&quot;
comma
dot
id|fops
op_assign
op_amp
id|pcipcwd_temp_fops
comma
)brace
suffix:semicolon
DECL|variable|pcipcwd_notifier
r_static
r_struct
id|notifier_block
id|pcipcwd_notifier
op_assign
(brace
dot
id|notifier_call
op_assign
id|pcipcwd_notify_sys
comma
)brace
suffix:semicolon
multiline_comment|/*&n; *&t;Init &amp; exit routines&n; */
DECL|function|check_temperature_support
r_static
r_inline
r_void
id|check_temperature_support
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|inb_p
c_func
(paren
id|pcipcwd_private.io_addr
)paren
op_ne
l_int|0xF0
)paren
id|pcipcwd_private.supports_temp
op_assign
l_int|1
suffix:semicolon
)brace
DECL|function|pcipcwd_card_init
r_static
r_int
id|__devinit
id|pcipcwd_card_init
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_const
r_struct
id|pci_device_id
op_star
id|ent
)paren
(brace
r_int
id|ret
op_assign
op_minus
id|EIO
suffix:semicolon
r_int
id|got_fw_rev
comma
id|fw_rev_major
comma
id|fw_rev_minor
suffix:semicolon
r_char
id|fw_ver_str
(braket
l_int|20
)braket
suffix:semicolon
r_char
id|option_switches
suffix:semicolon
id|cards_found
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|cards_found
op_eq
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_INFO
id|PFX
id|DRIVER_VERSION
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cards_found
OG
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;This driver only supports 1 device&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pci_enable_device
c_func
(paren
id|pdev
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;Not possible to enable PCI Device&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
op_eq
l_int|0x0000
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;No I/O-Address for card detected&bslash;n&quot;
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|err_out_disable_device
suffix:semicolon
)brace
id|pcipcwd_private.pdev
op_assign
id|pdev
suffix:semicolon
id|pcipcwd_private.io_addr
op_assign
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_request_regions
c_func
(paren
id|pdev
comma
id|WATCHDOG_NAME
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;I/O address 0x%04x already in use&bslash;n&quot;
comma
(paren
r_int
)paren
id|pcipcwd_private.io_addr
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|err_out_disable_device
suffix:semicolon
)brace
multiline_comment|/* get the boot_status */
id|pcipcwd_get_status
c_func
(paren
op_amp
id|pcipcwd_private.boot_status
)paren
suffix:semicolon
multiline_comment|/* clear the &quot;card caused reboot&quot; flag */
id|pcipcwd_clear_status
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* disable card */
id|pcipcwd_stop
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Check whether or not the card supports the temperature device */
id|check_temperature_support
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Get the Firmware Version */
id|got_fw_rev
op_assign
id|send_command
c_func
(paren
id|CMD_GET_FIRMWARE_VERSION
comma
op_amp
id|fw_rev_major
comma
op_amp
id|fw_rev_minor
)paren
suffix:semicolon
r_if
c_cond
(paren
id|got_fw_rev
)paren
(brace
id|sprintf
c_func
(paren
id|fw_ver_str
comma
l_string|&quot;%u.%02u&quot;
comma
id|fw_rev_major
comma
id|fw_rev_minor
)paren
suffix:semicolon
)brace
r_else
(brace
id|sprintf
c_func
(paren
id|fw_ver_str
comma
l_string|&quot;&lt;card no answer&gt;&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* Get switch settings */
id|option_switches
op_assign
id|inb_p
c_func
(paren
id|pcipcwd_private.io_addr
op_plus
l_int|3
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
id|PFX
l_string|&quot;Found card at port 0x%04x (Firmware: %s) %s temp option&bslash;n&quot;
comma
(paren
r_int
)paren
id|pcipcwd_private.io_addr
comma
id|fw_ver_str
comma
(paren
id|pcipcwd_private.supports_temp
ques
c_cond
l_string|&quot;with&quot;
suffix:colon
l_string|&quot;without&quot;
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
id|PFX
l_string|&quot;Option switches (0x%02x): Temperature Reset Enable=%s, Power On Delay=%s&bslash;n&quot;
comma
id|option_switches
comma
(paren
(paren
id|option_switches
op_amp
l_int|0x10
)paren
ques
c_cond
l_string|&quot;ON&quot;
suffix:colon
l_string|&quot;OFF&quot;
)paren
comma
(paren
(paren
id|option_switches
op_amp
l_int|0x08
)paren
ques
c_cond
l_string|&quot;ON&quot;
suffix:colon
l_string|&quot;OFF&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pcipcwd_private.boot_status
op_amp
id|WDIOF_CARDRESET
)paren
id|printk
c_func
(paren
id|KERN_INFO
id|PFX
l_string|&quot;Previous reset was caused by the Watchdog card&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pcipcwd_private.boot_status
op_amp
id|WDIOF_OVERHEAT
)paren
id|printk
c_func
(paren
id|KERN_INFO
id|PFX
l_string|&quot;Card sensed a CPU Overheat&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pcipcwd_private.boot_status
op_eq
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_INFO
id|PFX
l_string|&quot;No previous trip detected - Cold boot or reset&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Check that the heartbeat value is within it&squot;s range ; if not reset to the default */
r_if
c_cond
(paren
id|pcipcwd_set_heartbeat
c_func
(paren
id|heartbeat
)paren
)paren
(brace
id|pcipcwd_set_heartbeat
c_func
(paren
id|WATCHDOG_HEARTBEAT
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
id|PFX
l_string|&quot;heartbeat value must be 0&lt;heartbeat&lt;65536, using %d&bslash;n&quot;
comma
id|WATCHDOG_HEARTBEAT
)paren
suffix:semicolon
)brace
id|ret
op_assign
id|register_reboot_notifier
c_func
(paren
op_amp
id|pcipcwd_notifier
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;cannot register reboot notifier (err=%d)&bslash;n&quot;
comma
id|ret
)paren
suffix:semicolon
r_goto
id|err_out_release_region
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pcipcwd_private.supports_temp
)paren
(brace
id|ret
op_assign
id|misc_register
c_func
(paren
op_amp
id|pcipcwd_temp_miscdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;cannot register miscdev on minor=%d (err=%d)&bslash;n&quot;
comma
id|TEMP_MINOR
comma
id|ret
)paren
suffix:semicolon
r_goto
id|err_out_unregister_reboot
suffix:semicolon
)brace
)brace
id|ret
op_assign
id|misc_register
c_func
(paren
op_amp
id|pcipcwd_miscdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;cannot register miscdev on minor=%d (err=%d)&bslash;n&quot;
comma
id|WATCHDOG_MINOR
comma
id|ret
)paren
suffix:semicolon
r_goto
id|err_out_misc_deregister
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
id|PFX
l_string|&quot;initialized. heartbeat=%d sec (nowayout=%d)&bslash;n&quot;
comma
id|heartbeat
comma
id|nowayout
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|err_out_misc_deregister
suffix:colon
r_if
c_cond
(paren
id|pcipcwd_private.supports_temp
)paren
id|misc_deregister
c_func
(paren
op_amp
id|pcipcwd_temp_miscdev
)paren
suffix:semicolon
id|err_out_unregister_reboot
suffix:colon
id|unregister_reboot_notifier
c_func
(paren
op_amp
id|pcipcwd_notifier
)paren
suffix:semicolon
id|err_out_release_region
suffix:colon
id|pci_release_regions
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|err_out_disable_device
suffix:colon
id|pci_disable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|pcipcwd_card_exit
r_static
r_void
id|__devexit
id|pcipcwd_card_exit
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
multiline_comment|/* Stop the timer before we leave */
r_if
c_cond
(paren
op_logical_neg
id|nowayout
)paren
id|pcipcwd_stop
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Deregister */
id|misc_deregister
c_func
(paren
op_amp
id|pcipcwd_miscdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pcipcwd_private.supports_temp
)paren
id|misc_deregister
c_func
(paren
op_amp
id|pcipcwd_temp_miscdev
)paren
suffix:semicolon
id|unregister_reboot_notifier
c_func
(paren
op_amp
id|pcipcwd_notifier
)paren
suffix:semicolon
id|pci_release_regions
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|pci_disable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|cards_found
op_decrement
suffix:semicolon
)brace
DECL|variable|pcipcwd_pci_tbl
r_static
r_struct
id|pci_device_id
id|pcipcwd_pci_tbl
(braket
)braket
op_assign
(brace
(brace
id|PCI_VENDOR_ID_QUICKLOGIC
comma
id|PCI_DEVICE_ID_WATCHDOG_PCIPCWD
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
)brace
comma
(brace
l_int|0
)brace
comma
multiline_comment|/* End of list */
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|pci
comma
id|pcipcwd_pci_tbl
)paren
suffix:semicolon
DECL|variable|pcipcwd_driver
r_static
r_struct
id|pci_driver
id|pcipcwd_driver
op_assign
(brace
dot
id|name
op_assign
id|WATCHDOG_NAME
comma
dot
id|id_table
op_assign
id|pcipcwd_pci_tbl
comma
dot
id|probe
op_assign
id|pcipcwd_card_init
comma
dot
id|remove
op_assign
id|__devexit_p
c_func
(paren
id|pcipcwd_card_exit
)paren
comma
)brace
suffix:semicolon
DECL|function|pcipcwd_init_module
r_static
r_int
id|__init
id|pcipcwd_init_module
c_func
(paren
r_void
)paren
(brace
id|spin_lock_init
(paren
op_amp
id|pcipcwd_private.io_lock
)paren
suffix:semicolon
r_return
id|pci_module_init
c_func
(paren
op_amp
id|pcipcwd_driver
)paren
suffix:semicolon
)brace
DECL|function|pcipcwd_cleanup_module
r_static
r_void
id|__exit
id|pcipcwd_cleanup_module
c_func
(paren
r_void
)paren
(brace
id|pci_unregister_driver
c_func
(paren
op_amp
id|pcipcwd_driver
)paren
suffix:semicolon
)brace
DECL|variable|pcipcwd_init_module
id|module_init
c_func
(paren
id|pcipcwd_init_module
)paren
suffix:semicolon
DECL|variable|pcipcwd_cleanup_module
id|module_exit
c_func
(paren
id|pcipcwd_cleanup_module
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Wim Van Sebroeck &lt;wim@iguana.be&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Berkshire PCI-PC Watchdog driver&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
DECL|variable|WATCHDOG_MINOR
id|MODULE_ALIAS_MISCDEV
c_func
(paren
id|WATCHDOG_MINOR
)paren
suffix:semicolon
DECL|variable|TEMP_MINOR
id|MODULE_ALIAS_MISCDEV
c_func
(paren
id|TEMP_MINOR
)paren
suffix:semicolon
eof
