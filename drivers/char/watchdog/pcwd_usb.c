multiline_comment|/*&n; *&t;Berkshire USB-PC Watchdog Card Driver&n; *&n; *&t;(c) Copyright 2004 Wim Van Sebroeck &lt;wim@iguana.be&gt;.&n; *&n; *&t;Based on source code of the following authors:&n; *&t;  Ken Hollis &lt;kenji@bitgate.com&gt;,&n; *&t;  Alan Cox &lt;alan@redhat.com&gt;,&n; *&t;  Matt Domsch &lt;Matt_Domsch@dell.com&gt;,&n; *&t;  Rob Radez &lt;rob@osinvestor.com&gt;,&n; *&t;  Greg Kroah-Hartman &lt;greg@kroah.com&gt;&n; *&n; *&t;This program is free software; you can redistribute it and/or&n; *&t;modify it under the terms of the GNU General Public License&n; *&t;as published by the Free Software Foundation; either version&n; *&t;2 of the License, or (at your option) any later version.&n; *&n; *&t;Neither Wim Van Sebroeck nor Iguana vzw. admit liability nor&n; *&t;provide warranty for any of this software. This material is&n; *&t;provided &quot;AS-IS&quot; and at no charge.&n; *&n; *&t;Thanks also to Simon Machell at Berkshire Products Inc. for&n; *&t;providing the test hardware. More info is available at&n; *&t;http://www.berkprod.com/ or http://www.pcwatchdog.com/&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/moduleparam.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/miscdevice.h&gt;
macro_line|#include &lt;linux/watchdog.h&gt;
macro_line|#include &lt;linux/notifier.h&gt;
macro_line|#include &lt;linux/reboot.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/completion.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/usb.h&gt;
macro_line|#ifdef CONFIG_USB_DEBUG
DECL|variable|debug
r_static
r_int
id|debug
op_assign
l_int|1
suffix:semicolon
macro_line|#else
DECL|variable|debug
r_static
r_int
id|debug
suffix:semicolon
macro_line|#endif
multiline_comment|/* Use our own dbg macro */
DECL|macro|dbg
macro_line|#undef dbg
DECL|macro|dbg
mdefine_line|#define dbg(format, arg...) do { if (debug) printk(KERN_DEBUG PFX format &quot;&bslash;n&quot; , ## arg); } while (0)
multiline_comment|/* Module and Version Information */
DECL|macro|DRIVER_VERSION
mdefine_line|#define DRIVER_VERSION &quot;1.00&quot;
DECL|macro|DRIVER_DATE
mdefine_line|#define DRIVER_DATE &quot;12 Jun 2004&quot;
DECL|macro|DRIVER_AUTHOR
mdefine_line|#define DRIVER_AUTHOR &quot;Wim Van Sebroeck &lt;wim@iguana.be&gt;&quot;
DECL|macro|DRIVER_DESC
mdefine_line|#define DRIVER_DESC &quot;Berkshire USB-PC Watchdog driver&quot;
DECL|macro|DRIVER_LICENSE
mdefine_line|#define DRIVER_LICENSE &quot;GPL&quot;
DECL|macro|DRIVER_NAME
mdefine_line|#define DRIVER_NAME &quot;pcwd_usb&quot;
DECL|macro|PFX
mdefine_line|#define PFX DRIVER_NAME &quot;: &quot;
DECL|variable|DRIVER_AUTHOR
id|MODULE_AUTHOR
c_func
(paren
id|DRIVER_AUTHOR
)paren
suffix:semicolon
DECL|variable|DRIVER_DESC
id|MODULE_DESCRIPTION
c_func
(paren
id|DRIVER_DESC
)paren
suffix:semicolon
DECL|variable|DRIVER_LICENSE
id|MODULE_LICENSE
c_func
(paren
id|DRIVER_LICENSE
)paren
suffix:semicolon
DECL|variable|WATCHDOG_MINOR
id|MODULE_ALIAS_MISCDEV
c_func
(paren
id|WATCHDOG_MINOR
)paren
suffix:semicolon
DECL|variable|TEMP_MINOR
id|MODULE_ALIAS_MISCDEV
c_func
(paren
id|TEMP_MINOR
)paren
suffix:semicolon
multiline_comment|/* Module Parameters */
id|module_param
c_func
(paren
id|debug
comma
r_int
comma
l_int|0
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|debug
comma
l_string|&quot;Debug enabled or not&quot;
)paren
suffix:semicolon
DECL|macro|WATCHDOG_HEARTBEAT
mdefine_line|#define WATCHDOG_HEARTBEAT 2&t;/* 2 sec default heartbeat */
DECL|variable|heartbeat
r_static
r_int
id|heartbeat
op_assign
id|WATCHDOG_HEARTBEAT
suffix:semicolon
id|module_param
c_func
(paren
id|heartbeat
comma
r_int
comma
l_int|0
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|heartbeat
comma
l_string|&quot;Watchdog heartbeat in seconds. (0&lt;heartbeat&lt;65536, default=&quot;
id|__MODULE_STRING
c_func
(paren
id|WATCHDOG_HEARTBEAT
)paren
l_string|&quot;)&quot;
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_WATCHDOG_NOWAYOUT
DECL|variable|nowayout
r_static
r_int
id|nowayout
op_assign
l_int|1
suffix:semicolon
macro_line|#else
DECL|variable|nowayout
r_static
r_int
id|nowayout
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
id|module_param
c_func
(paren
id|nowayout
comma
r_int
comma
l_int|0
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|nowayout
comma
l_string|&quot;Watchdog cannot be stopped once started (default=CONFIG_WATCHDOG_NOWAYOUT)&quot;
)paren
suffix:semicolon
multiline_comment|/* The vendor and product id&squot;s for the USB-PC Watchdog card */
DECL|macro|USB_PCWD_VENDOR_ID
mdefine_line|#define USB_PCWD_VENDOR_ID&t;0x0c98
DECL|macro|USB_PCWD_PRODUCT_ID
mdefine_line|#define USB_PCWD_PRODUCT_ID&t;0x1140
multiline_comment|/* table of devices that work with this driver */
DECL|variable|usb_pcwd_table
r_static
r_struct
id|usb_device_id
id|usb_pcwd_table
(braket
)braket
op_assign
(brace
(brace
id|USB_DEVICE
c_func
(paren
id|USB_PCWD_VENDOR_ID
comma
id|USB_PCWD_PRODUCT_ID
)paren
)brace
comma
(brace
)brace
multiline_comment|/* Terminating entry */
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
(paren
id|usb
comma
id|usb_pcwd_table
)paren
suffix:semicolon
multiline_comment|/* according to documentation max. time to process a command for the USB&n; * watchdog card is 100 or 200 ms, so we give it 250 ms to do it&squot;s job */
DECL|macro|USB_COMMAND_TIMEOUT
mdefine_line|#define USB_COMMAND_TIMEOUT&t;250
multiline_comment|/* Watchdog&squot;s internal commands */
DECL|macro|CMD_READ_TEMP
mdefine_line|#define CMD_READ_TEMP&t;&t;&t;0x02&t;/* Read Temperature; Re-trigger Watchdog */
DECL|macro|CMD_TRIGGER
mdefine_line|#define CMD_TRIGGER&t;&t;&t;CMD_READ_TEMP
DECL|macro|CMD_GET_STATUS
mdefine_line|#define CMD_GET_STATUS&t;&t;&t;0x04&t;/* Get Status Information */
DECL|macro|CMD_GET_FIRMWARE_VERSION
mdefine_line|#define CMD_GET_FIRMWARE_VERSION&t;0x08&t;/* Get Firmware Version */
DECL|macro|CMD_GET_DIP_SWITCH_SETTINGS
mdefine_line|#define CMD_GET_DIP_SWITCH_SETTINGS&t;0x0c&t;/* Get Dip Switch Settings */
DECL|macro|CMD_READ_WATCHDOG_TIMEOUT
mdefine_line|#define CMD_READ_WATCHDOG_TIMEOUT&t;0x18&t;/* Read Current Watchdog Time */
DECL|macro|CMD_WRITE_WATCHDOG_TIMEOUT
mdefine_line|#define CMD_WRITE_WATCHDOG_TIMEOUT&t;0x19&t;/* Write Current Watchdog Time */
DECL|macro|CMD_ENABLE_WATCHDOG
mdefine_line|#define CMD_ENABLE_WATCHDOG&t;&t;0x30&t;/* Enable / Disable Watchdog */
DECL|macro|CMD_DISABLE_WATCHDOG
mdefine_line|#define CMD_DISABLE_WATCHDOG&t;&t;CMD_ENABLE_WATCHDOG
multiline_comment|/* Some defines that I like to be somewhere else like include/linux/usb_hid.h */
DECL|macro|HID_REQ_SET_REPORT
mdefine_line|#define HID_REQ_SET_REPORT&t;&t;0x09
DECL|macro|HID_DT_REPORT
mdefine_line|#define HID_DT_REPORT&t;&t;&t;(USB_TYPE_CLASS | 0x02)
multiline_comment|/* We can only use 1 card due to the /dev/watchdog restriction */
DECL|variable|cards_found
r_static
r_int
id|cards_found
suffix:semicolon
multiline_comment|/* some internal variables */
DECL|variable|is_active
r_static
r_int
r_int
id|is_active
suffix:semicolon
DECL|variable|expect_release
r_static
r_char
id|expect_release
suffix:semicolon
multiline_comment|/* Structure to hold all of our device specific stuff */
DECL|struct|usb_pcwd_private
r_struct
id|usb_pcwd_private
(brace
DECL|member|udev
r_struct
id|usb_device
op_star
id|udev
suffix:semicolon
multiline_comment|/* save off the usb device pointer */
DECL|member|interface
r_struct
id|usb_interface
op_star
id|interface
suffix:semicolon
multiline_comment|/* the interface for this device */
DECL|member|interface_number
r_int
r_int
id|interface_number
suffix:semicolon
multiline_comment|/* the interface number used for cmd&squot;s */
DECL|member|intr_buffer
r_int
r_char
op_star
id|intr_buffer
suffix:semicolon
multiline_comment|/* the buffer to intr data */
DECL|member|intr_dma
id|dma_addr_t
id|intr_dma
suffix:semicolon
multiline_comment|/* the dma address for the intr buffer */
DECL|member|intr_size
r_int
id|intr_size
suffix:semicolon
multiline_comment|/* the size of the intr buffer */
DECL|member|intr_urb
r_struct
id|urb
op_star
id|intr_urb
suffix:semicolon
multiline_comment|/* the urb used for the intr pipe */
DECL|member|cmd_command
r_int
r_char
id|cmd_command
suffix:semicolon
multiline_comment|/* The command that is reported back */
DECL|member|cmd_data_msb
r_int
r_char
id|cmd_data_msb
suffix:semicolon
multiline_comment|/* The data MSB that is reported back */
DECL|member|cmd_data_lsb
r_int
r_char
id|cmd_data_lsb
suffix:semicolon
multiline_comment|/* The data LSB that is reported back */
DECL|member|cmd_received
id|atomic_t
id|cmd_received
suffix:semicolon
multiline_comment|/* true if we received a report after a command */
DECL|member|exists
r_int
id|exists
suffix:semicolon
multiline_comment|/* Wether or not the device exists */
DECL|member|sem
r_struct
id|semaphore
id|sem
suffix:semicolon
multiline_comment|/* locks this structure */
)brace
suffix:semicolon
DECL|variable|usb_pcwd_device
r_static
r_struct
id|usb_pcwd_private
op_star
id|usb_pcwd_device
suffix:semicolon
multiline_comment|/* prevent races between open() and disconnect() */
r_static
id|DECLARE_MUTEX
(paren
id|disconnect_sem
)paren
suffix:semicolon
multiline_comment|/* local function prototypes */
r_static
r_int
id|usb_pcwd_probe
(paren
r_struct
id|usb_interface
op_star
id|interface
comma
r_const
r_struct
id|usb_device_id
op_star
id|id
)paren
suffix:semicolon
r_static
r_void
id|usb_pcwd_disconnect
(paren
r_struct
id|usb_interface
op_star
id|interface
)paren
suffix:semicolon
multiline_comment|/* usb specific object needed to register this driver with the usb subsystem */
DECL|variable|usb_pcwd_driver
r_static
r_struct
id|usb_driver
id|usb_pcwd_driver
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|name
op_assign
id|DRIVER_NAME
comma
dot
id|probe
op_assign
id|usb_pcwd_probe
comma
dot
id|disconnect
op_assign
id|usb_pcwd_disconnect
comma
dot
id|id_table
op_assign
id|usb_pcwd_table
comma
)brace
suffix:semicolon
DECL|function|usb_pcwd_intr_done
r_static
r_void
id|usb_pcwd_intr_done
c_func
(paren
r_struct
id|urb
op_star
id|urb
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|usb_pcwd_private
op_star
id|usb_pcwd
op_assign
(paren
r_struct
id|usb_pcwd_private
op_star
)paren
id|urb-&gt;context
suffix:semicolon
r_int
r_char
op_star
id|data
op_assign
id|usb_pcwd-&gt;intr_buffer
suffix:semicolon
r_int
id|retval
suffix:semicolon
r_switch
c_cond
(paren
id|urb-&gt;status
)paren
(brace
r_case
l_int|0
suffix:colon
multiline_comment|/* success */
r_break
suffix:semicolon
r_case
op_minus
id|ECONNRESET
suffix:colon
multiline_comment|/* unlink */
r_case
op_minus
id|ENOENT
suffix:colon
r_case
op_minus
id|ESHUTDOWN
suffix:colon
multiline_comment|/* this urb is terminated, clean up */
id|dbg
c_func
(paren
l_string|&quot;%s - urb shutting down with status: %d&quot;
comma
id|__FUNCTION__
comma
id|urb-&gt;status
)paren
suffix:semicolon
r_return
suffix:semicolon
multiline_comment|/* -EPIPE:  should clear the halt */
r_default
suffix:colon
multiline_comment|/* error */
id|dbg
c_func
(paren
l_string|&quot;%s - nonzero urb status received: %d&quot;
comma
id|__FUNCTION__
comma
id|urb-&gt;status
)paren
suffix:semicolon
r_goto
id|resubmit
suffix:semicolon
)brace
id|dbg
c_func
(paren
l_string|&quot;received following data cmd=0x%02x msb=0x%02x lsb=0x%02x&quot;
comma
id|data
(braket
l_int|0
)braket
comma
id|data
(braket
l_int|1
)braket
comma
id|data
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|usb_pcwd-&gt;cmd_command
op_assign
id|data
(braket
l_int|0
)braket
suffix:semicolon
id|usb_pcwd-&gt;cmd_data_msb
op_assign
id|data
(braket
l_int|1
)braket
suffix:semicolon
id|usb_pcwd-&gt;cmd_data_lsb
op_assign
id|data
(braket
l_int|2
)braket
suffix:semicolon
multiline_comment|/* notify anyone waiting that the cmd has finished */
id|atomic_set
(paren
op_amp
id|usb_pcwd-&gt;cmd_received
comma
l_int|1
)paren
suffix:semicolon
id|resubmit
suffix:colon
id|retval
op_assign
id|usb_submit_urb
(paren
id|urb
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;can&squot;t resubmit intr, usb_submit_urb failed with result %d&bslash;n&quot;
comma
id|retval
)paren
suffix:semicolon
)brace
DECL|function|usb_pcwd_send_command
r_static
r_int
id|usb_pcwd_send_command
c_func
(paren
r_struct
id|usb_pcwd_private
op_star
id|usb_pcwd
comma
r_int
r_char
id|cmd
comma
r_int
r_char
op_star
id|msb
comma
r_int
r_char
op_star
id|lsb
)paren
(brace
r_int
id|got_response
comma
id|count
suffix:semicolon
r_int
r_char
id|buf
(braket
l_int|6
)braket
suffix:semicolon
multiline_comment|/* We will not send any commands if the USB PCWD device does not exist */
r_if
c_cond
(paren
(paren
op_logical_neg
id|usb_pcwd
)paren
op_logical_or
(paren
op_logical_neg
id|usb_pcwd-&gt;exists
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* The USB PC Watchdog uses a 6 byte report format. The board currently uses&n;&t; * only 3 of the six bytes of the report. */
id|buf
(braket
l_int|0
)braket
op_assign
id|cmd
suffix:semicolon
multiline_comment|/* Byte 0 = CMD */
id|buf
(braket
l_int|1
)braket
op_assign
op_star
id|msb
suffix:semicolon
multiline_comment|/* Byte 1 = Data MSB */
id|buf
(braket
l_int|2
)braket
op_assign
op_star
id|lsb
suffix:semicolon
multiline_comment|/* Byte 2 = Data LSB */
id|buf
(braket
l_int|3
)braket
op_assign
id|buf
(braket
l_int|4
)braket
op_assign
id|buf
(braket
l_int|5
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* All other bytes not used */
id|dbg
c_func
(paren
l_string|&quot;sending following data cmd=0x%02x msb=0x%02x lsb=0x%02x&quot;
comma
id|buf
(braket
l_int|0
)braket
comma
id|buf
(braket
l_int|1
)braket
comma
id|buf
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|atomic_set
(paren
op_amp
id|usb_pcwd-&gt;cmd_received
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|usb_control_msg
c_func
(paren
id|usb_pcwd-&gt;udev
comma
id|usb_sndctrlpipe
c_func
(paren
id|usb_pcwd-&gt;udev
comma
l_int|0
)paren
comma
id|HID_REQ_SET_REPORT
comma
id|HID_DT_REPORT
comma
l_int|0x0200
comma
id|usb_pcwd-&gt;interface_number
comma
id|buf
comma
r_sizeof
(paren
id|buf
)paren
comma
id|HZ
)paren
op_ne
r_sizeof
(paren
id|buf
)paren
)paren
(brace
id|dbg
c_func
(paren
l_string|&quot;usb_pcwd_send_command: error in usb_control_msg for cmd 0x%x 0x%x 0x%x&bslash;n&quot;
comma
id|cmd
comma
op_star
id|msb
comma
op_star
id|lsb
)paren
suffix:semicolon
)brace
multiline_comment|/* wait till the usb card processed the command,&n;&t; * with a max. timeout of USB_COMMAND_TIMEOUT */
id|got_response
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|count
op_assign
l_int|0
suffix:semicolon
(paren
id|count
OL
id|USB_COMMAND_TIMEOUT
)paren
op_logical_and
(paren
op_logical_neg
id|got_response
)paren
suffix:semicolon
id|count
op_increment
)paren
(brace
id|mdelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
(paren
op_amp
id|usb_pcwd-&gt;cmd_received
)paren
)paren
id|got_response
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|got_response
)paren
op_logical_and
(paren
id|cmd
op_eq
id|usb_pcwd-&gt;cmd_command
)paren
)paren
(brace
multiline_comment|/* read back response */
op_star
id|msb
op_assign
id|usb_pcwd-&gt;cmd_data_msb
suffix:semicolon
op_star
id|lsb
op_assign
id|usb_pcwd-&gt;cmd_data_lsb
suffix:semicolon
)brace
r_return
id|got_response
suffix:semicolon
)brace
DECL|function|usb_pcwd_start
r_static
r_int
id|usb_pcwd_start
c_func
(paren
r_struct
id|usb_pcwd_private
op_star
id|usb_pcwd
)paren
(brace
r_int
r_char
id|msb
op_assign
l_int|0x00
suffix:semicolon
r_int
r_char
id|lsb
op_assign
l_int|0x00
suffix:semicolon
r_int
id|retval
suffix:semicolon
multiline_comment|/* Enable Watchdog */
id|retval
op_assign
id|usb_pcwd_send_command
c_func
(paren
id|usb_pcwd
comma
id|CMD_ENABLE_WATCHDOG
comma
op_amp
id|msb
comma
op_amp
id|lsb
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|retval
op_eq
l_int|0
)paren
op_logical_or
(paren
id|lsb
op_eq
l_int|0
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;Card did not acknowledge enable attempt&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|usb_pcwd_stop
r_static
r_int
id|usb_pcwd_stop
c_func
(paren
r_struct
id|usb_pcwd_private
op_star
id|usb_pcwd
)paren
(brace
r_int
r_char
id|msb
op_assign
l_int|0xA5
suffix:semicolon
r_int
r_char
id|lsb
op_assign
l_int|0xC3
suffix:semicolon
r_int
id|retval
suffix:semicolon
multiline_comment|/* Disable Watchdog */
id|retval
op_assign
id|usb_pcwd_send_command
c_func
(paren
id|usb_pcwd
comma
id|CMD_DISABLE_WATCHDOG
comma
op_amp
id|msb
comma
op_amp
id|lsb
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|retval
op_eq
l_int|0
)paren
op_logical_or
(paren
id|lsb
op_ne
l_int|0
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;Card did not acknowledge disable attempt&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|usb_pcwd_keepalive
r_static
r_int
id|usb_pcwd_keepalive
c_func
(paren
r_struct
id|usb_pcwd_private
op_star
id|usb_pcwd
)paren
(brace
r_int
r_char
id|dummy
suffix:semicolon
multiline_comment|/* Re-trigger Watchdog */
id|usb_pcwd_send_command
c_func
(paren
id|usb_pcwd
comma
id|CMD_TRIGGER
comma
op_amp
id|dummy
comma
op_amp
id|dummy
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|usb_pcwd_set_heartbeat
r_static
r_int
id|usb_pcwd_set_heartbeat
c_func
(paren
r_struct
id|usb_pcwd_private
op_star
id|usb_pcwd
comma
r_int
id|t
)paren
(brace
r_int
r_char
id|msb
op_assign
id|t
op_div
l_int|256
suffix:semicolon
r_int
r_char
id|lsb
op_assign
id|t
op_mod
l_int|256
suffix:semicolon
r_if
c_cond
(paren
(paren
id|t
OL
l_int|0x0001
)paren
op_logical_or
(paren
id|t
OG
l_int|0xFFFF
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* Write new heartbeat to watchdog */
id|usb_pcwd_send_command
c_func
(paren
id|usb_pcwd
comma
id|CMD_WRITE_WATCHDOG_TIMEOUT
comma
op_amp
id|msb
comma
op_amp
id|lsb
)paren
suffix:semicolon
id|heartbeat
op_assign
id|t
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|usb_pcwd_get_temperature
r_static
r_int
id|usb_pcwd_get_temperature
c_func
(paren
r_struct
id|usb_pcwd_private
op_star
id|usb_pcwd
comma
r_int
op_star
id|temperature
)paren
(brace
r_int
r_char
id|msb
comma
id|lsb
suffix:semicolon
id|usb_pcwd_send_command
c_func
(paren
id|usb_pcwd
comma
id|CMD_READ_TEMP
comma
op_amp
id|msb
comma
op_amp
id|lsb
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Convert celsius to fahrenheit, since this was&n;&t; * the decided &squot;standard&squot; for this return value.&n;&t; */
op_star
id|temperature
op_assign
(paren
id|lsb
op_star
l_int|9
op_div
l_int|5
)paren
op_plus
l_int|32
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;/dev/watchdog handling&n; */
DECL|function|usb_pcwd_write
r_static
id|ssize_t
id|usb_pcwd_write
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
id|__user
op_star
id|data
comma
r_int
id|len
comma
id|loff_t
op_star
id|ppos
)paren
(brace
multiline_comment|/* Can&squot;t seek (pwrite) on this device  */
r_if
c_cond
(paren
id|ppos
op_ne
op_amp
id|file-&gt;f_pos
)paren
r_return
op_minus
id|ESPIPE
suffix:semicolon
multiline_comment|/* See if we got the magic character &squot;V&squot; and reload the timer */
r_if
c_cond
(paren
id|len
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|nowayout
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/* note: just in case someone wrote the magic character&n;&t;&t;&t; * five months ago... */
id|expect_release
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* scan to see whether or not we got the magic character */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_ne
id|len
suffix:semicolon
id|i
op_increment
)paren
(brace
r_char
id|c
suffix:semicolon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|c
comma
id|data
op_plus
id|i
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|c
op_eq
l_char|&squot;V&squot;
)paren
id|expect_release
op_assign
l_int|42
suffix:semicolon
)brace
)brace
multiline_comment|/* someone wrote to us, we should reload the timer */
id|usb_pcwd_keepalive
c_func
(paren
id|usb_pcwd_device
)paren
suffix:semicolon
)brace
r_return
id|len
suffix:semicolon
)brace
DECL|function|usb_pcwd_ioctl
r_static
r_int
id|usb_pcwd_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_void
id|__user
op_star
id|argp
op_assign
(paren
r_void
id|__user
op_star
)paren
id|arg
suffix:semicolon
r_int
id|__user
op_star
id|p
op_assign
id|argp
suffix:semicolon
r_static
r_struct
id|watchdog_info
id|ident
op_assign
(brace
dot
id|options
op_assign
id|WDIOF_KEEPALIVEPING
op_or
id|WDIOF_SETTIMEOUT
op_or
id|WDIOF_MAGICCLOSE
comma
dot
id|firmware_version
op_assign
l_int|1
comma
dot
id|identity
op_assign
id|DRIVER_NAME
comma
)brace
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|WDIOC_GETSUPPORT
suffix:colon
r_return
id|copy_to_user
c_func
(paren
id|argp
comma
op_amp
id|ident
comma
r_sizeof
(paren
id|ident
)paren
)paren
ques
c_cond
op_minus
id|EFAULT
suffix:colon
l_int|0
suffix:semicolon
r_case
id|WDIOC_GETSTATUS
suffix:colon
r_case
id|WDIOC_GETBOOTSTATUS
suffix:colon
r_return
id|put_user
c_func
(paren
l_int|0
comma
id|p
)paren
suffix:semicolon
r_case
id|WDIOC_GETTEMP
suffix:colon
(brace
r_int
id|temperature
suffix:semicolon
r_if
c_cond
(paren
id|usb_pcwd_get_temperature
c_func
(paren
id|usb_pcwd_device
comma
op_amp
id|temperature
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
id|put_user
c_func
(paren
id|temperature
comma
id|p
)paren
suffix:semicolon
)brace
r_case
id|WDIOC_KEEPALIVE
suffix:colon
id|usb_pcwd_keepalive
c_func
(paren
id|usb_pcwd_device
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|WDIOC_SETOPTIONS
suffix:colon
(brace
r_int
id|new_options
comma
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|get_user
(paren
id|new_options
comma
id|p
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|new_options
op_amp
id|WDIOS_DISABLECARD
)paren
(brace
id|usb_pcwd_stop
c_func
(paren
id|usb_pcwd_device
)paren
suffix:semicolon
id|retval
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|new_options
op_amp
id|WDIOS_ENABLECARD
)paren
(brace
id|usb_pcwd_start
c_func
(paren
id|usb_pcwd_device
)paren
suffix:semicolon
id|retval
op_assign
l_int|0
suffix:semicolon
)brace
r_return
id|retval
suffix:semicolon
)brace
r_case
id|WDIOC_SETTIMEOUT
suffix:colon
(brace
r_int
id|new_heartbeat
suffix:semicolon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|new_heartbeat
comma
id|p
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|usb_pcwd_set_heartbeat
c_func
(paren
id|usb_pcwd_device
comma
id|new_heartbeat
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|usb_pcwd_keepalive
c_func
(paren
id|usb_pcwd_device
)paren
suffix:semicolon
multiline_comment|/* Fall */
)brace
r_case
id|WDIOC_GETTIMEOUT
suffix:colon
r_return
id|put_user
c_func
(paren
id|heartbeat
comma
id|p
)paren
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
)brace
)brace
DECL|function|usb_pcwd_open
r_static
r_int
id|usb_pcwd_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
multiline_comment|/* /dev/watchdog can only be opened once */
r_if
c_cond
(paren
id|test_and_set_bit
c_func
(paren
l_int|0
comma
op_amp
id|is_active
)paren
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
multiline_comment|/* Activate */
id|usb_pcwd_start
c_func
(paren
id|usb_pcwd_device
)paren
suffix:semicolon
id|usb_pcwd_keepalive
c_func
(paren
id|usb_pcwd_device
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|usb_pcwd_release
r_static
r_int
id|usb_pcwd_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
multiline_comment|/*&n;&t; *      Shut off the timer.&n;&t; */
r_if
c_cond
(paren
id|expect_release
op_eq
l_int|42
)paren
(brace
id|usb_pcwd_stop
c_func
(paren
id|usb_pcwd_device
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_CRIT
id|PFX
l_string|&quot;Unexpected close, not stopping watchdog!&bslash;n&quot;
)paren
suffix:semicolon
id|usb_pcwd_keepalive
c_func
(paren
id|usb_pcwd_device
)paren
suffix:semicolon
)brace
id|expect_release
op_assign
l_int|0
suffix:semicolon
id|clear_bit
c_func
(paren
l_int|0
comma
op_amp
id|is_active
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;/dev/temperature handling&n; */
DECL|function|usb_pcwd_temperature_read
r_static
id|ssize_t
id|usb_pcwd_temperature_read
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_char
id|__user
op_star
id|data
comma
r_int
id|len
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_int
id|temperature
suffix:semicolon
multiline_comment|/* Can&squot;t seek (pwrite) on this device  */
r_if
c_cond
(paren
id|ppos
op_ne
op_amp
id|file-&gt;f_pos
)paren
r_return
op_minus
id|ESPIPE
suffix:semicolon
r_if
c_cond
(paren
id|usb_pcwd_get_temperature
c_func
(paren
id|usb_pcwd_device
comma
op_amp
id|temperature
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|data
comma
op_amp
id|temperature
comma
l_int|1
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|usb_pcwd_temperature_open
r_static
r_int
id|usb_pcwd_temperature_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|usb_pcwd_temperature_release
r_static
r_int
id|usb_pcwd_temperature_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Notify system&n; */
DECL|function|usb_pcwd_notify_sys
r_static
r_int
id|usb_pcwd_notify_sys
c_func
(paren
r_struct
id|notifier_block
op_star
id|this
comma
r_int
r_int
id|code
comma
r_void
op_star
id|unused
)paren
(brace
r_if
c_cond
(paren
id|code
op_eq
id|SYS_DOWN
op_logical_or
id|code
op_eq
id|SYS_HALT
)paren
(brace
multiline_comment|/* Turn the WDT off */
id|usb_pcwd_stop
c_func
(paren
id|usb_pcwd_device
)paren
suffix:semicolon
)brace
r_return
id|NOTIFY_DONE
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Kernel Interfaces&n; */
DECL|variable|usb_pcwd_fops
r_static
r_struct
id|file_operations
id|usb_pcwd_fops
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|llseek
op_assign
id|no_llseek
comma
dot
id|write
op_assign
id|usb_pcwd_write
comma
dot
id|ioctl
op_assign
id|usb_pcwd_ioctl
comma
dot
id|open
op_assign
id|usb_pcwd_open
comma
dot
id|release
op_assign
id|usb_pcwd_release
comma
)brace
suffix:semicolon
DECL|variable|usb_pcwd_miscdev
r_static
r_struct
id|miscdevice
id|usb_pcwd_miscdev
op_assign
(brace
dot
id|minor
op_assign
id|WATCHDOG_MINOR
comma
dot
id|name
op_assign
l_string|&quot;watchdog&quot;
comma
dot
id|fops
op_assign
op_amp
id|usb_pcwd_fops
comma
)brace
suffix:semicolon
DECL|variable|usb_pcwd_temperature_fops
r_static
r_struct
id|file_operations
id|usb_pcwd_temperature_fops
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|llseek
op_assign
id|no_llseek
comma
dot
id|read
op_assign
id|usb_pcwd_temperature_read
comma
dot
id|open
op_assign
id|usb_pcwd_temperature_open
comma
dot
id|release
op_assign
id|usb_pcwd_temperature_release
comma
)brace
suffix:semicolon
DECL|variable|usb_pcwd_temperature_miscdev
r_static
r_struct
id|miscdevice
id|usb_pcwd_temperature_miscdev
op_assign
(brace
dot
id|minor
op_assign
id|TEMP_MINOR
comma
dot
id|name
op_assign
l_string|&quot;temperature&quot;
comma
dot
id|fops
op_assign
op_amp
id|usb_pcwd_temperature_fops
comma
)brace
suffix:semicolon
DECL|variable|usb_pcwd_notifier
r_static
r_struct
id|notifier_block
id|usb_pcwd_notifier
op_assign
(brace
dot
id|notifier_call
op_assign
id|usb_pcwd_notify_sys
comma
)brace
suffix:semicolon
multiline_comment|/**&n; *&t;usb_pcwd_delete&n; */
DECL|function|usb_pcwd_delete
r_static
r_inline
r_void
id|usb_pcwd_delete
(paren
r_struct
id|usb_pcwd_private
op_star
id|usb_pcwd
)paren
(brace
r_if
c_cond
(paren
id|usb_pcwd-&gt;intr_urb
op_ne
l_int|NULL
)paren
id|usb_free_urb
(paren
id|usb_pcwd-&gt;intr_urb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|usb_pcwd-&gt;intr_buffer
op_ne
l_int|NULL
)paren
id|usb_buffer_free
c_func
(paren
id|usb_pcwd-&gt;udev
comma
id|usb_pcwd-&gt;intr_size
comma
id|usb_pcwd-&gt;intr_buffer
comma
id|usb_pcwd-&gt;intr_dma
)paren
suffix:semicolon
id|kfree
(paren
id|usb_pcwd
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;usb_pcwd_probe&n; *&n; *&t;Called by the usb core when a new device is connected that it thinks&n; *&t;this driver might be interested in.&n; */
DECL|function|usb_pcwd_probe
r_static
r_int
id|usb_pcwd_probe
c_func
(paren
r_struct
id|usb_interface
op_star
id|interface
comma
r_const
r_struct
id|usb_device_id
op_star
id|id
)paren
(brace
r_struct
id|usb_device
op_star
id|udev
op_assign
id|interface_to_usbdev
c_func
(paren
id|interface
)paren
suffix:semicolon
r_struct
id|usb_host_interface
op_star
id|iface_desc
suffix:semicolon
r_struct
id|usb_endpoint_descriptor
op_star
id|endpoint
suffix:semicolon
r_struct
id|usb_pcwd_private
op_star
id|usb_pcwd
op_assign
l_int|NULL
suffix:semicolon
r_int
id|pipe
comma
id|maxp
suffix:semicolon
r_int
id|retval
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_int
id|got_fw_rev
suffix:semicolon
r_int
r_char
id|fw_rev_major
comma
id|fw_rev_minor
suffix:semicolon
r_char
id|fw_ver_str
(braket
l_int|20
)braket
suffix:semicolon
r_int
r_char
id|option_switches
comma
id|dummy
suffix:semicolon
multiline_comment|/* See if the device offered us matches what we can accept */
r_if
c_cond
(paren
(paren
id|udev-&gt;descriptor.idVendor
op_ne
id|USB_PCWD_VENDOR_ID
)paren
op_logical_or
(paren
id|udev-&gt;descriptor.idProduct
op_ne
id|USB_PCWD_PRODUCT_ID
)paren
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|cards_found
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|cards_found
OG
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;This driver only supports 1 device&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* get the active interface descriptor */
id|iface_desc
op_assign
id|interface-&gt;cur_altsetting
suffix:semicolon
multiline_comment|/* check out that we have a HID device */
r_if
c_cond
(paren
op_logical_neg
(paren
id|iface_desc-&gt;desc.bInterfaceClass
op_eq
id|USB_CLASS_HID
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;The device isn&squot;t a Human Interface Device&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* check out the endpoint: it has to be Interrupt &amp; IN */
id|endpoint
op_assign
op_amp
id|iface_desc-&gt;endpoint
(braket
l_int|0
)braket
dot
id|desc
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
(paren
id|endpoint-&gt;bEndpointAddress
op_amp
id|USB_DIR_IN
)paren
op_logical_and
(paren
(paren
id|endpoint-&gt;bmAttributes
op_amp
id|USB_ENDPOINT_XFERTYPE_MASK
)paren
op_eq
id|USB_ENDPOINT_XFER_INT
)paren
)paren
)paren
(brace
multiline_comment|/* we didn&squot;t find a Interrupt endpoint with direction IN */
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;Couldn&squot;t find an INTR &amp; IN endpoint&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* get a handle to the interrupt data pipe */
id|pipe
op_assign
id|usb_rcvintpipe
c_func
(paren
id|udev
comma
id|endpoint-&gt;bEndpointAddress
)paren
suffix:semicolon
id|maxp
op_assign
id|usb_maxpacket
c_func
(paren
id|udev
comma
id|pipe
comma
id|usb_pipeout
c_func
(paren
id|pipe
)paren
)paren
suffix:semicolon
multiline_comment|/* allocate memory for our device and initialize it */
id|usb_pcwd
op_assign
id|kmalloc
(paren
r_sizeof
(paren
r_struct
id|usb_pcwd_private
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|usb_pcwd
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;Out of memory&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
id|memset
(paren
id|usb_pcwd
comma
l_int|0x00
comma
r_sizeof
(paren
op_star
id|usb_pcwd
)paren
)paren
suffix:semicolon
id|usb_pcwd_device
op_assign
id|usb_pcwd
suffix:semicolon
id|init_MUTEX
(paren
op_amp
id|usb_pcwd-&gt;sem
)paren
suffix:semicolon
id|usb_pcwd-&gt;udev
op_assign
id|udev
suffix:semicolon
id|usb_pcwd-&gt;interface
op_assign
id|interface
suffix:semicolon
id|usb_pcwd-&gt;interface_number
op_assign
id|iface_desc-&gt;desc.bInterfaceNumber
suffix:semicolon
id|usb_pcwd-&gt;intr_size
op_assign
(paren
id|endpoint-&gt;wMaxPacketSize
OG
l_int|8
ques
c_cond
id|endpoint-&gt;wMaxPacketSize
suffix:colon
l_int|8
)paren
suffix:semicolon
multiline_comment|/* set up the memory buffer&squot;s */
r_if
c_cond
(paren
op_logical_neg
(paren
id|usb_pcwd-&gt;intr_buffer
op_assign
id|usb_buffer_alloc
c_func
(paren
id|udev
comma
id|usb_pcwd-&gt;intr_size
comma
id|SLAB_ATOMIC
comma
op_amp
id|usb_pcwd-&gt;intr_dma
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;Out of memory&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
multiline_comment|/* allocate the urb&squot;s */
id|usb_pcwd-&gt;intr_urb
op_assign
id|usb_alloc_urb
c_func
(paren
l_int|0
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|usb_pcwd-&gt;intr_urb
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;Out of memory&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
multiline_comment|/* initialise the intr urb&squot;s */
id|usb_fill_int_urb
c_func
(paren
id|usb_pcwd-&gt;intr_urb
comma
id|udev
comma
id|pipe
comma
id|usb_pcwd-&gt;intr_buffer
comma
id|usb_pcwd-&gt;intr_size
comma
id|usb_pcwd_intr_done
comma
id|usb_pcwd
comma
id|endpoint-&gt;bInterval
)paren
suffix:semicolon
id|usb_pcwd-&gt;intr_urb-&gt;transfer_dma
op_assign
id|usb_pcwd-&gt;intr_dma
suffix:semicolon
id|usb_pcwd-&gt;intr_urb-&gt;transfer_flags
op_or_assign
id|URB_NO_TRANSFER_DMA_MAP
suffix:semicolon
multiline_comment|/* register our interrupt URB with the USB system */
r_if
c_cond
(paren
id|usb_submit_urb
c_func
(paren
id|usb_pcwd-&gt;intr_urb
comma
id|GFP_KERNEL
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;Problem registering interrupt URB&bslash;n&quot;
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|EIO
suffix:semicolon
multiline_comment|/* failure */
r_goto
id|error
suffix:semicolon
)brace
multiline_comment|/* The device exists and can be communicated with */
id|usb_pcwd-&gt;exists
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* disable card */
id|usb_pcwd_stop
c_func
(paren
id|usb_pcwd
)paren
suffix:semicolon
multiline_comment|/* Get the Firmware Version */
id|got_fw_rev
op_assign
id|usb_pcwd_send_command
c_func
(paren
id|usb_pcwd
comma
id|CMD_GET_FIRMWARE_VERSION
comma
op_amp
id|fw_rev_major
comma
op_amp
id|fw_rev_minor
)paren
suffix:semicolon
r_if
c_cond
(paren
id|got_fw_rev
)paren
(brace
id|sprintf
c_func
(paren
id|fw_ver_str
comma
l_string|&quot;%u.%02u&quot;
comma
id|fw_rev_major
comma
id|fw_rev_minor
)paren
suffix:semicolon
)brace
r_else
(brace
id|sprintf
c_func
(paren
id|fw_ver_str
comma
l_string|&quot;&lt;card no answer&gt;&quot;
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
id|PFX
l_string|&quot;Found card (Firmware: %s) with temp option&bslash;n&quot;
comma
id|fw_ver_str
)paren
suffix:semicolon
multiline_comment|/* Get switch settings */
id|usb_pcwd_send_command
c_func
(paren
id|usb_pcwd
comma
id|CMD_GET_DIP_SWITCH_SETTINGS
comma
op_amp
id|dummy
comma
op_amp
id|option_switches
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
id|PFX
l_string|&quot;Option switches (0x%02x): Temperature Reset Enable=%s, Power On Delay=%s&bslash;n&quot;
comma
id|option_switches
comma
(paren
(paren
id|option_switches
op_amp
l_int|0x10
)paren
ques
c_cond
l_string|&quot;ON&quot;
suffix:colon
l_string|&quot;OFF&quot;
)paren
comma
(paren
(paren
id|option_switches
op_amp
l_int|0x08
)paren
ques
c_cond
l_string|&quot;ON&quot;
suffix:colon
l_string|&quot;OFF&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* Check that the heartbeat value is within it&squot;s range ; if not reset to the default */
r_if
c_cond
(paren
id|usb_pcwd_set_heartbeat
c_func
(paren
id|usb_pcwd
comma
id|heartbeat
)paren
)paren
(brace
id|usb_pcwd_set_heartbeat
c_func
(paren
id|usb_pcwd
comma
id|WATCHDOG_HEARTBEAT
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
id|PFX
l_string|&quot;heartbeat value must be 0&lt;heartbeat&lt;65536, using %d&bslash;n&quot;
comma
id|WATCHDOG_HEARTBEAT
)paren
suffix:semicolon
)brace
id|retval
op_assign
id|register_reboot_notifier
c_func
(paren
op_amp
id|usb_pcwd_notifier
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;cannot register reboot notifier (err=%d)&bslash;n&quot;
comma
id|retval
)paren
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
id|retval
op_assign
id|misc_register
c_func
(paren
op_amp
id|usb_pcwd_temperature_miscdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;cannot register miscdev on minor=%d (err=%d)&bslash;n&quot;
comma
id|TEMP_MINOR
comma
id|retval
)paren
suffix:semicolon
r_goto
id|err_out_unregister_reboot
suffix:semicolon
)brace
id|retval
op_assign
id|misc_register
c_func
(paren
op_amp
id|usb_pcwd_miscdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;cannot register miscdev on minor=%d (err=%d)&bslash;n&quot;
comma
id|WATCHDOG_MINOR
comma
id|retval
)paren
suffix:semicolon
r_goto
id|err_out_misc_deregister
suffix:semicolon
)brace
multiline_comment|/* we can register the device now, as it is ready */
id|usb_set_intfdata
(paren
id|interface
comma
id|usb_pcwd
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
id|PFX
l_string|&quot;initialized. heartbeat=%d sec (nowayout=%d)&bslash;n&quot;
comma
id|heartbeat
comma
id|nowayout
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|err_out_misc_deregister
suffix:colon
id|misc_deregister
c_func
(paren
op_amp
id|usb_pcwd_temperature_miscdev
)paren
suffix:semicolon
id|err_out_unregister_reboot
suffix:colon
id|unregister_reboot_notifier
c_func
(paren
op_amp
id|usb_pcwd_notifier
)paren
suffix:semicolon
id|error
suffix:colon
id|usb_pcwd_delete
(paren
id|usb_pcwd
)paren
suffix:semicolon
id|usb_pcwd_device
op_assign
l_int|NULL
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;usb_pcwd_disconnect&n; *&n; *&t;Called by the usb core when the device is removed from the system.&n; *&n; *&t;This routine guarantees that the driver will not submit any more urbs&n; *&t;by clearing dev-&gt;udev.&n; */
DECL|function|usb_pcwd_disconnect
r_static
r_void
id|usb_pcwd_disconnect
c_func
(paren
r_struct
id|usb_interface
op_star
id|interface
)paren
(brace
r_struct
id|usb_pcwd_private
op_star
id|usb_pcwd
suffix:semicolon
multiline_comment|/* prevent races with open() */
id|down
(paren
op_amp
id|disconnect_sem
)paren
suffix:semicolon
id|usb_pcwd
op_assign
id|usb_get_intfdata
(paren
id|interface
)paren
suffix:semicolon
id|usb_set_intfdata
(paren
id|interface
comma
l_int|NULL
)paren
suffix:semicolon
id|down
(paren
op_amp
id|usb_pcwd-&gt;sem
)paren
suffix:semicolon
multiline_comment|/* Stop the timer before we leave */
r_if
c_cond
(paren
op_logical_neg
id|nowayout
)paren
id|usb_pcwd_stop
c_func
(paren
id|usb_pcwd
)paren
suffix:semicolon
multiline_comment|/* We should now stop communicating with the USB PCWD device */
id|usb_pcwd-&gt;exists
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Deregister */
id|misc_deregister
c_func
(paren
op_amp
id|usb_pcwd_miscdev
)paren
suffix:semicolon
id|misc_deregister
c_func
(paren
op_amp
id|usb_pcwd_temperature_miscdev
)paren
suffix:semicolon
id|unregister_reboot_notifier
c_func
(paren
op_amp
id|usb_pcwd_notifier
)paren
suffix:semicolon
id|up
(paren
op_amp
id|usb_pcwd-&gt;sem
)paren
suffix:semicolon
multiline_comment|/* Delete the USB PCWD device */
id|usb_pcwd_delete
c_func
(paren
id|usb_pcwd
)paren
suffix:semicolon
id|cards_found
op_decrement
suffix:semicolon
id|up
(paren
op_amp
id|disconnect_sem
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
id|PFX
l_string|&quot;USB PC Watchdog disconnected&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;usb_pcwd_init&n; */
DECL|function|usb_pcwd_init
r_static
r_int
id|__init
id|usb_pcwd_init
c_func
(paren
r_void
)paren
(brace
r_int
id|result
suffix:semicolon
multiline_comment|/* register this driver with the USB subsystem */
id|result
op_assign
id|usb_register
c_func
(paren
op_amp
id|usb_pcwd_driver
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;usb_register failed. Error number %d&bslash;n&quot;
comma
id|result
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
id|PFX
id|DRIVER_DESC
l_string|&quot; v&quot;
id|DRIVER_VERSION
l_string|&quot; (&quot;
id|DRIVER_DATE
l_string|&quot;)&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;usb_pcwd_exit&n; */
DECL|function|usb_pcwd_exit
r_static
r_void
id|__exit
id|usb_pcwd_exit
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* deregister this driver with the USB subsystem */
id|usb_deregister
c_func
(paren
op_amp
id|usb_pcwd_driver
)paren
suffix:semicolon
)brace
DECL|variable|usb_pcwd_init
id|module_init
(paren
id|usb_pcwd_init
)paren
suffix:semicolon
DECL|variable|usb_pcwd_exit
id|module_exit
(paren
id|usb_pcwd_exit
)paren
suffix:semicolon
eof
