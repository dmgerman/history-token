multiline_comment|/*&n; * Copyright (C) 2004 Hollis Blanchard &lt;hollisb@us.ibm.com&gt;, IBM&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or&n; * (at your option) any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA&n; */
multiline_comment|/* Host Virtual Serial Interface (HVSI) is a protocol between the hosted OS&n; * and the service processor on IBM pSeries servers. On these servers, there&n; * are no serial ports under the OS&squot;s control, and sometimes there is no other&n; * console available either. However, the service processor has two standard&n; * serial ports, so this over-complicated protocol allows the OS to control&n; * those ports by proxy.&n; *&n; * Besides data, the procotol supports the reading/writing of the serial&n; * port&squot;s DTR line, and the reading of the CD line. This is to allow the OS to&n; * control a modem attached to the service processor&squot;s serial port. Note that&n; * the OS cannot change the speed of the port through this protocol.&n; */
DECL|macro|DEBUG
macro_line|#undef DEBUG
macro_line|#include &lt;linux/console.h&gt;
macro_line|#include &lt;linux/ctype.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/major.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/sysrq.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/tty_flip.h&gt;
macro_line|#include &lt;asm/hvcall.h&gt;
macro_line|#include &lt;asm/hvconsole.h&gt;
macro_line|#include &lt;asm/prom.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/vio.h&gt;
macro_line|#include &lt;asm/param.h&gt;
DECL|macro|HVSI_MAJOR
mdefine_line|#define HVSI_MAJOR&t;229
DECL|macro|HVSI_MINOR
mdefine_line|#define HVSI_MINOR&t;128
DECL|macro|MAX_NR_HVSI_CONSOLES
mdefine_line|#define MAX_NR_HVSI_CONSOLES 4
DECL|macro|HVSI_TIMEOUT
mdefine_line|#define HVSI_TIMEOUT (5*HZ)
DECL|macro|HVSI_VERSION
mdefine_line|#define HVSI_VERSION 1
DECL|macro|HVSI_MAX_PACKET
mdefine_line|#define HVSI_MAX_PACKET 256
DECL|macro|HVSI_MAX_READ
mdefine_line|#define HVSI_MAX_READ 16
DECL|macro|HVSI_MAX_OUTGOING_DATA
mdefine_line|#define HVSI_MAX_OUTGOING_DATA 12
DECL|macro|N_OUTBUF
mdefine_line|#define N_OUTBUF 12
multiline_comment|/*&n; * we pass data via two 8-byte registers, so we would like our char arrays&n; * properly aligned for those loads.&n; */
DECL|macro|__ALIGNED__
mdefine_line|#define __ALIGNED__&t;__attribute__((__aligned__(sizeof(long))))
DECL|struct|hvsi_struct
r_struct
id|hvsi_struct
(brace
DECL|member|writer
r_struct
id|work_struct
id|writer
suffix:semicolon
DECL|member|handshaker
r_struct
id|work_struct
id|handshaker
suffix:semicolon
DECL|member|emptyq
id|wait_queue_head_t
id|emptyq
suffix:semicolon
multiline_comment|/* woken when outbuf is emptied */
DECL|member|stateq
id|wait_queue_head_t
id|stateq
suffix:semicolon
multiline_comment|/* woken when HVSI state changes */
DECL|member|lock
id|spinlock_t
id|lock
suffix:semicolon
DECL|member|index
r_int
id|index
suffix:semicolon
DECL|member|tty
r_struct
id|tty_struct
op_star
id|tty
suffix:semicolon
DECL|member|count
r_int
r_int
id|count
suffix:semicolon
DECL|member|throttle_buf
r_uint8
id|throttle_buf
(braket
l_int|128
)braket
suffix:semicolon
DECL|member|outbuf
r_uint8
id|outbuf
(braket
id|N_OUTBUF
)braket
suffix:semicolon
multiline_comment|/* to implement write_room and chars_in_buffer */
multiline_comment|/* inbuf is for packet reassembly. leave a little room for leftovers. */
DECL|member|inbuf
r_uint8
id|inbuf
(braket
id|HVSI_MAX_PACKET
op_plus
id|HVSI_MAX_READ
)braket
suffix:semicolon
DECL|member|inbuf_end
r_uint8
op_star
id|inbuf_end
suffix:semicolon
DECL|member|n_throttle
r_int
id|n_throttle
suffix:semicolon
DECL|member|n_outbuf
r_int
id|n_outbuf
suffix:semicolon
DECL|member|vtermno
r_uint32
id|vtermno
suffix:semicolon
DECL|member|virq
r_uint32
id|virq
suffix:semicolon
DECL|member|seqno
id|atomic_t
id|seqno
suffix:semicolon
multiline_comment|/* HVSI packet sequence number */
DECL|member|mctrl
r_uint16
id|mctrl
suffix:semicolon
DECL|member|state
r_uint8
id|state
suffix:semicolon
multiline_comment|/* HVSI protocol state */
DECL|member|flags
r_uint8
id|flags
suffix:semicolon
macro_line|#ifdef CONFIG_MAGIC_SYSRQ
DECL|member|sysrq
r_uint8
id|sysrq
suffix:semicolon
macro_line|#endif /* CONFIG_MAGIC_SYSRQ */
)brace
suffix:semicolon
DECL|variable|hvsi_ports
r_static
r_struct
id|hvsi_struct
id|hvsi_ports
(braket
id|MAX_NR_HVSI_CONSOLES
)braket
suffix:semicolon
DECL|variable|hvsi_driver
r_static
r_struct
id|tty_driver
op_star
id|hvsi_driver
suffix:semicolon
DECL|variable|hvsi_count
r_static
r_int
id|hvsi_count
suffix:semicolon
DECL|variable|hvsi_wait
r_static
r_int
(paren
op_star
id|hvsi_wait
)paren
(paren
r_struct
id|hvsi_struct
op_star
id|hp
comma
r_int
id|state
)paren
suffix:semicolon
DECL|enum|HVSI_PROTOCOL_STATE
r_enum
id|HVSI_PROTOCOL_STATE
(brace
DECL|enumerator|HVSI_CLOSED
id|HVSI_CLOSED
comma
DECL|enumerator|HVSI_WAIT_FOR_VER_RESPONSE
id|HVSI_WAIT_FOR_VER_RESPONSE
comma
DECL|enumerator|HVSI_WAIT_FOR_VER_QUERY
id|HVSI_WAIT_FOR_VER_QUERY
comma
DECL|enumerator|HVSI_OPEN
id|HVSI_OPEN
comma
DECL|enumerator|HVSI_WAIT_FOR_MCTRL_RESPONSE
id|HVSI_WAIT_FOR_MCTRL_RESPONSE
comma
DECL|enumerator|HVSI_FSP_DIED
id|HVSI_FSP_DIED
comma
)brace
suffix:semicolon
DECL|macro|HVSI_CONSOLE
mdefine_line|#define HVSI_CONSOLE 0x1
DECL|macro|VS_DATA_PACKET_HEADER
mdefine_line|#define VS_DATA_PACKET_HEADER           0xff
DECL|macro|VS_CONTROL_PACKET_HEADER
mdefine_line|#define VS_CONTROL_PACKET_HEADER        0xfe
DECL|macro|VS_QUERY_PACKET_HEADER
mdefine_line|#define VS_QUERY_PACKET_HEADER          0xfd
DECL|macro|VS_QUERY_RESPONSE_PACKET_HEADER
mdefine_line|#define VS_QUERY_RESPONSE_PACKET_HEADER 0xfc
multiline_comment|/* control verbs */
DECL|macro|VSV_SET_MODEM_CTL
mdefine_line|#define VSV_SET_MODEM_CTL    1 /* to service processor only */
DECL|macro|VSV_MODEM_CTL_UPDATE
mdefine_line|#define VSV_MODEM_CTL_UPDATE 2 /* from service processor only */
DECL|macro|VSV_CLOSE_PROTOCOL
mdefine_line|#define VSV_CLOSE_PROTOCOL   3
multiline_comment|/* query verbs */
DECL|macro|VSV_SEND_VERSION_NUMBER
mdefine_line|#define VSV_SEND_VERSION_NUMBER 1
DECL|macro|VSV_SEND_MODEM_CTL_STATUS
mdefine_line|#define VSV_SEND_MODEM_CTL_STATUS 2
multiline_comment|/* yes, these masks are not consecutive. */
DECL|macro|HVSI_TSDTR
mdefine_line|#define HVSI_TSDTR 0x01
DECL|macro|HVSI_TSCD
mdefine_line|#define HVSI_TSCD  0x20
DECL|struct|hvsi_header
r_struct
id|hvsi_header
(brace
DECL|member|type
r_uint8
id|type
suffix:semicolon
DECL|member|len
r_uint8
id|len
suffix:semicolon
DECL|member|seqno
r_uint16
id|seqno
suffix:semicolon
)brace
id|__attribute__
c_func
(paren
(paren
id|packed
)paren
)paren
suffix:semicolon
DECL|struct|hvsi_data
r_struct
id|hvsi_data
(brace
DECL|member|type
r_uint8
id|type
suffix:semicolon
DECL|member|len
r_uint8
id|len
suffix:semicolon
DECL|member|seqno
r_uint16
id|seqno
suffix:semicolon
DECL|member|data
r_uint8
id|data
(braket
id|HVSI_MAX_OUTGOING_DATA
)braket
suffix:semicolon
)brace
id|__attribute__
c_func
(paren
(paren
id|packed
)paren
)paren
suffix:semicolon
DECL|struct|hvsi_control
r_struct
id|hvsi_control
(brace
DECL|member|type
r_uint8
id|type
suffix:semicolon
DECL|member|len
r_uint8
id|len
suffix:semicolon
DECL|member|seqno
r_uint16
id|seqno
suffix:semicolon
DECL|member|verb
r_uint16
id|verb
suffix:semicolon
multiline_comment|/* optional depending on verb: */
DECL|member|word
r_uint32
id|word
suffix:semicolon
DECL|member|mask
r_uint32
id|mask
suffix:semicolon
)brace
id|__attribute__
c_func
(paren
(paren
id|packed
)paren
)paren
suffix:semicolon
DECL|struct|hvsi_query
r_struct
id|hvsi_query
(brace
DECL|member|type
r_uint8
id|type
suffix:semicolon
DECL|member|len
r_uint8
id|len
suffix:semicolon
DECL|member|seqno
r_uint16
id|seqno
suffix:semicolon
DECL|member|verb
r_uint16
id|verb
suffix:semicolon
)brace
id|__attribute__
c_func
(paren
(paren
id|packed
)paren
)paren
suffix:semicolon
DECL|struct|hvsi_query_response
r_struct
id|hvsi_query_response
(brace
DECL|member|type
r_uint8
id|type
suffix:semicolon
DECL|member|len
r_uint8
id|len
suffix:semicolon
DECL|member|seqno
r_uint16
id|seqno
suffix:semicolon
DECL|member|verb
r_uint16
id|verb
suffix:semicolon
DECL|member|query_seqno
r_uint16
id|query_seqno
suffix:semicolon
r_union
(brace
DECL|member|version
r_uint8
id|version
suffix:semicolon
DECL|member|mctrl_word
r_uint32
id|mctrl_word
suffix:semicolon
DECL|member|u
)brace
id|u
suffix:semicolon
)brace
id|__attribute__
c_func
(paren
(paren
id|packed
)paren
)paren
suffix:semicolon
DECL|function|is_console
r_static
r_inline
r_int
id|is_console
c_func
(paren
r_struct
id|hvsi_struct
op_star
id|hp
)paren
(brace
r_return
id|hp-&gt;flags
op_amp
id|HVSI_CONSOLE
suffix:semicolon
)brace
DECL|function|is_open
r_static
r_inline
r_int
id|is_open
c_func
(paren
r_struct
id|hvsi_struct
op_star
id|hp
)paren
(brace
multiline_comment|/* if we&squot;re waiting for an mctrl then we&squot;re already open */
r_return
(paren
id|hp-&gt;state
op_eq
id|HVSI_OPEN
)paren
op_logical_or
(paren
id|hp-&gt;state
op_eq
id|HVSI_WAIT_FOR_MCTRL_RESPONSE
)paren
suffix:semicolon
)brace
DECL|function|print_state
r_static
r_inline
r_void
id|print_state
c_func
(paren
r_struct
id|hvsi_struct
op_star
id|hp
)paren
(brace
macro_line|#ifdef DEBUG
r_static
r_const
r_char
op_star
id|state_names
(braket
)braket
op_assign
(brace
l_string|&quot;HVSI_CLOSED&quot;
comma
l_string|&quot;HVSI_WAIT_FOR_VER_RESPONSE&quot;
comma
l_string|&quot;HVSI_WAIT_FOR_VER_QUERY&quot;
comma
l_string|&quot;HVSI_OPEN&quot;
comma
l_string|&quot;HVSI_WAIT_FOR_MCTRL_RESPONSE&quot;
comma
l_string|&quot;HVSI_FSP_DIED&quot;
comma
)brace
suffix:semicolon
r_const
r_char
op_star
id|name
op_assign
id|state_names
(braket
id|hp-&gt;state
)braket
suffix:semicolon
r_if
c_cond
(paren
id|hp-&gt;state
OG
(paren
r_sizeof
(paren
id|state_names
)paren
op_div
r_sizeof
(paren
r_char
op_star
)paren
)paren
)paren
id|name
op_assign
l_string|&quot;UNKNOWN&quot;
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;hvsi%i: state = %s&bslash;n&quot;
comma
id|hp-&gt;index
comma
id|name
)paren
suffix:semicolon
macro_line|#endif /* DEBUG */
)brace
DECL|function|__set_state
r_static
r_inline
r_void
id|__set_state
c_func
(paren
r_struct
id|hvsi_struct
op_star
id|hp
comma
r_int
id|state
)paren
(brace
id|hp-&gt;state
op_assign
id|state
suffix:semicolon
id|print_state
c_func
(paren
id|hp
)paren
suffix:semicolon
id|wake_up_all
c_func
(paren
op_amp
id|hp-&gt;stateq
)paren
suffix:semicolon
)brace
DECL|function|set_state
r_static
r_inline
r_void
id|set_state
c_func
(paren
r_struct
id|hvsi_struct
op_star
id|hp
comma
r_int
id|state
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|hp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|__set_state
c_func
(paren
id|hp
comma
id|state
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|hp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|len_packet
r_static
r_inline
r_int
id|len_packet
c_func
(paren
r_const
r_uint8
op_star
id|packet
)paren
(brace
r_return
(paren
r_int
)paren
(paren
(paren
r_struct
id|hvsi_header
op_star
)paren
id|packet
)paren
op_member_access_from_pointer
id|len
suffix:semicolon
)brace
DECL|function|is_header
r_static
r_inline
r_int
id|is_header
c_func
(paren
r_const
r_uint8
op_star
id|packet
)paren
(brace
r_struct
id|hvsi_header
op_star
id|header
op_assign
(paren
r_struct
id|hvsi_header
op_star
)paren
id|packet
suffix:semicolon
r_return
id|header-&gt;type
op_ge
id|VS_QUERY_RESPONSE_PACKET_HEADER
suffix:semicolon
)brace
DECL|function|got_packet
r_static
r_inline
r_int
id|got_packet
c_func
(paren
r_const
r_struct
id|hvsi_struct
op_star
id|hp
comma
r_uint8
op_star
id|packet
)paren
(brace
r_if
c_cond
(paren
id|hp-&gt;inbuf_end
OL
id|packet
op_plus
r_sizeof
(paren
r_struct
id|hvsi_header
)paren
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* don&squot;t even have the packet header */
r_if
c_cond
(paren
id|hp-&gt;inbuf_end
OL
(paren
id|packet
op_plus
id|len_packet
c_func
(paren
id|packet
)paren
)paren
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* don&squot;t have the rest of the packet */
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* shift remaining bytes in packetbuf down */
DECL|function|compact_inbuf
r_static
r_void
id|compact_inbuf
c_func
(paren
r_struct
id|hvsi_struct
op_star
id|hp
comma
r_uint8
op_star
id|read_to
)paren
(brace
r_int
id|remaining
op_assign
(paren
r_int
)paren
(paren
id|hp-&gt;inbuf_end
op_minus
id|read_to
)paren
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;%s: %i chars remain&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|remaining
)paren
suffix:semicolon
r_if
c_cond
(paren
id|read_to
op_ne
id|hp-&gt;inbuf
)paren
id|memmove
c_func
(paren
id|hp-&gt;inbuf
comma
id|read_to
comma
id|remaining
)paren
suffix:semicolon
id|hp-&gt;inbuf_end
op_assign
id|hp-&gt;inbuf
op_plus
id|remaining
suffix:semicolon
)brace
macro_line|#ifdef DEBUG
DECL|macro|dbg_dump_packet
mdefine_line|#define dbg_dump_packet(packet) dump_packet(packet)
DECL|macro|dbg_dump_hex
mdefine_line|#define dbg_dump_hex(data, len) dump_hex(data, len)
macro_line|#else
DECL|macro|dbg_dump_packet
mdefine_line|#define dbg_dump_packet(packet) do { } while (0)
DECL|macro|dbg_dump_hex
mdefine_line|#define dbg_dump_hex(data, len) do { } while (0)
macro_line|#endif
DECL|function|dump_hex
r_static
r_void
id|dump_hex
c_func
(paren
r_const
r_uint8
op_star
id|data
comma
r_int
id|len
)paren
(brace
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;    &quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%.2x&quot;
comma
id|data
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n    &quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|isprint
c_func
(paren
id|data
(braket
id|i
)braket
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;%c&quot;
comma
id|data
(braket
id|i
)braket
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
l_string|&quot;.&quot;
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|dump_packet
r_static
r_void
id|dump_packet
c_func
(paren
r_uint8
op_star
id|packet
)paren
(brace
r_struct
id|hvsi_header
op_star
id|header
op_assign
(paren
r_struct
id|hvsi_header
op_star
)paren
id|packet
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;type 0x%x, len %i, seqno %i:&bslash;n&quot;
comma
id|header-&gt;type
comma
id|header-&gt;len
comma
id|header-&gt;seqno
)paren
suffix:semicolon
id|dump_hex
c_func
(paren
id|packet
comma
id|header-&gt;len
)paren
suffix:semicolon
)brace
multiline_comment|/* can&squot;t use hvc_get_chars because that strips CRs */
DECL|function|hvsi_read
r_static
r_int
id|hvsi_read
c_func
(paren
r_struct
id|hvsi_struct
op_star
id|hp
comma
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_int
r_int
id|got
suffix:semicolon
r_if
c_cond
(paren
id|plpar_hcall
c_func
(paren
id|H_GET_TERM_CHAR
comma
id|hp-&gt;vtermno
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
op_amp
id|got
comma
(paren
r_int
r_int
op_star
)paren
id|buf
comma
(paren
r_int
r_int
op_star
)paren
id|buf
op_plus
l_int|1
)paren
op_eq
id|H_Success
)paren
r_return
id|got
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|hvsi_recv_control
r_static
r_void
id|hvsi_recv_control
c_func
(paren
r_struct
id|hvsi_struct
op_star
id|hp
comma
r_uint8
op_star
id|packet
comma
r_struct
id|tty_struct
op_star
op_star
id|to_hangup
comma
r_struct
id|hvsi_struct
op_star
op_star
id|to_handshake
)paren
(brace
r_struct
id|hvsi_control
op_star
id|header
op_assign
(paren
r_struct
id|hvsi_control
op_star
)paren
id|packet
suffix:semicolon
r_switch
c_cond
(paren
id|header-&gt;verb
)paren
(brace
r_case
id|VSV_MODEM_CTL_UPDATE
suffix:colon
r_if
c_cond
(paren
(paren
id|header-&gt;word
op_amp
id|HVSI_TSCD
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* CD went away; no more connection */
id|pr_debug
c_func
(paren
l_string|&quot;hvsi%i: CD dropped&bslash;n&quot;
comma
id|hp-&gt;index
)paren
suffix:semicolon
id|hp-&gt;mctrl
op_and_assign
id|TIOCM_CD
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|hp-&gt;tty-&gt;flags
op_amp
id|CLOCAL
)paren
)paren
op_star
id|to_hangup
op_assign
id|hp-&gt;tty
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|VSV_CLOSE_PROTOCOL
suffix:colon
id|pr_debug
c_func
(paren
l_string|&quot;hvsi%i: service processor came back&bslash;n&quot;
comma
id|hp-&gt;index
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hp-&gt;state
op_ne
id|HVSI_CLOSED
)paren
(brace
op_star
id|to_handshake
op_assign
id|hp
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;hvsi%i: unknown HVSI control packet: &quot;
comma
id|hp-&gt;index
)paren
suffix:semicolon
id|dump_packet
c_func
(paren
id|packet
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
DECL|function|hvsi_recv_response
r_static
r_void
id|hvsi_recv_response
c_func
(paren
r_struct
id|hvsi_struct
op_star
id|hp
comma
r_uint8
op_star
id|packet
)paren
(brace
r_struct
id|hvsi_query_response
op_star
id|resp
op_assign
(paren
r_struct
id|hvsi_query_response
op_star
)paren
id|packet
suffix:semicolon
r_switch
c_cond
(paren
id|hp-&gt;state
)paren
(brace
r_case
id|HVSI_WAIT_FOR_VER_RESPONSE
suffix:colon
id|__set_state
c_func
(paren
id|hp
comma
id|HVSI_WAIT_FOR_VER_QUERY
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HVSI_WAIT_FOR_MCTRL_RESPONSE
suffix:colon
id|hp-&gt;mctrl
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|resp-&gt;u.mctrl_word
op_amp
id|HVSI_TSDTR
)paren
id|hp-&gt;mctrl
op_or_assign
id|TIOCM_DTR
suffix:semicolon
r_if
c_cond
(paren
id|resp-&gt;u.mctrl_word
op_amp
id|HVSI_TSCD
)paren
id|hp-&gt;mctrl
op_or_assign
id|TIOCM_CD
suffix:semicolon
id|__set_state
c_func
(paren
id|hp
comma
id|HVSI_OPEN
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;hvsi%i: unexpected query response: &quot;
comma
id|hp-&gt;index
)paren
suffix:semicolon
id|dump_packet
c_func
(paren
id|packet
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* respond to service processor&squot;s version query */
DECL|function|hvsi_version_respond
r_static
r_int
id|hvsi_version_respond
c_func
(paren
r_struct
id|hvsi_struct
op_star
id|hp
comma
r_uint16
id|query_seqno
)paren
(brace
r_struct
id|hvsi_query_response
id|packet
id|__ALIGNED__
suffix:semicolon
r_int
id|wrote
suffix:semicolon
id|packet.type
op_assign
id|VS_QUERY_RESPONSE_PACKET_HEADER
suffix:semicolon
id|packet.len
op_assign
r_sizeof
(paren
r_struct
id|hvsi_query_response
)paren
suffix:semicolon
id|packet.seqno
op_assign
id|atomic_inc_return
c_func
(paren
op_amp
id|hp-&gt;seqno
)paren
suffix:semicolon
id|packet.verb
op_assign
id|VSV_SEND_VERSION_NUMBER
suffix:semicolon
id|packet.u.version
op_assign
id|HVSI_VERSION
suffix:semicolon
id|packet.query_seqno
op_assign
id|query_seqno
op_plus
l_int|1
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;%s: sending %i bytes&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|packet.len
)paren
suffix:semicolon
id|dbg_dump_hex
c_func
(paren
(paren
r_uint8
op_star
)paren
op_amp
id|packet
comma
id|packet.len
)paren
suffix:semicolon
id|wrote
op_assign
id|hvc_put_chars
c_func
(paren
id|hp-&gt;vtermno
comma
(paren
r_char
op_star
)paren
op_amp
id|packet
comma
id|packet.len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|wrote
op_ne
id|packet.len
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;hvsi%i: couldn&squot;t send query response!&bslash;n&quot;
comma
id|hp-&gt;index
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|hvsi_recv_query
r_static
r_void
id|hvsi_recv_query
c_func
(paren
r_struct
id|hvsi_struct
op_star
id|hp
comma
r_uint8
op_star
id|packet
)paren
(brace
r_struct
id|hvsi_query
op_star
id|query
op_assign
(paren
r_struct
id|hvsi_query
op_star
)paren
id|packet
suffix:semicolon
r_switch
c_cond
(paren
id|hp-&gt;state
)paren
(brace
r_case
id|HVSI_WAIT_FOR_VER_QUERY
suffix:colon
id|hvsi_version_respond
c_func
(paren
id|hp
comma
id|query-&gt;seqno
)paren
suffix:semicolon
id|__set_state
c_func
(paren
id|hp
comma
id|HVSI_OPEN
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;hvsi%i: unexpected query: &quot;
comma
id|hp-&gt;index
)paren
suffix:semicolon
id|dump_packet
c_func
(paren
id|packet
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
DECL|function|hvsi_insert_chars
r_static
r_void
id|hvsi_insert_chars
c_func
(paren
r_struct
id|hvsi_struct
op_star
id|hp
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|len
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
id|i
op_increment
)paren
(brace
r_char
id|c
op_assign
id|buf
(braket
id|i
)braket
suffix:semicolon
macro_line|#ifdef CONFIG_MAGIC_SYSRQ
r_if
c_cond
(paren
id|c
op_eq
l_char|&squot;&bslash;0&squot;
)paren
(brace
id|hp-&gt;sysrq
op_assign
l_int|1
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|hp-&gt;sysrq
)paren
(brace
id|handle_sysrq
c_func
(paren
id|c
comma
l_int|NULL
comma
id|hp-&gt;tty
)paren
suffix:semicolon
id|hp-&gt;sysrq
op_assign
l_int|0
suffix:semicolon
r_continue
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_MAGIC_SYSRQ */
id|tty_insert_flip_char
c_func
(paren
id|hp-&gt;tty
comma
id|c
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * We could get 252 bytes of data at once here. But the tty layer only&n; * throttles us at TTY_THRESHOLD_THROTTLE (128) bytes, so we could overflow&n; * it. Accordingly we won&squot;t send more than 128 bytes at a time to the flip&n; * buffer, which will give the tty buffer a chance to throttle us. Should the&n; * value of TTY_THRESHOLD_THROTTLE change in n_tty.c, this code should be&n; * revisited.&n; */
DECL|macro|TTY_THRESHOLD_THROTTLE
mdefine_line|#define TTY_THRESHOLD_THROTTLE 128
DECL|function|hvsi_recv_data
r_static
r_struct
id|tty_struct
op_star
id|hvsi_recv_data
c_func
(paren
r_struct
id|hvsi_struct
op_star
id|hp
comma
r_const
r_uint8
op_star
id|packet
)paren
(brace
r_const
r_struct
id|hvsi_header
op_star
id|header
op_assign
(paren
r_const
r_struct
id|hvsi_header
op_star
)paren
id|packet
suffix:semicolon
r_const
r_uint8
op_star
id|data
op_assign
id|packet
op_plus
r_sizeof
(paren
r_struct
id|hvsi_header
)paren
suffix:semicolon
r_int
id|datalen
op_assign
id|header-&gt;len
op_minus
r_sizeof
(paren
r_struct
id|hvsi_header
)paren
suffix:semicolon
r_int
id|overflow
op_assign
id|datalen
op_minus
id|TTY_THRESHOLD_THROTTLE
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;queueing %i chars &squot;%.*s&squot;&bslash;n&quot;
comma
id|datalen
comma
id|datalen
comma
id|data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|datalen
op_eq
l_int|0
)paren
r_return
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|overflow
OG
l_int|0
)paren
(brace
id|pr_debug
c_func
(paren
l_string|&quot;%s: got &gt;TTY_THRESHOLD_THROTTLE bytes&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|datalen
op_assign
id|TTY_THRESHOLD_THROTTLE
suffix:semicolon
)brace
id|hvsi_insert_chars
c_func
(paren
id|hp
comma
id|data
comma
id|datalen
)paren
suffix:semicolon
r_if
c_cond
(paren
id|overflow
OG
l_int|0
)paren
(brace
multiline_comment|/*&n;&t;&t; * we still have more data to deliver, so we need to save off the&n;&t;&t; * overflow and send it later&n;&t;&t; */
id|pr_debug
c_func
(paren
l_string|&quot;%s: deferring overflow&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|hp-&gt;throttle_buf
comma
id|data
op_plus
id|TTY_THRESHOLD_THROTTLE
comma
id|overflow
)paren
suffix:semicolon
id|hp-&gt;n_throttle
op_assign
id|overflow
suffix:semicolon
)brace
r_return
id|hp-&gt;tty
suffix:semicolon
)brace
multiline_comment|/*&n; * Returns true/false indicating data successfully read from hypervisor.&n; * Used both to get packets for tty connections and to advance the state&n; * machine during console handshaking (in which case tty = NULL and we ignore&n; * incoming data).&n; */
DECL|function|hvsi_load_chunk
r_static
r_int
id|hvsi_load_chunk
c_func
(paren
r_struct
id|hvsi_struct
op_star
id|hp
comma
r_struct
id|tty_struct
op_star
op_star
id|flip
comma
r_struct
id|tty_struct
op_star
op_star
id|hangup
comma
r_struct
id|hvsi_struct
op_star
op_star
id|handshake
)paren
(brace
r_uint8
op_star
id|packet
op_assign
id|hp-&gt;inbuf
suffix:semicolon
r_int
id|chunklen
suffix:semicolon
op_star
id|flip
op_assign
l_int|NULL
suffix:semicolon
op_star
id|hangup
op_assign
l_int|NULL
suffix:semicolon
op_star
id|handshake
op_assign
l_int|NULL
suffix:semicolon
id|chunklen
op_assign
id|hvsi_read
c_func
(paren
id|hp
comma
id|hp-&gt;inbuf_end
comma
id|HVSI_MAX_READ
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chunklen
op_eq
l_int|0
)paren
(brace
id|pr_debug
c_func
(paren
l_string|&quot;%s: 0-length read&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|pr_debug
c_func
(paren
l_string|&quot;%s: got %i bytes&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|chunklen
)paren
suffix:semicolon
id|dbg_dump_hex
c_func
(paren
id|hp-&gt;inbuf_end
comma
id|chunklen
)paren
suffix:semicolon
id|hp-&gt;inbuf_end
op_add_assign
id|chunklen
suffix:semicolon
multiline_comment|/* handle all completed packets */
r_while
c_loop
(paren
(paren
id|packet
OL
id|hp-&gt;inbuf_end
)paren
op_logical_and
id|got_packet
c_func
(paren
id|hp
comma
id|packet
)paren
)paren
(brace
r_struct
id|hvsi_header
op_star
id|header
op_assign
(paren
r_struct
id|hvsi_header
op_star
)paren
id|packet
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|is_header
c_func
(paren
id|packet
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;hvsi%i: got malformed packet&bslash;n&quot;
comma
id|hp-&gt;index
)paren
suffix:semicolon
multiline_comment|/* skip bytes until we find a header or run out of data */
r_while
c_loop
(paren
(paren
id|packet
OL
id|hp-&gt;inbuf_end
)paren
op_logical_and
(paren
op_logical_neg
id|is_header
c_func
(paren
id|packet
)paren
)paren
)paren
id|packet
op_increment
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|pr_debug
c_func
(paren
l_string|&quot;%s: handling %i-byte packet&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|len_packet
c_func
(paren
id|packet
)paren
)paren
suffix:semicolon
id|dbg_dump_packet
c_func
(paren
id|packet
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|header-&gt;type
)paren
(brace
r_case
id|VS_DATA_PACKET_HEADER
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|is_open
c_func
(paren
id|hp
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|hp-&gt;tty
op_eq
l_int|NULL
)paren
r_break
suffix:semicolon
multiline_comment|/* no tty buffer to put data in */
op_star
id|flip
op_assign
id|hvsi_recv_data
c_func
(paren
id|hp
comma
id|packet
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VS_CONTROL_PACKET_HEADER
suffix:colon
id|hvsi_recv_control
c_func
(paren
id|hp
comma
id|packet
comma
id|hangup
comma
id|handshake
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VS_QUERY_RESPONSE_PACKET_HEADER
suffix:colon
id|hvsi_recv_response
c_func
(paren
id|hp
comma
id|packet
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|VS_QUERY_PACKET_HEADER
suffix:colon
id|hvsi_recv_query
c_func
(paren
id|hp
comma
id|packet
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;hvsi%i: unknown HVSI packet type 0x%x&bslash;n&quot;
comma
id|hp-&gt;index
comma
id|header-&gt;type
)paren
suffix:semicolon
id|dump_packet
c_func
(paren
id|packet
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|packet
op_add_assign
id|len_packet
c_func
(paren
id|packet
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|hangup
op_logical_or
op_star
id|handshake
)paren
(brace
id|pr_debug
c_func
(paren
l_string|&quot;%s: hangup or handshake&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * we need to send the hangup now before receiving any more data.&n;&t;&t;&t; * If we get &quot;data, hangup, data&quot;, we can&squot;t deliver the second&n;&t;&t;&t; * data before the hangup.&n;&t;&t;&t; */
r_break
suffix:semicolon
)brace
)brace
id|compact_inbuf
c_func
(paren
id|hp
comma
id|packet
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|hvsi_send_overflow
r_static
r_void
id|hvsi_send_overflow
c_func
(paren
r_struct
id|hvsi_struct
op_star
id|hp
)paren
(brace
id|pr_debug
c_func
(paren
l_string|&quot;%s: delivering %i bytes overflow&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|hp-&gt;n_throttle
)paren
suffix:semicolon
id|hvsi_insert_chars
c_func
(paren
id|hp
comma
id|hp-&gt;throttle_buf
comma
id|hp-&gt;n_throttle
)paren
suffix:semicolon
id|hp-&gt;n_throttle
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * must get all pending data because we only get an irq on empty-&gt;non-empty&n; * transition&n; */
DECL|function|hvsi_interrupt
r_static
id|irqreturn_t
id|hvsi_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|arg
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|hvsi_struct
op_star
id|hp
op_assign
(paren
r_struct
id|hvsi_struct
op_star
)paren
id|arg
suffix:semicolon
r_struct
id|tty_struct
op_star
id|flip
suffix:semicolon
r_struct
id|tty_struct
op_star
id|hangup
suffix:semicolon
r_struct
id|hvsi_struct
op_star
id|handshake
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|again
op_assign
l_int|1
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_while
c_loop
(paren
id|again
)paren
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|hp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|again
op_assign
id|hvsi_load_chunk
c_func
(paren
id|hp
comma
op_amp
id|flip
comma
op_amp
id|hangup
comma
op_amp
id|handshake
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|hp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * we have to call tty_flip_buffer_push() and tty_hangup() outside our&n;&t;&t; * spinlock. But we also have to keep going until we&squot;ve read all the&n;&t;&t; * available data.&n;&t;&t; */
r_if
c_cond
(paren
id|flip
)paren
(brace
multiline_comment|/* there was data put in the tty flip buffer */
id|tty_flip_buffer_push
c_func
(paren
id|flip
)paren
suffix:semicolon
id|flip
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hangup
)paren
(brace
id|tty_hangup
c_func
(paren
id|hangup
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|handshake
)paren
(brace
id|pr_debug
c_func
(paren
l_string|&quot;hvsi%i: attempting re-handshake&bslash;n&quot;
comma
id|handshake-&gt;index
)paren
suffix:semicolon
id|schedule_work
c_func
(paren
op_amp
id|handshake-&gt;handshaker
)paren
suffix:semicolon
)brace
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|hp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hp-&gt;tty
op_logical_and
id|hp-&gt;n_throttle
op_logical_and
(paren
op_logical_neg
id|test_bit
c_func
(paren
id|TTY_THROTTLED
comma
op_amp
id|hp-&gt;tty-&gt;flags
)paren
)paren
)paren
(brace
multiline_comment|/* we weren&squot;t hung up and we weren&squot;t throttled, so we can deliver the&n;&t;&t; * rest now */
id|flip
op_assign
id|hp-&gt;tty
suffix:semicolon
id|hvsi_send_overflow
c_func
(paren
id|hp
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|hp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|flip
)paren
(brace
id|tty_flip_buffer_push
c_func
(paren
id|flip
)paren
suffix:semicolon
)brace
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
multiline_comment|/* for boot console, before the irq handler is running */
DECL|function|poll_for_state
r_static
r_int
id|__init
id|poll_for_state
c_func
(paren
r_struct
id|hvsi_struct
op_star
id|hp
comma
r_int
id|state
)paren
(brace
r_int
r_int
id|end_jiffies
op_assign
id|jiffies
op_plus
id|HVSI_TIMEOUT
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|hvsi_interrupt
c_func
(paren
id|hp-&gt;virq
comma
(paren
r_void
op_star
)paren
id|hp
comma
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/* get pending data */
r_if
c_cond
(paren
id|hp-&gt;state
op_eq
id|state
)paren
r_return
l_int|0
suffix:semicolon
id|mdelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
r_if
c_cond
(paren
id|time_after
c_func
(paren
id|jiffies
comma
id|end_jiffies
)paren
)paren
r_return
op_minus
id|EIO
suffix:semicolon
)brace
)brace
multiline_comment|/* wait for irq handler to change our state */
DECL|function|wait_for_state
r_static
r_int
id|wait_for_state
c_func
(paren
r_struct
id|hvsi_struct
op_star
id|hp
comma
r_int
id|state
)paren
(brace
r_int
r_int
id|end_jiffies
op_assign
id|jiffies
op_plus
id|HVSI_TIMEOUT
suffix:semicolon
r_int
r_int
id|timeout
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
id|DECLARE_WAITQUEUE
c_func
(paren
id|myself
comma
id|current
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|add_wait_queue
c_func
(paren
op_amp
id|hp-&gt;stateq
comma
op_amp
id|myself
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hp-&gt;state
op_eq
id|state
)paren
r_break
suffix:semicolon
id|timeout
op_assign
id|end_jiffies
op_minus
id|jiffies
suffix:semicolon
r_if
c_cond
(paren
id|time_after
c_func
(paren
id|jiffies
comma
id|end_jiffies
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|EIO
suffix:semicolon
r_break
suffix:semicolon
)brace
id|schedule_timeout
c_func
(paren
id|timeout
)paren
suffix:semicolon
)brace
id|remove_wait_queue
c_func
(paren
op_amp
id|hp-&gt;stateq
comma
op_amp
id|myself
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_RUNNING
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|hvsi_query
r_static
r_int
id|hvsi_query
c_func
(paren
r_struct
id|hvsi_struct
op_star
id|hp
comma
r_uint16
id|verb
)paren
(brace
r_struct
id|hvsi_query
id|packet
id|__ALIGNED__
suffix:semicolon
r_int
id|wrote
suffix:semicolon
id|packet.type
op_assign
id|VS_QUERY_PACKET_HEADER
suffix:semicolon
id|packet.len
op_assign
r_sizeof
(paren
r_struct
id|hvsi_query
)paren
suffix:semicolon
id|packet.seqno
op_assign
id|atomic_inc_return
c_func
(paren
op_amp
id|hp-&gt;seqno
)paren
suffix:semicolon
id|packet.verb
op_assign
id|verb
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;%s: sending %i bytes&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|packet.len
)paren
suffix:semicolon
id|dbg_dump_hex
c_func
(paren
(paren
r_uint8
op_star
)paren
op_amp
id|packet
comma
id|packet.len
)paren
suffix:semicolon
id|wrote
op_assign
id|hvc_put_chars
c_func
(paren
id|hp-&gt;vtermno
comma
(paren
r_char
op_star
)paren
op_amp
id|packet
comma
id|packet.len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|wrote
op_ne
id|packet.len
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;hvsi%i: couldn&squot;t send query (%i)!&bslash;n&quot;
comma
id|hp-&gt;index
comma
id|wrote
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|hvsi_get_mctrl
r_static
r_int
id|hvsi_get_mctrl
c_func
(paren
r_struct
id|hvsi_struct
op_star
id|hp
)paren
(brace
r_int
id|ret
suffix:semicolon
id|set_state
c_func
(paren
id|hp
comma
id|HVSI_WAIT_FOR_MCTRL_RESPONSE
)paren
suffix:semicolon
id|hvsi_query
c_func
(paren
id|hp
comma
id|VSV_SEND_MODEM_CTL_STATUS
)paren
suffix:semicolon
id|ret
op_assign
id|hvsi_wait
c_func
(paren
id|hp
comma
id|HVSI_OPEN
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;hvsi%i: didn&squot;t get modem flags&bslash;n&quot;
comma
id|hp-&gt;index
)paren
suffix:semicolon
id|set_state
c_func
(paren
id|hp
comma
id|HVSI_OPEN
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
id|pr_debug
c_func
(paren
l_string|&quot;%s: mctrl 0x%x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|hp-&gt;mctrl
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* note that we can only set DTR */
DECL|function|hvsi_set_mctrl
r_static
r_int
id|hvsi_set_mctrl
c_func
(paren
r_struct
id|hvsi_struct
op_star
id|hp
comma
r_uint16
id|mctrl
)paren
(brace
r_struct
id|hvsi_control
id|packet
id|__ALIGNED__
suffix:semicolon
r_int
id|wrote
suffix:semicolon
id|packet.type
op_assign
id|VS_CONTROL_PACKET_HEADER
comma
id|packet.seqno
op_assign
id|atomic_inc_return
c_func
(paren
op_amp
id|hp-&gt;seqno
)paren
suffix:semicolon
id|packet.len
op_assign
r_sizeof
(paren
r_struct
id|hvsi_control
)paren
suffix:semicolon
id|packet.verb
op_assign
id|VSV_SET_MODEM_CTL
suffix:semicolon
id|packet.mask
op_assign
id|HVSI_TSDTR
suffix:semicolon
r_if
c_cond
(paren
id|mctrl
op_amp
id|TIOCM_DTR
)paren
id|packet.word
op_assign
id|HVSI_TSDTR
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;%s: sending %i bytes&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|packet.len
)paren
suffix:semicolon
id|dbg_dump_hex
c_func
(paren
(paren
r_uint8
op_star
)paren
op_amp
id|packet
comma
id|packet.len
)paren
suffix:semicolon
id|wrote
op_assign
id|hvc_put_chars
c_func
(paren
id|hp-&gt;vtermno
comma
(paren
r_char
op_star
)paren
op_amp
id|packet
comma
id|packet.len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|wrote
op_ne
id|packet.len
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;hvsi%i: couldn&squot;t set DTR!&bslash;n&quot;
comma
id|hp-&gt;index
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|hvsi_drain_input
r_static
r_void
id|hvsi_drain_input
c_func
(paren
r_struct
id|hvsi_struct
op_star
id|hp
)paren
(brace
r_uint8
id|buf
(braket
id|HVSI_MAX_READ
)braket
id|__ALIGNED__
suffix:semicolon
r_int
r_int
id|end_jiffies
op_assign
id|jiffies
op_plus
id|HVSI_TIMEOUT
suffix:semicolon
r_while
c_loop
(paren
id|time_before
c_func
(paren
id|end_jiffies
comma
id|jiffies
)paren
)paren
r_if
c_cond
(paren
l_int|0
op_eq
id|hvsi_read
c_func
(paren
id|hp
comma
id|buf
comma
id|HVSI_MAX_READ
)paren
)paren
r_break
suffix:semicolon
)brace
DECL|function|hvsi_handshake
r_static
r_int
id|hvsi_handshake
c_func
(paren
r_struct
id|hvsi_struct
op_star
id|hp
)paren
(brace
r_int
id|ret
suffix:semicolon
multiline_comment|/*&n;&t; * We could have a CLOSE or other data waiting for us before we even try&n;&t; * to open; try to throw it all away so we don&squot;t get confused. (CLOSE&n;&t; * is the first message sent up the pipe when the FSP comes online. We&n;&t; * need to distinguish between &quot;it came up a while ago and we&squot;re the first&n;&t; * user&quot; and &quot;it was just reset before it saw our handshake packet&quot;.)&n;&t; */
id|hvsi_drain_input
c_func
(paren
id|hp
)paren
suffix:semicolon
id|set_state
c_func
(paren
id|hp
comma
id|HVSI_WAIT_FOR_VER_RESPONSE
)paren
suffix:semicolon
id|ret
op_assign
id|hvsi_query
c_func
(paren
id|hp
comma
id|VSV_SEND_VERSION_NUMBER
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;hvsi%i: couldn&squot;t send version query&bslash;n&quot;
comma
id|hp-&gt;index
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
id|ret
op_assign
id|hvsi_wait
c_func
(paren
id|hp
comma
id|HVSI_OPEN
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
r_return
id|ret
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|hvsi_handshaker
r_static
r_void
id|hvsi_handshaker
c_func
(paren
r_void
op_star
id|arg
)paren
(brace
r_struct
id|hvsi_struct
op_star
id|hp
op_assign
(paren
r_struct
id|hvsi_struct
op_star
)paren
id|arg
suffix:semicolon
r_if
c_cond
(paren
id|hvsi_handshake
c_func
(paren
id|hp
)paren
op_ge
l_int|0
)paren
r_return
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;hvsi%i: re-handshaking failed&bslash;n&quot;
comma
id|hp-&gt;index
)paren
suffix:semicolon
r_if
c_cond
(paren
id|is_console
c_func
(paren
id|hp
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t; * ttys will re-attempt the handshake via hvsi_open, but&n;&t;&t; * the console will not.&n;&t;&t; */
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;hvsi%i: lost console!&bslash;n&quot;
comma
id|hp-&gt;index
)paren
suffix:semicolon
)brace
)brace
DECL|function|hvsi_put_chars
r_static
r_int
id|hvsi_put_chars
c_func
(paren
r_struct
id|hvsi_struct
op_star
id|hp
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_struct
id|hvsi_data
id|packet
id|__ALIGNED__
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|BUG_ON
c_func
(paren
id|count
OG
id|HVSI_MAX_OUTGOING_DATA
)paren
suffix:semicolon
id|packet.type
op_assign
id|VS_DATA_PACKET_HEADER
suffix:semicolon
id|packet.seqno
op_assign
id|atomic_inc_return
c_func
(paren
op_amp
id|hp-&gt;seqno
)paren
suffix:semicolon
id|packet.len
op_assign
id|count
op_plus
r_sizeof
(paren
r_struct
id|hvsi_header
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|packet.data
comma
id|buf
comma
id|count
)paren
suffix:semicolon
id|ret
op_assign
id|hvc_put_chars
c_func
(paren
id|hp-&gt;vtermno
comma
(paren
r_char
op_star
)paren
op_amp
id|packet
comma
id|packet.len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
id|packet.len
)paren
(brace
multiline_comment|/* return the number of chars written, not the packet length */
r_return
id|count
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
multiline_comment|/* return any errors */
)brace
DECL|function|hvsi_close_protocol
r_static
r_void
id|hvsi_close_protocol
c_func
(paren
r_struct
id|hvsi_struct
op_star
id|hp
)paren
(brace
r_struct
id|hvsi_control
id|packet
id|__ALIGNED__
suffix:semicolon
id|packet.type
op_assign
id|VS_CONTROL_PACKET_HEADER
suffix:semicolon
id|packet.seqno
op_assign
id|atomic_inc_return
c_func
(paren
op_amp
id|hp-&gt;seqno
)paren
suffix:semicolon
id|packet.len
op_assign
l_int|6
suffix:semicolon
id|packet.verb
op_assign
id|VSV_CLOSE_PROTOCOL
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;%s: sending %i bytes&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|packet.len
)paren
suffix:semicolon
id|dbg_dump_hex
c_func
(paren
(paren
r_uint8
op_star
)paren
op_amp
id|packet
comma
id|packet.len
)paren
suffix:semicolon
id|hvc_put_chars
c_func
(paren
id|hp-&gt;vtermno
comma
(paren
r_char
op_star
)paren
op_amp
id|packet
comma
id|packet.len
)paren
suffix:semicolon
)brace
DECL|function|hvsi_open
r_static
r_int
id|hvsi_open
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_struct
id|hvsi_struct
op_star
id|hp
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|line
op_assign
id|tty-&gt;index
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_if
c_cond
(paren
id|line
OL
l_int|0
op_logical_or
id|line
op_ge
id|hvsi_count
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|hp
op_assign
op_amp
id|hvsi_ports
(braket
id|line
)braket
suffix:semicolon
id|tty-&gt;driver_data
op_assign
id|hp
suffix:semicolon
id|tty-&gt;low_latency
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* avoid throttle/tty_flip_buffer_push race */
id|mb
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hp-&gt;state
op_eq
id|HVSI_FSP_DIED
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|hp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|hp-&gt;tty
op_assign
id|tty
suffix:semicolon
id|hp-&gt;count
op_increment
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|hp-&gt;seqno
comma
l_int|0
)paren
suffix:semicolon
id|h_vio_signal
c_func
(paren
id|hp-&gt;vtermno
comma
id|VIO_IRQ_ENABLE
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|hp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|is_console
c_func
(paren
id|hp
)paren
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* this has already been handshaked as the console */
id|ret
op_assign
id|hvsi_handshake
c_func
(paren
id|hp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: HVSI handshaking failed&bslash;n&quot;
comma
id|tty-&gt;name
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
id|ret
op_assign
id|hvsi_get_mctrl
c_func
(paren
id|hp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: couldn&squot;t get initial modem flags&bslash;n&quot;
comma
id|tty-&gt;name
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
id|ret
op_assign
id|hvsi_set_mctrl
c_func
(paren
id|hp
comma
id|hp-&gt;mctrl
op_or
id|TIOCM_DTR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: couldn&squot;t set DTR&bslash;n&quot;
comma
id|tty-&gt;name
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* wait for hvsi_write_worker to empty hp-&gt;outbuf */
DECL|function|hvsi_flush_output
r_static
r_void
id|hvsi_flush_output
c_func
(paren
r_struct
id|hvsi_struct
op_star
id|hp
)paren
(brace
r_int
r_int
id|end_jiffies
op_assign
id|jiffies
op_plus
id|HVSI_TIMEOUT
suffix:semicolon
r_int
r_int
id|timeout
suffix:semicolon
id|DECLARE_WAITQUEUE
c_func
(paren
id|myself
comma
id|current
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|add_wait_queue
c_func
(paren
op_amp
id|hp-&gt;emptyq
comma
op_amp
id|myself
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hp-&gt;n_outbuf
op_le
l_int|0
)paren
r_break
suffix:semicolon
id|timeout
op_assign
id|end_jiffies
op_minus
id|jiffies
suffix:semicolon
r_if
c_cond
(paren
id|time_after
c_func
(paren
id|jiffies
comma
id|end_jiffies
)paren
)paren
r_break
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|timeout
)paren
suffix:semicolon
)brace
id|remove_wait_queue
c_func
(paren
op_amp
id|hp-&gt;emptyq
comma
op_amp
id|myself
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_RUNNING
)paren
suffix:semicolon
multiline_comment|/* &squot;writer&squot; could still be pending if it didn&squot;t see n_outbuf = 0 yet */
id|cancel_delayed_work
c_func
(paren
op_amp
id|hp-&gt;writer
)paren
suffix:semicolon
id|flush_scheduled_work
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * it&squot;s also possible that our timeout expired and hvsi_write_worker&n;&t; * didn&squot;t manage to push outbuf. poof.&n;&t; */
id|hp-&gt;n_outbuf
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|hvsi_close
r_static
r_void
id|hvsi_close
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_struct
id|hvsi_struct
op_star
id|hp
op_assign
id|tty-&gt;driver_data
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tty_hung_up_p
c_func
(paren
id|filp
)paren
)paren
r_return
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|hp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|hp-&gt;count
op_eq
l_int|0
)paren
(brace
id|hp-&gt;tty
op_assign
l_int|NULL
suffix:semicolon
id|hp-&gt;inbuf_end
op_assign
id|hp-&gt;inbuf
suffix:semicolon
multiline_comment|/* discard remaining partial packets */
multiline_comment|/* only close down connection if it is not the console */
r_if
c_cond
(paren
op_logical_neg
id|is_console
c_func
(paren
id|hp
)paren
)paren
(brace
id|h_vio_signal
c_func
(paren
id|hp-&gt;vtermno
comma
id|VIO_IRQ_DISABLE
)paren
suffix:semicolon
multiline_comment|/* no more irqs */
id|__set_state
c_func
(paren
id|hp
comma
id|HVSI_CLOSED
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * any data delivered to the tty layer after this will be&n;&t;&t;&t; * discarded (except for XON/XOFF)&n;&t;&t;&t; */
id|tty-&gt;closing
op_assign
l_int|1
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|hp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* let any existing irq handlers finish. no more will start. */
id|synchronize_irq
c_func
(paren
id|hp-&gt;virq
)paren
suffix:semicolon
multiline_comment|/* hvsi_write_worker will re-schedule until outbuf is empty. */
id|hvsi_flush_output
c_func
(paren
id|hp
)paren
suffix:semicolon
multiline_comment|/* tell FSP to stop sending data */
id|hvsi_close_protocol
c_func
(paren
id|hp
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * drain anything FSP is still in the middle of sending, and let&n;&t;&t;&t; * hvsi_handshake drain the rest on the next open.&n;&t;&t;&t; */
id|hvsi_drain_input
c_func
(paren
id|hp
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|hp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|hp-&gt;count
OL
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;hvsi_close %lu: oops, count is %d&bslash;n&quot;
comma
id|hp
op_minus
id|hvsi_ports
comma
id|hp-&gt;count
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|hp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|hvsi_hangup
r_static
r_void
id|hvsi_hangup
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_struct
id|hvsi_struct
op_star
id|hp
op_assign
id|tty-&gt;driver_data
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|hp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|hp-&gt;count
op_assign
l_int|0
suffix:semicolon
id|hp-&gt;n_outbuf
op_assign
l_int|0
suffix:semicolon
id|hp-&gt;tty
op_assign
l_int|NULL
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|hp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* called with hp-&gt;lock held */
DECL|function|hvsi_push
r_static
r_void
id|hvsi_push
c_func
(paren
r_struct
id|hvsi_struct
op_star
id|hp
)paren
(brace
r_int
id|n
suffix:semicolon
r_if
c_cond
(paren
id|hp-&gt;n_outbuf
op_le
l_int|0
)paren
r_return
suffix:semicolon
id|n
op_assign
id|hvsi_put_chars
c_func
(paren
id|hp
comma
id|hp-&gt;outbuf
comma
id|hp-&gt;n_outbuf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|n
OG
l_int|0
)paren
(brace
multiline_comment|/* success */
id|pr_debug
c_func
(paren
l_string|&quot;%s: wrote %i chars&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|n
)paren
suffix:semicolon
id|hp-&gt;n_outbuf
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|n
op_eq
op_minus
id|EIO
)paren
(brace
id|__set_state
c_func
(paren
id|hp
comma
id|HVSI_FSP_DIED
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;hvsi%i: service processor died&bslash;n&quot;
comma
id|hp-&gt;index
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* hvsi_write_worker will keep rescheduling itself until outbuf is empty */
DECL|function|hvsi_write_worker
r_static
r_void
id|hvsi_write_worker
c_func
(paren
r_void
op_star
id|arg
)paren
(brace
r_struct
id|hvsi_struct
op_star
id|hp
op_assign
(paren
r_struct
id|hvsi_struct
op_star
)paren
id|arg
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
macro_line|#ifdef DEBUG
r_static
r_int
id|start_j
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|start_j
op_eq
l_int|0
)paren
id|start_j
op_assign
id|jiffies
suffix:semicolon
macro_line|#endif /* DEBUG */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|hp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;%s: %i chars in buffer&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|hp-&gt;n_outbuf
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|is_open
c_func
(paren
id|hp
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t; * We could have a non-open connection if the service processor died&n;&t;&t; * while we were busily scheduling ourselves. In that case, it could&n;&t;&t; * be minutes before the service processor comes back, so only try&n;&t;&t; * again once a second.&n;&t;&t; */
id|schedule_delayed_work
c_func
(paren
op_amp
id|hp-&gt;writer
comma
id|HZ
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|hvsi_push
c_func
(paren
id|hp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hp-&gt;n_outbuf
OG
l_int|0
)paren
id|schedule_delayed_work
c_func
(paren
op_amp
id|hp-&gt;writer
comma
l_int|10
)paren
suffix:semicolon
r_else
(brace
macro_line|#ifdef DEBUG
id|pr_debug
c_func
(paren
l_string|&quot;%s: outbuf emptied after %li jiffies&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|jiffies
op_minus
id|start_j
)paren
suffix:semicolon
id|start_j
op_assign
l_int|0
suffix:semicolon
macro_line|#endif /* DEBUG */
id|wake_up_all
c_func
(paren
op_amp
id|hp-&gt;emptyq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|TTY_DO_WRITE_WAKEUP
comma
op_amp
id|hp-&gt;tty-&gt;flags
)paren
op_logical_and
id|hp-&gt;tty-&gt;ldisc.write_wakeup
)paren
id|hp-&gt;tty-&gt;ldisc
dot
id|write_wakeup
c_func
(paren
id|hp-&gt;tty
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|hp-&gt;tty-&gt;write_wait
)paren
suffix:semicolon
)brace
id|out
suffix:colon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|hp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|hvsi_write_room
r_static
r_int
id|hvsi_write_room
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_struct
id|hvsi_struct
op_star
id|hp
op_assign
(paren
r_struct
id|hvsi_struct
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_return
id|N_OUTBUF
op_minus
id|hp-&gt;n_outbuf
suffix:semicolon
)brace
DECL|function|hvsi_chars_in_buffer
r_static
r_int
id|hvsi_chars_in_buffer
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_struct
id|hvsi_struct
op_star
id|hp
op_assign
(paren
r_struct
id|hvsi_struct
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_return
id|hp-&gt;n_outbuf
suffix:semicolon
)brace
DECL|function|hvsi_write
r_static
r_int
id|hvsi_write
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_const
r_int
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_struct
id|hvsi_struct
op_star
id|hp
op_assign
id|tty-&gt;driver_data
suffix:semicolon
r_const
r_char
op_star
id|source
op_assign
id|buf
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|total
op_assign
l_int|0
suffix:semicolon
r_int
id|origcount
op_assign
id|count
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|hp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;%s: %i chars in buffer&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|hp-&gt;n_outbuf
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|is_open
c_func
(paren
id|hp
)paren
)paren
(brace
multiline_comment|/* we&squot;re either closing or not yet open; don&squot;t accept data */
id|pr_debug
c_func
(paren
l_string|&quot;%s: not open&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * when the hypervisor buffer (16K) fills, data will stay in hp-&gt;outbuf&n;&t; * and hvsi_write_worker will be scheduled. subsequent hvsi_write() calls&n;&t; * will see there is no room in outbuf and return.&n;&t; */
r_while
c_loop
(paren
(paren
id|count
OG
l_int|0
)paren
op_logical_and
(paren
id|hvsi_write_room
c_func
(paren
id|hp-&gt;tty
)paren
OG
l_int|0
)paren
)paren
(brace
r_int
id|chunksize
op_assign
id|min
c_func
(paren
id|count
comma
id|hvsi_write_room
c_func
(paren
id|hp-&gt;tty
)paren
)paren
suffix:semicolon
id|BUG_ON
c_func
(paren
id|hp-&gt;n_outbuf
OL
l_int|0
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|hp-&gt;outbuf
op_plus
id|hp-&gt;n_outbuf
comma
id|source
comma
id|chunksize
)paren
suffix:semicolon
id|hp-&gt;n_outbuf
op_add_assign
id|chunksize
suffix:semicolon
id|total
op_add_assign
id|chunksize
suffix:semicolon
id|source
op_add_assign
id|chunksize
suffix:semicolon
id|count
op_sub_assign
id|chunksize
suffix:semicolon
id|hvsi_push
c_func
(paren
id|hp
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hp-&gt;n_outbuf
OG
l_int|0
)paren
(brace
multiline_comment|/*&n;&t;&t; * we weren&squot;t able to write it all to the hypervisor.&n;&t;&t; * schedule another push attempt.&n;&t;&t; */
id|schedule_delayed_work
c_func
(paren
op_amp
id|hp-&gt;writer
comma
l_int|10
)paren
suffix:semicolon
)brace
id|out
suffix:colon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|hp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|total
op_ne
id|origcount
)paren
id|pr_debug
c_func
(paren
l_string|&quot;%s: wanted %i, only wrote %i&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|origcount
comma
id|total
)paren
suffix:semicolon
r_return
id|total
suffix:semicolon
)brace
multiline_comment|/*&n; * I have never seen throttle or unthrottle called, so this little throttle&n; * buffering scheme may or may not work.&n; */
DECL|function|hvsi_throttle
r_static
r_void
id|hvsi_throttle
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_struct
id|hvsi_struct
op_star
id|hp
op_assign
(paren
r_struct
id|hvsi_struct
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|h_vio_signal
c_func
(paren
id|hp-&gt;vtermno
comma
id|VIO_IRQ_DISABLE
)paren
suffix:semicolon
)brace
DECL|function|hvsi_unthrottle
r_static
r_void
id|hvsi_unthrottle
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_struct
id|hvsi_struct
op_star
id|hp
op_assign
(paren
r_struct
id|hvsi_struct
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|shouldflip
op_assign
l_int|0
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|hp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hp-&gt;n_throttle
)paren
(brace
id|hvsi_send_overflow
c_func
(paren
id|hp
)paren
suffix:semicolon
id|shouldflip
op_assign
l_int|1
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|hp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|shouldflip
)paren
id|tty_flip_buffer_push
c_func
(paren
id|hp-&gt;tty
)paren
suffix:semicolon
id|h_vio_signal
c_func
(paren
id|hp-&gt;vtermno
comma
id|VIO_IRQ_ENABLE
)paren
suffix:semicolon
)brace
DECL|function|hvsi_tiocmget
r_static
r_int
id|hvsi_tiocmget
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|hvsi_struct
op_star
id|hp
op_assign
(paren
r_struct
id|hvsi_struct
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
id|hvsi_get_mctrl
c_func
(paren
id|hp
)paren
suffix:semicolon
r_return
id|hp-&gt;mctrl
suffix:semicolon
)brace
DECL|function|hvsi_tiocmset
r_static
r_int
id|hvsi_tiocmset
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|set
comma
r_int
r_int
id|clear
)paren
(brace
r_struct
id|hvsi_struct
op_star
id|hp
op_assign
(paren
r_struct
id|hvsi_struct
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_uint16
id|new_mctrl
suffix:semicolon
multiline_comment|/* we can only alter DTR */
id|clear
op_and_assign
id|TIOCM_DTR
suffix:semicolon
id|set
op_and_assign
id|TIOCM_DTR
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|hp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|new_mctrl
op_assign
(paren
id|hp-&gt;mctrl
op_amp
op_complement
id|clear
)paren
op_or
id|set
suffix:semicolon
r_if
c_cond
(paren
id|hp-&gt;mctrl
op_ne
id|new_mctrl
)paren
(brace
id|hvsi_set_mctrl
c_func
(paren
id|hp
comma
id|new_mctrl
)paren
suffix:semicolon
id|hp-&gt;mctrl
op_assign
id|new_mctrl
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|hp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|hvsi_ops
r_static
r_struct
id|tty_operations
id|hvsi_ops
op_assign
(brace
dot
id|open
op_assign
id|hvsi_open
comma
dot
id|close
op_assign
id|hvsi_close
comma
dot
id|write
op_assign
id|hvsi_write
comma
dot
id|hangup
op_assign
id|hvsi_hangup
comma
dot
id|write_room
op_assign
id|hvsi_write_room
comma
dot
id|chars_in_buffer
op_assign
id|hvsi_chars_in_buffer
comma
dot
id|throttle
op_assign
id|hvsi_throttle
comma
dot
id|unthrottle
op_assign
id|hvsi_unthrottle
comma
dot
id|tiocmget
op_assign
id|hvsi_tiocmget
comma
dot
id|tiocmset
op_assign
id|hvsi_tiocmset
comma
)brace
suffix:semicolon
DECL|function|hvsi_init
r_static
r_int
id|__init
id|hvsi_init
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|hvsi_driver
op_assign
id|alloc_tty_driver
c_func
(paren
id|hvsi_count
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hvsi_driver
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|hvsi_driver-&gt;owner
op_assign
id|THIS_MODULE
suffix:semicolon
id|hvsi_driver-&gt;devfs_name
op_assign
l_string|&quot;hvsi/&quot;
suffix:semicolon
id|hvsi_driver-&gt;driver_name
op_assign
l_string|&quot;hvsi&quot;
suffix:semicolon
id|hvsi_driver-&gt;name
op_assign
l_string|&quot;hvsi&quot;
suffix:semicolon
id|hvsi_driver-&gt;major
op_assign
id|HVSI_MAJOR
suffix:semicolon
id|hvsi_driver-&gt;minor_start
op_assign
id|HVSI_MINOR
suffix:semicolon
id|hvsi_driver-&gt;type
op_assign
id|TTY_DRIVER_TYPE_SYSTEM
suffix:semicolon
id|hvsi_driver-&gt;init_termios
op_assign
id|tty_std_termios
suffix:semicolon
id|hvsi_driver-&gt;init_termios.c_cflag
op_assign
id|B9600
op_or
id|CS8
op_or
id|CREAD
op_or
id|HUPCL
suffix:semicolon
id|hvsi_driver-&gt;flags
op_assign
id|TTY_DRIVER_REAL_RAW
suffix:semicolon
id|tty_set_operations
c_func
(paren
id|hvsi_driver
comma
op_amp
id|hvsi_ops
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|hvsi_count
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|hvsi_struct
op_star
id|hp
op_assign
op_amp
id|hvsi_ports
(braket
id|i
)braket
suffix:semicolon
r_int
id|ret
op_assign
l_int|1
suffix:semicolon
id|ret
op_assign
id|request_irq
c_func
(paren
id|hp-&gt;virq
comma
id|hvsi_interrupt
comma
id|SA_INTERRUPT
comma
l_string|&quot;hvsi&quot;
comma
id|hp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;HVSI: couldn&squot;t reserve irq 0x%x (error %i)&bslash;n&quot;
comma
id|hp-&gt;virq
comma
id|ret
)paren
suffix:semicolon
)brace
id|hvsi_wait
op_assign
id|wait_for_state
suffix:semicolon
multiline_comment|/* irqs active now */
r_if
c_cond
(paren
id|tty_register_driver
c_func
(paren
id|hvsi_driver
)paren
)paren
id|panic
c_func
(paren
l_string|&quot;Couldn&squot;t register hvsi console driver&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;HVSI: registered %i devices&bslash;n&quot;
comma
id|hvsi_count
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|hvsi_init
id|device_initcall
c_func
(paren
id|hvsi_init
)paren
suffix:semicolon
multiline_comment|/***** console (not tty) code: *****/
DECL|function|hvsi_console_print
r_static
r_void
id|hvsi_console_print
c_func
(paren
r_struct
id|console
op_star
id|console
comma
r_const
r_char
op_star
id|buf
comma
r_int
r_int
id|count
)paren
(brace
r_struct
id|hvsi_struct
op_star
id|hp
op_assign
op_amp
id|hvsi_ports
(braket
id|console-&gt;index
)braket
suffix:semicolon
r_char
id|c
(braket
id|HVSI_MAX_OUTGOING_DATA
)braket
id|__ALIGNED__
suffix:semicolon
r_int
r_int
id|i
op_assign
l_int|0
comma
id|n
op_assign
l_int|0
suffix:semicolon
r_int
id|ret
comma
id|donecr
op_assign
l_int|0
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|is_open
c_func
(paren
id|hp
)paren
)paren
r_return
suffix:semicolon
multiline_comment|/*&n;&t; * ugh, we have to translate LF -&gt; CRLF ourselves, in place.&n;&t; * copied from hvc_console.c:&n;&t; */
r_while
c_loop
(paren
id|count
OG
l_int|0
op_logical_or
id|i
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|count
OG
l_int|0
op_logical_and
id|i
OL
r_sizeof
(paren
id|c
)paren
)paren
(brace
r_if
c_cond
(paren
id|buf
(braket
id|n
)braket
op_eq
l_char|&squot;&bslash;n&squot;
op_logical_and
op_logical_neg
id|donecr
)paren
(brace
id|c
(braket
id|i
op_increment
)braket
op_assign
l_char|&squot;&bslash;r&squot;
suffix:semicolon
id|donecr
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|c
(braket
id|i
op_increment
)braket
op_assign
id|buf
(braket
id|n
op_increment
)braket
suffix:semicolon
id|donecr
op_assign
l_int|0
suffix:semicolon
op_decrement
id|count
suffix:semicolon
)brace
)brace
r_else
(brace
id|ret
op_assign
id|hvsi_put_chars
c_func
(paren
id|hp
comma
id|c
comma
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_sub_assign
id|ret
suffix:semicolon
)brace
)brace
)brace
DECL|function|hvsi_console_device
r_static
r_struct
id|tty_driver
op_star
id|hvsi_console_device
c_func
(paren
r_struct
id|console
op_star
id|console
comma
r_int
op_star
id|index
)paren
(brace
op_star
id|index
op_assign
id|console-&gt;index
suffix:semicolon
r_return
id|hvsi_driver
suffix:semicolon
)brace
DECL|function|hvsi_console_setup
r_static
r_int
id|__init
id|hvsi_console_setup
c_func
(paren
r_struct
id|console
op_star
id|console
comma
r_char
op_star
id|options
)paren
(brace
r_struct
id|hvsi_struct
op_star
id|hp
op_assign
op_amp
id|hvsi_ports
(braket
id|console-&gt;index
)braket
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
id|console-&gt;index
OL
l_int|0
op_logical_or
id|console-&gt;index
op_ge
id|hvsi_count
)paren
r_return
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* give the FSP a chance to change the baud rate when we re-open */
id|hvsi_close_protocol
c_func
(paren
id|hp
)paren
suffix:semicolon
id|ret
op_assign
id|hvsi_handshake
c_func
(paren
id|hp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
r_return
id|ret
suffix:semicolon
id|ret
op_assign
id|hvsi_get_mctrl
c_func
(paren
id|hp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
r_return
id|ret
suffix:semicolon
id|ret
op_assign
id|hvsi_set_mctrl
c_func
(paren
id|hp
comma
id|hp-&gt;mctrl
op_or
id|TIOCM_DTR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
r_return
id|ret
suffix:semicolon
id|hp-&gt;flags
op_or_assign
id|HVSI_CONSOLE
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|hvsi_con_driver
r_static
r_struct
id|console
id|hvsi_con_driver
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;hvsi&quot;
comma
dot
id|write
op_assign
id|hvsi_console_print
comma
dot
id|device
op_assign
id|hvsi_console_device
comma
dot
id|setup
op_assign
id|hvsi_console_setup
comma
dot
id|flags
op_assign
id|CON_PRINTBUFFER
comma
dot
id|index
op_assign
op_minus
l_int|1
comma
)brace
suffix:semicolon
DECL|function|hvsi_console_init
r_static
r_int
id|__init
id|hvsi_console_init
c_func
(paren
r_void
)paren
(brace
r_struct
id|device_node
op_star
id|vty
suffix:semicolon
id|hvsi_wait
op_assign
id|poll_for_state
suffix:semicolon
multiline_comment|/* no irqs yet; must poll */
multiline_comment|/* search device tree for vty nodes */
r_for
c_loop
(paren
id|vty
op_assign
id|of_find_compatible_node
c_func
(paren
l_int|NULL
comma
l_string|&quot;serial&quot;
comma
l_string|&quot;hvterm-protocol&quot;
)paren
suffix:semicolon
id|vty
op_ne
l_int|NULL
suffix:semicolon
id|vty
op_assign
id|of_find_compatible_node
c_func
(paren
id|vty
comma
l_string|&quot;serial&quot;
comma
l_string|&quot;hvterm-protocol&quot;
)paren
)paren
(brace
r_struct
id|hvsi_struct
op_star
id|hp
suffix:semicolon
r_uint32
op_star
id|vtermno
suffix:semicolon
r_uint32
op_star
id|irq
suffix:semicolon
id|vtermno
op_assign
(paren
r_uint32
op_star
)paren
id|get_property
c_func
(paren
id|vty
comma
l_string|&quot;reg&quot;
comma
l_int|NULL
)paren
suffix:semicolon
id|irq
op_assign
(paren
r_uint32
op_star
)paren
id|get_property
c_func
(paren
id|vty
comma
l_string|&quot;interrupts&quot;
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|vtermno
op_logical_or
op_logical_neg
id|irq
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|hvsi_count
op_ge
id|MAX_NR_HVSI_CONSOLES
)paren
(brace
id|of_node_put
c_func
(paren
id|vty
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|hp
op_assign
op_amp
id|hvsi_ports
(braket
id|hvsi_count
)braket
suffix:semicolon
id|INIT_WORK
c_func
(paren
op_amp
id|hp-&gt;writer
comma
id|hvsi_write_worker
comma
id|hp
)paren
suffix:semicolon
id|INIT_WORK
c_func
(paren
op_amp
id|hp-&gt;handshaker
comma
id|hvsi_handshaker
comma
id|hp
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|hp-&gt;emptyq
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|hp-&gt;stateq
)paren
suffix:semicolon
id|hp-&gt;lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
id|hp-&gt;index
op_assign
id|hvsi_count
suffix:semicolon
id|hp-&gt;inbuf_end
op_assign
id|hp-&gt;inbuf
suffix:semicolon
id|hp-&gt;state
op_assign
id|HVSI_CLOSED
suffix:semicolon
id|hp-&gt;vtermno
op_assign
op_star
id|vtermno
suffix:semicolon
id|hp-&gt;virq
op_assign
id|virt_irq_create_mapping
c_func
(paren
id|irq
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hp-&gt;virq
op_eq
id|NO_IRQ
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: couldn&squot;t create irq mapping for 0x%x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|hp-&gt;virq
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_else
id|hp-&gt;virq
op_assign
id|irq_offset_up
c_func
(paren
id|hp-&gt;virq
)paren
suffix:semicolon
id|hvsi_count
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hvsi_count
)paren
id|register_console
c_func
(paren
op_amp
id|hvsi_con_driver
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|hvsi_console_init
id|console_initcall
c_func
(paren
id|hvsi_console_init
)paren
suffix:semicolon
eof
