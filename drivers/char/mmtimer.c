multiline_comment|/*&n; * Intel Multimedia Timer device implementation for SGI SN platforms.&n; *&n; * This file is subject to the terms and conditions of the GNU General Public&n; * License.  See the file &quot;COPYING&quot; in the main directory of this archive&n; * for more details.&n; *&n; * Copyright (c) 2001-2004 Silicon Graphics, Inc.  All rights reserved.&n; *&n; * This driver exports an API that should be supportable by any HPET or IA-PC&n; * multimedia timer.  The code below is currently specific to the SGI Altix&n; * SHub RTC, however.&n; *&n; * 11/01/01 - jbarnes - initial revision&n; * 9/10/04 - Christoph Lameter - remove interrupt support for kernel inclusion&n; */
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/ioctl.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/devfs_fs_kernel.h&gt;
macro_line|#include &lt;linux/mmtimer.h&gt;
macro_line|#include &lt;linux/miscdevice.h&gt;
macro_line|#include &lt;linux/posix-timers.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/sn/addrs.h&gt;
macro_line|#include &lt;asm/sn/clksupport.h&gt;
macro_line|#include &lt;asm/sn/shub_mmr.h&gt;
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Jesse Barnes &lt;jbarnes@sgi.com&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Multimedia timer support&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
multiline_comment|/* name of the device, usually in /dev */
DECL|macro|MMTIMER_NAME
mdefine_line|#define MMTIMER_NAME &quot;mmtimer&quot;
DECL|macro|MMTIMER_DESC
mdefine_line|#define MMTIMER_DESC &quot;IA-PC Multimedia Timer&quot;
DECL|macro|MMTIMER_VERSION
mdefine_line|#define MMTIMER_VERSION &quot;1.0&quot;
DECL|macro|RTC_BITS
mdefine_line|#define RTC_BITS 55 /* 55 bits for this implementation */
r_static
r_int
id|mmtimer_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
suffix:semicolon
r_static
r_int
id|mmtimer_mmap
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_struct
id|vm_area_struct
op_star
id|vma
)paren
suffix:semicolon
multiline_comment|/*&n; * Period in femtoseconds (10^-15 s)&n; */
DECL|variable|mmtimer_femtoperiod
r_static
r_int
r_int
id|mmtimer_femtoperiod
op_assign
l_int|0
suffix:semicolon
DECL|variable|mmtimer_fops
r_static
r_struct
id|file_operations
id|mmtimer_fops
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|mmap
op_assign
id|mmtimer_mmap
comma
dot
id|ioctl
op_assign
id|mmtimer_ioctl
comma
)brace
suffix:semicolon
multiline_comment|/**&n; * mmtimer_ioctl - ioctl interface for /dev/mmtimer&n; * @inode: inode of the device&n; * @file: file structure for the device&n; * @cmd: command to execute&n; * @arg: optional argument to command&n; *&n; * Executes the command specified by @cmd.  Returns 0 for success, &lt; 0 for&n; * failure.&n; *&n; * Valid commands:&n; *&n; * %MMTIMER_GETOFFSET - Should return the offset (relative to the start&n; * of the page where the registers are mapped) for the counter in question.&n; *&n; * %MMTIMER_GETRES - Returns the resolution of the clock in femto (10^-15)&n; * seconds&n; *&n; * %MMTIMER_GETFREQ - Copies the frequency of the clock in Hz to the address&n; * specified by @arg&n; *&n; * %MMTIMER_GETBITS - Returns the number of bits in the clock&squot;s counter&n; *&n; * %MMTIMER_MMAPAVAIL - Returns 1 if the registers can be mmap&squot;d into userspace&n; *&n; * %MMTIMER_GETCOUNTER - Gets the current value in the counter and places it&n; * in the address specified by @arg.&n; */
DECL|function|mmtimer_ioctl
r_static
r_int
id|mmtimer_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|MMTIMER_GETOFFSET
suffix:colon
multiline_comment|/* offset of the counter */
multiline_comment|/*&n;&t;&t; * SN RTC registers are on their own 64k page&n;&t;&t; */
r_if
c_cond
(paren
id|PAGE_SIZE
op_le
(paren
l_int|1
op_lshift
l_int|16
)paren
)paren
(brace
id|ret
op_assign
(paren
(paren
(paren
r_int
)paren
id|RTC_COUNTER_ADDR
)paren
op_amp
(paren
id|PAGE_SIZE
op_minus
l_int|1
)paren
)paren
op_div
l_int|8
suffix:semicolon
)brace
r_else
id|ret
op_assign
op_minus
id|ENOSYS
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MMTIMER_GETRES
suffix:colon
multiline_comment|/* resolution of the clock in 10^-15 s */
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_int
r_int
op_star
)paren
id|arg
comma
op_amp
id|mmtimer_femtoperiod
comma
r_sizeof
(paren
r_int
r_int
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|MMTIMER_GETFREQ
suffix:colon
multiline_comment|/* frequency in Hz */
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_int
r_int
op_star
)paren
id|arg
comma
op_amp
id|sn_rtc_cycles_per_second
comma
r_sizeof
(paren
r_int
r_int
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|ret
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MMTIMER_GETBITS
suffix:colon
multiline_comment|/* number of bits in the clock */
id|ret
op_assign
id|RTC_BITS
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MMTIMER_MMAPAVAIL
suffix:colon
multiline_comment|/* can we mmap the clock into userspace? */
id|ret
op_assign
(paren
id|PAGE_SIZE
op_le
(paren
l_int|1
op_lshift
l_int|16
)paren
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MMTIMER_GETCOUNTER
suffix:colon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_int
r_int
op_star
)paren
id|arg
comma
id|RTC_COUNTER_ADDR
comma
r_sizeof
(paren
r_int
r_int
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|ret
op_assign
op_minus
id|ENOSYS
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/**&n; * mmtimer_mmap - maps the clock&squot;s registers into userspace&n; * @file: file structure for the device&n; * @vma: VMA to map the registers into&n; *&n; * Calls remap_pfn_range() to map the clock&squot;s registers into&n; * the calling process&squot; address space.&n; */
DECL|function|mmtimer_mmap
r_static
r_int
id|mmtimer_mmap
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_struct
id|vm_area_struct
op_star
id|vma
)paren
(brace
r_int
r_int
id|mmtimer_addr
suffix:semicolon
r_if
c_cond
(paren
id|vma-&gt;vm_end
op_minus
id|vma-&gt;vm_start
op_ne
id|PAGE_SIZE
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|vma-&gt;vm_flags
op_amp
id|VM_WRITE
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
r_if
c_cond
(paren
id|PAGE_SIZE
OG
(paren
l_int|1
op_lshift
l_int|16
)paren
)paren
r_return
op_minus
id|ENOSYS
suffix:semicolon
id|vma-&gt;vm_flags
op_or_assign
(paren
id|VM_IO
op_or
id|VM_SHM
op_or
id|VM_LOCKED
)paren
suffix:semicolon
id|vma-&gt;vm_page_prot
op_assign
id|pgprot_noncached
c_func
(paren
id|vma-&gt;vm_page_prot
)paren
suffix:semicolon
id|mmtimer_addr
op_assign
id|__pa
c_func
(paren
id|RTC_COUNTER_ADDR
)paren
suffix:semicolon
id|mmtimer_addr
op_and_assign
op_complement
(paren
id|PAGE_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
id|mmtimer_addr
op_and_assign
l_int|0xfffffffffffffffUL
suffix:semicolon
r_if
c_cond
(paren
id|remap_pfn_range
c_func
(paren
id|vma
comma
id|vma-&gt;vm_start
comma
id|mmtimer_addr
op_rshift
id|PAGE_SHIFT
comma
id|PAGE_SIZE
comma
id|vma-&gt;vm_page_prot
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;remap_pfn_range failed in mmtimer.c&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|mmtimer_miscdev
r_static
r_struct
id|miscdevice
id|mmtimer_miscdev
op_assign
(brace
id|SGI_MMTIMER
comma
id|MMTIMER_NAME
comma
op_amp
id|mmtimer_fops
)brace
suffix:semicolon
DECL|variable|sgi_clock_offset
r_static
r_struct
id|timespec
id|sgi_clock_offset
suffix:semicolon
DECL|variable|sgi_clock_period
r_static
r_int
id|sgi_clock_period
suffix:semicolon
DECL|function|sgi_clock_get
r_static
r_int
id|sgi_clock_get
c_func
(paren
r_struct
id|timespec
op_star
id|tp
)paren
(brace
id|u64
id|nsec
suffix:semicolon
id|nsec
op_assign
id|readq
c_func
(paren
id|RTC_COUNTER_ADDR
)paren
op_star
id|sgi_clock_period
op_plus
id|sgi_clock_offset.tv_nsec
suffix:semicolon
id|tp-&gt;tv_sec
op_assign
id|div_long_long_rem
c_func
(paren
id|nsec
comma
id|NSEC_PER_SEC
comma
op_amp
id|tp-&gt;tv_nsec
)paren
op_plus
id|sgi_clock_offset.tv_sec
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
suffix:semicolon
DECL|function|sgi_clock_set
r_static
r_int
id|sgi_clock_set
c_func
(paren
r_struct
id|timespec
op_star
id|tp
)paren
(brace
id|u64
id|nsec
suffix:semicolon
id|u64
id|rem
suffix:semicolon
id|nsec
op_assign
id|readq
c_func
(paren
id|RTC_COUNTER_ADDR
)paren
op_star
id|sgi_clock_period
suffix:semicolon
id|sgi_clock_offset.tv_sec
op_assign
id|tp-&gt;tv_sec
op_minus
id|div_long_long_rem
c_func
(paren
id|nsec
comma
id|NSEC_PER_SEC
comma
op_amp
id|rem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rem
op_le
id|tp-&gt;tv_nsec
)paren
id|sgi_clock_offset.tv_nsec
op_assign
id|tp-&gt;tv_sec
op_minus
id|rem
suffix:semicolon
r_else
(brace
id|sgi_clock_offset.tv_nsec
op_assign
id|tp-&gt;tv_sec
op_plus
id|NSEC_PER_SEC
op_minus
id|rem
suffix:semicolon
id|sgi_clock_offset.tv_sec
op_decrement
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|sgi_clock
r_static
r_struct
id|k_clock
id|sgi_clock
op_assign
(brace
dot
id|res
op_assign
l_int|0
comma
dot
id|clock_set
op_assign
id|sgi_clock_set
comma
dot
id|clock_get
op_assign
id|sgi_clock_get
comma
dot
id|timer_create
op_assign
id|do_posix_clock_notimer_create
comma
dot
id|nsleep
op_assign
id|do_posix_clock_nonanosleep
)brace
suffix:semicolon
multiline_comment|/**&n; * mmtimer_init - device initialization routine&n; *&n; * Does initial setup for the mmtimer device.&n; */
DECL|function|mmtimer_init
r_static
r_int
id|__init
id|mmtimer_init
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ia64_platform_is
c_func
(paren
l_string|&quot;sn2&quot;
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t; * Sanity check the cycles/sec variable&n;&t; */
r_if
c_cond
(paren
id|sn_rtc_cycles_per_second
OL
l_int|100000
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: unable to determine clock frequency&bslash;n&quot;
comma
id|MMTIMER_NAME
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|mmtimer_femtoperiod
op_assign
(paren
(paren
r_int
r_int
)paren
l_float|1E15
op_plus
id|sn_rtc_cycles_per_second
op_div
l_int|2
)paren
op_div
id|sn_rtc_cycles_per_second
suffix:semicolon
id|strcpy
c_func
(paren
id|mmtimer_miscdev.devfs_name
comma
id|MMTIMER_NAME
)paren
suffix:semicolon
r_if
c_cond
(paren
id|misc_register
c_func
(paren
op_amp
id|mmtimer_miscdev
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: failed to register device&bslash;n&quot;
comma
id|MMTIMER_NAME
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|sgi_clock_period
op_assign
id|sgi_clock.res
op_assign
id|NSEC_PER_SEC
op_div
id|sn_rtc_cycles_per_second
suffix:semicolon
id|register_posix_clock
c_func
(paren
id|CLOCK_SGI_CYCLE
comma
op_amp
id|sgi_clock
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: v%s, %ld MHz&bslash;n&quot;
comma
id|MMTIMER_DESC
comma
id|MMTIMER_VERSION
comma
id|sn_rtc_cycles_per_second
op_div
(paren
r_int
r_int
)paren
l_float|1E6
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|mmtimer_init
id|module_init
c_func
(paren
id|mmtimer_init
)paren
suffix:semicolon
eof
