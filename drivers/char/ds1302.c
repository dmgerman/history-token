multiline_comment|/*!***************************************************************************&n;*!&n;*! FILE NAME  : ds1302.c&n;*!&n;*! DESCRIPTION: Implements an interface for the DS1302 RTC&n;*!&n;*! Functions exported: ds1302_readreg, ds1302_writereg, ds1302_init, get_rtc_status&n;*!&n;*! ---------------------------------------------------------------------------&n;*!&n;*! (C) Copyright 1999, 2000, 2001  Axis Communications AB, LUND, SWEDEN&n;*!&n;*!***************************************************************************/
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/miscdevice.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/bcd.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/rtc.h&gt;
macro_line|#if defined(CONFIG_M32R)
macro_line|#include &lt;asm/m32r.h&gt;
macro_line|#endif
DECL|macro|RTC_MAJOR_NR
mdefine_line|#define RTC_MAJOR_NR 121 /* local major, change later */
DECL|variable|ds1302_name
r_static
r_const
r_char
id|ds1302_name
(braket
)braket
op_assign
l_string|&quot;ds1302&quot;
suffix:semicolon
multiline_comment|/* Send 8 bits. */
r_static
r_void
DECL|function|out_byte_rtc
id|out_byte_rtc
c_func
(paren
r_int
r_int
id|reg_addr
comma
r_int
r_char
id|x
)paren
(brace
singleline_comment|//RST H
id|outw
c_func
(paren
l_int|0x0001
comma
(paren
r_int
r_int
)paren
id|PLD_RTCRSTODT
)paren
suffix:semicolon
singleline_comment|//write data
id|outw
c_func
(paren
(paren
(paren
id|x
op_lshift
l_int|8
)paren
op_or
(paren
id|reg_addr
op_amp
l_int|0xff
)paren
)paren
comma
(paren
r_int
r_int
)paren
id|PLD_RTCWRDATA
)paren
suffix:semicolon
singleline_comment|//WE
id|outw
c_func
(paren
l_int|0x0002
comma
(paren
r_int
r_int
)paren
id|PLD_RTCCR
)paren
suffix:semicolon
singleline_comment|//wait
r_while
c_loop
(paren
id|inw
c_func
(paren
(paren
r_int
r_int
)paren
id|PLD_RTCCR
)paren
)paren
(brace
suffix:semicolon
)brace
singleline_comment|//RST L
id|outw
c_func
(paren
l_int|0x0000
comma
(paren
r_int
r_int
)paren
id|PLD_RTCRSTODT
)paren
suffix:semicolon
)brace
r_static
r_int
r_char
DECL|function|in_byte_rtc
id|in_byte_rtc
c_func
(paren
r_int
r_int
id|reg_addr
)paren
(brace
r_int
r_char
id|retval
suffix:semicolon
singleline_comment|//RST H
id|outw
c_func
(paren
l_int|0x0001
comma
(paren
r_int
r_int
)paren
id|PLD_RTCRSTODT
)paren
suffix:semicolon
singleline_comment|//write data
id|outw
c_func
(paren
(paren
id|reg_addr
op_amp
l_int|0xff
)paren
comma
(paren
r_int
r_int
)paren
id|PLD_RTCRDDATA
)paren
suffix:semicolon
singleline_comment|//RE
id|outw
c_func
(paren
l_int|0x0001
comma
(paren
r_int
r_int
)paren
id|PLD_RTCCR
)paren
suffix:semicolon
singleline_comment|//wait
r_while
c_loop
(paren
id|inw
c_func
(paren
(paren
r_int
r_int
)paren
id|PLD_RTCCR
)paren
)paren
(brace
suffix:semicolon
)brace
singleline_comment|//read data
id|retval
op_assign
(paren
id|inw
c_func
(paren
(paren
r_int
r_int
)paren
id|PLD_RTCRDDATA
)paren
op_amp
l_int|0xff00
)paren
op_rshift
l_int|8
suffix:semicolon
singleline_comment|//RST L
id|outw
c_func
(paren
l_int|0x0000
comma
(paren
r_int
r_int
)paren
id|PLD_RTCRSTODT
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* Enable writing. */
r_static
r_void
DECL|function|ds1302_wenable
id|ds1302_wenable
c_func
(paren
r_void
)paren
(brace
id|out_byte_rtc
c_func
(paren
l_int|0x8e
comma
l_int|0x00
)paren
suffix:semicolon
)brace
multiline_comment|/* Disable writing. */
r_static
r_void
DECL|function|ds1302_wdisable
id|ds1302_wdisable
c_func
(paren
r_void
)paren
(brace
id|out_byte_rtc
c_func
(paren
l_int|0x8e
comma
l_int|0x80
)paren
suffix:semicolon
)brace
multiline_comment|/* Read a byte from the selected register in the DS1302. */
r_int
r_char
DECL|function|ds1302_readreg
id|ds1302_readreg
c_func
(paren
r_int
id|reg
)paren
(brace
r_int
r_char
id|x
suffix:semicolon
id|x
op_assign
id|in_byte_rtc
c_func
(paren
(paren
l_int|0x81
op_or
(paren
id|reg
op_lshift
l_int|1
)paren
)paren
)paren
suffix:semicolon
multiline_comment|/* read register */
r_return
id|x
suffix:semicolon
)brace
multiline_comment|/* Write a byte to the selected register. */
r_void
DECL|function|ds1302_writereg
id|ds1302_writereg
c_func
(paren
r_int
id|reg
comma
r_int
r_char
id|val
)paren
(brace
id|ds1302_wenable
c_func
(paren
)paren
suffix:semicolon
id|out_byte_rtc
c_func
(paren
(paren
l_int|0x80
op_or
(paren
id|reg
op_lshift
l_int|1
)paren
)paren
comma
id|val
)paren
suffix:semicolon
id|ds1302_wdisable
c_func
(paren
)paren
suffix:semicolon
)brace
r_void
DECL|function|get_rtc_time
id|get_rtc_time
c_func
(paren
r_struct
id|rtc_time
op_star
id|rtc_tm
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
id|local_irq_disable
c_func
(paren
)paren
suffix:semicolon
id|rtc_tm-&gt;tm_sec
op_assign
id|CMOS_READ
c_func
(paren
id|RTC_SECONDS
)paren
suffix:semicolon
id|rtc_tm-&gt;tm_min
op_assign
id|CMOS_READ
c_func
(paren
id|RTC_MINUTES
)paren
suffix:semicolon
id|rtc_tm-&gt;tm_hour
op_assign
id|CMOS_READ
c_func
(paren
id|RTC_HOURS
)paren
suffix:semicolon
id|rtc_tm-&gt;tm_mday
op_assign
id|CMOS_READ
c_func
(paren
id|RTC_DAY_OF_MONTH
)paren
suffix:semicolon
id|rtc_tm-&gt;tm_mon
op_assign
id|CMOS_READ
c_func
(paren
id|RTC_MONTH
)paren
suffix:semicolon
id|rtc_tm-&gt;tm_year
op_assign
id|CMOS_READ
c_func
(paren
id|RTC_YEAR
)paren
suffix:semicolon
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
id|BCD_TO_BIN
c_func
(paren
id|rtc_tm-&gt;tm_sec
)paren
suffix:semicolon
id|BCD_TO_BIN
c_func
(paren
id|rtc_tm-&gt;tm_min
)paren
suffix:semicolon
id|BCD_TO_BIN
c_func
(paren
id|rtc_tm-&gt;tm_hour
)paren
suffix:semicolon
id|BCD_TO_BIN
c_func
(paren
id|rtc_tm-&gt;tm_mday
)paren
suffix:semicolon
id|BCD_TO_BIN
c_func
(paren
id|rtc_tm-&gt;tm_mon
)paren
suffix:semicolon
id|BCD_TO_BIN
c_func
(paren
id|rtc_tm-&gt;tm_year
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Account for differences between how the RTC uses the values&n;&t; * and how they are defined in a struct rtc_time;&n;&t; */
r_if
c_cond
(paren
id|rtc_tm-&gt;tm_year
op_le
l_int|69
)paren
id|rtc_tm-&gt;tm_year
op_add_assign
l_int|100
suffix:semicolon
id|rtc_tm-&gt;tm_mon
op_decrement
suffix:semicolon
)brace
DECL|variable|days_in_mo
r_static
r_int
r_char
id|days_in_mo
(braket
)braket
op_assign
(brace
l_int|0
comma
l_int|31
comma
l_int|28
comma
l_int|31
comma
l_int|30
comma
l_int|31
comma
l_int|30
comma
l_int|31
comma
l_int|31
comma
l_int|30
comma
l_int|31
comma
l_int|30
comma
l_int|31
)brace
suffix:semicolon
multiline_comment|/* ioctl that supports RTC_RD_TIME and RTC_SET_TIME (read and set time/date). */
r_static
r_int
DECL|function|rtc_ioctl
id|rtc_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|RTC_RD_TIME
suffix:colon
multiline_comment|/* read the time/date from RTC&t;*/
(brace
r_struct
id|rtc_time
id|rtc_tm
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|rtc_tm
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|rtc_time
)paren
)paren
suffix:semicolon
id|get_rtc_time
c_func
(paren
op_amp
id|rtc_tm
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_struct
id|rtc_time
op_star
)paren
id|arg
comma
op_amp
id|rtc_tm
comma
r_sizeof
(paren
r_struct
id|rtc_time
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|RTC_SET_TIME
suffix:colon
multiline_comment|/* set the RTC */
(brace
r_struct
id|rtc_time
id|rtc_tm
suffix:semicolon
r_int
r_char
id|mon
comma
id|day
comma
id|hrs
comma
id|min
comma
id|sec
comma
id|leap_yr
suffix:semicolon
r_int
r_int
id|yrs
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_TIME
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|rtc_tm
comma
(paren
r_struct
id|rtc_time
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|rtc_time
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|yrs
op_assign
id|rtc_tm.tm_year
op_plus
l_int|1900
suffix:semicolon
id|mon
op_assign
id|rtc_tm.tm_mon
op_plus
l_int|1
suffix:semicolon
multiline_comment|/* tm_mon starts at zero */
id|day
op_assign
id|rtc_tm.tm_mday
suffix:semicolon
id|hrs
op_assign
id|rtc_tm.tm_hour
suffix:semicolon
id|min
op_assign
id|rtc_tm.tm_min
suffix:semicolon
id|sec
op_assign
id|rtc_tm.tm_sec
suffix:semicolon
r_if
c_cond
(paren
(paren
id|yrs
OL
l_int|1970
)paren
op_logical_or
(paren
id|yrs
OG
l_int|2069
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|leap_yr
op_assign
(paren
(paren
op_logical_neg
(paren
id|yrs
op_mod
l_int|4
)paren
op_logical_and
(paren
id|yrs
op_mod
l_int|100
)paren
)paren
op_logical_or
op_logical_neg
(paren
id|yrs
op_mod
l_int|400
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|mon
OG
l_int|12
)paren
op_logical_or
(paren
id|day
op_eq
l_int|0
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|day
OG
(paren
id|days_in_mo
(braket
id|mon
)braket
op_plus
(paren
(paren
id|mon
op_eq
l_int|2
)paren
op_logical_and
id|leap_yr
)paren
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
(paren
id|hrs
op_ge
l_int|24
)paren
op_logical_or
(paren
id|min
op_ge
l_int|60
)paren
op_logical_or
(paren
id|sec
op_ge
l_int|60
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|yrs
op_ge
l_int|2000
)paren
id|yrs
op_sub_assign
l_int|2000
suffix:semicolon
multiline_comment|/* RTC (0, 1, ... 69) */
r_else
id|yrs
op_sub_assign
l_int|1900
suffix:semicolon
multiline_comment|/* RTC (70, 71, ... 99) */
id|BIN_TO_BCD
c_func
(paren
id|sec
)paren
suffix:semicolon
id|BIN_TO_BCD
c_func
(paren
id|min
)paren
suffix:semicolon
id|BIN_TO_BCD
c_func
(paren
id|hrs
)paren
suffix:semicolon
id|BIN_TO_BCD
c_func
(paren
id|day
)paren
suffix:semicolon
id|BIN_TO_BCD
c_func
(paren
id|mon
)paren
suffix:semicolon
id|BIN_TO_BCD
c_func
(paren
id|yrs
)paren
suffix:semicolon
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
id|local_irq_disable
c_func
(paren
)paren
suffix:semicolon
id|CMOS_WRITE
c_func
(paren
id|yrs
comma
id|RTC_YEAR
)paren
suffix:semicolon
id|CMOS_WRITE
c_func
(paren
id|mon
comma
id|RTC_MONTH
)paren
suffix:semicolon
id|CMOS_WRITE
c_func
(paren
id|day
comma
id|RTC_DAY_OF_MONTH
)paren
suffix:semicolon
id|CMOS_WRITE
c_func
(paren
id|hrs
comma
id|RTC_HOURS
)paren
suffix:semicolon
id|CMOS_WRITE
c_func
(paren
id|min
comma
id|RTC_MINUTES
)paren
suffix:semicolon
id|CMOS_WRITE
c_func
(paren
id|sec
comma
id|RTC_SECONDS
)paren
suffix:semicolon
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/* Notice that at this point, the RTC is updated but&n;&t;&t;&t; * the kernel is still running with the old time.&n;&t;&t;&t; * You need to set that separately with settimeofday&n;&t;&t;&t; * or adjtimex.&n;&t;&t;&t; */
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|RTC_SET_CHARGE
suffix:colon
multiline_comment|/* set the RTC TRICKLE CHARGE register */
(brace
r_int
id|tcs_val
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_TIME
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|tcs_val
comma
(paren
r_int
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_int
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|tcs_val
op_assign
id|RTC_TCR_PATTERN
op_or
(paren
id|tcs_val
op_amp
l_int|0x0F
)paren
suffix:semicolon
id|ds1302_writereg
c_func
(paren
id|RTC_TRICKLECHARGER
comma
id|tcs_val
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
r_int
DECL|function|get_rtc_status
id|get_rtc_status
c_func
(paren
r_char
op_star
id|buf
)paren
(brace
r_char
op_star
id|p
suffix:semicolon
r_struct
id|rtc_time
id|tm
suffix:semicolon
id|p
op_assign
id|buf
suffix:semicolon
id|get_rtc_time
c_func
(paren
op_amp
id|tm
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * There is no way to tell if the luser has the RTC set for local&n;&t; * time or for Universal Standard Time (GMT). Probably local though.&n;&t; */
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;rtc_time&bslash;t: %02d:%02d:%02d&bslash;n&quot;
l_string|&quot;rtc_date&bslash;t: %04d-%02d-%02d&bslash;n&quot;
comma
id|tm.tm_hour
comma
id|tm.tm_min
comma
id|tm.tm_sec
comma
id|tm.tm_year
op_plus
l_int|1900
comma
id|tm.tm_mon
op_plus
l_int|1
comma
id|tm.tm_mday
)paren
suffix:semicolon
r_return
id|p
op_minus
id|buf
suffix:semicolon
)brace
multiline_comment|/* The various file operations we support. */
DECL|variable|rtc_fops
r_static
r_struct
id|file_operations
id|rtc_fops
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|ioctl
op_assign
id|rtc_ioctl
comma
)brace
suffix:semicolon
multiline_comment|/* Probe for the chip by writing something to its RAM and try reading it back. */
DECL|macro|MAGIC_PATTERN
mdefine_line|#define MAGIC_PATTERN 0x42
r_static
r_int
id|__init
DECL|function|ds1302_probe
id|ds1302_probe
c_func
(paren
r_void
)paren
(brace
r_int
id|retval
comma
id|res
comma
id|baur
suffix:semicolon
id|baur
op_assign
(paren
id|boot_cpu_data.bus_clock
op_div
(paren
l_int|2
op_star
l_int|1000
op_star
l_int|1000
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: Set PLD_RTCBAUR = %d&bslash;n&quot;
comma
id|ds1302_name
comma
id|baur
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0x0000
comma
(paren
r_int
r_int
)paren
id|PLD_RTCCR
)paren
suffix:semicolon
id|outw
c_func
(paren
l_int|0x0000
comma
(paren
r_int
r_int
)paren
id|PLD_RTCRSTODT
)paren
suffix:semicolon
id|outw
c_func
(paren
id|baur
comma
(paren
r_int
r_int
)paren
id|PLD_RTCBAUR
)paren
suffix:semicolon
multiline_comment|/* Try to talk to timekeeper. */
id|ds1302_wenable
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* write RAM byte 0 */
multiline_comment|/* write something magic */
id|out_byte_rtc
c_func
(paren
l_int|0xc0
comma
id|MAGIC_PATTERN
)paren
suffix:semicolon
multiline_comment|/* read RAM byte 0 */
r_if
c_cond
(paren
(paren
id|res
op_assign
id|in_byte_rtc
c_func
(paren
l_int|0xc1
)paren
)paren
op_eq
id|MAGIC_PATTERN
)paren
(brace
r_char
id|buf
(braket
l_int|100
)braket
suffix:semicolon
id|ds1302_wdisable
c_func
(paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: RTC found.&bslash;n&quot;
comma
id|ds1302_name
)paren
suffix:semicolon
id|get_rtc_status
c_func
(paren
id|buf
)paren
suffix:semicolon
id|printk
c_func
(paren
id|buf
)paren
suffix:semicolon
id|retval
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;%s: RTC not found.&bslash;n&quot;
comma
id|ds1302_name
)paren
suffix:semicolon
id|retval
op_assign
l_int|0
suffix:semicolon
)brace
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* Just probe for the RTC and register the device to handle the ioctl needed. */
r_int
id|__init
DECL|function|ds1302_init
id|ds1302_init
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ds1302_probe
c_func
(paren
)paren
)paren
(brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ds1302_register
r_static
r_int
id|__init
id|ds1302_register
c_func
(paren
r_void
)paren
(brace
id|ds1302_init
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|register_chrdev
c_func
(paren
id|RTC_MAJOR_NR
comma
id|ds1302_name
comma
op_amp
id|rtc_fops
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: unable to get major %d for rtc&bslash;n&quot;
comma
id|ds1302_name
comma
id|RTC_MAJOR_NR
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|ds1302_register
id|module_init
c_func
(paren
id|ds1302_register
)paren
suffix:semicolon
eof
