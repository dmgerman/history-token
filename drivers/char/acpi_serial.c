multiline_comment|/*&n; *  linux/drivers/char/acpi_serial.c&n; *&n; *  Copyright (C) 2000  Hewlett-Packard Co.&n; *  Copyright (C) 2000  Khalid Aziz &lt;khalid_aziz@hp.com&gt;&n; *&n; *  Detect and initialize the headless console serial port defined in &n; *  SPCR table and debug serial port defined in DBGP table&n; *&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/pm.h&gt;
macro_line|#include &lt;linux/acpi.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/serial.h&gt;
macro_line|#include &lt;asm/serial.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;linux/acpi_serial.h&gt;
multiline_comment|/*#include &lt;asm/acpi-ext.h&gt;*/
DECL|macro|SERIAL_DEBUG_ACPI
macro_line|#undef SERIAL_DEBUG_ACPI
multiline_comment|/*&n; * Query ACPI tables for a debug and a headless console serial&n; * port. If found, add them to rs_table[]. A pointer to either SPCR&n; * or DBGP table is passed as parameter. This function should be called &n; * before serial_console_init() is called to make sure the SPCR serial &n; * console will be available for use. IA-64 kernel calls this function&n; * from within acpi.c when it encounters SPCR or DBGP tables as it parses &n; * the ACPI 2.0 tables during bootup.&n; *&n; */
DECL|function|setup_serial_acpi
r_void
id|__init
id|setup_serial_acpi
c_func
(paren
r_void
op_star
id|tablep
)paren
(brace
id|acpi_ser_t
op_star
id|acpi_ser_p
suffix:semicolon
r_struct
id|serial_struct
id|serial_req
suffix:semicolon
r_int
r_int
id|iobase
suffix:semicolon
r_int
id|global_sys_irq
suffix:semicolon
macro_line|#ifdef SERIAL_DEBUG_ACPI
id|printk
c_func
(paren
l_string|&quot;Entering setup_serial_acpi()&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Now get the table */
r_if
c_cond
(paren
id|tablep
op_eq
l_int|NULL
)paren
(brace
r_return
suffix:semicolon
)brace
id|acpi_ser_p
op_assign
(paren
id|acpi_ser_t
op_star
)paren
id|tablep
suffix:semicolon
multiline_comment|/*&n;&t; * Perform a sanity check on the table. Table should have a &n;&t; * signature of &quot;SPCR&quot; or &quot;DBGP&quot; and it should be atleast 52 bytes&n;&t; * long.&n;&t; */
r_if
c_cond
(paren
(paren
id|strncmp
c_func
(paren
id|acpi_ser_p-&gt;signature
comma
id|ACPI_SPCRT_SIGNATURE
comma
id|ACPI_SIG_LEN
)paren
op_ne
l_int|0
)paren
op_logical_and
(paren
id|strncmp
c_func
(paren
id|acpi_ser_p-&gt;signature
comma
id|ACPI_DBGPT_SIGNATURE
comma
id|ACPI_SIG_LEN
)paren
op_ne
l_int|0
)paren
)paren
(brace
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|acpi_ser_p-&gt;length
OL
l_int|52
)paren
(brace
r_return
suffix:semicolon
)brace
id|iobase
op_assign
(paren
(paren
(paren
id|u64
)paren
id|acpi_ser_p-&gt;base_addr.addrh
)paren
op_lshift
l_int|32
)paren
op_or
id|acpi_ser_p-&gt;base_addr.addrl
suffix:semicolon
id|global_sys_irq
op_assign
(paren
id|acpi_ser_p-&gt;global_int
(braket
l_int|3
)braket
op_lshift
l_int|24
)paren
op_or
(paren
id|acpi_ser_p-&gt;global_int
(braket
l_int|2
)braket
op_lshift
l_int|16
)paren
op_or
(paren
id|acpi_ser_p-&gt;global_int
(braket
l_int|1
)braket
op_lshift
l_int|8
)paren
op_or
id|acpi_ser_p-&gt;global_int
(braket
l_int|0
)braket
suffix:semicolon
macro_line|#ifdef SERIAL_DEBUG_ACPI
id|printk
c_func
(paren
l_string|&quot;setup_serial_acpi(): table pointer = 0x%p&bslash;n&quot;
comma
id|acpi_ser_p
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;                     sig = &squot;%c%c%c%c&squot;&bslash;n&quot;
comma
id|acpi_ser_p-&gt;signature
(braket
l_int|0
)braket
comma
id|acpi_ser_p-&gt;signature
(braket
l_int|1
)braket
comma
id|acpi_ser_p-&gt;signature
(braket
l_int|2
)braket
comma
id|acpi_ser_p-&gt;signature
(braket
l_int|3
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;                     length = %d&bslash;n&quot;
comma
id|acpi_ser_p-&gt;length
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;                     Rev = %d&bslash;n&quot;
comma
id|acpi_ser_p-&gt;rev
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;                     Interface type = %d&bslash;n&quot;
comma
id|acpi_ser_p-&gt;intfc_type
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;                     Base address = 0x%lX&bslash;n&quot;
comma
id|iobase
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;                     IRQ = %d&bslash;n&quot;
comma
id|acpi_ser_p-&gt;irq
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;                     Global System Int = %d&bslash;n&quot;
comma
id|global_sys_irq
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;                     Baud rate = &quot;
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|acpi_ser_p-&gt;baud
)paren
(brace
r_case
id|ACPI_SERIAL_BAUD_9600
suffix:colon
id|printk
c_func
(paren
l_string|&quot;9600&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACPI_SERIAL_BAUD_19200
suffix:colon
id|printk
c_func
(paren
l_string|&quot;19200&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACPI_SERIAL_BAUD_57600
suffix:colon
id|printk
c_func
(paren
l_string|&quot;57600&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACPI_SERIAL_BAUD_115200
suffix:colon
id|printk
c_func
(paren
l_string|&quot;115200&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;Huh (%d)&bslash;n&quot;
comma
id|acpi_ser_p-&gt;baud
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|acpi_ser_p-&gt;base_addr.space_id
op_eq
id|ACPI_SERIAL_PCICONF_SPACE
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;                     PCI serial port:&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;                         Bus %d, Device %d, Vendor ID 0x%x, Dev ID 0x%x&bslash;n&quot;
comma
id|acpi_ser_p-&gt;pci_bus
comma
id|acpi_ser_p-&gt;pci_dev
comma
id|acpi_ser_p-&gt;pci_vendor_id
comma
id|acpi_ser_p-&gt;pci_dev_id
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* &n;&t; * Now build a serial_req structure to update the entry in&n;&t; * rs_table for the headless console port.&n;&t; */
r_switch
c_cond
(paren
id|acpi_ser_p-&gt;intfc_type
)paren
(brace
r_case
id|ACPI_SERIAL_INTFC_16550
suffix:colon
id|serial_req.type
op_assign
id|PORT_16550
suffix:semicolon
id|serial_req.baud_base
op_assign
id|BASE_BAUD
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ACPI_SERIAL_INTFC_16450
suffix:colon
id|serial_req.type
op_assign
id|PORT_16450
suffix:semicolon
id|serial_req.baud_base
op_assign
id|BASE_BAUD
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|serial_req.type
op_assign
id|PORT_UNKNOWN
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|acpi_ser_p-&gt;signature
comma
id|ACPI_SPCRT_SIGNATURE
comma
id|ACPI_SIG_LEN
)paren
op_eq
l_int|0
)paren
(brace
id|serial_req.line
op_assign
id|ACPI_SERIAL_CONSOLE_PORT
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|acpi_ser_p-&gt;signature
comma
id|ACPI_DBGPT_SIGNATURE
comma
id|ACPI_SIG_LEN
)paren
op_eq
l_int|0
)paren
(brace
id|serial_req.line
op_assign
id|ACPI_SERIAL_DEBUG_PORT
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Check if this is an I/O mapped address or a memory mapped address&n;&t; */
r_if
c_cond
(paren
id|acpi_ser_p-&gt;base_addr.space_id
op_eq
id|ACPI_SERIAL_MEM_SPACE
)paren
(brace
id|serial_req.port
op_assign
l_int|0
suffix:semicolon
id|serial_req.port_high
op_assign
l_int|0
suffix:semicolon
id|serial_req.iomem_base
op_assign
(paren
r_void
op_star
)paren
id|ioremap
c_func
(paren
id|iobase
comma
l_int|64
)paren
suffix:semicolon
id|serial_req.io_type
op_assign
id|SERIAL_IO_MEM
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|acpi_ser_p-&gt;base_addr.space_id
op_eq
id|ACPI_SERIAL_IO_SPACE
)paren
(brace
id|serial_req.port
op_assign
(paren
r_int
r_int
)paren
id|iobase
op_amp
l_int|0xffffffff
suffix:semicolon
id|serial_req.port_high
op_assign
(paren
r_int
r_int
)paren
(paren
(paren
(paren
id|u64
)paren
id|iobase
)paren
op_rshift
l_int|32
)paren
suffix:semicolon
id|serial_req.iomem_base
op_assign
l_int|NULL
suffix:semicolon
id|serial_req.io_type
op_assign
id|SERIAL_IO_PORT
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|acpi_ser_p-&gt;base_addr.space_id
op_eq
id|ACPI_SERIAL_PCICONF_SPACE
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;WARNING: No support for PCI serial console&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * If the table does not have IRQ information, use 0 for IRQ. &n;&t; * This will force rs_init() to probe for IRQ. &n;&t; */
r_if
c_cond
(paren
id|acpi_ser_p-&gt;length
OL
l_int|53
)paren
(brace
id|serial_req.irq
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|serial_req.flags
op_assign
id|ASYNC_SKIP_TEST
op_or
id|ASYNC_BOOT_AUTOCONF
op_or
id|ASYNC_AUTO_IRQ
suffix:semicolon
r_if
c_cond
(paren
id|acpi_ser_p-&gt;int_type
op_amp
(paren
id|ACPI_SERIAL_INT_APIC
op_or
id|ACPI_SERIAL_INT_SAPIC
)paren
)paren
(brace
id|serial_req.irq
op_assign
id|global_sys_irq
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|acpi_ser_p-&gt;int_type
op_amp
id|ACPI_SERIAL_INT_PCAT
)paren
(brace
id|serial_req.irq
op_assign
id|acpi_ser_p-&gt;irq
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t;&t; * IRQ type not being set would mean UART will&n;&t;&t;&t; * run in polling mode. Do not probe for IRQ in&n;&t;&t;&t; * that case.&n;&t;&t;&t; */
id|serial_req.flags
op_assign
id|ASYNC_SKIP_TEST
op_or
id|ASYNC_BOOT_AUTOCONF
suffix:semicolon
)brace
)brace
id|serial_req.xmit_fifo_size
op_assign
id|serial_req.custom_divisor
op_assign
l_int|0
suffix:semicolon
id|serial_req.close_delay
op_assign
id|serial_req.hub6
op_assign
id|serial_req.closing_wait
op_assign
l_int|0
suffix:semicolon
id|serial_req.iomem_reg_shift
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|early_serial_setup
c_func
(paren
op_amp
id|serial_req
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;early_serial_setup() for ACPI serial console port failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#ifdef SERIAL_DEBUG_ACPI
id|printk
c_func
(paren
l_string|&quot;Leaving setup_serial_acpi()&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
eof
