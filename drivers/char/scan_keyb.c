multiline_comment|/*&n; *&t;$Id: scan_keyb.c,v 1.2 2000/07/04 06:24:42 yaegashi Exp $ &n; *&t;Copyright (C) 2000 YAEGASHI Takeshi&n; *&t;Generic scan keyboard driver&n; */
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/signal.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/kbd_ll.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/random.h&gt;
macro_line|#include &lt;linux/poll.h&gt;
macro_line|#include &lt;linux/miscdevice.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/kbd_kern.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
DECL|macro|SCANHZ
mdefine_line|#define SCANHZ&t;(HZ/20)
DECL|struct|scan_keyboard
r_struct
id|scan_keyboard
(brace
DECL|member|next
r_struct
id|scan_keyboard
op_star
id|next
suffix:semicolon
DECL|member|scan
r_int
(paren
op_star
id|scan
)paren
(paren
r_int
r_char
op_star
id|buffer
)paren
suffix:semicolon
DECL|member|table
r_const
r_int
r_char
op_star
id|table
suffix:semicolon
DECL|member|s0
DECL|member|s1
r_int
r_char
op_star
id|s0
comma
op_star
id|s1
suffix:semicolon
DECL|member|length
r_int
id|length
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|scan_jiffies
r_static
r_int
id|scan_jiffies
op_assign
l_int|0
suffix:semicolon
DECL|variable|keyboards
r_static
r_struct
id|scan_keyboard
op_star
id|keyboards
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|scan_timer
r_struct
id|timer_list
id|scan_timer
suffix:semicolon
DECL|function|check_kbd
r_static
r_void
id|check_kbd
c_func
(paren
r_const
r_int
r_char
op_star
id|table
comma
r_int
r_char
op_star
r_new
comma
r_int
r_char
op_star
id|old
comma
r_int
id|length
)paren
(brace
r_int
id|need_tasklet_schedule
op_assign
l_int|0
suffix:semicolon
r_int
r_int
op_xor
comma
id|bit
suffix:semicolon
r_while
c_loop
(paren
id|length
op_decrement
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
(paren
op_xor
op_assign
op_star
r_new
op_xor
op_star
id|old
)paren
op_eq
l_int|0
)paren
(brace
id|table
op_add_assign
l_int|8
suffix:semicolon
)brace
r_else
(brace
r_for
c_loop
(paren
id|bit
op_assign
l_int|0x01
suffix:semicolon
id|bit
OL
l_int|0x100
suffix:semicolon
id|bit
op_lshift_assign
l_int|1
)paren
(brace
r_if
c_cond
(paren
op_xor
op_amp
id|bit
)paren
(brace
id|handle_scancode
c_func
(paren
op_star
id|table
comma
op_logical_neg
(paren
op_star
r_new
op_amp
id|bit
)paren
)paren
suffix:semicolon
id|need_tasklet_schedule
op_assign
l_int|1
suffix:semicolon
macro_line|#if 0
id|printk
c_func
(paren
l_string|&quot;0x%x %s&bslash;n&quot;
comma
op_star
id|table
comma
(paren
op_star
r_new
op_amp
id|bit
)paren
ques
c_cond
l_string|&quot;released&quot;
suffix:colon
l_string|&quot;pressed&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
id|table
op_increment
suffix:semicolon
)brace
)brace
r_new
op_increment
suffix:semicolon
id|old
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|need_tasklet_schedule
)paren
(brace
id|tasklet_schedule
c_func
(paren
op_amp
id|keyboard_tasklet
)paren
suffix:semicolon
)brace
)brace
DECL|function|scan_kbd
r_static
r_void
id|scan_kbd
c_func
(paren
r_int
r_int
id|dummy
)paren
(brace
r_struct
id|scan_keyboard
op_star
id|kbd
suffix:semicolon
id|scan_jiffies
op_increment
suffix:semicolon
r_for
c_loop
(paren
id|kbd
op_assign
id|keyboards
suffix:semicolon
id|kbd
op_ne
l_int|NULL
suffix:semicolon
id|kbd
op_assign
id|kbd-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|scan_jiffies
op_amp
l_int|1
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|kbd
op_member_access_from_pointer
id|scan
c_func
(paren
id|kbd-&gt;s0
)paren
)paren
(brace
id|check_kbd
c_func
(paren
id|kbd-&gt;table
comma
id|kbd-&gt;s0
comma
id|kbd-&gt;s1
comma
id|kbd-&gt;length
)paren
suffix:semicolon
)brace
r_else
id|memcpy
c_func
(paren
id|kbd-&gt;s0
comma
id|kbd-&gt;s1
comma
id|kbd-&gt;length
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
op_logical_neg
id|kbd
op_member_access_from_pointer
id|scan
c_func
(paren
id|kbd-&gt;s1
)paren
)paren
(brace
id|check_kbd
c_func
(paren
id|kbd-&gt;table
comma
id|kbd-&gt;s1
comma
id|kbd-&gt;s0
comma
id|kbd-&gt;length
)paren
suffix:semicolon
)brace
r_else
id|memcpy
c_func
(paren
id|kbd-&gt;s1
comma
id|kbd-&gt;s0
comma
id|kbd-&gt;length
)paren
suffix:semicolon
)brace
)brace
id|init_timer
c_func
(paren
op_amp
id|scan_timer
)paren
suffix:semicolon
id|scan_timer.expires
op_assign
id|jiffies
op_plus
id|SCANHZ
suffix:semicolon
id|scan_timer.data
op_assign
l_int|0
suffix:semicolon
id|scan_timer.function
op_assign
id|scan_kbd
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|scan_timer
)paren
suffix:semicolon
)brace
DECL|function|register_scan_keyboard
r_int
id|register_scan_keyboard
c_func
(paren
r_int
(paren
op_star
id|scan
)paren
(paren
r_int
r_char
op_star
id|buffer
)paren
comma
r_const
r_int
r_char
op_star
id|table
comma
r_int
id|length
)paren
(brace
r_struct
id|scan_keyboard
op_star
id|kbd
suffix:semicolon
id|kbd
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|scan_keyboard
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|kbd
op_eq
l_int|NULL
)paren
r_goto
id|error_out
suffix:semicolon
id|kbd-&gt;scan
op_assign
id|scan
suffix:semicolon
id|kbd-&gt;table
op_assign
id|table
suffix:semicolon
id|kbd-&gt;length
op_assign
id|length
suffix:semicolon
id|kbd-&gt;s0
op_assign
id|kmalloc
c_func
(paren
id|length
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|kbd-&gt;s0
op_eq
l_int|NULL
)paren
r_goto
id|error_free_kbd
suffix:semicolon
id|kbd-&gt;s1
op_assign
id|kmalloc
c_func
(paren
id|length
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|kbd-&gt;s1
op_eq
l_int|NULL
)paren
r_goto
id|error_free_s0
suffix:semicolon
id|memset
c_func
(paren
id|kbd-&gt;s0
comma
op_minus
l_int|1
comma
id|kbd-&gt;length
)paren
suffix:semicolon
id|memset
c_func
(paren
id|kbd-&gt;s1
comma
op_minus
l_int|1
comma
id|kbd-&gt;length
)paren
suffix:semicolon
id|kbd-&gt;next
op_assign
id|keyboards
suffix:semicolon
id|keyboards
op_assign
id|kbd
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|error_free_s0
suffix:colon
id|kfree
c_func
(paren
id|kbd-&gt;s0
)paren
suffix:semicolon
id|error_free_kbd
suffix:colon
id|kfree
c_func
(paren
id|kbd
)paren
suffix:semicolon
id|error_out
suffix:colon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
DECL|function|scan_kbd_init
r_void
id|__init
id|scan_kbd_init
c_func
(paren
r_void
)paren
(brace
id|init_timer
c_func
(paren
op_amp
id|scan_timer
)paren
suffix:semicolon
id|scan_timer.expires
op_assign
id|jiffies
op_plus
id|SCANHZ
suffix:semicolon
id|scan_timer.data
op_assign
l_int|0
suffix:semicolon
id|scan_timer.function
op_assign
id|scan_kbd
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|scan_timer
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Generic scan keyboard driver initialized&bslash;n&quot;
)paren
suffix:semicolon
)brace
eof
