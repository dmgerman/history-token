multiline_comment|/*&n; * HP zx1 AGPGART routines.&n; *&n; * (c) Copyright 2002, 2003 Hewlett-Packard Development Company, L.P.&n; *&t;Bjorn Helgaas &lt;bjorn.helgaas@hp.com&gt;&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License version 2 as&n; * published by the Free Software Foundation.&n; */
macro_line|#include &lt;linux/acpi.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/agp_backend.h&gt;
macro_line|#include &lt;asm/acpi-ext.h&gt;
macro_line|#include &quot;agp.h&quot;
macro_line|#ifndef log2
DECL|macro|log2
mdefine_line|#define log2(x)&t;&t;ffz(~(x))
macro_line|#endif
DECL|macro|HP_ZX1_IOC_OFFSET
mdefine_line|#define HP_ZX1_IOC_OFFSET&t;0x1000  /* ACPI reports SBA, we want IOC */
multiline_comment|/* HP ZX1 IOC registers */
DECL|macro|HP_ZX1_IBASE
mdefine_line|#define HP_ZX1_IBASE&t;&t;0x300
DECL|macro|HP_ZX1_IMASK
mdefine_line|#define HP_ZX1_IMASK&t;&t;0x308
DECL|macro|HP_ZX1_PCOM
mdefine_line|#define HP_ZX1_PCOM&t;&t;0x310
DECL|macro|HP_ZX1_TCNFG
mdefine_line|#define HP_ZX1_TCNFG&t;&t;0x318
DECL|macro|HP_ZX1_PDIR_BASE
mdefine_line|#define HP_ZX1_PDIR_BASE&t;0x320
DECL|macro|HP_ZX1_IOVA_BASE
mdefine_line|#define HP_ZX1_IOVA_BASE&t;GB(1UL)
DECL|macro|HP_ZX1_IOVA_SIZE
mdefine_line|#define HP_ZX1_IOVA_SIZE&t;GB(1UL)
DECL|macro|HP_ZX1_GART_SIZE
mdefine_line|#define HP_ZX1_GART_SIZE&t;(HP_ZX1_IOVA_SIZE / 2)
DECL|macro|HP_ZX1_SBA_IOMMU_COOKIE
mdefine_line|#define HP_ZX1_SBA_IOMMU_COOKIE&t;0x0000badbadc0ffeeUL
DECL|macro|HP_ZX1_PDIR_VALID_BIT
mdefine_line|#define HP_ZX1_PDIR_VALID_BIT&t;0x8000000000000000UL
DECL|macro|HP_ZX1_IOVA_TO_PDIR
mdefine_line|#define HP_ZX1_IOVA_TO_PDIR(va)&t;((va - hp_private.iova_base) &gt;&gt; hp_private.io_tlb_shift)
DECL|macro|AGP8X_MODE_BIT
mdefine_line|#define AGP8X_MODE_BIT&t;&t;3
DECL|macro|AGP8X_MODE
mdefine_line|#define AGP8X_MODE&t;&t;(1 &lt;&lt; AGP8X_MODE_BIT)
multiline_comment|/* AGP bridge need not be PCI device, but DRM thinks it is. */
DECL|variable|fake_bridge_dev
r_static
r_struct
id|pci_dev
id|fake_bridge_dev
suffix:semicolon
DECL|variable|hp_zx1_gart_found
r_static
r_int
id|hp_zx1_gart_found
suffix:semicolon
DECL|variable|hp_zx1_sizes
r_static
r_struct
id|aper_size_info_fixed
id|hp_zx1_sizes
(braket
)braket
op_assign
(brace
(brace
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
multiline_comment|/* filled in by hp_zx1_fetch_size() */
)brace
suffix:semicolon
DECL|variable|hp_zx1_masks
r_static
r_struct
id|gatt_mask
id|hp_zx1_masks
(braket
)braket
op_assign
(brace
(brace
dot
id|mask
op_assign
id|HP_ZX1_PDIR_VALID_BIT
comma
dot
id|type
op_assign
l_int|0
)brace
)brace
suffix:semicolon
DECL|struct|_hp_private
r_static
r_struct
id|_hp_private
(brace
DECL|member|ioc_regs
r_volatile
id|u8
id|__iomem
op_star
id|ioc_regs
suffix:semicolon
DECL|member|lba_regs
r_volatile
id|u8
id|__iomem
op_star
id|lba_regs
suffix:semicolon
DECL|member|lba_cap_offset
r_int
id|lba_cap_offset
suffix:semicolon
DECL|member|io_pdir
id|u64
op_star
id|io_pdir
suffix:semicolon
singleline_comment|// PDIR for entire IOVA
DECL|member|gatt
id|u64
op_star
id|gatt
suffix:semicolon
singleline_comment|// PDIR just for GART (subset of above)
DECL|member|gatt_entries
id|u64
id|gatt_entries
suffix:semicolon
DECL|member|iova_base
id|u64
id|iova_base
suffix:semicolon
DECL|member|gart_base
id|u64
id|gart_base
suffix:semicolon
DECL|member|gart_size
id|u64
id|gart_size
suffix:semicolon
DECL|member|io_pdir_size
id|u64
id|io_pdir_size
suffix:semicolon
DECL|member|io_pdir_owner
r_int
id|io_pdir_owner
suffix:semicolon
singleline_comment|// do we own it, or share it with sba_iommu?
DECL|member|io_page_size
r_int
id|io_page_size
suffix:semicolon
DECL|member|io_tlb_shift
r_int
id|io_tlb_shift
suffix:semicolon
DECL|member|io_tlb_ps
r_int
id|io_tlb_ps
suffix:semicolon
singleline_comment|// IOC ps config
DECL|member|io_pages_per_kpage
r_int
id|io_pages_per_kpage
suffix:semicolon
DECL|variable|hp_private
)brace
id|hp_private
suffix:semicolon
DECL|function|hp_zx1_ioc_shared
r_static
r_int
id|__init
id|hp_zx1_ioc_shared
c_func
(paren
r_void
)paren
(brace
r_struct
id|_hp_private
op_star
id|hp
op_assign
op_amp
id|hp_private
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
id|PFX
l_string|&quot;HP ZX1 IOC: IOPDIR shared with sba_iommu&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * IOC already configured by sba_iommu module; just use&n;&t; * its setup.  We assume:&n;&t; * &t;- IOVA space is 1Gb in size&n;&t; * &t;- first 512Mb is IOMMU, second 512Mb is GART&n;&t; */
id|hp-&gt;io_tlb_ps
op_assign
id|readq
c_func
(paren
id|hp-&gt;ioc_regs
op_plus
id|HP_ZX1_TCNFG
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|hp-&gt;io_tlb_ps
)paren
(brace
r_case
l_int|0
suffix:colon
id|hp-&gt;io_tlb_shift
op_assign
l_int|12
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|hp-&gt;io_tlb_shift
op_assign
l_int|13
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|hp-&gt;io_tlb_shift
op_assign
l_int|14
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
id|hp-&gt;io_tlb_shift
op_assign
l_int|16
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;Invalid IOTLB page size &quot;
l_string|&quot;configuration 0x%x&bslash;n&quot;
comma
id|hp-&gt;io_tlb_ps
)paren
suffix:semicolon
id|hp-&gt;gatt
op_assign
l_int|NULL
suffix:semicolon
id|hp-&gt;gatt_entries
op_assign
l_int|0
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|hp-&gt;io_page_size
op_assign
l_int|1
op_lshift
id|hp-&gt;io_tlb_shift
suffix:semicolon
id|hp-&gt;io_pages_per_kpage
op_assign
id|PAGE_SIZE
op_div
id|hp-&gt;io_page_size
suffix:semicolon
id|hp-&gt;iova_base
op_assign
id|readq
c_func
(paren
id|hp-&gt;ioc_regs
op_plus
id|HP_ZX1_IBASE
)paren
op_amp
op_complement
l_int|0x1
suffix:semicolon
id|hp-&gt;gart_base
op_assign
id|hp-&gt;iova_base
op_plus
id|HP_ZX1_IOVA_SIZE
op_minus
id|HP_ZX1_GART_SIZE
suffix:semicolon
id|hp-&gt;gart_size
op_assign
id|HP_ZX1_GART_SIZE
suffix:semicolon
id|hp-&gt;gatt_entries
op_assign
id|hp-&gt;gart_size
op_div
id|hp-&gt;io_page_size
suffix:semicolon
id|hp-&gt;io_pdir
op_assign
id|phys_to_virt
c_func
(paren
id|readq
c_func
(paren
id|hp-&gt;ioc_regs
op_plus
id|HP_ZX1_PDIR_BASE
)paren
)paren
suffix:semicolon
id|hp-&gt;gatt
op_assign
op_amp
id|hp-&gt;io_pdir
(braket
id|HP_ZX1_IOVA_TO_PDIR
c_func
(paren
id|hp-&gt;gart_base
)paren
)braket
suffix:semicolon
r_if
c_cond
(paren
id|hp-&gt;gatt
(braket
l_int|0
)braket
op_ne
id|HP_ZX1_SBA_IOMMU_COOKIE
)paren
(brace
multiline_comment|/* Normal case when no AGP device in system */
id|hp-&gt;gatt
op_assign
l_int|NULL
suffix:semicolon
id|hp-&gt;gatt_entries
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;No reserved IO PDIR entry found; &quot;
l_string|&quot;GART disabled&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
id|__init
DECL|function|hp_zx1_ioc_owner
id|hp_zx1_ioc_owner
(paren
r_void
)paren
(brace
r_struct
id|_hp_private
op_star
id|hp
op_assign
op_amp
id|hp_private
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
id|PFX
l_string|&quot;HP ZX1 IOC: IOPDIR dedicated to GART&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Select an IOV page size no larger than system page size.&n;&t; */
r_if
c_cond
(paren
id|PAGE_SIZE
op_ge
id|KB
c_func
(paren
l_int|64
)paren
)paren
(brace
id|hp-&gt;io_tlb_shift
op_assign
l_int|16
suffix:semicolon
id|hp-&gt;io_tlb_ps
op_assign
l_int|3
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|PAGE_SIZE
op_ge
id|KB
c_func
(paren
l_int|16
)paren
)paren
(brace
id|hp-&gt;io_tlb_shift
op_assign
l_int|14
suffix:semicolon
id|hp-&gt;io_tlb_ps
op_assign
l_int|2
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|PAGE_SIZE
op_ge
id|KB
c_func
(paren
l_int|8
)paren
)paren
(brace
id|hp-&gt;io_tlb_shift
op_assign
l_int|13
suffix:semicolon
id|hp-&gt;io_tlb_ps
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|hp-&gt;io_tlb_shift
op_assign
l_int|12
suffix:semicolon
id|hp-&gt;io_tlb_ps
op_assign
l_int|0
suffix:semicolon
)brace
id|hp-&gt;io_page_size
op_assign
l_int|1
op_lshift
id|hp-&gt;io_tlb_shift
suffix:semicolon
id|hp-&gt;io_pages_per_kpage
op_assign
id|PAGE_SIZE
op_div
id|hp-&gt;io_page_size
suffix:semicolon
id|hp-&gt;iova_base
op_assign
id|HP_ZX1_IOVA_BASE
suffix:semicolon
id|hp-&gt;gart_size
op_assign
id|HP_ZX1_GART_SIZE
suffix:semicolon
id|hp-&gt;gart_base
op_assign
id|hp-&gt;iova_base
op_plus
id|HP_ZX1_IOVA_SIZE
op_minus
id|hp-&gt;gart_size
suffix:semicolon
id|hp-&gt;gatt_entries
op_assign
id|hp-&gt;gart_size
op_div
id|hp-&gt;io_page_size
suffix:semicolon
id|hp-&gt;io_pdir_size
op_assign
(paren
id|HP_ZX1_IOVA_SIZE
op_div
id|hp-&gt;io_page_size
)paren
op_star
r_sizeof
(paren
id|u64
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
id|__init
DECL|function|hp_zx1_ioc_init
id|hp_zx1_ioc_init
(paren
id|u64
id|hpa
)paren
(brace
r_struct
id|_hp_private
op_star
id|hp
op_assign
op_amp
id|hp_private
suffix:semicolon
id|hp-&gt;ioc_regs
op_assign
id|ioremap
c_func
(paren
id|hpa
comma
l_int|1024
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hp-&gt;ioc_regs
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
multiline_comment|/*&n;&t; * If the IOTLB is currently disabled, we can take it over.&n;&t; * Otherwise, we have to share with sba_iommu.&n;&t; */
id|hp-&gt;io_pdir_owner
op_assign
(paren
id|readq
c_func
(paren
id|hp-&gt;ioc_regs
op_plus
id|HP_ZX1_IBASE
)paren
op_amp
l_int|0x1
)paren
op_eq
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|hp-&gt;io_pdir_owner
)paren
r_return
id|hp_zx1_ioc_owner
c_func
(paren
)paren
suffix:semicolon
r_return
id|hp_zx1_ioc_shared
c_func
(paren
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|hp_zx1_lba_find_capability
id|hp_zx1_lba_find_capability
(paren
r_volatile
id|u8
id|__iomem
op_star
id|hpa
comma
r_int
id|cap
)paren
(brace
id|u16
id|status
suffix:semicolon
id|u8
id|pos
comma
id|id
suffix:semicolon
r_int
id|ttl
op_assign
l_int|48
suffix:semicolon
id|status
op_assign
id|readw
c_func
(paren
id|hpa
op_plus
id|PCI_STATUS
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_amp
id|PCI_STATUS_CAP_LIST
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|pos
op_assign
id|readb
c_func
(paren
id|hpa
op_plus
id|PCI_CAPABILITY_LIST
)paren
suffix:semicolon
r_while
c_loop
(paren
id|ttl
op_decrement
op_logical_and
id|pos
op_ge
l_int|0x40
)paren
(brace
id|pos
op_and_assign
op_complement
l_int|3
suffix:semicolon
id|id
op_assign
id|readb
c_func
(paren
id|hpa
op_plus
id|pos
op_plus
id|PCI_CAP_LIST_ID
)paren
suffix:semicolon
r_if
c_cond
(paren
id|id
op_eq
l_int|0xff
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|id
op_eq
id|cap
)paren
r_return
id|pos
suffix:semicolon
id|pos
op_assign
id|readb
c_func
(paren
id|hpa
op_plus
id|pos
op_plus
id|PCI_CAP_LIST_NEXT
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
id|__init
DECL|function|hp_zx1_lba_init
id|hp_zx1_lba_init
(paren
id|u64
id|hpa
)paren
(brace
r_struct
id|_hp_private
op_star
id|hp
op_assign
op_amp
id|hp_private
suffix:semicolon
r_int
id|cap
suffix:semicolon
id|hp-&gt;lba_regs
op_assign
id|ioremap
c_func
(paren
id|hpa
comma
l_int|256
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hp-&gt;lba_regs
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|hp-&gt;lba_cap_offset
op_assign
id|hp_zx1_lba_find_capability
c_func
(paren
id|hp-&gt;lba_regs
comma
id|PCI_CAP_ID_AGP
)paren
suffix:semicolon
id|cap
op_assign
id|readl
c_func
(paren
id|hp-&gt;lba_regs
op_plus
id|hp-&gt;lba_cap_offset
)paren
op_amp
l_int|0xff
suffix:semicolon
r_if
c_cond
(paren
id|cap
op_ne
id|PCI_CAP_ID_AGP
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;Invalid capability ID 0x%02x at 0x%x&bslash;n&quot;
comma
id|cap
comma
id|hp-&gt;lba_cap_offset
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|hp_zx1_fetch_size
id|hp_zx1_fetch_size
c_func
(paren
r_void
)paren
(brace
r_int
id|size
suffix:semicolon
id|size
op_assign
id|hp_private.gart_size
op_div
id|MB
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|hp_zx1_sizes
(braket
l_int|0
)braket
dot
id|size
op_assign
id|size
suffix:semicolon
id|agp_bridge-&gt;current_size
op_assign
(paren
r_void
op_star
)paren
op_amp
id|hp_zx1_sizes
(braket
l_int|0
)braket
suffix:semicolon
r_return
id|size
suffix:semicolon
)brace
r_static
r_int
DECL|function|hp_zx1_configure
id|hp_zx1_configure
(paren
r_void
)paren
(brace
r_struct
id|_hp_private
op_star
id|hp
op_assign
op_amp
id|hp_private
suffix:semicolon
id|agp_bridge-&gt;gart_bus_addr
op_assign
id|hp-&gt;gart_base
suffix:semicolon
id|agp_bridge-&gt;capndx
op_assign
id|hp-&gt;lba_cap_offset
suffix:semicolon
id|agp_bridge-&gt;mode
op_assign
id|readl
c_func
(paren
id|hp-&gt;lba_regs
op_plus
id|hp-&gt;lba_cap_offset
op_plus
id|PCI_AGP_STATUS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hp-&gt;io_pdir_owner
)paren
(brace
id|writel
c_func
(paren
id|virt_to_phys
c_func
(paren
id|hp-&gt;io_pdir
)paren
comma
id|hp-&gt;ioc_regs
op_plus
id|HP_ZX1_PDIR_BASE
)paren
suffix:semicolon
id|readl
c_func
(paren
id|hp-&gt;ioc_regs
op_plus
id|HP_ZX1_PDIR_BASE
)paren
suffix:semicolon
id|writel
c_func
(paren
id|hp-&gt;io_tlb_ps
comma
id|hp-&gt;ioc_regs
op_plus
id|HP_ZX1_TCNFG
)paren
suffix:semicolon
id|readl
c_func
(paren
id|hp-&gt;ioc_regs
op_plus
id|HP_ZX1_TCNFG
)paren
suffix:semicolon
id|writel
c_func
(paren
op_complement
(paren
id|HP_ZX1_IOVA_SIZE
op_minus
l_int|1
)paren
comma
id|hp-&gt;ioc_regs
op_plus
id|HP_ZX1_IMASK
)paren
suffix:semicolon
id|readl
c_func
(paren
id|hp-&gt;ioc_regs
op_plus
id|HP_ZX1_IMASK
)paren
suffix:semicolon
id|writel
c_func
(paren
id|hp-&gt;iova_base
op_or
l_int|1
comma
id|hp-&gt;ioc_regs
op_plus
id|HP_ZX1_IBASE
)paren
suffix:semicolon
id|readl
c_func
(paren
id|hp-&gt;ioc_regs
op_plus
id|HP_ZX1_IBASE
)paren
suffix:semicolon
id|writel
c_func
(paren
id|hp-&gt;iova_base
op_or
id|log2
c_func
(paren
id|HP_ZX1_IOVA_SIZE
)paren
comma
id|hp-&gt;ioc_regs
op_plus
id|HP_ZX1_PCOM
)paren
suffix:semicolon
id|readl
c_func
(paren
id|hp-&gt;ioc_regs
op_plus
id|HP_ZX1_PCOM
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|hp_zx1_cleanup
id|hp_zx1_cleanup
(paren
r_void
)paren
(brace
r_struct
id|_hp_private
op_star
id|hp
op_assign
op_amp
id|hp_private
suffix:semicolon
r_if
c_cond
(paren
id|hp-&gt;ioc_regs
)paren
(brace
r_if
c_cond
(paren
id|hp-&gt;io_pdir_owner
)paren
(brace
id|writeq
c_func
(paren
l_int|0
comma
id|hp-&gt;ioc_regs
op_plus
id|HP_ZX1_IBASE
)paren
suffix:semicolon
id|readq
c_func
(paren
id|hp-&gt;ioc_regs
op_plus
id|HP_ZX1_IBASE
)paren
suffix:semicolon
)brace
id|iounmap
c_func
(paren
id|hp-&gt;ioc_regs
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hp-&gt;lba_regs
)paren
id|iounmap
c_func
(paren
id|hp-&gt;lba_regs
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|hp_zx1_tlbflush
id|hp_zx1_tlbflush
(paren
r_struct
id|agp_memory
op_star
id|mem
)paren
(brace
r_struct
id|_hp_private
op_star
id|hp
op_assign
op_amp
id|hp_private
suffix:semicolon
id|writeq
c_func
(paren
id|hp-&gt;gart_base
op_or
id|log2
c_func
(paren
id|hp-&gt;gart_size
)paren
comma
id|hp-&gt;ioc_regs
op_plus
id|HP_ZX1_PCOM
)paren
suffix:semicolon
id|readq
c_func
(paren
id|hp-&gt;ioc_regs
op_plus
id|HP_ZX1_PCOM
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|hp_zx1_create_gatt_table
id|hp_zx1_create_gatt_table
(paren
r_struct
id|agp_bridge_data
op_star
id|bridge
)paren
(brace
r_struct
id|_hp_private
op_star
id|hp
op_assign
op_amp
id|hp_private
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|hp-&gt;io_pdir_owner
)paren
(brace
id|hp-&gt;io_pdir
op_assign
(paren
id|u64
op_star
)paren
id|__get_free_pages
c_func
(paren
id|GFP_KERNEL
comma
id|get_order
c_func
(paren
id|hp-&gt;io_pdir_size
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hp-&gt;io_pdir
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;Couldn&squot;t allocate contiguous &quot;
l_string|&quot;memory for I/O PDIR&bslash;n&quot;
)paren
suffix:semicolon
id|hp-&gt;gatt
op_assign
l_int|NULL
suffix:semicolon
id|hp-&gt;gatt_entries
op_assign
l_int|0
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|hp-&gt;io_pdir
comma
l_int|0
comma
id|hp-&gt;io_pdir_size
)paren
suffix:semicolon
id|hp-&gt;gatt
op_assign
op_amp
id|hp-&gt;io_pdir
(braket
id|HP_ZX1_IOVA_TO_PDIR
c_func
(paren
id|hp-&gt;gart_base
)paren
)braket
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|hp-&gt;gatt_entries
suffix:semicolon
id|i
op_increment
)paren
(brace
id|hp-&gt;gatt
(braket
id|i
)braket
op_assign
(paren
r_int
r_int
)paren
id|agp_bridge-&gt;scratch_page
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|hp_zx1_free_gatt_table
id|hp_zx1_free_gatt_table
(paren
r_struct
id|agp_bridge_data
op_star
id|bridge
)paren
(brace
r_struct
id|_hp_private
op_star
id|hp
op_assign
op_amp
id|hp_private
suffix:semicolon
r_if
c_cond
(paren
id|hp-&gt;io_pdir_owner
)paren
id|free_pages
c_func
(paren
(paren
r_int
r_int
)paren
id|hp-&gt;io_pdir
comma
id|get_order
c_func
(paren
id|hp-&gt;io_pdir_size
)paren
)paren
suffix:semicolon
r_else
id|hp-&gt;gatt
(braket
l_int|0
)braket
op_assign
id|HP_ZX1_SBA_IOMMU_COOKIE
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|hp_zx1_insert_memory
id|hp_zx1_insert_memory
(paren
r_struct
id|agp_memory
op_star
id|mem
comma
id|off_t
id|pg_start
comma
r_int
id|type
)paren
(brace
r_struct
id|_hp_private
op_star
id|hp
op_assign
op_amp
id|hp_private
suffix:semicolon
r_int
id|i
comma
id|k
suffix:semicolon
id|off_t
id|j
comma
id|io_pg_start
suffix:semicolon
r_int
id|io_pg_count
suffix:semicolon
r_if
c_cond
(paren
id|type
op_ne
l_int|0
op_logical_or
id|mem-&gt;type
op_ne
l_int|0
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|io_pg_start
op_assign
id|hp-&gt;io_pages_per_kpage
op_star
id|pg_start
suffix:semicolon
id|io_pg_count
op_assign
id|hp-&gt;io_pages_per_kpage
op_star
id|mem-&gt;page_count
suffix:semicolon
r_if
c_cond
(paren
(paren
id|io_pg_start
op_plus
id|io_pg_count
)paren
OG
id|hp-&gt;gatt_entries
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|j
op_assign
id|io_pg_start
suffix:semicolon
r_while
c_loop
(paren
id|j
OL
(paren
id|io_pg_start
op_plus
id|io_pg_count
)paren
)paren
(brace
r_if
c_cond
(paren
id|hp-&gt;gatt
(braket
id|j
)braket
)paren
(brace
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|j
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mem-&gt;is_flushed
op_eq
id|FALSE
)paren
(brace
id|global_cache_flush
c_func
(paren
)paren
suffix:semicolon
id|mem-&gt;is_flushed
op_assign
id|TRUE
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|j
op_assign
id|io_pg_start
suffix:semicolon
id|i
OL
id|mem-&gt;page_count
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
r_int
id|paddr
suffix:semicolon
id|paddr
op_assign
id|mem-&gt;memory
(braket
id|i
)braket
suffix:semicolon
r_for
c_loop
(paren
id|k
op_assign
l_int|0
suffix:semicolon
id|k
OL
id|hp-&gt;io_pages_per_kpage
suffix:semicolon
id|k
op_increment
comma
id|j
op_increment
comma
id|paddr
op_add_assign
id|hp-&gt;io_page_size
)paren
(brace
id|hp-&gt;gatt
(braket
id|j
)braket
op_assign
id|agp_bridge-&gt;driver
op_member_access_from_pointer
id|mask_memory
c_func
(paren
id|agp_bridge
comma
id|paddr
comma
id|type
)paren
suffix:semicolon
)brace
)brace
id|agp_bridge-&gt;driver
op_member_access_from_pointer
id|tlb_flush
c_func
(paren
id|mem
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|hp_zx1_remove_memory
id|hp_zx1_remove_memory
(paren
r_struct
id|agp_memory
op_star
id|mem
comma
id|off_t
id|pg_start
comma
r_int
id|type
)paren
(brace
r_struct
id|_hp_private
op_star
id|hp
op_assign
op_amp
id|hp_private
suffix:semicolon
r_int
id|i
comma
id|io_pg_start
comma
id|io_pg_count
suffix:semicolon
r_if
c_cond
(paren
id|type
op_ne
l_int|0
op_logical_or
id|mem-&gt;type
op_ne
l_int|0
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|io_pg_start
op_assign
id|hp-&gt;io_pages_per_kpage
op_star
id|pg_start
suffix:semicolon
id|io_pg_count
op_assign
id|hp-&gt;io_pages_per_kpage
op_star
id|mem-&gt;page_count
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|io_pg_start
suffix:semicolon
id|i
OL
id|io_pg_count
op_plus
id|io_pg_start
suffix:semicolon
id|i
op_increment
)paren
(brace
id|hp-&gt;gatt
(braket
id|i
)braket
op_assign
id|agp_bridge-&gt;scratch_page
suffix:semicolon
)brace
id|agp_bridge-&gt;driver
op_member_access_from_pointer
id|tlb_flush
c_func
(paren
id|mem
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
r_int
DECL|function|hp_zx1_mask_memory
id|hp_zx1_mask_memory
(paren
r_struct
id|agp_bridge_data
op_star
id|bridge
comma
r_int
r_int
id|addr
comma
r_int
id|type
)paren
(brace
r_return
id|HP_ZX1_PDIR_VALID_BIT
op_or
id|addr
suffix:semicolon
)brace
r_static
r_void
DECL|function|hp_zx1_enable
id|hp_zx1_enable
(paren
r_struct
id|agp_bridge_data
op_star
id|bridge
comma
id|u32
id|mode
)paren
(brace
r_struct
id|_hp_private
op_star
id|hp
op_assign
op_amp
id|hp_private
suffix:semicolon
id|u32
id|command
suffix:semicolon
id|command
op_assign
id|readl
c_func
(paren
id|hp-&gt;lba_regs
op_plus
id|hp-&gt;lba_cap_offset
op_plus
id|PCI_AGP_STATUS
)paren
suffix:semicolon
id|command
op_assign
id|agp_collect_device_status
c_func
(paren
id|bridge
comma
id|mode
comma
id|command
)paren
suffix:semicolon
id|command
op_or_assign
l_int|0x00000100
suffix:semicolon
id|writel
c_func
(paren
id|command
comma
id|hp-&gt;lba_regs
op_plus
id|hp-&gt;lba_cap_offset
op_plus
id|PCI_AGP_COMMAND
)paren
suffix:semicolon
id|agp_device_command
c_func
(paren
id|command
comma
(paren
id|mode
op_amp
id|AGP8X_MODE
)paren
op_ne
l_int|0
)paren
suffix:semicolon
)brace
DECL|variable|hp_zx1_driver
r_struct
id|agp_bridge_driver
id|hp_zx1_driver
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|size_type
op_assign
id|FIXED_APER_SIZE
comma
dot
id|configure
op_assign
id|hp_zx1_configure
comma
dot
id|fetch_size
op_assign
id|hp_zx1_fetch_size
comma
dot
id|cleanup
op_assign
id|hp_zx1_cleanup
comma
dot
id|tlb_flush
op_assign
id|hp_zx1_tlbflush
comma
dot
id|mask_memory
op_assign
id|hp_zx1_mask_memory
comma
dot
id|masks
op_assign
id|hp_zx1_masks
comma
dot
id|agp_enable
op_assign
id|hp_zx1_enable
comma
dot
id|cache_flush
op_assign
id|global_cache_flush
comma
dot
id|create_gatt_table
op_assign
id|hp_zx1_create_gatt_table
comma
dot
id|free_gatt_table
op_assign
id|hp_zx1_free_gatt_table
comma
dot
id|insert_memory
op_assign
id|hp_zx1_insert_memory
comma
dot
id|remove_memory
op_assign
id|hp_zx1_remove_memory
comma
dot
id|alloc_by_type
op_assign
id|agp_generic_alloc_by_type
comma
dot
id|free_by_type
op_assign
id|agp_generic_free_by_type
comma
dot
id|agp_alloc_page
op_assign
id|agp_generic_alloc_page
comma
dot
id|agp_destroy_page
op_assign
id|agp_generic_destroy_page
comma
dot
id|cant_use_aperture
op_assign
l_int|1
comma
)brace
suffix:semicolon
r_static
r_int
id|__init
DECL|function|hp_zx1_setup
id|hp_zx1_setup
(paren
id|u64
id|ioc_hpa
comma
id|u64
id|lba_hpa
)paren
(brace
r_struct
id|agp_bridge_data
op_star
id|bridge
suffix:semicolon
r_int
id|error
op_assign
l_int|0
suffix:semicolon
id|error
op_assign
id|hp_zx1_ioc_init
c_func
(paren
id|ioc_hpa
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_goto
id|fail
suffix:semicolon
id|error
op_assign
id|hp_zx1_lba_init
c_func
(paren
id|lba_hpa
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_goto
id|fail
suffix:semicolon
id|bridge
op_assign
id|agp_alloc_bridge
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bridge
)paren
(brace
id|error
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|fail
suffix:semicolon
)brace
id|bridge-&gt;driver
op_assign
op_amp
id|hp_zx1_driver
suffix:semicolon
id|fake_bridge_dev.vendor
op_assign
id|PCI_VENDOR_ID_HP
suffix:semicolon
id|fake_bridge_dev.device
op_assign
id|PCI_DEVICE_ID_HP_PCIX_LBA
suffix:semicolon
id|bridge-&gt;dev
op_assign
op_amp
id|fake_bridge_dev
suffix:semicolon
id|error
op_assign
id|agp_add_bridge
c_func
(paren
id|bridge
)paren
suffix:semicolon
id|fail
suffix:colon
r_if
c_cond
(paren
id|error
)paren
id|hp_zx1_cleanup
c_func
(paren
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
r_static
id|acpi_status
id|__init
DECL|function|zx1_gart_probe
id|zx1_gart_probe
(paren
id|acpi_handle
id|obj
comma
id|u32
id|depth
comma
r_void
op_star
id|context
comma
r_void
op_star
op_star
id|ret
)paren
(brace
id|acpi_handle
id|handle
comma
id|parent
suffix:semicolon
id|acpi_status
id|status
suffix:semicolon
r_struct
id|acpi_buffer
id|buffer
suffix:semicolon
r_struct
id|acpi_device_info
op_star
id|info
suffix:semicolon
id|u64
id|lba_hpa
comma
id|sba_hpa
comma
id|length
suffix:semicolon
r_int
id|match
suffix:semicolon
id|status
op_assign
id|hp_acpi_csr_space
c_func
(paren
id|obj
comma
op_amp
id|lba_hpa
comma
op_amp
id|length
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_FAILURE
c_func
(paren
id|status
)paren
)paren
r_return
id|AE_OK
suffix:semicolon
multiline_comment|/* keep looking for another bridge */
multiline_comment|/* Look for an enclosing IOC scope and find its CSR space */
id|handle
op_assign
id|obj
suffix:semicolon
r_do
(brace
id|buffer.length
op_assign
id|ACPI_ALLOCATE_LOCAL_BUFFER
suffix:semicolon
id|status
op_assign
id|acpi_get_object_info
c_func
(paren
id|handle
comma
op_amp
id|buffer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_SUCCESS
c_func
(paren
id|status
)paren
)paren
(brace
multiline_comment|/* TBD check _CID also */
id|info
op_assign
id|buffer.pointer
suffix:semicolon
id|info-&gt;hardware_id.value
(braket
r_sizeof
(paren
id|info-&gt;hardware_id
)paren
op_minus
l_int|1
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|match
op_assign
(paren
id|strcmp
c_func
(paren
id|info-&gt;hardware_id.value
comma
l_string|&quot;HWP0001&quot;
)paren
op_eq
l_int|0
)paren
suffix:semicolon
id|ACPI_MEM_FREE
c_func
(paren
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|match
)paren
(brace
id|status
op_assign
id|hp_acpi_csr_space
c_func
(paren
id|handle
comma
op_amp
id|sba_hpa
comma
op_amp
id|length
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ACPI_SUCCESS
c_func
(paren
id|status
)paren
)paren
r_break
suffix:semicolon
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;Detected HP ZX1 &quot;
l_string|&quot;AGP LBA but no IOC.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|AE_OK
suffix:semicolon
)brace
)brace
)brace
id|status
op_assign
id|acpi_get_parent
c_func
(paren
id|handle
comma
op_amp
id|parent
)paren
suffix:semicolon
id|handle
op_assign
id|parent
suffix:semicolon
)brace
r_while
c_loop
(paren
id|ACPI_SUCCESS
c_func
(paren
id|status
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hp_zx1_setup
c_func
(paren
id|sba_hpa
op_plus
id|HP_ZX1_IOC_OFFSET
comma
id|lba_hpa
)paren
)paren
r_return
id|AE_OK
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
id|PFX
l_string|&quot;Detected HP ZX1 %s AGP chipset (ioc=%lx, lba=%lx)&bslash;n&quot;
comma
(paren
r_char
op_star
)paren
id|context
comma
id|sba_hpa
op_plus
id|HP_ZX1_IOC_OFFSET
comma
id|lba_hpa
)paren
suffix:semicolon
id|hp_zx1_gart_found
op_assign
l_int|1
suffix:semicolon
r_return
id|AE_CTRL_TERMINATE
suffix:semicolon
multiline_comment|/* we only support one bridge; quit looking */
)brace
r_static
r_int
id|__init
DECL|function|agp_hp_init
id|agp_hp_init
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|agp_off
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|acpi_get_devices
c_func
(paren
l_string|&quot;HWP0003&quot;
comma
id|zx1_gart_probe
comma
l_string|&quot;HWP0003&quot;
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hp_zx1_gart_found
)paren
r_return
l_int|0
suffix:semicolon
id|acpi_get_devices
c_func
(paren
l_string|&quot;HWP0007&quot;
comma
id|zx1_gart_probe
comma
l_string|&quot;HWP0007&quot;
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hp_zx1_gart_found
)paren
r_return
l_int|0
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_static
r_void
id|__exit
DECL|function|agp_hp_cleanup
id|agp_hp_cleanup
(paren
r_void
)paren
(brace
)brace
DECL|variable|agp_hp_init
id|module_init
c_func
(paren
id|agp_hp_init
)paren
suffix:semicolon
DECL|variable|agp_hp_cleanup
id|module_exit
c_func
(paren
id|agp_hp_cleanup
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL and additional rights&quot;
)paren
suffix:semicolon
eof
