multiline_comment|/*&n; * ipmi_poweroff.c&n; *&n; * MontaVista IPMI Poweroff extension to sys_reboot&n; *&n; * Author: MontaVista Software, Inc.&n; *         Steven Dake &lt;sdake@mvista.com&gt;&n; *         Corey Minyard &lt;cminyard@mvista.com&gt;&n; *         source@mvista.com&n; *&n; * Copyright 2002,2004 MontaVista Software Inc.&n; *&n; *  This program is free software; you can redistribute it and/or modify it&n; *  under the terms of the GNU General Public License as published by the&n; *  Free Software Foundation; either version 2 of the License, or (at your&n; *  option) any later version.&n; *&n; *&n; *  THIS SOFTWARE IS PROVIDED ``AS IS&squot;&squot; AND ANY EXPRESS OR IMPLIED&n; *  WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF&n; *  MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.&n; *  IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,&n; *  INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,&n; *  BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS&n; *  OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND&n; *  ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR&n; *  TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE&n; *  USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.&n; *&n; *  You should have received a copy of the GNU General Public License along&n; *  with this program; if not, write to the Free Software Foundation, Inc.,&n; *  675 Mass Ave, Cambridge, MA 02139, USA.&n; */
macro_line|#include &lt;asm/semaphore.h&gt;
macro_line|#include &lt;linux/kdev_t.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/ipmi.h&gt;
macro_line|#include &lt;linux/ipmi_smi.h&gt;
DECL|macro|PFX
mdefine_line|#define PFX &quot;IPMI poweroff: &quot;
DECL|macro|IPMI_POWEROFF_VERSION
mdefine_line|#define IPMI_POWEROFF_VERSION&t;&quot;v33&quot;
multiline_comment|/* Where to we insert our poweroff function? */
r_extern
r_void
(paren
op_star
id|pm_power_off
)paren
(paren
r_void
)paren
suffix:semicolon
multiline_comment|/* Stuff from the get device id command. */
DECL|variable|mfg_id
r_int
r_int
id|mfg_id
suffix:semicolon
DECL|variable|prod_id
r_int
r_int
id|prod_id
suffix:semicolon
DECL|variable|capabilities
r_int
r_char
id|capabilities
suffix:semicolon
multiline_comment|/* We use our own messages for this operation, we don&squot;t let the system&n;   allocate them, since we may be in a panic situation.  The whole&n;   thing is single-threaded, anyway, so multiple messages are not&n;   required. */
DECL|function|dummy_smi_free
r_static
r_void
id|dummy_smi_free
c_func
(paren
r_struct
id|ipmi_smi_msg
op_star
id|msg
)paren
(brace
)brace
DECL|function|dummy_recv_free
r_static
r_void
id|dummy_recv_free
c_func
(paren
r_struct
id|ipmi_recv_msg
op_star
id|msg
)paren
(brace
)brace
DECL|variable|halt_smi_msg
r_static
r_struct
id|ipmi_smi_msg
id|halt_smi_msg
op_assign
(brace
dot
id|done
op_assign
id|dummy_smi_free
)brace
suffix:semicolon
DECL|variable|halt_recv_msg
r_static
r_struct
id|ipmi_recv_msg
id|halt_recv_msg
op_assign
(brace
dot
id|done
op_assign
id|dummy_recv_free
)brace
suffix:semicolon
multiline_comment|/*&n; * Code to send a message and wait for the reponse.&n; */
DECL|function|receive_handler
r_static
r_void
id|receive_handler
c_func
(paren
r_struct
id|ipmi_recv_msg
op_star
id|recv_msg
comma
r_void
op_star
id|handler_data
)paren
(brace
r_struct
id|semaphore
op_star
id|sem
op_assign
id|recv_msg-&gt;user_msg_data
suffix:semicolon
r_if
c_cond
(paren
id|sem
)paren
id|up
c_func
(paren
id|sem
)paren
suffix:semicolon
)brace
DECL|variable|ipmi_poweroff_handler
r_static
r_struct
id|ipmi_user_hndl
id|ipmi_poweroff_handler
op_assign
(brace
dot
id|ipmi_recv_hndl
op_assign
id|receive_handler
)brace
suffix:semicolon
DECL|function|ipmi_request_wait_for_response
r_static
r_int
id|ipmi_request_wait_for_response
c_func
(paren
id|ipmi_user_t
id|user
comma
r_struct
id|ipmi_addr
op_star
id|addr
comma
r_struct
id|kernel_ipmi_msg
op_star
id|send_msg
)paren
(brace
r_int
id|rv
suffix:semicolon
r_struct
id|semaphore
id|sem
suffix:semicolon
id|sema_init
(paren
op_amp
id|sem
comma
l_int|0
)paren
suffix:semicolon
id|rv
op_assign
id|ipmi_request_supply_msgs
c_func
(paren
id|user
comma
id|addr
comma
l_int|0
comma
id|send_msg
comma
op_amp
id|sem
comma
op_amp
id|halt_smi_msg
comma
op_amp
id|halt_recv_msg
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rv
)paren
r_return
id|rv
suffix:semicolon
id|down
(paren
op_amp
id|sem
)paren
suffix:semicolon
r_return
id|halt_recv_msg.msg.data
(braket
l_int|0
)braket
suffix:semicolon
)brace
multiline_comment|/* We are in run-to-completion mode, no semaphore is desired. */
DECL|function|ipmi_request_in_rc_mode
r_static
r_int
id|ipmi_request_in_rc_mode
c_func
(paren
id|ipmi_user_t
id|user
comma
r_struct
id|ipmi_addr
op_star
id|addr
comma
r_struct
id|kernel_ipmi_msg
op_star
id|send_msg
)paren
(brace
r_int
id|rv
suffix:semicolon
id|rv
op_assign
id|ipmi_request_supply_msgs
c_func
(paren
id|user
comma
id|addr
comma
l_int|0
comma
id|send_msg
comma
l_int|NULL
comma
op_amp
id|halt_smi_msg
comma
op_amp
id|halt_recv_msg
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rv
)paren
r_return
id|rv
suffix:semicolon
r_return
id|halt_recv_msg.msg.data
(braket
l_int|0
)braket
suffix:semicolon
)brace
multiline_comment|/*&n; * ATCA Support&n; */
DECL|macro|IPMI_NETFN_ATCA
mdefine_line|#define IPMI_NETFN_ATCA&t;&t;&t;0x2c
DECL|macro|IPMI_ATCA_SET_POWER_CMD
mdefine_line|#define IPMI_ATCA_SET_POWER_CMD&t;&t;0x11
DECL|macro|IPMI_ATCA_GET_ADDR_INFO_CMD
mdefine_line|#define IPMI_ATCA_GET_ADDR_INFO_CMD&t;0x01
DECL|macro|IPMI_PICMG_ID
mdefine_line|#define IPMI_PICMG_ID&t;&t;&t;0
DECL|function|ipmi_atca_detect
r_static
r_int
id|ipmi_atca_detect
(paren
id|ipmi_user_t
id|user
)paren
(brace
r_struct
id|ipmi_system_interface_addr
id|smi_addr
suffix:semicolon
r_struct
id|kernel_ipmi_msg
id|send_msg
suffix:semicolon
r_int
id|rv
suffix:semicolon
r_int
r_char
id|data
(braket
l_int|1
)braket
suffix:semicolon
multiline_comment|/*&n;         * Configure IPMI address for local access&n;         */
id|smi_addr.addr_type
op_assign
id|IPMI_SYSTEM_INTERFACE_ADDR_TYPE
suffix:semicolon
id|smi_addr.channel
op_assign
id|IPMI_BMC_CHANNEL
suffix:semicolon
id|smi_addr.lun
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; * Use get address info to check and see if we are ATCA&n;&t; */
id|send_msg.netfn
op_assign
id|IPMI_NETFN_ATCA
suffix:semicolon
id|send_msg.cmd
op_assign
id|IPMI_ATCA_GET_ADDR_INFO_CMD
suffix:semicolon
id|data
(braket
l_int|0
)braket
op_assign
id|IPMI_PICMG_ID
suffix:semicolon
id|send_msg.data
op_assign
id|data
suffix:semicolon
id|send_msg.data_len
op_assign
r_sizeof
(paren
id|data
)paren
suffix:semicolon
id|rv
op_assign
id|ipmi_request_wait_for_response
c_func
(paren
id|user
comma
(paren
r_struct
id|ipmi_addr
op_star
)paren
op_amp
id|smi_addr
comma
op_amp
id|send_msg
)paren
suffix:semicolon
r_return
op_logical_neg
id|rv
suffix:semicolon
)brace
DECL|function|ipmi_poweroff_atca
r_static
r_void
id|ipmi_poweroff_atca
(paren
id|ipmi_user_t
id|user
)paren
(brace
r_struct
id|ipmi_system_interface_addr
id|smi_addr
suffix:semicolon
r_struct
id|kernel_ipmi_msg
id|send_msg
suffix:semicolon
r_int
id|rv
suffix:semicolon
r_int
r_char
id|data
(braket
l_int|4
)braket
suffix:semicolon
multiline_comment|/*&n;         * Configure IPMI address for local access&n;         */
id|smi_addr.addr_type
op_assign
id|IPMI_SYSTEM_INTERFACE_ADDR_TYPE
suffix:semicolon
id|smi_addr.channel
op_assign
id|IPMI_BMC_CHANNEL
suffix:semicolon
id|smi_addr.lun
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
id|PFX
l_string|&quot;Powering down via ATCA power command&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Power down&n;&t; */
id|send_msg.netfn
op_assign
id|IPMI_NETFN_ATCA
suffix:semicolon
id|send_msg.cmd
op_assign
id|IPMI_ATCA_SET_POWER_CMD
suffix:semicolon
id|data
(braket
l_int|0
)braket
op_assign
id|IPMI_PICMG_ID
suffix:semicolon
id|data
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* FRU id */
id|data
(braket
l_int|2
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Power Level */
id|data
(braket
l_int|3
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Don&squot;t change saved presets */
id|send_msg.data
op_assign
id|data
suffix:semicolon
id|send_msg.data_len
op_assign
r_sizeof
(paren
id|data
)paren
suffix:semicolon
id|rv
op_assign
id|ipmi_request_in_rc_mode
c_func
(paren
id|user
comma
(paren
r_struct
id|ipmi_addr
op_star
)paren
op_amp
id|smi_addr
comma
op_amp
id|send_msg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rv
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;Unable to send ATCA powerdown message,&quot;
l_string|&quot; IPMI error 0x%x&bslash;n&quot;
comma
id|rv
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|out
suffix:colon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * CPI1 Support&n; */
DECL|macro|IPMI_NETFN_OEM_1
mdefine_line|#define IPMI_NETFN_OEM_1&t;&t;&t;&t;0xf8
DECL|macro|OEM_GRP_CMD_SET_RESET_STATE
mdefine_line|#define OEM_GRP_CMD_SET_RESET_STATE&t;&t;0x84
DECL|macro|OEM_GRP_CMD_SET_POWER_STATE
mdefine_line|#define OEM_GRP_CMD_SET_POWER_STATE&t;&t;0x82
DECL|macro|IPMI_NETFN_OEM_8
mdefine_line|#define IPMI_NETFN_OEM_8&t;&t;&t;&t;0xf8
DECL|macro|OEM_GRP_CMD_REQUEST_HOTSWAP_CTRL
mdefine_line|#define OEM_GRP_CMD_REQUEST_HOTSWAP_CTRL&t;0x80
DECL|macro|OEM_GRP_CMD_GET_SLOT_GA
mdefine_line|#define OEM_GRP_CMD_GET_SLOT_GA&t;&t;&t;0xa3
DECL|macro|IPMI_NETFN_SENSOR_EVT
mdefine_line|#define IPMI_NETFN_SENSOR_EVT&t;&t;&t;0x10
DECL|macro|IPMI_CMD_GET_EVENT_RECEIVER
mdefine_line|#define IPMI_CMD_GET_EVENT_RECEIVER&t;&t;0x01
DECL|macro|IPMI_CPI1_PRODUCT_ID
mdefine_line|#define IPMI_CPI1_PRODUCT_ID&t;&t;0x000157
DECL|macro|IPMI_CPI1_MANUFACTURER_ID
mdefine_line|#define IPMI_CPI1_MANUFACTURER_ID&t;0x0108
DECL|function|ipmi_cpi1_detect
r_static
r_int
id|ipmi_cpi1_detect
(paren
id|ipmi_user_t
id|user
)paren
(brace
r_return
(paren
(paren
id|mfg_id
op_eq
id|IPMI_CPI1_MANUFACTURER_ID
)paren
op_logical_and
(paren
id|prod_id
op_eq
id|IPMI_CPI1_PRODUCT_ID
)paren
)paren
suffix:semicolon
)brace
DECL|function|ipmi_poweroff_cpi1
r_static
r_void
id|ipmi_poweroff_cpi1
(paren
id|ipmi_user_t
id|user
)paren
(brace
r_struct
id|ipmi_system_interface_addr
id|smi_addr
suffix:semicolon
r_struct
id|ipmi_ipmb_addr
id|ipmb_addr
suffix:semicolon
r_struct
id|kernel_ipmi_msg
id|send_msg
suffix:semicolon
r_int
id|rv
suffix:semicolon
r_int
r_char
id|data
(braket
l_int|1
)braket
suffix:semicolon
r_int
id|slot
suffix:semicolon
r_int
r_char
id|hotswap_ipmb
suffix:semicolon
r_int
r_char
id|aer_addr
suffix:semicolon
r_int
r_char
id|aer_lun
suffix:semicolon
multiline_comment|/*&n;         * Configure IPMI address for local access&n;         */
id|smi_addr.addr_type
op_assign
id|IPMI_SYSTEM_INTERFACE_ADDR_TYPE
suffix:semicolon
id|smi_addr.channel
op_assign
id|IPMI_BMC_CHANNEL
suffix:semicolon
id|smi_addr.lun
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
id|PFX
l_string|&quot;Powering down via CPI1 power command&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Get IPMI ipmb address&n;&t; */
id|send_msg.netfn
op_assign
id|IPMI_NETFN_OEM_8
op_rshift
l_int|2
suffix:semicolon
id|send_msg.cmd
op_assign
id|OEM_GRP_CMD_GET_SLOT_GA
suffix:semicolon
id|send_msg.data
op_assign
l_int|NULL
suffix:semicolon
id|send_msg.data_len
op_assign
l_int|0
suffix:semicolon
id|rv
op_assign
id|ipmi_request_in_rc_mode
c_func
(paren
id|user
comma
(paren
r_struct
id|ipmi_addr
op_star
)paren
op_amp
id|smi_addr
comma
op_amp
id|send_msg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rv
)paren
r_goto
id|out
suffix:semicolon
id|slot
op_assign
id|halt_recv_msg.msg.data
(braket
l_int|1
)braket
suffix:semicolon
id|hotswap_ipmb
op_assign
(paren
id|slot
OG
l_int|9
)paren
ques
c_cond
(paren
l_int|0xb0
op_plus
l_int|2
op_star
id|slot
)paren
suffix:colon
(paren
l_int|0xae
op_plus
l_int|2
op_star
id|slot
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Get active event receiver&n;&t; */
id|send_msg.netfn
op_assign
id|IPMI_NETFN_SENSOR_EVT
op_rshift
l_int|2
suffix:semicolon
id|send_msg.cmd
op_assign
id|IPMI_CMD_GET_EVENT_RECEIVER
suffix:semicolon
id|send_msg.data
op_assign
l_int|NULL
suffix:semicolon
id|send_msg.data_len
op_assign
l_int|0
suffix:semicolon
id|rv
op_assign
id|ipmi_request_in_rc_mode
c_func
(paren
id|user
comma
(paren
r_struct
id|ipmi_addr
op_star
)paren
op_amp
id|smi_addr
comma
op_amp
id|send_msg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rv
)paren
r_goto
id|out
suffix:semicolon
id|aer_addr
op_assign
id|halt_recv_msg.msg.data
(braket
l_int|1
)braket
suffix:semicolon
id|aer_lun
op_assign
id|halt_recv_msg.msg.data
(braket
l_int|2
)braket
suffix:semicolon
multiline_comment|/*&n;&t; * Setup IPMB address target instead of local target&n;&t; */
id|ipmb_addr.addr_type
op_assign
id|IPMI_IPMB_ADDR_TYPE
suffix:semicolon
id|ipmb_addr.channel
op_assign
l_int|0
suffix:semicolon
id|ipmb_addr.slave_addr
op_assign
id|aer_addr
suffix:semicolon
id|ipmb_addr.lun
op_assign
id|aer_lun
suffix:semicolon
multiline_comment|/*&n;&t; * Send request hotswap control to remove blade from dpv&n;&t; */
id|send_msg.netfn
op_assign
id|IPMI_NETFN_OEM_8
op_rshift
l_int|2
suffix:semicolon
id|send_msg.cmd
op_assign
id|OEM_GRP_CMD_REQUEST_HOTSWAP_CTRL
suffix:semicolon
id|send_msg.data
op_assign
op_amp
id|hotswap_ipmb
suffix:semicolon
id|send_msg.data_len
op_assign
l_int|1
suffix:semicolon
id|ipmi_request_in_rc_mode
c_func
(paren
id|user
comma
(paren
r_struct
id|ipmi_addr
op_star
)paren
op_amp
id|ipmb_addr
comma
op_amp
id|send_msg
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Set reset asserted&n;&t; */
id|send_msg.netfn
op_assign
id|IPMI_NETFN_OEM_1
op_rshift
l_int|2
suffix:semicolon
id|send_msg.cmd
op_assign
id|OEM_GRP_CMD_SET_RESET_STATE
suffix:semicolon
id|send_msg.data
op_assign
id|data
suffix:semicolon
id|data
(braket
l_int|0
)braket
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Reset asserted state */
id|send_msg.data_len
op_assign
l_int|1
suffix:semicolon
id|rv
op_assign
id|ipmi_request_in_rc_mode
c_func
(paren
id|user
comma
(paren
r_struct
id|ipmi_addr
op_star
)paren
op_amp
id|smi_addr
comma
op_amp
id|send_msg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rv
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/*&n;&t; * Power down&n;&t; */
id|send_msg.netfn
op_assign
id|IPMI_NETFN_OEM_1
op_rshift
l_int|2
suffix:semicolon
id|send_msg.cmd
op_assign
id|OEM_GRP_CMD_SET_POWER_STATE
suffix:semicolon
id|send_msg.data
op_assign
id|data
suffix:semicolon
id|data
(braket
l_int|0
)braket
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Power down state */
id|send_msg.data_len
op_assign
l_int|1
suffix:semicolon
id|rv
op_assign
id|ipmi_request_in_rc_mode
c_func
(paren
id|user
comma
(paren
r_struct
id|ipmi_addr
op_star
)paren
op_amp
id|smi_addr
comma
op_amp
id|send_msg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rv
)paren
r_goto
id|out
suffix:semicolon
id|out
suffix:colon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n; * Standard chassis support&n; */
DECL|macro|IPMI_NETFN_CHASSIS_REQUEST
mdefine_line|#define IPMI_NETFN_CHASSIS_REQUEST&t;0
DECL|macro|IPMI_CHASSIS_CONTROL_CMD
mdefine_line|#define IPMI_CHASSIS_CONTROL_CMD&t;0x02
DECL|function|ipmi_chassis_detect
r_static
r_int
id|ipmi_chassis_detect
(paren
id|ipmi_user_t
id|user
)paren
(brace
multiline_comment|/* Chassis support, use it. */
r_return
(paren
id|capabilities
op_amp
l_int|0x80
)paren
suffix:semicolon
)brace
DECL|function|ipmi_poweroff_chassis
r_static
r_void
id|ipmi_poweroff_chassis
(paren
id|ipmi_user_t
id|user
)paren
(brace
r_struct
id|ipmi_system_interface_addr
id|smi_addr
suffix:semicolon
r_struct
id|kernel_ipmi_msg
id|send_msg
suffix:semicolon
r_int
id|rv
suffix:semicolon
r_int
r_char
id|data
(braket
l_int|1
)braket
suffix:semicolon
multiline_comment|/*&n;         * Configure IPMI address for local access&n;         */
id|smi_addr.addr_type
op_assign
id|IPMI_SYSTEM_INTERFACE_ADDR_TYPE
suffix:semicolon
id|smi_addr.channel
op_assign
id|IPMI_BMC_CHANNEL
suffix:semicolon
id|smi_addr.lun
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
id|PFX
l_string|&quot;Powering down via IPMI chassis control command&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Power down&n;&t; */
id|send_msg.netfn
op_assign
id|IPMI_NETFN_CHASSIS_REQUEST
suffix:semicolon
id|send_msg.cmd
op_assign
id|IPMI_CHASSIS_CONTROL_CMD
suffix:semicolon
id|data
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Power down */
id|send_msg.data
op_assign
id|data
suffix:semicolon
id|send_msg.data_len
op_assign
r_sizeof
(paren
id|data
)paren
suffix:semicolon
id|rv
op_assign
id|ipmi_request_in_rc_mode
c_func
(paren
id|user
comma
(paren
r_struct
id|ipmi_addr
op_star
)paren
op_amp
id|smi_addr
comma
op_amp
id|send_msg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rv
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;Unable to send chassis powerdown message,&quot;
l_string|&quot; IPMI error 0x%x&bslash;n&quot;
comma
id|rv
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|out
suffix:colon
r_return
suffix:semicolon
)brace
multiline_comment|/* Table of possible power off functions. */
DECL|struct|poweroff_function
r_struct
id|poweroff_function
(brace
DECL|member|platform_type
r_char
op_star
id|platform_type
suffix:semicolon
DECL|member|detect
r_int
(paren
op_star
id|detect
)paren
(paren
id|ipmi_user_t
id|user
)paren
suffix:semicolon
DECL|member|poweroff_func
r_void
(paren
op_star
id|poweroff_func
)paren
(paren
id|ipmi_user_t
id|user
)paren
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|poweroff_functions
r_static
r_struct
id|poweroff_function
id|poweroff_functions
(braket
)braket
op_assign
(brace
(brace
l_string|&quot;ATCA&quot;
comma
id|ipmi_atca_detect
comma
id|ipmi_poweroff_atca
)brace
comma
(brace
l_string|&quot;CPI1&quot;
comma
id|ipmi_cpi1_detect
comma
id|ipmi_poweroff_cpi1
)brace
comma
multiline_comment|/* Chassis should generally be last, other things should override&n;&t;   it. */
(brace
l_string|&quot;chassis&quot;
comma
id|ipmi_chassis_detect
comma
id|ipmi_poweroff_chassis
)brace
comma
)brace
suffix:semicolon
DECL|macro|NUM_PO_FUNCS
mdefine_line|#define NUM_PO_FUNCS (sizeof(poweroff_functions) &bslash;&n;&t;&t;      / sizeof(struct poweroff_function))
multiline_comment|/* Our local state. */
DECL|variable|ready
r_static
r_int
id|ready
op_assign
l_int|0
suffix:semicolon
DECL|variable|ipmi_user
r_static
id|ipmi_user_t
id|ipmi_user
suffix:semicolon
DECL|variable|specific_poweroff_func
r_static
r_void
(paren
op_star
id|specific_poweroff_func
)paren
(paren
id|ipmi_user_t
id|user
)paren
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Holds the old poweroff function so we can restore it on removal. */
DECL|variable|old_poweroff_func
r_static
r_void
(paren
op_star
id|old_poweroff_func
)paren
(paren
r_void
)paren
suffix:semicolon
multiline_comment|/* Called on a powerdown request. */
DECL|function|ipmi_poweroff_function
r_static
r_void
id|ipmi_poweroff_function
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ready
)paren
r_return
suffix:semicolon
multiline_comment|/* Use run-to-completion mode, since interrupts may be off. */
id|ipmi_user_set_run_to_completion
c_func
(paren
id|ipmi_user
comma
l_int|1
)paren
suffix:semicolon
id|specific_poweroff_func
c_func
(paren
id|ipmi_user
)paren
suffix:semicolon
id|ipmi_user_set_run_to_completion
c_func
(paren
id|ipmi_user
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* Wait for an IPMI interface to be installed, the first one installed&n;   will be grabbed by this code and used to perform the powerdown. */
DECL|function|ipmi_po_new_smi
r_static
r_void
id|ipmi_po_new_smi
c_func
(paren
r_int
id|if_num
)paren
(brace
r_struct
id|ipmi_system_interface_addr
id|smi_addr
suffix:semicolon
r_struct
id|kernel_ipmi_msg
id|send_msg
suffix:semicolon
r_int
id|rv
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|ready
)paren
r_return
suffix:semicolon
id|rv
op_assign
id|ipmi_create_user
c_func
(paren
id|if_num
comma
op_amp
id|ipmi_poweroff_handler
comma
l_int|NULL
comma
op_amp
id|ipmi_user
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rv
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;could not create IPMI user, error %d&bslash;n&quot;
comma
id|rv
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/*&n;         * Do a get device ide and store some results, since this is&n;&t; * used by several functions.&n;         */
id|smi_addr.addr_type
op_assign
id|IPMI_SYSTEM_INTERFACE_ADDR_TYPE
suffix:semicolon
id|smi_addr.channel
op_assign
id|IPMI_BMC_CHANNEL
suffix:semicolon
id|smi_addr.lun
op_assign
l_int|0
suffix:semicolon
id|send_msg.netfn
op_assign
id|IPMI_NETFN_APP_REQUEST
suffix:semicolon
id|send_msg.cmd
op_assign
id|IPMI_GET_DEVICE_ID_CMD
suffix:semicolon
id|send_msg.data
op_assign
l_int|NULL
suffix:semicolon
id|send_msg.data_len
op_assign
l_int|0
suffix:semicolon
id|rv
op_assign
id|ipmi_request_wait_for_response
c_func
(paren
id|ipmi_user
comma
(paren
r_struct
id|ipmi_addr
op_star
)paren
op_amp
id|smi_addr
comma
op_amp
id|send_msg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rv
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;Unable to send IPMI get device id info,&quot;
l_string|&quot; IPMI error 0x%x&bslash;n&quot;
comma
id|rv
)paren
suffix:semicolon
r_goto
id|out_err
suffix:semicolon
)brace
r_if
c_cond
(paren
id|halt_recv_msg.msg.data_len
OL
l_int|12
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;(chassis) IPMI get device id info too,&quot;
l_string|&quot; short, was %d bytes, needed %d bytes&bslash;n&quot;
comma
id|halt_recv_msg.msg.data_len
comma
l_int|12
)paren
suffix:semicolon
r_goto
id|out_err
suffix:semicolon
)brace
id|mfg_id
op_assign
(paren
id|halt_recv_msg.msg.data
(braket
l_int|7
)braket
op_or
(paren
id|halt_recv_msg.msg.data
(braket
l_int|8
)braket
op_lshift
l_int|8
)paren
op_or
(paren
id|halt_recv_msg.msg.data
(braket
l_int|9
)braket
op_lshift
l_int|16
)paren
)paren
suffix:semicolon
id|prod_id
op_assign
(paren
id|halt_recv_msg.msg.data
(braket
l_int|10
)braket
op_or
(paren
id|halt_recv_msg.msg.data
(braket
l_int|11
)braket
op_lshift
l_int|8
)paren
)paren
suffix:semicolon
id|capabilities
op_assign
id|halt_recv_msg.msg.data
(braket
l_int|6
)braket
suffix:semicolon
multiline_comment|/* Scan for a poweroff method */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_PO_FUNCS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|poweroff_functions
(braket
id|i
)braket
dot
id|detect
c_func
(paren
id|ipmi_user
)paren
)paren
r_goto
id|found
suffix:semicolon
)brace
id|out_err
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;Unable to find a poweroff function that&quot;
l_string|&quot; will work, giving up&bslash;n&quot;
)paren
suffix:semicolon
id|ipmi_destroy_user
c_func
(paren
id|ipmi_user
)paren
suffix:semicolon
r_return
suffix:semicolon
id|found
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
id|PFX
l_string|&quot;Found a %s style poweroff function&bslash;n&quot;
comma
id|poweroff_functions
(braket
id|i
)braket
dot
id|platform_type
)paren
suffix:semicolon
id|specific_poweroff_func
op_assign
id|poweroff_functions
(braket
id|i
)braket
dot
id|poweroff_func
suffix:semicolon
id|old_poweroff_func
op_assign
id|pm_power_off
suffix:semicolon
id|pm_power_off
op_assign
id|ipmi_poweroff_function
suffix:semicolon
id|ready
op_assign
l_int|1
suffix:semicolon
)brace
DECL|function|ipmi_po_smi_gone
r_static
r_void
id|ipmi_po_smi_gone
c_func
(paren
r_int
id|if_num
)paren
(brace
multiline_comment|/* This can never be called, because once poweroff driver is&n;&t;   registered, the interface can&squot;t go away until the power&n;&t;   driver is unregistered. */
)brace
DECL|variable|smi_watcher
r_static
r_struct
id|ipmi_smi_watcher
id|smi_watcher
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|new_smi
op_assign
id|ipmi_po_new_smi
comma
dot
id|smi_gone
op_assign
id|ipmi_po_smi_gone
)brace
suffix:semicolon
multiline_comment|/*&n; * Startup and shutdown functions.&n; */
DECL|function|ipmi_poweroff_init
r_static
r_int
id|ipmi_poweroff_init
(paren
r_void
)paren
(brace
r_int
id|rv
suffix:semicolon
id|printk
(paren
l_string|&quot;Copyright (C) 2004 MontaVista Software -&quot;
l_string|&quot; IPMI Powerdown via sys_reboot version &quot;
id|IPMI_POWEROFF_VERSION
l_string|&quot;.&bslash;n&quot;
)paren
suffix:semicolon
id|rv
op_assign
id|ipmi_smi_watcher_register
c_func
(paren
op_amp
id|smi_watcher
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rv
)paren
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;Unable to register SMI watcher: %d&bslash;n&quot;
comma
id|rv
)paren
suffix:semicolon
r_return
id|rv
suffix:semicolon
)brace
macro_line|#ifdef MODULE
DECL|function|ipmi_poweroff_cleanup
r_static
id|__exit
r_void
id|ipmi_poweroff_cleanup
c_func
(paren
r_void
)paren
(brace
r_int
id|rv
suffix:semicolon
id|ipmi_smi_watcher_unregister
c_func
(paren
op_amp
id|smi_watcher
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ready
)paren
(brace
id|rv
op_assign
id|ipmi_destroy_user
c_func
(paren
id|ipmi_user
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rv
)paren
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;could not cleanup the IPMI&quot;
l_string|&quot; user: 0x%x&bslash;n&quot;
comma
id|rv
)paren
suffix:semicolon
id|pm_power_off
op_assign
id|old_poweroff_func
suffix:semicolon
)brace
)brace
DECL|variable|ipmi_poweroff_cleanup
id|module_exit
c_func
(paren
id|ipmi_poweroff_cleanup
)paren
suffix:semicolon
macro_line|#endif
DECL|variable|ipmi_poweroff_init
id|module_init
c_func
(paren
id|ipmi_poweroff_init
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
eof
