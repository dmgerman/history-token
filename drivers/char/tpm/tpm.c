multiline_comment|/*&n; * Copyright (C) 2004 IBM Corporation&n; *&n; * Authors:&n; * Leendert van Doorn &lt;leendert@watson.ibm.com&gt;&n; * Dave Safford &lt;safford@watson.ibm.com&gt;&n; * Reiner Sailer &lt;sailer@watson.ibm.com&gt;&n; * Kylene Hall &lt;kjhall@us.ibm.com&gt;&n; *&n; * Maintained by: &lt;tpmdd_devel@lists.sourceforge.net&gt;&n; *&n; * Device driver for TCG/TCPA TPM (trusted platform module).&n; * Specifications at www.trustedcomputinggroup.org&t; &n; *&n; * This program is free software; you can redistribute it and/or&n; * modify it under the terms of the GNU General Public License as&n; * published by the Free Software Foundation, version 2 of the&n; * License.&n; * &n; * Note, the TPM chip is not interrupt driven (only polling)&n; * and can have very long timeouts (minutes!). Hence the unusual&n; * calls to schedule_timeout.&n; *&n; */
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/poll.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &quot;tpm.h&quot;
DECL|macro|TPM_MINOR
mdefine_line|#define&t;TPM_MINOR&t;&t;&t;224&t;/* officially assigned */
DECL|macro|TPM_BUFSIZE
mdefine_line|#define&t;TPM_BUFSIZE&t;&t;&t;2048
multiline_comment|/* PCI configuration addresses */
DECL|macro|PCI_GEN_PMCON_1
mdefine_line|#define&t;PCI_GEN_PMCON_1&t;&t;&t;0xA0
DECL|macro|PCI_GEN1_DEC
mdefine_line|#define&t;PCI_GEN1_DEC&t;&t;&t;0xE4
DECL|macro|PCI_LPC_EN
mdefine_line|#define&t;PCI_LPC_EN&t;&t;&t;0xE6
DECL|macro|PCI_GEN2_DEC
mdefine_line|#define&t;PCI_GEN2_DEC&t;&t;&t;0xEC
r_static
id|LIST_HEAD
c_func
(paren
id|tpm_chip_list
)paren
suffix:semicolon
DECL|variable|driver_lock
r_static
id|spinlock_t
id|driver_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
DECL|variable|dev_mask
r_static
r_int
id|dev_mask
(braket
l_int|32
)braket
suffix:semicolon
DECL|function|user_reader_timeout
r_static
r_void
id|user_reader_timeout
c_func
(paren
r_int
r_int
id|ptr
)paren
(brace
r_struct
id|tpm_chip
op_star
id|chip
op_assign
(paren
r_struct
id|tpm_chip
op_star
)paren
id|ptr
suffix:semicolon
id|down
c_func
(paren
op_amp
id|chip-&gt;buffer_mutex
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|chip-&gt;data_pending
comma
l_int|0
)paren
suffix:semicolon
id|memset
c_func
(paren
id|chip-&gt;data_buffer
comma
l_int|0
comma
id|TPM_BUFSIZE
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|chip-&gt;buffer_mutex
)paren
suffix:semicolon
)brace
DECL|function|tpm_time_expired
r_void
id|tpm_time_expired
c_func
(paren
r_int
r_int
id|ptr
)paren
(brace
r_int
op_star
id|exp
op_assign
(paren
r_int
op_star
)paren
id|ptr
suffix:semicolon
op_star
id|exp
op_assign
l_int|1
suffix:semicolon
)brace
DECL|variable|tpm_time_expired
id|EXPORT_SYMBOL_GPL
c_func
(paren
id|tpm_time_expired
)paren
suffix:semicolon
multiline_comment|/*&n; * Initialize the LPC bus and enable the TPM ports&n; */
DECL|function|tpm_lpc_bus_init
r_int
id|tpm_lpc_bus_init
c_func
(paren
r_struct
id|pci_dev
op_star
id|pci_dev
comma
id|u16
id|base
)paren
(brace
id|u32
id|lpcenable
comma
id|tmp
suffix:semicolon
r_int
id|is_lpcm
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|pci_dev-&gt;vendor
)paren
(brace
r_case
id|PCI_VENDOR_ID_INTEL
suffix:colon
r_switch
c_cond
(paren
id|pci_dev-&gt;device
)paren
(brace
r_case
id|PCI_DEVICE_ID_INTEL_82801CA_12
suffix:colon
r_case
id|PCI_DEVICE_ID_INTEL_82801DB_12
suffix:colon
id|is_lpcm
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* init ICH (enable LPC) */
id|pci_read_config_dword
c_func
(paren
id|pci_dev
comma
id|PCI_GEN1_DEC
comma
op_amp
id|lpcenable
)paren
suffix:semicolon
id|lpcenable
op_or_assign
l_int|0x20000000
suffix:semicolon
id|pci_write_config_dword
c_func
(paren
id|pci_dev
comma
id|PCI_GEN1_DEC
comma
id|lpcenable
)paren
suffix:semicolon
r_if
c_cond
(paren
id|is_lpcm
)paren
(brace
id|pci_read_config_dword
c_func
(paren
id|pci_dev
comma
id|PCI_GEN1_DEC
comma
op_amp
id|lpcenable
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|lpcenable
op_amp
l_int|0x20000000
)paren
op_eq
l_int|0
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|pci_dev-&gt;dev
comma
l_string|&quot;cannot enable LPC&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
)brace
multiline_comment|/* initialize TPM registers */
id|pci_read_config_dword
c_func
(paren
id|pci_dev
comma
id|PCI_GEN2_DEC
comma
op_amp
id|tmp
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|is_lpcm
)paren
id|tmp
op_assign
(paren
id|tmp
op_amp
l_int|0xFFFF0000
)paren
op_or
(paren
id|base
op_amp
l_int|0xFFF0
)paren
suffix:semicolon
r_else
id|tmp
op_assign
(paren
id|tmp
op_amp
l_int|0xFFFF0000
)paren
op_or
(paren
id|base
op_amp
l_int|0xFFF0
)paren
op_or
l_int|0x00000001
suffix:semicolon
id|pci_write_config_dword
c_func
(paren
id|pci_dev
comma
id|PCI_GEN2_DEC
comma
id|tmp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|is_lpcm
)paren
(brace
id|pci_read_config_dword
c_func
(paren
id|pci_dev
comma
id|PCI_GEN_PMCON_1
comma
op_amp
id|tmp
)paren
suffix:semicolon
id|tmp
op_or_assign
l_int|0x00000004
suffix:semicolon
multiline_comment|/* enable CLKRUN */
id|pci_write_config_dword
c_func
(paren
id|pci_dev
comma
id|PCI_GEN_PMCON_1
comma
id|tmp
)paren
suffix:semicolon
)brace
id|tpm_write_index
c_func
(paren
l_int|0x0D
comma
l_int|0x55
)paren
suffix:semicolon
multiline_comment|/* unlock 4F */
id|tpm_write_index
c_func
(paren
l_int|0x0A
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* int disable */
id|tpm_write_index
c_func
(paren
l_int|0x08
comma
id|base
)paren
suffix:semicolon
multiline_comment|/* base addr lo */
id|tpm_write_index
c_func
(paren
l_int|0x09
comma
(paren
id|base
op_amp
l_int|0xFF00
)paren
op_rshift
l_int|8
)paren
suffix:semicolon
multiline_comment|/* base addr hi */
id|tpm_write_index
c_func
(paren
l_int|0x0D
comma
l_int|0xAA
)paren
suffix:semicolon
multiline_comment|/* lock 4F */
r_break
suffix:semicolon
r_case
id|PCI_VENDOR_ID_AMD
suffix:colon
multiline_comment|/* nothing yet */
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|tpm_lpc_bus_init
id|EXPORT_SYMBOL_GPL
c_func
(paren
id|tpm_lpc_bus_init
)paren
suffix:semicolon
multiline_comment|/*&n; * Internal kernel interface to transmit TPM commands&n; */
DECL|function|tpm_transmit
r_static
id|ssize_t
id|tpm_transmit
c_func
(paren
r_struct
id|tpm_chip
op_star
id|chip
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|bufsiz
)paren
(brace
id|ssize_t
id|len
suffix:semicolon
id|u32
id|count
suffix:semicolon
id|__be32
op_star
id|native_size
suffix:semicolon
id|native_size
op_assign
(paren
id|__force
id|__be32
op_star
)paren
(paren
id|buf
op_plus
l_int|2
)paren
suffix:semicolon
id|count
op_assign
id|be32_to_cpu
c_func
(paren
op_star
id|native_size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
op_eq
l_int|0
)paren
r_return
op_minus
id|ENODATA
suffix:semicolon
r_if
c_cond
(paren
id|count
OG
id|bufsiz
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|chip-&gt;pci_dev-&gt;dev
comma
l_string|&quot;invalid count value %x %x &bslash;n&quot;
comma
id|count
comma
id|bufsiz
)paren
suffix:semicolon
r_return
op_minus
id|E2BIG
suffix:semicolon
)brace
id|down
c_func
(paren
op_amp
id|chip-&gt;tpm_mutex
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|len
op_assign
id|chip-&gt;vendor
op_member_access_from_pointer
id|send
c_func
(paren
id|chip
comma
(paren
id|u8
op_star
)paren
id|buf
comma
id|count
)paren
)paren
OL
l_int|0
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|chip-&gt;pci_dev-&gt;dev
comma
l_string|&quot;tpm_transmit: tpm_send: error %d&bslash;n&quot;
comma
id|len
)paren
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
id|down
c_func
(paren
op_amp
id|chip-&gt;timer_manipulation_mutex
)paren
suffix:semicolon
id|chip-&gt;time_expired
op_assign
l_int|0
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|chip-&gt;device_timer
)paren
suffix:semicolon
id|chip-&gt;device_timer.function
op_assign
id|tpm_time_expired
suffix:semicolon
id|chip-&gt;device_timer.expires
op_assign
id|jiffies
op_plus
l_int|2
op_star
l_int|60
op_star
id|HZ
suffix:semicolon
id|chip-&gt;device_timer.data
op_assign
(paren
r_int
r_int
)paren
op_amp
id|chip-&gt;time_expired
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|chip-&gt;device_timer
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|chip-&gt;timer_manipulation_mutex
)paren
suffix:semicolon
r_do
(brace
id|u8
id|status
op_assign
id|inb
c_func
(paren
id|chip-&gt;vendor-&gt;base
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_amp
id|chip-&gt;vendor-&gt;req_complete_mask
)paren
op_eq
id|chip-&gt;vendor-&gt;req_complete_val
)paren
(brace
id|down
c_func
(paren
op_amp
id|chip-&gt;timer_manipulation_mutex
)paren
suffix:semicolon
id|del_singleshot_timer_sync
c_func
(paren
op_amp
id|chip-&gt;device_timer
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|chip-&gt;timer_manipulation_mutex
)paren
suffix:semicolon
r_goto
id|out_recv
suffix:semicolon
)brace
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|TPM_TIMEOUT
)paren
suffix:semicolon
id|rmb
c_func
(paren
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
op_logical_neg
id|chip-&gt;time_expired
)paren
suffix:semicolon
id|chip-&gt;vendor
op_member_access_from_pointer
id|cancel
c_func
(paren
id|chip
)paren
suffix:semicolon
id|dev_err
c_func
(paren
op_amp
id|chip-&gt;pci_dev-&gt;dev
comma
l_string|&quot;Time expired&bslash;n&quot;
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|chip-&gt;tpm_mutex
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
id|out_recv
suffix:colon
id|len
op_assign
id|chip-&gt;vendor
op_member_access_from_pointer
id|recv
c_func
(paren
id|chip
comma
(paren
id|u8
op_star
)paren
id|buf
comma
id|bufsiz
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
l_int|0
)paren
id|dev_err
c_func
(paren
op_amp
id|chip-&gt;pci_dev-&gt;dev
comma
l_string|&quot;tpm_transmit: tpm_recv: error %d&bslash;n&quot;
comma
id|len
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|chip-&gt;tpm_mutex
)paren
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
DECL|macro|TPM_DIGEST_SIZE
mdefine_line|#define TPM_DIGEST_SIZE 20
DECL|macro|CAP_PCR_RESULT_SIZE
mdefine_line|#define CAP_PCR_RESULT_SIZE 18
DECL|variable|cap_pcr
r_static
id|u8
id|cap_pcr
(braket
)braket
op_assign
(brace
l_int|0
comma
l_int|193
comma
multiline_comment|/* TPM_TAG_RQU_COMMAND */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|22
comma
multiline_comment|/* length */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|101
comma
multiline_comment|/* TPM_ORD_GetCapability */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|5
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|4
comma
l_int|0
comma
l_int|0
comma
l_int|1
comma
l_int|1
)brace
suffix:semicolon
DECL|macro|READ_PCR_RESULT_SIZE
mdefine_line|#define READ_PCR_RESULT_SIZE 30
DECL|variable|pcrread
r_static
id|u8
id|pcrread
(braket
)braket
op_assign
(brace
l_int|0
comma
l_int|193
comma
multiline_comment|/* TPM_TAG_RQU_COMMAND */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|14
comma
multiline_comment|/* length */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|21
comma
multiline_comment|/* TPM_ORD_PcrRead */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
multiline_comment|/* PCR index */
)brace
suffix:semicolon
DECL|function|show_pcrs
r_static
id|ssize_t
id|show_pcrs
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
)paren
(brace
id|u8
id|data
(braket
id|READ_PCR_RESULT_SIZE
)braket
suffix:semicolon
id|ssize_t
id|len
suffix:semicolon
r_int
id|i
comma
id|j
comma
id|index
comma
id|num_pcrs
suffix:semicolon
r_char
op_star
id|str
op_assign
id|buf
suffix:semicolon
r_struct
id|tpm_chp
op_star
id|chip
op_assign
id|pci_get_drvdata
c_func
(paren
id|container_of
c_func
(paren
id|dev
comma
r_struct
id|pci_dev
comma
id|dev
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chip
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|memcpy
c_func
(paren
id|data
comma
id|cap_pcr
comma
r_sizeof
(paren
id|cap_pcr
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|len
op_assign
id|tpm_transmit
c_func
(paren
id|chip
comma
id|data
comma
r_sizeof
(paren
id|data
)paren
)paren
)paren
OL
id|CAP_PCR_RESULT_SIZE
)paren
r_return
id|len
suffix:semicolon
id|num_pcrs
op_assign
id|be32_to_cpu
c_func
(paren
op_star
(paren
(paren
id|__force
id|__be32
op_star
)paren
(paren
id|data
op_plus
l_int|14
)paren
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_pcrs
suffix:semicolon
id|i
op_increment
)paren
(brace
id|memcpy
c_func
(paren
id|data
comma
id|pcrread
comma
r_sizeof
(paren
id|pcrread
)paren
)paren
suffix:semicolon
id|index
op_assign
id|cpu_to_be32
c_func
(paren
id|i
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|data
op_plus
l_int|10
comma
op_amp
id|index
comma
l_int|4
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|len
op_assign
id|tpm_transmit
c_func
(paren
id|chip
comma
id|data
comma
r_sizeof
(paren
id|data
)paren
)paren
)paren
OL
id|READ_PCR_RESULT_SIZE
)paren
r_return
id|len
suffix:semicolon
id|str
op_add_assign
id|sprintf
c_func
(paren
id|str
comma
l_string|&quot;PCR-%02d: &quot;
comma
id|i
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|TPM_DIGEST_SIZE
suffix:semicolon
id|j
op_increment
)paren
id|str
op_add_assign
id|sprintf
c_func
(paren
id|str
comma
l_string|&quot;%02X &quot;
comma
op_star
(paren
id|data
op_plus
l_int|10
op_plus
id|j
)paren
)paren
suffix:semicolon
id|str
op_add_assign
id|sprintf
c_func
(paren
id|str
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_return
id|str
op_minus
id|buf
suffix:semicolon
)brace
r_static
id|DEVICE_ATTR
c_func
(paren
id|pcrs
comma
id|S_IRUGO
comma
id|show_pcrs
comma
l_int|NULL
)paren
suffix:semicolon
DECL|macro|READ_PUBEK_RESULT_SIZE
mdefine_line|#define  READ_PUBEK_RESULT_SIZE 314
DECL|variable|readpubek
r_static
id|u8
id|readpubek
(braket
)braket
op_assign
(brace
l_int|0
comma
l_int|193
comma
multiline_comment|/* TPM_TAG_RQU_COMMAND */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|30
comma
multiline_comment|/* length */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|124
comma
multiline_comment|/* TPM_ORD_ReadPubek */
)brace
suffix:semicolon
DECL|function|show_pubek
r_static
id|ssize_t
id|show_pubek
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
)paren
(brace
id|u8
id|data
(braket
id|READ_PUBEK_RESULT_SIZE
)braket
suffix:semicolon
id|ssize_t
id|len
suffix:semicolon
id|__be32
op_star
id|native_val
suffix:semicolon
r_int
id|i
suffix:semicolon
r_char
op_star
id|str
op_assign
id|buf
suffix:semicolon
r_struct
id|tpm_chip
op_star
id|chip
op_assign
id|pci_get_drvdata
c_func
(paren
id|container_of
c_func
(paren
id|dev
comma
r_struct
id|pci_dev
comma
id|dev
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chip
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|memcpy
c_func
(paren
id|data
comma
id|readpubek
comma
r_sizeof
(paren
id|readpubek
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
id|data
op_plus
r_sizeof
(paren
id|readpubek
)paren
comma
l_int|0
comma
l_int|20
)paren
suffix:semicolon
multiline_comment|/* zero nonce */
r_if
c_cond
(paren
(paren
id|len
op_assign
id|tpm_transmit
c_func
(paren
id|chip
comma
id|data
comma
r_sizeof
(paren
id|data
)paren
)paren
)paren
OL
id|READ_PUBEK_RESULT_SIZE
)paren
r_return
id|len
suffix:semicolon
multiline_comment|/* &n;&t;   ignore header 10 bytes&n;&t;   algorithm 32 bits (1 == RSA )&n;&t;   encscheme 16 bits&n;&t;   sigscheme 16 bits&n;&t;   parameters (RSA 12-&gt;bytes: keybit, #primes, expbit)  &n;&t;   keylenbytes 32 bits&n;&t;   256 byte modulus&n;&t;   ignore checksum 20 bytes&n;&t; */
id|native_val
op_assign
(paren
id|__force
id|__be32
op_star
)paren
(paren
id|data
op_plus
l_int|34
)paren
suffix:semicolon
id|str
op_add_assign
id|sprintf
c_func
(paren
id|str
comma
l_string|&quot;Algorithm: %02X %02X %02X %02X&bslash;nEncscheme: %02X %02X&bslash;n&quot;
l_string|&quot;Sigscheme: %02X %02X&bslash;nParameters: %02X %02X %02X %02X&quot;
l_string|&quot; %02X %02X %02X %02X %02X %02X %02X %02X&bslash;n&quot;
l_string|&quot;Modulus length: %d&bslash;nModulus: &bslash;n&quot;
comma
id|data
(braket
l_int|10
)braket
comma
id|data
(braket
l_int|11
)braket
comma
id|data
(braket
l_int|12
)braket
comma
id|data
(braket
l_int|13
)braket
comma
id|data
(braket
l_int|14
)braket
comma
id|data
(braket
l_int|15
)braket
comma
id|data
(braket
l_int|16
)braket
comma
id|data
(braket
l_int|17
)braket
comma
id|data
(braket
l_int|22
)braket
comma
id|data
(braket
l_int|23
)braket
comma
id|data
(braket
l_int|24
)braket
comma
id|data
(braket
l_int|25
)braket
comma
id|data
(braket
l_int|26
)braket
comma
id|data
(braket
l_int|27
)braket
comma
id|data
(braket
l_int|28
)braket
comma
id|data
(braket
l_int|29
)braket
comma
id|data
(braket
l_int|30
)braket
comma
id|data
(braket
l_int|31
)braket
comma
id|data
(braket
l_int|32
)braket
comma
id|data
(braket
l_int|33
)braket
comma
id|be32_to_cpu
c_func
(paren
op_star
id|native_val
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|256
suffix:semicolon
id|i
op_increment
)paren
(brace
id|str
op_add_assign
id|sprintf
c_func
(paren
id|str
comma
l_string|&quot;%02X &quot;
comma
id|data
(braket
id|i
op_plus
l_int|39
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
op_plus
l_int|1
)paren
op_mod
l_int|16
op_eq
l_int|0
)paren
id|str
op_add_assign
id|sprintf
c_func
(paren
id|str
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_return
id|str
op_minus
id|buf
suffix:semicolon
)brace
r_static
id|DEVICE_ATTR
c_func
(paren
id|pubek
comma
id|S_IRUGO
comma
id|show_pubek
comma
l_int|NULL
)paren
suffix:semicolon
DECL|macro|CAP_VER_RESULT_SIZE
mdefine_line|#define CAP_VER_RESULT_SIZE 18
DECL|variable|cap_version
r_static
id|u8
id|cap_version
(braket
)braket
op_assign
(brace
l_int|0
comma
l_int|193
comma
multiline_comment|/* TPM_TAG_RQU_COMMAND */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|18
comma
multiline_comment|/* length */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|101
comma
multiline_comment|/* TPM_ORD_GetCapability */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|6
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
DECL|macro|CAP_MANUFACTURER_RESULT_SIZE
mdefine_line|#define CAP_MANUFACTURER_RESULT_SIZE 18
DECL|variable|cap_manufacturer
r_static
id|u8
id|cap_manufacturer
(braket
)braket
op_assign
(brace
l_int|0
comma
l_int|193
comma
multiline_comment|/* TPM_TAG_RQU_COMMAND */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|22
comma
multiline_comment|/* length */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|101
comma
multiline_comment|/* TPM_ORD_GetCapability */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|5
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|4
comma
l_int|0
comma
l_int|0
comma
l_int|1
comma
l_int|3
)brace
suffix:semicolon
DECL|function|show_caps
r_static
id|ssize_t
id|show_caps
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
)paren
(brace
id|u8
id|data
(braket
id|READ_PUBEK_RESULT_SIZE
)braket
suffix:semicolon
id|ssize_t
id|len
suffix:semicolon
r_char
op_star
id|str
op_assign
id|buf
suffix:semicolon
r_struct
id|tpm_chip
op_star
id|chip
op_assign
id|pci_get_drvdata
c_func
(paren
id|container_of
c_func
(paren
id|dev
comma
r_struct
id|pci_dev
comma
id|dev
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chip
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|memcpy
c_func
(paren
id|data
comma
id|cap_manufacturer
comma
r_sizeof
(paren
id|cap_manufacturer
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|len
op_assign
id|tpm_transmit
c_func
(paren
id|chip
comma
id|data
comma
r_sizeof
(paren
id|data
)paren
)paren
)paren
OL
id|CAP_MANUFACTURER_RESULT_SIZE
)paren
r_return
id|len
suffix:semicolon
id|str
op_add_assign
id|sprintf
c_func
(paren
id|str
comma
l_string|&quot;Manufacturer: 0x%x&bslash;n&quot;
comma
id|be32_to_cpu
c_func
(paren
op_star
(paren
id|data
op_plus
l_int|14
)paren
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|data
comma
id|cap_version
comma
r_sizeof
(paren
id|cap_version
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|len
op_assign
id|tpm_transmit
c_func
(paren
id|chip
comma
id|data
comma
r_sizeof
(paren
id|data
)paren
)paren
)paren
OL
id|CAP_VER_RESULT_SIZE
)paren
r_return
id|len
suffix:semicolon
id|str
op_add_assign
id|sprintf
c_func
(paren
id|str
comma
l_string|&quot;TCG version: %d.%d&bslash;nFirmware version: %d.%d&bslash;n&quot;
comma
(paren
r_int
)paren
id|data
(braket
l_int|14
)braket
comma
(paren
r_int
)paren
id|data
(braket
l_int|15
)braket
comma
(paren
r_int
)paren
id|data
(braket
l_int|16
)braket
comma
(paren
r_int
)paren
id|data
(braket
l_int|17
)braket
)paren
suffix:semicolon
r_return
id|str
op_minus
id|buf
suffix:semicolon
)brace
r_static
id|DEVICE_ATTR
c_func
(paren
id|caps
comma
id|S_IRUGO
comma
id|show_caps
comma
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/*&n; * Device file system interface to the TPM&n; */
DECL|function|tpm_open
r_int
id|tpm_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_int
id|rc
op_assign
l_int|0
comma
id|minor
op_assign
id|iminor
c_func
(paren
id|inode
)paren
suffix:semicolon
r_struct
id|tpm_chip
op_star
id|chip
op_assign
l_int|NULL
comma
op_star
id|pos
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|driver_lock
)paren
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|pos
comma
op_amp
id|tpm_chip_list
comma
id|list
)paren
(brace
r_if
c_cond
(paren
id|pos-&gt;vendor-&gt;miscdev.minor
op_eq
id|minor
)paren
(brace
id|chip
op_assign
id|pos
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|chip
op_eq
l_int|NULL
)paren
(brace
id|rc
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|err_out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|chip-&gt;num_opens
)paren
(brace
id|dev_dbg
c_func
(paren
op_amp
id|chip-&gt;pci_dev-&gt;dev
comma
l_string|&quot;Another process owns this TPM&bslash;n&quot;
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_goto
id|err_out
suffix:semicolon
)brace
id|chip-&gt;num_opens
op_increment
suffix:semicolon
id|pci_dev_get
c_func
(paren
id|chip-&gt;pci_dev
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|driver_lock
)paren
suffix:semicolon
id|chip-&gt;data_buffer
op_assign
id|kmalloc
c_func
(paren
id|TPM_BUFSIZE
op_star
r_sizeof
(paren
id|u8
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chip-&gt;data_buffer
op_eq
l_int|NULL
)paren
(brace
id|chip-&gt;num_opens
op_decrement
suffix:semicolon
id|pci_dev_put
c_func
(paren
id|chip-&gt;pci_dev
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|atomic_set
c_func
(paren
op_amp
id|chip-&gt;data_pending
comma
l_int|0
)paren
suffix:semicolon
id|file-&gt;private_data
op_assign
id|chip
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|err_out
suffix:colon
id|spin_unlock
c_func
(paren
op_amp
id|driver_lock
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|variable|tpm_open
id|EXPORT_SYMBOL_GPL
c_func
(paren
id|tpm_open
)paren
suffix:semicolon
DECL|function|tpm_release
r_int
id|tpm_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|tpm_chip
op_star
id|chip
op_assign
id|file-&gt;private_data
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|driver_lock
)paren
suffix:semicolon
id|chip-&gt;num_opens
op_decrement
suffix:semicolon
id|down
c_func
(paren
op_amp
id|chip-&gt;timer_manipulation_mutex
)paren
suffix:semicolon
r_if
c_cond
(paren
id|timer_pending
c_func
(paren
op_amp
id|chip-&gt;user_read_timer
)paren
)paren
id|del_singleshot_timer_sync
c_func
(paren
op_amp
id|chip-&gt;user_read_timer
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|timer_pending
c_func
(paren
op_amp
id|chip-&gt;device_timer
)paren
)paren
id|del_singleshot_timer_sync
c_func
(paren
op_amp
id|chip-&gt;device_timer
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|chip-&gt;timer_manipulation_mutex
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|chip-&gt;data_buffer
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|chip-&gt;data_pending
comma
l_int|0
)paren
suffix:semicolon
id|pci_dev_put
c_func
(paren
id|chip-&gt;pci_dev
)paren
suffix:semicolon
id|file-&gt;private_data
op_assign
l_int|NULL
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|driver_lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|tpm_release
id|EXPORT_SYMBOL_GPL
c_func
(paren
id|tpm_release
)paren
suffix:semicolon
DECL|function|tpm_write
id|ssize_t
id|tpm_write
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
id|__user
op_star
id|buf
comma
r_int
id|size
comma
id|loff_t
op_star
id|off
)paren
(brace
r_struct
id|tpm_chip
op_star
id|chip
op_assign
id|file-&gt;private_data
suffix:semicolon
r_int
id|in_size
op_assign
id|size
comma
id|out_size
suffix:semicolon
multiline_comment|/* cannot perform a write until the read has cleared&n;&t;   either via tpm_read or a user_read_timer timeout */
r_while
c_loop
(paren
id|atomic_read
c_func
(paren
op_amp
id|chip-&gt;data_pending
)paren
op_ne
l_int|0
)paren
(brace
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|TPM_TIMEOUT
)paren
suffix:semicolon
)brace
id|down
c_func
(paren
op_amp
id|chip-&gt;buffer_mutex
)paren
suffix:semicolon
r_if
c_cond
(paren
id|in_size
OG
id|TPM_BUFSIZE
)paren
id|in_size
op_assign
id|TPM_BUFSIZE
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
(paren
id|chip-&gt;data_buffer
comma
(paren
r_void
id|__user
op_star
)paren
id|buf
comma
id|in_size
)paren
)paren
(brace
id|up
c_func
(paren
op_amp
id|chip-&gt;buffer_mutex
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
multiline_comment|/* atomic tpm command send and result receive */
id|out_size
op_assign
id|tpm_transmit
c_func
(paren
id|chip
comma
id|chip-&gt;data_buffer
comma
id|TPM_BUFSIZE
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|chip-&gt;data_pending
comma
id|out_size
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|chip-&gt;buffer_mutex
)paren
suffix:semicolon
multiline_comment|/* Set a timeout by which the reader must come claim the result */
id|down
c_func
(paren
op_amp
id|chip-&gt;timer_manipulation_mutex
)paren
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|chip-&gt;user_read_timer
)paren
suffix:semicolon
id|chip-&gt;user_read_timer.function
op_assign
id|user_reader_timeout
suffix:semicolon
id|chip-&gt;user_read_timer.data
op_assign
(paren
r_int
r_int
)paren
id|chip
suffix:semicolon
id|chip-&gt;user_read_timer.expires
op_assign
id|jiffies
op_plus
(paren
l_int|60
op_star
id|HZ
)paren
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|chip-&gt;user_read_timer
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|chip-&gt;timer_manipulation_mutex
)paren
suffix:semicolon
r_return
id|in_size
suffix:semicolon
)brace
DECL|variable|tpm_write
id|EXPORT_SYMBOL_GPL
c_func
(paren
id|tpm_write
)paren
suffix:semicolon
DECL|function|tpm_read
id|ssize_t
id|tpm_read
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_char
id|__user
op_star
id|buf
comma
r_int
id|size
comma
id|loff_t
op_star
id|off
)paren
(brace
r_struct
id|tpm_chip
op_star
id|chip
op_assign
id|file-&gt;private_data
suffix:semicolon
r_int
id|ret_size
op_assign
op_minus
id|ENODATA
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|chip-&gt;data_pending
)paren
op_ne
l_int|0
)paren
(brace
multiline_comment|/* Result available */
id|down
c_func
(paren
op_amp
id|chip-&gt;timer_manipulation_mutex
)paren
suffix:semicolon
id|del_singleshot_timer_sync
c_func
(paren
op_amp
id|chip-&gt;user_read_timer
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|chip-&gt;timer_manipulation_mutex
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|chip-&gt;buffer_mutex
)paren
suffix:semicolon
id|ret_size
op_assign
id|atomic_read
c_func
(paren
op_amp
id|chip-&gt;data_pending
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|chip-&gt;data_pending
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret_size
op_eq
l_int|0
)paren
multiline_comment|/* timeout just occurred */
id|ret_size
op_assign
op_minus
id|ETIME
suffix:semicolon
r_else
r_if
c_cond
(paren
id|ret_size
OG
l_int|0
)paren
(brace
multiline_comment|/* relay data */
r_if
c_cond
(paren
id|size
OL
id|ret_size
)paren
id|ret_size
op_assign
id|size
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_void
id|__user
op_star
)paren
id|buf
comma
id|chip-&gt;data_buffer
comma
id|ret_size
)paren
)paren
(brace
id|ret_size
op_assign
op_minus
id|EFAULT
suffix:semicolon
)brace
)brace
id|up
c_func
(paren
op_amp
id|chip-&gt;buffer_mutex
)paren
suffix:semicolon
)brace
r_return
id|ret_size
suffix:semicolon
)brace
DECL|variable|tpm_read
id|EXPORT_SYMBOL_GPL
c_func
(paren
id|tpm_read
)paren
suffix:semicolon
DECL|function|tpm_remove
r_void
id|__devexit
id|tpm_remove
c_func
(paren
r_struct
id|pci_dev
op_star
id|pci_dev
)paren
(brace
r_struct
id|tpm_chip
op_star
id|chip
op_assign
id|pci_get_drvdata
c_func
(paren
id|pci_dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chip
op_eq
l_int|NULL
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|pci_dev-&gt;dev
comma
l_string|&quot;No device data found&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|spin_lock
c_func
(paren
op_amp
id|driver_lock
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|chip-&gt;list
)paren
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|pci_dev
comma
l_int|NULL
)paren
suffix:semicolon
id|misc_deregister
c_func
(paren
op_amp
id|chip-&gt;vendor-&gt;miscdev
)paren
suffix:semicolon
id|device_remove_file
c_func
(paren
op_amp
id|pci_dev-&gt;dev
comma
op_amp
id|dev_attr_pubek
)paren
suffix:semicolon
id|device_remove_file
c_func
(paren
op_amp
id|pci_dev-&gt;dev
comma
op_amp
id|dev_attr_pcrs
)paren
suffix:semicolon
id|device_remove_file
c_func
(paren
op_amp
id|pci_dev-&gt;dev
comma
op_amp
id|dev_attr_caps
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|driver_lock
)paren
suffix:semicolon
id|pci_disable_device
c_func
(paren
id|pci_dev
)paren
suffix:semicolon
id|dev_mask
(braket
id|chip-&gt;dev_num
op_div
l_int|32
)braket
op_and_assign
op_logical_neg
(paren
l_int|1
op_lshift
(paren
id|chip-&gt;dev_num
op_mod
l_int|32
)paren
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|chip
)paren
suffix:semicolon
id|pci_dev_put
c_func
(paren
id|pci_dev
)paren
suffix:semicolon
)brace
DECL|variable|tpm_remove
id|EXPORT_SYMBOL_GPL
c_func
(paren
id|tpm_remove
)paren
suffix:semicolon
DECL|variable|savestate
r_static
id|u8
id|savestate
(braket
)braket
op_assign
(brace
l_int|0
comma
l_int|193
comma
multiline_comment|/* TPM_TAG_RQU_COMMAND */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|10
comma
multiline_comment|/* blob length (in bytes) */
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|152
multiline_comment|/* TPM_ORD_SaveState */
)brace
suffix:semicolon
multiline_comment|/*&n; * We are about to suspend. Save the TPM state&n; * so that it can be restored.&n; */
DECL|function|tpm_pm_suspend
r_int
id|tpm_pm_suspend
c_func
(paren
r_struct
id|pci_dev
op_star
id|pci_dev
comma
id|u32
id|pm_state
)paren
(brace
r_struct
id|tpm_chip
op_star
id|chip
op_assign
id|pci_get_drvdata
c_func
(paren
id|pci_dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chip
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|tpm_transmit
c_func
(paren
id|chip
comma
id|savestate
comma
r_sizeof
(paren
id|savestate
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|tpm_pm_suspend
id|EXPORT_SYMBOL_GPL
c_func
(paren
id|tpm_pm_suspend
)paren
suffix:semicolon
multiline_comment|/*&n; * Resume from a power safe. The BIOS already restored&n; * the TPM state.&n; */
DECL|function|tpm_pm_resume
r_int
id|tpm_pm_resume
c_func
(paren
r_struct
id|pci_dev
op_star
id|pci_dev
)paren
(brace
r_struct
id|tpm_chip
op_star
id|chip
op_assign
id|pci_get_drvdata
c_func
(paren
id|pci_dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chip
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|driver_lock
)paren
suffix:semicolon
id|tpm_lpc_bus_init
c_func
(paren
id|pci_dev
comma
id|chip-&gt;vendor-&gt;base
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|driver_lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|tpm_pm_resume
id|EXPORT_SYMBOL_GPL
c_func
(paren
id|tpm_pm_resume
)paren
suffix:semicolon
multiline_comment|/*&n; * Called from tpm_&lt;specific&gt;.c probe function only for devices &n; * the driver has determined it should claim.  Prior to calling&n; * this function the specific probe function has called pci_enable_device&n; * upon errant exit from this function specific probe function should call&n; * pci_disable_device&n; */
DECL|function|tpm_register_hardware
r_int
id|tpm_register_hardware
c_func
(paren
r_struct
id|pci_dev
op_star
id|pci_dev
comma
r_struct
id|tpm_vendor_specific
op_star
id|entry
)paren
(brace
r_char
id|devname
(braket
l_int|7
)braket
suffix:semicolon
r_struct
id|tpm_chip
op_star
id|chip
suffix:semicolon
r_int
id|i
comma
id|j
suffix:semicolon
multiline_comment|/* Driver specific per-device data */
id|chip
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|chip
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chip
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|chip
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|tpm_chip
)paren
)paren
suffix:semicolon
id|init_MUTEX
c_func
(paren
op_amp
id|chip-&gt;buffer_mutex
)paren
suffix:semicolon
id|init_MUTEX
c_func
(paren
op_amp
id|chip-&gt;tpm_mutex
)paren
suffix:semicolon
id|init_MUTEX
c_func
(paren
op_amp
id|chip-&gt;timer_manipulation_mutex
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|chip-&gt;list
)paren
suffix:semicolon
id|chip-&gt;vendor
op_assign
id|entry
suffix:semicolon
id|chip-&gt;dev_num
op_assign
op_minus
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|8
suffix:semicolon
id|j
op_increment
)paren
r_if
c_cond
(paren
(paren
id|dev_mask
(braket
id|i
)braket
op_amp
(paren
l_int|1
op_lshift
id|j
)paren
)paren
op_eq
l_int|0
)paren
(brace
id|chip-&gt;dev_num
op_assign
id|i
op_star
l_int|32
op_plus
id|j
suffix:semicolon
id|dev_mask
(braket
id|i
)braket
op_or_assign
l_int|1
op_lshift
id|j
suffix:semicolon
r_goto
id|dev_num_search_complete
suffix:semicolon
)brace
id|dev_num_search_complete
suffix:colon
r_if
c_cond
(paren
id|chip-&gt;dev_num
OL
l_int|0
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|pci_dev-&gt;dev
comma
l_string|&quot;No available tpm device numbers&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|chip
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|chip-&gt;dev_num
op_eq
l_int|0
)paren
id|chip-&gt;vendor-&gt;miscdev.minor
op_assign
id|TPM_MINOR
suffix:semicolon
r_else
id|chip-&gt;vendor-&gt;miscdev.minor
op_assign
id|MISC_DYNAMIC_MINOR
suffix:semicolon
id|snprintf
c_func
(paren
id|devname
comma
r_sizeof
(paren
id|devname
)paren
comma
l_string|&quot;%s%d&quot;
comma
l_string|&quot;tpm&quot;
comma
id|chip-&gt;dev_num
)paren
suffix:semicolon
id|chip-&gt;vendor-&gt;miscdev.name
op_assign
id|devname
suffix:semicolon
id|chip-&gt;vendor-&gt;miscdev.dev
op_assign
op_amp
(paren
id|pci_dev-&gt;dev
)paren
suffix:semicolon
id|chip-&gt;pci_dev
op_assign
id|pci_dev_get
c_func
(paren
id|pci_dev
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|driver_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|misc_register
c_func
(paren
op_amp
id|chip-&gt;vendor-&gt;miscdev
)paren
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|chip-&gt;pci_dev-&gt;dev
comma
l_string|&quot;unable to misc_register %s, minor %d&bslash;n&quot;
comma
id|chip-&gt;vendor-&gt;miscdev.name
comma
id|chip-&gt;vendor-&gt;miscdev.minor
)paren
suffix:semicolon
id|pci_dev_put
c_func
(paren
id|pci_dev
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|driver_lock
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|chip
)paren
suffix:semicolon
id|dev_mask
(braket
id|i
)braket
op_and_assign
op_logical_neg
(paren
l_int|1
op_lshift
id|j
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|pci_set_drvdata
c_func
(paren
id|pci_dev
comma
id|chip
)paren
suffix:semicolon
id|list_add
c_func
(paren
op_amp
id|chip-&gt;list
comma
op_amp
id|tpm_chip_list
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|pci_dev-&gt;dev
comma
op_amp
id|dev_attr_pubek
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|pci_dev-&gt;dev
comma
op_amp
id|dev_attr_pcrs
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|pci_dev-&gt;dev
comma
op_amp
id|dev_attr_caps
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|driver_lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|tpm_register_hardware
id|EXPORT_SYMBOL_GPL
c_func
(paren
id|tpm_register_hardware
)paren
suffix:semicolon
DECL|function|init_tpm
r_static
r_int
id|__init
id|init_tpm
c_func
(paren
r_void
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|cleanup_tpm
r_static
r_void
id|__exit
id|cleanup_tpm
c_func
(paren
r_void
)paren
(brace
)brace
DECL|variable|init_tpm
id|module_init
c_func
(paren
id|init_tpm
)paren
suffix:semicolon
DECL|variable|cleanup_tpm
id|module_exit
c_func
(paren
id|cleanup_tpm
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Leendert van Doorn (leendert@watson.ibm.com)&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;TPM Driver&quot;
)paren
suffix:semicolon
id|MODULE_VERSION
c_func
(paren
l_string|&quot;2.0&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
eof
