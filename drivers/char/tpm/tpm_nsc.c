multiline_comment|/*&n; * Copyright (C) 2004 IBM Corporation&n; *&n; * Authors:&n; * Leendert van Doorn &lt;leendert@watson.ibm.com&gt;&n; * Dave Safford &lt;safford@watson.ibm.com&gt;&n; * Reiner Sailer &lt;sailer@watson.ibm.com&gt;&n; * Kylene Hall &lt;kjhall@us.ibm.com&gt;&n; *&n; * Maintained by: &lt;tpmdd_devel@lists.sourceforge.net&gt;&n; *&n; * Device driver for TCG/TCPA TPM (trusted platform module).&n; * Specifications at www.trustedcomputinggroup.org&t; &n; *&n; * This program is free software; you can redistribute it and/or&n; * modify it under the terms of the GNU General Public License as&n; * published by the Free Software Foundation, version 2 of the&n; * License.&n; * &n; */
macro_line|#include &quot;tpm.h&quot;
multiline_comment|/* National definitions */
DECL|macro|TPM_NSC_BASE
mdefine_line|#define&t;TPM_NSC_BASE&t;&t;&t;0x360
DECL|macro|TPM_NSC_IRQ
mdefine_line|#define&t;TPM_NSC_IRQ&t;&t;&t;0x07
DECL|macro|NSC_LDN_INDEX
mdefine_line|#define&t;NSC_LDN_INDEX&t;&t;&t;0x07
DECL|macro|NSC_SID_INDEX
mdefine_line|#define&t;NSC_SID_INDEX&t;&t;&t;0x20
DECL|macro|NSC_LDC_INDEX
mdefine_line|#define&t;NSC_LDC_INDEX&t;&t;&t;0x30
DECL|macro|NSC_DIO_INDEX
mdefine_line|#define&t;NSC_DIO_INDEX&t;&t;&t;0x60
DECL|macro|NSC_CIO_INDEX
mdefine_line|#define&t;NSC_CIO_INDEX&t;&t;&t;0x62
DECL|macro|NSC_IRQ_INDEX
mdefine_line|#define&t;NSC_IRQ_INDEX&t;&t;&t;0x70
DECL|macro|NSC_ITS_INDEX
mdefine_line|#define&t;NSC_ITS_INDEX&t;&t;&t;0x71
DECL|macro|NSC_STATUS
mdefine_line|#define&t;NSC_STATUS&t;&t;&t;0x01
DECL|macro|NSC_COMMAND
mdefine_line|#define&t;NSC_COMMAND&t;&t;&t;0x01
DECL|macro|NSC_DATA
mdefine_line|#define&t;NSC_DATA&t;&t;&t;0x00
multiline_comment|/* status bits */
DECL|macro|NSC_STATUS_OBF
mdefine_line|#define&t;NSC_STATUS_OBF&t;&t;&t;0x01&t;/* output buffer full */
DECL|macro|NSC_STATUS_IBF
mdefine_line|#define&t;NSC_STATUS_IBF&t;&t;&t;0x02&t;/* input buffer full */
DECL|macro|NSC_STATUS_F0
mdefine_line|#define&t;NSC_STATUS_F0&t;&t;&t;0x04&t;/* F0 */
DECL|macro|NSC_STATUS_A2
mdefine_line|#define&t;NSC_STATUS_A2&t;&t;&t;0x08&t;/* A2 */
DECL|macro|NSC_STATUS_RDY
mdefine_line|#define&t;NSC_STATUS_RDY&t;&t;&t;0x10&t;/* ready to receive command */
DECL|macro|NSC_STATUS_IBR
mdefine_line|#define&t;NSC_STATUS_IBR&t;&t;&t;0x20&t;/* ready to receive data */
multiline_comment|/* command bits */
DECL|macro|NSC_COMMAND_NORMAL
mdefine_line|#define&t;NSC_COMMAND_NORMAL&t;&t;0x01&t;/* normal mode */
DECL|macro|NSC_COMMAND_EOC
mdefine_line|#define&t;NSC_COMMAND_EOC&t;&t;&t;0x03
DECL|macro|NSC_COMMAND_CANCEL
mdefine_line|#define&t;NSC_COMMAND_CANCEL&t;&t;0x22
multiline_comment|/*&n; * Wait for a certain status to appear&n; */
DECL|function|wait_for_stat
r_static
r_int
id|wait_for_stat
c_func
(paren
r_struct
id|tpm_chip
op_star
id|chip
comma
id|u8
id|mask
comma
id|u8
id|val
comma
id|u8
op_star
id|data
)paren
(brace
r_int
id|expired
op_assign
l_int|0
suffix:semicolon
r_struct
id|timer_list
id|status_timer
op_assign
id|TIMER_INITIALIZER
c_func
(paren
id|tpm_time_expired
comma
id|jiffies
op_plus
l_int|10
op_star
id|HZ
comma
(paren
r_int
r_int
)paren
op_amp
id|expired
)paren
suffix:semicolon
multiline_comment|/* status immediately available check */
op_star
id|data
op_assign
id|inb
c_func
(paren
id|chip-&gt;vendor-&gt;base
op_plus
id|NSC_STATUS
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_star
id|data
op_amp
id|mask
)paren
op_eq
id|val
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* wait for status */
id|add_timer
c_func
(paren
op_amp
id|status_timer
)paren
suffix:semicolon
r_do
(brace
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|TPM_TIMEOUT
)paren
suffix:semicolon
op_star
id|data
op_assign
id|inb
c_func
(paren
id|chip-&gt;vendor-&gt;base
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_star
id|data
op_amp
id|mask
)paren
op_eq
id|val
)paren
(brace
id|del_singleshot_timer_sync
c_func
(paren
op_amp
id|status_timer
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
op_logical_neg
id|expired
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
DECL|function|nsc_wait_for_ready
r_static
r_int
id|nsc_wait_for_ready
c_func
(paren
r_struct
id|tpm_chip
op_star
id|chip
)paren
(brace
r_int
id|status
suffix:semicolon
r_int
id|expired
op_assign
l_int|0
suffix:semicolon
r_struct
id|timer_list
id|status_timer
op_assign
id|TIMER_INITIALIZER
c_func
(paren
id|tpm_time_expired
comma
id|jiffies
op_plus
l_int|100
comma
(paren
r_int
r_int
)paren
op_amp
id|expired
)paren
suffix:semicolon
multiline_comment|/* status immediately available check */
id|status
op_assign
id|inb
c_func
(paren
id|chip-&gt;vendor-&gt;base
op_plus
id|NSC_STATUS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|NSC_STATUS_OBF
)paren
id|status
op_assign
id|inb
c_func
(paren
id|chip-&gt;vendor-&gt;base
op_plus
id|NSC_DATA
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|NSC_STATUS_RDY
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* wait for status */
id|add_timer
c_func
(paren
op_amp
id|status_timer
)paren
suffix:semicolon
r_do
(brace
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|TPM_TIMEOUT
)paren
suffix:semicolon
id|status
op_assign
id|inb
c_func
(paren
id|chip-&gt;vendor-&gt;base
op_plus
id|NSC_STATUS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|NSC_STATUS_OBF
)paren
id|status
op_assign
id|inb
c_func
(paren
id|chip-&gt;vendor-&gt;base
op_plus
id|NSC_DATA
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|NSC_STATUS_RDY
)paren
(brace
id|del_singleshot_timer_sync
c_func
(paren
op_amp
id|status_timer
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
op_logical_neg
id|expired
)paren
suffix:semicolon
id|dev_info
c_func
(paren
op_amp
id|chip-&gt;pci_dev-&gt;dev
comma
l_string|&quot;wait for ready failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
DECL|function|tpm_nsc_recv
r_static
r_int
id|tpm_nsc_recv
c_func
(paren
r_struct
id|tpm_chip
op_star
id|chip
comma
id|u8
op_star
id|buf
comma
r_int
id|count
)paren
(brace
id|u8
op_star
id|buffer
op_assign
id|buf
suffix:semicolon
id|u8
id|data
comma
op_star
id|p
suffix:semicolon
id|u32
id|size
suffix:semicolon
id|__be32
op_star
id|native_size
suffix:semicolon
r_if
c_cond
(paren
id|count
OL
l_int|6
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_if
c_cond
(paren
id|wait_for_stat
c_func
(paren
id|chip
comma
id|NSC_STATUS_F0
comma
id|NSC_STATUS_F0
comma
op_amp
id|data
)paren
OL
l_int|0
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|chip-&gt;pci_dev-&gt;dev
comma
l_string|&quot;F0 timeout&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|data
op_assign
id|inb
c_func
(paren
id|chip-&gt;vendor-&gt;base
op_plus
id|NSC_DATA
)paren
)paren
op_ne
id|NSC_COMMAND_NORMAL
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|chip-&gt;pci_dev-&gt;dev
comma
l_string|&quot;not in normal mode (0x%x)&bslash;n&quot;
comma
id|data
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
multiline_comment|/* read the whole packet */
r_for
c_loop
(paren
id|p
op_assign
id|buffer
suffix:semicolon
id|p
OL
op_amp
id|buffer
(braket
id|count
)braket
suffix:semicolon
id|p
op_increment
)paren
(brace
r_if
c_cond
(paren
id|wait_for_stat
(paren
id|chip
comma
id|NSC_STATUS_OBF
comma
id|NSC_STATUS_OBF
comma
op_amp
id|data
)paren
OL
l_int|0
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|chip-&gt;pci_dev-&gt;dev
comma
l_string|&quot;OBF timeout (while reading data)&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_if
c_cond
(paren
id|data
op_amp
id|NSC_STATUS_F0
)paren
r_break
suffix:semicolon
op_star
id|p
op_assign
id|inb
c_func
(paren
id|chip-&gt;vendor-&gt;base
op_plus
id|NSC_DATA
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|data
op_amp
id|NSC_STATUS_F0
)paren
op_eq
l_int|0
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|chip-&gt;pci_dev-&gt;dev
comma
l_string|&quot;F0 not set&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|data
op_assign
id|inb
c_func
(paren
id|chip-&gt;vendor-&gt;base
op_plus
id|NSC_DATA
)paren
)paren
op_ne
id|NSC_COMMAND_EOC
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|chip-&gt;pci_dev-&gt;dev
comma
l_string|&quot;expected end of command(0x%x)&bslash;n&quot;
comma
id|data
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|native_size
op_assign
(paren
id|__force
id|__be32
op_star
)paren
(paren
id|buf
op_plus
l_int|2
)paren
suffix:semicolon
id|size
op_assign
id|be32_to_cpu
c_func
(paren
op_star
id|native_size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
OL
id|size
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_return
id|size
suffix:semicolon
)brace
DECL|function|tpm_nsc_send
r_static
r_int
id|tpm_nsc_send
c_func
(paren
r_struct
id|tpm_chip
op_star
id|chip
comma
id|u8
op_star
id|buf
comma
r_int
id|count
)paren
(brace
id|u8
id|data
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/*&n;&t; * If we hit the chip with back to back commands it locks up&n;&t; * and never set IBF. Hitting it with this &quot;hammer&quot; seems to&n;&t; * fix it. Not sure why this is needed, we followed the flow&n;&t; * chart in the manual to the letter.&n;&t; */
id|outb
c_func
(paren
id|NSC_COMMAND_CANCEL
comma
id|chip-&gt;vendor-&gt;base
op_plus
id|NSC_COMMAND
)paren
suffix:semicolon
r_if
c_cond
(paren
id|nsc_wait_for_ready
c_func
(paren
id|chip
)paren
op_ne
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_if
c_cond
(paren
id|wait_for_stat
c_func
(paren
id|chip
comma
id|NSC_STATUS_IBF
comma
l_int|0
comma
op_amp
id|data
)paren
OL
l_int|0
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|chip-&gt;pci_dev-&gt;dev
comma
l_string|&quot;IBF timeout&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|outb
c_func
(paren
id|NSC_COMMAND_NORMAL
comma
id|chip-&gt;vendor-&gt;base
op_plus
id|NSC_COMMAND
)paren
suffix:semicolon
r_if
c_cond
(paren
id|wait_for_stat
c_func
(paren
id|chip
comma
id|NSC_STATUS_IBR
comma
id|NSC_STATUS_IBR
comma
op_amp
id|data
)paren
OL
l_int|0
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|chip-&gt;pci_dev-&gt;dev
comma
l_string|&quot;IBR timeout&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|wait_for_stat
c_func
(paren
id|chip
comma
id|NSC_STATUS_IBF
comma
l_int|0
comma
op_amp
id|data
)paren
OL
l_int|0
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|chip-&gt;pci_dev-&gt;dev
comma
l_string|&quot;IBF timeout (while writing data)&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|outb
c_func
(paren
id|buf
(braket
id|i
)braket
comma
id|chip-&gt;vendor-&gt;base
op_plus
id|NSC_DATA
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|wait_for_stat
c_func
(paren
id|chip
comma
id|NSC_STATUS_IBF
comma
l_int|0
comma
op_amp
id|data
)paren
OL
l_int|0
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|chip-&gt;pci_dev-&gt;dev
comma
l_string|&quot;IBF timeout&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|outb
c_func
(paren
id|NSC_COMMAND_EOC
comma
id|chip-&gt;vendor-&gt;base
op_plus
id|NSC_COMMAND
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
DECL|function|tpm_nsc_cancel
r_static
r_void
id|tpm_nsc_cancel
c_func
(paren
r_struct
id|tpm_chip
op_star
id|chip
)paren
(brace
id|outb
c_func
(paren
id|NSC_COMMAND_CANCEL
comma
id|chip-&gt;vendor-&gt;base
op_plus
id|NSC_COMMAND
)paren
suffix:semicolon
)brace
DECL|variable|nsc_ops
r_static
r_struct
id|file_operations
id|nsc_ops
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|llseek
op_assign
id|no_llseek
comma
dot
id|open
op_assign
id|tpm_open
comma
dot
id|read
op_assign
id|tpm_read
comma
dot
id|write
op_assign
id|tpm_write
comma
dot
id|release
op_assign
id|tpm_release
comma
)brace
suffix:semicolon
DECL|variable|tpm_nsc
r_static
r_struct
id|tpm_vendor_specific
id|tpm_nsc
op_assign
(brace
dot
id|recv
op_assign
id|tpm_nsc_recv
comma
dot
id|send
op_assign
id|tpm_nsc_send
comma
dot
id|cancel
op_assign
id|tpm_nsc_cancel
comma
dot
id|req_complete_mask
op_assign
id|NSC_STATUS_OBF
comma
dot
id|req_complete_val
op_assign
id|NSC_STATUS_OBF
comma
dot
id|base
op_assign
id|TPM_NSC_BASE
comma
dot
id|miscdev
op_assign
(brace
dot
id|fops
op_assign
op_amp
id|nsc_ops
comma
)brace
comma
)brace
suffix:semicolon
DECL|function|tpm_nsc_init
r_static
r_int
id|__devinit
id|tpm_nsc_init
c_func
(paren
r_struct
id|pci_dev
op_star
id|pci_dev
comma
r_const
r_struct
id|pci_device_id
op_star
id|pci_id
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|pci_enable_device
c_func
(paren
id|pci_dev
)paren
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_if
c_cond
(paren
id|tpm_lpc_bus_init
c_func
(paren
id|pci_dev
comma
id|TPM_NSC_BASE
)paren
)paren
(brace
id|rc
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|out_err
suffix:semicolon
)brace
multiline_comment|/* verify that it is a National part (SID) */
r_if
c_cond
(paren
id|tpm_read_index
c_func
(paren
id|NSC_SID_INDEX
)paren
op_ne
l_int|0xEF
)paren
(brace
id|rc
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|out_err
suffix:semicolon
)brace
id|dev_dbg
c_func
(paren
op_amp
id|pci_dev-&gt;dev
comma
l_string|&quot;NSC TPM detected&bslash;n&quot;
)paren
suffix:semicolon
id|dev_dbg
c_func
(paren
op_amp
id|pci_dev-&gt;dev
comma
l_string|&quot;NSC LDN 0x%x, SID 0x%x, SRID 0x%x&bslash;n&quot;
comma
id|tpm_read_index
c_func
(paren
l_int|0x07
)paren
comma
id|tpm_read_index
c_func
(paren
l_int|0x20
)paren
comma
id|tpm_read_index
c_func
(paren
l_int|0x27
)paren
)paren
suffix:semicolon
id|dev_dbg
c_func
(paren
op_amp
id|pci_dev-&gt;dev
comma
l_string|&quot;NSC SIOCF1 0x%x SIOCF5 0x%x SIOCF6 0x%x SIOCF8 0x%x&bslash;n&quot;
comma
id|tpm_read_index
c_func
(paren
l_int|0x21
)paren
comma
id|tpm_read_index
c_func
(paren
l_int|0x25
)paren
comma
id|tpm_read_index
c_func
(paren
l_int|0x26
)paren
comma
id|tpm_read_index
c_func
(paren
l_int|0x28
)paren
)paren
suffix:semicolon
id|dev_dbg
c_func
(paren
op_amp
id|pci_dev-&gt;dev
comma
l_string|&quot;NSC IO Base0 0x%x&bslash;n&quot;
comma
(paren
id|tpm_read_index
c_func
(paren
l_int|0x60
)paren
op_lshift
l_int|8
)paren
op_or
id|tpm_read_index
c_func
(paren
l_int|0x61
)paren
)paren
suffix:semicolon
id|dev_dbg
c_func
(paren
op_amp
id|pci_dev-&gt;dev
comma
l_string|&quot;NSC IO Base1 0x%x&bslash;n&quot;
comma
(paren
id|tpm_read_index
c_func
(paren
l_int|0x62
)paren
op_lshift
l_int|8
)paren
op_or
id|tpm_read_index
c_func
(paren
l_int|0x63
)paren
)paren
suffix:semicolon
id|dev_dbg
c_func
(paren
op_amp
id|pci_dev-&gt;dev
comma
l_string|&quot;NSC Interrupt number and wakeup 0x%x&bslash;n&quot;
comma
id|tpm_read_index
c_func
(paren
l_int|0x70
)paren
)paren
suffix:semicolon
id|dev_dbg
c_func
(paren
op_amp
id|pci_dev-&gt;dev
comma
l_string|&quot;NSC IRQ type select 0x%x&bslash;n&quot;
comma
id|tpm_read_index
c_func
(paren
l_int|0x71
)paren
)paren
suffix:semicolon
id|dev_dbg
c_func
(paren
op_amp
id|pci_dev-&gt;dev
comma
l_string|&quot;NSC DMA channel select0 0x%x, select1 0x%x&bslash;n&quot;
comma
id|tpm_read_index
c_func
(paren
l_int|0x74
)paren
comma
id|tpm_read_index
c_func
(paren
l_int|0x75
)paren
)paren
suffix:semicolon
id|dev_dbg
c_func
(paren
op_amp
id|pci_dev-&gt;dev
comma
l_string|&quot;NSC Config &quot;
l_string|&quot;0x%x 0x%x 0x%x 0x%x 0x%x 0x%x 0x%x 0x%x 0x%x 0x%x&bslash;n&quot;
comma
id|tpm_read_index
c_func
(paren
l_int|0xF0
)paren
comma
id|tpm_read_index
c_func
(paren
l_int|0xF1
)paren
comma
id|tpm_read_index
c_func
(paren
l_int|0xF2
)paren
comma
id|tpm_read_index
c_func
(paren
l_int|0xF3
)paren
comma
id|tpm_read_index
c_func
(paren
l_int|0xF4
)paren
comma
id|tpm_read_index
c_func
(paren
l_int|0xF5
)paren
comma
id|tpm_read_index
c_func
(paren
l_int|0xF6
)paren
comma
id|tpm_read_index
c_func
(paren
l_int|0xF7
)paren
comma
id|tpm_read_index
c_func
(paren
l_int|0xF8
)paren
comma
id|tpm_read_index
c_func
(paren
l_int|0xF9
)paren
)paren
suffix:semicolon
id|dev_info
c_func
(paren
op_amp
id|pci_dev-&gt;dev
comma
l_string|&quot;NSC PC21100 TPM revision %d&bslash;n&quot;
comma
id|tpm_read_index
c_func
(paren
l_int|0x27
)paren
op_amp
l_int|0x1F
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tpm_read_index
c_func
(paren
id|NSC_LDC_INDEX
)paren
op_eq
l_int|0
)paren
id|dev_info
c_func
(paren
op_amp
id|pci_dev-&gt;dev
comma
l_string|&quot;: NSC TPM not active&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* select PM channel 1 */
id|tpm_write_index
c_func
(paren
id|NSC_LDN_INDEX
comma
l_int|0x12
)paren
suffix:semicolon
id|tpm_read_index
c_func
(paren
id|NSC_LDN_INDEX
)paren
suffix:semicolon
multiline_comment|/* disable the DPM module */
id|tpm_write_index
c_func
(paren
id|NSC_LDC_INDEX
comma
l_int|0
)paren
suffix:semicolon
id|tpm_read_index
c_func
(paren
id|NSC_LDC_INDEX
)paren
suffix:semicolon
multiline_comment|/* set the data register base addresses */
id|tpm_write_index
c_func
(paren
id|NSC_DIO_INDEX
comma
id|TPM_NSC_BASE
op_rshift
l_int|8
)paren
suffix:semicolon
id|tpm_write_index
c_func
(paren
id|NSC_DIO_INDEX
op_plus
l_int|1
comma
id|TPM_NSC_BASE
)paren
suffix:semicolon
id|tpm_read_index
c_func
(paren
id|NSC_DIO_INDEX
)paren
suffix:semicolon
id|tpm_read_index
c_func
(paren
id|NSC_DIO_INDEX
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* set the command register base addresses */
id|tpm_write_index
c_func
(paren
id|NSC_CIO_INDEX
comma
(paren
id|TPM_NSC_BASE
op_plus
l_int|1
)paren
op_rshift
l_int|8
)paren
suffix:semicolon
id|tpm_write_index
c_func
(paren
id|NSC_CIO_INDEX
op_plus
l_int|1
comma
(paren
id|TPM_NSC_BASE
op_plus
l_int|1
)paren
)paren
suffix:semicolon
id|tpm_read_index
c_func
(paren
id|NSC_DIO_INDEX
)paren
suffix:semicolon
id|tpm_read_index
c_func
(paren
id|NSC_DIO_INDEX
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* set the interrupt number to be used for the host interface */
id|tpm_write_index
c_func
(paren
id|NSC_IRQ_INDEX
comma
id|TPM_NSC_IRQ
)paren
suffix:semicolon
id|tpm_write_index
c_func
(paren
id|NSC_ITS_INDEX
comma
l_int|0x00
)paren
suffix:semicolon
id|tpm_read_index
c_func
(paren
id|NSC_IRQ_INDEX
)paren
suffix:semicolon
multiline_comment|/* enable the DPM module */
id|tpm_write_index
c_func
(paren
id|NSC_LDC_INDEX
comma
l_int|0x01
)paren
suffix:semicolon
id|tpm_read_index
c_func
(paren
id|NSC_LDC_INDEX
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|tpm_register_hardware
c_func
(paren
id|pci_dev
comma
op_amp
id|tpm_nsc
)paren
)paren
OL
l_int|0
)paren
r_goto
id|out_err
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|out_err
suffix:colon
id|pci_disable_device
c_func
(paren
id|pci_dev
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|variable|__devinitdata
r_static
r_struct
id|pci_device_id
id|tpm_pci_tbl
(braket
)braket
id|__devinitdata
op_assign
(brace
(brace
id|PCI_DEVICE
c_func
(paren
id|PCI_VENDOR_ID_INTEL
comma
id|PCI_DEVICE_ID_INTEL_82801BA_0
)paren
)brace
comma
(brace
id|PCI_DEVICE
c_func
(paren
id|PCI_VENDOR_ID_INTEL
comma
id|PCI_DEVICE_ID_INTEL_82801CA_12
)paren
)brace
comma
(brace
id|PCI_DEVICE
c_func
(paren
id|PCI_VENDOR_ID_INTEL
comma
id|PCI_DEVICE_ID_INTEL_82801DB_0
)paren
)brace
comma
(brace
id|PCI_DEVICE
c_func
(paren
id|PCI_VENDOR_ID_INTEL
comma
id|PCI_DEVICE_ID_INTEL_82801DB_12
)paren
)brace
comma
(brace
id|PCI_DEVICE
c_func
(paren
id|PCI_VENDOR_ID_INTEL
comma
id|PCI_DEVICE_ID_INTEL_82801EB_0
)paren
)brace
comma
(brace
id|PCI_DEVICE
c_func
(paren
id|PCI_VENDOR_ID_AMD
comma
id|PCI_DEVICE_ID_AMD_8111_LPC
)paren
)brace
comma
(brace
l_int|0
comma
)brace
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|pci
comma
id|tpm_pci_tbl
)paren
suffix:semicolon
DECL|variable|nsc_pci_driver
r_static
r_struct
id|pci_driver
id|nsc_pci_driver
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;tpm_nsc&quot;
comma
dot
id|id_table
op_assign
id|tpm_pci_tbl
comma
dot
id|probe
op_assign
id|tpm_nsc_init
comma
dot
id|remove
op_assign
id|__devexit_p
c_func
(paren
id|tpm_remove
)paren
comma
dot
id|suspend
op_assign
id|tpm_pm_suspend
comma
dot
id|resume
op_assign
id|tpm_pm_resume
comma
)brace
suffix:semicolon
DECL|function|init_nsc
r_static
r_int
id|__init
id|init_nsc
c_func
(paren
r_void
)paren
(brace
r_return
id|pci_register_driver
c_func
(paren
op_amp
id|nsc_pci_driver
)paren
suffix:semicolon
)brace
DECL|function|cleanup_nsc
r_static
r_void
id|__exit
id|cleanup_nsc
c_func
(paren
r_void
)paren
(brace
id|pci_unregister_driver
c_func
(paren
op_amp
id|nsc_pci_driver
)paren
suffix:semicolon
)brace
DECL|variable|init_nsc
id|module_init
c_func
(paren
id|init_nsc
)paren
suffix:semicolon
DECL|variable|cleanup_nsc
id|module_exit
c_func
(paren
id|cleanup_nsc
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Leendert van Doorn (leendert@watson.ibm.com)&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;TPM Driver&quot;
)paren
suffix:semicolon
id|MODULE_VERSION
c_func
(paren
l_string|&quot;2.0&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
eof
