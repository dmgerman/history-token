multiline_comment|/*&n; * Copyright (C) 2004 IBM Corporation&n; *&n; * Authors:&n; * Leendert van Doorn &lt;leendert@watson.ibm.com&gt;&n; * Dave Safford &lt;safford@watson.ibm.com&gt;&n; * Reiner Sailer &lt;sailer@watson.ibm.com&gt;&n; * Kylene Hall &lt;kjhall@us.ibm.com&gt;&n; *&n; * Maintained by: &lt;tpmdd_devel@lists.sourceforge.net&gt;&n; *&n; * Device driver for TCG/TCPA TPM (trusted platform module).&n; * Specifications at www.trustedcomputinggroup.org&t; &n; *&n; * This program is free software; you can redistribute it and/or&n; * modify it under the terms of the GNU General Public License as&n; * published by the Free Software Foundation, version 2 of the&n; * License.&n; * &n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/miscdevice.h&gt;
DECL|macro|TPM_TIMEOUT
mdefine_line|#define TPM_TIMEOUT msecs_to_jiffies(5)
multiline_comment|/* TPM addresses */
DECL|macro|TPM_ADDR
mdefine_line|#define&t;TPM_ADDR&t;&t;&t;0x4E
DECL|macro|TPM_DATA
mdefine_line|#define&t;TPM_DATA&t;&t;&t;0x4F
r_struct
id|tpm_chip
suffix:semicolon
DECL|struct|tpm_vendor_specific
r_struct
id|tpm_vendor_specific
(brace
DECL|member|req_complete_mask
id|u8
id|req_complete_mask
suffix:semicolon
DECL|member|req_complete_val
id|u8
id|req_complete_val
suffix:semicolon
DECL|member|base
id|u16
id|base
suffix:semicolon
multiline_comment|/* TPM base address */
DECL|member|recv
r_int
(paren
op_star
id|recv
)paren
(paren
r_struct
id|tpm_chip
op_star
comma
id|u8
op_star
comma
r_int
)paren
suffix:semicolon
DECL|member|send
r_int
(paren
op_star
id|send
)paren
(paren
r_struct
id|tpm_chip
op_star
comma
id|u8
op_star
comma
r_int
)paren
suffix:semicolon
DECL|member|cancel
r_void
(paren
op_star
id|cancel
)paren
(paren
r_struct
id|tpm_chip
op_star
)paren
suffix:semicolon
DECL|member|miscdev
r_struct
id|miscdevice
id|miscdev
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|tpm_chip
r_struct
id|tpm_chip
(brace
DECL|member|pci_dev
r_struct
id|pci_dev
op_star
id|pci_dev
suffix:semicolon
multiline_comment|/* PCI device stuff */
DECL|member|dev_num
r_int
id|dev_num
suffix:semicolon
multiline_comment|/* /dev/tpm# */
DECL|member|num_opens
r_int
id|num_opens
suffix:semicolon
multiline_comment|/* only one allowed */
DECL|member|time_expired
r_int
id|time_expired
suffix:semicolon
multiline_comment|/* Data passed to and from the tpm via the read/write calls */
DECL|member|data_buffer
id|u8
op_star
id|data_buffer
suffix:semicolon
DECL|member|data_pending
id|atomic_t
id|data_pending
suffix:semicolon
DECL|member|buffer_mutex
r_struct
id|semaphore
id|buffer_mutex
suffix:semicolon
DECL|member|user_read_timer
r_struct
id|timer_list
id|user_read_timer
suffix:semicolon
multiline_comment|/* user needs to claim result */
DECL|member|tpm_mutex
r_struct
id|semaphore
id|tpm_mutex
suffix:semicolon
multiline_comment|/* tpm is processing */
DECL|member|device_timer
r_struct
id|timer_list
id|device_timer
suffix:semicolon
multiline_comment|/* tpm is processing */
DECL|member|timer_manipulation_mutex
r_struct
id|semaphore
id|timer_manipulation_mutex
suffix:semicolon
DECL|member|vendor
r_struct
id|tpm_vendor_specific
op_star
id|vendor
suffix:semicolon
DECL|member|list
r_struct
id|list_head
id|list
suffix:semicolon
)brace
suffix:semicolon
DECL|function|tpm_read_index
r_static
r_inline
r_int
id|tpm_read_index
c_func
(paren
r_int
id|index
)paren
(brace
id|outb
c_func
(paren
id|index
comma
id|TPM_ADDR
)paren
suffix:semicolon
r_return
id|inb
c_func
(paren
id|TPM_DATA
)paren
op_amp
l_int|0xFF
suffix:semicolon
)brace
DECL|function|tpm_write_index
r_static
r_inline
r_void
id|tpm_write_index
c_func
(paren
r_int
id|index
comma
r_int
id|value
)paren
(brace
id|outb
c_func
(paren
id|index
comma
id|TPM_ADDR
)paren
suffix:semicolon
id|outb
c_func
(paren
id|value
op_amp
l_int|0xFF
comma
id|TPM_DATA
)paren
suffix:semicolon
)brace
r_extern
r_void
id|tpm_time_expired
c_func
(paren
r_int
r_int
)paren
suffix:semicolon
r_extern
r_int
id|tpm_lpc_bus_init
c_func
(paren
r_struct
id|pci_dev
op_star
comma
id|u16
)paren
suffix:semicolon
r_extern
r_int
id|tpm_register_hardware
c_func
(paren
r_struct
id|pci_dev
op_star
comma
r_struct
id|tpm_vendor_specific
op_star
)paren
suffix:semicolon
r_extern
r_int
id|tpm_open
c_func
(paren
r_struct
id|inode
op_star
comma
r_struct
id|file
op_star
)paren
suffix:semicolon
r_extern
r_int
id|tpm_release
c_func
(paren
r_struct
id|inode
op_star
comma
r_struct
id|file
op_star
)paren
suffix:semicolon
r_extern
id|ssize_t
id|tpm_write
c_func
(paren
r_struct
id|file
op_star
comma
r_const
r_char
id|__user
op_star
comma
r_int
comma
id|loff_t
op_star
)paren
suffix:semicolon
r_extern
id|ssize_t
id|tpm_read
c_func
(paren
r_struct
id|file
op_star
comma
r_char
id|__user
op_star
comma
r_int
comma
id|loff_t
op_star
)paren
suffix:semicolon
r_extern
r_void
id|__devexit
id|tpm_remove
c_func
(paren
r_struct
id|pci_dev
op_star
)paren
suffix:semicolon
r_extern
r_int
id|tpm_pm_suspend
c_func
(paren
r_struct
id|pci_dev
op_star
comma
id|u32
)paren
suffix:semicolon
r_extern
r_int
id|tpm_pm_resume
c_func
(paren
r_struct
id|pci_dev
op_star
)paren
suffix:semicolon
eof
