multiline_comment|/* $Id: sh-sci.c,v 1.16 2004/02/10 17:04:17 lethal Exp $&n; *&n; *  linux/drivers/char/sh-sci.c&n; *&n; *  SuperH on-chip serial module support.  (SCI with no FIFO / with FIFO)&n; *  Copyright (C) 1999, 2000  Niibe Yutaka&n; *  Copyright (C) 2000  Sugioka Toshinobu&n; *  Modified to support multiple serial ports. Stuart Menefy (May 2000).&n; *  Modified to support SH7760 SCIF. Paul Mundt (Oct 2003).&n; *  Modified to support H8/300 Series. Yoshinori Sato (Feb 2004).&n; *&n; * TTY code is based on sx.c (Specialix SX driver) by:&n; *&n; *   (C) 1998 R.E.Wolff@BitWizard.nl&n; *&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/signal.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/tty_flip.h&gt;
macro_line|#include &lt;linux/serial.h&gt;
macro_line|#include &lt;linux/major.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#if defined(CONFIG_SERIAL_CONSOLE) || defined(CONFIG_SH_KGDB_CONSOLE)
macro_line|#include &lt;linux/console.h&gt;
macro_line|#endif
macro_line|#ifdef CONFIG_CPU_FREQ
macro_line|#include &lt;linux/notifier.h&gt;
macro_line|#include &lt;linux/cpufreq.h&gt;
macro_line|#endif
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;linux/generic_serial.h&gt;
macro_line|#ifdef CONFIG_SH_STANDARD_BIOS
macro_line|#include &lt;asm/sh_bios.h&gt;
macro_line|#endif
macro_line|#include &quot;sh-sci.h&quot;
macro_line|#ifdef CONFIG_SH_KGDB
macro_line|#include &lt;asm/kgdb.h&gt;
r_int
id|kgdb_sci_setup
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|kgdb_get_char
c_func
(paren
r_struct
id|sci_port
op_star
id|port
)paren
suffix:semicolon
r_static
r_void
id|kgdb_put_char
c_func
(paren
r_struct
id|sci_port
op_star
id|port
comma
r_char
id|c
)paren
suffix:semicolon
r_static
r_void
id|kgdb_handle_error
c_func
(paren
r_struct
id|sci_port
op_star
id|port
)paren
suffix:semicolon
DECL|variable|kgdb_sci_port
r_static
r_struct
id|sci_port
op_star
id|kgdb_sci_port
suffix:semicolon
macro_line|#ifdef CONFIG_SH_KGDB_CONSOLE
DECL|variable|kgdbcons
r_static
r_struct
id|console
id|kgdbcons
suffix:semicolon
r_void
id|__init
id|kgdb_console_init
c_func
(paren
r_void
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_SH_KGDB_CONSOLE */
macro_line|#endif /* CONFIG_SH_KGDB */
macro_line|#ifdef CONFIG_SERIAL_CONSOLE
DECL|variable|sercons
r_static
r_struct
id|console
id|sercons
suffix:semicolon
DECL|variable|sercons_port
r_static
r_struct
id|sci_port
op_star
id|sercons_port
op_assign
l_int|0
suffix:semicolon
DECL|variable|sercons_baud
r_static
r_int
id|sercons_baud
suffix:semicolon
macro_line|#ifdef CONFIG_MAGIC_SYSRQ
macro_line|#include &lt;linux/sysrq.h&gt;
DECL|variable|break_pressed
r_static
r_int
id|break_pressed
suffix:semicolon
macro_line|#endif /* CONFIG_MAGIC_SYSRQ */
macro_line|#endif /* CONFIG_SERIAL_CONSOLE */
multiline_comment|/* Function prototypes */
r_static
r_void
id|sci_init_pins_sci
c_func
(paren
r_struct
id|sci_port
op_star
id|port
comma
r_int
r_int
id|cflag
)paren
suffix:semicolon
macro_line|#ifndef SCI_ONLY
r_static
r_void
id|sci_init_pins_scif
c_func
(paren
r_struct
id|sci_port
op_star
id|port
comma
r_int
r_int
id|cflag
)paren
suffix:semicolon
macro_line|#if defined(CONFIG_CPU_SH3)
r_static
r_void
id|sci_init_pins_irda
c_func
(paren
r_struct
id|sci_port
op_star
id|port
comma
r_int
r_int
id|cflag
)paren
suffix:semicolon
macro_line|#endif
macro_line|#endif
r_static
r_void
id|sci_disable_tx_interrupts
c_func
(paren
r_void
op_star
id|ptr
)paren
suffix:semicolon
r_static
r_void
id|sci_enable_tx_interrupts
c_func
(paren
r_void
op_star
id|ptr
)paren
suffix:semicolon
r_static
r_void
id|sci_disable_rx_interrupts
c_func
(paren
r_void
op_star
id|ptr
)paren
suffix:semicolon
r_static
r_void
id|sci_enable_rx_interrupts
c_func
(paren
r_void
op_star
id|ptr
)paren
suffix:semicolon
r_static
r_int
id|sci_get_CD
c_func
(paren
r_void
op_star
id|ptr
)paren
suffix:semicolon
r_static
r_void
id|sci_shutdown_port
c_func
(paren
r_void
op_star
id|ptr
)paren
suffix:semicolon
r_static
r_int
id|sci_set_real_termios
c_func
(paren
r_void
op_star
id|ptr
)paren
suffix:semicolon
r_static
r_void
id|sci_hungup
c_func
(paren
r_void
op_star
id|ptr
)paren
suffix:semicolon
r_static
r_void
id|sci_close
c_func
(paren
r_void
op_star
id|ptr
)paren
suffix:semicolon
r_static
r_int
id|sci_chars_in_buffer
c_func
(paren
r_void
op_star
id|ptr
)paren
suffix:semicolon
r_static
r_int
id|sci_request_irq
c_func
(paren
r_struct
id|sci_port
op_star
id|port
)paren
suffix:semicolon
r_static
r_void
id|sci_free_irq
c_func
(paren
r_struct
id|sci_port
op_star
id|port
)paren
suffix:semicolon
r_static
r_int
id|sci_init_drivers
c_func
(paren
r_void
)paren
suffix:semicolon
DECL|variable|sci_driver
r_static
r_struct
id|tty_driver
op_star
id|sci_driver
suffix:semicolon
DECL|variable|sci_ports
r_static
r_struct
id|sci_port
id|sci_ports
(braket
id|SCI_NPORTS
)braket
op_assign
id|SCI_INIT
suffix:semicolon
DECL|variable|sci_debug
r_static
r_int
id|sci_debug
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef MODULE
id|MODULE_PARM
c_func
(paren
id|sci_debug
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
macro_line|#endif
DECL|macro|dprintk
mdefine_line|#define dprintk(x...) do { if (sci_debug) printk(x); } while(0)
macro_line|#ifdef CONFIG_SERIAL_CONSOLE
DECL|function|put_char
r_static
r_void
id|put_char
c_func
(paren
r_struct
id|sci_port
op_star
id|port
comma
r_char
id|c
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|status
suffix:semicolon
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
r_do
id|status
op_assign
id|sci_in
c_func
(paren
id|port
comma
id|SCxSR
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
(paren
id|status
op_amp
id|SCxSR_TDxE
c_func
(paren
id|port
)paren
)paren
)paren
suffix:semicolon
id|sci_out
c_func
(paren
id|port
comma
id|SCxTDR
comma
id|c
)paren
suffix:semicolon
id|sci_in
c_func
(paren
id|port
comma
id|SCxSR
)paren
suffix:semicolon
multiline_comment|/* Dummy read */
id|sci_out
c_func
(paren
id|port
comma
id|SCxSR
comma
id|SCxSR_TDxE_CLEAR
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
macro_line|#endif
macro_line|#if defined(CONFIG_SH_STANDARD_BIOS) || defined(CONFIG_SH_KGDB)
DECL|function|handle_error
r_static
r_void
id|handle_error
c_func
(paren
r_struct
id|sci_port
op_star
id|port
)paren
(brace
multiline_comment|/* Clear error flags */
id|sci_out
c_func
(paren
id|port
comma
id|SCxSR
comma
id|SCxSR_ERROR_CLEAR
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
)brace
DECL|function|get_char
r_static
r_int
id|get_char
c_func
(paren
r_struct
id|sci_port
op_star
id|port
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|status
suffix:semicolon
r_int
id|c
suffix:semicolon
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
r_do
(brace
id|status
op_assign
id|sci_in
c_func
(paren
id|port
comma
id|SCxSR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|SCxSR_ERRORS
c_func
(paren
id|port
)paren
)paren
(brace
id|handle_error
c_func
(paren
id|port
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
op_logical_neg
(paren
id|status
op_amp
id|SCxSR_RDxF
c_func
(paren
id|port
)paren
)paren
)paren
suffix:semicolon
id|c
op_assign
id|sci_in
c_func
(paren
id|port
comma
id|SCxRDR
)paren
suffix:semicolon
id|sci_in
c_func
(paren
id|port
comma
id|SCxSR
)paren
suffix:semicolon
multiline_comment|/* Dummy read */
id|sci_out
c_func
(paren
id|port
comma
id|SCxSR
comma
id|SCxSR_RDxF_CLEAR
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|c
suffix:semicolon
)brace
multiline_comment|/* Taken from sh-stub.c of GDB 4.18 */
DECL|variable|hexchars
r_static
r_const
r_char
id|hexchars
(braket
)braket
op_assign
l_string|&quot;0123456789abcdef&quot;
suffix:semicolon
DECL|function|highhex
r_static
id|__inline__
r_char
id|highhex
c_func
(paren
r_int
id|x
)paren
(brace
r_return
id|hexchars
(braket
(paren
id|x
op_rshift
l_int|4
)paren
op_amp
l_int|0xf
)braket
suffix:semicolon
)brace
DECL|function|lowhex
r_static
id|__inline__
r_char
id|lowhex
c_func
(paren
r_int
id|x
)paren
(brace
r_return
id|hexchars
(braket
id|x
op_amp
l_int|0xf
)braket
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_SH_STANDARD_BIOS || CONFIG_SH_KGDB */
multiline_comment|/*&n; * Send the packet in buffer.  The host gets one chance to read it.&n; * This routine does not wait for a positive acknowledge.&n; */
macro_line|#ifdef CONFIG_SERIAL_CONSOLE
DECL|function|put_string
r_static
r_void
id|put_string
c_func
(paren
r_struct
id|sci_port
op_star
id|port
comma
r_const
r_char
op_star
id|buffer
comma
r_int
id|count
)paren
(brace
r_int
id|i
suffix:semicolon
r_const
r_int
r_char
op_star
id|p
op_assign
id|buffer
suffix:semicolon
macro_line|#if defined(CONFIG_SH_STANDARD_BIOS) || defined(CONFIG_SH_KGDB)
r_int
id|checksum
suffix:semicolon
r_int
id|usegdb
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef CONFIG_SH_STANDARD_BIOS
multiline_comment|/* This call only does a trap the first time it is&n;&t; * called, and so is safe to do here unconditionally&n;&t; */
id|usegdb
op_or_assign
id|sh_bios_in_gdb_mode
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_SH_KGDB
id|usegdb
op_or_assign
(paren
id|kgdb_in_gdb_mode
op_logical_and
(paren
id|port
op_eq
id|kgdb_sci_port
)paren
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|usegdb
)paren
(brace
multiline_comment|/*  $&lt;packet info&gt;#&lt;checksum&gt;. */
r_do
(brace
r_int
r_char
id|c
suffix:semicolon
id|put_char
c_func
(paren
id|port
comma
l_char|&squot;$&squot;
)paren
suffix:semicolon
id|put_char
c_func
(paren
id|port
comma
l_char|&squot;O&squot;
)paren
suffix:semicolon
multiline_comment|/* &squot;O&squot;utput to console */
id|checksum
op_assign
l_char|&squot;O&squot;
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* Don&squot;t use run length encoding */
r_int
id|h
comma
id|l
suffix:semicolon
id|c
op_assign
op_star
id|p
op_increment
suffix:semicolon
id|h
op_assign
id|highhex
c_func
(paren
id|c
)paren
suffix:semicolon
id|l
op_assign
id|lowhex
c_func
(paren
id|c
)paren
suffix:semicolon
id|put_char
c_func
(paren
id|port
comma
id|h
)paren
suffix:semicolon
id|put_char
c_func
(paren
id|port
comma
id|l
)paren
suffix:semicolon
id|checksum
op_add_assign
id|h
op_plus
id|l
suffix:semicolon
)brace
id|put_char
c_func
(paren
id|port
comma
l_char|&squot;#&squot;
)paren
suffix:semicolon
id|put_char
c_func
(paren
id|port
comma
id|highhex
c_func
(paren
id|checksum
)paren
)paren
suffix:semicolon
id|put_char
c_func
(paren
id|port
comma
id|lowhex
c_func
(paren
id|checksum
)paren
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|get_char
c_func
(paren
id|port
)paren
op_ne
l_char|&squot;+&squot;
)paren
suffix:semicolon
)brace
r_else
macro_line|#endif /* CONFIG_SH_STANDARD_BIOS || CONFIG_SH_KGDB */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_star
id|p
op_eq
l_int|10
)paren
id|put_char
c_func
(paren
id|port
comma
l_char|&squot;&bslash;r&squot;
)paren
suffix:semicolon
id|put_char
c_func
(paren
id|port
comma
op_star
id|p
op_increment
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif /* CONFIG_SERIAL_CONSOLE */
macro_line|#ifdef CONFIG_SH_KGDB
multiline_comment|/* Is the SCI ready, ie is there a char waiting? */
DECL|function|kgdb_is_char_ready
r_static
r_int
id|kgdb_is_char_ready
c_func
(paren
r_struct
id|sci_port
op_star
id|port
)paren
(brace
r_int
r_int
id|status
op_assign
id|sci_in
c_func
(paren
id|port
comma
id|SCxSR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
(paren
id|SCxSR_ERRORS
c_func
(paren
id|port
)paren
op_or
id|SCxSR_BRK
c_func
(paren
id|port
)paren
)paren
)paren
id|kgdb_handle_error
c_func
(paren
id|port
)paren
suffix:semicolon
r_return
(paren
id|status
op_amp
id|SCxSR_RDxF
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Write a char */
DECL|function|kgdb_put_char
r_static
r_void
id|kgdb_put_char
c_func
(paren
r_struct
id|sci_port
op_star
id|port
comma
r_char
id|c
)paren
(brace
r_int
r_int
id|status
suffix:semicolon
r_do
id|status
op_assign
id|sci_in
c_func
(paren
id|port
comma
id|SCxSR
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
(paren
id|status
op_amp
id|SCxSR_TDxE
c_func
(paren
id|port
)paren
)paren
)paren
suffix:semicolon
id|sci_out
c_func
(paren
id|port
comma
id|SCxTDR
comma
id|c
)paren
suffix:semicolon
id|sci_in
c_func
(paren
id|port
comma
id|SCxSR
)paren
suffix:semicolon
multiline_comment|/* Dummy read */
id|sci_out
c_func
(paren
id|port
comma
id|SCxSR
comma
id|SCxSR_TDxE_CLEAR
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Get a char if there is one, else ret -1 */
DECL|function|kgdb_get_char
r_static
r_int
id|kgdb_get_char
c_func
(paren
r_struct
id|sci_port
op_star
id|port
)paren
(brace
r_int
id|c
suffix:semicolon
r_if
c_cond
(paren
id|kgdb_is_char_ready
c_func
(paren
id|port
)paren
op_eq
l_int|0
)paren
id|c
op_assign
op_minus
l_int|1
suffix:semicolon
r_else
(brace
id|c
op_assign
id|sci_in
c_func
(paren
id|port
comma
id|SCxRDR
)paren
suffix:semicolon
id|sci_in
c_func
(paren
id|port
comma
id|SCxSR
)paren
suffix:semicolon
multiline_comment|/* Dummy read */
id|sci_out
c_func
(paren
id|port
comma
id|SCxSR
comma
id|SCxSR_RDxF_CLEAR
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
)brace
r_return
id|c
suffix:semicolon
)brace
multiline_comment|/* Called from kgdbstub.c to get a character, i.e. is blocking */
DECL|function|kgdb_sci_getchar
r_static
r_int
id|kgdb_sci_getchar
c_func
(paren
r_void
)paren
(brace
r_volatile
r_int
id|c
suffix:semicolon
multiline_comment|/* Keep trying to read a character, this could be neater */
r_while
c_loop
(paren
(paren
id|c
op_assign
id|kgdb_get_char
c_func
(paren
id|kgdb_sci_port
)paren
)paren
OL
l_int|0
)paren
suffix:semicolon
r_return
id|c
suffix:semicolon
)brace
multiline_comment|/* Called from kgdbstub.c to put a character, just a wrapper */
DECL|function|kgdb_sci_putchar
r_static
r_void
id|kgdb_sci_putchar
c_func
(paren
r_int
id|c
)paren
(brace
id|kgdb_put_char
c_func
(paren
id|kgdb_sci_port
comma
id|c
)paren
suffix:semicolon
)brace
multiline_comment|/* Clear any errors on the SCI */
DECL|function|kgdb_handle_error
r_static
r_void
id|kgdb_handle_error
c_func
(paren
r_struct
id|sci_port
op_star
id|port
)paren
(brace
id|sci_out
c_func
(paren
id|port
comma
id|SCxSR
comma
id|SCxSR_ERROR_CLEAR
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
multiline_comment|/* Clear error flags */
)brace
multiline_comment|/* Breakpoint if there&squot;s a break sent on the serial port */
DECL|function|kgdb_break_interrupt
r_static
r_void
id|kgdb_break_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|ptr
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|sci_port
op_star
id|port
op_assign
id|ptr
suffix:semicolon
r_int
r_int
id|status
op_assign
id|sci_in
c_func
(paren
id|port
comma
id|SCxSR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|SCxSR_BRK
c_func
(paren
id|port
)paren
)paren
(brace
multiline_comment|/* Break into the debugger if a break is detected */
id|BREAKPOINT
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Clear */
id|sci_out
c_func
(paren
id|port
comma
id|SCxSR
comma
id|SCxSR_BREAK_CLEAR
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
macro_line|#endif /* CONFIG_SH_KGDB */
DECL|variable|sci_real_driver
r_static
r_struct
id|real_driver
id|sci_real_driver
op_assign
(brace
id|sci_disable_tx_interrupts
comma
id|sci_enable_tx_interrupts
comma
id|sci_disable_rx_interrupts
comma
id|sci_enable_rx_interrupts
comma
id|sci_get_CD
comma
id|sci_shutdown_port
comma
id|sci_set_real_termios
comma
id|sci_chars_in_buffer
comma
id|sci_close
comma
id|sci_hungup
comma
l_int|NULL
)brace
suffix:semicolon
macro_line|#if !defined(__H8300H__) &amp;&amp; !defined(__H8300S__)
macro_line|#if defined(SCI_ONLY) || defined(SCI_AND_SCIF)
DECL|function|sci_init_pins_sci
r_static
r_void
id|sci_init_pins_sci
c_func
(paren
r_struct
id|sci_port
op_star
id|port
comma
r_int
r_int
id|cflag
)paren
(brace
)brace
macro_line|#endif
macro_line|#if defined(SCIF_ONLY) || defined(SCI_AND_SCIF)
macro_line|#if defined(CONFIG_CPU_SH3)
multiline_comment|/* For SH7707, SH7709, SH7709A, SH7729 */
DECL|function|sci_init_pins_scif
r_static
r_void
id|sci_init_pins_scif
c_func
(paren
r_struct
id|sci_port
op_star
id|port
comma
r_int
r_int
id|cflag
)paren
(brace
r_int
r_int
id|fcr_val
op_assign
l_int|0
suffix:semicolon
(brace
r_int
r_int
id|data
suffix:semicolon
multiline_comment|/* We need to set SCPCR to enable RTS/CTS */
id|data
op_assign
id|ctrl_inw
c_func
(paren
id|SCPCR
)paren
suffix:semicolon
multiline_comment|/* Clear out SCP7MD1,0, SCP6MD1,0, SCP4MD1,0*/
id|ctrl_outw
c_func
(paren
id|data
op_amp
l_int|0x0cff
comma
id|SCPCR
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cflag
op_amp
id|CRTSCTS
)paren
id|fcr_val
op_or_assign
id|SCFCR_MCE
suffix:semicolon
r_else
(brace
r_int
r_int
id|data
suffix:semicolon
multiline_comment|/* We need to set SCPCR to enable RTS/CTS */
id|data
op_assign
id|ctrl_inw
c_func
(paren
id|SCPCR
)paren
suffix:semicolon
multiline_comment|/* Clear out SCP7MD1,0, SCP4MD1,0,&n;&t;&t;   Set SCP6MD1,0 = {01} (output)  */
id|ctrl_outw
c_func
(paren
(paren
id|data
op_amp
l_int|0x0cff
)paren
op_or
l_int|0x1000
comma
id|SCPCR
)paren
suffix:semicolon
id|data
op_assign
id|ctrl_inb
c_func
(paren
id|SCPDR
)paren
suffix:semicolon
multiline_comment|/* Set /RTS2 (bit6) = 0 */
id|ctrl_outb
c_func
(paren
id|data
op_amp
l_int|0xbf
comma
id|SCPDR
)paren
suffix:semicolon
)brace
id|sci_out
c_func
(paren
id|port
comma
id|SCFCR
comma
id|fcr_val
)paren
suffix:semicolon
)brace
DECL|function|sci_init_pins_irda
r_static
r_void
id|sci_init_pins_irda
c_func
(paren
r_struct
id|sci_port
op_star
id|port
comma
r_int
r_int
id|cflag
)paren
(brace
r_int
r_int
id|fcr_val
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|cflag
op_amp
id|CRTSCTS
)paren
id|fcr_val
op_or_assign
id|SCFCR_MCE
suffix:semicolon
id|sci_out
c_func
(paren
id|port
comma
id|SCFCR
comma
id|fcr_val
)paren
suffix:semicolon
)brace
macro_line|#else
multiline_comment|/* For SH7750 */
DECL|function|sci_init_pins_scif
r_static
r_void
id|sci_init_pins_scif
c_func
(paren
r_struct
id|sci_port
op_star
id|port
comma
r_int
r_int
id|cflag
)paren
(brace
r_int
r_int
id|fcr_val
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|cflag
op_amp
id|CRTSCTS
)paren
(brace
id|fcr_val
op_or_assign
id|SCFCR_MCE
suffix:semicolon
)brace
r_else
(brace
id|ctrl_outw
c_func
(paren
l_int|0x0080
comma
id|SCSPTR2
)paren
suffix:semicolon
multiline_comment|/* Set RTS = 1 */
)brace
id|sci_out
c_func
(paren
id|port
comma
id|SCFCR
comma
id|fcr_val
)paren
suffix:semicolon
)brace
macro_line|#endif
macro_line|#endif /* SCIF_ONLY || SCI_AND_SCIF */
macro_line|#else /* !defined(__H8300H__) &amp;&amp; !defined(__H8300S__) */
DECL|function|sci_init_pins_sci
r_static
r_void
id|sci_init_pins_sci
c_func
(paren
r_struct
id|sci_port
op_star
id|port
comma
r_int
r_int
id|cflag
)paren
(brace
r_int
id|ch
op_assign
(paren
id|port-&gt;base
op_minus
id|SMR0
)paren
op_rshift
l_int|3
suffix:semicolon
multiline_comment|/* set DDR regs */
id|H8300_GPIO_DDR
c_func
(paren
id|h8300_sci_pins
(braket
id|ch
)braket
dot
id|port
comma
id|h8300_sci_pins
(braket
id|ch
)braket
dot
id|rx
comma
id|H8300_GPIO_INPUT
)paren
suffix:semicolon
id|H8300_GPIO_DDR
c_func
(paren
id|h8300_sci_pins
(braket
id|ch
)braket
dot
id|port
comma
id|h8300_sci_pins
(braket
id|ch
)braket
dot
id|tx
comma
id|H8300_GPIO_OUTPUT
)paren
suffix:semicolon
multiline_comment|/* tx mark output*/
id|H8300_SCI_DR
c_func
(paren
id|ch
)paren
op_or_assign
id|h8300_sci_pins
(braket
id|ch
)braket
dot
id|tx
suffix:semicolon
)brace
macro_line|#if defined(__H8300S__)
DECL|enumerator|sci_disable
DECL|enumerator|sci_enable
r_enum
(brace
id|sci_disable
comma
id|sci_enable
)brace
suffix:semicolon
DECL|function|h8300_sci_enable
r_static
r_void
id|h8300_sci_enable
c_func
(paren
r_struct
id|sci_port
op_star
id|port
comma
r_int
r_int
id|ctrl
)paren
(brace
r_volatile
r_int
r_char
op_star
id|mstpcrl
op_assign
(paren
r_volatile
r_int
r_char
op_star
)paren
id|MSTPCRL
suffix:semicolon
r_int
id|ch
op_assign
(paren
id|port-&gt;base
op_minus
id|SMR0
)paren
op_rshift
l_int|3
suffix:semicolon
r_int
r_char
id|mask
op_assign
l_int|1
op_lshift
(paren
id|ch
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ctrl
op_eq
id|sci_disable
)paren
op_star
id|mstpcrl
op_or_assign
id|mask
suffix:semicolon
r_else
op_star
id|mstpcrl
op_and_assign
op_complement
id|mask
suffix:semicolon
)brace
macro_line|#endif
macro_line|#endif
DECL|function|sci_setsignals
r_static
r_void
id|sci_setsignals
c_func
(paren
r_struct
id|sci_port
op_star
id|port
comma
r_int
id|dtr
comma
r_int
id|rts
)paren
(brace
multiline_comment|/* This routine is used for seting signals of: DTR, DCD, CTS/RTS */
multiline_comment|/* We use SCIF&squot;s hardware for CTS/RTS, so don&squot;t need any for that. */
multiline_comment|/* If you have signals for DTR and DCD, please implement here. */
suffix:semicolon
)brace
DECL|function|sci_getsignals
r_static
r_int
id|sci_getsignals
c_func
(paren
r_struct
id|sci_port
op_star
id|port
)paren
(brace
multiline_comment|/* This routine is used for geting signals of: DTR, DCD, DSR, RI,&n;&t;   and CTS/RTS */
r_return
id|TIOCM_DTR
op_or
id|TIOCM_RTS
op_or
id|TIOCM_DSR
suffix:semicolon
multiline_comment|/*&n;&t;(((o_stat &amp; OP_DTR)?TIOCM_DTR:0) |&n;&t; ((o_stat &amp; OP_RTS)?TIOCM_RTS:0) |&n;&t; ((i_stat &amp; IP_CTS)?TIOCM_CTS:0) |&n;&t; ((i_stat &amp; IP_DCD)?TIOCM_CAR:0) |&n;&t; ((i_stat &amp; IP_DSR)?TIOCM_DSR:0) |&n;&t; ((i_stat &amp; IP_RI) ?TIOCM_RNG:0)&n;*/
)brace
DECL|function|sci_set_baud
r_static
r_void
id|sci_set_baud
c_func
(paren
r_struct
id|sci_port
op_star
id|port
comma
r_int
id|baud
)paren
(brace
r_int
id|t
suffix:semicolon
r_switch
c_cond
(paren
id|baud
)paren
(brace
r_case
l_int|0
suffix:colon
id|t
op_assign
op_minus
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2400
suffix:colon
id|t
op_assign
id|BPS_2400
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4800
suffix:colon
id|t
op_assign
id|BPS_4800
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|9600
suffix:colon
id|t
op_assign
id|BPS_9600
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|19200
suffix:colon
id|t
op_assign
id|BPS_19200
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|38400
suffix:colon
id|t
op_assign
id|BPS_38400
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|57600
suffix:colon
id|t
op_assign
id|BPS_57600
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;sci: unsupported baud rate: %d, using 115200 instead.&bslash;n&quot;
comma
id|baud
)paren
suffix:semicolon
r_case
l_int|115200
suffix:colon
id|t
op_assign
id|BPS_115200
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|t
OG
l_int|0
)paren
(brace
id|sci_setsignals
(paren
id|port
comma
l_int|1
comma
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|t
op_ge
l_int|256
)paren
(brace
id|sci_out
c_func
(paren
id|port
comma
id|SCSMR
comma
(paren
id|sci_in
c_func
(paren
id|port
comma
id|SCSMR
)paren
op_amp
op_complement
l_int|3
)paren
op_or
l_int|1
)paren
suffix:semicolon
id|t
op_rshift_assign
l_int|2
suffix:semicolon
)brace
r_else
(brace
id|sci_out
c_func
(paren
id|port
comma
id|SCSMR
comma
id|sci_in
c_func
(paren
id|port
comma
id|SCSMR
)paren
op_amp
op_complement
l_int|3
)paren
suffix:semicolon
)brace
id|sci_out
c_func
(paren
id|port
comma
id|SCBRR
comma
id|t
)paren
suffix:semicolon
id|udelay
c_func
(paren
(paren
l_int|1000000
op_plus
(paren
id|baud
op_minus
l_int|1
)paren
)paren
op_div
id|baud
)paren
suffix:semicolon
multiline_comment|/* Wait one bit interval */
)brace
r_else
(brace
id|sci_setsignals
(paren
id|port
comma
l_int|0
comma
op_minus
l_int|1
)paren
suffix:semicolon
)brace
)brace
DECL|function|sci_set_termios_cflag
r_static
r_void
id|sci_set_termios_cflag
c_func
(paren
r_struct
id|sci_port
op_star
id|port
comma
r_int
id|cflag
comma
r_int
id|baud
)paren
(brace
r_int
r_int
id|status
suffix:semicolon
r_int
r_int
id|smr_val
suffix:semicolon
r_do
id|status
op_assign
id|sci_in
c_func
(paren
id|port
comma
id|SCxSR
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
(paren
id|status
op_amp
id|SCxSR_TEND
c_func
(paren
id|port
)paren
)paren
)paren
suffix:semicolon
id|sci_out
c_func
(paren
id|port
comma
id|SCSCR
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* TE=0, RE=0, CKE1=0 */
macro_line|#if !defined(SCI_ONLY)
r_if
c_cond
(paren
id|port-&gt;type
op_eq
id|PORT_SCIF
)paren
(brace
id|sci_out
c_func
(paren
id|port
comma
id|SCFCR
comma
id|SCFCR_RFRST
op_or
id|SCFCR_TFRST
)paren
suffix:semicolon
)brace
macro_line|#endif
id|smr_val
op_assign
id|sci_in
c_func
(paren
id|port
comma
id|SCSMR
)paren
op_amp
l_int|3
suffix:semicolon
r_if
c_cond
(paren
(paren
id|cflag
op_amp
id|CSIZE
)paren
op_eq
id|CS7
)paren
id|smr_val
op_or_assign
l_int|0x40
suffix:semicolon
r_if
c_cond
(paren
id|cflag
op_amp
id|PARENB
)paren
id|smr_val
op_or_assign
l_int|0x20
suffix:semicolon
r_if
c_cond
(paren
id|cflag
op_amp
id|PARODD
)paren
id|smr_val
op_or_assign
l_int|0x30
suffix:semicolon
r_if
c_cond
(paren
id|cflag
op_amp
id|CSTOPB
)paren
id|smr_val
op_or_assign
l_int|0x08
suffix:semicolon
id|sci_out
c_func
(paren
id|port
comma
id|SCSMR
comma
id|smr_val
)paren
suffix:semicolon
id|sci_set_baud
c_func
(paren
id|port
comma
id|baud
)paren
suffix:semicolon
id|port
op_member_access_from_pointer
id|init_pins
c_func
(paren
id|port
comma
id|cflag
)paren
suffix:semicolon
id|sci_out
c_func
(paren
id|port
comma
id|SCSCR
comma
id|SCSCR_INIT
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
)brace
DECL|function|sci_set_real_termios
r_static
r_int
id|sci_set_real_termios
c_func
(paren
r_void
op_star
id|ptr
)paren
(brace
r_struct
id|sci_port
op_star
id|port
op_assign
id|ptr
suffix:semicolon
r_if
c_cond
(paren
id|port-&gt;old_cflag
op_ne
id|port-&gt;gs.tty-&gt;termios-&gt;c_cflag
)paren
(brace
id|port-&gt;old_cflag
op_assign
id|port-&gt;gs.tty-&gt;termios-&gt;c_cflag
suffix:semicolon
id|sci_set_termios_cflag
c_func
(paren
id|port
comma
id|port-&gt;old_cflag
comma
id|port-&gt;gs.baud
)paren
suffix:semicolon
id|sci_enable_rx_interrupts
c_func
(paren
id|port
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* ********************************************************************** *&n; *                   the interrupt related routines                       *&n; * ********************************************************************** */
multiline_comment|/*&n; * This routine is used by the interrupt handler to schedule&n; * processing in the software interrupt portion of the driver.&n; */
DECL|function|sci_sched_event
r_static
r_inline
r_void
id|sci_sched_event
c_func
(paren
r_struct
id|sci_port
op_star
id|port
comma
r_int
id|event
)paren
(brace
id|port-&gt;event
op_or_assign
l_int|1
op_lshift
id|event
suffix:semicolon
id|schedule_work
c_func
(paren
op_amp
id|port-&gt;tqueue
)paren
suffix:semicolon
)brace
DECL|function|sci_transmit_chars
r_static
r_void
id|sci_transmit_chars
c_func
(paren
r_struct
id|sci_port
op_star
id|port
)paren
(brace
r_int
id|count
comma
id|i
suffix:semicolon
r_int
id|txroom
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|status
suffix:semicolon
r_int
r_int
id|ctrl
suffix:semicolon
r_int
r_char
id|c
suffix:semicolon
id|status
op_assign
id|sci_in
c_func
(paren
id|port
comma
id|SCxSR
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_amp
id|SCxSR_TDxE
c_func
(paren
id|port
)paren
)paren
)paren
(brace
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
id|ctrl
op_assign
id|sci_in
c_func
(paren
id|port
comma
id|SCSCR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|port-&gt;gs.xmit_cnt
op_eq
l_int|0
)paren
(brace
id|ctrl
op_and_assign
op_complement
id|SCI_CTRL_FLAGS_TIE
suffix:semicolon
id|port-&gt;gs.flags
op_and_assign
op_complement
id|GS_TX_INTEN
suffix:semicolon
)brace
r_else
id|ctrl
op_or_assign
id|SCI_CTRL_FLAGS_TIE
suffix:semicolon
id|sci_out
c_func
(paren
id|port
comma
id|SCSCR
comma
id|ctrl
)paren
suffix:semicolon
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|count
op_assign
id|port-&gt;gs.xmit_cnt
suffix:semicolon
macro_line|#if !defined(SCI_ONLY)
r_if
c_cond
(paren
id|port-&gt;type
op_eq
id|PORT_SCIF
)paren
(brace
id|txroom
op_assign
l_int|16
op_minus
(paren
id|sci_in
c_func
(paren
id|port
comma
id|SCFDR
)paren
op_rshift
l_int|8
)paren
suffix:semicolon
)brace
r_else
(brace
id|txroom
op_assign
(paren
id|sci_in
c_func
(paren
id|port
comma
id|SCxSR
)paren
op_amp
id|SCI_TDRE
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
)brace
macro_line|#else
id|txroom
op_assign
(paren
id|sci_in
c_func
(paren
id|port
comma
id|SCxSR
)paren
op_amp
id|SCI_TDRE
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|count
OG
id|txroom
)paren
id|count
op_assign
id|txroom
suffix:semicolon
multiline_comment|/* Don&squot;t copy past the end of the source buffer */
r_if
c_cond
(paren
id|count
OG
id|SERIAL_XMIT_SIZE
op_minus
id|port-&gt;gs.xmit_tail
)paren
id|count
op_assign
id|SERIAL_XMIT_SIZE
op_minus
id|port-&gt;gs.xmit_tail
suffix:semicolon
multiline_comment|/* If for one reason or another, we can&squot;t copy more data, we&squot;re done! */
r_if
c_cond
(paren
id|count
op_eq
l_int|0
)paren
r_break
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|c
op_assign
id|port-&gt;gs.xmit_buf
(braket
id|port-&gt;gs.xmit_tail
op_plus
id|i
)braket
suffix:semicolon
id|sci_out
c_func
(paren
id|port
comma
id|SCxTDR
comma
id|c
)paren
suffix:semicolon
)brace
id|sci_out
c_func
(paren
id|port
comma
id|SCxSR
comma
id|SCxSR_TDxE_CLEAR
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
id|port-&gt;icount.tx
op_add_assign
id|count
suffix:semicolon
multiline_comment|/* Update the kernel buffer end */
id|port-&gt;gs.xmit_tail
op_assign
(paren
id|port-&gt;gs.xmit_tail
op_plus
id|count
)paren
op_amp
(paren
id|SERIAL_XMIT_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* This one last. (this is essential)&n;&t;&t;   It would allow others to start putting more data into the buffer! */
id|port-&gt;gs.xmit_cnt
op_sub_assign
id|count
suffix:semicolon
)brace
r_if
c_cond
(paren
id|port-&gt;gs.xmit_cnt
op_le
id|port-&gt;gs.wakeup_chars
)paren
id|sci_sched_event
c_func
(paren
id|port
comma
id|SCI_EVENT_WRITE_WAKEUP
)paren
suffix:semicolon
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
id|ctrl
op_assign
id|sci_in
c_func
(paren
id|port
comma
id|SCSCR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|port-&gt;gs.xmit_cnt
op_eq
l_int|0
)paren
(brace
id|ctrl
op_and_assign
op_complement
id|SCI_CTRL_FLAGS_TIE
suffix:semicolon
id|port-&gt;gs.flags
op_and_assign
op_complement
id|GS_TX_INTEN
suffix:semicolon
)brace
r_else
(brace
macro_line|#if !defined(SCI_ONLY)
r_if
c_cond
(paren
id|port-&gt;type
op_eq
id|PORT_SCIF
)paren
(brace
id|sci_in
c_func
(paren
id|port
comma
id|SCxSR
)paren
suffix:semicolon
multiline_comment|/* Dummy read */
id|sci_out
c_func
(paren
id|port
comma
id|SCxSR
comma
id|SCxSR_TDxE_CLEAR
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
)brace
macro_line|#endif
id|ctrl
op_or_assign
id|SCI_CTRL_FLAGS_TIE
suffix:semicolon
)brace
id|sci_out
c_func
(paren
id|port
comma
id|SCSCR
comma
id|ctrl
)paren
suffix:semicolon
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* On SH3, SCIF may read end-of-break as a space-&gt;mark char */
DECL|macro|STEPFN
mdefine_line|#define STEPFN(c)  ({int __c=(c); (((__c-1)|(__c)) == -1); })
DECL|function|sci_receive_chars
r_static
r_inline
r_void
id|sci_receive_chars
c_func
(paren
r_struct
id|sci_port
op_star
id|port
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
id|i
comma
id|count
suffix:semicolon
r_struct
id|tty_struct
op_star
id|tty
suffix:semicolon
r_int
id|copied
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|status
suffix:semicolon
id|status
op_assign
id|sci_in
c_func
(paren
id|port
comma
id|SCxSR
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_amp
id|SCxSR_RDxF
c_func
(paren
id|port
)paren
)paren
)paren
r_return
suffix:semicolon
id|tty
op_assign
id|port-&gt;gs.tty
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
macro_line|#if !defined(SCI_ONLY)
r_if
c_cond
(paren
id|port-&gt;type
op_eq
id|PORT_SCIF
)paren
(brace
id|count
op_assign
id|sci_in
c_func
(paren
id|port
comma
id|SCFDR
)paren
op_amp
l_int|0x001f
suffix:semicolon
)brace
r_else
(brace
id|count
op_assign
(paren
id|sci_in
c_func
(paren
id|port
comma
id|SCxSR
)paren
op_amp
id|SCxSR_RDxF
c_func
(paren
id|port
)paren
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
)brace
macro_line|#else
id|count
op_assign
(paren
id|sci_in
c_func
(paren
id|port
comma
id|SCxSR
)paren
op_amp
id|SCxSR_RDxF
c_func
(paren
id|port
)paren
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
macro_line|#endif
multiline_comment|/* Don&squot;t copy more bytes than there is room for in the buffer */
r_if
c_cond
(paren
id|tty-&gt;flip.count
op_plus
id|count
OG
id|TTY_FLIPBUF_SIZE
)paren
id|count
op_assign
id|TTY_FLIPBUF_SIZE
op_minus
id|tty-&gt;flip.count
suffix:semicolon
multiline_comment|/* If for any reason we can&squot;t copy more data, we&squot;re done! */
r_if
c_cond
(paren
id|count
op_eq
l_int|0
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|port-&gt;type
op_eq
id|PORT_SCI
)paren
(brace
id|tty-&gt;flip.char_buf_ptr
(braket
l_int|0
)braket
op_assign
id|sci_in
c_func
(paren
id|port
comma
id|SCxRDR
)paren
suffix:semicolon
id|tty-&gt;flip.flag_buf_ptr
(braket
l_int|0
)braket
op_assign
id|TTY_NORMAL
suffix:semicolon
)brace
r_else
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
suffix:semicolon
id|i
op_increment
)paren
(brace
r_char
id|c
op_assign
id|sci_in
c_func
(paren
id|port
comma
id|SCxRDR
)paren
suffix:semicolon
id|status
op_assign
id|sci_in
c_func
(paren
id|port
comma
id|SCxSR
)paren
suffix:semicolon
macro_line|#if defined(__SH3__)
multiline_comment|/* Skip &quot;chars&quot; during break */
r_if
c_cond
(paren
id|port-&gt;break_flag
)paren
(brace
r_if
c_cond
(paren
(paren
id|c
op_eq
l_int|0
)paren
op_logical_and
(paren
id|status
op_amp
id|SCxSR_FER
c_func
(paren
id|port
)paren
)paren
)paren
(brace
id|count
op_decrement
suffix:semicolon
id|i
op_decrement
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/* Nonzero =&gt; end-of-break */
id|dprintk
c_func
(paren
l_string|&quot;scif: debounce&lt;%02x&gt;&bslash;n&quot;
comma
id|c
)paren
suffix:semicolon
id|port-&gt;break_flag
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|STEPFN
c_func
(paren
id|c
)paren
)paren
(brace
id|count
op_decrement
suffix:semicolon
id|i
op_decrement
suffix:semicolon
r_continue
suffix:semicolon
)brace
)brace
macro_line|#endif /* __SH3__ */
macro_line|#if defined(CONFIG_SERIAL_CONSOLE) &amp;&amp; defined(CONFIG_MAGIC_SYSRQ)
r_if
c_cond
(paren
id|break_pressed
op_logical_and
(paren
id|port
op_eq
id|sercons_port
)paren
)paren
(brace
r_if
c_cond
(paren
id|c
op_ne
l_int|0
op_logical_and
id|time_before
c_func
(paren
id|jiffies
comma
id|break_pressed
op_plus
id|HZ
op_star
l_int|5
)paren
)paren
(brace
id|handle_sysrq
c_func
(paren
id|c
comma
id|regs
comma
l_int|NULL
)paren
suffix:semicolon
id|break_pressed
op_assign
l_int|0
suffix:semicolon
id|count
op_decrement
suffix:semicolon
id|i
op_decrement
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|c
op_ne
l_int|0
)paren
(brace
id|break_pressed
op_assign
l_int|0
suffix:semicolon
)brace
)brace
macro_line|#endif /* CONFIG_SERIAL_CONSOLE &amp;&amp; CONFIG_MAGIC_SYSRQ */
multiline_comment|/* Store data and status */
id|tty-&gt;flip.char_buf_ptr
(braket
id|i
)braket
op_assign
id|c
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|SCxSR_FER
c_func
(paren
id|port
)paren
)paren
(brace
id|tty-&gt;flip.flag_buf_ptr
(braket
id|i
)braket
op_assign
id|TTY_FRAME
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;sci: frame error&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|status
op_amp
id|SCxSR_PER
c_func
(paren
id|port
)paren
)paren
(brace
id|tty-&gt;flip.flag_buf_ptr
(braket
id|i
)braket
op_assign
id|TTY_PARITY
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;sci: parity error&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|tty-&gt;flip.flag_buf_ptr
(braket
id|i
)braket
op_assign
id|TTY_NORMAL
suffix:semicolon
)brace
)brace
)brace
id|sci_in
c_func
(paren
id|port
comma
id|SCxSR
)paren
suffix:semicolon
multiline_comment|/* dummy read */
id|sci_out
c_func
(paren
id|port
comma
id|SCxSR
comma
id|SCxSR_RDxF_CLEAR
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
multiline_comment|/* Update the kernel buffer end */
id|tty-&gt;flip.count
op_add_assign
id|count
suffix:semicolon
id|tty-&gt;flip.char_buf_ptr
op_add_assign
id|count
suffix:semicolon
id|tty-&gt;flip.flag_buf_ptr
op_add_assign
id|count
suffix:semicolon
id|copied
op_add_assign
id|count
suffix:semicolon
id|port-&gt;icount.rx
op_add_assign
id|count
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copied
)paren
multiline_comment|/* Tell the rest of the system the news. New characters! */
id|tty_flip_buffer_push
c_func
(paren
id|tty
)paren
suffix:semicolon
r_else
(brace
id|sci_in
c_func
(paren
id|port
comma
id|SCxSR
)paren
suffix:semicolon
multiline_comment|/* dummy read */
id|sci_out
c_func
(paren
id|port
comma
id|SCxSR
comma
id|SCxSR_RDxF_CLEAR
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
)brace
)brace
DECL|function|sci_handle_errors
r_static
r_inline
r_int
id|sci_handle_errors
c_func
(paren
r_struct
id|sci_port
op_star
id|port
)paren
(brace
r_int
id|copied
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|status
op_assign
id|sci_in
c_func
(paren
id|port
comma
id|SCxSR
)paren
suffix:semicolon
r_struct
id|tty_struct
op_star
id|tty
op_assign
id|port-&gt;gs.tty
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|SCxSR_ORER
c_func
(paren
id|port
)paren
op_logical_and
id|tty-&gt;flip.count
OL
id|TTY_FLIPBUF_SIZE
)paren
(brace
multiline_comment|/* overrun error */
id|copied
op_increment
suffix:semicolon
op_star
id|tty-&gt;flip.flag_buf_ptr
op_increment
op_assign
id|TTY_OVERRUN
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;sci: overrun error&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|SCxSR_FER
c_func
(paren
id|port
)paren
op_logical_and
id|tty-&gt;flip.count
OL
id|TTY_FLIPBUF_SIZE
)paren
(brace
r_if
c_cond
(paren
id|sci_rxd_in
c_func
(paren
id|port
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* Notify of BREAK */
id|copied
op_increment
suffix:semicolon
op_star
id|tty-&gt;flip.flag_buf_ptr
op_increment
op_assign
id|TTY_BREAK
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;sci: BREAK detected&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* frame error */
id|copied
op_increment
suffix:semicolon
op_star
id|tty-&gt;flip.flag_buf_ptr
op_increment
op_assign
id|TTY_FRAME
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;sci: frame error&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|status
op_amp
id|SCxSR_PER
c_func
(paren
id|port
)paren
op_logical_and
id|tty-&gt;flip.count
OL
id|TTY_FLIPBUF_SIZE
)paren
(brace
multiline_comment|/* parity error */
id|copied
op_increment
suffix:semicolon
op_star
id|tty-&gt;flip.flag_buf_ptr
op_increment
op_assign
id|TTY_PARITY
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;sci: parity error&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copied
)paren
(brace
id|tty-&gt;flip.count
op_add_assign
id|copied
suffix:semicolon
id|tty_flip_buffer_push
c_func
(paren
id|tty
)paren
suffix:semicolon
)brace
r_return
id|copied
suffix:semicolon
)brace
DECL|function|sci_handle_breaks
r_static
r_inline
r_int
id|sci_handle_breaks
c_func
(paren
r_struct
id|sci_port
op_star
id|port
)paren
(brace
r_int
id|copied
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|status
op_assign
id|sci_in
c_func
(paren
id|port
comma
id|SCxSR
)paren
suffix:semicolon
r_struct
id|tty_struct
op_star
id|tty
op_assign
id|port-&gt;gs.tty
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|SCxSR_BRK
c_func
(paren
id|port
)paren
op_logical_and
id|tty-&gt;flip.count
OL
id|TTY_FLIPBUF_SIZE
)paren
(brace
macro_line|#if defined(__SH3__)
multiline_comment|/* Debounce break */
r_if
c_cond
(paren
id|port-&gt;break_flag
)paren
r_goto
id|break_continue
suffix:semicolon
id|port-&gt;break_flag
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
macro_line|#if defined(CONFIG_SERIAL_CONSOLE) &amp;&amp; defined(CONFIG_MAGIC_SYSRQ)
r_if
c_cond
(paren
id|port
op_eq
id|sercons_port
)paren
(brace
r_if
c_cond
(paren
id|break_pressed
op_eq
l_int|0
)paren
(brace
id|break_pressed
op_assign
id|jiffies
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;sci: implied sysrq&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|break_continue
suffix:semicolon
)brace
multiline_comment|/* Double break implies a real break */
id|break_pressed
op_assign
l_int|0
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* Notify of BREAK */
id|copied
op_increment
suffix:semicolon
op_star
id|tty-&gt;flip.flag_buf_ptr
op_increment
op_assign
id|TTY_BREAK
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;sci: BREAK detected&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|break_continue
suffix:colon
macro_line|#if defined(CONFIG_CPU_SUBTYPE_SH7750) || defined(CONFIG_CPU_SUBTYPE_ST40STB1) || &bslash;&n;    defined(CONFIG_CPU_SUBTYPE_SH7760)
multiline_comment|/* XXX: Handle SCIF overrun error */
r_if
c_cond
(paren
id|port-&gt;type
op_eq
id|PORT_SCIF
op_logical_and
(paren
id|sci_in
c_func
(paren
id|port
comma
id|SCLSR
)paren
op_amp
id|SCIF_ORER
)paren
op_ne
l_int|0
)paren
(brace
id|sci_out
c_func
(paren
id|port
comma
id|SCLSR
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tty-&gt;flip.count
OL
id|TTY_FLIPBUF_SIZE
)paren
(brace
id|copied
op_increment
suffix:semicolon
op_star
id|tty-&gt;flip.flag_buf_ptr
op_increment
op_assign
id|TTY_OVERRUN
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;sci: overrun error&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
r_if
c_cond
(paren
id|copied
)paren
(brace
id|tty-&gt;flip.count
op_add_assign
id|copied
suffix:semicolon
id|tty_flip_buffer_push
c_func
(paren
id|tty
)paren
suffix:semicolon
)brace
r_return
id|copied
suffix:semicolon
)brace
DECL|function|sci_rx_interrupt
r_static
id|irqreturn_t
id|sci_rx_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|ptr
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|sci_port
op_star
id|port
op_assign
id|ptr
suffix:semicolon
r_if
c_cond
(paren
id|port-&gt;gs.flags
op_amp
id|GS_ACTIVE
)paren
r_if
c_cond
(paren
op_logical_neg
(paren
id|port-&gt;gs.flags
op_amp
id|SCI_RX_THROTTLE
)paren
)paren
(brace
id|sci_receive_chars
c_func
(paren
id|port
comma
id|regs
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
id|sci_disable_rx_interrupts
c_func
(paren
id|port
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
DECL|function|sci_tx_interrupt
r_static
id|irqreturn_t
id|sci_tx_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|ptr
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|sci_port
op_star
id|port
op_assign
id|ptr
suffix:semicolon
r_if
c_cond
(paren
id|port-&gt;gs.flags
op_amp
id|GS_ACTIVE
)paren
id|sci_transmit_chars
c_func
(paren
id|port
)paren
suffix:semicolon
r_else
(brace
id|sci_disable_tx_interrupts
c_func
(paren
id|port
)paren
suffix:semicolon
)brace
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
DECL|function|sci_er_interrupt
r_static
id|irqreturn_t
id|sci_er_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|ptr
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|sci_port
op_star
id|port
op_assign
id|ptr
suffix:semicolon
multiline_comment|/* Handle errors */
r_if
c_cond
(paren
id|port-&gt;type
op_eq
id|PORT_SCI
)paren
(brace
r_if
c_cond
(paren
id|sci_handle_errors
c_func
(paren
id|port
)paren
)paren
(brace
multiline_comment|/* discard character in rx buffer */
id|sci_in
c_func
(paren
id|port
comma
id|SCxSR
)paren
suffix:semicolon
id|sci_out
c_func
(paren
id|port
comma
id|SCxSR
comma
id|SCxSR_RDxF_CLEAR
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
)brace
)brace
r_else
id|sci_rx_interrupt
c_func
(paren
id|irq
comma
id|ptr
comma
id|regs
)paren
suffix:semicolon
id|sci_out
c_func
(paren
id|port
comma
id|SCxSR
comma
id|SCxSR_ERROR_CLEAR
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
multiline_comment|/* Kick the transmission */
id|sci_tx_interrupt
c_func
(paren
id|irq
comma
id|ptr
comma
id|regs
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
macro_line|#if !defined(SCI_ONLY)
DECL|function|sci_br_interrupt
r_static
id|irqreturn_t
id|sci_br_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|ptr
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|sci_port
op_star
id|port
op_assign
id|ptr
suffix:semicolon
multiline_comment|/* Handle BREAKs */
id|sci_handle_breaks
c_func
(paren
id|port
)paren
suffix:semicolon
id|sci_out
c_func
(paren
id|port
comma
id|SCxSR
comma
id|SCxSR_BREAK_CLEAR
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
macro_line|#endif
DECL|function|do_softint
r_static
r_void
id|do_softint
c_func
(paren
r_void
op_star
id|private_
)paren
(brace
r_struct
id|sci_port
op_star
id|port
op_assign
(paren
r_struct
id|sci_port
op_star
)paren
id|private_
suffix:semicolon
r_struct
id|tty_struct
op_star
id|tty
suffix:semicolon
id|tty
op_assign
id|port-&gt;gs.tty
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tty
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|test_and_clear_bit
c_func
(paren
id|SCI_EVENT_WRITE_WAKEUP
comma
op_amp
id|port-&gt;event
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|tty-&gt;flags
op_amp
(paren
l_int|1
op_lshift
id|TTY_DO_WRITE_WAKEUP
)paren
)paren
op_logical_and
id|tty-&gt;ldisc.write_wakeup
)paren
(paren
id|tty-&gt;ldisc.write_wakeup
)paren
(paren
id|tty
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|tty-&gt;write_wait
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* ********************************************************************** *&n; *                Here are the routines that actually                     *&n; *              interface with the generic_serial driver                  *&n; * ********************************************************************** */
DECL|function|sci_disable_tx_interrupts
r_static
r_void
id|sci_disable_tx_interrupts
c_func
(paren
r_void
op_star
id|ptr
)paren
(brace
r_struct
id|sci_port
op_star
id|port
op_assign
id|ptr
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|ctrl
suffix:semicolon
multiline_comment|/* Clear TIE (Transmit Interrupt Enable) bit in SCSCR */
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
id|ctrl
op_assign
id|sci_in
c_func
(paren
id|port
comma
id|SCSCR
)paren
suffix:semicolon
id|ctrl
op_and_assign
op_complement
id|SCI_CTRL_FLAGS_TIE
suffix:semicolon
id|sci_out
c_func
(paren
id|port
comma
id|SCSCR
comma
id|ctrl
)paren
suffix:semicolon
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|sci_enable_tx_interrupts
r_static
r_void
id|sci_enable_tx_interrupts
c_func
(paren
r_void
op_star
id|ptr
)paren
(brace
r_struct
id|sci_port
op_star
id|port
op_assign
id|ptr
suffix:semicolon
id|disable_irq
c_func
(paren
id|port-&gt;irqs
(braket
id|SCIx_TXI_IRQ
)braket
)paren
suffix:semicolon
id|sci_transmit_chars
c_func
(paren
id|port
)paren
suffix:semicolon
id|enable_irq
c_func
(paren
id|port-&gt;irqs
(braket
id|SCIx_TXI_IRQ
)braket
)paren
suffix:semicolon
)brace
DECL|function|sci_disable_rx_interrupts
r_static
r_void
id|sci_disable_rx_interrupts
c_func
(paren
r_void
op_star
id|ptr
)paren
(brace
r_struct
id|sci_port
op_star
id|port
op_assign
id|ptr
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|ctrl
suffix:semicolon
multiline_comment|/* Clear RIE (Receive Interrupt Enable) bit in SCSCR */
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
id|ctrl
op_assign
id|sci_in
c_func
(paren
id|port
comma
id|SCSCR
)paren
suffix:semicolon
id|ctrl
op_and_assign
op_complement
id|SCI_CTRL_FLAGS_RIE
suffix:semicolon
id|sci_out
c_func
(paren
id|port
comma
id|SCSCR
comma
id|ctrl
)paren
suffix:semicolon
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|sci_enable_rx_interrupts
r_static
r_void
id|sci_enable_rx_interrupts
c_func
(paren
r_void
op_star
id|ptr
)paren
(brace
r_struct
id|sci_port
op_star
id|port
op_assign
id|ptr
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|ctrl
suffix:semicolon
multiline_comment|/* Set RIE (Receive Interrupt Enable) bit in SCSCR */
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
id|ctrl
op_assign
id|sci_in
c_func
(paren
id|port
comma
id|SCSCR
)paren
suffix:semicolon
id|ctrl
op_or_assign
id|SCI_CTRL_FLAGS_RIE
suffix:semicolon
id|sci_out
c_func
(paren
id|port
comma
id|SCSCR
comma
id|ctrl
)paren
suffix:semicolon
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|sci_get_CD
r_static
r_int
id|sci_get_CD
c_func
(paren
r_void
op_star
id|ptr
)paren
(brace
multiline_comment|/* If you have signal for CD (Carrier Detect), please change here. */
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|sci_chars_in_buffer
r_static
r_int
id|sci_chars_in_buffer
c_func
(paren
r_void
op_star
id|ptr
)paren
(brace
r_struct
id|sci_port
op_star
id|port
op_assign
id|ptr
suffix:semicolon
macro_line|#if !defined(SCI_ONLY)
r_if
c_cond
(paren
id|port-&gt;type
op_eq
id|PORT_SCIF
)paren
(brace
r_return
(paren
id|sci_in
c_func
(paren
id|port
comma
id|SCFDR
)paren
op_rshift
l_int|8
)paren
op_plus
(paren
(paren
id|sci_in
c_func
(paren
id|port
comma
id|SCxSR
)paren
op_amp
id|SCxSR_TEND
c_func
(paren
id|port
)paren
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|1
)paren
suffix:semicolon
)brace
r_else
(brace
r_return
(paren
id|sci_in
c_func
(paren
id|port
comma
id|SCxSR
)paren
op_amp
id|SCxSR_TEND
c_func
(paren
id|port
)paren
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|1
suffix:semicolon
)brace
macro_line|#else
r_return
(paren
id|sci_in
c_func
(paren
id|port
comma
id|SCxSR
)paren
op_amp
id|SCxSR_TEND
c_func
(paren
id|port
)paren
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|1
suffix:semicolon
macro_line|#endif
)brace
DECL|function|sci_shutdown_port
r_static
r_void
id|sci_shutdown_port
c_func
(paren
r_void
op_star
id|ptr
)paren
(brace
r_struct
id|sci_port
op_star
id|port
op_assign
id|ptr
suffix:semicolon
id|port-&gt;gs.flags
op_and_assign
op_complement
id|GS_ACTIVE
suffix:semicolon
r_if
c_cond
(paren
id|port-&gt;gs.tty
op_logical_and
id|port-&gt;gs.tty-&gt;termios-&gt;c_cflag
op_amp
id|HUPCL
)paren
id|sci_setsignals
c_func
(paren
id|port
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|sci_free_irq
c_func
(paren
id|port
)paren
suffix:semicolon
macro_line|#if defined(__H8300S__)
id|h8300_sci_enable
c_func
(paren
id|port
comma
id|sci_disable
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/* ********************************************************************** *&n; *                Here are the routines that actually                     *&n; *               interface with the rest of the system                    *&n; * ********************************************************************** */
DECL|function|sci_open
r_static
r_int
id|sci_open
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_struct
id|sci_port
op_star
id|port
suffix:semicolon
r_int
id|retval
comma
id|line
suffix:semicolon
id|line
op_assign
id|tty-&gt;index
suffix:semicolon
r_if
c_cond
(paren
(paren
id|line
OL
l_int|0
)paren
op_logical_or
(paren
id|line
op_ge
id|SCI_NPORTS
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|port
op_assign
op_amp
id|sci_ports
(braket
id|line
)braket
suffix:semicolon
id|tty-&gt;driver_data
op_assign
id|port
suffix:semicolon
id|port-&gt;gs.tty
op_assign
id|tty
suffix:semicolon
id|port-&gt;gs.count
op_increment
suffix:semicolon
id|port-&gt;event
op_assign
l_int|0
suffix:semicolon
id|INIT_WORK
c_func
(paren
op_amp
id|port-&gt;tqueue
comma
id|do_softint
comma
id|port
)paren
suffix:semicolon
macro_line|#if defined(__H8300S__)
id|h8300_sci_enable
c_func
(paren
id|port
comma
id|sci_enable
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;&t; * Start up serial port&n;&t; */
id|retval
op_assign
id|gs_init_port
c_func
(paren
op_amp
id|port-&gt;gs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
r_goto
id|failed_1
suffix:semicolon
)brace
id|port-&gt;gs.flags
op_or_assign
id|GS_ACTIVE
suffix:semicolon
id|sci_setsignals
c_func
(paren
id|port
comma
l_int|1
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|port-&gt;gs.count
op_eq
l_int|1
)paren
(brace
id|retval
op_assign
id|sci_request_irq
c_func
(paren
id|port
)paren
suffix:semicolon
)brace
id|retval
op_assign
id|gs_block_til_ready
c_func
(paren
id|port
comma
id|filp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
r_goto
id|failed_3
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_SERIAL_CONSOLE
r_if
c_cond
(paren
id|sercons.cflag
op_logical_and
id|sercons.index
op_eq
id|line
)paren
(brace
id|tty-&gt;termios-&gt;c_cflag
op_assign
id|sercons.cflag
suffix:semicolon
id|port-&gt;gs.baud
op_assign
id|sercons_baud
suffix:semicolon
id|sercons.cflag
op_assign
l_int|0
suffix:semicolon
id|sci_set_real_termios
c_func
(paren
id|port
)paren
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifdef CONFIG_SH_KGDB_CONSOLE
r_if
c_cond
(paren
id|kgdbcons.cflag
op_logical_and
id|kgdbcons.index
op_eq
id|line
)paren
(brace
id|tty-&gt;termios-&gt;c_cflag
op_assign
id|kgdbcons.cflag
suffix:semicolon
id|port-&gt;gs.baud
op_assign
id|kgdb_baud
suffix:semicolon
id|sercons.cflag
op_assign
l_int|0
suffix:semicolon
id|sci_set_real_termios
c_func
(paren
id|port
)paren
suffix:semicolon
)brace
macro_line|#endif
id|sci_enable_rx_interrupts
c_func
(paren
id|port
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|failed_3
suffix:colon
id|sci_free_irq
c_func
(paren
id|port
)paren
suffix:semicolon
id|failed_1
suffix:colon
id|port-&gt;gs.count
op_decrement
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
DECL|function|sci_hungup
r_static
r_void
id|sci_hungup
c_func
(paren
r_void
op_star
id|ptr
)paren
(brace
r_return
suffix:semicolon
)brace
DECL|function|sci_close
r_static
r_void
id|sci_close
c_func
(paren
r_void
op_star
id|ptr
)paren
(brace
r_return
suffix:semicolon
)brace
DECL|function|sci_tiocmget
r_static
r_int
id|sci_tiocmget
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|sci_port
op_star
id|port
op_assign
id|tty-&gt;driver_data
suffix:semicolon
r_return
id|sci_getsignals
c_func
(paren
id|port
)paren
suffix:semicolon
)brace
DECL|function|sci_tiocmset
r_static
r_int
id|sci_tiocmset
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|set
comma
r_int
r_int
id|clear
)paren
(brace
r_struct
id|sci_port
op_star
id|port
op_assign
id|tty-&gt;driver_data
suffix:semicolon
r_int
id|rts
op_assign
op_minus
l_int|1
comma
id|dtr
op_assign
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|set
op_amp
id|TIOCM_RTS
)paren
id|rts
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|set
op_amp
id|TIOCM_DTR
)paren
id|dtr
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|clear
op_amp
id|TIOCM_RTS
)paren
id|rts
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|clear
op_amp
id|TIOCM_DTR
)paren
id|dtr
op_assign
l_int|0
suffix:semicolon
id|sci_setsignals
c_func
(paren
id|port
comma
id|dtr
comma
id|rts
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sci_ioctl
r_static
r_int
id|sci_ioctl
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|filp
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_int
id|rc
suffix:semicolon
r_struct
id|sci_port
op_star
id|port
op_assign
id|tty-&gt;driver_data
suffix:semicolon
r_int
id|ival
suffix:semicolon
id|rc
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|TIOCGSOFTCAR
suffix:colon
id|rc
op_assign
id|put_user
c_func
(paren
(paren
(paren
id|tty-&gt;termios-&gt;c_cflag
op_amp
id|CLOCAL
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
comma
(paren
r_int
r_int
id|__user
op_star
)paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TIOCSSOFTCAR
suffix:colon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|get_user
c_func
(paren
id|ival
comma
(paren
r_int
r_int
id|__user
op_star
)paren
id|arg
)paren
)paren
op_eq
l_int|0
)paren
id|tty-&gt;termios-&gt;c_cflag
op_assign
(paren
id|tty-&gt;termios-&gt;c_cflag
op_amp
op_complement
id|CLOCAL
)paren
op_or
(paren
id|ival
ques
c_cond
id|CLOCAL
suffix:colon
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TIOCGSERIAL
suffix:colon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
(paren
r_void
id|__user
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|serial_struct
)paren
)paren
)paren
op_eq
l_int|0
)paren
id|rc
op_assign
id|gs_getserial
c_func
(paren
op_amp
id|port-&gt;gs
comma
(paren
r_struct
id|serial_struct
op_star
)paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TIOCSSERIAL
suffix:colon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|verify_area
c_func
(paren
id|VERIFY_READ
comma
(paren
r_void
id|__user
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|serial_struct
)paren
)paren
)paren
op_eq
l_int|0
)paren
id|rc
op_assign
id|gs_setserial
c_func
(paren
op_amp
id|port-&gt;gs
comma
(paren
r_struct
id|serial_struct
op_star
)paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|rc
op_assign
op_minus
id|ENOIOCTLCMD
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|rc
suffix:semicolon
)brace
DECL|function|sci_throttle
r_static
r_void
id|sci_throttle
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_struct
id|sci_port
op_star
id|port
op_assign
(paren
r_struct
id|sci_port
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
multiline_comment|/* If the port is using any type of input flow&n;&t; * control then throttle the port.&n;&t; */
r_if
c_cond
(paren
(paren
id|tty-&gt;termios-&gt;c_cflag
op_amp
id|CRTSCTS
)paren
op_logical_or
(paren
id|I_IXOFF
c_func
(paren
id|tty
)paren
)paren
)paren
id|port-&gt;gs.flags
op_or_assign
id|SCI_RX_THROTTLE
suffix:semicolon
)brace
DECL|function|sci_unthrottle
r_static
r_void
id|sci_unthrottle
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_struct
id|sci_port
op_star
id|port
op_assign
(paren
r_struct
id|sci_port
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
multiline_comment|/* Always unthrottle even if flow control is not enabled on&n;&t; * this port in case we disabled flow control while the port&n;&t; * was throttled&n;&t; */
id|port-&gt;gs.flags
op_and_assign
op_complement
id|SCI_RX_THROTTLE
suffix:semicolon
id|sci_enable_rx_interrupts
c_func
(paren
id|port
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_PROC_FS
DECL|function|sci_read_proc
r_static
r_int
id|sci_read_proc
c_func
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|sci_port
op_star
id|port
suffix:semicolon
r_int
id|len
op_assign
l_int|0
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
comma
l_string|&quot;sciinfo:0.1&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|SCI_NPORTS
op_logical_and
id|len
OL
l_int|4000
suffix:semicolon
id|i
op_increment
)paren
(brace
id|port
op_assign
op_amp
id|sci_ports
(braket
id|i
)braket
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot;%d: uart:%s address: %08x&quot;
comma
id|i
comma
(paren
id|port-&gt;type
op_eq
id|PORT_SCI
)paren
ques
c_cond
l_string|&quot;SCI&quot;
suffix:colon
l_string|&quot;SCIF&quot;
comma
id|port-&gt;base
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot; baud:%d&quot;
comma
id|port-&gt;gs.baud
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot; tx:%d rx:%d&quot;
comma
id|port-&gt;icount.tx
comma
id|port-&gt;icount.rx
)paren
suffix:semicolon
r_if
c_cond
(paren
id|port-&gt;icount.frame
)paren
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot; fe:%d&quot;
comma
id|port-&gt;icount.frame
)paren
suffix:semicolon
r_if
c_cond
(paren
id|port-&gt;icount.parity
)paren
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot; pe:%d&quot;
comma
id|port-&gt;icount.parity
)paren
suffix:semicolon
r_if
c_cond
(paren
id|port-&gt;icount.brk
)paren
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot; brk:%d&quot;
comma
id|port-&gt;icount.brk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|port-&gt;icount.overrun
)paren
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot; oe:%d&quot;
comma
id|port-&gt;icount.overrun
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_return
id|len
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifdef CONFIG_CPU_FREQ
multiline_comment|/*&n; * Here we define a transistion notifier so that we can update all of our&n; * ports&squot; baud rate when the peripheral clock changes.&n; */
DECL|function|sci_notifier
r_static
r_int
id|sci_notifier
c_func
(paren
r_struct
id|notifier_block
op_star
id|self
comma
r_int
r_int
id|phase
comma
r_void
op_star
id|p
)paren
(brace
r_struct
id|cpufreq_freqs
op_star
id|freqs
op_assign
id|p
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|phase
op_eq
id|CPUFREQ_POSTCHANGE
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|SCI_NPORTS
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * This will force a baud rate change in hardware.&n;&t;&t;&t; */
r_if
c_cond
(paren
id|sci_ports
(braket
id|i
)braket
dot
id|gs.tty
op_ne
l_int|NULL
)paren
(brace
id|sci_set_baud
c_func
(paren
op_amp
id|sci_ports
(braket
id|i
)braket
comma
id|sci_ports
(braket
id|i
)braket
dot
id|gs.baud
)paren
suffix:semicolon
)brace
)brace
id|printk
c_func
(paren
l_string|&quot;%s: got a postchange notification for cpu %d (old %d, new %d)&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|freqs-&gt;cpu
comma
id|freqs-&gt;old
comma
id|freqs
op_member_access_from_pointer
r_new
)paren
suffix:semicolon
)brace
r_return
id|NOTIFY_OK
suffix:semicolon
)brace
DECL|variable|sci_nb
r_static
r_struct
id|notifier_block
id|sci_nb
op_assign
(brace
op_amp
id|sci_notifier
comma
l_int|NULL
comma
l_int|0
)brace
suffix:semicolon
macro_line|#endif /* CONFIG_CPU_FREQ */
DECL|variable|sci_ops
r_static
r_struct
id|tty_operations
id|sci_ops
op_assign
(brace
dot
id|open
op_assign
id|sci_open
comma
dot
id|close
op_assign
id|gs_close
comma
dot
id|write
op_assign
id|gs_write
comma
dot
id|put_char
op_assign
id|gs_put_char
comma
dot
id|flush_chars
op_assign
id|gs_flush_chars
comma
dot
id|write_room
op_assign
id|gs_write_room
comma
dot
id|chars_in_buffer
op_assign
id|gs_chars_in_buffer
comma
dot
id|flush_buffer
op_assign
id|gs_flush_buffer
comma
dot
id|ioctl
op_assign
id|sci_ioctl
comma
dot
id|throttle
op_assign
id|sci_throttle
comma
dot
id|unthrottle
op_assign
id|sci_unthrottle
comma
dot
id|set_termios
op_assign
id|gs_set_termios
comma
dot
id|stop
op_assign
id|gs_stop
comma
dot
id|start
op_assign
id|gs_start
comma
dot
id|hangup
op_assign
id|gs_hangup
comma
macro_line|#ifdef CONFIG_PROC_FS
dot
id|read_proc
op_assign
id|sci_read_proc
comma
macro_line|#endif
dot
id|tiocmget
op_assign
id|sci_tiocmget
comma
dot
id|tiocmset
op_assign
id|sci_tiocmset
comma
)brace
suffix:semicolon
multiline_comment|/* ********************************************************************** *&n; *                    Here are the initialization routines.               *&n; * ********************************************************************** */
DECL|function|sci_init_drivers
r_static
r_int
id|sci_init_drivers
c_func
(paren
r_void
)paren
(brace
r_int
id|error
suffix:semicolon
r_struct
id|sci_port
op_star
id|port
suffix:semicolon
id|sci_driver
op_assign
id|alloc_tty_driver
c_func
(paren
id|SCI_NPORTS
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sci_driver
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|sci_driver-&gt;owner
op_assign
id|THIS_MODULE
suffix:semicolon
id|sci_driver-&gt;driver_name
op_assign
l_string|&quot;sci&quot;
suffix:semicolon
id|sci_driver-&gt;name
op_assign
l_string|&quot;ttySC&quot;
suffix:semicolon
id|sci_driver-&gt;devfs_name
op_assign
l_string|&quot;ttsc/&quot;
suffix:semicolon
id|sci_driver-&gt;major
op_assign
id|SCI_MAJOR
suffix:semicolon
id|sci_driver-&gt;minor_start
op_assign
id|SCI_MINOR_START
suffix:semicolon
id|sci_driver-&gt;type
op_assign
id|TTY_DRIVER_TYPE_SERIAL
suffix:semicolon
id|sci_driver-&gt;subtype
op_assign
id|SERIAL_TYPE_NORMAL
suffix:semicolon
id|sci_driver-&gt;init_termios
op_assign
id|tty_std_termios
suffix:semicolon
id|sci_driver-&gt;init_termios.c_cflag
op_assign
id|B9600
op_or
id|CS8
op_or
id|CREAD
op_or
id|HUPCL
op_or
id|CLOCAL
op_or
id|CRTSCTS
suffix:semicolon
id|sci_driver-&gt;flags
op_assign
id|TTY_DRIVER_REAL_RAW
suffix:semicolon
id|tty_set_operations
c_func
(paren
id|sci_driver
comma
op_amp
id|sci_ops
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|error
op_assign
id|tty_register_driver
c_func
(paren
id|sci_driver
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;sci: Couldn&squot;t register SCI driver, error = %d&bslash;n&quot;
comma
id|error
)paren
suffix:semicolon
id|put_tty_driver
c_func
(paren
id|sci_driver
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_for
c_loop
(paren
id|port
op_assign
op_amp
id|sci_ports
(braket
l_int|0
)braket
suffix:semicolon
id|port
OL
op_amp
id|sci_ports
(braket
id|SCI_NPORTS
)braket
suffix:semicolon
id|port
op_increment
)paren
(brace
id|port-&gt;gs.magic
op_assign
id|SCI_MAGIC
suffix:semicolon
id|port-&gt;gs.close_delay
op_assign
id|HZ
op_div
l_int|2
suffix:semicolon
id|port-&gt;gs.closing_wait
op_assign
l_int|30
op_star
id|HZ
suffix:semicolon
id|port-&gt;gs.rd
op_assign
op_amp
id|sci_real_driver
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|port-&gt;gs.open_wait
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|port-&gt;gs.close_wait
)paren
suffix:semicolon
id|port-&gt;old_cflag
op_assign
l_int|0
suffix:semicolon
id|port-&gt;icount.cts
op_assign
id|port-&gt;icount.dsr
op_assign
id|port-&gt;icount.rng
op_assign
id|port-&gt;icount.dcd
op_assign
l_int|0
suffix:semicolon
id|port-&gt;icount.rx
op_assign
id|port-&gt;icount.tx
op_assign
l_int|0
suffix:semicolon
id|port-&gt;icount.frame
op_assign
id|port-&gt;icount.parity
op_assign
l_int|0
suffix:semicolon
id|port-&gt;icount.overrun
op_assign
id|port-&gt;icount.brk
op_assign
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_CPU_FREQ
multiline_comment|/* Setup transition notifier */
r_if
c_cond
(paren
id|cpufreq_register_notifier
c_func
(paren
op_amp
id|sci_nb
comma
id|CPUFREQ_TRANSITION_NOTIFIER
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;sci: Unable to register CPU frequency notifier&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;sci: CPU frequency notifier registered&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sci_request_irq
r_static
r_int
id|sci_request_irq
c_func
(paren
r_struct
id|sci_port
op_star
id|port
)paren
(brace
r_int
id|i
suffix:semicolon
macro_line|#if !defined(SCI_ONLY)
id|irqreturn_t
(paren
op_star
id|handlers
(braket
l_int|4
)braket
)paren
(paren
r_int
id|irq
comma
r_void
op_star
id|p
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
op_assign
(brace
id|sci_er_interrupt
comma
id|sci_rx_interrupt
comma
id|sci_tx_interrupt
comma
id|sci_br_interrupt
comma
)brace
suffix:semicolon
macro_line|#else
r_void
(paren
op_star
id|handlers
(braket
l_int|3
)braket
)paren
(paren
r_int
id|irq
comma
r_void
op_star
id|ptr
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
op_assign
(brace
id|sci_er_interrupt
comma
id|sci_rx_interrupt
comma
id|sci_tx_interrupt
comma
)brace
suffix:semicolon
macro_line|#endif
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
r_sizeof
(paren
id|handlers
)paren
op_div
r_sizeof
(paren
id|handlers
(braket
l_int|0
)braket
)paren
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|port-&gt;irqs
(braket
id|i
)braket
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|port-&gt;irqs
(braket
id|i
)braket
comma
id|handlers
(braket
id|i
)braket
comma
id|SA_INTERRUPT
comma
l_string|&quot;sci&quot;
comma
id|port
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;sci: Cannot allocate irq.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sci_free_irq
r_static
r_void
id|sci_free_irq
c_func
(paren
r_struct
id|sci_port
op_star
id|port
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|port-&gt;irqs
(braket
id|i
)braket
)paren
r_continue
suffix:semicolon
id|free_irq
c_func
(paren
id|port-&gt;irqs
(braket
id|i
)braket
comma
id|port
)paren
suffix:semicolon
)brace
)brace
DECL|variable|__initdata
r_static
r_char
id|banner
(braket
)braket
id|__initdata
op_assign
id|KERN_INFO
l_string|&quot;SuperH SCI(F) driver initialized&bslash;n&quot;
suffix:semicolon
DECL|function|sci_init
r_int
id|__init
id|sci_init
c_func
(paren
r_void
)paren
(brace
r_struct
id|sci_port
op_star
id|port
suffix:semicolon
r_int
id|j
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s&quot;
comma
id|banner
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|SCI_NPORTS
suffix:semicolon
id|j
op_increment
)paren
(brace
id|port
op_assign
op_amp
id|sci_ports
(braket
id|j
)braket
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;ttySC%d at 0x%08x is a %s&bslash;n&quot;
comma
id|j
comma
id|port-&gt;base
comma
(paren
id|port-&gt;type
op_eq
id|PORT_SCI
)paren
ques
c_cond
l_string|&quot;SCI&quot;
suffix:colon
l_string|&quot;SCIF&quot;
)paren
suffix:semicolon
)brace
id|sci_init_drivers
c_func
(paren
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_SH_STANDARD_BIOS
id|sh_bios_gdb_detach
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Return -EIO when not detected */
)brace
DECL|variable|sci_init
id|module_init
c_func
(paren
id|sci_init
)paren
suffix:semicolon
macro_line|#ifdef MODULE
DECL|macro|func_enter
macro_line|#undef func_enter
DECL|macro|func_exit
macro_line|#undef func_exit
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
id|tty_unregister_driver
c_func
(paren
id|sci_driver
)paren
suffix:semicolon
id|put_tty_driver
c_func
(paren
id|sci_driver
)paren
suffix:semicolon
)brace
macro_line|#include &quot;generic_serial.c&quot;
macro_line|#endif
macro_line|#ifdef CONFIG_SERIAL_CONSOLE
multiline_comment|/*&n; *&t;Print a string to the serial port trying not to disturb&n; *&t;any possible real use of the port...&n; */
DECL|function|serial_console_write
r_static
r_void
id|serial_console_write
c_func
(paren
r_struct
id|console
op_star
id|co
comma
r_const
r_char
op_star
id|s
comma
r_int
id|count
)paren
(brace
id|put_string
c_func
(paren
id|sercons_port
comma
id|s
comma
id|count
)paren
suffix:semicolon
)brace
DECL|function|serial_console_device
r_static
r_struct
id|tty_driver
op_star
id|serial_console_device
c_func
(paren
r_struct
id|console
op_star
id|c
comma
r_int
op_star
id|index
)paren
(brace
op_star
id|index
op_assign
id|c-&gt;index
suffix:semicolon
r_return
id|sci_driver
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Setup initial baud/bits/parity. We do two things here:&n; *&t;- construct a cflag setting for the first rs_open()&n; *&t;- initialize the serial port&n; *&t;Return non-zero if we didn&squot;t find a serial port.&n; */
DECL|function|serial_console_setup
r_static
r_int
id|__init
id|serial_console_setup
c_func
(paren
r_struct
id|console
op_star
id|co
comma
r_char
op_star
id|options
)paren
(brace
r_int
id|baud
op_assign
l_int|9600
suffix:semicolon
r_int
id|bits
op_assign
l_int|8
suffix:semicolon
r_int
id|parity
op_assign
l_char|&squot;n&squot;
suffix:semicolon
r_int
id|cflag
op_assign
id|CREAD
op_or
id|HUPCL
op_or
id|CLOCAL
suffix:semicolon
r_char
op_star
id|s
suffix:semicolon
id|sercons_port
op_assign
op_amp
id|sci_ports
(braket
id|co-&gt;index
)braket
suffix:semicolon
r_if
c_cond
(paren
id|options
)paren
(brace
id|baud
op_assign
id|simple_strtoul
c_func
(paren
id|options
comma
l_int|NULL
comma
l_int|10
)paren
suffix:semicolon
id|s
op_assign
id|options
suffix:semicolon
r_while
c_loop
(paren
op_star
id|s
op_ge
l_char|&squot;0&squot;
op_logical_and
op_star
id|s
op_le
l_char|&squot;9&squot;
)paren
(brace
id|s
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
op_star
id|s
)paren
id|parity
op_assign
op_star
id|s
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_star
id|s
)paren
id|bits
op_assign
op_star
id|s
op_minus
l_char|&squot;0&squot;
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *&t;Now construct a cflag setting.&n;&t; */
r_switch
c_cond
(paren
id|baud
)paren
(brace
r_case
l_int|19200
suffix:colon
id|cflag
op_or_assign
id|B19200
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|38400
suffix:colon
id|cflag
op_or_assign
id|B38400
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|57600
suffix:colon
id|cflag
op_or_assign
id|B57600
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|115200
suffix:colon
id|cflag
op_or_assign
id|B115200
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|9600
suffix:colon
r_default
suffix:colon
id|cflag
op_or_assign
id|B9600
suffix:semicolon
id|baud
op_assign
l_int|9600
suffix:semicolon
r_break
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|bits
)paren
(brace
r_case
l_int|7
suffix:colon
id|cflag
op_or_assign
id|CS7
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_case
l_int|8
suffix:colon
id|cflag
op_or_assign
id|CS8
suffix:semicolon
r_break
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|parity
)paren
(brace
r_case
l_char|&squot;o&squot;
suffix:colon
r_case
l_char|&squot;O&squot;
suffix:colon
id|cflag
op_or_assign
id|PARODD
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;e&squot;
suffix:colon
r_case
l_char|&squot;E&squot;
suffix:colon
id|cflag
op_or_assign
id|PARENB
suffix:semicolon
r_break
suffix:semicolon
)brace
id|co-&gt;cflag
op_assign
id|cflag
suffix:semicolon
id|sercons_baud
op_assign
id|baud
suffix:semicolon
macro_line|#if defined(__H8300S__)
id|h8300_sci_enable
c_func
(paren
id|sercons_port
comma
id|sci_enable
)paren
suffix:semicolon
macro_line|#endif
id|sci_set_termios_cflag
c_func
(paren
id|sercons_port
comma
id|cflag
comma
id|baud
)paren
suffix:semicolon
id|sercons_port-&gt;old_cflag
op_assign
id|cflag
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|sercons
r_static
r_struct
id|console
id|sercons
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;ttySC&quot;
comma
dot
id|write
op_assign
id|serial_console_write
comma
dot
id|device
op_assign
id|serial_console_device
comma
dot
id|setup
op_assign
id|serial_console_setup
comma
dot
id|flags
op_assign
id|CON_PRINTBUFFER
comma
dot
id|index
op_assign
op_minus
l_int|1
comma
)brace
suffix:semicolon
multiline_comment|/*&n; *&t;Register console.&n; */
macro_line|#ifdef CONFIG_SH_EARLY_PRINTK
r_extern
r_void
id|sh_console_unregister
(paren
r_void
)paren
suffix:semicolon
macro_line|#endif
DECL|function|sci_console_init
r_static
r_int
id|__init
id|sci_console_init
c_func
(paren
r_void
)paren
(brace
id|register_console
c_func
(paren
op_amp
id|sercons
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_SH_EARLY_PRINTK
multiline_comment|/* Now that the real console is available, unregister the one we&n;&t; * used while first booting.&n;&t; */
id|sh_console_unregister
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|sci_console_init
id|console_initcall
c_func
(paren
id|sci_console_init
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_SERIAL_CONSOLE */
macro_line|#ifdef CONFIG_SH_KGDB
multiline_comment|/* Initialise the KGDB serial port */
DECL|function|kgdb_sci_setup
r_int
id|kgdb_sci_setup
c_func
(paren
r_void
)paren
(brace
r_int
id|cflag
op_assign
id|CREAD
op_or
id|HUPCL
op_or
id|CLOCAL
suffix:semicolon
r_if
c_cond
(paren
(paren
id|kgdb_portnum
OL
l_int|0
)paren
op_logical_or
(paren
id|kgdb_portnum
op_ge
id|SCI_NPORTS
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|kgdb_sci_port
op_assign
op_amp
id|sci_ports
(braket
id|kgdb_portnum
)braket
suffix:semicolon
r_switch
c_cond
(paren
id|kgdb_baud
)paren
(brace
r_case
l_int|115200
suffix:colon
id|cflag
op_or_assign
id|B115200
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|57600
suffix:colon
id|cflag
op_or_assign
id|B57600
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|38400
suffix:colon
id|cflag
op_or_assign
id|B38400
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|19200
suffix:colon
id|cflag
op_or_assign
id|B19200
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|9600
suffix:colon
r_default
suffix:colon
id|cflag
op_or_assign
id|B9600
suffix:semicolon
id|kgdb_baud
op_assign
l_int|9600
suffix:semicolon
r_break
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|kgdb_bits
)paren
(brace
r_case
l_char|&squot;7&squot;
suffix:colon
id|cflag
op_or_assign
id|CS7
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_case
l_char|&squot;8&squot;
suffix:colon
id|cflag
op_or_assign
id|CS8
suffix:semicolon
r_break
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|kgdb_parity
)paren
(brace
r_case
l_char|&squot;O&squot;
suffix:colon
id|cflag
op_or_assign
id|PARODD
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;E&squot;
suffix:colon
id|cflag
op_or_assign
id|PARENB
suffix:semicolon
r_break
suffix:semicolon
)brace
id|kgdb_cflag
op_assign
id|cflag
suffix:semicolon
id|sci_set_termios_cflag
c_func
(paren
id|kgdb_sci_port
comma
id|kgdb_cflag
comma
id|kgdb_baud
)paren
suffix:semicolon
multiline_comment|/* Set up the interrupt for BREAK from GDB */
multiline_comment|/* Commented out for now since it may not be possible yet...&n;&t;   request_irq(kgdb_sci_port-&gt;irqs[0], kgdb_break_interrupt,&n;&t;               SA_INTERRUPT, &quot;sci&quot;, kgdb_sci_port);&n;&t;   sci_enable_rx_interrupts(kgdb_sci_port);&n;&t;*/
multiline_comment|/* Setup complete: initialize function pointers */
id|kgdb_getchar
op_assign
id|kgdb_sci_getchar
suffix:semicolon
id|kgdb_putchar
op_assign
id|kgdb_sci_putchar
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_SH_KGDB_CONSOLE
multiline_comment|/* Create a console device */
DECL|function|kgdb_console_device
r_static
id|kdev_t
id|kgdb_console_device
c_func
(paren
r_struct
id|console
op_star
id|c
)paren
(brace
r_return
id|MKDEV
c_func
(paren
id|SCI_MAJOR
comma
id|SCI_MINOR_START
op_plus
id|c-&gt;index
)paren
suffix:semicolon
)brace
multiline_comment|/* Set up the KGDB console */
DECL|function|kgdb_console_setup
r_static
r_int
id|__init
id|kgdb_console_setup
c_func
(paren
r_struct
id|console
op_star
id|co
comma
r_char
op_star
id|options
)paren
(brace
multiline_comment|/* NB we ignore &squot;options&squot; because we&squot;ve already done the setup */
id|co-&gt;cflag
op_assign
id|kgdb_cflag
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Register the KGDB console so we get messages (d&squot;oh!) */
DECL|function|kgdb_console_init
r_void
id|__init
id|kgdb_console_init
c_func
(paren
r_void
)paren
(brace
id|register_console
c_func
(paren
op_amp
id|kgdbcons
)paren
suffix:semicolon
)brace
multiline_comment|/* The console structure for KGDB */
DECL|variable|kgdbcons
r_static
r_struct
id|console
id|kgdbcons
op_assign
(brace
id|name
suffix:colon
l_string|&quot;ttySC&quot;
comma
id|write
suffix:colon
id|kgdb_console_write
comma
id|device
suffix:colon
id|kgdb_console_device
comma
id|wait_key
suffix:colon
id|serial_console_wait_key
comma
id|setup
suffix:colon
id|kgdb_console_setup
comma
id|flags
suffix:colon
id|CON_PRINTBUFFER
op_or
id|CON_ENABLED
comma
id|index
suffix:colon
op_minus
l_int|1
comma
)brace
suffix:semicolon
macro_line|#endif /* CONFIG_SH_KGDB_CONSOLE */
macro_line|#endif /* CONFIG_SH_KGDB */
eof
