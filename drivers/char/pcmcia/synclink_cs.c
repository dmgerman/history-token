multiline_comment|/*&n; * linux/drivers/char/pcmcia/synclink_cs.c&n; *&n; * $Id: synclink_cs.c,v 4.26 2004/08/11 19:30:02 paulkf Exp $&n; *&n; * Device driver for Microgate SyncLink PC Card&n; * multiprotocol serial adapter.&n; *&n; * written by Paul Fulghum for Microgate Corporation&n; * paulkf@microgate.com&n; *&n; * Microgate and SyncLink are trademarks of Microgate Corporation&n; *&n; * This code is released under the GNU General Public License (GPL)&n; *&n; * THIS SOFTWARE IS PROVIDED ``AS IS&squot;&squot; AND ANY EXPRESS OR IMPLIED&n; * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES&n; * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE&n; * DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT,&n; * INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES&n; * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR&n; * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)&n; * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,&n; * STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)&n; * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED&n; * OF THE POSSIBILITY OF SUCH DAMAGE.&n; */
DECL|macro|VERSION
mdefine_line|#define VERSION(ver,rel,seq) (((ver)&lt;&lt;16) | ((rel)&lt;&lt;8) | (seq))
macro_line|#if defined(__i386__)
DECL|macro|BREAKPOINT
macro_line|#  define BREAKPOINT() asm(&quot;   int $3&quot;);
macro_line|#else
DECL|macro|BREAKPOINT
macro_line|#  define BREAKPOINT() { }
macro_line|#endif
DECL|macro|MAX_DEVICE_COUNT
mdefine_line|#define MAX_DEVICE_COUNT 4
macro_line|#include &lt;linux/config.h&gt;&t;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/signal.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/time.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/tty_flip.h&gt;
macro_line|#include &lt;linux/serial.h&gt;
macro_line|#include &lt;linux/major.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/vmalloc.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/serial.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/ioctl.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;linux/bitops.h&gt;
macro_line|#include &lt;asm/types.h&gt;
macro_line|#include &lt;linux/termios.h&gt;
macro_line|#include &lt;linux/workqueue.h&gt;
macro_line|#include &lt;linux/hdlc.h&gt;
macro_line|#include &lt;pcmcia/version.h&gt;
macro_line|#include &lt;pcmcia/cs_types.h&gt;
macro_line|#include &lt;pcmcia/cs.h&gt;
macro_line|#include &lt;pcmcia/cistpl.h&gt;
macro_line|#include &lt;pcmcia/cisreg.h&gt;
macro_line|#include &lt;pcmcia/ds.h&gt;
macro_line|#ifdef CONFIG_HDLC_MODULE
DECL|macro|CONFIG_HDLC
mdefine_line|#define CONFIG_HDLC 1
macro_line|#endif
DECL|macro|GET_USER
mdefine_line|#define GET_USER(error,value,addr) error = get_user(value,addr)
DECL|macro|COPY_FROM_USER
mdefine_line|#define COPY_FROM_USER(error,dest,src,size) error = copy_from_user(dest,src,size) ? -EFAULT : 0
DECL|macro|PUT_USER
mdefine_line|#define PUT_USER(error,value,addr) error = put_user(value,addr)
DECL|macro|COPY_TO_USER
mdefine_line|#define COPY_TO_USER(error,dest,src,size) error = copy_to_user(dest,src,size) ? -EFAULT : 0
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &quot;linux/synclink.h&quot;
DECL|variable|default_params
r_static
id|MGSL_PARAMS
id|default_params
op_assign
(brace
id|MGSL_MODE_HDLC
comma
multiline_comment|/* unsigned long mode */
l_int|0
comma
multiline_comment|/* unsigned char loopback; */
id|HDLC_FLAG_UNDERRUN_ABORT15
comma
multiline_comment|/* unsigned short flags; */
id|HDLC_ENCODING_NRZI_SPACE
comma
multiline_comment|/* unsigned char encoding; */
l_int|0
comma
multiline_comment|/* unsigned long clock_speed; */
l_int|0xff
comma
multiline_comment|/* unsigned char addr_filter; */
id|HDLC_CRC_16_CCITT
comma
multiline_comment|/* unsigned short crc_type; */
id|HDLC_PREAMBLE_LENGTH_8BITS
comma
multiline_comment|/* unsigned char preamble_length; */
id|HDLC_PREAMBLE_PATTERN_NONE
comma
multiline_comment|/* unsigned char preamble; */
l_int|9600
comma
multiline_comment|/* unsigned long data_rate; */
l_int|8
comma
multiline_comment|/* unsigned char data_bits; */
l_int|1
comma
multiline_comment|/* unsigned char stop_bits; */
id|ASYNC_PARITY_NONE
multiline_comment|/* unsigned char parity; */
)brace
suffix:semicolon
r_typedef
r_struct
(brace
DECL|member|count
r_int
id|count
suffix:semicolon
DECL|member|status
r_int
r_char
id|status
suffix:semicolon
DECL|member|data
r_char
id|data
(braket
l_int|1
)braket
suffix:semicolon
DECL|typedef|RXBUF
)brace
id|RXBUF
suffix:semicolon
multiline_comment|/* The queue of BH actions to be performed */
DECL|macro|BH_RECEIVE
mdefine_line|#define BH_RECEIVE  1
DECL|macro|BH_TRANSMIT
mdefine_line|#define BH_TRANSMIT 2
DECL|macro|BH_STATUS
mdefine_line|#define BH_STATUS   4
DECL|macro|IO_PIN_SHUTDOWN_LIMIT
mdefine_line|#define IO_PIN_SHUTDOWN_LIMIT 100
DECL|macro|RELEVANT_IFLAG
mdefine_line|#define RELEVANT_IFLAG(iflag) (iflag &amp; (IGNBRK|BRKINT|IGNPAR|PARMRK|INPCK))
DECL|struct|_input_signal_events
r_struct
id|_input_signal_events
(brace
DECL|member|ri_up
r_int
id|ri_up
suffix:semicolon
DECL|member|ri_down
r_int
id|ri_down
suffix:semicolon
DECL|member|dsr_up
r_int
id|dsr_up
suffix:semicolon
DECL|member|dsr_down
r_int
id|dsr_down
suffix:semicolon
DECL|member|dcd_up
r_int
id|dcd_up
suffix:semicolon
DECL|member|dcd_down
r_int
id|dcd_down
suffix:semicolon
DECL|member|cts_up
r_int
id|cts_up
suffix:semicolon
DECL|member|cts_down
r_int
id|cts_down
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/*&n; * Device instance data structure&n; */
DECL|struct|_mgslpc_info
r_typedef
r_struct
id|_mgslpc_info
(brace
DECL|member|if_ptr
r_void
op_star
id|if_ptr
suffix:semicolon
multiline_comment|/* General purpose pointer (used by SPPP) */
DECL|member|magic
r_int
id|magic
suffix:semicolon
DECL|member|flags
r_int
id|flags
suffix:semicolon
DECL|member|count
r_int
id|count
suffix:semicolon
multiline_comment|/* count of opens */
DECL|member|line
r_int
id|line
suffix:semicolon
DECL|member|close_delay
r_int
r_int
id|close_delay
suffix:semicolon
DECL|member|closing_wait
r_int
r_int
id|closing_wait
suffix:semicolon
multiline_comment|/* time to wait before closing */
DECL|member|icount
r_struct
id|mgsl_icount
id|icount
suffix:semicolon
DECL|member|tty
r_struct
id|tty_struct
op_star
id|tty
suffix:semicolon
DECL|member|timeout
r_int
id|timeout
suffix:semicolon
DECL|member|x_char
r_int
id|x_char
suffix:semicolon
multiline_comment|/* xon/xoff character */
DECL|member|blocked_open
r_int
id|blocked_open
suffix:semicolon
multiline_comment|/* # of blocked opens */
DECL|member|read_status_mask
r_int
r_char
id|read_status_mask
suffix:semicolon
DECL|member|ignore_status_mask
r_int
r_char
id|ignore_status_mask
suffix:semicolon
DECL|member|tx_buf
r_int
r_char
op_star
id|tx_buf
suffix:semicolon
DECL|member|tx_put
r_int
id|tx_put
suffix:semicolon
DECL|member|tx_get
r_int
id|tx_get
suffix:semicolon
DECL|member|tx_count
r_int
id|tx_count
suffix:semicolon
multiline_comment|/* circular list of fixed length rx buffers */
DECL|member|rx_buf
r_int
r_char
op_star
id|rx_buf
suffix:semicolon
multiline_comment|/* memory allocated for all rx buffers */
DECL|member|rx_buf_total_size
r_int
id|rx_buf_total_size
suffix:semicolon
multiline_comment|/* size of memory allocated for rx buffers */
DECL|member|rx_put
r_int
id|rx_put
suffix:semicolon
multiline_comment|/* index of next empty rx buffer */
DECL|member|rx_get
r_int
id|rx_get
suffix:semicolon
multiline_comment|/* index of next full rx buffer */
DECL|member|rx_buf_size
r_int
id|rx_buf_size
suffix:semicolon
multiline_comment|/* size in bytes of single rx buffer */
DECL|member|rx_buf_count
r_int
id|rx_buf_count
suffix:semicolon
multiline_comment|/* total number of rx buffers */
DECL|member|rx_frame_count
r_int
id|rx_frame_count
suffix:semicolon
multiline_comment|/* number of full rx buffers */
DECL|member|open_wait
id|wait_queue_head_t
id|open_wait
suffix:semicolon
DECL|member|close_wait
id|wait_queue_head_t
id|close_wait
suffix:semicolon
DECL|member|status_event_wait_q
id|wait_queue_head_t
id|status_event_wait_q
suffix:semicolon
DECL|member|event_wait_q
id|wait_queue_head_t
id|event_wait_q
suffix:semicolon
DECL|member|tx_timer
r_struct
id|timer_list
id|tx_timer
suffix:semicolon
multiline_comment|/* HDLC transmit timeout timer */
DECL|member|next_device
r_struct
id|_mgslpc_info
op_star
id|next_device
suffix:semicolon
multiline_comment|/* device list link */
DECL|member|imra_value
r_int
r_int
id|imra_value
suffix:semicolon
DECL|member|imrb_value
r_int
r_int
id|imrb_value
suffix:semicolon
DECL|member|pim_value
r_int
r_char
id|pim_value
suffix:semicolon
DECL|member|lock
id|spinlock_t
id|lock
suffix:semicolon
DECL|member|task
r_struct
id|work_struct
id|task
suffix:semicolon
multiline_comment|/* task structure for scheduling bh */
DECL|member|max_frame_size
id|u32
id|max_frame_size
suffix:semicolon
DECL|member|pending_bh
id|u32
id|pending_bh
suffix:semicolon
DECL|member|bh_running
r_int
id|bh_running
suffix:semicolon
DECL|member|bh_requested
r_int
id|bh_requested
suffix:semicolon
DECL|member|dcd_chkcount
r_int
id|dcd_chkcount
suffix:semicolon
multiline_comment|/* check counts to prevent */
DECL|member|cts_chkcount
r_int
id|cts_chkcount
suffix:semicolon
multiline_comment|/* too many IRQs if a signal */
DECL|member|dsr_chkcount
r_int
id|dsr_chkcount
suffix:semicolon
multiline_comment|/* is floating */
DECL|member|ri_chkcount
r_int
id|ri_chkcount
suffix:semicolon
DECL|member|rx_enabled
r_int
id|rx_enabled
suffix:semicolon
DECL|member|rx_overflow
r_int
id|rx_overflow
suffix:semicolon
DECL|member|tx_enabled
r_int
id|tx_enabled
suffix:semicolon
DECL|member|tx_active
r_int
id|tx_active
suffix:semicolon
DECL|member|tx_aborting
r_int
id|tx_aborting
suffix:semicolon
DECL|member|idle_mode
id|u32
id|idle_mode
suffix:semicolon
DECL|member|if_mode
r_int
id|if_mode
suffix:semicolon
multiline_comment|/* serial interface selection (RS-232, v.35 etc) */
DECL|member|device_name
r_char
id|device_name
(braket
l_int|25
)braket
suffix:semicolon
multiline_comment|/* device instance name */
DECL|member|io_base
r_int
r_int
id|io_base
suffix:semicolon
multiline_comment|/* base I/O address of adapter */
DECL|member|irq_level
r_int
r_int
id|irq_level
suffix:semicolon
DECL|member|params
id|MGSL_PARAMS
id|params
suffix:semicolon
multiline_comment|/* communications parameters */
DECL|member|serial_signals
r_int
r_char
id|serial_signals
suffix:semicolon
multiline_comment|/* current serial signal states */
DECL|member|irq_occurred
r_char
id|irq_occurred
suffix:semicolon
multiline_comment|/* for diagnostics use */
DECL|member|testing_irq
r_char
id|testing_irq
suffix:semicolon
DECL|member|init_error
r_int
r_int
id|init_error
suffix:semicolon
multiline_comment|/* startup error (DIAGS)&t;*/
DECL|member|flag_buf
r_char
id|flag_buf
(braket
id|MAX_ASYNC_BUFFER_SIZE
)braket
suffix:semicolon
DECL|member|drop_rts_on_tx_done
id|BOOLEAN
id|drop_rts_on_tx_done
suffix:semicolon
DECL|member|input_signal_events
r_struct
id|_input_signal_events
id|input_signal_events
suffix:semicolon
multiline_comment|/* PCMCIA support */
DECL|member|link
id|dev_link_t
id|link
suffix:semicolon
DECL|member|node
id|dev_node_t
id|node
suffix:semicolon
DECL|member|stop
r_int
id|stop
suffix:semicolon
multiline_comment|/* SPPP/Cisco HDLC device parts */
DECL|member|netcount
r_int
id|netcount
suffix:semicolon
DECL|member|dosyncppp
r_int
id|dosyncppp
suffix:semicolon
DECL|member|netlock
id|spinlock_t
id|netlock
suffix:semicolon
macro_line|#ifdef CONFIG_HDLC
DECL|member|netdev
r_struct
id|net_device
op_star
id|netdev
suffix:semicolon
macro_line|#endif
DECL|typedef|MGSLPC_INFO
)brace
id|MGSLPC_INFO
suffix:semicolon
DECL|macro|MGSLPC_MAGIC
mdefine_line|#define MGSLPC_MAGIC 0x5402
multiline_comment|/*&n; * The size of the serial xmit buffer is 1 page, or 4096 bytes&n; */
DECL|macro|TXBUFSIZE
mdefine_line|#define TXBUFSIZE 4096
DECL|macro|CHA
mdefine_line|#define CHA     0x00   /* channel A offset */
DECL|macro|CHB
mdefine_line|#define CHB     0x40   /* channel B offset */
multiline_comment|/*&n; *  FIXME: PPC has PVR defined in asm/reg.h.  For now we just undef it.&n; */
DECL|macro|PVR
macro_line|#undef PVR
DECL|macro|RXFIFO
mdefine_line|#define RXFIFO  0
DECL|macro|TXFIFO
mdefine_line|#define TXFIFO  0
DECL|macro|STAR
mdefine_line|#define STAR    0x20
DECL|macro|CMDR
mdefine_line|#define CMDR    0x20
DECL|macro|RSTA
mdefine_line|#define RSTA    0x21
DECL|macro|PRE
mdefine_line|#define PRE     0x21
DECL|macro|MODE
mdefine_line|#define MODE    0x22
DECL|macro|TIMR
mdefine_line|#define TIMR    0x23
DECL|macro|XAD1
mdefine_line|#define XAD1    0x24
DECL|macro|XAD2
mdefine_line|#define XAD2    0x25
DECL|macro|RAH1
mdefine_line|#define RAH1    0x26
DECL|macro|RAH2
mdefine_line|#define RAH2    0x27
DECL|macro|DAFO
mdefine_line|#define DAFO    0x27
DECL|macro|RAL1
mdefine_line|#define RAL1    0x28
DECL|macro|RFC
mdefine_line|#define RFC     0x28
DECL|macro|RHCR
mdefine_line|#define RHCR    0x29
DECL|macro|RAL2
mdefine_line|#define RAL2    0x29
DECL|macro|RBCL
mdefine_line|#define RBCL    0x2a
DECL|macro|XBCL
mdefine_line|#define XBCL    0x2a
DECL|macro|RBCH
mdefine_line|#define RBCH    0x2b
DECL|macro|XBCH
mdefine_line|#define XBCH    0x2b
DECL|macro|CCR0
mdefine_line|#define CCR0    0x2c
DECL|macro|CCR1
mdefine_line|#define CCR1    0x2d
DECL|macro|CCR2
mdefine_line|#define CCR2    0x2e
DECL|macro|CCR3
mdefine_line|#define CCR3    0x2f
DECL|macro|VSTR
mdefine_line|#define VSTR    0x34
DECL|macro|BGR
mdefine_line|#define BGR     0x34
DECL|macro|RLCR
mdefine_line|#define RLCR    0x35
DECL|macro|AML
mdefine_line|#define AML     0x36
DECL|macro|AMH
mdefine_line|#define AMH     0x37
DECL|macro|GIS
mdefine_line|#define GIS     0x38
DECL|macro|IVA
mdefine_line|#define IVA     0x38
DECL|macro|IPC
mdefine_line|#define IPC     0x39
DECL|macro|ISR
mdefine_line|#define ISR     0x3a
DECL|macro|IMR
mdefine_line|#define IMR     0x3a
DECL|macro|PVR
mdefine_line|#define PVR     0x3c
DECL|macro|PIS
mdefine_line|#define PIS     0x3d
DECL|macro|PIM
mdefine_line|#define PIM     0x3d
DECL|macro|PCR
mdefine_line|#define PCR     0x3e
DECL|macro|CCR4
mdefine_line|#define CCR4    0x3f
singleline_comment|// IMR/ISR
DECL|macro|IRQ_BREAK_ON
mdefine_line|#define IRQ_BREAK_ON    BIT15   
singleline_comment|// rx break detected
DECL|macro|IRQ_DATAOVERRUN
mdefine_line|#define IRQ_DATAOVERRUN BIT14&t;
singleline_comment|// receive data overflow
DECL|macro|IRQ_ALLSENT
mdefine_line|#define IRQ_ALLSENT     BIT13&t;
singleline_comment|// all sent
DECL|macro|IRQ_UNDERRUN
mdefine_line|#define IRQ_UNDERRUN    BIT12&t;
singleline_comment|// transmit data underrun
DECL|macro|IRQ_TIMER
mdefine_line|#define IRQ_TIMER       BIT11&t;
singleline_comment|// timer interrupt
DECL|macro|IRQ_CTS
mdefine_line|#define IRQ_CTS         BIT10&t;
singleline_comment|// CTS status change
DECL|macro|IRQ_TXREPEAT
mdefine_line|#define IRQ_TXREPEAT    BIT9&t;
singleline_comment|// tx message repeat
DECL|macro|IRQ_TXFIFO
mdefine_line|#define IRQ_TXFIFO      BIT8&t;
singleline_comment|// transmit pool ready
DECL|macro|IRQ_RXEOM
mdefine_line|#define IRQ_RXEOM       BIT7&t;
singleline_comment|// receive message end
DECL|macro|IRQ_EXITHUNT
mdefine_line|#define IRQ_EXITHUNT    BIT6&t;
singleline_comment|// receive frame start
DECL|macro|IRQ_RXTIME
mdefine_line|#define IRQ_RXTIME      BIT6    
singleline_comment|// rx char timeout
DECL|macro|IRQ_DCD
mdefine_line|#define IRQ_DCD         BIT2&t;
singleline_comment|// carrier detect status change
DECL|macro|IRQ_OVERRUN
mdefine_line|#define IRQ_OVERRUN     BIT1&t;
singleline_comment|// receive frame overflow
DECL|macro|IRQ_RXFIFO
mdefine_line|#define IRQ_RXFIFO      BIT0&t;
singleline_comment|// receive pool full
singleline_comment|// STAR
DECL|macro|XFW
mdefine_line|#define XFW   BIT6&t;&t;
singleline_comment|// transmit FIFO write enable
DECL|macro|CEC
mdefine_line|#define CEC   BIT2&t;&t;
singleline_comment|// command executing
DECL|macro|CTS
mdefine_line|#define CTS   BIT1&t;&t;
singleline_comment|// CTS state
DECL|macro|PVR_DTR
mdefine_line|#define PVR_DTR      BIT0
DECL|macro|PVR_DSR
mdefine_line|#define PVR_DSR      BIT1
DECL|macro|PVR_RI
mdefine_line|#define PVR_RI       BIT2
DECL|macro|PVR_AUTOCTS
mdefine_line|#define PVR_AUTOCTS  BIT3
DECL|macro|PVR_RS232
mdefine_line|#define PVR_RS232    0x20   /* 0010b */
DECL|macro|PVR_V35
mdefine_line|#define PVR_V35      0xe0   /* 1110b */
DECL|macro|PVR_RS422
mdefine_line|#define PVR_RS422    0x40   /* 0100b */
multiline_comment|/* Register access functions */
DECL|macro|write_reg
mdefine_line|#define write_reg(info, reg, val) outb((val),(info)-&gt;io_base + (reg))
DECL|macro|read_reg
mdefine_line|#define read_reg(info, reg) inb((info)-&gt;io_base + (reg))
DECL|macro|read_reg16
mdefine_line|#define read_reg16(info, reg) inw((info)-&gt;io_base + (reg))  
DECL|macro|write_reg16
mdefine_line|#define write_reg16(info, reg, val) outw((val), (info)-&gt;io_base + (reg))
DECL|macro|set_reg_bits
mdefine_line|#define set_reg_bits(info, reg, mask) &bslash;&n;    write_reg(info, (reg), &bslash;&n;&t;&t; (unsigned char) (read_reg(info, (reg)) | (mask)))  
DECL|macro|clear_reg_bits
mdefine_line|#define clear_reg_bits(info, reg, mask) &bslash;&n;    write_reg(info, (reg), &bslash;&n;&t;&t; (unsigned char) (read_reg(info, (reg)) &amp; ~(mask)))  
multiline_comment|/*&n; * interrupt enable/disable routines&n; */
DECL|function|irq_disable
r_static
r_void
id|irq_disable
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
comma
r_int
r_char
id|channel
comma
r_int
r_int
id|mask
)paren
(brace
r_if
c_cond
(paren
id|channel
op_eq
id|CHA
)paren
(brace
id|info-&gt;imra_value
op_or_assign
id|mask
suffix:semicolon
id|write_reg16
c_func
(paren
id|info
comma
id|CHA
op_plus
id|IMR
comma
id|info-&gt;imra_value
)paren
suffix:semicolon
)brace
r_else
(brace
id|info-&gt;imrb_value
op_or_assign
id|mask
suffix:semicolon
id|write_reg16
c_func
(paren
id|info
comma
id|CHB
op_plus
id|IMR
comma
id|info-&gt;imrb_value
)paren
suffix:semicolon
)brace
)brace
DECL|function|irq_enable
r_static
r_void
id|irq_enable
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
comma
r_int
r_char
id|channel
comma
r_int
r_int
id|mask
)paren
(brace
r_if
c_cond
(paren
id|channel
op_eq
id|CHA
)paren
(brace
id|info-&gt;imra_value
op_and_assign
op_complement
id|mask
suffix:semicolon
id|write_reg16
c_func
(paren
id|info
comma
id|CHA
op_plus
id|IMR
comma
id|info-&gt;imra_value
)paren
suffix:semicolon
)brace
r_else
(brace
id|info-&gt;imrb_value
op_and_assign
op_complement
id|mask
suffix:semicolon
id|write_reg16
c_func
(paren
id|info
comma
id|CHB
op_plus
id|IMR
comma
id|info-&gt;imrb_value
)paren
suffix:semicolon
)brace
)brace
DECL|macro|port_irq_disable
mdefine_line|#define port_irq_disable(info, mask) &bslash;&n;  { info-&gt;pim_value |= (mask); write_reg(info, PIM, info-&gt;pim_value); }
DECL|macro|port_irq_enable
mdefine_line|#define port_irq_enable(info, mask) &bslash;&n;  { info-&gt;pim_value &amp;= ~(mask); write_reg(info, PIM, info-&gt;pim_value); }
r_static
r_void
id|rx_start
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
)paren
suffix:semicolon
r_static
r_void
id|rx_stop
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
)paren
suffix:semicolon
r_static
r_void
id|tx_start
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
)paren
suffix:semicolon
r_static
r_void
id|tx_stop
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
)paren
suffix:semicolon
r_static
r_void
id|tx_set_idle
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
)paren
suffix:semicolon
r_static
r_void
id|get_signals
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
)paren
suffix:semicolon
r_static
r_void
id|set_signals
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
)paren
suffix:semicolon
r_static
r_void
id|reset_device
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
)paren
suffix:semicolon
r_static
r_void
id|hdlc_mode
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
)paren
suffix:semicolon
r_static
r_void
id|async_mode
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
)paren
suffix:semicolon
r_static
r_void
id|tx_timeout
c_func
(paren
r_int
r_int
id|context
)paren
suffix:semicolon
r_static
r_int
id|ioctl_common
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_HDLC
DECL|macro|dev_to_port
mdefine_line|#define dev_to_port(D) (dev_to_hdlc(D)-&gt;priv)
r_static
r_void
id|hdlcdev_tx_done
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
)paren
suffix:semicolon
r_static
r_void
id|hdlcdev_rx
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
comma
r_char
op_star
id|buf
comma
r_int
id|size
)paren
suffix:semicolon
r_static
r_int
id|hdlcdev_init
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
)paren
suffix:semicolon
r_static
r_void
id|hdlcdev_exit
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
)paren
suffix:semicolon
macro_line|#endif
r_static
r_void
id|trace_block
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
comma
r_const
r_char
op_star
id|data
comma
r_int
id|count
comma
r_int
id|xmit
)paren
suffix:semicolon
r_static
id|BOOLEAN
id|register_test
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
)paren
suffix:semicolon
r_static
id|BOOLEAN
id|irq_test
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|adapter_test
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|claim_resources
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
)paren
suffix:semicolon
r_static
r_void
id|release_resources
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
)paren
suffix:semicolon
r_static
r_void
id|mgslpc_add_device
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
)paren
suffix:semicolon
r_static
r_void
id|mgslpc_remove_device
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|rx_get_frame
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
)paren
suffix:semicolon
r_static
r_void
id|rx_reset_buffers
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|rx_alloc_buffers
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
)paren
suffix:semicolon
r_static
r_void
id|rx_free_buffers
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
)paren
suffix:semicolon
r_static
id|irqreturn_t
id|mgslpc_isr
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
multiline_comment|/*&n; * Bottom half interrupt handlers&n; */
r_static
r_void
id|bh_handler
c_func
(paren
r_void
op_star
id|Context
)paren
suffix:semicolon
r_static
r_void
id|bh_transmit
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
)paren
suffix:semicolon
r_static
r_void
id|bh_status
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
)paren
suffix:semicolon
multiline_comment|/*&n; * ioctl handlers&n; */
r_static
r_int
id|tiocmget
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|file
)paren
suffix:semicolon
r_static
r_int
id|tiocmset
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|set
comma
r_int
r_int
id|clear
)paren
suffix:semicolon
r_static
r_int
id|get_stats
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
comma
r_struct
id|mgsl_icount
id|__user
op_star
id|user_icount
)paren
suffix:semicolon
r_static
r_int
id|get_params
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
comma
id|MGSL_PARAMS
id|__user
op_star
id|user_params
)paren
suffix:semicolon
r_static
r_int
id|set_params
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
comma
id|MGSL_PARAMS
id|__user
op_star
id|new_params
)paren
suffix:semicolon
r_static
r_int
id|get_txidle
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
comma
r_int
id|__user
op_star
id|idle_mode
)paren
suffix:semicolon
r_static
r_int
id|set_txidle
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
comma
r_int
id|idle_mode
)paren
suffix:semicolon
r_static
r_int
id|set_txenable
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
comma
r_int
id|enable
)paren
suffix:semicolon
r_static
r_int
id|tx_abort
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|set_rxenable
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
comma
r_int
id|enable
)paren
suffix:semicolon
r_static
r_int
id|wait_events
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
comma
r_int
id|__user
op_star
id|mask
)paren
suffix:semicolon
DECL|variable|mgslpc_device_list
r_static
id|MGSLPC_INFO
op_star
id|mgslpc_device_list
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|mgslpc_device_count
r_static
r_int
id|mgslpc_device_count
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n; * Set this param to non-zero to load eax with the&n; * .text section address and breakpoint on module load.&n; * This is useful for use with gdb and add-symbol-file command.&n; */
DECL|variable|break_on_load
r_static
r_int
id|break_on_load
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n; * Driver major number, defaults to zero to get auto&n; * assigned major number. May be forced as module parameter.&n; */
DECL|variable|ttymajor
r_static
r_int
id|ttymajor
op_assign
l_int|0
suffix:semicolon
DECL|variable|debug_level
r_static
r_int
id|debug_level
op_assign
l_int|0
suffix:semicolon
DECL|variable|maxframe
r_static
r_int
id|maxframe
(braket
id|MAX_DEVICE_COUNT
)braket
op_assign
(brace
l_int|0
comma
)brace
suffix:semicolon
DECL|variable|dosyncppp
r_static
r_int
id|dosyncppp
(braket
id|MAX_DEVICE_COUNT
)braket
op_assign
(brace
l_int|1
comma
l_int|1
comma
l_int|1
comma
l_int|1
)brace
suffix:semicolon
multiline_comment|/* The old way: bit map of interrupts to choose from */
multiline_comment|/* This means pick from 15, 14, 12, 11, 10, 9, 7, 5, 4, and 3 */
DECL|variable|irq_mask
r_static
id|u_int
id|irq_mask
op_assign
l_int|0xdeb8
suffix:semicolon
multiline_comment|/* Newer, simpler way of listing specific interrupts */
DECL|variable|irq_list
r_static
r_int
id|irq_list
(braket
l_int|4
)braket
op_assign
(brace
op_minus
l_int|1
)brace
suffix:semicolon
id|module_param
c_func
(paren
id|irq_mask
comma
r_int
comma
l_int|0
)paren
suffix:semicolon
id|module_param_array
c_func
(paren
id|irq_list
comma
r_int
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
id|module_param
c_func
(paren
id|break_on_load
comma
r_bool
comma
l_int|0
)paren
suffix:semicolon
id|module_param
c_func
(paren
id|ttymajor
comma
r_int
comma
l_int|0
)paren
suffix:semicolon
id|module_param
c_func
(paren
id|debug_level
comma
r_int
comma
l_int|0
)paren
suffix:semicolon
id|module_param_array
c_func
(paren
id|maxframe
comma
r_int
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
id|module_param_array
c_func
(paren
id|dosyncppp
comma
r_int
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
DECL|variable|driver_name
r_static
r_char
op_star
id|driver_name
op_assign
l_string|&quot;SyncLink PC Card driver&quot;
suffix:semicolon
DECL|variable|driver_version
r_static
r_char
op_star
id|driver_version
op_assign
l_string|&quot;$Revision: 4.26 $&quot;
suffix:semicolon
DECL|variable|serial_driver
r_static
r_struct
id|tty_driver
op_star
id|serial_driver
suffix:semicolon
multiline_comment|/* number of characters left in xmit buffer before we ask for more */
DECL|macro|WAKEUP_CHARS
mdefine_line|#define WAKEUP_CHARS 256
r_static
r_void
id|mgslpc_change_params
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
)paren
suffix:semicolon
r_static
r_void
id|mgslpc_wait_until_sent
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_int
id|timeout
)paren
suffix:semicolon
multiline_comment|/* PCMCIA prototypes */
r_static
r_void
id|mgslpc_config
c_func
(paren
id|dev_link_t
op_star
id|link
)paren
suffix:semicolon
r_static
r_void
id|mgslpc_release
c_func
(paren
id|u_long
id|arg
)paren
suffix:semicolon
r_static
r_int
id|mgslpc_event
c_func
(paren
id|event_t
id|event
comma
r_int
id|priority
comma
id|event_callback_args_t
op_star
id|args
)paren
suffix:semicolon
r_static
id|dev_link_t
op_star
id|mgslpc_attach
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|mgslpc_detach
c_func
(paren
id|dev_link_t
op_star
)paren
suffix:semicolon
DECL|variable|dev_info
r_static
id|dev_info_t
id|dev_info
op_assign
l_string|&quot;synclink_cs&quot;
suffix:semicolon
DECL|variable|dev_list
r_static
id|dev_link_t
op_star
id|dev_list
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/*&n; * 1st function defined in .text section. Calling this function in&n; * init_module() followed by a breakpoint allows a remote debugger&n; * (gdb) to get the .text address for the add-symbol-file command.&n; * This allows remote debugging of dynamically loadable modules.&n; */
DECL|function|mgslpc_get_text_ptr
r_static
r_void
op_star
id|mgslpc_get_text_ptr
c_func
(paren
r_void
)paren
(brace
r_return
id|mgslpc_get_text_ptr
suffix:semicolon
)brace
multiline_comment|/**&n; * line discipline callback wrappers&n; *&n; * The wrappers maintain line discipline references&n; * while calling into the line discipline.&n; *&n; * ldisc_flush_buffer - flush line discipline receive buffers&n; * ldisc_receive_buf  - pass receive data to line discipline&n; */
DECL|function|ldisc_flush_buffer
r_static
r_void
id|ldisc_flush_buffer
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_struct
id|tty_ldisc
op_star
id|ld
op_assign
id|tty_ldisc_ref
c_func
(paren
id|tty
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ld
)paren
(brace
r_if
c_cond
(paren
id|ld-&gt;flush_buffer
)paren
id|ld
op_member_access_from_pointer
id|flush_buffer
c_func
(paren
id|tty
)paren
suffix:semicolon
id|tty_ldisc_deref
c_func
(paren
id|ld
)paren
suffix:semicolon
)brace
)brace
DECL|function|ldisc_receive_buf
r_static
r_void
id|ldisc_receive_buf
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_const
id|__u8
op_star
id|data
comma
r_char
op_star
id|flags
comma
r_int
id|count
)paren
(brace
r_struct
id|tty_ldisc
op_star
id|ld
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tty
)paren
r_return
suffix:semicolon
id|ld
op_assign
id|tty_ldisc_ref
c_func
(paren
id|tty
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ld
)paren
(brace
r_if
c_cond
(paren
id|ld-&gt;receive_buf
)paren
id|ld
op_member_access_from_pointer
id|receive_buf
c_func
(paren
id|tty
comma
id|data
comma
id|flags
comma
id|count
)paren
suffix:semicolon
id|tty_ldisc_deref
c_func
(paren
id|ld
)paren
suffix:semicolon
)brace
)brace
DECL|function|mgslpc_attach
r_static
id|dev_link_t
op_star
id|mgslpc_attach
c_func
(paren
r_void
)paren
(brace
id|MGSLPC_INFO
op_star
id|info
suffix:semicolon
id|dev_link_t
op_star
id|link
suffix:semicolon
id|client_reg_t
id|client_reg
suffix:semicolon
r_int
id|ret
comma
id|i
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;mgslpc_attach&bslash;n&quot;
)paren
suffix:semicolon
id|info
op_assign
(paren
id|MGSLPC_INFO
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|MGSLPC_INFO
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Error can&squot;t allocate device instance data&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|memset
c_func
(paren
id|info
comma
l_int|0
comma
r_sizeof
(paren
id|MGSLPC_INFO
)paren
)paren
suffix:semicolon
id|info-&gt;magic
op_assign
id|MGSLPC_MAGIC
suffix:semicolon
id|INIT_WORK
c_func
(paren
op_amp
id|info-&gt;task
comma
id|bh_handler
comma
id|info
)paren
suffix:semicolon
id|info-&gt;max_frame_size
op_assign
l_int|4096
suffix:semicolon
id|info-&gt;close_delay
op_assign
l_int|5
op_star
id|HZ
op_div
l_int|10
suffix:semicolon
id|info-&gt;closing_wait
op_assign
l_int|30
op_star
id|HZ
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|info-&gt;open_wait
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|info-&gt;close_wait
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|info-&gt;status_event_wait_q
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|info-&gt;event_wait_q
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|info-&gt;lock
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|info-&gt;netlock
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|info-&gt;params
comma
op_amp
id|default_params
comma
r_sizeof
(paren
id|MGSL_PARAMS
)paren
)paren
suffix:semicolon
id|info-&gt;idle_mode
op_assign
id|HDLC_TXIDLE_FLAGS
suffix:semicolon
id|info-&gt;imra_value
op_assign
l_int|0xffff
suffix:semicolon
id|info-&gt;imrb_value
op_assign
l_int|0xffff
suffix:semicolon
id|info-&gt;pim_value
op_assign
l_int|0xff
suffix:semicolon
id|link
op_assign
op_amp
id|info-&gt;link
suffix:semicolon
id|link-&gt;priv
op_assign
id|info
suffix:semicolon
multiline_comment|/* Initialize the dev_link_t structure */
multiline_comment|/* Interrupt setup */
id|link-&gt;irq.Attributes
op_assign
id|IRQ_TYPE_EXCLUSIVE
suffix:semicolon
id|link-&gt;irq.IRQInfo1
op_assign
id|IRQ_INFO2_VALID
op_or
id|IRQ_LEVEL_ID
suffix:semicolon
r_if
c_cond
(paren
id|irq_list
(braket
l_int|0
)braket
op_eq
op_minus
l_int|1
)paren
id|link-&gt;irq.IRQInfo2
op_assign
id|irq_mask
suffix:semicolon
r_else
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
id|link-&gt;irq.IRQInfo2
op_or_assign
l_int|1
op_lshift
id|irq_list
(braket
id|i
)braket
suffix:semicolon
id|link-&gt;irq.Handler
op_assign
l_int|NULL
suffix:semicolon
id|link-&gt;conf.Attributes
op_assign
l_int|0
suffix:semicolon
id|link-&gt;conf.Vcc
op_assign
l_int|50
suffix:semicolon
id|link-&gt;conf.IntType
op_assign
id|INT_MEMORY_AND_IO
suffix:semicolon
multiline_comment|/* Register with Card Services */
id|link-&gt;next
op_assign
id|dev_list
suffix:semicolon
id|dev_list
op_assign
id|link
suffix:semicolon
id|client_reg.dev_info
op_assign
op_amp
id|dev_info
suffix:semicolon
id|client_reg.Attributes
op_assign
id|INFO_IO_CLIENT
op_or
id|INFO_CARD_SHARE
suffix:semicolon
id|client_reg.EventMask
op_assign
id|CS_EVENT_CARD_INSERTION
op_or
id|CS_EVENT_CARD_REMOVAL
op_or
id|CS_EVENT_RESET_PHYSICAL
op_or
id|CS_EVENT_CARD_RESET
op_or
id|CS_EVENT_PM_SUSPEND
op_or
id|CS_EVENT_PM_RESUME
suffix:semicolon
id|client_reg.event_handler
op_assign
op_amp
id|mgslpc_event
suffix:semicolon
id|client_reg.Version
op_assign
l_int|0x0210
suffix:semicolon
id|client_reg.event_callback_args.client_data
op_assign
id|link
suffix:semicolon
id|ret
op_assign
id|pcmcia_register_client
c_func
(paren
op_amp
id|link-&gt;handle
comma
op_amp
id|client_reg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ne
id|CS_SUCCESS
)paren
(brace
id|cs_error
c_func
(paren
id|link-&gt;handle
comma
id|RegisterClient
comma
id|ret
)paren
suffix:semicolon
id|mgslpc_detach
c_func
(paren
id|link
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|mgslpc_add_device
c_func
(paren
id|info
)paren
suffix:semicolon
r_return
id|link
suffix:semicolon
)brace
multiline_comment|/* Card has been inserted.&n; */
DECL|macro|CS_CHECK
mdefine_line|#define CS_CHECK(fn, ret) &bslash;&n;do { last_fn = (fn); if ((last_ret = (ret)) != 0) goto cs_failed; } while (0)
DECL|function|mgslpc_config
r_static
r_void
id|mgslpc_config
c_func
(paren
id|dev_link_t
op_star
id|link
)paren
(brace
id|client_handle_t
id|handle
op_assign
id|link-&gt;handle
suffix:semicolon
id|MGSLPC_INFO
op_star
id|info
op_assign
id|link-&gt;priv
suffix:semicolon
id|tuple_t
id|tuple
suffix:semicolon
id|cisparse_t
id|parse
suffix:semicolon
r_int
id|last_fn
comma
id|last_ret
suffix:semicolon
id|u_char
id|buf
(braket
l_int|64
)braket
suffix:semicolon
id|config_info_t
id|conf
suffix:semicolon
id|cistpl_cftable_entry_t
id|dflt
op_assign
(brace
l_int|0
)brace
suffix:semicolon
id|cistpl_cftable_entry_t
op_star
id|cfg
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;mgslpc_config(0x%p)&bslash;n&quot;
comma
id|link
)paren
suffix:semicolon
multiline_comment|/* read CONFIG tuple to find its configuration registers */
id|tuple.DesiredTuple
op_assign
id|CISTPL_CONFIG
suffix:semicolon
id|tuple.Attributes
op_assign
l_int|0
suffix:semicolon
id|tuple.TupleData
op_assign
id|buf
suffix:semicolon
id|tuple.TupleDataMax
op_assign
r_sizeof
(paren
id|buf
)paren
suffix:semicolon
id|tuple.TupleOffset
op_assign
l_int|0
suffix:semicolon
id|CS_CHECK
c_func
(paren
id|GetFirstTuple
comma
id|pcmcia_get_first_tuple
c_func
(paren
id|handle
comma
op_amp
id|tuple
)paren
)paren
suffix:semicolon
id|CS_CHECK
c_func
(paren
id|GetTupleData
comma
id|pcmcia_get_tuple_data
c_func
(paren
id|handle
comma
op_amp
id|tuple
)paren
)paren
suffix:semicolon
id|CS_CHECK
c_func
(paren
id|ParseTuple
comma
id|pcmcia_parse_tuple
c_func
(paren
id|handle
comma
op_amp
id|tuple
comma
op_amp
id|parse
)paren
)paren
suffix:semicolon
id|link-&gt;conf.ConfigBase
op_assign
id|parse.config.base
suffix:semicolon
id|link-&gt;conf.Present
op_assign
id|parse.config.rmask
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/* Configure card */
id|link-&gt;state
op_or_assign
id|DEV_CONFIG
suffix:semicolon
multiline_comment|/* Look up the current Vcc */
id|CS_CHECK
c_func
(paren
id|GetConfigurationInfo
comma
id|pcmcia_get_configuration_info
c_func
(paren
id|handle
comma
op_amp
id|conf
)paren
)paren
suffix:semicolon
id|link-&gt;conf.Vcc
op_assign
id|conf.Vcc
suffix:semicolon
multiline_comment|/* get CIS configuration entry */
id|tuple.DesiredTuple
op_assign
id|CISTPL_CFTABLE_ENTRY
suffix:semicolon
id|CS_CHECK
c_func
(paren
id|GetFirstTuple
comma
id|pcmcia_get_first_tuple
c_func
(paren
id|handle
comma
op_amp
id|tuple
)paren
)paren
suffix:semicolon
id|cfg
op_assign
op_amp
(paren
id|parse.cftable_entry
)paren
suffix:semicolon
id|CS_CHECK
c_func
(paren
id|GetTupleData
comma
id|pcmcia_get_tuple_data
c_func
(paren
id|handle
comma
op_amp
id|tuple
)paren
)paren
suffix:semicolon
id|CS_CHECK
c_func
(paren
id|ParseTuple
comma
id|pcmcia_parse_tuple
c_func
(paren
id|handle
comma
op_amp
id|tuple
comma
op_amp
id|parse
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cfg-&gt;flags
op_amp
id|CISTPL_CFTABLE_DEFAULT
)paren
id|dflt
op_assign
op_star
id|cfg
suffix:semicolon
r_if
c_cond
(paren
id|cfg-&gt;index
op_eq
l_int|0
)paren
r_goto
id|cs_failed
suffix:semicolon
id|link-&gt;conf.ConfigIndex
op_assign
id|cfg-&gt;index
suffix:semicolon
id|link-&gt;conf.Attributes
op_or_assign
id|CONF_ENABLE_IRQ
suffix:semicolon
multiline_comment|/* IO window settings */
id|link-&gt;io.NumPorts1
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|cfg-&gt;io.nwin
OG
l_int|0
)paren
op_logical_or
(paren
id|dflt.io.nwin
OG
l_int|0
)paren
)paren
(brace
id|cistpl_io_t
op_star
id|io
op_assign
(paren
id|cfg-&gt;io.nwin
)paren
ques
c_cond
op_amp
id|cfg-&gt;io
suffix:colon
op_amp
id|dflt.io
suffix:semicolon
id|link-&gt;io.Attributes1
op_assign
id|IO_DATA_PATH_WIDTH_AUTO
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|io-&gt;flags
op_amp
id|CISTPL_IO_8BIT
)paren
)paren
id|link-&gt;io.Attributes1
op_assign
id|IO_DATA_PATH_WIDTH_16
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|io-&gt;flags
op_amp
id|CISTPL_IO_16BIT
)paren
)paren
id|link-&gt;io.Attributes1
op_assign
id|IO_DATA_PATH_WIDTH_8
suffix:semicolon
id|link-&gt;io.IOAddrLines
op_assign
id|io-&gt;flags
op_amp
id|CISTPL_IO_LINES_MASK
suffix:semicolon
id|link-&gt;io.BasePort1
op_assign
id|io-&gt;win
(braket
l_int|0
)braket
dot
id|base
suffix:semicolon
id|link-&gt;io.NumPorts1
op_assign
id|io-&gt;win
(braket
l_int|0
)braket
dot
id|len
suffix:semicolon
id|CS_CHECK
c_func
(paren
id|RequestIO
comma
id|pcmcia_request_io
c_func
(paren
id|link-&gt;handle
comma
op_amp
id|link-&gt;io
)paren
)paren
suffix:semicolon
)brace
id|link-&gt;conf.Attributes
op_assign
id|CONF_ENABLE_IRQ
suffix:semicolon
id|link-&gt;conf.Vcc
op_assign
l_int|50
suffix:semicolon
id|link-&gt;conf.IntType
op_assign
id|INT_MEMORY_AND_IO
suffix:semicolon
id|link-&gt;conf.ConfigIndex
op_assign
l_int|8
suffix:semicolon
id|link-&gt;conf.Present
op_assign
id|PRESENT_OPTION
suffix:semicolon
id|link-&gt;irq.Attributes
op_or_assign
id|IRQ_HANDLE_PRESENT
suffix:semicolon
id|link-&gt;irq.Handler
op_assign
id|mgslpc_isr
suffix:semicolon
id|link-&gt;irq.Instance
op_assign
id|info
suffix:semicolon
id|CS_CHECK
c_func
(paren
id|RequestIRQ
comma
id|pcmcia_request_irq
c_func
(paren
id|link-&gt;handle
comma
op_amp
id|link-&gt;irq
)paren
)paren
suffix:semicolon
id|CS_CHECK
c_func
(paren
id|RequestConfiguration
comma
id|pcmcia_request_configuration
c_func
(paren
id|link-&gt;handle
comma
op_amp
id|link-&gt;conf
)paren
)paren
suffix:semicolon
id|info-&gt;io_base
op_assign
id|link-&gt;io.BasePort1
suffix:semicolon
id|info-&gt;irq_level
op_assign
id|link-&gt;irq.AssignedIRQ
suffix:semicolon
multiline_comment|/* add to linked list of devices */
id|sprintf
c_func
(paren
id|info-&gt;node.dev_name
comma
l_string|&quot;mgslpc0&quot;
)paren
suffix:semicolon
id|info-&gt;node.major
op_assign
id|info-&gt;node.minor
op_assign
l_int|0
suffix:semicolon
id|link-&gt;dev
op_assign
op_amp
id|info-&gt;node
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: index 0x%02x:&quot;
comma
id|info-&gt;node.dev_name
comma
id|link-&gt;conf.ConfigIndex
)paren
suffix:semicolon
r_if
c_cond
(paren
id|link-&gt;conf.Attributes
op_amp
id|CONF_ENABLE_IRQ
)paren
id|printk
c_func
(paren
l_string|&quot;, irq %d&quot;
comma
id|link-&gt;irq.AssignedIRQ
)paren
suffix:semicolon
r_if
c_cond
(paren
id|link-&gt;io.NumPorts1
)paren
id|printk
c_func
(paren
l_string|&quot;, io 0x%04x-0x%04x&quot;
comma
id|link-&gt;io.BasePort1
comma
id|link-&gt;io.BasePort1
op_plus
id|link-&gt;io.NumPorts1
op_minus
l_int|1
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|link-&gt;state
op_and_assign
op_complement
id|DEV_CONFIG_PENDING
suffix:semicolon
r_return
suffix:semicolon
id|cs_failed
suffix:colon
id|cs_error
c_func
(paren
id|link-&gt;handle
comma
id|last_fn
comma
id|last_ret
)paren
suffix:semicolon
id|mgslpc_release
c_func
(paren
(paren
id|u_long
)paren
id|link
)paren
suffix:semicolon
)brace
multiline_comment|/* Card has been removed.&n; * Unregister device and release PCMCIA configuration.&n; * If device is open, postpone until it is closed.&n; */
DECL|function|mgslpc_release
r_static
r_void
id|mgslpc_release
c_func
(paren
id|u_long
id|arg
)paren
(brace
id|dev_link_t
op_star
id|link
op_assign
(paren
id|dev_link_t
op_star
)paren
id|arg
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;mgslpc_release(0x%p)&bslash;n&quot;
comma
id|link
)paren
suffix:semicolon
multiline_comment|/* Unlink the device chain */
id|link-&gt;dev
op_assign
l_int|NULL
suffix:semicolon
id|link-&gt;state
op_and_assign
op_complement
id|DEV_CONFIG
suffix:semicolon
id|pcmcia_release_configuration
c_func
(paren
id|link-&gt;handle
)paren
suffix:semicolon
r_if
c_cond
(paren
id|link-&gt;io.NumPorts1
)paren
id|pcmcia_release_io
c_func
(paren
id|link-&gt;handle
comma
op_amp
id|link-&gt;io
)paren
suffix:semicolon
r_if
c_cond
(paren
id|link-&gt;irq.AssignedIRQ
)paren
id|pcmcia_release_irq
c_func
(paren
id|link-&gt;handle
comma
op_amp
id|link-&gt;irq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|link-&gt;state
op_amp
id|DEV_STALE_LINK
)paren
id|mgslpc_detach
c_func
(paren
id|link
)paren
suffix:semicolon
)brace
DECL|function|mgslpc_detach
r_static
r_void
id|mgslpc_detach
c_func
(paren
id|dev_link_t
op_star
id|link
)paren
(brace
id|dev_link_t
op_star
op_star
id|linkp
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;mgslpc_detach(0x%p)&bslash;n&quot;
comma
id|link
)paren
suffix:semicolon
multiline_comment|/* find device */
r_for
c_loop
(paren
id|linkp
op_assign
op_amp
id|dev_list
suffix:semicolon
op_star
id|linkp
suffix:semicolon
id|linkp
op_assign
op_amp
(paren
op_star
id|linkp
)paren
op_member_access_from_pointer
id|next
)paren
r_if
c_cond
(paren
op_star
id|linkp
op_eq
id|link
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
op_star
id|linkp
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|link-&gt;state
op_amp
id|DEV_CONFIG
)paren
(brace
multiline_comment|/* device is configured/active, mark it so when&n;&t;     * release() is called a proper detach() occurs.&n;&t;     */
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;synclinkpc: detach postponed, &squot;%s&squot; &quot;
l_string|&quot;still locked&bslash;n&quot;
comma
id|link-&gt;dev-&gt;dev_name
)paren
suffix:semicolon
id|link-&gt;state
op_or_assign
id|DEV_STALE_LINK
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Break the link with Card Services */
r_if
c_cond
(paren
id|link-&gt;handle
)paren
id|pcmcia_deregister_client
c_func
(paren
id|link-&gt;handle
)paren
suffix:semicolon
multiline_comment|/* Unlink device structure, and free it */
op_star
id|linkp
op_assign
id|link-&gt;next
suffix:semicolon
id|mgslpc_remove_device
c_func
(paren
(paren
id|MGSLPC_INFO
op_star
)paren
id|link-&gt;priv
)paren
suffix:semicolon
)brace
DECL|function|mgslpc_event
r_static
r_int
id|mgslpc_event
c_func
(paren
id|event_t
id|event
comma
r_int
id|priority
comma
id|event_callback_args_t
op_star
id|args
)paren
(brace
id|dev_link_t
op_star
id|link
op_assign
id|args-&gt;client_data
suffix:semicolon
id|MGSLPC_INFO
op_star
id|info
op_assign
id|link-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;mgslpc_event(0x%06x)&bslash;n&quot;
comma
id|event
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|event
)paren
(brace
r_case
id|CS_EVENT_CARD_REMOVAL
suffix:colon
id|link-&gt;state
op_and_assign
op_complement
id|DEV_PRESENT
suffix:semicolon
r_if
c_cond
(paren
id|link-&gt;state
op_amp
id|DEV_CONFIG
)paren
(brace
(paren
(paren
id|MGSLPC_INFO
op_star
)paren
id|link-&gt;priv
)paren
op_member_access_from_pointer
id|stop
op_assign
l_int|1
suffix:semicolon
id|mgslpc_release
c_func
(paren
(paren
id|u_long
)paren
id|link
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|CS_EVENT_CARD_INSERTION
suffix:colon
id|link-&gt;state
op_or_assign
id|DEV_PRESENT
op_or
id|DEV_CONFIG_PENDING
suffix:semicolon
id|mgslpc_config
c_func
(paren
id|link
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS_EVENT_PM_SUSPEND
suffix:colon
id|link-&gt;state
op_or_assign
id|DEV_SUSPEND
suffix:semicolon
multiline_comment|/* Fall through... */
r_case
id|CS_EVENT_RESET_PHYSICAL
suffix:colon
multiline_comment|/* Mark the device as stopped, to block IO until later */
id|info-&gt;stop
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|link-&gt;state
op_amp
id|DEV_CONFIG
)paren
id|pcmcia_release_configuration
c_func
(paren
id|link-&gt;handle
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS_EVENT_PM_RESUME
suffix:colon
id|link-&gt;state
op_and_assign
op_complement
id|DEV_SUSPEND
suffix:semicolon
multiline_comment|/* Fall through... */
r_case
id|CS_EVENT_CARD_RESET
suffix:colon
r_if
c_cond
(paren
id|link-&gt;state
op_amp
id|DEV_CONFIG
)paren
id|pcmcia_request_configuration
c_func
(paren
id|link-&gt;handle
comma
op_amp
id|link-&gt;conf
)paren
suffix:semicolon
id|info-&gt;stop
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|mgslpc_paranoia_check
r_static
r_inline
r_int
id|mgslpc_paranoia_check
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
comma
r_char
op_star
id|name
comma
r_const
r_char
op_star
id|routine
)paren
(brace
macro_line|#ifdef MGSLPC_PARANOIA_CHECK
r_static
r_const
r_char
op_star
id|badmagic
op_assign
l_string|&quot;Warning: bad magic number for mgsl struct (%s) in %s&bslash;n&quot;
suffix:semicolon
r_static
r_const
r_char
op_star
id|badinfo
op_assign
l_string|&quot;Warning: null mgslpc_info for (%s) in %s&bslash;n&quot;
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info
)paren
(brace
id|printk
c_func
(paren
id|badinfo
comma
id|name
comma
id|routine
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|info-&gt;magic
op_ne
id|MGSLPC_MAGIC
)paren
(brace
id|printk
c_func
(paren
id|badmagic
comma
id|name
comma
id|routine
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
macro_line|#else
r_if
c_cond
(paren
op_logical_neg
id|info
)paren
r_return
l_int|1
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
DECL|macro|CMD_RXFIFO
mdefine_line|#define CMD_RXFIFO      BIT7&t;
singleline_comment|// release current rx FIFO
DECL|macro|CMD_RXRESET
mdefine_line|#define CMD_RXRESET     BIT6&t;
singleline_comment|// receiver reset
DECL|macro|CMD_RXFIFO_READ
mdefine_line|#define CMD_RXFIFO_READ BIT5
DECL|macro|CMD_START_TIMER
mdefine_line|#define CMD_START_TIMER BIT4
DECL|macro|CMD_TXFIFO
mdefine_line|#define CMD_TXFIFO      BIT3&t;
singleline_comment|// release current tx FIFO
DECL|macro|CMD_TXEOM
mdefine_line|#define CMD_TXEOM       BIT1&t;
singleline_comment|// transmit end message
DECL|macro|CMD_TXRESET
mdefine_line|#define CMD_TXRESET     BIT0&t;
singleline_comment|// transmit reset
DECL|function|wait_command_complete
r_static
id|BOOLEAN
id|wait_command_complete
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
comma
r_int
r_char
id|channel
)paren
(brace
r_int
id|i
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* wait for command completion */
r_while
c_loop
(paren
id|read_reg
c_func
(paren
id|info
comma
(paren
r_int
r_char
)paren
(paren
id|channel
op_plus
id|STAR
)paren
)paren
op_amp
id|BIT2
)paren
(brace
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_increment
op_eq
l_int|1000
)paren
r_return
id|FALSE
suffix:semicolon
)brace
r_return
id|TRUE
suffix:semicolon
)brace
DECL|function|issue_command
r_static
r_void
id|issue_command
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
comma
r_int
r_char
id|channel
comma
r_int
r_char
id|cmd
)paren
(brace
id|wait_command_complete
c_func
(paren
id|info
comma
id|channel
)paren
suffix:semicolon
id|write_reg
c_func
(paren
id|info
comma
(paren
r_int
r_char
)paren
(paren
id|channel
op_plus
id|CMDR
)paren
comma
id|cmd
)paren
suffix:semicolon
)brace
DECL|function|tx_pause
r_static
r_void
id|tx_pause
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
id|MGSLPC_INFO
op_star
id|info
op_assign
(paren
id|MGSLPC_INFO
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|mgslpc_paranoia_check
c_func
(paren
id|info
comma
id|tty-&gt;name
comma
l_string|&quot;tx_pause&quot;
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;tx_pause(%s)&bslash;n&quot;
comma
id|info-&gt;device_name
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;tx_enabled
)paren
id|tx_stop
c_func
(paren
id|info
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|tx_release
r_static
r_void
id|tx_release
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
id|MGSLPC_INFO
op_star
id|info
op_assign
(paren
id|MGSLPC_INFO
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|mgslpc_paranoia_check
c_func
(paren
id|info
comma
id|tty-&gt;name
comma
l_string|&quot;tx_release&quot;
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;tx_release(%s)&bslash;n&quot;
comma
id|info-&gt;device_name
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;tx_enabled
)paren
id|tx_start
c_func
(paren
id|info
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* Return next bottom half action to perform.&n; * or 0 if nothing to do.&n; */
DECL|function|bh_action
r_static
r_int
id|bh_action
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;pending_bh
op_amp
id|BH_RECEIVE
)paren
(brace
id|info-&gt;pending_bh
op_and_assign
op_complement
id|BH_RECEIVE
suffix:semicolon
id|rc
op_assign
id|BH_RECEIVE
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|info-&gt;pending_bh
op_amp
id|BH_TRANSMIT
)paren
(brace
id|info-&gt;pending_bh
op_and_assign
op_complement
id|BH_TRANSMIT
suffix:semicolon
id|rc
op_assign
id|BH_TRANSMIT
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|info-&gt;pending_bh
op_amp
id|BH_STATUS
)paren
(brace
id|info-&gt;pending_bh
op_and_assign
op_complement
id|BH_STATUS
suffix:semicolon
id|rc
op_assign
id|BH_STATUS
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|rc
)paren
(brace
multiline_comment|/* Mark BH routine as complete */
id|info-&gt;bh_running
op_assign
l_int|0
suffix:semicolon
id|info-&gt;bh_requested
op_assign
l_int|0
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|bh_handler
r_void
id|bh_handler
c_func
(paren
r_void
op_star
id|Context
)paren
(brace
id|MGSLPC_INFO
op_star
id|info
op_assign
(paren
id|MGSLPC_INFO
op_star
)paren
id|Context
suffix:semicolon
r_int
id|action
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_BH
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):bh_handler(%s) entry&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
)paren
suffix:semicolon
id|info-&gt;bh_running
op_assign
l_int|1
suffix:semicolon
r_while
c_loop
(paren
(paren
id|action
op_assign
id|bh_action
c_func
(paren
id|info
)paren
)paren
op_ne
l_int|0
)paren
(brace
multiline_comment|/* Process work item */
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_BH
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):bh_handler() work item action=%d&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|action
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|action
)paren
(brace
r_case
id|BH_RECEIVE
suffix:colon
r_while
c_loop
(paren
id|rx_get_frame
c_func
(paren
id|info
)paren
)paren
(brace
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|BH_TRANSMIT
suffix:colon
id|bh_transmit
c_func
(paren
id|info
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BH_STATUS
suffix:colon
id|bh_status
c_func
(paren
id|info
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* unknown work item ID */
id|printk
c_func
(paren
l_string|&quot;Unknown work item ID=%08X!&bslash;n&quot;
comma
id|action
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_BH
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):bh_handler(%s) exit&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
)paren
suffix:semicolon
)brace
DECL|function|bh_transmit
r_void
id|bh_transmit
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
)paren
(brace
r_struct
id|tty_struct
op_star
id|tty
op_assign
id|info-&gt;tty
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_BH
)paren
id|printk
c_func
(paren
l_string|&quot;bh_transmit() entry on %s&bslash;n&quot;
comma
id|info-&gt;device_name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tty
)paren
(brace
id|tty_wakeup
c_func
(paren
id|tty
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|tty-&gt;write_wait
)paren
suffix:semicolon
)brace
)brace
DECL|function|bh_status
r_void
id|bh_status
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
)paren
(brace
id|info-&gt;ri_chkcount
op_assign
l_int|0
suffix:semicolon
id|info-&gt;dsr_chkcount
op_assign
l_int|0
suffix:semicolon
id|info-&gt;dcd_chkcount
op_assign
l_int|0
suffix:semicolon
id|info-&gt;cts_chkcount
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* eom: non-zero = end of frame */
DECL|function|rx_ready_hdlc
r_static
r_void
id|rx_ready_hdlc
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
comma
r_int
id|eom
)paren
(brace
r_int
r_char
id|data
(braket
l_int|2
)braket
suffix:semicolon
r_int
r_char
id|fifo_count
comma
id|read_count
comma
id|i
suffix:semicolon
id|RXBUF
op_star
id|buf
op_assign
(paren
id|RXBUF
op_star
)paren
(paren
id|info-&gt;rx_buf
op_plus
(paren
id|info-&gt;rx_put
op_star
id|info-&gt;rx_buf_size
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_ISR
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):rx_ready_hdlc(eom=%d)&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|eom
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;rx_enabled
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;rx_frame_count
op_ge
id|info-&gt;rx_buf_count
)paren
(brace
multiline_comment|/* no more free buffers */
id|issue_command
c_func
(paren
id|info
comma
id|CHA
comma
id|CMD_RXRESET
)paren
suffix:semicolon
id|info-&gt;pending_bh
op_or_assign
id|BH_RECEIVE
suffix:semicolon
id|info-&gt;rx_overflow
op_assign
l_int|1
suffix:semicolon
id|info-&gt;icount.buf_overrun
op_increment
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|eom
)paren
(brace
multiline_comment|/* end of frame, get FIFO count from RBCL register */
r_if
c_cond
(paren
op_logical_neg
(paren
id|fifo_count
op_assign
(paren
r_int
r_char
)paren
(paren
id|read_reg
c_func
(paren
id|info
comma
id|CHA
op_plus
id|RBCL
)paren
op_amp
l_int|0x1f
)paren
)paren
)paren
id|fifo_count
op_assign
l_int|32
suffix:semicolon
)brace
r_else
id|fifo_count
op_assign
l_int|32
suffix:semicolon
r_do
(brace
r_if
c_cond
(paren
id|fifo_count
op_eq
l_int|1
)paren
(brace
id|read_count
op_assign
l_int|1
suffix:semicolon
id|data
(braket
l_int|0
)braket
op_assign
id|read_reg
c_func
(paren
id|info
comma
id|CHA
op_plus
id|RXFIFO
)paren
suffix:semicolon
)brace
r_else
(brace
id|read_count
op_assign
l_int|2
suffix:semicolon
op_star
(paren
(paren
r_int
r_int
op_star
)paren
id|data
)paren
op_assign
id|read_reg16
c_func
(paren
id|info
comma
id|CHA
op_plus
id|RXFIFO
)paren
suffix:semicolon
)brace
id|fifo_count
op_sub_assign
id|read_count
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fifo_count
op_logical_and
id|eom
)paren
id|buf-&gt;status
op_assign
id|data
(braket
op_decrement
id|read_count
)braket
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|read_count
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|buf-&gt;count
op_ge
id|info-&gt;max_frame_size
)paren
(brace
multiline_comment|/* frame too large, reset receiver and reset current buffer */
id|issue_command
c_func
(paren
id|info
comma
id|CHA
comma
id|CMD_RXRESET
)paren
suffix:semicolon
id|buf-&gt;count
op_assign
l_int|0
suffix:semicolon
r_return
suffix:semicolon
)brace
op_star
(paren
id|buf-&gt;data
op_plus
id|buf-&gt;count
)paren
op_assign
id|data
(braket
id|i
)braket
suffix:semicolon
id|buf-&gt;count
op_increment
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|fifo_count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|eom
)paren
(brace
id|info-&gt;pending_bh
op_or_assign
id|BH_RECEIVE
suffix:semicolon
id|info-&gt;rx_frame_count
op_increment
suffix:semicolon
id|info-&gt;rx_put
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;rx_put
op_ge
id|info-&gt;rx_buf_count
)paren
id|info-&gt;rx_put
op_assign
l_int|0
suffix:semicolon
)brace
id|issue_command
c_func
(paren
id|info
comma
id|CHA
comma
id|CMD_RXFIFO
)paren
suffix:semicolon
)brace
DECL|function|rx_ready_async
r_static
r_void
id|rx_ready_async
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
comma
r_int
id|tcd
)paren
(brace
r_int
r_char
id|data
comma
id|status
suffix:semicolon
r_int
id|fifo_count
suffix:semicolon
r_struct
id|tty_struct
op_star
id|tty
op_assign
id|info-&gt;tty
suffix:semicolon
r_struct
id|mgsl_icount
op_star
id|icount
op_assign
op_amp
id|info-&gt;icount
suffix:semicolon
r_if
c_cond
(paren
id|tcd
)paren
(brace
multiline_comment|/* early termination, get FIFO count from RBCL register */
id|fifo_count
op_assign
(paren
r_int
r_char
)paren
(paren
id|read_reg
c_func
(paren
id|info
comma
id|CHA
op_plus
id|RBCL
)paren
op_amp
l_int|0x1f
)paren
suffix:semicolon
multiline_comment|/* Zero fifo count could mean 0 or 32 bytes available.&n;&t;&t; * If BIT5 of STAR is set then at least 1 byte is available.&n;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
id|fifo_count
op_logical_and
(paren
id|read_reg
c_func
(paren
id|info
comma
id|CHA
op_plus
id|STAR
)paren
op_amp
id|BIT5
)paren
)paren
id|fifo_count
op_assign
l_int|32
suffix:semicolon
)brace
r_else
id|fifo_count
op_assign
l_int|32
suffix:semicolon
multiline_comment|/* Flush received async data to receive data buffer. */
r_while
c_loop
(paren
id|fifo_count
)paren
(brace
id|data
op_assign
id|read_reg
c_func
(paren
id|info
comma
id|CHA
op_plus
id|RXFIFO
)paren
suffix:semicolon
id|status
op_assign
id|read_reg
c_func
(paren
id|info
comma
id|CHA
op_plus
id|RXFIFO
)paren
suffix:semicolon
id|fifo_count
op_sub_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|tty-&gt;flip.count
op_ge
id|TTY_FLIPBUF_SIZE
)paren
r_break
suffix:semicolon
op_star
id|tty-&gt;flip.char_buf_ptr
op_assign
id|data
suffix:semicolon
id|icount-&gt;rx
op_increment
suffix:semicolon
op_star
id|tty-&gt;flip.flag_buf_ptr
op_assign
l_int|0
suffix:semicolon
singleline_comment|// if no frameing/crc error then save data
singleline_comment|// BIT7:parity error
singleline_comment|// BIT6:framing error
r_if
c_cond
(paren
id|status
op_amp
(paren
id|BIT7
op_plus
id|BIT6
)paren
)paren
(brace
r_if
c_cond
(paren
id|status
op_amp
id|BIT7
)paren
id|icount-&gt;parity
op_increment
suffix:semicolon
r_else
id|icount-&gt;frame
op_increment
suffix:semicolon
multiline_comment|/* discard char if tty control flags say so */
r_if
c_cond
(paren
id|status
op_amp
id|info-&gt;ignore_status_mask
)paren
r_continue
suffix:semicolon
id|status
op_and_assign
id|info-&gt;read_status_mask
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|BIT7
)paren
op_star
id|tty-&gt;flip.flag_buf_ptr
op_assign
id|TTY_PARITY
suffix:semicolon
r_else
r_if
c_cond
(paren
id|status
op_amp
id|BIT6
)paren
op_star
id|tty-&gt;flip.flag_buf_ptr
op_assign
id|TTY_FRAME
suffix:semicolon
)brace
id|tty-&gt;flip.flag_buf_ptr
op_increment
suffix:semicolon
id|tty-&gt;flip.char_buf_ptr
op_increment
suffix:semicolon
id|tty-&gt;flip.count
op_increment
suffix:semicolon
)brace
id|issue_command
c_func
(paren
id|info
comma
id|CHA
comma
id|CMD_RXFIFO
)paren
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_ISR
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s(%d):rx_ready_async count=%d&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|tty-&gt;flip.count
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s(%d):rx=%d brk=%d parity=%d frame=%d overrun=%d&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|icount-&gt;rx
comma
id|icount-&gt;brk
comma
id|icount-&gt;parity
comma
id|icount-&gt;frame
comma
id|icount-&gt;overrun
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tty-&gt;flip.count
)paren
id|tty_flip_buffer_push
c_func
(paren
id|tty
)paren
suffix:semicolon
)brace
DECL|function|tx_done
r_static
r_void
id|tx_done
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;tx_active
)paren
r_return
suffix:semicolon
id|info-&gt;tx_active
op_assign
l_int|0
suffix:semicolon
id|info-&gt;tx_aborting
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;params.mode
op_eq
id|MGSL_MODE_ASYNC
)paren
r_return
suffix:semicolon
id|info-&gt;tx_count
op_assign
id|info-&gt;tx_put
op_assign
id|info-&gt;tx_get
op_assign
l_int|0
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|info-&gt;tx_timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;drop_rts_on_tx_done
)paren
(brace
id|get_signals
c_func
(paren
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;serial_signals
op_amp
id|SerialSignal_RTS
)paren
(brace
id|info-&gt;serial_signals
op_and_assign
op_complement
id|SerialSignal_RTS
suffix:semicolon
id|set_signals
c_func
(paren
id|info
)paren
suffix:semicolon
)brace
id|info-&gt;drop_rts_on_tx_done
op_assign
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_HDLC
r_if
c_cond
(paren
id|info-&gt;netcount
)paren
id|hdlcdev_tx_done
c_func
(paren
id|info
)paren
suffix:semicolon
r_else
macro_line|#endif
(brace
r_if
c_cond
(paren
id|info-&gt;tty-&gt;stopped
op_logical_or
id|info-&gt;tty-&gt;hw_stopped
)paren
(brace
id|tx_stop
c_func
(paren
id|info
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|info-&gt;pending_bh
op_or_assign
id|BH_TRANSMIT
suffix:semicolon
)brace
)brace
DECL|function|tx_ready
r_static
r_void
id|tx_ready
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
)paren
(brace
r_int
r_char
id|fifo_count
op_assign
l_int|32
suffix:semicolon
r_int
id|c
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_ISR
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):tx_ready(%s)&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;params.mode
op_eq
id|MGSL_MODE_HDLC
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;tx_active
)paren
r_return
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|info-&gt;tty-&gt;stopped
op_logical_or
id|info-&gt;tty-&gt;hw_stopped
)paren
(brace
id|tx_stop
c_func
(paren
id|info
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;tx_count
)paren
id|info-&gt;tx_active
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;tx_count
)paren
r_return
suffix:semicolon
r_while
c_loop
(paren
id|info-&gt;tx_count
op_logical_and
id|fifo_count
)paren
(brace
id|c
op_assign
id|min
c_func
(paren
l_int|2
comma
id|min_t
c_func
(paren
r_int
comma
id|fifo_count
comma
id|min
c_func
(paren
id|info-&gt;tx_count
comma
id|TXBUFSIZE
op_minus
id|info-&gt;tx_get
)paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|c
op_eq
l_int|1
)paren
(brace
id|write_reg
c_func
(paren
id|info
comma
id|CHA
op_plus
id|TXFIFO
comma
op_star
(paren
id|info-&gt;tx_buf
op_plus
id|info-&gt;tx_get
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|write_reg16
c_func
(paren
id|info
comma
id|CHA
op_plus
id|TXFIFO
comma
op_star
(paren
(paren
r_int
r_int
op_star
)paren
(paren
id|info-&gt;tx_buf
op_plus
id|info-&gt;tx_get
)paren
)paren
)paren
suffix:semicolon
)brace
id|info-&gt;tx_count
op_sub_assign
id|c
suffix:semicolon
id|info-&gt;tx_get
op_assign
(paren
id|info-&gt;tx_get
op_plus
id|c
)paren
op_amp
(paren
id|TXBUFSIZE
op_minus
l_int|1
)paren
suffix:semicolon
id|fifo_count
op_sub_assign
id|c
suffix:semicolon
)brace
r_if
c_cond
(paren
id|info-&gt;params.mode
op_eq
id|MGSL_MODE_ASYNC
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;tx_count
OL
id|WAKEUP_CHARS
)paren
id|info-&gt;pending_bh
op_or_assign
id|BH_TRANSMIT
suffix:semicolon
id|issue_command
c_func
(paren
id|info
comma
id|CHA
comma
id|CMD_TXFIFO
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|info-&gt;tx_count
)paren
id|issue_command
c_func
(paren
id|info
comma
id|CHA
comma
id|CMD_TXFIFO
)paren
suffix:semicolon
r_else
id|issue_command
c_func
(paren
id|info
comma
id|CHA
comma
id|CMD_TXFIFO
op_plus
id|CMD_TXEOM
)paren
suffix:semicolon
)brace
)brace
DECL|function|cts_change
r_static
r_void
id|cts_change
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
)paren
(brace
id|get_signals
c_func
(paren
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|info-&gt;cts_chkcount
)paren
op_increment
op_ge
id|IO_PIN_SHUTDOWN_LIMIT
)paren
id|irq_disable
c_func
(paren
id|info
comma
id|CHB
comma
id|IRQ_CTS
)paren
suffix:semicolon
id|info-&gt;icount.cts
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;serial_signals
op_amp
id|SerialSignal_CTS
)paren
id|info-&gt;input_signal_events.cts_up
op_increment
suffix:semicolon
r_else
id|info-&gt;input_signal_events.cts_down
op_increment
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|info-&gt;status_event_wait_q
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|info-&gt;event_wait_q
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;flags
op_amp
id|ASYNC_CTS_FLOW
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;tty-&gt;hw_stopped
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;serial_signals
op_amp
id|SerialSignal_CTS
)paren
(brace
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_ISR
)paren
id|printk
c_func
(paren
l_string|&quot;CTS tx start...&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;tty
)paren
id|info-&gt;tty-&gt;hw_stopped
op_assign
l_int|0
suffix:semicolon
id|tx_start
c_func
(paren
id|info
)paren
suffix:semicolon
id|info-&gt;pending_bh
op_or_assign
id|BH_TRANSMIT
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|info-&gt;serial_signals
op_amp
id|SerialSignal_CTS
)paren
)paren
(brace
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_ISR
)paren
id|printk
c_func
(paren
l_string|&quot;CTS tx stop...&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;tty
)paren
id|info-&gt;tty-&gt;hw_stopped
op_assign
l_int|1
suffix:semicolon
id|tx_stop
c_func
(paren
id|info
)paren
suffix:semicolon
)brace
)brace
)brace
id|info-&gt;pending_bh
op_or_assign
id|BH_STATUS
suffix:semicolon
)brace
DECL|function|dcd_change
r_static
r_void
id|dcd_change
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
)paren
(brace
id|get_signals
c_func
(paren
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|info-&gt;dcd_chkcount
)paren
op_increment
op_ge
id|IO_PIN_SHUTDOWN_LIMIT
)paren
id|irq_disable
c_func
(paren
id|info
comma
id|CHB
comma
id|IRQ_DCD
)paren
suffix:semicolon
id|info-&gt;icount.dcd
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;serial_signals
op_amp
id|SerialSignal_DCD
)paren
(brace
id|info-&gt;input_signal_events.dcd_up
op_increment
suffix:semicolon
)brace
r_else
id|info-&gt;input_signal_events.dcd_down
op_increment
suffix:semicolon
macro_line|#ifdef CONFIG_HDLC
r_if
c_cond
(paren
id|info-&gt;netcount
)paren
id|hdlc_set_carrier
c_func
(paren
id|info-&gt;serial_signals
op_amp
id|SerialSignal_DCD
comma
id|info-&gt;netdev
)paren
suffix:semicolon
macro_line|#endif
id|wake_up_interruptible
c_func
(paren
op_amp
id|info-&gt;status_event_wait_q
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|info-&gt;event_wait_q
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;flags
op_amp
id|ASYNC_CHECK_CD
)paren
(brace
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_ISR
)paren
id|printk
c_func
(paren
l_string|&quot;%s CD now %s...&quot;
comma
id|info-&gt;device_name
comma
(paren
id|info-&gt;serial_signals
op_amp
id|SerialSignal_DCD
)paren
ques
c_cond
l_string|&quot;on&quot;
suffix:colon
l_string|&quot;off&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;serial_signals
op_amp
id|SerialSignal_DCD
)paren
id|wake_up_interruptible
c_func
(paren
op_amp
id|info-&gt;open_wait
)paren
suffix:semicolon
r_else
(brace
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_ISR
)paren
id|printk
c_func
(paren
l_string|&quot;doing serial hangup...&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;tty
)paren
id|tty_hangup
c_func
(paren
id|info-&gt;tty
)paren
suffix:semicolon
)brace
)brace
id|info-&gt;pending_bh
op_or_assign
id|BH_STATUS
suffix:semicolon
)brace
DECL|function|dsr_change
r_static
r_void
id|dsr_change
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
)paren
(brace
id|get_signals
c_func
(paren
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|info-&gt;dsr_chkcount
)paren
op_increment
op_ge
id|IO_PIN_SHUTDOWN_LIMIT
)paren
id|port_irq_disable
c_func
(paren
id|info
comma
id|PVR_DSR
)paren
suffix:semicolon
id|info-&gt;icount.dsr
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;serial_signals
op_amp
id|SerialSignal_DSR
)paren
id|info-&gt;input_signal_events.dsr_up
op_increment
suffix:semicolon
r_else
id|info-&gt;input_signal_events.dsr_down
op_increment
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|info-&gt;status_event_wait_q
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|info-&gt;event_wait_q
)paren
suffix:semicolon
id|info-&gt;pending_bh
op_or_assign
id|BH_STATUS
suffix:semicolon
)brace
DECL|function|ri_change
r_static
r_void
id|ri_change
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
)paren
(brace
id|get_signals
c_func
(paren
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|info-&gt;ri_chkcount
)paren
op_increment
op_ge
id|IO_PIN_SHUTDOWN_LIMIT
)paren
id|port_irq_disable
c_func
(paren
id|info
comma
id|PVR_RI
)paren
suffix:semicolon
id|info-&gt;icount.rng
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;serial_signals
op_amp
id|SerialSignal_RI
)paren
id|info-&gt;input_signal_events.ri_up
op_increment
suffix:semicolon
r_else
id|info-&gt;input_signal_events.ri_down
op_increment
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|info-&gt;status_event_wait_q
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|info-&gt;event_wait_q
)paren
suffix:semicolon
id|info-&gt;pending_bh
op_or_assign
id|BH_STATUS
suffix:semicolon
)brace
multiline_comment|/* Interrupt service routine entry point.&n; * &t;&n; * Arguments:&n; * &n; * irq     interrupt number that caused interrupt&n; * dev_id  device ID supplied during interrupt registration&n; * regs    interrupted processor context&n; */
DECL|function|mgslpc_isr
r_static
id|irqreturn_t
id|mgslpc_isr
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|MGSLPC_INFO
op_star
id|info
op_assign
(paren
id|MGSLPC_INFO
op_star
)paren
id|dev_id
suffix:semicolon
r_int
r_int
id|isr
suffix:semicolon
r_int
r_char
id|gis
comma
id|pis
suffix:semicolon
r_int
id|count
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_ISR
)paren
id|printk
c_func
(paren
l_string|&quot;mgslpc_isr(%d) entry.&bslash;n&quot;
comma
id|irq
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info
)paren
r_return
id|IRQ_NONE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|info-&gt;link.state
op_amp
id|DEV_CONFIG
)paren
)paren
r_return
id|IRQ_HANDLED
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|info-&gt;lock
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|gis
op_assign
id|read_reg
c_func
(paren
id|info
comma
id|CHA
op_plus
id|GIS
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_ISR
)paren
id|printk
c_func
(paren
l_string|&quot;mgslpc_isr %s gis=%04X&bslash;n&quot;
comma
id|info-&gt;device_name
comma
id|gis
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|gis
op_amp
l_int|0x70
)paren
op_logical_or
id|count
OG
l_int|1000
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;synclink_cs:hardware failed or ejected&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|count
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|gis
op_amp
(paren
id|BIT1
op_plus
id|BIT0
)paren
)paren
(brace
id|isr
op_assign
id|read_reg16
c_func
(paren
id|info
comma
id|CHB
op_plus
id|ISR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|isr
op_amp
id|IRQ_DCD
)paren
id|dcd_change
c_func
(paren
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|isr
op_amp
id|IRQ_CTS
)paren
id|cts_change
c_func
(paren
id|info
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|gis
op_amp
(paren
id|BIT3
op_plus
id|BIT2
)paren
)paren
(brace
id|isr
op_assign
id|read_reg16
c_func
(paren
id|info
comma
id|CHA
op_plus
id|ISR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|isr
op_amp
id|IRQ_TIMER
)paren
(brace
id|info-&gt;irq_occurred
op_assign
l_int|1
suffix:semicolon
id|irq_disable
c_func
(paren
id|info
comma
id|CHA
comma
id|IRQ_TIMER
)paren
suffix:semicolon
)brace
multiline_comment|/* receive IRQs */
r_if
c_cond
(paren
id|isr
op_amp
id|IRQ_EXITHUNT
)paren
(brace
id|info-&gt;icount.exithunt
op_increment
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|info-&gt;event_wait_q
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|isr
op_amp
id|IRQ_BREAK_ON
)paren
(brace
id|info-&gt;icount.brk
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;flags
op_amp
id|ASYNC_SAK
)paren
id|do_SAK
c_func
(paren
id|info-&gt;tty
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|isr
op_amp
id|IRQ_RXTIME
)paren
(brace
id|issue_command
c_func
(paren
id|info
comma
id|CHA
comma
id|CMD_RXFIFO_READ
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|isr
op_amp
(paren
id|IRQ_RXEOM
op_plus
id|IRQ_RXFIFO
)paren
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;params.mode
op_eq
id|MGSL_MODE_HDLC
)paren
id|rx_ready_hdlc
c_func
(paren
id|info
comma
id|isr
op_amp
id|IRQ_RXEOM
)paren
suffix:semicolon
r_else
id|rx_ready_async
c_func
(paren
id|info
comma
id|isr
op_amp
id|IRQ_RXEOM
)paren
suffix:semicolon
)brace
multiline_comment|/* transmit IRQs */
r_if
c_cond
(paren
id|isr
op_amp
id|IRQ_UNDERRUN
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;tx_aborting
)paren
id|info-&gt;icount.txabort
op_increment
suffix:semicolon
r_else
id|info-&gt;icount.txunder
op_increment
suffix:semicolon
id|tx_done
c_func
(paren
id|info
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|isr
op_amp
id|IRQ_ALLSENT
)paren
(brace
id|info-&gt;icount.txok
op_increment
suffix:semicolon
id|tx_done
c_func
(paren
id|info
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|isr
op_amp
id|IRQ_TXFIFO
)paren
id|tx_ready
c_func
(paren
id|info
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|gis
op_amp
id|BIT7
)paren
(brace
id|pis
op_assign
id|read_reg
c_func
(paren
id|info
comma
id|CHA
op_plus
id|PIS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pis
op_amp
id|BIT1
)paren
id|dsr_change
c_func
(paren
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pis
op_amp
id|BIT2
)paren
id|ri_change
c_func
(paren
id|info
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Request bottom half processing if there&squot;s something &n;&t; * for it to do and the bh is not already running&n;&t; */
r_if
c_cond
(paren
id|info-&gt;pending_bh
op_logical_and
op_logical_neg
id|info-&gt;bh_running
op_logical_and
op_logical_neg
id|info-&gt;bh_requested
)paren
(brace
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_ISR
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s queueing bh task.&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
)paren
suffix:semicolon
id|schedule_work
c_func
(paren
op_amp
id|info-&gt;task
)paren
suffix:semicolon
id|info-&gt;bh_requested
op_assign
l_int|1
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|info-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_ISR
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):mgslpc_isr(%d)exit.&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|irq
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
multiline_comment|/* Initialize and start device.&n; */
DECL|function|startup
r_static
r_int
id|startup
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
)paren
(brace
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):startup(%s)&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;flags
op_amp
id|ASYNC_INITIALIZED
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;tx_buf
)paren
(brace
multiline_comment|/* allocate a page of memory for a transmit buffer */
id|info-&gt;tx_buf
op_assign
(paren
r_int
r_char
op_star
)paren
id|get_zeroed_page
c_func
(paren
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;tx_buf
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s(%d):%s can&squot;t allocate transmit buffer&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
)brace
id|info-&gt;pending_bh
op_assign
l_int|0
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|info-&gt;tx_timer
)paren
suffix:semicolon
id|info-&gt;tx_timer.data
op_assign
(paren
r_int
r_int
)paren
id|info
suffix:semicolon
id|info-&gt;tx_timer.function
op_assign
id|tx_timeout
suffix:semicolon
multiline_comment|/* Allocate and claim adapter resources */
id|retval
op_assign
id|claim_resources
c_func
(paren
id|info
)paren
suffix:semicolon
multiline_comment|/* perform existance check and diagnostics */
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
id|retval
op_assign
id|adapter_test
c_func
(paren
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
r_if
c_cond
(paren
id|capable
c_func
(paren
id|CAP_SYS_ADMIN
)paren
op_logical_and
id|info-&gt;tty
)paren
id|set_bit
c_func
(paren
id|TTY_IO_ERROR
comma
op_amp
id|info-&gt;tty-&gt;flags
)paren
suffix:semicolon
id|release_resources
c_func
(paren
id|info
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* program hardware for current parameters */
id|mgslpc_change_params
c_func
(paren
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;tty
)paren
id|clear_bit
c_func
(paren
id|TTY_IO_ERROR
comma
op_amp
id|info-&gt;tty-&gt;flags
)paren
suffix:semicolon
id|info-&gt;flags
op_or_assign
id|ASYNC_INITIALIZED
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Called by mgslpc_close() and mgslpc_hangup() to shutdown hardware&n; */
DECL|function|shutdown
r_static
r_void
id|shutdown
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|info-&gt;flags
op_amp
id|ASYNC_INITIALIZED
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):mgslpc_shutdown(%s)&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
)paren
suffix:semicolon
multiline_comment|/* clear status wait queue because status changes */
multiline_comment|/* can&squot;t happen after shutting down the hardware */
id|wake_up_interruptible
c_func
(paren
op_amp
id|info-&gt;status_event_wait_q
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|info-&gt;event_wait_q
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|info-&gt;tx_timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;tx_buf
)paren
(brace
id|free_page
c_func
(paren
(paren
r_int
r_int
)paren
id|info-&gt;tx_buf
)paren
suffix:semicolon
id|info-&gt;tx_buf
op_assign
l_int|NULL
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|rx_stop
c_func
(paren
id|info
)paren
suffix:semicolon
id|tx_stop
c_func
(paren
id|info
)paren
suffix:semicolon
multiline_comment|/* TODO:disable interrupts instead of reset to preserve signal states */
id|reset_device
c_func
(paren
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;tty
op_logical_or
id|info-&gt;tty-&gt;termios-&gt;c_cflag
op_amp
id|HUPCL
)paren
(brace
id|info-&gt;serial_signals
op_and_assign
op_complement
(paren
id|SerialSignal_DTR
op_plus
id|SerialSignal_RTS
)paren
suffix:semicolon
id|set_signals
c_func
(paren
id|info
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|release_resources
c_func
(paren
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;tty
)paren
id|set_bit
c_func
(paren
id|TTY_IO_ERROR
comma
op_amp
id|info-&gt;tty-&gt;flags
)paren
suffix:semicolon
id|info-&gt;flags
op_and_assign
op_complement
id|ASYNC_INITIALIZED
suffix:semicolon
)brace
DECL|function|mgslpc_program_hw
r_static
r_void
id|mgslpc_program_hw
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|rx_stop
c_func
(paren
id|info
)paren
suffix:semicolon
id|tx_stop
c_func
(paren
id|info
)paren
suffix:semicolon
id|info-&gt;tx_count
op_assign
id|info-&gt;tx_put
op_assign
id|info-&gt;tx_get
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;params.mode
op_eq
id|MGSL_MODE_HDLC
op_logical_or
id|info-&gt;netcount
)paren
id|hdlc_mode
c_func
(paren
id|info
)paren
suffix:semicolon
r_else
id|async_mode
c_func
(paren
id|info
)paren
suffix:semicolon
id|set_signals
c_func
(paren
id|info
)paren
suffix:semicolon
id|info-&gt;dcd_chkcount
op_assign
l_int|0
suffix:semicolon
id|info-&gt;cts_chkcount
op_assign
l_int|0
suffix:semicolon
id|info-&gt;ri_chkcount
op_assign
l_int|0
suffix:semicolon
id|info-&gt;dsr_chkcount
op_assign
l_int|0
suffix:semicolon
id|irq_enable
c_func
(paren
id|info
comma
id|CHB
comma
id|IRQ_DCD
op_or
id|IRQ_CTS
)paren
suffix:semicolon
id|port_irq_enable
c_func
(paren
id|info
comma
(paren
r_int
r_char
)paren
id|PVR_DSR
op_or
id|PVR_RI
)paren
suffix:semicolon
id|get_signals
c_func
(paren
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;netcount
op_logical_or
id|info-&gt;tty-&gt;termios-&gt;c_cflag
op_amp
id|CREAD
)paren
id|rx_start
c_func
(paren
id|info
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* Reconfigure adapter based on new parameters&n; */
DECL|function|mgslpc_change_params
r_static
r_void
id|mgslpc_change_params
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
)paren
(brace
r_int
id|cflag
suffix:semicolon
r_int
id|bits_per_char
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;tty
op_logical_or
op_logical_neg
id|info-&gt;tty-&gt;termios
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):mgslpc_change_params(%s)&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
)paren
suffix:semicolon
id|cflag
op_assign
id|info-&gt;tty-&gt;termios-&gt;c_cflag
suffix:semicolon
multiline_comment|/* if B0 rate (hangup) specified then negate DTR and RTS */
multiline_comment|/* otherwise assert DTR and RTS */
r_if
c_cond
(paren
id|cflag
op_amp
id|CBAUD
)paren
id|info-&gt;serial_signals
op_or_assign
id|SerialSignal_RTS
op_plus
id|SerialSignal_DTR
suffix:semicolon
r_else
id|info-&gt;serial_signals
op_and_assign
op_complement
(paren
id|SerialSignal_RTS
op_plus
id|SerialSignal_DTR
)paren
suffix:semicolon
multiline_comment|/* byte size and parity */
r_switch
c_cond
(paren
id|cflag
op_amp
id|CSIZE
)paren
(brace
r_case
id|CS5
suffix:colon
id|info-&gt;params.data_bits
op_assign
l_int|5
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS6
suffix:colon
id|info-&gt;params.data_bits
op_assign
l_int|6
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS7
suffix:colon
id|info-&gt;params.data_bits
op_assign
l_int|7
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS8
suffix:colon
id|info-&gt;params.data_bits
op_assign
l_int|8
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|info-&gt;params.data_bits
op_assign
l_int|7
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cflag
op_amp
id|CSTOPB
)paren
id|info-&gt;params.stop_bits
op_assign
l_int|2
suffix:semicolon
r_else
id|info-&gt;params.stop_bits
op_assign
l_int|1
suffix:semicolon
id|info-&gt;params.parity
op_assign
id|ASYNC_PARITY_NONE
suffix:semicolon
r_if
c_cond
(paren
id|cflag
op_amp
id|PARENB
)paren
(brace
r_if
c_cond
(paren
id|cflag
op_amp
id|PARODD
)paren
id|info-&gt;params.parity
op_assign
id|ASYNC_PARITY_ODD
suffix:semicolon
r_else
id|info-&gt;params.parity
op_assign
id|ASYNC_PARITY_EVEN
suffix:semicolon
macro_line|#ifdef CMSPAR
r_if
c_cond
(paren
id|cflag
op_amp
id|CMSPAR
)paren
id|info-&gt;params.parity
op_assign
id|ASYNC_PARITY_SPACE
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/* calculate number of jiffies to transmit a full&n;&t; * FIFO (32 bytes) at specified data rate&n;&t; */
id|bits_per_char
op_assign
id|info-&gt;params.data_bits
op_plus
id|info-&gt;params.stop_bits
op_plus
l_int|1
suffix:semicolon
multiline_comment|/* if port data rate is set to 460800 or less then&n;&t; * allow tty settings to override, otherwise keep the&n;&t; * current data rate.&n;&t; */
r_if
c_cond
(paren
id|info-&gt;params.data_rate
op_le
l_int|460800
)paren
(brace
id|info-&gt;params.data_rate
op_assign
id|tty_get_baud_rate
c_func
(paren
id|info-&gt;tty
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|info-&gt;params.data_rate
)paren
(brace
id|info-&gt;timeout
op_assign
(paren
l_int|32
op_star
id|HZ
op_star
id|bits_per_char
)paren
op_div
id|info-&gt;params.data_rate
suffix:semicolon
)brace
id|info-&gt;timeout
op_add_assign
id|HZ
op_div
l_int|50
suffix:semicolon
multiline_comment|/* Add .02 seconds of slop */
r_if
c_cond
(paren
id|cflag
op_amp
id|CRTSCTS
)paren
id|info-&gt;flags
op_or_assign
id|ASYNC_CTS_FLOW
suffix:semicolon
r_else
id|info-&gt;flags
op_and_assign
op_complement
id|ASYNC_CTS_FLOW
suffix:semicolon
r_if
c_cond
(paren
id|cflag
op_amp
id|CLOCAL
)paren
id|info-&gt;flags
op_and_assign
op_complement
id|ASYNC_CHECK_CD
suffix:semicolon
r_else
id|info-&gt;flags
op_or_assign
id|ASYNC_CHECK_CD
suffix:semicolon
multiline_comment|/* process tty input control flags */
id|info-&gt;read_status_mask
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|I_INPCK
c_func
(paren
id|info-&gt;tty
)paren
)paren
id|info-&gt;read_status_mask
op_or_assign
id|BIT7
op_or
id|BIT6
suffix:semicolon
r_if
c_cond
(paren
id|I_IGNPAR
c_func
(paren
id|info-&gt;tty
)paren
)paren
id|info-&gt;ignore_status_mask
op_or_assign
id|BIT7
op_or
id|BIT6
suffix:semicolon
id|mgslpc_program_hw
c_func
(paren
id|info
)paren
suffix:semicolon
)brace
multiline_comment|/* Add a character to the transmit buffer&n; */
DECL|function|mgslpc_put_char
r_static
r_void
id|mgslpc_put_char
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_int
r_char
id|ch
)paren
(brace
id|MGSLPC_INFO
op_star
id|info
op_assign
(paren
id|MGSLPC_INFO
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s(%d):mgslpc_put_char(%d) on %s&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|ch
comma
id|info-&gt;device_name
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mgslpc_paranoia_check
c_func
(paren
id|info
comma
id|tty-&gt;name
comma
l_string|&quot;mgslpc_put_char&quot;
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tty
op_logical_or
op_logical_neg
id|info-&gt;tx_buf
)paren
r_return
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;params.mode
op_eq
id|MGSL_MODE_ASYNC
op_logical_or
op_logical_neg
id|info-&gt;tx_active
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;tx_count
OL
id|TXBUFSIZE
op_minus
l_int|1
)paren
(brace
id|info-&gt;tx_buf
(braket
id|info-&gt;tx_put
op_increment
)braket
op_assign
id|ch
suffix:semicolon
id|info-&gt;tx_put
op_and_assign
id|TXBUFSIZE
op_minus
l_int|1
suffix:semicolon
id|info-&gt;tx_count
op_increment
suffix:semicolon
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* Enable transmitter so remaining characters in the&n; * transmit buffer are sent.&n; */
DECL|function|mgslpc_flush_chars
r_static
r_void
id|mgslpc_flush_chars
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
id|MGSLPC_INFO
op_star
id|info
op_assign
(paren
id|MGSLPC_INFO
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):mgslpc_flush_chars() entry on %s tx_count=%d&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
comma
id|info-&gt;tx_count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mgslpc_paranoia_check
c_func
(paren
id|info
comma
id|tty-&gt;name
comma
l_string|&quot;mgslpc_flush_chars&quot;
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;tx_count
op_le
l_int|0
op_logical_or
id|tty-&gt;stopped
op_logical_or
id|tty-&gt;hw_stopped
op_logical_or
op_logical_neg
id|info-&gt;tx_buf
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):mgslpc_flush_chars() entry on %s starting transmitter&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;tx_active
)paren
id|tx_start
c_func
(paren
id|info
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* Send a block of data&n; * &t;&n; * Arguments:&n; * &n; * tty        pointer to tty information structure&n; * buf&t;      pointer to buffer containing send data&n; * count      size of send data in bytes&n; * &t;&n; * Returns: number of characters written&n; */
DECL|function|mgslpc_write
r_static
r_int
id|mgslpc_write
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_const
r_int
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_int
id|c
comma
id|ret
op_assign
l_int|0
suffix:semicolon
id|MGSLPC_INFO
op_star
id|info
op_assign
(paren
id|MGSLPC_INFO
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):mgslpc_write(%s) count=%d&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
comma
id|count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mgslpc_paranoia_check
c_func
(paren
id|info
comma
id|tty-&gt;name
comma
l_string|&quot;mgslpc_write&quot;
)paren
op_logical_or
op_logical_neg
id|tty
op_logical_or
op_logical_neg
id|info-&gt;tx_buf
)paren
r_goto
id|cleanup
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;params.mode
op_eq
id|MGSL_MODE_HDLC
)paren
(brace
r_if
c_cond
(paren
id|count
OG
id|TXBUFSIZE
)paren
(brace
id|ret
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|cleanup
suffix:semicolon
)brace
r_if
c_cond
(paren
id|info-&gt;tx_active
)paren
r_goto
id|cleanup
suffix:semicolon
r_else
r_if
c_cond
(paren
id|info-&gt;tx_count
)paren
r_goto
id|start
suffix:semicolon
)brace
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|c
op_assign
id|min
c_func
(paren
id|count
comma
id|min
c_func
(paren
id|TXBUFSIZE
op_minus
id|info-&gt;tx_count
op_minus
l_int|1
comma
id|TXBUFSIZE
op_minus
id|info-&gt;tx_put
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|c
op_le
l_int|0
)paren
r_break
suffix:semicolon
id|memcpy
c_func
(paren
id|info-&gt;tx_buf
op_plus
id|info-&gt;tx_put
comma
id|buf
comma
id|c
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|info-&gt;tx_put
op_assign
(paren
id|info-&gt;tx_put
op_plus
id|c
)paren
op_amp
(paren
id|TXBUFSIZE
op_minus
l_int|1
)paren
suffix:semicolon
id|info-&gt;tx_count
op_add_assign
id|c
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|buf
op_add_assign
id|c
suffix:semicolon
id|count
op_sub_assign
id|c
suffix:semicolon
id|ret
op_add_assign
id|c
suffix:semicolon
)brace
id|start
suffix:colon
r_if
c_cond
(paren
id|info-&gt;tx_count
op_logical_and
op_logical_neg
id|tty-&gt;stopped
op_logical_and
op_logical_neg
id|tty-&gt;hw_stopped
)paren
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;tx_active
)paren
id|tx_start
c_func
(paren
id|info
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
id|cleanup
suffix:colon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):mgslpc_write(%s) returning=%d&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
comma
id|ret
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* Return the count of free bytes in transmit buffer&n; */
DECL|function|mgslpc_write_room
r_static
r_int
id|mgslpc_write_room
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
id|MGSLPC_INFO
op_star
id|info
op_assign
(paren
id|MGSLPC_INFO
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
id|mgslpc_paranoia_check
c_func
(paren
id|info
comma
id|tty-&gt;name
comma
l_string|&quot;mgslpc_write_room&quot;
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;params.mode
op_eq
id|MGSL_MODE_HDLC
)paren
(brace
multiline_comment|/* HDLC (frame oriented) mode */
r_if
c_cond
(paren
id|info-&gt;tx_active
)paren
r_return
l_int|0
suffix:semicolon
r_else
r_return
id|HDLC_MAX_FRAME_SIZE
suffix:semicolon
)brace
r_else
(brace
id|ret
op_assign
id|TXBUFSIZE
op_minus
id|info-&gt;tx_count
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
id|ret
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):mgslpc_write_room(%s)=%d&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
comma
id|ret
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* Return the count of bytes in transmit buffer&n; */
DECL|function|mgslpc_chars_in_buffer
r_static
r_int
id|mgslpc_chars_in_buffer
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
id|MGSLPC_INFO
op_star
id|info
op_assign
(paren
id|MGSLPC_INFO
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):mgslpc_chars_in_buffer(%s)&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mgslpc_paranoia_check
c_func
(paren
id|info
comma
id|tty-&gt;name
comma
l_string|&quot;mgslpc_chars_in_buffer&quot;
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;params.mode
op_eq
id|MGSL_MODE_HDLC
)paren
id|rc
op_assign
id|info-&gt;tx_active
ques
c_cond
id|info-&gt;max_frame_size
suffix:colon
l_int|0
suffix:semicolon
r_else
id|rc
op_assign
id|info-&gt;tx_count
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):mgslpc_chars_in_buffer(%s)=%d&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
comma
id|rc
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/* Discard all data in the send buffer&n; */
DECL|function|mgslpc_flush_buffer
r_static
r_void
id|mgslpc_flush_buffer
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
id|MGSLPC_INFO
op_star
id|info
op_assign
(paren
id|MGSLPC_INFO
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):mgslpc_flush_buffer(%s) entry&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mgslpc_paranoia_check
c_func
(paren
id|info
comma
id|tty-&gt;name
comma
l_string|&quot;mgslpc_flush_buffer&quot;
)paren
)paren
r_return
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|info-&gt;tx_count
op_assign
id|info-&gt;tx_put
op_assign
id|info-&gt;tx_get
op_assign
l_int|0
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|info-&gt;tx_timer
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|tty-&gt;write_wait
)paren
suffix:semicolon
id|tty_wakeup
c_func
(paren
id|tty
)paren
suffix:semicolon
)brace
multiline_comment|/* Send a high-priority XON/XOFF character&n; */
DECL|function|mgslpc_send_xchar
r_static
r_void
id|mgslpc_send_xchar
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_char
id|ch
)paren
(brace
id|MGSLPC_INFO
op_star
id|info
op_assign
(paren
id|MGSLPC_INFO
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):mgslpc_send_xchar(%s,%d)&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
comma
id|ch
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mgslpc_paranoia_check
c_func
(paren
id|info
comma
id|tty-&gt;name
comma
l_string|&quot;mgslpc_send_xchar&quot;
)paren
)paren
r_return
suffix:semicolon
id|info-&gt;x_char
op_assign
id|ch
suffix:semicolon
r_if
c_cond
(paren
id|ch
)paren
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;tx_enabled
)paren
id|tx_start
c_func
(paren
id|info
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Signal remote device to throttle send data (our receive data)&n; */
DECL|function|mgslpc_throttle
r_static
r_void
id|mgslpc_throttle
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
id|MGSLPC_INFO
op_star
id|info
op_assign
(paren
id|MGSLPC_INFO
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):mgslpc_throttle(%s) entry&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mgslpc_paranoia_check
c_func
(paren
id|info
comma
id|tty-&gt;name
comma
l_string|&quot;mgslpc_throttle&quot;
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|I_IXOFF
c_func
(paren
id|tty
)paren
)paren
id|mgslpc_send_xchar
c_func
(paren
id|tty
comma
id|STOP_CHAR
c_func
(paren
id|tty
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tty-&gt;termios-&gt;c_cflag
op_amp
id|CRTSCTS
)paren
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|info-&gt;serial_signals
op_and_assign
op_complement
id|SerialSignal_RTS
suffix:semicolon
id|set_signals
c_func
(paren
id|info
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Signal remote device to stop throttling send data (our receive data)&n; */
DECL|function|mgslpc_unthrottle
r_static
r_void
id|mgslpc_unthrottle
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
id|MGSLPC_INFO
op_star
id|info
op_assign
(paren
id|MGSLPC_INFO
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):mgslpc_unthrottle(%s) entry&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mgslpc_paranoia_check
c_func
(paren
id|info
comma
id|tty-&gt;name
comma
l_string|&quot;mgslpc_unthrottle&quot;
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|I_IXOFF
c_func
(paren
id|tty
)paren
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;x_char
)paren
id|info-&gt;x_char
op_assign
l_int|0
suffix:semicolon
r_else
id|mgslpc_send_xchar
c_func
(paren
id|tty
comma
id|START_CHAR
c_func
(paren
id|tty
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tty-&gt;termios-&gt;c_cflag
op_amp
id|CRTSCTS
)paren
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|info-&gt;serial_signals
op_or_assign
id|SerialSignal_RTS
suffix:semicolon
id|set_signals
c_func
(paren
id|info
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* get the current serial statistics&n; */
DECL|function|get_stats
r_static
r_int
id|get_stats
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
comma
r_struct
id|mgsl_icount
id|__user
op_star
id|user_icount
)paren
(brace
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;get_params(%s)&bslash;n&quot;
comma
id|info-&gt;device_name
)paren
suffix:semicolon
id|COPY_TO_USER
c_func
(paren
id|err
comma
id|user_icount
comma
op_amp
id|info-&gt;icount
comma
r_sizeof
(paren
r_struct
id|mgsl_icount
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* get the current serial parameters&n; */
DECL|function|get_params
r_static
r_int
id|get_params
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
comma
id|MGSL_PARAMS
id|__user
op_star
id|user_params
)paren
(brace
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;get_params(%s)&bslash;n&quot;
comma
id|info-&gt;device_name
)paren
suffix:semicolon
id|COPY_TO_USER
c_func
(paren
id|err
comma
id|user_params
comma
op_amp
id|info-&gt;params
comma
r_sizeof
(paren
id|MGSL_PARAMS
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* set the serial parameters&n; * &t;&n; * Arguments:&n; * &n; * &t;info&t;&t;pointer to device instance data&n; * &t;new_params&t;user buffer containing new serial params&n; *&n; * Returns:&t;0 if success, otherwise error code&n; */
DECL|function|set_params
r_static
r_int
id|set_params
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
comma
id|MGSL_PARAMS
id|__user
op_star
id|new_params
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|MGSL_PARAMS
id|tmp_params
suffix:semicolon
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):set_params %s&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
)paren
suffix:semicolon
id|COPY_FROM_USER
c_func
(paren
id|err
comma
op_amp
id|tmp_params
comma
id|new_params
comma
r_sizeof
(paren
id|MGSL_PARAMS
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):set_params(%s) user buffer copy failed&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|info-&gt;params
comma
op_amp
id|tmp_params
comma
r_sizeof
(paren
id|MGSL_PARAMS
)paren
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|mgslpc_change_params
c_func
(paren
id|info
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|get_txidle
r_static
r_int
id|get_txidle
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
comma
r_int
id|__user
op_star
id|idle_mode
)paren
(brace
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;get_txidle(%s)=%d&bslash;n&quot;
comma
id|info-&gt;device_name
comma
id|info-&gt;idle_mode
)paren
suffix:semicolon
id|COPY_TO_USER
c_func
(paren
id|err
comma
id|idle_mode
comma
op_amp
id|info-&gt;idle_mode
comma
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|set_txidle
r_static
r_int
id|set_txidle
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
comma
r_int
id|idle_mode
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;set_txidle(%s,%d)&bslash;n&quot;
comma
id|info-&gt;device_name
comma
id|idle_mode
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|info-&gt;idle_mode
op_assign
id|idle_mode
suffix:semicolon
id|tx_set_idle
c_func
(paren
id|info
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|get_interface
r_static
r_int
id|get_interface
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
comma
r_int
id|__user
op_star
id|if_mode
)paren
(brace
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;get_interface(%s)=%d&bslash;n&quot;
comma
id|info-&gt;device_name
comma
id|info-&gt;if_mode
)paren
suffix:semicolon
id|COPY_TO_USER
c_func
(paren
id|err
comma
id|if_mode
comma
op_amp
id|info-&gt;if_mode
comma
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|set_interface
r_static
r_int
id|set_interface
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
comma
r_int
id|if_mode
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
r_char
id|val
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;set_interface(%s,%d)&bslash;n&quot;
comma
id|info-&gt;device_name
comma
id|if_mode
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|info-&gt;if_mode
op_assign
id|if_mode
suffix:semicolon
id|val
op_assign
id|read_reg
c_func
(paren
id|info
comma
id|PVR
)paren
op_amp
l_int|0x0f
suffix:semicolon
r_switch
c_cond
(paren
id|info-&gt;if_mode
)paren
(brace
r_case
id|MGSL_INTERFACE_RS232
suffix:colon
id|val
op_or_assign
id|PVR_RS232
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MGSL_INTERFACE_V35
suffix:colon
id|val
op_or_assign
id|PVR_V35
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MGSL_INTERFACE_RS422
suffix:colon
id|val
op_or_assign
id|PVR_RS422
suffix:semicolon
r_break
suffix:semicolon
)brace
id|write_reg
c_func
(paren
id|info
comma
id|PVR
comma
id|val
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|set_txenable
r_static
r_int
id|set_txenable
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
comma
r_int
id|enable
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;set_txenable(%s,%d)&bslash;n&quot;
comma
id|info-&gt;device_name
comma
id|enable
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|enable
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;tx_enabled
)paren
id|tx_start
c_func
(paren
id|info
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|info-&gt;tx_enabled
)paren
id|tx_stop
c_func
(paren
id|info
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|tx_abort
r_static
r_int
id|tx_abort
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;tx_abort(%s)&bslash;n&quot;
comma
id|info-&gt;device_name
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;tx_active
op_logical_and
id|info-&gt;tx_count
op_logical_and
id|info-&gt;params.mode
op_eq
id|MGSL_MODE_HDLC
)paren
(brace
multiline_comment|/* clear data count so FIFO is not filled on next IRQ.&n;&t;&t; * This results in underrun and abort transmission.&n;&t;&t; */
id|info-&gt;tx_count
op_assign
id|info-&gt;tx_put
op_assign
id|info-&gt;tx_get
op_assign
l_int|0
suffix:semicolon
id|info-&gt;tx_aborting
op_assign
id|TRUE
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|set_rxenable
r_static
r_int
id|set_rxenable
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
comma
r_int
id|enable
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;set_rxenable(%s,%d)&bslash;n&quot;
comma
id|info-&gt;device_name
comma
id|enable
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|enable
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;rx_enabled
)paren
id|rx_start
c_func
(paren
id|info
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|info-&gt;rx_enabled
)paren
id|rx_stop
c_func
(paren
id|info
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* wait for specified event to occur&n; * &t;&n; * Arguments:&t; &t;info&t;pointer to device instance data&n; * &t;&t;&t;mask&t;pointer to bitmask of events to wait for&n; * Return Value:&t;0 &t;if successful and bit mask updated with&n; *&t;&t;&t;&t;of events triggerred,&n; * &t;&t;&t;otherwise error code&n; */
DECL|function|wait_events
r_static
r_int
id|wait_events
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
comma
r_int
id|__user
op_star
id|mask_ptr
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|s
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_struct
id|mgsl_icount
id|cprev
comma
id|cnow
suffix:semicolon
r_int
id|events
suffix:semicolon
r_int
id|mask
suffix:semicolon
r_struct
id|_input_signal_events
id|oldsigs
comma
id|newsigs
suffix:semicolon
id|DECLARE_WAITQUEUE
c_func
(paren
id|wait
comma
id|current
)paren
suffix:semicolon
id|COPY_FROM_USER
c_func
(paren
id|rc
comma
op_amp
id|mask
comma
id|mask_ptr
comma
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;wait_events(%s,%d)&bslash;n&quot;
comma
id|info-&gt;device_name
comma
id|mask
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* return immediately if state matches requested events */
id|get_signals
c_func
(paren
id|info
)paren
suffix:semicolon
id|s
op_assign
id|info-&gt;serial_signals
suffix:semicolon
id|events
op_assign
id|mask
op_amp
(paren
(paren
(paren
id|s
op_amp
id|SerialSignal_DSR
)paren
ques
c_cond
id|MgslEvent_DsrActive
suffix:colon
id|MgslEvent_DsrInactive
)paren
op_plus
(paren
(paren
id|s
op_amp
id|SerialSignal_DCD
)paren
ques
c_cond
id|MgslEvent_DcdActive
suffix:colon
id|MgslEvent_DcdInactive
)paren
op_plus
(paren
(paren
id|s
op_amp
id|SerialSignal_CTS
)paren
ques
c_cond
id|MgslEvent_CtsActive
suffix:colon
id|MgslEvent_CtsInactive
)paren
op_plus
(paren
(paren
id|s
op_amp
id|SerialSignal_RI
)paren
ques
c_cond
id|MgslEvent_RiActive
suffix:colon
id|MgslEvent_RiInactive
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|events
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
multiline_comment|/* save current irq counts */
id|cprev
op_assign
id|info-&gt;icount
suffix:semicolon
id|oldsigs
op_assign
id|info-&gt;input_signal_events
suffix:semicolon
r_if
c_cond
(paren
(paren
id|info-&gt;params.mode
op_eq
id|MGSL_MODE_HDLC
)paren
op_logical_and
(paren
id|mask
op_amp
id|MgslEvent_ExitHuntMode
)paren
)paren
id|irq_enable
c_func
(paren
id|info
comma
id|CHA
comma
id|IRQ_EXITHUNT
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|add_wait_queue
c_func
(paren
op_amp
id|info-&gt;event_wait_q
comma
op_amp
id|wait
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|schedule
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
id|rc
op_assign
op_minus
id|ERESTARTSYS
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* get current irq counts */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|cnow
op_assign
id|info-&gt;icount
suffix:semicolon
id|newsigs
op_assign
id|info-&gt;input_signal_events
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* if no change, wait aborted for some reason */
r_if
c_cond
(paren
id|newsigs.dsr_up
op_eq
id|oldsigs.dsr_up
op_logical_and
id|newsigs.dsr_down
op_eq
id|oldsigs.dsr_down
op_logical_and
id|newsigs.dcd_up
op_eq
id|oldsigs.dcd_up
op_logical_and
id|newsigs.dcd_down
op_eq
id|oldsigs.dcd_down
op_logical_and
id|newsigs.cts_up
op_eq
id|oldsigs.cts_up
op_logical_and
id|newsigs.cts_down
op_eq
id|oldsigs.cts_down
op_logical_and
id|newsigs.ri_up
op_eq
id|oldsigs.ri_up
op_logical_and
id|newsigs.ri_down
op_eq
id|oldsigs.ri_down
op_logical_and
id|cnow.exithunt
op_eq
id|cprev.exithunt
op_logical_and
id|cnow.rxidle
op_eq
id|cprev.rxidle
)paren
(brace
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
r_break
suffix:semicolon
)brace
id|events
op_assign
id|mask
op_amp
(paren
(paren
id|newsigs.dsr_up
op_ne
id|oldsigs.dsr_up
ques
c_cond
id|MgslEvent_DsrActive
suffix:colon
l_int|0
)paren
op_plus
(paren
id|newsigs.dsr_down
op_ne
id|oldsigs.dsr_down
ques
c_cond
id|MgslEvent_DsrInactive
suffix:colon
l_int|0
)paren
op_plus
(paren
id|newsigs.dcd_up
op_ne
id|oldsigs.dcd_up
ques
c_cond
id|MgslEvent_DcdActive
suffix:colon
l_int|0
)paren
op_plus
(paren
id|newsigs.dcd_down
op_ne
id|oldsigs.dcd_down
ques
c_cond
id|MgslEvent_DcdInactive
suffix:colon
l_int|0
)paren
op_plus
(paren
id|newsigs.cts_up
op_ne
id|oldsigs.cts_up
ques
c_cond
id|MgslEvent_CtsActive
suffix:colon
l_int|0
)paren
op_plus
(paren
id|newsigs.cts_down
op_ne
id|oldsigs.cts_down
ques
c_cond
id|MgslEvent_CtsInactive
suffix:colon
l_int|0
)paren
op_plus
(paren
id|newsigs.ri_up
op_ne
id|oldsigs.ri_up
ques
c_cond
id|MgslEvent_RiActive
suffix:colon
l_int|0
)paren
op_plus
(paren
id|newsigs.ri_down
op_ne
id|oldsigs.ri_down
ques
c_cond
id|MgslEvent_RiInactive
suffix:colon
l_int|0
)paren
op_plus
(paren
id|cnow.exithunt
op_ne
id|cprev.exithunt
ques
c_cond
id|MgslEvent_ExitHuntMode
suffix:colon
l_int|0
)paren
op_plus
(paren
id|cnow.rxidle
op_ne
id|cprev.rxidle
ques
c_cond
id|MgslEvent_IdleReceived
suffix:colon
l_int|0
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|events
)paren
r_break
suffix:semicolon
id|cprev
op_assign
id|cnow
suffix:semicolon
id|oldsigs
op_assign
id|newsigs
suffix:semicolon
)brace
id|remove_wait_queue
c_func
(paren
op_amp
id|info-&gt;event_wait_q
comma
op_amp
id|wait
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_RUNNING
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mask
op_amp
id|MgslEvent_ExitHuntMode
)paren
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|waitqueue_active
c_func
(paren
op_amp
id|info-&gt;event_wait_q
)paren
)paren
id|irq_disable
c_func
(paren
id|info
comma
id|CHA
comma
id|IRQ_EXITHUNT
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
m_exit
suffix:colon
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
)paren
id|PUT_USER
c_func
(paren
id|rc
comma
id|events
comma
id|mask_ptr
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|modem_input_wait
r_static
r_int
id|modem_input_wait
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
comma
r_int
id|arg
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_struct
id|mgsl_icount
id|cprev
comma
id|cnow
suffix:semicolon
id|DECLARE_WAITQUEUE
c_func
(paren
id|wait
comma
id|current
)paren
suffix:semicolon
multiline_comment|/* save current irq counts */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|cprev
op_assign
id|info-&gt;icount
suffix:semicolon
id|add_wait_queue
c_func
(paren
op_amp
id|info-&gt;status_event_wait_q
comma
op_amp
id|wait
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|schedule
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
id|rc
op_assign
op_minus
id|ERESTARTSYS
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* get new irq counts */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|cnow
op_assign
id|info-&gt;icount
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* if no change, wait aborted for some reason */
r_if
c_cond
(paren
id|cnow.rng
op_eq
id|cprev.rng
op_logical_and
id|cnow.dsr
op_eq
id|cprev.dsr
op_logical_and
id|cnow.dcd
op_eq
id|cprev.dcd
op_logical_and
id|cnow.cts
op_eq
id|cprev.cts
)paren
(brace
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* check for change in caller specified modem input */
r_if
c_cond
(paren
(paren
id|arg
op_amp
id|TIOCM_RNG
op_logical_and
id|cnow.rng
op_ne
id|cprev.rng
)paren
op_logical_or
(paren
id|arg
op_amp
id|TIOCM_DSR
op_logical_and
id|cnow.dsr
op_ne
id|cprev.dsr
)paren
op_logical_or
(paren
id|arg
op_amp
id|TIOCM_CD
op_logical_and
id|cnow.dcd
op_ne
id|cprev.dcd
)paren
op_logical_or
(paren
id|arg
op_amp
id|TIOCM_CTS
op_logical_and
id|cnow.cts
op_ne
id|cprev.cts
)paren
)paren
(brace
id|rc
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
id|cprev
op_assign
id|cnow
suffix:semicolon
)brace
id|remove_wait_queue
c_func
(paren
op_amp
id|info-&gt;status_event_wait_q
comma
op_amp
id|wait
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_RUNNING
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/* return the state of the serial control and status signals&n; */
DECL|function|tiocmget
r_static
r_int
id|tiocmget
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|file
)paren
(brace
id|MGSLPC_INFO
op_star
id|info
op_assign
(paren
id|MGSLPC_INFO
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_int
r_int
id|result
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|get_signals
c_func
(paren
id|info
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|result
op_assign
(paren
(paren
id|info-&gt;serial_signals
op_amp
id|SerialSignal_RTS
)paren
ques
c_cond
id|TIOCM_RTS
suffix:colon
l_int|0
)paren
op_plus
(paren
(paren
id|info-&gt;serial_signals
op_amp
id|SerialSignal_DTR
)paren
ques
c_cond
id|TIOCM_DTR
suffix:colon
l_int|0
)paren
op_plus
(paren
(paren
id|info-&gt;serial_signals
op_amp
id|SerialSignal_DCD
)paren
ques
c_cond
id|TIOCM_CAR
suffix:colon
l_int|0
)paren
op_plus
(paren
(paren
id|info-&gt;serial_signals
op_amp
id|SerialSignal_RI
)paren
ques
c_cond
id|TIOCM_RNG
suffix:colon
l_int|0
)paren
op_plus
(paren
(paren
id|info-&gt;serial_signals
op_amp
id|SerialSignal_DSR
)paren
ques
c_cond
id|TIOCM_DSR
suffix:colon
l_int|0
)paren
op_plus
(paren
(paren
id|info-&gt;serial_signals
op_amp
id|SerialSignal_CTS
)paren
ques
c_cond
id|TIOCM_CTS
suffix:colon
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s tiocmget() value=%08X&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
comma
id|result
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/* set modem control signals (DTR/RTS)&n; */
DECL|function|tiocmset
r_static
r_int
id|tiocmset
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|set
comma
r_int
r_int
id|clear
)paren
(brace
id|MGSLPC_INFO
op_star
id|info
op_assign
(paren
id|MGSLPC_INFO
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s tiocmset(%x,%x)&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
comma
id|set
comma
id|clear
)paren
suffix:semicolon
r_if
c_cond
(paren
id|set
op_amp
id|TIOCM_RTS
)paren
id|info-&gt;serial_signals
op_or_assign
id|SerialSignal_RTS
suffix:semicolon
r_if
c_cond
(paren
id|set
op_amp
id|TIOCM_DTR
)paren
id|info-&gt;serial_signals
op_or_assign
id|SerialSignal_DTR
suffix:semicolon
r_if
c_cond
(paren
id|clear
op_amp
id|TIOCM_RTS
)paren
id|info-&gt;serial_signals
op_and_assign
op_complement
id|SerialSignal_RTS
suffix:semicolon
r_if
c_cond
(paren
id|clear
op_amp
id|TIOCM_DTR
)paren
id|info-&gt;serial_signals
op_and_assign
op_complement
id|SerialSignal_DTR
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|set_signals
c_func
(paren
id|info
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Set or clear transmit break condition&n; *&n; * Arguments:&t;&t;tty&t;&t;pointer to tty instance data&n; *&t;&t;&t;break_state&t;-1=set break condition, 0=clear&n; */
DECL|function|mgslpc_break
r_static
r_void
id|mgslpc_break
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_int
id|break_state
)paren
(brace
id|MGSLPC_INFO
op_star
id|info
op_assign
(paren
id|MGSLPC_INFO
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):mgslpc_break(%s,%d)&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
comma
id|break_state
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mgslpc_paranoia_check
c_func
(paren
id|info
comma
id|tty-&gt;name
comma
l_string|&quot;mgslpc_break&quot;
)paren
)paren
r_return
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|break_state
op_eq
op_minus
l_int|1
)paren
id|set_reg_bits
c_func
(paren
id|info
comma
id|CHA
op_plus
id|DAFO
comma
id|BIT6
)paren
suffix:semicolon
r_else
id|clear_reg_bits
c_func
(paren
id|info
comma
id|CHA
op_plus
id|DAFO
comma
id|BIT6
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* Service an IOCTL request&n; * &t;&n; * Arguments:&n; * &n; * &t;tty&t;pointer to tty instance data&n; * &t;file&t;pointer to associated file object for device&n; * &t;cmd&t;IOCTL command code&n; * &t;arg&t;command argument/context&n; * &t;&n; * Return Value:&t;0 if success, otherwise error code&n; */
DECL|function|mgslpc_ioctl
r_static
r_int
id|mgslpc_ioctl
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
id|MGSLPC_INFO
op_star
id|info
op_assign
(paren
id|MGSLPC_INFO
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):mgslpc_ioctl %s cmd=%08X&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
comma
id|cmd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mgslpc_paranoia_check
c_func
(paren
id|info
comma
id|tty-&gt;name
comma
l_string|&quot;mgslpc_ioctl&quot;
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
(paren
id|cmd
op_ne
id|TIOCGSERIAL
)paren
op_logical_and
(paren
id|cmd
op_ne
id|TIOCSSERIAL
)paren
op_logical_and
(paren
id|cmd
op_ne
id|TIOCMIWAIT
)paren
op_logical_and
(paren
id|cmd
op_ne
id|TIOCGICOUNT
)paren
)paren
(brace
r_if
c_cond
(paren
id|tty-&gt;flags
op_amp
(paren
l_int|1
op_lshift
id|TTY_IO_ERROR
)paren
)paren
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_return
id|ioctl_common
c_func
(paren
id|info
comma
id|cmd
comma
id|arg
)paren
suffix:semicolon
)brace
DECL|function|ioctl_common
r_int
id|ioctl_common
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_int
id|error
suffix:semicolon
r_struct
id|mgsl_icount
id|cnow
suffix:semicolon
multiline_comment|/* kernel counter temps */
r_struct
id|serial_icounter_struct
id|__user
op_star
id|p_cuser
suffix:semicolon
multiline_comment|/* user space */
r_void
id|__user
op_star
id|argp
op_assign
(paren
r_void
id|__user
op_star
)paren
id|arg
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|MGSL_IOCGPARAMS
suffix:colon
r_return
id|get_params
c_func
(paren
id|info
comma
id|argp
)paren
suffix:semicolon
r_case
id|MGSL_IOCSPARAMS
suffix:colon
r_return
id|set_params
c_func
(paren
id|info
comma
id|argp
)paren
suffix:semicolon
r_case
id|MGSL_IOCGTXIDLE
suffix:colon
r_return
id|get_txidle
c_func
(paren
id|info
comma
id|argp
)paren
suffix:semicolon
r_case
id|MGSL_IOCSTXIDLE
suffix:colon
r_return
id|set_txidle
c_func
(paren
id|info
comma
(paren
r_int
)paren
id|arg
)paren
suffix:semicolon
r_case
id|MGSL_IOCGIF
suffix:colon
r_return
id|get_interface
c_func
(paren
id|info
comma
id|argp
)paren
suffix:semicolon
r_case
id|MGSL_IOCSIF
suffix:colon
r_return
id|set_interface
c_func
(paren
id|info
comma
(paren
r_int
)paren
id|arg
)paren
suffix:semicolon
r_case
id|MGSL_IOCTXENABLE
suffix:colon
r_return
id|set_txenable
c_func
(paren
id|info
comma
(paren
r_int
)paren
id|arg
)paren
suffix:semicolon
r_case
id|MGSL_IOCRXENABLE
suffix:colon
r_return
id|set_rxenable
c_func
(paren
id|info
comma
(paren
r_int
)paren
id|arg
)paren
suffix:semicolon
r_case
id|MGSL_IOCTXABORT
suffix:colon
r_return
id|tx_abort
c_func
(paren
id|info
)paren
suffix:semicolon
r_case
id|MGSL_IOCGSTATS
suffix:colon
r_return
id|get_stats
c_func
(paren
id|info
comma
id|argp
)paren
suffix:semicolon
r_case
id|MGSL_IOCWAITEVENT
suffix:colon
r_return
id|wait_events
c_func
(paren
id|info
comma
id|argp
)paren
suffix:semicolon
r_case
id|TIOCMIWAIT
suffix:colon
r_return
id|modem_input_wait
c_func
(paren
id|info
comma
(paren
r_int
)paren
id|arg
)paren
suffix:semicolon
r_case
id|TIOCGICOUNT
suffix:colon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|cnow
op_assign
id|info-&gt;icount
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|p_cuser
op_assign
id|argp
suffix:semicolon
id|PUT_USER
c_func
(paren
id|error
comma
id|cnow.cts
comma
op_amp
id|p_cuser-&gt;cts
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_return
id|error
suffix:semicolon
id|PUT_USER
c_func
(paren
id|error
comma
id|cnow.dsr
comma
op_amp
id|p_cuser-&gt;dsr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_return
id|error
suffix:semicolon
id|PUT_USER
c_func
(paren
id|error
comma
id|cnow.rng
comma
op_amp
id|p_cuser-&gt;rng
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_return
id|error
suffix:semicolon
id|PUT_USER
c_func
(paren
id|error
comma
id|cnow.dcd
comma
op_amp
id|p_cuser-&gt;dcd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_return
id|error
suffix:semicolon
id|PUT_USER
c_func
(paren
id|error
comma
id|cnow.rx
comma
op_amp
id|p_cuser-&gt;rx
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_return
id|error
suffix:semicolon
id|PUT_USER
c_func
(paren
id|error
comma
id|cnow.tx
comma
op_amp
id|p_cuser-&gt;tx
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_return
id|error
suffix:semicolon
id|PUT_USER
c_func
(paren
id|error
comma
id|cnow.frame
comma
op_amp
id|p_cuser-&gt;frame
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_return
id|error
suffix:semicolon
id|PUT_USER
c_func
(paren
id|error
comma
id|cnow.overrun
comma
op_amp
id|p_cuser-&gt;overrun
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_return
id|error
suffix:semicolon
id|PUT_USER
c_func
(paren
id|error
comma
id|cnow.parity
comma
op_amp
id|p_cuser-&gt;parity
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_return
id|error
suffix:semicolon
id|PUT_USER
c_func
(paren
id|error
comma
id|cnow.brk
comma
op_amp
id|p_cuser-&gt;brk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_return
id|error
suffix:semicolon
id|PUT_USER
c_func
(paren
id|error
comma
id|cnow.buf_overrun
comma
op_amp
id|p_cuser-&gt;buf_overrun
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_return
id|error
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Set new termios settings&n; * &t;&n; * Arguments:&n; * &n; * &t;tty&t;&t;pointer to tty structure&n; * &t;termios&t;&t;pointer to buffer to hold returned old termios&n; */
DECL|function|mgslpc_set_termios
r_static
r_void
id|mgslpc_set_termios
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|termios
op_star
id|old_termios
)paren
(brace
id|MGSLPC_INFO
op_star
id|info
op_assign
(paren
id|MGSLPC_INFO
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):mgslpc_set_termios %s&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|tty-&gt;driver-&gt;name
)paren
suffix:semicolon
multiline_comment|/* just return if nothing has changed */
r_if
c_cond
(paren
(paren
id|tty-&gt;termios-&gt;c_cflag
op_eq
id|old_termios-&gt;c_cflag
)paren
op_logical_and
(paren
id|RELEVANT_IFLAG
c_func
(paren
id|tty-&gt;termios-&gt;c_iflag
)paren
op_eq
id|RELEVANT_IFLAG
c_func
(paren
id|old_termios-&gt;c_iflag
)paren
)paren
)paren
r_return
suffix:semicolon
id|mgslpc_change_params
c_func
(paren
id|info
)paren
suffix:semicolon
multiline_comment|/* Handle transition to B0 status */
r_if
c_cond
(paren
id|old_termios-&gt;c_cflag
op_amp
id|CBAUD
op_logical_and
op_logical_neg
(paren
id|tty-&gt;termios-&gt;c_cflag
op_amp
id|CBAUD
)paren
)paren
(brace
id|info-&gt;serial_signals
op_and_assign
op_complement
(paren
id|SerialSignal_RTS
op_plus
id|SerialSignal_DTR
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|set_signals
c_func
(paren
id|info
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* Handle transition away from B0 status */
r_if
c_cond
(paren
op_logical_neg
(paren
id|old_termios-&gt;c_cflag
op_amp
id|CBAUD
)paren
op_logical_and
id|tty-&gt;termios-&gt;c_cflag
op_amp
id|CBAUD
)paren
(brace
id|info-&gt;serial_signals
op_or_assign
id|SerialSignal_DTR
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|tty-&gt;termios-&gt;c_cflag
op_amp
id|CRTSCTS
)paren
op_logical_or
op_logical_neg
id|test_bit
c_func
(paren
id|TTY_THROTTLED
comma
op_amp
id|tty-&gt;flags
)paren
)paren
(brace
id|info-&gt;serial_signals
op_or_assign
id|SerialSignal_RTS
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|set_signals
c_func
(paren
id|info
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* Handle turning off CRTSCTS */
r_if
c_cond
(paren
id|old_termios-&gt;c_cflag
op_amp
id|CRTSCTS
op_logical_and
op_logical_neg
(paren
id|tty-&gt;termios-&gt;c_cflag
op_amp
id|CRTSCTS
)paren
)paren
(brace
id|tty-&gt;hw_stopped
op_assign
l_int|0
suffix:semicolon
id|tx_release
c_func
(paren
id|tty
)paren
suffix:semicolon
)brace
)brace
DECL|function|mgslpc_close
r_static
r_void
id|mgslpc_close
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
id|MGSLPC_INFO
op_star
id|info
op_assign
(paren
id|MGSLPC_INFO
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
id|mgslpc_paranoia_check
c_func
(paren
id|info
comma
id|tty-&gt;name
comma
l_string|&quot;mgslpc_close&quot;
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):mgslpc_close(%s) entry, count=%d&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
comma
id|info-&gt;count
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;count
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|tty_hung_up_p
c_func
(paren
id|filp
)paren
)paren
r_goto
id|cleanup
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tty-&gt;count
op_eq
l_int|1
)paren
op_logical_and
(paren
id|info-&gt;count
op_ne
l_int|1
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t; * tty-&gt;count is 1 and the tty structure will be freed.&n;&t;&t; * info-&gt;count should be one in this case.&n;&t;&t; * if it&squot;s not, correct it so that the port is shutdown.&n;&t;&t; */
id|printk
c_func
(paren
l_string|&quot;mgslpc_close: bad refcount; tty-&gt;count is 1, &quot;
l_string|&quot;info-&gt;count is %d&bslash;n&quot;
comma
id|info-&gt;count
)paren
suffix:semicolon
id|info-&gt;count
op_assign
l_int|1
suffix:semicolon
)brace
id|info-&gt;count
op_decrement
suffix:semicolon
multiline_comment|/* if at least one open remaining, leave hardware active */
r_if
c_cond
(paren
id|info-&gt;count
)paren
r_goto
id|cleanup
suffix:semicolon
id|info-&gt;flags
op_or_assign
id|ASYNC_CLOSING
suffix:semicolon
multiline_comment|/* set tty-&gt;closing to notify line discipline to &n;&t; * only process XON/XOFF characters. Only the N_TTY&n;&t; * discipline appears to use this (ppp does not).&n;&t; */
id|tty-&gt;closing
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* wait for transmit data to clear all layers */
r_if
c_cond
(paren
id|info-&gt;closing_wait
op_ne
id|ASYNC_CLOSING_WAIT_NONE
)paren
(brace
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):mgslpc_close(%s) calling tty_wait_until_sent&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
)paren
suffix:semicolon
id|tty_wait_until_sent
c_func
(paren
id|tty
comma
id|info-&gt;closing_wait
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|info-&gt;flags
op_amp
id|ASYNC_INITIALIZED
)paren
id|mgslpc_wait_until_sent
c_func
(paren
id|tty
comma
id|info-&gt;timeout
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tty-&gt;driver-&gt;flush_buffer
)paren
id|tty-&gt;driver
op_member_access_from_pointer
id|flush_buffer
c_func
(paren
id|tty
)paren
suffix:semicolon
id|ldisc_flush_buffer
c_func
(paren
id|tty
)paren
suffix:semicolon
id|shutdown
c_func
(paren
id|info
)paren
suffix:semicolon
id|tty-&gt;closing
op_assign
l_int|0
suffix:semicolon
id|info-&gt;tty
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;blocked_open
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;close_delay
)paren
(brace
id|msleep_interruptible
c_func
(paren
id|jiffies_to_msecs
c_func
(paren
id|info-&gt;close_delay
)paren
)paren
suffix:semicolon
)brace
id|wake_up_interruptible
c_func
(paren
op_amp
id|info-&gt;open_wait
)paren
suffix:semicolon
)brace
id|info-&gt;flags
op_and_assign
op_complement
(paren
id|ASYNC_NORMAL_ACTIVE
op_or
id|ASYNC_CLOSING
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|info-&gt;close_wait
)paren
suffix:semicolon
id|cleanup
suffix:colon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):mgslpc_close(%s) exit, count=%d&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|tty-&gt;driver-&gt;name
comma
id|info-&gt;count
)paren
suffix:semicolon
)brace
multiline_comment|/* Wait until the transmitter is empty.&n; */
DECL|function|mgslpc_wait_until_sent
r_static
r_void
id|mgslpc_wait_until_sent
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_int
id|timeout
)paren
(brace
id|MGSLPC_INFO
op_star
id|info
op_assign
(paren
id|MGSLPC_INFO
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_int
r_int
id|orig_jiffies
comma
id|char_time
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):mgslpc_wait_until_sent(%s) entry&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mgslpc_paranoia_check
c_func
(paren
id|info
comma
id|tty-&gt;name
comma
l_string|&quot;mgslpc_wait_until_sent&quot;
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|info-&gt;flags
op_amp
id|ASYNC_INITIALIZED
)paren
)paren
r_goto
m_exit
suffix:semicolon
id|orig_jiffies
op_assign
id|jiffies
suffix:semicolon
multiline_comment|/* Set check interval to 1/5 of estimated time to&n;&t; * send a character, and make it at least 1. The check&n;&t; * interval should also be less than the timeout.&n;&t; * Note: use tight timings here to satisfy the NIST-PCTS.&n;&t; */
r_if
c_cond
(paren
id|info-&gt;params.data_rate
)paren
(brace
id|char_time
op_assign
id|info-&gt;timeout
op_div
(paren
l_int|32
op_star
l_int|5
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|char_time
)paren
id|char_time
op_increment
suffix:semicolon
)brace
r_else
id|char_time
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|timeout
)paren
id|char_time
op_assign
id|min_t
c_func
(paren
r_int
r_int
comma
id|char_time
comma
id|timeout
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;params.mode
op_eq
id|MGSL_MODE_HDLC
)paren
(brace
r_while
c_loop
(paren
id|info-&gt;tx_active
)paren
(brace
id|msleep_interruptible
c_func
(paren
id|jiffies_to_msecs
c_func
(paren
id|char_time
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|timeout
op_logical_and
id|time_after
c_func
(paren
id|jiffies
comma
id|orig_jiffies
op_plus
id|timeout
)paren
)paren
r_break
suffix:semicolon
)brace
)brace
r_else
(brace
r_while
c_loop
(paren
(paren
id|info-&gt;tx_count
op_logical_or
id|info-&gt;tx_active
)paren
op_logical_and
id|info-&gt;tx_enabled
)paren
(brace
id|msleep_interruptible
c_func
(paren
id|jiffies_to_msecs
c_func
(paren
id|char_time
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|timeout
op_logical_and
id|time_after
c_func
(paren
id|jiffies
comma
id|orig_jiffies
op_plus
id|timeout
)paren
)paren
r_break
suffix:semicolon
)brace
)brace
m_exit
suffix:colon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):mgslpc_wait_until_sent(%s) exit&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
)paren
suffix:semicolon
)brace
multiline_comment|/* Called by tty_hangup() when a hangup is signaled.&n; * This is the same as closing all open files for the port.&n; */
DECL|function|mgslpc_hangup
r_static
r_void
id|mgslpc_hangup
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
id|MGSLPC_INFO
op_star
id|info
op_assign
(paren
id|MGSLPC_INFO
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):mgslpc_hangup(%s)&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mgslpc_paranoia_check
c_func
(paren
id|info
comma
id|tty-&gt;name
comma
l_string|&quot;mgslpc_hangup&quot;
)paren
)paren
r_return
suffix:semicolon
id|mgslpc_flush_buffer
c_func
(paren
id|tty
)paren
suffix:semicolon
id|shutdown
c_func
(paren
id|info
)paren
suffix:semicolon
id|info-&gt;count
op_assign
l_int|0
suffix:semicolon
id|info-&gt;flags
op_and_assign
op_complement
id|ASYNC_NORMAL_ACTIVE
suffix:semicolon
id|info-&gt;tty
op_assign
l_int|NULL
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|info-&gt;open_wait
)paren
suffix:semicolon
)brace
multiline_comment|/* Block the current process until the specified port&n; * is ready to be opened.&n; */
DECL|function|block_til_ready
r_static
r_int
id|block_til_ready
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|filp
comma
id|MGSLPC_INFO
op_star
id|info
)paren
(brace
id|DECLARE_WAITQUEUE
c_func
(paren
id|wait
comma
id|current
)paren
suffix:semicolon
r_int
id|retval
suffix:semicolon
r_int
id|do_clocal
op_assign
l_int|0
comma
id|extra_count
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):block_til_ready on %s&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|tty-&gt;driver-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|filp-&gt;f_flags
op_amp
id|O_NONBLOCK
op_logical_or
id|tty-&gt;flags
op_amp
(paren
l_int|1
op_lshift
id|TTY_IO_ERROR
)paren
)paren
(brace
multiline_comment|/* nonblock mode is set or port is not enabled */
multiline_comment|/* just verify that callout device is not active */
id|info-&gt;flags
op_or_assign
id|ASYNC_NORMAL_ACTIVE
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tty-&gt;termios-&gt;c_cflag
op_amp
id|CLOCAL
)paren
id|do_clocal
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Wait for carrier detect and the line to become&n;&t; * free (i.e., not in use by the callout).  While we are in&n;&t; * this loop, info-&gt;count is dropped by one, so that&n;&t; * mgslpc_close() knows when to free things.  We restore it upon&n;&t; * exit, either normal or abnormal.&n;&t; */
id|retval
op_assign
l_int|0
suffix:semicolon
id|add_wait_queue
c_func
(paren
op_amp
id|info-&gt;open_wait
comma
op_amp
id|wait
)paren
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):block_til_ready before block on %s count=%d&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|tty-&gt;driver-&gt;name
comma
id|info-&gt;count
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tty_hung_up_p
c_func
(paren
id|filp
)paren
)paren
(brace
id|extra_count
op_assign
l_int|1
suffix:semicolon
id|info-&gt;count
op_decrement
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|info-&gt;blocked_open
op_increment
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
r_if
c_cond
(paren
(paren
id|tty-&gt;termios-&gt;c_cflag
op_amp
id|CBAUD
)paren
)paren
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|info-&gt;serial_signals
op_or_assign
id|SerialSignal_RTS
op_plus
id|SerialSignal_DTR
suffix:semicolon
id|set_signals
c_func
(paren
id|info
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tty_hung_up_p
c_func
(paren
id|filp
)paren
op_logical_or
op_logical_neg
(paren
id|info-&gt;flags
op_amp
id|ASYNC_INITIALIZED
)paren
)paren
(brace
id|retval
op_assign
(paren
id|info-&gt;flags
op_amp
id|ASYNC_HUP_NOTIFY
)paren
ques
c_cond
op_minus
id|EAGAIN
suffix:colon
op_minus
id|ERESTARTSYS
suffix:semicolon
r_break
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|get_signals
c_func
(paren
id|info
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|info-&gt;flags
op_amp
id|ASYNC_CLOSING
)paren
op_logical_and
(paren
id|do_clocal
op_logical_or
(paren
id|info-&gt;serial_signals
op_amp
id|SerialSignal_DCD
)paren
)paren
)paren
(brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
id|retval
op_assign
op_minus
id|ERESTARTSYS
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):block_til_ready blocking on %s count=%d&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|tty-&gt;driver-&gt;name
comma
id|info-&gt;count
)paren
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
)brace
id|set_current_state
c_func
(paren
id|TASK_RUNNING
)paren
suffix:semicolon
id|remove_wait_queue
c_func
(paren
op_amp
id|info-&gt;open_wait
comma
op_amp
id|wait
)paren
suffix:semicolon
r_if
c_cond
(paren
id|extra_count
)paren
id|info-&gt;count
op_increment
suffix:semicolon
id|info-&gt;blocked_open
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):block_til_ready after blocking on %s count=%d&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|tty-&gt;driver-&gt;name
comma
id|info-&gt;count
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
id|info-&gt;flags
op_or_assign
id|ASYNC_NORMAL_ACTIVE
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
DECL|function|mgslpc_open
r_static
r_int
id|mgslpc_open
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
id|MGSLPC_INFO
op_star
id|info
suffix:semicolon
r_int
id|retval
comma
id|line
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/* verify range of specified line number */
id|line
op_assign
id|tty-&gt;index
suffix:semicolon
r_if
c_cond
(paren
(paren
id|line
OL
l_int|0
)paren
op_logical_or
(paren
id|line
op_ge
id|mgslpc_device_count
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s(%d):mgslpc_open with invalid line #%d.&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|line
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* find the info structure for the specified line */
id|info
op_assign
id|mgslpc_device_list
suffix:semicolon
r_while
c_loop
(paren
id|info
op_logical_and
id|info-&gt;line
op_ne
id|line
)paren
(brace
id|info
op_assign
id|info-&gt;next_device
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mgslpc_paranoia_check
c_func
(paren
id|info
comma
id|tty-&gt;name
comma
l_string|&quot;mgslpc_open&quot;
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|tty-&gt;driver_data
op_assign
id|info
suffix:semicolon
id|info-&gt;tty
op_assign
id|tty
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):mgslpc_open(%s), old ref count = %d&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|tty-&gt;driver-&gt;name
comma
id|info-&gt;count
)paren
suffix:semicolon
multiline_comment|/* If port is closing, signal caller to try again */
r_if
c_cond
(paren
id|tty_hung_up_p
c_func
(paren
id|filp
)paren
op_logical_or
id|info-&gt;flags
op_amp
id|ASYNC_CLOSING
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;flags
op_amp
id|ASYNC_CLOSING
)paren
id|interruptible_sleep_on
c_func
(paren
op_amp
id|info-&gt;close_wait
)paren
suffix:semicolon
id|retval
op_assign
(paren
(paren
id|info-&gt;flags
op_amp
id|ASYNC_HUP_NOTIFY
)paren
ques
c_cond
op_minus
id|EAGAIN
suffix:colon
op_minus
id|ERESTARTSYS
)paren
suffix:semicolon
r_goto
id|cleanup
suffix:semicolon
)brace
id|info-&gt;tty-&gt;low_latency
op_assign
(paren
id|info-&gt;flags
op_amp
id|ASYNC_LOW_LATENCY
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;netlock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;netcount
)paren
(brace
id|retval
op_assign
op_minus
id|EBUSY
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;netlock
comma
id|flags
)paren
suffix:semicolon
r_goto
id|cleanup
suffix:semicolon
)brace
id|info-&gt;count
op_increment
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;netlock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;count
op_eq
l_int|1
)paren
(brace
multiline_comment|/* 1st open on this device, init hardware */
id|retval
op_assign
id|startup
c_func
(paren
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
OL
l_int|0
)paren
r_goto
id|cleanup
suffix:semicolon
)brace
id|retval
op_assign
id|block_til_ready
c_func
(paren
id|tty
comma
id|filp
comma
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):block_til_ready(%s) returned %d&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
comma
id|retval
)paren
suffix:semicolon
r_goto
id|cleanup
suffix:semicolon
)brace
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):mgslpc_open(%s) success&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
)paren
suffix:semicolon
id|retval
op_assign
l_int|0
suffix:semicolon
id|cleanup
suffix:colon
r_if
c_cond
(paren
id|retval
)paren
(brace
r_if
c_cond
(paren
id|tty-&gt;count
op_eq
l_int|1
)paren
id|info-&gt;tty
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* tty layer will release tty struct */
r_if
c_cond
(paren
id|info-&gt;count
)paren
(brace
id|info-&gt;count
op_decrement
suffix:semicolon
)brace
)brace
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * /proc fs routines....&n; */
DECL|function|line_info
r_static
r_inline
r_int
id|line_info
c_func
(paren
r_char
op_star
id|buf
comma
id|MGSLPC_INFO
op_star
id|info
)paren
(brace
r_char
id|stat_buf
(braket
l_int|30
)braket
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|ret
op_assign
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%s:io:%04X irq:%d&quot;
comma
id|info-&gt;device_name
comma
id|info-&gt;io_base
comma
id|info-&gt;irq_level
)paren
suffix:semicolon
multiline_comment|/* output current serial signal states */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|get_signals
c_func
(paren
id|info
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|stat_buf
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|stat_buf
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;serial_signals
op_amp
id|SerialSignal_RTS
)paren
id|strcat
c_func
(paren
id|stat_buf
comma
l_string|&quot;|RTS&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;serial_signals
op_amp
id|SerialSignal_CTS
)paren
id|strcat
c_func
(paren
id|stat_buf
comma
l_string|&quot;|CTS&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;serial_signals
op_amp
id|SerialSignal_DTR
)paren
id|strcat
c_func
(paren
id|stat_buf
comma
l_string|&quot;|DTR&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;serial_signals
op_amp
id|SerialSignal_DSR
)paren
id|strcat
c_func
(paren
id|stat_buf
comma
l_string|&quot;|DSR&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;serial_signals
op_amp
id|SerialSignal_DCD
)paren
id|strcat
c_func
(paren
id|stat_buf
comma
l_string|&quot;|CD&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;serial_signals
op_amp
id|SerialSignal_RI
)paren
id|strcat
c_func
(paren
id|stat_buf
comma
l_string|&quot;|RI&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;params.mode
op_eq
id|MGSL_MODE_HDLC
)paren
(brace
id|ret
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|ret
comma
l_string|&quot; HDLC txok:%d rxok:%d&quot;
comma
id|info-&gt;icount.txok
comma
id|info-&gt;icount.rxok
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;icount.txunder
)paren
id|ret
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|ret
comma
l_string|&quot; txunder:%d&quot;
comma
id|info-&gt;icount.txunder
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;icount.txabort
)paren
id|ret
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|ret
comma
l_string|&quot; txabort:%d&quot;
comma
id|info-&gt;icount.txabort
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;icount.rxshort
)paren
id|ret
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|ret
comma
l_string|&quot; rxshort:%d&quot;
comma
id|info-&gt;icount.rxshort
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;icount.rxlong
)paren
id|ret
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|ret
comma
l_string|&quot; rxlong:%d&quot;
comma
id|info-&gt;icount.rxlong
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;icount.rxover
)paren
id|ret
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|ret
comma
l_string|&quot; rxover:%d&quot;
comma
id|info-&gt;icount.rxover
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;icount.rxcrc
)paren
id|ret
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|ret
comma
l_string|&quot; rxcrc:%d&quot;
comma
id|info-&gt;icount.rxcrc
)paren
suffix:semicolon
)brace
r_else
(brace
id|ret
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|ret
comma
l_string|&quot; ASYNC tx:%d rx:%d&quot;
comma
id|info-&gt;icount.tx
comma
id|info-&gt;icount.rx
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;icount.frame
)paren
id|ret
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|ret
comma
l_string|&quot; fe:%d&quot;
comma
id|info-&gt;icount.frame
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;icount.parity
)paren
id|ret
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|ret
comma
l_string|&quot; pe:%d&quot;
comma
id|info-&gt;icount.parity
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;icount.brk
)paren
id|ret
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|ret
comma
l_string|&quot; brk:%d&quot;
comma
id|info-&gt;icount.brk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;icount.overrun
)paren
id|ret
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|ret
comma
l_string|&quot; oe:%d&quot;
comma
id|info-&gt;icount.overrun
)paren
suffix:semicolon
)brace
multiline_comment|/* Append serial signal status to end */
id|ret
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|ret
comma
l_string|&quot; %s&bslash;n&quot;
comma
id|stat_buf
op_plus
l_int|1
)paren
suffix:semicolon
id|ret
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|ret
comma
l_string|&quot;txactive=%d bh_req=%d bh_run=%d pending_bh=%x&bslash;n&quot;
comma
id|info-&gt;tx_active
comma
id|info-&gt;bh_requested
comma
id|info-&gt;bh_running
comma
id|info-&gt;pending_bh
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* Called to print information about devices&n; */
DECL|function|mgslpc_read_proc
r_static
r_int
id|mgslpc_read_proc
c_func
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
r_int
id|len
op_assign
l_int|0
comma
id|l
suffix:semicolon
id|off_t
id|begin
op_assign
l_int|0
suffix:semicolon
id|MGSLPC_INFO
op_star
id|info
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
comma
l_string|&quot;synclink driver:%s&bslash;n&quot;
comma
id|driver_version
)paren
suffix:semicolon
id|info
op_assign
id|mgslpc_device_list
suffix:semicolon
r_while
c_loop
(paren
id|info
)paren
(brace
id|l
op_assign
id|line_info
c_func
(paren
id|page
op_plus
id|len
comma
id|info
)paren
suffix:semicolon
id|len
op_add_assign
id|l
suffix:semicolon
r_if
c_cond
(paren
id|len
op_plus
id|begin
OG
id|off
op_plus
id|count
)paren
r_goto
id|done
suffix:semicolon
r_if
c_cond
(paren
id|len
op_plus
id|begin
OL
id|off
)paren
(brace
id|begin
op_add_assign
id|len
suffix:semicolon
id|len
op_assign
l_int|0
suffix:semicolon
)brace
id|info
op_assign
id|info-&gt;next_device
suffix:semicolon
)brace
op_star
id|eof
op_assign
l_int|1
suffix:semicolon
id|done
suffix:colon
r_if
c_cond
(paren
id|off
op_ge
id|len
op_plus
id|begin
)paren
r_return
l_int|0
suffix:semicolon
op_star
id|start
op_assign
id|page
op_plus
(paren
id|off
op_minus
id|begin
)paren
suffix:semicolon
r_return
(paren
(paren
id|count
OL
id|begin
op_plus
id|len
op_minus
id|off
)paren
ques
c_cond
id|count
suffix:colon
id|begin
op_plus
id|len
op_minus
id|off
)paren
suffix:semicolon
)brace
DECL|function|rx_alloc_buffers
r_int
id|rx_alloc_buffers
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
)paren
(brace
multiline_comment|/* each buffer has header and data */
id|info-&gt;rx_buf_size
op_assign
r_sizeof
(paren
id|RXBUF
)paren
op_plus
id|info-&gt;max_frame_size
suffix:semicolon
multiline_comment|/* calculate total allocation size for 8 buffers */
id|info-&gt;rx_buf_total_size
op_assign
id|info-&gt;rx_buf_size
op_star
l_int|8
suffix:semicolon
multiline_comment|/* limit total allocated memory */
r_if
c_cond
(paren
id|info-&gt;rx_buf_total_size
OG
l_int|0x10000
)paren
id|info-&gt;rx_buf_total_size
op_assign
l_int|0x10000
suffix:semicolon
multiline_comment|/* calculate number of buffers */
id|info-&gt;rx_buf_count
op_assign
id|info-&gt;rx_buf_total_size
op_div
id|info-&gt;rx_buf_size
suffix:semicolon
id|info-&gt;rx_buf
op_assign
id|kmalloc
c_func
(paren
id|info-&gt;rx_buf_total_size
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;rx_buf
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|rx_reset_buffers
c_func
(paren
id|info
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|rx_free_buffers
r_void
id|rx_free_buffers
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;rx_buf
)paren
id|kfree
c_func
(paren
id|info-&gt;rx_buf
)paren
suffix:semicolon
id|info-&gt;rx_buf
op_assign
l_int|NULL
suffix:semicolon
)brace
DECL|function|claim_resources
r_int
id|claim_resources
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
)paren
(brace
r_if
c_cond
(paren
id|rx_alloc_buffers
c_func
(paren
id|info
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Cant allocate rx buffer %s&bslash;n&quot;
comma
id|info-&gt;device_name
)paren
suffix:semicolon
id|release_resources
c_func
(paren
id|info
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|release_resources
r_void
id|release_resources
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
)paren
(brace
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;release_resources(%s)&bslash;n&quot;
comma
id|info-&gt;device_name
)paren
suffix:semicolon
id|rx_free_buffers
c_func
(paren
id|info
)paren
suffix:semicolon
)brace
multiline_comment|/* Add the specified device instance data structure to the&n; * global linked list of devices and increment the device count.&n; * &t;&n; * Arguments:&t;&t;info&t;pointer to device instance data&n; */
DECL|function|mgslpc_add_device
r_void
id|mgslpc_add_device
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
)paren
(brace
id|info-&gt;next_device
op_assign
l_int|NULL
suffix:semicolon
id|info-&gt;line
op_assign
id|mgslpc_device_count
suffix:semicolon
id|sprintf
c_func
(paren
id|info-&gt;device_name
comma
l_string|&quot;ttySLP%d&quot;
comma
id|info-&gt;line
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;line
OL
id|MAX_DEVICE_COUNT
)paren
(brace
r_if
c_cond
(paren
id|maxframe
(braket
id|info-&gt;line
)braket
)paren
id|info-&gt;max_frame_size
op_assign
id|maxframe
(braket
id|info-&gt;line
)braket
suffix:semicolon
id|info-&gt;dosyncppp
op_assign
id|dosyncppp
(braket
id|info-&gt;line
)braket
suffix:semicolon
)brace
id|mgslpc_device_count
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mgslpc_device_list
)paren
id|mgslpc_device_list
op_assign
id|info
suffix:semicolon
r_else
(brace
id|MGSLPC_INFO
op_star
id|current_dev
op_assign
id|mgslpc_device_list
suffix:semicolon
r_while
c_loop
(paren
id|current_dev-&gt;next_device
)paren
(brace
id|current_dev
op_assign
id|current_dev-&gt;next_device
suffix:semicolon
)brace
id|current_dev-&gt;next_device
op_assign
id|info
suffix:semicolon
)brace
r_if
c_cond
(paren
id|info-&gt;max_frame_size
OL
l_int|4096
)paren
id|info-&gt;max_frame_size
op_assign
l_int|4096
suffix:semicolon
r_else
r_if
c_cond
(paren
id|info-&gt;max_frame_size
OG
l_int|65535
)paren
id|info-&gt;max_frame_size
op_assign
l_int|65535
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;SyncLink PC Card %s:IO=%04X IRQ=%d&bslash;n&quot;
comma
id|info-&gt;device_name
comma
id|info-&gt;io_base
comma
id|info-&gt;irq_level
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_HDLC
id|hdlcdev_init
c_func
(paren
id|info
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|mgslpc_remove_device
r_void
id|mgslpc_remove_device
c_func
(paren
id|MGSLPC_INFO
op_star
id|remove_info
)paren
(brace
id|MGSLPC_INFO
op_star
id|info
op_assign
id|mgslpc_device_list
suffix:semicolon
id|MGSLPC_INFO
op_star
id|last
op_assign
l_int|NULL
suffix:semicolon
r_while
c_loop
(paren
id|info
)paren
(brace
r_if
c_cond
(paren
id|info
op_eq
id|remove_info
)paren
(brace
r_if
c_cond
(paren
id|last
)paren
id|last-&gt;next_device
op_assign
id|info-&gt;next_device
suffix:semicolon
r_else
id|mgslpc_device_list
op_assign
id|info-&gt;next_device
suffix:semicolon
macro_line|#ifdef CONFIG_HDLC
id|hdlcdev_exit
c_func
(paren
id|info
)paren
suffix:semicolon
macro_line|#endif
id|release_resources
c_func
(paren
id|info
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|info
)paren
suffix:semicolon
id|mgslpc_device_count
op_decrement
suffix:semicolon
r_return
suffix:semicolon
)brace
id|last
op_assign
id|info
suffix:semicolon
id|info
op_assign
id|info-&gt;next_device
suffix:semicolon
)brace
)brace
DECL|variable|mgslpc_driver
r_static
r_struct
id|pcmcia_driver
id|mgslpc_driver
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|drv
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;synclink_cs&quot;
comma
)brace
comma
dot
id|attach
op_assign
id|mgslpc_attach
comma
dot
id|detach
op_assign
id|mgslpc_detach
comma
)brace
suffix:semicolon
DECL|variable|mgslpc_ops
r_static
r_struct
id|tty_operations
id|mgslpc_ops
op_assign
(brace
dot
id|open
op_assign
id|mgslpc_open
comma
dot
id|close
op_assign
id|mgslpc_close
comma
dot
id|write
op_assign
id|mgslpc_write
comma
dot
id|put_char
op_assign
id|mgslpc_put_char
comma
dot
id|flush_chars
op_assign
id|mgslpc_flush_chars
comma
dot
id|write_room
op_assign
id|mgslpc_write_room
comma
dot
id|chars_in_buffer
op_assign
id|mgslpc_chars_in_buffer
comma
dot
id|flush_buffer
op_assign
id|mgslpc_flush_buffer
comma
dot
id|ioctl
op_assign
id|mgslpc_ioctl
comma
dot
id|throttle
op_assign
id|mgslpc_throttle
comma
dot
id|unthrottle
op_assign
id|mgslpc_unthrottle
comma
dot
id|send_xchar
op_assign
id|mgslpc_send_xchar
comma
dot
id|break_ctl
op_assign
id|mgslpc_break
comma
dot
id|wait_until_sent
op_assign
id|mgslpc_wait_until_sent
comma
dot
id|read_proc
op_assign
id|mgslpc_read_proc
comma
dot
id|set_termios
op_assign
id|mgslpc_set_termios
comma
dot
id|stop
op_assign
id|tx_pause
comma
dot
id|start
op_assign
id|tx_release
comma
dot
id|hangup
op_assign
id|mgslpc_hangup
comma
dot
id|tiocmget
op_assign
id|tiocmget
comma
dot
id|tiocmset
op_assign
id|tiocmset
comma
)brace
suffix:semicolon
DECL|function|synclink_cs_cleanup
r_static
r_void
id|synclink_cs_cleanup
c_func
(paren
r_void
)paren
(brace
r_int
id|rc
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Unloading %s: version %s&bslash;n&quot;
comma
id|driver_name
comma
id|driver_version
)paren
suffix:semicolon
r_while
c_loop
(paren
id|mgslpc_device_list
)paren
(brace
id|mgslpc_remove_device
c_func
(paren
id|mgslpc_device_list
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|serial_driver
)paren
(brace
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|tty_unregister_driver
c_func
(paren
id|serial_driver
)paren
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d) failed to unregister tty driver err=%d&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|rc
)paren
suffix:semicolon
id|put_tty_driver
c_func
(paren
id|serial_driver
)paren
suffix:semicolon
)brace
id|pcmcia_unregister_driver
c_func
(paren
op_amp
id|mgslpc_driver
)paren
suffix:semicolon
multiline_comment|/* XXX: this really needs to move into generic code.. */
r_while
c_loop
(paren
id|dev_list
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|dev_list-&gt;state
op_amp
id|DEV_CONFIG
)paren
id|mgslpc_release
c_func
(paren
(paren
id|u_long
)paren
id|dev_list
)paren
suffix:semicolon
id|mgslpc_detach
c_func
(paren
id|dev_list
)paren
suffix:semicolon
)brace
)brace
DECL|function|synclink_cs_init
r_static
r_int
id|__init
id|synclink_cs_init
c_func
(paren
r_void
)paren
(brace
r_int
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|break_on_load
)paren
(brace
id|mgslpc_get_text_ptr
c_func
(paren
)paren
suffix:semicolon
id|BREAKPOINT
c_func
(paren
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;%s %s&bslash;n&quot;
comma
id|driver_name
comma
id|driver_version
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|pcmcia_register_driver
c_func
(paren
op_amp
id|mgslpc_driver
)paren
)paren
OL
l_int|0
)paren
r_return
id|rc
suffix:semicolon
id|serial_driver
op_assign
id|alloc_tty_driver
c_func
(paren
id|MAX_DEVICE_COUNT
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|serial_driver
)paren
(brace
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
multiline_comment|/* Initialize the tty_driver structure */
id|serial_driver-&gt;owner
op_assign
id|THIS_MODULE
suffix:semicolon
id|serial_driver-&gt;driver_name
op_assign
l_string|&quot;synclink_cs&quot;
suffix:semicolon
id|serial_driver-&gt;name
op_assign
l_string|&quot;ttySLP&quot;
suffix:semicolon
id|serial_driver-&gt;major
op_assign
id|ttymajor
suffix:semicolon
id|serial_driver-&gt;minor_start
op_assign
l_int|64
suffix:semicolon
id|serial_driver-&gt;type
op_assign
id|TTY_DRIVER_TYPE_SERIAL
suffix:semicolon
id|serial_driver-&gt;subtype
op_assign
id|SERIAL_TYPE_NORMAL
suffix:semicolon
id|serial_driver-&gt;init_termios
op_assign
id|tty_std_termios
suffix:semicolon
id|serial_driver-&gt;init_termios.c_cflag
op_assign
id|B9600
op_or
id|CS8
op_or
id|CREAD
op_or
id|HUPCL
op_or
id|CLOCAL
suffix:semicolon
id|serial_driver-&gt;flags
op_assign
id|TTY_DRIVER_REAL_RAW
suffix:semicolon
id|tty_set_operations
c_func
(paren
id|serial_driver
comma
op_amp
id|mgslpc_ops
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|tty_register_driver
c_func
(paren
id|serial_driver
)paren
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s(%d):Couldn&squot;t register serial driver&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
)paren
suffix:semicolon
id|put_tty_driver
c_func
(paren
id|serial_driver
)paren
suffix:semicolon
id|serial_driver
op_assign
l_int|NULL
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;%s %s, tty major#%d&bslash;n&quot;
comma
id|driver_name
comma
id|driver_version
comma
id|serial_driver-&gt;major
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|error
suffix:colon
id|synclink_cs_cleanup
c_func
(paren
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|synclink_cs_exit
r_static
r_void
id|__exit
id|synclink_cs_exit
c_func
(paren
r_void
)paren
(brace
id|synclink_cs_cleanup
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|variable|synclink_cs_init
id|module_init
c_func
(paren
id|synclink_cs_init
)paren
suffix:semicolon
DECL|variable|synclink_cs_exit
id|module_exit
c_func
(paren
id|synclink_cs_exit
)paren
suffix:semicolon
DECL|function|mgslpc_set_rate
r_static
r_void
id|mgslpc_set_rate
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
comma
r_int
r_char
id|channel
comma
r_int
r_int
id|rate
)paren
(brace
r_int
r_int
id|M
comma
id|N
suffix:semicolon
r_int
r_char
id|val
suffix:semicolon
multiline_comment|/* note:standard BRG mode is broken in V3.2 chip &n;&t; * so enhanced mode is always used &n;&t; */
r_if
c_cond
(paren
id|rate
)paren
(brace
id|N
op_assign
l_int|3686400
op_div
id|rate
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|N
)paren
id|N
op_assign
l_int|1
suffix:semicolon
id|N
op_rshift_assign
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|M
op_assign
l_int|1
suffix:semicolon
id|N
OG
l_int|64
op_logical_and
id|M
OL
l_int|16
suffix:semicolon
id|M
op_increment
)paren
id|N
op_rshift_assign
l_int|1
suffix:semicolon
id|N
op_decrement
suffix:semicolon
multiline_comment|/* BGR[5..0] = N&n;&t;&t; * BGR[9..6] = M&n;&t;&t; * BGR[7..0] contained in BGR register&n;&t;&t; * BGR[9..8] contained in CCR2[7..6]&n;&t;&t; * divisor = (N+1)*2^M&n;&t;&t; *&n;&t;&t; * Note: M *must* not be zero (causes asymetric duty cycle)&n;&t;&t; */
id|write_reg
c_func
(paren
id|info
comma
(paren
r_int
r_char
)paren
(paren
id|channel
op_plus
id|BGR
)paren
comma
(paren
r_int
r_char
)paren
(paren
(paren
id|M
op_lshift
l_int|6
)paren
op_plus
id|N
)paren
)paren
suffix:semicolon
id|val
op_assign
id|read_reg
c_func
(paren
id|info
comma
(paren
r_int
r_char
)paren
(paren
id|channel
op_plus
id|CCR2
)paren
)paren
op_amp
l_int|0x3f
suffix:semicolon
id|val
op_or_assign
(paren
(paren
id|M
op_lshift
l_int|4
)paren
op_amp
l_int|0xc0
)paren
suffix:semicolon
id|write_reg
c_func
(paren
id|info
comma
(paren
r_int
r_char
)paren
(paren
id|channel
op_plus
id|CCR2
)paren
comma
id|val
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Enabled the AUX clock output at the specified frequency.&n; */
DECL|function|enable_auxclk
r_static
r_void
id|enable_auxclk
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
)paren
(brace
r_int
r_char
id|val
suffix:semicolon
multiline_comment|/* MODE&n;&t; *&n;&t; * 07..06  MDS[1..0] 10 = transparent HDLC mode&n;&t; * 05      ADM Address Mode, 0 = no addr recognition&n;&t; * 04      TMD Timer Mode, 0 = external&n;&t; * 03      RAC Receiver Active, 0 = inactive&n;&t; * 02      RTS 0=RTS active during xmit, 1=RTS always active&n;&t; * 01      TRS Timer Resolution, 1=512&n;&t; * 00      TLP Test Loop, 0 = no loop&n;&t; *&n;&t; * 1000 0010&n;&t; */
id|val
op_assign
l_int|0x82
suffix:semicolon
multiline_comment|/* channel B RTS is used to enable AUXCLK driver on SP505 */
r_if
c_cond
(paren
id|info-&gt;params.mode
op_eq
id|MGSL_MODE_HDLC
op_logical_and
id|info-&gt;params.clock_speed
)paren
id|val
op_or_assign
id|BIT2
suffix:semicolon
id|write_reg
c_func
(paren
id|info
comma
id|CHB
op_plus
id|MODE
comma
id|val
)paren
suffix:semicolon
multiline_comment|/* CCR0&n;&t; *&n;&t; * 07      PU Power Up, 1=active, 0=power down&n;&t; * 06      MCE Master Clock Enable, 1=enabled&n;&t; * 05      Reserved, 0&n;&t; * 04..02  SC[2..0] Encoding&n;&t; * 01..00  SM[1..0] Serial Mode, 00=HDLC&n;&t; *&n;&t; * 11000000&n;&t; */
id|write_reg
c_func
(paren
id|info
comma
id|CHB
op_plus
id|CCR0
comma
l_int|0xc0
)paren
suffix:semicolon
multiline_comment|/* CCR1&n;&t; *&n;&t; * 07      SFLG Shared Flag, 0 = disable shared flags&n;&t; * 06      GALP Go Active On Loop, 0 = not used&n;&t; * 05      GLP Go On Loop, 0 = not used&n;&t; * 04      ODS Output Driver Select, 1=TxD is push-pull output&n;&t; * 03      ITF Interframe Time Fill, 0=mark, 1=flag&n;&t; * 02..00  CM[2..0] Clock Mode&n;&t; *&n;&t; * 0001 0111&n;&t; */
id|write_reg
c_func
(paren
id|info
comma
id|CHB
op_plus
id|CCR1
comma
l_int|0x17
)paren
suffix:semicolon
multiline_comment|/* CCR2 (Channel B)&n;&t; *&n;&t; * 07..06  BGR[9..8] Baud rate bits 9..8&n;&t; * 05      BDF Baud rate divisor factor, 0=1, 1=BGR value&n;&t; * 04      SSEL Clock source select, 1=submode b&n;&t; * 03      TOE 0=TxCLK is input, 1=TxCLK is output&n;&t; * 02      RWX Read/Write Exchange 0=disabled&n;&t; * 01      C32, CRC select, 0=CRC-16, 1=CRC-32&n;&t; * 00      DIV, data inversion 0=disabled, 1=enabled&n;&t; *&n;&t; * 0011 1000&n;&t; */
r_if
c_cond
(paren
id|info-&gt;params.mode
op_eq
id|MGSL_MODE_HDLC
op_logical_and
id|info-&gt;params.clock_speed
)paren
id|write_reg
c_func
(paren
id|info
comma
id|CHB
op_plus
id|CCR2
comma
l_int|0x38
)paren
suffix:semicolon
r_else
id|write_reg
c_func
(paren
id|info
comma
id|CHB
op_plus
id|CCR2
comma
l_int|0x30
)paren
suffix:semicolon
multiline_comment|/* CCR4&n;&t; *&n;&t; * 07      MCK4 Master Clock Divide by 4, 1=enabled&n;&t; * 06      EBRG Enhanced Baud Rate Generator Mode, 1=enabled&n;&t; * 05      TST1 Test Pin, 0=normal operation&n;&t; * 04      ICD Ivert Carrier Detect, 1=enabled (active low)&n;&t; * 03..02  Reserved, must be 0&n;&t; * 01..00  RFT[1..0] RxFIFO Threshold 00=32 bytes&n;&t; *&n;&t; * 0101 0000&n;&t; */
id|write_reg
c_func
(paren
id|info
comma
id|CHB
op_plus
id|CCR4
comma
l_int|0x50
)paren
suffix:semicolon
multiline_comment|/* if auxclk not enabled, set internal BRG so&n;&t; * CTS transitions can be detected (requires TxC)&n;&t; */
r_if
c_cond
(paren
id|info-&gt;params.mode
op_eq
id|MGSL_MODE_HDLC
op_logical_and
id|info-&gt;params.clock_speed
)paren
id|mgslpc_set_rate
c_func
(paren
id|info
comma
id|CHB
comma
id|info-&gt;params.clock_speed
)paren
suffix:semicolon
r_else
id|mgslpc_set_rate
c_func
(paren
id|info
comma
id|CHB
comma
l_int|921600
)paren
suffix:semicolon
)brace
DECL|function|loopback_enable
r_static
r_void
id|loopback_enable
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
)paren
(brace
r_int
r_char
id|val
suffix:semicolon
multiline_comment|/* CCR1:02..00  CM[2..0] Clock Mode = 111 (clock mode 7) */
id|val
op_assign
id|read_reg
c_func
(paren
id|info
comma
id|CHA
op_plus
id|CCR1
)paren
op_or
(paren
id|BIT2
op_plus
id|BIT1
op_plus
id|BIT0
)paren
suffix:semicolon
id|write_reg
c_func
(paren
id|info
comma
id|CHA
op_plus
id|CCR1
comma
id|val
)paren
suffix:semicolon
multiline_comment|/* CCR2:04 SSEL Clock source select, 1=submode b */
id|val
op_assign
id|read_reg
c_func
(paren
id|info
comma
id|CHA
op_plus
id|CCR2
)paren
op_or
(paren
id|BIT4
op_plus
id|BIT5
)paren
suffix:semicolon
id|write_reg
c_func
(paren
id|info
comma
id|CHA
op_plus
id|CCR2
comma
id|val
)paren
suffix:semicolon
multiline_comment|/* set LinkSpeed if available, otherwise default to 2Mbps */
r_if
c_cond
(paren
id|info-&gt;params.clock_speed
)paren
id|mgslpc_set_rate
c_func
(paren
id|info
comma
id|CHA
comma
id|info-&gt;params.clock_speed
)paren
suffix:semicolon
r_else
id|mgslpc_set_rate
c_func
(paren
id|info
comma
id|CHA
comma
l_int|1843200
)paren
suffix:semicolon
multiline_comment|/* MODE:00 TLP Test Loop, 1=loopback enabled */
id|val
op_assign
id|read_reg
c_func
(paren
id|info
comma
id|CHA
op_plus
id|MODE
)paren
op_or
id|BIT0
suffix:semicolon
id|write_reg
c_func
(paren
id|info
comma
id|CHA
op_plus
id|MODE
comma
id|val
)paren
suffix:semicolon
)brace
DECL|function|hdlc_mode
r_void
id|hdlc_mode
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
)paren
(brace
r_int
r_char
id|val
suffix:semicolon
r_int
r_char
id|clkmode
comma
id|clksubmode
suffix:semicolon
multiline_comment|/* disable all interrupts */
id|irq_disable
c_func
(paren
id|info
comma
id|CHA
comma
l_int|0xffff
)paren
suffix:semicolon
id|irq_disable
c_func
(paren
id|info
comma
id|CHB
comma
l_int|0xffff
)paren
suffix:semicolon
id|port_irq_disable
c_func
(paren
id|info
comma
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* assume clock mode 0a, rcv=RxC xmt=TxC */
id|clkmode
op_assign
id|clksubmode
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;params.flags
op_amp
id|HDLC_FLAG_RXC_DPLL
op_logical_and
id|info-&gt;params.flags
op_amp
id|HDLC_FLAG_TXC_DPLL
)paren
(brace
multiline_comment|/* clock mode 7a, rcv = DPLL, xmt = DPLL */
id|clkmode
op_assign
l_int|7
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|info-&gt;params.flags
op_amp
id|HDLC_FLAG_RXC_BRG
op_logical_and
id|info-&gt;params.flags
op_amp
id|HDLC_FLAG_TXC_BRG
)paren
(brace
multiline_comment|/* clock mode 7b, rcv = BRG, xmt = BRG */
id|clkmode
op_assign
l_int|7
suffix:semicolon
id|clksubmode
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|info-&gt;params.flags
op_amp
id|HDLC_FLAG_RXC_DPLL
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;params.flags
op_amp
id|HDLC_FLAG_TXC_BRG
)paren
(brace
multiline_comment|/* clock mode 6b, rcv = DPLL, xmt = BRG/16 */
id|clkmode
op_assign
l_int|6
suffix:semicolon
id|clksubmode
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* clock mode 6a, rcv = DPLL, xmt = TxC */
id|clkmode
op_assign
l_int|6
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|info-&gt;params.flags
op_amp
id|HDLC_FLAG_TXC_BRG
)paren
(brace
multiline_comment|/* clock mode 0b, rcv = RxC, xmt = BRG */
id|clksubmode
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* MODE&n;&t; *&n;&t; * 07..06  MDS[1..0] 10 = transparent HDLC mode&n;&t; * 05      ADM Address Mode, 0 = no addr recognition&n;&t; * 04      TMD Timer Mode, 0 = external&n;&t; * 03      RAC Receiver Active, 0 = inactive&n;&t; * 02      RTS 0=RTS active during xmit, 1=RTS always active&n;&t; * 01      TRS Timer Resolution, 1=512&n;&t; * 00      TLP Test Loop, 0 = no loop&n;&t; *&n;&t; * 1000 0010&n;&t; */
id|val
op_assign
l_int|0x82
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;params.loopback
)paren
id|val
op_or_assign
id|BIT0
suffix:semicolon
multiline_comment|/* preserve RTS state */
r_if
c_cond
(paren
id|info-&gt;serial_signals
op_amp
id|SerialSignal_RTS
)paren
id|val
op_or_assign
id|BIT2
suffix:semicolon
id|write_reg
c_func
(paren
id|info
comma
id|CHA
op_plus
id|MODE
comma
id|val
)paren
suffix:semicolon
multiline_comment|/* CCR0&n;&t; *&n;&t; * 07      PU Power Up, 1=active, 0=power down&n;&t; * 06      MCE Master Clock Enable, 1=enabled&n;&t; * 05      Reserved, 0&n;&t; * 04..02  SC[2..0] Encoding&n;&t; * 01..00  SM[1..0] Serial Mode, 00=HDLC&n;&t; *&n;&t; * 11000000&n;&t; */
id|val
op_assign
l_int|0xc0
suffix:semicolon
r_switch
c_cond
(paren
id|info-&gt;params.encoding
)paren
(brace
r_case
id|HDLC_ENCODING_NRZI
suffix:colon
id|val
op_or_assign
id|BIT3
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HDLC_ENCODING_BIPHASE_SPACE
suffix:colon
id|val
op_or_assign
id|BIT4
suffix:semicolon
r_break
suffix:semicolon
singleline_comment|// FM0
r_case
id|HDLC_ENCODING_BIPHASE_MARK
suffix:colon
id|val
op_or_assign
id|BIT4
op_plus
id|BIT2
suffix:semicolon
r_break
suffix:semicolon
singleline_comment|// FM1
r_case
id|HDLC_ENCODING_BIPHASE_LEVEL
suffix:colon
id|val
op_or_assign
id|BIT4
op_plus
id|BIT3
suffix:semicolon
r_break
suffix:semicolon
singleline_comment|// Manchester
)brace
id|write_reg
c_func
(paren
id|info
comma
id|CHA
op_plus
id|CCR0
comma
id|val
)paren
suffix:semicolon
multiline_comment|/* CCR1&n;&t; *&n;&t; * 07      SFLG Shared Flag, 0 = disable shared flags&n;&t; * 06      GALP Go Active On Loop, 0 = not used&n;&t; * 05      GLP Go On Loop, 0 = not used&n;&t; * 04      ODS Output Driver Select, 1=TxD is push-pull output&n;&t; * 03      ITF Interframe Time Fill, 0=mark, 1=flag&n;&t; * 02..00  CM[2..0] Clock Mode&n;&t; *&n;&t; * 0001 0000&n;&t; */
id|val
op_assign
l_int|0x10
op_plus
id|clkmode
suffix:semicolon
id|write_reg
c_func
(paren
id|info
comma
id|CHA
op_plus
id|CCR1
comma
id|val
)paren
suffix:semicolon
multiline_comment|/* CCR2&n;&t; *&n;&t; * 07..06  BGR[9..8] Baud rate bits 9..8&n;&t; * 05      BDF Baud rate divisor factor, 0=1, 1=BGR value&n;&t; * 04      SSEL Clock source select, 1=submode b&n;&t; * 03      TOE 0=TxCLK is input, 0=TxCLK is input&n;&t; * 02      RWX Read/Write Exchange 0=disabled&n;&t; * 01      C32, CRC select, 0=CRC-16, 1=CRC-32&n;&t; * 00      DIV, data inversion 0=disabled, 1=enabled&n;&t; *&n;&t; * 0000 0000&n;&t; */
id|val
op_assign
l_int|0x00
suffix:semicolon
r_if
c_cond
(paren
id|clkmode
op_eq
l_int|2
op_logical_or
id|clkmode
op_eq
l_int|3
op_logical_or
id|clkmode
op_eq
l_int|6
op_logical_or
id|clkmode
op_eq
l_int|7
op_logical_or
(paren
id|clkmode
op_eq
l_int|0
op_logical_and
id|clksubmode
op_eq
l_int|1
)paren
)paren
id|val
op_or_assign
id|BIT5
suffix:semicolon
r_if
c_cond
(paren
id|clksubmode
)paren
id|val
op_or_assign
id|BIT4
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;params.crc_type
op_eq
id|HDLC_CRC_32_CCITT
)paren
id|val
op_or_assign
id|BIT1
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;params.encoding
op_eq
id|HDLC_ENCODING_NRZB
)paren
id|val
op_or_assign
id|BIT0
suffix:semicolon
id|write_reg
c_func
(paren
id|info
comma
id|CHA
op_plus
id|CCR2
comma
id|val
)paren
suffix:semicolon
multiline_comment|/* CCR3&n;&t; *&n;&t; * 07..06  PRE[1..0] Preamble count 00=1, 01=2, 10=4, 11=8&n;&t; * 05      EPT Enable preamble transmission, 1=enabled&n;&t; * 04      RADD Receive address pushed to FIFO, 0=disabled&n;&t; * 03      CRL CRC Reset Level, 0=FFFF&n;&t; * 02      RCRC Rx CRC 0=On 1=Off&n;&t; * 01      TCRC Tx CRC 0=On 1=Off&n;&t; * 00      PSD DPLL Phase Shift Disable&n;&t; *&n;&t; * 0000 0000&n;&t; */
id|val
op_assign
l_int|0x00
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;params.crc_type
op_eq
id|HDLC_CRC_NONE
)paren
id|val
op_or_assign
id|BIT2
op_plus
id|BIT1
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;params.preamble
op_ne
id|HDLC_PREAMBLE_PATTERN_NONE
)paren
id|val
op_or_assign
id|BIT5
suffix:semicolon
r_switch
c_cond
(paren
id|info-&gt;params.preamble_length
)paren
(brace
r_case
id|HDLC_PREAMBLE_LENGTH_16BITS
suffix:colon
id|val
op_or_assign
id|BIT6
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HDLC_PREAMBLE_LENGTH_32BITS
suffix:colon
id|val
op_or_assign
id|BIT6
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HDLC_PREAMBLE_LENGTH_64BITS
suffix:colon
id|val
op_or_assign
id|BIT7
op_plus
id|BIT6
suffix:semicolon
r_break
suffix:semicolon
)brace
id|write_reg
c_func
(paren
id|info
comma
id|CHA
op_plus
id|CCR3
comma
id|val
)paren
suffix:semicolon
multiline_comment|/* PRE - Preamble pattern */
id|val
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|info-&gt;params.preamble
)paren
(brace
r_case
id|HDLC_PREAMBLE_PATTERN_FLAGS
suffix:colon
id|val
op_assign
l_int|0x7e
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HDLC_PREAMBLE_PATTERN_10
suffix:colon
id|val
op_assign
l_int|0xaa
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HDLC_PREAMBLE_PATTERN_01
suffix:colon
id|val
op_assign
l_int|0x55
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HDLC_PREAMBLE_PATTERN_ONES
suffix:colon
id|val
op_assign
l_int|0xff
suffix:semicolon
r_break
suffix:semicolon
)brace
id|write_reg
c_func
(paren
id|info
comma
id|CHA
op_plus
id|PRE
comma
id|val
)paren
suffix:semicolon
multiline_comment|/* CCR4&n;&t; *&n;&t; * 07      MCK4 Master Clock Divide by 4, 1=enabled&n;&t; * 06      EBRG Enhanced Baud Rate Generator Mode, 1=enabled&n;&t; * 05      TST1 Test Pin, 0=normal operation&n;&t; * 04      ICD Ivert Carrier Detect, 1=enabled (active low)&n;&t; * 03..02  Reserved, must be 0&n;&t; * 01..00  RFT[1..0] RxFIFO Threshold 00=32 bytes&n;&t; *&n;&t; * 0101 0000&n;&t; */
id|val
op_assign
l_int|0x50
suffix:semicolon
id|write_reg
c_func
(paren
id|info
comma
id|CHA
op_plus
id|CCR4
comma
id|val
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;params.flags
op_amp
id|HDLC_FLAG_RXC_DPLL
)paren
id|mgslpc_set_rate
c_func
(paren
id|info
comma
id|CHA
comma
id|info-&gt;params.clock_speed
op_star
l_int|16
)paren
suffix:semicolon
r_else
id|mgslpc_set_rate
c_func
(paren
id|info
comma
id|CHA
comma
id|info-&gt;params.clock_speed
)paren
suffix:semicolon
multiline_comment|/* RLCR Receive length check register&n;&t; *&n;&t; * 7     1=enable receive length check&n;&t; * 6..0  Max frame length = (RL + 1) * 32&n;&t; */
id|write_reg
c_func
(paren
id|info
comma
id|CHA
op_plus
id|RLCR
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* XBCH Transmit Byte Count High&n;&t; *&n;&t; * 07      DMA mode, 0 = interrupt driven&n;&t; * 06      NRM, 0=ABM (ignored)&n;&t; * 05      CAS Carrier Auto Start&n;&t; * 04      XC Transmit Continuously (ignored)&n;&t; * 03..00  XBC[10..8] Transmit byte count bits 10..8&n;&t; *&n;&t; * 0000 0000&n;&t; */
id|val
op_assign
l_int|0x00
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;params.flags
op_amp
id|HDLC_FLAG_AUTO_DCD
)paren
id|val
op_or_assign
id|BIT5
suffix:semicolon
id|write_reg
c_func
(paren
id|info
comma
id|CHA
op_plus
id|XBCH
comma
id|val
)paren
suffix:semicolon
id|enable_auxclk
c_func
(paren
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;params.loopback
op_logical_or
id|info-&gt;testing_irq
)paren
id|loopback_enable
c_func
(paren
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;params.flags
op_amp
id|HDLC_FLAG_AUTO_CTS
)paren
(brace
id|irq_enable
c_func
(paren
id|info
comma
id|CHB
comma
id|IRQ_CTS
)paren
suffix:semicolon
multiline_comment|/* PVR[3] 1=AUTO CTS active */
id|set_reg_bits
c_func
(paren
id|info
comma
id|CHA
op_plus
id|PVR
comma
id|BIT3
)paren
suffix:semicolon
)brace
r_else
id|clear_reg_bits
c_func
(paren
id|info
comma
id|CHA
op_plus
id|PVR
comma
id|BIT3
)paren
suffix:semicolon
id|irq_enable
c_func
(paren
id|info
comma
id|CHA
comma
id|IRQ_RXEOM
op_plus
id|IRQ_RXFIFO
op_plus
id|IRQ_ALLSENT
op_plus
id|IRQ_UNDERRUN
op_plus
id|IRQ_TXFIFO
)paren
suffix:semicolon
id|issue_command
c_func
(paren
id|info
comma
id|CHA
comma
id|CMD_TXRESET
op_plus
id|CMD_RXRESET
)paren
suffix:semicolon
id|wait_command_complete
c_func
(paren
id|info
comma
id|CHA
)paren
suffix:semicolon
id|read_reg16
c_func
(paren
id|info
comma
id|CHA
op_plus
id|ISR
)paren
suffix:semicolon
multiline_comment|/* clear pending IRQs */
multiline_comment|/* Master clock mode enabled above to allow reset commands&n;&t; * to complete even if no data clocks are present.&n;&t; *&n;&t; * Disable master clock mode for normal communications because&n;&t; * V3.2 of the ESCC2 has a bug that prevents the transmit all sent&n;&t; * IRQ when in master clock mode.&n;&t; *&n;&t; * Leave master clock mode enabled for IRQ test because the&n;&t; * timer IRQ used by the test can only happen in master clock mode.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;testing_irq
)paren
id|clear_reg_bits
c_func
(paren
id|info
comma
id|CHA
op_plus
id|CCR0
comma
id|BIT6
)paren
suffix:semicolon
id|tx_set_idle
c_func
(paren
id|info
)paren
suffix:semicolon
id|tx_stop
c_func
(paren
id|info
)paren
suffix:semicolon
id|rx_stop
c_func
(paren
id|info
)paren
suffix:semicolon
)brace
DECL|function|rx_stop
r_void
id|rx_stop
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
)paren
(brace
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_ISR
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):rx_stop(%s)&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
)paren
suffix:semicolon
multiline_comment|/* MODE:03 RAC Receiver Active, 0=inactive */
id|clear_reg_bits
c_func
(paren
id|info
comma
id|CHA
op_plus
id|MODE
comma
id|BIT3
)paren
suffix:semicolon
id|info-&gt;rx_enabled
op_assign
l_int|0
suffix:semicolon
id|info-&gt;rx_overflow
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|rx_start
r_void
id|rx_start
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
)paren
(brace
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_ISR
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):rx_start(%s)&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
)paren
suffix:semicolon
id|rx_reset_buffers
c_func
(paren
id|info
)paren
suffix:semicolon
id|info-&gt;rx_enabled
op_assign
l_int|0
suffix:semicolon
id|info-&gt;rx_overflow
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* MODE:03 RAC Receiver Active, 1=active */
id|set_reg_bits
c_func
(paren
id|info
comma
id|CHA
op_plus
id|MODE
comma
id|BIT3
)paren
suffix:semicolon
id|info-&gt;rx_enabled
op_assign
l_int|1
suffix:semicolon
)brace
DECL|function|tx_start
r_void
id|tx_start
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
)paren
(brace
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_ISR
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):tx_start(%s)&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;tx_count
)paren
(brace
multiline_comment|/* If auto RTS enabled and RTS is inactive, then assert */
multiline_comment|/* RTS and set a flag indicating that the driver should */
multiline_comment|/* negate RTS when the transmission completes. */
id|info-&gt;drop_rts_on_tx_done
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;params.flags
op_amp
id|HDLC_FLAG_AUTO_RTS
)paren
(brace
id|get_signals
c_func
(paren
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|info-&gt;serial_signals
op_amp
id|SerialSignal_RTS
)paren
)paren
(brace
id|info-&gt;serial_signals
op_or_assign
id|SerialSignal_RTS
suffix:semicolon
id|set_signals
c_func
(paren
id|info
)paren
suffix:semicolon
id|info-&gt;drop_rts_on_tx_done
op_assign
l_int|1
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|info-&gt;params.mode
op_eq
id|MGSL_MODE_ASYNC
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;tx_active
)paren
(brace
id|info-&gt;tx_active
op_assign
l_int|1
suffix:semicolon
id|tx_ready
c_func
(paren
id|info
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|info-&gt;tx_active
op_assign
l_int|1
suffix:semicolon
id|tx_ready
c_func
(paren
id|info
)paren
suffix:semicolon
id|info-&gt;tx_timer.expires
op_assign
id|jiffies
op_plus
id|msecs_to_jiffies
c_func
(paren
l_int|5000
)paren
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|info-&gt;tx_timer
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;tx_enabled
)paren
id|info-&gt;tx_enabled
op_assign
l_int|1
suffix:semicolon
)brace
DECL|function|tx_stop
r_void
id|tx_stop
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
)paren
(brace
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_ISR
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):tx_stop(%s)&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|info-&gt;tx_timer
)paren
suffix:semicolon
id|info-&gt;tx_enabled
op_assign
l_int|0
suffix:semicolon
id|info-&gt;tx_active
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Reset the adapter to a known state and prepare it for further use.&n; */
DECL|function|reset_device
r_void
id|reset_device
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
)paren
(brace
multiline_comment|/* power up both channels (set BIT7) */
id|write_reg
c_func
(paren
id|info
comma
id|CHA
op_plus
id|CCR0
comma
l_int|0x80
)paren
suffix:semicolon
id|write_reg
c_func
(paren
id|info
comma
id|CHB
op_plus
id|CCR0
comma
l_int|0x80
)paren
suffix:semicolon
id|write_reg
c_func
(paren
id|info
comma
id|CHA
op_plus
id|MODE
comma
l_int|0
)paren
suffix:semicolon
id|write_reg
c_func
(paren
id|info
comma
id|CHB
op_plus
id|MODE
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* disable all interrupts */
id|irq_disable
c_func
(paren
id|info
comma
id|CHA
comma
l_int|0xffff
)paren
suffix:semicolon
id|irq_disable
c_func
(paren
id|info
comma
id|CHB
comma
l_int|0xffff
)paren
suffix:semicolon
id|port_irq_disable
c_func
(paren
id|info
comma
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* PCR Port Configuration Register&n;&t; *&n;&t; * 07..04  DEC[3..0] Serial I/F select outputs&n;&t; * 03      output, 1=AUTO CTS control enabled&n;&t; * 02      RI Ring Indicator input 0=active&n;&t; * 01      DSR input 0=active&n;&t; * 00      DTR output 0=active&n;&t; *&n;&t; * 0000 0110&n;&t; */
id|write_reg
c_func
(paren
id|info
comma
id|PCR
comma
l_int|0x06
)paren
suffix:semicolon
multiline_comment|/* PVR Port Value Register&n;&t; *&n;&t; * 07..04  DEC[3..0] Serial I/F select (0000=disabled)&n;&t; * 03      AUTO CTS output 1=enabled&n;&t; * 02      RI Ring Indicator input&n;&t; * 01      DSR input&n;&t; * 00      DTR output (1=inactive)&n;&t; *&n;&t; * 0000 0001&n;&t; */
singleline_comment|//&t;write_reg(info, PVR, PVR_DTR);
multiline_comment|/* IPC Interrupt Port Configuration&n;&t; *&n;&t; * 07      VIS 1=Masked interrupts visible&n;&t; * 06..05  Reserved, 0&n;&t; * 04..03  SLA Slave address, 00 ignored&n;&t; * 02      CASM Cascading Mode, 1=daisy chain&n;&t; * 01..00  IC[1..0] Interrupt Config, 01=push-pull output, active low&n;&t; *&n;&t; * 0000 0101&n;&t; */
id|write_reg
c_func
(paren
id|info
comma
id|IPC
comma
l_int|0x05
)paren
suffix:semicolon
)brace
DECL|function|async_mode
r_void
id|async_mode
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
)paren
(brace
r_int
r_char
id|val
suffix:semicolon
multiline_comment|/* disable all interrupts */
id|irq_disable
c_func
(paren
id|info
comma
id|CHA
comma
l_int|0xffff
)paren
suffix:semicolon
id|irq_disable
c_func
(paren
id|info
comma
id|CHB
comma
l_int|0xffff
)paren
suffix:semicolon
id|port_irq_disable
c_func
(paren
id|info
comma
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* MODE&n;&t; *&n;&t; * 07      Reserved, 0&n;&t; * 06      FRTS RTS State, 0=active&n;&t; * 05      FCTS Flow Control on CTS&n;&t; * 04      FLON Flow Control Enable&n;&t; * 03      RAC Receiver Active, 0 = inactive&n;&t; * 02      RTS 0=Auto RTS, 1=manual RTS&n;&t; * 01      TRS Timer Resolution, 1=512&n;&t; * 00      TLP Test Loop, 0 = no loop&n;&t; *&n;&t; * 0000 0110&n;&t; */
id|val
op_assign
l_int|0x06
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;params.loopback
)paren
id|val
op_or_assign
id|BIT0
suffix:semicolon
multiline_comment|/* preserve RTS state */
r_if
c_cond
(paren
op_logical_neg
(paren
id|info-&gt;serial_signals
op_amp
id|SerialSignal_RTS
)paren
)paren
id|val
op_or_assign
id|BIT6
suffix:semicolon
id|write_reg
c_func
(paren
id|info
comma
id|CHA
op_plus
id|MODE
comma
id|val
)paren
suffix:semicolon
multiline_comment|/* CCR0&n;&t; *&n;&t; * 07      PU Power Up, 1=active, 0=power down&n;&t; * 06      MCE Master Clock Enable, 1=enabled&n;&t; * 05      Reserved, 0&n;&t; * 04..02  SC[2..0] Encoding, 000=NRZ&n;&t; * 01..00  SM[1..0] Serial Mode, 11=Async&n;&t; *&n;&t; * 1000 0011&n;&t; */
id|write_reg
c_func
(paren
id|info
comma
id|CHA
op_plus
id|CCR0
comma
l_int|0x83
)paren
suffix:semicolon
multiline_comment|/* CCR1&n;&t; *&n;&t; * 07..05  Reserved, 0&n;&t; * 04      ODS Output Driver Select, 1=TxD is push-pull output&n;&t; * 03      BCR Bit Clock Rate, 1=16x&n;&t; * 02..00  CM[2..0] Clock Mode, 111=BRG&n;&t; *&n;&t; * 0001 1111&n;&t; */
id|write_reg
c_func
(paren
id|info
comma
id|CHA
op_plus
id|CCR1
comma
l_int|0x1f
)paren
suffix:semicolon
multiline_comment|/* CCR2 (channel A)&n;&t; *&n;&t; * 07..06  BGR[9..8] Baud rate bits 9..8&n;&t; * 05      BDF Baud rate divisor factor, 0=1, 1=BGR value&n;&t; * 04      SSEL Clock source select, 1=submode b&n;&t; * 03      TOE 0=TxCLK is input, 0=TxCLK is input&n;&t; * 02      RWX Read/Write Exchange 0=disabled&n;&t; * 01      Reserved, 0&n;&t; * 00      DIV, data inversion 0=disabled, 1=enabled&n;&t; *&n;&t; * 0001 0000&n;&t; */
id|write_reg
c_func
(paren
id|info
comma
id|CHA
op_plus
id|CCR2
comma
l_int|0x10
)paren
suffix:semicolon
multiline_comment|/* CCR3&n;&t; *&n;&t; * 07..01  Reserved, 0&n;&t; * 00      PSD DPLL Phase Shift Disable&n;&t; *&n;&t; * 0000 0000&n;&t; */
id|write_reg
c_func
(paren
id|info
comma
id|CHA
op_plus
id|CCR3
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* CCR4&n;&t; *&n;&t; * 07      MCK4 Master Clock Divide by 4, 1=enabled&n;&t; * 06      EBRG Enhanced Baud Rate Generator Mode, 1=enabled&n;&t; * 05      TST1 Test Pin, 0=normal operation&n;&t; * 04      ICD Ivert Carrier Detect, 1=enabled (active low)&n;&t; * 03..00  Reserved, must be 0&n;&t; *&n;&t; * 0101 0000&n;&t; */
id|write_reg
c_func
(paren
id|info
comma
id|CHA
op_plus
id|CCR4
comma
l_int|0x50
)paren
suffix:semicolon
id|mgslpc_set_rate
c_func
(paren
id|info
comma
id|CHA
comma
id|info-&gt;params.data_rate
op_star
l_int|16
)paren
suffix:semicolon
multiline_comment|/* DAFO Data Format&n;&t; *&n;&t; * 07      Reserved, 0&n;&t; * 06      XBRK transmit break, 0=normal operation&n;&t; * 05      Stop bits (0=1, 1=2)&n;&t; * 04..03  PAR[1..0] Parity (01=odd, 10=even)&n;&t; * 02      PAREN Parity Enable&n;&t; * 01..00  CHL[1..0] Character Length (00=8, 01=7)&n;&t; *&n;&t; */
id|val
op_assign
l_int|0x00
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;params.data_bits
op_ne
l_int|8
)paren
id|val
op_or_assign
id|BIT0
suffix:semicolon
multiline_comment|/* 7 bits */
r_if
c_cond
(paren
id|info-&gt;params.stop_bits
op_ne
l_int|1
)paren
id|val
op_or_assign
id|BIT5
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;params.parity
op_ne
id|ASYNC_PARITY_NONE
)paren
(brace
id|val
op_or_assign
id|BIT2
suffix:semicolon
multiline_comment|/* Parity enable */
r_if
c_cond
(paren
id|info-&gt;params.parity
op_eq
id|ASYNC_PARITY_ODD
)paren
id|val
op_or_assign
id|BIT3
suffix:semicolon
r_else
id|val
op_or_assign
id|BIT4
suffix:semicolon
)brace
id|write_reg
c_func
(paren
id|info
comma
id|CHA
op_plus
id|DAFO
comma
id|val
)paren
suffix:semicolon
multiline_comment|/* RFC Rx FIFO Control&n;&t; *&n;&t; * 07      Reserved, 0&n;&t; * 06      DPS, 1=parity bit not stored in data byte&n;&t; * 05      DXS, 0=all data stored in FIFO (including XON/XOFF)&n;&t; * 04      RFDF Rx FIFO Data Format, 1=status byte stored in FIFO&n;&t; * 03..02  RFTH[1..0], rx threshold, 11=16 status + 16 data byte&n;&t; * 01      Reserved, 0&n;&t; * 00      TCDE Terminate Char Detect Enable, 0=disabled&n;&t; *&n;&t; * 0101 1100&n;&t; */
id|write_reg
c_func
(paren
id|info
comma
id|CHA
op_plus
id|RFC
comma
l_int|0x5c
)paren
suffix:semicolon
multiline_comment|/* RLCR Receive length check register&n;&t; *&n;&t; * Max frame length = (RL + 1) * 32&n;&t; */
id|write_reg
c_func
(paren
id|info
comma
id|CHA
op_plus
id|RLCR
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* XBCH Transmit Byte Count High&n;&t; *&n;&t; * 07      DMA mode, 0 = interrupt driven&n;&t; * 06      NRM, 0=ABM (ignored)&n;&t; * 05      CAS Carrier Auto Start&n;&t; * 04      XC Transmit Continuously (ignored)&n;&t; * 03..00  XBC[10..8] Transmit byte count bits 10..8&n;&t; *&n;&t; * 0000 0000&n;&t; */
id|val
op_assign
l_int|0x00
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;params.flags
op_amp
id|HDLC_FLAG_AUTO_DCD
)paren
id|val
op_or_assign
id|BIT5
suffix:semicolon
id|write_reg
c_func
(paren
id|info
comma
id|CHA
op_plus
id|XBCH
comma
id|val
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;params.flags
op_amp
id|HDLC_FLAG_AUTO_CTS
)paren
id|irq_enable
c_func
(paren
id|info
comma
id|CHA
comma
id|IRQ_CTS
)paren
suffix:semicolon
multiline_comment|/* MODE:03 RAC Receiver Active, 1=active */
id|set_reg_bits
c_func
(paren
id|info
comma
id|CHA
op_plus
id|MODE
comma
id|BIT3
)paren
suffix:semicolon
id|enable_auxclk
c_func
(paren
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;params.flags
op_amp
id|HDLC_FLAG_AUTO_CTS
)paren
(brace
id|irq_enable
c_func
(paren
id|info
comma
id|CHB
comma
id|IRQ_CTS
)paren
suffix:semicolon
multiline_comment|/* PVR[3] 1=AUTO CTS active */
id|set_reg_bits
c_func
(paren
id|info
comma
id|CHA
op_plus
id|PVR
comma
id|BIT3
)paren
suffix:semicolon
)brace
r_else
id|clear_reg_bits
c_func
(paren
id|info
comma
id|CHA
op_plus
id|PVR
comma
id|BIT3
)paren
suffix:semicolon
id|irq_enable
c_func
(paren
id|info
comma
id|CHA
comma
id|IRQ_RXEOM
op_plus
id|IRQ_RXFIFO
op_plus
id|IRQ_BREAK_ON
op_plus
id|IRQ_RXTIME
op_plus
id|IRQ_ALLSENT
op_plus
id|IRQ_TXFIFO
)paren
suffix:semicolon
id|issue_command
c_func
(paren
id|info
comma
id|CHA
comma
id|CMD_TXRESET
op_plus
id|CMD_RXRESET
)paren
suffix:semicolon
id|wait_command_complete
c_func
(paren
id|info
comma
id|CHA
)paren
suffix:semicolon
id|read_reg16
c_func
(paren
id|info
comma
id|CHA
op_plus
id|ISR
)paren
suffix:semicolon
multiline_comment|/* clear pending IRQs */
)brace
multiline_comment|/* Set the HDLC idle mode for the transmitter.&n; */
DECL|function|tx_set_idle
r_void
id|tx_set_idle
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
)paren
(brace
multiline_comment|/* Note: ESCC2 only supports flags and one idle modes */
r_if
c_cond
(paren
id|info-&gt;idle_mode
op_eq
id|HDLC_TXIDLE_FLAGS
)paren
id|set_reg_bits
c_func
(paren
id|info
comma
id|CHA
op_plus
id|CCR1
comma
id|BIT3
)paren
suffix:semicolon
r_else
id|clear_reg_bits
c_func
(paren
id|info
comma
id|CHA
op_plus
id|CCR1
comma
id|BIT3
)paren
suffix:semicolon
)brace
multiline_comment|/* get state of the V24 status (input) signals.&n; */
DECL|function|get_signals
r_void
id|get_signals
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
)paren
(brace
r_int
r_char
id|status
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* preserve DTR and RTS */
id|info-&gt;serial_signals
op_and_assign
id|SerialSignal_DTR
op_plus
id|SerialSignal_RTS
suffix:semicolon
r_if
c_cond
(paren
id|read_reg
c_func
(paren
id|info
comma
id|CHB
op_plus
id|VSTR
)paren
op_amp
id|BIT7
)paren
id|info-&gt;serial_signals
op_or_assign
id|SerialSignal_DCD
suffix:semicolon
r_if
c_cond
(paren
id|read_reg
c_func
(paren
id|info
comma
id|CHB
op_plus
id|STAR
)paren
op_amp
id|BIT1
)paren
id|info-&gt;serial_signals
op_or_assign
id|SerialSignal_CTS
suffix:semicolon
id|status
op_assign
id|read_reg
c_func
(paren
id|info
comma
id|CHA
op_plus
id|PVR
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_amp
id|PVR_RI
)paren
)paren
id|info-&gt;serial_signals
op_or_assign
id|SerialSignal_RI
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_amp
id|PVR_DSR
)paren
)paren
id|info-&gt;serial_signals
op_or_assign
id|SerialSignal_DSR
suffix:semicolon
)brace
multiline_comment|/* Set the state of DTR and RTS based on contents of&n; * serial_signals member of device extension.&n; */
DECL|function|set_signals
r_void
id|set_signals
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
)paren
(brace
r_int
r_char
id|val
suffix:semicolon
id|val
op_assign
id|read_reg
c_func
(paren
id|info
comma
id|CHA
op_plus
id|MODE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;params.mode
op_eq
id|MGSL_MODE_ASYNC
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;serial_signals
op_amp
id|SerialSignal_RTS
)paren
id|val
op_and_assign
op_complement
id|BIT6
suffix:semicolon
r_else
id|val
op_or_assign
id|BIT6
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|info-&gt;serial_signals
op_amp
id|SerialSignal_RTS
)paren
id|val
op_or_assign
id|BIT2
suffix:semicolon
r_else
id|val
op_and_assign
op_complement
id|BIT2
suffix:semicolon
)brace
id|write_reg
c_func
(paren
id|info
comma
id|CHA
op_plus
id|MODE
comma
id|val
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;serial_signals
op_amp
id|SerialSignal_DTR
)paren
id|clear_reg_bits
c_func
(paren
id|info
comma
id|CHA
op_plus
id|PVR
comma
id|PVR_DTR
)paren
suffix:semicolon
r_else
id|set_reg_bits
c_func
(paren
id|info
comma
id|CHA
op_plus
id|PVR
comma
id|PVR_DTR
)paren
suffix:semicolon
)brace
DECL|function|rx_reset_buffers
r_void
id|rx_reset_buffers
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
)paren
(brace
id|RXBUF
op_star
id|buf
suffix:semicolon
r_int
id|i
suffix:semicolon
id|info-&gt;rx_put
op_assign
l_int|0
suffix:semicolon
id|info-&gt;rx_get
op_assign
l_int|0
suffix:semicolon
id|info-&gt;rx_frame_count
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|info-&gt;rx_buf_count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|buf
op_assign
(paren
id|RXBUF
op_star
)paren
(paren
id|info-&gt;rx_buf
op_plus
(paren
id|i
op_star
id|info-&gt;rx_buf_size
)paren
)paren
suffix:semicolon
id|buf-&gt;status
op_assign
id|buf-&gt;count
op_assign
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/* Attempt to return a received HDLC frame&n; * Only frames received without errors are returned.&n; *&n; * Returns 1 if frame returned, otherwise 0&n; */
DECL|function|rx_get_frame
r_int
id|rx_get_frame
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
)paren
(brace
r_int
r_int
id|status
suffix:semicolon
id|RXBUF
op_star
id|buf
suffix:semicolon
r_int
r_int
id|framesize
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|tty_struct
op_star
id|tty
op_assign
id|info-&gt;tty
suffix:semicolon
r_int
id|return_frame
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;rx_frame_count
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
id|buf
op_assign
(paren
id|RXBUF
op_star
)paren
(paren
id|info-&gt;rx_buf
op_plus
(paren
id|info-&gt;rx_get
op_star
id|info-&gt;rx_buf_size
)paren
)paren
suffix:semicolon
id|status
op_assign
id|buf-&gt;status
suffix:semicolon
multiline_comment|/* 07  VFR  1=valid frame&n;&t; * 06  RDO  1=data overrun&n;&t; * 05  CRC  1=OK, 0=error&n;&t; * 04  RAB  1=frame aborted&n;&t; */
r_if
c_cond
(paren
(paren
id|status
op_amp
l_int|0xf0
)paren
op_ne
l_int|0xA0
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_amp
id|BIT7
)paren
op_logical_or
(paren
id|status
op_amp
id|BIT4
)paren
)paren
id|info-&gt;icount.rxabort
op_increment
suffix:semicolon
r_else
r_if
c_cond
(paren
id|status
op_amp
id|BIT6
)paren
id|info-&gt;icount.rxover
op_increment
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_amp
id|BIT5
)paren
)paren
(brace
id|info-&gt;icount.rxcrc
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;params.crc_type
op_amp
id|HDLC_CRC_RETURN_EX
)paren
id|return_frame
op_assign
l_int|1
suffix:semicolon
)brace
id|framesize
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef CONFIG_HDLC
(brace
r_struct
id|net_device_stats
op_star
id|stats
op_assign
id|hdlc_stats
c_func
(paren
id|info-&gt;netdev
)paren
suffix:semicolon
id|stats-&gt;rx_errors
op_increment
suffix:semicolon
id|stats-&gt;rx_frame_errors
op_increment
suffix:semicolon
)brace
macro_line|#endif
)brace
r_else
id|return_frame
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|return_frame
)paren
id|framesize
op_assign
id|buf-&gt;count
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_BH
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):rx_get_frame(%s) status=%04X size=%d&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
comma
id|status
comma
id|framesize
)paren
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_DATA
)paren
id|trace_block
c_func
(paren
id|info
comma
id|buf-&gt;data
comma
id|framesize
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|framesize
)paren
(brace
r_if
c_cond
(paren
(paren
id|info-&gt;params.crc_type
op_amp
id|HDLC_CRC_RETURN_EX
op_logical_and
id|framesize
op_plus
l_int|1
OG
id|info-&gt;max_frame_size
)paren
op_logical_or
id|framesize
OG
id|info-&gt;max_frame_size
)paren
id|info-&gt;icount.rxlong
op_increment
suffix:semicolon
r_else
(brace
r_if
c_cond
(paren
id|status
op_amp
id|BIT5
)paren
id|info-&gt;icount.rxok
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;params.crc_type
op_amp
id|HDLC_CRC_RETURN_EX
)paren
(brace
op_star
(paren
id|buf-&gt;data
op_plus
id|framesize
)paren
op_assign
id|status
op_amp
id|BIT5
ques
c_cond
id|RX_OK
suffix:colon
id|RX_CRC_ERROR
suffix:semicolon
op_increment
id|framesize
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_HDLC
r_if
c_cond
(paren
id|info-&gt;netcount
)paren
id|hdlcdev_rx
c_func
(paren
id|info
comma
id|buf-&gt;data
comma
id|framesize
)paren
suffix:semicolon
r_else
macro_line|#endif
id|ldisc_receive_buf
c_func
(paren
id|tty
comma
id|buf-&gt;data
comma
id|info-&gt;flag_buf
comma
id|framesize
)paren
suffix:semicolon
)brace
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|buf-&gt;status
op_assign
id|buf-&gt;count
op_assign
l_int|0
suffix:semicolon
id|info-&gt;rx_frame_count
op_decrement
suffix:semicolon
id|info-&gt;rx_get
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;rx_get
op_ge
id|info-&gt;rx_buf_count
)paren
id|info-&gt;rx_get
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|register_test
id|BOOLEAN
id|register_test
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
)paren
(brace
r_static
r_int
r_char
id|patterns
(braket
)braket
op_assign
(brace
l_int|0x00
comma
l_int|0xff
comma
l_int|0xaa
comma
l_int|0x55
comma
l_int|0x69
comma
l_int|0x96
comma
l_int|0x0f
)brace
suffix:semicolon
r_static
r_int
r_int
id|count
op_assign
r_sizeof
(paren
id|patterns
)paren
op_div
r_sizeof
(paren
id|patterns
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_int
r_int
id|i
suffix:semicolon
id|BOOLEAN
id|rc
op_assign
id|TRUE
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|reset_device
c_func
(paren
id|info
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|write_reg
c_func
(paren
id|info
comma
id|XAD1
comma
id|patterns
(braket
id|i
)braket
)paren
suffix:semicolon
id|write_reg
c_func
(paren
id|info
comma
id|XAD2
comma
id|patterns
(braket
(paren
id|i
op_plus
l_int|1
)paren
op_mod
id|count
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|read_reg
c_func
(paren
id|info
comma
id|XAD1
)paren
op_ne
id|patterns
(braket
id|i
)braket
)paren
op_logical_or
(paren
id|read_reg
c_func
(paren
id|info
comma
id|XAD2
)paren
op_ne
id|patterns
(braket
(paren
id|i
op_plus
l_int|1
)paren
op_mod
id|count
)braket
)paren
)paren
(brace
id|rc
op_assign
id|FALSE
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|irq_test
id|BOOLEAN
id|irq_test
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
)paren
(brace
r_int
r_int
id|end_time
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|reset_device
c_func
(paren
id|info
)paren
suffix:semicolon
id|info-&gt;testing_irq
op_assign
id|TRUE
suffix:semicolon
id|hdlc_mode
c_func
(paren
id|info
)paren
suffix:semicolon
id|info-&gt;irq_occurred
op_assign
id|FALSE
suffix:semicolon
multiline_comment|/* init hdlc mode */
id|irq_enable
c_func
(paren
id|info
comma
id|CHA
comma
id|IRQ_TIMER
)paren
suffix:semicolon
id|write_reg
c_func
(paren
id|info
comma
id|CHA
op_plus
id|TIMR
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* 512 cycles */
id|issue_command
c_func
(paren
id|info
comma
id|CHA
comma
id|CMD_START_TIMER
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|end_time
op_assign
l_int|100
suffix:semicolon
r_while
c_loop
(paren
id|end_time
op_decrement
op_logical_and
op_logical_neg
id|info-&gt;irq_occurred
)paren
(brace
id|msleep_interruptible
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
id|info-&gt;testing_irq
op_assign
id|FALSE
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|reset_device
c_func
(paren
id|info
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|info-&gt;irq_occurred
ques
c_cond
id|TRUE
suffix:colon
id|FALSE
suffix:semicolon
)brace
DECL|function|adapter_test
r_int
id|adapter_test
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|register_test
c_func
(paren
id|info
)paren
)paren
(brace
id|info-&gt;init_error
op_assign
id|DiagStatus_AddressFailure
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s(%d):Register test failure for device %s Addr=%04X&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
comma
(paren
r_int
r_int
)paren
(paren
id|info-&gt;io_base
)paren
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|irq_test
c_func
(paren
id|info
)paren
)paren
(brace
id|info-&gt;init_error
op_assign
id|DiagStatus_IrqFailure
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s(%d):Interrupt test failure for device %s IRQ=%d&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
comma
(paren
r_int
r_int
)paren
(paren
id|info-&gt;irq_level
)paren
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):device %s passed diagnostics&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|trace_block
r_void
id|trace_block
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
comma
r_const
r_char
op_star
id|data
comma
r_int
id|count
comma
r_int
id|xmit
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|linecount
suffix:semicolon
r_if
c_cond
(paren
id|xmit
)paren
id|printk
c_func
(paren
l_string|&quot;%s tx data:&bslash;n&quot;
comma
id|info-&gt;device_name
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
l_string|&quot;%s rx data:&bslash;n&quot;
comma
id|info-&gt;device_name
)paren
suffix:semicolon
r_while
c_loop
(paren
id|count
)paren
(brace
r_if
c_cond
(paren
id|count
OG
l_int|16
)paren
id|linecount
op_assign
l_int|16
suffix:semicolon
r_else
id|linecount
op_assign
id|count
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|linecount
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%02X &quot;
comma
(paren
r_int
r_char
)paren
id|data
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
suffix:semicolon
id|i
OL
l_int|17
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;   &quot;
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|linecount
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|data
(braket
id|i
)braket
op_ge
l_int|040
op_logical_and
id|data
(braket
id|i
)braket
op_le
l_int|0176
)paren
id|printk
c_func
(paren
l_string|&quot;%c&quot;
comma
id|data
(braket
id|i
)braket
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
l_string|&quot;.&quot;
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|data
op_add_assign
id|linecount
suffix:semicolon
id|count
op_sub_assign
id|linecount
suffix:semicolon
)brace
)brace
multiline_comment|/* HDLC frame time out&n; * update stats and do tx completion processing&n; */
DECL|function|tx_timeout
r_void
id|tx_timeout
c_func
(paren
r_int
r_int
id|context
)paren
(brace
id|MGSLPC_INFO
op_star
id|info
op_assign
(paren
id|MGSLPC_INFO
op_star
)paren
id|context
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):tx_timeout(%s)&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;tx_active
op_logical_and
id|info-&gt;params.mode
op_eq
id|MGSL_MODE_HDLC
)paren
(brace
id|info-&gt;icount.txtimeout
op_increment
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|info-&gt;tx_active
op_assign
l_int|0
suffix:semicolon
id|info-&gt;tx_count
op_assign
id|info-&gt;tx_put
op_assign
id|info-&gt;tx_get
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_HDLC
r_if
c_cond
(paren
id|info-&gt;netcount
)paren
id|hdlcdev_tx_done
c_func
(paren
id|info
)paren
suffix:semicolon
r_else
macro_line|#endif
id|bh_transmit
c_func
(paren
id|info
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_HDLC
multiline_comment|/**&n; * called by generic HDLC layer when protocol selected (PPP, frame relay, etc.)&n; * set encoding and frame check sequence (FCS) options&n; *&n; * dev       pointer to network device structure&n; * encoding  serial encoding setting&n; * parity    FCS setting&n; *&n; * returns 0 if success, otherwise error code&n; */
DECL|function|hdlcdev_attach
r_static
r_int
id|hdlcdev_attach
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
r_int
id|encoding
comma
r_int
r_int
id|parity
)paren
(brace
id|MGSLPC_INFO
op_star
id|info
op_assign
id|dev_to_port
c_func
(paren
id|dev
)paren
suffix:semicolon
r_int
r_char
id|new_encoding
suffix:semicolon
r_int
r_int
id|new_crctype
suffix:semicolon
multiline_comment|/* return error if TTY interface open */
r_if
c_cond
(paren
id|info-&gt;count
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
r_switch
c_cond
(paren
id|encoding
)paren
(brace
r_case
id|ENCODING_NRZ
suffix:colon
id|new_encoding
op_assign
id|HDLC_ENCODING_NRZ
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ENCODING_NRZI
suffix:colon
id|new_encoding
op_assign
id|HDLC_ENCODING_NRZI_SPACE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ENCODING_FM_MARK
suffix:colon
id|new_encoding
op_assign
id|HDLC_ENCODING_BIPHASE_MARK
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ENCODING_FM_SPACE
suffix:colon
id|new_encoding
op_assign
id|HDLC_ENCODING_BIPHASE_SPACE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ENCODING_MANCHESTER
suffix:colon
id|new_encoding
op_assign
id|HDLC_ENCODING_BIPHASE_LEVEL
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|parity
)paren
(brace
r_case
id|PARITY_NONE
suffix:colon
id|new_crctype
op_assign
id|HDLC_CRC_NONE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PARITY_CRC16_PR1_CCITT
suffix:colon
id|new_crctype
op_assign
id|HDLC_CRC_16_CCITT
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PARITY_CRC32_PR1_CCITT
suffix:colon
id|new_crctype
op_assign
id|HDLC_CRC_32_CCITT
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|info-&gt;params.encoding
op_assign
id|new_encoding
suffix:semicolon
id|info-&gt;params.crc_type
op_assign
id|new_crctype
suffix:semicolon
suffix:semicolon
multiline_comment|/* if network interface up, reprogram hardware */
r_if
c_cond
(paren
id|info-&gt;netcount
)paren
id|mgslpc_program_hw
c_func
(paren
id|info
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * called by generic HDLC layer to send frame&n; *&n; * skb  socket buffer containing HDLC frame&n; * dev  pointer to network device structure&n; *&n; * returns 0 if success, otherwise error code&n; */
DECL|function|hdlcdev_xmit
r_static
r_int
id|hdlcdev_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|MGSLPC_INFO
op_star
id|info
op_assign
id|dev_to_port
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|net_device_stats
op_star
id|stats
op_assign
id|hdlc_stats
c_func
(paren
id|dev
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:hdlc_xmit(%s)&bslash;n&quot;
comma
id|__FILE__
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/* stop sending until this frame completes */
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* copy data to device buffers */
id|memcpy
c_func
(paren
id|info-&gt;tx_buf
comma
id|skb-&gt;data
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|info-&gt;tx_get
op_assign
l_int|0
suffix:semicolon
id|info-&gt;tx_put
op_assign
id|info-&gt;tx_count
op_assign
id|skb-&gt;len
suffix:semicolon
multiline_comment|/* update network statistics */
id|stats-&gt;tx_packets
op_increment
suffix:semicolon
id|stats-&gt;tx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
multiline_comment|/* done with socket buffer, so free it */
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
multiline_comment|/* save start time for transmit timeout detection */
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
multiline_comment|/* start hardware transmitter if necessary */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;tx_active
)paren
id|tx_start
c_func
(paren
id|info
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * called by network layer when interface enabled&n; * claim resources and initialize hardware&n; *&n; * dev  pointer to network device structure&n; *&n; * returns 0 if success, otherwise error code&n; */
DECL|function|hdlcdev_open
r_static
r_int
id|hdlcdev_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|MGSLPC_INFO
op_star
id|info
op_assign
id|dev_to_port
c_func
(paren
id|dev
)paren
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s:hdlcdev_open(%s)&bslash;n&quot;
comma
id|__FILE__
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/* generic HDLC layer open processing */
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|hdlc_open
c_func
(paren
id|dev
)paren
)paren
)paren
r_return
id|rc
suffix:semicolon
multiline_comment|/* arbitrate between network and tty opens */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;netlock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;count
op_ne
l_int|0
op_logical_or
id|info-&gt;netcount
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: hdlc_open returning busy&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;netlock
comma
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|info-&gt;netcount
op_assign
l_int|1
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;netlock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* claim resources and init adapter */
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|startup
c_func
(paren
id|info
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;netlock
comma
id|flags
)paren
suffix:semicolon
id|info-&gt;netcount
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;netlock
comma
id|flags
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/* assert DTR and RTS, apply hardware settings */
id|info-&gt;serial_signals
op_or_assign
id|SerialSignal_RTS
op_plus
id|SerialSignal_DTR
suffix:semicolon
id|mgslpc_program_hw
c_func
(paren
id|info
)paren
suffix:semicolon
multiline_comment|/* enable network layer transmit */
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* inform generic HDLC layer of current DCD status */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|get_signals
c_func
(paren
id|info
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|hdlc_set_carrier
c_func
(paren
id|info-&gt;serial_signals
op_amp
id|SerialSignal_DCD
comma
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * called by network layer when interface is disabled&n; * shutdown hardware and release resources&n; *&n; * dev  pointer to network device structure&n; *&n; * returns 0 if success, otherwise error code&n; */
DECL|function|hdlcdev_close
r_static
r_int
id|hdlcdev_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|MGSLPC_INFO
op_star
id|info
op_assign
id|dev_to_port
c_func
(paren
id|dev
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s:hdlcdev_close(%s)&bslash;n&quot;
comma
id|__FILE__
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* shutdown adapter and release resources */
id|shutdown
c_func
(paren
id|info
)paren
suffix:semicolon
id|hdlc_close
c_func
(paren
id|dev
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;netlock
comma
id|flags
)paren
suffix:semicolon
id|info-&gt;netcount
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;netlock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * called by network layer to process IOCTL call to network device&n; *&n; * dev  pointer to network device structure&n; * ifr  pointer to network interface request structure&n; * cmd  IOCTL command code&n; *&n; * returns 0 if success, otherwise error code&n; */
DECL|function|hdlcdev_ioctl
r_static
r_int
id|hdlcdev_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|ifr
comma
r_int
id|cmd
)paren
(brace
r_const
r_int
id|size
op_assign
r_sizeof
(paren
id|sync_serial_settings
)paren
suffix:semicolon
id|sync_serial_settings
id|new_line
suffix:semicolon
id|sync_serial_settings
id|__user
op_star
id|line
op_assign
id|ifr-&gt;ifr_settings.ifs_ifsu.sync
suffix:semicolon
id|MGSLPC_INFO
op_star
id|info
op_assign
id|dev_to_port
c_func
(paren
id|dev
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s:hdlcdev_ioctl(%s)&bslash;n&quot;
comma
id|__FILE__
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/* return error if TTY interface open */
r_if
c_cond
(paren
id|info-&gt;count
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_ne
id|SIOCWANDEV
)paren
r_return
id|hdlc_ioctl
c_func
(paren
id|dev
comma
id|ifr
comma
id|cmd
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|ifr-&gt;ifr_settings.type
)paren
(brace
r_case
id|IF_GET_IFACE
suffix:colon
multiline_comment|/* return current sync_serial_settings */
id|ifr-&gt;ifr_settings.type
op_assign
id|IF_IFACE_SYNC_SERIAL
suffix:semicolon
r_if
c_cond
(paren
id|ifr-&gt;ifr_settings.size
OL
id|size
)paren
(brace
id|ifr-&gt;ifr_settings.size
op_assign
id|size
suffix:semicolon
multiline_comment|/* data size wanted */
r_return
op_minus
id|ENOBUFS
suffix:semicolon
)brace
id|flags
op_assign
id|info-&gt;params.flags
op_amp
(paren
id|HDLC_FLAG_RXC_RXCPIN
op_or
id|HDLC_FLAG_RXC_DPLL
op_or
id|HDLC_FLAG_RXC_BRG
op_or
id|HDLC_FLAG_RXC_TXCPIN
op_or
id|HDLC_FLAG_TXC_TXCPIN
op_or
id|HDLC_FLAG_TXC_DPLL
op_or
id|HDLC_FLAG_TXC_BRG
op_or
id|HDLC_FLAG_TXC_RXCPIN
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|flags
)paren
(brace
r_case
(paren
id|HDLC_FLAG_RXC_RXCPIN
op_or
id|HDLC_FLAG_TXC_TXCPIN
)paren
suffix:colon
id|new_line.clock_type
op_assign
id|CLOCK_EXT
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
id|HDLC_FLAG_RXC_BRG
op_or
id|HDLC_FLAG_TXC_BRG
)paren
suffix:colon
id|new_line.clock_type
op_assign
id|CLOCK_INT
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
id|HDLC_FLAG_RXC_RXCPIN
op_or
id|HDLC_FLAG_TXC_BRG
)paren
suffix:colon
id|new_line.clock_type
op_assign
id|CLOCK_TXINT
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
id|HDLC_FLAG_RXC_RXCPIN
op_or
id|HDLC_FLAG_TXC_RXCPIN
)paren
suffix:colon
id|new_line.clock_type
op_assign
id|CLOCK_TXFROMRX
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|new_line.clock_type
op_assign
id|CLOCK_DEFAULT
suffix:semicolon
)brace
id|new_line.clock_rate
op_assign
id|info-&gt;params.clock_speed
suffix:semicolon
id|new_line.loopback
op_assign
id|info-&gt;params.loopback
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|line
comma
op_amp
id|new_line
comma
id|size
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|IF_IFACE_SYNC_SERIAL
suffix:colon
multiline_comment|/* set sync_serial_settings */
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
(brace
r_return
op_minus
id|EPERM
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|new_line
comma
id|line
comma
id|size
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_switch
c_cond
(paren
id|new_line.clock_type
)paren
(brace
r_case
id|CLOCK_EXT
suffix:colon
id|flags
op_assign
id|HDLC_FLAG_RXC_RXCPIN
op_or
id|HDLC_FLAG_TXC_TXCPIN
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CLOCK_TXFROMRX
suffix:colon
id|flags
op_assign
id|HDLC_FLAG_RXC_RXCPIN
op_or
id|HDLC_FLAG_TXC_RXCPIN
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CLOCK_INT
suffix:colon
id|flags
op_assign
id|HDLC_FLAG_RXC_BRG
op_or
id|HDLC_FLAG_TXC_BRG
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CLOCK_TXINT
suffix:colon
id|flags
op_assign
id|HDLC_FLAG_RXC_RXCPIN
op_or
id|HDLC_FLAG_TXC_BRG
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CLOCK_DEFAULT
suffix:colon
id|flags
op_assign
id|info-&gt;params.flags
op_amp
(paren
id|HDLC_FLAG_RXC_RXCPIN
op_or
id|HDLC_FLAG_RXC_DPLL
op_or
id|HDLC_FLAG_RXC_BRG
op_or
id|HDLC_FLAG_RXC_TXCPIN
op_or
id|HDLC_FLAG_TXC_TXCPIN
op_or
id|HDLC_FLAG_TXC_DPLL
op_or
id|HDLC_FLAG_TXC_BRG
op_or
id|HDLC_FLAG_TXC_RXCPIN
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|new_line.loopback
op_ne
l_int|0
op_logical_and
id|new_line.loopback
op_ne
l_int|1
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|info-&gt;params.flags
op_and_assign
op_complement
(paren
id|HDLC_FLAG_RXC_RXCPIN
op_or
id|HDLC_FLAG_RXC_DPLL
op_or
id|HDLC_FLAG_RXC_BRG
op_or
id|HDLC_FLAG_RXC_TXCPIN
op_or
id|HDLC_FLAG_TXC_TXCPIN
op_or
id|HDLC_FLAG_TXC_DPLL
op_or
id|HDLC_FLAG_TXC_BRG
op_or
id|HDLC_FLAG_TXC_RXCPIN
)paren
suffix:semicolon
id|info-&gt;params.flags
op_or_assign
id|flags
suffix:semicolon
id|info-&gt;params.loopback
op_assign
id|new_line.loopback
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
(paren
id|HDLC_FLAG_RXC_BRG
op_or
id|HDLC_FLAG_TXC_BRG
)paren
)paren
id|info-&gt;params.clock_speed
op_assign
id|new_line.clock_rate
suffix:semicolon
r_else
id|info-&gt;params.clock_speed
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* if network interface up, reprogram hardware */
r_if
c_cond
(paren
id|info-&gt;netcount
)paren
id|mgslpc_program_hw
c_func
(paren
id|info
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_default
suffix:colon
r_return
id|hdlc_ioctl
c_func
(paren
id|dev
comma
id|ifr
comma
id|cmd
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; * called by network layer when transmit timeout is detected&n; *&n; * dev  pointer to network device structure&n; */
DECL|function|hdlcdev_tx_timeout
r_static
r_void
id|hdlcdev_tx_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|MGSLPC_INFO
op_star
id|info
op_assign
id|dev_to_port
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|net_device_stats
op_star
id|stats
op_assign
id|hdlc_stats
c_func
(paren
id|dev
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;hdlcdev_tx_timeout(%s)&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|stats-&gt;tx_errors
op_increment
suffix:semicolon
id|stats-&gt;tx_aborted_errors
op_increment
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|tx_stop
c_func
(paren
id|info
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * called by device driver when transmit completes&n; * reenable network layer transmit if stopped&n; *&n; * info  pointer to device instance information&n; */
DECL|function|hdlcdev_tx_done
r_static
r_void
id|hdlcdev_tx_done
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
)paren
(brace
r_if
c_cond
(paren
id|netif_queue_stopped
c_func
(paren
id|info-&gt;netdev
)paren
)paren
id|netif_wake_queue
c_func
(paren
id|info-&gt;netdev
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * called by device driver when frame received&n; * pass frame to network layer&n; *&n; * info  pointer to device instance information&n; * buf   pointer to buffer contianing frame data&n; * size  count of data bytes in buf&n; */
DECL|function|hdlcdev_rx
r_static
r_void
id|hdlcdev_rx
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
comma
r_char
op_star
id|buf
comma
r_int
id|size
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|size
)paren
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
id|info-&gt;netdev
suffix:semicolon
r_struct
id|net_device_stats
op_star
id|stats
op_assign
id|hdlc_stats
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;hdlcdev_rx(%s)&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;%s: can&squot;t alloc skb, dropping packet&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|stats-&gt;rx_dropped
op_increment
suffix:semicolon
r_return
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|size
)paren
comma
id|buf
comma
id|size
)paren
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|hdlc_type_trans
c_func
(paren
id|skb
comma
id|info-&gt;netdev
)paren
suffix:semicolon
id|stats-&gt;rx_packets
op_increment
suffix:semicolon
id|stats-&gt;rx_bytes
op_add_assign
id|size
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
id|info-&gt;netdev-&gt;last_rx
op_assign
id|jiffies
suffix:semicolon
)brace
multiline_comment|/**&n; * called by device driver when adding device instance&n; * do generic HDLC initialization&n; *&n; * info  pointer to device instance information&n; *&n; * returns 0 if success, otherwise error code&n; */
DECL|function|hdlcdev_init
r_static
r_int
id|hdlcdev_init
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
)paren
(brace
r_int
id|rc
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
id|hdlc_device
op_star
id|hdlc
suffix:semicolon
multiline_comment|/* allocate and initialize network and HDLC layer objects */
r_if
c_cond
(paren
op_logical_neg
(paren
id|dev
op_assign
id|alloc_hdlcdev
c_func
(paren
id|info
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s:hdlc device allocation failure&bslash;n&quot;
comma
id|__FILE__
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/* for network layer reporting purposes only */
id|dev-&gt;base_addr
op_assign
id|info-&gt;io_base
suffix:semicolon
id|dev-&gt;irq
op_assign
id|info-&gt;irq_level
suffix:semicolon
multiline_comment|/* network layer callbacks and settings */
id|dev-&gt;do_ioctl
op_assign
id|hdlcdev_ioctl
suffix:semicolon
id|dev-&gt;open
op_assign
id|hdlcdev_open
suffix:semicolon
id|dev-&gt;stop
op_assign
id|hdlcdev_close
suffix:semicolon
id|dev-&gt;tx_timeout
op_assign
id|hdlcdev_tx_timeout
suffix:semicolon
id|dev-&gt;watchdog_timeo
op_assign
l_int|10
op_star
id|HZ
suffix:semicolon
id|dev-&gt;tx_queue_len
op_assign
l_int|50
suffix:semicolon
multiline_comment|/* generic HDLC layer callbacks and settings */
id|hdlc
op_assign
id|dev_to_hdlc
c_func
(paren
id|dev
)paren
suffix:semicolon
id|hdlc-&gt;attach
op_assign
id|hdlcdev_attach
suffix:semicolon
id|hdlc-&gt;xmit
op_assign
id|hdlcdev_xmit
suffix:semicolon
multiline_comment|/* register objects with HDLC layer */
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|register_hdlc_device
c_func
(paren
id|dev
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s:unable to register hdlc device&bslash;n&quot;
comma
id|__FILE__
)paren
suffix:semicolon
id|free_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|info-&gt;netdev
op_assign
id|dev
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * called by device driver when removing device instance&n; * do generic HDLC cleanup&n; *&n; * info  pointer to device instance information&n; */
DECL|function|hdlcdev_exit
r_static
r_void
id|hdlcdev_exit
c_func
(paren
id|MGSLPC_INFO
op_star
id|info
)paren
(brace
id|unregister_hdlc_device
c_func
(paren
id|info-&gt;netdev
)paren
suffix:semicolon
id|free_netdev
c_func
(paren
id|info-&gt;netdev
)paren
suffix:semicolon
id|info-&gt;netdev
op_assign
l_int|NULL
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_HDLC */
eof
