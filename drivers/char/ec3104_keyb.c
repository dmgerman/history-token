multiline_comment|/*&n; * linux/drivers/char/ec3104_keyb.c&n; * &n; * Copyright (C) 2000 Philipp Rumpf &lt;prumpf@tux.org&gt;&n; *&n; * based on linux/drivers/char/pc_keyb.c, which had the following comments:&n; *&n; * Separation of the PC low-level part by Geert Uytterhoeven, May 1997&n; * See keyboard.c for the whole history.&n; *&n; * Major cleanup by Martin Mares, May 1997&n; *&n; * Combined the keyboard and PS/2 mouse handling into one file,&n; * because they share the same hardware.&n; * Johan Myreen &lt;jem@iki.fi&gt; 1998-10-08.&n; *&n; * Code fixes to handle mouse ACKs properly.&n; * C. Scott Ananian &lt;cananian@alumni.princeton.edu&gt; 1999-01-29.&n; */
multiline_comment|/* EC3104 note:&n; * This code was written without any documentation about the EC3104 chip.  While&n; * I hope I got most of the basic functionality right, the register names I use&n; * are most likely completely different from those in the chip documentation.&n; *&n; * If you have any further information about the EC3104, please tell me&n; * (prumpf@tux.org).&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/signal.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/kbd_ll.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/random.h&gt;
macro_line|#include &lt;linux/poll.h&gt;
macro_line|#include &lt;linux/miscdevice.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/kbd_kern.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;asm/keyboard.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/ec3104.h&gt;
macro_line|#include &lt;asm/io.h&gt;
multiline_comment|/* Some configuration switches are present in the include file... */
macro_line|#include &lt;linux/pc_keyb.h&gt;
DECL|macro|MSR_CTS
mdefine_line|#define MSR_CTS 0x10
DECL|macro|MCR_RTS
mdefine_line|#define MCR_RTS 0x02
DECL|macro|LSR_DR
mdefine_line|#define LSR_DR 0x01
DECL|macro|LSR_BOTH_EMPTY
mdefine_line|#define LSR_BOTH_EMPTY 0x60
DECL|struct|e5_struct
r_static
r_struct
id|e5_struct
(brace
DECL|member|packet
id|u8
id|packet
(braket
l_int|8
)braket
suffix:semicolon
DECL|member|pos
r_int
id|pos
suffix:semicolon
DECL|member|length
r_int
id|length
suffix:semicolon
DECL|member|cached_mcr
id|u8
id|cached_mcr
suffix:semicolon
DECL|member|last_msr
id|u8
id|last_msr
suffix:semicolon
DECL|variable|ec3104_keyb
)brace
id|ec3104_keyb
suffix:semicolon
multiline_comment|/* Simple translation table for the SysRq keys */
macro_line|#ifdef CONFIG_MAGIC_SYSRQ
DECL|variable|ec3104_kbd_sysrq_xlate
r_int
r_char
id|ec3104_kbd_sysrq_xlate
(braket
l_int|128
)braket
op_assign
l_string|&quot;&bslash;000&bslash;0331234567890-=&bslash;177&bslash;t&quot;
multiline_comment|/* 0x00 - 0x0f */
l_string|&quot;qwertyuiop[]&bslash;r&bslash;000as&quot;
multiline_comment|/* 0x10 - 0x1f */
l_string|&quot;dfghjkl;&squot;`&bslash;000&bslash;&bslash;zxcv&quot;
multiline_comment|/* 0x20 - 0x2f */
l_string|&quot;bnm,./&bslash;000*&bslash;000 &bslash;000&bslash;201&bslash;202&bslash;203&bslash;204&bslash;205&quot;
multiline_comment|/* 0x30 - 0x3f */
l_string|&quot;&bslash;206&bslash;207&bslash;210&bslash;211&bslash;212&bslash;000&bslash;000789-456+1&quot;
multiline_comment|/* 0x40 - 0x4f */
l_string|&quot;230&bslash;177&bslash;000&bslash;000&bslash;213&bslash;214&bslash;000&bslash;000&bslash;000&bslash;000&bslash;000&bslash;000&bslash;000&bslash;000&bslash;000&bslash;000&quot;
multiline_comment|/* 0x50 - 0x5f */
l_string|&quot;&bslash;r&bslash;000/&quot;
suffix:semicolon
multiline_comment|/* 0x60 - 0x6f */
macro_line|#endif
r_static
r_void
id|kbd_write_command_w
c_func
(paren
r_int
id|data
)paren
suffix:semicolon
r_static
r_void
id|kbd_write_output_w
c_func
(paren
r_int
id|data
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_PSMOUSE
r_static
r_void
id|aux_write_ack
c_func
(paren
r_int
id|val
)paren
suffix:semicolon
r_static
r_void
id|__aux_write_ack
c_func
(paren
r_int
id|val
)paren
suffix:semicolon
macro_line|#endif
DECL|variable|kbd_controller_lock
r_static
id|spinlock_t
id|kbd_controller_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
r_static
r_int
r_char
id|handle_kbd_event
c_func
(paren
r_void
)paren
suffix:semicolon
multiline_comment|/* used only by send_data - set by keyboard_interrupt */
DECL|variable|reply_expected
r_static
r_volatile
r_int
r_char
id|reply_expected
suffix:semicolon
DECL|variable|acknowledge
r_static
r_volatile
r_int
r_char
id|acknowledge
suffix:semicolon
DECL|variable|resend
r_static
r_volatile
r_int
r_char
id|resend
suffix:semicolon
DECL|function|ec3104_kbd_setkeycode
r_int
id|ec3104_kbd_setkeycode
c_func
(paren
r_int
r_int
id|scancode
comma
r_int
r_int
id|keycode
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ec3104_kbd_getkeycode
r_int
id|ec3104_kbd_getkeycode
c_func
(paren
r_int
r_int
id|scancode
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* yes, it probably would be faster to use an array.  I don&squot;t care. */
DECL|function|ec3104_scan2key
r_static
r_inline
r_int
r_char
id|ec3104_scan2key
c_func
(paren
r_int
r_char
id|scancode
)paren
(brace
r_switch
c_cond
(paren
id|scancode
)paren
(brace
r_case
l_int|1
suffix:colon
multiline_comment|/* &squot;`&squot; */
r_return
l_int|41
suffix:semicolon
r_case
l_int|2
dot
dot
dot
l_int|27
suffix:colon
r_return
id|scancode
suffix:semicolon
r_case
l_int|28
suffix:colon
multiline_comment|/* &squot;&bslash;&bslash;&squot; */
r_return
l_int|43
suffix:semicolon
r_case
l_int|29
dot
dot
dot
l_int|39
suffix:colon
r_return
id|scancode
op_plus
l_int|1
suffix:semicolon
r_case
l_int|40
suffix:colon
multiline_comment|/* &squot;&bslash;r&squot; */
r_return
l_int|28
suffix:semicolon
r_case
l_int|41
dot
dot
dot
l_int|50
suffix:colon
r_return
id|scancode
op_plus
l_int|3
suffix:semicolon
r_case
l_int|51
suffix:colon
multiline_comment|/* &squot; &squot; */
r_return
l_int|57
suffix:semicolon
r_case
l_int|52
suffix:colon
multiline_comment|/* escape */
r_return
l_int|1
suffix:semicolon
r_case
l_int|54
suffix:colon
multiline_comment|/* insert/delete (labelled delete) */
multiline_comment|/* this should arguably be 110, but I&squot;d like to have ctrl-alt-del&n;&t;&t; * working with a standard keymap */
r_return
l_int|111
suffix:semicolon
r_case
l_int|55
suffix:colon
multiline_comment|/* left */
r_return
l_int|105
suffix:semicolon
r_case
l_int|56
suffix:colon
multiline_comment|/* home */
r_return
l_int|102
suffix:semicolon
r_case
l_int|57
suffix:colon
multiline_comment|/* end */
r_return
l_int|107
suffix:semicolon
r_case
l_int|58
suffix:colon
multiline_comment|/* up */
r_return
l_int|103
suffix:semicolon
r_case
l_int|59
suffix:colon
multiline_comment|/* down */
r_return
l_int|108
suffix:semicolon
r_case
l_int|60
suffix:colon
multiline_comment|/* pgup */
r_return
l_int|104
suffix:semicolon
r_case
l_int|61
suffix:colon
multiline_comment|/* pgdown */
r_return
l_int|109
suffix:semicolon
r_case
l_int|62
suffix:colon
multiline_comment|/* right */
r_return
l_int|106
suffix:semicolon
r_case
l_int|79
dot
dot
dot
l_int|88
suffix:colon
multiline_comment|/* f1 - f10 */
r_return
id|scancode
op_minus
l_int|20
suffix:semicolon
r_case
l_int|89
dot
dot
dot
l_int|90
suffix:colon
multiline_comment|/* f11 - f12 */
r_return
id|scancode
op_minus
l_int|2
suffix:semicolon
r_case
l_int|91
suffix:colon
multiline_comment|/* left shift */
r_return
l_int|42
suffix:semicolon
r_case
l_int|92
suffix:colon
multiline_comment|/* right shift */
r_return
l_int|54
suffix:semicolon
r_case
l_int|93
suffix:colon
multiline_comment|/* left alt */
r_return
l_int|56
suffix:semicolon
r_case
l_int|94
suffix:colon
multiline_comment|/* right alt */
r_return
l_int|100
suffix:semicolon
r_case
l_int|95
suffix:colon
multiline_comment|/* left ctrl */
r_return
l_int|29
suffix:semicolon
r_case
l_int|96
suffix:colon
multiline_comment|/* right ctrl */
r_return
l_int|97
suffix:semicolon
r_case
l_int|97
suffix:colon
multiline_comment|/* caps lock */
r_return
l_int|58
suffix:semicolon
r_case
l_int|102
suffix:colon
multiline_comment|/* left windows */
r_return
l_int|125
suffix:semicolon
r_case
l_int|103
suffix:colon
multiline_comment|/* right windows */
r_return
l_int|126
suffix:semicolon
r_case
l_int|106
suffix:colon
multiline_comment|/* Fn */
multiline_comment|/* this is wrong. */
r_return
l_int|84
suffix:semicolon
r_default
suffix:colon
r_return
l_int|0
suffix:semicolon
)brace
)brace
DECL|function|ec3104_kbd_translate
r_int
id|ec3104_kbd_translate
c_func
(paren
r_int
r_char
id|scancode
comma
r_int
r_char
op_star
id|keycode
comma
r_char
id|raw_mode
)paren
(brace
id|scancode
op_and_assign
l_int|0x7f
suffix:semicolon
op_star
id|keycode
op_assign
id|ec3104_scan2key
c_func
(paren
id|scancode
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|ec3104_kbd_unexpected_up
r_char
id|ec3104_kbd_unexpected_up
c_func
(paren
r_int
r_char
id|keycode
)paren
(brace
r_return
l_int|0200
suffix:semicolon
)brace
DECL|function|handle_keyboard_event
r_static
r_inline
r_void
id|handle_keyboard_event
c_func
(paren
r_int
r_char
id|scancode
)paren
(brace
macro_line|#ifdef CONFIG_VT
id|handle_scancode
c_func
(paren
id|scancode
comma
op_logical_neg
(paren
id|scancode
op_amp
l_int|0x80
)paren
)paren
suffix:semicolon
macro_line|#endif&t;&t;&t;&t;
id|tasklet_schedule
c_func
(paren
op_amp
id|keyboard_tasklet
)paren
suffix:semicolon
)brace
DECL|function|ec3104_kbd_leds
r_void
id|ec3104_kbd_leds
c_func
(paren
r_int
r_char
id|leds
)paren
(brace
)brace
DECL|function|e5_checksum
r_static
id|u8
id|e5_checksum
c_func
(paren
id|u8
op_star
id|packet
comma
r_int
id|count
)paren
(brace
r_int
id|i
suffix:semicolon
id|u8
id|sum
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
suffix:semicolon
id|i
op_increment
)paren
id|sum
op_xor_assign
id|packet
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|sum
op_amp
l_int|0x80
)paren
id|sum
op_xor_assign
l_int|0xc0
suffix:semicolon
r_return
id|sum
suffix:semicolon
)brace
DECL|function|e5_wait_for_cts
r_static
r_void
id|e5_wait_for_cts
c_func
(paren
r_struct
id|e5_struct
op_star
id|k
)paren
(brace
id|u8
id|msr
suffix:semicolon
r_do
(brace
id|msr
op_assign
id|ctrl_inb
c_func
(paren
id|EC3104_SER4_MSR
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
op_logical_neg
(paren
id|msr
op_amp
id|MSR_CTS
)paren
)paren
suffix:semicolon
)brace
DECL|function|e5_send_byte
r_static
r_void
id|e5_send_byte
c_func
(paren
id|u8
id|byte
comma
r_struct
id|e5_struct
op_star
id|k
)paren
(brace
id|u8
id|status
suffix:semicolon
r_do
(brace
id|status
op_assign
id|ctrl_inb
c_func
(paren
id|EC3104_SER4_LSR
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|status
op_amp
id|LSR_BOTH_EMPTY
)paren
op_ne
id|LSR_BOTH_EMPTY
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&lt;%02x&gt;&quot;
comma
id|byte
)paren
suffix:semicolon
id|ctrl_outb
c_func
(paren
id|byte
comma
id|EC3104_SER4_DATA
)paren
suffix:semicolon
r_do
(brace
id|status
op_assign
id|ctrl_inb
c_func
(paren
id|EC3104_SER4_LSR
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|status
op_amp
id|LSR_BOTH_EMPTY
)paren
op_ne
id|LSR_BOTH_EMPTY
)paren
suffix:semicolon
)brace
DECL|function|e5_send_packet
r_static
r_int
id|e5_send_packet
c_func
(paren
id|u8
op_star
id|packet
comma
r_int
id|count
comma
r_struct
id|e5_struct
op_star
id|k
)paren
(brace
r_int
id|i
suffix:semicolon
id|disable_irq
c_func
(paren
id|EC3104_IRQ_SER4
)paren
suffix:semicolon
r_if
c_cond
(paren
id|k-&gt;cached_mcr
op_amp
id|MCR_RTS
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;e5_send_packet: too slow&bslash;n&quot;
)paren
suffix:semicolon
id|enable_irq
c_func
(paren
id|EC3104_IRQ_SER4
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|k-&gt;cached_mcr
op_or_assign
id|MCR_RTS
suffix:semicolon
id|ctrl_outb
c_func
(paren
id|k-&gt;cached_mcr
comma
id|EC3104_SER4_MCR
)paren
suffix:semicolon
id|e5_wait_for_cts
c_func
(paren
id|k
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;p: &quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|e5_send_byte
c_func
(paren
id|packet
(braket
id|i
)braket
comma
id|k
)paren
suffix:semicolon
)brace
id|e5_send_byte
c_func
(paren
id|e5_checksum
c_func
(paren
id|packet
comma
id|count
)paren
comma
id|k
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1500
)paren
suffix:semicolon
id|k-&gt;cached_mcr
op_and_assign
op_complement
id|MCR_RTS
suffix:semicolon
id|ctrl_outb
c_func
(paren
id|k-&gt;cached_mcr
comma
id|EC3104_SER4_MCR
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|enable_irq
c_func
(paren
id|EC3104_IRQ_SER4
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * E5 packets we know about:&n; * E5-&gt;host 0x80 0x05 &lt;checksum&gt; - resend packet&n; * host-&gt;E5 0x83 0x43 &lt;contrast&gt; - set LCD contrast&n; * host-&gt;E5 0x85 0x41 0x02 &lt;brightness&gt; 0x02 - set LCD backlight&n; * E5-&gt;host 0x87 &lt;ps2 packet&gt; 0x00 &lt;checksum&gt; - external PS2 &n; * E5-&gt;host 0x88 &lt;scancode&gt; &lt;checksum&gt; - key press&n; */
DECL|function|e5_receive
r_static
r_void
id|e5_receive
c_func
(paren
r_struct
id|e5_struct
op_star
id|k
)paren
(brace
id|k-&gt;packet
(braket
id|k-&gt;pos
op_increment
)braket
op_assign
id|ctrl_inb
c_func
(paren
id|EC3104_SER4_DATA
)paren
suffix:semicolon
r_if
c_cond
(paren
id|k-&gt;pos
op_eq
l_int|1
)paren
(brace
r_switch
c_cond
(paren
id|k-&gt;packet
(braket
l_int|0
)braket
)paren
(brace
r_case
l_int|0x80
suffix:colon
id|k-&gt;length
op_assign
l_int|3
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x87
suffix:colon
multiline_comment|/* PS2 ext */
id|k-&gt;length
op_assign
l_int|6
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x88
suffix:colon
multiline_comment|/* keyboard */
id|k-&gt;length
op_assign
l_int|3
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|k-&gt;length
op_assign
l_int|1
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;unknown E5 packet %02x&bslash;n&quot;
comma
id|k-&gt;packet
(braket
l_int|0
)braket
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|k-&gt;pos
op_eq
id|k-&gt;length
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|e5_checksum
c_func
(paren
id|k-&gt;packet
comma
id|k-&gt;length
)paren
op_ne
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;E5: wrong checksum&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#if 0
id|printk
c_func
(paren
l_string|&quot;E5 packet [&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|k-&gt;length
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%02x &quot;
comma
id|k-&gt;packet
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;(%02x)]&bslash;n&quot;
comma
id|e5_checksum
c_func
(paren
id|k-&gt;packet
comma
id|k-&gt;length
op_minus
l_int|1
)paren
)paren
suffix:semicolon
macro_line|#endif
r_switch
c_cond
(paren
id|k-&gt;packet
(braket
l_int|0
)braket
)paren
(brace
r_case
l_int|0x80
suffix:colon
r_case
l_int|0x88
suffix:colon
id|handle_keyboard_event
c_func
(paren
id|k-&gt;packet
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|k-&gt;pos
op_assign
id|k-&gt;length
op_assign
l_int|0
suffix:semicolon
)brace
)brace
DECL|function|ec3104_keyb_interrupt
r_static
r_void
id|ec3104_keyb_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|data
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|e5_struct
op_star
id|k
op_assign
op_amp
id|ec3104_keyb
suffix:semicolon
id|u8
id|msr
comma
id|lsr
suffix:semicolon
id|kbd_pt_regs
op_assign
id|regs
suffix:semicolon
id|msr
op_assign
id|ctrl_inb
c_func
(paren
id|EC3104_SER4_MSR
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|msr
op_amp
id|MSR_CTS
)paren
op_logical_and
op_logical_neg
(paren
id|k-&gt;last_msr
op_amp
id|MSR_CTS
)paren
)paren
(brace
r_if
c_cond
(paren
id|k-&gt;cached_mcr
op_amp
id|MCR_RTS
)paren
id|printk
c_func
(paren
l_string|&quot;confused: RTS already high&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* CTS went high.  Send RTS. */
id|k-&gt;cached_mcr
op_or_assign
id|MCR_RTS
suffix:semicolon
id|ctrl_outb
c_func
(paren
id|k-&gt;cached_mcr
comma
id|EC3104_SER4_MCR
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
op_logical_neg
(paren
id|msr
op_amp
id|MSR_CTS
)paren
)paren
op_logical_and
(paren
id|k-&gt;last_msr
op_amp
id|MSR_CTS
)paren
)paren
(brace
multiline_comment|/* CTS went low. */
r_if
c_cond
(paren
op_logical_neg
(paren
id|k-&gt;cached_mcr
op_amp
id|MCR_RTS
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;confused: RTS already low&bslash;n&quot;
)paren
suffix:semicolon
id|k-&gt;cached_mcr
op_and_assign
op_complement
id|MCR_RTS
suffix:semicolon
id|ctrl_outb
c_func
(paren
id|k-&gt;cached_mcr
comma
id|EC3104_SER4_MCR
)paren
suffix:semicolon
)brace
id|k-&gt;last_msr
op_assign
id|msr
suffix:semicolon
id|lsr
op_assign
id|ctrl_inb
c_func
(paren
id|EC3104_SER4_LSR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lsr
op_amp
id|LSR_DR
)paren
id|e5_receive
c_func
(paren
id|k
)paren
suffix:semicolon
)brace
DECL|function|ec3104_keyb_clear_state
r_static
r_void
id|ec3104_keyb_clear_state
c_func
(paren
r_void
)paren
(brace
r_struct
id|e5_struct
op_star
id|k
op_assign
op_amp
id|ec3104_keyb
suffix:semicolon
id|u8
id|msr
comma
id|lsr
suffix:semicolon
multiline_comment|/* we want CTS to be low */
id|k-&gt;last_msr
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|schedule_timeout
c_func
(paren
id|HZ
op_div
l_int|10
)paren
suffix:semicolon
id|msr
op_assign
id|ctrl_inb
c_func
(paren
id|EC3104_SER4_MSR
)paren
suffix:semicolon
id|lsr
op_assign
id|ctrl_inb
c_func
(paren
id|EC3104_SER4_LSR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lsr
op_amp
id|LSR_DR
)paren
(brace
id|e5_receive
c_func
(paren
id|k
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|msr
op_amp
id|MSR_CTS
)paren
op_logical_and
op_logical_neg
(paren
id|k-&gt;last_msr
op_amp
id|MSR_CTS
)paren
)paren
(brace
r_if
c_cond
(paren
id|k-&gt;cached_mcr
op_amp
id|MCR_RTS
)paren
id|printk
c_func
(paren
l_string|&quot;confused: RTS already high&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* CTS went high.  Send RTS. */
id|k-&gt;cached_mcr
op_or_assign
id|MCR_RTS
suffix:semicolon
id|ctrl_outb
c_func
(paren
id|k-&gt;cached_mcr
comma
id|EC3104_SER4_MCR
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
op_logical_neg
(paren
id|msr
op_amp
id|MSR_CTS
)paren
)paren
op_logical_and
(paren
id|k-&gt;last_msr
op_amp
id|MSR_CTS
)paren
)paren
(brace
multiline_comment|/* CTS went low. */
r_if
c_cond
(paren
op_logical_neg
(paren
id|k-&gt;cached_mcr
op_amp
id|MCR_RTS
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;confused: RTS already low&bslash;n&quot;
)paren
suffix:semicolon
id|k-&gt;cached_mcr
op_and_assign
op_complement
id|MCR_RTS
suffix:semicolon
id|ctrl_outb
c_func
(paren
id|k-&gt;cached_mcr
comma
id|EC3104_SER4_MCR
)paren
suffix:semicolon
)brace
r_else
r_break
suffix:semicolon
id|k-&gt;last_msr
op_assign
id|msr
suffix:semicolon
r_continue
suffix:semicolon
)brace
)brace
DECL|function|ec3104_kbd_init_hw
r_void
id|__init
id|ec3104_kbd_init_hw
c_func
(paren
r_void
)paren
(brace
id|ec3104_keyb.last_msr
op_assign
id|ctrl_inb
c_func
(paren
id|EC3104_SER4_MSR
)paren
suffix:semicolon
id|ec3104_keyb.cached_mcr
op_assign
id|ctrl_inb
c_func
(paren
id|EC3104_SER4_MCR
)paren
suffix:semicolon
id|ec3104_keyb_clear_state
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Ok, finally allocate the IRQ, and off we go.. */
id|request_irq
c_func
(paren
id|EC3104_IRQ_SER4
comma
id|ec3104_keyb_interrupt
comma
l_int|0
comma
l_string|&quot;keyboard&quot;
comma
l_int|NULL
)paren
suffix:semicolon
)brace
eof
