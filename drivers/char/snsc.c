multiline_comment|/*&n; * SN Platform system controller communication support&n; *&n; * This file is subject to the terms and conditions of the GNU General Public&n; * License.  See the file &quot;COPYING&quot; in the main directory of this archive&n; * for more details.&n; *&n; * Copyright (C) 2004 Silicon Graphics, Inc. All rights reserved.&n; */
multiline_comment|/*&n; * System controller communication driver&n; *&n; * This driver allows a user process to communicate with the system&n; * controller (a.k.a. &quot;IRouter&quot;) network in an SGI SN system.&n; */
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/device.h&gt;
macro_line|#include &lt;linux/poll.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;asm/sn/io.h&gt;
macro_line|#include &lt;asm/sn/sn_sal.h&gt;
macro_line|#include &lt;asm/sn/module.h&gt;
macro_line|#include &lt;asm/sn/geo.h&gt;
macro_line|#include &lt;asm/sn/nodepda.h&gt;
macro_line|#include &quot;snsc.h&quot;
DECL|macro|SYSCTL_BASENAME
mdefine_line|#define SYSCTL_BASENAME&t;&quot;snsc&quot;
DECL|macro|SCDRV_BUFSZ
mdefine_line|#define SCDRV_BUFSZ&t;2048
DECL|macro|SCDRV_TIMEOUT
mdefine_line|#define SCDRV_TIMEOUT&t;1000
r_static
id|irqreturn_t
DECL|function|scdrv_interrupt
id|scdrv_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|subch_data
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|subch_data_s
op_star
id|sd
op_assign
id|subch_data
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|status
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|sd-&gt;sd_rlock
comma
id|flags
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|sd-&gt;sd_wlock
)paren
suffix:semicolon
id|status
op_assign
id|ia64_sn_irtr_intr
c_func
(paren
id|sd-&gt;sd_nasid
comma
id|sd-&gt;sd_subch
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|status
op_amp
id|SAL_IROUTER_INTR_RECV
)paren
(brace
id|wake_up
c_func
(paren
op_amp
id|sd-&gt;sd_rq
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|SAL_IROUTER_INTR_XMIT
)paren
(brace
id|ia64_sn_irtr_intr_disable
(paren
id|sd-&gt;sd_nasid
comma
id|sd-&gt;sd_subch
comma
id|SAL_IROUTER_INTR_XMIT
)paren
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|sd-&gt;sd_wq
)paren
suffix:semicolon
)brace
)brace
id|spin_unlock
c_func
(paren
op_amp
id|sd-&gt;sd_wlock
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|sd-&gt;sd_rlock
comma
id|flags
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
multiline_comment|/*&n; * scdrv_open&n; *&n; * Reserve a subchannel for system controller communication.&n; */
r_static
r_int
DECL|function|scdrv_open
id|scdrv_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|sysctl_data_s
op_star
id|scd
suffix:semicolon
r_struct
id|subch_data_s
op_star
id|sd
suffix:semicolon
r_int
id|rv
suffix:semicolon
multiline_comment|/* look up device info for this device file */
id|scd
op_assign
id|container_of
c_func
(paren
id|inode-&gt;i_cdev
comma
r_struct
id|sysctl_data_s
comma
id|scd_cdev
)paren
suffix:semicolon
multiline_comment|/* allocate memory for subchannel data */
id|sd
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|subch_data_s
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sd
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: couldn&squot;t allocate subchannel data&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/* initialize subch_data_s fields */
id|memset
c_func
(paren
id|sd
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|subch_data_s
)paren
)paren
suffix:semicolon
id|sd-&gt;sd_nasid
op_assign
id|scd-&gt;scd_nasid
suffix:semicolon
id|sd-&gt;sd_subch
op_assign
id|ia64_sn_irtr_open
c_func
(paren
id|scd-&gt;scd_nasid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sd-&gt;sd_subch
OL
l_int|0
)paren
(brace
id|kfree
c_func
(paren
id|sd
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: couldn&squot;t allocate subchannel&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|spin_lock_init
c_func
(paren
op_amp
id|sd-&gt;sd_rlock
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|sd-&gt;sd_wlock
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|sd-&gt;sd_rq
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|sd-&gt;sd_wq
)paren
suffix:semicolon
id|sema_init
c_func
(paren
op_amp
id|sd-&gt;sd_rbs
comma
l_int|1
)paren
suffix:semicolon
id|sema_init
c_func
(paren
op_amp
id|sd-&gt;sd_wbs
comma
l_int|1
)paren
suffix:semicolon
id|file-&gt;private_data
op_assign
id|sd
suffix:semicolon
multiline_comment|/* hook this subchannel up to the system controller interrupt */
id|rv
op_assign
id|request_irq
c_func
(paren
id|SGI_UART_VECTOR
comma
id|scdrv_interrupt
comma
id|SA_SHIRQ
op_or
id|SA_INTERRUPT
comma
id|SYSCTL_BASENAME
comma
id|sd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rv
)paren
(brace
id|ia64_sn_irtr_close
c_func
(paren
id|sd-&gt;sd_nasid
comma
id|sd-&gt;sd_subch
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|sd
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: irq request failed (%d)&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|rv
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * scdrv_release&n; *&n; * Release a previously-reserved subchannel.&n; */
r_static
r_int
DECL|function|scdrv_release
id|scdrv_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|subch_data_s
op_star
id|sd
op_assign
(paren
r_struct
id|subch_data_s
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
r_int
id|rv
suffix:semicolon
multiline_comment|/* free the interrupt */
id|free_irq
c_func
(paren
id|SGI_UART_VECTOR
comma
id|sd
)paren
suffix:semicolon
multiline_comment|/* ask SAL to close the subchannel */
id|rv
op_assign
id|ia64_sn_irtr_close
c_func
(paren
id|sd-&gt;sd_nasid
comma
id|sd-&gt;sd_subch
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|sd
)paren
suffix:semicolon
r_return
id|rv
suffix:semicolon
)brace
multiline_comment|/*&n; * scdrv_read&n; *&n; * Called to read bytes from the open IRouter pipe.&n; *&n; */
r_static
r_inline
r_int
DECL|function|read_status_check
id|read_status_check
c_func
(paren
r_struct
id|subch_data_s
op_star
id|sd
comma
r_int
op_star
id|len
)paren
(brace
r_return
id|ia64_sn_irtr_recv
c_func
(paren
id|sd-&gt;sd_nasid
comma
id|sd-&gt;sd_subch
comma
id|sd-&gt;sd_rb
comma
id|len
)paren
suffix:semicolon
)brace
r_static
id|ssize_t
DECL|function|scdrv_read
id|scdrv_read
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_char
id|__user
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|f_pos
)paren
(brace
r_int
id|status
suffix:semicolon
r_int
id|len
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|subch_data_s
op_star
id|sd
op_assign
(paren
r_struct
id|subch_data_s
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
multiline_comment|/* try to get control of the read buffer */
r_if
c_cond
(paren
id|down_trylock
c_func
(paren
op_amp
id|sd-&gt;sd_rbs
)paren
)paren
(brace
multiline_comment|/* somebody else has it now;&n;&t;&t; * if we&squot;re non-blocking, then exit...&n;&t;&t; */
r_if
c_cond
(paren
id|file-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
(brace
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
multiline_comment|/* ...or if we want to block, then do so here */
r_if
c_cond
(paren
id|down_interruptible
c_func
(paren
op_amp
id|sd-&gt;sd_rbs
)paren
)paren
(brace
multiline_comment|/* something went wrong with wait */
r_return
op_minus
id|ERESTARTSYS
suffix:semicolon
)brace
)brace
multiline_comment|/* anything to read? */
id|len
op_assign
id|CHUNKSIZE
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|sd-&gt;sd_rlock
comma
id|flags
)paren
suffix:semicolon
id|status
op_assign
id|read_status_check
c_func
(paren
id|sd
comma
op_amp
id|len
)paren
suffix:semicolon
multiline_comment|/* if not, and we&squot;re blocking I/O, loop */
r_while
c_loop
(paren
id|status
OL
l_int|0
)paren
(brace
id|DECLARE_WAITQUEUE
c_func
(paren
id|wait
comma
id|current
)paren
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|sd-&gt;sd_rlock
comma
id|flags
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|sd-&gt;sd_rbs
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|len
op_assign
id|CHUNKSIZE
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|add_wait_queue
c_func
(paren
op_amp
id|sd-&gt;sd_rq
comma
op_amp
id|wait
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|sd-&gt;sd_rlock
comma
id|flags
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|SCDRV_TIMEOUT
)paren
suffix:semicolon
id|remove_wait_queue
c_func
(paren
op_amp
id|sd-&gt;sd_rq
comma
op_amp
id|wait
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
multiline_comment|/* wait was interrupted */
id|up
c_func
(paren
op_amp
id|sd-&gt;sd_rbs
)paren
suffix:semicolon
r_return
op_minus
id|ERESTARTSYS
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|sd-&gt;sd_rlock
comma
id|flags
)paren
suffix:semicolon
id|status
op_assign
id|read_status_check
c_func
(paren
id|sd
comma
op_amp
id|len
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|sd-&gt;sd_rlock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
l_int|0
)paren
(brace
multiline_comment|/* we read something in the last read_status_check(); copy&n;&t;&t; * it out to user space&n;&t;&t; */
r_if
c_cond
(paren
id|count
OL
id|len
)paren
(brace
id|pr_debug
c_func
(paren
l_string|&quot;%s: only accepting %d of %d bytes&bslash;n&quot;
comma
id|__FUNCTION__
comma
(paren
r_int
)paren
id|count
comma
id|len
)paren
suffix:semicolon
)brace
id|len
op_assign
id|min
c_func
(paren
(paren
r_int
)paren
id|count
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|buf
comma
id|sd-&gt;sd_rb
comma
id|len
)paren
)paren
id|len
op_assign
op_minus
id|EFAULT
suffix:semicolon
)brace
multiline_comment|/* release the read buffer and wake anyone who might be&n;&t; * waiting for it&n;&t; */
id|up
c_func
(paren
op_amp
id|sd-&gt;sd_rbs
)paren
suffix:semicolon
multiline_comment|/* return the number of characters read in */
r_return
id|len
suffix:semicolon
)brace
multiline_comment|/*&n; * scdrv_write&n; *&n; * Writes a chunk of an IRouter packet (or other system controller data)&n; * to the system controller.&n; *&n; */
r_static
r_inline
r_int
DECL|function|write_status_check
id|write_status_check
c_func
(paren
r_struct
id|subch_data_s
op_star
id|sd
comma
r_int
id|count
)paren
(brace
r_return
id|ia64_sn_irtr_send
c_func
(paren
id|sd-&gt;sd_nasid
comma
id|sd-&gt;sd_subch
comma
id|sd-&gt;sd_wb
comma
id|count
)paren
suffix:semicolon
)brace
r_static
id|ssize_t
DECL|function|scdrv_write
id|scdrv_write
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
id|__user
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|f_pos
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|status
suffix:semicolon
r_struct
id|subch_data_s
op_star
id|sd
op_assign
(paren
r_struct
id|subch_data_s
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
multiline_comment|/* try to get control of the write buffer */
r_if
c_cond
(paren
id|down_trylock
c_func
(paren
op_amp
id|sd-&gt;sd_wbs
)paren
)paren
(brace
multiline_comment|/* somebody else has it now;&n;&t;&t; * if we&squot;re non-blocking, then exit...&n;&t;&t; */
r_if
c_cond
(paren
id|file-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
(brace
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
multiline_comment|/* ...or if we want to block, then do so here */
r_if
c_cond
(paren
id|down_interruptible
c_func
(paren
op_amp
id|sd-&gt;sd_wbs
)paren
)paren
(brace
multiline_comment|/* something went wrong with wait */
r_return
op_minus
id|ERESTARTSYS
suffix:semicolon
)brace
)brace
id|count
op_assign
id|min
c_func
(paren
(paren
r_int
)paren
id|count
comma
id|CHUNKSIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|sd-&gt;sd_wb
comma
id|buf
comma
id|count
)paren
)paren
(brace
id|up
c_func
(paren
op_amp
id|sd-&gt;sd_wbs
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
multiline_comment|/* try to send the buffer */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|sd-&gt;sd_wlock
comma
id|flags
)paren
suffix:semicolon
id|status
op_assign
id|write_status_check
c_func
(paren
id|sd
comma
id|count
)paren
suffix:semicolon
multiline_comment|/* if we failed, and we want to block, then loop */
r_while
c_loop
(paren
id|status
op_le
l_int|0
)paren
(brace
id|DECLARE_WAITQUEUE
c_func
(paren
id|wait
comma
id|current
)paren
suffix:semicolon
r_if
c_cond
(paren
id|file-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
(brace
id|spin_unlock
c_func
(paren
op_amp
id|sd-&gt;sd_wlock
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|sd-&gt;sd_wbs
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|add_wait_queue
c_func
(paren
op_amp
id|sd-&gt;sd_wq
comma
op_amp
id|wait
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|sd-&gt;sd_wlock
comma
id|flags
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|SCDRV_TIMEOUT
)paren
suffix:semicolon
id|remove_wait_queue
c_func
(paren
op_amp
id|sd-&gt;sd_wq
comma
op_amp
id|wait
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
multiline_comment|/* wait was interrupted */
id|up
c_func
(paren
op_amp
id|sd-&gt;sd_wbs
)paren
suffix:semicolon
r_return
op_minus
id|ERESTARTSYS
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|sd-&gt;sd_wlock
comma
id|flags
)paren
suffix:semicolon
id|status
op_assign
id|write_status_check
c_func
(paren
id|sd
comma
id|count
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|sd-&gt;sd_wlock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* release the write buffer and wake anyone who&squot;s waiting for it */
id|up
c_func
(paren
op_amp
id|sd-&gt;sd_wbs
)paren
suffix:semicolon
multiline_comment|/* return the number of characters accepted (should be the complete&n;&t; * &quot;chunk&quot; as requested)&n;&t; */
r_if
c_cond
(paren
(paren
id|status
op_ge
l_int|0
)paren
op_logical_and
(paren
id|status
OL
id|count
)paren
)paren
(brace
id|pr_debug
c_func
(paren
l_string|&quot;Didn&squot;t accept the full chunk; %d of %d&bslash;n&quot;
comma
id|status
comma
(paren
r_int
)paren
id|count
)paren
suffix:semicolon
)brace
r_return
id|status
suffix:semicolon
)brace
r_static
r_int
r_int
DECL|function|scdrv_poll
id|scdrv_poll
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_struct
id|poll_table_struct
op_star
id|wait
)paren
(brace
r_int
r_int
id|mask
op_assign
l_int|0
suffix:semicolon
r_int
id|status
op_assign
l_int|0
suffix:semicolon
r_struct
id|subch_data_s
op_star
id|sd
op_assign
(paren
r_struct
id|subch_data_s
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|poll_wait
c_func
(paren
id|file
comma
op_amp
id|sd-&gt;sd_rq
comma
id|wait
)paren
suffix:semicolon
id|poll_wait
c_func
(paren
id|file
comma
op_amp
id|sd-&gt;sd_wq
comma
id|wait
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|sd-&gt;sd_rlock
comma
id|flags
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|sd-&gt;sd_wlock
)paren
suffix:semicolon
id|status
op_assign
id|ia64_sn_irtr_intr
c_func
(paren
id|sd-&gt;sd_nasid
comma
id|sd-&gt;sd_subch
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|sd-&gt;sd_wlock
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|sd-&gt;sd_rlock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|status
op_amp
id|SAL_IROUTER_INTR_RECV
)paren
(brace
id|mask
op_or_assign
id|POLLIN
op_or
id|POLLRDNORM
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|SAL_IROUTER_INTR_XMIT
)paren
(brace
id|mask
op_or_assign
id|POLLOUT
op_or
id|POLLWRNORM
suffix:semicolon
)brace
)brace
r_return
id|mask
suffix:semicolon
)brace
DECL|variable|scdrv_fops
r_static
r_struct
id|file_operations
id|scdrv_fops
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|read
op_assign
id|scdrv_read
comma
dot
id|write
op_assign
id|scdrv_write
comma
dot
id|poll
op_assign
id|scdrv_poll
comma
dot
id|open
op_assign
id|scdrv_open
comma
dot
id|release
op_assign
id|scdrv_release
comma
)brace
suffix:semicolon
multiline_comment|/*&n; * scdrv_init&n; *&n; * Called at boot time to initialize the system controller communication&n; * facility.&n; */
r_int
id|__init
DECL|function|scdrv_init
id|scdrv_init
c_func
(paren
r_void
)paren
(brace
id|geoid_t
id|geoid
suffix:semicolon
id|cnodeid_t
id|cnode
suffix:semicolon
r_char
id|devname
(braket
l_int|32
)braket
suffix:semicolon
r_char
op_star
id|devnamep
suffix:semicolon
r_struct
id|sysctl_data_s
op_star
id|scd
suffix:semicolon
r_void
op_star
id|salbuf
suffix:semicolon
r_struct
id|class_simple
op_star
id|snsc_class
suffix:semicolon
id|dev_t
id|first_dev
comma
id|dev
suffix:semicolon
r_if
c_cond
(paren
id|alloc_chrdev_region
c_func
(paren
op_amp
id|first_dev
comma
l_int|0
comma
id|numionodes
comma
id|SYSCTL_BASENAME
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: failed to register SN system controller device&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|snsc_class
op_assign
id|class_simple_create
c_func
(paren
id|THIS_MODULE
comma
id|SYSCTL_BASENAME
)paren
suffix:semicolon
r_for
c_loop
(paren
id|cnode
op_assign
l_int|0
suffix:semicolon
id|cnode
OL
id|numionodes
suffix:semicolon
id|cnode
op_increment
)paren
(brace
id|geoid
op_assign
id|cnodeid_get_geoid
c_func
(paren
id|cnode
)paren
suffix:semicolon
id|devnamep
op_assign
id|devname
suffix:semicolon
id|format_module_id
c_func
(paren
id|devnamep
comma
id|geo_module
c_func
(paren
id|geoid
)paren
comma
id|MODULE_FORMAT_BRIEF
)paren
suffix:semicolon
id|devnamep
op_assign
id|devname
op_plus
id|strlen
c_func
(paren
id|devname
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|devnamep
comma
l_string|&quot;#%d&quot;
comma
id|geo_slab
c_func
(paren
id|geoid
)paren
)paren
suffix:semicolon
multiline_comment|/* allocate sysctl device data */
id|scd
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|sysctl_data_s
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|scd
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: failed to allocate device info&quot;
l_string|&quot;for %s/%s&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|SYSCTL_BASENAME
comma
id|devname
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|memset
c_func
(paren
id|scd
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|sysctl_data_s
)paren
)paren
suffix:semicolon
multiline_comment|/* initialize sysctl device data fields */
id|scd-&gt;scd_nasid
op_assign
id|cnodeid_to_nasid
c_func
(paren
id|cnode
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|salbuf
op_assign
id|kmalloc
c_func
(paren
id|SCDRV_BUFSZ
comma
id|GFP_KERNEL
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: failed to allocate driver buffer&quot;
l_string|&quot;(%s%s)&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|SYSCTL_BASENAME
comma
id|devname
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|scd
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ia64_sn_irtr_init
c_func
(paren
id|scd-&gt;scd_nasid
comma
id|salbuf
comma
id|SCDRV_BUFSZ
)paren
OL
l_int|0
)paren
(brace
id|printk
(paren
l_string|&quot;%s: failed to initialize SAL for&quot;
l_string|&quot; system controller communication&quot;
l_string|&quot; (%s/%s): outdated PROM?&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|SYSCTL_BASENAME
comma
id|devname
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|scd
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|salbuf
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|dev
op_assign
id|first_dev
op_plus
id|cnode
suffix:semicolon
id|cdev_init
c_func
(paren
op_amp
id|scd-&gt;scd_cdev
comma
op_amp
id|scdrv_fops
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cdev_add
c_func
(paren
op_amp
id|scd-&gt;scd_cdev
comma
id|dev
comma
l_int|1
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: failed to register system&quot;
l_string|&quot; controller device (%s%s)&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|SYSCTL_BASENAME
comma
id|devname
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|scd
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|salbuf
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|class_simple_device_add
c_func
(paren
id|snsc_class
comma
id|dev
comma
l_int|NULL
comma
l_string|&quot;%s&quot;
comma
id|devname
)paren
suffix:semicolon
id|ia64_sn_irtr_intr_enable
c_func
(paren
id|scd-&gt;scd_nasid
comma
l_int|0
multiline_comment|/*ignored */
comma
id|SAL_IROUTER_INTR_RECV
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|scdrv_init
id|module_init
c_func
(paren
id|scdrv_init
)paren
suffix:semicolon
eof
