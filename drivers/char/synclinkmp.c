multiline_comment|/*&n; * $Id: synclinkmp.c,v 4.29 2004/08/27 20:06:41 paulkf Exp $&n; *&n; * Device driver for Microgate SyncLink Multiport&n; * high speed multiprotocol serial adapter.&n; *&n; * written by Paul Fulghum for Microgate Corporation&n; * paulkf@microgate.com&n; *&n; * Microgate and SyncLink are trademarks of Microgate Corporation&n; *&n; * Derived from serial.c written by Theodore Ts&squot;o and Linus Torvalds&n; * This code is released under the GNU General Public License (GPL)&n; *&n; * THIS SOFTWARE IS PROVIDED ``AS IS&squot;&squot; AND ANY EXPRESS OR IMPLIED&n; * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES&n; * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE&n; * DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT,&n; * INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES&n; * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR&n; * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)&n; * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,&n; * STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)&n; * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED&n; * OF THE POSSIBILITY OF SUCH DAMAGE.&n; */
DECL|macro|VERSION
mdefine_line|#define VERSION(ver,rel,seq) (((ver)&lt;&lt;16) | ((rel)&lt;&lt;8) | (seq))
macro_line|#if defined(__i386__)
DECL|macro|BREAKPOINT
macro_line|#  define BREAKPOINT() asm(&quot;   int $3&quot;);
macro_line|#else
DECL|macro|BREAKPOINT
macro_line|#  define BREAKPOINT() { }
macro_line|#endif
DECL|macro|MAX_DEVICES
mdefine_line|#define MAX_DEVICES 12
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/signal.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/tty_flip.h&gt;
macro_line|#include &lt;linux/serial.h&gt;
macro_line|#include &lt;linux/major.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/vmalloc.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/serial.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/ioctl.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;linux/bitops.h&gt;
macro_line|#include &lt;asm/types.h&gt;
macro_line|#include &lt;linux/termios.h&gt;
macro_line|#include &lt;linux/workqueue.h&gt;
macro_line|#include &lt;linux/hdlc.h&gt;
macro_line|#ifdef CONFIG_HDLC_MODULE
DECL|macro|CONFIG_HDLC
mdefine_line|#define CONFIG_HDLC 1
macro_line|#endif
DECL|macro|GET_USER
mdefine_line|#define GET_USER(error,value,addr) error = get_user(value,addr)
DECL|macro|COPY_FROM_USER
mdefine_line|#define COPY_FROM_USER(error,dest,src,size) error = copy_from_user(dest,src,size) ? -EFAULT : 0
DECL|macro|PUT_USER
mdefine_line|#define PUT_USER(error,value,addr) error = put_user(value,addr)
DECL|macro|COPY_TO_USER
mdefine_line|#define COPY_TO_USER(error,dest,src,size) error = copy_to_user(dest,src,size) ? -EFAULT : 0
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &quot;linux/synclink.h&quot;
DECL|variable|default_params
r_static
id|MGSL_PARAMS
id|default_params
op_assign
(brace
id|MGSL_MODE_HDLC
comma
multiline_comment|/* unsigned long mode */
l_int|0
comma
multiline_comment|/* unsigned char loopback; */
id|HDLC_FLAG_UNDERRUN_ABORT15
comma
multiline_comment|/* unsigned short flags; */
id|HDLC_ENCODING_NRZI_SPACE
comma
multiline_comment|/* unsigned char encoding; */
l_int|0
comma
multiline_comment|/* unsigned long clock_speed; */
l_int|0xff
comma
multiline_comment|/* unsigned char addr_filter; */
id|HDLC_CRC_16_CCITT
comma
multiline_comment|/* unsigned short crc_type; */
id|HDLC_PREAMBLE_LENGTH_8BITS
comma
multiline_comment|/* unsigned char preamble_length; */
id|HDLC_PREAMBLE_PATTERN_NONE
comma
multiline_comment|/* unsigned char preamble; */
l_int|9600
comma
multiline_comment|/* unsigned long data_rate; */
l_int|8
comma
multiline_comment|/* unsigned char data_bits; */
l_int|1
comma
multiline_comment|/* unsigned char stop_bits; */
id|ASYNC_PARITY_NONE
multiline_comment|/* unsigned char parity; */
)brace
suffix:semicolon
multiline_comment|/* size in bytes of DMA data buffers */
DECL|macro|SCABUFSIZE
mdefine_line|#define SCABUFSIZE &t;1024
DECL|macro|SCA_MEM_SIZE
mdefine_line|#define SCA_MEM_SIZE&t;0x40000
DECL|macro|SCA_BASE_SIZE
mdefine_line|#define SCA_BASE_SIZE   512
DECL|macro|SCA_REG_SIZE
mdefine_line|#define SCA_REG_SIZE    16
DECL|macro|SCA_MAX_PORTS
mdefine_line|#define SCA_MAX_PORTS   4
DECL|macro|SCAMAXDESC
mdefine_line|#define SCAMAXDESC &t;128
DECL|macro|BUFFERLISTSIZE
mdefine_line|#define&t;BUFFERLISTSIZE&t;4096
multiline_comment|/* SCA-I style DMA buffer descriptor */
DECL|struct|_SCADESC
r_typedef
r_struct
id|_SCADESC
(brace
DECL|member|next
id|u16
id|next
suffix:semicolon
multiline_comment|/* lower l6 bits of next descriptor addr */
DECL|member|buf_ptr
id|u16
id|buf_ptr
suffix:semicolon
multiline_comment|/* lower 16 bits of buffer addr */
DECL|member|buf_base
id|u8
id|buf_base
suffix:semicolon
multiline_comment|/* upper 8 bits of buffer addr */
DECL|member|pad1
id|u8
id|pad1
suffix:semicolon
DECL|member|length
id|u16
id|length
suffix:semicolon
multiline_comment|/* length of buffer */
DECL|member|status
id|u8
id|status
suffix:semicolon
multiline_comment|/* status of buffer */
DECL|member|pad2
id|u8
id|pad2
suffix:semicolon
DECL|typedef|SCADESC
DECL|typedef|PSCADESC
)brace
id|SCADESC
comma
op_star
id|PSCADESC
suffix:semicolon
DECL|struct|_SCADESC_EX
r_typedef
r_struct
id|_SCADESC_EX
(brace
multiline_comment|/* device driver bookkeeping section */
DECL|member|virt_addr
r_char
op_star
id|virt_addr
suffix:semicolon
multiline_comment|/* virtual address of data buffer */
DECL|member|phys_entry
id|u16
id|phys_entry
suffix:semicolon
multiline_comment|/* lower 16-bits of physical address of this descriptor */
DECL|typedef|SCADESC_EX
DECL|typedef|PSCADESC_EX
)brace
id|SCADESC_EX
comma
op_star
id|PSCADESC_EX
suffix:semicolon
multiline_comment|/* The queue of BH actions to be performed */
DECL|macro|BH_RECEIVE
mdefine_line|#define BH_RECEIVE  1
DECL|macro|BH_TRANSMIT
mdefine_line|#define BH_TRANSMIT 2
DECL|macro|BH_STATUS
mdefine_line|#define BH_STATUS   4
DECL|macro|IO_PIN_SHUTDOWN_LIMIT
mdefine_line|#define IO_PIN_SHUTDOWN_LIMIT 100
DECL|macro|RELEVANT_IFLAG
mdefine_line|#define RELEVANT_IFLAG(iflag) (iflag &amp; (IGNBRK|BRKINT|IGNPAR|PARMRK|INPCK))
DECL|struct|_input_signal_events
r_struct
id|_input_signal_events
(brace
DECL|member|ri_up
r_int
id|ri_up
suffix:semicolon
DECL|member|ri_down
r_int
id|ri_down
suffix:semicolon
DECL|member|dsr_up
r_int
id|dsr_up
suffix:semicolon
DECL|member|dsr_down
r_int
id|dsr_down
suffix:semicolon
DECL|member|dcd_up
r_int
id|dcd_up
suffix:semicolon
DECL|member|dcd_down
r_int
id|dcd_down
suffix:semicolon
DECL|member|cts_up
r_int
id|cts_up
suffix:semicolon
DECL|member|cts_down
r_int
id|cts_down
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/*&n; * Device instance data structure&n; */
DECL|struct|_synclinkmp_info
r_typedef
r_struct
id|_synclinkmp_info
(brace
DECL|member|if_ptr
r_void
op_star
id|if_ptr
suffix:semicolon
multiline_comment|/* General purpose pointer (used by SPPP) */
DECL|member|magic
r_int
id|magic
suffix:semicolon
DECL|member|flags
r_int
id|flags
suffix:semicolon
DECL|member|count
r_int
id|count
suffix:semicolon
multiline_comment|/* count of opens */
DECL|member|line
r_int
id|line
suffix:semicolon
DECL|member|close_delay
r_int
r_int
id|close_delay
suffix:semicolon
DECL|member|closing_wait
r_int
r_int
id|closing_wait
suffix:semicolon
multiline_comment|/* time to wait before closing */
DECL|member|icount
r_struct
id|mgsl_icount
id|icount
suffix:semicolon
DECL|member|tty
r_struct
id|tty_struct
op_star
id|tty
suffix:semicolon
DECL|member|timeout
r_int
id|timeout
suffix:semicolon
DECL|member|x_char
r_int
id|x_char
suffix:semicolon
multiline_comment|/* xon/xoff character */
DECL|member|blocked_open
r_int
id|blocked_open
suffix:semicolon
multiline_comment|/* # of blocked opens */
DECL|member|read_status_mask1
id|u16
id|read_status_mask1
suffix:semicolon
multiline_comment|/* break detection (SR1 indications) */
DECL|member|read_status_mask2
id|u16
id|read_status_mask2
suffix:semicolon
multiline_comment|/* parity/framing/overun (SR2 indications) */
DECL|member|ignore_status_mask1
r_int
r_char
id|ignore_status_mask1
suffix:semicolon
multiline_comment|/* break detection (SR1 indications) */
DECL|member|ignore_status_mask2
r_int
r_char
id|ignore_status_mask2
suffix:semicolon
multiline_comment|/* parity/framing/overun (SR2 indications) */
DECL|member|tx_buf
r_int
r_char
op_star
id|tx_buf
suffix:semicolon
DECL|member|tx_put
r_int
id|tx_put
suffix:semicolon
DECL|member|tx_get
r_int
id|tx_get
suffix:semicolon
DECL|member|tx_count
r_int
id|tx_count
suffix:semicolon
DECL|member|open_wait
id|wait_queue_head_t
id|open_wait
suffix:semicolon
DECL|member|close_wait
id|wait_queue_head_t
id|close_wait
suffix:semicolon
DECL|member|status_event_wait_q
id|wait_queue_head_t
id|status_event_wait_q
suffix:semicolon
DECL|member|event_wait_q
id|wait_queue_head_t
id|event_wait_q
suffix:semicolon
DECL|member|tx_timer
r_struct
id|timer_list
id|tx_timer
suffix:semicolon
multiline_comment|/* HDLC transmit timeout timer */
DECL|member|next_device
r_struct
id|_synclinkmp_info
op_star
id|next_device
suffix:semicolon
multiline_comment|/* device list link */
DECL|member|status_timer
r_struct
id|timer_list
id|status_timer
suffix:semicolon
multiline_comment|/* input signal status check timer */
DECL|member|lock
id|spinlock_t
id|lock
suffix:semicolon
multiline_comment|/* spinlock for synchronizing with ISR */
DECL|member|task
r_struct
id|work_struct
id|task
suffix:semicolon
multiline_comment|/* task structure for scheduling bh */
DECL|member|max_frame_size
id|u32
id|max_frame_size
suffix:semicolon
multiline_comment|/* as set by device config */
DECL|member|pending_bh
id|u32
id|pending_bh
suffix:semicolon
DECL|member|bh_running
r_int
id|bh_running
suffix:semicolon
multiline_comment|/* Protection from multiple */
DECL|member|isr_overflow
r_int
id|isr_overflow
suffix:semicolon
DECL|member|bh_requested
r_int
id|bh_requested
suffix:semicolon
DECL|member|dcd_chkcount
r_int
id|dcd_chkcount
suffix:semicolon
multiline_comment|/* check counts to prevent */
DECL|member|cts_chkcount
r_int
id|cts_chkcount
suffix:semicolon
multiline_comment|/* too many IRQs if a signal */
DECL|member|dsr_chkcount
r_int
id|dsr_chkcount
suffix:semicolon
multiline_comment|/* is floating */
DECL|member|ri_chkcount
r_int
id|ri_chkcount
suffix:semicolon
DECL|member|buffer_list
r_char
op_star
id|buffer_list
suffix:semicolon
multiline_comment|/* virtual address of Rx &amp; Tx buffer lists */
DECL|member|buffer_list_phys
r_int
r_int
id|buffer_list_phys
suffix:semicolon
DECL|member|rx_buf_count
r_int
r_int
id|rx_buf_count
suffix:semicolon
multiline_comment|/* count of total allocated Rx buffers */
DECL|member|rx_buf_list
id|SCADESC
op_star
id|rx_buf_list
suffix:semicolon
multiline_comment|/* list of receive buffer entries */
DECL|member|rx_buf_list_ex
id|SCADESC_EX
id|rx_buf_list_ex
(braket
id|SCAMAXDESC
)braket
suffix:semicolon
multiline_comment|/* list of receive buffer entries */
DECL|member|current_rx_buf
r_int
r_int
id|current_rx_buf
suffix:semicolon
DECL|member|tx_buf_count
r_int
r_int
id|tx_buf_count
suffix:semicolon
multiline_comment|/* count of total allocated Tx buffers */
DECL|member|tx_buf_list
id|SCADESC
op_star
id|tx_buf_list
suffix:semicolon
multiline_comment|/* list of transmit buffer entries */
DECL|member|tx_buf_list_ex
id|SCADESC_EX
id|tx_buf_list_ex
(braket
id|SCAMAXDESC
)braket
suffix:semicolon
multiline_comment|/* list of transmit buffer entries */
DECL|member|last_tx_buf
r_int
r_int
id|last_tx_buf
suffix:semicolon
DECL|member|tmp_rx_buf
r_int
r_char
op_star
id|tmp_rx_buf
suffix:semicolon
DECL|member|tmp_rx_buf_count
r_int
r_int
id|tmp_rx_buf_count
suffix:semicolon
DECL|member|rx_enabled
r_int
id|rx_enabled
suffix:semicolon
DECL|member|rx_overflow
r_int
id|rx_overflow
suffix:semicolon
DECL|member|tx_enabled
r_int
id|tx_enabled
suffix:semicolon
DECL|member|tx_active
r_int
id|tx_active
suffix:semicolon
DECL|member|idle_mode
id|u32
id|idle_mode
suffix:semicolon
DECL|member|ie0_value
r_int
r_char
id|ie0_value
suffix:semicolon
DECL|member|ie1_value
r_int
r_char
id|ie1_value
suffix:semicolon
DECL|member|ie2_value
r_int
r_char
id|ie2_value
suffix:semicolon
DECL|member|ctrlreg_value
r_int
r_char
id|ctrlreg_value
suffix:semicolon
DECL|member|old_signals
r_int
r_char
id|old_signals
suffix:semicolon
DECL|member|device_name
r_char
id|device_name
(braket
l_int|25
)braket
suffix:semicolon
multiline_comment|/* device instance name */
DECL|member|port_count
r_int
id|port_count
suffix:semicolon
DECL|member|adapter_num
r_int
id|adapter_num
suffix:semicolon
DECL|member|port_num
r_int
id|port_num
suffix:semicolon
DECL|member|port_array
r_struct
id|_synclinkmp_info
op_star
id|port_array
(braket
id|SCA_MAX_PORTS
)braket
suffix:semicolon
DECL|member|bus_type
r_int
r_int
id|bus_type
suffix:semicolon
multiline_comment|/* expansion bus type (ISA,EISA,PCI) */
DECL|member|irq_level
r_int
r_int
id|irq_level
suffix:semicolon
multiline_comment|/* interrupt level */
DECL|member|irq_flags
r_int
r_int
id|irq_flags
suffix:semicolon
DECL|member|irq_requested
r_int
id|irq_requested
suffix:semicolon
multiline_comment|/* nonzero if IRQ requested */
DECL|member|params
id|MGSL_PARAMS
id|params
suffix:semicolon
multiline_comment|/* communications parameters */
DECL|member|serial_signals
r_int
r_char
id|serial_signals
suffix:semicolon
multiline_comment|/* current serial signal states */
DECL|member|irq_occurred
r_int
id|irq_occurred
suffix:semicolon
multiline_comment|/* for diagnostics use */
DECL|member|init_error
r_int
r_int
id|init_error
suffix:semicolon
multiline_comment|/* Initialization startup error */
DECL|member|last_mem_alloc
id|u32
id|last_mem_alloc
suffix:semicolon
DECL|member|memory_base
r_int
r_char
op_star
id|memory_base
suffix:semicolon
multiline_comment|/* shared memory address (PCI only) */
DECL|member|phys_memory_base
id|u32
id|phys_memory_base
suffix:semicolon
DECL|member|shared_mem_requested
r_int
id|shared_mem_requested
suffix:semicolon
DECL|member|sca_base
r_int
r_char
op_star
id|sca_base
suffix:semicolon
multiline_comment|/* HD64570 SCA Memory address */
DECL|member|phys_sca_base
id|u32
id|phys_sca_base
suffix:semicolon
DECL|member|sca_offset
id|u32
id|sca_offset
suffix:semicolon
DECL|member|sca_base_requested
r_int
id|sca_base_requested
suffix:semicolon
DECL|member|lcr_base
r_int
r_char
op_star
id|lcr_base
suffix:semicolon
multiline_comment|/* local config registers (PCI only) */
DECL|member|phys_lcr_base
id|u32
id|phys_lcr_base
suffix:semicolon
DECL|member|lcr_offset
id|u32
id|lcr_offset
suffix:semicolon
DECL|member|lcr_mem_requested
r_int
id|lcr_mem_requested
suffix:semicolon
DECL|member|statctrl_base
r_int
r_char
op_star
id|statctrl_base
suffix:semicolon
multiline_comment|/* status/control register memory */
DECL|member|phys_statctrl_base
id|u32
id|phys_statctrl_base
suffix:semicolon
DECL|member|statctrl_offset
id|u32
id|statctrl_offset
suffix:semicolon
DECL|member|sca_statctrl_requested
r_int
id|sca_statctrl_requested
suffix:semicolon
DECL|member|misc_ctrl_value
id|u32
id|misc_ctrl_value
suffix:semicolon
DECL|member|flag_buf
r_char
id|flag_buf
(braket
id|MAX_ASYNC_BUFFER_SIZE
)braket
suffix:semicolon
DECL|member|char_buf
r_char
id|char_buf
(braket
id|MAX_ASYNC_BUFFER_SIZE
)braket
suffix:semicolon
DECL|member|drop_rts_on_tx_done
id|BOOLEAN
id|drop_rts_on_tx_done
suffix:semicolon
DECL|member|input_signal_events
r_struct
id|_input_signal_events
id|input_signal_events
suffix:semicolon
multiline_comment|/* SPPP/Cisco HDLC device parts */
DECL|member|netcount
r_int
id|netcount
suffix:semicolon
DECL|member|dosyncppp
r_int
id|dosyncppp
suffix:semicolon
DECL|member|netlock
id|spinlock_t
id|netlock
suffix:semicolon
macro_line|#ifdef CONFIG_HDLC
DECL|member|netdev
r_struct
id|net_device
op_star
id|netdev
suffix:semicolon
macro_line|#endif
DECL|typedef|SLMP_INFO
)brace
id|SLMP_INFO
suffix:semicolon
DECL|macro|MGSL_MAGIC
mdefine_line|#define MGSL_MAGIC 0x5401
multiline_comment|/*&n; * define serial signal status change macros&n; */
DECL|macro|MISCSTATUS_DCD_LATCHED
mdefine_line|#define&t;MISCSTATUS_DCD_LATCHED&t;(SerialSignal_DCD&lt;&lt;8)&t;/* indicates change in DCD */
DECL|macro|MISCSTATUS_RI_LATCHED
mdefine_line|#define MISCSTATUS_RI_LATCHED&t;(SerialSignal_RI&lt;&lt;8)&t;/* indicates change in RI */
DECL|macro|MISCSTATUS_CTS_LATCHED
mdefine_line|#define MISCSTATUS_CTS_LATCHED&t;(SerialSignal_CTS&lt;&lt;8)&t;/* indicates change in CTS */
DECL|macro|MISCSTATUS_DSR_LATCHED
mdefine_line|#define MISCSTATUS_DSR_LATCHED&t;(SerialSignal_DSR&lt;&lt;8)&t;/* change in DSR */
multiline_comment|/* Common Register macros */
DECL|macro|LPR
mdefine_line|#define LPR&t;0x00
DECL|macro|PABR0
mdefine_line|#define PABR0&t;0x02
DECL|macro|PABR1
mdefine_line|#define PABR1&t;0x03
DECL|macro|WCRL
mdefine_line|#define WCRL&t;0x04
DECL|macro|WCRM
mdefine_line|#define WCRM&t;0x05
DECL|macro|WCRH
mdefine_line|#define WCRH&t;0x06
DECL|macro|DPCR
mdefine_line|#define DPCR&t;0x08
DECL|macro|DMER
mdefine_line|#define DMER&t;0x09
DECL|macro|ISR0
mdefine_line|#define ISR0&t;0x10
DECL|macro|ISR1
mdefine_line|#define ISR1&t;0x11
DECL|macro|ISR2
mdefine_line|#define ISR2&t;0x12
DECL|macro|IER0
mdefine_line|#define IER0&t;0x14
DECL|macro|IER1
mdefine_line|#define IER1&t;0x15
DECL|macro|IER2
mdefine_line|#define IER2&t;0x16
DECL|macro|ITCR
mdefine_line|#define ITCR&t;0x18
DECL|macro|INTVR
mdefine_line|#define INTVR &t;0x1a
DECL|macro|IMVR
mdefine_line|#define IMVR&t;0x1c
multiline_comment|/* MSCI Register macros */
DECL|macro|TRB
mdefine_line|#define TRB&t;0x20
DECL|macro|TRBL
mdefine_line|#define TRBL&t;0x20
DECL|macro|TRBH
mdefine_line|#define TRBH&t;0x21
DECL|macro|SR0
mdefine_line|#define SR0&t;0x22
DECL|macro|SR1
mdefine_line|#define SR1&t;0x23
DECL|macro|SR2
mdefine_line|#define SR2&t;0x24
DECL|macro|SR3
mdefine_line|#define SR3&t;0x25
DECL|macro|FST
mdefine_line|#define FST&t;0x26
DECL|macro|IE0
mdefine_line|#define IE0&t;0x28
DECL|macro|IE1
mdefine_line|#define IE1&t;0x29
DECL|macro|IE2
mdefine_line|#define IE2&t;0x2a
DECL|macro|FIE
mdefine_line|#define FIE&t;0x2b
DECL|macro|CMD
mdefine_line|#define CMD&t;0x2c
DECL|macro|MD0
mdefine_line|#define MD0&t;0x2e
DECL|macro|MD1
mdefine_line|#define MD1&t;0x2f
DECL|macro|MD2
mdefine_line|#define MD2&t;0x30
DECL|macro|CTL
mdefine_line|#define CTL&t;0x31
DECL|macro|SA0
mdefine_line|#define SA0&t;0x32
DECL|macro|SA1
mdefine_line|#define SA1&t;0x33
DECL|macro|IDL
mdefine_line|#define IDL&t;0x34
DECL|macro|TMC
mdefine_line|#define TMC&t;0x35
DECL|macro|RXS
mdefine_line|#define RXS&t;0x36
DECL|macro|TXS
mdefine_line|#define TXS&t;0x37
DECL|macro|TRC0
mdefine_line|#define TRC0&t;0x38
DECL|macro|TRC1
mdefine_line|#define TRC1&t;0x39
DECL|macro|RRC
mdefine_line|#define RRC&t;0x3a
DECL|macro|CST0
mdefine_line|#define CST0&t;0x3c
DECL|macro|CST1
mdefine_line|#define CST1&t;0x3d
multiline_comment|/* Timer Register Macros */
DECL|macro|TCNT
mdefine_line|#define TCNT&t;0x60
DECL|macro|TCNTL
mdefine_line|#define TCNTL&t;0x60
DECL|macro|TCNTH
mdefine_line|#define TCNTH&t;0x61
DECL|macro|TCONR
mdefine_line|#define TCONR&t;0x62
DECL|macro|TCONRL
mdefine_line|#define TCONRL&t;0x62
DECL|macro|TCONRH
mdefine_line|#define TCONRH&t;0x63
DECL|macro|TMCS
mdefine_line|#define TMCS&t;0x64
DECL|macro|TEPR
mdefine_line|#define TEPR&t;0x65
multiline_comment|/* DMA Controller Register macros */
DECL|macro|DARL
mdefine_line|#define DARL&t;0x80
DECL|macro|DARH
mdefine_line|#define DARH&t;0x81
DECL|macro|DARB
mdefine_line|#define DARB&t;0x82
DECL|macro|BAR
mdefine_line|#define BAR&t;0x80
DECL|macro|BARL
mdefine_line|#define BARL&t;0x80
DECL|macro|BARH
mdefine_line|#define BARH&t;0x81
DECL|macro|BARB
mdefine_line|#define BARB&t;0x82
DECL|macro|SAR
mdefine_line|#define SAR&t;0x84
DECL|macro|SARL
mdefine_line|#define SARL&t;0x84
DECL|macro|SARH
mdefine_line|#define SARH&t;0x85
DECL|macro|SARB
mdefine_line|#define SARB&t;0x86
DECL|macro|CPB
mdefine_line|#define CPB&t;0x86
DECL|macro|CDA
mdefine_line|#define CDA&t;0x88
DECL|macro|CDAL
mdefine_line|#define CDAL&t;0x88
DECL|macro|CDAH
mdefine_line|#define CDAH&t;0x89
DECL|macro|EDA
mdefine_line|#define EDA&t;0x8a
DECL|macro|EDAL
mdefine_line|#define EDAL&t;0x8a
DECL|macro|EDAH
mdefine_line|#define EDAH&t;0x8b
DECL|macro|BFL
mdefine_line|#define BFL&t;0x8c
DECL|macro|BFLL
mdefine_line|#define BFLL&t;0x8c
DECL|macro|BFLH
mdefine_line|#define BFLH&t;0x8d
DECL|macro|BCR
mdefine_line|#define BCR&t;0x8e
DECL|macro|BCRL
mdefine_line|#define BCRL&t;0x8e
DECL|macro|BCRH
mdefine_line|#define BCRH&t;0x8f
DECL|macro|DSR
mdefine_line|#define DSR&t;0x90
DECL|macro|DMR
mdefine_line|#define DMR&t;0x91
DECL|macro|FCT
mdefine_line|#define FCT&t;0x93
DECL|macro|DIR
mdefine_line|#define DIR&t;0x94
DECL|macro|DCMD
mdefine_line|#define DCMD&t;0x95
multiline_comment|/* combine with timer or DMA register address */
DECL|macro|TIMER0
mdefine_line|#define TIMER0&t;0x00
DECL|macro|TIMER1
mdefine_line|#define TIMER1&t;0x08
DECL|macro|TIMER2
mdefine_line|#define TIMER2&t;0x10
DECL|macro|TIMER3
mdefine_line|#define TIMER3&t;0x18
DECL|macro|RXDMA
mdefine_line|#define RXDMA &t;0x00
DECL|macro|TXDMA
mdefine_line|#define TXDMA &t;0x20
multiline_comment|/* SCA Command Codes */
DECL|macro|NOOP
mdefine_line|#define NOOP&t;&t;0x00
DECL|macro|TXRESET
mdefine_line|#define TXRESET&t;&t;0x01
DECL|macro|TXENABLE
mdefine_line|#define TXENABLE&t;0x02
DECL|macro|TXDISABLE
mdefine_line|#define TXDISABLE&t;0x03
DECL|macro|TXCRCINIT
mdefine_line|#define TXCRCINIT&t;0x04
DECL|macro|TXCRCEXCL
mdefine_line|#define TXCRCEXCL&t;0x05
DECL|macro|TXEOM
mdefine_line|#define TXEOM&t;&t;0x06
DECL|macro|TXABORT
mdefine_line|#define TXABORT&t;&t;0x07
DECL|macro|MPON
mdefine_line|#define MPON&t;&t;0x08
DECL|macro|TXBUFCLR
mdefine_line|#define TXBUFCLR&t;0x09
DECL|macro|RXRESET
mdefine_line|#define RXRESET&t;&t;0x11
DECL|macro|RXENABLE
mdefine_line|#define RXENABLE&t;0x12
DECL|macro|RXDISABLE
mdefine_line|#define RXDISABLE&t;0x13
DECL|macro|RXCRCINIT
mdefine_line|#define RXCRCINIT&t;0x14
DECL|macro|RXREJECT
mdefine_line|#define RXREJECT&t;0x15
DECL|macro|SEARCHMP
mdefine_line|#define SEARCHMP&t;0x16
DECL|macro|RXCRCEXCL
mdefine_line|#define RXCRCEXCL&t;0x17
DECL|macro|RXCRCCALC
mdefine_line|#define RXCRCCALC&t;0x18
DECL|macro|CHRESET
mdefine_line|#define CHRESET&t;&t;0x21
DECL|macro|HUNT
mdefine_line|#define HUNT&t;&t;0x31
multiline_comment|/* DMA command codes */
DECL|macro|SWABORT
mdefine_line|#define SWABORT&t;&t;0x01
DECL|macro|FEICLEAR
mdefine_line|#define FEICLEAR&t;0x02
multiline_comment|/* IE0 */
DECL|macro|TXINTE
mdefine_line|#define TXINTE &t;&t;BIT7
DECL|macro|RXINTE
mdefine_line|#define RXINTE &t;&t;BIT6
DECL|macro|TXRDYE
mdefine_line|#define TXRDYE &t;&t;BIT1
DECL|macro|RXRDYE
mdefine_line|#define RXRDYE &t;&t;BIT0
multiline_comment|/* IE1 &amp; SR1 */
DECL|macro|UDRN
mdefine_line|#define UDRN   &t;BIT7
DECL|macro|IDLE
mdefine_line|#define IDLE   &t;BIT6
DECL|macro|SYNCD
mdefine_line|#define SYNCD  &t;BIT4
DECL|macro|FLGD
mdefine_line|#define FLGD   &t;BIT4
DECL|macro|CCTS
mdefine_line|#define CCTS   &t;BIT3
DECL|macro|CDCD
mdefine_line|#define CDCD   &t;BIT2
DECL|macro|BRKD
mdefine_line|#define BRKD   &t;BIT1
DECL|macro|ABTD
mdefine_line|#define ABTD   &t;BIT1
DECL|macro|GAPD
mdefine_line|#define GAPD   &t;BIT1
DECL|macro|BRKE
mdefine_line|#define BRKE   &t;BIT0
DECL|macro|IDLD
mdefine_line|#define IDLD&t;BIT0
multiline_comment|/* IE2 &amp; SR2 */
DECL|macro|EOM
mdefine_line|#define EOM&t;BIT7
DECL|macro|PMP
mdefine_line|#define PMP&t;BIT6
DECL|macro|SHRT
mdefine_line|#define SHRT&t;BIT6
DECL|macro|PE
mdefine_line|#define PE&t;BIT5
DECL|macro|ABT
mdefine_line|#define ABT&t;BIT5
DECL|macro|FRME
mdefine_line|#define FRME&t;BIT4
DECL|macro|RBIT
mdefine_line|#define RBIT&t;BIT4
DECL|macro|OVRN
mdefine_line|#define OVRN&t;BIT3
DECL|macro|CRCE
mdefine_line|#define CRCE&t;BIT2
multiline_comment|/*&n; * Global linked list of SyncLink devices&n; */
DECL|variable|synclinkmp_device_list
r_static
id|SLMP_INFO
op_star
id|synclinkmp_device_list
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|synclinkmp_adapter_count
r_static
r_int
id|synclinkmp_adapter_count
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|variable|synclinkmp_device_count
r_static
r_int
id|synclinkmp_device_count
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n; * Set this param to non-zero to load eax with the&n; * .text section address and breakpoint on module load.&n; * This is useful for use with gdb and add-symbol-file command.&n; */
DECL|variable|break_on_load
r_static
r_int
id|break_on_load
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n; * Driver major number, defaults to zero to get auto&n; * assigned major number. May be forced as module parameter.&n; */
DECL|variable|ttymajor
r_static
r_int
id|ttymajor
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n; * Array of user specified options for ISA adapters.&n; */
DECL|variable|debug_level
r_static
r_int
id|debug_level
op_assign
l_int|0
suffix:semicolon
DECL|variable|maxframe
r_static
r_int
id|maxframe
(braket
id|MAX_DEVICES
)braket
op_assign
(brace
l_int|0
comma
)brace
suffix:semicolon
DECL|variable|dosyncppp
r_static
r_int
id|dosyncppp
(braket
id|MAX_DEVICES
)braket
op_assign
(brace
l_int|0
comma
)brace
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|break_on_load
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|ttymajor
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|debug_level
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|maxframe
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
id|MAX_DEVICES
)paren
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|dosyncppp
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
id|MAX_DEVICES
)paren
l_string|&quot;i&quot;
)paren
suffix:semicolon
DECL|variable|driver_name
r_static
r_char
op_star
id|driver_name
op_assign
l_string|&quot;SyncLink MultiPort driver&quot;
suffix:semicolon
DECL|variable|driver_version
r_static
r_char
op_star
id|driver_version
op_assign
l_string|&quot;$Revision: 4.29 $&quot;
suffix:semicolon
r_static
r_int
id|synclinkmp_init_one
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_const
r_struct
id|pci_device_id
op_star
id|ent
)paren
suffix:semicolon
r_static
r_void
id|synclinkmp_remove_one
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
suffix:semicolon
DECL|variable|synclinkmp_pci_tbl
r_static
r_struct
id|pci_device_id
id|synclinkmp_pci_tbl
(braket
)braket
op_assign
(brace
(brace
id|PCI_VENDOR_ID_MICROGATE
comma
id|PCI_DEVICE_ID_MICROGATE_SCA
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
)brace
comma
(brace
l_int|0
comma
)brace
comma
multiline_comment|/* terminate list */
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|pci
comma
id|synclinkmp_pci_tbl
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
DECL|variable|synclinkmp_pci_driver
r_static
r_struct
id|pci_driver
id|synclinkmp_pci_driver
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;synclinkmp&quot;
comma
dot
id|id_table
op_assign
id|synclinkmp_pci_tbl
comma
dot
id|probe
op_assign
id|synclinkmp_init_one
comma
dot
id|remove
op_assign
id|__devexit_p
c_func
(paren
id|synclinkmp_remove_one
)paren
comma
)brace
suffix:semicolon
DECL|variable|serial_driver
r_static
r_struct
id|tty_driver
op_star
id|serial_driver
suffix:semicolon
multiline_comment|/* number of characters left in xmit buffer before we ask for more */
DECL|macro|WAKEUP_CHARS
mdefine_line|#define WAKEUP_CHARS 256
multiline_comment|/* tty callbacks */
r_static
r_int
id|open
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|filp
)paren
suffix:semicolon
r_static
r_void
id|close
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|filp
)paren
suffix:semicolon
r_static
r_void
id|hangup
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
suffix:semicolon
r_static
r_void
id|set_termios
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|termios
op_star
id|old_termios
)paren
suffix:semicolon
r_static
r_int
id|write
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_const
r_int
r_char
op_star
id|buf
comma
r_int
id|count
)paren
suffix:semicolon
r_static
r_void
id|put_char
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_int
r_char
id|ch
)paren
suffix:semicolon
r_static
r_void
id|send_xchar
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_char
id|ch
)paren
suffix:semicolon
r_static
r_void
id|wait_until_sent
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_int
id|timeout
)paren
suffix:semicolon
r_static
r_int
id|write_room
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
suffix:semicolon
r_static
r_void
id|flush_chars
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
suffix:semicolon
r_static
r_void
id|flush_buffer
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
suffix:semicolon
r_static
r_void
id|tx_hold
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
suffix:semicolon
r_static
r_void
id|tx_release
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
suffix:semicolon
r_static
r_int
id|ioctl
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
suffix:semicolon
r_static
r_int
id|read_proc
c_func
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
suffix:semicolon
r_static
r_int
id|chars_in_buffer
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
suffix:semicolon
r_static
r_void
id|throttle
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
suffix:semicolon
r_static
r_void
id|unthrottle
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
suffix:semicolon
r_static
r_void
id|set_break
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_int
id|break_state
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_HDLC
DECL|macro|dev_to_port
mdefine_line|#define dev_to_port(D) (dev_to_hdlc(D)-&gt;priv)
r_static
r_void
id|hdlcdev_tx_done
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
suffix:semicolon
r_static
r_void
id|hdlcdev_rx
c_func
(paren
id|SLMP_INFO
op_star
id|info
comma
r_char
op_star
id|buf
comma
r_int
id|size
)paren
suffix:semicolon
r_static
r_int
id|hdlcdev_init
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
suffix:semicolon
r_static
r_void
id|hdlcdev_exit
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* ioctl handlers */
r_static
r_int
id|get_stats
c_func
(paren
id|SLMP_INFO
op_star
id|info
comma
r_struct
id|mgsl_icount
id|__user
op_star
id|user_icount
)paren
suffix:semicolon
r_static
r_int
id|get_params
c_func
(paren
id|SLMP_INFO
op_star
id|info
comma
id|MGSL_PARAMS
id|__user
op_star
id|params
)paren
suffix:semicolon
r_static
r_int
id|set_params
c_func
(paren
id|SLMP_INFO
op_star
id|info
comma
id|MGSL_PARAMS
id|__user
op_star
id|params
)paren
suffix:semicolon
r_static
r_int
id|get_txidle
c_func
(paren
id|SLMP_INFO
op_star
id|info
comma
r_int
id|__user
op_star
id|idle_mode
)paren
suffix:semicolon
r_static
r_int
id|set_txidle
c_func
(paren
id|SLMP_INFO
op_star
id|info
comma
r_int
id|idle_mode
)paren
suffix:semicolon
r_static
r_int
id|tx_enable
c_func
(paren
id|SLMP_INFO
op_star
id|info
comma
r_int
id|enable
)paren
suffix:semicolon
r_static
r_int
id|tx_abort
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|rx_enable
c_func
(paren
id|SLMP_INFO
op_star
id|info
comma
r_int
id|enable
)paren
suffix:semicolon
r_static
r_int
id|map_status
c_func
(paren
r_int
id|signals
)paren
suffix:semicolon
r_static
r_int
id|modem_input_wait
c_func
(paren
id|SLMP_INFO
op_star
id|info
comma
r_int
id|arg
)paren
suffix:semicolon
r_static
r_int
id|wait_mgsl_event
c_func
(paren
id|SLMP_INFO
op_star
id|info
comma
r_int
id|__user
op_star
id|mask_ptr
)paren
suffix:semicolon
r_static
r_int
id|tiocmget
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|file
)paren
suffix:semicolon
r_static
r_int
id|tiocmset
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|set
comma
r_int
r_int
id|clear
)paren
suffix:semicolon
r_static
r_void
id|set_break
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_int
id|break_state
)paren
suffix:semicolon
r_static
r_void
id|add_device
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
suffix:semicolon
r_static
r_void
id|device_init
c_func
(paren
r_int
id|adapter_num
comma
r_struct
id|pci_dev
op_star
id|pdev
)paren
suffix:semicolon
r_static
r_int
id|claim_resources
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
suffix:semicolon
r_static
r_void
id|release_resources
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|startup
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|block_til_ready
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|filp
comma
id|SLMP_INFO
op_star
id|info
)paren
suffix:semicolon
r_static
r_void
id|shutdown
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
suffix:semicolon
r_static
r_void
id|program_hw
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
suffix:semicolon
r_static
r_void
id|change_params
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|init_adapter
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|register_test
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|irq_test
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|loopback_test
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|adapter_test
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|memory_test
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
suffix:semicolon
r_static
r_void
id|reset_adapter
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
suffix:semicolon
r_static
r_void
id|reset_port
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
suffix:semicolon
r_static
r_void
id|async_mode
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
suffix:semicolon
r_static
r_void
id|hdlc_mode
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
suffix:semicolon
r_static
r_void
id|rx_stop
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
suffix:semicolon
r_static
r_void
id|rx_start
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
suffix:semicolon
r_static
r_void
id|rx_reset_buffers
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
suffix:semicolon
r_static
r_void
id|rx_free_frame_buffers
c_func
(paren
id|SLMP_INFO
op_star
id|info
comma
r_int
r_int
id|first
comma
r_int
r_int
id|last
)paren
suffix:semicolon
r_static
r_int
id|rx_get_frame
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
suffix:semicolon
r_static
r_void
id|tx_start
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
suffix:semicolon
r_static
r_void
id|tx_stop
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
suffix:semicolon
r_static
r_void
id|tx_load_fifo
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
suffix:semicolon
r_static
r_void
id|tx_set_idle
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
suffix:semicolon
r_static
r_void
id|tx_load_dma_buffer
c_func
(paren
id|SLMP_INFO
op_star
id|info
comma
r_const
r_char
op_star
id|buf
comma
r_int
r_int
id|count
)paren
suffix:semicolon
r_static
r_void
id|get_signals
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
suffix:semicolon
r_static
r_void
id|set_signals
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
suffix:semicolon
r_static
r_void
id|enable_loopback
c_func
(paren
id|SLMP_INFO
op_star
id|info
comma
r_int
id|enable
)paren
suffix:semicolon
r_static
r_void
id|set_rate
c_func
(paren
id|SLMP_INFO
op_star
id|info
comma
id|u32
id|data_rate
)paren
suffix:semicolon
r_static
r_int
id|bh_action
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
suffix:semicolon
r_static
r_void
id|bh_handler
c_func
(paren
r_void
op_star
id|Context
)paren
suffix:semicolon
r_static
r_void
id|bh_receive
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
suffix:semicolon
r_static
r_void
id|bh_transmit
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
suffix:semicolon
r_static
r_void
id|bh_status
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
suffix:semicolon
r_static
r_void
id|isr_timer
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
suffix:semicolon
r_static
r_void
id|isr_rxint
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
suffix:semicolon
r_static
r_void
id|isr_rxrdy
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
suffix:semicolon
r_static
r_void
id|isr_txint
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
suffix:semicolon
r_static
r_void
id|isr_txrdy
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
suffix:semicolon
r_static
r_void
id|isr_rxdmaok
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
suffix:semicolon
r_static
r_void
id|isr_rxdmaerror
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
suffix:semicolon
r_static
r_void
id|isr_txdmaok
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
suffix:semicolon
r_static
r_void
id|isr_txdmaerror
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
suffix:semicolon
r_static
r_void
id|isr_io_pin
c_func
(paren
id|SLMP_INFO
op_star
id|info
comma
id|u16
id|status
)paren
suffix:semicolon
r_static
r_int
id|alloc_dma_bufs
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
suffix:semicolon
r_static
r_void
id|free_dma_bufs
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|alloc_buf_list
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
suffix:semicolon
r_static
r_int
id|alloc_frame_bufs
c_func
(paren
id|SLMP_INFO
op_star
id|info
comma
id|SCADESC
op_star
id|list
comma
id|SCADESC_EX
op_star
id|list_ex
comma
r_int
id|count
)paren
suffix:semicolon
r_static
r_int
id|alloc_tmp_rx_buf
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
suffix:semicolon
r_static
r_void
id|free_tmp_rx_buf
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
suffix:semicolon
r_static
r_void
id|load_pci_memory
c_func
(paren
id|SLMP_INFO
op_star
id|info
comma
r_char
op_star
id|dest
comma
r_const
r_char
op_star
id|src
comma
r_int
r_int
id|count
)paren
suffix:semicolon
r_static
r_void
id|trace_block
c_func
(paren
id|SLMP_INFO
op_star
id|info
comma
r_const
r_char
op_star
id|data
comma
r_int
id|count
comma
r_int
id|xmit
)paren
suffix:semicolon
r_static
r_void
id|tx_timeout
c_func
(paren
r_int
r_int
id|context
)paren
suffix:semicolon
r_static
r_void
id|status_timeout
c_func
(paren
r_int
r_int
id|context
)paren
suffix:semicolon
r_static
r_int
r_char
id|read_reg
c_func
(paren
id|SLMP_INFO
op_star
id|info
comma
r_int
r_char
id|addr
)paren
suffix:semicolon
r_static
r_void
id|write_reg
c_func
(paren
id|SLMP_INFO
op_star
id|info
comma
r_int
r_char
id|addr
comma
r_int
r_char
id|val
)paren
suffix:semicolon
r_static
id|u16
id|read_reg16
c_func
(paren
id|SLMP_INFO
op_star
id|info
comma
r_int
r_char
id|addr
)paren
suffix:semicolon
r_static
r_void
id|write_reg16
c_func
(paren
id|SLMP_INFO
op_star
id|info
comma
r_int
r_char
id|addr
comma
id|u16
id|val
)paren
suffix:semicolon
r_static
r_int
r_char
id|read_status_reg
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
suffix:semicolon
r_static
r_void
id|write_control_reg
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
suffix:semicolon
DECL|variable|rx_active_fifo_level
r_static
r_int
r_char
id|rx_active_fifo_level
op_assign
l_int|16
suffix:semicolon
singleline_comment|// rx request FIFO activation level in bytes
DECL|variable|tx_active_fifo_level
r_static
r_int
r_char
id|tx_active_fifo_level
op_assign
l_int|16
suffix:semicolon
singleline_comment|// tx request FIFO activation level in bytes
DECL|variable|tx_negate_fifo_level
r_static
r_int
r_char
id|tx_negate_fifo_level
op_assign
l_int|32
suffix:semicolon
singleline_comment|// tx request FIFO negation level in bytes
DECL|variable|misc_ctrl_value
r_static
id|u32
id|misc_ctrl_value
op_assign
l_int|0x007e4040
suffix:semicolon
DECL|variable|lcr1_brdr_value
r_static
id|u32
id|lcr1_brdr_value
op_assign
l_int|0x00800029
suffix:semicolon
DECL|variable|read_ahead_count
r_static
id|u32
id|read_ahead_count
op_assign
l_int|8
suffix:semicolon
multiline_comment|/* DPCR, DMA Priority Control&n; *&n; * 07..05  Not used, must be 0&n; * 04      BRC, bus release condition: 0=all transfers complete&n; *              1=release after 1 xfer on all channels&n; * 03      CCC, channel change condition: 0=every cycle&n; *              1=after each channel completes all xfers&n; * 02..00  PR&lt;2..0&gt;, priority 100=round robin&n; *&n; * 00000100 = 0x00&n; */
DECL|variable|dma_priority
r_static
r_int
r_char
id|dma_priority
op_assign
l_int|0x04
suffix:semicolon
singleline_comment|// Number of bytes that can be written to shared RAM
singleline_comment|// in a single write operation
DECL|variable|sca_pci_load_interval
r_static
id|u32
id|sca_pci_load_interval
op_assign
l_int|64
suffix:semicolon
multiline_comment|/*&n; * 1st function defined in .text section. Calling this function in&n; * init_module() followed by a breakpoint allows a remote debugger&n; * (gdb) to get the .text address for the add-symbol-file command.&n; * This allows remote debugging of dynamically loadable modules.&n; */
r_static
r_void
op_star
id|synclinkmp_get_text_ptr
c_func
(paren
r_void
)paren
suffix:semicolon
DECL|function|synclinkmp_get_text_ptr
r_static
r_void
op_star
id|synclinkmp_get_text_ptr
c_func
(paren
r_void
)paren
(brace
r_return
id|synclinkmp_get_text_ptr
suffix:semicolon
)brace
DECL|function|sanity_check
r_static
r_inline
r_int
id|sanity_check
c_func
(paren
id|SLMP_INFO
op_star
id|info
comma
r_char
op_star
id|name
comma
r_const
r_char
op_star
id|routine
)paren
(brace
macro_line|#ifdef SANITY_CHECK
r_static
r_const
r_char
op_star
id|badmagic
op_assign
l_string|&quot;Warning: bad magic number for synclinkmp_struct (%s) in %s&bslash;n&quot;
suffix:semicolon
r_static
r_const
r_char
op_star
id|badinfo
op_assign
l_string|&quot;Warning: null synclinkmp_struct for (%s) in %s&bslash;n&quot;
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info
)paren
(brace
id|printk
c_func
(paren
id|badinfo
comma
id|name
comma
id|routine
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|info-&gt;magic
op_ne
id|MGSL_MAGIC
)paren
(brace
id|printk
c_func
(paren
id|badmagic
comma
id|name
comma
id|routine
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
macro_line|#else
r_if
c_cond
(paren
op_logical_neg
id|info
)paren
r_return
l_int|1
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * line discipline callback wrappers&n; *&n; * The wrappers maintain line discipline references&n; * while calling into the line discipline.&n; *&n; * ldisc_receive_buf  - pass receive data to line discipline&n; */
DECL|function|ldisc_receive_buf
r_static
r_void
id|ldisc_receive_buf
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_const
id|__u8
op_star
id|data
comma
r_char
op_star
id|flags
comma
r_int
id|count
)paren
(brace
r_struct
id|tty_ldisc
op_star
id|ld
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tty
)paren
r_return
suffix:semicolon
id|ld
op_assign
id|tty_ldisc_ref
c_func
(paren
id|tty
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ld
)paren
(brace
r_if
c_cond
(paren
id|ld-&gt;receive_buf
)paren
id|ld
op_member_access_from_pointer
id|receive_buf
c_func
(paren
id|tty
comma
id|data
comma
id|flags
comma
id|count
)paren
suffix:semicolon
id|tty_ldisc_deref
c_func
(paren
id|ld
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* tty callbacks */
multiline_comment|/* Called when a port is opened.  Init and enable port.&n; */
DECL|function|open
r_static
r_int
id|open
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
id|SLMP_INFO
op_star
id|info
suffix:semicolon
r_int
id|retval
comma
id|line
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|line
op_assign
id|tty-&gt;index
suffix:semicolon
r_if
c_cond
(paren
(paren
id|line
OL
l_int|0
)paren
op_logical_or
(paren
id|line
op_ge
id|synclinkmp_device_count
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s(%d): open with invalid line #%d.&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|line
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|info
op_assign
id|synclinkmp_device_list
suffix:semicolon
r_while
c_loop
(paren
id|info
op_logical_and
id|info-&gt;line
op_ne
id|line
)paren
(brace
id|info
op_assign
id|info-&gt;next_device
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sanity_check
c_func
(paren
id|info
comma
id|tty-&gt;name
comma
l_string|&quot;open&quot;
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;init_error
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s device is not allocated, init error=%d&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
comma
id|info-&gt;init_error
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|tty-&gt;driver_data
op_assign
id|info
suffix:semicolon
id|info-&gt;tty
op_assign
id|tty
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s open(), old ref count = %d&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|tty-&gt;driver-&gt;name
comma
id|info-&gt;count
)paren
suffix:semicolon
multiline_comment|/* If port is closing, signal caller to try again */
r_if
c_cond
(paren
id|tty_hung_up_p
c_func
(paren
id|filp
)paren
op_logical_or
id|info-&gt;flags
op_amp
id|ASYNC_CLOSING
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;flags
op_amp
id|ASYNC_CLOSING
)paren
id|interruptible_sleep_on
c_func
(paren
op_amp
id|info-&gt;close_wait
)paren
suffix:semicolon
id|retval
op_assign
(paren
(paren
id|info-&gt;flags
op_amp
id|ASYNC_HUP_NOTIFY
)paren
ques
c_cond
op_minus
id|EAGAIN
suffix:colon
op_minus
id|ERESTARTSYS
)paren
suffix:semicolon
r_goto
id|cleanup
suffix:semicolon
)brace
id|info-&gt;tty-&gt;low_latency
op_assign
(paren
id|info-&gt;flags
op_amp
id|ASYNC_LOW_LATENCY
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;netlock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;netcount
)paren
(brace
id|retval
op_assign
op_minus
id|EBUSY
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;netlock
comma
id|flags
)paren
suffix:semicolon
r_goto
id|cleanup
suffix:semicolon
)brace
id|info-&gt;count
op_increment
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;netlock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;count
op_eq
l_int|1
)paren
(brace
multiline_comment|/* 1st open on this device, init hardware */
id|retval
op_assign
id|startup
c_func
(paren
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
OL
l_int|0
)paren
r_goto
id|cleanup
suffix:semicolon
)brace
id|retval
op_assign
id|block_til_ready
c_func
(paren
id|tty
comma
id|filp
comma
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
(brace
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s block_til_ready() returned %d&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
comma
id|retval
)paren
suffix:semicolon
r_goto
id|cleanup
suffix:semicolon
)brace
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s open() success&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
)paren
suffix:semicolon
id|retval
op_assign
l_int|0
suffix:semicolon
id|cleanup
suffix:colon
r_if
c_cond
(paren
id|retval
)paren
(brace
r_if
c_cond
(paren
id|tty-&gt;count
op_eq
l_int|1
)paren
id|info-&gt;tty
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* tty layer will release tty struct */
r_if
c_cond
(paren
id|info-&gt;count
)paren
(brace
id|info-&gt;count
op_decrement
suffix:semicolon
)brace
)brace
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* Called when port is closed. Wait for remaining data to be&n; * sent. Disable port and free resources.&n; */
DECL|function|close
r_static
r_void
id|close
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
id|SLMP_INFO
op_star
id|info
op_assign
(paren
id|SLMP_INFO
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
id|sanity_check
c_func
(paren
id|info
comma
id|tty-&gt;name
comma
l_string|&quot;close&quot;
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s close() entry, count=%d&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
comma
id|info-&gt;count
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;count
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|tty_hung_up_p
c_func
(paren
id|filp
)paren
)paren
r_goto
id|cleanup
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tty-&gt;count
op_eq
l_int|1
)paren
op_logical_and
(paren
id|info-&gt;count
op_ne
l_int|1
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t; * tty-&gt;count is 1 and the tty structure will be freed.&n;&t;&t; * info-&gt;count should be one in this case.&n;&t;&t; * if it&squot;s not, correct it so that the port is shutdown.&n;&t;&t; */
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s close: bad refcount; tty-&gt;count is 1, &quot;
l_string|&quot;info-&gt;count is %d&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
comma
id|info-&gt;count
)paren
suffix:semicolon
id|info-&gt;count
op_assign
l_int|1
suffix:semicolon
)brace
id|info-&gt;count
op_decrement
suffix:semicolon
multiline_comment|/* if at least one open remaining, leave hardware active */
r_if
c_cond
(paren
id|info-&gt;count
)paren
r_goto
id|cleanup
suffix:semicolon
id|info-&gt;flags
op_or_assign
id|ASYNC_CLOSING
suffix:semicolon
multiline_comment|/* set tty-&gt;closing to notify line discipline to&n;&t; * only process XON/XOFF characters. Only the N_TTY&n;&t; * discipline appears to use this (ppp does not).&n;&t; */
id|tty-&gt;closing
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* wait for transmit data to clear all layers */
r_if
c_cond
(paren
id|info-&gt;closing_wait
op_ne
id|ASYNC_CLOSING_WAIT_NONE
)paren
(brace
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s close() calling tty_wait_until_sent&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
)paren
suffix:semicolon
id|tty_wait_until_sent
c_func
(paren
id|tty
comma
id|info-&gt;closing_wait
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|info-&gt;flags
op_amp
id|ASYNC_INITIALIZED
)paren
id|wait_until_sent
c_func
(paren
id|tty
comma
id|info-&gt;timeout
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tty-&gt;driver-&gt;flush_buffer
)paren
id|tty-&gt;driver
op_member_access_from_pointer
id|flush_buffer
c_func
(paren
id|tty
)paren
suffix:semicolon
id|tty_ldisc_flush
c_func
(paren
id|tty
)paren
suffix:semicolon
id|shutdown
c_func
(paren
id|info
)paren
suffix:semicolon
id|tty-&gt;closing
op_assign
l_int|0
suffix:semicolon
id|info-&gt;tty
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;blocked_open
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;close_delay
)paren
(brace
id|msleep_interruptible
c_func
(paren
id|jiffies_to_msecs
c_func
(paren
id|info-&gt;close_delay
)paren
)paren
suffix:semicolon
)brace
id|wake_up_interruptible
c_func
(paren
op_amp
id|info-&gt;open_wait
)paren
suffix:semicolon
)brace
id|info-&gt;flags
op_and_assign
op_complement
(paren
id|ASYNC_NORMAL_ACTIVE
op_or
id|ASYNC_CLOSING
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|info-&gt;close_wait
)paren
suffix:semicolon
id|cleanup
suffix:colon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s close() exit, count=%d&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|tty-&gt;driver-&gt;name
comma
id|info-&gt;count
)paren
suffix:semicolon
)brace
multiline_comment|/* Called by tty_hangup() when a hangup is signaled.&n; * This is the same as closing all open descriptors for the port.&n; */
DECL|function|hangup
r_static
r_void
id|hangup
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
id|SLMP_INFO
op_star
id|info
op_assign
(paren
id|SLMP_INFO
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s hangup()&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sanity_check
c_func
(paren
id|info
comma
id|tty-&gt;name
comma
l_string|&quot;hangup&quot;
)paren
)paren
r_return
suffix:semicolon
id|flush_buffer
c_func
(paren
id|tty
)paren
suffix:semicolon
id|shutdown
c_func
(paren
id|info
)paren
suffix:semicolon
id|info-&gt;count
op_assign
l_int|0
suffix:semicolon
id|info-&gt;flags
op_and_assign
op_complement
id|ASYNC_NORMAL_ACTIVE
suffix:semicolon
id|info-&gt;tty
op_assign
l_int|NULL
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|info-&gt;open_wait
)paren
suffix:semicolon
)brace
multiline_comment|/* Set new termios settings&n; */
DECL|function|set_termios
r_static
r_void
id|set_termios
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|termios
op_star
id|old_termios
)paren
(brace
id|SLMP_INFO
op_star
id|info
op_assign
(paren
id|SLMP_INFO
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s set_termios()&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|tty-&gt;driver-&gt;name
)paren
suffix:semicolon
multiline_comment|/* just return if nothing has changed */
r_if
c_cond
(paren
(paren
id|tty-&gt;termios-&gt;c_cflag
op_eq
id|old_termios-&gt;c_cflag
)paren
op_logical_and
(paren
id|RELEVANT_IFLAG
c_func
(paren
id|tty-&gt;termios-&gt;c_iflag
)paren
op_eq
id|RELEVANT_IFLAG
c_func
(paren
id|old_termios-&gt;c_iflag
)paren
)paren
)paren
r_return
suffix:semicolon
id|change_params
c_func
(paren
id|info
)paren
suffix:semicolon
multiline_comment|/* Handle transition to B0 status */
r_if
c_cond
(paren
id|old_termios-&gt;c_cflag
op_amp
id|CBAUD
op_logical_and
op_logical_neg
(paren
id|tty-&gt;termios-&gt;c_cflag
op_amp
id|CBAUD
)paren
)paren
(brace
id|info-&gt;serial_signals
op_and_assign
op_complement
(paren
id|SerialSignal_RTS
op_plus
id|SerialSignal_DTR
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|set_signals
c_func
(paren
id|info
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* Handle transition away from B0 status */
r_if
c_cond
(paren
op_logical_neg
(paren
id|old_termios-&gt;c_cflag
op_amp
id|CBAUD
)paren
op_logical_and
id|tty-&gt;termios-&gt;c_cflag
op_amp
id|CBAUD
)paren
(brace
id|info-&gt;serial_signals
op_or_assign
id|SerialSignal_DTR
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|tty-&gt;termios-&gt;c_cflag
op_amp
id|CRTSCTS
)paren
op_logical_or
op_logical_neg
id|test_bit
c_func
(paren
id|TTY_THROTTLED
comma
op_amp
id|tty-&gt;flags
)paren
)paren
(brace
id|info-&gt;serial_signals
op_or_assign
id|SerialSignal_RTS
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|set_signals
c_func
(paren
id|info
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* Handle turning off CRTSCTS */
r_if
c_cond
(paren
id|old_termios-&gt;c_cflag
op_amp
id|CRTSCTS
op_logical_and
op_logical_neg
(paren
id|tty-&gt;termios-&gt;c_cflag
op_amp
id|CRTSCTS
)paren
)paren
(brace
id|tty-&gt;hw_stopped
op_assign
l_int|0
suffix:semicolon
id|tx_release
c_func
(paren
id|tty
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Send a block of data&n; *&n; * Arguments:&n; *&n; * &t;tty&t;&t;pointer to tty information structure&n; * &t;buf&t;&t;pointer to buffer containing send data&n; * &t;count&t;&t;size of send data in bytes&n; *&n; * Return Value:&t;number of characters written&n; */
DECL|function|write
r_static
r_int
id|write
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_const
r_int
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_int
id|c
comma
id|ret
op_assign
l_int|0
suffix:semicolon
id|SLMP_INFO
op_star
id|info
op_assign
(paren
id|SLMP_INFO
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s write() count=%d&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
comma
id|count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sanity_check
c_func
(paren
id|info
comma
id|tty-&gt;name
comma
l_string|&quot;write&quot;
)paren
)paren
r_goto
id|cleanup
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tty
op_logical_or
op_logical_neg
id|info-&gt;tx_buf
)paren
r_goto
id|cleanup
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;params.mode
op_eq
id|MGSL_MODE_HDLC
)paren
(brace
r_if
c_cond
(paren
id|count
OG
id|info-&gt;max_frame_size
)paren
(brace
id|ret
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|cleanup
suffix:semicolon
)brace
r_if
c_cond
(paren
id|info-&gt;tx_active
)paren
r_goto
id|cleanup
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;tx_count
)paren
(brace
multiline_comment|/* send accumulated data from send_char() calls */
multiline_comment|/* as frame and wait before accepting more data. */
id|tx_load_dma_buffer
c_func
(paren
id|info
comma
id|info-&gt;tx_buf
comma
id|info-&gt;tx_count
)paren
suffix:semicolon
r_goto
id|start
suffix:semicolon
)brace
id|ret
op_assign
id|info-&gt;tx_count
op_assign
id|count
suffix:semicolon
id|tx_load_dma_buffer
c_func
(paren
id|info
comma
id|buf
comma
id|count
)paren
suffix:semicolon
r_goto
id|start
suffix:semicolon
)brace
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|c
op_assign
id|min_t
c_func
(paren
r_int
comma
id|count
comma
id|min
c_func
(paren
id|info-&gt;max_frame_size
op_minus
id|info-&gt;tx_count
op_minus
l_int|1
comma
id|info-&gt;max_frame_size
op_minus
id|info-&gt;tx_put
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|c
op_le
l_int|0
)paren
r_break
suffix:semicolon
id|memcpy
c_func
(paren
id|info-&gt;tx_buf
op_plus
id|info-&gt;tx_put
comma
id|buf
comma
id|c
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|info-&gt;tx_put
op_add_assign
id|c
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;tx_put
op_ge
id|info-&gt;max_frame_size
)paren
id|info-&gt;tx_put
op_sub_assign
id|info-&gt;max_frame_size
suffix:semicolon
id|info-&gt;tx_count
op_add_assign
id|c
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|buf
op_add_assign
id|c
suffix:semicolon
id|count
op_sub_assign
id|c
suffix:semicolon
id|ret
op_add_assign
id|c
suffix:semicolon
)brace
r_if
c_cond
(paren
id|info-&gt;params.mode
op_eq
id|MGSL_MODE_HDLC
)paren
(brace
r_if
c_cond
(paren
id|count
)paren
(brace
id|ret
op_assign
id|info-&gt;tx_count
op_assign
l_int|0
suffix:semicolon
r_goto
id|cleanup
suffix:semicolon
)brace
id|tx_load_dma_buffer
c_func
(paren
id|info
comma
id|info-&gt;tx_buf
comma
id|info-&gt;tx_count
)paren
suffix:semicolon
)brace
id|start
suffix:colon
r_if
c_cond
(paren
id|info-&gt;tx_count
op_logical_and
op_logical_neg
id|tty-&gt;stopped
op_logical_and
op_logical_neg
id|tty-&gt;hw_stopped
)paren
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;tx_active
)paren
id|tx_start
c_func
(paren
id|info
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
id|cleanup
suffix:colon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s write() returning=%d&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
comma
id|ret
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* Add a character to the transmit buffer.&n; */
DECL|function|put_char
r_static
r_void
id|put_char
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_int
r_char
id|ch
)paren
(brace
id|SLMP_INFO
op_star
id|info
op_assign
(paren
id|SLMP_INFO
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s put_char(%d)&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
comma
id|ch
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sanity_check
c_func
(paren
id|info
comma
id|tty-&gt;name
comma
l_string|&quot;put_char&quot;
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tty
op_logical_or
op_logical_neg
id|info-&gt;tx_buf
)paren
r_return
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|info-&gt;params.mode
op_ne
id|MGSL_MODE_HDLC
)paren
op_logical_or
op_logical_neg
id|info-&gt;tx_active
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;tx_count
OL
id|info-&gt;max_frame_size
op_minus
l_int|1
)paren
(brace
id|info-&gt;tx_buf
(braket
id|info-&gt;tx_put
op_increment
)braket
op_assign
id|ch
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;tx_put
op_ge
id|info-&gt;max_frame_size
)paren
id|info-&gt;tx_put
op_sub_assign
id|info-&gt;max_frame_size
suffix:semicolon
id|info-&gt;tx_count
op_increment
suffix:semicolon
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* Send a high-priority XON/XOFF character&n; */
DECL|function|send_xchar
r_static
r_void
id|send_xchar
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_char
id|ch
)paren
(brace
id|SLMP_INFO
op_star
id|info
op_assign
(paren
id|SLMP_INFO
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s send_xchar(%d)&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
comma
id|ch
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sanity_check
c_func
(paren
id|info
comma
id|tty-&gt;name
comma
l_string|&quot;send_xchar&quot;
)paren
)paren
r_return
suffix:semicolon
id|info-&gt;x_char
op_assign
id|ch
suffix:semicolon
r_if
c_cond
(paren
id|ch
)paren
(brace
multiline_comment|/* Make sure transmit interrupts are on */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;tx_enabled
)paren
id|tx_start
c_func
(paren
id|info
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Wait until the transmitter is empty.&n; */
DECL|function|wait_until_sent
r_static
r_void
id|wait_until_sent
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_int
id|timeout
)paren
(brace
id|SLMP_INFO
op_star
id|info
op_assign
(paren
id|SLMP_INFO
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_int
r_int
id|orig_jiffies
comma
id|char_time
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s wait_until_sent() entry&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sanity_check
c_func
(paren
id|info
comma
id|tty-&gt;name
comma
l_string|&quot;wait_until_sent&quot;
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|info-&gt;flags
op_amp
id|ASYNC_INITIALIZED
)paren
)paren
r_goto
m_exit
suffix:semicolon
id|orig_jiffies
op_assign
id|jiffies
suffix:semicolon
multiline_comment|/* Set check interval to 1/5 of estimated time to&n;&t; * send a character, and make it at least 1. The check&n;&t; * interval should also be less than the timeout.&n;&t; * Note: use tight timings here to satisfy the NIST-PCTS.&n;&t; */
r_if
c_cond
(paren
id|info-&gt;params.data_rate
)paren
(brace
id|char_time
op_assign
id|info-&gt;timeout
op_div
(paren
l_int|32
op_star
l_int|5
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|char_time
)paren
id|char_time
op_increment
suffix:semicolon
)brace
r_else
id|char_time
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|timeout
)paren
id|char_time
op_assign
id|min_t
c_func
(paren
r_int
r_int
comma
id|char_time
comma
id|timeout
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;params.mode
op_eq
id|MGSL_MODE_HDLC
)paren
(brace
r_while
c_loop
(paren
id|info-&gt;tx_active
)paren
(brace
id|msleep_interruptible
c_func
(paren
id|jiffies_to_msecs
c_func
(paren
id|char_time
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|timeout
op_logical_and
id|time_after
c_func
(paren
id|jiffies
comma
id|orig_jiffies
op_plus
id|timeout
)paren
)paren
r_break
suffix:semicolon
)brace
)brace
r_else
(brace
singleline_comment|//TODO: determine if there is something similar to USC16C32
singleline_comment|// &t;TXSTATUS_ALL_SENT status
r_while
c_loop
(paren
id|info-&gt;tx_active
op_logical_and
id|info-&gt;tx_enabled
)paren
(brace
id|msleep_interruptible
c_func
(paren
id|jiffies_to_msecs
c_func
(paren
id|char_time
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|timeout
op_logical_and
id|time_after
c_func
(paren
id|jiffies
comma
id|orig_jiffies
op_plus
id|timeout
)paren
)paren
r_break
suffix:semicolon
)brace
)brace
m_exit
suffix:colon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s wait_until_sent() exit&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
)paren
suffix:semicolon
)brace
multiline_comment|/* Return the count of free bytes in transmit buffer&n; */
DECL|function|write_room
r_static
r_int
id|write_room
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
id|SLMP_INFO
op_star
id|info
op_assign
(paren
id|SLMP_INFO
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
id|sanity_check
c_func
(paren
id|info
comma
id|tty-&gt;name
comma
l_string|&quot;write_room&quot;
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;params.mode
op_eq
id|MGSL_MODE_HDLC
)paren
(brace
id|ret
op_assign
(paren
id|info-&gt;tx_active
)paren
ques
c_cond
l_int|0
suffix:colon
id|HDLC_MAX_FRAME_SIZE
suffix:semicolon
)brace
r_else
(brace
id|ret
op_assign
id|info-&gt;max_frame_size
op_minus
id|info-&gt;tx_count
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
id|ret
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s write_room()=%d&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
comma
id|ret
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* enable transmitter and send remaining buffered characters&n; */
DECL|function|flush_chars
r_static
r_void
id|flush_chars
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
id|SLMP_INFO
op_star
id|info
op_assign
(paren
id|SLMP_INFO
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s flush_chars() entry tx_count=%d&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
comma
id|info-&gt;tx_count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sanity_check
c_func
(paren
id|info
comma
id|tty-&gt;name
comma
l_string|&quot;flush_chars&quot;
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;tx_count
op_le
l_int|0
op_logical_or
id|tty-&gt;stopped
op_logical_or
id|tty-&gt;hw_stopped
op_logical_or
op_logical_neg
id|info-&gt;tx_buf
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s flush_chars() entry, starting transmitter&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;tx_active
)paren
(brace
r_if
c_cond
(paren
(paren
id|info-&gt;params.mode
op_eq
id|MGSL_MODE_HDLC
)paren
op_logical_and
id|info-&gt;tx_count
)paren
(brace
multiline_comment|/* operating in synchronous (frame oriented) mode */
multiline_comment|/* copy data from circular tx_buf to */
multiline_comment|/* transmit DMA buffer. */
id|tx_load_dma_buffer
c_func
(paren
id|info
comma
id|info-&gt;tx_buf
comma
id|info-&gt;tx_count
)paren
suffix:semicolon
)brace
id|tx_start
c_func
(paren
id|info
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* Discard all data in the send buffer&n; */
DECL|function|flush_buffer
r_static
r_void
id|flush_buffer
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
id|SLMP_INFO
op_star
id|info
op_assign
(paren
id|SLMP_INFO
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s flush_buffer() entry&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sanity_check
c_func
(paren
id|info
comma
id|tty-&gt;name
comma
l_string|&quot;flush_buffer&quot;
)paren
)paren
r_return
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|info-&gt;tx_count
op_assign
id|info-&gt;tx_put
op_assign
id|info-&gt;tx_get
op_assign
l_int|0
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|info-&gt;tx_timer
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|tty-&gt;write_wait
)paren
suffix:semicolon
id|tty_wakeup
c_func
(paren
id|tty
)paren
suffix:semicolon
)brace
multiline_comment|/* throttle (stop) transmitter&n; */
DECL|function|tx_hold
r_static
r_void
id|tx_hold
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
id|SLMP_INFO
op_star
id|info
op_assign
(paren
id|SLMP_INFO
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|sanity_check
c_func
(paren
id|info
comma
id|tty-&gt;name
comma
l_string|&quot;tx_hold&quot;
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s tx_hold()&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;tx_enabled
)paren
id|tx_stop
c_func
(paren
id|info
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* release (start) transmitter&n; */
DECL|function|tx_release
r_static
r_void
id|tx_release
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
id|SLMP_INFO
op_star
id|info
op_assign
(paren
id|SLMP_INFO
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|sanity_check
c_func
(paren
id|info
comma
id|tty-&gt;name
comma
l_string|&quot;tx_release&quot;
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s tx_release()&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;tx_enabled
)paren
id|tx_start
c_func
(paren
id|info
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* Service an IOCTL request&n; *&n; * Arguments:&n; *&n; * &t;tty&t;pointer to tty instance data&n; * &t;file&t;pointer to associated file object for device&n; * &t;cmd&t;IOCTL command code&n; * &t;arg&t;command argument/context&n; *&n; * Return Value:&t;0 if success, otherwise error code&n; */
DECL|function|ioctl
r_static
r_int
id|ioctl
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
id|SLMP_INFO
op_star
id|info
op_assign
(paren
id|SLMP_INFO
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_int
id|error
suffix:semicolon
r_struct
id|mgsl_icount
id|cnow
suffix:semicolon
multiline_comment|/* kernel counter temps */
r_struct
id|serial_icounter_struct
id|__user
op_star
id|p_cuser
suffix:semicolon
multiline_comment|/* user space */
r_int
r_int
id|flags
suffix:semicolon
r_void
id|__user
op_star
id|argp
op_assign
(paren
r_void
id|__user
op_star
)paren
id|arg
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s ioctl() cmd=%08X&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
comma
id|cmd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sanity_check
c_func
(paren
id|info
comma
id|tty-&gt;name
comma
l_string|&quot;ioctl&quot;
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
(paren
id|cmd
op_ne
id|TIOCGSERIAL
)paren
op_logical_and
(paren
id|cmd
op_ne
id|TIOCSSERIAL
)paren
op_logical_and
(paren
id|cmd
op_ne
id|TIOCMIWAIT
)paren
op_logical_and
(paren
id|cmd
op_ne
id|TIOCGICOUNT
)paren
)paren
(brace
r_if
c_cond
(paren
id|tty-&gt;flags
op_amp
(paren
l_int|1
op_lshift
id|TTY_IO_ERROR
)paren
)paren
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|MGSL_IOCGPARAMS
suffix:colon
r_return
id|get_params
c_func
(paren
id|info
comma
id|argp
)paren
suffix:semicolon
r_case
id|MGSL_IOCSPARAMS
suffix:colon
r_return
id|set_params
c_func
(paren
id|info
comma
id|argp
)paren
suffix:semicolon
r_case
id|MGSL_IOCGTXIDLE
suffix:colon
r_return
id|get_txidle
c_func
(paren
id|info
comma
id|argp
)paren
suffix:semicolon
r_case
id|MGSL_IOCSTXIDLE
suffix:colon
r_return
id|set_txidle
c_func
(paren
id|info
comma
(paren
r_int
)paren
id|arg
)paren
suffix:semicolon
r_case
id|MGSL_IOCTXENABLE
suffix:colon
r_return
id|tx_enable
c_func
(paren
id|info
comma
(paren
r_int
)paren
id|arg
)paren
suffix:semicolon
r_case
id|MGSL_IOCRXENABLE
suffix:colon
r_return
id|rx_enable
c_func
(paren
id|info
comma
(paren
r_int
)paren
id|arg
)paren
suffix:semicolon
r_case
id|MGSL_IOCTXABORT
suffix:colon
r_return
id|tx_abort
c_func
(paren
id|info
)paren
suffix:semicolon
r_case
id|MGSL_IOCGSTATS
suffix:colon
r_return
id|get_stats
c_func
(paren
id|info
comma
id|argp
)paren
suffix:semicolon
r_case
id|MGSL_IOCWAITEVENT
suffix:colon
r_return
id|wait_mgsl_event
c_func
(paren
id|info
comma
id|argp
)paren
suffix:semicolon
r_case
id|MGSL_IOCLOOPTXDONE
suffix:colon
r_return
l_int|0
suffix:semicolon
singleline_comment|// TODO: Not supported, need to document
multiline_comment|/* Wait for modem input (DCD,RI,DSR,CTS) change&n;&t;&t; * as specified by mask in arg (TIOCM_RNG/DSR/CD/CTS)&n;&t;&t; */
r_case
id|TIOCMIWAIT
suffix:colon
r_return
id|modem_input_wait
c_func
(paren
id|info
comma
(paren
r_int
)paren
id|arg
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Get counter of input serial line interrupts (DCD,RI,DSR,CTS)&n;&t;&t; * Return: write counters to the user passed counter struct&n;&t;&t; * NB: both 1-&gt;0 and 0-&gt;1 transitions are counted except for&n;&t;&t; *     RI where only 0-&gt;1 is counted.&n;&t;&t; */
r_case
id|TIOCGICOUNT
suffix:colon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|cnow
op_assign
id|info-&gt;icount
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|p_cuser
op_assign
id|argp
suffix:semicolon
id|PUT_USER
c_func
(paren
id|error
comma
id|cnow.cts
comma
op_amp
id|p_cuser-&gt;cts
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_return
id|error
suffix:semicolon
id|PUT_USER
c_func
(paren
id|error
comma
id|cnow.dsr
comma
op_amp
id|p_cuser-&gt;dsr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_return
id|error
suffix:semicolon
id|PUT_USER
c_func
(paren
id|error
comma
id|cnow.rng
comma
op_amp
id|p_cuser-&gt;rng
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_return
id|error
suffix:semicolon
id|PUT_USER
c_func
(paren
id|error
comma
id|cnow.dcd
comma
op_amp
id|p_cuser-&gt;dcd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_return
id|error
suffix:semicolon
id|PUT_USER
c_func
(paren
id|error
comma
id|cnow.rx
comma
op_amp
id|p_cuser-&gt;rx
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_return
id|error
suffix:semicolon
id|PUT_USER
c_func
(paren
id|error
comma
id|cnow.tx
comma
op_amp
id|p_cuser-&gt;tx
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_return
id|error
suffix:semicolon
id|PUT_USER
c_func
(paren
id|error
comma
id|cnow.frame
comma
op_amp
id|p_cuser-&gt;frame
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_return
id|error
suffix:semicolon
id|PUT_USER
c_func
(paren
id|error
comma
id|cnow.overrun
comma
op_amp
id|p_cuser-&gt;overrun
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_return
id|error
suffix:semicolon
id|PUT_USER
c_func
(paren
id|error
comma
id|cnow.parity
comma
op_amp
id|p_cuser-&gt;parity
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_return
id|error
suffix:semicolon
id|PUT_USER
c_func
(paren
id|error
comma
id|cnow.brk
comma
op_amp
id|p_cuser-&gt;brk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_return
id|error
suffix:semicolon
id|PUT_USER
c_func
(paren
id|error
comma
id|cnow.buf_overrun
comma
op_amp
id|p_cuser-&gt;buf_overrun
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_return
id|error
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * /proc fs routines....&n; */
DECL|function|line_info
r_static
r_inline
r_int
id|line_info
c_func
(paren
r_char
op_star
id|buf
comma
id|SLMP_INFO
op_star
id|info
)paren
(brace
r_char
id|stat_buf
(braket
l_int|30
)braket
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|ret
op_assign
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%s: SCABase=%08x Mem=%08X StatusControl=%08x LCR=%08X&bslash;n&quot;
l_string|&quot;&bslash;tIRQ=%d MaxFrameSize=%u&bslash;n&quot;
comma
id|info-&gt;device_name
comma
id|info-&gt;phys_sca_base
comma
id|info-&gt;phys_memory_base
comma
id|info-&gt;phys_statctrl_base
comma
id|info-&gt;phys_lcr_base
comma
id|info-&gt;irq_level
comma
id|info-&gt;max_frame_size
)paren
suffix:semicolon
multiline_comment|/* output current serial signal states */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|get_signals
c_func
(paren
id|info
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|stat_buf
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|stat_buf
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;serial_signals
op_amp
id|SerialSignal_RTS
)paren
id|strcat
c_func
(paren
id|stat_buf
comma
l_string|&quot;|RTS&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;serial_signals
op_amp
id|SerialSignal_CTS
)paren
id|strcat
c_func
(paren
id|stat_buf
comma
l_string|&quot;|CTS&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;serial_signals
op_amp
id|SerialSignal_DTR
)paren
id|strcat
c_func
(paren
id|stat_buf
comma
l_string|&quot;|DTR&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;serial_signals
op_amp
id|SerialSignal_DSR
)paren
id|strcat
c_func
(paren
id|stat_buf
comma
l_string|&quot;|DSR&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;serial_signals
op_amp
id|SerialSignal_DCD
)paren
id|strcat
c_func
(paren
id|stat_buf
comma
l_string|&quot;|CD&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;serial_signals
op_amp
id|SerialSignal_RI
)paren
id|strcat
c_func
(paren
id|stat_buf
comma
l_string|&quot;|RI&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;params.mode
op_eq
id|MGSL_MODE_HDLC
)paren
(brace
id|ret
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|ret
comma
l_string|&quot;&bslash;tHDLC txok:%d rxok:%d&quot;
comma
id|info-&gt;icount.txok
comma
id|info-&gt;icount.rxok
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;icount.txunder
)paren
id|ret
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|ret
comma
l_string|&quot; txunder:%d&quot;
comma
id|info-&gt;icount.txunder
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;icount.txabort
)paren
id|ret
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|ret
comma
l_string|&quot; txabort:%d&quot;
comma
id|info-&gt;icount.txabort
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;icount.rxshort
)paren
id|ret
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|ret
comma
l_string|&quot; rxshort:%d&quot;
comma
id|info-&gt;icount.rxshort
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;icount.rxlong
)paren
id|ret
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|ret
comma
l_string|&quot; rxlong:%d&quot;
comma
id|info-&gt;icount.rxlong
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;icount.rxover
)paren
id|ret
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|ret
comma
l_string|&quot; rxover:%d&quot;
comma
id|info-&gt;icount.rxover
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;icount.rxcrc
)paren
id|ret
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|ret
comma
l_string|&quot; rxlong:%d&quot;
comma
id|info-&gt;icount.rxcrc
)paren
suffix:semicolon
)brace
r_else
(brace
id|ret
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|ret
comma
l_string|&quot;&bslash;tASYNC tx:%d rx:%d&quot;
comma
id|info-&gt;icount.tx
comma
id|info-&gt;icount.rx
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;icount.frame
)paren
id|ret
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|ret
comma
l_string|&quot; fe:%d&quot;
comma
id|info-&gt;icount.frame
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;icount.parity
)paren
id|ret
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|ret
comma
l_string|&quot; pe:%d&quot;
comma
id|info-&gt;icount.parity
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;icount.brk
)paren
id|ret
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|ret
comma
l_string|&quot; brk:%d&quot;
comma
id|info-&gt;icount.brk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;icount.overrun
)paren
id|ret
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|ret
comma
l_string|&quot; oe:%d&quot;
comma
id|info-&gt;icount.overrun
)paren
suffix:semicolon
)brace
multiline_comment|/* Append serial signal status to end */
id|ret
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|ret
comma
l_string|&quot; %s&bslash;n&quot;
comma
id|stat_buf
op_plus
l_int|1
)paren
suffix:semicolon
id|ret
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|ret
comma
l_string|&quot;&bslash;ttxactive=%d bh_req=%d bh_run=%d pending_bh=%x&bslash;n&quot;
comma
id|info-&gt;tx_active
comma
id|info-&gt;bh_requested
comma
id|info-&gt;bh_running
comma
id|info-&gt;pending_bh
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* Called to print information about devices&n; */
DECL|function|read_proc
r_int
id|read_proc
c_func
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
r_int
id|len
op_assign
l_int|0
comma
id|l
suffix:semicolon
id|off_t
id|begin
op_assign
l_int|0
suffix:semicolon
id|SLMP_INFO
op_star
id|info
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
comma
l_string|&quot;synclinkmp driver:%s&bslash;n&quot;
comma
id|driver_version
)paren
suffix:semicolon
id|info
op_assign
id|synclinkmp_device_list
suffix:semicolon
r_while
c_loop
(paren
id|info
)paren
(brace
id|l
op_assign
id|line_info
c_func
(paren
id|page
op_plus
id|len
comma
id|info
)paren
suffix:semicolon
id|len
op_add_assign
id|l
suffix:semicolon
r_if
c_cond
(paren
id|len
op_plus
id|begin
OG
id|off
op_plus
id|count
)paren
r_goto
id|done
suffix:semicolon
r_if
c_cond
(paren
id|len
op_plus
id|begin
OL
id|off
)paren
(brace
id|begin
op_add_assign
id|len
suffix:semicolon
id|len
op_assign
l_int|0
suffix:semicolon
)brace
id|info
op_assign
id|info-&gt;next_device
suffix:semicolon
)brace
op_star
id|eof
op_assign
l_int|1
suffix:semicolon
id|done
suffix:colon
r_if
c_cond
(paren
id|off
op_ge
id|len
op_plus
id|begin
)paren
r_return
l_int|0
suffix:semicolon
op_star
id|start
op_assign
id|page
op_plus
(paren
id|off
op_minus
id|begin
)paren
suffix:semicolon
r_return
(paren
(paren
id|count
OL
id|begin
op_plus
id|len
op_minus
id|off
)paren
ques
c_cond
id|count
suffix:colon
id|begin
op_plus
id|len
op_minus
id|off
)paren
suffix:semicolon
)brace
multiline_comment|/* Return the count of bytes in transmit buffer&n; */
DECL|function|chars_in_buffer
r_static
r_int
id|chars_in_buffer
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
id|SLMP_INFO
op_star
id|info
op_assign
(paren
id|SLMP_INFO
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
id|sanity_check
c_func
(paren
id|info
comma
id|tty-&gt;name
comma
l_string|&quot;chars_in_buffer&quot;
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s chars_in_buffer()=%d&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
comma
id|info-&gt;tx_count
)paren
suffix:semicolon
r_return
id|info-&gt;tx_count
suffix:semicolon
)brace
multiline_comment|/* Signal remote device to throttle send data (our receive data)&n; */
DECL|function|throttle
r_static
r_void
id|throttle
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
id|SLMP_INFO
op_star
id|info
op_assign
(paren
id|SLMP_INFO
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s throttle() entry&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sanity_check
c_func
(paren
id|info
comma
id|tty-&gt;name
comma
l_string|&quot;throttle&quot;
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|I_IXOFF
c_func
(paren
id|tty
)paren
)paren
id|send_xchar
c_func
(paren
id|tty
comma
id|STOP_CHAR
c_func
(paren
id|tty
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tty-&gt;termios-&gt;c_cflag
op_amp
id|CRTSCTS
)paren
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|info-&gt;serial_signals
op_and_assign
op_complement
id|SerialSignal_RTS
suffix:semicolon
id|set_signals
c_func
(paren
id|info
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Signal remote device to stop throttling send data (our receive data)&n; */
DECL|function|unthrottle
r_static
r_void
id|unthrottle
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
id|SLMP_INFO
op_star
id|info
op_assign
(paren
id|SLMP_INFO
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s unthrottle() entry&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sanity_check
c_func
(paren
id|info
comma
id|tty-&gt;name
comma
l_string|&quot;unthrottle&quot;
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|I_IXOFF
c_func
(paren
id|tty
)paren
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;x_char
)paren
id|info-&gt;x_char
op_assign
l_int|0
suffix:semicolon
r_else
id|send_xchar
c_func
(paren
id|tty
comma
id|START_CHAR
c_func
(paren
id|tty
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tty-&gt;termios-&gt;c_cflag
op_amp
id|CRTSCTS
)paren
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|info-&gt;serial_signals
op_or_assign
id|SerialSignal_RTS
suffix:semicolon
id|set_signals
c_func
(paren
id|info
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* set or clear transmit break condition&n; * break_state&t;-1=set break condition, 0=clear&n; */
DECL|function|set_break
r_static
r_void
id|set_break
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_int
id|break_state
)paren
(brace
r_int
r_char
id|RegValue
suffix:semicolon
id|SLMP_INFO
op_star
id|info
op_assign
(paren
id|SLMP_INFO
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s set_break(%d)&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
comma
id|break_state
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sanity_check
c_func
(paren
id|info
comma
id|tty-&gt;name
comma
l_string|&quot;set_break&quot;
)paren
)paren
r_return
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|RegValue
op_assign
id|read_reg
c_func
(paren
id|info
comma
id|CTL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|break_state
op_eq
op_minus
l_int|1
)paren
id|RegValue
op_or_assign
id|BIT3
suffix:semicolon
r_else
id|RegValue
op_and_assign
op_complement
id|BIT3
suffix:semicolon
id|write_reg
c_func
(paren
id|info
comma
id|CTL
comma
id|RegValue
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_HDLC
multiline_comment|/**&n; * called by generic HDLC layer when protocol selected (PPP, frame relay, etc.)&n; * set encoding and frame check sequence (FCS) options&n; *&n; * dev       pointer to network device structure&n; * encoding  serial encoding setting&n; * parity    FCS setting&n; *&n; * returns 0 if success, otherwise error code&n; */
DECL|function|hdlcdev_attach
r_static
r_int
id|hdlcdev_attach
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
r_int
id|encoding
comma
r_int
r_int
id|parity
)paren
(brace
id|SLMP_INFO
op_star
id|info
op_assign
id|dev_to_port
c_func
(paren
id|dev
)paren
suffix:semicolon
r_int
r_char
id|new_encoding
suffix:semicolon
r_int
r_int
id|new_crctype
suffix:semicolon
multiline_comment|/* return error if TTY interface open */
r_if
c_cond
(paren
id|info-&gt;count
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
r_switch
c_cond
(paren
id|encoding
)paren
(brace
r_case
id|ENCODING_NRZ
suffix:colon
id|new_encoding
op_assign
id|HDLC_ENCODING_NRZ
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ENCODING_NRZI
suffix:colon
id|new_encoding
op_assign
id|HDLC_ENCODING_NRZI_SPACE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ENCODING_FM_MARK
suffix:colon
id|new_encoding
op_assign
id|HDLC_ENCODING_BIPHASE_MARK
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ENCODING_FM_SPACE
suffix:colon
id|new_encoding
op_assign
id|HDLC_ENCODING_BIPHASE_SPACE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ENCODING_MANCHESTER
suffix:colon
id|new_encoding
op_assign
id|HDLC_ENCODING_BIPHASE_LEVEL
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|parity
)paren
(brace
r_case
id|PARITY_NONE
suffix:colon
id|new_crctype
op_assign
id|HDLC_CRC_NONE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PARITY_CRC16_PR1_CCITT
suffix:colon
id|new_crctype
op_assign
id|HDLC_CRC_16_CCITT
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PARITY_CRC32_PR1_CCITT
suffix:colon
id|new_crctype
op_assign
id|HDLC_CRC_32_CCITT
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|info-&gt;params.encoding
op_assign
id|new_encoding
suffix:semicolon
id|info-&gt;params.crc_type
op_assign
id|new_crctype
suffix:semicolon
suffix:semicolon
multiline_comment|/* if network interface up, reprogram hardware */
r_if
c_cond
(paren
id|info-&gt;netcount
)paren
id|program_hw
c_func
(paren
id|info
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * called by generic HDLC layer to send frame&n; *&n; * skb  socket buffer containing HDLC frame&n; * dev  pointer to network device structure&n; *&n; * returns 0 if success, otherwise error code&n; */
DECL|function|hdlcdev_xmit
r_static
r_int
id|hdlcdev_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|SLMP_INFO
op_star
id|info
op_assign
id|dev_to_port
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|net_device_stats
op_star
id|stats
op_assign
id|hdlc_stats
c_func
(paren
id|dev
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s:hdlc_xmit(%s)&bslash;n&quot;
comma
id|__FILE__
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/* stop sending until this frame completes */
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* copy data to device buffers */
id|info-&gt;tx_count
op_assign
id|skb-&gt;len
suffix:semicolon
id|tx_load_dma_buffer
c_func
(paren
id|info
comma
id|skb-&gt;data
comma
id|skb-&gt;len
)paren
suffix:semicolon
multiline_comment|/* update network statistics */
id|stats-&gt;tx_packets
op_increment
suffix:semicolon
id|stats-&gt;tx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
multiline_comment|/* done with socket buffer, so free it */
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
multiline_comment|/* save start time for transmit timeout detection */
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
multiline_comment|/* start hardware transmitter if necessary */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;tx_active
)paren
id|tx_start
c_func
(paren
id|info
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * called by network layer when interface enabled&n; * claim resources and initialize hardware&n; *&n; * dev  pointer to network device structure&n; *&n; * returns 0 if success, otherwise error code&n; */
DECL|function|hdlcdev_open
r_static
r_int
id|hdlcdev_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|SLMP_INFO
op_star
id|info
op_assign
id|dev_to_port
c_func
(paren
id|dev
)paren
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s:hdlcdev_open(%s)&bslash;n&quot;
comma
id|__FILE__
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/* generic HDLC layer open processing */
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|hdlc_open
c_func
(paren
id|dev
)paren
)paren
)paren
r_return
id|rc
suffix:semicolon
multiline_comment|/* arbitrate between network and tty opens */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;netlock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;count
op_ne
l_int|0
op_logical_or
id|info-&gt;netcount
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: hdlc_open returning busy&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;netlock
comma
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|info-&gt;netcount
op_assign
l_int|1
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;netlock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* claim resources and init adapter */
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|startup
c_func
(paren
id|info
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;netlock
comma
id|flags
)paren
suffix:semicolon
id|info-&gt;netcount
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;netlock
comma
id|flags
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/* assert DTR and RTS, apply hardware settings */
id|info-&gt;serial_signals
op_or_assign
id|SerialSignal_RTS
op_plus
id|SerialSignal_DTR
suffix:semicolon
id|program_hw
c_func
(paren
id|info
)paren
suffix:semicolon
multiline_comment|/* enable network layer transmit */
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* inform generic HDLC layer of current DCD status */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|get_signals
c_func
(paren
id|info
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|hdlc_set_carrier
c_func
(paren
id|info-&gt;serial_signals
op_amp
id|SerialSignal_DCD
comma
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * called by network layer when interface is disabled&n; * shutdown hardware and release resources&n; *&n; * dev  pointer to network device structure&n; *&n; * returns 0 if success, otherwise error code&n; */
DECL|function|hdlcdev_close
r_static
r_int
id|hdlcdev_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|SLMP_INFO
op_star
id|info
op_assign
id|dev_to_port
c_func
(paren
id|dev
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s:hdlcdev_close(%s)&bslash;n&quot;
comma
id|__FILE__
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* shutdown adapter and release resources */
id|shutdown
c_func
(paren
id|info
)paren
suffix:semicolon
id|hdlc_close
c_func
(paren
id|dev
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;netlock
comma
id|flags
)paren
suffix:semicolon
id|info-&gt;netcount
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;netlock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * called by network layer to process IOCTL call to network device&n; *&n; * dev  pointer to network device structure&n; * ifr  pointer to network interface request structure&n; * cmd  IOCTL command code&n; *&n; * returns 0 if success, otherwise error code&n; */
DECL|function|hdlcdev_ioctl
r_static
r_int
id|hdlcdev_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|ifr
comma
r_int
id|cmd
)paren
(brace
r_const
r_int
id|size
op_assign
r_sizeof
(paren
id|sync_serial_settings
)paren
suffix:semicolon
id|sync_serial_settings
id|new_line
suffix:semicolon
id|sync_serial_settings
id|__user
op_star
id|line
op_assign
id|ifr-&gt;ifr_settings.ifs_ifsu.sync
suffix:semicolon
id|SLMP_INFO
op_star
id|info
op_assign
id|dev_to_port
c_func
(paren
id|dev
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s:hdlcdev_ioctl(%s)&bslash;n&quot;
comma
id|__FILE__
comma
id|dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/* return error if TTY interface open */
r_if
c_cond
(paren
id|info-&gt;count
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_ne
id|SIOCWANDEV
)paren
r_return
id|hdlc_ioctl
c_func
(paren
id|dev
comma
id|ifr
comma
id|cmd
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|ifr-&gt;ifr_settings.type
)paren
(brace
r_case
id|IF_GET_IFACE
suffix:colon
multiline_comment|/* return current sync_serial_settings */
id|ifr-&gt;ifr_settings.type
op_assign
id|IF_IFACE_SYNC_SERIAL
suffix:semicolon
r_if
c_cond
(paren
id|ifr-&gt;ifr_settings.size
OL
id|size
)paren
(brace
id|ifr-&gt;ifr_settings.size
op_assign
id|size
suffix:semicolon
multiline_comment|/* data size wanted */
r_return
op_minus
id|ENOBUFS
suffix:semicolon
)brace
id|flags
op_assign
id|info-&gt;params.flags
op_amp
(paren
id|HDLC_FLAG_RXC_RXCPIN
op_or
id|HDLC_FLAG_RXC_DPLL
op_or
id|HDLC_FLAG_RXC_BRG
op_or
id|HDLC_FLAG_RXC_TXCPIN
op_or
id|HDLC_FLAG_TXC_TXCPIN
op_or
id|HDLC_FLAG_TXC_DPLL
op_or
id|HDLC_FLAG_TXC_BRG
op_or
id|HDLC_FLAG_TXC_RXCPIN
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|flags
)paren
(brace
r_case
(paren
id|HDLC_FLAG_RXC_RXCPIN
op_or
id|HDLC_FLAG_TXC_TXCPIN
)paren
suffix:colon
id|new_line.clock_type
op_assign
id|CLOCK_EXT
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
id|HDLC_FLAG_RXC_BRG
op_or
id|HDLC_FLAG_TXC_BRG
)paren
suffix:colon
id|new_line.clock_type
op_assign
id|CLOCK_INT
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
id|HDLC_FLAG_RXC_RXCPIN
op_or
id|HDLC_FLAG_TXC_BRG
)paren
suffix:colon
id|new_line.clock_type
op_assign
id|CLOCK_TXINT
suffix:semicolon
r_break
suffix:semicolon
r_case
(paren
id|HDLC_FLAG_RXC_RXCPIN
op_or
id|HDLC_FLAG_TXC_RXCPIN
)paren
suffix:colon
id|new_line.clock_type
op_assign
id|CLOCK_TXFROMRX
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|new_line.clock_type
op_assign
id|CLOCK_DEFAULT
suffix:semicolon
)brace
id|new_line.clock_rate
op_assign
id|info-&gt;params.clock_speed
suffix:semicolon
id|new_line.loopback
op_assign
id|info-&gt;params.loopback
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|line
comma
op_amp
id|new_line
comma
id|size
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|IF_IFACE_SYNC_SERIAL
suffix:colon
multiline_comment|/* set sync_serial_settings */
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
(brace
r_return
op_minus
id|EPERM
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|new_line
comma
id|line
comma
id|size
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_switch
c_cond
(paren
id|new_line.clock_type
)paren
(brace
r_case
id|CLOCK_EXT
suffix:colon
id|flags
op_assign
id|HDLC_FLAG_RXC_RXCPIN
op_or
id|HDLC_FLAG_TXC_TXCPIN
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CLOCK_TXFROMRX
suffix:colon
id|flags
op_assign
id|HDLC_FLAG_RXC_RXCPIN
op_or
id|HDLC_FLAG_TXC_RXCPIN
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CLOCK_INT
suffix:colon
id|flags
op_assign
id|HDLC_FLAG_RXC_BRG
op_or
id|HDLC_FLAG_TXC_BRG
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CLOCK_TXINT
suffix:colon
id|flags
op_assign
id|HDLC_FLAG_RXC_RXCPIN
op_or
id|HDLC_FLAG_TXC_BRG
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CLOCK_DEFAULT
suffix:colon
id|flags
op_assign
id|info-&gt;params.flags
op_amp
(paren
id|HDLC_FLAG_RXC_RXCPIN
op_or
id|HDLC_FLAG_RXC_DPLL
op_or
id|HDLC_FLAG_RXC_BRG
op_or
id|HDLC_FLAG_RXC_TXCPIN
op_or
id|HDLC_FLAG_TXC_TXCPIN
op_or
id|HDLC_FLAG_TXC_DPLL
op_or
id|HDLC_FLAG_TXC_BRG
op_or
id|HDLC_FLAG_TXC_RXCPIN
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|new_line.loopback
op_ne
l_int|0
op_logical_and
id|new_line.loopback
op_ne
l_int|1
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|info-&gt;params.flags
op_and_assign
op_complement
(paren
id|HDLC_FLAG_RXC_RXCPIN
op_or
id|HDLC_FLAG_RXC_DPLL
op_or
id|HDLC_FLAG_RXC_BRG
op_or
id|HDLC_FLAG_RXC_TXCPIN
op_or
id|HDLC_FLAG_TXC_TXCPIN
op_or
id|HDLC_FLAG_TXC_DPLL
op_or
id|HDLC_FLAG_TXC_BRG
op_or
id|HDLC_FLAG_TXC_RXCPIN
)paren
suffix:semicolon
id|info-&gt;params.flags
op_or_assign
id|flags
suffix:semicolon
id|info-&gt;params.loopback
op_assign
id|new_line.loopback
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
(paren
id|HDLC_FLAG_RXC_BRG
op_or
id|HDLC_FLAG_TXC_BRG
)paren
)paren
id|info-&gt;params.clock_speed
op_assign
id|new_line.clock_rate
suffix:semicolon
r_else
id|info-&gt;params.clock_speed
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* if network interface up, reprogram hardware */
r_if
c_cond
(paren
id|info-&gt;netcount
)paren
id|program_hw
c_func
(paren
id|info
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_default
suffix:colon
r_return
id|hdlc_ioctl
c_func
(paren
id|dev
comma
id|ifr
comma
id|cmd
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; * called by network layer when transmit timeout is detected&n; *&n; * dev  pointer to network device structure&n; */
DECL|function|hdlcdev_tx_timeout
r_static
r_void
id|hdlcdev_tx_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|SLMP_INFO
op_star
id|info
op_assign
id|dev_to_port
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|net_device_stats
op_star
id|stats
op_assign
id|hdlc_stats
c_func
(paren
id|dev
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;hdlcdev_tx_timeout(%s)&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|stats-&gt;tx_errors
op_increment
suffix:semicolon
id|stats-&gt;tx_aborted_errors
op_increment
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|tx_stop
c_func
(paren
id|info
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * called by device driver when transmit completes&n; * reenable network layer transmit if stopped&n; *&n; * info  pointer to device instance information&n; */
DECL|function|hdlcdev_tx_done
r_static
r_void
id|hdlcdev_tx_done
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
(brace
r_if
c_cond
(paren
id|netif_queue_stopped
c_func
(paren
id|info-&gt;netdev
)paren
)paren
id|netif_wake_queue
c_func
(paren
id|info-&gt;netdev
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * called by device driver when frame received&n; * pass frame to network layer&n; *&n; * info  pointer to device instance information&n; * buf   pointer to buffer contianing frame data&n; * size  count of data bytes in buf&n; */
DECL|function|hdlcdev_rx
r_static
r_void
id|hdlcdev_rx
c_func
(paren
id|SLMP_INFO
op_star
id|info
comma
r_char
op_star
id|buf
comma
r_int
id|size
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
op_assign
id|dev_alloc_skb
c_func
(paren
id|size
)paren
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
id|info-&gt;netdev
suffix:semicolon
r_struct
id|net_device_stats
op_star
id|stats
op_assign
id|hdlc_stats
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;hdlcdev_rx(%s)&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;%s: can&squot;t alloc skb, dropping packet&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|stats-&gt;rx_dropped
op_increment
suffix:semicolon
r_return
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|size
)paren
comma
id|buf
comma
id|size
)paren
suffix:semicolon
id|skb-&gt;dev
op_assign
id|info-&gt;netdev
suffix:semicolon
id|skb-&gt;mac.raw
op_assign
id|skb-&gt;data
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|hdlc_type_trans
c_func
(paren
id|skb
comma
id|skb-&gt;dev
)paren
suffix:semicolon
id|stats-&gt;rx_packets
op_increment
suffix:semicolon
id|stats-&gt;rx_bytes
op_add_assign
id|size
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
id|info-&gt;netdev-&gt;last_rx
op_assign
id|jiffies
suffix:semicolon
)brace
multiline_comment|/**&n; * called by device driver when adding device instance&n; * do generic HDLC initialization&n; *&n; * info  pointer to device instance information&n; *&n; * returns 0 if success, otherwise error code&n; */
DECL|function|hdlcdev_init
r_static
r_int
id|hdlcdev_init
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
(brace
r_int
id|rc
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
id|hdlc_device
op_star
id|hdlc
suffix:semicolon
multiline_comment|/* allocate and initialize network and HDLC layer objects */
r_if
c_cond
(paren
op_logical_neg
(paren
id|dev
op_assign
id|alloc_hdlcdev
c_func
(paren
id|info
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s:hdlc device allocation failure&bslash;n&quot;
comma
id|__FILE__
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/* for network layer reporting purposes only */
id|dev-&gt;mem_start
op_assign
id|info-&gt;phys_sca_base
suffix:semicolon
id|dev-&gt;mem_end
op_assign
id|info-&gt;phys_sca_base
op_plus
id|SCA_BASE_SIZE
op_minus
l_int|1
suffix:semicolon
id|dev-&gt;irq
op_assign
id|info-&gt;irq_level
suffix:semicolon
multiline_comment|/* network layer callbacks and settings */
id|dev-&gt;do_ioctl
op_assign
id|hdlcdev_ioctl
suffix:semicolon
id|dev-&gt;open
op_assign
id|hdlcdev_open
suffix:semicolon
id|dev-&gt;stop
op_assign
id|hdlcdev_close
suffix:semicolon
id|dev-&gt;tx_timeout
op_assign
id|hdlcdev_tx_timeout
suffix:semicolon
id|dev-&gt;watchdog_timeo
op_assign
l_int|10
op_star
id|HZ
suffix:semicolon
id|dev-&gt;tx_queue_len
op_assign
l_int|50
suffix:semicolon
multiline_comment|/* generic HDLC layer callbacks and settings */
id|hdlc
op_assign
id|dev_to_hdlc
c_func
(paren
id|dev
)paren
suffix:semicolon
id|hdlc-&gt;attach
op_assign
id|hdlcdev_attach
suffix:semicolon
id|hdlc-&gt;xmit
op_assign
id|hdlcdev_xmit
suffix:semicolon
multiline_comment|/* register objects with HDLC layer */
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|register_hdlc_device
c_func
(paren
id|dev
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s:unable to register hdlc device&bslash;n&quot;
comma
id|__FILE__
)paren
suffix:semicolon
id|free_netdev
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|info-&gt;netdev
op_assign
id|dev
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * called by device driver when removing device instance&n; * do generic HDLC cleanup&n; *&n; * info  pointer to device instance information&n; */
DECL|function|hdlcdev_exit
r_static
r_void
id|hdlcdev_exit
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
(brace
id|unregister_hdlc_device
c_func
(paren
id|info-&gt;netdev
)paren
suffix:semicolon
id|free_netdev
c_func
(paren
id|info-&gt;netdev
)paren
suffix:semicolon
id|info-&gt;netdev
op_assign
l_int|NULL
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_HDLC */
multiline_comment|/* Return next bottom half action to perform.&n; * Return Value:&t;BH action code or 0 if nothing to do.&n; */
DECL|function|bh_action
r_int
id|bh_action
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;pending_bh
op_amp
id|BH_RECEIVE
)paren
(brace
id|info-&gt;pending_bh
op_and_assign
op_complement
id|BH_RECEIVE
suffix:semicolon
id|rc
op_assign
id|BH_RECEIVE
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|info-&gt;pending_bh
op_amp
id|BH_TRANSMIT
)paren
(brace
id|info-&gt;pending_bh
op_and_assign
op_complement
id|BH_TRANSMIT
suffix:semicolon
id|rc
op_assign
id|BH_TRANSMIT
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|info-&gt;pending_bh
op_amp
id|BH_STATUS
)paren
(brace
id|info-&gt;pending_bh
op_and_assign
op_complement
id|BH_STATUS
suffix:semicolon
id|rc
op_assign
id|BH_STATUS
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|rc
)paren
(brace
multiline_comment|/* Mark BH routine as complete */
id|info-&gt;bh_running
op_assign
l_int|0
suffix:semicolon
id|info-&gt;bh_requested
op_assign
l_int|0
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/* Perform bottom half processing of work items queued by ISR.&n; */
DECL|function|bh_handler
r_void
id|bh_handler
c_func
(paren
r_void
op_star
id|Context
)paren
(brace
id|SLMP_INFO
op_star
id|info
op_assign
(paren
id|SLMP_INFO
op_star
)paren
id|Context
suffix:semicolon
r_int
id|action
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_BH
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s bh_handler() entry&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
)paren
suffix:semicolon
id|info-&gt;bh_running
op_assign
l_int|1
suffix:semicolon
r_while
c_loop
(paren
(paren
id|action
op_assign
id|bh_action
c_func
(paren
id|info
)paren
)paren
op_ne
l_int|0
)paren
(brace
multiline_comment|/* Process work item */
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_BH
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s bh_handler() work item action=%d&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
comma
id|action
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|action
)paren
(brace
r_case
id|BH_RECEIVE
suffix:colon
id|bh_receive
c_func
(paren
id|info
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BH_TRANSMIT
suffix:colon
id|bh_transmit
c_func
(paren
id|info
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BH_STATUS
suffix:colon
id|bh_status
c_func
(paren
id|info
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* unknown work item ID */
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s Unknown work item ID=%08X!&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
comma
id|action
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_BH
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s bh_handler() exit&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
)paren
suffix:semicolon
)brace
DECL|function|bh_receive
r_void
id|bh_receive
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
(brace
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_BH
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s bh_receive()&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
)paren
suffix:semicolon
r_while
c_loop
(paren
id|rx_get_frame
c_func
(paren
id|info
)paren
)paren
(brace
suffix:semicolon
)brace
)brace
DECL|function|bh_transmit
r_void
id|bh_transmit
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
(brace
r_struct
id|tty_struct
op_star
id|tty
op_assign
id|info-&gt;tty
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_BH
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s bh_transmit() entry&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tty
)paren
(brace
id|tty_wakeup
c_func
(paren
id|tty
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|tty-&gt;write_wait
)paren
suffix:semicolon
)brace
)brace
DECL|function|bh_status
r_void
id|bh_status
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
(brace
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_BH
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s bh_status() entry&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
)paren
suffix:semicolon
id|info-&gt;ri_chkcount
op_assign
l_int|0
suffix:semicolon
id|info-&gt;dsr_chkcount
op_assign
l_int|0
suffix:semicolon
id|info-&gt;dcd_chkcount
op_assign
l_int|0
suffix:semicolon
id|info-&gt;cts_chkcount
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|isr_timer
r_void
id|isr_timer
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
(brace
r_int
r_char
id|timer
op_assign
(paren
id|info-&gt;port_num
op_amp
l_int|1
)paren
ques
c_cond
id|TIMER2
suffix:colon
id|TIMER0
suffix:semicolon
multiline_comment|/* IER2&lt;7..4&gt; = timer&lt;3..0&gt; interrupt enables (0=disabled) */
id|write_reg
c_func
(paren
id|info
comma
id|IER2
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* TMCS, Timer Control/Status Register&n;&t; *&n;&t; * 07      CMF, Compare match flag (read only) 1=match&n;&t; * 06      ECMI, CMF Interrupt Enable: 0=disabled&n;&t; * 05      Reserved, must be 0&n;&t; * 04      TME, Timer Enable&n;&t; * 03..00  Reserved, must be 0&n;&t; *&n;&t; * 0000 0000&n;&t; */
id|write_reg
c_func
(paren
id|info
comma
(paren
r_int
r_char
)paren
(paren
id|timer
op_plus
id|TMCS
)paren
comma
l_int|0
)paren
suffix:semicolon
id|info-&gt;irq_occurred
op_assign
id|TRUE
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_ISR
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s isr_timer()&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
)paren
suffix:semicolon
)brace
DECL|function|isr_rxint
r_void
id|isr_rxint
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
(brace
r_struct
id|tty_struct
op_star
id|tty
op_assign
id|info-&gt;tty
suffix:semicolon
r_struct
id|mgsl_icount
op_star
id|icount
op_assign
op_amp
id|info-&gt;icount
suffix:semicolon
r_int
r_char
id|status
op_assign
id|read_reg
c_func
(paren
id|info
comma
id|SR1
)paren
op_amp
id|info-&gt;ie1_value
op_amp
(paren
id|FLGD
op_plus
id|IDLD
op_plus
id|CDCD
op_plus
id|BRKD
)paren
suffix:semicolon
r_int
r_char
id|status2
op_assign
id|read_reg
c_func
(paren
id|info
comma
id|SR2
)paren
op_amp
id|info-&gt;ie2_value
op_amp
id|OVRN
suffix:semicolon
multiline_comment|/* clear status bits */
r_if
c_cond
(paren
id|status
)paren
id|write_reg
c_func
(paren
id|info
comma
id|SR1
comma
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status2
)paren
id|write_reg
c_func
(paren
id|info
comma
id|SR2
comma
id|status2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_ISR
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s isr_rxint status=%02X %02x&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
comma
id|status
comma
id|status2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;params.mode
op_eq
id|MGSL_MODE_ASYNC
)paren
(brace
r_if
c_cond
(paren
id|status
op_amp
id|BRKD
)paren
(brace
id|icount-&gt;brk
op_increment
suffix:semicolon
multiline_comment|/* process break detection if tty control&n;&t;&t;&t; * is not set to ignore it&n;&t;&t;&t; */
r_if
c_cond
(paren
id|tty
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_amp
id|info-&gt;ignore_status_mask1
)paren
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;read_status_mask1
op_amp
id|BRKD
)paren
(brace
op_star
id|tty-&gt;flip.flag_buf_ptr
op_assign
id|TTY_BREAK
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;flags
op_amp
id|ASYNC_SAK
)paren
id|do_SAK
c_func
(paren
id|tty
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|status
op_amp
(paren
id|FLGD
op_or
id|IDLD
)paren
)paren
(brace
r_if
c_cond
(paren
id|status
op_amp
id|FLGD
)paren
id|info-&gt;icount.exithunt
op_increment
suffix:semicolon
r_else
r_if
c_cond
(paren
id|status
op_amp
id|IDLD
)paren
id|info-&gt;icount.rxidle
op_increment
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|info-&gt;event_wait_q
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|status
op_amp
id|CDCD
)paren
(brace
multiline_comment|/* simulate a common modem status change interrupt&n;&t;&t; * for our handler&n;&t;&t; */
id|get_signals
c_func
(paren
id|info
)paren
suffix:semicolon
id|isr_io_pin
c_func
(paren
id|info
comma
id|MISCSTATUS_DCD_LATCHED
op_or
(paren
id|info-&gt;serial_signals
op_amp
id|SerialSignal_DCD
)paren
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * handle async rx data interrupts&n; */
DECL|function|isr_rxrdy
r_void
id|isr_rxrdy
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
(brace
id|u16
id|status
suffix:semicolon
r_int
r_char
id|DataByte
suffix:semicolon
r_struct
id|tty_struct
op_star
id|tty
op_assign
id|info-&gt;tty
suffix:semicolon
r_struct
id|mgsl_icount
op_star
id|icount
op_assign
op_amp
id|info-&gt;icount
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_ISR
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s isr_rxrdy&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|status
op_assign
id|read_reg
c_func
(paren
id|info
comma
id|CST0
)paren
)paren
op_amp
id|BIT0
)paren
(brace
id|DataByte
op_assign
id|read_reg
c_func
(paren
id|info
comma
id|TRB
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tty
)paren
(brace
r_if
c_cond
(paren
id|tty-&gt;flip.count
op_ge
id|TTY_FLIPBUF_SIZE
)paren
r_continue
suffix:semicolon
op_star
id|tty-&gt;flip.char_buf_ptr
op_assign
id|DataByte
suffix:semicolon
op_star
id|tty-&gt;flip.flag_buf_ptr
op_assign
l_int|0
suffix:semicolon
)brace
id|icount-&gt;rx
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
(paren
id|PE
op_plus
id|FRME
op_plus
id|OVRN
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s rxerr=%04X&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
comma
id|status
)paren
suffix:semicolon
multiline_comment|/* update error statistics */
r_if
c_cond
(paren
id|status
op_amp
id|PE
)paren
id|icount-&gt;parity
op_increment
suffix:semicolon
r_else
r_if
c_cond
(paren
id|status
op_amp
id|FRME
)paren
id|icount-&gt;frame
op_increment
suffix:semicolon
r_else
r_if
c_cond
(paren
id|status
op_amp
id|OVRN
)paren
id|icount-&gt;overrun
op_increment
suffix:semicolon
multiline_comment|/* discard char if tty control flags say so */
r_if
c_cond
(paren
id|status
op_amp
id|info-&gt;ignore_status_mask2
)paren
r_continue
suffix:semicolon
id|status
op_and_assign
id|info-&gt;read_status_mask2
suffix:semicolon
r_if
c_cond
(paren
id|tty
)paren
(brace
r_if
c_cond
(paren
id|status
op_amp
id|PE
)paren
op_star
id|tty-&gt;flip.flag_buf_ptr
op_assign
id|TTY_PARITY
suffix:semicolon
r_else
r_if
c_cond
(paren
id|status
op_amp
id|FRME
)paren
op_star
id|tty-&gt;flip.flag_buf_ptr
op_assign
id|TTY_FRAME
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|OVRN
)paren
(brace
multiline_comment|/* Overrun is special, since it&squot;s&n;&t;&t;&t;&t;&t; * reported immediately, and doesn&squot;t&n;&t;&t;&t;&t;&t; * affect the current character&n;&t;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|tty-&gt;flip.count
OL
id|TTY_FLIPBUF_SIZE
)paren
(brace
id|tty-&gt;flip.count
op_increment
suffix:semicolon
id|tty-&gt;flip.flag_buf_ptr
op_increment
suffix:semicolon
id|tty-&gt;flip.char_buf_ptr
op_increment
suffix:semicolon
op_star
id|tty-&gt;flip.flag_buf_ptr
op_assign
id|TTY_OVERRUN
suffix:semicolon
)brace
)brace
)brace
)brace
multiline_comment|/* end of if (error) */
r_if
c_cond
(paren
id|tty
)paren
(brace
id|tty-&gt;flip.flag_buf_ptr
op_increment
suffix:semicolon
id|tty-&gt;flip.char_buf_ptr
op_increment
suffix:semicolon
id|tty-&gt;flip.count
op_increment
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_ISR
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s isr_rxrdy() flip count=%d&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
comma
id|tty
ques
c_cond
id|tty-&gt;flip.count
suffix:colon
l_int|0
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s rx=%d brk=%d parity=%d frame=%d overrun=%d&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
comma
id|icount-&gt;rx
comma
id|icount-&gt;brk
comma
id|icount-&gt;parity
comma
id|icount-&gt;frame
comma
id|icount-&gt;overrun
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tty
op_logical_and
id|tty-&gt;flip.count
)paren
id|tty_flip_buffer_push
c_func
(paren
id|tty
)paren
suffix:semicolon
)brace
DECL|function|isr_txeom
r_void
id|isr_txeom
c_func
(paren
id|SLMP_INFO
op_star
id|info
comma
r_int
r_char
id|status
)paren
(brace
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_ISR
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s isr_txeom status=%02x&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
comma
id|status
)paren
suffix:semicolon
id|write_reg
c_func
(paren
id|info
comma
id|TXDMA
op_plus
id|DIR
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* disable Tx DMA IRQs */
id|write_reg
c_func
(paren
id|info
comma
id|TXDMA
op_plus
id|DSR
comma
l_int|0xc0
)paren
suffix:semicolon
multiline_comment|/* clear IRQs and disable DMA */
id|write_reg
c_func
(paren
id|info
comma
id|TXDMA
op_plus
id|DCMD
comma
id|SWABORT
)paren
suffix:semicolon
multiline_comment|/* reset/init DMA channel */
r_if
c_cond
(paren
id|status
op_amp
id|UDRN
)paren
(brace
id|write_reg
c_func
(paren
id|info
comma
id|CMD
comma
id|TXRESET
)paren
suffix:semicolon
id|write_reg
c_func
(paren
id|info
comma
id|CMD
comma
id|TXENABLE
)paren
suffix:semicolon
)brace
r_else
id|write_reg
c_func
(paren
id|info
comma
id|CMD
comma
id|TXBUFCLR
)paren
suffix:semicolon
multiline_comment|/* disable and clear tx interrupts */
id|info-&gt;ie0_value
op_and_assign
op_complement
id|TXRDYE
suffix:semicolon
id|info-&gt;ie1_value
op_and_assign
op_complement
(paren
id|IDLE
op_plus
id|UDRN
)paren
suffix:semicolon
id|write_reg16
c_func
(paren
id|info
comma
id|IE0
comma
(paren
r_int
r_int
)paren
(paren
(paren
id|info-&gt;ie1_value
op_lshift
l_int|8
)paren
op_plus
id|info-&gt;ie0_value
)paren
)paren
suffix:semicolon
id|write_reg
c_func
(paren
id|info
comma
id|SR1
comma
(paren
r_int
r_char
)paren
(paren
id|UDRN
op_plus
id|IDLE
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;tx_active
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;params.mode
op_ne
id|MGSL_MODE_ASYNC
)paren
(brace
r_if
c_cond
(paren
id|status
op_amp
id|UDRN
)paren
id|info-&gt;icount.txunder
op_increment
suffix:semicolon
r_else
r_if
c_cond
(paren
id|status
op_amp
id|IDLE
)paren
id|info-&gt;icount.txok
op_increment
suffix:semicolon
)brace
id|info-&gt;tx_active
op_assign
l_int|0
suffix:semicolon
id|info-&gt;tx_count
op_assign
id|info-&gt;tx_put
op_assign
id|info-&gt;tx_get
op_assign
l_int|0
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|info-&gt;tx_timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;params.mode
op_ne
id|MGSL_MODE_ASYNC
op_logical_and
id|info-&gt;drop_rts_on_tx_done
)paren
(brace
id|info-&gt;serial_signals
op_and_assign
op_complement
id|SerialSignal_RTS
suffix:semicolon
id|info-&gt;drop_rts_on_tx_done
op_assign
l_int|0
suffix:semicolon
id|set_signals
c_func
(paren
id|info
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_HDLC
r_if
c_cond
(paren
id|info-&gt;netcount
)paren
id|hdlcdev_tx_done
c_func
(paren
id|info
)paren
suffix:semicolon
r_else
macro_line|#endif
(brace
r_if
c_cond
(paren
id|info-&gt;tty
op_logical_and
(paren
id|info-&gt;tty-&gt;stopped
op_logical_or
id|info-&gt;tty-&gt;hw_stopped
)paren
)paren
(brace
id|tx_stop
c_func
(paren
id|info
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|info-&gt;pending_bh
op_or_assign
id|BH_TRANSMIT
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*&n; * handle tx status interrupts&n; */
DECL|function|isr_txint
r_void
id|isr_txint
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
(brace
r_int
r_char
id|status
op_assign
id|read_reg
c_func
(paren
id|info
comma
id|SR1
)paren
op_amp
id|info-&gt;ie1_value
op_amp
(paren
id|UDRN
op_plus
id|IDLE
op_plus
id|CCTS
)paren
suffix:semicolon
multiline_comment|/* clear status bits */
id|write_reg
c_func
(paren
id|info
comma
id|SR1
comma
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_ISR
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s isr_txint status=%02x&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
comma
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
(paren
id|UDRN
op_plus
id|IDLE
)paren
)paren
id|isr_txeom
c_func
(paren
id|info
comma
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|CCTS
)paren
(brace
multiline_comment|/* simulate a common modem status change interrupt&n;&t;&t; * for our handler&n;&t;&t; */
id|get_signals
c_func
(paren
id|info
)paren
suffix:semicolon
id|isr_io_pin
c_func
(paren
id|info
comma
id|MISCSTATUS_CTS_LATCHED
op_or
(paren
id|info-&gt;serial_signals
op_amp
id|SerialSignal_CTS
)paren
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * handle async tx data interrupts&n; */
DECL|function|isr_txrdy
r_void
id|isr_txrdy
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
(brace
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_ISR
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s isr_txrdy() tx_count=%d&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
comma
id|info-&gt;tx_count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;params.mode
op_ne
id|MGSL_MODE_ASYNC
)paren
(brace
multiline_comment|/* disable TXRDY IRQ, enable IDLE IRQ */
id|info-&gt;ie0_value
op_and_assign
op_complement
id|TXRDYE
suffix:semicolon
id|info-&gt;ie1_value
op_or_assign
id|IDLE
suffix:semicolon
id|write_reg16
c_func
(paren
id|info
comma
id|IE0
comma
(paren
r_int
r_int
)paren
(paren
(paren
id|info-&gt;ie1_value
op_lshift
l_int|8
)paren
op_plus
id|info-&gt;ie0_value
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|info-&gt;tty
op_logical_and
(paren
id|info-&gt;tty-&gt;stopped
op_logical_or
id|info-&gt;tty-&gt;hw_stopped
)paren
)paren
(brace
id|tx_stop
c_func
(paren
id|info
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|info-&gt;tx_count
)paren
id|tx_load_fifo
c_func
(paren
id|info
)paren
suffix:semicolon
r_else
(brace
id|info-&gt;tx_active
op_assign
l_int|0
suffix:semicolon
id|info-&gt;ie0_value
op_and_assign
op_complement
id|TXRDYE
suffix:semicolon
id|write_reg
c_func
(paren
id|info
comma
id|IE0
comma
id|info-&gt;ie0_value
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|info-&gt;tx_count
OL
id|WAKEUP_CHARS
)paren
id|info-&gt;pending_bh
op_or_assign
id|BH_TRANSMIT
suffix:semicolon
)brace
DECL|function|isr_rxdmaok
r_void
id|isr_rxdmaok
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
(brace
multiline_comment|/* BIT7 = EOT (end of transfer)&n;&t; * BIT6 = EOM (end of message/frame)&n;&t; */
r_int
r_char
id|status
op_assign
id|read_reg
c_func
(paren
id|info
comma
id|RXDMA
op_plus
id|DSR
)paren
op_amp
l_int|0xc0
suffix:semicolon
multiline_comment|/* clear IRQ (BIT0 must be 1 to prevent clearing DE bit) */
id|write_reg
c_func
(paren
id|info
comma
id|RXDMA
op_plus
id|DSR
comma
(paren
r_int
r_char
)paren
(paren
id|status
op_or
l_int|1
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_ISR
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s isr_rxdmaok(), status=%02x&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
comma
id|status
)paren
suffix:semicolon
id|info-&gt;pending_bh
op_or_assign
id|BH_RECEIVE
suffix:semicolon
)brace
DECL|function|isr_rxdmaerror
r_void
id|isr_rxdmaerror
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
(brace
multiline_comment|/* BIT5 = BOF (buffer overflow)&n;&t; * BIT4 = COF (counter overflow)&n;&t; */
r_int
r_char
id|status
op_assign
id|read_reg
c_func
(paren
id|info
comma
id|RXDMA
op_plus
id|DSR
)paren
op_amp
l_int|0x30
suffix:semicolon
multiline_comment|/* clear IRQ (BIT0 must be 1 to prevent clearing DE bit) */
id|write_reg
c_func
(paren
id|info
comma
id|RXDMA
op_plus
id|DSR
comma
(paren
r_int
r_char
)paren
(paren
id|status
op_or
l_int|1
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_ISR
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s isr_rxdmaerror(), status=%02x&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
comma
id|status
)paren
suffix:semicolon
id|info-&gt;rx_overflow
op_assign
id|TRUE
suffix:semicolon
id|info-&gt;pending_bh
op_or_assign
id|BH_RECEIVE
suffix:semicolon
)brace
DECL|function|isr_txdmaok
r_void
id|isr_txdmaok
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
(brace
r_int
r_char
id|status_reg1
op_assign
id|read_reg
c_func
(paren
id|info
comma
id|SR1
)paren
suffix:semicolon
id|write_reg
c_func
(paren
id|info
comma
id|TXDMA
op_plus
id|DIR
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* disable Tx DMA IRQs */
id|write_reg
c_func
(paren
id|info
comma
id|TXDMA
op_plus
id|DSR
comma
l_int|0xc0
)paren
suffix:semicolon
multiline_comment|/* clear IRQs and disable DMA */
id|write_reg
c_func
(paren
id|info
comma
id|TXDMA
op_plus
id|DCMD
comma
id|SWABORT
)paren
suffix:semicolon
multiline_comment|/* reset/init DMA channel */
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_ISR
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s isr_txdmaok(), status=%02x&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
comma
id|status_reg1
)paren
suffix:semicolon
multiline_comment|/* program TXRDY as FIFO empty flag, enable TXRDY IRQ */
id|write_reg16
c_func
(paren
id|info
comma
id|TRC0
comma
l_int|0
)paren
suffix:semicolon
id|info-&gt;ie0_value
op_or_assign
id|TXRDYE
suffix:semicolon
id|write_reg
c_func
(paren
id|info
comma
id|IE0
comma
id|info-&gt;ie0_value
)paren
suffix:semicolon
)brace
DECL|function|isr_txdmaerror
r_void
id|isr_txdmaerror
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
(brace
multiline_comment|/* BIT5 = BOF (buffer overflow)&n;&t; * BIT4 = COF (counter overflow)&n;&t; */
r_int
r_char
id|status
op_assign
id|read_reg
c_func
(paren
id|info
comma
id|TXDMA
op_plus
id|DSR
)paren
op_amp
l_int|0x30
suffix:semicolon
multiline_comment|/* clear IRQ (BIT0 must be 1 to prevent clearing DE bit) */
id|write_reg
c_func
(paren
id|info
comma
id|TXDMA
op_plus
id|DSR
comma
(paren
r_int
r_char
)paren
(paren
id|status
op_or
l_int|1
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_ISR
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s isr_txdmaerror(), status=%02x&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
comma
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/* handle input serial signal changes&n; */
DECL|function|isr_io_pin
r_void
id|isr_io_pin
c_func
(paren
id|SLMP_INFO
op_star
id|info
comma
id|u16
id|status
)paren
(brace
r_struct
id|mgsl_icount
op_star
id|icount
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_ISR
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):isr_io_pin status=%04X&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
(paren
id|MISCSTATUS_CTS_LATCHED
op_or
id|MISCSTATUS_DCD_LATCHED
op_or
id|MISCSTATUS_DSR_LATCHED
op_or
id|MISCSTATUS_RI_LATCHED
)paren
)paren
(brace
id|icount
op_assign
op_amp
id|info-&gt;icount
suffix:semicolon
multiline_comment|/* update input line counters */
r_if
c_cond
(paren
id|status
op_amp
id|MISCSTATUS_RI_LATCHED
)paren
(brace
id|icount-&gt;rng
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|SerialSignal_RI
)paren
id|info-&gt;input_signal_events.ri_up
op_increment
suffix:semicolon
r_else
id|info-&gt;input_signal_events.ri_down
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|MISCSTATUS_DSR_LATCHED
)paren
(brace
id|icount-&gt;dsr
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|SerialSignal_DSR
)paren
id|info-&gt;input_signal_events.dsr_up
op_increment
suffix:semicolon
r_else
id|info-&gt;input_signal_events.dsr_down
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|MISCSTATUS_DCD_LATCHED
)paren
(brace
r_if
c_cond
(paren
(paren
id|info-&gt;dcd_chkcount
)paren
op_increment
op_ge
id|IO_PIN_SHUTDOWN_LIMIT
)paren
(brace
id|info-&gt;ie1_value
op_and_assign
op_complement
id|CDCD
suffix:semicolon
id|write_reg
c_func
(paren
id|info
comma
id|IE1
comma
id|info-&gt;ie1_value
)paren
suffix:semicolon
)brace
id|icount-&gt;dcd
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|SerialSignal_DCD
)paren
(brace
id|info-&gt;input_signal_events.dcd_up
op_increment
suffix:semicolon
)brace
r_else
id|info-&gt;input_signal_events.dcd_down
op_increment
suffix:semicolon
macro_line|#ifdef CONFIG_HDLC
r_if
c_cond
(paren
id|info-&gt;netcount
)paren
id|hdlc_set_carrier
c_func
(paren
id|status
op_amp
id|SerialSignal_DCD
comma
id|info-&gt;netdev
)paren
suffix:semicolon
macro_line|#endif
)brace
r_if
c_cond
(paren
id|status
op_amp
id|MISCSTATUS_CTS_LATCHED
)paren
(brace
r_if
c_cond
(paren
(paren
id|info-&gt;cts_chkcount
)paren
op_increment
op_ge
id|IO_PIN_SHUTDOWN_LIMIT
)paren
(brace
id|info-&gt;ie1_value
op_and_assign
op_complement
id|CCTS
suffix:semicolon
id|write_reg
c_func
(paren
id|info
comma
id|IE1
comma
id|info-&gt;ie1_value
)paren
suffix:semicolon
)brace
id|icount-&gt;cts
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|SerialSignal_CTS
)paren
id|info-&gt;input_signal_events.cts_up
op_increment
suffix:semicolon
r_else
id|info-&gt;input_signal_events.cts_down
op_increment
suffix:semicolon
)brace
id|wake_up_interruptible
c_func
(paren
op_amp
id|info-&gt;status_event_wait_q
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|info-&gt;event_wait_q
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|info-&gt;flags
op_amp
id|ASYNC_CHECK_CD
)paren
op_logical_and
(paren
id|status
op_amp
id|MISCSTATUS_DCD_LATCHED
)paren
)paren
(brace
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_ISR
)paren
id|printk
c_func
(paren
l_string|&quot;%s CD now %s...&quot;
comma
id|info-&gt;device_name
comma
(paren
id|status
op_amp
id|SerialSignal_DCD
)paren
ques
c_cond
l_string|&quot;on&quot;
suffix:colon
l_string|&quot;off&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|SerialSignal_DCD
)paren
id|wake_up_interruptible
c_func
(paren
op_amp
id|info-&gt;open_wait
)paren
suffix:semicolon
r_else
(brace
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_ISR
)paren
id|printk
c_func
(paren
l_string|&quot;doing serial hangup...&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;tty
)paren
id|tty_hangup
c_func
(paren
id|info-&gt;tty
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
(paren
id|info-&gt;flags
op_amp
id|ASYNC_CTS_FLOW
)paren
op_logical_and
(paren
id|status
op_amp
id|MISCSTATUS_CTS_LATCHED
)paren
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;tty
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;tty-&gt;hw_stopped
)paren
(brace
r_if
c_cond
(paren
id|status
op_amp
id|SerialSignal_CTS
)paren
(brace
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_ISR
)paren
id|printk
c_func
(paren
l_string|&quot;CTS tx start...&quot;
)paren
suffix:semicolon
id|info-&gt;tty-&gt;hw_stopped
op_assign
l_int|0
suffix:semicolon
id|tx_start
c_func
(paren
id|info
)paren
suffix:semicolon
id|info-&gt;pending_bh
op_or_assign
id|BH_TRANSMIT
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_amp
id|SerialSignal_CTS
)paren
)paren
(brace
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_ISR
)paren
id|printk
c_func
(paren
l_string|&quot;CTS tx stop...&quot;
)paren
suffix:semicolon
id|info-&gt;tty-&gt;hw_stopped
op_assign
l_int|1
suffix:semicolon
id|tx_stop
c_func
(paren
id|info
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
)brace
id|info-&gt;pending_bh
op_or_assign
id|BH_STATUS
suffix:semicolon
)brace
multiline_comment|/* Interrupt service routine entry point.&n; *&n; * Arguments:&n; * &t;irq&t;&t;interrupt number that caused interrupt&n; * &t;dev_id&t;&t;device ID supplied during interrupt registration&n; * &t;regs&t;&t;interrupted processor context&n; */
DECL|function|synclinkmp_interrupt
r_static
id|irqreturn_t
id|synclinkmp_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|SLMP_INFO
op_star
id|info
suffix:semicolon
r_int
r_char
id|status
comma
id|status0
comma
id|status1
op_assign
l_int|0
suffix:semicolon
r_int
r_char
id|dmastatus
comma
id|dmastatus0
comma
id|dmastatus1
op_assign
l_int|0
suffix:semicolon
r_int
r_char
id|timerstatus0
comma
id|timerstatus1
op_assign
l_int|0
suffix:semicolon
r_int
r_char
id|shift
suffix:semicolon
r_int
r_int
id|i
suffix:semicolon
r_int
r_int
id|tmp
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_ISR
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d): synclinkmp_interrupt(%d)entry.&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|irq
)paren
suffix:semicolon
id|info
op_assign
(paren
id|SLMP_INFO
op_star
)paren
id|dev_id
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info
)paren
r_return
id|IRQ_NONE
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|info-&gt;lock
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
multiline_comment|/* get status for SCA0 (ports 0-1) */
id|tmp
op_assign
id|read_reg16
c_func
(paren
id|info
comma
id|ISR0
)paren
suffix:semicolon
multiline_comment|/* get ISR0 and ISR1 in one read */
id|status0
op_assign
(paren
r_int
r_char
)paren
id|tmp
suffix:semicolon
id|dmastatus0
op_assign
(paren
r_int
r_char
)paren
(paren
id|tmp
op_rshift
l_int|8
)paren
suffix:semicolon
id|timerstatus0
op_assign
id|read_reg
c_func
(paren
id|info
comma
id|ISR2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_ISR
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s status0=%02x, dmastatus0=%02x, timerstatus0=%02x&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
comma
id|status0
comma
id|dmastatus0
comma
id|timerstatus0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;port_count
op_eq
l_int|4
)paren
(brace
multiline_comment|/* get status for SCA1 (ports 2-3) */
id|tmp
op_assign
id|read_reg16
c_func
(paren
id|info-&gt;port_array
(braket
l_int|2
)braket
comma
id|ISR0
)paren
suffix:semicolon
id|status1
op_assign
(paren
r_int
r_char
)paren
id|tmp
suffix:semicolon
id|dmastatus1
op_assign
(paren
r_int
r_char
)paren
(paren
id|tmp
op_rshift
l_int|8
)paren
suffix:semicolon
id|timerstatus1
op_assign
id|read_reg
c_func
(paren
id|info-&gt;port_array
(braket
l_int|2
)braket
comma
id|ISR2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_ISR
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s status1=%02x, dmastatus1=%02x, timerstatus1=%02x&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
comma
id|status1
comma
id|dmastatus1
comma
id|timerstatus1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|status0
op_logical_and
op_logical_neg
id|dmastatus0
op_logical_and
op_logical_neg
id|timerstatus0
op_logical_and
op_logical_neg
id|status1
op_logical_and
op_logical_neg
id|dmastatus1
op_logical_and
op_logical_neg
id|timerstatus1
)paren
r_break
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|info-&gt;port_count
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;port_array
(braket
id|i
)braket
op_eq
l_int|NULL
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|2
)paren
(brace
id|status
op_assign
id|status0
suffix:semicolon
id|dmastatus
op_assign
id|dmastatus0
suffix:semicolon
)brace
r_else
(brace
id|status
op_assign
id|status1
suffix:semicolon
id|dmastatus
op_assign
id|dmastatus1
suffix:semicolon
)brace
id|shift
op_assign
id|i
op_amp
l_int|1
ques
c_cond
l_int|4
suffix:colon
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|BIT0
op_lshift
id|shift
)paren
id|isr_rxrdy
c_func
(paren
id|info-&gt;port_array
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|BIT1
op_lshift
id|shift
)paren
id|isr_txrdy
c_func
(paren
id|info-&gt;port_array
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|BIT2
op_lshift
id|shift
)paren
id|isr_rxint
c_func
(paren
id|info-&gt;port_array
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|BIT3
op_lshift
id|shift
)paren
id|isr_txint
c_func
(paren
id|info-&gt;port_array
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dmastatus
op_amp
id|BIT0
op_lshift
id|shift
)paren
id|isr_rxdmaerror
c_func
(paren
id|info-&gt;port_array
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dmastatus
op_amp
id|BIT1
op_lshift
id|shift
)paren
id|isr_rxdmaok
c_func
(paren
id|info-&gt;port_array
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dmastatus
op_amp
id|BIT2
op_lshift
id|shift
)paren
id|isr_txdmaerror
c_func
(paren
id|info-&gt;port_array
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dmastatus
op_amp
id|BIT3
op_lshift
id|shift
)paren
id|isr_txdmaok
c_func
(paren
id|info-&gt;port_array
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|timerstatus0
op_amp
(paren
id|BIT5
op_or
id|BIT4
)paren
)paren
id|isr_timer
c_func
(paren
id|info-&gt;port_array
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|timerstatus0
op_amp
(paren
id|BIT7
op_or
id|BIT6
)paren
)paren
id|isr_timer
c_func
(paren
id|info-&gt;port_array
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|timerstatus1
op_amp
(paren
id|BIT5
op_or
id|BIT4
)paren
)paren
id|isr_timer
c_func
(paren
id|info-&gt;port_array
(braket
l_int|2
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|timerstatus1
op_amp
(paren
id|BIT7
op_or
id|BIT6
)paren
)paren
id|isr_timer
c_func
(paren
id|info-&gt;port_array
(braket
l_int|3
)braket
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|info-&gt;port_count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|SLMP_INFO
op_star
id|port
op_assign
id|info-&gt;port_array
(braket
id|i
)braket
suffix:semicolon
multiline_comment|/* Request bottom half processing if there&squot;s something&n;&t;&t; * for it to do and the bh is not already running.&n;&t;&t; *&n;&t;&t; * Note: startup adapter diags require interrupts.&n;&t;&t; * do not request bottom half processing if the&n;&t;&t; * device is not open in a normal mode.&n;&t;&t; */
r_if
c_cond
(paren
id|port
op_logical_and
(paren
id|port-&gt;count
op_logical_or
id|port-&gt;netcount
)paren
op_logical_and
id|port-&gt;pending_bh
op_logical_and
op_logical_neg
id|port-&gt;bh_running
op_logical_and
op_logical_neg
id|port-&gt;bh_requested
)paren
(brace
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_ISR
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s queueing bh task.&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|port-&gt;device_name
)paren
suffix:semicolon
id|schedule_work
c_func
(paren
op_amp
id|port-&gt;task
)paren
suffix:semicolon
id|port-&gt;bh_requested
op_assign
l_int|1
suffix:semicolon
)brace
)brace
id|spin_unlock
c_func
(paren
op_amp
id|info-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_ISR
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):synclinkmp_interrupt(%d)exit.&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|irq
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
multiline_comment|/* Initialize and start device.&n; */
DECL|function|startup
r_static
r_int
id|startup
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
(brace
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s tx_releaseup()&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;flags
op_amp
id|ASYNC_INITIALIZED
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;tx_buf
)paren
(brace
id|info-&gt;tx_buf
op_assign
(paren
r_int
r_char
op_star
)paren
id|kmalloc
c_func
(paren
id|info-&gt;max_frame_size
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;tx_buf
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s(%d):%s can&squot;t allocate transmit buffer&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
)brace
id|info-&gt;pending_bh
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* program hardware for current parameters */
id|reset_port
c_func
(paren
id|info
)paren
suffix:semicolon
id|change_params
c_func
(paren
id|info
)paren
suffix:semicolon
id|info-&gt;status_timer.expires
op_assign
id|jiffies
op_plus
id|msecs_to_jiffies
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|info-&gt;status_timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;tty
)paren
id|clear_bit
c_func
(paren
id|TTY_IO_ERROR
comma
op_amp
id|info-&gt;tty-&gt;flags
)paren
suffix:semicolon
id|info-&gt;flags
op_or_assign
id|ASYNC_INITIALIZED
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Called by close() and hangup() to shutdown hardware&n; */
DECL|function|shutdown
r_static
r_void
id|shutdown
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|info-&gt;flags
op_amp
id|ASYNC_INITIALIZED
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s synclinkmp_shutdown()&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
)paren
suffix:semicolon
multiline_comment|/* clear status wait queue because status changes */
multiline_comment|/* can&squot;t happen after shutting down the hardware */
id|wake_up_interruptible
c_func
(paren
op_amp
id|info-&gt;status_event_wait_q
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|info-&gt;event_wait_q
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|info-&gt;tx_timer
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|info-&gt;status_timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;tx_buf
)paren
(brace
id|kfree
c_func
(paren
id|info-&gt;tx_buf
)paren
suffix:semicolon
id|info-&gt;tx_buf
op_assign
l_int|NULL
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|reset_port
c_func
(paren
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;tty
op_logical_or
id|info-&gt;tty-&gt;termios-&gt;c_cflag
op_amp
id|HUPCL
)paren
(brace
id|info-&gt;serial_signals
op_and_assign
op_complement
(paren
id|SerialSignal_DTR
op_plus
id|SerialSignal_RTS
)paren
suffix:semicolon
id|set_signals
c_func
(paren
id|info
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;tty
)paren
id|set_bit
c_func
(paren
id|TTY_IO_ERROR
comma
op_amp
id|info-&gt;tty-&gt;flags
)paren
suffix:semicolon
id|info-&gt;flags
op_and_assign
op_complement
id|ASYNC_INITIALIZED
suffix:semicolon
)brace
DECL|function|program_hw
r_static
r_void
id|program_hw
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|rx_stop
c_func
(paren
id|info
)paren
suffix:semicolon
id|tx_stop
c_func
(paren
id|info
)paren
suffix:semicolon
id|info-&gt;tx_count
op_assign
id|info-&gt;tx_put
op_assign
id|info-&gt;tx_get
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;params.mode
op_eq
id|MGSL_MODE_HDLC
op_logical_or
id|info-&gt;netcount
)paren
id|hdlc_mode
c_func
(paren
id|info
)paren
suffix:semicolon
r_else
id|async_mode
c_func
(paren
id|info
)paren
suffix:semicolon
id|set_signals
c_func
(paren
id|info
)paren
suffix:semicolon
id|info-&gt;dcd_chkcount
op_assign
l_int|0
suffix:semicolon
id|info-&gt;cts_chkcount
op_assign
l_int|0
suffix:semicolon
id|info-&gt;ri_chkcount
op_assign
l_int|0
suffix:semicolon
id|info-&gt;dsr_chkcount
op_assign
l_int|0
suffix:semicolon
id|info-&gt;ie1_value
op_or_assign
(paren
id|CDCD
op_or
id|CCTS
)paren
suffix:semicolon
id|write_reg
c_func
(paren
id|info
comma
id|IE1
comma
id|info-&gt;ie1_value
)paren
suffix:semicolon
id|get_signals
c_func
(paren
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;netcount
op_logical_or
(paren
id|info-&gt;tty
op_logical_and
id|info-&gt;tty-&gt;termios-&gt;c_cflag
op_amp
id|CREAD
)paren
)paren
id|rx_start
c_func
(paren
id|info
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* Reconfigure adapter based on new parameters&n; */
DECL|function|change_params
r_static
r_void
id|change_params
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
(brace
r_int
id|cflag
suffix:semicolon
r_int
id|bits_per_char
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;tty
op_logical_or
op_logical_neg
id|info-&gt;tty-&gt;termios
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s change_params()&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
)paren
suffix:semicolon
id|cflag
op_assign
id|info-&gt;tty-&gt;termios-&gt;c_cflag
suffix:semicolon
multiline_comment|/* if B0 rate (hangup) specified then negate DTR and RTS */
multiline_comment|/* otherwise assert DTR and RTS */
r_if
c_cond
(paren
id|cflag
op_amp
id|CBAUD
)paren
id|info-&gt;serial_signals
op_or_assign
id|SerialSignal_RTS
op_plus
id|SerialSignal_DTR
suffix:semicolon
r_else
id|info-&gt;serial_signals
op_and_assign
op_complement
(paren
id|SerialSignal_RTS
op_plus
id|SerialSignal_DTR
)paren
suffix:semicolon
multiline_comment|/* byte size and parity */
r_switch
c_cond
(paren
id|cflag
op_amp
id|CSIZE
)paren
(brace
r_case
id|CS5
suffix:colon
id|info-&gt;params.data_bits
op_assign
l_int|5
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS6
suffix:colon
id|info-&gt;params.data_bits
op_assign
l_int|6
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS7
suffix:colon
id|info-&gt;params.data_bits
op_assign
l_int|7
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS8
suffix:colon
id|info-&gt;params.data_bits
op_assign
l_int|8
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* Never happens, but GCC is too dumb to figure it out */
r_default
suffix:colon
id|info-&gt;params.data_bits
op_assign
l_int|7
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cflag
op_amp
id|CSTOPB
)paren
id|info-&gt;params.stop_bits
op_assign
l_int|2
suffix:semicolon
r_else
id|info-&gt;params.stop_bits
op_assign
l_int|1
suffix:semicolon
id|info-&gt;params.parity
op_assign
id|ASYNC_PARITY_NONE
suffix:semicolon
r_if
c_cond
(paren
id|cflag
op_amp
id|PARENB
)paren
(brace
r_if
c_cond
(paren
id|cflag
op_amp
id|PARODD
)paren
id|info-&gt;params.parity
op_assign
id|ASYNC_PARITY_ODD
suffix:semicolon
r_else
id|info-&gt;params.parity
op_assign
id|ASYNC_PARITY_EVEN
suffix:semicolon
macro_line|#ifdef CMSPAR
r_if
c_cond
(paren
id|cflag
op_amp
id|CMSPAR
)paren
id|info-&gt;params.parity
op_assign
id|ASYNC_PARITY_SPACE
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/* calculate number of jiffies to transmit a full&n;&t; * FIFO (32 bytes) at specified data rate&n;&t; */
id|bits_per_char
op_assign
id|info-&gt;params.data_bits
op_plus
id|info-&gt;params.stop_bits
op_plus
l_int|1
suffix:semicolon
multiline_comment|/* if port data rate is set to 460800 or less then&n;&t; * allow tty settings to override, otherwise keep the&n;&t; * current data rate.&n;&t; */
r_if
c_cond
(paren
id|info-&gt;params.data_rate
op_le
l_int|460800
)paren
(brace
id|info-&gt;params.data_rate
op_assign
id|tty_get_baud_rate
c_func
(paren
id|info-&gt;tty
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|info-&gt;params.data_rate
)paren
(brace
id|info-&gt;timeout
op_assign
(paren
l_int|32
op_star
id|HZ
op_star
id|bits_per_char
)paren
op_div
id|info-&gt;params.data_rate
suffix:semicolon
)brace
id|info-&gt;timeout
op_add_assign
id|HZ
op_div
l_int|50
suffix:semicolon
multiline_comment|/* Add .02 seconds of slop */
r_if
c_cond
(paren
id|cflag
op_amp
id|CRTSCTS
)paren
id|info-&gt;flags
op_or_assign
id|ASYNC_CTS_FLOW
suffix:semicolon
r_else
id|info-&gt;flags
op_and_assign
op_complement
id|ASYNC_CTS_FLOW
suffix:semicolon
r_if
c_cond
(paren
id|cflag
op_amp
id|CLOCAL
)paren
id|info-&gt;flags
op_and_assign
op_complement
id|ASYNC_CHECK_CD
suffix:semicolon
r_else
id|info-&gt;flags
op_or_assign
id|ASYNC_CHECK_CD
suffix:semicolon
multiline_comment|/* process tty input control flags */
id|info-&gt;read_status_mask2
op_assign
id|OVRN
suffix:semicolon
r_if
c_cond
(paren
id|I_INPCK
c_func
(paren
id|info-&gt;tty
)paren
)paren
id|info-&gt;read_status_mask2
op_or_assign
id|PE
op_or
id|FRME
suffix:semicolon
r_if
c_cond
(paren
id|I_BRKINT
c_func
(paren
id|info-&gt;tty
)paren
op_logical_or
id|I_PARMRK
c_func
(paren
id|info-&gt;tty
)paren
)paren
id|info-&gt;read_status_mask1
op_or_assign
id|BRKD
suffix:semicolon
r_if
c_cond
(paren
id|I_IGNPAR
c_func
(paren
id|info-&gt;tty
)paren
)paren
id|info-&gt;ignore_status_mask2
op_or_assign
id|PE
op_or
id|FRME
suffix:semicolon
r_if
c_cond
(paren
id|I_IGNBRK
c_func
(paren
id|info-&gt;tty
)paren
)paren
(brace
id|info-&gt;ignore_status_mask1
op_or_assign
id|BRKD
suffix:semicolon
multiline_comment|/* If ignoring parity and break indicators, ignore&n;&t;&t; * overruns too.  (For real raw support).&n;&t;&t; */
r_if
c_cond
(paren
id|I_IGNPAR
c_func
(paren
id|info-&gt;tty
)paren
)paren
id|info-&gt;ignore_status_mask2
op_or_assign
id|OVRN
suffix:semicolon
)brace
id|program_hw
c_func
(paren
id|info
)paren
suffix:semicolon
)brace
DECL|function|get_stats
r_static
r_int
id|get_stats
c_func
(paren
id|SLMP_INFO
op_star
id|info
comma
r_struct
id|mgsl_icount
id|__user
op_star
id|user_icount
)paren
(brace
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s get_params()&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
)paren
suffix:semicolon
id|COPY_TO_USER
c_func
(paren
id|err
comma
id|user_icount
comma
op_amp
id|info-&gt;icount
comma
r_sizeof
(paren
r_struct
id|mgsl_icount
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s get_stats() user buffer copy failed&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|get_params
r_static
r_int
id|get_params
c_func
(paren
id|SLMP_INFO
op_star
id|info
comma
id|MGSL_PARAMS
id|__user
op_star
id|user_params
)paren
(brace
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s get_params()&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
)paren
suffix:semicolon
id|COPY_TO_USER
c_func
(paren
id|err
comma
id|user_params
comma
op_amp
id|info-&gt;params
comma
r_sizeof
(paren
id|MGSL_PARAMS
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s get_params() user buffer copy failed&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|set_params
r_static
r_int
id|set_params
c_func
(paren
id|SLMP_INFO
op_star
id|info
comma
id|MGSL_PARAMS
id|__user
op_star
id|new_params
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|MGSL_PARAMS
id|tmp_params
suffix:semicolon
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s set_params&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
)paren
suffix:semicolon
id|COPY_FROM_USER
c_func
(paren
id|err
comma
op_amp
id|tmp_params
comma
id|new_params
comma
r_sizeof
(paren
id|MGSL_PARAMS
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s set_params() user buffer copy failed&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|info-&gt;params
comma
op_amp
id|tmp_params
comma
r_sizeof
(paren
id|MGSL_PARAMS
)paren
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|change_params
c_func
(paren
id|info
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|get_txidle
r_static
r_int
id|get_txidle
c_func
(paren
id|SLMP_INFO
op_star
id|info
comma
r_int
id|__user
op_star
id|idle_mode
)paren
(brace
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s get_txidle()=%d&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
comma
id|info-&gt;idle_mode
)paren
suffix:semicolon
id|COPY_TO_USER
c_func
(paren
id|err
comma
id|idle_mode
comma
op_amp
id|info-&gt;idle_mode
comma
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s get_txidle() user buffer copy failed&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|set_txidle
r_static
r_int
id|set_txidle
c_func
(paren
id|SLMP_INFO
op_star
id|info
comma
r_int
id|idle_mode
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s set_txidle(%d)&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
comma
id|idle_mode
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|info-&gt;idle_mode
op_assign
id|idle_mode
suffix:semicolon
id|tx_set_idle
c_func
(paren
id|info
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|tx_enable
r_static
r_int
id|tx_enable
c_func
(paren
id|SLMP_INFO
op_star
id|info
comma
r_int
id|enable
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s tx_enable(%d)&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
comma
id|enable
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|enable
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;tx_enabled
)paren
(brace
id|tx_start
c_func
(paren
id|info
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|info-&gt;tx_enabled
)paren
id|tx_stop
c_func
(paren
id|info
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* abort send HDLC frame&n; */
DECL|function|tx_abort
r_static
r_int
id|tx_abort
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s tx_abort()&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;tx_active
op_logical_and
id|info-&gt;params.mode
op_eq
id|MGSL_MODE_HDLC
)paren
(brace
id|info-&gt;ie1_value
op_and_assign
op_complement
id|UDRN
suffix:semicolon
id|info-&gt;ie1_value
op_or_assign
id|IDLE
suffix:semicolon
id|write_reg
c_func
(paren
id|info
comma
id|IE1
comma
id|info-&gt;ie1_value
)paren
suffix:semicolon
multiline_comment|/* disable tx status interrupts */
id|write_reg
c_func
(paren
id|info
comma
id|SR1
comma
(paren
r_int
r_char
)paren
(paren
id|IDLE
op_plus
id|UDRN
)paren
)paren
suffix:semicolon
multiline_comment|/* clear pending */
id|write_reg
c_func
(paren
id|info
comma
id|TXDMA
op_plus
id|DSR
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* disable DMA channel */
id|write_reg
c_func
(paren
id|info
comma
id|TXDMA
op_plus
id|DCMD
comma
id|SWABORT
)paren
suffix:semicolon
multiline_comment|/* reset/init DMA channel */
id|write_reg
c_func
(paren
id|info
comma
id|CMD
comma
id|TXABORT
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|rx_enable
r_static
r_int
id|rx_enable
c_func
(paren
id|SLMP_INFO
op_star
id|info
comma
r_int
id|enable
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s rx_enable(%d)&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
comma
id|enable
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|enable
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;rx_enabled
)paren
id|rx_start
c_func
(paren
id|info
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|info-&gt;rx_enabled
)paren
id|rx_stop
c_func
(paren
id|info
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|map_status
r_static
r_int
id|map_status
c_func
(paren
r_int
id|signals
)paren
(brace
multiline_comment|/* Map status bits to API event bits */
r_return
(paren
(paren
id|signals
op_amp
id|SerialSignal_DSR
)paren
ques
c_cond
id|MgslEvent_DsrActive
suffix:colon
id|MgslEvent_DsrInactive
)paren
op_plus
(paren
(paren
id|signals
op_amp
id|SerialSignal_CTS
)paren
ques
c_cond
id|MgslEvent_CtsActive
suffix:colon
id|MgslEvent_CtsInactive
)paren
op_plus
(paren
(paren
id|signals
op_amp
id|SerialSignal_DCD
)paren
ques
c_cond
id|MgslEvent_DcdActive
suffix:colon
id|MgslEvent_DcdInactive
)paren
op_plus
(paren
(paren
id|signals
op_amp
id|SerialSignal_RI
)paren
ques
c_cond
id|MgslEvent_RiActive
suffix:colon
id|MgslEvent_RiInactive
)paren
suffix:semicolon
)brace
multiline_comment|/* wait for specified event to occur&n; */
DECL|function|wait_mgsl_event
r_static
r_int
id|wait_mgsl_event
c_func
(paren
id|SLMP_INFO
op_star
id|info
comma
r_int
id|__user
op_star
id|mask_ptr
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|s
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_struct
id|mgsl_icount
id|cprev
comma
id|cnow
suffix:semicolon
r_int
id|events
suffix:semicolon
r_int
id|mask
suffix:semicolon
r_struct
id|_input_signal_events
id|oldsigs
comma
id|newsigs
suffix:semicolon
id|DECLARE_WAITQUEUE
c_func
(paren
id|wait
comma
id|current
)paren
suffix:semicolon
id|COPY_FROM_USER
c_func
(paren
id|rc
comma
op_amp
id|mask
comma
id|mask_ptr
comma
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s wait_mgsl_event(%d)&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
comma
id|mask
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* return immediately if state matches requested events */
id|get_signals
c_func
(paren
id|info
)paren
suffix:semicolon
id|s
op_assign
id|map_status
c_func
(paren
id|info-&gt;serial_signals
)paren
suffix:semicolon
id|events
op_assign
id|mask
op_amp
(paren
(paren
(paren
id|s
op_amp
id|SerialSignal_DSR
)paren
ques
c_cond
id|MgslEvent_DsrActive
suffix:colon
id|MgslEvent_DsrInactive
)paren
op_plus
(paren
(paren
id|s
op_amp
id|SerialSignal_DCD
)paren
ques
c_cond
id|MgslEvent_DcdActive
suffix:colon
id|MgslEvent_DcdInactive
)paren
op_plus
(paren
(paren
id|s
op_amp
id|SerialSignal_CTS
)paren
ques
c_cond
id|MgslEvent_CtsActive
suffix:colon
id|MgslEvent_CtsInactive
)paren
op_plus
(paren
(paren
id|s
op_amp
id|SerialSignal_RI
)paren
ques
c_cond
id|MgslEvent_RiActive
suffix:colon
id|MgslEvent_RiInactive
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|events
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
multiline_comment|/* save current irq counts */
id|cprev
op_assign
id|info-&gt;icount
suffix:semicolon
id|oldsigs
op_assign
id|info-&gt;input_signal_events
suffix:semicolon
multiline_comment|/* enable hunt and idle irqs if needed */
r_if
c_cond
(paren
id|mask
op_amp
(paren
id|MgslEvent_ExitHuntMode
op_plus
id|MgslEvent_IdleReceived
)paren
)paren
(brace
r_int
r_char
id|oldval
op_assign
id|info-&gt;ie1_value
suffix:semicolon
r_int
r_char
id|newval
op_assign
id|oldval
op_plus
(paren
id|mask
op_amp
id|MgslEvent_ExitHuntMode
ques
c_cond
id|FLGD
suffix:colon
l_int|0
)paren
op_plus
(paren
id|mask
op_amp
id|MgslEvent_IdleReceived
ques
c_cond
id|IDLD
suffix:colon
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|oldval
op_ne
id|newval
)paren
(brace
id|info-&gt;ie1_value
op_assign
id|newval
suffix:semicolon
id|write_reg
c_func
(paren
id|info
comma
id|IE1
comma
id|info-&gt;ie1_value
)paren
suffix:semicolon
)brace
)brace
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|add_wait_queue
c_func
(paren
op_amp
id|info-&gt;event_wait_q
comma
op_amp
id|wait
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|schedule
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
id|rc
op_assign
op_minus
id|ERESTARTSYS
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* get current irq counts */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|cnow
op_assign
id|info-&gt;icount
suffix:semicolon
id|newsigs
op_assign
id|info-&gt;input_signal_events
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* if no change, wait aborted for some reason */
r_if
c_cond
(paren
id|newsigs.dsr_up
op_eq
id|oldsigs.dsr_up
op_logical_and
id|newsigs.dsr_down
op_eq
id|oldsigs.dsr_down
op_logical_and
id|newsigs.dcd_up
op_eq
id|oldsigs.dcd_up
op_logical_and
id|newsigs.dcd_down
op_eq
id|oldsigs.dcd_down
op_logical_and
id|newsigs.cts_up
op_eq
id|oldsigs.cts_up
op_logical_and
id|newsigs.cts_down
op_eq
id|oldsigs.cts_down
op_logical_and
id|newsigs.ri_up
op_eq
id|oldsigs.ri_up
op_logical_and
id|newsigs.ri_down
op_eq
id|oldsigs.ri_down
op_logical_and
id|cnow.exithunt
op_eq
id|cprev.exithunt
op_logical_and
id|cnow.rxidle
op_eq
id|cprev.rxidle
)paren
(brace
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
r_break
suffix:semicolon
)brace
id|events
op_assign
id|mask
op_amp
(paren
(paren
id|newsigs.dsr_up
op_ne
id|oldsigs.dsr_up
ques
c_cond
id|MgslEvent_DsrActive
suffix:colon
l_int|0
)paren
op_plus
(paren
id|newsigs.dsr_down
op_ne
id|oldsigs.dsr_down
ques
c_cond
id|MgslEvent_DsrInactive
suffix:colon
l_int|0
)paren
op_plus
(paren
id|newsigs.dcd_up
op_ne
id|oldsigs.dcd_up
ques
c_cond
id|MgslEvent_DcdActive
suffix:colon
l_int|0
)paren
op_plus
(paren
id|newsigs.dcd_down
op_ne
id|oldsigs.dcd_down
ques
c_cond
id|MgslEvent_DcdInactive
suffix:colon
l_int|0
)paren
op_plus
(paren
id|newsigs.cts_up
op_ne
id|oldsigs.cts_up
ques
c_cond
id|MgslEvent_CtsActive
suffix:colon
l_int|0
)paren
op_plus
(paren
id|newsigs.cts_down
op_ne
id|oldsigs.cts_down
ques
c_cond
id|MgslEvent_CtsInactive
suffix:colon
l_int|0
)paren
op_plus
(paren
id|newsigs.ri_up
op_ne
id|oldsigs.ri_up
ques
c_cond
id|MgslEvent_RiActive
suffix:colon
l_int|0
)paren
op_plus
(paren
id|newsigs.ri_down
op_ne
id|oldsigs.ri_down
ques
c_cond
id|MgslEvent_RiInactive
suffix:colon
l_int|0
)paren
op_plus
(paren
id|cnow.exithunt
op_ne
id|cprev.exithunt
ques
c_cond
id|MgslEvent_ExitHuntMode
suffix:colon
l_int|0
)paren
op_plus
(paren
id|cnow.rxidle
op_ne
id|cprev.rxidle
ques
c_cond
id|MgslEvent_IdleReceived
suffix:colon
l_int|0
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|events
)paren
r_break
suffix:semicolon
id|cprev
op_assign
id|cnow
suffix:semicolon
id|oldsigs
op_assign
id|newsigs
suffix:semicolon
)brace
id|remove_wait_queue
c_func
(paren
op_amp
id|info-&gt;event_wait_q
comma
op_amp
id|wait
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_RUNNING
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mask
op_amp
(paren
id|MgslEvent_ExitHuntMode
op_plus
id|MgslEvent_IdleReceived
)paren
)paren
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|waitqueue_active
c_func
(paren
op_amp
id|info-&gt;event_wait_q
)paren
)paren
(brace
multiline_comment|/* disable enable exit hunt mode/idle rcvd IRQs */
id|info-&gt;ie1_value
op_and_assign
op_complement
(paren
id|FLGD
op_or
id|IDLD
)paren
suffix:semicolon
id|write_reg
c_func
(paren
id|info
comma
id|IE1
comma
id|info-&gt;ie1_value
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
m_exit
suffix:colon
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
)paren
id|PUT_USER
c_func
(paren
id|rc
comma
id|events
comma
id|mask_ptr
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|modem_input_wait
r_static
r_int
id|modem_input_wait
c_func
(paren
id|SLMP_INFO
op_star
id|info
comma
r_int
id|arg
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_struct
id|mgsl_icount
id|cprev
comma
id|cnow
suffix:semicolon
id|DECLARE_WAITQUEUE
c_func
(paren
id|wait
comma
id|current
)paren
suffix:semicolon
multiline_comment|/* save current irq counts */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|cprev
op_assign
id|info-&gt;icount
suffix:semicolon
id|add_wait_queue
c_func
(paren
op_amp
id|info-&gt;status_event_wait_q
comma
op_amp
id|wait
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|schedule
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
id|rc
op_assign
op_minus
id|ERESTARTSYS
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* get new irq counts */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|cnow
op_assign
id|info-&gt;icount
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* if no change, wait aborted for some reason */
r_if
c_cond
(paren
id|cnow.rng
op_eq
id|cprev.rng
op_logical_and
id|cnow.dsr
op_eq
id|cprev.dsr
op_logical_and
id|cnow.dcd
op_eq
id|cprev.dcd
op_logical_and
id|cnow.cts
op_eq
id|cprev.cts
)paren
(brace
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* check for change in caller specified modem input */
r_if
c_cond
(paren
(paren
id|arg
op_amp
id|TIOCM_RNG
op_logical_and
id|cnow.rng
op_ne
id|cprev.rng
)paren
op_logical_or
(paren
id|arg
op_amp
id|TIOCM_DSR
op_logical_and
id|cnow.dsr
op_ne
id|cprev.dsr
)paren
op_logical_or
(paren
id|arg
op_amp
id|TIOCM_CD
op_logical_and
id|cnow.dcd
op_ne
id|cprev.dcd
)paren
op_logical_or
(paren
id|arg
op_amp
id|TIOCM_CTS
op_logical_and
id|cnow.cts
op_ne
id|cprev.cts
)paren
)paren
(brace
id|rc
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
id|cprev
op_assign
id|cnow
suffix:semicolon
)brace
id|remove_wait_queue
c_func
(paren
op_amp
id|info-&gt;status_event_wait_q
comma
op_amp
id|wait
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_RUNNING
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/* return the state of the serial control and status signals&n; */
DECL|function|tiocmget
r_static
r_int
id|tiocmget
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|file
)paren
(brace
id|SLMP_INFO
op_star
id|info
op_assign
(paren
id|SLMP_INFO
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_int
r_int
id|result
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|get_signals
c_func
(paren
id|info
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|result
op_assign
(paren
(paren
id|info-&gt;serial_signals
op_amp
id|SerialSignal_RTS
)paren
ques
c_cond
id|TIOCM_RTS
suffix:colon
l_int|0
)paren
op_plus
(paren
(paren
id|info-&gt;serial_signals
op_amp
id|SerialSignal_DTR
)paren
ques
c_cond
id|TIOCM_DTR
suffix:colon
l_int|0
)paren
op_plus
(paren
(paren
id|info-&gt;serial_signals
op_amp
id|SerialSignal_DCD
)paren
ques
c_cond
id|TIOCM_CAR
suffix:colon
l_int|0
)paren
op_plus
(paren
(paren
id|info-&gt;serial_signals
op_amp
id|SerialSignal_RI
)paren
ques
c_cond
id|TIOCM_RNG
suffix:colon
l_int|0
)paren
op_plus
(paren
(paren
id|info-&gt;serial_signals
op_amp
id|SerialSignal_DSR
)paren
ques
c_cond
id|TIOCM_DSR
suffix:colon
l_int|0
)paren
op_plus
(paren
(paren
id|info-&gt;serial_signals
op_amp
id|SerialSignal_CTS
)paren
ques
c_cond
id|TIOCM_CTS
suffix:colon
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s tiocmget() value=%08X&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
comma
id|result
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/* set modem control signals (DTR/RTS)&n; */
DECL|function|tiocmset
r_static
r_int
id|tiocmset
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|set
comma
r_int
r_int
id|clear
)paren
(brace
id|SLMP_INFO
op_star
id|info
op_assign
(paren
id|SLMP_INFO
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s tiocmset(%x,%x)&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
comma
id|set
comma
id|clear
)paren
suffix:semicolon
r_if
c_cond
(paren
id|set
op_amp
id|TIOCM_RTS
)paren
id|info-&gt;serial_signals
op_or_assign
id|SerialSignal_RTS
suffix:semicolon
r_if
c_cond
(paren
id|set
op_amp
id|TIOCM_DTR
)paren
id|info-&gt;serial_signals
op_or_assign
id|SerialSignal_DTR
suffix:semicolon
r_if
c_cond
(paren
id|clear
op_amp
id|TIOCM_RTS
)paren
id|info-&gt;serial_signals
op_and_assign
op_complement
id|SerialSignal_RTS
suffix:semicolon
r_if
c_cond
(paren
id|clear
op_amp
id|TIOCM_DTR
)paren
id|info-&gt;serial_signals
op_and_assign
op_complement
id|SerialSignal_DTR
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|set_signals
c_func
(paren
id|info
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Block the current process until the specified port is ready to open.&n; */
DECL|function|block_til_ready
r_static
r_int
id|block_til_ready
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|filp
comma
id|SLMP_INFO
op_star
id|info
)paren
(brace
id|DECLARE_WAITQUEUE
c_func
(paren
id|wait
comma
id|current
)paren
suffix:semicolon
r_int
id|retval
suffix:semicolon
r_int
id|do_clocal
op_assign
l_int|0
comma
id|extra_count
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s block_til_ready()&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|tty-&gt;driver-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|filp-&gt;f_flags
op_amp
id|O_NONBLOCK
op_logical_or
id|tty-&gt;flags
op_amp
(paren
l_int|1
op_lshift
id|TTY_IO_ERROR
)paren
)paren
(brace
multiline_comment|/* nonblock mode is set or port is not enabled */
multiline_comment|/* just verify that callout device is not active */
id|info-&gt;flags
op_or_assign
id|ASYNC_NORMAL_ACTIVE
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tty-&gt;termios-&gt;c_cflag
op_amp
id|CLOCAL
)paren
id|do_clocal
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Wait for carrier detect and the line to become&n;&t; * free (i.e., not in use by the callout).  While we are in&n;&t; * this loop, info-&gt;count is dropped by one, so that&n;&t; * close() knows when to free things.  We restore it upon&n;&t; * exit, either normal or abnormal.&n;&t; */
id|retval
op_assign
l_int|0
suffix:semicolon
id|add_wait_queue
c_func
(paren
op_amp
id|info-&gt;open_wait
comma
op_amp
id|wait
)paren
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s block_til_ready() before block, count=%d&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|tty-&gt;driver-&gt;name
comma
id|info-&gt;count
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tty_hung_up_p
c_func
(paren
id|filp
)paren
)paren
(brace
id|extra_count
op_assign
l_int|1
suffix:semicolon
id|info-&gt;count
op_decrement
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|info-&gt;blocked_open
op_increment
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
r_if
c_cond
(paren
(paren
id|tty-&gt;termios-&gt;c_cflag
op_amp
id|CBAUD
)paren
)paren
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|info-&gt;serial_signals
op_or_assign
id|SerialSignal_RTS
op_plus
id|SerialSignal_DTR
suffix:semicolon
id|set_signals
c_func
(paren
id|info
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tty_hung_up_p
c_func
(paren
id|filp
)paren
op_logical_or
op_logical_neg
(paren
id|info-&gt;flags
op_amp
id|ASYNC_INITIALIZED
)paren
)paren
(brace
id|retval
op_assign
(paren
id|info-&gt;flags
op_amp
id|ASYNC_HUP_NOTIFY
)paren
ques
c_cond
op_minus
id|EAGAIN
suffix:colon
op_minus
id|ERESTARTSYS
suffix:semicolon
r_break
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|get_signals
c_func
(paren
id|info
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|info-&gt;flags
op_amp
id|ASYNC_CLOSING
)paren
op_logical_and
(paren
id|do_clocal
op_logical_or
(paren
id|info-&gt;serial_signals
op_amp
id|SerialSignal_DCD
)paren
)paren
)paren
(brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
id|retval
op_assign
op_minus
id|ERESTARTSYS
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s block_til_ready() count=%d&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|tty-&gt;driver-&gt;name
comma
id|info-&gt;count
)paren
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
)brace
id|set_current_state
c_func
(paren
id|TASK_RUNNING
)paren
suffix:semicolon
id|remove_wait_queue
c_func
(paren
op_amp
id|info-&gt;open_wait
comma
op_amp
id|wait
)paren
suffix:semicolon
r_if
c_cond
(paren
id|extra_count
)paren
id|info-&gt;count
op_increment
suffix:semicolon
id|info-&gt;blocked_open
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s block_til_ready() after, count=%d&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|tty-&gt;driver-&gt;name
comma
id|info-&gt;count
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
id|info-&gt;flags
op_or_assign
id|ASYNC_NORMAL_ACTIVE
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
DECL|function|alloc_dma_bufs
r_int
id|alloc_dma_bufs
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
(brace
r_int
r_int
id|BuffersPerFrame
suffix:semicolon
r_int
r_int
id|BufferCount
suffix:semicolon
singleline_comment|// Force allocation to start at 64K boundary for each port.
singleline_comment|// This is necessary because *all* buffer descriptors for a port
singleline_comment|// *must* be in the same 64K block. All descriptors on a port
singleline_comment|// share a common &squot;base&squot; address (upper 8 bits of 24 bits) programmed
singleline_comment|// into the CBP register.
id|info-&gt;port_array
(braket
l_int|0
)braket
op_member_access_from_pointer
id|last_mem_alloc
op_assign
(paren
id|SCA_MEM_SIZE
op_div
l_int|4
)paren
op_star
id|info-&gt;port_num
suffix:semicolon
multiline_comment|/* Calculate the number of DMA buffers necessary to hold the */
multiline_comment|/* largest allowable frame size. Note: If the max frame size is */
multiline_comment|/* not an even multiple of the DMA buffer size then we need to */
multiline_comment|/* round the buffer count per frame up one. */
id|BuffersPerFrame
op_assign
(paren
r_int
r_int
)paren
(paren
id|info-&gt;max_frame_size
op_div
id|SCABUFSIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;max_frame_size
op_mod
id|SCABUFSIZE
)paren
id|BuffersPerFrame
op_increment
suffix:semicolon
multiline_comment|/* calculate total number of data buffers (SCABUFSIZE) possible&n;&t; * in one ports memory (SCA_MEM_SIZE/4) after allocating memory&n;&t; * for the descriptor list (BUFFERLISTSIZE).&n;&t; */
id|BufferCount
op_assign
(paren
id|SCA_MEM_SIZE
op_div
l_int|4
op_minus
id|BUFFERLISTSIZE
)paren
op_div
id|SCABUFSIZE
suffix:semicolon
multiline_comment|/* limit number of buffers to maximum amount of descriptors */
r_if
c_cond
(paren
id|BufferCount
OG
id|BUFFERLISTSIZE
op_div
r_sizeof
(paren
id|SCADESC
)paren
)paren
id|BufferCount
op_assign
id|BUFFERLISTSIZE
op_div
r_sizeof
(paren
id|SCADESC
)paren
suffix:semicolon
multiline_comment|/* use enough buffers to transmit one max size frame */
id|info-&gt;tx_buf_count
op_assign
id|BuffersPerFrame
op_plus
l_int|1
suffix:semicolon
multiline_comment|/* never use more than half the available buffers for transmit */
r_if
c_cond
(paren
id|info-&gt;tx_buf_count
OG
(paren
id|BufferCount
op_div
l_int|2
)paren
)paren
id|info-&gt;tx_buf_count
op_assign
id|BufferCount
op_div
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;tx_buf_count
OG
id|SCAMAXDESC
)paren
id|info-&gt;tx_buf_count
op_assign
id|SCAMAXDESC
suffix:semicolon
multiline_comment|/* use remaining buffers for receive */
id|info-&gt;rx_buf_count
op_assign
id|BufferCount
op_minus
id|info-&gt;tx_buf_count
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;rx_buf_count
OG
id|SCAMAXDESC
)paren
id|info-&gt;rx_buf_count
op_assign
id|SCAMAXDESC
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s Allocating %d TX and %d RX DMA buffers.&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
comma
id|info-&gt;tx_buf_count
comma
id|info-&gt;rx_buf_count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|alloc_buf_list
c_func
(paren
id|info
)paren
OL
l_int|0
op_logical_or
id|alloc_frame_bufs
c_func
(paren
id|info
comma
id|info-&gt;rx_buf_list
comma
id|info-&gt;rx_buf_list_ex
comma
id|info-&gt;rx_buf_count
)paren
OL
l_int|0
op_logical_or
id|alloc_frame_bufs
c_func
(paren
id|info
comma
id|info-&gt;tx_buf_list
comma
id|info-&gt;tx_buf_list_ex
comma
id|info-&gt;tx_buf_count
)paren
OL
l_int|0
op_logical_or
id|alloc_tmp_rx_buf
c_func
(paren
id|info
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s Can&squot;t allocate DMA buffer memory&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|rx_reset_buffers
c_func
(paren
id|info
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Allocate DMA buffers for the transmit and receive descriptor lists.&n; */
DECL|function|alloc_buf_list
r_int
id|alloc_buf_list
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
(brace
r_int
r_int
id|i
suffix:semicolon
multiline_comment|/* build list in adapter shared memory */
id|info-&gt;buffer_list
op_assign
id|info-&gt;memory_base
op_plus
id|info-&gt;port_array
(braket
l_int|0
)braket
op_member_access_from_pointer
id|last_mem_alloc
suffix:semicolon
id|info-&gt;buffer_list_phys
op_assign
id|info-&gt;port_array
(braket
l_int|0
)braket
op_member_access_from_pointer
id|last_mem_alloc
suffix:semicolon
id|info-&gt;port_array
(braket
l_int|0
)braket
op_member_access_from_pointer
id|last_mem_alloc
op_add_assign
id|BUFFERLISTSIZE
suffix:semicolon
id|memset
c_func
(paren
id|info-&gt;buffer_list
comma
l_int|0
comma
id|BUFFERLISTSIZE
)paren
suffix:semicolon
multiline_comment|/* Save virtual address pointers to the receive and */
multiline_comment|/* transmit buffer lists. (Receive 1st). These pointers will */
multiline_comment|/* be used by the processor to access the lists. */
id|info-&gt;rx_buf_list
op_assign
(paren
id|SCADESC
op_star
)paren
id|info-&gt;buffer_list
suffix:semicolon
id|info-&gt;tx_buf_list
op_assign
(paren
id|SCADESC
op_star
)paren
id|info-&gt;buffer_list
suffix:semicolon
id|info-&gt;tx_buf_list
op_add_assign
id|info-&gt;rx_buf_count
suffix:semicolon
multiline_comment|/* Build links for circular buffer entry lists (tx and rx)&n;&t; *&n;&t; * Note: links are physical addresses read by the SCA device&n;&t; * to determine the next buffer entry to use.&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|info-&gt;rx_buf_count
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* calculate and store physical address of this buffer entry */
id|info-&gt;rx_buf_list_ex
(braket
id|i
)braket
dot
id|phys_entry
op_assign
id|info-&gt;buffer_list_phys
op_plus
(paren
id|i
op_star
r_sizeof
(paren
id|SCABUFSIZE
)paren
)paren
suffix:semicolon
multiline_comment|/* calculate and store physical address of */
multiline_comment|/* next entry in cirular list of entries */
id|info-&gt;rx_buf_list
(braket
id|i
)braket
dot
id|next
op_assign
id|info-&gt;buffer_list_phys
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
id|info-&gt;rx_buf_count
op_minus
l_int|1
)paren
id|info-&gt;rx_buf_list
(braket
id|i
)braket
dot
id|next
op_add_assign
(paren
id|i
op_plus
l_int|1
)paren
op_star
r_sizeof
(paren
id|SCADESC
)paren
suffix:semicolon
id|info-&gt;rx_buf_list
(braket
id|i
)braket
dot
id|length
op_assign
id|SCABUFSIZE
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|info-&gt;tx_buf_count
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* calculate and store physical address of this buffer entry */
id|info-&gt;tx_buf_list_ex
(braket
id|i
)braket
dot
id|phys_entry
op_assign
id|info-&gt;buffer_list_phys
op_plus
(paren
(paren
id|info-&gt;rx_buf_count
op_plus
id|i
)paren
op_star
r_sizeof
(paren
id|SCADESC
)paren
)paren
suffix:semicolon
multiline_comment|/* calculate and store physical address of */
multiline_comment|/* next entry in cirular list of entries */
id|info-&gt;tx_buf_list
(braket
id|i
)braket
dot
id|next
op_assign
id|info-&gt;buffer_list_phys
op_plus
id|info-&gt;rx_buf_count
op_star
r_sizeof
(paren
id|SCADESC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
id|info-&gt;tx_buf_count
op_minus
l_int|1
)paren
id|info-&gt;tx_buf_list
(braket
id|i
)braket
dot
id|next
op_add_assign
(paren
id|i
op_plus
l_int|1
)paren
op_star
r_sizeof
(paren
id|SCADESC
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Allocate the frame DMA buffers used by the specified buffer list.&n; */
DECL|function|alloc_frame_bufs
r_int
id|alloc_frame_bufs
c_func
(paren
id|SLMP_INFO
op_star
id|info
comma
id|SCADESC
op_star
id|buf_list
comma
id|SCADESC_EX
op_star
id|buf_list_ex
comma
r_int
id|count
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
r_int
id|phys_addr
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|buf_list_ex
(braket
id|i
)braket
dot
id|virt_addr
op_assign
id|info-&gt;memory_base
op_plus
id|info-&gt;port_array
(braket
l_int|0
)braket
op_member_access_from_pointer
id|last_mem_alloc
suffix:semicolon
id|phys_addr
op_assign
id|info-&gt;port_array
(braket
l_int|0
)braket
op_member_access_from_pointer
id|last_mem_alloc
suffix:semicolon
id|info-&gt;port_array
(braket
l_int|0
)braket
op_member_access_from_pointer
id|last_mem_alloc
op_add_assign
id|SCABUFSIZE
suffix:semicolon
id|buf_list
(braket
id|i
)braket
dot
id|buf_ptr
op_assign
(paren
r_int
r_int
)paren
id|phys_addr
suffix:semicolon
id|buf_list
(braket
id|i
)braket
dot
id|buf_base
op_assign
(paren
r_int
r_char
)paren
(paren
id|phys_addr
op_rshift
l_int|16
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|free_dma_bufs
r_void
id|free_dma_bufs
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
(brace
id|info-&gt;buffer_list
op_assign
l_int|NULL
suffix:semicolon
id|info-&gt;rx_buf_list
op_assign
l_int|NULL
suffix:semicolon
id|info-&gt;tx_buf_list
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* allocate buffer large enough to hold max_frame_size.&n; * This buffer is used to pass an assembled frame to the line discipline.&n; */
DECL|function|alloc_tmp_rx_buf
r_int
id|alloc_tmp_rx_buf
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
(brace
id|info-&gt;tmp_rx_buf
op_assign
id|kmalloc
c_func
(paren
id|info-&gt;max_frame_size
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;tmp_rx_buf
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|free_tmp_rx_buf
r_void
id|free_tmp_rx_buf
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;tmp_rx_buf
)paren
id|kfree
c_func
(paren
id|info-&gt;tmp_rx_buf
)paren
suffix:semicolon
id|info-&gt;tmp_rx_buf
op_assign
l_int|NULL
suffix:semicolon
)brace
DECL|function|claim_resources
r_int
id|claim_resources
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
(brace
r_if
c_cond
(paren
id|request_mem_region
c_func
(paren
id|info-&gt;phys_memory_base
comma
id|SCA_MEM_SIZE
comma
l_string|&quot;synclinkmp&quot;
)paren
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s mem addr conflict, Addr=%08X&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
comma
id|info-&gt;phys_memory_base
)paren
suffix:semicolon
id|info-&gt;init_error
op_assign
id|DiagStatus_AddressConflict
suffix:semicolon
r_goto
id|errout
suffix:semicolon
)brace
r_else
id|info-&gt;shared_mem_requested
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|request_mem_region
c_func
(paren
id|info-&gt;phys_lcr_base
op_plus
id|info-&gt;lcr_offset
comma
l_int|128
comma
l_string|&quot;synclinkmp&quot;
)paren
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s lcr mem addr conflict, Addr=%08X&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
comma
id|info-&gt;phys_lcr_base
)paren
suffix:semicolon
id|info-&gt;init_error
op_assign
id|DiagStatus_AddressConflict
suffix:semicolon
r_goto
id|errout
suffix:semicolon
)brace
r_else
id|info-&gt;lcr_mem_requested
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|request_mem_region
c_func
(paren
id|info-&gt;phys_sca_base
op_plus
id|info-&gt;sca_offset
comma
id|SCA_BASE_SIZE
comma
l_string|&quot;synclinkmp&quot;
)paren
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s sca mem addr conflict, Addr=%08X&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
comma
id|info-&gt;phys_sca_base
)paren
suffix:semicolon
id|info-&gt;init_error
op_assign
id|DiagStatus_AddressConflict
suffix:semicolon
r_goto
id|errout
suffix:semicolon
)brace
r_else
id|info-&gt;sca_base_requested
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|request_mem_region
c_func
(paren
id|info-&gt;phys_statctrl_base
op_plus
id|info-&gt;statctrl_offset
comma
id|SCA_REG_SIZE
comma
l_string|&quot;synclinkmp&quot;
)paren
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s stat/ctrl mem addr conflict, Addr=%08X&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
comma
id|info-&gt;phys_statctrl_base
)paren
suffix:semicolon
id|info-&gt;init_error
op_assign
id|DiagStatus_AddressConflict
suffix:semicolon
r_goto
id|errout
suffix:semicolon
)brace
r_else
id|info-&gt;sca_statctrl_requested
op_assign
l_int|1
suffix:semicolon
id|info-&gt;memory_base
op_assign
id|ioremap
c_func
(paren
id|info-&gt;phys_memory_base
comma
id|SCA_MEM_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;memory_base
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s Cant map shared memory, MemAddr=%08X&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
comma
id|info-&gt;phys_memory_base
)paren
suffix:semicolon
id|info-&gt;init_error
op_assign
id|DiagStatus_CantAssignPciResources
suffix:semicolon
r_goto
id|errout
suffix:semicolon
)brace
id|info-&gt;lcr_base
op_assign
id|ioremap
c_func
(paren
id|info-&gt;phys_lcr_base
comma
id|PAGE_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;lcr_base
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s Cant map LCR memory, MemAddr=%08X&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
comma
id|info-&gt;phys_lcr_base
)paren
suffix:semicolon
id|info-&gt;init_error
op_assign
id|DiagStatus_CantAssignPciResources
suffix:semicolon
r_goto
id|errout
suffix:semicolon
)brace
id|info-&gt;lcr_base
op_add_assign
id|info-&gt;lcr_offset
suffix:semicolon
id|info-&gt;sca_base
op_assign
id|ioremap
c_func
(paren
id|info-&gt;phys_sca_base
comma
id|PAGE_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;sca_base
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s Cant map SCA memory, MemAddr=%08X&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
comma
id|info-&gt;phys_sca_base
)paren
suffix:semicolon
id|info-&gt;init_error
op_assign
id|DiagStatus_CantAssignPciResources
suffix:semicolon
r_goto
id|errout
suffix:semicolon
)brace
id|info-&gt;sca_base
op_add_assign
id|info-&gt;sca_offset
suffix:semicolon
id|info-&gt;statctrl_base
op_assign
id|ioremap
c_func
(paren
id|info-&gt;phys_statctrl_base
comma
id|PAGE_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;statctrl_base
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s Cant map SCA Status/Control memory, MemAddr=%08X&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
comma
id|info-&gt;phys_statctrl_base
)paren
suffix:semicolon
id|info-&gt;init_error
op_assign
id|DiagStatus_CantAssignPciResources
suffix:semicolon
r_goto
id|errout
suffix:semicolon
)brace
id|info-&gt;statctrl_base
op_add_assign
id|info-&gt;statctrl_offset
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|memory_test
c_func
(paren
id|info
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s(%d):Shared Memory Test failed for device %s MemAddr=%08X&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
comma
id|info-&gt;phys_memory_base
)paren
suffix:semicolon
id|info-&gt;init_error
op_assign
id|DiagStatus_MemoryError
suffix:semicolon
r_goto
id|errout
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
id|errout
suffix:colon
id|release_resources
c_func
(paren
id|info
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
DECL|function|release_resources
r_void
id|release_resources
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
(brace
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s release_resources() entry&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;irq_requested
)paren
(brace
id|free_irq
c_func
(paren
id|info-&gt;irq_level
comma
id|info
)paren
suffix:semicolon
id|info-&gt;irq_requested
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|info-&gt;shared_mem_requested
)paren
(brace
id|release_mem_region
c_func
(paren
id|info-&gt;phys_memory_base
comma
id|SCA_MEM_SIZE
)paren
suffix:semicolon
id|info-&gt;shared_mem_requested
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|info-&gt;lcr_mem_requested
)paren
(brace
id|release_mem_region
c_func
(paren
id|info-&gt;phys_lcr_base
op_plus
id|info-&gt;lcr_offset
comma
l_int|128
)paren
suffix:semicolon
id|info-&gt;lcr_mem_requested
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|info-&gt;sca_base_requested
)paren
(brace
id|release_mem_region
c_func
(paren
id|info-&gt;phys_sca_base
op_plus
id|info-&gt;sca_offset
comma
id|SCA_BASE_SIZE
)paren
suffix:semicolon
id|info-&gt;sca_base_requested
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|info-&gt;sca_statctrl_requested
)paren
(brace
id|release_mem_region
c_func
(paren
id|info-&gt;phys_statctrl_base
op_plus
id|info-&gt;statctrl_offset
comma
id|SCA_REG_SIZE
)paren
suffix:semicolon
id|info-&gt;sca_statctrl_requested
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|info-&gt;memory_base
)paren
(brace
id|iounmap
c_func
(paren
id|info-&gt;memory_base
)paren
suffix:semicolon
id|info-&gt;memory_base
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|info-&gt;sca_base
)paren
(brace
id|iounmap
c_func
(paren
id|info-&gt;sca_base
op_minus
id|info-&gt;sca_offset
)paren
suffix:semicolon
id|info-&gt;sca_base
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|info-&gt;statctrl_base
)paren
(brace
id|iounmap
c_func
(paren
id|info-&gt;statctrl_base
op_minus
id|info-&gt;statctrl_offset
)paren
suffix:semicolon
id|info-&gt;statctrl_base
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|info-&gt;lcr_base
)paren
(brace
id|iounmap
c_func
(paren
id|info-&gt;lcr_base
op_minus
id|info-&gt;lcr_offset
)paren
suffix:semicolon
id|info-&gt;lcr_base
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s release_resources() exit&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
)paren
suffix:semicolon
)brace
multiline_comment|/* Add the specified device instance data structure to the&n; * global linked list of devices and increment the device count.&n; */
DECL|function|add_device
r_void
id|add_device
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
(brace
id|info-&gt;next_device
op_assign
l_int|NULL
suffix:semicolon
id|info-&gt;line
op_assign
id|synclinkmp_device_count
suffix:semicolon
id|sprintf
c_func
(paren
id|info-&gt;device_name
comma
l_string|&quot;ttySLM%dp%d&quot;
comma
id|info-&gt;adapter_num
comma
id|info-&gt;port_num
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;line
OL
id|MAX_DEVICES
)paren
(brace
r_if
c_cond
(paren
id|maxframe
(braket
id|info-&gt;line
)braket
)paren
id|info-&gt;max_frame_size
op_assign
id|maxframe
(braket
id|info-&gt;line
)braket
suffix:semicolon
id|info-&gt;dosyncppp
op_assign
id|dosyncppp
(braket
id|info-&gt;line
)braket
suffix:semicolon
)brace
id|synclinkmp_device_count
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|synclinkmp_device_list
)paren
id|synclinkmp_device_list
op_assign
id|info
suffix:semicolon
r_else
(brace
id|SLMP_INFO
op_star
id|current_dev
op_assign
id|synclinkmp_device_list
suffix:semicolon
r_while
c_loop
(paren
id|current_dev-&gt;next_device
)paren
(brace
id|current_dev
op_assign
id|current_dev-&gt;next_device
suffix:semicolon
)brace
id|current_dev-&gt;next_device
op_assign
id|info
suffix:semicolon
)brace
r_if
c_cond
(paren
id|info-&gt;max_frame_size
OL
l_int|4096
)paren
id|info-&gt;max_frame_size
op_assign
l_int|4096
suffix:semicolon
r_else
r_if
c_cond
(paren
id|info-&gt;max_frame_size
OG
l_int|65535
)paren
id|info-&gt;max_frame_size
op_assign
l_int|65535
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;SyncLink MultiPort %s: &quot;
l_string|&quot;Mem=(%08x %08X %08x %08X) IRQ=%d MaxFrameSize=%u&bslash;n&quot;
comma
id|info-&gt;device_name
comma
id|info-&gt;phys_sca_base
comma
id|info-&gt;phys_memory_base
comma
id|info-&gt;phys_statctrl_base
comma
id|info-&gt;phys_lcr_base
comma
id|info-&gt;irq_level
comma
id|info-&gt;max_frame_size
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_HDLC
id|hdlcdev_init
c_func
(paren
id|info
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/* Allocate and initialize a device instance structure&n; *&n; * Return Value:&t;pointer to SLMP_INFO if success, otherwise NULL&n; */
DECL|function|alloc_dev
id|SLMP_INFO
op_star
id|alloc_dev
c_func
(paren
r_int
id|adapter_num
comma
r_int
id|port_num
comma
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
id|SLMP_INFO
op_star
id|info
suffix:semicolon
id|info
op_assign
(paren
id|SLMP_INFO
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|SLMP_INFO
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s(%d) Error can&squot;t allocate device instance data for adapter %d, port %d&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|adapter_num
comma
id|port_num
)paren
suffix:semicolon
)brace
r_else
(brace
id|memset
c_func
(paren
id|info
comma
l_int|0
comma
r_sizeof
(paren
id|SLMP_INFO
)paren
)paren
suffix:semicolon
id|info-&gt;magic
op_assign
id|MGSL_MAGIC
suffix:semicolon
id|INIT_WORK
c_func
(paren
op_amp
id|info-&gt;task
comma
id|bh_handler
comma
id|info
)paren
suffix:semicolon
id|info-&gt;max_frame_size
op_assign
l_int|4096
suffix:semicolon
id|info-&gt;close_delay
op_assign
l_int|5
op_star
id|HZ
op_div
l_int|10
suffix:semicolon
id|info-&gt;closing_wait
op_assign
l_int|30
op_star
id|HZ
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|info-&gt;open_wait
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|info-&gt;close_wait
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|info-&gt;status_event_wait_q
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|info-&gt;event_wait_q
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|info-&gt;netlock
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|info-&gt;params
comma
op_amp
id|default_params
comma
r_sizeof
(paren
id|MGSL_PARAMS
)paren
)paren
suffix:semicolon
id|info-&gt;idle_mode
op_assign
id|HDLC_TXIDLE_FLAGS
suffix:semicolon
id|info-&gt;adapter_num
op_assign
id|adapter_num
suffix:semicolon
id|info-&gt;port_num
op_assign
id|port_num
suffix:semicolon
multiline_comment|/* Copy configuration info to device instance data */
id|info-&gt;irq_level
op_assign
id|pdev-&gt;irq
suffix:semicolon
id|info-&gt;phys_lcr_base
op_assign
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
suffix:semicolon
id|info-&gt;phys_sca_base
op_assign
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|2
)paren
suffix:semicolon
id|info-&gt;phys_memory_base
op_assign
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|3
)paren
suffix:semicolon
id|info-&gt;phys_statctrl_base
op_assign
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|4
)paren
suffix:semicolon
multiline_comment|/* Because veremap only works on page boundaries we must map&n;&t;&t; * a larger area than is actually implemented for the LCR&n;&t;&t; * memory range. We map a full page starting at the page boundary.&n;&t;&t; */
id|info-&gt;lcr_offset
op_assign
id|info-&gt;phys_lcr_base
op_amp
(paren
id|PAGE_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
id|info-&gt;phys_lcr_base
op_and_assign
op_complement
(paren
id|PAGE_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
id|info-&gt;sca_offset
op_assign
id|info-&gt;phys_sca_base
op_amp
(paren
id|PAGE_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
id|info-&gt;phys_sca_base
op_and_assign
op_complement
(paren
id|PAGE_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
id|info-&gt;statctrl_offset
op_assign
id|info-&gt;phys_statctrl_base
op_amp
(paren
id|PAGE_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
id|info-&gt;phys_statctrl_base
op_and_assign
op_complement
(paren
id|PAGE_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
id|info-&gt;bus_type
op_assign
id|MGSL_BUS_TYPE_PCI
suffix:semicolon
id|info-&gt;irq_flags
op_assign
id|SA_SHIRQ
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|info-&gt;tx_timer
)paren
suffix:semicolon
id|info-&gt;tx_timer.data
op_assign
(paren
r_int
r_int
)paren
id|info
suffix:semicolon
id|info-&gt;tx_timer.function
op_assign
id|tx_timeout
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|info-&gt;status_timer
)paren
suffix:semicolon
id|info-&gt;status_timer.data
op_assign
(paren
r_int
r_int
)paren
id|info
suffix:semicolon
id|info-&gt;status_timer.function
op_assign
id|status_timeout
suffix:semicolon
multiline_comment|/* Store the PCI9050 misc control register value because a flaw&n;&t;&t; * in the PCI9050 prevents LCR registers from being read if&n;&t;&t; * BIOS assigns an LCR base address with bit 7 set.&n;&t;&t; *&n;&t;&t; * Only the misc control register is accessed for which only&n;&t;&t; * write access is needed, so set an initial value and change&n;&t;&t; * bits to the device instance data as we write the value&n;&t;&t; * to the actual misc control register.&n;&t;&t; */
id|info-&gt;misc_ctrl_value
op_assign
l_int|0x087e4546
suffix:semicolon
multiline_comment|/* initial port state is unknown - if startup errors&n;&t;&t; * occur, init_error will be set to indicate the&n;&t;&t; * problem. Once the port is fully initialized,&n;&t;&t; * this value will be set to 0 to indicate the&n;&t;&t; * port is available.&n;&t;&t; */
id|info-&gt;init_error
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
r_return
id|info
suffix:semicolon
)brace
DECL|function|device_init
r_void
id|device_init
c_func
(paren
r_int
id|adapter_num
comma
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
id|SLMP_INFO
op_star
id|port_array
(braket
id|SCA_MAX_PORTS
)braket
suffix:semicolon
r_int
id|port
suffix:semicolon
multiline_comment|/* allocate device instances for up to SCA_MAX_PORTS devices */
r_for
c_loop
(paren
id|port
op_assign
l_int|0
suffix:semicolon
id|port
OL
id|SCA_MAX_PORTS
suffix:semicolon
op_increment
id|port
)paren
(brace
id|port_array
(braket
id|port
)braket
op_assign
id|alloc_dev
c_func
(paren
id|adapter_num
comma
id|port
comma
id|pdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|port_array
(braket
id|port
)braket
op_eq
l_int|NULL
)paren
(brace
r_for
c_loop
(paren
op_decrement
id|port
suffix:semicolon
id|port
op_ge
l_int|0
suffix:semicolon
op_decrement
id|port
)paren
id|kfree
c_func
(paren
id|port_array
(braket
id|port
)braket
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
multiline_comment|/* give copy of port_array to all ports and add to device list  */
r_for
c_loop
(paren
id|port
op_assign
l_int|0
suffix:semicolon
id|port
OL
id|SCA_MAX_PORTS
suffix:semicolon
op_increment
id|port
)paren
(brace
id|memcpy
c_func
(paren
id|port_array
(braket
id|port
)braket
op_member_access_from_pointer
id|port_array
comma
id|port_array
comma
r_sizeof
(paren
id|port_array
)paren
)paren
suffix:semicolon
id|add_device
c_func
(paren
id|port_array
(braket
id|port
)braket
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|port_array
(braket
id|port
)braket
op_member_access_from_pointer
id|lock
)paren
suffix:semicolon
)brace
multiline_comment|/* Allocate and claim adapter resources */
r_if
c_cond
(paren
op_logical_neg
id|claim_resources
c_func
(paren
id|port_array
(braket
l_int|0
)braket
)paren
)paren
(brace
id|alloc_dma_bufs
c_func
(paren
id|port_array
(braket
l_int|0
)braket
)paren
suffix:semicolon
multiline_comment|/* copy resource information from first port to others */
r_for
c_loop
(paren
id|port
op_assign
l_int|1
suffix:semicolon
id|port
OL
id|SCA_MAX_PORTS
suffix:semicolon
op_increment
id|port
)paren
(brace
id|port_array
(braket
id|port
)braket
op_member_access_from_pointer
id|lock
op_assign
id|port_array
(braket
l_int|0
)braket
op_member_access_from_pointer
id|lock
suffix:semicolon
id|port_array
(braket
id|port
)braket
op_member_access_from_pointer
id|irq_level
op_assign
id|port_array
(braket
l_int|0
)braket
op_member_access_from_pointer
id|irq_level
suffix:semicolon
id|port_array
(braket
id|port
)braket
op_member_access_from_pointer
id|memory_base
op_assign
id|port_array
(braket
l_int|0
)braket
op_member_access_from_pointer
id|memory_base
suffix:semicolon
id|port_array
(braket
id|port
)braket
op_member_access_from_pointer
id|sca_base
op_assign
id|port_array
(braket
l_int|0
)braket
op_member_access_from_pointer
id|sca_base
suffix:semicolon
id|port_array
(braket
id|port
)braket
op_member_access_from_pointer
id|statctrl_base
op_assign
id|port_array
(braket
l_int|0
)braket
op_member_access_from_pointer
id|statctrl_base
suffix:semicolon
id|port_array
(braket
id|port
)braket
op_member_access_from_pointer
id|lcr_base
op_assign
id|port_array
(braket
l_int|0
)braket
op_member_access_from_pointer
id|lcr_base
suffix:semicolon
id|alloc_dma_bufs
c_func
(paren
id|port_array
(braket
id|port
)braket
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|port_array
(braket
l_int|0
)braket
op_member_access_from_pointer
id|irq_level
comma
id|synclinkmp_interrupt
comma
id|port_array
(braket
l_int|0
)braket
op_member_access_from_pointer
id|irq_flags
comma
id|port_array
(braket
l_int|0
)braket
op_member_access_from_pointer
id|device_name
comma
id|port_array
(braket
l_int|0
)braket
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s Cant request interrupt, IRQ=%d&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|port_array
(braket
l_int|0
)braket
op_member_access_from_pointer
id|device_name
comma
id|port_array
(braket
l_int|0
)braket
op_member_access_from_pointer
id|irq_level
)paren
suffix:semicolon
)brace
r_else
(brace
id|port_array
(braket
l_int|0
)braket
op_member_access_from_pointer
id|irq_requested
op_assign
l_int|1
suffix:semicolon
id|adapter_test
c_func
(paren
id|port_array
(braket
l_int|0
)braket
)paren
suffix:semicolon
)brace
)brace
)brace
DECL|variable|ops
r_static
r_struct
id|tty_operations
id|ops
op_assign
(brace
dot
id|open
op_assign
id|open
comma
dot
id|close
op_assign
id|close
comma
dot
id|write
op_assign
id|write
comma
dot
id|put_char
op_assign
id|put_char
comma
dot
id|flush_chars
op_assign
id|flush_chars
comma
dot
id|write_room
op_assign
id|write_room
comma
dot
id|chars_in_buffer
op_assign
id|chars_in_buffer
comma
dot
id|flush_buffer
op_assign
id|flush_buffer
comma
dot
id|ioctl
op_assign
id|ioctl
comma
dot
id|throttle
op_assign
id|throttle
comma
dot
id|unthrottle
op_assign
id|unthrottle
comma
dot
id|send_xchar
op_assign
id|send_xchar
comma
dot
id|break_ctl
op_assign
id|set_break
comma
dot
id|wait_until_sent
op_assign
id|wait_until_sent
comma
dot
id|read_proc
op_assign
id|read_proc
comma
dot
id|set_termios
op_assign
id|set_termios
comma
dot
id|stop
op_assign
id|tx_hold
comma
dot
id|start
op_assign
id|tx_release
comma
dot
id|hangup
op_assign
id|hangup
comma
dot
id|tiocmget
op_assign
id|tiocmget
comma
dot
id|tiocmset
op_assign
id|tiocmset
comma
)brace
suffix:semicolon
DECL|function|synclinkmp_cleanup
r_static
r_void
id|synclinkmp_cleanup
c_func
(paren
r_void
)paren
(brace
r_int
id|rc
suffix:semicolon
id|SLMP_INFO
op_star
id|info
suffix:semicolon
id|SLMP_INFO
op_star
id|tmp
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Unloading %s %s&bslash;n&quot;
comma
id|driver_name
comma
id|driver_version
)paren
suffix:semicolon
r_if
c_cond
(paren
id|serial_driver
)paren
(brace
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|tty_unregister_driver
c_func
(paren
id|serial_driver
)paren
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d) failed to unregister tty driver err=%d&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|rc
)paren
suffix:semicolon
id|put_tty_driver
c_func
(paren
id|serial_driver
)paren
suffix:semicolon
)brace
multiline_comment|/* reset devices */
id|info
op_assign
id|synclinkmp_device_list
suffix:semicolon
r_while
c_loop
(paren
id|info
)paren
(brace
id|reset_port
c_func
(paren
id|info
)paren
suffix:semicolon
id|info
op_assign
id|info-&gt;next_device
suffix:semicolon
)brace
multiline_comment|/* release devices */
id|info
op_assign
id|synclinkmp_device_list
suffix:semicolon
r_while
c_loop
(paren
id|info
)paren
(brace
macro_line|#ifdef CONFIG_HDLC
id|hdlcdev_exit
c_func
(paren
id|info
)paren
suffix:semicolon
macro_line|#endif
id|free_dma_bufs
c_func
(paren
id|info
)paren
suffix:semicolon
id|free_tmp_rx_buf
c_func
(paren
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;port_num
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;sca_base
)paren
id|write_reg
c_func
(paren
id|info
comma
id|LPR
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* set low power mode */
id|release_resources
c_func
(paren
id|info
)paren
suffix:semicolon
)brace
id|tmp
op_assign
id|info
suffix:semicolon
id|info
op_assign
id|info-&gt;next_device
suffix:semicolon
id|kfree
c_func
(paren
id|tmp
)paren
suffix:semicolon
)brace
id|pci_unregister_driver
c_func
(paren
op_amp
id|synclinkmp_pci_driver
)paren
suffix:semicolon
)brace
multiline_comment|/* Driver initialization entry point.&n; */
DECL|function|synclinkmp_init
r_static
r_int
id|__init
id|synclinkmp_init
c_func
(paren
r_void
)paren
(brace
r_int
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|break_on_load
)paren
(brace
id|synclinkmp_get_text_ptr
c_func
(paren
)paren
suffix:semicolon
id|BREAKPOINT
c_func
(paren
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;%s %s&bslash;n&quot;
comma
id|driver_name
comma
id|driver_version
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|pci_register_driver
c_func
(paren
op_amp
id|synclinkmp_pci_driver
)paren
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s:failed to register PCI driver, error=%d&bslash;n&quot;
comma
id|__FILE__
comma
id|rc
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|serial_driver
op_assign
id|alloc_tty_driver
c_func
(paren
l_int|128
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|serial_driver
)paren
(brace
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
multiline_comment|/* Initialize the tty_driver structure */
id|serial_driver-&gt;owner
op_assign
id|THIS_MODULE
suffix:semicolon
id|serial_driver-&gt;driver_name
op_assign
l_string|&quot;synclinkmp&quot;
suffix:semicolon
id|serial_driver-&gt;name
op_assign
l_string|&quot;ttySLM&quot;
suffix:semicolon
id|serial_driver-&gt;major
op_assign
id|ttymajor
suffix:semicolon
id|serial_driver-&gt;minor_start
op_assign
l_int|64
suffix:semicolon
id|serial_driver-&gt;type
op_assign
id|TTY_DRIVER_TYPE_SERIAL
suffix:semicolon
id|serial_driver-&gt;subtype
op_assign
id|SERIAL_TYPE_NORMAL
suffix:semicolon
id|serial_driver-&gt;init_termios
op_assign
id|tty_std_termios
suffix:semicolon
id|serial_driver-&gt;init_termios.c_cflag
op_assign
id|B9600
op_or
id|CS8
op_or
id|CREAD
op_or
id|HUPCL
op_or
id|CLOCAL
suffix:semicolon
id|serial_driver-&gt;flags
op_assign
id|TTY_DRIVER_REAL_RAW
suffix:semicolon
id|tty_set_operations
c_func
(paren
id|serial_driver
comma
op_amp
id|ops
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|tty_register_driver
c_func
(paren
id|serial_driver
)paren
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s(%d):Couldn&squot;t register serial driver&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
)paren
suffix:semicolon
id|put_tty_driver
c_func
(paren
id|serial_driver
)paren
suffix:semicolon
id|serial_driver
op_assign
l_int|NULL
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;%s %s, tty major#%d&bslash;n&quot;
comma
id|driver_name
comma
id|driver_version
comma
id|serial_driver-&gt;major
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|error
suffix:colon
id|synclinkmp_cleanup
c_func
(paren
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|synclinkmp_exit
r_static
r_void
id|__exit
id|synclinkmp_exit
c_func
(paren
r_void
)paren
(brace
id|synclinkmp_cleanup
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|variable|synclinkmp_init
id|module_init
c_func
(paren
id|synclinkmp_init
)paren
suffix:semicolon
DECL|variable|synclinkmp_exit
id|module_exit
c_func
(paren
id|synclinkmp_exit
)paren
suffix:semicolon
multiline_comment|/* Set the port for internal loopback mode.&n; * The TxCLK and RxCLK signals are generated from the BRG and&n; * the TxD is looped back to the RxD internally.&n; */
DECL|function|enable_loopback
r_void
id|enable_loopback
c_func
(paren
id|SLMP_INFO
op_star
id|info
comma
r_int
id|enable
)paren
(brace
r_if
c_cond
(paren
id|enable
)paren
(brace
multiline_comment|/* MD2 (Mode Register 2)&n;&t;&t; * 01..00  CNCT&lt;1..0&gt; Channel Connection 11=Local Loopback&n;&t;&t; */
id|write_reg
c_func
(paren
id|info
comma
id|MD2
comma
(paren
r_int
r_char
)paren
(paren
id|read_reg
c_func
(paren
id|info
comma
id|MD2
)paren
op_or
(paren
id|BIT1
op_plus
id|BIT0
)paren
)paren
)paren
suffix:semicolon
multiline_comment|/* degate external TxC clock source */
id|info-&gt;port_array
(braket
l_int|0
)braket
op_member_access_from_pointer
id|ctrlreg_value
op_or_assign
(paren
id|BIT0
op_lshift
(paren
id|info-&gt;port_num
op_star
l_int|2
)paren
)paren
suffix:semicolon
id|write_control_reg
c_func
(paren
id|info
)paren
suffix:semicolon
multiline_comment|/* RXS/TXS (Rx/Tx clock source)&n;&t;&t; * 07      Reserved, must be 0&n;&t;&t; * 06..04  Clock Source, 100=BRG&n;&t;&t; * 03..00  Clock Divisor, 0000=1&n;&t;&t; */
id|write_reg
c_func
(paren
id|info
comma
id|RXS
comma
l_int|0x40
)paren
suffix:semicolon
id|write_reg
c_func
(paren
id|info
comma
id|TXS
comma
l_int|0x40
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* MD2 (Mode Register 2)&n;&t; &t; * 01..00  CNCT&lt;1..0&gt; Channel connection, 0=normal&n;&t;&t; */
id|write_reg
c_func
(paren
id|info
comma
id|MD2
comma
(paren
r_int
r_char
)paren
(paren
id|read_reg
c_func
(paren
id|info
comma
id|MD2
)paren
op_amp
op_complement
(paren
id|BIT1
op_plus
id|BIT0
)paren
)paren
)paren
suffix:semicolon
multiline_comment|/* RXS/TXS (Rx/Tx clock source)&n;&t;&t; * 07      Reserved, must be 0&n;&t;&t; * 06..04  Clock Source, 000=RxC/TxC Pin&n;&t;&t; * 03..00  Clock Divisor, 0000=1&n;&t;&t; */
id|write_reg
c_func
(paren
id|info
comma
id|RXS
comma
l_int|0x00
)paren
suffix:semicolon
id|write_reg
c_func
(paren
id|info
comma
id|TXS
comma
l_int|0x00
)paren
suffix:semicolon
)brace
multiline_comment|/* set LinkSpeed if available, otherwise default to 2Mbps */
r_if
c_cond
(paren
id|info-&gt;params.clock_speed
)paren
id|set_rate
c_func
(paren
id|info
comma
id|info-&gt;params.clock_speed
)paren
suffix:semicolon
r_else
id|set_rate
c_func
(paren
id|info
comma
l_int|3686400
)paren
suffix:semicolon
)brace
multiline_comment|/* Set the baud rate register to the desired speed&n; *&n; *&t;data_rate&t;data rate of clock in bits per second&n; *&t;&t;&t;A data rate of 0 disables the AUX clock.&n; */
DECL|function|set_rate
r_void
id|set_rate
c_func
(paren
id|SLMP_INFO
op_star
id|info
comma
id|u32
id|data_rate
)paren
(brace
id|u32
id|TMCValue
suffix:semicolon
r_int
r_char
id|BRValue
suffix:semicolon
id|u32
id|Divisor
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* fBRG = fCLK/(TMC * 2^BR)&n;&t; */
r_if
c_cond
(paren
id|data_rate
op_ne
l_int|0
)paren
(brace
id|Divisor
op_assign
l_int|14745600
op_div
id|data_rate
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|Divisor
)paren
id|Divisor
op_assign
l_int|1
suffix:semicolon
id|TMCValue
op_assign
id|Divisor
suffix:semicolon
id|BRValue
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|TMCValue
op_ne
l_int|1
op_logical_and
id|TMCValue
op_ne
l_int|2
)paren
(brace
multiline_comment|/* BRValue of 0 provides 50/50 duty cycle *only* when&n;&t;&t;&t; * TMCValue is 1 or 2. BRValue of 1 to 9 always provides&n;&t;&t;&t; * 50/50 duty cycle.&n;&t;&t;&t; */
id|BRValue
op_assign
l_int|1
suffix:semicolon
id|TMCValue
op_rshift_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* while TMCValue is too big for TMC register, divide&n;&t;&t; * by 2 and increment BR exponent.&n;&t;&t; */
r_for
c_loop
(paren
suffix:semicolon
id|TMCValue
OG
l_int|256
op_logical_and
id|BRValue
OL
l_int|10
suffix:semicolon
id|BRValue
op_increment
)paren
(brace
id|TMCValue
op_rshift_assign
l_int|1
suffix:semicolon
)brace
id|write_reg
c_func
(paren
id|info
comma
id|TXS
comma
(paren
r_int
r_char
)paren
(paren
(paren
id|read_reg
c_func
(paren
id|info
comma
id|TXS
)paren
op_amp
l_int|0xf0
)paren
op_or
id|BRValue
)paren
)paren
suffix:semicolon
id|write_reg
c_func
(paren
id|info
comma
id|RXS
comma
(paren
r_int
r_char
)paren
(paren
(paren
id|read_reg
c_func
(paren
id|info
comma
id|RXS
)paren
op_amp
l_int|0xf0
)paren
op_or
id|BRValue
)paren
)paren
suffix:semicolon
id|write_reg
c_func
(paren
id|info
comma
id|TMC
comma
(paren
r_int
r_char
)paren
id|TMCValue
)paren
suffix:semicolon
)brace
r_else
(brace
id|write_reg
c_func
(paren
id|info
comma
id|TXS
comma
l_int|0
)paren
suffix:semicolon
id|write_reg
c_func
(paren
id|info
comma
id|RXS
comma
l_int|0
)paren
suffix:semicolon
id|write_reg
c_func
(paren
id|info
comma
id|TMC
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Disable receiver&n; */
DECL|function|rx_stop
r_void
id|rx_stop
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
(brace
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_ISR
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s rx_stop()&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
)paren
suffix:semicolon
id|write_reg
c_func
(paren
id|info
comma
id|CMD
comma
id|RXRESET
)paren
suffix:semicolon
id|info-&gt;ie0_value
op_and_assign
op_complement
id|RXRDYE
suffix:semicolon
id|write_reg
c_func
(paren
id|info
comma
id|IE0
comma
id|info-&gt;ie0_value
)paren
suffix:semicolon
multiline_comment|/* disable Rx data interrupts */
id|write_reg
c_func
(paren
id|info
comma
id|RXDMA
op_plus
id|DSR
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* disable Rx DMA */
id|write_reg
c_func
(paren
id|info
comma
id|RXDMA
op_plus
id|DCMD
comma
id|SWABORT
)paren
suffix:semicolon
multiline_comment|/* reset/init Rx DMA */
id|write_reg
c_func
(paren
id|info
comma
id|RXDMA
op_plus
id|DIR
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* disable Rx DMA interrupts */
id|info-&gt;rx_enabled
op_assign
l_int|0
suffix:semicolon
id|info-&gt;rx_overflow
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* enable the receiver&n; */
DECL|function|rx_start
r_void
id|rx_start
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_ISR
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s rx_start()&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
)paren
suffix:semicolon
id|write_reg
c_func
(paren
id|info
comma
id|CMD
comma
id|RXRESET
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;params.mode
op_eq
id|MGSL_MODE_HDLC
)paren
(brace
multiline_comment|/* HDLC, disabe IRQ on rxdata */
id|info-&gt;ie0_value
op_and_assign
op_complement
id|RXRDYE
suffix:semicolon
id|write_reg
c_func
(paren
id|info
comma
id|IE0
comma
id|info-&gt;ie0_value
)paren
suffix:semicolon
multiline_comment|/* Reset all Rx DMA buffers and program rx dma */
id|write_reg
c_func
(paren
id|info
comma
id|RXDMA
op_plus
id|DSR
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* disable Rx DMA */
id|write_reg
c_func
(paren
id|info
comma
id|RXDMA
op_plus
id|DCMD
comma
id|SWABORT
)paren
suffix:semicolon
multiline_comment|/* reset/init Rx DMA */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|info-&gt;rx_buf_count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|info-&gt;rx_buf_list
(braket
id|i
)braket
dot
id|status
op_assign
l_int|0xff
suffix:semicolon
singleline_comment|// throttle to 4 shared memory writes at a time to prevent
singleline_comment|// hogging local bus (keep latency time for DMA requests low).
r_if
c_cond
(paren
op_logical_neg
(paren
id|i
op_mod
l_int|4
)paren
)paren
id|read_status_reg
c_func
(paren
id|info
)paren
suffix:semicolon
)brace
id|info-&gt;current_rx_buf
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* set current/1st descriptor address */
id|write_reg16
c_func
(paren
id|info
comma
id|RXDMA
op_plus
id|CDA
comma
id|info-&gt;rx_buf_list_ex
(braket
l_int|0
)braket
dot
id|phys_entry
)paren
suffix:semicolon
multiline_comment|/* set new last rx descriptor address */
id|write_reg16
c_func
(paren
id|info
comma
id|RXDMA
op_plus
id|EDA
comma
id|info-&gt;rx_buf_list_ex
(braket
id|info-&gt;rx_buf_count
op_minus
l_int|1
)braket
dot
id|phys_entry
)paren
suffix:semicolon
multiline_comment|/* set buffer length (shared by all rx dma data buffers) */
id|write_reg16
c_func
(paren
id|info
comma
id|RXDMA
op_plus
id|BFL
comma
id|SCABUFSIZE
)paren
suffix:semicolon
id|write_reg
c_func
(paren
id|info
comma
id|RXDMA
op_plus
id|DIR
comma
l_int|0x60
)paren
suffix:semicolon
multiline_comment|/* enable Rx DMA interrupts (EOM/BOF) */
id|write_reg
c_func
(paren
id|info
comma
id|RXDMA
op_plus
id|DSR
comma
l_int|0xf2
)paren
suffix:semicolon
multiline_comment|/* clear Rx DMA IRQs, enable Rx DMA */
)brace
r_else
(brace
multiline_comment|/* async, enable IRQ on rxdata */
id|info-&gt;ie0_value
op_or_assign
id|RXRDYE
suffix:semicolon
id|write_reg
c_func
(paren
id|info
comma
id|IE0
comma
id|info-&gt;ie0_value
)paren
suffix:semicolon
)brace
id|write_reg
c_func
(paren
id|info
comma
id|CMD
comma
id|RXENABLE
)paren
suffix:semicolon
id|info-&gt;rx_overflow
op_assign
id|FALSE
suffix:semicolon
id|info-&gt;rx_enabled
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Enable the transmitter and send a transmit frame if&n; * one is loaded in the DMA buffers.&n; */
DECL|function|tx_start
r_void
id|tx_start
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
(brace
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_ISR
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s tx_start() tx_count=%d&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
comma
id|info-&gt;tx_count
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;tx_enabled
)paren
(brace
id|write_reg
c_func
(paren
id|info
comma
id|CMD
comma
id|TXRESET
)paren
suffix:semicolon
id|write_reg
c_func
(paren
id|info
comma
id|CMD
comma
id|TXENABLE
)paren
suffix:semicolon
id|info-&gt;tx_enabled
op_assign
id|TRUE
suffix:semicolon
)brace
r_if
c_cond
(paren
id|info-&gt;tx_count
)paren
(brace
multiline_comment|/* If auto RTS enabled and RTS is inactive, then assert */
multiline_comment|/* RTS and set a flag indicating that the driver should */
multiline_comment|/* negate RTS when the transmission completes. */
id|info-&gt;drop_rts_on_tx_done
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;params.mode
op_ne
id|MGSL_MODE_ASYNC
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;params.flags
op_amp
id|HDLC_FLAG_AUTO_RTS
)paren
(brace
id|get_signals
c_func
(paren
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|info-&gt;serial_signals
op_amp
id|SerialSignal_RTS
)paren
)paren
(brace
id|info-&gt;serial_signals
op_or_assign
id|SerialSignal_RTS
suffix:semicolon
id|set_signals
c_func
(paren
id|info
)paren
suffix:semicolon
id|info-&gt;drop_rts_on_tx_done
op_assign
l_int|1
suffix:semicolon
)brace
)brace
id|write_reg16
c_func
(paren
id|info
comma
id|TRC0
comma
(paren
r_int
r_int
)paren
(paren
(paren
(paren
id|tx_negate_fifo_level
op_minus
l_int|1
)paren
op_lshift
l_int|8
)paren
op_plus
id|tx_active_fifo_level
)paren
)paren
suffix:semicolon
id|write_reg
c_func
(paren
id|info
comma
id|TXDMA
op_plus
id|DSR
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* disable DMA channel */
id|write_reg
c_func
(paren
id|info
comma
id|TXDMA
op_plus
id|DCMD
comma
id|SWABORT
)paren
suffix:semicolon
multiline_comment|/* reset/init DMA channel */
multiline_comment|/* set TX CDA (current descriptor address) */
id|write_reg16
c_func
(paren
id|info
comma
id|TXDMA
op_plus
id|CDA
comma
id|info-&gt;tx_buf_list_ex
(braket
l_int|0
)braket
dot
id|phys_entry
)paren
suffix:semicolon
multiline_comment|/* set TX EDA (last descriptor address) */
id|write_reg16
c_func
(paren
id|info
comma
id|TXDMA
op_plus
id|EDA
comma
id|info-&gt;tx_buf_list_ex
(braket
id|info-&gt;last_tx_buf
)braket
dot
id|phys_entry
)paren
suffix:semicolon
multiline_comment|/* enable underrun IRQ */
id|info-&gt;ie1_value
op_and_assign
op_complement
id|IDLE
suffix:semicolon
id|info-&gt;ie1_value
op_or_assign
id|UDRN
suffix:semicolon
id|write_reg
c_func
(paren
id|info
comma
id|IE1
comma
id|info-&gt;ie1_value
)paren
suffix:semicolon
id|write_reg
c_func
(paren
id|info
comma
id|SR1
comma
(paren
r_int
r_char
)paren
(paren
id|IDLE
op_plus
id|UDRN
)paren
)paren
suffix:semicolon
id|write_reg
c_func
(paren
id|info
comma
id|TXDMA
op_plus
id|DIR
comma
l_int|0x40
)paren
suffix:semicolon
multiline_comment|/* enable Tx DMA interrupts (EOM) */
id|write_reg
c_func
(paren
id|info
comma
id|TXDMA
op_plus
id|DSR
comma
l_int|0xf2
)paren
suffix:semicolon
multiline_comment|/* clear Tx DMA IRQs, enable Tx DMA */
id|info-&gt;tx_timer.expires
op_assign
id|jiffies
op_plus
id|msecs_to_jiffies
c_func
(paren
l_int|5000
)paren
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|info-&gt;tx_timer
)paren
suffix:semicolon
)brace
r_else
(brace
id|tx_load_fifo
c_func
(paren
id|info
)paren
suffix:semicolon
multiline_comment|/* async, enable IRQ on txdata */
id|info-&gt;ie0_value
op_or_assign
id|TXRDYE
suffix:semicolon
id|write_reg
c_func
(paren
id|info
comma
id|IE0
comma
id|info-&gt;ie0_value
)paren
suffix:semicolon
)brace
id|info-&gt;tx_active
op_assign
l_int|1
suffix:semicolon
)brace
)brace
multiline_comment|/* stop the transmitter and DMA&n; */
DECL|function|tx_stop
r_void
id|tx_stop
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
(brace
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_ISR
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s tx_stop()&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|info-&gt;tx_timer
)paren
suffix:semicolon
id|write_reg
c_func
(paren
id|info
comma
id|TXDMA
op_plus
id|DSR
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* disable DMA channel */
id|write_reg
c_func
(paren
id|info
comma
id|TXDMA
op_plus
id|DCMD
comma
id|SWABORT
)paren
suffix:semicolon
multiline_comment|/* reset/init DMA channel */
id|write_reg
c_func
(paren
id|info
comma
id|CMD
comma
id|TXRESET
)paren
suffix:semicolon
id|info-&gt;ie1_value
op_and_assign
op_complement
(paren
id|UDRN
op_plus
id|IDLE
)paren
suffix:semicolon
id|write_reg
c_func
(paren
id|info
comma
id|IE1
comma
id|info-&gt;ie1_value
)paren
suffix:semicolon
multiline_comment|/* disable tx status interrupts */
id|write_reg
c_func
(paren
id|info
comma
id|SR1
comma
(paren
r_int
r_char
)paren
(paren
id|IDLE
op_plus
id|UDRN
)paren
)paren
suffix:semicolon
multiline_comment|/* clear pending */
id|info-&gt;ie0_value
op_and_assign
op_complement
id|TXRDYE
suffix:semicolon
id|write_reg
c_func
(paren
id|info
comma
id|IE0
comma
id|info-&gt;ie0_value
)paren
suffix:semicolon
multiline_comment|/* disable tx data interrupts */
id|info-&gt;tx_enabled
op_assign
l_int|0
suffix:semicolon
id|info-&gt;tx_active
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Fill the transmit FIFO until the FIFO is full or&n; * there is no more data to load.&n; */
DECL|function|tx_load_fifo
r_void
id|tx_load_fifo
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
(brace
id|u8
id|TwoBytes
(braket
l_int|2
)braket
suffix:semicolon
multiline_comment|/* do nothing is now tx data available and no XON/XOFF pending */
r_if
c_cond
(paren
op_logical_neg
id|info-&gt;tx_count
op_logical_and
op_logical_neg
id|info-&gt;x_char
)paren
r_return
suffix:semicolon
multiline_comment|/* load the Transmit FIFO until FIFOs full or all data sent */
r_while
c_loop
(paren
id|info-&gt;tx_count
op_logical_and
(paren
id|read_reg
c_func
(paren
id|info
comma
id|SR0
)paren
op_amp
id|BIT1
)paren
)paren
(brace
multiline_comment|/* there is more space in the transmit FIFO and */
multiline_comment|/* there is more data in transmit buffer */
r_if
c_cond
(paren
(paren
id|info-&gt;tx_count
OG
l_int|1
)paren
op_logical_and
op_logical_neg
id|info-&gt;x_char
)paren
(brace
multiline_comment|/* write 16-bits */
id|TwoBytes
(braket
l_int|0
)braket
op_assign
id|info-&gt;tx_buf
(braket
id|info-&gt;tx_get
op_increment
)braket
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;tx_get
op_ge
id|info-&gt;max_frame_size
)paren
id|info-&gt;tx_get
op_sub_assign
id|info-&gt;max_frame_size
suffix:semicolon
id|TwoBytes
(braket
l_int|1
)braket
op_assign
id|info-&gt;tx_buf
(braket
id|info-&gt;tx_get
op_increment
)braket
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;tx_get
op_ge
id|info-&gt;max_frame_size
)paren
id|info-&gt;tx_get
op_sub_assign
id|info-&gt;max_frame_size
suffix:semicolon
id|write_reg16
c_func
(paren
id|info
comma
id|TRB
comma
op_star
(paren
(paren
id|u16
op_star
)paren
id|TwoBytes
)paren
)paren
suffix:semicolon
id|info-&gt;tx_count
op_sub_assign
l_int|2
suffix:semicolon
id|info-&gt;icount.tx
op_add_assign
l_int|2
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* only 1 byte left to transmit or 1 FIFO slot left */
r_if
c_cond
(paren
id|info-&gt;x_char
)paren
(brace
multiline_comment|/* transmit pending high priority char */
id|write_reg
c_func
(paren
id|info
comma
id|TRB
comma
id|info-&gt;x_char
)paren
suffix:semicolon
id|info-&gt;x_char
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|write_reg
c_func
(paren
id|info
comma
id|TRB
comma
id|info-&gt;tx_buf
(braket
id|info-&gt;tx_get
op_increment
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;tx_get
op_ge
id|info-&gt;max_frame_size
)paren
id|info-&gt;tx_get
op_sub_assign
id|info-&gt;max_frame_size
suffix:semicolon
id|info-&gt;tx_count
op_decrement
suffix:semicolon
)brace
id|info-&gt;icount.tx
op_increment
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* Reset a port to a known state&n; */
DECL|function|reset_port
r_void
id|reset_port
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;sca_base
)paren
(brace
id|tx_stop
c_func
(paren
id|info
)paren
suffix:semicolon
id|rx_stop
c_func
(paren
id|info
)paren
suffix:semicolon
id|info-&gt;serial_signals
op_and_assign
op_complement
(paren
id|SerialSignal_DTR
op_plus
id|SerialSignal_RTS
)paren
suffix:semicolon
id|set_signals
c_func
(paren
id|info
)paren
suffix:semicolon
multiline_comment|/* disable all port interrupts */
id|info-&gt;ie0_value
op_assign
l_int|0
suffix:semicolon
id|info-&gt;ie1_value
op_assign
l_int|0
suffix:semicolon
id|info-&gt;ie2_value
op_assign
l_int|0
suffix:semicolon
id|write_reg
c_func
(paren
id|info
comma
id|IE0
comma
id|info-&gt;ie0_value
)paren
suffix:semicolon
id|write_reg
c_func
(paren
id|info
comma
id|IE1
comma
id|info-&gt;ie1_value
)paren
suffix:semicolon
id|write_reg
c_func
(paren
id|info
comma
id|IE2
comma
id|info-&gt;ie2_value
)paren
suffix:semicolon
id|write_reg
c_func
(paren
id|info
comma
id|CMD
comma
id|CHRESET
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Reset all the ports to a known state.&n; */
DECL|function|reset_adapter
r_void
id|reset_adapter
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|SCA_MAX_PORTS
suffix:semicolon
op_increment
id|i
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;port_array
(braket
id|i
)braket
)paren
id|reset_port
c_func
(paren
id|info-&gt;port_array
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Program port for asynchronous communications.&n; */
DECL|function|async_mode
r_void
id|async_mode
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
(brace
r_int
r_char
id|RegValue
suffix:semicolon
id|tx_stop
c_func
(paren
id|info
)paren
suffix:semicolon
id|rx_stop
c_func
(paren
id|info
)paren
suffix:semicolon
multiline_comment|/* MD0, Mode Register 0&n;&t; *&n;&t; * 07..05  PRCTL&lt;2..0&gt;, Protocol Mode, 000=async&n;&t; * 04      AUTO, Auto-enable (RTS/CTS/DCD)&n;&t; * 03      Reserved, must be 0&n;&t; * 02      CRCCC, CRC Calculation, 0=disabled&n;&t; * 01..00  STOP&lt;1..0&gt; Stop bits (00=1,10=2)&n;&t; *&n;&t; * 0000 0000&n;&t; */
id|RegValue
op_assign
l_int|0x00
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;params.stop_bits
op_ne
l_int|1
)paren
id|RegValue
op_or_assign
id|BIT1
suffix:semicolon
id|write_reg
c_func
(paren
id|info
comma
id|MD0
comma
id|RegValue
)paren
suffix:semicolon
multiline_comment|/* MD1, Mode Register 1&n;&t; *&n;&t; * 07..06  BRATE&lt;1..0&gt;, bit rate, 00=1/1 01=1/16 10=1/32 11=1/64&n;&t; * 05..04  TXCHR&lt;1..0&gt;, tx char size, 00=8 bits,01=7,10=6,11=5&n;&t; * 03..02  RXCHR&lt;1..0&gt;, rx char size&n;&t; * 01..00  PMPM&lt;1..0&gt;, Parity mode, 00=none 10=even 11=odd&n;&t; *&n;&t; * 0100 0000&n;&t; */
id|RegValue
op_assign
l_int|0x40
suffix:semicolon
r_switch
c_cond
(paren
id|info-&gt;params.data_bits
)paren
(brace
r_case
l_int|7
suffix:colon
id|RegValue
op_or_assign
id|BIT4
op_plus
id|BIT2
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|6
suffix:colon
id|RegValue
op_or_assign
id|BIT5
op_plus
id|BIT3
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|5
suffix:colon
id|RegValue
op_or_assign
id|BIT5
op_plus
id|BIT4
op_plus
id|BIT3
op_plus
id|BIT2
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|info-&gt;params.parity
op_ne
id|ASYNC_PARITY_NONE
)paren
(brace
id|RegValue
op_or_assign
id|BIT1
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;params.parity
op_eq
id|ASYNC_PARITY_ODD
)paren
id|RegValue
op_or_assign
id|BIT0
suffix:semicolon
)brace
id|write_reg
c_func
(paren
id|info
comma
id|MD1
comma
id|RegValue
)paren
suffix:semicolon
multiline_comment|/* MD2, Mode Register 2&n;&t; *&n;&t; * 07..02  Reserved, must be 0&n;&t; * 01..00  CNCT&lt;1..0&gt; Channel connection, 0=normal&n;&t; *&n;&t; * 0000 0000&n;&t; */
id|RegValue
op_assign
l_int|0x00
suffix:semicolon
id|write_reg
c_func
(paren
id|info
comma
id|MD2
comma
id|RegValue
)paren
suffix:semicolon
multiline_comment|/* RXS, Receive clock source&n;&t; *&n;&t; * 07      Reserved, must be 0&n;&t; * 06..04  RXCS&lt;2..0&gt;, clock source, 000=RxC Pin, 100=BRG, 110=DPLL&n;&t; * 03..00  RXBR&lt;3..0&gt;, rate divisor, 0000=1&n;&t; */
id|RegValue
op_assign
id|BIT6
suffix:semicolon
id|write_reg
c_func
(paren
id|info
comma
id|RXS
comma
id|RegValue
)paren
suffix:semicolon
multiline_comment|/* TXS, Transmit clock source&n;&t; *&n;&t; * 07      Reserved, must be 0&n;&t; * 06..04  RXCS&lt;2..0&gt;, clock source, 000=TxC Pin, 100=BRG, 110=Receive Clock&n;&t; * 03..00  RXBR&lt;3..0&gt;, rate divisor, 0000=1&n;&t; */
id|RegValue
op_assign
id|BIT6
suffix:semicolon
id|write_reg
c_func
(paren
id|info
comma
id|TXS
comma
id|RegValue
)paren
suffix:semicolon
multiline_comment|/* Control Register&n;&t; *&n;&t; * 6,4,2,0  CLKSEL&lt;3..0&gt;, 0 = TcCLK in, 1 = Auxclk out&n;&t; */
id|info-&gt;port_array
(braket
l_int|0
)braket
op_member_access_from_pointer
id|ctrlreg_value
op_or_assign
(paren
id|BIT0
op_lshift
(paren
id|info-&gt;port_num
op_star
l_int|2
)paren
)paren
suffix:semicolon
id|write_control_reg
c_func
(paren
id|info
)paren
suffix:semicolon
id|tx_set_idle
c_func
(paren
id|info
)paren
suffix:semicolon
multiline_comment|/* RRC Receive Ready Control 0&n;&t; *&n;&t; * 07..05  Reserved, must be 0&n;&t; * 04..00  RRC&lt;4..0&gt; Rx FIFO trigger active 0x00 = 1 byte&n;&t; */
id|write_reg
c_func
(paren
id|info
comma
id|TRC0
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* TRC0 Transmit Ready Control 0&n;&t; *&n;&t; * 07..05  Reserved, must be 0&n;&t; * 04..00  TRC&lt;4..0&gt; Tx FIFO trigger active 0x10 = 16 bytes&n;&t; */
id|write_reg
c_func
(paren
id|info
comma
id|TRC0
comma
l_int|0x10
)paren
suffix:semicolon
multiline_comment|/* TRC1 Transmit Ready Control 1&n;&t; *&n;&t; * 07..05  Reserved, must be 0&n;&t; * 04..00  TRC&lt;4..0&gt; Tx FIFO trigger inactive 0x1e = 31 bytes (full-1)&n;&t; */
id|write_reg
c_func
(paren
id|info
comma
id|TRC1
comma
l_int|0x1e
)paren
suffix:semicolon
multiline_comment|/* CTL, MSCI control register&n;&t; *&n;&t; * 07..06  Reserved, set to 0&n;&t; * 05      UDRNC, underrun control, 0=abort 1=CRC+flag (HDLC/BSC)&n;&t; * 04      IDLC, idle control, 0=mark 1=idle register&n;&t; * 03      BRK, break, 0=off 1 =on (async)&n;&t; * 02      SYNCLD, sync char load enable (BSC) 1=enabled&n;&t; * 01      GOP, go active on poll (LOOP mode) 1=enabled&n;&t; * 00      RTS, RTS output control, 0=active 1=inactive&n;&t; *&n;&t; * 0001 0001&n;&t; */
id|RegValue
op_assign
l_int|0x10
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|info-&gt;serial_signals
op_amp
id|SerialSignal_RTS
)paren
)paren
id|RegValue
op_or_assign
l_int|0x01
suffix:semicolon
id|write_reg
c_func
(paren
id|info
comma
id|CTL
comma
id|RegValue
)paren
suffix:semicolon
multiline_comment|/* enable status interrupts */
id|info-&gt;ie0_value
op_or_assign
id|TXINTE
op_plus
id|RXINTE
suffix:semicolon
id|write_reg
c_func
(paren
id|info
comma
id|IE0
comma
id|info-&gt;ie0_value
)paren
suffix:semicolon
multiline_comment|/* enable break detect interrupt */
id|info-&gt;ie1_value
op_assign
id|BRKD
suffix:semicolon
id|write_reg
c_func
(paren
id|info
comma
id|IE1
comma
id|info-&gt;ie1_value
)paren
suffix:semicolon
multiline_comment|/* enable rx overrun interrupt */
id|info-&gt;ie2_value
op_assign
id|OVRN
suffix:semicolon
id|write_reg
c_func
(paren
id|info
comma
id|IE2
comma
id|info-&gt;ie2_value
)paren
suffix:semicolon
id|set_rate
c_func
(paren
id|info
comma
id|info-&gt;params.data_rate
op_star
l_int|16
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;params.loopback
)paren
id|enable_loopback
c_func
(paren
id|info
comma
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/* Program the SCA for HDLC communications.&n; */
DECL|function|hdlc_mode
r_void
id|hdlc_mode
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
(brace
r_int
r_char
id|RegValue
suffix:semicolon
id|u32
id|DpllDivisor
suffix:semicolon
singleline_comment|// Can&squot;t use DPLL because SCA outputs recovered clock on RxC when
singleline_comment|// DPLL mode selected. This causes output contention with RxC receiver.
singleline_comment|// Use of DPLL would require external hardware to disable RxC receiver
singleline_comment|// when DPLL mode selected.
id|info-&gt;params.flags
op_and_assign
op_complement
(paren
id|HDLC_FLAG_TXC_DPLL
op_plus
id|HDLC_FLAG_RXC_DPLL
)paren
suffix:semicolon
multiline_comment|/* disable DMA interrupts */
id|write_reg
c_func
(paren
id|info
comma
id|TXDMA
op_plus
id|DIR
comma
l_int|0
)paren
suffix:semicolon
id|write_reg
c_func
(paren
id|info
comma
id|RXDMA
op_plus
id|DIR
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* MD0, Mode Register 0&n;&t; *&n;&t; * 07..05  PRCTL&lt;2..0&gt;, Protocol Mode, 100=HDLC&n;&t; * 04      AUTO, Auto-enable (RTS/CTS/DCD)&n;&t; * 03      Reserved, must be 0&n;&t; * 02      CRCCC, CRC Calculation, 1=enabled&n;&t; * 01      CRC1, CRC selection, 0=CRC-16,1=CRC-CCITT-16&n;&t; * 00      CRC0, CRC initial value, 1 = all 1s&n;&t; *&n;&t; * 1000 0001&n;&t; */
id|RegValue
op_assign
l_int|0x81
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;params.flags
op_amp
id|HDLC_FLAG_AUTO_CTS
)paren
id|RegValue
op_or_assign
id|BIT4
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;params.flags
op_amp
id|HDLC_FLAG_AUTO_DCD
)paren
id|RegValue
op_or_assign
id|BIT4
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;params.crc_type
op_eq
id|HDLC_CRC_16_CCITT
)paren
id|RegValue
op_or_assign
id|BIT2
op_plus
id|BIT1
suffix:semicolon
id|write_reg
c_func
(paren
id|info
comma
id|MD0
comma
id|RegValue
)paren
suffix:semicolon
multiline_comment|/* MD1, Mode Register 1&n;&t; *&n;&t; * 07..06  ADDRS&lt;1..0&gt;, Address detect, 00=no addr check&n;&t; * 05..04  TXCHR&lt;1..0&gt;, tx char size, 00=8 bits&n;&t; * 03..02  RXCHR&lt;1..0&gt;, rx char size, 00=8 bits&n;&t; * 01..00  PMPM&lt;1..0&gt;, Parity mode, 00=no parity&n;&t; *&n;&t; * 0000 0000&n;&t; */
id|RegValue
op_assign
l_int|0x00
suffix:semicolon
id|write_reg
c_func
(paren
id|info
comma
id|MD1
comma
id|RegValue
)paren
suffix:semicolon
multiline_comment|/* MD2, Mode Register 2&n;&t; *&n;&t; * 07      NRZFM, 0=NRZ, 1=FM&n;&t; * 06..05  CODE&lt;1..0&gt; Encoding, 00=NRZ&n;&t; * 04..03  DRATE&lt;1..0&gt; DPLL Divisor, 00=8&n;&t; * 02      Reserved, must be 0&n;&t; * 01..00  CNCT&lt;1..0&gt; Channel connection, 0=normal&n;&t; *&n;&t; * 0000 0000&n;&t; */
id|RegValue
op_assign
l_int|0x00
suffix:semicolon
r_switch
c_cond
(paren
id|info-&gt;params.encoding
)paren
(brace
r_case
id|HDLC_ENCODING_NRZI
suffix:colon
id|RegValue
op_or_assign
id|BIT5
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HDLC_ENCODING_BIPHASE_MARK
suffix:colon
id|RegValue
op_or_assign
id|BIT7
op_plus
id|BIT5
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* aka FM1 */
r_case
id|HDLC_ENCODING_BIPHASE_SPACE
suffix:colon
id|RegValue
op_or_assign
id|BIT7
op_plus
id|BIT6
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* aka FM0 */
r_case
id|HDLC_ENCODING_BIPHASE_LEVEL
suffix:colon
id|RegValue
op_or_assign
id|BIT7
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* aka Manchester */
macro_line|#if 0
r_case
id|HDLC_ENCODING_NRZB
suffix:colon
multiline_comment|/* not supported */
r_case
id|HDLC_ENCODING_NRZI_MARK
suffix:colon
multiline_comment|/* not supported */
r_case
id|HDLC_ENCODING_DIFF_BIPHASE_LEVEL
suffix:colon
multiline_comment|/* not supported */
macro_line|#endif
)brace
r_if
c_cond
(paren
id|info-&gt;params.flags
op_amp
id|HDLC_FLAG_DPLL_DIV16
)paren
(brace
id|DpllDivisor
op_assign
l_int|16
suffix:semicolon
id|RegValue
op_or_assign
id|BIT3
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|info-&gt;params.flags
op_amp
id|HDLC_FLAG_DPLL_DIV8
)paren
(brace
id|DpllDivisor
op_assign
l_int|8
suffix:semicolon
)brace
r_else
(brace
id|DpllDivisor
op_assign
l_int|32
suffix:semicolon
id|RegValue
op_or_assign
id|BIT4
suffix:semicolon
)brace
id|write_reg
c_func
(paren
id|info
comma
id|MD2
comma
id|RegValue
)paren
suffix:semicolon
multiline_comment|/* RXS, Receive clock source&n;&t; *&n;&t; * 07      Reserved, must be 0&n;&t; * 06..04  RXCS&lt;2..0&gt;, clock source, 000=RxC Pin, 100=BRG, 110=DPLL&n;&t; * 03..00  RXBR&lt;3..0&gt;, rate divisor, 0000=1&n;&t; */
id|RegValue
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;params.flags
op_amp
id|HDLC_FLAG_RXC_BRG
)paren
id|RegValue
op_or_assign
id|BIT6
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;params.flags
op_amp
id|HDLC_FLAG_RXC_DPLL
)paren
id|RegValue
op_or_assign
id|BIT6
op_plus
id|BIT5
suffix:semicolon
id|write_reg
c_func
(paren
id|info
comma
id|RXS
comma
id|RegValue
)paren
suffix:semicolon
multiline_comment|/* TXS, Transmit clock source&n;&t; *&n;&t; * 07      Reserved, must be 0&n;&t; * 06..04  RXCS&lt;2..0&gt;, clock source, 000=TxC Pin, 100=BRG, 110=Receive Clock&n;&t; * 03..00  RXBR&lt;3..0&gt;, rate divisor, 0000=1&n;&t; */
id|RegValue
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;params.flags
op_amp
id|HDLC_FLAG_TXC_BRG
)paren
id|RegValue
op_or_assign
id|BIT6
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;params.flags
op_amp
id|HDLC_FLAG_TXC_DPLL
)paren
id|RegValue
op_or_assign
id|BIT6
op_plus
id|BIT5
suffix:semicolon
id|write_reg
c_func
(paren
id|info
comma
id|TXS
comma
id|RegValue
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;params.flags
op_amp
id|HDLC_FLAG_RXC_DPLL
)paren
id|set_rate
c_func
(paren
id|info
comma
id|info-&gt;params.clock_speed
op_star
id|DpllDivisor
)paren
suffix:semicolon
r_else
id|set_rate
c_func
(paren
id|info
comma
id|info-&gt;params.clock_speed
)paren
suffix:semicolon
multiline_comment|/* GPDATA (General Purpose I/O Data Register)&n;&t; *&n;&t; * 6,4,2,0  CLKSEL&lt;3..0&gt;, 0 = TcCLK in, 1 = Auxclk out&n;&t; */
r_if
c_cond
(paren
id|info-&gt;params.flags
op_amp
id|HDLC_FLAG_TXC_BRG
)paren
id|info-&gt;port_array
(braket
l_int|0
)braket
op_member_access_from_pointer
id|ctrlreg_value
op_or_assign
(paren
id|BIT0
op_lshift
(paren
id|info-&gt;port_num
op_star
l_int|2
)paren
)paren
suffix:semicolon
r_else
id|info-&gt;port_array
(braket
l_int|0
)braket
op_member_access_from_pointer
id|ctrlreg_value
op_and_assign
op_complement
(paren
id|BIT0
op_lshift
(paren
id|info-&gt;port_num
op_star
l_int|2
)paren
)paren
suffix:semicolon
id|write_control_reg
c_func
(paren
id|info
)paren
suffix:semicolon
multiline_comment|/* RRC Receive Ready Control 0&n;&t; *&n;&t; * 07..05  Reserved, must be 0&n;&t; * 04..00  RRC&lt;4..0&gt; Rx FIFO trigger active&n;&t; */
id|write_reg
c_func
(paren
id|info
comma
id|RRC
comma
id|rx_active_fifo_level
)paren
suffix:semicolon
multiline_comment|/* TRC0 Transmit Ready Control 0&n;&t; *&n;&t; * 07..05  Reserved, must be 0&n;&t; * 04..00  TRC&lt;4..0&gt; Tx FIFO trigger active&n;&t; */
id|write_reg
c_func
(paren
id|info
comma
id|TRC0
comma
id|tx_active_fifo_level
)paren
suffix:semicolon
multiline_comment|/* TRC1 Transmit Ready Control 1&n;&t; *&n;&t; * 07..05  Reserved, must be 0&n;&t; * 04..00  TRC&lt;4..0&gt; Tx FIFO trigger inactive 0x1f = 32 bytes (full)&n;&t; */
id|write_reg
c_func
(paren
id|info
comma
id|TRC1
comma
(paren
r_int
r_char
)paren
(paren
id|tx_negate_fifo_level
op_minus
l_int|1
)paren
)paren
suffix:semicolon
multiline_comment|/* DMR, DMA Mode Register&n;&t; *&n;&t; * 07..05  Reserved, must be 0&n;&t; * 04      TMOD, Transfer Mode: 1=chained-block&n;&t; * 03      Reserved, must be 0&n;&t; * 02      NF, Number of Frames: 1=multi-frame&n;&t; * 01      CNTE, Frame End IRQ Counter enable: 0=disabled&n;&t; * 00      Reserved, must be 0&n;&t; *&n;&t; * 0001 0100&n;&t; */
id|write_reg
c_func
(paren
id|info
comma
id|TXDMA
op_plus
id|DMR
comma
l_int|0x14
)paren
suffix:semicolon
id|write_reg
c_func
(paren
id|info
comma
id|RXDMA
op_plus
id|DMR
comma
l_int|0x14
)paren
suffix:semicolon
multiline_comment|/* Set chain pointer base (upper 8 bits of 24 bit addr) */
id|write_reg
c_func
(paren
id|info
comma
id|RXDMA
op_plus
id|CPB
comma
(paren
r_int
r_char
)paren
(paren
id|info-&gt;buffer_list_phys
op_rshift
l_int|16
)paren
)paren
suffix:semicolon
multiline_comment|/* Set chain pointer base (upper 8 bits of 24 bit addr) */
id|write_reg
c_func
(paren
id|info
comma
id|TXDMA
op_plus
id|CPB
comma
(paren
r_int
r_char
)paren
(paren
id|info-&gt;buffer_list_phys
op_rshift
l_int|16
)paren
)paren
suffix:semicolon
multiline_comment|/* enable status interrupts. other code enables/disables&n;&t; * the individual sources for these two interrupt classes.&n;&t; */
id|info-&gt;ie0_value
op_or_assign
id|TXINTE
op_plus
id|RXINTE
suffix:semicolon
id|write_reg
c_func
(paren
id|info
comma
id|IE0
comma
id|info-&gt;ie0_value
)paren
suffix:semicolon
multiline_comment|/* CTL, MSCI control register&n;&t; *&n;&t; * 07..06  Reserved, set to 0&n;&t; * 05      UDRNC, underrun control, 0=abort 1=CRC+flag (HDLC/BSC)&n;&t; * 04      IDLC, idle control, 0=mark 1=idle register&n;&t; * 03      BRK, break, 0=off 1 =on (async)&n;&t; * 02      SYNCLD, sync char load enable (BSC) 1=enabled&n;&t; * 01      GOP, go active on poll (LOOP mode) 1=enabled&n;&t; * 00      RTS, RTS output control, 0=active 1=inactive&n;&t; *&n;&t; * 0001 0001&n;&t; */
id|RegValue
op_assign
l_int|0x10
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|info-&gt;serial_signals
op_amp
id|SerialSignal_RTS
)paren
)paren
id|RegValue
op_or_assign
l_int|0x01
suffix:semicolon
id|write_reg
c_func
(paren
id|info
comma
id|CTL
comma
id|RegValue
)paren
suffix:semicolon
multiline_comment|/* preamble not supported ! */
id|tx_set_idle
c_func
(paren
id|info
)paren
suffix:semicolon
id|tx_stop
c_func
(paren
id|info
)paren
suffix:semicolon
id|rx_stop
c_func
(paren
id|info
)paren
suffix:semicolon
id|set_rate
c_func
(paren
id|info
comma
id|info-&gt;params.clock_speed
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;params.loopback
)paren
id|enable_loopback
c_func
(paren
id|info
comma
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/* Set the transmit HDLC idle mode&n; */
DECL|function|tx_set_idle
r_void
id|tx_set_idle
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
(brace
r_int
r_char
id|RegValue
op_assign
l_int|0xff
suffix:semicolon
multiline_comment|/* Map API idle mode to SCA register bits */
r_switch
c_cond
(paren
id|info-&gt;idle_mode
)paren
(brace
r_case
id|HDLC_TXIDLE_FLAGS
suffix:colon
id|RegValue
op_assign
l_int|0x7e
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HDLC_TXIDLE_ALT_ZEROS_ONES
suffix:colon
id|RegValue
op_assign
l_int|0xaa
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HDLC_TXIDLE_ZEROS
suffix:colon
id|RegValue
op_assign
l_int|0x00
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HDLC_TXIDLE_ONES
suffix:colon
id|RegValue
op_assign
l_int|0xff
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HDLC_TXIDLE_ALT_MARK_SPACE
suffix:colon
id|RegValue
op_assign
l_int|0xaa
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HDLC_TXIDLE_SPACE
suffix:colon
id|RegValue
op_assign
l_int|0x00
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HDLC_TXIDLE_MARK
suffix:colon
id|RegValue
op_assign
l_int|0xff
suffix:semicolon
r_break
suffix:semicolon
)brace
id|write_reg
c_func
(paren
id|info
comma
id|IDL
comma
id|RegValue
)paren
suffix:semicolon
)brace
multiline_comment|/* Query the adapter for the state of the V24 status (input) signals.&n; */
DECL|function|get_signals
r_void
id|get_signals
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
(brace
id|u16
id|status
op_assign
id|read_reg
c_func
(paren
id|info
comma
id|SR3
)paren
suffix:semicolon
id|u16
id|gpstatus
op_assign
id|read_status_reg
c_func
(paren
id|info
)paren
suffix:semicolon
id|u16
id|testbit
suffix:semicolon
multiline_comment|/* clear all serial signals except DTR and RTS */
id|info-&gt;serial_signals
op_and_assign
id|SerialSignal_DTR
op_plus
id|SerialSignal_RTS
suffix:semicolon
multiline_comment|/* set serial signal bits to reflect MISR */
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_amp
id|BIT3
)paren
)paren
id|info-&gt;serial_signals
op_or_assign
id|SerialSignal_CTS
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_amp
id|BIT2
)paren
)paren
id|info-&gt;serial_signals
op_or_assign
id|SerialSignal_DCD
suffix:semicolon
id|testbit
op_assign
id|BIT1
op_lshift
(paren
id|info-&gt;port_num
op_star
l_int|2
)paren
suffix:semicolon
singleline_comment|// Port 0..3 RI is GPDATA&lt;1,3,5,7&gt;
r_if
c_cond
(paren
op_logical_neg
(paren
id|gpstatus
op_amp
id|testbit
)paren
)paren
id|info-&gt;serial_signals
op_or_assign
id|SerialSignal_RI
suffix:semicolon
id|testbit
op_assign
id|BIT0
op_lshift
(paren
id|info-&gt;port_num
op_star
l_int|2
)paren
suffix:semicolon
singleline_comment|// Port 0..3 DSR is GPDATA&lt;0,2,4,6&gt;
r_if
c_cond
(paren
op_logical_neg
(paren
id|gpstatus
op_amp
id|testbit
)paren
)paren
id|info-&gt;serial_signals
op_or_assign
id|SerialSignal_DSR
suffix:semicolon
)brace
multiline_comment|/* Set the state of DTR and RTS based on contents of&n; * serial_signals member of device context.&n; */
DECL|function|set_signals
r_void
id|set_signals
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
(brace
r_int
r_char
id|RegValue
suffix:semicolon
id|u16
id|EnableBit
suffix:semicolon
id|RegValue
op_assign
id|read_reg
c_func
(paren
id|info
comma
id|CTL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;serial_signals
op_amp
id|SerialSignal_RTS
)paren
id|RegValue
op_and_assign
op_complement
id|BIT0
suffix:semicolon
r_else
id|RegValue
op_or_assign
id|BIT0
suffix:semicolon
id|write_reg
c_func
(paren
id|info
comma
id|CTL
comma
id|RegValue
)paren
suffix:semicolon
singleline_comment|// Port 0..3 DTR is ctrl reg &lt;1,3,5,7&gt;
id|EnableBit
op_assign
id|BIT1
op_lshift
(paren
id|info-&gt;port_num
op_star
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;serial_signals
op_amp
id|SerialSignal_DTR
)paren
id|info-&gt;port_array
(braket
l_int|0
)braket
op_member_access_from_pointer
id|ctrlreg_value
op_and_assign
op_complement
id|EnableBit
suffix:semicolon
r_else
id|info-&gt;port_array
(braket
l_int|0
)braket
op_member_access_from_pointer
id|ctrlreg_value
op_or_assign
id|EnableBit
suffix:semicolon
id|write_control_reg
c_func
(paren
id|info
)paren
suffix:semicolon
)brace
multiline_comment|/*******************/
multiline_comment|/* DMA Buffer Code */
multiline_comment|/*******************/
multiline_comment|/* Set the count for all receive buffers to SCABUFSIZE&n; * and set the current buffer to the first buffer. This effectively&n; * makes all buffers free and discards any data in buffers.&n; */
DECL|function|rx_reset_buffers
r_void
id|rx_reset_buffers
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
(brace
id|rx_free_frame_buffers
c_func
(paren
id|info
comma
l_int|0
comma
id|info-&gt;rx_buf_count
op_minus
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/* Free the buffers used by a received frame&n; *&n; * info   pointer to device instance data&n; * first  index of 1st receive buffer of frame&n; * last   index of last receive buffer of frame&n; */
DECL|function|rx_free_frame_buffers
r_void
id|rx_free_frame_buffers
c_func
(paren
id|SLMP_INFO
op_star
id|info
comma
r_int
r_int
id|first
comma
r_int
r_int
id|last
)paren
(brace
r_int
id|done
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|done
)paren
(brace
multiline_comment|/* reset current buffer for reuse */
id|info-&gt;rx_buf_list
(braket
id|first
)braket
dot
id|status
op_assign
l_int|0xff
suffix:semicolon
r_if
c_cond
(paren
id|first
op_eq
id|last
)paren
(brace
id|done
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* set new last rx descriptor address */
id|write_reg16
c_func
(paren
id|info
comma
id|RXDMA
op_plus
id|EDA
comma
id|info-&gt;rx_buf_list_ex
(braket
id|first
)braket
dot
id|phys_entry
)paren
suffix:semicolon
)brace
id|first
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|first
op_eq
id|info-&gt;rx_buf_count
)paren
id|first
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* set current buffer to next buffer after last buffer of frame */
id|info-&gt;current_rx_buf
op_assign
id|first
suffix:semicolon
)brace
multiline_comment|/* Return a received frame from the receive DMA buffers.&n; * Only frames received without errors are returned.&n; *&n; * Return Value:&t;1 if frame returned, otherwise 0&n; */
DECL|function|rx_get_frame
r_int
id|rx_get_frame
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
(brace
r_int
r_int
id|StartIndex
comma
id|EndIndex
suffix:semicolon
multiline_comment|/* index of 1st and last buffers of Rx frame */
r_int
r_int
id|status
suffix:semicolon
r_int
r_int
id|framesize
op_assign
l_int|0
suffix:semicolon
r_int
id|ReturnCode
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|tty_struct
op_star
id|tty
op_assign
id|info-&gt;tty
suffix:semicolon
r_int
r_char
id|addr_field
op_assign
l_int|0xff
suffix:semicolon
id|SCADESC
op_star
id|desc
suffix:semicolon
id|SCADESC_EX
op_star
id|desc_ex
suffix:semicolon
id|CheckAgain
suffix:colon
multiline_comment|/* assume no frame returned, set zero length */
id|framesize
op_assign
l_int|0
suffix:semicolon
id|addr_field
op_assign
l_int|0xff
suffix:semicolon
multiline_comment|/*&n;&t; * current_rx_buf points to the 1st buffer of the next available&n;&t; * receive frame. To find the last buffer of the frame look for&n;&t; * a non-zero status field in the buffer entries. (The status&n;&t; * field is set by the 16C32 after completing a receive frame.&n;&t; */
id|StartIndex
op_assign
id|EndIndex
op_assign
id|info-&gt;current_rx_buf
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|desc
op_assign
op_amp
id|info-&gt;rx_buf_list
(braket
id|EndIndex
)braket
suffix:semicolon
id|desc_ex
op_assign
op_amp
id|info-&gt;rx_buf_list_ex
(braket
id|EndIndex
)braket
suffix:semicolon
r_if
c_cond
(paren
id|desc-&gt;status
op_eq
l_int|0xff
)paren
r_goto
id|Cleanup
suffix:semicolon
multiline_comment|/* current desc still in use, no frames available */
r_if
c_cond
(paren
id|framesize
op_eq
l_int|0
op_logical_and
id|info-&gt;params.addr_filter
op_ne
l_int|0xff
)paren
id|addr_field
op_assign
id|desc_ex-&gt;virt_addr
(braket
l_int|0
)braket
suffix:semicolon
id|framesize
op_add_assign
id|desc-&gt;length
suffix:semicolon
multiline_comment|/* Status != 0 means last buffer of frame */
r_if
c_cond
(paren
id|desc-&gt;status
)paren
r_break
suffix:semicolon
id|EndIndex
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|EndIndex
op_eq
id|info-&gt;rx_buf_count
)paren
id|EndIndex
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|EndIndex
op_eq
id|info-&gt;current_rx_buf
)paren
(brace
multiline_comment|/* all buffers have been &squot;used&squot; but none mark&t;   */
multiline_comment|/* the end of a frame. Reset buffers and receiver. */
r_if
c_cond
(paren
id|info-&gt;rx_enabled
)paren
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|rx_start
c_func
(paren
id|info
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_goto
id|Cleanup
suffix:semicolon
)brace
)brace
multiline_comment|/* check status of receive frame */
multiline_comment|/* frame status is byte stored after frame data&n;&t; *&n;&t; * 7 EOM (end of msg), 1 = last buffer of frame&n;&t; * 6 Short Frame, 1 = short frame&n;&t; * 5 Abort, 1 = frame aborted&n;&t; * 4 Residue, 1 = last byte is partial&n;&t; * 3 Overrun, 1 = overrun occurred during frame reception&n;&t; * 2 CRC,     1 = CRC error detected&n;&t; *&n;&t; */
id|status
op_assign
id|desc-&gt;status
suffix:semicolon
multiline_comment|/* ignore CRC bit if not using CRC (bit is undefined) */
multiline_comment|/* Note:CRC is not save to data buffer */
r_if
c_cond
(paren
id|info-&gt;params.crc_type
op_eq
id|HDLC_CRC_NONE
)paren
id|status
op_and_assign
op_complement
id|BIT2
suffix:semicolon
r_if
c_cond
(paren
id|framesize
op_eq
l_int|0
op_logical_or
(paren
id|addr_field
op_ne
l_int|0xff
op_logical_and
id|addr_field
op_ne
id|info-&gt;params.addr_filter
)paren
)paren
(brace
multiline_comment|/* discard 0 byte frames, this seems to occur sometime&n;&t;&t; * when remote is idling flags.&n;&t;&t; */
id|rx_free_frame_buffers
c_func
(paren
id|info
comma
id|StartIndex
comma
id|EndIndex
)paren
suffix:semicolon
r_goto
id|CheckAgain
suffix:semicolon
)brace
r_if
c_cond
(paren
id|framesize
OL
l_int|2
)paren
id|status
op_or_assign
id|BIT6
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
(paren
id|BIT6
op_plus
id|BIT5
op_plus
id|BIT3
op_plus
id|BIT2
)paren
)paren
(brace
multiline_comment|/* received frame has errors,&n;&t;&t; * update counts and mark frame size as 0&n;&t;&t; */
r_if
c_cond
(paren
id|status
op_amp
id|BIT6
)paren
id|info-&gt;icount.rxshort
op_increment
suffix:semicolon
r_else
r_if
c_cond
(paren
id|status
op_amp
id|BIT5
)paren
id|info-&gt;icount.rxabort
op_increment
suffix:semicolon
r_else
r_if
c_cond
(paren
id|status
op_amp
id|BIT3
)paren
id|info-&gt;icount.rxover
op_increment
suffix:semicolon
r_else
id|info-&gt;icount.rxcrc
op_increment
suffix:semicolon
id|framesize
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef CONFIG_HDLC
(brace
r_struct
id|net_device_stats
op_star
id|stats
op_assign
id|hdlc_stats
c_func
(paren
id|info-&gt;netdev
)paren
suffix:semicolon
id|stats-&gt;rx_errors
op_increment
suffix:semicolon
id|stats-&gt;rx_frame_errors
op_increment
suffix:semicolon
)brace
macro_line|#endif
)brace
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_BH
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s rx_get_frame() status=%04X size=%d&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
comma
id|status
comma
id|framesize
)paren
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_DATA
)paren
id|trace_block
c_func
(paren
id|info
comma
id|info-&gt;rx_buf_list_ex
(braket
id|StartIndex
)braket
dot
id|virt_addr
comma
id|min_t
c_func
(paren
r_int
comma
id|framesize
comma
id|SCABUFSIZE
)paren
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|framesize
)paren
(brace
r_if
c_cond
(paren
id|framesize
OG
id|info-&gt;max_frame_size
)paren
id|info-&gt;icount.rxlong
op_increment
suffix:semicolon
r_else
(brace
multiline_comment|/* copy dma buffer(s) to contiguous intermediate buffer */
r_int
id|copy_count
op_assign
id|framesize
suffix:semicolon
r_int
id|index
op_assign
id|StartIndex
suffix:semicolon
r_int
r_char
op_star
id|ptmp
op_assign
id|info-&gt;tmp_rx_buf
suffix:semicolon
id|info-&gt;tmp_rx_buf_count
op_assign
id|framesize
suffix:semicolon
id|info-&gt;icount.rxok
op_increment
suffix:semicolon
r_while
c_loop
(paren
id|copy_count
)paren
(brace
r_int
id|partial_count
op_assign
id|min
c_func
(paren
id|copy_count
comma
id|SCABUFSIZE
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|ptmp
comma
id|info-&gt;rx_buf_list_ex
(braket
id|index
)braket
dot
id|virt_addr
comma
id|partial_count
)paren
suffix:semicolon
id|ptmp
op_add_assign
id|partial_count
suffix:semicolon
id|copy_count
op_sub_assign
id|partial_count
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|index
op_eq
id|info-&gt;rx_buf_count
)paren
id|index
op_assign
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_HDLC
r_if
c_cond
(paren
id|info-&gt;netcount
)paren
id|hdlcdev_rx
c_func
(paren
id|info
comma
id|info-&gt;tmp_rx_buf
comma
id|framesize
)paren
suffix:semicolon
r_else
macro_line|#endif
id|ldisc_receive_buf
c_func
(paren
id|tty
comma
id|info-&gt;tmp_rx_buf
comma
id|info-&gt;flag_buf
comma
id|framesize
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Free the buffers used by this frame. */
id|rx_free_frame_buffers
c_func
(paren
id|info
comma
id|StartIndex
comma
id|EndIndex
)paren
suffix:semicolon
id|ReturnCode
op_assign
l_int|1
suffix:semicolon
id|Cleanup
suffix:colon
r_if
c_cond
(paren
id|info-&gt;rx_enabled
op_logical_and
id|info-&gt;rx_overflow
)paren
(brace
multiline_comment|/* Receiver is enabled, but needs to restarted due to&n;&t;&t; * rx buffer overflow. If buffers are empty, restart receiver.&n;&t;&t; */
r_if
c_cond
(paren
id|info-&gt;rx_buf_list
(braket
id|EndIndex
)braket
dot
id|status
op_eq
l_int|0xff
)paren
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|rx_start
c_func
(paren
id|info
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
)brace
r_return
id|ReturnCode
suffix:semicolon
)brace
multiline_comment|/* load the transmit DMA buffer with data&n; */
DECL|function|tx_load_dma_buffer
r_void
id|tx_load_dma_buffer
c_func
(paren
id|SLMP_INFO
op_star
id|info
comma
r_const
r_char
op_star
id|buf
comma
r_int
r_int
id|count
)paren
(brace
r_int
r_int
id|copy_count
suffix:semicolon
r_int
r_int
id|i
op_assign
l_int|0
suffix:semicolon
id|SCADESC
op_star
id|desc
suffix:semicolon
id|SCADESC_EX
op_star
id|desc_ex
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_DATA
)paren
id|trace_block
c_func
(paren
id|info
comma
id|buf
comma
id|min_t
c_func
(paren
r_int
comma
id|count
comma
id|SCABUFSIZE
)paren
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Copy source buffer to one or more DMA buffers, starting with&n;&t; * the first transmit dma buffer.&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
suffix:semicolon
)paren
(brace
id|copy_count
op_assign
id|min_t
c_func
(paren
r_int
r_int
comma
id|count
comma
id|SCABUFSIZE
)paren
suffix:semicolon
id|desc
op_assign
op_amp
id|info-&gt;tx_buf_list
(braket
id|i
)braket
suffix:semicolon
id|desc_ex
op_assign
op_amp
id|info-&gt;tx_buf_list_ex
(braket
id|i
)braket
suffix:semicolon
id|load_pci_memory
c_func
(paren
id|info
comma
id|desc_ex-&gt;virt_addr
comma
id|buf
comma
id|copy_count
)paren
suffix:semicolon
id|desc-&gt;length
op_assign
id|copy_count
suffix:semicolon
id|desc-&gt;status
op_assign
l_int|0
suffix:semicolon
id|buf
op_add_assign
id|copy_count
suffix:semicolon
id|count
op_sub_assign
id|copy_count
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|count
)paren
r_break
suffix:semicolon
id|i
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ge
id|info-&gt;tx_buf_count
)paren
id|i
op_assign
l_int|0
suffix:semicolon
)brace
id|info-&gt;tx_buf_list
(braket
id|i
)braket
dot
id|status
op_assign
l_int|0x81
suffix:semicolon
multiline_comment|/* set EOM and EOT status */
id|info-&gt;last_tx_buf
op_assign
op_increment
id|i
suffix:semicolon
)brace
DECL|function|register_test
r_int
id|register_test
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
(brace
r_static
r_int
r_char
id|testval
(braket
)braket
op_assign
(brace
l_int|0x00
comma
l_int|0xff
comma
l_int|0xaa
comma
l_int|0x55
comma
l_int|0x69
comma
l_int|0x96
)brace
suffix:semicolon
r_static
r_int
r_int
id|count
op_assign
r_sizeof
(paren
id|testval
)paren
op_div
r_sizeof
(paren
r_int
r_char
)paren
suffix:semicolon
r_int
r_int
id|i
suffix:semicolon
r_int
id|rc
op_assign
id|TRUE
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|reset_port
c_func
(paren
id|info
)paren
suffix:semicolon
multiline_comment|/* assume failure */
id|info-&gt;init_error
op_assign
id|DiagStatus_AddressFailure
suffix:semicolon
multiline_comment|/* Write bit patterns to various registers but do it out of */
multiline_comment|/* sync, then read back and verify values. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|write_reg
c_func
(paren
id|info
comma
id|TMC
comma
id|testval
(braket
id|i
)braket
)paren
suffix:semicolon
id|write_reg
c_func
(paren
id|info
comma
id|IDL
comma
id|testval
(braket
(paren
id|i
op_plus
l_int|1
)paren
op_mod
id|count
)braket
)paren
suffix:semicolon
id|write_reg
c_func
(paren
id|info
comma
id|SA0
comma
id|testval
(braket
(paren
id|i
op_plus
l_int|2
)paren
op_mod
id|count
)braket
)paren
suffix:semicolon
id|write_reg
c_func
(paren
id|info
comma
id|SA1
comma
id|testval
(braket
(paren
id|i
op_plus
l_int|3
)paren
op_mod
id|count
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|read_reg
c_func
(paren
id|info
comma
id|TMC
)paren
op_ne
id|testval
(braket
id|i
)braket
)paren
op_logical_or
(paren
id|read_reg
c_func
(paren
id|info
comma
id|IDL
)paren
op_ne
id|testval
(braket
(paren
id|i
op_plus
l_int|1
)paren
op_mod
id|count
)braket
)paren
op_logical_or
(paren
id|read_reg
c_func
(paren
id|info
comma
id|SA0
)paren
op_ne
id|testval
(braket
(paren
id|i
op_plus
l_int|2
)paren
op_mod
id|count
)braket
)paren
op_logical_or
(paren
id|read_reg
c_func
(paren
id|info
comma
id|SA1
)paren
op_ne
id|testval
(braket
(paren
id|i
op_plus
l_int|3
)paren
op_mod
id|count
)braket
)paren
)paren
(brace
id|rc
op_assign
id|FALSE
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|reset_port
c_func
(paren
id|info
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|irq_test
r_int
id|irq_test
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
(brace
r_int
r_int
id|timeout
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
r_char
id|timer
op_assign
(paren
id|info-&gt;port_num
op_amp
l_int|1
)paren
ques
c_cond
id|TIMER2
suffix:colon
id|TIMER0
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|reset_port
c_func
(paren
id|info
)paren
suffix:semicolon
multiline_comment|/* assume failure */
id|info-&gt;init_error
op_assign
id|DiagStatus_IrqFailure
suffix:semicolon
id|info-&gt;irq_occurred
op_assign
id|FALSE
suffix:semicolon
multiline_comment|/* setup timer0 on SCA0 to interrupt */
multiline_comment|/* IER2&lt;7..4&gt; = timer&lt;3..0&gt; interrupt enables (1=enabled) */
id|write_reg
c_func
(paren
id|info
comma
id|IER2
comma
(paren
r_int
r_char
)paren
(paren
(paren
id|info-&gt;port_num
op_amp
l_int|1
)paren
ques
c_cond
id|BIT6
suffix:colon
id|BIT4
)paren
)paren
suffix:semicolon
id|write_reg
c_func
(paren
id|info
comma
(paren
r_int
r_char
)paren
(paren
id|timer
op_plus
id|TEPR
)paren
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* timer expand prescale */
id|write_reg16
c_func
(paren
id|info
comma
(paren
r_int
r_char
)paren
(paren
id|timer
op_plus
id|TCONR
)paren
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* timer constant */
multiline_comment|/* TMCS, Timer Control/Status Register&n;&t; *&n;&t; * 07      CMF, Compare match flag (read only) 1=match&n;&t; * 06      ECMI, CMF Interrupt Enable: 1=enabled&n;&t; * 05      Reserved, must be 0&n;&t; * 04      TME, Timer Enable&n;&t; * 03..00  Reserved, must be 0&n;&t; *&n;&t; * 0101 0000&n;&t; */
id|write_reg
c_func
(paren
id|info
comma
(paren
r_int
r_char
)paren
(paren
id|timer
op_plus
id|TMCS
)paren
comma
l_int|0x50
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|timeout
op_assign
l_int|100
suffix:semicolon
r_while
c_loop
(paren
id|timeout
op_decrement
op_logical_and
op_logical_neg
id|info-&gt;irq_occurred
)paren
(brace
id|msleep_interruptible
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|reset_port
c_func
(paren
id|info
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|info-&gt;irq_occurred
suffix:semicolon
)brace
multiline_comment|/* initialize individual SCA device (2 ports)&n; */
DECL|function|sca_init
r_int
id|sca_init
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
(brace
multiline_comment|/* set wait controller to single mem partition (low), no wait states */
id|write_reg
c_func
(paren
id|info
comma
id|PABR0
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* wait controller addr boundary 0 */
id|write_reg
c_func
(paren
id|info
comma
id|PABR1
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* wait controller addr boundary 1 */
id|write_reg
c_func
(paren
id|info
comma
id|WCRL
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* wait controller low range */
id|write_reg
c_func
(paren
id|info
comma
id|WCRM
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* wait controller mid range */
id|write_reg
c_func
(paren
id|info
comma
id|WCRH
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* wait controller high range */
multiline_comment|/* DPCR, DMA Priority Control&n;&t; *&n;&t; * 07..05  Not used, must be 0&n;&t; * 04      BRC, bus release condition: 0=all transfers complete&n;&t; * 03      CCC, channel change condition: 0=every cycle&n;&t; * 02..00  PR&lt;2..0&gt;, priority 100=round robin&n;&t; *&n;&t; * 00000100 = 0x04&n;&t; */
id|write_reg
c_func
(paren
id|info
comma
id|DPCR
comma
id|dma_priority
)paren
suffix:semicolon
multiline_comment|/* DMA Master Enable, BIT7: 1=enable all channels */
id|write_reg
c_func
(paren
id|info
comma
id|DMER
comma
l_int|0x80
)paren
suffix:semicolon
multiline_comment|/* enable all interrupt classes */
id|write_reg
c_func
(paren
id|info
comma
id|IER0
comma
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* TxRDY,RxRDY,TxINT,RxINT (ports 0-1) */
id|write_reg
c_func
(paren
id|info
comma
id|IER1
comma
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* DMIB,DMIA (channels 0-3) */
id|write_reg
c_func
(paren
id|info
comma
id|IER2
comma
l_int|0xf0
)paren
suffix:semicolon
multiline_comment|/* TIRQ (timers 0-3) */
multiline_comment|/* ITCR, interrupt control register&n;&t; * 07      IPC, interrupt priority, 0=MSCI-&gt;DMA&n;&t; * 06..05  IAK&lt;1..0&gt;, Acknowledge cycle, 00=non-ack cycle&n;&t; * 04      VOS, Vector Output, 0=unmodified vector&n;&t; * 03..00  Reserved, must be 0&n;&t; */
id|write_reg
c_func
(paren
id|info
comma
id|ITCR
comma
l_int|0
)paren
suffix:semicolon
r_return
id|TRUE
suffix:semicolon
)brace
multiline_comment|/* initialize adapter hardware&n; */
DECL|function|init_adapter
r_int
id|init_adapter
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/* Set BIT30 of Local Control Reg 0x50 to reset SCA */
r_volatile
id|u32
op_star
id|MiscCtrl
op_assign
(paren
id|u32
op_star
)paren
(paren
id|info-&gt;lcr_base
op_plus
l_int|0x50
)paren
suffix:semicolon
id|u32
id|readval
suffix:semicolon
id|info-&gt;misc_ctrl_value
op_or_assign
id|BIT30
suffix:semicolon
op_star
id|MiscCtrl
op_assign
id|info-&gt;misc_ctrl_value
suffix:semicolon
multiline_comment|/*&n;&t; * Force at least 170ns delay before clearing&n;&t; * reset bit. Each read from LCR takes at least&n;&t; * 30ns so 10 times for 300ns to be safe.&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|10
suffix:semicolon
id|i
op_increment
)paren
(brace
id|readval
op_assign
op_star
id|MiscCtrl
suffix:semicolon
)brace
id|info-&gt;misc_ctrl_value
op_and_assign
op_complement
id|BIT30
suffix:semicolon
op_star
id|MiscCtrl
op_assign
id|info-&gt;misc_ctrl_value
suffix:semicolon
multiline_comment|/* init control reg (all DTRs off, all clksel=input) */
id|info-&gt;ctrlreg_value
op_assign
l_int|0xaa
suffix:semicolon
id|write_control_reg
c_func
(paren
id|info
)paren
suffix:semicolon
(brace
r_volatile
id|u32
op_star
id|LCR1BRDR
op_assign
(paren
id|u32
op_star
)paren
(paren
id|info-&gt;lcr_base
op_plus
l_int|0x2c
)paren
suffix:semicolon
id|lcr1_brdr_value
op_and_assign
op_complement
(paren
id|BIT5
op_plus
id|BIT4
op_plus
id|BIT3
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|read_ahead_count
)paren
(brace
r_case
l_int|16
suffix:colon
id|lcr1_brdr_value
op_or_assign
id|BIT5
op_plus
id|BIT4
op_plus
id|BIT3
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|8
suffix:colon
id|lcr1_brdr_value
op_or_assign
id|BIT5
op_plus
id|BIT4
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
id|lcr1_brdr_value
op_or_assign
id|BIT5
op_plus
id|BIT3
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0
suffix:colon
id|lcr1_brdr_value
op_or_assign
id|BIT5
suffix:semicolon
r_break
suffix:semicolon
)brace
op_star
id|LCR1BRDR
op_assign
id|lcr1_brdr_value
suffix:semicolon
op_star
id|MiscCtrl
op_assign
id|misc_ctrl_value
suffix:semicolon
)brace
id|sca_init
c_func
(paren
id|info-&gt;port_array
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|sca_init
c_func
(paren
id|info-&gt;port_array
(braket
l_int|2
)braket
)paren
suffix:semicolon
r_return
id|TRUE
suffix:semicolon
)brace
multiline_comment|/* Loopback an HDLC frame to test the hardware&n; * interrupt and DMA functions.&n; */
DECL|function|loopback_test
r_int
id|loopback_test
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
(brace
DECL|macro|TESTFRAMESIZE
mdefine_line|#define TESTFRAMESIZE 20
r_int
r_int
id|timeout
suffix:semicolon
id|u16
id|count
op_assign
id|TESTFRAMESIZE
suffix:semicolon
r_int
r_char
id|buf
(braket
id|TESTFRAMESIZE
)braket
suffix:semicolon
r_int
id|rc
op_assign
id|FALSE
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|tty_struct
op_star
id|oldtty
op_assign
id|info-&gt;tty
suffix:semicolon
id|u32
id|speed
op_assign
id|info-&gt;params.clock_speed
suffix:semicolon
id|info-&gt;params.clock_speed
op_assign
l_int|3686400
suffix:semicolon
id|info-&gt;tty
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* assume failure */
id|info-&gt;init_error
op_assign
id|DiagStatus_DmaFailure
suffix:semicolon
multiline_comment|/* build and send transmit frame */
r_for
c_loop
(paren
id|count
op_assign
l_int|0
suffix:semicolon
id|count
OL
id|TESTFRAMESIZE
suffix:semicolon
op_increment
id|count
)paren
id|buf
(braket
id|count
)braket
op_assign
(paren
r_int
r_char
)paren
id|count
suffix:semicolon
id|memset
c_func
(paren
id|info-&gt;tmp_rx_buf
comma
l_int|0
comma
id|TESTFRAMESIZE
)paren
suffix:semicolon
multiline_comment|/* program hardware for HDLC and enabled receiver */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|hdlc_mode
c_func
(paren
id|info
)paren
suffix:semicolon
id|enable_loopback
c_func
(paren
id|info
comma
l_int|1
)paren
suffix:semicolon
id|rx_start
c_func
(paren
id|info
)paren
suffix:semicolon
id|info-&gt;tx_count
op_assign
id|count
suffix:semicolon
id|tx_load_dma_buffer
c_func
(paren
id|info
comma
id|buf
comma
id|count
)paren
suffix:semicolon
id|tx_start
c_func
(paren
id|info
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* wait for receive complete */
multiline_comment|/* Set a timeout for waiting for interrupt. */
r_for
c_loop
(paren
id|timeout
op_assign
l_int|100
suffix:semicolon
id|timeout
suffix:semicolon
op_decrement
id|timeout
)paren
(brace
id|msleep_interruptible
c_func
(paren
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rx_get_frame
c_func
(paren
id|info
)paren
)paren
(brace
id|rc
op_assign
id|TRUE
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* verify received frame length and contents */
r_if
c_cond
(paren
id|rc
op_eq
id|TRUE
op_logical_and
(paren
id|info-&gt;tmp_rx_buf_count
op_ne
id|count
op_logical_or
id|memcmp
c_func
(paren
id|buf
comma
id|info-&gt;tmp_rx_buf
comma
id|count
)paren
)paren
)paren
(brace
id|rc
op_assign
id|FALSE
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|reset_adapter
c_func
(paren
id|info
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|info-&gt;params.clock_speed
op_assign
id|speed
suffix:semicolon
id|info-&gt;tty
op_assign
id|oldtty
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/* Perform diagnostics on hardware&n; */
DECL|function|adapter_test
r_int
id|adapter_test
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):Testing device %s&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|init_adapter
c_func
(paren
id|info
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|info-&gt;port_array
(braket
l_int|0
)braket
op_member_access_from_pointer
id|port_count
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|register_test
c_func
(paren
id|info-&gt;port_array
(braket
l_int|0
)braket
)paren
op_logical_and
id|register_test
c_func
(paren
id|info-&gt;port_array
(braket
l_int|1
)braket
)paren
)paren
(brace
id|info-&gt;port_array
(braket
l_int|0
)braket
op_member_access_from_pointer
id|port_count
op_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|register_test
c_func
(paren
id|info-&gt;port_array
(braket
l_int|2
)braket
)paren
op_logical_and
id|register_test
c_func
(paren
id|info-&gt;port_array
(braket
l_int|3
)braket
)paren
)paren
id|info-&gt;port_array
(braket
l_int|0
)braket
op_member_access_from_pointer
id|port_count
op_add_assign
l_int|2
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;%s(%d):Register test failure for device %s Addr=%08lX&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
comma
(paren
r_int
r_int
)paren
(paren
id|info-&gt;phys_sca_base
)paren
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|irq_test
c_func
(paren
id|info-&gt;port_array
(braket
l_int|0
)braket
)paren
op_logical_or
op_logical_neg
id|irq_test
c_func
(paren
id|info-&gt;port_array
(braket
l_int|1
)braket
)paren
op_logical_or
(paren
id|info-&gt;port_count
op_eq
l_int|4
op_logical_and
op_logical_neg
id|irq_test
c_func
(paren
id|info-&gt;port_array
(braket
l_int|2
)braket
)paren
)paren
op_logical_or
(paren
id|info-&gt;port_count
op_eq
l_int|4
op_logical_and
op_logical_neg
id|irq_test
c_func
(paren
id|info-&gt;port_array
(braket
l_int|3
)braket
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s(%d):Interrupt test failure for device %s IRQ=%d&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
comma
(paren
r_int
r_int
)paren
(paren
id|info-&gt;irq_level
)paren
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|loopback_test
c_func
(paren
id|info-&gt;port_array
(braket
l_int|0
)braket
)paren
op_logical_or
op_logical_neg
id|loopback_test
c_func
(paren
id|info-&gt;port_array
(braket
l_int|1
)braket
)paren
op_logical_or
(paren
id|info-&gt;port_count
op_eq
l_int|4
op_logical_and
op_logical_neg
id|loopback_test
c_func
(paren
id|info-&gt;port_array
(braket
l_int|2
)braket
)paren
)paren
op_logical_or
(paren
id|info-&gt;port_count
op_eq
l_int|4
op_logical_and
op_logical_neg
id|loopback_test
c_func
(paren
id|info-&gt;port_array
(braket
l_int|3
)braket
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s(%d):DMA test failure for device %s&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):device %s passed diagnostics&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
)paren
suffix:semicolon
id|info-&gt;port_array
(braket
l_int|0
)braket
op_member_access_from_pointer
id|init_error
op_assign
l_int|0
suffix:semicolon
id|info-&gt;port_array
(braket
l_int|1
)braket
op_member_access_from_pointer
id|init_error
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;port_count
OG
l_int|2
)paren
(brace
id|info-&gt;port_array
(braket
l_int|2
)braket
op_member_access_from_pointer
id|init_error
op_assign
l_int|0
suffix:semicolon
id|info-&gt;port_array
(braket
l_int|3
)braket
op_member_access_from_pointer
id|init_error
op_assign
l_int|0
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Test the shared memory on a PCI adapter.&n; */
DECL|function|memory_test
r_int
id|memory_test
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
(brace
r_static
r_int
r_int
id|testval
(braket
)braket
op_assign
(brace
l_int|0x0
comma
l_int|0x55555555
comma
l_int|0xaaaaaaaa
comma
l_int|0x66666666
comma
l_int|0x99999999
comma
l_int|0xffffffff
comma
l_int|0x12345678
)brace
suffix:semicolon
r_int
r_int
id|count
op_assign
r_sizeof
(paren
id|testval
)paren
op_div
r_sizeof
(paren
r_int
r_int
)paren
suffix:semicolon
r_int
r_int
id|i
suffix:semicolon
r_int
r_int
id|limit
op_assign
id|SCA_MEM_SIZE
op_div
r_sizeof
(paren
r_int
r_int
)paren
suffix:semicolon
r_int
r_int
op_star
id|addr
op_assign
(paren
r_int
r_int
op_star
)paren
id|info-&gt;memory_base
suffix:semicolon
multiline_comment|/* Test data lines with test pattern at one location. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
suffix:semicolon
id|i
op_increment
)paren
(brace
op_star
id|addr
op_assign
id|testval
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
op_star
id|addr
op_ne
id|testval
(braket
id|i
)braket
)paren
r_return
id|FALSE
suffix:semicolon
)brace
multiline_comment|/* Test address lines with incrementing pattern over */
multiline_comment|/* entire address range. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|limit
suffix:semicolon
id|i
op_increment
)paren
(brace
op_star
id|addr
op_assign
id|i
op_star
l_int|4
suffix:semicolon
id|addr
op_increment
suffix:semicolon
)brace
id|addr
op_assign
(paren
r_int
r_int
op_star
)paren
id|info-&gt;memory_base
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|limit
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_star
id|addr
op_ne
id|i
op_star
l_int|4
)paren
r_return
id|FALSE
suffix:semicolon
id|addr
op_increment
suffix:semicolon
)brace
id|memset
c_func
(paren
id|info-&gt;memory_base
comma
l_int|0
comma
id|SCA_MEM_SIZE
)paren
suffix:semicolon
r_return
id|TRUE
suffix:semicolon
)brace
multiline_comment|/* Load data into PCI adapter shared memory.&n; *&n; * The PCI9050 releases control of the local bus&n; * after completing the current read or write operation.&n; *&n; * While the PCI9050 write FIFO not empty, the&n; * PCI9050 treats all of the writes as a single transaction&n; * and does not release the bus. This causes DMA latency problems&n; * at high speeds when copying large data blocks to the shared memory.&n; *&n; * This function breaks a write into multiple transations by&n; * interleaving a read which flushes the write FIFO and &squot;completes&squot;&n; * the write transation. This allows any pending DMA request to gain control&n; * of the local bus in a timely fasion.&n; */
DECL|function|load_pci_memory
r_void
id|load_pci_memory
c_func
(paren
id|SLMP_INFO
op_star
id|info
comma
r_char
op_star
id|dest
comma
r_const
r_char
op_star
id|src
comma
r_int
r_int
id|count
)paren
(brace
multiline_comment|/* A load interval of 16 allows for 4 32-bit writes at */
multiline_comment|/* 136ns each for a maximum latency of 542ns on the local bus.*/
r_int
r_int
id|interval
op_assign
id|count
op_div
id|sca_pci_load_interval
suffix:semicolon
r_int
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|interval
suffix:semicolon
id|i
op_increment
)paren
(brace
id|memcpy
c_func
(paren
id|dest
comma
id|src
comma
id|sca_pci_load_interval
)paren
suffix:semicolon
id|read_status_reg
c_func
(paren
id|info
)paren
suffix:semicolon
id|dest
op_add_assign
id|sca_pci_load_interval
suffix:semicolon
id|src
op_add_assign
id|sca_pci_load_interval
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|dest
comma
id|src
comma
id|count
op_mod
id|sca_pci_load_interval
)paren
suffix:semicolon
)brace
DECL|function|trace_block
r_void
id|trace_block
c_func
(paren
id|SLMP_INFO
op_star
id|info
comma
r_const
r_char
op_star
id|data
comma
r_int
id|count
comma
r_int
id|xmit
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|linecount
suffix:semicolon
r_if
c_cond
(paren
id|xmit
)paren
id|printk
c_func
(paren
l_string|&quot;%s tx data:&bslash;n&quot;
comma
id|info-&gt;device_name
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
l_string|&quot;%s rx data:&bslash;n&quot;
comma
id|info-&gt;device_name
)paren
suffix:semicolon
r_while
c_loop
(paren
id|count
)paren
(brace
r_if
c_cond
(paren
id|count
OG
l_int|16
)paren
id|linecount
op_assign
l_int|16
suffix:semicolon
r_else
id|linecount
op_assign
id|count
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|linecount
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%02X &quot;
comma
(paren
r_int
r_char
)paren
id|data
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
suffix:semicolon
id|i
OL
l_int|17
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;   &quot;
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|linecount
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|data
(braket
id|i
)braket
op_ge
l_int|040
op_logical_and
id|data
(braket
id|i
)braket
op_le
l_int|0176
)paren
id|printk
c_func
(paren
l_string|&quot;%c&quot;
comma
id|data
(braket
id|i
)braket
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
l_string|&quot;.&quot;
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|data
op_add_assign
id|linecount
suffix:semicolon
id|count
op_sub_assign
id|linecount
suffix:semicolon
)brace
)brace
multiline_comment|/* end of trace_block() */
multiline_comment|/* called when HDLC frame times out&n; * update stats and do tx completion processing&n; */
DECL|function|tx_timeout
r_void
id|tx_timeout
c_func
(paren
r_int
r_int
id|context
)paren
(brace
id|SLMP_INFO
op_star
id|info
op_assign
(paren
id|SLMP_INFO
op_star
)paren
id|context
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|debug_level
op_ge
id|DEBUG_LEVEL_INFO
)paren
id|printk
c_func
(paren
l_string|&quot;%s(%d):%s tx_timeout()&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|info-&gt;device_name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;tx_active
op_logical_and
id|info-&gt;params.mode
op_eq
id|MGSL_MODE_HDLC
)paren
(brace
id|info-&gt;icount.txtimeout
op_increment
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|info-&gt;tx_active
op_assign
l_int|0
suffix:semicolon
id|info-&gt;tx_count
op_assign
id|info-&gt;tx_put
op_assign
id|info-&gt;tx_get
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_HDLC
r_if
c_cond
(paren
id|info-&gt;netcount
)paren
id|hdlcdev_tx_done
c_func
(paren
id|info
)paren
suffix:semicolon
r_else
macro_line|#endif
id|bh_transmit
c_func
(paren
id|info
)paren
suffix:semicolon
)brace
multiline_comment|/* called to periodically check the DSR/RI modem signal input status&n; */
DECL|function|status_timeout
r_void
id|status_timeout
c_func
(paren
r_int
r_int
id|context
)paren
(brace
id|u16
id|status
op_assign
l_int|0
suffix:semicolon
id|SLMP_INFO
op_star
id|info
op_assign
(paren
id|SLMP_INFO
op_star
)paren
id|context
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
r_char
id|delta
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|get_signals
c_func
(paren
id|info
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|info-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* check for DSR/RI state change */
id|delta
op_assign
id|info-&gt;old_signals
op_xor
id|info-&gt;serial_signals
suffix:semicolon
id|info-&gt;old_signals
op_assign
id|info-&gt;serial_signals
suffix:semicolon
r_if
c_cond
(paren
id|delta
op_amp
id|SerialSignal_DSR
)paren
id|status
op_or_assign
id|MISCSTATUS_DSR_LATCHED
op_or
(paren
id|info-&gt;serial_signals
op_amp
id|SerialSignal_DSR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|delta
op_amp
id|SerialSignal_RI
)paren
id|status
op_or_assign
id|MISCSTATUS_RI_LATCHED
op_or
(paren
id|info-&gt;serial_signals
op_amp
id|SerialSignal_RI
)paren
suffix:semicolon
r_if
c_cond
(paren
id|delta
op_amp
id|SerialSignal_DCD
)paren
id|status
op_or_assign
id|MISCSTATUS_DCD_LATCHED
op_or
(paren
id|info-&gt;serial_signals
op_amp
id|SerialSignal_DCD
)paren
suffix:semicolon
r_if
c_cond
(paren
id|delta
op_amp
id|SerialSignal_CTS
)paren
id|status
op_or_assign
id|MISCSTATUS_CTS_LATCHED
op_or
(paren
id|info-&gt;serial_signals
op_amp
id|SerialSignal_CTS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
id|isr_io_pin
c_func
(paren
id|info
comma
id|status
)paren
suffix:semicolon
id|info-&gt;status_timer.data
op_assign
(paren
r_int
r_int
)paren
id|info
suffix:semicolon
id|info-&gt;status_timer.function
op_assign
id|status_timeout
suffix:semicolon
id|info-&gt;status_timer.expires
op_assign
id|jiffies
op_plus
id|msecs_to_jiffies
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|info-&gt;status_timer
)paren
suffix:semicolon
)brace
multiline_comment|/* Register Access Routines -&n; * All registers are memory mapped&n; */
DECL|macro|CALC_REGADDR
mdefine_line|#define CALC_REGADDR() &bslash;&n;&t;unsigned char * RegAddr = (unsigned char*)(info-&gt;sca_base + Addr); &bslash;&n;&t;if (info-&gt;port_num &gt; 1) &bslash;&n;&t;&t;RegAddr += 256;&t;    &t;&t;/* port 0-1 SCA0, 2-3 SCA1 */ &bslash;&n;&t;if ( info-&gt;port_num &amp; 1) { &bslash;&n;&t;&t;if (Addr &gt; 0x7f) &bslash;&n;&t;&t;&t;RegAddr += 0x40;&t;/* DMA access */ &bslash;&n;&t;&t;else if (Addr &gt; 0x1f &amp;&amp; Addr &lt; 0x60) &bslash;&n;&t;&t;&t;RegAddr += 0x20;&t;/* MSCI access */ &bslash;&n;&t;}
DECL|function|read_reg
r_int
r_char
id|read_reg
c_func
(paren
id|SLMP_INFO
op_star
id|info
comma
r_int
r_char
id|Addr
)paren
(brace
id|CALC_REGADDR
c_func
(paren
)paren
suffix:semicolon
r_return
op_star
id|RegAddr
suffix:semicolon
)brace
DECL|function|write_reg
r_void
id|write_reg
c_func
(paren
id|SLMP_INFO
op_star
id|info
comma
r_int
r_char
id|Addr
comma
r_int
r_char
id|Value
)paren
(brace
id|CALC_REGADDR
c_func
(paren
)paren
suffix:semicolon
op_star
id|RegAddr
op_assign
id|Value
suffix:semicolon
)brace
DECL|function|read_reg16
id|u16
id|read_reg16
c_func
(paren
id|SLMP_INFO
op_star
id|info
comma
r_int
r_char
id|Addr
)paren
(brace
id|CALC_REGADDR
c_func
(paren
)paren
suffix:semicolon
r_return
op_star
(paren
(paren
id|u16
op_star
)paren
id|RegAddr
)paren
suffix:semicolon
)brace
DECL|function|write_reg16
r_void
id|write_reg16
c_func
(paren
id|SLMP_INFO
op_star
id|info
comma
r_int
r_char
id|Addr
comma
id|u16
id|Value
)paren
(brace
id|CALC_REGADDR
c_func
(paren
)paren
suffix:semicolon
op_star
(paren
(paren
id|u16
op_star
)paren
id|RegAddr
)paren
op_assign
id|Value
suffix:semicolon
)brace
DECL|function|read_status_reg
r_int
r_char
id|read_status_reg
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
(brace
r_int
r_char
op_star
id|RegAddr
op_assign
(paren
r_int
r_char
op_star
)paren
id|info-&gt;statctrl_base
suffix:semicolon
r_return
op_star
id|RegAddr
suffix:semicolon
)brace
DECL|function|write_control_reg
r_void
id|write_control_reg
c_func
(paren
id|SLMP_INFO
op_star
id|info
)paren
(brace
r_int
r_char
op_star
id|RegAddr
op_assign
(paren
r_int
r_char
op_star
)paren
id|info-&gt;statctrl_base
suffix:semicolon
op_star
id|RegAddr
op_assign
id|info-&gt;port_array
(braket
l_int|0
)braket
op_member_access_from_pointer
id|ctrlreg_value
suffix:semicolon
)brace
DECL|function|synclinkmp_init_one
r_static
r_int
id|__devinit
id|synclinkmp_init_one
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_const
r_struct
id|pci_device_id
op_star
id|ent
)paren
(brace
r_if
c_cond
(paren
id|pci_enable_device
c_func
(paren
id|dev
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;error enabling pci device %p&bslash;n&quot;
comma
id|dev
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|device_init
c_func
(paren
op_increment
id|synclinkmp_adapter_count
comma
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|synclinkmp_remove_one
r_static
r_void
id|__devexit
id|synclinkmp_remove_one
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
)brace
eof
