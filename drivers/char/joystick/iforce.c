multiline_comment|/*&n; * $Id: iforce.c,v 1.56 2001/05/27 14:41:26 jdeneux Exp $&n; *&n; *  Copyright (c) 2000-2001 Vojtech Pavlik &lt;vojtech@suse.cz&gt;&n; *  Copyright (c) 2001 Johann Deneux &lt;deneux@ifrance.com&gt;&n; *&n; *  USB/RS232 I-Force joysticks and wheels.&n; *&n; *  Sponsored by SuSE&n; */
multiline_comment|/*&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or&n; * (at your option) any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA&n; *&n; * Should you need to contact me, the author, you can do so either by&n; * e-mail - mail your message to &lt;vojtech@suse.cz&gt;, or by paper mail:&n; * Vojtech Pavlik, Ucitelska 1576, Prague 8, 182 00 Czech Republic&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/input.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/usb.h&gt;
macro_line|#include &lt;linux/serio.h&gt;
macro_line|#include &lt;linux/config.h&gt;
multiline_comment|/* FF: This module provides arbitrary resource management routines.&n; * I use it to manage the device&squot;s memory.&n; * Despite the name of this module, I am *not* going to access the ioports.&n; */
macro_line|#include &lt;linux/ioport.h&gt;
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Vojtech Pavlik &lt;vojtech@suse.cz&gt;, Johann Deneux &lt;deneux@ifrance.com&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;USB/RS232 I-Force joysticks and wheels driver&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
DECL|macro|IFORCE_MAX_LENGTH
mdefine_line|#define IFORCE_MAX_LENGTH&t;16
macro_line|#if defined(CONFIG_INPUT_IFORCE_232) || defined(CONFIG_INPUT_IFORCE_232_MODULE)
DECL|macro|IFORCE_232
mdefine_line|#define IFORCE_232&t;1
macro_line|#endif
macro_line|#if defined(CONFIG_INPUT_IFORCE_USB) || defined(CONFIG_INPUT_IFORCE_USB_MODULE)
DECL|macro|IFORCE_USB
mdefine_line|#define IFORCE_USB&t;2
macro_line|#endif
DECL|macro|FF_EFFECTS_MAX
mdefine_line|#define FF_EFFECTS_MAX&t;32
multiline_comment|/* Each force feedback effect is made of one core effect, which can be&n; * associated to at most to effect modifiers&n; */
DECL|macro|FF_MOD1_IS_USED
mdefine_line|#define FF_MOD1_IS_USED&t;&t;0
DECL|macro|FF_MOD2_IS_USED
mdefine_line|#define FF_MOD2_IS_USED&t;&t;1
DECL|macro|FF_CORE_IS_USED
mdefine_line|#define FF_CORE_IS_USED&t;&t;2
DECL|macro|FF_CORE_IS_PLAYED
mdefine_line|#define FF_CORE_IS_PLAYED&t;3
DECL|macro|FF_MODCORE_MAX
mdefine_line|#define FF_MODCORE_MAX&t;&t;3
DECL|struct|iforce_core_effect
r_struct
id|iforce_core_effect
(brace
multiline_comment|/* Information about where modifiers are stored in the device&squot;s memory */
DECL|member|mod1_chunk
r_struct
id|resource
id|mod1_chunk
suffix:semicolon
DECL|member|mod2_chunk
r_struct
id|resource
id|mod2_chunk
suffix:semicolon
DECL|member|flags
r_int
r_int
id|flags
(braket
id|NBITS
c_func
(paren
id|FF_MODCORE_MAX
)paren
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|macro|FF_CMD_EFFECT
mdefine_line|#define FF_CMD_EFFECT&t;&t;0x010e
DECL|macro|FF_CMD_SHAPE
mdefine_line|#define FF_CMD_SHAPE&t;&t;0x0208
DECL|macro|FF_CMD_MAGNITUDE
mdefine_line|#define FF_CMD_MAGNITUDE&t;0x0303
DECL|macro|FF_CMD_PERIOD
mdefine_line|#define FF_CMD_PERIOD&t;&t;0x0407
DECL|macro|FF_CMD_INTERACT
mdefine_line|#define FF_CMD_INTERACT&t;&t;0x050a
DECL|macro|FF_CMD_AUTOCENTER
mdefine_line|#define FF_CMD_AUTOCENTER&t;0x4002
DECL|macro|FF_CMD_PLAY
mdefine_line|#define FF_CMD_PLAY&t;&t;0x4103
DECL|macro|FF_CMD_ENABLE
mdefine_line|#define FF_CMD_ENABLE&t;&t;0x4201
DECL|macro|FF_CMD_GAIN
mdefine_line|#define FF_CMD_GAIN&t;&t;0x4301
DECL|macro|FF_CMD_QUERY
mdefine_line|#define FF_CMD_QUERY&t;&t;0xff01
DECL|variable|btn_joystick
r_static
r_int
r_int
id|btn_joystick
(braket
)braket
op_assign
(brace
id|BTN_TRIGGER
comma
id|BTN_TOP
comma
id|BTN_THUMB
comma
id|BTN_TOP2
comma
id|BTN_BASE
comma
id|BTN_BASE2
comma
id|BTN_BASE3
comma
id|BTN_BASE4
comma
id|BTN_BASE5
comma
id|BTN_A
comma
id|BTN_B
comma
id|BTN_C
comma
id|BTN_DEAD
comma
op_minus
l_int|1
)brace
suffix:semicolon
DECL|variable|btn_wheel
r_static
r_int
r_int
id|btn_wheel
(braket
)braket
op_assign
(brace
id|BTN_TRIGGER
comma
id|BTN_TOP
comma
id|BTN_THUMB
comma
id|BTN_TOP2
comma
id|BTN_BASE
comma
id|BTN_BASE2
comma
id|BTN_BASE3
comma
id|BTN_BASE4
comma
id|BTN_BASE5
comma
id|BTN_A
comma
id|BTN_B
comma
id|BTN_C
comma
op_minus
l_int|1
)brace
suffix:semicolon
DECL|variable|abs_joystick
r_static
r_int
r_int
id|abs_joystick
(braket
)braket
op_assign
(brace
id|ABS_X
comma
id|ABS_Y
comma
id|ABS_THROTTLE
comma
id|ABS_HAT0X
comma
id|ABS_HAT0Y
comma
op_minus
l_int|1
)brace
suffix:semicolon
DECL|variable|abs_wheel
r_static
r_int
r_int
id|abs_wheel
(braket
)braket
op_assign
(brace
id|ABS_WHEEL
comma
id|ABS_GAS
comma
id|ABS_BRAKE
comma
id|ABS_HAT0X
comma
id|ABS_HAT0Y
comma
op_minus
l_int|1
)brace
suffix:semicolon
DECL|variable|ff_iforce
r_static
r_int
r_int
id|ff_iforce
(braket
)braket
op_assign
(brace
id|FF_PERIODIC
comma
id|FF_CONSTANT
comma
id|FF_SPRING
comma
id|FF_FRICTION
comma
id|FF_SQUARE
comma
id|FF_TRIANGLE
comma
id|FF_SINE
comma
id|FF_SAW_UP
comma
id|FF_SAW_DOWN
comma
id|FF_GAIN
comma
id|FF_AUTOCENTER
comma
op_minus
l_int|1
)brace
suffix:semicolon
DECL|struct|iforce_device
r_static
r_struct
id|iforce_device
(brace
DECL|member|idvendor
id|u16
id|idvendor
suffix:semicolon
DECL|member|idproduct
id|u16
id|idproduct
suffix:semicolon
DECL|member|name
r_char
op_star
id|name
suffix:semicolon
DECL|member|btn
r_int
r_int
op_star
id|btn
suffix:semicolon
DECL|member|abs
r_int
r_int
op_star
id|abs
suffix:semicolon
DECL|member|ff
r_int
r_int
op_star
id|ff
suffix:semicolon
DECL|variable|iforce_device
)brace
id|iforce_device
(braket
)braket
op_assign
(brace
(brace
l_int|0x046d
comma
l_int|0xc281
comma
l_string|&quot;Logitech WingMan Force&quot;
comma
id|btn_joystick
comma
id|abs_joystick
comma
id|ff_iforce
)brace
comma
(brace
l_int|0x046d
comma
l_int|0xc291
comma
l_string|&quot;Logitech WingMan Formula Force&quot;
comma
id|btn_wheel
comma
id|abs_wheel
comma
id|ff_iforce
)brace
comma
(brace
l_int|0x05ef
comma
l_int|0x020a
comma
l_string|&quot;AVB Top Shot Pegasus&quot;
comma
id|btn_joystick
comma
id|abs_joystick
comma
id|ff_iforce
)brace
comma
(brace
l_int|0x05ef
comma
l_int|0x8884
comma
l_string|&quot;AVB Mag Turbo Force&quot;
comma
id|btn_wheel
comma
id|abs_wheel
comma
id|ff_iforce
)brace
comma
(brace
l_int|0x06f8
comma
l_int|0x0001
comma
l_string|&quot;Guillemot Race Leader Force Feedback&quot;
comma
id|btn_wheel
comma
id|abs_wheel
comma
id|ff_iforce
)brace
comma
(brace
l_int|0x0000
comma
l_int|0x0000
comma
l_string|&quot;Unknown I-Force Device [%04x:%04x]&quot;
comma
id|btn_joystick
comma
id|abs_joystick
comma
id|ff_iforce
)brace
)brace
suffix:semicolon
DECL|struct|iforce
r_struct
id|iforce
(brace
DECL|member|dev
r_struct
id|input_dev
id|dev
suffix:semicolon
multiline_comment|/* Input device interface */
DECL|member|type
r_struct
id|iforce_device
op_star
id|type
suffix:semicolon
DECL|member|name
r_char
id|name
(braket
l_int|64
)braket
suffix:semicolon
DECL|member|open
r_int
id|open
suffix:semicolon
DECL|member|bus
r_int
id|bus
suffix:semicolon
DECL|member|data
r_int
r_char
id|data
(braket
id|IFORCE_MAX_LENGTH
)braket
suffix:semicolon
DECL|member|edata
r_int
r_char
id|edata
(braket
id|IFORCE_MAX_LENGTH
)braket
suffix:semicolon
DECL|member|ecmd
id|u16
id|ecmd
suffix:semicolon
DECL|member|expect_packet
id|u16
id|expect_packet
suffix:semicolon
macro_line|#ifdef IFORCE_232
DECL|member|serio
r_struct
id|serio
op_star
id|serio
suffix:semicolon
multiline_comment|/* RS232 transfer */
DECL|member|idx
DECL|member|pkt
DECL|member|len
DECL|member|id
r_int
id|idx
comma
id|pkt
comma
id|len
comma
id|id
suffix:semicolon
DECL|member|csum
r_int
r_char
id|csum
suffix:semicolon
macro_line|#endif
macro_line|#ifdef IFORCE_USB
DECL|member|usbdev
r_struct
id|usb_device
op_star
id|usbdev
suffix:semicolon
multiline_comment|/* USB transfer */
DECL|member|irq
DECL|member|out
DECL|member|ctrl
r_struct
id|urb
id|irq
comma
id|out
comma
id|ctrl
suffix:semicolon
DECL|member|dr
r_struct
id|usb_ctrlrequest
id|dr
suffix:semicolon
macro_line|#endif
multiline_comment|/* Force Feedback */
DECL|member|wait
id|wait_queue_head_t
id|wait
suffix:semicolon
DECL|member|device_memory
r_struct
id|resource
id|device_memory
suffix:semicolon
DECL|member|core_effects
r_struct
id|iforce_core_effect
id|core_effects
(braket
id|FF_EFFECTS_MAX
)braket
suffix:semicolon
)brace
suffix:semicolon
r_static
r_struct
(brace
DECL|member|x
id|__s32
id|x
suffix:semicolon
DECL|member|y
id|__s32
id|y
suffix:semicolon
DECL|variable|iforce_hat_to_axis
)brace
id|iforce_hat_to_axis
(braket
l_int|16
)braket
op_assign
(brace
(brace
l_int|0
comma
op_minus
l_int|1
)brace
comma
(brace
l_int|1
comma
op_minus
l_int|1
)brace
comma
(brace
l_int|1
comma
l_int|0
)brace
comma
(brace
l_int|1
comma
l_int|1
)brace
comma
(brace
l_int|0
comma
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|1
)brace
comma
(brace
op_minus
l_int|1
comma
l_int|0
)brace
comma
(brace
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
)brace
suffix:semicolon
multiline_comment|/* Get hi and low bytes of a 16-bits int */
DECL|macro|HI
mdefine_line|#define HI(a)&t;((unsigned char)((a) &gt;&gt; 8))
DECL|macro|LO
mdefine_line|#define LO(a)&t;((unsigned char)((a) &amp; 0xff))
multiline_comment|/* Encode a time value */
DECL|macro|TIME_SCALE
mdefine_line|#define TIME_SCALE(a)&t;((a) == 0xffff ? 0xffff : (a) * 1000 / 256)
DECL|function|dump_packet
r_static
r_void
id|dump_packet
c_func
(paren
r_char
op_star
id|msg
comma
id|u16
id|cmd
comma
r_int
r_char
op_star
id|data
)paren
(brace
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;iforce.c: %s ( cmd = %04x, data = &quot;
comma
id|msg
comma
id|cmd
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|LO
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|i
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%02x &quot;
comma
id|data
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;)&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Send a packet of bytes to the device&n; */
DECL|function|send_packet
r_static
r_void
id|send_packet
c_func
(paren
r_struct
id|iforce
op_star
id|iforce
comma
id|u16
id|cmd
comma
r_int
r_char
op_star
id|data
)paren
(brace
r_switch
c_cond
(paren
id|iforce-&gt;bus
)paren
(brace
macro_line|#ifdef IFORCE_232
r_case
id|IFORCE_232
suffix:colon
(brace
r_int
id|i
suffix:semicolon
r_int
r_char
id|csum
op_assign
l_int|0x2b
op_xor
id|HI
c_func
(paren
id|cmd
)paren
op_xor
id|LO
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|serio_write
c_func
(paren
id|iforce-&gt;serio
comma
l_int|0x2b
)paren
suffix:semicolon
id|serio_write
c_func
(paren
id|iforce-&gt;serio
comma
id|HI
c_func
(paren
id|cmd
)paren
)paren
suffix:semicolon
id|serio_write
c_func
(paren
id|iforce-&gt;serio
comma
id|LO
c_func
(paren
id|cmd
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|LO
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|serio_write
c_func
(paren
id|iforce-&gt;serio
comma
id|data
(braket
id|i
)braket
)paren
suffix:semicolon
id|csum
op_assign
id|csum
op_xor
id|data
(braket
id|i
)braket
suffix:semicolon
)brace
id|serio_write
c_func
(paren
id|iforce-&gt;serio
comma
id|csum
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifdef IFORCE_USB
r_case
id|IFORCE_USB
suffix:colon
(brace
id|DECLARE_WAITQUEUE
c_func
(paren
id|wait
comma
id|current
)paren
suffix:semicolon
r_int
id|timeout
op_assign
id|HZ
suffix:semicolon
multiline_comment|/* 1 second */
id|memcpy
c_func
(paren
id|iforce-&gt;out.transfer_buffer
op_plus
l_int|1
comma
id|data
comma
id|LO
c_func
(paren
id|cmd
)paren
)paren
suffix:semicolon
(paren
(paren
r_char
op_star
)paren
id|iforce-&gt;out.transfer_buffer
)paren
(braket
l_int|0
)braket
op_assign
id|HI
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|iforce-&gt;out.transfer_buffer_length
op_assign
id|LO
c_func
(paren
id|cmd
)paren
op_plus
l_int|2
suffix:semicolon
id|iforce-&gt;out.dev
op_assign
id|iforce-&gt;usbdev
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|add_wait_queue
c_func
(paren
op_amp
id|iforce-&gt;wait
comma
op_amp
id|wait
)paren
suffix:semicolon
r_if
c_cond
(paren
id|usb_submit_urb
c_func
(paren
op_amp
id|iforce-&gt;out
)paren
)paren
(brace
id|set_current_state
c_func
(paren
id|TASK_RUNNING
)paren
suffix:semicolon
id|remove_wait_queue
c_func
(paren
op_amp
id|iforce-&gt;wait
comma
op_amp
id|wait
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_while
c_loop
(paren
id|timeout
op_logical_and
id|iforce-&gt;out.status
op_eq
op_minus
id|EINPROGRESS
)paren
id|timeout
op_assign
id|schedule_timeout
c_func
(paren
id|timeout
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_RUNNING
)paren
suffix:semicolon
id|remove_wait_queue
c_func
(paren
op_amp
id|iforce-&gt;wait
comma
op_amp
id|wait
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|timeout
)paren
id|usb_unlink_urb
c_func
(paren
op_amp
id|iforce-&gt;out
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#endif
)brace
)brace
DECL|function|iforce_process_packet
r_static
r_void
id|iforce_process_packet
c_func
(paren
r_struct
id|iforce
op_star
id|iforce
comma
id|u16
id|cmd
comma
r_int
r_char
op_star
id|data
)paren
(brace
r_struct
id|input_dev
op_star
id|dev
op_assign
op_amp
id|iforce-&gt;dev
suffix:semicolon
r_int
id|i
suffix:semicolon
macro_line|#ifdef IFORCE_232
r_if
c_cond
(paren
id|HI
c_func
(paren
id|iforce-&gt;expect_packet
)paren
op_eq
id|HI
c_func
(paren
id|cmd
)paren
)paren
(brace
id|iforce-&gt;expect_packet
op_assign
l_int|0
suffix:semicolon
id|iforce-&gt;ecmd
op_assign
id|cmd
suffix:semicolon
id|memcpy
c_func
(paren
id|iforce-&gt;edata
comma
id|data
comma
id|IFORCE_MAX_LENGTH
)paren
suffix:semicolon
r_if
c_cond
(paren
id|waitqueue_active
c_func
(paren
op_amp
id|iforce-&gt;wait
)paren
)paren
id|wake_up
c_func
(paren
op_amp
id|iforce-&gt;wait
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|iforce-&gt;type
)paren
r_return
suffix:semicolon
r_switch
c_cond
(paren
id|HI
c_func
(paren
id|cmd
)paren
)paren
(brace
r_case
l_int|0x01
suffix:colon
multiline_comment|/* joystick position data */
r_case
l_int|0x03
suffix:colon
multiline_comment|/* wheel position data */
r_if
c_cond
(paren
id|HI
c_func
(paren
id|cmd
)paren
op_eq
l_int|1
)paren
(brace
id|input_report_abs
c_func
(paren
id|dev
comma
id|ABS_X
comma
(paren
id|__s16
)paren
(paren
(paren
(paren
id|__s16
)paren
id|data
(braket
l_int|1
)braket
op_lshift
l_int|8
)paren
op_or
id|data
(braket
l_int|0
)braket
)paren
)paren
suffix:semicolon
id|input_report_abs
c_func
(paren
id|dev
comma
id|ABS_Y
comma
(paren
id|__s16
)paren
(paren
(paren
(paren
id|__s16
)paren
id|data
(braket
l_int|3
)braket
op_lshift
l_int|8
)paren
op_or
id|data
(braket
l_int|2
)braket
)paren
)paren
suffix:semicolon
id|input_report_abs
c_func
(paren
id|dev
comma
id|ABS_THROTTLE
comma
l_int|255
op_minus
id|data
(braket
l_int|4
)braket
)paren
suffix:semicolon
)brace
r_else
(brace
id|input_report_abs
c_func
(paren
id|dev
comma
id|ABS_WHEEL
comma
(paren
id|__s16
)paren
(paren
(paren
(paren
id|__s16
)paren
id|data
(braket
l_int|1
)braket
op_lshift
l_int|8
)paren
op_or
id|data
(braket
l_int|0
)braket
)paren
)paren
suffix:semicolon
id|input_report_abs
c_func
(paren
id|dev
comma
id|ABS_GAS
comma
l_int|255
op_minus
id|data
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|input_report_abs
c_func
(paren
id|dev
comma
id|ABS_BRAKE
comma
l_int|255
op_minus
id|data
(braket
l_int|3
)braket
)paren
suffix:semicolon
)brace
id|input_report_abs
c_func
(paren
id|dev
comma
id|ABS_HAT0X
comma
id|iforce_hat_to_axis
(braket
id|data
(braket
l_int|6
)braket
op_rshift
l_int|4
)braket
dot
id|x
)paren
suffix:semicolon
id|input_report_abs
c_func
(paren
id|dev
comma
id|ABS_HAT0Y
comma
id|iforce_hat_to_axis
(braket
id|data
(braket
l_int|6
)braket
op_rshift
l_int|4
)braket
dot
id|y
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|iforce-&gt;type-&gt;btn
(braket
id|i
)braket
op_ge
l_int|0
suffix:semicolon
id|i
op_increment
)paren
id|input_report_key
c_func
(paren
id|dev
comma
id|iforce-&gt;type-&gt;btn
(braket
id|i
)braket
comma
id|data
(braket
(paren
id|i
op_rshift
l_int|3
)paren
op_plus
l_int|5
)braket
op_amp
(paren
l_int|1
op_lshift
(paren
id|i
op_amp
l_int|7
)paren
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x02
suffix:colon
multiline_comment|/* status report */
id|input_report_key
c_func
(paren
id|dev
comma
id|BTN_DEAD
comma
id|data
(braket
l_int|0
)braket
op_amp
l_int|0x02
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
DECL|function|get_id_packet
r_static
r_int
id|get_id_packet
c_func
(paren
r_struct
id|iforce
op_star
id|iforce
comma
r_char
op_star
id|packet
)paren
(brace
id|DECLARE_WAITQUEUE
c_func
(paren
id|wait
comma
id|current
)paren
suffix:semicolon
r_int
id|timeout
op_assign
id|HZ
suffix:semicolon
multiline_comment|/* 1 second */
r_switch
c_cond
(paren
id|iforce-&gt;bus
)paren
(brace
macro_line|#ifdef IFORCE_USB
r_case
id|IFORCE_USB
suffix:colon
id|iforce-&gt;dr.bRequest
op_assign
id|packet
(braket
l_int|0
)braket
suffix:semicolon
id|iforce-&gt;ctrl.dev
op_assign
id|iforce-&gt;usbdev
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|add_wait_queue
c_func
(paren
op_amp
id|iforce-&gt;wait
comma
op_amp
id|wait
)paren
suffix:semicolon
r_if
c_cond
(paren
id|usb_submit_urb
c_func
(paren
op_amp
id|iforce-&gt;ctrl
)paren
)paren
(brace
id|set_current_state
c_func
(paren
id|TASK_RUNNING
)paren
suffix:semicolon
id|remove_wait_queue
c_func
(paren
op_amp
id|iforce-&gt;wait
comma
op_amp
id|wait
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_while
c_loop
(paren
id|timeout
op_logical_and
id|iforce-&gt;ctrl.status
op_eq
op_minus
id|EINPROGRESS
)paren
id|timeout
op_assign
id|schedule_timeout
c_func
(paren
id|timeout
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_RUNNING
)paren
suffix:semicolon
id|remove_wait_queue
c_func
(paren
op_amp
id|iforce-&gt;wait
comma
op_amp
id|wait
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|timeout
)paren
(brace
id|usb_unlink_urb
c_func
(paren
op_amp
id|iforce-&gt;ctrl
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
macro_line|#endif
macro_line|#ifdef IFORCE_232
r_case
id|IFORCE_232
suffix:colon
id|iforce-&gt;expect_packet
op_assign
id|FF_CMD_QUERY
suffix:semicolon
id|send_packet
c_func
(paren
id|iforce
comma
id|FF_CMD_QUERY
comma
id|packet
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|add_wait_queue
c_func
(paren
op_amp
id|iforce-&gt;wait
comma
op_amp
id|wait
)paren
suffix:semicolon
r_while
c_loop
(paren
id|timeout
op_logical_and
id|iforce-&gt;expect_packet
)paren
id|timeout
op_assign
id|schedule_timeout
c_func
(paren
id|timeout
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_RUNNING
)paren
suffix:semicolon
id|remove_wait_queue
c_func
(paren
op_amp
id|iforce-&gt;wait
comma
op_amp
id|wait
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|timeout
)paren
(brace
id|iforce-&gt;expect_packet
op_assign
l_int|0
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
macro_line|#endif
)brace
r_return
op_minus
(paren
id|iforce-&gt;edata
(braket
l_int|0
)braket
op_ne
id|packet
(braket
l_int|0
)braket
)paren
suffix:semicolon
)brace
DECL|function|iforce_open
r_static
r_int
id|iforce_open
c_func
(paren
r_struct
id|input_dev
op_star
id|dev
)paren
(brace
r_struct
id|iforce
op_star
id|iforce
op_assign
id|dev
op_member_access_from_pointer
r_private
suffix:semicolon
r_switch
c_cond
(paren
id|iforce-&gt;bus
)paren
(brace
macro_line|#ifdef IFORCE_USB
r_case
id|IFORCE_USB
suffix:colon
r_if
c_cond
(paren
id|iforce-&gt;open
op_increment
)paren
r_break
suffix:semicolon
id|iforce-&gt;irq.dev
op_assign
id|iforce-&gt;usbdev
suffix:semicolon
r_if
c_cond
(paren
id|usb_submit_urb
c_func
(paren
op_amp
id|iforce-&gt;irq
)paren
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|iforce_close
r_static
r_void
id|iforce_close
c_func
(paren
r_struct
id|input_dev
op_star
id|dev
)paren
(brace
r_struct
id|iforce
op_star
id|iforce
op_assign
id|dev
op_member_access_from_pointer
r_private
suffix:semicolon
r_switch
c_cond
(paren
id|iforce-&gt;bus
)paren
(brace
macro_line|#ifdef IFORCE_USB
r_case
id|IFORCE_USB
suffix:colon
r_if
c_cond
(paren
op_logical_neg
op_decrement
id|iforce-&gt;open
)paren
id|usb_unlink_urb
c_func
(paren
op_amp
id|iforce-&gt;irq
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
)brace
)brace
multiline_comment|/*&n; * Start or stop playing an effect&n; */
DECL|function|iforce_input_event
r_static
r_int
id|iforce_input_event
c_func
(paren
r_struct
id|input_dev
op_star
id|dev
comma
r_int
r_int
id|type
comma
r_int
r_int
id|code
comma
r_int
id|value
)paren
(brace
r_struct
id|iforce
op_star
id|iforce
op_assign
(paren
r_struct
id|iforce
op_star
)paren
(paren
id|dev
op_member_access_from_pointer
r_private
)paren
suffix:semicolon
r_int
r_char
id|data
(braket
l_int|3
)braket
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;iforce.c: input_event(type = %d, code = %d, value = %d)&bslash;n&quot;
comma
id|type
comma
id|code
comma
id|value
)paren
suffix:semicolon
r_if
c_cond
(paren
id|type
op_ne
id|EV_FF
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_switch
c_cond
(paren
id|code
)paren
(brace
r_case
id|FF_GAIN
suffix:colon
id|data
(braket
l_int|0
)braket
op_assign
id|value
op_rshift
l_int|9
suffix:semicolon
id|send_packet
c_func
(paren
id|iforce
comma
id|FF_CMD_GAIN
comma
id|data
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|FF_AUTOCENTER
suffix:colon
id|data
(braket
l_int|0
)braket
op_assign
l_int|0x03
suffix:semicolon
id|data
(braket
l_int|1
)braket
op_assign
id|value
op_rshift
l_int|9
suffix:semicolon
id|send_packet
c_func
(paren
id|iforce
comma
id|FF_CMD_AUTOCENTER
comma
id|data
)paren
suffix:semicolon
id|data
(braket
l_int|0
)braket
op_assign
l_int|0x04
suffix:semicolon
id|data
(braket
l_int|1
)braket
op_assign
l_int|0x01
suffix:semicolon
id|send_packet
c_func
(paren
id|iforce
comma
id|FF_CMD_AUTOCENTER
comma
id|data
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_default
suffix:colon
(brace
)brace
multiline_comment|/* Play an effect */
r_if
c_cond
(paren
id|code
op_ge
id|iforce-&gt;dev.ff_effects_max
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|data
(braket
l_int|0
)braket
op_assign
id|LO
c_func
(paren
id|code
)paren
suffix:semicolon
id|data
(braket
l_int|1
)braket
op_assign
(paren
id|value
OG
l_int|0
)paren
ques
c_cond
(paren
(paren
id|value
OG
l_int|1
)paren
ques
c_cond
l_int|0x41
suffix:colon
l_int|0x01
)paren
suffix:colon
l_int|0
suffix:semicolon
id|data
(braket
l_int|2
)braket
op_assign
id|LO
c_func
(paren
id|value
)paren
suffix:semicolon
id|send_packet
c_func
(paren
id|iforce
comma
id|FF_CMD_PLAY
comma
id|data
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; * Set the magnitude of a constant force effect&n; * Return error code&n; *&n; * Note: caller must ensure exclusive access to device&n; */
DECL|function|make_magnitude_modifier
r_static
r_int
id|make_magnitude_modifier
c_func
(paren
r_struct
id|iforce
op_star
id|iforce
comma
r_struct
id|resource
op_star
id|mod_chunk
comma
id|__s16
id|level
)paren
(brace
r_int
r_char
id|data
(braket
l_int|3
)braket
suffix:semicolon
r_if
c_cond
(paren
id|allocate_resource
c_func
(paren
op_amp
(paren
id|iforce-&gt;device_memory
)paren
comma
id|mod_chunk
comma
l_int|2
comma
id|iforce-&gt;device_memory.start
comma
id|iforce-&gt;device_memory.end
comma
l_int|2L
comma
l_int|NULL
comma
l_int|NULL
)paren
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|data
(braket
l_int|0
)braket
op_assign
id|LO
c_func
(paren
id|mod_chunk-&gt;start
)paren
suffix:semicolon
id|data
(braket
l_int|1
)braket
op_assign
id|HI
c_func
(paren
id|mod_chunk-&gt;start
)paren
suffix:semicolon
id|data
(braket
l_int|2
)braket
op_assign
id|HI
c_func
(paren
id|level
)paren
suffix:semicolon
id|send_packet
c_func
(paren
id|iforce
comma
id|FF_CMD_MAGNITUDE
comma
id|data
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Upload the component of an effect dealing with the period, phase and magnitude&n; */
DECL|function|make_period_modifier
r_static
r_int
id|make_period_modifier
c_func
(paren
r_struct
id|iforce
op_star
id|iforce
comma
r_struct
id|resource
op_star
id|mod_chunk
comma
id|__s16
id|magnitude
comma
id|__s16
id|offset
comma
id|u16
id|period
comma
id|u16
id|phase
)paren
(brace
r_int
r_char
id|data
(braket
l_int|7
)braket
suffix:semicolon
id|period
op_assign
id|TIME_SCALE
c_func
(paren
id|period
)paren
suffix:semicolon
r_if
c_cond
(paren
id|allocate_resource
c_func
(paren
op_amp
(paren
id|iforce-&gt;device_memory
)paren
comma
id|mod_chunk
comma
l_int|0x0c
comma
id|iforce-&gt;device_memory.start
comma
id|iforce-&gt;device_memory.end
comma
l_int|2L
comma
l_int|NULL
comma
l_int|NULL
)paren
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|data
(braket
l_int|0
)braket
op_assign
id|LO
c_func
(paren
id|mod_chunk-&gt;start
)paren
suffix:semicolon
id|data
(braket
l_int|1
)braket
op_assign
id|HI
c_func
(paren
id|mod_chunk-&gt;start
)paren
suffix:semicolon
id|data
(braket
l_int|2
)braket
op_assign
id|HI
c_func
(paren
id|magnitude
)paren
suffix:semicolon
id|data
(braket
l_int|3
)braket
op_assign
id|HI
c_func
(paren
id|offset
)paren
suffix:semicolon
id|data
(braket
l_int|4
)braket
op_assign
id|HI
c_func
(paren
id|phase
)paren
suffix:semicolon
id|data
(braket
l_int|5
)braket
op_assign
id|LO
c_func
(paren
id|period
)paren
suffix:semicolon
id|data
(braket
l_int|6
)braket
op_assign
id|HI
c_func
(paren
id|period
)paren
suffix:semicolon
id|send_packet
c_func
(paren
id|iforce
comma
id|FF_CMD_PERIOD
comma
id|data
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Uploads the part of an effect setting the shape of the force&n; */
DECL|function|make_shape_modifier
r_static
r_int
id|make_shape_modifier
c_func
(paren
r_struct
id|iforce
op_star
id|iforce
comma
r_struct
id|resource
op_star
id|mod_chunk
comma
id|u16
id|attack_duration
comma
id|__s16
id|initial_level
comma
id|u16
id|fade_duration
comma
id|__s16
id|final_level
)paren
(brace
r_int
r_char
id|data
(braket
l_int|8
)braket
suffix:semicolon
id|attack_duration
op_assign
id|TIME_SCALE
c_func
(paren
id|attack_duration
)paren
suffix:semicolon
id|fade_duration
op_assign
id|TIME_SCALE
c_func
(paren
id|fade_duration
)paren
suffix:semicolon
r_if
c_cond
(paren
id|allocate_resource
c_func
(paren
op_amp
(paren
id|iforce-&gt;device_memory
)paren
comma
id|mod_chunk
comma
l_int|0x0e
comma
id|iforce-&gt;device_memory.start
comma
id|iforce-&gt;device_memory.end
comma
l_int|2L
comma
l_int|NULL
comma
l_int|NULL
)paren
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|data
(braket
l_int|0
)braket
op_assign
id|LO
c_func
(paren
id|mod_chunk-&gt;start
)paren
suffix:semicolon
id|data
(braket
l_int|1
)braket
op_assign
id|HI
c_func
(paren
id|mod_chunk-&gt;start
)paren
suffix:semicolon
id|data
(braket
l_int|2
)braket
op_assign
id|LO
c_func
(paren
id|attack_duration
)paren
suffix:semicolon
id|data
(braket
l_int|3
)braket
op_assign
id|HI
c_func
(paren
id|attack_duration
)paren
suffix:semicolon
id|data
(braket
l_int|4
)braket
op_assign
id|HI
c_func
(paren
id|initial_level
)paren
suffix:semicolon
id|data
(braket
l_int|5
)braket
op_assign
id|LO
c_func
(paren
id|fade_duration
)paren
suffix:semicolon
id|data
(braket
l_int|6
)braket
op_assign
id|HI
c_func
(paren
id|fade_duration
)paren
suffix:semicolon
id|data
(braket
l_int|7
)braket
op_assign
id|HI
c_func
(paren
id|final_level
)paren
suffix:semicolon
id|send_packet
c_func
(paren
id|iforce
comma
id|FF_CMD_SHAPE
comma
id|data
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Component of spring, friction, inertia... effects&n; */
DECL|function|make_interactive_modifier
r_static
r_int
id|make_interactive_modifier
c_func
(paren
r_struct
id|iforce
op_star
id|iforce
comma
r_struct
id|resource
op_star
id|mod_chunk
comma
id|__s16
id|rsat
comma
id|__s16
id|lsat
comma
id|__s16
id|rk
comma
id|__s16
id|lk
comma
id|u16
id|db
comma
id|__s16
id|center
)paren
(brace
r_int
r_char
id|data
(braket
l_int|10
)braket
suffix:semicolon
r_if
c_cond
(paren
id|allocate_resource
c_func
(paren
op_amp
(paren
id|iforce-&gt;device_memory
)paren
comma
id|mod_chunk
comma
l_int|8
comma
id|iforce-&gt;device_memory.start
comma
id|iforce-&gt;device_memory.end
comma
l_int|2L
comma
l_int|NULL
comma
l_int|NULL
)paren
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|data
(braket
l_int|0
)braket
op_assign
id|LO
c_func
(paren
id|mod_chunk-&gt;start
)paren
suffix:semicolon
id|data
(braket
l_int|1
)braket
op_assign
id|HI
c_func
(paren
id|mod_chunk-&gt;start
)paren
suffix:semicolon
id|data
(braket
l_int|2
)braket
op_assign
id|HI
c_func
(paren
id|rk
)paren
suffix:semicolon
id|data
(braket
l_int|3
)braket
op_assign
id|HI
c_func
(paren
id|lk
)paren
suffix:semicolon
id|data
(braket
l_int|4
)braket
op_assign
id|LO
c_func
(paren
id|center
)paren
suffix:semicolon
id|data
(braket
l_int|5
)braket
op_assign
id|HI
c_func
(paren
id|center
)paren
suffix:semicolon
id|data
(braket
l_int|6
)braket
op_assign
id|LO
c_func
(paren
id|db
)paren
suffix:semicolon
id|data
(braket
l_int|7
)braket
op_assign
id|HI
c_func
(paren
id|db
)paren
suffix:semicolon
id|data
(braket
l_int|8
)braket
op_assign
id|HI
c_func
(paren
id|rsat
)paren
suffix:semicolon
id|data
(braket
l_int|9
)braket
op_assign
id|HI
c_func
(paren
id|lsat
)paren
suffix:semicolon
id|send_packet
c_func
(paren
id|iforce
comma
id|FF_CMD_INTERACT
comma
id|data
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|find_button
r_static
r_int
r_char
id|find_button
c_func
(paren
r_struct
id|iforce
op_star
id|iforce
comma
r_int
r_int
id|button
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|iforce-&gt;type-&gt;btn
(braket
id|i
)braket
op_ge
l_int|0
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|iforce-&gt;type-&gt;btn
(braket
id|i
)braket
op_eq
id|button
)paren
r_return
id|i
op_plus
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Send the part common to all effects to the device&n; */
DECL|function|make_core
r_static
r_int
id|make_core
c_func
(paren
r_struct
id|iforce
op_star
id|iforce
comma
id|u16
id|id
comma
id|u16
id|mod_id1
comma
id|u16
id|mod_id2
comma
id|u8
id|effect_type
comma
id|u8
id|axes
comma
id|u16
id|duration
comma
id|u16
id|delay
comma
id|u16
id|button
comma
id|u16
id|interval
comma
id|u16
id|direction
)paren
(brace
r_int
r_char
id|data
(braket
l_int|14
)braket
suffix:semicolon
id|duration
op_assign
id|TIME_SCALE
c_func
(paren
id|duration
)paren
suffix:semicolon
id|delay
op_assign
id|TIME_SCALE
c_func
(paren
id|delay
)paren
suffix:semicolon
id|interval
op_assign
id|TIME_SCALE
c_func
(paren
id|interval
)paren
suffix:semicolon
id|data
(braket
l_int|0
)braket
op_assign
id|LO
c_func
(paren
id|id
)paren
suffix:semicolon
id|data
(braket
l_int|1
)braket
op_assign
id|effect_type
suffix:semicolon
id|data
(braket
l_int|2
)braket
op_assign
id|LO
c_func
(paren
id|axes
)paren
op_or
id|find_button
c_func
(paren
id|iforce
comma
id|button
)paren
suffix:semicolon
id|data
(braket
l_int|3
)braket
op_assign
id|LO
c_func
(paren
id|duration
)paren
suffix:semicolon
id|data
(braket
l_int|4
)braket
op_assign
id|HI
c_func
(paren
id|duration
)paren
suffix:semicolon
id|data
(braket
l_int|5
)braket
op_assign
id|HI
c_func
(paren
id|direction
)paren
suffix:semicolon
id|data
(braket
l_int|6
)braket
op_assign
id|LO
c_func
(paren
id|interval
)paren
suffix:semicolon
id|data
(braket
l_int|7
)braket
op_assign
id|HI
c_func
(paren
id|interval
)paren
suffix:semicolon
id|data
(braket
l_int|8
)braket
op_assign
id|LO
c_func
(paren
id|mod_id1
)paren
suffix:semicolon
id|data
(braket
l_int|9
)braket
op_assign
id|HI
c_func
(paren
id|mod_id1
)paren
suffix:semicolon
id|data
(braket
l_int|10
)braket
op_assign
id|LO
c_func
(paren
id|mod_id2
)paren
suffix:semicolon
id|data
(braket
l_int|11
)braket
op_assign
id|HI
c_func
(paren
id|mod_id2
)paren
suffix:semicolon
id|data
(braket
l_int|12
)braket
op_assign
id|LO
c_func
(paren
id|delay
)paren
suffix:semicolon
id|data
(braket
l_int|13
)braket
op_assign
id|HI
c_func
(paren
id|delay
)paren
suffix:semicolon
id|send_packet
c_func
(paren
id|iforce
comma
id|FF_CMD_EFFECT
comma
id|data
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Upload a periodic effect to the device&n; */
DECL|function|iforce_upload_periodic
r_static
r_int
id|iforce_upload_periodic
c_func
(paren
r_struct
id|iforce
op_star
id|iforce
comma
r_struct
id|ff_effect
op_star
id|effect
)paren
(brace
id|u8
id|wave_code
suffix:semicolon
r_int
id|core_id
op_assign
id|effect-&gt;id
suffix:semicolon
r_struct
id|iforce_core_effect
op_star
id|core_effect
op_assign
id|iforce-&gt;core_effects
op_plus
id|core_id
suffix:semicolon
r_struct
id|resource
op_star
id|mod1_chunk
op_assign
op_amp
(paren
id|iforce-&gt;core_effects
(braket
id|core_id
)braket
dot
id|mod1_chunk
)paren
suffix:semicolon
r_struct
id|resource
op_star
id|mod2_chunk
op_assign
op_amp
(paren
id|iforce-&gt;core_effects
(braket
id|core_id
)braket
dot
id|mod2_chunk
)paren
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
id|err
op_assign
id|make_period_modifier
c_func
(paren
id|iforce
comma
id|mod1_chunk
comma
id|effect-&gt;u.periodic.magnitude
comma
id|effect-&gt;u.periodic.offset
comma
id|effect-&gt;u.periodic.period
comma
id|effect-&gt;u.periodic.phase
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_return
id|err
suffix:semicolon
id|set_bit
c_func
(paren
id|FF_MOD1_IS_USED
comma
id|core_effect-&gt;flags
)paren
suffix:semicolon
id|err
op_assign
id|make_shape_modifier
c_func
(paren
id|iforce
comma
id|mod2_chunk
comma
id|effect-&gt;u.periodic.shape.attack_length
comma
id|effect-&gt;u.periodic.shape.attack_level
comma
id|effect-&gt;u.periodic.shape.fade_length
comma
id|effect-&gt;u.periodic.shape.fade_level
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_return
id|err
suffix:semicolon
id|set_bit
c_func
(paren
id|FF_MOD2_IS_USED
comma
id|core_effect-&gt;flags
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|effect-&gt;u.periodic.waveform
)paren
(brace
r_case
id|FF_SQUARE
suffix:colon
id|wave_code
op_assign
l_int|0x20
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FF_TRIANGLE
suffix:colon
id|wave_code
op_assign
l_int|0x21
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FF_SINE
suffix:colon
id|wave_code
op_assign
l_int|0x22
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FF_SAW_UP
suffix:colon
id|wave_code
op_assign
l_int|0x23
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FF_SAW_DOWN
suffix:colon
id|wave_code
op_assign
l_int|0x24
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|wave_code
op_assign
l_int|0x20
suffix:semicolon
r_break
suffix:semicolon
)brace
id|err
op_assign
id|make_core
c_func
(paren
id|iforce
comma
id|effect-&gt;id
comma
id|mod1_chunk-&gt;start
comma
id|mod2_chunk-&gt;start
comma
id|wave_code
comma
l_int|0x20
comma
id|effect-&gt;replay.length
comma
id|effect-&gt;replay.delay
comma
id|effect-&gt;trigger.button
comma
id|effect-&gt;trigger.interval
comma
id|effect-&gt;u.periodic.direction
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*&n; * Upload a constant force effect&n; */
DECL|function|iforce_upload_constant
r_static
r_int
id|iforce_upload_constant
c_func
(paren
r_struct
id|iforce
op_star
id|iforce
comma
r_struct
id|ff_effect
op_star
id|effect
)paren
(brace
r_int
id|core_id
op_assign
id|effect-&gt;id
suffix:semicolon
r_struct
id|iforce_core_effect
op_star
id|core_effect
op_assign
id|iforce-&gt;core_effects
op_plus
id|core_id
suffix:semicolon
r_struct
id|resource
op_star
id|mod1_chunk
op_assign
op_amp
(paren
id|iforce-&gt;core_effects
(braket
id|core_id
)braket
dot
id|mod1_chunk
)paren
suffix:semicolon
r_struct
id|resource
op_star
id|mod2_chunk
op_assign
op_amp
(paren
id|iforce-&gt;core_effects
(braket
id|core_id
)braket
dot
id|mod2_chunk
)paren
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;iforce.c: make constant effect&bslash;n&quot;
)paren
suffix:semicolon
id|err
op_assign
id|make_magnitude_modifier
c_func
(paren
id|iforce
comma
id|mod1_chunk
comma
id|effect-&gt;u.constant.level
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_return
id|err
suffix:semicolon
id|set_bit
c_func
(paren
id|FF_MOD1_IS_USED
comma
id|core_effect-&gt;flags
)paren
suffix:semicolon
id|err
op_assign
id|make_shape_modifier
c_func
(paren
id|iforce
comma
id|mod2_chunk
comma
id|effect-&gt;u.constant.shape.attack_length
comma
id|effect-&gt;u.constant.shape.attack_level
comma
id|effect-&gt;u.constant.shape.fade_length
comma
id|effect-&gt;u.constant.shape.fade_level
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_return
id|err
suffix:semicolon
id|set_bit
c_func
(paren
id|FF_MOD2_IS_USED
comma
id|core_effect-&gt;flags
)paren
suffix:semicolon
id|err
op_assign
id|make_core
c_func
(paren
id|iforce
comma
id|effect-&gt;id
comma
id|mod1_chunk-&gt;start
comma
id|mod2_chunk-&gt;start
comma
l_int|0x00
comma
l_int|0x20
comma
id|effect-&gt;replay.length
comma
id|effect-&gt;replay.delay
comma
id|effect-&gt;trigger.button
comma
id|effect-&gt;trigger.interval
comma
id|effect-&gt;u.constant.direction
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*&n; * Upload an interactive effect. Those are for example friction, inertia, springs...&n; */
DECL|function|iforce_upload_interactive
r_static
r_int
id|iforce_upload_interactive
c_func
(paren
r_struct
id|iforce
op_star
id|iforce
comma
r_struct
id|ff_effect
op_star
id|effect
)paren
(brace
r_int
id|core_id
op_assign
id|effect-&gt;id
suffix:semicolon
r_struct
id|iforce_core_effect
op_star
id|core_effect
op_assign
id|iforce-&gt;core_effects
op_plus
id|core_id
suffix:semicolon
r_struct
id|resource
op_star
id|mod_chunk
op_assign
op_amp
(paren
id|core_effect-&gt;mod1_chunk
)paren
suffix:semicolon
id|u8
id|type
comma
id|axes
suffix:semicolon
id|u16
id|mod1
comma
id|mod2
comma
id|direction
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;iforce.c: make interactive effect&bslash;n&quot;
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|effect-&gt;type
)paren
(brace
r_case
id|FF_SPRING
suffix:colon
id|type
op_assign
l_int|0x40
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FF_FRICTION
suffix:colon
id|type
op_assign
l_int|0x41
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|err
op_assign
id|make_interactive_modifier
c_func
(paren
id|iforce
comma
id|mod_chunk
comma
id|effect-&gt;u.interactive.right_saturation
comma
id|effect-&gt;u.interactive.left_saturation
comma
id|effect-&gt;u.interactive.right_coeff
comma
id|effect-&gt;u.interactive.left_coeff
comma
id|effect-&gt;u.interactive.deadband
comma
id|effect-&gt;u.interactive.center
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_return
id|err
suffix:semicolon
id|set_bit
c_func
(paren
id|FF_MOD1_IS_USED
comma
id|core_effect-&gt;flags
)paren
suffix:semicolon
r_switch
c_cond
(paren
(paren
id|test_bit
c_func
(paren
id|ABS_X
comma
op_amp
id|effect-&gt;u.interactive.axis
)paren
op_logical_or
id|test_bit
c_func
(paren
id|ABS_WHEEL
comma
op_amp
id|effect-&gt;u.interactive.axis
)paren
)paren
op_or
(paren
op_logical_neg
op_logical_neg
id|test_bit
c_func
(paren
id|ABS_Y
comma
op_amp
id|effect-&gt;u.interactive.axis
)paren
op_lshift
l_int|1
)paren
)paren
(brace
r_case
l_int|0
suffix:colon
multiline_comment|/* Only one axis, choose orientation */
id|mod1
op_assign
id|mod_chunk-&gt;start
suffix:semicolon
id|mod2
op_assign
l_int|0xffff
suffix:semicolon
id|direction
op_assign
id|effect-&gt;u.interactive.direction
suffix:semicolon
id|axes
op_assign
l_int|0x20
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
multiline_comment|/* Only X axis */
id|mod1
op_assign
id|mod_chunk-&gt;start
suffix:semicolon
id|mod2
op_assign
l_int|0xffff
suffix:semicolon
id|direction
op_assign
l_int|0x5a00
suffix:semicolon
id|axes
op_assign
l_int|0x40
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
multiline_comment|/* Only Y axis */
id|mod1
op_assign
l_int|0xffff
suffix:semicolon
id|mod2
op_assign
id|mod_chunk-&gt;start
suffix:semicolon
id|direction
op_assign
l_int|0xb400
suffix:semicolon
id|axes
op_assign
l_int|0x80
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
multiline_comment|/* Both X and Y axes */
multiline_comment|/* TODO: same setting for both axes is not mandatory */
id|mod1
op_assign
id|mod_chunk-&gt;start
suffix:semicolon
id|mod2
op_assign
id|mod_chunk-&gt;start
suffix:semicolon
id|direction
op_assign
l_int|0x6000
suffix:semicolon
id|axes
op_assign
l_int|0xc0
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|err
op_assign
id|make_core
c_func
(paren
id|iforce
comma
id|effect-&gt;id
comma
id|mod1
comma
id|mod2
comma
id|type
comma
id|axes
comma
id|effect-&gt;replay.length
comma
id|effect-&gt;replay.delay
comma
id|effect-&gt;trigger.button
comma
id|effect-&gt;trigger.interval
comma
id|direction
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*&n; * Function called when an ioctl is performed on the event dev entry.&n; * It uploads an effect to the device&n; */
DECL|function|iforce_upload_effect
r_static
r_int
id|iforce_upload_effect
c_func
(paren
r_struct
id|input_dev
op_star
id|dev
comma
r_struct
id|ff_effect
op_star
id|effect
)paren
(brace
r_struct
id|iforce
op_star
id|iforce
op_assign
(paren
r_struct
id|iforce
op_star
)paren
(paren
id|dev
op_member_access_from_pointer
r_private
)paren
suffix:semicolon
r_int
id|id
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;iforce.c: upload effect&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/*&n; * Get a free id&n; */
r_for
c_loop
(paren
id|id
op_assign
l_int|0
suffix:semicolon
id|id
OL
id|FF_EFFECTS_MAX
suffix:semicolon
op_increment
id|id
)paren
r_if
c_cond
(paren
op_logical_neg
id|test_bit
c_func
(paren
id|FF_CORE_IS_USED
comma
id|iforce-&gt;core_effects
(braket
id|id
)braket
dot
id|flags
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|id
op_eq
id|FF_EFFECTS_MAX
op_logical_or
id|id
op_ge
id|iforce-&gt;dev.ff_effects_max
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|effect-&gt;id
op_assign
id|id
suffix:semicolon
id|set_bit
c_func
(paren
id|FF_CORE_IS_USED
comma
id|iforce-&gt;core_effects
(braket
id|id
)braket
dot
id|flags
)paren
suffix:semicolon
multiline_comment|/*&n; * Upload the effect&n; */
r_switch
c_cond
(paren
id|effect-&gt;type
)paren
(brace
r_case
id|FF_PERIODIC
suffix:colon
r_return
id|iforce_upload_periodic
c_func
(paren
id|iforce
comma
id|effect
)paren
suffix:semicolon
r_case
id|FF_CONSTANT
suffix:colon
r_return
id|iforce_upload_constant
c_func
(paren
id|iforce
comma
id|effect
)paren
suffix:semicolon
r_case
id|FF_SPRING
suffix:colon
r_case
id|FF_FRICTION
suffix:colon
r_return
id|iforce_upload_interactive
c_func
(paren
id|iforce
comma
id|effect
)paren
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Erases an effect: it frees the effect id and mark as unused the memory&n; * allocated for the parameters&n; */
DECL|function|iforce_erase_effect
r_static
r_int
id|iforce_erase_effect
c_func
(paren
r_struct
id|input_dev
op_star
id|dev
comma
r_int
id|effect_id
)paren
(brace
r_struct
id|iforce
op_star
id|iforce
op_assign
(paren
r_struct
id|iforce
op_star
)paren
(paren
id|dev
op_member_access_from_pointer
r_private
)paren
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
r_struct
id|iforce_core_effect
op_star
id|core_effect
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;iforce.c: erase effect %d&bslash;n&quot;
comma
id|effect_id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|effect_id
OL
l_int|0
op_logical_or
id|effect_id
op_ge
id|FF_EFFECTS_MAX
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|core_effect
op_assign
id|iforce-&gt;core_effects
op_plus
id|effect_id
suffix:semicolon
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|FF_MOD1_IS_USED
comma
id|core_effect-&gt;flags
)paren
)paren
id|err
op_assign
id|release_resource
c_func
(paren
op_amp
(paren
id|iforce-&gt;core_effects
(braket
id|effect_id
)braket
dot
id|mod1_chunk
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|err
op_logical_and
id|test_bit
c_func
(paren
id|FF_MOD2_IS_USED
comma
id|core_effect-&gt;flags
)paren
)paren
id|err
op_assign
id|release_resource
c_func
(paren
op_amp
(paren
id|iforce-&gt;core_effects
(braket
id|effect_id
)braket
dot
id|mod2_chunk
)paren
)paren
suffix:semicolon
multiline_comment|/*TODO: remember to change that if more FF_MOD* bits are added */
id|core_effect-&gt;flags
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|iforce_init_device
r_static
r_int
id|iforce_init_device
c_func
(paren
r_struct
id|iforce
op_star
id|iforce
)paren
(brace
r_int
r_char
id|c
(braket
)braket
op_assign
l_string|&quot;CEOV&quot;
suffix:semicolon
r_int
id|i
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|iforce-&gt;wait
)paren
suffix:semicolon
id|iforce-&gt;dev.ff_effects_max
op_assign
l_int|10
suffix:semicolon
multiline_comment|/*&n; * Input device fields.&n; */
id|iforce-&gt;dev.idbus
op_assign
id|BUS_USB
suffix:semicolon
id|iforce-&gt;dev
dot
r_private
op_assign
id|iforce
suffix:semicolon
id|iforce-&gt;dev.name
op_assign
id|iforce-&gt;name
suffix:semicolon
id|iforce-&gt;dev.open
op_assign
id|iforce_open
suffix:semicolon
id|iforce-&gt;dev.close
op_assign
id|iforce_close
suffix:semicolon
id|iforce-&gt;dev.event
op_assign
id|iforce_input_event
suffix:semicolon
id|iforce-&gt;dev.upload_effect
op_assign
id|iforce_upload_effect
suffix:semicolon
id|iforce-&gt;dev.erase_effect
op_assign
id|iforce_erase_effect
suffix:semicolon
multiline_comment|/*&n; * On-device memory allocation.&n; */
id|iforce-&gt;device_memory.name
op_assign
l_string|&quot;I-Force device effect memory&quot;
suffix:semicolon
id|iforce-&gt;device_memory.start
op_assign
l_int|0
suffix:semicolon
id|iforce-&gt;device_memory.end
op_assign
l_int|200
suffix:semicolon
id|iforce-&gt;device_memory.flags
op_assign
id|IORESOURCE_MEM
suffix:semicolon
id|iforce-&gt;device_memory.parent
op_assign
l_int|NULL
suffix:semicolon
id|iforce-&gt;device_memory.child
op_assign
l_int|NULL
suffix:semicolon
id|iforce-&gt;device_memory.sibling
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/*&n; * Wait until device ready - until it sends its first response.&n; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|20
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
op_logical_neg
id|get_id_packet
c_func
(paren
id|iforce
comma
l_string|&quot;O&quot;
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
l_int|20
)paren
(brace
multiline_comment|/* 5 seconds */
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;iforce.c: Timeout waiting for response from device.&bslash;n&quot;
)paren
suffix:semicolon
id|iforce_close
c_func
(paren
op_amp
id|iforce-&gt;dev
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; * Get device info.&n; */
r_if
c_cond
(paren
op_logical_neg
id|get_id_packet
c_func
(paren
id|iforce
comma
l_string|&quot;M&quot;
)paren
)paren
id|iforce-&gt;dev.idvendor
op_assign
(paren
id|iforce-&gt;edata
(braket
l_int|2
)braket
op_lshift
l_int|8
)paren
op_or
id|iforce-&gt;edata
(braket
l_int|1
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|get_id_packet
c_func
(paren
id|iforce
comma
l_string|&quot;P&quot;
)paren
)paren
id|iforce-&gt;dev.idproduct
op_assign
(paren
id|iforce-&gt;edata
(braket
l_int|2
)braket
op_lshift
l_int|8
)paren
op_or
id|iforce-&gt;edata
(braket
l_int|1
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|get_id_packet
c_func
(paren
id|iforce
comma
l_string|&quot;B&quot;
)paren
)paren
id|iforce-&gt;device_memory.end
op_assign
(paren
id|iforce-&gt;edata
(braket
l_int|2
)braket
op_lshift
l_int|8
)paren
op_or
id|iforce-&gt;edata
(braket
l_int|1
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|get_id_packet
c_func
(paren
id|iforce
comma
l_string|&quot;N&quot;
)paren
)paren
id|iforce-&gt;dev.ff_effects_max
op_assign
id|iforce-&gt;edata
(braket
l_int|1
)braket
suffix:semicolon
multiline_comment|/*&n; * Display additional info.&n; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|c
(braket
id|i
)braket
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
op_logical_neg
id|get_id_packet
c_func
(paren
id|iforce
comma
id|c
op_plus
id|i
)paren
)paren
id|dump_packet
c_func
(paren
l_string|&quot;info&quot;
comma
id|iforce-&gt;ecmd
comma
id|iforce-&gt;edata
)paren
suffix:semicolon
multiline_comment|/*&n; * Disable spring, enable force feedback.&n; * FIXME: We should use iforce_set_autocenter() et al here.&n; */
id|send_packet
c_func
(paren
id|iforce
comma
id|FF_CMD_AUTOCENTER
comma
l_string|&quot;&bslash;004&bslash;000&quot;
)paren
suffix:semicolon
id|send_packet
c_func
(paren
id|iforce
comma
id|FF_CMD_ENABLE
comma
l_string|&quot;&bslash;004&quot;
)paren
suffix:semicolon
multiline_comment|/*&n; * Find appropriate device entry&n; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|iforce_device
(braket
id|i
)braket
dot
id|idvendor
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|iforce_device
(braket
id|i
)braket
dot
id|idvendor
op_eq
id|iforce-&gt;dev.idvendor
op_logical_and
id|iforce_device
(braket
id|i
)braket
dot
id|idproduct
op_eq
id|iforce-&gt;dev.idproduct
)paren
r_break
suffix:semicolon
id|iforce-&gt;type
op_assign
id|iforce_device
op_plus
id|i
suffix:semicolon
id|sprintf
c_func
(paren
id|iforce-&gt;name
comma
id|iforce-&gt;type-&gt;name
comma
id|iforce-&gt;dev.idproduct
comma
id|iforce-&gt;dev.idvendor
)paren
suffix:semicolon
multiline_comment|/*&n; * Set input device bitfields and ranges.&n; */
id|iforce-&gt;dev.evbit
(braket
l_int|0
)braket
op_assign
id|BIT
c_func
(paren
id|EV_KEY
)paren
op_or
id|BIT
c_func
(paren
id|EV_ABS
)paren
op_or
id|BIT
c_func
(paren
id|EV_FF
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|iforce-&gt;type-&gt;btn
(braket
id|i
)braket
op_ge
l_int|0
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
r_int
id|t
op_assign
id|iforce-&gt;type-&gt;btn
(braket
id|i
)braket
suffix:semicolon
id|set_bit
c_func
(paren
id|t
comma
id|iforce-&gt;dev.keybit
)paren
suffix:semicolon
r_if
c_cond
(paren
id|t
op_ne
id|BTN_DEAD
)paren
id|set_bit
c_func
(paren
id|FF_BTN
c_func
(paren
id|t
)paren
comma
id|iforce-&gt;dev.ffbit
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|iforce-&gt;type-&gt;abs
(braket
id|i
)braket
op_ge
l_int|0
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
r_int
id|t
op_assign
id|iforce-&gt;type-&gt;abs
(braket
id|i
)braket
suffix:semicolon
id|set_bit
c_func
(paren
id|t
comma
id|iforce-&gt;dev.absbit
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|t
)paren
(brace
r_case
id|ABS_X
suffix:colon
r_case
id|ABS_Y
suffix:colon
r_case
id|ABS_WHEEL
suffix:colon
id|iforce-&gt;dev.absmax
(braket
id|t
)braket
op_assign
l_int|1920
suffix:semicolon
id|iforce-&gt;dev.absmin
(braket
id|t
)braket
op_assign
op_minus
l_int|1920
suffix:semicolon
id|iforce-&gt;dev.absflat
(braket
id|t
)braket
op_assign
l_int|128
suffix:semicolon
id|iforce-&gt;dev.absfuzz
(braket
id|t
)braket
op_assign
l_int|16
suffix:semicolon
id|set_bit
c_func
(paren
id|FF_ABS
c_func
(paren
id|t
)paren
comma
id|iforce-&gt;dev.ffbit
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ABS_THROTTLE
suffix:colon
r_case
id|ABS_GAS
suffix:colon
r_case
id|ABS_BRAKE
suffix:colon
id|iforce-&gt;dev.absmax
(braket
id|t
)braket
op_assign
l_int|255
suffix:semicolon
id|iforce-&gt;dev.absmin
(braket
id|t
)braket
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ABS_HAT0X
suffix:colon
r_case
id|ABS_HAT0Y
suffix:colon
id|iforce-&gt;dev.absmax
(braket
id|t
)braket
op_assign
l_int|1
suffix:semicolon
id|iforce-&gt;dev.absmin
(braket
id|t
)braket
op_assign
op_minus
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|iforce-&gt;type-&gt;ff
(braket
id|i
)braket
op_ge
l_int|0
suffix:semicolon
id|i
op_increment
)paren
id|set_bit
c_func
(paren
id|iforce-&gt;type-&gt;ff
(braket
id|i
)braket
comma
id|iforce-&gt;dev.ffbit
)paren
suffix:semicolon
multiline_comment|/*&n; * Register input device.&n; */
id|input_register_device
c_func
(paren
op_amp
id|iforce-&gt;dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef IFORCE_USB
DECL|function|iforce_usb_irq
r_static
r_void
id|iforce_usb_irq
c_func
(paren
r_struct
id|urb
op_star
id|urb
)paren
(brace
r_struct
id|iforce
op_star
id|iforce
op_assign
id|urb-&gt;context
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;status
)paren
r_return
suffix:semicolon
id|iforce_process_packet
c_func
(paren
id|iforce
comma
(paren
id|iforce-&gt;data
(braket
l_int|0
)braket
op_lshift
l_int|8
)paren
op_or
(paren
id|urb-&gt;actual_length
op_minus
l_int|1
)paren
comma
id|iforce-&gt;data
op_plus
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|iforce_usb_out
r_static
r_void
id|iforce_usb_out
c_func
(paren
r_struct
id|urb
op_star
id|urb
)paren
(brace
r_struct
id|iforce
op_star
id|iforce
op_assign
id|urb-&gt;context
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;status
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|waitqueue_active
c_func
(paren
op_amp
id|iforce-&gt;wait
)paren
)paren
id|wake_up
c_func
(paren
op_amp
id|iforce-&gt;wait
)paren
suffix:semicolon
)brace
DECL|function|iforce_usb_ctrl
r_static
r_void
id|iforce_usb_ctrl
c_func
(paren
r_struct
id|urb
op_star
id|urb
)paren
(brace
r_struct
id|iforce
op_star
id|iforce
op_assign
id|urb-&gt;context
suffix:semicolon
r_if
c_cond
(paren
id|urb-&gt;status
)paren
r_return
suffix:semicolon
id|iforce-&gt;ecmd
op_assign
l_int|0xff00
op_or
id|urb-&gt;actual_length
suffix:semicolon
r_if
c_cond
(paren
id|waitqueue_active
c_func
(paren
op_amp
id|iforce-&gt;wait
)paren
)paren
id|wake_up
c_func
(paren
op_amp
id|iforce-&gt;wait
)paren
suffix:semicolon
)brace
DECL|function|iforce_usb_probe
r_static
r_void
op_star
id|iforce_usb_probe
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
comma
r_int
r_int
id|ifnum
comma
r_const
r_struct
id|usb_device_id
op_star
id|id
)paren
(brace
r_struct
id|usb_endpoint_descriptor
op_star
id|epirq
comma
op_star
id|epout
suffix:semicolon
r_struct
id|iforce
op_star
id|iforce
suffix:semicolon
id|epirq
op_assign
id|dev-&gt;config
(braket
l_int|0
)braket
dot
id|interface
(braket
id|ifnum
)braket
dot
id|altsetting
(braket
l_int|0
)braket
dot
id|endpoint
op_plus
l_int|0
suffix:semicolon
id|epout
op_assign
id|dev-&gt;config
(braket
l_int|0
)braket
dot
id|interface
(braket
id|ifnum
)braket
dot
id|altsetting
(braket
l_int|0
)braket
dot
id|endpoint
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|iforce
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|iforce
)paren
op_plus
l_int|32
comma
id|GFP_KERNEL
)paren
)paren
)paren
r_return
l_int|NULL
suffix:semicolon
id|memset
c_func
(paren
id|iforce
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|iforce
)paren
)paren
suffix:semicolon
id|iforce-&gt;bus
op_assign
id|IFORCE_USB
suffix:semicolon
id|iforce-&gt;usbdev
op_assign
id|dev
suffix:semicolon
id|iforce-&gt;dr.bRequestType
op_assign
id|USB_TYPE_VENDOR
op_or
id|USB_DIR_IN
op_or
id|USB_RECIP_INTERFACE
suffix:semicolon
id|iforce-&gt;dr.wIndex
op_assign
l_int|0
suffix:semicolon
id|iforce-&gt;dr.wLength
op_assign
l_int|16
suffix:semicolon
id|FILL_INT_URB
c_func
(paren
op_amp
id|iforce-&gt;irq
comma
id|dev
comma
id|usb_rcvintpipe
c_func
(paren
id|dev
comma
id|epirq-&gt;bEndpointAddress
)paren
comma
id|iforce-&gt;data
comma
l_int|16
comma
id|iforce_usb_irq
comma
id|iforce
comma
id|epirq-&gt;bInterval
)paren
suffix:semicolon
id|FILL_BULK_URB
c_func
(paren
op_amp
id|iforce-&gt;out
comma
id|dev
comma
id|usb_sndbulkpipe
c_func
(paren
id|dev
comma
id|epout-&gt;bEndpointAddress
)paren
comma
id|iforce
op_plus
l_int|1
comma
l_int|32
comma
id|iforce_usb_out
comma
id|iforce
)paren
suffix:semicolon
id|FILL_CONTROL_URB
c_func
(paren
op_amp
id|iforce-&gt;ctrl
comma
id|dev
comma
id|usb_rcvctrlpipe
c_func
(paren
id|dev
comma
l_int|0
)paren
comma
(paren
r_void
op_star
)paren
op_amp
id|iforce-&gt;dr
comma
id|iforce-&gt;edata
comma
l_int|16
comma
id|iforce_usb_ctrl
comma
id|iforce
)paren
suffix:semicolon
r_if
c_cond
(paren
id|iforce_init_device
c_func
(paren
id|iforce
)paren
)paren
(brace
id|kfree
c_func
(paren
id|iforce
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;input%d: %s [%d effects, %ld bytes memory] on usb%d:%d.%d&bslash;n&quot;
comma
id|iforce-&gt;dev.number
comma
id|iforce-&gt;dev.name
comma
id|iforce-&gt;dev.ff_effects_max
comma
id|iforce-&gt;device_memory.end
comma
id|dev-&gt;bus-&gt;busnum
comma
id|dev-&gt;devnum
comma
id|ifnum
)paren
suffix:semicolon
r_return
id|iforce
suffix:semicolon
)brace
DECL|function|iforce_usb_disconnect
r_static
r_void
id|iforce_usb_disconnect
c_func
(paren
r_struct
id|usb_device
op_star
id|dev
comma
r_void
op_star
id|ptr
)paren
(brace
r_struct
id|iforce
op_star
id|iforce
op_assign
id|ptr
suffix:semicolon
id|usb_unlink_urb
c_func
(paren
op_amp
id|iforce-&gt;irq
)paren
suffix:semicolon
id|input_unregister_device
c_func
(paren
op_amp
id|iforce-&gt;dev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|iforce
)paren
suffix:semicolon
)brace
DECL|variable|iforce_usb_ids
r_static
r_struct
id|usb_device_id
id|iforce_usb_ids
(braket
)braket
op_assign
(brace
(brace
id|USB_DEVICE
c_func
(paren
l_int|0x046d
comma
l_int|0xc281
)paren
)brace
comma
multiline_comment|/* Logitech WingMan Force */
(brace
id|USB_DEVICE
c_func
(paren
l_int|0x046d
comma
l_int|0xc291
)paren
)brace
comma
multiline_comment|/* Logitech WingMan Formula Force */
(brace
id|USB_DEVICE
c_func
(paren
l_int|0x05ef
comma
l_int|0x020a
)paren
)brace
comma
multiline_comment|/* AVB Top Shot Pegasus */
(brace
id|USB_DEVICE
c_func
(paren
l_int|0x05ef
comma
l_int|0x8884
)paren
)brace
comma
multiline_comment|/* AVB Mag Turbo Force */
(brace
id|USB_DEVICE
c_func
(paren
l_int|0x06f8
comma
l_int|0x0001
)paren
)brace
comma
multiline_comment|/* Guillemot Race Leader Force Feedback */
(brace
)brace
multiline_comment|/* Terminating entry */
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
(paren
id|usb
comma
id|iforce_usb_ids
)paren
suffix:semicolon
DECL|variable|iforce_usb_driver
r_static
r_struct
id|usb_driver
id|iforce_usb_driver
op_assign
(brace
id|name
suffix:colon
l_string|&quot;iforce&quot;
comma
id|probe
suffix:colon
id|iforce_usb_probe
comma
id|disconnect
suffix:colon
id|iforce_usb_disconnect
comma
id|id_table
suffix:colon
id|iforce_usb_ids
comma
)brace
suffix:semicolon
macro_line|#endif
macro_line|#ifdef IFORCE_232
DECL|function|iforce_serio_irq
r_static
r_void
id|iforce_serio_irq
c_func
(paren
r_struct
id|serio
op_star
id|serio
comma
r_int
r_char
id|data
comma
r_int
r_int
id|flags
)paren
(brace
r_struct
id|iforce
op_star
id|iforce
op_assign
id|serio
op_member_access_from_pointer
r_private
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|iforce-&gt;pkt
)paren
(brace
r_if
c_cond
(paren
id|data
op_ne
l_int|0x2b
)paren
(brace
r_return
suffix:semicolon
)brace
id|iforce-&gt;pkt
op_assign
l_int|1
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|iforce-&gt;id
)paren
(brace
r_if
c_cond
(paren
id|data
OG
l_int|3
op_logical_and
id|data
op_ne
l_int|0xff
)paren
(brace
id|iforce-&gt;pkt
op_assign
l_int|0
suffix:semicolon
r_return
suffix:semicolon
)brace
id|iforce-&gt;id
op_assign
id|data
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|iforce-&gt;len
)paren
(brace
r_if
c_cond
(paren
id|data
OG
id|IFORCE_MAX_LENGTH
)paren
(brace
id|iforce-&gt;pkt
op_assign
l_int|0
suffix:semicolon
id|iforce-&gt;id
op_assign
l_int|0
suffix:semicolon
r_return
suffix:semicolon
)brace
id|iforce-&gt;len
op_assign
id|data
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|iforce-&gt;idx
OL
id|iforce-&gt;len
)paren
(brace
id|iforce-&gt;csum
op_add_assign
id|iforce-&gt;data
(braket
id|iforce-&gt;idx
op_increment
)braket
op_assign
id|data
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|iforce-&gt;idx
op_eq
id|iforce-&gt;len
)paren
(brace
id|iforce_process_packet
c_func
(paren
id|iforce
comma
(paren
id|iforce-&gt;id
op_lshift
l_int|8
)paren
op_or
id|iforce-&gt;idx
comma
id|iforce-&gt;data
)paren
suffix:semicolon
id|iforce-&gt;pkt
op_assign
l_int|0
suffix:semicolon
id|iforce-&gt;id
op_assign
l_int|0
suffix:semicolon
id|iforce-&gt;len
op_assign
l_int|0
suffix:semicolon
id|iforce-&gt;idx
op_assign
l_int|0
suffix:semicolon
id|iforce-&gt;csum
op_assign
l_int|0
suffix:semicolon
)brace
)brace
DECL|function|iforce_serio_connect
r_static
r_void
id|iforce_serio_connect
c_func
(paren
r_struct
id|serio
op_star
id|serio
comma
r_struct
id|serio_dev
op_star
id|dev
)paren
(brace
r_struct
id|iforce
op_star
id|iforce
suffix:semicolon
r_if
c_cond
(paren
id|serio-&gt;type
op_ne
(paren
id|SERIO_RS232
op_or
id|SERIO_IFORCE
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|iforce
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|iforce
)paren
comma
id|GFP_KERNEL
)paren
)paren
)paren
r_return
suffix:semicolon
id|memset
c_func
(paren
id|iforce
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|iforce
)paren
)paren
suffix:semicolon
id|iforce-&gt;bus
op_assign
id|IFORCE_232
suffix:semicolon
id|iforce-&gt;serio
op_assign
id|serio
suffix:semicolon
id|serio
op_member_access_from_pointer
r_private
op_assign
id|iforce
suffix:semicolon
r_if
c_cond
(paren
id|serio_open
c_func
(paren
id|serio
comma
id|dev
)paren
)paren
(brace
id|kfree
c_func
(paren
id|iforce
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|iforce_init_device
c_func
(paren
id|iforce
)paren
)paren
(brace
id|serio_close
c_func
(paren
id|serio
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|iforce
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;input%d: %s [%d effects, %ld bytes memory] on serio%d&bslash;n&quot;
comma
id|iforce-&gt;dev.number
comma
id|iforce-&gt;dev.name
comma
id|iforce-&gt;dev.ff_effects_max
comma
id|iforce-&gt;device_memory.end
comma
id|serio-&gt;number
)paren
suffix:semicolon
)brace
DECL|function|iforce_serio_disconnect
r_static
r_void
id|iforce_serio_disconnect
c_func
(paren
r_struct
id|serio
op_star
id|serio
)paren
(brace
r_struct
id|iforce
op_star
id|iforce
op_assign
id|serio
op_member_access_from_pointer
r_private
suffix:semicolon
id|input_unregister_device
c_func
(paren
op_amp
id|iforce-&gt;dev
)paren
suffix:semicolon
id|serio_close
c_func
(paren
id|serio
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|iforce
)paren
suffix:semicolon
)brace
DECL|variable|iforce_serio_dev
r_static
r_struct
id|serio_dev
id|iforce_serio_dev
op_assign
(brace
id|interrupt
suffix:colon
id|iforce_serio_irq
comma
id|connect
suffix:colon
id|iforce_serio_connect
comma
id|disconnect
suffix:colon
id|iforce_serio_disconnect
comma
)brace
suffix:semicolon
macro_line|#endif
DECL|function|iforce_init
r_static
r_int
id|__init
id|iforce_init
c_func
(paren
r_void
)paren
(brace
macro_line|#ifdef IFORCE_USB
id|usb_register
c_func
(paren
op_amp
id|iforce_usb_driver
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef IFORCE_232
id|serio_register_device
c_func
(paren
op_amp
id|iforce_serio_dev
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|iforce_exit
r_static
r_void
id|__exit
id|iforce_exit
c_func
(paren
r_void
)paren
(brace
macro_line|#ifdef IFORCE_USB
id|usb_deregister
c_func
(paren
op_amp
id|iforce_usb_driver
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef IFORCE_232
id|serio_unregister_device
c_func
(paren
op_amp
id|iforce_serio_dev
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|variable|iforce_init
id|module_init
c_func
(paren
id|iforce_init
)paren
suffix:semicolon
DECL|variable|iforce_exit
id|module_exit
c_func
(paren
id|iforce_exit
)paren
suffix:semicolon
eof
