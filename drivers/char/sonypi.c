multiline_comment|/*&n; * Sony Programmable I/O Control Device driver for VAIO&n; *&n; * Copyright (C) 2001-2003 Stelian Pop &lt;stelian@popies.net&gt;&n; *&n; * Copyright (C) 2001-2002 Alc&#xfffd;ve &lt;www.alcove.com&gt;&n; *&n; * Copyright (C) 2001 Michael Ashley &lt;m.ashley@unsw.edu.au&gt;&n; *&n; * Copyright (C) 2001 Junichi Morita &lt;jun1m@mars.dti.ne.jp&gt;&n; *&n; * Copyright (C) 2000 Takaya Kinjo &lt;t-kinjo@tc4.so-net.ne.jp&gt;&n; *&n; * Copyright (C) 2000 Andrew Tridgell &lt;tridge@valinux.com&gt;&n; *&n; * Earlier work by Werner Almesberger, Paul `Rusty&squot; Russell and Paul Mackerras.&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or&n; * (at your option) any later version.&n; * &n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; * &n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/input.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/miscdevice.h&gt;
macro_line|#include &lt;linux/poll.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/wait.h&gt;
macro_line|#include &lt;linux/acpi.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &quot;sonypi.h&quot;
macro_line|#include &lt;linux/sonypi.h&gt;
DECL|variable|sonypi_device
r_static
r_struct
id|sonypi_device
id|sonypi_device
suffix:semicolon
DECL|variable|minor
r_static
r_int
id|minor
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|variable|verbose
r_static
r_int
id|verbose
suffix:semicolon
multiline_comment|/* = 0 */
DECL|variable|fnkeyinit
r_static
r_int
id|fnkeyinit
suffix:semicolon
multiline_comment|/* = 0 */
DECL|variable|camera
r_static
r_int
id|camera
suffix:semicolon
multiline_comment|/* = 0 */
DECL|variable|compat
r_static
r_int
id|compat
suffix:semicolon
multiline_comment|/* = 0 */
DECL|variable|useinput
r_static
r_int
id|useinput
op_assign
l_int|1
suffix:semicolon
DECL|variable|mask
r_static
r_int
r_int
id|mask
op_assign
l_int|0xffffffff
suffix:semicolon
multiline_comment|/* Inits the queue */
DECL|function|sonypi_initq
r_static
r_inline
r_void
id|sonypi_initq
c_func
(paren
r_void
)paren
(brace
id|sonypi_device.queue.head
op_assign
id|sonypi_device.queue.tail
op_assign
l_int|0
suffix:semicolon
id|sonypi_device.queue.len
op_assign
l_int|0
suffix:semicolon
id|sonypi_device.queue.s_lock
op_assign
(paren
id|spinlock_t
)paren
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|sonypi_device.queue.proc_list
)paren
suffix:semicolon
)brace
multiline_comment|/* Pulls an event from the queue */
DECL|function|sonypi_pullq
r_static
r_inline
r_int
r_char
id|sonypi_pullq
c_func
(paren
r_void
)paren
(brace
r_int
r_char
id|result
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|sonypi_device.queue.s_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sonypi_device.queue.len
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|sonypi_device.queue.s_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|result
op_assign
id|sonypi_device.queue.buf
(braket
id|sonypi_device.queue.head
)braket
suffix:semicolon
id|sonypi_device.queue.head
op_increment
suffix:semicolon
id|sonypi_device.queue.head
op_and_assign
(paren
id|SONYPI_BUF_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
id|sonypi_device.queue.len
op_decrement
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|sonypi_device.queue.s_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/* Pushes an event into the queue */
DECL|function|sonypi_pushq
r_static
r_inline
r_void
id|sonypi_pushq
c_func
(paren
r_int
r_char
id|event
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|sonypi_device.queue.s_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sonypi_device.queue.len
op_eq
id|SONYPI_BUF_SIZE
)paren
(brace
multiline_comment|/* remove the first element */
id|sonypi_device.queue.head
op_increment
suffix:semicolon
id|sonypi_device.queue.head
op_and_assign
(paren
id|SONYPI_BUF_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
id|sonypi_device.queue.len
op_decrement
suffix:semicolon
)brace
id|sonypi_device.queue.buf
(braket
id|sonypi_device.queue.tail
)braket
op_assign
id|event
suffix:semicolon
id|sonypi_device.queue.tail
op_increment
suffix:semicolon
id|sonypi_device.queue.tail
op_and_assign
(paren
id|SONYPI_BUF_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
id|sonypi_device.queue.len
op_increment
suffix:semicolon
id|kill_fasync
c_func
(paren
op_amp
id|sonypi_device.queue.fasync
comma
id|SIGIO
comma
id|POLL_IN
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|sonypi_device.queue.proc_list
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|sonypi_device.queue.s_lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* Tests if the queue is empty */
DECL|function|sonypi_emptyq
r_static
r_inline
r_int
id|sonypi_emptyq
c_func
(paren
r_void
)paren
(brace
r_int
id|result
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|sonypi_device.queue.s_lock
comma
id|flags
)paren
suffix:semicolon
id|result
op_assign
(paren
id|sonypi_device.queue.len
op_eq
l_int|0
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|sonypi_device.queue.s_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
DECL|function|ec_read16
r_static
r_int
id|ec_read16
c_func
(paren
id|u8
id|addr
comma
id|u16
op_star
id|value
)paren
(brace
id|u8
id|val_lb
comma
id|val_hb
suffix:semicolon
r_if
c_cond
(paren
id|ec_read
c_func
(paren
id|addr
comma
op_amp
id|val_lb
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|ec_read
c_func
(paren
id|addr
op_plus
l_int|1
comma
op_amp
id|val_hb
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
op_star
id|value
op_assign
id|val_lb
op_or
(paren
id|val_hb
op_lshift
l_int|8
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Initializes the device - this comes from the AML code in the ACPI bios */
DECL|function|sonypi_type1_srs
r_static
r_void
id|__devinit
id|sonypi_type1_srs
c_func
(paren
r_void
)paren
(brace
id|u32
id|v
suffix:semicolon
id|pci_read_config_dword
c_func
(paren
id|sonypi_device.dev
comma
id|SONYPI_G10A
comma
op_amp
id|v
)paren
suffix:semicolon
id|v
op_assign
(paren
id|v
op_amp
l_int|0xFFFF0000
)paren
op_or
(paren
(paren
id|u32
)paren
id|sonypi_device.ioport1
)paren
suffix:semicolon
id|pci_write_config_dword
c_func
(paren
id|sonypi_device.dev
comma
id|SONYPI_G10A
comma
id|v
)paren
suffix:semicolon
id|pci_read_config_dword
c_func
(paren
id|sonypi_device.dev
comma
id|SONYPI_G10A
comma
op_amp
id|v
)paren
suffix:semicolon
id|v
op_assign
(paren
id|v
op_amp
l_int|0xFFF0FFFF
)paren
op_or
(paren
(paren
(paren
id|u32
)paren
id|sonypi_device.ioport1
op_xor
id|sonypi_device.ioport2
)paren
op_lshift
l_int|16
)paren
suffix:semicolon
id|pci_write_config_dword
c_func
(paren
id|sonypi_device.dev
comma
id|SONYPI_G10A
comma
id|v
)paren
suffix:semicolon
id|v
op_assign
id|inl
c_func
(paren
id|SONYPI_IRQ_PORT
)paren
suffix:semicolon
id|v
op_and_assign
op_complement
(paren
(paren
(paren
id|u32
)paren
l_int|0x3
)paren
op_lshift
id|SONYPI_IRQ_SHIFT
)paren
suffix:semicolon
id|v
op_or_assign
(paren
(paren
(paren
id|u32
)paren
id|sonypi_device.bits
)paren
op_lshift
id|SONYPI_IRQ_SHIFT
)paren
suffix:semicolon
id|outl
c_func
(paren
id|v
comma
id|SONYPI_IRQ_PORT
)paren
suffix:semicolon
id|pci_read_config_dword
c_func
(paren
id|sonypi_device.dev
comma
id|SONYPI_G10A
comma
op_amp
id|v
)paren
suffix:semicolon
id|v
op_assign
(paren
id|v
op_amp
l_int|0xFF1FFFFF
)paren
op_or
l_int|0x00C00000
suffix:semicolon
id|pci_write_config_dword
c_func
(paren
id|sonypi_device.dev
comma
id|SONYPI_G10A
comma
id|v
)paren
suffix:semicolon
)brace
DECL|function|sonypi_type2_srs
r_static
r_void
id|__devinit
id|sonypi_type2_srs
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|ec_write
c_func
(paren
id|SONYPI_SHIB
comma
(paren
id|sonypi_device.ioport1
op_amp
l_int|0xFF00
)paren
op_rshift
l_int|8
)paren
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;ec_write failed&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ec_write
c_func
(paren
id|SONYPI_SLOB
comma
id|sonypi_device.ioport1
op_amp
l_int|0x00FF
)paren
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;ec_write failed&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ec_write
c_func
(paren
id|SONYPI_SIRQ
comma
id|sonypi_device.bits
)paren
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;ec_write failed&bslash;n&quot;
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
multiline_comment|/* Disables the device - this comes from the AML code in the ACPI bios */
DECL|function|sonypi_type1_dis
r_static
r_void
id|__devexit
id|sonypi_type1_dis
c_func
(paren
r_void
)paren
(brace
id|u32
id|v
suffix:semicolon
id|pci_read_config_dword
c_func
(paren
id|sonypi_device.dev
comma
id|SONYPI_G10A
comma
op_amp
id|v
)paren
suffix:semicolon
id|v
op_assign
id|v
op_amp
l_int|0xFF3FFFFF
suffix:semicolon
id|pci_write_config_dword
c_func
(paren
id|sonypi_device.dev
comma
id|SONYPI_G10A
comma
id|v
)paren
suffix:semicolon
id|v
op_assign
id|inl
c_func
(paren
id|SONYPI_IRQ_PORT
)paren
suffix:semicolon
id|v
op_or_assign
(paren
l_int|0x3
op_lshift
id|SONYPI_IRQ_SHIFT
)paren
suffix:semicolon
id|outl
c_func
(paren
id|v
comma
id|SONYPI_IRQ_PORT
)paren
suffix:semicolon
)brace
DECL|function|sonypi_type2_dis
r_static
r_void
id|__devexit
id|sonypi_type2_dis
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|ec_write
c_func
(paren
id|SONYPI_SHIB
comma
l_int|0
)paren
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;ec_write failed&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ec_write
c_func
(paren
id|SONYPI_SLOB
comma
l_int|0
)paren
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;ec_write failed&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ec_write
c_func
(paren
id|SONYPI_SIRQ
comma
l_int|0
)paren
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;ec_write failed&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|sonypi_call1
r_static
id|u8
id|sonypi_call1
c_func
(paren
id|u8
id|dev
)paren
(brace
id|u8
id|v1
comma
id|v2
suffix:semicolon
id|wait_on_command
c_func
(paren
l_int|0
comma
id|inb_p
c_func
(paren
id|sonypi_device.ioport2
)paren
op_amp
l_int|2
comma
id|ITERATIONS_LONG
)paren
suffix:semicolon
id|outb
c_func
(paren
id|dev
comma
id|sonypi_device.ioport2
)paren
suffix:semicolon
id|v1
op_assign
id|inb_p
c_func
(paren
id|sonypi_device.ioport2
)paren
suffix:semicolon
id|v2
op_assign
id|inb_p
c_func
(paren
id|sonypi_device.ioport1
)paren
suffix:semicolon
r_return
id|v2
suffix:semicolon
)brace
DECL|function|sonypi_call2
r_static
id|u8
id|sonypi_call2
c_func
(paren
id|u8
id|dev
comma
id|u8
id|fn
)paren
(brace
id|u8
id|v1
suffix:semicolon
id|wait_on_command
c_func
(paren
l_int|0
comma
id|inb_p
c_func
(paren
id|sonypi_device.ioport2
)paren
op_amp
l_int|2
comma
id|ITERATIONS_LONG
)paren
suffix:semicolon
id|outb
c_func
(paren
id|dev
comma
id|sonypi_device.ioport2
)paren
suffix:semicolon
id|wait_on_command
c_func
(paren
l_int|0
comma
id|inb_p
c_func
(paren
id|sonypi_device.ioport2
)paren
op_amp
l_int|2
comma
id|ITERATIONS_LONG
)paren
suffix:semicolon
id|outb
c_func
(paren
id|fn
comma
id|sonypi_device.ioport1
)paren
suffix:semicolon
id|v1
op_assign
id|inb_p
c_func
(paren
id|sonypi_device.ioport1
)paren
suffix:semicolon
r_return
id|v1
suffix:semicolon
)brace
DECL|function|sonypi_call3
r_static
id|u8
id|sonypi_call3
c_func
(paren
id|u8
id|dev
comma
id|u8
id|fn
comma
id|u8
id|v
)paren
(brace
id|u8
id|v1
suffix:semicolon
id|wait_on_command
c_func
(paren
l_int|0
comma
id|inb_p
c_func
(paren
id|sonypi_device.ioport2
)paren
op_amp
l_int|2
comma
id|ITERATIONS_LONG
)paren
suffix:semicolon
id|outb
c_func
(paren
id|dev
comma
id|sonypi_device.ioport2
)paren
suffix:semicolon
id|wait_on_command
c_func
(paren
l_int|0
comma
id|inb_p
c_func
(paren
id|sonypi_device.ioport2
)paren
op_amp
l_int|2
comma
id|ITERATIONS_LONG
)paren
suffix:semicolon
id|outb
c_func
(paren
id|fn
comma
id|sonypi_device.ioport1
)paren
suffix:semicolon
id|wait_on_command
c_func
(paren
l_int|0
comma
id|inb_p
c_func
(paren
id|sonypi_device.ioport2
)paren
op_amp
l_int|2
comma
id|ITERATIONS_LONG
)paren
suffix:semicolon
id|outb
c_func
(paren
id|v
comma
id|sonypi_device.ioport1
)paren
suffix:semicolon
id|v1
op_assign
id|inb_p
c_func
(paren
id|sonypi_device.ioport1
)paren
suffix:semicolon
r_return
id|v1
suffix:semicolon
)brace
DECL|function|sonypi_read
r_static
id|u8
id|sonypi_read
c_func
(paren
id|u8
id|fn
)paren
(brace
id|u8
id|v1
comma
id|v2
suffix:semicolon
r_int
id|n
op_assign
l_int|100
suffix:semicolon
r_while
c_loop
(paren
id|n
op_decrement
)paren
(brace
id|v1
op_assign
id|sonypi_call2
c_func
(paren
l_int|0x8f
comma
id|fn
)paren
suffix:semicolon
id|v2
op_assign
id|sonypi_call2
c_func
(paren
l_int|0x8f
comma
id|fn
)paren
suffix:semicolon
r_if
c_cond
(paren
id|v1
op_eq
id|v2
op_logical_and
id|v1
op_ne
l_int|0xff
)paren
r_return
id|v1
suffix:semicolon
)brace
r_return
l_int|0xff
suffix:semicolon
)brace
multiline_comment|/* Set brightness, hue etc */
DECL|function|sonypi_set
r_static
r_void
id|sonypi_set
c_func
(paren
id|u8
id|fn
comma
id|u8
id|v
)paren
(brace
id|wait_on_command
c_func
(paren
l_int|0
comma
id|sonypi_call3
c_func
(paren
l_int|0x90
comma
id|fn
comma
id|v
)paren
comma
id|ITERATIONS_SHORT
)paren
suffix:semicolon
)brace
multiline_comment|/* Tests if the camera is ready */
DECL|function|sonypi_camera_ready
r_static
r_int
id|sonypi_camera_ready
c_func
(paren
r_void
)paren
(brace
id|u8
id|v
suffix:semicolon
id|v
op_assign
id|sonypi_call2
c_func
(paren
l_int|0x8f
comma
id|SONYPI_CAMERA_STATUS
)paren
suffix:semicolon
r_return
(paren
id|v
op_ne
l_int|0xff
op_logical_and
(paren
id|v
op_amp
id|SONYPI_CAMERA_STATUS_READY
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Turns the camera off */
DECL|function|sonypi_camera_off
r_static
r_void
id|sonypi_camera_off
c_func
(paren
r_void
)paren
(brace
id|sonypi_set
c_func
(paren
id|SONYPI_CAMERA_PICTURE
comma
id|SONYPI_CAMERA_MUTE_MASK
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sonypi_device.camera_power
)paren
r_return
suffix:semicolon
id|sonypi_call2
c_func
(paren
l_int|0x91
comma
l_int|0
)paren
suffix:semicolon
id|sonypi_device.camera_power
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Turns the camera on */
DECL|function|sonypi_camera_on
r_static
r_void
id|sonypi_camera_on
c_func
(paren
r_void
)paren
(brace
r_int
id|i
comma
id|j
suffix:semicolon
r_if
c_cond
(paren
id|sonypi_device.camera_power
)paren
r_return
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|5
suffix:semicolon
id|j
OG
l_int|0
suffix:semicolon
id|j
op_decrement
)paren
(brace
r_while
c_loop
(paren
id|sonypi_call2
c_func
(paren
l_int|0x91
comma
l_int|0x1
)paren
op_ne
l_int|0
)paren
(brace
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
id|sonypi_call1
c_func
(paren
l_int|0x93
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|400
suffix:semicolon
id|i
OG
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
r_if
c_cond
(paren
id|sonypi_camera_ready
c_func
(paren
)paren
)paren
r_break
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_ne
l_int|0
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|j
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;sonypi: failed to power on camera&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|sonypi_set
c_func
(paren
l_int|0x10
comma
l_int|0x5a
)paren
suffix:semicolon
id|sonypi_device.camera_power
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* sets the bluetooth subsystem power state */
DECL|function|sonypi_setbluetoothpower
r_static
r_void
id|sonypi_setbluetoothpower
c_func
(paren
id|u8
id|state
)paren
(brace
id|state
op_assign
(paren
id|state
op_ne
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sonypi_device.bluetooth_power
op_logical_and
id|state
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sonypi_device.bluetooth_power
op_logical_and
op_logical_neg
id|state
)paren
r_return
suffix:semicolon
id|sonypi_call2
c_func
(paren
l_int|0x96
comma
id|state
)paren
suffix:semicolon
id|sonypi_call1
c_func
(paren
l_int|0x93
)paren
suffix:semicolon
id|sonypi_device.bluetooth_power
op_assign
id|state
suffix:semicolon
)brace
multiline_comment|/* Interrupt handler: some event is available */
DECL|function|sonypi_irq
r_void
id|sonypi_irq
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|u8
id|v1
comma
id|v2
comma
id|event
op_assign
l_int|0
suffix:semicolon
r_int
id|i
comma
id|j
suffix:semicolon
id|v1
op_assign
id|inb_p
c_func
(paren
id|sonypi_device.ioport1
)paren
suffix:semicolon
id|v2
op_assign
id|inb_p
c_func
(paren
id|sonypi_device.ioport2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|verbose
OG
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;sonypi: event port1=0x%02x,port2=0x%02x&bslash;n&quot;
comma
id|v1
comma
id|v2
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|sonypi_eventtypes
(braket
id|i
)braket
dot
id|model
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|sonypi_device.model
op_ne
id|sonypi_eventtypes
(braket
id|i
)braket
dot
id|model
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
(paren
id|v2
op_amp
id|sonypi_eventtypes
(braket
id|i
)braket
dot
id|data
)paren
op_ne
id|sonypi_eventtypes
(braket
id|i
)braket
dot
id|data
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|mask
op_amp
id|sonypi_eventtypes
(braket
id|i
)braket
dot
id|mask
)paren
)paren
r_continue
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|sonypi_eventtypes
(braket
id|i
)braket
dot
id|events
(braket
id|j
)braket
dot
id|event
suffix:semicolon
id|j
op_increment
)paren
(brace
r_if
c_cond
(paren
id|v1
op_eq
id|sonypi_eventtypes
(braket
id|i
)braket
dot
id|events
(braket
id|j
)braket
dot
id|data
)paren
(brace
id|event
op_assign
id|sonypi_eventtypes
(braket
id|i
)braket
dot
id|events
(braket
id|j
)braket
dot
id|event
suffix:semicolon
r_goto
id|found
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|verbose
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;sonypi: unknown event port1=0x%02x,port2=0x%02x&bslash;n&quot;
comma
id|v1
comma
id|v2
)paren
suffix:semicolon
r_return
suffix:semicolon
id|found
suffix:colon
macro_line|#if defined(CONFIG_INPUT) || defined(CONFIG_INPUT_MODULE)
r_if
c_cond
(paren
id|useinput
)paren
(brace
r_struct
id|input_dev
op_star
id|jog_dev
op_assign
op_amp
id|sonypi_device.jog_dev
suffix:semicolon
r_if
c_cond
(paren
id|event
op_eq
id|SONYPI_EVENT_JOGDIAL_PRESSED
)paren
id|input_report_key
c_func
(paren
id|jog_dev
comma
id|BTN_MIDDLE
comma
l_int|1
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|event
op_eq
id|SONYPI_EVENT_ANYBUTTON_RELEASED
)paren
id|input_report_key
c_func
(paren
id|jog_dev
comma
id|BTN_MIDDLE
comma
l_int|0
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|event
op_eq
id|SONYPI_EVENT_JOGDIAL_UP
)paren
op_logical_or
(paren
id|event
op_eq
id|SONYPI_EVENT_JOGDIAL_UP_PRESSED
)paren
)paren
id|input_report_rel
c_func
(paren
id|jog_dev
comma
id|REL_WHEEL
comma
l_int|1
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|event
op_eq
id|SONYPI_EVENT_JOGDIAL_DOWN
)paren
op_logical_or
(paren
id|event
op_eq
id|SONYPI_EVENT_JOGDIAL_DOWN_PRESSED
)paren
)paren
id|input_report_rel
c_func
(paren
id|jog_dev
comma
id|REL_WHEEL
comma
op_minus
l_int|1
)paren
suffix:semicolon
id|input_sync
c_func
(paren
id|jog_dev
)paren
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_INPUT || CONFIG_INPUT_MODULE */
id|sonypi_pushq
c_func
(paren
id|event
)paren
suffix:semicolon
)brace
multiline_comment|/* External camera command (exported to the motion eye v4l driver) */
DECL|function|sonypi_camera_command
id|u8
id|sonypi_camera_command
c_func
(paren
r_int
id|command
comma
id|u8
id|value
)paren
(brace
id|u8
id|ret
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|camera
)paren
r_return
l_int|0
suffix:semicolon
id|down
c_func
(paren
op_amp
id|sonypi_device.lock
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|command
)paren
(brace
r_case
id|SONYPI_COMMAND_GETCAMERA
suffix:colon
id|ret
op_assign
id|sonypi_camera_ready
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SONYPI_COMMAND_SETCAMERA
suffix:colon
r_if
c_cond
(paren
id|value
)paren
id|sonypi_camera_on
c_func
(paren
)paren
suffix:semicolon
r_else
id|sonypi_camera_off
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SONYPI_COMMAND_GETCAMERABRIGHTNESS
suffix:colon
id|ret
op_assign
id|sonypi_read
c_func
(paren
id|SONYPI_CAMERA_BRIGHTNESS
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SONYPI_COMMAND_SETCAMERABRIGHTNESS
suffix:colon
id|sonypi_set
c_func
(paren
id|SONYPI_CAMERA_BRIGHTNESS
comma
id|value
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SONYPI_COMMAND_GETCAMERACONTRAST
suffix:colon
id|ret
op_assign
id|sonypi_read
c_func
(paren
id|SONYPI_CAMERA_CONTRAST
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SONYPI_COMMAND_SETCAMERACONTRAST
suffix:colon
id|sonypi_set
c_func
(paren
id|SONYPI_CAMERA_CONTRAST
comma
id|value
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SONYPI_COMMAND_GETCAMERAHUE
suffix:colon
id|ret
op_assign
id|sonypi_read
c_func
(paren
id|SONYPI_CAMERA_HUE
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SONYPI_COMMAND_SETCAMERAHUE
suffix:colon
id|sonypi_set
c_func
(paren
id|SONYPI_CAMERA_HUE
comma
id|value
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SONYPI_COMMAND_GETCAMERACOLOR
suffix:colon
id|ret
op_assign
id|sonypi_read
c_func
(paren
id|SONYPI_CAMERA_COLOR
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SONYPI_COMMAND_SETCAMERACOLOR
suffix:colon
id|sonypi_set
c_func
(paren
id|SONYPI_CAMERA_COLOR
comma
id|value
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SONYPI_COMMAND_GETCAMERASHARPNESS
suffix:colon
id|ret
op_assign
id|sonypi_read
c_func
(paren
id|SONYPI_CAMERA_SHARPNESS
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SONYPI_COMMAND_SETCAMERASHARPNESS
suffix:colon
id|sonypi_set
c_func
(paren
id|SONYPI_CAMERA_SHARPNESS
comma
id|value
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SONYPI_COMMAND_GETCAMERAPICTURE
suffix:colon
id|ret
op_assign
id|sonypi_read
c_func
(paren
id|SONYPI_CAMERA_PICTURE
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SONYPI_COMMAND_SETCAMERAPICTURE
suffix:colon
id|sonypi_set
c_func
(paren
id|SONYPI_CAMERA_PICTURE
comma
id|value
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SONYPI_COMMAND_GETCAMERAAGC
suffix:colon
id|ret
op_assign
id|sonypi_read
c_func
(paren
id|SONYPI_CAMERA_AGC
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SONYPI_COMMAND_SETCAMERAAGC
suffix:colon
id|sonypi_set
c_func
(paren
id|SONYPI_CAMERA_AGC
comma
id|value
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SONYPI_COMMAND_GETCAMERADIRECTION
suffix:colon
id|ret
op_assign
id|sonypi_read
c_func
(paren
id|SONYPI_CAMERA_STATUS
)paren
suffix:semicolon
id|ret
op_and_assign
id|SONYPI_DIRECTION_BACKWARDS
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SONYPI_COMMAND_GETCAMERAROMVERSION
suffix:colon
id|ret
op_assign
id|sonypi_read
c_func
(paren
id|SONYPI_CAMERA_ROMVERSION
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SONYPI_COMMAND_GETCAMERAREVISION
suffix:colon
id|ret
op_assign
id|sonypi_read
c_func
(paren
id|SONYPI_CAMERA_REVISION
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|sonypi_device.lock
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|sonypi_misc_fasync
r_static
r_int
id|sonypi_misc_fasync
c_func
(paren
r_int
id|fd
comma
r_struct
id|file
op_star
id|filp
comma
r_int
id|on
)paren
(brace
r_int
id|retval
suffix:semicolon
id|retval
op_assign
id|fasync_helper
c_func
(paren
id|fd
comma
id|filp
comma
id|on
comma
op_amp
id|sonypi_device.queue.fasync
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
OL
l_int|0
)paren
r_return
id|retval
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sonypi_misc_release
r_static
r_int
id|sonypi_misc_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
id|sonypi_misc_fasync
c_func
(paren
op_minus
l_int|1
comma
id|file
comma
l_int|0
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|sonypi_device.lock
)paren
suffix:semicolon
id|sonypi_device.open_count
op_decrement
suffix:semicolon
id|up
c_func
(paren
op_amp
id|sonypi_device.lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sonypi_misc_open
r_static
r_int
id|sonypi_misc_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
id|down
c_func
(paren
op_amp
id|sonypi_device.lock
)paren
suffix:semicolon
multiline_comment|/* Flush input queue on first open */
r_if
c_cond
(paren
op_logical_neg
id|sonypi_device.open_count
)paren
id|sonypi_initq
c_func
(paren
)paren
suffix:semicolon
id|sonypi_device.open_count
op_increment
suffix:semicolon
id|up
c_func
(paren
op_amp
id|sonypi_device.lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sonypi_misc_read
r_static
id|ssize_t
id|sonypi_misc_read
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|pos
)paren
(brace
id|DECLARE_WAITQUEUE
c_func
(paren
id|wait
comma
id|current
)paren
suffix:semicolon
id|ssize_t
id|i
op_assign
id|count
suffix:semicolon
r_int
r_char
id|c
suffix:semicolon
r_if
c_cond
(paren
id|sonypi_emptyq
c_func
(paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|file-&gt;f_flags
op_amp
id|O_NONBLOCK
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
id|add_wait_queue
c_func
(paren
op_amp
id|sonypi_device.queue.proc_list
comma
op_amp
id|wait
)paren
suffix:semicolon
id|repeat
suffix:colon
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sonypi_emptyq
c_func
(paren
)paren
op_logical_and
op_logical_neg
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
id|schedule
c_func
(paren
)paren
suffix:semicolon
r_goto
id|repeat
suffix:semicolon
)brace
id|current-&gt;state
op_assign
id|TASK_RUNNING
suffix:semicolon
id|remove_wait_queue
c_func
(paren
op_amp
id|sonypi_device.queue.proc_list
comma
op_amp
id|wait
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|i
OG
l_int|0
op_logical_and
op_logical_neg
id|sonypi_emptyq
c_func
(paren
)paren
)paren
(brace
id|c
op_assign
id|sonypi_pullq
c_func
(paren
)paren
suffix:semicolon
id|put_user
c_func
(paren
id|c
comma
id|buf
op_increment
)paren
suffix:semicolon
id|i
op_decrement
suffix:semicolon
)brace
r_if
c_cond
(paren
id|count
op_minus
id|i
)paren
(brace
id|file-&gt;f_dentry-&gt;d_inode-&gt;i_atime
op_assign
id|CURRENT_TIME
suffix:semicolon
r_return
id|count
op_minus
id|i
suffix:semicolon
)brace
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
r_return
op_minus
id|ERESTARTSYS
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sonypi_misc_poll
r_static
r_int
r_int
id|sonypi_misc_poll
c_func
(paren
r_struct
id|file
op_star
id|file
comma
id|poll_table
op_star
id|wait
)paren
(brace
id|poll_wait
c_func
(paren
id|file
comma
op_amp
id|sonypi_device.queue.proc_list
comma
id|wait
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sonypi_emptyq
c_func
(paren
)paren
)paren
r_return
id|POLLIN
op_or
id|POLLRDNORM
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sonypi_misc_ioctl
r_static
r_int
id|sonypi_misc_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|ip
comma
r_struct
id|file
op_star
id|fp
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
id|u8
id|val8
suffix:semicolon
id|u16
id|val16
suffix:semicolon
id|down
c_func
(paren
op_amp
id|sonypi_device.lock
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SONYPI_IOCGBRT
suffix:colon
r_if
c_cond
(paren
id|ec_read
c_func
(paren
id|SONYPI_LCD_LIGHT
comma
op_amp
id|val8
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|EIO
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
id|u8
op_star
)paren
id|arg
comma
op_amp
id|val8
comma
r_sizeof
(paren
id|val8
)paren
)paren
)paren
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SONYPI_IOCSBRT
suffix:colon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|val8
comma
(paren
id|u8
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|val8
)paren
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ec_write
c_func
(paren
id|SONYPI_LCD_LIGHT
comma
id|val8
)paren
)paren
id|ret
op_assign
op_minus
id|EIO
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SONYPI_IOCGBAT1CAP
suffix:colon
r_if
c_cond
(paren
id|ec_read16
c_func
(paren
id|SONYPI_BAT1_FULL
comma
op_amp
id|val16
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|EIO
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
id|u16
op_star
)paren
id|arg
comma
op_amp
id|val16
comma
r_sizeof
(paren
id|val16
)paren
)paren
)paren
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SONYPI_IOCGBAT1REM
suffix:colon
r_if
c_cond
(paren
id|ec_read16
c_func
(paren
id|SONYPI_BAT1_FULL
comma
op_amp
id|val16
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|EIO
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
id|u16
op_star
)paren
id|arg
comma
op_amp
id|val16
comma
r_sizeof
(paren
id|val16
)paren
)paren
)paren
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SONYPI_IOCGBAT2CAP
suffix:colon
r_if
c_cond
(paren
id|ec_read16
c_func
(paren
id|SONYPI_BAT1_FULL
comma
op_amp
id|val16
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|EIO
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
id|u16
op_star
)paren
id|arg
comma
op_amp
id|val16
comma
r_sizeof
(paren
id|val16
)paren
)paren
)paren
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SONYPI_IOCGBAT2REM
suffix:colon
r_if
c_cond
(paren
id|ec_read16
c_func
(paren
id|SONYPI_BAT1_FULL
comma
op_amp
id|val16
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|EIO
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
id|u16
op_star
)paren
id|arg
comma
op_amp
id|val16
comma
r_sizeof
(paren
id|val16
)paren
)paren
)paren
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SONYPI_IOCGBATFLAGS
suffix:colon
r_if
c_cond
(paren
id|ec_read
c_func
(paren
id|SONYPI_BAT_FLAGS
comma
op_amp
id|val8
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|EIO
suffix:semicolon
r_break
suffix:semicolon
)brace
id|val8
op_and_assign
l_int|0x07
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
id|u8
op_star
)paren
id|arg
comma
op_amp
id|val8
comma
r_sizeof
(paren
id|val8
)paren
)paren
)paren
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SONYPI_IOCGBLUE
suffix:colon
id|val8
op_assign
id|sonypi_device.bluetooth_power
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
id|u8
op_star
)paren
id|arg
comma
op_amp
id|val8
comma
r_sizeof
(paren
id|val8
)paren
)paren
)paren
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SONYPI_IOCSBLUE
suffix:colon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|val8
comma
(paren
id|u8
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|val8
)paren
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
)brace
id|sonypi_setbluetoothpower
c_func
(paren
id|val8
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|sonypi_device.lock
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|variable|sonypi_misc_fops
r_static
r_struct
id|file_operations
id|sonypi_misc_fops
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|read
op_assign
id|sonypi_misc_read
comma
dot
id|poll
op_assign
id|sonypi_misc_poll
comma
dot
id|open
op_assign
id|sonypi_misc_open
comma
dot
id|release
op_assign
id|sonypi_misc_release
comma
dot
id|fasync
op_assign
id|sonypi_misc_fasync
comma
dot
id|ioctl
op_assign
id|sonypi_misc_ioctl
comma
)brace
suffix:semicolon
DECL|variable|sonypi_misc_device
r_struct
id|miscdevice
id|sonypi_misc_device
op_assign
(brace
op_minus
l_int|1
comma
l_string|&quot;sonypi&quot;
comma
op_amp
id|sonypi_misc_fops
)brace
suffix:semicolon
macro_line|#ifdef CONFIG_PM
DECL|function|sonypi_pm_callback
r_static
r_int
id|sonypi_pm_callback
c_func
(paren
r_struct
id|pm_dev
op_star
id|dev
comma
id|pm_request_t
id|rqst
comma
r_void
op_star
id|data
)paren
(brace
r_static
r_int
id|old_camera_power
suffix:semicolon
r_switch
c_cond
(paren
id|rqst
)paren
(brace
r_case
id|PM_SUSPEND
suffix:colon
id|sonypi_call2
c_func
(paren
l_int|0x81
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* make sure we don&squot;t get any more events */
r_if
c_cond
(paren
id|camera
)paren
(brace
id|old_camera_power
op_assign
id|sonypi_device.camera_power
suffix:semicolon
id|sonypi_camera_off
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sonypi_device.model
op_eq
id|SONYPI_DEVICE_MODEL_TYPE2
)paren
id|sonypi_type2_dis
c_func
(paren
)paren
suffix:semicolon
r_else
id|sonypi_type1_dis
c_func
(paren
)paren
suffix:semicolon
macro_line|#ifndef CONFIG_ACPI
multiline_comment|/* disable ACPI mode */
r_if
c_cond
(paren
id|fnkeyinit
)paren
id|outb
c_func
(paren
l_int|0xf1
comma
l_int|0xb2
)paren
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
r_case
id|PM_RESUME
suffix:colon
macro_line|#ifndef CONFIG_ACPI
multiline_comment|/* Enable ACPI mode to get Fn key events */
r_if
c_cond
(paren
id|fnkeyinit
)paren
id|outb
c_func
(paren
l_int|0xf0
comma
l_int|0xb2
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|sonypi_device.model
op_eq
id|SONYPI_DEVICE_MODEL_TYPE2
)paren
id|sonypi_type2_srs
c_func
(paren
)paren
suffix:semicolon
r_else
id|sonypi_type1_srs
c_func
(paren
)paren
suffix:semicolon
id|sonypi_call1
c_func
(paren
l_int|0x82
)paren
suffix:semicolon
id|sonypi_call2
c_func
(paren
l_int|0x81
comma
l_int|0xff
)paren
suffix:semicolon
r_if
c_cond
(paren
id|compat
)paren
id|sonypi_call1
c_func
(paren
l_int|0x92
)paren
suffix:semicolon
r_else
id|sonypi_call1
c_func
(paren
l_int|0x82
)paren
suffix:semicolon
r_if
c_cond
(paren
id|camera
op_logical_and
id|old_camera_power
)paren
id|sonypi_camera_on
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
DECL|function|sonypi_probe
r_static
r_int
id|__devinit
id|sonypi_probe
c_func
(paren
r_struct
id|pci_dev
op_star
id|pcidev
)paren
(brace
r_int
id|i
comma
id|ret
suffix:semicolon
r_struct
id|sonypi_ioport_list
op_star
id|ioport_list
suffix:semicolon
r_struct
id|sonypi_irq_list
op_star
id|irq_list
suffix:semicolon
id|sonypi_device.dev
op_assign
id|pcidev
suffix:semicolon
r_if
c_cond
(paren
id|pcidev
)paren
id|sonypi_device.model
op_assign
id|SONYPI_DEVICE_MODEL_TYPE1
suffix:semicolon
r_else
id|sonypi_device.model
op_assign
id|SONYPI_DEVICE_MODEL_TYPE2
suffix:semicolon
id|sonypi_initq
c_func
(paren
)paren
suffix:semicolon
id|init_MUTEX
c_func
(paren
op_amp
id|sonypi_device.lock
)paren
suffix:semicolon
id|sonypi_device.bluetooth_power
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|pcidev
op_logical_and
id|pci_enable_device
c_func
(paren
id|pcidev
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;sonypi: pci_enable_device failed&bslash;n&quot;
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|out1
suffix:semicolon
)brace
id|sonypi_misc_device.minor
op_assign
(paren
id|minor
op_eq
op_minus
l_int|1
)paren
ques
c_cond
id|MISC_DYNAMIC_MINOR
suffix:colon
id|minor
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|misc_register
c_func
(paren
op_amp
id|sonypi_misc_device
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;sonypi: misc_register failed&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sonypi_device.model
op_eq
id|SONYPI_DEVICE_MODEL_TYPE2
)paren
(brace
id|ioport_list
op_assign
id|sonypi_type2_ioport_list
suffix:semicolon
id|sonypi_device.region_size
op_assign
id|SONYPI_TYPE2_REGION_SIZE
suffix:semicolon
id|irq_list
op_assign
id|sonypi_type2_irq_list
suffix:semicolon
)brace
r_else
(brace
id|ioport_list
op_assign
id|sonypi_type1_ioport_list
suffix:semicolon
id|sonypi_device.region_size
op_assign
id|SONYPI_TYPE1_REGION_SIZE
suffix:semicolon
id|irq_list
op_assign
id|sonypi_type1_irq_list
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|ioport_list
(braket
id|i
)braket
dot
id|port1
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|request_region
c_func
(paren
id|ioport_list
(braket
id|i
)braket
dot
id|port1
comma
id|sonypi_device.region_size
comma
l_string|&quot;Sony Programable I/O Device&quot;
)paren
)paren
(brace
multiline_comment|/* get the ioport */
id|sonypi_device.ioport1
op_assign
id|ioport_list
(braket
id|i
)braket
dot
id|port1
suffix:semicolon
id|sonypi_device.ioport2
op_assign
id|ioport_list
(braket
id|i
)braket
dot
id|port2
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|sonypi_device.ioport1
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;sonypi: request_region failed&bslash;n&quot;
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|out2
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|irq_list
(braket
id|i
)braket
dot
id|irq
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|request_irq
c_func
(paren
id|irq_list
(braket
id|i
)braket
dot
id|irq
comma
id|sonypi_irq
comma
id|SA_SHIRQ
comma
l_string|&quot;sonypi&quot;
comma
id|sonypi_irq
)paren
)paren
(brace
id|sonypi_device.irq
op_assign
id|irq_list
(braket
id|i
)braket
dot
id|irq
suffix:semicolon
id|sonypi_device.bits
op_assign
id|irq_list
(braket
id|i
)braket
dot
id|bits
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|sonypi_device.irq
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;sonypi: request_irq failed&bslash;n&quot;
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|out3
suffix:semicolon
)brace
macro_line|#ifndef CONFIG_ACPI
multiline_comment|/* Enable ACPI mode to get Fn key events */
r_if
c_cond
(paren
id|fnkeyinit
)paren
id|outb
c_func
(paren
l_int|0xf0
comma
l_int|0xb2
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|sonypi_device.model
op_eq
id|SONYPI_DEVICE_MODEL_TYPE2
)paren
id|sonypi_type2_srs
c_func
(paren
)paren
suffix:semicolon
r_else
id|sonypi_type1_srs
c_func
(paren
)paren
suffix:semicolon
id|sonypi_call1
c_func
(paren
l_int|0x82
)paren
suffix:semicolon
id|sonypi_call2
c_func
(paren
l_int|0x81
comma
l_int|0xff
)paren
suffix:semicolon
r_if
c_cond
(paren
id|compat
)paren
id|sonypi_call1
c_func
(paren
l_int|0x92
)paren
suffix:semicolon
r_else
id|sonypi_call1
c_func
(paren
l_int|0x82
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;sonypi: Sony Programmable I/O Controller Driver v%d.%d.&bslash;n&quot;
comma
id|SONYPI_DRIVER_MAJORVERSION
comma
id|SONYPI_DRIVER_MINORVERSION
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;sonypi: detected %s model, &quot;
l_string|&quot;verbose = %d, fnkeyinit = %s, camera = %s, &quot;
l_string|&quot;compat = %s, mask = 0x%08lx, useinput = %s&bslash;n&quot;
comma
(paren
id|sonypi_device.model
op_eq
id|SONYPI_DEVICE_MODEL_TYPE1
)paren
ques
c_cond
l_string|&quot;type1&quot;
suffix:colon
l_string|&quot;type2&quot;
comma
id|verbose
comma
id|fnkeyinit
ques
c_cond
l_string|&quot;on&quot;
suffix:colon
l_string|&quot;off&quot;
comma
id|camera
ques
c_cond
l_string|&quot;on&quot;
suffix:colon
l_string|&quot;off&quot;
comma
id|compat
ques
c_cond
l_string|&quot;on&quot;
suffix:colon
l_string|&quot;off&quot;
comma
id|mask
comma
id|useinput
ques
c_cond
l_string|&quot;on&quot;
suffix:colon
l_string|&quot;off&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;sonypi: enabled at irq=%d, port1=0x%x, port2=0x%x&bslash;n&quot;
comma
id|sonypi_device.irq
comma
id|sonypi_device.ioport1
comma
id|sonypi_device.ioport2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|minor
op_eq
op_minus
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;sonypi: device allocated minor is %d&bslash;n&quot;
comma
id|sonypi_misc_device.minor
)paren
suffix:semicolon
macro_line|#if defined(CONFIG_INPUT) || defined(CONFIG_INPUT_MODULE)
r_if
c_cond
(paren
id|useinput
)paren
(brace
multiline_comment|/* Initialize the Input Drivers: */
id|sonypi_device.jog_dev.evbit
(braket
l_int|0
)braket
op_assign
id|BIT
c_func
(paren
id|EV_KEY
)paren
op_or
id|BIT
c_func
(paren
id|EV_REL
)paren
suffix:semicolon
id|sonypi_device.jog_dev.keybit
(braket
id|LONG
c_func
(paren
id|BTN_MOUSE
)paren
)braket
op_assign
id|BIT
c_func
(paren
id|BTN_MIDDLE
)paren
suffix:semicolon
id|sonypi_device.jog_dev.relbit
(braket
l_int|0
)braket
op_assign
id|BIT
c_func
(paren
id|REL_WHEEL
)paren
suffix:semicolon
id|sonypi_device.jog_dev.name
op_assign
(paren
r_char
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|SONYPI_INPUTNAME
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|sonypi_device.jog_dev.name
comma
id|SONYPI_INPUTNAME
)paren
suffix:semicolon
id|sonypi_device.jog_dev.id.bustype
op_assign
id|BUS_ISA
suffix:semicolon
id|sonypi_device.jog_dev.id.vendor
op_assign
id|PCI_VENDOR_ID_SONY
suffix:semicolon
id|input_register_device
c_func
(paren
op_amp
id|sonypi_device.jog_dev
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s installed.&bslash;n&quot;
comma
id|sonypi_device.jog_dev.name
)paren
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_INPUT || CONFIG_INPUT_MODULE */
macro_line|#ifdef CONFIG_PM
id|sonypi_device.pm
op_assign
id|pm_register
c_func
(paren
id|PM_PCI_DEV
comma
l_int|0
comma
id|sonypi_pm_callback
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
id|out3
suffix:colon
id|release_region
c_func
(paren
id|sonypi_device.ioport1
comma
id|sonypi_device.region_size
)paren
suffix:semicolon
id|out2
suffix:colon
id|misc_deregister
c_func
(paren
op_amp
id|sonypi_misc_device
)paren
suffix:semicolon
id|out1
suffix:colon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|sonypi_remove
r_static
r_void
id|__devexit
id|sonypi_remove
c_func
(paren
r_void
)paren
(brace
macro_line|#ifdef CONFIG_PM
id|pm_unregister
c_func
(paren
id|sonypi_device.pm
)paren
suffix:semicolon
macro_line|#endif
id|sonypi_call2
c_func
(paren
l_int|0x81
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* make sure we don&squot;t get any more events */
macro_line|#if defined(CONFIG_INPUT) || defined(CONFIG_INPUT_MODULE)
r_if
c_cond
(paren
id|useinput
)paren
(brace
id|input_unregister_device
c_func
(paren
op_amp
id|sonypi_device.jog_dev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|sonypi_device.jog_dev.name
)paren
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_INPUT || CONFIG_INPUT_MODULE */
r_if
c_cond
(paren
id|camera
)paren
id|sonypi_camera_off
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sonypi_device.model
op_eq
id|SONYPI_DEVICE_MODEL_TYPE2
)paren
id|sonypi_type2_dis
c_func
(paren
)paren
suffix:semicolon
r_else
id|sonypi_type1_dis
c_func
(paren
)paren
suffix:semicolon
macro_line|#ifndef CONFIG_ACPI
multiline_comment|/* disable ACPI mode */
r_if
c_cond
(paren
id|fnkeyinit
)paren
id|outb
c_func
(paren
l_int|0xf1
comma
l_int|0xb2
)paren
suffix:semicolon
macro_line|#endif
id|free_irq
c_func
(paren
id|sonypi_device.irq
comma
id|sonypi_irq
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|sonypi_device.ioport1
comma
id|sonypi_device.region_size
)paren
suffix:semicolon
id|misc_deregister
c_func
(paren
op_amp
id|sonypi_misc_device
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;sonypi: removed.&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|sonypi_init_module
r_static
r_int
id|__init
id|sonypi_init_module
c_func
(paren
r_void
)paren
(brace
r_struct
id|pci_dev
op_star
id|pcidev
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|is_sony_vaio_laptop
)paren
(brace
id|pcidev
op_assign
id|pci_find_device
c_func
(paren
id|PCI_VENDOR_ID_INTEL
comma
id|PCI_DEVICE_ID_INTEL_82371AB_3
comma
l_int|NULL
)paren
suffix:semicolon
r_return
id|sonypi_probe
c_func
(paren
id|pcidev
)paren
suffix:semicolon
)brace
r_else
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
DECL|function|sonypi_cleanup_module
r_static
r_void
id|__exit
id|sonypi_cleanup_module
c_func
(paren
r_void
)paren
(brace
id|sonypi_remove
c_func
(paren
)paren
suffix:semicolon
)brace
macro_line|#ifndef MODULE
DECL|function|sonypi_setup
r_static
r_int
id|__init
id|sonypi_setup
c_func
(paren
r_char
op_star
id|str
)paren
(brace
r_int
id|ints
(braket
l_int|8
)braket
suffix:semicolon
id|str
op_assign
id|get_options
c_func
(paren
id|str
comma
id|ARRAY_SIZE
c_func
(paren
id|ints
)paren
comma
id|ints
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ints
(braket
l_int|0
)braket
op_le
l_int|0
)paren
r_goto
id|out
suffix:semicolon
id|minor
op_assign
id|ints
(braket
l_int|1
)braket
suffix:semicolon
r_if
c_cond
(paren
id|ints
(braket
l_int|0
)braket
op_eq
l_int|1
)paren
r_goto
id|out
suffix:semicolon
id|verbose
op_assign
id|ints
(braket
l_int|2
)braket
suffix:semicolon
r_if
c_cond
(paren
id|ints
(braket
l_int|0
)braket
op_eq
l_int|2
)paren
r_goto
id|out
suffix:semicolon
id|fnkeyinit
op_assign
id|ints
(braket
l_int|3
)braket
suffix:semicolon
r_if
c_cond
(paren
id|ints
(braket
l_int|0
)braket
op_eq
l_int|3
)paren
r_goto
id|out
suffix:semicolon
id|camera
op_assign
id|ints
(braket
l_int|4
)braket
suffix:semicolon
r_if
c_cond
(paren
id|ints
(braket
l_int|0
)braket
op_eq
l_int|4
)paren
r_goto
id|out
suffix:semicolon
id|compat
op_assign
id|ints
(braket
l_int|5
)braket
suffix:semicolon
r_if
c_cond
(paren
id|ints
(braket
l_int|0
)braket
op_eq
l_int|5
)paren
r_goto
id|out
suffix:semicolon
id|mask
op_assign
id|ints
(braket
l_int|6
)braket
suffix:semicolon
r_if
c_cond
(paren
id|ints
(braket
l_int|0
)braket
op_eq
l_int|6
)paren
r_goto
id|out
suffix:semicolon
id|useinput
op_assign
id|ints
(braket
l_int|7
)braket
suffix:semicolon
id|out
suffix:colon
r_return
l_int|1
suffix:semicolon
)brace
id|__setup
c_func
(paren
l_string|&quot;sonypi=&quot;
comma
id|sonypi_setup
)paren
suffix:semicolon
macro_line|#endif /* !MODULE */
multiline_comment|/* Module entry points */
DECL|variable|sonypi_init_module
id|module_init
c_func
(paren
id|sonypi_init_module
)paren
suffix:semicolon
DECL|variable|sonypi_cleanup_module
id|module_exit
c_func
(paren
id|sonypi_cleanup_module
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Stelian Pop &lt;stelian@popies.net&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Sony Programmable I/O Control Device driver&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|minor
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|minor
comma
l_string|&quot;minor number of the misc device, default is -1 (automatic)&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|verbose
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|verbose
comma
l_string|&quot;be verbose, default is 0 (no)&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|fnkeyinit
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|fnkeyinit
comma
l_string|&quot;set this if your Fn keys do not generate any event&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|camera
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|camera
comma
l_string|&quot;set this if you have a MotionEye camera (PictureBook series)&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|compat
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|compat
comma
l_string|&quot;set this if you want to enable backward compatibility mode&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|mask
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|mask
comma
l_string|&quot;set this to the mask of event you want to enable (see doc)&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|useinput
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|useinput
comma
l_string|&quot;if you have a jogdial, set this if you would like it to use the modern Linux Input Driver system&quot;
)paren
suffix:semicolon
DECL|variable|sonypi_camera_command
id|EXPORT_SYMBOL
c_func
(paren
id|sonypi_camera_command
)paren
suffix:semicolon
eof
