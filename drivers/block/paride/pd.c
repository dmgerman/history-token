multiline_comment|/* &n;        pd.c    (c) 1997-8  Grant R. Guenther &lt;grant@torque.net&gt;&n;                            Under the terms of the GNU General Public License.&n;&n;        This is the high-level driver for parallel port IDE hard&n;        drives based on chips supported by the paride module.&n;&n;&t;By default, the driver will autoprobe for a single parallel&n;&t;port IDE drive, but if their individual parameters are&n;        specified, the driver can handle up to 4 drives.&n;&n;        The behaviour of the pd driver can be altered by setting&n;        some parameters from the insmod command line.  The following&n;        parameters are adjustable:&n; &n;&t;    drive0  &t;These four arguments can be arrays of&t;    &n;&t;    drive1&t;1-8 integers as follows:&n;&t;    drive2&n;&t;    drive3&t;&lt;prt&gt;,&lt;pro&gt;,&lt;uni&gt;,&lt;mod&gt;,&lt;geo&gt;,&lt;sby&gt;,&lt;dly&gt;,&lt;slv&gt;&n;&n;&t;&t;&t;Where,&n;&n;&t;&t;&lt;prt&gt;&t;is the base of the parallel port address for&n;&t;&t;&t;the corresponding drive.  (required)&n;&n;&t;&t;&lt;pro&gt;   is the protocol number for the adapter that&n;&t;&t;&t;supports this drive.  These numbers are&n;                        logged by &squot;paride&squot; when the protocol modules&n;&t;&t;&t;are initialised.  (0 if not given)&n;&n;&t;&t;&lt;uni&gt;   for those adapters that support chained&n;&t;&t;&t;devices, this is the unit selector for the&n;&t;&t;        chain of devices on the given port.  It should&n;&t;&t;&t;be zero for devices that don&squot;t support chaining.&n;&t;&t;&t;(0 if not given)&n;&n;&t;&t;&lt;mod&gt;   this can be -1 to choose the best mode, or one&n;&t;&t;        of the mode numbers supported by the adapter.&n;&t;&t;&t;(-1 if not given)&n;&n;&t;&t;&lt;geo&gt;   this defaults to 0 to indicate that the driver&n;&t;&t;&t;should use the CHS geometry provided by the drive&n;&t;&t;&t;itself.  If set to 1, the driver will provide&n;&t;&t;&t;a logical geometry with 64 heads and 32 sectors&n;&t;&t;&t;per track, to be consistent with most SCSI&n;&t;&t;        drivers.  (0 if not given)&n;&n;&t;&t;&lt;sby&gt;   set this to zero to disable the power saving&n;&t;&t;&t;standby mode, if needed.  (1 if not given)&n;&n;&t;&t;&lt;dly&gt;   some parallel ports require the driver to &n;&t;&t;&t;go more slowly.  -1 sets a default value that&n;&t;&t;&t;should work with the chosen protocol.  Otherwise,&n;&t;&t;&t;set this to a small integer, the larger it is&n;&t;&t;&t;the slower the port i/o.  In some cases, setting&n;&t;&t;&t;this to zero will speed up the device. (default -1)&n;&n;&t;&t;&lt;slv&gt;   IDE disks can be jumpered to master or slave.&n;                        Set this to 0 to choose the master drive, 1 to&n;                        choose the slave, -1 (the default) to choose the&n;                        first drive found.&n;&t;&t;&t;&n;&n;            major       You may use this parameter to overide the&n;                        default major number (45) that this driver&n;                        will use.  Be sure to change the device&n;                        name as well.&n;&n;            name        This parameter is a character string that&n;                        contains the name the kernel will use for this&n;                        device (in /proc output, for instance).&n;&t;&t;&t;(default &quot;pd&quot;)&n;&n;&t;    cluster&t;The driver will attempt to aggregate requests&n;&t;&t;&t;for adjacent blocks into larger multi-block&n;&t;&t;&t;clusters.  The maximum cluster size (in 512&n;&t;&t;&t;byte sectors) is set with this parameter.&n;&t;&t;&t;(default 64)&n;&n;&t;    verbose&t;This parameter controls the amount of logging&n;&t;&t;&t;that the driver will do.  Set it to 0 for &n;&t;&t;&t;normal operation, 1 to see autoprobe progress&n;&t;&t;&t;messages, or 2 to see additional debugging&n;&t;&t;&t;output.  (default 0)&n;&n;            nice        This parameter controls the driver&squot;s use of&n;                        idle CPU time, at the expense of some speed.&n;&n;        If this driver is built into the kernel, you can use kernel&n;        the following command line parameters, with the same values&n;        as the corresponding module parameters listed above:&n;&n;            pd.drive0&n;            pd.drive1&n;            pd.drive2&n;            pd.drive3&n;            pd.cluster&n;            pd.nice&n;&n;        In addition, you can use the parameter pd.disable to disable&n;        the driver entirely.&n; &n;*/
multiline_comment|/* Changes:&n;&n;&t;1.01&t;GRG 1997.01.24&t;Restored pd_reset()&n;&t;&t;&t;&t;Added eject ioctl&n;&t;1.02    GRG 1998.05.06  SMP spinlock changes, &n;&t;&t;&t;&t;Added slave support&n;&t;1.03    GRG 1998.06.16  Eliminate an Ugh.&n;&t;1.04&t;GRG 1998.08.15  Extra debugging, use HZ in loop timing&n;&t;1.05    GRG 1998.09.24  Added jumbo support&n;&n;*/
DECL|macro|PD_VERSION
mdefine_line|#define PD_VERSION      &quot;1.05&quot;
DECL|macro|PD_MAJOR
mdefine_line|#define PD_MAJOR&t;45
DECL|macro|PD_NAME
mdefine_line|#define PD_NAME&t;&t;&quot;pd&quot;
DECL|macro|PD_UNITS
mdefine_line|#define PD_UNITS&t;4
multiline_comment|/* Here are things one can override from the insmod command.&n;   Most are autoprobed by paride unless set here.  Verbose is off&n;   by default.&n;&n;*/
DECL|variable|verbose
r_static
r_int
id|verbose
op_assign
l_int|0
suffix:semicolon
DECL|variable|major
r_static
r_int
id|major
op_assign
id|PD_MAJOR
suffix:semicolon
DECL|variable|name
r_static
r_char
op_star
id|name
op_assign
id|PD_NAME
suffix:semicolon
DECL|variable|cluster
r_static
r_int
id|cluster
op_assign
l_int|64
suffix:semicolon
DECL|variable|nice
r_static
r_int
id|nice
op_assign
l_int|0
suffix:semicolon
DECL|variable|disable
r_static
r_int
id|disable
op_assign
l_int|0
suffix:semicolon
DECL|variable|drive0
r_static
r_int
id|drive0
(braket
l_int|8
)braket
op_assign
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
op_minus
l_int|1
comma
l_int|0
comma
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
suffix:semicolon
DECL|variable|drive1
r_static
r_int
id|drive1
(braket
l_int|8
)braket
op_assign
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
op_minus
l_int|1
comma
l_int|0
comma
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
suffix:semicolon
DECL|variable|drive2
r_static
r_int
id|drive2
(braket
l_int|8
)braket
op_assign
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
op_minus
l_int|1
comma
l_int|0
comma
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
suffix:semicolon
DECL|variable|drive3
r_static
r_int
id|drive3
(braket
l_int|8
)braket
op_assign
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
op_minus
l_int|1
comma
l_int|0
comma
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
)brace
suffix:semicolon
DECL|variable|drives
r_static
r_int
(paren
op_star
id|drives
(braket
l_int|4
)braket
)paren
(braket
l_int|8
)braket
op_assign
(brace
op_amp
id|drive0
comma
op_amp
id|drive1
comma
op_amp
id|drive2
comma
op_amp
id|drive3
)brace
suffix:semicolon
DECL|enumerator|D_PRT
DECL|enumerator|D_PRO
DECL|enumerator|D_UNI
DECL|enumerator|D_MOD
DECL|enumerator|D_GEO
DECL|enumerator|D_SBY
DECL|enumerator|D_DLY
DECL|enumerator|D_SLV
r_enum
(brace
id|D_PRT
comma
id|D_PRO
comma
id|D_UNI
comma
id|D_MOD
comma
id|D_GEO
comma
id|D_SBY
comma
id|D_DLY
comma
id|D_SLV
)brace
suffix:semicolon
multiline_comment|/* end of parameters */
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/hdreg.h&gt;
macro_line|#include &lt;linux/cdrom.h&gt;&t;/* for the eject ioctl */
macro_line|#include &lt;linux/blkdev.h&gt;
macro_line|#include &lt;linux/blkpg.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/workqueue.h&gt;
DECL|variable|pd_lock
r_static
id|spinlock_t
id|pd_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
macro_line|#ifndef MODULE
macro_line|#include &quot;setup.h&quot;
DECL|variable|pd_stt
r_static
id|STT
id|pd_stt
(braket
l_int|7
)braket
op_assign
(brace
(brace
l_string|&quot;drive0&quot;
comma
l_int|8
comma
id|drive0
)brace
comma
(brace
l_string|&quot;drive1&quot;
comma
l_int|8
comma
id|drive1
)brace
comma
(brace
l_string|&quot;drive2&quot;
comma
l_int|8
comma
id|drive2
)brace
comma
(brace
l_string|&quot;drive3&quot;
comma
l_int|8
comma
id|drive3
)brace
comma
(brace
l_string|&quot;disable&quot;
comma
l_int|1
comma
op_amp
id|disable
)brace
comma
(brace
l_string|&quot;cluster&quot;
comma
l_int|1
comma
op_amp
id|cluster
)brace
comma
(brace
l_string|&quot;nice&quot;
comma
l_int|1
comma
op_amp
id|nice
)brace
)brace
suffix:semicolon
DECL|function|pd_setup
r_void
id|pd_setup
c_func
(paren
r_char
op_star
id|str
comma
r_int
op_star
id|ints
)paren
(brace
id|generic_setup
c_func
(paren
id|pd_stt
comma
l_int|7
comma
id|str
)paren
suffix:semicolon
)brace
macro_line|#endif
id|module_param
c_func
(paren
id|verbose
comma
r_bool
comma
l_int|0
)paren
suffix:semicolon
id|module_param
c_func
(paren
id|major
comma
r_int
comma
l_int|0
)paren
suffix:semicolon
id|module_param
c_func
(paren
id|name
comma
id|charp
comma
l_int|0
)paren
suffix:semicolon
id|module_param
c_func
(paren
id|cluster
comma
r_int
comma
l_int|0
)paren
suffix:semicolon
id|module_param
c_func
(paren
id|nice
comma
r_int
comma
l_int|0
)paren
suffix:semicolon
id|module_param_array
c_func
(paren
id|drive0
comma
r_int
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
id|module_param_array
c_func
(paren
id|drive1
comma
r_int
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
id|module_param_array
c_func
(paren
id|drive2
comma
r_int
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
id|module_param_array
c_func
(paren
id|drive3
comma
r_int
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
macro_line|#include &quot;paride.h&quot;
DECL|macro|PD_BITS
mdefine_line|#define PD_BITS    4
multiline_comment|/* numbers for &quot;SCSI&quot; geometry */
DECL|macro|PD_LOG_HEADS
mdefine_line|#define PD_LOG_HEADS    64
DECL|macro|PD_LOG_SECTS
mdefine_line|#define PD_LOG_SECTS    32
DECL|macro|PD_ID_OFF
mdefine_line|#define PD_ID_OFF       54
DECL|macro|PD_ID_LEN
mdefine_line|#define PD_ID_LEN       14
DECL|macro|PD_MAX_RETRIES
mdefine_line|#define PD_MAX_RETRIES  5
DECL|macro|PD_TMO
mdefine_line|#define PD_TMO          800&t;/* interrupt timeout in jiffies */
DECL|macro|PD_SPIN_DEL
mdefine_line|#define PD_SPIN_DEL     50&t;/* spin delay in micro-seconds  */
DECL|macro|PD_SPIN
mdefine_line|#define PD_SPIN         (1000000*PD_TMO)/(HZ*PD_SPIN_DEL)
DECL|macro|STAT_ERR
mdefine_line|#define STAT_ERR        0x00001
DECL|macro|STAT_INDEX
mdefine_line|#define STAT_INDEX      0x00002
DECL|macro|STAT_ECC
mdefine_line|#define STAT_ECC        0x00004
DECL|macro|STAT_DRQ
mdefine_line|#define STAT_DRQ        0x00008
DECL|macro|STAT_SEEK
mdefine_line|#define STAT_SEEK       0x00010
DECL|macro|STAT_WRERR
mdefine_line|#define STAT_WRERR      0x00020
DECL|macro|STAT_READY
mdefine_line|#define STAT_READY      0x00040
DECL|macro|STAT_BUSY
mdefine_line|#define STAT_BUSY       0x00080
DECL|macro|ERR_AMNF
mdefine_line|#define ERR_AMNF        0x00100
DECL|macro|ERR_TK0NF
mdefine_line|#define ERR_TK0NF       0x00200
DECL|macro|ERR_ABRT
mdefine_line|#define ERR_ABRT        0x00400
DECL|macro|ERR_MCR
mdefine_line|#define ERR_MCR         0x00800
DECL|macro|ERR_IDNF
mdefine_line|#define ERR_IDNF        0x01000
DECL|macro|ERR_MC
mdefine_line|#define ERR_MC          0x02000
DECL|macro|ERR_UNC
mdefine_line|#define ERR_UNC         0x04000
DECL|macro|ERR_TMO
mdefine_line|#define ERR_TMO         0x10000
DECL|macro|IDE_READ
mdefine_line|#define IDE_READ        &t;0x20
DECL|macro|IDE_WRITE
mdefine_line|#define IDE_WRITE       &t;0x30
DECL|macro|IDE_READ_VRFY
mdefine_line|#define IDE_READ_VRFY&t;&t;0x40
DECL|macro|IDE_INIT_DEV_PARMS
mdefine_line|#define IDE_INIT_DEV_PARMS&t;0x91
DECL|macro|IDE_STANDBY
mdefine_line|#define IDE_STANDBY     &t;0x96
DECL|macro|IDE_ACKCHANGE
mdefine_line|#define IDE_ACKCHANGE   &t;0xdb
DECL|macro|IDE_DOORLOCK
mdefine_line|#define IDE_DOORLOCK    &t;0xde
DECL|macro|IDE_DOORUNLOCK
mdefine_line|#define IDE_DOORUNLOCK  &t;0xdf
DECL|macro|IDE_IDENTIFY
mdefine_line|#define IDE_IDENTIFY    &t;0xec
DECL|macro|IDE_EJECT
mdefine_line|#define IDE_EJECT&t;&t;0xed
DECL|macro|PD_NAMELEN
mdefine_line|#define PD_NAMELEN&t;8
DECL|struct|pd_unit
r_struct
id|pd_unit
(brace
DECL|member|pia
r_struct
id|pi_adapter
id|pia
suffix:semicolon
multiline_comment|/* interface to paride layer */
DECL|member|pi
r_struct
id|pi_adapter
op_star
id|pi
suffix:semicolon
DECL|member|access
r_int
id|access
suffix:semicolon
multiline_comment|/* count of active opens ... */
DECL|member|capacity
r_int
id|capacity
suffix:semicolon
multiline_comment|/* Size of this volume in sectors */
DECL|member|heads
r_int
id|heads
suffix:semicolon
multiline_comment|/* physical geometry */
DECL|member|sectors
r_int
id|sectors
suffix:semicolon
DECL|member|cylinders
r_int
id|cylinders
suffix:semicolon
DECL|member|can_lba
r_int
id|can_lba
suffix:semicolon
DECL|member|drive
r_int
id|drive
suffix:semicolon
multiline_comment|/* master=0 slave=1 */
DECL|member|changed
r_int
id|changed
suffix:semicolon
multiline_comment|/* Have we seen a disk change ? */
DECL|member|removable
r_int
id|removable
suffix:semicolon
multiline_comment|/* removable media device  ?  */
DECL|member|standby
r_int
id|standby
suffix:semicolon
DECL|member|alt_geom
r_int
id|alt_geom
suffix:semicolon
DECL|member|name
r_char
id|name
(braket
id|PD_NAMELEN
)braket
suffix:semicolon
multiline_comment|/* pda, pdb, etc ... */
DECL|member|gd
r_struct
id|gendisk
op_star
id|gd
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|pd
r_struct
id|pd_unit
id|pd
(braket
id|PD_UNITS
)braket
suffix:semicolon
DECL|variable|pd_scratch
r_static
r_char
id|pd_scratch
(braket
l_int|512
)braket
suffix:semicolon
multiline_comment|/* scratch block buffer */
DECL|variable|pd_errs
r_static
r_char
op_star
id|pd_errs
(braket
l_int|17
)braket
op_assign
(brace
l_string|&quot;ERR&quot;
comma
l_string|&quot;INDEX&quot;
comma
l_string|&quot;ECC&quot;
comma
l_string|&quot;DRQ&quot;
comma
l_string|&quot;SEEK&quot;
comma
l_string|&quot;WRERR&quot;
comma
l_string|&quot;READY&quot;
comma
l_string|&quot;BUSY&quot;
comma
l_string|&quot;AMNF&quot;
comma
l_string|&quot;TK0NF&quot;
comma
l_string|&quot;ABRT&quot;
comma
l_string|&quot;MCR&quot;
comma
l_string|&quot;IDNF&quot;
comma
l_string|&quot;MC&quot;
comma
l_string|&quot;UNC&quot;
comma
l_string|&quot;???&quot;
comma
l_string|&quot;TMO&quot;
)brace
suffix:semicolon
DECL|function|status_reg
r_static
r_inline
r_int
id|status_reg
c_func
(paren
r_struct
id|pd_unit
op_star
id|disk
)paren
(brace
r_return
id|pi_read_regr
c_func
(paren
id|disk-&gt;pi
comma
l_int|1
comma
l_int|6
)paren
suffix:semicolon
)brace
DECL|function|read_reg
r_static
r_inline
r_int
id|read_reg
c_func
(paren
r_struct
id|pd_unit
op_star
id|disk
comma
r_int
id|reg
)paren
(brace
r_return
id|pi_read_regr
c_func
(paren
id|disk-&gt;pi
comma
l_int|0
comma
id|reg
)paren
suffix:semicolon
)brace
DECL|function|write_status
r_static
r_inline
r_void
id|write_status
c_func
(paren
r_struct
id|pd_unit
op_star
id|disk
comma
r_int
id|val
)paren
(brace
id|pi_write_regr
c_func
(paren
id|disk-&gt;pi
comma
l_int|1
comma
l_int|6
comma
id|val
)paren
suffix:semicolon
)brace
DECL|function|write_reg
r_static
r_inline
r_void
id|write_reg
c_func
(paren
r_struct
id|pd_unit
op_star
id|disk
comma
r_int
id|reg
comma
r_int
id|val
)paren
(brace
id|pi_write_regr
c_func
(paren
id|disk-&gt;pi
comma
l_int|0
comma
id|reg
comma
id|val
)paren
suffix:semicolon
)brace
DECL|function|DRIVE
r_static
r_inline
id|u8
id|DRIVE
c_func
(paren
r_struct
id|pd_unit
op_star
id|disk
)paren
(brace
r_return
l_int|0xa0
op_plus
l_int|0x10
op_star
id|disk-&gt;drive
suffix:semicolon
)brace
multiline_comment|/*  ide command interface */
DECL|function|pd_print_error
r_static
r_void
id|pd_print_error
c_func
(paren
r_struct
id|pd_unit
op_star
id|disk
comma
r_char
op_star
id|msg
comma
r_int
id|status
)paren
(brace
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: %s: status = 0x%x =&quot;
comma
id|disk-&gt;name
comma
id|msg
comma
id|status
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|18
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|status
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
id|printk
c_func
(paren
l_string|&quot; %s&quot;
comma
id|pd_errs
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|pd_reset
r_static
r_void
id|pd_reset
c_func
(paren
r_struct
id|pd_unit
op_star
id|disk
)paren
(brace
multiline_comment|/* called only for MASTER drive */
id|write_status
c_func
(paren
id|disk
comma
l_int|4
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|50
)paren
suffix:semicolon
id|write_status
c_func
(paren
id|disk
comma
l_int|0
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|250
)paren
suffix:semicolon
)brace
DECL|macro|DBMSG
mdefine_line|#define DBMSG(msg)&t;((verbose&gt;1)?(msg):NULL)
DECL|function|pd_wait_for
r_static
r_int
id|pd_wait_for
c_func
(paren
r_struct
id|pd_unit
op_star
id|disk
comma
r_int
id|w
comma
r_char
op_star
id|msg
)paren
(brace
multiline_comment|/* polled wait */
r_int
id|k
comma
id|r
comma
id|e
suffix:semicolon
id|k
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|k
OL
id|PD_SPIN
)paren
(brace
id|r
op_assign
id|status_reg
c_func
(paren
id|disk
)paren
suffix:semicolon
id|k
op_increment
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
id|r
op_amp
id|w
)paren
op_eq
id|w
)paren
op_logical_and
op_logical_neg
(paren
id|r
op_amp
id|STAT_BUSY
)paren
)paren
r_break
suffix:semicolon
id|udelay
c_func
(paren
id|PD_SPIN_DEL
)paren
suffix:semicolon
)brace
id|e
op_assign
(paren
id|read_reg
c_func
(paren
id|disk
comma
l_int|1
)paren
op_lshift
l_int|8
)paren
op_plus
id|read_reg
c_func
(paren
id|disk
comma
l_int|7
)paren
suffix:semicolon
r_if
c_cond
(paren
id|k
op_ge
id|PD_SPIN
)paren
id|e
op_or_assign
id|ERR_TMO
suffix:semicolon
r_if
c_cond
(paren
(paren
id|e
op_amp
(paren
id|STAT_ERR
op_or
id|ERR_TMO
)paren
)paren
op_logical_and
(paren
id|msg
op_ne
l_int|NULL
)paren
)paren
id|pd_print_error
c_func
(paren
id|disk
comma
id|msg
comma
id|e
)paren
suffix:semicolon
r_return
id|e
suffix:semicolon
)brace
DECL|function|pd_send_command
r_static
r_void
id|pd_send_command
c_func
(paren
r_struct
id|pd_unit
op_star
id|disk
comma
r_int
id|n
comma
r_int
id|s
comma
r_int
id|h
comma
r_int
id|c0
comma
r_int
id|c1
comma
r_int
id|func
)paren
(brace
id|write_reg
c_func
(paren
id|disk
comma
l_int|6
comma
id|DRIVE
c_func
(paren
id|disk
)paren
op_plus
id|h
)paren
suffix:semicolon
id|write_reg
c_func
(paren
id|disk
comma
l_int|1
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* the IDE task file */
id|write_reg
c_func
(paren
id|disk
comma
l_int|2
comma
id|n
)paren
suffix:semicolon
id|write_reg
c_func
(paren
id|disk
comma
l_int|3
comma
id|s
)paren
suffix:semicolon
id|write_reg
c_func
(paren
id|disk
comma
l_int|4
comma
id|c0
)paren
suffix:semicolon
id|write_reg
c_func
(paren
id|disk
comma
l_int|5
comma
id|c1
)paren
suffix:semicolon
id|write_reg
c_func
(paren
id|disk
comma
l_int|7
comma
id|func
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|pd_ide_command
r_static
r_void
id|pd_ide_command
c_func
(paren
r_struct
id|pd_unit
op_star
id|disk
comma
r_int
id|func
comma
r_int
id|block
comma
r_int
id|count
)paren
(brace
r_int
id|c1
comma
id|c0
comma
id|h
comma
id|s
suffix:semicolon
r_if
c_cond
(paren
id|disk-&gt;can_lba
)paren
(brace
id|s
op_assign
id|block
op_amp
l_int|255
suffix:semicolon
id|c0
op_assign
(paren
id|block
op_rshift_assign
l_int|8
)paren
op_amp
l_int|255
suffix:semicolon
id|c1
op_assign
(paren
id|block
op_rshift_assign
l_int|8
)paren
op_amp
l_int|255
suffix:semicolon
id|h
op_assign
(paren
(paren
id|block
op_rshift_assign
l_int|8
)paren
op_amp
l_int|15
)paren
op_plus
l_int|0x40
suffix:semicolon
)brace
r_else
(brace
id|s
op_assign
(paren
id|block
op_mod
id|disk-&gt;sectors
)paren
op_plus
l_int|1
suffix:semicolon
id|h
op_assign
(paren
id|block
op_div_assign
id|disk-&gt;sectors
)paren
op_mod
id|disk-&gt;heads
suffix:semicolon
id|c0
op_assign
(paren
id|block
op_div_assign
id|disk-&gt;heads
)paren
op_mod
l_int|256
suffix:semicolon
id|c1
op_assign
(paren
id|block
op_rshift_assign
l_int|8
)paren
suffix:semicolon
)brace
id|pd_send_command
c_func
(paren
id|disk
comma
id|count
comma
id|s
comma
id|h
comma
id|c0
comma
id|c1
comma
id|func
)paren
suffix:semicolon
)brace
multiline_comment|/* The i/o request engine */
DECL|enum|action
DECL|enumerator|Fail
DECL|enumerator|Ok
DECL|enumerator|Hold
DECL|enumerator|Wait
r_enum
id|action
(brace
id|Fail
op_assign
l_int|0
comma
id|Ok
op_assign
l_int|1
comma
id|Hold
comma
id|Wait
)brace
suffix:semicolon
DECL|variable|pd_req
r_static
r_struct
id|request
op_star
id|pd_req
suffix:semicolon
multiline_comment|/* current request */
DECL|variable|phase
r_static
r_enum
id|action
(paren
op_star
id|phase
)paren
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|run_fsm
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|ps_tq_int
c_func
(paren
r_void
op_star
id|data
)paren
suffix:semicolon
r_static
id|DECLARE_WORK
c_func
(paren
id|fsm_tq
comma
id|ps_tq_int
comma
l_int|NULL
)paren
suffix:semicolon
DECL|function|schedule_fsm
r_static
r_void
id|schedule_fsm
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|nice
)paren
id|schedule_work
c_func
(paren
op_amp
id|fsm_tq
)paren
suffix:semicolon
r_else
id|schedule_delayed_work
c_func
(paren
op_amp
id|fsm_tq
comma
id|nice
op_minus
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|ps_tq_int
r_static
r_void
id|ps_tq_int
c_func
(paren
r_void
op_star
id|data
)paren
(brace
id|run_fsm
c_func
(paren
)paren
suffix:semicolon
)brace
r_static
r_enum
id|action
id|do_pd_io_start
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_enum
id|action
id|pd_special
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_enum
id|action
id|do_pd_read_start
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_enum
id|action
id|do_pd_write_start
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_enum
id|action
id|do_pd_read_drq
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_enum
id|action
id|do_pd_write_done
c_func
(paren
r_void
)paren
suffix:semicolon
DECL|variable|pd_queue
r_static
r_struct
id|request_queue
op_star
id|pd_queue
suffix:semicolon
DECL|variable|pd_claimed
r_static
r_int
id|pd_claimed
suffix:semicolon
DECL|variable|pd_current
r_static
r_struct
id|pd_unit
op_star
id|pd_current
suffix:semicolon
multiline_comment|/* current request&squot;s drive */
DECL|variable|pi_current
r_static
id|PIA
op_star
id|pi_current
suffix:semicolon
multiline_comment|/* current request&squot;s PIA */
DECL|function|run_fsm
r_static
r_void
id|run_fsm
c_func
(paren
r_void
)paren
(brace
r_while
c_loop
(paren
l_int|1
)paren
(brace
r_enum
id|action
id|res
suffix:semicolon
r_int
r_int
id|saved_flags
suffix:semicolon
r_int
id|stop
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|phase
)paren
(brace
id|pd_current
op_assign
id|pd_req-&gt;rq_disk-&gt;private_data
suffix:semicolon
id|pi_current
op_assign
id|pd_current-&gt;pi
suffix:semicolon
id|phase
op_assign
id|do_pd_io_start
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|pd_claimed
)paren
(brace
r_case
l_int|0
suffix:colon
id|pd_claimed
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pi_schedule_claimed
c_func
(paren
id|pi_current
comma
id|run_fsm
)paren
)paren
r_return
suffix:semicolon
r_case
l_int|1
suffix:colon
id|pd_claimed
op_assign
l_int|2
suffix:semicolon
id|pi_current-&gt;proto
op_member_access_from_pointer
id|connect
c_func
(paren
id|pi_current
)paren
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|res
op_assign
id|phase
c_func
(paren
)paren
)paren
(brace
r_case
id|Ok
suffix:colon
r_case
id|Fail
suffix:colon
id|pi_disconnect
c_func
(paren
id|pi_current
)paren
suffix:semicolon
id|pd_claimed
op_assign
l_int|0
suffix:semicolon
id|phase
op_assign
l_int|NULL
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|pd_lock
comma
id|saved_flags
)paren
suffix:semicolon
id|end_request
c_func
(paren
id|pd_req
comma
id|res
)paren
suffix:semicolon
id|pd_req
op_assign
id|elv_next_request
c_func
(paren
id|pd_queue
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pd_req
)paren
id|stop
op_assign
l_int|1
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|pd_lock
comma
id|saved_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|stop
)paren
r_return
suffix:semicolon
r_case
id|Hold
suffix:colon
id|schedule_fsm
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
id|Wait
suffix:colon
id|pi_disconnect
c_func
(paren
id|pi_current
)paren
suffix:semicolon
id|pd_claimed
op_assign
l_int|0
suffix:semicolon
)brace
)brace
)brace
DECL|variable|pd_retries
r_static
r_int
id|pd_retries
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* i/o error retry count */
DECL|variable|pd_block
r_static
r_int
id|pd_block
suffix:semicolon
multiline_comment|/* address of next requested block */
DECL|variable|pd_count
r_static
r_int
id|pd_count
suffix:semicolon
multiline_comment|/* number of blocks still to do */
DECL|variable|pd_run
r_static
r_int
id|pd_run
suffix:semicolon
multiline_comment|/* sectors in current cluster */
DECL|variable|pd_cmd
r_static
r_int
id|pd_cmd
suffix:semicolon
multiline_comment|/* current command READ/WRITE */
DECL|variable|pd_buf
r_static
r_char
op_star
id|pd_buf
suffix:semicolon
multiline_comment|/* buffer for request in progress */
DECL|function|do_pd_io_start
r_static
r_enum
id|action
id|do_pd_io_start
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|pd_req-&gt;flags
op_amp
id|REQ_SPECIAL
)paren
(brace
id|phase
op_assign
id|pd_special
suffix:semicolon
r_return
id|pd_special
c_func
(paren
)paren
suffix:semicolon
)brace
id|pd_cmd
op_assign
id|rq_data_dir
c_func
(paren
id|pd_req
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pd_cmd
op_eq
id|READ
op_logical_or
id|pd_cmd
op_eq
id|WRITE
)paren
(brace
id|pd_block
op_assign
id|pd_req-&gt;sector
suffix:semicolon
id|pd_count
op_assign
id|pd_req-&gt;current_nr_sectors
suffix:semicolon
r_if
c_cond
(paren
id|pd_block
op_plus
id|pd_count
OG
id|get_capacity
c_func
(paren
id|pd_req-&gt;rq_disk
)paren
)paren
r_return
id|Fail
suffix:semicolon
id|pd_run
op_assign
id|pd_req-&gt;nr_sectors
suffix:semicolon
id|pd_buf
op_assign
id|pd_req-&gt;buffer
suffix:semicolon
id|pd_retries
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|pd_cmd
op_eq
id|READ
)paren
r_return
id|do_pd_read_start
c_func
(paren
)paren
suffix:semicolon
r_else
r_return
id|do_pd_write_start
c_func
(paren
)paren
suffix:semicolon
)brace
r_return
id|Fail
suffix:semicolon
)brace
DECL|function|pd_special
r_static
r_enum
id|action
id|pd_special
c_func
(paren
r_void
)paren
(brace
r_enum
id|action
(paren
op_star
id|func
)paren
(paren
r_struct
id|pd_unit
op_star
)paren
op_assign
id|pd_req-&gt;special
suffix:semicolon
r_return
id|func
c_func
(paren
id|pd_current
)paren
suffix:semicolon
)brace
DECL|function|pd_next_buf
r_static
r_int
id|pd_next_buf
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|saved_flags
suffix:semicolon
id|pd_count
op_decrement
suffix:semicolon
id|pd_run
op_decrement
suffix:semicolon
id|pd_buf
op_add_assign
l_int|512
suffix:semicolon
id|pd_block
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pd_run
)paren
r_return
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|pd_count
)paren
r_return
l_int|0
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|pd_lock
comma
id|saved_flags
)paren
suffix:semicolon
id|end_request
c_func
(paren
id|pd_req
comma
l_int|1
)paren
suffix:semicolon
id|pd_count
op_assign
id|pd_req-&gt;current_nr_sectors
suffix:semicolon
id|pd_buf
op_assign
id|pd_req-&gt;buffer
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|pd_lock
comma
id|saved_flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|pd_timeout
r_static
r_int
r_int
id|pd_timeout
suffix:semicolon
DECL|function|do_pd_read_start
r_static
r_enum
id|action
id|do_pd_read_start
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|pd_wait_for
c_func
(paren
id|pd_current
comma
id|STAT_READY
comma
l_string|&quot;do_pd_read&quot;
)paren
op_amp
id|STAT_ERR
)paren
(brace
r_if
c_cond
(paren
id|pd_retries
OL
id|PD_MAX_RETRIES
)paren
(brace
id|pd_retries
op_increment
suffix:semicolon
r_return
id|Wait
suffix:semicolon
)brace
r_return
id|Fail
suffix:semicolon
)brace
id|pd_ide_command
c_func
(paren
id|pd_current
comma
id|IDE_READ
comma
id|pd_block
comma
id|pd_run
)paren
suffix:semicolon
id|phase
op_assign
id|do_pd_read_drq
suffix:semicolon
id|pd_timeout
op_assign
id|jiffies
op_plus
id|PD_TMO
suffix:semicolon
r_return
id|Hold
suffix:semicolon
)brace
DECL|function|do_pd_write_start
r_static
r_enum
id|action
id|do_pd_write_start
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|pd_wait_for
c_func
(paren
id|pd_current
comma
id|STAT_READY
comma
l_string|&quot;do_pd_write&quot;
)paren
op_amp
id|STAT_ERR
)paren
(brace
r_if
c_cond
(paren
id|pd_retries
OL
id|PD_MAX_RETRIES
)paren
(brace
id|pd_retries
op_increment
suffix:semicolon
r_return
id|Wait
suffix:semicolon
)brace
r_return
id|Fail
suffix:semicolon
)brace
id|pd_ide_command
c_func
(paren
id|pd_current
comma
id|IDE_WRITE
comma
id|pd_block
comma
id|pd_run
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|pd_wait_for
c_func
(paren
id|pd_current
comma
id|STAT_DRQ
comma
l_string|&quot;do_pd_write_drq&quot;
)paren
op_amp
id|STAT_ERR
)paren
(brace
r_if
c_cond
(paren
id|pd_retries
OL
id|PD_MAX_RETRIES
)paren
(brace
id|pd_retries
op_increment
suffix:semicolon
r_return
id|Wait
suffix:semicolon
)brace
r_return
id|Fail
suffix:semicolon
)brace
id|pi_write_block
c_func
(paren
id|pd_current-&gt;pi
comma
id|pd_buf
comma
l_int|512
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pd_next_buf
c_func
(paren
)paren
)paren
r_break
suffix:semicolon
)brace
id|phase
op_assign
id|do_pd_write_done
suffix:semicolon
id|pd_timeout
op_assign
id|jiffies
op_plus
id|PD_TMO
suffix:semicolon
r_return
id|Hold
suffix:semicolon
)brace
DECL|function|pd_ready
r_static
r_inline
r_int
id|pd_ready
c_func
(paren
r_void
)paren
(brace
r_return
op_logical_neg
(paren
id|status_reg
c_func
(paren
id|pd_current
)paren
op_amp
id|STAT_BUSY
)paren
suffix:semicolon
)brace
DECL|function|do_pd_read_drq
r_static
r_enum
id|action
id|do_pd_read_drq
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|pd_ready
c_func
(paren
)paren
op_logical_and
op_logical_neg
id|time_after_eq
c_func
(paren
id|jiffies
comma
id|pd_timeout
)paren
)paren
r_return
id|Hold
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|pd_wait_for
c_func
(paren
id|pd_current
comma
id|STAT_DRQ
comma
l_string|&quot;do_pd_read_drq&quot;
)paren
op_amp
id|STAT_ERR
)paren
(brace
r_if
c_cond
(paren
id|pd_retries
OL
id|PD_MAX_RETRIES
)paren
(brace
id|pd_retries
op_increment
suffix:semicolon
id|phase
op_assign
id|do_pd_read_start
suffix:semicolon
r_return
id|Wait
suffix:semicolon
)brace
r_return
id|Fail
suffix:semicolon
)brace
id|pi_read_block
c_func
(paren
id|pd_current-&gt;pi
comma
id|pd_buf
comma
l_int|512
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pd_next_buf
c_func
(paren
)paren
)paren
r_break
suffix:semicolon
)brace
r_return
id|Ok
suffix:semicolon
)brace
DECL|function|do_pd_write_done
r_static
r_enum
id|action
id|do_pd_write_done
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|pd_ready
c_func
(paren
)paren
op_logical_and
op_logical_neg
id|time_after_eq
c_func
(paren
id|jiffies
comma
id|pd_timeout
)paren
)paren
r_return
id|Hold
suffix:semicolon
r_if
c_cond
(paren
id|pd_wait_for
c_func
(paren
id|pd_current
comma
id|STAT_READY
comma
l_string|&quot;do_pd_write_done&quot;
)paren
op_amp
id|STAT_ERR
)paren
(brace
r_if
c_cond
(paren
id|pd_retries
OL
id|PD_MAX_RETRIES
)paren
(brace
id|pd_retries
op_increment
suffix:semicolon
id|phase
op_assign
id|do_pd_write_start
suffix:semicolon
r_return
id|Wait
suffix:semicolon
)brace
r_return
id|Fail
suffix:semicolon
)brace
r_return
id|Ok
suffix:semicolon
)brace
multiline_comment|/* special io requests */
multiline_comment|/* According to the ATA standard, the default CHS geometry should be&n;   available following a reset.  Some Western Digital drives come up&n;   in a mode where only LBA addresses are accepted until the device&n;   parameters are initialised.&n;*/
DECL|function|pd_init_dev_parms
r_static
r_void
id|pd_init_dev_parms
c_func
(paren
r_struct
id|pd_unit
op_star
id|disk
)paren
(brace
id|pd_wait_for
c_func
(paren
id|disk
comma
l_int|0
comma
id|DBMSG
c_func
(paren
l_string|&quot;before init_dev_parms&quot;
)paren
)paren
suffix:semicolon
id|pd_send_command
c_func
(paren
id|disk
comma
id|disk-&gt;sectors
comma
l_int|0
comma
id|disk-&gt;heads
op_minus
l_int|1
comma
l_int|0
comma
l_int|0
comma
id|IDE_INIT_DEV_PARMS
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|300
)paren
suffix:semicolon
id|pd_wait_for
c_func
(paren
id|disk
comma
l_int|0
comma
l_string|&quot;Initialise device parameters&quot;
)paren
suffix:semicolon
)brace
DECL|function|pd_door_lock
r_static
r_enum
id|action
id|pd_door_lock
c_func
(paren
r_struct
id|pd_unit
op_star
id|disk
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|pd_wait_for
c_func
(paren
id|disk
comma
id|STAT_READY
comma
l_string|&quot;Lock&quot;
)paren
op_amp
id|STAT_ERR
)paren
)paren
(brace
id|pd_send_command
c_func
(paren
id|disk
comma
l_int|1
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
id|IDE_DOORLOCK
)paren
suffix:semicolon
id|pd_wait_for
c_func
(paren
id|disk
comma
id|STAT_READY
comma
l_string|&quot;Lock done&quot;
)paren
suffix:semicolon
)brace
r_return
id|Ok
suffix:semicolon
)brace
DECL|function|pd_door_unlock
r_static
r_enum
id|action
id|pd_door_unlock
c_func
(paren
r_struct
id|pd_unit
op_star
id|disk
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|pd_wait_for
c_func
(paren
id|disk
comma
id|STAT_READY
comma
l_string|&quot;Lock&quot;
)paren
op_amp
id|STAT_ERR
)paren
)paren
(brace
id|pd_send_command
c_func
(paren
id|disk
comma
l_int|1
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
id|IDE_DOORUNLOCK
)paren
suffix:semicolon
id|pd_wait_for
c_func
(paren
id|disk
comma
id|STAT_READY
comma
l_string|&quot;Lock done&quot;
)paren
suffix:semicolon
)brace
r_return
id|Ok
suffix:semicolon
)brace
DECL|function|pd_eject
r_static
r_enum
id|action
id|pd_eject
c_func
(paren
r_struct
id|pd_unit
op_star
id|disk
)paren
(brace
id|pd_wait_for
c_func
(paren
id|disk
comma
l_int|0
comma
id|DBMSG
c_func
(paren
l_string|&quot;before unlock on eject&quot;
)paren
)paren
suffix:semicolon
id|pd_send_command
c_func
(paren
id|disk
comma
l_int|1
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
id|IDE_DOORUNLOCK
)paren
suffix:semicolon
id|pd_wait_for
c_func
(paren
id|disk
comma
l_int|0
comma
id|DBMSG
c_func
(paren
l_string|&quot;after unlock on eject&quot;
)paren
)paren
suffix:semicolon
id|pd_wait_for
c_func
(paren
id|disk
comma
l_int|0
comma
id|DBMSG
c_func
(paren
l_string|&quot;before eject&quot;
)paren
)paren
suffix:semicolon
id|pd_send_command
c_func
(paren
id|disk
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
id|IDE_EJECT
)paren
suffix:semicolon
id|pd_wait_for
c_func
(paren
id|disk
comma
l_int|0
comma
id|DBMSG
c_func
(paren
l_string|&quot;after eject&quot;
)paren
)paren
suffix:semicolon
r_return
id|Ok
suffix:semicolon
)brace
DECL|function|pd_media_check
r_static
r_enum
id|action
id|pd_media_check
c_func
(paren
r_struct
id|pd_unit
op_star
id|disk
)paren
(brace
r_int
id|r
op_assign
id|pd_wait_for
c_func
(paren
id|disk
comma
id|STAT_READY
comma
id|DBMSG
c_func
(paren
l_string|&quot;before media_check&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|r
op_amp
id|STAT_ERR
)paren
)paren
(brace
id|pd_send_command
c_func
(paren
id|disk
comma
l_int|1
comma
l_int|1
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
id|IDE_READ_VRFY
)paren
suffix:semicolon
id|r
op_assign
id|pd_wait_for
c_func
(paren
id|disk
comma
id|STAT_READY
comma
id|DBMSG
c_func
(paren
l_string|&quot;RDY after READ_VRFY&quot;
)paren
)paren
suffix:semicolon
)brace
r_else
id|disk-&gt;changed
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* say changed if other error */
r_if
c_cond
(paren
id|r
op_amp
id|ERR_MC
)paren
(brace
id|disk-&gt;changed
op_assign
l_int|1
suffix:semicolon
id|pd_send_command
c_func
(paren
id|disk
comma
l_int|1
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
id|IDE_ACKCHANGE
)paren
suffix:semicolon
id|pd_wait_for
c_func
(paren
id|disk
comma
id|STAT_READY
comma
id|DBMSG
c_func
(paren
l_string|&quot;RDY after ACKCHANGE&quot;
)paren
)paren
suffix:semicolon
id|pd_send_command
c_func
(paren
id|disk
comma
l_int|1
comma
l_int|1
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
id|IDE_READ_VRFY
)paren
suffix:semicolon
id|r
op_assign
id|pd_wait_for
c_func
(paren
id|disk
comma
id|STAT_READY
comma
id|DBMSG
c_func
(paren
l_string|&quot;RDY after VRFY&quot;
)paren
)paren
suffix:semicolon
)brace
r_return
id|Ok
suffix:semicolon
)brace
DECL|function|pd_standby_off
r_static
r_void
id|pd_standby_off
c_func
(paren
r_struct
id|pd_unit
op_star
id|disk
)paren
(brace
id|pd_wait_for
c_func
(paren
id|disk
comma
l_int|0
comma
id|DBMSG
c_func
(paren
l_string|&quot;before STANDBY&quot;
)paren
)paren
suffix:semicolon
id|pd_send_command
c_func
(paren
id|disk
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
id|IDE_STANDBY
)paren
suffix:semicolon
id|pd_wait_for
c_func
(paren
id|disk
comma
l_int|0
comma
id|DBMSG
c_func
(paren
l_string|&quot;after STANDBY&quot;
)paren
)paren
suffix:semicolon
)brace
DECL|function|pd_identify
r_static
r_enum
id|action
id|pd_identify
c_func
(paren
r_struct
id|pd_unit
op_star
id|disk
)paren
(brace
r_int
id|j
suffix:semicolon
r_char
id|id
(braket
id|PD_ID_LEN
op_plus
l_int|1
)braket
suffix:semicolon
multiline_comment|/* WARNING:  here there may be dragons.  reset() applies to both drives,&n;   but we call it only on probing the MASTER. This should allow most&n;   common configurations to work, but be warned that a reset can clear&n;   settings on the SLAVE drive.&n;*/
r_if
c_cond
(paren
id|disk-&gt;drive
op_eq
l_int|0
)paren
id|pd_reset
c_func
(paren
id|disk
)paren
suffix:semicolon
id|write_reg
c_func
(paren
id|disk
comma
l_int|6
comma
id|DRIVE
c_func
(paren
id|disk
)paren
)paren
suffix:semicolon
id|pd_wait_for
c_func
(paren
id|disk
comma
l_int|0
comma
id|DBMSG
c_func
(paren
l_string|&quot;before IDENT&quot;
)paren
)paren
suffix:semicolon
id|pd_send_command
c_func
(paren
id|disk
comma
l_int|1
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
id|IDE_IDENTIFY
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pd_wait_for
c_func
(paren
id|disk
comma
id|STAT_DRQ
comma
id|DBMSG
c_func
(paren
l_string|&quot;IDENT DRQ&quot;
)paren
)paren
op_amp
id|STAT_ERR
)paren
r_return
id|Fail
suffix:semicolon
id|pi_read_block
c_func
(paren
id|disk-&gt;pi
comma
id|pd_scratch
comma
l_int|512
)paren
suffix:semicolon
id|disk-&gt;can_lba
op_assign
id|pd_scratch
(braket
l_int|99
)braket
op_amp
l_int|2
suffix:semicolon
id|disk-&gt;sectors
op_assign
id|le16_to_cpu
c_func
(paren
op_star
(paren
id|u16
op_star
)paren
(paren
id|pd_scratch
op_plus
l_int|12
)paren
)paren
suffix:semicolon
id|disk-&gt;heads
op_assign
id|le16_to_cpu
c_func
(paren
op_star
(paren
id|u16
op_star
)paren
(paren
id|pd_scratch
op_plus
l_int|6
)paren
)paren
suffix:semicolon
id|disk-&gt;cylinders
op_assign
id|le16_to_cpu
c_func
(paren
op_star
(paren
id|u16
op_star
)paren
(paren
id|pd_scratch
op_plus
l_int|2
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|disk-&gt;can_lba
)paren
id|disk-&gt;capacity
op_assign
id|le32_to_cpu
c_func
(paren
op_star
(paren
id|u32
op_star
)paren
(paren
id|pd_scratch
op_plus
l_int|120
)paren
)paren
suffix:semicolon
r_else
id|disk-&gt;capacity
op_assign
id|disk-&gt;sectors
op_star
id|disk-&gt;heads
op_star
id|disk-&gt;cylinders
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|PD_ID_LEN
suffix:semicolon
id|j
op_increment
)paren
id|id
(braket
id|j
op_xor
l_int|1
)braket
op_assign
id|pd_scratch
(braket
id|j
op_plus
id|PD_ID_OFF
)braket
suffix:semicolon
id|j
op_assign
id|PD_ID_LEN
op_minus
l_int|1
suffix:semicolon
r_while
c_loop
(paren
(paren
id|j
op_ge
l_int|0
)paren
op_logical_and
(paren
id|id
(braket
id|j
)braket
op_le
l_int|0x20
)paren
)paren
id|j
op_decrement
suffix:semicolon
id|j
op_increment
suffix:semicolon
id|id
(braket
id|j
)braket
op_assign
l_int|0
suffix:semicolon
id|disk-&gt;removable
op_assign
id|pd_scratch
(braket
l_int|0
)braket
op_amp
l_int|0x80
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: %s, %s, %d blocks [%dM], (%d/%d/%d), %s media&bslash;n&quot;
comma
id|disk-&gt;name
comma
id|id
comma
id|disk-&gt;drive
ques
c_cond
l_string|&quot;slave&quot;
suffix:colon
l_string|&quot;master&quot;
comma
id|disk-&gt;capacity
comma
id|disk-&gt;capacity
op_div
l_int|2048
comma
id|disk-&gt;cylinders
comma
id|disk-&gt;heads
comma
id|disk-&gt;sectors
comma
id|disk-&gt;removable
ques
c_cond
l_string|&quot;removable&quot;
suffix:colon
l_string|&quot;fixed&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|disk-&gt;capacity
)paren
id|pd_init_dev_parms
c_func
(paren
id|disk
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|disk-&gt;standby
)paren
id|pd_standby_off
c_func
(paren
id|disk
)paren
suffix:semicolon
r_return
id|Ok
suffix:semicolon
)brace
multiline_comment|/* end of io request engine */
DECL|function|do_pd_request
r_static
r_void
id|do_pd_request
c_func
(paren
id|request_queue_t
op_star
id|q
)paren
(brace
r_if
c_cond
(paren
id|pd_req
)paren
r_return
suffix:semicolon
id|pd_req
op_assign
id|elv_next_request
c_func
(paren
id|q
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pd_req
)paren
r_return
suffix:semicolon
id|schedule_fsm
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|pd_special_command
r_static
r_int
id|pd_special_command
c_func
(paren
r_struct
id|pd_unit
op_star
id|disk
comma
r_enum
id|action
(paren
op_star
id|func
)paren
(paren
r_struct
id|pd_unit
op_star
id|disk
)paren
)paren
(brace
id|DECLARE_COMPLETION
c_func
(paren
id|wait
)paren
suffix:semicolon
r_struct
id|request
id|rq
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|rq
comma
l_int|0
comma
r_sizeof
(paren
id|rq
)paren
)paren
suffix:semicolon
id|rq.errors
op_assign
l_int|0
suffix:semicolon
id|rq.rq_status
op_assign
id|RQ_ACTIVE
suffix:semicolon
id|rq.rq_disk
op_assign
id|disk-&gt;gd
suffix:semicolon
id|rq.ref_count
op_assign
l_int|1
suffix:semicolon
id|rq.waiting
op_assign
op_amp
id|wait
suffix:semicolon
id|blk_insert_request
c_func
(paren
id|disk-&gt;gd-&gt;queue
comma
op_amp
id|rq
comma
l_int|0
comma
id|func
comma
l_int|0
)paren
suffix:semicolon
id|wait_for_completion
c_func
(paren
op_amp
id|wait
)paren
suffix:semicolon
id|rq.waiting
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|rq.errors
)paren
id|err
op_assign
op_minus
id|EIO
suffix:semicolon
id|blk_put_request
c_func
(paren
op_amp
id|rq
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/* kernel glue structures */
DECL|function|pd_open
r_static
r_int
id|pd_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|pd_unit
op_star
id|disk
op_assign
id|inode-&gt;i_bdev-&gt;bd_disk-&gt;private_data
suffix:semicolon
id|disk-&gt;access
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|disk-&gt;removable
)paren
(brace
id|pd_special_command
c_func
(paren
id|disk
comma
id|pd_media_check
)paren
suffix:semicolon
id|pd_special_command
c_func
(paren
id|disk
comma
id|pd_door_lock
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pd_ioctl
r_static
r_int
id|pd_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_struct
id|pd_unit
op_star
id|disk
op_assign
id|inode-&gt;i_bdev-&gt;bd_disk-&gt;private_data
suffix:semicolon
r_struct
id|hd_geometry
id|__user
op_star
id|geo
op_assign
(paren
r_struct
id|hd_geometry
id|__user
op_star
)paren
id|arg
suffix:semicolon
r_struct
id|hd_geometry
id|g
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|CDROMEJECT
suffix:colon
r_if
c_cond
(paren
id|disk-&gt;access
op_eq
l_int|1
)paren
id|pd_special_command
c_func
(paren
id|disk
comma
id|pd_eject
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|HDIO_GETGEO
suffix:colon
r_if
c_cond
(paren
id|disk-&gt;alt_geom
)paren
(brace
id|g.heads
op_assign
id|PD_LOG_HEADS
suffix:semicolon
id|g.sectors
op_assign
id|PD_LOG_SECTS
suffix:semicolon
id|g.cylinders
op_assign
id|disk-&gt;capacity
op_div
(paren
id|g.heads
op_star
id|g.sectors
)paren
suffix:semicolon
)brace
r_else
(brace
id|g.heads
op_assign
id|disk-&gt;heads
suffix:semicolon
id|g.sectors
op_assign
id|disk-&gt;sectors
suffix:semicolon
id|g.cylinders
op_assign
id|disk-&gt;cylinders
suffix:semicolon
)brace
id|g.start
op_assign
id|get_start_sect
c_func
(paren
id|inode-&gt;i_bdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|geo
comma
op_amp
id|g
comma
r_sizeof
(paren
r_struct
id|hd_geometry
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
DECL|function|pd_release
r_static
r_int
id|pd_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|pd_unit
op_star
id|disk
op_assign
id|inode-&gt;i_bdev-&gt;bd_disk-&gt;private_data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
op_decrement
id|disk-&gt;access
op_logical_and
id|disk-&gt;removable
)paren
id|pd_special_command
c_func
(paren
id|disk
comma
id|pd_door_unlock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pd_check_media
r_static
r_int
id|pd_check_media
c_func
(paren
r_struct
id|gendisk
op_star
id|p
)paren
(brace
r_struct
id|pd_unit
op_star
id|disk
op_assign
id|p-&gt;private_data
suffix:semicolon
r_int
id|r
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|disk-&gt;removable
)paren
r_return
l_int|0
suffix:semicolon
id|pd_special_command
c_func
(paren
id|disk
comma
id|pd_media_check
)paren
suffix:semicolon
id|r
op_assign
id|disk-&gt;changed
suffix:semicolon
id|disk-&gt;changed
op_assign
l_int|0
suffix:semicolon
r_return
id|r
suffix:semicolon
)brace
DECL|function|pd_revalidate
r_static
r_int
id|pd_revalidate
c_func
(paren
r_struct
id|gendisk
op_star
id|p
)paren
(brace
r_struct
id|pd_unit
op_star
id|disk
op_assign
id|p-&gt;private_data
suffix:semicolon
r_if
c_cond
(paren
id|pd_special_command
c_func
(paren
id|disk
comma
id|pd_identify
)paren
op_eq
l_int|0
)paren
id|set_capacity
c_func
(paren
id|p
comma
id|disk-&gt;capacity
)paren
suffix:semicolon
r_else
id|set_capacity
c_func
(paren
id|p
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|pd_fops
r_static
r_struct
id|block_device_operations
id|pd_fops
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|open
op_assign
id|pd_open
comma
dot
id|release
op_assign
id|pd_release
comma
dot
id|ioctl
op_assign
id|pd_ioctl
comma
dot
id|media_changed
op_assign
id|pd_check_media
comma
dot
id|revalidate_disk
op_assign
id|pd_revalidate
)brace
suffix:semicolon
multiline_comment|/* probing */
DECL|function|pd_probe_drive
r_static
r_void
id|pd_probe_drive
c_func
(paren
r_struct
id|pd_unit
op_star
id|disk
)paren
(brace
r_struct
id|gendisk
op_star
id|p
op_assign
id|alloc_disk
c_func
(paren
l_int|1
op_lshift
id|PD_BITS
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|p
)paren
r_return
suffix:semicolon
id|strcpy
c_func
(paren
id|p-&gt;disk_name
comma
id|disk-&gt;name
)paren
suffix:semicolon
id|p-&gt;fops
op_assign
op_amp
id|pd_fops
suffix:semicolon
id|p-&gt;major
op_assign
id|major
suffix:semicolon
id|p-&gt;first_minor
op_assign
(paren
id|disk
op_minus
id|pd
)paren
op_lshift
id|PD_BITS
suffix:semicolon
id|disk-&gt;gd
op_assign
id|p
suffix:semicolon
id|p-&gt;private_data
op_assign
id|disk
suffix:semicolon
id|p-&gt;queue
op_assign
id|pd_queue
suffix:semicolon
r_if
c_cond
(paren
id|disk-&gt;drive
op_eq
op_minus
l_int|1
)paren
(brace
r_for
c_loop
(paren
id|disk-&gt;drive
op_assign
l_int|0
suffix:semicolon
id|disk-&gt;drive
op_le
l_int|1
suffix:semicolon
id|disk-&gt;drive
op_increment
)paren
r_if
c_cond
(paren
id|pd_special_command
c_func
(paren
id|disk
comma
id|pd_identify
)paren
op_eq
l_int|0
)paren
r_return
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|pd_special_command
c_func
(paren
id|disk
comma
id|pd_identify
)paren
op_eq
l_int|0
)paren
r_return
suffix:semicolon
id|disk-&gt;gd
op_assign
l_int|NULL
suffix:semicolon
id|put_disk
c_func
(paren
id|p
)paren
suffix:semicolon
)brace
DECL|function|pd_detect
r_static
r_int
id|pd_detect
c_func
(paren
r_void
)paren
(brace
r_int
id|found
op_assign
l_int|0
comma
id|unit
comma
id|pd_drive_count
op_assign
l_int|0
suffix:semicolon
r_struct
id|pd_unit
op_star
id|disk
suffix:semicolon
r_for
c_loop
(paren
id|unit
op_assign
l_int|0
suffix:semicolon
id|unit
OL
id|PD_UNITS
suffix:semicolon
id|unit
op_increment
)paren
(brace
r_int
op_star
id|parm
op_assign
op_star
id|drives
(braket
id|unit
)braket
suffix:semicolon
r_struct
id|pd_unit
op_star
id|disk
op_assign
id|pd
op_plus
id|unit
suffix:semicolon
id|disk-&gt;pi
op_assign
op_amp
id|disk-&gt;pia
suffix:semicolon
id|disk-&gt;access
op_assign
l_int|0
suffix:semicolon
id|disk-&gt;changed
op_assign
l_int|1
suffix:semicolon
id|disk-&gt;capacity
op_assign
l_int|0
suffix:semicolon
id|disk-&gt;drive
op_assign
id|parm
(braket
id|D_SLV
)braket
suffix:semicolon
id|snprintf
c_func
(paren
id|disk-&gt;name
comma
id|PD_NAMELEN
comma
l_string|&quot;%s%c&quot;
comma
id|name
comma
l_char|&squot;a&squot;
op_plus
id|unit
)paren
suffix:semicolon
id|disk-&gt;alt_geom
op_assign
id|parm
(braket
id|D_GEO
)braket
suffix:semicolon
id|disk-&gt;standby
op_assign
id|parm
(braket
id|D_SBY
)braket
suffix:semicolon
r_if
c_cond
(paren
id|parm
(braket
id|D_PRT
)braket
)paren
id|pd_drive_count
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pd_drive_count
op_eq
l_int|0
)paren
(brace
multiline_comment|/* nothing spec&squot;d - so autoprobe for 1 */
id|disk
op_assign
id|pd
suffix:semicolon
r_if
c_cond
(paren
id|pi_init
c_func
(paren
id|disk-&gt;pi
comma
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
id|pd_scratch
comma
id|PI_PD
comma
id|verbose
comma
id|disk-&gt;name
)paren
)paren
(brace
id|pd_probe_drive
c_func
(paren
id|disk
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|disk-&gt;gd
)paren
id|pi_release
c_func
(paren
id|disk-&gt;pi
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
r_for
c_loop
(paren
id|unit
op_assign
l_int|0
comma
id|disk
op_assign
id|pd
suffix:semicolon
id|unit
OL
id|PD_UNITS
suffix:semicolon
id|unit
op_increment
comma
id|disk
op_increment
)paren
(brace
r_int
op_star
id|parm
op_assign
op_star
id|drives
(braket
id|unit
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|parm
(braket
id|D_PRT
)braket
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|pi_init
c_func
(paren
id|disk-&gt;pi
comma
l_int|0
comma
id|parm
(braket
id|D_PRT
)braket
comma
id|parm
(braket
id|D_MOD
)braket
comma
id|parm
(braket
id|D_UNI
)braket
comma
id|parm
(braket
id|D_PRO
)braket
comma
id|parm
(braket
id|D_DLY
)braket
comma
id|pd_scratch
comma
id|PI_PD
comma
id|verbose
comma
id|disk-&gt;name
)paren
)paren
(brace
id|pd_probe_drive
c_func
(paren
id|disk
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|disk-&gt;gd
)paren
id|pi_release
c_func
(paren
id|disk-&gt;pi
)paren
suffix:semicolon
)brace
)brace
)brace
r_for
c_loop
(paren
id|unit
op_assign
l_int|0
comma
id|disk
op_assign
id|pd
suffix:semicolon
id|unit
OL
id|PD_UNITS
suffix:semicolon
id|unit
op_increment
comma
id|disk
op_increment
)paren
(brace
r_if
c_cond
(paren
id|disk-&gt;gd
)paren
(brace
id|set_capacity
c_func
(paren
id|disk-&gt;gd
comma
id|disk-&gt;capacity
)paren
suffix:semicolon
id|add_disk
c_func
(paren
id|disk-&gt;gd
)paren
suffix:semicolon
id|found
op_assign
l_int|1
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|found
)paren
id|printk
c_func
(paren
l_string|&quot;%s: no valid drive found&bslash;n&quot;
comma
id|name
)paren
suffix:semicolon
r_return
id|found
suffix:semicolon
)brace
DECL|function|pd_init
r_static
r_int
id|__init
id|pd_init
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|disable
)paren
r_goto
id|out1
suffix:semicolon
id|pd_queue
op_assign
id|blk_init_queue
c_func
(paren
id|do_pd_request
comma
op_amp
id|pd_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pd_queue
)paren
r_goto
id|out1
suffix:semicolon
id|blk_queue_max_sectors
c_func
(paren
id|pd_queue
comma
id|cluster
)paren
suffix:semicolon
r_if
c_cond
(paren
id|register_blkdev
c_func
(paren
id|major
comma
id|name
)paren
)paren
r_goto
id|out2
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: %s version %s, major %d, cluster %d, nice %d&bslash;n&quot;
comma
id|name
comma
id|name
comma
id|PD_VERSION
comma
id|major
comma
id|cluster
comma
id|nice
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pd_detect
c_func
(paren
)paren
)paren
r_goto
id|out3
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|out3
suffix:colon
id|unregister_blkdev
c_func
(paren
id|major
comma
id|name
)paren
suffix:semicolon
id|out2
suffix:colon
id|blk_cleanup_queue
c_func
(paren
id|pd_queue
)paren
suffix:semicolon
id|out1
suffix:colon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
DECL|function|pd_exit
r_static
r_void
id|__exit
id|pd_exit
c_func
(paren
r_void
)paren
(brace
r_struct
id|pd_unit
op_star
id|disk
suffix:semicolon
r_int
id|unit
suffix:semicolon
id|unregister_blkdev
c_func
(paren
id|major
comma
id|name
)paren
suffix:semicolon
r_for
c_loop
(paren
id|unit
op_assign
l_int|0
comma
id|disk
op_assign
id|pd
suffix:semicolon
id|unit
OL
id|PD_UNITS
suffix:semicolon
id|unit
op_increment
comma
id|disk
op_increment
)paren
(brace
r_struct
id|gendisk
op_star
id|p
op_assign
id|disk-&gt;gd
suffix:semicolon
r_if
c_cond
(paren
id|p
)paren
(brace
id|disk-&gt;gd
op_assign
l_int|NULL
suffix:semicolon
id|del_gendisk
c_func
(paren
id|p
)paren
suffix:semicolon
id|put_disk
c_func
(paren
id|p
)paren
suffix:semicolon
id|pi_release
c_func
(paren
id|disk-&gt;pi
)paren
suffix:semicolon
)brace
)brace
id|blk_cleanup_queue
c_func
(paren
id|pd_queue
)paren
suffix:semicolon
)brace
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|module_init
c_func
(paren
id|pd_init
)paren
id|module_exit
c_func
(paren
id|pd_exit
)paren
eof
