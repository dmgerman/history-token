multiline_comment|/*&n; *    Disk Array driver for HP SA 5xxx and 6xxx Controllers&n; *    Copyright 2000, 2002 Hewlett-Packard Development Company, L.P.&n; *&n; *    This program is free software; you can redistribute it and/or modify&n; *    it under the terms of the GNU General Public License as published by&n; *    the Free Software Foundation; either version 2 of the License, or&n; *    (at your option) any later version.&n; *&n; *    This program is distributed in the hope that it will be useful,&n; *    but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *    MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE, GOOD TITLE or&n; *    NON INFRINGEMENT.  See the GNU General Public License for more details.&n; *&n; *    You should have received a copy of the GNU General Public License&n; *    along with this program; if not, write to the Free Software&n; *    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; *    Questions/Comments/Bugfixes to iss_storagedev@hp.com&n; *&n; */
macro_line|#include &lt;linux/config.h&gt;&t;/* CONFIG_PROC_FS */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/major.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/bio.h&gt;
macro_line|#include &lt;linux/blkpg.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/init.h&gt; 
macro_line|#include &lt;linux/hdreg.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/compat.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;linux/blkdev.h&gt;
macro_line|#include &lt;linux/genhd.h&gt;
macro_line|#include &lt;linux/completion.h&gt;
DECL|macro|CCISS_DRIVER_VERSION
mdefine_line|#define CCISS_DRIVER_VERSION(maj,min,submin) ((maj&lt;&lt;16)|(min&lt;&lt;8)|(submin))
DECL|macro|DRIVER_NAME
mdefine_line|#define DRIVER_NAME &quot;HP CISS Driver (v 2.6.2)&quot;
DECL|macro|DRIVER_VERSION
mdefine_line|#define DRIVER_VERSION CCISS_DRIVER_VERSION(2,6,2)
multiline_comment|/* Embedded module documentation macros - see modules.h */
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Hewlett-Packard Company&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Driver for HP Controller SA5xxx SA6xxx version 2.6.2&quot;
)paren
suffix:semicolon
id|MODULE_SUPPORTED_DEVICE
c_func
(paren
l_string|&quot;HP SA5i SA5i+ SA532 SA5300 SA5312 SA641 SA642 SA6400&quot;
l_string|&quot; SA6i V100&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
macro_line|#include &quot;cciss_cmd.h&quot;
macro_line|#include &quot;cciss.h&quot;
macro_line|#include &lt;linux/cciss_ioctl.h&gt;
multiline_comment|/* define the PCI info for the cards we can control */
DECL|variable|cciss_pci_device_id
r_const
r_struct
id|pci_device_id
id|cciss_pci_device_id
(braket
)braket
op_assign
(brace
(brace
id|PCI_VENDOR_ID_COMPAQ
comma
id|PCI_DEVICE_ID_COMPAQ_CISS
comma
l_int|0x0E11
comma
l_int|0x4070
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
(brace
id|PCI_VENDOR_ID_COMPAQ
comma
id|PCI_DEVICE_ID_COMPAQ_CISSB
comma
l_int|0x0E11
comma
l_int|0x4080
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
(brace
id|PCI_VENDOR_ID_COMPAQ
comma
id|PCI_DEVICE_ID_COMPAQ_CISSB
comma
l_int|0x0E11
comma
l_int|0x4082
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
(brace
id|PCI_VENDOR_ID_COMPAQ
comma
id|PCI_DEVICE_ID_COMPAQ_CISSB
comma
l_int|0x0E11
comma
l_int|0x4083
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
(brace
id|PCI_VENDOR_ID_COMPAQ
comma
id|PCI_DEVICE_ID_COMPAQ_CISSC
comma
l_int|0x0E11
comma
l_int|0x409A
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
(brace
id|PCI_VENDOR_ID_COMPAQ
comma
id|PCI_DEVICE_ID_COMPAQ_CISSC
comma
l_int|0x0E11
comma
l_int|0x409B
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
(brace
id|PCI_VENDOR_ID_COMPAQ
comma
id|PCI_DEVICE_ID_COMPAQ_CISSC
comma
l_int|0x0E11
comma
l_int|0x409C
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
(brace
id|PCI_VENDOR_ID_COMPAQ
comma
id|PCI_DEVICE_ID_COMPAQ_CISSC
comma
l_int|0x0E11
comma
l_int|0x409D
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
(brace
id|PCI_VENDOR_ID_COMPAQ
comma
id|PCI_DEVICE_ID_COMPAQ_CISSC
comma
l_int|0x0E11
comma
l_int|0x4091
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
(brace
id|PCI_VENDOR_ID_COMPAQ
comma
id|PCI_DEVICE_ID_COMPAQ_CISSC
comma
l_int|0x0E11
comma
l_int|0x409E
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
(brace
id|PCI_VENDOR_ID_HP
comma
id|PCI_DEVICE_ID_HP_CISS
comma
l_int|0x103C
comma
l_int|0x3211
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
)brace
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|pci
comma
id|cciss_pci_device_id
)paren
suffix:semicolon
DECL|macro|NR_PRODUCTS
mdefine_line|#define NR_PRODUCTS (sizeof(products)/sizeof(struct board_type))
multiline_comment|/*  board_id = Subsystem Device ID &amp; Vendor ID&n; *  product = Marketing Name for the board&n; *  access = Address of the struct of function pointers &n; */
DECL|variable|products
r_static
r_struct
id|board_type
id|products
(braket
)braket
op_assign
(brace
(brace
l_int|0x40700E11
comma
l_string|&quot;Smart Array 5300&quot;
comma
op_amp
id|SA5_access
)brace
comma
(brace
l_int|0x40800E11
comma
l_string|&quot;Smart Array 5i&quot;
comma
op_amp
id|SA5B_access
)brace
comma
(brace
l_int|0x40820E11
comma
l_string|&quot;Smart Array 532&quot;
comma
op_amp
id|SA5B_access
)brace
comma
(brace
l_int|0x40830E11
comma
l_string|&quot;Smart Array 5312&quot;
comma
op_amp
id|SA5B_access
)brace
comma
(brace
l_int|0x409A0E11
comma
l_string|&quot;Smart Array 641&quot;
comma
op_amp
id|SA5_access
)brace
comma
(brace
l_int|0x409B0E11
comma
l_string|&quot;Smart Array 642&quot;
comma
op_amp
id|SA5_access
)brace
comma
(brace
l_int|0x409C0E11
comma
l_string|&quot;Smart Array 6400&quot;
comma
op_amp
id|SA5_access
)brace
comma
(brace
l_int|0x409D0E11
comma
l_string|&quot;Smart Array 6400 EM&quot;
comma
op_amp
id|SA5_access
)brace
comma
(brace
l_int|0x40910E11
comma
l_string|&quot;Smart Array 6i&quot;
comma
op_amp
id|SA5_access
)brace
comma
(brace
l_int|0x409E0E11
comma
l_string|&quot;Smart Array 6422&quot;
comma
op_amp
id|SA5_access
)brace
comma
(brace
l_int|0x3211103C
comma
l_string|&quot;Smart Array V100&quot;
comma
op_amp
id|SA5_access
)brace
comma
)brace
suffix:semicolon
multiline_comment|/* How long to wait (in millesconds) for board to go into simple mode */
DECL|macro|MAX_CONFIG_WAIT
mdefine_line|#define MAX_CONFIG_WAIT 30000 
DECL|macro|MAX_IOCTL_CONFIG_WAIT
mdefine_line|#define MAX_IOCTL_CONFIG_WAIT 1000
multiline_comment|/*define how many times we will try a command because of bus resets */
DECL|macro|MAX_CMD_RETRIES
mdefine_line|#define MAX_CMD_RETRIES 3
DECL|macro|READ_AHEAD
mdefine_line|#define READ_AHEAD &t; 1024
DECL|macro|NR_CMDS
mdefine_line|#define NR_CMDS&t;&t; 384 /* #commands that can be outstanding */
DECL|macro|MAX_CTLR
mdefine_line|#define MAX_CTLR 8
DECL|macro|CCISS_DMA_MASK
mdefine_line|#define CCISS_DMA_MASK&t;0xFFFFFFFF&t;/* 32 bit DMA */
DECL|variable|hba
r_static
id|ctlr_info_t
op_star
id|hba
(braket
id|MAX_CTLR
)braket
suffix:semicolon
r_static
r_void
id|do_cciss_request
c_func
(paren
id|request_queue_t
op_star
id|q
)paren
suffix:semicolon
r_static
r_int
id|cciss_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filep
)paren
suffix:semicolon
r_static
r_int
id|cciss_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filep
)paren
suffix:semicolon
r_static
r_int
id|cciss_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filep
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
suffix:semicolon
r_static
r_int
id|revalidate_allvol
c_func
(paren
id|ctlr_info_t
op_star
id|host
)paren
suffix:semicolon
r_static
r_int
id|cciss_revalidate
c_func
(paren
r_struct
id|gendisk
op_star
id|disk
)paren
suffix:semicolon
r_static
r_int
id|deregister_disk
c_func
(paren
r_struct
id|gendisk
op_star
id|disk
)paren
suffix:semicolon
r_static
r_int
id|register_new_disk
c_func
(paren
id|ctlr_info_t
op_star
id|h
)paren
suffix:semicolon
r_static
r_void
id|cciss_getgeometry
c_func
(paren
r_int
id|cntl_num
)paren
suffix:semicolon
r_static
r_void
id|start_io
c_func
(paren
id|ctlr_info_t
op_star
id|h
)paren
suffix:semicolon
r_static
r_int
id|sendcmd
c_func
(paren
id|__u8
id|cmd
comma
r_int
id|ctlr
comma
r_void
op_star
id|buff
comma
r_int
id|size
comma
r_int
r_int
id|use_unit_num
comma
r_int
r_int
id|log_unit
comma
id|__u8
id|page_code
comma
r_int
r_char
op_star
id|scsi3addr
comma
r_int
id|cmd_type
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_PROC_FS
r_static
r_int
id|cciss_proc_get_info
c_func
(paren
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|length
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
suffix:semicolon
r_static
r_void
id|cciss_procinit
c_func
(paren
r_int
id|i
)paren
suffix:semicolon
macro_line|#else
DECL|function|cciss_procinit
r_static
r_void
id|cciss_procinit
c_func
(paren
r_int
id|i
)paren
(brace
)brace
macro_line|#endif /* CONFIG_PROC_FS */
DECL|variable|cciss_fops
r_static
r_struct
id|block_device_operations
id|cciss_fops
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|open
op_assign
id|cciss_open
comma
dot
id|release
op_assign
id|cciss_release
comma
dot
id|ioctl
op_assign
id|cciss_ioctl
comma
dot
id|revalidate_disk
op_assign
id|cciss_revalidate
comma
)brace
suffix:semicolon
multiline_comment|/*&n; * Enqueuing and dequeuing functions for cmdlists.&n; */
DECL|function|addQ
r_static
r_inline
r_void
id|addQ
c_func
(paren
id|CommandList_struct
op_star
op_star
id|Qptr
comma
id|CommandList_struct
op_star
id|c
)paren
(brace
r_if
c_cond
(paren
op_star
id|Qptr
op_eq
l_int|NULL
)paren
(brace
op_star
id|Qptr
op_assign
id|c
suffix:semicolon
id|c-&gt;next
op_assign
id|c-&gt;prev
op_assign
id|c
suffix:semicolon
)brace
r_else
(brace
id|c-&gt;prev
op_assign
(paren
op_star
id|Qptr
)paren
op_member_access_from_pointer
id|prev
suffix:semicolon
id|c-&gt;next
op_assign
(paren
op_star
id|Qptr
)paren
suffix:semicolon
(paren
op_star
id|Qptr
)paren
op_member_access_from_pointer
id|prev-&gt;next
op_assign
id|c
suffix:semicolon
(paren
op_star
id|Qptr
)paren
op_member_access_from_pointer
id|prev
op_assign
id|c
suffix:semicolon
)brace
)brace
DECL|function|removeQ
r_static
r_inline
id|CommandList_struct
op_star
id|removeQ
c_func
(paren
id|CommandList_struct
op_star
op_star
id|Qptr
comma
id|CommandList_struct
op_star
id|c
)paren
(brace
r_if
c_cond
(paren
id|c
op_logical_and
id|c-&gt;next
op_ne
id|c
)paren
(brace
r_if
c_cond
(paren
op_star
id|Qptr
op_eq
id|c
)paren
op_star
id|Qptr
op_assign
id|c-&gt;next
suffix:semicolon
id|c-&gt;prev-&gt;next
op_assign
id|c-&gt;next
suffix:semicolon
id|c-&gt;next-&gt;prev
op_assign
id|c-&gt;prev
suffix:semicolon
)brace
r_else
(brace
op_star
id|Qptr
op_assign
l_int|NULL
suffix:semicolon
)brace
r_return
id|c
suffix:semicolon
)brace
macro_line|#include &quot;cciss_scsi.c&quot;&t;&t;/* For SCSI tape support */
macro_line|#ifdef CONFIG_PROC_FS
multiline_comment|/*&n; * Report information about this controller.&n; */
DECL|macro|ENG_GIG
mdefine_line|#define ENG_GIG 1000000000
DECL|macro|ENG_GIG_FACTOR
mdefine_line|#define ENG_GIG_FACTOR (ENG_GIG/512)
DECL|macro|RAID_UNKNOWN
mdefine_line|#define RAID_UNKNOWN 6
DECL|variable|raid_label
r_static
r_const
r_char
op_star
id|raid_label
(braket
)braket
op_assign
(brace
l_string|&quot;0&quot;
comma
l_string|&quot;4&quot;
comma
l_string|&quot;1(1+0)&quot;
comma
l_string|&quot;5&quot;
comma
l_string|&quot;5+1&quot;
comma
l_string|&quot;ADG&quot;
comma
l_string|&quot;UNKNOWN&quot;
)brace
suffix:semicolon
DECL|variable|proc_cciss
r_static
r_struct
id|proc_dir_entry
op_star
id|proc_cciss
suffix:semicolon
DECL|function|cciss_proc_get_info
r_static
r_int
id|cciss_proc_get_info
c_func
(paren
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|length
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
id|off_t
id|pos
op_assign
l_int|0
suffix:semicolon
id|off_t
id|len
op_assign
l_int|0
suffix:semicolon
r_int
id|size
comma
id|i
comma
id|ctlr
suffix:semicolon
id|ctlr_info_t
op_star
id|h
op_assign
(paren
id|ctlr_info_t
op_star
)paren
id|data
suffix:semicolon
id|drive_info_struct
op_star
id|drv
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|sector_t
id|vol_sz
comma
id|vol_sz_frac
suffix:semicolon
id|ctlr
op_assign
id|h-&gt;ctlr
suffix:semicolon
multiline_comment|/* prevent displaying bogus info during configuration&n;&t; * or deconfiguration of a logical volume&n;&t; */
id|spin_lock_irqsave
c_func
(paren
id|CCISS_LOCK
c_func
(paren
id|ctlr
)paren
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|h-&gt;busy_configuring
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
id|CCISS_LOCK
c_func
(paren
id|ctlr
)paren
comma
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|h-&gt;busy_configuring
op_assign
l_int|1
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
id|CCISS_LOCK
c_func
(paren
id|ctlr
)paren
comma
id|flags
)paren
suffix:semicolon
id|size
op_assign
id|sprintf
c_func
(paren
id|buffer
comma
l_string|&quot;%s: HP %s Controller&bslash;n&quot;
l_string|&quot;Board ID: 0x%08lx&bslash;n&quot;
l_string|&quot;Firmware Version: %c%c%c%c&bslash;n&quot;
l_string|&quot;IRQ: %d&bslash;n&quot;
l_string|&quot;Logical drives: %d&bslash;n&quot;
l_string|&quot;Current Q depth: %d&bslash;n&quot;
l_string|&quot;Current # commands on controller: %d&bslash;n&quot;
l_string|&quot;Max Q depth since init: %d&bslash;n&quot;
l_string|&quot;Max # commands on controller since init: %d&bslash;n&quot;
l_string|&quot;Max SG entries since init: %d&bslash;n&bslash;n&quot;
comma
id|h-&gt;devname
comma
id|h-&gt;product_name
comma
(paren
r_int
r_int
)paren
id|h-&gt;board_id
comma
id|h-&gt;firm_ver
(braket
l_int|0
)braket
comma
id|h-&gt;firm_ver
(braket
l_int|1
)braket
comma
id|h-&gt;firm_ver
(braket
l_int|2
)braket
comma
id|h-&gt;firm_ver
(braket
l_int|3
)braket
comma
(paren
r_int
r_int
)paren
id|h-&gt;intr
comma
id|h-&gt;num_luns
comma
id|h-&gt;Qdepth
comma
id|h-&gt;commands_outstanding
comma
id|h-&gt;maxQsinceinit
comma
id|h-&gt;max_outstanding
comma
id|h-&gt;maxSG
)paren
suffix:semicolon
id|pos
op_add_assign
id|size
suffix:semicolon
id|len
op_add_assign
id|size
suffix:semicolon
id|cciss_proc_tape_report
c_func
(paren
id|ctlr
comma
id|buffer
comma
op_amp
id|pos
comma
op_amp
id|len
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_le
id|h-&gt;highest_lun
suffix:semicolon
id|i
op_increment
)paren
(brace
id|drv
op_assign
op_amp
id|h-&gt;drv
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|drv-&gt;block_size
op_eq
l_int|0
)paren
r_continue
suffix:semicolon
id|vol_sz
op_assign
id|drv-&gt;nr_blocks
suffix:semicolon
id|vol_sz_frac
op_assign
id|sector_div
c_func
(paren
id|vol_sz
comma
id|ENG_GIG_FACTOR
)paren
suffix:semicolon
id|vol_sz_frac
op_mul_assign
l_int|100
suffix:semicolon
id|sector_div
c_func
(paren
id|vol_sz_frac
comma
id|ENG_GIG_FACTOR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|drv-&gt;raid_level
OG
l_int|5
)paren
id|drv-&gt;raid_level
op_assign
id|RAID_UNKNOWN
suffix:semicolon
id|size
op_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;cciss/c%dd%d:&quot;
l_string|&quot;&bslash;t%4u.%02uGB&bslash;tRAID %s&bslash;n&quot;
comma
id|ctlr
comma
id|i
comma
(paren
r_int
)paren
id|vol_sz
comma
(paren
r_int
)paren
id|vol_sz_frac
comma
id|raid_label
(braket
id|drv-&gt;raid_level
)braket
)paren
suffix:semicolon
id|pos
op_add_assign
id|size
suffix:semicolon
id|len
op_add_assign
id|size
suffix:semicolon
)brace
op_star
id|eof
op_assign
l_int|1
suffix:semicolon
op_star
id|start
op_assign
id|buffer
op_plus
id|offset
suffix:semicolon
id|len
op_sub_assign
id|offset
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|length
)paren
id|len
op_assign
id|length
suffix:semicolon
id|h-&gt;busy_configuring
op_assign
l_int|0
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
r_static
r_int
DECL|function|cciss_proc_write
id|cciss_proc_write
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
id|__user
op_star
id|buffer
comma
r_int
r_int
id|count
comma
r_void
op_star
id|data
)paren
(brace
r_int
r_char
id|cmd
(braket
l_int|80
)braket
suffix:semicolon
r_int
id|len
suffix:semicolon
macro_line|#ifdef CONFIG_CISS_SCSI_TAPE
id|ctlr_info_t
op_star
id|h
op_assign
(paren
id|ctlr_info_t
op_star
)paren
id|data
suffix:semicolon
r_int
id|rc
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|count
OG
r_sizeof
(paren
id|cmd
)paren
op_minus
l_int|1
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|cmd
comma
id|buffer
comma
id|count
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|cmd
(braket
id|count
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|len
op_assign
id|strlen
c_func
(paren
id|cmd
)paren
suffix:semicolon
singleline_comment|// above 3 lines ensure safety
r_if
c_cond
(paren
id|cmd
(braket
id|len
op_minus
l_int|1
)braket
op_eq
l_char|&squot;&bslash;n&squot;
)paren
id|cmd
(braket
op_decrement
id|len
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
macro_line|#&t;ifdef CONFIG_CISS_SCSI_TAPE
r_if
c_cond
(paren
id|strcmp
c_func
(paren
l_string|&quot;engage scsi&quot;
comma
id|cmd
)paren
op_eq
l_int|0
)paren
(brace
id|rc
op_assign
id|cciss_engage_scsi
c_func
(paren
id|h-&gt;ctlr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ne
l_int|0
)paren
r_return
op_minus
id|rc
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
multiline_comment|/* might be nice to have &quot;disengage&quot; too, but it&squot;s not &n;&t;&t;   safely possible. (only 1 module use count, lock issues.) */
macro_line|#&t;endif
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/*&n; * Get us a file in /proc/cciss that says something about each controller.&n; * Create /proc/cciss if it doesn&squot;t exist yet.&n; */
DECL|function|cciss_procinit
r_static
r_void
id|__devinit
id|cciss_procinit
c_func
(paren
r_int
id|i
)paren
(brace
r_struct
id|proc_dir_entry
op_star
id|pde
suffix:semicolon
r_if
c_cond
(paren
id|proc_cciss
op_eq
l_int|NULL
)paren
(brace
id|proc_cciss
op_assign
id|proc_mkdir
c_func
(paren
l_string|&quot;cciss&quot;
comma
id|proc_root_driver
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|proc_cciss
)paren
r_return
suffix:semicolon
)brace
id|pde
op_assign
id|create_proc_read_entry
c_func
(paren
id|hba
(braket
id|i
)braket
op_member_access_from_pointer
id|devname
comma
id|S_IWUSR
op_or
id|S_IRUSR
op_or
id|S_IRGRP
op_or
id|S_IROTH
comma
id|proc_cciss
comma
id|cciss_proc_get_info
comma
id|hba
(braket
id|i
)braket
)paren
suffix:semicolon
id|pde-&gt;write_proc
op_assign
id|cciss_proc_write
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_PROC_FS */
multiline_comment|/* &n; * For operations that cannot sleep, a command block is allocated at init, &n; * and managed by cmd_alloc() and cmd_free() using a simple bitmap to track&n; * which ones are free or in use.  For operations that can wait for kmalloc &n; * to possible sleep, this routine can be called with get_from_pool set to 0. &n; * cmd_free() MUST be called with a got_from_pool set to 0 if cmd_alloc was. &n; */
DECL|function|cmd_alloc
r_static
id|CommandList_struct
op_star
id|cmd_alloc
c_func
(paren
id|ctlr_info_t
op_star
id|h
comma
r_int
id|get_from_pool
)paren
(brace
id|CommandList_struct
op_star
id|c
suffix:semicolon
r_int
id|i
suffix:semicolon
id|u64bit
id|temp64
suffix:semicolon
id|dma_addr_t
id|cmd_dma_handle
comma
id|err_dma_handle
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|get_from_pool
)paren
(brace
id|c
op_assign
(paren
id|CommandList_struct
op_star
)paren
id|pci_alloc_consistent
c_func
(paren
id|h-&gt;pdev
comma
r_sizeof
(paren
id|CommandList_struct
)paren
comma
op_amp
id|cmd_dma_handle
)paren
suffix:semicolon
r_if
c_cond
(paren
id|c
op_eq
l_int|NULL
)paren
(brace
r_return
l_int|NULL
suffix:semicolon
)brace
id|memset
c_func
(paren
id|c
comma
l_int|0
comma
r_sizeof
(paren
id|CommandList_struct
)paren
)paren
suffix:semicolon
id|c-&gt;err_info
op_assign
(paren
id|ErrorInfo_struct
op_star
)paren
id|pci_alloc_consistent
c_func
(paren
id|h-&gt;pdev
comma
r_sizeof
(paren
id|ErrorInfo_struct
)paren
comma
op_amp
id|err_dma_handle
)paren
suffix:semicolon
r_if
c_cond
(paren
id|c-&gt;err_info
op_eq
l_int|NULL
)paren
(brace
id|pci_free_consistent
c_func
(paren
id|h-&gt;pdev
comma
r_sizeof
(paren
id|CommandList_struct
)paren
comma
id|c
comma
id|cmd_dma_handle
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|memset
c_func
(paren
id|c-&gt;err_info
comma
l_int|0
comma
r_sizeof
(paren
id|ErrorInfo_struct
)paren
)paren
suffix:semicolon
)brace
r_else
multiline_comment|/* get it out of the controllers pool */
(brace
r_do
(brace
id|i
op_assign
id|find_first_zero_bit
c_func
(paren
id|h-&gt;cmd_pool_bits
comma
id|NR_CMDS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
id|NR_CMDS
)paren
r_return
l_int|NULL
suffix:semicolon
)brace
r_while
c_loop
(paren
id|test_and_set_bit
c_func
(paren
id|i
op_amp
(paren
id|BITS_PER_LONG
op_minus
l_int|1
)paren
comma
id|h-&gt;cmd_pool_bits
op_plus
(paren
id|i
op_div
id|BITS_PER_LONG
)paren
)paren
op_ne
l_int|0
)paren
(brace
suffix:semicolon
)brace
macro_line|#ifdef CCISS_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;cciss: using command buffer %d&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
macro_line|#endif
id|c
op_assign
id|h-&gt;cmd_pool
op_plus
id|i
suffix:semicolon
id|memset
c_func
(paren
id|c
comma
l_int|0
comma
r_sizeof
(paren
id|CommandList_struct
)paren
)paren
suffix:semicolon
id|cmd_dma_handle
op_assign
id|h-&gt;cmd_pool_dhandle
op_plus
id|i
op_star
r_sizeof
(paren
id|CommandList_struct
)paren
suffix:semicolon
id|c-&gt;err_info
op_assign
id|h-&gt;errinfo_pool
op_plus
id|i
suffix:semicolon
id|memset
c_func
(paren
id|c-&gt;err_info
comma
l_int|0
comma
r_sizeof
(paren
id|ErrorInfo_struct
)paren
)paren
suffix:semicolon
id|err_dma_handle
op_assign
id|h-&gt;errinfo_pool_dhandle
op_plus
id|i
op_star
r_sizeof
(paren
id|ErrorInfo_struct
)paren
suffix:semicolon
id|h-&gt;nr_allocs
op_increment
suffix:semicolon
)brace
id|c-&gt;busaddr
op_assign
(paren
id|__u32
)paren
id|cmd_dma_handle
suffix:semicolon
id|temp64.val
op_assign
(paren
id|__u64
)paren
id|err_dma_handle
suffix:semicolon
id|c-&gt;ErrDesc.Addr.lower
op_assign
id|temp64.val32.lower
suffix:semicolon
id|c-&gt;ErrDesc.Addr.upper
op_assign
id|temp64.val32.upper
suffix:semicolon
id|c-&gt;ErrDesc.Len
op_assign
r_sizeof
(paren
id|ErrorInfo_struct
)paren
suffix:semicolon
id|c-&gt;ctlr
op_assign
id|h-&gt;ctlr
suffix:semicolon
r_return
id|c
suffix:semicolon
)brace
multiline_comment|/* &n; * Frees a command block that was previously allocated with cmd_alloc(). &n; */
DECL|function|cmd_free
r_static
r_void
id|cmd_free
c_func
(paren
id|ctlr_info_t
op_star
id|h
comma
id|CommandList_struct
op_star
id|c
comma
r_int
id|got_from_pool
)paren
(brace
r_int
id|i
suffix:semicolon
id|u64bit
id|temp64
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|got_from_pool
)paren
(brace
id|temp64.val32.lower
op_assign
id|c-&gt;ErrDesc.Addr.lower
suffix:semicolon
id|temp64.val32.upper
op_assign
id|c-&gt;ErrDesc.Addr.upper
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|h-&gt;pdev
comma
r_sizeof
(paren
id|ErrorInfo_struct
)paren
comma
id|c-&gt;err_info
comma
(paren
id|dma_addr_t
)paren
id|temp64.val
)paren
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|h-&gt;pdev
comma
r_sizeof
(paren
id|CommandList_struct
)paren
comma
id|c
comma
(paren
id|dma_addr_t
)paren
id|c-&gt;busaddr
)paren
suffix:semicolon
)brace
r_else
(brace
id|i
op_assign
id|c
op_minus
id|h-&gt;cmd_pool
suffix:semicolon
id|clear_bit
c_func
(paren
id|i
op_amp
(paren
id|BITS_PER_LONG
op_minus
l_int|1
)paren
comma
id|h-&gt;cmd_pool_bits
op_plus
(paren
id|i
op_div
id|BITS_PER_LONG
)paren
)paren
suffix:semicolon
id|h-&gt;nr_frees
op_increment
suffix:semicolon
)brace
)brace
DECL|function|get_host
r_static
r_inline
id|ctlr_info_t
op_star
id|get_host
c_func
(paren
r_struct
id|gendisk
op_star
id|disk
)paren
(brace
r_return
id|disk-&gt;queue-&gt;queuedata
suffix:semicolon
)brace
DECL|function|get_drv
r_static
r_inline
id|drive_info_struct
op_star
id|get_drv
c_func
(paren
r_struct
id|gendisk
op_star
id|disk
)paren
(brace
r_return
id|disk-&gt;private_data
suffix:semicolon
)brace
multiline_comment|/*&n; * Open.  Make sure the device is really there.&n; */
DECL|function|cciss_open
r_static
r_int
id|cciss_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filep
)paren
(brace
id|ctlr_info_t
op_star
id|host
op_assign
id|get_host
c_func
(paren
id|inode-&gt;i_bdev-&gt;bd_disk
)paren
suffix:semicolon
id|drive_info_struct
op_star
id|drv
op_assign
id|get_drv
c_func
(paren
id|inode-&gt;i_bdev-&gt;bd_disk
)paren
suffix:semicolon
macro_line|#ifdef CCISS_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;cciss_open %s&bslash;n&quot;
comma
id|inode-&gt;i_bdev-&gt;bd_disk-&gt;disk_name
)paren
suffix:semicolon
macro_line|#endif /* CCISS_DEBUG */ 
multiline_comment|/*&n;&t; * Root is allowed to open raw volume zero even if it&squot;s not configured&n;&t; * so array config can still work. Root is also allowed to open any&n;&t; * volume that has a LUN ID, so it can issue IOCTL to reread the&n;&t; * disk information.  I don&squot;t think I really like this&n;&t; * but I&squot;m already using way to many device nodes to claim another one&n;&t; * for &quot;raw controller&quot;.&n;&t; */
r_if
c_cond
(paren
id|drv-&gt;nr_blocks
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|iminor
c_func
(paren
id|inode
)paren
op_ne
l_int|0
)paren
(brace
multiline_comment|/* not node 0? */
multiline_comment|/* if not node 0 make sure it is a partition = 0 */
r_if
c_cond
(paren
id|iminor
c_func
(paren
id|inode
)paren
op_amp
l_int|0x0f
)paren
(brace
r_return
op_minus
id|ENXIO
suffix:semicolon
multiline_comment|/* if it is, make sure we have a LUN ID */
)brace
r_else
r_if
c_cond
(paren
id|drv-&gt;LunID
op_eq
l_int|0
)paren
(brace
r_return
op_minus
id|ENXIO
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_ADMIN
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
)brace
id|drv-&gt;usage_count
op_increment
suffix:semicolon
id|host-&gt;usage_count
op_increment
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Close.  Sync first.&n; */
DECL|function|cciss_release
r_static
r_int
id|cciss_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filep
)paren
(brace
id|ctlr_info_t
op_star
id|host
op_assign
id|get_host
c_func
(paren
id|inode-&gt;i_bdev-&gt;bd_disk
)paren
suffix:semicolon
id|drive_info_struct
op_star
id|drv
op_assign
id|get_drv
c_func
(paren
id|inode-&gt;i_bdev-&gt;bd_disk
)paren
suffix:semicolon
macro_line|#ifdef CCISS_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;cciss_release %s&bslash;n&quot;
comma
id|inode-&gt;i_bdev-&gt;bd_disk-&gt;disk_name
)paren
suffix:semicolon
macro_line|#endif /* CCISS_DEBUG */
id|drv-&gt;usage_count
op_decrement
suffix:semicolon
id|host-&gt;usage_count
op_decrement
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_COMPAT
multiline_comment|/* for AMD 64 bit kernel compatibility with 32-bit userland ioctls */
r_extern
r_int
id|sys_ioctl
c_func
(paren
r_int
r_int
id|fd
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
suffix:semicolon
r_extern
r_int
id|register_ioctl32_conversion
c_func
(paren
r_int
r_int
id|cmd
comma
r_int
(paren
op_star
id|handler
)paren
(paren
r_int
r_int
comma
r_int
r_int
comma
r_int
r_int
comma
r_struct
id|file
op_star
)paren
)paren
suffix:semicolon
r_extern
r_int
id|unregister_ioctl32_conversion
c_func
(paren
r_int
r_int
id|cmd
)paren
suffix:semicolon
r_static
r_int
id|cciss_ioctl32_passthru
c_func
(paren
r_int
r_int
id|fd
comma
r_int
id|cmd
comma
r_int
r_int
id|arg
comma
r_struct
id|file
op_star
id|file
)paren
suffix:semicolon
r_static
r_int
id|cciss_ioctl32_big_passthru
c_func
(paren
r_int
r_int
id|fd
comma
r_int
id|cmd
comma
r_int
r_int
id|arg
comma
r_struct
id|file
op_star
id|file
)paren
suffix:semicolon
DECL|typedef|handler_type
r_typedef
r_int
(paren
op_star
id|handler_type
)paren
(paren
r_int
r_int
comma
r_int
r_int
comma
r_int
r_int
comma
r_struct
id|file
op_star
)paren
suffix:semicolon
DECL|struct|ioctl32_map
r_static
r_struct
id|ioctl32_map
(brace
DECL|member|cmd
r_int
r_int
id|cmd
suffix:semicolon
DECL|member|handler
id|handler_type
id|handler
suffix:semicolon
DECL|member|registered
r_int
id|registered
suffix:semicolon
DECL|variable|cciss_ioctl32_map
)brace
id|cciss_ioctl32_map
(braket
)braket
op_assign
(brace
(brace
id|CCISS_GETPCIINFO
comma
(paren
id|handler_type
)paren
id|sys_ioctl
comma
l_int|0
)brace
comma
(brace
id|CCISS_GETINTINFO
comma
(paren
id|handler_type
)paren
id|sys_ioctl
comma
l_int|0
)brace
comma
(brace
id|CCISS_SETINTINFO
comma
(paren
id|handler_type
)paren
id|sys_ioctl
comma
l_int|0
)brace
comma
(brace
id|CCISS_GETNODENAME
comma
(paren
id|handler_type
)paren
id|sys_ioctl
comma
l_int|0
)brace
comma
(brace
id|CCISS_SETNODENAME
comma
(paren
id|handler_type
)paren
id|sys_ioctl
comma
l_int|0
)brace
comma
(brace
id|CCISS_GETHEARTBEAT
comma
(paren
id|handler_type
)paren
id|sys_ioctl
comma
l_int|0
)brace
comma
(brace
id|CCISS_GETBUSTYPES
comma
(paren
id|handler_type
)paren
id|sys_ioctl
comma
l_int|0
)brace
comma
(brace
id|CCISS_GETFIRMVER
comma
(paren
id|handler_type
)paren
id|sys_ioctl
comma
l_int|0
)brace
comma
(brace
id|CCISS_GETDRIVVER
comma
(paren
id|handler_type
)paren
id|sys_ioctl
comma
l_int|0
)brace
comma
(brace
id|CCISS_REVALIDVOLS
comma
(paren
id|handler_type
)paren
id|sys_ioctl
comma
l_int|0
)brace
comma
(brace
id|CCISS_PASSTHRU32
comma
id|cciss_ioctl32_passthru
comma
l_int|0
)brace
comma
(brace
id|CCISS_DEREGDISK
comma
(paren
id|handler_type
)paren
id|sys_ioctl
comma
l_int|0
)brace
comma
(brace
id|CCISS_REGNEWDISK
comma
(paren
id|handler_type
)paren
id|sys_ioctl
comma
l_int|0
)brace
comma
(brace
id|CCISS_REGNEWD
comma
(paren
id|handler_type
)paren
id|sys_ioctl
comma
l_int|0
)brace
comma
(brace
id|CCISS_RESCANDISK
comma
(paren
id|handler_type
)paren
id|sys_ioctl
comma
l_int|0
)brace
comma
(brace
id|CCISS_GETLUNINFO
comma
(paren
id|handler_type
)paren
id|sys_ioctl
comma
l_int|0
)brace
comma
(brace
id|CCISS_BIG_PASSTHRU32
comma
id|cciss_ioctl32_big_passthru
comma
l_int|0
)brace
comma
)brace
suffix:semicolon
DECL|macro|NCCISS_IOCTL32_ENTRIES
mdefine_line|#define NCCISS_IOCTL32_ENTRIES (sizeof(cciss_ioctl32_map) / sizeof(cciss_ioctl32_map[0]))
DECL|function|register_cciss_ioctl32
r_static
r_void
id|register_cciss_ioctl32
c_func
(paren
r_void
)paren
(brace
r_int
id|i
comma
id|rc
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NCCISS_IOCTL32_ENTRIES
suffix:semicolon
id|i
op_increment
)paren
(brace
id|rc
op_assign
id|register_ioctl32_conversion
c_func
(paren
id|cciss_ioctl32_map
(braket
id|i
)braket
dot
id|cmd
comma
id|cciss_ioctl32_map
(braket
id|i
)braket
dot
id|handler
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;cciss: failed to register &quot;
l_string|&quot;32 bit compatible ioctl 0x%08x&bslash;n&quot;
comma
id|cciss_ioctl32_map
(braket
id|i
)braket
dot
id|cmd
)paren
suffix:semicolon
id|cciss_ioctl32_map
(braket
id|i
)braket
dot
id|registered
op_assign
l_int|0
suffix:semicolon
)brace
r_else
id|cciss_ioctl32_map
(braket
id|i
)braket
dot
id|registered
op_assign
l_int|1
suffix:semicolon
)brace
)brace
DECL|function|unregister_cciss_ioctl32
r_static
r_void
id|unregister_cciss_ioctl32
c_func
(paren
r_void
)paren
(brace
r_int
id|i
comma
id|rc
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NCCISS_IOCTL32_ENTRIES
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|cciss_ioctl32_map
(braket
id|i
)braket
dot
id|registered
)paren
r_continue
suffix:semicolon
id|rc
op_assign
id|unregister_ioctl32_conversion
c_func
(paren
id|cciss_ioctl32_map
(braket
id|i
)braket
dot
id|cmd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
)paren
(brace
id|cciss_ioctl32_map
(braket
id|i
)braket
dot
id|registered
op_assign
l_int|0
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;cciss: failed to unregister &quot;
l_string|&quot;32 bit compatible ioctl 0x%08x&bslash;n&quot;
comma
id|cciss_ioctl32_map
(braket
id|i
)braket
dot
id|cmd
)paren
suffix:semicolon
)brace
)brace
DECL|function|cciss_ioctl32_passthru
r_int
id|cciss_ioctl32_passthru
c_func
(paren
r_int
r_int
id|fd
comma
r_int
id|cmd
comma
r_int
r_int
id|arg
comma
r_struct
id|file
op_star
id|file
)paren
(brace
id|IOCTL32_Command_struct
id|__user
op_star
id|arg32
op_assign
(paren
id|IOCTL32_Command_struct
id|__user
op_star
)paren
id|arg
suffix:semicolon
id|IOCTL_Command_struct
id|arg64
suffix:semicolon
id|IOCTL_Command_struct
id|__user
op_star
id|p
op_assign
id|compat_alloc_user_space
c_func
(paren
r_sizeof
(paren
id|arg64
)paren
)paren
suffix:semicolon
r_int
id|err
suffix:semicolon
id|u32
id|cp
suffix:semicolon
id|err
op_assign
l_int|0
suffix:semicolon
id|err
op_or_assign
id|copy_from_user
c_func
(paren
op_amp
id|arg64.LUN_info
comma
op_amp
id|arg32-&gt;LUN_info
comma
r_sizeof
(paren
id|arg64.LUN_info
)paren
)paren
suffix:semicolon
id|err
op_or_assign
id|copy_from_user
c_func
(paren
op_amp
id|arg64.Request
comma
op_amp
id|arg32-&gt;Request
comma
r_sizeof
(paren
id|arg64.Request
)paren
)paren
suffix:semicolon
id|err
op_or_assign
id|copy_from_user
c_func
(paren
op_amp
id|arg64.error_info
comma
op_amp
id|arg32-&gt;error_info
comma
r_sizeof
(paren
id|arg64.error_info
)paren
)paren
suffix:semicolon
id|err
op_or_assign
id|get_user
c_func
(paren
id|arg64.buf_size
comma
op_amp
id|arg32-&gt;buf_size
)paren
suffix:semicolon
id|err
op_or_assign
id|get_user
c_func
(paren
id|cp
comma
op_amp
id|arg32-&gt;buf
)paren
suffix:semicolon
id|arg64.buf
op_assign
id|compat_ptr
c_func
(paren
id|cp
)paren
suffix:semicolon
id|err
op_or_assign
id|copy_to_user
c_func
(paren
id|p
comma
op_amp
id|arg64
comma
r_sizeof
(paren
id|arg64
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|err
op_assign
id|sys_ioctl
c_func
(paren
id|fd
comma
id|CCISS_PASSTHRU
comma
(paren
r_int
r_int
)paren
id|p
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_return
id|err
suffix:semicolon
id|err
op_or_assign
id|copy_in_user
c_func
(paren
op_amp
id|arg32-&gt;error_info
comma
op_amp
id|p-&gt;error_info
comma
r_sizeof
(paren
id|arg32-&gt;error_info
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|cciss_ioctl32_big_passthru
r_int
id|cciss_ioctl32_big_passthru
c_func
(paren
r_int
r_int
id|fd
comma
r_int
id|cmd
comma
r_int
r_int
id|arg
comma
r_struct
id|file
op_star
id|file
)paren
(brace
id|BIG_IOCTL32_Command_struct
id|__user
op_star
id|arg32
op_assign
(paren
id|BIG_IOCTL32_Command_struct
id|__user
op_star
)paren
id|arg
suffix:semicolon
id|BIG_IOCTL_Command_struct
id|arg64
suffix:semicolon
id|BIG_IOCTL_Command_struct
id|__user
op_star
id|p
op_assign
id|compat_alloc_user_space
c_func
(paren
r_sizeof
(paren
id|arg64
)paren
)paren
suffix:semicolon
r_int
id|err
suffix:semicolon
id|u32
id|cp
suffix:semicolon
id|err
op_assign
l_int|0
suffix:semicolon
id|err
op_or_assign
id|copy_from_user
c_func
(paren
op_amp
id|arg64.LUN_info
comma
op_amp
id|arg32-&gt;LUN_info
comma
r_sizeof
(paren
id|arg64.LUN_info
)paren
)paren
suffix:semicolon
id|err
op_or_assign
id|copy_from_user
c_func
(paren
op_amp
id|arg64.Request
comma
op_amp
id|arg32-&gt;Request
comma
r_sizeof
(paren
id|arg64.Request
)paren
)paren
suffix:semicolon
id|err
op_or_assign
id|copy_from_user
c_func
(paren
op_amp
id|arg64.error_info
comma
op_amp
id|arg32-&gt;error_info
comma
r_sizeof
(paren
id|arg64.error_info
)paren
)paren
suffix:semicolon
id|err
op_or_assign
id|get_user
c_func
(paren
id|arg64.buf_size
comma
op_amp
id|arg32-&gt;buf_size
)paren
suffix:semicolon
id|err
op_or_assign
id|get_user
c_func
(paren
id|arg64.malloc_size
comma
op_amp
id|arg32-&gt;malloc_size
)paren
suffix:semicolon
id|err
op_or_assign
id|get_user
c_func
(paren
id|cp
comma
op_amp
id|arg32-&gt;buf
)paren
suffix:semicolon
id|arg64.buf
op_assign
id|compat_ptr
c_func
(paren
id|cp
)paren
suffix:semicolon
id|err
op_or_assign
id|copy_to_user
c_func
(paren
id|p
comma
op_amp
id|arg64
comma
r_sizeof
(paren
id|arg64
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|err
op_assign
id|sys_ioctl
c_func
(paren
id|fd
comma
id|CCISS_BIG_PASSTHRU
comma
(paren
r_int
r_int
)paren
id|p
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_return
id|err
suffix:semicolon
id|err
op_or_assign
id|copy_in_user
c_func
(paren
op_amp
id|arg32-&gt;error_info
comma
op_amp
id|p-&gt;error_info
comma
r_sizeof
(paren
id|arg32-&gt;error_info
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
macro_line|#else
DECL|function|register_cciss_ioctl32
r_static
r_inline
r_void
id|register_cciss_ioctl32
c_func
(paren
r_void
)paren
(brace
)brace
DECL|function|unregister_cciss_ioctl32
r_static
r_inline
r_void
id|unregister_cciss_ioctl32
c_func
(paren
r_void
)paren
(brace
)brace
macro_line|#endif
multiline_comment|/*&n; * ioctl &n; */
DECL|function|cciss_ioctl
r_static
r_int
id|cciss_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filep
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_struct
id|block_device
op_star
id|bdev
op_assign
id|inode-&gt;i_bdev
suffix:semicolon
r_struct
id|gendisk
op_star
id|disk
op_assign
id|bdev-&gt;bd_disk
suffix:semicolon
id|ctlr_info_t
op_star
id|host
op_assign
id|get_host
c_func
(paren
id|disk
)paren
suffix:semicolon
id|drive_info_struct
op_star
id|drv
op_assign
id|get_drv
c_func
(paren
id|disk
)paren
suffix:semicolon
r_int
id|ctlr
op_assign
id|host-&gt;ctlr
suffix:semicolon
r_void
id|__user
op_star
id|argp
op_assign
(paren
r_void
id|__user
op_star
)paren
id|arg
suffix:semicolon
macro_line|#ifdef CCISS_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;cciss_ioctl: Called with cmd=%x %lx&bslash;n&quot;
comma
id|cmd
comma
id|arg
)paren
suffix:semicolon
macro_line|#endif /* CCISS_DEBUG */ 
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|HDIO_GETGEO
suffix:colon
(brace
r_struct
id|hd_geometry
id|driver_geo
suffix:semicolon
r_if
c_cond
(paren
id|drv-&gt;cylinders
)paren
(brace
id|driver_geo.heads
op_assign
id|drv-&gt;heads
suffix:semicolon
id|driver_geo.sectors
op_assign
id|drv-&gt;sectors
suffix:semicolon
id|driver_geo.cylinders
op_assign
id|drv-&gt;cylinders
suffix:semicolon
)brace
r_else
r_return
op_minus
id|ENXIO
suffix:semicolon
id|driver_geo.start
op_assign
id|get_start_sect
c_func
(paren
id|inode-&gt;i_bdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|argp
comma
op_amp
id|driver_geo
comma
r_sizeof
(paren
r_struct
id|hd_geometry
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|CCISS_GETPCIINFO
suffix:colon
(brace
id|cciss_pci_info_struct
id|pciinfo
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|arg
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|pciinfo.bus
op_assign
id|host-&gt;pdev-&gt;bus-&gt;number
suffix:semicolon
id|pciinfo.dev_fn
op_assign
id|host-&gt;pdev-&gt;devfn
suffix:semicolon
id|pciinfo.board_id
op_assign
id|host-&gt;board_id
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|argp
comma
op_amp
id|pciinfo
comma
r_sizeof
(paren
id|cciss_pci_info_struct
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|CCISS_GETINTINFO
suffix:colon
(brace
id|cciss_coalint_struct
id|intinfo
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|arg
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|intinfo.delay
op_assign
id|readl
c_func
(paren
op_amp
id|host-&gt;cfgtable-&gt;HostWrite.CoalIntDelay
)paren
suffix:semicolon
id|intinfo.count
op_assign
id|readl
c_func
(paren
op_amp
id|host-&gt;cfgtable-&gt;HostWrite.CoalIntCount
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|argp
comma
op_amp
id|intinfo
comma
r_sizeof
(paren
id|cciss_coalint_struct
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|CCISS_SETINTINFO
suffix:colon
(brace
id|cciss_coalint_struct
id|intinfo
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|arg
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_ADMIN
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|intinfo
comma
id|argp
comma
r_sizeof
(paren
id|cciss_coalint_struct
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
(paren
id|intinfo.delay
op_eq
l_int|0
)paren
op_logical_and
(paren
id|intinfo.count
op_eq
l_int|0
)paren
)paren
(brace
singleline_comment|//&t;&t;&t;printk(&quot;cciss_ioctl: delay and count cannot be 0&bslash;n&quot;);
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
id|CCISS_LOCK
c_func
(paren
id|ctlr
)paren
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Update the field, and then ring the doorbell */
id|writel
c_func
(paren
id|intinfo.delay
comma
op_amp
(paren
id|host-&gt;cfgtable-&gt;HostWrite.CoalIntDelay
)paren
)paren
suffix:semicolon
id|writel
c_func
(paren
id|intinfo.count
comma
op_amp
(paren
id|host-&gt;cfgtable-&gt;HostWrite.CoalIntCount
)paren
)paren
suffix:semicolon
id|writel
c_func
(paren
id|CFGTBL_ChangeReq
comma
id|host-&gt;vaddr
op_plus
id|SA5_DOORBELL
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_IOCTL_CONFIG_WAIT
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|readl
c_func
(paren
id|host-&gt;vaddr
op_plus
id|SA5_DOORBELL
)paren
op_amp
id|CFGTBL_ChangeReq
)paren
)paren
r_break
suffix:semicolon
multiline_comment|/* delay and try again */
id|udelay
c_func
(paren
l_int|1000
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
id|CCISS_LOCK
c_func
(paren
id|ctlr
)paren
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ge
id|MAX_IOCTL_CONFIG_WAIT
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|CCISS_GETNODENAME
suffix:colon
(brace
id|NodeName_type
id|NodeName
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|arg
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
id|NodeName
(braket
id|i
)braket
op_assign
id|readb
c_func
(paren
op_amp
id|host-&gt;cfgtable-&gt;ServerName
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|argp
comma
id|NodeName
comma
r_sizeof
(paren
id|NodeName_type
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|CCISS_SETNODENAME
suffix:colon
(brace
id|NodeName_type
id|NodeName
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|arg
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_ADMIN
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|NodeName
comma
id|argp
comma
r_sizeof
(paren
id|NodeName_type
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
id|CCISS_LOCK
c_func
(paren
id|ctlr
)paren
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Update the field, and then ring the doorbell */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
id|writeb
c_func
(paren
id|NodeName
(braket
id|i
)braket
comma
op_amp
id|host-&gt;cfgtable-&gt;ServerName
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|writel
c_func
(paren
id|CFGTBL_ChangeReq
comma
id|host-&gt;vaddr
op_plus
id|SA5_DOORBELL
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_IOCTL_CONFIG_WAIT
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|readl
c_func
(paren
id|host-&gt;vaddr
op_plus
id|SA5_DOORBELL
)paren
op_amp
id|CFGTBL_ChangeReq
)paren
)paren
r_break
suffix:semicolon
multiline_comment|/* delay and try again */
id|udelay
c_func
(paren
l_int|1000
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
id|CCISS_LOCK
c_func
(paren
id|ctlr
)paren
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ge
id|MAX_IOCTL_CONFIG_WAIT
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|CCISS_GETHEARTBEAT
suffix:colon
(brace
id|Heartbeat_type
id|heartbeat
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|arg
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|heartbeat
op_assign
id|readl
c_func
(paren
op_amp
id|host-&gt;cfgtable-&gt;HeartBeat
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|argp
comma
op_amp
id|heartbeat
comma
r_sizeof
(paren
id|Heartbeat_type
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|CCISS_GETBUSTYPES
suffix:colon
(brace
id|BusTypes_type
id|BusTypes
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|arg
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|BusTypes
op_assign
id|readl
c_func
(paren
op_amp
id|host-&gt;cfgtable-&gt;BusTypes
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|argp
comma
op_amp
id|BusTypes
comma
r_sizeof
(paren
id|BusTypes_type
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|CCISS_GETFIRMVER
suffix:colon
(brace
id|FirmwareVer_type
id|firmware
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|arg
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|memcpy
c_func
(paren
id|firmware
comma
id|host-&gt;firm_ver
comma
l_int|4
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|argp
comma
id|firmware
comma
r_sizeof
(paren
id|FirmwareVer_type
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|CCISS_GETDRIVVER
suffix:colon
(brace
id|DriverVer_type
id|DriverVer
op_assign
id|DRIVER_VERSION
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|arg
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|argp
comma
op_amp
id|DriverVer
comma
r_sizeof
(paren
id|DriverVer_type
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|CCISS_REVALIDVOLS
suffix:colon
r_if
c_cond
(paren
id|bdev
op_ne
id|bdev-&gt;bd_contains
op_logical_or
id|drv
op_ne
id|host-&gt;drv
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
r_return
id|revalidate_allvol
c_func
(paren
id|host
)paren
suffix:semicolon
r_case
id|CCISS_GETLUNINFO
suffix:colon
(brace
id|LogvolInfo_struct
id|luninfo
suffix:semicolon
r_int
id|i
suffix:semicolon
id|luninfo.LunID
op_assign
id|drv-&gt;LunID
suffix:semicolon
id|luninfo.num_opens
op_assign
id|drv-&gt;usage_count
suffix:semicolon
id|luninfo.num_parts
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* count partitions 1 to 15 with sizes &gt; 0 */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_PART
op_minus
l_int|1
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|disk-&gt;part
(braket
id|i
)braket
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|disk-&gt;part
(braket
id|i
)braket
op_member_access_from_pointer
id|nr_sects
op_ne
l_int|0
)paren
id|luninfo.num_parts
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|argp
comma
op_amp
id|luninfo
comma
r_sizeof
(paren
id|LogvolInfo_struct
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|CCISS_DEREGDISK
suffix:colon
r_return
id|deregister_disk
c_func
(paren
id|disk
)paren
suffix:semicolon
r_case
id|CCISS_REGNEWD
suffix:colon
r_return
id|register_new_disk
c_func
(paren
id|host
)paren
suffix:semicolon
r_case
id|CCISS_PASSTHRU
suffix:colon
(brace
id|IOCTL_Command_struct
id|iocommand
suffix:semicolon
id|CommandList_struct
op_star
id|c
suffix:semicolon
r_char
op_star
id|buff
op_assign
l_int|NULL
suffix:semicolon
id|u64bit
id|temp64
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|DECLARE_COMPLETION
c_func
(paren
id|wait
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|arg
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_RAWIO
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|iocommand
comma
id|argp
comma
r_sizeof
(paren
id|IOCTL_Command_struct
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
(paren
id|iocommand.buf_size
OL
l_int|1
)paren
op_logical_and
(paren
id|iocommand.Request.Type.Direction
op_ne
id|XFER_NONE
)paren
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
macro_line|#if 0 /* &squot;buf_size&squot; member is 16-bits, and always smaller than kmalloc limit */
multiline_comment|/* Check kmalloc limits */
r_if
c_cond
(paren
id|iocommand.buf_size
OG
l_int|128000
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|iocommand.buf_size
OG
l_int|0
)paren
(brace
id|buff
op_assign
id|kmalloc
c_func
(paren
id|iocommand.buf_size
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buff
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|iocommand.Request.Type.Direction
op_eq
id|XFER_WRITE
)paren
(brace
multiline_comment|/* Copy the data into the buffer we created */
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|buff
comma
id|iocommand.buf
comma
id|iocommand.buf_size
)paren
)paren
(brace
id|kfree
c_func
(paren
id|buff
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
)brace
r_else
(brace
id|memset
c_func
(paren
id|buff
comma
l_int|0
comma
id|iocommand.buf_size
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|c
op_assign
id|cmd_alloc
c_func
(paren
id|host
comma
l_int|0
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|kfree
c_func
(paren
id|buff
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
singleline_comment|// Fill in the command type 
id|c-&gt;cmd_type
op_assign
id|CMD_IOCTL_PEND
suffix:semicolon
singleline_comment|// Fill in Command Header 
id|c-&gt;Header.ReplyQueue
op_assign
l_int|0
suffix:semicolon
singleline_comment|// unused in simple mode
r_if
c_cond
(paren
id|iocommand.buf_size
OG
l_int|0
)paren
singleline_comment|// buffer to fill 
(brace
id|c-&gt;Header.SGList
op_assign
l_int|1
suffix:semicolon
id|c-&gt;Header.SGTotal
op_assign
l_int|1
suffix:semicolon
)brace
r_else
singleline_comment|// no buffers to fill  
(brace
id|c-&gt;Header.SGList
op_assign
l_int|0
suffix:semicolon
id|c-&gt;Header.SGTotal
op_assign
l_int|0
suffix:semicolon
)brace
id|c-&gt;Header.LUN
op_assign
id|iocommand.LUN_info
suffix:semicolon
id|c-&gt;Header.Tag.lower
op_assign
id|c-&gt;busaddr
suffix:semicolon
singleline_comment|// use the kernel address the cmd block for tag
singleline_comment|// Fill in Request block 
id|c-&gt;Request
op_assign
id|iocommand.Request
suffix:semicolon
singleline_comment|// Fill in the scatter gather information
r_if
c_cond
(paren
id|iocommand.buf_size
OG
l_int|0
)paren
(brace
id|temp64.val
op_assign
id|pci_map_single
c_func
(paren
id|host-&gt;pdev
comma
id|buff
comma
id|iocommand.buf_size
comma
id|PCI_DMA_BIDIRECTIONAL
)paren
suffix:semicolon
id|c-&gt;SG
(braket
l_int|0
)braket
dot
id|Addr.lower
op_assign
id|temp64.val32.lower
suffix:semicolon
id|c-&gt;SG
(braket
l_int|0
)braket
dot
id|Addr.upper
op_assign
id|temp64.val32.upper
suffix:semicolon
id|c-&gt;SG
(braket
l_int|0
)braket
dot
id|Len
op_assign
id|iocommand.buf_size
suffix:semicolon
id|c-&gt;SG
(braket
l_int|0
)braket
dot
id|Ext
op_assign
l_int|0
suffix:semicolon
singleline_comment|// we are not chaining
)brace
id|c-&gt;waiting
op_assign
op_amp
id|wait
suffix:semicolon
multiline_comment|/* Put the request on the tail of the request queue */
id|spin_lock_irqsave
c_func
(paren
id|CCISS_LOCK
c_func
(paren
id|ctlr
)paren
comma
id|flags
)paren
suffix:semicolon
id|addQ
c_func
(paren
op_amp
id|host-&gt;reqQ
comma
id|c
)paren
suffix:semicolon
id|host-&gt;Qdepth
op_increment
suffix:semicolon
id|start_io
c_func
(paren
id|host
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
id|CCISS_LOCK
c_func
(paren
id|ctlr
)paren
comma
id|flags
)paren
suffix:semicolon
id|wait_for_completion
c_func
(paren
op_amp
id|wait
)paren
suffix:semicolon
multiline_comment|/* unlock the buffers from DMA */
id|temp64.val32.lower
op_assign
id|c-&gt;SG
(braket
l_int|0
)braket
dot
id|Addr.lower
suffix:semicolon
id|temp64.val32.upper
op_assign
id|c-&gt;SG
(braket
l_int|0
)braket
dot
id|Addr.upper
suffix:semicolon
id|pci_unmap_single
c_func
(paren
id|host-&gt;pdev
comma
(paren
id|dma_addr_t
)paren
id|temp64.val
comma
id|iocommand.buf_size
comma
id|PCI_DMA_BIDIRECTIONAL
)paren
suffix:semicolon
multiline_comment|/* Copy the error information out */
id|iocommand.error_info
op_assign
op_star
(paren
id|c-&gt;err_info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|argp
comma
op_amp
id|iocommand
comma
r_sizeof
(paren
id|IOCTL_Command_struct
)paren
)paren
)paren
(brace
id|kfree
c_func
(paren
id|buff
)paren
suffix:semicolon
id|cmd_free
c_func
(paren
id|host
comma
id|c
comma
l_int|0
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|iocommand.Request.Type.Direction
op_eq
id|XFER_READ
)paren
(brace
multiline_comment|/* Copy the data out of the buffer we created */
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|iocommand.buf
comma
id|buff
comma
id|iocommand.buf_size
)paren
)paren
(brace
id|kfree
c_func
(paren
id|buff
)paren
suffix:semicolon
id|cmd_free
c_func
(paren
id|host
comma
id|c
comma
l_int|0
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
)brace
id|kfree
c_func
(paren
id|buff
)paren
suffix:semicolon
id|cmd_free
c_func
(paren
id|host
comma
id|c
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|CCISS_BIG_PASSTHRU
suffix:colon
(brace
id|BIG_IOCTL_Command_struct
op_star
id|ioc
suffix:semicolon
id|CommandList_struct
op_star
id|c
suffix:semicolon
r_int
r_char
op_star
op_star
id|buff
op_assign
l_int|NULL
suffix:semicolon
r_int
op_star
id|buff_size
op_assign
l_int|NULL
suffix:semicolon
id|u64bit
id|temp64
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|BYTE
id|sg_used
op_assign
l_int|0
suffix:semicolon
r_int
id|status
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
id|DECLARE_COMPLETION
c_func
(paren
id|wait
)paren
suffix:semicolon
id|__u32
id|left
suffix:semicolon
id|__u32
id|sz
suffix:semicolon
id|BYTE
id|__user
op_star
id|data_ptr
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|arg
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_RAWIO
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
id|ioc
op_assign
(paren
id|BIG_IOCTL_Command_struct
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|ioc
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ioc
)paren
(brace
id|status
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|cleanup1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|ioc
comma
id|argp
comma
r_sizeof
(paren
op_star
id|ioc
)paren
)paren
)paren
(brace
id|status
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
id|cleanup1
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|ioc-&gt;buf_size
OL
l_int|1
)paren
op_logical_and
(paren
id|ioc-&gt;Request.Type.Direction
op_ne
id|XFER_NONE
)paren
)paren
(brace
id|status
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|cleanup1
suffix:semicolon
)brace
multiline_comment|/* Check kmalloc limits  using all SGs */
r_if
c_cond
(paren
id|ioc-&gt;malloc_size
OG
id|MAX_KMALLOC_SIZE
)paren
(brace
id|status
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|cleanup1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ioc-&gt;buf_size
OG
id|ioc-&gt;malloc_size
op_star
id|MAXSGENTRIES
)paren
(brace
id|status
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|cleanup1
suffix:semicolon
)brace
id|buff
op_assign
(paren
r_int
r_char
op_star
op_star
)paren
id|kmalloc
c_func
(paren
id|MAXSGENTRIES
op_star
r_sizeof
(paren
r_char
op_star
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|buff
)paren
(brace
id|status
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|cleanup1
suffix:semicolon
)brace
id|memset
c_func
(paren
id|buff
comma
l_int|0
comma
id|MAXSGENTRIES
)paren
suffix:semicolon
id|buff_size
op_assign
(paren
r_int
op_star
)paren
id|kmalloc
c_func
(paren
id|MAXSGENTRIES
op_star
r_sizeof
(paren
r_int
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|buff_size
)paren
(brace
id|status
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|cleanup1
suffix:semicolon
)brace
id|left
op_assign
id|ioc-&gt;buf_size
suffix:semicolon
id|data_ptr
op_assign
id|ioc-&gt;buf
suffix:semicolon
r_while
c_loop
(paren
id|left
)paren
(brace
id|sz
op_assign
(paren
id|left
OG
id|ioc-&gt;malloc_size
)paren
ques
c_cond
id|ioc-&gt;malloc_size
suffix:colon
id|left
suffix:semicolon
id|buff_size
(braket
id|sg_used
)braket
op_assign
id|sz
suffix:semicolon
id|buff
(braket
id|sg_used
)braket
op_assign
id|kmalloc
c_func
(paren
id|sz
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buff
(braket
id|sg_used
)braket
op_eq
l_int|NULL
)paren
(brace
id|status
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|cleanup1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ioc-&gt;Request.Type.Direction
op_eq
id|XFER_WRITE
op_logical_and
id|copy_from_user
c_func
(paren
id|buff
(braket
id|sg_used
)braket
comma
id|data_ptr
comma
id|sz
)paren
)paren
(brace
id|status
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|cleanup1
suffix:semicolon
)brace
r_else
(brace
id|memset
c_func
(paren
id|buff
(braket
id|sg_used
)braket
comma
l_int|0
comma
id|sz
)paren
suffix:semicolon
)brace
id|left
op_sub_assign
id|sz
suffix:semicolon
id|data_ptr
op_add_assign
id|sz
suffix:semicolon
id|sg_used
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|c
op_assign
id|cmd_alloc
c_func
(paren
id|host
comma
l_int|0
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|status
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|cleanup1
suffix:semicolon
)brace
id|c-&gt;cmd_type
op_assign
id|CMD_IOCTL_PEND
suffix:semicolon
id|c-&gt;Header.ReplyQueue
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ioc-&gt;buf_size
OG
l_int|0
)paren
(brace
id|c-&gt;Header.SGList
op_assign
id|sg_used
suffix:semicolon
id|c-&gt;Header.SGTotal
op_assign
id|sg_used
suffix:semicolon
)brace
r_else
(brace
id|c-&gt;Header.SGList
op_assign
l_int|0
suffix:semicolon
id|c-&gt;Header.SGTotal
op_assign
l_int|0
suffix:semicolon
)brace
id|c-&gt;Header.LUN
op_assign
id|ioc-&gt;LUN_info
suffix:semicolon
id|c-&gt;Header.Tag.lower
op_assign
id|c-&gt;busaddr
suffix:semicolon
id|c-&gt;Request
op_assign
id|ioc-&gt;Request
suffix:semicolon
r_if
c_cond
(paren
id|ioc-&gt;buf_size
OG
l_int|0
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|sg_used
suffix:semicolon
id|i
op_increment
)paren
(brace
id|temp64.val
op_assign
id|pci_map_single
c_func
(paren
id|host-&gt;pdev
comma
id|buff
(braket
id|i
)braket
comma
id|buff_size
(braket
id|i
)braket
comma
id|PCI_DMA_BIDIRECTIONAL
)paren
suffix:semicolon
id|c-&gt;SG
(braket
id|i
)braket
dot
id|Addr.lower
op_assign
id|temp64.val32.lower
suffix:semicolon
id|c-&gt;SG
(braket
id|i
)braket
dot
id|Addr.upper
op_assign
id|temp64.val32.upper
suffix:semicolon
id|c-&gt;SG
(braket
id|i
)braket
dot
id|Len
op_assign
id|buff_size
(braket
id|i
)braket
suffix:semicolon
id|c-&gt;SG
(braket
id|i
)braket
dot
id|Ext
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* we are not chaining */
)brace
)brace
id|c-&gt;waiting
op_assign
op_amp
id|wait
suffix:semicolon
multiline_comment|/* Put the request on the tail of the request queue */
id|spin_lock_irqsave
c_func
(paren
id|CCISS_LOCK
c_func
(paren
id|ctlr
)paren
comma
id|flags
)paren
suffix:semicolon
id|addQ
c_func
(paren
op_amp
id|host-&gt;reqQ
comma
id|c
)paren
suffix:semicolon
id|host-&gt;Qdepth
op_increment
suffix:semicolon
id|start_io
c_func
(paren
id|host
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
id|CCISS_LOCK
c_func
(paren
id|ctlr
)paren
comma
id|flags
)paren
suffix:semicolon
id|wait_for_completion
c_func
(paren
op_amp
id|wait
)paren
suffix:semicolon
multiline_comment|/* unlock the buffers from DMA */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|sg_used
suffix:semicolon
id|i
op_increment
)paren
(brace
id|temp64.val32.lower
op_assign
id|c-&gt;SG
(braket
id|i
)braket
dot
id|Addr.lower
suffix:semicolon
id|temp64.val32.upper
op_assign
id|c-&gt;SG
(braket
id|i
)braket
dot
id|Addr.upper
suffix:semicolon
id|pci_unmap_single
c_func
(paren
id|host-&gt;pdev
comma
(paren
id|dma_addr_t
)paren
id|temp64.val
comma
id|buff_size
(braket
id|i
)braket
comma
id|PCI_DMA_BIDIRECTIONAL
)paren
suffix:semicolon
)brace
multiline_comment|/* Copy the error information out */
id|ioc-&gt;error_info
op_assign
op_star
(paren
id|c-&gt;err_info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|argp
comma
id|ioc
comma
r_sizeof
(paren
op_star
id|ioc
)paren
)paren
)paren
(brace
id|cmd_free
c_func
(paren
id|host
comma
id|c
comma
l_int|0
)paren
suffix:semicolon
id|status
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
id|cleanup1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ioc-&gt;Request.Type.Direction
op_eq
id|XFER_READ
)paren
(brace
multiline_comment|/* Copy the data out of the buffer we created */
id|BYTE
id|__user
op_star
id|ptr
op_assign
id|ioc-&gt;buf
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|sg_used
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|ptr
comma
id|buff
(braket
id|i
)braket
comma
id|buff_size
(braket
id|i
)braket
)paren
)paren
(brace
id|cmd_free
c_func
(paren
id|host
comma
id|c
comma
l_int|0
)paren
suffix:semicolon
id|status
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
id|cleanup1
suffix:semicolon
)brace
id|ptr
op_add_assign
id|buff_size
(braket
id|i
)braket
suffix:semicolon
)brace
)brace
id|cmd_free
c_func
(paren
id|host
comma
id|c
comma
l_int|0
)paren
suffix:semicolon
id|status
op_assign
l_int|0
suffix:semicolon
id|cleanup1
suffix:colon
r_if
c_cond
(paren
id|buff
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|sg_used
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|buff
(braket
id|i
)braket
op_ne
l_int|NULL
)paren
(brace
id|kfree
c_func
(paren
id|buff
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|buff
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|buff_size
)paren
id|kfree
c_func
(paren
id|buff_size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioc
)paren
id|kfree
c_func
(paren
id|ioc
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
r_default
suffix:colon
r_return
op_minus
id|ENOTTY
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * revalidate_allvol is for online array config utilities.  After a&n; * utility reconfigures the drives in the array, it can use this function&n; * (through an ioctl) to make the driver zap any previous disk structs for&n; * that controller and get new ones.&n; *&n; * Right now I&squot;m using the getgeometry() function to do this, but this&n; * function should probably be finer grained and allow you to revalidate one&n; * particualar logical volume (instead of all of them on a particular&n; * controller).&n; */
DECL|function|revalidate_allvol
r_static
r_int
id|revalidate_allvol
c_func
(paren
id|ctlr_info_t
op_star
id|host
)paren
(brace
r_int
id|ctlr
op_assign
id|host-&gt;ctlr
comma
id|i
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
id|CCISS_LOCK
c_func
(paren
id|ctlr
)paren
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|host-&gt;usage_count
OG
l_int|1
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
id|CCISS_LOCK
c_func
(paren
id|ctlr
)paren
comma
id|flags
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;cciss: Device busy for volume&quot;
l_string|&quot; revalidation (usage=%d)&bslash;n&quot;
comma
id|host-&gt;usage_count
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|host-&gt;usage_count
op_increment
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
id|CCISS_LOCK
c_func
(paren
id|ctlr
)paren
comma
id|flags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NWD
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|gendisk
op_star
id|disk
op_assign
id|host-&gt;gendisk
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|disk-&gt;flags
op_amp
id|GENHD_FL_UP
)paren
id|del_gendisk
c_func
(paren
id|disk
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;         * Set the partition and block size structures for all volumes&n;         * on this controller to zero.  We will reread all of this data&n;         */
id|memset
c_func
(paren
id|host-&gt;drv
comma
l_int|0
comma
r_sizeof
(paren
id|drive_info_struct
)paren
op_star
id|CISS_MAX_LUN
)paren
suffix:semicolon
multiline_comment|/*&n;         * Tell the array controller not to give us any interrupts while&n;         * we check the new geometry.  Then turn interrupts back on when&n;         * we&squot;re done.&n;         */
id|host-&gt;access
dot
id|set_intr_mask
c_func
(paren
id|host
comma
id|CCISS_INTR_OFF
)paren
suffix:semicolon
id|cciss_getgeometry
c_func
(paren
id|ctlr
)paren
suffix:semicolon
id|host-&gt;access
dot
id|set_intr_mask
c_func
(paren
id|host
comma
id|CCISS_INTR_ON
)paren
suffix:semicolon
multiline_comment|/* Loop through each real device */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NWD
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|gendisk
op_star
id|disk
op_assign
id|host-&gt;gendisk
(braket
id|i
)braket
suffix:semicolon
id|drive_info_struct
op_star
id|drv
op_assign
op_amp
(paren
id|host-&gt;drv
(braket
id|i
)braket
)paren
suffix:semicolon
multiline_comment|/* we must register the controller even if no disks exist */
multiline_comment|/* this is for the online array utilities */
r_if
c_cond
(paren
op_logical_neg
id|drv-&gt;heads
op_logical_and
id|i
)paren
r_continue
suffix:semicolon
id|blk_queue_hardsect_size
c_func
(paren
id|host-&gt;queue
comma
id|drv-&gt;block_size
)paren
suffix:semicolon
id|set_capacity
c_func
(paren
id|disk
comma
id|drv-&gt;nr_blocks
)paren
suffix:semicolon
id|add_disk
c_func
(paren
id|disk
)paren
suffix:semicolon
)brace
id|host-&gt;usage_count
op_decrement
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|deregister_disk
r_static
r_int
id|deregister_disk
c_func
(paren
r_struct
id|gendisk
op_star
id|disk
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|ctlr_info_t
op_star
id|h
op_assign
id|get_host
c_func
(paren
id|disk
)paren
suffix:semicolon
id|drive_info_struct
op_star
id|drv
op_assign
id|get_drv
c_func
(paren
id|disk
)paren
suffix:semicolon
r_int
id|ctlr
op_assign
id|h-&gt;ctlr
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_RAWIO
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
id|CCISS_LOCK
c_func
(paren
id|ctlr
)paren
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* make sure logical volume is NOT is use */
r_if
c_cond
(paren
id|drv-&gt;usage_count
OG
l_int|1
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
id|CCISS_LOCK
c_func
(paren
id|ctlr
)paren
comma
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|drv-&gt;usage_count
op_increment
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
id|CCISS_LOCK
c_func
(paren
id|ctlr
)paren
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* invalidate the devices and deregister the disk */
r_if
c_cond
(paren
id|disk-&gt;flags
op_amp
id|GENHD_FL_UP
)paren
id|del_gendisk
c_func
(paren
id|disk
)paren
suffix:semicolon
multiline_comment|/* check to see if it was the last disk */
r_if
c_cond
(paren
id|drv
op_eq
id|h-&gt;drv
op_plus
id|h-&gt;highest_lun
)paren
(brace
multiline_comment|/* if so, find the new hightest lun */
r_int
id|i
comma
id|newhighest
op_assign
op_minus
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|h-&gt;highest_lun
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* if the disk has size &gt; 0, it is available */
r_if
c_cond
(paren
id|h-&gt;drv
(braket
id|i
)braket
dot
id|nr_blocks
)paren
id|newhighest
op_assign
id|i
suffix:semicolon
)brace
id|h-&gt;highest_lun
op_assign
id|newhighest
suffix:semicolon
)brace
op_decrement
id|h-&gt;num_luns
suffix:semicolon
multiline_comment|/* zero out the disk size info */
id|drv-&gt;nr_blocks
op_assign
l_int|0
suffix:semicolon
id|drv-&gt;block_size
op_assign
l_int|0
suffix:semicolon
id|drv-&gt;cylinders
op_assign
l_int|0
suffix:semicolon
id|drv-&gt;LunID
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|fill_cmd
r_static
r_int
id|fill_cmd
c_func
(paren
id|CommandList_struct
op_star
id|c
comma
id|__u8
id|cmd
comma
r_int
id|ctlr
comma
r_void
op_star
id|buff
comma
r_int
id|size
comma
r_int
r_int
id|use_unit_num
comma
multiline_comment|/* 0: address the controller,&n;&t;&t;&t;&t;      1: address logical volume log_unit,&n;&t;&t;&t;&t;      2: periph device address is scsi3addr */
r_int
r_int
id|log_unit
comma
id|__u8
id|page_code
comma
r_int
r_char
op_star
id|scsi3addr
comma
r_int
id|cmd_type
)paren
(brace
id|ctlr_info_t
op_star
id|h
op_assign
id|hba
(braket
id|ctlr
)braket
suffix:semicolon
id|u64bit
id|buff_dma_handle
suffix:semicolon
r_int
id|status
op_assign
id|IO_OK
suffix:semicolon
id|c-&gt;cmd_type
op_assign
id|CMD_IOCTL_PEND
suffix:semicolon
id|c-&gt;Header.ReplyQueue
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|buff
op_ne
l_int|NULL
)paren
(brace
id|c-&gt;Header.SGList
op_assign
l_int|1
suffix:semicolon
id|c-&gt;Header.SGTotal
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|c-&gt;Header.SGList
op_assign
l_int|0
suffix:semicolon
id|c-&gt;Header.SGTotal
op_assign
l_int|0
suffix:semicolon
)brace
id|c-&gt;Header.Tag.lower
op_assign
id|c-&gt;busaddr
suffix:semicolon
id|c-&gt;Request.Type.Type
op_assign
id|cmd_type
suffix:semicolon
r_if
c_cond
(paren
id|cmd_type
op_eq
id|TYPE_CMD
)paren
(brace
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|CISS_INQUIRY
suffix:colon
multiline_comment|/* If the logical unit number is 0 then, this is going&n;&t;&t;&t;to controller so It&squot;s a physical command&n;&t;&t;&t;mode = 0 target = 0.  So we have nothing to write.&n;&t;&t;&t;otherwise, if use_unit_num == 1,&n;&t;&t;&t;mode = 1(volume set addressing) target = LUNID&n;&t;&t;&t;otherwise, if use_unit_num == 2,&n;&t;&t;&t;mode = 0(periph dev addr) target = scsi3addr */
r_if
c_cond
(paren
id|use_unit_num
op_eq
l_int|1
)paren
(brace
id|c-&gt;Header.LUN.LogDev.VolId
op_assign
id|h-&gt;drv
(braket
id|log_unit
)braket
dot
id|LunID
suffix:semicolon
id|c-&gt;Header.LUN.LogDev.Mode
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|use_unit_num
op_eq
l_int|2
)paren
(brace
id|memcpy
c_func
(paren
id|c-&gt;Header.LUN.LunAddrBytes
comma
id|scsi3addr
comma
l_int|8
)paren
suffix:semicolon
id|c-&gt;Header.LUN.LogDev.Mode
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* are we trying to read a vital product page */
r_if
c_cond
(paren
id|page_code
op_ne
l_int|0
)paren
(brace
id|c-&gt;Request.CDB
(braket
l_int|1
)braket
op_assign
l_int|0x01
suffix:semicolon
id|c-&gt;Request.CDB
(braket
l_int|2
)braket
op_assign
id|page_code
suffix:semicolon
)brace
id|c-&gt;Request.CDBLen
op_assign
l_int|6
suffix:semicolon
id|c-&gt;Request.Type.Attribute
op_assign
id|ATTR_SIMPLE
suffix:semicolon
id|c-&gt;Request.Type.Direction
op_assign
id|XFER_READ
suffix:semicolon
id|c-&gt;Request.Timeout
op_assign
l_int|0
suffix:semicolon
id|c-&gt;Request.CDB
(braket
l_int|0
)braket
op_assign
id|CISS_INQUIRY
suffix:semicolon
id|c-&gt;Request.CDB
(braket
l_int|4
)braket
op_assign
id|size
op_amp
l_int|0xFF
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CISS_REPORT_LOG
suffix:colon
r_case
id|CISS_REPORT_PHYS
suffix:colon
multiline_comment|/* Talking to controller so It&squot;s a physical command&n;&t;&t;&t;   mode = 00 target = 0.  Nothing to write.&n;                        */
id|c-&gt;Request.CDBLen
op_assign
l_int|12
suffix:semicolon
id|c-&gt;Request.Type.Attribute
op_assign
id|ATTR_SIMPLE
suffix:semicolon
id|c-&gt;Request.Type.Direction
op_assign
id|XFER_READ
suffix:semicolon
id|c-&gt;Request.Timeout
op_assign
l_int|0
suffix:semicolon
id|c-&gt;Request.CDB
(braket
l_int|0
)braket
op_assign
id|cmd
suffix:semicolon
id|c-&gt;Request.CDB
(braket
l_int|6
)braket
op_assign
(paren
id|size
op_rshift
l_int|24
)paren
op_amp
l_int|0xFF
suffix:semicolon
singleline_comment|//MSB
id|c-&gt;Request.CDB
(braket
l_int|7
)braket
op_assign
(paren
id|size
op_rshift
l_int|16
)paren
op_amp
l_int|0xFF
suffix:semicolon
id|c-&gt;Request.CDB
(braket
l_int|8
)braket
op_assign
(paren
id|size
op_rshift
l_int|8
)paren
op_amp
l_int|0xFF
suffix:semicolon
id|c-&gt;Request.CDB
(braket
l_int|9
)braket
op_assign
id|size
op_amp
l_int|0xFF
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CCISS_READ_CAPACITY
suffix:colon
id|c-&gt;Header.LUN.LogDev.VolId
op_assign
id|h-&gt;drv
(braket
id|log_unit
)braket
dot
id|LunID
suffix:semicolon
id|c-&gt;Header.LUN.LogDev.Mode
op_assign
l_int|1
suffix:semicolon
id|c-&gt;Request.CDBLen
op_assign
l_int|10
suffix:semicolon
id|c-&gt;Request.Type.Attribute
op_assign
id|ATTR_SIMPLE
suffix:semicolon
id|c-&gt;Request.Type.Direction
op_assign
id|XFER_READ
suffix:semicolon
id|c-&gt;Request.Timeout
op_assign
l_int|0
suffix:semicolon
id|c-&gt;Request.CDB
(braket
l_int|0
)braket
op_assign
id|cmd
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CCISS_CACHE_FLUSH
suffix:colon
id|c-&gt;Request.CDBLen
op_assign
l_int|12
suffix:semicolon
id|c-&gt;Request.Type.Attribute
op_assign
id|ATTR_SIMPLE
suffix:semicolon
id|c-&gt;Request.Type.Direction
op_assign
id|XFER_WRITE
suffix:semicolon
id|c-&gt;Request.Timeout
op_assign
l_int|0
suffix:semicolon
id|c-&gt;Request.CDB
(braket
l_int|0
)braket
op_assign
id|BMIC_WRITE
suffix:semicolon
id|c-&gt;Request.CDB
(braket
l_int|6
)braket
op_assign
id|BMIC_CACHE_FLUSH
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;cciss%d:  Unknown Command 0x%c&bslash;n&quot;
comma
id|ctlr
comma
id|cmd
)paren
suffix:semicolon
r_return
id|IO_ERROR
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|cmd_type
op_eq
id|TYPE_MSG
)paren
(brace
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
l_int|3
suffix:colon
multiline_comment|/* No-Op message */
id|c-&gt;Request.CDBLen
op_assign
l_int|1
suffix:semicolon
id|c-&gt;Request.Type.Attribute
op_assign
id|ATTR_SIMPLE
suffix:semicolon
id|c-&gt;Request.Type.Direction
op_assign
id|XFER_WRITE
suffix:semicolon
id|c-&gt;Request.Timeout
op_assign
l_int|0
suffix:semicolon
id|c-&gt;Request.CDB
(braket
l_int|0
)braket
op_assign
id|cmd
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;cciss%d: unknown message type %d&bslash;n&quot;
comma
id|ctlr
comma
id|cmd
)paren
suffix:semicolon
r_return
id|IO_ERROR
suffix:semicolon
)brace
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;cciss%d: unknown command type %d&bslash;n&quot;
comma
id|ctlr
comma
id|cmd_type
)paren
suffix:semicolon
r_return
id|IO_ERROR
suffix:semicolon
)brace
multiline_comment|/* Fill in the scatter gather information */
r_if
c_cond
(paren
id|size
OG
l_int|0
)paren
(brace
id|buff_dma_handle.val
op_assign
(paren
id|__u64
)paren
id|pci_map_single
c_func
(paren
id|h-&gt;pdev
comma
id|buff
comma
id|size
comma
id|PCI_DMA_BIDIRECTIONAL
)paren
suffix:semicolon
id|c-&gt;SG
(braket
l_int|0
)braket
dot
id|Addr.lower
op_assign
id|buff_dma_handle.val32.lower
suffix:semicolon
id|c-&gt;SG
(braket
l_int|0
)braket
dot
id|Addr.upper
op_assign
id|buff_dma_handle.val32.upper
suffix:semicolon
id|c-&gt;SG
(braket
l_int|0
)braket
dot
id|Len
op_assign
id|size
suffix:semicolon
id|c-&gt;SG
(braket
l_int|0
)braket
dot
id|Ext
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* we are not chaining */
)brace
r_return
id|status
suffix:semicolon
)brace
DECL|function|sendcmd_withirq
r_static
r_int
id|sendcmd_withirq
c_func
(paren
id|__u8
id|cmd
comma
r_int
id|ctlr
comma
r_void
op_star
id|buff
comma
r_int
id|size
comma
r_int
r_int
id|use_unit_num
comma
r_int
r_int
id|log_unit
comma
id|__u8
id|page_code
comma
r_int
id|cmd_type
)paren
(brace
id|ctlr_info_t
op_star
id|h
op_assign
id|hba
(braket
id|ctlr
)braket
suffix:semicolon
id|CommandList_struct
op_star
id|c
suffix:semicolon
id|u64bit
id|buff_dma_handle
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|return_status
suffix:semicolon
id|DECLARE_COMPLETION
c_func
(paren
id|wait
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|c
op_assign
id|cmd_alloc
c_func
(paren
id|h
comma
l_int|0
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|return_status
op_assign
id|fill_cmd
c_func
(paren
id|c
comma
id|cmd
comma
id|ctlr
comma
id|buff
comma
id|size
comma
id|use_unit_num
comma
id|log_unit
comma
id|page_code
comma
l_int|NULL
comma
id|cmd_type
)paren
suffix:semicolon
r_if
c_cond
(paren
id|return_status
op_ne
id|IO_OK
)paren
(brace
id|cmd_free
c_func
(paren
id|h
comma
id|c
comma
l_int|0
)paren
suffix:semicolon
r_return
id|return_status
suffix:semicolon
)brace
id|resend_cmd2
suffix:colon
id|c-&gt;waiting
op_assign
op_amp
id|wait
suffix:semicolon
multiline_comment|/* Put the request on the tail of the queue and send it */
id|spin_lock_irqsave
c_func
(paren
id|CCISS_LOCK
c_func
(paren
id|ctlr
)paren
comma
id|flags
)paren
suffix:semicolon
id|addQ
c_func
(paren
op_amp
id|h-&gt;reqQ
comma
id|c
)paren
suffix:semicolon
id|h-&gt;Qdepth
op_increment
suffix:semicolon
id|start_io
c_func
(paren
id|h
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
id|CCISS_LOCK
c_func
(paren
id|ctlr
)paren
comma
id|flags
)paren
suffix:semicolon
id|wait_for_completion
c_func
(paren
op_amp
id|wait
)paren
suffix:semicolon
r_if
c_cond
(paren
id|c-&gt;err_info-&gt;CommandStatus
op_ne
l_int|0
)paren
(brace
multiline_comment|/* an error has occurred */
r_switch
c_cond
(paren
id|c-&gt;err_info-&gt;CommandStatus
)paren
(brace
r_case
id|CMD_TARGET_STATUS
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;cciss: cmd %p has &quot;
l_string|&quot; completed with errors&bslash;n&quot;
comma
id|c
)paren
suffix:semicolon
r_if
c_cond
(paren
id|c-&gt;err_info-&gt;ScsiStatus
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;cciss: cmd %p &quot;
l_string|&quot;has SCSI Status = %x&bslash;n&quot;
comma
id|c
comma
id|c-&gt;err_info-&gt;ScsiStatus
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|CMD_DATA_UNDERRUN
suffix:colon
r_case
id|CMD_DATA_OVERRUN
suffix:colon
multiline_comment|/* expected for inquire and report lun commands */
r_break
suffix:semicolon
r_case
id|CMD_INVALID
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;cciss: Cmd %p is &quot;
l_string|&quot;reported invalid&bslash;n&quot;
comma
id|c
)paren
suffix:semicolon
id|return_status
op_assign
id|IO_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CMD_PROTOCOL_ERR
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;cciss: cmd %p has &quot;
l_string|&quot;protocol error &bslash;n&quot;
comma
id|c
)paren
suffix:semicolon
id|return_status
op_assign
id|IO_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CMD_HARDWARE_ERR
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;cciss: cmd %p had &quot;
l_string|&quot; hardware error&bslash;n&quot;
comma
id|c
)paren
suffix:semicolon
id|return_status
op_assign
id|IO_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CMD_CONNECTION_LOST
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;cciss: cmd %p had &quot;
l_string|&quot;connection lost&bslash;n&quot;
comma
id|c
)paren
suffix:semicolon
id|return_status
op_assign
id|IO_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CMD_ABORTED
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;cciss: cmd %p was &quot;
l_string|&quot;aborted&bslash;n&quot;
comma
id|c
)paren
suffix:semicolon
id|return_status
op_assign
id|IO_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CMD_ABORT_FAILED
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;cciss: cmd %p reports &quot;
l_string|&quot;abort failed&bslash;n&quot;
comma
id|c
)paren
suffix:semicolon
id|return_status
op_assign
id|IO_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CMD_UNSOLICITED_ABORT
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;cciss%d: unsolicited abort %p&bslash;n&quot;
comma
id|ctlr
comma
id|c
)paren
suffix:semicolon
r_if
c_cond
(paren
id|c-&gt;retry_count
OL
id|MAX_CMD_RETRIES
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;cciss%d: retrying %p&bslash;n&quot;
comma
id|ctlr
comma
id|c
)paren
suffix:semicolon
id|c-&gt;retry_count
op_increment
suffix:semicolon
multiline_comment|/* erase the old error information */
id|memset
c_func
(paren
id|c-&gt;err_info
comma
l_int|0
comma
r_sizeof
(paren
id|ErrorInfo_struct
)paren
)paren
suffix:semicolon
id|return_status
op_assign
id|IO_OK
suffix:semicolon
id|INIT_COMPLETION
c_func
(paren
id|wait
)paren
suffix:semicolon
r_goto
id|resend_cmd2
suffix:semicolon
)brace
id|return_status
op_assign
id|IO_ERROR
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;cciss: cmd %p returned &quot;
l_string|&quot;unknown status %x&bslash;n&quot;
comma
id|c
comma
id|c-&gt;err_info-&gt;CommandStatus
)paren
suffix:semicolon
id|return_status
op_assign
id|IO_ERROR
suffix:semicolon
)brace
)brace
multiline_comment|/* unlock the buffers from DMA */
id|pci_unmap_single
c_func
(paren
id|h-&gt;pdev
comma
(paren
id|dma_addr_t
)paren
id|buff_dma_handle.val
comma
id|size
comma
id|PCI_DMA_BIDIRECTIONAL
)paren
suffix:semicolon
id|cmd_free
c_func
(paren
id|h
comma
id|c
comma
l_int|0
)paren
suffix:semicolon
r_return
id|return_status
suffix:semicolon
)brace
DECL|function|cciss_geometry_inquiry
r_static
r_void
id|cciss_geometry_inquiry
c_func
(paren
r_int
id|ctlr
comma
r_int
id|logvol
comma
r_int
id|withirq
comma
r_int
r_int
id|total_size
comma
r_int
r_int
id|block_size
comma
id|InquiryData_struct
op_star
id|inq_buff
comma
id|drive_info_struct
op_star
id|drv
)paren
(brace
r_int
id|return_code
suffix:semicolon
id|memset
c_func
(paren
id|inq_buff
comma
l_int|0
comma
r_sizeof
(paren
id|InquiryData_struct
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|withirq
)paren
id|return_code
op_assign
id|sendcmd_withirq
c_func
(paren
id|CISS_INQUIRY
comma
id|ctlr
comma
id|inq_buff
comma
r_sizeof
(paren
op_star
id|inq_buff
)paren
comma
l_int|1
comma
id|logvol
comma
l_int|0xC1
comma
id|TYPE_CMD
)paren
suffix:semicolon
r_else
id|return_code
op_assign
id|sendcmd
c_func
(paren
id|CISS_INQUIRY
comma
id|ctlr
comma
id|inq_buff
comma
r_sizeof
(paren
op_star
id|inq_buff
)paren
comma
l_int|1
comma
id|logvol
comma
l_int|0xC1
comma
l_int|NULL
comma
id|TYPE_CMD
)paren
suffix:semicolon
r_if
c_cond
(paren
id|return_code
op_eq
id|IO_OK
)paren
(brace
r_if
c_cond
(paren
id|inq_buff-&gt;data_byte
(braket
l_int|8
)braket
op_eq
l_int|0xFF
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;cciss: reading geometry failed, volume &quot;
l_string|&quot;does not support reading geometry&bslash;n&quot;
)paren
suffix:semicolon
id|drv-&gt;block_size
op_assign
id|block_size
suffix:semicolon
id|drv-&gt;nr_blocks
op_assign
id|total_size
suffix:semicolon
id|drv-&gt;heads
op_assign
l_int|255
suffix:semicolon
id|drv-&gt;sectors
op_assign
l_int|32
suffix:semicolon
singleline_comment|// Sectors per track
id|drv-&gt;cylinders
op_assign
id|total_size
op_div
l_int|255
op_div
l_int|32
suffix:semicolon
)brace
r_else
(brace
r_int
r_int
id|t
suffix:semicolon
id|drv-&gt;block_size
op_assign
id|block_size
suffix:semicolon
id|drv-&gt;nr_blocks
op_assign
id|total_size
suffix:semicolon
id|drv-&gt;heads
op_assign
id|inq_buff-&gt;data_byte
(braket
l_int|6
)braket
suffix:semicolon
id|drv-&gt;sectors
op_assign
id|inq_buff-&gt;data_byte
(braket
l_int|7
)braket
suffix:semicolon
id|drv-&gt;cylinders
op_assign
(paren
id|inq_buff-&gt;data_byte
(braket
l_int|4
)braket
op_amp
l_int|0xff
)paren
op_lshift
l_int|8
suffix:semicolon
id|drv-&gt;cylinders
op_add_assign
id|inq_buff-&gt;data_byte
(braket
l_int|5
)braket
suffix:semicolon
id|drv-&gt;raid_level
op_assign
id|inq_buff-&gt;data_byte
(braket
l_int|8
)braket
suffix:semicolon
id|t
op_assign
id|drv-&gt;heads
op_star
id|drv-&gt;sectors
suffix:semicolon
r_if
c_cond
(paren
id|t
OG
l_int|1
)paren
(brace
id|drv-&gt;cylinders
op_assign
id|total_size
op_div
id|t
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
multiline_comment|/* Get geometry failed */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;cciss: reading geometry failed&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;      heads= %d, sectors= %d, cylinders= %d&bslash;n&bslash;n&quot;
comma
id|drv-&gt;heads
comma
id|drv-&gt;sectors
comma
id|drv-&gt;cylinders
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|cciss_read_capacity
id|cciss_read_capacity
c_func
(paren
r_int
id|ctlr
comma
r_int
id|logvol
comma
id|ReadCapdata_struct
op_star
id|buf
comma
r_int
id|withirq
comma
r_int
r_int
op_star
id|total_size
comma
r_int
r_int
op_star
id|block_size
)paren
(brace
r_int
id|return_code
suffix:semicolon
id|memset
c_func
(paren
id|buf
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|buf
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|withirq
)paren
id|return_code
op_assign
id|sendcmd_withirq
c_func
(paren
id|CCISS_READ_CAPACITY
comma
id|ctlr
comma
id|buf
comma
r_sizeof
(paren
op_star
id|buf
)paren
comma
l_int|1
comma
id|logvol
comma
l_int|0
comma
id|TYPE_CMD
)paren
suffix:semicolon
r_else
id|return_code
op_assign
id|sendcmd
c_func
(paren
id|CCISS_READ_CAPACITY
comma
id|ctlr
comma
id|buf
comma
r_sizeof
(paren
op_star
id|buf
)paren
comma
l_int|1
comma
id|logvol
comma
l_int|0
comma
l_int|NULL
comma
id|TYPE_CMD
)paren
suffix:semicolon
r_if
c_cond
(paren
id|return_code
op_eq
id|IO_OK
)paren
(brace
op_star
id|total_size
op_assign
id|be32_to_cpu
c_func
(paren
op_star
(paren
(paren
id|__be32
op_star
)paren
op_amp
id|buf-&gt;total_size
(braket
l_int|0
)braket
)paren
)paren
op_plus
l_int|1
suffix:semicolon
op_star
id|block_size
op_assign
id|be32_to_cpu
c_func
(paren
op_star
(paren
(paren
id|__be32
op_star
)paren
op_amp
id|buf-&gt;block_size
(braket
l_int|0
)braket
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* read capacity command failed */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;cciss: read capacity failed&bslash;n&quot;
)paren
suffix:semicolon
op_star
id|total_size
op_assign
l_int|0
suffix:semicolon
op_star
id|block_size
op_assign
id|BLOCK_SIZE
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;      blocks= %u block_size= %d&bslash;n&quot;
comma
op_star
id|total_size
comma
op_star
id|block_size
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|register_new_disk
r_static
r_int
id|register_new_disk
c_func
(paren
id|ctlr_info_t
op_star
id|h
)paren
(brace
r_struct
id|gendisk
op_star
id|disk
suffix:semicolon
r_int
id|ctlr
op_assign
id|h-&gt;ctlr
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|num_luns
suffix:semicolon
r_int
id|logvol
suffix:semicolon
r_int
id|new_lun_found
op_assign
l_int|0
suffix:semicolon
r_int
id|new_lun_index
op_assign
l_int|0
suffix:semicolon
r_int
id|free_index_found
op_assign
l_int|0
suffix:semicolon
r_int
id|free_index
op_assign
l_int|0
suffix:semicolon
id|ReportLunData_struct
op_star
id|ld_buff
op_assign
l_int|NULL
suffix:semicolon
id|ReadCapdata_struct
op_star
id|size_buff
op_assign
l_int|NULL
suffix:semicolon
id|InquiryData_struct
op_star
id|inq_buff
op_assign
l_int|NULL
suffix:semicolon
r_int
id|return_code
suffix:semicolon
r_int
id|listlength
op_assign
l_int|0
suffix:semicolon
id|__u32
id|lunid
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|block_size
suffix:semicolon
r_int
r_int
id|total_size
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_RAWIO
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
multiline_comment|/* if we have no space in our disk array left to add anything */
r_if
c_cond
(paren
id|h-&gt;num_luns
op_ge
id|CISS_MAX_LUN
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|ld_buff
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|ReportLunData_struct
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ld_buff
op_eq
l_int|NULL
)paren
r_goto
id|mem_msg
suffix:semicolon
id|memset
c_func
(paren
id|ld_buff
comma
l_int|0
comma
r_sizeof
(paren
id|ReportLunData_struct
)paren
)paren
suffix:semicolon
id|size_buff
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|ReadCapdata_struct
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|size_buff
op_eq
l_int|NULL
)paren
r_goto
id|mem_msg
suffix:semicolon
id|inq_buff
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|InquiryData_struct
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inq_buff
op_eq
l_int|NULL
)paren
r_goto
id|mem_msg
suffix:semicolon
id|return_code
op_assign
id|sendcmd_withirq
c_func
(paren
id|CISS_REPORT_LOG
comma
id|ctlr
comma
id|ld_buff
comma
r_sizeof
(paren
id|ReportLunData_struct
)paren
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
id|TYPE_CMD
)paren
suffix:semicolon
r_if
c_cond
(paren
id|return_code
op_eq
id|IO_OK
)paren
(brace
singleline_comment|// printk(&quot;LUN Data&bslash;n--------------------------&bslash;n&quot;);
id|listlength
op_or_assign
(paren
l_int|0xff
op_amp
(paren
r_int
r_int
)paren
(paren
id|ld_buff-&gt;LUNListLength
(braket
l_int|0
)braket
)paren
)paren
op_lshift
l_int|24
suffix:semicolon
id|listlength
op_or_assign
(paren
l_int|0xff
op_amp
(paren
r_int
r_int
)paren
(paren
id|ld_buff-&gt;LUNListLength
(braket
l_int|1
)braket
)paren
)paren
op_lshift
l_int|16
suffix:semicolon
id|listlength
op_or_assign
(paren
l_int|0xff
op_amp
(paren
r_int
r_int
)paren
(paren
id|ld_buff-&gt;LUNListLength
(braket
l_int|2
)braket
)paren
)paren
op_lshift
l_int|8
suffix:semicolon
id|listlength
op_or_assign
l_int|0xff
op_amp
(paren
r_int
r_int
)paren
(paren
id|ld_buff-&gt;LUNListLength
(braket
l_int|3
)braket
)paren
suffix:semicolon
)brace
r_else
multiline_comment|/* reading number of logical volumes failed */
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;cciss: report logical volume&quot;
l_string|&quot; command failed&bslash;n&quot;
)paren
suffix:semicolon
id|listlength
op_assign
l_int|0
suffix:semicolon
r_goto
id|free_err
suffix:semicolon
)brace
id|num_luns
op_assign
id|listlength
op_div
l_int|8
suffix:semicolon
singleline_comment|// 8 bytes pre entry
r_if
c_cond
(paren
id|num_luns
OG
id|CISS_MAX_LUN
)paren
(brace
id|num_luns
op_assign
id|CISS_MAX_LUN
suffix:semicolon
)brace
macro_line|#ifdef CCISS_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Length = %x %x %x %x = %d&bslash;n&quot;
comma
id|ld_buff-&gt;LUNListLength
(braket
l_int|0
)braket
comma
id|ld_buff-&gt;LUNListLength
(braket
l_int|1
)braket
comma
id|ld_buff-&gt;LUNListLength
(braket
l_int|2
)braket
comma
id|ld_buff-&gt;LUNListLength
(braket
l_int|3
)braket
comma
id|num_luns
)paren
suffix:semicolon
macro_line|#endif 
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_luns
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
id|j
suffix:semicolon
r_int
id|lunID_found
op_assign
l_int|0
suffix:semicolon
id|lunid
op_assign
(paren
l_int|0xff
op_amp
(paren
r_int
r_int
)paren
(paren
id|ld_buff-&gt;LUN
(braket
id|i
)braket
(braket
l_int|3
)braket
)paren
)paren
op_lshift
l_int|24
suffix:semicolon
id|lunid
op_or_assign
(paren
l_int|0xff
op_amp
(paren
r_int
r_int
)paren
(paren
id|ld_buff-&gt;LUN
(braket
id|i
)braket
(braket
l_int|2
)braket
)paren
)paren
op_lshift
l_int|16
suffix:semicolon
id|lunid
op_or_assign
(paren
l_int|0xff
op_amp
(paren
r_int
r_int
)paren
(paren
id|ld_buff-&gt;LUN
(braket
id|i
)braket
(braket
l_int|1
)braket
)paren
)paren
op_lshift
l_int|8
suffix:semicolon
id|lunid
op_or_assign
l_int|0xff
op_amp
(paren
r_int
r_int
)paren
(paren
id|ld_buff-&gt;LUN
(braket
id|i
)braket
(braket
l_int|0
)braket
)paren
suffix:semicolon
multiline_comment|/* check to see if this is a new lun */
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
op_le
id|h-&gt;highest_lun
suffix:semicolon
id|j
op_increment
)paren
(brace
macro_line|#ifdef CCISS_DEBUG
id|printk
c_func
(paren
l_string|&quot;Checking %d %x against %x&bslash;n&quot;
comma
id|j
comma
id|h-&gt;drv
(braket
id|j
)braket
dot
id|LunID
comma
id|lunid
)paren
suffix:semicolon
macro_line|#endif /* CCISS_DEBUG */
r_if
c_cond
(paren
id|h-&gt;drv
(braket
id|j
)braket
dot
id|LunID
op_eq
id|lunid
)paren
(brace
id|lunID_found
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|lunID_found
op_eq
l_int|1
)paren
(brace
r_continue
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* It is the new lun we have been looking for */
macro_line|#ifdef CCISS_DEBUG
id|printk
c_func
(paren
l_string|&quot;new lun found at %d&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
macro_line|#endif /* CCISS_DEBUG */
id|new_lun_index
op_assign
id|i
suffix:semicolon
id|new_lun_found
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|new_lun_found
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;cciss:  New Logical Volume not found&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|free_err
suffix:semicolon
)brace
multiline_comment|/* Now find the free index &t;*/
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|CISS_MAX_LUN
suffix:semicolon
id|i
op_increment
)paren
(brace
macro_line|#ifdef CCISS_DEBUG
id|printk
c_func
(paren
l_string|&quot;Checking Index %d&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
macro_line|#endif /* CCISS_DEBUG */
r_if
c_cond
(paren
id|h-&gt;drv
(braket
id|i
)braket
dot
id|LunID
op_eq
l_int|0
)paren
(brace
macro_line|#ifdef CCISS_DEBUG
id|printk
c_func
(paren
l_string|&quot;free index found at %d&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
macro_line|#endif /* CCISS_DEBUG */
id|free_index_found
op_assign
l_int|1
suffix:semicolon
id|free_index
op_assign
id|i
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|free_index_found
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;cciss: unable to find free slot for disk&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|free_err
suffix:semicolon
)brace
id|logvol
op_assign
id|free_index
suffix:semicolon
id|h-&gt;drv
(braket
id|logvol
)braket
dot
id|LunID
op_assign
id|lunid
suffix:semicolon
multiline_comment|/* there could be gaps in lun numbers, track hightest */
r_if
c_cond
(paren
id|h-&gt;highest_lun
OL
id|lunid
)paren
(brace
id|h-&gt;highest_lun
op_assign
id|logvol
suffix:semicolon
)brace
id|cciss_read_capacity
c_func
(paren
id|ctlr
comma
id|logvol
comma
id|size_buff
comma
l_int|1
comma
op_amp
id|total_size
comma
op_amp
id|block_size
)paren
suffix:semicolon
id|cciss_geometry_inquiry
c_func
(paren
id|ctlr
comma
id|logvol
comma
l_int|1
comma
id|total_size
comma
id|block_size
comma
id|inq_buff
comma
op_amp
id|h-&gt;drv
(braket
id|logvol
)braket
)paren
suffix:semicolon
id|h-&gt;drv
(braket
id|logvol
)braket
dot
id|usage_count
op_assign
l_int|0
suffix:semicolon
op_increment
id|h-&gt;num_luns
suffix:semicolon
multiline_comment|/* setup partitions per disk */
id|disk
op_assign
id|h-&gt;gendisk
(braket
id|logvol
)braket
suffix:semicolon
id|set_capacity
c_func
(paren
id|disk
comma
id|h-&gt;drv
(braket
id|logvol
)braket
dot
id|nr_blocks
)paren
suffix:semicolon
multiline_comment|/* if it&squot;s the controller it&squot;s already added */
r_if
c_cond
(paren
id|logvol
)paren
(brace
id|add_disk
c_func
(paren
id|disk
)paren
suffix:semicolon
)brace
id|freeret
suffix:colon
id|kfree
c_func
(paren
id|ld_buff
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|size_buff
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|inq_buff
)paren
suffix:semicolon
r_return
(paren
id|logvol
)paren
suffix:semicolon
id|mem_msg
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;cciss: out of memory&bslash;n&quot;
)paren
suffix:semicolon
id|free_err
suffix:colon
id|logvol
op_assign
op_minus
l_int|1
suffix:semicolon
r_goto
id|freeret
suffix:semicolon
)brace
DECL|function|cciss_revalidate
r_static
r_int
id|cciss_revalidate
c_func
(paren
r_struct
id|gendisk
op_star
id|disk
)paren
(brace
id|ctlr_info_t
op_star
id|h
op_assign
id|get_host
c_func
(paren
id|disk
)paren
suffix:semicolon
id|drive_info_struct
op_star
id|drv
op_assign
id|get_drv
c_func
(paren
id|disk
)paren
suffix:semicolon
r_int
id|logvol
suffix:semicolon
r_int
id|FOUND
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|block_size
suffix:semicolon
r_int
r_int
id|total_size
suffix:semicolon
id|ReadCapdata_struct
op_star
id|size_buff
op_assign
l_int|NULL
suffix:semicolon
id|InquiryData_struct
op_star
id|inq_buff
op_assign
l_int|NULL
suffix:semicolon
r_for
c_loop
(paren
id|logvol
op_assign
l_int|0
suffix:semicolon
id|logvol
OL
id|CISS_MAX_LUN
suffix:semicolon
id|logvol
op_increment
)paren
(brace
r_if
c_cond
(paren
id|h-&gt;drv
(braket
id|logvol
)braket
dot
id|LunID
op_eq
id|drv-&gt;LunID
)paren
(brace
id|FOUND
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|FOUND
)paren
r_return
l_int|1
suffix:semicolon
id|size_buff
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|ReadCapdata_struct
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|size_buff
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;cciss: out of memory&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|inq_buff
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|InquiryData_struct
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inq_buff
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;cciss: out of memory&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|size_buff
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|cciss_read_capacity
c_func
(paren
id|h-&gt;ctlr
comma
id|logvol
comma
id|size_buff
comma
l_int|1
comma
op_amp
id|total_size
comma
op_amp
id|block_size
)paren
suffix:semicolon
id|cciss_geometry_inquiry
c_func
(paren
id|h-&gt;ctlr
comma
id|logvol
comma
l_int|1
comma
id|total_size
comma
id|block_size
comma
id|inq_buff
comma
id|drv
)paren
suffix:semicolon
id|blk_queue_hardsect_size
c_func
(paren
id|h-&gt;queue
comma
id|drv-&gt;block_size
)paren
suffix:semicolon
id|set_capacity
c_func
(paren
id|disk
comma
id|drv-&gt;nr_blocks
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|size_buff
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|inq_buff
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *   Wait polling for a command to complete.&n; *   The memory mapped FIFO is polled for the completion.&n; *   Used only at init time, interrupts from the HBA are disabled.&n; */
DECL|function|pollcomplete
r_static
r_int
r_int
id|pollcomplete
c_func
(paren
r_int
id|ctlr
)paren
(brace
r_int
r_int
id|done
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* Wait (up to 20 seconds) for a command to complete */
r_for
c_loop
(paren
id|i
op_assign
l_int|20
op_star
id|HZ
suffix:semicolon
id|i
OG
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
id|done
op_assign
id|hba
(braket
id|ctlr
)braket
op_member_access_from_pointer
id|access
dot
id|command_completed
c_func
(paren
id|hba
(braket
id|ctlr
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|done
op_eq
id|FIFO_EMPTY
)paren
(brace
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_else
r_return
(paren
id|done
)paren
suffix:semicolon
)brace
multiline_comment|/* Invalid address to tell caller we ran out of time */
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; * Send a command to the controller, and wait for it to complete.  &n; * Only used at init time. &n; */
DECL|function|sendcmd
r_static
r_int
id|sendcmd
c_func
(paren
id|__u8
id|cmd
comma
r_int
id|ctlr
comma
r_void
op_star
id|buff
comma
r_int
id|size
comma
r_int
r_int
id|use_unit_num
comma
multiline_comment|/* 0: address the controller,&n;&t;&t;&t;&t;      1: address logical volume log_unit, &n;&t;&t;&t;&t;      2: periph device address is scsi3addr */
r_int
r_int
id|log_unit
comma
id|__u8
id|page_code
comma
r_int
r_char
op_star
id|scsi3addr
comma
r_int
id|cmd_type
)paren
(brace
id|CommandList_struct
op_star
id|c
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
r_int
id|complete
suffix:semicolon
id|ctlr_info_t
op_star
id|info_p
op_assign
id|hba
(braket
id|ctlr
)braket
suffix:semicolon
id|u64bit
id|buff_dma_handle
suffix:semicolon
r_int
id|status
suffix:semicolon
r_if
c_cond
(paren
(paren
id|c
op_assign
id|cmd_alloc
c_func
(paren
id|info_p
comma
l_int|1
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;cciss: unable to get memory&quot;
)paren
suffix:semicolon
r_return
id|IO_ERROR
suffix:semicolon
)brace
id|status
op_assign
id|fill_cmd
c_func
(paren
id|c
comma
id|cmd
comma
id|ctlr
comma
id|buff
comma
id|size
comma
id|use_unit_num
comma
id|log_unit
comma
id|page_code
comma
id|scsi3addr
comma
id|cmd_type
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_ne
id|IO_OK
)paren
(brace
id|cmd_free
c_func
(paren
id|info_p
comma
id|c
comma
l_int|1
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
id|resend_cmd1
suffix:colon
multiline_comment|/*&n;         * Disable interrupt&n;         */
macro_line|#ifdef CCISS_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;cciss: turning intr off&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif /* CCISS_DEBUG */ 
id|info_p-&gt;access
dot
id|set_intr_mask
c_func
(paren
id|info_p
comma
id|CCISS_INTR_OFF
)paren
suffix:semicolon
multiline_comment|/* Make sure there is room in the command FIFO */
multiline_comment|/* Actually it should be completely empty at this time. */
r_for
c_loop
(paren
id|i
op_assign
l_int|200000
suffix:semicolon
id|i
OG
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
multiline_comment|/* if fifo isn&squot;t full go */
r_if
c_cond
(paren
op_logical_neg
(paren
id|info_p-&gt;access
dot
id|fifo_full
c_func
(paren
id|info_p
)paren
)paren
)paren
(brace
r_break
suffix:semicolon
)brace
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;cciss cciss%d: SendCmd FIFO full,&quot;
l_string|&quot; waiting!&bslash;n&quot;
comma
id|ctlr
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;         * Send the cmd&n;         */
id|info_p-&gt;access
dot
id|submit_command
c_func
(paren
id|info_p
comma
id|c
)paren
suffix:semicolon
id|complete
op_assign
id|pollcomplete
c_func
(paren
id|ctlr
)paren
suffix:semicolon
macro_line|#ifdef CCISS_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;cciss: command completed&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif /* CCISS_DEBUG */
r_if
c_cond
(paren
id|complete
op_ne
l_int|1
)paren
(brace
r_if
c_cond
(paren
(paren
id|complete
op_amp
id|CISS_ERROR_BIT
)paren
op_logical_and
(paren
id|complete
op_amp
op_complement
id|CISS_ERROR_BIT
)paren
op_eq
id|c-&gt;busaddr
)paren
(brace
multiline_comment|/* if data overrun or underun on Report command &n;&t;&t;&t;&t;ignore it &n;&t;&t;&t;*/
r_if
c_cond
(paren
(paren
(paren
id|c-&gt;Request.CDB
(braket
l_int|0
)braket
op_eq
id|CISS_REPORT_LOG
)paren
op_logical_or
(paren
id|c-&gt;Request.CDB
(braket
l_int|0
)braket
op_eq
id|CISS_REPORT_PHYS
)paren
op_logical_or
(paren
id|c-&gt;Request.CDB
(braket
l_int|0
)braket
op_eq
id|CISS_INQUIRY
)paren
)paren
op_logical_and
(paren
(paren
id|c-&gt;err_info-&gt;CommandStatus
op_eq
id|CMD_DATA_OVERRUN
)paren
op_logical_or
(paren
id|c-&gt;err_info-&gt;CommandStatus
op_eq
id|CMD_DATA_UNDERRUN
)paren
)paren
)paren
(brace
id|complete
op_assign
id|c-&gt;busaddr
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|c-&gt;err_info-&gt;CommandStatus
op_eq
id|CMD_UNSOLICITED_ABORT
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;cciss%d: &quot;
l_string|&quot;unsolicited abort %p&bslash;n&quot;
comma
id|ctlr
comma
id|c
)paren
suffix:semicolon
r_if
c_cond
(paren
id|c-&gt;retry_count
OL
id|MAX_CMD_RETRIES
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;cciss%d: retrying %p&bslash;n&quot;
comma
id|ctlr
comma
id|c
)paren
suffix:semicolon
id|c-&gt;retry_count
op_increment
suffix:semicolon
multiline_comment|/* erase the old error */
multiline_comment|/* information */
id|memset
c_func
(paren
id|c-&gt;err_info
comma
l_int|0
comma
r_sizeof
(paren
id|ErrorInfo_struct
)paren
)paren
suffix:semicolon
r_goto
id|resend_cmd1
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;cciss%d: retried %p too &quot;
l_string|&quot;many times&bslash;n&quot;
comma
id|ctlr
comma
id|c
)paren
suffix:semicolon
id|status
op_assign
id|IO_ERROR
suffix:semicolon
r_goto
id|cleanup1
suffix:semicolon
)brace
)brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;ciss ciss%d: sendcmd&quot;
l_string|&quot; Error %x &bslash;n&quot;
comma
id|ctlr
comma
id|c-&gt;err_info-&gt;CommandStatus
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;ciss ciss%d: sendcmd&quot;
l_string|&quot; offensive info&bslash;n&quot;
l_string|&quot;  size %x&bslash;n   num %x   value %x&bslash;n&quot;
comma
id|ctlr
comma
id|c-&gt;err_info-&gt;MoreErrInfo.Invalid_Cmd.offense_size
comma
id|c-&gt;err_info-&gt;MoreErrInfo.Invalid_Cmd.offense_num
comma
id|c-&gt;err_info-&gt;MoreErrInfo.Invalid_Cmd.offense_value
)paren
suffix:semicolon
id|status
op_assign
id|IO_ERROR
suffix:semicolon
r_goto
id|cleanup1
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|complete
op_ne
id|c-&gt;busaddr
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;cciss cciss%d: SendCmd &quot;
l_string|&quot;Invalid command list address returned! (%lx)&bslash;n&quot;
comma
id|ctlr
comma
id|complete
)paren
suffix:semicolon
id|status
op_assign
id|IO_ERROR
suffix:semicolon
r_goto
id|cleanup1
suffix:semicolon
)brace
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;cciss cciss%d: SendCmd Timeout out, &quot;
l_string|&quot;No command list address returned!&bslash;n&quot;
comma
id|ctlr
)paren
suffix:semicolon
id|status
op_assign
id|IO_ERROR
suffix:semicolon
)brace
id|cleanup1
suffix:colon
multiline_comment|/* unlock the data buffer from DMA */
id|pci_unmap_single
c_func
(paren
id|info_p-&gt;pdev
comma
(paren
id|dma_addr_t
)paren
id|buff_dma_handle.val
comma
id|size
comma
id|PCI_DMA_BIDIRECTIONAL
)paren
suffix:semicolon
id|cmd_free
c_func
(paren
id|info_p
comma
id|c
comma
l_int|1
)paren
suffix:semicolon
r_return
(paren
id|status
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Map (physical) PCI mem into (virtual) kernel space&n; */
DECL|function|remap_pci_mem
r_static
r_void
id|__iomem
op_star
id|remap_pci_mem
c_func
(paren
id|ulong
id|base
comma
id|ulong
id|size
)paren
(brace
id|ulong
id|page_base
op_assign
(paren
(paren
id|ulong
)paren
id|base
)paren
op_amp
id|PAGE_MASK
suffix:semicolon
id|ulong
id|page_offs
op_assign
(paren
(paren
id|ulong
)paren
id|base
)paren
op_minus
id|page_base
suffix:semicolon
r_void
id|__iomem
op_star
id|page_remapped
op_assign
id|ioremap
c_func
(paren
id|page_base
comma
id|page_offs
op_plus
id|size
)paren
suffix:semicolon
r_return
id|page_remapped
ques
c_cond
(paren
id|page_remapped
op_plus
id|page_offs
)paren
suffix:colon
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* &n; * Takes jobs of the Q and sends them to the hardware, then puts it on &n; * the Q to wait for completion. &n; */
DECL|function|start_io
r_static
r_void
id|start_io
c_func
(paren
id|ctlr_info_t
op_star
id|h
)paren
(brace
id|CommandList_struct
op_star
id|c
suffix:semicolon
r_while
c_loop
(paren
(paren
id|c
op_assign
id|h-&gt;reqQ
)paren
op_ne
l_int|NULL
)paren
(brace
multiline_comment|/* can&squot;t do anything if fifo is full */
r_if
c_cond
(paren
(paren
id|h-&gt;access
dot
id|fifo_full
c_func
(paren
id|h
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;cciss: fifo full&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* Get the frist entry from the Request Q */
id|removeQ
c_func
(paren
op_amp
(paren
id|h-&gt;reqQ
)paren
comma
id|c
)paren
suffix:semicolon
id|h-&gt;Qdepth
op_decrement
suffix:semicolon
multiline_comment|/* Tell the controller execute command */
id|h-&gt;access
dot
id|submit_command
c_func
(paren
id|h
comma
id|c
)paren
suffix:semicolon
multiline_comment|/* Put job onto the completed Q */
id|addQ
(paren
op_amp
(paren
id|h-&gt;cmpQ
)paren
comma
id|c
)paren
suffix:semicolon
)brace
)brace
DECL|function|complete_buffers
r_static
r_inline
r_void
id|complete_buffers
c_func
(paren
r_struct
id|bio
op_star
id|bio
comma
r_int
id|status
)paren
(brace
r_while
c_loop
(paren
id|bio
)paren
(brace
r_struct
id|bio
op_star
id|xbh
op_assign
id|bio-&gt;bi_next
suffix:semicolon
r_int
id|nr_sectors
op_assign
id|bio_sectors
c_func
(paren
id|bio
)paren
suffix:semicolon
id|bio-&gt;bi_next
op_assign
l_int|NULL
suffix:semicolon
id|blk_finished_io
c_func
(paren
id|len
)paren
suffix:semicolon
id|bio_endio
c_func
(paren
id|bio
comma
id|nr_sectors
op_lshift
l_int|9
comma
id|status
ques
c_cond
l_int|0
suffix:colon
op_minus
id|EIO
)paren
suffix:semicolon
id|bio
op_assign
id|xbh
suffix:semicolon
)brace
)brace
multiline_comment|/* Assumes that CCISS_LOCK(h-&gt;ctlr) is held. */
multiline_comment|/* Zeros out the error record and then resends the command back */
multiline_comment|/* to the controller */
DECL|function|resend_cciss_cmd
r_static
r_inline
r_void
id|resend_cciss_cmd
c_func
(paren
id|ctlr_info_t
op_star
id|h
comma
id|CommandList_struct
op_star
id|c
)paren
(brace
multiline_comment|/* erase the old error information */
id|memset
c_func
(paren
id|c-&gt;err_info
comma
l_int|0
comma
r_sizeof
(paren
id|ErrorInfo_struct
)paren
)paren
suffix:semicolon
multiline_comment|/* add it to software queue and then send it to the controller */
id|addQ
c_func
(paren
op_amp
(paren
id|h-&gt;reqQ
)paren
comma
id|c
)paren
suffix:semicolon
id|h-&gt;Qdepth
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|h-&gt;Qdepth
OG
id|h-&gt;maxQsinceinit
)paren
(brace
id|h-&gt;maxQsinceinit
op_assign
id|h-&gt;Qdepth
suffix:semicolon
)brace
id|start_io
c_func
(paren
id|h
)paren
suffix:semicolon
)brace
multiline_comment|/* checks the status of the job and calls complete buffers to mark all &n; * buffers for the completed job. &n; */
DECL|function|complete_command
r_static
r_inline
r_void
id|complete_command
c_func
(paren
id|ctlr_info_t
op_star
id|h
comma
id|CommandList_struct
op_star
id|cmd
comma
r_int
id|timeout
)paren
(brace
r_int
id|status
op_assign
l_int|1
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|retry_cmd
op_assign
l_int|0
suffix:semicolon
id|u64bit
id|temp64
suffix:semicolon
r_if
c_cond
(paren
id|timeout
)paren
id|status
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|cmd-&gt;err_info-&gt;CommandStatus
op_ne
l_int|0
)paren
(brace
multiline_comment|/* an error has occurred */
r_switch
c_cond
(paren
id|cmd-&gt;err_info-&gt;CommandStatus
)paren
(brace
r_int
r_char
id|sense_key
suffix:semicolon
r_case
id|CMD_TARGET_STATUS
suffix:colon
id|status
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|cmd-&gt;err_info-&gt;ScsiStatus
op_eq
l_int|0x02
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;cciss: cmd %p &quot;
l_string|&quot;has CHECK CONDITION &quot;
l_string|&quot; byte 2 = 0x%x&bslash;n&quot;
comma
id|cmd
comma
id|cmd-&gt;err_info-&gt;SenseInfo
(braket
l_int|2
)braket
)paren
suffix:semicolon
multiline_comment|/* check the sense key */
id|sense_key
op_assign
l_int|0xf
op_amp
id|cmd-&gt;err_info-&gt;SenseInfo
(braket
l_int|2
)braket
suffix:semicolon
multiline_comment|/* no status or recovered error */
r_if
c_cond
(paren
(paren
id|sense_key
op_eq
l_int|0x0
)paren
op_logical_or
(paren
id|sense_key
op_eq
l_int|0x1
)paren
)paren
(brace
id|status
op_assign
l_int|1
suffix:semicolon
)brace
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;cciss: cmd %p &quot;
l_string|&quot;has SCSI Status 0x%x&bslash;n&quot;
comma
id|cmd
comma
id|cmd-&gt;err_info-&gt;ScsiStatus
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|CMD_DATA_UNDERRUN
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;cciss: cmd %p has&quot;
l_string|&quot; completed with data underrun &quot;
l_string|&quot;reported&bslash;n&quot;
comma
id|cmd
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CMD_DATA_OVERRUN
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;cciss: cmd %p has&quot;
l_string|&quot; completed with data overrun &quot;
l_string|&quot;reported&bslash;n&quot;
comma
id|cmd
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CMD_INVALID
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;cciss: cmd %p is &quot;
l_string|&quot;reported invalid&bslash;n&quot;
comma
id|cmd
)paren
suffix:semicolon
id|status
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CMD_PROTOCOL_ERR
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;cciss: cmd %p has &quot;
l_string|&quot;protocol error &bslash;n&quot;
comma
id|cmd
)paren
suffix:semicolon
id|status
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CMD_HARDWARE_ERR
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;cciss: cmd %p had &quot;
l_string|&quot; hardware error&bslash;n&quot;
comma
id|cmd
)paren
suffix:semicolon
id|status
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CMD_CONNECTION_LOST
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;cciss: cmd %p had &quot;
l_string|&quot;connection lost&bslash;n&quot;
comma
id|cmd
)paren
suffix:semicolon
id|status
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CMD_ABORTED
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;cciss: cmd %p was &quot;
l_string|&quot;aborted&bslash;n&quot;
comma
id|cmd
)paren
suffix:semicolon
id|status
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CMD_ABORT_FAILED
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;cciss: cmd %p reports &quot;
l_string|&quot;abort failed&bslash;n&quot;
comma
id|cmd
)paren
suffix:semicolon
id|status
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CMD_UNSOLICITED_ABORT
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;cciss%d: unsolicited &quot;
l_string|&quot;abort %p&bslash;n&quot;
comma
id|h-&gt;ctlr
comma
id|cmd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmd-&gt;retry_count
OL
id|MAX_CMD_RETRIES
)paren
(brace
id|retry_cmd
op_assign
l_int|1
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;cciss%d: retrying %p&bslash;n&quot;
comma
id|h-&gt;ctlr
comma
id|cmd
)paren
suffix:semicolon
id|cmd-&gt;retry_count
op_increment
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;cciss%d: %p retried too &quot;
l_string|&quot;many times&bslash;n&quot;
comma
id|h-&gt;ctlr
comma
id|cmd
)paren
suffix:semicolon
id|status
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CMD_TIMEOUT
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;cciss: cmd %p timedout&bslash;n&quot;
comma
id|cmd
)paren
suffix:semicolon
id|status
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;cciss: cmd %p returned &quot;
l_string|&quot;unknown status %x&bslash;n&quot;
comma
id|cmd
comma
id|cmd-&gt;err_info-&gt;CommandStatus
)paren
suffix:semicolon
id|status
op_assign
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/* We need to return this command */
r_if
c_cond
(paren
id|retry_cmd
)paren
(brace
id|resend_cciss_cmd
c_func
(paren
id|h
comma
id|cmd
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* command did not need to be retried */
multiline_comment|/* unmap the DMA mapping for all the scatter gather elements */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|cmd-&gt;Header.SGList
suffix:semicolon
id|i
op_increment
)paren
(brace
id|temp64.val32.lower
op_assign
id|cmd-&gt;SG
(braket
id|i
)braket
dot
id|Addr.lower
suffix:semicolon
id|temp64.val32.upper
op_assign
id|cmd-&gt;SG
(braket
id|i
)braket
dot
id|Addr.upper
suffix:semicolon
id|pci_unmap_page
c_func
(paren
id|hba
(braket
id|cmd-&gt;ctlr
)braket
op_member_access_from_pointer
id|pdev
comma
id|temp64.val
comma
id|cmd-&gt;SG
(braket
id|i
)braket
dot
id|Len
comma
(paren
id|cmd-&gt;Request.Type.Direction
op_eq
id|XFER_READ
)paren
ques
c_cond
id|PCI_DMA_FROMDEVICE
suffix:colon
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
)brace
id|complete_buffers
c_func
(paren
id|cmd-&gt;rq-&gt;bio
comma
id|status
)paren
suffix:semicolon
macro_line|#ifdef CCISS_DEBUG
id|printk
c_func
(paren
l_string|&quot;Done with %p&bslash;n&quot;
comma
id|cmd-&gt;rq
)paren
suffix:semicolon
macro_line|#endif /* CCISS_DEBUG */ 
id|end_that_request_last
c_func
(paren
id|cmd-&gt;rq
)paren
suffix:semicolon
id|cmd_free
c_func
(paren
id|h
comma
id|cmd
comma
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/* &n; * Get a request and submit it to the controller. &n; */
DECL|function|do_cciss_request
r_static
r_void
id|do_cciss_request
c_func
(paren
id|request_queue_t
op_star
id|q
)paren
(brace
id|ctlr_info_t
op_star
id|h
op_assign
id|q-&gt;queuedata
suffix:semicolon
id|CommandList_struct
op_star
id|c
suffix:semicolon
r_int
id|start_blk
comma
id|seg
suffix:semicolon
r_struct
id|request
op_star
id|creq
suffix:semicolon
id|u64bit
id|temp64
suffix:semicolon
r_struct
id|scatterlist
id|tmp_sg
(braket
id|MAXSGENTRIES
)braket
suffix:semicolon
id|drive_info_struct
op_star
id|drv
suffix:semicolon
r_int
id|i
comma
id|dir
suffix:semicolon
r_if
c_cond
(paren
id|blk_queue_plugged
c_func
(paren
id|q
)paren
)paren
r_goto
id|startio
suffix:semicolon
id|queue
suffix:colon
id|creq
op_assign
id|elv_next_request
c_func
(paren
id|q
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|creq
)paren
r_goto
id|startio
suffix:semicolon
r_if
c_cond
(paren
id|creq-&gt;nr_phys_segments
OG
id|MAXSGENTRIES
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|c
op_assign
id|cmd_alloc
c_func
(paren
id|h
comma
l_int|1
)paren
)paren
op_eq
l_int|NULL
)paren
r_goto
id|full
suffix:semicolon
id|blkdev_dequeue_request
c_func
(paren
id|creq
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
id|q-&gt;queue_lock
)paren
suffix:semicolon
id|c-&gt;cmd_type
op_assign
id|CMD_RWREQ
suffix:semicolon
id|c-&gt;rq
op_assign
id|creq
suffix:semicolon
multiline_comment|/* fill in the request */
id|drv
op_assign
id|creq-&gt;rq_disk-&gt;private_data
suffix:semicolon
id|c-&gt;Header.ReplyQueue
op_assign
l_int|0
suffix:semicolon
singleline_comment|// unused in simple mode
id|c-&gt;Header.Tag.lower
op_assign
id|c-&gt;busaddr
suffix:semicolon
singleline_comment|// use the physical address the cmd block for tag
id|c-&gt;Header.LUN.LogDev.VolId
op_assign
id|drv-&gt;LunID
suffix:semicolon
id|c-&gt;Header.LUN.LogDev.Mode
op_assign
l_int|1
suffix:semicolon
id|c-&gt;Request.CDBLen
op_assign
l_int|10
suffix:semicolon
singleline_comment|// 12 byte commands not in FW yet;
id|c-&gt;Request.Type.Type
op_assign
id|TYPE_CMD
suffix:semicolon
singleline_comment|// It is a command. 
id|c-&gt;Request.Type.Attribute
op_assign
id|ATTR_SIMPLE
suffix:semicolon
id|c-&gt;Request.Type.Direction
op_assign
(paren
id|rq_data_dir
c_func
(paren
id|creq
)paren
op_eq
id|READ
)paren
ques
c_cond
id|XFER_READ
suffix:colon
id|XFER_WRITE
suffix:semicolon
id|c-&gt;Request.Timeout
op_assign
l_int|0
suffix:semicolon
singleline_comment|// Don&squot;t time out&t;
id|c-&gt;Request.CDB
(braket
l_int|0
)braket
op_assign
(paren
id|rq_data_dir
c_func
(paren
id|creq
)paren
op_eq
id|READ
)paren
ques
c_cond
id|CCISS_READ
suffix:colon
id|CCISS_WRITE
suffix:semicolon
id|start_blk
op_assign
id|creq-&gt;sector
suffix:semicolon
macro_line|#ifdef CCISS_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;ciss: sector =%d nr_sectors=%d&bslash;n&quot;
comma
(paren
r_int
)paren
id|creq-&gt;sector
comma
(paren
r_int
)paren
id|creq-&gt;nr_sectors
)paren
suffix:semicolon
macro_line|#endif /* CCISS_DEBUG */
id|seg
op_assign
id|blk_rq_map_sg
c_func
(paren
id|q
comma
id|creq
comma
id|tmp_sg
)paren
suffix:semicolon
multiline_comment|/* get the DMA records for the setup */
r_if
c_cond
(paren
id|c-&gt;Request.Type.Direction
op_eq
id|XFER_READ
)paren
id|dir
op_assign
id|PCI_DMA_FROMDEVICE
suffix:semicolon
r_else
id|dir
op_assign
id|PCI_DMA_TODEVICE
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|seg
suffix:semicolon
id|i
op_increment
)paren
(brace
id|c-&gt;SG
(braket
id|i
)braket
dot
id|Len
op_assign
id|tmp_sg
(braket
id|i
)braket
dot
id|length
suffix:semicolon
id|temp64.val
op_assign
(paren
id|__u64
)paren
id|pci_map_page
c_func
(paren
id|h-&gt;pdev
comma
id|tmp_sg
(braket
id|i
)braket
dot
id|page
comma
id|tmp_sg
(braket
id|i
)braket
dot
id|offset
comma
id|tmp_sg
(braket
id|i
)braket
dot
id|length
comma
id|dir
)paren
suffix:semicolon
id|c-&gt;SG
(braket
id|i
)braket
dot
id|Addr.lower
op_assign
id|temp64.val32.lower
suffix:semicolon
id|c-&gt;SG
(braket
id|i
)braket
dot
id|Addr.upper
op_assign
id|temp64.val32.upper
suffix:semicolon
id|c-&gt;SG
(braket
id|i
)braket
dot
id|Ext
op_assign
l_int|0
suffix:semicolon
singleline_comment|// we are not chaining
)brace
multiline_comment|/* track how many SG entries we are using */
r_if
c_cond
(paren
id|seg
OG
id|h-&gt;maxSG
)paren
(brace
id|h-&gt;maxSG
op_assign
id|seg
suffix:semicolon
)brace
macro_line|#ifdef CCISS_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;cciss: Submitting %d sectors in %d segments&bslash;n&quot;
comma
id|creq-&gt;nr_sectors
comma
id|seg
)paren
suffix:semicolon
macro_line|#endif /* CCISS_DEBUG */
id|c-&gt;Header.SGList
op_assign
id|c-&gt;Header.SGTotal
op_assign
id|seg
suffix:semicolon
id|c-&gt;Request.CDB
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|c-&gt;Request.CDB
(braket
l_int|2
)braket
op_assign
(paren
id|start_blk
op_rshift
l_int|24
)paren
op_amp
l_int|0xff
suffix:semicolon
singleline_comment|//MSB
id|c-&gt;Request.CDB
(braket
l_int|3
)braket
op_assign
(paren
id|start_blk
op_rshift
l_int|16
)paren
op_amp
l_int|0xff
suffix:semicolon
id|c-&gt;Request.CDB
(braket
l_int|4
)braket
op_assign
(paren
id|start_blk
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
id|c-&gt;Request.CDB
(braket
l_int|5
)braket
op_assign
id|start_blk
op_amp
l_int|0xff
suffix:semicolon
id|c-&gt;Request.CDB
(braket
l_int|6
)braket
op_assign
l_int|0
suffix:semicolon
singleline_comment|// (sect &gt;&gt; 24) &amp; 0xff; MSB
id|c-&gt;Request.CDB
(braket
l_int|7
)braket
op_assign
(paren
id|creq-&gt;nr_sectors
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
id|c-&gt;Request.CDB
(braket
l_int|8
)braket
op_assign
id|creq-&gt;nr_sectors
op_amp
l_int|0xff
suffix:semicolon
id|c-&gt;Request.CDB
(braket
l_int|9
)braket
op_assign
id|c-&gt;Request.CDB
(braket
l_int|11
)braket
op_assign
id|c-&gt;Request.CDB
(braket
l_int|12
)braket
op_assign
l_int|0
suffix:semicolon
id|spin_lock_irq
c_func
(paren
id|q-&gt;queue_lock
)paren
suffix:semicolon
id|addQ
c_func
(paren
op_amp
(paren
id|h-&gt;reqQ
)paren
comma
id|c
)paren
suffix:semicolon
id|h-&gt;Qdepth
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|h-&gt;Qdepth
OG
id|h-&gt;maxQsinceinit
)paren
(brace
id|h-&gt;maxQsinceinit
op_assign
id|h-&gt;Qdepth
suffix:semicolon
)brace
r_goto
id|queue
suffix:semicolon
id|full
suffix:colon
id|blk_stop_queue
c_func
(paren
id|q
)paren
suffix:semicolon
id|startio
suffix:colon
id|start_io
c_func
(paren
id|h
)paren
suffix:semicolon
)brace
DECL|function|do_cciss_intr
r_static
id|irqreturn_t
id|do_cciss_intr
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|ctlr_info_t
op_star
id|h
op_assign
id|dev_id
suffix:semicolon
id|CommandList_struct
op_star
id|c
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|__u32
id|a
comma
id|a1
suffix:semicolon
multiline_comment|/* Is this interrupt for us? */
r_if
c_cond
(paren
(paren
id|h-&gt;access
dot
id|intr_pending
c_func
(paren
id|h
)paren
op_eq
l_int|0
)paren
op_logical_or
(paren
id|h-&gt;interrupts_enabled
op_eq
l_int|0
)paren
)paren
r_return
id|IRQ_NONE
suffix:semicolon
multiline_comment|/*&n;&t; * If there are completed commands in the completion queue,&n;&t; * we had better do something about it.&n;&t; */
id|spin_lock_irqsave
c_func
(paren
id|CCISS_LOCK
c_func
(paren
id|h-&gt;ctlr
)paren
comma
id|flags
)paren
suffix:semicolon
r_while
c_loop
(paren
id|h-&gt;access
dot
id|intr_pending
c_func
(paren
id|h
)paren
)paren
(brace
r_while
c_loop
(paren
(paren
id|a
op_assign
id|h-&gt;access
dot
id|command_completed
c_func
(paren
id|h
)paren
)paren
op_ne
id|FIFO_EMPTY
)paren
(brace
id|a1
op_assign
id|a
suffix:semicolon
id|a
op_and_assign
op_complement
l_int|3
suffix:semicolon
r_if
c_cond
(paren
(paren
id|c
op_assign
id|h-&gt;cmpQ
)paren
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;cciss: Completion of %08lx ignored&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|a1
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_while
c_loop
(paren
id|c-&gt;busaddr
op_ne
id|a
)paren
(brace
id|c
op_assign
id|c-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|c
op_eq
id|h-&gt;cmpQ
)paren
r_break
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t;&t; * If we&squot;ve found the command, take it off the&n;&t;&t;&t; * completion Q and free it&n;&t;&t;&t; */
r_if
c_cond
(paren
id|c-&gt;busaddr
op_eq
id|a
)paren
(brace
id|removeQ
c_func
(paren
op_amp
id|h-&gt;cmpQ
comma
id|c
)paren
suffix:semicolon
r_if
c_cond
(paren
id|c-&gt;cmd_type
op_eq
id|CMD_RWREQ
)paren
(brace
id|complete_command
c_func
(paren
id|h
comma
id|c
comma
l_int|0
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|c-&gt;cmd_type
op_eq
id|CMD_IOCTL_PEND
)paren
(brace
id|complete
c_func
(paren
id|c-&gt;waiting
)paren
suffix:semicolon
)brace
macro_line|#&t;&t;&t;&t;ifdef CONFIG_CISS_SCSI_TAPE
r_else
r_if
c_cond
(paren
id|c-&gt;cmd_type
op_eq
id|CMD_SCSI
)paren
id|complete_scsi_command
c_func
(paren
id|c
comma
l_int|0
comma
id|a1
)paren
suffix:semicolon
macro_line|#&t;&t;&t;&t;endif
r_continue
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*&n;&t; * See if we can queue up some more IO&n;&t; */
id|blk_start_queue
c_func
(paren
id|h-&gt;queue
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
id|CCISS_LOCK
c_func
(paren
id|h-&gt;ctlr
)paren
comma
id|flags
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
multiline_comment|/* &n; *  We cannot read the structure directly, for portablity we must use &n; *   the io functions.&n; *   This is for debug only. &n; */
macro_line|#ifdef CCISS_DEBUG
DECL|function|print_cfg_table
r_static
r_void
id|print_cfg_table
c_func
(paren
id|CfgTable_struct
op_star
id|tb
)paren
(brace
r_int
id|i
suffix:semicolon
r_char
id|temp_name
(braket
l_int|17
)braket
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Controller Configuration information&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;------------------------------------&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
id|temp_name
(braket
id|i
)braket
op_assign
id|readb
c_func
(paren
op_amp
(paren
id|tb-&gt;Signature
(braket
id|i
)braket
)paren
)paren
suffix:semicolon
)brace
id|temp_name
(braket
l_int|4
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;   Signature = %s&bslash;n&quot;
comma
id|temp_name
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;   Spec Number = %d&bslash;n&quot;
comma
id|readl
c_func
(paren
op_amp
(paren
id|tb-&gt;SpecValence
)paren
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;   Transport methods supported = 0x%x&bslash;n&quot;
comma
id|readl
c_func
(paren
op_amp
(paren
id|tb
op_member_access_from_pointer
id|TransportSupport
)paren
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;   Transport methods active = 0x%x&bslash;n&quot;
comma
id|readl
c_func
(paren
op_amp
(paren
id|tb-&gt;TransportActive
)paren
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;   Requested transport Method = 0x%x&bslash;n&quot;
comma
id|readl
c_func
(paren
op_amp
(paren
id|tb-&gt;HostWrite.TransportRequest
)paren
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;   Coalese Interrupt Delay = 0x%x&bslash;n&quot;
comma
id|readl
c_func
(paren
op_amp
(paren
id|tb-&gt;HostWrite.CoalIntDelay
)paren
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;   Coalese Interrupt Count = 0x%x&bslash;n&quot;
comma
id|readl
c_func
(paren
op_amp
(paren
id|tb-&gt;HostWrite.CoalIntCount
)paren
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;   Max outstanding commands = 0x%d&bslash;n&quot;
comma
id|readl
c_func
(paren
op_amp
(paren
id|tb-&gt;CmdsOutMax
)paren
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;   Bus Types = 0x%x&bslash;n&quot;
comma
id|readl
c_func
(paren
op_amp
(paren
id|tb
op_member_access_from_pointer
id|BusTypes
)paren
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
id|temp_name
(braket
id|i
)braket
op_assign
id|readb
c_func
(paren
op_amp
(paren
id|tb-&gt;ServerName
(braket
id|i
)braket
)paren
)paren
suffix:semicolon
)brace
id|temp_name
(braket
l_int|16
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;   Server Name = %s&bslash;n&quot;
comma
id|temp_name
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;   Heartbeat Counter = 0x%x&bslash;n&bslash;n&bslash;n&quot;
comma
id|readl
c_func
(paren
op_amp
(paren
id|tb-&gt;HeartBeat
)paren
)paren
)paren
suffix:semicolon
)brace
macro_line|#endif /* CCISS_DEBUG */ 
DECL|function|release_io_mem
r_static
r_void
id|release_io_mem
c_func
(paren
id|ctlr_info_t
op_star
id|c
)paren
(brace
multiline_comment|/* if IO mem was not protected do nothing */
r_if
c_cond
(paren
id|c-&gt;io_mem_addr
op_eq
l_int|0
)paren
(brace
r_return
suffix:semicolon
)brace
id|release_region
c_func
(paren
id|c-&gt;io_mem_addr
comma
id|c-&gt;io_mem_length
)paren
suffix:semicolon
id|c-&gt;io_mem_addr
op_assign
l_int|0
suffix:semicolon
id|c-&gt;io_mem_length
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|find_PCI_BAR_index
r_static
r_int
id|find_PCI_BAR_index
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_int
r_int
id|pci_bar_addr
)paren
(brace
r_int
id|i
comma
id|offset
comma
id|mem_type
comma
id|bar_type
suffix:semicolon
r_if
c_cond
(paren
id|pci_bar_addr
op_eq
id|PCI_BASE_ADDRESS_0
)paren
multiline_comment|/* looking for BAR zero? */
r_return
l_int|0
suffix:semicolon
id|offset
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|DEVICE_COUNT_RESOURCE
suffix:semicolon
id|i
op_increment
)paren
(brace
id|bar_type
op_assign
id|pci_resource_flags
c_func
(paren
id|pdev
comma
id|i
)paren
op_amp
id|PCI_BASE_ADDRESS_SPACE
suffix:semicolon
r_if
c_cond
(paren
id|bar_type
op_eq
id|PCI_BASE_ADDRESS_SPACE_IO
)paren
id|offset
op_add_assign
l_int|4
suffix:semicolon
r_else
(brace
id|mem_type
op_assign
id|pci_resource_flags
c_func
(paren
id|pdev
comma
id|i
)paren
op_amp
id|PCI_BASE_ADDRESS_MEM_TYPE_MASK
suffix:semicolon
r_switch
c_cond
(paren
id|mem_type
)paren
(brace
r_case
id|PCI_BASE_ADDRESS_MEM_TYPE_32
suffix:colon
r_case
id|PCI_BASE_ADDRESS_MEM_TYPE_1M
suffix:colon
id|offset
op_add_assign
l_int|4
suffix:semicolon
multiline_comment|/* 32 bit */
r_break
suffix:semicolon
r_case
id|PCI_BASE_ADDRESS_MEM_TYPE_64
suffix:colon
id|offset
op_add_assign
l_int|8
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* reserved in PCI 2.2 */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Base address is invalid&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|offset
op_eq
id|pci_bar_addr
op_minus
id|PCI_BASE_ADDRESS_0
)paren
r_return
id|i
op_plus
l_int|1
suffix:semicolon
)brace
r_return
op_minus
l_int|1
suffix:semicolon
)brace
DECL|function|cciss_pci_init
r_static
r_int
id|cciss_pci_init
c_func
(paren
id|ctlr_info_t
op_star
id|c
comma
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
id|ushort
id|subsystem_vendor_id
comma
id|subsystem_device_id
comma
id|command
suffix:semicolon
id|__u32
id|board_id
comma
id|scratchpad
op_assign
l_int|0
suffix:semicolon
id|__u64
id|cfg_offset
suffix:semicolon
id|__u32
id|cfg_base_addr
suffix:semicolon
id|__u64
id|cfg_base_addr_index
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* check to see if controller has been disabled */
multiline_comment|/* BEFORE trying to enable it */
(paren
r_void
)paren
id|pci_read_config_word
c_func
(paren
id|pdev
comma
id|PCI_COMMAND
comma
op_amp
id|command
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|command
op_amp
l_int|0x02
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;cciss: controller appears to be disabled&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pci_enable_device
c_func
(paren
id|pdev
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;cciss: Unable to Enable PCI device&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pci_set_dma_mask
c_func
(paren
id|pdev
comma
id|CCISS_DMA_MASK
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;cciss:  Unable to set DMA mask&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|subsystem_vendor_id
op_assign
id|pdev-&gt;subsystem_vendor
suffix:semicolon
id|subsystem_device_id
op_assign
id|pdev-&gt;subsystem_device
suffix:semicolon
id|board_id
op_assign
(paren
(paren
(paren
id|__u32
)paren
(paren
id|subsystem_device_id
op_lshift
l_int|16
)paren
op_amp
l_int|0xffff0000
)paren
op_or
id|subsystem_vendor_id
)paren
suffix:semicolon
multiline_comment|/* search for our IO range so we can protect it */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|DEVICE_COUNT_RESOURCE
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* is this an IO range */
r_if
c_cond
(paren
id|pci_resource_flags
c_func
(paren
id|pdev
comma
id|i
)paren
op_amp
l_int|0x01
)paren
(brace
id|c-&gt;io_mem_addr
op_assign
id|pci_resource_start
c_func
(paren
id|pdev
comma
id|i
)paren
suffix:semicolon
id|c-&gt;io_mem_length
op_assign
id|pci_resource_end
c_func
(paren
id|pdev
comma
id|i
)paren
op_minus
id|pci_resource_start
c_func
(paren
id|pdev
comma
id|i
)paren
op_plus
l_int|1
suffix:semicolon
macro_line|#ifdef CCISS_DEBUG
id|printk
c_func
(paren
l_string|&quot;IO value found base_addr[%d] %lx %lx&bslash;n&quot;
comma
id|i
comma
id|c-&gt;io_mem_addr
comma
id|c-&gt;io_mem_length
)paren
suffix:semicolon
macro_line|#endif /* CCISS_DEBUG */
multiline_comment|/* register the IO range */
r_if
c_cond
(paren
op_logical_neg
id|request_region
c_func
(paren
id|c-&gt;io_mem_addr
comma
id|c-&gt;io_mem_length
comma
l_string|&quot;cciss&quot;
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;cciss I/O memory range already in use addr=%lx length=%ld&bslash;n&quot;
comma
id|c-&gt;io_mem_addr
comma
id|c-&gt;io_mem_length
)paren
suffix:semicolon
id|c-&gt;io_mem_addr
op_assign
l_int|0
suffix:semicolon
id|c-&gt;io_mem_length
op_assign
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
)brace
macro_line|#ifdef CCISS_DEBUG
id|printk
c_func
(paren
l_string|&quot;command = %x&bslash;n&quot;
comma
id|command
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;irq = %x&bslash;n&quot;
comma
id|pdev-&gt;irq
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;board_id = %x&bslash;n&quot;
comma
id|board_id
)paren
suffix:semicolon
macro_line|#endif /* CCISS_DEBUG */ 
id|c-&gt;intr
op_assign
id|pdev-&gt;irq
suffix:semicolon
multiline_comment|/*&n;&t; * Memory base addr is first addr , the second points to the config&n;         *   table&n;&t; */
id|c-&gt;paddr
op_assign
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* addressing mode bits already removed */
macro_line|#ifdef CCISS_DEBUG
id|printk
c_func
(paren
l_string|&quot;address 0 = %x&bslash;n&quot;
comma
id|c-&gt;paddr
)paren
suffix:semicolon
macro_line|#endif /* CCISS_DEBUG */ 
id|c-&gt;vaddr
op_assign
id|remap_pci_mem
c_func
(paren
id|c-&gt;paddr
comma
l_int|200
)paren
suffix:semicolon
multiline_comment|/* Wait for the board to become ready.  (PCI hotplug needs this.)&n;&t; * We poll for up to 120 secs, once per 100ms. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|1200
suffix:semicolon
id|i
op_increment
)paren
(brace
id|scratchpad
op_assign
id|readl
c_func
(paren
id|c-&gt;vaddr
op_plus
id|SA5_SCRATCHPAD_OFFSET
)paren
suffix:semicolon
r_if
c_cond
(paren
id|scratchpad
op_eq
id|CCISS_FIRMWARE_READY
)paren
r_break
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|HZ
op_div
l_int|10
)paren
suffix:semicolon
multiline_comment|/* wait 100ms */
)brace
r_if
c_cond
(paren
id|scratchpad
op_ne
id|CCISS_FIRMWARE_READY
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;cciss: Board not ready.  Timed out.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* get the address index number */
id|cfg_base_addr
op_assign
id|readl
c_func
(paren
id|c-&gt;vaddr
op_plus
id|SA5_CTCFG_OFFSET
)paren
suffix:semicolon
id|cfg_base_addr
op_and_assign
(paren
id|__u32
)paren
l_int|0x0000ffff
suffix:semicolon
macro_line|#ifdef CCISS_DEBUG
id|printk
c_func
(paren
l_string|&quot;cfg base address = %x&bslash;n&quot;
comma
id|cfg_base_addr
)paren
suffix:semicolon
macro_line|#endif /* CCISS_DEBUG */
id|cfg_base_addr_index
op_assign
id|find_PCI_BAR_index
c_func
(paren
id|pdev
comma
id|cfg_base_addr
)paren
suffix:semicolon
macro_line|#ifdef CCISS_DEBUG
id|printk
c_func
(paren
l_string|&quot;cfg base address index = %x&bslash;n&quot;
comma
id|cfg_base_addr_index
)paren
suffix:semicolon
macro_line|#endif /* CCISS_DEBUG */
r_if
c_cond
(paren
id|cfg_base_addr_index
op_eq
op_minus
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;cciss: Cannot find cfg_base_addr_index&bslash;n&quot;
)paren
suffix:semicolon
id|release_io_mem
c_func
(paren
id|c
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|cfg_offset
op_assign
id|readl
c_func
(paren
id|c-&gt;vaddr
op_plus
id|SA5_CTMEM_OFFSET
)paren
suffix:semicolon
macro_line|#ifdef CCISS_DEBUG
id|printk
c_func
(paren
l_string|&quot;cfg offset = %x&bslash;n&quot;
comma
id|cfg_offset
)paren
suffix:semicolon
macro_line|#endif /* CCISS_DEBUG */
id|c-&gt;cfgtable
op_assign
id|remap_pci_mem
c_func
(paren
id|pci_resource_start
c_func
(paren
id|pdev
comma
id|cfg_base_addr_index
)paren
op_plus
id|cfg_offset
comma
r_sizeof
(paren
id|CfgTable_struct
)paren
)paren
suffix:semicolon
id|c-&gt;board_id
op_assign
id|board_id
suffix:semicolon
macro_line|#ifdef CCISS_DEBUG
id|print_cfg_table
c_func
(paren
id|c-&gt;cfgtable
)paren
suffix:semicolon
macro_line|#endif /* CCISS_DEBUG */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_PRODUCTS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|board_id
op_eq
id|products
(braket
id|i
)braket
dot
id|board_id
)paren
(brace
id|c-&gt;product_name
op_assign
id|products
(braket
id|i
)braket
dot
id|product_name
suffix:semicolon
id|c-&gt;access
op_assign
op_star
(paren
id|products
(braket
id|i
)braket
dot
id|access
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|i
op_eq
id|NR_PRODUCTS
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;cciss: Sorry, I don&squot;t know how&quot;
l_string|&quot; to access the Smart Array controller %08lx&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|board_id
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|readb
c_func
(paren
op_amp
id|c-&gt;cfgtable-&gt;Signature
(braket
l_int|0
)braket
)paren
op_ne
l_char|&squot;C&squot;
)paren
op_logical_or
(paren
id|readb
c_func
(paren
op_amp
id|c-&gt;cfgtable-&gt;Signature
(braket
l_int|1
)braket
)paren
op_ne
l_char|&squot;I&squot;
)paren
op_logical_or
(paren
id|readb
c_func
(paren
op_amp
id|c-&gt;cfgtable-&gt;Signature
(braket
l_int|2
)braket
)paren
op_ne
l_char|&squot;S&squot;
)paren
op_logical_or
(paren
id|readb
c_func
(paren
op_amp
id|c-&gt;cfgtable-&gt;Signature
(braket
l_int|3
)braket
)paren
op_ne
l_char|&squot;S&squot;
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Does not appear to be a valid CISS config table&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_X86
(brace
multiline_comment|/* Need to enable prefetch in the SCSI core for 6400 in x86 */
id|__u32
id|prefetch
suffix:semicolon
id|prefetch
op_assign
id|readl
c_func
(paren
op_amp
(paren
id|c-&gt;cfgtable-&gt;SCSI_Prefetch
)paren
)paren
suffix:semicolon
id|prefetch
op_or_assign
l_int|0x100
suffix:semicolon
id|writel
c_func
(paren
id|prefetch
comma
op_amp
(paren
id|c-&gt;cfgtable-&gt;SCSI_Prefetch
)paren
)paren
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifdef CCISS_DEBUG
id|printk
c_func
(paren
l_string|&quot;Trying to put board into Simple mode&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif /* CCISS_DEBUG */ 
id|c-&gt;max_commands
op_assign
id|readl
c_func
(paren
op_amp
(paren
id|c-&gt;cfgtable-&gt;CmdsOutMax
)paren
)paren
suffix:semicolon
multiline_comment|/* Update the field, and then ring the doorbell */
id|writel
c_func
(paren
id|CFGTBL_Trans_Simple
comma
op_amp
(paren
id|c-&gt;cfgtable-&gt;HostWrite.TransportRequest
)paren
)paren
suffix:semicolon
id|writel
c_func
(paren
id|CFGTBL_ChangeReq
comma
id|c-&gt;vaddr
op_plus
id|SA5_DOORBELL
)paren
suffix:semicolon
multiline_comment|/* under certain very rare conditions, this can take awhile.&n;&t; * (e.g.: hot replace a failed 144GB drive in a RAID 5 set right&n;&t; * as we enter this code.) */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_CONFIG_WAIT
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|readl
c_func
(paren
id|c-&gt;vaddr
op_plus
id|SA5_DOORBELL
)paren
op_amp
id|CFGTBL_ChangeReq
)paren
)paren
r_break
suffix:semicolon
multiline_comment|/* delay and try again */
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
macro_line|#ifdef CCISS_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;I counter got to %d %x&bslash;n&quot;
comma
id|i
comma
id|readl
c_func
(paren
id|c-&gt;vaddr
op_plus
id|SA5_DOORBELL
)paren
)paren
suffix:semicolon
macro_line|#endif /* CCISS_DEBUG */
macro_line|#ifdef CCISS_DEBUG
id|print_cfg_table
c_func
(paren
id|c-&gt;cfgtable
)paren
suffix:semicolon
macro_line|#endif /* CCISS_DEBUG */ 
r_if
c_cond
(paren
op_logical_neg
(paren
id|readl
c_func
(paren
op_amp
(paren
id|c-&gt;cfgtable-&gt;TransportActive
)paren
)paren
op_amp
id|CFGTBL_Trans_Simple
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;cciss: unable to get board into&quot;
l_string|&quot; simple mode&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* &n; * Gets information about the local volumes attached to the controller. &n; */
DECL|function|cciss_getgeometry
r_static
r_void
id|cciss_getgeometry
c_func
(paren
r_int
id|cntl_num
)paren
(brace
id|ReportLunData_struct
op_star
id|ld_buff
suffix:semicolon
id|ReadCapdata_struct
op_star
id|size_buff
suffix:semicolon
id|InquiryData_struct
op_star
id|inq_buff
suffix:semicolon
r_int
id|return_code
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|listlength
op_assign
l_int|0
suffix:semicolon
id|__u32
id|lunid
op_assign
l_int|0
suffix:semicolon
r_int
id|block_size
suffix:semicolon
r_int
id|total_size
suffix:semicolon
id|ld_buff
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|ReportLunData_struct
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ld_buff
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;cciss: out of memory&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|memset
c_func
(paren
id|ld_buff
comma
l_int|0
comma
r_sizeof
(paren
id|ReportLunData_struct
)paren
)paren
suffix:semicolon
id|size_buff
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|ReadCapdata_struct
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|size_buff
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;cciss: out of memory&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|ld_buff
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|inq_buff
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|InquiryData_struct
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inq_buff
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;cciss: out of memory&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|ld_buff
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|size_buff
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Get the firmware version */
id|return_code
op_assign
id|sendcmd
c_func
(paren
id|CISS_INQUIRY
comma
id|cntl_num
comma
id|inq_buff
comma
r_sizeof
(paren
id|InquiryData_struct
)paren
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
comma
id|TYPE_CMD
)paren
suffix:semicolon
r_if
c_cond
(paren
id|return_code
op_eq
id|IO_OK
)paren
(brace
id|hba
(braket
id|cntl_num
)braket
op_member_access_from_pointer
id|firm_ver
(braket
l_int|0
)braket
op_assign
id|inq_buff-&gt;data_byte
(braket
l_int|32
)braket
suffix:semicolon
id|hba
(braket
id|cntl_num
)braket
op_member_access_from_pointer
id|firm_ver
(braket
l_int|1
)braket
op_assign
id|inq_buff-&gt;data_byte
(braket
l_int|33
)braket
suffix:semicolon
id|hba
(braket
id|cntl_num
)braket
op_member_access_from_pointer
id|firm_ver
(braket
l_int|2
)braket
op_assign
id|inq_buff-&gt;data_byte
(braket
l_int|34
)braket
suffix:semicolon
id|hba
(braket
id|cntl_num
)braket
op_member_access_from_pointer
id|firm_ver
(braket
l_int|3
)braket
op_assign
id|inq_buff-&gt;data_byte
(braket
l_int|35
)braket
suffix:semicolon
)brace
r_else
multiline_comment|/* send command failed */
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;cciss: unable to determine firmware&quot;
l_string|&quot; version of controller&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* Get the number of logical volumes */
id|return_code
op_assign
id|sendcmd
c_func
(paren
id|CISS_REPORT_LOG
comma
id|cntl_num
comma
id|ld_buff
comma
r_sizeof
(paren
id|ReportLunData_struct
)paren
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
comma
id|TYPE_CMD
)paren
suffix:semicolon
r_if
c_cond
(paren
id|return_code
op_eq
id|IO_OK
)paren
(brace
macro_line|#ifdef CCISS_DEBUG
id|printk
c_func
(paren
l_string|&quot;LUN Data&bslash;n--------------------------&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif /* CCISS_DEBUG */ 
id|listlength
op_or_assign
(paren
l_int|0xff
op_amp
(paren
r_int
r_int
)paren
(paren
id|ld_buff-&gt;LUNListLength
(braket
l_int|0
)braket
)paren
)paren
op_lshift
l_int|24
suffix:semicolon
id|listlength
op_or_assign
(paren
l_int|0xff
op_amp
(paren
r_int
r_int
)paren
(paren
id|ld_buff-&gt;LUNListLength
(braket
l_int|1
)braket
)paren
)paren
op_lshift
l_int|16
suffix:semicolon
id|listlength
op_or_assign
(paren
l_int|0xff
op_amp
(paren
r_int
r_int
)paren
(paren
id|ld_buff-&gt;LUNListLength
(braket
l_int|2
)braket
)paren
)paren
op_lshift
l_int|8
suffix:semicolon
id|listlength
op_or_assign
l_int|0xff
op_amp
(paren
r_int
r_int
)paren
(paren
id|ld_buff-&gt;LUNListLength
(braket
l_int|3
)braket
)paren
suffix:semicolon
)brace
r_else
multiline_comment|/* reading number of logical volumes failed */
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;cciss: report logical volume&quot;
l_string|&quot; command failed&bslash;n&quot;
)paren
suffix:semicolon
id|listlength
op_assign
l_int|0
suffix:semicolon
)brace
id|hba
(braket
id|cntl_num
)braket
op_member_access_from_pointer
id|num_luns
op_assign
id|listlength
op_div
l_int|8
suffix:semicolon
singleline_comment|// 8 bytes pre entry
r_if
c_cond
(paren
id|hba
(braket
id|cntl_num
)braket
op_member_access_from_pointer
id|num_luns
OG
id|CISS_MAX_LUN
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ciss:  only %d number of logical volumes supported&bslash;n&quot;
comma
id|CISS_MAX_LUN
)paren
suffix:semicolon
id|hba
(braket
id|cntl_num
)braket
op_member_access_from_pointer
id|num_luns
op_assign
id|CISS_MAX_LUN
suffix:semicolon
)brace
macro_line|#ifdef CCISS_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Length = %x %x %x %x = %d&bslash;n&quot;
comma
id|ld_buff-&gt;LUNListLength
(braket
l_int|0
)braket
comma
id|ld_buff-&gt;LUNListLength
(braket
l_int|1
)braket
comma
id|ld_buff-&gt;LUNListLength
(braket
l_int|2
)braket
comma
id|ld_buff-&gt;LUNListLength
(braket
l_int|3
)braket
comma
id|hba
(braket
id|cntl_num
)braket
op_member_access_from_pointer
id|num_luns
)paren
suffix:semicolon
macro_line|#endif /* CCISS_DEBUG */
id|hba
(braket
id|cntl_num
)braket
op_member_access_from_pointer
id|highest_lun
op_assign
id|hba
(braket
id|cntl_num
)braket
op_member_access_from_pointer
id|num_luns
op_minus
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|hba
(braket
id|cntl_num
)braket
op_member_access_from_pointer
id|num_luns
suffix:semicolon
id|i
op_increment
)paren
(brace
id|lunid
op_assign
(paren
l_int|0xff
op_amp
(paren
r_int
r_int
)paren
(paren
id|ld_buff-&gt;LUN
(braket
id|i
)braket
(braket
l_int|3
)braket
)paren
)paren
op_lshift
l_int|24
suffix:semicolon
id|lunid
op_or_assign
(paren
l_int|0xff
op_amp
(paren
r_int
r_int
)paren
(paren
id|ld_buff-&gt;LUN
(braket
id|i
)braket
(braket
l_int|2
)braket
)paren
)paren
op_lshift
l_int|16
suffix:semicolon
id|lunid
op_or_assign
(paren
l_int|0xff
op_amp
(paren
r_int
r_int
)paren
(paren
id|ld_buff-&gt;LUN
(braket
id|i
)braket
(braket
l_int|1
)braket
)paren
)paren
op_lshift
l_int|8
suffix:semicolon
id|lunid
op_or_assign
l_int|0xff
op_amp
(paren
r_int
r_int
)paren
(paren
id|ld_buff-&gt;LUN
(braket
id|i
)braket
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|hba
(braket
id|cntl_num
)braket
op_member_access_from_pointer
id|drv
(braket
id|i
)braket
dot
id|LunID
op_assign
id|lunid
suffix:semicolon
macro_line|#ifdef CCISS_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;LUN[%d]:  %x %x %x %x = %x&bslash;n&quot;
comma
id|i
comma
id|ld_buff-&gt;LUN
(braket
id|i
)braket
(braket
l_int|0
)braket
comma
id|ld_buff-&gt;LUN
(braket
id|i
)braket
(braket
l_int|1
)braket
comma
id|ld_buff-&gt;LUN
(braket
id|i
)braket
(braket
l_int|2
)braket
comma
id|ld_buff-&gt;LUN
(braket
id|i
)braket
(braket
l_int|3
)braket
comma
id|hba
(braket
id|cntl_num
)braket
op_member_access_from_pointer
id|drv
(braket
id|i
)braket
dot
id|LunID
)paren
suffix:semicolon
macro_line|#endif /* CCISS_DEBUG */
id|cciss_read_capacity
c_func
(paren
id|cntl_num
comma
id|i
comma
id|size_buff
comma
l_int|0
comma
op_amp
id|total_size
comma
op_amp
id|block_size
)paren
suffix:semicolon
id|cciss_geometry_inquiry
c_func
(paren
id|cntl_num
comma
id|i
comma
l_int|0
comma
id|total_size
comma
id|block_size
comma
id|inq_buff
comma
op_amp
id|hba
(braket
id|cntl_num
)braket
op_member_access_from_pointer
id|drv
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|ld_buff
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|size_buff
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|inq_buff
)paren
suffix:semicolon
)brace
multiline_comment|/* Function to find the first free pointer into our hba[] array */
multiline_comment|/* Returns -1 if no free entries are left.  */
DECL|function|alloc_cciss_hba
r_static
r_int
id|alloc_cciss_hba
c_func
(paren
r_void
)paren
(brace
r_struct
id|gendisk
op_star
id|disk
(braket
id|NWD
)braket
suffix:semicolon
r_int
id|i
comma
id|n
suffix:semicolon
r_for
c_loop
(paren
id|n
op_assign
l_int|0
suffix:semicolon
id|n
OL
id|NWD
suffix:semicolon
id|n
op_increment
)paren
(brace
id|disk
(braket
id|n
)braket
op_assign
id|alloc_disk
c_func
(paren
l_int|1
op_lshift
id|NWD_SHIFT
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|disk
(braket
id|n
)braket
)paren
r_goto
id|out
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_CTLR
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|hba
(braket
id|i
)braket
)paren
(brace
id|ctlr_info_t
op_star
id|p
suffix:semicolon
id|p
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|ctlr_info_t
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|p
)paren
r_goto
id|Enomem
suffix:semicolon
id|memset
c_func
(paren
id|p
comma
l_int|0
comma
r_sizeof
(paren
id|ctlr_info_t
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|n
op_assign
l_int|0
suffix:semicolon
id|n
OL
id|NWD
suffix:semicolon
id|n
op_increment
)paren
id|p-&gt;gendisk
(braket
id|n
)braket
op_assign
id|disk
(braket
id|n
)braket
suffix:semicolon
id|hba
(braket
id|i
)braket
op_assign
id|p
suffix:semicolon
r_return
id|i
suffix:semicolon
)brace
)brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;cciss: This driver supports a maximum&quot;
l_string|&quot; of 8 controllers.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
id|Enomem
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;cciss: out of memory.&bslash;n&quot;
)paren
suffix:semicolon
id|out
suffix:colon
r_while
c_loop
(paren
id|n
op_decrement
)paren
id|put_disk
c_func
(paren
id|disk
(braket
id|n
)braket
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
DECL|function|free_hba
r_static
r_void
id|free_hba
c_func
(paren
r_int
id|i
)paren
(brace
id|ctlr_info_t
op_star
id|p
op_assign
id|hba
(braket
id|i
)braket
suffix:semicolon
r_int
id|n
suffix:semicolon
id|hba
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
r_for
c_loop
(paren
id|n
op_assign
l_int|0
suffix:semicolon
id|n
OL
id|NWD
suffix:semicolon
id|n
op_increment
)paren
id|put_disk
c_func
(paren
id|p-&gt;gendisk
(braket
id|n
)braket
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|p
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *  This is it.  Find all the controllers and register them.  I really hate&n; *  stealing all these major device numbers.&n; *  returns the number of block devices registered.&n; */
DECL|function|cciss_init_one
r_static
r_int
id|__devinit
id|cciss_init_one
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_const
r_struct
id|pci_device_id
op_star
id|ent
)paren
(brace
id|request_queue_t
op_star
id|q
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|j
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;cciss: Device 0x%x has been found at&quot;
l_string|&quot; bus %d dev %d func %d&bslash;n&quot;
comma
id|pdev-&gt;device
comma
id|pdev-&gt;bus-&gt;number
comma
id|PCI_SLOT
c_func
(paren
id|pdev-&gt;devfn
)paren
comma
id|PCI_FUNC
c_func
(paren
id|pdev-&gt;devfn
)paren
)paren
suffix:semicolon
id|i
op_assign
id|alloc_cciss_hba
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
(brace
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cciss_pci_init
c_func
(paren
id|hba
(braket
id|i
)braket
comma
id|pdev
)paren
op_ne
l_int|0
)paren
r_goto
id|clean1
suffix:semicolon
id|sprintf
c_func
(paren
id|hba
(braket
id|i
)braket
op_member_access_from_pointer
id|devname
comma
l_string|&quot;cciss%d&quot;
comma
id|i
)paren
suffix:semicolon
id|hba
(braket
id|i
)braket
op_member_access_from_pointer
id|ctlr
op_assign
id|i
suffix:semicolon
id|hba
(braket
id|i
)braket
op_member_access_from_pointer
id|pdev
op_assign
id|pdev
suffix:semicolon
multiline_comment|/* configure PCI DMA stuff */
r_if
c_cond
(paren
op_logical_neg
id|pci_set_dma_mask
c_func
(paren
id|pdev
comma
l_int|0xffffffffffffffffULL
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;cciss: using DAC cycles&bslash;n&quot;
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|pci_set_dma_mask
c_func
(paren
id|pdev
comma
l_int|0xffffffff
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;cciss: not using DAC cycles&bslash;n&quot;
)paren
suffix:semicolon
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;cciss: no suitable DMA available&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|clean1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|register_blkdev
c_func
(paren
id|COMPAQ_CISS_MAJOR
op_plus
id|i
comma
id|hba
(braket
id|i
)braket
op_member_access_from_pointer
id|devname
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;cciss: Unable to register device %s&bslash;n&quot;
comma
id|hba
(braket
id|i
)braket
op_member_access_from_pointer
id|devname
)paren
suffix:semicolon
r_goto
id|clean1
suffix:semicolon
)brace
multiline_comment|/* make sure the board interrupts are off */
id|hba
(braket
id|i
)braket
op_member_access_from_pointer
id|access
dot
id|set_intr_mask
c_func
(paren
id|hba
(braket
id|i
)braket
comma
id|CCISS_INTR_OFF
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|hba
(braket
id|i
)braket
op_member_access_from_pointer
id|intr
comma
id|do_cciss_intr
comma
id|SA_INTERRUPT
op_or
id|SA_SHIRQ
op_or
id|SA_SAMPLE_RANDOM
comma
id|hba
(braket
id|i
)braket
op_member_access_from_pointer
id|devname
comma
id|hba
(braket
id|i
)braket
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;cciss: Unable to get irq %d for %s&bslash;n&quot;
comma
id|hba
(braket
id|i
)braket
op_member_access_from_pointer
id|intr
comma
id|hba
(braket
id|i
)braket
op_member_access_from_pointer
id|devname
)paren
suffix:semicolon
r_goto
id|clean2
suffix:semicolon
)brace
id|hba
(braket
id|i
)braket
op_member_access_from_pointer
id|cmd_pool_bits
op_assign
id|kmalloc
c_func
(paren
(paren
(paren
id|NR_CMDS
op_plus
id|BITS_PER_LONG
op_minus
l_int|1
)paren
op_div
id|BITS_PER_LONG
)paren
op_star
r_sizeof
(paren
r_int
r_int
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|hba
(braket
id|i
)braket
op_member_access_from_pointer
id|cmd_pool
op_assign
(paren
id|CommandList_struct
op_star
)paren
id|pci_alloc_consistent
c_func
(paren
id|hba
(braket
id|i
)braket
op_member_access_from_pointer
id|pdev
comma
id|NR_CMDS
op_star
r_sizeof
(paren
id|CommandList_struct
)paren
comma
op_amp
(paren
id|hba
(braket
id|i
)braket
op_member_access_from_pointer
id|cmd_pool_dhandle
)paren
)paren
suffix:semicolon
id|hba
(braket
id|i
)braket
op_member_access_from_pointer
id|errinfo_pool
op_assign
(paren
id|ErrorInfo_struct
op_star
)paren
id|pci_alloc_consistent
c_func
(paren
id|hba
(braket
id|i
)braket
op_member_access_from_pointer
id|pdev
comma
id|NR_CMDS
op_star
r_sizeof
(paren
id|ErrorInfo_struct
)paren
comma
op_amp
(paren
id|hba
(braket
id|i
)braket
op_member_access_from_pointer
id|errinfo_pool_dhandle
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|hba
(braket
id|i
)braket
op_member_access_from_pointer
id|cmd_pool_bits
op_eq
l_int|NULL
)paren
op_logical_or
(paren
id|hba
(braket
id|i
)braket
op_member_access_from_pointer
id|cmd_pool
op_eq
l_int|NULL
)paren
op_logical_or
(paren
id|hba
(braket
id|i
)braket
op_member_access_from_pointer
id|errinfo_pool
op_eq
l_int|NULL
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;cciss: out of memory&quot;
)paren
suffix:semicolon
r_goto
id|clean4
suffix:semicolon
)brace
id|spin_lock_init
c_func
(paren
op_amp
id|hba
(braket
id|i
)braket
op_member_access_from_pointer
id|lock
)paren
suffix:semicolon
id|q
op_assign
id|blk_init_queue
c_func
(paren
id|do_cciss_request
comma
op_amp
id|hba
(braket
id|i
)braket
op_member_access_from_pointer
id|lock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|q
)paren
r_goto
id|clean4
suffix:semicolon
id|q-&gt;backing_dev_info.ra_pages
op_assign
id|READ_AHEAD
suffix:semicolon
id|hba
(braket
id|i
)braket
op_member_access_from_pointer
id|queue
op_assign
id|q
suffix:semicolon
id|q-&gt;queuedata
op_assign
id|hba
(braket
id|i
)braket
suffix:semicolon
multiline_comment|/* Initialize the pdev driver private data. &n;&t;&t;have it point to hba[i].  */
id|pci_set_drvdata
c_func
(paren
id|pdev
comma
id|hba
(braket
id|i
)braket
)paren
suffix:semicolon
multiline_comment|/* command and error info recs zeroed out before &n;&t;&t;&t;they are used */
id|memset
c_func
(paren
id|hba
(braket
id|i
)braket
op_member_access_from_pointer
id|cmd_pool_bits
comma
l_int|0
comma
(paren
(paren
id|NR_CMDS
op_plus
id|BITS_PER_LONG
op_minus
l_int|1
)paren
op_div
id|BITS_PER_LONG
)paren
op_star
r_sizeof
(paren
r_int
r_int
)paren
)paren
suffix:semicolon
macro_line|#ifdef CCISS_DEBUG&t;
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Scanning for drives on controller cciss%d&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
macro_line|#endif /* CCISS_DEBUG */
id|cciss_getgeometry
c_func
(paren
id|i
)paren
suffix:semicolon
id|cciss_scsi_setup
c_func
(paren
id|i
)paren
suffix:semicolon
multiline_comment|/* Turn the interrupts on so we can service requests */
id|hba
(braket
id|i
)braket
op_member_access_from_pointer
id|access
dot
id|set_intr_mask
c_func
(paren
id|hba
(braket
id|i
)braket
comma
id|CCISS_INTR_ON
)paren
suffix:semicolon
id|cciss_procinit
c_func
(paren
id|i
)paren
suffix:semicolon
id|blk_queue_bounce_limit
c_func
(paren
id|q
comma
id|hba
(braket
id|i
)braket
op_member_access_from_pointer
id|pdev-&gt;dma_mask
)paren
suffix:semicolon
multiline_comment|/* This is a hardware imposed limit. */
id|blk_queue_max_hw_segments
c_func
(paren
id|q
comma
id|MAXSGENTRIES
)paren
suffix:semicolon
multiline_comment|/* This is a limit in the driver and could be eliminated. */
id|blk_queue_max_phys_segments
c_func
(paren
id|q
comma
id|MAXSGENTRIES
)paren
suffix:semicolon
id|blk_queue_max_sectors
c_func
(paren
id|q
comma
l_int|512
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|NWD
suffix:semicolon
id|j
op_increment
)paren
(brace
id|drive_info_struct
op_star
id|drv
op_assign
op_amp
(paren
id|hba
(braket
id|i
)braket
op_member_access_from_pointer
id|drv
(braket
id|j
)braket
)paren
suffix:semicolon
r_struct
id|gendisk
op_star
id|disk
op_assign
id|hba
(braket
id|i
)braket
op_member_access_from_pointer
id|gendisk
(braket
id|j
)braket
suffix:semicolon
id|sprintf
c_func
(paren
id|disk-&gt;disk_name
comma
l_string|&quot;cciss/c%dd%d&quot;
comma
id|i
comma
id|j
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|disk-&gt;devfs_name
comma
l_string|&quot;cciss/host%d/target%d&quot;
comma
id|i
comma
id|j
)paren
suffix:semicolon
id|disk-&gt;major
op_assign
id|COMPAQ_CISS_MAJOR
op_plus
id|i
suffix:semicolon
id|disk-&gt;first_minor
op_assign
id|j
op_lshift
id|NWD_SHIFT
suffix:semicolon
id|disk-&gt;fops
op_assign
op_amp
id|cciss_fops
suffix:semicolon
id|disk-&gt;queue
op_assign
id|hba
(braket
id|i
)braket
op_member_access_from_pointer
id|queue
suffix:semicolon
id|disk-&gt;private_data
op_assign
id|drv
suffix:semicolon
multiline_comment|/* we must register the controller even if no disks exist */
multiline_comment|/* this is for the online array utilities */
r_if
c_cond
(paren
op_logical_neg
id|drv-&gt;heads
op_logical_and
id|j
)paren
(brace
r_continue
suffix:semicolon
)brace
id|blk_queue_hardsect_size
c_func
(paren
id|hba
(braket
id|i
)braket
op_member_access_from_pointer
id|queue
comma
id|drv-&gt;block_size
)paren
suffix:semicolon
id|set_capacity
c_func
(paren
id|disk
comma
id|drv-&gt;nr_blocks
)paren
suffix:semicolon
id|add_disk
c_func
(paren
id|disk
)paren
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
id|clean4
suffix:colon
r_if
c_cond
(paren
id|hba
(braket
id|i
)braket
op_member_access_from_pointer
id|cmd_pool_bits
)paren
(brace
id|kfree
c_func
(paren
id|hba
(braket
id|i
)braket
op_member_access_from_pointer
id|cmd_pool_bits
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hba
(braket
id|i
)braket
op_member_access_from_pointer
id|cmd_pool
)paren
(brace
id|pci_free_consistent
c_func
(paren
id|hba
(braket
id|i
)braket
op_member_access_from_pointer
id|pdev
comma
id|NR_CMDS
op_star
r_sizeof
(paren
id|CommandList_struct
)paren
comma
id|hba
(braket
id|i
)braket
op_member_access_from_pointer
id|cmd_pool
comma
id|hba
(braket
id|i
)braket
op_member_access_from_pointer
id|cmd_pool_dhandle
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hba
(braket
id|i
)braket
op_member_access_from_pointer
id|errinfo_pool
)paren
(brace
id|pci_free_consistent
c_func
(paren
id|hba
(braket
id|i
)braket
op_member_access_from_pointer
id|pdev
comma
id|NR_CMDS
op_star
r_sizeof
(paren
id|ErrorInfo_struct
)paren
comma
id|hba
(braket
id|i
)braket
op_member_access_from_pointer
id|errinfo_pool
comma
id|hba
(braket
id|i
)braket
op_member_access_from_pointer
id|errinfo_pool_dhandle
)paren
suffix:semicolon
)brace
id|free_irq
c_func
(paren
id|hba
(braket
id|i
)braket
op_member_access_from_pointer
id|intr
comma
id|hba
(braket
id|i
)braket
)paren
suffix:semicolon
id|clean2
suffix:colon
id|unregister_blkdev
c_func
(paren
id|COMPAQ_CISS_MAJOR
op_plus
id|i
comma
id|hba
(braket
id|i
)braket
op_member_access_from_pointer
id|devname
)paren
suffix:semicolon
id|clean1
suffix:colon
id|release_io_mem
c_func
(paren
id|hba
(braket
id|i
)braket
)paren
suffix:semicolon
id|free_hba
c_func
(paren
id|i
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
DECL|function|cciss_remove_one
r_static
r_void
id|__devexit
id|cciss_remove_one
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
id|ctlr_info_t
op_star
id|tmp_ptr
suffix:semicolon
r_int
id|i
comma
id|j
suffix:semicolon
r_char
id|flush_buf
(braket
l_int|4
)braket
suffix:semicolon
r_int
id|return_code
suffix:semicolon
r_if
c_cond
(paren
id|pci_get_drvdata
c_func
(paren
id|pdev
)paren
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;cciss: Unable to remove device &bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|tmp_ptr
op_assign
id|pci_get_drvdata
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|i
op_assign
id|tmp_ptr-&gt;ctlr
suffix:semicolon
r_if
c_cond
(paren
id|hba
(braket
id|i
)braket
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;cciss: device appears to &quot;
l_string|&quot;already be removed &bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Turn board interrupts off  and send the flush cache command */
multiline_comment|/* sendcmd will turn off interrupt, and send the flush...&n;&t;* To write all data in the battery backed cache to disks */
id|memset
c_func
(paren
id|flush_buf
comma
l_int|0
comma
l_int|4
)paren
suffix:semicolon
id|return_code
op_assign
id|sendcmd
c_func
(paren
id|CCISS_CACHE_FLUSH
comma
id|i
comma
id|flush_buf
comma
l_int|4
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
comma
id|TYPE_CMD
)paren
suffix:semicolon
r_if
c_cond
(paren
id|return_code
op_ne
id|IO_OK
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Error Flushing cache on controller %d&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
)brace
id|free_irq
c_func
(paren
id|hba
(braket
id|i
)braket
op_member_access_from_pointer
id|intr
comma
id|hba
(braket
id|i
)braket
)paren
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|pdev
comma
l_int|NULL
)paren
suffix:semicolon
id|iounmap
c_func
(paren
id|hba
(braket
id|i
)braket
op_member_access_from_pointer
id|vaddr
)paren
suffix:semicolon
id|cciss_unregister_scsi
c_func
(paren
id|i
)paren
suffix:semicolon
multiline_comment|/* unhook from SCSI subsystem */
id|unregister_blkdev
c_func
(paren
id|COMPAQ_CISS_MAJOR
op_plus
id|i
comma
id|hba
(braket
id|i
)braket
op_member_access_from_pointer
id|devname
)paren
suffix:semicolon
id|remove_proc_entry
c_func
(paren
id|hba
(braket
id|i
)braket
op_member_access_from_pointer
id|devname
comma
id|proc_cciss
)paren
suffix:semicolon
multiline_comment|/* remove it from the disk list */
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|NWD
suffix:semicolon
id|j
op_increment
)paren
(brace
r_struct
id|gendisk
op_star
id|disk
op_assign
id|hba
(braket
id|i
)braket
op_member_access_from_pointer
id|gendisk
(braket
id|j
)braket
suffix:semicolon
r_if
c_cond
(paren
id|disk-&gt;flags
op_amp
id|GENHD_FL_UP
)paren
id|del_gendisk
c_func
(paren
id|disk
)paren
suffix:semicolon
)brace
id|blk_cleanup_queue
c_func
(paren
id|hba
(braket
id|i
)braket
op_member_access_from_pointer
id|queue
)paren
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|hba
(braket
id|i
)braket
op_member_access_from_pointer
id|pdev
comma
id|NR_CMDS
op_star
r_sizeof
(paren
id|CommandList_struct
)paren
comma
id|hba
(braket
id|i
)braket
op_member_access_from_pointer
id|cmd_pool
comma
id|hba
(braket
id|i
)braket
op_member_access_from_pointer
id|cmd_pool_dhandle
)paren
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|hba
(braket
id|i
)braket
op_member_access_from_pointer
id|pdev
comma
id|NR_CMDS
op_star
r_sizeof
(paren
id|ErrorInfo_struct
)paren
comma
id|hba
(braket
id|i
)braket
op_member_access_from_pointer
id|errinfo_pool
comma
id|hba
(braket
id|i
)braket
op_member_access_from_pointer
id|errinfo_pool_dhandle
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|hba
(braket
id|i
)braket
op_member_access_from_pointer
id|cmd_pool_bits
)paren
suffix:semicolon
id|release_io_mem
c_func
(paren
id|hba
(braket
id|i
)braket
)paren
suffix:semicolon
id|free_hba
c_func
(paren
id|i
)paren
suffix:semicolon
)brace
DECL|variable|cciss_pci_driver
r_static
r_struct
id|pci_driver
id|cciss_pci_driver
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;cciss&quot;
comma
dot
id|probe
op_assign
id|cciss_init_one
comma
dot
id|remove
op_assign
id|__devexit_p
c_func
(paren
id|cciss_remove_one
)paren
comma
dot
id|id_table
op_assign
id|cciss_pci_device_id
comma
multiline_comment|/* id_table */
)brace
suffix:semicolon
multiline_comment|/*&n; *  This is it.  Register the PCI driver information for the cards we control&n; *  the OS will call our registered routines when it finds one of our cards. &n; */
DECL|function|cciss_init
r_int
id|__init
id|cciss_init
c_func
(paren
r_void
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
id|DRIVER_NAME
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Register for our PCI devices */
r_return
id|pci_module_init
c_func
(paren
op_amp
id|cciss_pci_driver
)paren
suffix:semicolon
)brace
DECL|function|init_cciss_module
r_static
r_int
id|__init
id|init_cciss_module
c_func
(paren
r_void
)paren
(brace
id|register_cciss_ioctl32
c_func
(paren
)paren
suffix:semicolon
r_return
(paren
id|cciss_init
c_func
(paren
)paren
)paren
suffix:semicolon
)brace
DECL|function|cleanup_cciss_module
r_static
r_void
id|__exit
id|cleanup_cciss_module
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|unregister_cciss_ioctl32
c_func
(paren
)paren
suffix:semicolon
id|pci_unregister_driver
c_func
(paren
op_amp
id|cciss_pci_driver
)paren
suffix:semicolon
multiline_comment|/* double check that all controller entrys have been removed */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_CTLR
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|hba
(braket
id|i
)braket
op_ne
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;cciss: had to remove&quot;
l_string|&quot; controller %d&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
id|cciss_remove_one
c_func
(paren
id|hba
(braket
id|i
)braket
op_member_access_from_pointer
id|pdev
)paren
suffix:semicolon
)brace
)brace
id|remove_proc_entry
c_func
(paren
l_string|&quot;cciss&quot;
comma
id|proc_root_driver
)paren
suffix:semicolon
)brace
DECL|variable|init_cciss_module
id|module_init
c_func
(paren
id|init_cciss_module
)paren
suffix:semicolon
DECL|variable|cleanup_cciss_module
id|module_exit
c_func
(paren
id|cleanup_cciss_module
)paren
suffix:semicolon
eof
