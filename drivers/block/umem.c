multiline_comment|/*&n; * mm.c - Micro Memory(tm) PCI memory board block device driver - v2.3&n; *&n; * (C) 2001 San Mehat &lt;nettwerk@valinux.com&gt;&n; * (C) 2001 Johannes Erdfelt &lt;jerdfelt@valinux.com&gt;&n; * (C) 2001 NeilBrown &lt;neilb@cse.unsw.edu.au&gt;&n; *&n; * This driver for the Micro Memory PCI Memory Module with Battery Backup&n; * is Copyright Micro Memory Inc 2001-2002.  All rights reserved.&n; *&n; * This driver is released to the public under the terms of the&n; *  GNU GENERAL PUBLIC LICENSE version 2&n; * See the file COPYING for details.&n; *&n; * This driver provides a standard block device interface for Micro Memory(tm)&n; * PCI based RAM boards.&n; * 10/05/01: Phap Nguyen - Rebuilt the driver&n; * 10/22/01: Phap Nguyen - v2.1 Added disk partitioning&n; * 29oct2001:NeilBrown   - Use make_request_fn instead of request_fn&n; *                       - use stand disk partitioning (so fdisk works).&n; * 08nov2001:NeilBrown&t; - change driver name from &quot;mm&quot; to &quot;umem&quot;&n; *&t;&t;&t; - incorporate into main kernel&n; * 08apr2002:NeilBrown   - Move some of interrupt handle to tasklet&n; *&t;&t;&t; - use spin_lock_bh instead of _irq&n; *&t;&t;&t; - Never block on make_request.  queue&n; *&t;&t;&t;   bh&squot;s instead.&n; *&t;&t;&t; - unregister umem from devfs at mod unload&n; *&t;&t;&t; - Change version to 2.3&n; * 07Nov2001:Phap Nguyen - Select pci read command: 06, 12, 15 (Decimal)&n; * 07Jan2002: P. Nguyen  - Used PCI Memory Write &amp; Invalidate for DMA&n; * 15May2002:NeilBrown   - convert to bio for 2.5&n; * 17May2002:NeilBrown   - remove init_mem initialisation.  Instead detect&n; *&t;&t;&t; - a sequence of writes that cover the card, and&n; *&t;&t;&t; - set initialised bit then.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/bio.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/mman.h&gt;
macro_line|#include &lt;linux/ioctl.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;        /* O_ACCMODE */
macro_line|#include &lt;linux/hdreg.h&gt;  /* HDIO_GETGEO */
macro_line|#include &lt;linux/umem.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/io.h&gt;
DECL|macro|PRINTK
mdefine_line|#define PRINTK(x...) do {} while (0)
DECL|macro|dprintk
mdefine_line|#define dprintk(x...) do {} while (0)
multiline_comment|/*#define dprintk(x...) printk(x) */
DECL|macro|MM_MAXCARDS
mdefine_line|#define MM_MAXCARDS 4
DECL|macro|MM_RAHEAD
mdefine_line|#define MM_RAHEAD 2      /* two sectors */
DECL|macro|MM_BLKSIZE
mdefine_line|#define MM_BLKSIZE 1024  /* 1k blocks */
DECL|macro|MM_HARDSECT
mdefine_line|#define MM_HARDSECT 512  /* 512-byte hardware sectors */
DECL|macro|MM_SHIFT
mdefine_line|#define MM_SHIFT 6       /* max 64 partitions on 4 cards  */
multiline_comment|/*&n; * Version Information&n; */
DECL|macro|DRIVER_VERSION
mdefine_line|#define DRIVER_VERSION &quot;v2.3&quot;
DECL|macro|DRIVER_AUTHOR
mdefine_line|#define DRIVER_AUTHOR &quot;San Mehat, Johannes Erdfelt, NeilBrown&quot;
DECL|macro|DRIVER_DESC
mdefine_line|#define DRIVER_DESC &quot;Micro Memory(tm) PCI memory board block driver&quot;
DECL|variable|debug
r_static
r_int
id|debug
suffix:semicolon
multiline_comment|/* #define HW_TRACE(x)     writeb(x,cards[0].csr_remap + MEMCTRLSTATUS_MAGIC) */
DECL|macro|HW_TRACE
mdefine_line|#define HW_TRACE(x)
DECL|macro|DEBUG_LED_ON_TRANSFER
mdefine_line|#define DEBUG_LED_ON_TRANSFER&t;0x01
DECL|macro|DEBUG_BATTERY_POLLING
mdefine_line|#define DEBUG_BATTERY_POLLING&t;0x02
id|MODULE_PARM
c_func
(paren
id|debug
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|debug
comma
l_string|&quot;Debug bitmask&quot;
)paren
suffix:semicolon
DECL|variable|pci_read_cmd
r_static
r_int
id|pci_read_cmd
op_assign
l_int|0x0C
suffix:semicolon
multiline_comment|/* Read Multiple */
id|MODULE_PARM
c_func
(paren
id|pci_read_cmd
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|pci_read_cmd
comma
l_string|&quot;PCI read command&quot;
)paren
suffix:semicolon
DECL|variable|pci_write_cmd
r_static
r_int
id|pci_write_cmd
op_assign
l_int|0x0F
suffix:semicolon
multiline_comment|/* Write and Invalidate */
id|MODULE_PARM
c_func
(paren
id|pci_write_cmd
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|pci_write_cmd
comma
l_string|&quot;PCI write command&quot;
)paren
suffix:semicolon
DECL|variable|pci_cmds
r_static
r_int
id|pci_cmds
suffix:semicolon
DECL|variable|major_nr
r_static
r_int
id|major_nr
suffix:semicolon
macro_line|#include &lt;linux/blkdev.h&gt;
macro_line|#include &lt;linux/blkpg.h&gt;
DECL|struct|cardinfo
r_struct
id|cardinfo
(brace
DECL|member|card_number
r_int
id|card_number
suffix:semicolon
DECL|member|dev
r_struct
id|pci_dev
op_star
id|dev
suffix:semicolon
DECL|member|irq
r_int
id|irq
suffix:semicolon
DECL|member|csr_base
r_int
r_int
id|csr_base
suffix:semicolon
DECL|member|csr_remap
r_int
r_char
op_star
id|csr_remap
suffix:semicolon
DECL|member|csr_len
r_int
r_int
id|csr_len
suffix:semicolon
macro_line|#ifdef CONFIG_MM_MAP_MEMORY
DECL|member|mem_base
r_int
r_int
id|mem_base
suffix:semicolon
DECL|member|mem_remap
r_int
r_char
op_star
id|mem_remap
suffix:semicolon
DECL|member|mem_len
r_int
r_int
id|mem_len
suffix:semicolon
macro_line|#endif
DECL|member|win_size
r_int
r_int
id|win_size
suffix:semicolon
multiline_comment|/* PCI window size */
DECL|member|mm_size
r_int
r_int
id|mm_size
suffix:semicolon
multiline_comment|/* size in kbytes */
DECL|member|init_size
r_int
r_int
id|init_size
suffix:semicolon
multiline_comment|/* initial segment, in sectors,&n;&t;&t;&t;&t;    * that we know to&n;&t;&t;&t;&t;    * have been written&n;&t;&t;&t;&t;    */
DECL|member|bio
DECL|member|currentbio
DECL|member|biotail
r_struct
id|bio
op_star
id|bio
comma
op_star
id|currentbio
comma
op_star
op_star
id|biotail
suffix:semicolon
DECL|member|queue
id|request_queue_t
op_star
id|queue
suffix:semicolon
DECL|struct|mm_page
r_struct
id|mm_page
(brace
DECL|member|page_dma
id|dma_addr_t
id|page_dma
suffix:semicolon
DECL|member|desc
r_struct
id|mm_dma_desc
op_star
id|desc
suffix:semicolon
DECL|member|cnt
DECL|member|headcnt
r_int
id|cnt
comma
id|headcnt
suffix:semicolon
DECL|member|bio
DECL|member|biotail
r_struct
id|bio
op_star
id|bio
comma
op_star
op_star
id|biotail
suffix:semicolon
DECL|member|mm_pages
)brace
id|mm_pages
(braket
l_int|2
)braket
suffix:semicolon
DECL|macro|DESC_PER_PAGE
mdefine_line|#define DESC_PER_PAGE ((PAGE_SIZE*2)/sizeof(struct mm_dma_desc))
DECL|member|Active
DECL|member|Ready
r_int
id|Active
comma
id|Ready
suffix:semicolon
DECL|member|tasklet
r_struct
id|tasklet_struct
id|tasklet
suffix:semicolon
DECL|member|dma_status
r_int
r_int
id|dma_status
suffix:semicolon
r_struct
(brace
DECL|member|good
r_int
id|good
suffix:semicolon
DECL|member|warned
r_int
id|warned
suffix:semicolon
DECL|member|last_change
r_int
r_int
id|last_change
suffix:semicolon
DECL|member|battery
)brace
id|battery
(braket
l_int|2
)braket
suffix:semicolon
DECL|member|lock
id|spinlock_t
id|lock
suffix:semicolon
DECL|member|check_batteries
r_int
id|check_batteries
suffix:semicolon
DECL|member|flags
r_int
id|flags
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|cards
r_static
r_struct
id|cardinfo
id|cards
(braket
id|MM_MAXCARDS
)braket
suffix:semicolon
DECL|variable|mm_fops
r_static
r_struct
id|block_device_operations
id|mm_fops
suffix:semicolon
DECL|variable|battery_timer
r_static
r_struct
id|timer_list
id|battery_timer
suffix:semicolon
DECL|variable|num_cards
r_static
r_int
id|num_cards
op_assign
l_int|0
suffix:semicolon
DECL|variable|mm_gendisk
r_static
r_struct
id|gendisk
op_star
id|mm_gendisk
(braket
id|MM_MAXCARDS
)braket
suffix:semicolon
r_static
r_void
id|check_batteries
c_func
(paren
r_struct
id|cardinfo
op_star
id|card
)paren
suffix:semicolon
multiline_comment|/*&n;-----------------------------------------------------------------------------------&n;--                           get_userbit&n;-----------------------------------------------------------------------------------&n;*/
DECL|function|get_userbit
r_static
r_int
id|get_userbit
c_func
(paren
r_struct
id|cardinfo
op_star
id|card
comma
r_int
id|bit
)paren
(brace
r_int
r_char
id|led
suffix:semicolon
id|led
op_assign
id|readb
c_func
(paren
id|card-&gt;csr_remap
op_plus
id|MEMCTRLCMD_LEDCTRL
)paren
suffix:semicolon
r_return
id|led
op_amp
id|bit
suffix:semicolon
)brace
multiline_comment|/*&n;-----------------------------------------------------------------------------------&n;--                            set_userbit&n;-----------------------------------------------------------------------------------&n;*/
DECL|function|set_userbit
r_static
r_int
id|set_userbit
c_func
(paren
r_struct
id|cardinfo
op_star
id|card
comma
r_int
id|bit
comma
r_int
r_char
id|state
)paren
(brace
r_int
r_char
id|led
suffix:semicolon
id|led
op_assign
id|readb
c_func
(paren
id|card-&gt;csr_remap
op_plus
id|MEMCTRLCMD_LEDCTRL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|state
)paren
id|led
op_or_assign
id|bit
suffix:semicolon
r_else
id|led
op_and_assign
op_complement
id|bit
suffix:semicolon
id|writeb
c_func
(paren
id|led
comma
id|card-&gt;csr_remap
op_plus
id|MEMCTRLCMD_LEDCTRL
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;-----------------------------------------------------------------------------------&n;--                             set_led&n;-----------------------------------------------------------------------------------&n;*/
multiline_comment|/*&n; * NOTE: For the power LED, use the LED_POWER_* macros since they differ&n; */
DECL|function|set_led
r_static
r_void
id|set_led
c_func
(paren
r_struct
id|cardinfo
op_star
id|card
comma
r_int
id|shift
comma
r_int
r_char
id|state
)paren
(brace
r_int
r_char
id|led
suffix:semicolon
id|led
op_assign
id|readb
c_func
(paren
id|card-&gt;csr_remap
op_plus
id|MEMCTRLCMD_LEDCTRL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|state
op_eq
id|LED_FLIP
)paren
id|led
op_xor_assign
(paren
l_int|1
op_lshift
id|shift
)paren
suffix:semicolon
r_else
(brace
id|led
op_and_assign
op_complement
(paren
l_int|0x03
op_lshift
id|shift
)paren
suffix:semicolon
id|led
op_or_assign
(paren
id|state
op_lshift
id|shift
)paren
suffix:semicolon
)brace
id|writeb
c_func
(paren
id|led
comma
id|card-&gt;csr_remap
op_plus
id|MEMCTRLCMD_LEDCTRL
)paren
suffix:semicolon
)brace
macro_line|#ifdef MM_DIAG
multiline_comment|/*&n;-----------------------------------------------------------------------------------&n;--                              dump_regs&n;-----------------------------------------------------------------------------------&n;*/
DECL|function|dump_regs
r_static
r_void
id|dump_regs
c_func
(paren
r_struct
id|cardinfo
op_star
id|card
)paren
(brace
r_int
r_char
op_star
id|p
suffix:semicolon
r_int
id|i
comma
id|i1
suffix:semicolon
id|p
op_assign
id|card-&gt;csr_remap
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%p   &quot;
comma
id|p
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i1
op_assign
l_int|0
suffix:semicolon
id|i1
OL
l_int|16
suffix:semicolon
id|i1
op_increment
)paren
id|printk
c_func
(paren
l_string|&quot;%02x &quot;
comma
op_star
id|p
op_increment
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
multiline_comment|/*&n;-----------------------------------------------------------------------------------&n;--                            dump_dmastat&n;-----------------------------------------------------------------------------------&n;*/
DECL|function|dump_dmastat
r_static
r_void
id|dump_dmastat
c_func
(paren
r_struct
id|cardinfo
op_star
id|card
comma
r_int
r_int
id|dmastat
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;MM%d*: DMAstat - &quot;
comma
id|card-&gt;card_number
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dmastat
op_amp
id|DMASCR_ANY_ERR
)paren
id|printk
c_func
(paren
l_string|&quot;ANY_ERR &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dmastat
op_amp
id|DMASCR_MBE_ERR
)paren
id|printk
c_func
(paren
l_string|&quot;MBE_ERR &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dmastat
op_amp
id|DMASCR_PARITY_ERR_REP
)paren
id|printk
c_func
(paren
l_string|&quot;PARITY_ERR_REP &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dmastat
op_amp
id|DMASCR_PARITY_ERR_DET
)paren
id|printk
c_func
(paren
l_string|&quot;PARITY_ERR_DET &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dmastat
op_amp
id|DMASCR_SYSTEM_ERR_SIG
)paren
id|printk
c_func
(paren
l_string|&quot;SYSTEM_ERR_SIG &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dmastat
op_amp
id|DMASCR_TARGET_ABT
)paren
id|printk
c_func
(paren
l_string|&quot;TARGET_ABT &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dmastat
op_amp
id|DMASCR_MASTER_ABT
)paren
id|printk
c_func
(paren
l_string|&quot;MASTER_ABT &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dmastat
op_amp
id|DMASCR_CHAIN_COMPLETE
)paren
id|printk
c_func
(paren
l_string|&quot;CHAIN_COMPLETE &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dmastat
op_amp
id|DMASCR_DMA_COMPLETE
)paren
id|printk
c_func
(paren
l_string|&quot;DMA_COMPLETE &quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Theory of request handling&n; *&n; * Each bio is assigned to one mm_dma_desc - which may not be enough FIXME&n; * We have two pages of mm_dma_desc, holding about 64 descriptors&n; * each.  These are allocated at init time.&n; * One page is &quot;Ready&quot; and is either full, or can have request added.&n; * The other page might be &quot;Active&quot;, which DMA is happening on it.&n; *&n; * Whenever IO on the active page completes, the Ready page is activated&n; * and the ex-Active page is clean out and made Ready.&n; * Otherwise the Ready page is only activated when it becomes full, or&n; * when mm_unplug_device is called via blk_run_queues().&n; *&n; * If a request arrives while both pages a full, it is queued, and b_rdev is&n; * overloaded to record whether it was a read or a write.&n; *&n; * The interrupt handler only polls the device to clear the interrupt.&n; * The processing of the result is done in a tasklet.&n; */
DECL|function|mm_start_io
r_static
r_void
id|mm_start_io
c_func
(paren
r_struct
id|cardinfo
op_star
id|card
)paren
(brace
multiline_comment|/* we have the lock, we know there is&n;&t; * no IO active, and we know that card-&gt;Active&n;&t; * is set&n;&t; */
r_struct
id|mm_dma_desc
op_star
id|desc
suffix:semicolon
r_struct
id|mm_page
op_star
id|page
suffix:semicolon
r_int
id|offset
suffix:semicolon
multiline_comment|/* make the last descriptor end the chain */
id|page
op_assign
op_amp
id|card-&gt;mm_pages
(braket
id|card-&gt;Active
)braket
suffix:semicolon
id|PRINTK
c_func
(paren
l_string|&quot;start_io: %d %d-&gt;%d&bslash;n&quot;
comma
id|card-&gt;Active
comma
id|page-&gt;headcnt
comma
id|page-&gt;cnt
op_minus
l_int|1
)paren
suffix:semicolon
id|desc
op_assign
op_amp
id|page-&gt;desc
(braket
id|page-&gt;cnt
op_minus
l_int|1
)braket
suffix:semicolon
id|desc-&gt;control_bits
op_or_assign
id|cpu_to_le32
c_func
(paren
id|DMASCR_CHAIN_COMP_EN
)paren
suffix:semicolon
id|desc-&gt;control_bits
op_and_assign
op_complement
id|cpu_to_le32
c_func
(paren
id|DMASCR_CHAIN_EN
)paren
suffix:semicolon
id|desc-&gt;sem_control_bits
op_assign
id|desc-&gt;control_bits
suffix:semicolon
r_if
c_cond
(paren
id|debug
op_amp
id|DEBUG_LED_ON_TRANSFER
)paren
id|set_led
c_func
(paren
id|card
comma
id|LED_REMOVE
comma
id|LED_ON
)paren
suffix:semicolon
id|desc
op_assign
op_amp
id|page-&gt;desc
(braket
id|page-&gt;headcnt
)braket
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|card-&gt;csr_remap
op_plus
id|DMA_PCI_ADDR
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|card-&gt;csr_remap
op_plus
id|DMA_PCI_ADDR
op_plus
l_int|4
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|card-&gt;csr_remap
op_plus
id|DMA_LOCAL_ADDR
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|card-&gt;csr_remap
op_plus
id|DMA_LOCAL_ADDR
op_plus
l_int|4
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|card-&gt;csr_remap
op_plus
id|DMA_TRANSFER_SIZE
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|card-&gt;csr_remap
op_plus
id|DMA_TRANSFER_SIZE
op_plus
l_int|4
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|card-&gt;csr_remap
op_plus
id|DMA_SEMAPHORE_ADDR
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|card-&gt;csr_remap
op_plus
id|DMA_SEMAPHORE_ADDR
op_plus
l_int|4
)paren
suffix:semicolon
id|offset
op_assign
(paren
(paren
r_char
op_star
)paren
id|desc
)paren
op_minus
(paren
(paren
r_char
op_star
)paren
id|page-&gt;desc
)paren
suffix:semicolon
id|writel
c_func
(paren
id|cpu_to_le32
c_func
(paren
(paren
id|page-&gt;page_dma
op_plus
id|offset
)paren
op_amp
l_int|0xffffffff
)paren
comma
id|card-&gt;csr_remap
op_plus
id|DMA_DESCRIPTOR_ADDR
)paren
suffix:semicolon
multiline_comment|/* Force the value to u64 before shifting otherwise &gt;&gt; 32 is undefined C&n;&t; * and on some ports will do nothing ! */
id|writel
c_func
(paren
id|cpu_to_le32
c_func
(paren
(paren
(paren
id|u64
)paren
id|page-&gt;page_dma
)paren
op_rshift
l_int|32
)paren
comma
id|card-&gt;csr_remap
op_plus
id|DMA_DESCRIPTOR_ADDR
op_plus
l_int|4
)paren
suffix:semicolon
multiline_comment|/* Go, go, go */
id|writel
c_func
(paren
id|cpu_to_le32
c_func
(paren
id|DMASCR_GO
op_or
id|DMASCR_CHAIN_EN
op_or
id|pci_cmds
)paren
comma
id|card-&gt;csr_remap
op_plus
id|DMA_STATUS_CTRL
)paren
suffix:semicolon
)brace
r_static
r_int
id|add_bio
c_func
(paren
r_struct
id|cardinfo
op_star
id|card
)paren
suffix:semicolon
DECL|function|activate
r_static
r_void
id|activate
c_func
(paren
r_struct
id|cardinfo
op_star
id|card
)paren
(brace
multiline_comment|/* if No page is Active, and Ready is &n;&t; * not empty, then switch Ready page&n;&t; * to active and start IO.&n;&t; * Then add any bh&squot;s that are available to Ready&n;&t; */
r_do
(brace
r_while
c_loop
(paren
id|add_bio
c_func
(paren
id|card
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;Active
op_eq
op_minus
l_int|1
op_logical_and
id|card-&gt;mm_pages
(braket
id|card-&gt;Ready
)braket
dot
id|cnt
OG
l_int|0
)paren
(brace
id|card-&gt;Active
op_assign
id|card-&gt;Ready
suffix:semicolon
id|card-&gt;Ready
op_assign
l_int|1
op_minus
id|card-&gt;Ready
suffix:semicolon
id|mm_start_io
c_func
(paren
id|card
)paren
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|card-&gt;Active
op_eq
op_minus
l_int|1
op_logical_and
id|add_bio
c_func
(paren
id|card
)paren
)paren
suffix:semicolon
)brace
DECL|function|reset_page
r_static
r_inline
r_void
id|reset_page
c_func
(paren
r_struct
id|mm_page
op_star
id|page
)paren
(brace
id|page-&gt;cnt
op_assign
l_int|0
suffix:semicolon
id|page-&gt;headcnt
op_assign
l_int|0
suffix:semicolon
id|page-&gt;bio
op_assign
l_int|NULL
suffix:semicolon
id|page-&gt;biotail
op_assign
op_amp
id|page-&gt;bio
suffix:semicolon
)brace
DECL|function|mm_unplug_device
r_static
r_void
id|mm_unplug_device
c_func
(paren
r_void
op_star
id|data
)paren
(brace
id|request_queue_t
op_star
id|q
op_assign
id|data
suffix:semicolon
r_struct
id|cardinfo
op_star
id|card
op_assign
id|q-&gt;queuedata
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|blk_remove_plug
c_func
(paren
id|q
)paren
)paren
id|activate
c_func
(paren
id|card
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|card-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* &n; * If there is room on Ready page, take&n; * one bh off list and add it.&n; * return 1 if there was room, else 0.&n; */
DECL|function|add_bio
r_static
r_int
id|add_bio
c_func
(paren
r_struct
id|cardinfo
op_star
id|card
)paren
(brace
r_struct
id|mm_page
op_star
id|p
suffix:semicolon
r_struct
id|mm_dma_desc
op_star
id|desc
suffix:semicolon
id|dma_addr_t
id|dma_handle
suffix:semicolon
r_int
id|offset
suffix:semicolon
r_struct
id|bio
op_star
id|bio
suffix:semicolon
r_int
id|rw
suffix:semicolon
r_int
id|len
suffix:semicolon
id|bio
op_assign
id|card-&gt;currentbio
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bio
op_logical_and
id|card-&gt;bio
)paren
(brace
id|card-&gt;currentbio
op_assign
id|card-&gt;bio
suffix:semicolon
id|card-&gt;bio
op_assign
id|card-&gt;bio-&gt;bi_next
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;bio
op_eq
l_int|NULL
)paren
id|card-&gt;biotail
op_assign
op_amp
id|card-&gt;bio
suffix:semicolon
id|card-&gt;currentbio-&gt;bi_next
op_assign
l_int|NULL
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|bio
)paren
r_return
l_int|0
suffix:semicolon
id|rw
op_assign
id|bio_rw
c_func
(paren
id|bio
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;mm_pages
(braket
id|card-&gt;Ready
)braket
dot
id|cnt
op_ge
id|DESC_PER_PAGE
)paren
r_return
l_int|0
suffix:semicolon
id|len
op_assign
id|bio_iovec
c_func
(paren
id|bio
)paren
op_member_access_from_pointer
id|bv_len
suffix:semicolon
id|dma_handle
op_assign
id|pci_map_page
c_func
(paren
id|card-&gt;dev
comma
id|bio_page
c_func
(paren
id|bio
)paren
comma
id|bio_offset
c_func
(paren
id|bio
)paren
comma
id|len
comma
(paren
id|rw
op_eq
id|READ
)paren
ques
c_cond
id|PCI_DMA_FROMDEVICE
suffix:colon
id|PCI_DMA_TODEVICE
)paren
suffix:semicolon
id|p
op_assign
op_amp
id|card-&gt;mm_pages
(braket
id|card-&gt;Ready
)braket
suffix:semicolon
id|desc
op_assign
op_amp
id|p-&gt;desc
(braket
id|p-&gt;cnt
)braket
suffix:semicolon
id|p-&gt;cnt
op_increment
suffix:semicolon
r_if
c_cond
(paren
(paren
id|p-&gt;biotail
)paren
op_ne
op_amp
id|bio-&gt;bi_next
)paren
(brace
op_star
(paren
id|p-&gt;biotail
)paren
op_assign
id|bio
suffix:semicolon
id|p-&gt;biotail
op_assign
op_amp
(paren
id|bio-&gt;bi_next
)paren
suffix:semicolon
id|bio-&gt;bi_next
op_assign
l_int|NULL
suffix:semicolon
)brace
id|desc-&gt;data_dma_handle
op_assign
id|dma_handle
suffix:semicolon
id|desc-&gt;pci_addr
op_assign
id|cpu_to_le64
c_func
(paren
(paren
id|u64
)paren
id|desc-&gt;data_dma_handle
)paren
suffix:semicolon
id|desc-&gt;local_addr
op_assign
id|cpu_to_le64
c_func
(paren
id|bio-&gt;bi_sector
op_lshift
l_int|9
)paren
suffix:semicolon
id|desc-&gt;transfer_size
op_assign
id|cpu_to_le32
c_func
(paren
id|len
)paren
suffix:semicolon
id|offset
op_assign
(paren
(paren
(paren
r_char
op_star
)paren
op_amp
id|desc-&gt;sem_control_bits
)paren
op_minus
(paren
(paren
r_char
op_star
)paren
id|p-&gt;desc
)paren
)paren
suffix:semicolon
id|desc-&gt;sem_addr
op_assign
id|cpu_to_le64
c_func
(paren
(paren
id|u64
)paren
(paren
id|p-&gt;page_dma
op_plus
id|offset
)paren
)paren
suffix:semicolon
id|desc-&gt;zero1
op_assign
id|desc-&gt;zero2
op_assign
l_int|0
suffix:semicolon
id|offset
op_assign
(paren
(paren
(paren
r_char
op_star
)paren
(paren
id|desc
op_plus
l_int|1
)paren
)paren
op_minus
(paren
(paren
r_char
op_star
)paren
id|p-&gt;desc
)paren
)paren
suffix:semicolon
id|desc-&gt;next_desc_addr
op_assign
id|cpu_to_le64
c_func
(paren
id|p-&gt;page_dma
op_plus
id|offset
)paren
suffix:semicolon
id|desc-&gt;control_bits
op_assign
id|cpu_to_le32
c_func
(paren
id|DMASCR_GO
op_or
id|DMASCR_ERR_INT_EN
op_or
id|DMASCR_PARITY_INT_EN
op_or
id|DMASCR_CHAIN_EN
op_or
id|DMASCR_SEM_EN
op_or
id|pci_cmds
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rw
op_eq
id|WRITE
)paren
id|desc-&gt;control_bits
op_or_assign
id|cpu_to_le32
c_func
(paren
id|DMASCR_TRANSFER_READ
)paren
suffix:semicolon
id|desc-&gt;sem_control_bits
op_assign
id|desc-&gt;control_bits
suffix:semicolon
id|bio-&gt;bi_sector
op_add_assign
(paren
id|len
op_rshift
l_int|9
)paren
suffix:semicolon
id|bio-&gt;bi_size
op_sub_assign
id|len
suffix:semicolon
id|bio-&gt;bi_idx
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|bio-&gt;bi_idx
op_ge
id|bio-&gt;bi_vcnt
)paren
id|card-&gt;currentbio
op_assign
l_int|NULL
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|process_page
r_static
r_void
id|process_page
c_func
(paren
r_int
r_int
id|data
)paren
(brace
multiline_comment|/* check if any of the requests in the page are DMA_COMPLETE,&n;&t; * and deal with them appropriately.&n;&t; * If we find a descriptor without DMA_COMPLETE in the semaphore, then&n;&t; * dma must have hit an error on that descriptor, so use dma_status instead&n;&t; * and assume that all following descriptors must be re-tried.&n;&t; */
r_struct
id|mm_page
op_star
id|page
suffix:semicolon
r_struct
id|bio
op_star
id|return_bio
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|cardinfo
op_star
id|card
op_assign
(paren
r_struct
id|cardinfo
op_star
)paren
id|data
suffix:semicolon
r_int
r_int
id|dma_status
op_assign
id|card-&gt;dma_status
suffix:semicolon
id|spin_lock_bh
c_func
(paren
op_amp
id|card-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;Active
OL
l_int|0
)paren
r_goto
id|out_unlock
suffix:semicolon
id|page
op_assign
op_amp
id|card-&gt;mm_pages
(braket
id|card-&gt;Active
)braket
suffix:semicolon
r_while
c_loop
(paren
id|page-&gt;headcnt
OL
id|page-&gt;cnt
)paren
(brace
r_struct
id|bio
op_star
id|bio
op_assign
id|page-&gt;bio
suffix:semicolon
r_struct
id|mm_dma_desc
op_star
id|desc
op_assign
op_amp
id|page-&gt;desc
(braket
id|page-&gt;headcnt
)braket
suffix:semicolon
r_int
id|control
op_assign
id|le32_to_cpu
c_func
(paren
id|desc-&gt;sem_control_bits
)paren
suffix:semicolon
r_int
id|last
op_assign
l_int|0
suffix:semicolon
r_int
id|idx
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|control
op_amp
id|DMASCR_DMA_COMPLETE
)paren
)paren
(brace
id|control
op_assign
id|dma_status
suffix:semicolon
id|last
op_assign
l_int|1
suffix:semicolon
)brace
id|page-&gt;headcnt
op_increment
suffix:semicolon
id|idx
op_assign
id|bio-&gt;bi_phys_segments
suffix:semicolon
id|bio-&gt;bi_phys_segments
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|bio-&gt;bi_phys_segments
op_ge
id|bio-&gt;bi_vcnt
)paren
id|page-&gt;bio
op_assign
id|bio-&gt;bi_next
suffix:semicolon
id|pci_unmap_page
c_func
(paren
id|card-&gt;dev
comma
id|desc-&gt;data_dma_handle
comma
id|bio_iovec_idx
c_func
(paren
id|bio
comma
id|idx
)paren
op_member_access_from_pointer
id|bv_len
comma
(paren
id|control
op_amp
id|DMASCR_TRANSFER_READ
)paren
ques
c_cond
id|PCI_DMA_TODEVICE
suffix:colon
id|PCI_DMA_FROMDEVICE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|control
op_amp
id|DMASCR_HARD_ERROR
)paren
(brace
multiline_comment|/* error */
id|clear_bit
c_func
(paren
id|BIO_UPTODATE
comma
op_amp
id|bio-&gt;bi_flags
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;MM%d: I/O error on sector %d/%d&bslash;n&quot;
comma
id|card-&gt;card_number
comma
id|le32_to_cpu
c_func
(paren
id|desc-&gt;local_addr
)paren
op_rshift
l_int|9
comma
id|le32_to_cpu
c_func
(paren
id|desc-&gt;transfer_size
)paren
)paren
suffix:semicolon
id|dump_dmastat
c_func
(paren
id|card
comma
id|control
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|BIO_RW
comma
op_amp
id|bio-&gt;bi_rw
)paren
op_logical_and
id|le32_to_cpu
c_func
(paren
id|desc-&gt;local_addr
)paren
op_rshift
l_int|9
op_eq
id|card-&gt;init_size
)paren
(brace
id|card-&gt;init_size
op_add_assign
id|le32_to_cpu
c_func
(paren
id|desc-&gt;transfer_size
)paren
op_rshift
l_int|9
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;init_size
op_rshift
l_int|1
op_ge
id|card-&gt;mm_size
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;MM%d: memory now initialised&bslash;n&quot;
comma
id|card-&gt;card_number
)paren
suffix:semicolon
id|set_userbit
c_func
(paren
id|card
comma
id|MEMORY_INITIALIZED
comma
l_int|1
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|bio
op_ne
id|page-&gt;bio
)paren
(brace
id|bio-&gt;bi_next
op_assign
id|return_bio
suffix:semicolon
id|return_bio
op_assign
id|bio
suffix:semicolon
)brace
r_if
c_cond
(paren
id|last
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|debug
op_amp
id|DEBUG_LED_ON_TRANSFER
)paren
id|set_led
c_func
(paren
id|card
comma
id|LED_REMOVE
comma
id|LED_OFF
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;check_batteries
)paren
(brace
id|card-&gt;check_batteries
op_assign
l_int|0
suffix:semicolon
id|check_batteries
c_func
(paren
id|card
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|page-&gt;headcnt
op_ge
id|page-&gt;cnt
)paren
(brace
id|reset_page
c_func
(paren
id|page
)paren
suffix:semicolon
id|card-&gt;Active
op_assign
op_minus
l_int|1
suffix:semicolon
id|activate
c_func
(paren
id|card
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* haven&squot;t finished with this one yet */
id|PRINTK
c_func
(paren
l_string|&quot;do some more&bslash;n&quot;
)paren
suffix:semicolon
id|mm_start_io
c_func
(paren
id|card
)paren
suffix:semicolon
)brace
id|out_unlock
suffix:colon
id|spin_unlock_bh
c_func
(paren
op_amp
id|card-&gt;lock
)paren
suffix:semicolon
r_while
c_loop
(paren
id|return_bio
)paren
(brace
r_struct
id|bio
op_star
id|bio
op_assign
id|return_bio
suffix:semicolon
id|return_bio
op_assign
id|bio-&gt;bi_next
suffix:semicolon
id|bio-&gt;bi_next
op_assign
l_int|NULL
suffix:semicolon
id|bio_endio
c_func
(paren
id|bio
comma
id|bio-&gt;bi_size
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;-----------------------------------------------------------------------------------&n;--                              mm_make_request&n;-----------------------------------------------------------------------------------&n;*/
DECL|function|mm_make_request
r_static
r_int
id|mm_make_request
c_func
(paren
id|request_queue_t
op_star
id|q
comma
r_struct
id|bio
op_star
id|bio
)paren
(brace
r_struct
id|cardinfo
op_star
id|card
op_assign
id|q-&gt;queuedata
suffix:semicolon
id|PRINTK
c_func
(paren
l_string|&quot;mm_make_request %ld %d&bslash;n&quot;
comma
id|bh-&gt;b_rsector
comma
id|bh-&gt;b_size
)paren
suffix:semicolon
id|bio-&gt;bi_phys_segments
op_assign
id|bio-&gt;bi_idx
suffix:semicolon
multiline_comment|/* count of completed segments*/
id|spin_lock_irq
c_func
(paren
op_amp
id|card-&gt;lock
)paren
suffix:semicolon
op_star
id|card-&gt;biotail
op_assign
id|bio
suffix:semicolon
id|bio-&gt;bi_next
op_assign
l_int|NULL
suffix:semicolon
id|card-&gt;biotail
op_assign
op_amp
id|bio-&gt;bi_next
suffix:semicolon
id|blk_plug_device
c_func
(paren
id|q
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|card-&gt;lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;-----------------------------------------------------------------------------------&n;--                              mm_interrupt&n;-----------------------------------------------------------------------------------&n;*/
DECL|function|mm_interrupt
r_static
id|irqreturn_t
id|mm_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|__card
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|cardinfo
op_star
id|card
op_assign
(paren
r_struct
id|cardinfo
op_star
)paren
id|__card
suffix:semicolon
r_int
r_int
id|dma_status
suffix:semicolon
r_int
r_int
id|cfg_status
suffix:semicolon
id|HW_TRACE
c_func
(paren
l_int|0x30
)paren
suffix:semicolon
id|dma_status
op_assign
id|le32_to_cpu
c_func
(paren
id|readl
c_func
(paren
id|card-&gt;csr_remap
op_plus
id|DMA_STATUS_CTRL
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|dma_status
op_amp
(paren
id|DMASCR_ERROR_MASK
op_or
id|DMASCR_CHAIN_COMPLETE
)paren
)paren
)paren
(brace
multiline_comment|/* interrupt wasn&squot;t for me ... */
r_return
id|IRQ_NONE
suffix:semicolon
)brace
multiline_comment|/* clear COMPLETION interrupts */
r_if
c_cond
(paren
id|card-&gt;flags
op_amp
id|UM_FLAG_NO_BYTE_STATUS
)paren
id|writel
c_func
(paren
id|cpu_to_le32
c_func
(paren
id|DMASCR_DMA_COMPLETE
op_or
id|DMASCR_CHAIN_COMPLETE
)paren
comma
id|card-&gt;csr_remap
op_plus
id|DMA_STATUS_CTRL
)paren
suffix:semicolon
r_else
id|writeb
c_func
(paren
(paren
id|DMASCR_DMA_COMPLETE
op_or
id|DMASCR_CHAIN_COMPLETE
)paren
op_rshift
l_int|16
comma
id|card-&gt;csr_remap
op_plus
id|DMA_STATUS_CTRL
op_plus
l_int|2
)paren
suffix:semicolon
multiline_comment|/* log errors and clear interrupt status */
r_if
c_cond
(paren
id|dma_status
op_amp
id|DMASCR_ANY_ERR
)paren
(brace
r_int
r_int
id|data_log1
comma
id|data_log2
suffix:semicolon
r_int
r_int
id|addr_log1
comma
id|addr_log2
suffix:semicolon
r_int
r_char
id|stat
comma
id|count
comma
id|syndrome
comma
id|check
suffix:semicolon
id|stat
op_assign
id|readb
c_func
(paren
id|card-&gt;csr_remap
op_plus
id|MEMCTRLCMD_ERRSTATUS
)paren
suffix:semicolon
id|data_log1
op_assign
id|le32_to_cpu
c_func
(paren
id|readl
c_func
(paren
id|card-&gt;csr_remap
op_plus
id|ERROR_DATA_LOG
)paren
)paren
suffix:semicolon
id|data_log2
op_assign
id|le32_to_cpu
c_func
(paren
id|readl
c_func
(paren
id|card-&gt;csr_remap
op_plus
id|ERROR_DATA_LOG
op_plus
l_int|4
)paren
)paren
suffix:semicolon
id|addr_log1
op_assign
id|le32_to_cpu
c_func
(paren
id|readl
c_func
(paren
id|card-&gt;csr_remap
op_plus
id|ERROR_ADDR_LOG
)paren
)paren
suffix:semicolon
id|addr_log2
op_assign
id|readb
c_func
(paren
id|card-&gt;csr_remap
op_plus
id|ERROR_ADDR_LOG
op_plus
l_int|4
)paren
suffix:semicolon
id|count
op_assign
id|readb
c_func
(paren
id|card-&gt;csr_remap
op_plus
id|ERROR_COUNT
)paren
suffix:semicolon
id|syndrome
op_assign
id|readb
c_func
(paren
id|card-&gt;csr_remap
op_plus
id|ERROR_SYNDROME
)paren
suffix:semicolon
id|check
op_assign
id|readb
c_func
(paren
id|card-&gt;csr_remap
op_plus
id|ERROR_CHECK
)paren
suffix:semicolon
id|dump_dmastat
c_func
(paren
id|card
comma
id|dma_status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|stat
op_amp
l_int|0x01
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;MM%d*: Memory access error detected (err count %d)&bslash;n&quot;
comma
id|card-&gt;card_number
comma
id|count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|stat
op_amp
l_int|0x02
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;MM%d*: Multi-bit EDC error&bslash;n&quot;
comma
id|card-&gt;card_number
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;MM%d*: Fault Address 0x%02x%08x, Fault Data 0x%08x%08x&bslash;n&quot;
comma
id|card-&gt;card_number
comma
id|addr_log2
comma
id|addr_log1
comma
id|data_log2
comma
id|data_log1
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;MM%d*: Fault Check 0x%02x, Fault Syndrome 0x%02x&bslash;n&quot;
comma
id|card-&gt;card_number
comma
id|check
comma
id|syndrome
)paren
suffix:semicolon
id|writeb
c_func
(paren
l_int|0
comma
id|card-&gt;csr_remap
op_plus
id|ERROR_COUNT
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dma_status
op_amp
id|DMASCR_PARITY_ERR_REP
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;MM%d*: PARITY ERROR REPORTED&bslash;n&quot;
comma
id|card-&gt;card_number
)paren
suffix:semicolon
id|pci_read_config_word
c_func
(paren
id|card-&gt;dev
comma
id|PCI_STATUS
comma
op_amp
id|cfg_status
)paren
suffix:semicolon
id|pci_write_config_word
c_func
(paren
id|card-&gt;dev
comma
id|PCI_STATUS
comma
id|cfg_status
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dma_status
op_amp
id|DMASCR_PARITY_ERR_DET
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;MM%d*: PARITY ERROR DETECTED&bslash;n&quot;
comma
id|card-&gt;card_number
)paren
suffix:semicolon
id|pci_read_config_word
c_func
(paren
id|card-&gt;dev
comma
id|PCI_STATUS
comma
op_amp
id|cfg_status
)paren
suffix:semicolon
id|pci_write_config_word
c_func
(paren
id|card-&gt;dev
comma
id|PCI_STATUS
comma
id|cfg_status
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dma_status
op_amp
id|DMASCR_SYSTEM_ERR_SIG
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;MM%d*: SYSTEM ERROR&bslash;n&quot;
comma
id|card-&gt;card_number
)paren
suffix:semicolon
id|pci_read_config_word
c_func
(paren
id|card-&gt;dev
comma
id|PCI_STATUS
comma
op_amp
id|cfg_status
)paren
suffix:semicolon
id|pci_write_config_word
c_func
(paren
id|card-&gt;dev
comma
id|PCI_STATUS
comma
id|cfg_status
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dma_status
op_amp
id|DMASCR_TARGET_ABT
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;MM%d*: TARGET ABORT&bslash;n&quot;
comma
id|card-&gt;card_number
)paren
suffix:semicolon
id|pci_read_config_word
c_func
(paren
id|card-&gt;dev
comma
id|PCI_STATUS
comma
op_amp
id|cfg_status
)paren
suffix:semicolon
id|pci_write_config_word
c_func
(paren
id|card-&gt;dev
comma
id|PCI_STATUS
comma
id|cfg_status
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dma_status
op_amp
id|DMASCR_MASTER_ABT
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;MM%d*: MASTER ABORT&bslash;n&quot;
comma
id|card-&gt;card_number
)paren
suffix:semicolon
id|pci_read_config_word
c_func
(paren
id|card-&gt;dev
comma
id|PCI_STATUS
comma
op_amp
id|cfg_status
)paren
suffix:semicolon
id|pci_write_config_word
c_func
(paren
id|card-&gt;dev
comma
id|PCI_STATUS
comma
id|cfg_status
)paren
suffix:semicolon
)brace
multiline_comment|/* and process the DMA descriptors */
id|card-&gt;dma_status
op_assign
id|dma_status
suffix:semicolon
id|tasklet_schedule
c_func
(paren
op_amp
id|card-&gt;tasklet
)paren
suffix:semicolon
id|HW_TRACE
c_func
(paren
l_int|0x36
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
multiline_comment|/*&n;-----------------------------------------------------------------------------------&n;--                         set_fault_to_battery_status&n;-----------------------------------------------------------------------------------&n;*/
multiline_comment|/*&n; * If both batteries are good, no LED&n; * If either battery has been warned, solid LED&n; * If both batteries are bad, flash the LED quickly&n; * If either battery is bad, flash the LED semi quickly&n; */
DECL|function|set_fault_to_battery_status
r_static
r_void
id|set_fault_to_battery_status
c_func
(paren
r_struct
id|cardinfo
op_star
id|card
)paren
(brace
r_if
c_cond
(paren
id|card-&gt;battery
(braket
l_int|0
)braket
dot
id|good
op_logical_and
id|card-&gt;battery
(braket
l_int|1
)braket
dot
id|good
)paren
id|set_led
c_func
(paren
id|card
comma
id|LED_FAULT
comma
id|LED_OFF
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|card-&gt;battery
(braket
l_int|0
)braket
dot
id|warned
op_logical_or
id|card-&gt;battery
(braket
l_int|1
)braket
dot
id|warned
)paren
id|set_led
c_func
(paren
id|card
comma
id|LED_FAULT
comma
id|LED_ON
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;battery
(braket
l_int|0
)braket
dot
id|good
op_logical_and
op_logical_neg
id|card-&gt;battery
(braket
l_int|1
)braket
dot
id|good
)paren
id|set_led
c_func
(paren
id|card
comma
id|LED_FAULT
comma
id|LED_FLASH_7_0
)paren
suffix:semicolon
r_else
id|set_led
c_func
(paren
id|card
comma
id|LED_FAULT
comma
id|LED_FLASH_3_5
)paren
suffix:semicolon
)brace
r_static
r_void
id|init_battery_timer
c_func
(paren
r_void
)paren
suffix:semicolon
multiline_comment|/*&n;-----------------------------------------------------------------------------------&n;--                            check_battery&n;-----------------------------------------------------------------------------------&n;*/
DECL|function|check_battery
r_static
r_int
id|check_battery
c_func
(paren
r_struct
id|cardinfo
op_star
id|card
comma
r_int
id|battery
comma
r_int
id|status
)paren
(brace
r_if
c_cond
(paren
id|status
op_ne
id|card-&gt;battery
(braket
id|battery
)braket
dot
id|good
)paren
(brace
id|card-&gt;battery
(braket
id|battery
)braket
dot
id|good
op_assign
op_logical_neg
id|card-&gt;battery
(braket
id|battery
)braket
dot
id|good
suffix:semicolon
id|card-&gt;battery
(braket
id|battery
)braket
dot
id|last_change
op_assign
id|jiffies
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;battery
(braket
id|battery
)braket
dot
id|good
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;MM%d: Battery %d now good&bslash;n&quot;
comma
id|card-&gt;card_number
comma
id|battery
op_plus
l_int|1
)paren
suffix:semicolon
id|card-&gt;battery
(braket
id|battery
)braket
dot
id|warned
op_assign
l_int|0
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;MM%d: Battery %d now FAILED&bslash;n&quot;
comma
id|card-&gt;card_number
comma
id|battery
op_plus
l_int|1
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;battery
(braket
id|battery
)braket
dot
id|good
op_logical_and
op_logical_neg
id|card-&gt;battery
(braket
id|battery
)braket
dot
id|warned
op_logical_and
id|time_after_eq
c_func
(paren
id|jiffies
comma
id|card-&gt;battery
(braket
id|battery
)braket
dot
id|last_change
op_plus
(paren
id|HZ
op_star
l_int|60
op_star
l_int|60
op_star
l_int|5
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;MM%d: Battery %d still FAILED after 5 hours&bslash;n&quot;
comma
id|card-&gt;card_number
comma
id|battery
op_plus
l_int|1
)paren
suffix:semicolon
id|card-&gt;battery
(braket
id|battery
)braket
dot
id|warned
op_assign
l_int|1
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;-----------------------------------------------------------------------------------&n;--                              check_batteries&n;-----------------------------------------------------------------------------------&n;*/
DECL|function|check_batteries
r_static
r_void
id|check_batteries
c_func
(paren
r_struct
id|cardinfo
op_star
id|card
)paren
(brace
multiline_comment|/* NOTE: this must *never* be called while the card&n;&t; * is doing (bus-to-card) DMA, or you will need the&n;&t; * reset switch&n;&t; */
r_int
r_char
id|status
suffix:semicolon
r_int
id|ret1
comma
id|ret2
suffix:semicolon
id|status
op_assign
id|readb
c_func
(paren
id|card-&gt;csr_remap
op_plus
id|MEMCTRLSTATUS_BATTERY
)paren
suffix:semicolon
r_if
c_cond
(paren
id|debug
op_amp
id|DEBUG_BATTERY_POLLING
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;MM%d: checking battery status, 1 = %s, 2 = %s&bslash;n&quot;
comma
id|card-&gt;card_number
comma
(paren
id|status
op_amp
id|BATTERY_1_FAILURE
)paren
ques
c_cond
l_string|&quot;FAILURE&quot;
suffix:colon
l_string|&quot;OK&quot;
comma
(paren
id|status
op_amp
id|BATTERY_2_FAILURE
)paren
ques
c_cond
l_string|&quot;FAILURE&quot;
suffix:colon
l_string|&quot;OK&quot;
)paren
suffix:semicolon
id|ret1
op_assign
id|check_battery
c_func
(paren
id|card
comma
l_int|0
comma
op_logical_neg
(paren
id|status
op_amp
id|BATTERY_1_FAILURE
)paren
)paren
suffix:semicolon
id|ret2
op_assign
id|check_battery
c_func
(paren
id|card
comma
l_int|1
comma
op_logical_neg
(paren
id|status
op_amp
id|BATTERY_2_FAILURE
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret1
op_logical_or
id|ret2
)paren
id|set_fault_to_battery_status
c_func
(paren
id|card
)paren
suffix:semicolon
)brace
DECL|function|check_all_batteries
r_static
r_void
id|check_all_batteries
c_func
(paren
r_int
r_int
id|ptr
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_cards
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
op_logical_neg
(paren
id|cards
(braket
id|i
)braket
dot
id|flags
op_amp
id|UM_FLAG_NO_BATT
)paren
)paren
(brace
r_struct
id|cardinfo
op_star
id|card
op_assign
op_amp
id|cards
(braket
id|i
)braket
suffix:semicolon
id|spin_lock_bh
c_func
(paren
op_amp
id|card-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;Active
op_ge
l_int|0
)paren
id|card-&gt;check_batteries
op_assign
l_int|1
suffix:semicolon
r_else
id|check_batteries
c_func
(paren
id|card
)paren
suffix:semicolon
id|spin_unlock_bh
c_func
(paren
op_amp
id|card-&gt;lock
)paren
suffix:semicolon
)brace
id|init_battery_timer
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;-----------------------------------------------------------------------------------&n;--                            init_battery_timer&n;-----------------------------------------------------------------------------------&n;*/
DECL|function|init_battery_timer
r_static
r_void
id|init_battery_timer
c_func
(paren
r_void
)paren
(brace
id|init_timer
c_func
(paren
op_amp
id|battery_timer
)paren
suffix:semicolon
id|battery_timer.function
op_assign
id|check_all_batteries
suffix:semicolon
id|battery_timer.expires
op_assign
id|jiffies
op_plus
(paren
id|HZ
op_star
l_int|60
)paren
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|battery_timer
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;-----------------------------------------------------------------------------------&n;--                              del_battery_timer&n;-----------------------------------------------------------------------------------&n;*/
DECL|function|del_battery_timer
r_static
r_void
id|del_battery_timer
c_func
(paren
r_void
)paren
(brace
id|del_timer
c_func
(paren
op_amp
id|battery_timer
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;-----------------------------------------------------------------------------------&n;--                                mm_revalidate&n;-----------------------------------------------------------------------------------&n;*/
multiline_comment|/*&n; * Note no locks taken out here.  In a worst case scenario, we could drop&n; * a chunk of system memory.  But that should never happen, since validation&n; * happens at open or mount time, when locks are held.&n; *&n; *&t;That&squot;s crap, since doing that while some partitions are opened&n; * or mounted will give you really nasty results.&n; */
DECL|function|mm_revalidate
r_static
r_int
id|mm_revalidate
c_func
(paren
r_struct
id|gendisk
op_star
id|disk
)paren
(brace
r_struct
id|cardinfo
op_star
id|card
op_assign
id|disk-&gt;private_data
suffix:semicolon
id|set_capacity
c_func
(paren
id|disk
comma
id|card-&gt;mm_size
op_lshift
l_int|1
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;-----------------------------------------------------------------------------------&n;--                            mm_ioctl&n;-----------------------------------------------------------------------------------&n;*/
DECL|function|mm_ioctl
r_static
r_int
id|mm_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|i
comma
r_struct
id|file
op_star
id|f
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_if
c_cond
(paren
id|cmd
op_eq
id|HDIO_GETGEO
)paren
(brace
r_struct
id|cardinfo
op_star
id|card
op_assign
id|i-&gt;i_bdev-&gt;bd_disk-&gt;private_data
suffix:semicolon
r_int
id|size
op_assign
id|card-&gt;mm_size
op_star
(paren
l_int|1024
op_div
id|MM_HARDSECT
)paren
suffix:semicolon
r_struct
id|hd_geometry
id|geo
suffix:semicolon
multiline_comment|/*&n;&t;&t; * get geometry: we have to fake one...  trim the size to a&n;&t;&t; * multiple of 2048 (1M): tell we have 32 sectors, 64 heads,&n;&t;&t; * whatever cylinders.&n;&t;&t; */
id|geo.heads
op_assign
l_int|64
suffix:semicolon
id|geo.sectors
op_assign
l_int|32
suffix:semicolon
id|geo.start
op_assign
id|get_start_sect
c_func
(paren
id|i-&gt;i_bdev
)paren
suffix:semicolon
id|geo.cylinders
op_assign
id|size
op_div
(paren
id|geo.heads
op_star
id|geo.sectors
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|geo
comma
r_sizeof
(paren
id|geo
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/*&n;-----------------------------------------------------------------------------------&n;--                                mm_check_change&n;-----------------------------------------------------------------------------------&n;  Future support for removable devices&n;*/
DECL|function|mm_check_change
r_static
r_int
id|mm_check_change
c_func
(paren
r_struct
id|gendisk
op_star
id|disk
)paren
(brace
multiline_comment|/*  struct cardinfo *dev = disk-&gt;private_data; */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;-----------------------------------------------------------------------------------&n;--                             mm_fops&n;-----------------------------------------------------------------------------------&n;*/
DECL|variable|mm_fops
r_static
r_struct
id|block_device_operations
id|mm_fops
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|ioctl
op_assign
id|mm_ioctl
comma
dot
id|revalidate_disk
op_assign
id|mm_revalidate
comma
dot
id|media_changed
op_assign
id|mm_check_change
comma
)brace
suffix:semicolon
multiline_comment|/*&n;-----------------------------------------------------------------------------------&n;--                                mm_pci_probe&n;-----------------------------------------------------------------------------------&n;*/
DECL|function|mm_pci_probe
r_static
r_int
id|__devinit
id|mm_pci_probe
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_const
r_struct
id|pci_device_id
op_star
id|id
)paren
(brace
r_int
id|ret
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_struct
id|cardinfo
op_star
id|card
op_assign
op_amp
id|cards
(braket
id|num_cards
)braket
suffix:semicolon
r_int
r_char
id|mem_present
suffix:semicolon
r_int
r_char
id|batt_status
suffix:semicolon
r_int
r_int
id|saved_bar
comma
id|data
suffix:semicolon
r_int
id|magic_number
suffix:semicolon
r_if
c_cond
(paren
id|pci_enable_device
c_func
(paren
id|dev
)paren
OL
l_int|0
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|pci_write_config_byte
c_func
(paren
id|dev
comma
id|PCI_LATENCY_TIMER
comma
l_int|0xF8
)paren
suffix:semicolon
id|pci_set_master
c_func
(paren
id|dev
)paren
suffix:semicolon
id|card-&gt;dev
op_assign
id|dev
suffix:semicolon
id|card-&gt;card_number
op_assign
id|num_cards
suffix:semicolon
id|card-&gt;csr_base
op_assign
id|pci_resource_start
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
id|card-&gt;csr_len
op_assign
id|pci_resource_len
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_MM_MAP_MEMORY
id|card-&gt;mem_base
op_assign
id|pci_resource_start
c_func
(paren
id|dev
comma
l_int|1
)paren
suffix:semicolon
id|card-&gt;mem_len
op_assign
id|pci_resource_len
c_func
(paren
id|dev
comma
l_int|1
)paren
suffix:semicolon
macro_line|#endif
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Micro Memory(tm) controller #%d found at %02x:%02x (PCI Mem Module (Battery Backup))&bslash;n&quot;
comma
id|card-&gt;card_number
comma
id|dev-&gt;bus-&gt;number
comma
id|dev-&gt;devfn
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_set_dma_mask
c_func
(paren
id|dev
comma
l_int|0xffffffffffffffffLL
)paren
op_logical_and
op_logical_neg
id|pci_set_dma_mask
c_func
(paren
id|dev
comma
l_int|0xffffffffLL
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;MM%d: NO suitable DMA found&bslash;n&quot;
comma
id|num_cards
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|request_mem_region
c_func
(paren
id|card-&gt;csr_base
comma
id|card-&gt;csr_len
comma
l_string|&quot;Micro Memory&quot;
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;MM%d: Unable to request memory region&bslash;n&quot;
comma
id|card-&gt;card_number
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|failed_req_csr
suffix:semicolon
)brace
id|card-&gt;csr_remap
op_assign
id|ioremap_nocache
c_func
(paren
id|card-&gt;csr_base
comma
id|card-&gt;csr_len
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;csr_remap
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;MM%d: Unable to remap memory region&bslash;n&quot;
comma
id|card-&gt;card_number
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|failed_remap_csr
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;MM%d: CSR 0x%08lx -&gt; 0x%p (0x%lx)&bslash;n&quot;
comma
id|card-&gt;card_number
comma
id|card-&gt;csr_base
comma
id|card-&gt;csr_remap
comma
id|card-&gt;csr_len
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_MM_MAP_MEMORY
r_if
c_cond
(paren
op_logical_neg
id|request_mem_region
c_func
(paren
id|card-&gt;mem_base
comma
id|card-&gt;mem_len
comma
l_string|&quot;Micro Memory&quot;
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;MM%d: Unable to request memory region&bslash;n&quot;
comma
id|card-&gt;card_number
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|failed_req_mem
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|card-&gt;mem_remap
op_assign
(paren
r_int
r_char
op_star
)paren
id|ioremap
c_func
(paren
id|card-&gt;mem_base
comma
id|cards-&gt;mem_len
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;MM%d: Unable to remap memory region&bslash;n&quot;
comma
id|card-&gt;card_number
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|failed_remap_mem
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;MM%d: MEM 0x%8lx -&gt; 0x%8lx (0x%lx)&bslash;n&quot;
comma
id|card-&gt;card_number
comma
id|card-&gt;mem_base
comma
id|card-&gt;mem_remap
comma
id|card-&gt;mem_len
)paren
suffix:semicolon
macro_line|#else
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;MM%d: MEM area not remapped (CONFIG_MM_MAP_MEMORY not set)&bslash;n&quot;
comma
id|card-&gt;card_number
)paren
suffix:semicolon
macro_line|#endif
r_switch
c_cond
(paren
id|card-&gt;dev-&gt;device
)paren
(brace
r_case
l_int|0x5415
suffix:colon
id|card-&gt;flags
op_or_assign
id|UM_FLAG_NO_BYTE_STATUS
op_or
id|UM_FLAG_NO_BATTREG
suffix:semicolon
id|magic_number
op_assign
l_int|0x59
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x5425
suffix:colon
id|card-&gt;flags
op_or_assign
id|UM_FLAG_NO_BYTE_STATUS
suffix:semicolon
id|magic_number
op_assign
l_int|0x5C
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x6155
suffix:colon
id|card-&gt;flags
op_or_assign
id|UM_FLAG_NO_BYTE_STATUS
op_or
id|UM_FLAG_NO_BATTREG
op_or
id|UM_FLAG_NO_BATT
suffix:semicolon
id|magic_number
op_assign
l_int|0x99
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|magic_number
op_assign
l_int|0x100
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|readb
c_func
(paren
id|card-&gt;csr_remap
op_plus
id|MEMCTRLSTATUS_MAGIC
)paren
op_ne
id|magic_number
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;MM%d: Magic number invalid&bslash;n&quot;
comma
id|card-&gt;card_number
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|failed_magic
suffix:semicolon
)brace
id|card-&gt;mm_pages
(braket
l_int|0
)braket
dot
id|desc
op_assign
id|pci_alloc_consistent
c_func
(paren
id|card-&gt;dev
comma
id|PAGE_SIZE
op_star
l_int|2
comma
op_amp
id|card-&gt;mm_pages
(braket
l_int|0
)braket
dot
id|page_dma
)paren
suffix:semicolon
id|card-&gt;mm_pages
(braket
l_int|1
)braket
dot
id|desc
op_assign
id|pci_alloc_consistent
c_func
(paren
id|card-&gt;dev
comma
id|PAGE_SIZE
op_star
l_int|2
comma
op_amp
id|card-&gt;mm_pages
(braket
l_int|1
)braket
dot
id|page_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;mm_pages
(braket
l_int|0
)braket
dot
id|desc
op_eq
l_int|NULL
op_logical_or
id|card-&gt;mm_pages
(braket
l_int|1
)braket
dot
id|desc
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;MM%d: alloc failed&bslash;n&quot;
comma
id|card-&gt;card_number
)paren
suffix:semicolon
r_goto
id|failed_alloc
suffix:semicolon
)brace
id|reset_page
c_func
(paren
op_amp
id|card-&gt;mm_pages
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|reset_page
c_func
(paren
op_amp
id|card-&gt;mm_pages
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|card-&gt;Ready
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* page 0 is ready */
id|card-&gt;Active
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* no page is active */
id|card-&gt;bio
op_assign
l_int|NULL
suffix:semicolon
id|card-&gt;biotail
op_assign
op_amp
id|card-&gt;bio
suffix:semicolon
id|card-&gt;queue
op_assign
id|blk_alloc_queue
c_func
(paren
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|card-&gt;queue
)paren
r_goto
id|failed_alloc
suffix:semicolon
id|blk_queue_make_request
c_func
(paren
id|card-&gt;queue
comma
id|mm_make_request
)paren
suffix:semicolon
id|card-&gt;queue-&gt;queuedata
op_assign
id|card
suffix:semicolon
id|card-&gt;queue-&gt;unplug_fn
op_assign
id|mm_unplug_device
suffix:semicolon
id|tasklet_init
c_func
(paren
op_amp
id|card-&gt;tasklet
comma
id|process_page
comma
(paren
r_int
r_int
)paren
id|card
)paren
suffix:semicolon
id|card-&gt;check_batteries
op_assign
l_int|0
suffix:semicolon
id|mem_present
op_assign
id|readb
c_func
(paren
id|card-&gt;csr_remap
op_plus
id|MEMCTRLSTATUS_MEMORY
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|mem_present
)paren
(brace
r_case
id|MEM_128_MB
suffix:colon
id|card-&gt;mm_size
op_assign
l_int|1024
op_star
l_int|128
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MEM_256_MB
suffix:colon
id|card-&gt;mm_size
op_assign
l_int|1024
op_star
l_int|256
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MEM_512_MB
suffix:colon
id|card-&gt;mm_size
op_assign
l_int|1024
op_star
l_int|512
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MEM_1_GB
suffix:colon
id|card-&gt;mm_size
op_assign
l_int|1024
op_star
l_int|1024
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MEM_2_GB
suffix:colon
id|card-&gt;mm_size
op_assign
l_int|1024
op_star
l_int|2048
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|card-&gt;mm_size
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* Clear the LED&squot;s we control */
id|set_led
c_func
(paren
id|card
comma
id|LED_REMOVE
comma
id|LED_OFF
)paren
suffix:semicolon
id|set_led
c_func
(paren
id|card
comma
id|LED_FAULT
comma
id|LED_OFF
)paren
suffix:semicolon
id|batt_status
op_assign
id|readb
c_func
(paren
id|card-&gt;csr_remap
op_plus
id|MEMCTRLSTATUS_BATTERY
)paren
suffix:semicolon
id|card-&gt;battery
(braket
l_int|0
)braket
dot
id|good
op_assign
op_logical_neg
(paren
id|batt_status
op_amp
id|BATTERY_1_FAILURE
)paren
suffix:semicolon
id|card-&gt;battery
(braket
l_int|1
)braket
dot
id|good
op_assign
op_logical_neg
(paren
id|batt_status
op_amp
id|BATTERY_2_FAILURE
)paren
suffix:semicolon
id|card-&gt;battery
(braket
l_int|0
)braket
dot
id|last_change
op_assign
id|card-&gt;battery
(braket
l_int|1
)braket
dot
id|last_change
op_assign
id|jiffies
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;flags
op_amp
id|UM_FLAG_NO_BATT
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;MM%d: Size %d KB&bslash;n&quot;
comma
id|card-&gt;card_number
comma
id|card-&gt;mm_size
)paren
suffix:semicolon
r_else
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;MM%d: Size %d KB, Battery 1 %s (%s), Battery 2 %s (%s)&bslash;n&quot;
comma
id|card-&gt;card_number
comma
id|card-&gt;mm_size
comma
(paren
id|batt_status
op_amp
id|BATTERY_1_DISABLED
ques
c_cond
l_string|&quot;Disabled&quot;
suffix:colon
l_string|&quot;Enabled&quot;
)paren
comma
id|card-&gt;battery
(braket
l_int|0
)braket
dot
id|good
ques
c_cond
l_string|&quot;OK&quot;
suffix:colon
l_string|&quot;FAILURE&quot;
comma
(paren
id|batt_status
op_amp
id|BATTERY_2_DISABLED
ques
c_cond
l_string|&quot;Disabled&quot;
suffix:colon
l_string|&quot;Enabled&quot;
)paren
comma
id|card-&gt;battery
(braket
l_int|1
)braket
dot
id|good
ques
c_cond
l_string|&quot;OK&quot;
suffix:colon
l_string|&quot;FAILURE&quot;
)paren
suffix:semicolon
id|set_fault_to_battery_status
c_func
(paren
id|card
)paren
suffix:semicolon
)brace
id|pci_read_config_dword
c_func
(paren
id|dev
comma
id|PCI_BASE_ADDRESS_1
comma
op_amp
id|saved_bar
)paren
suffix:semicolon
id|data
op_assign
l_int|0xffffffff
suffix:semicolon
id|pci_write_config_dword
c_func
(paren
id|dev
comma
id|PCI_BASE_ADDRESS_1
comma
id|data
)paren
suffix:semicolon
id|pci_read_config_dword
c_func
(paren
id|dev
comma
id|PCI_BASE_ADDRESS_1
comma
op_amp
id|data
)paren
suffix:semicolon
id|pci_write_config_dword
c_func
(paren
id|dev
comma
id|PCI_BASE_ADDRESS_1
comma
id|saved_bar
)paren
suffix:semicolon
id|data
op_and_assign
l_int|0xfffffff0
suffix:semicolon
id|data
op_assign
op_complement
id|data
suffix:semicolon
id|data
op_add_assign
l_int|1
suffix:semicolon
id|card-&gt;win_size
op_assign
id|data
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
id|mm_interrupt
comma
id|SA_SHIRQ
comma
l_string|&quot;pci-umem&quot;
comma
id|card
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;MM%d: Unable to allocate IRQ&bslash;n&quot;
comma
id|card-&gt;card_number
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|failed_req_irq
suffix:semicolon
)brace
id|card-&gt;irq
op_assign
id|dev-&gt;irq
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;MM%d: Window size %d bytes, IRQ %d&bslash;n&quot;
comma
id|card-&gt;card_number
comma
id|card-&gt;win_size
comma
id|card-&gt;irq
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|card-&gt;lock
)paren
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|dev
comma
id|card
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_write_cmd
op_ne
l_int|0x0F
)paren
multiline_comment|/* If not Memory Write &amp; Invalidate */
id|pci_write_cmd
op_assign
l_int|0x07
suffix:semicolon
multiline_comment|/* then Memory Write command */
r_if
c_cond
(paren
id|pci_write_cmd
op_amp
l_int|0x08
)paren
(brace
multiline_comment|/* use Memory Write and Invalidate */
r_int
r_int
id|cfg_command
suffix:semicolon
id|pci_read_config_word
c_func
(paren
id|dev
comma
id|PCI_COMMAND
comma
op_amp
id|cfg_command
)paren
suffix:semicolon
id|cfg_command
op_or_assign
l_int|0x10
suffix:semicolon
multiline_comment|/* Memory Write &amp; Invalidate Enable */
id|pci_write_config_word
c_func
(paren
id|dev
comma
id|PCI_COMMAND
comma
id|cfg_command
)paren
suffix:semicolon
)brace
id|pci_cmds
op_assign
(paren
id|pci_read_cmd
op_lshift
l_int|28
)paren
op_or
(paren
id|pci_write_cmd
op_lshift
l_int|24
)paren
suffix:semicolon
id|num_cards
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|get_userbit
c_func
(paren
id|card
comma
id|MEMORY_INITIALIZED
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;MM%d: memory NOT initialized. Consider over-writing whole device.&bslash;n&quot;
comma
id|card-&gt;card_number
)paren
suffix:semicolon
id|card-&gt;init_size
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;MM%d: memory already initialized&bslash;n&quot;
comma
id|card-&gt;card_number
)paren
suffix:semicolon
id|card-&gt;init_size
op_assign
id|card-&gt;mm_size
suffix:semicolon
)brace
multiline_comment|/* Enable ECC */
id|writeb
c_func
(paren
id|EDC_STORE_CORRECT
comma
id|card-&gt;csr_remap
op_plus
id|MEMCTRLCMD_ERRCTRL
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|failed_req_irq
suffix:colon
id|failed_alloc
suffix:colon
r_if
c_cond
(paren
id|card-&gt;mm_pages
(braket
l_int|0
)braket
dot
id|desc
)paren
id|pci_free_consistent
c_func
(paren
id|card-&gt;dev
comma
id|PAGE_SIZE
op_star
l_int|2
comma
id|card-&gt;mm_pages
(braket
l_int|0
)braket
dot
id|desc
comma
id|card-&gt;mm_pages
(braket
l_int|0
)braket
dot
id|page_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;mm_pages
(braket
l_int|1
)braket
dot
id|desc
)paren
id|pci_free_consistent
c_func
(paren
id|card-&gt;dev
comma
id|PAGE_SIZE
op_star
l_int|2
comma
id|card-&gt;mm_pages
(braket
l_int|1
)braket
dot
id|desc
comma
id|card-&gt;mm_pages
(braket
l_int|1
)braket
dot
id|page_dma
)paren
suffix:semicolon
id|failed_magic
suffix:colon
macro_line|#ifdef CONFIG_MM_MAP_MEMORY
id|iounmap
c_func
(paren
(paren
r_void
op_star
)paren
id|card-&gt;mem_remap
)paren
suffix:semicolon
id|failed_remap_mem
suffix:colon
id|release_mem_region
c_func
(paren
id|card-&gt;mem_base
comma
id|card-&gt;mem_len
)paren
suffix:semicolon
id|failed_req_mem
suffix:colon
macro_line|#endif
id|iounmap
c_func
(paren
(paren
r_void
op_star
)paren
id|card-&gt;csr_remap
)paren
suffix:semicolon
id|failed_remap_csr
suffix:colon
id|release_mem_region
c_func
(paren
id|card-&gt;csr_base
comma
id|card-&gt;csr_len
)paren
suffix:semicolon
id|failed_req_csr
suffix:colon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n;-----------------------------------------------------------------------------------&n;--                              mm_pci_remove&n;-----------------------------------------------------------------------------------&n;*/
DECL|function|mm_pci_remove
r_static
r_void
id|mm_pci_remove
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
r_struct
id|cardinfo
op_star
id|card
op_assign
id|pci_get_drvdata
c_func
(paren
id|dev
)paren
suffix:semicolon
id|tasklet_kill
c_func
(paren
op_amp
id|card-&gt;tasklet
)paren
suffix:semicolon
id|iounmap
c_func
(paren
id|card-&gt;csr_remap
)paren
suffix:semicolon
id|release_mem_region
c_func
(paren
id|card-&gt;csr_base
comma
id|card-&gt;csr_len
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_MM_MAP_MEMORY
id|iounmap
c_func
(paren
id|card-&gt;mem_remap
)paren
suffix:semicolon
id|release_mem_region
c_func
(paren
id|card-&gt;mem_base
comma
id|card-&gt;mem_len
)paren
suffix:semicolon
macro_line|#endif
id|free_irq
c_func
(paren
id|card-&gt;irq
comma
id|card
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;mm_pages
(braket
l_int|0
)braket
dot
id|desc
)paren
id|pci_free_consistent
c_func
(paren
id|card-&gt;dev
comma
id|PAGE_SIZE
op_star
l_int|2
comma
id|card-&gt;mm_pages
(braket
l_int|0
)braket
dot
id|desc
comma
id|card-&gt;mm_pages
(braket
l_int|0
)braket
dot
id|page_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
id|card-&gt;mm_pages
(braket
l_int|1
)braket
dot
id|desc
)paren
id|pci_free_consistent
c_func
(paren
id|card-&gt;dev
comma
id|PAGE_SIZE
op_star
l_int|2
comma
id|card-&gt;mm_pages
(braket
l_int|1
)braket
dot
id|desc
comma
id|card-&gt;mm_pages
(braket
l_int|1
)braket
dot
id|page_dma
)paren
suffix:semicolon
id|blk_put_queue
c_func
(paren
id|card-&gt;queue
)paren
suffix:semicolon
)brace
DECL|variable|mm_pci_ids
r_static
r_const
r_struct
id|pci_device_id
id|mm_pci_ids
(braket
)braket
op_assign
(brace
(brace
dot
id|vendor
op_assign
id|PCI_VENDOR_ID_MICRO_MEMORY
comma
dot
id|device
op_assign
id|PCI_DEVICE_ID_MICRO_MEMORY_5415CN
comma
)brace
comma
(brace
dot
id|vendor
op_assign
id|PCI_VENDOR_ID_MICRO_MEMORY
comma
dot
id|device
op_assign
id|PCI_DEVICE_ID_MICRO_MEMORY_5425CN
comma
)brace
comma
(brace
dot
id|vendor
op_assign
id|PCI_VENDOR_ID_MICRO_MEMORY
comma
dot
id|device
op_assign
id|PCI_DEVICE_ID_MICRO_MEMORY_6155
comma
)brace
comma
(brace
dot
id|vendor
op_assign
l_int|0x8086
comma
dot
id|device
op_assign
l_int|0xB555
comma
dot
id|subvendor
op_assign
l_int|0x1332
comma
dot
id|subdevice
op_assign
l_int|0x5460
comma
dot
r_class
op_assign
l_int|0x050000
comma
dot
id|class_mask
op_assign
l_int|0
comma
)brace
comma
(brace
multiline_comment|/* end: all zeroes */
)brace
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|pci
comma
id|mm_pci_ids
)paren
suffix:semicolon
DECL|variable|mm_pci_driver
r_static
r_struct
id|pci_driver
id|mm_pci_driver
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;umem&quot;
comma
dot
id|id_table
op_assign
id|mm_pci_ids
comma
dot
id|probe
op_assign
id|mm_pci_probe
comma
dot
id|remove
op_assign
id|mm_pci_remove
comma
)brace
suffix:semicolon
multiline_comment|/*&n;-----------------------------------------------------------------------------------&n;--                               mm_init&n;-----------------------------------------------------------------------------------&n;*/
DECL|function|mm_init
r_int
id|__init
id|mm_init
c_func
(paren
r_void
)paren
(brace
r_int
id|retval
comma
id|i
suffix:semicolon
r_int
id|err
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
id|DRIVER_VERSION
l_string|&quot; : &quot;
id|DRIVER_DESC
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|retval
op_assign
id|pci_module_init
c_func
(paren
op_amp
id|mm_pci_driver
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|err
op_assign
id|major_nr
op_assign
id|register_blkdev
c_func
(paren
l_int|0
comma
l_string|&quot;umem&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_cards
suffix:semicolon
id|i
op_increment
)paren
(brace
id|mm_gendisk
(braket
id|i
)braket
op_assign
id|alloc_disk
c_func
(paren
l_int|1
op_lshift
id|MM_SHIFT
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mm_gendisk
(braket
id|i
)braket
)paren
r_goto
id|out
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_cards
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|gendisk
op_star
id|disk
op_assign
id|mm_gendisk
(braket
id|i
)braket
suffix:semicolon
id|sprintf
c_func
(paren
id|disk-&gt;disk_name
comma
l_string|&quot;umem%c&quot;
comma
l_char|&squot;a&squot;
op_plus
id|i
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|disk-&gt;devfs_name
comma
l_string|&quot;umem/card%d&quot;
comma
id|i
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|cards
(braket
id|i
)braket
dot
id|lock
)paren
suffix:semicolon
id|disk-&gt;major
op_assign
id|major_nr
suffix:semicolon
id|disk-&gt;first_minor
op_assign
id|i
op_lshift
id|MM_SHIFT
suffix:semicolon
id|disk-&gt;fops
op_assign
op_amp
id|mm_fops
suffix:semicolon
id|disk-&gt;private_data
op_assign
op_amp
id|cards
(braket
id|i
)braket
suffix:semicolon
id|disk-&gt;queue
op_assign
id|cards
(braket
id|i
)braket
dot
id|queue
suffix:semicolon
id|set_capacity
c_func
(paren
id|disk
comma
id|cards
(braket
id|i
)braket
dot
id|mm_size
op_lshift
l_int|1
)paren
suffix:semicolon
id|add_disk
c_func
(paren
id|disk
)paren
suffix:semicolon
)brace
id|init_battery_timer
c_func
(paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;MM: desc_per_page = %ld&bslash;n&quot;
comma
id|DESC_PER_PAGE
)paren
suffix:semicolon
multiline_comment|/* printk(&quot;mm_init: Done. 10-19-01 9:00&bslash;n&quot;); */
r_return
l_int|0
suffix:semicolon
id|out
suffix:colon
id|unregister_blkdev
c_func
(paren
id|major_nr
comma
l_string|&quot;umem&quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
id|i
op_decrement
)paren
id|put_disk
c_func
(paren
id|mm_gendisk
(braket
id|i
)braket
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/*&n;-----------------------------------------------------------------------------------&n;--                             mm_cleanup&n;-----------------------------------------------------------------------------------&n;*/
DECL|function|mm_cleanup
r_void
id|__exit
id|mm_cleanup
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|del_battery_timer
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|num_cards
suffix:semicolon
id|i
op_increment
)paren
(brace
id|del_gendisk
c_func
(paren
id|mm_gendisk
(braket
id|i
)braket
)paren
suffix:semicolon
id|put_disk
c_func
(paren
id|mm_gendisk
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|pci_unregister_driver
c_func
(paren
op_amp
id|mm_pci_driver
)paren
suffix:semicolon
id|unregister_blkdev
c_func
(paren
id|major_nr
comma
l_string|&quot;umem&quot;
)paren
suffix:semicolon
)brace
DECL|variable|mm_init
id|module_init
c_func
(paren
id|mm_init
)paren
suffix:semicolon
DECL|variable|mm_cleanup
id|module_exit
c_func
(paren
id|mm_cleanup
)paren
suffix:semicolon
DECL|variable|DRIVER_AUTHOR
id|MODULE_AUTHOR
c_func
(paren
id|DRIVER_AUTHOR
)paren
suffix:semicolon
DECL|variable|DRIVER_DESC
id|MODULE_DESCRIPTION
c_func
(paren
id|DRIVER_DESC
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
eof
