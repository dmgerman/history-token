multiline_comment|/*&n; *  linux/drivers/block/loop.c&n; *&n; *  Written by Theodore Ts&squot;o, 3/29/93&n; * &n; * Copyright 1993 by Theodore Ts&squot;o.  Redistribution of this file is&n; * permitted under the GNU General Public License.&n; *&n; * DES encryption plus some minor changes by Werner Almesberger, 30-MAY-1993&n; * more DES encryption plus IDEA encryption by Nicholas J. Leon, June 20, 1996&n; *&n; * Modularized and updated for 1.1.16 kernel - Mitch Dsouza 28th May 1994&n; * Adapted for 1.3.59 kernel - Andries Brouwer, 1 Feb 1996&n; *&n; * Fixed do_loop_request() re-entrancy - Vincent.Renardias@waw.com Mar 20, 1997&n; *&n; * Added devfs support - Richard Gooch &lt;rgooch@atnf.csiro.au&gt; 16-Jan-1998&n; *&n; * Handle sparse backing files correctly - Kenn Humborg, Jun 28, 1998&n; *&n; * Loadable modules and other fixes by AK, 1998&n; *&n; * Make real block number available to downstream transfer functions, enables&n; * CBC (and relatives) mode encryption requiring unique IVs per data block. &n; * Reed H. Petty, rhp@draper.net&n; *&n; * Maximum number of loop devices now dynamic via max_loop module parameter.&n; * Russell Kroll &lt;rkroll@exploits.org&gt; 19990701&n; * &n; * Maximum number of loop devices when compiled-in now selectable by passing&n; * max_loop=&lt;1-255&gt; to the kernel on boot.&n; * Erik I. Bols&#xfffd;, &lt;eriki@himolde.no&gt;, Oct 31, 1999&n; *&n; * Completely rewrite request handling to be make_request_fn style and&n; * non blocking, pushing work to a helper thread. Lots of fixes from&n; * Al Viro too.&n; * Jens Axboe &lt;axboe@suse.de&gt;, Nov 2000&n; *&n; * Still To Fix:&n; * - Advisory locking is ignored here. &n; * - Should use an own CAP_* category instead of CAP_SYS_ADMIN &n; *&n; * WARNING/FIXME:&n; * - The block number as IV passing to low level transfer functions is broken:&n; *   it passes the underlying device&squot;s block number instead of the&n; *   offset. This makes it change for a given block when the file is &n; *   moved/restored/copied and also doesn&squot;t work over NFS. &n; * AV, Feb 12, 2000: we pass the logical block number now. It fixes the&n; *   problem above. Encryption modules that used to rely on the old scheme&n; *   should just call -&gt;i_mapping-&gt;bmap() to calculate the physical block&n; *   number.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/file.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/major.h&gt;
macro_line|#include &lt;linux/wait.h&gt;
macro_line|#include &lt;linux/blk.h&gt;
macro_line|#include &lt;linux/blkpg.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/devfs_fs_kernel.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/swap.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/loop.h&gt;&t;&t;
DECL|macro|MAJOR_NR
mdefine_line|#define MAJOR_NR LOOP_MAJOR
DECL|variable|max_loop
r_static
r_int
id|max_loop
op_assign
l_int|8
suffix:semicolon
DECL|variable|loop_dev
r_static
r_struct
id|loop_device
op_star
id|loop_dev
suffix:semicolon
DECL|variable|loop_sizes
r_static
r_int
op_star
id|loop_sizes
suffix:semicolon
DECL|variable|loop_blksizes
r_static
r_int
op_star
id|loop_blksizes
suffix:semicolon
DECL|variable|devfs_handle
r_static
id|devfs_handle_t
id|devfs_handle
suffix:semicolon
multiline_comment|/*  For the directory */
multiline_comment|/*&n; * Transfer functions&n; */
DECL|function|transfer_none
r_static
r_int
id|transfer_none
c_func
(paren
r_struct
id|loop_device
op_star
id|lo
comma
r_int
id|cmd
comma
r_char
op_star
id|raw_buf
comma
r_char
op_star
id|loop_buf
comma
r_int
id|size
comma
r_int
id|real_block
)paren
(brace
r_if
c_cond
(paren
id|raw_buf
op_ne
id|loop_buf
)paren
(brace
r_if
c_cond
(paren
id|cmd
op_eq
id|READ
)paren
id|memcpy
c_func
(paren
id|loop_buf
comma
id|raw_buf
comma
id|size
)paren
suffix:semicolon
r_else
id|memcpy
c_func
(paren
id|raw_buf
comma
id|loop_buf
comma
id|size
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|transfer_xor
r_static
r_int
id|transfer_xor
c_func
(paren
r_struct
id|loop_device
op_star
id|lo
comma
r_int
id|cmd
comma
r_char
op_star
id|raw_buf
comma
r_char
op_star
id|loop_buf
comma
r_int
id|size
comma
r_int
id|real_block
)paren
(brace
r_char
op_star
id|in
comma
op_star
id|out
comma
op_star
id|key
suffix:semicolon
r_int
id|i
comma
id|keysize
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_eq
id|READ
)paren
(brace
id|in
op_assign
id|raw_buf
suffix:semicolon
id|out
op_assign
id|loop_buf
suffix:semicolon
)brace
r_else
(brace
id|in
op_assign
id|loop_buf
suffix:semicolon
id|out
op_assign
id|raw_buf
suffix:semicolon
)brace
id|key
op_assign
id|lo-&gt;lo_encrypt_key
suffix:semicolon
id|keysize
op_assign
id|lo-&gt;lo_encrypt_key_size
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|size
suffix:semicolon
id|i
op_increment
)paren
op_star
id|out
op_increment
op_assign
op_star
id|in
op_increment
op_xor
id|key
(braket
(paren
id|i
op_amp
l_int|511
)paren
op_mod
id|keysize
)braket
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|none_status
r_static
r_int
id|none_status
c_func
(paren
r_struct
id|loop_device
op_star
id|lo
comma
r_struct
id|loop_info
op_star
id|info
)paren
(brace
id|lo-&gt;lo_flags
op_or_assign
id|LO_FLAGS_BH_REMAP
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|xor_status
r_static
r_int
id|xor_status
c_func
(paren
r_struct
id|loop_device
op_star
id|lo
comma
r_struct
id|loop_info
op_star
id|info
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;lo_encrypt_key_size
op_le
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|none_funcs
r_struct
id|loop_func_table
id|none_funcs
op_assign
(brace
id|number
suffix:colon
id|LO_CRYPT_NONE
comma
id|transfer
suffix:colon
id|transfer_none
comma
id|init
suffix:colon
id|none_status
comma
)brace
suffix:semicolon
DECL|variable|xor_funcs
r_struct
id|loop_func_table
id|xor_funcs
op_assign
(brace
id|number
suffix:colon
id|LO_CRYPT_XOR
comma
id|transfer
suffix:colon
id|transfer_xor
comma
id|init
suffix:colon
id|xor_status
)brace
suffix:semicolon
multiline_comment|/* xfer_funcs[0] is special - its release function is never called */
DECL|variable|xfer_funcs
r_struct
id|loop_func_table
op_star
id|xfer_funcs
(braket
id|MAX_LO_CRYPT
)braket
op_assign
(brace
op_amp
id|none_funcs
comma
op_amp
id|xor_funcs
)brace
suffix:semicolon
DECL|macro|MAX_DISK_SIZE
mdefine_line|#define MAX_DISK_SIZE 1024*1024*1024
DECL|function|compute_loop_size
r_static
r_int
r_int
id|compute_loop_size
c_func
(paren
r_struct
id|loop_device
op_star
id|lo
comma
r_struct
id|dentry
op_star
id|lo_dentry
comma
id|kdev_t
id|lodev
)paren
(brace
r_if
c_cond
(paren
id|S_ISREG
c_func
(paren
id|lo_dentry-&gt;d_inode-&gt;i_mode
)paren
)paren
r_return
(paren
id|lo_dentry-&gt;d_inode-&gt;i_size
op_minus
id|lo-&gt;lo_offset
)paren
op_rshift
id|BLOCK_SIZE_BITS
suffix:semicolon
r_if
c_cond
(paren
id|blk_size
(braket
id|MAJOR
c_func
(paren
id|lodev
)paren
)braket
)paren
r_return
id|blk_size
(braket
id|MAJOR
c_func
(paren
id|lodev
)paren
)braket
(braket
id|MINOR
c_func
(paren
id|lodev
)paren
)braket
op_minus
(paren
id|lo-&gt;lo_offset
op_rshift
id|BLOCK_SIZE_BITS
)paren
suffix:semicolon
r_return
id|MAX_DISK_SIZE
suffix:semicolon
)brace
DECL|function|figure_loop_size
r_static
r_void
id|figure_loop_size
c_func
(paren
r_struct
id|loop_device
op_star
id|lo
)paren
(brace
id|loop_sizes
(braket
id|lo-&gt;lo_number
)braket
op_assign
id|compute_loop_size
c_func
(paren
id|lo
comma
id|lo-&gt;lo_backing_file-&gt;f_dentry
comma
id|lo-&gt;lo_device
)paren
suffix:semicolon
)brace
DECL|function|lo_send
r_static
r_int
id|lo_send
c_func
(paren
r_struct
id|loop_device
op_star
id|lo
comma
r_struct
id|bio
op_star
id|bio
comma
r_int
id|bsize
comma
id|loff_t
id|pos
)paren
(brace
r_struct
id|file
op_star
id|file
op_assign
id|lo-&gt;lo_backing_file
suffix:semicolon
multiline_comment|/* kudos to NFsckingS */
r_struct
id|address_space
op_star
id|mapping
op_assign
id|file-&gt;f_dentry-&gt;d_inode-&gt;i_mapping
suffix:semicolon
r_struct
id|address_space_operations
op_star
id|aops
op_assign
id|mapping-&gt;a_ops
suffix:semicolon
r_struct
id|page
op_star
id|page
suffix:semicolon
r_char
op_star
id|kaddr
comma
op_star
id|data
suffix:semicolon
r_int
r_int
id|index
suffix:semicolon
r_int
id|size
comma
id|offset
suffix:semicolon
r_int
id|len
suffix:semicolon
id|down
c_func
(paren
op_amp
id|mapping-&gt;host-&gt;i_sem
)paren
suffix:semicolon
id|index
op_assign
id|pos
op_rshift
id|PAGE_CACHE_SHIFT
suffix:semicolon
id|offset
op_assign
id|pos
op_amp
(paren
id|PAGE_CACHE_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
id|len
op_assign
id|bio-&gt;bi_size
suffix:semicolon
id|data
op_assign
id|bio_data
c_func
(paren
id|bio
)paren
suffix:semicolon
r_while
c_loop
(paren
id|len
OG
l_int|0
)paren
(brace
r_int
id|IV
op_assign
id|index
op_star
(paren
id|PAGE_CACHE_SIZE
op_div
id|bsize
)paren
op_plus
id|offset
op_div
id|bsize
suffix:semicolon
r_int
id|transfer_result
suffix:semicolon
id|size
op_assign
id|PAGE_CACHE_SIZE
op_minus
id|offset
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
id|len
)paren
id|size
op_assign
id|len
suffix:semicolon
id|page
op_assign
id|grab_cache_page
c_func
(paren
id|mapping
comma
id|index
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|page
)paren
r_goto
id|fail
suffix:semicolon
r_if
c_cond
(paren
id|aops
op_member_access_from_pointer
id|prepare_write
c_func
(paren
id|file
comma
id|page
comma
id|offset
comma
id|offset
op_plus
id|size
)paren
)paren
r_goto
id|unlock
suffix:semicolon
id|kaddr
op_assign
id|page_address
c_func
(paren
id|page
)paren
suffix:semicolon
id|flush_dcache_page
c_func
(paren
id|page
)paren
suffix:semicolon
id|transfer_result
op_assign
id|lo_do_transfer
c_func
(paren
id|lo
comma
id|WRITE
comma
id|kaddr
op_plus
id|offset
comma
id|data
comma
id|size
comma
id|IV
)paren
suffix:semicolon
r_if
c_cond
(paren
id|transfer_result
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * The transfer failed, but we still write the data to&n;&t;&t;&t; * keep prepare/commit calls balanced.&n;&t;&t;&t; */
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;loop: transfer error block %ld&bslash;n&quot;
comma
id|index
)paren
suffix:semicolon
id|memset
c_func
(paren
id|kaddr
op_plus
id|offset
comma
l_int|0
comma
id|size
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|aops
op_member_access_from_pointer
id|commit_write
c_func
(paren
id|file
comma
id|page
comma
id|offset
comma
id|offset
op_plus
id|size
)paren
)paren
r_goto
id|unlock
suffix:semicolon
r_if
c_cond
(paren
id|transfer_result
)paren
r_goto
id|unlock
suffix:semicolon
id|data
op_add_assign
id|size
suffix:semicolon
id|len
op_sub_assign
id|size
suffix:semicolon
id|offset
op_assign
l_int|0
suffix:semicolon
id|index
op_increment
suffix:semicolon
id|pos
op_add_assign
id|size
suffix:semicolon
id|UnlockPage
c_func
(paren
id|page
)paren
suffix:semicolon
id|page_cache_release
c_func
(paren
id|page
)paren
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|mapping-&gt;host-&gt;i_sem
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|unlock
suffix:colon
id|UnlockPage
c_func
(paren
id|page
)paren
suffix:semicolon
id|page_cache_release
c_func
(paren
id|page
)paren
suffix:semicolon
id|fail
suffix:colon
id|up
c_func
(paren
op_amp
id|mapping-&gt;host-&gt;i_sem
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
DECL|struct|lo_read_data
r_struct
id|lo_read_data
(brace
DECL|member|lo
r_struct
id|loop_device
op_star
id|lo
suffix:semicolon
DECL|member|data
r_char
op_star
id|data
suffix:semicolon
DECL|member|bsize
r_int
id|bsize
suffix:semicolon
)brace
suffix:semicolon
DECL|function|lo_read_actor
r_static
r_int
id|lo_read_actor
c_func
(paren
id|read_descriptor_t
op_star
id|desc
comma
r_struct
id|page
op_star
id|page
comma
r_int
r_int
id|offset
comma
r_int
r_int
id|size
)paren
(brace
r_char
op_star
id|kaddr
suffix:semicolon
r_int
r_int
id|count
op_assign
id|desc-&gt;count
suffix:semicolon
r_struct
id|lo_read_data
op_star
id|p
op_assign
(paren
r_struct
id|lo_read_data
op_star
)paren
id|desc-&gt;buf
suffix:semicolon
r_struct
id|loop_device
op_star
id|lo
op_assign
id|p-&gt;lo
suffix:semicolon
r_int
id|IV
op_assign
id|page-&gt;index
op_star
(paren
id|PAGE_CACHE_SIZE
op_div
id|p-&gt;bsize
)paren
op_plus
id|offset
op_div
id|p-&gt;bsize
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
id|count
)paren
id|size
op_assign
id|count
suffix:semicolon
id|kaddr
op_assign
id|kmap
c_func
(paren
id|page
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lo_do_transfer
c_func
(paren
id|lo
comma
id|READ
comma
id|kaddr
op_plus
id|offset
comma
id|p-&gt;data
comma
id|size
comma
id|IV
)paren
)paren
(brace
id|size
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;loop: transfer error block %ld&bslash;n&quot;
comma
id|page-&gt;index
)paren
suffix:semicolon
id|desc-&gt;error
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
id|kunmap
c_func
(paren
id|page
)paren
suffix:semicolon
id|desc-&gt;count
op_assign
id|count
op_minus
id|size
suffix:semicolon
id|desc-&gt;written
op_add_assign
id|size
suffix:semicolon
id|p-&gt;data
op_add_assign
id|size
suffix:semicolon
r_return
id|size
suffix:semicolon
)brace
DECL|function|lo_receive
r_static
r_int
id|lo_receive
c_func
(paren
r_struct
id|loop_device
op_star
id|lo
comma
r_struct
id|bio
op_star
id|bio
comma
r_int
id|bsize
comma
id|loff_t
id|pos
)paren
(brace
r_struct
id|lo_read_data
id|cookie
suffix:semicolon
id|read_descriptor_t
id|desc
suffix:semicolon
r_struct
id|file
op_star
id|file
suffix:semicolon
id|cookie.lo
op_assign
id|lo
suffix:semicolon
id|cookie.data
op_assign
id|bio_data
c_func
(paren
id|bio
)paren
suffix:semicolon
id|cookie.bsize
op_assign
id|bsize
suffix:semicolon
id|desc.written
op_assign
l_int|0
suffix:semicolon
id|desc.count
op_assign
id|bio-&gt;bi_size
suffix:semicolon
id|desc.buf
op_assign
(paren
r_char
op_star
)paren
op_amp
id|cookie
suffix:semicolon
id|desc.error
op_assign
l_int|0
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|lo-&gt;lo_lock
)paren
suffix:semicolon
id|file
op_assign
id|lo-&gt;lo_backing_file
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|lo-&gt;lo_lock
)paren
suffix:semicolon
id|do_generic_file_read
c_func
(paren
id|file
comma
op_amp
id|pos
comma
op_amp
id|desc
comma
id|lo_read_actor
)paren
suffix:semicolon
r_return
id|desc.error
suffix:semicolon
)brace
DECL|function|loop_get_bs
r_static
r_inline
r_int
id|loop_get_bs
c_func
(paren
r_struct
id|loop_device
op_star
id|lo
)paren
(brace
r_int
id|bs
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|blksize_size
(braket
id|MAJOR
c_func
(paren
id|lo-&gt;lo_device
)paren
)braket
)paren
id|bs
op_assign
id|blksize_size
(braket
id|MAJOR
c_func
(paren
id|lo-&gt;lo_device
)paren
)braket
(braket
id|MINOR
c_func
(paren
id|lo-&gt;lo_device
)paren
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bs
)paren
id|bs
op_assign
id|BLOCK_SIZE
suffix:semicolon
r_return
id|bs
suffix:semicolon
)brace
DECL|function|loop_get_iv
r_static
r_inline
r_int
r_int
id|loop_get_iv
c_func
(paren
r_struct
id|loop_device
op_star
id|lo
comma
r_int
r_int
id|sector
)paren
(brace
r_int
id|bs
op_assign
id|loop_get_bs
c_func
(paren
id|lo
)paren
suffix:semicolon
r_int
r_int
id|offset
comma
id|IV
suffix:semicolon
id|IV
op_assign
id|sector
op_div
(paren
id|bs
op_rshift
l_int|9
)paren
op_plus
id|lo-&gt;lo_offset
op_div
id|bs
suffix:semicolon
id|offset
op_assign
(paren
(paren
id|sector
op_mod
(paren
id|bs
op_rshift
l_int|9
)paren
)paren
op_lshift
l_int|9
)paren
op_plus
id|lo-&gt;lo_offset
op_mod
id|bs
suffix:semicolon
r_if
c_cond
(paren
id|offset
op_ge
id|bs
)paren
id|IV
op_increment
suffix:semicolon
r_return
id|IV
suffix:semicolon
)brace
DECL|function|do_bio_filebacked
r_static
r_int
id|do_bio_filebacked
c_func
(paren
r_struct
id|loop_device
op_star
id|lo
comma
r_struct
id|bio
op_star
id|bio
)paren
(brace
id|loff_t
id|pos
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|pos
op_assign
(paren
(paren
id|loff_t
)paren
id|bio-&gt;bi_sector
op_lshift
l_int|9
)paren
op_plus
id|lo-&gt;lo_offset
suffix:semicolon
r_do
(brace
r_if
c_cond
(paren
id|bio_rw
c_func
(paren
id|bio
)paren
op_eq
id|WRITE
)paren
id|ret
op_assign
id|lo_send
c_func
(paren
id|lo
comma
id|bio
comma
id|loop_get_bs
c_func
(paren
id|lo
)paren
comma
id|pos
)paren
suffix:semicolon
r_else
id|ret
op_assign
id|lo_receive
c_func
(paren
id|lo
comma
id|bio
comma
id|loop_get_bs
c_func
(paren
id|lo
)paren
comma
id|pos
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
op_increment
id|bio-&gt;bi_idx
OL
id|bio-&gt;bi_vcnt
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
r_static
r_int
id|loop_end_io_transfer
c_func
(paren
r_struct
id|bio
op_star
comma
r_int
)paren
suffix:semicolon
DECL|function|loop_put_buffer
r_static
r_void
id|loop_put_buffer
c_func
(paren
r_struct
id|bio
op_star
id|bio
)paren
(brace
multiline_comment|/*&n;&t; * check bi_end_io, may just be a remapped bio&n;&t; */
r_if
c_cond
(paren
id|bio
op_logical_and
id|bio-&gt;bi_end_io
op_eq
id|loop_end_io_transfer
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|bio-&gt;bi_vcnt
suffix:semicolon
id|i
op_increment
)paren
id|__free_page
c_func
(paren
id|bio-&gt;bi_io_vec
(braket
id|i
)braket
dot
id|bv_page
)paren
suffix:semicolon
id|bio_put
c_func
(paren
id|bio
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Add bio to back of pending list&n; */
DECL|function|loop_add_bio
r_static
r_void
id|loop_add_bio
c_func
(paren
r_struct
id|loop_device
op_star
id|lo
comma
r_struct
id|bio
op_star
id|bio
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|lo-&gt;lo_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lo-&gt;lo_biotail
)paren
(brace
id|lo-&gt;lo_biotail-&gt;bi_next
op_assign
id|bio
suffix:semicolon
id|lo-&gt;lo_biotail
op_assign
id|bio
suffix:semicolon
)brace
r_else
id|lo-&gt;lo_bio
op_assign
id|lo-&gt;lo_biotail
op_assign
id|bio
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|lo-&gt;lo_lock
comma
id|flags
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|lo-&gt;lo_bh_mutex
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Grab first pending buffer&n; */
DECL|function|loop_get_bio
r_static
r_struct
id|bio
op_star
id|loop_get_bio
c_func
(paren
r_struct
id|loop_device
op_star
id|lo
)paren
(brace
r_struct
id|bio
op_star
id|bio
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|lo-&gt;lo_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|bio
op_assign
id|lo-&gt;lo_bio
)paren
)paren
(brace
r_if
c_cond
(paren
id|bio
op_eq
id|lo-&gt;lo_biotail
)paren
id|lo-&gt;lo_biotail
op_assign
l_int|NULL
suffix:semicolon
id|lo-&gt;lo_bio
op_assign
id|bio-&gt;bi_next
suffix:semicolon
id|bio-&gt;bi_next
op_assign
l_int|NULL
suffix:semicolon
)brace
id|spin_unlock_irq
c_func
(paren
op_amp
id|lo-&gt;lo_lock
)paren
suffix:semicolon
r_return
id|bio
suffix:semicolon
)brace
multiline_comment|/*&n; * if this was a WRITE lo-&gt;transfer stuff has already been done. for READs,&n; * queue it for the loop thread and let it do the transfer out of&n; * bi_end_io context (we don&squot;t want to do decrypt of a page with irqs&n; * disabled)&n; */
DECL|function|loop_end_io_transfer
r_static
r_int
id|loop_end_io_transfer
c_func
(paren
r_struct
id|bio
op_star
id|bio
comma
r_int
id|nr_sectors
)paren
(brace
r_struct
id|loop_device
op_star
id|lo
op_assign
op_amp
id|loop_dev
(braket
id|MINOR
c_func
(paren
id|bio-&gt;bi_dev
)paren
)braket
suffix:semicolon
r_int
id|uptodate
op_assign
id|test_bit
c_func
(paren
id|BIO_UPTODATE
comma
op_amp
id|bio-&gt;bi_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|uptodate
op_logical_or
id|bio_rw
c_func
(paren
id|bio
)paren
op_eq
id|WRITE
)paren
(brace
r_struct
id|bio
op_star
id|rbh
op_assign
id|bio-&gt;bi_private
suffix:semicolon
id|bio_endio
c_func
(paren
id|rbh
comma
id|uptodate
comma
id|nr_sectors
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_dec_and_test
c_func
(paren
op_amp
id|lo-&gt;lo_pending
)paren
)paren
id|up
c_func
(paren
op_amp
id|lo-&gt;lo_bh_mutex
)paren
suffix:semicolon
id|loop_put_buffer
c_func
(paren
id|bio
)paren
suffix:semicolon
)brace
r_else
id|loop_add_bio
c_func
(paren
id|lo
comma
id|bio
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|loop_get_buffer
r_static
r_struct
id|bio
op_star
id|loop_get_buffer
c_func
(paren
r_struct
id|loop_device
op_star
id|lo
comma
r_struct
id|bio
op_star
id|rbh
)paren
(brace
r_struct
id|bio
op_star
id|bio
suffix:semicolon
multiline_comment|/*&n;&t; * for xfer_funcs that can operate on the same bh, do that&n;&t; */
r_if
c_cond
(paren
id|lo-&gt;lo_flags
op_amp
id|LO_FLAGS_BH_REMAP
)paren
(brace
id|bio
op_assign
id|rbh
suffix:semicolon
r_goto
id|out_bh
suffix:semicolon
)brace
id|bio
op_assign
id|bio_copy
c_func
(paren
id|rbh
comma
id|GFP_NOIO
comma
id|rbh-&gt;bi_rw
op_amp
id|WRITE
)paren
suffix:semicolon
id|bio-&gt;bi_end_io
op_assign
id|loop_end_io_transfer
suffix:semicolon
id|bio-&gt;bi_private
op_assign
id|rbh
suffix:semicolon
id|out_bh
suffix:colon
id|bio-&gt;bi_sector
op_assign
id|rbh-&gt;bi_sector
op_plus
(paren
id|lo-&gt;lo_offset
op_rshift
l_int|9
)paren
suffix:semicolon
id|bio-&gt;bi_rw
op_assign
id|rbh-&gt;bi_rw
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|lo-&gt;lo_lock
)paren
suffix:semicolon
id|bio-&gt;bi_dev
op_assign
id|lo-&gt;lo_device
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|lo-&gt;lo_lock
)paren
suffix:semicolon
r_return
id|bio
suffix:semicolon
)brace
DECL|function|loop_make_request
r_static
r_int
id|loop_make_request
c_func
(paren
id|request_queue_t
op_star
id|q
comma
r_struct
id|bio
op_star
id|rbh
)paren
(brace
r_struct
id|bio
op_star
id|bh
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|loop_device
op_star
id|lo
suffix:semicolon
r_int
r_int
id|IV
suffix:semicolon
r_int
id|rw
op_assign
id|bio_rw
c_func
(paren
id|rbh
)paren
suffix:semicolon
r_if
c_cond
(paren
id|MINOR
c_func
(paren
id|rbh-&gt;bi_dev
)paren
op_ge
id|max_loop
)paren
r_goto
id|out
suffix:semicolon
id|lo
op_assign
op_amp
id|loop_dev
(braket
id|MINOR
c_func
(paren
id|rbh-&gt;bi_dev
)paren
)braket
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|lo-&gt;lo_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lo-&gt;lo_state
op_ne
id|Lo_bound
)paren
r_goto
id|inactive
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|lo-&gt;lo_pending
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|lo-&gt;lo_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rw
op_eq
id|WRITE
)paren
(brace
r_if
c_cond
(paren
id|lo-&gt;lo_flags
op_amp
id|LO_FLAGS_READ_ONLY
)paren
r_goto
id|err
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|rw
op_eq
id|READA
)paren
(brace
id|rw
op_assign
id|READ
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|rw
op_ne
id|READ
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;loop: unknown command (%x)&bslash;n&quot;
comma
id|rw
)paren
suffix:semicolon
r_goto
id|err
suffix:semicolon
)brace
id|blk_queue_bounce
c_func
(paren
id|q
comma
op_amp
id|rbh
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * file backed, queue for loop_thread to handle&n;&t; */
r_if
c_cond
(paren
id|lo-&gt;lo_flags
op_amp
id|LO_FLAGS_DO_BMAP
)paren
(brace
id|loop_add_bio
c_func
(paren
id|lo
comma
id|rbh
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * piggy old buffer on original, and submit for I/O&n;&t; */
id|bh
op_assign
id|loop_get_buffer
c_func
(paren
id|lo
comma
id|rbh
)paren
suffix:semicolon
id|IV
op_assign
id|loop_get_iv
c_func
(paren
id|lo
comma
id|rbh-&gt;bi_sector
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rw
op_eq
id|WRITE
)paren
(brace
r_if
c_cond
(paren
id|lo_do_transfer
c_func
(paren
id|lo
comma
id|WRITE
comma
id|bio_data
c_func
(paren
id|bh
)paren
comma
id|bio_data
c_func
(paren
id|rbh
)paren
comma
id|bh-&gt;bi_size
comma
id|IV
)paren
)paren
r_goto
id|err
suffix:semicolon
)brace
id|generic_make_request
c_func
(paren
id|bh
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|err
suffix:colon
r_if
c_cond
(paren
id|atomic_dec_and_test
c_func
(paren
op_amp
id|lo-&gt;lo_pending
)paren
)paren
id|up
c_func
(paren
op_amp
id|lo-&gt;lo_bh_mutex
)paren
suffix:semicolon
id|loop_put_buffer
c_func
(paren
id|bh
)paren
suffix:semicolon
id|out
suffix:colon
id|bio_io_error
c_func
(paren
id|rbh
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|inactive
suffix:colon
id|spin_unlock_irq
c_func
(paren
op_amp
id|lo-&gt;lo_lock
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
DECL|function|do_bio_blockbacked
r_static
r_int
id|do_bio_blockbacked
c_func
(paren
r_struct
id|loop_device
op_star
id|lo
comma
r_struct
id|bio
op_star
id|bio
comma
r_struct
id|bio
op_star
id|rbh
)paren
(brace
r_int
r_int
id|IV
op_assign
id|loop_get_iv
c_func
(paren
id|lo
comma
id|rbh-&gt;bi_sector
)paren
suffix:semicolon
r_struct
id|bio_vec
op_star
id|to
suffix:semicolon
r_char
op_star
id|vto
comma
op_star
id|vfrom
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
comma
id|i
suffix:semicolon
id|bio_for_each_segment
c_func
(paren
id|to
comma
id|bio
comma
id|i
)paren
(brace
id|vfrom
op_assign
id|page_address
c_func
(paren
id|rbh-&gt;bi_io_vec
(braket
id|i
)braket
dot
id|bv_page
)paren
op_plus
id|rbh-&gt;bi_io_vec
(braket
id|i
)braket
dot
id|bv_offset
suffix:semicolon
id|vto
op_assign
id|page_address
c_func
(paren
id|to-&gt;bv_page
)paren
op_plus
id|to-&gt;bv_offset
suffix:semicolon
id|ret
op_or_assign
id|lo_do_transfer
c_func
(paren
id|lo
comma
id|bio_data_dir
c_func
(paren
id|bio
)paren
comma
id|vto
comma
id|vfrom
comma
id|to-&gt;bv_len
comma
id|IV
)paren
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|function|loop_handle_bio
r_static
r_inline
r_void
id|loop_handle_bio
c_func
(paren
r_struct
id|loop_device
op_star
id|lo
comma
r_struct
id|bio
op_star
id|bio
)paren
(brace
r_int
id|ret
suffix:semicolon
multiline_comment|/*&n;&t; * For block backed loop, we know this is a READ&n;&t; */
r_if
c_cond
(paren
id|lo-&gt;lo_flags
op_amp
id|LO_FLAGS_DO_BMAP
)paren
(brace
id|ret
op_assign
id|do_bio_filebacked
c_func
(paren
id|lo
comma
id|bio
)paren
suffix:semicolon
id|bio_endio
c_func
(paren
id|bio
comma
op_logical_neg
id|ret
comma
id|bio_sectors
c_func
(paren
id|bio
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
r_struct
id|bio
op_star
id|rbh
op_assign
id|bio-&gt;bi_private
suffix:semicolon
id|ret
op_assign
id|do_bio_blockbacked
c_func
(paren
id|lo
comma
id|bio
comma
id|rbh
)paren
suffix:semicolon
id|bio_endio
c_func
(paren
id|rbh
comma
op_logical_neg
id|ret
comma
id|bio_sectors
c_func
(paren
id|bio
)paren
)paren
suffix:semicolon
id|loop_put_buffer
c_func
(paren
id|bio
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * worker thread that handles reads/writes to file backed loop devices,&n; * to avoid blocking in our make_request_fn. it also does loop decrypting&n; * on reads for block backed loop, as that is too heavy to do from&n; * b_end_io context where irqs may be disabled.&n; */
DECL|function|loop_thread
r_static
r_int
id|loop_thread
c_func
(paren
r_void
op_star
id|data
)paren
(brace
r_struct
id|loop_device
op_star
id|lo
op_assign
id|data
suffix:semicolon
r_struct
id|bio
op_star
id|bio
suffix:semicolon
id|daemonize
c_func
(paren
)paren
suffix:semicolon
id|exit_files
c_func
(paren
id|current
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|current-&gt;comm
comma
l_string|&quot;loop%d&quot;
comma
id|lo-&gt;lo_number
)paren
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|current-&gt;sigmask_lock
)paren
suffix:semicolon
id|sigfillset
c_func
(paren
op_amp
id|current-&gt;blocked
)paren
suffix:semicolon
id|flush_signals
c_func
(paren
id|current
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|current-&gt;sigmask_lock
)paren
suffix:semicolon
id|current-&gt;policy
op_assign
id|SCHED_OTHER
suffix:semicolon
id|current-&gt;nice
op_assign
op_minus
l_int|20
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|lo-&gt;lo_lock
)paren
suffix:semicolon
id|lo-&gt;lo_state
op_assign
id|Lo_bound
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|lo-&gt;lo_pending
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|lo-&gt;lo_lock
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * up sem, we are running&n;&t; */
id|up
c_func
(paren
op_amp
id|lo-&gt;lo_sem
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|down_interruptible
c_func
(paren
op_amp
id|lo-&gt;lo_bh_mutex
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * could be upped because of tear-down, not because of&n;&t;&t; * pending work&n;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
id|atomic_read
c_func
(paren
op_amp
id|lo-&gt;lo_pending
)paren
)paren
r_break
suffix:semicolon
id|bio
op_assign
id|loop_get_bio
c_func
(paren
id|lo
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bio
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;loop: missing bio&bslash;n&quot;
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|loop_handle_bio
c_func
(paren
id|lo
comma
id|bio
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * upped both for pending work and tear-down, lo_pending&n;&t;&t; * will hit zero then&n;&t;&t; */
r_if
c_cond
(paren
id|atomic_dec_and_test
c_func
(paren
op_amp
id|lo-&gt;lo_pending
)paren
)paren
r_break
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|lo-&gt;lo_sem
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|loop_set_fd
r_static
r_int
id|loop_set_fd
c_func
(paren
r_struct
id|loop_device
op_star
id|lo
comma
r_struct
id|file
op_star
id|lo_file
comma
id|kdev_t
id|dev
comma
r_int
r_int
id|arg
)paren
(brace
r_struct
id|file
op_star
id|file
suffix:semicolon
r_struct
id|inode
op_star
id|inode
suffix:semicolon
id|kdev_t
id|lo_device
suffix:semicolon
r_int
id|lo_flags
op_assign
l_int|0
suffix:semicolon
r_int
id|error
suffix:semicolon
r_int
id|bs
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
id|error
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_if
c_cond
(paren
id|lo-&gt;lo_state
op_ne
id|Lo_unbound
)paren
r_goto
id|out
suffix:semicolon
id|error
op_assign
op_minus
id|EBADF
suffix:semicolon
id|file
op_assign
id|fget
c_func
(paren
id|arg
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|file
)paren
r_goto
id|out
suffix:semicolon
id|error
op_assign
op_minus
id|EINVAL
suffix:semicolon
id|inode
op_assign
id|file-&gt;f_dentry-&gt;d_inode
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
)paren
id|lo_flags
op_or_assign
id|LO_FLAGS_READ_ONLY
suffix:semicolon
r_if
c_cond
(paren
id|S_ISBLK
c_func
(paren
id|inode-&gt;i_mode
)paren
)paren
(brace
id|lo_device
op_assign
id|inode-&gt;i_rdev
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|S_ISREG
c_func
(paren
id|inode-&gt;i_mode
)paren
)paren
(brace
r_struct
id|address_space_operations
op_star
id|aops
op_assign
id|inode-&gt;i_mapping-&gt;a_ops
suffix:semicolon
multiline_comment|/*&n;&t;&t; * If we can&squot;t read - sorry. If we only can&squot;t write - well,&n;&t;&t; * it&squot;s going to be read-only.&n;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
id|aops-&gt;readpage
)paren
r_goto
id|out_putf
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|aops-&gt;prepare_write
op_logical_or
op_logical_neg
id|aops-&gt;commit_write
)paren
id|lo_flags
op_or_assign
id|LO_FLAGS_READ_ONLY
suffix:semicolon
id|lo_device
op_assign
id|inode-&gt;i_dev
suffix:semicolon
id|lo_flags
op_or_assign
id|LO_FLAGS_DO_BMAP
suffix:semicolon
id|error
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_goto
id|out_putf
suffix:semicolon
id|get_file
c_func
(paren
id|file
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_RDONLY
(paren
id|inode
)paren
op_logical_or
id|is_read_only
c_func
(paren
id|lo_device
)paren
op_logical_or
op_logical_neg
(paren
id|lo_file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
)paren
id|lo_flags
op_or_assign
id|LO_FLAGS_READ_ONLY
suffix:semicolon
id|set_device_ro
c_func
(paren
id|dev
comma
(paren
id|lo_flags
op_amp
id|LO_FLAGS_READ_ONLY
)paren
op_ne
l_int|0
)paren
suffix:semicolon
id|lo-&gt;lo_device
op_assign
id|lo_device
suffix:semicolon
id|lo-&gt;lo_flags
op_assign
id|lo_flags
suffix:semicolon
id|lo-&gt;lo_backing_file
op_assign
id|file
suffix:semicolon
id|lo-&gt;transfer
op_assign
l_int|NULL
suffix:semicolon
id|lo-&gt;ioctl
op_assign
l_int|NULL
suffix:semicolon
id|figure_loop_size
c_func
(paren
id|lo
)paren
suffix:semicolon
id|lo-&gt;old_gfp_mask
op_assign
id|inode-&gt;i_mapping-&gt;gfp_mask
suffix:semicolon
id|inode-&gt;i_mapping-&gt;gfp_mask
op_assign
id|GFP_NOIO
suffix:semicolon
id|bs
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|blksize_size
(braket
id|MAJOR
c_func
(paren
id|lo_device
)paren
)braket
)paren
id|bs
op_assign
id|blksize_size
(braket
id|MAJOR
c_func
(paren
id|lo_device
)paren
)braket
(braket
id|MINOR
c_func
(paren
id|lo_device
)paren
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bs
)paren
id|bs
op_assign
id|BLOCK_SIZE
suffix:semicolon
id|set_blocksize
c_func
(paren
id|dev
comma
id|bs
)paren
suffix:semicolon
id|lo-&gt;lo_bio
op_assign
id|lo-&gt;lo_biotail
op_assign
l_int|NULL
suffix:semicolon
id|kernel_thread
c_func
(paren
id|loop_thread
comma
id|lo
comma
id|CLONE_FS
op_or
id|CLONE_FILES
op_or
id|CLONE_SIGHAND
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|lo-&gt;lo_sem
)paren
suffix:semicolon
id|fput
c_func
(paren
id|file
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|out_putf
suffix:colon
id|fput
c_func
(paren
id|file
)paren
suffix:semicolon
id|out
suffix:colon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|function|loop_release_xfer
r_static
r_int
id|loop_release_xfer
c_func
(paren
r_struct
id|loop_device
op_star
id|lo
)paren
(brace
r_int
id|err
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|lo-&gt;lo_encrypt_type
)paren
(brace
r_struct
id|loop_func_table
op_star
id|xfer
op_assign
id|xfer_funcs
(braket
id|lo-&gt;lo_encrypt_type
)braket
suffix:semicolon
r_if
c_cond
(paren
id|xfer
op_logical_and
id|xfer-&gt;release
)paren
id|err
op_assign
id|xfer
op_member_access_from_pointer
id|release
c_func
(paren
id|lo
)paren
suffix:semicolon
r_if
c_cond
(paren
id|xfer
op_logical_and
id|xfer-&gt;unlock
)paren
id|xfer
op_member_access_from_pointer
id|unlock
c_func
(paren
id|lo
)paren
suffix:semicolon
id|lo-&gt;lo_encrypt_type
op_assign
l_int|0
suffix:semicolon
)brace
r_return
id|err
suffix:semicolon
)brace
DECL|function|loop_init_xfer
r_static
r_int
id|loop_init_xfer
c_func
(paren
r_struct
id|loop_device
op_star
id|lo
comma
r_int
id|type
comma
r_struct
id|loop_info
op_star
id|i
)paren
(brace
r_int
id|err
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|type
)paren
(brace
r_struct
id|loop_func_table
op_star
id|xfer
op_assign
id|xfer_funcs
(braket
id|type
)braket
suffix:semicolon
r_if
c_cond
(paren
id|xfer-&gt;init
)paren
id|err
op_assign
id|xfer
op_member_access_from_pointer
id|init
c_func
(paren
id|lo
comma
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|err
)paren
(brace
id|lo-&gt;lo_encrypt_type
op_assign
id|type
suffix:semicolon
r_if
c_cond
(paren
id|xfer-&gt;lock
)paren
id|xfer
op_member_access_from_pointer
id|lock
c_func
(paren
id|lo
)paren
suffix:semicolon
)brace
)brace
r_return
id|err
suffix:semicolon
)brace
DECL|function|loop_clr_fd
r_static
r_int
id|loop_clr_fd
c_func
(paren
r_struct
id|loop_device
op_star
id|lo
comma
r_struct
id|block_device
op_star
id|bdev
)paren
(brace
r_struct
id|file
op_star
id|filp
op_assign
id|lo-&gt;lo_backing_file
suffix:semicolon
r_int
id|gfp
op_assign
id|lo-&gt;old_gfp_mask
suffix:semicolon
r_if
c_cond
(paren
id|lo-&gt;lo_state
op_ne
id|Lo_bound
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
r_if
c_cond
(paren
id|lo-&gt;lo_refcnt
OG
l_int|1
)paren
multiline_comment|/* we needed one fd for the ioctl */
r_return
op_minus
id|EBUSY
suffix:semicolon
r_if
c_cond
(paren
id|filp
op_eq
l_int|NULL
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|lo-&gt;lo_lock
)paren
suffix:semicolon
id|lo-&gt;lo_state
op_assign
id|Lo_rundown
suffix:semicolon
r_if
c_cond
(paren
id|atomic_dec_and_test
c_func
(paren
op_amp
id|lo-&gt;lo_pending
)paren
)paren
id|up
c_func
(paren
op_amp
id|lo-&gt;lo_bh_mutex
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|lo-&gt;lo_lock
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|lo-&gt;lo_sem
)paren
suffix:semicolon
id|lo-&gt;lo_backing_file
op_assign
l_int|NULL
suffix:semicolon
id|loop_release_xfer
c_func
(paren
id|lo
)paren
suffix:semicolon
id|lo-&gt;transfer
op_assign
l_int|NULL
suffix:semicolon
id|lo-&gt;ioctl
op_assign
l_int|NULL
suffix:semicolon
id|lo-&gt;lo_device
op_assign
l_int|0
suffix:semicolon
id|lo-&gt;lo_encrypt_type
op_assign
l_int|0
suffix:semicolon
id|lo-&gt;lo_offset
op_assign
l_int|0
suffix:semicolon
id|lo-&gt;lo_encrypt_key_size
op_assign
l_int|0
suffix:semicolon
id|lo-&gt;lo_flags
op_assign
l_int|0
suffix:semicolon
id|memset
c_func
(paren
id|lo-&gt;lo_encrypt_key
comma
l_int|0
comma
id|LO_KEY_SIZE
)paren
suffix:semicolon
id|memset
c_func
(paren
id|lo-&gt;lo_name
comma
l_int|0
comma
id|LO_NAME_SIZE
)paren
suffix:semicolon
id|loop_sizes
(braket
id|lo-&gt;lo_number
)braket
op_assign
l_int|0
suffix:semicolon
id|invalidate_bdev
c_func
(paren
id|bdev
comma
l_int|0
)paren
suffix:semicolon
id|filp-&gt;f_dentry-&gt;d_inode-&gt;i_mapping-&gt;gfp_mask
op_assign
id|gfp
suffix:semicolon
id|lo-&gt;lo_state
op_assign
id|Lo_unbound
suffix:semicolon
id|fput
c_func
(paren
id|filp
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|loop_set_status
r_static
r_int
id|loop_set_status
c_func
(paren
r_struct
id|loop_device
op_star
id|lo
comma
r_struct
id|loop_info
op_star
id|arg
)paren
(brace
r_struct
id|loop_info
id|info
suffix:semicolon
r_int
id|err
suffix:semicolon
r_int
r_int
id|type
suffix:semicolon
r_if
c_cond
(paren
id|lo-&gt;lo_encrypt_key_size
op_logical_and
id|lo-&gt;lo_key_owner
op_ne
id|current-&gt;uid
op_logical_and
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_ADMIN
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
r_if
c_cond
(paren
id|lo-&gt;lo_state
op_ne
id|Lo_bound
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|info
comma
id|arg
comma
r_sizeof
(paren
r_struct
id|loop_info
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
(paren
r_int
r_int
)paren
id|info.lo_encrypt_key_size
OG
id|LO_KEY_SIZE
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|type
op_assign
id|info.lo_encrypt_type
suffix:semicolon
r_if
c_cond
(paren
id|type
op_ge
id|MAX_LO_CRYPT
op_logical_or
id|xfer_funcs
(braket
id|type
)braket
op_eq
l_int|NULL
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|type
op_eq
id|LO_CRYPT_XOR
op_logical_and
id|info.lo_encrypt_key_size
op_eq
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|err
op_assign
id|loop_release_xfer
c_func
(paren
id|lo
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|err
)paren
id|err
op_assign
id|loop_init_xfer
c_func
(paren
id|lo
comma
id|type
comma
op_amp
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_return
id|err
suffix:semicolon
id|lo-&gt;lo_offset
op_assign
id|info.lo_offset
suffix:semicolon
id|strncpy
c_func
(paren
id|lo-&gt;lo_name
comma
id|info.lo_name
comma
id|LO_NAME_SIZE
)paren
suffix:semicolon
id|lo-&gt;transfer
op_assign
id|xfer_funcs
(braket
id|type
)braket
op_member_access_from_pointer
id|transfer
suffix:semicolon
id|lo-&gt;ioctl
op_assign
id|xfer_funcs
(braket
id|type
)braket
op_member_access_from_pointer
id|ioctl
suffix:semicolon
id|lo-&gt;lo_encrypt_key_size
op_assign
id|info.lo_encrypt_key_size
suffix:semicolon
id|lo-&gt;lo_init
(braket
l_int|0
)braket
op_assign
id|info.lo_init
(braket
l_int|0
)braket
suffix:semicolon
id|lo-&gt;lo_init
(braket
l_int|1
)braket
op_assign
id|info.lo_init
(braket
l_int|1
)braket
suffix:semicolon
r_if
c_cond
(paren
id|info.lo_encrypt_key_size
)paren
(brace
id|memcpy
c_func
(paren
id|lo-&gt;lo_encrypt_key
comma
id|info.lo_encrypt_key
comma
id|info.lo_encrypt_key_size
)paren
suffix:semicolon
id|lo-&gt;lo_key_owner
op_assign
id|current-&gt;uid
suffix:semicolon
)brace
id|figure_loop_size
c_func
(paren
id|lo
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|loop_get_status
r_static
r_int
id|loop_get_status
c_func
(paren
r_struct
id|loop_device
op_star
id|lo
comma
r_struct
id|loop_info
op_star
id|arg
)paren
(brace
r_struct
id|loop_info
id|info
suffix:semicolon
r_struct
id|file
op_star
id|file
op_assign
id|lo-&gt;lo_backing_file
suffix:semicolon
r_if
c_cond
(paren
id|lo-&gt;lo_state
op_ne
id|Lo_bound
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|arg
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|info
comma
l_int|0
comma
r_sizeof
(paren
id|info
)paren
)paren
suffix:semicolon
id|info.lo_number
op_assign
id|lo-&gt;lo_number
suffix:semicolon
id|info.lo_device
op_assign
id|kdev_t_to_nr
c_func
(paren
id|file-&gt;f_dentry-&gt;d_inode-&gt;i_dev
)paren
suffix:semicolon
id|info.lo_inode
op_assign
id|file-&gt;f_dentry-&gt;d_inode-&gt;i_ino
suffix:semicolon
id|info.lo_rdevice
op_assign
id|kdev_t_to_nr
c_func
(paren
id|lo-&gt;lo_device
)paren
suffix:semicolon
id|info.lo_offset
op_assign
id|lo-&gt;lo_offset
suffix:semicolon
id|info.lo_flags
op_assign
id|lo-&gt;lo_flags
suffix:semicolon
id|strncpy
c_func
(paren
id|info.lo_name
comma
id|lo-&gt;lo_name
comma
id|LO_NAME_SIZE
)paren
suffix:semicolon
id|info.lo_encrypt_type
op_assign
id|lo-&gt;lo_encrypt_type
suffix:semicolon
r_if
c_cond
(paren
id|lo-&gt;lo_encrypt_key_size
op_logical_and
id|capable
c_func
(paren
id|CAP_SYS_ADMIN
)paren
)paren
(brace
id|info.lo_encrypt_key_size
op_assign
id|lo-&gt;lo_encrypt_key_size
suffix:semicolon
id|memcpy
c_func
(paren
id|info.lo_encrypt_key
comma
id|lo-&gt;lo_encrypt_key
comma
id|lo-&gt;lo_encrypt_key_size
)paren
suffix:semicolon
)brace
r_return
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|info
comma
r_sizeof
(paren
id|info
)paren
)paren
ques
c_cond
op_minus
id|EFAULT
suffix:colon
l_int|0
suffix:semicolon
)brace
DECL|function|lo_ioctl
r_static
r_int
id|lo_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_struct
id|loop_device
op_star
id|lo
suffix:semicolon
r_int
id|dev
comma
id|err
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|inode
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|MAJOR
c_func
(paren
id|inode-&gt;i_rdev
)paren
op_ne
id|MAJOR_NR
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;lo_ioctl: pseudo-major != %d&bslash;n&quot;
comma
id|MAJOR_NR
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|dev
op_assign
id|MINOR
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_ge
id|max_loop
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|lo
op_assign
op_amp
id|loop_dev
(braket
id|dev
)braket
suffix:semicolon
id|down
c_func
(paren
op_amp
id|lo-&gt;lo_ctl_mutex
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|LOOP_SET_FD
suffix:colon
id|err
op_assign
id|loop_set_fd
c_func
(paren
id|lo
comma
id|file
comma
id|inode-&gt;i_rdev
comma
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LOOP_CLR_FD
suffix:colon
id|err
op_assign
id|loop_clr_fd
c_func
(paren
id|lo
comma
id|inode-&gt;i_bdev
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LOOP_SET_STATUS
suffix:colon
id|err
op_assign
id|loop_set_status
c_func
(paren
id|lo
comma
(paren
r_struct
id|loop_info
op_star
)paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LOOP_GET_STATUS
suffix:colon
id|err
op_assign
id|loop_get_status
c_func
(paren
id|lo
comma
(paren
r_struct
id|loop_info
op_star
)paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BLKGETSIZE
suffix:colon
r_if
c_cond
(paren
id|lo-&gt;lo_state
op_ne
id|Lo_bound
)paren
(brace
id|err
op_assign
op_minus
id|ENXIO
suffix:semicolon
r_break
suffix:semicolon
)brace
id|err
op_assign
id|put_user
c_func
(paren
(paren
r_int
r_int
)paren
id|loop_sizes
(braket
id|lo-&gt;lo_number
)braket
op_lshift
l_int|1
comma
(paren
r_int
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BLKGETSIZE64
suffix:colon
r_if
c_cond
(paren
id|lo-&gt;lo_state
op_ne
id|Lo_bound
)paren
(brace
id|err
op_assign
op_minus
id|ENXIO
suffix:semicolon
r_break
suffix:semicolon
)brace
id|err
op_assign
id|put_user
c_func
(paren
(paren
id|u64
)paren
id|loop_sizes
(braket
id|lo-&gt;lo_number
)braket
op_lshift
l_int|10
comma
(paren
id|u64
op_star
)paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|BLKBSZGET
suffix:colon
r_case
id|BLKBSZSET
suffix:colon
id|err
op_assign
id|blk_ioctl
c_func
(paren
id|inode-&gt;i_rdev
comma
id|cmd
comma
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|err
op_assign
id|lo-&gt;ioctl
ques
c_cond
id|lo
op_member_access_from_pointer
id|ioctl
c_func
(paren
id|lo
comma
id|cmd
comma
id|arg
)paren
suffix:colon
op_minus
id|EINVAL
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|lo-&gt;lo_ctl_mutex
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|lo_open
r_static
r_int
id|lo_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|loop_device
op_star
id|lo
suffix:semicolon
r_int
id|dev
comma
id|type
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|inode
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|MAJOR
c_func
(paren
id|inode-&gt;i_rdev
)paren
op_ne
id|MAJOR_NR
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;lo_open: pseudo-major != %d&bslash;n&quot;
comma
id|MAJOR_NR
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|dev
op_assign
id|MINOR
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_ge
id|max_loop
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|lo
op_assign
op_amp
id|loop_dev
(braket
id|dev
)braket
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
id|down
c_func
(paren
op_amp
id|lo-&gt;lo_ctl_mutex
)paren
suffix:semicolon
id|type
op_assign
id|lo-&gt;lo_encrypt_type
suffix:semicolon
r_if
c_cond
(paren
id|type
op_logical_and
id|xfer_funcs
(braket
id|type
)braket
op_logical_and
id|xfer_funcs
(braket
id|type
)braket
op_member_access_from_pointer
id|lock
)paren
id|xfer_funcs
(braket
id|type
)braket
op_member_access_from_pointer
id|lock
c_func
(paren
id|lo
)paren
suffix:semicolon
id|lo-&gt;lo_refcnt
op_increment
suffix:semicolon
id|up
c_func
(paren
op_amp
id|lo-&gt;lo_ctl_mutex
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|lo_release
r_static
r_int
id|lo_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|loop_device
op_star
id|lo
suffix:semicolon
r_int
id|dev
comma
id|type
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|inode
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|MAJOR
c_func
(paren
id|inode-&gt;i_rdev
)paren
op_ne
id|MAJOR_NR
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;lo_release: pseudo-major != %d&bslash;n&quot;
comma
id|MAJOR_NR
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|dev
op_assign
id|MINOR
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
op_ge
id|max_loop
)paren
r_return
l_int|0
suffix:semicolon
id|lo
op_assign
op_amp
id|loop_dev
(braket
id|dev
)braket
suffix:semicolon
id|down
c_func
(paren
op_amp
id|lo-&gt;lo_ctl_mutex
)paren
suffix:semicolon
id|type
op_assign
id|lo-&gt;lo_encrypt_type
suffix:semicolon
op_decrement
id|lo-&gt;lo_refcnt
suffix:semicolon
r_if
c_cond
(paren
id|xfer_funcs
(braket
id|type
)braket
op_logical_and
id|xfer_funcs
(braket
id|type
)braket
op_member_access_from_pointer
id|unlock
)paren
id|xfer_funcs
(braket
id|type
)braket
op_member_access_from_pointer
id|unlock
c_func
(paren
id|lo
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|lo-&gt;lo_ctl_mutex
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|lo_fops
r_static
r_struct
id|block_device_operations
id|lo_fops
op_assign
(brace
id|owner
suffix:colon
id|THIS_MODULE
comma
id|open
suffix:colon
id|lo_open
comma
id|release
suffix:colon
id|lo_release
comma
id|ioctl
suffix:colon
id|lo_ioctl
comma
)brace
suffix:semicolon
multiline_comment|/*&n; * And now the modules code and kernel interface.&n; */
id|MODULE_PARM
c_func
(paren
id|max_loop
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|max_loop
comma
l_string|&quot;Maximum number of loop devices (1-255)&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
DECL|function|loop_register_transfer
r_int
id|loop_register_transfer
c_func
(paren
r_struct
id|loop_func_table
op_star
id|funcs
)paren
(brace
r_if
c_cond
(paren
(paren
r_int
)paren
id|funcs-&gt;number
OG
id|MAX_LO_CRYPT
op_logical_or
id|xfer_funcs
(braket
id|funcs-&gt;number
)braket
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|xfer_funcs
(braket
id|funcs-&gt;number
)braket
op_assign
id|funcs
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|loop_unregister_transfer
r_int
id|loop_unregister_transfer
c_func
(paren
r_int
id|number
)paren
(brace
r_struct
id|loop_device
op_star
id|lo
suffix:semicolon
r_if
c_cond
(paren
(paren
r_int
)paren
id|number
op_ge
id|MAX_LO_CRYPT
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_for
c_loop
(paren
id|lo
op_assign
op_amp
id|loop_dev
(braket
l_int|0
)braket
suffix:semicolon
id|lo
OL
op_amp
id|loop_dev
(braket
id|max_loop
)braket
suffix:semicolon
id|lo
op_increment
)paren
(brace
r_int
id|type
op_assign
id|lo-&gt;lo_encrypt_type
suffix:semicolon
r_if
c_cond
(paren
id|type
op_eq
id|number
)paren
(brace
id|xfer_funcs
(braket
id|type
)braket
op_member_access_from_pointer
id|release
c_func
(paren
id|lo
)paren
suffix:semicolon
id|lo-&gt;transfer
op_assign
l_int|NULL
suffix:semicolon
id|lo-&gt;lo_encrypt_type
op_assign
l_int|0
suffix:semicolon
)brace
)brace
id|xfer_funcs
(braket
id|number
)braket
op_assign
l_int|NULL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|loop_register_transfer
id|EXPORT_SYMBOL
c_func
(paren
id|loop_register_transfer
)paren
suffix:semicolon
DECL|variable|loop_unregister_transfer
id|EXPORT_SYMBOL
c_func
(paren
id|loop_unregister_transfer
)paren
suffix:semicolon
DECL|function|loop_init
r_int
id|__init
id|loop_init
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
(paren
id|max_loop
OL
l_int|1
)paren
op_logical_or
(paren
id|max_loop
OG
l_int|255
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;loop: invalid max_loop (must be between&quot;
l_string|&quot; 1 and 255), using default (8)&bslash;n&quot;
)paren
suffix:semicolon
id|max_loop
op_assign
l_int|8
suffix:semicolon
)brace
r_if
c_cond
(paren
id|devfs_register_blkdev
c_func
(paren
id|MAJOR_NR
comma
l_string|&quot;loop&quot;
comma
op_amp
id|lo_fops
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Unable to get major number %d for loop&quot;
l_string|&quot; device&bslash;n&quot;
comma
id|MAJOR_NR
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|devfs_handle
op_assign
id|devfs_mk_dir
c_func
(paren
l_int|NULL
comma
l_string|&quot;loop&quot;
comma
l_int|NULL
)paren
suffix:semicolon
id|devfs_register_series
c_func
(paren
id|devfs_handle
comma
l_string|&quot;%u&quot;
comma
id|max_loop
comma
id|DEVFS_FL_DEFAULT
comma
id|MAJOR_NR
comma
l_int|0
comma
id|S_IFBLK
op_or
id|S_IRUSR
op_or
id|S_IWUSR
op_or
id|S_IRGRP
comma
op_amp
id|lo_fops
comma
l_int|NULL
)paren
suffix:semicolon
id|loop_dev
op_assign
id|kmalloc
c_func
(paren
id|max_loop
op_star
r_sizeof
(paren
r_struct
id|loop_device
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|loop_dev
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|loop_sizes
op_assign
id|kmalloc
c_func
(paren
id|max_loop
op_star
r_sizeof
(paren
r_int
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|loop_sizes
)paren
r_goto
id|out_mem
suffix:semicolon
id|loop_blksizes
op_assign
id|kmalloc
c_func
(paren
id|max_loop
op_star
r_sizeof
(paren
r_int
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|loop_blksizes
)paren
r_goto
id|out_mem
suffix:semicolon
id|blk_queue_make_request
c_func
(paren
id|BLK_DEFAULT_QUEUE
c_func
(paren
id|MAJOR_NR
)paren
comma
id|loop_make_request
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|max_loop
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|loop_device
op_star
id|lo
op_assign
op_amp
id|loop_dev
(braket
id|i
)braket
suffix:semicolon
id|memset
c_func
(paren
id|lo
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|loop_device
)paren
)paren
suffix:semicolon
id|init_MUTEX
c_func
(paren
op_amp
id|lo-&gt;lo_ctl_mutex
)paren
suffix:semicolon
id|init_MUTEX_LOCKED
c_func
(paren
op_amp
id|lo-&gt;lo_sem
)paren
suffix:semicolon
id|init_MUTEX_LOCKED
c_func
(paren
op_amp
id|lo-&gt;lo_bh_mutex
)paren
suffix:semicolon
id|lo-&gt;lo_number
op_assign
id|i
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|lo-&gt;lo_lock
)paren
suffix:semicolon
)brace
id|memset
c_func
(paren
id|loop_sizes
comma
l_int|0
comma
id|max_loop
op_star
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
id|loop_blksizes
comma
l_int|0
comma
id|max_loop
op_star
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
id|blk_size
(braket
id|MAJOR_NR
)braket
op_assign
id|loop_sizes
suffix:semicolon
id|blksize_size
(braket
id|MAJOR_NR
)braket
op_assign
id|loop_blksizes
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|max_loop
suffix:semicolon
id|i
op_increment
)paren
id|register_disk
c_func
(paren
l_int|NULL
comma
id|MKDEV
c_func
(paren
id|MAJOR_NR
comma
id|i
)paren
comma
l_int|1
comma
op_amp
id|lo_fops
comma
l_int|0
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;loop: loaded (max %d devices)&bslash;n&quot;
comma
id|max_loop
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|out_mem
suffix:colon
id|kfree
c_func
(paren
id|loop_dev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|loop_sizes
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;loop: ran out of memory&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
DECL|function|loop_exit
r_void
id|loop_exit
c_func
(paren
r_void
)paren
(brace
id|devfs_unregister
c_func
(paren
id|devfs_handle
)paren
suffix:semicolon
r_if
c_cond
(paren
id|devfs_unregister_blkdev
c_func
(paren
id|MAJOR_NR
comma
l_string|&quot;loop&quot;
)paren
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;loop: cannot unregister blkdev&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|loop_dev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|loop_sizes
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|loop_blksizes
)paren
suffix:semicolon
)brace
DECL|variable|loop_init
id|module_init
c_func
(paren
id|loop_init
)paren
suffix:semicolon
DECL|variable|loop_exit
id|module_exit
c_func
(paren
id|loop_exit
)paren
suffix:semicolon
macro_line|#ifndef MODULE
DECL|function|max_loop_setup
r_static
r_int
id|__init
id|max_loop_setup
c_func
(paren
r_char
op_star
id|str
)paren
(brace
id|max_loop
op_assign
id|simple_strtol
c_func
(paren
id|str
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|__setup
c_func
(paren
l_string|&quot;max_loop=&quot;
comma
id|max_loop_setup
)paren
suffix:semicolon
macro_line|#endif
eof
