multiline_comment|/*&n; *  linux/drivers/block/loop.c&n; *&n; *  Written by Theodore Ts&squot;o, 3/29/93&n; *&n; * Copyright 1993 by Theodore Ts&squot;o.  Redistribution of this file is&n; * permitted under the GNU General Public License.&n; *&n; * DES encryption plus some minor changes by Werner Almesberger, 30-MAY-1993&n; * more DES encryption plus IDEA encryption by Nicholas J. Leon, June 20, 1996&n; *&n; * Modularized and updated for 1.1.16 kernel - Mitch Dsouza 28th May 1994&n; * Adapted for 1.3.59 kernel - Andries Brouwer, 1 Feb 1996&n; *&n; * Fixed do_loop_request() re-entrancy - Vincent.Renardias@waw.com Mar 20, 1997&n; *&n; * Added devfs support - Richard Gooch &lt;rgooch@atnf.csiro.au&gt; 16-Jan-1998&n; *&n; * Handle sparse backing files correctly - Kenn Humborg, Jun 28, 1998&n; *&n; * Loadable modules and other fixes by AK, 1998&n; *&n; * Make real block number available to downstream transfer functions, enables&n; * CBC (and relatives) mode encryption requiring unique IVs per data block.&n; * Reed H. Petty, rhp@draper.net&n; *&n; * Maximum number of loop devices now dynamic via max_loop module parameter.&n; * Russell Kroll &lt;rkroll@exploits.org&gt; 19990701&n; *&n; * Maximum number of loop devices when compiled-in now selectable by passing&n; * max_loop=&lt;1-255&gt; to the kernel on boot.&n; * Erik I. Bols&#xfffd;, &lt;eriki@himolde.no&gt;, Oct 31, 1999&n; *&n; * Completely rewrite request handling to be make_request_fn style and&n; * non blocking, pushing work to a helper thread. Lots of fixes from&n; * Al Viro too.&n; * Jens Axboe &lt;axboe@suse.de&gt;, Nov 2000&n; *&n; * Support up to 256 loop devices&n; * Heinz Mauelshagen &lt;mge@sistina.com&gt;, Feb 2002&n; *&n; * Still To Fix:&n; * - Advisory locking is ignored here.&n; * - Should use an own CAP_* category instead of CAP_SYS_ADMIN&n; *&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/moduleparam.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/file.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/major.h&gt;
macro_line|#include &lt;linux/wait.h&gt;
macro_line|#include &lt;linux/blkdev.h&gt;
macro_line|#include &lt;linux/blkpg.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/devfs_fs_kernel.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/swap.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/loop.h&gt;
macro_line|#include &lt;linux/suspend.h&gt;
macro_line|#include &lt;linux/writeback.h&gt;
macro_line|#include &lt;linux/buffer_head.h&gt;&t;&t;/* for invalidate_bdev() */
macro_line|#include &lt;linux/completion.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
DECL|variable|max_loop
r_static
r_int
id|max_loop
op_assign
l_int|8
suffix:semicolon
DECL|variable|loop_dev
r_static
r_struct
id|loop_device
op_star
id|loop_dev
suffix:semicolon
DECL|variable|disks
r_static
r_struct
id|gendisk
op_star
op_star
id|disks
suffix:semicolon
multiline_comment|/*&n; * Transfer functions&n; */
DECL|function|transfer_none
r_static
r_int
id|transfer_none
c_func
(paren
r_struct
id|loop_device
op_star
id|lo
comma
r_int
id|cmd
comma
r_struct
id|page
op_star
id|raw_page
comma
r_int
id|raw_off
comma
r_struct
id|page
op_star
id|loop_page
comma
r_int
id|loop_off
comma
r_int
id|size
comma
id|sector_t
id|real_block
)paren
(brace
r_char
op_star
id|raw_buf
op_assign
id|kmap_atomic
c_func
(paren
id|raw_page
comma
id|KM_USER0
)paren
op_plus
id|raw_off
suffix:semicolon
r_char
op_star
id|loop_buf
op_assign
id|kmap_atomic
c_func
(paren
id|loop_page
comma
id|KM_USER1
)paren
op_plus
id|loop_off
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_eq
id|READ
)paren
id|memcpy
c_func
(paren
id|loop_buf
comma
id|raw_buf
comma
id|size
)paren
suffix:semicolon
r_else
id|memcpy
c_func
(paren
id|raw_buf
comma
id|loop_buf
comma
id|size
)paren
suffix:semicolon
id|kunmap_atomic
c_func
(paren
id|raw_buf
comma
id|KM_USER0
)paren
suffix:semicolon
id|kunmap_atomic
c_func
(paren
id|loop_buf
comma
id|KM_USER1
)paren
suffix:semicolon
id|cond_resched
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|transfer_xor
r_static
r_int
id|transfer_xor
c_func
(paren
r_struct
id|loop_device
op_star
id|lo
comma
r_int
id|cmd
comma
r_struct
id|page
op_star
id|raw_page
comma
r_int
id|raw_off
comma
r_struct
id|page
op_star
id|loop_page
comma
r_int
id|loop_off
comma
r_int
id|size
comma
id|sector_t
id|real_block
)paren
(brace
r_char
op_star
id|raw_buf
op_assign
id|kmap_atomic
c_func
(paren
id|raw_page
comma
id|KM_USER0
)paren
op_plus
id|raw_off
suffix:semicolon
r_char
op_star
id|loop_buf
op_assign
id|kmap_atomic
c_func
(paren
id|loop_page
comma
id|KM_USER1
)paren
op_plus
id|loop_off
suffix:semicolon
r_char
op_star
id|in
comma
op_star
id|out
comma
op_star
id|key
suffix:semicolon
r_int
id|i
comma
id|keysize
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_eq
id|READ
)paren
(brace
id|in
op_assign
id|raw_buf
suffix:semicolon
id|out
op_assign
id|loop_buf
suffix:semicolon
)brace
r_else
(brace
id|in
op_assign
id|loop_buf
suffix:semicolon
id|out
op_assign
id|raw_buf
suffix:semicolon
)brace
id|key
op_assign
id|lo-&gt;lo_encrypt_key
suffix:semicolon
id|keysize
op_assign
id|lo-&gt;lo_encrypt_key_size
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|size
suffix:semicolon
id|i
op_increment
)paren
op_star
id|out
op_increment
op_assign
op_star
id|in
op_increment
op_xor
id|key
(braket
(paren
id|i
op_amp
l_int|511
)paren
op_mod
id|keysize
)braket
suffix:semicolon
id|kunmap_atomic
c_func
(paren
id|raw_buf
comma
id|KM_USER0
)paren
suffix:semicolon
id|kunmap_atomic
c_func
(paren
id|loop_buf
comma
id|KM_USER1
)paren
suffix:semicolon
id|cond_resched
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|xor_init
r_static
r_int
id|xor_init
c_func
(paren
r_struct
id|loop_device
op_star
id|lo
comma
r_const
r_struct
id|loop_info64
op_star
id|info
)paren
(brace
r_if
c_cond
(paren
id|info-&gt;lo_encrypt_key_size
op_le
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|none_funcs
r_static
r_struct
id|loop_func_table
id|none_funcs
op_assign
(brace
dot
id|number
op_assign
id|LO_CRYPT_NONE
comma
dot
id|transfer
op_assign
id|transfer_none
comma
)brace
suffix:semicolon
DECL|variable|xor_funcs
r_static
r_struct
id|loop_func_table
id|xor_funcs
op_assign
(brace
dot
id|number
op_assign
id|LO_CRYPT_XOR
comma
dot
id|transfer
op_assign
id|transfer_xor
comma
dot
id|init
op_assign
id|xor_init
)brace
suffix:semicolon
multiline_comment|/* xfer_funcs[0] is special - its release function is never called */
DECL|variable|xfer_funcs
r_static
r_struct
id|loop_func_table
op_star
id|xfer_funcs
(braket
id|MAX_LO_CRYPT
)braket
op_assign
(brace
op_amp
id|none_funcs
comma
op_amp
id|xor_funcs
)brace
suffix:semicolon
DECL|function|get_loop_size
r_static
id|loff_t
id|get_loop_size
c_func
(paren
r_struct
id|loop_device
op_star
id|lo
comma
r_struct
id|file
op_star
id|file
)paren
(brace
id|loff_t
id|size
comma
id|offset
comma
id|loopsize
suffix:semicolon
multiline_comment|/* Compute loopsize in bytes */
id|size
op_assign
id|i_size_read
c_func
(paren
id|file-&gt;f_mapping-&gt;host
)paren
suffix:semicolon
id|offset
op_assign
id|lo-&gt;lo_offset
suffix:semicolon
id|loopsize
op_assign
id|size
op_minus
id|offset
suffix:semicolon
r_if
c_cond
(paren
id|lo-&gt;lo_sizelimit
OG
l_int|0
op_logical_and
id|lo-&gt;lo_sizelimit
OL
id|loopsize
)paren
id|loopsize
op_assign
id|lo-&gt;lo_sizelimit
suffix:semicolon
multiline_comment|/*&n;&t; * Unfortunately, if we want to do I/O on the device,&n;&t; * the number of 512-byte sectors has to fit into a sector_t.&n;&t; */
r_return
id|loopsize
op_rshift
l_int|9
suffix:semicolon
)brace
r_static
r_int
DECL|function|figure_loop_size
id|figure_loop_size
c_func
(paren
r_struct
id|loop_device
op_star
id|lo
)paren
(brace
id|loff_t
id|size
op_assign
id|get_loop_size
c_func
(paren
id|lo
comma
id|lo-&gt;lo_backing_file
)paren
suffix:semicolon
id|sector_t
id|x
op_assign
(paren
id|sector_t
)paren
id|size
suffix:semicolon
r_if
c_cond
(paren
(paren
id|loff_t
)paren
id|x
op_ne
id|size
)paren
r_return
op_minus
id|EFBIG
suffix:semicolon
id|set_capacity
c_func
(paren
id|disks
(braket
id|lo-&gt;lo_number
)braket
comma
id|x
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|lo_do_transfer
id|lo_do_transfer
c_func
(paren
r_struct
id|loop_device
op_star
id|lo
comma
r_int
id|cmd
comma
r_struct
id|page
op_star
id|rpage
comma
r_int
id|roffs
comma
r_struct
id|page
op_star
id|lpage
comma
r_int
id|loffs
comma
r_int
id|size
comma
id|sector_t
id|rblock
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|lo-&gt;transfer
)paren
r_return
l_int|0
suffix:semicolon
r_return
id|lo
op_member_access_from_pointer
id|transfer
c_func
(paren
id|lo
comma
id|cmd
comma
id|rpage
comma
id|roffs
comma
id|lpage
comma
id|loffs
comma
id|size
comma
id|rblock
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|do_lo_send
id|do_lo_send
c_func
(paren
r_struct
id|loop_device
op_star
id|lo
comma
r_struct
id|bio_vec
op_star
id|bvec
comma
r_int
id|bsize
comma
id|loff_t
id|pos
)paren
(brace
r_struct
id|file
op_star
id|file
op_assign
id|lo-&gt;lo_backing_file
suffix:semicolon
multiline_comment|/* kudos to NFsckingS */
r_struct
id|address_space
op_star
id|mapping
op_assign
id|file-&gt;f_mapping
suffix:semicolon
r_struct
id|address_space_operations
op_star
id|aops
op_assign
id|mapping-&gt;a_ops
suffix:semicolon
r_struct
id|page
op_star
id|page
suffix:semicolon
id|pgoff_t
id|index
suffix:semicolon
r_int
id|size
comma
id|offset
comma
id|bv_offs
suffix:semicolon
r_int
id|len
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
id|down
c_func
(paren
op_amp
id|mapping-&gt;host-&gt;i_sem
)paren
suffix:semicolon
id|index
op_assign
id|pos
op_rshift
id|PAGE_CACHE_SHIFT
suffix:semicolon
id|offset
op_assign
id|pos
op_amp
(paren
(paren
id|pgoff_t
)paren
id|PAGE_CACHE_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
id|bv_offs
op_assign
id|bvec-&gt;bv_offset
suffix:semicolon
id|len
op_assign
id|bvec-&gt;bv_len
suffix:semicolon
r_while
c_loop
(paren
id|len
OG
l_int|0
)paren
(brace
id|sector_t
id|IV
suffix:semicolon
r_int
id|transfer_result
suffix:semicolon
id|IV
op_assign
(paren
(paren
id|sector_t
)paren
id|index
op_lshift
(paren
id|PAGE_CACHE_SHIFT
op_minus
l_int|9
)paren
)paren
op_plus
(paren
id|offset
op_rshift
l_int|9
)paren
suffix:semicolon
id|size
op_assign
id|PAGE_CACHE_SIZE
op_minus
id|offset
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
id|len
)paren
id|size
op_assign
id|len
suffix:semicolon
id|page
op_assign
id|grab_cache_page
c_func
(paren
id|mapping
comma
id|index
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|page
)paren
r_goto
id|fail
suffix:semicolon
r_if
c_cond
(paren
id|aops
op_member_access_from_pointer
id|prepare_write
c_func
(paren
id|file
comma
id|page
comma
id|offset
comma
id|offset
op_plus
id|size
)paren
)paren
r_goto
id|unlock
suffix:semicolon
id|transfer_result
op_assign
id|lo_do_transfer
c_func
(paren
id|lo
comma
id|WRITE
comma
id|page
comma
id|offset
comma
id|bvec-&gt;bv_page
comma
id|bv_offs
comma
id|size
comma
id|IV
)paren
suffix:semicolon
r_if
c_cond
(paren
id|transfer_result
)paren
(brace
r_char
op_star
id|kaddr
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * The transfer failed, but we still write the data to&n;&t;&t;&t; * keep prepare/commit calls balanced.&n;&t;&t;&t; */
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;loop: transfer error block %llu&bslash;n&quot;
comma
(paren
r_int
r_int
r_int
)paren
id|index
)paren
suffix:semicolon
id|kaddr
op_assign
id|kmap_atomic
c_func
(paren
id|page
comma
id|KM_USER0
)paren
suffix:semicolon
id|memset
c_func
(paren
id|kaddr
op_plus
id|offset
comma
l_int|0
comma
id|size
)paren
suffix:semicolon
id|kunmap_atomic
c_func
(paren
id|kaddr
comma
id|KM_USER0
)paren
suffix:semicolon
)brace
id|flush_dcache_page
c_func
(paren
id|page
)paren
suffix:semicolon
r_if
c_cond
(paren
id|aops
op_member_access_from_pointer
id|commit_write
c_func
(paren
id|file
comma
id|page
comma
id|offset
comma
id|offset
op_plus
id|size
)paren
)paren
r_goto
id|unlock
suffix:semicolon
r_if
c_cond
(paren
id|transfer_result
)paren
r_goto
id|unlock
suffix:semicolon
id|bv_offs
op_add_assign
id|size
suffix:semicolon
id|len
op_sub_assign
id|size
suffix:semicolon
id|offset
op_assign
l_int|0
suffix:semicolon
id|index
op_increment
suffix:semicolon
id|pos
op_add_assign
id|size
suffix:semicolon
id|unlock_page
c_func
(paren
id|page
)paren
suffix:semicolon
id|page_cache_release
c_func
(paren
id|page
)paren
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|mapping-&gt;host-&gt;i_sem
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|ret
suffix:semicolon
id|unlock
suffix:colon
id|unlock_page
c_func
(paren
id|page
)paren
suffix:semicolon
id|page_cache_release
c_func
(paren
id|page
)paren
suffix:semicolon
id|fail
suffix:colon
id|up
c_func
(paren
op_amp
id|mapping-&gt;host-&gt;i_sem
)paren
suffix:semicolon
id|ret
op_assign
op_minus
l_int|1
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_static
r_int
DECL|function|lo_send
id|lo_send
c_func
(paren
r_struct
id|loop_device
op_star
id|lo
comma
r_struct
id|bio
op_star
id|bio
comma
r_int
id|bsize
comma
id|loff_t
id|pos
)paren
(brace
r_struct
id|bio_vec
op_star
id|bvec
suffix:semicolon
r_int
id|i
comma
id|ret
op_assign
l_int|0
suffix:semicolon
id|bio_for_each_segment
c_func
(paren
id|bvec
comma
id|bio
comma
id|i
)paren
(brace
id|ret
op_assign
id|do_lo_send
c_func
(paren
id|lo
comma
id|bvec
comma
id|bsize
comma
id|pos
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
r_break
suffix:semicolon
id|pos
op_add_assign
id|bvec-&gt;bv_len
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|struct|lo_read_data
r_struct
id|lo_read_data
(brace
DECL|member|lo
r_struct
id|loop_device
op_star
id|lo
suffix:semicolon
DECL|member|page
r_struct
id|page
op_star
id|page
suffix:semicolon
DECL|member|offset
r_int
id|offset
suffix:semicolon
DECL|member|bsize
r_int
id|bsize
suffix:semicolon
)brace
suffix:semicolon
r_static
r_int
DECL|function|lo_read_actor
id|lo_read_actor
c_func
(paren
id|read_descriptor_t
op_star
id|desc
comma
r_struct
id|page
op_star
id|page
comma
r_int
r_int
id|offset
comma
r_int
r_int
id|size
)paren
(brace
r_int
r_int
id|count
op_assign
id|desc-&gt;count
suffix:semicolon
r_struct
id|lo_read_data
op_star
id|p
op_assign
id|desc-&gt;arg.data
suffix:semicolon
r_struct
id|loop_device
op_star
id|lo
op_assign
id|p-&gt;lo
suffix:semicolon
id|sector_t
id|IV
suffix:semicolon
id|IV
op_assign
(paren
(paren
id|sector_t
)paren
id|page-&gt;index
op_lshift
(paren
id|PAGE_CACHE_SHIFT
op_minus
l_int|9
)paren
)paren
op_plus
(paren
id|offset
op_rshift
l_int|9
)paren
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
id|count
)paren
id|size
op_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
id|lo_do_transfer
c_func
(paren
id|lo
comma
id|READ
comma
id|page
comma
id|offset
comma
id|p-&gt;page
comma
id|p-&gt;offset
comma
id|size
comma
id|IV
)paren
)paren
(brace
id|size
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;loop: transfer error block %ld&bslash;n&quot;
comma
id|page-&gt;index
)paren
suffix:semicolon
id|desc-&gt;error
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
id|flush_dcache_page
c_func
(paren
id|p-&gt;page
)paren
suffix:semicolon
id|desc-&gt;count
op_assign
id|count
op_minus
id|size
suffix:semicolon
id|desc-&gt;written
op_add_assign
id|size
suffix:semicolon
id|p-&gt;offset
op_add_assign
id|size
suffix:semicolon
r_return
id|size
suffix:semicolon
)brace
r_static
r_int
DECL|function|do_lo_receive
id|do_lo_receive
c_func
(paren
r_struct
id|loop_device
op_star
id|lo
comma
r_struct
id|bio_vec
op_star
id|bvec
comma
r_int
id|bsize
comma
id|loff_t
id|pos
)paren
(brace
r_struct
id|lo_read_data
id|cookie
suffix:semicolon
r_struct
id|file
op_star
id|file
suffix:semicolon
r_int
id|retval
suffix:semicolon
id|cookie.lo
op_assign
id|lo
suffix:semicolon
id|cookie.page
op_assign
id|bvec-&gt;bv_page
suffix:semicolon
id|cookie.offset
op_assign
id|bvec-&gt;bv_offset
suffix:semicolon
id|cookie.bsize
op_assign
id|bsize
suffix:semicolon
id|file
op_assign
id|lo-&gt;lo_backing_file
suffix:semicolon
id|retval
op_assign
id|file-&gt;f_op
op_member_access_from_pointer
id|sendfile
c_func
(paren
id|file
comma
op_amp
id|pos
comma
id|bvec-&gt;bv_len
comma
id|lo_read_actor
comma
op_amp
id|cookie
)paren
suffix:semicolon
r_return
(paren
id|retval
OL
l_int|0
)paren
ques
c_cond
id|retval
suffix:colon
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|lo_receive
id|lo_receive
c_func
(paren
r_struct
id|loop_device
op_star
id|lo
comma
r_struct
id|bio
op_star
id|bio
comma
r_int
id|bsize
comma
id|loff_t
id|pos
)paren
(brace
r_struct
id|bio_vec
op_star
id|bvec
suffix:semicolon
r_int
id|i
comma
id|ret
op_assign
l_int|0
suffix:semicolon
id|bio_for_each_segment
c_func
(paren
id|bvec
comma
id|bio
comma
id|i
)paren
(brace
id|ret
op_assign
id|do_lo_receive
c_func
(paren
id|lo
comma
id|bvec
comma
id|bsize
comma
id|pos
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
r_break
suffix:semicolon
id|pos
op_add_assign
id|bvec-&gt;bv_len
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|function|do_bio_filebacked
r_static
r_int
id|do_bio_filebacked
c_func
(paren
r_struct
id|loop_device
op_star
id|lo
comma
r_struct
id|bio
op_star
id|bio
)paren
(brace
id|loff_t
id|pos
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|pos
op_assign
(paren
(paren
id|loff_t
)paren
id|bio-&gt;bi_sector
op_lshift
l_int|9
)paren
op_plus
id|lo-&gt;lo_offset
suffix:semicolon
r_if
c_cond
(paren
id|bio_rw
c_func
(paren
id|bio
)paren
op_eq
id|WRITE
)paren
id|ret
op_assign
id|lo_send
c_func
(paren
id|lo
comma
id|bio
comma
id|lo-&gt;lo_blocksize
comma
id|pos
)paren
suffix:semicolon
r_else
id|ret
op_assign
id|lo_receive
c_func
(paren
id|lo
comma
id|bio
comma
id|lo-&gt;lo_blocksize
comma
id|pos
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n; * Add bio to back of pending list&n; */
DECL|function|loop_add_bio
r_static
r_void
id|loop_add_bio
c_func
(paren
r_struct
id|loop_device
op_star
id|lo
comma
r_struct
id|bio
op_star
id|bio
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|lo-&gt;lo_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lo-&gt;lo_biotail
)paren
(brace
id|lo-&gt;lo_biotail-&gt;bi_next
op_assign
id|bio
suffix:semicolon
id|lo-&gt;lo_biotail
op_assign
id|bio
suffix:semicolon
)brace
r_else
id|lo-&gt;lo_bio
op_assign
id|lo-&gt;lo_biotail
op_assign
id|bio
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|lo-&gt;lo_lock
comma
id|flags
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|lo-&gt;lo_bh_mutex
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Grab first pending buffer&n; */
DECL|function|loop_get_bio
r_static
r_struct
id|bio
op_star
id|loop_get_bio
c_func
(paren
r_struct
id|loop_device
op_star
id|lo
)paren
(brace
r_struct
id|bio
op_star
id|bio
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|lo-&gt;lo_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|bio
op_assign
id|lo-&gt;lo_bio
)paren
)paren
(brace
r_if
c_cond
(paren
id|bio
op_eq
id|lo-&gt;lo_biotail
)paren
id|lo-&gt;lo_biotail
op_assign
l_int|NULL
suffix:semicolon
id|lo-&gt;lo_bio
op_assign
id|bio-&gt;bi_next
suffix:semicolon
id|bio-&gt;bi_next
op_assign
l_int|NULL
suffix:semicolon
)brace
id|spin_unlock_irq
c_func
(paren
op_amp
id|lo-&gt;lo_lock
)paren
suffix:semicolon
r_return
id|bio
suffix:semicolon
)brace
DECL|function|loop_make_request
r_static
r_int
id|loop_make_request
c_func
(paren
id|request_queue_t
op_star
id|q
comma
r_struct
id|bio
op_star
id|old_bio
)paren
(brace
r_struct
id|loop_device
op_star
id|lo
op_assign
id|q-&gt;queuedata
suffix:semicolon
r_int
id|rw
op_assign
id|bio_rw
c_func
(paren
id|old_bio
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|lo
)paren
r_goto
id|out
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|lo-&gt;lo_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lo-&gt;lo_state
op_ne
id|Lo_bound
)paren
r_goto
id|inactive
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|lo-&gt;lo_pending
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|lo-&gt;lo_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rw
op_eq
id|WRITE
)paren
(brace
r_if
c_cond
(paren
id|lo-&gt;lo_flags
op_amp
id|LO_FLAGS_READ_ONLY
)paren
r_goto
id|err
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|rw
op_eq
id|READA
)paren
(brace
id|rw
op_assign
id|READ
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|rw
op_ne
id|READ
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;loop: unknown command (%x)&bslash;n&quot;
comma
id|rw
)paren
suffix:semicolon
r_goto
id|err
suffix:semicolon
)brace
id|loop_add_bio
c_func
(paren
id|lo
comma
id|old_bio
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|err
suffix:colon
r_if
c_cond
(paren
id|atomic_dec_and_test
c_func
(paren
op_amp
id|lo-&gt;lo_pending
)paren
)paren
id|up
c_func
(paren
op_amp
id|lo-&gt;lo_bh_mutex
)paren
suffix:semicolon
id|out
suffix:colon
id|bio_io_error
c_func
(paren
id|old_bio
comma
id|old_bio-&gt;bi_size
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|inactive
suffix:colon
id|spin_unlock_irq
c_func
(paren
op_amp
id|lo-&gt;lo_lock
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/*&n; * kick off io on the underlying address space&n; */
DECL|function|loop_unplug
r_static
r_void
id|loop_unplug
c_func
(paren
id|request_queue_t
op_star
id|q
)paren
(brace
r_struct
id|loop_device
op_star
id|lo
op_assign
id|q-&gt;queuedata
suffix:semicolon
id|clear_bit
c_func
(paren
id|QUEUE_FLAG_PLUGGED
comma
op_amp
id|q-&gt;queue_flags
)paren
suffix:semicolon
id|blk_run_address_space
c_func
(paren
id|lo-&gt;lo_backing_file-&gt;f_mapping
)paren
suffix:semicolon
)brace
DECL|struct|switch_request
r_struct
id|switch_request
(brace
DECL|member|file
r_struct
id|file
op_star
id|file
suffix:semicolon
DECL|member|wait
r_struct
id|completion
id|wait
suffix:semicolon
)brace
suffix:semicolon
r_static
r_void
id|do_loop_switch
c_func
(paren
r_struct
id|loop_device
op_star
comma
r_struct
id|switch_request
op_star
)paren
suffix:semicolon
DECL|function|loop_handle_bio
r_static
r_inline
r_void
id|loop_handle_bio
c_func
(paren
r_struct
id|loop_device
op_star
id|lo
comma
r_struct
id|bio
op_star
id|bio
)paren
(brace
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
op_logical_neg
id|bio-&gt;bi_bdev
)paren
)paren
(brace
id|do_loop_switch
c_func
(paren
id|lo
comma
id|bio-&gt;bi_private
)paren
suffix:semicolon
id|bio_put
c_func
(paren
id|bio
)paren
suffix:semicolon
)brace
r_else
(brace
id|ret
op_assign
id|do_bio_filebacked
c_func
(paren
id|lo
comma
id|bio
)paren
suffix:semicolon
id|bio_endio
c_func
(paren
id|bio
comma
id|bio-&gt;bi_size
comma
id|ret
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * worker thread that handles reads/writes to file backed loop devices,&n; * to avoid blocking in our make_request_fn. it also does loop decrypting&n; * on reads for block backed loop, as that is too heavy to do from&n; * b_end_io context where irqs may be disabled.&n; */
DECL|function|loop_thread
r_static
r_int
id|loop_thread
c_func
(paren
r_void
op_star
id|data
)paren
(brace
r_struct
id|loop_device
op_star
id|lo
op_assign
id|data
suffix:semicolon
r_struct
id|bio
op_star
id|bio
suffix:semicolon
id|daemonize
c_func
(paren
l_string|&quot;loop%d&quot;
comma
id|lo-&gt;lo_number
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * loop can be used in an encrypted device,&n;&t; * hence, it mustn&squot;t be stopped at all&n;&t; * because it could be indirectly used during suspension&n;&t; */
id|current-&gt;flags
op_or_assign
id|PF_NOFREEZE
suffix:semicolon
id|set_user_nice
c_func
(paren
id|current
comma
op_minus
l_int|20
)paren
suffix:semicolon
id|lo-&gt;lo_state
op_assign
id|Lo_bound
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|lo-&gt;lo_pending
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * up sem, we are running&n;&t; */
id|up
c_func
(paren
op_amp
id|lo-&gt;lo_sem
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|down_interruptible
c_func
(paren
op_amp
id|lo-&gt;lo_bh_mutex
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * could be upped because of tear-down, not because of&n;&t;&t; * pending work&n;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
id|atomic_read
c_func
(paren
op_amp
id|lo-&gt;lo_pending
)paren
)paren
r_break
suffix:semicolon
id|bio
op_assign
id|loop_get_bio
c_func
(paren
id|lo
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bio
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;loop: missing bio&bslash;n&quot;
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|loop_handle_bio
c_func
(paren
id|lo
comma
id|bio
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * upped both for pending work and tear-down, lo_pending&n;&t;&t; * will hit zero then&n;&t;&t; */
r_if
c_cond
(paren
id|atomic_dec_and_test
c_func
(paren
op_amp
id|lo-&gt;lo_pending
)paren
)paren
r_break
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|lo-&gt;lo_sem
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * loop_switch performs the hard work of switching a backing store.&n; * First it needs to flush existing IO, it does this by sending a magic&n; * BIO down the pipe. The completion of this BIO does the actual switch.&n; */
DECL|function|loop_switch
r_static
r_int
id|loop_switch
c_func
(paren
r_struct
id|loop_device
op_star
id|lo
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|switch_request
id|w
suffix:semicolon
r_struct
id|bio
op_star
id|bio
op_assign
id|bio_alloc
c_func
(paren
id|GFP_KERNEL
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bio
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|init_completion
c_func
(paren
op_amp
id|w.wait
)paren
suffix:semicolon
id|w.file
op_assign
id|file
suffix:semicolon
id|bio-&gt;bi_private
op_assign
op_amp
id|w
suffix:semicolon
id|bio-&gt;bi_bdev
op_assign
l_int|NULL
suffix:semicolon
id|loop_make_request
c_func
(paren
id|lo-&gt;lo_queue
comma
id|bio
)paren
suffix:semicolon
id|wait_for_completion
c_func
(paren
op_amp
id|w.wait
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Do the actual switch; called from the BIO completion routine&n; */
DECL|function|do_loop_switch
r_static
r_void
id|do_loop_switch
c_func
(paren
r_struct
id|loop_device
op_star
id|lo
comma
r_struct
id|switch_request
op_star
id|p
)paren
(brace
r_struct
id|file
op_star
id|file
op_assign
id|p-&gt;file
suffix:semicolon
r_struct
id|file
op_star
id|old_file
op_assign
id|lo-&gt;lo_backing_file
suffix:semicolon
r_struct
id|address_space
op_star
id|mapping
op_assign
id|file-&gt;f_mapping
suffix:semicolon
id|mapping_set_gfp_mask
c_func
(paren
id|old_file-&gt;f_mapping
comma
id|lo-&gt;old_gfp_mask
)paren
suffix:semicolon
id|lo-&gt;lo_backing_file
op_assign
id|file
suffix:semicolon
id|lo-&gt;lo_blocksize
op_assign
id|mapping-&gt;host-&gt;i_blksize
suffix:semicolon
id|lo-&gt;old_gfp_mask
op_assign
id|mapping_gfp_mask
c_func
(paren
id|mapping
)paren
suffix:semicolon
id|mapping_set_gfp_mask
c_func
(paren
id|mapping
comma
id|lo-&gt;old_gfp_mask
op_amp
op_complement
(paren
id|__GFP_IO
op_or
id|__GFP_FS
)paren
)paren
suffix:semicolon
id|complete
c_func
(paren
op_amp
id|p-&gt;wait
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * loop_change_fd switched the backing store of a loopback device to&n; * a new file. This is useful for operating system installers to free up&n; * the original file and in High Availability environments to switch to&n; * an alternative location for the content in case of server meltdown.&n; * This can only work if the loop device is used read-only, and if the&n; * new backing store is the same size and type as the old backing store.&n; */
DECL|function|loop_change_fd
r_static
r_int
id|loop_change_fd
c_func
(paren
r_struct
id|loop_device
op_star
id|lo
comma
r_struct
id|file
op_star
id|lo_file
comma
r_struct
id|block_device
op_star
id|bdev
comma
r_int
r_int
id|arg
)paren
(brace
r_struct
id|file
op_star
id|file
comma
op_star
id|old_file
suffix:semicolon
r_struct
id|inode
op_star
id|inode
suffix:semicolon
r_int
id|error
suffix:semicolon
id|error
op_assign
op_minus
id|ENXIO
suffix:semicolon
r_if
c_cond
(paren
id|lo-&gt;lo_state
op_ne
id|Lo_bound
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* the loop device has to be read-only */
id|error
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|lo-&gt;lo_flags
op_ne
id|LO_FLAGS_READ_ONLY
)paren
r_goto
id|out
suffix:semicolon
id|error
op_assign
op_minus
id|EBADF
suffix:semicolon
id|file
op_assign
id|fget
c_func
(paren
id|arg
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|file
)paren
r_goto
id|out
suffix:semicolon
id|inode
op_assign
id|file-&gt;f_mapping-&gt;host
suffix:semicolon
id|old_file
op_assign
id|lo-&gt;lo_backing_file
suffix:semicolon
id|error
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|S_ISREG
c_func
(paren
id|inode-&gt;i_mode
)paren
op_logical_and
op_logical_neg
id|S_ISBLK
c_func
(paren
id|inode-&gt;i_mode
)paren
)paren
r_goto
id|out_putf
suffix:semicolon
multiline_comment|/* new backing store needs to support loop (eg sendfile) */
r_if
c_cond
(paren
op_logical_neg
id|inode-&gt;i_fop-&gt;sendfile
)paren
r_goto
id|out_putf
suffix:semicolon
multiline_comment|/* size of the new backing store needs to be the same */
r_if
c_cond
(paren
id|get_loop_size
c_func
(paren
id|lo
comma
id|file
)paren
op_ne
id|get_loop_size
c_func
(paren
id|lo
comma
id|old_file
)paren
)paren
r_goto
id|out_putf
suffix:semicolon
multiline_comment|/* and ... switch */
id|error
op_assign
id|loop_switch
c_func
(paren
id|lo
comma
id|file
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_goto
id|out_putf
suffix:semicolon
id|fput
c_func
(paren
id|old_file
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|out_putf
suffix:colon
id|fput
c_func
(paren
id|file
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|error
suffix:semicolon
)brace
DECL|function|is_loop_device
r_static
r_inline
r_int
id|is_loop_device
c_func
(paren
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|inode
op_star
id|i
op_assign
id|file-&gt;f_mapping-&gt;host
suffix:semicolon
r_return
id|i
op_logical_and
id|S_ISBLK
c_func
(paren
id|i-&gt;i_mode
)paren
op_logical_and
id|MAJOR
c_func
(paren
id|i-&gt;i_rdev
)paren
op_eq
id|LOOP_MAJOR
suffix:semicolon
)brace
DECL|function|loop_set_fd
r_static
r_int
id|loop_set_fd
c_func
(paren
r_struct
id|loop_device
op_star
id|lo
comma
r_struct
id|file
op_star
id|lo_file
comma
r_struct
id|block_device
op_star
id|bdev
comma
r_int
r_int
id|arg
)paren
(brace
r_struct
id|file
op_star
id|file
comma
op_star
id|f
suffix:semicolon
r_struct
id|inode
op_star
id|inode
suffix:semicolon
r_struct
id|address_space
op_star
id|mapping
suffix:semicolon
r_int
id|lo_blocksize
suffix:semicolon
r_int
id|lo_flags
op_assign
l_int|0
suffix:semicolon
r_int
id|error
suffix:semicolon
id|loff_t
id|size
suffix:semicolon
multiline_comment|/* This is safe, since we have a reference from open(). */
id|__module_get
c_func
(paren
id|THIS_MODULE
)paren
suffix:semicolon
id|error
op_assign
op_minus
id|EBADF
suffix:semicolon
id|file
op_assign
id|fget
c_func
(paren
id|arg
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|file
)paren
r_goto
id|out
suffix:semicolon
id|error
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_if
c_cond
(paren
id|lo-&gt;lo_state
op_ne
id|Lo_unbound
)paren
r_goto
id|out_putf
suffix:semicolon
multiline_comment|/* Avoid recursion */
id|f
op_assign
id|file
suffix:semicolon
r_while
c_loop
(paren
id|is_loop_device
c_func
(paren
id|f
)paren
)paren
(brace
r_struct
id|loop_device
op_star
id|l
suffix:semicolon
r_if
c_cond
(paren
id|f-&gt;f_mapping-&gt;host-&gt;i_rdev
op_eq
id|lo_file-&gt;f_mapping-&gt;host-&gt;i_rdev
)paren
r_goto
id|out_putf
suffix:semicolon
id|l
op_assign
id|f-&gt;f_mapping-&gt;host-&gt;i_bdev-&gt;bd_disk-&gt;private_data
suffix:semicolon
r_if
c_cond
(paren
id|l-&gt;lo_state
op_eq
id|Lo_unbound
)paren
(brace
id|error
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|out_putf
suffix:semicolon
)brace
id|f
op_assign
id|l-&gt;lo_backing_file
suffix:semicolon
)brace
id|mapping
op_assign
id|file-&gt;f_mapping
suffix:semicolon
id|inode
op_assign
id|mapping-&gt;host
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
)paren
id|lo_flags
op_or_assign
id|LO_FLAGS_READ_ONLY
suffix:semicolon
id|error
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|S_ISREG
c_func
(paren
id|inode-&gt;i_mode
)paren
op_logical_or
id|S_ISBLK
c_func
(paren
id|inode-&gt;i_mode
)paren
)paren
(brace
r_struct
id|address_space_operations
op_star
id|aops
op_assign
id|mapping-&gt;a_ops
suffix:semicolon
multiline_comment|/*&n;&t;&t; * If we can&squot;t read - sorry. If we only can&squot;t write - well,&n;&t;&t; * it&squot;s going to be read-only.&n;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
id|file-&gt;f_op-&gt;sendfile
)paren
r_goto
id|out_putf
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|aops-&gt;prepare_write
op_logical_or
op_logical_neg
id|aops-&gt;commit_write
)paren
id|lo_flags
op_or_assign
id|LO_FLAGS_READ_ONLY
suffix:semicolon
id|lo_blocksize
op_assign
id|inode-&gt;i_blksize
suffix:semicolon
id|error
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
r_goto
id|out_putf
suffix:semicolon
)brace
id|size
op_assign
id|get_loop_size
c_func
(paren
id|lo
comma
id|file
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|loff_t
)paren
(paren
id|sector_t
)paren
id|size
op_ne
id|size
)paren
(brace
id|error
op_assign
op_minus
id|EFBIG
suffix:semicolon
r_goto
id|out_putf
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|lo_file-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
)paren
id|lo_flags
op_or_assign
id|LO_FLAGS_READ_ONLY
suffix:semicolon
id|set_device_ro
c_func
(paren
id|bdev
comma
(paren
id|lo_flags
op_amp
id|LO_FLAGS_READ_ONLY
)paren
op_ne
l_int|0
)paren
suffix:semicolon
id|lo-&gt;lo_blocksize
op_assign
id|lo_blocksize
suffix:semicolon
id|lo-&gt;lo_device
op_assign
id|bdev
suffix:semicolon
id|lo-&gt;lo_flags
op_assign
id|lo_flags
suffix:semicolon
id|lo-&gt;lo_backing_file
op_assign
id|file
suffix:semicolon
id|lo-&gt;transfer
op_assign
l_int|NULL
suffix:semicolon
id|lo-&gt;ioctl
op_assign
l_int|NULL
suffix:semicolon
id|lo-&gt;lo_sizelimit
op_assign
l_int|0
suffix:semicolon
id|lo-&gt;old_gfp_mask
op_assign
id|mapping_gfp_mask
c_func
(paren
id|mapping
)paren
suffix:semicolon
id|mapping_set_gfp_mask
c_func
(paren
id|mapping
comma
id|lo-&gt;old_gfp_mask
op_amp
op_complement
(paren
id|__GFP_IO
op_or
id|__GFP_FS
)paren
)paren
suffix:semicolon
id|lo-&gt;lo_bio
op_assign
id|lo-&gt;lo_biotail
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/*&n;&t; * set queue make_request_fn, and add limits based on lower level&n;&t; * device&n;&t; */
id|blk_queue_make_request
c_func
(paren
id|lo-&gt;lo_queue
comma
id|loop_make_request
)paren
suffix:semicolon
id|lo-&gt;lo_queue-&gt;queuedata
op_assign
id|lo
suffix:semicolon
id|lo-&gt;lo_queue-&gt;unplug_fn
op_assign
id|loop_unplug
suffix:semicolon
id|set_capacity
c_func
(paren
id|disks
(braket
id|lo-&gt;lo_number
)braket
comma
id|size
)paren
suffix:semicolon
id|bd_set_size
c_func
(paren
id|bdev
comma
id|size
op_lshift
l_int|9
)paren
suffix:semicolon
id|set_blocksize
c_func
(paren
id|bdev
comma
id|lo_blocksize
)paren
suffix:semicolon
id|kernel_thread
c_func
(paren
id|loop_thread
comma
id|lo
comma
id|CLONE_KERNEL
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|lo-&gt;lo_sem
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|out_putf
suffix:colon
id|fput
c_func
(paren
id|file
)paren
suffix:semicolon
id|out
suffix:colon
multiline_comment|/* This is safe: open() is still holding a reference. */
id|module_put
c_func
(paren
id|THIS_MODULE
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
r_static
r_int
DECL|function|loop_release_xfer
id|loop_release_xfer
c_func
(paren
r_struct
id|loop_device
op_star
id|lo
)paren
(brace
r_int
id|err
op_assign
l_int|0
suffix:semicolon
r_struct
id|loop_func_table
op_star
id|xfer
op_assign
id|lo-&gt;lo_encryption
suffix:semicolon
r_if
c_cond
(paren
id|xfer
)paren
(brace
r_if
c_cond
(paren
id|xfer-&gt;release
)paren
id|err
op_assign
id|xfer
op_member_access_from_pointer
id|release
c_func
(paren
id|lo
)paren
suffix:semicolon
id|lo-&gt;transfer
op_assign
l_int|NULL
suffix:semicolon
id|lo-&gt;lo_encryption
op_assign
l_int|NULL
suffix:semicolon
id|module_put
c_func
(paren
id|xfer-&gt;owner
)paren
suffix:semicolon
)brace
r_return
id|err
suffix:semicolon
)brace
r_static
r_int
DECL|function|loop_init_xfer
id|loop_init_xfer
c_func
(paren
r_struct
id|loop_device
op_star
id|lo
comma
r_struct
id|loop_func_table
op_star
id|xfer
comma
r_const
r_struct
id|loop_info64
op_star
id|i
)paren
(brace
r_int
id|err
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|xfer
)paren
(brace
r_struct
id|module
op_star
id|owner
op_assign
id|xfer-&gt;owner
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|try_module_get
c_func
(paren
id|owner
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|xfer-&gt;init
)paren
id|err
op_assign
id|xfer
op_member_access_from_pointer
id|init
c_func
(paren
id|lo
comma
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
id|module_put
c_func
(paren
id|owner
)paren
suffix:semicolon
r_else
id|lo-&gt;lo_encryption
op_assign
id|xfer
suffix:semicolon
)brace
r_return
id|err
suffix:semicolon
)brace
DECL|function|loop_clr_fd
r_static
r_int
id|loop_clr_fd
c_func
(paren
r_struct
id|loop_device
op_star
id|lo
comma
r_struct
id|block_device
op_star
id|bdev
)paren
(brace
r_struct
id|file
op_star
id|filp
op_assign
id|lo-&gt;lo_backing_file
suffix:semicolon
r_int
id|gfp
op_assign
id|lo-&gt;old_gfp_mask
suffix:semicolon
r_if
c_cond
(paren
id|lo-&gt;lo_state
op_ne
id|Lo_bound
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
r_if
c_cond
(paren
id|lo-&gt;lo_refcnt
OG
l_int|1
)paren
multiline_comment|/* we needed one fd for the ioctl */
r_return
op_minus
id|EBUSY
suffix:semicolon
r_if
c_cond
(paren
id|filp
op_eq
l_int|NULL
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|lo-&gt;lo_lock
)paren
suffix:semicolon
id|lo-&gt;lo_state
op_assign
id|Lo_rundown
suffix:semicolon
r_if
c_cond
(paren
id|atomic_dec_and_test
c_func
(paren
op_amp
id|lo-&gt;lo_pending
)paren
)paren
id|up
c_func
(paren
op_amp
id|lo-&gt;lo_bh_mutex
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|lo-&gt;lo_lock
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|lo-&gt;lo_sem
)paren
suffix:semicolon
id|lo-&gt;lo_backing_file
op_assign
l_int|NULL
suffix:semicolon
id|loop_release_xfer
c_func
(paren
id|lo
)paren
suffix:semicolon
id|lo-&gt;transfer
op_assign
l_int|NULL
suffix:semicolon
id|lo-&gt;ioctl
op_assign
l_int|NULL
suffix:semicolon
id|lo-&gt;lo_device
op_assign
l_int|NULL
suffix:semicolon
id|lo-&gt;lo_encryption
op_assign
l_int|NULL
suffix:semicolon
id|lo-&gt;lo_offset
op_assign
l_int|0
suffix:semicolon
id|lo-&gt;lo_sizelimit
op_assign
l_int|0
suffix:semicolon
id|lo-&gt;lo_encrypt_key_size
op_assign
l_int|0
suffix:semicolon
id|lo-&gt;lo_flags
op_assign
l_int|0
suffix:semicolon
id|memset
c_func
(paren
id|lo-&gt;lo_encrypt_key
comma
l_int|0
comma
id|LO_KEY_SIZE
)paren
suffix:semicolon
id|memset
c_func
(paren
id|lo-&gt;lo_crypt_name
comma
l_int|0
comma
id|LO_NAME_SIZE
)paren
suffix:semicolon
id|memset
c_func
(paren
id|lo-&gt;lo_file_name
comma
l_int|0
comma
id|LO_NAME_SIZE
)paren
suffix:semicolon
id|invalidate_bdev
c_func
(paren
id|bdev
comma
l_int|0
)paren
suffix:semicolon
id|set_capacity
c_func
(paren
id|disks
(braket
id|lo-&gt;lo_number
)braket
comma
l_int|0
)paren
suffix:semicolon
id|bd_set_size
c_func
(paren
id|bdev
comma
l_int|0
)paren
suffix:semicolon
id|mapping_set_gfp_mask
c_func
(paren
id|filp-&gt;f_mapping
comma
id|gfp
)paren
suffix:semicolon
id|lo-&gt;lo_state
op_assign
id|Lo_unbound
suffix:semicolon
id|fput
c_func
(paren
id|filp
)paren
suffix:semicolon
multiline_comment|/* This is safe: open() is still holding a reference. */
id|module_put
c_func
(paren
id|THIS_MODULE
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|loop_set_status
id|loop_set_status
c_func
(paren
r_struct
id|loop_device
op_star
id|lo
comma
r_const
r_struct
id|loop_info64
op_star
id|info
)paren
(brace
r_int
id|err
suffix:semicolon
r_struct
id|loop_func_table
op_star
id|xfer
suffix:semicolon
r_if
c_cond
(paren
id|lo-&gt;lo_encrypt_key_size
op_logical_and
id|lo-&gt;lo_key_owner
op_ne
id|current-&gt;uid
op_logical_and
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_ADMIN
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
r_if
c_cond
(paren
id|lo-&gt;lo_state
op_ne
id|Lo_bound
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
r_if
c_cond
(paren
(paren
r_int
r_int
)paren
id|info-&gt;lo_encrypt_key_size
OG
id|LO_KEY_SIZE
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|err
op_assign
id|loop_release_xfer
c_func
(paren
id|lo
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_return
id|err
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;lo_encrypt_type
)paren
(brace
r_int
r_int
id|type
op_assign
id|info-&gt;lo_encrypt_type
suffix:semicolon
r_if
c_cond
(paren
id|type
op_ge
id|MAX_LO_CRYPT
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|xfer
op_assign
id|xfer_funcs
(braket
id|type
)braket
suffix:semicolon
r_if
c_cond
(paren
id|xfer
op_eq
l_int|NULL
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_else
id|xfer
op_assign
l_int|NULL
suffix:semicolon
id|err
op_assign
id|loop_init_xfer
c_func
(paren
id|lo
comma
id|xfer
comma
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_return
id|err
suffix:semicolon
r_if
c_cond
(paren
id|lo-&gt;lo_offset
op_ne
id|info-&gt;lo_offset
op_logical_or
id|lo-&gt;lo_sizelimit
op_ne
id|info-&gt;lo_sizelimit
)paren
(brace
id|lo-&gt;lo_offset
op_assign
id|info-&gt;lo_offset
suffix:semicolon
id|lo-&gt;lo_sizelimit
op_assign
id|info-&gt;lo_sizelimit
suffix:semicolon
r_if
c_cond
(paren
id|figure_loop_size
c_func
(paren
id|lo
)paren
)paren
r_return
op_minus
id|EFBIG
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|lo-&gt;lo_file_name
comma
id|info-&gt;lo_file_name
comma
id|LO_NAME_SIZE
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|lo-&gt;lo_crypt_name
comma
id|info-&gt;lo_crypt_name
comma
id|LO_NAME_SIZE
)paren
suffix:semicolon
id|lo-&gt;lo_file_name
(braket
id|LO_NAME_SIZE
op_minus
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|lo-&gt;lo_crypt_name
(braket
id|LO_NAME_SIZE
op_minus
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|xfer
)paren
id|xfer
op_assign
op_amp
id|none_funcs
suffix:semicolon
id|lo-&gt;transfer
op_assign
id|xfer-&gt;transfer
suffix:semicolon
id|lo-&gt;ioctl
op_assign
id|xfer-&gt;ioctl
suffix:semicolon
id|lo-&gt;lo_encrypt_key_size
op_assign
id|info-&gt;lo_encrypt_key_size
suffix:semicolon
id|lo-&gt;lo_init
(braket
l_int|0
)braket
op_assign
id|info-&gt;lo_init
(braket
l_int|0
)braket
suffix:semicolon
id|lo-&gt;lo_init
(braket
l_int|1
)braket
op_assign
id|info-&gt;lo_init
(braket
l_int|1
)braket
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;lo_encrypt_key_size
)paren
(brace
id|memcpy
c_func
(paren
id|lo-&gt;lo_encrypt_key
comma
id|info-&gt;lo_encrypt_key
comma
id|info-&gt;lo_encrypt_key_size
)paren
suffix:semicolon
id|lo-&gt;lo_key_owner
op_assign
id|current-&gt;uid
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|loop_get_status
id|loop_get_status
c_func
(paren
r_struct
id|loop_device
op_star
id|lo
comma
r_struct
id|loop_info64
op_star
id|info
)paren
(brace
r_struct
id|file
op_star
id|file
op_assign
id|lo-&gt;lo_backing_file
suffix:semicolon
r_struct
id|kstat
id|stat
suffix:semicolon
r_int
id|error
suffix:semicolon
r_if
c_cond
(paren
id|lo-&gt;lo_state
op_ne
id|Lo_bound
)paren
r_return
op_minus
id|ENXIO
suffix:semicolon
id|error
op_assign
id|vfs_getattr
c_func
(paren
id|file-&gt;f_vfsmnt
comma
id|file-&gt;f_dentry
comma
op_amp
id|stat
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_return
id|error
suffix:semicolon
id|memset
c_func
(paren
id|info
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|info
)paren
)paren
suffix:semicolon
id|info-&gt;lo_number
op_assign
id|lo-&gt;lo_number
suffix:semicolon
id|info-&gt;lo_device
op_assign
id|huge_encode_dev
c_func
(paren
id|stat.dev
)paren
suffix:semicolon
id|info-&gt;lo_inode
op_assign
id|stat.ino
suffix:semicolon
id|info-&gt;lo_rdevice
op_assign
id|huge_encode_dev
c_func
(paren
id|lo-&gt;lo_device
ques
c_cond
id|stat.rdev
suffix:colon
id|stat.dev
)paren
suffix:semicolon
id|info-&gt;lo_offset
op_assign
id|lo-&gt;lo_offset
suffix:semicolon
id|info-&gt;lo_sizelimit
op_assign
id|lo-&gt;lo_sizelimit
suffix:semicolon
id|info-&gt;lo_flags
op_assign
id|lo-&gt;lo_flags
suffix:semicolon
id|memcpy
c_func
(paren
id|info-&gt;lo_file_name
comma
id|lo-&gt;lo_file_name
comma
id|LO_NAME_SIZE
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|info-&gt;lo_crypt_name
comma
id|lo-&gt;lo_crypt_name
comma
id|LO_NAME_SIZE
)paren
suffix:semicolon
id|info-&gt;lo_encrypt_type
op_assign
id|lo-&gt;lo_encryption
ques
c_cond
id|lo-&gt;lo_encryption-&gt;number
suffix:colon
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|lo-&gt;lo_encrypt_key_size
op_logical_and
id|capable
c_func
(paren
id|CAP_SYS_ADMIN
)paren
)paren
(brace
id|info-&gt;lo_encrypt_key_size
op_assign
id|lo-&gt;lo_encrypt_key_size
suffix:semicolon
id|memcpy
c_func
(paren
id|info-&gt;lo_encrypt_key
comma
id|lo-&gt;lo_encrypt_key
comma
id|lo-&gt;lo_encrypt_key_size
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|loop_info64_from_old
id|loop_info64_from_old
c_func
(paren
r_const
r_struct
id|loop_info
op_star
id|info
comma
r_struct
id|loop_info64
op_star
id|info64
)paren
(brace
id|memset
c_func
(paren
id|info64
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|info64
)paren
)paren
suffix:semicolon
id|info64-&gt;lo_number
op_assign
id|info-&gt;lo_number
suffix:semicolon
id|info64-&gt;lo_device
op_assign
id|info-&gt;lo_device
suffix:semicolon
id|info64-&gt;lo_inode
op_assign
id|info-&gt;lo_inode
suffix:semicolon
id|info64-&gt;lo_rdevice
op_assign
id|info-&gt;lo_rdevice
suffix:semicolon
id|info64-&gt;lo_offset
op_assign
id|info-&gt;lo_offset
suffix:semicolon
id|info64-&gt;lo_sizelimit
op_assign
l_int|0
suffix:semicolon
id|info64-&gt;lo_encrypt_type
op_assign
id|info-&gt;lo_encrypt_type
suffix:semicolon
id|info64-&gt;lo_encrypt_key_size
op_assign
id|info-&gt;lo_encrypt_key_size
suffix:semicolon
id|info64-&gt;lo_flags
op_assign
id|info-&gt;lo_flags
suffix:semicolon
id|info64-&gt;lo_init
(braket
l_int|0
)braket
op_assign
id|info-&gt;lo_init
(braket
l_int|0
)braket
suffix:semicolon
id|info64-&gt;lo_init
(braket
l_int|1
)braket
op_assign
id|info-&gt;lo_init
(braket
l_int|1
)braket
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;lo_encrypt_type
op_eq
id|LO_CRYPT_CRYPTOAPI
)paren
id|memcpy
c_func
(paren
id|info64-&gt;lo_crypt_name
comma
id|info-&gt;lo_name
comma
id|LO_NAME_SIZE
)paren
suffix:semicolon
r_else
id|memcpy
c_func
(paren
id|info64-&gt;lo_file_name
comma
id|info-&gt;lo_name
comma
id|LO_NAME_SIZE
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|info64-&gt;lo_encrypt_key
comma
id|info-&gt;lo_encrypt_key
comma
id|LO_KEY_SIZE
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|loop_info64_to_old
id|loop_info64_to_old
c_func
(paren
r_const
r_struct
id|loop_info64
op_star
id|info64
comma
r_struct
id|loop_info
op_star
id|info
)paren
(brace
id|memset
c_func
(paren
id|info
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|info
)paren
)paren
suffix:semicolon
id|info-&gt;lo_number
op_assign
id|info64-&gt;lo_number
suffix:semicolon
id|info-&gt;lo_device
op_assign
id|info64-&gt;lo_device
suffix:semicolon
id|info-&gt;lo_inode
op_assign
id|info64-&gt;lo_inode
suffix:semicolon
id|info-&gt;lo_rdevice
op_assign
id|info64-&gt;lo_rdevice
suffix:semicolon
id|info-&gt;lo_offset
op_assign
id|info64-&gt;lo_offset
suffix:semicolon
id|info-&gt;lo_encrypt_type
op_assign
id|info64-&gt;lo_encrypt_type
suffix:semicolon
id|info-&gt;lo_encrypt_key_size
op_assign
id|info64-&gt;lo_encrypt_key_size
suffix:semicolon
id|info-&gt;lo_flags
op_assign
id|info64-&gt;lo_flags
suffix:semicolon
id|info-&gt;lo_init
(braket
l_int|0
)braket
op_assign
id|info64-&gt;lo_init
(braket
l_int|0
)braket
suffix:semicolon
id|info-&gt;lo_init
(braket
l_int|1
)braket
op_assign
id|info64-&gt;lo_init
(braket
l_int|1
)braket
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;lo_encrypt_type
op_eq
id|LO_CRYPT_CRYPTOAPI
)paren
id|memcpy
c_func
(paren
id|info-&gt;lo_name
comma
id|info64-&gt;lo_crypt_name
comma
id|LO_NAME_SIZE
)paren
suffix:semicolon
r_else
id|memcpy
c_func
(paren
id|info-&gt;lo_name
comma
id|info64-&gt;lo_file_name
comma
id|LO_NAME_SIZE
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|info-&gt;lo_encrypt_key
comma
id|info64-&gt;lo_encrypt_key
comma
id|LO_KEY_SIZE
)paren
suffix:semicolon
multiline_comment|/* error in case values were truncated */
r_if
c_cond
(paren
id|info-&gt;lo_device
op_ne
id|info64-&gt;lo_device
op_logical_or
id|info-&gt;lo_rdevice
op_ne
id|info64-&gt;lo_rdevice
op_logical_or
id|info-&gt;lo_inode
op_ne
id|info64-&gt;lo_inode
op_logical_or
id|info-&gt;lo_offset
op_ne
id|info64-&gt;lo_offset
)paren
r_return
op_minus
id|EOVERFLOW
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|loop_set_status_old
id|loop_set_status_old
c_func
(paren
r_struct
id|loop_device
op_star
id|lo
comma
r_const
r_struct
id|loop_info
id|__user
op_star
id|arg
)paren
(brace
r_struct
id|loop_info
id|info
suffix:semicolon
r_struct
id|loop_info64
id|info64
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|info
comma
id|arg
comma
r_sizeof
(paren
r_struct
id|loop_info
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|loop_info64_from_old
c_func
(paren
op_amp
id|info
comma
op_amp
id|info64
)paren
suffix:semicolon
r_return
id|loop_set_status
c_func
(paren
id|lo
comma
op_amp
id|info64
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|loop_set_status64
id|loop_set_status64
c_func
(paren
r_struct
id|loop_device
op_star
id|lo
comma
r_const
r_struct
id|loop_info64
id|__user
op_star
id|arg
)paren
(brace
r_struct
id|loop_info64
id|info64
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|info64
comma
id|arg
comma
r_sizeof
(paren
r_struct
id|loop_info64
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
id|loop_set_status
c_func
(paren
id|lo
comma
op_amp
id|info64
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|loop_get_status_old
id|loop_get_status_old
c_func
(paren
r_struct
id|loop_device
op_star
id|lo
comma
r_struct
id|loop_info
id|__user
op_star
id|arg
)paren
(brace
r_struct
id|loop_info
id|info
suffix:semicolon
r_struct
id|loop_info64
id|info64
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|arg
)paren
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|err
)paren
id|err
op_assign
id|loop_get_status
c_func
(paren
id|lo
comma
op_amp
id|info64
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|err
)paren
id|err
op_assign
id|loop_info64_to_old
c_func
(paren
op_amp
id|info64
comma
op_amp
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|err
op_logical_and
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|info
comma
r_sizeof
(paren
id|info
)paren
)paren
)paren
id|err
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
r_static
r_int
DECL|function|loop_get_status64
id|loop_get_status64
c_func
(paren
r_struct
id|loop_device
op_star
id|lo
comma
r_struct
id|loop_info64
id|__user
op_star
id|arg
)paren
(brace
r_struct
id|loop_info64
id|info64
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|arg
)paren
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|err
)paren
id|err
op_assign
id|loop_get_status
c_func
(paren
id|lo
comma
op_amp
id|info64
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|err
op_logical_and
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|info64
comma
r_sizeof
(paren
id|info64
)paren
)paren
)paren
id|err
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|lo_ioctl
r_static
r_int
id|lo_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_struct
id|loop_device
op_star
id|lo
op_assign
id|inode-&gt;i_bdev-&gt;bd_disk-&gt;private_data
suffix:semicolon
r_int
id|err
suffix:semicolon
id|down
c_func
(paren
op_amp
id|lo-&gt;lo_ctl_mutex
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|LOOP_SET_FD
suffix:colon
id|err
op_assign
id|loop_set_fd
c_func
(paren
id|lo
comma
id|file
comma
id|inode-&gt;i_bdev
comma
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LOOP_CHANGE_FD
suffix:colon
id|err
op_assign
id|loop_change_fd
c_func
(paren
id|lo
comma
id|file
comma
id|inode-&gt;i_bdev
comma
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LOOP_CLR_FD
suffix:colon
id|err
op_assign
id|loop_clr_fd
c_func
(paren
id|lo
comma
id|inode-&gt;i_bdev
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LOOP_SET_STATUS
suffix:colon
id|err
op_assign
id|loop_set_status_old
c_func
(paren
id|lo
comma
(paren
r_struct
id|loop_info
id|__user
op_star
)paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LOOP_GET_STATUS
suffix:colon
id|err
op_assign
id|loop_get_status_old
c_func
(paren
id|lo
comma
(paren
r_struct
id|loop_info
id|__user
op_star
)paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LOOP_SET_STATUS64
suffix:colon
id|err
op_assign
id|loop_set_status64
c_func
(paren
id|lo
comma
(paren
r_struct
id|loop_info64
id|__user
op_star
)paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LOOP_GET_STATUS64
suffix:colon
id|err
op_assign
id|loop_get_status64
c_func
(paren
id|lo
comma
(paren
r_struct
id|loop_info64
id|__user
op_star
)paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|err
op_assign
id|lo-&gt;ioctl
ques
c_cond
id|lo
op_member_access_from_pointer
id|ioctl
c_func
(paren
id|lo
comma
id|cmd
comma
id|arg
)paren
suffix:colon
op_minus
id|EINVAL
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|lo-&gt;lo_ctl_mutex
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|lo_open
r_static
r_int
id|lo_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|loop_device
op_star
id|lo
op_assign
id|inode-&gt;i_bdev-&gt;bd_disk-&gt;private_data
suffix:semicolon
id|down
c_func
(paren
op_amp
id|lo-&gt;lo_ctl_mutex
)paren
suffix:semicolon
id|lo-&gt;lo_refcnt
op_increment
suffix:semicolon
id|up
c_func
(paren
op_amp
id|lo-&gt;lo_ctl_mutex
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|lo_release
r_static
r_int
id|lo_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|loop_device
op_star
id|lo
op_assign
id|inode-&gt;i_bdev-&gt;bd_disk-&gt;private_data
suffix:semicolon
id|down
c_func
(paren
op_amp
id|lo-&gt;lo_ctl_mutex
)paren
suffix:semicolon
op_decrement
id|lo-&gt;lo_refcnt
suffix:semicolon
id|up
c_func
(paren
op_amp
id|lo-&gt;lo_ctl_mutex
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|lo_fops
r_static
r_struct
id|block_device_operations
id|lo_fops
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|open
op_assign
id|lo_open
comma
dot
id|release
op_assign
id|lo_release
comma
dot
id|ioctl
op_assign
id|lo_ioctl
comma
)brace
suffix:semicolon
multiline_comment|/*&n; * And now the modules code and kernel interface.&n; */
id|module_param
c_func
(paren
id|max_loop
comma
r_int
comma
l_int|0
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|max_loop
comma
l_string|&quot;Maximum number of loop devices (1-256)&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
DECL|variable|LOOP_MAJOR
id|MODULE_ALIAS_BLOCKDEV_MAJOR
c_func
(paren
id|LOOP_MAJOR
)paren
suffix:semicolon
DECL|function|loop_register_transfer
r_int
id|loop_register_transfer
c_func
(paren
r_struct
id|loop_func_table
op_star
id|funcs
)paren
(brace
r_int
r_int
id|n
op_assign
id|funcs-&gt;number
suffix:semicolon
r_if
c_cond
(paren
id|n
op_ge
id|MAX_LO_CRYPT
op_logical_or
id|xfer_funcs
(braket
id|n
)braket
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|xfer_funcs
(braket
id|n
)braket
op_assign
id|funcs
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|loop_unregister_transfer
r_int
id|loop_unregister_transfer
c_func
(paren
r_int
id|number
)paren
(brace
r_int
r_int
id|n
op_assign
id|number
suffix:semicolon
r_struct
id|loop_device
op_star
id|lo
suffix:semicolon
r_struct
id|loop_func_table
op_star
id|xfer
suffix:semicolon
r_if
c_cond
(paren
id|n
op_eq
l_int|0
op_logical_or
id|n
op_ge
id|MAX_LO_CRYPT
op_logical_or
(paren
id|xfer
op_assign
id|xfer_funcs
(braket
id|n
)braket
)paren
op_eq
l_int|NULL
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|xfer_funcs
(braket
id|n
)braket
op_assign
l_int|NULL
suffix:semicolon
r_for
c_loop
(paren
id|lo
op_assign
op_amp
id|loop_dev
(braket
l_int|0
)braket
suffix:semicolon
id|lo
OL
op_amp
id|loop_dev
(braket
id|max_loop
)braket
suffix:semicolon
id|lo
op_increment
)paren
(brace
id|down
c_func
(paren
op_amp
id|lo-&gt;lo_ctl_mutex
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lo-&gt;lo_encryption
op_eq
id|xfer
)paren
id|loop_release_xfer
c_func
(paren
id|lo
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|lo-&gt;lo_ctl_mutex
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|loop_register_transfer
id|EXPORT_SYMBOL
c_func
(paren
id|loop_register_transfer
)paren
suffix:semicolon
DECL|variable|loop_unregister_transfer
id|EXPORT_SYMBOL
c_func
(paren
id|loop_unregister_transfer
)paren
suffix:semicolon
DECL|function|loop_init
r_int
id|__init
id|loop_init
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|max_loop
template_param
l_int|256
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;loop: invalid max_loop (must be between&quot;
l_string|&quot; 1 and 256), using default (8)&bslash;n&quot;
)paren
suffix:semicolon
id|max_loop
op_assign
l_int|8
suffix:semicolon
)brace
r_if
c_cond
(paren
id|register_blkdev
c_func
(paren
id|LOOP_MAJOR
comma
l_string|&quot;loop&quot;
)paren
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|loop_dev
op_assign
id|kmalloc
c_func
(paren
id|max_loop
op_star
r_sizeof
(paren
r_struct
id|loop_device
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|loop_dev
)paren
r_goto
id|out_mem1
suffix:semicolon
id|memset
c_func
(paren
id|loop_dev
comma
l_int|0
comma
id|max_loop
op_star
r_sizeof
(paren
r_struct
id|loop_device
)paren
)paren
suffix:semicolon
id|disks
op_assign
id|kmalloc
c_func
(paren
id|max_loop
op_star
r_sizeof
(paren
r_struct
id|gendisk
op_star
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|disks
)paren
r_goto
id|out_mem2
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|max_loop
suffix:semicolon
id|i
op_increment
)paren
(brace
id|disks
(braket
id|i
)braket
op_assign
id|alloc_disk
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|disks
(braket
id|i
)braket
)paren
r_goto
id|out_mem3
suffix:semicolon
)brace
id|devfs_mk_dir
c_func
(paren
l_string|&quot;loop&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|max_loop
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|loop_device
op_star
id|lo
op_assign
op_amp
id|loop_dev
(braket
id|i
)braket
suffix:semicolon
r_struct
id|gendisk
op_star
id|disk
op_assign
id|disks
(braket
id|i
)braket
suffix:semicolon
id|memset
c_func
(paren
id|lo
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|lo
)paren
)paren
suffix:semicolon
id|lo-&gt;lo_queue
op_assign
id|blk_alloc_queue
c_func
(paren
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|lo-&gt;lo_queue
)paren
r_goto
id|out_mem4
suffix:semicolon
id|init_MUTEX
c_func
(paren
op_amp
id|lo-&gt;lo_ctl_mutex
)paren
suffix:semicolon
id|init_MUTEX_LOCKED
c_func
(paren
op_amp
id|lo-&gt;lo_sem
)paren
suffix:semicolon
id|init_MUTEX_LOCKED
c_func
(paren
op_amp
id|lo-&gt;lo_bh_mutex
)paren
suffix:semicolon
id|lo-&gt;lo_number
op_assign
id|i
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|lo-&gt;lo_lock
)paren
suffix:semicolon
id|disk-&gt;major
op_assign
id|LOOP_MAJOR
suffix:semicolon
id|disk-&gt;first_minor
op_assign
id|i
suffix:semicolon
id|disk-&gt;fops
op_assign
op_amp
id|lo_fops
suffix:semicolon
id|sprintf
c_func
(paren
id|disk-&gt;disk_name
comma
l_string|&quot;loop%d&quot;
comma
id|i
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|disk-&gt;devfs_name
comma
l_string|&quot;loop/%d&quot;
comma
id|i
)paren
suffix:semicolon
id|disk-&gt;private_data
op_assign
id|lo
suffix:semicolon
id|disk-&gt;queue
op_assign
id|lo-&gt;lo_queue
suffix:semicolon
)brace
multiline_comment|/* We cannot fail after we call this, so another loop!*/
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|max_loop
suffix:semicolon
id|i
op_increment
)paren
id|add_disk
c_func
(paren
id|disks
(braket
id|i
)braket
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;loop: loaded (max %d devices)&bslash;n&quot;
comma
id|max_loop
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|out_mem4
suffix:colon
r_while
c_loop
(paren
id|i
op_decrement
)paren
id|blk_put_queue
c_func
(paren
id|loop_dev
(braket
id|i
)braket
dot
id|lo_queue
)paren
suffix:semicolon
id|devfs_remove
c_func
(paren
l_string|&quot;loop&quot;
)paren
suffix:semicolon
id|i
op_assign
id|max_loop
suffix:semicolon
id|out_mem3
suffix:colon
r_while
c_loop
(paren
id|i
op_decrement
)paren
id|put_disk
c_func
(paren
id|disks
(braket
id|i
)braket
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|disks
)paren
suffix:semicolon
id|out_mem2
suffix:colon
id|kfree
c_func
(paren
id|loop_dev
)paren
suffix:semicolon
id|out_mem1
suffix:colon
id|unregister_blkdev
c_func
(paren
id|LOOP_MAJOR
comma
l_string|&quot;loop&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;loop: ran out of memory&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
DECL|function|loop_exit
r_void
id|loop_exit
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|max_loop
suffix:semicolon
id|i
op_increment
)paren
(brace
id|del_gendisk
c_func
(paren
id|disks
(braket
id|i
)braket
)paren
suffix:semicolon
id|blk_put_queue
c_func
(paren
id|loop_dev
(braket
id|i
)braket
dot
id|lo_queue
)paren
suffix:semicolon
id|put_disk
c_func
(paren
id|disks
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|devfs_remove
c_func
(paren
l_string|&quot;loop&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unregister_blkdev
c_func
(paren
id|LOOP_MAJOR
comma
l_string|&quot;loop&quot;
)paren
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;loop: cannot unregister blkdev&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|disks
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|loop_dev
)paren
suffix:semicolon
)brace
DECL|variable|loop_init
id|module_init
c_func
(paren
id|loop_init
)paren
suffix:semicolon
DECL|variable|loop_exit
id|module_exit
c_func
(paren
id|loop_exit
)paren
suffix:semicolon
macro_line|#ifndef MODULE
DECL|function|max_loop_setup
r_static
r_int
id|__init
id|max_loop_setup
c_func
(paren
r_char
op_star
id|str
)paren
(brace
id|max_loop
op_assign
id|simple_strtol
c_func
(paren
id|str
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|__setup
c_func
(paren
l_string|&quot;max_loop=&quot;
comma
id|max_loop_setup
)paren
suffix:semicolon
macro_line|#endif
eof
