multiline_comment|/*&n; *  linux/drivers/block/deadline-iosched.c&n; *&n; *  Deadline i/o scheduler.&n; *&n; *  Copyright (C) 2002 Jens Axboe &lt;axboe@suse.de&gt;&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/blkdev.h&gt;
macro_line|#include &lt;linux/elevator.h&gt;
macro_line|#include &lt;linux/bio.h&gt;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/compiler.h&gt;
macro_line|#include &lt;linux/hash.h&gt;
macro_line|#include &lt;linux/rbtree.h&gt;
multiline_comment|/*&n; * See Documentation/deadline-iosched.txt&n; */
DECL|variable|read_expire
r_static
r_int
id|read_expire
op_assign
id|HZ
op_div
l_int|2
suffix:semicolon
multiline_comment|/* max time before a read is submitted. */
DECL|variable|write_expire
r_static
r_int
id|write_expire
op_assign
l_int|5
op_star
id|HZ
suffix:semicolon
multiline_comment|/* ditto for writes, these limits are SOFT! */
DECL|variable|writes_starved
r_static
r_int
id|writes_starved
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* max times reads can starve a write */
DECL|variable|fifo_batch
r_static
r_int
id|fifo_batch
op_assign
l_int|16
suffix:semicolon
multiline_comment|/* # of sequential requests treated as one&n;&t;&t;&t;&t;     by the above parameters. For throughput. */
DECL|variable|deadline_hash_shift
r_static
r_const
r_int
id|deadline_hash_shift
op_assign
l_int|5
suffix:semicolon
DECL|macro|DL_HASH_BLOCK
mdefine_line|#define DL_HASH_BLOCK(sec)&t;((sec) &gt;&gt; 3)
DECL|macro|DL_HASH_FN
mdefine_line|#define DL_HASH_FN(sec)&t;&t;(hash_long(DL_HASH_BLOCK((sec)), deadline_hash_shift))
DECL|macro|DL_HASH_ENTRIES
mdefine_line|#define DL_HASH_ENTRIES&t;&t;(1 &lt;&lt; deadline_hash_shift)
DECL|macro|rq_hash_key
mdefine_line|#define rq_hash_key(rq)&t;&t;((rq)-&gt;sector + (rq)-&gt;nr_sectors)
DECL|macro|list_entry_hash
mdefine_line|#define list_entry_hash(ptr)&t;list_entry((ptr), struct deadline_rq, hash)
DECL|macro|ON_HASH
mdefine_line|#define ON_HASH(drq)&t;&t;(drq)-&gt;on_hash
DECL|struct|deadline_data
r_struct
id|deadline_data
(brace
multiline_comment|/*&n;&t; * run time data&n;&t; */
multiline_comment|/*&n;&t; * requests (deadline_rq s) are present on both sort_list and fifo_list&n;&t; */
DECL|member|sort_list
r_struct
id|rb_root
id|sort_list
(braket
l_int|2
)braket
suffix:semicolon
DECL|member|fifo_list
r_struct
id|list_head
id|fifo_list
(braket
l_int|2
)braket
suffix:semicolon
multiline_comment|/*&n;&t; * next in sort order. read, write or both are NULL&n;&t; */
DECL|member|next_drq
r_struct
id|deadline_rq
op_star
id|next_drq
(braket
l_int|2
)braket
suffix:semicolon
DECL|member|dispatch
r_struct
id|list_head
op_star
id|dispatch
suffix:semicolon
multiline_comment|/* driver dispatch queue */
DECL|member|hash
r_struct
id|list_head
op_star
id|hash
suffix:semicolon
multiline_comment|/* request hash */
DECL|member|batching
r_int
r_int
id|batching
suffix:semicolon
multiline_comment|/* number of sequential requests made */
DECL|member|last_sector
id|sector_t
id|last_sector
suffix:semicolon
multiline_comment|/* head position */
DECL|member|starved
r_int
r_int
id|starved
suffix:semicolon
multiline_comment|/* times reads have starved writes */
multiline_comment|/*&n;&t; * settings that change how the i/o scheduler behaves&n;&t; */
DECL|member|fifo_expire
r_int
id|fifo_expire
(braket
l_int|2
)braket
suffix:semicolon
DECL|member|fifo_batch
r_int
id|fifo_batch
suffix:semicolon
DECL|member|writes_starved
r_int
id|writes_starved
suffix:semicolon
DECL|member|front_merges
r_int
id|front_merges
suffix:semicolon
DECL|member|drq_pool
id|mempool_t
op_star
id|drq_pool
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/*&n; * pre-request data.&n; */
DECL|struct|deadline_rq
r_struct
id|deadline_rq
(brace
multiline_comment|/*&n;&t; * rbtree index, key is the starting offset&n;&t; */
DECL|member|rb_node
r_struct
id|rb_node
id|rb_node
suffix:semicolon
DECL|member|rb_key
id|sector_t
id|rb_key
suffix:semicolon
DECL|member|request
r_struct
id|request
op_star
id|request
suffix:semicolon
multiline_comment|/*&n;&t; * request hash, key is the ending offset (for back merge lookup)&n;&t; */
DECL|member|hash
r_struct
id|list_head
id|hash
suffix:semicolon
DECL|member|on_hash
r_char
id|on_hash
suffix:semicolon
multiline_comment|/*&n;&t; * expire fifo&n;&t; */
DECL|member|fifo
r_struct
id|list_head
id|fifo
suffix:semicolon
DECL|member|expires
r_int
r_int
id|expires
suffix:semicolon
)brace
suffix:semicolon
r_static
r_void
id|deadline_move_request
c_func
(paren
r_struct
id|deadline_data
op_star
id|dd
comma
r_struct
id|deadline_rq
op_star
id|drq
)paren
suffix:semicolon
DECL|variable|drq_pool
r_static
id|kmem_cache_t
op_star
id|drq_pool
suffix:semicolon
DECL|macro|RQ_DATA
mdefine_line|#define RQ_DATA(rq)&t;((struct deadline_rq *) (rq)-&gt;elevator_private)
multiline_comment|/*&n; * the back merge hash support functions&n; */
DECL|function|__deadline_del_drq_hash
r_static
r_inline
r_void
id|__deadline_del_drq_hash
c_func
(paren
r_struct
id|deadline_rq
op_star
id|drq
)paren
(brace
id|drq-&gt;on_hash
op_assign
l_int|0
suffix:semicolon
id|list_del_init
c_func
(paren
op_amp
id|drq-&gt;hash
)paren
suffix:semicolon
)brace
DECL|function|deadline_del_drq_hash
r_static
r_inline
r_void
id|deadline_del_drq_hash
c_func
(paren
r_struct
id|deadline_rq
op_star
id|drq
)paren
(brace
r_if
c_cond
(paren
id|ON_HASH
c_func
(paren
id|drq
)paren
)paren
id|__deadline_del_drq_hash
c_func
(paren
id|drq
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|deadline_remove_merge_hints
id|deadline_remove_merge_hints
c_func
(paren
id|request_queue_t
op_star
id|q
comma
r_struct
id|deadline_rq
op_star
id|drq
)paren
(brace
id|deadline_del_drq_hash
c_func
(paren
id|drq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|q-&gt;last_merge
op_eq
id|drq-&gt;request
)paren
id|q-&gt;last_merge
op_assign
l_int|NULL
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|deadline_add_drq_hash
id|deadline_add_drq_hash
c_func
(paren
r_struct
id|deadline_data
op_star
id|dd
comma
r_struct
id|deadline_rq
op_star
id|drq
)paren
(brace
r_struct
id|request
op_star
id|rq
op_assign
id|drq-&gt;request
suffix:semicolon
id|BUG_ON
c_func
(paren
id|ON_HASH
c_func
(paren
id|drq
)paren
)paren
suffix:semicolon
id|drq-&gt;on_hash
op_assign
l_int|1
suffix:semicolon
id|list_add
c_func
(paren
op_amp
id|drq-&gt;hash
comma
op_amp
id|dd-&gt;hash
(braket
id|DL_HASH_FN
c_func
(paren
id|rq_hash_key
c_func
(paren
id|rq
)paren
)paren
)braket
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * move hot entry to front of chain&n; */
r_static
r_inline
r_void
DECL|function|deadline_hot_drq_hash
id|deadline_hot_drq_hash
c_func
(paren
r_struct
id|deadline_data
op_star
id|dd
comma
r_struct
id|deadline_rq
op_star
id|drq
)paren
(brace
r_struct
id|request
op_star
id|rq
op_assign
id|drq-&gt;request
suffix:semicolon
r_struct
id|list_head
op_star
id|head
op_assign
op_amp
id|dd-&gt;hash
(braket
id|DL_HASH_FN
c_func
(paren
id|rq_hash_key
c_func
(paren
id|rq
)paren
)paren
)braket
suffix:semicolon
r_if
c_cond
(paren
id|ON_HASH
c_func
(paren
id|drq
)paren
op_logical_and
id|drq-&gt;hash.prev
op_ne
id|head
)paren
(brace
id|list_del
c_func
(paren
op_amp
id|drq-&gt;hash
)paren
suffix:semicolon
id|list_add
c_func
(paren
op_amp
id|drq-&gt;hash
comma
id|head
)paren
suffix:semicolon
)brace
)brace
r_static
r_struct
id|request
op_star
DECL|function|deadline_find_drq_hash
id|deadline_find_drq_hash
c_func
(paren
r_struct
id|deadline_data
op_star
id|dd
comma
id|sector_t
id|offset
)paren
(brace
r_struct
id|list_head
op_star
id|hash_list
op_assign
op_amp
id|dd-&gt;hash
(braket
id|DL_HASH_FN
c_func
(paren
id|offset
)paren
)braket
suffix:semicolon
r_struct
id|list_head
op_star
id|entry
comma
op_star
id|next
op_assign
id|hash_list-&gt;next
suffix:semicolon
r_while
c_loop
(paren
(paren
id|entry
op_assign
id|next
)paren
op_ne
id|hash_list
)paren
(brace
r_struct
id|deadline_rq
op_star
id|drq
op_assign
id|list_entry_hash
c_func
(paren
id|entry
)paren
suffix:semicolon
r_struct
id|request
op_star
id|__rq
op_assign
id|drq-&gt;request
suffix:semicolon
id|next
op_assign
id|entry-&gt;next
suffix:semicolon
id|BUG_ON
c_func
(paren
op_logical_neg
id|ON_HASH
c_func
(paren
id|drq
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rq_mergeable
c_func
(paren
id|__rq
)paren
)paren
(brace
id|__deadline_del_drq_hash
c_func
(paren
id|drq
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rq_hash_key
c_func
(paren
id|__rq
)paren
op_eq
id|offset
)paren
r_return
id|__rq
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; * rb tree support functions&n; */
DECL|macro|RB_NONE
mdefine_line|#define RB_NONE&t;&t;(2)
DECL|macro|RB_EMPTY
mdefine_line|#define RB_EMPTY(root)&t;((root)-&gt;rb_node == NULL)
DECL|macro|ON_RB
mdefine_line|#define ON_RB(node)&t;((node)-&gt;rb_color != RB_NONE)
DECL|macro|RB_CLEAR
mdefine_line|#define RB_CLEAR(node)&t;((node)-&gt;rb_color = RB_NONE)
DECL|macro|rb_entry_drq
mdefine_line|#define rb_entry_drq(node)&t;rb_entry((node), struct deadline_rq, rb_node)
DECL|macro|DRQ_RB_ROOT
mdefine_line|#define DRQ_RB_ROOT(dd, drq)&t;(&amp;(dd)-&gt;sort_list[rq_data_dir((drq)-&gt;request)])
DECL|macro|rq_rb_key
mdefine_line|#define rq_rb_key(rq)&t;&t;(rq)-&gt;sector
r_static
r_struct
id|deadline_rq
op_star
DECL|function|__deadline_add_drq_rb
id|__deadline_add_drq_rb
c_func
(paren
r_struct
id|deadline_data
op_star
id|dd
comma
r_struct
id|deadline_rq
op_star
id|drq
)paren
(brace
r_struct
id|rb_node
op_star
op_star
id|p
op_assign
op_amp
id|DRQ_RB_ROOT
c_func
(paren
id|dd
comma
id|drq
)paren
op_member_access_from_pointer
id|rb_node
suffix:semicolon
r_struct
id|rb_node
op_star
id|parent
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|deadline_rq
op_star
id|__drq
suffix:semicolon
r_while
c_loop
(paren
op_star
id|p
)paren
(brace
id|parent
op_assign
op_star
id|p
suffix:semicolon
id|__drq
op_assign
id|rb_entry_drq
c_func
(paren
id|parent
)paren
suffix:semicolon
r_if
c_cond
(paren
id|drq-&gt;rb_key
OL
id|__drq-&gt;rb_key
)paren
id|p
op_assign
op_amp
(paren
op_star
id|p
)paren
op_member_access_from_pointer
id|rb_left
suffix:semicolon
r_else
r_if
c_cond
(paren
id|drq-&gt;rb_key
OG
id|__drq-&gt;rb_key
)paren
id|p
op_assign
op_amp
(paren
op_star
id|p
)paren
op_member_access_from_pointer
id|rb_right
suffix:semicolon
r_else
r_return
id|__drq
suffix:semicolon
)brace
id|rb_link_node
c_func
(paren
op_amp
id|drq-&gt;rb_node
comma
id|parent
comma
id|p
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_static
r_void
DECL|function|deadline_add_drq_rb
id|deadline_add_drq_rb
c_func
(paren
r_struct
id|deadline_data
op_star
id|dd
comma
r_struct
id|deadline_rq
op_star
id|drq
)paren
(brace
r_struct
id|deadline_rq
op_star
id|__alias
suffix:semicolon
id|drq-&gt;rb_key
op_assign
id|rq_rb_key
c_func
(paren
id|drq-&gt;request
)paren
suffix:semicolon
id|retry
suffix:colon
id|__alias
op_assign
id|__deadline_add_drq_rb
c_func
(paren
id|dd
comma
id|drq
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|__alias
)paren
(brace
id|rb_insert_color
c_func
(paren
op_amp
id|drq-&gt;rb_node
comma
id|DRQ_RB_ROOT
c_func
(paren
id|dd
comma
id|drq
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|deadline_move_request
c_func
(paren
id|dd
comma
id|__alias
)paren
suffix:semicolon
r_goto
id|retry
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|deadline_del_drq_rb
id|deadline_del_drq_rb
c_func
(paren
r_struct
id|deadline_data
op_star
id|dd
comma
r_struct
id|deadline_rq
op_star
id|drq
)paren
(brace
r_const
r_int
id|data_dir
op_assign
id|rq_data_dir
c_func
(paren
id|drq-&gt;request
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dd-&gt;next_drq
(braket
id|data_dir
)braket
op_eq
id|drq
)paren
(brace
r_struct
id|rb_node
op_star
id|rbnext
op_assign
id|rb_next
c_func
(paren
op_amp
id|drq-&gt;rb_node
)paren
suffix:semicolon
id|dd-&gt;next_drq
(braket
id|data_dir
)braket
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|rbnext
)paren
id|dd-&gt;next_drq
(braket
id|data_dir
)braket
op_assign
id|rb_entry_drq
c_func
(paren
id|rbnext
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ON_RB
c_func
(paren
op_amp
id|drq-&gt;rb_node
)paren
)paren
(brace
id|rb_erase
c_func
(paren
op_amp
id|drq-&gt;rb_node
comma
id|DRQ_RB_ROOT
c_func
(paren
id|dd
comma
id|drq
)paren
)paren
suffix:semicolon
id|RB_CLEAR
c_func
(paren
op_amp
id|drq-&gt;rb_node
)paren
suffix:semicolon
)brace
)brace
r_static
r_struct
id|request
op_star
DECL|function|deadline_find_drq_rb
id|deadline_find_drq_rb
c_func
(paren
r_struct
id|deadline_data
op_star
id|dd
comma
id|sector_t
id|sector
comma
r_int
id|data_dir
)paren
(brace
r_struct
id|rb_node
op_star
id|n
op_assign
id|dd-&gt;sort_list
(braket
id|data_dir
)braket
dot
id|rb_node
suffix:semicolon
r_struct
id|deadline_rq
op_star
id|drq
suffix:semicolon
r_while
c_loop
(paren
id|n
)paren
(brace
id|drq
op_assign
id|rb_entry_drq
c_func
(paren
id|n
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sector
OL
id|drq-&gt;rb_key
)paren
id|n
op_assign
id|n-&gt;rb_left
suffix:semicolon
r_else
r_if
c_cond
(paren
id|sector
OG
id|drq-&gt;rb_key
)paren
id|n
op_assign
id|n-&gt;rb_right
suffix:semicolon
r_else
r_return
id|drq-&gt;request
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; * deadline_find_first_drq finds the first (lowest sector numbered) request&n; * for the specified data_dir. Used to sweep back to the start of the disk&n; * (1-way elevator) after we process the last (highest sector) request.&n; */
r_static
r_struct
id|deadline_rq
op_star
DECL|function|deadline_find_first_drq
id|deadline_find_first_drq
c_func
(paren
r_struct
id|deadline_data
op_star
id|dd
comma
r_int
id|data_dir
)paren
(brace
r_struct
id|rb_node
op_star
id|n
op_assign
id|dd-&gt;sort_list
(braket
id|data_dir
)braket
dot
id|rb_node
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
r_if
c_cond
(paren
id|n-&gt;rb_left
op_eq
l_int|NULL
)paren
r_return
id|rb_entry_drq
c_func
(paren
id|n
)paren
suffix:semicolon
id|n
op_assign
id|n-&gt;rb_left
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * add drq to rbtree and fifo&n; */
r_static
r_inline
r_void
DECL|function|deadline_add_request
id|deadline_add_request
c_func
(paren
r_struct
id|request_queue
op_star
id|q
comma
r_struct
id|request
op_star
id|rq
)paren
(brace
r_struct
id|deadline_data
op_star
id|dd
op_assign
id|q-&gt;elevator-&gt;elevator_data
suffix:semicolon
r_struct
id|deadline_rq
op_star
id|drq
op_assign
id|RQ_DATA
c_func
(paren
id|rq
)paren
suffix:semicolon
r_const
r_int
id|data_dir
op_assign
id|rq_data_dir
c_func
(paren
id|drq-&gt;request
)paren
suffix:semicolon
id|deadline_add_drq_rb
c_func
(paren
id|dd
comma
id|drq
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * set expire time (only used for reads) and add to fifo list&n;&t; */
id|drq-&gt;expires
op_assign
id|jiffies
op_plus
id|dd-&gt;fifo_expire
(braket
id|data_dir
)braket
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|drq-&gt;fifo
comma
op_amp
id|dd-&gt;fifo_list
(braket
id|data_dir
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rq_mergeable
c_func
(paren
id|rq
)paren
)paren
(brace
id|deadline_add_drq_hash
c_func
(paren
id|dd
comma
id|drq
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|q-&gt;last_merge
)paren
id|q-&gt;last_merge
op_assign
id|rq
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * remove rq from rbtree, fifo, and hash&n; */
DECL|function|deadline_remove_request
r_static
r_void
id|deadline_remove_request
c_func
(paren
id|request_queue_t
op_star
id|q
comma
r_struct
id|request
op_star
id|rq
)paren
(brace
r_struct
id|deadline_rq
op_star
id|drq
op_assign
id|RQ_DATA
c_func
(paren
id|rq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|drq
)paren
(brace
r_struct
id|deadline_data
op_star
id|dd
op_assign
id|q-&gt;elevator-&gt;elevator_data
suffix:semicolon
id|list_del_init
c_func
(paren
op_amp
id|drq-&gt;fifo
)paren
suffix:semicolon
id|deadline_remove_merge_hints
c_func
(paren
id|q
comma
id|drq
)paren
suffix:semicolon
id|deadline_del_drq_rb
c_func
(paren
id|dd
comma
id|drq
)paren
suffix:semicolon
)brace
)brace
r_static
r_int
DECL|function|deadline_merge
id|deadline_merge
c_func
(paren
id|request_queue_t
op_star
id|q
comma
r_struct
id|request
op_star
op_star
id|req
comma
r_struct
id|bio
op_star
id|bio
)paren
(brace
r_struct
id|deadline_data
op_star
id|dd
op_assign
id|q-&gt;elevator-&gt;elevator_data
suffix:semicolon
r_struct
id|request
op_star
id|__rq
suffix:semicolon
r_int
id|ret
suffix:semicolon
multiline_comment|/*&n;&t; * try last_merge to avoid going to hash&n;&t; */
id|ret
op_assign
id|elv_try_last_merge
c_func
(paren
id|q
comma
id|bio
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ne
id|ELEVATOR_NO_MERGE
)paren
(brace
id|__rq
op_assign
id|q-&gt;last_merge
suffix:semicolon
r_goto
id|out_insert
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * see if the merge hash can satisfy a back merge&n;&t; */
id|__rq
op_assign
id|deadline_find_drq_hash
c_func
(paren
id|dd
comma
id|bio-&gt;bi_sector
)paren
suffix:semicolon
r_if
c_cond
(paren
id|__rq
)paren
(brace
id|BUG_ON
c_func
(paren
id|__rq-&gt;sector
op_plus
id|__rq-&gt;nr_sectors
op_ne
id|bio-&gt;bi_sector
)paren
suffix:semicolon
r_if
c_cond
(paren
id|elv_rq_merge_ok
c_func
(paren
id|__rq
comma
id|bio
)paren
)paren
(brace
id|ret
op_assign
id|ELEVATOR_BACK_MERGE
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t; * check for front merge&n;&t; */
r_if
c_cond
(paren
id|dd-&gt;front_merges
)paren
(brace
id|sector_t
id|rb_key
op_assign
id|bio-&gt;bi_sector
op_plus
id|bio_sectors
c_func
(paren
id|bio
)paren
suffix:semicolon
id|__rq
op_assign
id|deadline_find_drq_rb
c_func
(paren
id|dd
comma
id|rb_key
comma
id|bio_data_dir
c_func
(paren
id|bio
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|__rq
)paren
(brace
id|BUG_ON
c_func
(paren
id|rb_key
op_ne
id|rq_rb_key
c_func
(paren
id|__rq
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|elv_rq_merge_ok
c_func
(paren
id|__rq
comma
id|bio
)paren
)paren
(brace
id|ret
op_assign
id|ELEVATOR_FRONT_MERGE
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
)brace
r_return
id|ELEVATOR_NO_MERGE
suffix:semicolon
id|out
suffix:colon
id|q-&gt;last_merge
op_assign
id|__rq
suffix:semicolon
id|out_insert
suffix:colon
r_if
c_cond
(paren
id|ret
)paren
id|deadline_hot_drq_hash
c_func
(paren
id|dd
comma
id|RQ_DATA
c_func
(paren
id|__rq
)paren
)paren
suffix:semicolon
op_star
id|req
op_assign
id|__rq
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|deadline_merged_request
r_static
r_void
id|deadline_merged_request
c_func
(paren
id|request_queue_t
op_star
id|q
comma
r_struct
id|request
op_star
id|req
)paren
(brace
r_struct
id|deadline_data
op_star
id|dd
op_assign
id|q-&gt;elevator-&gt;elevator_data
suffix:semicolon
r_struct
id|deadline_rq
op_star
id|drq
op_assign
id|RQ_DATA
c_func
(paren
id|req
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * hash always needs to be repositioned, key is end sector&n;&t; */
id|deadline_del_drq_hash
c_func
(paren
id|drq
)paren
suffix:semicolon
id|deadline_add_drq_hash
c_func
(paren
id|dd
comma
id|drq
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * if the merge was a front merge, we need to reposition request&n;&t; */
r_if
c_cond
(paren
id|rq_rb_key
c_func
(paren
id|req
)paren
op_ne
id|drq-&gt;rb_key
)paren
(brace
id|deadline_del_drq_rb
c_func
(paren
id|dd
comma
id|drq
)paren
suffix:semicolon
id|deadline_add_drq_rb
c_func
(paren
id|dd
comma
id|drq
)paren
suffix:semicolon
)brace
id|q-&gt;last_merge
op_assign
id|req
suffix:semicolon
)brace
r_static
r_void
DECL|function|deadline_merged_requests
id|deadline_merged_requests
c_func
(paren
id|request_queue_t
op_star
id|q
comma
r_struct
id|request
op_star
id|req
comma
r_struct
id|request
op_star
id|next
)paren
(brace
r_struct
id|deadline_data
op_star
id|dd
op_assign
id|q-&gt;elevator-&gt;elevator_data
suffix:semicolon
r_struct
id|deadline_rq
op_star
id|drq
op_assign
id|RQ_DATA
c_func
(paren
id|req
)paren
suffix:semicolon
r_struct
id|deadline_rq
op_star
id|dnext
op_assign
id|RQ_DATA
c_func
(paren
id|next
)paren
suffix:semicolon
id|BUG_ON
c_func
(paren
op_logical_neg
id|drq
)paren
suffix:semicolon
id|BUG_ON
c_func
(paren
op_logical_neg
id|dnext
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * reposition drq (this is the merged request) in hash, and in rbtree&n;&t; * in case of a front merge&n;&t; */
id|deadline_del_drq_hash
c_func
(paren
id|drq
)paren
suffix:semicolon
id|deadline_add_drq_hash
c_func
(paren
id|dd
comma
id|drq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rq_rb_key
c_func
(paren
id|req
)paren
op_ne
id|drq-&gt;rb_key
)paren
(brace
id|deadline_del_drq_rb
c_func
(paren
id|dd
comma
id|drq
)paren
suffix:semicolon
id|deadline_add_drq_rb
c_func
(paren
id|dd
comma
id|drq
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * if dnext expires before drq, assign its expire time to drq&n;&t; * and move into dnext position (dnext will be deleted) in fifo&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|drq-&gt;fifo
)paren
op_logical_and
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|dnext-&gt;fifo
)paren
)paren
(brace
r_if
c_cond
(paren
id|time_before
c_func
(paren
id|dnext-&gt;expires
comma
id|drq-&gt;expires
)paren
)paren
(brace
id|list_move
c_func
(paren
op_amp
id|drq-&gt;fifo
comma
op_amp
id|dnext-&gt;fifo
)paren
suffix:semicolon
id|drq-&gt;expires
op_assign
id|dnext-&gt;expires
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t; * kill knowledge of next, this one is a goner&n;&t; */
id|deadline_remove_request
c_func
(paren
id|q
comma
id|next
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * move request from sort list to dispatch queue.&n; */
r_static
r_inline
r_void
DECL|function|deadline_move_to_dispatch
id|deadline_move_to_dispatch
c_func
(paren
r_struct
id|deadline_data
op_star
id|dd
comma
r_struct
id|deadline_rq
op_star
id|drq
)paren
(brace
id|request_queue_t
op_star
id|q
op_assign
id|drq-&gt;request-&gt;q
suffix:semicolon
id|deadline_remove_request
c_func
(paren
id|q
comma
id|drq-&gt;request
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|drq-&gt;request-&gt;queuelist
comma
id|dd-&gt;dispatch
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * move an entry to dispatch queue&n; */
r_static
r_void
DECL|function|deadline_move_request
id|deadline_move_request
c_func
(paren
r_struct
id|deadline_data
op_star
id|dd
comma
r_struct
id|deadline_rq
op_star
id|drq
)paren
(brace
r_const
r_int
id|data_dir
op_assign
id|rq_data_dir
c_func
(paren
id|drq-&gt;request
)paren
suffix:semicolon
r_struct
id|rb_node
op_star
id|rbnext
op_assign
id|rb_next
c_func
(paren
op_amp
id|drq-&gt;rb_node
)paren
suffix:semicolon
id|dd-&gt;next_drq
(braket
id|READ
)braket
op_assign
l_int|NULL
suffix:semicolon
id|dd-&gt;next_drq
(braket
id|WRITE
)braket
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|rbnext
)paren
id|dd-&gt;next_drq
(braket
id|data_dir
)braket
op_assign
id|rb_entry_drq
c_func
(paren
id|rbnext
)paren
suffix:semicolon
id|dd-&gt;last_sector
op_assign
id|drq-&gt;request-&gt;sector
op_plus
id|drq-&gt;request-&gt;nr_sectors
suffix:semicolon
multiline_comment|/*&n;&t; * take it off the sort and fifo list, move&n;&t; * to dispatch queue&n;&t; */
id|deadline_move_to_dispatch
c_func
(paren
id|dd
comma
id|drq
)paren
suffix:semicolon
)brace
DECL|macro|list_entry_fifo
mdefine_line|#define list_entry_fifo(ptr)&t;list_entry((ptr), struct deadline_rq, fifo)
multiline_comment|/*&n; * deadline_check_fifo returns 0 if there are no expired reads on the fifo,&n; * 1 otherwise. Requires !list_empty(&amp;dd-&gt;fifo_list[data_dir])&n; */
DECL|function|deadline_check_fifo
r_static
r_inline
r_int
id|deadline_check_fifo
c_func
(paren
r_struct
id|deadline_data
op_star
id|dd
comma
r_int
id|ddir
)paren
(brace
r_struct
id|deadline_rq
op_star
id|drq
op_assign
id|list_entry_fifo
c_func
(paren
id|dd-&gt;fifo_list
(braket
id|ddir
)braket
dot
id|next
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * drq is expired!&n;&t; */
r_if
c_cond
(paren
id|time_after
c_func
(paren
id|jiffies
comma
id|drq-&gt;expires
)paren
)paren
r_return
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * deadline_dispatch_requests selects the best request according to&n; * read/write expire, fifo_batch, etc&n; */
DECL|function|deadline_dispatch_requests
r_static
r_int
id|deadline_dispatch_requests
c_func
(paren
r_struct
id|deadline_data
op_star
id|dd
)paren
(brace
r_const
r_int
id|reads
op_assign
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|dd-&gt;fifo_list
(braket
id|READ
)braket
)paren
suffix:semicolon
r_const
r_int
id|writes
op_assign
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|dd-&gt;fifo_list
(braket
id|WRITE
)braket
)paren
suffix:semicolon
r_struct
id|deadline_rq
op_star
id|drq
suffix:semicolon
r_int
id|data_dir
comma
id|other_dir
suffix:semicolon
multiline_comment|/*&n;&t; * batches are currently reads XOR writes&n;&t; */
id|drq
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|dd-&gt;next_drq
(braket
id|READ
)braket
)paren
id|drq
op_assign
id|dd-&gt;next_drq
(braket
id|READ
)braket
suffix:semicolon
r_if
c_cond
(paren
id|dd-&gt;next_drq
(braket
id|WRITE
)braket
)paren
id|drq
op_assign
id|dd-&gt;next_drq
(braket
id|WRITE
)braket
suffix:semicolon
r_if
c_cond
(paren
id|drq
)paren
(brace
multiline_comment|/* we have a &quot;next request&quot; */
r_if
c_cond
(paren
id|dd-&gt;last_sector
op_ne
id|drq-&gt;request-&gt;sector
)paren
multiline_comment|/* end the batch on a non sequential request */
id|dd-&gt;batching
op_add_assign
id|dd-&gt;fifo_batch
suffix:semicolon
r_if
c_cond
(paren
id|dd-&gt;batching
OL
id|dd-&gt;fifo_batch
)paren
multiline_comment|/* we are still entitled to batch */
r_goto
id|dispatch_request
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * at this point we are not running a batch. select the appropriate&n;&t; * data direction (read / write)&n;&t; */
r_if
c_cond
(paren
id|reads
)paren
(brace
id|BUG_ON
c_func
(paren
id|RB_EMPTY
c_func
(paren
op_amp
id|dd-&gt;sort_list
(braket
id|READ
)braket
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|writes
op_logical_and
(paren
id|dd-&gt;starved
op_increment
op_ge
id|dd-&gt;writes_starved
)paren
)paren
r_goto
id|dispatch_writes
suffix:semicolon
id|data_dir
op_assign
id|READ
suffix:semicolon
id|other_dir
op_assign
id|WRITE
suffix:semicolon
r_goto
id|dispatch_find_request
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * there are either no reads or writes have been starved&n;&t; */
r_if
c_cond
(paren
id|writes
)paren
(brace
id|dispatch_writes
suffix:colon
id|BUG_ON
c_func
(paren
id|RB_EMPTY
c_func
(paren
op_amp
id|dd-&gt;sort_list
(braket
id|WRITE
)braket
)paren
)paren
suffix:semicolon
id|dd-&gt;starved
op_assign
l_int|0
suffix:semicolon
id|data_dir
op_assign
id|WRITE
suffix:semicolon
id|other_dir
op_assign
id|READ
suffix:semicolon
r_goto
id|dispatch_find_request
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
id|dispatch_find_request
suffix:colon
multiline_comment|/*&n;&t; * we are not running a batch, find best request for selected data_dir&n;&t; */
r_if
c_cond
(paren
id|deadline_check_fifo
c_func
(paren
id|dd
comma
id|data_dir
)paren
)paren
(brace
multiline_comment|/* An expired request exists - satisfy it */
id|dd-&gt;batching
op_assign
l_int|0
suffix:semicolon
id|drq
op_assign
id|list_entry_fifo
c_func
(paren
id|dd-&gt;fifo_list
(braket
id|data_dir
)braket
dot
id|next
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|dd-&gt;next_drq
(braket
id|data_dir
)braket
)paren
(brace
multiline_comment|/*&n;&t;&t; * The last req was the same dir and we have a next request in&n;&t;&t; * sort order. No expired requests so continue on from here.&n;&t;&t; */
id|drq
op_assign
id|dd-&gt;next_drq
(braket
id|data_dir
)braket
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t; * The last req was the other direction or we have run out of&n;&t;&t; * higher-sectored requests. Go back to the lowest sectored&n;&t;&t; * request (1 way elevator) and start a new batch.&n;&t;&t; */
id|dd-&gt;batching
op_assign
l_int|0
suffix:semicolon
id|drq
op_assign
id|deadline_find_first_drq
c_func
(paren
id|dd
comma
id|data_dir
)paren
suffix:semicolon
)brace
id|dispatch_request
suffix:colon
multiline_comment|/*&n;&t; * drq is the selected appropriate request.&n;&t; */
id|dd-&gt;batching
op_increment
suffix:semicolon
id|deadline_move_request
c_func
(paren
id|dd
comma
id|drq
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|deadline_next_request
r_static
r_struct
id|request
op_star
id|deadline_next_request
c_func
(paren
id|request_queue_t
op_star
id|q
)paren
(brace
r_struct
id|deadline_data
op_star
id|dd
op_assign
id|q-&gt;elevator-&gt;elevator_data
suffix:semicolon
r_struct
id|request
op_star
id|rq
suffix:semicolon
multiline_comment|/*&n;&t; * if there are still requests on the dispatch queue, grab the first one&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
id|dd-&gt;dispatch
)paren
)paren
(brace
id|dispatch
suffix:colon
id|rq
op_assign
id|list_entry_rq
c_func
(paren
id|dd-&gt;dispatch-&gt;next
)paren
suffix:semicolon
r_return
id|rq
suffix:semicolon
)brace
r_if
c_cond
(paren
id|deadline_dispatch_requests
c_func
(paren
id|dd
)paren
)paren
r_goto
id|dispatch
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_static
r_void
DECL|function|deadline_insert_request
id|deadline_insert_request
c_func
(paren
id|request_queue_t
op_star
id|q
comma
r_struct
id|request
op_star
id|rq
comma
r_int
id|where
)paren
(brace
r_struct
id|deadline_data
op_star
id|dd
op_assign
id|q-&gt;elevator-&gt;elevator_data
suffix:semicolon
multiline_comment|/* barriers must flush the reorder queue */
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|rq-&gt;flags
op_amp
(paren
id|REQ_SOFTBARRIER
op_or
id|REQ_HARDBARRIER
)paren
op_logical_and
id|where
op_eq
id|ELEVATOR_INSERT_SORT
)paren
)paren
id|where
op_assign
id|ELEVATOR_INSERT_BACK
suffix:semicolon
r_switch
c_cond
(paren
id|where
)paren
(brace
r_case
id|ELEVATOR_INSERT_BACK
suffix:colon
r_while
c_loop
(paren
id|deadline_dispatch_requests
c_func
(paren
id|dd
)paren
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|rq-&gt;queuelist
comma
id|dd-&gt;dispatch
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ELEVATOR_INSERT_FRONT
suffix:colon
id|list_add
c_func
(paren
op_amp
id|rq-&gt;queuelist
comma
id|dd-&gt;dispatch
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ELEVATOR_INSERT_SORT
suffix:colon
id|BUG_ON
c_func
(paren
op_logical_neg
id|blk_fs_request
c_func
(paren
id|rq
)paren
)paren
suffix:semicolon
id|deadline_add_request
c_func
(paren
id|q
comma
id|rq
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;%s: bad insert point %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|where
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
DECL|function|deadline_queue_empty
r_static
r_int
id|deadline_queue_empty
c_func
(paren
id|request_queue_t
op_star
id|q
)paren
(brace
r_struct
id|deadline_data
op_star
id|dd
op_assign
id|q-&gt;elevator-&gt;elevator_data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|dd-&gt;fifo_list
(braket
id|WRITE
)braket
)paren
op_logical_or
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|dd-&gt;fifo_list
(braket
id|READ
)braket
)paren
op_logical_or
op_logical_neg
id|list_empty
c_func
(paren
id|dd-&gt;dispatch
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_static
r_struct
id|request
op_star
DECL|function|deadline_former_request
id|deadline_former_request
c_func
(paren
id|request_queue_t
op_star
id|q
comma
r_struct
id|request
op_star
id|rq
)paren
(brace
r_struct
id|deadline_rq
op_star
id|drq
op_assign
id|RQ_DATA
c_func
(paren
id|rq
)paren
suffix:semicolon
r_struct
id|rb_node
op_star
id|rbprev
op_assign
id|rb_prev
c_func
(paren
op_amp
id|drq-&gt;rb_node
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rbprev
)paren
r_return
id|rb_entry_drq
c_func
(paren
id|rbprev
)paren
op_member_access_from_pointer
id|request
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_static
r_struct
id|request
op_star
DECL|function|deadline_latter_request
id|deadline_latter_request
c_func
(paren
id|request_queue_t
op_star
id|q
comma
r_struct
id|request
op_star
id|rq
)paren
(brace
r_struct
id|deadline_rq
op_star
id|drq
op_assign
id|RQ_DATA
c_func
(paren
id|rq
)paren
suffix:semicolon
r_struct
id|rb_node
op_star
id|rbnext
op_assign
id|rb_next
c_func
(paren
op_amp
id|drq-&gt;rb_node
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rbnext
)paren
r_return
id|rb_entry_drq
c_func
(paren
id|rbnext
)paren
op_member_access_from_pointer
id|request
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|deadline_exit_queue
r_static
r_void
id|deadline_exit_queue
c_func
(paren
id|elevator_t
op_star
id|e
)paren
(brace
r_struct
id|deadline_data
op_star
id|dd
op_assign
id|e-&gt;elevator_data
suffix:semicolon
id|BUG_ON
c_func
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|dd-&gt;fifo_list
(braket
id|READ
)braket
)paren
)paren
suffix:semicolon
id|BUG_ON
c_func
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|dd-&gt;fifo_list
(braket
id|WRITE
)braket
)paren
)paren
suffix:semicolon
id|mempool_destroy
c_func
(paren
id|dd-&gt;drq_pool
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dd-&gt;hash
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dd
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * initialize elevator private data (deadline_data), and alloc a drq for&n; * each request on the free lists&n; */
DECL|function|deadline_init_queue
r_static
r_int
id|deadline_init_queue
c_func
(paren
id|request_queue_t
op_star
id|q
comma
id|elevator_t
op_star
id|e
)paren
(brace
r_struct
id|deadline_data
op_star
id|dd
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|drq_pool
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|dd
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|dd
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dd
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|dd
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|dd
)paren
)paren
suffix:semicolon
id|dd-&gt;hash
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|list_head
)paren
op_star
id|DL_HASH_ENTRIES
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dd-&gt;hash
)paren
(brace
id|kfree
c_func
(paren
id|dd
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|dd-&gt;drq_pool
op_assign
id|mempool_create
c_func
(paren
id|BLKDEV_MIN_RQ
comma
id|mempool_alloc_slab
comma
id|mempool_free_slab
comma
id|drq_pool
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dd-&gt;drq_pool
)paren
(brace
id|kfree
c_func
(paren
id|dd-&gt;hash
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dd
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|DL_HASH_ENTRIES
suffix:semicolon
id|i
op_increment
)paren
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|dd-&gt;hash
(braket
id|i
)braket
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|dd-&gt;fifo_list
(braket
id|READ
)braket
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|dd-&gt;fifo_list
(braket
id|WRITE
)braket
)paren
suffix:semicolon
id|dd-&gt;sort_list
(braket
id|READ
)braket
op_assign
id|RB_ROOT
suffix:semicolon
id|dd-&gt;sort_list
(braket
id|WRITE
)braket
op_assign
id|RB_ROOT
suffix:semicolon
id|dd-&gt;dispatch
op_assign
op_amp
id|q-&gt;queue_head
suffix:semicolon
id|dd-&gt;fifo_expire
(braket
id|READ
)braket
op_assign
id|read_expire
suffix:semicolon
id|dd-&gt;fifo_expire
(braket
id|WRITE
)braket
op_assign
id|write_expire
suffix:semicolon
id|dd-&gt;writes_starved
op_assign
id|writes_starved
suffix:semicolon
id|dd-&gt;front_merges
op_assign
l_int|1
suffix:semicolon
id|dd-&gt;fifo_batch
op_assign
id|fifo_batch
suffix:semicolon
id|e-&gt;elevator_data
op_assign
id|dd
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|deadline_put_request
r_static
r_void
id|deadline_put_request
c_func
(paren
id|request_queue_t
op_star
id|q
comma
r_struct
id|request
op_star
id|rq
)paren
(brace
r_struct
id|deadline_data
op_star
id|dd
op_assign
id|q-&gt;elevator-&gt;elevator_data
suffix:semicolon
r_struct
id|deadline_rq
op_star
id|drq
op_assign
id|RQ_DATA
c_func
(paren
id|rq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|drq
)paren
(brace
id|mempool_free
c_func
(paren
id|drq
comma
id|dd-&gt;drq_pool
)paren
suffix:semicolon
id|rq-&gt;elevator_private
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
r_static
r_int
DECL|function|deadline_set_request
id|deadline_set_request
c_func
(paren
id|request_queue_t
op_star
id|q
comma
r_struct
id|request
op_star
id|rq
comma
r_int
id|gfp_mask
)paren
(brace
r_struct
id|deadline_data
op_star
id|dd
op_assign
id|q-&gt;elevator-&gt;elevator_data
suffix:semicolon
r_struct
id|deadline_rq
op_star
id|drq
suffix:semicolon
id|drq
op_assign
id|mempool_alloc
c_func
(paren
id|dd-&gt;drq_pool
comma
id|gfp_mask
)paren
suffix:semicolon
r_if
c_cond
(paren
id|drq
)paren
(brace
id|memset
c_func
(paren
id|drq
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|drq
)paren
)paren
suffix:semicolon
id|RB_CLEAR
c_func
(paren
op_amp
id|drq-&gt;rb_node
)paren
suffix:semicolon
id|drq-&gt;request
op_assign
id|rq
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|drq-&gt;hash
)paren
suffix:semicolon
id|drq-&gt;on_hash
op_assign
l_int|0
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|drq-&gt;fifo
)paren
suffix:semicolon
id|rq-&gt;elevator_private
op_assign
id|drq
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; * sysfs parts below&n; */
DECL|struct|deadline_fs_entry
r_struct
id|deadline_fs_entry
(brace
DECL|member|attr
r_struct
id|attribute
id|attr
suffix:semicolon
DECL|member|show
id|ssize_t
(paren
op_star
id|show
)paren
(paren
r_struct
id|deadline_data
op_star
comma
r_char
op_star
)paren
suffix:semicolon
DECL|member|store
id|ssize_t
(paren
op_star
id|store
)paren
(paren
r_struct
id|deadline_data
op_star
comma
r_const
r_char
op_star
comma
r_int
)paren
suffix:semicolon
)brace
suffix:semicolon
r_static
id|ssize_t
DECL|function|deadline_var_show
id|deadline_var_show
c_func
(paren
r_int
id|var
comma
r_char
op_star
id|page
)paren
(brace
r_return
id|sprintf
c_func
(paren
id|page
comma
l_string|&quot;%d&bslash;n&quot;
comma
id|var
)paren
suffix:semicolon
)brace
r_static
id|ssize_t
DECL|function|deadline_var_store
id|deadline_var_store
c_func
(paren
r_int
op_star
id|var
comma
r_const
r_char
op_star
id|page
comma
r_int
id|count
)paren
(brace
r_char
op_star
id|p
op_assign
(paren
r_char
op_star
)paren
id|page
suffix:semicolon
op_star
id|var
op_assign
id|simple_strtol
c_func
(paren
id|p
comma
op_amp
id|p
comma
l_int|10
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
DECL|macro|SHOW_FUNCTION
mdefine_line|#define SHOW_FUNCTION(__FUNC, __VAR, __CONV)&t;&t;&t;&t;&bslash;&n;static ssize_t __FUNC(struct deadline_data *dd, char *page)&t;&t;&bslash;&n;{&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;int __data = __VAR;&t;&t;&t;&t;&t;&bslash;&n;&t;if (__CONV)&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;&t;__data = jiffies_to_msecs(__data);&t;&t;&t;&bslash;&n;&t;return deadline_var_show(__data, (page));&t;&t;&t;&bslash;&n;}
id|SHOW_FUNCTION
c_func
(paren
id|deadline_readexpire_show
comma
id|dd-&gt;fifo_expire
(braket
id|READ
)braket
comma
l_int|1
)paren
suffix:semicolon
id|SHOW_FUNCTION
c_func
(paren
id|deadline_writeexpire_show
comma
id|dd-&gt;fifo_expire
(braket
id|WRITE
)braket
comma
l_int|1
)paren
suffix:semicolon
id|SHOW_FUNCTION
c_func
(paren
id|deadline_writesstarved_show
comma
id|dd-&gt;writes_starved
comma
l_int|0
)paren
suffix:semicolon
id|SHOW_FUNCTION
c_func
(paren
id|deadline_frontmerges_show
comma
id|dd-&gt;front_merges
comma
l_int|0
)paren
suffix:semicolon
id|SHOW_FUNCTION
c_func
(paren
id|deadline_fifobatch_show
comma
id|dd-&gt;fifo_batch
comma
l_int|0
)paren
suffix:semicolon
DECL|macro|SHOW_FUNCTION
macro_line|#undef SHOW_FUNCTION
DECL|macro|STORE_FUNCTION
mdefine_line|#define STORE_FUNCTION(__FUNC, __PTR, MIN, MAX, __CONV)&t;&t;&t;&bslash;&n;static ssize_t __FUNC(struct deadline_data *dd, const char *page, size_t count)&t;&bslash;&n;{&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;int __data;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;int ret = deadline_var_store(&amp;__data, (page), count);&t;&t;&bslash;&n;&t;if (__data &lt; (MIN))&t;&t;&t;&t;&t;&t;&bslash;&n;&t;&t;__data = (MIN);&t;&t;&t;&t;&t;&t;&bslash;&n;&t;else if (__data &gt; (MAX))&t;&t;&t;&t;&t;&bslash;&n;&t;&t;__data = (MAX);&t;&t;&t;&t;&t;&t;&bslash;&n;&t;if (__CONV)&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;&t;*(__PTR) = msecs_to_jiffies(__data);&t;&t;&t;&bslash;&n;&t;else&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;&t;*(__PTR) = __data;&t;&t;&t;&t;&t;&bslash;&n;&t;return ret;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;}
id|STORE_FUNCTION
c_func
(paren
id|deadline_readexpire_store
comma
op_amp
id|dd-&gt;fifo_expire
(braket
id|READ
)braket
comma
l_int|0
comma
id|INT_MAX
comma
l_int|1
)paren
suffix:semicolon
id|STORE_FUNCTION
c_func
(paren
id|deadline_writeexpire_store
comma
op_amp
id|dd-&gt;fifo_expire
(braket
id|WRITE
)braket
comma
l_int|0
comma
id|INT_MAX
comma
l_int|1
)paren
suffix:semicolon
id|STORE_FUNCTION
c_func
(paren
id|deadline_writesstarved_store
comma
op_amp
id|dd-&gt;writes_starved
comma
id|INT_MIN
comma
id|INT_MAX
comma
l_int|0
)paren
suffix:semicolon
id|STORE_FUNCTION
c_func
(paren
id|deadline_frontmerges_store
comma
op_amp
id|dd-&gt;front_merges
comma
l_int|0
comma
l_int|1
comma
l_int|0
)paren
suffix:semicolon
id|STORE_FUNCTION
c_func
(paren
id|deadline_fifobatch_store
comma
op_amp
id|dd-&gt;fifo_batch
comma
l_int|0
comma
id|INT_MAX
comma
l_int|0
)paren
suffix:semicolon
DECL|macro|STORE_FUNCTION
macro_line|#undef STORE_FUNCTION
DECL|variable|deadline_readexpire_entry
r_static
r_struct
id|deadline_fs_entry
id|deadline_readexpire_entry
op_assign
(brace
dot
id|attr
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;read_expire&quot;
comma
dot
id|mode
op_assign
id|S_IRUGO
op_or
id|S_IWUSR
)brace
comma
dot
id|show
op_assign
id|deadline_readexpire_show
comma
dot
id|store
op_assign
id|deadline_readexpire_store
comma
)brace
suffix:semicolon
DECL|variable|deadline_writeexpire_entry
r_static
r_struct
id|deadline_fs_entry
id|deadline_writeexpire_entry
op_assign
(brace
dot
id|attr
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;write_expire&quot;
comma
dot
id|mode
op_assign
id|S_IRUGO
op_or
id|S_IWUSR
)brace
comma
dot
id|show
op_assign
id|deadline_writeexpire_show
comma
dot
id|store
op_assign
id|deadline_writeexpire_store
comma
)brace
suffix:semicolon
DECL|variable|deadline_writesstarved_entry
r_static
r_struct
id|deadline_fs_entry
id|deadline_writesstarved_entry
op_assign
(brace
dot
id|attr
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;writes_starved&quot;
comma
dot
id|mode
op_assign
id|S_IRUGO
op_or
id|S_IWUSR
)brace
comma
dot
id|show
op_assign
id|deadline_writesstarved_show
comma
dot
id|store
op_assign
id|deadline_writesstarved_store
comma
)brace
suffix:semicolon
DECL|variable|deadline_frontmerges_entry
r_static
r_struct
id|deadline_fs_entry
id|deadline_frontmerges_entry
op_assign
(brace
dot
id|attr
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;front_merges&quot;
comma
dot
id|mode
op_assign
id|S_IRUGO
op_or
id|S_IWUSR
)brace
comma
dot
id|show
op_assign
id|deadline_frontmerges_show
comma
dot
id|store
op_assign
id|deadline_frontmerges_store
comma
)brace
suffix:semicolon
DECL|variable|deadline_fifobatch_entry
r_static
r_struct
id|deadline_fs_entry
id|deadline_fifobatch_entry
op_assign
(brace
dot
id|attr
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;fifo_batch&quot;
comma
dot
id|mode
op_assign
id|S_IRUGO
op_or
id|S_IWUSR
)brace
comma
dot
id|show
op_assign
id|deadline_fifobatch_show
comma
dot
id|store
op_assign
id|deadline_fifobatch_store
comma
)brace
suffix:semicolon
DECL|variable|default_attrs
r_static
r_struct
id|attribute
op_star
id|default_attrs
(braket
)braket
op_assign
(brace
op_amp
id|deadline_readexpire_entry.attr
comma
op_amp
id|deadline_writeexpire_entry.attr
comma
op_amp
id|deadline_writesstarved_entry.attr
comma
op_amp
id|deadline_frontmerges_entry.attr
comma
op_amp
id|deadline_fifobatch_entry.attr
comma
l_int|NULL
comma
)brace
suffix:semicolon
DECL|macro|to_deadline
mdefine_line|#define to_deadline(atr) container_of((atr), struct deadline_fs_entry, attr)
r_static
id|ssize_t
DECL|function|deadline_attr_show
id|deadline_attr_show
c_func
(paren
r_struct
id|kobject
op_star
id|kobj
comma
r_struct
id|attribute
op_star
id|attr
comma
r_char
op_star
id|page
)paren
(brace
id|elevator_t
op_star
id|e
op_assign
id|container_of
c_func
(paren
id|kobj
comma
id|elevator_t
comma
id|kobj
)paren
suffix:semicolon
r_struct
id|deadline_fs_entry
op_star
id|entry
op_assign
id|to_deadline
c_func
(paren
id|attr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|entry-&gt;show
)paren
r_return
l_int|0
suffix:semicolon
r_return
id|entry
op_member_access_from_pointer
id|show
c_func
(paren
id|e-&gt;elevator_data
comma
id|page
)paren
suffix:semicolon
)brace
r_static
id|ssize_t
DECL|function|deadline_attr_store
id|deadline_attr_store
c_func
(paren
r_struct
id|kobject
op_star
id|kobj
comma
r_struct
id|attribute
op_star
id|attr
comma
r_const
r_char
op_star
id|page
comma
r_int
id|length
)paren
(brace
id|elevator_t
op_star
id|e
op_assign
id|container_of
c_func
(paren
id|kobj
comma
id|elevator_t
comma
id|kobj
)paren
suffix:semicolon
r_struct
id|deadline_fs_entry
op_star
id|entry
op_assign
id|to_deadline
c_func
(paren
id|attr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|entry-&gt;store
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_return
id|entry
op_member_access_from_pointer
id|store
c_func
(paren
id|e-&gt;elevator_data
comma
id|page
comma
id|length
)paren
suffix:semicolon
)brace
DECL|variable|deadline_sysfs_ops
r_static
r_struct
id|sysfs_ops
id|deadline_sysfs_ops
op_assign
(brace
dot
id|show
op_assign
id|deadline_attr_show
comma
dot
id|store
op_assign
id|deadline_attr_store
comma
)brace
suffix:semicolon
DECL|variable|deadline_ktype
r_struct
id|kobj_type
id|deadline_ktype
op_assign
(brace
dot
id|sysfs_ops
op_assign
op_amp
id|deadline_sysfs_ops
comma
dot
id|default_attrs
op_assign
id|default_attrs
comma
)brace
suffix:semicolon
DECL|variable|iosched_deadline
r_static
r_struct
id|elevator_type
id|iosched_deadline
op_assign
(brace
dot
id|ops
op_assign
(brace
dot
id|elevator_merge_fn
op_assign
id|deadline_merge
comma
dot
id|elevator_merged_fn
op_assign
id|deadline_merged_request
comma
dot
id|elevator_merge_req_fn
op_assign
id|deadline_merged_requests
comma
dot
id|elevator_next_req_fn
op_assign
id|deadline_next_request
comma
dot
id|elevator_add_req_fn
op_assign
id|deadline_insert_request
comma
dot
id|elevator_remove_req_fn
op_assign
id|deadline_remove_request
comma
dot
id|elevator_queue_empty_fn
op_assign
id|deadline_queue_empty
comma
dot
id|elevator_former_req_fn
op_assign
id|deadline_former_request
comma
dot
id|elevator_latter_req_fn
op_assign
id|deadline_latter_request
comma
dot
id|elevator_set_req_fn
op_assign
id|deadline_set_request
comma
dot
id|elevator_put_req_fn
op_assign
id|deadline_put_request
comma
dot
id|elevator_init_fn
op_assign
id|deadline_init_queue
comma
dot
id|elevator_exit_fn
op_assign
id|deadline_exit_queue
comma
)brace
comma
dot
id|elevator_ktype
op_assign
op_amp
id|deadline_ktype
comma
dot
id|elevator_name
op_assign
l_string|&quot;deadline&quot;
comma
dot
id|elevator_owner
op_assign
id|THIS_MODULE
comma
)brace
suffix:semicolon
DECL|function|deadline_init
r_static
r_int
id|__init
id|deadline_init
c_func
(paren
r_void
)paren
(brace
r_int
id|ret
suffix:semicolon
id|drq_pool
op_assign
id|kmem_cache_create
c_func
(paren
l_string|&quot;deadline_drq&quot;
comma
r_sizeof
(paren
r_struct
id|deadline_rq
)paren
comma
l_int|0
comma
l_int|0
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|drq_pool
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|ret
op_assign
id|elv_register
c_func
(paren
op_amp
id|iosched_deadline
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
id|kmem_cache_destroy
c_func
(paren
id|drq_pool
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|deadline_exit
r_static
r_void
id|__exit
id|deadline_exit
c_func
(paren
r_void
)paren
(brace
id|kmem_cache_destroy
c_func
(paren
id|drq_pool
)paren
suffix:semicolon
id|elv_unregister
c_func
(paren
op_amp
id|iosched_deadline
)paren
suffix:semicolon
)brace
DECL|variable|deadline_init
id|module_init
c_func
(paren
id|deadline_init
)paren
suffix:semicolon
DECL|variable|deadline_exit
id|module_exit
c_func
(paren
id|deadline_exit
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Jens Axboe&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;deadline IO scheduler&quot;
)paren
suffix:semicolon
eof
