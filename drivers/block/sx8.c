multiline_comment|/*&n; *  sx8.c: Driver for Promise SATA SX8 looks-like-I2O hardware&n; *&n; *  Copyright 2004 Red Hat, Inc.&n; *&n; *  Author/maintainer:  Jeff Garzik &lt;jgarzik@pobox.com&gt;&n; *&n; *  This file is subject to the terms and conditions of the GNU General Public&n; *  License.  See the file &quot;COPYING&quot; in the main directory of this archive&n; *  for more details.&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/blkdev.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/devfs_fs_kernel.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/compiler.h&gt;
macro_line|#include &lt;linux/workqueue.h&gt;
macro_line|#include &lt;linux/bitops.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/time.h&gt;
macro_line|#include &lt;linux/hdreg.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/semaphore.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Jeff Garzik&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Promise SATA SX8 block driver&quot;
)paren
suffix:semicolon
macro_line|#if 0
mdefine_line|#define CARM_DEBUG
mdefine_line|#define CARM_VERBOSE_DEBUG
macro_line|#else
DECL|macro|CARM_DEBUG
macro_line|#undef CARM_DEBUG
DECL|macro|CARM_VERBOSE_DEBUG
macro_line|#undef CARM_VERBOSE_DEBUG
macro_line|#endif
DECL|macro|CARM_NDEBUG
macro_line|#undef CARM_NDEBUG
DECL|macro|DRV_NAME
mdefine_line|#define DRV_NAME &quot;sx8&quot;
DECL|macro|DRV_VERSION
mdefine_line|#define DRV_VERSION &quot;0.8&quot;
DECL|macro|PFX
mdefine_line|#define PFX DRV_NAME &quot;: &quot;
DECL|macro|NEXT_RESP
mdefine_line|#define NEXT_RESP(idx)&t;((idx + 1) % RMSG_Q_LEN)
multiline_comment|/* 0xf is just arbitrary, non-zero noise; this is sorta like poisoning */
DECL|macro|TAG_ENCODE
mdefine_line|#define TAG_ENCODE(tag)&t;(((tag) &lt;&lt; 16) | 0xf)
DECL|macro|TAG_DECODE
mdefine_line|#define TAG_DECODE(tag)&t;(((tag) &gt;&gt; 16) &amp; 0x1f)
DECL|macro|TAG_VALID
mdefine_line|#define TAG_VALID(tag)&t;((((tag) &amp; 0xf) == 0xf) &amp;&amp; (TAG_DECODE(tag) &lt; 32))
multiline_comment|/* note: prints function name for you */
macro_line|#ifdef CARM_DEBUG
DECL|macro|DPRINTK
mdefine_line|#define DPRINTK(fmt, args...) printk(KERN_ERR &quot;%s: &quot; fmt, __FUNCTION__, ## args)
macro_line|#ifdef CARM_VERBOSE_DEBUG
DECL|macro|VPRINTK
mdefine_line|#define VPRINTK(fmt, args...) printk(KERN_ERR &quot;%s: &quot; fmt, __FUNCTION__, ## args)
macro_line|#else
DECL|macro|VPRINTK
mdefine_line|#define VPRINTK(fmt, args...)
macro_line|#endif&t;/* CARM_VERBOSE_DEBUG */
macro_line|#else
DECL|macro|DPRINTK
mdefine_line|#define DPRINTK(fmt, args...)
DECL|macro|VPRINTK
mdefine_line|#define VPRINTK(fmt, args...)
macro_line|#endif&t;/* CARM_DEBUG */
macro_line|#ifdef CARM_NDEBUG
DECL|macro|assert
mdefine_line|#define assert(expr)
macro_line|#else
DECL|macro|assert
mdefine_line|#define assert(expr) &bslash;&n;        if(unlikely(!(expr))) {                                   &bslash;&n;        printk(KERN_ERR &quot;Assertion failed! %s,%s,%s,line=%d&bslash;n&quot;, &bslash;&n;        #expr,__FILE__,__FUNCTION__,__LINE__);          &bslash;&n;        }
macro_line|#endif
multiline_comment|/* defines only for the constants which don&squot;t work well as enums */
r_struct
id|carm_host
suffix:semicolon
r_enum
(brace
multiline_comment|/* adapter-wide limits */
DECL|enumerator|CARM_MAX_PORTS
id|CARM_MAX_PORTS
op_assign
l_int|8
comma
DECL|enumerator|CARM_SHM_SIZE
id|CARM_SHM_SIZE
op_assign
(paren
l_int|4096
op_lshift
l_int|7
)paren
comma
DECL|enumerator|CARM_MINORS_PER_MAJOR
id|CARM_MINORS_PER_MAJOR
op_assign
l_int|256
op_div
id|CARM_MAX_PORTS
comma
DECL|enumerator|CARM_MAX_WAIT_Q
id|CARM_MAX_WAIT_Q
op_assign
id|CARM_MAX_PORTS
op_plus
l_int|1
comma
multiline_comment|/* command message queue limits */
DECL|enumerator|CARM_MAX_REQ
id|CARM_MAX_REQ
op_assign
l_int|64
comma
multiline_comment|/* max command msgs per host */
DECL|enumerator|CARM_MAX_Q
id|CARM_MAX_Q
op_assign
l_int|1
comma
multiline_comment|/* one command at a time */
DECL|enumerator|CARM_MSG_LOW_WATER
id|CARM_MSG_LOW_WATER
op_assign
(paren
id|CARM_MAX_REQ
op_div
l_int|4
)paren
comma
multiline_comment|/* refill mark */
multiline_comment|/* S/G limits, host-wide and per-request */
DECL|enumerator|CARM_MAX_REQ_SG
id|CARM_MAX_REQ_SG
op_assign
l_int|32
comma
multiline_comment|/* max s/g entries per request */
DECL|enumerator|CARM_SG_BOUNDARY
id|CARM_SG_BOUNDARY
op_assign
l_int|0xffffUL
comma
multiline_comment|/* s/g segment boundary */
DECL|enumerator|CARM_MAX_HOST_SG
id|CARM_MAX_HOST_SG
op_assign
l_int|600
comma
multiline_comment|/* max s/g entries per host */
DECL|enumerator|CARM_SG_LOW_WATER
id|CARM_SG_LOW_WATER
op_assign
(paren
id|CARM_MAX_HOST_SG
op_div
l_int|4
)paren
comma
multiline_comment|/* re-fill mark */
multiline_comment|/* hardware registers */
DECL|enumerator|CARM_IHQP
id|CARM_IHQP
op_assign
l_int|0x1c
comma
DECL|enumerator|CARM_INT_STAT
id|CARM_INT_STAT
op_assign
l_int|0x10
comma
multiline_comment|/* interrupt status */
DECL|enumerator|CARM_INT_MASK
id|CARM_INT_MASK
op_assign
l_int|0x14
comma
multiline_comment|/* interrupt mask */
DECL|enumerator|CARM_HMUC
id|CARM_HMUC
op_assign
l_int|0x18
comma
multiline_comment|/* host message unit control */
DECL|enumerator|RBUF_ADDR_LO
id|RBUF_ADDR_LO
op_assign
l_int|0x20
comma
multiline_comment|/* response msg DMA buf low 32 bits */
DECL|enumerator|RBUF_ADDR_HI
id|RBUF_ADDR_HI
op_assign
l_int|0x24
comma
multiline_comment|/* response msg DMA buf high 32 bits */
DECL|enumerator|RBUF_BYTE_SZ
id|RBUF_BYTE_SZ
op_assign
l_int|0x28
comma
DECL|enumerator|CARM_RESP_IDX
id|CARM_RESP_IDX
op_assign
l_int|0x2c
comma
DECL|enumerator|CARM_CMS0
id|CARM_CMS0
op_assign
l_int|0x30
comma
multiline_comment|/* command message size reg 0 */
DECL|enumerator|CARM_LMUC
id|CARM_LMUC
op_assign
l_int|0x48
comma
DECL|enumerator|CARM_HMPHA
id|CARM_HMPHA
op_assign
l_int|0x6c
comma
DECL|enumerator|CARM_INITC
id|CARM_INITC
op_assign
l_int|0xb5
comma
multiline_comment|/* bits in CARM_INT_{STAT,MASK} */
DECL|enumerator|INT_RESERVED
id|INT_RESERVED
op_assign
l_int|0xfffffff0
comma
DECL|enumerator|INT_WATCHDOG
id|INT_WATCHDOG
op_assign
(paren
l_int|1
op_lshift
l_int|3
)paren
comma
multiline_comment|/* watchdog timer */
DECL|enumerator|INT_Q_OVERFLOW
id|INT_Q_OVERFLOW
op_assign
(paren
l_int|1
op_lshift
l_int|2
)paren
comma
multiline_comment|/* cmd msg q overflow */
DECL|enumerator|INT_Q_AVAILABLE
id|INT_Q_AVAILABLE
op_assign
(paren
l_int|1
op_lshift
l_int|1
)paren
comma
multiline_comment|/* cmd msg q has free space */
DECL|enumerator|INT_RESPONSE
id|INT_RESPONSE
op_assign
(paren
l_int|1
op_lshift
l_int|0
)paren
comma
multiline_comment|/* response msg available */
DECL|enumerator|INT_ACK_MASK
id|INT_ACK_MASK
op_assign
id|INT_WATCHDOG
op_or
id|INT_Q_OVERFLOW
comma
DECL|enumerator|INT_DEF_MASK
id|INT_DEF_MASK
op_assign
id|INT_RESERVED
op_or
id|INT_Q_OVERFLOW
op_or
id|INT_RESPONSE
comma
multiline_comment|/* command messages, and related register bits */
DECL|enumerator|CARM_HAVE_RESP
id|CARM_HAVE_RESP
op_assign
l_int|0x01
comma
DECL|enumerator|CARM_MSG_READ
id|CARM_MSG_READ
op_assign
l_int|1
comma
DECL|enumerator|CARM_MSG_WRITE
id|CARM_MSG_WRITE
op_assign
l_int|2
comma
DECL|enumerator|CARM_MSG_VERIFY
id|CARM_MSG_VERIFY
op_assign
l_int|3
comma
DECL|enumerator|CARM_MSG_GET_CAPACITY
id|CARM_MSG_GET_CAPACITY
op_assign
l_int|4
comma
DECL|enumerator|CARM_MSG_FLUSH
id|CARM_MSG_FLUSH
op_assign
l_int|5
comma
DECL|enumerator|CARM_MSG_IOCTL
id|CARM_MSG_IOCTL
op_assign
l_int|6
comma
DECL|enumerator|CARM_MSG_ARRAY
id|CARM_MSG_ARRAY
op_assign
l_int|8
comma
DECL|enumerator|CARM_MSG_MISC
id|CARM_MSG_MISC
op_assign
l_int|9
comma
DECL|enumerator|CARM_CME
id|CARM_CME
op_assign
(paren
l_int|1
op_lshift
l_int|2
)paren
comma
DECL|enumerator|CARM_RME
id|CARM_RME
op_assign
(paren
l_int|1
op_lshift
l_int|1
)paren
comma
DECL|enumerator|CARM_WZBC
id|CARM_WZBC
op_assign
(paren
l_int|1
op_lshift
l_int|0
)paren
comma
DECL|enumerator|CARM_RMI
id|CARM_RMI
op_assign
(paren
l_int|1
op_lshift
l_int|0
)paren
comma
DECL|enumerator|CARM_Q_FULL
id|CARM_Q_FULL
op_assign
(paren
l_int|1
op_lshift
l_int|3
)paren
comma
DECL|enumerator|CARM_MSG_SIZE
id|CARM_MSG_SIZE
op_assign
l_int|288
comma
DECL|enumerator|CARM_Q_LEN
id|CARM_Q_LEN
op_assign
l_int|48
comma
multiline_comment|/* CARM_MSG_IOCTL messages */
DECL|enumerator|CARM_IOC_SCAN_CHAN
id|CARM_IOC_SCAN_CHAN
op_assign
l_int|5
comma
multiline_comment|/* scan channels for devices */
DECL|enumerator|CARM_IOC_GET_TCQ
id|CARM_IOC_GET_TCQ
op_assign
l_int|13
comma
multiline_comment|/* get tcq/ncq depth */
DECL|enumerator|CARM_IOC_SET_TCQ
id|CARM_IOC_SET_TCQ
op_assign
l_int|14
comma
multiline_comment|/* set tcq/ncq depth */
DECL|enumerator|IOC_SCAN_CHAN_NODEV
id|IOC_SCAN_CHAN_NODEV
op_assign
l_int|0x1f
comma
DECL|enumerator|IOC_SCAN_CHAN_OFFSET
id|IOC_SCAN_CHAN_OFFSET
op_assign
l_int|0x40
comma
multiline_comment|/* CARM_MSG_ARRAY messages */
DECL|enumerator|CARM_ARRAY_INFO
id|CARM_ARRAY_INFO
op_assign
l_int|0
comma
DECL|enumerator|ARRAY_NO_EXIST
id|ARRAY_NO_EXIST
op_assign
(paren
l_int|1
op_lshift
l_int|31
)paren
comma
multiline_comment|/* response messages */
DECL|enumerator|RMSG_SZ
id|RMSG_SZ
op_assign
l_int|8
comma
multiline_comment|/* sizeof(struct carm_response) */
DECL|enumerator|RMSG_Q_LEN
id|RMSG_Q_LEN
op_assign
l_int|48
comma
multiline_comment|/* resp. msg list length */
DECL|enumerator|RMSG_OK
id|RMSG_OK
op_assign
l_int|1
comma
multiline_comment|/* bit indicating msg was successful */
multiline_comment|/* length of entire resp. msg buffer */
DECL|enumerator|RBUF_LEN
id|RBUF_LEN
op_assign
id|RMSG_SZ
op_star
id|RMSG_Q_LEN
comma
DECL|enumerator|PDC_SHM_SIZE
id|PDC_SHM_SIZE
op_assign
(paren
l_int|4096
op_lshift
l_int|7
)paren
comma
multiline_comment|/* length of entire h/w buffer */
multiline_comment|/* CARM_MSG_MISC messages */
DECL|enumerator|MISC_GET_FW_VER
id|MISC_GET_FW_VER
op_assign
l_int|2
comma
DECL|enumerator|MISC_ALLOC_MEM
id|MISC_ALLOC_MEM
op_assign
l_int|3
comma
DECL|enumerator|MISC_SET_TIME
id|MISC_SET_TIME
op_assign
l_int|5
comma
multiline_comment|/* MISC_GET_FW_VER feature bits */
DECL|enumerator|FW_VER_4PORT
id|FW_VER_4PORT
op_assign
(paren
l_int|1
op_lshift
l_int|2
)paren
comma
multiline_comment|/* 1=4 ports, 0=8 ports */
DECL|enumerator|FW_VER_NON_RAID
id|FW_VER_NON_RAID
op_assign
(paren
l_int|1
op_lshift
l_int|1
)paren
comma
multiline_comment|/* 1=non-RAID firmware, 0=RAID */
DECL|enumerator|FW_VER_ZCR
id|FW_VER_ZCR
op_assign
(paren
l_int|1
op_lshift
l_int|0
)paren
comma
multiline_comment|/* zero channel RAID (whatever that is) */
multiline_comment|/* carm_host flags */
DECL|enumerator|FL_NON_RAID
id|FL_NON_RAID
op_assign
id|FW_VER_NON_RAID
comma
DECL|enumerator|FL_4PORT
id|FL_4PORT
op_assign
id|FW_VER_4PORT
comma
DECL|enumerator|FL_FW_VER_MASK
id|FL_FW_VER_MASK
op_assign
(paren
id|FW_VER_NON_RAID
op_or
id|FW_VER_4PORT
)paren
comma
DECL|enumerator|FL_DAC
id|FL_DAC
op_assign
(paren
l_int|1
op_lshift
l_int|16
)paren
comma
DECL|enumerator|FL_DYN_MAJOR
id|FL_DYN_MAJOR
op_assign
(paren
l_int|1
op_lshift
l_int|17
)paren
comma
)brace
suffix:semicolon
DECL|enum|scatter_gather_types
r_enum
id|scatter_gather_types
(brace
DECL|enumerator|SGT_32BIT
id|SGT_32BIT
op_assign
l_int|0
comma
DECL|enumerator|SGT_64BIT
id|SGT_64BIT
op_assign
l_int|1
comma
)brace
suffix:semicolon
DECL|enum|host_states
r_enum
id|host_states
(brace
DECL|enumerator|HST_INVALID
id|HST_INVALID
comma
multiline_comment|/* invalid state; never used */
DECL|enumerator|HST_ALLOC_BUF
id|HST_ALLOC_BUF
comma
multiline_comment|/* setting up master SHM area */
DECL|enumerator|HST_ERROR
id|HST_ERROR
comma
multiline_comment|/* we never leave here */
DECL|enumerator|HST_PORT_SCAN
id|HST_PORT_SCAN
comma
multiline_comment|/* start dev scan */
DECL|enumerator|HST_DEV_SCAN_START
id|HST_DEV_SCAN_START
comma
multiline_comment|/* start per-device probe */
DECL|enumerator|HST_DEV_SCAN
id|HST_DEV_SCAN
comma
multiline_comment|/* continue per-device probe */
DECL|enumerator|HST_DEV_ACTIVATE
id|HST_DEV_ACTIVATE
comma
multiline_comment|/* activate devices we found */
DECL|enumerator|HST_PROBE_FINISHED
id|HST_PROBE_FINISHED
comma
multiline_comment|/* probe is complete */
DECL|enumerator|HST_PROBE_START
id|HST_PROBE_START
comma
multiline_comment|/* initiate probe */
DECL|enumerator|HST_SYNC_TIME
id|HST_SYNC_TIME
comma
multiline_comment|/* tell firmware what time it is */
DECL|enumerator|HST_GET_FW_VER
id|HST_GET_FW_VER
comma
multiline_comment|/* get firmware version, adapter port cnt */
)brace
suffix:semicolon
macro_line|#ifdef CARM_DEBUG
DECL|variable|state_name
r_static
r_const
r_char
op_star
id|state_name
(braket
)braket
op_assign
(brace
l_string|&quot;HST_INVALID&quot;
comma
l_string|&quot;HST_ALLOC_BUF&quot;
comma
l_string|&quot;HST_ERROR&quot;
comma
l_string|&quot;HST_PORT_SCAN&quot;
comma
l_string|&quot;HST_DEV_SCAN_START&quot;
comma
l_string|&quot;HST_DEV_SCAN&quot;
comma
l_string|&quot;HST_DEV_ACTIVATE&quot;
comma
l_string|&quot;HST_PROBE_FINISHED&quot;
comma
l_string|&quot;HST_PROBE_START&quot;
comma
l_string|&quot;HST_SYNC_TIME&quot;
comma
l_string|&quot;HST_GET_FW_VER&quot;
comma
)brace
suffix:semicolon
macro_line|#endif
DECL|struct|carm_port
r_struct
id|carm_port
(brace
DECL|member|port_no
r_int
r_int
id|port_no
suffix:semicolon
DECL|member|n_queued
r_int
r_int
id|n_queued
suffix:semicolon
DECL|member|disk
r_struct
id|gendisk
op_star
id|disk
suffix:semicolon
DECL|member|host
r_struct
id|carm_host
op_star
id|host
suffix:semicolon
multiline_comment|/* attached device characteristics */
DECL|member|capacity
id|u64
id|capacity
suffix:semicolon
DECL|member|name
r_char
id|name
(braket
l_int|41
)braket
suffix:semicolon
DECL|member|dev_geom_head
id|u16
id|dev_geom_head
suffix:semicolon
DECL|member|dev_geom_sect
id|u16
id|dev_geom_sect
suffix:semicolon
DECL|member|dev_geom_cyl
id|u16
id|dev_geom_cyl
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|carm_request
r_struct
id|carm_request
(brace
DECL|member|tag
r_int
r_int
id|tag
suffix:semicolon
DECL|member|n_elem
r_int
id|n_elem
suffix:semicolon
DECL|member|msg_type
r_int
r_int
id|msg_type
suffix:semicolon
DECL|member|msg_subtype
r_int
r_int
id|msg_subtype
suffix:semicolon
DECL|member|msg_bucket
r_int
r_int
id|msg_bucket
suffix:semicolon
DECL|member|rq
r_struct
id|request
op_star
id|rq
suffix:semicolon
DECL|member|port
r_struct
id|carm_port
op_star
id|port
suffix:semicolon
DECL|member|sg
r_struct
id|scatterlist
id|sg
(braket
id|CARM_MAX_REQ_SG
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|carm_host
r_struct
id|carm_host
(brace
DECL|member|flags
r_int
r_int
id|flags
suffix:semicolon
DECL|member|mmio
r_void
id|__iomem
op_star
id|mmio
suffix:semicolon
DECL|member|shm
r_void
op_star
id|shm
suffix:semicolon
DECL|member|shm_dma
id|dma_addr_t
id|shm_dma
suffix:semicolon
DECL|member|major
r_int
id|major
suffix:semicolon
DECL|member|id
r_int
id|id
suffix:semicolon
DECL|member|name
r_char
id|name
(braket
l_int|32
)braket
suffix:semicolon
DECL|member|lock
id|spinlock_t
id|lock
suffix:semicolon
DECL|member|pdev
r_struct
id|pci_dev
op_star
id|pdev
suffix:semicolon
DECL|member|state
r_int
r_int
id|state
suffix:semicolon
DECL|member|fw_ver
id|u32
id|fw_ver
suffix:semicolon
DECL|member|oob_q
id|request_queue_t
op_star
id|oob_q
suffix:semicolon
DECL|member|n_oob
r_int
r_int
id|n_oob
suffix:semicolon
DECL|member|hw_sg_used
r_int
r_int
id|hw_sg_used
suffix:semicolon
DECL|member|resp_idx
r_int
r_int
id|resp_idx
suffix:semicolon
DECL|member|wait_q_prod
r_int
r_int
id|wait_q_prod
suffix:semicolon
DECL|member|wait_q_cons
r_int
r_int
id|wait_q_cons
suffix:semicolon
DECL|member|wait_q
id|request_queue_t
op_star
id|wait_q
(braket
id|CARM_MAX_WAIT_Q
)braket
suffix:semicolon
DECL|member|n_msgs
r_int
r_int
id|n_msgs
suffix:semicolon
DECL|member|msg_alloc
id|u64
id|msg_alloc
suffix:semicolon
DECL|member|req
r_struct
id|carm_request
id|req
(braket
id|CARM_MAX_REQ
)braket
suffix:semicolon
DECL|member|msg_base
r_void
op_star
id|msg_base
suffix:semicolon
DECL|member|msg_dma
id|dma_addr_t
id|msg_dma
suffix:semicolon
DECL|member|cur_scan_dev
r_int
id|cur_scan_dev
suffix:semicolon
DECL|member|dev_active
r_int
r_int
id|dev_active
suffix:semicolon
DECL|member|dev_present
r_int
r_int
id|dev_present
suffix:semicolon
DECL|member|port
r_struct
id|carm_port
id|port
(braket
id|CARM_MAX_PORTS
)braket
suffix:semicolon
DECL|member|fsm_task
r_struct
id|work_struct
id|fsm_task
suffix:semicolon
DECL|member|probe_sem
r_struct
id|semaphore
id|probe_sem
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|carm_response
r_struct
id|carm_response
(brace
DECL|member|ret_handle
id|__le32
id|ret_handle
suffix:semicolon
DECL|member|status
id|__le32
id|status
suffix:semicolon
)brace
id|__attribute__
c_func
(paren
(paren
id|packed
)paren
)paren
suffix:semicolon
DECL|struct|carm_msg_sg
r_struct
id|carm_msg_sg
(brace
DECL|member|start
id|__le32
id|start
suffix:semicolon
DECL|member|len
id|__le32
id|len
suffix:semicolon
)brace
id|__attribute__
c_func
(paren
(paren
id|packed
)paren
)paren
suffix:semicolon
DECL|struct|carm_msg_rw
r_struct
id|carm_msg_rw
(brace
DECL|member|type
id|u8
id|type
suffix:semicolon
DECL|member|id
id|u8
id|id
suffix:semicolon
DECL|member|sg_count
id|u8
id|sg_count
suffix:semicolon
DECL|member|sg_type
id|u8
id|sg_type
suffix:semicolon
DECL|member|handle
id|__le32
id|handle
suffix:semicolon
DECL|member|lba
id|__le32
id|lba
suffix:semicolon
DECL|member|lba_count
id|__le16
id|lba_count
suffix:semicolon
DECL|member|lba_high
id|__le16
id|lba_high
suffix:semicolon
DECL|member|sg
r_struct
id|carm_msg_sg
id|sg
(braket
l_int|32
)braket
suffix:semicolon
)brace
id|__attribute__
c_func
(paren
(paren
id|packed
)paren
)paren
suffix:semicolon
DECL|struct|carm_msg_allocbuf
r_struct
id|carm_msg_allocbuf
(brace
DECL|member|type
id|u8
id|type
suffix:semicolon
DECL|member|subtype
id|u8
id|subtype
suffix:semicolon
DECL|member|n_sg
id|u8
id|n_sg
suffix:semicolon
DECL|member|sg_type
id|u8
id|sg_type
suffix:semicolon
DECL|member|handle
id|__le32
id|handle
suffix:semicolon
DECL|member|addr
id|__le32
id|addr
suffix:semicolon
DECL|member|len
id|__le32
id|len
suffix:semicolon
DECL|member|evt_pool
id|__le32
id|evt_pool
suffix:semicolon
DECL|member|n_evt
id|__le32
id|n_evt
suffix:semicolon
DECL|member|rbuf_pool
id|__le32
id|rbuf_pool
suffix:semicolon
DECL|member|n_rbuf
id|__le32
id|n_rbuf
suffix:semicolon
DECL|member|msg_pool
id|__le32
id|msg_pool
suffix:semicolon
DECL|member|n_msg
id|__le32
id|n_msg
suffix:semicolon
DECL|member|sg
r_struct
id|carm_msg_sg
id|sg
(braket
l_int|8
)braket
suffix:semicolon
)brace
id|__attribute__
c_func
(paren
(paren
id|packed
)paren
)paren
suffix:semicolon
DECL|struct|carm_msg_ioctl
r_struct
id|carm_msg_ioctl
(brace
DECL|member|type
id|u8
id|type
suffix:semicolon
DECL|member|subtype
id|u8
id|subtype
suffix:semicolon
DECL|member|array_id
id|u8
id|array_id
suffix:semicolon
DECL|member|reserved1
id|u8
id|reserved1
suffix:semicolon
DECL|member|handle
id|__le32
id|handle
suffix:semicolon
DECL|member|data_addr
id|__le32
id|data_addr
suffix:semicolon
DECL|member|reserved2
id|u32
id|reserved2
suffix:semicolon
)brace
id|__attribute__
c_func
(paren
(paren
id|packed
)paren
)paren
suffix:semicolon
DECL|struct|carm_msg_sync_time
r_struct
id|carm_msg_sync_time
(brace
DECL|member|type
id|u8
id|type
suffix:semicolon
DECL|member|subtype
id|u8
id|subtype
suffix:semicolon
DECL|member|reserved1
id|u16
id|reserved1
suffix:semicolon
DECL|member|handle
id|__le32
id|handle
suffix:semicolon
DECL|member|reserved2
id|u32
id|reserved2
suffix:semicolon
DECL|member|timestamp
id|__le32
id|timestamp
suffix:semicolon
)brace
id|__attribute__
c_func
(paren
(paren
id|packed
)paren
)paren
suffix:semicolon
DECL|struct|carm_msg_get_fw_ver
r_struct
id|carm_msg_get_fw_ver
(brace
DECL|member|type
id|u8
id|type
suffix:semicolon
DECL|member|subtype
id|u8
id|subtype
suffix:semicolon
DECL|member|reserved1
id|u16
id|reserved1
suffix:semicolon
DECL|member|handle
id|__le32
id|handle
suffix:semicolon
DECL|member|data_addr
id|__le32
id|data_addr
suffix:semicolon
DECL|member|reserved2
id|u32
id|reserved2
suffix:semicolon
)brace
id|__attribute__
c_func
(paren
(paren
id|packed
)paren
)paren
suffix:semicolon
DECL|struct|carm_fw_ver
r_struct
id|carm_fw_ver
(brace
DECL|member|version
id|__le32
id|version
suffix:semicolon
DECL|member|features
id|u8
id|features
suffix:semicolon
DECL|member|reserved1
id|u8
id|reserved1
suffix:semicolon
DECL|member|reserved2
id|u16
id|reserved2
suffix:semicolon
)brace
id|__attribute__
c_func
(paren
(paren
id|packed
)paren
)paren
suffix:semicolon
DECL|struct|carm_array_info
r_struct
id|carm_array_info
(brace
DECL|member|size
id|__le32
id|size
suffix:semicolon
DECL|member|size_hi
id|__le16
id|size_hi
suffix:semicolon
DECL|member|stripe_size
id|__le16
id|stripe_size
suffix:semicolon
DECL|member|mode
id|__le32
id|mode
suffix:semicolon
DECL|member|stripe_blk_sz
id|__le16
id|stripe_blk_sz
suffix:semicolon
DECL|member|reserved1
id|__le16
id|reserved1
suffix:semicolon
DECL|member|cyl
id|__le16
id|cyl
suffix:semicolon
DECL|member|head
id|__le16
id|head
suffix:semicolon
DECL|member|sect
id|__le16
id|sect
suffix:semicolon
DECL|member|array_id
id|u8
id|array_id
suffix:semicolon
DECL|member|reserved2
id|u8
id|reserved2
suffix:semicolon
DECL|member|name
r_char
id|name
(braket
l_int|40
)braket
suffix:semicolon
DECL|member|array_status
id|__le32
id|array_status
suffix:semicolon
multiline_comment|/* device list continues beyond this point? */
)brace
id|__attribute__
c_func
(paren
(paren
id|packed
)paren
)paren
suffix:semicolon
r_static
r_int
id|carm_init_one
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_const
r_struct
id|pci_device_id
op_star
id|ent
)paren
suffix:semicolon
r_static
r_void
id|carm_remove_one
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
suffix:semicolon
r_static
r_int
id|carm_bdev_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|ino
comma
r_struct
id|file
op_star
id|fil
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
suffix:semicolon
DECL|variable|carm_pci_tbl
r_static
r_struct
id|pci_device_id
id|carm_pci_tbl
(braket
)braket
op_assign
(brace
(brace
id|PCI_VENDOR_ID_PROMISE
comma
l_int|0x8000
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
)brace
comma
(brace
id|PCI_VENDOR_ID_PROMISE
comma
l_int|0x8002
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0
comma
l_int|0
comma
)brace
comma
(brace
)brace
multiline_comment|/* terminate list */
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|pci
comma
id|carm_pci_tbl
)paren
suffix:semicolon
DECL|variable|carm_driver
r_static
r_struct
id|pci_driver
id|carm_driver
op_assign
(brace
dot
id|name
op_assign
id|DRV_NAME
comma
dot
id|id_table
op_assign
id|carm_pci_tbl
comma
dot
id|probe
op_assign
id|carm_init_one
comma
dot
id|remove
op_assign
id|carm_remove_one
comma
)brace
suffix:semicolon
DECL|variable|carm_bd_ops
r_static
r_struct
id|block_device_operations
id|carm_bd_ops
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|ioctl
op_assign
id|carm_bdev_ioctl
comma
)brace
suffix:semicolon
DECL|variable|carm_host_id
r_static
r_int
r_int
id|carm_host_id
suffix:semicolon
DECL|variable|carm_major_alloc
r_static
r_int
r_int
id|carm_major_alloc
suffix:semicolon
DECL|function|carm_bdev_ioctl
r_static
r_int
id|carm_bdev_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|ino
comma
r_struct
id|file
op_star
id|fil
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_void
id|__user
op_star
id|usermem
op_assign
(paren
r_void
id|__user
op_star
)paren
id|arg
suffix:semicolon
r_struct
id|carm_port
op_star
id|port
op_assign
id|ino-&gt;i_bdev-&gt;bd_disk-&gt;private_data
suffix:semicolon
r_struct
id|hd_geometry
id|geom
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|HDIO_GETGEO
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|usermem
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|geom.heads
op_assign
(paren
id|u8
)paren
id|port-&gt;dev_geom_head
suffix:semicolon
id|geom.sectors
op_assign
(paren
id|u8
)paren
id|port-&gt;dev_geom_sect
suffix:semicolon
id|geom.cylinders
op_assign
id|port-&gt;dev_geom_cyl
suffix:semicolon
id|geom.start
op_assign
id|get_start_sect
c_func
(paren
id|ino-&gt;i_bdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|usermem
comma
op_amp
id|geom
comma
r_sizeof
(paren
id|geom
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
)brace
DECL|variable|msg_sizes
r_static
r_const
id|u32
id|msg_sizes
(braket
)braket
op_assign
(brace
l_int|32
comma
l_int|64
comma
l_int|128
comma
id|CARM_MSG_SIZE
)brace
suffix:semicolon
DECL|function|carm_lookup_bucket
r_static
r_inline
r_int
id|carm_lookup_bucket
c_func
(paren
id|u32
id|msg_size
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ARRAY_SIZE
c_func
(paren
id|msg_sizes
)paren
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|msg_size
op_le
id|msg_sizes
(braket
id|i
)braket
)paren
r_return
id|i
suffix:semicolon
r_return
op_minus
id|ENOENT
suffix:semicolon
)brace
DECL|function|carm_init_buckets
r_static
r_void
id|carm_init_buckets
c_func
(paren
r_void
id|__iomem
op_star
id|mmio
)paren
(brace
r_int
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ARRAY_SIZE
c_func
(paren
id|msg_sizes
)paren
suffix:semicolon
id|i
op_increment
)paren
id|writel
c_func
(paren
id|msg_sizes
(braket
id|i
)braket
comma
id|mmio
op_plus
id|CARM_CMS0
op_plus
(paren
l_int|4
op_star
id|i
)paren
)paren
suffix:semicolon
)brace
DECL|function|carm_ref_msg
r_static
r_inline
r_void
op_star
id|carm_ref_msg
c_func
(paren
r_struct
id|carm_host
op_star
id|host
comma
r_int
r_int
id|msg_idx
)paren
(brace
r_return
id|host-&gt;msg_base
op_plus
(paren
id|msg_idx
op_star
id|CARM_MSG_SIZE
)paren
suffix:semicolon
)brace
DECL|function|carm_ref_msg_dma
r_static
r_inline
id|dma_addr_t
id|carm_ref_msg_dma
c_func
(paren
r_struct
id|carm_host
op_star
id|host
comma
r_int
r_int
id|msg_idx
)paren
(brace
r_return
id|host-&gt;msg_dma
op_plus
(paren
id|msg_idx
op_star
id|CARM_MSG_SIZE
)paren
suffix:semicolon
)brace
DECL|function|carm_send_msg
r_static
r_int
id|carm_send_msg
c_func
(paren
r_struct
id|carm_host
op_star
id|host
comma
r_struct
id|carm_request
op_star
id|crq
)paren
(brace
r_void
id|__iomem
op_star
id|mmio
op_assign
id|host-&gt;mmio
suffix:semicolon
id|u32
id|msg
op_assign
(paren
id|u32
)paren
id|carm_ref_msg_dma
c_func
(paren
id|host
comma
id|crq-&gt;tag
)paren
suffix:semicolon
id|u32
id|cm_bucket
op_assign
id|crq-&gt;msg_bucket
suffix:semicolon
id|u32
id|tmp
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|VPRINTK
c_func
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
id|tmp
op_assign
id|readl
c_func
(paren
id|mmio
op_plus
id|CARM_HMUC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmp
op_amp
id|CARM_Q_FULL
)paren
(brace
macro_line|#if 0
id|tmp
op_assign
id|readl
c_func
(paren
id|mmio
op_plus
id|CARM_INT_MASK
)paren
suffix:semicolon
id|tmp
op_or_assign
id|INT_Q_AVAILABLE
suffix:semicolon
id|writel
c_func
(paren
id|tmp
comma
id|mmio
op_plus
id|CARM_INT_MASK
)paren
suffix:semicolon
id|readl
c_func
(paren
id|mmio
op_plus
id|CARM_INT_MASK
)paren
suffix:semicolon
multiline_comment|/* flush */
macro_line|#endif
id|DPRINTK
c_func
(paren
l_string|&quot;host msg queue full&bslash;n&quot;
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|EBUSY
suffix:semicolon
)brace
r_else
(brace
id|writel
c_func
(paren
id|msg
op_or
(paren
id|cm_bucket
op_lshift
l_int|1
)paren
comma
id|mmio
op_plus
id|CARM_IHQP
)paren
suffix:semicolon
id|readl
c_func
(paren
id|mmio
op_plus
id|CARM_IHQP
)paren
suffix:semicolon
multiline_comment|/* flush */
)brace
r_return
id|rc
suffix:semicolon
)brace
DECL|function|carm_get_request
r_static
r_struct
id|carm_request
op_star
id|carm_get_request
c_func
(paren
r_struct
id|carm_host
op_star
id|host
)paren
(brace
r_int
r_int
id|i
suffix:semicolon
multiline_comment|/* obey global hardware limit on S/G entries */
r_if
c_cond
(paren
id|host-&gt;hw_sg_used
op_ge
(paren
id|CARM_MAX_HOST_SG
op_minus
id|CARM_MAX_REQ_SG
)paren
)paren
r_return
l_int|NULL
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|CARM_MAX_Q
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
(paren
id|host-&gt;msg_alloc
op_amp
(paren
l_int|1ULL
op_lshift
id|i
)paren
)paren
op_eq
l_int|0
)paren
(brace
r_struct
id|carm_request
op_star
id|crq
op_assign
op_amp
id|host-&gt;req
(braket
id|i
)braket
suffix:semicolon
id|crq-&gt;port
op_assign
l_int|NULL
suffix:semicolon
id|crq-&gt;n_elem
op_assign
l_int|0
suffix:semicolon
id|host-&gt;msg_alloc
op_or_assign
(paren
l_int|1ULL
op_lshift
id|i
)paren
suffix:semicolon
id|host-&gt;n_msgs
op_increment
suffix:semicolon
m_assert
(paren
id|host-&gt;n_msgs
op_le
id|CARM_MAX_REQ
)paren
suffix:semicolon
r_return
id|crq
suffix:semicolon
)brace
id|DPRINTK
c_func
(paren
l_string|&quot;no request available, returning NULL&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|carm_put_request
r_static
r_int
id|carm_put_request
c_func
(paren
r_struct
id|carm_host
op_star
id|host
comma
r_struct
id|carm_request
op_star
id|crq
)paren
(brace
m_assert
(paren
id|crq-&gt;tag
OL
id|CARM_MAX_Q
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
(paren
id|host-&gt;msg_alloc
op_amp
(paren
l_int|1ULL
op_lshift
id|crq-&gt;tag
)paren
)paren
op_eq
l_int|0
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* tried to clear a tag that was not active */
m_assert
(paren
id|host-&gt;hw_sg_used
op_ge
id|crq-&gt;n_elem
)paren
suffix:semicolon
id|host-&gt;msg_alloc
op_and_assign
op_complement
(paren
l_int|1ULL
op_lshift
id|crq-&gt;tag
)paren
suffix:semicolon
id|host-&gt;hw_sg_used
op_sub_assign
id|crq-&gt;n_elem
suffix:semicolon
id|host-&gt;n_msgs
op_decrement
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|carm_get_special
r_static
r_struct
id|carm_request
op_star
id|carm_get_special
c_func
(paren
r_struct
id|carm_host
op_star
id|host
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_struct
id|carm_request
op_star
id|crq
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|request
op_star
id|rq
suffix:semicolon
r_int
id|tries
op_assign
l_int|5000
suffix:semicolon
r_while
c_loop
(paren
id|tries
op_decrement
OG
l_int|0
)paren
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|host-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|crq
op_assign
id|carm_get_request
c_func
(paren
id|host
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|host-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|crq
)paren
r_break
suffix:semicolon
id|msleep
c_func
(paren
l_int|10
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|crq
)paren
r_return
l_int|NULL
suffix:semicolon
id|rq
op_assign
id|blk_get_request
c_func
(paren
id|host-&gt;oob_q
comma
id|WRITE
multiline_comment|/* bogus */
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rq
)paren
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|host-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|carm_put_request
c_func
(paren
id|host
comma
id|crq
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|host-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|crq-&gt;rq
op_assign
id|rq
suffix:semicolon
r_return
id|crq
suffix:semicolon
)brace
DECL|function|carm_array_info
r_static
r_int
id|carm_array_info
(paren
r_struct
id|carm_host
op_star
id|host
comma
r_int
r_int
id|array_idx
)paren
(brace
r_struct
id|carm_msg_ioctl
op_star
id|ioc
suffix:semicolon
r_int
r_int
id|idx
suffix:semicolon
id|u32
id|msg_data
suffix:semicolon
id|dma_addr_t
id|msg_dma
suffix:semicolon
r_struct
id|carm_request
op_star
id|crq
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|crq
op_assign
id|carm_get_special
c_func
(paren
id|host
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|crq
)paren
(brace
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|err_out
suffix:semicolon
)brace
id|idx
op_assign
id|crq-&gt;tag
suffix:semicolon
id|ioc
op_assign
id|carm_ref_msg
c_func
(paren
id|host
comma
id|idx
)paren
suffix:semicolon
id|msg_dma
op_assign
id|carm_ref_msg_dma
c_func
(paren
id|host
comma
id|idx
)paren
suffix:semicolon
id|msg_data
op_assign
(paren
id|u32
)paren
(paren
id|msg_dma
op_plus
r_sizeof
(paren
r_struct
id|carm_array_info
)paren
)paren
suffix:semicolon
id|crq-&gt;msg_type
op_assign
id|CARM_MSG_ARRAY
suffix:semicolon
id|crq-&gt;msg_subtype
op_assign
id|CARM_ARRAY_INFO
suffix:semicolon
id|rc
op_assign
id|carm_lookup_bucket
c_func
(paren
r_sizeof
(paren
r_struct
id|carm_msg_ioctl
)paren
op_plus
r_sizeof
(paren
r_struct
id|carm_array_info
)paren
)paren
suffix:semicolon
id|BUG_ON
c_func
(paren
id|rc
OL
l_int|0
)paren
suffix:semicolon
id|crq-&gt;msg_bucket
op_assign
(paren
id|u32
)paren
id|rc
suffix:semicolon
id|memset
c_func
(paren
id|ioc
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|ioc
)paren
)paren
suffix:semicolon
id|ioc-&gt;type
op_assign
id|CARM_MSG_ARRAY
suffix:semicolon
id|ioc-&gt;subtype
op_assign
id|CARM_ARRAY_INFO
suffix:semicolon
id|ioc-&gt;array_id
op_assign
(paren
id|u8
)paren
id|array_idx
suffix:semicolon
id|ioc-&gt;handle
op_assign
id|cpu_to_le32
c_func
(paren
id|TAG_ENCODE
c_func
(paren
id|idx
)paren
)paren
suffix:semicolon
id|ioc-&gt;data_addr
op_assign
id|cpu_to_le32
c_func
(paren
id|msg_data
)paren
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|host-&gt;lock
)paren
suffix:semicolon
m_assert
(paren
id|host-&gt;state
op_eq
id|HST_DEV_SCAN_START
op_logical_or
id|host-&gt;state
op_eq
id|HST_DEV_SCAN
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|host-&gt;lock
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;blk_insert_request, tag == %u&bslash;n&quot;
comma
id|idx
)paren
suffix:semicolon
id|blk_insert_request
c_func
(paren
id|host-&gt;oob_q
comma
id|crq-&gt;rq
comma
l_int|1
comma
id|crq
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|err_out
suffix:colon
id|spin_lock_irq
c_func
(paren
op_amp
id|host-&gt;lock
)paren
suffix:semicolon
id|host-&gt;state
op_assign
id|HST_ERROR
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|host-&gt;lock
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|typedef|carm_sspc_t
r_typedef
r_int
r_int
(paren
op_star
id|carm_sspc_t
)paren
(paren
r_struct
id|carm_host
op_star
comma
r_int
r_int
comma
r_void
op_star
)paren
suffix:semicolon
DECL|function|carm_send_special
r_static
r_int
id|carm_send_special
(paren
r_struct
id|carm_host
op_star
id|host
comma
id|carm_sspc_t
id|func
)paren
(brace
r_struct
id|carm_request
op_star
id|crq
suffix:semicolon
r_struct
id|carm_msg_ioctl
op_star
id|ioc
suffix:semicolon
r_void
op_star
id|mem
suffix:semicolon
r_int
r_int
id|idx
comma
id|msg_size
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|crq
op_assign
id|carm_get_special
c_func
(paren
id|host
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|crq
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|idx
op_assign
id|crq-&gt;tag
suffix:semicolon
id|mem
op_assign
id|carm_ref_msg
c_func
(paren
id|host
comma
id|idx
)paren
suffix:semicolon
id|msg_size
op_assign
id|func
c_func
(paren
id|host
comma
id|idx
comma
id|mem
)paren
suffix:semicolon
id|ioc
op_assign
id|mem
suffix:semicolon
id|crq-&gt;msg_type
op_assign
id|ioc-&gt;type
suffix:semicolon
id|crq-&gt;msg_subtype
op_assign
id|ioc-&gt;subtype
suffix:semicolon
id|rc
op_assign
id|carm_lookup_bucket
c_func
(paren
id|msg_size
)paren
suffix:semicolon
id|BUG_ON
c_func
(paren
id|rc
OL
l_int|0
)paren
suffix:semicolon
id|crq-&gt;msg_bucket
op_assign
(paren
id|u32
)paren
id|rc
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;blk_insert_request, tag == %u&bslash;n&quot;
comma
id|idx
)paren
suffix:semicolon
id|blk_insert_request
c_func
(paren
id|host-&gt;oob_q
comma
id|crq-&gt;rq
comma
l_int|1
comma
id|crq
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|carm_fill_sync_time
r_static
r_int
r_int
id|carm_fill_sync_time
c_func
(paren
r_struct
id|carm_host
op_star
id|host
comma
r_int
r_int
id|idx
comma
r_void
op_star
id|mem
)paren
(brace
r_struct
id|timeval
id|tv
suffix:semicolon
r_struct
id|carm_msg_sync_time
op_star
id|st
op_assign
id|mem
suffix:semicolon
id|do_gettimeofday
c_func
(paren
op_amp
id|tv
)paren
suffix:semicolon
id|memset
c_func
(paren
id|st
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|st
)paren
)paren
suffix:semicolon
id|st-&gt;type
op_assign
id|CARM_MSG_MISC
suffix:semicolon
id|st-&gt;subtype
op_assign
id|MISC_SET_TIME
suffix:semicolon
id|st-&gt;handle
op_assign
id|cpu_to_le32
c_func
(paren
id|TAG_ENCODE
c_func
(paren
id|idx
)paren
)paren
suffix:semicolon
id|st-&gt;timestamp
op_assign
id|cpu_to_le32
c_func
(paren
id|tv.tv_sec
)paren
suffix:semicolon
r_return
r_sizeof
(paren
r_struct
id|carm_msg_sync_time
)paren
suffix:semicolon
)brace
DECL|function|carm_fill_alloc_buf
r_static
r_int
r_int
id|carm_fill_alloc_buf
c_func
(paren
r_struct
id|carm_host
op_star
id|host
comma
r_int
r_int
id|idx
comma
r_void
op_star
id|mem
)paren
(brace
r_struct
id|carm_msg_allocbuf
op_star
id|ab
op_assign
id|mem
suffix:semicolon
id|memset
c_func
(paren
id|ab
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|ab
)paren
)paren
suffix:semicolon
id|ab-&gt;type
op_assign
id|CARM_MSG_MISC
suffix:semicolon
id|ab-&gt;subtype
op_assign
id|MISC_ALLOC_MEM
suffix:semicolon
id|ab-&gt;handle
op_assign
id|cpu_to_le32
c_func
(paren
id|TAG_ENCODE
c_func
(paren
id|idx
)paren
)paren
suffix:semicolon
id|ab-&gt;n_sg
op_assign
l_int|1
suffix:semicolon
id|ab-&gt;sg_type
op_assign
id|SGT_32BIT
suffix:semicolon
id|ab-&gt;addr
op_assign
id|cpu_to_le32
c_func
(paren
id|host-&gt;shm_dma
op_plus
(paren
id|PDC_SHM_SIZE
op_rshift
l_int|1
)paren
)paren
suffix:semicolon
id|ab-&gt;len
op_assign
id|cpu_to_le32
c_func
(paren
id|PDC_SHM_SIZE
op_rshift
l_int|1
)paren
suffix:semicolon
id|ab-&gt;evt_pool
op_assign
id|cpu_to_le32
c_func
(paren
id|host-&gt;shm_dma
op_plus
(paren
l_int|16
op_star
l_int|1024
)paren
)paren
suffix:semicolon
id|ab-&gt;n_evt
op_assign
id|cpu_to_le32
c_func
(paren
l_int|1024
)paren
suffix:semicolon
id|ab-&gt;rbuf_pool
op_assign
id|cpu_to_le32
c_func
(paren
id|host-&gt;shm_dma
)paren
suffix:semicolon
id|ab-&gt;n_rbuf
op_assign
id|cpu_to_le32
c_func
(paren
id|RMSG_Q_LEN
)paren
suffix:semicolon
id|ab-&gt;msg_pool
op_assign
id|cpu_to_le32
c_func
(paren
id|host-&gt;shm_dma
op_plus
id|RBUF_LEN
)paren
suffix:semicolon
id|ab-&gt;n_msg
op_assign
id|cpu_to_le32
c_func
(paren
id|CARM_Q_LEN
)paren
suffix:semicolon
id|ab-&gt;sg
(braket
l_int|0
)braket
dot
id|start
op_assign
id|cpu_to_le32
c_func
(paren
id|host-&gt;shm_dma
op_plus
(paren
id|PDC_SHM_SIZE
op_rshift
l_int|1
)paren
)paren
suffix:semicolon
id|ab-&gt;sg
(braket
l_int|0
)braket
dot
id|len
op_assign
id|cpu_to_le32
c_func
(paren
l_int|65536
)paren
suffix:semicolon
r_return
r_sizeof
(paren
r_struct
id|carm_msg_allocbuf
)paren
suffix:semicolon
)brace
DECL|function|carm_fill_scan_channels
r_static
r_int
r_int
id|carm_fill_scan_channels
c_func
(paren
r_struct
id|carm_host
op_star
id|host
comma
r_int
r_int
id|idx
comma
r_void
op_star
id|mem
)paren
(brace
r_struct
id|carm_msg_ioctl
op_star
id|ioc
op_assign
id|mem
suffix:semicolon
id|u32
id|msg_data
op_assign
(paren
id|u32
)paren
(paren
id|carm_ref_msg_dma
c_func
(paren
id|host
comma
id|idx
)paren
op_plus
id|IOC_SCAN_CHAN_OFFSET
)paren
suffix:semicolon
id|memset
c_func
(paren
id|ioc
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|ioc
)paren
)paren
suffix:semicolon
id|ioc-&gt;type
op_assign
id|CARM_MSG_IOCTL
suffix:semicolon
id|ioc-&gt;subtype
op_assign
id|CARM_IOC_SCAN_CHAN
suffix:semicolon
id|ioc-&gt;handle
op_assign
id|cpu_to_le32
c_func
(paren
id|TAG_ENCODE
c_func
(paren
id|idx
)paren
)paren
suffix:semicolon
id|ioc-&gt;data_addr
op_assign
id|cpu_to_le32
c_func
(paren
id|msg_data
)paren
suffix:semicolon
multiline_comment|/* fill output data area with &quot;no device&quot; default values */
id|mem
op_add_assign
id|IOC_SCAN_CHAN_OFFSET
suffix:semicolon
id|memset
c_func
(paren
id|mem
comma
id|IOC_SCAN_CHAN_NODEV
comma
id|CARM_MAX_PORTS
)paren
suffix:semicolon
r_return
id|IOC_SCAN_CHAN_OFFSET
op_plus
id|CARM_MAX_PORTS
suffix:semicolon
)brace
DECL|function|carm_fill_get_fw_ver
r_static
r_int
r_int
id|carm_fill_get_fw_ver
c_func
(paren
r_struct
id|carm_host
op_star
id|host
comma
r_int
r_int
id|idx
comma
r_void
op_star
id|mem
)paren
(brace
r_struct
id|carm_msg_get_fw_ver
op_star
id|ioc
op_assign
id|mem
suffix:semicolon
id|u32
id|msg_data
op_assign
(paren
id|u32
)paren
(paren
id|carm_ref_msg_dma
c_func
(paren
id|host
comma
id|idx
)paren
op_plus
r_sizeof
(paren
op_star
id|ioc
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
id|ioc
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|ioc
)paren
)paren
suffix:semicolon
id|ioc-&gt;type
op_assign
id|CARM_MSG_MISC
suffix:semicolon
id|ioc-&gt;subtype
op_assign
id|MISC_GET_FW_VER
suffix:semicolon
id|ioc-&gt;handle
op_assign
id|cpu_to_le32
c_func
(paren
id|TAG_ENCODE
c_func
(paren
id|idx
)paren
)paren
suffix:semicolon
id|ioc-&gt;data_addr
op_assign
id|cpu_to_le32
c_func
(paren
id|msg_data
)paren
suffix:semicolon
r_return
r_sizeof
(paren
r_struct
id|carm_msg_get_fw_ver
)paren
op_plus
r_sizeof
(paren
r_struct
id|carm_fw_ver
)paren
suffix:semicolon
)brace
DECL|function|carm_end_request_queued
r_static
r_inline
r_void
id|carm_end_request_queued
c_func
(paren
r_struct
id|carm_host
op_star
id|host
comma
r_struct
id|carm_request
op_star
id|crq
comma
r_int
id|uptodate
)paren
(brace
r_struct
id|request
op_star
id|req
op_assign
id|crq-&gt;rq
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|rc
op_assign
id|end_that_request_first
c_func
(paren
id|req
comma
id|uptodate
comma
id|req-&gt;hard_nr_sectors
)paren
suffix:semicolon
m_assert
(paren
id|rc
op_eq
l_int|0
)paren
suffix:semicolon
id|end_that_request_last
c_func
(paren
id|req
)paren
suffix:semicolon
id|rc
op_assign
id|carm_put_request
c_func
(paren
id|host
comma
id|crq
)paren
suffix:semicolon
m_assert
(paren
id|rc
op_eq
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|carm_push_q
r_static
r_inline
r_void
id|carm_push_q
(paren
r_struct
id|carm_host
op_star
id|host
comma
id|request_queue_t
op_star
id|q
)paren
(brace
r_int
r_int
id|idx
op_assign
id|host-&gt;wait_q_prod
op_mod
id|CARM_MAX_WAIT_Q
suffix:semicolon
id|blk_stop_queue
c_func
(paren
id|q
)paren
suffix:semicolon
id|VPRINTK
c_func
(paren
l_string|&quot;STOPPED QUEUE %p&bslash;n&quot;
comma
id|q
)paren
suffix:semicolon
id|host-&gt;wait_q
(braket
id|idx
)braket
op_assign
id|q
suffix:semicolon
id|host-&gt;wait_q_prod
op_increment
suffix:semicolon
id|BUG_ON
c_func
(paren
id|host-&gt;wait_q_prod
op_eq
id|host-&gt;wait_q_cons
)paren
suffix:semicolon
multiline_comment|/* overrun */
)brace
DECL|function|carm_pop_q
r_static
r_inline
id|request_queue_t
op_star
id|carm_pop_q
c_func
(paren
r_struct
id|carm_host
op_star
id|host
)paren
(brace
r_int
r_int
id|idx
suffix:semicolon
r_if
c_cond
(paren
id|host-&gt;wait_q_prod
op_eq
id|host-&gt;wait_q_cons
)paren
r_return
l_int|NULL
suffix:semicolon
id|idx
op_assign
id|host-&gt;wait_q_cons
op_mod
id|CARM_MAX_WAIT_Q
suffix:semicolon
id|host-&gt;wait_q_cons
op_increment
suffix:semicolon
r_return
id|host-&gt;wait_q
(braket
id|idx
)braket
suffix:semicolon
)brace
DECL|function|carm_round_robin
r_static
r_inline
r_void
id|carm_round_robin
c_func
(paren
r_struct
id|carm_host
op_star
id|host
)paren
(brace
id|request_queue_t
op_star
id|q
op_assign
id|carm_pop_q
c_func
(paren
id|host
)paren
suffix:semicolon
r_if
c_cond
(paren
id|q
)paren
(brace
id|blk_start_queue
c_func
(paren
id|q
)paren
suffix:semicolon
id|VPRINTK
c_func
(paren
l_string|&quot;STARTED QUEUE %p&bslash;n&quot;
comma
id|q
)paren
suffix:semicolon
)brace
)brace
DECL|function|carm_end_rq
r_static
r_inline
r_void
id|carm_end_rq
c_func
(paren
r_struct
id|carm_host
op_star
id|host
comma
r_struct
id|carm_request
op_star
id|crq
comma
r_int
id|is_ok
)paren
(brace
id|carm_end_request_queued
c_func
(paren
id|host
comma
id|crq
comma
id|is_ok
)paren
suffix:semicolon
r_if
c_cond
(paren
id|CARM_MAX_Q
op_eq
l_int|1
)paren
id|carm_round_robin
c_func
(paren
id|host
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|host-&gt;n_msgs
op_le
id|CARM_MSG_LOW_WATER
)paren
op_logical_and
(paren
id|host-&gt;hw_sg_used
op_le
id|CARM_SG_LOW_WATER
)paren
)paren
(brace
id|carm_round_robin
c_func
(paren
id|host
)paren
suffix:semicolon
)brace
)brace
DECL|function|carm_oob_rq_fn
r_static
r_void
id|carm_oob_rq_fn
c_func
(paren
id|request_queue_t
op_star
id|q
)paren
(brace
r_struct
id|carm_host
op_star
id|host
op_assign
id|q-&gt;queuedata
suffix:semicolon
r_struct
id|carm_request
op_star
id|crq
suffix:semicolon
r_struct
id|request
op_star
id|rq
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;get req&bslash;n&quot;
)paren
suffix:semicolon
id|rq
op_assign
id|elv_next_request
c_func
(paren
id|q
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rq
)paren
r_break
suffix:semicolon
id|blkdev_dequeue_request
c_func
(paren
id|rq
)paren
suffix:semicolon
id|crq
op_assign
id|rq-&gt;special
suffix:semicolon
m_assert
(paren
id|crq
op_ne
l_int|NULL
)paren
suffix:semicolon
m_assert
(paren
id|crq-&gt;rq
op_eq
id|rq
)paren
suffix:semicolon
id|crq-&gt;n_elem
op_assign
l_int|0
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;send req&bslash;n&quot;
)paren
suffix:semicolon
id|rc
op_assign
id|carm_send_msg
c_func
(paren
id|host
comma
id|crq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|blk_requeue_request
c_func
(paren
id|q
comma
id|rq
)paren
suffix:semicolon
id|carm_push_q
c_func
(paren
id|host
comma
id|q
)paren
suffix:semicolon
r_return
suffix:semicolon
multiline_comment|/* call us again later, eventually */
)brace
)brace
)brace
DECL|function|carm_rq_fn
r_static
r_void
id|carm_rq_fn
c_func
(paren
id|request_queue_t
op_star
id|q
)paren
(brace
r_struct
id|carm_port
op_star
id|port
op_assign
id|q-&gt;queuedata
suffix:semicolon
r_struct
id|carm_host
op_star
id|host
op_assign
id|port-&gt;host
suffix:semicolon
r_struct
id|carm_msg_rw
op_star
id|msg
suffix:semicolon
r_struct
id|carm_request
op_star
id|crq
suffix:semicolon
r_struct
id|request
op_star
id|rq
suffix:semicolon
r_struct
id|scatterlist
op_star
id|sg
suffix:semicolon
r_int
id|writing
op_assign
l_int|0
comma
id|pci_dir
comma
id|i
comma
id|n_elem
comma
id|rc
suffix:semicolon
id|u32
id|tmp
suffix:semicolon
r_int
r_int
id|msg_size
suffix:semicolon
id|queue_one_request
suffix:colon
id|VPRINTK
c_func
(paren
l_string|&quot;get req&bslash;n&quot;
)paren
suffix:semicolon
id|rq
op_assign
id|elv_next_request
c_func
(paren
id|q
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rq
)paren
r_return
suffix:semicolon
id|crq
op_assign
id|carm_get_request
c_func
(paren
id|host
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|crq
)paren
(brace
id|carm_push_q
c_func
(paren
id|host
comma
id|q
)paren
suffix:semicolon
r_return
suffix:semicolon
multiline_comment|/* call us again later, eventually */
)brace
id|crq-&gt;rq
op_assign
id|rq
suffix:semicolon
id|blkdev_dequeue_request
c_func
(paren
id|rq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rq_data_dir
c_func
(paren
id|rq
)paren
op_eq
id|WRITE
)paren
(brace
id|writing
op_assign
l_int|1
suffix:semicolon
id|pci_dir
op_assign
id|PCI_DMA_TODEVICE
suffix:semicolon
)brace
r_else
(brace
id|pci_dir
op_assign
id|PCI_DMA_FROMDEVICE
suffix:semicolon
)brace
multiline_comment|/* get scatterlist from block layer */
id|sg
op_assign
op_amp
id|crq-&gt;sg
(braket
l_int|0
)braket
suffix:semicolon
id|n_elem
op_assign
id|blk_rq_map_sg
c_func
(paren
id|q
comma
id|rq
comma
id|sg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|n_elem
op_le
l_int|0
)paren
(brace
id|carm_end_rq
c_func
(paren
id|host
comma
id|crq
comma
l_int|0
)paren
suffix:semicolon
r_return
suffix:semicolon
multiline_comment|/* request with no s/g entries? */
)brace
multiline_comment|/* map scatterlist to PCI bus addresses */
id|n_elem
op_assign
id|pci_map_sg
c_func
(paren
id|host-&gt;pdev
comma
id|sg
comma
id|n_elem
comma
id|pci_dir
)paren
suffix:semicolon
r_if
c_cond
(paren
id|n_elem
op_le
l_int|0
)paren
(brace
id|carm_end_rq
c_func
(paren
id|host
comma
id|crq
comma
l_int|0
)paren
suffix:semicolon
r_return
suffix:semicolon
multiline_comment|/* request with no s/g entries? */
)brace
id|crq-&gt;n_elem
op_assign
id|n_elem
suffix:semicolon
id|crq-&gt;port
op_assign
id|port
suffix:semicolon
id|host-&gt;hw_sg_used
op_add_assign
id|n_elem
suffix:semicolon
multiline_comment|/*&n;&t; * build read/write message&n;&t; */
id|VPRINTK
c_func
(paren
l_string|&quot;build msg&bslash;n&quot;
)paren
suffix:semicolon
id|msg
op_assign
(paren
r_struct
id|carm_msg_rw
op_star
)paren
id|carm_ref_msg
c_func
(paren
id|host
comma
id|crq-&gt;tag
)paren
suffix:semicolon
r_if
c_cond
(paren
id|writing
)paren
(brace
id|msg-&gt;type
op_assign
id|CARM_MSG_WRITE
suffix:semicolon
id|crq-&gt;msg_type
op_assign
id|CARM_MSG_WRITE
suffix:semicolon
)brace
r_else
(brace
id|msg-&gt;type
op_assign
id|CARM_MSG_READ
suffix:semicolon
id|crq-&gt;msg_type
op_assign
id|CARM_MSG_READ
suffix:semicolon
)brace
id|msg-&gt;id
op_assign
id|port-&gt;port_no
suffix:semicolon
id|msg-&gt;sg_count
op_assign
id|n_elem
suffix:semicolon
id|msg-&gt;sg_type
op_assign
id|SGT_32BIT
suffix:semicolon
id|msg-&gt;handle
op_assign
id|cpu_to_le32
c_func
(paren
id|TAG_ENCODE
c_func
(paren
id|crq-&gt;tag
)paren
)paren
suffix:semicolon
id|msg-&gt;lba
op_assign
id|cpu_to_le32
c_func
(paren
id|rq-&gt;sector
op_amp
l_int|0xffffffff
)paren
suffix:semicolon
id|tmp
op_assign
(paren
id|rq-&gt;sector
op_rshift
l_int|16
)paren
op_rshift
l_int|16
suffix:semicolon
id|msg-&gt;lba_high
op_assign
id|cpu_to_le16
c_func
(paren
(paren
id|u16
)paren
id|tmp
)paren
suffix:semicolon
id|msg-&gt;lba_count
op_assign
id|cpu_to_le16
c_func
(paren
id|rq-&gt;nr_sectors
)paren
suffix:semicolon
id|msg_size
op_assign
r_sizeof
(paren
r_struct
id|carm_msg_rw
)paren
op_minus
r_sizeof
(paren
id|msg-&gt;sg
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|n_elem
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|carm_msg_sg
op_star
id|carm_sg
op_assign
op_amp
id|msg-&gt;sg
(braket
id|i
)braket
suffix:semicolon
id|carm_sg-&gt;start
op_assign
id|cpu_to_le32
c_func
(paren
id|sg_dma_address
c_func
(paren
op_amp
id|crq-&gt;sg
(braket
id|i
)braket
)paren
)paren
suffix:semicolon
id|carm_sg-&gt;len
op_assign
id|cpu_to_le32
c_func
(paren
id|sg_dma_len
c_func
(paren
op_amp
id|crq-&gt;sg
(braket
id|i
)braket
)paren
)paren
suffix:semicolon
id|msg_size
op_add_assign
r_sizeof
(paren
r_struct
id|carm_msg_sg
)paren
suffix:semicolon
)brace
id|rc
op_assign
id|carm_lookup_bucket
c_func
(paren
id|msg_size
)paren
suffix:semicolon
id|BUG_ON
c_func
(paren
id|rc
OL
l_int|0
)paren
suffix:semicolon
id|crq-&gt;msg_bucket
op_assign
(paren
id|u32
)paren
id|rc
suffix:semicolon
multiline_comment|/*&n;&t; * queue read/write message to hardware&n;&t; */
id|VPRINTK
c_func
(paren
l_string|&quot;send msg, tag == %u&bslash;n&quot;
comma
id|crq-&gt;tag
)paren
suffix:semicolon
id|rc
op_assign
id|carm_send_msg
c_func
(paren
id|host
comma
id|crq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|carm_put_request
c_func
(paren
id|host
comma
id|crq
)paren
suffix:semicolon
id|blk_requeue_request
c_func
(paren
id|q
comma
id|rq
)paren
suffix:semicolon
id|carm_push_q
c_func
(paren
id|host
comma
id|q
)paren
suffix:semicolon
r_return
suffix:semicolon
multiline_comment|/* call us again later, eventually */
)brace
r_goto
id|queue_one_request
suffix:semicolon
)brace
DECL|function|carm_handle_array_info
r_static
r_void
id|carm_handle_array_info
c_func
(paren
r_struct
id|carm_host
op_star
id|host
comma
r_struct
id|carm_request
op_star
id|crq
comma
id|u8
op_star
id|mem
comma
r_int
id|is_ok
)paren
(brace
r_struct
id|carm_port
op_star
id|port
suffix:semicolon
id|u8
op_star
id|msg_data
op_assign
id|mem
op_plus
r_sizeof
(paren
r_struct
id|carm_array_info
)paren
suffix:semicolon
r_struct
id|carm_array_info
op_star
id|desc
op_assign
(paren
r_struct
id|carm_array_info
op_star
)paren
id|msg_data
suffix:semicolon
id|u64
id|lo
comma
id|hi
suffix:semicolon
r_int
id|cur_port
suffix:semicolon
r_int
id|slen
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
id|carm_end_rq
c_func
(paren
id|host
comma
id|crq
comma
id|is_ok
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|is_ok
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|le32_to_cpu
c_func
(paren
id|desc-&gt;array_status
)paren
op_amp
id|ARRAY_NO_EXIST
)paren
r_goto
id|out
suffix:semicolon
id|cur_port
op_assign
id|host-&gt;cur_scan_dev
suffix:semicolon
multiline_comment|/* should never occur */
r_if
c_cond
(paren
(paren
id|cur_port
OL
l_int|0
)paren
op_logical_or
(paren
id|cur_port
op_ge
id|CARM_MAX_PORTS
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;BUG: cur_scan_dev==%d, array_id==%d&bslash;n&quot;
comma
id|cur_port
comma
(paren
r_int
)paren
id|desc-&gt;array_id
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|port
op_assign
op_amp
id|host-&gt;port
(braket
id|cur_port
)braket
suffix:semicolon
id|lo
op_assign
(paren
id|u64
)paren
id|le32_to_cpu
c_func
(paren
id|desc-&gt;size
)paren
suffix:semicolon
id|hi
op_assign
(paren
id|u64
)paren
id|le16_to_cpu
c_func
(paren
id|desc-&gt;size_hi
)paren
suffix:semicolon
id|port-&gt;capacity
op_assign
id|lo
op_or
(paren
id|hi
op_lshift
l_int|32
)paren
suffix:semicolon
id|port-&gt;dev_geom_head
op_assign
id|le16_to_cpu
c_func
(paren
id|desc-&gt;head
)paren
suffix:semicolon
id|port-&gt;dev_geom_sect
op_assign
id|le16_to_cpu
c_func
(paren
id|desc-&gt;sect
)paren
suffix:semicolon
id|port-&gt;dev_geom_cyl
op_assign
id|le16_to_cpu
c_func
(paren
id|desc-&gt;cyl
)paren
suffix:semicolon
id|host-&gt;dev_active
op_or_assign
(paren
l_int|1
op_lshift
id|cur_port
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|port-&gt;name
comma
id|desc-&gt;name
comma
r_sizeof
(paren
id|port-&gt;name
)paren
)paren
suffix:semicolon
id|port-&gt;name
(braket
r_sizeof
(paren
id|port-&gt;name
)paren
op_minus
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|slen
op_assign
id|strlen
c_func
(paren
id|port-&gt;name
)paren
suffix:semicolon
r_while
c_loop
(paren
id|slen
op_logical_and
(paren
id|port-&gt;name
(braket
id|slen
op_minus
l_int|1
)braket
op_eq
l_char|&squot; &squot;
)paren
)paren
(brace
id|port-&gt;name
(braket
id|slen
op_minus
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|slen
op_decrement
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
id|DRV_NAME
l_string|&quot;(%s): port %u device %Lu sectors&bslash;n&quot;
comma
id|pci_name
c_func
(paren
id|host-&gt;pdev
)paren
comma
id|port-&gt;port_no
comma
(paren
r_int
r_int
r_int
)paren
id|port-&gt;capacity
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
id|DRV_NAME
l_string|&quot;(%s): port %u device &bslash;&quot;%s&bslash;&quot;&bslash;n&quot;
comma
id|pci_name
c_func
(paren
id|host-&gt;pdev
)paren
comma
id|port-&gt;port_no
comma
id|port-&gt;name
)paren
suffix:semicolon
id|out
suffix:colon
m_assert
(paren
id|host-&gt;state
op_eq
id|HST_DEV_SCAN
)paren
suffix:semicolon
id|schedule_work
c_func
(paren
op_amp
id|host-&gt;fsm_task
)paren
suffix:semicolon
)brace
DECL|function|carm_handle_scan_chan
r_static
r_void
id|carm_handle_scan_chan
c_func
(paren
r_struct
id|carm_host
op_star
id|host
comma
r_struct
id|carm_request
op_star
id|crq
comma
id|u8
op_star
id|mem
comma
r_int
id|is_ok
)paren
(brace
id|u8
op_star
id|msg_data
op_assign
id|mem
op_plus
id|IOC_SCAN_CHAN_OFFSET
suffix:semicolon
r_int
r_int
id|i
comma
id|dev_count
op_assign
l_int|0
suffix:semicolon
r_int
id|new_state
op_assign
id|HST_DEV_SCAN_START
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
id|carm_end_rq
c_func
(paren
id|host
comma
id|crq
comma
id|is_ok
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|is_ok
)paren
(brace
id|new_state
op_assign
id|HST_ERROR
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* TODO: scan and support non-disk devices */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|msg_data
(braket
id|i
)braket
op_eq
l_int|0
)paren
(brace
multiline_comment|/* direct-access device (disk) */
id|host-&gt;dev_present
op_or_assign
(paren
l_int|1
op_lshift
id|i
)paren
suffix:semicolon
id|dev_count
op_increment
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
id|DRV_NAME
l_string|&quot;(%s): found %u interesting devices&bslash;n&quot;
comma
id|pci_name
c_func
(paren
id|host-&gt;pdev
)paren
comma
id|dev_count
)paren
suffix:semicolon
id|out
suffix:colon
m_assert
(paren
id|host-&gt;state
op_eq
id|HST_PORT_SCAN
)paren
suffix:semicolon
id|host-&gt;state
op_assign
id|new_state
suffix:semicolon
id|schedule_work
c_func
(paren
op_amp
id|host-&gt;fsm_task
)paren
suffix:semicolon
)brace
DECL|function|carm_handle_generic
r_static
r_void
id|carm_handle_generic
c_func
(paren
r_struct
id|carm_host
op_star
id|host
comma
r_struct
id|carm_request
op_star
id|crq
comma
r_int
id|is_ok
comma
r_int
id|cur_state
comma
r_int
id|next_state
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
id|carm_end_rq
c_func
(paren
id|host
comma
id|crq
comma
id|is_ok
)paren
suffix:semicolon
m_assert
(paren
id|host-&gt;state
op_eq
id|cur_state
)paren
suffix:semicolon
r_if
c_cond
(paren
id|is_ok
)paren
id|host-&gt;state
op_assign
id|next_state
suffix:semicolon
r_else
id|host-&gt;state
op_assign
id|HST_ERROR
suffix:semicolon
id|schedule_work
c_func
(paren
op_amp
id|host-&gt;fsm_task
)paren
suffix:semicolon
)brace
DECL|function|carm_handle_rw
r_static
r_inline
r_void
id|carm_handle_rw
c_func
(paren
r_struct
id|carm_host
op_star
id|host
comma
r_struct
id|carm_request
op_star
id|crq
comma
r_int
id|is_ok
)paren
(brace
r_int
id|pci_dir
suffix:semicolon
id|VPRINTK
c_func
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rq_data_dir
c_func
(paren
id|crq-&gt;rq
)paren
op_eq
id|WRITE
)paren
id|pci_dir
op_assign
id|PCI_DMA_TODEVICE
suffix:semicolon
r_else
id|pci_dir
op_assign
id|PCI_DMA_FROMDEVICE
suffix:semicolon
id|pci_unmap_sg
c_func
(paren
id|host-&gt;pdev
comma
op_amp
id|crq-&gt;sg
(braket
l_int|0
)braket
comma
id|crq-&gt;n_elem
comma
id|pci_dir
)paren
suffix:semicolon
id|carm_end_rq
c_func
(paren
id|host
comma
id|crq
comma
id|is_ok
)paren
suffix:semicolon
)brace
DECL|function|carm_handle_resp
r_static
r_inline
r_void
id|carm_handle_resp
c_func
(paren
r_struct
id|carm_host
op_star
id|host
comma
id|__le32
id|ret_handle_le
comma
id|u32
id|status
)paren
(brace
id|u32
id|handle
op_assign
id|le32_to_cpu
c_func
(paren
id|ret_handle_le
)paren
suffix:semicolon
r_int
r_int
id|msg_idx
suffix:semicolon
r_struct
id|carm_request
op_star
id|crq
suffix:semicolon
r_int
id|is_ok
op_assign
(paren
id|status
op_eq
id|RMSG_OK
)paren
suffix:semicolon
id|u8
op_star
id|mem
suffix:semicolon
id|VPRINTK
c_func
(paren
l_string|&quot;ENTER, handle == 0x%x&bslash;n&quot;
comma
id|handle
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
op_logical_neg
id|TAG_VALID
c_func
(paren
id|handle
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|DRV_NAME
l_string|&quot;(%s): BUG: invalid tag 0x%x&bslash;n&quot;
comma
id|pci_name
c_func
(paren
id|host-&gt;pdev
)paren
comma
id|handle
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|msg_idx
op_assign
id|TAG_DECODE
c_func
(paren
id|handle
)paren
suffix:semicolon
id|VPRINTK
c_func
(paren
l_string|&quot;tag == %u&bslash;n&quot;
comma
id|msg_idx
)paren
suffix:semicolon
id|crq
op_assign
op_amp
id|host-&gt;req
(braket
id|msg_idx
)braket
suffix:semicolon
multiline_comment|/* fast path */
r_if
c_cond
(paren
id|likely
c_func
(paren
id|crq-&gt;msg_type
op_eq
id|CARM_MSG_READ
op_logical_or
id|crq-&gt;msg_type
op_eq
id|CARM_MSG_WRITE
)paren
)paren
(brace
id|carm_handle_rw
c_func
(paren
id|host
comma
id|crq
comma
id|is_ok
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|mem
op_assign
id|carm_ref_msg
c_func
(paren
id|host
comma
id|msg_idx
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|crq-&gt;msg_type
)paren
(brace
r_case
id|CARM_MSG_IOCTL
suffix:colon
(brace
r_switch
c_cond
(paren
id|crq-&gt;msg_subtype
)paren
(brace
r_case
id|CARM_IOC_SCAN_CHAN
suffix:colon
id|carm_handle_scan_chan
c_func
(paren
id|host
comma
id|crq
comma
id|mem
comma
id|is_ok
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* unknown / invalid response */
r_goto
id|err_out
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_case
id|CARM_MSG_MISC
suffix:colon
(brace
r_switch
c_cond
(paren
id|crq-&gt;msg_subtype
)paren
(brace
r_case
id|MISC_ALLOC_MEM
suffix:colon
id|carm_handle_generic
c_func
(paren
id|host
comma
id|crq
comma
id|is_ok
comma
id|HST_ALLOC_BUF
comma
id|HST_SYNC_TIME
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MISC_SET_TIME
suffix:colon
id|carm_handle_generic
c_func
(paren
id|host
comma
id|crq
comma
id|is_ok
comma
id|HST_SYNC_TIME
comma
id|HST_GET_FW_VER
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MISC_GET_FW_VER
suffix:colon
(brace
r_struct
id|carm_fw_ver
op_star
id|ver
op_assign
(paren
r_struct
id|carm_fw_ver
op_star
)paren
id|mem
op_plus
r_sizeof
(paren
r_struct
id|carm_msg_get_fw_ver
)paren
suffix:semicolon
r_if
c_cond
(paren
id|is_ok
)paren
(brace
id|host-&gt;fw_ver
op_assign
id|le32_to_cpu
c_func
(paren
id|ver-&gt;version
)paren
suffix:semicolon
id|host-&gt;flags
op_or_assign
(paren
id|ver-&gt;features
op_amp
id|FL_FW_VER_MASK
)paren
suffix:semicolon
)brace
id|carm_handle_generic
c_func
(paren
id|host
comma
id|crq
comma
id|is_ok
comma
id|HST_GET_FW_VER
comma
id|HST_PORT_SCAN
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_default
suffix:colon
multiline_comment|/* unknown / invalid response */
r_goto
id|err_out
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_case
id|CARM_MSG_ARRAY
suffix:colon
(brace
r_switch
c_cond
(paren
id|crq-&gt;msg_subtype
)paren
(brace
r_case
id|CARM_ARRAY_INFO
suffix:colon
id|carm_handle_array_info
c_func
(paren
id|host
comma
id|crq
comma
id|mem
comma
id|is_ok
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* unknown / invalid response */
r_goto
id|err_out
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_default
suffix:colon
multiline_comment|/* unknown / invalid response */
r_goto
id|err_out
suffix:semicolon
)brace
r_return
suffix:semicolon
id|err_out
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
id|DRV_NAME
l_string|&quot;(%s): BUG: unhandled message type %d/%d&bslash;n&quot;
comma
id|pci_name
c_func
(paren
id|host-&gt;pdev
)paren
comma
id|crq-&gt;msg_type
comma
id|crq-&gt;msg_subtype
)paren
suffix:semicolon
id|carm_end_rq
c_func
(paren
id|host
comma
id|crq
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|carm_handle_responses
r_static
r_inline
r_void
id|carm_handle_responses
c_func
(paren
r_struct
id|carm_host
op_star
id|host
)paren
(brace
r_void
id|__iomem
op_star
id|mmio
op_assign
id|host-&gt;mmio
suffix:semicolon
r_struct
id|carm_response
op_star
id|resp
op_assign
(paren
r_struct
id|carm_response
op_star
)paren
id|host-&gt;shm
suffix:semicolon
r_int
r_int
id|work
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|idx
op_assign
id|host-&gt;resp_idx
op_mod
id|RMSG_Q_LEN
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|u32
id|status
op_assign
id|le32_to_cpu
c_func
(paren
id|resp
(braket
id|idx
)braket
dot
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_eq
l_int|0xffffffff
)paren
(brace
id|VPRINTK
c_func
(paren
l_string|&quot;ending response on index %u&bslash;n&quot;
comma
id|idx
)paren
suffix:semicolon
id|writel
c_func
(paren
id|idx
op_lshift
l_int|3
comma
id|mmio
op_plus
id|CARM_RESP_IDX
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* response to a message we sent */
r_else
r_if
c_cond
(paren
(paren
id|status
op_amp
(paren
l_int|1
op_lshift
l_int|31
)paren
)paren
op_eq
l_int|0
)paren
(brace
id|VPRINTK
c_func
(paren
l_string|&quot;handling msg response on index %u&bslash;n&quot;
comma
id|idx
)paren
suffix:semicolon
id|carm_handle_resp
c_func
(paren
id|host
comma
id|resp
(braket
id|idx
)braket
dot
id|ret_handle
comma
id|status
)paren
suffix:semicolon
id|resp
(braket
id|idx
)braket
dot
id|status
op_assign
id|cpu_to_le32
c_func
(paren
l_int|0xffffffff
)paren
suffix:semicolon
)brace
multiline_comment|/* asynchronous events the hardware throws our way */
r_else
r_if
c_cond
(paren
(paren
id|status
op_amp
l_int|0xff000000
)paren
op_eq
(paren
l_int|1
op_lshift
l_int|31
)paren
)paren
(brace
id|u8
op_star
id|evt_type_ptr
op_assign
(paren
id|u8
op_star
)paren
op_amp
id|resp
(braket
id|idx
)braket
suffix:semicolon
id|u8
id|evt_type
op_assign
op_star
id|evt_type_ptr
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
id|DRV_NAME
l_string|&quot;(%s): unhandled event type %d&bslash;n&quot;
comma
id|pci_name
c_func
(paren
id|host-&gt;pdev
)paren
comma
(paren
r_int
)paren
id|evt_type
)paren
suffix:semicolon
id|resp
(braket
id|idx
)braket
dot
id|status
op_assign
id|cpu_to_le32
c_func
(paren
l_int|0xffffffff
)paren
suffix:semicolon
)brace
id|idx
op_assign
id|NEXT_RESP
c_func
(paren
id|idx
)paren
suffix:semicolon
id|work
op_increment
suffix:semicolon
)brace
id|VPRINTK
c_func
(paren
l_string|&quot;EXIT, work==%u&bslash;n&quot;
comma
id|work
)paren
suffix:semicolon
id|host-&gt;resp_idx
op_add_assign
id|work
suffix:semicolon
)brace
DECL|function|carm_interrupt
r_static
id|irqreturn_t
id|carm_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|__host
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|carm_host
op_star
id|host
op_assign
id|__host
suffix:semicolon
r_void
id|__iomem
op_star
id|mmio
suffix:semicolon
id|u32
id|mask
suffix:semicolon
r_int
id|handled
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|host
)paren
(brace
id|VPRINTK
c_func
(paren
l_string|&quot;no host&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|IRQ_NONE
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|host-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|mmio
op_assign
id|host-&gt;mmio
suffix:semicolon
multiline_comment|/* reading should also clear interrupts */
id|mask
op_assign
id|readl
c_func
(paren
id|mmio
op_plus
id|CARM_INT_STAT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mask
op_eq
l_int|0
op_logical_or
id|mask
op_eq
l_int|0xffffffff
)paren
(brace
id|VPRINTK
c_func
(paren
l_string|&quot;no work, mask == 0x%x&bslash;n&quot;
comma
id|mask
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mask
op_amp
id|INT_ACK_MASK
)paren
id|writel
c_func
(paren
id|mask
comma
id|mmio
op_plus
id|CARM_INT_STAT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|host-&gt;state
op_eq
id|HST_INVALID
)paren
)paren
(brace
id|VPRINTK
c_func
(paren
l_string|&quot;not initialized yet, mask = 0x%x&bslash;n&quot;
comma
id|mask
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mask
op_amp
id|CARM_HAVE_RESP
)paren
(brace
id|handled
op_assign
l_int|1
suffix:semicolon
id|carm_handle_responses
c_func
(paren
id|host
)paren
suffix:semicolon
)brace
id|out
suffix:colon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|host-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|VPRINTK
c_func
(paren
l_string|&quot;EXIT&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|IRQ_RETVAL
c_func
(paren
id|handled
)paren
suffix:semicolon
)brace
DECL|function|carm_fsm_task
r_static
r_void
id|carm_fsm_task
(paren
r_void
op_star
id|_data
)paren
(brace
r_struct
id|carm_host
op_star
id|host
op_assign
id|_data
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|state
suffix:semicolon
r_int
id|rc
comma
id|i
comma
id|next_dev
suffix:semicolon
r_int
id|reschedule
op_assign
l_int|0
suffix:semicolon
r_int
id|new_state
op_assign
id|HST_INVALID
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|host-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|state
op_assign
id|host-&gt;state
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|host-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;ENTER, state == %s&bslash;n&quot;
comma
id|state_name
(braket
id|state
)braket
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|state
)paren
(brace
r_case
id|HST_PROBE_START
suffix:colon
id|new_state
op_assign
id|HST_ALLOC_BUF
suffix:semicolon
id|reschedule
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HST_ALLOC_BUF
suffix:colon
id|rc
op_assign
id|carm_send_special
c_func
(paren
id|host
comma
id|carm_fill_alloc_buf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|new_state
op_assign
id|HST_ERROR
suffix:semicolon
id|reschedule
op_assign
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|HST_SYNC_TIME
suffix:colon
id|rc
op_assign
id|carm_send_special
c_func
(paren
id|host
comma
id|carm_fill_sync_time
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|new_state
op_assign
id|HST_ERROR
suffix:semicolon
id|reschedule
op_assign
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|HST_GET_FW_VER
suffix:colon
id|rc
op_assign
id|carm_send_special
c_func
(paren
id|host
comma
id|carm_fill_get_fw_ver
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|new_state
op_assign
id|HST_ERROR
suffix:semicolon
id|reschedule
op_assign
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|HST_PORT_SCAN
suffix:colon
id|rc
op_assign
id|carm_send_special
c_func
(paren
id|host
comma
id|carm_fill_scan_channels
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|new_state
op_assign
id|HST_ERROR
suffix:semicolon
id|reschedule
op_assign
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|HST_DEV_SCAN_START
suffix:colon
id|host-&gt;cur_scan_dev
op_assign
op_minus
l_int|1
suffix:semicolon
id|new_state
op_assign
id|HST_DEV_SCAN
suffix:semicolon
id|reschedule
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HST_DEV_SCAN
suffix:colon
id|next_dev
op_assign
op_minus
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|host-&gt;cur_scan_dev
op_plus
l_int|1
suffix:semicolon
id|i
OL
id|CARM_MAX_PORTS
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|host-&gt;dev_present
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
(brace
id|next_dev
op_assign
id|i
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|next_dev
op_ge
l_int|0
)paren
(brace
id|host-&gt;cur_scan_dev
op_assign
id|next_dev
suffix:semicolon
id|rc
op_assign
id|carm_array_info
c_func
(paren
id|host
comma
id|next_dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|new_state
op_assign
id|HST_ERROR
suffix:semicolon
id|reschedule
op_assign
l_int|1
suffix:semicolon
)brace
)brace
r_else
(brace
id|new_state
op_assign
id|HST_DEV_ACTIVATE
suffix:semicolon
id|reschedule
op_assign
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|HST_DEV_ACTIVATE
suffix:colon
(brace
r_int
id|activated
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|CARM_MAX_PORTS
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|host-&gt;dev_active
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
(brace
r_struct
id|carm_port
op_star
id|port
op_assign
op_amp
id|host-&gt;port
(braket
id|i
)braket
suffix:semicolon
r_struct
id|gendisk
op_star
id|disk
op_assign
id|port-&gt;disk
suffix:semicolon
id|set_capacity
c_func
(paren
id|disk
comma
id|port-&gt;capacity
)paren
suffix:semicolon
id|add_disk
c_func
(paren
id|disk
)paren
suffix:semicolon
id|activated
op_increment
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
id|DRV_NAME
l_string|&quot;(%s): %d ports activated&bslash;n&quot;
comma
id|pci_name
c_func
(paren
id|host-&gt;pdev
)paren
comma
id|activated
)paren
suffix:semicolon
id|new_state
op_assign
id|HST_PROBE_FINISHED
suffix:semicolon
id|reschedule
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
id|HST_PROBE_FINISHED
suffix:colon
id|up
c_func
(paren
op_amp
id|host-&gt;probe_sem
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HST_ERROR
suffix:colon
multiline_comment|/* FIXME: TODO */
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* should never occur */
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;BUG: unknown state %d&bslash;n&quot;
comma
id|state
)paren
suffix:semicolon
m_assert
(paren
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|new_state
op_ne
id|HST_INVALID
)paren
(brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|host-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|host-&gt;state
op_assign
id|new_state
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|host-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|reschedule
)paren
id|schedule_work
c_func
(paren
op_amp
id|host-&gt;fsm_task
)paren
suffix:semicolon
)brace
DECL|function|carm_init_wait
r_static
r_int
id|carm_init_wait
c_func
(paren
r_void
id|__iomem
op_star
id|mmio
comma
id|u32
id|bits
comma
r_int
r_int
id|test_bit
)paren
(brace
r_int
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|50000
suffix:semicolon
id|i
op_increment
)paren
(brace
id|u32
id|tmp
op_assign
id|readl
c_func
(paren
id|mmio
op_plus
id|CARM_LMUC
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
r_if
c_cond
(paren
id|test_bit
)paren
(brace
r_if
c_cond
(paren
(paren
id|tmp
op_amp
id|bits
)paren
op_eq
id|bits
)paren
r_return
l_int|0
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
(paren
id|tmp
op_amp
id|bits
)paren
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
)brace
id|cond_resched
c_func
(paren
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;carm_init_wait timeout, bits == 0x%x, test_bit == %s&bslash;n&quot;
comma
id|bits
comma
id|test_bit
ques
c_cond
l_string|&quot;yes&quot;
suffix:colon
l_string|&quot;no&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
DECL|function|carm_init_responses
r_static
r_void
id|carm_init_responses
c_func
(paren
r_struct
id|carm_host
op_star
id|host
)paren
(brace
r_void
id|__iomem
op_star
id|mmio
op_assign
id|host-&gt;mmio
suffix:semicolon
r_int
r_int
id|i
suffix:semicolon
r_struct
id|carm_response
op_star
id|resp
op_assign
(paren
r_struct
id|carm_response
op_star
)paren
id|host-&gt;shm
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RMSG_Q_LEN
suffix:semicolon
id|i
op_increment
)paren
id|resp
(braket
id|i
)braket
dot
id|status
op_assign
id|cpu_to_le32
c_func
(paren
l_int|0xffffffff
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|mmio
op_plus
id|CARM_RESP_IDX
)paren
suffix:semicolon
)brace
DECL|function|carm_init_host
r_static
r_int
id|carm_init_host
c_func
(paren
r_struct
id|carm_host
op_star
id|host
)paren
(brace
r_void
id|__iomem
op_star
id|mmio
op_assign
id|host-&gt;mmio
suffix:semicolon
id|u32
id|tmp
suffix:semicolon
id|u8
id|tmp8
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;ENTER&bslash;n&quot;
)paren
suffix:semicolon
id|writel
c_func
(paren
l_int|0
comma
id|mmio
op_plus
id|CARM_INT_MASK
)paren
suffix:semicolon
id|tmp8
op_assign
id|readb
c_func
(paren
id|mmio
op_plus
id|CARM_INITC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmp8
op_amp
l_int|0x01
)paren
(brace
id|tmp8
op_and_assign
op_complement
l_int|0x01
suffix:semicolon
id|writeb
c_func
(paren
id|tmp8
comma
id|mmio
op_plus
id|CARM_INITC
)paren
suffix:semicolon
id|readb
c_func
(paren
id|mmio
op_plus
id|CARM_INITC
)paren
suffix:semicolon
multiline_comment|/* flush */
id|DPRINTK
c_func
(paren
l_string|&quot;snooze...&bslash;n&quot;
)paren
suffix:semicolon
id|msleep
c_func
(paren
l_int|5000
)paren
suffix:semicolon
)brace
id|tmp
op_assign
id|readl
c_func
(paren
id|mmio
op_plus
id|CARM_HMUC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmp
op_amp
id|CARM_CME
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;CME bit present, waiting&bslash;n&quot;
)paren
suffix:semicolon
id|rc
op_assign
id|carm_init_wait
c_func
(paren
id|mmio
comma
id|CARM_CME
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;EXIT, carm_init_wait 1 failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|tmp
op_amp
id|CARM_RME
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;RME bit present, waiting&bslash;n&quot;
)paren
suffix:semicolon
id|rc
op_assign
id|carm_init_wait
c_func
(paren
id|mmio
comma
id|CARM_RME
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;EXIT, carm_init_wait 2 failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
)brace
id|tmp
op_and_assign
op_complement
(paren
id|CARM_RME
op_or
id|CARM_CME
)paren
suffix:semicolon
id|writel
c_func
(paren
id|tmp
comma
id|mmio
op_plus
id|CARM_HMUC
)paren
suffix:semicolon
id|readl
c_func
(paren
id|mmio
op_plus
id|CARM_HMUC
)paren
suffix:semicolon
multiline_comment|/* flush */
id|rc
op_assign
id|carm_init_wait
c_func
(paren
id|mmio
comma
id|CARM_RME
op_or
id|CARM_CME
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;EXIT, carm_init_wait 3 failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|carm_init_buckets
c_func
(paren
id|mmio
)paren
suffix:semicolon
id|writel
c_func
(paren
id|host-&gt;shm_dma
op_amp
l_int|0xffffffff
comma
id|mmio
op_plus
id|RBUF_ADDR_LO
)paren
suffix:semicolon
id|writel
c_func
(paren
(paren
id|host-&gt;shm_dma
op_rshift
l_int|16
)paren
op_rshift
l_int|16
comma
id|mmio
op_plus
id|RBUF_ADDR_HI
)paren
suffix:semicolon
id|writel
c_func
(paren
id|RBUF_LEN
comma
id|mmio
op_plus
id|RBUF_BYTE_SZ
)paren
suffix:semicolon
id|tmp
op_assign
id|readl
c_func
(paren
id|mmio
op_plus
id|CARM_HMUC
)paren
suffix:semicolon
id|tmp
op_or_assign
(paren
id|CARM_RME
op_or
id|CARM_CME
op_or
id|CARM_WZBC
)paren
suffix:semicolon
id|writel
c_func
(paren
id|tmp
comma
id|mmio
op_plus
id|CARM_HMUC
)paren
suffix:semicolon
id|readl
c_func
(paren
id|mmio
op_plus
id|CARM_HMUC
)paren
suffix:semicolon
multiline_comment|/* flush */
id|rc
op_assign
id|carm_init_wait
c_func
(paren
id|mmio
comma
id|CARM_RME
op_or
id|CARM_CME
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;EXIT, carm_init_wait 4 failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|writel
c_func
(paren
l_int|0
comma
id|mmio
op_plus
id|CARM_HMPHA
)paren
suffix:semicolon
id|writel
c_func
(paren
id|INT_DEF_MASK
comma
id|mmio
op_plus
id|CARM_INT_MASK
)paren
suffix:semicolon
id|carm_init_responses
c_func
(paren
id|host
)paren
suffix:semicolon
multiline_comment|/* start initialization, probing state machine */
id|spin_lock_irq
c_func
(paren
op_amp
id|host-&gt;lock
)paren
suffix:semicolon
m_assert
(paren
id|host-&gt;state
op_eq
id|HST_INVALID
)paren
suffix:semicolon
id|host-&gt;state
op_assign
id|HST_PROBE_START
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|host-&gt;lock
)paren
suffix:semicolon
id|schedule_work
c_func
(paren
op_amp
id|host-&gt;fsm_task
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;EXIT&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|carm_init_disks
r_static
r_int
id|carm_init_disks
c_func
(paren
r_struct
id|carm_host
op_star
id|host
)paren
(brace
r_int
r_int
id|i
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|CARM_MAX_PORTS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|gendisk
op_star
id|disk
suffix:semicolon
id|request_queue_t
op_star
id|q
suffix:semicolon
r_struct
id|carm_port
op_star
id|port
suffix:semicolon
id|port
op_assign
op_amp
id|host-&gt;port
(braket
id|i
)braket
suffix:semicolon
id|port-&gt;host
op_assign
id|host
suffix:semicolon
id|port-&gt;port_no
op_assign
id|i
suffix:semicolon
id|disk
op_assign
id|alloc_disk
c_func
(paren
id|CARM_MINORS_PER_MAJOR
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|disk
)paren
(brace
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_break
suffix:semicolon
)brace
id|port-&gt;disk
op_assign
id|disk
suffix:semicolon
id|sprintf
c_func
(paren
id|disk-&gt;disk_name
comma
id|DRV_NAME
l_string|&quot;/%u&quot;
comma
(paren
r_int
r_int
)paren
(paren
id|host-&gt;id
op_star
id|CARM_MAX_PORTS
)paren
op_plus
id|i
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|disk-&gt;devfs_name
comma
id|DRV_NAME
l_string|&quot;/%u_%u&quot;
comma
id|host-&gt;id
comma
id|i
)paren
suffix:semicolon
id|disk-&gt;major
op_assign
id|host-&gt;major
suffix:semicolon
id|disk-&gt;first_minor
op_assign
id|i
op_star
id|CARM_MINORS_PER_MAJOR
suffix:semicolon
id|disk-&gt;fops
op_assign
op_amp
id|carm_bd_ops
suffix:semicolon
id|disk-&gt;private_data
op_assign
id|port
suffix:semicolon
id|q
op_assign
id|blk_init_queue
c_func
(paren
id|carm_rq_fn
comma
op_amp
id|host-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|q
)paren
(brace
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_break
suffix:semicolon
)brace
id|disk-&gt;queue
op_assign
id|q
suffix:semicolon
id|blk_queue_max_hw_segments
c_func
(paren
id|q
comma
id|CARM_MAX_REQ_SG
)paren
suffix:semicolon
id|blk_queue_max_phys_segments
c_func
(paren
id|q
comma
id|CARM_MAX_REQ_SG
)paren
suffix:semicolon
id|blk_queue_segment_boundary
c_func
(paren
id|q
comma
id|CARM_SG_BOUNDARY
)paren
suffix:semicolon
id|q-&gt;queuedata
op_assign
id|port
suffix:semicolon
)brace
r_return
id|rc
suffix:semicolon
)brace
DECL|function|carm_free_disks
r_static
r_void
id|carm_free_disks
c_func
(paren
r_struct
id|carm_host
op_star
id|host
)paren
(brace
r_int
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|CARM_MAX_PORTS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|gendisk
op_star
id|disk
op_assign
id|host-&gt;port
(braket
id|i
)braket
dot
id|disk
suffix:semicolon
r_if
c_cond
(paren
id|disk
)paren
(brace
id|request_queue_t
op_star
id|q
op_assign
id|disk-&gt;queue
suffix:semicolon
r_if
c_cond
(paren
id|disk-&gt;flags
op_amp
id|GENHD_FL_UP
)paren
id|del_gendisk
c_func
(paren
id|disk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|q
)paren
id|blk_cleanup_queue
c_func
(paren
id|q
)paren
suffix:semicolon
id|put_disk
c_func
(paren
id|disk
)paren
suffix:semicolon
)brace
)brace
)brace
DECL|function|carm_init_shm
r_static
r_int
id|carm_init_shm
c_func
(paren
r_struct
id|carm_host
op_star
id|host
)paren
(brace
id|host-&gt;shm
op_assign
id|pci_alloc_consistent
c_func
(paren
id|host-&gt;pdev
comma
id|CARM_SHM_SIZE
comma
op_amp
id|host-&gt;shm_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|host-&gt;shm
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|host-&gt;msg_base
op_assign
id|host-&gt;shm
op_plus
id|RBUF_LEN
suffix:semicolon
id|host-&gt;msg_dma
op_assign
id|host-&gt;shm_dma
op_plus
id|RBUF_LEN
suffix:semicolon
id|memset
c_func
(paren
id|host-&gt;shm
comma
l_int|0xff
comma
id|RBUF_LEN
)paren
suffix:semicolon
id|memset
c_func
(paren
id|host-&gt;msg_base
comma
l_int|0
comma
id|PDC_SHM_SIZE
op_minus
id|RBUF_LEN
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|carm_init_one
r_static
r_int
id|carm_init_one
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_const
r_struct
id|pci_device_id
op_star
id|ent
)paren
(brace
r_static
r_int
r_int
id|printed_version
suffix:semicolon
r_struct
id|carm_host
op_star
id|host
suffix:semicolon
r_int
r_int
id|pci_dac
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|request_queue_t
op_star
id|q
suffix:semicolon
r_int
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|printed_version
op_increment
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
id|DRV_NAME
l_string|&quot; version &quot;
id|DRV_VERSION
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|rc
op_assign
id|pci_enable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
id|rc
op_assign
id|pci_request_regions
c_func
(paren
id|pdev
comma
id|DRV_NAME
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_goto
id|err_out
suffix:semicolon
macro_line|#if IF_64BIT_DMA_IS_POSSIBLE /* grrrr... */
id|rc
op_assign
id|pci_set_dma_mask
c_func
(paren
id|pdev
comma
l_int|0xffffffffffffffffULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rc
)paren
(brace
id|rc
op_assign
id|pci_set_consistent_dma_mask
c_func
(paren
id|pdev
comma
l_int|0xffffffffffffffffULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|DRV_NAME
l_string|&quot;(%s): consistent DMA mask failure&bslash;n&quot;
comma
id|pci_name
c_func
(paren
id|pdev
)paren
)paren
suffix:semicolon
r_goto
id|err_out_regions
suffix:semicolon
)brace
id|pci_dac
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
macro_line|#endif
id|rc
op_assign
id|pci_set_dma_mask
c_func
(paren
id|pdev
comma
l_int|0xffffffffULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|DRV_NAME
l_string|&quot;(%s): DMA mask failure&bslash;n&quot;
comma
id|pci_name
c_func
(paren
id|pdev
)paren
)paren
suffix:semicolon
r_goto
id|err_out_regions
suffix:semicolon
)brace
id|pci_dac
op_assign
l_int|0
suffix:semicolon
macro_line|#if IF_64BIT_DMA_IS_POSSIBLE /* grrrr... */
)brace
macro_line|#endif
id|host
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|host
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|host
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|DRV_NAME
l_string|&quot;(%s): memory alloc failure&bslash;n&quot;
comma
id|pci_name
c_func
(paren
id|pdev
)paren
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|err_out_regions
suffix:semicolon
)brace
id|memset
c_func
(paren
id|host
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|host
)paren
)paren
suffix:semicolon
id|host-&gt;pdev
op_assign
id|pdev
suffix:semicolon
id|host-&gt;flags
op_assign
id|pci_dac
ques
c_cond
id|FL_DAC
suffix:colon
l_int|0
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|host-&gt;lock
)paren
suffix:semicolon
id|INIT_WORK
c_func
(paren
op_amp
id|host-&gt;fsm_task
comma
id|carm_fsm_task
comma
id|host
)paren
suffix:semicolon
id|init_MUTEX_LOCKED
c_func
(paren
op_amp
id|host-&gt;probe_sem
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ARRAY_SIZE
c_func
(paren
id|host-&gt;req
)paren
suffix:semicolon
id|i
op_increment
)paren
id|host-&gt;req
(braket
id|i
)braket
dot
id|tag
op_assign
id|i
suffix:semicolon
id|host-&gt;mmio
op_assign
id|ioremap
c_func
(paren
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
comma
id|pci_resource_len
c_func
(paren
id|pdev
comma
l_int|0
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|host-&gt;mmio
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|DRV_NAME
l_string|&quot;(%s): MMIO alloc failure&bslash;n&quot;
comma
id|pci_name
c_func
(paren
id|pdev
)paren
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|err_out_kfree
suffix:semicolon
)brace
id|rc
op_assign
id|carm_init_shm
c_func
(paren
id|host
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|DRV_NAME
l_string|&quot;(%s): DMA SHM alloc failure&bslash;n&quot;
comma
id|pci_name
c_func
(paren
id|pdev
)paren
)paren
suffix:semicolon
r_goto
id|err_out_iounmap
suffix:semicolon
)brace
id|q
op_assign
id|blk_init_queue
c_func
(paren
id|carm_oob_rq_fn
comma
op_amp
id|host-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|q
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|DRV_NAME
l_string|&quot;(%s): OOB queue alloc failure&bslash;n&quot;
comma
id|pci_name
c_func
(paren
id|pdev
)paren
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|err_out_pci_free
suffix:semicolon
)brace
id|host-&gt;oob_q
op_assign
id|q
suffix:semicolon
id|q-&gt;queuedata
op_assign
id|host
suffix:semicolon
multiline_comment|/*&n;&t; * Figure out which major to use: 160, 161, or dynamic&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|test_and_set_bit
c_func
(paren
l_int|0
comma
op_amp
id|carm_major_alloc
)paren
)paren
id|host-&gt;major
op_assign
l_int|160
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|test_and_set_bit
c_func
(paren
l_int|1
comma
op_amp
id|carm_major_alloc
)paren
)paren
id|host-&gt;major
op_assign
l_int|161
suffix:semicolon
r_else
id|host-&gt;flags
op_or_assign
id|FL_DYN_MAJOR
suffix:semicolon
id|host-&gt;id
op_assign
id|carm_host_id
suffix:semicolon
id|sprintf
c_func
(paren
id|host-&gt;name
comma
id|DRV_NAME
l_string|&quot;%d&quot;
comma
id|carm_host_id
)paren
suffix:semicolon
id|rc
op_assign
id|register_blkdev
c_func
(paren
id|host-&gt;major
comma
id|host-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_goto
id|err_out_free_majors
suffix:semicolon
r_if
c_cond
(paren
id|host-&gt;flags
op_amp
id|FL_DYN_MAJOR
)paren
id|host-&gt;major
op_assign
id|rc
suffix:semicolon
id|devfs_mk_dir
c_func
(paren
id|DRV_NAME
)paren
suffix:semicolon
id|rc
op_assign
id|carm_init_disks
c_func
(paren
id|host
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_goto
id|err_out_blkdev_disks
suffix:semicolon
id|pci_set_master
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|rc
op_assign
id|request_irq
c_func
(paren
id|pdev-&gt;irq
comma
id|carm_interrupt
comma
id|SA_SHIRQ
comma
id|DRV_NAME
comma
id|host
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|DRV_NAME
l_string|&quot;(%s): irq alloc failure&bslash;n&quot;
comma
id|pci_name
c_func
(paren
id|pdev
)paren
)paren
suffix:semicolon
r_goto
id|err_out_blkdev_disks
suffix:semicolon
)brace
id|rc
op_assign
id|carm_init_host
c_func
(paren
id|host
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_goto
id|err_out_free_irq
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;waiting for probe_sem&bslash;n&quot;
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|host-&gt;probe_sem
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: pci %s, ports %d, io %lx, irq %u, major %d&bslash;n&quot;
comma
id|host-&gt;name
comma
id|pci_name
c_func
(paren
id|pdev
)paren
comma
(paren
r_int
)paren
id|CARM_MAX_PORTS
comma
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
comma
id|pdev-&gt;irq
comma
id|host-&gt;major
)paren
suffix:semicolon
id|carm_host_id
op_increment
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|pdev
comma
id|host
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|err_out_free_irq
suffix:colon
id|free_irq
c_func
(paren
id|pdev-&gt;irq
comma
id|host
)paren
suffix:semicolon
id|err_out_blkdev_disks
suffix:colon
id|carm_free_disks
c_func
(paren
id|host
)paren
suffix:semicolon
id|unregister_blkdev
c_func
(paren
id|host-&gt;major
comma
id|host-&gt;name
)paren
suffix:semicolon
id|err_out_free_majors
suffix:colon
r_if
c_cond
(paren
id|host-&gt;major
op_eq
l_int|160
)paren
id|clear_bit
c_func
(paren
l_int|0
comma
op_amp
id|carm_major_alloc
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|host-&gt;major
op_eq
l_int|161
)paren
id|clear_bit
c_func
(paren
l_int|1
comma
op_amp
id|carm_major_alloc
)paren
suffix:semicolon
id|blk_cleanup_queue
c_func
(paren
id|host-&gt;oob_q
)paren
suffix:semicolon
id|err_out_pci_free
suffix:colon
id|pci_free_consistent
c_func
(paren
id|pdev
comma
id|CARM_SHM_SIZE
comma
id|host-&gt;shm
comma
id|host-&gt;shm_dma
)paren
suffix:semicolon
id|err_out_iounmap
suffix:colon
id|iounmap
c_func
(paren
id|host-&gt;mmio
)paren
suffix:semicolon
id|err_out_kfree
suffix:colon
id|kfree
c_func
(paren
id|host
)paren
suffix:semicolon
id|err_out_regions
suffix:colon
id|pci_release_regions
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|err_out
suffix:colon
id|pci_disable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|carm_remove_one
r_static
r_void
id|carm_remove_one
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
r_struct
id|carm_host
op_star
id|host
op_assign
id|pci_get_drvdata
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|host
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|PFX
l_string|&quot;BUG: no host data for PCI(%s)&bslash;n&quot;
comma
id|pci_name
c_func
(paren
id|pdev
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|free_irq
c_func
(paren
id|pdev-&gt;irq
comma
id|host
)paren
suffix:semicolon
id|carm_free_disks
c_func
(paren
id|host
)paren
suffix:semicolon
id|devfs_remove
c_func
(paren
id|DRV_NAME
)paren
suffix:semicolon
id|unregister_blkdev
c_func
(paren
id|host-&gt;major
comma
id|host-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|host-&gt;major
op_eq
l_int|160
)paren
id|clear_bit
c_func
(paren
l_int|0
comma
op_amp
id|carm_major_alloc
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|host-&gt;major
op_eq
l_int|161
)paren
id|clear_bit
c_func
(paren
l_int|1
comma
op_amp
id|carm_major_alloc
)paren
suffix:semicolon
id|blk_cleanup_queue
c_func
(paren
id|host-&gt;oob_q
)paren
suffix:semicolon
id|pci_free_consistent
c_func
(paren
id|pdev
comma
id|CARM_SHM_SIZE
comma
id|host-&gt;shm
comma
id|host-&gt;shm_dma
)paren
suffix:semicolon
id|iounmap
c_func
(paren
id|host-&gt;mmio
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|host
)paren
suffix:semicolon
id|pci_release_regions
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|pci_disable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|pdev
comma
l_int|NULL
)paren
suffix:semicolon
)brace
DECL|function|carm_init
r_static
r_int
id|__init
id|carm_init
c_func
(paren
r_void
)paren
(brace
r_return
id|pci_module_init
c_func
(paren
op_amp
id|carm_driver
)paren
suffix:semicolon
)brace
DECL|function|carm_exit
r_static
r_void
id|__exit
id|carm_exit
c_func
(paren
r_void
)paren
(brace
id|pci_unregister_driver
c_func
(paren
op_amp
id|carm_driver
)paren
suffix:semicolon
)brace
DECL|variable|carm_init
id|module_init
c_func
(paren
id|carm_init
)paren
suffix:semicolon
DECL|variable|carm_exit
id|module_exit
c_func
(paren
id|carm_exit
)paren
suffix:semicolon
eof
