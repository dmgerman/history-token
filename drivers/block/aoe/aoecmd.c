multiline_comment|/* Copyright (c) 2004 Coraid, Inc.  See COPYING for GPL terms. */
multiline_comment|/*&n; * aoecmd.c&n; * Filesystem request handling methods&n; */
macro_line|#include &lt;linux/hdreg.h&gt;
macro_line|#include &lt;linux/blkdev.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &quot;aoe.h&quot;
DECL|macro|TIMERTICK
mdefine_line|#define TIMERTICK (HZ / 10)
DECL|macro|MINTIMER
mdefine_line|#define MINTIMER (2 * TIMERTICK)
DECL|macro|MAXTIMER
mdefine_line|#define MAXTIMER (HZ &lt;&lt; 1)
DECL|macro|MAXWAIT
mdefine_line|#define MAXWAIT (60 * 3)&t;/* After MAXWAIT seconds, give up and fail dev */
r_static
r_struct
id|sk_buff
op_star
DECL|function|new_skb
id|new_skb
c_func
(paren
r_struct
id|net_device
op_star
id|if_dev
comma
id|ulong
id|len
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|skb
op_assign
id|alloc_skb
c_func
(paren
id|len
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
)paren
(brace
id|skb-&gt;nh.raw
op_assign
id|skb-&gt;mac.raw
op_assign
id|skb-&gt;data
suffix:semicolon
id|skb-&gt;dev
op_assign
id|if_dev
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|__constant_htons
c_func
(paren
id|ETH_P_AOE
)paren
suffix:semicolon
id|skb-&gt;priority
op_assign
l_int|0
suffix:semicolon
id|skb_put
c_func
(paren
id|skb
comma
id|len
)paren
suffix:semicolon
id|skb-&gt;next
op_assign
id|skb-&gt;prev
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* tell the network layer not to perform IP checksums&n;&t;&t; * or to get the NIC to do it&n;&t;&t; */
id|skb-&gt;ip_summed
op_assign
id|CHECKSUM_NONE
suffix:semicolon
)brace
r_return
id|skb
suffix:semicolon
)brace
r_static
r_struct
id|sk_buff
op_star
DECL|function|skb_prepare
id|skb_prepare
c_func
(paren
r_struct
id|aoedev
op_star
id|d
comma
r_struct
id|frame
op_star
id|f
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_char
op_star
id|p
suffix:semicolon
id|skb
op_assign
id|new_skb
c_func
(paren
id|d-&gt;ifp
comma
id|f-&gt;ndata
op_plus
id|f-&gt;writedatalen
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;aoe: skb_prepare: failure to allocate skb&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|p
op_assign
id|skb-&gt;mac.raw
suffix:semicolon
id|memcpy
c_func
(paren
id|p
comma
id|f-&gt;data
comma
id|f-&gt;ndata
)paren
suffix:semicolon
r_if
c_cond
(paren
id|f-&gt;writedatalen
)paren
(brace
id|p
op_add_assign
r_sizeof
(paren
r_struct
id|aoe_hdr
)paren
op_plus
r_sizeof
(paren
r_struct
id|aoe_atahdr
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|p
comma
id|f-&gt;bufaddr
comma
id|f-&gt;writedatalen
)paren
suffix:semicolon
)brace
r_return
id|skb
suffix:semicolon
)brace
r_static
r_struct
id|frame
op_star
DECL|function|getframe
id|getframe
c_func
(paren
r_struct
id|aoedev
op_star
id|d
comma
r_int
id|tag
)paren
(brace
r_struct
id|frame
op_star
id|f
comma
op_star
id|e
suffix:semicolon
id|f
op_assign
id|d-&gt;frames
suffix:semicolon
id|e
op_assign
id|f
op_plus
id|d-&gt;nframes
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|f
OL
id|e
suffix:semicolon
id|f
op_increment
)paren
r_if
c_cond
(paren
id|f-&gt;tag
op_eq
id|tag
)paren
r_return
id|f
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; * Leave the top bit clear so we have tagspace for userland.&n; * The bottom 16 bits are the xmit tick for rexmit/rttavg processing.&n; * This driver reserves tag -1 to mean &quot;unused frame.&quot;&n; */
r_static
r_int
DECL|function|newtag
id|newtag
c_func
(paren
r_struct
id|aoedev
op_star
id|d
)paren
(brace
r_register
id|ulong
id|n
suffix:semicolon
id|n
op_assign
id|jiffies
op_amp
l_int|0xffff
suffix:semicolon
r_return
id|n
op_or_assign
(paren
op_increment
id|d-&gt;lasttag
op_amp
l_int|0x7fff
)paren
op_lshift
l_int|16
suffix:semicolon
)brace
r_static
r_int
DECL|function|aoehdr_atainit
id|aoehdr_atainit
c_func
(paren
r_struct
id|aoedev
op_star
id|d
comma
r_struct
id|aoe_hdr
op_star
id|h
)paren
(brace
id|u16
id|type
op_assign
id|__constant_cpu_to_be16
c_func
(paren
id|ETH_P_AOE
)paren
suffix:semicolon
id|u16
id|aoemajor
op_assign
id|__cpu_to_be16
c_func
(paren
id|d-&gt;aoemajor
)paren
suffix:semicolon
id|u32
id|host_tag
op_assign
id|newtag
c_func
(paren
id|d
)paren
suffix:semicolon
id|u32
id|tag
op_assign
id|__cpu_to_be32
c_func
(paren
id|host_tag
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|h-&gt;src
comma
id|d-&gt;ifp-&gt;dev_addr
comma
r_sizeof
id|h-&gt;src
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|h-&gt;dst
comma
id|d-&gt;addr
comma
r_sizeof
id|h-&gt;dst
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|h-&gt;type
comma
op_amp
id|type
comma
r_sizeof
id|type
)paren
suffix:semicolon
id|h-&gt;verfl
op_assign
id|AOE_HVER
suffix:semicolon
id|memcpy
c_func
(paren
id|h-&gt;major
comma
op_amp
id|aoemajor
comma
r_sizeof
id|aoemajor
)paren
suffix:semicolon
id|h-&gt;minor
op_assign
id|d-&gt;aoeminor
suffix:semicolon
id|h-&gt;cmd
op_assign
id|AOECMD_ATA
suffix:semicolon
id|memcpy
c_func
(paren
id|h-&gt;tag
comma
op_amp
id|tag
comma
r_sizeof
id|tag
)paren
suffix:semicolon
r_return
id|host_tag
suffix:semicolon
)brace
r_static
r_void
DECL|function|aoecmd_ata_rw
id|aoecmd_ata_rw
c_func
(paren
r_struct
id|aoedev
op_star
id|d
comma
r_struct
id|frame
op_star
id|f
)paren
(brace
r_struct
id|aoe_hdr
op_star
id|h
suffix:semicolon
r_struct
id|aoe_atahdr
op_star
id|ah
suffix:semicolon
r_struct
id|buf
op_star
id|buf
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|ulong
id|bcnt
suffix:semicolon
r_register
id|sector_t
id|sector
suffix:semicolon
r_char
id|writebit
comma
id|extbit
suffix:semicolon
id|writebit
op_assign
l_int|0x10
suffix:semicolon
id|extbit
op_assign
l_int|0x4
suffix:semicolon
id|buf
op_assign
id|d-&gt;inprocess
suffix:semicolon
id|sector
op_assign
id|buf-&gt;sector
suffix:semicolon
id|bcnt
op_assign
id|buf-&gt;bv_resid
suffix:semicolon
r_if
c_cond
(paren
id|bcnt
OG
id|MAXATADATA
)paren
id|bcnt
op_assign
id|MAXATADATA
suffix:semicolon
multiline_comment|/* initialize the headers &amp; frame */
id|h
op_assign
(paren
r_struct
id|aoe_hdr
op_star
)paren
id|f-&gt;data
suffix:semicolon
id|ah
op_assign
(paren
r_struct
id|aoe_atahdr
op_star
)paren
(paren
id|h
op_plus
l_int|1
)paren
suffix:semicolon
id|f-&gt;ndata
op_assign
r_sizeof
op_star
id|h
op_plus
r_sizeof
op_star
id|ah
suffix:semicolon
id|memset
c_func
(paren
id|h
comma
l_int|0
comma
id|f-&gt;ndata
)paren
suffix:semicolon
id|f-&gt;tag
op_assign
id|aoehdr_atainit
c_func
(paren
id|d
comma
id|h
)paren
suffix:semicolon
id|f-&gt;waited
op_assign
l_int|0
suffix:semicolon
id|f-&gt;buf
op_assign
id|buf
suffix:semicolon
id|f-&gt;bufaddr
op_assign
id|buf-&gt;bufaddr
suffix:semicolon
multiline_comment|/* set up ata header */
id|ah-&gt;scnt
op_assign
id|bcnt
op_rshift
l_int|9
suffix:semicolon
id|ah-&gt;lba0
op_assign
id|sector
suffix:semicolon
id|ah-&gt;lba1
op_assign
id|sector
op_rshift_assign
l_int|8
suffix:semicolon
id|ah-&gt;lba2
op_assign
id|sector
op_rshift_assign
l_int|8
suffix:semicolon
id|ah-&gt;lba3
op_assign
id|sector
op_rshift_assign
l_int|8
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;flags
op_amp
id|DEVFL_EXT
)paren
(brace
id|ah-&gt;aflags
op_or_assign
id|AOEAFL_EXT
suffix:semicolon
id|ah-&gt;lba4
op_assign
id|sector
op_rshift_assign
l_int|8
suffix:semicolon
id|ah-&gt;lba5
op_assign
id|sector
op_rshift_assign
l_int|8
suffix:semicolon
)brace
r_else
(brace
id|extbit
op_assign
l_int|0
suffix:semicolon
id|ah-&gt;lba3
op_and_assign
l_int|0x0f
suffix:semicolon
id|ah-&gt;lba3
op_or_assign
l_int|0xe0
suffix:semicolon
multiline_comment|/* LBA bit + obsolete 0xa0 */
)brace
r_if
c_cond
(paren
id|bio_data_dir
c_func
(paren
id|buf-&gt;bio
)paren
op_eq
id|WRITE
)paren
(brace
id|ah-&gt;aflags
op_or_assign
id|AOEAFL_WRITE
suffix:semicolon
id|f-&gt;writedatalen
op_assign
id|bcnt
suffix:semicolon
)brace
r_else
(brace
id|writebit
op_assign
l_int|0
suffix:semicolon
id|f-&gt;writedatalen
op_assign
l_int|0
suffix:semicolon
)brace
id|ah-&gt;cmdstat
op_assign
id|WIN_READ
op_or
id|writebit
op_or
id|extbit
suffix:semicolon
multiline_comment|/* mark all tracking fields and load out */
id|buf-&gt;nframesout
op_add_assign
l_int|1
suffix:semicolon
id|buf-&gt;bufaddr
op_add_assign
id|bcnt
suffix:semicolon
id|buf-&gt;bv_resid
op_sub_assign
id|bcnt
suffix:semicolon
multiline_comment|/* printk(KERN_INFO &quot;aoe: bv_resid=%ld&bslash;n&quot;, buf-&gt;bv_resid); */
id|buf-&gt;resid
op_sub_assign
id|bcnt
suffix:semicolon
id|buf-&gt;sector
op_add_assign
id|bcnt
op_rshift
l_int|9
suffix:semicolon
r_if
c_cond
(paren
id|buf-&gt;resid
op_eq
l_int|0
)paren
(brace
id|d-&gt;inprocess
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|buf-&gt;bv_resid
op_eq
l_int|0
)paren
(brace
id|buf-&gt;bv
op_increment
suffix:semicolon
id|buf-&gt;bv_resid
op_assign
id|buf-&gt;bv-&gt;bv_len
suffix:semicolon
id|buf-&gt;bufaddr
op_assign
id|page_address
c_func
(paren
id|buf-&gt;bv-&gt;bv_page
)paren
op_plus
id|buf-&gt;bv-&gt;bv_offset
suffix:semicolon
)brace
id|skb
op_assign
id|skb_prepare
c_func
(paren
id|d
comma
id|f
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
)paren
(brace
id|skb-&gt;next
op_assign
id|d-&gt;skblist
suffix:semicolon
id|d-&gt;skblist
op_assign
id|skb
suffix:semicolon
)brace
)brace
multiline_comment|/* enters with d-&gt;lock held */
r_void
DECL|function|aoecmd_work
id|aoecmd_work
c_func
(paren
r_struct
id|aoedev
op_star
id|d
)paren
(brace
r_struct
id|frame
op_star
id|f
suffix:semicolon
r_struct
id|buf
op_star
id|buf
suffix:semicolon
id|loop
suffix:colon
id|f
op_assign
id|getframe
c_func
(paren
id|d
comma
id|FREETAG
)paren
suffix:semicolon
r_if
c_cond
(paren
id|f
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;inprocess
op_eq
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|list_empty
c_func
(paren
op_amp
id|d-&gt;bufq
)paren
)paren
r_return
suffix:semicolon
id|buf
op_assign
id|container_of
c_func
(paren
id|d-&gt;bufq.next
comma
r_struct
id|buf
comma
id|bufs
)paren
suffix:semicolon
id|list_del
c_func
(paren
id|d-&gt;bufq.next
)paren
suffix:semicolon
multiline_comment|/*printk(KERN_INFO &quot;aoecmd_work: bi_size=%ld&bslash;n&quot;, buf-&gt;bio-&gt;bi_size); */
id|d-&gt;inprocess
op_assign
id|buf
suffix:semicolon
)brace
id|aoecmd_ata_rw
c_func
(paren
id|d
comma
id|f
)paren
suffix:semicolon
r_goto
id|loop
suffix:semicolon
)brace
r_static
r_void
DECL|function|rexmit
id|rexmit
c_func
(paren
r_struct
id|aoedev
op_star
id|d
comma
r_struct
id|frame
op_star
id|f
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_struct
id|aoe_hdr
op_star
id|h
suffix:semicolon
r_char
id|buf
(braket
l_int|128
)braket
suffix:semicolon
id|u32
id|n
suffix:semicolon
id|u32
id|net_tag
suffix:semicolon
id|n
op_assign
id|newtag
c_func
(paren
id|d
)paren
suffix:semicolon
id|snprintf
c_func
(paren
id|buf
comma
r_sizeof
id|buf
comma
l_string|&quot;%15s e%ld.%ld oldtag=%08x@%08lx newtag=%08x&bslash;n&quot;
comma
l_string|&quot;retransmit&quot;
comma
id|d-&gt;aoemajor
comma
id|d-&gt;aoeminor
comma
id|f-&gt;tag
comma
id|jiffies
comma
id|n
)paren
suffix:semicolon
id|aoechr_error
c_func
(paren
id|buf
)paren
suffix:semicolon
id|h
op_assign
(paren
r_struct
id|aoe_hdr
op_star
)paren
id|f-&gt;data
suffix:semicolon
id|f-&gt;tag
op_assign
id|n
suffix:semicolon
id|net_tag
op_assign
id|__cpu_to_be32
c_func
(paren
id|n
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|h-&gt;tag
comma
op_amp
id|net_tag
comma
r_sizeof
id|net_tag
)paren
suffix:semicolon
id|skb
op_assign
id|skb_prepare
c_func
(paren
id|d
comma
id|f
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
)paren
(brace
id|skb-&gt;next
op_assign
id|d-&gt;skblist
suffix:semicolon
id|d-&gt;skblist
op_assign
id|skb
suffix:semicolon
)brace
)brace
r_static
r_int
DECL|function|tsince
id|tsince
c_func
(paren
r_int
id|tag
)paren
(brace
r_int
id|n
suffix:semicolon
id|n
op_assign
id|jiffies
op_amp
l_int|0xffff
suffix:semicolon
id|n
op_sub_assign
id|tag
op_amp
l_int|0xffff
suffix:semicolon
r_if
c_cond
(paren
id|n
OL
l_int|0
)paren
id|n
op_add_assign
l_int|1
op_lshift
l_int|16
suffix:semicolon
r_return
id|n
suffix:semicolon
)brace
r_static
r_void
DECL|function|rexmit_timer
id|rexmit_timer
c_func
(paren
id|ulong
id|vp
)paren
(brace
r_struct
id|aoedev
op_star
id|d
suffix:semicolon
r_struct
id|frame
op_star
id|f
comma
op_star
id|e
suffix:semicolon
r_struct
id|sk_buff
op_star
id|sl
suffix:semicolon
r_register
r_int
id|timeout
suffix:semicolon
id|ulong
id|flags
comma
id|n
suffix:semicolon
id|d
op_assign
(paren
r_struct
id|aoedev
op_star
)paren
id|vp
suffix:semicolon
id|sl
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* timeout is always ~150% of the moving average */
id|timeout
op_assign
id|d-&gt;rttavg
suffix:semicolon
id|timeout
op_add_assign
id|timeout
op_rshift
l_int|1
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|d-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;flags
op_amp
id|DEVFL_TKILL
)paren
(brace
id|tdie
suffix:colon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|d-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|f
op_assign
id|d-&gt;frames
suffix:semicolon
id|e
op_assign
id|f
op_plus
id|d-&gt;nframes
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|f
OL
id|e
suffix:semicolon
id|f
op_increment
)paren
(brace
r_if
c_cond
(paren
id|f-&gt;tag
op_ne
id|FREETAG
op_logical_and
id|tsince
c_func
(paren
id|f-&gt;tag
)paren
op_ge
id|timeout
)paren
(brace
id|n
op_assign
id|f-&gt;waited
op_add_assign
id|timeout
suffix:semicolon
id|n
op_div_assign
id|HZ
suffix:semicolon
r_if
c_cond
(paren
id|n
OG
id|MAXWAIT
)paren
(brace
multiline_comment|/* waited too long.  device failure. */
id|aoedev_downdev
c_func
(paren
id|d
)paren
suffix:semicolon
r_goto
id|tdie
suffix:semicolon
)brace
id|rexmit
c_func
(paren
id|d
comma
id|f
)paren
suffix:semicolon
)brace
)brace
id|sl
op_assign
id|d-&gt;skblist
suffix:semicolon
id|d-&gt;skblist
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|sl
)paren
(brace
id|n
op_assign
id|d-&gt;rttavg
op_lshift_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|n
OG
id|MAXTIMER
)paren
id|d-&gt;rttavg
op_assign
id|MAXTIMER
suffix:semicolon
)brace
id|d-&gt;timer.expires
op_assign
id|jiffies
op_plus
id|TIMERTICK
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|d-&gt;timer
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|d-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|aoenet_xmit
c_func
(paren
id|sl
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|ataid_complete
id|ataid_complete
c_func
(paren
r_struct
id|aoedev
op_star
id|d
comma
r_int
r_char
op_star
id|id
)paren
(brace
id|u64
id|ssize
suffix:semicolon
id|u16
id|n
suffix:semicolon
multiline_comment|/* word 83: command set supported */
id|n
op_assign
id|__le16_to_cpu
c_func
(paren
op_star
(paren
(paren
id|u16
op_star
)paren
op_amp
id|id
(braket
l_int|83
op_lshift
l_int|1
)braket
)paren
)paren
suffix:semicolon
multiline_comment|/* word 86: command set/feature enabled */
id|n
op_or_assign
id|__le16_to_cpu
c_func
(paren
op_star
(paren
(paren
id|u16
op_star
)paren
op_amp
id|id
(braket
l_int|86
op_lshift
l_int|1
)braket
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|n
op_amp
(paren
l_int|1
op_lshift
l_int|10
)paren
)paren
(brace
multiline_comment|/* bit 10: LBA 48 */
id|d-&gt;flags
op_or_assign
id|DEVFL_EXT
suffix:semicolon
multiline_comment|/* word 100: number lba48 sectors */
id|ssize
op_assign
id|__le64_to_cpu
c_func
(paren
op_star
(paren
(paren
id|u64
op_star
)paren
op_amp
id|id
(braket
l_int|100
op_lshift
l_int|1
)braket
)paren
)paren
suffix:semicolon
multiline_comment|/* set as in ide-disk.c:init_idedisk_capacity */
id|d-&gt;geo.cylinders
op_assign
id|ssize
suffix:semicolon
id|d-&gt;geo.cylinders
op_div_assign
(paren
l_int|255
op_star
l_int|63
)paren
suffix:semicolon
id|d-&gt;geo.heads
op_assign
l_int|255
suffix:semicolon
id|d-&gt;geo.sectors
op_assign
l_int|63
suffix:semicolon
)brace
r_else
(brace
id|d-&gt;flags
op_and_assign
op_complement
id|DEVFL_EXT
suffix:semicolon
multiline_comment|/* number lba28 sectors */
id|ssize
op_assign
id|__le32_to_cpu
c_func
(paren
op_star
(paren
(paren
id|u32
op_star
)paren
op_amp
id|id
(braket
l_int|60
op_lshift
l_int|1
)braket
)paren
)paren
suffix:semicolon
multiline_comment|/* NOTE: obsolete in ATA 6 */
id|d-&gt;geo.cylinders
op_assign
id|__le16_to_cpu
c_func
(paren
op_star
(paren
(paren
id|u16
op_star
)paren
op_amp
id|id
(braket
l_int|54
op_lshift
l_int|1
)braket
)paren
)paren
suffix:semicolon
id|d-&gt;geo.heads
op_assign
id|__le16_to_cpu
c_func
(paren
op_star
(paren
(paren
id|u16
op_star
)paren
op_amp
id|id
(braket
l_int|55
op_lshift
l_int|1
)braket
)paren
)paren
suffix:semicolon
id|d-&gt;geo.sectors
op_assign
id|__le16_to_cpu
c_func
(paren
op_star
(paren
(paren
id|u16
op_star
)paren
op_amp
id|id
(braket
l_int|56
op_lshift
l_int|1
)braket
)paren
)paren
suffix:semicolon
)brace
id|d-&gt;ssize
op_assign
id|ssize
suffix:semicolon
id|d-&gt;geo.start
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;gd
op_ne
l_int|NULL
)paren
(brace
id|d-&gt;gd-&gt;capacity
op_assign
id|ssize
suffix:semicolon
id|d-&gt;flags
op_or_assign
id|DEVFL_UP
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|d-&gt;flags
op_amp
id|DEVFL_WORKON
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;aoe: ataid_complete: can&squot;t schedule work, it&squot;s already on!  &quot;
l_string|&quot;(This really shouldn&squot;t happen).&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|INIT_WORK
c_func
(paren
op_amp
id|d-&gt;work
comma
id|aoeblk_gdalloc
comma
id|d
)paren
suffix:semicolon
id|schedule_work
c_func
(paren
op_amp
id|d-&gt;work
)paren
suffix:semicolon
id|d-&gt;flags
op_or_assign
id|DEVFL_WORKON
suffix:semicolon
)brace
r_static
r_void
DECL|function|calc_rttavg
id|calc_rttavg
c_func
(paren
r_struct
id|aoedev
op_star
id|d
comma
r_int
id|rtt
)paren
(brace
r_register
r_int
id|n
suffix:semicolon
id|n
op_assign
id|rtt
suffix:semicolon
r_if
c_cond
(paren
id|n
OL
id|MINTIMER
)paren
id|n
op_assign
id|MINTIMER
suffix:semicolon
r_else
r_if
c_cond
(paren
id|n
OG
id|MAXTIMER
)paren
id|n
op_assign
id|MAXTIMER
suffix:semicolon
multiline_comment|/* g == .25; cf. Congestion Avoidance and Control, Jacobson &amp; Karels; 1988 */
id|n
op_sub_assign
id|d-&gt;rttavg
suffix:semicolon
id|d-&gt;rttavg
op_add_assign
id|n
op_rshift
l_int|2
suffix:semicolon
)brace
r_void
DECL|function|aoecmd_ata_rsp
id|aoecmd_ata_rsp
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|aoedev
op_star
id|d
suffix:semicolon
r_struct
id|aoe_hdr
op_star
id|hin
suffix:semicolon
r_struct
id|aoe_atahdr
op_star
id|ahin
comma
op_star
id|ahout
suffix:semicolon
r_struct
id|frame
op_star
id|f
suffix:semicolon
r_struct
id|buf
op_star
id|buf
suffix:semicolon
r_struct
id|sk_buff
op_star
id|sl
suffix:semicolon
r_register
r_int
id|n
suffix:semicolon
id|ulong
id|flags
suffix:semicolon
r_char
id|ebuf
(braket
l_int|128
)braket
suffix:semicolon
id|hin
op_assign
(paren
r_struct
id|aoe_hdr
op_star
)paren
id|skb-&gt;mac.raw
suffix:semicolon
id|d
op_assign
id|aoedev_bymac
c_func
(paren
id|hin-&gt;src
)paren
suffix:semicolon
r_if
c_cond
(paren
id|d
op_eq
l_int|NULL
)paren
(brace
id|snprintf
c_func
(paren
id|ebuf
comma
r_sizeof
id|ebuf
comma
l_string|&quot;aoecmd_ata_rsp: ata response &quot;
l_string|&quot;for unknown device %d.%d&bslash;n&quot;
comma
id|__be16_to_cpu
c_func
(paren
op_star
(paren
(paren
id|u16
op_star
)paren
id|hin-&gt;major
)paren
)paren
comma
id|hin-&gt;minor
)paren
suffix:semicolon
id|aoechr_error
c_func
(paren
id|ebuf
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|d-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|f
op_assign
id|getframe
c_func
(paren
id|d
comma
id|__be32_to_cpu
c_func
(paren
op_star
(paren
(paren
id|u32
op_star
)paren
id|hin-&gt;tag
)paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|f
op_eq
l_int|NULL
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|d-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|snprintf
c_func
(paren
id|ebuf
comma
r_sizeof
id|ebuf
comma
l_string|&quot;%15s e%d.%d    tag=%08x@%08lx&bslash;n&quot;
comma
l_string|&quot;unexpected rsp&quot;
comma
id|__be16_to_cpu
c_func
(paren
op_star
(paren
(paren
id|u16
op_star
)paren
id|hin-&gt;major
)paren
)paren
comma
id|hin-&gt;minor
comma
id|__be32_to_cpu
c_func
(paren
op_star
(paren
(paren
id|u32
op_star
)paren
id|hin-&gt;tag
)paren
)paren
comma
id|jiffies
)paren
suffix:semicolon
id|aoechr_error
c_func
(paren
id|ebuf
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|calc_rttavg
c_func
(paren
id|d
comma
id|tsince
c_func
(paren
id|f-&gt;tag
)paren
)paren
suffix:semicolon
id|ahin
op_assign
(paren
r_struct
id|aoe_atahdr
op_star
)paren
(paren
id|hin
op_plus
l_int|1
)paren
suffix:semicolon
id|ahout
op_assign
(paren
r_struct
id|aoe_atahdr
op_star
)paren
(paren
id|f-&gt;data
op_plus
r_sizeof
(paren
r_struct
id|aoe_hdr
)paren
)paren
suffix:semicolon
id|buf
op_assign
id|f-&gt;buf
suffix:semicolon
r_if
c_cond
(paren
id|ahin-&gt;cmdstat
op_amp
l_int|0xa9
)paren
(brace
multiline_comment|/* these bits cleared on success */
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;aoe: aoecmd_ata_rsp: ata error cmd=%2.2Xh &quot;
l_string|&quot;stat=%2.2Xh&bslash;n&quot;
comma
id|ahout-&gt;cmdstat
comma
id|ahin-&gt;cmdstat
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buf
)paren
id|buf-&gt;flags
op_or_assign
id|BUFFL_FAIL
suffix:semicolon
)brace
r_else
(brace
r_switch
c_cond
(paren
id|ahout-&gt;cmdstat
)paren
(brace
r_case
id|WIN_READ
suffix:colon
r_case
id|WIN_READ_EXT
suffix:colon
id|n
op_assign
id|ahout-&gt;scnt
op_lshift
l_int|9
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;len
op_minus
r_sizeof
op_star
id|hin
op_minus
r_sizeof
op_star
id|ahin
OL
id|n
)paren
(brace
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;aoe: aoecmd_ata_rsp: runt &quot;
l_string|&quot;ata data size in read.  skb-&gt;len=%d&bslash;n&quot;
comma
id|skb-&gt;len
)paren
suffix:semicolon
multiline_comment|/* fail frame f?  just returning will rexmit. */
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|d-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|f-&gt;bufaddr
comma
id|ahin
op_plus
l_int|1
comma
id|n
)paren
suffix:semicolon
r_case
id|WIN_WRITE
suffix:colon
r_case
id|WIN_WRITE_EXT
suffix:colon
r_break
suffix:semicolon
r_case
id|WIN_IDENTIFY
suffix:colon
r_if
c_cond
(paren
id|skb-&gt;len
op_minus
r_sizeof
op_star
id|hin
op_minus
r_sizeof
op_star
id|ahin
OL
l_int|512
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;aoe: aoecmd_ata_rsp: runt data size &quot;
l_string|&quot;in ataid.  skb-&gt;len=%d&bslash;n&quot;
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|d-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|ataid_complete
c_func
(paren
id|d
comma
(paren
r_char
op_star
)paren
(paren
id|ahin
op_plus
l_int|1
)paren
)paren
suffix:semicolon
multiline_comment|/* d-&gt;flags |= DEVFL_WC_UPDATE; */
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;aoe: aoecmd_ata_rsp: unrecognized &quot;
l_string|&quot;outbound ata command %2.2Xh for %d.%d&bslash;n&quot;
comma
id|ahout-&gt;cmdstat
comma
id|__be16_to_cpu
c_func
(paren
op_star
(paren
(paren
id|u16
op_star
)paren
id|hin-&gt;major
)paren
)paren
comma
id|hin-&gt;minor
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|buf
)paren
(brace
id|buf-&gt;nframesout
op_sub_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|buf-&gt;nframesout
op_eq
l_int|0
op_logical_and
id|buf-&gt;resid
op_eq
l_int|0
)paren
(brace
id|n
op_assign
op_logical_neg
(paren
id|buf-&gt;flags
op_amp
id|BUFFL_FAIL
)paren
suffix:semicolon
id|bio_endio
c_func
(paren
id|buf-&gt;bio
comma
id|buf-&gt;bio-&gt;bi_size
comma
l_int|0
)paren
suffix:semicolon
id|mempool_free
c_func
(paren
id|buf
comma
id|d-&gt;bufpool
)paren
suffix:semicolon
)brace
)brace
id|f-&gt;buf
op_assign
l_int|NULL
suffix:semicolon
id|f-&gt;tag
op_assign
id|FREETAG
suffix:semicolon
id|aoecmd_work
c_func
(paren
id|d
)paren
suffix:semicolon
id|sl
op_assign
id|d-&gt;skblist
suffix:semicolon
id|d-&gt;skblist
op_assign
l_int|NULL
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|d-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|aoenet_xmit
c_func
(paren
id|sl
)paren
suffix:semicolon
)brace
r_void
DECL|function|aoecmd_cfg
id|aoecmd_cfg
c_func
(paren
id|ushort
id|aoemajor
comma
r_int
r_char
id|aoeminor
)paren
(brace
r_struct
id|aoe_hdr
op_star
id|h
suffix:semicolon
r_struct
id|aoe_cfghdr
op_star
id|ch
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
comma
op_star
id|sl
suffix:semicolon
r_struct
id|net_device
op_star
id|ifp
suffix:semicolon
id|u16
id|aoe_type
op_assign
id|__constant_cpu_to_be16
c_func
(paren
id|ETH_P_AOE
)paren
suffix:semicolon
id|u16
id|net_aoemajor
op_assign
id|__cpu_to_be16
c_func
(paren
id|aoemajor
)paren
suffix:semicolon
id|sl
op_assign
l_int|NULL
suffix:semicolon
id|read_lock
c_func
(paren
op_amp
id|dev_base_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|ifp
op_assign
id|dev_base
suffix:semicolon
id|ifp
suffix:semicolon
id|dev_put
c_func
(paren
id|ifp
)paren
comma
id|ifp
op_assign
id|ifp-&gt;next
)paren
(brace
id|dev_hold
c_func
(paren
id|ifp
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|is_aoe_netif
c_func
(paren
id|ifp
)paren
)paren
r_continue
suffix:semicolon
id|skb
op_assign
id|new_skb
c_func
(paren
id|ifp
comma
r_sizeof
op_star
id|h
op_plus
r_sizeof
op_star
id|ch
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;aoe: aoecmd_cfg: skb alloc failure&bslash;n&quot;
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|h
op_assign
(paren
r_struct
id|aoe_hdr
op_star
)paren
id|skb-&gt;mac.raw
suffix:semicolon
id|memset
c_func
(paren
id|h
comma
l_int|0
comma
r_sizeof
op_star
id|h
op_plus
r_sizeof
op_star
id|ch
)paren
suffix:semicolon
id|memset
c_func
(paren
id|h-&gt;dst
comma
l_int|0xff
comma
r_sizeof
id|h-&gt;dst
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|h-&gt;src
comma
id|ifp-&gt;dev_addr
comma
r_sizeof
id|h-&gt;src
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|h-&gt;type
comma
op_amp
id|aoe_type
comma
r_sizeof
id|aoe_type
)paren
suffix:semicolon
id|h-&gt;verfl
op_assign
id|AOE_HVER
suffix:semicolon
id|memcpy
c_func
(paren
id|h-&gt;major
comma
op_amp
id|net_aoemajor
comma
r_sizeof
id|net_aoemajor
)paren
suffix:semicolon
id|h-&gt;minor
op_assign
id|aoeminor
suffix:semicolon
id|h-&gt;cmd
op_assign
id|AOECMD_CFG
suffix:semicolon
id|skb-&gt;next
op_assign
id|sl
suffix:semicolon
id|sl
op_assign
id|skb
suffix:semicolon
)brace
id|read_unlock
c_func
(paren
op_amp
id|dev_base_lock
)paren
suffix:semicolon
id|aoenet_xmit
c_func
(paren
id|sl
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Since we only call this in one place (and it only prepares one frame)&n; * we just return the skb.  Usually we&squot;d chain it up to the d-&gt;skblist.&n; */
r_static
r_struct
id|sk_buff
op_star
DECL|function|aoecmd_ata_id
id|aoecmd_ata_id
c_func
(paren
r_struct
id|aoedev
op_star
id|d
)paren
(brace
r_struct
id|aoe_hdr
op_star
id|h
suffix:semicolon
r_struct
id|aoe_atahdr
op_star
id|ah
suffix:semicolon
r_struct
id|frame
op_star
id|f
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|f
op_assign
id|getframe
c_func
(paren
id|d
comma
id|FREETAG
)paren
suffix:semicolon
r_if
c_cond
(paren
id|f
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;aoe: aoecmd_ata_id: can&squot;t get a frame.  &quot;
l_string|&quot;This shouldn&squot;t happen.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* initialize the headers &amp; frame */
id|h
op_assign
(paren
r_struct
id|aoe_hdr
op_star
)paren
id|f-&gt;data
suffix:semicolon
id|ah
op_assign
(paren
r_struct
id|aoe_atahdr
op_star
)paren
(paren
id|h
op_plus
l_int|1
)paren
suffix:semicolon
id|f-&gt;ndata
op_assign
r_sizeof
op_star
id|h
op_plus
r_sizeof
op_star
id|ah
suffix:semicolon
id|memset
c_func
(paren
id|h
comma
l_int|0
comma
id|f-&gt;ndata
)paren
suffix:semicolon
id|f-&gt;tag
op_assign
id|aoehdr_atainit
c_func
(paren
id|d
comma
id|h
)paren
suffix:semicolon
id|f-&gt;waited
op_assign
l_int|0
suffix:semicolon
id|f-&gt;writedatalen
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* this message initializes the device, so we reset the rttavg */
id|d-&gt;rttavg
op_assign
id|MAXTIMER
suffix:semicolon
multiline_comment|/* set up ata header */
id|ah-&gt;scnt
op_assign
l_int|1
suffix:semicolon
id|ah-&gt;cmdstat
op_assign
id|WIN_IDENTIFY
suffix:semicolon
id|ah-&gt;lba3
op_assign
l_int|0xa0
suffix:semicolon
id|skb
op_assign
id|skb_prepare
c_func
(paren
id|d
comma
id|f
)paren
suffix:semicolon
multiline_comment|/* we now want to start the rexmit tracking */
id|d-&gt;flags
op_and_assign
op_complement
id|DEVFL_TKILL
suffix:semicolon
id|d-&gt;timer.data
op_assign
(paren
id|ulong
)paren
id|d
suffix:semicolon
id|d-&gt;timer.function
op_assign
id|rexmit_timer
suffix:semicolon
id|d-&gt;timer.expires
op_assign
id|jiffies
op_plus
id|TIMERTICK
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|d-&gt;timer
)paren
suffix:semicolon
r_return
id|skb
suffix:semicolon
)brace
r_void
DECL|function|aoecmd_cfg_rsp
id|aoecmd_cfg_rsp
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|aoedev
op_star
id|d
suffix:semicolon
r_struct
id|aoe_hdr
op_star
id|h
suffix:semicolon
r_struct
id|aoe_cfghdr
op_star
id|ch
suffix:semicolon
id|ulong
id|flags
comma
id|bufcnt
comma
id|sysminor
comma
id|aoemajor
suffix:semicolon
r_struct
id|sk_buff
op_star
id|sl
suffix:semicolon
r_enum
(brace
id|MAXFRAMES
op_assign
l_int|8
comma
id|MAXSYSMINOR
op_assign
l_int|255
)brace
suffix:semicolon
id|h
op_assign
(paren
r_struct
id|aoe_hdr
op_star
)paren
id|skb-&gt;mac.raw
suffix:semicolon
id|ch
op_assign
(paren
r_struct
id|aoe_cfghdr
op_star
)paren
(paren
id|h
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Enough people have their dip switches set backwards to&n;&t; * warrant a loud message for this special case.&n;&t; */
id|aoemajor
op_assign
id|__be16_to_cpu
c_func
(paren
op_star
(paren
(paren
id|u16
op_star
)paren
id|h-&gt;major
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|aoemajor
op_eq
l_int|0xfff
)paren
(brace
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;aoe: aoecmd_cfg_rsp: Warning: shelf &quot;
l_string|&quot;address is all ones.  Check shelf dip switches&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|sysminor
op_assign
id|SYSMINOR
c_func
(paren
id|aoemajor
comma
id|h-&gt;minor
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sysminor
OG
id|MAXSYSMINOR
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;aoe: aoecmd_cfg_rsp: sysminor %ld too &quot;
l_string|&quot;large&bslash;n&quot;
comma
id|sysminor
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|bufcnt
op_assign
id|__be16_to_cpu
c_func
(paren
op_star
(paren
(paren
id|u16
op_star
)paren
id|ch-&gt;bufcnt
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bufcnt
OG
id|MAXFRAMES
)paren
multiline_comment|/* keep it reasonable */
id|bufcnt
op_assign
id|MAXFRAMES
suffix:semicolon
id|d
op_assign
id|aoedev_set
c_func
(paren
id|sysminor
comma
id|h-&gt;src
comma
id|skb-&gt;dev
comma
id|bufcnt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|d
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;aoe: aoecmd_cfg_rsp: device set failure&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|d-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;flags
op_amp
(paren
id|DEVFL_UP
op_or
id|DEVFL_CLOSEWAIT
)paren
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|d-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|d-&gt;fw_ver
op_assign
id|__be16_to_cpu
c_func
(paren
op_star
(paren
(paren
id|u16
op_star
)paren
id|ch-&gt;fwver
)paren
)paren
suffix:semicolon
multiline_comment|/* we get here only if the device is new */
id|sl
op_assign
id|aoecmd_ata_id
c_func
(paren
id|d
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|d-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|aoenet_xmit
c_func
(paren
id|sl
)paren
suffix:semicolon
)brace
eof
