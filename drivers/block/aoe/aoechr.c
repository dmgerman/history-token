multiline_comment|/* Copyright (c) 2004 Coraid, Inc.  See COPYING for GPL terms. */
multiline_comment|/*&n; * aoechr.c&n; * AoE character device driver&n; */
macro_line|#include &lt;linux/hdreg.h&gt;
macro_line|#include &lt;linux/blkdev.h&gt;
macro_line|#include &quot;aoe.h&quot;
r_enum
(brace
singleline_comment|//MINOR_STAT = 1, (moved to sysfs)
DECL|enumerator|MINOR_ERR
id|MINOR_ERR
op_assign
l_int|2
comma
DECL|enumerator|MINOR_DISCOVER
id|MINOR_DISCOVER
comma
DECL|enumerator|MINOR_INTERFACES
id|MINOR_INTERFACES
comma
DECL|enumerator|MSGSZ
id|MSGSZ
op_assign
l_int|2048
comma
DECL|enumerator|NARGS
id|NARGS
op_assign
l_int|10
comma
DECL|enumerator|NMSG
id|NMSG
op_assign
l_int|100
comma
multiline_comment|/* message backlog to retain */
)brace
suffix:semicolon
DECL|struct|aoe_chardev
r_struct
id|aoe_chardev
(brace
DECL|member|minor
id|ulong
id|minor
suffix:semicolon
DECL|member|name
r_char
id|name
(braket
l_int|32
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|enumerator|EMFL_VALID
r_enum
(brace
id|EMFL_VALID
op_assign
l_int|1
)brace
suffix:semicolon
DECL|struct|ErrMsg
r_struct
id|ErrMsg
(brace
DECL|member|flags
r_int
id|flags
suffix:semicolon
DECL|member|len
r_int
id|len
suffix:semicolon
DECL|member|msg
r_char
op_star
id|msg
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|emsgs
r_static
r_struct
id|ErrMsg
id|emsgs
(braket
id|NMSG
)braket
suffix:semicolon
DECL|variable|emsgs_head_idx
DECL|variable|emsgs_tail_idx
r_static
r_int
id|emsgs_head_idx
comma
id|emsgs_tail_idx
suffix:semicolon
DECL|variable|emsgs_sema
r_static
r_struct
id|semaphore
id|emsgs_sema
suffix:semicolon
DECL|variable|emsgs_lock
r_static
id|spinlock_t
id|emsgs_lock
suffix:semicolon
DECL|variable|nblocked_emsgs_readers
r_static
r_int
id|nblocked_emsgs_readers
suffix:semicolon
DECL|variable|aoe_class
r_static
r_struct
id|class_simple
op_star
id|aoe_class
suffix:semicolon
DECL|variable|chardevs
r_static
r_struct
id|aoe_chardev
id|chardevs
(braket
)braket
op_assign
(brace
(brace
id|MINOR_ERR
comma
l_string|&quot;err&quot;
)brace
comma
(brace
id|MINOR_DISCOVER
comma
l_string|&quot;discover&quot;
)brace
comma
(brace
id|MINOR_INTERFACES
comma
l_string|&quot;interfaces&quot;
)brace
comma
)brace
suffix:semicolon
r_static
r_int
DECL|function|discover
id|discover
c_func
(paren
r_void
)paren
(brace
id|aoecmd_cfg
c_func
(paren
l_int|0xffff
comma
l_int|0xff
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|interfaces
id|interfaces
c_func
(paren
r_const
r_char
id|__user
op_star
id|str
comma
r_int
id|size
)paren
(brace
r_if
c_cond
(paren
id|set_aoe_iflist
c_func
(paren
id|str
comma
id|size
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;%s: could not set interface list: %s&bslash;n&quot;
comma
id|__FUNCTION__
comma
l_string|&quot;too many interfaces&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_void
DECL|function|aoechr_error
id|aoechr_error
c_func
(paren
r_char
op_star
id|msg
)paren
(brace
r_struct
id|ErrMsg
op_star
id|em
suffix:semicolon
r_char
op_star
id|mp
suffix:semicolon
id|ulong
id|flags
comma
id|n
suffix:semicolon
id|n
op_assign
id|strlen
c_func
(paren
id|msg
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|emsgs_lock
comma
id|flags
)paren
suffix:semicolon
id|em
op_assign
id|emsgs
op_plus
id|emsgs_tail_idx
suffix:semicolon
r_if
c_cond
(paren
(paren
id|em-&gt;flags
op_amp
id|EMFL_VALID
)paren
)paren
(brace
id|bail
suffix:colon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|emsgs_lock
comma
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|mp
op_assign
id|kmalloc
c_func
(paren
id|n
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mp
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;aoe: aoechr_error: allocation failure, len=%ld&bslash;n&quot;
comma
id|n
)paren
suffix:semicolon
r_goto
id|bail
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|mp
comma
id|msg
comma
id|n
)paren
suffix:semicolon
id|em-&gt;msg
op_assign
id|mp
suffix:semicolon
id|em-&gt;flags
op_or_assign
id|EMFL_VALID
suffix:semicolon
id|em-&gt;len
op_assign
id|n
suffix:semicolon
id|emsgs_tail_idx
op_increment
suffix:semicolon
id|emsgs_tail_idx
op_mod_assign
id|ARRAY_SIZE
c_func
(paren
id|emsgs
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|emsgs_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|nblocked_emsgs_readers
)paren
id|up
c_func
(paren
op_amp
id|emsgs_sema
)paren
suffix:semicolon
)brace
DECL|macro|PERLINE
mdefine_line|#define PERLINE 16
r_void
DECL|function|aoechr_hdump
id|aoechr_hdump
c_func
(paren
r_char
op_star
id|buf
comma
r_int
id|n
)paren
(brace
r_int
id|bufsiz
suffix:semicolon
r_char
op_star
id|fbuf
suffix:semicolon
r_int
id|linelen
suffix:semicolon
r_char
op_star
id|p
comma
op_star
id|e
comma
op_star
id|fp
suffix:semicolon
id|bufsiz
op_assign
id|n
op_star
l_int|3
suffix:semicolon
multiline_comment|/* 2 hex digits and a space */
id|bufsiz
op_add_assign
id|n
op_div
id|PERLINE
op_plus
l_int|1
suffix:semicolon
multiline_comment|/* the newline characters */
id|bufsiz
op_add_assign
l_int|1
suffix:semicolon
multiline_comment|/* the final &squot;&bslash;0&squot; */
id|fbuf
op_assign
id|kmalloc
c_func
(paren
id|bufsiz
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fbuf
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: cannot allocate memory&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_for
c_loop
(paren
id|p
op_assign
id|buf
suffix:semicolon
id|n
op_le
l_int|0
suffix:semicolon
)paren
(brace
id|linelen
op_assign
id|n
OG
id|PERLINE
ques
c_cond
id|PERLINE
suffix:colon
id|n
suffix:semicolon
id|n
op_sub_assign
id|linelen
suffix:semicolon
id|fp
op_assign
id|fbuf
suffix:semicolon
r_for
c_loop
(paren
id|e
op_assign
id|p
op_plus
id|linelen
suffix:semicolon
id|p
OL
id|e
suffix:semicolon
id|p
op_increment
)paren
id|fp
op_add_assign
id|sprintf
c_func
(paren
id|fp
comma
l_string|&quot;%2.2X &quot;
comma
op_star
id|p
op_amp
l_int|255
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|fp
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|aoechr_error
c_func
(paren
id|fbuf
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|fbuf
)paren
suffix:semicolon
)brace
r_static
id|ssize_t
DECL|function|aoechr_write
id|aoechr_write
c_func
(paren
r_struct
id|file
op_star
id|filp
comma
r_const
r_char
id|__user
op_star
id|buf
comma
r_int
id|cnt
comma
id|loff_t
op_star
id|offp
)paren
(brace
r_int
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_switch
c_cond
(paren
(paren
r_int
r_int
)paren
id|filp-&gt;private_data
)paren
(brace
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;aoe: aoechr_write: can&squot;t write to that file.&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MINOR_DISCOVER
suffix:colon
id|ret
op_assign
id|discover
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MINOR_INTERFACES
suffix:colon
id|ret
op_assign
id|interfaces
c_func
(paren
id|buf
comma
id|cnt
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ret
op_eq
l_int|0
)paren
id|ret
op_assign
id|cnt
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
r_static
r_int
DECL|function|aoechr_open
id|aoechr_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_int
id|n
comma
id|i
suffix:semicolon
id|n
op_assign
id|MINOR
c_func
(paren
id|inode-&gt;i_rdev
)paren
suffix:semicolon
id|filp-&gt;private_data
op_assign
(paren
r_void
op_star
)paren
(paren
r_int
r_int
)paren
id|n
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ARRAY_SIZE
c_func
(paren
id|chardevs
)paren
suffix:semicolon
op_increment
id|i
)paren
r_if
c_cond
(paren
id|chardevs
(braket
id|i
)braket
dot
id|minor
op_eq
id|n
)paren
r_return
l_int|0
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_static
r_int
DECL|function|aoechr_rel
id|aoechr_rel
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
id|ssize_t
DECL|function|aoechr_read
id|aoechr_read
c_func
(paren
r_struct
id|file
op_star
id|filp
comma
r_char
id|__user
op_star
id|buf
comma
r_int
id|cnt
comma
id|loff_t
op_star
id|off
)paren
(brace
r_int
id|n
suffix:semicolon
r_char
op_star
id|mp
suffix:semicolon
r_struct
id|ErrMsg
op_star
id|em
suffix:semicolon
id|ssize_t
id|len
suffix:semicolon
id|ulong
id|flags
suffix:semicolon
id|n
op_assign
(paren
r_int
)paren
id|filp-&gt;private_data
suffix:semicolon
r_switch
c_cond
(paren
id|n
)paren
(brace
r_case
id|MINOR_ERR
suffix:colon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|emsgs_lock
comma
id|flags
)paren
suffix:semicolon
id|loop
suffix:colon
id|em
op_assign
id|emsgs
op_plus
id|emsgs_head_idx
suffix:semicolon
r_if
c_cond
(paren
(paren
id|em-&gt;flags
op_amp
id|EMFL_VALID
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|filp-&gt;f_flags
op_amp
id|O_NDELAY
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|emsgs_lock
comma
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|nblocked_emsgs_readers
op_increment
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|emsgs_lock
comma
id|flags
)paren
suffix:semicolon
id|n
op_assign
id|down_interruptible
c_func
(paren
op_amp
id|emsgs_sema
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|emsgs_lock
comma
id|flags
)paren
suffix:semicolon
id|nblocked_emsgs_readers
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|n
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|emsgs_lock
comma
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|ERESTARTSYS
suffix:semicolon
)brace
r_goto
id|loop
suffix:semicolon
)brace
r_if
c_cond
(paren
id|em-&gt;len
OG
id|cnt
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|emsgs_lock
comma
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|mp
op_assign
id|em-&gt;msg
suffix:semicolon
id|len
op_assign
id|em-&gt;len
suffix:semicolon
id|em-&gt;msg
op_assign
l_int|NULL
suffix:semicolon
id|em-&gt;flags
op_and_assign
op_complement
id|EMFL_VALID
suffix:semicolon
id|emsgs_head_idx
op_increment
suffix:semicolon
id|emsgs_head_idx
op_mod_assign
id|ARRAY_SIZE
c_func
(paren
id|emsgs
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|emsgs_lock
comma
id|flags
)paren
suffix:semicolon
id|n
op_assign
id|copy_to_user
c_func
(paren
id|buf
comma
id|mp
comma
id|len
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|mp
)paren
suffix:semicolon
r_return
id|n
op_eq
l_int|0
ques
c_cond
id|len
suffix:colon
op_minus
id|EFAULT
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
)brace
DECL|variable|aoe_fops
r_struct
id|file_operations
id|aoe_fops
op_assign
(brace
dot
id|write
op_assign
id|aoechr_write
comma
dot
id|read
op_assign
id|aoechr_read
comma
dot
id|open
op_assign
id|aoechr_open
comma
dot
id|release
op_assign
id|aoechr_rel
comma
dot
id|owner
op_assign
id|THIS_MODULE
comma
)brace
suffix:semicolon
r_int
id|__init
DECL|function|aoechr_init
id|aoechr_init
c_func
(paren
r_void
)paren
(brace
r_int
id|n
comma
id|i
suffix:semicolon
id|n
op_assign
id|register_chrdev
c_func
(paren
id|AOE_MAJOR
comma
l_string|&quot;aoechr&quot;
comma
op_amp
id|aoe_fops
)paren
suffix:semicolon
r_if
c_cond
(paren
id|n
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;aoe: aoechr_init: can&squot;t register char device&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|n
suffix:semicolon
)brace
id|sema_init
c_func
(paren
op_amp
id|emsgs_sema
comma
l_int|0
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|emsgs_lock
)paren
suffix:semicolon
id|aoe_class
op_assign
id|class_simple_create
c_func
(paren
id|THIS_MODULE
comma
l_string|&quot;aoe&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|aoe_class
)paren
)paren
(brace
id|unregister_chrdev
c_func
(paren
id|AOE_MAJOR
comma
l_string|&quot;aoechr&quot;
)paren
suffix:semicolon
r_return
id|PTR_ERR
c_func
(paren
id|aoe_class
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ARRAY_SIZE
c_func
(paren
id|chardevs
)paren
suffix:semicolon
op_increment
id|i
)paren
id|class_simple_device_add
c_func
(paren
id|aoe_class
comma
id|MKDEV
c_func
(paren
id|AOE_MAJOR
comma
id|chardevs
(braket
id|i
)braket
dot
id|minor
)paren
comma
l_int|NULL
comma
id|chardevs
(braket
id|i
)braket
dot
id|name
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_void
id|__exit
DECL|function|aoechr_exit
id|aoechr_exit
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ARRAY_SIZE
c_func
(paren
id|chardevs
)paren
suffix:semicolon
op_increment
id|i
)paren
id|class_simple_device_remove
c_func
(paren
id|MKDEV
c_func
(paren
id|AOE_MAJOR
comma
id|chardevs
(braket
id|i
)braket
dot
id|minor
)paren
)paren
suffix:semicolon
id|class_simple_destroy
c_func
(paren
id|aoe_class
)paren
suffix:semicolon
id|unregister_chrdev
c_func
(paren
id|AOE_MAJOR
comma
l_string|&quot;aoechr&quot;
)paren
suffix:semicolon
)brace
eof
