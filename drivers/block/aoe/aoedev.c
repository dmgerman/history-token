multiline_comment|/* Copyright (c) 2004 Coraid, Inc.  See COPYING for GPL terms. */
multiline_comment|/*&n; * aoedev.c&n; * AoE device utility functions; maintains device list.&n; */
macro_line|#include &lt;linux/hdreg.h&gt;
macro_line|#include &lt;linux/blkdev.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &quot;aoe.h&quot;
DECL|variable|devlist
r_static
r_struct
id|aoedev
op_star
id|devlist
suffix:semicolon
DECL|variable|devlist_lock
r_static
id|spinlock_t
id|devlist_lock
suffix:semicolon
r_struct
id|aoedev
op_star
DECL|function|aoedev_bymac
id|aoedev_bymac
c_func
(paren
r_int
r_char
op_star
id|macaddr
)paren
(brace
r_struct
id|aoedev
op_star
id|d
suffix:semicolon
id|ulong
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|devlist_lock
comma
id|flags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|d
op_assign
id|devlist
suffix:semicolon
id|d
suffix:semicolon
id|d
op_assign
id|d-&gt;next
)paren
r_if
c_cond
(paren
op_logical_neg
id|memcmp
c_func
(paren
id|d-&gt;addr
comma
id|macaddr
comma
l_int|6
)paren
)paren
r_break
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|devlist_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|d
suffix:semicolon
)brace
multiline_comment|/* called with devlist lock held */
r_static
r_struct
id|aoedev
op_star
DECL|function|aoedev_newdev
id|aoedev_newdev
c_func
(paren
id|ulong
id|nframes
)paren
(brace
r_struct
id|aoedev
op_star
id|d
suffix:semicolon
r_struct
id|frame
op_star
id|f
comma
op_star
id|e
suffix:semicolon
id|d
op_assign
id|kcalloc
c_func
(paren
l_int|1
comma
r_sizeof
op_star
id|d
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|d
op_eq
l_int|NULL
)paren
r_return
l_int|NULL
suffix:semicolon
id|f
op_assign
id|kcalloc
c_func
(paren
id|nframes
comma
r_sizeof
op_star
id|f
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|f
op_eq
l_int|NULL
)paren
(brace
id|kfree
c_func
(paren
id|d
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|d-&gt;nframes
op_assign
id|nframes
suffix:semicolon
id|d-&gt;frames
op_assign
id|f
suffix:semicolon
id|e
op_assign
id|f
op_plus
id|nframes
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|f
OL
id|e
suffix:semicolon
id|f
op_increment
)paren
id|f-&gt;tag
op_assign
id|FREETAG
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|d-&gt;lock
)paren
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|d-&gt;timer
)paren
suffix:semicolon
id|d-&gt;bufpool
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* defer to aoeblk_gdalloc */
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|d-&gt;bufq
)paren
suffix:semicolon
id|d-&gt;next
op_assign
id|devlist
suffix:semicolon
id|devlist
op_assign
id|d
suffix:semicolon
r_return
id|d
suffix:semicolon
)brace
r_void
DECL|function|aoedev_downdev
id|aoedev_downdev
c_func
(paren
r_struct
id|aoedev
op_star
id|d
)paren
(brace
r_struct
id|frame
op_star
id|f
comma
op_star
id|e
suffix:semicolon
r_struct
id|buf
op_star
id|buf
suffix:semicolon
r_struct
id|bio
op_star
id|bio
suffix:semicolon
id|d-&gt;flags
op_or_assign
id|DEVFL_TKILL
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|d-&gt;timer
)paren
suffix:semicolon
id|f
op_assign
id|d-&gt;frames
suffix:semicolon
id|e
op_assign
id|f
op_plus
id|d-&gt;nframes
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|f
OL
id|e
suffix:semicolon
id|f-&gt;tag
op_assign
id|FREETAG
comma
id|f-&gt;buf
op_assign
l_int|NULL
comma
id|f
op_increment
)paren
(brace
r_if
c_cond
(paren
id|f-&gt;tag
op_eq
id|FREETAG
op_logical_or
id|f-&gt;buf
op_eq
l_int|NULL
)paren
r_continue
suffix:semicolon
id|buf
op_assign
id|f-&gt;buf
suffix:semicolon
id|bio
op_assign
id|buf-&gt;bio
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|buf-&gt;nframesout
op_eq
l_int|0
)paren
(brace
id|mempool_free
c_func
(paren
id|buf
comma
id|d-&gt;bufpool
)paren
suffix:semicolon
id|bio_endio
c_func
(paren
id|bio
comma
id|bio-&gt;bi_size
comma
op_minus
id|EIO
)paren
suffix:semicolon
)brace
)brace
id|d-&gt;inprocess
op_assign
l_int|NULL
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|d-&gt;bufq
)paren
)paren
(brace
id|buf
op_assign
id|container_of
c_func
(paren
id|d-&gt;bufq.next
comma
r_struct
id|buf
comma
id|bufs
)paren
suffix:semicolon
id|list_del
c_func
(paren
id|d-&gt;bufq.next
)paren
suffix:semicolon
id|bio
op_assign
id|buf-&gt;bio
suffix:semicolon
id|mempool_free
c_func
(paren
id|buf
comma
id|d-&gt;bufpool
)paren
suffix:semicolon
id|bio_endio
c_func
(paren
id|bio
comma
id|bio-&gt;bi_size
comma
op_minus
id|EIO
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|d-&gt;nopen
)paren
id|d-&gt;flags
op_or_assign
id|DEVFL_CLOSEWAIT
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;gd
)paren
id|d-&gt;gd-&gt;capacity
op_assign
l_int|0
suffix:semicolon
id|d-&gt;flags
op_and_assign
op_complement
id|DEVFL_UP
suffix:semicolon
)brace
r_struct
id|aoedev
op_star
DECL|function|aoedev_set
id|aoedev_set
c_func
(paren
id|ulong
id|sysminor
comma
r_int
r_char
op_star
id|addr
comma
r_struct
id|net_device
op_star
id|ifp
comma
id|ulong
id|bufcnt
)paren
(brace
r_struct
id|aoedev
op_star
id|d
suffix:semicolon
id|ulong
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|devlist_lock
comma
id|flags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|d
op_assign
id|devlist
suffix:semicolon
id|d
suffix:semicolon
id|d
op_assign
id|d-&gt;next
)paren
r_if
c_cond
(paren
id|d-&gt;sysminor
op_eq
id|sysminor
op_logical_or
id|memcmp
c_func
(paren
id|d-&gt;addr
comma
id|addr
comma
r_sizeof
id|d-&gt;addr
)paren
op_eq
l_int|0
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|d
op_eq
l_int|NULL
op_logical_and
(paren
id|d
op_assign
id|aoedev_newdev
c_func
(paren
id|bufcnt
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|devlist_lock
comma
id|flags
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;aoe: aoedev_set: aoedev_newdev failure.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|devlist_lock
comma
id|flags
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|d-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|d-&gt;ifp
op_assign
id|ifp
suffix:semicolon
r_if
c_cond
(paren
id|d-&gt;sysminor
op_ne
id|sysminor
op_logical_or
id|memcmp
c_func
(paren
id|d-&gt;addr
comma
id|addr
comma
r_sizeof
id|d-&gt;addr
)paren
op_logical_or
(paren
id|d-&gt;flags
op_amp
id|DEVFL_UP
)paren
op_eq
l_int|0
)paren
(brace
id|aoedev_downdev
c_func
(paren
id|d
)paren
suffix:semicolon
multiline_comment|/* flushes outstanding frames */
id|memcpy
c_func
(paren
id|d-&gt;addr
comma
id|addr
comma
r_sizeof
id|d-&gt;addr
)paren
suffix:semicolon
id|d-&gt;sysminor
op_assign
id|sysminor
suffix:semicolon
id|d-&gt;aoemajor
op_assign
id|AOEMAJOR
c_func
(paren
id|sysminor
)paren
suffix:semicolon
id|d-&gt;aoeminor
op_assign
id|AOEMINOR
c_func
(paren
id|sysminor
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|d-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|d
suffix:semicolon
)brace
r_static
r_void
DECL|function|aoedev_freedev
id|aoedev_freedev
c_func
(paren
r_struct
id|aoedev
op_star
id|d
)paren
(brace
r_if
c_cond
(paren
id|d-&gt;gd
)paren
(brace
id|aoedisk_rm_sysfs
c_func
(paren
id|d
)paren
suffix:semicolon
id|del_gendisk
c_func
(paren
id|d-&gt;gd
)paren
suffix:semicolon
id|put_disk
c_func
(paren
id|d-&gt;gd
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|d-&gt;frames
)paren
suffix:semicolon
id|mempool_destroy
c_func
(paren
id|d-&gt;bufpool
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|d
)paren
suffix:semicolon
)brace
r_void
id|__exit
DECL|function|aoedev_exit
id|aoedev_exit
c_func
(paren
r_void
)paren
(brace
r_struct
id|aoedev
op_star
id|d
suffix:semicolon
id|ulong
id|flags
suffix:semicolon
id|flush_scheduled_work
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|d
op_assign
id|devlist
)paren
)paren
(brace
id|devlist
op_assign
id|d-&gt;next
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|d-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|aoedev_downdev
c_func
(paren
id|d
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|d-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|del_timer_sync
c_func
(paren
op_amp
id|d-&gt;timer
)paren
suffix:semicolon
id|aoedev_freedev
c_func
(paren
id|d
)paren
suffix:semicolon
)brace
)brace
r_int
id|__init
DECL|function|aoedev_init
id|aoedev_init
c_func
(paren
r_void
)paren
(brace
id|spin_lock_init
c_func
(paren
op_amp
id|devlist_lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
eof
