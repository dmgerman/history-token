multiline_comment|/* $Id: bbc_envctrl.c,v 1.4 2001/04/06 16:48:08 davem Exp $&n; * bbc_envctrl.c: UltraSPARC-III environment control driver.&n; *&n; * Copyright (C) 2001 David S. Miller (davem@redhat.com)&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;asm/oplib.h&gt;
macro_line|#include &lt;asm/ebus.h&gt;
DECL|macro|__KERNEL_SYSCALLS__
mdefine_line|#define __KERNEL_SYSCALLS__
DECL|variable|errno
r_static
r_int
id|errno
suffix:semicolon
macro_line|#include &lt;asm/unistd.h&gt;
macro_line|#include &quot;bbc_i2c.h&quot;
macro_line|#include &quot;max1617.h&quot;
DECL|macro|ENVCTRL_TRACE
macro_line|#undef ENVCTRL_TRACE
multiline_comment|/* WARNING: Making changes to this driver is very dangerous.&n; *          If you misprogram the sensor chips they can&n; *          cut the power on you instantly.&n; */
multiline_comment|/* Two temperature sensors exist in the SunBLADE-1000 enclosure.&n; * Both are implemented using max1617 i2c devices.  Each max1617&n; * monitors 2 temperatures, one for one of the cpu dies and the other&n; * for the ambient temperature.&n; *&n; * The max1617 is capable of being programmed with power-off&n; * temperature values, one low limit and one high limit.  These&n; * can be controlled independently for the cpu or ambient temperature.&n; * If a limit is violated, the power is simply shut off.  The frequency&n; * with which the max1617 does temperature sampling can be controlled&n; * as well.&n; *&n; * Three fans exist inside the machine, all three are controlled with&n; * an i2c digital to analog converter.  There is a fan directed at the&n; * two processor slots, another for the rest of the enclosure, and the&n; * third is for the power supply.  The first two fans may be speed&n; * controlled by changing the voltage fed to them.  The third fan may&n; * only be completely off or on.  The third fan is meant to only be&n; * disabled/enabled when entering/exiting the lowest power-saving&n; * mode of the machine.&n; *&n; * An environmental control kernel thread periodically monitors all&n; * temperature sensors.  Based upon the samples it will adjust the&n; * fan speeds to try and keep the system within a certain temperature&n; * range (the goal being to make the fans as quiet as possible without&n; * allowing the system to get too hot).&n; *&n; * If the temperature begins to rise/fall outside of the acceptable&n; * operating range, a periodic warning will be sent to the kernel log.&n; * The fans will be put on full blast to attempt to deal with this&n; * situation.  After exceeding the acceptable operating range by a&n; * certain threshold, the kernel thread will shut down the system.&n; * Here, the thread is attempting to shut the machine down cleanly&n; * before the hardware based power-off event is triggered.&n; */
multiline_comment|/* These settings are in celcius.  We use these defaults only&n; * if we cannot interrogate the cpu-fru SEEPROM.&n; */
DECL|struct|temp_limits
r_struct
id|temp_limits
(brace
DECL|member|high_pwroff
DECL|member|high_shutdown
DECL|member|high_warn
id|s8
id|high_pwroff
comma
id|high_shutdown
comma
id|high_warn
suffix:semicolon
DECL|member|low_warn
DECL|member|low_shutdown
DECL|member|low_pwroff
id|s8
id|low_warn
comma
id|low_shutdown
comma
id|low_pwroff
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|cpu_temp_limits
r_static
r_struct
id|temp_limits
id|cpu_temp_limits
(braket
l_int|2
)braket
op_assign
(brace
(brace
l_int|100
comma
l_int|85
comma
l_int|80
comma
l_int|5
comma
op_minus
l_int|5
comma
op_minus
l_int|10
)brace
comma
(brace
l_int|100
comma
l_int|85
comma
l_int|80
comma
l_int|5
comma
op_minus
l_int|5
comma
op_minus
l_int|10
)brace
comma
)brace
suffix:semicolon
DECL|variable|amb_temp_limits
r_static
r_struct
id|temp_limits
id|amb_temp_limits
(braket
l_int|2
)braket
op_assign
(brace
(brace
l_int|65
comma
l_int|55
comma
l_int|40
comma
l_int|5
comma
op_minus
l_int|5
comma
op_minus
l_int|10
)brace
comma
(brace
l_int|65
comma
l_int|55
comma
l_int|40
comma
l_int|5
comma
op_minus
l_int|5
comma
op_minus
l_int|10
)brace
comma
)brace
suffix:semicolon
DECL|enum|fan_action
DECL|enumerator|FAN_SLOWER
DECL|enumerator|FAN_SAME
DECL|enumerator|FAN_FASTER
DECL|enumerator|FAN_FULLBLAST
DECL|enumerator|FAN_STATE_MAX
r_enum
id|fan_action
(brace
id|FAN_SLOWER
comma
id|FAN_SAME
comma
id|FAN_FASTER
comma
id|FAN_FULLBLAST
comma
id|FAN_STATE_MAX
)brace
suffix:semicolon
DECL|struct|bbc_cpu_temperature
r_struct
id|bbc_cpu_temperature
(brace
DECL|member|next
r_struct
id|bbc_cpu_temperature
op_star
id|next
suffix:semicolon
DECL|member|client
r_struct
id|bbc_i2c_client
op_star
id|client
suffix:semicolon
DECL|member|index
r_int
id|index
suffix:semicolon
multiline_comment|/* Current readings, and history. */
DECL|member|curr_cpu_temp
id|s8
id|curr_cpu_temp
suffix:semicolon
DECL|member|curr_amb_temp
id|s8
id|curr_amb_temp
suffix:semicolon
DECL|member|prev_cpu_temp
id|s8
id|prev_cpu_temp
suffix:semicolon
DECL|member|prev_amb_temp
id|s8
id|prev_amb_temp
suffix:semicolon
DECL|member|avg_cpu_temp
id|s8
id|avg_cpu_temp
suffix:semicolon
DECL|member|avg_amb_temp
id|s8
id|avg_amb_temp
suffix:semicolon
DECL|member|sample_tick
r_int
id|sample_tick
suffix:semicolon
DECL|member|fan_todo
r_enum
id|fan_action
id|fan_todo
(braket
l_int|2
)braket
suffix:semicolon
DECL|macro|FAN_AMBIENT
mdefine_line|#define FAN_AMBIENT&t;0
DECL|macro|FAN_CPU
mdefine_line|#define FAN_CPU&t;&t;1
)brace
suffix:semicolon
DECL|variable|all_bbc_temps
r_struct
id|bbc_cpu_temperature
op_star
id|all_bbc_temps
suffix:semicolon
DECL|struct|bbc_fan_control
r_struct
id|bbc_fan_control
(brace
DECL|member|next
r_struct
id|bbc_fan_control
op_star
id|next
suffix:semicolon
DECL|member|client
r_struct
id|bbc_i2c_client
op_star
id|client
suffix:semicolon
DECL|member|index
r_int
id|index
suffix:semicolon
DECL|member|psupply_fan_on
r_int
id|psupply_fan_on
suffix:semicolon
DECL|member|cpu_fan_speed
r_int
id|cpu_fan_speed
suffix:semicolon
DECL|member|system_fan_speed
r_int
id|system_fan_speed
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|all_bbc_fans
r_struct
id|bbc_fan_control
op_star
id|all_bbc_fans
suffix:semicolon
DECL|macro|CPU_FAN_REG
mdefine_line|#define CPU_FAN_REG&t;0xf0
DECL|macro|SYS_FAN_REG
mdefine_line|#define SYS_FAN_REG&t;0xf2
DECL|macro|PSUPPLY_FAN_REG
mdefine_line|#define PSUPPLY_FAN_REG&t;0xf4
DECL|macro|FAN_SPEED_MIN
mdefine_line|#define FAN_SPEED_MIN&t;0x0c
DECL|macro|FAN_SPEED_MAX
mdefine_line|#define FAN_SPEED_MAX&t;0x3f
DECL|macro|PSUPPLY_FAN_ON
mdefine_line|#define PSUPPLY_FAN_ON&t;0x1f
DECL|macro|PSUPPLY_FAN_OFF
mdefine_line|#define PSUPPLY_FAN_OFF&t;0x00
DECL|function|set_fan_speeds
r_static
r_void
id|set_fan_speeds
c_func
(paren
r_struct
id|bbc_fan_control
op_star
id|fp
)paren
(brace
multiline_comment|/* Put temperatures into range so we don&squot;t mis-program&n;&t; * the hardware.&n;&t; */
r_if
c_cond
(paren
id|fp-&gt;cpu_fan_speed
OL
id|FAN_SPEED_MIN
)paren
id|fp-&gt;cpu_fan_speed
op_assign
id|FAN_SPEED_MIN
suffix:semicolon
r_if
c_cond
(paren
id|fp-&gt;cpu_fan_speed
OG
id|FAN_SPEED_MAX
)paren
id|fp-&gt;cpu_fan_speed
op_assign
id|FAN_SPEED_MAX
suffix:semicolon
r_if
c_cond
(paren
id|fp-&gt;system_fan_speed
OL
id|FAN_SPEED_MIN
)paren
id|fp-&gt;system_fan_speed
op_assign
id|FAN_SPEED_MIN
suffix:semicolon
r_if
c_cond
(paren
id|fp-&gt;system_fan_speed
OG
id|FAN_SPEED_MAX
)paren
id|fp-&gt;system_fan_speed
op_assign
id|FAN_SPEED_MAX
suffix:semicolon
macro_line|#ifdef ENVCTRL_TRACE
id|printk
c_func
(paren
l_string|&quot;fan%d: Changed fan speed to cpu(%02x) sys(%02x)&bslash;n&quot;
comma
id|fp-&gt;index
comma
id|fp-&gt;cpu_fan_speed
comma
id|fp-&gt;system_fan_speed
)paren
suffix:semicolon
macro_line|#endif
id|bbc_i2c_writeb
c_func
(paren
id|fp-&gt;client
comma
id|fp-&gt;cpu_fan_speed
comma
id|CPU_FAN_REG
)paren
suffix:semicolon
id|bbc_i2c_writeb
c_func
(paren
id|fp-&gt;client
comma
id|fp-&gt;system_fan_speed
comma
id|SYS_FAN_REG
)paren
suffix:semicolon
id|bbc_i2c_writeb
c_func
(paren
id|fp-&gt;client
comma
(paren
id|fp-&gt;psupply_fan_on
ques
c_cond
id|PSUPPLY_FAN_ON
suffix:colon
id|PSUPPLY_FAN_OFF
)paren
comma
id|PSUPPLY_FAN_REG
)paren
suffix:semicolon
)brace
DECL|function|get_current_temps
r_static
r_void
id|get_current_temps
c_func
(paren
r_struct
id|bbc_cpu_temperature
op_star
id|tp
)paren
(brace
id|tp-&gt;prev_amb_temp
op_assign
id|tp-&gt;curr_amb_temp
suffix:semicolon
id|bbc_i2c_readb
c_func
(paren
id|tp-&gt;client
comma
(paren
r_int
r_char
op_star
)paren
op_amp
id|tp-&gt;curr_amb_temp
comma
id|MAX1617_AMB_TEMP
)paren
suffix:semicolon
id|tp-&gt;prev_cpu_temp
op_assign
id|tp-&gt;curr_cpu_temp
suffix:semicolon
id|bbc_i2c_readb
c_func
(paren
id|tp-&gt;client
comma
(paren
r_int
r_char
op_star
)paren
op_amp
id|tp-&gt;curr_cpu_temp
comma
id|MAX1617_CPU_TEMP
)paren
suffix:semicolon
macro_line|#ifdef ENVCTRL_TRACE
id|printk
c_func
(paren
l_string|&quot;temp%d: cpu(%d C) amb(%d C)&bslash;n&quot;
comma
id|tp-&gt;index
comma
(paren
r_int
)paren
id|tp-&gt;curr_cpu_temp
comma
(paren
r_int
)paren
id|tp-&gt;curr_amb_temp
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|do_envctrl_shutdown
r_static
r_void
id|do_envctrl_shutdown
c_func
(paren
r_struct
id|bbc_cpu_temperature
op_star
id|tp
)paren
(brace
r_static
r_int
id|shutting_down
op_assign
l_int|0
suffix:semicolon
r_static
r_char
op_star
id|envp
(braket
)braket
op_assign
(brace
l_string|&quot;HOME=/&quot;
comma
l_string|&quot;TERM=linux&quot;
comma
l_string|&quot;PATH=/sbin:/usr/sbin:/bin:/usr/bin&quot;
comma
l_int|NULL
)brace
suffix:semicolon
r_char
op_star
id|argv
(braket
)braket
op_assign
(brace
l_string|&quot;/sbin/shutdown&quot;
comma
l_string|&quot;-h&quot;
comma
l_string|&quot;now&quot;
comma
l_int|NULL
)brace
suffix:semicolon
r_char
op_star
id|type
op_assign
l_string|&quot;???&quot;
suffix:semicolon
id|s8
id|val
op_assign
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|shutting_down
op_ne
l_int|0
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|tp-&gt;curr_amb_temp
op_ge
id|amb_temp_limits
(braket
id|tp-&gt;index
)braket
dot
id|high_shutdown
op_logical_or
id|tp-&gt;curr_amb_temp
OL
id|amb_temp_limits
(braket
id|tp-&gt;index
)braket
dot
id|low_shutdown
)paren
(brace
id|type
op_assign
l_string|&quot;ambient&quot;
suffix:semicolon
id|val
op_assign
id|tp-&gt;curr_amb_temp
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|tp-&gt;curr_cpu_temp
op_ge
id|cpu_temp_limits
(braket
id|tp-&gt;index
)braket
dot
id|high_shutdown
op_logical_or
id|tp-&gt;curr_cpu_temp
OL
id|cpu_temp_limits
(braket
id|tp-&gt;index
)braket
dot
id|low_shutdown
)paren
(brace
id|type
op_assign
l_string|&quot;CPU&quot;
suffix:semicolon
id|val
op_assign
id|tp-&gt;curr_cpu_temp
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;temp%d: Outside of safe %s &quot;
l_string|&quot;operating temperature, %d C.&bslash;n&quot;
comma
id|tp-&gt;index
comma
id|type
comma
id|val
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;kenvctrld: Shutting down the system now.&bslash;n&quot;
)paren
suffix:semicolon
id|shutting_down
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|execve
c_func
(paren
l_string|&quot;/sbin/shutdown&quot;
comma
id|argv
comma
id|envp
)paren
OL
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;envctrl: shutdown execution failed&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|macro|WARN_INTERVAL
mdefine_line|#define WARN_INTERVAL&t;(30 * HZ)
DECL|function|analyze_ambient_temp
r_static
r_void
id|analyze_ambient_temp
c_func
(paren
r_struct
id|bbc_cpu_temperature
op_star
id|tp
comma
r_int
r_int
op_star
id|last_warn
comma
r_int
id|tick
)paren
(brace
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|time_after
c_func
(paren
id|jiffies
comma
(paren
op_star
id|last_warn
op_plus
id|WARN_INTERVAL
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|tp-&gt;curr_amb_temp
op_ge
id|amb_temp_limits
(braket
id|tp-&gt;index
)braket
dot
id|high_warn
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;temp%d: &quot;
l_string|&quot;Above safe ambient operating temperature, %d C.&bslash;n&quot;
comma
id|tp-&gt;index
comma
(paren
r_int
)paren
id|tp-&gt;curr_amb_temp
)paren
suffix:semicolon
id|ret
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|tp-&gt;curr_amb_temp
OL
id|amb_temp_limits
(braket
id|tp-&gt;index
)braket
dot
id|low_warn
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;temp%d: &quot;
l_string|&quot;Below safe ambient operating temperature, %d C.&bslash;n&quot;
comma
id|tp-&gt;index
comma
(paren
r_int
)paren
id|tp-&gt;curr_amb_temp
)paren
suffix:semicolon
id|ret
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ret
)paren
op_star
id|last_warn
op_assign
id|jiffies
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|tp-&gt;curr_amb_temp
op_ge
id|amb_temp_limits
(braket
id|tp-&gt;index
)braket
dot
id|high_warn
op_logical_or
id|tp-&gt;curr_amb_temp
OL
id|amb_temp_limits
(braket
id|tp-&gt;index
)braket
dot
id|low_warn
)paren
id|ret
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Now check the shutdown limits. */
r_if
c_cond
(paren
id|tp-&gt;curr_amb_temp
op_ge
id|amb_temp_limits
(braket
id|tp-&gt;index
)braket
dot
id|high_shutdown
op_logical_or
id|tp-&gt;curr_amb_temp
OL
id|amb_temp_limits
(braket
id|tp-&gt;index
)braket
dot
id|low_shutdown
)paren
(brace
id|do_envctrl_shutdown
c_func
(paren
id|tp
)paren
suffix:semicolon
id|ret
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ret
)paren
(brace
id|tp-&gt;fan_todo
(braket
id|FAN_AMBIENT
)braket
op_assign
id|FAN_FULLBLAST
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|tick
op_amp
(paren
l_int|8
op_minus
l_int|1
)paren
)paren
op_eq
l_int|0
)paren
(brace
id|s8
id|amb_goal_hi
op_assign
id|amb_temp_limits
(braket
id|tp-&gt;index
)braket
dot
id|high_warn
op_minus
l_int|10
suffix:semicolon
id|s8
id|amb_goal_lo
suffix:semicolon
id|amb_goal_lo
op_assign
id|amb_goal_hi
op_minus
l_int|3
suffix:semicolon
multiline_comment|/* We do not try to avoid &squot;too cold&squot; events.  Basically we&n;&t;&t; * only try to deal with over-heating and fan noise reduction.&n;&t;&t; */
r_if
c_cond
(paren
id|tp-&gt;avg_amb_temp
OL
id|amb_goal_hi
)paren
(brace
r_if
c_cond
(paren
id|tp-&gt;avg_amb_temp
op_ge
id|amb_goal_lo
)paren
id|tp-&gt;fan_todo
(braket
id|FAN_AMBIENT
)braket
op_assign
id|FAN_SAME
suffix:semicolon
r_else
id|tp-&gt;fan_todo
(braket
id|FAN_AMBIENT
)braket
op_assign
id|FAN_SLOWER
suffix:semicolon
)brace
r_else
(brace
id|tp-&gt;fan_todo
(braket
id|FAN_AMBIENT
)braket
op_assign
id|FAN_FASTER
suffix:semicolon
)brace
)brace
r_else
(brace
id|tp-&gt;fan_todo
(braket
id|FAN_AMBIENT
)braket
op_assign
id|FAN_SAME
suffix:semicolon
)brace
)brace
DECL|function|analyze_cpu_temp
r_static
r_void
id|analyze_cpu_temp
c_func
(paren
r_struct
id|bbc_cpu_temperature
op_star
id|tp
comma
r_int
r_int
op_star
id|last_warn
comma
r_int
id|tick
)paren
(brace
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|time_after
c_func
(paren
id|jiffies
comma
(paren
op_star
id|last_warn
op_plus
id|WARN_INTERVAL
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|tp-&gt;curr_cpu_temp
op_ge
id|cpu_temp_limits
(braket
id|tp-&gt;index
)braket
dot
id|high_warn
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;temp%d: &quot;
l_string|&quot;Above safe CPU operating temperature, %d C.&bslash;n&quot;
comma
id|tp-&gt;index
comma
(paren
r_int
)paren
id|tp-&gt;curr_cpu_temp
)paren
suffix:semicolon
id|ret
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|tp-&gt;curr_cpu_temp
OL
id|cpu_temp_limits
(braket
id|tp-&gt;index
)braket
dot
id|low_warn
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;temp%d: &quot;
l_string|&quot;Below safe CPU operating temperature, %d C.&bslash;n&quot;
comma
id|tp-&gt;index
comma
(paren
r_int
)paren
id|tp-&gt;curr_cpu_temp
)paren
suffix:semicolon
id|ret
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ret
)paren
op_star
id|last_warn
op_assign
id|jiffies
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|tp-&gt;curr_cpu_temp
op_ge
id|cpu_temp_limits
(braket
id|tp-&gt;index
)braket
dot
id|high_warn
op_logical_or
id|tp-&gt;curr_cpu_temp
OL
id|cpu_temp_limits
(braket
id|tp-&gt;index
)braket
dot
id|low_warn
)paren
id|ret
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Now check the shutdown limits. */
r_if
c_cond
(paren
id|tp-&gt;curr_cpu_temp
op_ge
id|cpu_temp_limits
(braket
id|tp-&gt;index
)braket
dot
id|high_shutdown
op_logical_or
id|tp-&gt;curr_cpu_temp
OL
id|cpu_temp_limits
(braket
id|tp-&gt;index
)braket
dot
id|low_shutdown
)paren
(brace
id|do_envctrl_shutdown
c_func
(paren
id|tp
)paren
suffix:semicolon
id|ret
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ret
)paren
(brace
id|tp-&gt;fan_todo
(braket
id|FAN_CPU
)braket
op_assign
id|FAN_FULLBLAST
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|tick
op_amp
(paren
l_int|8
op_minus
l_int|1
)paren
)paren
op_eq
l_int|0
)paren
(brace
id|s8
id|cpu_goal_hi
op_assign
id|cpu_temp_limits
(braket
id|tp-&gt;index
)braket
dot
id|high_warn
op_minus
l_int|10
suffix:semicolon
id|s8
id|cpu_goal_lo
suffix:semicolon
id|cpu_goal_lo
op_assign
id|cpu_goal_hi
op_minus
l_int|3
suffix:semicolon
multiline_comment|/* We do not try to avoid &squot;too cold&squot; events.  Basically we&n;&t;&t; * only try to deal with over-heating and fan noise reduction.&n;&t;&t; */
r_if
c_cond
(paren
id|tp-&gt;avg_cpu_temp
OL
id|cpu_goal_hi
)paren
(brace
r_if
c_cond
(paren
id|tp-&gt;avg_cpu_temp
op_ge
id|cpu_goal_lo
)paren
id|tp-&gt;fan_todo
(braket
id|FAN_CPU
)braket
op_assign
id|FAN_SAME
suffix:semicolon
r_else
id|tp-&gt;fan_todo
(braket
id|FAN_CPU
)braket
op_assign
id|FAN_SLOWER
suffix:semicolon
)brace
r_else
(brace
id|tp-&gt;fan_todo
(braket
id|FAN_CPU
)braket
op_assign
id|FAN_FASTER
suffix:semicolon
)brace
)brace
r_else
(brace
id|tp-&gt;fan_todo
(braket
id|FAN_CPU
)braket
op_assign
id|FAN_SAME
suffix:semicolon
)brace
)brace
DECL|function|analyze_temps
r_static
r_void
id|analyze_temps
c_func
(paren
r_struct
id|bbc_cpu_temperature
op_star
id|tp
comma
r_int
r_int
op_star
id|last_warn
)paren
(brace
id|tp-&gt;avg_amb_temp
op_assign
(paren
id|s8
)paren
(paren
(paren
r_int
)paren
(paren
(paren
r_int
)paren
id|tp-&gt;avg_amb_temp
op_plus
(paren
r_int
)paren
id|tp-&gt;curr_amb_temp
)paren
op_div
l_int|2
)paren
suffix:semicolon
id|tp-&gt;avg_cpu_temp
op_assign
(paren
id|s8
)paren
(paren
(paren
r_int
)paren
(paren
(paren
r_int
)paren
id|tp-&gt;avg_cpu_temp
op_plus
(paren
r_int
)paren
id|tp-&gt;curr_cpu_temp
)paren
op_div
l_int|2
)paren
suffix:semicolon
id|analyze_ambient_temp
c_func
(paren
id|tp
comma
id|last_warn
comma
id|tp-&gt;sample_tick
)paren
suffix:semicolon
id|analyze_cpu_temp
c_func
(paren
id|tp
comma
id|last_warn
comma
id|tp-&gt;sample_tick
)paren
suffix:semicolon
id|tp-&gt;sample_tick
op_increment
suffix:semicolon
)brace
DECL|function|prioritize_fan_action
r_static
r_enum
id|fan_action
id|prioritize_fan_action
c_func
(paren
r_int
id|which_fan
)paren
(brace
r_struct
id|bbc_cpu_temperature
op_star
id|tp
suffix:semicolon
r_enum
id|fan_action
id|decision
op_assign
id|FAN_STATE_MAX
suffix:semicolon
multiline_comment|/* Basically, prioritize what the temperature sensors&n;&t; * recommend we do, and perform that action on all the&n;&t; * fans.&n;&t; */
r_for
c_loop
(paren
id|tp
op_assign
id|all_bbc_temps
suffix:semicolon
id|tp
suffix:semicolon
id|tp
op_assign
id|tp-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|tp-&gt;fan_todo
(braket
id|which_fan
)braket
op_eq
id|FAN_FULLBLAST
)paren
(brace
id|decision
op_assign
id|FAN_FULLBLAST
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tp-&gt;fan_todo
(braket
id|which_fan
)braket
op_eq
id|FAN_SAME
op_logical_and
id|decision
op_ne
id|FAN_FASTER
)paren
id|decision
op_assign
id|FAN_SAME
suffix:semicolon
r_else
r_if
c_cond
(paren
id|tp-&gt;fan_todo
(braket
id|which_fan
)braket
op_eq
id|FAN_FASTER
)paren
id|decision
op_assign
id|FAN_FASTER
suffix:semicolon
r_else
r_if
c_cond
(paren
id|decision
op_ne
id|FAN_FASTER
op_logical_and
id|decision
op_ne
id|FAN_SAME
op_logical_and
id|tp-&gt;fan_todo
(braket
id|which_fan
)braket
op_eq
id|FAN_SLOWER
)paren
id|decision
op_assign
id|FAN_SLOWER
suffix:semicolon
)brace
r_if
c_cond
(paren
id|decision
op_eq
id|FAN_STATE_MAX
)paren
id|decision
op_assign
id|FAN_SAME
suffix:semicolon
r_return
id|decision
suffix:semicolon
)brace
DECL|function|maybe_new_ambient_fan_speed
r_static
r_int
id|maybe_new_ambient_fan_speed
c_func
(paren
r_struct
id|bbc_fan_control
op_star
id|fp
)paren
(brace
r_enum
id|fan_action
id|decision
op_assign
id|prioritize_fan_action
c_func
(paren
id|FAN_AMBIENT
)paren
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
id|decision
op_eq
id|FAN_SAME
)paren
r_return
l_int|0
suffix:semicolon
id|ret
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|decision
op_eq
id|FAN_FULLBLAST
)paren
(brace
r_if
c_cond
(paren
id|fp-&gt;system_fan_speed
op_ge
id|FAN_SPEED_MAX
)paren
id|ret
op_assign
l_int|0
suffix:semicolon
r_else
id|fp-&gt;system_fan_speed
op_assign
id|FAN_SPEED_MAX
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|decision
op_eq
id|FAN_FASTER
)paren
(brace
r_if
c_cond
(paren
id|fp-&gt;system_fan_speed
op_ge
id|FAN_SPEED_MAX
)paren
id|ret
op_assign
l_int|0
suffix:semicolon
r_else
id|fp-&gt;system_fan_speed
op_add_assign
l_int|2
suffix:semicolon
)brace
r_else
(brace
r_int
id|orig_speed
op_assign
id|fp-&gt;system_fan_speed
suffix:semicolon
r_if
c_cond
(paren
id|orig_speed
op_le
id|FAN_SPEED_MIN
op_logical_or
id|orig_speed
op_le
(paren
id|fp-&gt;cpu_fan_speed
op_minus
l_int|3
)paren
)paren
id|ret
op_assign
l_int|0
suffix:semicolon
r_else
id|fp-&gt;system_fan_speed
op_sub_assign
l_int|1
suffix:semicolon
)brace
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|function|maybe_new_cpu_fan_speed
r_static
r_int
id|maybe_new_cpu_fan_speed
c_func
(paren
r_struct
id|bbc_fan_control
op_star
id|fp
)paren
(brace
r_enum
id|fan_action
id|decision
op_assign
id|prioritize_fan_action
c_func
(paren
id|FAN_CPU
)paren
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
id|decision
op_eq
id|FAN_SAME
)paren
r_return
l_int|0
suffix:semicolon
id|ret
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|decision
op_eq
id|FAN_FULLBLAST
)paren
(brace
r_if
c_cond
(paren
id|fp-&gt;cpu_fan_speed
op_ge
id|FAN_SPEED_MAX
)paren
id|ret
op_assign
l_int|0
suffix:semicolon
r_else
id|fp-&gt;cpu_fan_speed
op_assign
id|FAN_SPEED_MAX
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|decision
op_eq
id|FAN_FASTER
)paren
(brace
r_if
c_cond
(paren
id|fp-&gt;cpu_fan_speed
op_ge
id|FAN_SPEED_MAX
)paren
id|ret
op_assign
l_int|0
suffix:semicolon
r_else
(brace
id|fp-&gt;cpu_fan_speed
op_add_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|fp-&gt;system_fan_speed
OL
(paren
id|fp-&gt;cpu_fan_speed
op_minus
l_int|3
)paren
)paren
id|fp-&gt;system_fan_speed
op_assign
id|fp-&gt;cpu_fan_speed
op_minus
l_int|3
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|fp-&gt;cpu_fan_speed
op_le
id|FAN_SPEED_MIN
)paren
id|ret
op_assign
l_int|0
suffix:semicolon
r_else
id|fp-&gt;cpu_fan_speed
op_sub_assign
l_int|1
suffix:semicolon
)brace
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|function|maybe_new_fan_speeds
r_static
r_void
id|maybe_new_fan_speeds
c_func
(paren
r_struct
id|bbc_fan_control
op_star
id|fp
)paren
(brace
r_int
r_new
suffix:semicolon
r_new
op_assign
id|maybe_new_ambient_fan_speed
c_func
(paren
id|fp
)paren
suffix:semicolon
r_new
op_or_assign
id|maybe_new_cpu_fan_speed
c_func
(paren
id|fp
)paren
suffix:semicolon
r_if
c_cond
(paren
r_new
)paren
id|set_fan_speeds
c_func
(paren
id|fp
)paren
suffix:semicolon
)brace
DECL|function|fans_full_blast
r_static
r_void
id|fans_full_blast
c_func
(paren
r_void
)paren
(brace
r_struct
id|bbc_fan_control
op_star
id|fp
suffix:semicolon
multiline_comment|/* Since we will not be monitoring things anymore, put&n;&t; * the fans on full blast.&n;&t; */
r_for
c_loop
(paren
id|fp
op_assign
id|all_bbc_fans
suffix:semicolon
id|fp
suffix:semicolon
id|fp
op_assign
id|fp-&gt;next
)paren
(brace
id|fp-&gt;cpu_fan_speed
op_assign
id|FAN_SPEED_MAX
suffix:semicolon
id|fp-&gt;system_fan_speed
op_assign
id|FAN_SPEED_MAX
suffix:semicolon
id|fp-&gt;psupply_fan_on
op_assign
l_int|1
suffix:semicolon
id|set_fan_speeds
c_func
(paren
id|fp
)paren
suffix:semicolon
)brace
)brace
DECL|macro|POLL_INTERVAL
mdefine_line|#define POLL_INTERVAL&t;(5 * HZ)
DECL|variable|last_warning_jiffies
r_static
r_int
r_int
id|last_warning_jiffies
suffix:semicolon
DECL|variable|kenvctrld_task
r_static
r_struct
id|task_struct
op_star
id|kenvctrld_task
suffix:semicolon
DECL|function|kenvctrld
r_static
r_int
id|kenvctrld
c_func
(paren
r_void
op_star
id|__unused
)paren
(brace
id|daemonize
c_func
(paren
l_string|&quot;kenvctrld&quot;
)paren
suffix:semicolon
id|allow_signal
c_func
(paren
id|SIGKILL
)paren
suffix:semicolon
id|kenvctrld_task
op_assign
id|current
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;bbc_envctrl: kenvctrld starting...&bslash;n&quot;
)paren
suffix:semicolon
id|last_warning_jiffies
op_assign
id|jiffies
op_minus
id|WARN_INTERVAL
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
r_struct
id|bbc_cpu_temperature
op_star
id|tp
suffix:semicolon
r_struct
id|bbc_fan_control
op_star
id|fp
suffix:semicolon
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|POLL_INTERVAL
)paren
suffix:semicolon
id|current-&gt;state
op_assign
id|TASK_RUNNING
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
r_break
suffix:semicolon
r_for
c_loop
(paren
id|tp
op_assign
id|all_bbc_temps
suffix:semicolon
id|tp
suffix:semicolon
id|tp
op_assign
id|tp-&gt;next
)paren
(brace
id|get_current_temps
c_func
(paren
id|tp
)paren
suffix:semicolon
id|analyze_temps
c_func
(paren
id|tp
comma
op_amp
id|last_warning_jiffies
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|fp
op_assign
id|all_bbc_fans
suffix:semicolon
id|fp
suffix:semicolon
id|fp
op_assign
id|fp-&gt;next
)paren
id|maybe_new_fan_speeds
c_func
(paren
id|fp
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;bbc_envctrl: kenvctrld exiting...&bslash;n&quot;
)paren
suffix:semicolon
id|fans_full_blast
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|attach_one_temp
r_static
r_void
id|attach_one_temp
c_func
(paren
r_struct
id|linux_ebus_child
op_star
id|echild
comma
r_int
id|temp_idx
)paren
(brace
r_struct
id|bbc_cpu_temperature
op_star
id|tp
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|tp
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tp
)paren
r_return
suffix:semicolon
id|memset
c_func
(paren
id|tp
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|tp
)paren
)paren
suffix:semicolon
id|tp-&gt;client
op_assign
id|bbc_i2c_attach
c_func
(paren
id|echild
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tp-&gt;client
)paren
(brace
id|kfree
c_func
(paren
id|tp
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|tp-&gt;index
op_assign
id|temp_idx
suffix:semicolon
(brace
r_struct
id|bbc_cpu_temperature
op_star
op_star
id|tpp
op_assign
op_amp
id|all_bbc_temps
suffix:semicolon
r_while
c_loop
(paren
op_star
id|tpp
)paren
id|tpp
op_assign
op_amp
(paren
(paren
op_star
id|tpp
)paren
op_member_access_from_pointer
id|next
)paren
suffix:semicolon
id|tp-&gt;next
op_assign
l_int|NULL
suffix:semicolon
op_star
id|tpp
op_assign
id|tp
suffix:semicolon
)brace
multiline_comment|/* Tell it to convert once every 5 seconds, clear all cfg&n;&t; * bits.&n;&t; */
id|bbc_i2c_writeb
c_func
(paren
id|tp-&gt;client
comma
l_int|0x00
comma
id|MAX1617_WR_CFG_BYTE
)paren
suffix:semicolon
id|bbc_i2c_writeb
c_func
(paren
id|tp-&gt;client
comma
l_int|0x02
comma
id|MAX1617_WR_CVRATE_BYTE
)paren
suffix:semicolon
multiline_comment|/* Program the hard temperature limits into the chip. */
id|bbc_i2c_writeb
c_func
(paren
id|tp-&gt;client
comma
id|amb_temp_limits
(braket
id|tp-&gt;index
)braket
dot
id|high_pwroff
comma
id|MAX1617_WR_AMB_HIGHLIM
)paren
suffix:semicolon
id|bbc_i2c_writeb
c_func
(paren
id|tp-&gt;client
comma
id|amb_temp_limits
(braket
id|tp-&gt;index
)braket
dot
id|low_pwroff
comma
id|MAX1617_WR_AMB_LOWLIM
)paren
suffix:semicolon
id|bbc_i2c_writeb
c_func
(paren
id|tp-&gt;client
comma
id|cpu_temp_limits
(braket
id|tp-&gt;index
)braket
dot
id|high_pwroff
comma
id|MAX1617_WR_CPU_HIGHLIM
)paren
suffix:semicolon
id|bbc_i2c_writeb
c_func
(paren
id|tp-&gt;client
comma
id|cpu_temp_limits
(braket
id|tp-&gt;index
)braket
dot
id|low_pwroff
comma
id|MAX1617_WR_CPU_LOWLIM
)paren
suffix:semicolon
id|get_current_temps
c_func
(paren
id|tp
)paren
suffix:semicolon
id|tp-&gt;prev_cpu_temp
op_assign
id|tp-&gt;avg_cpu_temp
op_assign
id|tp-&gt;curr_cpu_temp
suffix:semicolon
id|tp-&gt;prev_amb_temp
op_assign
id|tp-&gt;avg_amb_temp
op_assign
id|tp-&gt;curr_amb_temp
suffix:semicolon
id|tp-&gt;fan_todo
(braket
id|FAN_AMBIENT
)braket
op_assign
id|FAN_SAME
suffix:semicolon
id|tp-&gt;fan_todo
(braket
id|FAN_CPU
)braket
op_assign
id|FAN_SAME
suffix:semicolon
)brace
DECL|function|attach_one_fan
r_static
r_void
id|attach_one_fan
c_func
(paren
r_struct
id|linux_ebus_child
op_star
id|echild
comma
r_int
id|fan_idx
)paren
(brace
r_struct
id|bbc_fan_control
op_star
id|fp
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|fp
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fp
)paren
r_return
suffix:semicolon
id|memset
c_func
(paren
id|fp
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|fp
)paren
)paren
suffix:semicolon
id|fp-&gt;client
op_assign
id|bbc_i2c_attach
c_func
(paren
id|echild
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fp-&gt;client
)paren
(brace
id|kfree
c_func
(paren
id|fp
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|fp-&gt;index
op_assign
id|fan_idx
suffix:semicolon
(brace
r_struct
id|bbc_fan_control
op_star
op_star
id|fpp
op_assign
op_amp
id|all_bbc_fans
suffix:semicolon
r_while
c_loop
(paren
op_star
id|fpp
)paren
id|fpp
op_assign
op_amp
(paren
(paren
op_star
id|fpp
)paren
op_member_access_from_pointer
id|next
)paren
suffix:semicolon
id|fp-&gt;next
op_assign
l_int|NULL
suffix:semicolon
op_star
id|fpp
op_assign
id|fp
suffix:semicolon
)brace
multiline_comment|/* The i2c device controlling the fans is write-only.&n;&t; * So the only way to keep track of the current power&n;&t; * level fed to the fans is via software.  Choose half&n;&t; * power for cpu/system and &squot;on&squot; fo the powersupply fan&n;&t; * and set it now.&n;&t; */
id|fp-&gt;psupply_fan_on
op_assign
l_int|1
suffix:semicolon
id|fp-&gt;cpu_fan_speed
op_assign
(paren
id|FAN_SPEED_MAX
op_minus
id|FAN_SPEED_MIN
)paren
op_div
l_int|2
suffix:semicolon
id|fp-&gt;cpu_fan_speed
op_add_assign
id|FAN_SPEED_MIN
suffix:semicolon
id|fp-&gt;system_fan_speed
op_assign
(paren
id|FAN_SPEED_MAX
op_minus
id|FAN_SPEED_MIN
)paren
op_div
l_int|2
suffix:semicolon
id|fp-&gt;system_fan_speed
op_add_assign
id|FAN_SPEED_MIN
suffix:semicolon
id|set_fan_speeds
c_func
(paren
id|fp
)paren
suffix:semicolon
)brace
DECL|function|bbc_envctrl_init
r_int
id|bbc_envctrl_init
c_func
(paren
r_void
)paren
(brace
r_struct
id|linux_ebus_child
op_star
id|echild
suffix:semicolon
r_int
id|temp_index
op_assign
l_int|0
suffix:semicolon
r_int
id|fan_index
op_assign
l_int|0
suffix:semicolon
r_int
id|devidx
op_assign
l_int|0
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
id|echild
op_assign
id|bbc_i2c_getdev
c_func
(paren
id|devidx
op_increment
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|echild-&gt;prom_name
comma
l_string|&quot;temperature&quot;
)paren
)paren
id|attach_one_temp
c_func
(paren
id|echild
comma
id|temp_index
op_increment
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|echild-&gt;prom_name
comma
l_string|&quot;fan-control&quot;
)paren
)paren
id|attach_one_fan
c_func
(paren
id|echild
comma
id|fan_index
op_increment
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|temp_index
op_ne
l_int|0
op_logical_and
id|fan_index
op_ne
l_int|0
)paren
id|err
op_assign
id|kernel_thread
c_func
(paren
id|kenvctrld
comma
l_int|NULL
comma
id|CLONE_FS
op_or
id|CLONE_FILES
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|destroy_one_temp
r_static
r_void
id|destroy_one_temp
c_func
(paren
r_struct
id|bbc_cpu_temperature
op_star
id|tp
)paren
(brace
id|bbc_i2c_detach
c_func
(paren
id|tp-&gt;client
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|tp
)paren
suffix:semicolon
)brace
DECL|function|destroy_one_fan
r_static
r_void
id|destroy_one_fan
c_func
(paren
r_struct
id|bbc_fan_control
op_star
id|fp
)paren
(brace
id|bbc_i2c_detach
c_func
(paren
id|fp-&gt;client
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|fp
)paren
suffix:semicolon
)brace
DECL|function|bbc_envctrl_cleanup
r_void
id|bbc_envctrl_cleanup
c_func
(paren
r_void
)paren
(brace
r_struct
id|bbc_cpu_temperature
op_star
id|tp
suffix:semicolon
r_struct
id|bbc_fan_control
op_star
id|fp
suffix:semicolon
r_if
c_cond
(paren
id|kenvctrld_task
op_ne
l_int|NULL
)paren
(brace
id|force_sig
c_func
(paren
id|SIGKILL
comma
id|kenvctrld_task
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
r_struct
id|task_struct
op_star
id|p
suffix:semicolon
r_int
id|found
op_assign
l_int|0
suffix:semicolon
id|read_lock
c_func
(paren
op_amp
id|tasklist_lock
)paren
suffix:semicolon
id|for_each_process
c_func
(paren
id|p
)paren
(brace
r_if
c_cond
(paren
id|p
op_eq
id|kenvctrld_task
)paren
(brace
id|found
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|read_unlock
c_func
(paren
op_amp
id|tasklist_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|found
)paren
r_break
suffix:semicolon
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|HZ
)paren
suffix:semicolon
id|current-&gt;state
op_assign
id|TASK_RUNNING
suffix:semicolon
)brace
id|kenvctrld_task
op_assign
l_int|NULL
suffix:semicolon
)brace
id|tp
op_assign
id|all_bbc_temps
suffix:semicolon
r_while
c_loop
(paren
id|tp
op_ne
l_int|NULL
)paren
(brace
r_struct
id|bbc_cpu_temperature
op_star
id|next
op_assign
id|tp-&gt;next
suffix:semicolon
id|destroy_one_temp
c_func
(paren
id|tp
)paren
suffix:semicolon
id|tp
op_assign
id|next
suffix:semicolon
)brace
id|all_bbc_temps
op_assign
l_int|NULL
suffix:semicolon
id|fp
op_assign
id|all_bbc_fans
suffix:semicolon
r_while
c_loop
(paren
id|fp
op_ne
l_int|NULL
)paren
(brace
r_struct
id|bbc_fan_control
op_star
id|next
op_assign
id|fp-&gt;next
suffix:semicolon
id|destroy_one_fan
c_func
(paren
id|fp
)paren
suffix:semicolon
id|fp
op_assign
id|next
suffix:semicolon
)brace
id|all_bbc_fans
op_assign
l_int|NULL
suffix:semicolon
)brace
eof
