multiline_comment|/*&n; * sunzilog.c&n; *&n; * Driver for Zilog serial chips found on Sun workstations and&n; * servers.  This driver could actually be made more generic.&n; *&n; * This is based on the old drivers/sbus/char/zs.c code.  A lot&n; * of code has been simply moved over directly from there but&n; * much has been rewritten.  Credits therefore go out to Eddie&n; * C. Dost, Pete Zaitcev, Ted Ts&squot;o and Alex Buell for their&n; * work there.&n; *&n; *  Copyright (C) 2002 David S. Miller (davem@redhat.com)&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/tty_flip.h&gt;
macro_line|#include &lt;linux/major.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/circ_buf.h&gt;
macro_line|#include &lt;linux/serial.h&gt;
macro_line|#include &lt;linux/sysrq.h&gt;
macro_line|#include &lt;linux/console.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#ifdef CONFIG_SERIO
macro_line|#include &lt;linux/serio.h&gt;
macro_line|#endif
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#ifdef CONFIG_SPARC64
macro_line|#include &lt;asm/fhc.h&gt;
macro_line|#endif
macro_line|#include &lt;asm/sbus.h&gt;
macro_line|#if defined(CONFIG_SERIAL_SUNZILOG_CONSOLE) &amp;&amp; defined(CONFIG_MAGIC_SYSRQ)
DECL|macro|SUPPORT_SYSRQ
mdefine_line|#define SUPPORT_SYSRQ
macro_line|#endif
macro_line|#include &lt;linux/serial_core.h&gt;
macro_line|#include &quot;suncore.h&quot;
macro_line|#include &quot;sunzilog.h&quot;
multiline_comment|/* On 32-bit sparcs we need to delay after register accesses&n; * to accommodate sun4 systems, but we do not need to flush writes.&n; * On 64-bit sparc we only need to flush single writes to ensure&n; * completion.&n; */
macro_line|#ifndef CONFIG_SPARC64
DECL|macro|ZSDELAY
mdefine_line|#define ZSDELAY()&t;&t;udelay(5)
DECL|macro|ZSDELAY_LONG
mdefine_line|#define ZSDELAY_LONG()&t;&t;udelay(20)
DECL|macro|ZS_WSYNC
mdefine_line|#define ZS_WSYNC(channel)&t;do { } while (0)
macro_line|#else
DECL|macro|ZSDELAY
mdefine_line|#define ZSDELAY()
DECL|macro|ZSDELAY_LONG
mdefine_line|#define ZSDELAY_LONG()
DECL|macro|ZS_WSYNC
mdefine_line|#define ZS_WSYNC(__channel) &bslash;&n;&t;sbus_readb(&amp;((__channel)-&gt;control))
macro_line|#endif
DECL|variable|num_sunzilog
r_static
r_int
id|num_sunzilog
suffix:semicolon
DECL|macro|NUM_SUNZILOG
mdefine_line|#define NUM_SUNZILOG&t;num_sunzilog
DECL|macro|NUM_CHANNELS
mdefine_line|#define NUM_CHANNELS&t;(NUM_SUNZILOG * 2)
DECL|macro|KEYBOARD_LINE
mdefine_line|#define KEYBOARD_LINE 0x2
DECL|macro|MOUSE_LINE
mdefine_line|#define MOUSE_LINE    0x3
DECL|macro|ZS_CLOCK
mdefine_line|#define ZS_CLOCK&t;&t;4915200 /* Zilog input clock rate. */
DECL|macro|ZS_CLOCK_DIVISOR
mdefine_line|#define ZS_CLOCK_DIVISOR&t;16      /* Divisor this driver uses. */
multiline_comment|/*&n; * We wrap our port structure around the generic uart_port.&n; */
DECL|struct|uart_sunzilog_port
r_struct
id|uart_sunzilog_port
(brace
DECL|member|port
r_struct
id|uart_port
id|port
suffix:semicolon
multiline_comment|/* IRQ servicing chain.  */
DECL|member|next
r_struct
id|uart_sunzilog_port
op_star
id|next
suffix:semicolon
multiline_comment|/* Current values of Zilog write registers.  */
DECL|member|curregs
r_int
r_char
id|curregs
(braket
id|NUM_ZSREGS
)braket
suffix:semicolon
DECL|member|flags
r_int
r_int
id|flags
suffix:semicolon
DECL|macro|SUNZILOG_FLAG_CONS_KEYB
mdefine_line|#define SUNZILOG_FLAG_CONS_KEYB&t;&t;0x00000001
DECL|macro|SUNZILOG_FLAG_CONS_MOUSE
mdefine_line|#define SUNZILOG_FLAG_CONS_MOUSE&t;0x00000002
DECL|macro|SUNZILOG_FLAG_IS_CONS
mdefine_line|#define SUNZILOG_FLAG_IS_CONS&t;&t;0x00000004
DECL|macro|SUNZILOG_FLAG_IS_KGDB
mdefine_line|#define SUNZILOG_FLAG_IS_KGDB&t;&t;0x00000008
DECL|macro|SUNZILOG_FLAG_MODEM_STATUS
mdefine_line|#define SUNZILOG_FLAG_MODEM_STATUS&t;0x00000010
DECL|macro|SUNZILOG_FLAG_IS_CHANNEL_A
mdefine_line|#define SUNZILOG_FLAG_IS_CHANNEL_A&t;0x00000020
DECL|macro|SUNZILOG_FLAG_REGS_HELD
mdefine_line|#define SUNZILOG_FLAG_REGS_HELD&t;&t;0x00000040
DECL|macro|SUNZILOG_FLAG_TX_STOPPED
mdefine_line|#define SUNZILOG_FLAG_TX_STOPPED&t;0x00000080
DECL|macro|SUNZILOG_FLAG_TX_ACTIVE
mdefine_line|#define SUNZILOG_FLAG_TX_ACTIVE&t;&t;0x00000100
DECL|member|cflag
r_int
r_int
id|cflag
suffix:semicolon
DECL|member|parity_mask
r_int
r_char
id|parity_mask
suffix:semicolon
DECL|member|prev_status
r_int
r_char
id|prev_status
suffix:semicolon
macro_line|#ifdef CONFIG_SERIO
DECL|member|serio
r_struct
id|serio
id|serio
suffix:semicolon
DECL|member|serio_open
r_int
id|serio_open
suffix:semicolon
macro_line|#endif
)brace
suffix:semicolon
DECL|macro|ZILOG_CHANNEL_FROM_PORT
mdefine_line|#define ZILOG_CHANNEL_FROM_PORT(PORT)&t;((struct zilog_channel *)((PORT)-&gt;membase))
DECL|macro|UART_ZILOG
mdefine_line|#define UART_ZILOG(PORT)&t;&t;((struct uart_sunzilog_port *)(PORT))
DECL|macro|ZS_IS_KEYB
mdefine_line|#define ZS_IS_KEYB(UP)&t;((UP)-&gt;flags &amp; SUNZILOG_FLAG_CONS_KEYB)
DECL|macro|ZS_IS_MOUSE
mdefine_line|#define ZS_IS_MOUSE(UP)&t;((UP)-&gt;flags &amp; SUNZILOG_FLAG_CONS_MOUSE)
DECL|macro|ZS_IS_CONS
mdefine_line|#define ZS_IS_CONS(UP)&t;((UP)-&gt;flags &amp; SUNZILOG_FLAG_IS_CONS)
DECL|macro|ZS_IS_KGDB
mdefine_line|#define ZS_IS_KGDB(UP)&t;((UP)-&gt;flags &amp; SUNZILOG_FLAG_IS_KGDB)
DECL|macro|ZS_WANTS_MODEM_STATUS
mdefine_line|#define ZS_WANTS_MODEM_STATUS(UP)&t;((UP)-&gt;flags &amp; SUNZILOG_FLAG_MODEM_STATUS)
DECL|macro|ZS_IS_CHANNEL_A
mdefine_line|#define ZS_IS_CHANNEL_A(UP)&t;((UP)-&gt;flags &amp; SUNZILOG_FLAG_IS_CHANNEL_A)
DECL|macro|ZS_REGS_HELD
mdefine_line|#define ZS_REGS_HELD(UP)&t;((UP)-&gt;flags &amp; SUNZILOG_FLAG_REGS_HELD)
DECL|macro|ZS_TX_STOPPED
mdefine_line|#define ZS_TX_STOPPED(UP)&t;((UP)-&gt;flags &amp; SUNZILOG_FLAG_TX_STOPPED)
DECL|macro|ZS_TX_ACTIVE
mdefine_line|#define ZS_TX_ACTIVE(UP)&t;((UP)-&gt;flags &amp; SUNZILOG_FLAG_TX_ACTIVE)
multiline_comment|/* Reading and writing Zilog8530 registers.  The delays are to make this&n; * driver work on the Sun4 which needs a settling delay after each chip&n; * register access, other machines handle this in hardware via auxiliary&n; * flip-flops which implement the settle time we do in software.&n; *&n; * The port lock must be held and local IRQs must be disabled&n; * when {read,write}_zsreg is invoked.&n; */
DECL|function|read_zsreg
r_static
r_int
r_char
id|read_zsreg
c_func
(paren
r_struct
id|zilog_channel
op_star
id|channel
comma
r_int
r_char
id|reg
)paren
(brace
r_int
r_char
id|retval
suffix:semicolon
id|sbus_writeb
c_func
(paren
id|reg
comma
op_amp
id|channel-&gt;control
)paren
suffix:semicolon
id|ZSDELAY
c_func
(paren
)paren
suffix:semicolon
id|retval
op_assign
id|sbus_readb
c_func
(paren
op_amp
id|channel-&gt;control
)paren
suffix:semicolon
id|ZSDELAY
c_func
(paren
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
DECL|function|write_zsreg
r_static
r_void
id|write_zsreg
c_func
(paren
r_struct
id|zilog_channel
op_star
id|channel
comma
r_int
r_char
id|reg
comma
r_int
r_char
id|value
)paren
(brace
id|sbus_writeb
c_func
(paren
id|reg
comma
op_amp
id|channel-&gt;control
)paren
suffix:semicolon
id|ZSDELAY
c_func
(paren
)paren
suffix:semicolon
id|sbus_writeb
c_func
(paren
id|value
comma
op_amp
id|channel-&gt;control
)paren
suffix:semicolon
id|ZSDELAY
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|sunzilog_clear_fifo
r_static
r_void
id|sunzilog_clear_fifo
c_func
(paren
r_struct
id|zilog_channel
op_star
id|channel
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
r_char
id|regval
suffix:semicolon
id|regval
op_assign
id|sbus_readb
c_func
(paren
op_amp
id|channel-&gt;control
)paren
suffix:semicolon
id|ZSDELAY
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|regval
op_amp
id|Rx_CH_AV
)paren
r_break
suffix:semicolon
id|regval
op_assign
id|read_zsreg
c_func
(paren
id|channel
comma
id|R1
)paren
suffix:semicolon
id|sbus_readb
c_func
(paren
op_amp
id|channel-&gt;data
)paren
suffix:semicolon
id|ZSDELAY
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|regval
op_amp
(paren
id|PAR_ERR
op_or
id|Rx_OVR
op_or
id|CRC_ERR
)paren
)paren
(brace
id|sbus_writeb
c_func
(paren
id|ERR_RES
comma
op_amp
id|channel-&gt;control
)paren
suffix:semicolon
id|ZSDELAY
c_func
(paren
)paren
suffix:semicolon
id|ZS_WSYNC
c_func
(paren
id|channel
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* This function must only be called when the TX is not busy.  The UART&n; * port lock must be held and local interrupts disabled.&n; */
DECL|function|__load_zsregs
r_static
r_void
id|__load_zsregs
c_func
(paren
r_struct
id|zilog_channel
op_star
id|channel
comma
r_int
r_char
op_star
id|regs
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/* Let pending transmits finish.  */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|1000
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
r_char
id|stat
op_assign
id|read_zsreg
c_func
(paren
id|channel
comma
id|R1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|stat
op_amp
id|ALL_SNT
)paren
r_break
suffix:semicolon
id|udelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
)brace
id|sbus_writeb
c_func
(paren
id|ERR_RES
comma
op_amp
id|channel-&gt;control
)paren
suffix:semicolon
id|ZSDELAY
c_func
(paren
)paren
suffix:semicolon
id|ZS_WSYNC
c_func
(paren
id|channel
)paren
suffix:semicolon
id|sunzilog_clear_fifo
c_func
(paren
id|channel
)paren
suffix:semicolon
multiline_comment|/* Disable all interrupts.  */
id|write_zsreg
c_func
(paren
id|channel
comma
id|R1
comma
id|regs
(braket
id|R1
)braket
op_amp
op_complement
(paren
id|RxINT_MASK
op_or
id|TxINT_ENAB
op_or
id|EXT_INT_ENAB
)paren
)paren
suffix:semicolon
multiline_comment|/* Set parity, sync config, stop bits, and clock divisor.  */
id|write_zsreg
c_func
(paren
id|channel
comma
id|R4
comma
id|regs
(braket
id|R4
)braket
)paren
suffix:semicolon
multiline_comment|/* Set misc. TX/RX control bits.  */
id|write_zsreg
c_func
(paren
id|channel
comma
id|R10
comma
id|regs
(braket
id|R10
)braket
)paren
suffix:semicolon
multiline_comment|/* Set TX/RX controls sans the enable bits.  */
id|write_zsreg
c_func
(paren
id|channel
comma
id|R3
comma
id|regs
(braket
id|R3
)braket
op_amp
op_complement
id|RxENAB
)paren
suffix:semicolon
id|write_zsreg
c_func
(paren
id|channel
comma
id|R5
comma
id|regs
(braket
id|R5
)braket
op_amp
op_complement
id|TxENAB
)paren
suffix:semicolon
multiline_comment|/* Synchronous mode config.  */
id|write_zsreg
c_func
(paren
id|channel
comma
id|R6
comma
id|regs
(braket
id|R6
)braket
)paren
suffix:semicolon
id|write_zsreg
c_func
(paren
id|channel
comma
id|R7
comma
id|regs
(braket
id|R7
)braket
)paren
suffix:semicolon
multiline_comment|/* Don&squot;t mess with the interrupt vector (R2, unused by us) and&n;&t; * master interrupt control (R9).  We make sure this is setup&n;&t; * properly at probe time then never touch it again.&n;&t; */
multiline_comment|/* Disable baud generator.  */
id|write_zsreg
c_func
(paren
id|channel
comma
id|R14
comma
id|regs
(braket
id|R14
)braket
op_amp
op_complement
id|BRENAB
)paren
suffix:semicolon
multiline_comment|/* Clock mode control.  */
id|write_zsreg
c_func
(paren
id|channel
comma
id|R11
comma
id|regs
(braket
id|R11
)braket
)paren
suffix:semicolon
multiline_comment|/* Lower and upper byte of baud rate generator divisor.  */
id|write_zsreg
c_func
(paren
id|channel
comma
id|R12
comma
id|regs
(braket
id|R12
)braket
)paren
suffix:semicolon
id|write_zsreg
c_func
(paren
id|channel
comma
id|R13
comma
id|regs
(braket
id|R13
)braket
)paren
suffix:semicolon
multiline_comment|/* Now rewrite R14, with BRENAB (if set).  */
id|write_zsreg
c_func
(paren
id|channel
comma
id|R14
comma
id|regs
(braket
id|R14
)braket
)paren
suffix:semicolon
multiline_comment|/* External status interrupt control.  */
id|write_zsreg
c_func
(paren
id|channel
comma
id|R15
comma
id|regs
(braket
id|R15
)braket
)paren
suffix:semicolon
multiline_comment|/* Reset external status interrupts.  */
id|write_zsreg
c_func
(paren
id|channel
comma
id|R0
comma
id|RES_EXT_INT
)paren
suffix:semicolon
id|write_zsreg
c_func
(paren
id|channel
comma
id|R0
comma
id|RES_EXT_INT
)paren
suffix:semicolon
multiline_comment|/* Rewrite R3/R5, this time without enables masked.  */
id|write_zsreg
c_func
(paren
id|channel
comma
id|R3
comma
id|regs
(braket
id|R3
)braket
)paren
suffix:semicolon
id|write_zsreg
c_func
(paren
id|channel
comma
id|R5
comma
id|regs
(braket
id|R5
)braket
)paren
suffix:semicolon
multiline_comment|/* Rewrite R1, this time without IRQ enabled masked.  */
id|write_zsreg
c_func
(paren
id|channel
comma
id|R1
comma
id|regs
(braket
id|R1
)braket
)paren
suffix:semicolon
)brace
multiline_comment|/* Reprogram the Zilog channel HW registers with the copies found in the&n; * software state struct.  If the transmitter is busy, we defer this update&n; * until the next TX complete interrupt.  Else, we do it right now.&n; *&n; * The UART port lock must be held and local interrupts disabled.&n; */
DECL|function|sunzilog_maybe_update_regs
r_static
r_void
id|sunzilog_maybe_update_regs
c_func
(paren
r_struct
id|uart_sunzilog_port
op_star
id|up
comma
r_struct
id|zilog_channel
op_star
id|channel
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ZS_REGS_HELD
c_func
(paren
id|up
)paren
)paren
(brace
r_if
c_cond
(paren
id|ZS_TX_ACTIVE
c_func
(paren
id|up
)paren
)paren
(brace
id|up-&gt;flags
op_or_assign
id|SUNZILOG_FLAG_REGS_HELD
suffix:semicolon
)brace
r_else
(brace
id|__load_zsregs
c_func
(paren
id|channel
comma
id|up-&gt;curregs
)paren
suffix:semicolon
)brace
)brace
)brace
DECL|function|sunzilog_change_mouse_baud
r_static
r_void
id|sunzilog_change_mouse_baud
c_func
(paren
r_struct
id|uart_sunzilog_port
op_star
id|up
)paren
(brace
r_int
r_int
id|cur_cflag
op_assign
id|up-&gt;cflag
suffix:semicolon
r_int
id|brg
comma
id|new_baud
suffix:semicolon
id|up-&gt;cflag
op_and_assign
op_complement
id|CBAUD
suffix:semicolon
id|up-&gt;cflag
op_or_assign
id|suncore_mouse_baud_cflag_next
c_func
(paren
id|cur_cflag
comma
op_amp
id|new_baud
)paren
suffix:semicolon
id|brg
op_assign
id|BPS_TO_BRG
c_func
(paren
id|new_baud
comma
id|ZS_CLOCK
op_div
id|ZS_CLOCK_DIVISOR
)paren
suffix:semicolon
id|up-&gt;curregs
(braket
id|R12
)braket
op_assign
(paren
id|brg
op_amp
l_int|0xff
)paren
suffix:semicolon
id|up-&gt;curregs
(braket
id|R13
)braket
op_assign
(paren
id|brg
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
id|sunzilog_maybe_update_regs
c_func
(paren
id|up
comma
id|ZILOG_CHANNEL_FROM_PORT
c_func
(paren
op_amp
id|up-&gt;port
)paren
)paren
suffix:semicolon
)brace
DECL|function|sunzilog_kbdms_receive_chars
r_static
r_void
id|sunzilog_kbdms_receive_chars
c_func
(paren
r_struct
id|uart_sunzilog_port
op_star
id|up
comma
r_int
r_char
id|ch
comma
r_int
id|is_break
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_if
c_cond
(paren
id|ZS_IS_KEYB
c_func
(paren
id|up
)paren
)paren
(brace
multiline_comment|/* Stop-A is handled by drivers/char/keyboard.c now. */
macro_line|#ifdef CONFIG_SERIO
r_if
c_cond
(paren
id|up-&gt;serio_open
)paren
id|serio_interrupt
c_func
(paren
op_amp
id|up-&gt;serio
comma
id|ch
comma
l_int|0
comma
id|regs
)paren
suffix:semicolon
macro_line|#endif
)brace
r_else
r_if
c_cond
(paren
id|ZS_IS_MOUSE
c_func
(paren
id|up
)paren
)paren
(brace
r_int
id|ret
op_assign
id|suncore_mouse_baud_detection
c_func
(paren
id|ch
comma
id|is_break
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|ret
)paren
(brace
r_case
l_int|2
suffix:colon
id|sunzilog_change_mouse_baud
c_func
(paren
id|up
)paren
suffix:semicolon
multiline_comment|/* fallthru */
r_case
l_int|1
suffix:colon
r_break
suffix:semicolon
r_case
l_int|0
suffix:colon
macro_line|#ifdef CONFIG_SERIO
r_if
c_cond
(paren
id|up-&gt;serio_open
)paren
id|serio_interrupt
c_func
(paren
op_amp
id|up-&gt;serio
comma
id|ch
comma
l_int|0
comma
id|regs
)paren
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
)brace
suffix:semicolon
)brace
)brace
r_static
r_struct
id|tty_struct
op_star
DECL|function|sunzilog_receive_chars
id|sunzilog_receive_chars
c_func
(paren
r_struct
id|uart_sunzilog_port
op_star
id|up
comma
r_struct
id|zilog_channel
op_star
id|channel
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|tty_struct
op_star
id|tty
suffix:semicolon
r_int
r_char
id|ch
comma
id|r1
suffix:semicolon
id|tty
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|up-&gt;port.info
op_ne
l_int|NULL
op_logical_and
multiline_comment|/* Unopened serial console */
id|up-&gt;port.info-&gt;tty
op_ne
l_int|NULL
)paren
multiline_comment|/* Keyboard || mouse */
id|tty
op_assign
id|up-&gt;port.info-&gt;tty
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|r1
op_assign
id|read_zsreg
c_func
(paren
id|channel
comma
id|R1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r1
op_amp
(paren
id|PAR_ERR
op_or
id|Rx_OVR
op_or
id|CRC_ERR
)paren
)paren
(brace
id|sbus_writeb
c_func
(paren
id|ERR_RES
comma
op_amp
id|channel-&gt;control
)paren
suffix:semicolon
id|ZSDELAY
c_func
(paren
)paren
suffix:semicolon
id|ZS_WSYNC
c_func
(paren
id|channel
)paren
suffix:semicolon
)brace
id|ch
op_assign
id|sbus_readb
c_func
(paren
op_amp
id|channel-&gt;control
)paren
suffix:semicolon
id|ZSDELAY
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* This funny hack depends upon BRK_ABRT not interfering&n;&t;&t; * with the other bits we care about in R1.&n;&t;&t; */
r_if
c_cond
(paren
id|ch
op_amp
id|BRK_ABRT
)paren
id|r1
op_or_assign
id|BRK_ABRT
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|ch
op_amp
id|Rx_CH_AV
)paren
)paren
r_break
suffix:semicolon
id|ch
op_assign
id|sbus_readb
c_func
(paren
op_amp
id|channel-&gt;data
)paren
suffix:semicolon
id|ZSDELAY
c_func
(paren
)paren
suffix:semicolon
id|ch
op_and_assign
id|up-&gt;parity_mask
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|ZS_IS_KEYB
c_func
(paren
id|up
)paren
)paren
op_logical_or
id|unlikely
c_func
(paren
id|ZS_IS_MOUSE
c_func
(paren
id|up
)paren
)paren
)paren
(brace
id|sunzilog_kbdms_receive_chars
c_func
(paren
id|up
comma
id|ch
comma
l_int|0
comma
id|regs
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tty
op_eq
l_int|NULL
)paren
(brace
id|uart_handle_sysrq_char
c_func
(paren
op_amp
id|up-&gt;port
comma
id|ch
comma
id|regs
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|tty-&gt;flip.count
op_ge
id|TTY_FLIPBUF_SIZE
)paren
)paren
(brace
id|tty-&gt;flip.work
dot
id|func
c_func
(paren
(paren
r_void
op_star
)paren
id|tty
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * The 8250 bails out of the loop here,&n;&t;&t;&t; * but we need to read everything, or die.&n;&t;&t;&t; */
r_if
c_cond
(paren
id|tty-&gt;flip.count
op_ge
id|TTY_FLIPBUF_SIZE
)paren
r_continue
suffix:semicolon
)brace
multiline_comment|/* A real serial line, record the character and status.  */
op_star
id|tty-&gt;flip.char_buf_ptr
op_assign
id|ch
suffix:semicolon
op_star
id|tty-&gt;flip.flag_buf_ptr
op_assign
id|TTY_NORMAL
suffix:semicolon
id|up-&gt;port.icount.rx
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|r1
op_amp
(paren
id|BRK_ABRT
op_or
id|PAR_ERR
op_or
id|Rx_OVR
op_or
id|CRC_ERR
)paren
)paren
(brace
r_if
c_cond
(paren
id|r1
op_amp
id|BRK_ABRT
)paren
(brace
id|r1
op_and_assign
op_complement
(paren
id|PAR_ERR
op_or
id|CRC_ERR
)paren
suffix:semicolon
id|up-&gt;port.icount.brk
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|uart_handle_break
c_func
(paren
op_amp
id|up-&gt;port
)paren
)paren
r_continue
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|r1
op_amp
id|PAR_ERR
)paren
id|up-&gt;port.icount.parity
op_increment
suffix:semicolon
r_else
r_if
c_cond
(paren
id|r1
op_amp
id|CRC_ERR
)paren
id|up-&gt;port.icount.frame
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|r1
op_amp
id|Rx_OVR
)paren
id|up-&gt;port.icount.overrun
op_increment
suffix:semicolon
id|r1
op_and_assign
id|up-&gt;port.read_status_mask
suffix:semicolon
r_if
c_cond
(paren
id|r1
op_amp
id|BRK_ABRT
)paren
op_star
id|tty-&gt;flip.flag_buf_ptr
op_assign
id|TTY_BREAK
suffix:semicolon
r_else
r_if
c_cond
(paren
id|r1
op_amp
id|PAR_ERR
)paren
op_star
id|tty-&gt;flip.flag_buf_ptr
op_assign
id|TTY_PARITY
suffix:semicolon
r_else
r_if
c_cond
(paren
id|r1
op_amp
id|CRC_ERR
)paren
op_star
id|tty-&gt;flip.flag_buf_ptr
op_assign
id|TTY_FRAME
suffix:semicolon
)brace
r_if
c_cond
(paren
id|uart_handle_sysrq_char
c_func
(paren
op_amp
id|up-&gt;port
comma
id|ch
comma
id|regs
)paren
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|up-&gt;port.ignore_status_mask
op_eq
l_int|0xff
op_logical_or
(paren
id|r1
op_amp
id|up-&gt;port.ignore_status_mask
)paren
op_eq
l_int|0
)paren
(brace
id|tty-&gt;flip.flag_buf_ptr
op_increment
suffix:semicolon
id|tty-&gt;flip.char_buf_ptr
op_increment
suffix:semicolon
id|tty-&gt;flip.count
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|r1
op_amp
id|Rx_OVR
)paren
op_logical_and
id|tty-&gt;flip.count
OL
id|TTY_FLIPBUF_SIZE
)paren
(brace
op_star
id|tty-&gt;flip.flag_buf_ptr
op_assign
id|TTY_OVERRUN
suffix:semicolon
id|tty-&gt;flip.flag_buf_ptr
op_increment
suffix:semicolon
id|tty-&gt;flip.char_buf_ptr
op_increment
suffix:semicolon
id|tty-&gt;flip.count
op_increment
suffix:semicolon
)brace
)brace
r_return
id|tty
suffix:semicolon
)brace
DECL|function|sunzilog_status_handle
r_static
r_void
id|sunzilog_status_handle
c_func
(paren
r_struct
id|uart_sunzilog_port
op_star
id|up
comma
r_struct
id|zilog_channel
op_star
id|channel
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
r_char
id|status
suffix:semicolon
id|status
op_assign
id|sbus_readb
c_func
(paren
op_amp
id|channel-&gt;control
)paren
suffix:semicolon
id|ZSDELAY
c_func
(paren
)paren
suffix:semicolon
id|sbus_writeb
c_func
(paren
id|RES_EXT_INT
comma
op_amp
id|channel-&gt;control
)paren
suffix:semicolon
id|ZSDELAY
c_func
(paren
)paren
suffix:semicolon
id|ZS_WSYNC
c_func
(paren
id|channel
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|BRK_ABRT
)paren
(brace
r_if
c_cond
(paren
id|ZS_IS_MOUSE
c_func
(paren
id|up
)paren
)paren
id|sunzilog_kbdms_receive_chars
c_func
(paren
id|up
comma
l_int|0
comma
l_int|1
comma
id|regs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ZS_IS_CONS
c_func
(paren
id|up
)paren
)paren
(brace
multiline_comment|/* Wait for BREAK to deassert to avoid potentially&n;&t;&t;&t; * confusing the PROM.&n;&t;&t;&t; */
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|status
op_assign
id|sbus_readb
c_func
(paren
op_amp
id|channel-&gt;control
)paren
suffix:semicolon
id|ZSDELAY
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_amp
id|BRK_ABRT
)paren
)paren
r_break
suffix:semicolon
)brace
id|sun_do_break
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|ZS_WANTS_MODEM_STATUS
c_func
(paren
id|up
)paren
)paren
(brace
r_if
c_cond
(paren
id|status
op_amp
id|SYNC
)paren
id|up-&gt;port.icount.dsr
op_increment
suffix:semicolon
multiline_comment|/* The Zilog just gives us an interrupt when DCD/CTS/etc. change.&n;&t;&t; * But it does not tell us which bit has changed, we have to keep&n;&t;&t; * track of this ourselves.&n;&t;&t; */
r_if
c_cond
(paren
(paren
id|status
op_xor
id|up-&gt;prev_status
)paren
op_xor
id|DCD
)paren
id|uart_handle_dcd_change
c_func
(paren
op_amp
id|up-&gt;port
comma
(paren
id|status
op_amp
id|DCD
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_xor
id|up-&gt;prev_status
)paren
op_xor
id|CTS
)paren
id|uart_handle_cts_change
c_func
(paren
op_amp
id|up-&gt;port
comma
(paren
id|status
op_amp
id|CTS
)paren
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|up-&gt;port.info-&gt;delta_msr_wait
)paren
suffix:semicolon
)brace
id|up-&gt;prev_status
op_assign
id|status
suffix:semicolon
)brace
DECL|function|sunzilog_transmit_chars
r_static
r_void
id|sunzilog_transmit_chars
c_func
(paren
r_struct
id|uart_sunzilog_port
op_star
id|up
comma
r_struct
id|zilog_channel
op_star
id|channel
)paren
(brace
r_struct
id|circ_buf
op_star
id|xmit
suffix:semicolon
r_if
c_cond
(paren
id|ZS_IS_CONS
c_func
(paren
id|up
)paren
)paren
(brace
r_int
r_char
id|status
op_assign
id|sbus_readb
c_func
(paren
op_amp
id|channel-&gt;control
)paren
suffix:semicolon
id|ZSDELAY
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* TX still busy?  Just wait for the next TX done interrupt.&n;&t;&t; *&n;&t;&t; * It can occur because of how we do serial console writes.  It would&n;&t;&t; * be nice to transmit console writes just like we normally would for&n;&t;&t; * a TTY line. (ie. buffered and TX interrupt driven).  That is not&n;&t;&t; * easy because console writes cannot sleep.  One solution might be&n;&t;&t; * to poll on enough port-&gt;xmit space becomming free.  -DaveM&n;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_amp
id|Tx_BUF_EMP
)paren
)paren
r_return
suffix:semicolon
)brace
id|up-&gt;flags
op_and_assign
op_complement
id|SUNZILOG_FLAG_TX_ACTIVE
suffix:semicolon
r_if
c_cond
(paren
id|ZS_REGS_HELD
c_func
(paren
id|up
)paren
)paren
(brace
id|__load_zsregs
c_func
(paren
id|channel
comma
id|up-&gt;curregs
)paren
suffix:semicolon
id|up-&gt;flags
op_and_assign
op_complement
id|SUNZILOG_FLAG_REGS_HELD
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ZS_TX_STOPPED
c_func
(paren
id|up
)paren
)paren
(brace
id|up-&gt;flags
op_and_assign
op_complement
id|SUNZILOG_FLAG_TX_STOPPED
suffix:semicolon
r_goto
id|ack_tx_int
suffix:semicolon
)brace
r_if
c_cond
(paren
id|up-&gt;port.x_char
)paren
(brace
id|up-&gt;flags
op_or_assign
id|SUNZILOG_FLAG_TX_ACTIVE
suffix:semicolon
id|sbus_writeb
c_func
(paren
id|up-&gt;port.x_char
comma
op_amp
id|channel-&gt;data
)paren
suffix:semicolon
id|ZSDELAY
c_func
(paren
)paren
suffix:semicolon
id|ZS_WSYNC
c_func
(paren
id|channel
)paren
suffix:semicolon
id|up-&gt;port.icount.tx
op_increment
suffix:semicolon
id|up-&gt;port.x_char
op_assign
l_int|0
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|up-&gt;port.info
op_eq
l_int|NULL
)paren
r_goto
id|ack_tx_int
suffix:semicolon
id|xmit
op_assign
op_amp
id|up-&gt;port.info-&gt;xmit
suffix:semicolon
r_if
c_cond
(paren
id|uart_circ_empty
c_func
(paren
id|xmit
)paren
)paren
(brace
id|uart_write_wakeup
c_func
(paren
op_amp
id|up-&gt;port
)paren
suffix:semicolon
r_goto
id|ack_tx_int
suffix:semicolon
)brace
r_if
c_cond
(paren
id|uart_tx_stopped
c_func
(paren
op_amp
id|up-&gt;port
)paren
)paren
r_goto
id|ack_tx_int
suffix:semicolon
id|up-&gt;flags
op_or_assign
id|SUNZILOG_FLAG_TX_ACTIVE
suffix:semicolon
id|sbus_writeb
c_func
(paren
id|xmit-&gt;buf
(braket
id|xmit-&gt;tail
)braket
comma
op_amp
id|channel-&gt;data
)paren
suffix:semicolon
id|ZSDELAY
c_func
(paren
)paren
suffix:semicolon
id|ZS_WSYNC
c_func
(paren
id|channel
)paren
suffix:semicolon
id|xmit-&gt;tail
op_assign
(paren
id|xmit-&gt;tail
op_plus
l_int|1
)paren
op_amp
(paren
id|UART_XMIT_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
id|up-&gt;port.icount.tx
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|uart_circ_chars_pending
c_func
(paren
id|xmit
)paren
OL
id|WAKEUP_CHARS
)paren
id|uart_write_wakeup
c_func
(paren
op_amp
id|up-&gt;port
)paren
suffix:semicolon
r_return
suffix:semicolon
id|ack_tx_int
suffix:colon
id|sbus_writeb
c_func
(paren
id|RES_Tx_P
comma
op_amp
id|channel-&gt;control
)paren
suffix:semicolon
id|ZSDELAY
c_func
(paren
)paren
suffix:semicolon
id|ZS_WSYNC
c_func
(paren
id|channel
)paren
suffix:semicolon
)brace
DECL|function|sunzilog_interrupt
r_static
id|irqreturn_t
id|sunzilog_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|uart_sunzilog_port
op_star
id|up
op_assign
id|dev_id
suffix:semicolon
r_while
c_loop
(paren
id|up
)paren
(brace
r_struct
id|zilog_channel
op_star
id|channel
op_assign
id|ZILOG_CHANNEL_FROM_PORT
c_func
(paren
op_amp
id|up-&gt;port
)paren
suffix:semicolon
r_struct
id|tty_struct
op_star
id|tty
suffix:semicolon
r_int
r_char
id|r3
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|up-&gt;port.lock
)paren
suffix:semicolon
id|r3
op_assign
id|read_zsreg
c_func
(paren
id|channel
comma
id|R3
)paren
suffix:semicolon
multiline_comment|/* Channel A */
id|tty
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|r3
op_amp
(paren
id|CHAEXT
op_or
id|CHATxIP
op_or
id|CHARxIP
)paren
)paren
(brace
id|sbus_writeb
c_func
(paren
id|RES_H_IUS
comma
op_amp
id|channel-&gt;control
)paren
suffix:semicolon
id|ZSDELAY
c_func
(paren
)paren
suffix:semicolon
id|ZS_WSYNC
c_func
(paren
id|channel
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r3
op_amp
id|CHARxIP
)paren
id|tty
op_assign
id|sunzilog_receive_chars
c_func
(paren
id|up
comma
id|channel
comma
id|regs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r3
op_amp
id|CHAEXT
)paren
id|sunzilog_status_handle
c_func
(paren
id|up
comma
id|channel
comma
id|regs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r3
op_amp
id|CHATxIP
)paren
id|sunzilog_transmit_chars
c_func
(paren
id|up
comma
id|channel
)paren
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|up-&gt;port.lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tty
)paren
id|tty_flip_buffer_push
c_func
(paren
id|tty
)paren
suffix:semicolon
multiline_comment|/* Channel B */
id|up
op_assign
id|up-&gt;next
suffix:semicolon
id|channel
op_assign
id|ZILOG_CHANNEL_FROM_PORT
c_func
(paren
op_amp
id|up-&gt;port
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|up-&gt;port.lock
)paren
suffix:semicolon
id|tty
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|r3
op_amp
(paren
id|CHBEXT
op_or
id|CHBTxIP
op_or
id|CHBRxIP
)paren
)paren
(brace
id|sbus_writeb
c_func
(paren
id|RES_H_IUS
comma
op_amp
id|channel-&gt;control
)paren
suffix:semicolon
id|ZSDELAY
c_func
(paren
)paren
suffix:semicolon
id|ZS_WSYNC
c_func
(paren
id|channel
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r3
op_amp
id|CHBRxIP
)paren
id|tty
op_assign
id|sunzilog_receive_chars
c_func
(paren
id|up
comma
id|channel
comma
id|regs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r3
op_amp
id|CHBEXT
)paren
id|sunzilog_status_handle
c_func
(paren
id|up
comma
id|channel
comma
id|regs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r3
op_amp
id|CHBTxIP
)paren
id|sunzilog_transmit_chars
c_func
(paren
id|up
comma
id|channel
)paren
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|up-&gt;port.lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tty
)paren
id|tty_flip_buffer_push
c_func
(paren
id|tty
)paren
suffix:semicolon
id|up
op_assign
id|up-&gt;next
suffix:semicolon
)brace
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
multiline_comment|/* A convenient way to quickly get R0 status.  The caller must _not_ hold the&n; * port lock, it is acquired here.&n; */
DECL|function|sunzilog_read_channel_status
r_static
id|__inline__
r_int
r_char
id|sunzilog_read_channel_status
c_func
(paren
r_struct
id|uart_port
op_star
id|port
)paren
(brace
r_struct
id|zilog_channel
op_star
id|channel
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
r_char
id|status
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|port-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|channel
op_assign
id|ZILOG_CHANNEL_FROM_PORT
c_func
(paren
id|port
)paren
suffix:semicolon
id|status
op_assign
id|sbus_readb
c_func
(paren
op_amp
id|channel-&gt;control
)paren
suffix:semicolon
id|ZSDELAY
c_func
(paren
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|port-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/* The port lock is not held.  */
DECL|function|sunzilog_tx_empty
r_static
r_int
r_int
id|sunzilog_tx_empty
c_func
(paren
r_struct
id|uart_port
op_star
id|port
)paren
(brace
r_int
r_char
id|status
suffix:semicolon
r_int
r_int
id|ret
suffix:semicolon
id|status
op_assign
id|sunzilog_read_channel_status
c_func
(paren
id|port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|Tx_BUF_EMP
)paren
id|ret
op_assign
id|TIOCSER_TEMT
suffix:semicolon
r_else
id|ret
op_assign
l_int|0
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* The port lock is not held.  */
DECL|function|sunzilog_get_mctrl
r_static
r_int
r_int
id|sunzilog_get_mctrl
c_func
(paren
r_struct
id|uart_port
op_star
id|port
)paren
(brace
r_int
r_char
id|status
suffix:semicolon
r_int
r_int
id|ret
suffix:semicolon
id|status
op_assign
id|sunzilog_read_channel_status
c_func
(paren
id|port
)paren
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|DCD
)paren
id|ret
op_or_assign
id|TIOCM_CAR
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|SYNC
)paren
id|ret
op_or_assign
id|TIOCM_DSR
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|CTS
)paren
id|ret
op_or_assign
id|TIOCM_CTS
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* The port lock is held and interrupts are disabled.  */
DECL|function|sunzilog_set_mctrl
r_static
r_void
id|sunzilog_set_mctrl
c_func
(paren
r_struct
id|uart_port
op_star
id|port
comma
r_int
r_int
id|mctrl
)paren
(brace
r_struct
id|uart_sunzilog_port
op_star
id|up
op_assign
(paren
r_struct
id|uart_sunzilog_port
op_star
)paren
id|port
suffix:semicolon
r_struct
id|zilog_channel
op_star
id|channel
op_assign
id|ZILOG_CHANNEL_FROM_PORT
c_func
(paren
id|port
)paren
suffix:semicolon
r_int
r_char
id|set_bits
comma
id|clear_bits
suffix:semicolon
id|set_bits
op_assign
id|clear_bits
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|mctrl
op_amp
id|TIOCM_RTS
)paren
id|set_bits
op_or_assign
id|RTS
suffix:semicolon
r_else
id|clear_bits
op_or_assign
id|RTS
suffix:semicolon
r_if
c_cond
(paren
id|mctrl
op_amp
id|TIOCM_DTR
)paren
id|set_bits
op_or_assign
id|DTR
suffix:semicolon
r_else
id|clear_bits
op_or_assign
id|DTR
suffix:semicolon
multiline_comment|/* NOTE: Not subject to &squot;transmitter active&squot; rule.  */
id|up-&gt;curregs
(braket
id|R5
)braket
op_or_assign
id|set_bits
suffix:semicolon
id|up-&gt;curregs
(braket
id|R5
)braket
op_and_assign
op_complement
id|clear_bits
suffix:semicolon
id|write_zsreg
c_func
(paren
id|channel
comma
id|R5
comma
id|up-&gt;curregs
(braket
id|R5
)braket
)paren
suffix:semicolon
)brace
multiline_comment|/* The port lock is held and interrupts are disabled.  */
DECL|function|sunzilog_stop_tx
r_static
r_void
id|sunzilog_stop_tx
c_func
(paren
r_struct
id|uart_port
op_star
id|port
comma
r_int
r_int
id|tty_stop
)paren
(brace
r_struct
id|uart_sunzilog_port
op_star
id|up
op_assign
(paren
r_struct
id|uart_sunzilog_port
op_star
)paren
id|port
suffix:semicolon
id|up-&gt;flags
op_or_assign
id|SUNZILOG_FLAG_TX_STOPPED
suffix:semicolon
)brace
multiline_comment|/* The port lock is held and interrupts are disabled.  */
DECL|function|sunzilog_start_tx
r_static
r_void
id|sunzilog_start_tx
c_func
(paren
r_struct
id|uart_port
op_star
id|port
comma
r_int
r_int
id|tty_start
)paren
(brace
r_struct
id|uart_sunzilog_port
op_star
id|up
op_assign
(paren
r_struct
id|uart_sunzilog_port
op_star
)paren
id|port
suffix:semicolon
r_struct
id|zilog_channel
op_star
id|channel
op_assign
id|ZILOG_CHANNEL_FROM_PORT
c_func
(paren
id|port
)paren
suffix:semicolon
r_int
r_char
id|status
suffix:semicolon
id|up-&gt;flags
op_or_assign
id|SUNZILOG_FLAG_TX_ACTIVE
suffix:semicolon
id|up-&gt;flags
op_and_assign
op_complement
id|SUNZILOG_FLAG_TX_STOPPED
suffix:semicolon
id|status
op_assign
id|sbus_readb
c_func
(paren
op_amp
id|channel-&gt;control
)paren
suffix:semicolon
id|ZSDELAY
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* TX busy?  Just wait for the TX done interrupt.  */
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_amp
id|Tx_BUF_EMP
)paren
)paren
r_return
suffix:semicolon
multiline_comment|/* Send the first character to jump-start the TX done&n;&t; * IRQ sending engine.&n;&t; */
r_if
c_cond
(paren
id|port-&gt;x_char
)paren
(brace
id|sbus_writeb
c_func
(paren
id|port-&gt;x_char
comma
op_amp
id|channel-&gt;data
)paren
suffix:semicolon
id|ZSDELAY
c_func
(paren
)paren
suffix:semicolon
id|ZS_WSYNC
c_func
(paren
id|channel
)paren
suffix:semicolon
id|port-&gt;icount.tx
op_increment
suffix:semicolon
id|port-&gt;x_char
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
r_struct
id|circ_buf
op_star
id|xmit
op_assign
op_amp
id|port-&gt;info-&gt;xmit
suffix:semicolon
id|sbus_writeb
c_func
(paren
id|xmit-&gt;buf
(braket
id|xmit-&gt;tail
)braket
comma
op_amp
id|channel-&gt;data
)paren
suffix:semicolon
id|ZSDELAY
c_func
(paren
)paren
suffix:semicolon
id|ZS_WSYNC
c_func
(paren
id|channel
)paren
suffix:semicolon
id|xmit-&gt;tail
op_assign
(paren
id|xmit-&gt;tail
op_plus
l_int|1
)paren
op_amp
(paren
id|UART_XMIT_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
id|port-&gt;icount.tx
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|uart_circ_chars_pending
c_func
(paren
id|xmit
)paren
OL
id|WAKEUP_CHARS
)paren
id|uart_write_wakeup
c_func
(paren
op_amp
id|up-&gt;port
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* The port lock is held.  */
DECL|function|sunzilog_stop_rx
r_static
r_void
id|sunzilog_stop_rx
c_func
(paren
r_struct
id|uart_port
op_star
id|port
)paren
(brace
r_struct
id|uart_sunzilog_port
op_star
id|up
op_assign
id|UART_ZILOG
c_func
(paren
id|port
)paren
suffix:semicolon
r_struct
id|zilog_channel
op_star
id|channel
suffix:semicolon
r_if
c_cond
(paren
id|ZS_IS_CONS
c_func
(paren
id|up
)paren
)paren
r_return
suffix:semicolon
id|channel
op_assign
id|ZILOG_CHANNEL_FROM_PORT
c_func
(paren
id|port
)paren
suffix:semicolon
multiline_comment|/* Disable all RX interrupts.  */
id|up-&gt;curregs
(braket
id|R1
)braket
op_and_assign
op_complement
id|RxINT_MASK
suffix:semicolon
id|sunzilog_maybe_update_regs
c_func
(paren
id|up
comma
id|channel
)paren
suffix:semicolon
)brace
multiline_comment|/* The port lock is held.  */
DECL|function|sunzilog_enable_ms
r_static
r_void
id|sunzilog_enable_ms
c_func
(paren
r_struct
id|uart_port
op_star
id|port
)paren
(brace
r_struct
id|uart_sunzilog_port
op_star
id|up
op_assign
(paren
r_struct
id|uart_sunzilog_port
op_star
)paren
id|port
suffix:semicolon
r_struct
id|zilog_channel
op_star
id|channel
op_assign
id|ZILOG_CHANNEL_FROM_PORT
c_func
(paren
id|port
)paren
suffix:semicolon
r_int
r_char
id|new_reg
suffix:semicolon
id|new_reg
op_assign
id|up-&gt;curregs
(braket
id|R15
)braket
op_or
(paren
id|DCDIE
op_or
id|SYNCIE
op_or
id|CTSIE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|new_reg
op_ne
id|up-&gt;curregs
(braket
id|R15
)braket
)paren
(brace
id|up-&gt;curregs
(braket
id|R15
)braket
op_assign
id|new_reg
suffix:semicolon
multiline_comment|/* NOTE: Not subject to &squot;transmitter active&squot; rule.  */
id|write_zsreg
c_func
(paren
id|channel
comma
id|R15
comma
id|up-&gt;curregs
(braket
id|R15
)braket
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* The port lock is not held.  */
DECL|function|sunzilog_break_ctl
r_static
r_void
id|sunzilog_break_ctl
c_func
(paren
r_struct
id|uart_port
op_star
id|port
comma
r_int
id|break_state
)paren
(brace
r_struct
id|uart_sunzilog_port
op_star
id|up
op_assign
(paren
r_struct
id|uart_sunzilog_port
op_star
)paren
id|port
suffix:semicolon
r_struct
id|zilog_channel
op_star
id|channel
op_assign
id|ZILOG_CHANNEL_FROM_PORT
c_func
(paren
id|port
)paren
suffix:semicolon
r_int
r_char
id|set_bits
comma
id|clear_bits
comma
id|new_reg
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|set_bits
op_assign
id|clear_bits
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|break_state
)paren
id|set_bits
op_or_assign
id|SND_BRK
suffix:semicolon
r_else
id|clear_bits
op_or_assign
id|SND_BRK
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|port-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|new_reg
op_assign
(paren
id|up-&gt;curregs
(braket
id|R5
)braket
op_or
id|set_bits
)paren
op_amp
op_complement
id|clear_bits
suffix:semicolon
r_if
c_cond
(paren
id|new_reg
op_ne
id|up-&gt;curregs
(braket
id|R5
)braket
)paren
(brace
id|up-&gt;curregs
(braket
id|R5
)braket
op_assign
id|new_reg
suffix:semicolon
multiline_comment|/* NOTE: Not subject to &squot;transmitter active&squot; rule.  */
id|write_zsreg
c_func
(paren
id|channel
comma
id|R5
comma
id|up-&gt;curregs
(braket
id|R5
)braket
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|port-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|__sunzilog_startup
r_static
r_void
id|__sunzilog_startup
c_func
(paren
r_struct
id|uart_sunzilog_port
op_star
id|up
)paren
(brace
r_struct
id|zilog_channel
op_star
id|channel
suffix:semicolon
id|channel
op_assign
id|ZILOG_CHANNEL_FROM_PORT
c_func
(paren
op_amp
id|up-&gt;port
)paren
suffix:semicolon
id|up-&gt;prev_status
op_assign
id|sbus_readb
c_func
(paren
op_amp
id|channel-&gt;control
)paren
suffix:semicolon
multiline_comment|/* Enable receiver and transmitter.  */
id|up-&gt;curregs
(braket
id|R3
)braket
op_or_assign
id|RxENAB
suffix:semicolon
id|up-&gt;curregs
(braket
id|R5
)braket
op_or_assign
id|TxENAB
suffix:semicolon
id|up-&gt;curregs
(braket
id|R1
)braket
op_or_assign
id|EXT_INT_ENAB
op_or
id|INT_ALL_Rx
op_or
id|TxINT_ENAB
suffix:semicolon
id|sunzilog_maybe_update_regs
c_func
(paren
id|up
comma
id|channel
)paren
suffix:semicolon
)brace
DECL|function|sunzilog_startup
r_static
r_int
id|sunzilog_startup
c_func
(paren
r_struct
id|uart_port
op_star
id|port
)paren
(brace
r_struct
id|uart_sunzilog_port
op_star
id|up
op_assign
id|UART_ZILOG
c_func
(paren
id|port
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|ZS_IS_CONS
c_func
(paren
id|up
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|port-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|__sunzilog_startup
c_func
(paren
id|up
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|port-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * The test for ZS_IS_CONS is explained by the following e-mail:&n; *****&n; * From: Russell King &lt;rmk@arm.linux.org.uk&gt;&n; * Date: Sun, 8 Dec 2002 10:18:38 +0000&n; *&n; * On Sun, Dec 08, 2002 at 02:43:36AM -0500, Pete Zaitcev wrote:&n; * &gt; I boot my 2.5 boxes using &quot;console=ttyS0,9600&quot; argument,&n; * &gt; and I noticed that something is not right with reference&n; * &gt; counting in this case. It seems that when the console&n; * &gt; is open by kernel initially, this is not accounted&n; * &gt; as an open, and uart_startup is not called.&n; *&n; * That is correct.  We are unable to call uart_startup when the serial&n; * console is initialised because it may need to allocate memory (as&n; * request_irq does) and the memory allocators may not have been&n; * initialised.&n; *&n; * 1. initialise the port into a state where it can send characters in the&n; *    console write method.&n; *&n; * 2. don&squot;t do the actual hardware shutdown in your shutdown() method (but&n; *    do the normal software shutdown - ie, free irqs etc)&n; *****&n; */
DECL|function|sunzilog_shutdown
r_static
r_void
id|sunzilog_shutdown
c_func
(paren
r_struct
id|uart_port
op_star
id|port
)paren
(brace
r_struct
id|uart_sunzilog_port
op_star
id|up
op_assign
id|UART_ZILOG
c_func
(paren
id|port
)paren
suffix:semicolon
r_struct
id|zilog_channel
op_star
id|channel
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|ZS_IS_CONS
c_func
(paren
id|up
)paren
)paren
r_return
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|port-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|channel
op_assign
id|ZILOG_CHANNEL_FROM_PORT
c_func
(paren
id|port
)paren
suffix:semicolon
multiline_comment|/* Disable receiver and transmitter.  */
id|up-&gt;curregs
(braket
id|R3
)braket
op_and_assign
op_complement
id|RxENAB
suffix:semicolon
id|up-&gt;curregs
(braket
id|R5
)braket
op_and_assign
op_complement
id|TxENAB
suffix:semicolon
multiline_comment|/* Disable all interrupts and BRK assertion.  */
id|up-&gt;curregs
(braket
id|R1
)braket
op_and_assign
op_complement
(paren
id|EXT_INT_ENAB
op_or
id|TxINT_ENAB
op_or
id|RxINT_MASK
)paren
suffix:semicolon
id|up-&gt;curregs
(braket
id|R5
)braket
op_and_assign
op_complement
id|SND_BRK
suffix:semicolon
id|sunzilog_maybe_update_regs
c_func
(paren
id|up
comma
id|channel
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|port-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* Shared by TTY driver and serial console setup.  The port lock is held&n; * and local interrupts are disabled.&n; */
r_static
r_void
DECL|function|sunzilog_convert_to_zs
id|sunzilog_convert_to_zs
c_func
(paren
r_struct
id|uart_sunzilog_port
op_star
id|up
comma
r_int
r_int
id|cflag
comma
r_int
r_int
id|iflag
comma
r_int
id|brg
)paren
(brace
id|up-&gt;curregs
(braket
id|R10
)braket
op_assign
id|NRZ
suffix:semicolon
id|up-&gt;curregs
(braket
id|R11
)braket
op_assign
id|TCBR
op_or
id|RCBR
suffix:semicolon
multiline_comment|/* Program BAUD and clock source. */
id|up-&gt;curregs
(braket
id|R4
)braket
op_and_assign
op_complement
id|XCLK_MASK
suffix:semicolon
id|up-&gt;curregs
(braket
id|R4
)braket
op_or_assign
id|X16CLK
suffix:semicolon
id|up-&gt;curregs
(braket
id|R12
)braket
op_assign
id|brg
op_amp
l_int|0xff
suffix:semicolon
id|up-&gt;curregs
(braket
id|R13
)braket
op_assign
(paren
id|brg
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
id|up-&gt;curregs
(braket
id|R14
)braket
op_assign
id|BRSRC
op_or
id|BRENAB
suffix:semicolon
multiline_comment|/* Character size, stop bits, and parity. */
id|up-&gt;curregs
(braket
l_int|3
)braket
op_and_assign
op_complement
id|RxN_MASK
suffix:semicolon
id|up-&gt;curregs
(braket
l_int|5
)braket
op_and_assign
op_complement
id|TxN_MASK
suffix:semicolon
r_switch
c_cond
(paren
id|cflag
op_amp
id|CSIZE
)paren
(brace
r_case
id|CS5
suffix:colon
id|up-&gt;curregs
(braket
l_int|3
)braket
op_or_assign
id|Rx5
suffix:semicolon
id|up-&gt;curregs
(braket
l_int|5
)braket
op_or_assign
id|Tx5
suffix:semicolon
id|up-&gt;parity_mask
op_assign
l_int|0x1f
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS6
suffix:colon
id|up-&gt;curregs
(braket
l_int|3
)braket
op_or_assign
id|Rx6
suffix:semicolon
id|up-&gt;curregs
(braket
l_int|5
)braket
op_or_assign
id|Tx6
suffix:semicolon
id|up-&gt;parity_mask
op_assign
l_int|0x3f
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS7
suffix:colon
id|up-&gt;curregs
(braket
l_int|3
)braket
op_or_assign
id|Rx7
suffix:semicolon
id|up-&gt;curregs
(braket
l_int|5
)braket
op_or_assign
id|Tx7
suffix:semicolon
id|up-&gt;parity_mask
op_assign
l_int|0x7f
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS8
suffix:colon
r_default
suffix:colon
id|up-&gt;curregs
(braket
l_int|3
)braket
op_or_assign
id|Rx8
suffix:semicolon
id|up-&gt;curregs
(braket
l_int|5
)braket
op_or_assign
id|Tx8
suffix:semicolon
id|up-&gt;parity_mask
op_assign
l_int|0xff
suffix:semicolon
r_break
suffix:semicolon
)brace
suffix:semicolon
id|up-&gt;curregs
(braket
l_int|4
)braket
op_and_assign
op_complement
l_int|0x0c
suffix:semicolon
r_if
c_cond
(paren
id|cflag
op_amp
id|CSTOPB
)paren
id|up-&gt;curregs
(braket
l_int|4
)braket
op_or_assign
id|SB2
suffix:semicolon
r_else
id|up-&gt;curregs
(braket
l_int|4
)braket
op_or_assign
id|SB1
suffix:semicolon
r_if
c_cond
(paren
id|cflag
op_amp
id|PARENB
)paren
id|up-&gt;curregs
(braket
l_int|4
)braket
op_or_assign
id|PAR_ENAB
suffix:semicolon
r_else
id|up-&gt;curregs
(braket
l_int|4
)braket
op_and_assign
op_complement
id|PAR_ENAB
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|cflag
op_amp
id|PARODD
)paren
)paren
id|up-&gt;curregs
(braket
l_int|4
)braket
op_or_assign
id|PAR_EVEN
suffix:semicolon
r_else
id|up-&gt;curregs
(braket
l_int|4
)braket
op_and_assign
op_complement
id|PAR_EVEN
suffix:semicolon
id|up-&gt;port.read_status_mask
op_assign
id|Rx_OVR
suffix:semicolon
r_if
c_cond
(paren
id|iflag
op_amp
id|INPCK
)paren
id|up-&gt;port.read_status_mask
op_or_assign
id|CRC_ERR
op_or
id|PAR_ERR
suffix:semicolon
r_if
c_cond
(paren
id|iflag
op_amp
(paren
id|BRKINT
op_or
id|PARMRK
)paren
)paren
id|up-&gt;port.read_status_mask
op_or_assign
id|BRK_ABRT
suffix:semicolon
id|up-&gt;port.ignore_status_mask
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|iflag
op_amp
id|IGNPAR
)paren
id|up-&gt;port.ignore_status_mask
op_or_assign
id|CRC_ERR
op_or
id|PAR_ERR
suffix:semicolon
r_if
c_cond
(paren
id|iflag
op_amp
id|IGNBRK
)paren
(brace
id|up-&gt;port.ignore_status_mask
op_or_assign
id|BRK_ABRT
suffix:semicolon
r_if
c_cond
(paren
id|iflag
op_amp
id|IGNPAR
)paren
id|up-&gt;port.ignore_status_mask
op_or_assign
id|Rx_OVR
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|cflag
op_amp
id|CREAD
)paren
op_eq
l_int|0
)paren
id|up-&gt;port.ignore_status_mask
op_assign
l_int|0xff
suffix:semicolon
)brace
multiline_comment|/* The port lock is not held.  */
r_static
r_void
DECL|function|sunzilog_set_termios
id|sunzilog_set_termios
c_func
(paren
r_struct
id|uart_port
op_star
id|port
comma
r_struct
id|termios
op_star
id|termios
comma
r_struct
id|termios
op_star
id|old
)paren
(brace
r_struct
id|uart_sunzilog_port
op_star
id|up
op_assign
(paren
r_struct
id|uart_sunzilog_port
op_star
)paren
id|port
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|baud
comma
id|brg
suffix:semicolon
id|baud
op_assign
id|uart_get_baud_rate
c_func
(paren
id|port
comma
id|termios
comma
id|old
comma
l_int|1200
comma
l_int|76800
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|up-&gt;port.lock
comma
id|flags
)paren
suffix:semicolon
id|brg
op_assign
id|BPS_TO_BRG
c_func
(paren
id|baud
comma
id|ZS_CLOCK
op_div
id|ZS_CLOCK_DIVISOR
)paren
suffix:semicolon
id|sunzilog_convert_to_zs
c_func
(paren
id|up
comma
id|termios-&gt;c_cflag
comma
id|termios-&gt;c_iflag
comma
id|brg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|UART_ENABLE_MS
c_func
(paren
op_amp
id|up-&gt;port
comma
id|termios-&gt;c_cflag
)paren
)paren
id|up-&gt;flags
op_or_assign
id|SUNZILOG_FLAG_MODEM_STATUS
suffix:semicolon
r_else
id|up-&gt;flags
op_and_assign
op_complement
id|SUNZILOG_FLAG_MODEM_STATUS
suffix:semicolon
id|up-&gt;cflag
op_assign
id|termios-&gt;c_cflag
suffix:semicolon
id|sunzilog_maybe_update_regs
c_func
(paren
id|up
comma
id|ZILOG_CHANNEL_FROM_PORT
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|up-&gt;port.lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|sunzilog_type
r_static
r_const
r_char
op_star
id|sunzilog_type
c_func
(paren
r_struct
id|uart_port
op_star
id|port
)paren
(brace
r_return
l_string|&quot;SunZilog&quot;
suffix:semicolon
)brace
multiline_comment|/* We do not request/release mappings of the registers here, this&n; * happens at early serial probe time.&n; */
DECL|function|sunzilog_release_port
r_static
r_void
id|sunzilog_release_port
c_func
(paren
r_struct
id|uart_port
op_star
id|port
)paren
(brace
)brace
DECL|function|sunzilog_request_port
r_static
r_int
id|sunzilog_request_port
c_func
(paren
r_struct
id|uart_port
op_star
id|port
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* These do not need to do anything interesting either.  */
DECL|function|sunzilog_config_port
r_static
r_void
id|sunzilog_config_port
c_func
(paren
r_struct
id|uart_port
op_star
id|port
comma
r_int
id|flags
)paren
(brace
)brace
multiline_comment|/* We do not support letting the user mess with the divisor, IRQ, etc. */
DECL|function|sunzilog_verify_port
r_static
r_int
id|sunzilog_verify_port
c_func
(paren
r_struct
id|uart_port
op_star
id|port
comma
r_struct
id|serial_struct
op_star
id|ser
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|variable|sunzilog_pops
r_static
r_struct
id|uart_ops
id|sunzilog_pops
op_assign
(brace
dot
id|tx_empty
op_assign
id|sunzilog_tx_empty
comma
dot
id|set_mctrl
op_assign
id|sunzilog_set_mctrl
comma
dot
id|get_mctrl
op_assign
id|sunzilog_get_mctrl
comma
dot
id|stop_tx
op_assign
id|sunzilog_stop_tx
comma
dot
id|start_tx
op_assign
id|sunzilog_start_tx
comma
dot
id|stop_rx
op_assign
id|sunzilog_stop_rx
comma
dot
id|enable_ms
op_assign
id|sunzilog_enable_ms
comma
dot
id|break_ctl
op_assign
id|sunzilog_break_ctl
comma
dot
id|startup
op_assign
id|sunzilog_startup
comma
dot
id|shutdown
op_assign
id|sunzilog_shutdown
comma
dot
id|set_termios
op_assign
id|sunzilog_set_termios
comma
dot
id|type
op_assign
id|sunzilog_type
comma
dot
id|release_port
op_assign
id|sunzilog_release_port
comma
dot
id|request_port
op_assign
id|sunzilog_request_port
comma
dot
id|config_port
op_assign
id|sunzilog_config_port
comma
dot
id|verify_port
op_assign
id|sunzilog_verify_port
comma
)brace
suffix:semicolon
DECL|variable|sunzilog_port_table
r_static
r_struct
id|uart_sunzilog_port
op_star
id|sunzilog_port_table
suffix:semicolon
DECL|variable|sunzilog_chip_regs
r_static
r_struct
id|zilog_layout
op_star
op_star
id|sunzilog_chip_regs
suffix:semicolon
DECL|variable|sunzilog_irq_chain
r_static
r_struct
id|uart_sunzilog_port
op_star
id|sunzilog_irq_chain
suffix:semicolon
DECL|variable|zilog_irq
r_static
r_int
id|zilog_irq
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|variable|sunzilog_reg
r_static
r_struct
id|uart_driver
id|sunzilog_reg
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|driver_name
op_assign
l_string|&quot;ttyS&quot;
comma
dot
id|devfs_name
op_assign
l_string|&quot;tts/&quot;
comma
dot
id|dev_name
op_assign
l_string|&quot;ttyS&quot;
comma
dot
id|major
op_assign
id|TTY_MAJOR
comma
)brace
suffix:semicolon
DECL|function|alloc_one_table
r_static
r_void
op_star
id|__init
id|alloc_one_table
c_func
(paren
r_int
r_int
id|size
)paren
(brace
r_void
op_star
id|ret
suffix:semicolon
id|ret
op_assign
id|kmalloc
c_func
(paren
id|size
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ne
l_int|NULL
)paren
id|memset
c_func
(paren
id|ret
comma
l_int|0
comma
id|size
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|sunzilog_alloc_tables
r_static
r_void
id|__init
id|sunzilog_alloc_tables
c_func
(paren
r_void
)paren
(brace
id|sunzilog_port_table
op_assign
(paren
r_struct
id|uart_sunzilog_port
op_star
)paren
id|alloc_one_table
c_func
(paren
id|NUM_CHANNELS
op_star
r_sizeof
(paren
r_struct
id|uart_sunzilog_port
)paren
)paren
suffix:semicolon
id|sunzilog_chip_regs
op_assign
(paren
r_struct
id|zilog_layout
op_star
op_star
)paren
id|alloc_one_table
c_func
(paren
id|NUM_SUNZILOG
op_star
r_sizeof
(paren
r_struct
id|zilog_layout
op_star
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sunzilog_port_table
op_eq
l_int|NULL
op_logical_or
id|sunzilog_chip_regs
op_eq
l_int|NULL
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;SunZilog: Cannot allocate tables.&bslash;n&quot;
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
macro_line|#ifdef CONFIG_SPARC64
multiline_comment|/* We used to attempt to use the address property of the Zilog device node&n; * but that totally is not necessary on sparc64.&n; */
DECL|function|get_zs_sun4u
r_static
r_struct
id|zilog_layout
op_star
id|__init
id|get_zs_sun4u
c_func
(paren
r_int
id|chip
comma
r_int
id|zsnode
)paren
(brace
r_int
r_int
id|mapped_addr
suffix:semicolon
r_int
r_int
id|sun4u_ino
suffix:semicolon
r_struct
id|sbus_bus
op_star
id|sbus
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|sbus_dev
op_star
id|sdev
op_assign
l_int|NULL
suffix:semicolon
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
id|central_bus
op_eq
l_int|NULL
)paren
(brace
id|for_each_sbus
c_func
(paren
id|sbus
)paren
(brace
id|for_each_sbusdev
c_func
(paren
id|sdev
comma
id|sbus
)paren
(brace
r_if
c_cond
(paren
id|sdev-&gt;prom_node
op_eq
id|zsnode
)paren
r_goto
id|found
suffix:semicolon
)brace
)brace
)brace
id|found
suffix:colon
r_if
c_cond
(paren
id|sdev
op_eq
l_int|NULL
op_logical_and
id|central_bus
op_eq
l_int|NULL
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;SunZilog: sdev&amp;&amp;central == NULL for &quot;
l_string|&quot;Zilog %d in get_zs_sun4u.&bslash;n&quot;
comma
id|chip
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|central_bus
op_eq
l_int|NULL
)paren
(brace
id|mapped_addr
op_assign
id|sbus_ioremap
c_func
(paren
op_amp
id|sdev-&gt;resource
(braket
l_int|0
)braket
comma
l_int|0
comma
id|PAGE_SIZE
comma
l_string|&quot;Zilog Registers&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
r_struct
id|linux_prom_registers
id|zsregs
(braket
l_int|1
)braket
suffix:semicolon
id|err
op_assign
id|prom_getproperty
c_func
(paren
id|zsnode
comma
l_string|&quot;reg&quot;
comma
(paren
r_char
op_star
)paren
op_amp
id|zsregs
(braket
l_int|0
)braket
comma
r_sizeof
(paren
id|zsregs
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_eq
op_minus
l_int|1
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;SunZilog: Cannot map &quot;
l_string|&quot;Zilog %d regs on &quot;
l_string|&quot;central bus.&bslash;n&quot;
comma
id|chip
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
id|apply_fhc_ranges
c_func
(paren
id|central_bus-&gt;child
comma
op_amp
id|zsregs
(braket
l_int|0
)braket
comma
l_int|1
)paren
suffix:semicolon
id|apply_central_ranges
c_func
(paren
id|central_bus
comma
op_amp
id|zsregs
(braket
l_int|0
)braket
comma
l_int|1
)paren
suffix:semicolon
id|mapped_addr
op_assign
(paren
(paren
(paren
id|u64
)paren
id|zsregs
(braket
l_int|0
)braket
dot
id|which_io
)paren
op_lshift
l_int|32UL
)paren
op_or
(paren
(paren
id|u64
)paren
id|zsregs
(braket
l_int|0
)braket
dot
id|phys_addr
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|zilog_irq
op_eq
op_minus
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|central_bus
)paren
(brace
r_int
r_int
id|iclr
comma
id|imap
suffix:semicolon
id|iclr
op_assign
id|central_bus-&gt;child-&gt;fhc_regs.uregs
op_plus
id|FHC_UREGS_ICLR
suffix:semicolon
id|imap
op_assign
id|central_bus-&gt;child-&gt;fhc_regs.uregs
op_plus
id|FHC_UREGS_IMAP
suffix:semicolon
id|zilog_irq
op_assign
id|build_irq
c_func
(paren
l_int|12
comma
l_int|0
comma
id|iclr
comma
id|imap
)paren
suffix:semicolon
)brace
r_else
(brace
id|err
op_assign
id|prom_getproperty
c_func
(paren
id|zsnode
comma
l_string|&quot;interrupts&quot;
comma
(paren
r_char
op_star
)paren
op_amp
id|sun4u_ino
comma
r_sizeof
(paren
id|sun4u_ino
)paren
)paren
suffix:semicolon
id|zilog_irq
op_assign
id|sbus_build_irq
c_func
(paren
id|sbus_root
comma
id|sun4u_ino
)paren
suffix:semicolon
)brace
)brace
r_return
(paren
r_struct
id|zilog_layout
op_star
)paren
id|mapped_addr
suffix:semicolon
)brace
macro_line|#else /* CONFIG_SPARC64 */
multiline_comment|/*&n; * XXX The sun4d case is utterly screwed: it tries to re-walk the tree&n; * (for the 3rd time) in order to find bootbus and cpu. Streamline it.&n; */
DECL|function|get_zs_sun4cmd
r_static
r_struct
id|zilog_layout
op_star
id|__init
id|get_zs_sun4cmd
c_func
(paren
r_int
id|chip
comma
r_int
id|node
)paren
(brace
r_struct
id|linux_prom_irqs
id|irq_info
(braket
l_int|2
)braket
suffix:semicolon
r_int
r_int
id|mapped_addr
op_assign
l_int|0
suffix:semicolon
r_int
id|zsnode
comma
id|cpunode
comma
id|bbnode
suffix:semicolon
r_struct
id|linux_prom_registers
id|zsreg
(braket
l_int|4
)braket
suffix:semicolon
r_struct
id|resource
id|res
suffix:semicolon
r_if
c_cond
(paren
id|sparc_cpu_model
op_eq
id|sun4d
)paren
(brace
r_int
id|walk
suffix:semicolon
id|zsnode
op_assign
l_int|0
suffix:semicolon
id|bbnode
op_assign
l_int|0
suffix:semicolon
id|cpunode
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|walk
op_assign
id|prom_getchild
c_func
(paren
id|prom_root_node
)paren
suffix:semicolon
(paren
id|walk
op_assign
id|prom_searchsiblings
c_func
(paren
id|walk
comma
l_string|&quot;cpu-unit&quot;
)paren
)paren
op_ne
l_int|0
suffix:semicolon
id|walk
op_assign
id|prom_getsibling
c_func
(paren
id|walk
)paren
)paren
(brace
id|bbnode
op_assign
id|prom_getchild
c_func
(paren
id|walk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bbnode
op_logical_and
(paren
id|bbnode
op_assign
id|prom_searchsiblings
c_func
(paren
id|bbnode
comma
l_string|&quot;bootbus&quot;
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|zsnode
op_assign
id|prom_getchild
c_func
(paren
id|bbnode
)paren
)paren
op_eq
id|node
)paren
(brace
id|cpunode
op_assign
id|walk
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|walk
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;SunZilog: Cannot find the %d&squot;th bootbus on sun4d.&bslash;n&quot;
comma
(paren
id|chip
op_div
l_int|2
)paren
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|prom_getproperty
c_func
(paren
id|zsnode
comma
l_string|&quot;reg&quot;
comma
(paren
r_char
op_star
)paren
id|zsreg
comma
r_sizeof
(paren
id|zsreg
)paren
)paren
op_eq
op_minus
l_int|1
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;SunZilog: Cannot map Zilog %d&bslash;n&quot;
comma
id|chip
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* XXX Looks like an off by one? */
id|prom_apply_generic_ranges
c_func
(paren
id|bbnode
comma
id|cpunode
comma
id|zsreg
comma
l_int|1
)paren
suffix:semicolon
id|res.start
op_assign
id|zsreg
(braket
l_int|0
)braket
dot
id|phys_addr
suffix:semicolon
id|res.end
op_assign
id|res.start
op_plus
(paren
l_int|8
op_minus
l_int|1
)paren
suffix:semicolon
id|res.flags
op_assign
id|zsreg
(braket
l_int|0
)braket
dot
id|which_io
op_or
id|IORESOURCE_IO
suffix:semicolon
id|mapped_addr
op_assign
id|sbus_ioremap
c_func
(paren
op_amp
id|res
comma
l_int|0
comma
l_int|8
comma
l_string|&quot;Zilog Serial&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|zsnode
op_assign
id|node
suffix:semicolon
macro_line|#if 0 /* XXX When was this used? */
r_if
c_cond
(paren
id|prom_getintdefault
c_func
(paren
id|zsnode
comma
l_string|&quot;slave&quot;
comma
op_minus
l_int|1
)paren
op_ne
id|chipid
)paren
(brace
id|zsnode
op_assign
id|prom_getsibling
c_func
(paren
id|zsnode
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n;&t;&t; * &quot;address&quot; is only present on ports that OBP opened&n;&t;&t; * (from Mitch Bradley&squot;s &quot;Hitchhiker&squot;s Guide to OBP&quot;).&n;&t;&t; * We do not use it.&n;&t;&t; */
r_if
c_cond
(paren
id|prom_getproperty
c_func
(paren
id|zsnode
comma
l_string|&quot;reg&quot;
comma
(paren
r_char
op_star
)paren
id|zsreg
comma
r_sizeof
(paren
id|zsreg
)paren
)paren
op_eq
op_minus
l_int|1
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;SunZilog: Cannot map Zilog %d&bslash;n&quot;
comma
id|chip
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sparc_cpu_model
op_eq
id|sun4m
)paren
multiline_comment|/* Crude. Pass parent. XXX */
id|prom_apply_obio_ranges
c_func
(paren
id|zsreg
comma
l_int|1
)paren
suffix:semicolon
id|res.start
op_assign
id|zsreg
(braket
l_int|0
)braket
dot
id|phys_addr
suffix:semicolon
id|res.end
op_assign
id|res.start
op_plus
(paren
l_int|8
op_minus
l_int|1
)paren
suffix:semicolon
id|res.flags
op_assign
id|zsreg
(braket
l_int|0
)braket
dot
id|which_io
op_or
id|IORESOURCE_IO
suffix:semicolon
id|mapped_addr
op_assign
id|sbus_ioremap
c_func
(paren
op_amp
id|res
comma
l_int|0
comma
l_int|8
comma
l_string|&quot;Zilog Serial&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|prom_getproperty
c_func
(paren
id|zsnode
comma
l_string|&quot;intr&quot;
comma
(paren
r_char
op_star
)paren
id|irq_info
comma
r_sizeof
(paren
id|irq_info
)paren
)paren
op_mod
r_sizeof
(paren
r_struct
id|linux_prom_irqs
)paren
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;SunZilog: Cannot get IRQ property for Zilog %d.&bslash;n&quot;
comma
id|chip
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|zilog_irq
op_eq
op_minus
l_int|1
)paren
(brace
id|zilog_irq
op_assign
id|irq_info
(braket
l_int|0
)braket
dot
id|pri
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|zilog_irq
op_ne
id|irq_info
(braket
l_int|0
)braket
dot
id|pri
)paren
(brace
multiline_comment|/* XXX. Dumb. Should handle per-chip IRQ, for add-ons. */
id|prom_printf
c_func
(paren
l_string|&quot;SunZilog: Inconsistent IRQ layout for Zilog %d.&bslash;n&quot;
comma
id|chip
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
r_return
(paren
r_struct
id|zilog_layout
op_star
)paren
id|mapped_addr
suffix:semicolon
)brace
macro_line|#endif /* !(CONFIG_SPARC64) */
multiline_comment|/* Get the address of the registers for SunZilog instance CHIP.  */
DECL|function|get_zs
r_static
r_struct
id|zilog_layout
op_star
id|__init
id|get_zs
c_func
(paren
r_int
id|chip
comma
r_int
id|node
)paren
(brace
r_if
c_cond
(paren
id|chip
OL
l_int|0
op_logical_or
id|chip
op_ge
id|NUM_SUNZILOG
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;SunZilog: Illegal chip number %d in get_zs.&bslash;n&quot;
comma
id|chip
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_SPARC64
r_return
id|get_zs_sun4u
c_func
(paren
id|chip
comma
id|node
)paren
suffix:semicolon
macro_line|#else
r_if
c_cond
(paren
id|sparc_cpu_model
op_eq
id|sun4
)paren
(brace
r_struct
id|resource
id|res
suffix:semicolon
multiline_comment|/* Not probe-able, hard code it. */
r_switch
c_cond
(paren
id|chip
)paren
(brace
r_case
l_int|0
suffix:colon
id|res.start
op_assign
l_int|0xf1000000
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|res.start
op_assign
l_int|0xf0000000
suffix:semicolon
r_break
suffix:semicolon
)brace
suffix:semicolon
id|zilog_irq
op_assign
l_int|12
suffix:semicolon
id|res.end
op_assign
(paren
id|res.start
op_plus
(paren
l_int|8
op_minus
l_int|1
)paren
)paren
suffix:semicolon
id|res.flags
op_assign
id|IORESOURCE_IO
suffix:semicolon
r_return
(paren
r_struct
id|zilog_layout
op_star
)paren
id|sbus_ioremap
c_func
(paren
op_amp
id|res
comma
l_int|0
comma
l_int|8
comma
l_string|&quot;SunZilog&quot;
)paren
suffix:semicolon
)brace
r_return
id|get_zs_sun4cmd
c_func
(paren
id|chip
comma
id|node
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|macro|ZS_PUT_CHAR_MAX_DELAY
mdefine_line|#define ZS_PUT_CHAR_MAX_DELAY&t;2000&t;/* 10 ms */
DECL|function|sunzilog_put_char
r_static
r_void
id|sunzilog_put_char
c_func
(paren
r_struct
id|zilog_channel
op_star
id|channel
comma
r_int
r_char
id|ch
)paren
(brace
r_int
id|loops
op_assign
id|ZS_PUT_CHAR_MAX_DELAY
suffix:semicolon
multiline_comment|/* This is a timed polling loop so do not switch the explicit&n;&t; * udelay with ZSDELAY as that is a NOP on some platforms.  -DaveM&n;&t; */
r_do
(brace
r_int
r_char
id|val
op_assign
id|sbus_readb
c_func
(paren
op_amp
id|channel-&gt;control
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val
op_amp
id|Tx_BUF_EMP
)paren
(brace
id|ZSDELAY
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
op_decrement
id|loops
)paren
suffix:semicolon
id|sbus_writeb
c_func
(paren
id|ch
comma
op_amp
id|channel-&gt;data
)paren
suffix:semicolon
id|ZSDELAY
c_func
(paren
)paren
suffix:semicolon
id|ZS_WSYNC
c_func
(paren
id|channel
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_SERIO
DECL|variable|sunzilog_serio_lock
r_static
id|spinlock_t
id|sunzilog_serio_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
DECL|function|sunzilog_serio_write
r_static
r_int
id|sunzilog_serio_write
c_func
(paren
r_struct
id|serio
op_star
id|serio
comma
r_int
r_char
id|ch
)paren
(brace
r_struct
id|uart_sunzilog_port
op_star
id|up
op_assign
id|serio-&gt;driver
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|sunzilog_serio_lock
comma
id|flags
)paren
suffix:semicolon
id|sunzilog_put_char
c_func
(paren
id|ZILOG_CHANNEL_FROM_PORT
c_func
(paren
op_amp
id|up-&gt;port
)paren
comma
id|ch
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|sunzilog_serio_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sunzilog_serio_open
r_static
r_int
id|sunzilog_serio_open
c_func
(paren
r_struct
id|serio
op_star
id|serio
)paren
(brace
r_struct
id|uart_sunzilog_port
op_star
id|up
op_assign
id|serio-&gt;driver
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|sunzilog_serio_lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|up-&gt;serio_open
)paren
(brace
id|up-&gt;serio_open
op_assign
l_int|1
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
)brace
r_else
id|ret
op_assign
op_minus
id|EBUSY
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|sunzilog_serio_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|sunzilog_serio_close
r_static
r_void
id|sunzilog_serio_close
c_func
(paren
r_struct
id|serio
op_star
id|serio
)paren
(brace
r_struct
id|uart_sunzilog_port
op_star
id|up
op_assign
id|serio-&gt;driver
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|sunzilog_serio_lock
comma
id|flags
)paren
suffix:semicolon
id|up-&gt;serio_open
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|sunzilog_serio_lock
comma
id|flags
)paren
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_SERIO */
macro_line|#ifdef CONFIG_SERIAL_SUNZILOG_CONSOLE
r_static
r_void
DECL|function|sunzilog_console_write
id|sunzilog_console_write
c_func
(paren
r_struct
id|console
op_star
id|con
comma
r_const
r_char
op_star
id|s
comma
r_int
r_int
id|count
)paren
(brace
r_struct
id|uart_sunzilog_port
op_star
id|up
op_assign
op_amp
id|sunzilog_port_table
(braket
id|con-&gt;index
)braket
suffix:semicolon
r_struct
id|zilog_channel
op_star
id|channel
op_assign
id|ZILOG_CHANNEL_FROM_PORT
c_func
(paren
op_amp
id|up-&gt;port
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|i
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|up-&gt;port.lock
comma
id|flags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
suffix:semicolon
id|i
op_increment
comma
id|s
op_increment
)paren
(brace
id|sunzilog_put_char
c_func
(paren
id|channel
comma
op_star
id|s
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|s
op_eq
l_int|10
)paren
id|sunzilog_put_char
c_func
(paren
id|channel
comma
l_int|13
)paren
suffix:semicolon
)brace
id|udelay
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|up-&gt;port.lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|sunzilog_console_setup
r_static
r_int
id|__init
id|sunzilog_console_setup
c_func
(paren
r_struct
id|console
op_star
id|con
comma
r_char
op_star
id|options
)paren
(brace
r_struct
id|uart_sunzilog_port
op_star
id|up
op_assign
op_amp
id|sunzilog_port_table
(braket
id|con-&gt;index
)braket
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|baud
comma
id|brg
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Console: ttyS%d (SunZilog zs%d)&bslash;n&quot;
comma
(paren
id|sunzilog_reg.minor
op_minus
l_int|64
)paren
op_plus
id|con-&gt;index
comma
id|con-&gt;index
)paren
suffix:semicolon
multiline_comment|/* Get firmware console settings.  */
id|sunserial_console_termios
c_func
(paren
id|con
)paren
suffix:semicolon
multiline_comment|/* Firmware console speed is limited to 150--&gt;38400 baud so&n;&t; * this hackish cflag thing is OK.&n;&t; */
r_switch
c_cond
(paren
id|con-&gt;cflag
op_amp
id|CBAUD
)paren
(brace
r_case
id|B150
suffix:colon
id|baud
op_assign
l_int|150
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B300
suffix:colon
id|baud
op_assign
l_int|300
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B600
suffix:colon
id|baud
op_assign
l_int|600
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B1200
suffix:colon
id|baud
op_assign
l_int|1200
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B2400
suffix:colon
id|baud
op_assign
l_int|2400
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B4800
suffix:colon
id|baud
op_assign
l_int|4800
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_case
id|B9600
suffix:colon
id|baud
op_assign
l_int|9600
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B19200
suffix:colon
id|baud
op_assign
l_int|19200
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B38400
suffix:colon
id|baud
op_assign
l_int|38400
suffix:semicolon
r_break
suffix:semicolon
)brace
suffix:semicolon
id|brg
op_assign
id|BPS_TO_BRG
c_func
(paren
id|baud
comma
id|ZS_CLOCK
op_div
id|ZS_CLOCK_DIVISOR
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|up-&gt;port.lock
comma
id|flags
)paren
suffix:semicolon
id|up-&gt;curregs
(braket
id|R15
)braket
op_assign
id|BRKIE
suffix:semicolon
id|sunzilog_convert_to_zs
c_func
(paren
id|up
comma
id|con-&gt;cflag
comma
l_int|0
comma
id|brg
)paren
suffix:semicolon
id|sunzilog_set_mctrl
c_func
(paren
op_amp
id|up-&gt;port
comma
id|TIOCM_DTR
op_or
id|TIOCM_RTS
)paren
suffix:semicolon
id|__sunzilog_startup
c_func
(paren
id|up
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|up-&gt;port.lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|sunzilog_console
r_static
r_struct
id|console
id|sunzilog_console
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;ttyS&quot;
comma
dot
id|write
op_assign
id|sunzilog_console_write
comma
dot
id|device
op_assign
id|uart_console_device
comma
dot
id|setup
op_assign
id|sunzilog_console_setup
comma
dot
id|flags
op_assign
id|CON_PRINTBUFFER
comma
dot
id|index
op_assign
op_minus
l_int|1
comma
dot
id|data
op_assign
op_amp
id|sunzilog_reg
comma
)brace
suffix:semicolon
DECL|macro|SUNZILOG_CONSOLE
mdefine_line|#define SUNZILOG_CONSOLE&t;(&amp;sunzilog_console)
DECL|function|sunzilog_console_init
r_static
r_int
id|__init
id|sunzilog_console_init
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|con_is_present
c_func
(paren
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_CHANNELS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
id|this_minor
op_assign
id|sunzilog_reg.minor
op_plus
id|i
suffix:semicolon
r_if
c_cond
(paren
(paren
id|this_minor
op_minus
l_int|64
)paren
op_eq
(paren
id|serial_console
op_minus
l_int|1
)paren
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_eq
id|NUM_CHANNELS
)paren
r_return
l_int|0
suffix:semicolon
id|sunzilog_console.index
op_assign
id|i
suffix:semicolon
id|sunzilog_port_table
(braket
id|i
)braket
dot
id|flags
op_or_assign
id|SUNZILOG_FLAG_IS_CONS
suffix:semicolon
id|register_console
c_func
(paren
op_amp
id|sunzilog_console
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#else
DECL|macro|SUNZILOG_CONSOLE
mdefine_line|#define SUNZILOG_CONSOLE&t;(NULL)
DECL|macro|sunzilog_console_init
mdefine_line|#define sunzilog_console_init() do { } while (0)
macro_line|#endif
multiline_comment|/*&n; * We scan the PROM tree recursively. This is the most reliable way&n; * to find Zilog nodes on various platforms. However, we face an extreme&n; * shortage of kernel stack, so we must be very careful. To that end,&n; * we scan only to a certain depth, and we use a common property buffer&n; * in the scan structure.&n; */
DECL|macro|ZS_PROPSIZE
mdefine_line|#define ZS_PROPSIZE  128
DECL|macro|ZS_SCAN_DEPTH
mdefine_line|#define ZS_SCAN_DEPTH&t;5
DECL|struct|zs_probe_scan
r_struct
id|zs_probe_scan
(brace
DECL|member|depth
r_int
id|depth
suffix:semicolon
DECL|member|scanner
r_void
(paren
op_star
id|scanner
)paren
(paren
r_struct
id|zs_probe_scan
op_star
id|t
comma
r_int
id|node
)paren
suffix:semicolon
DECL|member|devices
r_int
id|devices
suffix:semicolon
DECL|member|prop
r_char
id|prop
(braket
id|ZS_PROPSIZE
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|function|sunzilog_node_ok
r_static
r_int
id|__inline__
id|sunzilog_node_ok
c_func
(paren
r_int
id|node
comma
r_const
r_char
op_star
id|name
comma
r_int
id|len
)paren
(brace
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|name
comma
l_string|&quot;zs&quot;
comma
id|len
)paren
op_eq
l_int|0
)paren
r_return
l_int|1
suffix:semicolon
multiline_comment|/* Don&squot;t fold this procedure just yet. Compare to su_node_ok(). */
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sunzilog_scan
r_static
r_void
id|__init
id|sunzilog_scan
c_func
(paren
r_struct
id|zs_probe_scan
op_star
id|t
comma
r_int
id|node
)paren
(brace
r_int
id|len
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|node
op_ne
l_int|0
suffix:semicolon
id|node
op_assign
id|prom_getsibling
c_func
(paren
id|node
)paren
)paren
(brace
id|len
op_assign
id|prom_getproperty
c_func
(paren
id|node
comma
l_string|&quot;name&quot;
comma
id|t-&gt;prop
comma
id|ZS_PROPSIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
op_le
l_int|1
)paren
r_continue
suffix:semicolon
multiline_comment|/* Broken PROM node */
r_if
c_cond
(paren
id|sunzilog_node_ok
c_func
(paren
id|node
comma
id|t-&gt;prop
comma
id|len
)paren
)paren
(brace
(paren
op_star
id|t-&gt;scanner
)paren
(paren
id|t
comma
id|node
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|t-&gt;depth
OL
id|ZS_SCAN_DEPTH
)paren
(brace
id|t-&gt;depth
op_increment
suffix:semicolon
id|sunzilog_scan
c_func
(paren
id|t
comma
id|prom_getchild
c_func
(paren
id|node
)paren
)paren
suffix:semicolon
op_decrement
id|t-&gt;depth
suffix:semicolon
)brace
)brace
)brace
)brace
DECL|function|sunzilog_prepare
r_static
r_void
id|__init
id|sunzilog_prepare
c_func
(paren
r_void
)paren
(brace
r_struct
id|uart_sunzilog_port
op_star
id|up
suffix:semicolon
r_struct
id|zilog_layout
op_star
id|rp
suffix:semicolon
r_int
id|channel
comma
id|chip
suffix:semicolon
multiline_comment|/*&n;&t; * Temporary fix.&n;&t; */
r_for
c_loop
(paren
id|channel
op_assign
l_int|0
suffix:semicolon
id|channel
OL
id|NUM_CHANNELS
suffix:semicolon
id|channel
op_increment
)paren
id|spin_lock_init
c_func
(paren
op_amp
id|sunzilog_port_table
(braket
id|channel
)braket
dot
id|port.lock
)paren
suffix:semicolon
id|sunzilog_irq_chain
op_assign
id|up
op_assign
op_amp
id|sunzilog_port_table
(braket
l_int|0
)braket
suffix:semicolon
r_for
c_loop
(paren
id|channel
op_assign
l_int|0
suffix:semicolon
id|channel
OL
id|NUM_CHANNELS
op_minus
l_int|1
suffix:semicolon
id|channel
op_increment
)paren
id|up
(braket
id|channel
)braket
dot
id|next
op_assign
op_amp
id|up
(braket
id|channel
op_plus
l_int|1
)braket
suffix:semicolon
id|up
(braket
id|channel
)braket
dot
id|next
op_assign
l_int|NULL
suffix:semicolon
r_for
c_loop
(paren
id|chip
op_assign
l_int|0
suffix:semicolon
id|chip
OL
id|NUM_SUNZILOG
suffix:semicolon
id|chip
op_increment
)paren
(brace
id|rp
op_assign
id|sunzilog_chip_regs
(braket
id|chip
)braket
suffix:semicolon
id|up
(braket
(paren
id|chip
op_star
l_int|2
)paren
op_plus
l_int|0
)braket
dot
id|port.membase
op_assign
(paren
r_char
op_star
)paren
op_amp
id|rp-&gt;channelA
suffix:semicolon
id|up
(braket
(paren
id|chip
op_star
l_int|2
)paren
op_plus
l_int|1
)braket
dot
id|port.membase
op_assign
(paren
r_char
op_star
)paren
op_amp
id|rp-&gt;channelB
suffix:semicolon
multiline_comment|/* Channel A */
id|up
(braket
(paren
id|chip
op_star
l_int|2
)paren
op_plus
l_int|0
)braket
dot
id|port.iotype
op_assign
id|SERIAL_IO_MEM
suffix:semicolon
id|up
(braket
(paren
id|chip
op_star
l_int|2
)paren
op_plus
l_int|0
)braket
dot
id|port.irq
op_assign
id|zilog_irq
suffix:semicolon
id|up
(braket
(paren
id|chip
op_star
l_int|2
)paren
op_plus
l_int|0
)braket
dot
id|port.uartclk
op_assign
id|ZS_CLOCK
suffix:semicolon
id|up
(braket
(paren
id|chip
op_star
l_int|2
)paren
op_plus
l_int|0
)braket
dot
id|port.fifosize
op_assign
l_int|1
suffix:semicolon
id|up
(braket
(paren
id|chip
op_star
l_int|2
)paren
op_plus
l_int|0
)braket
dot
id|port.ops
op_assign
op_amp
id|sunzilog_pops
suffix:semicolon
id|up
(braket
(paren
id|chip
op_star
l_int|2
)paren
op_plus
l_int|0
)braket
dot
id|port.type
op_assign
id|PORT_SUNZILOG
suffix:semicolon
id|up
(braket
(paren
id|chip
op_star
l_int|2
)paren
op_plus
l_int|0
)braket
dot
id|port.flags
op_assign
l_int|0
suffix:semicolon
id|up
(braket
(paren
id|chip
op_star
l_int|2
)paren
op_plus
l_int|0
)braket
dot
id|port.line
op_assign
(paren
id|chip
op_star
l_int|2
)paren
op_plus
l_int|0
suffix:semicolon
id|up
(braket
(paren
id|chip
op_star
l_int|2
)paren
op_plus
l_int|0
)braket
dot
id|flags
op_or_assign
id|SUNZILOG_FLAG_IS_CHANNEL_A
suffix:semicolon
multiline_comment|/* Channel B */
id|up
(braket
(paren
id|chip
op_star
l_int|2
)paren
op_plus
l_int|1
)braket
dot
id|port.iotype
op_assign
id|SERIAL_IO_MEM
suffix:semicolon
id|up
(braket
(paren
id|chip
op_star
l_int|2
)paren
op_plus
l_int|1
)braket
dot
id|port.irq
op_assign
id|zilog_irq
suffix:semicolon
id|up
(braket
(paren
id|chip
op_star
l_int|2
)paren
op_plus
l_int|1
)braket
dot
id|port.uartclk
op_assign
id|ZS_CLOCK
suffix:semicolon
id|up
(braket
(paren
id|chip
op_star
l_int|2
)paren
op_plus
l_int|1
)braket
dot
id|port.fifosize
op_assign
l_int|1
suffix:semicolon
id|up
(braket
(paren
id|chip
op_star
l_int|2
)paren
op_plus
l_int|1
)braket
dot
id|port.ops
op_assign
op_amp
id|sunzilog_pops
suffix:semicolon
id|up
(braket
(paren
id|chip
op_star
l_int|2
)paren
op_plus
l_int|1
)braket
dot
id|port.type
op_assign
id|PORT_SUNZILOG
suffix:semicolon
id|up
(braket
(paren
id|chip
op_star
l_int|2
)paren
op_plus
l_int|1
)braket
dot
id|port.flags
op_assign
l_int|0
suffix:semicolon
id|up
(braket
(paren
id|chip
op_star
l_int|2
)paren
op_plus
l_int|1
)braket
dot
id|port.line
op_assign
(paren
id|chip
op_star
l_int|2
)paren
op_plus
l_int|1
suffix:semicolon
id|up
(braket
(paren
id|chip
op_star
l_int|2
)paren
op_plus
l_int|1
)braket
dot
id|flags
op_or_assign
l_int|0
suffix:semicolon
)brace
)brace
DECL|function|sunzilog_init_kbdms
r_static
r_void
id|__init
id|sunzilog_init_kbdms
c_func
(paren
r_struct
id|uart_sunzilog_port
op_star
id|up
comma
r_int
id|channel
)paren
(brace
r_int
id|baud
comma
id|brg
suffix:semicolon
r_if
c_cond
(paren
id|channel
op_eq
id|KEYBOARD_LINE
)paren
(brace
id|up-&gt;flags
op_or_assign
id|SUNZILOG_FLAG_CONS_KEYB
suffix:semicolon
id|up-&gt;cflag
op_assign
id|B1200
op_or
id|CS8
op_or
id|CLOCAL
op_or
id|CREAD
suffix:semicolon
id|baud
op_assign
l_int|1200
suffix:semicolon
)brace
r_else
(brace
id|up-&gt;flags
op_or_assign
id|SUNZILOG_FLAG_CONS_MOUSE
suffix:semicolon
id|up-&gt;cflag
op_assign
id|B4800
op_or
id|CS8
op_or
id|CLOCAL
op_or
id|CREAD
suffix:semicolon
id|baud
op_assign
l_int|4800
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;zs%d at 0x%p (irq = %s) is a SunZilog&bslash;n&quot;
comma
id|channel
comma
id|up-&gt;port.membase
comma
id|__irq_itoa
c_func
(paren
id|zilog_irq
)paren
)paren
suffix:semicolon
id|up-&gt;curregs
(braket
id|R15
)braket
op_assign
id|BRKIE
suffix:semicolon
id|brg
op_assign
id|BPS_TO_BRG
c_func
(paren
id|baud
comma
id|ZS_CLOCK
op_div
id|ZS_CLOCK_DIVISOR
)paren
suffix:semicolon
id|sunzilog_convert_to_zs
c_func
(paren
id|up
comma
id|up-&gt;cflag
comma
l_int|0
comma
id|brg
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_SERIO
id|memset
c_func
(paren
op_amp
id|up-&gt;serio
comma
l_int|0
comma
r_sizeof
(paren
id|up-&gt;serio
)paren
)paren
suffix:semicolon
id|up-&gt;serio.driver
op_assign
id|up
suffix:semicolon
id|up-&gt;serio.type
op_assign
id|SERIO_RS232
suffix:semicolon
r_if
c_cond
(paren
id|channel
op_eq
id|KEYBOARD_LINE
)paren
(brace
id|up-&gt;serio.type
op_or_assign
id|SERIO_SUNKBD
suffix:semicolon
id|up-&gt;serio.name
op_assign
l_string|&quot;zskbd&quot;
suffix:semicolon
)brace
r_else
(brace
id|up-&gt;serio.type
op_or_assign
(paren
id|SERIO_SUN
op_or
(paren
l_int|1
op_lshift
l_int|16
)paren
)paren
suffix:semicolon
id|up-&gt;serio.name
op_assign
l_string|&quot;zsms&quot;
suffix:semicolon
)brace
id|up-&gt;serio.phys
op_assign
(paren
id|channel
op_eq
id|KEYBOARD_LINE
ques
c_cond
l_string|&quot;zs/serio0&quot;
suffix:colon
l_string|&quot;zs/serio1&quot;
)paren
suffix:semicolon
id|up-&gt;serio.write
op_assign
id|sunzilog_serio_write
suffix:semicolon
id|up-&gt;serio.open
op_assign
id|sunzilog_serio_open
suffix:semicolon
id|up-&gt;serio.close
op_assign
id|sunzilog_serio_close
suffix:semicolon
id|serio_register_port
c_func
(paren
op_amp
id|up-&gt;serio
)paren
suffix:semicolon
macro_line|#endif
id|sunzilog_set_mctrl
c_func
(paren
op_amp
id|up-&gt;port
comma
id|TIOCM_DTR
op_or
id|TIOCM_RTS
)paren
suffix:semicolon
id|__sunzilog_startup
c_func
(paren
id|up
)paren
suffix:semicolon
)brace
DECL|function|sunzilog_init_hw
r_static
r_void
id|__init
id|sunzilog_init_hw
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_CHANNELS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|uart_sunzilog_port
op_star
id|up
op_assign
op_amp
id|sunzilog_port_table
(braket
id|i
)braket
suffix:semicolon
r_struct
id|zilog_channel
op_star
id|channel
op_assign
id|ZILOG_CHANNEL_FROM_PORT
c_func
(paren
op_amp
id|up-&gt;port
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|baud
comma
id|brg
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|up-&gt;port.lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ZS_IS_CHANNEL_A
c_func
(paren
id|up
)paren
)paren
(brace
id|write_zsreg
c_func
(paren
id|channel
comma
id|R9
comma
id|FHWRES
)paren
suffix:semicolon
id|ZSDELAY_LONG
c_func
(paren
)paren
suffix:semicolon
(paren
r_void
)paren
id|read_zsreg
c_func
(paren
id|channel
comma
id|R0
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_eq
id|KEYBOARD_LINE
op_logical_or
id|i
op_eq
id|MOUSE_LINE
)paren
(brace
id|sunzilog_init_kbdms
c_func
(paren
id|up
comma
id|i
)paren
suffix:semicolon
id|up-&gt;curregs
(braket
id|R9
)braket
op_or_assign
(paren
id|NV
op_or
id|MIE
)paren
suffix:semicolon
id|write_zsreg
c_func
(paren
id|channel
comma
id|R9
comma
id|up-&gt;curregs
(braket
id|R9
)braket
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Normal serial TTY. */
id|up-&gt;parity_mask
op_assign
l_int|0xff
suffix:semicolon
id|up-&gt;curregs
(braket
id|R1
)braket
op_assign
id|EXT_INT_ENAB
op_or
id|INT_ALL_Rx
op_or
id|TxINT_ENAB
suffix:semicolon
id|up-&gt;curregs
(braket
id|R4
)braket
op_assign
id|PAR_EVEN
op_or
id|X16CLK
op_or
id|SB1
suffix:semicolon
id|up-&gt;curregs
(braket
id|R3
)braket
op_assign
id|RxENAB
op_or
id|Rx8
suffix:semicolon
id|up-&gt;curregs
(braket
id|R5
)braket
op_assign
id|TxENAB
op_or
id|Tx8
suffix:semicolon
id|up-&gt;curregs
(braket
id|R9
)braket
op_assign
id|NV
op_or
id|MIE
suffix:semicolon
id|up-&gt;curregs
(braket
id|R10
)braket
op_assign
id|NRZ
suffix:semicolon
id|up-&gt;curregs
(braket
id|R11
)braket
op_assign
id|TCBR
op_or
id|RCBR
suffix:semicolon
id|baud
op_assign
l_int|9600
suffix:semicolon
id|brg
op_assign
id|BPS_TO_BRG
c_func
(paren
id|baud
comma
id|ZS_CLOCK
op_div
id|ZS_CLOCK_DIVISOR
)paren
suffix:semicolon
id|up-&gt;curregs
(braket
id|R12
)braket
op_assign
(paren
id|brg
op_amp
l_int|0xff
)paren
suffix:semicolon
id|up-&gt;curregs
(braket
id|R13
)braket
op_assign
(paren
id|brg
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
id|up-&gt;curregs
(braket
id|R14
)braket
op_assign
id|BRSRC
op_or
id|BRENAB
suffix:semicolon
id|__load_zsregs
c_func
(paren
id|channel
comma
id|up-&gt;curregs
)paren
suffix:semicolon
id|write_zsreg
c_func
(paren
id|channel
comma
id|R9
comma
id|up-&gt;curregs
(braket
id|R9
)braket
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|up-&gt;port.lock
comma
id|flags
)paren
suffix:semicolon
)brace
)brace
r_static
r_struct
id|zilog_layout
op_star
id|__init
id|get_zs
c_func
(paren
r_int
id|chip
comma
r_int
id|node
)paren
suffix:semicolon
DECL|function|sunzilog_scan_probe
r_static
r_void
id|__init
id|sunzilog_scan_probe
c_func
(paren
r_struct
id|zs_probe_scan
op_star
id|t
comma
r_int
id|node
)paren
(brace
id|sunzilog_chip_regs
(braket
id|t-&gt;devices
)braket
op_assign
id|get_zs
c_func
(paren
id|t-&gt;devices
comma
id|node
)paren
suffix:semicolon
id|t-&gt;devices
op_increment
suffix:semicolon
)brace
DECL|function|sunzilog_ports_init
r_static
r_int
id|__init
id|sunzilog_ports_init
c_func
(paren
r_void
)paren
(brace
r_struct
id|zs_probe_scan
id|scan
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_int
id|uart_count
suffix:semicolon
r_int
id|i
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;SunZilog: %d chips.&bslash;n&quot;
comma
id|NUM_SUNZILOG
)paren
suffix:semicolon
id|scan.scanner
op_assign
id|sunzilog_scan_probe
suffix:semicolon
id|scan.depth
op_assign
l_int|0
suffix:semicolon
id|scan.devices
op_assign
l_int|0
suffix:semicolon
id|sunzilog_scan
c_func
(paren
op_amp
id|scan
comma
id|prom_getchild
c_func
(paren
id|prom_root_node
)paren
)paren
suffix:semicolon
id|sunzilog_prepare
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|zilog_irq
comma
id|sunzilog_interrupt
comma
id|SA_SHIRQ
comma
l_string|&quot;SunZilog&quot;
comma
id|sunzilog_irq_chain
)paren
)paren
(brace
id|prom_printf
c_func
(paren
l_string|&quot;SunZilog: Unable to register zs interrupt handler.&bslash;n&quot;
)paren
suffix:semicolon
id|prom_halt
c_func
(paren
)paren
suffix:semicolon
)brace
id|sunzilog_init_hw
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* We can only init this once we have probed the Zilogs&n;&t; * in the system. Do not count channels assigned to keyboards&n;&t; * or mice when we are deciding how many ports to register.&n;&t; */
id|uart_count
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_CHANNELS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|uart_sunzilog_port
op_star
id|up
op_assign
op_amp
id|sunzilog_port_table
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|ZS_IS_KEYB
c_func
(paren
id|up
)paren
op_logical_or
id|ZS_IS_MOUSE
c_func
(paren
id|up
)paren
)paren
r_continue
suffix:semicolon
id|uart_count
op_increment
suffix:semicolon
)brace
id|sunzilog_reg.nr
op_assign
id|uart_count
suffix:semicolon
id|sunzilog_reg.cons
op_assign
id|SUNZILOG_CONSOLE
suffix:semicolon
id|sunzilog_reg.minor
op_assign
id|sunserial_current_minor
suffix:semicolon
id|sunserial_current_minor
op_add_assign
id|uart_count
suffix:semicolon
id|ret
op_assign
id|uart_register_driver
c_func
(paren
op_amp
id|sunzilog_reg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
l_int|0
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_CHANNELS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|uart_sunzilog_port
op_star
id|up
op_assign
op_amp
id|sunzilog_port_table
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|ZS_IS_KEYB
c_func
(paren
id|up
)paren
op_logical_or
id|ZS_IS_MOUSE
c_func
(paren
id|up
)paren
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|uart_add_one_port
c_func
(paren
op_amp
id|sunzilog_reg
comma
op_amp
id|up-&gt;port
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;SunZilog: failed to add port zs%d&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
)brace
)brace
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|function|sunzilog_scan_count
r_static
r_void
id|__init
id|sunzilog_scan_count
c_func
(paren
r_struct
id|zs_probe_scan
op_star
id|t
comma
r_int
id|node
)paren
(brace
id|t-&gt;devices
op_increment
suffix:semicolon
)brace
DECL|function|sunzilog_ports_count
r_static
r_int
id|__init
id|sunzilog_ports_count
c_func
(paren
r_void
)paren
(brace
r_struct
id|zs_probe_scan
id|scan
suffix:semicolon
multiline_comment|/* Sun4 Zilog setup is hard coded, no probing to do.  */
r_if
c_cond
(paren
id|sparc_cpu_model
op_eq
id|sun4
)paren
r_return
l_int|2
suffix:semicolon
id|scan.scanner
op_assign
id|sunzilog_scan_count
suffix:semicolon
id|scan.depth
op_assign
l_int|0
suffix:semicolon
id|scan.devices
op_assign
l_int|0
suffix:semicolon
id|sunzilog_scan
c_func
(paren
op_amp
id|scan
comma
id|prom_getchild
c_func
(paren
id|prom_root_node
)paren
)paren
suffix:semicolon
r_return
id|scan.devices
suffix:semicolon
)brace
DECL|function|sunzilog_init
r_static
r_int
id|__init
id|sunzilog_init
c_func
(paren
r_void
)paren
(brace
id|NUM_SUNZILOG
op_assign
id|sunzilog_ports_count
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|NUM_SUNZILOG
op_eq
l_int|0
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|sunzilog_alloc_tables
c_func
(paren
)paren
suffix:semicolon
id|sunzilog_ports_init
c_func
(paren
)paren
suffix:semicolon
id|sunzilog_console_init
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sunzilog_exit
r_static
r_void
id|__exit
id|sunzilog_exit
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_CHANNELS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|uart_sunzilog_port
op_star
id|up
op_assign
op_amp
id|sunzilog_port_table
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|ZS_IS_KEYB
c_func
(paren
id|up
)paren
op_logical_or
id|ZS_IS_MOUSE
c_func
(paren
id|up
)paren
)paren
r_continue
suffix:semicolon
id|uart_remove_one_port
c_func
(paren
op_amp
id|sunzilog_reg
comma
op_amp
id|up-&gt;port
)paren
suffix:semicolon
)brace
id|uart_unregister_driver
c_func
(paren
op_amp
id|sunzilog_reg
)paren
suffix:semicolon
)brace
DECL|variable|sunzilog_init
id|module_init
c_func
(paren
id|sunzilog_init
)paren
suffix:semicolon
DECL|variable|sunzilog_exit
id|module_exit
c_func
(paren
id|sunzilog_exit
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;David S. Miller&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Sun Zilog serial port driver&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
eof
