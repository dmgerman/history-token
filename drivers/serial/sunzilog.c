multiline_comment|/*&n; * sunzilog.c&n; *&n; * Driver for Zilog serial chips found on Sun workstations and&n; * servers.  This driver could actually be made more generic&n; * and anyone wanting to work on doing that should contact&n; * me. -DaveM&n; *&n; * This is based on the old drivers/sbus/char/zs.c code, a lot&n; * of code has been simply moved over directly from there but&n; * much has been rewritten.  Credits therefore go out to Eddie&n; * C. Dost, Peter Zaitcev, Ted Ts&squot;o and Alex Buell for their&n; * work there.&n; *&n; *  Copyright (C) 2002 David S. Miller (davem@redhat.com)&n; */
macro_line|#include &quot;suncore.h&quot;
macro_line|#include &quot;sunzilog.h&quot;
multiline_comment|/* On 32-bit sparcs we need to delay after register accesses&n; * to accomodate sun4 systems, but we do not need to flush writes.&n; * On 64-bit sparc we only need to flush single writes to ensure&n; * completion.&n; */
macro_line|#ifndef __sparc_v9__
DECL|macro|ZSDELAY
mdefine_line|#define ZSDELAY()&t;&t;udelay(5)
DECL|macro|ZSDELAY_LONG
mdefine_line|#define ZSDELAY_LONG()&t;&t;udelay(20)
DECL|macro|ZS_WSYNC
mdefine_line|#define ZS_WSYNC(channel)&t;do { } while(0)
macro_line|#else
DECL|macro|ZSDELAY
mdefine_line|#define ZSDELAY()
DECL|macro|ZSDELAY_LONG
mdefine_line|#define ZSDELAY_LONG()
DECL|macro|ZS_WSYNC
mdefine_line|#define ZS_WSYNC(__channel) &bslash;&n;&t;sbus_readb(&amp;((__channel)-&gt;control))
macro_line|#endif
multiline_comment|/* Default setting is sun4/sun4c/sun4m, two chips on board. */
DECL|variable|num_sunzilog
r_static
r_int
id|num_sunzilog
op_assign
l_int|2
suffix:semicolon
DECL|macro|NUM_SUNZILOG
mdefine_line|#define NUM_SUNZILOG&t;num_sunzilog
DECL|macro|NUM_CHANNELS
mdefine_line|#define NUM_CHANNELS&t;(NUM_SUNZILOG * 2)
multiline_comment|/*&n; * We wrap our port structure around the generic uart_port.&n; */
DECL|struct|uart_sunzilog_port
r_struct
id|uart_sunzilog_port
(brace
DECL|member|port
r_struct
id|uart_port
id|port
suffix:semicolon
multiline_comment|/* IRQ servicing chain.  */
DECL|member|next
r_struct
id|uart_sunzilog_port
op_star
id|next
suffix:semicolon
multiline_comment|/* Current values of Zilog write registers.  */
DECL|member|curregs
r_int
r_char
id|curregs
(braket
id|NUM_ZSREGS
)braket
suffix:semicolon
DECL|member|flags
r_int
r_int
id|flags
suffix:semicolon
DECL|macro|SUNZILOG_FLAG_CONS_KEYB
mdefine_line|#define SUNZILOG_FLAG_CONS_KEYB&t;&t;0x00000001
DECL|macro|SUNZILOG_FLAG_CONS_MOUSE
mdefine_line|#define SUNZILOG_FLAG_CONS_MOUSE&t;0x00000002
DECL|macro|SUNZILOG_FLAG_IS_CONS
mdefine_line|#define SUNZILOG_FLAG_IS_CONS&t;&t;0x00000004
DECL|macro|SUNZILOG_FLAG_IS_KGDB
mdefine_line|#define SUNZILOG_FLAG_IS_KGDB&t;&t;0x00000008
DECL|macro|SUNZILOG_FLAG_MODEM_STATUS
mdefine_line|#define SUNZILOG_FLAG_MODEM_STATUS&t;0x00000010
DECL|macro|SUNZILOG_FLAG_IS_CHANNEL_A
mdefine_line|#define SUNZILOG_FLAG_IS_CHANNEL_A&t;0x00000020
multiline_comment|/* L1-A keyboard break state.  */
DECL|member|kbd_id
r_int
id|kbd_id
suffix:semicolon
DECL|member|l1_down
r_int
id|l1_down
suffix:semicolon
DECL|member|parity_mask
r_int
r_char
id|parity_mask
suffix:semicolon
DECL|member|prev_status
r_int
r_char
id|prev_status
suffix:semicolon
)brace
suffix:semicolon
DECL|macro|ZILOG_CHANNEL_FROM_PORT
mdefine_line|#define ZILOG_CHANNEL_FROM_PORT(PORT)&t;((struct zilog_channel *)((PORT)-&gt;membase))
DECL|macro|UART_ZILOG
mdefine_line|#define UART_ZILOG(PORT)&t;&t;((struct uart_sunzilog_port *)(PORT))
DECL|macro|SUNZILOG_GET_CURR_REG
mdefine_line|#define SUNZILOG_GET_CURR_REG(PORT, REGNUM)&t;&t;&bslash;&n;&t;(UART_ZILOG(PORT)-&gt;curregs[REGNUM])
DECL|macro|SUNZILOG_SET_CURR_REG
mdefine_line|#define SUNZILOG_SET_CURR_REG(PORT, REGNUM, REGVAL)&t;&bslash;&n;&t;((UART_ZILOG(PORT)-&gt;curregs[REGNUM]) = (REGVAL))
DECL|variable|sunzilog_initregs_normal
r_static
r_int
r_char
id|sunzilog_initregs_normal
(braket
id|NUM_ZSREGS
)braket
op_assign
(brace
id|RES_EXT_INT
comma
multiline_comment|/* R0 */
l_int|0
comma
multiline_comment|/* R1 */
l_int|0
comma
multiline_comment|/* R2 */
id|Rx8
comma
multiline_comment|/* R3 */
id|PAR_EVEN
op_or
id|X16CLK
op_or
id|SB1
comma
multiline_comment|/* R4 */
id|Tx8
comma
multiline_comment|/* R5 */
l_int|0
comma
multiline_comment|/* R6 */
l_int|0
comma
multiline_comment|/* R7 */
l_int|0
comma
multiline_comment|/* R8 */
id|NV
op_or
id|MIE
comma
multiline_comment|/* R9 */
id|NRZ
comma
multiline_comment|/* R10 */
id|RCBR
op_or
id|TCBR
comma
multiline_comment|/* R11 */
l_int|0
comma
l_int|0
comma
multiline_comment|/* R12, R13 Baud Quotient low, high */
id|BRSRC
op_or
id|BRENAB
comma
multiline_comment|/* R14 */
id|DCDIE
op_or
id|SYNCIE
op_or
id|CTSIE
op_or
id|BRKIE
comma
multiline_comment|/* R15 */
)brace
suffix:semicolon
DECL|variable|sunzilog_initregs_console
r_static
r_int
r_char
id|sunzilog_initregs_console
(braket
id|NUM_ZSREGS
)braket
op_assign
(brace
id|RES_EXT_INT
comma
multiline_comment|/* R0 */
id|EXT_INT_ENAB
op_or
id|INT_ALL_Rx
comma
multiline_comment|/* R1 */
l_int|0
comma
multiline_comment|/* R2 */
id|Rx8
op_or
id|RxENAB
comma
multiline_comment|/* R3 */
id|X16CLK
comma
multiline_comment|/* R4 */
id|DTR
op_or
id|Tx8
op_or
id|TxENAB
comma
multiline_comment|/* R5 */
l_int|0
comma
multiline_comment|/* R6 */
l_int|0
comma
multiline_comment|/* R7 */
l_int|0
comma
multiline_comment|/* R8 */
id|NV
op_or
id|MIE
comma
multiline_comment|/* R9 */
id|NRZ
comma
multiline_comment|/* R10 */
id|RCBR
op_or
id|TCBR
comma
multiline_comment|/* R11 */
l_int|0
comma
l_int|0
comma
multiline_comment|/* R12, R13 Baud Quotient low, high */
id|BRSRC
op_or
id|BRENAB
comma
multiline_comment|/* R14 */
id|DCDIE
op_or
id|SYNCIE
op_or
id|CTSIE
op_or
id|BRKIE
comma
multiline_comment|/* R15 */
)brace
suffix:semicolon
DECL|variable|sunzilog_initregs_kgdb
r_static
r_int
r_char
id|sunzilog_initregs_kgdb
(braket
id|NUM_ZSREGS
)braket
op_assign
(brace
l_int|0
comma
l_int|0
comma
l_int|0
multiline_comment|/* R0, R1, R2 */
id|Rx8
op_or
id|RxENAB
comma
multiline_comment|/* R3 */
id|PAR_EVEN
op_or
id|X16CLK
op_or
id|SB1
comma
multiline_comment|/* R4 */
id|DTR
op_or
id|Tx8
op_or
id|TxENAB
comma
multiline_comment|/* R5 */
l_int|0
comma
l_int|0
comma
l_int|0
comma
multiline_comment|/* R6, R7, R8 */
id|NV
comma
multiline_comment|/* R9 */
id|NRZ
comma
multiline_comment|/* R10 */
id|RCBR
op_or
id|TCBR
comma
multiline_comment|/* R11 */
l_int|0
comma
l_int|0
comma
multiline_comment|/* R12, R13 Baud Quotient low, high */
id|BRSRC
op_or
id|BRENAB
comma
multiline_comment|/* R14 */
id|DCDIE
comma
multiline_comment|/* R15 */
)brace
suffix:semicolon
multiline_comment|/* Reading and writing Zilog8530 registers.  The delays are to make this&n; * driver work on the Sun4 which needs a settling delay after each chip&n; * register access, other machines handle this in hardware via auxiliary&n; * flip-flops which implement the settle time we do in software.&n; *&n; * The port lock must be held and local IRQs must be disabled&n; * when {read,write}_zsreg is invoked.&n; */
DECL|function|read_zsreg
r_static
r_int
r_char
id|read_zsreg
c_func
(paren
r_struct
id|zilog_channel
op_star
id|channel
comma
r_int
r_char
id|reg
)paren
(brace
r_int
r_char
id|retval
suffix:semicolon
id|sbus_writeb
c_func
(paren
id|reg
comma
op_amp
id|channel-&gt;control
)paren
suffix:semicolon
id|ZSDELAY
c_func
(paren
)paren
suffix:semicolon
id|retval
op_assign
id|sbus_readb
c_func
(paren
op_amp
id|channel-&gt;control
)paren
suffix:semicolon
id|ZSDELAY
c_func
(paren
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
DECL|function|write_zsreg
r_static
r_void
id|write_zsreg
c_func
(paren
r_struct
id|zilog_channel
op_star
id|channel
comma
r_int
r_char
id|reg
comma
r_int
r_char
id|value
)paren
(brace
id|sbus_writeb
c_func
(paren
id|reg
comma
op_amp
id|channel-&gt;control
)paren
suffix:semicolon
id|ZSDELAY
c_func
(paren
)paren
suffix:semicolon
id|sbus_writeb
c_func
(paren
id|value
comma
op_amp
id|channel-&gt;control
)paren
suffix:semicolon
id|ZSDELAY
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|load_zsregs
r_static
r_void
id|load_zsregs
c_func
(paren
r_struct
id|zilog_channel
op_star
id|channel
comma
r_int
r_char
op_star
id|regs
comma
r_int
id|is_channel_a
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|1000
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
r_char
id|stat
op_assign
id|read_zsreg
c_func
(paren
id|channel
comma
id|R1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|stat
op_amp
id|ALL_SNT
)paren
r_break
suffix:semicolon
id|udelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
)brace
id|write_zsreg
c_func
(paren
id|channel
comma
id|R3
comma
l_int|0
)paren
suffix:semicolon
id|ZS_CLEARSTAT
c_func
(paren
id|channel
)paren
suffix:semicolon
id|ZS_CLEARERR
c_func
(paren
id|channel
)paren
suffix:semicolon
id|ZS_CLEARFIFO
c_func
(paren
id|channel
)paren
suffix:semicolon
r_if
c_cond
(paren
id|is_channel_a
)paren
id|write_zsreg
c_func
(paren
id|channel
comma
id|R9
comma
id|CHRA
)paren
suffix:semicolon
r_else
id|write_zsreg
c_func
(paren
id|channel
comma
id|R9
comma
id|CHRB
)paren
suffix:semicolon
id|ZSDELAY_LONG
c_func
(paren
)paren
suffix:semicolon
id|write_zsreg
c_func
(paren
id|channel
comma
id|R4
comma
id|regs
(braket
id|R4
)braket
)paren
suffix:semicolon
id|write_zsreg
c_func
(paren
id|channel
comma
id|R3
comma
id|regs
(braket
id|R3
)braket
op_amp
op_complement
id|RxENAB
)paren
suffix:semicolon
id|write_zsreg
c_func
(paren
id|channel
comma
id|R5
comma
id|regs
(braket
id|R5
)braket
op_amp
op_complement
id|TxENAB
)paren
suffix:semicolon
id|write_zsreg
c_func
(paren
id|channel
comma
id|R9
comma
id|regs
(braket
id|R9
)braket
op_amp
op_complement
id|MIE
)paren
suffix:semicolon
id|write_zsreg
c_func
(paren
id|channel
comma
id|R10
comma
id|regs
(braket
id|R10
)braket
)paren
suffix:semicolon
id|write_zsreg
c_func
(paren
id|channel
comma
id|R11
comma
id|regs
(braket
id|R11
)braket
)paren
suffix:semicolon
id|write_zsreg
c_func
(paren
id|channel
comma
id|R12
comma
id|regs
(braket
id|R12
)braket
)paren
suffix:semicolon
id|write_zsreg
c_func
(paren
id|channel
comma
id|R13
comma
id|regs
(braket
id|R13
)braket
)paren
suffix:semicolon
id|write_zsreg
c_func
(paren
id|channel
comma
id|R14
comma
id|regs
(braket
id|R14
)braket
op_amp
op_complement
id|BRENAB
)paren
suffix:semicolon
id|write_zsreg
c_func
(paren
id|channel
comma
id|R14
comma
id|regs
(braket
id|R14
)braket
)paren
suffix:semicolon
id|write_zsreg
c_func
(paren
id|channel
comma
id|R14
comma
(paren
id|regs
(braket
id|R14
)braket
op_amp
op_complement
id|SNRZI
)paren
op_or
id|BRENAB
)paren
suffix:semicolon
id|write_zsreg
c_func
(paren
id|channel
comma
id|R3
comma
id|regs
(braket
id|R3
)braket
)paren
suffix:semicolon
id|write_zsreg
c_func
(paren
id|channel
comma
id|R5
comma
id|regs
(braket
id|R5
)braket
)paren
suffix:semicolon
id|write_zsreg
c_func
(paren
id|channel
comma
id|R15
comma
id|regs
(braket
id|R15
)braket
)paren
suffix:semicolon
id|write_zsreg
c_func
(paren
id|channel
comma
id|R0
comma
id|RES_EXT_INT
)paren
suffix:semicolon
id|write_zsreg
c_func
(paren
id|channel
comma
id|R0
comma
id|ERR_RES
)paren
suffix:semicolon
id|write_zsreg
c_func
(paren
id|channel
comma
id|R1
comma
id|regs
(braket
id|R1
)braket
)paren
suffix:semicolon
id|write_zsreg
c_func
(paren
id|channel
comma
id|R9
comma
id|regs
(braket
id|R9
)braket
)paren
suffix:semicolon
)brace
multiline_comment|/* The port-&gt;lock must be held and interrupts must be disabled here.  */
DECL|function|__sunzilog_read_channel_status
r_static
id|__inline__
r_int
r_char
id|__sunzilog_read_channel_status
c_func
(paren
r_struct
id|uart_port
op_star
id|port
)paren
(brace
r_struct
id|zilog_channel
op_star
id|channel
suffix:semicolon
r_int
r_char
id|status
suffix:semicolon
id|channel
op_assign
id|ZILOG_CHANNEL_FROM_PORT
c_func
(paren
id|port
)paren
suffix:semicolon
id|status
op_assign
id|sbus_read
c_func
(paren
op_amp
id|channel-&gt;control
)paren
suffix:semicolon
id|ZSDELAY
c_func
(paren
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/* A convenient way to quickly get R0 status.  The caller must _not_ hold the&n; * port lock, it is acquired here.  If you have the lock already invoke the&n; * double-underscore variant above.&n; */
DECL|function|sunzilog_read_channel_status
r_static
r_int
r_char
id|sunzilog_read_channel_status
c_func
(paren
r_struct
id|uart_port
op_star
id|port
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
r_char
id|status
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|port-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|status
op_assign
id|__sunzilog_read_channel_status
c_func
(paren
id|port
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|port-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/* A convenient way to set/clear bits in an arbitrary zilog register.&n; * The caller must the port lock and local interrupts must be disabled.&n; */
DECL|function|__sunzilog_set_clear_bits
r_static
r_void
id|__sunzilog_set_clear_bits
c_func
(paren
r_struct
id|uart_port
op_star
id|port
comma
r_int
id|regnum
comma
r_int
r_char
id|set_bits
comma
r_int
r_char
id|clear_bits
)paren
(brace
r_int
r_char
id|regval
suffix:semicolon
id|regval
op_assign
id|SUNZILOG_GET_CURR_REG
c_func
(paren
id|port
comma
id|regnum
)paren
suffix:semicolon
id|regval
op_or_assign
id|set_bits
suffix:semicolon
id|regval
op_and_assign
op_complement
id|clear_bits
suffix:semicolon
id|SUNZILOG_SET_CURR_REG
c_func
(paren
id|port
comma
id|regnum
comma
id|regval
)paren
suffix:semicolon
id|write_zsreg
c_func
(paren
id|ZILOG_CHANNEL_FROM_PORT
c_func
(paren
id|port
)paren
comma
id|regnum
comma
id|regval
)paren
suffix:semicolon
)brace
DECL|function|sunzilog_receive_chars
r_static
r_void
id|sunzilog_receive_chars
c_func
(paren
r_struct
id|uart_sunzilog_port
op_star
id|sunzilog_port
comma
r_struct
id|sunzilog_channel
op_star
id|channel
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|tty_struct
op_star
id|tty
op_assign
id|sunzilog_port-&gt;port.info-&gt;tty
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
r_int
r_char
id|ch
comma
id|r1
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|tty-&gt;flip.count
op_ge
id|TTY_FLIPBUF_SIZE
)paren
)paren
(brace
id|tty-&gt;flip.tqueue
dot
id|routine
c_func
(paren
(paren
r_void
op_star
)paren
id|tty
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tty-&gt;flip.count
op_ge
id|TTY_FLIPBUF_SIZE
)paren
r_return
suffix:semicolon
)brace
id|r1
op_assign
id|read_zsreg
c_func
(paren
id|channel
comma
id|R1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r1
op_amp
(paren
id|PAR_ERR
op_or
id|Rx_OVR
op_or
id|CRC_ERR
)paren
)paren
(brace
id|sbus_writeb
c_func
(paren
id|ERR_RES
comma
op_amp
id|channel-&gt;control
)paren
suffix:semicolon
id|ZSDELAY
c_func
(paren
)paren
suffix:semicolon
id|ZS_WSYNC
c_func
(paren
id|channel
)paren
suffix:semicolon
)brace
id|ch
op_assign
id|sbus_readb
c_func
(paren
op_amp
id|channel-&gt;control
)paren
suffix:semicolon
id|ZSDELAY
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* This funny hack depends upon BRK_ABRT not interfering&n;&t;&t; * with the other bits we care about in R1.&n;&t;&t; */
r_if
c_cond
(paren
id|ch
op_amp
id|BRK_ABRT
)paren
id|r1
op_or_assign
id|BRK_ABRT
suffix:semicolon
id|ch
op_assign
id|sbus_readb
c_func
(paren
op_amp
id|channel-&gt;data
)paren
suffix:semicolon
id|ZSDELAY
c_func
(paren
)paren
suffix:semicolon
id|ch
op_and_assign
id|sunzilog_port-&gt;parity_mask
suffix:semicolon
r_if
c_cond
(paren
id|sunzilog_port-&gt;flags
op_amp
id|SUNZILOG_FLAG_CONS_KEYB
)paren
(brace
r_if
c_cond
(paren
id|ch
op_eq
id|SUNKBD_RESET
)paren
(brace
id|sunzilog_port-&gt;kbd_id
op_assign
l_int|1
suffix:semicolon
id|sunzilog_port-&gt;l1_down
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|sunzilog_port-&gt;kbd_id
)paren
(brace
id|sunzilog_port-&gt;kbd_id
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ch
op_eq
id|SUNKBD_l1
)paren
(brace
id|sunzilog_port-&gt;l1_down
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ch
op_eq
(paren
id|SUNKBD_l1
op_or
id|SUNKBD_UP
)paren
)paren
(brace
id|sunzilog_port-&gt;l1_down
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ch
op_eq
id|SUNKBD_A
op_logical_and
id|sunzilog_port-&gt;l1_down
)paren
(brace
id|sun_do_break
c_func
(paren
)paren
suffix:semicolon
id|sunzilog_port-&gt;l1_down
op_assign
l_int|0
suffix:semicolon
id|sunzilog_port-&gt;kbd_id
op_assign
l_int|0
suffix:semicolon
r_return
suffix:semicolon
)brace
id|sunkbd_inchar
c_func
(paren
id|ch
comma
id|regs
)paren
suffix:semicolon
r_goto
id|next_char
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sunzilog_port-&gt;flags
op_amp
id|SUNZILOG_FLAG_CONS_MOUSE
)paren
(brace
id|sun_mouse_inbyte
c_func
(paren
id|ch
comma
l_int|0
)paren
suffix:semicolon
r_goto
id|next_char
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|sunzilog_port-&gt;flags
op_amp
id|SUNZILOG_FLAG_IS_CONS
)paren
op_logical_and
(paren
id|r1
op_amp
id|BRK_ABRT
)paren
)paren
(brace
id|sun_do_break
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#ifndef CONFIG_SPARC64
multiline_comment|/* Look for kgdb &squot;stop&squot; character.  */
r_if
c_cond
(paren
(paren
id|sunzilog_port-&gt;flags
op_amp
id|SUNZILOG_FLAG_IS_KGDB
)paren
op_logical_and
(paren
id|ch
op_eq
l_char|&squot;&bslash;003&squot;
)paren
)paren
(brace
id|breakpoint
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* A real serial line, record the character and status.  */
op_star
id|tty-&gt;flip.char_buf_ptr
op_assign
id|ch
suffix:semicolon
op_star
id|tty-&gt;flip.flag_buf_ptr
op_assign
id|TTY_NORMAL
suffix:semicolon
id|sunzilog_port-&gt;port.icount.rx
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|r1
op_amp
(paren
id|BRK_ABRT
op_or
id|PAR_ERR
op_or
id|Rx_OVR
op_or
id|CRC_ERR
)paren
)paren
(brace
r_if
c_cond
(paren
id|r1
op_amp
id|BRK_ABRT
)paren
(brace
id|r1
op_and_assign
op_complement
(paren
id|PAR_ERR
op_or
id|CRC_ERR
)paren
suffix:semicolon
id|sunzilog_port-&gt;port.icount
dot
r_break
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|uart_handle_break
c_func
(paren
op_amp
id|sunzilog_port-&gt;port
)paren
)paren
r_goto
id|next_char
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|r1
op_amp
id|PAR_ERR
)paren
id|sunzilog_port-&gt;port.icount.parity
op_increment
suffix:semicolon
r_else
r_if
c_cond
(paren
id|r1
op_amp
id|CRC_ERR
)paren
id|sunzilog_port-&gt;port.icount.frame
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|r1
op_amp
id|Rx_OVR
)paren
id|sunzilog_port-&gt;port.icount.overrun
op_increment
suffix:semicolon
id|r1
op_and_assign
id|sunzilog_port-&gt;port.read_status_mask
suffix:semicolon
r_if
c_cond
(paren
id|r1
op_amp
id|BRK_ABRT
)paren
op_star
id|tty-&gt;flip.flag_buf_ptr
op_assign
id|TTY_BREAK
suffix:semicolon
r_else
r_if
c_cond
(paren
id|r1
op_amp
id|PAR_ERR
)paren
op_star
id|tty-&gt;flip.flag_buf_ptr
op_assign
id|TTY_PARITY
suffix:semicolon
r_else
r_if
c_cond
(paren
id|r1
op_amp
id|CRC_ERR
)paren
op_star
id|tty-&gt;flip.flag_buf_ptr
op_assign
id|TTY_FRAME
suffix:semicolon
)brace
r_if
c_cond
(paren
id|uart_handle_sysrq_char
c_func
(paren
op_amp
id|sunzilog_port-&gt;port
comma
id|ch
comma
id|regs
)paren
)paren
r_goto
id|next_char
suffix:semicolon
r_if
c_cond
(paren
id|up-&gt;ignore_status_mask
op_eq
l_int|0xff
op_logical_or
(paren
id|r1
op_amp
id|sunzilog_port-&gt;port.ignore_status_mask
)paren
op_eq
l_int|0
)paren
(brace
id|tty-&gt;flip.flag_buf_ptr
op_increment
suffix:semicolon
id|tty-&gt;flip.char_buf_ptr
op_increment
suffix:semicolon
id|tty-&gt;flip.count
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|r1
op_amp
id|Rx_OVR
)paren
op_logical_and
id|tty-&gt;flip.count
OL
id|TTY_FLIPBUF_SIZE
)paren
(brace
op_star
id|tty-&gt;flip.flag_buf_ptr
op_assign
id|TTY_OVERRUN
suffix:semicolon
id|tty-&gt;flip.flag_buf_ptr
op_increment
suffix:semicolon
id|tty-&gt;flip.char_buf_ptr
op_increment
suffix:semicolon
id|tty-&gt;flip.count
op_increment
suffix:semicolon
)brace
id|next_char
suffix:colon
id|ch
op_assign
id|sbus_readb
c_func
(paren
op_amp
id|channel-&gt;control
)paren
suffix:semicolon
id|ZSDELAY
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|ch
op_amp
id|Rx_CH_AV
)paren
)paren
r_break
suffix:semicolon
)brace
id|tty_flip_buffer_push
c_func
(paren
id|tty
)paren
suffix:semicolon
)brace
DECL|function|sunzilog_status_handle
r_static
r_void
id|sunzilog_status_handle
c_func
(paren
r_struct
id|uart_sunzilog_port
op_star
id|sunzilog_port
comma
r_struct
id|sunzilog_channel
op_star
id|channel
)paren
(brace
r_int
r_char
id|status
suffix:semicolon
id|status
op_assign
id|sbus_readb
c_func
(paren
op_amp
id|channel-&gt;control
)paren
suffix:semicolon
id|ZSDELAY
c_func
(paren
)paren
suffix:semicolon
id|sbus_writeb
c_func
(paren
id|RES_EXT_INT
comma
op_amp
id|channel-&gt;control
)paren
suffix:semicolon
id|ZSDELAY
c_func
(paren
)paren
suffix:semicolon
id|ZS_WSYNC
c_func
(paren
id|channel
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_amp
id|BRK_ABRT
)paren
op_logical_and
(paren
id|sunzilog_port-&gt;flags
op_amp
id|SUNZILOG_FLAG_CONS_MOUSE
)paren
)paren
id|sun_mouse_inbyte
c_func
(paren
l_int|0
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sunzilog_port-&gt;flags
op_amp
id|SUNZILOG_FLAG_MODEM_STATUS
)paren
(brace
r_if
c_cond
(paren
id|status
op_amp
id|SYNC
)paren
id|sunzilog_port-&gt;port.icount.dsr
op_increment
suffix:semicolon
multiline_comment|/* The Zilog just gives us an interrupt when DCD/CTS/etc. change.&n;&t;&t; * But it does not tell us which bit has changed, we have to keep&n;&t;&t; * track of this ourselves.&n;&t;&t; */
r_if
c_cond
(paren
(paren
id|status
op_amp
id|DCD
)paren
op_xor
id|sunzilog_port-&gt;prev_status
)paren
id|uart_handle_dcd_change
c_func
(paren
op_amp
id|sunzilog_port-&gt;port
comma
(paren
id|status
op_amp
id|DCD
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_amp
id|CTS
)paren
op_xor
id|sunzilog_port-&gt;prev_status
)paren
id|uart_handle_cts_change
c_func
(paren
op_amp
id|sunzilog_port-&gt;port
comma
(paren
id|status
op_amp
id|CTS
)paren
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|sunzilog_port-&gt;port.info-&gt;delta_msr_wait
)paren
suffix:semicolon
)brace
id|sunzilog_port-&gt;prev_status
op_assign
id|status
suffix:semicolon
)brace
DECL|macro|ZS_PUT_CHAR_MAX_DELAY
mdefine_line|#define ZS_PUT_CHAR_MAX_DELAY&t;2000&t;/* 10 ms */
DECL|function|sunzilog_put_char
r_static
r_void
id|sunzilog_put_char
c_func
(paren
r_struct
id|sunzilog_channel
op_star
id|channel
comma
r_int
r_char
id|ch
)paren
(brace
r_int
id|loops
op_assign
id|ZS_PUT_CHAR_MAX_DELAY
suffix:semicolon
multiline_comment|/* This is a timed polling loop so do not switch the explicit&n;&t; * udelay with ZSDELAY as that is a NOP on some platforms.  -DaveM&n;&t; */
r_do
(brace
r_int
r_char
id|val
op_assign
id|sbus_readb
c_func
(paren
op_amp
id|channel-&gt;control
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val
op_amp
id|Tx_BUF_EMP
)paren
r_break
suffix:semicolon
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
op_decrement
id|loops
)paren
suffix:semicolon
id|sbus_writeb
c_func
(paren
id|ch
comma
op_amp
id|channel-&gt;data
)paren
suffix:semicolon
id|ZSDELAY
c_func
(paren
)paren
suffix:semicolon
id|ZS_WSYNC
c_func
(paren
id|channel
)paren
suffix:semicolon
)brace
DECL|function|sunzilog_transmit_chars
r_static
r_void
id|sunzilog_transmit_chars
c_func
(paren
r_struct
id|uart_sunzilog_port
op_star
id|sunzilog_port
comma
r_struct
id|sunzilog_channel
op_star
id|channel
)paren
(brace
r_struct
id|circ_buf
op_star
id|xmit
op_assign
op_amp
id|sunzilog_port-&gt;port.info-&gt;xmit
suffix:semicolon
r_int
r_char
id|status
suffix:semicolon
r_int
id|count
suffix:semicolon
id|status
op_assign
id|sbus_readb
c_func
(paren
op_amp
id|channel-&gt;control
)paren
suffix:semicolon
id|ZSDELAY
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* TX still busy?  Just wait for the next TX done interrupt.&n;&t; * XXX This is a bug bug bug if it happens.  It can occur because&n;&t; * XXX of how we used to do serial consoles on Sparc but we should&n;&t; * XXX transmit console writes just like we normally would for normal&n;&t; * XXX UART lines (ie. buffered and TX interrupt driven).  -DaveM&n;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_amp
id|Tx_BUF_EMP
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|sunzilog_port-&gt;port.x_char
)paren
(brace
id|sbus_writeb
c_func
(paren
id|sunzilog-&gt;port.x_char
comma
op_amp
id|channel-&gt;data
)paren
suffix:semicolon
id|ZSDELAY
c_func
(paren
)paren
suffix:semicolon
id|ZS_WSYNC
c_func
(paren
id|channel
)paren
suffix:semicolon
id|sunzilog_port-&gt;port.icount.tx
op_increment
suffix:semicolon
id|sunzilog_port-&gt;port.x_char
op_assign
l_int|0
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|uart_circ_empty
c_func
(paren
id|xmit
)paren
op_logical_or
id|uart_tx_stopped
c_func
(paren
op_amp
id|sunzilog_port-&gt;port
)paren
)paren
(brace
id|sunzilog_stop_tx
c_func
(paren
op_amp
id|sunzilog_port-&gt;port
comma
l_int|0
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|sbus_writeb
c_func
(paren
id|xmit-&gt;buf
(braket
id|xmit-&gt;tail
)braket
comma
op_amp
id|channel-&gt;data
)paren
suffix:semicolon
id|ZSDELAY
c_func
(paren
)paren
suffix:semicolon
id|ZS_WSYNC
c_func
(paren
id|channel
)paren
suffix:semicolon
id|xmit-&gt;tail
op_assign
(paren
id|xmit-&gt;tail
op_plus
l_int|1
)paren
op_amp
(paren
id|UART_XMIT_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
id|sunzilog_port-&gt;port.icount.tx
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|uart_circ_chars_pending
c_func
(paren
id|xmit
)paren
OL
id|WAKEUP_CHARS
)paren
id|uart_event
c_func
(paren
op_amp
id|sunzilog_port-&gt;port
comma
id|EVT_WRITE_WAKEUP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|uart_circ_empty
c_func
(paren
id|xmit
)paren
)paren
id|sunzilog_stop_tx
c_func
(paren
op_amp
id|sunzilog_port-&gt;port
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|sunzilog_interrupt
r_static
r_void
id|sunzilog_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|uart_sunzilog_port
op_star
id|sunzilog_port
op_assign
id|dev_id
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_while
c_loop
(paren
id|sunzilog_port
)paren
(brace
r_struct
id|sunzilog_channel
op_star
id|channel
op_assign
id|ZILOG_CHANNEL_FROM_PORT
c_func
(paren
op_amp
id|sunzilog_port.port
)paren
suffix:semicolon
r_int
r_char
id|r3
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|sunzilog_port-&gt;port.lock
)paren
suffix:semicolon
id|r3
op_assign
id|read_zsreg
c_func
(paren
id|channel
comma
l_int|3
)paren
suffix:semicolon
multiline_comment|/* Channel A */
r_if
c_cond
(paren
id|r3
op_amp
(paren
id|CHAEXT
op_or
id|CHATxIP
op_or
id|CHARxIP
)paren
)paren
(brace
id|sbus_writeb
c_func
(paren
id|RES_H_IUS
comma
op_amp
id|channel-&gt;control
)paren
suffix:semicolon
id|ZSDELAY
c_func
(paren
)paren
suffix:semicolon
id|ZS_WSYNC
c_func
(paren
id|channel
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r3
op_amp
id|CHARxIP
)paren
id|sunzilog_receive_chars
c_func
(paren
id|sunzilog_port
comma
id|channel
comma
id|regs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r3
op_amp
id|CHAEXT
)paren
id|sunzilog_status_handle
c_func
(paren
id|sunzilog_port
comma
id|channel
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r3
op_amp
id|CHATxIP
)paren
id|sunzilog_transmit_chars
c_func
(paren
id|sunzilog_port
comma
id|channel
)paren
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|sunzilog_port-&gt;port.lock
)paren
suffix:semicolon
multiline_comment|/* Channel B */
id|sunzilog_port
op_assign
id|sunzilog_port-&gt;next
suffix:semicolon
id|channel
op_assign
id|ZILOG_CHANNEL_FROM_PORT
c_func
(paren
op_amp
id|sunzilog_port.port
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|sunzilog_port-&gt;port.lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r3
op_amp
(paren
id|CHBEXT
op_or
id|CHBTxIP
op_or
id|CHBRxIP
)paren
)paren
(brace
id|sbus_writeb
c_func
(paren
id|RES_H_IUS
comma
op_amp
id|channel-&gt;control
)paren
suffix:semicolon
id|ZSDELAY
c_func
(paren
)paren
suffix:semicolon
id|ZS_WSYNC
c_func
(paren
id|channel
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r3
op_amp
id|CHBRxIP
)paren
id|sunzilog_receive_chars
c_func
(paren
id|sunzilog_port
comma
id|channel
comma
id|regs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r3
op_amp
id|CHBEXT
)paren
id|sunzilog_status_handle
c_func
(paren
id|sunzilog_port
comma
id|channel
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r3
op_amp
id|CHBTxIP
)paren
id|sunzilog_transmit_chars
c_func
(paren
id|sunzilog_port
comma
id|channel
)paren
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|sunzilog_port-&gt;port.lock
)paren
suffix:semicolon
id|sunzilog_port
op_assign
id|sunzilog_port-&gt;next
suffix:semicolon
)brace
id|spin_lock_irqrestore
c_func
(paren
op_amp
id|sunzilog_lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* The port lock is not held.  */
DECL|function|sunzilog_tx_empty
r_static
r_int
r_int
id|sunzilog_tx_empty
c_func
(paren
r_struct
id|uart_port
op_star
id|port
)paren
(brace
r_int
r_char
id|status
suffix:semicolon
r_int
r_int
id|ret
suffix:semicolon
id|status
op_assign
id|sunzilog_read_channel_status
c_func
(paren
id|port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|Tx_BUF_EMP
)paren
id|ret
op_assign
id|TIOCSER_TEMPT
suffix:semicolon
r_else
id|ret
op_assign
l_int|0
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* The port lock is not held.  */
DECL|function|sunzilog_get_mctrl
r_static
r_int
r_int
id|sunzilog_get_mctrl
c_func
(paren
r_struct
id|uart_port
op_star
id|port
)paren
(brace
r_int
r_char
id|status
suffix:semicolon
r_int
r_int
id|ret
suffix:semicolon
id|status
op_assign
id|sunzilog_read_channel_status
c_func
(paren
id|port
)paren
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|DCD
)paren
id|ret
op_or_assign
id|TIOCM_CAR
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|SYNC
)paren
id|ret
op_or_assign
id|TIOCM_DSR
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|CTS
)paren
id|ret
op_or_assign
id|TIOCM_CTS
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* The port lock is held and interrupts are disabled.  */
DECL|function|sunzilog_set_mctrl
r_static
r_void
id|sunzilog_set_mctrl
c_func
(paren
r_struct
id|uart_port
op_star
id|port
comma
r_int
r_int
id|mctrl
)paren
(brace
r_int
r_char
id|set_bits
comma
id|clear_bits
suffix:semicolon
id|set_bits
op_assign
id|clear_bits
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|mctrl
op_amp
id|TIOCM_RTS
)paren
id|set_bits
op_or_assign
id|RTS
suffix:semicolon
r_else
id|clear_bits
op_or_assign
id|RTS
suffix:semicolon
r_if
c_cond
(paren
id|mctrl
op_amp
id|TIOCM_DTR
)paren
id|set_bits
op_or_assign
id|DTR
suffix:semicolon
r_else
id|clear_bits
op_or_assign
id|DTR
suffix:semicolon
id|__sunzilog_set_clear_bits
c_func
(paren
id|port
comma
l_int|5
comma
id|set_bits
comma
id|clear_bits
)paren
suffix:semicolon
)brace
multiline_comment|/* The port lock is held and interrupts are disabled.  */
DECL|function|sunzilog_stop_tx
r_static
r_void
id|sunzilog_stop_tx
c_func
(paren
r_struct
id|uart_port
op_star
id|port
comma
r_int
r_int
id|tty_stop
)paren
(brace
id|__sunzilog_set_clear_bits
c_func
(paren
id|port
comma
l_int|5
comma
l_int|0
comma
id|TxENAB
)paren
suffix:semicolon
)brace
multiline_comment|/* The port lock is held and interrupts are disabled.  */
DECL|function|sunzilog_start_tx
r_static
r_void
id|sunzilog_start_tx
c_func
(paren
r_struct
id|uart_port
op_star
id|port
comma
r_int
r_int
id|tty_start
)paren
(brace
r_struct
id|uart_sunzilog_port
op_star
id|up
op_assign
(paren
r_struct
id|uart_sunzilog_port
op_star
)paren
id|port
suffix:semicolon
r_struct
id|sunzilog_channel
op_star
id|channel
suffix:semicolon
r_int
r_char
id|status
suffix:semicolon
multiline_comment|/* Enable the transmitter.  */
id|__sunzilog_set_clear_bits
c_func
(paren
id|port
comma
l_int|5
comma
id|TxENAB
comma
l_int|0
)paren
suffix:semicolon
id|channel
op_assign
id|ZILOG_CHANNEL_FROM_PORT
c_func
(paren
id|port
)paren
suffix:semicolon
id|status
op_assign
id|sbus_readb
c_func
(paren
op_amp
id|channel-&gt;control
)paren
suffix:semicolon
id|ZSDELAY
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* TX busy?  Just wait for the TX done interrupt.  */
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_amp
id|Tx_BUF_EMP
)paren
)paren
r_return
suffix:semicolon
multiline_comment|/* Send the first character to jump-start the TX done&n;&t; * IRQ sending engine.&n;&t; */
r_if
c_cond
(paren
id|port-&gt;x_char
)paren
(brace
id|sbus_writeb
c_func
(paren
id|port-&gt;x_char
comma
op_amp
id|channel-&gt;data
)paren
suffix:semicolon
id|ZSDELAY
c_func
(paren
)paren
suffix:semicolon
id|ZS_WSYNC
c_func
(paren
id|channel
)paren
suffix:semicolon
id|port-&gt;icount.tx
op_increment
suffix:semicolon
id|port-&gt;x_char
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
r_struct
id|circ_buf
op_star
id|xmit
op_assign
op_amp
id|port-&gt;info-&gt;xmit
suffix:semicolon
id|sbus_writeb
c_func
(paren
id|xmit-&gt;but
(braket
id|xmit-&gt;tail
)braket
comma
op_amp
id|channel-&gt;data
)paren
suffix:semicolon
id|ZSDELAY
c_func
(paren
)paren
suffix:semicolon
id|ZS_WSYNC
c_func
(paren
id|channel
)paren
suffix:semicolon
id|xmit-&gt;tail
op_assign
(paren
id|xmit-&gt;tail
op_plus
l_int|1
)paren
op_amp
(paren
id|UART_XMIT_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
id|port-&gt;icount.tx
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|uart_circ_chars_pending
c_func
(paren
id|xmit
)paren
OL
id|WAKEUP_CHARS
)paren
id|uart_event
c_func
(paren
op_amp
id|sunzilog_port-&gt;port
comma
id|EVT_WRITE_WAKEUP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|uart_circ_empty
c_func
(paren
id|xmit
)paren
)paren
id|sunzilog_stop_tx
c_func
(paren
op_amp
id|sunzilog_port-&gt;port
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* The port lock is not held.  */
DECL|function|sunzilog_stop_rx
r_static
r_void
id|sunzilog_stop_rx
c_func
(paren
r_struct
id|uart_port
op_star
id|port
)paren
(brace
)brace
multiline_comment|/* The port lock is not held.  */
DECL|function|sunzilog_enable_ms
r_static
r_void
id|sunzilog_enable_ms
c_func
(paren
r_struct
id|uart_port
op_star
id|port
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|port-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|__sunzilog_set_clear_bits
c_func
(paren
id|port
comma
l_int|15
comma
(paren
id|DCDIE
op_or
id|SYNCIE
op_or
id|CTSIE
)paren
comma
l_int|0
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|port-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* The port lock is not held.  */
DECL|function|sunzilog_break_ctl
r_static
r_void
id|sunzilog_break_ctl
c_func
(paren
r_struct
id|uart_port
op_star
id|port
comma
r_int
id|break_state
)paren
(brace
r_int
r_char
id|set_bits
comma
id|clear_bits
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|set_bits
op_assign
id|clear_bits
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|break_state
)paren
id|set_bits
op_or_assign
id|SND_BRK
suffix:semicolon
r_else
id|clear_bits
op_or_assign
id|SND_BRK
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|port-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|__sunzilog_set_clear_bits
c_func
(paren
id|port
comma
l_int|5
comma
id|set_bits
comma
id|clear_bits
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|port-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|sunzilog_startup
r_static
r_int
id|sunzilog_startup
c_func
(paren
r_struct
id|uart_port
op_star
id|port
)paren
(brace
)brace
DECL|function|sunzilog_shutdown
r_static
r_void
id|sunzilog_shutdown
c_func
(paren
r_struct
id|uart_port
op_star
id|port
)paren
(brace
)brace
multiline_comment|/* The port lock is not held.  */
r_static
r_void
DECL|function|sunzilog_change_speed
id|sunzilog_change_speed
c_func
(paren
r_struct
id|uart_port
op_star
id|port
comma
r_int
r_int
id|cflag
comma
r_int
r_int
id|iflag
comma
r_int
r_int
id|quot
)paren
(brace
r_struct
id|uart_sunzilog_port
op_star
id|up
op_assign
(paren
r_struct
id|uart_sunzilog_port
op_star
)paren
id|port
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|up-&gt;port.lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Program BAUD and clock source. */
id|up-&gt;curregs
(braket
l_int|4
)braket
op_and_assign
op_complement
id|XCLK_MASK
suffix:semicolon
id|up-&gt;curregs
(braket
l_int|4
)braket
op_or_assign
id|X16CLK
suffix:semicolon
id|up-&gt;curregs
(braket
l_int|11
)braket
op_assign
id|TCBR
op_or
id|RCBR
suffix:semicolon
multiline_comment|/* XXX verify this stuff XXX */
id|up-&gt;curregs
(braket
l_int|12
)braket
op_assign
id|quot
op_amp
l_int|0xff
suffix:semicolon
id|up-&gt;curregs
(braket
l_int|13
)braket
op_assign
(paren
id|quot
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
id|up-&gt;curregs
(braket
l_int|14
)braket
op_assign
id|BRSRC
op_or
id|BRENAB
suffix:semicolon
id|up-&gt;curregs
(braket
l_int|15
)braket
op_or_assign
id|RTS
op_or
id|DTR
suffix:semicolon
multiline_comment|/* Character size, stop bits, and parity. */
id|up-&gt;curregs
(braket
l_int|3
)braket
op_and_assign
op_complement
id|RxN_MASK
suffix:semicolon
id|up-&gt;curregs
(braket
l_int|5
)braket
op_and_assign
op_complement
id|TxN_MASK
suffix:semicolon
r_switch
c_cond
(paren
id|cflag
op_amp
id|CSIZE
)paren
(brace
r_case
id|CS5
suffix:colon
id|up-&gt;curregs
(braket
l_int|3
)braket
op_or_assign
id|Rx5
suffix:semicolon
id|up-&gt;curregs
(braket
l_int|5
)braket
op_or_assign
id|Tx5
suffix:semicolon
id|up-&gt;parity_mask
op_assign
l_int|0x1f
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS6
suffix:colon
id|up-&gt;curregs
(braket
l_int|3
)braket
op_or_assign
id|Rx6
suffix:semicolon
id|up-&gt;curregs
(braket
l_int|5
)braket
op_or_assign
id|Tx6
suffix:semicolon
id|up-&gt;parity_mask
op_assign
l_int|0x3f
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS7
suffix:colon
id|up-&gt;curregs
(braket
l_int|3
)braket
op_or_assign
id|Rx7
suffix:semicolon
id|up-&gt;curregs
(braket
l_int|5
)braket
op_or_assign
id|Tx7
suffix:semicolon
id|up-&gt;parity_mask
op_assign
l_int|0x7f
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS8
suffix:colon
r_default
suffix:colon
id|up-&gt;curregs
(braket
l_int|3
)braket
op_or_assign
id|Rx8
suffix:semicolon
id|up-&gt;curregs
(braket
l_int|5
)braket
op_or_assign
id|Tx8
suffix:semicolon
id|up-&gt;parity_mask
op_assign
l_int|0xff
suffix:semicolon
r_break
suffix:semicolon
)brace
suffix:semicolon
id|up-&gt;curregs
(braket
l_int|4
)braket
op_and_assign
op_complement
l_int|0x0c
suffix:semicolon
r_if
c_cond
(paren
id|cflag
op_amp
id|CSTOPB
)paren
id|up-&gt;curregs
(braket
l_int|4
)braket
op_or_assign
id|SB2
suffix:semicolon
r_else
id|up-&gt;curregs
(braket
l_int|4
)braket
op_or_assign
id|SB1
suffix:semicolon
r_if
c_cond
(paren
id|cflag
op_amp
id|PARENB
)paren
id|up-&gt;curregs
(braket
l_int|4
)braket
op_or_assign
id|PAR_ENAB
suffix:semicolon
r_else
id|up-&gt;curregs
(braket
l_int|4
)braket
op_and_assign
op_complement
id|PAR_ENAB
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|cflag
op_amp
id|PARODD
)paren
)paren
id|up-&gt;curregs
(braket
l_int|4
)braket
op_or_assign
id|PAR_EVEN
suffix:semicolon
r_else
id|up-&gt;curregs
(braket
l_int|4
)braket
op_and_assign
op_complement
id|PAR_EVEN
suffix:semicolon
id|up-&gt;read_status_mask
op_assign
id|Rx_OVR
suffix:semicolon
r_if
c_cond
(paren
id|iflag
op_amp
id|INPCK
)paren
id|up-&gt;read_status_mask
op_or_assign
id|CRC_ERR
op_or
id|PAR_ERR
suffix:semicolon
r_if
c_cond
(paren
id|iflag
op_amp
(paren
id|BRKINT
op_or
id|PARMRK
)paren
)paren
id|up-&gt;read_status_mask
op_or_assign
id|BRK_ABRT
suffix:semicolon
id|up-&gt;ignore_status_mask
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|iflag
op_amp
id|IGNPAR
)paren
id|up-&gt;ignore_status_mask
op_or_assign
id|CRC_ERR
op_or
id|PAR_ERR
suffix:semicolon
r_if
c_cond
(paren
id|iflag
op_amp
id|IGNBRK
)paren
(brace
id|up-&gt;ignore_status_mask
op_or_assign
id|BRK_ABRT
suffix:semicolon
r_if
c_cond
(paren
id|iflag
op_amp
id|IGNPAR
)paren
id|up-&gt;ignore_status_mask
op_or_assign
id|Rx_OVR
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|cflag
op_amp
id|CREAD
)paren
op_eq
l_int|0
)paren
id|up-&gt;ignore_status_mask
op_assign
l_int|0xff
suffix:semicolon
r_if
c_cond
(paren
id|UART_ENABLE_MS
c_func
(paren
op_amp
id|up-&gt;port
comma
id|cflag
)paren
)paren
id|up-&gt;flags
op_or_assign
id|SUNZILOG_FLAG_MODEM_STATUS
suffix:semicolon
r_else
id|up-&gt;flags
op_and_assign
op_complement
id|SUNZILOG_FLAG_MODEM_STATUS
suffix:semicolon
id|load_zsregs
c_func
(paren
id|up
comma
id|up-&gt;curregs
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|up-&gt;port.lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|sunzilog_type
r_static
r_const
r_char
op_star
id|sunzilog_type
c_func
(paren
r_struct
id|uart_port
op_star
id|port
)paren
(brace
r_return
l_string|&quot;SunZilog&quot;
suffix:semicolon
)brace
multiline_comment|/* We do not request/release mappings of the registers here, this&n; * happens at early serial probe time.&n; */
DECL|function|sunzilog_release_port
r_static
r_void
id|sunzilog_release_port
c_func
(paren
r_struct
id|uart_port
op_star
id|port
)paren
(brace
)brace
DECL|function|sunzilog_request_port
r_static
r_int
id|sunzilog_request_port
c_func
(paren
r_struct
id|uart_port
op_star
id|port
)paren
(brace
)brace
multiline_comment|/* These do not need to do anything interesting either.  */
DECL|function|sunzilog_config_port
r_static
r_void
id|sunzilog_config_port
c_func
(paren
r_struct
id|uart_port
op_star
id|port
comma
r_int
id|flags
)paren
(brace
)brace
DECL|function|sunzilog_verify_port
r_static
r_int
id|sunzilog_verify_port
c_func
(paren
r_struct
id|uart_port
op_star
id|port
comma
r_struct
id|serial_struct
op_star
id|ser
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|sunzilog_pops
r_static
r_struct
id|uart_ops
id|sunzilog_pops
op_assign
(brace
id|tx_empty
suffix:colon
id|sunzilog_tx_empty
comma
id|set_mctrl
suffix:colon
id|sunzilog_set_mctrl
comma
id|get_mctrl
suffix:colon
id|sunzilog_get_mctrl
comma
id|stop_tx
suffix:colon
id|sunzilog_stop_tx
comma
id|start_tx
suffix:colon
id|sunzilog_start_tx
comma
id|stop_rx
suffix:colon
id|sunzilog_stop_rx
comma
id|enable_ms
suffix:colon
id|sunzilog_enable_ms
comma
id|break_ctl
suffix:colon
id|sunzilog_break_ctl
comma
id|startup
suffix:colon
id|sunzilog_startup
comma
id|shutdown
suffix:colon
id|sunzilog_shutdown
comma
id|change_speed
suffix:colon
id|sunzilog_change_speed
comma
id|type
suffix:colon
id|sunzilog_type
comma
id|release_port
suffix:colon
id|sunzilog_release_port
comma
id|request_port
suffix:colon
id|sunzilog_request_port
comma
id|config_port
suffix:colon
id|sunzilog_config_port
comma
id|verify_port
suffix:colon
id|sunzilog_verify_port
comma
)brace
suffix:semicolon
DECL|variable|sunzilog_ports
r_static
r_struct
id|uart_sunzilog_port
id|sunzilog_ports
(braket
id|UART_NR
)braket
suffix:semicolon
DECL|variable|sunzilog_reg
r_static
r_struct
id|uart_driver
id|sunzilog_reg
op_assign
(brace
id|owner
suffix:colon
id|THIS_MODULE
comma
id|driver_name
suffix:colon
l_string|&quot;ttyS&quot;
comma
macro_line|#ifdef CONFIG_DEVFS_FS
id|dev_name
suffix:colon
l_string|&quot;ttyS%d&quot;
comma
macro_line|#else
id|dev_name
suffix:colon
l_string|&quot;ttyS&quot;
comma
macro_line|#endif
id|major
suffix:colon
id|TTY_MAJOR
comma
id|minor
suffix:colon
l_int|64
comma
)brace
suffix:semicolon
DECL|function|sunzilog_alloc_bootmem
r_static
r_void
op_star
id|__init
id|sunzilog_alloc_bootmem
c_func
(paren
r_int
r_int
id|size
)paren
(brace
r_void
op_star
id|ret
suffix:semicolon
id|ret
op_assign
id|__alloc_bootmem
c_func
(paren
id|size
comma
id|SMP_CACHE_BYTES
comma
l_int|0UL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ne
l_int|NULL
)paren
id|memset
c_func
(paren
id|ret
comma
l_int|0
comma
id|size
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|sunzilog_alloc_tables
r_static
r_void
id|__init
id|sunzilog_alloc_tables
c_func
(paren
r_void
)paren
(brace
id|zs_chips
op_assign
(paren
r_struct
id|sun_zslayout
op_star
op_star
)paren
id|zs_alloc_bootmem
c_func
(paren
id|NUM_SERIAL
op_star
r_sizeof
(paren
r_struct
id|sun_zslayout
op_star
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|zs_chips
op_eq
l_int|NULL
)paren
id|zs_init_alloc_failure
c_func
(paren
l_string|&quot;zs_chips&quot;
)paren
suffix:semicolon
id|zs_channels
op_assign
(paren
r_struct
id|sun_zschannel
op_star
op_star
)paren
id|zs_alloc_bootmem
c_func
(paren
id|NUM_CHANNELS
op_star
r_sizeof
(paren
r_struct
id|sun_zschannel
op_star
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|zs_channels
op_eq
l_int|NULL
)paren
id|zs_init_alloc_failure
c_func
(paren
l_string|&quot;zs_channels&quot;
)paren
suffix:semicolon
id|zs_nodes
op_assign
(paren
r_int
op_star
)paren
id|zs_alloc_bootmem
c_func
(paren
id|NUM_SERIAL
op_star
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|zs_nodes
op_eq
l_int|NULL
)paren
id|zs_init_alloc_failure
c_func
(paren
l_string|&quot;zs_nodes&quot;
)paren
suffix:semicolon
id|zs_soft
op_assign
(paren
r_struct
id|sun_serial
op_star
)paren
id|zs_alloc_bootmem
c_func
(paren
id|NUM_CHANNELS
op_star
r_sizeof
(paren
r_struct
id|sun_serial
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|zs_soft
op_eq
l_int|NULL
)paren
id|zs_init_alloc_failure
c_func
(paren
l_string|&quot;zs_soft&quot;
)paren
suffix:semicolon
id|zs_ttys
op_assign
(paren
r_struct
id|tty_struct
op_star
)paren
id|zs_alloc_bootmem
c_func
(paren
id|NUM_CHANNELS
op_star
r_sizeof
(paren
r_struct
id|tty_struct
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|zs_ttys
op_eq
l_int|NULL
)paren
id|zs_init_alloc_failure
c_func
(paren
l_string|&quot;zs_ttys&quot;
)paren
suffix:semicolon
id|serial_table
op_assign
(paren
r_struct
id|tty_struct
op_star
op_star
)paren
id|zs_alloc_bootmem
c_func
(paren
id|NUM_CHANNELS
op_star
r_sizeof
(paren
r_struct
id|tty_struct
op_star
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|serial_table
op_eq
l_int|NULL
)paren
id|zs_init_alloc_failure
c_func
(paren
l_string|&quot;serial_table&quot;
)paren
suffix:semicolon
id|serial_termios
op_assign
(paren
r_struct
id|termios
op_star
op_star
)paren
id|zs_alloc_bootmem
c_func
(paren
id|NUM_CHANNELS
op_star
r_sizeof
(paren
r_struct
id|termios
op_star
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|serial_termios
op_eq
l_int|NULL
)paren
id|zs_init_alloc_failure
c_func
(paren
l_string|&quot;serial_termios&quot;
)paren
suffix:semicolon
id|serial_termios_locked
op_assign
(paren
r_struct
id|termios
op_star
op_star
)paren
id|zs_alloc_bootmem
c_func
(paren
id|NUM_CHANNELS
op_star
r_sizeof
(paren
r_struct
id|termios
op_star
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|serial_termios_locked
op_eq
l_int|NULL
)paren
id|zs_init_alloc_failure
c_func
(paren
l_string|&quot;serial_termios_locked&quot;
)paren
suffix:semicolon
)brace
DECL|function|sunzilog_probe
r_static
r_int
id|__init
id|sunzilog_probe
c_func
(paren
r_void
)paren
(brace
r_int
id|node
suffix:semicolon
multiline_comment|/* Sun4 Zilog setup is hard coded, no probing to do.  */
r_if
c_cond
(paren
id|sparc_cpu_model
op_eq
id|sun4
)paren
r_goto
id|no_probe
suffix:semicolon
id|NUM_SUNZILOG
op_assign
l_int|0
suffix:semicolon
id|node
op_assign
id|prom_getchild
c_func
(paren
id|prom_root_node
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sparc_cpu_model
op_eq
id|sun4d
)paren
(brace
r_int
id|bbnode
suffix:semicolon
r_while
c_loop
(paren
id|node
op_logical_and
(paren
id|node
op_assign
id|prom_searchsiblings
c_func
(paren
id|node
comma
l_string|&quot;cpu-unit&quot;
)paren
)paren
)paren
(brace
id|bbnode
op_assign
id|prom_getchild
c_func
(paren
id|node
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bbnode
op_logical_and
id|prom_searchsiblings
c_func
(paren
id|bbnode
comma
l_string|&quot;bootbus&quot;
)paren
)paren
id|NUM_SUNZILOG
op_add_assign
l_int|2
suffix:semicolon
id|node
op_assign
id|prom_getsibling
c_func
(paren
id|node
)paren
suffix:semicolon
)brace
r_goto
id|no_probe
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_SPARC64
r_else
r_if
c_cond
(paren
id|sparc_cpu_model
op_eq
id|sun4u
)paren
(brace
r_int
id|central_node
suffix:semicolon
multiline_comment|/* Central bus zilogs must be checked for first,&n;&t;&t; * since Enterprise boxes might have SBUSes as well.&n;&t;&t; */
id|central_node
op_assign
id|prom_finddevice
c_func
(paren
l_string|&quot;/central&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|central_node
op_ne
l_int|0
op_logical_and
id|central_node
op_ne
op_minus
l_int|1
)paren
(brace
id|node
op_assign
id|prom_searchsiblings
c_func
(paren
id|prom_getchild
c_func
(paren
id|central_node
)paren
comma
l_string|&quot;fhc&quot;
)paren
suffix:semicolon
)brace
r_else
id|node
op_assign
id|prom_searchsiblings
c_func
(paren
id|node
comma
l_string|&quot;sbus&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|node
op_ne
l_int|0
op_logical_and
id|node
op_ne
op_minus
l_int|1
)paren
(brace
id|node
op_assign
id|prom_getchild
c_func
(paren
id|node
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|node
op_eq
l_int|0
op_logical_or
id|node
op_eq
op_minus
l_int|1
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
)brace
macro_line|#endif /* CONFIG_SPARC64 */
r_else
(brace
id|node
op_assign
id|prom_searchsiblings
c_func
(paren
id|node
comma
l_string|&quot;obio&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|node
)paren
(brace
id|node
op_assign
id|prom_getchild
c_func
(paren
id|node
)paren
suffix:semicolon
)brace
id|NUM_SERIAL
op_assign
l_int|2
suffix:semicolon
r_goto
id|no_probe
suffix:semicolon
)brace
id|node
op_assign
id|prom_searchsiblings
c_func
(paren
id|node
comma
l_string|&quot;zs&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|node
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|NUM_SERIAL
op_assign
l_int|2
suffix:semicolon
id|no_probe
suffix:colon
id|sunzilog_alloc_tables
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|sunzilog_init
r_static
r_int
id|__init
id|sunzilog_init
c_func
(paren
r_void
)paren
(brace
r_int
id|ret
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Serial: Sun Zilog driver.&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* We can only init this once we have probed the Zilogs&n;&t; * in the system.&n;&t; */
id|sunzilog_reg.nr
op_assign
id|NUM_CHANNELS
suffix:semicolon
multiline_comment|/* XXX This is probably where this needs to be setup for&n;&t; * XXX the same reason.&n;&t; */
id|sunzilog_reg.cons
op_assign
id|XXX
suffix:semicolon
id|ret
op_assign
id|uart_register_driver
c_func
(paren
op_amp
id|sunzilog_reg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
l_int|0
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|UART_NR
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* XXX For each probed Zilog do this... */
id|uart_add_one_port
c_func
(paren
op_amp
id|sunzilog_reg
comma
op_amp
id|sunzilog_ports
(braket
id|i
)braket
dot
id|port
)paren
suffix:semicolon
)brace
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|function|sunzilog_exit
r_static
r_void
id|__exit
id|sunzilog_exit
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|UART_NR
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* XXX For each probed Zilog do this... */
id|uart_remove_one_port
c_func
(paren
op_amp
id|sunzilog_reg
comma
op_amp
id|sunzilog_ports
(braket
id|i
)braket
dot
id|port
)paren
suffix:semicolon
)brace
id|uart_unregister_driver
c_func
(paren
op_amp
id|sunzilog_reg
)paren
suffix:semicolon
)brace
DECL|variable|sunzilog_init
id|module_init
c_func
(paren
id|sunzilog_init
)paren
suffix:semicolon
DECL|variable|sunzilog_exit
id|module_exit
c_func
(paren
id|sunzilog_exit
)paren
suffix:semicolon
id|EXPORT_NO_SYMBOLS
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;David S. Miller&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Sun Zilog serial port driver&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
eof
