multiline_comment|/*&n; * drivers/serial/mpc52xx_uart.c&n; *&n; * Driver for the PSC of the Freescale MPC52xx PSCs configured as UARTs.&n; *&n; * FIXME According to the usermanual the status bits in the status register&n; * are only updated when the peripherals access the FIFO and not when the&n; * CPU access them. So since we use this bits to know when we stop writing&n; * and reading, they may not be updated in-time and a race condition may&n; * exists. But I haven&squot;t be able to prove this and I don&squot;t care. But if&n; * any problem arises, it might worth checking. The TX/RX FIFO Stats&n; * registers should be used in addition.&n; * Update: Actually, they seem updated ... At least the bits we use.&n; *&n; *&n; * Maintainer : Sylvain Munaut &lt;tnt@246tNt.com&gt;&n; * &n; * Some of the code has been inspired/copied from the 2.4 code written&n; * by Dale Farnsworth &lt;dfarnsworth@mvista.com&gt;.&n; * &n; * Copyright (C) 2004 Sylvain Munaut &lt;tnt@246tNt.com&gt;&n; * Copyright (C) 2003 MontaVista, Software, Inc.&n; * &n; * This file is licensed under the terms of the GNU General Public License&n; * version 2. This program is licensed &quot;as is&quot; without any warranty of any&n; * kind, whether express or implied.&n; */
multiline_comment|/* OCP Usage :&n; *&n; * This drivers uses the OCP model. To load the serial driver for one of the&n; * PSCs, just add this to the core_ocp table :&n; *&n; * {&n; * &t;.vendor         = OCP_VENDOR_FREESCALE,&n; * &t;.function       = OCP_FUNC_PSC_UART,&n; * &t;.index          = 0,&n; * &t;.paddr          = MPC52xx_PSC1,&n; * &t;.irq            = MPC52xx_PSC1_IRQ,&n; * &t;.pm             = OCP_CPM_NA,&n; * },&n; *&n; * This is for PSC1, replace the paddr and irq according to the PSC you want to&n; * use. The driver all necessary registers to place the PSC in uart mode without&n; * DCD. However, the pin multiplexing aren&squot;t changed and should be set either&n; * by the bootloader or in the platform init code.&n; * The index field must be equal to the PSC index ( e.g. 0 for PSC1, 1 for PSC2,&n; * and so on). So the PSC1 is mapped to /dev/ttyS0, PSC2 to /dev/ttyS1 and so&n; * on. But be warned, it&squot;s an ABSOLUTE REQUIREMENT ! This is needed mainly for&n; * the console code : without this 1:1 mapping, at early boot time, when we are&n; * parsing the kernel args console=ttyS?, we wouldn&squot;t know wich PSC it will be&n; * mapped to because OCP stuff is not yet initialized.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/serial.h&gt;
macro_line|#include &lt;linux/sysrq.h&gt;
macro_line|#include &lt;linux/console.h&gt;
macro_line|#include &lt;asm/delay.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/ocp.h&gt;
macro_line|#include &lt;asm/mpc52xx.h&gt;
macro_line|#include &lt;asm/mpc52xx_psc.h&gt;
macro_line|#if defined(CONFIG_SERIAL_MPC52xx_CONSOLE) &amp;&amp; defined(CONFIG_MAGIC_SYSRQ)
DECL|macro|SUPPORT_SYSRQ
mdefine_line|#define SUPPORT_SYSRQ
macro_line|#endif
macro_line|#include &lt;linux/serial_core.h&gt;
DECL|macro|ISR_PASS_LIMIT
mdefine_line|#define ISR_PASS_LIMIT 256&t;/* Max number of iteration in the interrupt */
DECL|variable|mpc52xx_uart_ports
r_static
r_struct
id|uart_port
id|mpc52xx_uart_ports
(braket
id|MPC52xx_PSC_MAXNUM
)braket
suffix:semicolon
multiline_comment|/* Rem: - We use the read_status_mask as a shadow of&n;&t; *        psc-&gt;mpc52xx_psc_imr&n;&t; *      - It&squot;s important that is array is all zero on start as we&n;&t; *        use it to know if it&squot;s initialized or not ! If it&squot;s not sure&n;&t; *        it&squot;s cleared, then a memset(...,0,...) should be added to&n;&t; *        the console_init&n;&t; */
DECL|macro|PSC
mdefine_line|#define PSC(port) ((struct mpc52xx_psc *)((port)-&gt;membase))
multiline_comment|/* Forward declaration of the interruption handling routine */
r_static
id|irqreturn_t
id|mpc52xx_uart_int
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
suffix:semicolon
multiline_comment|/* Simple macro to test if a port is console or not. This one is taken&n; * for serial_core.c and maybe should be moved to serial_core.h ? */
macro_line|#ifdef CONFIG_SERIAL_CORE_CONSOLE
DECL|macro|uart_console
mdefine_line|#define uart_console(port)&t;((port)-&gt;cons &amp;&amp; (port)-&gt;cons-&gt;index == (port)-&gt;line)
macro_line|#else
DECL|macro|uart_console
mdefine_line|#define uart_console(port)&t;(0)
macro_line|#endif
multiline_comment|/* ======================================================================== */
multiline_comment|/* UART operations                                                          */
multiline_comment|/* ======================================================================== */
r_static
r_int
r_int
DECL|function|mpc52xx_uart_tx_empty
id|mpc52xx_uart_tx_empty
c_func
(paren
r_struct
id|uart_port
op_star
id|port
)paren
(brace
r_int
id|status
op_assign
id|in_be16
c_func
(paren
op_amp
id|PSC
c_func
(paren
id|port
)paren
op_member_access_from_pointer
id|mpc52xx_psc_status
)paren
suffix:semicolon
r_return
(paren
id|status
op_amp
id|MPC52xx_PSC_SR_TXEMP
)paren
ques
c_cond
id|TIOCSER_TEMT
suffix:colon
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|mpc52xx_uart_set_mctrl
id|mpc52xx_uart_set_mctrl
c_func
(paren
r_struct
id|uart_port
op_star
id|port
comma
r_int
r_int
id|mctrl
)paren
(brace
multiline_comment|/* Not implemented */
)brace
r_static
r_int
r_int
DECL|function|mpc52xx_uart_get_mctrl
id|mpc52xx_uart_get_mctrl
c_func
(paren
r_struct
id|uart_port
op_star
id|port
)paren
(brace
multiline_comment|/* Not implemented */
r_return
id|TIOCM_CTS
op_or
id|TIOCM_DSR
op_or
id|TIOCM_CAR
suffix:semicolon
)brace
r_static
r_void
DECL|function|mpc52xx_uart_stop_tx
id|mpc52xx_uart_stop_tx
c_func
(paren
r_struct
id|uart_port
op_star
id|port
comma
r_int
r_int
id|tty_stop
)paren
(brace
multiline_comment|/* port-&gt;lock taken by caller */
id|port-&gt;read_status_mask
op_and_assign
op_complement
id|MPC52xx_PSC_IMR_TXRDY
suffix:semicolon
id|out_be16
c_func
(paren
op_amp
id|PSC
c_func
(paren
id|port
)paren
op_member_access_from_pointer
id|mpc52xx_psc_imr
comma
id|port-&gt;read_status_mask
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|mpc52xx_uart_start_tx
id|mpc52xx_uart_start_tx
c_func
(paren
r_struct
id|uart_port
op_star
id|port
comma
r_int
r_int
id|tty_start
)paren
(brace
multiline_comment|/* port-&gt;lock taken by caller */
id|port-&gt;read_status_mask
op_or_assign
id|MPC52xx_PSC_IMR_TXRDY
suffix:semicolon
id|out_be16
c_func
(paren
op_amp
id|PSC
c_func
(paren
id|port
)paren
op_member_access_from_pointer
id|mpc52xx_psc_imr
comma
id|port-&gt;read_status_mask
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|mpc52xx_uart_send_xchar
id|mpc52xx_uart_send_xchar
c_func
(paren
r_struct
id|uart_port
op_star
id|port
comma
r_char
id|ch
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|port-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|port-&gt;x_char
op_assign
id|ch
suffix:semicolon
r_if
c_cond
(paren
id|ch
)paren
(brace
multiline_comment|/* Make sure tx interrupts are on */
multiline_comment|/* Truly necessary ??? They should be anyway */
id|port-&gt;read_status_mask
op_or_assign
id|MPC52xx_PSC_IMR_TXRDY
suffix:semicolon
id|out_be16
c_func
(paren
op_amp
id|PSC
c_func
(paren
id|port
)paren
op_member_access_from_pointer
id|mpc52xx_psc_imr
comma
id|port-&gt;read_status_mask
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|port-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|mpc52xx_uart_stop_rx
id|mpc52xx_uart_stop_rx
c_func
(paren
r_struct
id|uart_port
op_star
id|port
)paren
(brace
multiline_comment|/* port-&gt;lock taken by caller */
id|port-&gt;read_status_mask
op_and_assign
op_complement
id|MPC52xx_PSC_IMR_RXRDY
suffix:semicolon
id|out_be16
c_func
(paren
op_amp
id|PSC
c_func
(paren
id|port
)paren
op_member_access_from_pointer
id|mpc52xx_psc_imr
comma
id|port-&gt;read_status_mask
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|mpc52xx_uart_enable_ms
id|mpc52xx_uart_enable_ms
c_func
(paren
r_struct
id|uart_port
op_star
id|port
)paren
(brace
multiline_comment|/* Not implemented */
)brace
r_static
r_void
DECL|function|mpc52xx_uart_break_ctl
id|mpc52xx_uart_break_ctl
c_func
(paren
r_struct
id|uart_port
op_star
id|port
comma
r_int
id|ctl
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|port-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ctl
op_eq
op_minus
l_int|1
)paren
id|out_8
c_func
(paren
op_amp
id|PSC
c_func
(paren
id|port
)paren
op_member_access_from_pointer
id|command
comma
id|MPC52xx_PSC_START_BRK
)paren
suffix:semicolon
r_else
id|out_8
c_func
(paren
op_amp
id|PSC
c_func
(paren
id|port
)paren
op_member_access_from_pointer
id|command
comma
id|MPC52xx_PSC_STOP_BRK
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|port-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|mpc52xx_uart_startup
id|mpc52xx_uart_startup
c_func
(paren
r_struct
id|uart_port
op_star
id|port
)paren
(brace
r_struct
id|mpc52xx_psc
op_star
id|psc
op_assign
id|PSC
c_func
(paren
id|port
)paren
suffix:semicolon
multiline_comment|/* Reset/activate the port, clear and enable interrupts */
id|out_8
c_func
(paren
op_amp
id|psc-&gt;command
comma
id|MPC52xx_PSC_RST_RX
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|psc-&gt;command
comma
id|MPC52xx_PSC_RST_TX
)paren
suffix:semicolon
id|out_be32
c_func
(paren
op_amp
id|psc-&gt;sicr
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* UART mode DCD ignored */
id|out_be16
c_func
(paren
op_amp
id|psc-&gt;mpc52xx_psc_clock_select
comma
l_int|0xdd00
)paren
suffix:semicolon
multiline_comment|/* /16 prescaler on */
id|out_8
c_func
(paren
op_amp
id|psc-&gt;rfcntl
comma
l_int|0x00
)paren
suffix:semicolon
id|out_be16
c_func
(paren
op_amp
id|psc-&gt;rfalarm
comma
l_int|0x1ff
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|psc-&gt;tfcntl
comma
l_int|0x07
)paren
suffix:semicolon
id|out_be16
c_func
(paren
op_amp
id|psc-&gt;tfalarm
comma
l_int|0x80
)paren
suffix:semicolon
id|port-&gt;read_status_mask
op_or_assign
id|MPC52xx_PSC_IMR_RXRDY
op_or
id|MPC52xx_PSC_IMR_TXRDY
suffix:semicolon
id|out_be16
c_func
(paren
op_amp
id|psc-&gt;mpc52xx_psc_imr
comma
id|port-&gt;read_status_mask
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|psc-&gt;command
comma
id|MPC52xx_PSC_TX_ENABLE
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|psc-&gt;command
comma
id|MPC52xx_PSC_RX_ENABLE
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|mpc52xx_uart_shutdown
id|mpc52xx_uart_shutdown
c_func
(paren
r_struct
id|uart_port
op_star
id|port
)paren
(brace
r_struct
id|mpc52xx_psc
op_star
id|psc
op_assign
id|PSC
c_func
(paren
id|port
)paren
suffix:semicolon
multiline_comment|/* Shut down the port, interrupt and all */
id|out_8
c_func
(paren
op_amp
id|psc-&gt;command
comma
id|MPC52xx_PSC_RST_RX
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|psc-&gt;command
comma
id|MPC52xx_PSC_RST_TX
)paren
suffix:semicolon
id|port-&gt;read_status_mask
op_assign
l_int|0
suffix:semicolon
id|out_be16
c_func
(paren
op_amp
id|psc-&gt;mpc52xx_psc_imr
comma
id|port-&gt;read_status_mask
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|mpc52xx_uart_set_termios
id|mpc52xx_uart_set_termios
c_func
(paren
r_struct
id|uart_port
op_star
id|port
comma
r_struct
id|termios
op_star
r_new
comma
r_struct
id|termios
op_star
id|old
)paren
(brace
r_struct
id|mpc52xx_psc
op_star
id|psc
op_assign
id|PSC
c_func
(paren
id|port
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
r_char
id|mr1
comma
id|mr2
suffix:semicolon
r_int
r_int
id|ctr
suffix:semicolon
r_int
r_int
id|j
comma
id|baud
comma
id|quot
suffix:semicolon
multiline_comment|/* Prepare what we&squot;re gonna write */
id|mr1
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
r_new
op_member_access_from_pointer
id|c_cflag
op_amp
id|CSIZE
)paren
(brace
r_case
id|CS5
suffix:colon
id|mr1
op_or_assign
id|MPC52xx_PSC_MODE_5_BITS
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS6
suffix:colon
id|mr1
op_or_assign
id|MPC52xx_PSC_MODE_6_BITS
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS7
suffix:colon
id|mr1
op_or_assign
id|MPC52xx_PSC_MODE_7_BITS
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS8
suffix:colon
r_default
suffix:colon
id|mr1
op_or_assign
id|MPC52xx_PSC_MODE_8_BITS
suffix:semicolon
)brace
r_if
c_cond
(paren
r_new
op_member_access_from_pointer
id|c_cflag
op_amp
id|PARENB
)paren
(brace
id|mr1
op_or_assign
(paren
r_new
op_member_access_from_pointer
id|c_cflag
op_amp
id|PARODD
)paren
ques
c_cond
id|MPC52xx_PSC_MODE_PARODD
suffix:colon
id|MPC52xx_PSC_MODE_PAREVEN
suffix:semicolon
)brace
r_else
id|mr1
op_or_assign
id|MPC52xx_PSC_MODE_PARNONE
suffix:semicolon
id|mr2
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
r_new
op_member_access_from_pointer
id|c_cflag
op_amp
id|CSTOPB
)paren
id|mr2
op_or_assign
id|MPC52xx_PSC_MODE_TWO_STOP
suffix:semicolon
r_else
id|mr2
op_or_assign
(paren
(paren
r_new
op_member_access_from_pointer
id|c_cflag
op_amp
id|CSIZE
)paren
op_eq
id|CS5
)paren
ques
c_cond
id|MPC52xx_PSC_MODE_ONE_STOP_5_BITS
suffix:colon
id|MPC52xx_PSC_MODE_ONE_STOP
suffix:semicolon
id|baud
op_assign
id|uart_get_baud_rate
c_func
(paren
id|port
comma
r_new
comma
id|old
comma
l_int|0
comma
id|port-&gt;uartclk
op_div
l_int|16
)paren
suffix:semicolon
id|quot
op_assign
id|uart_get_divisor
c_func
(paren
id|port
comma
id|baud
)paren
suffix:semicolon
id|ctr
op_assign
id|quot
op_amp
l_int|0xffff
suffix:semicolon
multiline_comment|/* Get the lock */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|port-&gt;lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* Update the per-port timeout */
id|uart_update_timeout
c_func
(paren
id|port
comma
r_new
op_member_access_from_pointer
id|c_cflag
comma
id|baud
)paren
suffix:semicolon
multiline_comment|/* Do our best to flush TX &amp; RX, so we don&squot;t loose anything */
multiline_comment|/* But we don&squot;t wait indefinitly ! */
id|j
op_assign
l_int|5000000
suffix:semicolon
multiline_comment|/* Maximum wait */
multiline_comment|/* FIXME Can&squot;t receive chars since set_termios might be called at early&n;&t; * boot for the console, all stuff is not yet ready to receive at that&n;&t; * time and that just makes the kernel oops */
multiline_comment|/* while (j-- &amp;&amp; mpc52xx_uart_int_rx_chars(port)); */
r_while
c_loop
(paren
op_logical_neg
(paren
id|in_be16
c_func
(paren
op_amp
id|psc-&gt;mpc52xx_psc_status
)paren
op_amp
id|MPC52xx_PSC_SR_TXEMP
)paren
op_logical_and
op_decrement
id|j
)paren
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|j
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;mpc52xx_uart.c: &quot;
l_string|&quot;Unable to flush RX &amp; TX fifos in-time in set_termios.&quot;
l_string|&quot;Some chars may have been lost.&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Reset the TX &amp; RX */
id|out_8
c_func
(paren
op_amp
id|psc-&gt;command
comma
id|MPC52xx_PSC_RST_RX
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|psc-&gt;command
comma
id|MPC52xx_PSC_RST_TX
)paren
suffix:semicolon
multiline_comment|/* Send new mode settings */
id|out_8
c_func
(paren
op_amp
id|psc-&gt;command
comma
id|MPC52xx_PSC_SEL_MODE_REG_1
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|psc-&gt;mode
comma
id|mr1
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|psc-&gt;mode
comma
id|mr2
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|psc-&gt;ctur
comma
id|ctr
op_rshift
l_int|8
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|psc-&gt;ctlr
comma
id|ctr
op_amp
l_int|0xff
)paren
suffix:semicolon
multiline_comment|/* Reenable TX &amp; RX */
id|out_8
c_func
(paren
op_amp
id|psc-&gt;command
comma
id|MPC52xx_PSC_TX_ENABLE
)paren
suffix:semicolon
id|out_8
c_func
(paren
op_amp
id|psc-&gt;command
comma
id|MPC52xx_PSC_RX_ENABLE
)paren
suffix:semicolon
multiline_comment|/* We&squot;re all set, release the lock */
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|port-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_static
r_const
r_char
op_star
DECL|function|mpc52xx_uart_type
id|mpc52xx_uart_type
c_func
(paren
r_struct
id|uart_port
op_star
id|port
)paren
(brace
r_return
id|port-&gt;type
op_eq
id|PORT_MPC52xx
ques
c_cond
l_string|&quot;MPC52xx PSC&quot;
suffix:colon
l_int|NULL
suffix:semicolon
)brace
r_static
r_void
DECL|function|mpc52xx_uart_release_port
id|mpc52xx_uart_release_port
c_func
(paren
r_struct
id|uart_port
op_star
id|port
)paren
(brace
r_if
c_cond
(paren
id|port-&gt;flags
op_amp
id|UPF_IOREMAP
)paren
(brace
multiline_comment|/* remapped by us ? */
id|iounmap
c_func
(paren
id|port-&gt;membase
)paren
suffix:semicolon
id|port-&gt;membase
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
r_static
r_int
DECL|function|mpc52xx_uart_request_port
id|mpc52xx_uart_request_port
c_func
(paren
r_struct
id|uart_port
op_star
id|port
)paren
(brace
r_if
c_cond
(paren
id|port-&gt;flags
op_amp
id|UPF_IOREMAP
)paren
multiline_comment|/* Need to remap ? */
id|port-&gt;membase
op_assign
id|ioremap
c_func
(paren
id|port-&gt;mapbase
comma
r_sizeof
(paren
r_struct
id|mpc52xx_psc
)paren
)paren
suffix:semicolon
r_return
id|port-&gt;membase
op_ne
l_int|NULL
ques
c_cond
l_int|0
suffix:colon
op_minus
id|EBUSY
suffix:semicolon
)brace
r_static
r_void
DECL|function|mpc52xx_uart_config_port
id|mpc52xx_uart_config_port
c_func
(paren
r_struct
id|uart_port
op_star
id|port
comma
r_int
id|flags
)paren
(brace
r_if
c_cond
(paren
(paren
id|flags
op_amp
id|UART_CONFIG_TYPE
)paren
op_logical_and
(paren
id|mpc52xx_uart_request_port
c_func
(paren
id|port
)paren
op_eq
l_int|0
)paren
)paren
id|port-&gt;type
op_assign
id|PORT_MPC52xx
suffix:semicolon
)brace
r_static
r_int
DECL|function|mpc52xx_uart_verify_port
id|mpc52xx_uart_verify_port
c_func
(paren
r_struct
id|uart_port
op_star
id|port
comma
r_struct
id|serial_struct
op_star
id|ser
)paren
(brace
r_if
c_cond
(paren
id|ser-&gt;type
op_ne
id|PORT_UNKNOWN
op_logical_and
id|ser-&gt;type
op_ne
id|PORT_MPC52xx
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ser-&gt;irq
op_ne
id|port-&gt;irq
)paren
op_logical_or
(paren
id|ser-&gt;io_type
op_ne
id|SERIAL_IO_MEM
)paren
op_logical_or
(paren
id|ser-&gt;baud_base
op_ne
id|port-&gt;uartclk
)paren
op_logical_or
singleline_comment|// FIXME Should check addresses/irq as well ?
(paren
id|ser-&gt;hub6
op_ne
l_int|0
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|mpc52xx_uart_ops
r_static
r_struct
id|uart_ops
id|mpc52xx_uart_ops
op_assign
(brace
dot
id|tx_empty
op_assign
id|mpc52xx_uart_tx_empty
comma
dot
id|set_mctrl
op_assign
id|mpc52xx_uart_set_mctrl
comma
dot
id|get_mctrl
op_assign
id|mpc52xx_uart_get_mctrl
comma
dot
id|stop_tx
op_assign
id|mpc52xx_uart_stop_tx
comma
dot
id|start_tx
op_assign
id|mpc52xx_uart_start_tx
comma
dot
id|send_xchar
op_assign
id|mpc52xx_uart_send_xchar
comma
dot
id|stop_rx
op_assign
id|mpc52xx_uart_stop_rx
comma
dot
id|enable_ms
op_assign
id|mpc52xx_uart_enable_ms
comma
dot
id|break_ctl
op_assign
id|mpc52xx_uart_break_ctl
comma
dot
id|startup
op_assign
id|mpc52xx_uart_startup
comma
dot
id|shutdown
op_assign
id|mpc52xx_uart_shutdown
comma
dot
id|set_termios
op_assign
id|mpc52xx_uart_set_termios
comma
multiline_comment|/*&t;.pm&t;&t;= mpc52xx_uart_pm,&t;&t;Not supported yet */
multiline_comment|/*&t;.set_wake&t;= mpc52xx_uart_set_wake,&t;Not supported yet */
dot
id|type
op_assign
id|mpc52xx_uart_type
comma
dot
id|release_port
op_assign
id|mpc52xx_uart_release_port
comma
dot
id|request_port
op_assign
id|mpc52xx_uart_request_port
comma
dot
id|config_port
op_assign
id|mpc52xx_uart_config_port
comma
dot
id|verify_port
op_assign
id|mpc52xx_uart_verify_port
)brace
suffix:semicolon
multiline_comment|/* ======================================================================== */
multiline_comment|/* Interrupt handling                                                       */
multiline_comment|/* ======================================================================== */
r_static
r_inline
r_int
DECL|function|mpc52xx_uart_int_rx_chars
id|mpc52xx_uart_int_rx_chars
c_func
(paren
r_struct
id|uart_port
op_star
id|port
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|tty_struct
op_star
id|tty
op_assign
id|port-&gt;info-&gt;tty
suffix:semicolon
r_int
r_char
id|ch
suffix:semicolon
r_int
r_int
id|status
suffix:semicolon
multiline_comment|/* While we can read, do so ! */
r_while
c_loop
(paren
(paren
id|status
op_assign
id|in_be16
c_func
(paren
op_amp
id|PSC
c_func
(paren
id|port
)paren
op_member_access_from_pointer
id|mpc52xx_psc_status
)paren
)paren
op_amp
id|MPC52xx_PSC_SR_RXRDY
)paren
(brace
multiline_comment|/* If we are full, just stop reading */
r_if
c_cond
(paren
id|tty-&gt;flip.count
op_ge
id|TTY_FLIPBUF_SIZE
)paren
r_break
suffix:semicolon
multiline_comment|/* Get the char */
id|ch
op_assign
id|in_8
c_func
(paren
op_amp
id|PSC
c_func
(paren
id|port
)paren
op_member_access_from_pointer
id|mpc52xx_psc_buffer_8
)paren
suffix:semicolon
multiline_comment|/* Handle sysreq char */
macro_line|#ifdef SUPPORT_SYSRQ
r_if
c_cond
(paren
id|uart_handle_sysrq_char
c_func
(paren
id|port
comma
id|ch
comma
id|regs
)paren
)paren
(brace
id|port-&gt;sysrq
op_assign
l_int|0
suffix:semicolon
r_continue
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* Store it */
op_star
id|tty-&gt;flip.char_buf_ptr
op_assign
id|ch
suffix:semicolon
op_star
id|tty-&gt;flip.flag_buf_ptr
op_assign
l_int|0
suffix:semicolon
id|port-&gt;icount.rx
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
(paren
id|MPC52xx_PSC_SR_PE
op_or
id|MPC52xx_PSC_SR_FE
op_or
id|MPC52xx_PSC_SR_RB
op_or
id|MPC52xx_PSC_SR_OE
)paren
)paren
(brace
r_if
c_cond
(paren
id|status
op_amp
id|MPC52xx_PSC_SR_RB
)paren
(brace
op_star
id|tty-&gt;flip.flag_buf_ptr
op_assign
id|TTY_BREAK
suffix:semicolon
id|uart_handle_break
c_func
(paren
id|port
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|status
op_amp
id|MPC52xx_PSC_SR_PE
)paren
op_star
id|tty-&gt;flip.flag_buf_ptr
op_assign
id|TTY_PARITY
suffix:semicolon
r_else
r_if
c_cond
(paren
id|status
op_amp
id|MPC52xx_PSC_SR_FE
)paren
op_star
id|tty-&gt;flip.flag_buf_ptr
op_assign
id|TTY_FRAME
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|MPC52xx_PSC_SR_OE
)paren
(brace
multiline_comment|/*&n;&t;&t;&t;&t; * Overrun is special, since it&squot;s&n;&t;&t;&t;&t; * reported immediately, and doesn&squot;t&n;&t;&t;&t;&t; * affect the current character&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|tty-&gt;flip.count
OL
(paren
id|TTY_FLIPBUF_SIZE
op_minus
l_int|1
)paren
)paren
(brace
id|tty-&gt;flip.flag_buf_ptr
op_increment
suffix:semicolon
id|tty-&gt;flip.char_buf_ptr
op_increment
suffix:semicolon
id|tty-&gt;flip.count
op_increment
suffix:semicolon
)brace
op_star
id|tty-&gt;flip.flag_buf_ptr
op_assign
id|TTY_OVERRUN
suffix:semicolon
)brace
multiline_comment|/* Clear error condition */
id|out_8
c_func
(paren
op_amp
id|PSC
c_func
(paren
id|port
)paren
op_member_access_from_pointer
id|command
comma
id|MPC52xx_PSC_RST_ERR_STAT
)paren
suffix:semicolon
)brace
id|tty-&gt;flip.char_buf_ptr
op_increment
suffix:semicolon
id|tty-&gt;flip.flag_buf_ptr
op_increment
suffix:semicolon
id|tty-&gt;flip.count
op_increment
suffix:semicolon
)brace
id|tty_flip_buffer_push
c_func
(paren
id|tty
)paren
suffix:semicolon
r_return
id|in_be16
c_func
(paren
op_amp
id|PSC
c_func
(paren
id|port
)paren
op_member_access_from_pointer
id|mpc52xx_psc_status
)paren
op_amp
id|MPC52xx_PSC_SR_RXRDY
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|mpc52xx_uart_int_tx_chars
id|mpc52xx_uart_int_tx_chars
c_func
(paren
r_struct
id|uart_port
op_star
id|port
)paren
(brace
r_struct
id|circ_buf
op_star
id|xmit
op_assign
op_amp
id|port-&gt;info-&gt;xmit
suffix:semicolon
multiline_comment|/* Process out of band chars */
r_if
c_cond
(paren
id|port-&gt;x_char
)paren
(brace
id|out_8
c_func
(paren
op_amp
id|PSC
c_func
(paren
id|port
)paren
op_member_access_from_pointer
id|mpc52xx_psc_buffer_8
comma
id|port-&gt;x_char
)paren
suffix:semicolon
id|port-&gt;icount.tx
op_increment
suffix:semicolon
id|port-&gt;x_char
op_assign
l_int|0
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Nothing to do ? */
r_if
c_cond
(paren
id|uart_circ_empty
c_func
(paren
id|xmit
)paren
op_logical_or
id|uart_tx_stopped
c_func
(paren
id|port
)paren
)paren
(brace
id|mpc52xx_uart_stop_tx
c_func
(paren
id|port
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Send chars */
r_while
c_loop
(paren
id|in_be16
c_func
(paren
op_amp
id|PSC
c_func
(paren
id|port
)paren
op_member_access_from_pointer
id|mpc52xx_psc_status
)paren
op_amp
id|MPC52xx_PSC_SR_TXRDY
)paren
(brace
id|out_8
c_func
(paren
op_amp
id|PSC
c_func
(paren
id|port
)paren
op_member_access_from_pointer
id|mpc52xx_psc_buffer_8
comma
id|xmit-&gt;buf
(braket
id|xmit-&gt;tail
)braket
)paren
suffix:semicolon
id|xmit-&gt;tail
op_assign
(paren
id|xmit-&gt;tail
op_plus
l_int|1
)paren
op_amp
(paren
id|UART_XMIT_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
id|port-&gt;icount.tx
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|uart_circ_empty
c_func
(paren
id|xmit
)paren
)paren
r_break
suffix:semicolon
)brace
multiline_comment|/* Wake up */
r_if
c_cond
(paren
id|uart_circ_chars_pending
c_func
(paren
id|xmit
)paren
OL
id|WAKEUP_CHARS
)paren
id|uart_write_wakeup
c_func
(paren
id|port
)paren
suffix:semicolon
multiline_comment|/* Maybe we&squot;re done after all */
r_if
c_cond
(paren
id|uart_circ_empty
c_func
(paren
id|xmit
)paren
)paren
(brace
id|mpc52xx_uart_stop_tx
c_func
(paren
id|port
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
r_static
id|irqreturn_t
DECL|function|mpc52xx_uart_int
id|mpc52xx_uart_int
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|uart_port
op_star
id|port
op_assign
(paren
r_struct
id|uart_port
op_star
)paren
id|dev_id
suffix:semicolon
r_int
r_int
id|pass
op_assign
id|ISR_PASS_LIMIT
suffix:semicolon
r_int
r_int
id|keepgoing
suffix:semicolon
r_int
r_int
id|status
suffix:semicolon
r_if
c_cond
(paren
id|irq
op_ne
id|port-&gt;irq
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;mpc52xx_uart_int : &quot;
"&bslash;"
l_string|&quot;Received wrong int %d. Waiting for %d&bslash;n&quot;
comma
id|irq
comma
id|port-&gt;irq
)paren
suffix:semicolon
r_return
id|IRQ_NONE
suffix:semicolon
)brace
id|spin_lock
c_func
(paren
op_amp
id|port-&gt;lock
)paren
suffix:semicolon
multiline_comment|/* While we have stuff to do, we continue */
r_do
(brace
multiline_comment|/* If we don&squot;t find anything to do, we stop */
id|keepgoing
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Read status */
id|status
op_assign
id|in_be16
c_func
(paren
op_amp
id|PSC
c_func
(paren
id|port
)paren
op_member_access_from_pointer
id|mpc52xx_psc_isr
)paren
suffix:semicolon
id|status
op_and_assign
id|port-&gt;read_status_mask
suffix:semicolon
multiline_comment|/* Do we need to receive chars ? */
multiline_comment|/* For this RX interrupts must be on and some chars waiting */
r_if
c_cond
(paren
id|status
op_amp
id|MPC52xx_PSC_IMR_RXRDY
)paren
id|keepgoing
op_or_assign
id|mpc52xx_uart_int_rx_chars
c_func
(paren
id|port
comma
id|regs
)paren
suffix:semicolon
multiline_comment|/* Do we need to send chars ? */
multiline_comment|/* For this, TX must be ready and TX interrupt enabled */
r_if
c_cond
(paren
id|status
op_amp
id|MPC52xx_PSC_IMR_TXRDY
)paren
id|keepgoing
op_or_assign
id|mpc52xx_uart_int_tx_chars
c_func
(paren
id|port
)paren
suffix:semicolon
multiline_comment|/* Limit number of iteration */
r_if
c_cond
(paren
op_logical_neg
(paren
op_decrement
id|pass
)paren
)paren
id|keepgoing
op_assign
l_int|0
suffix:semicolon
)brace
r_while
c_loop
(paren
id|keepgoing
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|port-&gt;lock
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
multiline_comment|/* ======================================================================== */
multiline_comment|/* Console ( if applicable )                                                */
multiline_comment|/* ======================================================================== */
macro_line|#ifdef CONFIG_SERIAL_MPC52xx_CONSOLE
r_static
r_void
id|__init
DECL|function|mpc52xx_console_get_options
id|mpc52xx_console_get_options
c_func
(paren
r_struct
id|uart_port
op_star
id|port
comma
r_int
op_star
id|baud
comma
r_int
op_star
id|parity
comma
r_int
op_star
id|bits
comma
r_int
op_star
id|flow
)paren
(brace
r_struct
id|mpc52xx_psc
op_star
id|psc
op_assign
id|PSC
c_func
(paren
id|port
)paren
suffix:semicolon
r_int
r_char
id|mr1
suffix:semicolon
multiline_comment|/* Read the mode registers */
id|out_8
c_func
(paren
op_amp
id|psc-&gt;command
comma
id|MPC52xx_PSC_SEL_MODE_REG_1
)paren
suffix:semicolon
id|mr1
op_assign
id|in_8
c_func
(paren
op_amp
id|psc-&gt;mode
)paren
suffix:semicolon
multiline_comment|/* CT{U,L}R are write-only ! */
op_star
id|baud
op_assign
id|__res.bi_baudrate
ques
c_cond
id|__res.bi_baudrate
suffix:colon
id|CONFIG_SERIAL_MPC52xx_CONSOLE_BAUD
suffix:semicolon
multiline_comment|/* Parse them */
r_switch
c_cond
(paren
id|mr1
op_amp
id|MPC52xx_PSC_MODE_BITS_MASK
)paren
(brace
r_case
id|MPC52xx_PSC_MODE_5_BITS
suffix:colon
op_star
id|bits
op_assign
l_int|5
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPC52xx_PSC_MODE_6_BITS
suffix:colon
op_star
id|bits
op_assign
l_int|6
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPC52xx_PSC_MODE_7_BITS
suffix:colon
op_star
id|bits
op_assign
l_int|7
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MPC52xx_PSC_MODE_8_BITS
suffix:colon
r_default
suffix:colon
op_star
id|bits
op_assign
l_int|8
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mr1
op_amp
id|MPC52xx_PSC_MODE_PARNONE
)paren
op_star
id|parity
op_assign
l_char|&squot;n&squot;
suffix:semicolon
r_else
op_star
id|parity
op_assign
id|mr1
op_amp
id|MPC52xx_PSC_MODE_PARODD
ques
c_cond
l_char|&squot;o&squot;
suffix:colon
l_char|&squot;e&squot;
suffix:semicolon
)brace
r_static
r_void
DECL|function|mpc52xx_console_write
id|mpc52xx_console_write
c_func
(paren
r_struct
id|console
op_star
id|co
comma
r_const
r_char
op_star
id|s
comma
r_int
r_int
id|count
)paren
(brace
r_struct
id|uart_port
op_star
id|port
op_assign
op_amp
id|mpc52xx_uart_ports
(braket
id|co-&gt;index
)braket
suffix:semicolon
r_struct
id|mpc52xx_psc
op_star
id|psc
op_assign
id|PSC
c_func
(paren
id|port
)paren
suffix:semicolon
r_int
r_int
id|i
comma
id|j
suffix:semicolon
multiline_comment|/* Disable interrupts */
id|out_be16
c_func
(paren
op_amp
id|psc-&gt;mpc52xx_psc_imr
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Wait the TX buffer to be empty */
id|j
op_assign
l_int|5000000
suffix:semicolon
multiline_comment|/* Maximum wait */
r_while
c_loop
(paren
op_logical_neg
(paren
id|in_be16
c_func
(paren
op_amp
id|psc-&gt;mpc52xx_psc_status
)paren
op_amp
id|MPC52xx_PSC_SR_TXEMP
)paren
op_logical_and
op_decrement
id|j
)paren
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Write all the chars */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* Send the char */
id|out_8
c_func
(paren
op_amp
id|psc-&gt;mpc52xx_psc_buffer_8
comma
op_star
id|s
)paren
suffix:semicolon
multiline_comment|/* Line return handling */
r_if
c_cond
(paren
op_star
id|s
op_increment
op_eq
l_char|&squot;&bslash;n&squot;
)paren
id|out_8
c_func
(paren
op_amp
id|psc-&gt;mpc52xx_psc_buffer_8
comma
l_char|&squot;&bslash;r&squot;
)paren
suffix:semicolon
multiline_comment|/* Wait the TX buffer to be empty */
id|j
op_assign
l_int|20000
suffix:semicolon
multiline_comment|/* Maximum wait */
r_while
c_loop
(paren
op_logical_neg
(paren
id|in_be16
c_func
(paren
op_amp
id|psc-&gt;mpc52xx_psc_status
)paren
op_amp
id|MPC52xx_PSC_SR_TXEMP
)paren
op_logical_and
op_decrement
id|j
)paren
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/* Restore interrupt state */
id|out_be16
c_func
(paren
op_amp
id|psc-&gt;mpc52xx_psc_imr
comma
id|port-&gt;read_status_mask
)paren
suffix:semicolon
)brace
r_static
r_int
id|__init
DECL|function|mpc52xx_console_setup
id|mpc52xx_console_setup
c_func
(paren
r_struct
id|console
op_star
id|co
comma
r_char
op_star
id|options
)paren
(brace
r_struct
id|uart_port
op_star
id|port
op_assign
op_amp
id|mpc52xx_uart_ports
(braket
id|co-&gt;index
)braket
suffix:semicolon
r_int
id|baud
op_assign
l_int|9600
suffix:semicolon
r_int
id|bits
op_assign
l_int|8
suffix:semicolon
r_int
id|parity
op_assign
l_char|&squot;n&squot;
suffix:semicolon
r_int
id|flow
op_assign
l_char|&squot;n&squot;
suffix:semicolon
r_if
c_cond
(paren
id|co-&gt;index
OL
l_int|0
op_logical_or
id|co-&gt;index
op_ge
id|MPC52xx_PSC_MAXNUM
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* Basic port init. Needed since we use some uart_??? func before&n;&t; * real init for early access */
id|spin_lock_init
c_func
(paren
op_amp
id|port-&gt;lock
)paren
suffix:semicolon
id|port-&gt;uartclk
op_assign
id|__res.bi_ipbfreq
op_div
l_int|2
suffix:semicolon
multiline_comment|/* Look at CTLR doc */
id|port-&gt;ops
op_assign
op_amp
id|mpc52xx_uart_ops
suffix:semicolon
id|port-&gt;mapbase
op_assign
id|MPC52xx_PSCx
c_func
(paren
id|co-&gt;index
)paren
suffix:semicolon
multiline_comment|/* We ioremap ourself */
id|port-&gt;membase
op_assign
id|ioremap
c_func
(paren
id|port-&gt;mapbase
comma
r_sizeof
(paren
r_struct
id|mpc52xx_psc
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|port-&gt;membase
op_eq
l_int|NULL
)paren
(brace
id|release_mem_region
c_func
(paren
id|port-&gt;mapbase
comma
r_sizeof
(paren
r_struct
id|mpc52xx_psc
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
multiline_comment|/* Setup the port parameters accoding to options */
r_if
c_cond
(paren
id|options
)paren
id|uart_parse_options
c_func
(paren
id|options
comma
op_amp
id|baud
comma
op_amp
id|parity
comma
op_amp
id|bits
comma
op_amp
id|flow
)paren
suffix:semicolon
r_else
id|mpc52xx_console_get_options
c_func
(paren
id|port
comma
op_amp
id|baud
comma
op_amp
id|parity
comma
op_amp
id|bits
comma
op_amp
id|flow
)paren
suffix:semicolon
r_return
id|uart_set_options
c_func
(paren
id|port
comma
id|co
comma
id|baud
comma
id|parity
comma
id|bits
comma
id|flow
)paren
suffix:semicolon
)brace
r_extern
r_struct
id|uart_driver
id|mpc52xx_uart_driver
suffix:semicolon
DECL|variable|mpc52xx_console
r_static
r_struct
id|console
id|mpc52xx_console
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;ttyS&quot;
comma
dot
id|write
op_assign
id|mpc52xx_console_write
comma
dot
id|device
op_assign
id|uart_console_device
comma
dot
id|setup
op_assign
id|mpc52xx_console_setup
comma
dot
id|flags
op_assign
id|CON_PRINTBUFFER
comma
dot
id|index
op_assign
op_minus
l_int|1
comma
multiline_comment|/* Specified on the cmdline (e.g. console=ttyS0 ) */
dot
id|data
op_assign
op_amp
id|mpc52xx_uart_driver
comma
)brace
suffix:semicolon
r_static
r_int
id|__init
DECL|function|mpc52xx_console_init
id|mpc52xx_console_init
c_func
(paren
r_void
)paren
(brace
id|register_console
c_func
(paren
op_amp
id|mpc52xx_console
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|mpc52xx_console_init
id|console_initcall
c_func
(paren
id|mpc52xx_console_init
)paren
suffix:semicolon
DECL|macro|MPC52xx_PSC_CONSOLE
mdefine_line|#define MPC52xx_PSC_CONSOLE &amp;mpc52xx_console
macro_line|#else
DECL|macro|MPC52xx_PSC_CONSOLE
mdefine_line|#define MPC52xx_PSC_CONSOLE NULL
macro_line|#endif
multiline_comment|/* ======================================================================== */
multiline_comment|/* UART Driver                                                              */
multiline_comment|/* ======================================================================== */
DECL|variable|mpc52xx_uart_driver
r_static
r_struct
id|uart_driver
id|mpc52xx_uart_driver
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|driver_name
op_assign
l_string|&quot;mpc52xx_psc_uart&quot;
comma
dot
id|dev_name
op_assign
l_string|&quot;ttyS&quot;
comma
dot
id|devfs_name
op_assign
l_string|&quot;ttyS&quot;
comma
dot
id|major
op_assign
id|TTY_MAJOR
comma
dot
id|minor
op_assign
l_int|64
comma
dot
id|nr
op_assign
id|MPC52xx_PSC_MAXNUM
comma
dot
id|cons
op_assign
id|MPC52xx_PSC_CONSOLE
comma
)brace
suffix:semicolon
multiline_comment|/* ======================================================================== */
multiline_comment|/* OCP Driver                                                               */
multiline_comment|/* ======================================================================== */
r_static
r_int
id|__devinit
DECL|function|mpc52xx_uart_probe
id|mpc52xx_uart_probe
c_func
(paren
r_struct
id|ocp_device
op_star
id|ocp
)paren
(brace
r_struct
id|uart_port
op_star
id|port
op_assign
l_int|NULL
suffix:semicolon
r_int
id|idx
comma
id|ret
suffix:semicolon
multiline_comment|/* Get the corresponding port struct */
id|idx
op_assign
id|ocp-&gt;def-&gt;index
suffix:semicolon
r_if
c_cond
(paren
id|idx
OL
l_int|0
op_logical_or
id|idx
op_ge
id|MPC52xx_PSC_MAXNUM
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|port
op_assign
op_amp
id|mpc52xx_uart_ports
(braket
id|idx
)braket
suffix:semicolon
multiline_comment|/* Init the port structure */
id|spin_lock_init
c_func
(paren
op_amp
id|port-&gt;lock
)paren
suffix:semicolon
id|port-&gt;mapbase
op_assign
id|ocp-&gt;def-&gt;paddr
suffix:semicolon
id|port-&gt;irq
op_assign
id|ocp-&gt;def-&gt;irq
suffix:semicolon
id|port-&gt;uartclk
op_assign
id|__res.bi_ipbfreq
op_div
l_int|2
suffix:semicolon
multiline_comment|/* Look at CTLR doc */
id|port-&gt;fifosize
op_assign
l_int|255
suffix:semicolon
multiline_comment|/* Should be 512 ! But it can&squot;t be */
multiline_comment|/* stored in a unsigned char       */
id|port-&gt;iotype
op_assign
id|UPIO_MEM
suffix:semicolon
id|port-&gt;flags
op_assign
id|UPF_BOOT_AUTOCONF
op_or
(paren
id|uart_console
c_func
(paren
id|port
)paren
ques
c_cond
l_int|0
suffix:colon
id|UPF_IOREMAP
)paren
suffix:semicolon
id|port-&gt;line
op_assign
id|idx
suffix:semicolon
id|port-&gt;ops
op_assign
op_amp
id|mpc52xx_uart_ops
suffix:semicolon
id|port-&gt;read_status_mask
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Requests the mem &amp; irqs */
multiline_comment|/* Unlike other serial drivers, we reserve the resources here, so we&n;&t; * can detect early if multiple drivers uses the same PSC. Special&n;&t; * care must be taken with the console PSC&n;&t; */
id|ret
op_assign
id|request_irq
c_func
(paren
id|port-&gt;irq
comma
id|mpc52xx_uart_int
comma
id|SA_INTERRUPT
op_or
id|SA_SAMPLE_RANDOM
comma
l_string|&quot;mpc52xx_psc_uart&quot;
comma
id|port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_goto
id|error
suffix:semicolon
id|ret
op_assign
id|request_mem_region
c_func
(paren
id|port-&gt;mapbase
comma
r_sizeof
(paren
r_struct
id|mpc52xx_psc
)paren
comma
l_string|&quot;mpc52xx_psc_uart&quot;
)paren
op_ne
l_int|NULL
ques
c_cond
l_int|0
suffix:colon
op_minus
id|EBUSY
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_goto
id|free_irq
suffix:semicolon
multiline_comment|/* Add the port to the uart sub-system */
id|ret
op_assign
id|uart_add_one_port
c_func
(paren
op_amp
id|mpc52xx_uart_driver
comma
id|port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_goto
id|release_mem
suffix:semicolon
id|ocp_set_drvdata
c_func
(paren
id|ocp
comma
(paren
r_void
op_star
)paren
id|port
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|free_irq
suffix:colon
id|free_irq
c_func
(paren
id|port-&gt;irq
comma
id|mpc52xx_uart_int
)paren
suffix:semicolon
id|release_mem
suffix:colon
id|release_mem_region
c_func
(paren
id|port-&gt;mapbase
comma
r_sizeof
(paren
r_struct
id|mpc52xx_psc
)paren
)paren
suffix:semicolon
id|error
suffix:colon
r_if
c_cond
(paren
id|uart_console
c_func
(paren
id|port
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;mpc52xx_uart.c: Error during resource alloction for &quot;
l_string|&quot;the console port !!! Check that the console PSC is &quot;
l_string|&quot;not used by another OCP driver !!!&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
r_static
r_void
DECL|function|mpc52xx_uart_remove
id|mpc52xx_uart_remove
c_func
(paren
r_struct
id|ocp_device
op_star
id|ocp
)paren
(brace
r_struct
id|uart_port
op_star
id|port
op_assign
(paren
r_struct
id|uart_port
op_star
)paren
id|ocp_get_drvdata
c_func
(paren
id|ocp
)paren
suffix:semicolon
id|ocp_set_drvdata
c_func
(paren
id|ocp
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|port
)paren
(brace
id|uart_remove_one_port
c_func
(paren
op_amp
id|mpc52xx_uart_driver
comma
id|port
)paren
suffix:semicolon
id|release_mem_region
c_func
(paren
id|port-&gt;mapbase
comma
r_sizeof
(paren
r_struct
id|mpc52xx_psc
)paren
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|port-&gt;irq
comma
id|mpc52xx_uart_int
)paren
suffix:semicolon
)brace
)brace
macro_line|#ifdef CONFIG_PM
r_static
r_int
DECL|function|mpc52xx_uart_suspend
id|mpc52xx_uart_suspend
c_func
(paren
r_struct
id|ocp_device
op_star
id|ocp
comma
id|u32
id|state
)paren
(brace
r_struct
id|uart_port
op_star
id|port
op_assign
(paren
r_struct
id|uart_port
op_star
)paren
id|ocp_get_drvdata
c_func
(paren
id|ocp
)paren
suffix:semicolon
id|uart_suspend_port
c_func
(paren
op_amp
id|mpc52xx_uart_driver
comma
id|port
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|mpc52xx_uart_resume
id|mpc52xx_uart_resume
c_func
(paren
r_struct
id|ocp_device
op_star
id|ocp
)paren
(brace
r_struct
id|uart_port
op_star
id|port
op_assign
(paren
r_struct
id|uart_port
op_star
)paren
id|ocp_get_drvdata
c_func
(paren
id|ocp
)paren
suffix:semicolon
id|uart_resume_port
c_func
(paren
op_amp
id|mpc52xx_uart_driver
comma
id|port
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
DECL|variable|__devinitdata
r_static
r_struct
id|ocp_device_id
id|mpc52xx_uart_ids
(braket
)braket
id|__devinitdata
op_assign
(brace
(brace
dot
id|vendor
op_assign
id|OCP_VENDOR_FREESCALE
comma
dot
id|function
op_assign
id|OCP_FUNC_PSC_UART
)brace
comma
(brace
dot
id|vendor
op_assign
id|OCP_VENDOR_INVALID
multiline_comment|/* Terminating entry */
)brace
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|ocp
comma
id|mpc52xx_uart_ids
)paren
suffix:semicolon
DECL|variable|mpc52xx_uart_ocp_driver
r_static
r_struct
id|ocp_driver
id|mpc52xx_uart_ocp_driver
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;mpc52xx_psc_uart&quot;
comma
dot
id|id_table
op_assign
id|mpc52xx_uart_ids
comma
dot
id|probe
op_assign
id|mpc52xx_uart_probe
comma
dot
id|remove
op_assign
id|mpc52xx_uart_remove
comma
macro_line|#ifdef CONFIG_PM
dot
id|suspend
op_assign
id|mpc52xx_uart_suspend
comma
dot
id|resume
op_assign
id|mpc52xx_uart_resume
comma
macro_line|#endif
)brace
suffix:semicolon
multiline_comment|/* ======================================================================== */
multiline_comment|/* Module                                                                   */
multiline_comment|/* ======================================================================== */
r_static
r_int
id|__init
DECL|function|mpc52xx_uart_init
id|mpc52xx_uart_init
c_func
(paren
r_void
)paren
(brace
r_int
id|ret
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Serial: MPC52xx PSC driver&bslash;n&quot;
)paren
suffix:semicolon
id|ret
op_assign
id|uart_register_driver
c_func
(paren
op_amp
id|mpc52xx_uart_driver
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_return
id|ret
suffix:semicolon
id|ret
op_assign
id|ocp_register_driver
c_func
(paren
op_amp
id|mpc52xx_uart_ocp_driver
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
r_static
r_void
id|__exit
DECL|function|mpc52xx_uart_exit
id|mpc52xx_uart_exit
c_func
(paren
r_void
)paren
(brace
id|ocp_unregister_driver
c_func
(paren
op_amp
id|mpc52xx_uart_ocp_driver
)paren
suffix:semicolon
id|uart_unregister_driver
c_func
(paren
op_amp
id|mpc52xx_uart_driver
)paren
suffix:semicolon
)brace
DECL|variable|mpc52xx_uart_init
id|module_init
c_func
(paren
id|mpc52xx_uart_init
)paren
suffix:semicolon
DECL|variable|mpc52xx_uart_exit
id|module_exit
c_func
(paren
id|mpc52xx_uart_exit
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Sylvain Munaut &lt;tnt@246tNt.com&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Freescale MPC52xx PSC UART&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
eof
