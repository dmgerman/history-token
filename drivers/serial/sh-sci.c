multiline_comment|/*&n; * drivers/serial/sh-sci.c&n; *&n; * SuperH on-chip serial module support.  (SCI with no FIFO / with FIFO)&n; *&n; *  Copyright (C) 2002, 2003, 2004  Paul Mundt&n; *&n; * based off of the old drivers/char/sh-sci.c by:&n; *&n; *   Copyright (C) 1999, 2000  Niibe Yutaka&n; *   Copyright (C) 2000  Sugioka Toshinobu&n; *   Modified to support multiple serial ports. Stuart Menefy (May 2000).&n; *   Modified to support SecureEdge. David McCullough (2002)&n; *   Modified to support SH7300 SCIF. Takashi Kusuda (Jun 2003).&n; *&n; * This file is subject to the terms and conditions of the GNU General Public&n; * License.  See the file &quot;COPYING&quot; in the main directory of this archive&n; * for more details.&n; */
DECL|macro|DEBUG
macro_line|#undef DEBUG
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/signal.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/tty_flip.h&gt;
macro_line|#include &lt;linux/serial.h&gt;
macro_line|#include &lt;linux/major.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/sysrq.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/console.h&gt;
macro_line|#include &lt;linux/bitops.h&gt;
macro_line|#ifdef CONFIG_CPU_FREQ
macro_line|#include &lt;linux/notifier.h&gt;
macro_line|#include &lt;linux/cpufreq.h&gt;
macro_line|#endif
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/generic_serial.h&gt;
macro_line|#ifdef CONFIG_SH_STANDARD_BIOS
macro_line|#include &lt;asm/sh_bios.h&gt;
macro_line|#endif
macro_line|#if defined(CONFIG_SERIAL_SH_SCI_CONSOLE) &amp;&amp; defined(CONFIG_MAGIC_SYSRQ)
DECL|macro|SUPPORT_SYSRQ
mdefine_line|#define SUPPORT_SYSRQ
macro_line|#endif
macro_line|#include &quot;sh-sci.h&quot;
macro_line|#ifdef CONFIG_SH_KGDB
macro_line|#include &lt;asm/kgdb.h&gt;
r_static
r_int
id|kgdb_get_char
c_func
(paren
r_struct
id|sci_port
op_star
id|port
)paren
suffix:semicolon
r_static
r_void
id|kgdb_put_char
c_func
(paren
r_struct
id|sci_port
op_star
id|port
comma
r_char
id|c
)paren
suffix:semicolon
r_static
r_void
id|kgdb_handle_error
c_func
(paren
r_struct
id|sci_port
op_star
id|port
)paren
suffix:semicolon
DECL|variable|kgdb_sci_port
r_static
r_struct
id|sci_port
op_star
id|kgdb_sci_port
suffix:semicolon
macro_line|#endif /* CONFIG_SH_KGDB */
macro_line|#ifdef CONFIG_SERIAL_SH_SCI_CONSOLE
DECL|variable|serial_console_port
r_static
r_struct
id|sci_port
op_star
id|serial_console_port
op_assign
l_int|0
suffix:semicolon
macro_line|#endif /* CONFIG_SERIAL_SH_SCI_CONSOLE */
multiline_comment|/* Function prototypes */
r_static
r_void
id|sci_stop_tx
c_func
(paren
r_struct
id|uart_port
op_star
id|port
comma
r_int
r_int
id|tty_stop
)paren
suffix:semicolon
r_static
r_void
id|sci_start_tx
c_func
(paren
r_struct
id|uart_port
op_star
id|port
comma
r_int
r_int
id|tty_start
)paren
suffix:semicolon
r_static
r_void
id|sci_start_rx
c_func
(paren
r_struct
id|uart_port
op_star
id|port
comma
r_int
r_int
id|tty_start
)paren
suffix:semicolon
r_static
r_void
id|sci_stop_rx
c_func
(paren
r_struct
id|uart_port
op_star
id|port
)paren
suffix:semicolon
r_static
r_int
id|sci_request_irq
c_func
(paren
r_struct
id|sci_port
op_star
id|port
)paren
suffix:semicolon
r_static
r_void
id|sci_free_irq
c_func
(paren
r_struct
id|sci_port
op_star
id|port
)paren
suffix:semicolon
DECL|variable|sci_ports
r_static
r_struct
id|sci_port
id|sci_ports
(braket
id|SCI_NPORTS
)braket
suffix:semicolon
DECL|variable|sci_uart_driver
r_static
r_struct
id|uart_driver
id|sci_uart_driver
suffix:semicolon
macro_line|#if defined(CONFIG_SH_STANDARD_BIOS) || defined(CONFIG_SH_KGDB)
DECL|function|handle_error
r_static
r_void
id|handle_error
c_func
(paren
r_struct
id|uart_port
op_star
id|port
)paren
(brace
multiline_comment|/* Clear error flags */
id|sci_out
c_func
(paren
id|port
comma
id|SCxSR
comma
id|SCxSR_ERROR_CLEAR
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
)brace
DECL|function|get_char
r_static
r_int
id|get_char
c_func
(paren
r_struct
id|uart_port
op_star
id|port
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|status
suffix:semicolon
r_int
id|c
suffix:semicolon
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
r_do
(brace
id|status
op_assign
id|sci_in
c_func
(paren
id|port
comma
id|SCxSR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|SCxSR_ERRORS
c_func
(paren
id|port
)paren
)paren
(brace
id|handle_error
c_func
(paren
id|port
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
op_logical_neg
(paren
id|status
op_amp
id|SCxSR_RDxF
c_func
(paren
id|port
)paren
)paren
)paren
suffix:semicolon
id|c
op_assign
id|sci_in
c_func
(paren
id|port
comma
id|SCxRDR
)paren
suffix:semicolon
id|sci_in
c_func
(paren
id|port
comma
id|SCxSR
)paren
suffix:semicolon
multiline_comment|/* Dummy read */
id|sci_out
c_func
(paren
id|port
comma
id|SCxSR
comma
id|SCxSR_RDxF_CLEAR
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
id|c
suffix:semicolon
)brace
multiline_comment|/* Taken from sh-stub.c of GDB 4.18 */
DECL|variable|hexchars
r_static
r_const
r_char
id|hexchars
(braket
)braket
op_assign
l_string|&quot;0123456789abcdef&quot;
suffix:semicolon
DECL|function|highhex
r_static
id|__inline__
r_char
id|highhex
c_func
(paren
r_int
id|x
)paren
(brace
r_return
id|hexchars
(braket
(paren
id|x
op_rshift
l_int|4
)paren
op_amp
l_int|0xf
)braket
suffix:semicolon
)brace
DECL|function|lowhex
r_static
id|__inline__
r_char
id|lowhex
c_func
(paren
r_int
id|x
)paren
(brace
r_return
id|hexchars
(braket
id|x
op_amp
l_int|0xf
)braket
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_SH_STANDARD_BIOS || CONFIG_SH_KGDB */
multiline_comment|/*&n; * Send the packet in buffer.  The host gets one chance to read it.&n; * This routine does not wait for a positive acknowledge.&n; */
macro_line|#ifdef CONFIG_SERIAL_SH_SCI_CONSOLE
DECL|function|put_char
r_static
r_void
id|put_char
c_func
(paren
r_struct
id|uart_port
op_star
id|port
comma
r_char
id|c
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|status
suffix:semicolon
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
r_do
(brace
id|status
op_assign
id|sci_in
c_func
(paren
id|port
comma
id|SCxSR
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
op_logical_neg
(paren
id|status
op_amp
id|SCxSR_TDxE
c_func
(paren
id|port
)paren
)paren
)paren
suffix:semicolon
id|sci_out
c_func
(paren
id|port
comma
id|SCxTDR
comma
id|c
)paren
suffix:semicolon
id|sci_in
c_func
(paren
id|port
comma
id|SCxSR
)paren
suffix:semicolon
multiline_comment|/* Dummy read */
id|sci_out
c_func
(paren
id|port
comma
id|SCxSR
comma
id|SCxSR_TDxE_CLEAR
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|put_string
r_static
r_void
id|put_string
c_func
(paren
r_struct
id|sci_port
op_star
id|sci_port
comma
r_const
r_char
op_star
id|buffer
comma
r_int
id|count
)paren
(brace
r_struct
id|uart_port
op_star
id|port
op_assign
op_amp
id|sci_port-&gt;port
suffix:semicolon
r_const
r_int
r_char
op_star
id|p
op_assign
id|buffer
suffix:semicolon
r_int
id|i
suffix:semicolon
macro_line|#if defined(CONFIG_SH_STANDARD_BIOS) || defined(CONFIG_SH_KGDB)
r_int
id|checksum
suffix:semicolon
r_int
id|usegdb
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef CONFIG_SH_STANDARD_BIOS
multiline_comment|/* This call only does a trap the first time it is&n;&t; * called, and so is safe to do here unconditionally&n;&t; */
id|usegdb
op_or_assign
id|sh_bios_in_gdb_mode
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_SH_KGDB
id|usegdb
op_or_assign
(paren
id|kgdb_in_gdb_mode
op_logical_and
(paren
id|port
op_eq
id|kgdb_sci_port
)paren
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|usegdb
)paren
(brace
multiline_comment|/*  $&lt;packet info&gt;#&lt;checksum&gt;. */
r_do
(brace
r_int
r_char
id|c
suffix:semicolon
id|put_char
c_func
(paren
id|port
comma
l_char|&squot;$&squot;
)paren
suffix:semicolon
id|put_char
c_func
(paren
id|port
comma
l_char|&squot;O&squot;
)paren
suffix:semicolon
multiline_comment|/* &squot;O&squot;utput to console */
id|checksum
op_assign
l_char|&squot;O&squot;
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* Don&squot;t use run length encoding */
r_int
id|h
comma
id|l
suffix:semicolon
id|c
op_assign
op_star
id|p
op_increment
suffix:semicolon
id|h
op_assign
id|highhex
c_func
(paren
id|c
)paren
suffix:semicolon
id|l
op_assign
id|lowhex
c_func
(paren
id|c
)paren
suffix:semicolon
id|put_char
c_func
(paren
id|port
comma
id|h
)paren
suffix:semicolon
id|put_char
c_func
(paren
id|port
comma
id|l
)paren
suffix:semicolon
id|checksum
op_add_assign
id|h
op_plus
id|l
suffix:semicolon
)brace
id|put_char
c_func
(paren
id|port
comma
l_char|&squot;#&squot;
)paren
suffix:semicolon
id|put_char
c_func
(paren
id|port
comma
id|highhex
c_func
(paren
id|checksum
)paren
)paren
suffix:semicolon
id|put_char
c_func
(paren
id|port
comma
id|lowhex
c_func
(paren
id|checksum
)paren
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|get_char
c_func
(paren
id|port
)paren
op_ne
l_char|&squot;+&squot;
)paren
suffix:semicolon
)brace
r_else
macro_line|#endif /* CONFIG_SH_STANDARD_BIOS || CONFIG_SH_KGDB */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_star
id|p
op_eq
l_int|10
)paren
id|put_char
c_func
(paren
id|port
comma
l_char|&squot;&bslash;r&squot;
)paren
suffix:semicolon
id|put_char
c_func
(paren
id|port
comma
op_star
id|p
op_increment
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif /* CONFIG_SERIAL_SH_SCI_CONSOLE */
macro_line|#ifdef CONFIG_SH_KGDB
multiline_comment|/* Is the SCI ready, ie is there a char waiting? */
DECL|function|kgdb_is_char_ready
r_static
r_int
id|kgdb_is_char_ready
c_func
(paren
r_struct
id|sci_port
op_star
id|port
)paren
(brace
r_int
r_int
id|status
op_assign
id|sci_in
c_func
(paren
id|port
comma
id|SCxSR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
(paren
id|SCxSR_ERRORS
c_func
(paren
id|port
)paren
op_or
id|SCxSR_BRK
c_func
(paren
id|port
)paren
)paren
)paren
id|kgdb_handle_error
c_func
(paren
id|port
)paren
suffix:semicolon
r_return
(paren
id|status
op_amp
id|SCxSR_RDxF
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Write a char */
DECL|function|kgdb_put_char
r_static
r_void
id|kgdb_put_char
c_func
(paren
r_struct
id|sci_port
op_star
id|port
comma
r_char
id|c
)paren
(brace
r_int
r_int
id|status
suffix:semicolon
r_do
id|status
op_assign
id|sci_in
c_func
(paren
id|port
comma
id|SCxSR
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
(paren
id|status
op_amp
id|SCxSR_TDxE
c_func
(paren
id|port
)paren
)paren
)paren
suffix:semicolon
id|sci_out
c_func
(paren
id|port
comma
id|SCxTDR
comma
id|c
)paren
suffix:semicolon
id|sci_in
c_func
(paren
id|port
comma
id|SCxSR
)paren
suffix:semicolon
multiline_comment|/* Dummy read */
id|sci_out
c_func
(paren
id|port
comma
id|SCxSR
comma
id|SCxSR_TDxE_CLEAR
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Get a char if there is one, else ret -1 */
DECL|function|kgdb_get_char
r_static
r_int
id|kgdb_get_char
c_func
(paren
r_struct
id|sci_port
op_star
id|port
)paren
(brace
r_int
id|c
suffix:semicolon
r_if
c_cond
(paren
id|kgdb_is_char_ready
c_func
(paren
id|port
)paren
op_eq
l_int|0
)paren
id|c
op_assign
op_minus
l_int|1
suffix:semicolon
r_else
(brace
id|c
op_assign
id|sci_in
c_func
(paren
id|port
comma
id|SCxRDR
)paren
suffix:semicolon
id|sci_in
c_func
(paren
id|port
comma
id|SCxSR
)paren
suffix:semicolon
multiline_comment|/* Dummy read */
id|sci_out
c_func
(paren
id|port
comma
id|SCxSR
comma
id|SCxSR_RDxF_CLEAR
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
)brace
r_return
id|c
suffix:semicolon
)brace
multiline_comment|/* Called from kgdbstub.c to get a character, i.e. is blocking */
DECL|function|kgdb_sci_getchar
r_static
r_int
id|kgdb_sci_getchar
c_func
(paren
r_void
)paren
(brace
r_volatile
r_int
id|c
suffix:semicolon
multiline_comment|/* Keep trying to read a character, this could be neater */
r_while
c_loop
(paren
(paren
id|c
op_assign
id|kgdb_get_char
c_func
(paren
id|kgdb_sci_port
)paren
)paren
OL
l_int|0
)paren
suffix:semicolon
r_return
id|c
suffix:semicolon
)brace
multiline_comment|/* Called from kgdbstub.c to put a character, just a wrapper */
DECL|function|kgdb_sci_putchar
r_static
r_void
id|kgdb_sci_putchar
c_func
(paren
r_int
id|c
)paren
(brace
id|kgdb_put_char
c_func
(paren
id|kgdb_sci_port
comma
id|c
)paren
suffix:semicolon
)brace
multiline_comment|/* Clear any errors on the SCI */
DECL|function|kgdb_handle_error
r_static
r_void
id|kgdb_handle_error
c_func
(paren
r_struct
id|sci_port
op_star
id|port
)paren
(brace
id|sci_out
c_func
(paren
id|port
comma
id|SCxSR
comma
id|SCxSR_ERROR_CLEAR
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
multiline_comment|/* Clear error flags */
)brace
multiline_comment|/* Breakpoint if there&squot;s a break sent on the serial port */
DECL|function|kgdb_break_interrupt
r_static
r_void
id|kgdb_break_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|ptr
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|sci_port
op_star
id|port
op_assign
id|ptr
suffix:semicolon
r_int
r_int
id|status
op_assign
id|sci_in
c_func
(paren
id|port
comma
id|SCxSR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|SCxSR_BRK
c_func
(paren
id|port
)paren
)paren
(brace
multiline_comment|/* Break into the debugger if a break is detected */
id|BREAKPOINT
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Clear */
id|sci_out
c_func
(paren
id|port
comma
id|SCxSR
comma
id|SCxSR_BREAK_CLEAR
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif /* CONFIG_SH_KGDB */
macro_line|#if defined(__H8300S__)
DECL|enumerator|sci_disable
DECL|enumerator|sci_enable
r_enum
(brace
id|sci_disable
comma
id|sci_enable
)brace
suffix:semicolon
DECL|function|h8300_sci_enable
r_static
r_void
id|h8300_sci_enable
c_func
(paren
r_struct
id|uart_port
op_star
id|port
comma
r_int
r_int
id|ctrl
)paren
(brace
r_volatile
r_int
r_char
op_star
id|mstpcrl
op_assign
(paren
r_volatile
r_int
r_char
op_star
)paren
id|MSTPCRL
suffix:semicolon
r_int
id|ch
op_assign
(paren
id|port-&gt;mapbase
op_minus
id|SMR0
)paren
op_rshift
l_int|3
suffix:semicolon
r_int
r_char
id|mask
op_assign
l_int|1
op_lshift
(paren
id|ch
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ctrl
op_eq
id|sci_disable
)paren
(brace
op_star
id|mstpcrl
op_or_assign
id|mask
suffix:semicolon
)brace
r_else
(brace
op_star
id|mstpcrl
op_and_assign
op_complement
id|mask
suffix:semicolon
)brace
)brace
macro_line|#endif
macro_line|#if defined(SCI_ONLY) || defined(SCI_AND_SCIF)
macro_line|#if defined(__H8300H__) || defined(__H8300S__)
DECL|function|sci_init_pins_sci
r_static
r_void
id|sci_init_pins_sci
c_func
(paren
r_struct
id|uart_port
op_star
id|port
comma
r_int
r_int
id|cflag
)paren
(brace
r_int
id|ch
op_assign
(paren
id|port-&gt;mapbase
op_minus
id|SMR0
)paren
op_rshift
l_int|3
suffix:semicolon
multiline_comment|/* set DDR regs */
id|H8300_GPIO_DDR
c_func
(paren
id|h8300_sci_pins
(braket
id|ch
)braket
dot
id|port
comma
id|h8300_sci_pins
(braket
id|ch
)braket
dot
id|rx
comma
id|H8300_GPIO_INPUT
)paren
suffix:semicolon
id|H8300_GPIO_DDR
c_func
(paren
id|h8300_sci_pins
(braket
id|ch
)braket
dot
id|port
comma
id|h8300_sci_pins
(braket
id|ch
)braket
dot
id|tx
comma
id|H8300_GPIO_OUTPUT
)paren
suffix:semicolon
multiline_comment|/* tx mark output*/
id|H8300_SCI_DR
c_func
(paren
id|ch
)paren
op_or_assign
id|h8300_sci_pins
(braket
id|ch
)braket
dot
id|tx
suffix:semicolon
)brace
macro_line|#else
DECL|function|sci_init_pins_sci
r_static
r_void
id|sci_init_pins_sci
c_func
(paren
r_struct
id|uart_port
op_star
id|port
comma
r_int
r_int
id|cflag
)paren
(brace
)brace
macro_line|#endif
macro_line|#endif
macro_line|#if defined(SCIF_ONLY) || defined(SCI_AND_SCIF)
macro_line|#if defined(CONFIG_CPU_SH3)
multiline_comment|/* For SH7705, SH7707, SH7709, SH7709A, SH7729, SH7300*/
DECL|function|sci_init_pins_scif
r_static
r_void
id|sci_init_pins_scif
c_func
(paren
r_struct
id|uart_port
op_star
id|port
comma
r_int
r_int
id|cflag
)paren
(brace
r_int
r_int
id|fcr_val
op_assign
l_int|0
suffix:semicolon
macro_line|#if !defined(CONFIG_CPU_SUBTYPE_SH7300) /* SH7300 doesn&squot;t use RTS/CTS */
(brace
r_int
r_int
id|data
suffix:semicolon
multiline_comment|/* We need to set SCPCR to enable RTS/CTS */
id|data
op_assign
id|ctrl_inw
c_func
(paren
id|SCPCR
)paren
suffix:semicolon
multiline_comment|/* Clear out SCP7MD1,0, SCP6MD1,0, SCP4MD1,0*/
id|ctrl_outw
c_func
(paren
id|data
op_amp
l_int|0x0fcf
comma
id|SCPCR
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cflag
op_amp
id|CRTSCTS
)paren
id|fcr_val
op_or_assign
id|SCFCR_MCE
suffix:semicolon
r_else
(brace
r_int
r_int
id|data
suffix:semicolon
multiline_comment|/* We need to set SCPCR to enable RTS/CTS */
id|data
op_assign
id|ctrl_inw
c_func
(paren
id|SCPCR
)paren
suffix:semicolon
multiline_comment|/* Clear out SCP7MD1,0, SCP4MD1,0,&n;&t;&t;   Set SCP6MD1,0 = {01} (output)  */
id|ctrl_outw
c_func
(paren
(paren
id|data
op_amp
l_int|0x0fcf
)paren
op_or
l_int|0x1000
comma
id|SCPCR
)paren
suffix:semicolon
id|data
op_assign
id|ctrl_inb
c_func
(paren
id|SCPDR
)paren
suffix:semicolon
multiline_comment|/* Set /RTS2 (bit6) = 0 */
id|ctrl_outb
c_func
(paren
id|data
op_amp
l_int|0xbf
comma
id|SCPDR
)paren
suffix:semicolon
)brace
macro_line|#endif
id|sci_out
c_func
(paren
id|port
comma
id|SCFCR
comma
id|fcr_val
)paren
suffix:semicolon
)brace
DECL|function|sci_init_pins_irda
r_static
r_void
id|sci_init_pins_irda
c_func
(paren
r_struct
id|uart_port
op_star
id|port
comma
r_int
r_int
id|cflag
)paren
(brace
r_int
r_int
id|fcr_val
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|cflag
op_amp
id|CRTSCTS
)paren
id|fcr_val
op_or_assign
id|SCFCR_MCE
suffix:semicolon
id|sci_out
c_func
(paren
id|port
comma
id|SCFCR
comma
id|fcr_val
)paren
suffix:semicolon
)brace
macro_line|#else
multiline_comment|/* For SH7750 */
DECL|function|sci_init_pins_scif
r_static
r_void
id|sci_init_pins_scif
c_func
(paren
r_struct
id|uart_port
op_star
id|port
comma
r_int
r_int
id|cflag
)paren
(brace
r_int
r_int
id|fcr_val
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|cflag
op_amp
id|CRTSCTS
)paren
(brace
id|fcr_val
op_or_assign
id|SCFCR_MCE
suffix:semicolon
)brace
r_else
(brace
id|ctrl_outw
c_func
(paren
l_int|0x0080
comma
id|SCSPTR2
)paren
suffix:semicolon
multiline_comment|/* Set RTS = 1 */
)brace
id|sci_out
c_func
(paren
id|port
comma
id|SCFCR
comma
id|fcr_val
)paren
suffix:semicolon
)brace
macro_line|#endif
macro_line|#endif /* SCIF_ONLY || SCI_AND_SCIF */
multiline_comment|/* ********************************************************************** *&n; *                   the interrupt related routines                       *&n; * ********************************************************************** */
DECL|function|sci_transmit_chars
r_static
r_void
id|sci_transmit_chars
c_func
(paren
r_struct
id|uart_port
op_star
id|port
)paren
(brace
r_struct
id|circ_buf
op_star
id|xmit
op_assign
op_amp
id|port-&gt;info-&gt;xmit
suffix:semicolon
r_int
r_int
id|stopped
op_assign
id|uart_tx_stopped
c_func
(paren
id|port
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|status
suffix:semicolon
r_int
r_int
id|ctrl
suffix:semicolon
r_int
id|count
comma
id|txroom
suffix:semicolon
id|status
op_assign
id|sci_in
c_func
(paren
id|port
comma
id|SCxSR
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_amp
id|SCxSR_TDxE
c_func
(paren
id|port
)paren
)paren
)paren
(brace
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
id|ctrl
op_assign
id|sci_in
c_func
(paren
id|port
comma
id|SCSCR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|uart_circ_empty
c_func
(paren
id|xmit
)paren
)paren
(brace
id|ctrl
op_and_assign
op_complement
id|SCI_CTRL_FLAGS_TIE
suffix:semicolon
)brace
r_else
(brace
id|ctrl
op_or_assign
id|SCI_CTRL_FLAGS_TIE
suffix:semicolon
)brace
id|sci_out
c_func
(paren
id|port
comma
id|SCSCR
comma
id|ctrl
)paren
suffix:semicolon
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#if !defined(SCI_ONLY)
r_if
c_cond
(paren
id|port-&gt;type
op_eq
id|PORT_SCIF
)paren
(brace
id|txroom
op_assign
id|SCIF_TXROOM_MAX
op_minus
(paren
id|sci_in
c_func
(paren
id|port
comma
id|SCFDR
)paren
op_rshift
l_int|8
)paren
suffix:semicolon
)brace
r_else
(brace
id|txroom
op_assign
(paren
id|sci_in
c_func
(paren
id|port
comma
id|SCxSR
)paren
op_amp
id|SCI_TDRE
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
)brace
macro_line|#else
id|txroom
op_assign
(paren
id|sci_in
c_func
(paren
id|port
comma
id|SCxSR
)paren
op_amp
id|SCI_TDRE
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
macro_line|#endif
id|count
op_assign
id|txroom
suffix:semicolon
r_do
(brace
r_int
r_char
id|c
suffix:semicolon
r_if
c_cond
(paren
id|port-&gt;x_char
)paren
(brace
id|c
op_assign
id|port-&gt;x_char
suffix:semicolon
id|port-&gt;x_char
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|uart_circ_empty
c_func
(paren
id|xmit
)paren
op_logical_and
op_logical_neg
id|stopped
)paren
(brace
id|c
op_assign
id|xmit-&gt;buf
(braket
id|xmit-&gt;tail
)braket
suffix:semicolon
id|xmit-&gt;tail
op_assign
(paren
id|xmit-&gt;tail
op_plus
l_int|1
)paren
op_amp
(paren
id|UART_XMIT_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_else
(brace
r_break
suffix:semicolon
)brace
id|sci_out
c_func
(paren
id|port
comma
id|SCxTDR
comma
id|c
)paren
suffix:semicolon
id|port-&gt;icount.tx
op_increment
suffix:semicolon
)brace
r_while
c_loop
(paren
op_decrement
id|count
OG
l_int|0
)paren
suffix:semicolon
id|sci_out
c_func
(paren
id|port
comma
id|SCxSR
comma
id|SCxSR_TDxE_CLEAR
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|uart_circ_chars_pending
c_func
(paren
id|xmit
)paren
OL
id|WAKEUP_CHARS
)paren
id|uart_write_wakeup
c_func
(paren
id|port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|uart_circ_empty
c_func
(paren
id|xmit
)paren
)paren
(brace
id|sci_stop_tx
c_func
(paren
id|port
comma
l_int|0
)paren
suffix:semicolon
)brace
r_else
(brace
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
id|ctrl
op_assign
id|sci_in
c_func
(paren
id|port
comma
id|SCSCR
)paren
suffix:semicolon
macro_line|#if !defined(SCI_ONLY)
r_if
c_cond
(paren
id|port-&gt;type
op_eq
id|PORT_SCIF
)paren
(brace
id|sci_in
c_func
(paren
id|port
comma
id|SCxSR
)paren
suffix:semicolon
multiline_comment|/* Dummy read */
id|sci_out
c_func
(paren
id|port
comma
id|SCxSR
comma
id|SCxSR_TDxE_CLEAR
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
)brace
macro_line|#endif
id|ctrl
op_or_assign
id|SCI_CTRL_FLAGS_TIE
suffix:semicolon
id|sci_out
c_func
(paren
id|port
comma
id|SCSCR
comma
id|ctrl
)paren
suffix:semicolon
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* On SH3, SCIF may read end-of-break as a space-&gt;mark char */
DECL|macro|STEPFN
mdefine_line|#define STEPFN(c)  ({int __c=(c); (((__c-1)|(__c)) == -1); })
DECL|function|sci_receive_chars
r_static
r_inline
r_void
id|sci_receive_chars
c_func
(paren
r_struct
id|uart_port
op_star
id|port
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|tty_struct
op_star
id|tty
op_assign
id|port-&gt;info-&gt;tty
suffix:semicolon
r_int
id|i
comma
id|count
comma
id|copied
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|status
suffix:semicolon
id|status
op_assign
id|sci_in
c_func
(paren
id|port
comma
id|SCxSR
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_amp
id|SCxSR_RDxF
c_func
(paren
id|port
)paren
)paren
)paren
r_return
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
macro_line|#if !defined(SCI_ONLY)
r_if
c_cond
(paren
id|port-&gt;type
op_eq
id|PORT_SCIF
)paren
(brace
id|count
op_assign
id|sci_in
c_func
(paren
id|port
comma
id|SCFDR
)paren
op_amp
id|SCIF_RFDC_MASK
suffix:semicolon
)brace
r_else
(brace
id|count
op_assign
(paren
id|sci_in
c_func
(paren
id|port
comma
id|SCxSR
)paren
op_amp
id|SCxSR_RDxF
c_func
(paren
id|port
)paren
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
)brace
macro_line|#else
id|count
op_assign
(paren
id|sci_in
c_func
(paren
id|port
comma
id|SCxSR
)paren
op_amp
id|SCxSR_RDxF
c_func
(paren
id|port
)paren
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
macro_line|#endif
multiline_comment|/* Don&squot;t copy more bytes than there is room for in the buffer */
r_if
c_cond
(paren
id|tty-&gt;flip.count
op_plus
id|count
OG
id|TTY_FLIPBUF_SIZE
)paren
id|count
op_assign
id|TTY_FLIPBUF_SIZE
op_minus
id|tty-&gt;flip.count
suffix:semicolon
multiline_comment|/* If for any reason we can&squot;t copy more data, we&squot;re done! */
r_if
c_cond
(paren
id|count
op_eq
l_int|0
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|port-&gt;type
op_eq
id|PORT_SCI
)paren
(brace
r_char
id|c
op_assign
id|sci_in
c_func
(paren
id|port
comma
id|SCxRDR
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
r_struct
id|sci_port
op_star
)paren
id|port
)paren
op_member_access_from_pointer
id|break_flag
op_logical_or
id|uart_handle_sysrq_char
c_func
(paren
id|port
comma
id|c
comma
id|regs
)paren
)paren
(brace
id|count
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|tty-&gt;flip.char_buf_ptr
(braket
l_int|0
)braket
op_assign
id|c
suffix:semicolon
id|tty-&gt;flip.flag_buf_ptr
(braket
l_int|0
)braket
op_assign
id|TTY_NORMAL
suffix:semicolon
)brace
)brace
r_else
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
suffix:semicolon
id|i
op_increment
)paren
(brace
r_char
id|c
op_assign
id|sci_in
c_func
(paren
id|port
comma
id|SCxRDR
)paren
suffix:semicolon
id|status
op_assign
id|sci_in
c_func
(paren
id|port
comma
id|SCxSR
)paren
suffix:semicolon
macro_line|#if defined(CONFIG_CPU_SH3)
multiline_comment|/* Skip &quot;chars&quot; during break */
r_if
c_cond
(paren
(paren
(paren
r_struct
id|sci_port
op_star
)paren
id|port
)paren
op_member_access_from_pointer
id|break_flag
)paren
(brace
r_if
c_cond
(paren
(paren
id|c
op_eq
l_int|0
)paren
op_logical_and
(paren
id|status
op_amp
id|SCxSR_FER
c_func
(paren
id|port
)paren
)paren
)paren
(brace
id|count
op_decrement
suffix:semicolon
id|i
op_decrement
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/* Nonzero =&gt; end-of-break */
id|pr_debug
c_func
(paren
l_string|&quot;scif: debounce&lt;%02x&gt;&bslash;n&quot;
comma
id|c
)paren
suffix:semicolon
(paren
(paren
r_struct
id|sci_port
op_star
)paren
id|port
)paren
op_member_access_from_pointer
id|break_flag
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|STEPFN
c_func
(paren
id|c
)paren
)paren
(brace
id|count
op_decrement
suffix:semicolon
id|i
op_decrement
suffix:semicolon
r_continue
suffix:semicolon
)brace
)brace
macro_line|#endif /* CONFIG_CPU_SH3 */
r_if
c_cond
(paren
id|uart_handle_sysrq_char
c_func
(paren
id|port
comma
id|c
comma
id|regs
)paren
)paren
(brace
id|count
op_decrement
suffix:semicolon
id|i
op_decrement
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/* Store data and status */
id|tty-&gt;flip.char_buf_ptr
(braket
id|i
)braket
op_assign
id|c
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|SCxSR_FER
c_func
(paren
id|port
)paren
)paren
(brace
id|tty-&gt;flip.flag_buf_ptr
(braket
id|i
)braket
op_assign
id|TTY_FRAME
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;sci: frame error&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|status
op_amp
id|SCxSR_PER
c_func
(paren
id|port
)paren
)paren
(brace
id|tty-&gt;flip.flag_buf_ptr
(braket
id|i
)braket
op_assign
id|TTY_PARITY
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;sci: parity error&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|tty-&gt;flip.flag_buf_ptr
(braket
id|i
)braket
op_assign
id|TTY_NORMAL
suffix:semicolon
)brace
)brace
)brace
id|sci_in
c_func
(paren
id|port
comma
id|SCxSR
)paren
suffix:semicolon
multiline_comment|/* dummy read */
id|sci_out
c_func
(paren
id|port
comma
id|SCxSR
comma
id|SCxSR_RDxF_CLEAR
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
multiline_comment|/* Update the kernel buffer end */
id|tty-&gt;flip.count
op_add_assign
id|count
suffix:semicolon
id|tty-&gt;flip.char_buf_ptr
op_add_assign
id|count
suffix:semicolon
id|tty-&gt;flip.flag_buf_ptr
op_add_assign
id|count
suffix:semicolon
id|copied
op_add_assign
id|count
suffix:semicolon
id|port-&gt;icount.rx
op_add_assign
id|count
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copied
)paren
(brace
multiline_comment|/* Tell the rest of the system the news. New characters! */
id|tty_flip_buffer_push
c_func
(paren
id|tty
)paren
suffix:semicolon
)brace
r_else
(brace
id|sci_in
c_func
(paren
id|port
comma
id|SCxSR
)paren
suffix:semicolon
multiline_comment|/* dummy read */
id|sci_out
c_func
(paren
id|port
comma
id|SCxSR
comma
id|SCxSR_RDxF_CLEAR
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
)brace
)brace
DECL|macro|SCI_BREAK_JIFFIES
mdefine_line|#define SCI_BREAK_JIFFIES (HZ/20)
multiline_comment|/* The sci generates interrupts during the break,&n; * 1 per millisecond or so during the break period, for 9600 baud.&n; * So dont bother disabling interrupts.&n; * But dont want more than 1 break event.&n; * Use a kernel timer to periodically poll the rx line until&n; * the break is finished.&n; */
DECL|function|sci_schedule_break_timer
r_static
r_void
id|sci_schedule_break_timer
c_func
(paren
r_struct
id|sci_port
op_star
id|port
)paren
(brace
id|port-&gt;break_timer.expires
op_assign
id|jiffies
op_plus
id|SCI_BREAK_JIFFIES
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|port-&gt;break_timer
)paren
suffix:semicolon
)brace
multiline_comment|/* Ensure that two consecutive samples find the break over. */
DECL|function|sci_break_timer
r_static
r_void
id|sci_break_timer
c_func
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|sci_port
op_star
id|port
op_assign
(paren
r_struct
id|sci_port
op_star
)paren
id|data
suffix:semicolon
r_if
c_cond
(paren
id|sci_rxd_in
c_func
(paren
op_amp
id|port-&gt;port
)paren
op_eq
l_int|0
)paren
(brace
id|port-&gt;break_flag
op_assign
l_int|1
suffix:semicolon
id|sci_schedule_break_timer
c_func
(paren
id|port
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|port-&gt;break_flag
op_eq
l_int|1
)paren
(brace
multiline_comment|/* break is over. */
id|port-&gt;break_flag
op_assign
l_int|2
suffix:semicolon
id|sci_schedule_break_timer
c_func
(paren
id|port
)paren
suffix:semicolon
)brace
r_else
id|port-&gt;break_flag
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|sci_handle_errors
r_static
r_inline
r_int
id|sci_handle_errors
c_func
(paren
r_struct
id|uart_port
op_star
id|port
)paren
(brace
r_int
id|copied
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|status
op_assign
id|sci_in
c_func
(paren
id|port
comma
id|SCxSR
)paren
suffix:semicolon
r_struct
id|tty_struct
op_star
id|tty
op_assign
id|port-&gt;info-&gt;tty
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|SCxSR_ORER
c_func
(paren
id|port
)paren
op_logical_and
id|tty-&gt;flip.count
OL
id|TTY_FLIPBUF_SIZE
)paren
(brace
multiline_comment|/* overrun error */
id|copied
op_increment
suffix:semicolon
op_star
id|tty-&gt;flip.flag_buf_ptr
op_increment
op_assign
id|TTY_OVERRUN
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;sci: overrun error&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|SCxSR_FER
c_func
(paren
id|port
)paren
op_logical_and
id|tty-&gt;flip.count
OL
id|TTY_FLIPBUF_SIZE
)paren
(brace
r_if
c_cond
(paren
id|sci_rxd_in
c_func
(paren
id|port
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* Notify of BREAK */
r_struct
id|sci_port
op_star
id|sci_port
op_assign
(paren
r_struct
id|sci_port
op_star
)paren
id|port
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sci_port-&gt;break_flag
)paren
(brace
id|sci_port-&gt;break_flag
op_assign
l_int|1
suffix:semicolon
id|sci_schedule_break_timer
c_func
(paren
(paren
r_struct
id|sci_port
op_star
)paren
id|port
)paren
suffix:semicolon
multiline_comment|/* Do sysrq handling. */
r_if
c_cond
(paren
id|uart_handle_break
c_func
(paren
id|port
)paren
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|pr_debug
c_func
(paren
l_string|&quot;sci: BREAK detected&bslash;n&quot;
)paren
suffix:semicolon
id|copied
op_increment
suffix:semicolon
op_star
id|tty-&gt;flip.flag_buf_ptr
op_increment
op_assign
id|TTY_BREAK
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* frame error */
id|copied
op_increment
suffix:semicolon
op_star
id|tty-&gt;flip.flag_buf_ptr
op_increment
op_assign
id|TTY_FRAME
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;sci: frame error&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|status
op_amp
id|SCxSR_PER
c_func
(paren
id|port
)paren
op_logical_and
id|tty-&gt;flip.count
OL
id|TTY_FLIPBUF_SIZE
)paren
(brace
multiline_comment|/* parity error */
id|copied
op_increment
suffix:semicolon
op_star
id|tty-&gt;flip.flag_buf_ptr
op_increment
op_assign
id|TTY_PARITY
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;sci: parity error&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copied
)paren
(brace
id|tty-&gt;flip.count
op_add_assign
id|copied
suffix:semicolon
id|tty_flip_buffer_push
c_func
(paren
id|tty
)paren
suffix:semicolon
)brace
r_return
id|copied
suffix:semicolon
)brace
DECL|function|sci_handle_breaks
r_static
r_inline
r_int
id|sci_handle_breaks
c_func
(paren
r_struct
id|uart_port
op_star
id|port
)paren
(brace
r_int
id|copied
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|status
op_assign
id|sci_in
c_func
(paren
id|port
comma
id|SCxSR
)paren
suffix:semicolon
r_struct
id|tty_struct
op_star
id|tty
op_assign
id|port-&gt;info-&gt;tty
suffix:semicolon
r_struct
id|sci_port
op_star
id|s
op_assign
op_amp
id|sci_ports
(braket
id|port-&gt;line
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|s-&gt;break_flag
op_logical_and
id|status
op_amp
id|SCxSR_BRK
c_func
(paren
id|port
)paren
op_logical_and
id|tty-&gt;flip.count
OL
id|TTY_FLIPBUF_SIZE
)paren
(brace
macro_line|#if defined(CONFIG_CPU_SH3)
multiline_comment|/* Debounce break */
id|s-&gt;break_flag
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
multiline_comment|/* Notify of BREAK */
id|copied
op_increment
suffix:semicolon
op_star
id|tty-&gt;flip.flag_buf_ptr
op_increment
op_assign
id|TTY_BREAK
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;sci: BREAK detected&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#if defined(SCIF_ORER)
multiline_comment|/* XXX: Handle SCIF overrun error */
r_if
c_cond
(paren
id|port-&gt;type
op_eq
id|PORT_SCIF
op_logical_and
(paren
id|sci_in
c_func
(paren
id|port
comma
id|SCLSR
)paren
op_amp
id|SCIF_ORER
)paren
op_ne
l_int|0
)paren
(brace
id|sci_out
c_func
(paren
id|port
comma
id|SCLSR
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tty-&gt;flip.count
OL
id|TTY_FLIPBUF_SIZE
)paren
(brace
id|copied
op_increment
suffix:semicolon
op_star
id|tty-&gt;flip.flag_buf_ptr
op_increment
op_assign
id|TTY_OVERRUN
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;sci: overrun error&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
r_if
c_cond
(paren
id|copied
)paren
(brace
id|tty-&gt;flip.count
op_add_assign
id|copied
suffix:semicolon
id|tty_flip_buffer_push
c_func
(paren
id|tty
)paren
suffix:semicolon
)brace
r_return
id|copied
suffix:semicolon
)brace
DECL|function|sci_rx_interrupt
r_static
id|irqreturn_t
id|sci_rx_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|ptr
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|uart_port
op_star
id|port
op_assign
id|ptr
suffix:semicolon
multiline_comment|/* I think sci_receive_chars has to be called irrespective&n;&t; * of whether the I_IXOFF is set, otherwise, how is the interrupt&n;&t; * to be disabled?&n;&t; */
id|sci_receive_chars
c_func
(paren
id|port
comma
id|regs
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
DECL|function|sci_tx_interrupt
r_static
id|irqreturn_t
id|sci_tx_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|ptr
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|uart_port
op_star
id|port
op_assign
id|ptr
suffix:semicolon
id|sci_transmit_chars
c_func
(paren
id|port
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
DECL|function|sci_er_interrupt
r_static
id|irqreturn_t
id|sci_er_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|ptr
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|uart_port
op_star
id|port
op_assign
id|ptr
suffix:semicolon
multiline_comment|/* Handle errors */
r_if
c_cond
(paren
id|port-&gt;type
op_eq
id|PORT_SCI
)paren
(brace
r_if
c_cond
(paren
id|sci_handle_errors
c_func
(paren
id|port
)paren
)paren
(brace
multiline_comment|/* discard character in rx buffer */
id|sci_in
c_func
(paren
id|port
comma
id|SCxSR
)paren
suffix:semicolon
id|sci_out
c_func
(paren
id|port
comma
id|SCxSR
comma
id|SCxSR_RDxF_CLEAR
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
macro_line|#if defined(SCIF_ORER)
r_if
c_cond
(paren
(paren
id|sci_in
c_func
(paren
id|port
comma
id|SCLSR
)paren
op_amp
id|SCIF_ORER
)paren
op_ne
l_int|0
)paren
(brace
r_struct
id|tty_struct
op_star
id|tty
op_assign
id|port-&gt;info-&gt;tty
suffix:semicolon
id|sci_out
c_func
(paren
id|port
comma
id|SCLSR
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tty-&gt;flip.count
OL
id|TTY_FLIPBUF_SIZE
)paren
(brace
op_star
id|tty-&gt;flip.flag_buf_ptr
op_increment
op_assign
id|TTY_OVERRUN
suffix:semicolon
id|tty-&gt;flip.count
op_increment
suffix:semicolon
id|tty_flip_buffer_push
c_func
(paren
id|tty
)paren
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;scif: overrun error&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
id|sci_rx_interrupt
c_func
(paren
id|irq
comma
id|ptr
comma
id|regs
)paren
suffix:semicolon
)brace
id|sci_out
c_func
(paren
id|port
comma
id|SCxSR
comma
id|SCxSR_ERROR_CLEAR
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
multiline_comment|/* Kick the transmission */
id|sci_tx_interrupt
c_func
(paren
id|irq
comma
id|ptr
comma
id|regs
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
DECL|function|sci_br_interrupt
r_static
id|irqreturn_t
id|sci_br_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|ptr
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|uart_port
op_star
id|port
op_assign
id|ptr
suffix:semicolon
multiline_comment|/* Handle BREAKs */
id|sci_handle_breaks
c_func
(paren
id|port
)paren
suffix:semicolon
id|sci_out
c_func
(paren
id|port
comma
id|SCxSR
comma
id|SCxSR_BREAK_CLEAR
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
DECL|function|sci_mpxed_interrupt
r_static
id|irqreturn_t
id|sci_mpxed_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|ptr
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
r_int
id|ssr_status
comma
id|scr_status
suffix:semicolon
r_struct
id|uart_port
op_star
id|port
op_assign
id|ptr
suffix:semicolon
id|ssr_status
op_assign
id|sci_in
c_func
(paren
id|port
comma
id|SCxSR
)paren
suffix:semicolon
id|scr_status
op_assign
id|sci_in
c_func
(paren
id|port
comma
id|SCSCR
)paren
suffix:semicolon
multiline_comment|/* Tx Interrupt */
r_if
c_cond
(paren
(paren
id|ssr_status
op_amp
l_int|0x0020
)paren
op_logical_and
(paren
id|scr_status
op_amp
l_int|0x0080
)paren
)paren
id|sci_tx_interrupt
c_func
(paren
id|irq
comma
id|ptr
comma
id|regs
)paren
suffix:semicolon
multiline_comment|/* Rx Interrupt */
r_if
c_cond
(paren
(paren
id|ssr_status
op_amp
l_int|0x0002
)paren
op_logical_and
(paren
id|scr_status
op_amp
l_int|0x0040
)paren
)paren
id|sci_rx_interrupt
c_func
(paren
id|irq
comma
id|ptr
comma
id|regs
)paren
suffix:semicolon
multiline_comment|/* Error Interrupt */
r_if
c_cond
(paren
(paren
id|ssr_status
op_amp
l_int|0x0080
)paren
op_logical_and
(paren
id|scr_status
op_amp
l_int|0x0400
)paren
)paren
id|sci_er_interrupt
c_func
(paren
id|irq
comma
id|ptr
comma
id|regs
)paren
suffix:semicolon
multiline_comment|/* Break Interrupt */
r_if
c_cond
(paren
(paren
id|ssr_status
op_amp
l_int|0x0010
)paren
op_logical_and
(paren
id|scr_status
op_amp
l_int|0x0200
)paren
)paren
id|sci_br_interrupt
c_func
(paren
id|irq
comma
id|ptr
comma
id|regs
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_CPU_FREQ
multiline_comment|/*&n; * Here we define a transistion notifier so that we can update all of our&n; * ports&squot; baud rate when the peripheral clock changes.&n; */
DECL|function|sci_notifier
r_static
r_int
id|sci_notifier
c_func
(paren
r_struct
id|notifier_block
op_star
id|self
comma
r_int
r_int
id|phase
comma
r_void
op_star
id|p
)paren
(brace
r_struct
id|cpufreq_freqs
op_star
id|freqs
op_assign
id|p
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
(paren
id|phase
op_eq
id|CPUFREQ_POSTCHANGE
)paren
op_logical_or
(paren
id|phase
op_eq
id|CPUFREQ_RESUMECHANGE
)paren
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|SCI_NPORTS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|uart_port
op_star
id|port
op_assign
op_amp
id|sci_ports
(braket
id|i
)braket
dot
id|port
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * Update the uartclk per-port if frequency has&n;&t;&t;&t; * changed, since it will no longer necessarily be&n;&t;&t;&t; * consistent with the old frequency.&n;&t;&t;&t; *&n;&t;&t;&t; * Really we want to be able to do something like&n;&t;&t;&t; * uart_change_speed() or something along those lines&n;&t;&t;&t; * here to implicitly reset the per-port baud rate..&n;&t;&t;&t; *&n;&t;&t;&t; * Clean this up later..&n;&t;&t;&t; */
id|port-&gt;uartclk
op_assign
id|current_cpu_data.module_clock
op_star
l_int|16
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;%s: got a postchange notification for cpu %d (old %d, new %d)&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|freqs-&gt;cpu
comma
id|freqs-&gt;old
comma
id|freqs
op_member_access_from_pointer
r_new
)paren
suffix:semicolon
)brace
r_return
id|NOTIFY_OK
suffix:semicolon
)brace
DECL|variable|sci_nb
r_static
r_struct
id|notifier_block
id|sci_nb
op_assign
(brace
op_amp
id|sci_notifier
comma
l_int|NULL
comma
l_int|0
)brace
suffix:semicolon
macro_line|#endif /* CONFIG_CPU_FREQ */
DECL|function|sci_request_irq
r_static
r_int
id|sci_request_irq
c_func
(paren
r_struct
id|sci_port
op_star
id|port
)paren
(brace
r_int
id|i
suffix:semicolon
id|irqreturn_t
(paren
op_star
id|handlers
(braket
l_int|4
)braket
)paren
(paren
r_int
id|irq
comma
r_void
op_star
id|ptr
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
op_assign
(brace
id|sci_er_interrupt
comma
id|sci_rx_interrupt
comma
id|sci_tx_interrupt
comma
id|sci_br_interrupt
comma
)brace
suffix:semicolon
r_const
r_char
op_star
id|desc
(braket
)braket
op_assign
(brace
l_string|&quot;SCI Receive Error&quot;
comma
l_string|&quot;SCI Receive Data Full&quot;
comma
l_string|&quot;SCI Transmit Data Empty&quot;
comma
l_string|&quot;SCI Break&quot;
)brace
suffix:semicolon
r_if
c_cond
(paren
id|port-&gt;irqs
(braket
l_int|0
)braket
op_eq
id|port-&gt;irqs
(braket
l_int|1
)braket
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|port-&gt;irqs
(braket
l_int|0
)braket
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;sci: Cannot allocate irq.(IRQ=0)&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|port-&gt;irqs
(braket
l_int|0
)braket
comma
id|sci_mpxed_interrupt
comma
id|SA_INTERRUPT
comma
l_string|&quot;sci&quot;
comma
id|port
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;sci: Cannot allocate irq.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
)brace
r_else
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ARRAY_SIZE
c_func
(paren
id|handlers
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|port-&gt;irqs
(braket
id|i
)braket
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|port-&gt;irqs
(braket
id|i
)braket
comma
id|handlers
(braket
id|i
)braket
comma
id|SA_INTERRUPT
comma
id|desc
(braket
id|i
)braket
comma
id|port
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;sci: Cannot allocate irq.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sci_free_irq
r_static
r_void
id|sci_free_irq
c_func
(paren
r_struct
id|sci_port
op_star
id|port
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|port-&gt;irqs
(braket
l_int|0
)braket
op_eq
id|port-&gt;irqs
(braket
l_int|1
)braket
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|port-&gt;irqs
(braket
l_int|0
)braket
)paren
id|printk
c_func
(paren
l_string|&quot;sci: sci_free_irq error&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|free_irq
c_func
(paren
id|port-&gt;irqs
(braket
l_int|0
)braket
comma
id|port
)paren
suffix:semicolon
)brace
r_else
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ARRAY_SIZE
c_func
(paren
id|port-&gt;irqs
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|port-&gt;irqs
(braket
id|i
)braket
)paren
r_continue
suffix:semicolon
id|free_irq
c_func
(paren
id|port-&gt;irqs
(braket
id|i
)braket
comma
id|port
)paren
suffix:semicolon
)brace
)brace
)brace
DECL|function|sci_tx_empty
r_static
r_int
r_int
id|sci_tx_empty
c_func
(paren
r_struct
id|uart_port
op_star
id|port
)paren
(brace
multiline_comment|/* Can&squot;t detect */
r_return
id|TIOCSER_TEMT
suffix:semicolon
)brace
DECL|function|sci_set_mctrl
r_static
r_void
id|sci_set_mctrl
c_func
(paren
r_struct
id|uart_port
op_star
id|port
comma
r_int
r_int
id|mctrl
)paren
(brace
multiline_comment|/* This routine is used for seting signals of: DTR, DCD, CTS/RTS */
multiline_comment|/* We use SCIF&squot;s hardware for CTS/RTS, so don&squot;t need any for that. */
multiline_comment|/* If you have signals for DTR and DCD, please implement here. */
)brace
DECL|function|sci_get_mctrl
r_static
r_int
r_int
id|sci_get_mctrl
c_func
(paren
r_struct
id|uart_port
op_star
id|port
)paren
(brace
multiline_comment|/* This routine is used for geting signals of: DTR, DCD, DSR, RI,&n;&t;   and CTS/RTS */
r_return
id|TIOCM_DTR
op_or
id|TIOCM_RTS
op_or
id|TIOCM_DSR
suffix:semicolon
)brace
DECL|function|sci_start_tx
r_static
r_void
id|sci_start_tx
c_func
(paren
r_struct
id|uart_port
op_star
id|port
comma
r_int
r_int
id|tty_start
)paren
(brace
r_struct
id|sci_port
op_star
id|s
op_assign
op_amp
id|sci_ports
(braket
id|port-&gt;line
)braket
suffix:semicolon
id|disable_irq
c_func
(paren
id|s-&gt;irqs
(braket
id|SCIx_TXI_IRQ
)braket
)paren
suffix:semicolon
id|sci_transmit_chars
c_func
(paren
id|port
)paren
suffix:semicolon
id|enable_irq
c_func
(paren
id|s-&gt;irqs
(braket
id|SCIx_TXI_IRQ
)braket
)paren
suffix:semicolon
)brace
DECL|function|sci_stop_tx
r_static
r_void
id|sci_stop_tx
c_func
(paren
r_struct
id|uart_port
op_star
id|port
comma
r_int
r_int
id|tty_stop
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|ctrl
suffix:semicolon
multiline_comment|/* Clear TIE (Transmit Interrupt Enable) bit in SCSCR */
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
id|ctrl
op_assign
id|sci_in
c_func
(paren
id|port
comma
id|SCSCR
)paren
suffix:semicolon
id|ctrl
op_and_assign
op_complement
id|SCI_CTRL_FLAGS_TIE
suffix:semicolon
id|sci_out
c_func
(paren
id|port
comma
id|SCSCR
comma
id|ctrl
)paren
suffix:semicolon
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|sci_start_rx
r_static
r_void
id|sci_start_rx
c_func
(paren
r_struct
id|uart_port
op_star
id|port
comma
r_int
r_int
id|tty_start
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|ctrl
suffix:semicolon
multiline_comment|/* Set RIE (Receive Interrupt Enable) bit in SCSCR */
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
id|ctrl
op_assign
id|sci_in
c_func
(paren
id|port
comma
id|SCSCR
)paren
suffix:semicolon
id|ctrl
op_or_assign
id|SCI_CTRL_FLAGS_RIE
op_or
id|SCI_CTRL_FLAGS_REIE
suffix:semicolon
id|sci_out
c_func
(paren
id|port
comma
id|SCSCR
comma
id|ctrl
)paren
suffix:semicolon
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|sci_stop_rx
r_static
r_void
id|sci_stop_rx
c_func
(paren
r_struct
id|uart_port
op_star
id|port
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|ctrl
suffix:semicolon
multiline_comment|/* Clear RIE (Receive Interrupt Enable) bit in SCSCR */
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
id|ctrl
op_assign
id|sci_in
c_func
(paren
id|port
comma
id|SCSCR
)paren
suffix:semicolon
id|ctrl
op_and_assign
op_complement
(paren
id|SCI_CTRL_FLAGS_RIE
op_or
id|SCI_CTRL_FLAGS_REIE
)paren
suffix:semicolon
id|sci_out
c_func
(paren
id|port
comma
id|SCSCR
comma
id|ctrl
)paren
suffix:semicolon
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|function|sci_enable_ms
r_static
r_void
id|sci_enable_ms
c_func
(paren
r_struct
id|uart_port
op_star
id|port
)paren
(brace
multiline_comment|/* Nothing here yet .. */
)brace
DECL|function|sci_break_ctl
r_static
r_void
id|sci_break_ctl
c_func
(paren
r_struct
id|uart_port
op_star
id|port
comma
r_int
id|break_state
)paren
(brace
multiline_comment|/* Nothing here yet .. */
)brace
DECL|function|sci_startup
r_static
r_int
id|sci_startup
c_func
(paren
r_struct
id|uart_port
op_star
id|port
)paren
(brace
r_struct
id|sci_port
op_star
id|s
op_assign
op_amp
id|sci_ports
(braket
id|port-&gt;line
)braket
suffix:semicolon
macro_line|#if defined(__H8300S__)
id|h8300_sci_enable
c_func
(paren
id|port
comma
id|sci_enable
)paren
suffix:semicolon
macro_line|#endif
id|sci_request_irq
c_func
(paren
id|s
)paren
suffix:semicolon
id|sci_start_tx
c_func
(paren
id|port
comma
l_int|1
)paren
suffix:semicolon
id|sci_start_rx
c_func
(paren
id|port
comma
l_int|1
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sci_shutdown
r_static
r_void
id|sci_shutdown
c_func
(paren
r_struct
id|uart_port
op_star
id|port
)paren
(brace
r_struct
id|sci_port
op_star
id|s
op_assign
op_amp
id|sci_ports
(braket
id|port-&gt;line
)braket
suffix:semicolon
id|sci_stop_rx
c_func
(paren
id|port
)paren
suffix:semicolon
id|sci_stop_tx
c_func
(paren
id|port
comma
l_int|1
)paren
suffix:semicolon
id|sci_free_irq
c_func
(paren
id|s
)paren
suffix:semicolon
macro_line|#if defined(__H8300S__)
id|h8300_sci_enable
c_func
(paren
id|port
comma
id|sci_disable
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|sci_set_termios
r_static
r_void
id|sci_set_termios
c_func
(paren
r_struct
id|uart_port
op_star
id|port
comma
r_struct
id|termios
op_star
id|termios
comma
r_struct
id|termios
op_star
id|old
)paren
(brace
r_struct
id|sci_port
op_star
id|s
op_assign
op_amp
id|sci_ports
(braket
id|port-&gt;line
)braket
suffix:semicolon
r_int
r_int
id|status
comma
id|baud
comma
id|smr_val
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|t
suffix:semicolon
id|baud
op_assign
id|uart_get_baud_rate
c_func
(paren
id|port
comma
id|termios
comma
id|old
comma
l_int|0
comma
id|port-&gt;uartclk
op_div
l_int|16
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|port-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_do
(brace
id|status
op_assign
id|sci_in
c_func
(paren
id|port
comma
id|SCxSR
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
op_logical_neg
(paren
id|status
op_amp
id|SCxSR_TEND
c_func
(paren
id|port
)paren
)paren
)paren
suffix:semicolon
id|sci_out
c_func
(paren
id|port
comma
id|SCSCR
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* TE=0, RE=0, CKE1=0 */
macro_line|#if !defined(SCI_ONLY)
r_if
c_cond
(paren
id|port-&gt;type
op_eq
id|PORT_SCIF
)paren
(brace
id|sci_out
c_func
(paren
id|port
comma
id|SCFCR
comma
id|SCFCR_RFRST
op_or
id|SCFCR_TFRST
)paren
suffix:semicolon
)brace
macro_line|#endif
id|smr_val
op_assign
id|sci_in
c_func
(paren
id|port
comma
id|SCSMR
)paren
op_amp
l_int|3
suffix:semicolon
r_if
c_cond
(paren
(paren
id|termios-&gt;c_cflag
op_amp
id|CSIZE
)paren
op_eq
id|CS7
)paren
id|smr_val
op_or_assign
l_int|0x40
suffix:semicolon
r_if
c_cond
(paren
id|termios-&gt;c_cflag
op_amp
id|PARENB
)paren
id|smr_val
op_or_assign
l_int|0x20
suffix:semicolon
r_if
c_cond
(paren
id|termios-&gt;c_cflag
op_amp
id|PARODD
)paren
id|smr_val
op_or_assign
l_int|0x30
suffix:semicolon
r_if
c_cond
(paren
id|termios-&gt;c_cflag
op_amp
id|CSTOPB
)paren
id|smr_val
op_or_assign
l_int|0x08
suffix:semicolon
id|uart_update_timeout
c_func
(paren
id|port
comma
id|termios-&gt;c_cflag
comma
id|baud
)paren
suffix:semicolon
id|sci_out
c_func
(paren
id|port
comma
id|SCSMR
comma
id|smr_val
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|baud
)paren
(brace
r_case
l_int|0
suffix:colon
id|t
op_assign
op_minus
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2400
suffix:colon
id|t
op_assign
id|BPS_2400
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4800
suffix:colon
id|t
op_assign
id|BPS_4800
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|9600
suffix:colon
id|t
op_assign
id|BPS_9600
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|19200
suffix:colon
id|t
op_assign
id|BPS_19200
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|38400
suffix:colon
id|t
op_assign
id|BPS_38400
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|57600
suffix:colon
id|t
op_assign
id|BPS_57600
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|115200
suffix:colon
id|t
op_assign
id|BPS_115200
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|t
op_assign
id|SCBRR_VALUE
c_func
(paren
id|baud
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|t
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|t
op_ge
l_int|256
)paren
(brace
id|sci_out
c_func
(paren
id|port
comma
id|SCSMR
comma
(paren
id|sci_in
c_func
(paren
id|port
comma
id|SCSMR
)paren
op_amp
op_complement
l_int|3
)paren
op_or
l_int|1
)paren
suffix:semicolon
id|t
op_rshift_assign
l_int|2
suffix:semicolon
)brace
r_else
(brace
id|sci_out
c_func
(paren
id|port
comma
id|SCSMR
comma
id|sci_in
c_func
(paren
id|port
comma
id|SCSMR
)paren
op_amp
op_complement
l_int|3
)paren
suffix:semicolon
)brace
id|sci_out
c_func
(paren
id|port
comma
id|SCBRR
comma
id|t
)paren
suffix:semicolon
id|udelay
c_func
(paren
(paren
l_int|1000000
op_plus
(paren
id|baud
op_minus
l_int|1
)paren
)paren
op_div
id|baud
)paren
suffix:semicolon
multiline_comment|/* Wait one bit interval */
)brace
id|s
op_member_access_from_pointer
id|init_pins
c_func
(paren
id|port
comma
id|termios-&gt;c_cflag
)paren
suffix:semicolon
id|sci_out
c_func
(paren
id|port
comma
id|SCSCR
comma
id|SCSCR_INIT
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|termios-&gt;c_cflag
op_amp
id|CREAD
)paren
op_ne
l_int|0
)paren
id|sci_start_rx
c_func
(paren
id|port
comma
l_int|0
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|port-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|sci_type
r_static
r_const
r_char
op_star
id|sci_type
c_func
(paren
r_struct
id|uart_port
op_star
id|port
)paren
(brace
r_switch
c_cond
(paren
id|port-&gt;type
)paren
(brace
r_case
id|PORT_SCI
suffix:colon
r_return
l_string|&quot;sci&quot;
suffix:semicolon
r_case
id|PORT_SCIF
suffix:colon
r_return
l_string|&quot;scif&quot;
suffix:semicolon
r_case
id|PORT_IRDA
suffix:colon
r_return
l_string|&quot;irda&quot;
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sci_release_port
r_static
r_void
id|sci_release_port
c_func
(paren
r_struct
id|uart_port
op_star
id|port
)paren
(brace
multiline_comment|/* Nothing here yet .. */
)brace
DECL|function|sci_request_port
r_static
r_int
id|sci_request_port
c_func
(paren
r_struct
id|uart_port
op_star
id|port
)paren
(brace
multiline_comment|/* Nothing here yet .. */
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sci_config_port
r_static
r_void
id|sci_config_port
c_func
(paren
r_struct
id|uart_port
op_star
id|port
comma
r_int
id|flags
)paren
(brace
r_struct
id|sci_port
op_star
id|s
op_assign
op_amp
id|sci_ports
(braket
id|port-&gt;line
)braket
suffix:semicolon
id|port-&gt;type
op_assign
id|s-&gt;type
suffix:semicolon
macro_line|#if defined(CONFIG_CPU_SUBTYPE_SH5_101) || defined(CONFIG_CPU_SUBTYPE_SH5_103)
r_if
c_cond
(paren
id|port-&gt;mapbase
op_eq
l_int|0
)paren
id|port-&gt;mapbase
op_assign
id|onchip_remap
c_func
(paren
id|SCIF_ADDR_SH5
comma
l_int|1024
comma
l_string|&quot;SCIF&quot;
)paren
suffix:semicolon
id|port-&gt;membase
op_assign
(paren
r_void
op_star
)paren
id|port-&gt;mapbase
suffix:semicolon
macro_line|#endif
)brace
DECL|function|sci_verify_port
r_static
r_int
id|sci_verify_port
c_func
(paren
r_struct
id|uart_port
op_star
id|port
comma
r_struct
id|serial_struct
op_star
id|ser
)paren
(brace
r_struct
id|sci_port
op_star
id|s
op_assign
op_amp
id|sci_ports
(braket
id|port-&gt;line
)braket
suffix:semicolon
r_if
c_cond
(paren
id|ser-&gt;irq
op_ne
id|s-&gt;irqs
(braket
id|SCIx_TXI_IRQ
)braket
op_logical_or
id|ser-&gt;irq
OG
id|NR_IRQS
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|ser-&gt;baud_base
OL
l_int|2400
)paren
multiline_comment|/* No paper tape reader for Mitch.. */
r_return
op_minus
id|EINVAL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|sci_uart_ops
r_static
r_struct
id|uart_ops
id|sci_uart_ops
op_assign
(brace
dot
id|tx_empty
op_assign
id|sci_tx_empty
comma
dot
id|set_mctrl
op_assign
id|sci_set_mctrl
comma
dot
id|get_mctrl
op_assign
id|sci_get_mctrl
comma
dot
id|start_tx
op_assign
id|sci_start_tx
comma
dot
id|stop_tx
op_assign
id|sci_stop_tx
comma
dot
id|stop_rx
op_assign
id|sci_stop_rx
comma
dot
id|enable_ms
op_assign
id|sci_enable_ms
comma
dot
id|break_ctl
op_assign
id|sci_break_ctl
comma
dot
id|startup
op_assign
id|sci_startup
comma
dot
id|shutdown
op_assign
id|sci_shutdown
comma
dot
id|set_termios
op_assign
id|sci_set_termios
comma
dot
id|type
op_assign
id|sci_type
comma
dot
id|release_port
op_assign
id|sci_release_port
comma
dot
id|request_port
op_assign
id|sci_request_port
comma
dot
id|config_port
op_assign
id|sci_config_port
comma
dot
id|verify_port
op_assign
id|sci_verify_port
comma
)brace
suffix:semicolon
DECL|variable|sci_ports
r_static
r_struct
id|sci_port
id|sci_ports
(braket
id|SCI_NPORTS
)braket
op_assign
(brace
macro_line|#if defined(CONFIG_CPU_SUBTYPE_SH7708)
(brace
dot
id|port
op_assign
(brace
dot
id|membase
op_assign
(paren
r_void
op_star
)paren
l_int|0xfffffe80
comma
dot
id|mapbase
op_assign
l_int|0xfffffe80
comma
dot
id|iotype
op_assign
id|SERIAL_IO_MEM
comma
dot
id|irq
op_assign
l_int|25
comma
dot
id|ops
op_assign
op_amp
id|sci_uart_ops
comma
dot
id|flags
op_assign
id|ASYNC_BOOT_AUTOCONF
comma
dot
id|line
op_assign
l_int|0
comma
)brace
comma
dot
id|type
op_assign
id|PORT_SCI
comma
dot
id|irqs
op_assign
id|SCI_IRQS
comma
dot
id|init_pins
op_assign
id|sci_init_pins_sci
comma
)brace
comma
macro_line|#elif defined(CONFIG_CPU_SUBTYPE_SH7705)
(brace
dot
id|port
op_assign
(brace
dot
id|membase
op_assign
(paren
r_void
op_star
)paren
id|SCIF0
comma
dot
id|mapbase
op_assign
id|SCIF0
comma
dot
id|iotype
op_assign
id|SERIAL_IO_MEM
comma
dot
id|irq
op_assign
l_int|55
comma
dot
id|ops
op_assign
op_amp
id|sci_uart_ops
comma
dot
id|flags
op_assign
id|ASYNC_BOOT_AUTOCONF
comma
dot
id|line
op_assign
l_int|0
comma
)brace
comma
dot
id|type
op_assign
id|PORT_SCIF
comma
dot
id|irqs
op_assign
id|SH3_IRDA_IRQS
comma
dot
id|init_pins
op_assign
id|sci_init_pins_scif
comma
)brace
comma
(brace
dot
id|port
op_assign
(brace
dot
id|membase
op_assign
(paren
r_void
op_star
)paren
id|SCIF2
comma
dot
id|mapbase
op_assign
id|SCIF2
comma
dot
id|iotype
op_assign
id|SERIAL_IO_MEM
comma
dot
id|irq
op_assign
l_int|59
comma
dot
id|ops
op_assign
op_amp
id|sci_uart_ops
comma
dot
id|flags
op_assign
id|ASYNC_BOOT_AUTOCONF
comma
dot
id|line
op_assign
l_int|1
comma
)brace
comma
dot
id|type
op_assign
id|PORT_SCIF
comma
dot
id|irqs
op_assign
id|SH3_SCIF_IRQS
comma
dot
id|init_pins
op_assign
id|sci_init_pins_scif
comma
)brace
macro_line|#elif defined(CONFIG_CPU_SUBTYPE_SH7707) || defined(CONFIG_CPU_SUBTYPE_SH7709)
(brace
dot
id|port
op_assign
(brace
dot
id|membase
op_assign
(paren
r_void
op_star
)paren
l_int|0xfffffe80
comma
dot
id|mapbase
op_assign
l_int|0xfffffe80
comma
dot
id|iotype
op_assign
id|SERIAL_IO_MEM
comma
dot
id|irq
op_assign
l_int|25
comma
dot
id|ops
op_assign
op_amp
id|sci_uart_ops
comma
dot
id|flags
op_assign
id|ASYNC_BOOT_AUTOCONF
comma
dot
id|line
op_assign
l_int|0
comma
)brace
comma
dot
id|type
op_assign
id|PORT_SCI
comma
dot
id|irqs
op_assign
id|SCI_IRQS
comma
dot
id|init_pins
op_assign
id|sci_init_pins_sci
comma
)brace
comma
(brace
dot
id|port
op_assign
(brace
dot
id|membase
op_assign
(paren
r_void
op_star
)paren
l_int|0xa4000150
comma
dot
id|mapbase
op_assign
l_int|0xa4000150
comma
dot
id|iotype
op_assign
id|SERIAL_IO_MEM
comma
dot
id|irq
op_assign
l_int|59
comma
dot
id|ops
op_assign
op_amp
id|sci_uart_ops
comma
dot
id|flags
op_assign
id|ASYNC_BOOT_AUTOCONF
comma
dot
id|line
op_assign
l_int|1
comma
)brace
comma
dot
id|type
op_assign
id|PORT_SCIF
comma
dot
id|irqs
op_assign
id|SH3_SCIF_IRQS
comma
dot
id|init_pins
op_assign
id|sci_init_pins_scif
comma
)brace
comma
(brace
dot
id|port
op_assign
(brace
dot
id|membase
op_assign
(paren
r_void
op_star
)paren
l_int|0xa4000140
comma
dot
id|mapbase
op_assign
l_int|0xa4000140
comma
dot
id|iotype
op_assign
id|SERIAL_IO_MEM
comma
dot
id|irq
op_assign
l_int|55
comma
dot
id|ops
op_assign
op_amp
id|sci_uart_ops
comma
dot
id|flags
op_assign
id|ASYNC_BOOT_AUTOCONF
comma
dot
id|line
op_assign
l_int|2
comma
)brace
comma
dot
id|type
op_assign
id|PORT_IRDA
comma
dot
id|irqs
op_assign
id|SH3_IRDA_IRQS
comma
dot
id|init_pins
op_assign
id|sci_init_pins_irda
comma
)brace
macro_line|#elif defined(CONFIG_CPU_SUBTYPE_SH7300)
(brace
dot
id|port
op_assign
(brace
dot
id|membase
op_assign
(paren
r_void
op_star
)paren
l_int|0xA4430000
comma
dot
id|mapbase
op_assign
l_int|0xA4430000
comma
dot
id|iotype
op_assign
id|SERIAL_IO_MEM
comma
dot
id|irq
op_assign
l_int|25
comma
dot
id|ops
op_assign
op_amp
id|sci_uart_ops
comma
dot
id|flags
op_assign
id|ASYNC_BOOT_AUTOCONF
comma
dot
id|line
op_assign
l_int|0
comma
)brace
comma
dot
id|type
op_assign
id|PORT_SCIF
comma
dot
id|irqs
op_assign
id|SH7300_SCIF0_IRQS
comma
dot
id|init_pins
op_assign
id|sci_init_pins_scif
comma
)brace
comma
macro_line|#elif defined(CONFIG_CPU_SUBTYPE_SH73180)
(brace
dot
id|port
op_assign
(brace
dot
id|membase
op_assign
(paren
r_void
op_star
)paren
l_int|0xffe00000
comma
dot
id|mapbase
op_assign
l_int|0xffe00000
comma
dot
id|iotype
op_assign
id|SERIAL_IO_MEM
comma
dot
id|irq
op_assign
l_int|25
comma
dot
id|ops
op_assign
op_amp
id|sci_uart_ops
comma
dot
id|flags
op_assign
id|ASYNC_BOOT_AUTOCONF
comma
dot
id|line
op_assign
l_int|0
comma
)brace
comma
dot
id|type
op_assign
id|PORT_SCIF
comma
dot
id|irqs
op_assign
id|SH73180_SCIF_IRQS
comma
dot
id|init_pins
op_assign
id|sci_init_pins_scif
comma
)brace
comma
macro_line|#elif defined(CONFIG_SH_RTS7751R2D)
(brace
dot
id|port
op_assign
(brace
dot
id|membase
op_assign
(paren
r_void
op_star
)paren
l_int|0xffe80000
comma
dot
id|mapbase
op_assign
l_int|0xffe80000
comma
dot
id|iotype
op_assign
id|SERIAL_IO_MEM
comma
dot
id|irq
op_assign
l_int|43
comma
dot
id|ops
op_assign
op_amp
id|sci_uart_ops
comma
dot
id|flags
op_assign
id|ASYNC_BOOT_AUTOCONF
comma
dot
id|line
op_assign
l_int|0
comma
)brace
comma
dot
id|type
op_assign
id|PORT_SCIF
comma
dot
id|irqs
op_assign
id|SH4_SCIF_IRQS
comma
dot
id|init_pins
op_assign
id|sci_init_pins_scif
comma
)brace
comma
macro_line|#elif defined(CONFIG_CPU_SUBTYPE_SH7750) || defined(CONFIG_CPU_SUBTYPE_SH7751)
(brace
dot
id|port
op_assign
(brace
dot
id|membase
op_assign
(paren
r_void
op_star
)paren
l_int|0xffe00000
comma
dot
id|mapbase
op_assign
l_int|0xffe00000
comma
dot
id|iotype
op_assign
id|SERIAL_IO_MEM
comma
dot
id|irq
op_assign
l_int|25
comma
dot
id|ops
op_assign
op_amp
id|sci_uart_ops
comma
dot
id|flags
op_assign
id|ASYNC_BOOT_AUTOCONF
comma
dot
id|line
op_assign
l_int|0
comma
)brace
comma
dot
id|type
op_assign
id|PORT_SCI
comma
dot
id|irqs
op_assign
id|SCI_IRQS
comma
dot
id|init_pins
op_assign
id|sci_init_pins_sci
comma
)brace
comma
(brace
dot
id|port
op_assign
(brace
dot
id|membase
op_assign
(paren
r_void
op_star
)paren
l_int|0xffe80000
comma
dot
id|mapbase
op_assign
l_int|0xffe80000
comma
dot
id|iotype
op_assign
id|SERIAL_IO_MEM
comma
dot
id|irq
op_assign
l_int|43
comma
dot
id|ops
op_assign
op_amp
id|sci_uart_ops
comma
dot
id|flags
op_assign
id|ASYNC_BOOT_AUTOCONF
comma
dot
id|line
op_assign
l_int|1
comma
)brace
comma
dot
id|type
op_assign
id|PORT_SCIF
comma
dot
id|irqs
op_assign
id|SH4_SCIF_IRQS
comma
dot
id|init_pins
op_assign
id|sci_init_pins_scif
comma
)brace
comma
macro_line|#elif defined(CONFIG_CPU_SUBTYPE_SH7760)
(brace
dot
id|port
op_assign
(brace
dot
id|membase
op_assign
(paren
r_void
op_star
)paren
l_int|0xfe600000
comma
dot
id|mapbase
op_assign
l_int|0xfe600000
comma
dot
id|iotype
op_assign
id|SERIAL_IO_MEM
comma
dot
id|irq
op_assign
l_int|55
comma
dot
id|ops
op_assign
op_amp
id|sci_uart_ops
comma
dot
id|flags
op_assign
id|ASYNC_BOOT_AUTOCONF
comma
dot
id|line
op_assign
l_int|0
comma
)brace
comma
dot
id|type
op_assign
id|PORT_SCIF
comma
dot
id|irqs
op_assign
id|SH7760_SCIF0_IRQS
comma
dot
id|init_pins
op_assign
id|sci_init_pins_scif
comma
)brace
comma
(brace
dot
id|port
op_assign
(brace
dot
id|membase
op_assign
(paren
r_void
op_star
)paren
l_int|0xfe610000
comma
dot
id|mapbase
op_assign
l_int|0xfe610000
comma
dot
id|iotype
op_assign
id|SERIAL_IO_MEM
comma
dot
id|irq
op_assign
l_int|75
comma
dot
id|ops
op_assign
op_amp
id|sci_uart_ops
comma
dot
id|flags
op_assign
id|ASYNC_BOOT_AUTOCONF
comma
dot
id|line
op_assign
l_int|1
comma
)brace
comma
dot
id|type
op_assign
id|PORT_SCIF
comma
dot
id|irqs
op_assign
id|SH7760_SCIF1_IRQS
comma
dot
id|init_pins
op_assign
id|sci_init_pins_scif
comma
)brace
comma
(brace
dot
id|port
op_assign
(brace
dot
id|membase
op_assign
(paren
r_void
op_star
)paren
l_int|0xfe620000
comma
dot
id|mapbase
op_assign
l_int|0xfe620000
comma
dot
id|iotype
op_assign
id|SERIAL_IO_MEM
comma
dot
id|irq
op_assign
l_int|79
comma
dot
id|ops
op_assign
op_amp
id|sci_uart_ops
comma
dot
id|flags
op_assign
id|ASYNC_BOOT_AUTOCONF
comma
dot
id|line
op_assign
l_int|2
comma
)brace
comma
dot
id|type
op_assign
id|PORT_SCIF
comma
dot
id|irqs
op_assign
id|SH7760_SCIF2_IRQS
comma
dot
id|init_pins
op_assign
id|sci_init_pins_scif
comma
)brace
comma
macro_line|#elif defined(CONFIG_CPU_SUBTYPE_SH4_202)
(brace
dot
id|port
op_assign
(brace
dot
id|membase
op_assign
(paren
r_void
op_star
)paren
l_int|0xffe80000
comma
dot
id|mapbase
op_assign
l_int|0xffe80000
comma
dot
id|iotype
op_assign
id|SERIAL_IO_MEM
comma
dot
id|irq
op_assign
l_int|43
comma
dot
id|ops
op_assign
op_amp
id|sci_uart_ops
comma
dot
id|flags
op_assign
id|ASYNC_BOOT_AUTOCONF
comma
dot
id|line
op_assign
l_int|0
comma
)brace
comma
dot
id|type
op_assign
id|PORT_SCIF
comma
dot
id|irqs
op_assign
id|SH4_SCIF_IRQS
comma
dot
id|init_pins
op_assign
id|sci_init_pins_scif
comma
)brace
comma
macro_line|#elif defined(CONFIG_CPU_SUBTYPE_ST40STB1)
(brace
dot
id|port
op_assign
(brace
dot
id|membase
op_assign
(paren
r_void
op_star
)paren
l_int|0xffe00000
comma
dot
id|mapbase
op_assign
l_int|0xffe00000
comma
dot
id|iotype
op_assign
id|SERIAL_IO_MEM
comma
dot
id|irq
op_assign
l_int|26
comma
dot
id|ops
op_assign
op_amp
id|sci_uart_ops
comma
dot
id|flags
op_assign
id|ASYNC_BOOT_AUTOCONF
comma
dot
id|line
op_assign
l_int|0
comma
)brace
comma
dot
id|type
op_assign
id|PORT_SCIF
comma
dot
id|irqs
op_assign
id|STB1_SCIF1_IRQS
comma
dot
id|init_pins
op_assign
id|sci_init_pins_scif
comma
)brace
comma
(brace
dot
id|port
op_assign
(brace
dot
id|membase
op_assign
(paren
r_void
op_star
)paren
l_int|0xffe80000
comma
dot
id|mapbase
op_assign
l_int|0xffe80000
comma
dot
id|iotype
op_assign
id|SERIAL_IO_MEM
comma
dot
id|irq
op_assign
l_int|43
comma
dot
id|ops
op_assign
op_amp
id|sci_uart_ops
comma
dot
id|flags
op_assign
id|ASYNC_BOOT_AUTOCONF
comma
dot
id|line
op_assign
l_int|1
comma
)brace
comma
dot
id|type
op_assign
id|PORT_SCIF
comma
dot
id|irqs
op_assign
id|SH4_SCIF_IRQS
comma
dot
id|init_pins
op_assign
id|sci_init_pins_scif
comma
)brace
comma
macro_line|#elif defined(CONFIG_CPU_SUBTYPE_SH5_101) || defined(CONFIG_CPU_SUBTYPE_SH5_103)
(brace
dot
id|port
op_assign
(brace
dot
id|iotype
op_assign
id|SERIAL_IO_MEM
comma
dot
id|irq
op_assign
l_int|42
comma
dot
id|ops
op_assign
op_amp
id|sci_uart_ops
comma
dot
id|flags
op_assign
id|ASYNC_BOOT_AUTOCONF
comma
dot
id|line
op_assign
l_int|0
comma
)brace
comma
dot
id|type
op_assign
id|PORT_SCIF
comma
dot
id|irqs
op_assign
id|SH5_SCIF_IRQS
comma
dot
id|init_pins
op_assign
id|sci_init_pins_scif
comma
)brace
comma
macro_line|#elif defined(CONFIG_H83007) || defined(CONFIG_H83068)
(brace
dot
id|port
op_assign
(brace
dot
id|membase
op_assign
(paren
r_void
op_star
)paren
l_int|0x00ffffb0
comma
dot
id|mapbase
op_assign
l_int|0x00ffffb0
comma
dot
id|iotype
op_assign
id|SERIAL_IO_MEM
comma
dot
id|irq
op_assign
l_int|54
comma
dot
id|ops
op_assign
op_amp
id|sci_uart_ops
comma
dot
id|flags
op_assign
id|ASYNC_BOOT_AUTOCONF
comma
dot
id|line
op_assign
l_int|0
comma
)brace
comma
dot
id|type
op_assign
id|PORT_SCI
comma
dot
id|irqs
op_assign
id|H8300H_SCI_IRQS0
comma
dot
id|init_pins
op_assign
id|sci_init_pins_sci
comma
)brace
comma
(brace
dot
id|port
op_assign
(brace
dot
id|membase
op_assign
(paren
r_void
op_star
)paren
l_int|0x00ffffb8
comma
dot
id|mapbase
op_assign
l_int|0x00ffffb8
comma
dot
id|iotype
op_assign
id|SERIAL_IO_MEM
comma
dot
id|irq
op_assign
l_int|58
comma
dot
id|ops
op_assign
op_amp
id|sci_uart_ops
comma
dot
id|flags
op_assign
id|ASYNC_BOOT_AUTOCONF
comma
dot
id|line
op_assign
l_int|1
comma
)brace
comma
dot
id|type
op_assign
id|PORT_SCI
comma
dot
id|irqs
op_assign
id|H8300H_SCI_IRQS1
comma
dot
id|init_pins
op_assign
id|sci_init_pins_sci
comma
)brace
comma
(brace
dot
id|port
op_assign
(brace
dot
id|membase
op_assign
(paren
r_void
op_star
)paren
l_int|0x00ffffc0
comma
dot
id|mapbase
op_assign
l_int|0x00ffffc0
comma
dot
id|iotype
op_assign
id|SERIAL_IO_MEM
comma
dot
id|irq
op_assign
l_int|62
comma
dot
id|ops
op_assign
op_amp
id|sci_uart_ops
comma
dot
id|flags
op_assign
id|ASYNC_BOOT_AUTOCONF
comma
dot
id|line
op_assign
l_int|2
comma
)brace
comma
dot
id|type
op_assign
id|PORT_SCI
comma
dot
id|irqs
op_assign
id|H8300H_SCI_IRQS2
comma
dot
id|init_pins
op_assign
id|sci_init_pins_sci
comma
)brace
comma
macro_line|#elif defined(CONFIG_H8S2678)
(brace
dot
id|port
op_assign
(brace
dot
id|membase
op_assign
(paren
r_void
op_star
)paren
l_int|0x00ffff78
comma
dot
id|mapbase
op_assign
l_int|0x00ffff78
comma
dot
id|iotype
op_assign
id|SERIAL_IO_MEM
comma
dot
id|irq
op_assign
l_int|90
comma
dot
id|ops
op_assign
op_amp
id|sci_uart_ops
comma
dot
id|flags
op_assign
id|ASYNC_BOOT_AUTOCONF
comma
dot
id|line
op_assign
l_int|0
comma
)brace
comma
dot
id|type
op_assign
id|PORT_SCI
comma
dot
id|irqs
op_assign
id|H8S_SCI_IRQS0
comma
dot
id|init_pins
op_assign
id|sci_init_pins_sci
comma
)brace
comma
(brace
dot
id|port
op_assign
(brace
dot
id|membase
op_assign
(paren
r_void
op_star
)paren
l_int|0x00ffff80
comma
dot
id|mapbase
op_assign
l_int|0x00ffff80
comma
dot
id|iotype
op_assign
id|SERIAL_IO_MEM
comma
dot
id|irq
op_assign
l_int|94
comma
dot
id|ops
op_assign
op_amp
id|sci_uart_ops
comma
dot
id|flags
op_assign
id|ASYNC_BOOT_AUTOCONF
comma
dot
id|line
op_assign
l_int|1
comma
)brace
comma
dot
id|type
op_assign
id|PORT_SCI
comma
dot
id|irqs
op_assign
id|H8S_SCI_IRQS1
comma
dot
id|init_pins
op_assign
id|sci_init_pins_sci
comma
)brace
comma
(brace
dot
id|port
op_assign
(brace
dot
id|membase
op_assign
(paren
r_void
op_star
)paren
l_int|0x00ffff88
comma
dot
id|mapbase
op_assign
l_int|0x00ffff88
comma
dot
id|iotype
op_assign
id|SERIAL_IO_MEM
comma
dot
id|irq
op_assign
l_int|98
comma
dot
id|ops
op_assign
op_amp
id|sci_uart_ops
comma
dot
id|flags
op_assign
id|ASYNC_BOOT_AUTOCONF
comma
dot
id|line
op_assign
l_int|2
comma
)brace
comma
dot
id|type
op_assign
id|PORT_SCI
comma
dot
id|irqs
op_assign
id|H8S_SCI_IRQS2
comma
dot
id|init_pins
op_assign
id|sci_init_pins_sci
comma
)brace
comma
macro_line|#else
macro_line|#error &quot;CPU subtype not defined&quot;
macro_line|#endif
)brace
suffix:semicolon
macro_line|#ifdef CONFIG_SERIAL_SH_SCI_CONSOLE
multiline_comment|/*&n; *&t;Print a string to the serial port trying not to disturb&n; *&t;any possible real use of the port...&n; */
DECL|function|serial_console_write
r_static
r_void
id|serial_console_write
c_func
(paren
r_struct
id|console
op_star
id|co
comma
r_const
r_char
op_star
id|s
comma
r_int
id|count
)paren
(brace
id|put_string
c_func
(paren
id|serial_console_port
comma
id|s
comma
id|count
)paren
suffix:semicolon
)brace
DECL|function|serial_console_setup
r_static
r_int
id|__init
id|serial_console_setup
c_func
(paren
r_struct
id|console
op_star
id|co
comma
r_char
op_star
id|options
)paren
(brace
r_struct
id|uart_port
op_star
id|port
suffix:semicolon
r_int
id|baud
op_assign
l_int|115200
suffix:semicolon
r_int
id|bits
op_assign
l_int|8
suffix:semicolon
r_int
id|parity
op_assign
l_char|&squot;n&squot;
suffix:semicolon
r_int
id|flow
op_assign
l_char|&squot;n&squot;
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
id|co-&gt;index
op_ge
id|SCI_NPORTS
)paren
id|co-&gt;index
op_assign
l_int|0
suffix:semicolon
id|serial_console_port
op_assign
op_amp
id|sci_ports
(braket
id|co-&gt;index
)braket
suffix:semicolon
id|port
op_assign
op_amp
id|serial_console_port-&gt;port
suffix:semicolon
id|port-&gt;type
op_assign
id|serial_console_port-&gt;type
suffix:semicolon
macro_line|#ifdef CONFIG_SUPERH64
multiline_comment|/* This is especially needed on sh64 to remap the SCIF */
id|sci_config_port
c_func
(paren
id|port
comma
l_int|0
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;&t; * We need to set the initial uartclk here, since otherwise it will&n;&t; * only ever be setup at sci_init() time.&n;&t; */
macro_line|#if !defined(__H8300H__) &amp;&amp; !defined(__H8300S__)
id|port-&gt;uartclk
op_assign
id|current_cpu_data.module_clock
op_star
l_int|16
suffix:semicolon
macro_line|#else
id|port-&gt;uartclk
op_assign
id|CONFIG_CPU_CLOCK
suffix:semicolon
macro_line|#endif
macro_line|#if defined(__H8300S__)
id|h8300_sci_enable
c_func
(paren
id|port
comma
id|sci_enable
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|options
)paren
id|uart_parse_options
c_func
(paren
id|options
comma
op_amp
id|baud
comma
op_amp
id|parity
comma
op_amp
id|bits
comma
op_amp
id|flow
)paren
suffix:semicolon
id|ret
op_assign
id|uart_set_options
c_func
(paren
id|port
comma
id|co
comma
id|baud
comma
id|parity
comma
id|bits
comma
id|flow
)paren
suffix:semicolon
macro_line|#if defined(__H8300H__) || defined(__H8300S__)
multiline_comment|/* disable rx interrupt */
r_if
c_cond
(paren
id|ret
op_eq
l_int|0
)paren
id|sci_stop_rx
c_func
(paren
id|port
)paren
suffix:semicolon
macro_line|#endif
r_return
id|ret
suffix:semicolon
)brace
DECL|variable|serial_console
r_static
r_struct
id|console
id|serial_console
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;ttySC&quot;
comma
dot
id|device
op_assign
id|uart_console_device
comma
dot
id|write
op_assign
id|serial_console_write
comma
dot
id|setup
op_assign
id|serial_console_setup
comma
dot
id|flags
op_assign
id|CON_PRINTBUFFER
comma
dot
id|index
op_assign
op_minus
l_int|1
comma
dot
id|data
op_assign
op_amp
id|sci_uart_driver
comma
)brace
suffix:semicolon
DECL|function|sci_console_init
r_static
r_int
id|__init
id|sci_console_init
c_func
(paren
r_void
)paren
(brace
id|register_console
c_func
(paren
op_amp
id|serial_console
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|sci_console_init
id|console_initcall
c_func
(paren
id|sci_console_init
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_SERIAL_SH_SCI_CONSOLE */
macro_line|#ifdef CONFIG_SH_KGDB
multiline_comment|/*&n; * FIXME: Most of this can go away.. at the moment, we rely on&n; * arch/sh/kernel/setup.c to do the command line parsing for kgdb, though&n; * most of that can easily be done here instead.&n; *&n; * For the time being, just accept the values that were parsed earlier..&n; */
DECL|function|kgdb_console_get_options
r_static
r_void
id|__init
id|kgdb_console_get_options
c_func
(paren
r_struct
id|uart_port
op_star
id|port
comma
r_int
op_star
id|baud
comma
r_int
op_star
id|parity
comma
r_int
op_star
id|bits
)paren
(brace
op_star
id|baud
op_assign
id|kgdb_baud
suffix:semicolon
op_star
id|parity
op_assign
id|tolower
c_func
(paren
id|kgdb_parity
)paren
suffix:semicolon
op_star
id|bits
op_assign
id|kgdb_bits
op_minus
l_char|&squot;0&squot;
suffix:semicolon
)brace
multiline_comment|/*&n; * The naming here is somewhat misleading, since kgdb_console_setup() takes&n; * care of the early-on initialization for kgdb, regardless of whether we&n; * actually use kgdb as a console or not.&n; *&n; * On the plus side, this lets us kill off the old kgdb_sci_setup() nonsense.&n; */
DECL|function|kgdb_console_setup
r_int
id|__init
id|kgdb_console_setup
c_func
(paren
r_struct
id|console
op_star
id|co
comma
r_char
op_star
id|options
)paren
(brace
r_struct
id|uart_port
op_star
id|port
op_assign
op_amp
id|sci_ports
(braket
id|kgdb_portnum
)braket
dot
id|port
suffix:semicolon
r_int
id|baud
op_assign
l_int|38400
suffix:semicolon
r_int
id|bits
op_assign
l_int|8
suffix:semicolon
r_int
id|parity
op_assign
l_char|&squot;n&squot;
suffix:semicolon
r_int
id|flow
op_assign
l_char|&squot;n&squot;
suffix:semicolon
r_if
c_cond
(paren
id|co-&gt;index
op_ge
id|SCI_NPORTS
op_logical_or
id|co-&gt;index
op_ne
id|kgdb_portnum
)paren
id|co-&gt;index
op_assign
id|kgdb_portnum
suffix:semicolon
r_if
c_cond
(paren
id|options
)paren
id|uart_parse_options
c_func
(paren
id|options
comma
op_amp
id|baud
comma
op_amp
id|parity
comma
op_amp
id|bits
comma
op_amp
id|flow
)paren
suffix:semicolon
r_else
id|kgdb_console_get_options
c_func
(paren
id|port
comma
op_amp
id|baud
comma
op_amp
id|parity
comma
op_amp
id|bits
)paren
suffix:semicolon
id|kgdb_getchar
op_assign
id|kgdb_sci_getchar
suffix:semicolon
id|kgdb_putchar
op_assign
id|kgdb_sci_putchar
suffix:semicolon
r_return
id|uart_set_options
c_func
(paren
id|port
comma
id|co
comma
id|baud
comma
id|parity
comma
id|bits
comma
id|flow
)paren
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_SH_KGDB */
macro_line|#ifdef CONFIG_SH_KGDB_CONSOLE
DECL|variable|kgdb_console
r_static
r_struct
id|console
id|kgdb_console
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;ttySC&quot;
comma
dot
id|write
op_assign
id|kgdb_console_write
comma
dot
id|setup
op_assign
id|kgdb_console_setup
comma
dot
id|flags
op_assign
id|CON_PRINTBUFFER
op_or
id|CON_ENABLED
comma
dot
id|index
op_assign
op_minus
l_int|1
comma
dot
id|data
op_assign
op_amp
id|sci_uart_driver
comma
)brace
suffix:semicolon
multiline_comment|/* Register the KGDB console so we get messages (d&squot;oh!) */
DECL|function|kgdb_console_init
r_static
r_int
id|__init
id|kgdb_console_init
c_func
(paren
r_void
)paren
(brace
id|register_console
c_func
(paren
op_amp
id|kgdb_console
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|kgdb_console_init
id|console_initcall
c_func
(paren
id|kgdb_console_init
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_SH_KGDB_CONSOLE */
macro_line|#if defined(CONFIG_SH_KGDB_CONSOLE)
DECL|macro|SCI_CONSOLE
mdefine_line|#define SCI_CONSOLE&t;&amp;kgdb_console
macro_line|#elif defined(CONFIG_SERIAL_SH_SCI_CONSOLE)
DECL|macro|SCI_CONSOLE
mdefine_line|#define SCI_CONSOLE&t;&amp;serial_console
macro_line|#else
DECL|macro|SCI_CONSOLE
mdefine_line|#define SCI_CONSOLE &t;0
macro_line|#endif
DECL|variable|__initdata
r_static
r_char
id|banner
(braket
)braket
id|__initdata
op_assign
id|KERN_INFO
l_string|&quot;SuperH SCI(F) driver initialized&bslash;n&quot;
suffix:semicolon
DECL|variable|sci_uart_driver
r_static
r_struct
id|uart_driver
id|sci_uart_driver
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|driver_name
op_assign
l_string|&quot;sci&quot;
comma
macro_line|#ifdef CONFIG_DEVFS_FS
dot
id|devfs_name
op_assign
l_string|&quot;ttsc/&quot;
comma
macro_line|#endif
dot
id|dev_name
op_assign
l_string|&quot;ttySC&quot;
comma
dot
id|major
op_assign
id|SCI_MAJOR
comma
dot
id|minor
op_assign
id|SCI_MINOR_START
comma
dot
id|nr
op_assign
id|SCI_NPORTS
comma
dot
id|cons
op_assign
id|SCI_CONSOLE
comma
)brace
suffix:semicolon
DECL|function|sci_init
r_static
r_int
id|__init
id|sci_init
c_func
(paren
r_void
)paren
(brace
r_int
id|chan
comma
id|ret
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s&quot;
comma
id|banner
)paren
suffix:semicolon
id|ret
op_assign
id|uart_register_driver
c_func
(paren
op_amp
id|sci_uart_driver
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
l_int|0
)paren
(brace
r_for
c_loop
(paren
id|chan
op_assign
l_int|0
suffix:semicolon
id|chan
OL
id|SCI_NPORTS
suffix:semicolon
id|chan
op_increment
)paren
(brace
r_struct
id|sci_port
op_star
id|sciport
op_assign
op_amp
id|sci_ports
(braket
id|chan
)braket
suffix:semicolon
macro_line|#if !defined(__H8300H__) &amp;&amp; !defined(__H8300S__)
id|sciport-&gt;port.uartclk
op_assign
(paren
id|current_cpu_data.module_clock
op_star
l_int|16
)paren
suffix:semicolon
macro_line|#else
id|sciport-&gt;port.uartclk
op_assign
id|CONFIG_CPU_CLOCK
suffix:semicolon
macro_line|#endif
id|uart_add_one_port
c_func
(paren
op_amp
id|sci_uart_driver
comma
op_amp
id|sciport-&gt;port
)paren
suffix:semicolon
id|sciport-&gt;break_timer.data
op_assign
(paren
r_int
r_int
)paren
id|sciport
suffix:semicolon
id|sciport-&gt;break_timer.function
op_assign
id|sci_break_timer
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|sciport-&gt;break_timer
)paren
suffix:semicolon
)brace
)brace
macro_line|#ifdef CONFIG_CPU_FREQ
id|cpufreq_register_notifier
c_func
(paren
op_amp
id|sci_nb
comma
id|CPUFREQ_TRANSITION_NOTIFIER
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;sci: CPU frequency notifier registered&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_SH_STANDARD_BIOS
id|sh_bios_gdb_detach
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
r_return
id|ret
suffix:semicolon
)brace
DECL|function|sci_exit
r_static
r_void
id|__exit
id|sci_exit
c_func
(paren
r_void
)paren
(brace
r_int
id|chan
suffix:semicolon
r_for
c_loop
(paren
id|chan
op_assign
l_int|0
suffix:semicolon
id|chan
OL
id|SCI_NPORTS
suffix:semicolon
id|chan
op_increment
)paren
id|uart_remove_one_port
c_func
(paren
op_amp
id|sci_uart_driver
comma
op_amp
id|sci_ports
(braket
id|chan
)braket
dot
id|port
)paren
suffix:semicolon
id|uart_unregister_driver
c_func
(paren
op_amp
id|sci_uart_driver
)paren
suffix:semicolon
)brace
DECL|variable|sci_init
id|module_init
c_func
(paren
id|sci_init
)paren
suffix:semicolon
DECL|variable|sci_exit
id|module_exit
c_func
(paren
id|sci_exit
)paren
suffix:semicolon
eof
