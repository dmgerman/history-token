multiline_comment|/*&n; * Driver for Zilog serial chips found on SGI workstations and&n; * servers.  This driver could actually be made more generic.&n; *&n; * This is based on the drivers/serial/sunzilog.c code as of 2.6.0-test7 and the&n; * old drivers/sgi/char/sgiserial.c code which itself is based of the original&n; * drivers/sbus/char/zs.c code.  A lot of code has been simply moved over&n; * directly from there but much has been rewritten.  Credits therefore go out&n; * to David S. Miller, Eddie C. Dost, Pete Zaitcev, Ted Ts&squot;o and Alex Buell&n; * for their work there.&n; *&n; *  Copyright (C) 2002 Ralf Baechle (ralf@linux-mips.org)&n; *  Copyright (C) 2002 David S. Miller (davem@redhat.com)&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/tty_flip.h&gt;
macro_line|#include &lt;linux/major.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/circ_buf.h&gt;
macro_line|#include &lt;linux/serial.h&gt;
macro_line|#include &lt;linux/sysrq.h&gt;
macro_line|#include &lt;linux/console.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/sgialib.h&gt;
macro_line|#include &lt;asm/sgi/ioc.h&gt;
macro_line|#include &lt;asm/sgi/hpc3.h&gt;
macro_line|#include &lt;asm/sgi/ip22.h&gt;
macro_line|#if defined(CONFIG_SERIAL_IP22_ZILOG_CONSOLE) &amp;&amp; defined(CONFIG_MAGIC_SYSRQ)
DECL|macro|SUPPORT_SYSRQ
mdefine_line|#define SUPPORT_SYSRQ
macro_line|#endif
macro_line|#include &lt;linux/serial_core.h&gt;
macro_line|#include &quot;ip22zilog.h&quot;
r_void
id|ip22_do_break
c_func
(paren
r_void
)paren
suffix:semicolon
multiline_comment|/*&n; * On IP22 we need to delay after register accesses but we do not need to&n; * flush writes.&n; */
DECL|macro|ZSDELAY
mdefine_line|#define ZSDELAY()&t;&t;udelay(5)
DECL|macro|ZSDELAY_LONG
mdefine_line|#define ZSDELAY_LONG()&t;&t;udelay(20)
DECL|macro|ZS_WSYNC
mdefine_line|#define ZS_WSYNC(channel)&t;do { } while (0)
DECL|macro|NUM_IP22ZILOG
mdefine_line|#define NUM_IP22ZILOG&t;&t;1
DECL|macro|NUM_CHANNELS
mdefine_line|#define NUM_CHANNELS&t;&t;(NUM_IP22ZILOG * 2)
DECL|macro|ZS_CLOCK
mdefine_line|#define ZS_CLOCK&t;&t;3672000&t;/* Zilog input clock rate. */
DECL|macro|ZS_CLOCK_DIVISOR
mdefine_line|#define ZS_CLOCK_DIVISOR&t;16      /* Divisor this driver uses. */
multiline_comment|/*&n; * We wrap our port structure around the generic uart_port.&n; */
DECL|struct|uart_ip22zilog_port
r_struct
id|uart_ip22zilog_port
(brace
DECL|member|port
r_struct
id|uart_port
id|port
suffix:semicolon
multiline_comment|/* IRQ servicing chain.  */
DECL|member|next
r_struct
id|uart_ip22zilog_port
op_star
id|next
suffix:semicolon
multiline_comment|/* Current values of Zilog write registers.  */
DECL|member|curregs
r_int
r_char
id|curregs
(braket
id|NUM_ZSREGS
)braket
suffix:semicolon
DECL|member|flags
r_int
r_int
id|flags
suffix:semicolon
DECL|macro|IP22ZILOG_FLAG_IS_CONS
mdefine_line|#define IP22ZILOG_FLAG_IS_CONS&t;&t;0x00000004
DECL|macro|IP22ZILOG_FLAG_IS_KGDB
mdefine_line|#define IP22ZILOG_FLAG_IS_KGDB&t;&t;0x00000008
DECL|macro|IP22ZILOG_FLAG_MODEM_STATUS
mdefine_line|#define IP22ZILOG_FLAG_MODEM_STATUS&t;0x00000010
DECL|macro|IP22ZILOG_FLAG_IS_CHANNEL_A
mdefine_line|#define IP22ZILOG_FLAG_IS_CHANNEL_A&t;0x00000020
DECL|macro|IP22ZILOG_FLAG_REGS_HELD
mdefine_line|#define IP22ZILOG_FLAG_REGS_HELD&t;0x00000040
DECL|macro|IP22ZILOG_FLAG_TX_STOPPED
mdefine_line|#define IP22ZILOG_FLAG_TX_STOPPED&t;0x00000080
DECL|macro|IP22ZILOG_FLAG_TX_ACTIVE
mdefine_line|#define IP22ZILOG_FLAG_TX_ACTIVE&t;0x00000100
DECL|member|cflag
r_int
r_int
id|cflag
suffix:semicolon
multiline_comment|/* L1-A keyboard break state.  */
DECL|member|kbd_id
r_int
id|kbd_id
suffix:semicolon
DECL|member|l1_down
r_int
id|l1_down
suffix:semicolon
DECL|member|parity_mask
r_int
r_char
id|parity_mask
suffix:semicolon
DECL|member|prev_status
r_int
r_char
id|prev_status
suffix:semicolon
)brace
suffix:semicolon
DECL|macro|ZILOG_CHANNEL_FROM_PORT
mdefine_line|#define ZILOG_CHANNEL_FROM_PORT(PORT)&t;((struct zilog_channel *)((PORT)-&gt;membase))
DECL|macro|UART_ZILOG
mdefine_line|#define UART_ZILOG(PORT)&t;&t;((struct uart_ip22zilog_port *)(PORT))
DECL|macro|IP22ZILOG_GET_CURR_REG
mdefine_line|#define IP22ZILOG_GET_CURR_REG(PORT, REGNUM)&t;&t;&bslash;&n;&t;(UART_ZILOG(PORT)-&gt;curregs[REGNUM])
DECL|macro|IP22ZILOG_SET_CURR_REG
mdefine_line|#define IP22ZILOG_SET_CURR_REG(PORT, REGNUM, REGVAL)&t;&bslash;&n;&t;((UART_ZILOG(PORT)-&gt;curregs[REGNUM]) = (REGVAL))
DECL|macro|ZS_IS_CONS
mdefine_line|#define ZS_IS_CONS(UP)&t;((UP)-&gt;flags &amp; IP22ZILOG_FLAG_IS_CONS)
DECL|macro|ZS_IS_KGDB
mdefine_line|#define ZS_IS_KGDB(UP)&t;((UP)-&gt;flags &amp; IP22ZILOG_FLAG_IS_KGDB)
DECL|macro|ZS_WANTS_MODEM_STATUS
mdefine_line|#define ZS_WANTS_MODEM_STATUS(UP)&t;((UP)-&gt;flags &amp; IP22ZILOG_FLAG_MODEM_STATUS)
DECL|macro|ZS_IS_CHANNEL_A
mdefine_line|#define ZS_IS_CHANNEL_A(UP)&t;((UP)-&gt;flags &amp; IP22ZILOG_FLAG_IS_CHANNEL_A)
DECL|macro|ZS_REGS_HELD
mdefine_line|#define ZS_REGS_HELD(UP)&t;((UP)-&gt;flags &amp; IP22ZILOG_FLAG_REGS_HELD)
DECL|macro|ZS_TX_STOPPED
mdefine_line|#define ZS_TX_STOPPED(UP)&t;((UP)-&gt;flags &amp; IP22ZILOG_FLAG_TX_STOPPED)
DECL|macro|ZS_TX_ACTIVE
mdefine_line|#define ZS_TX_ACTIVE(UP)&t;((UP)-&gt;flags &amp; IP22ZILOG_FLAG_TX_ACTIVE)
multiline_comment|/* Reading and writing Zilog8530 registers.  The delays are to make this&n; * driver work on the IP22 which needs a settling delay after each chip&n; * register access, other machines handle this in hardware via auxiliary&n; * flip-flops which implement the settle time we do in software.&n; *&n; * The port lock must be held and local IRQs must be disabled&n; * when {read,write}_zsreg is invoked.&n; */
DECL|function|read_zsreg
r_static
r_int
r_char
id|read_zsreg
c_func
(paren
r_struct
id|zilog_channel
op_star
id|channel
comma
r_int
r_char
id|reg
)paren
(brace
r_int
r_char
id|retval
suffix:semicolon
id|writeb
c_func
(paren
id|reg
comma
op_amp
id|channel-&gt;control
)paren
suffix:semicolon
id|ZSDELAY
c_func
(paren
)paren
suffix:semicolon
id|retval
op_assign
id|readb
c_func
(paren
op_amp
id|channel-&gt;control
)paren
suffix:semicolon
id|ZSDELAY
c_func
(paren
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
DECL|function|write_zsreg
r_static
r_void
id|write_zsreg
c_func
(paren
r_struct
id|zilog_channel
op_star
id|channel
comma
r_int
r_char
id|reg
comma
r_int
r_char
id|value
)paren
(brace
id|writeb
c_func
(paren
id|reg
comma
op_amp
id|channel-&gt;control
)paren
suffix:semicolon
id|ZSDELAY
c_func
(paren
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|value
comma
op_amp
id|channel-&gt;control
)paren
suffix:semicolon
id|ZSDELAY
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|ip22zilog_clear_fifo
r_static
r_void
id|ip22zilog_clear_fifo
c_func
(paren
r_struct
id|zilog_channel
op_star
id|channel
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
r_char
id|regval
suffix:semicolon
id|regval
op_assign
id|readb
c_func
(paren
op_amp
id|channel-&gt;control
)paren
suffix:semicolon
id|ZSDELAY
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|regval
op_amp
id|Rx_CH_AV
)paren
r_break
suffix:semicolon
id|regval
op_assign
id|read_zsreg
c_func
(paren
id|channel
comma
id|R1
)paren
suffix:semicolon
id|readb
c_func
(paren
op_amp
id|channel-&gt;data
)paren
suffix:semicolon
id|ZSDELAY
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|regval
op_amp
(paren
id|PAR_ERR
op_or
id|Rx_OVR
op_or
id|CRC_ERR
)paren
)paren
(brace
id|writeb
c_func
(paren
id|ERR_RES
comma
op_amp
id|channel-&gt;control
)paren
suffix:semicolon
id|ZSDELAY
c_func
(paren
)paren
suffix:semicolon
id|ZS_WSYNC
c_func
(paren
id|channel
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* This function must only be called when the TX is not busy.  The UART&n; * port lock must be held and local interrupts disabled.&n; */
DECL|function|__load_zsregs
r_static
r_void
id|__load_zsregs
c_func
(paren
r_struct
id|zilog_channel
op_star
id|channel
comma
r_int
r_char
op_star
id|regs
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/* Let pending transmits finish.  */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|1000
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
r_char
id|stat
op_assign
id|read_zsreg
c_func
(paren
id|channel
comma
id|R1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|stat
op_amp
id|ALL_SNT
)paren
r_break
suffix:semicolon
id|udelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
)brace
id|writeb
c_func
(paren
id|ERR_RES
comma
op_amp
id|channel-&gt;control
)paren
suffix:semicolon
id|ZSDELAY
c_func
(paren
)paren
suffix:semicolon
id|ZS_WSYNC
c_func
(paren
id|channel
)paren
suffix:semicolon
id|ip22zilog_clear_fifo
c_func
(paren
id|channel
)paren
suffix:semicolon
multiline_comment|/* Disable all interrupts.  */
id|write_zsreg
c_func
(paren
id|channel
comma
id|R1
comma
id|regs
(braket
id|R1
)braket
op_amp
op_complement
(paren
id|RxINT_MASK
op_or
id|TxINT_ENAB
op_or
id|EXT_INT_ENAB
)paren
)paren
suffix:semicolon
multiline_comment|/* Set parity, sync config, stop bits, and clock divisor.  */
id|write_zsreg
c_func
(paren
id|channel
comma
id|R4
comma
id|regs
(braket
id|R4
)braket
)paren
suffix:semicolon
multiline_comment|/* Set misc. TX/RX control bits.  */
id|write_zsreg
c_func
(paren
id|channel
comma
id|R10
comma
id|regs
(braket
id|R10
)braket
)paren
suffix:semicolon
multiline_comment|/* Set TX/RX controls sans the enable bits.  */
id|write_zsreg
c_func
(paren
id|channel
comma
id|R3
comma
id|regs
(braket
id|R3
)braket
op_amp
op_complement
id|RxENAB
)paren
suffix:semicolon
id|write_zsreg
c_func
(paren
id|channel
comma
id|R5
comma
id|regs
(braket
id|R5
)braket
op_amp
op_complement
id|TxENAB
)paren
suffix:semicolon
multiline_comment|/* Synchronous mode config.  */
id|write_zsreg
c_func
(paren
id|channel
comma
id|R6
comma
id|regs
(braket
id|R6
)braket
)paren
suffix:semicolon
id|write_zsreg
c_func
(paren
id|channel
comma
id|R7
comma
id|regs
(braket
id|R7
)braket
)paren
suffix:semicolon
multiline_comment|/* Don&squot;t mess with the interrupt vector (R2, unused by us) and&n;&t; * master interrupt control (R9).  We make sure this is setup&n;&t; * properly at probe time then never touch it again.&n;&t; */
multiline_comment|/* Disable baud generator.  */
id|write_zsreg
c_func
(paren
id|channel
comma
id|R14
comma
id|regs
(braket
id|R14
)braket
op_amp
op_complement
id|BRENAB
)paren
suffix:semicolon
multiline_comment|/* Clock mode control.  */
id|write_zsreg
c_func
(paren
id|channel
comma
id|R11
comma
id|regs
(braket
id|R11
)braket
)paren
suffix:semicolon
multiline_comment|/* Lower and upper byte of baud rate generator divisor.  */
id|write_zsreg
c_func
(paren
id|channel
comma
id|R12
comma
id|regs
(braket
id|R12
)braket
)paren
suffix:semicolon
id|write_zsreg
c_func
(paren
id|channel
comma
id|R13
comma
id|regs
(braket
id|R13
)braket
)paren
suffix:semicolon
multiline_comment|/* Now rewrite R14, with BRENAB (if set).  */
id|write_zsreg
c_func
(paren
id|channel
comma
id|R14
comma
id|regs
(braket
id|R14
)braket
)paren
suffix:semicolon
multiline_comment|/* External status interrupt control.  */
id|write_zsreg
c_func
(paren
id|channel
comma
id|R15
comma
id|regs
(braket
id|R15
)braket
)paren
suffix:semicolon
multiline_comment|/* Reset external status interrupts.  */
id|write_zsreg
c_func
(paren
id|channel
comma
id|R0
comma
id|RES_EXT_INT
)paren
suffix:semicolon
id|write_zsreg
c_func
(paren
id|channel
comma
id|R0
comma
id|RES_EXT_INT
)paren
suffix:semicolon
multiline_comment|/* Rewrite R3/R5, this time without enables masked.  */
id|write_zsreg
c_func
(paren
id|channel
comma
id|R3
comma
id|regs
(braket
id|R3
)braket
)paren
suffix:semicolon
id|write_zsreg
c_func
(paren
id|channel
comma
id|R5
comma
id|regs
(braket
id|R5
)braket
)paren
suffix:semicolon
multiline_comment|/* Rewrite R1, this time without IRQ enabled masked.  */
id|write_zsreg
c_func
(paren
id|channel
comma
id|R1
comma
id|regs
(braket
id|R1
)braket
)paren
suffix:semicolon
)brace
multiline_comment|/* Reprogram the Zilog channel HW registers with the copies found in the&n; * software state struct.  If the transmitter is busy, we defer this update&n; * until the next TX complete interrupt.  Else, we do it right now.&n; *&n; * The UART port lock must be held and local interrupts disabled.&n; */
DECL|function|ip22zilog_maybe_update_regs
r_static
r_void
id|ip22zilog_maybe_update_regs
c_func
(paren
r_struct
id|uart_ip22zilog_port
op_star
id|up
comma
r_struct
id|zilog_channel
op_star
id|channel
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ZS_REGS_HELD
c_func
(paren
id|up
)paren
)paren
(brace
r_if
c_cond
(paren
id|ZS_TX_ACTIVE
c_func
(paren
id|up
)paren
)paren
(brace
id|up-&gt;flags
op_or_assign
id|IP22ZILOG_FLAG_REGS_HELD
suffix:semicolon
)brace
r_else
(brace
id|__load_zsregs
c_func
(paren
id|channel
comma
id|up-&gt;curregs
)paren
suffix:semicolon
)brace
)brace
)brace
DECL|function|ip22zilog_receive_chars
r_static
r_void
id|ip22zilog_receive_chars
c_func
(paren
r_struct
id|uart_ip22zilog_port
op_star
id|up
comma
r_struct
id|zilog_channel
op_star
id|channel
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|tty_struct
op_star
id|tty
op_assign
id|up-&gt;port.info-&gt;tty
suffix:semicolon
multiline_comment|/* XXX info==NULL? */
r_while
c_loop
(paren
l_int|1
)paren
(brace
r_int
r_char
id|ch
comma
id|r1
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|tty-&gt;flip.count
op_ge
id|TTY_FLIPBUF_SIZE
)paren
)paren
(brace
id|tty-&gt;flip.work
dot
id|func
c_func
(paren
(paren
r_void
op_star
)paren
id|tty
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tty-&gt;flip.count
op_ge
id|TTY_FLIPBUF_SIZE
)paren
r_return
suffix:semicolon
multiline_comment|/* XXX Ignores SysRq when we need it most. Fix. */
)brace
id|r1
op_assign
id|read_zsreg
c_func
(paren
id|channel
comma
id|R1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r1
op_amp
(paren
id|PAR_ERR
op_or
id|Rx_OVR
op_or
id|CRC_ERR
)paren
)paren
(brace
id|writeb
c_func
(paren
id|ERR_RES
comma
op_amp
id|channel-&gt;control
)paren
suffix:semicolon
id|ZSDELAY
c_func
(paren
)paren
suffix:semicolon
id|ZS_WSYNC
c_func
(paren
id|channel
)paren
suffix:semicolon
)brace
id|ch
op_assign
id|readb
c_func
(paren
op_amp
id|channel-&gt;control
)paren
suffix:semicolon
id|ZSDELAY
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* This funny hack depends upon BRK_ABRT not interfering&n;&t;&t; * with the other bits we care about in R1.&n;&t;&t; */
r_if
c_cond
(paren
id|ch
op_amp
id|BRK_ABRT
)paren
id|r1
op_or_assign
id|BRK_ABRT
suffix:semicolon
id|ch
op_assign
id|readb
c_func
(paren
op_amp
id|channel-&gt;data
)paren
suffix:semicolon
id|ZSDELAY
c_func
(paren
)paren
suffix:semicolon
id|ch
op_and_assign
id|up-&gt;parity_mask
suffix:semicolon
r_if
c_cond
(paren
id|ZS_IS_CONS
c_func
(paren
id|up
)paren
op_logical_and
(paren
id|r1
op_amp
id|BRK_ABRT
)paren
)paren
(brace
multiline_comment|/* Wait for BREAK to deassert to avoid potentially&n;&t;&t;&t; * confusing the PROM.&n;&t;&t;&t; */
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|ch
op_assign
id|readb
c_func
(paren
op_amp
id|channel-&gt;control
)paren
suffix:semicolon
id|ZSDELAY
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|ch
op_amp
id|BRK_ABRT
)paren
)paren
r_break
suffix:semicolon
)brace
id|ip22_do_break
c_func
(paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* A real serial line, record the character and status.  */
op_star
id|tty-&gt;flip.char_buf_ptr
op_assign
id|ch
suffix:semicolon
op_star
id|tty-&gt;flip.flag_buf_ptr
op_assign
id|TTY_NORMAL
suffix:semicolon
id|up-&gt;port.icount.rx
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|r1
op_amp
(paren
id|BRK_ABRT
op_or
id|PAR_ERR
op_or
id|Rx_OVR
op_or
id|CRC_ERR
)paren
)paren
(brace
r_if
c_cond
(paren
id|r1
op_amp
id|BRK_ABRT
)paren
(brace
id|r1
op_and_assign
op_complement
(paren
id|PAR_ERR
op_or
id|CRC_ERR
)paren
suffix:semicolon
id|up-&gt;port.icount.brk
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|uart_handle_break
c_func
(paren
op_amp
id|up-&gt;port
)paren
)paren
r_goto
id|next_char
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|r1
op_amp
id|PAR_ERR
)paren
id|up-&gt;port.icount.parity
op_increment
suffix:semicolon
r_else
r_if
c_cond
(paren
id|r1
op_amp
id|CRC_ERR
)paren
id|up-&gt;port.icount.frame
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|r1
op_amp
id|Rx_OVR
)paren
id|up-&gt;port.icount.overrun
op_increment
suffix:semicolon
id|r1
op_and_assign
id|up-&gt;port.read_status_mask
suffix:semicolon
r_if
c_cond
(paren
id|r1
op_amp
id|BRK_ABRT
)paren
op_star
id|tty-&gt;flip.flag_buf_ptr
op_assign
id|TTY_BREAK
suffix:semicolon
r_else
r_if
c_cond
(paren
id|r1
op_amp
id|PAR_ERR
)paren
op_star
id|tty-&gt;flip.flag_buf_ptr
op_assign
id|TTY_PARITY
suffix:semicolon
r_else
r_if
c_cond
(paren
id|r1
op_amp
id|CRC_ERR
)paren
op_star
id|tty-&gt;flip.flag_buf_ptr
op_assign
id|TTY_FRAME
suffix:semicolon
)brace
r_if
c_cond
(paren
id|uart_handle_sysrq_char
c_func
(paren
op_amp
id|up-&gt;port
comma
id|ch
comma
id|regs
)paren
)paren
r_goto
id|next_char
suffix:semicolon
r_if
c_cond
(paren
id|up-&gt;port.ignore_status_mask
op_eq
l_int|0xff
op_logical_or
(paren
id|r1
op_amp
id|up-&gt;port.ignore_status_mask
)paren
op_eq
l_int|0
)paren
(brace
id|tty-&gt;flip.flag_buf_ptr
op_increment
suffix:semicolon
id|tty-&gt;flip.char_buf_ptr
op_increment
suffix:semicolon
id|tty-&gt;flip.count
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|r1
op_amp
id|Rx_OVR
)paren
op_logical_and
id|tty-&gt;flip.count
OL
id|TTY_FLIPBUF_SIZE
)paren
(brace
op_star
id|tty-&gt;flip.flag_buf_ptr
op_assign
id|TTY_OVERRUN
suffix:semicolon
id|tty-&gt;flip.flag_buf_ptr
op_increment
suffix:semicolon
id|tty-&gt;flip.char_buf_ptr
op_increment
suffix:semicolon
id|tty-&gt;flip.count
op_increment
suffix:semicolon
)brace
id|next_char
suffix:colon
id|ch
op_assign
id|readb
c_func
(paren
op_amp
id|channel-&gt;control
)paren
suffix:semicolon
id|ZSDELAY
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|ch
op_amp
id|Rx_CH_AV
)paren
)paren
r_break
suffix:semicolon
)brace
id|tty_flip_buffer_push
c_func
(paren
id|tty
)paren
suffix:semicolon
)brace
DECL|function|ip22zilog_status_handle
r_static
r_void
id|ip22zilog_status_handle
c_func
(paren
r_struct
id|uart_ip22zilog_port
op_star
id|up
comma
r_struct
id|zilog_channel
op_star
id|channel
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
r_char
id|status
suffix:semicolon
id|status
op_assign
id|readb
c_func
(paren
op_amp
id|channel-&gt;control
)paren
suffix:semicolon
id|ZSDELAY
c_func
(paren
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|RES_EXT_INT
comma
op_amp
id|channel-&gt;control
)paren
suffix:semicolon
id|ZSDELAY
c_func
(paren
)paren
suffix:semicolon
id|ZS_WSYNC
c_func
(paren
id|channel
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ZS_WANTS_MODEM_STATUS
c_func
(paren
id|up
)paren
)paren
(brace
r_if
c_cond
(paren
id|status
op_amp
id|SYNC
)paren
id|up-&gt;port.icount.dsr
op_increment
suffix:semicolon
multiline_comment|/* The Zilog just gives us an interrupt when DCD/CTS/etc. change.&n;&t;&t; * But it does not tell us which bit has changed, we have to keep&n;&t;&t; * track of this ourselves.&n;&t;&t; */
r_if
c_cond
(paren
(paren
id|status
op_amp
id|DCD
)paren
op_xor
id|up-&gt;prev_status
)paren
id|uart_handle_dcd_change
c_func
(paren
op_amp
id|up-&gt;port
comma
(paren
id|status
op_amp
id|DCD
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_amp
id|CTS
)paren
op_xor
id|up-&gt;prev_status
)paren
id|uart_handle_cts_change
c_func
(paren
op_amp
id|up-&gt;port
comma
(paren
id|status
op_amp
id|CTS
)paren
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|up-&gt;port.info-&gt;delta_msr_wait
)paren
suffix:semicolon
)brace
id|up-&gt;prev_status
op_assign
id|status
suffix:semicolon
)brace
DECL|function|ip22zilog_transmit_chars
r_static
r_void
id|ip22zilog_transmit_chars
c_func
(paren
r_struct
id|uart_ip22zilog_port
op_star
id|up
comma
r_struct
id|zilog_channel
op_star
id|channel
)paren
(brace
r_struct
id|circ_buf
op_star
id|xmit
suffix:semicolon
r_if
c_cond
(paren
id|ZS_IS_CONS
c_func
(paren
id|up
)paren
)paren
(brace
r_int
r_char
id|status
op_assign
id|readb
c_func
(paren
op_amp
id|channel-&gt;control
)paren
suffix:semicolon
id|ZSDELAY
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* TX still busy?  Just wait for the next TX done interrupt.&n;&t;&t; *&n;&t;&t; * It can occur because of how we do serial console writes.  It would&n;&t;&t; * be nice to transmit console writes just like we normally would for&n;&t;&t; * a TTY line. (ie. buffered and TX interrupt driven).  That is not&n;&t;&t; * easy because console writes cannot sleep.  One solution might be&n;&t;&t; * to poll on enough port-&gt;xmit space becomming free.  -DaveM&n;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_amp
id|Tx_BUF_EMP
)paren
)paren
r_return
suffix:semicolon
)brace
id|up-&gt;flags
op_and_assign
op_complement
id|IP22ZILOG_FLAG_TX_ACTIVE
suffix:semicolon
r_if
c_cond
(paren
id|ZS_REGS_HELD
c_func
(paren
id|up
)paren
)paren
(brace
id|__load_zsregs
c_func
(paren
id|channel
comma
id|up-&gt;curregs
)paren
suffix:semicolon
id|up-&gt;flags
op_and_assign
op_complement
id|IP22ZILOG_FLAG_REGS_HELD
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ZS_TX_STOPPED
c_func
(paren
id|up
)paren
)paren
(brace
id|up-&gt;flags
op_and_assign
op_complement
id|IP22ZILOG_FLAG_TX_STOPPED
suffix:semicolon
r_goto
id|ack_tx_int
suffix:semicolon
)brace
r_if
c_cond
(paren
id|up-&gt;port.x_char
)paren
(brace
id|up-&gt;flags
op_or_assign
id|IP22ZILOG_FLAG_TX_ACTIVE
suffix:semicolon
id|writeb
c_func
(paren
id|up-&gt;port.x_char
comma
op_amp
id|channel-&gt;data
)paren
suffix:semicolon
id|ZSDELAY
c_func
(paren
)paren
suffix:semicolon
id|ZS_WSYNC
c_func
(paren
id|channel
)paren
suffix:semicolon
id|up-&gt;port.icount.tx
op_increment
suffix:semicolon
id|up-&gt;port.x_char
op_assign
l_int|0
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|up-&gt;port.info
op_eq
l_int|NULL
)paren
r_goto
id|ack_tx_int
suffix:semicolon
id|xmit
op_assign
op_amp
id|up-&gt;port.info-&gt;xmit
suffix:semicolon
r_if
c_cond
(paren
id|uart_circ_empty
c_func
(paren
id|xmit
)paren
)paren
(brace
id|uart_write_wakeup
c_func
(paren
op_amp
id|up-&gt;port
)paren
suffix:semicolon
r_goto
id|ack_tx_int
suffix:semicolon
)brace
r_if
c_cond
(paren
id|uart_tx_stopped
c_func
(paren
op_amp
id|up-&gt;port
)paren
)paren
r_goto
id|ack_tx_int
suffix:semicolon
id|up-&gt;flags
op_or_assign
id|IP22ZILOG_FLAG_TX_ACTIVE
suffix:semicolon
id|writeb
c_func
(paren
id|xmit-&gt;buf
(braket
id|xmit-&gt;tail
)braket
comma
op_amp
id|channel-&gt;data
)paren
suffix:semicolon
id|ZSDELAY
c_func
(paren
)paren
suffix:semicolon
id|ZS_WSYNC
c_func
(paren
id|channel
)paren
suffix:semicolon
id|xmit-&gt;tail
op_assign
(paren
id|xmit-&gt;tail
op_plus
l_int|1
)paren
op_amp
(paren
id|UART_XMIT_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
id|up-&gt;port.icount.tx
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|uart_circ_chars_pending
c_func
(paren
id|xmit
)paren
OL
id|WAKEUP_CHARS
)paren
id|uart_write_wakeup
c_func
(paren
op_amp
id|up-&gt;port
)paren
suffix:semicolon
r_return
suffix:semicolon
id|ack_tx_int
suffix:colon
id|writeb
c_func
(paren
id|RES_Tx_P
comma
op_amp
id|channel-&gt;control
)paren
suffix:semicolon
id|ZSDELAY
c_func
(paren
)paren
suffix:semicolon
id|ZS_WSYNC
c_func
(paren
id|channel
)paren
suffix:semicolon
)brace
DECL|function|ip22zilog_interrupt
r_static
id|irqreturn_t
id|ip22zilog_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|uart_ip22zilog_port
op_star
id|up
op_assign
id|dev_id
suffix:semicolon
r_while
c_loop
(paren
id|up
)paren
(brace
r_struct
id|zilog_channel
op_star
id|channel
op_assign
id|ZILOG_CHANNEL_FROM_PORT
c_func
(paren
op_amp
id|up-&gt;port
)paren
suffix:semicolon
r_int
r_char
id|r3
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|up-&gt;port.lock
)paren
suffix:semicolon
id|r3
op_assign
id|read_zsreg
c_func
(paren
id|channel
comma
id|R3
)paren
suffix:semicolon
multiline_comment|/* Channel A */
r_if
c_cond
(paren
id|r3
op_amp
(paren
id|CHAEXT
op_or
id|CHATxIP
op_or
id|CHARxIP
)paren
)paren
(brace
id|writeb
c_func
(paren
id|RES_H_IUS
comma
op_amp
id|channel-&gt;control
)paren
suffix:semicolon
id|ZSDELAY
c_func
(paren
)paren
suffix:semicolon
id|ZS_WSYNC
c_func
(paren
id|channel
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r3
op_amp
id|CHARxIP
)paren
id|ip22zilog_receive_chars
c_func
(paren
id|up
comma
id|channel
comma
id|regs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r3
op_amp
id|CHAEXT
)paren
id|ip22zilog_status_handle
c_func
(paren
id|up
comma
id|channel
comma
id|regs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r3
op_amp
id|CHATxIP
)paren
id|ip22zilog_transmit_chars
c_func
(paren
id|up
comma
id|channel
)paren
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|up-&gt;port.lock
)paren
suffix:semicolon
multiline_comment|/* Channel B */
id|up
op_assign
id|up-&gt;next
suffix:semicolon
id|channel
op_assign
id|ZILOG_CHANNEL_FROM_PORT
c_func
(paren
op_amp
id|up-&gt;port
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|up-&gt;port.lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r3
op_amp
(paren
id|CHBEXT
op_or
id|CHBTxIP
op_or
id|CHBRxIP
)paren
)paren
(brace
id|writeb
c_func
(paren
id|RES_H_IUS
comma
op_amp
id|channel-&gt;control
)paren
suffix:semicolon
id|ZSDELAY
c_func
(paren
)paren
suffix:semicolon
id|ZS_WSYNC
c_func
(paren
id|channel
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r3
op_amp
id|CHBRxIP
)paren
id|ip22zilog_receive_chars
c_func
(paren
id|up
comma
id|channel
comma
id|regs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r3
op_amp
id|CHBEXT
)paren
id|ip22zilog_status_handle
c_func
(paren
id|up
comma
id|channel
comma
id|regs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r3
op_amp
id|CHBTxIP
)paren
id|ip22zilog_transmit_chars
c_func
(paren
id|up
comma
id|channel
)paren
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|up-&gt;port.lock
)paren
suffix:semicolon
id|up
op_assign
id|up-&gt;next
suffix:semicolon
)brace
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
multiline_comment|/* A convenient way to quickly get R0 status.  The caller must _not_ hold the&n; * port lock, it is acquired here.&n; */
DECL|function|ip22zilog_read_channel_status
r_static
id|__inline__
r_int
r_char
id|ip22zilog_read_channel_status
c_func
(paren
r_struct
id|uart_port
op_star
id|port
)paren
(brace
r_struct
id|zilog_channel
op_star
id|channel
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
r_char
id|status
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|port-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|channel
op_assign
id|ZILOG_CHANNEL_FROM_PORT
c_func
(paren
id|port
)paren
suffix:semicolon
id|status
op_assign
id|readb
c_func
(paren
op_amp
id|channel-&gt;control
)paren
suffix:semicolon
id|ZSDELAY
c_func
(paren
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|port-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/* The port lock is not held.  */
DECL|function|ip22zilog_tx_empty
r_static
r_int
r_int
id|ip22zilog_tx_empty
c_func
(paren
r_struct
id|uart_port
op_star
id|port
)paren
(brace
r_int
r_char
id|status
suffix:semicolon
r_int
r_int
id|ret
suffix:semicolon
id|status
op_assign
id|ip22zilog_read_channel_status
c_func
(paren
id|port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|Tx_BUF_EMP
)paren
id|ret
op_assign
id|TIOCSER_TEMT
suffix:semicolon
r_else
id|ret
op_assign
l_int|0
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* The port lock is not held.  */
DECL|function|ip22zilog_get_mctrl
r_static
r_int
r_int
id|ip22zilog_get_mctrl
c_func
(paren
r_struct
id|uart_port
op_star
id|port
)paren
(brace
r_int
r_char
id|status
suffix:semicolon
r_int
r_int
id|ret
suffix:semicolon
id|status
op_assign
id|ip22zilog_read_channel_status
c_func
(paren
id|port
)paren
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|DCD
)paren
id|ret
op_or_assign
id|TIOCM_CAR
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|SYNC
)paren
id|ret
op_or_assign
id|TIOCM_DSR
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|CTS
)paren
id|ret
op_or_assign
id|TIOCM_CTS
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* The port lock is held and interrupts are disabled.  */
DECL|function|ip22zilog_set_mctrl
r_static
r_void
id|ip22zilog_set_mctrl
c_func
(paren
r_struct
id|uart_port
op_star
id|port
comma
r_int
r_int
id|mctrl
)paren
(brace
r_struct
id|uart_ip22zilog_port
op_star
id|up
op_assign
(paren
r_struct
id|uart_ip22zilog_port
op_star
)paren
id|port
suffix:semicolon
r_struct
id|zilog_channel
op_star
id|channel
op_assign
id|ZILOG_CHANNEL_FROM_PORT
c_func
(paren
id|port
)paren
suffix:semicolon
r_int
r_char
id|set_bits
comma
id|clear_bits
suffix:semicolon
id|set_bits
op_assign
id|clear_bits
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|mctrl
op_amp
id|TIOCM_RTS
)paren
id|set_bits
op_or_assign
id|RTS
suffix:semicolon
r_else
id|clear_bits
op_or_assign
id|RTS
suffix:semicolon
r_if
c_cond
(paren
id|mctrl
op_amp
id|TIOCM_DTR
)paren
id|set_bits
op_or_assign
id|DTR
suffix:semicolon
r_else
id|clear_bits
op_or_assign
id|DTR
suffix:semicolon
multiline_comment|/* NOTE: Not subject to &squot;transmitter active&squot; rule.  */
id|up-&gt;curregs
(braket
id|R5
)braket
op_or_assign
id|set_bits
suffix:semicolon
id|up-&gt;curregs
(braket
id|R5
)braket
op_and_assign
op_complement
id|clear_bits
suffix:semicolon
id|write_zsreg
c_func
(paren
id|channel
comma
id|R5
comma
id|up-&gt;curregs
(braket
id|R5
)braket
)paren
suffix:semicolon
)brace
multiline_comment|/* The port lock is held and interrupts are disabled.  */
DECL|function|ip22zilog_stop_tx
r_static
r_void
id|ip22zilog_stop_tx
c_func
(paren
r_struct
id|uart_port
op_star
id|port
comma
r_int
r_int
id|tty_stop
)paren
(brace
r_struct
id|uart_ip22zilog_port
op_star
id|up
op_assign
(paren
r_struct
id|uart_ip22zilog_port
op_star
)paren
id|port
suffix:semicolon
id|up-&gt;flags
op_or_assign
id|IP22ZILOG_FLAG_TX_STOPPED
suffix:semicolon
)brace
multiline_comment|/* The port lock is held and interrupts are disabled.  */
DECL|function|ip22zilog_start_tx
r_static
r_void
id|ip22zilog_start_tx
c_func
(paren
r_struct
id|uart_port
op_star
id|port
comma
r_int
r_int
id|tty_start
)paren
(brace
r_struct
id|uart_ip22zilog_port
op_star
id|up
op_assign
(paren
r_struct
id|uart_ip22zilog_port
op_star
)paren
id|port
suffix:semicolon
r_struct
id|zilog_channel
op_star
id|channel
op_assign
id|ZILOG_CHANNEL_FROM_PORT
c_func
(paren
id|port
)paren
suffix:semicolon
r_int
r_char
id|status
suffix:semicolon
id|up-&gt;flags
op_or_assign
id|IP22ZILOG_FLAG_TX_ACTIVE
suffix:semicolon
id|up-&gt;flags
op_and_assign
op_complement
id|IP22ZILOG_FLAG_TX_STOPPED
suffix:semicolon
id|status
op_assign
id|readb
c_func
(paren
op_amp
id|channel-&gt;control
)paren
suffix:semicolon
id|ZSDELAY
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* TX busy?  Just wait for the TX done interrupt.  */
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_amp
id|Tx_BUF_EMP
)paren
)paren
r_return
suffix:semicolon
multiline_comment|/* Send the first character to jump-start the TX done&n;&t; * IRQ sending engine.&n;&t; */
r_if
c_cond
(paren
id|port-&gt;x_char
)paren
(brace
id|writeb
c_func
(paren
id|port-&gt;x_char
comma
op_amp
id|channel-&gt;data
)paren
suffix:semicolon
id|ZSDELAY
c_func
(paren
)paren
suffix:semicolon
id|ZS_WSYNC
c_func
(paren
id|channel
)paren
suffix:semicolon
id|port-&gt;icount.tx
op_increment
suffix:semicolon
id|port-&gt;x_char
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
r_struct
id|circ_buf
op_star
id|xmit
op_assign
op_amp
id|port-&gt;info-&gt;xmit
suffix:semicolon
id|writeb
c_func
(paren
id|xmit-&gt;buf
(braket
id|xmit-&gt;tail
)braket
comma
op_amp
id|channel-&gt;data
)paren
suffix:semicolon
id|ZSDELAY
c_func
(paren
)paren
suffix:semicolon
id|ZS_WSYNC
c_func
(paren
id|channel
)paren
suffix:semicolon
id|xmit-&gt;tail
op_assign
(paren
id|xmit-&gt;tail
op_plus
l_int|1
)paren
op_amp
(paren
id|UART_XMIT_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
id|port-&gt;icount.tx
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|uart_circ_chars_pending
c_func
(paren
id|xmit
)paren
OL
id|WAKEUP_CHARS
)paren
id|uart_write_wakeup
c_func
(paren
op_amp
id|up-&gt;port
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* The port lock is held and interrupts are disabled.  */
DECL|function|ip22zilog_stop_rx
r_static
r_void
id|ip22zilog_stop_rx
c_func
(paren
r_struct
id|uart_port
op_star
id|port
)paren
(brace
r_struct
id|uart_ip22zilog_port
op_star
id|up
op_assign
id|UART_ZILOG
c_func
(paren
id|port
)paren
suffix:semicolon
r_struct
id|zilog_channel
op_star
id|channel
suffix:semicolon
r_if
c_cond
(paren
id|ZS_IS_CONS
c_func
(paren
id|up
)paren
)paren
r_return
suffix:semicolon
id|channel
op_assign
id|ZILOG_CHANNEL_FROM_PORT
c_func
(paren
id|port
)paren
suffix:semicolon
multiline_comment|/* Disable all RX interrupts.  */
id|up-&gt;curregs
(braket
id|R1
)braket
op_and_assign
op_complement
id|RxINT_MASK
suffix:semicolon
id|ip22zilog_maybe_update_regs
c_func
(paren
id|up
comma
id|channel
)paren
suffix:semicolon
)brace
multiline_comment|/* The port lock is held.  */
DECL|function|ip22zilog_enable_ms
r_static
r_void
id|ip22zilog_enable_ms
c_func
(paren
r_struct
id|uart_port
op_star
id|port
)paren
(brace
r_struct
id|uart_ip22zilog_port
op_star
id|up
op_assign
(paren
r_struct
id|uart_ip22zilog_port
op_star
)paren
id|port
suffix:semicolon
r_struct
id|zilog_channel
op_star
id|channel
op_assign
id|ZILOG_CHANNEL_FROM_PORT
c_func
(paren
id|port
)paren
suffix:semicolon
r_int
r_char
id|new_reg
suffix:semicolon
id|new_reg
op_assign
id|up-&gt;curregs
(braket
id|R15
)braket
op_or
(paren
id|DCDIE
op_or
id|SYNCIE
op_or
id|CTSIE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|new_reg
op_ne
id|up-&gt;curregs
(braket
id|R15
)braket
)paren
(brace
id|up-&gt;curregs
(braket
id|R15
)braket
op_assign
id|new_reg
suffix:semicolon
multiline_comment|/* NOTE: Not subject to &squot;transmitter active&squot; rule.  */
id|write_zsreg
c_func
(paren
id|channel
comma
id|R15
comma
id|up-&gt;curregs
(braket
id|R15
)braket
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* The port lock is not held.  */
DECL|function|ip22zilog_break_ctl
r_static
r_void
id|ip22zilog_break_ctl
c_func
(paren
r_struct
id|uart_port
op_star
id|port
comma
r_int
id|break_state
)paren
(brace
r_struct
id|uart_ip22zilog_port
op_star
id|up
op_assign
(paren
r_struct
id|uart_ip22zilog_port
op_star
)paren
id|port
suffix:semicolon
r_struct
id|zilog_channel
op_star
id|channel
op_assign
id|ZILOG_CHANNEL_FROM_PORT
c_func
(paren
id|port
)paren
suffix:semicolon
r_int
r_char
id|set_bits
comma
id|clear_bits
comma
id|new_reg
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|set_bits
op_assign
id|clear_bits
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|break_state
)paren
id|set_bits
op_or_assign
id|SND_BRK
suffix:semicolon
r_else
id|clear_bits
op_or_assign
id|SND_BRK
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|port-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|new_reg
op_assign
(paren
id|up-&gt;curregs
(braket
id|R5
)braket
op_or
id|set_bits
)paren
op_amp
op_complement
id|clear_bits
suffix:semicolon
r_if
c_cond
(paren
id|new_reg
op_ne
id|up-&gt;curregs
(braket
id|R5
)braket
)paren
(brace
id|up-&gt;curregs
(braket
id|R5
)braket
op_assign
id|new_reg
suffix:semicolon
multiline_comment|/* NOTE: Not subject to &squot;transmitter active&squot; rule.  */
id|write_zsreg
c_func
(paren
id|channel
comma
id|R5
comma
id|up-&gt;curregs
(braket
id|R5
)braket
)paren
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|port-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|__ip22zilog_startup
r_static
r_void
id|__ip22zilog_startup
c_func
(paren
r_struct
id|uart_ip22zilog_port
op_star
id|up
)paren
(brace
r_struct
id|zilog_channel
op_star
id|channel
suffix:semicolon
id|channel
op_assign
id|ZILOG_CHANNEL_FROM_PORT
c_func
(paren
op_amp
id|up-&gt;port
)paren
suffix:semicolon
id|up-&gt;prev_status
op_assign
id|readb
c_func
(paren
op_amp
id|channel-&gt;control
)paren
suffix:semicolon
multiline_comment|/* Enable receiver and transmitter.  */
id|up-&gt;curregs
(braket
id|R3
)braket
op_or_assign
id|RxENAB
suffix:semicolon
id|up-&gt;curregs
(braket
id|R5
)braket
op_or_assign
id|TxENAB
suffix:semicolon
id|up-&gt;curregs
(braket
id|R1
)braket
op_or_assign
id|EXT_INT_ENAB
op_or
id|INT_ALL_Rx
op_or
id|TxINT_ENAB
suffix:semicolon
id|ip22zilog_maybe_update_regs
c_func
(paren
id|up
comma
id|channel
)paren
suffix:semicolon
)brace
DECL|function|ip22zilog_startup
r_static
r_int
id|ip22zilog_startup
c_func
(paren
r_struct
id|uart_port
op_star
id|port
)paren
(brace
r_struct
id|uart_ip22zilog_port
op_star
id|up
op_assign
id|UART_ZILOG
c_func
(paren
id|port
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|ZS_IS_CONS
c_func
(paren
id|up
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|port-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|__ip22zilog_startup
c_func
(paren
id|up
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|port-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * The test for ZS_IS_CONS is explained by the following e-mail:&n; *****&n; * From: Russell King &lt;rmk@arm.linux.org.uk&gt;&n; * Date: Sun, 8 Dec 2002 10:18:38 +0000&n; *&n; * On Sun, Dec 08, 2002 at 02:43:36AM -0500, Pete Zaitcev wrote:&n; * &gt; I boot my 2.5 boxes using &quot;console=ttyS0,9600&quot; argument,&n; * &gt; and I noticed that something is not right with reference&n; * &gt; counting in this case. It seems that when the console&n; * &gt; is open by kernel initially, this is not accounted&n; * &gt; as an open, and uart_startup is not called.&n; *&n; * That is correct.  We are unable to call uart_startup when the serial&n; * console is initialised because it may need to allocate memory (as&n; * request_irq does) and the memory allocators may not have been&n; * initialised.&n; *&n; * 1. initialise the port into a state where it can send characters in the&n; *    console write method.&n; *&n; * 2. don&squot;t do the actual hardware shutdown in your shutdown() method (but&n; *    do the normal software shutdown - ie, free irqs etc)&n; *****&n; */
DECL|function|ip22zilog_shutdown
r_static
r_void
id|ip22zilog_shutdown
c_func
(paren
r_struct
id|uart_port
op_star
id|port
)paren
(brace
r_struct
id|uart_ip22zilog_port
op_star
id|up
op_assign
id|UART_ZILOG
c_func
(paren
id|port
)paren
suffix:semicolon
r_struct
id|zilog_channel
op_star
id|channel
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|ZS_IS_CONS
c_func
(paren
id|up
)paren
)paren
r_return
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|port-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|channel
op_assign
id|ZILOG_CHANNEL_FROM_PORT
c_func
(paren
id|port
)paren
suffix:semicolon
multiline_comment|/* Disable receiver and transmitter.  */
id|up-&gt;curregs
(braket
id|R3
)braket
op_and_assign
op_complement
id|RxENAB
suffix:semicolon
id|up-&gt;curregs
(braket
id|R5
)braket
op_and_assign
op_complement
id|TxENAB
suffix:semicolon
multiline_comment|/* Disable all interrupts and BRK assertion.  */
id|up-&gt;curregs
(braket
id|R1
)braket
op_and_assign
op_complement
(paren
id|EXT_INT_ENAB
op_or
id|TxINT_ENAB
op_or
id|RxINT_MASK
)paren
suffix:semicolon
id|up-&gt;curregs
(braket
id|R5
)braket
op_and_assign
op_complement
id|SND_BRK
suffix:semicolon
id|ip22zilog_maybe_update_regs
c_func
(paren
id|up
comma
id|channel
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|port-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* Shared by TTY driver and serial console setup.  The port lock is held&n; * and local interrupts are disabled.&n; */
r_static
r_void
DECL|function|ip22zilog_convert_to_zs
id|ip22zilog_convert_to_zs
c_func
(paren
r_struct
id|uart_ip22zilog_port
op_star
id|up
comma
r_int
r_int
id|cflag
comma
r_int
r_int
id|iflag
comma
r_int
id|brg
)paren
(brace
id|up-&gt;curregs
(braket
id|R10
)braket
op_assign
id|NRZ
suffix:semicolon
id|up-&gt;curregs
(braket
id|R11
)braket
op_assign
id|TCBR
op_or
id|RCBR
suffix:semicolon
multiline_comment|/* Program BAUD and clock source. */
id|up-&gt;curregs
(braket
id|R4
)braket
op_and_assign
op_complement
id|XCLK_MASK
suffix:semicolon
id|up-&gt;curregs
(braket
id|R4
)braket
op_or_assign
id|X16CLK
suffix:semicolon
id|up-&gt;curregs
(braket
id|R12
)braket
op_assign
id|brg
op_amp
l_int|0xff
suffix:semicolon
id|up-&gt;curregs
(braket
id|R13
)braket
op_assign
(paren
id|brg
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
id|up-&gt;curregs
(braket
id|R14
)braket
op_assign
id|BRENAB
suffix:semicolon
multiline_comment|/* Character size, stop bits, and parity. */
id|up-&gt;curregs
(braket
l_int|3
)braket
op_and_assign
op_complement
id|RxN_MASK
suffix:semicolon
id|up-&gt;curregs
(braket
l_int|5
)braket
op_and_assign
op_complement
id|TxN_MASK
suffix:semicolon
r_switch
c_cond
(paren
id|cflag
op_amp
id|CSIZE
)paren
(brace
r_case
id|CS5
suffix:colon
id|up-&gt;curregs
(braket
l_int|3
)braket
op_or_assign
id|Rx5
suffix:semicolon
id|up-&gt;curregs
(braket
l_int|5
)braket
op_or_assign
id|Tx5
suffix:semicolon
id|up-&gt;parity_mask
op_assign
l_int|0x1f
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS6
suffix:colon
id|up-&gt;curregs
(braket
l_int|3
)braket
op_or_assign
id|Rx6
suffix:semicolon
id|up-&gt;curregs
(braket
l_int|5
)braket
op_or_assign
id|Tx6
suffix:semicolon
id|up-&gt;parity_mask
op_assign
l_int|0x3f
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS7
suffix:colon
id|up-&gt;curregs
(braket
l_int|3
)braket
op_or_assign
id|Rx7
suffix:semicolon
id|up-&gt;curregs
(braket
l_int|5
)braket
op_or_assign
id|Tx7
suffix:semicolon
id|up-&gt;parity_mask
op_assign
l_int|0x7f
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS8
suffix:colon
r_default
suffix:colon
id|up-&gt;curregs
(braket
l_int|3
)braket
op_or_assign
id|Rx8
suffix:semicolon
id|up-&gt;curregs
(braket
l_int|5
)braket
op_or_assign
id|Tx8
suffix:semicolon
id|up-&gt;parity_mask
op_assign
l_int|0xff
suffix:semicolon
r_break
suffix:semicolon
)brace
suffix:semicolon
id|up-&gt;curregs
(braket
l_int|4
)braket
op_and_assign
op_complement
l_int|0x0c
suffix:semicolon
r_if
c_cond
(paren
id|cflag
op_amp
id|CSTOPB
)paren
id|up-&gt;curregs
(braket
l_int|4
)braket
op_or_assign
id|SB2
suffix:semicolon
r_else
id|up-&gt;curregs
(braket
l_int|4
)braket
op_or_assign
id|SB1
suffix:semicolon
r_if
c_cond
(paren
id|cflag
op_amp
id|PARENB
)paren
id|up-&gt;curregs
(braket
l_int|4
)braket
op_or_assign
id|PAR_ENAB
suffix:semicolon
r_else
id|up-&gt;curregs
(braket
l_int|4
)braket
op_and_assign
op_complement
id|PAR_ENAB
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|cflag
op_amp
id|PARODD
)paren
)paren
id|up-&gt;curregs
(braket
l_int|4
)braket
op_or_assign
id|PAR_EVEN
suffix:semicolon
r_else
id|up-&gt;curregs
(braket
l_int|4
)braket
op_and_assign
op_complement
id|PAR_EVEN
suffix:semicolon
id|up-&gt;port.read_status_mask
op_assign
id|Rx_OVR
suffix:semicolon
r_if
c_cond
(paren
id|iflag
op_amp
id|INPCK
)paren
id|up-&gt;port.read_status_mask
op_or_assign
id|CRC_ERR
op_or
id|PAR_ERR
suffix:semicolon
r_if
c_cond
(paren
id|iflag
op_amp
(paren
id|BRKINT
op_or
id|PARMRK
)paren
)paren
id|up-&gt;port.read_status_mask
op_or_assign
id|BRK_ABRT
suffix:semicolon
id|up-&gt;port.ignore_status_mask
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|iflag
op_amp
id|IGNPAR
)paren
id|up-&gt;port.ignore_status_mask
op_or_assign
id|CRC_ERR
op_or
id|PAR_ERR
suffix:semicolon
r_if
c_cond
(paren
id|iflag
op_amp
id|IGNBRK
)paren
(brace
id|up-&gt;port.ignore_status_mask
op_or_assign
id|BRK_ABRT
suffix:semicolon
r_if
c_cond
(paren
id|iflag
op_amp
id|IGNPAR
)paren
id|up-&gt;port.ignore_status_mask
op_or_assign
id|Rx_OVR
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|cflag
op_amp
id|CREAD
)paren
op_eq
l_int|0
)paren
id|up-&gt;port.ignore_status_mask
op_assign
l_int|0xff
suffix:semicolon
)brace
multiline_comment|/* The port lock is not held.  */
r_static
r_void
DECL|function|ip22zilog_set_termios
id|ip22zilog_set_termios
c_func
(paren
r_struct
id|uart_port
op_star
id|port
comma
r_struct
id|termios
op_star
id|termios
comma
r_struct
id|termios
op_star
id|old
)paren
(brace
r_struct
id|uart_ip22zilog_port
op_star
id|up
op_assign
(paren
r_struct
id|uart_ip22zilog_port
op_star
)paren
id|port
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|baud
comma
id|brg
suffix:semicolon
id|baud
op_assign
id|uart_get_baud_rate
c_func
(paren
id|port
comma
id|termios
comma
id|old
comma
l_int|1200
comma
l_int|76800
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|up-&gt;port.lock
comma
id|flags
)paren
suffix:semicolon
id|brg
op_assign
id|BPS_TO_BRG
c_func
(paren
id|baud
comma
id|ZS_CLOCK
op_div
id|ZS_CLOCK_DIVISOR
)paren
suffix:semicolon
id|ip22zilog_convert_to_zs
c_func
(paren
id|up
comma
id|termios-&gt;c_cflag
comma
id|termios-&gt;c_iflag
comma
id|brg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|UART_ENABLE_MS
c_func
(paren
op_amp
id|up-&gt;port
comma
id|termios-&gt;c_cflag
)paren
)paren
id|up-&gt;flags
op_or_assign
id|IP22ZILOG_FLAG_MODEM_STATUS
suffix:semicolon
r_else
id|up-&gt;flags
op_and_assign
op_complement
id|IP22ZILOG_FLAG_MODEM_STATUS
suffix:semicolon
id|up-&gt;cflag
op_assign
id|termios-&gt;c_cflag
suffix:semicolon
id|ip22zilog_maybe_update_regs
c_func
(paren
id|up
comma
id|ZILOG_CHANNEL_FROM_PORT
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|up-&gt;port.lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|ip22zilog_type
r_static
r_const
r_char
op_star
id|ip22zilog_type
c_func
(paren
r_struct
id|uart_port
op_star
id|port
)paren
(brace
r_return
l_string|&quot;IP22-Zilog&quot;
suffix:semicolon
)brace
multiline_comment|/* We do not request/release mappings of the registers here, this&n; * happens at early serial probe time.&n; */
DECL|function|ip22zilog_release_port
r_static
r_void
id|ip22zilog_release_port
c_func
(paren
r_struct
id|uart_port
op_star
id|port
)paren
(brace
)brace
DECL|function|ip22zilog_request_port
r_static
r_int
id|ip22zilog_request_port
c_func
(paren
r_struct
id|uart_port
op_star
id|port
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* These do not need to do anything interesting either.  */
DECL|function|ip22zilog_config_port
r_static
r_void
id|ip22zilog_config_port
c_func
(paren
r_struct
id|uart_port
op_star
id|port
comma
r_int
id|flags
)paren
(brace
)brace
multiline_comment|/* We do not support letting the user mess with the divisor, IRQ, etc. */
DECL|function|ip22zilog_verify_port
r_static
r_int
id|ip22zilog_verify_port
c_func
(paren
r_struct
id|uart_port
op_star
id|port
comma
r_struct
id|serial_struct
op_star
id|ser
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|variable|ip22zilog_pops
r_static
r_struct
id|uart_ops
id|ip22zilog_pops
op_assign
(brace
dot
id|tx_empty
op_assign
id|ip22zilog_tx_empty
comma
dot
id|set_mctrl
op_assign
id|ip22zilog_set_mctrl
comma
dot
id|get_mctrl
op_assign
id|ip22zilog_get_mctrl
comma
dot
id|stop_tx
op_assign
id|ip22zilog_stop_tx
comma
dot
id|start_tx
op_assign
id|ip22zilog_start_tx
comma
dot
id|stop_rx
op_assign
id|ip22zilog_stop_rx
comma
dot
id|enable_ms
op_assign
id|ip22zilog_enable_ms
comma
dot
id|break_ctl
op_assign
id|ip22zilog_break_ctl
comma
dot
id|startup
op_assign
id|ip22zilog_startup
comma
dot
id|shutdown
op_assign
id|ip22zilog_shutdown
comma
dot
id|set_termios
op_assign
id|ip22zilog_set_termios
comma
dot
id|type
op_assign
id|ip22zilog_type
comma
dot
id|release_port
op_assign
id|ip22zilog_release_port
comma
dot
id|request_port
op_assign
id|ip22zilog_request_port
comma
dot
id|config_port
op_assign
id|ip22zilog_config_port
comma
dot
id|verify_port
op_assign
id|ip22zilog_verify_port
comma
)brace
suffix:semicolon
DECL|variable|ip22zilog_port_table
r_static
r_struct
id|uart_ip22zilog_port
op_star
id|ip22zilog_port_table
suffix:semicolon
DECL|variable|ip22zilog_chip_regs
r_static
r_struct
id|zilog_layout
op_star
op_star
id|ip22zilog_chip_regs
suffix:semicolon
DECL|variable|ip22zilog_irq_chain
r_static
r_struct
id|uart_ip22zilog_port
op_star
id|ip22zilog_irq_chain
suffix:semicolon
DECL|variable|zilog_irq
r_static
r_int
id|zilog_irq
op_assign
op_minus
l_int|1
suffix:semicolon
DECL|function|alloc_one_table
r_static
r_void
op_star
id|__init
id|alloc_one_table
c_func
(paren
r_int
r_int
id|size
)paren
(brace
r_void
op_star
id|ret
suffix:semicolon
id|ret
op_assign
id|kmalloc
c_func
(paren
id|size
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ne
l_int|NULL
)paren
id|memset
c_func
(paren
id|ret
comma
l_int|0
comma
id|size
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|ip22zilog_alloc_tables
r_static
r_void
id|__init
id|ip22zilog_alloc_tables
c_func
(paren
r_void
)paren
(brace
id|ip22zilog_port_table
op_assign
(paren
r_struct
id|uart_ip22zilog_port
op_star
)paren
id|alloc_one_table
c_func
(paren
id|NUM_CHANNELS
op_star
r_sizeof
(paren
r_struct
id|uart_ip22zilog_port
)paren
)paren
suffix:semicolon
id|ip22zilog_chip_regs
op_assign
(paren
r_struct
id|zilog_layout
op_star
op_star
)paren
id|alloc_one_table
c_func
(paren
id|NUM_IP22ZILOG
op_star
r_sizeof
(paren
r_struct
id|zilog_layout
op_star
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ip22zilog_port_table
op_eq
l_int|NULL
op_logical_or
id|ip22zilog_chip_regs
op_eq
l_int|NULL
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;IP22-Zilog: Cannot allocate IP22-Zilog tables.&quot;
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Get the address of the registers for IP22-Zilog instance CHIP.  */
DECL|function|get_zs
r_static
r_struct
id|zilog_layout
op_star
id|__init
id|get_zs
c_func
(paren
r_int
id|chip
)paren
(brace
r_int
r_int
id|base
suffix:semicolon
r_if
c_cond
(paren
id|chip
OL
l_int|0
op_logical_or
id|chip
op_ge
id|NUM_IP22ZILOG
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;IP22-Zilog: Illegal chip number %d in get_zs.&quot;
comma
id|chip
)paren
suffix:semicolon
)brace
multiline_comment|/* Not probe-able, hard code it. */
id|base
op_assign
(paren
r_int
r_int
)paren
op_amp
id|sgioc-&gt;uart
suffix:semicolon
id|zilog_irq
op_assign
id|SGI_SERIAL_IRQ
suffix:semicolon
id|request_mem_region
c_func
(paren
id|base
comma
l_int|8
comma
l_string|&quot;IP22-Zilog&quot;
)paren
suffix:semicolon
r_return
(paren
r_struct
id|zilog_layout
op_star
)paren
id|base
suffix:semicolon
)brace
DECL|macro|ZS_PUT_CHAR_MAX_DELAY
mdefine_line|#define ZS_PUT_CHAR_MAX_DELAY&t;2000&t;/* 10 ms */
macro_line|#ifdef CONFIG_SERIAL_IP22_ZILOG_CONSOLE
DECL|function|ip22zilog_put_char
r_static
r_void
id|ip22zilog_put_char
c_func
(paren
r_struct
id|zilog_channel
op_star
id|channel
comma
r_int
r_char
id|ch
)paren
(brace
r_int
id|loops
op_assign
id|ZS_PUT_CHAR_MAX_DELAY
suffix:semicolon
multiline_comment|/* This is a timed polling loop so do not switch the explicit&n;&t; * udelay with ZSDELAY as that is a NOP on some platforms.  -DaveM&n;&t; */
r_do
(brace
r_int
r_char
id|val
op_assign
id|readb
c_func
(paren
op_amp
id|channel-&gt;control
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val
op_amp
id|Tx_BUF_EMP
)paren
(brace
id|ZSDELAY
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|udelay
c_func
(paren
l_int|5
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
op_decrement
id|loops
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|ch
comma
op_amp
id|channel-&gt;data
)paren
suffix:semicolon
id|ZSDELAY
c_func
(paren
)paren
suffix:semicolon
id|ZS_WSYNC
c_func
(paren
id|channel
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|ip22zilog_console_write
id|ip22zilog_console_write
c_func
(paren
r_struct
id|console
op_star
id|con
comma
r_const
r_char
op_star
id|s
comma
r_int
r_int
id|count
)paren
(brace
r_struct
id|uart_ip22zilog_port
op_star
id|up
op_assign
op_amp
id|ip22zilog_port_table
(braket
id|con-&gt;index
)braket
suffix:semicolon
r_struct
id|zilog_channel
op_star
id|channel
op_assign
id|ZILOG_CHANNEL_FROM_PORT
c_func
(paren
op_amp
id|up-&gt;port
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|i
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|up-&gt;port.lock
comma
id|flags
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
suffix:semicolon
id|i
op_increment
comma
id|s
op_increment
)paren
(brace
id|ip22zilog_put_char
c_func
(paren
id|channel
comma
op_star
id|s
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|s
op_eq
l_int|10
)paren
id|ip22zilog_put_char
c_func
(paren
id|channel
comma
l_int|13
)paren
suffix:semicolon
)brace
id|udelay
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|up-&gt;port.lock
comma
id|flags
)paren
suffix:semicolon
)brace
r_void
DECL|function|ip22serial_console_termios
id|ip22serial_console_termios
c_func
(paren
r_struct
id|console
op_star
id|con
comma
r_char
op_star
id|options
)paren
(brace
r_int
id|baud
op_assign
l_int|9600
comma
id|bits
op_assign
l_int|8
comma
id|cflag
suffix:semicolon
r_int
id|parity
op_assign
l_char|&squot;n&squot;
suffix:semicolon
r_int
id|flow
op_assign
l_char|&squot;n&squot;
suffix:semicolon
r_if
c_cond
(paren
id|options
)paren
id|uart_parse_options
c_func
(paren
id|options
comma
op_amp
id|baud
comma
op_amp
id|parity
comma
op_amp
id|bits
comma
op_amp
id|flow
)paren
suffix:semicolon
id|cflag
op_assign
id|CREAD
op_or
id|HUPCL
op_or
id|CLOCAL
suffix:semicolon
r_switch
c_cond
(paren
id|baud
)paren
(brace
r_case
l_int|150
suffix:colon
id|cflag
op_or_assign
id|B150
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|300
suffix:colon
id|cflag
op_or_assign
id|B300
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|600
suffix:colon
id|cflag
op_or_assign
id|B600
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1200
suffix:colon
id|cflag
op_or_assign
id|B1200
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2400
suffix:colon
id|cflag
op_or_assign
id|B2400
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4800
suffix:colon
id|cflag
op_or_assign
id|B4800
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|9600
suffix:colon
id|cflag
op_or_assign
id|B9600
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|19200
suffix:colon
id|cflag
op_or_assign
id|B19200
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|38400
suffix:colon
id|cflag
op_or_assign
id|B38400
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|baud
op_assign
l_int|9600
suffix:semicolon
id|cflag
op_or_assign
id|B9600
suffix:semicolon
r_break
suffix:semicolon
)brace
id|con-&gt;cflag
op_assign
id|cflag
op_or
id|CS8
suffix:semicolon
multiline_comment|/* 8N1 */
)brace
DECL|function|ip22zilog_console_setup
r_static
r_int
id|__init
id|ip22zilog_console_setup
c_func
(paren
r_struct
id|console
op_star
id|con
comma
r_char
op_star
id|options
)paren
(brace
r_struct
id|uart_ip22zilog_port
op_star
id|up
op_assign
op_amp
id|ip22zilog_port_table
(braket
id|con-&gt;index
)braket
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|baud
comma
id|brg
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Console: ttyS%d (IP22-Zilog)&bslash;n&quot;
comma
id|con-&gt;index
)paren
suffix:semicolon
multiline_comment|/* Get firmware console settings.  */
id|ip22serial_console_termios
c_func
(paren
id|con
comma
id|options
)paren
suffix:semicolon
multiline_comment|/* Firmware console speed is limited to 150--&gt;38400 baud so&n;&t; * this hackish cflag thing is OK.&n;&t; */
r_switch
c_cond
(paren
id|con-&gt;cflag
op_amp
id|CBAUD
)paren
(brace
r_case
id|B150
suffix:colon
id|baud
op_assign
l_int|150
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B300
suffix:colon
id|baud
op_assign
l_int|300
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B600
suffix:colon
id|baud
op_assign
l_int|600
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B1200
suffix:colon
id|baud
op_assign
l_int|1200
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B2400
suffix:colon
id|baud
op_assign
l_int|2400
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B4800
suffix:colon
id|baud
op_assign
l_int|4800
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_case
id|B9600
suffix:colon
id|baud
op_assign
l_int|9600
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B19200
suffix:colon
id|baud
op_assign
l_int|19200
suffix:semicolon
r_break
suffix:semicolon
r_case
id|B38400
suffix:colon
id|baud
op_assign
l_int|38400
suffix:semicolon
r_break
suffix:semicolon
)brace
suffix:semicolon
id|brg
op_assign
id|BPS_TO_BRG
c_func
(paren
id|baud
comma
id|ZS_CLOCK
op_div
id|ZS_CLOCK_DIVISOR
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|up-&gt;port.lock
comma
id|flags
)paren
suffix:semicolon
id|up-&gt;curregs
(braket
id|R15
)braket
op_assign
id|BRKIE
suffix:semicolon
id|ip22zilog_convert_to_zs
c_func
(paren
id|up
comma
id|con-&gt;cflag
comma
l_int|0
comma
id|brg
)paren
suffix:semicolon
id|__ip22zilog_startup
c_func
(paren
id|up
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|up-&gt;port.lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|ip22zilog_reg
r_static
r_struct
id|uart_driver
id|ip22zilog_reg
suffix:semicolon
DECL|variable|ip22zilog_console
r_static
r_struct
id|console
id|ip22zilog_console
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;ttyS&quot;
comma
dot
id|write
op_assign
id|ip22zilog_console_write
comma
dot
id|device
op_assign
id|uart_console_device
comma
dot
id|setup
op_assign
id|ip22zilog_console_setup
comma
dot
id|flags
op_assign
id|CON_PRINTBUFFER
comma
dot
id|index
op_assign
op_minus
l_int|1
comma
dot
id|data
op_assign
op_amp
id|ip22zilog_reg
comma
)brace
suffix:semicolon
macro_line|#endif /* CONFIG_SERIAL_IP22_ZILOG_CONSOLE */
DECL|variable|ip22zilog_reg
r_static
r_struct
id|uart_driver
id|ip22zilog_reg
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|driver_name
op_assign
l_string|&quot;serial&quot;
comma
dot
id|devfs_name
op_assign
l_string|&quot;tts/&quot;
comma
dot
id|dev_name
op_assign
l_string|&quot;ttyS&quot;
comma
dot
id|major
op_assign
id|TTY_MAJOR
comma
dot
id|minor
op_assign
l_int|64
comma
dot
id|nr
op_assign
id|NUM_CHANNELS
comma
macro_line|#ifdef CONFIG_SERIAL_IP22_ZILOG_CONSOLE
dot
id|cons
op_assign
op_amp
id|ip22zilog_console
comma
macro_line|#endif
)brace
suffix:semicolon
DECL|function|ip22zilog_prepare
r_static
r_void
id|__init
id|ip22zilog_prepare
c_func
(paren
r_void
)paren
(brace
r_struct
id|uart_ip22zilog_port
op_star
id|up
suffix:semicolon
r_struct
id|zilog_layout
op_star
id|rp
suffix:semicolon
r_int
id|channel
comma
id|chip
suffix:semicolon
multiline_comment|/*&n;&t; * Temporary fix.&n;&t; */
r_for
c_loop
(paren
id|channel
op_assign
l_int|0
suffix:semicolon
id|channel
OL
id|NUM_CHANNELS
suffix:semicolon
id|channel
op_increment
)paren
id|spin_lock_init
c_func
(paren
op_amp
id|ip22zilog_port_table
(braket
id|channel
)braket
dot
id|port.lock
)paren
suffix:semicolon
id|ip22zilog_irq_chain
op_assign
op_amp
id|ip22zilog_port_table
(braket
id|NUM_CHANNELS
op_minus
l_int|1
)braket
suffix:semicolon
id|up
op_assign
op_amp
id|ip22zilog_port_table
(braket
l_int|0
)braket
suffix:semicolon
r_for
c_loop
(paren
id|channel
op_assign
id|NUM_CHANNELS
op_minus
l_int|1
suffix:semicolon
id|channel
OG
l_int|0
suffix:semicolon
id|channel
op_decrement
)paren
id|up
(braket
id|channel
)braket
dot
id|next
op_assign
op_amp
id|up
(braket
id|channel
op_minus
l_int|1
)braket
suffix:semicolon
id|up
(braket
id|channel
)braket
dot
id|next
op_assign
l_int|NULL
suffix:semicolon
r_for
c_loop
(paren
id|chip
op_assign
l_int|0
suffix:semicolon
id|chip
OL
id|NUM_IP22ZILOG
suffix:semicolon
id|chip
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ip22zilog_chip_regs
(braket
id|chip
)braket
)paren
(brace
id|ip22zilog_chip_regs
(braket
id|chip
)braket
op_assign
id|rp
op_assign
id|get_zs
c_func
(paren
id|chip
)paren
suffix:semicolon
id|up
(braket
(paren
id|chip
op_star
l_int|2
)paren
op_plus
l_int|0
)braket
dot
id|port.membase
op_assign
(paren
r_char
op_star
)paren
op_amp
id|rp-&gt;channelB
suffix:semicolon
id|up
(braket
(paren
id|chip
op_star
l_int|2
)paren
op_plus
l_int|1
)braket
dot
id|port.membase
op_assign
(paren
r_char
op_star
)paren
op_amp
id|rp-&gt;channelA
suffix:semicolon
multiline_comment|/* In theory mapbase is the physical address ...  */
id|up
(braket
(paren
id|chip
op_star
l_int|2
)paren
op_plus
l_int|0
)braket
dot
id|port.mapbase
op_assign
(paren
r_int
r_int
)paren
id|ioremap
c_func
(paren
(paren
r_int
r_int
)paren
op_amp
id|rp-&gt;channelB
comma
l_int|8
)paren
suffix:semicolon
id|up
(braket
(paren
id|chip
op_star
l_int|2
)paren
op_plus
l_int|1
)braket
dot
id|port.mapbase
op_assign
(paren
r_int
r_int
)paren
id|ioremap
c_func
(paren
(paren
r_int
r_int
)paren
op_amp
id|rp-&gt;channelA
comma
l_int|8
)paren
suffix:semicolon
)brace
multiline_comment|/* Channel A */
id|up
(braket
(paren
id|chip
op_star
l_int|2
)paren
op_plus
l_int|0
)braket
dot
id|port.iotype
op_assign
id|UPIO_MEM
suffix:semicolon
id|up
(braket
(paren
id|chip
op_star
l_int|2
)paren
op_plus
l_int|0
)braket
dot
id|port.irq
op_assign
id|zilog_irq
suffix:semicolon
id|up
(braket
(paren
id|chip
op_star
l_int|2
)paren
op_plus
l_int|0
)braket
dot
id|port.uartclk
op_assign
id|ZS_CLOCK
suffix:semicolon
id|up
(braket
(paren
id|chip
op_star
l_int|2
)paren
op_plus
l_int|0
)braket
dot
id|port.fifosize
op_assign
l_int|1
suffix:semicolon
id|up
(braket
(paren
id|chip
op_star
l_int|2
)paren
op_plus
l_int|0
)braket
dot
id|port.ops
op_assign
op_amp
id|ip22zilog_pops
suffix:semicolon
id|up
(braket
(paren
id|chip
op_star
l_int|2
)paren
op_plus
l_int|0
)braket
dot
id|port.type
op_assign
id|PORT_IP22ZILOG
suffix:semicolon
id|up
(braket
(paren
id|chip
op_star
l_int|2
)paren
op_plus
l_int|0
)braket
dot
id|port.flags
op_assign
l_int|0
suffix:semicolon
id|up
(braket
(paren
id|chip
op_star
l_int|2
)paren
op_plus
l_int|0
)braket
dot
id|port.line
op_assign
(paren
id|chip
op_star
l_int|2
)paren
op_plus
l_int|0
suffix:semicolon
id|up
(braket
(paren
id|chip
op_star
l_int|2
)paren
op_plus
l_int|0
)braket
dot
id|flags
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Channel B */
id|up
(braket
(paren
id|chip
op_star
l_int|2
)paren
op_plus
l_int|1
)braket
dot
id|port.iotype
op_assign
id|UPIO_MEM
suffix:semicolon
id|up
(braket
(paren
id|chip
op_star
l_int|2
)paren
op_plus
l_int|1
)braket
dot
id|port.irq
op_assign
id|zilog_irq
suffix:semicolon
id|up
(braket
(paren
id|chip
op_star
l_int|2
)paren
op_plus
l_int|1
)braket
dot
id|port.uartclk
op_assign
id|ZS_CLOCK
suffix:semicolon
id|up
(braket
(paren
id|chip
op_star
l_int|2
)paren
op_plus
l_int|1
)braket
dot
id|port.fifosize
op_assign
l_int|1
suffix:semicolon
id|up
(braket
(paren
id|chip
op_star
l_int|2
)paren
op_plus
l_int|1
)braket
dot
id|port.ops
op_assign
op_amp
id|ip22zilog_pops
suffix:semicolon
id|up
(braket
(paren
id|chip
op_star
l_int|2
)paren
op_plus
l_int|1
)braket
dot
id|port.type
op_assign
id|PORT_IP22ZILOG
suffix:semicolon
id|up
(braket
(paren
id|chip
op_star
l_int|2
)paren
op_plus
l_int|1
)braket
dot
id|port.flags
op_or_assign
id|IP22ZILOG_FLAG_IS_CHANNEL_A
suffix:semicolon
id|up
(braket
(paren
id|chip
op_star
l_int|2
)paren
op_plus
l_int|1
)braket
dot
id|port.line
op_assign
(paren
id|chip
op_star
l_int|2
)paren
op_plus
l_int|1
suffix:semicolon
id|up
(braket
(paren
id|chip
op_star
l_int|2
)paren
op_plus
l_int|1
)braket
dot
id|flags
op_assign
l_int|0
suffix:semicolon
)brace
)brace
DECL|function|ip22zilog_init_hw
r_static
r_void
id|__init
id|ip22zilog_init_hw
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_CHANNELS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|uart_ip22zilog_port
op_star
id|up
op_assign
op_amp
id|ip22zilog_port_table
(braket
id|i
)braket
suffix:semicolon
r_struct
id|zilog_channel
op_star
id|channel
op_assign
id|ZILOG_CHANNEL_FROM_PORT
c_func
(paren
op_amp
id|up-&gt;port
)paren
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|baud
comma
id|brg
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|up-&gt;port.lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ZS_IS_CHANNEL_A
c_func
(paren
id|up
)paren
)paren
(brace
id|write_zsreg
c_func
(paren
id|channel
comma
id|R9
comma
id|FHWRES
)paren
suffix:semicolon
id|ZSDELAY_LONG
c_func
(paren
)paren
suffix:semicolon
(paren
r_void
)paren
id|read_zsreg
c_func
(paren
id|channel
comma
id|R0
)paren
suffix:semicolon
)brace
multiline_comment|/* Normal serial TTY. */
id|up-&gt;parity_mask
op_assign
l_int|0xff
suffix:semicolon
id|up-&gt;curregs
(braket
id|R1
)braket
op_assign
id|EXT_INT_ENAB
op_or
id|INT_ALL_Rx
op_or
id|TxINT_ENAB
suffix:semicolon
id|up-&gt;curregs
(braket
id|R4
)braket
op_assign
id|PAR_EVEN
op_or
id|X16CLK
op_or
id|SB1
suffix:semicolon
id|up-&gt;curregs
(braket
id|R3
)braket
op_assign
id|RxENAB
op_or
id|Rx8
suffix:semicolon
id|up-&gt;curregs
(braket
id|R5
)braket
op_assign
id|TxENAB
op_or
id|Tx8
suffix:semicolon
id|up-&gt;curregs
(braket
id|R9
)braket
op_assign
id|NV
op_or
id|MIE
suffix:semicolon
id|up-&gt;curregs
(braket
id|R10
)braket
op_assign
id|NRZ
suffix:semicolon
id|up-&gt;curregs
(braket
id|R11
)braket
op_assign
id|TCBR
op_or
id|RCBR
suffix:semicolon
id|baud
op_assign
l_int|9600
suffix:semicolon
id|brg
op_assign
id|BPS_TO_BRG
c_func
(paren
id|baud
comma
id|ZS_CLOCK
op_div
id|ZS_CLOCK_DIVISOR
)paren
suffix:semicolon
id|up-&gt;curregs
(braket
id|R12
)braket
op_assign
(paren
id|brg
op_amp
l_int|0xff
)paren
suffix:semicolon
id|up-&gt;curregs
(braket
id|R13
)braket
op_assign
(paren
id|brg
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
suffix:semicolon
id|up-&gt;curregs
(braket
id|R14
)braket
op_assign
id|BRENAB
suffix:semicolon
id|__load_zsregs
c_func
(paren
id|channel
comma
id|up-&gt;curregs
)paren
suffix:semicolon
multiline_comment|/* set master interrupt enable */
id|write_zsreg
c_func
(paren
id|channel
comma
id|R9
comma
id|up-&gt;curregs
(braket
id|R9
)braket
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|up-&gt;port.lock
comma
id|flags
)paren
suffix:semicolon
)brace
)brace
DECL|function|ip22zilog_ports_init
r_static
r_int
id|__init
id|ip22zilog_ports_init
c_func
(paren
r_void
)paren
(brace
r_int
id|ret
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Serial: IP22 Zilog driver (%d chips).&bslash;n&quot;
comma
id|NUM_IP22ZILOG
)paren
suffix:semicolon
id|ip22zilog_prepare
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|zilog_irq
comma
id|ip22zilog_interrupt
comma
l_int|0
comma
l_string|&quot;IP22-Zilog&quot;
comma
id|ip22zilog_irq_chain
)paren
)paren
(brace
id|panic
c_func
(paren
l_string|&quot;IP22-Zilog: Unable to register zs interrupt handler.&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|ip22zilog_init_hw
c_func
(paren
)paren
suffix:semicolon
id|ret
op_assign
id|uart_register_driver
c_func
(paren
op_amp
id|ip22zilog_reg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
l_int|0
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_CHANNELS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|uart_ip22zilog_port
op_star
id|up
op_assign
op_amp
id|ip22zilog_port_table
(braket
id|i
)braket
suffix:semicolon
id|uart_add_one_port
c_func
(paren
op_amp
id|ip22zilog_reg
comma
op_amp
id|up-&gt;port
)paren
suffix:semicolon
)brace
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|function|ip22zilog_init
r_static
r_int
id|__init
id|ip22zilog_init
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* IP22 Zilog setup is hard coded, no probing to do.  */
id|ip22zilog_alloc_tables
c_func
(paren
)paren
suffix:semicolon
id|ip22zilog_ports_init
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ip22zilog_exit
r_static
r_void
id|__exit
id|ip22zilog_exit
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_CHANNELS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|uart_ip22zilog_port
op_star
id|up
op_assign
op_amp
id|ip22zilog_port_table
(braket
id|i
)braket
suffix:semicolon
id|uart_remove_one_port
c_func
(paren
op_amp
id|ip22zilog_reg
comma
op_amp
id|up-&gt;port
)paren
suffix:semicolon
)brace
id|uart_unregister_driver
c_func
(paren
op_amp
id|ip22zilog_reg
)paren
suffix:semicolon
)brace
DECL|variable|ip22zilog_init
id|module_init
c_func
(paren
id|ip22zilog_init
)paren
suffix:semicolon
DECL|variable|ip22zilog_exit
id|module_exit
c_func
(paren
id|ip22zilog_exit
)paren
suffix:semicolon
multiline_comment|/* David wrote it but I&squot;m to blame for the bugs ...  */
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Ralf Baechle &lt;ralf@linux-mips.org&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;SGI Zilog serial port driver&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
eof
