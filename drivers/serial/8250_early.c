multiline_comment|/*&n; * Early serial console for 8250/16550 devices&n; *&n; * (c) Copyright 2004 Hewlett-Packard Development Company, L.P.&n; *&t;Bjorn Helgaas &lt;bjorn.helgaas@hp.com&gt;&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License version 2 as&n; * published by the Free Software Foundation.&n; *&n; * Based on the 8250.c serial driver, Copyright (C) 2001 Russell King,&n; * and on early_printk.c by Andi Kleen.&n; *&n; * This is for use before the serial driver has initialized, in&n; * particular, before the UARTs have been discovered and named.&n; * Instead of specifying the console device as, e.g., &quot;ttyS0&quot;,&n; * we locate the device directly by its MMIO or I/O port address.&n; *&n; * The user can specify the device directly, e.g.,&n; *&t;console=uart,io,0x3f8,9600n8&n; *&t;console=uart,mmio,0xff5e0000,115200n8&n; * or platform code can call early_uart_console_init() to set&n; * the early UART device.&n; *&n; * After the normal serial driver starts, we try to locate the&n; * matching ttyS device and start a console there.&n; */
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/console.h&gt;
macro_line|#include &lt;linux/serial_core.h&gt;
macro_line|#include &lt;linux/serial_reg.h&gt;
macro_line|#include &lt;linux/serial.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/serial.h&gt;
DECL|struct|early_uart_device
r_struct
id|early_uart_device
(brace
DECL|member|port
r_struct
id|uart_port
id|port
suffix:semicolon
DECL|member|options
r_char
id|options
(braket
l_int|16
)braket
suffix:semicolon
multiline_comment|/* e.g., 115200n8 */
DECL|member|baud
r_int
r_int
id|baud
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|__initdata
r_static
r_struct
id|early_uart_device
id|early_device
id|__initdata
suffix:semicolon
DECL|variable|__initdata
r_static
r_int
id|early_uart_registered
id|__initdata
suffix:semicolon
DECL|function|serial_in
r_static
r_int
r_int
id|__init
id|serial_in
c_func
(paren
r_struct
id|uart_port
op_star
id|port
comma
r_int
id|offset
)paren
(brace
r_if
c_cond
(paren
id|port-&gt;iotype
op_eq
id|UPIO_MEM
)paren
r_return
id|readb
c_func
(paren
id|port-&gt;membase
op_plus
id|offset
)paren
suffix:semicolon
r_else
r_return
id|inb
c_func
(paren
id|port-&gt;iobase
op_plus
id|offset
)paren
suffix:semicolon
)brace
DECL|function|serial_out
r_static
r_void
id|__init
id|serial_out
c_func
(paren
r_struct
id|uart_port
op_star
id|port
comma
r_int
id|offset
comma
r_int
id|value
)paren
(brace
r_if
c_cond
(paren
id|port-&gt;iotype
op_eq
id|UPIO_MEM
)paren
id|writeb
c_func
(paren
id|value
comma
id|port-&gt;membase
op_plus
id|offset
)paren
suffix:semicolon
r_else
id|outb
c_func
(paren
id|value
comma
id|port-&gt;iobase
op_plus
id|offset
)paren
suffix:semicolon
)brace
DECL|macro|BOTH_EMPTY
mdefine_line|#define BOTH_EMPTY (UART_LSR_TEMT | UART_LSR_THRE)
DECL|function|wait_for_xmitr
r_static
r_void
id|__init
id|wait_for_xmitr
c_func
(paren
r_struct
id|uart_port
op_star
id|port
)paren
(brace
r_int
r_int
id|status
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|status
op_assign
id|serial_in
c_func
(paren
id|port
comma
id|UART_LSR
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_amp
id|BOTH_EMPTY
)paren
op_eq
id|BOTH_EMPTY
)paren
r_return
suffix:semicolon
id|cpu_relax
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
DECL|function|putc
r_static
r_void
id|__init
id|putc
c_func
(paren
r_struct
id|uart_port
op_star
id|port
comma
r_int
r_char
id|c
)paren
(brace
id|wait_for_xmitr
c_func
(paren
id|port
)paren
suffix:semicolon
id|serial_out
c_func
(paren
id|port
comma
id|UART_TX
comma
id|c
)paren
suffix:semicolon
)brace
DECL|function|early_uart_write
r_static
r_void
id|__init
id|early_uart_write
c_func
(paren
r_struct
id|console
op_star
id|console
comma
r_const
r_char
op_star
id|s
comma
r_int
r_int
id|count
)paren
(brace
r_struct
id|uart_port
op_star
id|port
op_assign
op_amp
id|early_device.port
suffix:semicolon
r_int
r_int
id|ier
suffix:semicolon
multiline_comment|/* Save the IER and disable interrupts */
id|ier
op_assign
id|serial_in
c_func
(paren
id|port
comma
id|UART_IER
)paren
suffix:semicolon
id|serial_out
c_func
(paren
id|port
comma
id|UART_IER
comma
l_int|0
)paren
suffix:semicolon
r_while
c_loop
(paren
op_star
id|s
op_logical_and
id|count
op_decrement
OG
l_int|0
)paren
(brace
id|putc
c_func
(paren
id|port
comma
op_star
id|s
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|s
op_eq
l_char|&squot;&bslash;n&squot;
)paren
id|putc
c_func
(paren
id|port
comma
l_char|&squot;&bslash;r&squot;
)paren
suffix:semicolon
id|s
op_increment
suffix:semicolon
)brace
multiline_comment|/* Wait for transmitter to become empty and restore the IER */
id|wait_for_xmitr
c_func
(paren
id|port
)paren
suffix:semicolon
id|serial_out
c_func
(paren
id|port
comma
id|UART_IER
comma
id|ier
)paren
suffix:semicolon
)brace
DECL|function|probe_baud
r_static
r_int
r_int
id|__init
id|probe_baud
c_func
(paren
r_struct
id|uart_port
op_star
id|port
)paren
(brace
r_int
r_char
id|lcr
comma
id|dll
comma
id|dlm
suffix:semicolon
r_int
r_int
id|quot
suffix:semicolon
id|lcr
op_assign
id|serial_in
c_func
(paren
id|port
comma
id|UART_LCR
)paren
suffix:semicolon
id|serial_out
c_func
(paren
id|port
comma
id|UART_LCR
comma
id|lcr
op_or
id|UART_LCR_DLAB
)paren
suffix:semicolon
id|dll
op_assign
id|serial_in
c_func
(paren
id|port
comma
id|UART_DLL
)paren
suffix:semicolon
id|dlm
op_assign
id|serial_in
c_func
(paren
id|port
comma
id|UART_DLM
)paren
suffix:semicolon
id|serial_out
c_func
(paren
id|port
comma
id|UART_LCR
comma
id|lcr
)paren
suffix:semicolon
id|quot
op_assign
(paren
id|dlm
op_lshift
l_int|8
)paren
op_or
id|dll
suffix:semicolon
r_return
(paren
id|port-&gt;uartclk
op_div
l_int|16
)paren
op_div
id|quot
suffix:semicolon
)brace
DECL|function|init_port
r_static
r_void
id|__init
id|init_port
c_func
(paren
r_struct
id|early_uart_device
op_star
id|device
)paren
(brace
r_struct
id|uart_port
op_star
id|port
op_assign
op_amp
id|device-&gt;port
suffix:semicolon
r_int
r_int
id|divisor
suffix:semicolon
r_int
r_char
id|c
suffix:semicolon
id|serial_out
c_func
(paren
id|port
comma
id|UART_LCR
comma
l_int|0x3
)paren
suffix:semicolon
multiline_comment|/* 8n1 */
id|serial_out
c_func
(paren
id|port
comma
id|UART_IER
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* no interrupt */
id|serial_out
c_func
(paren
id|port
comma
id|UART_FCR
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* no fifo */
id|serial_out
c_func
(paren
id|port
comma
id|UART_MCR
comma
l_int|0x3
)paren
suffix:semicolon
multiline_comment|/* DTR + RTS */
id|divisor
op_assign
id|port-&gt;uartclk
op_div
(paren
l_int|16
op_star
id|device-&gt;baud
)paren
suffix:semicolon
id|c
op_assign
id|serial_in
c_func
(paren
id|port
comma
id|UART_LCR
)paren
suffix:semicolon
id|serial_out
c_func
(paren
id|port
comma
id|UART_LCR
comma
id|c
op_or
id|UART_LCR_DLAB
)paren
suffix:semicolon
id|serial_out
c_func
(paren
id|port
comma
id|UART_DLL
comma
id|divisor
op_amp
l_int|0xff
)paren
suffix:semicolon
id|serial_out
c_func
(paren
id|port
comma
id|UART_DLM
comma
(paren
id|divisor
op_rshift
l_int|8
)paren
op_amp
l_int|0xff
)paren
suffix:semicolon
id|serial_out
c_func
(paren
id|port
comma
id|UART_LCR
comma
id|c
op_amp
op_complement
id|UART_LCR_DLAB
)paren
suffix:semicolon
)brace
DECL|function|parse_options
r_static
r_int
id|__init
id|parse_options
c_func
(paren
r_struct
id|early_uart_device
op_star
id|device
comma
r_char
op_star
id|options
)paren
(brace
r_struct
id|uart_port
op_star
id|port
op_assign
op_amp
id|device-&gt;port
suffix:semicolon
r_int
id|mapsize
op_assign
l_int|64
suffix:semicolon
r_int
id|mmio
comma
id|length
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|options
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|port-&gt;uartclk
op_assign
id|BASE_BAUD
op_star
l_int|16
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|options
comma
l_string|&quot;mmio,&quot;
comma
l_int|5
)paren
)paren
(brace
id|port-&gt;iotype
op_assign
id|UPIO_MEM
suffix:semicolon
id|port-&gt;mapbase
op_assign
id|simple_strtoul
c_func
(paren
id|options
op_plus
l_int|5
comma
op_amp
id|options
comma
l_int|0
)paren
suffix:semicolon
id|port-&gt;membase
op_assign
id|ioremap
c_func
(paren
id|port-&gt;mapbase
comma
id|mapsize
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|port-&gt;membase
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Couldn&squot;t ioremap 0x%lx&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|port-&gt;mapbase
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|mmio
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|options
comma
l_string|&quot;io,&quot;
comma
l_int|3
)paren
)paren
(brace
id|port-&gt;iotype
op_assign
id|UPIO_PORT
suffix:semicolon
id|port-&gt;iobase
op_assign
id|simple_strtoul
c_func
(paren
id|options
op_plus
l_int|3
comma
op_amp
id|options
comma
l_int|0
)paren
suffix:semicolon
id|mmio
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
(paren
id|options
op_assign
id|strchr
c_func
(paren
id|options
comma
l_char|&squot;,&squot;
)paren
)paren
)paren
(brace
id|options
op_increment
suffix:semicolon
id|device-&gt;baud
op_assign
id|simple_strtoul
c_func
(paren
id|options
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|length
op_assign
id|min
c_func
(paren
id|strcspn
c_func
(paren
id|options
comma
l_string|&quot; &quot;
)paren
comma
r_sizeof
(paren
id|device-&gt;options
)paren
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|device-&gt;options
comma
id|options
comma
id|length
)paren
suffix:semicolon
)brace
r_else
(brace
id|device-&gt;baud
op_assign
id|probe_baud
c_func
(paren
id|port
)paren
suffix:semicolon
id|snprintf
c_func
(paren
id|device-&gt;options
comma
r_sizeof
(paren
id|device-&gt;options
)paren
comma
l_string|&quot;%u&quot;
comma
id|device-&gt;baud
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Early serial console at %s 0x%lx (options &squot;%s&squot;)&bslash;n&quot;
comma
id|mmio
ques
c_cond
l_string|&quot;MMIO&quot;
suffix:colon
l_string|&quot;I/O port&quot;
comma
id|mmio
ques
c_cond
id|port-&gt;mapbase
suffix:colon
(paren
r_int
r_int
)paren
id|port-&gt;iobase
comma
id|device-&gt;options
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|early_uart_setup
r_static
r_int
id|__init
id|early_uart_setup
c_func
(paren
r_struct
id|console
op_star
id|console
comma
r_char
op_star
id|options
)paren
(brace
r_struct
id|early_uart_device
op_star
id|device
op_assign
op_amp
id|early_device
suffix:semicolon
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
id|device-&gt;port.membase
op_logical_or
id|device-&gt;port.iobase
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|parse_options
c_func
(paren
id|device
comma
id|options
)paren
)paren
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
id|init_port
c_func
(paren
id|device
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|__initdata
r_static
r_struct
id|console
id|early_uart_console
id|__initdata
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;uart&quot;
comma
dot
id|write
op_assign
id|early_uart_write
comma
dot
id|setup
op_assign
id|early_uart_setup
comma
dot
id|flags
op_assign
id|CON_PRINTBUFFER
comma
dot
id|index
op_assign
op_minus
l_int|1
comma
)brace
suffix:semicolon
DECL|function|early_uart_console_init
r_static
r_int
id|__init
id|early_uart_console_init
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|early_uart_registered
)paren
(brace
id|register_console
c_func
(paren
op_amp
id|early_uart_console
)paren
suffix:semicolon
id|early_uart_registered
op_assign
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|early_uart_console_init
id|console_initcall
c_func
(paren
id|early_uart_console_init
)paren
suffix:semicolon
DECL|function|early_serial_console_init
r_int
id|__init
id|early_serial_console_init
c_func
(paren
r_char
op_star
id|cmdline
)paren
(brace
r_char
op_star
id|options
suffix:semicolon
r_int
id|err
suffix:semicolon
id|options
op_assign
id|strstr
c_func
(paren
id|cmdline
comma
l_string|&quot;console=uart,&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|options
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|options
op_assign
id|strchr
c_func
(paren
id|cmdline
comma
l_char|&squot;,&squot;
)paren
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|early_uart_setup
c_func
(paren
l_int|NULL
comma
id|options
)paren
)paren
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
r_return
id|early_uart_console_init
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|early_uart_console_switch
r_static
r_int
id|__init
id|early_uart_console_switch
c_func
(paren
r_void
)paren
(brace
r_struct
id|early_uart_device
op_star
id|device
op_assign
op_amp
id|early_device
suffix:semicolon
r_struct
id|uart_port
op_star
id|port
op_assign
op_amp
id|device-&gt;port
suffix:semicolon
r_int
id|mmio
comma
id|line
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|early_uart_console.flags
op_amp
id|CON_ENABLED
)paren
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Try to start the normal driver on a matching line.  */
id|mmio
op_assign
(paren
id|port-&gt;iotype
op_eq
id|UPIO_MEM
)paren
suffix:semicolon
id|line
op_assign
id|serial8250_start_console
c_func
(paren
id|port
comma
id|device-&gt;options
)paren
suffix:semicolon
r_if
c_cond
(paren
id|line
OL
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;No ttyS device at %s 0x%lx for console&bslash;n&quot;
comma
id|mmio
ques
c_cond
l_string|&quot;MMIO&quot;
suffix:colon
l_string|&quot;I/O port&quot;
comma
id|mmio
ques
c_cond
id|port-&gt;mapbase
suffix:colon
(paren
r_int
r_int
)paren
id|port-&gt;iobase
)paren
suffix:semicolon
id|unregister_console
c_func
(paren
op_amp
id|early_uart_console
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mmio
)paren
id|iounmap
c_func
(paren
id|port-&gt;membase
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|early_uart_console_switch
id|late_initcall
c_func
(paren
id|early_uart_console_switch
)paren
suffix:semicolon
eof
