multiline_comment|/*&n; *  linux/drivers/serial/serial98.c&n; *&n; *  Driver for NEC PC-9801/PC-9821 standard serial ports&n; *&n; *  Based on drivers/serial/8250.c, by Russell King.&n; *  Based on drivers/char/serial.c, by Linus Torvalds, Theodore Ts&squot;o.&n; *&n; *  Copyright (C) 2002 Osamu Tomita &lt;tomita@cinet.co.jp&gt;&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or&n; * (at your option) any later version.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/serial.h&gt;
macro_line|#include &lt;linux/console.h&gt;
macro_line|#include &lt;linux/sysrq.h&gt;
macro_line|#include &lt;linux/serial_reg.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/pc9800.h&gt;
macro_line|#include &lt;asm/pc9800_sca.h&gt;
macro_line|#if defined(CONFIG_SERIAL98_CONSOLE) &amp;&amp; defined(CONFIG_MAGIC_SYSRQ)
DECL|macro|SUPPORT_SYSRQ
mdefine_line|#define SUPPORT_SYSRQ
macro_line|#endif
macro_line|#include &lt;linux/serial_core.h&gt;
DECL|macro|SERIAL98_NR
mdefine_line|#define SERIAL98_NR&t;&t;1
DECL|macro|SERIAL98_ISR_PASS_LIMIT
mdefine_line|#define SERIAL98_ISR_PASS_LIMIT&t;256
DECL|macro|SERIAL98_EXT
mdefine_line|#define SERIAL98_EXT&t;&t;0x434
singleline_comment|//#define RX_8251F&t;&t;0x130&t;/* In: Receive buffer */
singleline_comment|//#define TX_8251F&t;&t;0x130&t;/* Out: Transmit buffer */
singleline_comment|//#define LSR_8251F&t;&t;0x132&t;/* In: Line Status Register */
singleline_comment|//#define MSR_8251F&t;&t;0x134&t;/* In: Modem Status Register */
DECL|macro|IIR_8251F
mdefine_line|#define IIR_8251F&t;&t;0x136&t;/* In: Interrupt ID Register */
DECL|macro|FCR_8251F
mdefine_line|#define FCR_8251F&t;&t;0x138&t;/* I/O: FIFO Control Register */
DECL|macro|VFAST_8251F
mdefine_line|#define VFAST_8251F&t;&t;0x13a&t;/* I/O: VFAST mode Register */
DECL|macro|CMD_8251F
mdefine_line|#define CMD_8251F&t;&t;0x32&t;/* Out: 8251 Command Resister */
DECL|macro|IER2_8251F
mdefine_line|#define IER2_8251F&t;&t;0x34&t;/* I/O: Interrupt Enable Register */
DECL|macro|IER1_8251F
mdefine_line|#define IER1_8251F&t;&t;0x35&t;/* I/O: Interrupt Enable Register */
DECL|macro|IER1_CTL
mdefine_line|#define IER1_CTL&t;&t;0x37&t;/* Out: Interrupt Enable Register */
DECL|macro|DIS_RXR_INT
mdefine_line|#define DIS_RXR_INT&t;&t;0x00&t;/* disable RxRDY Interrupt */
DECL|macro|ENA_RXR_INT
mdefine_line|#define ENA_RXR_INT&t;&t;0x01&t;/* enable RxRDY Interrupt */
DECL|macro|DIS_TXE_INT
mdefine_line|#define DIS_TXE_INT&t;&t;0x02&t;/* disable TxEMPTY Interrupt */
DECL|macro|ENA_TXE_INT
mdefine_line|#define ENA_TXE_INT&t;&t;0x03&t;/* enable TxEMPTY Interrupt */
DECL|macro|DIS_TXR_INT
mdefine_line|#define DIS_TXR_INT&t;&t;0x04&t;/* disable TxRDY Interrupt */
DECL|macro|ENA_TXR_INT
mdefine_line|#define ENA_TXR_INT&t;&t;0x05&t;/* enable TxRDY Interrupt */
DECL|macro|CMD_RESET
mdefine_line|#define CMD_RESET&t;&t;0x40&t;/* Reset Command */
DECL|macro|CMD_RTS
mdefine_line|#define CMD_RTS&t;&t;&t;0x20&t;/* Set RTS line */
DECL|macro|CMD_CLR_ERR
mdefine_line|#define CMD_CLR_ERR&t;&t;0x10&t;/* Clear error flag */
DECL|macro|CMD_BREAK
mdefine_line|#define CMD_BREAK&t;&t;0x08&t;/* Send Break */
DECL|macro|CMD_RXE
mdefine_line|#define CMD_RXE&t;&t;&t;0x04&t;/* Enable receive */
DECL|macro|CMD_DTR
mdefine_line|#define CMD_DTR&t;&t;&t;0x02&t;/* Set DTR line */
DECL|macro|CMD_TXE
mdefine_line|#define CMD_TXE&t;&t;&t;0x01&t;/* Enable send */
DECL|macro|CMD_DUMMY
mdefine_line|#define CMD_DUMMY&t;&t;0x00&t;/* Dummy Command */
DECL|macro|VFAST_ENABLE
mdefine_line|#define VFAST_ENABLE&t;&t;0x80&t;/* V.Fast mode Enable */
multiline_comment|/* Interrupt masks */
DECL|macro|INTR_8251_TXRE
mdefine_line|#define INTR_8251_TXRE&t;&t;0x04
DECL|macro|INTR_8251_TXEE
mdefine_line|#define INTR_8251_TXEE&t;&t;0x02
DECL|macro|INTR_8251_RXRE
mdefine_line|#define INTR_8251_RXRE&t;&t;0x01
multiline_comment|/* I/O Port */
singleline_comment|//#define PORT_8251_DATA&t;0
singleline_comment|//#define PORT_8251_CMD&t;&t;2
singleline_comment|//#define PORT_8251_MOD&t;&t;2
singleline_comment|//#define PORT_8251_STS&t;&t;2
multiline_comment|/* status read */
DECL|macro|STAT_8251_TXRDY
mdefine_line|#define STAT_8251_TXRDY&t;&t;0x01
DECL|macro|STAT_8251_RXRDY
mdefine_line|#define STAT_8251_RXRDY&t;&t;0x02
DECL|macro|STAT_8251_TXEMP
mdefine_line|#define STAT_8251_TXEMP&t;&t;0x04
DECL|macro|STAT_8251_PER
mdefine_line|#define STAT_8251_PER&t;&t;0x08
DECL|macro|STAT_8251_OER
mdefine_line|#define STAT_8251_OER&t;&t;0x10
DECL|macro|STAT_8251_FER
mdefine_line|#define STAT_8251_FER&t;&t;0x20
DECL|macro|STAT_8251_BRK
mdefine_line|#define STAT_8251_BRK&t;&t;0x40
DECL|macro|STAT_8251_DSR
mdefine_line|#define STAT_8251_DSR&t;&t;0x80
macro_line|#if 1
DECL|macro|STAT_8251F_TXEMP
mdefine_line|#define STAT_8251F_TXEMP&t;0x01
DECL|macro|STAT_8251F_TXRDY
mdefine_line|#define STAT_8251F_TXRDY&t;0x02
DECL|macro|STAT_8251F_RXRDY
mdefine_line|#define STAT_8251F_RXRDY&t;0x04
DECL|macro|STAT_8251F_DSR
mdefine_line|#define STAT_8251F_DSR&t;&t;0x08
DECL|macro|STAT_8251F_OER
mdefine_line|#define STAT_8251F_OER&t;&t;0x10
DECL|macro|STAT_8251F_PER
mdefine_line|#define STAT_8251F_PER&t;&t;0x20
DECL|macro|STAT_8251F_FER
mdefine_line|#define STAT_8251F_FER&t;&t;0x40
DECL|macro|STAT_8251F_BRK
mdefine_line|#define STAT_8251F_BRK&t;&t;0x80
macro_line|#else
DECL|macro|STAT_8251F_TXEMP
mdefine_line|#define STAT_8251F_TXEMP&t;0x01
DECL|macro|STAT_8251F_TEMT
mdefine_line|#define STAT_8251F_TEMT&t;&t;0x01
DECL|macro|STAT_8251F_TXRDY
mdefine_line|#define STAT_8251F_TXRDY&t;0x02
DECL|macro|STAT_8251F_THRE
mdefine_line|#define STAT_8251F_THRE&t;&t;0x02
DECL|macro|STAT_8251F_RXRDY
mdefine_line|#define STAT_8251F_RXRDY&t;0x04
DECL|macro|STAT_8251F_DSR
mdefine_line|#define STAT_8251F_DSR&t;&t;0x04
DECL|macro|STAT_8251F_PER
mdefine_line|#define STAT_8251F_PER&t;&t;0x08
DECL|macro|STAT_8251F_OER
mdefine_line|#define STAT_8251F_OER&t;&t;0x10
DECL|macro|STAT_8251F_FER
mdefine_line|#define STAT_8251F_FER&t;&t;0x20
DECL|macro|STAT_8251F_BRK
mdefine_line|#define STAT_8251F_BRK&t;&t;0x40
macro_line|#endif
multiline_comment|/*&n; * We wrap our port structure around the generic uart_port.&n; */
DECL|struct|serial98_port
r_struct
id|serial98_port
(brace
DECL|member|port
r_struct
id|uart_port
id|port
suffix:semicolon
DECL|member|type
r_int
r_int
id|type
suffix:semicolon
DECL|member|ext
r_int
r_int
id|ext
suffix:semicolon
DECL|member|lsr_break_flag
r_int
r_int
id|lsr_break_flag
suffix:semicolon
DECL|member|cmd
r_int
r_char
id|cmd
suffix:semicolon
DECL|member|mode
r_int
r_char
id|mode
suffix:semicolon
DECL|member|msr
r_int
r_char
id|msr
suffix:semicolon
DECL|member|ier
r_int
r_char
id|ier
suffix:semicolon
DECL|member|rxchk
r_int
r_char
id|rxchk
suffix:semicolon
DECL|member|txemp
r_int
r_char
id|txemp
suffix:semicolon
DECL|member|txrdy
r_int
r_char
id|txrdy
suffix:semicolon
DECL|member|rxrdy
r_int
r_char
id|rxrdy
suffix:semicolon
DECL|member|brk
r_int
r_char
id|brk
suffix:semicolon
DECL|member|fe
r_int
r_char
id|fe
suffix:semicolon
DECL|member|oe
r_int
r_char
id|oe
suffix:semicolon
DECL|member|pe
r_int
r_char
id|pe
suffix:semicolon
DECL|member|dr
r_int
r_char
id|dr
suffix:semicolon
)brace
suffix:semicolon
macro_line|#ifdef CONFIG_SERIAL98_CONSOLE
r_static
r_void
id|serial98_console_write
c_func
(paren
r_struct
id|console
op_star
id|co
comma
r_const
r_char
op_star
id|s
comma
r_int
r_int
id|count
)paren
suffix:semicolon
r_static
id|kdev_t
id|serial98_console_device
c_func
(paren
r_struct
id|console
op_star
id|co
)paren
suffix:semicolon
r_static
r_int
id|__init
id|serial98_console_setup
c_func
(paren
r_struct
id|console
op_star
id|co
comma
r_char
op_star
id|options
)paren
suffix:semicolon
DECL|variable|serial98_console
r_static
r_struct
id|console
id|serial98_console
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;ttyS&quot;
comma
dot
id|write
op_assign
id|serial98_console_write
comma
dot
id|device
op_assign
id|serial98_console_device
comma
dot
id|setup
op_assign
id|serial98_console_setup
comma
dot
id|flags
op_assign
id|CON_PRINTBUFFER
comma
dot
id|index
op_assign
op_minus
l_int|1
comma
)brace
suffix:semicolon
DECL|macro|SERIAL98_CONSOLE
mdefine_line|#define SERIAL98_CONSOLE&t;&amp;serial98_console
macro_line|#else
DECL|macro|SERIAL98_CONSOLE
mdefine_line|#define SERIAL98_CONSOLE&t;NULL
macro_line|#endif
DECL|variable|serial98_reg
r_static
r_struct
id|uart_driver
id|serial98_reg
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|driver_name
op_assign
l_string|&quot;serial98&quot;
comma
dot
id|dev_name
op_assign
l_string|&quot;ttyS%d&quot;
comma
dot
id|major
op_assign
id|TTY_MAJOR
comma
dot
id|minor
op_assign
l_int|64
comma
dot
id|nr
op_assign
id|SERIAL98_NR
comma
dot
id|cons
op_assign
id|SERIAL98_CONSOLE
comma
)brace
suffix:semicolon
DECL|variable|serial98_clk
r_static
r_int
id|serial98_clk
suffix:semicolon
DECL|variable|type_str
r_static
r_char
id|type_str
(braket
l_int|48
)braket
suffix:semicolon
DECL|macro|PORT98
mdefine_line|#define PORT98 ((struct serial98_port *)port)
DECL|macro|PORT
mdefine_line|#define PORT (PORT98-&gt;port)
DECL|function|serial98_fifo_enable
r_static
r_void
id|serial98_fifo_enable
c_func
(paren
r_struct
id|uart_port
op_star
id|port
comma
r_int
id|enable
)paren
(brace
r_int
r_char
id|fcr
suffix:semicolon
r_if
c_cond
(paren
id|PORT.type
op_eq
id|PORT_FIFO_PC98
op_logical_or
id|PORT.type
op_eq
id|PORT_VFAST_PC98
)paren
(brace
id|fcr
op_assign
id|inb
c_func
(paren
id|FCR_8251F
)paren
suffix:semicolon
r_if
c_cond
(paren
id|enable
)paren
id|fcr
op_or_assign
id|UART_FCR_ENABLE_FIFO
suffix:semicolon
r_else
id|fcr
op_and_assign
op_complement
id|UART_FCR_ENABLE_FIFO
suffix:semicolon
id|outb
c_func
(paren
id|fcr
comma
id|FCR_8251F
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|enable
)paren
r_return
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
l_int|0x5f
)paren
suffix:semicolon
multiline_comment|/* wait */
id|outb
c_func
(paren
l_int|0
comma
l_int|0x5f
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
l_int|0x5f
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
l_int|0x5f
)paren
suffix:semicolon
)brace
DECL|function|serial98_cmd_out
r_static
r_void
id|serial98_cmd_out
c_func
(paren
r_struct
id|uart_port
op_star
id|port
comma
r_int
r_char
id|cmd
)paren
(brace
id|serial98_fifo_enable
c_func
(paren
id|port
comma
l_int|0
)paren
suffix:semicolon
id|outb
c_func
(paren
id|cmd
comma
id|CMD_8251F
)paren
suffix:semicolon
id|serial98_fifo_enable
c_func
(paren
id|port
comma
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|serial98_mode_set
r_static
r_void
id|serial98_mode_set
c_func
(paren
r_struct
id|uart_port
op_star
id|port
)paren
(brace
id|serial98_cmd_out
c_func
(paren
id|port
comma
id|CMD_DUMMY
)paren
suffix:semicolon
id|serial98_cmd_out
c_func
(paren
id|port
comma
id|CMD_DUMMY
)paren
suffix:semicolon
id|serial98_cmd_out
c_func
(paren
id|port
comma
id|CMD_DUMMY
)paren
suffix:semicolon
id|serial98_cmd_out
c_func
(paren
id|port
comma
id|CMD_RESET
)paren
suffix:semicolon
id|serial98_cmd_out
c_func
(paren
id|port
comma
id|PORT98-&gt;mode
)paren
suffix:semicolon
)brace
DECL|function|serial98_msr_in
r_static
r_int
r_char
id|serial98_msr_in
c_func
(paren
r_struct
id|uart_port
op_star
id|port
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|ms
comma
id|st
suffix:semicolon
r_int
r_int
id|tmp
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|PORT.lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|PORT.type
op_eq
id|PORT_FIFO_PC98
op_logical_or
id|PORT.type
op_eq
id|PORT_VFAST_PC98
)paren
(brace
id|PORT98-&gt;msr
op_assign
id|inb
c_func
(paren
id|PORT.iobase
op_plus
l_int|4
)paren
suffix:semicolon
)brace
r_else
(brace
id|ms
op_assign
id|inb
c_func
(paren
l_int|0x33
)paren
suffix:semicolon
id|st
op_assign
id|inb
c_func
(paren
l_int|0x32
)paren
suffix:semicolon
id|tmp
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|ms
op_amp
l_int|0x20
)paren
)paren
(brace
id|tmp
op_or_assign
id|UART_MSR_DCD
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|ms
op_amp
l_int|0x80
)paren
)paren
(brace
id|tmp
op_or_assign
id|UART_MSR_RI
suffix:semicolon
id|PORT98-&gt;msr
op_or_assign
id|UART_MSR_RI
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|ms
op_amp
l_int|0x40
)paren
)paren
(brace
id|tmp
op_or_assign
id|UART_MSR_CTS
suffix:semicolon
)brace
r_if
c_cond
(paren
id|st
op_amp
l_int|0x80
)paren
(brace
id|tmp
op_or_assign
id|UART_MSR_DSR
suffix:semicolon
)brace
id|PORT98-&gt;msr
op_assign
(paren
(paren
id|PORT98-&gt;msr
op_xor
id|tmp
)paren
op_rshift
l_int|4
)paren
op_or
id|tmp
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|PORT.lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|PORT98-&gt;msr
suffix:semicolon
)brace
DECL|function|serial98_stop_tx
r_static
r_void
id|serial98_stop_tx
c_func
(paren
r_struct
id|uart_port
op_star
id|port
comma
r_int
r_int
id|tty_stop
)paren
(brace
r_int
r_int
id|ier
op_assign
id|inb
c_func
(paren
id|IER1_8251F
)paren
suffix:semicolon
id|ier
op_and_assign
op_complement
(paren
id|INTR_8251_TXRE
op_or
id|INTR_8251_TXEE
)paren
suffix:semicolon
id|outb
c_func
(paren
id|ier
comma
id|IER1_8251F
)paren
suffix:semicolon
)brace
DECL|function|serial98_start_tx
r_static
r_void
id|serial98_start_tx
c_func
(paren
r_struct
id|uart_port
op_star
id|port
comma
r_int
r_int
id|tty_start
)paren
(brace
r_int
r_int
id|ier
op_assign
id|inb
c_func
(paren
id|IER1_8251F
)paren
suffix:semicolon
id|ier
op_or_assign
id|INTR_8251_TXRE
op_or
id|INTR_8251_TXEE
suffix:semicolon
id|outb
c_func
(paren
id|ier
comma
id|IER1_8251F
)paren
suffix:semicolon
)brace
DECL|function|serial98_stop_rx
r_static
r_void
id|serial98_stop_rx
c_func
(paren
r_struct
id|uart_port
op_star
id|port
)paren
(brace
id|PORT.read_status_mask
op_and_assign
op_complement
id|PORT98-&gt;dr
suffix:semicolon
id|outb
c_func
(paren
id|DIS_RXR_INT
comma
id|IER1_CTL
)paren
suffix:semicolon
)brace
DECL|function|serial98_enable_ms
r_static
r_void
id|serial98_enable_ms
c_func
(paren
r_struct
id|uart_port
op_star
id|port
)paren
(brace
id|outb
c_func
(paren
id|PORT98-&gt;ier
op_or
l_int|0x80
comma
id|IER2_8251F
)paren
suffix:semicolon
)brace
DECL|function|serial98_rx_chars
r_static
r_void
id|serial98_rx_chars
c_func
(paren
r_struct
id|uart_port
op_star
id|port
comma
r_int
op_star
id|status
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|tty_struct
op_star
id|tty
op_assign
id|PORT.info-&gt;tty
suffix:semicolon
r_int
r_char
id|ch
suffix:semicolon
r_int
id|max_count
op_assign
l_int|256
suffix:semicolon
r_do
(brace
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|tty-&gt;flip.count
op_ge
id|TTY_FLIPBUF_SIZE
)paren
)paren
(brace
id|tty-&gt;flip.work
dot
id|func
c_func
(paren
(paren
r_void
op_star
)paren
id|tty
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tty-&gt;flip.count
op_ge
id|TTY_FLIPBUF_SIZE
)paren
r_return
suffix:semicolon
singleline_comment|// if TTY_DONT_FLIP is set
)brace
id|ch
op_assign
id|inb
c_func
(paren
id|PORT.iobase
)paren
suffix:semicolon
op_star
id|tty-&gt;flip.char_buf_ptr
op_assign
id|ch
suffix:semicolon
op_star
id|tty-&gt;flip.flag_buf_ptr
op_assign
id|TTY_NORMAL
suffix:semicolon
id|PORT.icount.rx
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
op_star
id|status
op_amp
(paren
id|PORT98-&gt;brk
op_or
id|PORT98-&gt;pe
op_or
id|PORT98-&gt;fe
op_or
id|PORT98-&gt;oe
)paren
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * For statistics only&n;&t;&t;&t; */
r_if
c_cond
(paren
op_star
id|status
op_amp
id|PORT98-&gt;brk
)paren
(brace
op_star
id|status
op_and_assign
op_complement
(paren
id|PORT98-&gt;fe
op_or
id|PORT98-&gt;pe
)paren
suffix:semicolon
id|PORT.icount.brk
op_increment
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t;&t; * We do the SysRQ and SAK checking&n;&t;&t;&t;&t; * here because otherwise the break&n;&t;&t;&t;&t; * may get masked by ignore_status_mask&n;&t;&t;&t;&t; * or read_status_mask.&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|uart_handle_break
c_func
(paren
op_amp
id|PORT
)paren
)paren
r_goto
id|ignore_char
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_star
id|status
op_amp
id|PORT98-&gt;pe
)paren
id|PORT.icount.parity
op_increment
suffix:semicolon
r_else
r_if
c_cond
(paren
op_star
id|status
op_amp
id|PORT98-&gt;fe
)paren
id|PORT.icount.frame
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_star
id|status
op_amp
id|PORT98-&gt;oe
)paren
id|PORT.icount.overrun
op_increment
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * Mask off conditions which should be ingored.&n;&t;&t;&t; */
op_star
id|status
op_and_assign
id|PORT.read_status_mask
suffix:semicolon
macro_line|#ifdef CONFIG_SERIAL98_CONSOLE
r_if
c_cond
(paren
id|PORT.line
op_eq
id|PORT.cons-&gt;index
)paren
(brace
multiline_comment|/* Recover the break flag from console xmit */
op_star
id|status
op_or_assign
id|PORT98-&gt;lsr_break_flag
suffix:semicolon
id|PORT98-&gt;lsr_break_flag
op_assign
l_int|0
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
op_star
id|status
op_amp
id|PORT98-&gt;brk
)paren
(brace
op_star
id|tty-&gt;flip.flag_buf_ptr
op_assign
id|TTY_BREAK
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_star
id|status
op_amp
id|PORT98-&gt;pe
)paren
op_star
id|tty-&gt;flip.flag_buf_ptr
op_assign
id|TTY_PARITY
suffix:semicolon
r_else
r_if
c_cond
(paren
op_star
id|status
op_amp
id|PORT98-&gt;fe
)paren
op_star
id|tty-&gt;flip.flag_buf_ptr
op_assign
id|TTY_FRAME
suffix:semicolon
)brace
r_if
c_cond
(paren
id|uart_handle_sysrq_char
c_func
(paren
op_amp
id|PORT
comma
id|ch
comma
id|regs
)paren
)paren
r_goto
id|ignore_char
suffix:semicolon
r_if
c_cond
(paren
(paren
op_star
id|status
op_amp
id|PORT.ignore_status_mask
)paren
op_eq
l_int|0
)paren
(brace
id|tty-&gt;flip.flag_buf_ptr
op_increment
suffix:semicolon
id|tty-&gt;flip.char_buf_ptr
op_increment
suffix:semicolon
id|tty-&gt;flip.count
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
op_star
id|status
op_amp
id|PORT98-&gt;oe
)paren
op_logical_and
id|tty-&gt;flip.count
OL
id|TTY_FLIPBUF_SIZE
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * Overrun is special, since it&squot;s reported&n;&t;&t;&t; * immediately, and doesn&squot;t affect the current&n;&t;&t;&t; * character.&n;&t;&t;&t; */
op_star
id|tty-&gt;flip.flag_buf_ptr
op_assign
id|TTY_OVERRUN
suffix:semicolon
id|tty-&gt;flip.flag_buf_ptr
op_increment
suffix:semicolon
id|tty-&gt;flip.char_buf_ptr
op_increment
suffix:semicolon
id|tty-&gt;flip.count
op_increment
suffix:semicolon
)brace
id|ignore_char
suffix:colon
op_star
id|status
op_assign
id|inb
c_func
(paren
id|PORT.iobase
op_plus
l_int|2
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
op_star
id|status
op_amp
id|PORT98-&gt;rxchk
)paren
op_logical_and
(paren
id|max_count
op_decrement
OG
l_int|0
)paren
)paren
suffix:semicolon
id|tty_flip_buffer_push
c_func
(paren
id|tty
)paren
suffix:semicolon
)brace
DECL|function|serial98_tx_chars
r_static
r_void
id|serial98_tx_chars
c_func
(paren
r_struct
id|uart_port
op_star
id|port
)paren
(brace
r_struct
id|circ_buf
op_star
id|xmit
op_assign
op_amp
id|PORT.info-&gt;xmit
suffix:semicolon
r_int
id|count
suffix:semicolon
r_if
c_cond
(paren
id|PORT.x_char
)paren
(brace
id|outb
c_func
(paren
id|PORT.x_char
comma
id|PORT.iobase
)paren
suffix:semicolon
id|PORT.icount.tx
op_increment
suffix:semicolon
id|PORT.x_char
op_assign
l_int|0
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|uart_circ_empty
c_func
(paren
id|xmit
)paren
op_logical_or
id|uart_tx_stopped
c_func
(paren
op_amp
id|PORT
)paren
)paren
(brace
id|serial98_stop_tx
c_func
(paren
id|port
comma
l_int|0
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|count
op_assign
id|PORT.fifosize
suffix:semicolon
r_do
(brace
id|outb
c_func
(paren
id|xmit-&gt;buf
(braket
id|xmit-&gt;tail
)braket
comma
id|PORT.iobase
)paren
suffix:semicolon
id|xmit-&gt;tail
op_assign
(paren
id|xmit-&gt;tail
op_plus
l_int|1
)paren
op_amp
(paren
id|UART_XMIT_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
id|PORT.icount.tx
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|uart_circ_empty
c_func
(paren
id|xmit
)paren
)paren
r_break
suffix:semicolon
)brace
r_while
c_loop
(paren
op_decrement
id|count
OG
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|uart_circ_chars_pending
c_func
(paren
id|xmit
)paren
OL
id|WAKEUP_CHARS
)paren
id|uart_write_wakeup
c_func
(paren
op_amp
id|PORT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|uart_circ_empty
c_func
(paren
id|xmit
)paren
)paren
id|serial98_stop_tx
c_func
(paren
op_amp
id|PORT
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|serial98_modem_status
r_static
r_void
id|serial98_modem_status
c_func
(paren
r_struct
id|uart_port
op_star
id|port
)paren
(brace
r_int
id|status
suffix:semicolon
id|status
op_assign
id|serial98_msr_in
c_func
(paren
id|port
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_amp
id|UART_MSR_ANY_DELTA
)paren
op_eq
l_int|0
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|UART_MSR_TERI
)paren
id|PORT.icount.rng
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|UART_MSR_DDSR
)paren
id|PORT.icount.dsr
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|UART_MSR_DDCD
)paren
id|uart_handle_dcd_change
c_func
(paren
op_amp
id|PORT
comma
id|status
op_amp
id|UART_MSR_DCD
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|UART_MSR_DCTS
)paren
id|uart_handle_cts_change
c_func
(paren
op_amp
id|PORT
comma
id|status
op_amp
id|UART_MSR_CTS
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|PORT.info-&gt;delta_msr_wait
)paren
suffix:semicolon
)brace
DECL|function|serial98_int
r_static
r_void
id|serial98_int
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|port
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
r_int
id|status
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|PORT.lock
)paren
suffix:semicolon
id|status
op_assign
id|inb
c_func
(paren
id|PORT.iobase
op_plus
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|PORT98-&gt;rxrdy
)paren
(brace
id|serial98_rx_chars
c_func
(paren
id|port
comma
op_amp
id|status
comma
id|regs
)paren
suffix:semicolon
)brace
id|serial98_modem_status
c_func
(paren
id|port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|PORT98-&gt;txrdy
)paren
(brace
id|serial98_tx_chars
c_func
(paren
id|port
)paren
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|PORT.lock
)paren
suffix:semicolon
)brace
DECL|function|serial98_tx_empty
r_static
r_int
r_int
id|serial98_tx_empty
c_func
(paren
r_struct
id|uart_port
op_star
id|port
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|PORT.lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inb
c_func
(paren
id|PORT.iobase
op_plus
l_int|2
)paren
op_amp
id|PORT98-&gt;txemp
)paren
id|ret
op_assign
id|TIOCSER_TEMT
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|PORT.lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|serial98_get_mctrl
r_static
r_int
r_int
id|serial98_get_mctrl
c_func
(paren
r_struct
id|uart_port
op_star
id|port
)paren
(brace
r_int
r_char
id|status
suffix:semicolon
r_int
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
id|status
op_assign
id|serial98_msr_in
c_func
(paren
id|port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|UART_MSR_DCD
)paren
id|ret
op_or_assign
id|TIOCM_CAR
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|UART_MSR_RI
)paren
id|ret
op_or_assign
id|TIOCM_RNG
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|UART_MSR_DSR
)paren
id|ret
op_or_assign
id|TIOCM_DSR
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|UART_MSR_CTS
)paren
id|ret
op_or_assign
id|TIOCM_CTS
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|serial98_set_mctrl
r_static
r_void
id|serial98_set_mctrl
c_func
(paren
r_struct
id|uart_port
op_star
id|port
comma
r_int
r_int
id|mctrl
)paren
(brace
id|PORT98-&gt;cmd
op_and_assign
l_int|0xdd
suffix:semicolon
r_if
c_cond
(paren
id|mctrl
op_amp
id|TIOCM_RTS
)paren
id|PORT98-&gt;cmd
op_or_assign
id|CMD_RTS
suffix:semicolon
r_if
c_cond
(paren
id|mctrl
op_amp
id|TIOCM_DTR
)paren
id|PORT98-&gt;cmd
op_or_assign
id|CMD_DTR
suffix:semicolon
id|serial98_cmd_out
c_func
(paren
id|port
comma
id|PORT98-&gt;cmd
)paren
suffix:semicolon
)brace
DECL|function|serial98_break_ctl
r_static
r_void
id|serial98_break_ctl
c_func
(paren
r_struct
id|uart_port
op_star
id|port
comma
r_int
id|break_state
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|PORT.lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|break_state
op_eq
op_minus
l_int|1
)paren
id|PORT98-&gt;cmd
op_or_assign
id|CMD_BREAK
suffix:semicolon
r_else
id|PORT98-&gt;cmd
op_and_assign
op_complement
id|CMD_BREAK
suffix:semicolon
id|serial98_cmd_out
c_func
(paren
id|port
comma
id|PORT98-&gt;cmd
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|PORT.lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|serial98_startup
r_static
r_int
id|serial98_startup
c_func
(paren
r_struct
id|uart_port
op_star
id|port
)paren
(brace
r_int
id|retval
suffix:semicolon
r_if
c_cond
(paren
id|PORT.type
op_eq
id|PORT_8251_PC98
)paren
(brace
multiline_comment|/* Wake up UART */
id|PORT98-&gt;mode
op_assign
l_int|0xfc
suffix:semicolon
id|serial98_mode_set
c_func
(paren
id|port
)paren
suffix:semicolon
id|outb
c_func
(paren
id|DIS_RXR_INT
comma
id|IER1_CTL
)paren
suffix:semicolon
id|outb
c_func
(paren
id|DIS_TXE_INT
comma
id|IER1_CTL
)paren
suffix:semicolon
id|outb
c_func
(paren
id|DIS_TXR_INT
comma
id|IER1_CTL
)paren
suffix:semicolon
id|PORT98-&gt;mode
op_assign
l_int|0
suffix:semicolon
id|serial98_mode_set
c_func
(paren
id|port
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Clear the FIFO buffers and disable them.&n;&t; * (they will be reeanbled in set_termios())&n;&t; */
r_if
c_cond
(paren
id|PORT.type
op_eq
id|PORT_FIFO_PC98
op_logical_or
id|PORT.type
op_eq
id|PORT_VFAST_PC98
)paren
(brace
id|outb
c_func
(paren
id|UART_FCR_ENABLE_FIFO
comma
id|FCR_8251F
)paren
suffix:semicolon
id|outb
c_func
(paren
(paren
id|UART_FCR_ENABLE_FIFO
op_or
id|UART_FCR_CLEAR_RCVR
op_or
id|UART_FCR_CLEAR_XMIT
)paren
comma
id|FCR_8251F
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|FCR_8251F
)paren
suffix:semicolon
)brace
multiline_comment|/* Clear the interrupt registers. */
id|inb
c_func
(paren
l_int|0x30
)paren
suffix:semicolon
id|inb
c_func
(paren
l_int|0x32
)paren
suffix:semicolon
r_if
c_cond
(paren
id|PORT.type
op_eq
id|PORT_FIFO_PC98
op_logical_or
id|PORT.type
op_eq
id|PORT_VFAST_PC98
)paren
(brace
id|inb
c_func
(paren
id|PORT.iobase
)paren
suffix:semicolon
id|inb
c_func
(paren
id|PORT.iobase
op_plus
l_int|2
)paren
suffix:semicolon
id|inb
c_func
(paren
id|PORT.iobase
op_plus
l_int|4
)paren
suffix:semicolon
id|inb
c_func
(paren
id|PORT.iobase
op_plus
l_int|6
)paren
suffix:semicolon
)brace
multiline_comment|/* Allocate the IRQ */
id|retval
op_assign
id|request_irq
c_func
(paren
id|PORT.irq
comma
id|serial98_int
comma
l_int|0
comma
id|serial98_reg.driver_name
comma
id|port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
r_return
id|retval
suffix:semicolon
multiline_comment|/*&n;&t; * Now, initialize the UART&n;&t; */
id|PORT98-&gt;mode
op_assign
l_int|0x4e
suffix:semicolon
id|serial98_mode_set
c_func
(paren
id|port
)paren
suffix:semicolon
id|PORT98-&gt;cmd
op_assign
l_int|0x15
suffix:semicolon
id|serial98_cmd_out
c_func
(paren
id|port
comma
id|PORT98-&gt;cmd
)paren
suffix:semicolon
id|PORT98-&gt;cmd
op_assign
l_int|0x05
suffix:semicolon
multiline_comment|/*&n;&t; * Finally, enable interrupts&n;&t; */
id|outb
c_func
(paren
l_int|0x00
comma
id|IER2_8251F
)paren
suffix:semicolon
id|outb
c_func
(paren
id|ENA_RXR_INT
comma
id|IER1_CTL
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * And clear the interrupt registers again for luck.&n;&t; */
id|inb
c_func
(paren
l_int|0x30
)paren
suffix:semicolon
id|inb
c_func
(paren
l_int|0x32
)paren
suffix:semicolon
r_if
c_cond
(paren
id|PORT.type
op_eq
id|PORT_FIFO_PC98
op_logical_or
id|PORT.type
op_eq
id|PORT_VFAST_PC98
)paren
(brace
id|inb
c_func
(paren
id|PORT.iobase
)paren
suffix:semicolon
id|inb
c_func
(paren
id|PORT.iobase
op_plus
l_int|2
)paren
suffix:semicolon
id|inb
c_func
(paren
id|PORT.iobase
op_plus
l_int|4
)paren
suffix:semicolon
id|inb
c_func
(paren
id|PORT.iobase
op_plus
l_int|6
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|serial98_shutdown
r_static
r_void
id|serial98_shutdown
c_func
(paren
r_struct
id|uart_port
op_star
id|port
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/*&n;&t; * disable all interrupts&n;&t; */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|PORT.lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|PORT.type
op_eq
id|PORT_VFAST_PC98
)paren
id|outb
c_func
(paren
l_int|0
comma
id|VFAST_8251F
)paren
suffix:semicolon
multiline_comment|/* V.FAST mode off */
multiline_comment|/* disnable all modem status interrupt */
id|outb
c_func
(paren
l_int|0x80
comma
id|IER2_8251F
)paren
suffix:semicolon
multiline_comment|/* disnable TX/RX interrupt */
id|outb
c_func
(paren
l_int|0x00
comma
id|IER2_8251F
)paren
suffix:semicolon
id|outb
c_func
(paren
id|DIS_RXR_INT
comma
id|IER1_CTL
)paren
suffix:semicolon
id|outb
c_func
(paren
id|DIS_TXE_INT
comma
id|IER1_CTL
)paren
suffix:semicolon
id|outb
c_func
(paren
id|DIS_TXR_INT
comma
id|IER1_CTL
)paren
suffix:semicolon
id|PORT98-&gt;ier
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|PORT.lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Free the interrupt&n;&t; */
id|free_irq
c_func
(paren
id|PORT.irq
comma
id|port
)paren
suffix:semicolon
multiline_comment|/* disable break condition and disable the port */
id|serial98_mode_set
c_func
(paren
id|port
)paren
suffix:semicolon
multiline_comment|/* disable FIFO&squot;s */
r_if
c_cond
(paren
id|PORT.type
op_eq
id|PORT_FIFO_PC98
op_logical_or
id|PORT.type
op_eq
id|PORT_VFAST_PC98
)paren
(brace
id|outb
c_func
(paren
(paren
id|UART_FCR_ENABLE_FIFO
op_or
id|UART_FCR_CLEAR_RCVR
op_or
id|UART_FCR_CLEAR_XMIT
)paren
comma
id|FCR_8251F
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|FCR_8251F
)paren
suffix:semicolon
)brace
id|inb
c_func
(paren
id|PORT.iobase
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|serial98_set_termios
id|serial98_set_termios
c_func
(paren
r_struct
id|uart_port
op_star
id|port
comma
r_struct
id|termios
op_star
id|termios
comma
r_struct
id|termios
op_star
id|old
)paren
(brace
r_int
r_char
id|stopbit
comma
id|cval
comma
id|fcr
op_assign
l_int|0
comma
id|ier
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|baud
comma
id|quot
suffix:semicolon
id|stopbit
op_assign
l_int|0x80
suffix:semicolon
r_switch
c_cond
(paren
id|termios-&gt;c_cflag
op_amp
id|CSIZE
)paren
(brace
r_case
id|CS5
suffix:colon
id|cval
op_assign
l_int|0x42
suffix:semicolon
id|stopbit
op_assign
l_int|0xc0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS6
suffix:colon
id|cval
op_assign
l_int|0x46
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS7
suffix:colon
id|cval
op_assign
l_int|0x4a
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_case
id|CS8
suffix:colon
id|cval
op_assign
l_int|0x4e
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|termios-&gt;c_cflag
op_amp
id|CSTOPB
)paren
id|cval
op_xor_assign
id|stopbit
suffix:semicolon
r_if
c_cond
(paren
id|termios-&gt;c_cflag
op_amp
id|PARENB
)paren
id|cval
op_or_assign
l_int|0x10
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|termios-&gt;c_cflag
op_amp
id|PARODD
)paren
)paren
id|cval
op_or_assign
l_int|0x20
suffix:semicolon
multiline_comment|/*&n;&t; * Ask the core to calculate the divisor for us.&n;&t; */
id|baud
op_assign
id|uart_get_baud_rate
c_func
(paren
id|port
comma
id|termios
comma
id|old
comma
l_int|0
comma
id|port-&gt;uartclk
op_div
l_int|16
)paren
suffix:semicolon
id|quot
op_assign
id|uart_get_divisor
c_func
(paren
id|port
comma
id|baud
)paren
suffix:semicolon
r_if
c_cond
(paren
id|PORT.type
op_eq
id|PORT_FIFO_PC98
op_logical_or
id|PORT.type
op_eq
id|PORT_VFAST_PC98
)paren
(brace
r_if
c_cond
(paren
(paren
id|PORT.uartclk
op_div
id|quot
)paren
OL
(paren
l_int|2400
op_star
l_int|16
)paren
)paren
id|fcr
op_assign
id|UART_FCR_ENABLE_FIFO
op_or
id|UART_FCR_TRIGGER_1
suffix:semicolon
r_else
id|fcr
op_assign
id|UART_FCR_ENABLE_FIFO
op_or
id|UART_FCR_TRIGGER_8
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Ok, we&squot;re now changing the port state.  Do it with&n;&t; * interrupts disabled.&n;&t; */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|PORT.lock
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Update the per-port timeout.&n;&t; */
id|uart_update_timeout
c_func
(paren
id|port
comma
id|termios-&gt;c_cflag
comma
id|baud
)paren
suffix:semicolon
id|PORT.read_status_mask
op_assign
id|PORT98-&gt;oe
op_or
id|PORT98-&gt;txemp
op_or
id|PORT98-&gt;dr
suffix:semicolon
r_if
c_cond
(paren
id|termios-&gt;c_iflag
op_amp
id|INPCK
)paren
id|PORT.read_status_mask
op_or_assign
id|PORT98-&gt;fe
op_or
id|PORT98-&gt;pe
suffix:semicolon
r_if
c_cond
(paren
id|termios-&gt;c_iflag
op_amp
(paren
id|BRKINT
op_or
id|PARMRK
)paren
)paren
id|PORT.read_status_mask
op_or_assign
id|PORT98-&gt;brk
suffix:semicolon
multiline_comment|/*&n;&t; * Characters to ignore&n;&t; */
id|PORT.ignore_status_mask
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|termios-&gt;c_iflag
op_amp
id|IGNPAR
)paren
id|PORT.ignore_status_mask
op_or_assign
id|PORT98-&gt;fe
op_or
id|PORT98-&gt;pe
suffix:semicolon
r_if
c_cond
(paren
id|termios-&gt;c_iflag
op_amp
id|IGNBRK
)paren
(brace
id|PORT.ignore_status_mask
op_or_assign
id|PORT98-&gt;brk
suffix:semicolon
multiline_comment|/*&n;&t;&t; * If we&squot;re ignoring parity and break indicators,&n;&t;&t; * ignore overruns too (for real raw support).&n;&t;&t; */
r_if
c_cond
(paren
id|termios-&gt;c_iflag
op_amp
id|IGNPAR
)paren
id|PORT.ignore_status_mask
op_or_assign
id|PORT98-&gt;oe
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * ignore all characters if CREAD is not set&n;&t; */
r_if
c_cond
(paren
(paren
id|termios-&gt;c_cflag
op_amp
id|CREAD
)paren
op_eq
l_int|0
)paren
id|PORT.ignore_status_mask
op_or_assign
id|PORT98-&gt;dr
suffix:semicolon
multiline_comment|/*&n;&t; * CTS flow control flag and modem status interrupts&n;&t; */
r_if
c_cond
(paren
id|PORT.flags
op_amp
id|UPF_HARDPPS_CD
)paren
id|ier
op_or_assign
l_int|0x80
suffix:semicolon
multiline_comment|/* enable modem status interrupt */
r_if
c_cond
(paren
id|termios-&gt;c_cflag
op_amp
id|CRTSCTS
)paren
(brace
id|ier
op_or_assign
l_int|0x08
suffix:semicolon
multiline_comment|/* enable CTS interrupt */
id|ier
op_or_assign
l_int|0x80
suffix:semicolon
multiline_comment|/* enable modem status interrupt */
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|termios-&gt;c_cflag
op_amp
id|CLOCAL
)paren
)paren
(brace
id|ier
op_or_assign
l_int|0x20
suffix:semicolon
multiline_comment|/* enable CD interrupt */
id|ier
op_or_assign
l_int|0x80
suffix:semicolon
multiline_comment|/* enable modem status interrupt */
)brace
id|PORT98-&gt;ier
op_assign
id|ier
suffix:semicolon
id|PORT98-&gt;mode
op_assign
id|cval
suffix:semicolon
id|serial98_mode_set
c_func
(paren
id|port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|PORT.type
op_eq
id|PORT_VFAST_PC98
op_logical_and
id|quot
op_le
l_int|48
)paren
(brace
id|quot
op_div_assign
l_int|4
suffix:semicolon
r_if
c_cond
(paren
id|quot
OL
l_int|1
)paren
id|quot
op_assign
l_int|1
suffix:semicolon
id|outb
c_func
(paren
id|quot
op_or
id|VFAST_ENABLE
comma
id|VFAST_8251F
)paren
suffix:semicolon
)brace
r_else
(brace
id|quot
op_div_assign
l_int|3
suffix:semicolon
r_if
c_cond
(paren
id|quot
OL
l_int|1
)paren
id|quot
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|PORT.type
op_eq
id|PORT_VFAST_PC98
)paren
id|outb
c_func
(paren
l_int|0
comma
id|VFAST_8251F
)paren
suffix:semicolon
multiline_comment|/* V.FAST mode off */
id|outb
c_func
(paren
l_int|0xb6
comma
l_int|0x77
)paren
suffix:semicolon
id|outb
c_func
(paren
id|quot
op_amp
l_int|0xff
comma
l_int|0x75
)paren
suffix:semicolon
multiline_comment|/* LS of divisor */
id|outb
c_func
(paren
id|quot
op_rshift
l_int|8
comma
l_int|0x75
)paren
suffix:semicolon
multiline_comment|/* MS of divisor */
)brace
r_if
c_cond
(paren
id|fcr
op_amp
id|UART_FCR_ENABLE_FIFO
)paren
(brace
id|outb
c_func
(paren
id|UART_FCR_ENABLE_FIFO
comma
id|FCR_8251F
)paren
suffix:semicolon
id|outb
c_func
(paren
id|fcr
comma
id|FCR_8251F
)paren
suffix:semicolon
)brace
multiline_comment|/* enable RX/TX */
id|PORT98-&gt;cmd
op_assign
l_int|0x15
suffix:semicolon
id|serial98_cmd_out
c_func
(paren
id|port
comma
id|PORT98-&gt;cmd
)paren
suffix:semicolon
id|PORT98-&gt;cmd
op_assign
l_int|0x05
suffix:semicolon
multiline_comment|/* enable interrupts */
id|outb
c_func
(paren
l_int|0x00
comma
id|IER2_8251F
)paren
suffix:semicolon
id|outb
c_func
(paren
id|ENA_RXR_INT
comma
id|IER1_CTL
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|PORT.lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|serial98_type
r_static
r_const
r_char
op_star
id|serial98_type
c_func
(paren
r_struct
id|uart_port
op_star
id|port
)paren
(brace
r_char
op_star
id|p
suffix:semicolon
r_switch
c_cond
(paren
id|PORT.type
)paren
(brace
r_case
id|PORT_8251_PC98
suffix:colon
id|p
op_assign
l_string|&quot;PC98 onboard legacy 8251&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PORT_19K_PC98
suffix:colon
id|p
op_assign
l_string|&quot;PC98 onboard max 19200bps&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PORT_FIFO_PC98
suffix:colon
id|p
op_assign
l_string|&quot;PC98 onboard with FIFO&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PORT_VFAST_PC98
suffix:colon
id|p
op_assign
l_string|&quot;PC98 onboard V.FAST&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PORT_PC9861
suffix:colon
id|p
op_assign
l_string|&quot;PC-9861K RS-232C ext. board&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|PORT_PC9801_101
suffix:colon
id|p
op_assign
l_string|&quot;PC-9801-101 RS-232C ext. board&quot;
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
l_int|NULL
suffix:semicolon
)brace
id|sprintf
c_func
(paren
id|type_str
comma
l_string|&quot;%s  Clock %dMHz&quot;
comma
id|p
comma
id|serial98_clk
)paren
suffix:semicolon
r_return
id|type_str
suffix:semicolon
)brace
multiline_comment|/* Release the region(s) being used by &squot;port&squot; */
DECL|function|serial98_release_port
r_static
r_void
id|serial98_release_port
c_func
(paren
r_struct
id|uart_port
op_star
id|port
)paren
(brace
r_switch
c_cond
(paren
id|PORT.type
)paren
(brace
r_case
id|PORT_VFAST_PC98
suffix:colon
id|release_region
c_func
(paren
id|PORT.iobase
op_plus
l_int|0xa
comma
l_int|1
)paren
suffix:semicolon
r_case
id|PORT_FIFO_PC98
suffix:colon
id|release_region
c_func
(paren
id|PORT.iobase
op_plus
l_int|8
comma
l_int|1
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|PORT.iobase
op_plus
l_int|6
comma
l_int|1
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|PORT.iobase
op_plus
l_int|4
comma
l_int|1
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|PORT.iobase
op_plus
l_int|2
comma
l_int|1
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|PORT.iobase
comma
l_int|1
)paren
suffix:semicolon
r_case
id|PORT_19K_PC98
suffix:colon
id|release_region
c_func
(paren
id|SERIAL98_EXT
comma
l_int|1
)paren
suffix:semicolon
id|release_region
c_func
(paren
l_int|0x34
comma
l_int|1
)paren
suffix:semicolon
r_case
id|PORT_8251_PC98
suffix:colon
id|release_region
c_func
(paren
l_int|0x32
comma
l_int|1
)paren
suffix:semicolon
id|release_region
c_func
(paren
l_int|0x30
comma
l_int|1
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Request the region(s) being used by &squot;port&squot; */
DECL|macro|REQ_REGION98
mdefine_line|#define REQ_REGION98(base) (request_region((base), 1, serial98_reg.driver_name))
DECL|function|serial98_request_region
r_static
r_int
id|serial98_request_region
c_func
(paren
r_int
r_int
id|type
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|REQ_REGION98
c_func
(paren
l_int|0x30
)paren
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
r_if
c_cond
(paren
id|REQ_REGION98
c_func
(paren
l_int|0x32
)paren
)paren
(brace
r_if
c_cond
(paren
id|type
op_eq
id|PORT_8251_PC98
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|REQ_REGION98
c_func
(paren
l_int|0x34
)paren
)paren
(brace
r_if
c_cond
(paren
id|REQ_REGION98
c_func
(paren
id|SERIAL98_EXT
)paren
)paren
(brace
r_int
r_int
id|base
suffix:semicolon
r_if
c_cond
(paren
id|type
op_eq
id|PORT_19K_PC98
)paren
r_return
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|base
op_assign
l_int|0x130
suffix:semicolon
id|base
op_le
l_int|0x138
suffix:semicolon
id|base
op_add_assign
l_int|2
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|REQ_REGION98
c_func
(paren
id|base
)paren
)paren
(brace
id|base
op_sub_assign
l_int|2
suffix:semicolon
r_goto
id|err
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|type
op_eq
id|PORT_FIFO_PC98
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|type
op_eq
id|PORT_VFAST_PC98
)paren
(brace
r_if
c_cond
(paren
id|REQ_REGION98
c_func
(paren
l_int|0x13a
)paren
)paren
r_return
l_int|0
suffix:semicolon
)brace
id|err
suffix:colon
r_while
c_loop
(paren
id|base
op_ge
l_int|0x130
)paren
(brace
id|release_region
c_func
(paren
id|base
comma
l_int|1
)paren
suffix:semicolon
id|base
op_sub_assign
l_int|2
suffix:semicolon
)brace
id|release_region
c_func
(paren
id|SERIAL98_EXT
comma
l_int|1
)paren
suffix:semicolon
)brace
id|release_region
c_func
(paren
l_int|0x34
comma
l_int|1
)paren
suffix:semicolon
)brace
id|release_region
c_func
(paren
l_int|0x32
comma
l_int|1
)paren
suffix:semicolon
)brace
id|release_region
c_func
(paren
l_int|0x30
comma
l_int|1
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
DECL|function|serial98_request_port
r_static
r_int
id|serial98_request_port
c_func
(paren
r_struct
id|uart_port
op_star
id|port
)paren
(brace
r_return
id|serial98_request_region
c_func
(paren
id|PORT.type
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Configure/autoconfigure the port.&n; */
DECL|function|serial98_config_port
r_static
r_void
id|serial98_config_port
c_func
(paren
r_struct
id|uart_port
op_star
id|port
comma
r_int
id|flags
)paren
(brace
r_if
c_cond
(paren
id|flags
op_amp
id|UART_CONFIG_TYPE
)paren
id|PORT.type
op_assign
id|PORT98-&gt;type
suffix:semicolon
)brace
multiline_comment|/*&n; * verify the new serial_struct (for TIOCSSERIAL).&n; */
DECL|function|serial98_verify_port
r_static
r_int
id|serial98_verify_port
c_func
(paren
r_struct
id|uart_port
op_star
id|port
comma
r_struct
id|serial_struct
op_star
id|ser
)paren
(brace
r_switch
c_cond
(paren
id|ser-&gt;type
)paren
(brace
r_case
id|PORT_VFAST_PC98
suffix:colon
r_case
id|PORT_FIFO_PC98
suffix:colon
r_case
id|PORT_19K_PC98
suffix:colon
r_case
id|PORT_8251_PC98
suffix:colon
multiline_comment|/* not implemented yet&n;&t;&t;case PORT_PC9861:&n;&t;&t;case PORT_PC9801_101:&n;&t;&t;*/
r_case
id|PORT_UNKNOWN
suffix:colon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ser-&gt;irq
OL
l_int|0
op_logical_or
id|ser-&gt;irq
op_ge
id|NR_IRQS
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|ser-&gt;baud_base
OL
l_int|9600
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|serial98_ops
r_static
r_struct
id|uart_ops
id|serial98_ops
op_assign
(brace
dot
id|tx_empty
op_assign
id|serial98_tx_empty
comma
dot
id|set_mctrl
op_assign
id|serial98_set_mctrl
comma
dot
id|get_mctrl
op_assign
id|serial98_get_mctrl
comma
dot
id|stop_tx
op_assign
id|serial98_stop_tx
comma
dot
id|start_tx
op_assign
id|serial98_start_tx
comma
dot
id|stop_rx
op_assign
id|serial98_stop_rx
comma
dot
id|enable_ms
op_assign
id|serial98_enable_ms
comma
dot
id|break_ctl
op_assign
id|serial98_break_ctl
comma
dot
id|startup
op_assign
id|serial98_startup
comma
dot
id|shutdown
op_assign
id|serial98_shutdown
comma
dot
id|set_termios
op_assign
id|serial98_set_termios
comma
dot
id|type
op_assign
id|serial98_type
comma
dot
id|release_port
op_assign
id|serial98_release_port
comma
dot
id|request_port
op_assign
id|serial98_request_port
comma
dot
id|config_port
op_assign
id|serial98_config_port
comma
dot
id|verify_port
op_assign
id|serial98_verify_port
comma
)brace
suffix:semicolon
DECL|variable|serial98_ports
r_static
r_struct
id|serial98_port
id|serial98_ports
(braket
id|SERIAL98_NR
)braket
op_assign
(brace
(brace
dot
id|port
op_assign
(brace
dot
id|iobase
op_assign
l_int|0x30
comma
dot
id|iotype
op_assign
id|SERIAL_IO_PORT
comma
dot
id|irq
op_assign
l_int|4
comma
dot
id|fifosize
op_assign
l_int|1
comma
dot
id|ops
op_assign
op_amp
id|serial98_ops
comma
dot
id|flags
op_assign
id|ASYNC_BOOT_AUTOCONF
comma
dot
id|line
op_assign
l_int|0
comma
)brace
comma
dot
id|rxchk
op_assign
id|STAT_8251_RXRDY
comma
dot
id|txemp
op_assign
id|STAT_8251_TXEMP
comma
dot
id|txrdy
op_assign
id|STAT_8251_TXRDY
comma
dot
id|rxrdy
op_assign
id|STAT_8251_RXRDY
comma
dot
id|brk
op_assign
id|STAT_8251_BRK
comma
dot
id|fe
op_assign
id|STAT_8251_FER
comma
dot
id|oe
op_assign
id|STAT_8251_OER
comma
dot
id|pe
op_assign
id|STAT_8251_PER
comma
dot
id|dr
op_assign
id|STAT_8251_DSR
comma
)brace
comma
)brace
suffix:semicolon
macro_line|#ifdef CONFIG_SERIAL98_CONSOLE
DECL|macro|BOTH_EMPTY
mdefine_line|#define BOTH_EMPTY (PORT98-&gt;txemp | PORT98-&gt;txrdy)
multiline_comment|/*&n; *&t;Wait for transmitter &amp; holding register to empty&n; */
DECL|function|wait_for_xmitr
r_static
r_inline
r_void
id|wait_for_xmitr
c_func
(paren
r_struct
id|uart_port
op_star
id|port
)paren
(brace
r_int
r_int
id|status
comma
id|tmout
op_assign
l_int|10000
suffix:semicolon
multiline_comment|/* Wait up to 10ms for the character(s) to be sent. */
r_do
(brace
id|status
op_assign
id|inb
c_func
(paren
id|PORT.iobase
op_plus
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|PORT98-&gt;brk
)paren
id|PORT98-&gt;lsr_break_flag
op_assign
id|PORT98-&gt;brk
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|tmout
op_eq
l_int|0
)paren
r_break
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|status
op_amp
id|BOTH_EMPTY
)paren
op_ne
id|BOTH_EMPTY
)paren
suffix:semicolon
multiline_comment|/* Wait up to 1s for flow control if necessary */
r_if
c_cond
(paren
id|PORT.flags
op_amp
id|UPF_CONS_FLOW
)paren
(brace
id|tmout
op_assign
l_int|1000000
suffix:semicolon
r_while
c_loop
(paren
op_decrement
id|tmout
op_logical_and
(paren
(paren
id|serial98_msr_in
c_func
(paren
id|port
)paren
op_amp
id|UART_MSR_CTS
)paren
op_eq
l_int|0
)paren
)paren
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; *&t;Print a string to the serial port trying not to disturb&n; *&t;any possible real use of the port...&n; *&n; *&t;The console_lock must be held when we get here.&n; */
r_static
r_void
DECL|function|serial98_console_write
id|serial98_console_write
c_func
(paren
r_struct
id|console
op_star
id|co
comma
r_const
r_char
op_star
id|s
comma
r_int
r_int
id|count
)paren
(brace
r_struct
id|uart_port
op_star
id|port
op_assign
(paren
r_struct
id|uart_port
op_star
)paren
op_amp
id|serial98_ports
(braket
id|co-&gt;index
)braket
suffix:semicolon
r_int
r_int
id|ier1
comma
id|ier2
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/*&n;&t; *&t;First save the UER then disable the interrupts&n;&t; */
id|ier1
op_assign
id|inb
c_func
(paren
id|IER1_8251F
)paren
suffix:semicolon
id|ier2
op_assign
id|inb
c_func
(paren
id|IER2_8251F
)paren
suffix:semicolon
multiline_comment|/* disnable all modem status interrupt */
id|outb
c_func
(paren
l_int|0x80
comma
id|IER2_8251F
)paren
suffix:semicolon
multiline_comment|/* disnable TX/RX interrupt */
id|outb
c_func
(paren
l_int|0x00
comma
id|IER2_8251F
)paren
suffix:semicolon
id|outb
c_func
(paren
id|DIS_RXR_INT
comma
id|IER1_CTL
)paren
suffix:semicolon
id|outb
c_func
(paren
id|DIS_TXE_INT
comma
id|IER1_CTL
)paren
suffix:semicolon
id|outb
c_func
(paren
id|DIS_TXR_INT
comma
id|IER1_CTL
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Now, do each character&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
suffix:semicolon
id|i
op_increment
comma
id|s
op_increment
)paren
(brace
id|wait_for_xmitr
c_func
(paren
id|port
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; *&t;Send the character out.&n;&t;&t; *&t;If a LF, also do CR...&n;&t;&t; */
id|outb
c_func
(paren
op_star
id|s
comma
id|PORT.iobase
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|s
op_eq
l_int|10
)paren
(brace
id|wait_for_xmitr
c_func
(paren
id|port
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|13
comma
id|PORT.iobase
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t; *&t;Finally, wait for transmitter to become empty&n;&t; *&t;and restore the IER&n;&t; */
id|wait_for_xmitr
c_func
(paren
id|port
)paren
suffix:semicolon
multiline_comment|/* restore TX/RX interrupt */
id|outb
c_func
(paren
l_int|0x00
comma
id|IER2_8251F
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ier1
op_amp
l_int|0x01
)paren
id|outb
c_func
(paren
id|ENA_RXR_INT
comma
id|IER1_CTL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ier1
op_amp
l_int|0x02
)paren
id|outb
c_func
(paren
id|ENA_TXE_INT
comma
id|IER1_CTL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ier1
op_amp
l_int|0x04
)paren
id|outb
c_func
(paren
id|ENA_TXR_INT
comma
id|IER1_CTL
)paren
suffix:semicolon
multiline_comment|/* restore modem status interrupt */
id|outb
c_func
(paren
id|ier2
comma
id|IER2_8251F
)paren
suffix:semicolon
)brace
DECL|function|serial98_console_device
r_static
id|kdev_t
id|serial98_console_device
c_func
(paren
r_struct
id|console
op_star
id|co
)paren
(brace
r_return
id|mk_kdev
c_func
(paren
id|TTY_MAJOR
comma
l_int|64
op_plus
id|co-&gt;index
)paren
suffix:semicolon
)brace
DECL|function|serial98_console_setup
r_static
r_int
id|__init
id|serial98_console_setup
c_func
(paren
r_struct
id|console
op_star
id|co
comma
r_char
op_star
id|options
)paren
(brace
r_struct
id|uart_port
op_star
id|port
suffix:semicolon
r_int
id|baud
op_assign
l_int|9600
suffix:semicolon
r_int
id|bits
op_assign
l_int|8
suffix:semicolon
r_int
id|parity
op_assign
l_char|&squot;n&squot;
suffix:semicolon
r_int
id|flow
op_assign
l_char|&squot;n&squot;
suffix:semicolon
multiline_comment|/*&n;&t; * Check whether an invalid uart number has been specified, and&n;&t; * if so, search for the first available port that does have&n;&t; * console support.&n;&t; */
r_if
c_cond
(paren
id|co-&gt;index
op_ge
id|SERIAL98_NR
)paren
id|co-&gt;index
op_assign
l_int|0
suffix:semicolon
id|port
op_assign
op_amp
id|serial98_ports
(braket
id|co-&gt;index
)braket
dot
id|port
suffix:semicolon
multiline_comment|/*&n;&t; * Temporary fix.&n;&t; */
id|spin_lock_init
c_func
(paren
op_amp
id|port-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|options
)paren
id|uart_parse_options
c_func
(paren
id|options
comma
op_amp
id|baud
comma
op_amp
id|parity
comma
op_amp
id|bits
comma
op_amp
id|flow
)paren
suffix:semicolon
r_return
id|uart_set_options
c_func
(paren
id|port
comma
id|co
comma
id|baud
comma
id|parity
comma
id|bits
comma
id|flow
)paren
suffix:semicolon
)brace
DECL|function|serial98_console_init
r_void
id|__init
id|serial98_console_init
c_func
(paren
r_void
)paren
(brace
id|register_console
c_func
(paren
op_amp
id|serial98_console
)paren
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_SERIAL98_CONSOLE */
DECL|function|serial98_init
r_static
r_int
id|__init
id|serial98_init
c_func
(paren
r_void
)paren
(brace
r_int
id|ret
suffix:semicolon
r_int
r_char
id|iir1
comma
id|iir2
suffix:semicolon
r_if
c_cond
(paren
id|PC9800_8MHz_P
c_func
(paren
)paren
)paren
(brace
id|serial98_clk
op_assign
l_int|8
suffix:semicolon
id|serial98_ports
(braket
l_int|0
)braket
dot
id|port.uartclk
op_assign
l_int|374400
op_star
l_int|16
suffix:semicolon
)brace
r_else
(brace
id|serial98_clk
op_assign
l_int|5
suffix:semicolon
id|serial98_ports
(braket
l_int|0
)braket
dot
id|port.uartclk
op_assign
l_int|460800
op_star
l_int|16
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;serial98: PC-9801 standard serial port driver Version 0.1alpha&bslash;n&quot;
)paren
suffix:semicolon
id|serial98_ports
(braket
l_int|0
)braket
dot
id|type
op_assign
id|PORT_8251_PC98
suffix:semicolon
multiline_comment|/* Check FIFO exist */
id|iir1
op_assign
id|inb
c_func
(paren
id|IIR_8251F
)paren
suffix:semicolon
id|iir2
op_assign
id|inb
c_func
(paren
id|IIR_8251F
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|iir1
op_amp
l_int|0x40
)paren
op_ne
(paren
id|iir2
op_amp
l_int|0x40
)paren
op_logical_and
(paren
id|iir1
op_amp
l_int|0x20
)paren
op_eq
(paren
id|iir2
op_amp
l_int|0x20
)paren
)paren
(brace
id|serial98_ports
(braket
l_int|0
)braket
dot
id|port.iobase
op_assign
l_int|0x130
suffix:semicolon
id|serial98_ports
(braket
l_int|0
)braket
dot
id|port.fifosize
op_assign
l_int|16
suffix:semicolon
id|serial98_ports
(braket
l_int|0
)braket
dot
id|rxchk
op_assign
id|STAT_8251F_DSR
suffix:semicolon
id|serial98_ports
(braket
l_int|0
)braket
dot
id|txemp
op_assign
id|STAT_8251F_TXEMP
suffix:semicolon
id|serial98_ports
(braket
l_int|0
)braket
dot
id|txrdy
op_assign
id|STAT_8251F_TXRDY
suffix:semicolon
id|serial98_ports
(braket
l_int|0
)braket
dot
id|rxrdy
op_assign
id|STAT_8251F_RXRDY
suffix:semicolon
id|serial98_ports
(braket
l_int|0
)braket
dot
id|brk
op_assign
id|STAT_8251F_BRK
suffix:semicolon
id|serial98_ports
(braket
l_int|0
)braket
dot
id|fe
op_assign
id|STAT_8251F_FER
suffix:semicolon
id|serial98_ports
(braket
l_int|0
)braket
dot
id|oe
op_assign
id|STAT_8251F_OER
suffix:semicolon
id|serial98_ports
(braket
l_int|0
)braket
dot
id|pe
op_assign
id|STAT_8251F_PER
suffix:semicolon
id|serial98_ports
(braket
l_int|0
)braket
dot
id|dr
op_assign
id|STAT_8251F_DSR
suffix:semicolon
r_if
c_cond
(paren
op_star
(paren
r_int
r_char
op_star
)paren
id|__va
c_func
(paren
id|PC9821SCA_RSFLAGS
)paren
op_amp
l_int|0x10
)paren
id|serial98_ports
(braket
l_int|0
)braket
dot
id|type
op_assign
id|PORT_VFAST_PC98
suffix:semicolon
r_else
(brace
id|outb
c_func
(paren
id|serial98_ports
(braket
l_int|0
)braket
dot
id|ext
op_or
l_int|0x40
comma
id|SERIAL98_EXT
)paren
suffix:semicolon
id|serial98_ports
(braket
l_int|0
)braket
dot
id|port.uartclk
op_mul_assign
l_int|4
suffix:semicolon
id|serial98_ports
(braket
l_int|0
)braket
dot
id|type
op_assign
id|PORT_FIFO_PC98
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
(paren
id|serial98_ports
(braket
l_int|0
)braket
dot
id|ext
op_assign
id|inb
c_func
(paren
id|SERIAL98_EXT
)paren
)paren
op_ne
l_int|0xff
)paren
(brace
id|outb
c_func
(paren
id|serial98_ports
(braket
l_int|0
)braket
dot
id|ext
op_or
l_int|0x40
comma
id|SERIAL98_EXT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inb
c_func
(paren
id|SERIAL98_EXT
)paren
op_eq
(paren
id|serial98_ports
(braket
l_int|0
)braket
dot
id|ext
op_or
l_int|0x40
)paren
)paren
(brace
id|serial98_ports
(braket
l_int|0
)braket
dot
id|port.uartclk
op_mul_assign
l_int|4
suffix:semicolon
id|serial98_ports
(braket
l_int|0
)braket
dot
id|type
op_assign
id|PORT_19K_PC98
suffix:semicolon
)brace
r_else
(brace
id|serial98_ops.enable_ms
op_assign
l_int|NULL
suffix:semicolon
id|outb
c_func
(paren
id|serial98_ports
(braket
l_int|0
)braket
dot
id|ext
comma
id|SERIAL98_EXT
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|serial98_request_region
c_func
(paren
id|serial98_ports
(braket
l_int|0
)braket
dot
id|type
)paren
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
id|ret
op_assign
id|uart_register_driver
c_func
(paren
op_amp
id|serial98_reg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
l_int|0
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|SERIAL98_NR
suffix:semicolon
id|i
op_increment
)paren
(brace
id|uart_add_one_port
c_func
(paren
op_amp
id|serial98_reg
comma
(paren
r_struct
id|uart_port
op_star
)paren
op_amp
id|serial98_ports
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|function|serial98_exit
r_static
r_void
id|__exit
id|serial98_exit
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|serial98_ports
(braket
l_int|0
)braket
dot
id|type
op_eq
id|PORT_19K_PC98
op_logical_or
id|serial98_ports
(braket
l_int|0
)braket
dot
id|type
op_eq
id|PORT_FIFO_PC98
)paren
id|outb
c_func
(paren
id|serial98_ports
(braket
l_int|0
)braket
dot
id|ext
comma
id|SERIAL98_EXT
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|SERIAL98_NR
suffix:semicolon
id|i
op_increment
)paren
(brace
id|uart_remove_one_port
c_func
(paren
op_amp
id|serial98_reg
comma
(paren
r_struct
id|uart_port
op_star
)paren
op_amp
id|serial98_ports
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|uart_unregister_driver
c_func
(paren
op_amp
id|serial98_reg
)paren
suffix:semicolon
)brace
DECL|variable|serial98_init
id|module_init
c_func
(paren
id|serial98_init
)paren
suffix:semicolon
DECL|variable|serial98_exit
id|module_exit
c_func
(paren
id|serial98_exit
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Osamu Tomita &lt;tomita@cinet.co.jp&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;PC-9801 standard serial port driver Version 0.1alpha&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
eof
