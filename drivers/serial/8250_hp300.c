multiline_comment|/*&n; * Driver for the 98626/98644/internal serial interface on hp300/hp400&n; * (based on the National Semiconductor INS8250/NS16550AF/WD16C552 UARTs)&n; *&n; * Ported from 2.2 and modified to use the normal 8250 driver&n; * by Kars de Jong &lt;jongk@linux-m68k.org&gt;, May 2004.&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/serial.h&gt;
macro_line|#include &lt;linux/serialP.h&gt;
macro_line|#include &lt;linux/serial_core.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/dio.h&gt;
macro_line|#include &lt;linux/console.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#if !defined(CONFIG_HPDCA) &amp;&amp; !defined(CONFIG_HPAPCI)
macro_line|#warning CONFIG_8250 defined but neither CONFIG_HPDCA nor CONFIG_HPAPCI defined, are you sure?
macro_line|#endif
DECL|struct|hp300_port
r_struct
id|hp300_port
(brace
DECL|member|next
r_struct
id|hp300_port
op_star
id|next
suffix:semicolon
multiline_comment|/* next port */
DECL|member|dio_base
r_int
r_int
id|dio_base
suffix:semicolon
multiline_comment|/* start of DIO registers */
DECL|member|scode
r_int
id|scode
suffix:semicolon
multiline_comment|/* select code of this board */
DECL|member|line
r_int
id|line
suffix:semicolon
multiline_comment|/* line (tty) number */
)brace
suffix:semicolon
r_extern
r_int
id|hp300_uart_scode
suffix:semicolon
DECL|variable|hp300_ports
r_static
r_struct
id|hp300_port
op_star
id|hp300_ports
suffix:semicolon
multiline_comment|/* Offset to UART registers from base of DCA */
DECL|macro|UART_OFFSET
mdefine_line|#define UART_OFFSET&t;17
DECL|macro|DCA_ID
mdefine_line|#define DCA_ID&t;&t;0x01&t;/* ID (read), reset (write) */
DECL|macro|DCA_IC
mdefine_line|#define DCA_IC&t;&t;0x03&t;/* Interrupt control        */
multiline_comment|/* Interrupt control */
DECL|macro|DCA_IC_IE
mdefine_line|#define DCA_IC_IE&t;0x80&t;/* Master interrupt enable  */
DECL|macro|HPDCA_BAUD_BASE
mdefine_line|#define HPDCA_BAUD_BASE 153600
multiline_comment|/* Base address of the Frodo part */
DECL|macro|FRODO_BASE
mdefine_line|#define FRODO_BASE&t;(0x41c000)
multiline_comment|/*&n; * Where we find the 8250-like APCI ports, and how far apart they are.&n; */
DECL|macro|FRODO_APCIBASE
mdefine_line|#define FRODO_APCIBASE&t;&t;0x0
DECL|macro|FRODO_APCISPACE
mdefine_line|#define FRODO_APCISPACE&t;&t;0x20
DECL|macro|FRODO_APCI_OFFSET
mdefine_line|#define FRODO_APCI_OFFSET(x)&t;(FRODO_APCIBASE + ((x) * FRODO_APCISPACE))
DECL|macro|HPAPCI_BAUD_BASE
mdefine_line|#define HPAPCI_BAUD_BASE 500400
macro_line|#ifdef CONFIG_SERIAL_8250_CONSOLE
multiline_comment|/*&n; * Parse the bootinfo to find descriptions for headless console and &n; * debug serial ports and register them with the 8250 driver.&n; * This function should be called before serial_console_init() is called&n; * to make sure the serial console will be available for use. IA-64 kernel&n; * calls this function from setup_arch() after the EFI and ACPI tables have&n; * been parsed.&n; */
DECL|function|hp300_setup_serial_console
r_int
id|__init
id|hp300_setup_serial_console
c_func
(paren
r_void
)paren
(brace
r_int
id|scode
suffix:semicolon
r_struct
id|uart_port
id|port
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|port
comma
l_int|0
comma
r_sizeof
(paren
id|port
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hp300_uart_scode
template_param
l_int|256
)paren
r_return
l_int|0
suffix:semicolon
id|scode
op_assign
id|hp300_uart_scode
suffix:semicolon
multiline_comment|/* Memory mapped I/O */
id|port.iotype
op_assign
id|UPIO_MEM
suffix:semicolon
id|port.flags
op_assign
id|UPF_SKIP_TEST
op_or
id|UPF_SHARE_IRQ
op_or
id|UPF_BOOT_AUTOCONF
suffix:semicolon
id|port.type
op_assign
id|PORT_UNKNOWN
suffix:semicolon
multiline_comment|/* Check for APCI console */
r_if
c_cond
(paren
id|scode
op_eq
l_int|256
)paren
(brace
macro_line|#ifdef CONFIG_HPAPCI
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Serial console is HP APCI 1&bslash;n&quot;
)paren
suffix:semicolon
id|port.uartclk
op_assign
id|HPAPCI_BAUD_BASE
op_star
l_int|16
suffix:semicolon
id|port.mapbase
op_assign
(paren
id|FRODO_BASE
op_plus
id|FRODO_APCI_OFFSET
c_func
(paren
l_int|1
)paren
)paren
suffix:semicolon
id|port.membase
op_assign
(paren
r_char
op_star
)paren
(paren
id|port.mapbase
op_plus
id|DIO_VIRADDRBASE
)paren
suffix:semicolon
id|port.regshift
op_assign
l_int|2
suffix:semicolon
id|add_preferred_console
c_func
(paren
l_string|&quot;ttyS&quot;
comma
id|port.line
comma
l_string|&quot;9600n8&quot;
)paren
suffix:semicolon
macro_line|#else
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Serial console is APCI but support is disabled (CONFIG_HPAPCI)!&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
macro_line|#endif
)brace
r_else
(brace
macro_line|#ifdef CONFIG_HPDCA
r_int
r_int
id|pa
op_assign
id|dio_scodetophysaddr
c_func
(paren
id|scode
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pa
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Serial console is HP DCA at select code %d&bslash;n&quot;
comma
id|scode
)paren
suffix:semicolon
id|port.uartclk
op_assign
id|HPDCA_BAUD_BASE
op_star
l_int|16
suffix:semicolon
id|port.mapbase
op_assign
(paren
id|pa
op_plus
id|UART_OFFSET
)paren
suffix:semicolon
id|port.membase
op_assign
(paren
r_char
op_star
)paren
(paren
id|port.mapbase
op_plus
id|DIO_VIRADDRBASE
)paren
suffix:semicolon
id|port.regshift
op_assign
l_int|1
suffix:semicolon
id|port.irq
op_assign
id|DIO_IPL
c_func
(paren
id|pa
op_plus
id|DIO_VIRADDRBASE
)paren
suffix:semicolon
multiline_comment|/* Enable board-interrupts */
id|out_8
c_func
(paren
id|pa
op_plus
id|DIO_VIRADDRBASE
op_plus
id|DCA_IC
comma
id|DCA_IC_IE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|DIO_ID
c_func
(paren
id|pa
op_plus
id|DIO_VIRADDRBASE
)paren
op_amp
l_int|0x80
)paren
(brace
id|add_preferred_console
c_func
(paren
l_string|&quot;ttyS&quot;
comma
id|port.line
comma
l_string|&quot;9600n8&quot;
)paren
suffix:semicolon
)brace
macro_line|#else
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Serial console is DCA but support is disabled (CONFIG_HPDCA)!&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
macro_line|#endif
)brace
r_if
c_cond
(paren
id|early_serial_setup
c_func
(paren
op_amp
id|port
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;hp300_setup_serial_console(): early_serial_setup() failed.&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_SERIAL_8250_CONSOLE */
DECL|function|hp300_8250_init
r_static
r_int
id|__init
id|hp300_8250_init
c_func
(paren
r_void
)paren
(brace
r_static
r_int
id|called
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef CONFIG_HPDCA
r_int
id|scode
suffix:semicolon
macro_line|#endif
r_int
id|line
comma
id|num_ports
suffix:semicolon
r_int
r_int
id|base
suffix:semicolon
r_struct
id|serial_struct
id|serial_req
suffix:semicolon
r_struct
id|hp300_port
op_star
id|port
suffix:semicolon
r_if
c_cond
(paren
id|called
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|called
op_assign
l_int|1
suffix:semicolon
id|num_ports
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|MACH_IS_HP300
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_HPDCA
r_while
c_loop
(paren
l_int|1
)paren
(brace
multiline_comment|/* We detect boards by looking for DIO boards which match a&n;                 * given subset of IDs. dio_find() returns the board&squot;s scancode.&n;                 * The scancode to physaddr mapping is a property of the hardware,&n;                 * as is the scancode to IPL (interrupt priority) mapping.&n;                 */
id|scode
op_assign
id|dio_find
c_func
(paren
id|DIO_ID_DCA0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|scode
OL
l_int|0
)paren
id|scode
op_assign
id|dio_find
c_func
(paren
id|DIO_ID_DCA0REM
)paren
suffix:semicolon
r_if
c_cond
(paren
id|scode
OL
l_int|0
)paren
id|scode
op_assign
id|dio_find
c_func
(paren
id|DIO_ID_DCA1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|scode
OL
l_int|0
)paren
id|scode
op_assign
id|dio_find
c_func
(paren
id|DIO_ID_DCA1REM
)paren
suffix:semicolon
r_if
c_cond
(paren
id|scode
OL
l_int|0
)paren
r_break
suffix:semicolon
multiline_comment|/* no, none at all */
macro_line|#ifdef CONFIG_SERIAL_8250_CONSOLE
r_if
c_cond
(paren
id|hp300_uart_scode
op_eq
id|scode
)paren
(brace
multiline_comment|/* Already got it */
id|dio_config_board
c_func
(paren
id|scode
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* Create new serial device */
id|port
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|hp300_port
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|port
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|serial_req
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|serial_struct
)paren
)paren
suffix:semicolon
id|base
op_assign
id|dio_scodetophysaddr
c_func
(paren
id|scode
)paren
suffix:semicolon
multiline_comment|/* If we want to tell the DIO code that this board is configured,&n;                 * we should do that here.&n;                 */
id|dio_config_board
c_func
(paren
id|scode
)paren
suffix:semicolon
multiline_comment|/* Memory mapped I/O */
id|serial_req.io_type
op_assign
id|SERIAL_IO_MEM
suffix:semicolon
id|serial_req.flags
op_assign
id|UPF_SKIP_TEST
op_or
id|UPF_SHARE_IRQ
op_or
id|UPF_BOOT_AUTOCONF
suffix:semicolon
id|serial_req.irq
op_assign
id|dio_scodetoipl
c_func
(paren
id|scode
)paren
suffix:semicolon
id|serial_req.baud_base
op_assign
id|HPDCA_BAUD_BASE
suffix:semicolon
id|serial_req.iomap_base
op_assign
(paren
id|base
op_plus
id|UART_OFFSET
)paren
suffix:semicolon
id|serial_req.iomem_base
op_assign
(paren
r_char
op_star
)paren
(paren
id|serial_req.iomap_base
op_plus
id|DIO_VIRADDRBASE
)paren
suffix:semicolon
id|serial_req.iomem_reg_shift
op_assign
l_int|1
suffix:semicolon
macro_line|#ifdef CONFIG_SERIAL_8250_CONSOLE
r_if
c_cond
(paren
id|hp300_uart_scode
op_ne
id|scode
)paren
(brace
macro_line|#endif
multiline_comment|/* Reset the DCA */
id|out_8
c_func
(paren
id|base
op_plus
id|DIO_VIRADDRBASE
op_plus
id|DCA_ID
comma
l_int|0xff
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_SERIAL_8250_CONSOLE
)brace
macro_line|#endif
id|line
op_assign
id|register_serial
c_func
(paren
op_amp
id|serial_req
)paren
suffix:semicolon
r_if
c_cond
(paren
id|line
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;8250_hp300: register_serial() DCA scode %d&quot;
l_string|&quot; irq %d failed&bslash;n&quot;
comma
id|scode
comma
id|serial_req.irq
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|port
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/* Enable board-interrupts */
id|out_8
c_func
(paren
id|base
op_plus
id|DIO_VIRADDRBASE
op_plus
id|DCA_IC
comma
id|DCA_IC_IE
)paren
suffix:semicolon
id|port-&gt;dio_base
op_assign
id|base
op_plus
id|DIO_VIRADDRBASE
suffix:semicolon
id|port-&gt;scode
op_assign
id|scode
suffix:semicolon
id|port-&gt;line
op_assign
id|line
suffix:semicolon
id|port-&gt;next
op_assign
id|hp300_ports
suffix:semicolon
id|hp300_ports
op_assign
id|port
suffix:semicolon
id|num_ports
op_increment
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifdef CONFIG_HPAPCI
r_if
c_cond
(paren
id|hp300_model
op_ge
id|HP_400
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/* These models have the Frodo chip.&n;&t;&t; * Port 0 is reserved for the Apollo Domain keyboard.&n;&t;&t; * Port 1 is either the console or the DCA.&n;&t;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* Port 1 is the console on a 425e, on other machines it&squot;s mapped to&n;&t;&t;&t; * DCA.&n;&t;&t;&t; */
macro_line|#ifdef CONFIG_SERIAL_8250_CONSOLE
r_if
c_cond
(paren
id|i
op_eq
l_int|1
)paren
(brace
r_continue
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* Create new serial device */
id|port
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|hp300_port
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|port
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|serial_req
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|serial_struct
)paren
)paren
suffix:semicolon
id|base
op_assign
(paren
id|FRODO_BASE
op_plus
id|FRODO_APCI_OFFSET
c_func
(paren
id|i
)paren
)paren
suffix:semicolon
multiline_comment|/* Memory mapped I/O */
id|serial_req.io_type
op_assign
id|SERIAL_IO_MEM
suffix:semicolon
id|serial_req.flags
op_assign
id|UPF_SKIP_TEST
op_or
id|UPF_SHARE_IRQ
op_or
id|UPF_BOOT_AUTOCONF
suffix:semicolon
multiline_comment|/* XXX - no interrupt support yet */
id|serial_req.irq
op_assign
l_int|0
suffix:semicolon
id|serial_req.baud_base
op_assign
id|HPAPCI_BAUD_BASE
suffix:semicolon
id|serial_req.iomap_base
op_assign
id|base
suffix:semicolon
id|serial_req.iomem_base
op_assign
(paren
r_char
op_star
)paren
(paren
id|serial_req.iomap_base
op_plus
id|DIO_VIRADDRBASE
)paren
suffix:semicolon
id|serial_req.iomem_reg_shift
op_assign
l_int|2
suffix:semicolon
id|line
op_assign
id|register_serial
c_func
(paren
op_amp
id|serial_req
)paren
suffix:semicolon
r_if
c_cond
(paren
id|line
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;8250_hp300: register_serial() APCI %d&quot;
l_string|&quot; irq %d failed&bslash;n&quot;
comma
id|i
comma
id|serial_req.irq
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|port
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|port-&gt;dio_base
op_assign
l_int|0
suffix:semicolon
id|port-&gt;line
op_assign
id|line
suffix:semicolon
id|port-&gt;next
op_assign
id|hp300_ports
suffix:semicolon
id|hp300_ports
op_assign
id|port
suffix:semicolon
id|num_ports
op_increment
suffix:semicolon
)brace
)brace
macro_line|#endif
multiline_comment|/* Any boards found? */
r_if
c_cond
(paren
op_logical_neg
id|num_ports
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|hp300_8250_exit
r_static
r_void
id|__exit
id|hp300_8250_exit
c_func
(paren
r_void
)paren
(brace
r_struct
id|hp300_port
op_star
id|port
comma
op_star
id|to_free
suffix:semicolon
r_for
c_loop
(paren
id|port
op_assign
id|hp300_ports
suffix:semicolon
id|port
suffix:semicolon
)paren
(brace
id|unregister_serial
c_func
(paren
id|port-&gt;line
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_HPDCA
r_if
c_cond
(paren
id|port-&gt;dio_base
)paren
(brace
multiline_comment|/* Disable board-interrupts */
id|out_8
c_func
(paren
id|port-&gt;dio_base
op_plus
id|DCA_IC
comma
l_int|0
)paren
suffix:semicolon
id|dio_unconfig_board
c_func
(paren
id|port-&gt;scode
)paren
suffix:semicolon
)brace
macro_line|#endif
id|to_free
op_assign
id|port
suffix:semicolon
id|port
op_assign
id|port-&gt;next
suffix:semicolon
id|kfree
c_func
(paren
id|to_free
)paren
suffix:semicolon
)brace
id|hp300_ports
op_assign
l_int|NULL
suffix:semicolon
)brace
DECL|variable|hp300_8250_init
id|module_init
c_func
(paren
id|hp300_8250_init
)paren
suffix:semicolon
DECL|variable|hp300_8250_exit
id|module_exit
c_func
(paren
id|hp300_8250_exit
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;HP DCA/APCI serial driver&quot;
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Kars de Jong &lt;jongk@linux-m68k.org&gt;&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
eof
