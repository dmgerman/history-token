macro_line|#include &lt;linux/config.h&gt;
DECL|macro|__NO_VERSION__
mdefine_line|#define __NO_VERSION__
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/major.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/genhd.h&gt;
macro_line|#include &lt;linux/blkpg.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/hdreg.h&gt;
macro_line|#include &lt;linux/ide.h&gt;
macro_line|#include &lt;asm/byteorder.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
multiline_comment|/*&n; *&t;IDE library routines. These are plug in code that most &n; *&t;drivers can use but occasionally may be weird enough&n; *&t;to want to do their own thing with&n; *&n; *&t;Add common non I/O op stuff here. Make sure it has proper&n; *&t;kernel-doc function headers or your patch will be rejected&n; */
multiline_comment|/**&n; *&t;ide_xfer_verbose&t;-&t;return IDE mode names&n; *&t;@xfer_rate: rate to name&n; *&n; *&t;Returns a constant string giving the name of the mode&n; *&t;requested.&n; */
DECL|function|ide_xfer_verbose
r_char
op_star
id|ide_xfer_verbose
(paren
id|u8
id|xfer_rate
)paren
(brace
r_switch
c_cond
(paren
id|xfer_rate
)paren
(brace
r_case
id|XFER_UDMA_7
suffix:colon
r_return
l_string|&quot;UDMA 7&quot;
suffix:semicolon
r_case
id|XFER_UDMA_6
suffix:colon
r_return
l_string|&quot;UDMA 6&quot;
suffix:semicolon
r_case
id|XFER_UDMA_5
suffix:colon
r_return
l_string|&quot;UDMA 5&quot;
suffix:semicolon
r_case
id|XFER_UDMA_4
suffix:colon
r_return
l_string|&quot;UDMA 4&quot;
suffix:semicolon
r_case
id|XFER_UDMA_3
suffix:colon
r_return
l_string|&quot;UDMA 3&quot;
suffix:semicolon
r_case
id|XFER_UDMA_2
suffix:colon
r_return
l_string|&quot;UDMA 2&quot;
suffix:semicolon
r_case
id|XFER_UDMA_1
suffix:colon
r_return
l_string|&quot;UDMA 1&quot;
suffix:semicolon
r_case
id|XFER_UDMA_0
suffix:colon
r_return
l_string|&quot;UDMA 0&quot;
suffix:semicolon
r_case
id|XFER_MW_DMA_2
suffix:colon
r_return
l_string|&quot;MW DMA 2&quot;
suffix:semicolon
r_case
id|XFER_MW_DMA_1
suffix:colon
r_return
l_string|&quot;MW DMA 1&quot;
suffix:semicolon
r_case
id|XFER_MW_DMA_0
suffix:colon
r_return
l_string|&quot;MW DMA 0&quot;
suffix:semicolon
r_case
id|XFER_SW_DMA_2
suffix:colon
r_return
l_string|&quot;SW DMA 2&quot;
suffix:semicolon
r_case
id|XFER_SW_DMA_1
suffix:colon
r_return
l_string|&quot;SW DMA 1&quot;
suffix:semicolon
r_case
id|XFER_SW_DMA_0
suffix:colon
r_return
l_string|&quot;SW DMA 0&quot;
suffix:semicolon
r_case
id|XFER_PIO_4
suffix:colon
r_return
l_string|&quot;PIO 4&quot;
suffix:semicolon
r_case
id|XFER_PIO_3
suffix:colon
r_return
l_string|&quot;PIO 3&quot;
suffix:semicolon
r_case
id|XFER_PIO_2
suffix:colon
r_return
l_string|&quot;PIO 2&quot;
suffix:semicolon
r_case
id|XFER_PIO_1
suffix:colon
r_return
l_string|&quot;PIO 1&quot;
suffix:semicolon
r_case
id|XFER_PIO_0
suffix:colon
r_return
l_string|&quot;PIO 0&quot;
suffix:semicolon
r_case
id|XFER_PIO_SLOW
suffix:colon
r_return
l_string|&quot;PIO SLOW&quot;
suffix:semicolon
r_default
suffix:colon
r_return
l_string|&quot;XFER ERROR&quot;
suffix:semicolon
)brace
)brace
DECL|variable|ide_xfer_verbose
id|EXPORT_SYMBOL
c_func
(paren
id|ide_xfer_verbose
)paren
suffix:semicolon
multiline_comment|/**&n; *&t;ide_dma_speed&t;-&t;compute DMA speed&n; *&t;@drive: drive&n; *&t;@mode; intended mode&n; *&n; *&t;Checks the drive capabilities and returns the speed to use&n; *&t;for the transfer. Returns -1 if the requested mode is unknown&n; *&t;(eg PIO)&n; */
DECL|function|ide_dma_speed
id|u8
id|ide_dma_speed
c_func
(paren
id|ide_drive_t
op_star
id|drive
comma
id|u8
id|mode
)paren
(brace
r_struct
id|hd_driveid
op_star
id|id
op_assign
id|drive-&gt;id
suffix:semicolon
id|ide_hwif_t
op_star
id|hwif
op_assign
id|HWIF
c_func
(paren
id|drive
)paren
suffix:semicolon
id|u8
id|speed
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|drive-&gt;media
op_ne
id|ide_disk
op_logical_and
id|hwif-&gt;atapi_dma
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|mode
)paren
(brace
r_case
l_int|0x04
suffix:colon
r_if
c_cond
(paren
(paren
id|id-&gt;dma_ultra
op_amp
l_int|0x0040
)paren
op_logical_and
(paren
id|id-&gt;dma_ultra
op_amp
id|hwif-&gt;ultra_mask
)paren
)paren
(brace
id|speed
op_assign
id|XFER_UDMA_6
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
l_int|0x03
suffix:colon
r_if
c_cond
(paren
(paren
id|id-&gt;dma_ultra
op_amp
l_int|0x0020
)paren
op_logical_and
(paren
id|id-&gt;dma_ultra
op_amp
id|hwif-&gt;ultra_mask
)paren
)paren
(brace
id|speed
op_assign
id|XFER_UDMA_5
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
l_int|0x02
suffix:colon
r_if
c_cond
(paren
(paren
id|id-&gt;dma_ultra
op_amp
l_int|0x0010
)paren
op_logical_and
(paren
id|id-&gt;dma_ultra
op_amp
id|hwif-&gt;ultra_mask
)paren
)paren
(brace
id|speed
op_assign
id|XFER_UDMA_4
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|id-&gt;dma_ultra
op_amp
l_int|0x0008
)paren
op_logical_and
(paren
id|id-&gt;dma_ultra
op_amp
id|hwif-&gt;ultra_mask
)paren
)paren
(brace
id|speed
op_assign
id|XFER_UDMA_3
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
l_int|0x01
suffix:colon
r_if
c_cond
(paren
(paren
id|id-&gt;dma_ultra
op_amp
l_int|0x0004
)paren
op_logical_and
(paren
id|id-&gt;dma_ultra
op_amp
id|hwif-&gt;ultra_mask
)paren
)paren
(brace
id|speed
op_assign
id|XFER_UDMA_2
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|id-&gt;dma_ultra
op_amp
l_int|0x0002
)paren
op_logical_and
(paren
id|id-&gt;dma_ultra
op_amp
id|hwif-&gt;ultra_mask
)paren
)paren
(brace
id|speed
op_assign
id|XFER_UDMA_1
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|id-&gt;dma_ultra
op_amp
l_int|0x0001
)paren
op_logical_and
(paren
id|id-&gt;dma_ultra
op_amp
id|hwif-&gt;ultra_mask
)paren
)paren
(brace
id|speed
op_assign
id|XFER_UDMA_0
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
l_int|0x00
suffix:colon
r_if
c_cond
(paren
(paren
id|id-&gt;dma_mword
op_amp
l_int|0x0004
)paren
op_logical_and
(paren
id|id-&gt;dma_mword
op_amp
id|hwif-&gt;mwdma_mask
)paren
)paren
(brace
id|speed
op_assign
id|XFER_MW_DMA_2
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|id-&gt;dma_mword
op_amp
l_int|0x0002
)paren
op_logical_and
(paren
id|id-&gt;dma_mword
op_amp
id|hwif-&gt;mwdma_mask
)paren
)paren
(brace
id|speed
op_assign
id|XFER_MW_DMA_1
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|id-&gt;dma_mword
op_amp
l_int|0x0001
)paren
op_logical_and
(paren
id|id-&gt;dma_mword
op_amp
id|hwif-&gt;mwdma_mask
)paren
)paren
(brace
id|speed
op_assign
id|XFER_MW_DMA_0
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|id-&gt;dma_1word
op_amp
l_int|0x0004
)paren
op_logical_and
(paren
id|id-&gt;dma_1word
op_amp
id|hwif-&gt;swdma_mask
)paren
)paren
(brace
id|speed
op_assign
id|XFER_SW_DMA_2
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|id-&gt;dma_1word
op_amp
l_int|0x0002
)paren
op_logical_and
(paren
id|id-&gt;dma_1word
op_amp
id|hwif-&gt;swdma_mask
)paren
)paren
(brace
id|speed
op_assign
id|XFER_SW_DMA_1
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|id-&gt;dma_1word
op_amp
l_int|0x0001
)paren
op_logical_and
(paren
id|id-&gt;dma_1word
op_amp
id|hwif-&gt;swdma_mask
)paren
)paren
(brace
id|speed
op_assign
id|XFER_SW_DMA_0
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
singleline_comment|//&t;printk(&quot;%s: %s: mode 0x%02x, speed 0x%02x&bslash;n&quot;,
singleline_comment|//&t;&t;__FUNCTION__, drive-&gt;name, mode, speed);
r_return
id|speed
suffix:semicolon
)brace
DECL|variable|ide_dma_speed
id|EXPORT_SYMBOL
c_func
(paren
id|ide_dma_speed
)paren
suffix:semicolon
multiline_comment|/**&n; *&t;ide_rate_filter&t;&t;-&t;return best speed for mode&n; *&t;@mode: modes available&n; *&t;@speed: desired speed&n; *&n; *&t;Given the available DMA/UDMA mode this function returns&n; *&t;the best available speed at or below the speed requested.&n; */
DECL|function|ide_rate_filter
id|u8
id|ide_rate_filter
(paren
id|u8
id|mode
comma
id|u8
id|speed
)paren
(brace
macro_line|#ifdef CONFIG_BLK_DEV_IDEDMA
r_static
id|u8
id|speed_max
(braket
)braket
op_assign
(brace
id|XFER_MW_DMA_2
comma
id|XFER_UDMA_2
comma
id|XFER_UDMA_4
comma
id|XFER_UDMA_5
comma
id|XFER_UDMA_6
)brace
suffix:semicolon
singleline_comment|//&t;printk(&quot;%s: mode 0x%02x, speed 0x%02x&bslash;n&quot;, __FUNCTION__, mode, speed);
multiline_comment|/* So that we remember to update this if new modes appear */
r_if
c_cond
(paren
id|mode
OG
l_int|4
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
r_return
id|min
c_func
(paren
id|speed
comma
id|speed_max
(braket
id|mode
)braket
)paren
suffix:semicolon
macro_line|#else /* !CONFIG_BLK_DEV_IDEDMA */
r_return
id|min
c_func
(paren
id|speed
comma
id|XFER_PIO_4
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_BLK_DEV_IDEDMA */
)brace
DECL|variable|ide_rate_filter
id|EXPORT_SYMBOL
c_func
(paren
id|ide_rate_filter
)paren
suffix:semicolon
DECL|function|ide_dma_enable
r_int
id|ide_dma_enable
(paren
id|ide_drive_t
op_star
id|drive
)paren
(brace
id|ide_hwif_t
op_star
id|hwif
op_assign
id|HWIF
c_func
(paren
id|drive
)paren
suffix:semicolon
r_struct
id|hd_driveid
op_star
id|id
op_assign
id|drive-&gt;id
suffix:semicolon
r_return
(paren
(paren
r_int
)paren
(paren
(paren
(paren
(paren
id|id-&gt;dma_ultra
op_rshift
l_int|8
)paren
op_amp
id|hwif-&gt;ultra_mask
)paren
op_logical_or
(paren
(paren
id|id-&gt;dma_mword
op_rshift
l_int|8
)paren
op_amp
id|hwif-&gt;mwdma_mask
)paren
op_logical_or
(paren
(paren
id|id-&gt;dma_1word
op_rshift
l_int|8
)paren
op_amp
id|hwif-&gt;swdma_mask
)paren
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
)paren
suffix:semicolon
)brace
DECL|variable|ide_dma_enable
id|EXPORT_SYMBOL
c_func
(paren
id|ide_dma_enable
)paren
suffix:semicolon
eof
