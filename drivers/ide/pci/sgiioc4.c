multiline_comment|/*&n; * Copyright (c) 2003 Silicon Graphics, Inc.  All Rights Reserved.&n; *&n; * This program is free software; you can redistribute it and/or modify it&n; * under the terms of version 2 of the GNU General Public License&n; * as published by the Free Software Foundation.&n; *&n; * This program is distributed in the hope that it would be useful, but&n; * WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.&n; *&n; * You should have received a copy of the GNU General Public&n; * License along with this program; if not, write the Free Software&n; * Foundation, Inc., 59 Temple Place - Suite 330, Boston MA 02111-1307, USA.&n; *&n; * Contact information:  Silicon Graphics, Inc., 1600 Amphitheatre Pkwy,&n; * Mountain View, CA  94043, or:&n; *&n; * http://www.sgi.com&n; *&n; * For further information regarding this notice, see:&n; *&n; * http://oss.sgi.com/projects/GenInfo/NoticeExplan&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/hdreg.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/blkdev.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;linux/ide.h&gt;
multiline_comment|/* IOC4 Specific Definitions */
DECL|macro|IOC4_CMD_OFFSET
mdefine_line|#define IOC4_CMD_OFFSET&t;&t;0x100
DECL|macro|IOC4_CTRL_OFFSET
mdefine_line|#define IOC4_CTRL_OFFSET&t;0x120
DECL|macro|IOC4_DMA_OFFSET
mdefine_line|#define IOC4_DMA_OFFSET&t;&t;0x140
DECL|macro|IOC4_INTR_OFFSET
mdefine_line|#define IOC4_INTR_OFFSET&t;0x0
DECL|macro|IOC4_TIMING
mdefine_line|#define IOC4_TIMING&t;&t;0x00
DECL|macro|IOC4_DMA_PTR_L
mdefine_line|#define IOC4_DMA_PTR_L&t;&t;0x01
DECL|macro|IOC4_DMA_PTR_H
mdefine_line|#define IOC4_DMA_PTR_H&t;&t;0x02
DECL|macro|IOC4_DMA_ADDR_L
mdefine_line|#define IOC4_DMA_ADDR_L&t;&t;0x03
DECL|macro|IOC4_DMA_ADDR_H
mdefine_line|#define IOC4_DMA_ADDR_H&t;&t;0x04
DECL|macro|IOC4_BC_DEV
mdefine_line|#define IOC4_BC_DEV&t;&t;0x05
DECL|macro|IOC4_BC_MEM
mdefine_line|#define IOC4_BC_MEM&t;&t;0x06
DECL|macro|IOC4_DMA_CTRL
mdefine_line|#define&t;IOC4_DMA_CTRL&t;&t;0x07
DECL|macro|IOC4_DMA_END_ADDR
mdefine_line|#define&t;IOC4_DMA_END_ADDR&t;0x08
multiline_comment|/* Bits in the IOC4 Control/Status Register */
DECL|macro|IOC4_S_DMA_START
mdefine_line|#define&t;IOC4_S_DMA_START&t;0x01
DECL|macro|IOC4_S_DMA_STOP
mdefine_line|#define&t;IOC4_S_DMA_STOP&t;&t;0x02
DECL|macro|IOC4_S_DMA_DIR
mdefine_line|#define&t;IOC4_S_DMA_DIR&t;&t;0x04
DECL|macro|IOC4_S_DMA_ACTIVE
mdefine_line|#define&t;IOC4_S_DMA_ACTIVE&t;0x08
DECL|macro|IOC4_S_DMA_ERROR
mdefine_line|#define&t;IOC4_S_DMA_ERROR&t;0x10
DECL|macro|IOC4_ATA_MEMERR
mdefine_line|#define&t;IOC4_ATA_MEMERR&t;&t;0x02
multiline_comment|/* Read/Write Directions */
DECL|macro|IOC4_DMA_WRITE
mdefine_line|#define&t;IOC4_DMA_WRITE&t;&t;0x04
DECL|macro|IOC4_DMA_READ
mdefine_line|#define&t;IOC4_DMA_READ&t;&t;0x00
multiline_comment|/* Interrupt Register Offsets */
DECL|macro|IOC4_INTR_REG
mdefine_line|#define IOC4_INTR_REG&t;&t;0x03
DECL|macro|IOC4_INTR_SET
mdefine_line|#define&t;IOC4_INTR_SET&t;&t;0x05
DECL|macro|IOC4_INTR_CLEAR
mdefine_line|#define&t;IOC4_INTR_CLEAR&t;&t;0x07
DECL|macro|IOC4_IDE_CACHELINE_SIZE
mdefine_line|#define IOC4_IDE_CACHELINE_SIZE&t;128
DECL|macro|IOC4_CMD_CTL_BLK_SIZE
mdefine_line|#define IOC4_CMD_CTL_BLK_SIZE&t;0x20
DECL|macro|IOC4_SUPPORTED_FIRMWARE_REV
mdefine_line|#define IOC4_SUPPORTED_FIRMWARE_REV 46
r_typedef
r_struct
(brace
DECL|member|timing_reg0
id|u32
id|timing_reg0
suffix:semicolon
DECL|member|timing_reg1
id|u32
id|timing_reg1
suffix:semicolon
DECL|member|low_mem_ptr
id|u32
id|low_mem_ptr
suffix:semicolon
DECL|member|high_mem_ptr
id|u32
id|high_mem_ptr
suffix:semicolon
DECL|member|low_mem_addr
id|u32
id|low_mem_addr
suffix:semicolon
DECL|member|high_mem_addr
id|u32
id|high_mem_addr
suffix:semicolon
DECL|member|dev_byte_count
id|u32
id|dev_byte_count
suffix:semicolon
DECL|member|mem_byte_count
id|u32
id|mem_byte_count
suffix:semicolon
DECL|member|status
id|u32
id|status
suffix:semicolon
DECL|typedef|ioc4_dma_regs_t
)brace
id|ioc4_dma_regs_t
suffix:semicolon
multiline_comment|/* Each Physical Region Descriptor Entry size is 16 bytes (2 * 64 bits) */
multiline_comment|/* IOC4 has only 1 IDE channel */
DECL|macro|IOC4_PRD_BYTES
mdefine_line|#define IOC4_PRD_BYTES       16
DECL|macro|IOC4_PRD_ENTRIES
mdefine_line|#define IOC4_PRD_ENTRIES     (PAGE_SIZE /(4*IOC4_PRD_BYTES))
r_static
r_void
DECL|function|sgiioc4_init_hwif_ports
id|sgiioc4_init_hwif_ports
c_func
(paren
id|hw_regs_t
op_star
id|hw
comma
r_int
r_int
id|data_port
comma
r_int
r_int
id|ctrl_port
comma
r_int
r_int
id|irq_port
)paren
(brace
r_int
r_int
id|reg
op_assign
id|data_port
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* Registers are word (32 bit) aligned */
r_for
c_loop
(paren
id|i
op_assign
id|IDE_DATA_OFFSET
suffix:semicolon
id|i
op_le
id|IDE_STATUS_OFFSET
suffix:semicolon
id|i
op_increment
)paren
id|hw-&gt;io_ports
(braket
id|i
)braket
op_assign
id|reg
op_plus
id|i
op_star
l_int|4
suffix:semicolon
r_if
c_cond
(paren
id|ctrl_port
)paren
id|hw-&gt;io_ports
(braket
id|IDE_CONTROL_OFFSET
)braket
op_assign
id|ctrl_port
suffix:semicolon
r_if
c_cond
(paren
id|irq_port
)paren
id|hw-&gt;io_ports
(braket
id|IDE_IRQ_OFFSET
)braket
op_assign
id|irq_port
suffix:semicolon
)brace
r_static
r_void
DECL|function|sgiioc4_maskproc
id|sgiioc4_maskproc
c_func
(paren
id|ide_drive_t
op_star
id|drive
comma
r_int
id|mask
)paren
(brace
id|ide_hwif_t
op_star
id|hwif
op_assign
id|HWIF
c_func
(paren
id|drive
)paren
suffix:semicolon
id|hwif
op_member_access_from_pointer
id|OUTB
c_func
(paren
id|mask
ques
c_cond
(paren
id|drive-&gt;ctl
op_or
l_int|2
)paren
suffix:colon
(paren
id|drive-&gt;ctl
op_amp
op_complement
l_int|2
)paren
comma
id|IDE_CONTROL_REG
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|sgiioc4_checkirq
id|sgiioc4_checkirq
c_func
(paren
id|ide_hwif_t
op_star
id|hwif
)paren
(brace
id|u8
id|intr_reg
op_assign
id|hwif
op_member_access_from_pointer
id|INL
c_func
(paren
id|hwif-&gt;io_ports
(braket
id|IDE_IRQ_OFFSET
)braket
op_plus
id|IOC4_INTR_REG
op_star
l_int|4
)paren
suffix:semicolon
r_if
c_cond
(paren
id|intr_reg
op_amp
l_int|0x03
)paren
r_return
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|sgiioc4_clearirq
id|sgiioc4_clearirq
c_func
(paren
id|ide_drive_t
op_star
id|drive
)paren
(brace
id|u32
id|intr_reg
suffix:semicolon
id|ide_hwif_t
op_star
id|hwif
op_assign
id|HWIF
c_func
(paren
id|drive
)paren
suffix:semicolon
r_int
r_int
id|other_ir
op_assign
id|hwif-&gt;io_ports
(braket
id|IDE_IRQ_OFFSET
)braket
op_plus
(paren
id|IOC4_INTR_REG
op_lshift
l_int|2
)paren
suffix:semicolon
multiline_comment|/* Code to check for PCI error conditions */
id|intr_reg
op_assign
id|hwif
op_member_access_from_pointer
id|INL
c_func
(paren
id|other_ir
)paren
suffix:semicolon
r_if
c_cond
(paren
id|intr_reg
op_amp
l_int|0x03
)paren
(brace
multiline_comment|/* Valid IOC4-IDE interrupt */
multiline_comment|/*&n;&t;&t; * Using hwif-&gt;INB to read the IDE_STATUS_REG has a side effect&n;&t;&t; * of clearing the interrupt.  The first read should clear it&n;&t;&t; * if it is set.  The second read should return a &quot;clear&quot; status&n;&t;&t; * if it got cleared.  If not, then spin for a bit trying to&n;&t;&t; * clear it.&n;&t;&t; */
id|u8
id|stat
op_assign
id|hwif
op_member_access_from_pointer
id|INB
c_func
(paren
id|IDE_STATUS_REG
)paren
suffix:semicolon
r_int
id|count
op_assign
l_int|0
suffix:semicolon
id|stat
op_assign
id|hwif
op_member_access_from_pointer
id|INB
c_func
(paren
id|IDE_STATUS_REG
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|stat
op_amp
l_int|0x80
)paren
op_logical_and
(paren
id|count
op_increment
OL
l_int|100
)paren
)paren
(brace
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|stat
op_assign
id|hwif
op_member_access_from_pointer
id|INB
c_func
(paren
id|IDE_STATUS_REG
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|intr_reg
op_amp
l_int|0x02
)paren
(brace
multiline_comment|/* Error when transferring DMA data on PCI bus */
id|u32
id|pci_err_addr_low
comma
id|pci_err_addr_high
comma
id|pci_stat_cmd_reg
suffix:semicolon
id|pci_err_addr_low
op_assign
id|hwif
op_member_access_from_pointer
id|INL
c_func
(paren
id|hwif-&gt;io_ports
(braket
id|IDE_IRQ_OFFSET
)braket
)paren
suffix:semicolon
id|pci_err_addr_high
op_assign
id|hwif
op_member_access_from_pointer
id|INL
c_func
(paren
id|hwif-&gt;io_ports
(braket
id|IDE_IRQ_OFFSET
)braket
op_plus
l_int|4
)paren
suffix:semicolon
id|pci_read_config_dword
c_func
(paren
id|hwif-&gt;pci_dev
comma
id|PCI_COMMAND
comma
op_amp
id|pci_stat_cmd_reg
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s(%s) : PCI Bus Error when doing DMA:&quot;
l_string|&quot; status-cmd reg is 0x%x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|drive-&gt;name
comma
id|pci_stat_cmd_reg
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s(%s) : PCI Error Address is 0x%x%x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|drive-&gt;name
comma
id|pci_err_addr_high
comma
id|pci_err_addr_low
)paren
suffix:semicolon
multiline_comment|/* Clear the PCI Error indicator */
id|pci_write_config_dword
c_func
(paren
id|hwif-&gt;pci_dev
comma
id|PCI_COMMAND
comma
l_int|0x00000146
)paren
suffix:semicolon
)brace
multiline_comment|/* Clear the Interrupt, Error bits on the IOC4 */
id|hwif
op_member_access_from_pointer
id|OUTL
c_func
(paren
l_int|0x03
comma
id|other_ir
)paren
suffix:semicolon
id|intr_reg
op_assign
id|hwif
op_member_access_from_pointer
id|INL
c_func
(paren
id|other_ir
)paren
suffix:semicolon
)brace
r_return
id|intr_reg
op_amp
l_int|3
suffix:semicolon
)brace
r_static
r_int
DECL|function|sgiioc4_ide_dma_begin
id|sgiioc4_ide_dma_begin
c_func
(paren
id|ide_drive_t
op_star
id|drive
)paren
(brace
id|ide_hwif_t
op_star
id|hwif
op_assign
id|HWIF
c_func
(paren
id|drive
)paren
suffix:semicolon
r_int
r_int
id|reg
op_assign
id|hwif
op_member_access_from_pointer
id|INL
c_func
(paren
id|hwif-&gt;dma_base
op_plus
id|IOC4_DMA_CTRL
op_star
l_int|4
)paren
suffix:semicolon
r_int
r_int
id|temp_reg
op_assign
id|reg
op_or
id|IOC4_S_DMA_START
suffix:semicolon
id|hwif
op_member_access_from_pointer
id|OUTL
c_func
(paren
id|temp_reg
comma
id|hwif-&gt;dma_base
op_plus
id|IOC4_DMA_CTRL
op_star
l_int|4
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
id|u32
DECL|function|sgiioc4_ide_dma_stop
id|sgiioc4_ide_dma_stop
c_func
(paren
id|ide_hwif_t
op_star
id|hwif
comma
id|u64
id|dma_base
)paren
(brace
id|u32
id|ioc4_dma
suffix:semicolon
r_int
id|count
suffix:semicolon
id|count
op_assign
l_int|0
suffix:semicolon
id|ioc4_dma
op_assign
id|hwif
op_member_access_from_pointer
id|INL
c_func
(paren
id|dma_base
op_plus
id|IOC4_DMA_CTRL
op_star
l_int|4
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|ioc4_dma
op_amp
id|IOC4_S_DMA_STOP
)paren
op_logical_and
(paren
id|count
op_increment
OL
l_int|200
)paren
)paren
(brace
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|ioc4_dma
op_assign
id|hwif
op_member_access_from_pointer
id|INL
c_func
(paren
id|dma_base
op_plus
id|IOC4_DMA_CTRL
op_star
l_int|4
)paren
suffix:semicolon
)brace
r_return
id|ioc4_dma
suffix:semicolon
)brace
multiline_comment|/* Stops the IOC4 DMA Engine */
r_static
r_int
DECL|function|sgiioc4_ide_dma_end
id|sgiioc4_ide_dma_end
c_func
(paren
id|ide_drive_t
op_star
id|drive
)paren
(brace
id|u32
id|ioc4_dma
comma
id|bc_dev
comma
id|bc_mem
comma
id|num
comma
id|valid
op_assign
l_int|0
comma
id|cnt
op_assign
l_int|0
suffix:semicolon
id|ide_hwif_t
op_star
id|hwif
op_assign
id|HWIF
c_func
(paren
id|drive
)paren
suffix:semicolon
id|u64
id|dma_base
op_assign
id|hwif-&gt;dma_base
suffix:semicolon
r_int
id|dma_stat
op_assign
l_int|0
suffix:semicolon
r_int
r_int
op_star
id|ending_dma
op_assign
(paren
r_int
r_int
op_star
)paren
id|hwif-&gt;dma_base2
suffix:semicolon
id|hwif
op_member_access_from_pointer
id|OUTL
c_func
(paren
id|IOC4_S_DMA_STOP
comma
id|dma_base
op_plus
id|IOC4_DMA_CTRL
op_star
l_int|4
)paren
suffix:semicolon
id|ioc4_dma
op_assign
id|sgiioc4_ide_dma_stop
c_func
(paren
id|hwif
comma
id|dma_base
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioc4_dma
op_amp
id|IOC4_S_DMA_STOP
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s(%s): IOC4 DMA STOP bit is still 1 :&quot;
l_string|&quot;ioc4_dma_reg 0x%x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|drive-&gt;name
comma
id|ioc4_dma
)paren
suffix:semicolon
id|dma_stat
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * The IOC4 will DMA 1&squot;s to the ending dma area to indicate that&n;&t; * previous data DMA is complete.  This is necessary because of relaxed&n;&t; * ordering between register reads and DMA writes on the Altix.&n;&t; */
r_while
c_loop
(paren
(paren
id|cnt
op_increment
OL
l_int|200
)paren
op_logical_and
(paren
op_logical_neg
id|valid
)paren
)paren
(brace
r_for
c_loop
(paren
id|num
op_assign
l_int|0
suffix:semicolon
id|num
OL
l_int|16
suffix:semicolon
id|num
op_increment
)paren
(brace
r_if
c_cond
(paren
id|ending_dma
(braket
id|num
)braket
)paren
(brace
id|valid
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|valid
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s(%s) : DMA incomplete&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|drive-&gt;name
)paren
suffix:semicolon
id|dma_stat
op_assign
l_int|1
suffix:semicolon
)brace
id|bc_dev
op_assign
id|hwif
op_member_access_from_pointer
id|INL
c_func
(paren
id|dma_base
op_plus
id|IOC4_BC_DEV
op_star
l_int|4
)paren
suffix:semicolon
id|bc_mem
op_assign
id|hwif
op_member_access_from_pointer
id|INL
c_func
(paren
id|dma_base
op_plus
id|IOC4_BC_MEM
op_star
l_int|4
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|bc_dev
op_amp
l_int|0x01FF
)paren
op_logical_or
(paren
id|bc_mem
op_amp
l_int|0x1FF
)paren
)paren
(brace
r_if
c_cond
(paren
id|bc_dev
OG
id|bc_mem
op_plus
l_int|8
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s(%s): WARNING!! byte_count_dev %d &quot;
l_string|&quot;!= byte_count_mem %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|drive-&gt;name
comma
id|bc_dev
comma
id|bc_mem
)paren
suffix:semicolon
)brace
)brace
id|drive-&gt;waiting_for_dma
op_assign
l_int|0
suffix:semicolon
id|ide_destroy_dmatable
c_func
(paren
id|drive
)paren
suffix:semicolon
r_return
id|dma_stat
suffix:semicolon
)brace
r_static
r_int
DECL|function|sgiioc4_ide_dma_check
id|sgiioc4_ide_dma_check
c_func
(paren
id|ide_drive_t
op_star
id|drive
)paren
(brace
r_if
c_cond
(paren
id|ide_config_drive_speed
c_func
(paren
id|drive
comma
id|XFER_MW_DMA_2
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Couldnot set %s in Multimode-2 DMA mode | &quot;
l_string|&quot;Drive %s using PIO instead&bslash;n&quot;
comma
id|drive-&gt;name
comma
id|drive-&gt;name
)paren
suffix:semicolon
id|drive-&gt;using_dma
op_assign
l_int|0
suffix:semicolon
)brace
r_else
id|drive-&gt;using_dma
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|sgiioc4_ide_dma_on
id|sgiioc4_ide_dma_on
c_func
(paren
id|ide_drive_t
op_star
id|drive
)paren
(brace
id|drive-&gt;using_dma
op_assign
l_int|1
suffix:semicolon
r_return
id|HWIF
c_func
(paren
id|drive
)paren
op_member_access_from_pointer
id|ide_dma_host_on
c_func
(paren
id|drive
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|sgiioc4_ide_dma_off_quietly
id|sgiioc4_ide_dma_off_quietly
c_func
(paren
id|ide_drive_t
op_star
id|drive
)paren
(brace
id|drive-&gt;using_dma
op_assign
l_int|0
suffix:semicolon
r_return
id|HWIF
c_func
(paren
id|drive
)paren
op_member_access_from_pointer
id|ide_dma_host_off
c_func
(paren
id|drive
)paren
suffix:semicolon
)brace
multiline_comment|/* returns 1 if dma irq issued, 0 otherwise */
r_static
r_int
DECL|function|sgiioc4_ide_dma_test_irq
id|sgiioc4_ide_dma_test_irq
c_func
(paren
id|ide_drive_t
op_star
id|drive
)paren
(brace
r_return
id|sgiioc4_checkirq
c_func
(paren
id|HWIF
c_func
(paren
id|drive
)paren
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|sgiioc4_ide_dma_host_on
id|sgiioc4_ide_dma_host_on
c_func
(paren
id|ide_drive_t
op_star
id|drive
)paren
(brace
r_if
c_cond
(paren
id|drive-&gt;using_dma
)paren
r_return
l_int|0
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_static
r_int
DECL|function|sgiioc4_ide_dma_host_off
id|sgiioc4_ide_dma_host_off
c_func
(paren
id|ide_drive_t
op_star
id|drive
)paren
(brace
id|sgiioc4_clearirq
c_func
(paren
id|drive
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|sgiioc4_ide_dma_verbose
id|sgiioc4_ide_dma_verbose
c_func
(paren
id|ide_drive_t
op_star
id|drive
)paren
(brace
r_if
c_cond
(paren
id|drive-&gt;using_dma
op_eq
l_int|1
)paren
id|printk
c_func
(paren
l_string|&quot;, UDMA(16)&quot;
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
l_string|&quot;, PIO&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_static
r_int
DECL|function|sgiioc4_ide_dma_lostirq
id|sgiioc4_ide_dma_lostirq
c_func
(paren
id|ide_drive_t
op_star
id|drive
)paren
(brace
id|HWIF
c_func
(paren
id|drive
)paren
op_member_access_from_pointer
id|resetproc
c_func
(paren
id|drive
)paren
suffix:semicolon
r_return
id|__ide_dma_lostirq
c_func
(paren
id|drive
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|sgiioc4_resetproc
id|sgiioc4_resetproc
c_func
(paren
id|ide_drive_t
op_star
id|drive
)paren
(brace
id|sgiioc4_ide_dma_end
c_func
(paren
id|drive
)paren
suffix:semicolon
id|sgiioc4_clearirq
c_func
(paren
id|drive
)paren
suffix:semicolon
)brace
r_static
id|u8
DECL|function|sgiioc4_INB
id|sgiioc4_INB
c_func
(paren
r_int
r_int
id|port
)paren
(brace
id|u8
id|reg
op_assign
(paren
id|u8
)paren
id|inb
c_func
(paren
id|port
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|port
op_amp
l_int|0xFFF
)paren
op_eq
l_int|0x11C
)paren
(brace
multiline_comment|/* Status register of IOC4 */
r_if
c_cond
(paren
id|reg
op_amp
l_int|0x51
)paren
(brace
multiline_comment|/* Not busy...check for interrupt */
r_int
r_int
id|other_ir
op_assign
id|port
op_minus
l_int|0x110
suffix:semicolon
r_int
r_int
id|intr_reg
op_assign
(paren
id|u32
)paren
id|inl
c_func
(paren
id|other_ir
)paren
suffix:semicolon
multiline_comment|/* Clear the Interrupt, Error bits on the IOC4 */
r_if
c_cond
(paren
id|intr_reg
op_amp
l_int|0x03
)paren
(brace
id|outl
c_func
(paren
l_int|0x03
comma
id|other_ir
)paren
suffix:semicolon
id|intr_reg
op_assign
(paren
id|u32
)paren
id|inl
c_func
(paren
id|other_ir
)paren
suffix:semicolon
)brace
)brace
)brace
r_return
id|reg
suffix:semicolon
)brace
multiline_comment|/* Creates a dma map for the scatter-gather list entries */
r_static
r_void
id|__init
DECL|function|ide_dma_sgiioc4
id|ide_dma_sgiioc4
c_func
(paren
id|ide_hwif_t
op_star
id|hwif
comma
r_int
r_int
id|dma_base
)paren
(brace
r_int
id|num_ports
op_assign
r_sizeof
(paren
id|ioc4_dma_regs_t
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: BM-DMA at 0x%04lx-0x%04lx&bslash;n&quot;
comma
id|hwif-&gt;name
comma
id|dma_base
comma
id|dma_base
op_plus
id|num_ports
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|request_region
c_func
(paren
id|dma_base
comma
id|num_ports
comma
id|hwif-&gt;name
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s(%s) -- ERROR, Addresses 0x%p to 0x%p &quot;
l_string|&quot;ALREADY in use&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|hwif-&gt;name
comma
(paren
r_void
op_star
)paren
id|dma_base
comma
(paren
r_void
op_star
)paren
id|dma_base
op_plus
id|num_ports
op_minus
l_int|1
)paren
suffix:semicolon
r_goto
id|dma_alloc_failure
suffix:semicolon
)brace
id|hwif-&gt;dma_base
op_assign
id|dma_base
suffix:semicolon
id|hwif-&gt;dmatable_cpu
op_assign
id|pci_alloc_consistent
c_func
(paren
id|hwif-&gt;pci_dev
comma
id|IOC4_PRD_ENTRIES
op_star
id|IOC4_PRD_BYTES
comma
op_amp
id|hwif-&gt;dmatable_dma
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hwif-&gt;dmatable_cpu
)paren
r_goto
id|dma_alloc_failure
suffix:semicolon
id|hwif-&gt;sg_table
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|scatterlist
)paren
op_star
id|IOC4_PRD_ENTRIES
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hwif-&gt;sg_table
)paren
r_goto
id|dma_sgalloc_failure
suffix:semicolon
id|hwif-&gt;dma_base2
op_assign
(paren
r_int
r_int
)paren
id|pci_alloc_consistent
c_func
(paren
id|hwif-&gt;pci_dev
comma
id|IOC4_IDE_CACHELINE_SIZE
comma
(paren
id|dma_addr_t
op_star
)paren
op_amp
(paren
id|hwif-&gt;dma_status
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hwif-&gt;dma_base2
)paren
r_goto
id|dma_base2alloc_failure
suffix:semicolon
r_return
suffix:semicolon
id|dma_base2alloc_failure
suffix:colon
id|kfree
c_func
(paren
id|hwif-&gt;sg_table
)paren
suffix:semicolon
id|dma_sgalloc_failure
suffix:colon
id|pci_free_consistent
c_func
(paren
id|hwif-&gt;pci_dev
comma
id|IOC4_PRD_ENTRIES
op_star
id|IOC4_PRD_BYTES
comma
id|hwif-&gt;dmatable_cpu
comma
id|hwif-&gt;dmatable_dma
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s() -- Error! Unable to allocate DMA Maps for drive %s&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|hwif-&gt;name
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Changing from DMA to PIO mode for Drive %s&bslash;n&quot;
comma
id|hwif-&gt;name
)paren
suffix:semicolon
id|dma_alloc_failure
suffix:colon
multiline_comment|/* Disable DMA because we couldnot allocate any DMA maps */
id|hwif-&gt;autodma
op_assign
l_int|0
suffix:semicolon
id|hwif-&gt;atapi_dma
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Initializes the IOC4 DMA Engine */
r_static
r_void
DECL|function|sgiioc4_configure_for_dma
id|sgiioc4_configure_for_dma
c_func
(paren
r_int
id|dma_direction
comma
id|ide_drive_t
op_star
id|drive
)paren
(brace
id|u32
id|ioc4_dma
suffix:semicolon
id|ide_hwif_t
op_star
id|hwif
op_assign
id|HWIF
c_func
(paren
id|drive
)paren
suffix:semicolon
id|u64
id|dma_base
op_assign
id|hwif-&gt;dma_base
suffix:semicolon
id|u32
id|dma_addr
comma
id|ending_dma_addr
suffix:semicolon
id|ioc4_dma
op_assign
id|hwif
op_member_access_from_pointer
id|INL
c_func
(paren
id|dma_base
op_plus
id|IOC4_DMA_CTRL
op_star
l_int|4
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioc4_dma
op_amp
id|IOC4_S_DMA_ACTIVE
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s(%s):Warning!! DMA from previous transfer was still active&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|drive-&gt;name
)paren
suffix:semicolon
id|hwif
op_member_access_from_pointer
id|OUTL
c_func
(paren
id|IOC4_S_DMA_STOP
comma
id|dma_base
op_plus
id|IOC4_DMA_CTRL
op_star
l_int|4
)paren
suffix:semicolon
id|ioc4_dma
op_assign
id|sgiioc4_ide_dma_stop
c_func
(paren
id|hwif
comma
id|dma_base
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioc4_dma
op_amp
id|IOC4_S_DMA_STOP
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s(%s) : IOC4 Dma STOP bit is still 1&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|drive-&gt;name
)paren
suffix:semicolon
)brace
id|ioc4_dma
op_assign
id|hwif
op_member_access_from_pointer
id|INL
c_func
(paren
id|dma_base
op_plus
id|IOC4_DMA_CTRL
op_star
l_int|4
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioc4_dma
op_amp
id|IOC4_S_DMA_ERROR
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s(%s) : Warning!! - DMA Error during Previous&quot;
l_string|&quot; transfer | status 0x%x&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|drive-&gt;name
comma
id|ioc4_dma
)paren
suffix:semicolon
id|hwif
op_member_access_from_pointer
id|OUTL
c_func
(paren
id|IOC4_S_DMA_STOP
comma
id|dma_base
op_plus
id|IOC4_DMA_CTRL
op_star
l_int|4
)paren
suffix:semicolon
id|ioc4_dma
op_assign
id|sgiioc4_ide_dma_stop
c_func
(paren
id|hwif
comma
id|dma_base
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioc4_dma
op_amp
id|IOC4_S_DMA_STOP
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s(%s) : IOC4 DMA STOP bit is still 1&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|drive-&gt;name
)paren
suffix:semicolon
)brace
multiline_comment|/* Address of the Scatter Gather List */
id|dma_addr
op_assign
id|cpu_to_le32
c_func
(paren
id|hwif-&gt;dmatable_dma
)paren
suffix:semicolon
id|hwif
op_member_access_from_pointer
id|OUTL
c_func
(paren
id|dma_addr
comma
id|dma_base
op_plus
id|IOC4_DMA_PTR_L
op_star
l_int|4
)paren
suffix:semicolon
multiline_comment|/* Address of the Ending DMA */
id|memset
c_func
(paren
(paren
r_int
r_int
op_star
)paren
id|hwif-&gt;dma_base2
comma
l_int|0
comma
id|IOC4_IDE_CACHELINE_SIZE
)paren
suffix:semicolon
id|ending_dma_addr
op_assign
id|cpu_to_le32
c_func
(paren
id|hwif-&gt;dma_status
)paren
suffix:semicolon
id|hwif
op_member_access_from_pointer
id|OUTL
c_func
(paren
id|ending_dma_addr
comma
id|dma_base
op_plus
id|IOC4_DMA_END_ADDR
op_star
l_int|4
)paren
suffix:semicolon
id|hwif
op_member_access_from_pointer
id|OUTL
c_func
(paren
id|dma_direction
comma
id|dma_base
op_plus
id|IOC4_DMA_CTRL
op_star
l_int|4
)paren
suffix:semicolon
id|drive-&gt;waiting_for_dma
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* IOC4 Scatter Gather list Format &t;&t;&t;&t;&t; */
multiline_comment|/* 128 Bit entries to support 64 bit addresses in the future&t;&t; */
multiline_comment|/* The Scatter Gather list Entry should be in the BIG-ENDIAN Format&t; */
multiline_comment|/* --------------------------------------------------------------------- */
multiline_comment|/* | Upper 32 bits - Zero           |&t; &t;Lower 32 bits- address | */
multiline_comment|/* --------------------------------------------------------------------- */
multiline_comment|/* | Upper 32 bits - Zero&t;    |EOL| 15 unused     | 16 Bit Length| */
multiline_comment|/* --------------------------------------------------------------------- */
multiline_comment|/* Creates the scatter gather list, DMA Table */
r_static
r_int
r_int
DECL|function|sgiioc4_build_dma_table
id|sgiioc4_build_dma_table
c_func
(paren
id|ide_drive_t
op_star
id|drive
comma
r_struct
id|request
op_star
id|rq
comma
r_int
id|ddir
)paren
(brace
id|ide_hwif_t
op_star
id|hwif
op_assign
id|HWIF
c_func
(paren
id|drive
)paren
suffix:semicolon
r_int
r_int
op_star
id|table
op_assign
id|hwif-&gt;dmatable_cpu
suffix:semicolon
r_int
r_int
id|count
op_assign
l_int|0
comma
id|i
op_assign
l_int|1
suffix:semicolon
r_struct
id|scatterlist
op_star
id|sg
suffix:semicolon
r_if
c_cond
(paren
id|HWGROUP
c_func
(paren
id|drive
)paren
op_member_access_from_pointer
id|rq-&gt;flags
op_amp
id|REQ_DRIVE_TASKFILE
)paren
id|hwif-&gt;sg_nents
op_assign
id|i
op_assign
id|ide_raw_build_sglist
c_func
(paren
id|drive
comma
id|rq
)paren
suffix:semicolon
r_else
id|hwif-&gt;sg_nents
op_assign
id|i
op_assign
id|ide_build_sglist
c_func
(paren
id|drive
comma
id|rq
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|i
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* sglist of length Zero */
id|sg
op_assign
id|hwif-&gt;sg_table
suffix:semicolon
r_while
c_loop
(paren
id|i
op_logical_and
id|sg_dma_len
c_func
(paren
id|sg
)paren
)paren
(brace
id|dma_addr_t
id|cur_addr
suffix:semicolon
r_int
id|cur_len
suffix:semicolon
id|cur_addr
op_assign
id|sg_dma_address
c_func
(paren
id|sg
)paren
suffix:semicolon
id|cur_len
op_assign
id|sg_dma_len
c_func
(paren
id|sg
)paren
suffix:semicolon
r_while
c_loop
(paren
id|cur_len
)paren
(brace
r_if
c_cond
(paren
id|count
op_increment
op_ge
id|IOC4_PRD_ENTRIES
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: DMA table too small&bslash;n&quot;
comma
id|drive-&gt;name
)paren
suffix:semicolon
r_goto
id|use_pio_instead
suffix:semicolon
)brace
r_else
(brace
id|u32
id|xcount
comma
id|bcount
op_assign
l_int|0x10000
op_minus
(paren
id|cur_addr
op_amp
l_int|0xffff
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bcount
OG
id|cur_len
)paren
id|bcount
op_assign
id|cur_len
suffix:semicolon
multiline_comment|/* put the addr, length in&n;&t;&t;&t;&t; * the IOC4 dma-table format */
op_star
id|table
op_assign
l_int|0x0
suffix:semicolon
id|table
op_increment
suffix:semicolon
op_star
id|table
op_assign
id|cpu_to_be32
c_func
(paren
id|cur_addr
)paren
suffix:semicolon
id|table
op_increment
suffix:semicolon
op_star
id|table
op_assign
l_int|0x0
suffix:semicolon
id|table
op_increment
suffix:semicolon
id|xcount
op_assign
id|bcount
op_amp
l_int|0xffff
suffix:semicolon
op_star
id|table
op_assign
id|cpu_to_be32
c_func
(paren
id|xcount
)paren
suffix:semicolon
id|table
op_increment
suffix:semicolon
id|cur_addr
op_add_assign
id|bcount
suffix:semicolon
id|cur_len
op_sub_assign
id|bcount
suffix:semicolon
)brace
)brace
id|sg
op_increment
suffix:semicolon
id|i
op_decrement
suffix:semicolon
)brace
r_if
c_cond
(paren
id|count
)paren
(brace
id|table
op_decrement
suffix:semicolon
op_star
id|table
op_or_assign
id|cpu_to_be32
c_func
(paren
l_int|0x80000000
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
id|use_pio_instead
suffix:colon
id|pci_unmap_sg
c_func
(paren
id|hwif-&gt;pci_dev
comma
id|hwif-&gt;sg_table
comma
id|hwif-&gt;sg_nents
comma
id|hwif-&gt;sg_dma_direction
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* revert to PIO for this request */
)brace
r_static
r_int
DECL|function|sgiioc4_ide_dma_read
id|sgiioc4_ide_dma_read
c_func
(paren
id|ide_drive_t
op_star
id|drive
)paren
(brace
r_struct
id|request
op_star
id|rq
op_assign
id|HWGROUP
c_func
(paren
id|drive
)paren
op_member_access_from_pointer
id|rq
suffix:semicolon
r_int
r_int
id|count
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|count
op_assign
id|sgiioc4_build_dma_table
c_func
(paren
id|drive
comma
id|rq
comma
id|PCI_DMA_FROMDEVICE
)paren
)paren
)paren
(brace
multiline_comment|/* try PIO instead of DMA */
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Writes FROM the IOC4 TO Main Memory */
id|sgiioc4_configure_for_dma
c_func
(paren
id|IOC4_DMA_WRITE
comma
id|drive
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|sgiioc4_ide_dma_write
id|sgiioc4_ide_dma_write
c_func
(paren
id|ide_drive_t
op_star
id|drive
)paren
(brace
r_struct
id|request
op_star
id|rq
op_assign
id|HWGROUP
c_func
(paren
id|drive
)paren
op_member_access_from_pointer
id|rq
suffix:semicolon
r_int
r_int
id|count
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|count
op_assign
id|sgiioc4_build_dma_table
c_func
(paren
id|drive
comma
id|rq
comma
id|PCI_DMA_TODEVICE
)paren
)paren
)paren
(brace
multiline_comment|/* try PIO instead of DMA */
r_return
l_int|1
suffix:semicolon
)brace
id|sgiioc4_configure_for_dma
c_func
(paren
id|IOC4_DMA_READ
comma
id|drive
)paren
suffix:semicolon
multiline_comment|/* Writes TO the IOC4 FROM Main Memory */
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
id|__init
DECL|function|ide_init_sgiioc4
id|ide_init_sgiioc4
c_func
(paren
id|ide_hwif_t
op_star
id|hwif
)paren
(brace
id|hwif-&gt;mmio
op_assign
l_int|2
suffix:semicolon
id|hwif-&gt;autodma
op_assign
l_int|1
suffix:semicolon
id|hwif-&gt;atapi_dma
op_assign
l_int|1
suffix:semicolon
id|hwif-&gt;ultra_mask
op_assign
l_int|0x0
suffix:semicolon
multiline_comment|/* Disable Ultra DMA */
id|hwif-&gt;mwdma_mask
op_assign
l_int|0x2
suffix:semicolon
multiline_comment|/* Multimode-2 DMA  */
id|hwif-&gt;swdma_mask
op_assign
l_int|0x2
suffix:semicolon
id|hwif-&gt;identify
op_assign
l_int|NULL
suffix:semicolon
id|hwif-&gt;tuneproc
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Sets timing for PIO mode */
id|hwif-&gt;speedproc
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Sets timing for DMA &amp;/or PIO modes */
id|hwif-&gt;selectproc
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Use the default routine to select drive */
id|hwif-&gt;reset_poll
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* No HBA specific reset_poll needed */
id|hwif-&gt;pre_reset
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* No HBA specific pre_set needed */
id|hwif-&gt;resetproc
op_assign
op_amp
id|sgiioc4_resetproc
suffix:semicolon
multiline_comment|/* Reset DMA engine,&n;&t;&t;&t;&t;&t;&t;clear interrupts */
id|hwif-&gt;intrproc
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Enable or Disable interrupt from drive */
id|hwif-&gt;maskproc
op_assign
op_amp
id|sgiioc4_maskproc
suffix:semicolon
multiline_comment|/* Mask on/off NIEN register */
id|hwif-&gt;quirkproc
op_assign
l_int|NULL
suffix:semicolon
id|hwif-&gt;busproc
op_assign
l_int|NULL
suffix:semicolon
id|hwif-&gt;ide_dma_read
op_assign
op_amp
id|sgiioc4_ide_dma_read
suffix:semicolon
id|hwif-&gt;ide_dma_write
op_assign
op_amp
id|sgiioc4_ide_dma_write
suffix:semicolon
id|hwif-&gt;ide_dma_begin
op_assign
op_amp
id|sgiioc4_ide_dma_begin
suffix:semicolon
id|hwif-&gt;ide_dma_end
op_assign
op_amp
id|sgiioc4_ide_dma_end
suffix:semicolon
id|hwif-&gt;ide_dma_check
op_assign
op_amp
id|sgiioc4_ide_dma_check
suffix:semicolon
id|hwif-&gt;ide_dma_on
op_assign
op_amp
id|sgiioc4_ide_dma_on
suffix:semicolon
id|hwif-&gt;ide_dma_off_quietly
op_assign
op_amp
id|sgiioc4_ide_dma_off_quietly
suffix:semicolon
id|hwif-&gt;ide_dma_test_irq
op_assign
op_amp
id|sgiioc4_ide_dma_test_irq
suffix:semicolon
id|hwif-&gt;ide_dma_host_on
op_assign
op_amp
id|sgiioc4_ide_dma_host_on
suffix:semicolon
id|hwif-&gt;ide_dma_host_off
op_assign
op_amp
id|sgiioc4_ide_dma_host_off
suffix:semicolon
id|hwif-&gt;ide_dma_verbose
op_assign
op_amp
id|sgiioc4_ide_dma_verbose
suffix:semicolon
id|hwif-&gt;ide_dma_lostirq
op_assign
op_amp
id|sgiioc4_ide_dma_lostirq
suffix:semicolon
id|hwif-&gt;ide_dma_timeout
op_assign
op_amp
id|__ide_dma_timeout
suffix:semicolon
id|hwif-&gt;INB
op_assign
op_amp
id|sgiioc4_INB
suffix:semicolon
)brace
r_static
r_int
id|__init
DECL|function|sgiioc4_ide_setup_pci_device
id|sgiioc4_ide_setup_pci_device
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
id|ide_pci_device_t
op_star
id|d
)paren
(brace
r_int
r_int
id|base
comma
id|ctl
comma
id|dma_base
comma
id|irqport
suffix:semicolon
id|ide_hwif_t
op_star
id|hwif
suffix:semicolon
r_int
id|h
suffix:semicolon
r_for
c_loop
(paren
id|h
op_assign
l_int|0
suffix:semicolon
id|h
OL
id|MAX_HWIFS
suffix:semicolon
op_increment
id|h
)paren
(brace
id|hwif
op_assign
op_amp
id|ide_hwifs
(braket
id|h
)braket
suffix:semicolon
multiline_comment|/* Find an empty HWIF */
r_if
c_cond
(paren
id|hwif-&gt;chipset
op_eq
id|ide_unknown
)paren
r_break
suffix:semicolon
)brace
multiline_comment|/*  Get the CmdBlk and CtrlBlk Base Registers */
id|base
op_assign
id|pci_resource_start
c_func
(paren
id|dev
comma
l_int|0
)paren
op_plus
id|IOC4_CMD_OFFSET
suffix:semicolon
id|ctl
op_assign
id|pci_resource_start
c_func
(paren
id|dev
comma
l_int|0
)paren
op_plus
id|IOC4_CTRL_OFFSET
suffix:semicolon
id|irqport
op_assign
id|pci_resource_start
c_func
(paren
id|dev
comma
l_int|0
)paren
op_plus
id|IOC4_INTR_OFFSET
suffix:semicolon
id|dma_base
op_assign
id|pci_resource_start
c_func
(paren
id|dev
comma
l_int|0
)paren
op_plus
id|IOC4_DMA_OFFSET
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|request_region
c_func
(paren
id|base
comma
id|IOC4_CMD_CTL_BLK_SIZE
comma
id|hwif-&gt;name
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s : %s -- ERROR, Port Addresses &quot;
l_string|&quot;0x%p to 0x%p ALREADY in use&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|hwif-&gt;name
comma
(paren
r_void
op_star
)paren
id|base
comma
(paren
r_void
op_star
)paren
id|base
op_plus
id|IOC4_CMD_CTL_BLK_SIZE
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hwif-&gt;io_ports
(braket
id|IDE_DATA_OFFSET
)braket
op_ne
id|base
)paren
(brace
multiline_comment|/* Initialize the IO registers */
id|sgiioc4_init_hwif_ports
c_func
(paren
op_amp
id|hwif-&gt;hw
comma
id|base
comma
id|ctl
comma
id|irqport
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|hwif-&gt;io_ports
comma
id|hwif-&gt;hw.io_ports
comma
r_sizeof
(paren
id|hwif-&gt;io_ports
)paren
)paren
suffix:semicolon
id|hwif-&gt;noprobe
op_assign
op_logical_neg
id|hwif-&gt;io_ports
(braket
id|IDE_DATA_OFFSET
)braket
suffix:semicolon
)brace
id|hwif-&gt;irq
op_assign
id|dev-&gt;irq
suffix:semicolon
id|hwif-&gt;chipset
op_assign
id|ide_pci
suffix:semicolon
id|hwif-&gt;pci_dev
op_assign
id|dev
suffix:semicolon
id|hwif-&gt;channel
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Single Channel chip */
id|hwif-&gt;cds
op_assign
(paren
r_struct
id|ide_pci_device_s
op_star
)paren
id|d
suffix:semicolon
id|hwif-&gt;gendev.parent
op_assign
op_amp
id|dev-&gt;dev
suffix:semicolon
multiline_comment|/* setup proper ancestral information */
multiline_comment|/* Initializing chipset IRQ Registers */
id|hwif
op_member_access_from_pointer
id|OUTL
c_func
(paren
l_int|0x03
comma
id|irqport
op_plus
id|IOC4_INTR_SET
op_star
l_int|4
)paren
suffix:semicolon
id|ide_init_sgiioc4
c_func
(paren
id|hwif
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dma_base
)paren
id|ide_dma_sgiioc4
c_func
(paren
id|hwif
comma
id|dma_base
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %s Bus-Master DMA disabled&bslash;n&quot;
comma
id|hwif-&gt;name
comma
id|d-&gt;name
)paren
suffix:semicolon
id|probe_hwif_init
c_func
(paren
id|hwif
)paren
suffix:semicolon
multiline_comment|/* Create /proc/ide entries */
id|create_proc_ide_interfaces
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
r_int
id|__init
DECL|function|pci_init_sgiioc4
id|pci_init_sgiioc4
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
id|ide_pci_device_t
op_star
id|d
)paren
(brace
r_int
r_int
id|class_rev
suffix:semicolon
r_if
c_cond
(paren
id|pci_enable_device
c_func
(paren
id|dev
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Failed to enable device %s at slot %s&bslash;n&quot;
comma
id|d-&gt;name
comma
id|dev-&gt;slot_name
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|pci_set_master
c_func
(paren
id|dev
)paren
suffix:semicolon
id|pci_read_config_dword
c_func
(paren
id|dev
comma
id|PCI_CLASS_REVISION
comma
op_amp
id|class_rev
)paren
suffix:semicolon
id|class_rev
op_and_assign
l_int|0xff
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: IDE controller at PCI slot %s, revision %d&bslash;n&quot;
comma
id|d-&gt;name
comma
id|dev-&gt;slot_name
comma
id|class_rev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|class_rev
OL
id|IOC4_SUPPORTED_FIRMWARE_REV
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Skipping %s IDE controller in slot %s: &quot;
l_string|&quot;firmware is obsolete - please upgrade to revision&quot;
l_string|&quot;46 or higher&bslash;n&quot;
comma
id|d-&gt;name
comma
id|dev-&gt;slot_name
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_return
id|sgiioc4_ide_setup_pci_device
c_func
(paren
id|dev
comma
id|d
)paren
suffix:semicolon
)brace
DECL|variable|__devinitdata
r_static
id|ide_pci_device_t
id|sgiioc4_chipsets
(braket
)braket
id|__devinitdata
op_assign
(brace
(brace
multiline_comment|/* Channel 0 */
dot
id|name
op_assign
l_string|&quot;SGIIOC4&quot;
comma
dot
id|init_hwif
op_assign
id|ide_init_sgiioc4
comma
dot
id|init_dma
op_assign
id|ide_dma_sgiioc4
comma
dot
id|channels
op_assign
l_int|1
comma
dot
id|autodma
op_assign
id|AUTODMA
comma
multiline_comment|/* SGI IOC4 doesn&squot;t have enablebits. */
dot
id|bootable
op_assign
id|ON_BOARD
comma
)brace
)brace
suffix:semicolon
r_static
r_int
id|__devinit
DECL|function|sgiioc4_init_one
id|sgiioc4_init_one
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_const
r_struct
id|pci_device_id
op_star
id|id
)paren
(brace
id|pci_init_sgiioc4
c_func
(paren
id|dev
comma
op_amp
id|sgiioc4_chipsets
(braket
id|id-&gt;driver_data
)braket
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|sgiioc4_pci_tbl
r_static
r_struct
id|pci_device_id
id|sgiioc4_pci_tbl
(braket
)braket
op_assign
(brace
(brace
id|PCI_VENDOR_ID_SGI
comma
id|PCI_DEVICE_ID_SGI_IOC4
comma
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
l_int|0x0b4000
comma
l_int|0xFFFFFF
comma
l_int|0
)brace
comma
(brace
l_int|0
)brace
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|pci
comma
id|sgiioc4_pci_tbl
)paren
suffix:semicolon
DECL|variable|driver
r_static
r_struct
id|pci_driver
id|driver
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;SGI-IOC4_IDE&quot;
comma
dot
id|id_table
op_assign
id|sgiioc4_pci_tbl
comma
dot
id|probe
op_assign
id|sgiioc4_init_one
comma
)brace
suffix:semicolon
r_static
r_int
DECL|function|sgiioc4_ide_init
id|sgiioc4_ide_init
c_func
(paren
r_void
)paren
(brace
r_return
id|ide_pci_register_driver
c_func
(paren
op_amp
id|driver
)paren
suffix:semicolon
)brace
DECL|variable|sgiioc4_ide_init
id|module_init
c_func
(paren
id|sgiioc4_ide_init
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Aniket Malatpure - Silicon Graphics Inc. (SGI)&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;PCI driver module for SGI IOC4 Base-IO Card&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
eof
