multiline_comment|/*&n; *  ide_pc9800.c&n; *&n; *  Copyright (C) 1997-2000  Linux/98 project,&n; *&t;&t;&t;     Kyoto University Microcomputer Club.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/ide.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/pc9800.h&gt;
DECL|macro|PC9800_IDE_BANKSELECT
mdefine_line|#define PC9800_IDE_BANKSELECT&t;0x432
DECL|macro|PC9800_IDE_DEBUG
macro_line|#undef PC9800_IDE_DEBUG
DECL|function|pc9800_select
r_static
r_void
id|pc9800_select
c_func
(paren
id|ide_drive_t
op_star
id|drive
)paren
(brace
macro_line|#ifdef PC9800_IDE_DEBUG
id|byte
id|old
suffix:semicolon
multiline_comment|/* Too noisy: */
multiline_comment|/* printk(KERN_DEBUG &quot;pc9800_select(%s)&bslash;n&quot;, drive-&gt;name); */
id|outb
c_func
(paren
l_int|0x80
comma
id|PC9800_IDE_BANKSELECT
)paren
suffix:semicolon
id|old
op_assign
id|inb
c_func
(paren
id|PC9800_IDE_BANKSELECT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|old
op_ne
id|HWIF
c_func
(paren
id|drive
)paren
op_member_access_from_pointer
id|index
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;ide-pc9800: switching bank #%d -&gt; #%d&bslash;n&quot;
comma
id|old
comma
id|HWIF
c_func
(paren
id|drive
)paren
op_member_access_from_pointer
id|index
)paren
suffix:semicolon
macro_line|#endif
id|outb
c_func
(paren
id|HWIF
c_func
(paren
id|drive
)paren
op_member_access_from_pointer
id|index
comma
id|PC9800_IDE_BANKSELECT
)paren
suffix:semicolon
)brace
DECL|function|ide_probe_for_pc9800
r_void
id|__init
id|ide_probe_for_pc9800
c_func
(paren
r_void
)paren
(brace
id|u8
id|saved_bank
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|PC9800_9821_P
c_func
(paren
)paren
multiline_comment|/* || !PC9821_IDEIF_DOUBLE_P() */
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|request_region
c_func
(paren
id|PC9800_IDE_BANKSELECT
comma
l_int|1
comma
l_string|&quot;ide0/1 bank&quot;
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ide: bank select port (%#x) is already occupied!&bslash;n&quot;
comma
id|PC9800_IDE_BANKSELECT
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Do actual probing. */
r_if
c_cond
(paren
(paren
id|saved_bank
op_assign
id|inb
c_func
(paren
id|PC9800_IDE_BANKSELECT
)paren
)paren
op_eq
(paren
id|u8
)paren
op_complement
l_int|0
op_logical_or
(paren
id|outb
c_func
(paren
id|saved_bank
op_xor
l_int|1
comma
id|PC9800_IDE_BANKSELECT
)paren
comma
multiline_comment|/* Next outb is dummy for reading status. */
id|outb
c_func
(paren
l_int|0x80
comma
id|PC9800_IDE_BANKSELECT
)paren
comma
id|inb
c_func
(paren
id|PC9800_IDE_BANKSELECT
)paren
op_ne
(paren
id|saved_bank
op_xor
l_int|1
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;ide: pc9800 type bank selecting port not found&bslash;n&quot;
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|PC9800_IDE_BANKSELECT
comma
l_int|1
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Restore original value, just in case. */
id|outb
c_func
(paren
id|saved_bank
comma
id|PC9800_IDE_BANKSELECT
)paren
suffix:semicolon
multiline_comment|/* These ports are reseved by IDE I/F.  */
r_if
c_cond
(paren
op_logical_neg
id|request_region
c_func
(paren
l_int|0x430
comma
l_int|1
comma
l_string|&quot;ide&quot;
)paren
op_logical_or
op_logical_neg
id|request_region
c_func
(paren
l_int|0x435
comma
l_int|1
comma
l_string|&quot;ide&quot;
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;ide: IO port 0x430 and 0x435 are reserved for IDE&quot;
l_string|&quot; the card using these ports may not work&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ide_hwifs
(braket
l_int|0
)braket
dot
id|io_ports
(braket
id|IDE_DATA_OFFSET
)braket
op_eq
id|HD_DATA
op_logical_and
id|ide_hwifs
(braket
l_int|1
)braket
dot
id|io_ports
(braket
id|IDE_DATA_OFFSET
)braket
op_eq
id|HD_DATA
)paren
(brace
id|ide_hwifs
(braket
l_int|0
)braket
dot
id|chipset
op_assign
id|ide_pc9800
suffix:semicolon
id|ide_hwifs
(braket
l_int|0
)braket
dot
id|mate
op_assign
op_amp
id|ide_hwifs
(braket
l_int|1
)braket
suffix:semicolon
id|ide_hwifs
(braket
l_int|0
)braket
dot
id|selectproc
op_assign
id|pc9800_select
suffix:semicolon
id|ide_hwifs
(braket
l_int|1
)braket
dot
id|chipset
op_assign
id|ide_pc9800
suffix:semicolon
id|ide_hwifs
(braket
l_int|1
)braket
dot
id|mate
op_assign
op_amp
id|ide_hwifs
(braket
l_int|0
)braket
suffix:semicolon
id|ide_hwifs
(braket
l_int|1
)braket
dot
id|selectproc
op_assign
id|pc9800_select
suffix:semicolon
)brace
)brace
eof
