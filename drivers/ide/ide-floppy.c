multiline_comment|/*&n; * linux/drivers/ide/ide-floppy.c&t;Version 0.99&t;Feb 24 2002&n; *&n; * Copyright (C) 1996 - 1999 Gadi Oxman &lt;gadio@netvision.net.il&gt;&n; * Copyright (C) 2000 - 2002 Paul Bristow &lt;paul@paulbristow.net&gt;&n; */
multiline_comment|/*&n; * IDE ATAPI floppy driver.&n; *&n; * The driver currently doesn&squot;t have any fancy features, just the bare&n; * minimum read/write support.&n; *&n; * This driver supports the following IDE floppy drives:&n; *&n; * LS-120/240 SuperDisk&n; * Iomega Zip 100/250&n; * Iomega PC Card Clik!/PocketZip&n; *&n; * Many thanks to Lode Leroy &lt;Lode.Leroy@www.ibase.be&gt;, who tested so many&n; * ALPHA patches to this driver on an EASYSTOR LS-120 ATAPI floppy drive.&n; *&n; * Ver 0.1   Oct 17 96   Initial test version, mostly based on ide-tape.c.&n; * Ver 0.2   Oct 31 96   Minor changes.&n; * Ver 0.3   Dec  2 96   Fixed error recovery bug.&n; * Ver 0.4   Jan 26 97   Add support for the HDIO_GETGEO ioctl.&n; * Ver 0.5   Feb 21 97   Add partitions support.&n; *                       Use the minimum of the LBA and CHS capacities.&n; *                       Avoid hwgroup-&gt;rq == NULL on the last irq.&n; *                       Fix potential null dereferencing with DEBUG_LOG.&n; * Ver 0.8   Dec  7 97   Increase irq timeout from 10 to 50 seconds.&n; *                       Add media write-protect detection.&n; *                       Issue START command only if TEST UNIT READY fails.&n; *                       Add work-around for IOMEGA ZIP revision 21.D.&n; *                       Remove idefloppy_get_capabilities().&n; * Ver 0.9   Jul  4 99   Fix a bug which might have caused the number of&n; *                        bytes requested on each interrupt to be zero.&n; *                        Thanks to &lt;shanos@es.co.nz&gt; for pointing this out.&n; * Ver 0.9.sv Jan 6 01   Sam Varshavchik &lt;mrsam@courier-mta.com&gt;&n; *                       Implement low level formatting.  Reimplemented&n; *                       IDEFLOPPY_CAPABILITIES_PAGE, since we need the srfp&n; *                       bit.  My LS-120 drive barfs on&n; *                       IDEFLOPPY_CAPABILITIES_PAGE, but maybe it&squot;s just me.&n; *                       Compromise by not reporting a failure to get this&n; *                       mode page.  Implemented four IOCTLs in order to&n; *                       implement formatting.  IOCTls begin with 0x4600,&n; *                       0x46 is &squot;F&squot; as in Format.&n; *            Jan 9 01   Userland option to select format verify.&n; *                       Added PC_SUPPRESS_ERROR flag - some idefloppy drives&n; *                       do not implement IDEFLOPPY_CAPABILITIES_PAGE, and&n; *                       return a sense error.  Suppress error reporting in&n; *                       this particular case in order to avoid spurious&n; *                       errors in syslog.  The culprit is&n; *                       idefloppy_get_capability_page(), so move it to&n; *                       idefloppy_begin_format() so that it&squot;s not used&n; *                       unless absolutely necessary.&n; *                       If drive does not support format progress indication&n; *                       monitor the dsc bit in the status register.&n; *                       Also, O_NDELAY on open will allow the device to be&n; *                       opened without a disk available.  This can be used to&n; *                       open an unformatted disk, or get the device capacity.&n; * Ver 0.91  Dec 11 99   Added IOMEGA Clik! drive support by &n; *     &t;&t;   &lt;paul@paulbristow.net&gt;&n; * Ver 0.92  Oct 22 00   Paul Bristow became official maintainer for this &n; *           &t;&t;   driver.  Included Powerbook internal zip kludge.&n; * Ver 0.93  Oct 24 00   Fixed bugs for Clik! drive&n; *                        no disk on insert and disk change now works&n; * Ver 0.94  Oct 27 00   Tidied up to remove strstr(Clik) everywhere&n; * Ver 0.95  Nov  7 00   Brought across to kernel 2.4&n; * Ver 0.96  Jan  7 01   Actually in line with release version of 2.4.0&n; *                       including set_bit patch from Rusty Russell&n; * Ver 0.97  Jul 22 01   Merge 0.91-0.96 onto 0.9.sv for ac series&n; * Ver 0.97.sv Aug 3 01  Backported from 2.4.7-ac3&n; * Ver 0.98  Oct 26 01   Split idefloppy_transfer_pc into two pieces to&n; *                        fix a lost interrupt problem. It appears the busy&n; *                        bit was being deasserted by my IOMEGA ATAPI ZIP 100&n; *                        drive before the drive was actually ready.&n; * Ver 0.98a Oct 29 01   Expose delay value so we can play.&n; * Ver 0.99  Feb 24 02   Remove duplicate code, modify clik! detection code &n; *                        to support new PocketZip drives &n; */
DECL|macro|IDEFLOPPY_VERSION
mdefine_line|#define IDEFLOPPY_VERSION &quot;0.99.newide&quot;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/major.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/genhd.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/cdrom.h&gt;
macro_line|#include &lt;linux/ide.h&gt;
macro_line|#include &lt;linux/bitops.h&gt;
macro_line|#include &lt;asm/byteorder.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/unaligned.h&gt;
multiline_comment|/*&n; *&t;The following are used to debug the driver.&n; */
DECL|macro|IDEFLOPPY_DEBUG_LOG
mdefine_line|#define IDEFLOPPY_DEBUG_LOG&t;&t;0
DECL|macro|IDEFLOPPY_DEBUG_INFO
mdefine_line|#define IDEFLOPPY_DEBUG_INFO&t;&t;0
DECL|macro|IDEFLOPPY_DEBUG_BUGS
mdefine_line|#define IDEFLOPPY_DEBUG_BUGS&t;&t;1
multiline_comment|/* #define IDEFLOPPY_DEBUG(fmt, args...) printk(KERN_INFO fmt, ## args) */
DECL|macro|IDEFLOPPY_DEBUG
mdefine_line|#define IDEFLOPPY_DEBUG( fmt, args... )
macro_line|#if IDEFLOPPY_DEBUG_LOG
DECL|macro|debug_log
mdefine_line|#define debug_log printk
macro_line|#else
DECL|macro|debug_log
mdefine_line|#define debug_log(fmt, args... ) do {} while(0)
macro_line|#endif
multiline_comment|/*&n; *&t;Some drives require a longer irq timeout.&n; */
DECL|macro|IDEFLOPPY_WAIT_CMD
mdefine_line|#define IDEFLOPPY_WAIT_CMD&t;&t;(5 * WAIT_CMD)
multiline_comment|/*&n; *&t;After each failed packet command we issue a request sense command&n; *&t;and retry the packet command IDEFLOPPY_MAX_PC_RETRIES times.&n; */
DECL|macro|IDEFLOPPY_MAX_PC_RETRIES
mdefine_line|#define IDEFLOPPY_MAX_PC_RETRIES&t;3
multiline_comment|/*&n; *&t;With each packet command, we allocate a buffer of&n; *&t;IDEFLOPPY_PC_BUFFER_SIZE bytes.&n; */
DECL|macro|IDEFLOPPY_PC_BUFFER_SIZE
mdefine_line|#define IDEFLOPPY_PC_BUFFER_SIZE&t;256
multiline_comment|/*&n; *&t;In various places in the driver, we need to allocate storage&n; *&t;for packet commands and requests, which will remain valid while&n; *&t;we leave the driver to wait for an interrupt or a timeout event.&n; */
DECL|macro|IDEFLOPPY_PC_STACK
mdefine_line|#define IDEFLOPPY_PC_STACK&t;&t;(10 + IDEFLOPPY_MAX_PC_RETRIES)
multiline_comment|/*&n; *&t;Our view of a packet command.&n; */
DECL|struct|idefloppy_packet_command_s
r_typedef
r_struct
id|idefloppy_packet_command_s
(brace
DECL|member|c
id|u8
id|c
(braket
l_int|12
)braket
suffix:semicolon
multiline_comment|/* Actual packet bytes */
DECL|member|retries
r_int
id|retries
suffix:semicolon
multiline_comment|/* On each retry, we increment retries */
DECL|member|error
r_int
id|error
suffix:semicolon
multiline_comment|/* Error code */
DECL|member|request_transfer
r_int
id|request_transfer
suffix:semicolon
multiline_comment|/* Bytes to transfer */
DECL|member|actually_transferred
r_int
id|actually_transferred
suffix:semicolon
multiline_comment|/* Bytes actually transferred */
DECL|member|buffer_size
r_int
id|buffer_size
suffix:semicolon
multiline_comment|/* Size of our data buffer */
DECL|member|b_count
r_int
id|b_count
suffix:semicolon
multiline_comment|/* Missing/Available data on the current buffer */
DECL|member|rq
r_struct
id|request
op_star
id|rq
suffix:semicolon
multiline_comment|/* The corresponding request */
DECL|member|buffer
id|u8
op_star
id|buffer
suffix:semicolon
multiline_comment|/* Data buffer */
DECL|member|current_position
id|u8
op_star
id|current_position
suffix:semicolon
multiline_comment|/* Pointer into the above buffer */
DECL|member|callback
r_void
(paren
op_star
id|callback
)paren
(paren
id|ide_drive_t
op_star
)paren
suffix:semicolon
multiline_comment|/* Called when this packet command is completed */
DECL|member|pc_buffer
id|u8
id|pc_buffer
(braket
id|IDEFLOPPY_PC_BUFFER_SIZE
)braket
suffix:semicolon
multiline_comment|/* Temporary buffer */
DECL|member|flags
r_int
r_int
id|flags
suffix:semicolon
multiline_comment|/* Status/Action bit flags: long for set_bit */
DECL|typedef|idefloppy_pc_t
)brace
id|idefloppy_pc_t
suffix:semicolon
multiline_comment|/*&n; *&t;Packet command flag bits.&n; */
DECL|macro|PC_ABORT
mdefine_line|#define&t;PC_ABORT&t;&t;&t;0&t;/* Set when an error is considered normal - We won&squot;t retry */
DECL|macro|PC_DMA_RECOMMENDED
mdefine_line|#define PC_DMA_RECOMMENDED&t;&t;2&t;/* 1 when we prefer to use DMA if possible */
DECL|macro|PC_DMA_IN_PROGRESS
mdefine_line|#define&t;PC_DMA_IN_PROGRESS&t;&t;3&t;/* 1 while DMA in progress */
DECL|macro|PC_DMA_ERROR
mdefine_line|#define&t;PC_DMA_ERROR&t;&t;&t;4&t;/* 1 when encountered problem during DMA */
DECL|macro|PC_WRITING
mdefine_line|#define&t;PC_WRITING&t;&t;&t;5&t;/* Data direction */
DECL|macro|PC_SUPPRESS_ERROR
mdefine_line|#define&t;PC_SUPPRESS_ERROR&t;&t;6&t;/* Suppress error reporting */
multiline_comment|/*&n; *&t;Removable Block Access Capabilities Page&n; */
r_typedef
r_struct
(brace
macro_line|#if defined(__LITTLE_ENDIAN_BITFIELD)
DECL|member|page_code
r_int
id|page_code
suffix:colon
l_int|6
suffix:semicolon
multiline_comment|/* Page code - Should be 0x1b */
DECL|member|reserved1_6
r_int
id|reserved1_6
suffix:colon
l_int|1
suffix:semicolon
multiline_comment|/* Reserved */
DECL|member|ps
r_int
id|ps
suffix:colon
l_int|1
suffix:semicolon
multiline_comment|/* Should be 0 */
macro_line|#elif defined(__BIG_ENDIAN_BITFIELD)
r_int
id|ps
suffix:colon
l_int|1
suffix:semicolon
multiline_comment|/* Should be 0 */
r_int
id|reserved1_6
suffix:colon
l_int|1
suffix:semicolon
multiline_comment|/* Reserved */
r_int
id|page_code
suffix:colon
l_int|6
suffix:semicolon
multiline_comment|/* Page code - Should be 0x1b */
macro_line|#else
macro_line|#error &quot;Bitfield endianness not defined! Check your byteorder.h&quot;
macro_line|#endif
DECL|member|page_length
id|u8
id|page_length
suffix:semicolon
multiline_comment|/* Page Length - Should be 0xa */
macro_line|#if defined(__LITTLE_ENDIAN_BITFIELD)
DECL|member|reserved2
r_int
id|reserved2
suffix:colon
l_int|6
suffix:semicolon
DECL|member|srfp
r_int
id|srfp
suffix:colon
l_int|1
suffix:semicolon
multiline_comment|/* Supports reporting progress of format */
DECL|member|sflp
r_int
id|sflp
suffix:colon
l_int|1
suffix:semicolon
multiline_comment|/* System floppy type device */
DECL|member|tlun
r_int
id|tlun
suffix:colon
l_int|3
suffix:semicolon
multiline_comment|/* Total logical units supported by the device */
DECL|member|reserved3
r_int
id|reserved3
suffix:colon
l_int|3
suffix:semicolon
DECL|member|sml
r_int
id|sml
suffix:colon
l_int|1
suffix:semicolon
multiline_comment|/* Single / Multiple lun supported */
DECL|member|ncd
r_int
id|ncd
suffix:colon
l_int|1
suffix:semicolon
multiline_comment|/* Non cd optical device */
macro_line|#elif defined(__BIG_ENDIAN_BITFIELD)
DECL|member|sflp
r_int
id|sflp
suffix:colon
l_int|1
suffix:semicolon
multiline_comment|/* System floppy type device */
DECL|member|srfp
r_int
id|srfp
suffix:colon
l_int|1
suffix:semicolon
multiline_comment|/* Supports reporting progress of format */
DECL|member|reserved2
r_int
id|reserved2
suffix:colon
l_int|6
suffix:semicolon
DECL|member|ncd
r_int
id|ncd
suffix:colon
l_int|1
suffix:semicolon
multiline_comment|/* Non cd optical device */
DECL|member|sml
r_int
id|sml
suffix:colon
l_int|1
suffix:semicolon
multiline_comment|/* Single / Multiple lun supported */
DECL|member|reserved3
r_int
id|reserved3
suffix:colon
l_int|3
suffix:semicolon
DECL|member|tlun
r_int
id|tlun
suffix:colon
l_int|3
suffix:semicolon
multiline_comment|/* Total logical units supported by the device */
macro_line|#else
macro_line|#error &quot;Bitfield endianness not defined! Check your byteorder.h&quot;
macro_line|#endif
DECL|member|reserved
id|u8
id|reserved
(braket
l_int|8
)braket
suffix:semicolon
DECL|typedef|idefloppy_capabilities_page_t
)brace
id|idefloppy_capabilities_page_t
suffix:semicolon
multiline_comment|/*&n; *&t;Flexible disk page.&n; */
r_typedef
r_struct
(brace
macro_line|#if defined(__LITTLE_ENDIAN_BITFIELD)
DECL|member|page_code
r_int
id|page_code
suffix:colon
l_int|6
suffix:semicolon
multiline_comment|/* Page code - Should be 0x5 */
DECL|member|reserved1_6
r_int
id|reserved1_6
suffix:colon
l_int|1
suffix:semicolon
multiline_comment|/* Reserved */
DECL|member|ps
r_int
id|ps
suffix:colon
l_int|1
suffix:semicolon
multiline_comment|/* The device is capable of saving the page */
macro_line|#elif defined(__BIG_ENDIAN_BITFIELD)
r_int
id|ps
suffix:colon
l_int|1
suffix:semicolon
multiline_comment|/* The device is capable of saving the page */
r_int
id|reserved1_6
suffix:colon
l_int|1
suffix:semicolon
multiline_comment|/* Reserved */
r_int
id|page_code
suffix:colon
l_int|6
suffix:semicolon
multiline_comment|/* Page code - Should be 0x5 */
macro_line|#else
macro_line|#error &quot;Bitfield endianness not defined! Check your byteorder.h&quot;
macro_line|#endif
DECL|member|page_length
id|u8
id|page_length
suffix:semicolon
multiline_comment|/* Page Length - Should be 0x1e */
DECL|member|transfer_rate
id|u16
id|transfer_rate
suffix:semicolon
multiline_comment|/* In kilobits per second */
DECL|member|heads
DECL|member|sectors
id|u8
id|heads
comma
id|sectors
suffix:semicolon
multiline_comment|/* Number of heads, Number of sectors per track */
DECL|member|sector_size
id|u16
id|sector_size
suffix:semicolon
multiline_comment|/* Byes per sector */
DECL|member|cyls
id|u16
id|cyls
suffix:semicolon
multiline_comment|/* Number of cylinders */
DECL|member|reserved10
id|u8
id|reserved10
(braket
l_int|10
)braket
suffix:semicolon
DECL|member|motor_delay
id|u8
id|motor_delay
suffix:semicolon
multiline_comment|/* Motor off delay */
DECL|member|reserved21
id|u8
id|reserved21
(braket
l_int|7
)braket
suffix:semicolon
DECL|member|rpm
id|u16
id|rpm
suffix:semicolon
multiline_comment|/* Rotations per minute */
DECL|member|reserved30
id|u8
id|reserved30
(braket
l_int|2
)braket
suffix:semicolon
DECL|typedef|idefloppy_flexible_disk_page_t
)brace
id|idefloppy_flexible_disk_page_t
suffix:semicolon
multiline_comment|/*&n; *&t;Format capacity&n; */
r_typedef
r_struct
(brace
DECL|member|reserved
id|u8
id|reserved
(braket
l_int|3
)braket
suffix:semicolon
DECL|member|length
id|u8
id|length
suffix:semicolon
multiline_comment|/* Length of the following descriptors in bytes */
DECL|typedef|idefloppy_capacity_header_t
)brace
id|idefloppy_capacity_header_t
suffix:semicolon
r_typedef
r_struct
(brace
DECL|member|blocks
id|u32
id|blocks
suffix:semicolon
multiline_comment|/* Number of blocks */
macro_line|#if defined(__LITTLE_ENDIAN_BITFIELD)
DECL|member|dc
r_int
id|dc
suffix:colon
l_int|2
suffix:semicolon
multiline_comment|/* Descriptor Code */
DECL|member|reserved
r_int
id|reserved
suffix:colon
l_int|6
suffix:semicolon
macro_line|#elif defined(__BIG_ENDIAN_BITFIELD)
DECL|member|reserved
r_int
id|reserved
suffix:colon
l_int|6
suffix:semicolon
DECL|member|dc
r_int
id|dc
suffix:colon
l_int|2
suffix:semicolon
multiline_comment|/* Descriptor Code */
macro_line|#else
macro_line|#error &quot;Bitfield endianness not defined! Check your byteorder.h&quot;
macro_line|#endif
DECL|member|length_msb
id|u8
id|length_msb
suffix:semicolon
multiline_comment|/* Block Length (MSB)*/
DECL|member|length
id|u16
id|length
suffix:semicolon
multiline_comment|/* Block Length */
DECL|typedef|idefloppy_capacity_descriptor_t
)brace
id|idefloppy_capacity_descriptor_t
suffix:semicolon
DECL|macro|CAPACITY_INVALID
mdefine_line|#define CAPACITY_INVALID&t;0x00
DECL|macro|CAPACITY_UNFORMATTED
mdefine_line|#define CAPACITY_UNFORMATTED&t;0x01
DECL|macro|CAPACITY_CURRENT
mdefine_line|#define CAPACITY_CURRENT&t;0x02
DECL|macro|CAPACITY_NO_CARTRIDGE
mdefine_line|#define CAPACITY_NO_CARTRIDGE&t;0x03
multiline_comment|/*&n; *&t;Most of our global data which we need to save even as we leave the&n; *&t;driver due to an interrupt or a timer event is stored in a variable&n; *&t;of type idefloppy_floppy_t, defined below.&n; */
r_typedef
r_struct
(brace
DECL|member|drive
id|ide_drive_t
op_star
id|drive
suffix:semicolon
multiline_comment|/* Current packet command */
DECL|member|pc
id|idefloppy_pc_t
op_star
id|pc
suffix:semicolon
multiline_comment|/* Last failed packet command */
DECL|member|failed_pc
id|idefloppy_pc_t
op_star
id|failed_pc
suffix:semicolon
multiline_comment|/* Packet command stack */
DECL|member|pc_stack
id|idefloppy_pc_t
id|pc_stack
(braket
id|IDEFLOPPY_PC_STACK
)braket
suffix:semicolon
multiline_comment|/* Next free packet command storage space */
DECL|member|pc_stack_index
r_int
id|pc_stack_index
suffix:semicolon
DECL|member|rq_stack
r_struct
id|request
id|rq_stack
(braket
id|IDEFLOPPY_PC_STACK
)braket
suffix:semicolon
multiline_comment|/* We implement a circular array */
DECL|member|rq_stack_index
r_int
id|rq_stack_index
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Last error information&n;&t; */
DECL|member|sense_key
DECL|member|asc
DECL|member|ascq
id|u8
id|sense_key
comma
id|asc
comma
id|ascq
suffix:semicolon
multiline_comment|/* delay this long before sending packet command */
DECL|member|ticks
id|u8
id|ticks
suffix:semicolon
DECL|member|progress_indication
r_int
id|progress_indication
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Device information&n;&t; */
multiline_comment|/* Current format */
DECL|member|blocks
DECL|member|block_size
DECL|member|bs_factor
r_int
id|blocks
comma
id|block_size
comma
id|bs_factor
suffix:semicolon
multiline_comment|/* Last format capacity */
DECL|member|capacity
id|idefloppy_capacity_descriptor_t
id|capacity
suffix:semicolon
multiline_comment|/* Copy of the flexible disk page */
DECL|member|flexible_disk_page
id|idefloppy_flexible_disk_page_t
id|flexible_disk_page
suffix:semicolon
multiline_comment|/* Write protect */
DECL|member|wp
r_int
id|wp
suffix:semicolon
multiline_comment|/* Supports format progress report */
DECL|member|srfp
r_int
id|srfp
suffix:semicolon
multiline_comment|/* Status/Action flags */
DECL|member|flags
r_int
r_int
id|flags
suffix:semicolon
DECL|typedef|idefloppy_floppy_t
)brace
id|idefloppy_floppy_t
suffix:semicolon
DECL|macro|IDEFLOPPY_TICKS_DELAY
mdefine_line|#define IDEFLOPPY_TICKS_DELAY&t;3&t;/* default delay for ZIP 100 */
multiline_comment|/*&n; *&t;Floppy flag bits values.&n; */
DECL|macro|IDEFLOPPY_DRQ_INTERRUPT
mdefine_line|#define IDEFLOPPY_DRQ_INTERRUPT&t;&t;0&t;/* DRQ interrupt device */
DECL|macro|IDEFLOPPY_MEDIA_CHANGED
mdefine_line|#define IDEFLOPPY_MEDIA_CHANGED&t;&t;1&t;/* Media may have changed */
DECL|macro|IDEFLOPPY_USE_READ12
mdefine_line|#define IDEFLOPPY_USE_READ12&t;&t;2&t;/* Use READ12/WRITE12 or READ10/WRITE10 */
DECL|macro|IDEFLOPPY_FORMAT_IN_PROGRESS
mdefine_line|#define&t;IDEFLOPPY_FORMAT_IN_PROGRESS&t;3&t;/* Format in progress */
DECL|macro|IDEFLOPPY_CLIK_DRIVE
mdefine_line|#define IDEFLOPPY_CLIK_DRIVE&t;        4       /* Avoid commands not supported in Clik drive */
DECL|macro|IDEFLOPPY_ZIP_DRIVE
mdefine_line|#define IDEFLOPPY_ZIP_DRIVE&t;&t;5&t;/* Requires BH algorithm for packets */
multiline_comment|/*&n; *&t;ATAPI floppy drive packet commands&n; */
DECL|macro|IDEFLOPPY_FORMAT_UNIT_CMD
mdefine_line|#define IDEFLOPPY_FORMAT_UNIT_CMD&t;0x04
DECL|macro|IDEFLOPPY_INQUIRY_CMD
mdefine_line|#define IDEFLOPPY_INQUIRY_CMD&t;&t;0x12
DECL|macro|IDEFLOPPY_MODE_SELECT_CMD
mdefine_line|#define IDEFLOPPY_MODE_SELECT_CMD&t;0x55
DECL|macro|IDEFLOPPY_MODE_SENSE_CMD
mdefine_line|#define IDEFLOPPY_MODE_SENSE_CMD&t;0x5a
DECL|macro|IDEFLOPPY_READ10_CMD
mdefine_line|#define IDEFLOPPY_READ10_CMD&t;&t;0x28
DECL|macro|IDEFLOPPY_READ12_CMD
mdefine_line|#define IDEFLOPPY_READ12_CMD&t;&t;0xa8
DECL|macro|IDEFLOPPY_READ_CAPACITY_CMD
mdefine_line|#define IDEFLOPPY_READ_CAPACITY_CMD&t;0x23
DECL|macro|IDEFLOPPY_REQUEST_SENSE_CMD
mdefine_line|#define IDEFLOPPY_REQUEST_SENSE_CMD&t;0x03
DECL|macro|IDEFLOPPY_PREVENT_REMOVAL_CMD
mdefine_line|#define IDEFLOPPY_PREVENT_REMOVAL_CMD&t;0x1e
DECL|macro|IDEFLOPPY_SEEK_CMD
mdefine_line|#define IDEFLOPPY_SEEK_CMD&t;&t;0x2b
DECL|macro|IDEFLOPPY_START_STOP_CMD
mdefine_line|#define IDEFLOPPY_START_STOP_CMD&t;0x1b
DECL|macro|IDEFLOPPY_TEST_UNIT_READY_CMD
mdefine_line|#define IDEFLOPPY_TEST_UNIT_READY_CMD&t;0x00
DECL|macro|IDEFLOPPY_VERIFY_CMD
mdefine_line|#define IDEFLOPPY_VERIFY_CMD&t;&t;0x2f
DECL|macro|IDEFLOPPY_WRITE10_CMD
mdefine_line|#define IDEFLOPPY_WRITE10_CMD&t;&t;0x2a
DECL|macro|IDEFLOPPY_WRITE12_CMD
mdefine_line|#define IDEFLOPPY_WRITE12_CMD&t;&t;0xaa
DECL|macro|IDEFLOPPY_WRITE_VERIFY_CMD
mdefine_line|#define IDEFLOPPY_WRITE_VERIFY_CMD&t;0x2e
multiline_comment|/*&n; *&t;Defines for the mode sense command&n; */
DECL|macro|MODE_SENSE_CURRENT
mdefine_line|#define MODE_SENSE_CURRENT&t;&t;0x00
DECL|macro|MODE_SENSE_CHANGEABLE
mdefine_line|#define MODE_SENSE_CHANGEABLE&t;&t;0x01
DECL|macro|MODE_SENSE_DEFAULT
mdefine_line|#define MODE_SENSE_DEFAULT&t;&t;0x02 
DECL|macro|MODE_SENSE_SAVED
mdefine_line|#define MODE_SENSE_SAVED&t;&t;0x03
multiline_comment|/*&n; *&t;IOCTLs used in low-level formatting.&n; */
DECL|macro|IDEFLOPPY_IOCTL_FORMAT_SUPPORTED
mdefine_line|#define&t;IDEFLOPPY_IOCTL_FORMAT_SUPPORTED&t;0x4600
DECL|macro|IDEFLOPPY_IOCTL_FORMAT_GET_CAPACITY
mdefine_line|#define&t;IDEFLOPPY_IOCTL_FORMAT_GET_CAPACITY&t;0x4601
DECL|macro|IDEFLOPPY_IOCTL_FORMAT_START
mdefine_line|#define&t;IDEFLOPPY_IOCTL_FORMAT_START&t;&t;0x4602
DECL|macro|IDEFLOPPY_IOCTL_FORMAT_GET_PROGRESS
mdefine_line|#define IDEFLOPPY_IOCTL_FORMAT_GET_PROGRESS&t;0x4603
macro_line|#if 0
multiline_comment|/*&n; *&t;Special requests for our block device strategy routine.&n; */
mdefine_line|#define&t;IDEFLOPPY_FIRST_RQ&t;90
multiline_comment|/*&n; * &t;IDEFLOPPY_PC_RQ is used to queue a packet command in the request queue.&n; */
mdefine_line|#define&t;IDEFLOPPY_PC_RQ&t;&t;90
mdefine_line|#define IDEFLOPPY_LAST_RQ&t;90
multiline_comment|/*&n; *&t;A macro which can be used to check if a given request command&n; *&t;originated in the driver or in the buffer cache layer.&n; */
mdefine_line|#define IDEFLOPPY_RQ_CMD(cmd) &t;((cmd &gt;= IDEFLOPPY_FIRST_RQ) &amp;&amp; (cmd &lt;= IDEFLOPPY_LAST_RQ))
macro_line|#endif
multiline_comment|/*&n; *&t;Error codes which are returned in rq-&gt;errors to the higher part&n; *&t;of the driver.&n; */
DECL|macro|IDEFLOPPY_ERROR_GENERAL
mdefine_line|#define&t;IDEFLOPPY_ERROR_GENERAL&t;&t;101
multiline_comment|/*&n; *&t;The following is used to format the general configuration word of&n; *&t;the ATAPI IDENTIFY DEVICE command.&n; */
DECL|struct|idefloppy_id_gcw
r_struct
id|idefloppy_id_gcw
(brace
macro_line|#if defined(__LITTLE_ENDIAN_BITFIELD)
DECL|member|packet_size
r_int
id|packet_size
suffix:colon
l_int|2
suffix:semicolon
multiline_comment|/* Packet Size */
DECL|member|reserved234
r_int
id|reserved234
suffix:colon
l_int|3
suffix:semicolon
multiline_comment|/* Reserved */
DECL|member|drq_type
r_int
id|drq_type
suffix:colon
l_int|2
suffix:semicolon
multiline_comment|/* Command packet DRQ type */
DECL|member|removable
r_int
id|removable
suffix:colon
l_int|1
suffix:semicolon
multiline_comment|/* Removable media */
DECL|member|device_type
r_int
id|device_type
suffix:colon
l_int|5
suffix:semicolon
multiline_comment|/* Device type */
DECL|member|reserved13
r_int
id|reserved13
suffix:colon
l_int|1
suffix:semicolon
multiline_comment|/* Reserved */
DECL|member|protocol
r_int
id|protocol
suffix:colon
l_int|2
suffix:semicolon
multiline_comment|/* Protocol type */
macro_line|#elif defined(__BIG_ENDIAN_BITFIELD)
r_int
id|protocol
suffix:colon
l_int|2
suffix:semicolon
multiline_comment|/* Protocol type */
r_int
id|reserved13
suffix:colon
l_int|1
suffix:semicolon
multiline_comment|/* Reserved */
r_int
id|device_type
suffix:colon
l_int|5
suffix:semicolon
multiline_comment|/* Device type */
r_int
id|removable
suffix:colon
l_int|1
suffix:semicolon
multiline_comment|/* Removable media */
r_int
id|drq_type
suffix:colon
l_int|2
suffix:semicolon
multiline_comment|/* Command packet DRQ type */
r_int
id|reserved234
suffix:colon
l_int|3
suffix:semicolon
multiline_comment|/* Reserved */
r_int
id|packet_size
suffix:colon
l_int|2
suffix:semicolon
multiline_comment|/* Packet Size */
macro_line|#else
macro_line|#error &quot;Bitfield endianness not defined! Check your byteorder.h&quot;
macro_line|#endif
)brace
suffix:semicolon
multiline_comment|/*&n; *&t;INQUIRY packet command - Data Format&n; */
r_typedef
r_struct
(brace
macro_line|#if defined(__LITTLE_ENDIAN_BITFIELD)
DECL|member|device_type
r_int
id|device_type
suffix:colon
l_int|5
suffix:semicolon
multiline_comment|/* Peripheral Device Type */
DECL|member|reserved0_765
r_int
id|reserved0_765
suffix:colon
l_int|3
suffix:semicolon
multiline_comment|/* Peripheral Qualifier - Reserved */
DECL|member|reserved1_6t0
r_int
id|reserved1_6t0
suffix:colon
l_int|7
suffix:semicolon
multiline_comment|/* Reserved */
DECL|member|rmb
r_int
id|rmb
suffix:colon
l_int|1
suffix:semicolon
multiline_comment|/* Removable Medium Bit */
DECL|member|ansi_version
r_int
id|ansi_version
suffix:colon
l_int|3
suffix:semicolon
multiline_comment|/* ANSI Version */
DECL|member|ecma_version
r_int
id|ecma_version
suffix:colon
l_int|3
suffix:semicolon
multiline_comment|/* ECMA Version */
DECL|member|iso_version
r_int
id|iso_version
suffix:colon
l_int|2
suffix:semicolon
multiline_comment|/* ISO Version */
DECL|member|response_format
r_int
id|response_format
suffix:colon
l_int|4
suffix:semicolon
multiline_comment|/* Response Data Format */
DECL|member|reserved3_45
r_int
id|reserved3_45
suffix:colon
l_int|2
suffix:semicolon
multiline_comment|/* Reserved */
DECL|member|reserved3_6
r_int
id|reserved3_6
suffix:colon
l_int|1
suffix:semicolon
multiline_comment|/* TrmIOP - Reserved */
DECL|member|reserved3_7
r_int
id|reserved3_7
suffix:colon
l_int|1
suffix:semicolon
multiline_comment|/* AENC - Reserved */
macro_line|#elif defined(__BIG_ENDIAN_BITFIELD)
r_int
id|reserved0_765
suffix:colon
l_int|3
suffix:semicolon
multiline_comment|/* Peripheral Qualifier - Reserved */
r_int
id|device_type
suffix:colon
l_int|5
suffix:semicolon
multiline_comment|/* Peripheral Device Type */
r_int
id|rmb
suffix:colon
l_int|1
suffix:semicolon
multiline_comment|/* Removable Medium Bit */
r_int
id|reserved1_6t0
suffix:colon
l_int|7
suffix:semicolon
multiline_comment|/* Reserved */
r_int
id|iso_version
suffix:colon
l_int|2
suffix:semicolon
multiline_comment|/* ISO Version */
r_int
id|ecma_version
suffix:colon
l_int|3
suffix:semicolon
multiline_comment|/* ECMA Version */
r_int
id|ansi_version
suffix:colon
l_int|3
suffix:semicolon
multiline_comment|/* ANSI Version */
r_int
id|reserved3_7
suffix:colon
l_int|1
suffix:semicolon
multiline_comment|/* AENC - Reserved */
r_int
id|reserved3_6
suffix:colon
l_int|1
suffix:semicolon
multiline_comment|/* TrmIOP - Reserved */
r_int
id|reserved3_45
suffix:colon
l_int|2
suffix:semicolon
multiline_comment|/* Reserved */
r_int
id|response_format
suffix:colon
l_int|4
suffix:semicolon
multiline_comment|/* Response Data Format */
macro_line|#else
macro_line|#error &quot;Bitfield endianness not defined! Check your byteorder.h&quot;
macro_line|#endif
DECL|member|additional_length
id|u8
id|additional_length
suffix:semicolon
multiline_comment|/* Additional Length (total_length-4) */
DECL|member|rsv5
DECL|member|rsv6
DECL|member|rsv7
id|u8
id|rsv5
comma
id|rsv6
comma
id|rsv7
suffix:semicolon
multiline_comment|/* Reserved */
DECL|member|vendor_id
id|u8
id|vendor_id
(braket
l_int|8
)braket
suffix:semicolon
multiline_comment|/* Vendor Identification */
DECL|member|product_id
id|u8
id|product_id
(braket
l_int|16
)braket
suffix:semicolon
multiline_comment|/* Product Identification */
DECL|member|revision_level
id|u8
id|revision_level
(braket
l_int|4
)braket
suffix:semicolon
multiline_comment|/* Revision Level */
DECL|member|vendor_specific
id|u8
id|vendor_specific
(braket
l_int|20
)braket
suffix:semicolon
multiline_comment|/* Vendor Specific - Optional */
DECL|member|reserved56t95
id|u8
id|reserved56t95
(braket
l_int|40
)braket
suffix:semicolon
multiline_comment|/* Reserved - Optional */
multiline_comment|/* Additional information may be returned */
DECL|typedef|idefloppy_inquiry_result_t
)brace
id|idefloppy_inquiry_result_t
suffix:semicolon
multiline_comment|/*&n; *&t;REQUEST SENSE packet command result - Data Format.&n; */
r_typedef
r_struct
(brace
macro_line|#if defined(__LITTLE_ENDIAN_BITFIELD)
DECL|member|error_code
r_int
id|error_code
suffix:colon
l_int|7
suffix:semicolon
multiline_comment|/* Current error (0x70) */
DECL|member|valid
r_int
id|valid
suffix:colon
l_int|1
suffix:semicolon
multiline_comment|/* The information field conforms to SFF-8070i */
DECL|member|reserved1
id|u8
id|reserved1
suffix:colon
l_int|8
suffix:semicolon
multiline_comment|/* Reserved */
DECL|member|sense_key
r_int
id|sense_key
suffix:colon
l_int|4
suffix:semicolon
multiline_comment|/* Sense Key */
DECL|member|reserved2_4
r_int
id|reserved2_4
suffix:colon
l_int|1
suffix:semicolon
multiline_comment|/* Reserved */
DECL|member|ili
r_int
id|ili
suffix:colon
l_int|1
suffix:semicolon
multiline_comment|/* Incorrect Length Indicator */
DECL|member|reserved2_67
r_int
id|reserved2_67
suffix:colon
l_int|2
suffix:semicolon
macro_line|#elif defined(__BIG_ENDIAN_BITFIELD)
r_int
id|valid
suffix:colon
l_int|1
suffix:semicolon
multiline_comment|/* The information field conforms to SFF-8070i */
r_int
id|error_code
suffix:colon
l_int|7
suffix:semicolon
multiline_comment|/* Current error (0x70) */
id|u8
id|reserved1
suffix:colon
l_int|8
suffix:semicolon
multiline_comment|/* Reserved */
r_int
id|reserved2_67
suffix:colon
l_int|2
suffix:semicolon
r_int
id|ili
suffix:colon
l_int|1
suffix:semicolon
multiline_comment|/* Incorrect Length Indicator */
r_int
id|reserved2_4
suffix:colon
l_int|1
suffix:semicolon
multiline_comment|/* Reserved */
r_int
id|sense_key
suffix:colon
l_int|4
suffix:semicolon
multiline_comment|/* Sense Key */
macro_line|#else
macro_line|#error &quot;Bitfield endianness not defined! Check your byteorder.h&quot;
macro_line|#endif
DECL|member|information
id|u32
id|information
id|__attribute__
(paren
(paren
id|packed
)paren
)paren
suffix:semicolon
DECL|member|asl
id|u8
id|asl
suffix:semicolon
multiline_comment|/* Additional sense length (n-7) */
DECL|member|command_specific
id|u32
id|command_specific
suffix:semicolon
multiline_comment|/* Additional command specific information */
DECL|member|asc
id|u8
id|asc
suffix:semicolon
multiline_comment|/* Additional Sense Code */
DECL|member|ascq
id|u8
id|ascq
suffix:semicolon
multiline_comment|/* Additional Sense Code Qualifier */
DECL|member|replaceable_unit_code
id|u8
id|replaceable_unit_code
suffix:semicolon
multiline_comment|/* Field Replaceable Unit Code */
DECL|member|sksv
id|u8
id|sksv
(braket
l_int|3
)braket
suffix:semicolon
DECL|member|pad
id|u8
id|pad
(braket
l_int|2
)braket
suffix:semicolon
multiline_comment|/* Padding to 20 bytes */
DECL|typedef|idefloppy_request_sense_result_t
)brace
id|idefloppy_request_sense_result_t
suffix:semicolon
multiline_comment|/*&n; *&t;Pages of the SELECT SENSE / MODE SENSE packet commands.&n; */
DECL|macro|IDEFLOPPY_CAPABILITIES_PAGE
mdefine_line|#define&t;IDEFLOPPY_CAPABILITIES_PAGE&t;0x1b
DECL|macro|IDEFLOPPY_FLEXIBLE_DISK_PAGE
mdefine_line|#define IDEFLOPPY_FLEXIBLE_DISK_PAGE&t;0x05
multiline_comment|/*&n; *&t;Mode Parameter Header for the MODE SENSE packet command&n; */
r_typedef
r_struct
(brace
DECL|member|mode_data_length
id|u16
id|mode_data_length
suffix:semicolon
multiline_comment|/* Length of the following data transfer */
DECL|member|medium_type
id|u8
id|medium_type
suffix:semicolon
multiline_comment|/* Medium Type */
macro_line|#if defined(__LITTLE_ENDIAN_BITFIELD)
DECL|member|reserved3
r_int
id|reserved3
suffix:colon
l_int|7
suffix:semicolon
DECL|member|wp
r_int
id|wp
suffix:colon
l_int|1
suffix:semicolon
multiline_comment|/* Write protect */
macro_line|#elif defined(__BIG_ENDIAN_BITFIELD)
DECL|member|wp
r_int
id|wp
suffix:colon
l_int|1
suffix:semicolon
multiline_comment|/* Write protect */
DECL|member|reserved3
r_int
id|reserved3
suffix:colon
l_int|7
suffix:semicolon
macro_line|#else
macro_line|#error &quot;Bitfield endianness not defined! Check your byteorder.h&quot;
macro_line|#endif
DECL|member|reserved
id|u8
id|reserved
(braket
l_int|4
)braket
suffix:semicolon
DECL|typedef|idefloppy_mode_parameter_header_t
)brace
id|idefloppy_mode_parameter_header_t
suffix:semicolon
multiline_comment|/*&n; *&t;Too bad. The drive wants to send us data which we are not ready to accept.&n; *&t;Just throw it away.&n; */
DECL|function|idefloppy_discard_data
r_static
r_void
id|idefloppy_discard_data
(paren
id|ide_drive_t
op_star
id|drive
comma
r_int
r_int
id|bcount
)paren
(brace
r_while
c_loop
(paren
id|bcount
op_decrement
)paren
(paren
r_void
)paren
id|HWIF
c_func
(paren
id|drive
)paren
op_member_access_from_pointer
id|INB
c_func
(paren
id|IDE_DATA_REG
)paren
suffix:semicolon
)brace
macro_line|#if IDEFLOPPY_DEBUG_BUGS
DECL|function|idefloppy_write_zeros
r_static
r_void
id|idefloppy_write_zeros
(paren
id|ide_drive_t
op_star
id|drive
comma
r_int
r_int
id|bcount
)paren
(brace
r_while
c_loop
(paren
id|bcount
op_decrement
)paren
id|HWIF
c_func
(paren
id|drive
)paren
op_member_access_from_pointer
id|OUTB
c_func
(paren
l_int|0
comma
id|IDE_DATA_REG
)paren
suffix:semicolon
)brace
macro_line|#endif /* IDEFLOPPY_DEBUG_BUGS */
multiline_comment|/*&n; *&t;idefloppy_do_end_request is used to finish servicing a request.&n; *&n; *&t;For read/write requests, we will call ide_end_request to pass to the&n; *&t;next buffer.&n; */
DECL|function|idefloppy_do_end_request
r_static
r_int
id|idefloppy_do_end_request
c_func
(paren
id|ide_drive_t
op_star
id|drive
comma
r_int
id|uptodate
comma
r_int
id|nsecs
)paren
(brace
id|idefloppy_floppy_t
op_star
id|floppy
op_assign
id|drive-&gt;driver_data
suffix:semicolon
r_struct
id|request
op_star
id|rq
op_assign
id|HWGROUP
c_func
(paren
id|drive
)paren
op_member_access_from_pointer
id|rq
suffix:semicolon
r_int
id|error
suffix:semicolon
id|debug_log
c_func
(paren
id|KERN_INFO
l_string|&quot;Reached idefloppy_end_request&bslash;n&quot;
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|uptodate
)paren
(brace
r_case
l_int|0
suffix:colon
id|error
op_assign
id|IDEFLOPPY_ERROR_GENERAL
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|error
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|error
op_assign
id|uptodate
suffix:semicolon
)brace
r_if
c_cond
(paren
id|error
)paren
id|floppy-&gt;failed_pc
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Why does this happen? */
r_if
c_cond
(paren
op_logical_neg
id|rq
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|rq-&gt;flags
op_amp
id|REQ_SPECIAL
)paren
)paren
(brace
singleline_comment|//if (!IDEFLOPPY_RQ_CMD (rq-&gt;cmd)) {
multiline_comment|/* our real local end request function */
id|ide_end_request
c_func
(paren
id|drive
comma
id|uptodate
comma
id|nsecs
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|rq-&gt;errors
op_assign
id|error
suffix:semicolon
multiline_comment|/* fixme: need to move this local also */
id|ide_end_drive_cmd
c_func
(paren
id|drive
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|idefloppy_input_buffers
r_static
r_void
id|idefloppy_input_buffers
(paren
id|ide_drive_t
op_star
id|drive
comma
id|idefloppy_pc_t
op_star
id|pc
comma
r_int
r_int
id|bcount
)paren
(brace
r_struct
id|request
op_star
id|rq
op_assign
id|pc-&gt;rq
suffix:semicolon
r_struct
id|bio_vec
op_star
id|bvec
suffix:semicolon
r_struct
id|bio
op_star
id|bio
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_char
op_star
id|data
suffix:semicolon
r_int
id|count
comma
id|i
comma
id|done
op_assign
l_int|0
suffix:semicolon
id|rq_for_each_bio
c_func
(paren
id|bio
comma
id|rq
)paren
(brace
id|bio_for_each_segment
c_func
(paren
id|bvec
comma
id|bio
comma
id|i
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|bcount
)paren
r_break
suffix:semicolon
id|count
op_assign
id|min
c_func
(paren
id|bvec-&gt;bv_len
comma
id|bcount
)paren
suffix:semicolon
id|data
op_assign
id|bvec_kmap_irq
c_func
(paren
id|bvec
comma
op_amp
id|flags
)paren
suffix:semicolon
id|atapi_input_bytes
c_func
(paren
id|drive
comma
id|data
comma
id|count
)paren
suffix:semicolon
id|bvec_kunmap_irq
c_func
(paren
id|data
comma
op_amp
id|flags
)paren
suffix:semicolon
id|bcount
op_sub_assign
id|count
suffix:semicolon
id|pc-&gt;b_count
op_add_assign
id|count
suffix:semicolon
id|done
op_add_assign
id|count
suffix:semicolon
)brace
)brace
id|idefloppy_do_end_request
c_func
(paren
id|drive
comma
l_int|1
comma
id|done
op_rshift
l_int|9
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bcount
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: leftover data in idefloppy_input_buffers, bcount == %d&bslash;n&quot;
comma
id|drive-&gt;name
comma
id|bcount
)paren
suffix:semicolon
id|idefloppy_discard_data
c_func
(paren
id|drive
comma
id|bcount
)paren
suffix:semicolon
)brace
)brace
DECL|function|idefloppy_output_buffers
r_static
r_void
id|idefloppy_output_buffers
(paren
id|ide_drive_t
op_star
id|drive
comma
id|idefloppy_pc_t
op_star
id|pc
comma
r_int
r_int
id|bcount
)paren
(brace
r_struct
id|request
op_star
id|rq
op_assign
id|pc-&gt;rq
suffix:semicolon
r_struct
id|bio
op_star
id|bio
suffix:semicolon
r_struct
id|bio_vec
op_star
id|bvec
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
id|count
comma
id|i
comma
id|done
op_assign
l_int|0
suffix:semicolon
r_char
op_star
id|data
suffix:semicolon
id|rq_for_each_bio
c_func
(paren
id|bio
comma
id|rq
)paren
(brace
id|bio_for_each_segment
c_func
(paren
id|bvec
comma
id|bio
comma
id|i
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|bcount
)paren
r_break
suffix:semicolon
id|count
op_assign
id|min
c_func
(paren
id|bvec-&gt;bv_len
comma
id|bcount
)paren
suffix:semicolon
id|data
op_assign
id|bvec_kmap_irq
c_func
(paren
id|bvec
comma
op_amp
id|flags
)paren
suffix:semicolon
id|atapi_output_bytes
c_func
(paren
id|drive
comma
id|data
comma
id|count
)paren
suffix:semicolon
id|bvec_kunmap_irq
c_func
(paren
id|data
comma
op_amp
id|flags
)paren
suffix:semicolon
id|bcount
op_sub_assign
id|count
suffix:semicolon
id|pc-&gt;b_count
op_add_assign
id|count
suffix:semicolon
id|done
op_add_assign
id|count
suffix:semicolon
)brace
)brace
id|idefloppy_do_end_request
c_func
(paren
id|drive
comma
l_int|1
comma
id|done
op_rshift
l_int|9
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bcount
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: leftover data in idefloppy_output_buffers, bcount == %d&bslash;n&quot;
comma
id|drive-&gt;name
comma
id|bcount
)paren
suffix:semicolon
id|idefloppy_write_zeros
c_func
(paren
id|drive
comma
id|bcount
)paren
suffix:semicolon
)brace
)brace
DECL|function|idefloppy_update_buffers
r_static
r_void
id|idefloppy_update_buffers
(paren
id|ide_drive_t
op_star
id|drive
comma
id|idefloppy_pc_t
op_star
id|pc
)paren
(brace
r_struct
id|request
op_star
id|rq
op_assign
id|pc-&gt;rq
suffix:semicolon
r_struct
id|bio
op_star
id|bio
op_assign
id|rq-&gt;bio
suffix:semicolon
r_while
c_loop
(paren
(paren
id|bio
op_assign
id|rq-&gt;bio
)paren
op_ne
l_int|NULL
)paren
id|idefloppy_do_end_request
c_func
(paren
id|drive
comma
l_int|1
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;idefloppy_queue_pc_head generates a new packet command request in front&n; *&t;of the request queue, before the current request, so that it will be&n; *&t;processed immediately, on the next pass through the driver.&n; */
DECL|function|idefloppy_queue_pc_head
r_static
r_void
id|idefloppy_queue_pc_head
(paren
id|ide_drive_t
op_star
id|drive
comma
id|idefloppy_pc_t
op_star
id|pc
comma
r_struct
id|request
op_star
id|rq
)paren
(brace
id|ide_init_drive_cmd
c_func
(paren
id|rq
)paren
suffix:semicolon
id|rq-&gt;buffer
op_assign
(paren
r_char
op_star
)paren
id|pc
suffix:semicolon
id|rq-&gt;flags
op_assign
id|REQ_SPECIAL
suffix:semicolon
singleline_comment|//rq-&gt;cmd = IDEFLOPPY_PC_RQ;
(paren
r_void
)paren
id|ide_do_drive_cmd
c_func
(paren
id|drive
comma
id|rq
comma
id|ide_preempt
)paren
suffix:semicolon
)brace
DECL|function|idefloppy_next_pc_storage
r_static
id|idefloppy_pc_t
op_star
id|idefloppy_next_pc_storage
(paren
id|ide_drive_t
op_star
id|drive
)paren
(brace
id|idefloppy_floppy_t
op_star
id|floppy
op_assign
id|drive-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
id|floppy-&gt;pc_stack_index
op_eq
id|IDEFLOPPY_PC_STACK
)paren
id|floppy-&gt;pc_stack_index
op_assign
l_int|0
suffix:semicolon
r_return
(paren
op_amp
id|floppy-&gt;pc_stack
(braket
id|floppy-&gt;pc_stack_index
op_increment
)braket
)paren
suffix:semicolon
)brace
DECL|function|idefloppy_next_rq_storage
r_static
r_struct
id|request
op_star
id|idefloppy_next_rq_storage
(paren
id|ide_drive_t
op_star
id|drive
)paren
(brace
id|idefloppy_floppy_t
op_star
id|floppy
op_assign
id|drive-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
id|floppy-&gt;rq_stack_index
op_eq
id|IDEFLOPPY_PC_STACK
)paren
id|floppy-&gt;rq_stack_index
op_assign
l_int|0
suffix:semicolon
r_return
(paren
op_amp
id|floppy-&gt;rq_stack
(braket
id|floppy-&gt;rq_stack_index
op_increment
)braket
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;idefloppy_analyze_error is called on each failed packet command retry&n; *&t;to analyze the request sense.&n; */
DECL|function|idefloppy_analyze_error
r_static
r_void
id|idefloppy_analyze_error
(paren
id|ide_drive_t
op_star
id|drive
comma
id|idefloppy_request_sense_result_t
op_star
id|result
)paren
(brace
id|idefloppy_floppy_t
op_star
id|floppy
op_assign
id|drive-&gt;driver_data
suffix:semicolon
id|floppy-&gt;sense_key
op_assign
id|result-&gt;sense_key
suffix:semicolon
id|floppy-&gt;asc
op_assign
id|result-&gt;asc
suffix:semicolon
id|floppy-&gt;ascq
op_assign
id|result-&gt;ascq
suffix:semicolon
id|floppy-&gt;progress_indication
op_assign
id|result-&gt;sksv
(braket
l_int|0
)braket
op_amp
l_int|0x80
ques
c_cond
(paren
id|u16
)paren
id|get_unaligned
c_func
(paren
(paren
id|u16
op_star
)paren
(paren
id|result-&gt;sksv
op_plus
l_int|1
)paren
)paren
suffix:colon
l_int|0x10000
suffix:semicolon
r_if
c_cond
(paren
id|floppy-&gt;failed_pc
)paren
id|debug_log
c_func
(paren
id|KERN_INFO
l_string|&quot;ide-floppy: pc = %x, sense key = %x, &quot;
l_string|&quot;asc = %x, ascq = %x&bslash;n&quot;
comma
id|floppy-&gt;failed_pc-&gt;c
(braket
l_int|0
)braket
comma
id|result-&gt;sense_key
comma
id|result-&gt;asc
comma
id|result-&gt;ascq
)paren
suffix:semicolon
r_else
id|debug_log
c_func
(paren
id|KERN_INFO
l_string|&quot;ide-floppy: sense key = %x, asc = %x, &quot;
l_string|&quot;ascq = %x&bslash;n&quot;
comma
id|result-&gt;sense_key
comma
id|result-&gt;asc
comma
id|result-&gt;ascq
)paren
suffix:semicolon
)brace
DECL|function|idefloppy_request_sense_callback
r_static
r_void
id|idefloppy_request_sense_callback
(paren
id|ide_drive_t
op_star
id|drive
)paren
(brace
id|idefloppy_floppy_t
op_star
id|floppy
op_assign
id|drive-&gt;driver_data
suffix:semicolon
id|debug_log
c_func
(paren
id|KERN_INFO
l_string|&quot;ide-floppy: Reached %s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|floppy-&gt;pc-&gt;error
)paren
(brace
id|idefloppy_analyze_error
c_func
(paren
id|drive
comma
(paren
id|idefloppy_request_sense_result_t
op_star
)paren
id|floppy-&gt;pc-&gt;buffer
)paren
suffix:semicolon
id|idefloppy_do_end_request
c_func
(paren
id|drive
comma
l_int|1
comma
l_int|0
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Error in REQUEST SENSE itself - Aborting request!&bslash;n&quot;
)paren
suffix:semicolon
id|idefloppy_do_end_request
c_func
(paren
id|drive
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; *&t;General packet command callback function.&n; */
DECL|function|idefloppy_pc_callback
r_static
r_void
id|idefloppy_pc_callback
(paren
id|ide_drive_t
op_star
id|drive
)paren
(brace
id|idefloppy_floppy_t
op_star
id|floppy
op_assign
id|drive-&gt;driver_data
suffix:semicolon
id|debug_log
c_func
(paren
id|KERN_INFO
l_string|&quot;ide-floppy: Reached %s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|idefloppy_do_end_request
c_func
(paren
id|drive
comma
id|floppy-&gt;pc-&gt;error
ques
c_cond
l_int|0
suffix:colon
l_int|1
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;idefloppy_init_pc initializes a packet command.&n; */
DECL|function|idefloppy_init_pc
r_static
r_void
id|idefloppy_init_pc
(paren
id|idefloppy_pc_t
op_star
id|pc
)paren
(brace
id|memset
c_func
(paren
id|pc-&gt;c
comma
l_int|0
comma
l_int|12
)paren
suffix:semicolon
id|pc-&gt;retries
op_assign
l_int|0
suffix:semicolon
id|pc-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|pc-&gt;request_transfer
op_assign
l_int|0
suffix:semicolon
id|pc-&gt;buffer
op_assign
id|pc-&gt;pc_buffer
suffix:semicolon
id|pc-&gt;buffer_size
op_assign
id|IDEFLOPPY_PC_BUFFER_SIZE
suffix:semicolon
id|pc-&gt;callback
op_assign
op_amp
id|idefloppy_pc_callback
suffix:semicolon
)brace
DECL|function|idefloppy_create_request_sense_cmd
r_static
r_void
id|idefloppy_create_request_sense_cmd
(paren
id|idefloppy_pc_t
op_star
id|pc
)paren
(brace
id|idefloppy_init_pc
c_func
(paren
id|pc
)paren
suffix:semicolon
id|pc-&gt;c
(braket
l_int|0
)braket
op_assign
id|IDEFLOPPY_REQUEST_SENSE_CMD
suffix:semicolon
id|pc-&gt;c
(braket
l_int|4
)braket
op_assign
l_int|255
suffix:semicolon
id|pc-&gt;request_transfer
op_assign
l_int|18
suffix:semicolon
id|pc-&gt;callback
op_assign
op_amp
id|idefloppy_request_sense_callback
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;idefloppy_retry_pc is called when an error was detected during the&n; *&t;last packet command. We queue a request sense packet command in&n; *&t;the head of the request list.&n; */
DECL|function|idefloppy_retry_pc
r_static
r_void
id|idefloppy_retry_pc
(paren
id|ide_drive_t
op_star
id|drive
)paren
(brace
id|idefloppy_pc_t
op_star
id|pc
suffix:semicolon
r_struct
id|request
op_star
id|rq
suffix:semicolon
id|atapi_error_t
id|error
suffix:semicolon
id|error.all
op_assign
id|HWIF
c_func
(paren
id|drive
)paren
op_member_access_from_pointer
id|INB
c_func
(paren
id|IDE_ERROR_REG
)paren
suffix:semicolon
id|pc
op_assign
id|idefloppy_next_pc_storage
c_func
(paren
id|drive
)paren
suffix:semicolon
id|rq
op_assign
id|idefloppy_next_rq_storage
c_func
(paren
id|drive
)paren
suffix:semicolon
id|idefloppy_create_request_sense_cmd
c_func
(paren
id|pc
)paren
suffix:semicolon
id|idefloppy_queue_pc_head
c_func
(paren
id|drive
comma
id|pc
comma
id|rq
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;idefloppy_pc_intr is the usual interrupt handler which will be called&n; *&t;during a packet command.&n; */
DECL|function|idefloppy_pc_intr
r_static
id|ide_startstop_t
id|idefloppy_pc_intr
(paren
id|ide_drive_t
op_star
id|drive
)paren
(brace
id|idefloppy_floppy_t
op_star
id|floppy
op_assign
id|drive-&gt;driver_data
suffix:semicolon
id|atapi_status_t
id|status
suffix:semicolon
id|atapi_bcount_t
id|bcount
suffix:semicolon
id|atapi_ireason_t
id|ireason
suffix:semicolon
id|idefloppy_pc_t
op_star
id|pc
op_assign
id|floppy-&gt;pc
suffix:semicolon
r_struct
id|request
op_star
id|rq
op_assign
id|pc-&gt;rq
suffix:semicolon
r_int
r_int
id|temp
suffix:semicolon
id|debug_log
c_func
(paren
id|KERN_INFO
l_string|&quot;ide-floppy: Reached %s interrupt handler&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|PC_DMA_IN_PROGRESS
comma
op_amp
id|pc-&gt;flags
)paren
)paren
(brace
r_if
c_cond
(paren
id|HWIF
c_func
(paren
id|drive
)paren
op_member_access_from_pointer
id|ide_dma_end
c_func
(paren
id|drive
)paren
)paren
(brace
id|set_bit
c_func
(paren
id|PC_DMA_ERROR
comma
op_amp
id|pc-&gt;flags
)paren
suffix:semicolon
)brace
r_else
(brace
id|pc-&gt;actually_transferred
op_assign
id|pc-&gt;request_transfer
suffix:semicolon
id|idefloppy_update_buffers
c_func
(paren
id|drive
comma
id|pc
)paren
suffix:semicolon
)brace
id|debug_log
c_func
(paren
id|KERN_INFO
l_string|&quot;ide-floppy: DMA finished&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* Clear the interrupt */
id|status.all
op_assign
id|HWIF
c_func
(paren
id|drive
)paren
op_member_access_from_pointer
id|INB
c_func
(paren
id|IDE_STATUS_REG
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|status.b.drq
)paren
(brace
multiline_comment|/* No more interrupts */
id|debug_log
c_func
(paren
id|KERN_INFO
l_string|&quot;Packet command completed, %d bytes &quot;
l_string|&quot;transferred&bslash;n&quot;
comma
id|pc-&gt;actually_transferred
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|PC_DMA_IN_PROGRESS
comma
op_amp
id|pc-&gt;flags
)paren
suffix:semicolon
id|local_irq_enable
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status.b.check
op_logical_or
id|test_bit
c_func
(paren
id|PC_DMA_ERROR
comma
op_amp
id|pc-&gt;flags
)paren
)paren
(brace
multiline_comment|/* Error detected */
id|debug_log
c_func
(paren
id|KERN_INFO
l_string|&quot;ide-floppy: %s: I/O error&bslash;n&quot;
comma
id|drive-&gt;name
)paren
suffix:semicolon
id|rq-&gt;errors
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|pc-&gt;c
(braket
l_int|0
)braket
op_eq
id|IDEFLOPPY_REQUEST_SENSE_CMD
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ide-floppy: I/O error in &quot;
l_string|&quot;request sense command&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|ide_do_reset
c_func
(paren
id|drive
)paren
suffix:semicolon
)brace
multiline_comment|/* Retry operation */
id|idefloppy_retry_pc
c_func
(paren
id|drive
)paren
suffix:semicolon
multiline_comment|/* queued, but not started */
r_return
id|ide_stopped
suffix:semicolon
)brace
id|pc-&gt;error
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|floppy-&gt;failed_pc
op_eq
id|pc
)paren
id|floppy-&gt;failed_pc
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Command finished - Call the callback function */
id|pc
op_member_access_from_pointer
id|callback
c_func
(paren
id|drive
)paren
suffix:semicolon
r_return
id|ide_stopped
suffix:semicolon
)brace
r_if
c_cond
(paren
id|test_and_clear_bit
c_func
(paren
id|PC_DMA_IN_PROGRESS
comma
op_amp
id|pc-&gt;flags
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ide-floppy: The floppy wants to issue &quot;
l_string|&quot;more interrupts in DMA mode&bslash;n&quot;
)paren
suffix:semicolon
(paren
r_void
)paren
id|__ide_dma_off
c_func
(paren
id|drive
)paren
suffix:semicolon
r_return
id|ide_do_reset
c_func
(paren
id|drive
)paren
suffix:semicolon
)brace
multiline_comment|/* Get the number of bytes to transfer */
id|bcount.b.high
op_assign
id|HWIF
c_func
(paren
id|drive
)paren
op_member_access_from_pointer
id|INB
c_func
(paren
id|IDE_BCOUNTH_REG
)paren
suffix:semicolon
id|bcount.b.low
op_assign
id|HWIF
c_func
(paren
id|drive
)paren
op_member_access_from_pointer
id|INB
c_func
(paren
id|IDE_BCOUNTL_REG
)paren
suffix:semicolon
multiline_comment|/* on this interrupt */
id|ireason.all
op_assign
id|HWIF
c_func
(paren
id|drive
)paren
op_member_access_from_pointer
id|INB
c_func
(paren
id|IDE_IREASON_REG
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ireason.b.cod
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ide-floppy: CoD != 0 in idefloppy_pc_intr&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|ide_do_reset
c_func
(paren
id|drive
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ireason.b.io
op_eq
id|test_bit
c_func
(paren
id|PC_WRITING
comma
op_amp
id|pc-&gt;flags
)paren
)paren
(brace
multiline_comment|/* Hopefully, we will never get here */
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ide-floppy: We wanted to %s, &quot;
comma
id|ireason.b.io
ques
c_cond
l_string|&quot;Write&quot;
suffix:colon
l_string|&quot;Read&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;but the floppy wants us to %s !&bslash;n&quot;
comma
id|ireason.b.io
ques
c_cond
l_string|&quot;Read&quot;
suffix:colon
l_string|&quot;Write&quot;
)paren
suffix:semicolon
r_return
id|ide_do_reset
c_func
(paren
id|drive
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|test_bit
c_func
(paren
id|PC_WRITING
comma
op_amp
id|pc-&gt;flags
)paren
)paren
(brace
multiline_comment|/* Reading - Check that we have enough space */
id|temp
op_assign
id|pc-&gt;actually_transferred
op_plus
id|bcount.all
suffix:semicolon
r_if
c_cond
(paren
id|temp
OG
id|pc-&gt;request_transfer
)paren
(brace
r_if
c_cond
(paren
id|temp
OG
id|pc-&gt;buffer_size
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ide-floppy: The floppy wants &quot;
l_string|&quot;to send us more data than expected &quot;
l_string|&quot;- discarding data&bslash;n&quot;
)paren
suffix:semicolon
id|idefloppy_discard_data
c_func
(paren
id|drive
comma
id|bcount.all
)paren
suffix:semicolon
r_if
c_cond
(paren
id|HWGROUP
c_func
(paren
id|drive
)paren
op_member_access_from_pointer
id|handler
op_ne
l_int|NULL
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
id|ide_set_handler
c_func
(paren
id|drive
comma
op_amp
id|idefloppy_pc_intr
comma
id|IDEFLOPPY_WAIT_CMD
comma
l_int|NULL
)paren
suffix:semicolon
r_return
id|ide_started
suffix:semicolon
)brace
id|debug_log
c_func
(paren
id|KERN_NOTICE
l_string|&quot;ide-floppy: The floppy wants to &quot;
l_string|&quot;send us more data than expected - &quot;
l_string|&quot;allowing transfer&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|PC_WRITING
comma
op_amp
id|pc-&gt;flags
)paren
)paren
(brace
r_if
c_cond
(paren
id|pc-&gt;buffer
op_ne
l_int|NULL
)paren
multiline_comment|/* Write the current buffer */
id|HWIF
c_func
(paren
id|drive
)paren
op_member_access_from_pointer
id|atapi_output_bytes
c_func
(paren
id|drive
comma
id|pc-&gt;current_position
comma
id|bcount.all
)paren
suffix:semicolon
r_else
id|idefloppy_output_buffers
c_func
(paren
id|drive
comma
id|pc
comma
id|bcount.all
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|pc-&gt;buffer
op_ne
l_int|NULL
)paren
multiline_comment|/* Read the current buffer */
id|HWIF
c_func
(paren
id|drive
)paren
op_member_access_from_pointer
id|atapi_input_bytes
c_func
(paren
id|drive
comma
id|pc-&gt;current_position
comma
id|bcount.all
)paren
suffix:semicolon
r_else
id|idefloppy_input_buffers
c_func
(paren
id|drive
comma
id|pc
comma
id|bcount.all
)paren
suffix:semicolon
)brace
multiline_comment|/* Update the current position */
id|pc-&gt;actually_transferred
op_add_assign
id|bcount.all
suffix:semicolon
id|pc-&gt;current_position
op_add_assign
id|bcount.all
suffix:semicolon
r_if
c_cond
(paren
id|HWGROUP
c_func
(paren
id|drive
)paren
op_member_access_from_pointer
id|handler
op_ne
l_int|NULL
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
id|ide_set_handler
c_func
(paren
id|drive
comma
op_amp
id|idefloppy_pc_intr
comma
id|IDEFLOPPY_WAIT_CMD
comma
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/* And set the interrupt handler again */
r_return
id|ide_started
suffix:semicolon
)brace
multiline_comment|/*&n; * This is the original routine that did the packet transfer.&n; * It fails at high speeds on the Iomega ZIP drive, so there&squot;s a slower version&n; * for that drive below. The algorithm is chosen based on drive type&n; */
DECL|function|idefloppy_transfer_pc
r_static
id|ide_startstop_t
id|idefloppy_transfer_pc
(paren
id|ide_drive_t
op_star
id|drive
)paren
(brace
id|ide_startstop_t
id|startstop
suffix:semicolon
id|idefloppy_floppy_t
op_star
id|floppy
op_assign
id|drive-&gt;driver_data
suffix:semicolon
id|atapi_ireason_t
id|ireason
suffix:semicolon
r_if
c_cond
(paren
id|ide_wait_stat
c_func
(paren
op_amp
id|startstop
comma
id|drive
comma
id|DRQ_STAT
comma
id|BUSY_STAT
comma
id|WAIT_READY
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ide-floppy: Strange, packet command &quot;
l_string|&quot;initiated yet DRQ isn&squot;t asserted&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|startstop
suffix:semicolon
)brace
id|ireason.all
op_assign
id|HWIF
c_func
(paren
id|drive
)paren
op_member_access_from_pointer
id|INB
c_func
(paren
id|IDE_IREASON_REG
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ireason.b.cod
op_logical_or
id|ireason.b.io
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ide-floppy: (IO,CoD) != (0,1) while &quot;
l_string|&quot;issuing a packet command&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|ide_do_reset
c_func
(paren
id|drive
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|HWGROUP
c_func
(paren
id|drive
)paren
op_member_access_from_pointer
id|handler
op_ne
l_int|NULL
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Set the interrupt routine */
id|ide_set_handler
c_func
(paren
id|drive
comma
op_amp
id|idefloppy_pc_intr
comma
id|IDEFLOPPY_WAIT_CMD
comma
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/* Send the actual packet */
id|HWIF
c_func
(paren
id|drive
)paren
op_member_access_from_pointer
id|atapi_output_bytes
c_func
(paren
id|drive
comma
id|floppy-&gt;pc-&gt;c
comma
l_int|12
)paren
suffix:semicolon
r_return
id|ide_started
suffix:semicolon
)brace
multiline_comment|/*&n; * What we have here is a classic case of a top half / bottom half&n; * interrupt service routine. In interrupt mode, the device sends&n; * an interrupt to signal it&squot;s ready to receive a packet. However,&n; * we need to delay about 2-3 ticks before issuing the packet or we&n; * gets in trouble.&n; *&n; * So, follow carefully. transfer_pc1 is called as an interrupt (or&n; * directly). In either case, when the device says it&squot;s ready for a &n; * packet, we schedule the packet transfer to occur about 2-3 ticks&n; * later in transfer_pc2.&n; */
DECL|function|idefloppy_transfer_pc2
r_static
r_int
id|idefloppy_transfer_pc2
(paren
id|ide_drive_t
op_star
id|drive
)paren
(brace
id|idefloppy_floppy_t
op_star
id|floppy
op_assign
id|drive-&gt;driver_data
suffix:semicolon
multiline_comment|/* Send the actual packet */
id|HWIF
c_func
(paren
id|drive
)paren
op_member_access_from_pointer
id|atapi_output_bytes
c_func
(paren
id|drive
comma
id|floppy-&gt;pc-&gt;c
comma
l_int|12
)paren
suffix:semicolon
multiline_comment|/* Timeout for the packet command */
r_return
id|IDEFLOPPY_WAIT_CMD
suffix:semicolon
)brace
DECL|function|idefloppy_transfer_pc1
r_static
id|ide_startstop_t
id|idefloppy_transfer_pc1
(paren
id|ide_drive_t
op_star
id|drive
)paren
(brace
id|idefloppy_floppy_t
op_star
id|floppy
op_assign
id|drive-&gt;driver_data
suffix:semicolon
id|ide_startstop_t
id|startstop
suffix:semicolon
id|atapi_ireason_t
id|ireason
suffix:semicolon
r_if
c_cond
(paren
id|ide_wait_stat
c_func
(paren
op_amp
id|startstop
comma
id|drive
comma
id|DRQ_STAT
comma
id|BUSY_STAT
comma
id|WAIT_READY
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ide-floppy: Strange, packet command &quot;
l_string|&quot;initiated yet DRQ isn&squot;t asserted&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|startstop
suffix:semicolon
)brace
id|ireason.all
op_assign
id|HWIF
c_func
(paren
id|drive
)paren
op_member_access_from_pointer
id|INB
c_func
(paren
id|IDE_IREASON_REG
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ireason.b.cod
op_logical_or
id|ireason.b.io
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ide-floppy: (IO,CoD) != (0,1) &quot;
l_string|&quot;while issuing a packet command&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|ide_do_reset
c_func
(paren
id|drive
)paren
suffix:semicolon
)brace
multiline_comment|/* &n;&t; * The following delay solves a problem with ATAPI Zip 100 drives&n;&t; * where the Busy flag was apparently being deasserted before the&n;&t; * unit was ready to receive data. This was happening on a&n;&t; * 1200 MHz Athlon system. 10/26/01 25msec is too short,&n;&t; * 40 and 50msec work well. idefloppy_pc_intr will not be actually&n;&t; * used until after the packet is moved in about 50 msec.&n;&t; */
r_if
c_cond
(paren
id|HWGROUP
c_func
(paren
id|drive
)paren
op_member_access_from_pointer
id|handler
op_ne
l_int|NULL
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
id|ide_set_handler
c_func
(paren
id|drive
comma
op_amp
id|idefloppy_pc_intr
comma
multiline_comment|/* service routine for packet command */
id|floppy-&gt;ticks
comma
multiline_comment|/* wait this long before &quot;failing&quot; */
op_amp
id|idefloppy_transfer_pc2
)paren
suffix:semicolon
multiline_comment|/* fail == transfer_pc2 */
r_return
id|ide_started
suffix:semicolon
)brace
multiline_comment|/**&n; * idefloppy_should_report_error()&n; *&n; * Supresses error messages resulting from Medium not present&n; */
DECL|function|idefloppy_should_report_error
r_static
r_inline
r_int
id|idefloppy_should_report_error
c_func
(paren
id|idefloppy_floppy_t
op_star
id|floppy
)paren
(brace
r_if
c_cond
(paren
id|floppy-&gt;sense_key
op_eq
l_int|0x02
op_logical_and
id|floppy-&gt;asc
op_eq
l_int|0x3a
op_logical_and
id|floppy-&gt;ascq
op_eq
l_int|0x00
)paren
r_return
l_int|0
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Issue a packet command&n; */
DECL|function|idefloppy_issue_pc
r_static
id|ide_startstop_t
id|idefloppy_issue_pc
(paren
id|ide_drive_t
op_star
id|drive
comma
id|idefloppy_pc_t
op_star
id|pc
)paren
(brace
id|idefloppy_floppy_t
op_star
id|floppy
op_assign
id|drive-&gt;driver_data
suffix:semicolon
id|ide_hwif_t
op_star
id|hwif
op_assign
id|drive-&gt;hwif
suffix:semicolon
id|atapi_feature_t
id|feature
suffix:semicolon
id|atapi_bcount_t
id|bcount
suffix:semicolon
id|ide_handler_t
op_star
id|pkt_xfer_routine
suffix:semicolon
macro_line|#if IDEFLOPPY_DEBUG_BUGS
r_if
c_cond
(paren
id|floppy-&gt;pc-&gt;c
(braket
l_int|0
)braket
op_eq
id|IDEFLOPPY_REQUEST_SENSE_CMD
op_logical_and
id|pc-&gt;c
(braket
l_int|0
)braket
op_eq
id|IDEFLOPPY_REQUEST_SENSE_CMD
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ide-floppy: possible ide-floppy.c bug - &quot;
l_string|&quot;Two request sense in serial were issued&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif /* IDEFLOPPY_DEBUG_BUGS */
r_if
c_cond
(paren
id|floppy-&gt;failed_pc
op_eq
l_int|NULL
op_logical_and
id|pc-&gt;c
(braket
l_int|0
)braket
op_ne
id|IDEFLOPPY_REQUEST_SENSE_CMD
)paren
id|floppy-&gt;failed_pc
op_assign
id|pc
suffix:semicolon
multiline_comment|/* Set the current packet command */
id|floppy-&gt;pc
op_assign
id|pc
suffix:semicolon
r_if
c_cond
(paren
id|pc-&gt;retries
OG
id|IDEFLOPPY_MAX_PC_RETRIES
op_logical_or
id|test_bit
c_func
(paren
id|PC_ABORT
comma
op_amp
id|pc-&gt;flags
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t; *&t;We will &quot;abort&quot; retrying a packet command in case&n;&t;&t; *&t;a legitimate error code was received.&n;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
id|test_bit
c_func
(paren
id|PC_ABORT
comma
op_amp
id|pc-&gt;flags
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|test_bit
c_func
(paren
id|PC_SUPPRESS_ERROR
comma
op_amp
id|pc-&gt;flags
)paren
)paren
(brace
r_if
c_cond
(paren
id|idefloppy_should_report_error
c_func
(paren
id|floppy
)paren
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ide-floppy: %s: I/O error, &quot;
l_string|&quot;pc = %2x, key = %2x, &quot;
l_string|&quot;asc = %2x, ascq = %2x&bslash;n&quot;
comma
id|drive-&gt;name
comma
id|pc-&gt;c
(braket
l_int|0
)braket
comma
id|floppy-&gt;sense_key
comma
id|floppy-&gt;asc
comma
id|floppy-&gt;ascq
)paren
suffix:semicolon
)brace
multiline_comment|/* Giving up */
id|pc-&gt;error
op_assign
id|IDEFLOPPY_ERROR_GENERAL
suffix:semicolon
)brace
id|floppy-&gt;failed_pc
op_assign
l_int|NULL
suffix:semicolon
id|pc
op_member_access_from_pointer
id|callback
c_func
(paren
id|drive
)paren
suffix:semicolon
r_return
id|ide_stopped
suffix:semicolon
)brace
id|debug_log
c_func
(paren
id|KERN_INFO
l_string|&quot;Retry number - %d&bslash;n&quot;
comma
id|pc-&gt;retries
)paren
suffix:semicolon
id|pc-&gt;retries
op_increment
suffix:semicolon
multiline_comment|/* We haven&squot;t transferred any data yet */
id|pc-&gt;actually_transferred
op_assign
l_int|0
suffix:semicolon
id|pc-&gt;current_position
op_assign
id|pc-&gt;buffer
suffix:semicolon
id|bcount.all
op_assign
id|min
c_func
(paren
id|pc-&gt;request_transfer
comma
l_int|63
op_star
l_int|1024
)paren
suffix:semicolon
r_if
c_cond
(paren
id|test_and_clear_bit
c_func
(paren
id|PC_DMA_ERROR
comma
op_amp
id|pc-&gt;flags
)paren
)paren
(brace
(paren
r_void
)paren
id|__ide_dma_off
c_func
(paren
id|drive
)paren
suffix:semicolon
)brace
id|feature.all
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|PC_DMA_RECOMMENDED
comma
op_amp
id|pc-&gt;flags
)paren
op_logical_and
id|drive-&gt;using_dma
)paren
id|feature.b.dma
op_assign
op_logical_neg
id|hwif
op_member_access_from_pointer
id|dma_setup
c_func
(paren
id|drive
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IDE_CONTROL_REG
)paren
id|HWIF
c_func
(paren
id|drive
)paren
op_member_access_from_pointer
id|OUTB
c_func
(paren
id|drive-&gt;ctl
comma
id|IDE_CONTROL_REG
)paren
suffix:semicolon
multiline_comment|/* Use PIO/DMA */
id|HWIF
c_func
(paren
id|drive
)paren
op_member_access_from_pointer
id|OUTB
c_func
(paren
id|feature.all
comma
id|IDE_FEATURE_REG
)paren
suffix:semicolon
id|HWIF
c_func
(paren
id|drive
)paren
op_member_access_from_pointer
id|OUTB
c_func
(paren
id|bcount.b.high
comma
id|IDE_BCOUNTH_REG
)paren
suffix:semicolon
id|HWIF
c_func
(paren
id|drive
)paren
op_member_access_from_pointer
id|OUTB
c_func
(paren
id|bcount.b.low
comma
id|IDE_BCOUNTL_REG
)paren
suffix:semicolon
id|HWIF
c_func
(paren
id|drive
)paren
op_member_access_from_pointer
id|OUTB
c_func
(paren
id|drive-&gt;select.all
comma
id|IDE_SELECT_REG
)paren
suffix:semicolon
r_if
c_cond
(paren
id|feature.b.dma
)paren
(brace
multiline_comment|/* Begin DMA, if necessary */
id|set_bit
c_func
(paren
id|PC_DMA_IN_PROGRESS
comma
op_amp
id|pc-&gt;flags
)paren
suffix:semicolon
id|hwif
op_member_access_from_pointer
id|dma_start
c_func
(paren
id|drive
)paren
suffix:semicolon
)brace
multiline_comment|/* Can we transfer the packet when we get the interrupt or wait? */
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|IDEFLOPPY_ZIP_DRIVE
comma
op_amp
id|floppy-&gt;flags
)paren
)paren
(brace
multiline_comment|/* wait */
id|pkt_xfer_routine
op_assign
op_amp
id|idefloppy_transfer_pc1
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* immediate */
id|pkt_xfer_routine
op_assign
op_amp
id|idefloppy_transfer_pc
suffix:semicolon
)brace
r_if
c_cond
(paren
id|test_bit
(paren
id|IDEFLOPPY_DRQ_INTERRUPT
comma
op_amp
id|floppy-&gt;flags
)paren
)paren
(brace
multiline_comment|/* Issue the packet command */
id|ide_execute_command
c_func
(paren
id|drive
comma
id|WIN_PACKETCMD
comma
id|pkt_xfer_routine
comma
id|IDEFLOPPY_WAIT_CMD
comma
l_int|NULL
)paren
suffix:semicolon
r_return
id|ide_started
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Issue the packet command */
id|HWIF
c_func
(paren
id|drive
)paren
op_member_access_from_pointer
id|OUTB
c_func
(paren
id|WIN_PACKETCMD
comma
id|IDE_COMMAND_REG
)paren
suffix:semicolon
r_return
(paren
op_star
id|pkt_xfer_routine
)paren
(paren
id|drive
)paren
suffix:semicolon
)brace
)brace
DECL|function|idefloppy_rw_callback
r_static
r_void
id|idefloppy_rw_callback
(paren
id|ide_drive_t
op_star
id|drive
)paren
(brace
id|debug_log
c_func
(paren
id|KERN_INFO
l_string|&quot;ide-floppy: Reached idefloppy_rw_callback&bslash;n&quot;
)paren
suffix:semicolon
id|idefloppy_do_end_request
c_func
(paren
id|drive
comma
l_int|1
comma
l_int|0
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|idefloppy_create_prevent_cmd
r_static
r_void
id|idefloppy_create_prevent_cmd
(paren
id|idefloppy_pc_t
op_star
id|pc
comma
r_int
id|prevent
)paren
(brace
id|debug_log
c_func
(paren
id|KERN_INFO
l_string|&quot;ide-floppy: creating prevent removal command, &quot;
l_string|&quot;prevent = %d&bslash;n&quot;
comma
id|prevent
)paren
suffix:semicolon
id|idefloppy_init_pc
c_func
(paren
id|pc
)paren
suffix:semicolon
id|pc-&gt;c
(braket
l_int|0
)braket
op_assign
id|IDEFLOPPY_PREVENT_REMOVAL_CMD
suffix:semicolon
id|pc-&gt;c
(braket
l_int|4
)braket
op_assign
id|prevent
suffix:semicolon
)brace
DECL|function|idefloppy_create_read_capacity_cmd
r_static
r_void
id|idefloppy_create_read_capacity_cmd
(paren
id|idefloppy_pc_t
op_star
id|pc
)paren
(brace
id|idefloppy_init_pc
c_func
(paren
id|pc
)paren
suffix:semicolon
id|pc-&gt;c
(braket
l_int|0
)braket
op_assign
id|IDEFLOPPY_READ_CAPACITY_CMD
suffix:semicolon
id|pc-&gt;c
(braket
l_int|7
)braket
op_assign
l_int|255
suffix:semicolon
id|pc-&gt;c
(braket
l_int|8
)braket
op_assign
l_int|255
suffix:semicolon
id|pc-&gt;request_transfer
op_assign
l_int|255
suffix:semicolon
)brace
DECL|function|idefloppy_create_format_unit_cmd
r_static
r_void
id|idefloppy_create_format_unit_cmd
(paren
id|idefloppy_pc_t
op_star
id|pc
comma
r_int
id|b
comma
r_int
id|l
comma
r_int
id|flags
)paren
(brace
id|idefloppy_init_pc
c_func
(paren
id|pc
)paren
suffix:semicolon
id|pc-&gt;c
(braket
l_int|0
)braket
op_assign
id|IDEFLOPPY_FORMAT_UNIT_CMD
suffix:semicolon
id|pc-&gt;c
(braket
l_int|1
)braket
op_assign
l_int|0x17
suffix:semicolon
id|memset
c_func
(paren
id|pc-&gt;buffer
comma
l_int|0
comma
l_int|12
)paren
suffix:semicolon
id|pc-&gt;buffer
(braket
l_int|1
)braket
op_assign
l_int|0xA2
suffix:semicolon
multiline_comment|/* Default format list header, u8 1: FOV/DCRT/IMM bits set */
r_if
c_cond
(paren
id|flags
op_amp
l_int|1
)paren
multiline_comment|/* Verify bit on... */
id|pc-&gt;buffer
(braket
l_int|1
)braket
op_xor_assign
l_int|0x20
suffix:semicolon
multiline_comment|/* ... turn off DCRT bit */
id|pc-&gt;buffer
(braket
l_int|3
)braket
op_assign
l_int|8
suffix:semicolon
id|put_unaligned
c_func
(paren
id|htonl
c_func
(paren
id|b
)paren
comma
(paren
r_int
r_int
op_star
)paren
(paren
op_amp
id|pc-&gt;buffer
(braket
l_int|4
)braket
)paren
)paren
suffix:semicolon
id|put_unaligned
c_func
(paren
id|htonl
c_func
(paren
id|l
)paren
comma
(paren
r_int
r_int
op_star
)paren
(paren
op_amp
id|pc-&gt;buffer
(braket
l_int|8
)braket
)paren
)paren
suffix:semicolon
id|pc-&gt;buffer_size
op_assign
l_int|12
suffix:semicolon
id|set_bit
c_func
(paren
id|PC_WRITING
comma
op_amp
id|pc-&gt;flags
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;A mode sense command is used to &quot;sense&quot; floppy parameters.&n; */
DECL|function|idefloppy_create_mode_sense_cmd
r_static
r_void
id|idefloppy_create_mode_sense_cmd
(paren
id|idefloppy_pc_t
op_star
id|pc
comma
id|u8
id|page_code
comma
id|u8
id|type
)paren
(brace
id|u16
id|length
op_assign
r_sizeof
(paren
id|idefloppy_mode_parameter_header_t
)paren
suffix:semicolon
id|idefloppy_init_pc
c_func
(paren
id|pc
)paren
suffix:semicolon
id|pc-&gt;c
(braket
l_int|0
)braket
op_assign
id|IDEFLOPPY_MODE_SENSE_CMD
suffix:semicolon
id|pc-&gt;c
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|pc-&gt;c
(braket
l_int|2
)braket
op_assign
id|page_code
op_plus
(paren
id|type
op_lshift
l_int|6
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|page_code
)paren
(brace
r_case
id|IDEFLOPPY_CAPABILITIES_PAGE
suffix:colon
id|length
op_add_assign
l_int|12
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IDEFLOPPY_FLEXIBLE_DISK_PAGE
suffix:colon
id|length
op_add_assign
l_int|32
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ide-floppy: unsupported page code &quot;
l_string|&quot;in create_mode_sense_cmd&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|put_unaligned
c_func
(paren
id|htons
c_func
(paren
id|length
)paren
comma
(paren
id|u16
op_star
)paren
op_amp
id|pc-&gt;c
(braket
l_int|7
)braket
)paren
suffix:semicolon
id|pc-&gt;request_transfer
op_assign
id|length
suffix:semicolon
)brace
DECL|function|idefloppy_create_start_stop_cmd
r_static
r_void
id|idefloppy_create_start_stop_cmd
(paren
id|idefloppy_pc_t
op_star
id|pc
comma
r_int
id|start
)paren
(brace
id|idefloppy_init_pc
c_func
(paren
id|pc
)paren
suffix:semicolon
id|pc-&gt;c
(braket
l_int|0
)braket
op_assign
id|IDEFLOPPY_START_STOP_CMD
suffix:semicolon
id|pc-&gt;c
(braket
l_int|4
)braket
op_assign
id|start
suffix:semicolon
)brace
DECL|function|idefloppy_create_test_unit_ready_cmd
r_static
r_void
id|idefloppy_create_test_unit_ready_cmd
c_func
(paren
id|idefloppy_pc_t
op_star
id|pc
)paren
(brace
id|idefloppy_init_pc
c_func
(paren
id|pc
)paren
suffix:semicolon
id|pc-&gt;c
(braket
l_int|0
)braket
op_assign
id|IDEFLOPPY_TEST_UNIT_READY_CMD
suffix:semicolon
)brace
DECL|function|idefloppy_create_rw_cmd
r_static
r_void
id|idefloppy_create_rw_cmd
(paren
id|idefloppy_floppy_t
op_star
id|floppy
comma
id|idefloppy_pc_t
op_star
id|pc
comma
r_struct
id|request
op_star
id|rq
comma
r_int
r_int
id|sector
)paren
(brace
r_int
id|block
op_assign
id|sector
op_div
id|floppy-&gt;bs_factor
suffix:semicolon
r_int
id|blocks
op_assign
id|rq-&gt;nr_sectors
op_div
id|floppy-&gt;bs_factor
suffix:semicolon
r_int
id|cmd
op_assign
id|rq_data_dir
c_func
(paren
id|rq
)paren
suffix:semicolon
id|debug_log
c_func
(paren
l_string|&quot;create_rw1%d_cmd: block == %d, blocks == %d&bslash;n&quot;
comma
l_int|2
op_star
id|test_bit
(paren
id|IDEFLOPPY_USE_READ12
comma
op_amp
id|floppy-&gt;flags
)paren
comma
id|block
comma
id|blocks
)paren
suffix:semicolon
id|idefloppy_init_pc
c_func
(paren
id|pc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|IDEFLOPPY_USE_READ12
comma
op_amp
id|floppy-&gt;flags
)paren
)paren
(brace
id|pc-&gt;c
(braket
l_int|0
)braket
op_assign
id|cmd
op_eq
id|READ
ques
c_cond
id|IDEFLOPPY_READ12_CMD
suffix:colon
id|IDEFLOPPY_WRITE12_CMD
suffix:semicolon
id|put_unaligned
c_func
(paren
id|htonl
c_func
(paren
id|blocks
)paren
comma
(paren
r_int
r_int
op_star
)paren
op_amp
id|pc-&gt;c
(braket
l_int|6
)braket
)paren
suffix:semicolon
)brace
r_else
(brace
id|pc-&gt;c
(braket
l_int|0
)braket
op_assign
id|cmd
op_eq
id|READ
ques
c_cond
id|IDEFLOPPY_READ10_CMD
suffix:colon
id|IDEFLOPPY_WRITE10_CMD
suffix:semicolon
id|put_unaligned
c_func
(paren
id|htons
c_func
(paren
id|blocks
)paren
comma
(paren
r_int
r_int
op_star
)paren
op_amp
id|pc-&gt;c
(braket
l_int|7
)braket
)paren
suffix:semicolon
)brace
id|put_unaligned
c_func
(paren
id|htonl
c_func
(paren
id|block
)paren
comma
(paren
r_int
r_int
op_star
)paren
op_amp
id|pc-&gt;c
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|pc-&gt;callback
op_assign
op_amp
id|idefloppy_rw_callback
suffix:semicolon
id|pc-&gt;rq
op_assign
id|rq
suffix:semicolon
id|pc-&gt;b_count
op_assign
id|cmd
op_eq
id|READ
ques
c_cond
l_int|0
suffix:colon
id|rq-&gt;bio-&gt;bi_size
suffix:semicolon
r_if
c_cond
(paren
id|rq-&gt;flags
op_amp
id|REQ_RW
)paren
id|set_bit
c_func
(paren
id|PC_WRITING
comma
op_amp
id|pc-&gt;flags
)paren
suffix:semicolon
id|pc-&gt;buffer
op_assign
l_int|NULL
suffix:semicolon
id|pc-&gt;request_transfer
op_assign
id|pc-&gt;buffer_size
op_assign
id|blocks
op_star
id|floppy-&gt;block_size
suffix:semicolon
id|set_bit
c_func
(paren
id|PC_DMA_RECOMMENDED
comma
op_amp
id|pc-&gt;flags
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|idefloppy_blockpc_cmd
id|idefloppy_blockpc_cmd
c_func
(paren
id|idefloppy_floppy_t
op_star
id|floppy
comma
id|idefloppy_pc_t
op_star
id|pc
comma
r_struct
id|request
op_star
id|rq
)paren
(brace
multiline_comment|/*&n;&t; * just support eject for now, it would not be hard to make the&n;&t; * REQ_BLOCK_PC support fully-featured&n;&t; */
r_if
c_cond
(paren
id|rq-&gt;cmd
(braket
l_int|0
)braket
op_ne
id|IDEFLOPPY_START_STOP_CMD
)paren
r_return
l_int|1
suffix:semicolon
id|idefloppy_init_pc
c_func
(paren
id|pc
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|pc-&gt;c
comma
id|rq-&gt;cmd
comma
r_sizeof
(paren
id|pc-&gt;c
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;idefloppy_do_request is our request handling function.&t;&n; */
DECL|function|idefloppy_do_request
r_static
id|ide_startstop_t
id|idefloppy_do_request
(paren
id|ide_drive_t
op_star
id|drive
comma
r_struct
id|request
op_star
id|rq
comma
id|sector_t
id|block_s
)paren
(brace
id|idefloppy_floppy_t
op_star
id|floppy
op_assign
id|drive-&gt;driver_data
suffix:semicolon
id|idefloppy_pc_t
op_star
id|pc
suffix:semicolon
r_int
r_int
id|block
op_assign
(paren
r_int
r_int
)paren
id|block_s
suffix:semicolon
id|debug_log
c_func
(paren
id|KERN_INFO
l_string|&quot;rq_status: %d, dev: %s, flags: %lx, errors: %d&bslash;n&quot;
comma
id|rq-&gt;rq_status
comma
id|rq-&gt;rq_disk-&gt;disk_name
comma
id|rq-&gt;flags
comma
id|rq-&gt;errors
)paren
suffix:semicolon
id|debug_log
c_func
(paren
id|KERN_INFO
l_string|&quot;sector: %ld, nr_sectors: %ld, &quot;
l_string|&quot;current_nr_sectors: %d&bslash;n&quot;
comma
(paren
r_int
)paren
id|rq-&gt;sector
comma
id|rq-&gt;nr_sectors
comma
id|rq-&gt;current_nr_sectors
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rq-&gt;errors
op_ge
id|ERROR_MAX
)paren
(brace
r_if
c_cond
(paren
id|floppy-&gt;failed_pc
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|idefloppy_should_report_error
c_func
(paren
id|floppy
)paren
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ide-floppy: %s: I/O error, pc = %2x,&quot;
l_string|&quot; key = %2x, asc = %2x, ascq = %2x&bslash;n&quot;
comma
id|drive-&gt;name
comma
id|floppy-&gt;failed_pc-&gt;c
(braket
l_int|0
)braket
comma
id|floppy-&gt;sense_key
comma
id|floppy-&gt;asc
comma
id|floppy-&gt;ascq
)paren
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ide-floppy: %s: I/O error&bslash;n&quot;
comma
id|drive-&gt;name
)paren
suffix:semicolon
id|idefloppy_do_end_request
c_func
(paren
id|drive
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_return
id|ide_stopped
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rq-&gt;flags
op_amp
id|REQ_CMD
)paren
(brace
r_if
c_cond
(paren
(paren
(paren
r_int
)paren
id|rq-&gt;sector
op_mod
id|floppy-&gt;bs_factor
)paren
op_logical_or
(paren
id|rq-&gt;nr_sectors
op_mod
id|floppy-&gt;bs_factor
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: unsupported r/w request size&bslash;n&quot;
comma
id|drive-&gt;name
)paren
suffix:semicolon
id|idefloppy_do_end_request
c_func
(paren
id|drive
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_return
id|ide_stopped
suffix:semicolon
)brace
id|pc
op_assign
id|idefloppy_next_pc_storage
c_func
(paren
id|drive
)paren
suffix:semicolon
id|idefloppy_create_rw_cmd
c_func
(paren
id|floppy
comma
id|pc
comma
id|rq
comma
id|block
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|rq-&gt;flags
op_amp
id|REQ_SPECIAL
)paren
(brace
id|pc
op_assign
(paren
id|idefloppy_pc_t
op_star
)paren
id|rq-&gt;buffer
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|rq-&gt;flags
op_amp
id|REQ_BLOCK_PC
)paren
(brace
id|pc
op_assign
id|idefloppy_next_pc_storage
c_func
(paren
id|drive
)paren
suffix:semicolon
r_if
c_cond
(paren
id|idefloppy_blockpc_cmd
c_func
(paren
id|floppy
comma
id|pc
comma
id|rq
)paren
)paren
(brace
id|idefloppy_do_end_request
c_func
(paren
id|drive
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_return
id|ide_stopped
suffix:semicolon
)brace
)brace
r_else
(brace
id|blk_dump_rq_flags
c_func
(paren
id|rq
comma
l_string|&quot;ide-floppy: unsupported command in queue&quot;
)paren
suffix:semicolon
id|idefloppy_do_end_request
c_func
(paren
id|drive
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_return
id|ide_stopped
suffix:semicolon
)brace
id|pc-&gt;rq
op_assign
id|rq
suffix:semicolon
r_return
id|idefloppy_issue_pc
c_func
(paren
id|drive
comma
id|pc
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;idefloppy_queue_pc_tail adds a special packet command request to the&n; *&t;tail of the request queue, and waits for it to be serviced.&n; */
DECL|function|idefloppy_queue_pc_tail
r_static
r_int
id|idefloppy_queue_pc_tail
(paren
id|ide_drive_t
op_star
id|drive
comma
id|idefloppy_pc_t
op_star
id|pc
)paren
(brace
r_struct
id|request
id|rq
suffix:semicolon
id|ide_init_drive_cmd
(paren
op_amp
id|rq
)paren
suffix:semicolon
id|rq.buffer
op_assign
(paren
r_char
op_star
)paren
id|pc
suffix:semicolon
id|rq.flags
op_assign
id|REQ_SPECIAL
suffix:semicolon
singleline_comment|//&t;rq.cmd = IDEFLOPPY_PC_RQ;
r_return
id|ide_do_drive_cmd
c_func
(paren
id|drive
comma
op_amp
id|rq
comma
id|ide_wait
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Look at the flexible disk page parameters. We will ignore the CHS&n; *&t;capacity parameters and use the LBA parameters instead.&n; */
DECL|function|idefloppy_get_flexible_disk_page
r_static
r_int
id|idefloppy_get_flexible_disk_page
(paren
id|ide_drive_t
op_star
id|drive
)paren
(brace
id|idefloppy_floppy_t
op_star
id|floppy
op_assign
id|drive-&gt;driver_data
suffix:semicolon
id|idefloppy_pc_t
id|pc
suffix:semicolon
id|idefloppy_mode_parameter_header_t
op_star
id|header
suffix:semicolon
id|idefloppy_flexible_disk_page_t
op_star
id|page
suffix:semicolon
r_int
id|capacity
comma
id|lba_capacity
suffix:semicolon
id|idefloppy_create_mode_sense_cmd
c_func
(paren
op_amp
id|pc
comma
id|IDEFLOPPY_FLEXIBLE_DISK_PAGE
comma
id|MODE_SENSE_CURRENT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|idefloppy_queue_pc_tail
c_func
(paren
id|drive
comma
op_amp
id|pc
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ide-floppy: Can&squot;t get flexible disk &quot;
l_string|&quot;page parameters&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|header
op_assign
(paren
id|idefloppy_mode_parameter_header_t
op_star
)paren
id|pc.buffer
suffix:semicolon
id|floppy-&gt;wp
op_assign
id|header-&gt;wp
suffix:semicolon
id|set_disk_ro
c_func
(paren
id|drive-&gt;disk
comma
id|floppy-&gt;wp
)paren
suffix:semicolon
id|page
op_assign
(paren
id|idefloppy_flexible_disk_page_t
op_star
)paren
(paren
id|header
op_plus
l_int|1
)paren
suffix:semicolon
id|page-&gt;transfer_rate
op_assign
id|ntohs
c_func
(paren
id|page-&gt;transfer_rate
)paren
suffix:semicolon
id|page-&gt;sector_size
op_assign
id|ntohs
c_func
(paren
id|page-&gt;sector_size
)paren
suffix:semicolon
id|page-&gt;cyls
op_assign
id|ntohs
c_func
(paren
id|page-&gt;cyls
)paren
suffix:semicolon
id|page-&gt;rpm
op_assign
id|ntohs
c_func
(paren
id|page-&gt;rpm
)paren
suffix:semicolon
id|capacity
op_assign
id|page-&gt;cyls
op_star
id|page-&gt;heads
op_star
id|page-&gt;sectors
op_star
id|page-&gt;sector_size
suffix:semicolon
r_if
c_cond
(paren
id|memcmp
(paren
id|page
comma
op_amp
id|floppy-&gt;flexible_disk_page
comma
r_sizeof
(paren
id|idefloppy_flexible_disk_page_t
)paren
)paren
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %dkB, %d/%d/%d CHS, %d kBps, &quot;
l_string|&quot;%d sector size, %d rpm&bslash;n&quot;
comma
id|drive-&gt;name
comma
id|capacity
op_div
l_int|1024
comma
id|page-&gt;cyls
comma
id|page-&gt;heads
comma
id|page-&gt;sectors
comma
id|page-&gt;transfer_rate
op_div
l_int|8
comma
id|page-&gt;sector_size
comma
id|page-&gt;rpm
)paren
suffix:semicolon
id|floppy-&gt;flexible_disk_page
op_assign
op_star
id|page
suffix:semicolon
id|drive-&gt;bios_cyl
op_assign
id|page-&gt;cyls
suffix:semicolon
id|drive-&gt;bios_head
op_assign
id|page-&gt;heads
suffix:semicolon
id|drive-&gt;bios_sect
op_assign
id|page-&gt;sectors
suffix:semicolon
id|lba_capacity
op_assign
id|floppy-&gt;blocks
op_star
id|floppy-&gt;block_size
suffix:semicolon
r_if
c_cond
(paren
id|capacity
OL
id|lba_capacity
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;%s: The disk reports a capacity of %d &quot;
l_string|&quot;bytes, but the drive only handles %d&bslash;n&quot;
comma
id|drive-&gt;name
comma
id|lba_capacity
comma
id|capacity
)paren
suffix:semicolon
id|floppy-&gt;blocks
op_assign
id|floppy-&gt;block_size
ques
c_cond
id|capacity
op_div
id|floppy-&gt;block_size
suffix:colon
l_int|0
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|idefloppy_get_capability_page
r_static
r_int
id|idefloppy_get_capability_page
c_func
(paren
id|ide_drive_t
op_star
id|drive
)paren
(brace
id|idefloppy_floppy_t
op_star
id|floppy
op_assign
id|drive-&gt;driver_data
suffix:semicolon
id|idefloppy_pc_t
id|pc
suffix:semicolon
id|idefloppy_mode_parameter_header_t
op_star
id|header
suffix:semicolon
id|idefloppy_capabilities_page_t
op_star
id|page
suffix:semicolon
id|floppy-&gt;srfp
op_assign
l_int|0
suffix:semicolon
id|idefloppy_create_mode_sense_cmd
c_func
(paren
op_amp
id|pc
comma
id|IDEFLOPPY_CAPABILITIES_PAGE
comma
id|MODE_SENSE_CURRENT
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|PC_SUPPRESS_ERROR
comma
op_amp
id|pc.flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|idefloppy_queue_pc_tail
c_func
(paren
id|drive
comma
op_amp
id|pc
)paren
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
id|header
op_assign
(paren
id|idefloppy_mode_parameter_header_t
op_star
)paren
id|pc.buffer
suffix:semicolon
id|page
op_assign
(paren
id|idefloppy_capabilities_page_t
op_star
)paren
(paren
id|header
op_plus
l_int|1
)paren
suffix:semicolon
id|floppy-&gt;srfp
op_assign
id|page-&gt;srfp
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Determine if a media is present in the floppy drive, and if so,&n; *&t;its LBA capacity.&n; */
DECL|function|idefloppy_get_capacity
r_static
r_int
id|idefloppy_get_capacity
(paren
id|ide_drive_t
op_star
id|drive
)paren
(brace
id|idefloppy_floppy_t
op_star
id|floppy
op_assign
id|drive-&gt;driver_data
suffix:semicolon
id|idefloppy_pc_t
id|pc
suffix:semicolon
id|idefloppy_capacity_header_t
op_star
id|header
suffix:semicolon
id|idefloppy_capacity_descriptor_t
op_star
id|descriptor
suffix:semicolon
r_int
id|i
comma
id|descriptors
comma
id|rc
op_assign
l_int|1
comma
id|blocks
comma
id|length
suffix:semicolon
id|drive-&gt;bios_cyl
op_assign
l_int|0
suffix:semicolon
id|drive-&gt;bios_head
op_assign
id|drive-&gt;bios_sect
op_assign
l_int|0
suffix:semicolon
id|floppy-&gt;blocks
op_assign
id|floppy-&gt;bs_factor
op_assign
l_int|0
suffix:semicolon
id|set_capacity
c_func
(paren
id|drive-&gt;disk
comma
l_int|0
)paren
suffix:semicolon
id|idefloppy_create_read_capacity_cmd
c_func
(paren
op_amp
id|pc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|idefloppy_queue_pc_tail
c_func
(paren
id|drive
comma
op_amp
id|pc
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ide-floppy: Can&squot;t get floppy parameters&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|header
op_assign
(paren
id|idefloppy_capacity_header_t
op_star
)paren
id|pc.buffer
suffix:semicolon
id|descriptors
op_assign
id|header-&gt;length
op_div
r_sizeof
(paren
id|idefloppy_capacity_descriptor_t
)paren
suffix:semicolon
id|descriptor
op_assign
(paren
id|idefloppy_capacity_descriptor_t
op_star
)paren
(paren
id|header
op_plus
l_int|1
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|descriptors
suffix:semicolon
id|i
op_increment
comma
id|descriptor
op_increment
)paren
(brace
id|blocks
op_assign
id|descriptor-&gt;blocks
op_assign
id|ntohl
c_func
(paren
id|descriptor-&gt;blocks
)paren
suffix:semicolon
id|length
op_assign
id|descriptor-&gt;length
op_assign
id|ntohs
c_func
(paren
id|descriptor-&gt;length
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|i
)paren
(brace
r_switch
c_cond
(paren
id|descriptor-&gt;dc
)paren
(brace
multiline_comment|/* Clik! drive returns this instead of CAPACITY_CURRENT */
r_case
id|CAPACITY_UNFORMATTED
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|test_bit
c_func
(paren
id|IDEFLOPPY_CLIK_DRIVE
comma
op_amp
id|floppy-&gt;flags
)paren
)paren
multiline_comment|/*&n;&t;&t;&t;&t; * If it is not a clik drive, break out&n;&t;&t;&t;&t; * (maintains previous driver behaviour)&n;&t;&t;&t;&t; */
r_break
suffix:semicolon
r_case
id|CAPACITY_CURRENT
suffix:colon
multiline_comment|/* Normal Zip/LS-120 disks */
r_if
c_cond
(paren
id|memcmp
c_func
(paren
id|descriptor
comma
op_amp
id|floppy-&gt;capacity
comma
r_sizeof
(paren
id|idefloppy_capacity_descriptor_t
)paren
)paren
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: %dkB, %d blocks, %d &quot;
l_string|&quot;sector size&bslash;n&quot;
comma
id|drive-&gt;name
comma
id|blocks
op_star
id|length
op_div
l_int|1024
comma
id|blocks
comma
id|length
)paren
suffix:semicolon
id|floppy-&gt;capacity
op_assign
op_star
id|descriptor
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|length
op_logical_or
id|length
op_mod
l_int|512
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;%s: %d bytes block size &quot;
l_string|&quot;not supported&bslash;n&quot;
comma
id|drive-&gt;name
comma
id|length
)paren
suffix:semicolon
)brace
r_else
(brace
id|floppy-&gt;blocks
op_assign
id|blocks
suffix:semicolon
id|floppy-&gt;block_size
op_assign
id|length
suffix:semicolon
r_if
c_cond
(paren
(paren
id|floppy-&gt;bs_factor
op_assign
id|length
op_div
l_int|512
)paren
op_ne
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;%s: warning: non &quot;
l_string|&quot;512 bytes block size not &quot;
l_string|&quot;fully supported&bslash;n&quot;
comma
id|drive-&gt;name
)paren
suffix:semicolon
id|rc
op_assign
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|CAPACITY_NO_CARTRIDGE
suffix:colon
multiline_comment|/*&n;&t;&t;&t; * This is a KERN_ERR so it appears on screen&n;&t;&t;&t; * for the user to see&n;&t;&t;&t; */
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: No disk in drive&bslash;n&quot;
comma
id|drive-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CAPACITY_INVALID
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: Invalid capacity for disk &quot;
l_string|&quot;in drive&bslash;n&quot;
comma
id|drive-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|i
)paren
(brace
id|debug_log
c_func
(paren
l_string|&quot;Descriptor 0 Code: %d&bslash;n&quot;
comma
id|descriptor-&gt;dc
)paren
suffix:semicolon
)brace
id|debug_log
c_func
(paren
l_string|&quot;Descriptor %d: %dkB, %d blocks, %d &quot;
l_string|&quot;sector size&bslash;n&quot;
comma
id|i
comma
id|blocks
op_star
id|length
op_div
l_int|1024
comma
id|blocks
comma
id|length
)paren
suffix:semicolon
)brace
multiline_comment|/* Clik! disk does not support get_flexible_disk_page */
r_if
c_cond
(paren
op_logical_neg
id|test_bit
c_func
(paren
id|IDEFLOPPY_CLIK_DRIVE
comma
op_amp
id|floppy-&gt;flags
)paren
)paren
(brace
(paren
r_void
)paren
id|idefloppy_get_flexible_disk_page
c_func
(paren
id|drive
)paren
suffix:semicolon
)brace
id|set_capacity
c_func
(paren
id|drive-&gt;disk
comma
id|floppy-&gt;blocks
op_star
id|floppy-&gt;bs_factor
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*&n;** Obtain the list of formattable capacities.&n;** Very similar to idefloppy_get_capacity, except that we push the capacity&n;** descriptors to userland, instead of our own structures.&n;**&n;** Userland gives us the following structure:&n;**&n;** struct idefloppy_format_capacities {&n;**        int nformats;&n;**        struct {&n;**                int nblocks;&n;**                int blocksize;&n;**                } formats[];&n;**        } ;&n;**&n;** userland initializes nformats to the number of allocated formats[]&n;** records.  On exit we set nformats to the number of records we&squot;ve&n;** actually initialized.&n;**&n;*/
DECL|function|idefloppy_get_format_capacities
r_static
r_int
id|idefloppy_get_format_capacities
c_func
(paren
id|ide_drive_t
op_star
id|drive
comma
r_int
id|__user
op_star
id|arg
)paren
(brace
id|idefloppy_pc_t
id|pc
suffix:semicolon
id|idefloppy_capacity_header_t
op_star
id|header
suffix:semicolon
id|idefloppy_capacity_descriptor_t
op_star
id|descriptor
suffix:semicolon
r_int
id|i
comma
id|descriptors
comma
id|blocks
comma
id|length
suffix:semicolon
r_int
id|u_array_size
suffix:semicolon
r_int
id|u_index
suffix:semicolon
r_int
id|__user
op_star
id|argp
suffix:semicolon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|u_array_size
comma
id|arg
)paren
)paren
r_return
(paren
op_minus
id|EFAULT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|u_array_size
op_le
l_int|0
)paren
r_return
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
id|idefloppy_create_read_capacity_cmd
c_func
(paren
op_amp
id|pc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|idefloppy_queue_pc_tail
c_func
(paren
id|drive
comma
op_amp
id|pc
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ide-floppy: Can&squot;t get floppy parameters&bslash;n&quot;
)paren
suffix:semicolon
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
id|header
op_assign
(paren
id|idefloppy_capacity_header_t
op_star
)paren
id|pc.buffer
suffix:semicolon
id|descriptors
op_assign
id|header-&gt;length
op_div
r_sizeof
(paren
id|idefloppy_capacity_descriptor_t
)paren
suffix:semicolon
id|descriptor
op_assign
(paren
id|idefloppy_capacity_descriptor_t
op_star
)paren
(paren
id|header
op_plus
l_int|1
)paren
suffix:semicolon
id|u_index
op_assign
l_int|0
suffix:semicolon
id|argp
op_assign
id|arg
op_plus
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t;** We always skip the first capacity descriptor.  That&squot;s the&n;&t;** current capacity.  We are interested in the remaining descriptors,&n;&t;** the formattable capacities.&n;&t;*/
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|descriptors
suffix:semicolon
id|i
op_increment
comma
id|descriptor
op_increment
)paren
(brace
r_if
c_cond
(paren
id|u_index
op_ge
id|u_array_size
)paren
r_break
suffix:semicolon
multiline_comment|/* User-supplied buffer too small */
r_if
c_cond
(paren
id|i
op_eq
l_int|0
)paren
r_continue
suffix:semicolon
multiline_comment|/* Skip the first descriptor */
id|blocks
op_assign
id|ntohl
c_func
(paren
id|descriptor-&gt;blocks
)paren
suffix:semicolon
id|length
op_assign
id|ntohs
c_func
(paren
id|descriptor-&gt;length
)paren
suffix:semicolon
r_if
c_cond
(paren
id|put_user
c_func
(paren
id|blocks
comma
id|argp
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
op_increment
id|argp
suffix:semicolon
r_if
c_cond
(paren
id|put_user
c_func
(paren
id|length
comma
id|argp
)paren
)paren
r_return
(paren
op_minus
id|EFAULT
)paren
suffix:semicolon
op_increment
id|argp
suffix:semicolon
op_increment
id|u_index
suffix:semicolon
)brace
r_if
c_cond
(paren
id|put_user
c_func
(paren
id|u_index
comma
id|arg
)paren
)paren
r_return
(paren
op_minus
id|EFAULT
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;** Send ATAPI_FORMAT_UNIT to the drive.&n;**&n;** Userland gives us the following structure:&n;**&n;** struct idefloppy_format_command {&n;**        int nblocks;&n;**        int blocksize;&n;**        int flags;&n;**        } ;&n;**&n;** flags is a bitmask, currently, the only defined flag is:&n;**&n;**        0x01 - verify media after format.&n;*/
DECL|function|idefloppy_begin_format
r_static
r_int
id|idefloppy_begin_format
c_func
(paren
id|ide_drive_t
op_star
id|drive
comma
r_int
id|__user
op_star
id|arg
)paren
(brace
r_int
id|blocks
suffix:semicolon
r_int
id|length
suffix:semicolon
r_int
id|flags
suffix:semicolon
id|idefloppy_pc_t
id|pc
suffix:semicolon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|blocks
comma
id|arg
)paren
op_logical_or
id|get_user
c_func
(paren
id|length
comma
id|arg
op_plus
l_int|1
)paren
op_logical_or
id|get_user
c_func
(paren
id|flags
comma
id|arg
op_plus
l_int|2
)paren
)paren
(brace
r_return
(paren
op_minus
id|EFAULT
)paren
suffix:semicolon
)brace
multiline_comment|/* Get the SFRP bit */
(paren
r_void
)paren
id|idefloppy_get_capability_page
c_func
(paren
id|drive
)paren
suffix:semicolon
id|idefloppy_create_format_unit_cmd
c_func
(paren
op_amp
id|pc
comma
id|blocks
comma
id|length
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|idefloppy_queue_pc_tail
c_func
(paren
id|drive
comma
op_amp
id|pc
)paren
)paren
(brace
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;** Get ATAPI_FORMAT_UNIT progress indication.&n;**&n;** Userland gives a pointer to an int.  The int is set to a progresss&n;** indicator 0-65536, with 65536=100%.&n;**&n;** If the drive does not support format progress indication, we just check&n;** the dsc bit, and return either 0 or 65536.&n;*/
DECL|function|idefloppy_get_format_progress
r_static
r_int
id|idefloppy_get_format_progress
c_func
(paren
id|ide_drive_t
op_star
id|drive
comma
r_int
id|__user
op_star
id|arg
)paren
(brace
id|idefloppy_floppy_t
op_star
id|floppy
op_assign
id|drive-&gt;driver_data
suffix:semicolon
id|idefloppy_pc_t
id|pc
suffix:semicolon
r_int
id|progress_indication
op_assign
l_int|0x10000
suffix:semicolon
r_if
c_cond
(paren
id|floppy-&gt;srfp
)paren
(brace
id|idefloppy_create_request_sense_cmd
c_func
(paren
op_amp
id|pc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|idefloppy_queue_pc_tail
c_func
(paren
id|drive
comma
op_amp
id|pc
)paren
)paren
(brace
r_return
(paren
op_minus
id|EIO
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|floppy-&gt;sense_key
op_eq
l_int|2
op_logical_and
id|floppy-&gt;asc
op_eq
l_int|4
op_logical_and
id|floppy-&gt;ascq
op_eq
l_int|4
)paren
(brace
id|progress_indication
op_assign
id|floppy-&gt;progress_indication
suffix:semicolon
)brace
multiline_comment|/* Else assume format_unit has finished, and we&squot;re&n;&t;&t;** at 0x10000 */
)brace
r_else
(brace
id|atapi_status_t
id|status
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
id|status.all
op_assign
id|HWIF
c_func
(paren
id|drive
)paren
op_member_access_from_pointer
id|INB
c_func
(paren
id|IDE_STATUS_REG
)paren
suffix:semicolon
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
id|progress_indication
op_assign
op_logical_neg
id|status.b.dsc
ques
c_cond
l_int|0
suffix:colon
l_int|0x10000
suffix:semicolon
)brace
r_if
c_cond
(paren
id|put_user
c_func
(paren
id|progress_indication
comma
id|arg
)paren
)paren
r_return
(paren
op_minus
id|EFAULT
)paren
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Return the current floppy capacity.&n; */
DECL|function|idefloppy_capacity
r_static
id|sector_t
id|idefloppy_capacity
(paren
id|ide_drive_t
op_star
id|drive
)paren
(brace
id|idefloppy_floppy_t
op_star
id|floppy
op_assign
id|drive-&gt;driver_data
suffix:semicolon
r_int
r_int
id|capacity
op_assign
id|floppy-&gt;blocks
op_star
id|floppy-&gt;bs_factor
suffix:semicolon
r_return
id|capacity
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;idefloppy_identify_device checks if we can support a drive,&n; *&t;based on the ATAPI IDENTIFY command results.&n; */
DECL|function|idefloppy_identify_device
r_static
r_int
id|idefloppy_identify_device
(paren
id|ide_drive_t
op_star
id|drive
comma
r_struct
id|hd_driveid
op_star
id|id
)paren
(brace
r_struct
id|idefloppy_id_gcw
id|gcw
suffix:semicolon
macro_line|#if IDEFLOPPY_DEBUG_INFO
id|u16
id|mask
comma
id|i
suffix:semicolon
r_char
id|buffer
(braket
l_int|80
)braket
suffix:semicolon
macro_line|#endif /* IDEFLOPPY_DEBUG_INFO */
op_star
(paren
(paren
id|u16
op_star
)paren
op_amp
id|gcw
)paren
op_assign
id|id-&gt;config
suffix:semicolon
macro_line|#ifdef CONFIG_PPC
multiline_comment|/* kludge for Apple PowerBook internal zip */
r_if
c_cond
(paren
(paren
id|gcw.device_type
op_eq
l_int|5
)paren
op_logical_and
op_logical_neg
id|strstr
c_func
(paren
id|id-&gt;model
comma
l_string|&quot;CD-ROM&quot;
)paren
op_logical_and
id|strstr
c_func
(paren
id|id-&gt;model
comma
l_string|&quot;ZIP&quot;
)paren
)paren
id|gcw.device_type
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
macro_line|#if IDEFLOPPY_DEBUG_INFO
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Dumping ATAPI Identify Device floppy parameters&bslash;n&quot;
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|gcw.protocol
)paren
(brace
r_case
l_int|0
suffix:colon
r_case
l_int|1
suffix:colon
id|sprintf
c_func
(paren
id|buffer
comma
l_string|&quot;ATA&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|sprintf
c_func
(paren
id|buffer
comma
l_string|&quot;ATAPI&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
id|sprintf
c_func
(paren
id|buffer
comma
l_string|&quot;Reserved (Unknown to ide-floppy)&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Protocol Type: %s&bslash;n&quot;
comma
id|buffer
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|gcw.device_type
)paren
(brace
r_case
l_int|0
suffix:colon
id|sprintf
c_func
(paren
id|buffer
comma
l_string|&quot;Direct-access Device&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|sprintf
c_func
(paren
id|buffer
comma
l_string|&quot;Streaming Tape Device&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
r_case
l_int|3
suffix:colon
r_case
l_int|4
suffix:colon
id|sprintf
(paren
id|buffer
comma
l_string|&quot;Reserved&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|5
suffix:colon
id|sprintf
c_func
(paren
id|buffer
comma
l_string|&quot;CD-ROM Device&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|6
suffix:colon
id|sprintf
c_func
(paren
id|buffer
comma
l_string|&quot;Reserved&quot;
)paren
suffix:semicolon
r_case
l_int|7
suffix:colon
id|sprintf
c_func
(paren
id|buffer
comma
l_string|&quot;Optical memory Device&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x1f
suffix:colon
id|sprintf
c_func
(paren
id|buffer
comma
l_string|&quot;Unknown or no Device type&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|sprintf
c_func
(paren
id|buffer
comma
l_string|&quot;Reserved&quot;
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Device Type: %x - %s&bslash;n&quot;
comma
id|gcw.device_type
comma
id|buffer
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Removable: %s&bslash;n&quot;
comma
id|gcw.removable
ques
c_cond
l_string|&quot;Yes&quot;
suffix:colon
l_string|&quot;No&quot;
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|gcw.drq_type
)paren
(brace
r_case
l_int|0
suffix:colon
id|sprintf
c_func
(paren
id|buffer
comma
l_string|&quot;Microprocessor DRQ&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|sprintf
c_func
(paren
id|buffer
comma
l_string|&quot;Interrupt DRQ&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|sprintf
c_func
(paren
id|buffer
comma
l_string|&quot;Accelerated DRQ&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
id|sprintf
c_func
(paren
id|buffer
comma
l_string|&quot;Reserved&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Command Packet DRQ Type: %s&bslash;n&quot;
comma
id|buffer
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|gcw.packet_size
)paren
(brace
r_case
l_int|0
suffix:colon
id|sprintf
c_func
(paren
id|buffer
comma
l_string|&quot;12 bytes&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|sprintf
c_func
(paren
id|buffer
comma
l_string|&quot;16 bytes&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|sprintf
c_func
(paren
id|buffer
comma
l_string|&quot;Reserved&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Command Packet Size: %s&bslash;n&quot;
comma
id|buffer
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Model: %.40s&bslash;n&quot;
comma
id|id-&gt;model
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Firmware Revision: %.8s&bslash;n&quot;
comma
id|id-&gt;fw_rev
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Serial Number: %.20s&bslash;n&quot;
comma
id|id-&gt;serial_no
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Write buffer size(?): %d bytes&bslash;n&quot;
comma
id|id-&gt;buf_size
op_star
l_int|512
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;DMA: %s&quot;
comma
id|id-&gt;capability
op_amp
l_int|0x01
ques
c_cond
l_string|&quot;Yes&bslash;n&quot;
suffix:colon
l_string|&quot;No&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;LBA: %s&quot;
comma
id|id-&gt;capability
op_amp
l_int|0x02
ques
c_cond
l_string|&quot;Yes&bslash;n&quot;
suffix:colon
l_string|&quot;No&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;IORDY can be disabled: %s&quot;
comma
id|id-&gt;capability
op_amp
l_int|0x04
ques
c_cond
l_string|&quot;Yes&bslash;n&quot;
suffix:colon
l_string|&quot;No&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;IORDY supported: %s&quot;
comma
id|id-&gt;capability
op_amp
l_int|0x08
ques
c_cond
l_string|&quot;Yes&bslash;n&quot;
suffix:colon
l_string|&quot;Unknown&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;ATAPI overlap supported: %s&quot;
comma
id|id-&gt;capability
op_amp
l_int|0x20
ques
c_cond
l_string|&quot;Yes&bslash;n&quot;
suffix:colon
l_string|&quot;No&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;PIO Cycle Timing Category: %d&bslash;n&quot;
comma
id|id-&gt;tPIO
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;DMA Cycle Timing Category: %d&bslash;n&quot;
comma
id|id-&gt;tDMA
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Single Word DMA supported modes:&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|mask
op_assign
l_int|1
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
comma
id|mask
op_assign
id|mask
op_lshift
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|id-&gt;dma_1word
op_amp
id|mask
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;   Mode %d%s&bslash;n&quot;
comma
id|i
comma
(paren
id|id-&gt;dma_1word
op_amp
(paren
id|mask
op_lshift
l_int|8
)paren
)paren
ques
c_cond
l_string|&quot; (active)&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Multi Word DMA supported modes:&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|mask
op_assign
l_int|1
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
comma
id|mask
op_assign
id|mask
op_lshift
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|id-&gt;dma_mword
op_amp
id|mask
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;   Mode %d%s&bslash;n&quot;
comma
id|i
comma
(paren
id|id-&gt;dma_mword
op_amp
(paren
id|mask
op_lshift
l_int|8
)paren
)paren
ques
c_cond
l_string|&quot; (active)&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|id-&gt;field_valid
op_amp
l_int|0x0002
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Enhanced PIO Modes: %s&bslash;n&quot;
comma
id|id-&gt;eide_pio_modes
op_amp
l_int|1
ques
c_cond
l_string|&quot;Mode 3&quot;
suffix:colon
l_string|&quot;None&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|id-&gt;eide_dma_min
op_eq
l_int|0
)paren
id|sprintf
c_func
(paren
id|buffer
comma
l_string|&quot;Not supported&quot;
)paren
suffix:semicolon
r_else
id|sprintf
c_func
(paren
id|buffer
comma
l_string|&quot;%d ns&quot;
comma
id|id-&gt;eide_dma_min
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Minimum Multi-word DMA cycle per word: %s&bslash;n&quot;
comma
id|buffer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|id-&gt;eide_dma_time
op_eq
l_int|0
)paren
id|sprintf
c_func
(paren
id|buffer
comma
l_string|&quot;Not supported&quot;
)paren
suffix:semicolon
r_else
id|sprintf
c_func
(paren
id|buffer
comma
l_string|&quot;%d ns&quot;
comma
id|id-&gt;eide_dma_time
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Manufacturer&bslash;&squot;s Recommended Multi-word cycle: %s&bslash;n&quot;
comma
id|buffer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|id-&gt;eide_pio
op_eq
l_int|0
)paren
id|sprintf
c_func
(paren
id|buffer
comma
l_string|&quot;Not supported&quot;
)paren
suffix:semicolon
r_else
id|sprintf
c_func
(paren
id|buffer
comma
l_string|&quot;%d ns&quot;
comma
id|id-&gt;eide_pio
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Minimum PIO cycle without IORDY: %s&bslash;n&quot;
comma
id|buffer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|id-&gt;eide_pio_iordy
op_eq
l_int|0
)paren
id|sprintf
c_func
(paren
id|buffer
comma
l_string|&quot;Not supported&quot;
)paren
suffix:semicolon
r_else
id|sprintf
c_func
(paren
id|buffer
comma
l_string|&quot;%d ns&quot;
comma
id|id-&gt;eide_pio_iordy
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Minimum PIO cycle with IORDY: %s&bslash;n&quot;
comma
id|buffer
)paren
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;According to the device, fields 64-70 are not valid.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif /* IDEFLOPPY_DEBUG_INFO */
r_if
c_cond
(paren
id|gcw.protocol
op_ne
l_int|2
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ide-floppy: Protocol is not ATAPI&bslash;n&quot;
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|gcw.device_type
op_ne
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ide-floppy: Device type is not set to floppy&bslash;n&quot;
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|gcw.removable
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ide-floppy: The removable flag is not set&bslash;n&quot;
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|gcw.drq_type
op_eq
l_int|3
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ide-floppy: Sorry, DRQ type %d not supported&bslash;n&quot;
comma
id|gcw.drq_type
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|gcw.packet_size
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ide-floppy: Packet size is not 12 bytes long&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
r_return
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|idefloppy_add_settings
r_static
r_void
id|idefloppy_add_settings
c_func
(paren
id|ide_drive_t
op_star
id|drive
)paren
(brace
id|idefloppy_floppy_t
op_star
id|floppy
op_assign
id|drive-&gt;driver_data
suffix:semicolon
multiline_comment|/*&n; *&t;&t;&t;drive&t;setting name&t;read/write&t;ioctl&t;ioctl&t;&t;data type&t;min&t;max&t;mul_factor&t;div_factor&t;data pointer&t;&t;set function&n; */
id|ide_add_setting
c_func
(paren
id|drive
comma
l_string|&quot;bios_cyl&quot;
comma
id|SETTING_RW
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
id|TYPE_INT
comma
l_int|0
comma
l_int|1023
comma
l_int|1
comma
l_int|1
comma
op_amp
id|drive-&gt;bios_cyl
comma
l_int|NULL
)paren
suffix:semicolon
id|ide_add_setting
c_func
(paren
id|drive
comma
l_string|&quot;bios_head&quot;
comma
id|SETTING_RW
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
id|TYPE_BYTE
comma
l_int|0
comma
l_int|255
comma
l_int|1
comma
l_int|1
comma
op_amp
id|drive-&gt;bios_head
comma
l_int|NULL
)paren
suffix:semicolon
id|ide_add_setting
c_func
(paren
id|drive
comma
l_string|&quot;bios_sect&quot;
comma
id|SETTING_RW
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
id|TYPE_BYTE
comma
l_int|0
comma
l_int|63
comma
l_int|1
comma
l_int|1
comma
op_amp
id|drive-&gt;bios_sect
comma
l_int|NULL
)paren
suffix:semicolon
id|ide_add_setting
c_func
(paren
id|drive
comma
l_string|&quot;ticks&quot;
comma
id|SETTING_RW
comma
op_minus
l_int|1
comma
op_minus
l_int|1
comma
id|TYPE_BYTE
comma
l_int|0
comma
l_int|255
comma
l_int|1
comma
l_int|1
comma
op_amp
id|floppy-&gt;ticks
comma
l_int|NULL
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Driver initialization.&n; */
DECL|function|idefloppy_setup
r_static
r_void
id|idefloppy_setup
(paren
id|ide_drive_t
op_star
id|drive
comma
id|idefloppy_floppy_t
op_star
id|floppy
)paren
(brace
r_struct
id|idefloppy_id_gcw
id|gcw
suffix:semicolon
op_star
(paren
(paren
id|u16
op_star
)paren
op_amp
id|gcw
)paren
op_assign
id|drive-&gt;id-&gt;config
suffix:semicolon
id|drive-&gt;driver_data
op_assign
id|floppy
suffix:semicolon
id|drive-&gt;ready_stat
op_assign
l_int|0
suffix:semicolon
id|memset
c_func
(paren
id|floppy
comma
l_int|0
comma
r_sizeof
(paren
id|idefloppy_floppy_t
)paren
)paren
suffix:semicolon
id|floppy-&gt;drive
op_assign
id|drive
suffix:semicolon
id|floppy-&gt;pc
op_assign
id|floppy-&gt;pc_stack
suffix:semicolon
r_if
c_cond
(paren
id|gcw.drq_type
op_eq
l_int|1
)paren
id|set_bit
c_func
(paren
id|IDEFLOPPY_DRQ_INTERRUPT
comma
op_amp
id|floppy-&gt;flags
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;We used to check revisions here. At this point however&n;&t; *&t;I&squot;m giving up. Just assume they are all broken, its easier.&n;&t; *&n;&t; *&t;The actual reason for the workarounds was likely&n;&t; *&t;a driver bug after all rather than a firmware bug,&n;&t; *&t;and the workaround below used to hide it. It should&n;&t; *&t;be fixed as of version 1.9, but to be on the safe side&n;&t; *&t;we&squot;ll leave the limitation below for the 2.2.x tree.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|drive-&gt;id-&gt;model
comma
l_string|&quot;IOMEGA ZIP 100 ATAPI&quot;
comma
l_int|20
)paren
)paren
(brace
id|set_bit
c_func
(paren
id|IDEFLOPPY_ZIP_DRIVE
comma
op_amp
id|floppy-&gt;flags
)paren
suffix:semicolon
multiline_comment|/* This value will be visible in the /proc/ide/hdx/settings */
id|floppy-&gt;ticks
op_assign
id|IDEFLOPPY_TICKS_DELAY
suffix:semicolon
id|blk_queue_max_sectors
c_func
(paren
id|drive-&gt;queue
comma
l_int|64
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t;*      Guess what?  The IOMEGA Clik! drive also needs the&n;&t;*      above fix.  It makes nasty clicking noises without&n;&t;*      it, so please don&squot;t remove this.&n;&t;*/
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|drive-&gt;id-&gt;model
comma
l_string|&quot;IOMEGA Clik!&quot;
comma
l_int|11
)paren
op_eq
l_int|0
)paren
(brace
id|blk_queue_max_sectors
c_func
(paren
id|drive-&gt;queue
comma
l_int|64
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|IDEFLOPPY_CLIK_DRIVE
comma
op_amp
id|floppy-&gt;flags
)paren
suffix:semicolon
)brace
(paren
r_void
)paren
id|idefloppy_get_capacity
c_func
(paren
id|drive
)paren
suffix:semicolon
id|idefloppy_add_settings
c_func
(paren
id|drive
)paren
suffix:semicolon
)brace
DECL|function|idefloppy_cleanup
r_static
r_int
id|idefloppy_cleanup
(paren
id|ide_drive_t
op_star
id|drive
)paren
(brace
id|idefloppy_floppy_t
op_star
id|floppy
op_assign
id|drive-&gt;driver_data
suffix:semicolon
r_struct
id|gendisk
op_star
id|g
op_assign
id|drive-&gt;disk
suffix:semicolon
r_if
c_cond
(paren
id|ide_unregister_subdriver
c_func
(paren
id|drive
)paren
)paren
r_return
l_int|1
suffix:semicolon
id|drive-&gt;driver_data
op_assign
l_int|NULL
suffix:semicolon
id|kfree
c_func
(paren
id|floppy
)paren
suffix:semicolon
id|del_gendisk
c_func
(paren
id|g
)paren
suffix:semicolon
id|g-&gt;fops
op_assign
id|ide_fops
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_PROC_FS
DECL|variable|idefloppy_proc
r_static
id|ide_proc_entry_t
id|idefloppy_proc
(braket
)braket
op_assign
(brace
(brace
l_string|&quot;geometry&quot;
comma
id|S_IFREG
op_or
id|S_IRUGO
comma
id|proc_ide_read_geometry
comma
l_int|NULL
)brace
comma
(brace
l_int|NULL
comma
l_int|0
comma
l_int|NULL
comma
l_int|NULL
)brace
)brace
suffix:semicolon
macro_line|#else
DECL|macro|idefloppy_proc
mdefine_line|#define&t;idefloppy_proc&t;NULL
macro_line|#endif&t;/* CONFIG_PROC_FS */
r_static
r_int
id|idefloppy_attach
c_func
(paren
id|ide_drive_t
op_star
id|drive
)paren
suffix:semicolon
multiline_comment|/*&n; *&t;IDE subdriver functions, registered with ide.c&n; */
DECL|variable|idefloppy_driver
r_static
id|ide_driver_t
id|idefloppy_driver
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|name
op_assign
l_string|&quot;ide-floppy&quot;
comma
dot
id|version
op_assign
id|IDEFLOPPY_VERSION
comma
dot
id|media
op_assign
id|ide_floppy
comma
dot
id|busy
op_assign
l_int|0
comma
dot
id|supports_dsc_overlap
op_assign
l_int|0
comma
dot
id|cleanup
op_assign
id|idefloppy_cleanup
comma
dot
id|do_request
op_assign
id|idefloppy_do_request
comma
dot
id|end_request
op_assign
id|idefloppy_do_end_request
comma
dot
id|capacity
op_assign
id|idefloppy_capacity
comma
dot
id|proc
op_assign
id|idefloppy_proc
comma
dot
id|attach
op_assign
id|idefloppy_attach
comma
dot
id|drives
op_assign
id|LIST_HEAD_INIT
c_func
(paren
id|idefloppy_driver.drives
)paren
comma
)brace
suffix:semicolon
DECL|function|idefloppy_open
r_static
r_int
id|idefloppy_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
id|ide_drive_t
op_star
id|drive
op_assign
id|inode-&gt;i_bdev-&gt;bd_disk-&gt;private_data
suffix:semicolon
id|idefloppy_floppy_t
op_star
id|floppy
op_assign
id|drive-&gt;driver_data
suffix:semicolon
id|idefloppy_pc_t
id|pc
suffix:semicolon
id|drive-&gt;usage
op_increment
suffix:semicolon
id|debug_log
c_func
(paren
id|KERN_INFO
l_string|&quot;Reached idefloppy_open&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|drive-&gt;usage
op_eq
l_int|1
)paren
(brace
id|clear_bit
c_func
(paren
id|IDEFLOPPY_FORMAT_IN_PROGRESS
comma
op_amp
id|floppy-&gt;flags
)paren
suffix:semicolon
multiline_comment|/* Just in case */
id|idefloppy_create_test_unit_ready_cmd
c_func
(paren
op_amp
id|pc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|idefloppy_queue_pc_tail
c_func
(paren
id|drive
comma
op_amp
id|pc
)paren
)paren
(brace
id|idefloppy_create_start_stop_cmd
c_func
(paren
op_amp
id|pc
comma
l_int|1
)paren
suffix:semicolon
(paren
r_void
)paren
id|idefloppy_queue_pc_tail
c_func
(paren
id|drive
comma
op_amp
id|pc
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|idefloppy_get_capacity
(paren
id|drive
)paren
op_logical_and
(paren
id|filp-&gt;f_flags
op_amp
id|O_NDELAY
)paren
op_eq
l_int|0
multiline_comment|/*&n;&t;&t;    ** Allow O_NDELAY to open a drive without a disk, or with&n;&t;&t;    ** an unreadable disk, so that we can get the format&n;&t;&t;    ** capacity of the drive or begin the format - Sam&n;&t;&t;    */
)paren
(brace
id|drive-&gt;usage
op_decrement
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_if
c_cond
(paren
id|floppy-&gt;wp
op_logical_and
(paren
id|filp-&gt;f_mode
op_amp
l_int|2
)paren
)paren
(brace
id|drive-&gt;usage
op_decrement
suffix:semicolon
r_return
op_minus
id|EROFS
suffix:semicolon
)brace
id|set_bit
c_func
(paren
id|IDEFLOPPY_MEDIA_CHANGED
comma
op_amp
id|floppy-&gt;flags
)paren
suffix:semicolon
multiline_comment|/* IOMEGA Clik! drives do not support lock/unlock commands */
r_if
c_cond
(paren
op_logical_neg
id|test_bit
c_func
(paren
id|IDEFLOPPY_CLIK_DRIVE
comma
op_amp
id|floppy-&gt;flags
)paren
)paren
(brace
id|idefloppy_create_prevent_cmd
c_func
(paren
op_amp
id|pc
comma
l_int|1
)paren
suffix:semicolon
(paren
r_void
)paren
id|idefloppy_queue_pc_tail
c_func
(paren
id|drive
comma
op_amp
id|pc
)paren
suffix:semicolon
)brace
id|check_disk_change
c_func
(paren
id|inode-&gt;i_bdev
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|IDEFLOPPY_FORMAT_IN_PROGRESS
comma
op_amp
id|floppy-&gt;flags
)paren
)paren
(brace
id|drive-&gt;usage
op_decrement
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|idefloppy_release
r_static
r_int
id|idefloppy_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
id|ide_drive_t
op_star
id|drive
op_assign
id|inode-&gt;i_bdev-&gt;bd_disk-&gt;private_data
suffix:semicolon
id|idefloppy_pc_t
id|pc
suffix:semicolon
id|debug_log
c_func
(paren
id|KERN_INFO
l_string|&quot;Reached idefloppy_release&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|drive-&gt;usage
op_eq
l_int|1
)paren
(brace
id|idefloppy_floppy_t
op_star
id|floppy
op_assign
id|drive-&gt;driver_data
suffix:semicolon
multiline_comment|/* IOMEGA Clik! drives do not support lock/unlock commands */
r_if
c_cond
(paren
op_logical_neg
id|test_bit
c_func
(paren
id|IDEFLOPPY_CLIK_DRIVE
comma
op_amp
id|floppy-&gt;flags
)paren
)paren
(brace
id|idefloppy_create_prevent_cmd
c_func
(paren
op_amp
id|pc
comma
l_int|0
)paren
suffix:semicolon
(paren
r_void
)paren
id|idefloppy_queue_pc_tail
c_func
(paren
id|drive
comma
op_amp
id|pc
)paren
suffix:semicolon
)brace
id|clear_bit
c_func
(paren
id|IDEFLOPPY_FORMAT_IN_PROGRESS
comma
op_amp
id|floppy-&gt;flags
)paren
suffix:semicolon
)brace
id|drive-&gt;usage
op_decrement
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|idefloppy_ioctl
r_static
r_int
id|idefloppy_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_struct
id|block_device
op_star
id|bdev
op_assign
id|inode-&gt;i_bdev
suffix:semicolon
id|ide_drive_t
op_star
id|drive
op_assign
id|bdev-&gt;bd_disk-&gt;private_data
suffix:semicolon
id|idefloppy_floppy_t
op_star
id|floppy
op_assign
id|drive-&gt;driver_data
suffix:semicolon
r_void
id|__user
op_star
id|argp
op_assign
(paren
r_void
id|__user
op_star
)paren
id|arg
suffix:semicolon
r_int
id|err
op_assign
id|generic_ide_ioctl
c_func
(paren
id|file
comma
id|bdev
comma
id|cmd
comma
id|arg
)paren
suffix:semicolon
r_int
id|prevent
op_assign
(paren
id|arg
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|idefloppy_pc_t
id|pc
suffix:semicolon
r_if
c_cond
(paren
id|err
op_ne
op_minus
id|EINVAL
)paren
r_return
id|err
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|CDROMEJECT
suffix:colon
id|prevent
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* fall through */
r_case
id|CDROM_LOCKDOOR
suffix:colon
r_if
c_cond
(paren
id|drive-&gt;usage
OG
l_int|1
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
multiline_comment|/* The IOMEGA Clik! Drive doesn&squot;t support this command - no room for an eject mechanism */
r_if
c_cond
(paren
op_logical_neg
id|test_bit
c_func
(paren
id|IDEFLOPPY_CLIK_DRIVE
comma
op_amp
id|floppy-&gt;flags
)paren
)paren
(brace
id|idefloppy_create_prevent_cmd
c_func
(paren
op_amp
id|pc
comma
id|prevent
)paren
suffix:semicolon
(paren
r_void
)paren
id|idefloppy_queue_pc_tail
c_func
(paren
id|drive
comma
op_amp
id|pc
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cmd
op_eq
id|CDROMEJECT
)paren
(brace
id|idefloppy_create_start_stop_cmd
c_func
(paren
op_amp
id|pc
comma
l_int|2
)paren
suffix:semicolon
(paren
r_void
)paren
id|idefloppy_queue_pc_tail
c_func
(paren
id|drive
comma
op_amp
id|pc
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
r_case
id|IDEFLOPPY_IOCTL_FORMAT_SUPPORTED
suffix:colon
r_return
l_int|0
suffix:semicolon
r_case
id|IDEFLOPPY_IOCTL_FORMAT_GET_CAPACITY
suffix:colon
r_return
id|idefloppy_get_format_capacities
c_func
(paren
id|drive
comma
id|argp
)paren
suffix:semicolon
r_case
id|IDEFLOPPY_IOCTL_FORMAT_START
suffix:colon
r_if
c_cond
(paren
op_logical_neg
(paren
id|file-&gt;f_mode
op_amp
l_int|2
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
r_if
c_cond
(paren
id|drive-&gt;usage
OG
l_int|1
)paren
(brace
multiline_comment|/* Don&squot;t format if someone is using the disk */
id|clear_bit
c_func
(paren
id|IDEFLOPPY_FORMAT_IN_PROGRESS
comma
op_amp
id|floppy-&gt;flags
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|set_bit
c_func
(paren
id|IDEFLOPPY_FORMAT_IN_PROGRESS
comma
op_amp
id|floppy-&gt;flags
)paren
suffix:semicolon
id|err
op_assign
id|idefloppy_begin_format
c_func
(paren
id|drive
comma
id|argp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
id|clear_bit
c_func
(paren
id|IDEFLOPPY_FORMAT_IN_PROGRESS
comma
op_amp
id|floppy-&gt;flags
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
multiline_comment|/*&n;&t;&t;** Note, the bit will be cleared when the device is&n;&t;&t;** closed.  This is the cleanest way to handle the&n;&t;&t;** situation where the drive does not support&n;&t;&t;** format progress reporting.&n;&t;&t;*/
r_case
id|IDEFLOPPY_IOCTL_FORMAT_GET_PROGRESS
suffix:colon
r_return
id|idefloppy_get_format_progress
c_func
(paren
id|drive
comma
id|argp
)paren
suffix:semicolon
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|idefloppy_media_changed
r_static
r_int
id|idefloppy_media_changed
c_func
(paren
r_struct
id|gendisk
op_star
id|disk
)paren
(brace
id|ide_drive_t
op_star
id|drive
op_assign
id|disk-&gt;private_data
suffix:semicolon
id|idefloppy_floppy_t
op_star
id|floppy
op_assign
id|drive-&gt;driver_data
suffix:semicolon
multiline_comment|/* do not scan partitions twice if this is a removable device */
r_if
c_cond
(paren
id|drive-&gt;attach
)paren
(brace
id|drive-&gt;attach
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
id|test_and_clear_bit
c_func
(paren
id|IDEFLOPPY_MEDIA_CHANGED
comma
op_amp
id|floppy-&gt;flags
)paren
suffix:semicolon
)brace
DECL|function|idefloppy_revalidate_disk
r_static
r_int
id|idefloppy_revalidate_disk
c_func
(paren
r_struct
id|gendisk
op_star
id|disk
)paren
(brace
id|ide_drive_t
op_star
id|drive
op_assign
id|disk-&gt;private_data
suffix:semicolon
id|set_capacity
c_func
(paren
id|disk
comma
id|idefloppy_capacity
c_func
(paren
id|drive
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|idefloppy_ops
r_static
r_struct
id|block_device_operations
id|idefloppy_ops
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|open
op_assign
id|idefloppy_open
comma
dot
id|release
op_assign
id|idefloppy_release
comma
dot
id|ioctl
op_assign
id|idefloppy_ioctl
comma
dot
id|media_changed
op_assign
id|idefloppy_media_changed
comma
dot
id|revalidate_disk
op_assign
id|idefloppy_revalidate_disk
)brace
suffix:semicolon
DECL|function|idefloppy_attach
r_static
r_int
id|idefloppy_attach
(paren
id|ide_drive_t
op_star
id|drive
)paren
(brace
id|idefloppy_floppy_t
op_star
id|floppy
suffix:semicolon
r_struct
id|gendisk
op_star
id|g
op_assign
id|drive-&gt;disk
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strstr
c_func
(paren
l_string|&quot;ide-floppy&quot;
comma
id|drive-&gt;driver_req
)paren
)paren
r_goto
id|failed
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|drive-&gt;present
)paren
r_goto
id|failed
suffix:semicolon
r_if
c_cond
(paren
id|drive-&gt;media
op_ne
id|ide_floppy
)paren
r_goto
id|failed
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|idefloppy_identify_device
(paren
id|drive
comma
id|drive-&gt;id
)paren
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;ide-floppy: %s: not supported by this version of ide-floppy&bslash;n&quot;
comma
id|drive-&gt;name
)paren
suffix:semicolon
r_goto
id|failed
suffix:semicolon
)brace
r_if
c_cond
(paren
id|drive-&gt;scsi
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ide-floppy: passing drive %s to ide-scsi emulation.&bslash;n&quot;
comma
id|drive-&gt;name
)paren
suffix:semicolon
r_goto
id|failed
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|floppy
op_assign
(paren
id|idefloppy_floppy_t
op_star
)paren
id|kmalloc
(paren
r_sizeof
(paren
id|idefloppy_floppy_t
)paren
comma
id|GFP_KERNEL
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;ide-floppy: %s: Can&squot;t allocate a floppy structure&bslash;n&quot;
comma
id|drive-&gt;name
)paren
suffix:semicolon
r_goto
id|failed
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ide_register_subdriver
c_func
(paren
id|drive
comma
op_amp
id|idefloppy_driver
)paren
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;ide-floppy: %s: Failed to register the driver with ide.c&bslash;n&quot;
comma
id|drive-&gt;name
)paren
suffix:semicolon
id|kfree
(paren
id|floppy
)paren
suffix:semicolon
r_goto
id|failed
suffix:semicolon
)brace
id|DRIVER
c_func
(paren
id|drive
)paren
op_member_access_from_pointer
id|busy
op_increment
suffix:semicolon
id|idefloppy_setup
(paren
id|drive
comma
id|floppy
)paren
suffix:semicolon
id|DRIVER
c_func
(paren
id|drive
)paren
op_member_access_from_pointer
id|busy
op_decrement
suffix:semicolon
id|g-&gt;minors
op_assign
l_int|1
op_lshift
id|PARTN_BITS
suffix:semicolon
id|g-&gt;driverfs_dev
op_assign
op_amp
id|drive-&gt;gendev
suffix:semicolon
id|strcpy
c_func
(paren
id|g-&gt;devfs_name
comma
id|drive-&gt;devfs_name
)paren
suffix:semicolon
id|g-&gt;flags
op_assign
id|drive-&gt;removable
ques
c_cond
id|GENHD_FL_REMOVABLE
suffix:colon
l_int|0
suffix:semicolon
id|g-&gt;fops
op_assign
op_amp
id|idefloppy_ops
suffix:semicolon
id|drive-&gt;attach
op_assign
l_int|1
suffix:semicolon
id|add_disk
c_func
(paren
id|g
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|failed
suffix:colon
r_return
l_int|1
suffix:semicolon
)brace
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;ATAPI FLOPPY Driver&quot;
)paren
suffix:semicolon
DECL|function|idefloppy_exit
r_static
r_void
id|__exit
id|idefloppy_exit
(paren
r_void
)paren
(brace
id|ide_unregister_driver
c_func
(paren
op_amp
id|idefloppy_driver
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;idefloppy_init will register the driver for each floppy.&n; */
DECL|function|idefloppy_init
r_static
r_int
id|idefloppy_init
(paren
r_void
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ide-floppy driver &quot;
id|IDEFLOPPY_VERSION
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|ide_register_driver
c_func
(paren
op_amp
id|idefloppy_driver
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|idefloppy_init
id|module_init
c_func
(paren
id|idefloppy_init
)paren
suffix:semicolon
DECL|variable|idefloppy_exit
id|module_exit
c_func
(paren
id|idefloppy_exit
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
eof
