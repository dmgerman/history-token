multiline_comment|/*&n; * linux/drivers/ide/arm/icside.c&n; *&n; * Copyright (c) 1996-2003 Russell King.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/blkdev.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/hdreg.h&gt;
macro_line|#include &lt;linux/ide.h&gt;
macro_line|#include &lt;linux/dma-mapping.h&gt;
macro_line|#include &lt;linux/device.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/scatterlist.h&gt;
macro_line|#include &lt;asm/dma.h&gt;
macro_line|#include &lt;asm/ecard.h&gt;
macro_line|#include &lt;asm/io.h&gt;
DECL|macro|ICS_IDENT_OFFSET
mdefine_line|#define ICS_IDENT_OFFSET&t;&t;0x2280
DECL|macro|ICS_ARCIN_V5_INTRSTAT
mdefine_line|#define ICS_ARCIN_V5_INTRSTAT&t;&t;0x000
DECL|macro|ICS_ARCIN_V5_INTROFFSET
mdefine_line|#define ICS_ARCIN_V5_INTROFFSET&t;&t;0x001
DECL|macro|ICS_ARCIN_V5_IDEOFFSET
mdefine_line|#define ICS_ARCIN_V5_IDEOFFSET&t;&t;0xa00
DECL|macro|ICS_ARCIN_V5_IDEALTOFFSET
mdefine_line|#define ICS_ARCIN_V5_IDEALTOFFSET&t;0xae0
DECL|macro|ICS_ARCIN_V5_IDESTEPPING
mdefine_line|#define ICS_ARCIN_V5_IDESTEPPING&t;4
DECL|macro|ICS_ARCIN_V6_IDEOFFSET_1
mdefine_line|#define ICS_ARCIN_V6_IDEOFFSET_1&t;0x800
DECL|macro|ICS_ARCIN_V6_INTROFFSET_1
mdefine_line|#define ICS_ARCIN_V6_INTROFFSET_1&t;0x880
DECL|macro|ICS_ARCIN_V6_INTRSTAT_1
mdefine_line|#define ICS_ARCIN_V6_INTRSTAT_1&t;&t;0x8a4
DECL|macro|ICS_ARCIN_V6_IDEALTOFFSET_1
mdefine_line|#define ICS_ARCIN_V6_IDEALTOFFSET_1&t;0x8e0
DECL|macro|ICS_ARCIN_V6_IDEOFFSET_2
mdefine_line|#define ICS_ARCIN_V6_IDEOFFSET_2&t;0xc00
DECL|macro|ICS_ARCIN_V6_INTROFFSET_2
mdefine_line|#define ICS_ARCIN_V6_INTROFFSET_2&t;0xc80
DECL|macro|ICS_ARCIN_V6_INTRSTAT_2
mdefine_line|#define ICS_ARCIN_V6_INTRSTAT_2&t;&t;0xca4
DECL|macro|ICS_ARCIN_V6_IDEALTOFFSET_2
mdefine_line|#define ICS_ARCIN_V6_IDEALTOFFSET_2&t;0xce0
DECL|macro|ICS_ARCIN_V6_IDESTEPPING
mdefine_line|#define ICS_ARCIN_V6_IDESTEPPING&t;4
DECL|struct|cardinfo
r_struct
id|cardinfo
(brace
DECL|member|dataoffset
r_int
r_int
id|dataoffset
suffix:semicolon
DECL|member|ctrloffset
r_int
r_int
id|ctrloffset
suffix:semicolon
DECL|member|stepping
r_int
r_int
id|stepping
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|icside_cardinfo_v5
r_static
r_struct
id|cardinfo
id|icside_cardinfo_v5
op_assign
(brace
id|ICS_ARCIN_V5_IDEOFFSET
comma
id|ICS_ARCIN_V5_IDEALTOFFSET
comma
id|ICS_ARCIN_V5_IDESTEPPING
)brace
suffix:semicolon
DECL|variable|icside_cardinfo_v6_1
r_static
r_struct
id|cardinfo
id|icside_cardinfo_v6_1
op_assign
(brace
id|ICS_ARCIN_V6_IDEOFFSET_1
comma
id|ICS_ARCIN_V6_IDEALTOFFSET_1
comma
id|ICS_ARCIN_V6_IDESTEPPING
)brace
suffix:semicolon
DECL|variable|icside_cardinfo_v6_2
r_static
r_struct
id|cardinfo
id|icside_cardinfo_v6_2
op_assign
(brace
id|ICS_ARCIN_V6_IDEOFFSET_2
comma
id|ICS_ARCIN_V6_IDEALTOFFSET_2
comma
id|ICS_ARCIN_V6_IDESTEPPING
)brace
suffix:semicolon
DECL|struct|icside_state
r_struct
id|icside_state
(brace
DECL|member|channel
r_int
r_int
id|channel
suffix:semicolon
DECL|member|enabled
r_int
r_int
id|enabled
suffix:semicolon
DECL|member|irq_port
r_int
r_int
id|irq_port
suffix:semicolon
DECL|member|slot_port
r_int
r_int
id|slot_port
suffix:semicolon
DECL|member|type
r_int
r_int
id|type
suffix:semicolon
multiline_comment|/* parent device... until the IDE core gets one of its own */
DECL|member|dev
r_struct
id|device
op_star
id|dev
suffix:semicolon
DECL|member|hwif
id|ide_hwif_t
op_star
id|hwif
(braket
l_int|2
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|macro|ICS_TYPE_A3IN
mdefine_line|#define ICS_TYPE_A3IN&t;0
DECL|macro|ICS_TYPE_A3USER
mdefine_line|#define ICS_TYPE_A3USER&t;1
DECL|macro|ICS_TYPE_V6
mdefine_line|#define ICS_TYPE_V6&t;3
DECL|macro|ICS_TYPE_V5
mdefine_line|#define ICS_TYPE_V5&t;15
DECL|macro|ICS_TYPE_NOTYPE
mdefine_line|#define ICS_TYPE_NOTYPE&t;((unsigned int)-1)
multiline_comment|/* ---------------- Version 5 PCB Support Functions --------------------- */
multiline_comment|/* Prototype: icside_irqenable_arcin_v5 (struct expansion_card *ec, int irqnr)&n; * Purpose  : enable interrupts from card&n; */
DECL|function|icside_irqenable_arcin_v5
r_static
r_void
id|icside_irqenable_arcin_v5
(paren
r_struct
id|expansion_card
op_star
id|ec
comma
r_int
id|irqnr
)paren
(brace
r_struct
id|icside_state
op_star
id|state
op_assign
id|ec-&gt;irq_data
suffix:semicolon
r_int
r_int
id|base
op_assign
id|state-&gt;irq_port
suffix:semicolon
id|outb
c_func
(paren
l_int|0
comma
id|base
op_plus
id|ICS_ARCIN_V5_INTROFFSET
)paren
suffix:semicolon
)brace
multiline_comment|/* Prototype: icside_irqdisable_arcin_v5 (struct expansion_card *ec, int irqnr)&n; * Purpose  : disable interrupts from card&n; */
DECL|function|icside_irqdisable_arcin_v5
r_static
r_void
id|icside_irqdisable_arcin_v5
(paren
r_struct
id|expansion_card
op_star
id|ec
comma
r_int
id|irqnr
)paren
(brace
r_struct
id|icside_state
op_star
id|state
op_assign
id|ec-&gt;irq_data
suffix:semicolon
r_int
r_int
id|base
op_assign
id|state-&gt;irq_port
suffix:semicolon
id|inb
c_func
(paren
id|base
op_plus
id|ICS_ARCIN_V5_INTROFFSET
)paren
suffix:semicolon
)brace
DECL|variable|icside_ops_arcin_v5
r_static
r_const
id|expansioncard_ops_t
id|icside_ops_arcin_v5
op_assign
(brace
dot
id|irqenable
op_assign
id|icside_irqenable_arcin_v5
comma
dot
id|irqdisable
op_assign
id|icside_irqdisable_arcin_v5
comma
)brace
suffix:semicolon
multiline_comment|/* ---------------- Version 6 PCB Support Functions --------------------- */
multiline_comment|/* Prototype: icside_irqenable_arcin_v6 (struct expansion_card *ec, int irqnr)&n; * Purpose  : enable interrupts from card&n; */
DECL|function|icside_irqenable_arcin_v6
r_static
r_void
id|icside_irqenable_arcin_v6
(paren
r_struct
id|expansion_card
op_star
id|ec
comma
r_int
id|irqnr
)paren
(brace
r_struct
id|icside_state
op_star
id|state
op_assign
id|ec-&gt;irq_data
suffix:semicolon
r_int
r_int
id|base
op_assign
id|state-&gt;irq_port
suffix:semicolon
id|state-&gt;enabled
op_assign
l_int|1
suffix:semicolon
r_switch
c_cond
(paren
id|state-&gt;channel
)paren
(brace
r_case
l_int|0
suffix:colon
id|outb
c_func
(paren
l_int|0
comma
id|base
op_plus
id|ICS_ARCIN_V6_INTROFFSET_1
)paren
suffix:semicolon
id|inb
c_func
(paren
id|base
op_plus
id|ICS_ARCIN_V6_INTROFFSET_2
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|outb
c_func
(paren
l_int|0
comma
id|base
op_plus
id|ICS_ARCIN_V6_INTROFFSET_2
)paren
suffix:semicolon
id|inb
c_func
(paren
id|base
op_plus
id|ICS_ARCIN_V6_INTROFFSET_1
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* Prototype: icside_irqdisable_arcin_v6 (struct expansion_card *ec, int irqnr)&n; * Purpose  : disable interrupts from card&n; */
DECL|function|icside_irqdisable_arcin_v6
r_static
r_void
id|icside_irqdisable_arcin_v6
(paren
r_struct
id|expansion_card
op_star
id|ec
comma
r_int
id|irqnr
)paren
(brace
r_struct
id|icside_state
op_star
id|state
op_assign
id|ec-&gt;irq_data
suffix:semicolon
id|state-&gt;enabled
op_assign
l_int|0
suffix:semicolon
id|inb
(paren
id|state-&gt;irq_port
op_plus
id|ICS_ARCIN_V6_INTROFFSET_1
)paren
suffix:semicolon
id|inb
(paren
id|state-&gt;irq_port
op_plus
id|ICS_ARCIN_V6_INTROFFSET_2
)paren
suffix:semicolon
)brace
multiline_comment|/* Prototype: icside_irqprobe(struct expansion_card *ec)&n; * Purpose  : detect an active interrupt from card&n; */
DECL|function|icside_irqpending_arcin_v6
r_static
r_int
id|icside_irqpending_arcin_v6
c_func
(paren
r_struct
id|expansion_card
op_star
id|ec
)paren
(brace
r_struct
id|icside_state
op_star
id|state
op_assign
id|ec-&gt;irq_data
suffix:semicolon
r_return
id|inb
c_func
(paren
id|state-&gt;irq_port
op_plus
id|ICS_ARCIN_V6_INTRSTAT_1
)paren
op_amp
l_int|1
op_logical_or
id|inb
c_func
(paren
id|state-&gt;irq_port
op_plus
id|ICS_ARCIN_V6_INTRSTAT_2
)paren
op_amp
l_int|1
suffix:semicolon
)brace
DECL|variable|icside_ops_arcin_v6
r_static
r_const
id|expansioncard_ops_t
id|icside_ops_arcin_v6
op_assign
(brace
dot
id|irqenable
op_assign
id|icside_irqenable_arcin_v6
comma
dot
id|irqdisable
op_assign
id|icside_irqdisable_arcin_v6
comma
dot
id|irqpending
op_assign
id|icside_irqpending_arcin_v6
comma
)brace
suffix:semicolon
multiline_comment|/*&n; * Handle routing of interrupts.  This is called before&n; * we write the command to the drive.&n; */
DECL|function|icside_maskproc
r_static
r_void
id|icside_maskproc
c_func
(paren
id|ide_drive_t
op_star
id|drive
comma
r_int
id|mask
)paren
(brace
id|ide_hwif_t
op_star
id|hwif
op_assign
id|HWIF
c_func
(paren
id|drive
)paren
suffix:semicolon
r_struct
id|icside_state
op_star
id|state
op_assign
id|hwif-&gt;hwif_data
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
id|state-&gt;channel
op_assign
id|hwif-&gt;channel
suffix:semicolon
r_if
c_cond
(paren
id|state-&gt;enabled
op_logical_and
op_logical_neg
id|mask
)paren
(brace
r_switch
c_cond
(paren
id|hwif-&gt;channel
)paren
(brace
r_case
l_int|0
suffix:colon
id|outb
c_func
(paren
l_int|0
comma
id|state-&gt;irq_port
op_plus
id|ICS_ARCIN_V6_INTROFFSET_1
)paren
suffix:semicolon
id|inb
c_func
(paren
id|state-&gt;irq_port
op_plus
id|ICS_ARCIN_V6_INTROFFSET_2
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|outb
c_func
(paren
l_int|0
comma
id|state-&gt;irq_port
op_plus
id|ICS_ARCIN_V6_INTROFFSET_2
)paren
suffix:semicolon
id|inb
c_func
(paren
id|state-&gt;irq_port
op_plus
id|ICS_ARCIN_V6_INTROFFSET_1
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_else
(brace
id|inb
c_func
(paren
id|state-&gt;irq_port
op_plus
id|ICS_ARCIN_V6_INTROFFSET_2
)paren
suffix:semicolon
id|inb
c_func
(paren
id|state-&gt;irq_port
op_plus
id|ICS_ARCIN_V6_INTROFFSET_1
)paren
suffix:semicolon
)brace
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_BLK_DEV_IDEDMA_ICS
multiline_comment|/*&n; * SG-DMA support.&n; *&n; * Similar to the BM-DMA, but we use the RiscPCs IOMD DMA controllers.&n; * There is only one DMA controller per card, which means that only&n; * one drive can be accessed at one time.  NOTE! We do not enforce that&n; * here, but we rely on the main IDE driver spotting that both&n; * interfaces use the same IRQ, which should guarantee this.&n; */
DECL|macro|NR_ENTRIES
mdefine_line|#define NR_ENTRIES 256
DECL|macro|TABLE_SIZE
mdefine_line|#define TABLE_SIZE (NR_ENTRIES * 8)
DECL|function|icside_build_sglist
r_static
r_void
id|icside_build_sglist
c_func
(paren
id|ide_drive_t
op_star
id|drive
comma
r_struct
id|request
op_star
id|rq
)paren
(brace
id|ide_hwif_t
op_star
id|hwif
op_assign
id|drive-&gt;hwif
suffix:semicolon
r_struct
id|icside_state
op_star
id|state
op_assign
id|hwif-&gt;hwif_data
suffix:semicolon
r_struct
id|scatterlist
op_star
id|sg
op_assign
id|hwif-&gt;sg_table
suffix:semicolon
r_int
id|nents
suffix:semicolon
r_if
c_cond
(paren
id|rq-&gt;flags
op_amp
id|REQ_DRIVE_TASKFILE
)paren
(brace
id|ide_task_t
op_star
id|args
op_assign
id|rq-&gt;special
suffix:semicolon
r_if
c_cond
(paren
id|args-&gt;command_type
op_eq
id|IDE_DRIVE_TASK_RAW_WRITE
)paren
id|hwif-&gt;sg_dma_direction
op_assign
id|DMA_TO_DEVICE
suffix:semicolon
r_else
id|hwif-&gt;sg_dma_direction
op_assign
id|DMA_FROM_DEVICE
suffix:semicolon
id|sg_init_one
c_func
(paren
id|sg
comma
id|rq-&gt;buffer
comma
id|rq-&gt;nr_sectors
op_star
id|SECTOR_SIZE
)paren
suffix:semicolon
id|nents
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|nents
op_assign
id|blk_rq_map_sg
c_func
(paren
id|drive-&gt;queue
comma
id|rq
comma
id|sg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rq_data_dir
c_func
(paren
id|rq
)paren
op_eq
id|READ
)paren
id|hwif-&gt;sg_dma_direction
op_assign
id|DMA_FROM_DEVICE
suffix:semicolon
r_else
id|hwif-&gt;sg_dma_direction
op_assign
id|DMA_TO_DEVICE
suffix:semicolon
)brace
id|nents
op_assign
id|dma_map_sg
c_func
(paren
id|state-&gt;dev
comma
id|sg
comma
id|nents
comma
id|hwif-&gt;sg_dma_direction
)paren
suffix:semicolon
id|hwif-&gt;sg_nents
op_assign
id|nents
suffix:semicolon
)brace
multiline_comment|/*&n; * Configure the IOMD to give the appropriate timings for the transfer&n; * mode being requested.  We take the advice of the ATA standards, and&n; * calculate the cycle time based on the transfer mode, and the EIDE&n; * MW DMA specs that the drive provides in the IDENTIFY command.&n; *&n; * We have the following IOMD DMA modes to choose from:&n; *&n; *&t;Type&t;Active&t;&t;Recovery&t;Cycle&n; *&t;A&t;250 (250)&t;312 (550)&t;562 (800)&n; *&t;B&t;187&t;&t;250&t;&t;437&n; *&t;C&t;125 (125)&t;125 (375)&t;250 (500)&n; *&t;D&t;62&t;&t;125&t;&t;187&n; *&n; * (figures in brackets are actual measured timings)&n; *&n; * However, we also need to take care of the read/write active and&n; * recovery timings:&n; *&n; *&t;&t;&t;Read&t;Write&n; *  &t;Mode&t;Active&t;-- Recovery --&t;Cycle&t;IOMD type&n; *&t;MW0&t;215&t;50&t;215&t;480&t;A&n; *&t;MW1&t;80&t;50&t;50&t;150&t;C&n; *&t;MW2&t;70&t;25&t;25&t;120&t;C&n; */
DECL|function|icside_set_speed
r_static
r_int
id|icside_set_speed
c_func
(paren
id|ide_drive_t
op_star
id|drive
comma
id|u8
id|xfer_mode
)paren
(brace
r_int
id|on
op_assign
l_int|0
comma
id|cycle_time
op_assign
l_int|0
comma
id|use_dma_info
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; * Limit the transfer speed to MW_DMA_2.&n;&t; */
r_if
c_cond
(paren
id|xfer_mode
OG
id|XFER_MW_DMA_2
)paren
id|xfer_mode
op_assign
id|XFER_MW_DMA_2
suffix:semicolon
r_switch
c_cond
(paren
id|xfer_mode
)paren
(brace
r_case
id|XFER_MW_DMA_2
suffix:colon
id|cycle_time
op_assign
l_int|250
suffix:semicolon
id|use_dma_info
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|XFER_MW_DMA_1
suffix:colon
id|cycle_time
op_assign
l_int|250
suffix:semicolon
id|use_dma_info
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|XFER_MW_DMA_0
suffix:colon
id|cycle_time
op_assign
l_int|480
suffix:semicolon
r_break
suffix:semicolon
r_case
id|XFER_SW_DMA_2
suffix:colon
r_case
id|XFER_SW_DMA_1
suffix:colon
r_case
id|XFER_SW_DMA_0
suffix:colon
id|cycle_time
op_assign
l_int|480
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * If we&squot;re going to be doing MW_DMA_1 or MW_DMA_2, we should&n;&t; * take care to note the values in the ID...&n;&t; */
r_if
c_cond
(paren
id|use_dma_info
op_logical_and
id|drive-&gt;id-&gt;eide_dma_time
OG
id|cycle_time
)paren
id|cycle_time
op_assign
id|drive-&gt;id-&gt;eide_dma_time
suffix:semicolon
id|drive-&gt;drive_data
op_assign
id|cycle_time
suffix:semicolon
r_if
c_cond
(paren
id|cycle_time
op_logical_and
id|ide_config_drive_speed
c_func
(paren
id|drive
comma
id|xfer_mode
)paren
op_eq
l_int|0
)paren
id|on
op_assign
l_int|1
suffix:semicolon
r_else
id|drive-&gt;drive_data
op_assign
l_int|480
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;%s: %s selected (peak %dMB/s)&bslash;n&quot;
comma
id|drive-&gt;name
comma
id|ide_xfer_verbose
c_func
(paren
id|xfer_mode
)paren
comma
l_int|2000
op_div
id|drive-&gt;drive_data
)paren
suffix:semicolon
id|drive-&gt;current_speed
op_assign
id|xfer_mode
suffix:semicolon
r_return
id|on
suffix:semicolon
)brace
DECL|function|icside_dma_host_off
r_static
r_int
id|icside_dma_host_off
c_func
(paren
id|ide_drive_t
op_star
id|drive
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|icside_dma_off_quietly
r_static
r_int
id|icside_dma_off_quietly
c_func
(paren
id|ide_drive_t
op_star
id|drive
)paren
(brace
id|drive-&gt;using_dma
op_assign
l_int|0
suffix:semicolon
r_return
id|icside_dma_host_off
c_func
(paren
id|drive
)paren
suffix:semicolon
)brace
DECL|function|icside_dma_host_on
r_static
r_int
id|icside_dma_host_on
c_func
(paren
id|ide_drive_t
op_star
id|drive
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|icside_dma_on
r_static
r_int
id|icside_dma_on
c_func
(paren
id|ide_drive_t
op_star
id|drive
)paren
(brace
id|drive-&gt;using_dma
op_assign
l_int|1
suffix:semicolon
r_return
id|icside_dma_host_on
c_func
(paren
id|drive
)paren
suffix:semicolon
)brace
DECL|function|icside_dma_check
r_static
r_int
id|icside_dma_check
c_func
(paren
id|ide_drive_t
op_star
id|drive
)paren
(brace
r_struct
id|hd_driveid
op_star
id|id
op_assign
id|drive-&gt;id
suffix:semicolon
id|ide_hwif_t
op_star
id|hwif
op_assign
id|HWIF
c_func
(paren
id|drive
)paren
suffix:semicolon
r_int
id|xfer_mode
op_assign
id|XFER_PIO_2
suffix:semicolon
r_int
id|on
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|id-&gt;capability
op_amp
l_int|1
)paren
op_logical_or
op_logical_neg
id|hwif-&gt;autodma
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/*&n;&t; * Consult the list of known &quot;bad&quot; drives&n;&t; */
r_if
c_cond
(paren
id|__ide_dma_bad_drive
c_func
(paren
id|drive
)paren
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/*&n;&t; * Enable DMA on any drive that has multiword DMA&n;&t; */
r_if
c_cond
(paren
id|id-&gt;field_valid
op_amp
l_int|2
)paren
(brace
id|xfer_mode
op_assign
id|ide_dma_speed
c_func
(paren
id|drive
comma
l_int|0
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Consult the list of known &quot;good&quot; drives&n;&t; */
r_if
c_cond
(paren
id|__ide_dma_good_drive
c_func
(paren
id|drive
)paren
)paren
(brace
r_if
c_cond
(paren
id|id-&gt;eide_dma_time
OG
l_int|150
)paren
r_goto
id|out
suffix:semicolon
id|xfer_mode
op_assign
id|XFER_MW_DMA_1
suffix:semicolon
)brace
id|out
suffix:colon
id|on
op_assign
id|icside_set_speed
c_func
(paren
id|drive
comma
id|xfer_mode
)paren
suffix:semicolon
r_if
c_cond
(paren
id|on
)paren
r_return
id|icside_dma_on
c_func
(paren
id|drive
)paren
suffix:semicolon
r_else
r_return
id|icside_dma_off_quietly
c_func
(paren
id|drive
)paren
suffix:semicolon
)brace
DECL|function|icside_dma_end
r_static
r_int
id|icside_dma_end
c_func
(paren
id|ide_drive_t
op_star
id|drive
)paren
(brace
id|ide_hwif_t
op_star
id|hwif
op_assign
id|HWIF
c_func
(paren
id|drive
)paren
suffix:semicolon
r_struct
id|icside_state
op_star
id|state
op_assign
id|hwif-&gt;hwif_data
suffix:semicolon
id|drive-&gt;waiting_for_dma
op_assign
l_int|0
suffix:semicolon
id|disable_dma
c_func
(paren
id|hwif-&gt;hw.dma
)paren
suffix:semicolon
multiline_comment|/* Teardown mappings after DMA has completed. */
id|dma_unmap_sg
c_func
(paren
id|state-&gt;dev
comma
id|hwif-&gt;sg_table
comma
id|hwif-&gt;sg_nents
comma
id|hwif-&gt;sg_dma_direction
)paren
suffix:semicolon
r_return
id|get_dma_residue
c_func
(paren
id|hwif-&gt;hw.dma
)paren
op_ne
l_int|0
suffix:semicolon
)brace
DECL|function|icside_dma_begin
r_static
r_int
id|icside_dma_begin
c_func
(paren
id|ide_drive_t
op_star
id|drive
)paren
(brace
id|ide_hwif_t
op_star
id|hwif
op_assign
id|HWIF
c_func
(paren
id|drive
)paren
suffix:semicolon
multiline_comment|/* We can not enable DMA on both channels simultaneously. */
id|BUG_ON
c_func
(paren
id|dma_channel_active
c_func
(paren
id|hwif-&gt;hw.dma
)paren
)paren
suffix:semicolon
id|enable_dma
c_func
(paren
id|hwif-&gt;hw.dma
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * dma_intr() is the handler for disk read/write DMA interrupts&n; */
DECL|function|icside_dmaintr
r_static
id|ide_startstop_t
id|icside_dmaintr
c_func
(paren
id|ide_drive_t
op_star
id|drive
)paren
(brace
r_int
r_int
id|stat
suffix:semicolon
r_int
id|dma_stat
suffix:semicolon
id|dma_stat
op_assign
id|icside_dma_end
c_func
(paren
id|drive
)paren
suffix:semicolon
id|stat
op_assign
id|HWIF
c_func
(paren
id|drive
)paren
op_member_access_from_pointer
id|INB
c_func
(paren
id|IDE_STATUS_REG
)paren
suffix:semicolon
r_if
c_cond
(paren
id|OK_STAT
c_func
(paren
id|stat
comma
id|DRIVE_READY
comma
id|drive-&gt;bad_wstat
op_or
id|DRQ_STAT
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|dma_stat
)paren
(brace
r_struct
id|request
op_star
id|rq
op_assign
id|HWGROUP
c_func
(paren
id|drive
)paren
op_member_access_from_pointer
id|rq
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|rq-&gt;nr_sectors
suffix:semicolon
id|i
OG
l_int|0
suffix:semicolon
)paren
(brace
id|i
op_sub_assign
id|rq-&gt;current_nr_sectors
suffix:semicolon
id|DRIVER
c_func
(paren
id|drive
)paren
op_member_access_from_pointer
id|end_request
c_func
(paren
id|drive
comma
l_int|1
comma
id|rq-&gt;nr_sectors
)paren
suffix:semicolon
)brace
r_return
id|ide_stopped
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: bad DMA status (dma_stat=%x)&bslash;n&quot;
comma
id|drive-&gt;name
comma
id|dma_stat
)paren
suffix:semicolon
)brace
r_return
id|DRIVER
c_func
(paren
id|drive
)paren
op_member_access_from_pointer
id|error
c_func
(paren
id|drive
comma
id|__FUNCTION__
comma
id|stat
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|icside_dma_common
id|icside_dma_common
c_func
(paren
id|ide_drive_t
op_star
id|drive
comma
r_struct
id|request
op_star
id|rq
comma
r_int
r_int
id|dma_mode
)paren
(brace
id|ide_hwif_t
op_star
id|hwif
op_assign
id|HWIF
c_func
(paren
id|drive
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * We can not enable DMA on both channels.&n;&t; */
id|BUG_ON
c_func
(paren
id|dma_channel_active
c_func
(paren
id|hwif-&gt;hw.dma
)paren
)paren
suffix:semicolon
id|icside_build_sglist
c_func
(paren
id|drive
comma
id|rq
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Ensure that we have the right interrupt routed.&n;&t; */
id|icside_maskproc
c_func
(paren
id|drive
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Route the DMA signals to the correct interface.&n;&t; */
id|outb
c_func
(paren
id|hwif-&gt;select_data
comma
id|hwif-&gt;config_data
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Select the correct timing for this drive.&n;&t; */
id|set_dma_speed
c_func
(paren
id|hwif-&gt;hw.dma
comma
id|drive-&gt;drive_data
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Tell the DMA engine about the SG table and&n;&t; * data direction.&n;&t; */
id|set_dma_sg
c_func
(paren
id|hwif-&gt;hw.dma
comma
id|hwif-&gt;sg_table
comma
id|hwif-&gt;sg_nents
)paren
suffix:semicolon
id|set_dma_mode
c_func
(paren
id|hwif-&gt;hw.dma
comma
id|dma_mode
)paren
suffix:semicolon
id|drive-&gt;waiting_for_dma
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|icside_dma_read
r_static
r_int
id|icside_dma_read
c_func
(paren
id|ide_drive_t
op_star
id|drive
)paren
(brace
r_struct
id|request
op_star
id|rq
op_assign
id|HWGROUP
c_func
(paren
id|drive
)paren
op_member_access_from_pointer
id|rq
suffix:semicolon
id|task_ioreg_t
id|cmd
suffix:semicolon
r_if
c_cond
(paren
id|icside_dma_common
c_func
(paren
id|drive
comma
id|rq
comma
id|DMA_MODE_READ
)paren
)paren
r_return
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|drive-&gt;media
op_ne
id|ide_disk
)paren
r_return
l_int|0
suffix:semicolon
id|BUG_ON
c_func
(paren
id|HWGROUP
c_func
(paren
id|drive
)paren
op_member_access_from_pointer
id|handler
op_ne
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * FIX ME to use only ACB ide_task_t args Struct&n;&t; */
macro_line|#if 0
(brace
id|ide_task_t
op_star
id|args
op_assign
id|rq-&gt;special
suffix:semicolon
id|cmd
op_assign
id|args-&gt;tfRegister
(braket
id|IDE_COMMAND_OFFSET
)braket
suffix:semicolon
)brace
macro_line|#else
r_if
c_cond
(paren
id|rq-&gt;flags
op_amp
id|REQ_DRIVE_TASKFILE
)paren
(brace
id|ide_task_t
op_star
id|args
op_assign
id|rq-&gt;special
suffix:semicolon
id|cmd
op_assign
id|args-&gt;tfRegister
(braket
id|IDE_COMMAND_OFFSET
)braket
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|drive-&gt;addressing
op_eq
l_int|1
)paren
(brace
id|cmd
op_assign
id|WIN_READDMA_EXT
suffix:semicolon
)brace
r_else
(brace
id|cmd
op_assign
id|WIN_READDMA
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* issue cmd to drive */
id|ide_execute_command
c_func
(paren
id|drive
comma
id|cmd
comma
id|icside_dmaintr
comma
l_int|2
op_star
id|WAIT_CMD
comma
l_int|NULL
)paren
suffix:semicolon
r_return
id|icside_dma_begin
c_func
(paren
id|drive
)paren
suffix:semicolon
)brace
DECL|function|icside_dma_write
r_static
r_int
id|icside_dma_write
c_func
(paren
id|ide_drive_t
op_star
id|drive
)paren
(brace
r_struct
id|request
op_star
id|rq
op_assign
id|HWGROUP
c_func
(paren
id|drive
)paren
op_member_access_from_pointer
id|rq
suffix:semicolon
id|task_ioreg_t
id|cmd
suffix:semicolon
r_if
c_cond
(paren
id|icside_dma_common
c_func
(paren
id|drive
comma
id|rq
comma
id|DMA_MODE_WRITE
)paren
)paren
r_return
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|drive-&gt;media
op_ne
id|ide_disk
)paren
r_return
l_int|0
suffix:semicolon
id|BUG_ON
c_func
(paren
id|HWGROUP
c_func
(paren
id|drive
)paren
op_member_access_from_pointer
id|handler
op_ne
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * FIX ME to use only ACB ide_task_t args Struct&n;&t; */
macro_line|#if 0
(brace
id|ide_task_t
op_star
id|args
op_assign
id|rq-&gt;special
suffix:semicolon
id|cmd
op_assign
id|args-&gt;tfRegister
(braket
id|IDE_COMMAND_OFFSET
)braket
suffix:semicolon
)brace
macro_line|#else
r_if
c_cond
(paren
id|rq-&gt;flags
op_amp
id|REQ_DRIVE_TASKFILE
)paren
(brace
id|ide_task_t
op_star
id|args
op_assign
id|rq-&gt;special
suffix:semicolon
id|cmd
op_assign
id|args-&gt;tfRegister
(braket
id|IDE_COMMAND_OFFSET
)braket
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|drive-&gt;addressing
op_eq
l_int|1
)paren
(brace
id|cmd
op_assign
id|WIN_WRITEDMA_EXT
suffix:semicolon
)brace
r_else
(brace
id|cmd
op_assign
id|WIN_WRITEDMA
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* issue cmd to drive */
id|ide_execute_command
c_func
(paren
id|drive
comma
id|cmd
comma
id|icside_dmaintr
comma
l_int|2
op_star
id|WAIT_CMD
comma
l_int|NULL
)paren
suffix:semicolon
r_return
id|icside_dma_begin
c_func
(paren
id|drive
)paren
suffix:semicolon
)brace
DECL|function|icside_dma_test_irq
r_static
r_int
id|icside_dma_test_irq
c_func
(paren
id|ide_drive_t
op_star
id|drive
)paren
(brace
id|ide_hwif_t
op_star
id|hwif
op_assign
id|HWIF
c_func
(paren
id|drive
)paren
suffix:semicolon
r_struct
id|icside_state
op_star
id|state
op_assign
id|hwif-&gt;hwif_data
suffix:semicolon
r_return
id|inb
c_func
(paren
id|state-&gt;irq_port
op_plus
(paren
id|hwif-&gt;channel
ques
c_cond
id|ICS_ARCIN_V6_INTRSTAT_2
suffix:colon
id|ICS_ARCIN_V6_INTRSTAT_1
)paren
)paren
op_amp
l_int|1
suffix:semicolon
)brace
DECL|function|icside_dma_verbose
r_static
r_int
id|icside_dma_verbose
c_func
(paren
id|ide_drive_t
op_star
id|drive
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;, %s (peak %dMB/s)&quot;
comma
id|ide_xfer_verbose
c_func
(paren
id|drive-&gt;current_speed
)paren
comma
l_int|2000
op_div
id|drive-&gt;drive_data
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|icside_dma_timeout
r_static
r_int
id|icside_dma_timeout
c_func
(paren
id|ide_drive_t
op_star
id|drive
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: DMA timeout occurred: &quot;
comma
id|drive-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|icside_dma_test_irq
c_func
(paren
id|drive
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|ide_dump_status
c_func
(paren
id|drive
comma
l_string|&quot;DMA timeout&quot;
comma
id|HWIF
c_func
(paren
id|drive
)paren
op_member_access_from_pointer
id|INB
c_func
(paren
id|IDE_STATUS_REG
)paren
)paren
suffix:semicolon
r_return
id|icside_dma_end
c_func
(paren
id|drive
)paren
suffix:semicolon
)brace
DECL|function|icside_dma_lostirq
r_static
r_int
id|icside_dma_lostirq
c_func
(paren
id|ide_drive_t
op_star
id|drive
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: IRQ lost&bslash;n&quot;
comma
id|drive-&gt;name
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|icside_dma_init
r_static
r_int
id|icside_dma_init
c_func
(paren
id|ide_hwif_t
op_star
id|hwif
)paren
(brace
r_int
id|autodma
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef CONFIG_IDEDMA_ICS_AUTO
id|autodma
op_assign
l_int|1
suffix:semicolon
macro_line|#endif
id|printk
c_func
(paren
l_string|&quot;    %s: SG-DMA&quot;
comma
id|hwif-&gt;name
)paren
suffix:semicolon
id|hwif-&gt;sg_table
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|scatterlist
)paren
op_star
id|NR_ENTRIES
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hwif-&gt;sg_table
)paren
r_goto
id|failed
suffix:semicolon
id|hwif-&gt;atapi_dma
op_assign
l_int|1
suffix:semicolon
id|hwif-&gt;mwdma_mask
op_assign
l_int|7
suffix:semicolon
multiline_comment|/* MW0..2 */
id|hwif-&gt;swdma_mask
op_assign
l_int|7
suffix:semicolon
multiline_comment|/* SW0..2 */
id|hwif-&gt;dmatable_cpu
op_assign
l_int|NULL
suffix:semicolon
id|hwif-&gt;dmatable_dma
op_assign
l_int|0
suffix:semicolon
id|hwif-&gt;speedproc
op_assign
id|icside_set_speed
suffix:semicolon
id|hwif-&gt;autodma
op_assign
id|autodma
suffix:semicolon
id|hwif-&gt;ide_dma_check
op_assign
id|icside_dma_check
suffix:semicolon
id|hwif-&gt;ide_dma_host_off
op_assign
id|icside_dma_host_off
suffix:semicolon
id|hwif-&gt;ide_dma_off_quietly
op_assign
id|icside_dma_off_quietly
suffix:semicolon
id|hwif-&gt;ide_dma_host_on
op_assign
id|icside_dma_host_on
suffix:semicolon
id|hwif-&gt;ide_dma_on
op_assign
id|icside_dma_on
suffix:semicolon
id|hwif-&gt;ide_dma_read
op_assign
id|icside_dma_read
suffix:semicolon
id|hwif-&gt;ide_dma_write
op_assign
id|icside_dma_write
suffix:semicolon
id|hwif-&gt;ide_dma_begin
op_assign
id|icside_dma_begin
suffix:semicolon
id|hwif-&gt;ide_dma_end
op_assign
id|icside_dma_end
suffix:semicolon
id|hwif-&gt;ide_dma_test_irq
op_assign
id|icside_dma_test_irq
suffix:semicolon
id|hwif-&gt;ide_dma_verbose
op_assign
id|icside_dma_verbose
suffix:semicolon
id|hwif-&gt;ide_dma_timeout
op_assign
id|icside_dma_timeout
suffix:semicolon
id|hwif-&gt;ide_dma_lostirq
op_assign
id|icside_dma_lostirq
suffix:semicolon
id|hwif-&gt;drives
(braket
l_int|0
)braket
dot
id|autodma
op_assign
id|hwif-&gt;autodma
suffix:semicolon
id|hwif-&gt;drives
(braket
l_int|1
)braket
dot
id|autodma
op_assign
id|hwif-&gt;autodma
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; capable%s&bslash;n&quot;
comma
id|hwif-&gt;autodma
ques
c_cond
l_string|&quot;, auto-enable&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
id|failed
suffix:colon
id|printk
c_func
(paren
l_string|&quot; disabled, unable to allocate DMA table&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|icside_dma_exit
r_static
r_void
id|icside_dma_exit
c_func
(paren
id|ide_hwif_t
op_star
id|hwif
)paren
(brace
r_if
c_cond
(paren
id|hwif-&gt;sg_table
)paren
(brace
id|kfree
c_func
(paren
id|hwif-&gt;sg_table
)paren
suffix:semicolon
id|hwif-&gt;sg_table
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
macro_line|#else
DECL|macro|icside_dma_init
mdefine_line|#define icside_dma_init(hwif)&t;(0)
DECL|macro|icside_dma_exit
mdefine_line|#define icside_dma_exit(hwif)&t;do { } while (0)
macro_line|#endif
DECL|function|icside_find_hwif
r_static
id|ide_hwif_t
op_star
id|icside_find_hwif
c_func
(paren
r_int
r_int
id|dataport
)paren
(brace
id|ide_hwif_t
op_star
id|hwif
suffix:semicolon
r_int
id|index
suffix:semicolon
r_for
c_loop
(paren
id|index
op_assign
l_int|0
suffix:semicolon
id|index
OL
id|MAX_HWIFS
suffix:semicolon
op_increment
id|index
)paren
(brace
id|hwif
op_assign
op_amp
id|ide_hwifs
(braket
id|index
)braket
suffix:semicolon
r_if
c_cond
(paren
id|hwif-&gt;io_ports
(braket
id|IDE_DATA_OFFSET
)braket
op_eq
id|dataport
)paren
r_goto
id|found
suffix:semicolon
)brace
r_for
c_loop
(paren
id|index
op_assign
l_int|0
suffix:semicolon
id|index
OL
id|MAX_HWIFS
suffix:semicolon
op_increment
id|index
)paren
(brace
id|hwif
op_assign
op_amp
id|ide_hwifs
(braket
id|index
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hwif-&gt;io_ports
(braket
id|IDE_DATA_OFFSET
)braket
)paren
r_goto
id|found
suffix:semicolon
)brace
id|hwif
op_assign
l_int|NULL
suffix:semicolon
id|found
suffix:colon
r_return
id|hwif
suffix:semicolon
)brace
r_static
id|ide_hwif_t
op_star
DECL|function|icside_setup
id|icside_setup
c_func
(paren
r_int
r_int
id|base
comma
r_struct
id|cardinfo
op_star
id|info
comma
r_struct
id|expansion_card
op_star
id|ec
)paren
(brace
r_int
r_int
id|port
op_assign
id|base
op_plus
id|info-&gt;dataoffset
suffix:semicolon
id|ide_hwif_t
op_star
id|hwif
suffix:semicolon
id|hwif
op_assign
id|icside_find_hwif
c_func
(paren
id|base
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hwif
)paren
(brace
r_int
id|i
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|hwif-&gt;hw
comma
l_int|0
comma
r_sizeof
(paren
id|hw_regs_t
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|IDE_DATA_OFFSET
suffix:semicolon
id|i
op_le
id|IDE_STATUS_OFFSET
suffix:semicolon
id|i
op_increment
)paren
(brace
id|hwif-&gt;hw.io_ports
(braket
id|i
)braket
op_assign
id|port
suffix:semicolon
id|hwif-&gt;io_ports
(braket
id|i
)braket
op_assign
id|port
suffix:semicolon
id|port
op_add_assign
l_int|1
op_lshift
id|info-&gt;stepping
suffix:semicolon
)brace
id|hwif-&gt;hw.io_ports
(braket
id|IDE_CONTROL_OFFSET
)braket
op_assign
id|base
op_plus
id|info-&gt;ctrloffset
suffix:semicolon
id|hwif-&gt;io_ports
(braket
id|IDE_CONTROL_OFFSET
)braket
op_assign
id|base
op_plus
id|info-&gt;ctrloffset
suffix:semicolon
id|hwif-&gt;hw.irq
op_assign
id|ec-&gt;irq
suffix:semicolon
id|hwif-&gt;irq
op_assign
id|ec-&gt;irq
suffix:semicolon
id|hwif-&gt;noprobe
op_assign
l_int|0
suffix:semicolon
id|hwif-&gt;chipset
op_assign
id|ide_acorn
suffix:semicolon
id|hwif-&gt;gendev.parent
op_assign
op_amp
id|ec-&gt;dev
suffix:semicolon
)brace
r_return
id|hwif
suffix:semicolon
)brace
r_static
r_int
id|__init
DECL|function|icside_register_v5
id|icside_register_v5
c_func
(paren
r_struct
id|icside_state
op_star
id|state
comma
r_struct
id|expansion_card
op_star
id|ec
)paren
(brace
r_int
r_int
id|slot_port
suffix:semicolon
id|ide_hwif_t
op_star
id|hwif
suffix:semicolon
id|slot_port
op_assign
id|ecard_address
c_func
(paren
id|ec
comma
id|ECARD_MEMC
comma
l_int|0
)paren
suffix:semicolon
id|state-&gt;irq_port
op_assign
id|slot_port
suffix:semicolon
id|ec-&gt;irqaddr
op_assign
(paren
r_int
r_char
op_star
)paren
id|ioaddr
c_func
(paren
id|slot_port
op_plus
id|ICS_ARCIN_V5_INTRSTAT
)paren
suffix:semicolon
id|ec-&gt;irqmask
op_assign
l_int|1
suffix:semicolon
id|ec-&gt;irq_data
op_assign
id|state
suffix:semicolon
id|ec-&gt;ops
op_assign
op_amp
id|icside_ops_arcin_v5
suffix:semicolon
multiline_comment|/*&n;&t; * Be on the safe side - disable interrupts&n;&t; */
id|inb
c_func
(paren
id|slot_port
op_plus
id|ICS_ARCIN_V5_INTROFFSET
)paren
suffix:semicolon
id|hwif
op_assign
id|icside_setup
c_func
(paren
id|slot_port
comma
op_amp
id|icside_cardinfo_v5
comma
id|ec
)paren
suffix:semicolon
id|state-&gt;hwif
(braket
l_int|0
)braket
op_assign
id|hwif
suffix:semicolon
r_return
id|hwif
ques
c_cond
l_int|0
suffix:colon
op_minus
id|ENODEV
suffix:semicolon
)brace
r_static
r_int
id|__init
DECL|function|icside_register_v6
id|icside_register_v6
c_func
(paren
r_struct
id|icside_state
op_star
id|state
comma
r_struct
id|expansion_card
op_star
id|ec
)paren
(brace
r_int
r_int
id|slot_port
comma
id|port
suffix:semicolon
id|ide_hwif_t
op_star
id|hwif
comma
op_star
id|mate
suffix:semicolon
r_int
r_int
id|sel
op_assign
l_int|0
suffix:semicolon
id|slot_port
op_assign
id|ecard_address
c_func
(paren
id|ec
comma
id|ECARD_IOC
comma
id|ECARD_FAST
)paren
suffix:semicolon
id|port
op_assign
id|ecard_address
c_func
(paren
id|ec
comma
id|ECARD_EASI
comma
id|ECARD_FAST
)paren
suffix:semicolon
r_if
c_cond
(paren
id|port
op_eq
l_int|0
)paren
id|port
op_assign
id|slot_port
suffix:semicolon
r_else
id|sel
op_assign
l_int|1
op_lshift
l_int|5
suffix:semicolon
id|outb
c_func
(paren
id|sel
comma
id|slot_port
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Be on the safe side - disable interrupts&n;&t; */
id|inb
c_func
(paren
id|port
op_plus
id|ICS_ARCIN_V6_INTROFFSET_1
)paren
suffix:semicolon
id|inb
c_func
(paren
id|port
op_plus
id|ICS_ARCIN_V6_INTROFFSET_2
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Find and register the interfaces.&n;&t; */
id|hwif
op_assign
id|icside_setup
c_func
(paren
id|port
comma
op_amp
id|icside_cardinfo_v6_1
comma
id|ec
)paren
suffix:semicolon
id|mate
op_assign
id|icside_setup
c_func
(paren
id|port
comma
op_amp
id|icside_cardinfo_v6_2
comma
id|ec
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hwif
op_logical_or
op_logical_neg
id|mate
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|state-&gt;irq_port
op_assign
id|port
suffix:semicolon
id|state-&gt;slot_port
op_assign
id|slot_port
suffix:semicolon
id|state-&gt;hwif
(braket
l_int|0
)braket
op_assign
id|hwif
suffix:semicolon
id|state-&gt;hwif
(braket
l_int|1
)braket
op_assign
id|mate
suffix:semicolon
id|ec-&gt;irq_data
op_assign
id|state
suffix:semicolon
id|ec-&gt;ops
op_assign
op_amp
id|icside_ops_arcin_v6
suffix:semicolon
id|hwif-&gt;maskproc
op_assign
id|icside_maskproc
suffix:semicolon
id|hwif-&gt;channel
op_assign
l_int|0
suffix:semicolon
id|hwif-&gt;hwif_data
op_assign
id|state
suffix:semicolon
id|hwif-&gt;mate
op_assign
id|mate
suffix:semicolon
id|hwif-&gt;serialized
op_assign
l_int|1
suffix:semicolon
id|hwif-&gt;config_data
op_assign
id|slot_port
suffix:semicolon
id|hwif-&gt;select_data
op_assign
id|sel
suffix:semicolon
id|hwif-&gt;hw.dma
op_assign
id|ec-&gt;dma
suffix:semicolon
id|mate-&gt;maskproc
op_assign
id|icside_maskproc
suffix:semicolon
id|mate-&gt;channel
op_assign
l_int|1
suffix:semicolon
id|mate-&gt;hwif_data
op_assign
id|state
suffix:semicolon
id|mate-&gt;mate
op_assign
id|hwif
suffix:semicolon
id|mate-&gt;serialized
op_assign
l_int|1
suffix:semicolon
id|mate-&gt;config_data
op_assign
id|slot_port
suffix:semicolon
id|mate-&gt;select_data
op_assign
id|sel
op_or
l_int|1
suffix:semicolon
id|mate-&gt;hw.dma
op_assign
id|ec-&gt;dma
suffix:semicolon
r_if
c_cond
(paren
id|ec-&gt;dma
op_ne
id|NO_DMA
op_logical_and
op_logical_neg
id|request_dma
c_func
(paren
id|ec-&gt;dma
comma
id|hwif-&gt;name
)paren
)paren
(brace
id|icside_dma_init
c_func
(paren
id|hwif
)paren
suffix:semicolon
id|icside_dma_init
c_func
(paren
id|mate
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
id|__devinit
DECL|function|icside_probe
id|icside_probe
c_func
(paren
r_struct
id|expansion_card
op_star
id|ec
comma
r_const
r_struct
id|ecard_id
op_star
id|id
)paren
(brace
r_struct
id|icside_state
op_star
id|state
suffix:semicolon
r_void
op_star
id|idmem
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|state
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|icside_state
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|state
)paren
(brace
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|memset
c_func
(paren
id|state
comma
l_int|0
comma
r_sizeof
(paren
id|state
)paren
)paren
suffix:semicolon
id|state-&gt;type
op_assign
id|ICS_TYPE_NOTYPE
suffix:semicolon
id|state-&gt;dev
op_assign
op_amp
id|ec-&gt;dev
suffix:semicolon
id|idmem
op_assign
id|ioremap
c_func
(paren
id|ecard_resource_start
c_func
(paren
id|ec
comma
id|ECARD_RES_IOCFAST
)paren
comma
id|ecard_resource_len
c_func
(paren
id|ec
comma
id|ECARD_RES_IOCFAST
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|idmem
)paren
(brace
r_int
r_int
id|type
suffix:semicolon
id|type
op_assign
id|readb
c_func
(paren
id|idmem
op_plus
id|ICS_IDENT_OFFSET
)paren
op_amp
l_int|1
suffix:semicolon
id|type
op_or_assign
(paren
id|readb
c_func
(paren
id|idmem
op_plus
id|ICS_IDENT_OFFSET
op_plus
l_int|4
)paren
op_amp
l_int|1
)paren
op_lshift
l_int|1
suffix:semicolon
id|type
op_or_assign
(paren
id|readb
c_func
(paren
id|idmem
op_plus
id|ICS_IDENT_OFFSET
op_plus
l_int|8
)paren
op_amp
l_int|1
)paren
op_lshift
l_int|2
suffix:semicolon
id|type
op_or_assign
(paren
id|readb
c_func
(paren
id|idmem
op_plus
id|ICS_IDENT_OFFSET
op_plus
l_int|12
)paren
op_amp
l_int|1
)paren
op_lshift
l_int|3
suffix:semicolon
id|iounmap
c_func
(paren
id|idmem
)paren
suffix:semicolon
id|state-&gt;type
op_assign
id|type
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|state-&gt;type
)paren
(brace
r_case
id|ICS_TYPE_A3IN
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;icside: A3IN unsupported&bslash;n&quot;
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ICS_TYPE_A3USER
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;icside: A3USER unsupported&bslash;n&quot;
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ICS_TYPE_V5
suffix:colon
id|ret
op_assign
id|icside_register_v5
c_func
(paren
id|state
comma
id|ec
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ICS_TYPE_V6
suffix:colon
id|ret
op_assign
id|icside_register_v6
c_func
(paren
id|state
comma
id|ec
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;icside: unknown interface type&bslash;n&quot;
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ret
op_eq
l_int|0
)paren
id|ecard_set_drvdata
c_func
(paren
id|ec
comma
id|state
)paren
suffix:semicolon
r_else
id|kfree
c_func
(paren
id|state
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|icside_remove
r_static
r_void
id|__devexit
id|icside_remove
c_func
(paren
r_struct
id|expansion_card
op_star
id|ec
)paren
(brace
r_struct
id|icside_state
op_star
id|state
op_assign
id|ecard_get_drvdata
c_func
(paren
id|ec
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|state-&gt;type
)paren
(brace
r_case
id|ICS_TYPE_V5
suffix:colon
multiline_comment|/* FIXME: tell IDE to stop using the interface */
multiline_comment|/* Disable interrupts */
id|inb
c_func
(paren
id|state-&gt;slot_port
op_plus
id|ICS_ARCIN_V5_INTROFFSET
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ICS_TYPE_V6
suffix:colon
multiline_comment|/* FIXME: tell IDE to stop using the interface */
id|icside_dma_exit
c_func
(paren
id|state-&gt;hwif
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|icside_dma_exit
c_func
(paren
id|state-&gt;hwif
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ec-&gt;dma
op_ne
id|NO_DMA
)paren
id|free_dma
c_func
(paren
id|ec-&gt;dma
)paren
suffix:semicolon
multiline_comment|/* Disable interrupts */
id|inb
c_func
(paren
id|state-&gt;irq_port
op_plus
id|ICS_ARCIN_V6_INTROFFSET_1
)paren
suffix:semicolon
id|inb
c_func
(paren
id|state-&gt;irq_port
op_plus
id|ICS_ARCIN_V6_INTROFFSET_2
)paren
suffix:semicolon
multiline_comment|/* Reset the ROM pointer/EASI selection */
id|outb
c_func
(paren
l_int|0
comma
id|state-&gt;slot_port
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|ecard_set_drvdata
c_func
(paren
id|ec
comma
l_int|NULL
)paren
suffix:semicolon
id|ec-&gt;ops
op_assign
l_int|NULL
suffix:semicolon
id|ec-&gt;irq_data
op_assign
l_int|NULL
suffix:semicolon
id|kfree
c_func
(paren
id|state
)paren
suffix:semicolon
)brace
DECL|function|icside_shutdown
r_static
r_void
id|icside_shutdown
c_func
(paren
r_struct
id|expansion_card
op_star
id|ec
)paren
(brace
r_struct
id|icside_state
op_star
id|state
op_assign
id|ecard_get_drvdata
c_func
(paren
id|ec
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|state-&gt;type
)paren
(brace
r_case
id|ICS_TYPE_V5
suffix:colon
multiline_comment|/* Disable interrupts */
id|inb
c_func
(paren
id|state-&gt;slot_port
op_plus
id|ICS_ARCIN_V5_INTROFFSET
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ICS_TYPE_V6
suffix:colon
multiline_comment|/* Disable interrupts */
id|inb
c_func
(paren
id|state-&gt;irq_port
op_plus
id|ICS_ARCIN_V6_INTROFFSET_1
)paren
suffix:semicolon
id|inb
c_func
(paren
id|state-&gt;irq_port
op_plus
id|ICS_ARCIN_V6_INTROFFSET_2
)paren
suffix:semicolon
multiline_comment|/* Reset the ROM pointer/EASI selection */
id|outb
c_func
(paren
l_int|0
comma
id|state-&gt;slot_port
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
DECL|variable|icside_ids
r_static
r_const
r_struct
id|ecard_id
id|icside_ids
(braket
)braket
op_assign
(brace
(brace
id|MANU_ICS
comma
id|PROD_ICS_IDE
)brace
comma
(brace
id|MANU_ICS2
comma
id|PROD_ICS2_IDE
)brace
comma
(brace
l_int|0xffff
comma
l_int|0xffff
)brace
)brace
suffix:semicolon
DECL|variable|icside_driver
r_static
r_struct
id|ecard_driver
id|icside_driver
op_assign
(brace
dot
id|probe
op_assign
id|icside_probe
comma
dot
id|remove
op_assign
id|__devexit_p
c_func
(paren
id|icside_remove
)paren
comma
dot
id|shutdown
op_assign
id|icside_shutdown
comma
dot
id|id_table
op_assign
id|icside_ids
comma
dot
id|drv
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;icside&quot;
comma
)brace
comma
)brace
suffix:semicolon
DECL|function|icside_init
r_static
r_int
id|__init
id|icside_init
c_func
(paren
r_void
)paren
(brace
r_return
id|ecard_register_driver
c_func
(paren
op_amp
id|icside_driver
)paren
suffix:semicolon
)brace
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Russell King &lt;rmk@arm.linux.org.uk&gt;&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;ICS IDE driver&quot;
)paren
suffix:semicolon
DECL|variable|icside_init
id|module_init
c_func
(paren
id|icside_init
)paren
suffix:semicolon
eof
