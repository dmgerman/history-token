multiline_comment|/**** vi:set ts=8 sts=8 sw=8:************************************************&n; *&n; *  Copyright (C) 2002 Marcin Dalecki &lt;martin@dalecki.de&gt;&n; *&n; *  Copyright (c) 1999-2000  Andre Hedrick &lt;andre@linux-ide.org&gt;&n; *  Copyright (c) 1995-1998  Mark Lord&n; *&n; * This program is free software; you can redistribute it and/or modify it&n; * under the terms of the GNU General Public License version 2 as published by&n; * the Free Software Foundation.&n; */
multiline_comment|/*&n; *  Just the black and white list handling for BM-DMA operation.&n; */
macro_line|#include &lt;linux/config.h&gt;
DECL|macro|__NO_VERSION__
mdefine_line|#define __NO_VERSION__
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/ide.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#ifdef CONFIG_IDEDMA_NEW_DRIVE_LISTINGS
DECL|struct|drive_list_entry
r_struct
id|drive_list_entry
(brace
DECL|member|id_model
r_char
op_star
id|id_model
suffix:semicolon
DECL|member|id_firmware
r_char
op_star
id|id_firmware
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|drive_whitelist
r_struct
id|drive_list_entry
id|drive_whitelist
(braket
)braket
op_assign
(brace
(brace
l_string|&quot;Micropolis 2112A&quot;
comma
l_int|NULL
)brace
comma
(brace
l_string|&quot;CONNER CTMA 4000&quot;
comma
l_int|NULL
)brace
comma
(brace
l_string|&quot;CONNER CTT8000-A&quot;
comma
l_int|NULL
)brace
comma
(brace
l_string|&quot;ST34342A&quot;
comma
l_int|NULL
)brace
comma
(brace
l_int|NULL
comma
l_int|NULL
)brace
)brace
suffix:semicolon
DECL|variable|drive_blacklist
r_struct
id|drive_list_entry
id|drive_blacklist
(braket
)braket
op_assign
(brace
(brace
l_string|&quot;WDC AC11000H&quot;
comma
l_int|NULL
)brace
comma
(brace
l_string|&quot;WDC AC22100H&quot;
comma
l_int|NULL
)brace
comma
(brace
l_string|&quot;WDC AC32500H&quot;
comma
l_int|NULL
)brace
comma
(brace
l_string|&quot;WDC AC33100H&quot;
comma
l_int|NULL
)brace
comma
(brace
l_string|&quot;WDC AC31600H&quot;
comma
l_int|NULL
)brace
comma
(brace
l_string|&quot;WDC AC32100H&quot;
comma
l_string|&quot;24.09P07&quot;
)brace
comma
(brace
l_string|&quot;WDC AC23200L&quot;
comma
l_string|&quot;21.10N21&quot;
)brace
comma
(brace
l_string|&quot;Compaq CRD-8241B&quot;
comma
l_int|NULL
)brace
comma
(brace
l_string|&quot;CRD-8400B&quot;
comma
l_int|NULL
)brace
comma
(brace
l_string|&quot;CRD-8480B&quot;
comma
l_int|NULL
)brace
comma
(brace
l_string|&quot;CRD-8480C&quot;
comma
l_int|NULL
)brace
comma
(brace
l_string|&quot;CRD-8482B&quot;
comma
l_int|NULL
)brace
comma
(brace
l_string|&quot;CRD-84&quot;
comma
l_int|NULL
)brace
comma
(brace
l_string|&quot;SanDisk SDP3B&quot;
comma
l_int|NULL
)brace
comma
(brace
l_string|&quot;SanDisk SDP3B-64&quot;
comma
l_int|NULL
)brace
comma
(brace
l_string|&quot;SANYO CD-ROM CRD&quot;
comma
l_int|NULL
)brace
comma
(brace
l_string|&quot;HITACHI CDR-8&quot;
comma
l_int|NULL
)brace
comma
(brace
l_string|&quot;HITACHI CDR-8335&quot;
comma
l_int|NULL
)brace
comma
(brace
l_string|&quot;HITACHI CDR-8435&quot;
comma
l_int|NULL
)brace
comma
(brace
l_string|&quot;Toshiba CD-ROM XM-6202B&quot;
comma
l_int|NULL
)brace
comma
(brace
l_string|&quot;CD-532E-A&quot;
comma
l_int|NULL
)brace
comma
(brace
l_string|&quot;E-IDE CD-ROM CR-840&quot;
comma
l_int|NULL
)brace
comma
(brace
l_string|&quot;CD-ROM Drive/F5A&quot;
comma
l_int|NULL
)brace
comma
(brace
l_string|&quot;RICOH CD-R/RW MP7083A&quot;
comma
l_int|NULL
)brace
comma
(brace
l_string|&quot;WPI CDD-820&quot;
comma
l_int|NULL
)brace
comma
(brace
l_string|&quot;SAMSUNG CD-ROM SC-148C&quot;
comma
l_int|NULL
)brace
comma
(brace
l_string|&quot;SAMSUNG CD-ROM SC-148F&quot;
comma
l_int|NULL
)brace
comma
(brace
l_string|&quot;SAMSUNG CD-ROM SC&quot;
comma
l_int|NULL
)brace
comma
(brace
l_string|&quot;SanDisk SDP3B-64&quot;
comma
l_int|NULL
)brace
comma
(brace
l_string|&quot;SAMSUNG CD-ROM SN-124&quot;
comma
l_int|NULL
)brace
comma
(brace
l_string|&quot;PLEXTOR CD-R PX-W8432T&quot;
comma
l_int|NULL
)brace
comma
(brace
l_string|&quot;ATAPI CD-ROM DRIVE 40X MAXIMUM&quot;
comma
l_int|NULL
)brace
comma
(brace
l_string|&quot;_NEC DV5800A&quot;
comma
l_int|NULL
)brace
comma
(brace
l_int|NULL
comma
l_int|NULL
)brace
)brace
suffix:semicolon
DECL|function|in_drive_list
r_static
r_int
id|in_drive_list
c_func
(paren
r_struct
id|hd_driveid
op_star
id|id
comma
r_struct
id|drive_list_entry
op_star
id|drive_table
)paren
(brace
r_for
c_loop
(paren
suffix:semicolon
id|drive_table-&gt;id_model
suffix:semicolon
id|drive_table
op_increment
)paren
r_if
c_cond
(paren
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|drive_table-&gt;id_model
comma
id|id-&gt;model
)paren
)paren
op_logical_and
(paren
(paren
id|drive_table-&gt;id_firmware
op_logical_and
op_logical_neg
id|strstr
c_func
(paren
id|drive_table-&gt;id_firmware
comma
id|id-&gt;fw_rev
)paren
)paren
op_logical_or
(paren
op_logical_neg
id|drive_table-&gt;id_firmware
)paren
)paren
)paren
r_return
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#else
multiline_comment|/*&n; * good_dma_drives() lists the model names (from &quot;hdparm -i&quot;)&n; * of drives which do not support mode2 DMA but which are&n; * known to work fine with this interface under Linux.&n; */
DECL|variable|good_dma_drives
r_const
r_char
op_star
id|good_dma_drives
(braket
)braket
op_assign
(brace
l_string|&quot;Micropolis 2112A&quot;
comma
l_string|&quot;CONNER CTMA 4000&quot;
comma
l_string|&quot;CONNER CTT8000-A&quot;
comma
l_string|&quot;ST34342A&quot;
comma
multiline_comment|/* for Sun Ultra */
l_int|NULL
)brace
suffix:semicolon
multiline_comment|/*&n; * bad_dma_drives() lists the model names (from &quot;hdparm -i&quot;)&n; * of drives which supposedly support (U)DMA but which are&n; * known to corrupt data with this interface under Linux.&n; *&n; * This is an empirical list. Its generated from bug reports. That means&n; * while it reflects actual problem distributions it doesn&squot;t answer whether&n; * the drive or the controller, or cabling, or software, or some combination&n; * thereof is the fault. If you don&squot;t happen to agree with the kernel&squot;s&n; * opinion of your drive - use hdparm to turn DMA on.&n; */
DECL|variable|bad_dma_drives
r_const
r_char
op_star
id|bad_dma_drives
(braket
)braket
op_assign
(brace
l_string|&quot;WDC AC11000H&quot;
comma
l_string|&quot;WDC AC22100H&quot;
comma
l_string|&quot;WDC AC32100H&quot;
comma
l_string|&quot;WDC AC32500H&quot;
comma
l_string|&quot;WDC AC33100H&quot;
comma
l_string|&quot;WDC AC31600H&quot;
comma
l_int|NULL
)brace
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n; *  For both Blacklisted and Whitelisted drives.&n; *  This is setup to be called as an extern for future support&n; *  to other special driver code.&n; */
DECL|function|check_drive_lists
r_int
id|check_drive_lists
c_func
(paren
r_struct
id|ata_device
op_star
id|drive
comma
r_int
id|good_bad
)paren
(brace
r_struct
id|hd_driveid
op_star
id|id
op_assign
id|drive-&gt;id
suffix:semicolon
macro_line|#ifdef CONFIG_IDEDMA_NEW_DRIVE_LISTINGS
r_if
c_cond
(paren
id|good_bad
)paren
(brace
r_return
id|in_drive_list
c_func
(paren
id|id
comma
id|drive_whitelist
)paren
suffix:semicolon
)brace
r_else
(brace
r_int
id|blacklist
op_assign
id|in_drive_list
c_func
(paren
id|id
comma
id|drive_blacklist
)paren
suffix:semicolon
r_if
c_cond
(paren
id|blacklist
)paren
id|printk
c_func
(paren
l_string|&quot;%s: Disabling (U)DMA for %s&bslash;n&quot;
comma
id|drive-&gt;name
comma
id|id-&gt;model
)paren
suffix:semicolon
r_return
id|blacklist
suffix:semicolon
)brace
macro_line|#else
r_const
r_char
op_star
op_star
id|list
suffix:semicolon
r_if
c_cond
(paren
id|good_bad
)paren
(brace
multiline_comment|/* Consult the list of known &quot;good&quot; drives */
id|list
op_assign
id|good_dma_drives
suffix:semicolon
r_while
c_loop
(paren
op_star
id|list
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
op_star
id|list
op_increment
comma
id|id-&gt;model
)paren
)paren
r_return
l_int|1
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* Consult the list of known &quot;bad&quot; drives */
id|list
op_assign
id|bad_dma_drives
suffix:semicolon
r_while
c_loop
(paren
op_star
id|list
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
op_star
id|list
op_increment
comma
id|id-&gt;model
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: Disabling (U)DMA for %s&bslash;n&quot;
comma
id|drive-&gt;name
comma
id|id-&gt;model
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
)brace
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|udma_print
r_void
id|udma_print
c_func
(paren
r_struct
id|ata_device
op_star
id|drive
)paren
(brace
macro_line|#ifdef CONFIG_ARCH_ACORN
id|printk
c_func
(paren
l_string|&quot;, DMA&quot;
)paren
suffix:semicolon
macro_line|#else
r_struct
id|hd_driveid
op_star
id|id
op_assign
id|drive-&gt;id
suffix:semicolon
r_char
op_star
id|str
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
(paren
id|id-&gt;field_valid
op_amp
l_int|4
)paren
op_logical_and
(paren
id|eighty_ninty_three
c_func
(paren
id|drive
)paren
)paren
op_logical_and
(paren
id|id-&gt;dma_ultra
op_amp
(paren
id|id-&gt;dma_ultra
op_rshift
l_int|14
)paren
op_amp
l_int|3
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|id-&gt;dma_ultra
op_rshift
l_int|15
)paren
op_amp
l_int|1
)paren
id|str
op_assign
l_string|&quot;, UDMA(mode 7)&quot;
suffix:semicolon
multiline_comment|/* UDMA BIOS-enabled! */
r_else
id|str
op_assign
l_string|&quot;, UDMA(133)&quot;
suffix:semicolon
multiline_comment|/* UDMA BIOS-enabled! */
)brace
r_else
r_if
c_cond
(paren
(paren
id|id-&gt;field_valid
op_amp
l_int|4
)paren
op_logical_and
(paren
id|eighty_ninty_three
c_func
(paren
id|drive
)paren
)paren
op_logical_and
(paren
id|id-&gt;dma_ultra
op_amp
(paren
id|id-&gt;dma_ultra
op_rshift
l_int|11
)paren
op_amp
l_int|7
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|id-&gt;dma_ultra
op_rshift
l_int|13
)paren
op_amp
l_int|1
)paren
(brace
id|str
op_assign
l_string|&quot;, UDMA(100)&quot;
suffix:semicolon
multiline_comment|/* UDMA BIOS-enabled! */
)brace
r_else
r_if
c_cond
(paren
(paren
id|id-&gt;dma_ultra
op_rshift
l_int|12
)paren
op_amp
l_int|1
)paren
(brace
id|str
op_assign
l_string|&quot;, UDMA(66)&quot;
suffix:semicolon
multiline_comment|/* UDMA BIOS-enabled! */
)brace
r_else
(brace
id|str
op_assign
l_string|&quot;, UDMA(44)&quot;
suffix:semicolon
multiline_comment|/* UDMA BIOS-enabled! */
)brace
)brace
r_else
r_if
c_cond
(paren
(paren
id|id-&gt;field_valid
op_amp
l_int|4
)paren
op_logical_and
(paren
id|id-&gt;dma_ultra
op_amp
(paren
id|id-&gt;dma_ultra
op_rshift
l_int|8
)paren
op_amp
l_int|7
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|id-&gt;dma_ultra
op_rshift
l_int|10
)paren
op_amp
l_int|1
)paren
(brace
id|str
op_assign
l_string|&quot;, UDMA(33)&quot;
suffix:semicolon
multiline_comment|/* UDMA BIOS-enabled! */
)brace
r_else
r_if
c_cond
(paren
(paren
id|id-&gt;dma_ultra
op_rshift
l_int|9
)paren
op_amp
l_int|1
)paren
(brace
id|str
op_assign
l_string|&quot;, UDMA(25)&quot;
suffix:semicolon
multiline_comment|/* UDMA BIOS-enabled! */
)brace
r_else
(brace
id|str
op_assign
l_string|&quot;, UDMA(16)&quot;
suffix:semicolon
multiline_comment|/* UDMA BIOS-enabled! */
)brace
)brace
r_else
r_if
c_cond
(paren
id|id-&gt;field_valid
op_amp
l_int|4
)paren
id|str
op_assign
l_string|&quot;, (U)DMA&quot;
suffix:semicolon
multiline_comment|/* Can be BIOS-enabled! */
r_else
id|str
op_assign
l_string|&quot;, DMA&quot;
suffix:semicolon
id|printk
c_func
(paren
id|str
)paren
suffix:semicolon
macro_line|#endif
)brace
multiline_comment|/*&n; * Drive back/white list handling for UDMA capability:&n; */
DECL|function|udma_black_list
r_int
id|udma_black_list
c_func
(paren
r_struct
id|ata_device
op_star
id|drive
)paren
(brace
r_return
id|check_drive_lists
c_func
(paren
id|drive
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|udma_white_list
r_int
id|udma_white_list
c_func
(paren
r_struct
id|ata_device
op_star
id|drive
)paren
(brace
r_return
id|check_drive_lists
c_func
(paren
id|drive
comma
l_int|1
)paren
suffix:semicolon
)brace
DECL|variable|udma_print
id|EXPORT_SYMBOL
c_func
(paren
id|udma_print
)paren
suffix:semicolon
DECL|variable|udma_black_list
id|EXPORT_SYMBOL
c_func
(paren
id|udma_black_list
)paren
suffix:semicolon
DECL|variable|udma_white_list
id|EXPORT_SYMBOL
c_func
(paren
id|udma_white_list
)paren
suffix:semicolon
eof
