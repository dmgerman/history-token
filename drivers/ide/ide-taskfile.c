multiline_comment|/*&n; * linux/drivers/ide/ide-taskfile.c&t;Version 0.38&t;March 05, 2003&n; *&n; *  Copyright (C) 2000-2002&t;Michael Cornwell &lt;cornwell@acm.org&gt;&n; *  Copyright (C) 2000-2002&t;Andre Hedrick &lt;andre@linux-ide.org&gt;&n; *  Copyright (C) 2001-2002&t;Klaus Smolin&n; *&t;&t;&t;&t;&t;IBM Storage Technology Division&n; *  Copyright (C) 2003-2004&t;Bartlomiej Zolnierkiewicz&n; *&n; *  The big the bad and the ugly.&n; *&n; *  Problems to be fixed because of BH interface or the lack therefore.&n; *&n; *  Fill me in stupid !!!&n; *&n; *  HOST:&n; *&t;General refers to the Controller and Driver &quot;pair&quot;.&n; *  DATA HANDLER:&n; *&t;Under the context of Linux it generally refers to an interrupt handler.&n; *&t;However, it correctly describes the &squot;HOST&squot;&n; *  DATA BLOCK:&n; *&t;The amount of data needed to be transfered as predefined in the&n; *&t;setup of the device.&n; *  STORAGE ATOMIC:&n; *&t;The &squot;DATA BLOCK&squot; associated to the &squot;DATA HANDLER&squot;, and can be as&n; *&t;small as a single sector or as large as the entire command block&n; *&t;request.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/major.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/genhd.h&gt;
macro_line|#include &lt;linux/blkpg.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/hdreg.h&gt;
macro_line|#include &lt;linux/ide.h&gt;
macro_line|#include &lt;linux/bitops.h&gt;
macro_line|#include &lt;asm/byteorder.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/io.h&gt;
DECL|macro|DEBUG_TASKFILE
mdefine_line|#define DEBUG_TASKFILE&t;0&t;/* unset when fixed */
DECL|function|ata_bswap_data
r_static
r_void
id|ata_bswap_data
(paren
r_void
op_star
id|buffer
comma
r_int
id|wcount
)paren
(brace
id|u16
op_star
id|p
op_assign
id|buffer
suffix:semicolon
r_while
c_loop
(paren
id|wcount
op_decrement
)paren
(brace
op_star
id|p
op_assign
op_star
id|p
op_lshift
l_int|8
op_or
op_star
id|p
op_rshift
l_int|8
suffix:semicolon
id|p
op_increment
suffix:semicolon
op_star
id|p
op_assign
op_star
id|p
op_lshift
l_int|8
op_or
op_star
id|p
op_rshift
l_int|8
suffix:semicolon
id|p
op_increment
suffix:semicolon
)brace
)brace
DECL|function|taskfile_input_data
r_static
r_void
id|taskfile_input_data
c_func
(paren
id|ide_drive_t
op_star
id|drive
comma
r_void
op_star
id|buffer
comma
id|u32
id|wcount
)paren
(brace
id|HWIF
c_func
(paren
id|drive
)paren
op_member_access_from_pointer
id|ata_input_data
c_func
(paren
id|drive
comma
id|buffer
comma
id|wcount
)paren
suffix:semicolon
r_if
c_cond
(paren
id|drive-&gt;bswap
)paren
id|ata_bswap_data
c_func
(paren
id|buffer
comma
id|wcount
)paren
suffix:semicolon
)brace
DECL|function|taskfile_output_data
r_static
r_void
id|taskfile_output_data
c_func
(paren
id|ide_drive_t
op_star
id|drive
comma
r_void
op_star
id|buffer
comma
id|u32
id|wcount
)paren
(brace
r_if
c_cond
(paren
id|drive-&gt;bswap
)paren
(brace
id|ata_bswap_data
c_func
(paren
id|buffer
comma
id|wcount
)paren
suffix:semicolon
id|HWIF
c_func
(paren
id|drive
)paren
op_member_access_from_pointer
id|ata_output_data
c_func
(paren
id|drive
comma
id|buffer
comma
id|wcount
)paren
suffix:semicolon
id|ata_bswap_data
c_func
(paren
id|buffer
comma
id|wcount
)paren
suffix:semicolon
)brace
r_else
(brace
id|HWIF
c_func
(paren
id|drive
)paren
op_member_access_from_pointer
id|ata_output_data
c_func
(paren
id|drive
comma
id|buffer
comma
id|wcount
)paren
suffix:semicolon
)brace
)brace
DECL|function|taskfile_lib_get_identify
r_int
id|taskfile_lib_get_identify
(paren
id|ide_drive_t
op_star
id|drive
comma
id|u8
op_star
id|buf
)paren
(brace
id|ide_task_t
id|args
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|args
comma
l_int|0
comma
r_sizeof
(paren
id|ide_task_t
)paren
)paren
suffix:semicolon
id|args.tfRegister
(braket
id|IDE_NSECTOR_OFFSET
)braket
op_assign
l_int|0x01
suffix:semicolon
r_if
c_cond
(paren
id|drive-&gt;media
op_eq
id|ide_disk
)paren
id|args.tfRegister
(braket
id|IDE_COMMAND_OFFSET
)braket
op_assign
id|WIN_IDENTIFY
suffix:semicolon
r_else
id|args.tfRegister
(braket
id|IDE_COMMAND_OFFSET
)braket
op_assign
id|WIN_PIDENTIFY
suffix:semicolon
id|args.command_type
op_assign
id|IDE_DRIVE_TASK_IN
suffix:semicolon
id|args.data_phase
op_assign
id|TASKFILE_IN
suffix:semicolon
id|args.handler
op_assign
op_amp
id|task_in_intr
suffix:semicolon
r_return
id|ide_raw_taskfile
c_func
(paren
id|drive
comma
op_amp
id|args
comma
id|buf
)paren
suffix:semicolon
)brace
DECL|function|do_rw_taskfile
id|ide_startstop_t
id|do_rw_taskfile
(paren
id|ide_drive_t
op_star
id|drive
comma
id|ide_task_t
op_star
id|task
)paren
(brace
id|ide_hwif_t
op_star
id|hwif
op_assign
id|HWIF
c_func
(paren
id|drive
)paren
suffix:semicolon
id|task_struct_t
op_star
id|taskfile
op_assign
(paren
id|task_struct_t
op_star
)paren
id|task-&gt;tfRegister
suffix:semicolon
id|hob_struct_t
op_star
id|hobfile
op_assign
(paren
id|hob_struct_t
op_star
)paren
id|task-&gt;hobRegister
suffix:semicolon
id|u8
id|HIHI
op_assign
(paren
id|drive-&gt;addressing
op_eq
l_int|1
)paren
ques
c_cond
l_int|0xE0
suffix:colon
l_int|0xEF
suffix:semicolon
multiline_comment|/* ALL Command Block Executions SHALL clear nIEN, unless otherwise */
r_if
c_cond
(paren
id|IDE_CONTROL_REG
)paren
(brace
multiline_comment|/* clear nIEN */
id|hwif
op_member_access_from_pointer
id|OUTB
c_func
(paren
id|drive-&gt;ctl
comma
id|IDE_CONTROL_REG
)paren
suffix:semicolon
)brace
id|SELECT_MASK
c_func
(paren
id|drive
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|drive-&gt;addressing
op_eq
l_int|1
)paren
(brace
id|hwif
op_member_access_from_pointer
id|OUTB
c_func
(paren
id|hobfile-&gt;feature
comma
id|IDE_FEATURE_REG
)paren
suffix:semicolon
id|hwif
op_member_access_from_pointer
id|OUTB
c_func
(paren
id|hobfile-&gt;sector_count
comma
id|IDE_NSECTOR_REG
)paren
suffix:semicolon
id|hwif
op_member_access_from_pointer
id|OUTB
c_func
(paren
id|hobfile-&gt;sector_number
comma
id|IDE_SECTOR_REG
)paren
suffix:semicolon
id|hwif
op_member_access_from_pointer
id|OUTB
c_func
(paren
id|hobfile-&gt;low_cylinder
comma
id|IDE_LCYL_REG
)paren
suffix:semicolon
id|hwif
op_member_access_from_pointer
id|OUTB
c_func
(paren
id|hobfile-&gt;high_cylinder
comma
id|IDE_HCYL_REG
)paren
suffix:semicolon
)brace
id|hwif
op_member_access_from_pointer
id|OUTB
c_func
(paren
id|taskfile-&gt;feature
comma
id|IDE_FEATURE_REG
)paren
suffix:semicolon
id|hwif
op_member_access_from_pointer
id|OUTB
c_func
(paren
id|taskfile-&gt;sector_count
comma
id|IDE_NSECTOR_REG
)paren
suffix:semicolon
id|hwif
op_member_access_from_pointer
id|OUTB
c_func
(paren
id|taskfile-&gt;sector_number
comma
id|IDE_SECTOR_REG
)paren
suffix:semicolon
id|hwif
op_member_access_from_pointer
id|OUTB
c_func
(paren
id|taskfile-&gt;low_cylinder
comma
id|IDE_LCYL_REG
)paren
suffix:semicolon
id|hwif
op_member_access_from_pointer
id|OUTB
c_func
(paren
id|taskfile-&gt;high_cylinder
comma
id|IDE_HCYL_REG
)paren
suffix:semicolon
id|hwif
op_member_access_from_pointer
id|OUTB
c_func
(paren
(paren
id|taskfile-&gt;device_head
op_amp
id|HIHI
)paren
op_or
id|drive-&gt;select.all
comma
id|IDE_SELECT_REG
)paren
suffix:semicolon
r_if
c_cond
(paren
id|task-&gt;handler
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|task-&gt;prehandler
op_ne
l_int|NULL
)paren
(brace
id|hwif
op_member_access_from_pointer
id|OUTBSYNC
c_func
(paren
id|drive
comma
id|taskfile-&gt;command
comma
id|IDE_COMMAND_REG
)paren
suffix:semicolon
id|ndelay
c_func
(paren
l_int|400
)paren
suffix:semicolon
multiline_comment|/* FIXME */
r_return
id|task
op_member_access_from_pointer
id|prehandler
c_func
(paren
id|drive
comma
id|task-&gt;rq
)paren
suffix:semicolon
)brace
id|ide_execute_command
c_func
(paren
id|drive
comma
id|taskfile-&gt;command
comma
id|task-&gt;handler
comma
id|WAIT_WORSTCASE
comma
l_int|NULL
)paren
suffix:semicolon
r_return
id|ide_started
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|drive-&gt;using_dma
)paren
r_return
id|ide_stopped
suffix:semicolon
r_switch
c_cond
(paren
id|taskfile-&gt;command
)paren
(brace
r_case
id|WIN_WRITEDMA_ONCE
suffix:colon
r_case
id|WIN_WRITEDMA
suffix:colon
r_case
id|WIN_WRITEDMA_EXT
suffix:colon
r_case
id|WIN_READDMA_ONCE
suffix:colon
r_case
id|WIN_READDMA
suffix:colon
r_case
id|WIN_READDMA_EXT
suffix:colon
r_case
id|WIN_IDENTIFY_DMA
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|hwif
op_member_access_from_pointer
id|dma_setup
c_func
(paren
id|drive
)paren
)paren
(brace
id|hwif
op_member_access_from_pointer
id|dma_exec_cmd
c_func
(paren
id|drive
comma
id|taskfile-&gt;command
)paren
suffix:semicolon
id|hwif
op_member_access_from_pointer
id|dma_start
c_func
(paren
id|drive
)paren
suffix:semicolon
r_return
id|ide_started
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
r_if
c_cond
(paren
id|task-&gt;handler
op_eq
l_int|NULL
)paren
r_return
id|ide_stopped
suffix:semicolon
)brace
r_return
id|ide_stopped
suffix:semicolon
)brace
DECL|variable|do_rw_taskfile
id|EXPORT_SYMBOL
c_func
(paren
id|do_rw_taskfile
)paren
suffix:semicolon
multiline_comment|/*&n; * set_multmode_intr() is invoked on completion of a WIN_SETMULT cmd.&n; */
DECL|function|set_multmode_intr
id|ide_startstop_t
id|set_multmode_intr
(paren
id|ide_drive_t
op_star
id|drive
)paren
(brace
id|ide_hwif_t
op_star
id|hwif
op_assign
id|HWIF
c_func
(paren
id|drive
)paren
suffix:semicolon
id|u8
id|stat
suffix:semicolon
r_if
c_cond
(paren
id|OK_STAT
c_func
(paren
id|stat
op_assign
id|hwif
op_member_access_from_pointer
id|INB
c_func
(paren
id|IDE_STATUS_REG
)paren
comma
id|READY_STAT
comma
id|BAD_STAT
)paren
)paren
(brace
id|drive-&gt;mult_count
op_assign
id|drive-&gt;mult_req
suffix:semicolon
)brace
r_else
(brace
id|drive-&gt;mult_req
op_assign
id|drive-&gt;mult_count
op_assign
l_int|0
suffix:semicolon
id|drive-&gt;special.b.recalibrate
op_assign
l_int|1
suffix:semicolon
(paren
r_void
)paren
id|ide_dump_status
c_func
(paren
id|drive
comma
l_string|&quot;set_multmode&quot;
comma
id|stat
)paren
suffix:semicolon
)brace
r_return
id|ide_stopped
suffix:semicolon
)brace
DECL|variable|set_multmode_intr
id|EXPORT_SYMBOL
c_func
(paren
id|set_multmode_intr
)paren
suffix:semicolon
multiline_comment|/*&n; * set_geometry_intr() is invoked on completion of a WIN_SPECIFY cmd.&n; */
DECL|function|set_geometry_intr
id|ide_startstop_t
id|set_geometry_intr
(paren
id|ide_drive_t
op_star
id|drive
)paren
(brace
id|ide_hwif_t
op_star
id|hwif
op_assign
id|HWIF
c_func
(paren
id|drive
)paren
suffix:semicolon
r_int
id|retries
op_assign
l_int|5
suffix:semicolon
id|u8
id|stat
suffix:semicolon
r_while
c_loop
(paren
(paren
(paren
id|stat
op_assign
id|hwif
op_member_access_from_pointer
id|INB
c_func
(paren
id|IDE_STATUS_REG
)paren
)paren
op_amp
id|BUSY_STAT
)paren
op_logical_and
id|retries
op_decrement
)paren
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|OK_STAT
c_func
(paren
id|stat
comma
id|READY_STAT
comma
id|BAD_STAT
)paren
)paren
r_return
id|ide_stopped
suffix:semicolon
r_if
c_cond
(paren
id|stat
op_amp
(paren
id|ERR_STAT
op_or
id|DRQ_STAT
)paren
)paren
r_return
id|DRIVER
c_func
(paren
id|drive
)paren
op_member_access_from_pointer
id|error
c_func
(paren
id|drive
comma
l_string|&quot;set_geometry_intr&quot;
comma
id|stat
)paren
suffix:semicolon
r_if
c_cond
(paren
id|HWGROUP
c_func
(paren
id|drive
)paren
op_member_access_from_pointer
id|handler
op_ne
l_int|NULL
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
id|ide_set_handler
c_func
(paren
id|drive
comma
op_amp
id|set_geometry_intr
comma
id|WAIT_WORSTCASE
comma
l_int|NULL
)paren
suffix:semicolon
r_return
id|ide_started
suffix:semicolon
)brace
DECL|variable|set_geometry_intr
id|EXPORT_SYMBOL
c_func
(paren
id|set_geometry_intr
)paren
suffix:semicolon
multiline_comment|/*&n; * recal_intr() is invoked on completion of a WIN_RESTORE (recalibrate) cmd.&n; */
DECL|function|recal_intr
id|ide_startstop_t
id|recal_intr
(paren
id|ide_drive_t
op_star
id|drive
)paren
(brace
id|ide_hwif_t
op_star
id|hwif
op_assign
id|HWIF
c_func
(paren
id|drive
)paren
suffix:semicolon
id|u8
id|stat
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|OK_STAT
c_func
(paren
id|stat
op_assign
id|hwif
op_member_access_from_pointer
id|INB
c_func
(paren
id|IDE_STATUS_REG
)paren
comma
id|READY_STAT
comma
id|BAD_STAT
)paren
)paren
r_return
id|DRIVER
c_func
(paren
id|drive
)paren
op_member_access_from_pointer
id|error
c_func
(paren
id|drive
comma
l_string|&quot;recal_intr&quot;
comma
id|stat
)paren
suffix:semicolon
r_return
id|ide_stopped
suffix:semicolon
)brace
DECL|variable|recal_intr
id|EXPORT_SYMBOL
c_func
(paren
id|recal_intr
)paren
suffix:semicolon
multiline_comment|/*&n; * Handler for commands without a data phase&n; */
DECL|function|task_no_data_intr
id|ide_startstop_t
id|task_no_data_intr
(paren
id|ide_drive_t
op_star
id|drive
)paren
(brace
id|ide_task_t
op_star
id|args
op_assign
id|HWGROUP
c_func
(paren
id|drive
)paren
op_member_access_from_pointer
id|rq-&gt;special
suffix:semicolon
id|ide_hwif_t
op_star
id|hwif
op_assign
id|HWIF
c_func
(paren
id|drive
)paren
suffix:semicolon
id|u8
id|stat
suffix:semicolon
id|local_irq_enable
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|OK_STAT
c_func
(paren
id|stat
op_assign
id|hwif
op_member_access_from_pointer
id|INB
c_func
(paren
id|IDE_STATUS_REG
)paren
comma
id|READY_STAT
comma
id|BAD_STAT
)paren
)paren
(brace
r_return
id|DRIVER
c_func
(paren
id|drive
)paren
op_member_access_from_pointer
id|error
c_func
(paren
id|drive
comma
l_string|&quot;task_no_data_intr&quot;
comma
id|stat
)paren
suffix:semicolon
multiline_comment|/* calls ide_end_drive_cmd */
)brace
r_if
c_cond
(paren
id|args
)paren
id|ide_end_drive_cmd
c_func
(paren
id|drive
comma
id|stat
comma
id|hwif
op_member_access_from_pointer
id|INB
c_func
(paren
id|IDE_ERROR_REG
)paren
)paren
suffix:semicolon
r_return
id|ide_stopped
suffix:semicolon
)brace
DECL|variable|task_no_data_intr
id|EXPORT_SYMBOL
c_func
(paren
id|task_no_data_intr
)paren
suffix:semicolon
DECL|function|wait_drive_not_busy
r_static
id|u8
id|wait_drive_not_busy
c_func
(paren
id|ide_drive_t
op_star
id|drive
)paren
(brace
id|ide_hwif_t
op_star
id|hwif
op_assign
id|HWIF
c_func
(paren
id|drive
)paren
suffix:semicolon
r_int
id|retries
op_assign
l_int|100
suffix:semicolon
id|u8
id|stat
suffix:semicolon
multiline_comment|/*&n;&t; * Last sector was transfered, wait until drive is ready.&n;&t; * This can take up to 10 usec, but we will wait max 1 ms&n;&t; * (drive_cmd_intr() waits that long).&n;&t; */
r_while
c_loop
(paren
(paren
(paren
id|stat
op_assign
id|hwif
op_member_access_from_pointer
id|INB
c_func
(paren
id|IDE_STATUS_REG
)paren
)paren
op_amp
id|BUSY_STAT
)paren
op_logical_and
id|retries
op_decrement
)paren
id|udelay
c_func
(paren
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|retries
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: drive still BUSY!&bslash;n&quot;
comma
id|drive-&gt;name
)paren
suffix:semicolon
r_return
id|stat
suffix:semicolon
)brace
DECL|function|ide_pio_sector
r_static
r_void
id|ide_pio_sector
c_func
(paren
id|ide_drive_t
op_star
id|drive
comma
r_int
r_int
id|write
)paren
(brace
id|ide_hwif_t
op_star
id|hwif
op_assign
id|drive-&gt;hwif
suffix:semicolon
r_struct
id|scatterlist
op_star
id|sg
op_assign
id|hwif-&gt;sg_table
suffix:semicolon
r_struct
id|page
op_star
id|page
suffix:semicolon
macro_line|#ifdef CONFIG_HIGHMEM
r_int
r_int
id|flags
suffix:semicolon
macro_line|#endif
id|u8
op_star
id|buf
suffix:semicolon
id|page
op_assign
id|sg
(braket
id|hwif-&gt;cursg
)braket
dot
id|page
suffix:semicolon
macro_line|#ifdef CONFIG_HIGHMEM
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
macro_line|#endif
id|buf
op_assign
id|kmap_atomic
c_func
(paren
id|page
comma
id|KM_BIO_SRC_IRQ
)paren
op_plus
id|sg
(braket
id|hwif-&gt;cursg
)braket
dot
id|offset
op_plus
(paren
id|hwif-&gt;cursg_ofs
op_star
id|SECTOR_SIZE
)paren
suffix:semicolon
id|hwif-&gt;nleft
op_decrement
suffix:semicolon
id|hwif-&gt;cursg_ofs
op_increment
suffix:semicolon
r_if
c_cond
(paren
(paren
id|hwif-&gt;cursg_ofs
op_star
id|SECTOR_SIZE
)paren
op_eq
id|sg
(braket
id|hwif-&gt;cursg
)braket
dot
id|length
)paren
(brace
id|hwif-&gt;cursg
op_increment
suffix:semicolon
id|hwif-&gt;cursg_ofs
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* do the actual data transfer */
r_if
c_cond
(paren
id|write
)paren
id|taskfile_output_data
c_func
(paren
id|drive
comma
id|buf
comma
id|SECTOR_WORDS
)paren
suffix:semicolon
r_else
id|taskfile_input_data
c_func
(paren
id|drive
comma
id|buf
comma
id|SECTOR_WORDS
)paren
suffix:semicolon
id|kunmap_atomic
c_func
(paren
id|buf
comma
id|KM_BIO_SRC_IRQ
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_HIGHMEM
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|ide_pio_multi
r_static
r_void
id|ide_pio_multi
c_func
(paren
id|ide_drive_t
op_star
id|drive
comma
r_int
r_int
id|write
)paren
(brace
r_int
r_int
id|nsect
suffix:semicolon
id|nsect
op_assign
id|min_t
c_func
(paren
r_int
r_int
comma
id|drive-&gt;hwif-&gt;nleft
comma
id|drive-&gt;mult_count
)paren
suffix:semicolon
r_while
c_loop
(paren
id|nsect
op_decrement
)paren
id|ide_pio_sector
c_func
(paren
id|drive
comma
id|write
)paren
suffix:semicolon
)brace
DECL|function|ide_pio_datablock
r_static
r_inline
r_void
id|ide_pio_datablock
c_func
(paren
id|ide_drive_t
op_star
id|drive
comma
r_struct
id|request
op_star
id|rq
comma
r_int
r_int
id|write
)paren
(brace
r_if
c_cond
(paren
id|rq-&gt;bio
)paren
multiline_comment|/* fs request */
id|rq-&gt;errors
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|drive-&gt;hwif-&gt;data_phase
)paren
(brace
r_case
id|TASKFILE_MULTI_IN
suffix:colon
r_case
id|TASKFILE_MULTI_OUT
suffix:colon
id|ide_pio_multi
c_func
(paren
id|drive
comma
id|write
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ide_pio_sector
c_func
(paren
id|drive
comma
id|write
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
DECL|function|task_error
r_static
id|ide_startstop_t
id|task_error
c_func
(paren
id|ide_drive_t
op_star
id|drive
comma
r_struct
id|request
op_star
id|rq
comma
r_const
r_char
op_star
id|s
comma
id|u8
id|stat
)paren
(brace
r_if
c_cond
(paren
id|rq-&gt;bio
)paren
(brace
id|ide_hwif_t
op_star
id|hwif
op_assign
id|drive-&gt;hwif
suffix:semicolon
r_int
id|sectors
op_assign
id|hwif-&gt;nsect
op_minus
id|hwif-&gt;nleft
suffix:semicolon
r_switch
c_cond
(paren
id|hwif-&gt;data_phase
)paren
(brace
r_case
id|TASKFILE_IN
suffix:colon
r_if
c_cond
(paren
id|hwif-&gt;nleft
)paren
r_break
suffix:semicolon
multiline_comment|/* fall through */
r_case
id|TASKFILE_OUT
suffix:colon
id|sectors
op_decrement
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TASKFILE_MULTI_IN
suffix:colon
r_if
c_cond
(paren
id|hwif-&gt;nleft
)paren
r_break
suffix:semicolon
multiline_comment|/* fall through */
r_case
id|TASKFILE_MULTI_OUT
suffix:colon
id|sectors
op_sub_assign
id|drive-&gt;mult_count
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sectors
OG
l_int|0
)paren
id|drive-&gt;driver
op_member_access_from_pointer
id|end_request
c_func
(paren
id|drive
comma
l_int|1
comma
id|sectors
)paren
suffix:semicolon
)brace
r_return
id|drive-&gt;driver
op_member_access_from_pointer
id|error
c_func
(paren
id|drive
comma
id|s
comma
id|stat
)paren
suffix:semicolon
)brace
DECL|function|task_end_request
r_static
r_void
id|task_end_request
c_func
(paren
id|ide_drive_t
op_star
id|drive
comma
r_struct
id|request
op_star
id|rq
comma
id|u8
id|stat
)paren
(brace
r_if
c_cond
(paren
id|rq-&gt;flags
op_amp
id|REQ_DRIVE_TASKFILE
)paren
(brace
id|ide_task_t
op_star
id|task
op_assign
id|rq-&gt;special
suffix:semicolon
r_if
c_cond
(paren
id|task-&gt;tf_out_flags.all
)paren
(brace
id|u8
id|err
op_assign
id|drive-&gt;hwif
op_member_access_from_pointer
id|INB
c_func
(paren
id|IDE_ERROR_REG
)paren
suffix:semicolon
id|ide_end_drive_cmd
c_func
(paren
id|drive
comma
id|stat
comma
id|err
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
id|drive-&gt;driver
op_member_access_from_pointer
id|end_request
c_func
(paren
id|drive
comma
l_int|1
comma
id|rq-&gt;hard_nr_sectors
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Handler for command with PIO data-in phase (Read/Read Multiple).&n; */
DECL|function|task_in_intr
id|ide_startstop_t
id|task_in_intr
(paren
id|ide_drive_t
op_star
id|drive
)paren
(brace
id|ide_hwif_t
op_star
id|hwif
op_assign
id|drive-&gt;hwif
suffix:semicolon
r_struct
id|request
op_star
id|rq
op_assign
id|HWGROUP
c_func
(paren
id|drive
)paren
op_member_access_from_pointer
id|rq
suffix:semicolon
id|u8
id|stat
op_assign
id|hwif
op_member_access_from_pointer
id|INB
c_func
(paren
id|IDE_STATUS_REG
)paren
suffix:semicolon
multiline_comment|/* new way for dealing with premature shared PCI interrupts */
r_if
c_cond
(paren
op_logical_neg
id|OK_STAT
c_func
(paren
id|stat
comma
id|DATA_READY
comma
id|BAD_R_STAT
)paren
)paren
(brace
r_if
c_cond
(paren
id|stat
op_amp
(paren
id|ERR_STAT
op_or
id|DRQ_STAT
)paren
)paren
r_return
id|task_error
c_func
(paren
id|drive
comma
id|rq
comma
id|__FUNCTION__
comma
id|stat
)paren
suffix:semicolon
multiline_comment|/* No data yet, so wait for another IRQ. */
id|ide_set_handler
c_func
(paren
id|drive
comma
op_amp
id|task_in_intr
comma
id|WAIT_WORSTCASE
comma
l_int|NULL
)paren
suffix:semicolon
r_return
id|ide_started
suffix:semicolon
)brace
id|ide_pio_datablock
c_func
(paren
id|drive
comma
id|rq
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* If it was the last datablock check status and finish transfer. */
r_if
c_cond
(paren
op_logical_neg
id|hwif-&gt;nleft
)paren
(brace
id|stat
op_assign
id|wait_drive_not_busy
c_func
(paren
id|drive
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|OK_STAT
c_func
(paren
id|stat
comma
l_int|0
comma
id|BAD_R_STAT
)paren
)paren
r_return
id|task_error
c_func
(paren
id|drive
comma
id|rq
comma
id|__FUNCTION__
comma
id|stat
)paren
suffix:semicolon
id|task_end_request
c_func
(paren
id|drive
comma
id|rq
comma
id|stat
)paren
suffix:semicolon
r_return
id|ide_stopped
suffix:semicolon
)brace
multiline_comment|/* Still data left to transfer. */
id|ide_set_handler
c_func
(paren
id|drive
comma
op_amp
id|task_in_intr
comma
id|WAIT_WORSTCASE
comma
l_int|NULL
)paren
suffix:semicolon
r_return
id|ide_started
suffix:semicolon
)brace
DECL|variable|task_in_intr
id|EXPORT_SYMBOL
c_func
(paren
id|task_in_intr
)paren
suffix:semicolon
multiline_comment|/*&n; * Handler for command with PIO data-out phase (Write/Write Multiple).&n; */
DECL|function|task_out_intr
id|ide_startstop_t
id|task_out_intr
(paren
id|ide_drive_t
op_star
id|drive
)paren
(brace
id|ide_hwif_t
op_star
id|hwif
op_assign
id|drive-&gt;hwif
suffix:semicolon
r_struct
id|request
op_star
id|rq
op_assign
id|HWGROUP
c_func
(paren
id|drive
)paren
op_member_access_from_pointer
id|rq
suffix:semicolon
id|u8
id|stat
op_assign
id|hwif
op_member_access_from_pointer
id|INB
c_func
(paren
id|IDE_STATUS_REG
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|OK_STAT
c_func
(paren
id|stat
comma
id|DRIVE_READY
comma
id|drive-&gt;bad_wstat
)paren
)paren
r_return
id|task_error
c_func
(paren
id|drive
comma
id|rq
comma
id|__FUNCTION__
comma
id|stat
)paren
suffix:semicolon
multiline_comment|/* Deal with unexpected ATA data phase. */
r_if
c_cond
(paren
(paren
(paren
id|stat
op_amp
id|DRQ_STAT
)paren
op_eq
l_int|0
)paren
op_xor
op_logical_neg
id|hwif-&gt;nleft
)paren
r_return
id|task_error
c_func
(paren
id|drive
comma
id|rq
comma
id|__FUNCTION__
comma
id|stat
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hwif-&gt;nleft
)paren
(brace
id|task_end_request
c_func
(paren
id|drive
comma
id|rq
comma
id|stat
)paren
suffix:semicolon
r_return
id|ide_stopped
suffix:semicolon
)brace
multiline_comment|/* Still data left to transfer. */
id|ide_pio_datablock
c_func
(paren
id|drive
comma
id|rq
comma
l_int|1
)paren
suffix:semicolon
id|ide_set_handler
c_func
(paren
id|drive
comma
op_amp
id|task_out_intr
comma
id|WAIT_WORSTCASE
comma
l_int|NULL
)paren
suffix:semicolon
r_return
id|ide_started
suffix:semicolon
)brace
DECL|variable|task_out_intr
id|EXPORT_SYMBOL
c_func
(paren
id|task_out_intr
)paren
suffix:semicolon
DECL|function|pre_task_out_intr
id|ide_startstop_t
id|pre_task_out_intr
(paren
id|ide_drive_t
op_star
id|drive
comma
r_struct
id|request
op_star
id|rq
)paren
(brace
id|ide_startstop_t
id|startstop
suffix:semicolon
r_if
c_cond
(paren
id|ide_wait_stat
c_func
(paren
op_amp
id|startstop
comma
id|drive
comma
id|DATA_READY
comma
id|drive-&gt;bad_wstat
comma
id|WAIT_DRQ
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: no DRQ after issuing %sWRITE%s&bslash;n&quot;
comma
id|drive-&gt;name
comma
id|drive-&gt;hwif-&gt;data_phase
ques
c_cond
l_string|&quot;MULT&quot;
suffix:colon
l_string|&quot;&quot;
comma
id|drive-&gt;addressing
ques
c_cond
l_string|&quot;_EXT&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
r_return
id|startstop
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|drive-&gt;unmask
)paren
id|local_irq_disable
c_func
(paren
)paren
suffix:semicolon
id|ide_set_handler
c_func
(paren
id|drive
comma
op_amp
id|task_out_intr
comma
id|WAIT_WORSTCASE
comma
l_int|NULL
)paren
suffix:semicolon
id|ide_pio_datablock
c_func
(paren
id|drive
comma
id|rq
comma
l_int|1
)paren
suffix:semicolon
r_return
id|ide_started
suffix:semicolon
)brace
DECL|variable|pre_task_out_intr
id|EXPORT_SYMBOL
c_func
(paren
id|pre_task_out_intr
)paren
suffix:semicolon
DECL|function|ide_diag_taskfile
r_static
r_int
id|ide_diag_taskfile
c_func
(paren
id|ide_drive_t
op_star
id|drive
comma
id|ide_task_t
op_star
id|args
comma
r_int
r_int
id|data_size
comma
id|u8
op_star
id|buf
)paren
(brace
r_struct
id|request
id|rq
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|rq
comma
l_int|0
comma
r_sizeof
(paren
id|rq
)paren
)paren
suffix:semicolon
id|rq.flags
op_assign
id|REQ_DRIVE_TASKFILE
suffix:semicolon
id|rq.buffer
op_assign
id|buf
suffix:semicolon
multiline_comment|/*&n;&t; * (ks) We transfer currently only whole sectors.&n;&t; * This is suffient for now.  But, it would be great,&n;&t; * if we would find a solution to transfer any size.&n;&t; * To support special commands like READ LONG.&n;&t; */
r_if
c_cond
(paren
id|args-&gt;command_type
op_ne
id|IDE_DRIVE_TASK_NO_DATA
)paren
(brace
r_if
c_cond
(paren
id|data_size
op_eq
l_int|0
)paren
id|rq.nr_sectors
op_assign
(paren
id|args-&gt;hobRegister
(braket
id|IDE_NSECTOR_OFFSET
)braket
op_lshift
l_int|8
)paren
op_or
id|args-&gt;tfRegister
(braket
id|IDE_NSECTOR_OFFSET
)braket
suffix:semicolon
r_else
id|rq.nr_sectors
op_assign
id|data_size
op_div
id|SECTOR_SIZE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rq.nr_sectors
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: in/out command without data&bslash;n&quot;
comma
id|drive-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|rq.hard_nr_sectors
op_assign
id|rq.nr_sectors
suffix:semicolon
id|rq.hard_cur_sectors
op_assign
id|rq.current_nr_sectors
op_assign
id|rq.nr_sectors
suffix:semicolon
r_if
c_cond
(paren
id|args-&gt;command_type
op_eq
id|IDE_DRIVE_TASK_RAW_WRITE
)paren
id|rq.flags
op_or_assign
id|REQ_RW
suffix:semicolon
)brace
id|rq.special
op_assign
id|args
suffix:semicolon
r_return
id|ide_do_drive_cmd
c_func
(paren
id|drive
comma
op_amp
id|rq
comma
id|ide_wait
)paren
suffix:semicolon
)brace
DECL|function|ide_raw_taskfile
r_int
id|ide_raw_taskfile
(paren
id|ide_drive_t
op_star
id|drive
comma
id|ide_task_t
op_star
id|args
comma
id|u8
op_star
id|buf
)paren
(brace
r_return
id|ide_diag_taskfile
c_func
(paren
id|drive
comma
id|args
comma
l_int|0
comma
id|buf
)paren
suffix:semicolon
)brace
DECL|variable|ide_raw_taskfile
id|EXPORT_SYMBOL
c_func
(paren
id|ide_raw_taskfile
)paren
suffix:semicolon
DECL|function|ide_taskfile_ioctl
r_int
id|ide_taskfile_ioctl
(paren
id|ide_drive_t
op_star
id|drive
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
id|ide_task_request_t
op_star
id|req_task
suffix:semicolon
id|ide_task_t
id|args
suffix:semicolon
id|u8
op_star
id|outbuf
op_assign
l_int|NULL
suffix:semicolon
id|u8
op_star
id|inbuf
op_assign
l_int|NULL
suffix:semicolon
id|task_ioreg_t
op_star
id|argsptr
op_assign
id|args.tfRegister
suffix:semicolon
id|task_ioreg_t
op_star
id|hobsptr
op_assign
id|args.hobRegister
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
r_int
id|tasksize
op_assign
r_sizeof
(paren
r_struct
id|ide_task_request_s
)paren
suffix:semicolon
r_int
id|taskin
op_assign
l_int|0
suffix:semicolon
r_int
id|taskout
op_assign
l_int|0
suffix:semicolon
id|u8
id|io_32bit
op_assign
id|drive-&gt;io_32bit
suffix:semicolon
r_char
id|__user
op_star
id|buf
op_assign
(paren
r_char
id|__user
op_star
)paren
id|arg
suffix:semicolon
singleline_comment|//&t;printk(&quot;IDE Taskfile ...&bslash;n&quot;);
id|req_task
op_assign
id|kmalloc
c_func
(paren
id|tasksize
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|req_task
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|req_task
comma
l_int|0
comma
id|tasksize
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|req_task
comma
id|buf
comma
id|tasksize
)paren
)paren
(brace
id|kfree
c_func
(paren
id|req_task
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|taskout
op_assign
(paren
r_int
)paren
id|req_task-&gt;out_size
suffix:semicolon
id|taskin
op_assign
(paren
r_int
)paren
id|req_task-&gt;in_size
suffix:semicolon
r_if
c_cond
(paren
id|taskout
)paren
(brace
r_int
id|outtotal
op_assign
id|tasksize
suffix:semicolon
id|outbuf
op_assign
id|kmalloc
c_func
(paren
id|taskout
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|outbuf
op_eq
l_int|NULL
)paren
(brace
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
m_abort
suffix:semicolon
)brace
id|memset
c_func
(paren
id|outbuf
comma
l_int|0
comma
id|taskout
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|outbuf
comma
id|buf
op_plus
id|outtotal
comma
id|taskout
)paren
)paren
(brace
id|err
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
m_abort
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|taskin
)paren
(brace
r_int
id|intotal
op_assign
id|tasksize
op_plus
id|taskout
suffix:semicolon
id|inbuf
op_assign
id|kmalloc
c_func
(paren
id|taskin
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inbuf
op_eq
l_int|NULL
)paren
(brace
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
m_abort
suffix:semicolon
)brace
id|memset
c_func
(paren
id|inbuf
comma
l_int|0
comma
id|taskin
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|inbuf
comma
id|buf
op_plus
id|intotal
comma
id|taskin
)paren
)paren
(brace
id|err
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
m_abort
suffix:semicolon
)brace
)brace
id|memset
c_func
(paren
op_amp
id|args
comma
l_int|0
comma
r_sizeof
(paren
id|ide_task_t
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|argsptr
comma
id|req_task-&gt;io_ports
comma
id|HDIO_DRIVE_TASK_HDR_SIZE
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|hobsptr
comma
id|req_task-&gt;hob_ports
comma
id|HDIO_DRIVE_HOB_HDR_SIZE
)paren
suffix:semicolon
id|args.tf_in_flags
op_assign
id|req_task-&gt;in_flags
suffix:semicolon
id|args.tf_out_flags
op_assign
id|req_task-&gt;out_flags
suffix:semicolon
id|args.data_phase
op_assign
id|req_task-&gt;data_phase
suffix:semicolon
id|args.command_type
op_assign
id|req_task-&gt;req_cmd
suffix:semicolon
id|drive-&gt;io_32bit
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|req_task-&gt;data_phase
)paren
(brace
r_case
id|TASKFILE_OUT_DMAQ
suffix:colon
r_case
id|TASKFILE_OUT_DMA
suffix:colon
id|err
op_assign
id|ide_diag_taskfile
c_func
(paren
id|drive
comma
op_amp
id|args
comma
id|taskout
comma
id|outbuf
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TASKFILE_IN_DMAQ
suffix:colon
r_case
id|TASKFILE_IN_DMA
suffix:colon
id|err
op_assign
id|ide_diag_taskfile
c_func
(paren
id|drive
comma
op_amp
id|args
comma
id|taskin
comma
id|inbuf
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TASKFILE_MULTI_OUT
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|drive-&gt;mult_count
)paren
(brace
multiline_comment|/* (hs): give up if multcount is not set */
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: %s Multimode Write &quot;
"&bslash;"
l_string|&quot;multcount is not set&bslash;n&quot;
comma
id|drive-&gt;name
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EPERM
suffix:semicolon
r_goto
m_abort
suffix:semicolon
)brace
multiline_comment|/* fall through */
r_case
id|TASKFILE_OUT
suffix:colon
id|args.prehandler
op_assign
op_amp
id|pre_task_out_intr
suffix:semicolon
id|args.handler
op_assign
op_amp
id|task_out_intr
suffix:semicolon
id|err
op_assign
id|ide_diag_taskfile
c_func
(paren
id|drive
comma
op_amp
id|args
comma
id|taskout
comma
id|outbuf
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TASKFILE_MULTI_IN
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|drive-&gt;mult_count
)paren
(brace
multiline_comment|/* (hs): give up if multcount is not set */
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: %s Multimode Read failure &quot;
"&bslash;"
l_string|&quot;multcount is not set&bslash;n&quot;
comma
id|drive-&gt;name
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EPERM
suffix:semicolon
r_goto
m_abort
suffix:semicolon
)brace
multiline_comment|/* fall through */
r_case
id|TASKFILE_IN
suffix:colon
id|args.handler
op_assign
op_amp
id|task_in_intr
suffix:semicolon
id|err
op_assign
id|ide_diag_taskfile
c_func
(paren
id|drive
comma
op_amp
id|args
comma
id|taskin
comma
id|inbuf
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TASKFILE_NO_DATA
suffix:colon
id|args.handler
op_assign
op_amp
id|task_no_data_intr
suffix:semicolon
id|err
op_assign
id|ide_diag_taskfile
c_func
(paren
id|drive
comma
op_amp
id|args
comma
l_int|0
comma
l_int|NULL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|err
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
m_abort
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|req_task-&gt;io_ports
comma
op_amp
(paren
id|args.tfRegister
)paren
comma
id|HDIO_DRIVE_TASK_HDR_SIZE
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|req_task-&gt;hob_ports
comma
op_amp
(paren
id|args.hobRegister
)paren
comma
id|HDIO_DRIVE_HOB_HDR_SIZE
)paren
suffix:semicolon
id|req_task-&gt;in_flags
op_assign
id|args.tf_in_flags
suffix:semicolon
id|req_task-&gt;out_flags
op_assign
id|args.tf_out_flags
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|buf
comma
id|req_task
comma
id|tasksize
)paren
)paren
(brace
id|err
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
m_abort
suffix:semicolon
)brace
r_if
c_cond
(paren
id|taskout
)paren
(brace
r_int
id|outtotal
op_assign
id|tasksize
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|buf
op_plus
id|outtotal
comma
id|outbuf
comma
id|taskout
)paren
)paren
(brace
id|err
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
m_abort
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|taskin
)paren
(brace
r_int
id|intotal
op_assign
id|tasksize
op_plus
id|taskout
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|buf
op_plus
id|intotal
comma
id|inbuf
comma
id|taskin
)paren
)paren
(brace
id|err
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
m_abort
suffix:semicolon
)brace
)brace
m_abort
suffix:colon
id|kfree
c_func
(paren
id|req_task
)paren
suffix:semicolon
r_if
c_cond
(paren
id|outbuf
op_ne
l_int|NULL
)paren
id|kfree
c_func
(paren
id|outbuf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inbuf
op_ne
l_int|NULL
)paren
id|kfree
c_func
(paren
id|inbuf
)paren
suffix:semicolon
singleline_comment|//&t;printk(&quot;IDE Taskfile ioctl ended. rc = %i&bslash;n&quot;, err);
id|drive-&gt;io_32bit
op_assign
id|io_32bit
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|ide_wait_cmd
r_int
id|ide_wait_cmd
(paren
id|ide_drive_t
op_star
id|drive
comma
id|u8
id|cmd
comma
id|u8
id|nsect
comma
id|u8
id|feature
comma
id|u8
id|sectors
comma
id|u8
op_star
id|buf
)paren
(brace
r_struct
id|request
id|rq
suffix:semicolon
id|u8
id|buffer
(braket
l_int|4
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|buf
)paren
id|buf
op_assign
id|buffer
suffix:semicolon
id|memset
c_func
(paren
id|buf
comma
l_int|0
comma
l_int|4
op_plus
id|SECTOR_WORDS
op_star
l_int|4
op_star
id|sectors
)paren
suffix:semicolon
id|ide_init_drive_cmd
c_func
(paren
op_amp
id|rq
)paren
suffix:semicolon
id|rq.buffer
op_assign
id|buf
suffix:semicolon
op_star
id|buf
op_increment
op_assign
id|cmd
suffix:semicolon
op_star
id|buf
op_increment
op_assign
id|nsect
suffix:semicolon
op_star
id|buf
op_increment
op_assign
id|feature
suffix:semicolon
op_star
id|buf
op_increment
op_assign
id|sectors
suffix:semicolon
r_return
id|ide_do_drive_cmd
c_func
(paren
id|drive
comma
op_amp
id|rq
comma
id|ide_wait
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * FIXME : this needs to map into at taskfile. &lt;andre@linux-ide.org&gt;&n; */
DECL|function|ide_cmd_ioctl
r_int
id|ide_cmd_ioctl
(paren
id|ide_drive_t
op_star
id|drive
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_int
id|err
op_assign
l_int|0
suffix:semicolon
id|u8
id|args
(braket
l_int|4
)braket
comma
op_star
id|argbuf
op_assign
id|args
suffix:semicolon
id|u8
id|xfer_rate
op_assign
l_int|0
suffix:semicolon
r_int
id|argsize
op_assign
l_int|4
suffix:semicolon
id|ide_task_t
id|tfargs
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_eq
(paren
r_void
op_star
)paren
id|arg
)paren
(brace
r_struct
id|request
id|rq
suffix:semicolon
id|ide_init_drive_cmd
c_func
(paren
op_amp
id|rq
)paren
suffix:semicolon
r_return
id|ide_do_drive_cmd
c_func
(paren
id|drive
comma
op_amp
id|rq
comma
id|ide_wait
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|args
comma
(paren
r_void
id|__user
op_star
)paren
id|arg
comma
l_int|4
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|tfargs
comma
l_int|0
comma
r_sizeof
(paren
id|ide_task_t
)paren
)paren
suffix:semicolon
id|tfargs.tfRegister
(braket
id|IDE_FEATURE_OFFSET
)braket
op_assign
id|args
(braket
l_int|2
)braket
suffix:semicolon
id|tfargs.tfRegister
(braket
id|IDE_NSECTOR_OFFSET
)braket
op_assign
id|args
(braket
l_int|3
)braket
suffix:semicolon
id|tfargs.tfRegister
(braket
id|IDE_SECTOR_OFFSET
)braket
op_assign
id|args
(braket
l_int|1
)braket
suffix:semicolon
id|tfargs.tfRegister
(braket
id|IDE_LCYL_OFFSET
)braket
op_assign
l_int|0x00
suffix:semicolon
id|tfargs.tfRegister
(braket
id|IDE_HCYL_OFFSET
)braket
op_assign
l_int|0x00
suffix:semicolon
id|tfargs.tfRegister
(braket
id|IDE_SELECT_OFFSET
)braket
op_assign
l_int|0x00
suffix:semicolon
id|tfargs.tfRegister
(braket
id|IDE_COMMAND_OFFSET
)braket
op_assign
id|args
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|args
(braket
l_int|3
)braket
)paren
(brace
id|argsize
op_assign
l_int|4
op_plus
(paren
id|SECTOR_WORDS
op_star
l_int|4
op_star
id|args
(braket
l_int|3
)braket
)paren
suffix:semicolon
id|argbuf
op_assign
id|kmalloc
c_func
(paren
id|argsize
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|argbuf
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memcpy
c_func
(paren
id|argbuf
comma
id|args
comma
l_int|4
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|set_transfer
c_func
(paren
id|drive
comma
op_amp
id|tfargs
)paren
)paren
(brace
id|xfer_rate
op_assign
id|args
(braket
l_int|1
)braket
suffix:semicolon
r_if
c_cond
(paren
id|ide_ata66_check
c_func
(paren
id|drive
comma
op_amp
id|tfargs
)paren
)paren
r_goto
m_abort
suffix:semicolon
)brace
id|err
op_assign
id|ide_wait_cmd
c_func
(paren
id|drive
comma
id|args
(braket
l_int|0
)braket
comma
id|args
(braket
l_int|1
)braket
comma
id|args
(braket
l_int|2
)braket
comma
id|args
(braket
l_int|3
)braket
comma
id|argbuf
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|err
op_logical_and
id|xfer_rate
)paren
(brace
multiline_comment|/* active-retuning-calls future */
id|ide_set_xfer_rate
c_func
(paren
id|drive
comma
id|xfer_rate
)paren
suffix:semicolon
id|ide_driveid_update
c_func
(paren
id|drive
)paren
suffix:semicolon
)brace
m_abort
suffix:colon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
(paren
r_void
id|__user
op_star
)paren
id|arg
comma
id|argbuf
comma
id|argsize
)paren
)paren
id|err
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|argsize
OG
l_int|4
)paren
id|kfree
c_func
(paren
id|argbuf
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|ide_wait_cmd_task
r_static
r_int
id|ide_wait_cmd_task
c_func
(paren
id|ide_drive_t
op_star
id|drive
comma
id|u8
op_star
id|buf
)paren
(brace
r_struct
id|request
id|rq
suffix:semicolon
id|ide_init_drive_cmd
c_func
(paren
op_amp
id|rq
)paren
suffix:semicolon
id|rq.flags
op_assign
id|REQ_DRIVE_TASK
suffix:semicolon
id|rq.buffer
op_assign
id|buf
suffix:semicolon
r_return
id|ide_do_drive_cmd
c_func
(paren
id|drive
comma
op_amp
id|rq
comma
id|ide_wait
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * FIXME : this needs to map into at taskfile. &lt;andre@linux-ide.org&gt;&n; */
DECL|function|ide_task_ioctl
r_int
id|ide_task_ioctl
(paren
id|ide_drive_t
op_star
id|drive
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_void
id|__user
op_star
id|p
op_assign
(paren
r_void
id|__user
op_star
)paren
id|arg
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
id|u8
id|args
(braket
l_int|7
)braket
comma
op_star
id|argbuf
op_assign
id|args
suffix:semicolon
r_int
id|argsize
op_assign
l_int|7
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|args
comma
id|p
comma
l_int|7
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|err
op_assign
id|ide_wait_cmd_task
c_func
(paren
id|drive
comma
id|argbuf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|p
comma
id|argbuf
comma
id|argsize
)paren
)paren
id|err
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*&n; * NOTICE: This is additions from IBM to provide a discrete interface,&n; * for selective taskregister access operations.  Nice JOB Klaus!!!&n; * Glad to be able to work and co-develop this with you and IBM.&n; */
DECL|function|flagged_taskfile
id|ide_startstop_t
id|flagged_taskfile
(paren
id|ide_drive_t
op_star
id|drive
comma
id|ide_task_t
op_star
id|task
)paren
(brace
id|ide_hwif_t
op_star
id|hwif
op_assign
id|HWIF
c_func
(paren
id|drive
)paren
suffix:semicolon
id|task_struct_t
op_star
id|taskfile
op_assign
(paren
id|task_struct_t
op_star
)paren
id|task-&gt;tfRegister
suffix:semicolon
id|hob_struct_t
op_star
id|hobfile
op_assign
(paren
id|hob_struct_t
op_star
)paren
id|task-&gt;hobRegister
suffix:semicolon
macro_line|#if DEBUG_TASKFILE
id|u8
id|status
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|task-&gt;data_phase
op_eq
id|TASKFILE_MULTI_IN
op_logical_or
id|task-&gt;data_phase
op_eq
id|TASKFILE_MULTI_OUT
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|drive-&gt;mult_count
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: multimode not set!&bslash;n&quot;
comma
id|drive-&gt;name
)paren
suffix:semicolon
r_return
id|ide_stopped
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t; * (ks) Check taskfile in/out flags.&n;&t; * If set, then execute as it is defined.&n;&t; * If not set, then define default settings.&n;&t; * The default values are:&n;&t; *&t;write and read all taskfile registers (except data) &n;&t; *&t;write and read the hob registers (sector,nsector,lcyl,hcyl)&n;&t; */
r_if
c_cond
(paren
id|task-&gt;tf_out_flags.all
op_eq
l_int|0
)paren
(brace
id|task-&gt;tf_out_flags.all
op_assign
id|IDE_TASKFILE_STD_OUT_FLAGS
suffix:semicolon
r_if
c_cond
(paren
id|drive-&gt;addressing
op_eq
l_int|1
)paren
id|task-&gt;tf_out_flags.all
op_or_assign
(paren
id|IDE_HOB_STD_OUT_FLAGS
op_lshift
l_int|8
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|task-&gt;tf_in_flags.all
op_eq
l_int|0
)paren
(brace
id|task-&gt;tf_in_flags.all
op_assign
id|IDE_TASKFILE_STD_IN_FLAGS
suffix:semicolon
r_if
c_cond
(paren
id|drive-&gt;addressing
op_eq
l_int|1
)paren
id|task-&gt;tf_in_flags.all
op_or_assign
(paren
id|IDE_HOB_STD_IN_FLAGS
op_lshift
l_int|8
)paren
suffix:semicolon
)brace
multiline_comment|/* ALL Command Block Executions SHALL clear nIEN, unless otherwise */
r_if
c_cond
(paren
id|IDE_CONTROL_REG
)paren
multiline_comment|/* clear nIEN */
id|hwif
op_member_access_from_pointer
id|OUTB
c_func
(paren
id|drive-&gt;ctl
comma
id|IDE_CONTROL_REG
)paren
suffix:semicolon
id|SELECT_MASK
c_func
(paren
id|drive
comma
l_int|0
)paren
suffix:semicolon
macro_line|#if DEBUG_TASKFILE
id|status
op_assign
id|hwif
op_member_access_from_pointer
id|INB
c_func
(paren
id|IDE_STATUS_REG
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
l_int|0x80
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;flagged_taskfile -&gt; Bad status. Status = %02x. wait 100 usec ...&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
id|status
op_assign
id|hwif
op_member_access_from_pointer
id|INB
c_func
(paren
id|IDE_STATUS_REG
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;flagged_taskfile -&gt; Status = %02x&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|task-&gt;tf_out_flags.b.data
)paren
(brace
id|u16
id|data
op_assign
id|taskfile-&gt;data
op_plus
(paren
id|hobfile-&gt;data
op_lshift
l_int|8
)paren
suffix:semicolon
id|hwif
op_member_access_from_pointer
id|OUTW
c_func
(paren
id|data
comma
id|IDE_DATA_REG
)paren
suffix:semicolon
)brace
multiline_comment|/* (ks) send hob registers first */
r_if
c_cond
(paren
id|task-&gt;tf_out_flags.b.nsector_hob
)paren
id|hwif
op_member_access_from_pointer
id|OUTB
c_func
(paren
id|hobfile-&gt;sector_count
comma
id|IDE_NSECTOR_REG
)paren
suffix:semicolon
r_if
c_cond
(paren
id|task-&gt;tf_out_flags.b.sector_hob
)paren
id|hwif
op_member_access_from_pointer
id|OUTB
c_func
(paren
id|hobfile-&gt;sector_number
comma
id|IDE_SECTOR_REG
)paren
suffix:semicolon
r_if
c_cond
(paren
id|task-&gt;tf_out_flags.b.lcyl_hob
)paren
id|hwif
op_member_access_from_pointer
id|OUTB
c_func
(paren
id|hobfile-&gt;low_cylinder
comma
id|IDE_LCYL_REG
)paren
suffix:semicolon
r_if
c_cond
(paren
id|task-&gt;tf_out_flags.b.hcyl_hob
)paren
id|hwif
op_member_access_from_pointer
id|OUTB
c_func
(paren
id|hobfile-&gt;high_cylinder
comma
id|IDE_HCYL_REG
)paren
suffix:semicolon
multiline_comment|/* (ks) Send now the standard registers */
r_if
c_cond
(paren
id|task-&gt;tf_out_flags.b.error_feature
)paren
id|hwif
op_member_access_from_pointer
id|OUTB
c_func
(paren
id|taskfile-&gt;feature
comma
id|IDE_FEATURE_REG
)paren
suffix:semicolon
multiline_comment|/* refers to number of sectors to transfer */
r_if
c_cond
(paren
id|task-&gt;tf_out_flags.b.nsector
)paren
id|hwif
op_member_access_from_pointer
id|OUTB
c_func
(paren
id|taskfile-&gt;sector_count
comma
id|IDE_NSECTOR_REG
)paren
suffix:semicolon
multiline_comment|/* refers to sector offset or start sector */
r_if
c_cond
(paren
id|task-&gt;tf_out_flags.b.sector
)paren
id|hwif
op_member_access_from_pointer
id|OUTB
c_func
(paren
id|taskfile-&gt;sector_number
comma
id|IDE_SECTOR_REG
)paren
suffix:semicolon
r_if
c_cond
(paren
id|task-&gt;tf_out_flags.b.lcyl
)paren
id|hwif
op_member_access_from_pointer
id|OUTB
c_func
(paren
id|taskfile-&gt;low_cylinder
comma
id|IDE_LCYL_REG
)paren
suffix:semicolon
r_if
c_cond
(paren
id|task-&gt;tf_out_flags.b.hcyl
)paren
id|hwif
op_member_access_from_pointer
id|OUTB
c_func
(paren
id|taskfile-&gt;high_cylinder
comma
id|IDE_HCYL_REG
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * (ks) In the flagged taskfile approch, we will used all specified&n;&t; * registers and the register value will not be changed. Except the&n;&t; * select bit (master/slave) in the drive_head register. We must make&n;&t; * sure that the desired drive is selected.&n;&t; */
id|hwif
op_member_access_from_pointer
id|OUTB
c_func
(paren
id|taskfile-&gt;device_head
op_or
id|drive-&gt;select.all
comma
id|IDE_SELECT_REG
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|task-&gt;data_phase
)paren
(brace
r_case
id|TASKFILE_OUT_DMAQ
suffix:colon
r_case
id|TASKFILE_OUT_DMA
suffix:colon
r_case
id|TASKFILE_IN_DMAQ
suffix:colon
r_case
id|TASKFILE_IN_DMA
suffix:colon
id|hwif
op_member_access_from_pointer
id|dma_setup
c_func
(paren
id|drive
)paren
suffix:semicolon
id|hwif
op_member_access_from_pointer
id|dma_exec_cmd
c_func
(paren
id|drive
comma
id|taskfile-&gt;command
)paren
suffix:semicolon
id|hwif
op_member_access_from_pointer
id|dma_start
c_func
(paren
id|drive
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
r_if
c_cond
(paren
id|task-&gt;handler
op_eq
l_int|NULL
)paren
r_return
id|ide_stopped
suffix:semicolon
multiline_comment|/* Issue the command */
r_if
c_cond
(paren
id|task-&gt;prehandler
)paren
(brace
id|hwif
op_member_access_from_pointer
id|OUTBSYNC
c_func
(paren
id|drive
comma
id|taskfile-&gt;command
comma
id|IDE_COMMAND_REG
)paren
suffix:semicolon
id|ndelay
c_func
(paren
l_int|400
)paren
suffix:semicolon
multiline_comment|/* FIXME */
r_return
id|task
op_member_access_from_pointer
id|prehandler
c_func
(paren
id|drive
comma
id|task-&gt;rq
)paren
suffix:semicolon
)brace
id|ide_execute_command
c_func
(paren
id|drive
comma
id|taskfile-&gt;command
comma
id|task-&gt;handler
comma
id|WAIT_WORSTCASE
comma
l_int|NULL
)paren
suffix:semicolon
)brace
r_return
id|ide_started
suffix:semicolon
)brace
eof
