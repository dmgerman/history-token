multiline_comment|/*&n; * linux/drivers/ide/ide-geometry.c&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/ide.h&gt;
macro_line|#include &lt;linux/mc146818rtc.h&gt;
macro_line|#include &lt;asm/io.h&gt;
r_extern
r_int
r_int
id|current_capacity
(paren
id|ide_drive_t
op_star
)paren
suffix:semicolon
multiline_comment|/*&n; * If heads is nonzero: find a translation with this many heads and S=63.&n; * Otherwise: find out how OnTrack Disk Manager would translate the disk.&n; */
DECL|function|ontrack
r_static
r_void
id|ontrack
c_func
(paren
id|ide_drive_t
op_star
id|drive
comma
r_int
id|heads
comma
r_int
r_int
op_star
id|c
comma
r_int
op_star
id|h
comma
r_int
op_star
id|s
)paren
(brace
r_static
r_const
id|u8
id|dm_head_vals
(braket
)braket
op_assign
(brace
l_int|4
comma
l_int|8
comma
l_int|16
comma
l_int|32
comma
l_int|64
comma
l_int|128
comma
l_int|255
comma
l_int|0
)brace
suffix:semicolon
r_const
id|u8
op_star
id|headp
op_assign
id|dm_head_vals
suffix:semicolon
r_int
r_int
id|total
suffix:semicolon
multiline_comment|/*&n;&t; * The specs say: take geometry as obtained from Identify,&n;&t; * compute total capacity C*H*S from that, and truncate to&n;&t; * 1024*255*63. Now take S=63, H the first in the sequence&n;&t; * 4, 8, 16, 32, 64, 128, 255 such that 63*H*1024 &gt;= total.&n;&t; * [Please tell aeb@cwi.nl in case this computes a&n;&t; * geometry different from what OnTrack uses.]&n;&t; */
id|total
op_assign
id|DRIVER
c_func
(paren
id|drive
)paren
op_member_access_from_pointer
id|capacity
c_func
(paren
id|drive
)paren
suffix:semicolon
op_star
id|s
op_assign
l_int|63
suffix:semicolon
r_if
c_cond
(paren
id|heads
)paren
(brace
op_star
id|h
op_assign
id|heads
suffix:semicolon
op_star
id|c
op_assign
id|total
op_div
(paren
l_int|63
op_star
id|heads
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_while
c_loop
(paren
l_int|63
op_star
id|headp
(braket
l_int|0
)braket
op_star
l_int|1024
OL
id|total
op_logical_and
id|headp
(braket
l_int|1
)braket
op_ne
l_int|0
)paren
id|headp
op_increment
suffix:semicolon
op_star
id|h
op_assign
id|headp
(braket
l_int|0
)braket
suffix:semicolon
op_star
id|c
op_assign
id|total
op_div
(paren
l_int|63
op_star
id|headp
(braket
l_int|0
)braket
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * This routine is called from the partition-table code in pt/msdos.c.&n; * It has two tasks:&n; * (i) to handle Ontrack DiskManager by offsetting everything by 63 sectors,&n; *  or to handle EZdrive by remapping sector 0 to sector 1.&n; * (ii) to invent a translated geometry.&n; * Part (i) is suppressed if the user specifies the &quot;noremap&quot; option&n; * on the command line.&n; * Part (ii) is suppressed if the user specifies an explicit geometry.&n; *&n; * The ptheads parameter is either 0 or tells about the number of&n; * heads shown by the end of the first nonempty partition.&n; * If this is either 16, 32, 64, 128, 240 or 255 we&squot;ll believe it.&n; *&n; * The xparm parameter has the following meaning:&n; *&t; 0 = convert to CHS with fewer than 1024 cyls&n; *&t;     using the same method as Ontrack DiskManager.&n; *&t; 1 = same as &quot;0&quot;, plus offset everything by 63 sectors.&n; *&t;-1 = similar to &quot;0&quot;, plus redirect sector 0 to sector 1.&n; *&t; 2 = convert to a CHS geometry with &quot;ptheads&quot; heads.&n; *&n; * Returns 0 if the translation was not possible, if the device was not &n; * an IDE disk drive, or if a geometry was &quot;forced&quot; on the commandline.&n; * Returns 1 if the geometry translation was successful.&n; */
DECL|function|ide_xlate_1024
r_int
id|ide_xlate_1024
(paren
r_struct
id|block_device
op_star
id|bdev
comma
r_int
id|xparm
comma
r_int
id|ptheads
comma
r_const
r_char
op_star
id|msg
)paren
(brace
id|ide_drive_t
op_star
id|drive
op_assign
id|bdev-&gt;bd_disk-&gt;private_data
suffix:semicolon
r_const
r_char
op_star
id|msg1
op_assign
l_string|&quot;&quot;
suffix:semicolon
r_int
id|heads
op_assign
l_int|0
suffix:semicolon
r_int
id|c
comma
id|h
comma
id|s
suffix:semicolon
r_int
id|transl
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* try translation */
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* remap? */
r_if
c_cond
(paren
id|drive-&gt;remap_0_to_1
op_ne
l_int|2
)paren
(brace
r_if
c_cond
(paren
id|xparm
op_eq
l_int|1
)paren
(brace
multiline_comment|/* DM */
id|drive-&gt;sect0
op_assign
l_int|63
suffix:semicolon
id|msg1
op_assign
l_string|&quot; [remap +63]&quot;
suffix:semicolon
id|ret
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|xparm
op_eq
op_minus
l_int|1
)paren
(brace
multiline_comment|/* EZ-Drive */
r_if
c_cond
(paren
id|drive-&gt;remap_0_to_1
op_eq
l_int|0
)paren
(brace
id|drive-&gt;remap_0_to_1
op_assign
l_int|1
suffix:semicolon
id|msg1
op_assign
l_string|&quot; [remap 0-&gt;1]&quot;
suffix:semicolon
id|ret
op_assign
l_int|1
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* There used to be code here that assigned drive-&gt;id-&gt;CHS&n;&t;   to drive-&gt;CHS and that to drive-&gt;bios_CHS. However,&n;&t;   some disks have id-&gt;C/H/S = 4092/16/63 but are larger than 2.1 GB.&n;&t;   In such cases that code was wrong.  Moreover,&n;&t;   there seems to be no reason to do any of these things. */
multiline_comment|/* translate? */
r_if
c_cond
(paren
id|drive-&gt;forced_geom
)paren
id|transl
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* does ptheads look reasonable? */
r_if
c_cond
(paren
id|ptheads
op_eq
l_int|32
op_logical_or
id|ptheads
op_eq
l_int|64
op_logical_or
id|ptheads
op_eq
l_int|128
op_logical_or
id|ptheads
op_eq
l_int|240
op_logical_or
id|ptheads
op_eq
l_int|255
)paren
id|heads
op_assign
id|ptheads
suffix:semicolon
r_if
c_cond
(paren
id|xparm
op_eq
l_int|2
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|heads
op_logical_or
(paren
id|drive-&gt;bios_head
op_ge
id|heads
op_logical_and
id|drive-&gt;bios_sect
op_eq
l_int|63
)paren
)paren
id|transl
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|xparm
op_eq
op_minus
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|drive-&gt;bios_head
OG
l_int|16
)paren
id|transl
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* we already have a translation */
)brace
r_if
c_cond
(paren
id|transl
)paren
(brace
id|ontrack
c_func
(paren
id|drive
comma
id|heads
comma
op_amp
id|c
comma
op_amp
id|h
comma
op_amp
id|s
)paren
suffix:semicolon
id|drive-&gt;bios_cyl
op_assign
id|c
suffix:semicolon
id|drive-&gt;bios_head
op_assign
id|h
suffix:semicolon
id|drive-&gt;bios_sect
op_assign
id|s
suffix:semicolon
id|ret
op_assign
l_int|1
suffix:semicolon
)brace
id|set_capacity
c_func
(paren
id|drive-&gt;disk
comma
id|current_capacity
c_func
(paren
id|drive
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s%s [%d/%d/%d]&quot;
comma
id|msg
comma
id|msg1
comma
id|drive-&gt;bios_cyl
comma
id|drive-&gt;bios_head
comma
id|drive-&gt;bios_sect
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
eof
