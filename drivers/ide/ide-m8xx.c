multiline_comment|/*&n; *  linux/drivers/ide/ide-m8xx.c&n; *&n; *  Copyright (C) 2000, 2001 Wolfgang Denk, wd@denx.de&n; *  Modified for direct IDE interface&n; *&t;by Thomas Lange, thomas@corelatus.com&n; *  Modified for direct IDE interface on 8xx without using the PCMCIA&n; *  controller&n; *&t;by Steven.Scholz@imc-berlin.de&n; *  Moved out of arch/ppc/kernel/m8xx_setup.c, other minor cleanups&n; *&t;by Mathew Locke &lt;mattl@mvista.com&gt;&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/stddef.h&gt;
macro_line|#include &lt;linux/unistd.h&gt;
macro_line|#include &lt;linux/ptrace.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/user.h&gt;
macro_line|#include &lt;linux/a.out.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/major.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/reboot.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/blk.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/bootmem.h&gt;
macro_line|#include &lt;linux/hdreg.h&gt;
macro_line|#include &lt;linux/ide.h&gt;
macro_line|#include &lt;asm/mpc8xx.h&gt;
macro_line|#include &lt;asm/mmu.h&gt;
macro_line|#include &lt;asm/processor.h&gt;
macro_line|#include &lt;asm/residual.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/ide.h&gt;
macro_line|#include &lt;asm/8xx_immap.h&gt;
macro_line|#include &lt;asm/machdep.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &quot;timing.h&quot;
r_static
r_int
id|identify
(paren
r_volatile
r_int
r_char
op_star
id|p
)paren
suffix:semicolon
r_static
r_void
id|print_fixed
(paren
r_volatile
r_int
r_char
op_star
id|p
)paren
suffix:semicolon
r_static
r_void
id|print_funcid
(paren
r_int
id|func
)paren
suffix:semicolon
r_static
r_int
id|check_ide_device
(paren
r_int
r_int
id|base
)paren
suffix:semicolon
r_static
r_int
id|ide_interrupt_ack
c_func
(paren
r_struct
id|ata_channel
op_star
)paren
suffix:semicolon
r_static
r_void
id|m8xx_ide_tuneproc
c_func
(paren
r_struct
id|ata_device
op_star
id|drive
comma
id|u8
id|pio
)paren
suffix:semicolon
DECL|struct|ide_ioport_desc
r_typedef
r_struct
id|ide_ioport_desc
(brace
DECL|member|base_off
r_int
r_int
id|base_off
suffix:semicolon
multiline_comment|/* Offset to PCMCIA memory&t;*/
DECL|member|reg_off
id|ide_ioreg_t
id|reg_off
(braket
id|IDE_NR_PORTS
)braket
suffix:semicolon
multiline_comment|/* controller register offsets&t;*/
DECL|member|irq
r_int
id|irq
suffix:semicolon
multiline_comment|/* IRQ&t;&t;&t;&t;*/
DECL|typedef|ide_ioport_desc_t
)brace
id|ide_ioport_desc_t
suffix:semicolon
DECL|variable|ioport_dsc
id|ide_ioport_desc_t
id|ioport_dsc
(braket
id|MAX_HWIFS
)braket
op_assign
(brace
macro_line|#ifdef IDE0_BASE_OFFSET
(brace
id|IDE0_BASE_OFFSET
comma
(brace
id|IDE0_DATA_REG_OFFSET
comma
id|IDE0_ERROR_REG_OFFSET
comma
id|IDE0_NSECTOR_REG_OFFSET
comma
id|IDE0_SECTOR_REG_OFFSET
comma
id|IDE0_LCYL_REG_OFFSET
comma
id|IDE0_HCYL_REG_OFFSET
comma
id|IDE0_SELECT_REG_OFFSET
comma
id|IDE0_STATUS_REG_OFFSET
comma
id|IDE0_CONTROL_REG_OFFSET
comma
id|IDE0_IRQ_REG_OFFSET
comma
)brace
comma
id|IDE0_INTERRUPT
comma
)brace
comma
macro_line|#ifdef IDE1_BASE_OFFSET
(brace
id|IDE1_BASE_OFFSET
comma
(brace
id|IDE1_DATA_REG_OFFSET
comma
id|IDE1_ERROR_REG_OFFSET
comma
id|IDE1_NSECTOR_REG_OFFSET
comma
id|IDE1_SECTOR_REG_OFFSET
comma
id|IDE1_LCYL_REG_OFFSET
comma
id|IDE1_HCYL_REG_OFFSET
comma
id|IDE1_SELECT_REG_OFFSET
comma
id|IDE1_STATUS_REG_OFFSET
comma
id|IDE1_CONTROL_REG_OFFSET
comma
id|IDE1_IRQ_REG_OFFSET
comma
)brace
comma
id|IDE1_INTERRUPT
comma
)brace
comma
macro_line|#endif /* IDE1_BASE_OFFSET */
macro_line|#endif&t;/* IDE0_BASE_OFFSET */
)brace
suffix:semicolon
DECL|struct|ide_pio_timings_s
r_typedef
r_struct
id|ide_pio_timings_s
(brace
DECL|member|setup_time
r_int
id|setup_time
suffix:semicolon
multiline_comment|/* Address setup (ns) minimum */
DECL|member|active_time
r_int
id|active_time
suffix:semicolon
multiline_comment|/* Active pulse (ns) minimum */
DECL|member|cycle_time
r_int
id|cycle_time
suffix:semicolon
multiline_comment|/* Cycle time (ns) minimum = (setup + active + recovery) */
DECL|typedef|ide_pio_timings_t
)brace
id|ide_pio_timings_t
suffix:semicolon
DECL|variable|ide_pio_clocks
id|ide_pio_timings_t
id|ide_pio_clocks
(braket
l_int|6
)braket
suffix:semicolon
DECL|variable|hold_time
r_int
id|hold_time
(braket
l_int|6
)braket
op_assign
(brace
l_int|30
comma
l_int|20
comma
l_int|15
comma
l_int|10
comma
l_int|10
comma
l_int|10
)brace
suffix:semicolon
multiline_comment|/* PIO Mode 5 with IORDY (nonstandard) */
multiline_comment|/*&n; * Warning: only 1 (ONE) PCMCIA slot supported here,&n; * which must be correctly initialized by the firmware (PPCBoot).&n; */
DECL|variable|_slot_
r_static
r_int
id|_slot_
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* will be read from PCMCIA registers   */
multiline_comment|/* Make clock cycles and always round up */
DECL|macro|PCMCIA_MK_CLKS
mdefine_line|#define PCMCIA_MK_CLKS( t, T ) (( (t) * ((T)/1000000) + 999U ) / 1000U )
multiline_comment|/*&n; * IDE stuff.&n; */
r_static
r_int
DECL|function|m8xx_ide_default_irq
id|m8xx_ide_default_irq
c_func
(paren
id|ide_ioreg_t
id|base
)paren
(brace
macro_line|#ifdef CONFIG_BLK_DEV_MPC8xx_IDE
r_if
c_cond
(paren
id|base
op_ge
id|MAX_HWIFS
)paren
r_return
l_int|0
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;[%d] m8xx_ide_default_irq %d&bslash;n&quot;
comma
id|__LINE__
comma
id|ioport_dsc
(braket
id|base
)braket
dot
id|irq
)paren
suffix:semicolon
r_return
(paren
id|ioport_dsc
(braket
id|base
)braket
dot
id|irq
)paren
suffix:semicolon
macro_line|#else
r_return
l_int|9
suffix:semicolon
macro_line|#endif
)brace
r_static
id|ide_ioreg_t
DECL|function|m8xx_ide_default_io_base
id|m8xx_ide_default_io_base
c_func
(paren
r_int
id|index
)paren
(brace
r_return
id|index
suffix:semicolon
)brace
DECL|macro|M8XX_PCMCIA_CD2
mdefine_line|#define M8XX_PCMCIA_CD2(slot)      (0x10000000 &gt;&gt; (slot &lt;&lt; 4))
DECL|macro|M8XX_PCMCIA_CD1
mdefine_line|#define M8XX_PCMCIA_CD1(slot)      (0x08000000 &gt;&gt; (slot &lt;&lt; 4))
multiline_comment|/*&n; * The TQM850L hardware has two pins swapped! Grrrrgh!&n; */
macro_line|#ifdef&t;CONFIG_TQM850L
DECL|macro|__MY_PCMCIA_GCRX_CXRESET
mdefine_line|#define __MY_PCMCIA_GCRX_CXRESET&t;PCMCIA_GCRX_CXOE
DECL|macro|__MY_PCMCIA_GCRX_CXOE
mdefine_line|#define __MY_PCMCIA_GCRX_CXOE&t;&t;PCMCIA_GCRX_CXRESET
macro_line|#else
DECL|macro|__MY_PCMCIA_GCRX_CXRESET
mdefine_line|#define __MY_PCMCIA_GCRX_CXRESET&t;PCMCIA_GCRX_CXRESET
DECL|macro|__MY_PCMCIA_GCRX_CXOE
mdefine_line|#define __MY_PCMCIA_GCRX_CXOE&t;&t;PCMCIA_GCRX_CXOE
macro_line|#endif
macro_line|#if defined(CONFIG_BLK_DEV_MPC8xx_IDE) &amp;&amp; defined(CONFIG_IDE_8xx_PCCARD)
DECL|macro|PCMCIA_SCHLVL
mdefine_line|#define PCMCIA_SCHLVL IDE0_INTERRUPT&t;/* Status Change Interrupt Level&t;*/
DECL|variable|pcmcia_schlvl
r_static
r_int
id|pcmcia_schlvl
op_assign
id|PCMCIA_SCHLVL
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n; * See include/linux/ide.h for definition of hw_regs_t (p, base)&n; */
multiline_comment|/*&n; * m8xx_ide_init_hwif_ports for a direct IDE interface _using_&n; */
macro_line|#if defined(CONFIG_IDE_8xx_PCCARD) || defined(CONFIG_IDE_8xx_DIRECT)
r_static
r_void
DECL|function|m8xx_ide_init_hwif_ports
id|m8xx_ide_init_hwif_ports
c_func
(paren
id|hw_regs_t
op_star
id|hw
comma
id|ide_ioreg_t
id|data_port
comma
id|ide_ioreg_t
id|ctrl_port
comma
r_int
op_star
id|irq
)paren
(brace
id|ide_ioreg_t
op_star
id|p
op_assign
id|hw-&gt;io_ports
suffix:semicolon
r_int
id|i
suffix:semicolon
r_typedef
r_struct
(brace
id|ulong
id|br
suffix:semicolon
id|ulong
op_logical_or
suffix:semicolon
)brace
id|pcmcia_win_t
suffix:semicolon
r_volatile
id|pcmcia_win_t
op_star
id|win
suffix:semicolon
r_volatile
id|pcmconf8xx_t
op_star
id|pcmp
suffix:semicolon
id|uint
op_star
id|pgcrx
suffix:semicolon
id|u32
id|pcmcia_phy_base
suffix:semicolon
id|u32
id|pcmcia_phy_end
suffix:semicolon
r_static
r_int
r_int
id|pcmcia_base
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|base
suffix:semicolon
op_star
id|p
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|irq
)paren
op_star
id|irq
op_assign
l_int|0
suffix:semicolon
id|pcmp
op_assign
(paren
id|pcmconf8xx_t
op_star
)paren
(paren
op_amp
(paren
(paren
(paren
id|immap_t
op_star
)paren
id|IMAP_ADDR
)paren
op_member_access_from_pointer
id|im_pcmcia
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pcmcia_base
)paren
(brace
multiline_comment|/*&n;                 * Read out PCMCIA registers. Since the reset values&n;                 * are undefined, we sure hope that they have been&n;                 * set up by firmware&n;&t;&t; */
multiline_comment|/* Scan all registers for valid settings */
id|pcmcia_phy_base
op_assign
l_int|0xFFFFFFFF
suffix:semicolon
id|pcmcia_phy_end
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* br0 is start of brX and orX regs */
id|win
op_assign
(paren
id|pcmcia_win_t
op_star
)paren
"&bslash;"
(paren
op_amp
(paren
(paren
(paren
id|immap_t
op_star
)paren
id|IMAP_ADDR
)paren
op_member_access_from_pointer
id|im_pcmcia.pcmc_pbr0
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|win
op_member_access_from_pointer
op_logical_or
op_amp
l_int|1
)paren
(brace
multiline_comment|/* This bank is marked as valid */
r_if
c_cond
(paren
id|win-&gt;br
OL
id|pcmcia_phy_base
)paren
(brace
id|pcmcia_phy_base
op_assign
id|win-&gt;br
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|win-&gt;br
op_plus
id|PCMCIA_MEM_SIZE
)paren
OG
id|pcmcia_phy_end
)paren
(brace
id|pcmcia_phy_end
op_assign
id|win-&gt;br
op_plus
id|PCMCIA_MEM_SIZE
suffix:semicolon
)brace
multiline_comment|/* Check which slot that has been defined */
id|_slot_
op_assign
(paren
id|win
op_member_access_from_pointer
op_logical_or
op_rshift
l_int|2
)paren
op_amp
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Valid bank */
id|win
op_increment
suffix:semicolon
)brace
multiline_comment|/* for */
id|printk
(paren
l_string|&quot;PCMCIA slot %c: phys mem %08x...%08x (size %08x)&bslash;n&quot;
comma
l_char|&squot;A&squot;
op_plus
id|_slot_
comma
id|pcmcia_phy_base
comma
id|pcmcia_phy_end
comma
id|pcmcia_phy_end
op_minus
id|pcmcia_phy_base
)paren
suffix:semicolon
id|pcmcia_base
op_assign
(paren
r_int
r_int
)paren
id|ioremap
c_func
(paren
id|pcmcia_phy_base
comma
id|pcmcia_phy_end
op_minus
id|pcmcia_phy_base
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
(paren
l_string|&quot;PCMCIA virt base: %08lx&bslash;n&quot;
comma
id|pcmcia_base
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Compute clock cycles for PIO timings */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|6
suffix:semicolon
op_increment
id|i
)paren
(brace
id|bd_t
op_star
id|binfo
op_assign
(paren
id|bd_t
op_star
)paren
id|__res
suffix:semicolon
r_struct
id|ata_timing
op_star
id|t
suffix:semicolon
id|t
op_assign
id|ata_timing_data
c_func
(paren
id|i
op_plus
id|XFER_PIO_0
)paren
suffix:semicolon
id|hold_time
(braket
id|i
)braket
op_assign
id|PCMCIA_MK_CLKS
(paren
id|hold_time
(braket
id|i
)braket
comma
id|binfo-&gt;bi_busfreq
)paren
suffix:semicolon
id|ide_pio_clocks
(braket
id|i
)braket
dot
id|setup_time
op_assign
id|PCMCIA_MK_CLKS
(paren
id|t-&gt;setup
comma
id|binfo-&gt;bi_busfreq
)paren
suffix:semicolon
id|ide_pio_clocks
(braket
id|i
)braket
dot
id|active_time
op_assign
id|PCMCIA_MK_CLKS
(paren
id|t-&gt;active
comma
id|binfo-&gt;bi_busfreq
)paren
suffix:semicolon
id|ide_pio_clocks
(braket
id|i
)braket
dot
id|cycle_time
op_assign
id|PCMCIA_MK_CLKS
(paren
id|t-&gt;cycle
comma
id|binfo-&gt;bi_busfreq
)paren
suffix:semicolon
macro_line|#if 0
id|printk
(paren
l_string|&quot;PIO mode %d timings: %d/%d/%d =&gt; %d/%d/%d&bslash;n&quot;
comma
id|i
comma
id|ide_pio_clocks
(braket
id|i
)braket
dot
id|setup_time
comma
id|ide_pio_clocks
(braket
id|i
)braket
dot
id|active_time
comma
id|ide_pio_clocks
(braket
id|i
)braket
dot
id|hold_time
comma
id|ide_pio_clocks
(braket
id|i
)braket
dot
id|cycle_time
comma
id|t-&gt;setup
comma
id|t-&gt;active
comma
id|hold_time
(braket
id|i
)braket
comma
id|t-&gt;cycle
)paren
suffix:semicolon
macro_line|#endif
)brace
)brace
r_if
c_cond
(paren
id|data_port
op_ge
id|MAX_HWIFS
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|_slot_
op_eq
op_minus
l_int|1
)paren
(brace
id|printk
(paren
l_string|&quot;PCMCIA slot has not been defined! Using A as default&bslash;n&quot;
)paren
suffix:semicolon
id|_slot_
op_assign
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_IDE_8xx_PCCARD
macro_line|#ifdef DEBUG
id|printk
(paren
l_string|&quot;PIPR = 0x%08X  slot %c ==&gt; mask = 0x%X&bslash;n&quot;
comma
id|pcmp-&gt;pcmc_pipr
comma
l_char|&squot;A&squot;
op_plus
id|_slot_
comma
id|M8XX_PCMCIA_CD1
c_func
(paren
id|_slot_
)paren
op_or
id|M8XX_PCMCIA_CD2
c_func
(paren
id|_slot_
)paren
)paren
suffix:semicolon
macro_line|#endif /* DEBUG */
r_if
c_cond
(paren
id|pcmp-&gt;pcmc_pipr
op_amp
(paren
id|M8XX_PCMCIA_CD1
c_func
(paren
id|_slot_
)paren
op_or
id|M8XX_PCMCIA_CD2
c_func
(paren
id|_slot_
)paren
)paren
)paren
(brace
id|printk
(paren
l_string|&quot;No card in slot %c: PIPR=%08x&bslash;n&quot;
comma
l_char|&squot;A&squot;
op_plus
id|_slot_
comma
(paren
id|u32
)paren
id|pcmp-&gt;pcmc_pipr
)paren
suffix:semicolon
r_return
suffix:semicolon
multiline_comment|/* No card in slot */
)brace
id|check_ide_device
(paren
id|pcmcia_base
)paren
suffix:semicolon
macro_line|#endif&t;/* CONFIG_IDE_8xx_PCCARD */
id|base
op_assign
id|pcmcia_base
op_plus
id|ioport_dsc
(braket
id|data_port
)braket
dot
id|base_off
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
(paren
l_string|&quot;base: %08x + %08x = %08x&bslash;n&quot;
comma
id|pcmcia_base
comma
id|ioport_dsc
(braket
id|data_port
)braket
dot
id|base_off
comma
id|base
)paren
suffix:semicolon
macro_line|#endif
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|IDE_NR_PORTS
suffix:semicolon
op_increment
id|i
)paren
(brace
macro_line|#ifdef DEBUG
id|printk
(paren
l_string|&quot;port[%d]: %08x + %08x = %08x&bslash;n&quot;
comma
id|i
comma
id|base
comma
id|ioport_dsc
(braket
id|data_port
)braket
dot
id|reg_off
(braket
id|i
)braket
comma
id|i
comma
id|base
op_plus
id|ioport_dsc
(braket
id|data_port
)braket
dot
id|reg_off
(braket
id|i
)braket
)paren
suffix:semicolon
macro_line|#endif
op_star
id|p
op_increment
op_assign
id|base
op_plus
id|ioport_dsc
(braket
id|data_port
)braket
dot
id|reg_off
(braket
id|i
)braket
suffix:semicolon
)brace
r_if
c_cond
(paren
id|irq
)paren
(brace
macro_line|#ifdef CONFIG_IDE_8xx_PCCARD
r_int
r_int
id|reg
suffix:semicolon
op_star
id|irq
op_assign
id|ioport_dsc
(braket
id|data_port
)braket
dot
id|irq
suffix:semicolon
r_if
c_cond
(paren
id|_slot_
)paren
id|pgcrx
op_assign
op_amp
(paren
(paren
id|immap_t
op_star
)paren
id|IMAP_ADDR
)paren
op_member_access_from_pointer
id|im_pcmcia.pcmc_pgcrb
suffix:semicolon
r_else
id|pgcrx
op_assign
op_amp
(paren
(paren
id|immap_t
op_star
)paren
id|IMAP_ADDR
)paren
op_member_access_from_pointer
id|im_pcmcia.pcmc_pgcra
suffix:semicolon
id|reg
op_assign
op_star
id|pgcrx
suffix:semicolon
id|reg
op_or_assign
id|mk_int_int_mask
(paren
id|pcmcia_schlvl
)paren
op_lshift
l_int|24
suffix:semicolon
id|reg
op_or_assign
id|mk_int_int_mask
(paren
id|pcmcia_schlvl
)paren
op_lshift
l_int|16
suffix:semicolon
op_star
id|pgcrx
op_assign
id|reg
suffix:semicolon
macro_line|#else&t;/* direct connected IDE drive, i.e. external IRQ, not the PCMCIA irq */
op_star
id|irq
op_assign
id|ioport_dsc
(braket
id|data_port
)braket
dot
id|irq
suffix:semicolon
macro_line|#endif&t;/* CONFIG_IDE_8xx_PCCARD */
)brace
multiline_comment|/* register routine to tune PIO mode */
id|ide_hwifs
(braket
id|data_port
)braket
dot
id|tuneproc
op_assign
id|m8xx_ide_tuneproc
suffix:semicolon
id|hw-&gt;ack_intr
op_assign
id|ide_interrupt_ack
suffix:semicolon
multiline_comment|/* Enable Harddisk Interrupt,&n;&t; * and make it edge sensitive&n;&t; */
multiline_comment|/* (11-18) Set edge detect for irq, no wakeup from low power mode */
(paren
(paren
id|immap_t
op_star
)paren
id|IMAP_ADDR
)paren
op_member_access_from_pointer
id|im_siu_conf.sc_siel
op_or_assign
(paren
l_int|0x80000000
op_rshift
id|ioport_dsc
(braket
id|data_port
)braket
dot
id|irq
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_IDE_8xx_PCCARD
multiline_comment|/* Make sure we dont get garbage irq */
(paren
(paren
id|immap_t
op_star
)paren
id|IMAP_ADDR
)paren
op_member_access_from_pointer
id|im_pcmcia.pcmc_pscr
op_assign
l_int|0xFFFF
suffix:semicolon
multiline_comment|/* Enable falling edge irq */
id|pcmp-&gt;pcmc_per
op_assign
l_int|0x100000
op_rshift
(paren
l_int|16
op_star
id|_slot_
)paren
suffix:semicolon
macro_line|#endif&t;/* CONFIG_IDE_8xx_PCCARD */
)brace
multiline_comment|/* m8xx_ide_init_hwif_ports() using 8xx internal PCMCIA interface */
macro_line|#endif /* CONFIG_IDE_8xx_PCCARD || CONFIG_IDE_8xx_DIRECT */
multiline_comment|/*&n; * m8xx_ide_init_hwif_ports for a direct IDE interface _not_ using&n; * MPC8xx&squot;s internal PCMCIA interface&n; */
macro_line|#if defined(CONFIG_IDE_EXT_DIRECT)
DECL|function|m8xx_ide_init_hwif_ports
r_void
id|m8xx_ide_init_hwif_ports
(paren
id|hw_regs_t
op_star
id|hw
comma
id|ide_ioreg_t
id|data_port
comma
id|ide_ioreg_t
id|ctrl_port
comma
r_int
op_star
id|irq
)paren
(brace
id|ide_ioreg_t
op_star
id|p
op_assign
id|hw-&gt;io_ports
suffix:semicolon
r_int
id|i
suffix:semicolon
id|u32
id|ide_phy_base
suffix:semicolon
id|u32
id|ide_phy_end
suffix:semicolon
r_static
r_int
r_int
id|ide_base
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|base
suffix:semicolon
op_star
id|p
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|irq
)paren
op_star
id|irq
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ide_base
)paren
(brace
multiline_comment|/* TODO:&n;&t;&t; * - add code to read ORx, BRx&n;&t;&t; */
id|ide_phy_base
op_assign
id|CFG_ATA_BASE_ADDR
suffix:semicolon
id|ide_phy_end
op_assign
id|CFG_ATA_BASE_ADDR
op_plus
l_int|0x200
suffix:semicolon
id|printk
(paren
l_string|&quot;IDE phys mem : %08x...%08x (size %08x)&bslash;n&quot;
comma
id|ide_phy_base
comma
id|ide_phy_end
comma
id|ide_phy_end
op_minus
id|ide_phy_base
)paren
suffix:semicolon
id|ide_base
op_assign
(paren
r_int
r_int
)paren
id|ioremap
c_func
(paren
id|ide_phy_base
comma
id|ide_phy_end
op_minus
id|ide_phy_base
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
(paren
l_string|&quot;IDE virt base: %08lx&bslash;n&quot;
comma
id|ide_base
)paren
suffix:semicolon
macro_line|#endif
)brace
r_if
c_cond
(paren
id|data_port
op_ge
id|MAX_HWIFS
)paren
r_return
suffix:semicolon
id|base
op_assign
id|ide_base
op_plus
id|ioport_dsc
(braket
id|data_port
)braket
dot
id|base_off
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
(paren
l_string|&quot;base: %08x + %08x = %08x&bslash;n&quot;
comma
id|ide_base
comma
id|ioport_dsc
(braket
id|data_port
)braket
dot
id|base_off
comma
id|base
)paren
suffix:semicolon
macro_line|#endif
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|IDE_NR_PORTS
suffix:semicolon
op_increment
id|i
)paren
(brace
macro_line|#ifdef DEBUG
id|printk
(paren
l_string|&quot;port[%d]: %08x + %08x = %08x&bslash;n&quot;
comma
id|i
comma
id|base
comma
id|ioport_dsc
(braket
id|data_port
)braket
dot
id|reg_off
(braket
id|i
)braket
comma
id|i
comma
id|base
op_plus
id|ioport_dsc
(braket
id|data_port
)braket
dot
id|reg_off
(braket
id|i
)braket
)paren
suffix:semicolon
macro_line|#endif
op_star
id|p
op_increment
op_assign
id|base
op_plus
id|ioport_dsc
(braket
id|data_port
)braket
dot
id|reg_off
(braket
id|i
)braket
suffix:semicolon
)brace
r_if
c_cond
(paren
id|irq
)paren
(brace
multiline_comment|/* direct connected IDE drive, i.e. external IRQ */
op_star
id|irq
op_assign
id|ioport_dsc
(braket
id|data_port
)braket
dot
id|irq
suffix:semicolon
)brace
multiline_comment|/* register routine to tune PIO mode */
id|ide_hwifs
(braket
id|data_port
)braket
dot
id|tuneproc
op_assign
id|m8xx_ide_tuneproc
suffix:semicolon
id|hw-&gt;ack_intr
op_assign
id|ide_interrupt_ack
suffix:semicolon
multiline_comment|/* Enable Harddisk Interrupt,&n;&t; * and make it edge sensitive&n;&t; */
multiline_comment|/* (11-18) Set edge detect for irq, no wakeup from low power mode */
(paren
(paren
id|immap_t
op_star
)paren
id|IMAP_ADDR
)paren
op_member_access_from_pointer
id|im_siu_conf.sc_siel
op_or_assign
(paren
l_int|0x80000000
op_rshift
id|ioport_dsc
(braket
id|data_port
)braket
dot
id|irq
)paren
suffix:semicolon
)brace
multiline_comment|/* m8xx_ide_init_hwif_ports() for CONFIG_IDE_8xx_DIRECT */
macro_line|#endif
multiline_comment|/* -------------------------------------------------------------------- */
multiline_comment|/* PCMCIA Timing */
macro_line|#ifndef&t;PCMCIA_SHT
DECL|macro|PCMCIA_SHT
mdefine_line|#define PCMCIA_SHT(t)&t;((t &amp; 0x0F)&lt;&lt;16)&t;/* Strobe Hold  Time &t;*/
DECL|macro|PCMCIA_SST
mdefine_line|#define PCMCIA_SST(t)&t;((t &amp; 0x0F)&lt;&lt;12)&t;/* Strobe Setup Time&t;*/
DECL|macro|PCMCIA_SL
mdefine_line|#define PCMCIA_SL(t) ((t==32) ? 0 : ((t &amp; 0x1F)&lt;&lt;7)) /* Strobe Length&t;*/
macro_line|#endif
multiline_comment|/* Calculate PIO timings */
r_static
r_void
DECL|function|m8xx_ide_tuneproc
id|m8xx_ide_tuneproc
c_func
(paren
r_struct
id|ata_device
op_star
id|drive
comma
id|u8
id|pio
)paren
(brace
macro_line|#if defined(CONFIG_IDE_8xx_PCCARD) || defined(CONFIG_IDE_8xx_DIRECT)
r_volatile
id|pcmconf8xx_t
op_star
id|pcmp
suffix:semicolon
id|ulong
id|timing
comma
id|mask
comma
id|reg
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|pio
op_eq
l_int|255
)paren
id|pio
op_assign
id|ata_timing_mode
c_func
(paren
id|drive
comma
id|XFER_PIO
op_or
id|XFER_EPIO
)paren
op_minus
id|XFER_PIO_0
suffix:semicolon
macro_line|#if 1
id|printk
c_func
(paren
l_string|&quot;%s[%d] %s: best PIO mode: %d&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|__FUNCTION__
comma
id|pio
)paren
suffix:semicolon
macro_line|#endif
macro_line|#if defined(CONFIG_IDE_8xx_PCCARD) || defined(CONFIG_IDE_8xx_DIRECT)
id|pcmp
op_assign
(paren
id|pcmconf8xx_t
op_star
)paren
(paren
op_amp
(paren
(paren
(paren
id|immap_t
op_star
)paren
id|IMAP_ADDR
)paren
op_member_access_from_pointer
id|im_pcmcia
)paren
)paren
suffix:semicolon
id|mask
op_assign
op_complement
(paren
id|PCMCIA_SHT
c_func
(paren
l_int|0xFF
)paren
op_or
id|PCMCIA_SST
c_func
(paren
l_int|0xFF
)paren
op_or
id|PCMCIA_SL
c_func
(paren
l_int|0xFF
)paren
)paren
suffix:semicolon
id|timing
op_assign
id|PCMCIA_SHT
c_func
(paren
id|hold_time
(braket
id|pio
)braket
)paren
op_or
id|PCMCIA_SST
c_func
(paren
id|ide_pio_clocks
(braket
id|pio
)braket
dot
id|setup_time
)paren
op_or
id|PCMCIA_SL
(paren
id|ide_pio_clocks
(braket
id|pio
)braket
dot
id|active_time
)paren
suffix:semicolon
macro_line|#if 1
id|printk
(paren
l_string|&quot;Setting timing bits 0x%08lx in PCMCIA controller&bslash;n&quot;
comma
id|timing
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|reg
op_assign
id|pcmp-&gt;pcmc_por0
op_amp
id|mask
)paren
op_ne
l_int|0
)paren
id|pcmp-&gt;pcmc_por0
op_assign
id|reg
op_or
id|timing
suffix:semicolon
r_if
c_cond
(paren
(paren
id|reg
op_assign
id|pcmp-&gt;pcmc_por1
op_amp
id|mask
)paren
op_ne
l_int|0
)paren
id|pcmp-&gt;pcmc_por1
op_assign
id|reg
op_or
id|timing
suffix:semicolon
r_if
c_cond
(paren
(paren
id|reg
op_assign
id|pcmp-&gt;pcmc_por2
op_amp
id|mask
)paren
op_ne
l_int|0
)paren
id|pcmp-&gt;pcmc_por2
op_assign
id|reg
op_or
id|timing
suffix:semicolon
r_if
c_cond
(paren
(paren
id|reg
op_assign
id|pcmp-&gt;pcmc_por3
op_amp
id|mask
)paren
op_ne
l_int|0
)paren
id|pcmp-&gt;pcmc_por3
op_assign
id|reg
op_or
id|timing
suffix:semicolon
r_if
c_cond
(paren
(paren
id|reg
op_assign
id|pcmp-&gt;pcmc_por4
op_amp
id|mask
)paren
op_ne
l_int|0
)paren
id|pcmp-&gt;pcmc_por4
op_assign
id|reg
op_or
id|timing
suffix:semicolon
r_if
c_cond
(paren
(paren
id|reg
op_assign
id|pcmp-&gt;pcmc_por5
op_amp
id|mask
)paren
op_ne
l_int|0
)paren
id|pcmp-&gt;pcmc_por5
op_assign
id|reg
op_or
id|timing
suffix:semicolon
r_if
c_cond
(paren
(paren
id|reg
op_assign
id|pcmp-&gt;pcmc_por6
op_amp
id|mask
)paren
op_ne
l_int|0
)paren
id|pcmp-&gt;pcmc_por6
op_assign
id|reg
op_or
id|timing
suffix:semicolon
r_if
c_cond
(paren
(paren
id|reg
op_assign
id|pcmp-&gt;pcmc_por7
op_amp
id|mask
)paren
op_ne
l_int|0
)paren
id|pcmp-&gt;pcmc_por7
op_assign
id|reg
op_or
id|timing
suffix:semicolon
macro_line|#elif defined(CONFIG_IDE_EXT_DIRECT)
id|printk
c_func
(paren
l_string|&quot;%s[%d] %s: not implemented yet!&bslash;n&quot;
comma
id|__FILE__
comma
id|__LINE__
comma
id|__FUNCTION__
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|ide_interrupt_ack
r_static
r_int
id|ide_interrupt_ack
c_func
(paren
r_struct
id|ata_channel
op_star
id|ch
)paren
(brace
macro_line|#ifdef CONFIG_IDE_8xx_PCCARD
id|u_int
id|pscr
comma
id|pipr
suffix:semicolon
macro_line|#if (PCMCIA_SOCKETS_NO == 2)
id|u_int
id|_slot_
suffix:semicolon
macro_line|#endif
multiline_comment|/* get interrupt sources */
id|pscr
op_assign
(paren
(paren
r_volatile
id|immap_t
op_star
)paren
id|IMAP_ADDR
)paren
op_member_access_from_pointer
id|im_pcmcia.pcmc_pscr
suffix:semicolon
id|pipr
op_assign
(paren
(paren
r_volatile
id|immap_t
op_star
)paren
id|IMAP_ADDR
)paren
op_member_access_from_pointer
id|im_pcmcia.pcmc_pipr
suffix:semicolon
multiline_comment|/*&n;&t; * report only if both card detect signals are the same&n;&t; * not too nice done,&n;&t; * we depend on that CD2 is the bit to the left of CD1...&n;&t; */
r_if
c_cond
(paren
id|_slot_
op_eq
op_minus
l_int|1
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;PCMCIA slot has not been defined! Using A as default&bslash;n&quot;
)paren
suffix:semicolon
id|_slot_
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
(paren
id|pipr
op_amp
id|M8XX_PCMCIA_CD2
c_func
(paren
id|_slot_
)paren
)paren
op_rshift
l_int|1
)paren
op_xor
(paren
id|pipr
op_amp
id|M8XX_PCMCIA_CD1
c_func
(paren
id|_slot_
)paren
)paren
)paren
(brace
id|printk
(paren
l_string|&quot;card detect interrupt&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* clear the interrupt sources */
(paren
(paren
id|immap_t
op_star
)paren
id|IMAP_ADDR
)paren
op_member_access_from_pointer
id|im_pcmcia.pcmc_pscr
op_assign
id|pscr
suffix:semicolon
macro_line|#else
multiline_comment|/*&n;&t; * Only CONFIG_IDE_8xx_PCCARD is using the interrupt of the&n;&t; * MPC8xx&squot;s PCMCIA controller, so there is nothing to be done here&n;&t; * for CONFIG_IDE_8xx_DIRECT and CONFIG_IDE_EXT_DIRECT.&n;&t; * The interrupt is handled somewhere else.&t;-- Steven&n;&t; */
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * CIS Tupel codes&n; */
DECL|macro|CISTPL_NULL
mdefine_line|#define CISTPL_NULL&t;&t;0x00
DECL|macro|CISTPL_DEVICE
mdefine_line|#define CISTPL_DEVICE&t;&t;0x01
DECL|macro|CISTPL_LONGLINK_CB
mdefine_line|#define CISTPL_LONGLINK_CB&t;0x02
DECL|macro|CISTPL_INDIRECT
mdefine_line|#define CISTPL_INDIRECT&t;&t;0x03
DECL|macro|CISTPL_CONFIG_CB
mdefine_line|#define CISTPL_CONFIG_CB&t;0x04
DECL|macro|CISTPL_CFTABLE_ENTRY_CB
mdefine_line|#define CISTPL_CFTABLE_ENTRY_CB 0x05
DECL|macro|CISTPL_LONGLINK_MFC
mdefine_line|#define CISTPL_LONGLINK_MFC&t;0x06
DECL|macro|CISTPL_BAR
mdefine_line|#define CISTPL_BAR&t;&t;0x07
DECL|macro|CISTPL_PWR_MGMNT
mdefine_line|#define CISTPL_PWR_MGMNT&t;0x08
DECL|macro|CISTPL_EXTDEVICE
mdefine_line|#define CISTPL_EXTDEVICE&t;0x09
DECL|macro|CISTPL_CHECKSUM
mdefine_line|#define CISTPL_CHECKSUM&t;&t;0x10
DECL|macro|CISTPL_LONGLINK_A
mdefine_line|#define CISTPL_LONGLINK_A&t;0x11
DECL|macro|CISTPL_LONGLINK_C
mdefine_line|#define CISTPL_LONGLINK_C&t;0x12
DECL|macro|CISTPL_LINKTARGET
mdefine_line|#define CISTPL_LINKTARGET&t;0x13
DECL|macro|CISTPL_NO_LINK
mdefine_line|#define CISTPL_NO_LINK&t;&t;0x14
DECL|macro|CISTPL_VERS_1
mdefine_line|#define CISTPL_VERS_1&t;&t;0x15
DECL|macro|CISTPL_ALTSTR
mdefine_line|#define CISTPL_ALTSTR&t;&t;0x16
DECL|macro|CISTPL_DEVICE_A
mdefine_line|#define CISTPL_DEVICE_A&t;&t;0x17
DECL|macro|CISTPL_JEDEC_C
mdefine_line|#define CISTPL_JEDEC_C&t;&t;0x18
DECL|macro|CISTPL_JEDEC_A
mdefine_line|#define CISTPL_JEDEC_A&t;&t;0x19
DECL|macro|CISTPL_CONFIG
mdefine_line|#define CISTPL_CONFIG&t;&t;0x1a
DECL|macro|CISTPL_CFTABLE_ENTRY
mdefine_line|#define CISTPL_CFTABLE_ENTRY&t;0x1b
DECL|macro|CISTPL_DEVICE_OC
mdefine_line|#define CISTPL_DEVICE_OC&t;0x1c
DECL|macro|CISTPL_DEVICE_OA
mdefine_line|#define CISTPL_DEVICE_OA&t;0x1d
DECL|macro|CISTPL_DEVICE_GEO
mdefine_line|#define CISTPL_DEVICE_GEO&t;0x1e
DECL|macro|CISTPL_DEVICE_GEO_A
mdefine_line|#define CISTPL_DEVICE_GEO_A&t;0x1f
DECL|macro|CISTPL_MANFID
mdefine_line|#define CISTPL_MANFID&t;&t;0x20
DECL|macro|CISTPL_FUNCID
mdefine_line|#define CISTPL_FUNCID&t;&t;0x21
DECL|macro|CISTPL_FUNCE
mdefine_line|#define CISTPL_FUNCE&t;&t;0x22
DECL|macro|CISTPL_SWIL
mdefine_line|#define CISTPL_SWIL&t;&t;0x23
DECL|macro|CISTPL_END
mdefine_line|#define CISTPL_END&t;&t;0xff
multiline_comment|/*&n; * CIS Function ID codes&n; */
DECL|macro|CISTPL_FUNCID_MULTI
mdefine_line|#define CISTPL_FUNCID_MULTI&t;0x00
DECL|macro|CISTPL_FUNCID_MEMORY
mdefine_line|#define CISTPL_FUNCID_MEMORY&t;0x01
DECL|macro|CISTPL_FUNCID_SERIAL
mdefine_line|#define CISTPL_FUNCID_SERIAL&t;0x02
DECL|macro|CISTPL_FUNCID_PARALLEL
mdefine_line|#define CISTPL_FUNCID_PARALLEL&t;0x03
DECL|macro|CISTPL_FUNCID_FIXED
mdefine_line|#define CISTPL_FUNCID_FIXED&t;0x04
DECL|macro|CISTPL_FUNCID_VIDEO
mdefine_line|#define CISTPL_FUNCID_VIDEO&t;0x05
DECL|macro|CISTPL_FUNCID_NETWORK
mdefine_line|#define CISTPL_FUNCID_NETWORK&t;0x06
DECL|macro|CISTPL_FUNCID_AIMS
mdefine_line|#define CISTPL_FUNCID_AIMS&t;0x07
DECL|macro|CISTPL_FUNCID_SCSI
mdefine_line|#define CISTPL_FUNCID_SCSI&t;0x08
multiline_comment|/*&n; * Fixed Disk FUNCE codes&n; */
DECL|macro|CISTPL_IDE_INTERFACE
mdefine_line|#define CISTPL_IDE_INTERFACE&t;0x01
DECL|macro|CISTPL_FUNCE_IDE_IFACE
mdefine_line|#define CISTPL_FUNCE_IDE_IFACE&t;0x01
DECL|macro|CISTPL_FUNCE_IDE_MASTER
mdefine_line|#define CISTPL_FUNCE_IDE_MASTER&t;0x02
DECL|macro|CISTPL_FUNCE_IDE_SLAVE
mdefine_line|#define CISTPL_FUNCE_IDE_SLAVE&t;0x03
multiline_comment|/* First feature byte */
DECL|macro|CISTPL_IDE_SILICON
mdefine_line|#define CISTPL_IDE_SILICON&t;0x04
DECL|macro|CISTPL_IDE_UNIQUE
mdefine_line|#define CISTPL_IDE_UNIQUE&t;0x08
DECL|macro|CISTPL_IDE_DUAL
mdefine_line|#define CISTPL_IDE_DUAL&t;&t;0x10
multiline_comment|/* Second feature byte */
DECL|macro|CISTPL_IDE_HAS_SLEEP
mdefine_line|#define CISTPL_IDE_HAS_SLEEP&t;0x01
DECL|macro|CISTPL_IDE_HAS_STANDBY
mdefine_line|#define CISTPL_IDE_HAS_STANDBY&t;0x02
DECL|macro|CISTPL_IDE_HAS_IDLE
mdefine_line|#define CISTPL_IDE_HAS_IDLE&t;0x04
DECL|macro|CISTPL_IDE_LOW_POWER
mdefine_line|#define CISTPL_IDE_LOW_POWER&t;0x08
DECL|macro|CISTPL_IDE_REG_INHIBIT
mdefine_line|#define CISTPL_IDE_REG_INHIBIT&t;0x10
DECL|macro|CISTPL_IDE_HAS_INDEX
mdefine_line|#define CISTPL_IDE_HAS_INDEX&t;0x20
DECL|macro|CISTPL_IDE_IOIS16
mdefine_line|#define CISTPL_IDE_IOIS16&t;0x40
multiline_comment|/* -------------------------------------------------------------------- */
DECL|macro|MAX_TUPEL_SZ
mdefine_line|#define&t;MAX_TUPEL_SZ&t;512
DECL|macro|MAX_FEATURES
mdefine_line|#define MAX_FEATURES&t;4
DECL|function|check_ide_device
r_static
r_int
id|check_ide_device
(paren
r_int
r_int
id|base
)paren
(brace
r_volatile
r_int
r_char
op_star
id|ident
op_assign
l_int|NULL
suffix:semicolon
r_volatile
r_int
r_char
op_star
id|feature_p
(braket
id|MAX_FEATURES
)braket
suffix:semicolon
r_volatile
r_int
r_char
op_star
id|p
comma
op_star
id|start
suffix:semicolon
r_int
id|n_features
op_assign
l_int|0
suffix:semicolon
r_int
r_char
id|func_id
op_assign
op_complement
l_int|0
suffix:semicolon
r_int
r_char
id|code
comma
id|len
suffix:semicolon
r_int
r_int
id|config_base
op_assign
l_int|0
suffix:semicolon
r_int
id|found
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
(paren
l_string|&quot;PCMCIA MEM: %08lX&bslash;n&quot;
comma
id|base
)paren
suffix:semicolon
macro_line|#endif
id|start
op_assign
id|p
op_assign
(paren
r_volatile
r_int
r_char
op_star
)paren
id|base
suffix:semicolon
r_while
c_loop
(paren
(paren
id|p
op_minus
id|start
)paren
OL
id|MAX_TUPEL_SZ
)paren
(brace
id|code
op_assign
op_star
id|p
suffix:semicolon
id|p
op_add_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|code
op_eq
l_int|0xFF
)paren
(brace
multiline_comment|/* End of chain */
r_break
suffix:semicolon
)brace
id|len
op_assign
op_star
id|p
suffix:semicolon
id|p
op_add_assign
l_int|2
suffix:semicolon
macro_line|#ifdef&t;DEBUG_PCMCIA
(brace
r_volatile
r_int
r_char
op_star
id|q
op_assign
id|p
suffix:semicolon
id|printk
(paren
l_string|&quot;&bslash;nTuple code %02x  length %d&bslash;n&bslash;tData:&quot;
comma
id|code
comma
id|len
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
op_increment
id|i
)paren
(brace
id|printk
(paren
l_string|&quot; %02x&quot;
comma
op_star
id|q
)paren
suffix:semicolon
id|q
op_add_assign
l_int|2
suffix:semicolon
)brace
)brace
macro_line|#endif
r_switch
c_cond
(paren
id|code
)paren
(brace
r_case
id|CISTPL_VERS_1
suffix:colon
id|ident
op_assign
id|p
op_plus
l_int|4
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CISTPL_FUNCID
suffix:colon
id|func_id
op_assign
op_star
id|p
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CISTPL_FUNCE
suffix:colon
r_if
c_cond
(paren
id|n_features
OL
id|MAX_FEATURES
)paren
id|feature_p
(braket
id|n_features
op_increment
)braket
op_assign
id|p
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CISTPL_CONFIG
suffix:colon
id|config_base
op_assign
(paren
op_star
(paren
id|p
op_plus
l_int|6
)paren
op_lshift
l_int|8
)paren
op_plus
(paren
op_star
(paren
id|p
op_plus
l_int|4
)paren
)paren
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
id|p
op_add_assign
l_int|2
op_star
id|len
suffix:semicolon
)brace
id|found
op_assign
id|identify
(paren
id|ident
)paren
suffix:semicolon
r_if
c_cond
(paren
id|func_id
op_ne
(paren
(paren
r_int
r_char
)paren
op_complement
l_int|0
)paren
)paren
(brace
id|print_funcid
(paren
id|func_id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|func_id
op_eq
id|CISTPL_FUNCID_FIXED
)paren
id|found
op_assign
l_int|1
suffix:semicolon
r_else
r_return
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* no disk drive */
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|n_features
suffix:semicolon
op_increment
id|i
)paren
(brace
id|print_fixed
(paren
id|feature_p
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|found
)paren
(brace
id|printk
(paren
l_string|&quot;unknown card type&bslash;n&quot;
)paren
suffix:semicolon
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/* set level mode irq and I/O mapped device in config reg*/
op_star
(paren
(paren
r_int
r_char
op_star
)paren
(paren
id|base
op_plus
id|config_base
)paren
)paren
op_assign
l_int|0x41
suffix:semicolon
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* ------------------------------------------------------------------------- */
DECL|function|print_funcid
r_static
r_void
id|print_funcid
(paren
r_int
id|func
)paren
(brace
r_switch
c_cond
(paren
id|func
)paren
(brace
r_case
id|CISTPL_FUNCID_MULTI
suffix:colon
id|printk
(paren
l_string|&quot; Multi-Function&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CISTPL_FUNCID_MEMORY
suffix:colon
id|printk
(paren
l_string|&quot; Memory&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CISTPL_FUNCID_SERIAL
suffix:colon
id|printk
(paren
l_string|&quot; Serial Port&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CISTPL_FUNCID_PARALLEL
suffix:colon
id|printk
(paren
l_string|&quot; Parallel Port&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CISTPL_FUNCID_FIXED
suffix:colon
id|printk
(paren
l_string|&quot; Fixed Disk&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CISTPL_FUNCID_VIDEO
suffix:colon
id|printk
(paren
l_string|&quot; Video Adapter&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CISTPL_FUNCID_NETWORK
suffix:colon
id|printk
(paren
l_string|&quot; Network Adapter&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CISTPL_FUNCID_AIMS
suffix:colon
id|printk
(paren
l_string|&quot; AIMS Card&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CISTPL_FUNCID_SCSI
suffix:colon
id|printk
(paren
l_string|&quot; SCSI Adapter&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
(paren
l_string|&quot; Unknown&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|printk
(paren
l_string|&quot; Card&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* ------------------------------------------------------------------------- */
DECL|function|print_fixed
r_static
r_void
id|print_fixed
(paren
r_volatile
r_int
r_char
op_star
id|p
)paren
(brace
r_if
c_cond
(paren
id|p
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
r_switch
c_cond
(paren
op_star
id|p
)paren
(brace
r_case
id|CISTPL_FUNCE_IDE_IFACE
suffix:colon
(brace
r_int
r_char
id|iface
op_assign
op_star
(paren
id|p
op_plus
l_int|2
)paren
suffix:semicolon
id|printk
(paren
(paren
id|iface
op_eq
id|CISTPL_IDE_INTERFACE
)paren
ques
c_cond
l_string|&quot; IDE&quot;
suffix:colon
l_string|&quot; unknown&quot;
)paren
suffix:semicolon
id|printk
(paren
l_string|&quot; interface &quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
id|CISTPL_FUNCE_IDE_MASTER
suffix:colon
r_case
id|CISTPL_FUNCE_IDE_SLAVE
suffix:colon
(brace
r_int
r_char
id|f1
op_assign
op_star
(paren
id|p
op_plus
l_int|2
)paren
suffix:semicolon
r_int
r_char
id|f2
op_assign
op_star
(paren
id|p
op_plus
l_int|4
)paren
suffix:semicolon
id|printk
(paren
(paren
id|f1
op_amp
id|CISTPL_IDE_SILICON
)paren
ques
c_cond
l_string|&quot; [silicon]&quot;
suffix:colon
l_string|&quot; [rotating]&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|f1
op_amp
id|CISTPL_IDE_UNIQUE
)paren
id|printk
(paren
l_string|&quot; [unique]&quot;
)paren
suffix:semicolon
id|printk
(paren
(paren
id|f1
op_amp
id|CISTPL_IDE_DUAL
)paren
ques
c_cond
l_string|&quot; [dual]&quot;
suffix:colon
l_string|&quot; [single]&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|f2
op_amp
id|CISTPL_IDE_HAS_SLEEP
)paren
id|printk
(paren
l_string|&quot; [sleep]&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|f2
op_amp
id|CISTPL_IDE_HAS_STANDBY
)paren
id|printk
(paren
l_string|&quot; [standby]&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|f2
op_amp
id|CISTPL_IDE_HAS_IDLE
)paren
id|printk
(paren
l_string|&quot; [idle]&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|f2
op_amp
id|CISTPL_IDE_LOW_POWER
)paren
id|printk
(paren
l_string|&quot; [low power]&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|f2
op_amp
id|CISTPL_IDE_REG_INHIBIT
)paren
id|printk
(paren
l_string|&quot; [reg inhibit]&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|f2
op_amp
id|CISTPL_IDE_HAS_INDEX
)paren
id|printk
(paren
l_string|&quot; [index]&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|f2
op_amp
id|CISTPL_IDE_IOIS16
)paren
id|printk
(paren
l_string|&quot; [IOis16]&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|printk
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* ------------------------------------------------------------------------- */
DECL|macro|MAX_IDENT_CHARS
mdefine_line|#define MAX_IDENT_CHARS&t;&t;64
DECL|macro|MAX_IDENT_FIELDS
mdefine_line|#define&t;MAX_IDENT_FIELDS&t;4
DECL|variable|known_cards
r_static
r_int
r_char
op_star
id|known_cards
(braket
)braket
op_assign
(brace
l_string|&quot;ARGOSY PnPIDE D5&quot;
comma
l_int|NULL
)brace
suffix:semicolon
DECL|function|identify
r_static
r_int
id|identify
(paren
r_volatile
r_int
r_char
op_star
id|p
)paren
(brace
r_int
r_char
id|id_str
(braket
id|MAX_IDENT_CHARS
)braket
suffix:semicolon
r_int
r_char
id|data
suffix:semicolon
r_int
r_char
op_star
id|t
suffix:semicolon
r_int
r_char
op_star
op_star
id|card
suffix:semicolon
r_int
id|i
comma
id|done
suffix:semicolon
r_if
c_cond
(paren
id|p
op_eq
l_int|NULL
)paren
r_return
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Don&squot;t know */
id|t
op_assign
id|id_str
suffix:semicolon
id|done
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_le
l_int|4
op_logical_and
op_logical_neg
id|done
suffix:semicolon
op_increment
id|i
comma
id|p
op_add_assign
l_int|2
)paren
(brace
r_while
c_loop
(paren
(paren
id|data
op_assign
op_star
id|p
)paren
op_ne
l_char|&squot;&bslash;0&squot;
)paren
(brace
r_if
c_cond
(paren
id|data
op_eq
l_int|0xFF
)paren
(brace
id|done
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
op_star
id|t
op_increment
op_assign
id|data
suffix:semicolon
r_if
c_cond
(paren
id|t
op_eq
op_amp
id|id_str
(braket
id|MAX_IDENT_CHARS
op_minus
l_int|1
)braket
)paren
(brace
id|done
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
id|p
op_add_assign
l_int|2
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|done
)paren
op_star
id|t
op_increment
op_assign
l_char|&squot; &squot;
suffix:semicolon
)brace
op_star
id|t
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_while
c_loop
(paren
op_decrement
id|t
OG
id|id_str
)paren
(brace
r_if
c_cond
(paren
op_star
id|t
op_eq
l_char|&squot; &squot;
)paren
op_star
id|t
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_else
r_break
suffix:semicolon
)brace
id|printk
(paren
l_string|&quot;Card ID: %s&bslash;n&quot;
comma
id|id_str
)paren
suffix:semicolon
r_for
c_loop
(paren
id|card
op_assign
id|known_cards
suffix:semicolon
op_star
id|card
suffix:semicolon
op_increment
id|card
)paren
(brace
r_if
c_cond
(paren
id|strcmp
c_func
(paren
op_star
id|card
comma
id|id_str
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* found! */
r_return
(paren
l_int|1
)paren
suffix:semicolon
)brace
)brace
r_return
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* don&squot;t know */
)brace
DECL|function|m8xx_ide_init
r_void
id|m8xx_ide_init
c_func
(paren
r_void
)paren
(brace
id|ppc_ide_md.default_irq
op_assign
id|m8xx_ide_default_irq
suffix:semicolon
id|ppc_ide_md.default_io_base
op_assign
id|m8xx_ide_default_io_base
suffix:semicolon
id|ppc_ide_md.ide_init_hwif
op_assign
id|m8xx_ide_init_hwif_ports
suffix:semicolon
)brace
eof
