multiline_comment|/*&n; * power.c - power management functions for the device tree.&n; * &n; * Copyright (c) 2002 Patrick Mochel&n; *&t;&t; 2002 Open Source Development Lab&n; * &n; *  Kai Germaschewski contributed to the list walking routines.&n; *&n; * FIXME: The suspend and shutdown walks are identical. The resume walk&n; * is simply walking the list backward. Anyway we can combine these (cleanly)?&n; */
macro_line|#include &lt;linux/device.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &quot;base.h&quot;
DECL|macro|to_dev
mdefine_line|#define to_dev(node) container_of(node,struct device,g_list)
multiline_comment|/**&n; * device_suspend - suspend all devices on the device tree&n; * @state:&t;state we&squot;re entering&n; * @level:&t;what stage of the suspend process we&squot;re at &n; * &n; * The entries in the global device list are inserted such that they&squot;re in a &n; * depth-first ordering. So, simply iterate over the list, and call the driver&squot;s&n; * suspend callback for each device.&n; */
DECL|function|device_suspend
r_int
id|device_suspend
c_func
(paren
id|u32
id|state
comma
id|u32
id|level
)paren
(brace
r_struct
id|list_head
op_star
id|node
suffix:semicolon
r_struct
id|device
op_star
id|prev
op_assign
l_int|NULL
suffix:semicolon
r_int
id|error
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
id|KERN_EMERG
l_string|&quot;Suspending Devices&bslash;n&quot;
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|device_lock
)paren
suffix:semicolon
id|list_for_each
c_func
(paren
id|node
comma
op_amp
id|global_device_list
)paren
(brace
r_struct
id|device
op_star
id|dev
op_assign
id|get_device_locked
c_func
(paren
id|to_dev
c_func
(paren
id|node
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
)paren
(brace
id|spin_unlock
c_func
(paren
op_amp
id|device_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;driver
op_logical_and
id|dev-&gt;driver-&gt;suspend
)paren
id|error
op_assign
id|dev-&gt;driver
op_member_access_from_pointer
id|suspend
c_func
(paren
id|dev
comma
id|state
comma
id|level
)paren
suffix:semicolon
r_if
c_cond
(paren
id|prev
)paren
id|put_device
c_func
(paren
id|prev
)paren
suffix:semicolon
id|prev
op_assign
id|dev
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|device_lock
)paren
suffix:semicolon
)brace
)brace
id|spin_unlock
c_func
(paren
op_amp
id|device_lock
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
multiline_comment|/**&n; * device_resume - resume all the devices in the system&n; * @level:&t;stage of resume process we&squot;re at &n; * &n; * Similar to device_suspend above, though we want to do a breadth-first&n; * walk of the tree to make sure we wake up parents before children.&n; * So, we iterate over the list backward. &n; */
DECL|function|device_resume
r_void
id|device_resume
c_func
(paren
id|u32
id|level
)paren
(brace
r_struct
id|list_head
op_star
id|node
suffix:semicolon
r_struct
id|device
op_star
id|prev
op_assign
l_int|NULL
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|device_lock
)paren
suffix:semicolon
id|list_for_each_prev
c_func
(paren
id|node
comma
op_amp
id|global_device_list
)paren
(brace
r_struct
id|device
op_star
id|dev
op_assign
id|get_device_locked
c_func
(paren
id|to_dev
c_func
(paren
id|node
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
)paren
(brace
id|spin_unlock
c_func
(paren
op_amp
id|device_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;driver
op_logical_and
id|dev-&gt;driver-&gt;resume
)paren
id|dev-&gt;driver
op_member_access_from_pointer
id|resume
c_func
(paren
id|dev
comma
id|level
)paren
suffix:semicolon
r_if
c_cond
(paren
id|prev
)paren
id|put_device
c_func
(paren
id|prev
)paren
suffix:semicolon
id|prev
op_assign
id|dev
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|device_lock
)paren
suffix:semicolon
)brace
)brace
id|spin_unlock
c_func
(paren
op_amp
id|device_lock
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_EMERG
l_string|&quot;Devices Resumed&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * device_shutdown - queisce all the devices before reboot/shutdown&n; *&n; * Do depth first iteration over device tree, calling -&gt;remove() for each&n; * device. This should ensure the devices are put into a sane state before&n; * we reboot the system.&n; *&n; */
DECL|function|device_shutdown
r_void
id|device_shutdown
c_func
(paren
r_void
)paren
(brace
r_struct
id|list_head
op_star
id|node
comma
op_star
id|next
suffix:semicolon
r_struct
id|device
op_star
id|prev
op_assign
l_int|NULL
suffix:semicolon
id|printk
c_func
(paren
id|KERN_EMERG
l_string|&quot;Shutting down devices&bslash;n&quot;
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|device_lock
)paren
suffix:semicolon
id|list_for_each_safe
c_func
(paren
id|node
comma
id|next
comma
op_amp
id|global_device_list
)paren
(brace
r_struct
id|device
op_star
id|dev
op_assign
id|get_device_locked
c_func
(paren
id|to_dev
c_func
(paren
id|node
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
)paren
(brace
id|spin_unlock
c_func
(paren
op_amp
id|device_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;driver
op_logical_and
id|dev-&gt;driver-&gt;remove
)paren
id|dev-&gt;driver
op_member_access_from_pointer
id|remove
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|prev
)paren
id|put_device
c_func
(paren
id|prev
)paren
suffix:semicolon
id|prev
op_assign
id|dev
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|device_lock
)paren
suffix:semicolon
)brace
)brace
id|spin_unlock
c_func
(paren
op_amp
id|device_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|prev
)paren
id|put_device
c_func
(paren
id|prev
)paren
suffix:semicolon
)brace
DECL|variable|device_suspend
id|EXPORT_SYMBOL
c_func
(paren
id|device_suspend
)paren
suffix:semicolon
DECL|variable|device_resume
id|EXPORT_SYMBOL
c_func
(paren
id|device_resume
)paren
suffix:semicolon
DECL|variable|device_shutdown
id|EXPORT_SYMBOL
c_func
(paren
id|device_shutdown
)paren
suffix:semicolon
eof
