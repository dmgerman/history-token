multiline_comment|/*&n; * suspend.c - Functions for putting devices to sleep. &n; *&n; * Copyright (c) 2003 Patrick Mochel&n; * Copyright (c) 2003 Open Source Development Labs&n; *&n; * This file is released under the GPLv2&n; *&n; */
macro_line|#include &lt;linux/device.h&gt;
macro_line|#include &quot;power.h&quot;
r_extern
r_int
id|sysdev_save
c_func
(paren
id|u32
id|state
)paren
suffix:semicolon
r_extern
r_int
id|sysdev_suspend
c_func
(paren
id|u32
id|state
)paren
suffix:semicolon
multiline_comment|/*&n; * The entries in the dpm_active list are in a depth first order, simply&n; * because children are guaranteed to be discovered after parents, and &n; * are inserted at the back of the list on discovery. &n; * &n; * All list on the suspend path are done in reverse order, so we operate&n; * on the leaves of the device tree (or forests, depending on how you want&n; * to look at it ;) first. As nodes are removed from the back of the list, &n; * they are inserted into the front of their destintation lists. &n; *&n; * Things are the reverse on the resume path - iterations are done in&n; * forward order, and nodes are inserted at the back of their destination&n; * lists. This way, the ancestors will be accessed before their descendents.&n; */
multiline_comment|/**&n; *&t;suspend_device - Save state of one device.&n; *&t;@dev:&t;Device.&n; *&t;@state:&t;Power state device is entering.&n; */
DECL|function|suspend_device
r_static
r_int
id|suspend_device
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|u32
id|state
)paren
(brace
r_struct
id|device_driver
op_star
id|drv
op_assign
id|dev-&gt;driver
suffix:semicolon
r_if
c_cond
(paren
id|drv
op_logical_and
id|drv-&gt;suspend
)paren
r_return
id|drv
op_member_access_from_pointer
id|suspend
c_func
(paren
id|dev
comma
id|state
comma
id|SUSPEND_SAVE_STATE
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;device_pm_suspend - Save state and stop all devices in system.&n; *&t;@state:&t;&t;Power state to put each device in. &n; *&n; *&t;Walk the dpm_active list, call -&gt;suspend() for each device, and move&n; *&t;it to dpm_suspended. If we hit a failure with any of the devices, call&n; *&t;dpm_resume() above to bring the suspended devices back to life. &n; *&n; *&t;Have system devices save state last. &n; *&n; *&t;Note this function leaves dpm_sem held to&n; *&t;a) block other devices from registering.&n; *&t;b) prevent other PM operations from happening after we&squot;ve begun.&n; *&t;c) make sure we&squot;re exclusive when we disable interrupts.&n; *&n; *&t;device_pm_resume() will release dpm_sem after restoring state to &n; *&t;all devices (as will this on error). You must call it once you&squot;ve &n; *&t;called device_pm_suspend().&n; */
DECL|function|device_pm_suspend
r_int
id|device_pm_suspend
c_func
(paren
id|u32
id|state
)paren
(brace
r_int
id|error
op_assign
l_int|0
suffix:semicolon
id|down
c_func
(paren
op_amp
id|dpm_sem
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|dpm_lock
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|dpm_active
)paren
)paren
(brace
r_struct
id|list_head
op_star
id|entry
op_assign
id|dpm_active.prev
suffix:semicolon
r_struct
id|device
op_star
id|dev
op_assign
id|to_device
c_func
(paren
id|entry
)paren
suffix:semicolon
id|list_del_init
c_func
(paren
id|entry
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|dpm_lock
)paren
suffix:semicolon
id|error
op_assign
id|suspend_device
c_func
(paren
id|dev
comma
id|state
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|dpm_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|error
)paren
id|list_add
c_func
(paren
id|entry
comma
op_amp
id|dpm_suspended
)paren
suffix:semicolon
r_else
(brace
id|list_add_tail
c_func
(paren
id|entry
comma
op_amp
id|dpm_active
)paren
suffix:semicolon
r_goto
id|Error
suffix:semicolon
)brace
)brace
id|spin_unlock
c_func
(paren
op_amp
id|dpm_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|error
op_assign
id|sysdev_save
c_func
(paren
id|state
)paren
)paren
)paren
r_goto
id|Error
suffix:semicolon
id|Done
suffix:colon
r_return
id|error
suffix:semicolon
id|Error
suffix:colon
id|dpm_resume
c_func
(paren
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|dpm_sem
)paren
suffix:semicolon
r_goto
id|Done
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;power_down_device - Put one device in low power state.&n; *&t;@dev:&t;Device.&n; *&t;@state:&t;Power state to enter.&n; */
DECL|function|power_down_device
r_static
r_int
id|power_down_device
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|u32
id|state
)paren
(brace
r_struct
id|device_driver
op_star
id|drv
op_assign
id|dev-&gt;driver
suffix:semicolon
r_if
c_cond
(paren
id|drv
op_logical_and
id|drv-&gt;suspend
)paren
r_return
id|drv
op_member_access_from_pointer
id|suspend
c_func
(paren
id|dev
comma
id|state
comma
id|SUSPEND_POWER_DOWN
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;dpm_power_down - Put all devices in low power state.&n; *&t;@state:&t;Power state to enter.&n; *&n; *&t;Walk the dpm_suspended list (with interrupts enabled) and try&n; *&t;to power down each each. If any fail with -EAGAIN, they require&n; *&t;the call to be done with interrupts disabled. So, we move them to&n; *&t;the dpm_off_irq list.&n; *&n; *&t;If the call succeeds, we move each device to the dpm_off list.&n; */
DECL|function|dpm_power_down
r_static
r_int
id|dpm_power_down
c_func
(paren
id|u32
id|state
)paren
(brace
id|spin_lock
c_func
(paren
op_amp
id|dpm_lock
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|dpm_suspended
)paren
)paren
(brace
r_struct
id|list_head
op_star
id|entry
op_assign
id|dpm_suspended.prev
suffix:semicolon
r_int
id|error
suffix:semicolon
id|list_del_init
c_func
(paren
id|entry
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|dpm_lock
)paren
suffix:semicolon
id|error
op_assign
id|power_down_device
c_func
(paren
id|to_device
c_func
(paren
id|entry
)paren
comma
id|state
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|dpm_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|error
)paren
id|list_add
c_func
(paren
id|entry
comma
op_amp
id|dpm_off
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|error
op_eq
op_minus
id|EAGAIN
)paren
id|list_add
c_func
(paren
id|entry
comma
op_amp
id|dpm_off_irq
)paren
suffix:semicolon
r_else
(brace
id|list_add_tail
c_func
(paren
id|entry
comma
op_amp
id|dpm_suspended
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
)brace
id|spin_unlock
c_func
(paren
op_amp
id|dpm_lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;dpm_power_down_irq - Power down devices without interrupts.&n; *&t;@state:&t;State to enter.&n; *&n; *&t;Walk the dpm_off_irq list (built by dpm_power_down) and power&n; *&t;down each device that requires the call to be made with interrupts&n; *&t;disabled. &n; */
DECL|function|dpm_power_down_irq
r_static
r_int
id|dpm_power_down_irq
c_func
(paren
id|u32
id|state
)paren
(brace
r_struct
id|device
op_star
id|dev
suffix:semicolon
r_int
id|error
op_assign
l_int|0
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|dpm_lock
)paren
suffix:semicolon
id|list_for_each_entry_reverse
c_func
(paren
id|dev
comma
op_amp
id|dpm_off_irq
comma
id|power.entry
)paren
(brace
r_if
c_cond
(paren
(paren
id|error
op_assign
id|power_down_device
c_func
(paren
id|dev
comma
id|state
)paren
)paren
)paren
r_break
suffix:semicolon
)brace
id|spin_unlock_irq
c_func
(paren
op_amp
id|dpm_lock
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;device_pm_power_down - Put all devices in low power state.&n; *&t;@state:&t;&t;Power state to enter.&n; *&n; *&t;Walk the dpm_suspended list, calling -&gt;power_down() for each device.&n; *&t;Check the return value for each. If it returns 0, then we move the&n; *&t;the device to the dpm_off list. If it returns -EAGAIN, we move it to &n; *&t;the dpm_off_irq list. If we get a different error, try and back out. &n; *&n; *&t;dpm_irq_off is for devices that require interrupts to be disabled to&n; *&t;either to power down the device or power it back on. &n; *&n; *&t;When we&squot;re done, we disable interrrupts (!!) and walk the dpm_off_irq&n; *&t;list to shut down the devices that need interrupts disabled. &n; *&n; *&t;This function leaves interrupts disabled on exit, since powering down&n; *&t;devices should be the very last thing before the system is put into a &n; *&t;low-power state. &n; *&n; *&t;device_pm_power_on() should be called to re-enable interrupts and power&n; *&t;the devices back on. &n; */
DECL|function|device_pm_power_down
r_int
id|device_pm_power_down
c_func
(paren
id|u32
id|state
)paren
(brace
r_int
id|error
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|error
op_assign
id|dpm_power_down
c_func
(paren
id|state
)paren
)paren
)paren
r_goto
id|ErrorIRQOn
suffix:semicolon
id|local_irq_disable
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|error
op_assign
id|dpm_power_down_irq
c_func
(paren
id|state
)paren
)paren
)paren
r_goto
id|ErrorIRQOff
suffix:semicolon
id|sysdev_suspend
c_func
(paren
id|state
)paren
suffix:semicolon
id|Done
suffix:colon
r_return
id|error
suffix:semicolon
id|ErrorIRQOff
suffix:colon
id|dpm_power_up_irq
c_func
(paren
)paren
suffix:semicolon
id|local_irq_enable
c_func
(paren
)paren
suffix:semicolon
id|ErrorIRQOn
suffix:colon
id|dpm_power_up
c_func
(paren
)paren
suffix:semicolon
r_goto
id|Done
suffix:semicolon
)brace
multiline_comment|/**&n; * device_suspend - suspend all devices on the device ree&n; * @state:&t;state we&squot;re entering&n; * @level:&t;Stage of suspend sequence we&squot;re in.&n; *&n; *&n; *&t;This function is deprecated. Calls should be replaced with&n; *&t;appropriate calls to device_pm_suspend() and device_pm_power_down().&n; */
DECL|function|device_suspend
r_int
id|device_suspend
c_func
(paren
id|u32
id|state
comma
id|u32
id|level
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s Called from:&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|dump_stack
c_func
(paren
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
eof
