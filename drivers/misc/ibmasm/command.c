multiline_comment|/*&n; * IBM ASM Service Processor Device Driver&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or&n; * (at your option) any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.&n; *&n; * Copyright (C) IBM Corporation, 2004&n; *&n; * Author: Max Asb&#xfffd;ck &lt;amax@us.ibm.com&gt; &n; *&n; */
macro_line|#include &quot;ibmasm.h&quot;
r_static
r_void
id|exec_next_command
c_func
(paren
r_struct
id|service_processor
op_star
id|sp
)paren
suffix:semicolon
r_static
r_void
id|free_command
c_func
(paren
r_struct
id|kobject
op_star
id|kobj
)paren
suffix:semicolon
DECL|variable|ibmasm_cmd_kobj_type
r_static
r_struct
id|kobj_type
id|ibmasm_cmd_kobj_type
op_assign
(brace
dot
id|release
op_assign
id|free_command
comma
)brace
suffix:semicolon
DECL|function|ibmasm_new_command
r_struct
id|command
op_star
id|ibmasm_new_command
c_func
(paren
r_int
id|buffer_size
)paren
(brace
r_struct
id|command
op_star
id|cmd
suffix:semicolon
r_if
c_cond
(paren
id|buffer_size
OG
id|IBMASM_CMD_MAX_BUFFER_SIZE
)paren
r_return
l_int|NULL
suffix:semicolon
id|cmd
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|command
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_eq
l_int|NULL
)paren
r_return
l_int|NULL
suffix:semicolon
id|memset
c_func
(paren
id|cmd
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|cmd
)paren
)paren
suffix:semicolon
id|cmd-&gt;buffer
op_assign
id|kmalloc
c_func
(paren
id|buffer_size
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmd-&gt;buffer
op_eq
l_int|NULL
)paren
(brace
id|kfree
c_func
(paren
id|cmd
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|memset
c_func
(paren
id|cmd-&gt;buffer
comma
l_int|0
comma
id|buffer_size
)paren
suffix:semicolon
id|cmd-&gt;buffer_size
op_assign
id|buffer_size
suffix:semicolon
id|kobject_init
c_func
(paren
op_amp
id|cmd-&gt;kobj
)paren
suffix:semicolon
id|cmd-&gt;kobj.ktype
op_assign
op_amp
id|ibmasm_cmd_kobj_type
suffix:semicolon
id|cmd-&gt;status
op_assign
id|IBMASM_CMD_PENDING
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|cmd-&gt;wait
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|cmd-&gt;queue_node
)paren
suffix:semicolon
r_return
id|cmd
suffix:semicolon
)brace
DECL|function|free_command
r_static
r_void
id|free_command
c_func
(paren
r_struct
id|kobject
op_star
id|kobj
)paren
(brace
r_struct
id|command
op_star
id|cmd
op_assign
id|to_command
c_func
(paren
id|kobj
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|cmd-&gt;queue_node
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|cmd-&gt;buffer
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|cmd
)paren
suffix:semicolon
)brace
DECL|function|enqueue_command
r_static
r_void
id|enqueue_command
c_func
(paren
r_struct
id|service_processor
op_star
id|sp
comma
r_struct
id|command
op_star
id|cmd
)paren
(brace
id|list_add_tail
c_func
(paren
op_amp
id|cmd-&gt;queue_node
comma
op_amp
id|sp-&gt;command_queue
)paren
suffix:semicolon
)brace
DECL|function|dequeue_command
r_static
r_struct
id|command
op_star
id|dequeue_command
c_func
(paren
r_struct
id|service_processor
op_star
id|sp
)paren
(brace
r_struct
id|command
op_star
id|cmd
suffix:semicolon
r_struct
id|list_head
op_star
id|next
suffix:semicolon
r_if
c_cond
(paren
id|list_empty
c_func
(paren
op_amp
id|sp-&gt;command_queue
)paren
)paren
r_return
l_int|NULL
suffix:semicolon
id|next
op_assign
id|sp-&gt;command_queue.next
suffix:semicolon
id|list_del_init
c_func
(paren
id|next
)paren
suffix:semicolon
id|cmd
op_assign
id|list_entry
c_func
(paren
id|next
comma
r_struct
id|command
comma
id|queue_node
)paren
suffix:semicolon
r_return
id|cmd
suffix:semicolon
)brace
DECL|function|do_exec_command
r_static
r_inline
r_void
id|do_exec_command
c_func
(paren
r_struct
id|service_processor
op_star
id|sp
)paren
(brace
r_if
c_cond
(paren
id|ibmasm_send_i2o_message
c_func
(paren
id|sp
)paren
)paren
(brace
id|sp-&gt;current_command-&gt;status
op_assign
id|IBMASM_CMD_FAILED
suffix:semicolon
id|exec_next_command
c_func
(paren
id|sp
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; * exec_command&n; * send a command to a service processor&n; * Commands are executed sequentially. One command (sp-&gt;current_command)&n; * is sent to the service processor. Once the interrupt handler gets a&n; * message of type command_response, the message is copied into&n; * the current commands buffer, &n; */
DECL|function|ibmasm_exec_command
r_void
id|ibmasm_exec_command
c_func
(paren
r_struct
id|service_processor
op_star
id|sp
comma
r_struct
id|command
op_star
id|cmd
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|sp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sp-&gt;current_command
)paren
(brace
id|command_get
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|sp-&gt;current_command
op_assign
id|cmd
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|sp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|do_exec_command
c_func
(paren
id|sp
)paren
suffix:semicolon
)brace
r_else
(brace
id|enqueue_command
c_func
(paren
id|sp
comma
id|cmd
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|sp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
)brace
DECL|function|exec_next_command
r_static
r_void
id|exec_next_command
c_func
(paren
r_struct
id|service_processor
op_star
id|sp
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|sp-&gt;current_command-&gt;wait
)paren
suffix:semicolon
id|command_put
c_func
(paren
id|sp-&gt;current_command
)paren
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|sp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|sp-&gt;current_command
op_assign
id|dequeue_command
c_func
(paren
id|sp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sp-&gt;current_command
)paren
(brace
id|command_get
c_func
(paren
id|sp-&gt;current_command
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|sp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|do_exec_command
c_func
(paren
id|sp
)paren
suffix:semicolon
)brace
r_else
(brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|sp-&gt;lock
comma
id|flags
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/** &n; * Sleep until a command has failed or a response has been received&n; * and the command status been updated by the interrupt handler.&n; * (see receive_response).&n; */
DECL|function|ibmasm_wait_for_response
r_void
id|ibmasm_wait_for_response
c_func
(paren
r_struct
id|command
op_star
id|cmd
comma
r_int
id|timeout
)paren
(brace
id|wait_event_interruptible_timeout
c_func
(paren
id|cmd-&gt;wait
comma
id|cmd-&gt;status
op_eq
id|IBMASM_CMD_COMPLETE
op_logical_or
id|cmd-&gt;status
op_eq
id|IBMASM_CMD_FAILED
comma
id|timeout
op_star
id|HZ
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * receive_command_response&n; * called by the interrupt handler when a dot command of type command_response&n; * was received.&n; */
DECL|function|ibmasm_receive_command_response
r_void
id|ibmasm_receive_command_response
c_func
(paren
r_struct
id|service_processor
op_star
id|sp
comma
r_void
op_star
id|response
comma
r_int
id|size
)paren
(brace
r_struct
id|command
op_star
id|cmd
op_assign
id|sp-&gt;current_command
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sp-&gt;current_command
)paren
r_return
suffix:semicolon
id|memcpy
c_func
(paren
id|cmd-&gt;buffer
comma
id|response
comma
id|min
c_func
(paren
id|size
comma
id|cmd-&gt;buffer_size
)paren
)paren
suffix:semicolon
id|cmd-&gt;status
op_assign
id|IBMASM_CMD_COMPLETE
suffix:semicolon
id|exec_next_command
c_func
(paren
id|sp
)paren
suffix:semicolon
)brace
eof
