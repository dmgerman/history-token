multiline_comment|/*&n; * IBM ASM Service Processor Device Driver&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or&n; * (at your option) any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.&n; *&n; * Copyright (C) IBM Corporation, 2004&n; *&n; * Author: Max Asb&#xfffd;ck &lt;amax@us.ibm.com&gt; &n; *&n; */
macro_line|#include &lt;linux/notifier.h&gt;
macro_line|#include &quot;ibmasm.h&quot;
macro_line|#include &quot;dot_command.h&quot;
DECL|variable|suspend_heartbeats
r_static
r_int
id|suspend_heartbeats
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n; * Once the driver indicates to the service processor that it is running&n; * - see send_os_state() - the service processor sends periodic heartbeats&n; * to the driver. The driver must respond to the heartbeats or else the OS&n; * will be rebooted.&n; * In the case of a panic the interrupt handler continues to work and thus&n; * continues to respond to heartbeats, making the service processor believe&n; * the OS is still running and thus preventing a reboot.&n; * To prevent this from happening a callback is added the panic_notifier_list.&n; * Before responding to a heartbeat the driver checks if a panic has happened,&n; * if yes it suspends heartbeat, causing the service processor to reboot as&n; * expected.&n; */
DECL|function|panic_happened
r_static
r_int
id|panic_happened
c_func
(paren
r_struct
id|notifier_block
op_star
id|n
comma
r_int
r_int
id|val
comma
r_void
op_star
id|v
)paren
(brace
id|suspend_heartbeats
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|panic_notifier
r_static
r_struct
id|notifier_block
id|panic_notifier
op_assign
(brace
id|panic_happened
comma
l_int|NULL
comma
l_int|1
)brace
suffix:semicolon
DECL|function|ibmasm_register_panic_notifier
r_void
id|ibmasm_register_panic_notifier
c_func
(paren
r_void
)paren
(brace
id|notifier_chain_register
c_func
(paren
op_amp
id|panic_notifier_list
comma
op_amp
id|panic_notifier
)paren
suffix:semicolon
)brace
DECL|function|ibmasm_unregister_panic_notifier
r_void
id|ibmasm_unregister_panic_notifier
c_func
(paren
r_void
)paren
(brace
id|notifier_chain_unregister
c_func
(paren
op_amp
id|panic_notifier_list
comma
op_amp
id|panic_notifier
)paren
suffix:semicolon
)brace
DECL|function|ibmasm_heartbeat_init
r_int
id|ibmasm_heartbeat_init
c_func
(paren
r_struct
id|service_processor
op_star
id|sp
)paren
(brace
id|sp-&gt;heartbeat
op_assign
id|ibmasm_new_command
c_func
(paren
id|HEARTBEAT_BUFFER_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sp-&gt;heartbeat
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ibmasm_heartbeat_exit
r_void
id|ibmasm_heartbeat_exit
c_func
(paren
r_struct
id|service_processor
op_star
id|sp
)paren
(brace
id|command_put
c_func
(paren
id|sp-&gt;heartbeat
)paren
suffix:semicolon
)brace
DECL|function|ibmasm_receive_heartbeat
r_void
id|ibmasm_receive_heartbeat
c_func
(paren
r_struct
id|service_processor
op_star
id|sp
comma
r_void
op_star
id|message
comma
r_int
id|size
)paren
(brace
r_struct
id|command
op_star
id|cmd
op_assign
id|sp-&gt;heartbeat
suffix:semicolon
r_struct
id|dot_command_header
op_star
id|header
op_assign
(paren
r_struct
id|dot_command_header
op_star
)paren
id|cmd-&gt;buffer
suffix:semicolon
r_if
c_cond
(paren
id|suspend_heartbeats
)paren
r_return
suffix:semicolon
multiline_comment|/* return the received dot command to sender */
id|cmd-&gt;status
op_assign
id|IBMASM_CMD_PENDING
suffix:semicolon
id|size
op_assign
id|min
c_func
(paren
id|size
comma
id|cmd-&gt;buffer_size
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|cmd-&gt;buffer
comma
id|message
comma
id|size
)paren
suffix:semicolon
id|header-&gt;type
op_assign
id|sp_write
suffix:semicolon
id|ibmasm_exec_command
c_func
(paren
id|sp
comma
id|cmd
)paren
suffix:semicolon
)brace
eof
