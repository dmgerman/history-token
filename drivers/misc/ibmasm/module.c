multiline_comment|/*&n; * IBM ASM Service Processor Device Driver&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or&n; * (at your option) any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.&n; *&n; * Copyright (C) IBM Corporation, 2004&n; *&n; * Author: Max Asb&#xfffd;ck &lt;amax@us.ibm.com&gt; &n; *&n; * This driver is based on code originally written by Pete Reynolds &n; * and others.&n; *&n; */
multiline_comment|/*&n; * The ASM device driver does the following things:&n; *&n; * 1) When loaded it sends a message to the service processor,&n; * indicating that an OS is * running. This causes the service processor&n; * to send periodic heartbeats to the OS. &n; *&n; * 2) Answers the periodic heartbeats sent by the service processor.&n; * Failure to do so would result in system reboot.&n; *&n; * 3) Acts as a pass through for dot commands sent from user applications.&n; * The interface for this is the ibmasmfs file system. &n; *&n; * 4) Allows user applications to register for event notification. Events&n; * are sent to the driver through interrupts. They can be read from user&n; * space through the ibmasmfs file system.&n; *&n; * 5) Allows user space applications to send heartbeats to the service&n; * processor (aka reverse heartbeats). Again this happens through ibmasmfs.&n; *&n; * 6) Handles remote mouse and keyboard event interrupts and makes them&n; * available to user applications through ibmasmfs.&n; *&n; */
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &quot;ibmasm.h&quot;
macro_line|#include &quot;lowlevel.h&quot;
macro_line|#include &quot;remote.h&quot;
DECL|function|ibmasm_init_one
r_static
r_int
id|__devinit
id|ibmasm_init_one
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
comma
r_const
r_struct
id|pci_device_id
op_star
id|id
)paren
(brace
r_int
id|err
comma
id|result
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_struct
id|service_processor
op_star
id|sp
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|pci_enable_device
c_func
(paren
id|pdev
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: can&squot;t enable PCI device at %s&bslash;n&quot;
comma
id|DRIVER_NAME
comma
id|pci_name
c_func
(paren
id|pdev
)paren
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|sp
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|service_processor
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sp
op_eq
l_int|NULL
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|pdev-&gt;dev
comma
l_string|&quot;Failed to allocate memory&bslash;n&quot;
)paren
suffix:semicolon
id|result
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|error_kmalloc
suffix:semicolon
)brace
id|memset
c_func
(paren
id|sp
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|service_processor
)paren
)paren
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|pdev
comma
(paren
r_void
op_star
)paren
id|sp
)paren
suffix:semicolon
id|sp-&gt;dev
op_assign
op_amp
id|pdev-&gt;dev
suffix:semicolon
id|sp-&gt;number
op_assign
id|pdev-&gt;bus-&gt;number
suffix:semicolon
id|snprintf
c_func
(paren
id|sp-&gt;dirname
comma
id|IBMASM_NAME_SIZE
comma
l_string|&quot;%d&quot;
comma
id|sp-&gt;number
)paren
suffix:semicolon
id|snprintf
c_func
(paren
id|sp-&gt;devname
comma
id|IBMASM_NAME_SIZE
comma
l_string|&quot;%s%d&quot;
comma
id|DRIVER_NAME
comma
id|sp-&gt;number
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ibmasm_event_buffer_init
c_func
(paren
id|sp
)paren
)paren
(brace
id|dev_err
c_func
(paren
id|sp-&gt;dev
comma
l_string|&quot;Failed to allocate event buffer&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|error_eventbuffer
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ibmasm_heartbeat_init
c_func
(paren
id|sp
)paren
)paren
(brace
id|dev_err
c_func
(paren
id|sp-&gt;dev
comma
l_string|&quot;Failed to allocate heartbeat command&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|error_heartbeat
suffix:semicolon
)brace
id|sp-&gt;irq
op_assign
id|pdev-&gt;irq
suffix:semicolon
id|sp-&gt;base_address
op_assign
id|ioremap
c_func
(paren
id|pci_resource_start
c_func
(paren
id|pdev
comma
l_int|0
)paren
comma
id|pci_resource_len
c_func
(paren
id|pdev
comma
l_int|0
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sp-&gt;base_address
op_eq
l_int|0
)paren
(brace
id|dev_err
c_func
(paren
id|sp-&gt;dev
comma
l_string|&quot;Failed to ioremap pci memory&bslash;n&quot;
)paren
suffix:semicolon
id|result
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|error_ioremap
suffix:semicolon
)brace
id|result
op_assign
id|ibmasm_init_remote_queue
c_func
(paren
id|sp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
(brace
id|dev_err
c_func
(paren
id|sp-&gt;dev
comma
l_string|&quot;Failed to initialize remote queue&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|error_remote_queue
suffix:semicolon
)brace
id|sp-&gt;lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|sp-&gt;command_queue
)paren
suffix:semicolon
id|result
op_assign
id|request_irq
c_func
(paren
id|sp-&gt;irq
comma
id|ibmasm_interrupt_handler
comma
id|SA_SHIRQ
comma
id|sp-&gt;devname
comma
(paren
r_void
op_star
)paren
id|sp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
(brace
id|dev_err
c_func
(paren
id|sp-&gt;dev
comma
l_string|&quot;Failed to register interrupt handler&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|error_request_irq
suffix:semicolon
)brace
id|enable_sp_interrupts
c_func
(paren
id|sp-&gt;base_address
)paren
suffix:semicolon
id|disable_mouse_interrupts
c_func
(paren
id|sp
)paren
suffix:semicolon
id|result
op_assign
id|ibmasm_send_driver_vpd
c_func
(paren
id|sp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
(brace
id|dev_err
c_func
(paren
id|sp-&gt;dev
comma
l_string|&quot;Failed to send driver VPD to service processor&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|error_send_message
suffix:semicolon
)brace
id|result
op_assign
id|ibmasm_send_os_state
c_func
(paren
id|sp
comma
id|SYSTEM_STATE_OS_UP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
(brace
id|dev_err
c_func
(paren
id|sp-&gt;dev
comma
l_string|&quot;Failed to send OS state to service processor&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|error_send_message
suffix:semicolon
)brace
id|ibmasmfs_add_sp
c_func
(paren
id|sp
)paren
suffix:semicolon
id|ibmasm_register_uart
c_func
(paren
id|sp
)paren
suffix:semicolon
id|dev_printk
c_func
(paren
id|KERN_DEBUG
comma
op_amp
id|pdev-&gt;dev
comma
l_string|&quot;WARNING: This software may not be supported or function&bslash;n&quot;
)paren
suffix:semicolon
id|dev_printk
c_func
(paren
id|KERN_DEBUG
comma
op_amp
id|pdev-&gt;dev
comma
l_string|&quot;correctly on your IBM server. Please consult the IBM&bslash;n&quot;
)paren
suffix:semicolon
id|dev_printk
c_func
(paren
id|KERN_DEBUG
comma
op_amp
id|pdev-&gt;dev
comma
l_string|&quot;ServerProven website&bslash;n&quot;
)paren
suffix:semicolon
id|dev_printk
c_func
(paren
id|KERN_DEBUG
comma
op_amp
id|pdev-&gt;dev
comma
l_string|&quot;http://www.pc.ibm.com/ww/eserver/xseries/serverproven&bslash;n&quot;
)paren
suffix:semicolon
id|dev_printk
c_func
(paren
id|KERN_DEBUG
comma
op_amp
id|pdev-&gt;dev
comma
l_string|&quot;for information on the specific driver level and support&bslash;n&quot;
)paren
suffix:semicolon
id|dev_printk
c_func
(paren
id|KERN_DEBUG
comma
op_amp
id|pdev-&gt;dev
comma
l_string|&quot;statement for your IBM server.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|error_send_message
suffix:colon
id|disable_sp_interrupts
c_func
(paren
id|sp-&gt;base_address
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|sp-&gt;irq
comma
(paren
r_void
op_star
)paren
id|sp
)paren
suffix:semicolon
id|error_request_irq
suffix:colon
id|ibmasm_free_remote_queue
c_func
(paren
id|sp
)paren
suffix:semicolon
id|error_remote_queue
suffix:colon
id|iounmap
c_func
(paren
id|sp-&gt;base_address
)paren
suffix:semicolon
id|error_ioremap
suffix:colon
id|ibmasm_heartbeat_exit
c_func
(paren
id|sp
)paren
suffix:semicolon
id|error_heartbeat
suffix:colon
id|ibmasm_event_buffer_exit
c_func
(paren
id|sp
)paren
suffix:semicolon
id|error_eventbuffer
suffix:colon
id|kfree
c_func
(paren
id|sp
)paren
suffix:semicolon
id|error_kmalloc
suffix:colon
id|pci_disable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
DECL|function|ibmasm_remove_one
r_static
r_void
id|__devexit
id|ibmasm_remove_one
c_func
(paren
r_struct
id|pci_dev
op_star
id|pdev
)paren
(brace
r_struct
id|service_processor
op_star
id|sp
op_assign
(paren
r_struct
id|service_processor
op_star
)paren
id|pci_get_drvdata
c_func
(paren
id|pdev
)paren
suffix:semicolon
id|ibmasm_unregister_uart
c_func
(paren
id|sp
)paren
suffix:semicolon
id|ibmasm_send_os_state
c_func
(paren
id|sp
comma
id|SYSTEM_STATE_OS_DOWN
)paren
suffix:semicolon
id|disable_sp_interrupts
c_func
(paren
id|sp-&gt;base_address
)paren
suffix:semicolon
id|disable_mouse_interrupts
c_func
(paren
id|sp
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|sp-&gt;irq
comma
(paren
r_void
op_star
)paren
id|sp
)paren
suffix:semicolon
id|ibmasm_heartbeat_exit
c_func
(paren
id|sp
)paren
suffix:semicolon
id|ibmasm_free_remote_queue
c_func
(paren
id|sp
)paren
suffix:semicolon
id|iounmap
c_func
(paren
id|sp-&gt;base_address
)paren
suffix:semicolon
id|ibmasm_event_buffer_exit
c_func
(paren
id|sp
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|sp
)paren
suffix:semicolon
id|pci_disable_device
c_func
(paren
id|pdev
)paren
suffix:semicolon
)brace
DECL|variable|ibmasm_pci_table
r_static
r_struct
id|pci_device_id
id|ibmasm_pci_table
(braket
)braket
op_assign
(brace
(brace
id|PCI_DEVICE
c_func
(paren
id|VENDORID_IBM
comma
id|DEVICEID_RSA
)paren
)brace
comma
(brace
)brace
comma
)brace
suffix:semicolon
DECL|variable|ibmasm_driver
r_static
r_struct
id|pci_driver
id|ibmasm_driver
op_assign
(brace
dot
id|name
op_assign
id|DRIVER_NAME
comma
dot
id|id_table
op_assign
id|ibmasm_pci_table
comma
dot
id|probe
op_assign
id|ibmasm_init_one
comma
dot
id|remove
op_assign
id|__devexit_p
c_func
(paren
id|ibmasm_remove_one
)paren
comma
)brace
suffix:semicolon
DECL|function|ibmasm_exit
r_static
r_void
id|__exit
id|ibmasm_exit
(paren
r_void
)paren
(brace
id|ibmasm_unregister_panic_notifier
c_func
(paren
)paren
suffix:semicolon
id|ibmasmfs_unregister
c_func
(paren
)paren
suffix:semicolon
id|pci_unregister_driver
c_func
(paren
op_amp
id|ibmasm_driver
)paren
suffix:semicolon
id|info
c_func
(paren
id|DRIVER_DESC
l_string|&quot; version &quot;
id|DRIVER_VERSION
l_string|&quot; unloaded&quot;
)paren
suffix:semicolon
)brace
DECL|function|ibmasm_init
r_static
r_int
id|__init
id|ibmasm_init
c_func
(paren
r_void
)paren
(brace
r_int
id|result
suffix:semicolon
id|result
op_assign
id|ibmasmfs_register
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
(brace
id|err
c_func
(paren
l_string|&quot;Failed to register ibmasmfs file system&quot;
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
id|result
op_assign
id|pci_register_driver
c_func
(paren
op_amp
id|ibmasm_driver
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
(brace
id|ibmasmfs_unregister
c_func
(paren
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
id|ibmasm_register_panic_notifier
c_func
(paren
)paren
suffix:semicolon
id|info
c_func
(paren
id|DRIVER_DESC
l_string|&quot; version &quot;
id|DRIVER_VERSION
l_string|&quot; loaded&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|ibmasm_init
id|module_init
c_func
(paren
id|ibmasm_init
)paren
suffix:semicolon
DECL|variable|ibmasm_exit
id|module_exit
c_func
(paren
id|ibmasm_exit
)paren
suffix:semicolon
DECL|variable|DRIVER_AUTHOR
id|MODULE_AUTHOR
c_func
(paren
id|DRIVER_AUTHOR
)paren
suffix:semicolon
DECL|variable|DRIVER_DESC
id|MODULE_DESCRIPTION
c_func
(paren
id|DRIVER_DESC
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
eof
