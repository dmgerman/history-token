multiline_comment|/*&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or&n; * (at your option) any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.&n; *&n; * Copyright (C) IBM Corporation, 2004&n; *&n; * Author: Max Asb&#xfffd;ck &lt;amax@us.ibm.com&gt; &n; *&n; */
macro_line|#include &quot;ibmasm.h&quot;
macro_line|#include &quot;dot_command.h&quot;
multiline_comment|/*&n; * Reverse Heartbeat, i.e. heartbeats sent from the driver to the&n; * service processor.&n; * These heartbeats are initiated by user level programs.&n; */
multiline_comment|/* the reverse heartbeat dot command */
macro_line|#pragma pack(1)
r_static
r_struct
(brace
DECL|member|header
r_struct
id|dot_command_header
id|header
suffix:semicolon
DECL|member|command
r_int
r_char
id|command
(braket
l_int|3
)braket
suffix:semicolon
DECL|variable|rhb_dot_cmd
)brace
id|rhb_dot_cmd
op_assign
(brace
dot
id|header
op_assign
(brace
dot
id|type
op_assign
id|sp_read
comma
dot
id|command_size
op_assign
l_int|3
comma
dot
id|data_size
op_assign
l_int|0
comma
dot
id|status
op_assign
l_int|0
)brace
comma
dot
id|command
op_assign
(brace
l_int|4
comma
l_int|3
comma
l_int|6
)brace
)brace
suffix:semicolon
macro_line|#pragma pack()
DECL|function|ibmasm_init_reverse_heartbeat
r_void
id|ibmasm_init_reverse_heartbeat
c_func
(paren
r_struct
id|service_processor
op_star
id|sp
comma
r_struct
id|reverse_heartbeat
op_star
id|rhb
)paren
(brace
id|init_waitqueue_head
c_func
(paren
op_amp
id|rhb-&gt;wait
)paren
suffix:semicolon
id|rhb-&gt;stopped
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * start_reverse_heartbeat&n; * Loop forever, sending a reverse heartbeat dot command to the service&n; * processor, then sleeping. The loop comes to an end if the service&n; * processor fails to respond 3 times or we were interrupted.&n; */
DECL|function|ibmasm_start_reverse_heartbeat
r_int
id|ibmasm_start_reverse_heartbeat
c_func
(paren
r_struct
id|service_processor
op_star
id|sp
comma
r_struct
id|reverse_heartbeat
op_star
id|rhb
)paren
(brace
r_struct
id|command
op_star
id|cmd
suffix:semicolon
r_int
id|times_failed
op_assign
l_int|0
suffix:semicolon
r_int
id|result
op_assign
l_int|1
suffix:semicolon
id|cmd
op_assign
id|ibmasm_new_command
c_func
(paren
r_sizeof
id|rhb_dot_cmd
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cmd
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
r_while
c_loop
(paren
id|times_failed
OL
l_int|3
)paren
(brace
id|memcpy
c_func
(paren
id|cmd-&gt;buffer
comma
(paren
r_void
op_star
)paren
op_amp
id|rhb_dot_cmd
comma
r_sizeof
id|rhb_dot_cmd
)paren
suffix:semicolon
id|cmd-&gt;status
op_assign
id|IBMASM_CMD_PENDING
suffix:semicolon
id|ibmasm_exec_command
c_func
(paren
id|sp
comma
id|cmd
)paren
suffix:semicolon
id|ibmasm_wait_for_response
c_func
(paren
id|cmd
comma
id|IBMASM_CMD_TIMEOUT_NORMAL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmd-&gt;status
op_ne
id|IBMASM_CMD_COMPLETE
)paren
id|times_failed
op_increment
suffix:semicolon
id|wait_event_interruptible_timeout
c_func
(paren
id|rhb-&gt;wait
comma
id|rhb-&gt;stopped
comma
id|REVERSE_HEARTBEAT_TIMEOUT
op_star
id|HZ
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
op_logical_or
id|rhb-&gt;stopped
)paren
(brace
id|result
op_assign
op_minus
id|EINTR
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|command_put
c_func
(paren
id|cmd
)paren
suffix:semicolon
id|rhb-&gt;stopped
op_assign
l_int|0
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
DECL|function|ibmasm_stop_reverse_heartbeat
r_void
id|ibmasm_stop_reverse_heartbeat
c_func
(paren
r_struct
id|reverse_heartbeat
op_star
id|rhb
)paren
(brace
id|rhb-&gt;stopped
op_assign
l_int|1
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|rhb-&gt;wait
)paren
suffix:semicolon
)brace
eof
