multiline_comment|/*&n; * IBM ASM Service Processor Device Driver&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or&n; * (at your option) any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.&n; *&n; * Copyright (C) IBM Corporation, 2004&n; *&n; * Author: Max Asb&#xfffd;ck &lt;amax@us.ibm.com&gt; &n; *&n; */
macro_line|#include &quot;ibmasm.h&quot;
macro_line|#include &quot;dot_command.h&quot;
multiline_comment|/**&n; * Dispatch an incoming message to the specific handler for the message.&n; * Called from interrupt context.&n; */
DECL|function|ibmasm_receive_message
r_void
id|ibmasm_receive_message
c_func
(paren
r_struct
id|service_processor
op_star
id|sp
comma
r_void
op_star
id|message
comma
r_int
id|message_size
)paren
(brace
id|u32
id|size
suffix:semicolon
r_struct
id|dot_command_header
op_star
id|header
op_assign
(paren
r_struct
id|dot_command_header
op_star
)paren
id|message
suffix:semicolon
id|size
op_assign
id|get_dot_command_size
c_func
(paren
id|message
)paren
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
id|message_size
)paren
id|size
op_assign
id|message_size
suffix:semicolon
r_switch
c_cond
(paren
id|header-&gt;type
)paren
(brace
r_case
id|sp_event
suffix:colon
id|ibmasm_receive_event
c_func
(paren
id|sp
comma
id|message
comma
id|size
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|sp_command_response
suffix:colon
id|ibmasm_receive_command_response
c_func
(paren
id|sp
comma
id|message
comma
id|size
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|sp_heartbeat
suffix:colon
id|ibmasm_receive_heartbeat
c_func
(paren
id|sp
comma
id|message
comma
id|size
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|dev_err
c_func
(paren
id|sp-&gt;dev
comma
l_string|&quot;Received unknown message from service processor&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
DECL|macro|INIT_BUFFER_SIZE
mdefine_line|#define INIT_BUFFER_SIZE 32
multiline_comment|/**&n; * send the 4.3.5.10 dot command (driver VPD) to the service processor&n; */
DECL|function|ibmasm_send_driver_vpd
r_int
id|ibmasm_send_driver_vpd
c_func
(paren
r_struct
id|service_processor
op_star
id|sp
)paren
(brace
r_struct
id|command
op_star
id|command
suffix:semicolon
r_struct
id|dot_command_header
op_star
id|header
suffix:semicolon
id|u8
op_star
id|vpd_command
suffix:semicolon
id|u8
op_star
id|vpd_data
suffix:semicolon
r_int
id|result
op_assign
l_int|0
suffix:semicolon
id|command
op_assign
id|ibmasm_new_command
c_func
(paren
id|INIT_BUFFER_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|command
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|header
op_assign
(paren
r_struct
id|dot_command_header
op_star
)paren
id|command-&gt;buffer
suffix:semicolon
id|header-&gt;type
op_assign
id|sp_write
suffix:semicolon
id|header-&gt;command_size
op_assign
l_int|4
suffix:semicolon
id|header-&gt;data_size
op_assign
l_int|16
suffix:semicolon
id|header-&gt;status
op_assign
l_int|0
suffix:semicolon
id|header-&gt;reserved
op_assign
l_int|0
suffix:semicolon
id|vpd_command
op_assign
id|command-&gt;buffer
op_plus
r_sizeof
(paren
r_struct
id|dot_command_header
)paren
suffix:semicolon
id|vpd_command
(braket
l_int|0
)braket
op_assign
l_int|0x4
suffix:semicolon
id|vpd_command
(braket
l_int|1
)braket
op_assign
l_int|0x3
suffix:semicolon
id|vpd_command
(braket
l_int|2
)braket
op_assign
l_int|0x5
suffix:semicolon
id|vpd_command
(braket
l_int|3
)braket
op_assign
l_int|0xa
suffix:semicolon
id|vpd_data
op_assign
id|vpd_command
op_plus
id|header-&gt;command_size
suffix:semicolon
id|vpd_data
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|strcat
c_func
(paren
id|vpd_data
comma
id|IBMASM_DRIVER_VPD
)paren
suffix:semicolon
id|vpd_data
(braket
l_int|10
)braket
op_assign
l_int|0
suffix:semicolon
id|vpd_data
(braket
l_int|15
)braket
op_assign
l_int|0
suffix:semicolon
id|ibmasm_exec_command
c_func
(paren
id|sp
comma
id|command
)paren
suffix:semicolon
id|ibmasm_wait_for_response
c_func
(paren
id|command
comma
id|IBMASM_CMD_TIMEOUT_NORMAL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|command-&gt;status
op_ne
id|IBMASM_CMD_COMPLETE
)paren
id|result
op_assign
op_minus
id|ENODEV
suffix:semicolon
id|command_put
c_func
(paren
id|command
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
DECL|struct|os_state_command
r_struct
id|os_state_command
(brace
DECL|member|header
r_struct
id|dot_command_header
id|header
suffix:semicolon
DECL|member|command
r_int
r_char
id|command
(braket
l_int|3
)braket
suffix:semicolon
DECL|member|data
r_int
r_char
id|data
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/**&n; * send the 4.3.6 dot command (os state) to the service processor&n; * During driver init this function is called with os state &quot;up&quot;.&n; * This causes the service processor to start sending heartbeats the&n; * driver.&n; * During driver exit the function is called with os state &quot;down&quot;, &n; * causing the service processor to stop the heartbeats.&n; */
DECL|function|ibmasm_send_os_state
r_int
id|ibmasm_send_os_state
c_func
(paren
r_struct
id|service_processor
op_star
id|sp
comma
r_int
id|os_state
)paren
(brace
r_struct
id|command
op_star
id|cmd
suffix:semicolon
r_struct
id|os_state_command
op_star
id|os_state_cmd
suffix:semicolon
r_int
id|result
op_assign
l_int|0
suffix:semicolon
id|cmd
op_assign
id|ibmasm_new_command
c_func
(paren
r_sizeof
(paren
r_struct
id|os_state_command
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|os_state_cmd
op_assign
(paren
r_struct
id|os_state_command
op_star
)paren
id|cmd-&gt;buffer
suffix:semicolon
id|os_state_cmd-&gt;header.type
op_assign
id|sp_write
suffix:semicolon
id|os_state_cmd-&gt;header.command_size
op_assign
l_int|3
suffix:semicolon
id|os_state_cmd-&gt;header.data_size
op_assign
l_int|1
suffix:semicolon
id|os_state_cmd-&gt;header.status
op_assign
l_int|0
suffix:semicolon
id|os_state_cmd-&gt;command
(braket
l_int|0
)braket
op_assign
l_int|4
suffix:semicolon
id|os_state_cmd-&gt;command
(braket
l_int|1
)braket
op_assign
l_int|3
suffix:semicolon
id|os_state_cmd-&gt;command
(braket
l_int|2
)braket
op_assign
l_int|6
suffix:semicolon
id|os_state_cmd-&gt;data
op_assign
id|os_state
suffix:semicolon
id|ibmasm_exec_command
c_func
(paren
id|sp
comma
id|cmd
)paren
suffix:semicolon
id|ibmasm_wait_for_response
c_func
(paren
id|cmd
comma
id|IBMASM_CMD_TIMEOUT_NORMAL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmd-&gt;status
op_ne
id|IBMASM_CMD_COMPLETE
)paren
id|result
op_assign
op_minus
id|ENODEV
suffix:semicolon
id|command_put
c_func
(paren
id|cmd
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
eof
