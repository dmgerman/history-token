multiline_comment|/*&n; *  pc87360.c - Part of lm_sensors, Linux kernel modules&n; *              for hardware monitoring&n; *  Copyright (C) 2004 Jean Delvare &lt;khali@linux-fr.org&gt;&n; *&n; *  Copied from smsc47m1.c:&n; *  Copyright (C) 2002 Mark D. Studebaker &lt;mdsxyz123@yahoo.com&gt;&n; *&n; *  This program is free software; you can redistribute it and/or modify&n; *  it under the terms of the GNU General Public License as published by&n; *  the Free Software Foundation; either version 2 of the License, or&n; *  (at your option) any later version.&n; *&n; *  This program is distributed in the hope that it will be useful,&n; *  but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *  GNU General Public License for more details.&n; *&n; *  You should have received a copy of the GNU General Public License&n; *  along with this program; if not, write to the Free Software&n; *  Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; *  Supports the following chips:&n; *&n; *  Chip        #vin    #fan    #pwm    #temp   devid&n; *  PC87360     -       2       2       -       0xE1&n; *  PC87363     -       2       2       -       0xE8&n; *  PC87364     -       3       3       -       0xE4&n; *  PC87365     11      3       3       2       0xE5&n; *  PC87366     11      3       3       3-4     0xE9&n; *&n; *  This driver assumes that no more than one chip is present, and one of&n; *  the standard Super-I/O addresses is used (0x2E/0x2F or 0x4E/0x4F).&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/jiffies.h&gt;
macro_line|#include &lt;linux/i2c.h&gt;
macro_line|#include &lt;linux/i2c-sensor.h&gt;
macro_line|#include &lt;linux/i2c-vid.h&gt;
macro_line|#include &lt;asm/io.h&gt;
DECL|variable|normal_i2c
r_static
r_int
r_int
id|normal_i2c
(braket
)braket
op_assign
(brace
id|I2C_CLIENT_END
)brace
suffix:semicolon
DECL|variable|normal_isa
r_static
r_int
r_int
id|normal_isa
(braket
)braket
op_assign
(brace
l_int|0
comma
id|I2C_CLIENT_ISA_END
)brace
suffix:semicolon
DECL|variable|forces
r_static
r_struct
id|i2c_force_data
id|forces
(braket
)braket
op_assign
(brace
(brace
l_int|NULL
)brace
)brace
suffix:semicolon
DECL|variable|devid
r_static
id|u8
id|devid
suffix:semicolon
DECL|variable|extra_isa
r_static
r_int
r_int
id|extra_isa
(braket
l_int|3
)braket
suffix:semicolon
DECL|variable|confreg
r_static
id|u8
id|confreg
(braket
l_int|4
)braket
suffix:semicolon
DECL|enum|chips
DECL|enumerator|any_chip
DECL|enumerator|pc87360
DECL|enumerator|pc87363
DECL|enumerator|pc87364
DECL|enumerator|pc87365
DECL|enumerator|pc87366
r_enum
id|chips
(brace
id|any_chip
comma
id|pc87360
comma
id|pc87363
comma
id|pc87364
comma
id|pc87365
comma
id|pc87366
)brace
suffix:semicolon
DECL|variable|addr_data
r_static
r_struct
id|i2c_address_data
id|addr_data
op_assign
(brace
dot
id|normal_i2c
op_assign
id|normal_i2c
comma
dot
id|normal_isa
op_assign
id|normal_isa
comma
dot
id|forces
op_assign
id|forces
comma
)brace
suffix:semicolon
DECL|variable|init
r_static
r_int
id|init
op_assign
l_int|1
suffix:semicolon
id|module_param
c_func
(paren
id|init
comma
r_int
comma
l_int|0
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|init
comma
l_string|&quot;Chip initialization level:&bslash;n&quot;
l_string|&quot; 0: None&bslash;n&quot;
l_string|&quot;*1: Forcibly enable internal voltage and temperature channels, except in9&bslash;n&quot;
l_string|&quot; 2: Forcibly enable all voltage and temperature channels, except in9&bslash;n&quot;
l_string|&quot; 3: Forcibly enable all voltage and temperature channels, including in9&quot;
)paren
suffix:semicolon
multiline_comment|/*&n; * Super-I/O registers and operations&n; */
DECL|macro|DEV
mdefine_line|#define DEV&t;0x07&t;/* Register: Logical device select */
DECL|macro|DEVID
mdefine_line|#define DEVID&t;0x20&t;/* Register: Device ID */
DECL|macro|ACT
mdefine_line|#define ACT&t;0x30&t;/* Register: Device activation */
DECL|macro|BASE
mdefine_line|#define BASE&t;0x60&t;/* Register: Base address */
DECL|macro|FSCM
mdefine_line|#define FSCM&t;0x09&t;/* Logical device: fans */
DECL|macro|VLM
mdefine_line|#define VLM&t;0x0d&t;/* Logical device: voltages */
DECL|macro|TMS
mdefine_line|#define TMS&t;0x0e&t;/* Logical device: temperatures */
DECL|variable|logdev
r_static
r_const
id|u8
id|logdev
(braket
l_int|3
)braket
op_assign
(brace
id|FSCM
comma
id|VLM
comma
id|TMS
)brace
suffix:semicolon
DECL|macro|LD_FAN
mdefine_line|#define LD_FAN&t;&t;0
DECL|macro|LD_IN
mdefine_line|#define LD_IN&t;&t;1
DECL|macro|LD_TEMP
mdefine_line|#define LD_TEMP&t;&t;2
DECL|function|superio_outb
r_static
r_inline
r_void
id|superio_outb
c_func
(paren
r_int
id|sioaddr
comma
r_int
id|reg
comma
r_int
id|val
)paren
(brace
id|outb
c_func
(paren
id|reg
comma
id|sioaddr
)paren
suffix:semicolon
id|outb
c_func
(paren
id|val
comma
id|sioaddr
op_plus
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|superio_inb
r_static
r_inline
r_int
id|superio_inb
c_func
(paren
r_int
id|sioaddr
comma
r_int
id|reg
)paren
(brace
id|outb
c_func
(paren
id|reg
comma
id|sioaddr
)paren
suffix:semicolon
r_return
id|inb
c_func
(paren
id|sioaddr
op_plus
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|superio_exit
r_static
r_inline
r_void
id|superio_exit
c_func
(paren
r_int
id|sioaddr
)paren
(brace
id|outb
c_func
(paren
l_int|0x02
comma
id|sioaddr
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x02
comma
id|sioaddr
op_plus
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Logical devices&n; */
DECL|macro|PC87360_EXTENT
mdefine_line|#define PC87360_EXTENT&t;&t;0x10
DECL|macro|PC87365_REG_BANK
mdefine_line|#define PC87365_REG_BANK&t;0x09
DECL|macro|NO_BANK
mdefine_line|#define NO_BANK&t;&t;&t;0xff
multiline_comment|/*&n; * Fan registers and conversions&n; */
multiline_comment|/* nr has to be 0 or 1 (PC87360/87363) or 2 (PC87364/87365/87366) */
DECL|macro|PC87360_REG_PRESCALE
mdefine_line|#define PC87360_REG_PRESCALE(nr)&t;(0x00 + 2 * (nr))
DECL|macro|PC87360_REG_PWM
mdefine_line|#define PC87360_REG_PWM(nr)&t;&t;(0x01 + 2 * (nr))
DECL|macro|PC87360_REG_FAN_MIN
mdefine_line|#define PC87360_REG_FAN_MIN(nr)&t;&t;(0x06 + 3 * (nr))
DECL|macro|PC87360_REG_FAN
mdefine_line|#define PC87360_REG_FAN(nr)&t;&t;(0x07 + 3 * (nr))
DECL|macro|PC87360_REG_FAN_STATUS
mdefine_line|#define PC87360_REG_FAN_STATUS(nr)&t;(0x08 + 3 * (nr))
DECL|macro|FAN_FROM_REG
mdefine_line|#define FAN_FROM_REG(val,div)&t;&t;((val) == 0 ? 0: &bslash;&n;&t;&t;&t;&t;&t; 480000 / ((val)*(div)))
DECL|macro|FAN_TO_REG
mdefine_line|#define FAN_TO_REG(val,div)&t;&t;((val) &lt;= 100 ? 0 : &bslash;&n;&t;&t;&t;&t;&t; 480000 / ((val)*(div)))
DECL|macro|FAN_DIV_FROM_REG
mdefine_line|#define FAN_DIV_FROM_REG(val)&t;&t;(1 &lt;&lt; ((val &gt;&gt; 5) &amp; 0x03))
DECL|macro|FAN_STATUS_FROM_REG
mdefine_line|#define FAN_STATUS_FROM_REG(val)&t;((val) &amp; 0x07)
DECL|macro|FAN_CONFIG_MONITOR
mdefine_line|#define FAN_CONFIG_MONITOR(val,nr)&t;(((val) &gt;&gt; (2 + nr * 3)) &amp; 1)
DECL|macro|FAN_CONFIG_CONTROL
mdefine_line|#define FAN_CONFIG_CONTROL(val,nr)&t;(((val) &gt;&gt; (3 + nr * 3)) &amp; 1)
DECL|macro|FAN_CONFIG_INVERT
mdefine_line|#define FAN_CONFIG_INVERT(val,nr)&t;(((val) &gt;&gt; (4 + nr * 3)) &amp; 1)
DECL|macro|PWM_FROM_REG
mdefine_line|#define PWM_FROM_REG(val,inv)&t;&t;((inv) ? 255 - (val) : (val))
DECL|function|PWM_TO_REG
r_static
r_inline
id|u8
id|PWM_TO_REG
c_func
(paren
r_int
id|val
comma
r_int
id|inv
)paren
(brace
r_if
c_cond
(paren
id|inv
)paren
id|val
op_assign
l_int|255
op_minus
id|val
suffix:semicolon
r_if
c_cond
(paren
id|val
OL
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|val
OG
l_int|255
)paren
r_return
l_int|255
suffix:semicolon
r_return
id|val
suffix:semicolon
)brace
multiline_comment|/*&n; * Voltage registers and conversions&n; */
DECL|macro|PC87365_REG_IN_CONVRATE
mdefine_line|#define PC87365_REG_IN_CONVRATE&t;&t;0x07
DECL|macro|PC87365_REG_IN_CONFIG
mdefine_line|#define PC87365_REG_IN_CONFIG&t;&t;0x08
DECL|macro|PC87365_REG_IN
mdefine_line|#define PC87365_REG_IN&t;&t;&t;0x0B
DECL|macro|PC87365_REG_IN_MIN
mdefine_line|#define PC87365_REG_IN_MIN&t;&t;0x0D
DECL|macro|PC87365_REG_IN_MAX
mdefine_line|#define PC87365_REG_IN_MAX&t;&t;0x0C
DECL|macro|PC87365_REG_IN_STATUS
mdefine_line|#define PC87365_REG_IN_STATUS&t;&t;0x0A
DECL|macro|PC87365_REG_IN_ALARMS1
mdefine_line|#define PC87365_REG_IN_ALARMS1&t;&t;0x00
DECL|macro|PC87365_REG_IN_ALARMS2
mdefine_line|#define PC87365_REG_IN_ALARMS2&t;&t;0x01
DECL|macro|PC87365_REG_VID
mdefine_line|#define PC87365_REG_VID&t;&t;&t;0x06
DECL|macro|IN_FROM_REG
mdefine_line|#define IN_FROM_REG(val,ref)&t;&t;(((val) * (ref) + 128) / 256)
DECL|macro|IN_TO_REG
mdefine_line|#define IN_TO_REG(val,ref)&t;&t;((val) &lt; 0 ? 0 : &bslash;&n;&t;&t;&t;&t;&t; (val)*256 &gt;= (ref)*255 ? 255: &bslash;&n;&t;&t;&t;&t;&t; ((val) * 256 + (ref)/2) / (ref))
multiline_comment|/*&n; * Temperature registers and conversions&n; */
DECL|macro|PC87365_REG_TEMP_CONFIG
mdefine_line|#define PC87365_REG_TEMP_CONFIG&t;&t;0x08
DECL|macro|PC87365_REG_TEMP
mdefine_line|#define PC87365_REG_TEMP&t;&t;0x0B
DECL|macro|PC87365_REG_TEMP_MIN
mdefine_line|#define PC87365_REG_TEMP_MIN&t;&t;0x0D
DECL|macro|PC87365_REG_TEMP_MAX
mdefine_line|#define PC87365_REG_TEMP_MAX&t;&t;0x0C
DECL|macro|PC87365_REG_TEMP_CRIT
mdefine_line|#define PC87365_REG_TEMP_CRIT&t;&t;0x0E
DECL|macro|PC87365_REG_TEMP_STATUS
mdefine_line|#define PC87365_REG_TEMP_STATUS&t;&t;0x0A
DECL|macro|PC87365_REG_TEMP_ALARMS
mdefine_line|#define PC87365_REG_TEMP_ALARMS&t;&t;0x00
DECL|macro|TEMP_FROM_REG
mdefine_line|#define TEMP_FROM_REG(val)&t;&t;((val) * 1000)
DECL|macro|TEMP_TO_REG
mdefine_line|#define TEMP_TO_REG(val)&t;&t;((val) &lt; -55000 ? -55 : &bslash;&n;&t;&t;&t;&t;&t; (val) &gt; 127000 ? 127 : &bslash;&n;&t;&t;&t;&t;&t; (val) &lt; 0 ? ((val) - 500) / 1000 : &bslash;&n;&t;&t;&t;&t;&t; ((val) + 500) / 1000)
multiline_comment|/*&n; * Client data (each client gets its own)&n; */
DECL|struct|pc87360_data
r_struct
id|pc87360_data
(brace
DECL|member|client
r_struct
id|i2c_client
id|client
suffix:semicolon
DECL|member|lock
r_struct
id|semaphore
id|lock
suffix:semicolon
DECL|member|update_lock
r_struct
id|semaphore
id|update_lock
suffix:semicolon
DECL|member|valid
r_char
id|valid
suffix:semicolon
multiline_comment|/* !=0 if following fields are valid */
DECL|member|last_updated
r_int
r_int
id|last_updated
suffix:semicolon
multiline_comment|/* In jiffies */
DECL|member|address
r_int
id|address
(braket
l_int|3
)braket
suffix:semicolon
DECL|member|fannr
DECL|member|innr
DECL|member|tempnr
id|u8
id|fannr
comma
id|innr
comma
id|tempnr
suffix:semicolon
DECL|member|fan
id|u8
id|fan
(braket
l_int|3
)braket
suffix:semicolon
multiline_comment|/* Register value */
DECL|member|fan_min
id|u8
id|fan_min
(braket
l_int|3
)braket
suffix:semicolon
multiline_comment|/* Register value */
DECL|member|fan_status
id|u8
id|fan_status
(braket
l_int|3
)braket
suffix:semicolon
multiline_comment|/* Register value */
DECL|member|pwm
id|u8
id|pwm
(braket
l_int|3
)braket
suffix:semicolon
multiline_comment|/* Register value */
DECL|member|fan_conf
id|u16
id|fan_conf
suffix:semicolon
multiline_comment|/* Configuration register values, combined */
DECL|member|in_vref
id|u16
id|in_vref
suffix:semicolon
multiline_comment|/* 1 mV/bit */
DECL|member|in
id|u8
id|in
(braket
l_int|14
)braket
suffix:semicolon
multiline_comment|/* Register value */
DECL|member|in_min
id|u8
id|in_min
(braket
l_int|14
)braket
suffix:semicolon
multiline_comment|/* Register value */
DECL|member|in_max
id|u8
id|in_max
(braket
l_int|14
)braket
suffix:semicolon
multiline_comment|/* Register value */
DECL|member|in_crit
id|u8
id|in_crit
(braket
l_int|3
)braket
suffix:semicolon
multiline_comment|/* Register value */
DECL|member|in_status
id|u8
id|in_status
(braket
l_int|14
)braket
suffix:semicolon
multiline_comment|/* Register value */
DECL|member|in_alarms
id|u16
id|in_alarms
suffix:semicolon
multiline_comment|/* Register values, combined, masked */
DECL|member|vid_conf
id|u8
id|vid_conf
suffix:semicolon
multiline_comment|/* Configuration register value */
DECL|member|vrm
id|u8
id|vrm
suffix:semicolon
DECL|member|vid
id|u8
id|vid
suffix:semicolon
multiline_comment|/* Register value */
DECL|member|temp
id|s8
id|temp
(braket
l_int|3
)braket
suffix:semicolon
multiline_comment|/* Register value */
DECL|member|temp_min
id|s8
id|temp_min
(braket
l_int|3
)braket
suffix:semicolon
multiline_comment|/* Register value */
DECL|member|temp_max
id|s8
id|temp_max
(braket
l_int|3
)braket
suffix:semicolon
multiline_comment|/* Register value */
DECL|member|temp_crit
id|s8
id|temp_crit
(braket
l_int|3
)braket
suffix:semicolon
multiline_comment|/* Register value */
DECL|member|temp_status
id|u8
id|temp_status
(braket
l_int|3
)braket
suffix:semicolon
multiline_comment|/* Register value */
DECL|member|temp_alarms
id|u8
id|temp_alarms
suffix:semicolon
multiline_comment|/* Register value, masked */
)brace
suffix:semicolon
multiline_comment|/*&n; * Functions declaration&n; */
r_static
r_int
id|pc87360_attach_adapter
c_func
(paren
r_struct
id|i2c_adapter
op_star
id|adapter
)paren
suffix:semicolon
r_static
r_int
id|pc87360_detect
c_func
(paren
r_struct
id|i2c_adapter
op_star
id|adapter
comma
r_int
id|address
comma
r_int
id|kind
)paren
suffix:semicolon
r_static
r_int
id|pc87360_detach_client
c_func
(paren
r_struct
id|i2c_client
op_star
id|client
)paren
suffix:semicolon
r_static
r_int
id|pc87360_read_value
c_func
(paren
r_struct
id|pc87360_data
op_star
id|data
comma
id|u8
id|ldi
comma
id|u8
id|bank
comma
id|u8
id|reg
)paren
suffix:semicolon
r_static
r_void
id|pc87360_write_value
c_func
(paren
r_struct
id|pc87360_data
op_star
id|data
comma
id|u8
id|ldi
comma
id|u8
id|bank
comma
id|u8
id|reg
comma
id|u8
id|value
)paren
suffix:semicolon
r_static
r_void
id|pc87360_init_client
c_func
(paren
r_struct
id|i2c_client
op_star
id|client
comma
r_int
id|use_thermistors
)paren
suffix:semicolon
r_static
r_struct
id|pc87360_data
op_star
id|pc87360_update_device
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
multiline_comment|/*&n; * Driver data (common to all clients)&n; */
DECL|variable|pc87360_driver
r_static
r_struct
id|i2c_driver
id|pc87360_driver
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|name
op_assign
l_string|&quot;pc87360&quot;
comma
dot
id|flags
op_assign
id|I2C_DF_NOTIFY
comma
dot
id|attach_adapter
op_assign
id|pc87360_attach_adapter
comma
dot
id|detach_client
op_assign
id|pc87360_detach_client
comma
)brace
suffix:semicolon
multiline_comment|/*&n; * Sysfs stuff&n; */
DECL|function|set_fan_min
r_static
id|ssize_t
id|set_fan_min
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
comma
r_int
id|nr
)paren
(brace
r_struct
id|i2c_client
op_star
id|client
op_assign
id|to_i2c_client
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|pc87360_data
op_star
id|data
op_assign
id|i2c_get_clientdata
c_func
(paren
id|client
)paren
suffix:semicolon
r_int
id|fan_min
op_assign
id|simple_strtol
c_func
(paren
id|buf
comma
l_int|NULL
comma
l_int|10
)paren
suffix:semicolon
id|fan_min
op_assign
id|FAN_TO_REG
c_func
(paren
id|fan_min
comma
id|FAN_DIV_FROM_REG
c_func
(paren
id|data-&gt;fan_status
(braket
id|nr
)braket
)paren
)paren
suffix:semicolon
multiline_comment|/* If it wouldn&squot;t fit, change clock divisor */
r_while
c_loop
(paren
id|fan_min
OG
l_int|255
op_logical_and
(paren
id|data-&gt;fan_status
(braket
id|nr
)braket
op_amp
l_int|0x60
)paren
op_ne
l_int|0x60
)paren
(brace
id|fan_min
op_rshift_assign
l_int|1
suffix:semicolon
id|data-&gt;fan
(braket
id|nr
)braket
op_rshift_assign
l_int|1
suffix:semicolon
id|data-&gt;fan_status
(braket
id|nr
)braket
op_add_assign
l_int|0x20
suffix:semicolon
)brace
id|data-&gt;fan_min
(braket
id|nr
)braket
op_assign
id|fan_min
OG
l_int|255
ques
c_cond
l_int|255
suffix:colon
id|fan_min
suffix:semicolon
id|pc87360_write_value
c_func
(paren
id|data
comma
id|LD_FAN
comma
id|NO_BANK
comma
id|PC87360_REG_FAN_MIN
c_func
(paren
id|nr
)paren
comma
id|data-&gt;fan_min
(braket
id|nr
)braket
)paren
suffix:semicolon
multiline_comment|/* Write new divider, preserve alarm bits */
id|pc87360_write_value
c_func
(paren
id|data
comma
id|LD_FAN
comma
id|NO_BANK
comma
id|PC87360_REG_FAN_STATUS
c_func
(paren
id|nr
)paren
comma
id|data-&gt;fan_status
(braket
id|nr
)braket
op_amp
l_int|0xF9
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
DECL|macro|show_and_set_fan
mdefine_line|#define show_and_set_fan(offset) &bslash;&n;static ssize_t show_fan##offset##_input(struct device *dev, char *buf) &bslash;&n;{ &bslash;&n;&t;struct pc87360_data *data = pc87360_update_device(dev); &bslash;&n;&t;return sprintf(buf, &quot;%u&bslash;n&quot;, FAN_FROM_REG(data-&gt;fan[offset-1], &bslash;&n;&t;&t;       FAN_DIV_FROM_REG(data-&gt;fan_status[offset-1]))); &bslash;&n;} &bslash;&n;static ssize_t show_fan##offset##_min(struct device *dev, char *buf) &bslash;&n;{ &bslash;&n;&t;struct pc87360_data *data = pc87360_update_device(dev); &bslash;&n;&t;return sprintf(buf, &quot;%u&bslash;n&quot;, FAN_FROM_REG(data-&gt;fan_min[offset-1], &bslash;&n;&t;&t;       FAN_DIV_FROM_REG(data-&gt;fan_status[offset-1]))); &bslash;&n;} &bslash;&n;static ssize_t show_fan##offset##_div(struct device *dev, char *buf) &bslash;&n;{ &bslash;&n;&t;struct pc87360_data *data = pc87360_update_device(dev); &bslash;&n;&t;return sprintf(buf, &quot;%u&bslash;n&quot;, &bslash;&n;&t;&t;       FAN_DIV_FROM_REG(data-&gt;fan_status[offset-1])); &bslash;&n;} &bslash;&n;static ssize_t show_fan##offset##_status(struct device *dev, char *buf) &bslash;&n;{ &bslash;&n;&t;struct pc87360_data *data = pc87360_update_device(dev); &bslash;&n;&t;return sprintf(buf, &quot;%u&bslash;n&quot;, &bslash;&n;&t;&t;       FAN_STATUS_FROM_REG(data-&gt;fan_status[offset-1])); &bslash;&n;} &bslash;&n;static ssize_t set_fan##offset##_min(struct device *dev, const char *buf, &bslash;&n;&t;size_t count) &bslash;&n;{ &bslash;&n;&t;return set_fan_min(dev, buf, count, offset-1); &bslash;&n;} &bslash;&n;static DEVICE_ATTR(fan##offset##_input, S_IRUGO, &bslash;&n;&t;show_fan##offset##_input, NULL); &bslash;&n;static DEVICE_ATTR(fan##offset##_min, S_IWUSR | S_IRUGO, &bslash;&n;&t;show_fan##offset##_min, set_fan##offset##_min); &bslash;&n;static DEVICE_ATTR(fan##offset##_div, S_IRUGO, &bslash;&n;&t;show_fan##offset##_div, NULL); &bslash;&n;static DEVICE_ATTR(fan##offset##_status, S_IRUGO, &bslash;&n;&t;show_fan##offset##_status, NULL);
id|show_and_set_fan
c_func
(paren
l_int|1
)paren
id|show_and_set_fan
c_func
(paren
l_int|2
)paren
id|show_and_set_fan
c_func
(paren
l_int|3
)paren
DECL|macro|show_and_set_pwm
mdefine_line|#define show_and_set_pwm(offset) &bslash;&n;static ssize_t show_pwm##offset(struct device *dev, char *buf) &bslash;&n;{ &bslash;&n;&t;struct pc87360_data *data = pc87360_update_device(dev); &bslash;&n;&t;return sprintf(buf, &quot;%u&bslash;n&quot;, &bslash;&n;&t;&t;       PWM_FROM_REG(data-&gt;pwm[offset-1], &bslash;&n;&t;&t;&t;&t;    FAN_CONFIG_INVERT(data-&gt;fan_conf, &bslash;&n;&t;&t;&t;&t;&t;&t;      offset-1))); &bslash;&n;} &bslash;&n;static ssize_t set_pwm##offset(struct device *dev, const char *buf, &bslash;&n;&t;size_t count) &bslash;&n;{ &bslash;&n;&t;struct i2c_client *client = to_i2c_client(dev); &bslash;&n;&t;struct pc87360_data *data = i2c_get_clientdata(client); &bslash;&n;&t;long val = simple_strtol(buf, NULL, 10); &bslash;&n;&t;data-&gt;pwm[offset-1] = PWM_TO_REG(val, &bslash;&n;&t;&t;&t;      FAN_CONFIG_INVERT(data-&gt;fan_conf, offset-1)); &bslash;&n;&t;pc87360_write_value(data, LD_FAN, NO_BANK, PC87360_REG_PWM(offset-1), &bslash;&n;&t;&t;&t;    data-&gt;pwm[offset-1]); &bslash;&n;&t;return count; &bslash;&n;} &bslash;&n;static DEVICE_ATTR(pwm##offset, S_IWUSR | S_IRUGO, &bslash;&n;&t;show_pwm##offset, set_pwm##offset);
id|show_and_set_pwm
c_func
(paren
l_int|1
)paren
id|show_and_set_pwm
c_func
(paren
l_int|2
)paren
id|show_and_set_pwm
c_func
(paren
l_int|3
)paren
DECL|macro|show_and_set_in
mdefine_line|#define show_and_set_in(offset) &bslash;&n;static ssize_t show_in##offset##_input(struct device *dev, char *buf) &bslash;&n;{ &bslash;&n;&t;struct pc87360_data *data = pc87360_update_device(dev); &bslash;&n;&t;return sprintf(buf, &quot;%u&bslash;n&quot;, IN_FROM_REG(data-&gt;in[offset], &bslash;&n;&t;&t;       data-&gt;in_vref)); &bslash;&n;} &bslash;&n;static ssize_t show_in##offset##_min(struct device *dev, char *buf) &bslash;&n;{ &bslash;&n;&t;struct pc87360_data *data = pc87360_update_device(dev); &bslash;&n;&t;return sprintf(buf, &quot;%u&bslash;n&quot;, IN_FROM_REG(data-&gt;in_min[offset], &bslash;&n;&t;&t;       data-&gt;in_vref)); &bslash;&n;} &bslash;&n;static ssize_t show_in##offset##_max(struct device *dev, char *buf) &bslash;&n;{ &bslash;&n;&t;struct pc87360_data *data = pc87360_update_device(dev); &bslash;&n;&t;return sprintf(buf, &quot;%u&bslash;n&quot;, IN_FROM_REG(data-&gt;in_max[offset], &bslash;&n;&t;&t;       data-&gt;in_vref)); &bslash;&n;} &bslash;&n;static ssize_t show_in##offset##_status(struct device *dev, char *buf) &bslash;&n;{ &bslash;&n;&t;struct pc87360_data *data = pc87360_update_device(dev); &bslash;&n;&t;return sprintf(buf, &quot;%u&bslash;n&quot;, data-&gt;in_status[offset]); &bslash;&n;} &bslash;&n;static ssize_t set_in##offset##_min(struct device *dev, const char *buf, &bslash;&n;&t;size_t count) &bslash;&n;{ &bslash;&n;&t;struct i2c_client *client = to_i2c_client(dev); &bslash;&n;&t;struct pc87360_data *data = i2c_get_clientdata(client); &bslash;&n;&t;long val = simple_strtol(buf, NULL, 10); &bslash;&n;&t;data-&gt;in_min[offset] = IN_TO_REG(val, data-&gt;in_vref); &bslash;&n;&t;pc87360_write_value(data, LD_IN, offset, PC87365_REG_IN_MIN, &bslash;&n;&t;&t;&t;    data-&gt;in_min[offset]); &bslash;&n;&t;return count; &bslash;&n;} &bslash;&n;static ssize_t set_in##offset##_max(struct device *dev, const char *buf, &bslash;&n;&t;size_t count) &bslash;&n;{ &bslash;&n;&t;struct i2c_client *client = to_i2c_client(dev); &bslash;&n;&t;struct pc87360_data *data = i2c_get_clientdata(client); &bslash;&n;&t;long val = simple_strtol(buf, NULL, 10); &bslash;&n;&t;data-&gt;in_max[offset] = IN_TO_REG(val, &bslash;&n;&t;&t;&t;       data-&gt;in_vref); &bslash;&n;&t;pc87360_write_value(data, LD_IN, offset, PC87365_REG_IN_MAX, &bslash;&n;&t;&t;&t;    data-&gt;in_max[offset]); &bslash;&n;&t;return count; &bslash;&n;} &bslash;&n;static DEVICE_ATTR(in##offset##_input, S_IRUGO, &bslash;&n;&t;show_in##offset##_input, NULL); &bslash;&n;static DEVICE_ATTR(in##offset##_min, S_IWUSR | S_IRUGO, &bslash;&n;&t;show_in##offset##_min, set_in##offset##_min); &bslash;&n;static DEVICE_ATTR(in##offset##_max, S_IWUSR | S_IRUGO, &bslash;&n;&t;show_in##offset##_max, set_in##offset##_max); &bslash;&n;static DEVICE_ATTR(in##offset##_status, S_IRUGO, &bslash;&n;&t;show_in##offset##_status, NULL);
id|show_and_set_in
c_func
(paren
l_int|0
)paren
id|show_and_set_in
c_func
(paren
l_int|1
)paren
id|show_and_set_in
c_func
(paren
l_int|2
)paren
id|show_and_set_in
c_func
(paren
l_int|3
)paren
id|show_and_set_in
c_func
(paren
l_int|4
)paren
id|show_and_set_in
c_func
(paren
l_int|5
)paren
id|show_and_set_in
c_func
(paren
l_int|6
)paren
id|show_and_set_in
c_func
(paren
l_int|7
)paren
id|show_and_set_in
c_func
(paren
l_int|8
)paren
id|show_and_set_in
c_func
(paren
l_int|9
)paren
id|show_and_set_in
c_func
(paren
l_int|10
)paren
DECL|macro|show_and_set_therm
mdefine_line|#define show_and_set_therm(offset) &bslash;&n;static ssize_t show_temp##offset##_input(struct device *dev, char *buf) &bslash;&n;{ &bslash;&n;&t;struct pc87360_data *data = pc87360_update_device(dev); &bslash;&n;&t;return sprintf(buf, &quot;%u&bslash;n&quot;, IN_FROM_REG(data-&gt;in[offset+7], &bslash;&n;&t;&t;       data-&gt;in_vref)); &bslash;&n;} &bslash;&n;static ssize_t show_temp##offset##_min(struct device *dev, char *buf) &bslash;&n;{ &bslash;&n;&t;struct pc87360_data *data = pc87360_update_device(dev); &bslash;&n;&t;return sprintf(buf, &quot;%u&bslash;n&quot;, IN_FROM_REG(data-&gt;in_min[offset+7], &bslash;&n;&t;&t;       data-&gt;in_vref)); &bslash;&n;} &bslash;&n;static ssize_t show_temp##offset##_max(struct device *dev, char *buf) &bslash;&n;{ &bslash;&n;&t;struct pc87360_data *data = pc87360_update_device(dev); &bslash;&n;&t;return sprintf(buf, &quot;%u&bslash;n&quot;, IN_FROM_REG(data-&gt;in_max[offset+7], &bslash;&n;&t;&t;       data-&gt;in_vref)); &bslash;&n;} &bslash;&n;static ssize_t show_temp##offset##_crit(struct device *dev, char *buf) &bslash;&n;{ &bslash;&n;&t;struct pc87360_data *data = pc87360_update_device(dev); &bslash;&n;&t;return sprintf(buf, &quot;%u&bslash;n&quot;, IN_FROM_REG(data-&gt;in_crit[offset-4], &bslash;&n;&t;&t;       data-&gt;in_vref)); &bslash;&n;} &bslash;&n;static ssize_t show_temp##offset##_status(struct device *dev, char *buf) &bslash;&n;{ &bslash;&n;&t;struct pc87360_data *data = pc87360_update_device(dev); &bslash;&n;&t;return sprintf(buf, &quot;%u&bslash;n&quot;, data-&gt;in_status[offset+7]); &bslash;&n;} &bslash;&n;static ssize_t set_temp##offset##_min(struct device *dev, const char *buf, &bslash;&n;&t;size_t count) &bslash;&n;{ &bslash;&n;&t;struct i2c_client *client = to_i2c_client(dev); &bslash;&n;&t;struct pc87360_data *data = i2c_get_clientdata(client); &bslash;&n;&t;long val = simple_strtol(buf, NULL, 10); &bslash;&n;&t;data-&gt;in_min[offset+7] = IN_TO_REG(val, data-&gt;in_vref); &bslash;&n;&t;pc87360_write_value(data, LD_IN, offset+7, PC87365_REG_TEMP_MIN, &bslash;&n;&t;&t;&t;    data-&gt;in_min[offset+7]); &bslash;&n;&t;return count; &bslash;&n;} &bslash;&n;static ssize_t set_temp##offset##_max(struct device *dev, const char *buf, &bslash;&n;&t;size_t count) &bslash;&n;{ &bslash;&n;&t;struct i2c_client *client = to_i2c_client(dev); &bslash;&n;&t;struct pc87360_data *data = i2c_get_clientdata(client); &bslash;&n;&t;long val = simple_strtol(buf, NULL, 10); &bslash;&n;&t;data-&gt;in_max[offset+7] = IN_TO_REG(val, data-&gt;in_vref); &bslash;&n;&t;pc87360_write_value(data, LD_IN, offset+7, PC87365_REG_TEMP_MAX, &bslash;&n;&t;&t;&t;    data-&gt;in_max[offset+7]); &bslash;&n;&t;return count; &bslash;&n;} &bslash;&n;static ssize_t set_temp##offset##_crit(struct device *dev, const char *buf, &bslash;&n;&t;size_t count) &bslash;&n;{ &bslash;&n;&t;struct i2c_client *client = to_i2c_client(dev); &bslash;&n;&t;struct pc87360_data *data = i2c_get_clientdata(client); &bslash;&n;&t;long val = simple_strtol(buf, NULL, 10); &bslash;&n;&t;data-&gt;in_crit[offset-4] = IN_TO_REG(val, data-&gt;in_vref); &bslash;&n;&t;pc87360_write_value(data, LD_IN, offset+7, PC87365_REG_TEMP_CRIT, &bslash;&n;&t;&t;&t;    data-&gt;in_crit[offset-4]); &bslash;&n;&t;return count; &bslash;&n;} &bslash;&n;static DEVICE_ATTR(temp##offset##_input, S_IRUGO, &bslash;&n;&t;show_temp##offset##_input, NULL); &bslash;&n;static DEVICE_ATTR(temp##offset##_min, S_IWUSR | S_IRUGO, &bslash;&n;&t;show_temp##offset##_min, set_temp##offset##_min); &bslash;&n;static DEVICE_ATTR(temp##offset##_max, S_IWUSR | S_IRUGO, &bslash;&n;&t;show_temp##offset##_max, set_temp##offset##_max); &bslash;&n;static DEVICE_ATTR(temp##offset##_crit, S_IWUSR | S_IRUGO, &bslash;&n;&t;show_temp##offset##_crit, set_temp##offset##_crit); &bslash;&n;static DEVICE_ATTR(temp##offset##_status, S_IRUGO, &bslash;&n;&t;show_temp##offset##_status, NULL);
id|show_and_set_therm
c_func
(paren
l_int|4
)paren
id|show_and_set_therm
c_func
(paren
l_int|5
)paren
id|show_and_set_therm
c_func
(paren
l_int|6
)paren
DECL|function|show_vid
r_static
id|ssize_t
id|show_vid
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
)paren
(brace
r_struct
id|pc87360_data
op_star
id|data
op_assign
id|pc87360_update_device
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%u&bslash;n&quot;
comma
id|vid_from_reg
c_func
(paren
id|data-&gt;vid
comma
id|data-&gt;vrm
)paren
)paren
suffix:semicolon
)brace
r_static
id|DEVICE_ATTR
c_func
(paren
id|cpu0_vid
comma
id|S_IRUGO
comma
id|show_vid
comma
l_int|NULL
)paren
suffix:semicolon
DECL|function|show_vrm
r_static
id|ssize_t
id|show_vrm
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
)paren
(brace
r_struct
id|pc87360_data
op_star
id|data
op_assign
id|pc87360_update_device
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%u&bslash;n&quot;
comma
id|data-&gt;vrm
)paren
suffix:semicolon
)brace
DECL|function|set_vrm
r_static
id|ssize_t
id|set_vrm
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_struct
id|i2c_client
op_star
id|client
op_assign
id|to_i2c_client
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|pc87360_data
op_star
id|data
op_assign
id|i2c_get_clientdata
c_func
(paren
id|client
)paren
suffix:semicolon
id|data-&gt;vrm
op_assign
id|simple_strtoul
c_func
(paren
id|buf
comma
l_int|NULL
comma
l_int|10
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
r_static
id|DEVICE_ATTR
c_func
(paren
id|vrm
comma
id|S_IRUGO
op_or
id|S_IWUSR
comma
id|show_vrm
comma
id|set_vrm
)paren
suffix:semicolon
DECL|function|show_in_alarms
r_static
id|ssize_t
id|show_in_alarms
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
)paren
(brace
r_struct
id|pc87360_data
op_star
id|data
op_assign
id|pc87360_update_device
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%u&bslash;n&quot;
comma
id|data-&gt;in_alarms
)paren
suffix:semicolon
)brace
r_static
id|DEVICE_ATTR
c_func
(paren
id|alarms_in
comma
id|S_IRUGO
comma
id|show_in_alarms
comma
l_int|NULL
)paren
suffix:semicolon
DECL|macro|show_and_set_temp
mdefine_line|#define show_and_set_temp(offset) &bslash;&n;static ssize_t show_temp##offset##_input(struct device *dev, char *buf) &bslash;&n;{ &bslash;&n;&t;struct pc87360_data *data = pc87360_update_device(dev); &bslash;&n;&t;return sprintf(buf, &quot;%d&bslash;n&quot;, TEMP_FROM_REG(data-&gt;temp[offset-1])); &bslash;&n;} &bslash;&n;static ssize_t show_temp##offset##_min(struct device *dev, char *buf) &bslash;&n;{ &bslash;&n;&t;struct pc87360_data *data = pc87360_update_device(dev); &bslash;&n;&t;return sprintf(buf, &quot;%d&bslash;n&quot;, TEMP_FROM_REG(data-&gt;temp_min[offset-1])); &bslash;&n;} &bslash;&n;static ssize_t show_temp##offset##_max(struct device *dev, char *buf) &bslash;&n;{ &bslash;&n;&t;struct pc87360_data *data = pc87360_update_device(dev); &bslash;&n;&t;return sprintf(buf, &quot;%d&bslash;n&quot;, TEMP_FROM_REG(data-&gt;temp_max[offset-1])); &bslash;&n;}&bslash;&n;static ssize_t show_temp##offset##_crit(struct device *dev, char *buf) &bslash;&n;{ &bslash;&n;&t;struct pc87360_data *data = pc87360_update_device(dev); &bslash;&n;&t;return sprintf(buf, &quot;%d&bslash;n&quot;, TEMP_FROM_REG(data-&gt;temp_crit[offset-1])); &bslash;&n;}&bslash;&n;static ssize_t show_temp##offset##_status(struct device *dev, char *buf) &bslash;&n;{ &bslash;&n;&t;struct pc87360_data *data = pc87360_update_device(dev); &bslash;&n;&t;return sprintf(buf, &quot;%d&bslash;n&quot;, data-&gt;temp_status[offset-1]); &bslash;&n;}&bslash;&n;static ssize_t set_temp##offset##_min(struct device *dev, const char *buf, &bslash;&n;&t;size_t count) &bslash;&n;{ &bslash;&n;&t;struct i2c_client *client = to_i2c_client(dev); &bslash;&n;&t;struct pc87360_data *data = i2c_get_clientdata(client); &bslash;&n;&t;long val = simple_strtol(buf, NULL, 10); &bslash;&n;&t;data-&gt;temp_min[offset-1] = TEMP_TO_REG(val); &bslash;&n;&t;pc87360_write_value(data, LD_TEMP, offset-1, PC87365_REG_TEMP_MIN, &bslash;&n;&t;&t;&t;    data-&gt;temp_min[offset-1]); &bslash;&n;&t;return count; &bslash;&n;} &bslash;&n;static ssize_t set_temp##offset##_max(struct device *dev, const char *buf, &bslash;&n;&t;size_t count) &bslash;&n;{ &bslash;&n;&t;struct i2c_client *client = to_i2c_client(dev); &bslash;&n;&t;struct pc87360_data *data = i2c_get_clientdata(client); &bslash;&n;&t;long val = simple_strtol(buf, NULL, 10); &bslash;&n;&t;data-&gt;temp_max[offset-1] = TEMP_TO_REG(val); &bslash;&n;&t;pc87360_write_value(data, LD_TEMP, offset-1, PC87365_REG_TEMP_MAX, &bslash;&n;&t;&t;&t;    data-&gt;temp_max[offset-1]); &bslash;&n;&t;return count; &bslash;&n;} &bslash;&n;static ssize_t set_temp##offset##_crit(struct device *dev, const char *buf, &bslash;&n;&t;size_t count) &bslash;&n;{ &bslash;&n;&t;struct i2c_client *client = to_i2c_client(dev); &bslash;&n;&t;struct pc87360_data *data = i2c_get_clientdata(client); &bslash;&n;&t;long val = simple_strtol(buf, NULL, 10); &bslash;&n;&t;data-&gt;temp_crit[offset-1] = TEMP_TO_REG(val); &bslash;&n;&t;pc87360_write_value(data, LD_TEMP, offset-1, PC87365_REG_TEMP_CRIT, &bslash;&n;&t;&t;&t;    data-&gt;temp_crit[offset-1]); &bslash;&n;&t;return count; &bslash;&n;} &bslash;&n;static DEVICE_ATTR(temp##offset##_input, S_IRUGO, &bslash;&n;&t;show_temp##offset##_input, NULL); &bslash;&n;static DEVICE_ATTR(temp##offset##_min, S_IWUSR | S_IRUGO, &bslash;&n;&t;show_temp##offset##_min, set_temp##offset##_min); &bslash;&n;static DEVICE_ATTR(temp##offset##_max, S_IWUSR | S_IRUGO, &bslash;&n;&t;show_temp##offset##_max, set_temp##offset##_max); &bslash;&n;static DEVICE_ATTR(temp##offset##_crit, S_IWUSR | S_IRUGO, &bslash;&n;&t;show_temp##offset##_crit, set_temp##offset##_crit); &bslash;&n;static DEVICE_ATTR(temp##offset##_status, S_IRUGO, &bslash;&n;&t;show_temp##offset##_status, NULL);
id|show_and_set_temp
c_func
(paren
l_int|1
)paren
id|show_and_set_temp
c_func
(paren
l_int|2
)paren
id|show_and_set_temp
c_func
(paren
l_int|3
)paren
DECL|function|show_temp_alarms
r_static
id|ssize_t
id|show_temp_alarms
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
)paren
(brace
r_struct
id|pc87360_data
op_star
id|data
op_assign
id|pc87360_update_device
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%u&bslash;n&quot;
comma
id|data-&gt;temp_alarms
)paren
suffix:semicolon
)brace
r_static
id|DEVICE_ATTR
c_func
(paren
id|alarms_temp
comma
id|S_IRUGO
comma
id|show_temp_alarms
comma
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/*&n; * Device detection, registration and update&n; */
DECL|function|pc87360_attach_adapter
r_static
r_int
id|pc87360_attach_adapter
c_func
(paren
r_struct
id|i2c_adapter
op_star
id|adapter
)paren
(brace
r_return
id|i2c_detect
c_func
(paren
id|adapter
comma
op_amp
id|addr_data
comma
id|pc87360_detect
)paren
suffix:semicolon
)brace
DECL|function|pc87360_find
r_static
r_int
id|pc87360_find
c_func
(paren
r_int
id|sioaddr
comma
id|u8
op_star
id|devid
comma
r_int
op_star
id|address
)paren
(brace
id|u16
id|val
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|nrdev
suffix:semicolon
multiline_comment|/* logical device count */
multiline_comment|/* No superio_enter */
multiline_comment|/* Identify device */
id|val
op_assign
id|superio_inb
c_func
(paren
id|sioaddr
comma
id|DEVID
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|val
)paren
(brace
r_case
l_int|0xE1
suffix:colon
multiline_comment|/* PC87360 */
r_case
l_int|0xE8
suffix:colon
multiline_comment|/* PC87363 */
r_case
l_int|0xE4
suffix:colon
multiline_comment|/* PC87364 */
id|nrdev
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0xE5
suffix:colon
multiline_comment|/* PC87365 */
r_case
l_int|0xE9
suffix:colon
multiline_comment|/* PC87366 */
id|nrdev
op_assign
l_int|3
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|superio_exit
c_func
(paren
id|sioaddr
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* Remember the device id */
op_star
id|devid
op_assign
id|val
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|nrdev
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* select logical device */
id|superio_outb
c_func
(paren
id|sioaddr
comma
id|DEV
comma
id|logdev
(braket
id|i
)braket
)paren
suffix:semicolon
id|val
op_assign
id|superio_inb
c_func
(paren
id|sioaddr
comma
id|ACT
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|val
op_amp
l_int|0x01
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;pc87360: Device 0x%02x not &quot;
l_string|&quot;activated&bslash;n&quot;
comma
id|logdev
(braket
id|i
)braket
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|val
op_assign
(paren
id|superio_inb
c_func
(paren
id|sioaddr
comma
id|BASE
)paren
op_lshift
l_int|8
)paren
op_or
id|superio_inb
c_func
(paren
id|sioaddr
comma
id|BASE
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|val
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;pc87360: Base address not set for &quot;
l_string|&quot;device 0x%02x&bslash;n&quot;
comma
id|logdev
(braket
id|i
)braket
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|address
(braket
id|i
)braket
op_assign
id|val
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
l_int|0
)paren
(brace
multiline_comment|/* Fans */
id|confreg
(braket
l_int|0
)braket
op_assign
id|superio_inb
c_func
(paren
id|sioaddr
comma
l_int|0xF0
)paren
suffix:semicolon
id|confreg
(braket
l_int|1
)braket
op_assign
id|superio_inb
c_func
(paren
id|sioaddr
comma
l_int|0xF1
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;pc87360: Fan 1: mon=%d &quot;
l_string|&quot;ctrl=%d inv=%d&bslash;n&quot;
comma
(paren
id|confreg
(braket
l_int|0
)braket
op_rshift
l_int|2
)paren
op_amp
l_int|1
comma
(paren
id|confreg
(braket
l_int|0
)braket
op_rshift
l_int|3
)paren
op_amp
l_int|1
comma
(paren
id|confreg
(braket
l_int|0
)braket
op_rshift
l_int|4
)paren
op_amp
l_int|1
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;pc87360: Fan 2: mon=%d &quot;
l_string|&quot;ctrl=%d inv=%d&bslash;n&quot;
comma
(paren
id|confreg
(braket
l_int|0
)braket
op_rshift
l_int|5
)paren
op_amp
l_int|1
comma
(paren
id|confreg
(braket
l_int|0
)braket
op_rshift
l_int|6
)paren
op_amp
l_int|1
comma
(paren
id|confreg
(braket
l_int|0
)braket
op_rshift
l_int|7
)paren
op_amp
l_int|1
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;pc87360: Fan 3: mon=%d &quot;
l_string|&quot;ctrl=%d inv=%d&bslash;n&quot;
comma
id|confreg
(braket
l_int|1
)braket
op_amp
l_int|1
comma
(paren
id|confreg
(braket
l_int|1
)braket
op_rshift
l_int|1
)paren
op_amp
l_int|1
comma
(paren
id|confreg
(braket
l_int|1
)braket
op_rshift
l_int|2
)paren
op_amp
l_int|1
)paren
suffix:semicolon
macro_line|#endif
)brace
r_else
r_if
c_cond
(paren
id|i
op_eq
l_int|1
)paren
(brace
multiline_comment|/* Voltages */
multiline_comment|/* Are we using thermistors? */
r_if
c_cond
(paren
op_star
id|devid
op_eq
l_int|0xE9
)paren
(brace
multiline_comment|/* PC87366 */
multiline_comment|/* These registers are not logical-device&n;&t;&t;&t;&t;   specific, just that we won&squot;t need them if&n;&t;&t;&t;&t;   we don&squot;t use the VLM device */
id|confreg
(braket
l_int|2
)braket
op_assign
id|superio_inb
c_func
(paren
id|sioaddr
comma
l_int|0x2B
)paren
suffix:semicolon
id|confreg
(braket
l_int|3
)braket
op_assign
id|superio_inb
c_func
(paren
id|sioaddr
comma
l_int|0x25
)paren
suffix:semicolon
r_if
c_cond
(paren
id|confreg
(braket
l_int|2
)braket
op_amp
l_int|0x40
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;pc87360: Using &quot;
l_string|&quot;thermistors for temperature &quot;
l_string|&quot;monitoring&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|confreg
(braket
l_int|3
)braket
op_amp
l_int|0xE0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;pc87360: VID &quot;
l_string|&quot;inputs routed (mode %u)&bslash;n&quot;
comma
id|confreg
(braket
l_int|3
)braket
op_rshift
l_int|5
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
id|superio_exit
c_func
(paren
id|sioaddr
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* We don&squot;t really care about the address.&n;   Read from extra_isa instead. */
DECL|function|pc87360_detect
r_int
id|pc87360_detect
c_func
(paren
r_struct
id|i2c_adapter
op_star
id|adapter
comma
r_int
id|address
comma
r_int
id|kind
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|i2c_client
op_star
id|new_client
suffix:semicolon
r_struct
id|pc87360_data
op_star
id|data
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
r_const
r_char
op_star
id|name
op_assign
l_string|&quot;pc87360&quot;
suffix:semicolon
r_int
id|use_thermistors
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|i2c_is_isa_adapter
c_func
(paren
id|adapter
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|data
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|pc87360_data
)paren
comma
id|GFP_KERNEL
)paren
)paren
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|data
comma
l_int|0x00
comma
r_sizeof
(paren
r_struct
id|pc87360_data
)paren
)paren
suffix:semicolon
id|new_client
op_assign
op_amp
id|data-&gt;client
suffix:semicolon
id|i2c_set_clientdata
c_func
(paren
id|new_client
comma
id|data
)paren
suffix:semicolon
id|new_client-&gt;addr
op_assign
id|address
suffix:semicolon
id|init_MUTEX
c_func
(paren
op_amp
id|data-&gt;lock
)paren
suffix:semicolon
id|new_client-&gt;adapter
op_assign
id|adapter
suffix:semicolon
id|new_client-&gt;driver
op_assign
op_amp
id|pc87360_driver
suffix:semicolon
id|new_client-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|data-&gt;fannr
op_assign
l_int|2
suffix:semicolon
id|data-&gt;innr
op_assign
l_int|0
suffix:semicolon
id|data-&gt;tempnr
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|devid
)paren
(brace
r_case
l_int|0xe8
suffix:colon
id|name
op_assign
l_string|&quot;pc87363&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0xe4
suffix:colon
id|name
op_assign
l_string|&quot;pc87364&quot;
suffix:semicolon
id|data-&gt;fannr
op_assign
l_int|3
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0xe5
suffix:colon
id|name
op_assign
l_string|&quot;pc87365&quot;
suffix:semicolon
id|data-&gt;fannr
op_assign
id|extra_isa
(braket
l_int|0
)braket
ques
c_cond
l_int|3
suffix:colon
l_int|0
suffix:semicolon
id|data-&gt;innr
op_assign
id|extra_isa
(braket
l_int|1
)braket
ques
c_cond
l_int|11
suffix:colon
l_int|0
suffix:semicolon
id|data-&gt;tempnr
op_assign
id|extra_isa
(braket
l_int|2
)braket
ques
c_cond
l_int|2
suffix:colon
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0xe9
suffix:colon
id|name
op_assign
l_string|&quot;pc87366&quot;
suffix:semicolon
id|data-&gt;fannr
op_assign
id|extra_isa
(braket
l_int|0
)braket
ques
c_cond
l_int|3
suffix:colon
l_int|0
suffix:semicolon
id|data-&gt;innr
op_assign
id|extra_isa
(braket
l_int|1
)braket
ques
c_cond
l_int|14
suffix:colon
l_int|0
suffix:semicolon
id|data-&gt;tempnr
op_assign
id|extra_isa
(braket
l_int|2
)braket
ques
c_cond
l_int|3
suffix:colon
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
id|strcpy
c_func
(paren
id|new_client-&gt;name
comma
id|name
)paren
suffix:semicolon
id|data-&gt;valid
op_assign
l_int|0
suffix:semicolon
id|init_MUTEX
c_func
(paren
op_amp
id|data-&gt;update_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|3
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
(paren
id|data-&gt;address
(braket
id|i
)braket
op_assign
id|extra_isa
(braket
id|i
)braket
)paren
)paren
op_logical_and
op_logical_neg
id|request_region
c_func
(paren
id|extra_isa
(braket
id|i
)braket
comma
id|PC87360_EXTENT
comma
id|pc87360_driver.name
)paren
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
l_string|&quot;Region 0x%x-0x%x already &quot;
l_string|&quot;in use!&bslash;n&quot;
comma
id|extra_isa
(braket
id|i
)braket
comma
id|extra_isa
(braket
id|i
)braket
op_plus
id|PC87360_EXTENT
op_minus
l_int|1
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_decrement
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
id|release_region
c_func
(paren
id|extra_isa
(braket
id|i
)braket
comma
id|PC87360_EXTENT
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_goto
id|ERROR1
suffix:semicolon
)brace
)brace
multiline_comment|/* Retrieve the fans configuration from Super-I/O space */
r_if
c_cond
(paren
id|data-&gt;fannr
)paren
id|data-&gt;fan_conf
op_assign
id|confreg
(braket
l_int|0
)braket
op_or
(paren
id|confreg
(braket
l_int|1
)braket
op_lshift
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|i2c_attach_client
c_func
(paren
id|new_client
)paren
)paren
)paren
r_goto
id|ERROR2
suffix:semicolon
multiline_comment|/* Use the correct reference voltage&n;&t;   Unless both the VLM and the TMS logical devices agree to&n;&t;   use an external Vref, the internal one is used. */
r_if
c_cond
(paren
id|data-&gt;innr
)paren
(brace
id|i
op_assign
id|pc87360_read_value
c_func
(paren
id|data
comma
id|LD_IN
comma
id|NO_BANK
comma
id|PC87365_REG_IN_CONFIG
)paren
suffix:semicolon
r_if
c_cond
(paren
id|data-&gt;tempnr
)paren
(brace
id|i
op_and_assign
id|pc87360_read_value
c_func
(paren
id|data
comma
id|LD_TEMP
comma
id|NO_BANK
comma
id|PC87365_REG_TEMP_CONFIG
)paren
suffix:semicolon
)brace
id|data-&gt;in_vref
op_assign
(paren
id|i
op_amp
l_int|0x02
)paren
ques
c_cond
l_int|3025
suffix:colon
l_int|2966
suffix:semicolon
id|dev_dbg
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
l_string|&quot;Using %s reference voltage&bslash;n&quot;
comma
(paren
id|i
op_amp
l_int|0x02
)paren
ques
c_cond
l_string|&quot;external&quot;
suffix:colon
l_string|&quot;internal&quot;
)paren
suffix:semicolon
id|data-&gt;vid_conf
op_assign
id|confreg
(braket
l_int|3
)braket
suffix:semicolon
id|data-&gt;vrm
op_assign
l_int|90
suffix:semicolon
)brace
multiline_comment|/* Fan clock dividers may be needed before any data is read */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|data-&gt;fannr
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|FAN_CONFIG_MONITOR
c_func
(paren
id|data-&gt;fan_conf
comma
id|i
)paren
)paren
id|data-&gt;fan_status
(braket
id|i
)braket
op_assign
id|pc87360_read_value
c_func
(paren
id|data
comma
id|LD_FAN
comma
id|NO_BANK
comma
id|PC87360_REG_FAN_STATUS
c_func
(paren
id|i
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|init
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|devid
op_eq
l_int|0xe9
op_logical_and
id|data-&gt;address
(braket
l_int|1
)braket
)paren
multiline_comment|/* PC87366 */
id|use_thermistors
op_assign
id|confreg
(braket
l_int|2
)braket
op_amp
l_int|0x40
suffix:semicolon
id|pc87360_init_client
c_func
(paren
id|new_client
comma
id|use_thermistors
)paren
suffix:semicolon
)brace
multiline_comment|/* Register sysfs hooks */
r_if
c_cond
(paren
id|data-&gt;innr
)paren
(brace
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_in0_input
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_in1_input
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_in2_input
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_in3_input
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_in4_input
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_in5_input
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_in6_input
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_in7_input
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_in8_input
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_in9_input
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_in10_input
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_in0_min
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_in1_min
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_in2_min
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_in3_min
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_in4_min
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_in5_min
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_in6_min
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_in7_min
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_in8_min
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_in9_min
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_in10_min
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_in0_max
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_in1_max
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_in2_max
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_in3_max
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_in4_max
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_in5_max
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_in6_max
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_in7_max
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_in8_max
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_in9_max
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_in10_max
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_in0_status
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_in1_status
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_in2_status
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_in3_status
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_in4_status
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_in5_status
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_in6_status
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_in7_status
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_in8_status
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_in9_status
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_in10_status
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_cpu0_vid
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_vrm
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_alarms_in
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|data-&gt;tempnr
)paren
(brace
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_temp1_input
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_temp2_input
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_temp1_min
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_temp2_min
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_temp1_max
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_temp2_max
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_temp1_crit
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_temp2_crit
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_temp1_status
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_temp2_status
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_alarms_temp
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|data-&gt;tempnr
op_eq
l_int|3
)paren
(brace
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_temp3_input
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_temp3_min
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_temp3_max
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_temp3_crit
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_temp3_status
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|data-&gt;innr
op_eq
l_int|14
)paren
(brace
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_temp4_input
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_temp5_input
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_temp6_input
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_temp4_min
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_temp5_min
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_temp6_min
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_temp4_max
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_temp5_max
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_temp6_max
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_temp4_crit
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_temp5_crit
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_temp6_crit
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_temp4_status
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_temp5_status
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_temp6_status
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|data-&gt;fannr
)paren
(brace
r_if
c_cond
(paren
id|FAN_CONFIG_MONITOR
c_func
(paren
id|data-&gt;fan_conf
comma
l_int|0
)paren
)paren
(brace
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_fan1_input
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_fan1_min
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_fan1_div
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_fan1_status
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|FAN_CONFIG_MONITOR
c_func
(paren
id|data-&gt;fan_conf
comma
l_int|1
)paren
)paren
(brace
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_fan2_input
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_fan2_min
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_fan2_div
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_fan2_status
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|FAN_CONFIG_CONTROL
c_func
(paren
id|data-&gt;fan_conf
comma
l_int|0
)paren
)paren
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_pwm1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|FAN_CONFIG_CONTROL
c_func
(paren
id|data-&gt;fan_conf
comma
l_int|1
)paren
)paren
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_pwm2
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|data-&gt;fannr
op_eq
l_int|3
)paren
(brace
r_if
c_cond
(paren
id|FAN_CONFIG_MONITOR
c_func
(paren
id|data-&gt;fan_conf
comma
l_int|2
)paren
)paren
(brace
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_fan3_input
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_fan3_min
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_fan3_div
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_fan3_status
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|FAN_CONFIG_CONTROL
c_func
(paren
id|data-&gt;fan_conf
comma
l_int|2
)paren
)paren
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_pwm3
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
id|ERROR2
suffix:colon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|3
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|data-&gt;address
(braket
id|i
)braket
)paren
(brace
id|release_region
c_func
(paren
id|data-&gt;address
(braket
id|i
)braket
comma
id|PC87360_EXTENT
)paren
suffix:semicolon
)brace
)brace
id|ERROR1
suffix:colon
id|kfree
c_func
(paren
id|data
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|pc87360_detach_client
r_static
r_int
id|pc87360_detach_client
c_func
(paren
r_struct
id|i2c_client
op_star
id|client
)paren
(brace
r_struct
id|pc87360_data
op_star
id|data
op_assign
id|i2c_get_clientdata
c_func
(paren
id|client
)paren
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
op_assign
id|i2c_detach_client
c_func
(paren
id|client
)paren
)paren
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|client-&gt;dev
comma
l_string|&quot;Client deregistration failed, &quot;
l_string|&quot;client not detached.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|i
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|3
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|data-&gt;address
(braket
id|i
)braket
)paren
(brace
id|release_region
c_func
(paren
id|data-&gt;address
(braket
id|i
)braket
comma
id|PC87360_EXTENT
)paren
suffix:semicolon
)brace
)brace
id|kfree
c_func
(paren
id|data
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* ldi is the logical device index&n;   bank is for voltages and temperatures only */
DECL|function|pc87360_read_value
r_static
r_int
id|pc87360_read_value
c_func
(paren
r_struct
id|pc87360_data
op_star
id|data
comma
id|u8
id|ldi
comma
id|u8
id|bank
comma
id|u8
id|reg
)paren
(brace
r_int
id|res
suffix:semicolon
id|down
c_func
(paren
op_amp
(paren
id|data-&gt;lock
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bank
op_ne
id|NO_BANK
)paren
id|outb_p
c_func
(paren
id|bank
comma
id|data-&gt;address
(braket
id|ldi
)braket
op_plus
id|PC87365_REG_BANK
)paren
suffix:semicolon
id|res
op_assign
id|inb_p
c_func
(paren
id|data-&gt;address
(braket
id|ldi
)braket
op_plus
id|reg
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
(paren
id|data-&gt;lock
)paren
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
DECL|function|pc87360_write_value
r_static
r_void
id|pc87360_write_value
c_func
(paren
r_struct
id|pc87360_data
op_star
id|data
comma
id|u8
id|ldi
comma
id|u8
id|bank
comma
id|u8
id|reg
comma
id|u8
id|value
)paren
(brace
id|down
c_func
(paren
op_amp
(paren
id|data-&gt;lock
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bank
op_ne
id|NO_BANK
)paren
id|outb_p
c_func
(paren
id|bank
comma
id|data-&gt;address
(braket
id|ldi
)braket
op_plus
id|PC87365_REG_BANK
)paren
suffix:semicolon
id|outb_p
c_func
(paren
id|value
comma
id|data-&gt;address
(braket
id|ldi
)braket
op_plus
id|reg
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
(paren
id|data-&gt;lock
)paren
)paren
suffix:semicolon
)brace
DECL|function|pc87360_init_client
r_static
r_void
id|pc87360_init_client
c_func
(paren
r_struct
id|i2c_client
op_star
id|client
comma
r_int
id|use_thermistors
)paren
(brace
r_struct
id|pc87360_data
op_star
id|data
op_assign
id|i2c_get_clientdata
c_func
(paren
id|client
)paren
suffix:semicolon
r_int
id|i
comma
id|nr
suffix:semicolon
r_const
id|u8
id|init_in
(braket
l_int|14
)braket
op_assign
(brace
l_int|2
comma
l_int|2
comma
l_int|2
comma
l_int|2
comma
l_int|2
comma
l_int|2
comma
l_int|2
comma
l_int|1
comma
l_int|1
comma
l_int|3
comma
l_int|1
comma
l_int|2
comma
l_int|2
comma
l_int|2
)brace
suffix:semicolon
r_const
id|u8
id|init_temp
(braket
l_int|3
)braket
op_assign
(brace
l_int|2
comma
l_int|2
comma
l_int|1
)brace
suffix:semicolon
id|u8
id|reg
suffix:semicolon
r_if
c_cond
(paren
id|init
op_ge
l_int|2
op_logical_and
id|data-&gt;innr
)paren
(brace
id|reg
op_assign
id|pc87360_read_value
c_func
(paren
id|data
comma
id|LD_IN
comma
id|NO_BANK
comma
id|PC87365_REG_IN_CONVRATE
)paren
suffix:semicolon
id|dev_info
c_func
(paren
op_amp
id|client-&gt;dev
comma
l_string|&quot;VLM conversion set to&quot;
l_string|&quot;1s period, 160us delay&bslash;n&quot;
)paren
suffix:semicolon
id|pc87360_write_value
c_func
(paren
id|data
comma
id|LD_IN
comma
id|NO_BANK
comma
id|PC87365_REG_IN_CONVRATE
comma
(paren
id|reg
op_amp
l_int|0xC0
)paren
op_or
l_int|0x11
)paren
suffix:semicolon
)brace
id|nr
op_assign
id|data-&gt;innr
OL
l_int|11
ques
c_cond
id|data-&gt;innr
suffix:colon
l_int|11
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|nr
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|init
op_ge
id|init_in
(braket
id|i
)braket
)paren
(brace
multiline_comment|/* Forcibly enable voltage channel */
id|reg
op_assign
id|pc87360_read_value
c_func
(paren
id|data
comma
id|LD_IN
comma
id|i
comma
id|PC87365_REG_IN_STATUS
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|reg
op_amp
l_int|0x01
)paren
)paren
(brace
id|dev_dbg
c_func
(paren
op_amp
id|client-&gt;dev
comma
l_string|&quot;Forcibly &quot;
l_string|&quot;enabling in%d&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
id|pc87360_write_value
c_func
(paren
id|data
comma
id|LD_IN
comma
id|i
comma
id|PC87365_REG_IN_STATUS
comma
(paren
id|reg
op_amp
l_int|0x68
)paren
op_or
l_int|0x87
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* We can&squot;t blindly trust the Super-I/O space configuration bit,&n;&t;   most BIOS won&squot;t set it properly */
r_for
c_loop
(paren
id|i
op_assign
l_int|11
suffix:semicolon
id|i
OL
id|data-&gt;innr
suffix:semicolon
id|i
op_increment
)paren
(brace
id|reg
op_assign
id|pc87360_read_value
c_func
(paren
id|data
comma
id|LD_IN
comma
id|i
comma
id|PC87365_REG_TEMP_STATUS
)paren
suffix:semicolon
id|use_thermistors
op_assign
id|use_thermistors
op_logical_or
(paren
id|reg
op_amp
l_int|0x01
)paren
suffix:semicolon
)brace
id|i
op_assign
id|use_thermistors
ques
c_cond
l_int|2
suffix:colon
l_int|0
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|i
OL
id|data-&gt;tempnr
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|init
op_ge
id|init_temp
(braket
id|i
)braket
)paren
(brace
multiline_comment|/* Forcibly enable temperature channel */
id|reg
op_assign
id|pc87360_read_value
c_func
(paren
id|data
comma
id|LD_TEMP
comma
id|i
comma
id|PC87365_REG_TEMP_STATUS
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|reg
op_amp
l_int|0x01
)paren
)paren
(brace
id|dev_dbg
c_func
(paren
op_amp
id|client-&gt;dev
comma
l_string|&quot;Forcibly &quot;
l_string|&quot;enabling temp%d&bslash;n&quot;
comma
id|i
op_plus
l_int|1
)paren
suffix:semicolon
id|pc87360_write_value
c_func
(paren
id|data
comma
id|LD_TEMP
comma
id|i
comma
id|PC87365_REG_TEMP_STATUS
comma
l_int|0xCF
)paren
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|use_thermistors
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|11
suffix:semicolon
id|i
OL
id|data-&gt;innr
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|init
op_ge
id|init_in
(braket
id|i
)braket
)paren
(brace
multiline_comment|/* The pin may already be used by thermal&n;&t;&t;&t;&t;   diodes */
id|reg
op_assign
id|pc87360_read_value
c_func
(paren
id|data
comma
id|LD_TEMP
comma
(paren
id|i
op_minus
l_int|11
)paren
op_div
l_int|2
comma
id|PC87365_REG_TEMP_STATUS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|reg
op_amp
l_int|0x01
)paren
(brace
id|dev_dbg
c_func
(paren
op_amp
id|client-&gt;dev
comma
l_string|&quot;Skipping &quot;
l_string|&quot;temp%d, pin already in use &quot;
l_string|&quot;by temp%d&bslash;n&quot;
comma
id|i
op_minus
l_int|7
comma
(paren
id|i
op_minus
l_int|11
)paren
op_div
l_int|2
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/* Forcibly enable thermistor channel */
id|reg
op_assign
id|pc87360_read_value
c_func
(paren
id|data
comma
id|LD_IN
comma
id|i
comma
id|PC87365_REG_IN_STATUS
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|reg
op_amp
l_int|0x01
)paren
)paren
(brace
id|dev_dbg
c_func
(paren
op_amp
id|client-&gt;dev
comma
l_string|&quot;Forcibly &quot;
l_string|&quot;enabling temp%d&bslash;n&quot;
comma
id|i
op_minus
l_int|7
)paren
suffix:semicolon
id|pc87360_write_value
c_func
(paren
id|data
comma
id|LD_IN
comma
id|i
comma
id|PC87365_REG_TEMP_STATUS
comma
(paren
id|reg
op_amp
l_int|0x60
)paren
op_or
l_int|0x8F
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
r_if
c_cond
(paren
id|data-&gt;innr
)paren
(brace
id|reg
op_assign
id|pc87360_read_value
c_func
(paren
id|data
comma
id|LD_IN
comma
id|NO_BANK
comma
id|PC87365_REG_IN_CONFIG
)paren
suffix:semicolon
r_if
c_cond
(paren
id|reg
op_amp
l_int|0x01
)paren
(brace
id|dev_dbg
c_func
(paren
op_amp
id|client-&gt;dev
comma
l_string|&quot;Forcibly &quot;
l_string|&quot;enabling monitoring (VLM)&bslash;n&quot;
)paren
suffix:semicolon
id|pc87360_write_value
c_func
(paren
id|data
comma
id|LD_IN
comma
id|NO_BANK
comma
id|PC87365_REG_IN_CONFIG
comma
id|reg
op_amp
l_int|0xFE
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|data-&gt;tempnr
)paren
(brace
id|reg
op_assign
id|pc87360_read_value
c_func
(paren
id|data
comma
id|LD_TEMP
comma
id|NO_BANK
comma
id|PC87365_REG_TEMP_CONFIG
)paren
suffix:semicolon
r_if
c_cond
(paren
id|reg
op_amp
l_int|0x01
)paren
(brace
id|dev_dbg
c_func
(paren
op_amp
id|client-&gt;dev
comma
l_string|&quot;Forcibly enabling &quot;
l_string|&quot;monitoring (TMS)&bslash;n&quot;
)paren
suffix:semicolon
id|pc87360_write_value
c_func
(paren
id|data
comma
id|LD_TEMP
comma
id|NO_BANK
comma
id|PC87365_REG_TEMP_CONFIG
comma
id|reg
op_amp
l_int|0xFE
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|init
op_ge
l_int|2
)paren
(brace
multiline_comment|/* Chip config as documented by National Semi. */
id|pc87360_write_value
c_func
(paren
id|data
comma
id|LD_TEMP
comma
l_int|0xF
comma
l_int|0xA
comma
l_int|0x08
)paren
suffix:semicolon
multiline_comment|/* We voluntarily omit the bank here, in case the&n;&t;&t;&t;   sequence itself matters. It shouldn&squot;t be a problem,&n;&t;&t;&t;   since nobody else is supposed to access the&n;&t;&t;&t;   device at that point. */
id|pc87360_write_value
c_func
(paren
id|data
comma
id|LD_TEMP
comma
id|NO_BANK
comma
l_int|0xB
comma
l_int|0x04
)paren
suffix:semicolon
id|pc87360_write_value
c_func
(paren
id|data
comma
id|LD_TEMP
comma
id|NO_BANK
comma
l_int|0xC
comma
l_int|0x35
)paren
suffix:semicolon
id|pc87360_write_value
c_func
(paren
id|data
comma
id|LD_TEMP
comma
id|NO_BANK
comma
l_int|0xD
comma
l_int|0x05
)paren
suffix:semicolon
id|pc87360_write_value
c_func
(paren
id|data
comma
id|LD_TEMP
comma
id|NO_BANK
comma
l_int|0xE
comma
l_int|0x05
)paren
suffix:semicolon
)brace
)brace
)brace
DECL|function|pc87360_autodiv
r_static
r_void
id|pc87360_autodiv
c_func
(paren
r_struct
id|i2c_client
op_star
id|client
comma
r_int
id|nr
)paren
(brace
r_struct
id|pc87360_data
op_star
id|data
op_assign
id|i2c_get_clientdata
c_func
(paren
id|client
)paren
suffix:semicolon
id|u8
id|old_min
op_assign
id|data-&gt;fan_min
(braket
id|nr
)braket
suffix:semicolon
multiline_comment|/* Increase clock divider if needed and possible */
r_if
c_cond
(paren
(paren
id|data-&gt;fan_status
(braket
id|nr
)braket
op_amp
l_int|0x04
)paren
multiline_comment|/* overflow flag */
op_logical_or
(paren
id|data-&gt;fan
(braket
id|nr
)braket
op_ge
l_int|224
)paren
)paren
(brace
multiline_comment|/* next to overflow */
r_if
c_cond
(paren
(paren
id|data-&gt;fan_status
(braket
id|nr
)braket
op_amp
l_int|0x60
)paren
op_ne
l_int|0x60
)paren
(brace
id|data-&gt;fan_status
(braket
id|nr
)braket
op_add_assign
l_int|0x20
suffix:semicolon
id|data-&gt;fan_min
(braket
id|nr
)braket
op_rshift_assign
l_int|1
suffix:semicolon
id|data-&gt;fan
(braket
id|nr
)braket
op_rshift_assign
l_int|1
suffix:semicolon
id|dev_dbg
c_func
(paren
op_amp
id|client-&gt;dev
comma
l_string|&quot;Increasing &quot;
l_string|&quot;clock divider to %d for fan %d&bslash;n&quot;
comma
id|FAN_DIV_FROM_REG
c_func
(paren
id|data-&gt;fan_status
(braket
id|nr
)braket
)paren
comma
id|nr
op_plus
l_int|1
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* Decrease clock divider if possible */
r_while
c_loop
(paren
op_logical_neg
(paren
id|data-&gt;fan_min
(braket
id|nr
)braket
op_amp
l_int|0x80
)paren
multiline_comment|/* min &quot;nails&quot; divider */
op_logical_and
id|data-&gt;fan
(braket
id|nr
)braket
OL
l_int|85
multiline_comment|/* bad accuracy */
op_logical_and
(paren
id|data-&gt;fan_status
(braket
id|nr
)braket
op_amp
l_int|0x60
)paren
op_ne
l_int|0x00
)paren
(brace
id|data-&gt;fan_status
(braket
id|nr
)braket
op_sub_assign
l_int|0x20
suffix:semicolon
id|data-&gt;fan_min
(braket
id|nr
)braket
op_lshift_assign
l_int|1
suffix:semicolon
id|data-&gt;fan
(braket
id|nr
)braket
op_lshift_assign
l_int|1
suffix:semicolon
id|dev_dbg
c_func
(paren
op_amp
id|client-&gt;dev
comma
l_string|&quot;Decreasing &quot;
l_string|&quot;clock divider to %d for fan %d&bslash;n&quot;
comma
id|FAN_DIV_FROM_REG
c_func
(paren
id|data-&gt;fan_status
(braket
id|nr
)braket
)paren
comma
id|nr
op_plus
l_int|1
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Write new fan min if it changed */
r_if
c_cond
(paren
id|old_min
op_ne
id|data-&gt;fan_min
(braket
id|nr
)braket
)paren
(brace
id|pc87360_write_value
c_func
(paren
id|data
comma
id|LD_FAN
comma
id|NO_BANK
comma
id|PC87360_REG_FAN_MIN
c_func
(paren
id|nr
)paren
comma
id|data-&gt;fan_min
(braket
id|nr
)braket
)paren
suffix:semicolon
)brace
)brace
DECL|function|pc87360_update_device
r_static
r_struct
id|pc87360_data
op_star
id|pc87360_update_device
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|i2c_client
op_star
id|client
op_assign
id|to_i2c_client
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|pc87360_data
op_star
id|data
op_assign
id|i2c_get_clientdata
c_func
(paren
id|client
)paren
suffix:semicolon
id|u8
id|i
suffix:semicolon
id|down
c_func
(paren
op_amp
id|data-&gt;update_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|time_after
c_func
(paren
id|jiffies
comma
id|data-&gt;last_updated
op_plus
id|HZ
op_star
l_int|2
)paren
op_logical_or
op_logical_neg
id|data-&gt;valid
)paren
(brace
id|dev_dbg
c_func
(paren
op_amp
id|client-&gt;dev
comma
l_string|&quot;Data update&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Fans */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|data-&gt;fannr
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|FAN_CONFIG_MONITOR
c_func
(paren
id|data-&gt;fan_conf
comma
id|i
)paren
)paren
(brace
id|data-&gt;fan_status
(braket
id|i
)braket
op_assign
id|pc87360_read_value
c_func
(paren
id|data
comma
id|LD_FAN
comma
id|NO_BANK
comma
id|PC87360_REG_FAN_STATUS
c_func
(paren
id|i
)paren
)paren
suffix:semicolon
id|data-&gt;fan
(braket
id|i
)braket
op_assign
id|pc87360_read_value
c_func
(paren
id|data
comma
id|LD_FAN
comma
id|NO_BANK
comma
id|PC87360_REG_FAN
c_func
(paren
id|i
)paren
)paren
suffix:semicolon
id|data-&gt;fan_min
(braket
id|i
)braket
op_assign
id|pc87360_read_value
c_func
(paren
id|data
comma
id|LD_FAN
comma
id|NO_BANK
comma
id|PC87360_REG_FAN_MIN
c_func
(paren
id|i
)paren
)paren
suffix:semicolon
multiline_comment|/* Change clock divider if needed */
id|pc87360_autodiv
c_func
(paren
id|client
comma
id|i
)paren
suffix:semicolon
multiline_comment|/* Clear bits and write new divider */
id|pc87360_write_value
c_func
(paren
id|data
comma
id|LD_FAN
comma
id|NO_BANK
comma
id|PC87360_REG_FAN_STATUS
c_func
(paren
id|i
)paren
comma
id|data-&gt;fan_status
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|FAN_CONFIG_CONTROL
c_func
(paren
id|data-&gt;fan_conf
comma
id|i
)paren
)paren
id|data-&gt;pwm
(braket
id|i
)braket
op_assign
id|pc87360_read_value
c_func
(paren
id|data
comma
id|LD_FAN
comma
id|NO_BANK
comma
id|PC87360_REG_PWM
c_func
(paren
id|i
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Voltages */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|data-&gt;innr
suffix:semicolon
id|i
op_increment
)paren
(brace
id|data-&gt;in_status
(braket
id|i
)braket
op_assign
id|pc87360_read_value
c_func
(paren
id|data
comma
id|LD_IN
comma
id|i
comma
id|PC87365_REG_IN_STATUS
)paren
suffix:semicolon
multiline_comment|/* Clear bits */
id|pc87360_write_value
c_func
(paren
id|data
comma
id|LD_IN
comma
id|i
comma
id|PC87365_REG_IN_STATUS
comma
id|data-&gt;in_status
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|data-&gt;in_status
(braket
id|i
)braket
op_amp
l_int|0x81
)paren
op_eq
l_int|0x81
)paren
(brace
id|data-&gt;in
(braket
id|i
)braket
op_assign
id|pc87360_read_value
c_func
(paren
id|data
comma
id|LD_IN
comma
id|i
comma
id|PC87365_REG_IN
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|data-&gt;in_status
(braket
id|i
)braket
op_amp
l_int|0x01
)paren
(brace
id|data-&gt;in_min
(braket
id|i
)braket
op_assign
id|pc87360_read_value
c_func
(paren
id|data
comma
id|LD_IN
comma
id|i
comma
id|PC87365_REG_IN_MIN
)paren
suffix:semicolon
id|data-&gt;in_max
(braket
id|i
)braket
op_assign
id|pc87360_read_value
c_func
(paren
id|data
comma
id|LD_IN
comma
id|i
comma
id|PC87365_REG_IN_MAX
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_ge
l_int|11
)paren
id|data-&gt;in_crit
(braket
id|i
op_minus
l_int|11
)braket
op_assign
id|pc87360_read_value
c_func
(paren
id|data
comma
id|LD_IN
comma
id|i
comma
id|PC87365_REG_TEMP_CRIT
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|data-&gt;innr
)paren
(brace
id|data-&gt;in_alarms
op_assign
id|pc87360_read_value
c_func
(paren
id|data
comma
id|LD_IN
comma
id|NO_BANK
comma
id|PC87365_REG_IN_ALARMS1
)paren
op_or
(paren
(paren
id|pc87360_read_value
c_func
(paren
id|data
comma
id|LD_IN
comma
id|NO_BANK
comma
id|PC87365_REG_IN_ALARMS2
)paren
op_amp
l_int|0x07
)paren
op_lshift
l_int|8
)paren
suffix:semicolon
id|data-&gt;vid
op_assign
(paren
id|data-&gt;vid_conf
op_amp
l_int|0xE0
)paren
ques
c_cond
id|pc87360_read_value
c_func
(paren
id|data
comma
id|LD_IN
comma
id|NO_BANK
comma
id|PC87365_REG_VID
)paren
suffix:colon
l_int|0x1F
suffix:semicolon
)brace
multiline_comment|/* Temperatures */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|data-&gt;tempnr
suffix:semicolon
id|i
op_increment
)paren
(brace
id|data-&gt;temp_status
(braket
id|i
)braket
op_assign
id|pc87360_read_value
c_func
(paren
id|data
comma
id|LD_TEMP
comma
id|i
comma
id|PC87365_REG_TEMP_STATUS
)paren
suffix:semicolon
multiline_comment|/* Clear bits */
id|pc87360_write_value
c_func
(paren
id|data
comma
id|LD_TEMP
comma
id|i
comma
id|PC87365_REG_TEMP_STATUS
comma
id|data-&gt;temp_status
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|data-&gt;temp_status
(braket
id|i
)braket
op_amp
l_int|0x81
)paren
op_eq
l_int|0x81
)paren
(brace
id|data-&gt;temp
(braket
id|i
)braket
op_assign
id|pc87360_read_value
c_func
(paren
id|data
comma
id|LD_TEMP
comma
id|i
comma
id|PC87365_REG_TEMP
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|data-&gt;temp_status
(braket
id|i
)braket
op_amp
l_int|0x01
)paren
(brace
id|data-&gt;temp_min
(braket
id|i
)braket
op_assign
id|pc87360_read_value
c_func
(paren
id|data
comma
id|LD_TEMP
comma
id|i
comma
id|PC87365_REG_TEMP_MIN
)paren
suffix:semicolon
id|data-&gt;temp_max
(braket
id|i
)braket
op_assign
id|pc87360_read_value
c_func
(paren
id|data
comma
id|LD_TEMP
comma
id|i
comma
id|PC87365_REG_TEMP_MAX
)paren
suffix:semicolon
id|data-&gt;temp_crit
(braket
id|i
)braket
op_assign
id|pc87360_read_value
c_func
(paren
id|data
comma
id|LD_TEMP
comma
id|i
comma
id|PC87365_REG_TEMP_CRIT
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|data-&gt;tempnr
)paren
(brace
id|data-&gt;temp_alarms
op_assign
id|pc87360_read_value
c_func
(paren
id|data
comma
id|LD_TEMP
comma
id|NO_BANK
comma
id|PC87365_REG_TEMP_ALARMS
)paren
op_amp
l_int|0x3F
suffix:semicolon
)brace
id|data-&gt;last_updated
op_assign
id|jiffies
suffix:semicolon
id|data-&gt;valid
op_assign
l_int|1
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|data-&gt;update_lock
)paren
suffix:semicolon
r_return
id|data
suffix:semicolon
)brace
DECL|function|pc87360_init
r_static
r_int
id|__init
id|pc87360_init
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|pc87360_find
c_func
(paren
l_int|0x2e
comma
op_amp
id|devid
comma
id|extra_isa
)paren
op_logical_and
id|pc87360_find
c_func
(paren
l_int|0x4e
comma
op_amp
id|devid
comma
id|extra_isa
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;pc87360: PC8736x not detected, &quot;
l_string|&quot;module not inserted.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* Arbitrarily pick one of the addresses */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|3
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|extra_isa
(braket
id|i
)braket
op_ne
l_int|0x0000
)paren
(brace
id|normal_isa
(braket
l_int|0
)braket
op_assign
id|extra_isa
(braket
id|i
)braket
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|normal_isa
(braket
l_int|0
)braket
op_eq
l_int|0x0000
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;pc87360: No active logical device, &quot;
l_string|&quot;module not inserted.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_return
id|i2c_add_driver
c_func
(paren
op_amp
id|pc87360_driver
)paren
suffix:semicolon
)brace
DECL|function|pc87360_exit
r_static
r_void
id|__exit
id|pc87360_exit
c_func
(paren
r_void
)paren
(brace
id|i2c_del_driver
c_func
(paren
op_amp
id|pc87360_driver
)paren
suffix:semicolon
)brace
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Jean Delvare &lt;khali@linux-fr.org&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;PC8736x hardware monitor&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
DECL|variable|pc87360_init
id|module_init
c_func
(paren
id|pc87360_init
)paren
suffix:semicolon
DECL|variable|pc87360_exit
id|module_exit
c_func
(paren
id|pc87360_exit
)paren
suffix:semicolon
eof
