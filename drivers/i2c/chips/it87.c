multiline_comment|/*&n;    it87.c - Part of lm_sensors, Linux kernel modules for hardware&n;             monitoring.&n;&n;    Supports: IT8705F  Super I/O chip w/LPC interface&n;              IT8712F  Super I/O chip w/LPC interface &amp; SMbus&n;              Sis950   A clone of the IT8705F&n;&n;    Copyright (C) 2001 Chris Gauthron &lt;chrisg@0-in.com&gt; &n;    Largely inspired by lm78.c of the same package&n;&n;    This program is free software; you can redistribute it and/or modify&n;    it under the terms of the GNU General Public License as published by&n;    the Free Software Foundation; either version 2 of the License, or&n;    (at your option) any later version.&n;&n;    This program is distributed in the hope that it will be useful,&n;    but WITHOUT ANY WARRANTY; without even the implied warranty of&n;    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n;    GNU General Public License for more details.&n;&n;    You should have received a copy of the GNU General Public License&n;    along with this program; if not, write to the Free Software&n;    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n;*/
multiline_comment|/*&n;    djg@pdp8.net David Gesswein 7/18/01&n;    Modified to fix bug with not all alarms enabled.&n;    Added ability to read battery voltage and select temperature sensor&n;    type at module load time.&n;*/
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/i2c.h&gt;
macro_line|#include &lt;linux/i2c-sensor.h&gt;
macro_line|#include &lt;linux/i2c-vid.h&gt;
macro_line|#include &lt;asm/io.h&gt;
multiline_comment|/* Addresses to scan */
DECL|variable|normal_i2c
r_static
r_int
r_int
id|normal_i2c
(braket
)braket
op_assign
(brace
l_int|0x20
comma
l_int|0x21
comma
l_int|0x22
comma
l_int|0x23
comma
l_int|0x24
comma
l_int|0x25
comma
l_int|0x26
comma
l_int|0x27
comma
l_int|0x28
comma
l_int|0x29
comma
l_int|0x2a
comma
l_int|0x2b
comma
l_int|0x2c
comma
l_int|0x2d
comma
l_int|0x2e
comma
l_int|0x2f
comma
id|I2C_CLIENT_END
)brace
suffix:semicolon
DECL|variable|normal_isa
r_static
r_int
r_int
id|normal_isa
(braket
)braket
op_assign
(brace
l_int|0x0290
comma
id|I2C_CLIENT_ISA_END
)brace
suffix:semicolon
multiline_comment|/* Insmod parameters */
id|SENSORS_INSMOD_2
c_func
(paren
id|it87
comma
id|it8712
)paren
suffix:semicolon
DECL|macro|REG
mdefine_line|#define&t;REG&t;0x2e&t;/* The register to read/write */
DECL|macro|DEV
mdefine_line|#define&t;DEV&t;0x07&t;/* Register: Logical device select */
DECL|macro|VAL
mdefine_line|#define&t;VAL&t;0x2f&t;/* The value to read/write */
DECL|macro|PME
mdefine_line|#define PME&t;0x04&t;/* The device with the fan registers in it */
DECL|macro|DEVID
mdefine_line|#define&t;DEVID&t;0x20&t;/* Register: Device ID */
r_static
r_inline
r_int
DECL|function|superio_inb
id|superio_inb
c_func
(paren
r_int
id|reg
)paren
(brace
id|outb
c_func
(paren
id|reg
comma
id|REG
)paren
suffix:semicolon
r_return
id|inb
c_func
(paren
id|VAL
)paren
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|superio_select
id|superio_select
c_func
(paren
r_void
)paren
(brace
id|outb
c_func
(paren
id|DEV
comma
id|REG
)paren
suffix:semicolon
id|outb
c_func
(paren
id|PME
comma
id|VAL
)paren
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|superio_enter
id|superio_enter
c_func
(paren
r_void
)paren
(brace
id|outb
c_func
(paren
l_int|0x87
comma
id|REG
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x01
comma
id|REG
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x55
comma
id|REG
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x55
comma
id|REG
)paren
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|superio_exit
id|superio_exit
c_func
(paren
r_void
)paren
(brace
id|outb
c_func
(paren
l_int|0x02
comma
id|REG
)paren
suffix:semicolon
id|outb
c_func
(paren
l_int|0x02
comma
id|VAL
)paren
suffix:semicolon
)brace
multiline_comment|/* just IT8712F for now - this should be extended to support the other&n;   chips as well */
DECL|macro|IT8712F_DEVID
mdefine_line|#define IT8712F_DEVID 0x8712
DECL|macro|IT87_ACT_REG
mdefine_line|#define IT87_ACT_REG  0x30
DECL|macro|IT87_BASE_REG
mdefine_line|#define IT87_BASE_REG 0x60
multiline_comment|/* Update battery voltage after every reading if true */
DECL|variable|update_vbat
r_static
r_int
id|update_vbat
suffix:semicolon
multiline_comment|/* Chip Type */
DECL|variable|chip_type
r_static
id|u16
id|chip_type
suffix:semicolon
multiline_comment|/* Many IT87 constants specified below */
multiline_comment|/* Length of ISA address segment */
DECL|macro|IT87_EXTENT
mdefine_line|#define IT87_EXTENT 8
multiline_comment|/* Where are the ISA address/data registers relative to the base address */
DECL|macro|IT87_ADDR_REG_OFFSET
mdefine_line|#define IT87_ADDR_REG_OFFSET 5
DECL|macro|IT87_DATA_REG_OFFSET
mdefine_line|#define IT87_DATA_REG_OFFSET 6
multiline_comment|/*----- The IT87 registers -----*/
DECL|macro|IT87_REG_CONFIG
mdefine_line|#define IT87_REG_CONFIG        0x00
DECL|macro|IT87_REG_ALARM1
mdefine_line|#define IT87_REG_ALARM1        0x01
DECL|macro|IT87_REG_ALARM2
mdefine_line|#define IT87_REG_ALARM2        0x02
DECL|macro|IT87_REG_ALARM3
mdefine_line|#define IT87_REG_ALARM3        0x03
DECL|macro|IT87_REG_VID
mdefine_line|#define IT87_REG_VID           0x0a
DECL|macro|IT87_REG_FAN_DIV
mdefine_line|#define IT87_REG_FAN_DIV       0x0b
multiline_comment|/* Monitors: 9 voltage (0 to 7, battery), 3 temp (1 to 3), 3 fan (1 to 3) */
DECL|macro|IT87_REG_FAN
mdefine_line|#define IT87_REG_FAN(nr)       (0x0d + (nr))
DECL|macro|IT87_REG_FAN_MIN
mdefine_line|#define IT87_REG_FAN_MIN(nr)   (0x10 + (nr))
DECL|macro|IT87_REG_FAN_MAIN_CTRL
mdefine_line|#define IT87_REG_FAN_MAIN_CTRL 0x13
DECL|macro|IT87_REG_FAN_CTL
mdefine_line|#define IT87_REG_FAN_CTL       0x14
DECL|macro|IT87_REG_PWM
mdefine_line|#define IT87_REG_PWM(nr)       (0x15 + (nr))
DECL|macro|IT87_REG_VIN
mdefine_line|#define IT87_REG_VIN(nr)       (0x20 + (nr))
DECL|macro|IT87_REG_TEMP
mdefine_line|#define IT87_REG_TEMP(nr)      (0x29 + (nr))
DECL|macro|IT87_REG_VIN_MAX
mdefine_line|#define IT87_REG_VIN_MAX(nr)   (0x30 + (nr) * 2)
DECL|macro|IT87_REG_VIN_MIN
mdefine_line|#define IT87_REG_VIN_MIN(nr)   (0x31 + (nr) * 2)
DECL|macro|IT87_REG_TEMP_HIGH
mdefine_line|#define IT87_REG_TEMP_HIGH(nr) (0x40 + (nr) * 2)
DECL|macro|IT87_REG_TEMP_LOW
mdefine_line|#define IT87_REG_TEMP_LOW(nr)  (0x41 + (nr) * 2)
DECL|macro|IT87_REG_I2C_ADDR
mdefine_line|#define IT87_REG_I2C_ADDR      0x48
DECL|macro|IT87_REG_VIN_ENABLE
mdefine_line|#define IT87_REG_VIN_ENABLE    0x50
DECL|macro|IT87_REG_TEMP_ENABLE
mdefine_line|#define IT87_REG_TEMP_ENABLE   0x51
DECL|macro|IT87_REG_CHIPID
mdefine_line|#define IT87_REG_CHIPID        0x58
DECL|macro|IN_TO_REG
mdefine_line|#define IN_TO_REG(val)  (SENSORS_LIMIT((((val) + 8)/16),0,255))
DECL|macro|IN_FROM_REG
mdefine_line|#define IN_FROM_REG(val) ((val) * 16)
DECL|function|FAN_TO_REG
r_static
r_inline
id|u8
id|FAN_TO_REG
c_func
(paren
r_int
id|rpm
comma
r_int
id|div
)paren
(brace
r_if
c_cond
(paren
id|rpm
op_eq
l_int|0
)paren
r_return
l_int|255
suffix:semicolon
id|rpm
op_assign
id|SENSORS_LIMIT
c_func
(paren
id|rpm
comma
l_int|1
comma
l_int|1000000
)paren
suffix:semicolon
r_return
id|SENSORS_LIMIT
c_func
(paren
(paren
l_int|1350000
op_plus
id|rpm
op_star
id|div
op_div
l_int|2
)paren
op_div
(paren
id|rpm
op_star
id|div
)paren
comma
l_int|1
comma
l_int|254
)paren
suffix:semicolon
)brace
DECL|macro|FAN_FROM_REG
mdefine_line|#define FAN_FROM_REG(val,div) ((val)==0?-1:(val)==255?0:1350000/((val)*(div)))
DECL|macro|TEMP_TO_REG
mdefine_line|#define TEMP_TO_REG(val) (SENSORS_LIMIT(((val)&lt;0?(((val)-500)/1000):&bslash;&n;&t;&t;&t;&t;&t;((val)+500)/1000),-128,127))
DECL|macro|TEMP_FROM_REG
mdefine_line|#define TEMP_FROM_REG(val) (((val)&gt;0x80?(val)-0x100:(val))*1000)
DECL|macro|ALARMS_FROM_REG
mdefine_line|#define ALARMS_FROM_REG(val) (val)
DECL|macro|PWM_TO_REG
mdefine_line|#define PWM_TO_REG(val)   ((val) &gt;&gt; 1)
DECL|macro|PWM_FROM_REG
mdefine_line|#define PWM_FROM_REG(val) (((val)&amp;0x7f) &lt;&lt; 1)
DECL|function|DIV_TO_REG
r_static
r_int
id|DIV_TO_REG
c_func
(paren
r_int
id|val
)paren
(brace
r_int
id|answer
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
id|val
op_rshift_assign
l_int|1
)paren
op_ne
l_int|0
)paren
id|answer
op_increment
suffix:semicolon
r_return
id|answer
suffix:semicolon
)brace
DECL|macro|DIV_FROM_REG
mdefine_line|#define DIV_FROM_REG(val) (1 &lt;&lt; (val))
multiline_comment|/* For each registered IT87, we need to keep some data in memory. That&n;   data is pointed to by it87_list[NR]-&gt;data. The structure itself is&n;   dynamically allocated, at the same time when a new it87 client is&n;   allocated. */
DECL|struct|it87_data
r_struct
id|it87_data
(brace
DECL|member|client
r_struct
id|i2c_client
id|client
suffix:semicolon
DECL|member|lock
r_struct
id|semaphore
id|lock
suffix:semicolon
DECL|member|type
r_enum
id|chips
id|type
suffix:semicolon
DECL|member|update_lock
r_struct
id|semaphore
id|update_lock
suffix:semicolon
DECL|member|valid
r_char
id|valid
suffix:semicolon
multiline_comment|/* !=0 if following fields are valid */
DECL|member|last_updated
r_int
r_int
id|last_updated
suffix:semicolon
multiline_comment|/* In jiffies */
DECL|member|in
id|u8
id|in
(braket
l_int|9
)braket
suffix:semicolon
multiline_comment|/* Register value */
DECL|member|in_max
id|u8
id|in_max
(braket
l_int|9
)braket
suffix:semicolon
multiline_comment|/* Register value */
DECL|member|in_min
id|u8
id|in_min
(braket
l_int|9
)braket
suffix:semicolon
multiline_comment|/* Register value */
DECL|member|fan
id|u8
id|fan
(braket
l_int|3
)braket
suffix:semicolon
multiline_comment|/* Register value */
DECL|member|fan_min
id|u8
id|fan_min
(braket
l_int|3
)braket
suffix:semicolon
multiline_comment|/* Register value */
DECL|member|temp
id|u8
id|temp
(braket
l_int|3
)braket
suffix:semicolon
multiline_comment|/* Register value */
DECL|member|temp_high
id|u8
id|temp_high
(braket
l_int|3
)braket
suffix:semicolon
multiline_comment|/* Register value */
DECL|member|temp_low
id|u8
id|temp_low
(braket
l_int|3
)braket
suffix:semicolon
multiline_comment|/* Register value */
DECL|member|sensor
id|u8
id|sensor
suffix:semicolon
multiline_comment|/* Register value */
DECL|member|fan_div
id|u8
id|fan_div
(braket
l_int|3
)braket
suffix:semicolon
multiline_comment|/* Register encoding, shifted right */
DECL|member|vid
id|u8
id|vid
suffix:semicolon
multiline_comment|/* Register encoding, combined */
DECL|member|vrm
r_int
id|vrm
suffix:semicolon
DECL|member|alarms
id|u32
id|alarms
suffix:semicolon
multiline_comment|/* Register encoding, combined */
DECL|member|fan_main_ctrl
id|u8
id|fan_main_ctrl
suffix:semicolon
multiline_comment|/* Register value */
DECL|member|manual_pwm_ctl
id|u8
id|manual_pwm_ctl
(braket
l_int|3
)braket
suffix:semicolon
multiline_comment|/* manual PWM value set by user */
)brace
suffix:semicolon
r_static
r_int
id|it87_attach_adapter
c_func
(paren
r_struct
id|i2c_adapter
op_star
id|adapter
)paren
suffix:semicolon
r_static
r_int
id|it87_find
c_func
(paren
r_int
op_star
id|address
)paren
suffix:semicolon
r_static
r_int
id|it87_detect
c_func
(paren
r_struct
id|i2c_adapter
op_star
id|adapter
comma
r_int
id|address
comma
r_int
id|kind
)paren
suffix:semicolon
r_static
r_int
id|it87_detach_client
c_func
(paren
r_struct
id|i2c_client
op_star
id|client
)paren
suffix:semicolon
r_static
r_int
id|it87_read_value
c_func
(paren
r_struct
id|i2c_client
op_star
id|client
comma
id|u8
r_register
)paren
suffix:semicolon
r_static
r_int
id|it87_write_value
c_func
(paren
r_struct
id|i2c_client
op_star
id|client
comma
id|u8
r_register
comma
id|u8
id|value
)paren
suffix:semicolon
r_static
r_struct
id|it87_data
op_star
id|it87_update_device
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
r_static
r_void
id|it87_init_client
c_func
(paren
r_struct
id|i2c_client
op_star
id|client
comma
r_struct
id|it87_data
op_star
id|data
)paren
suffix:semicolon
DECL|variable|it87_driver
r_static
r_struct
id|i2c_driver
id|it87_driver
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|name
op_assign
l_string|&quot;it87&quot;
comma
dot
id|id
op_assign
id|I2C_DRIVERID_IT87
comma
dot
id|flags
op_assign
id|I2C_DF_NOTIFY
comma
dot
id|attach_adapter
op_assign
id|it87_attach_adapter
comma
dot
id|detach_client
op_assign
id|it87_detach_client
comma
)brace
suffix:semicolon
DECL|variable|it87_id
r_static
r_int
id|it87_id
suffix:semicolon
DECL|function|show_in
r_static
id|ssize_t
id|show_in
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
comma
r_int
id|nr
)paren
(brace
r_struct
id|it87_data
op_star
id|data
op_assign
id|it87_update_device
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%d&bslash;n&quot;
comma
id|IN_FROM_REG
c_func
(paren
id|data-&gt;in
(braket
id|nr
)braket
)paren
)paren
suffix:semicolon
)brace
DECL|function|show_in_min
r_static
id|ssize_t
id|show_in_min
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
comma
r_int
id|nr
)paren
(brace
r_struct
id|it87_data
op_star
id|data
op_assign
id|it87_update_device
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%d&bslash;n&quot;
comma
id|IN_FROM_REG
c_func
(paren
id|data-&gt;in_min
(braket
id|nr
)braket
)paren
)paren
suffix:semicolon
)brace
DECL|function|show_in_max
r_static
id|ssize_t
id|show_in_max
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
comma
r_int
id|nr
)paren
(brace
r_struct
id|it87_data
op_star
id|data
op_assign
id|it87_update_device
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%d&bslash;n&quot;
comma
id|IN_FROM_REG
c_func
(paren
id|data-&gt;in_max
(braket
id|nr
)braket
)paren
)paren
suffix:semicolon
)brace
DECL|function|set_in_min
r_static
id|ssize_t
id|set_in_min
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
comma
r_int
id|nr
)paren
(brace
r_struct
id|i2c_client
op_star
id|client
op_assign
id|to_i2c_client
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|it87_data
op_star
id|data
op_assign
id|i2c_get_clientdata
c_func
(paren
id|client
)paren
suffix:semicolon
r_int
r_int
id|val
op_assign
id|simple_strtoul
c_func
(paren
id|buf
comma
l_int|NULL
comma
l_int|10
)paren
suffix:semicolon
id|data-&gt;in_min
(braket
id|nr
)braket
op_assign
id|IN_TO_REG
c_func
(paren
id|val
)paren
suffix:semicolon
id|it87_write_value
c_func
(paren
id|client
comma
id|IT87_REG_VIN_MIN
c_func
(paren
id|nr
)paren
comma
id|data-&gt;in_min
(braket
id|nr
)braket
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
DECL|function|set_in_max
r_static
id|ssize_t
id|set_in_max
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
comma
r_int
id|nr
)paren
(brace
r_struct
id|i2c_client
op_star
id|client
op_assign
id|to_i2c_client
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|it87_data
op_star
id|data
op_assign
id|i2c_get_clientdata
c_func
(paren
id|client
)paren
suffix:semicolon
r_int
r_int
id|val
op_assign
id|simple_strtoul
c_func
(paren
id|buf
comma
l_int|NULL
comma
l_int|10
)paren
suffix:semicolon
id|data-&gt;in_max
(braket
id|nr
)braket
op_assign
id|IN_TO_REG
c_func
(paren
id|val
)paren
suffix:semicolon
id|it87_write_value
c_func
(paren
id|client
comma
id|IT87_REG_VIN_MAX
c_func
(paren
id|nr
)paren
comma
id|data-&gt;in_max
(braket
id|nr
)braket
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
DECL|macro|show_in_offset
mdefine_line|#define show_in_offset(offset)&t;&t;&t;&t;&t;&bslash;&n;static ssize_t&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;show_in##offset (struct device *dev, char *buf)&t;&t;&bslash;&n;{&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;return show_in(dev, buf, offset);&t;&t;&t;&bslash;&n;}&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;static DEVICE_ATTR(in##offset##_input, S_IRUGO, show_in##offset, NULL);
DECL|macro|limit_in_offset
mdefine_line|#define limit_in_offset(offset)&t;&t;&t;&t;&t;&bslash;&n;static ssize_t&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;show_in##offset##_min (struct device *dev, char *buf)&t;&bslash;&n;{&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;return show_in_min(dev, buf, offset);&t;&t;&t;&bslash;&n;}&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;static ssize_t&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;show_in##offset##_max (struct device *dev, char *buf)&t;&bslash;&n;{&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;return show_in_max(dev, buf, offset);&t;&t;&t;&bslash;&n;}&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;static ssize_t set_in##offset##_min (struct device *dev, &t;&bslash;&n;&t;&t;const char *buf, size_t count) &t;&t;&t;&bslash;&n;{&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;return set_in_min(dev, buf, count, offset);&t;&t;&bslash;&n;}&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;static ssize_t set_in##offset##_max (struct device *dev,&t;&bslash;&n;&t;&t;&t;const char *buf, size_t count)&t;&t;&bslash;&n;{&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;return set_in_max(dev, buf, count, offset);&t;&t;&bslash;&n;}&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;static DEVICE_ATTR(in##offset##_min, S_IRUGO | S_IWUSR, &t;&bslash;&n;&t;&t;show_in##offset##_min, set_in##offset##_min);&t;&bslash;&n;static DEVICE_ATTR(in##offset##_max, S_IRUGO | S_IWUSR, &t;&bslash;&n;&t;&t;show_in##offset##_max, set_in##offset##_max);
id|show_in_offset
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|limit_in_offset
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|show_in_offset
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|limit_in_offset
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|show_in_offset
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|limit_in_offset
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|show_in_offset
c_func
(paren
l_int|3
)paren
suffix:semicolon
id|limit_in_offset
c_func
(paren
l_int|3
)paren
suffix:semicolon
id|show_in_offset
c_func
(paren
l_int|4
)paren
suffix:semicolon
id|limit_in_offset
c_func
(paren
l_int|4
)paren
suffix:semicolon
id|show_in_offset
c_func
(paren
l_int|5
)paren
suffix:semicolon
id|limit_in_offset
c_func
(paren
l_int|5
)paren
suffix:semicolon
id|show_in_offset
c_func
(paren
l_int|6
)paren
suffix:semicolon
id|limit_in_offset
c_func
(paren
l_int|6
)paren
suffix:semicolon
id|show_in_offset
c_func
(paren
l_int|7
)paren
suffix:semicolon
id|limit_in_offset
c_func
(paren
l_int|7
)paren
suffix:semicolon
id|show_in_offset
c_func
(paren
l_int|8
)paren
suffix:semicolon
multiline_comment|/* 3 temperatures */
DECL|function|show_temp
r_static
id|ssize_t
id|show_temp
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
comma
r_int
id|nr
)paren
(brace
r_struct
id|it87_data
op_star
id|data
op_assign
id|it87_update_device
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%d&bslash;n&quot;
comma
id|TEMP_FROM_REG
c_func
(paren
id|data-&gt;temp
(braket
id|nr
)braket
)paren
)paren
suffix:semicolon
)brace
DECL|function|show_temp_max
r_static
id|ssize_t
id|show_temp_max
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
comma
r_int
id|nr
)paren
(brace
r_struct
id|it87_data
op_star
id|data
op_assign
id|it87_update_device
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%d&bslash;n&quot;
comma
id|TEMP_FROM_REG
c_func
(paren
id|data-&gt;temp_high
(braket
id|nr
)braket
)paren
)paren
suffix:semicolon
)brace
DECL|function|show_temp_min
r_static
id|ssize_t
id|show_temp_min
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
comma
r_int
id|nr
)paren
(brace
r_struct
id|it87_data
op_star
id|data
op_assign
id|it87_update_device
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%d&bslash;n&quot;
comma
id|TEMP_FROM_REG
c_func
(paren
id|data-&gt;temp_low
(braket
id|nr
)braket
)paren
)paren
suffix:semicolon
)brace
DECL|function|set_temp_max
r_static
id|ssize_t
id|set_temp_max
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
comma
r_int
id|nr
)paren
(brace
r_struct
id|i2c_client
op_star
id|client
op_assign
id|to_i2c_client
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|it87_data
op_star
id|data
op_assign
id|i2c_get_clientdata
c_func
(paren
id|client
)paren
suffix:semicolon
r_int
id|val
op_assign
id|simple_strtol
c_func
(paren
id|buf
comma
l_int|NULL
comma
l_int|10
)paren
suffix:semicolon
id|data-&gt;temp_high
(braket
id|nr
)braket
op_assign
id|TEMP_TO_REG
c_func
(paren
id|val
)paren
suffix:semicolon
id|it87_write_value
c_func
(paren
id|client
comma
id|IT87_REG_TEMP_HIGH
c_func
(paren
id|nr
)paren
comma
id|data-&gt;temp_high
(braket
id|nr
)braket
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
DECL|function|set_temp_min
r_static
id|ssize_t
id|set_temp_min
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
comma
r_int
id|nr
)paren
(brace
r_struct
id|i2c_client
op_star
id|client
op_assign
id|to_i2c_client
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|it87_data
op_star
id|data
op_assign
id|i2c_get_clientdata
c_func
(paren
id|client
)paren
suffix:semicolon
r_int
id|val
op_assign
id|simple_strtol
c_func
(paren
id|buf
comma
l_int|NULL
comma
l_int|10
)paren
suffix:semicolon
id|data-&gt;temp_low
(braket
id|nr
)braket
op_assign
id|TEMP_TO_REG
c_func
(paren
id|val
)paren
suffix:semicolon
id|it87_write_value
c_func
(paren
id|client
comma
id|IT87_REG_TEMP_LOW
c_func
(paren
id|nr
)paren
comma
id|data-&gt;temp_low
(braket
id|nr
)braket
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
DECL|macro|show_temp_offset
mdefine_line|#define show_temp_offset(offset)&t;&t;&t;&t;&t;&bslash;&n;static ssize_t show_temp_##offset (struct device *dev, char *buf)&t;&bslash;&n;{&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;return show_temp(dev, buf, offset - 1);&t;&t;&t;&t;&bslash;&n;}&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;static ssize_t&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;show_temp_##offset##_max (struct device *dev, char *buf)&t;&t;&bslash;&n;{&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;return show_temp_max(dev, buf, offset - 1);&t;&t;&t;&bslash;&n;}&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;static ssize_t&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;show_temp_##offset##_min (struct device *dev, char *buf)&t;&t;&bslash;&n;{&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;return show_temp_min(dev, buf, offset - 1);&t;&t;&t;&bslash;&n;}&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;static ssize_t set_temp_##offset##_max (struct device *dev, &t;&t;&bslash;&n;&t;&t;const char *buf, size_t count) &t;&t;&t;&t;&bslash;&n;{&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;return set_temp_max(dev, buf, count, offset - 1);&t;&t;&bslash;&n;}&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;static ssize_t set_temp_##offset##_min (struct device *dev, &t;&t;&bslash;&n;&t;&t;const char *buf, size_t count) &t;&t;&t;&t;&bslash;&n;{&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;return set_temp_min(dev, buf, count, offset - 1);&t;&t;&bslash;&n;}&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;static DEVICE_ATTR(temp##offset##_input, S_IRUGO, show_temp_##offset, NULL); &bslash;&n;static DEVICE_ATTR(temp##offset##_max, S_IRUGO | S_IWUSR, &t;&t;&bslash;&n;&t;&t;show_temp_##offset##_max, set_temp_##offset##_max); &t;&bslash;&n;static DEVICE_ATTR(temp##offset##_min, S_IRUGO | S_IWUSR, &t;&t;&bslash;&n;&t;&t;show_temp_##offset##_min, set_temp_##offset##_min);&t;
id|show_temp_offset
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|show_temp_offset
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|show_temp_offset
c_func
(paren
l_int|3
)paren
suffix:semicolon
DECL|function|show_sensor
r_static
id|ssize_t
id|show_sensor
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
comma
r_int
id|nr
)paren
(brace
r_struct
id|it87_data
op_star
id|data
op_assign
id|it87_update_device
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|data-&gt;sensor
op_amp
(paren
l_int|1
op_lshift
id|nr
)paren
)paren
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;3&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* thermal diode */
r_if
c_cond
(paren
id|data-&gt;sensor
op_amp
(paren
l_int|8
op_lshift
id|nr
)paren
)paren
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;2&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* thermistor */
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;0&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* disabled */
)brace
DECL|function|set_sensor
r_static
id|ssize_t
id|set_sensor
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
comma
r_int
id|nr
)paren
(brace
r_struct
id|i2c_client
op_star
id|client
op_assign
id|to_i2c_client
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|it87_data
op_star
id|data
op_assign
id|i2c_get_clientdata
c_func
(paren
id|client
)paren
suffix:semicolon
r_int
id|val
op_assign
id|simple_strtol
c_func
(paren
id|buf
comma
l_int|NULL
comma
l_int|10
)paren
suffix:semicolon
id|data-&gt;sensor
op_and_assign
op_complement
(paren
l_int|1
op_lshift
id|nr
)paren
suffix:semicolon
id|data-&gt;sensor
op_and_assign
op_complement
(paren
l_int|8
op_lshift
id|nr
)paren
suffix:semicolon
multiline_comment|/* 3 = thermal diode; 2 = thermistor; 0 = disabled */
r_if
c_cond
(paren
id|val
op_eq
l_int|3
)paren
id|data-&gt;sensor
op_or_assign
l_int|1
op_lshift
id|nr
suffix:semicolon
r_else
r_if
c_cond
(paren
id|val
op_eq
l_int|2
)paren
id|data-&gt;sensor
op_or_assign
l_int|8
op_lshift
id|nr
suffix:semicolon
r_else
r_if
c_cond
(paren
id|val
op_ne
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|it87_write_value
c_func
(paren
id|client
comma
id|IT87_REG_TEMP_ENABLE
comma
id|data-&gt;sensor
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
DECL|macro|show_sensor_offset
mdefine_line|#define show_sensor_offset(offset)&t;&t;&t;&t;&t;&bslash;&n;static ssize_t show_sensor_##offset (struct device *dev, char *buf)&t;&bslash;&n;{&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;return show_sensor(dev, buf, offset - 1);&t;&t;&t;&bslash;&n;}&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;static ssize_t set_sensor_##offset (struct device *dev, &t;&t;&bslash;&n;&t;&t;const char *buf, size_t count) &t;&t;&t;&t;&bslash;&n;{&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;return set_sensor(dev, buf, count, offset - 1);&t;&t;&t;&bslash;&n;}&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;static DEVICE_ATTR(temp##offset##_type, S_IRUGO | S_IWUSR, &t;&t;&bslash;&n;&t;&t;show_sensor_##offset, set_sensor_##offset);
id|show_sensor_offset
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|show_sensor_offset
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|show_sensor_offset
c_func
(paren
l_int|3
)paren
suffix:semicolon
multiline_comment|/* 3 Fans */
DECL|function|show_fan
r_static
id|ssize_t
id|show_fan
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
comma
r_int
id|nr
)paren
(brace
r_struct
id|it87_data
op_star
id|data
op_assign
id|it87_update_device
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%d&bslash;n&quot;
comma
id|FAN_FROM_REG
c_func
(paren
id|data-&gt;fan
(braket
id|nr
)braket
comma
id|DIV_FROM_REG
c_func
(paren
id|data-&gt;fan_div
(braket
id|nr
)braket
)paren
)paren
)paren
suffix:semicolon
)brace
DECL|function|show_fan_min
r_static
id|ssize_t
id|show_fan_min
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
comma
r_int
id|nr
)paren
(brace
r_struct
id|it87_data
op_star
id|data
op_assign
id|it87_update_device
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%d&bslash;n&quot;
comma
id|FAN_FROM_REG
c_func
(paren
id|data-&gt;fan_min
(braket
id|nr
)braket
comma
id|DIV_FROM_REG
c_func
(paren
id|data-&gt;fan_div
(braket
id|nr
)braket
)paren
)paren
)paren
suffix:semicolon
)brace
DECL|function|show_fan_div
r_static
id|ssize_t
id|show_fan_div
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
comma
r_int
id|nr
)paren
(brace
r_struct
id|it87_data
op_star
id|data
op_assign
id|it87_update_device
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%d&bslash;n&quot;
comma
id|DIV_FROM_REG
c_func
(paren
id|data-&gt;fan_div
(braket
id|nr
)braket
)paren
)paren
suffix:semicolon
)brace
DECL|function|show_pwm_enable
r_static
id|ssize_t
id|show_pwm_enable
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
comma
r_int
id|nr
)paren
(brace
r_struct
id|it87_data
op_star
id|data
op_assign
id|it87_update_device
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%d&bslash;n&quot;
comma
(paren
id|data-&gt;fan_main_ctrl
op_amp
(paren
l_int|1
op_lshift
id|nr
)paren
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|show_pwm
r_static
id|ssize_t
id|show_pwm
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
comma
r_int
id|nr
)paren
(brace
r_struct
id|it87_data
op_star
id|data
op_assign
id|it87_update_device
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%d&bslash;n&quot;
comma
id|data-&gt;manual_pwm_ctl
(braket
id|nr
)braket
)paren
suffix:semicolon
)brace
DECL|function|set_fan_min
r_static
id|ssize_t
id|set_fan_min
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
comma
r_int
id|nr
)paren
(brace
r_struct
id|i2c_client
op_star
id|client
op_assign
id|to_i2c_client
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|it87_data
op_star
id|data
op_assign
id|i2c_get_clientdata
c_func
(paren
id|client
)paren
suffix:semicolon
r_int
id|val
op_assign
id|simple_strtol
c_func
(paren
id|buf
comma
l_int|NULL
comma
l_int|10
)paren
suffix:semicolon
id|data-&gt;fan_min
(braket
id|nr
)braket
op_assign
id|FAN_TO_REG
c_func
(paren
id|val
comma
id|DIV_FROM_REG
c_func
(paren
id|data-&gt;fan_div
(braket
id|nr
)braket
)paren
)paren
suffix:semicolon
id|it87_write_value
c_func
(paren
id|client
comma
id|IT87_REG_FAN_MIN
c_func
(paren
id|nr
)paren
comma
id|data-&gt;fan_min
(braket
id|nr
)braket
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
DECL|function|set_fan_div
r_static
id|ssize_t
id|set_fan_div
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
comma
r_int
id|nr
)paren
(brace
r_struct
id|i2c_client
op_star
id|client
op_assign
id|to_i2c_client
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|it87_data
op_star
id|data
op_assign
id|i2c_get_clientdata
c_func
(paren
id|client
)paren
suffix:semicolon
r_int
id|val
op_assign
id|simple_strtol
c_func
(paren
id|buf
comma
l_int|NULL
comma
l_int|10
)paren
suffix:semicolon
r_int
id|i
comma
id|min
(braket
l_int|3
)braket
suffix:semicolon
id|u8
id|old
op_assign
id|it87_read_value
c_func
(paren
id|client
comma
id|IT87_REG_FAN_DIV
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|3
suffix:semicolon
id|i
op_increment
)paren
id|min
(braket
id|i
)braket
op_assign
id|FAN_FROM_REG
c_func
(paren
id|data-&gt;fan_min
(braket
id|i
)braket
comma
id|DIV_FROM_REG
c_func
(paren
id|data-&gt;fan_div
(braket
id|i
)braket
)paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|nr
)paren
(brace
r_case
l_int|0
suffix:colon
r_case
l_int|1
suffix:colon
id|data-&gt;fan_div
(braket
id|nr
)braket
op_assign
id|DIV_TO_REG
c_func
(paren
id|val
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
r_if
c_cond
(paren
id|val
OL
l_int|8
)paren
id|data-&gt;fan_div
(braket
id|nr
)braket
op_assign
l_int|1
suffix:semicolon
r_else
id|data-&gt;fan_div
(braket
id|nr
)braket
op_assign
l_int|3
suffix:semicolon
)brace
id|val
op_assign
id|old
op_amp
l_int|0x100
suffix:semicolon
id|val
op_or_assign
(paren
id|data-&gt;fan_div
(braket
l_int|0
)braket
op_amp
l_int|0x07
)paren
suffix:semicolon
id|val
op_or_assign
(paren
id|data-&gt;fan_div
(braket
l_int|1
)braket
op_amp
l_int|0x07
)paren
op_lshift
l_int|3
suffix:semicolon
r_if
c_cond
(paren
id|data-&gt;fan_div
(braket
l_int|2
)braket
op_eq
l_int|3
)paren
id|val
op_or_assign
l_int|0x1
op_lshift
l_int|6
suffix:semicolon
id|it87_write_value
c_func
(paren
id|client
comma
id|IT87_REG_FAN_DIV
comma
id|val
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|3
suffix:semicolon
id|i
op_increment
)paren
(brace
id|data-&gt;fan_min
(braket
id|i
)braket
op_assign
id|FAN_TO_REG
c_func
(paren
id|min
(braket
id|i
)braket
comma
id|DIV_FROM_REG
c_func
(paren
id|data-&gt;fan_div
(braket
id|i
)braket
)paren
)paren
suffix:semicolon
id|it87_write_value
c_func
(paren
id|client
comma
id|IT87_REG_FAN_MIN
c_func
(paren
id|i
)paren
comma
id|data-&gt;fan_min
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
r_return
id|count
suffix:semicolon
)brace
DECL|function|set_pwm_enable
r_static
id|ssize_t
id|set_pwm_enable
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
comma
r_int
id|nr
)paren
(brace
r_struct
id|i2c_client
op_star
id|client
op_assign
id|to_i2c_client
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|it87_data
op_star
id|data
op_assign
id|i2c_get_clientdata
c_func
(paren
id|client
)paren
suffix:semicolon
r_int
id|val
op_assign
id|simple_strtol
c_func
(paren
id|buf
comma
l_int|NULL
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val
op_eq
l_int|0
)paren
(brace
multiline_comment|/* set on/off mode */
id|data-&gt;fan_main_ctrl
op_and_assign
op_complement
(paren
l_int|1
op_lshift
id|nr
)paren
suffix:semicolon
id|it87_write_value
c_func
(paren
id|client
comma
id|IT87_REG_FAN_MAIN_CTRL
comma
id|data-&gt;fan_main_ctrl
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|val
op_eq
l_int|1
)paren
(brace
multiline_comment|/* set SmartGuardian mode */
id|data-&gt;fan_main_ctrl
op_or_assign
(paren
l_int|1
op_lshift
id|nr
)paren
suffix:semicolon
id|it87_write_value
c_func
(paren
id|client
comma
id|IT87_REG_FAN_MAIN_CTRL
comma
id|data-&gt;fan_main_ctrl
)paren
suffix:semicolon
multiline_comment|/* set saved pwm value, clear FAN_CTLX PWM mode bit */
id|it87_write_value
c_func
(paren
id|client
comma
id|IT87_REG_PWM
c_func
(paren
id|nr
)paren
comma
id|PWM_TO_REG
c_func
(paren
id|data-&gt;manual_pwm_ctl
(braket
id|nr
)braket
)paren
)paren
suffix:semicolon
)brace
r_else
r_return
op_minus
id|EINVAL
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
DECL|function|set_pwm
r_static
id|ssize_t
id|set_pwm
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
comma
r_int
id|nr
)paren
(brace
r_struct
id|i2c_client
op_star
id|client
op_assign
id|to_i2c_client
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|it87_data
op_star
id|data
op_assign
id|i2c_get_clientdata
c_func
(paren
id|client
)paren
suffix:semicolon
r_int
id|val
op_assign
id|simple_strtol
c_func
(paren
id|buf
comma
l_int|NULL
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val
template_param
l_int|255
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|data-&gt;manual_pwm_ctl
(braket
id|nr
)braket
op_assign
id|val
suffix:semicolon
r_if
c_cond
(paren
id|data-&gt;fan_main_ctrl
op_amp
(paren
l_int|1
op_lshift
id|nr
)paren
)paren
id|it87_write_value
c_func
(paren
id|client
comma
id|IT87_REG_PWM
c_func
(paren
id|nr
)paren
comma
id|PWM_TO_REG
c_func
(paren
id|data-&gt;manual_pwm_ctl
(braket
id|nr
)braket
)paren
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
DECL|macro|show_fan_offset
mdefine_line|#define show_fan_offset(offset)&t;&t;&t;&t;&t;&t;&bslash;&n;static ssize_t show_fan_##offset (struct device *dev, char *buf)&t;&bslash;&n;{&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;return show_fan(dev, buf, offset - 1);&t;&t;&t;&t;&bslash;&n;}&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;static ssize_t show_fan_##offset##_min (struct device *dev, char *buf)&t;&bslash;&n;{&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;return show_fan_min(dev, buf, offset - 1);&t;&t;&t;&bslash;&n;}&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;static ssize_t show_fan_##offset##_div (struct device *dev, char *buf)&t;&bslash;&n;{&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;return show_fan_div(dev, buf, offset - 1);&t;&t;&t;&bslash;&n;}&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;static ssize_t set_fan_##offset##_min (struct device *dev, &t;&t;&bslash;&n;&t;const char *buf, size_t count) &t;&t;&t;&t;&t;&bslash;&n;{&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;return set_fan_min(dev, buf, count, offset - 1);&t;&t;&bslash;&n;}&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;static ssize_t set_fan_##offset##_div (struct device *dev, &t;&t;&bslash;&n;&t;&t;const char *buf, size_t count) &t;&t;&t;&t;&bslash;&n;{&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;return set_fan_div(dev, buf, count, offset - 1);&t;&t;&bslash;&n;}&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;static DEVICE_ATTR(fan##offset##_input, S_IRUGO, show_fan_##offset, NULL); &bslash;&n;static DEVICE_ATTR(fan##offset##_min, S_IRUGO | S_IWUSR, &t;&t;&bslash;&n;&t;&t;show_fan_##offset##_min, set_fan_##offset##_min); &t;&bslash;&n;static DEVICE_ATTR(fan##offset##_div, S_IRUGO | S_IWUSR, &t;&t;&bslash;&n;&t;&t;show_fan_##offset##_div, set_fan_##offset##_div);
id|show_fan_offset
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|show_fan_offset
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|show_fan_offset
c_func
(paren
l_int|3
)paren
suffix:semicolon
DECL|macro|show_pwm_offset
mdefine_line|#define show_pwm_offset(offset)&t;&t;&t;&t;&t;&t;&bslash;&n;static ssize_t show_pwm##offset##_enable (struct device *dev,&t;&t;&bslash;&n;&t;char *buf)&t;&t;&t;&t;&t;&t;&t;&bslash;&n;{&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;return show_pwm_enable(dev, buf, offset - 1);&t;&t;&t;&bslash;&n;}&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;static ssize_t show_pwm##offset (struct device *dev, char *buf)&t;&t;&bslash;&n;{&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;return show_pwm(dev, buf, offset - 1);&t;&t;&t;&t;&bslash;&n;}&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;static ssize_t set_pwm##offset##_enable (struct device *dev,&t;&t;&bslash;&n;&t;&t;const char *buf, size_t count)&t;&t;&t;&t;&bslash;&n;{&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;return set_pwm_enable(dev, buf, count, offset - 1);&t;&t;&bslash;&n;}&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;static ssize_t set_pwm##offset (struct device *dev,&t;&t;&t;&bslash;&n;&t;&t;const char *buf, size_t count)&t;&t;&t;&t;&bslash;&n;{&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;return set_pwm(dev, buf, count, offset - 1);&t;&t;&t;&bslash;&n;}&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;static DEVICE_ATTR(pwm##offset##_enable, S_IRUGO | S_IWUSR,&t;&t;&bslash;&n;&t;&t;show_pwm##offset##_enable,&t;&t;&t;&t;&bslash;&n;&t;&t;set_pwm##offset##_enable);&t;&t;&t;&t;&bslash;&n;static DEVICE_ATTR(pwm##offset, S_IRUGO | S_IWUSR,&t;&t;&t;&bslash;&n;&t;&t;show_pwm##offset , set_pwm##offset );
id|show_pwm_offset
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|show_pwm_offset
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|show_pwm_offset
c_func
(paren
l_int|3
)paren
suffix:semicolon
multiline_comment|/* Alarms */
DECL|function|show_alarms
r_static
id|ssize_t
id|show_alarms
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
)paren
(brace
r_struct
id|it87_data
op_star
id|data
op_assign
id|it87_update_device
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%d&bslash;n&quot;
comma
id|ALARMS_FROM_REG
c_func
(paren
id|data-&gt;alarms
)paren
)paren
suffix:semicolon
)brace
r_static
id|DEVICE_ATTR
c_func
(paren
id|alarms
comma
id|S_IRUGO
op_or
id|S_IWUSR
comma
id|show_alarms
comma
l_int|NULL
)paren
suffix:semicolon
r_static
id|ssize_t
DECL|function|show_vrm_reg
id|show_vrm_reg
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
)paren
(brace
r_struct
id|it87_data
op_star
id|data
op_assign
id|it87_update_device
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%ld&bslash;n&quot;
comma
(paren
r_int
)paren
id|data-&gt;vrm
)paren
suffix:semicolon
)brace
r_static
id|ssize_t
DECL|function|store_vrm_reg
id|store_vrm_reg
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_struct
id|i2c_client
op_star
id|client
op_assign
id|to_i2c_client
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|it87_data
op_star
id|data
op_assign
id|i2c_get_clientdata
c_func
(paren
id|client
)paren
suffix:semicolon
id|u32
id|val
suffix:semicolon
id|val
op_assign
id|simple_strtoul
c_func
(paren
id|buf
comma
l_int|NULL
comma
l_int|10
)paren
suffix:semicolon
id|data-&gt;vrm
op_assign
id|val
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
r_static
id|DEVICE_ATTR
c_func
(paren
id|vrm
comma
id|S_IRUGO
op_or
id|S_IWUSR
comma
id|show_vrm_reg
comma
id|store_vrm_reg
)paren
suffix:semicolon
DECL|macro|device_create_file_vrm
mdefine_line|#define device_create_file_vrm(client) &bslash;&n;device_create_file(&amp;client-&gt;dev, &amp;dev_attr_vrm)
r_static
id|ssize_t
DECL|function|show_vid_reg
id|show_vid_reg
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
)paren
(brace
r_struct
id|it87_data
op_star
id|data
op_assign
id|it87_update_device
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%ld&bslash;n&quot;
comma
(paren
r_int
)paren
id|vid_from_reg
c_func
(paren
id|data-&gt;vid
comma
id|data-&gt;vrm
)paren
)paren
suffix:semicolon
)brace
r_static
id|DEVICE_ATTR
c_func
(paren
id|cpu0_vid
comma
id|S_IRUGO
comma
id|show_vid_reg
comma
l_int|NULL
)paren
suffix:semicolon
DECL|macro|device_create_file_vid
mdefine_line|#define device_create_file_vid(client) &bslash;&n;device_create_file(&amp;client-&gt;dev, &amp;dev_attr_cpu0_vid)
multiline_comment|/* This function is called when:&n;     * it87_driver is inserted (when this module is loaded), for each&n;       available adapter&n;     * when a new adapter is inserted (and it87_driver is still present) */
DECL|function|it87_attach_adapter
r_static
r_int
id|it87_attach_adapter
c_func
(paren
r_struct
id|i2c_adapter
op_star
id|adapter
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|adapter
op_member_access_from_pointer
r_class
op_amp
id|I2C_CLASS_HWMON
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_return
id|i2c_detect
c_func
(paren
id|adapter
comma
op_amp
id|addr_data
comma
id|it87_detect
)paren
suffix:semicolon
)brace
multiline_comment|/* SuperIO detection - will change normal_isa[0] if a chip is found */
DECL|function|it87_find
r_static
r_int
id|it87_find
c_func
(paren
r_int
op_star
id|address
)paren
(brace
id|u16
id|val
suffix:semicolon
id|superio_enter
c_func
(paren
)paren
suffix:semicolon
id|chip_type
op_assign
(paren
id|superio_inb
c_func
(paren
id|DEVID
)paren
op_lshift
l_int|8
)paren
op_or
id|superio_inb
c_func
(paren
id|DEVID
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chip_type
op_ne
id|IT8712F_DEVID
)paren
(brace
id|superio_exit
c_func
(paren
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|superio_select
c_func
(paren
)paren
suffix:semicolon
id|val
op_assign
(paren
id|superio_inb
c_func
(paren
id|IT87_BASE_REG
)paren
op_lshift
l_int|8
)paren
op_or
id|superio_inb
c_func
(paren
id|IT87_BASE_REG
op_plus
l_int|1
)paren
suffix:semicolon
id|superio_exit
c_func
(paren
)paren
suffix:semicolon
op_star
id|address
op_assign
id|val
op_amp
op_complement
(paren
id|IT87_EXTENT
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|address
op_eq
l_int|0
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* This function is called by i2c_detect */
DECL|function|it87_detect
r_int
id|it87_detect
c_func
(paren
r_struct
id|i2c_adapter
op_star
id|adapter
comma
r_int
id|address
comma
r_int
id|kind
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|i2c_client
op_star
id|new_client
suffix:semicolon
r_struct
id|it87_data
op_star
id|data
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
r_const
r_char
op_star
id|name
op_assign
l_string|&quot;&quot;
suffix:semicolon
r_int
id|is_isa
op_assign
id|i2c_is_isa_adapter
c_func
(paren
id|adapter
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|is_isa
op_logical_and
op_logical_neg
id|i2c_check_functionality
c_func
(paren
id|adapter
comma
id|I2C_FUNC_SMBUS_BYTE_DATA
)paren
)paren
r_goto
id|ERROR0
suffix:semicolon
multiline_comment|/* Reserve the ISA region */
r_if
c_cond
(paren
id|is_isa
)paren
r_if
c_cond
(paren
op_logical_neg
id|request_region
c_func
(paren
id|address
comma
id|IT87_EXTENT
comma
id|it87_driver.name
)paren
)paren
r_goto
id|ERROR0
suffix:semicolon
multiline_comment|/* Probe whether there is anything available on this address. Already&n;&t;   done for SMBus clients */
r_if
c_cond
(paren
id|kind
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|is_isa
)paren
(brace
DECL|macro|REALLY_SLOW_IO
mdefine_line|#define REALLY_SLOW_IO
multiline_comment|/* We need the timeouts for at least some IT87-like chips. But only&n;&t;&t;&t;   if we read &squot;undefined&squot; registers. */
id|i
op_assign
id|inb_p
c_func
(paren
id|address
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inb_p
c_func
(paren
id|address
op_plus
l_int|2
)paren
op_ne
id|i
op_logical_or
id|inb_p
c_func
(paren
id|address
op_plus
l_int|3
)paren
op_ne
id|i
op_logical_or
id|inb_p
c_func
(paren
id|address
op_plus
l_int|7
)paren
op_ne
id|i
)paren
(brace
id|err
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|ERROR1
suffix:semicolon
)brace
DECL|macro|REALLY_SLOW_IO
macro_line|#undef REALLY_SLOW_IO
multiline_comment|/* Let&squot;s just hope nothing breaks here */
id|i
op_assign
id|inb_p
c_func
(paren
id|address
op_plus
l_int|5
)paren
op_amp
l_int|0x7f
suffix:semicolon
id|outb_p
c_func
(paren
op_complement
id|i
op_amp
l_int|0x7f
comma
id|address
op_plus
l_int|5
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|inb_p
c_func
(paren
id|address
op_plus
l_int|5
)paren
op_amp
l_int|0x7f
)paren
op_ne
(paren
op_complement
id|i
op_amp
l_int|0x7f
)paren
)paren
(brace
id|outb_p
c_func
(paren
id|i
comma
id|address
op_plus
l_int|5
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|ERROR1
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* OK. For now, we presume we have a valid client. We now create the&n;&t;   client structure, even though we cannot fill it completely yet.&n;&t;   But it allows us to access it87_{read,write}_value. */
r_if
c_cond
(paren
op_logical_neg
(paren
id|data
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|it87_data
)paren
comma
id|GFP_KERNEL
)paren
)paren
)paren
(brace
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|ERROR1
suffix:semicolon
)brace
id|memset
c_func
(paren
id|data
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|it87_data
)paren
)paren
suffix:semicolon
id|new_client
op_assign
op_amp
id|data-&gt;client
suffix:semicolon
r_if
c_cond
(paren
id|is_isa
)paren
id|init_MUTEX
c_func
(paren
op_amp
id|data-&gt;lock
)paren
suffix:semicolon
id|i2c_set_clientdata
c_func
(paren
id|new_client
comma
id|data
)paren
suffix:semicolon
id|new_client-&gt;addr
op_assign
id|address
suffix:semicolon
id|new_client-&gt;adapter
op_assign
id|adapter
suffix:semicolon
id|new_client-&gt;driver
op_assign
op_amp
id|it87_driver
suffix:semicolon
id|new_client-&gt;flags
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Now, we do the remaining detection. */
r_if
c_cond
(paren
id|kind
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
(paren
id|it87_read_value
c_func
(paren
id|new_client
comma
id|IT87_REG_CONFIG
)paren
op_amp
l_int|0x80
)paren
op_logical_or
(paren
op_logical_neg
id|is_isa
op_logical_and
id|it87_read_value
c_func
(paren
id|new_client
comma
id|IT87_REG_I2C_ADDR
)paren
op_ne
id|address
)paren
)paren
(brace
id|err
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|ERROR2
suffix:semicolon
)brace
)brace
multiline_comment|/* Determine the chip type. */
r_if
c_cond
(paren
id|kind
op_le
l_int|0
)paren
(brace
id|i
op_assign
id|it87_read_value
c_func
(paren
id|new_client
comma
id|IT87_REG_CHIPID
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
l_int|0x90
)paren
(brace
id|kind
op_assign
id|it87
suffix:semicolon
r_if
c_cond
(paren
(paren
id|is_isa
)paren
op_logical_and
(paren
id|chip_type
op_eq
id|IT8712F_DEVID
)paren
)paren
id|kind
op_assign
id|it8712
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|kind
op_eq
l_int|0
)paren
id|dev_info
c_func
(paren
op_amp
id|adapter-&gt;dev
comma
l_string|&quot;Ignoring &squot;force&squot; parameter for unknown chip at &quot;
l_string|&quot;adapter %d, address 0x%02x&bslash;n&quot;
comma
id|i2c_adapter_id
c_func
(paren
id|adapter
)paren
comma
id|address
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|ERROR2
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|kind
op_eq
id|it87
)paren
(brace
id|name
op_assign
l_string|&quot;it87&quot;
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|kind
op_eq
id|it8712
)paren
(brace
id|name
op_assign
l_string|&quot;it8712&quot;
suffix:semicolon
)brace
multiline_comment|/* Fill in the remaining client fields and put it into the global list */
id|strlcpy
c_func
(paren
id|new_client-&gt;name
comma
id|name
comma
id|I2C_NAME_SIZE
)paren
suffix:semicolon
id|data-&gt;type
op_assign
id|kind
suffix:semicolon
id|new_client-&gt;id
op_assign
id|it87_id
op_increment
suffix:semicolon
id|data-&gt;valid
op_assign
l_int|0
suffix:semicolon
id|init_MUTEX
c_func
(paren
op_amp
id|data-&gt;update_lock
)paren
suffix:semicolon
multiline_comment|/* Tell the I2C layer a new client has arrived */
r_if
c_cond
(paren
(paren
id|err
op_assign
id|i2c_attach_client
c_func
(paren
id|new_client
)paren
)paren
)paren
r_goto
id|ERROR2
suffix:semicolon
multiline_comment|/* Initialize the IT87 chip */
id|it87_init_client
c_func
(paren
id|new_client
comma
id|data
)paren
suffix:semicolon
multiline_comment|/* Register sysfs hooks */
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_in0_input
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_in1_input
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_in2_input
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_in3_input
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_in4_input
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_in5_input
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_in6_input
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_in7_input
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_in8_input
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_in0_min
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_in1_min
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_in2_min
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_in3_min
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_in4_min
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_in5_min
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_in6_min
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_in7_min
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_in0_max
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_in1_max
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_in2_max
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_in3_max
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_in4_max
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_in5_max
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_in6_max
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_in7_max
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_temp1_input
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_temp2_input
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_temp3_input
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_temp1_max
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_temp2_max
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_temp3_max
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_temp1_min
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_temp2_min
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_temp3_min
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_temp1_type
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_temp2_type
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_temp3_type
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_fan1_input
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_fan2_input
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_fan3_input
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_fan1_min
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_fan2_min
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_fan3_min
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_fan1_div
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_fan2_div
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_fan3_div
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_alarms
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_pwm1_enable
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_pwm2_enable
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_pwm3_enable
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_pwm1
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_pwm2
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_pwm3
)paren
suffix:semicolon
r_if
c_cond
(paren
id|data-&gt;type
op_eq
id|it8712
)paren
(brace
id|device_create_file_vrm
c_func
(paren
id|new_client
)paren
suffix:semicolon
id|device_create_file_vid
c_func
(paren
id|new_client
)paren
suffix:semicolon
id|data-&gt;vrm
op_assign
id|i2c_which_vrm
c_func
(paren
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
id|ERROR2
suffix:colon
id|kfree
c_func
(paren
id|data
)paren
suffix:semicolon
id|ERROR1
suffix:colon
r_if
c_cond
(paren
id|is_isa
)paren
id|release_region
c_func
(paren
id|address
comma
id|IT87_EXTENT
)paren
suffix:semicolon
id|ERROR0
suffix:colon
r_return
id|err
suffix:semicolon
)brace
DECL|function|it87_detach_client
r_static
r_int
id|it87_detach_client
c_func
(paren
r_struct
id|i2c_client
op_star
id|client
)paren
(brace
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|i2c_detach_client
c_func
(paren
id|client
)paren
)paren
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|client-&gt;dev
comma
l_string|&quot;Client deregistration failed, client not detached.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i2c_is_isa_client
c_func
(paren
id|client
)paren
)paren
(brace
id|release_region
c_func
(paren
id|client-&gt;addr
comma
id|IT87_EXTENT
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|i2c_get_clientdata
c_func
(paren
id|client
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* The SMBus locks itself, but ISA access must be locked explicitely! &n;   We don&squot;t want to lock the whole ISA bus, so we lock each client&n;   separately.&n;   We ignore the IT87 BUSY flag at this moment - it could lead to deadlocks,&n;   would slow down the IT87 access and should not be necessary. */
DECL|function|it87_read_value
r_static
r_int
id|it87_read_value
c_func
(paren
r_struct
id|i2c_client
op_star
id|client
comma
id|u8
id|reg
)paren
(brace
r_struct
id|it87_data
op_star
id|data
op_assign
id|i2c_get_clientdata
c_func
(paren
id|client
)paren
suffix:semicolon
r_int
id|res
suffix:semicolon
r_if
c_cond
(paren
id|i2c_is_isa_client
c_func
(paren
id|client
)paren
)paren
(brace
id|down
c_func
(paren
op_amp
id|data-&gt;lock
)paren
suffix:semicolon
id|outb_p
c_func
(paren
id|reg
comma
id|client-&gt;addr
op_plus
id|IT87_ADDR_REG_OFFSET
)paren
suffix:semicolon
id|res
op_assign
id|inb_p
c_func
(paren
id|client-&gt;addr
op_plus
id|IT87_DATA_REG_OFFSET
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|data-&gt;lock
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
r_else
r_return
id|i2c_smbus_read_byte_data
c_func
(paren
id|client
comma
id|reg
)paren
suffix:semicolon
)brace
multiline_comment|/* The SMBus locks itself, but ISA access muse be locked explicitely! &n;   We don&squot;t want to lock the whole ISA bus, so we lock each client&n;   separately.&n;   We ignore the IT87 BUSY flag at this moment - it could lead to deadlocks,&n;   would slow down the IT87 access and should not be necessary. */
DECL|function|it87_write_value
r_static
r_int
id|it87_write_value
c_func
(paren
r_struct
id|i2c_client
op_star
id|client
comma
id|u8
id|reg
comma
id|u8
id|value
)paren
(brace
r_struct
id|it87_data
op_star
id|data
op_assign
id|i2c_get_clientdata
c_func
(paren
id|client
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i2c_is_isa_client
c_func
(paren
id|client
)paren
)paren
(brace
id|down
c_func
(paren
op_amp
id|data-&gt;lock
)paren
suffix:semicolon
id|outb_p
c_func
(paren
id|reg
comma
id|client-&gt;addr
op_plus
id|IT87_ADDR_REG_OFFSET
)paren
suffix:semicolon
id|outb_p
c_func
(paren
id|value
comma
id|client-&gt;addr
op_plus
id|IT87_DATA_REG_OFFSET
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|data-&gt;lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
r_return
id|i2c_smbus_write_byte_data
c_func
(paren
id|client
comma
id|reg
comma
id|value
)paren
suffix:semicolon
)brace
multiline_comment|/* Called when we have found a new IT87. */
DECL|function|it87_init_client
r_static
r_void
id|it87_init_client
c_func
(paren
r_struct
id|i2c_client
op_star
id|client
comma
r_struct
id|it87_data
op_star
id|data
)paren
(brace
r_int
id|tmp
comma
id|i
suffix:semicolon
multiline_comment|/* initialize to sane defaults:&n;&t; * - if the chip is in manual pwm mode, this will be overwritten with&n;&t; *   the actual settings on the chip (so in this case, initialization&n;&t; *   is not needed)&n;&t; * - if in automatic or on/off mode, we could switch to manual mode,&n;&t; *   read the registers and set manual_pwm_ctl accordingly, but currently&n;&t; *   this is not implemented, so we initialize to something sane */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|3
suffix:semicolon
id|i
op_increment
)paren
(brace
id|data-&gt;manual_pwm_ctl
(braket
id|i
)braket
op_assign
l_int|0xff
suffix:semicolon
)brace
multiline_comment|/* Check if temperature channnels are reset manually or by some reason */
id|tmp
op_assign
id|it87_read_value
c_func
(paren
id|client
comma
id|IT87_REG_TEMP_ENABLE
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tmp
op_amp
l_int|0x3f
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* Temp1,Temp3=thermistor; Temp2=thermal diode */
id|tmp
op_assign
(paren
id|tmp
op_amp
l_int|0xc0
)paren
op_or
l_int|0x2a
suffix:semicolon
id|it87_write_value
c_func
(paren
id|client
comma
id|IT87_REG_TEMP_ENABLE
comma
id|tmp
)paren
suffix:semicolon
)brace
id|data-&gt;sensor
op_assign
id|tmp
suffix:semicolon
multiline_comment|/* Check if voltage monitors are reset manually or by some reason */
id|tmp
op_assign
id|it87_read_value
c_func
(paren
id|client
comma
id|IT87_REG_VIN_ENABLE
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tmp
op_amp
l_int|0xff
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* Enable all voltage monitors */
id|it87_write_value
c_func
(paren
id|client
comma
id|IT87_REG_VIN_ENABLE
comma
l_int|0xff
)paren
suffix:semicolon
)brace
multiline_comment|/* Check if tachometers are reset manually or by some reason */
id|data-&gt;fan_main_ctrl
op_assign
id|it87_read_value
c_func
(paren
id|client
comma
id|IT87_REG_FAN_MAIN_CTRL
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|data-&gt;fan_main_ctrl
op_amp
l_int|0x70
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* Enable all fan tachometers */
id|data-&gt;fan_main_ctrl
op_or_assign
l_int|0x70
suffix:semicolon
id|it87_write_value
c_func
(paren
id|client
comma
id|IT87_REG_FAN_MAIN_CTRL
comma
id|data-&gt;fan_main_ctrl
)paren
suffix:semicolon
)brace
multiline_comment|/* Set current fan mode registers and the default settings for the&n;&t; * other mode registers */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|3
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|data-&gt;fan_main_ctrl
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
(brace
multiline_comment|/* pwm mode */
id|tmp
op_assign
id|it87_read_value
c_func
(paren
id|client
comma
id|IT87_REG_PWM
c_func
(paren
id|i
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmp
op_amp
l_int|0x80
)paren
(brace
multiline_comment|/* automatic pwm - not yet implemented, but&n;&t;&t;&t;&t; * leave the settings made by the BIOS alone&n;&t;&t;&t;&t; * until a change is requested via the sysfs&n;&t;&t;&t;&t; * interface */
)brace
r_else
(brace
multiline_comment|/* manual pwm */
id|data-&gt;manual_pwm_ctl
(braket
id|i
)braket
op_assign
id|PWM_FROM_REG
c_func
(paren
id|tmp
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* make sure the fan is on when in on/off mode */
id|tmp
op_assign
id|it87_read_value
c_func
(paren
id|client
comma
id|IT87_REG_FAN_CTL
)paren
suffix:semicolon
id|it87_write_value
c_func
(paren
id|client
comma
id|IT87_REG_FAN_CTL
comma
id|tmp
op_or
l_int|0x07
)paren
suffix:semicolon
multiline_comment|/* Start monitoring */
id|it87_write_value
c_func
(paren
id|client
comma
id|IT87_REG_CONFIG
comma
(paren
id|it87_read_value
c_func
(paren
id|client
comma
id|IT87_REG_CONFIG
)paren
op_amp
l_int|0x36
)paren
op_or
(paren
id|update_vbat
ques
c_cond
l_int|0x41
suffix:colon
l_int|0x01
)paren
)paren
suffix:semicolon
)brace
DECL|function|it87_update_device
r_static
r_struct
id|it87_data
op_star
id|it87_update_device
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|i2c_client
op_star
id|client
op_assign
id|to_i2c_client
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|it87_data
op_star
id|data
op_assign
id|i2c_get_clientdata
c_func
(paren
id|client
)paren
suffix:semicolon
r_int
id|i
suffix:semicolon
id|down
c_func
(paren
op_amp
id|data-&gt;update_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|jiffies
op_minus
id|data-&gt;last_updated
OG
id|HZ
op_plus
id|HZ
op_div
l_int|2
)paren
op_logical_or
(paren
id|jiffies
OL
id|data-&gt;last_updated
)paren
op_logical_or
op_logical_neg
id|data-&gt;valid
)paren
(brace
r_if
c_cond
(paren
id|update_vbat
)paren
(brace
multiline_comment|/* Cleared after each update, so reenable.  Value&n;&t;&t; &t;  returned by this read will be previous value */
id|it87_write_value
c_func
(paren
id|client
comma
id|IT87_REG_CONFIG
comma
id|it87_read_value
c_func
(paren
id|client
comma
id|IT87_REG_CONFIG
)paren
op_or
l_int|0x40
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_le
l_int|7
suffix:semicolon
id|i
op_increment
)paren
(brace
id|data-&gt;in
(braket
id|i
)braket
op_assign
id|it87_read_value
c_func
(paren
id|client
comma
id|IT87_REG_VIN
c_func
(paren
id|i
)paren
)paren
suffix:semicolon
id|data-&gt;in_min
(braket
id|i
)braket
op_assign
id|it87_read_value
c_func
(paren
id|client
comma
id|IT87_REG_VIN_MIN
c_func
(paren
id|i
)paren
)paren
suffix:semicolon
id|data-&gt;in_max
(braket
id|i
)braket
op_assign
id|it87_read_value
c_func
(paren
id|client
comma
id|IT87_REG_VIN_MAX
c_func
(paren
id|i
)paren
)paren
suffix:semicolon
)brace
id|data-&gt;in
(braket
l_int|8
)braket
op_assign
id|it87_read_value
c_func
(paren
id|client
comma
id|IT87_REG_VIN
c_func
(paren
l_int|8
)paren
)paren
suffix:semicolon
multiline_comment|/* Temperature sensor doesn&squot;t have limit registers, set&n;&t;&t;   to min and max value */
id|data-&gt;in_min
(braket
l_int|8
)braket
op_assign
l_int|0
suffix:semicolon
id|data-&gt;in_max
(braket
l_int|8
)braket
op_assign
l_int|255
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|3
suffix:semicolon
id|i
op_increment
)paren
(brace
id|data-&gt;fan
(braket
id|i
)braket
op_assign
id|it87_read_value
c_func
(paren
id|client
comma
id|IT87_REG_FAN
c_func
(paren
id|i
)paren
)paren
suffix:semicolon
id|data-&gt;fan_min
(braket
id|i
)braket
op_assign
id|it87_read_value
c_func
(paren
id|client
comma
id|IT87_REG_FAN_MIN
c_func
(paren
id|i
)paren
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|3
suffix:semicolon
id|i
op_increment
)paren
(brace
id|data-&gt;temp
(braket
id|i
)braket
op_assign
id|it87_read_value
c_func
(paren
id|client
comma
id|IT87_REG_TEMP
c_func
(paren
id|i
)paren
)paren
suffix:semicolon
id|data-&gt;temp_high
(braket
id|i
)braket
op_assign
id|it87_read_value
c_func
(paren
id|client
comma
id|IT87_REG_TEMP_HIGH
c_func
(paren
id|i
)paren
)paren
suffix:semicolon
id|data-&gt;temp_low
(braket
id|i
)braket
op_assign
id|it87_read_value
c_func
(paren
id|client
comma
id|IT87_REG_TEMP_LOW
c_func
(paren
id|i
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* The 8705 does not have VID capability */
id|data-&gt;vid
op_assign
l_int|0x1f
suffix:semicolon
id|i
op_assign
id|it87_read_value
c_func
(paren
id|client
comma
id|IT87_REG_FAN_DIV
)paren
suffix:semicolon
id|data-&gt;fan_div
(braket
l_int|0
)braket
op_assign
id|i
op_amp
l_int|0x07
suffix:semicolon
id|data-&gt;fan_div
(braket
l_int|1
)braket
op_assign
(paren
id|i
op_rshift
l_int|3
)paren
op_amp
l_int|0x07
suffix:semicolon
id|data-&gt;fan_div
(braket
l_int|2
)braket
op_assign
(paren
id|i
op_amp
l_int|0x40
)paren
ques
c_cond
l_int|3
suffix:colon
l_int|1
suffix:semicolon
id|data-&gt;alarms
op_assign
id|it87_read_value
c_func
(paren
id|client
comma
id|IT87_REG_ALARM1
)paren
op_or
(paren
id|it87_read_value
c_func
(paren
id|client
comma
id|IT87_REG_ALARM2
)paren
op_lshift
l_int|8
)paren
op_or
(paren
id|it87_read_value
c_func
(paren
id|client
comma
id|IT87_REG_ALARM3
)paren
op_lshift
l_int|16
)paren
suffix:semicolon
id|data-&gt;sensor
op_assign
id|it87_read_value
c_func
(paren
id|client
comma
id|IT87_REG_TEMP_ENABLE
)paren
suffix:semicolon
multiline_comment|/* The 8705 does not have VID capability */
r_if
c_cond
(paren
id|data-&gt;type
op_eq
id|it8712
)paren
(brace
id|data-&gt;vid
op_assign
id|it87_read_value
c_func
(paren
id|client
comma
id|IT87_REG_VID
)paren
suffix:semicolon
id|data-&gt;vid
op_and_assign
l_int|0x1f
suffix:semicolon
)brace
id|data-&gt;last_updated
op_assign
id|jiffies
suffix:semicolon
id|data-&gt;valid
op_assign
l_int|1
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|data-&gt;update_lock
)paren
suffix:semicolon
r_return
id|data
suffix:semicolon
)brace
DECL|function|sm_it87_init
r_static
r_int
id|__init
id|sm_it87_init
c_func
(paren
r_void
)paren
(brace
r_int
id|addr
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|it87_find
c_func
(paren
op_amp
id|addr
)paren
)paren
(brace
id|normal_isa
(braket
l_int|0
)braket
op_assign
id|addr
suffix:semicolon
)brace
r_return
id|i2c_add_driver
c_func
(paren
op_amp
id|it87_driver
)paren
suffix:semicolon
)brace
DECL|function|sm_it87_exit
r_static
r_void
id|__exit
id|sm_it87_exit
c_func
(paren
r_void
)paren
(brace
id|i2c_del_driver
c_func
(paren
op_amp
id|it87_driver
)paren
suffix:semicolon
)brace
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Chris Gauthron &lt;chrisg@0-in.com&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;IT8705F, IT8712F, Sis950 driver&quot;
)paren
suffix:semicolon
id|module_param
c_func
(paren
id|update_vbat
comma
r_bool
comma
l_int|0
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|update_vbat
comma
l_string|&quot;Update vbat if set else return powerup value&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
DECL|variable|sm_it87_init
id|module_init
c_func
(paren
id|sm_it87_init
)paren
suffix:semicolon
DECL|variable|sm_it87_exit
id|module_exit
c_func
(paren
id|sm_it87_exit
)paren
suffix:semicolon
eof
