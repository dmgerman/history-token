multiline_comment|/*&n;  adm1031.c - Part of lm_sensors, Linux kernel modules for hardware&n;  monitoring&n;  Based on lm75.c and lm85.c&n;  Supports adm1030 / adm1031&n;  Copyright (C) 2004 Alexandre d&squot;Alton &lt;alex@alexdalton.org&gt;&n;  Reworked by Jean Delvare &lt;khali@linux-fr.org&gt;&n;  &n;  This program is free software; you can redistribute it and/or modify&n;  it under the terms of the GNU General Public License as published by&n;  the Free Software Foundation; either version 2 of the License, or&n;  (at your option) any later version.&n;&n;  This program is distributed in the hope that it will be useful,&n;  but WITHOUT ANY WARRANTY; without even the implied warranty of&n;  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n;  GNU General Public License for more details.&n;&n;  You should have received a copy of the GNU General Public License&n;  along with this program; if not, write to the Free Software&n;  Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n;*/
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/i2c.h&gt;
macro_line|#include &lt;linux/i2c-sensor.h&gt;
multiline_comment|/* Following macros takes channel parameter starting from 0 to 2 */
DECL|macro|ADM1031_REG_FAN_SPEED
mdefine_line|#define ADM1031_REG_FAN_SPEED(nr)&t;(0x08 + (nr))
DECL|macro|ADM1031_REG_FAN_DIV
mdefine_line|#define ADM1031_REG_FAN_DIV(nr)&t;&t;(0x20  + (nr))
DECL|macro|ADM1031_REG_PWM
mdefine_line|#define ADM1031_REG_PWM&t;&t;&t;(0x22)
DECL|macro|ADM1031_REG_FAN_MIN
mdefine_line|#define ADM1031_REG_FAN_MIN(nr)&t;&t;(0x10 + (nr))
DECL|macro|ADM1031_REG_TEMP_MAX
mdefine_line|#define ADM1031_REG_TEMP_MAX(nr)&t;(0x14  + 4*(nr))
DECL|macro|ADM1031_REG_TEMP_MIN
mdefine_line|#define ADM1031_REG_TEMP_MIN(nr)&t;(0x15  + 4*(nr))
DECL|macro|ADM1031_REG_TEMP_CRIT
mdefine_line|#define ADM1031_REG_TEMP_CRIT(nr)&t;(0x16  + 4*(nr))
DECL|macro|ADM1031_REG_TEMP
mdefine_line|#define ADM1031_REG_TEMP(nr)&t;&t;(0xa + (nr))
DECL|macro|ADM1031_REG_AUTO_TEMP
mdefine_line|#define ADM1031_REG_AUTO_TEMP(nr)&t;(0x24 + (nr))
DECL|macro|ADM1031_REG_STATUS
mdefine_line|#define ADM1031_REG_STATUS(nr)&t;&t;(0x2 + (nr))
DECL|macro|ADM1031_REG_CONF1
mdefine_line|#define ADM1031_REG_CONF1&t;&t;0x0
DECL|macro|ADM1031_REG_CONF2
mdefine_line|#define ADM1031_REG_CONF2&t;&t;0x1
DECL|macro|ADM1031_REG_EXT_TEMP
mdefine_line|#define ADM1031_REG_EXT_TEMP&t;&t;0x6
DECL|macro|ADM1031_CONF1_MONITOR_ENABLE
mdefine_line|#define ADM1031_CONF1_MONITOR_ENABLE&t;0x01&t;/* Monitoring enable */
DECL|macro|ADM1031_CONF1_PWM_INVERT
mdefine_line|#define ADM1031_CONF1_PWM_INVERT&t;0x08&t;/* PWM Invert */
DECL|macro|ADM1031_CONF1_AUTO_MODE
mdefine_line|#define ADM1031_CONF1_AUTO_MODE&t;&t;0x80&t;/* Auto FAN */
DECL|macro|ADM1031_CONF2_PWM1_ENABLE
mdefine_line|#define ADM1031_CONF2_PWM1_ENABLE&t;0x01
DECL|macro|ADM1031_CONF2_PWM2_ENABLE
mdefine_line|#define ADM1031_CONF2_PWM2_ENABLE&t;0x02
DECL|macro|ADM1031_CONF2_TACH1_ENABLE
mdefine_line|#define ADM1031_CONF2_TACH1_ENABLE&t;0x04
DECL|macro|ADM1031_CONF2_TACH2_ENABLE
mdefine_line|#define ADM1031_CONF2_TACH2_ENABLE&t;0x08
DECL|macro|ADM1031_CONF2_TEMP_ENABLE
mdefine_line|#define ADM1031_CONF2_TEMP_ENABLE(chan)&t;(0x10 &lt;&lt; (chan))
multiline_comment|/* Addresses to scan */
DECL|variable|normal_i2c
r_static
r_int
r_int
id|normal_i2c
(braket
)braket
op_assign
(brace
l_int|0x2c
comma
l_int|0x2d
comma
l_int|0x2e
comma
id|I2C_CLIENT_END
)brace
suffix:semicolon
DECL|variable|normal_isa
r_static
r_int
r_int
id|normal_isa
(braket
)braket
op_assign
(brace
id|I2C_CLIENT_ISA_END
)brace
suffix:semicolon
multiline_comment|/* Insmod parameters */
id|SENSORS_INSMOD_2
c_func
(paren
id|adm1030
comma
id|adm1031
)paren
suffix:semicolon
DECL|typedef|auto_chan_table_t
r_typedef
id|u8
id|auto_chan_table_t
(braket
l_int|8
)braket
(braket
l_int|2
)braket
suffix:semicolon
multiline_comment|/* Each client has this additional data */
DECL|struct|adm1031_data
r_struct
id|adm1031_data
(brace
DECL|member|client
r_struct
id|i2c_client
id|client
suffix:semicolon
DECL|member|update_lock
r_struct
id|semaphore
id|update_lock
suffix:semicolon
DECL|member|chip_type
r_int
id|chip_type
suffix:semicolon
DECL|member|valid
r_char
id|valid
suffix:semicolon
multiline_comment|/* !=0 if following fields are valid */
DECL|member|last_updated
r_int
r_int
id|last_updated
suffix:semicolon
multiline_comment|/* In jiffies */
multiline_comment|/* The chan_select_table contains the possible configurations for&n;&t; * auto fan control.&n;&t; */
DECL|member|chan_select_table
id|auto_chan_table_t
op_star
id|chan_select_table
suffix:semicolon
DECL|member|alarm
id|u16
id|alarm
suffix:semicolon
DECL|member|conf1
id|u8
id|conf1
suffix:semicolon
DECL|member|conf2
id|u8
id|conf2
suffix:semicolon
DECL|member|fan
id|u8
id|fan
(braket
l_int|2
)braket
suffix:semicolon
DECL|member|fan_div
id|u8
id|fan_div
(braket
l_int|2
)braket
suffix:semicolon
DECL|member|fan_min
id|u8
id|fan_min
(braket
l_int|2
)braket
suffix:semicolon
DECL|member|pwm
id|u8
id|pwm
(braket
l_int|2
)braket
suffix:semicolon
DECL|member|old_pwm
id|u8
id|old_pwm
(braket
l_int|2
)braket
suffix:semicolon
DECL|member|temp
id|s8
id|temp
(braket
l_int|3
)braket
suffix:semicolon
DECL|member|ext_temp
id|u8
id|ext_temp
(braket
l_int|3
)braket
suffix:semicolon
DECL|member|auto_temp
id|u8
id|auto_temp
(braket
l_int|3
)braket
suffix:semicolon
DECL|member|auto_temp_min
id|u8
id|auto_temp_min
(braket
l_int|3
)braket
suffix:semicolon
DECL|member|auto_temp_off
id|u8
id|auto_temp_off
(braket
l_int|3
)braket
suffix:semicolon
DECL|member|auto_temp_max
id|u8
id|auto_temp_max
(braket
l_int|3
)braket
suffix:semicolon
DECL|member|temp_min
id|s8
id|temp_min
(braket
l_int|3
)braket
suffix:semicolon
DECL|member|temp_max
id|s8
id|temp_max
(braket
l_int|3
)braket
suffix:semicolon
DECL|member|temp_crit
id|s8
id|temp_crit
(braket
l_int|3
)braket
suffix:semicolon
)brace
suffix:semicolon
r_static
r_int
id|adm1031_attach_adapter
c_func
(paren
r_struct
id|i2c_adapter
op_star
id|adapter
)paren
suffix:semicolon
r_static
r_int
id|adm1031_detect
c_func
(paren
r_struct
id|i2c_adapter
op_star
id|adapter
comma
r_int
id|address
comma
r_int
id|kind
)paren
suffix:semicolon
r_static
r_void
id|adm1031_init_client
c_func
(paren
r_struct
id|i2c_client
op_star
id|client
)paren
suffix:semicolon
r_static
r_int
id|adm1031_detach_client
c_func
(paren
r_struct
id|i2c_client
op_star
id|client
)paren
suffix:semicolon
r_static
r_struct
id|adm1031_data
op_star
id|adm1031_update_device
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
suffix:semicolon
multiline_comment|/* This is the driver that will be inserted */
DECL|variable|adm1031_driver
r_static
r_struct
id|i2c_driver
id|adm1031_driver
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|name
op_assign
l_string|&quot;adm1031&quot;
comma
dot
id|flags
op_assign
id|I2C_DF_NOTIFY
comma
dot
id|attach_adapter
op_assign
id|adm1031_attach_adapter
comma
dot
id|detach_client
op_assign
id|adm1031_detach_client
comma
)brace
suffix:semicolon
DECL|variable|adm1031_id
r_static
r_int
id|adm1031_id
suffix:semicolon
DECL|function|adm1031_read_value
r_static
r_inline
id|u8
id|adm1031_read_value
c_func
(paren
r_struct
id|i2c_client
op_star
id|client
comma
id|u8
id|reg
)paren
(brace
r_return
id|i2c_smbus_read_byte_data
c_func
(paren
id|client
comma
id|reg
)paren
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|adm1031_write_value
id|adm1031_write_value
c_func
(paren
r_struct
id|i2c_client
op_star
id|client
comma
id|u8
id|reg
comma
r_int
r_int
id|value
)paren
(brace
r_return
id|i2c_smbus_write_byte_data
c_func
(paren
id|client
comma
id|reg
comma
id|value
)paren
suffix:semicolon
)brace
DECL|macro|TEMP_TO_REG
mdefine_line|#define TEMP_TO_REG(val)&t;&t;(((val) &lt; 0 ? ((val - 500) / 1000) : &bslash;&n;&t;&t;&t;&t;&t;((val + 500) / 1000)))
DECL|macro|TEMP_FROM_REG
mdefine_line|#define TEMP_FROM_REG(val)&t;&t;((val) * 1000)
DECL|macro|TEMP_FROM_REG_EXT
mdefine_line|#define TEMP_FROM_REG_EXT(val, ext)&t;(TEMP_FROM_REG(val) + (ext) * 125)
DECL|macro|FAN_FROM_REG
mdefine_line|#define FAN_FROM_REG(reg, div)&t;&t;((reg) ? (11250 * 60) / ((reg) * (div)) : 0)
DECL|function|FAN_TO_REG
r_static
r_int
id|FAN_TO_REG
c_func
(paren
r_int
id|reg
comma
r_int
id|div
)paren
(brace
r_int
id|tmp
suffix:semicolon
id|tmp
op_assign
id|FAN_FROM_REG
c_func
(paren
id|SENSORS_LIMIT
c_func
(paren
id|reg
comma
l_int|0
comma
l_int|65535
)paren
comma
id|div
)paren
suffix:semicolon
r_return
id|tmp
OG
l_int|255
ques
c_cond
l_int|255
suffix:colon
id|tmp
suffix:semicolon
)brace
DECL|macro|FAN_DIV_FROM_REG
mdefine_line|#define FAN_DIV_FROM_REG(reg)&t;&t;(1&lt;&lt;(((reg)&amp;0xc0)&gt;&gt;6))
DECL|macro|PWM_TO_REG
mdefine_line|#define PWM_TO_REG(val)&t;&t;&t;(SENSORS_LIMIT((val), 0, 255) &gt;&gt; 4)
DECL|macro|PWM_FROM_REG
mdefine_line|#define PWM_FROM_REG(val)&t;&t;((val) &lt;&lt; 4)
DECL|macro|FAN_CHAN_FROM_REG
mdefine_line|#define FAN_CHAN_FROM_REG(reg)&t;&t;(((reg) &gt;&gt; 5) &amp; 7)
DECL|macro|FAN_CHAN_TO_REG
mdefine_line|#define FAN_CHAN_TO_REG(val, reg)&t;&bslash;&n;&t;(((reg) &amp; 0x1F) | (((val) &lt;&lt; 5) &amp; 0xe0))
DECL|macro|AUTO_TEMP_MIN_TO_REG
mdefine_line|#define AUTO_TEMP_MIN_TO_REG(val, reg)&t;&bslash;&n;&t;((((val)/500) &amp; 0xf8)|((reg) &amp; 0x7))
DECL|macro|AUTO_TEMP_RANGE_FROM_REG
mdefine_line|#define AUTO_TEMP_RANGE_FROM_REG(reg)&t;(5000 * (1&lt;&lt; ((reg)&amp;0x7)))
DECL|macro|AUTO_TEMP_MIN_FROM_REG
mdefine_line|#define AUTO_TEMP_MIN_FROM_REG(reg)&t;(1000 * ((((reg) &gt;&gt; 3) &amp; 0x1f) &lt;&lt; 2))
DECL|macro|AUTO_TEMP_MIN_FROM_REG_DEG
mdefine_line|#define AUTO_TEMP_MIN_FROM_REG_DEG(reg)&t;((((reg) &gt;&gt; 3) &amp; 0x1f) &lt;&lt; 2)
DECL|macro|AUTO_TEMP_OFF_FROM_REG
mdefine_line|#define AUTO_TEMP_OFF_FROM_REG(reg)&t;&t;&bslash;&n;&t;(AUTO_TEMP_MIN_FROM_REG(reg) - 5000)
DECL|macro|AUTO_TEMP_MAX_FROM_REG
mdefine_line|#define AUTO_TEMP_MAX_FROM_REG(reg)&t;&t;&bslash;&n;&t;(AUTO_TEMP_RANGE_FROM_REG(reg) +&t;&bslash;&n;&t;AUTO_TEMP_MIN_FROM_REG(reg))
DECL|function|AUTO_TEMP_MAX_TO_REG
r_static
r_int
id|AUTO_TEMP_MAX_TO_REG
c_func
(paren
r_int
id|val
comma
r_int
id|reg
comma
r_int
id|pwm
)paren
(brace
r_int
id|ret
suffix:semicolon
r_int
id|range
op_assign
id|val
op_minus
id|AUTO_TEMP_MIN_FROM_REG
c_func
(paren
id|reg
)paren
suffix:semicolon
id|range
op_assign
(paren
(paren
id|val
op_minus
id|AUTO_TEMP_MIN_FROM_REG
c_func
(paren
id|reg
)paren
)paren
op_star
l_int|10
)paren
op_div
(paren
l_int|16
op_minus
id|pwm
)paren
suffix:semicolon
id|ret
op_assign
(paren
(paren
id|reg
op_amp
l_int|0xf8
)paren
op_or
(paren
id|range
OL
l_int|10000
ques
c_cond
l_int|0
suffix:colon
id|range
OL
l_int|20000
ques
c_cond
l_int|1
suffix:colon
id|range
OL
l_int|40000
ques
c_cond
l_int|2
suffix:colon
id|range
OL
l_int|80000
ques
c_cond
l_int|3
suffix:colon
l_int|4
)paren
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* FAN auto control */
DECL|macro|GET_FAN_AUTO_BITFIELD
mdefine_line|#define GET_FAN_AUTO_BITFIELD(data, idx)&t;&bslash;&n;&t;(*(data)-&gt;chan_select_table)[FAN_CHAN_FROM_REG((data)-&gt;conf1)][idx%2]
multiline_comment|/* The tables below contains the possible values for the auto fan &n; * control bitfields. the index in the table is the register value.&n; * MSb is the auto fan control enable bit, so the four first entries&n; * in the table disables auto fan control when both bitfields are zero.&n; */
DECL|variable|auto_channel_select_table_adm1031
r_static
id|auto_chan_table_t
id|auto_channel_select_table_adm1031
op_assign
(brace
(brace
l_int|0
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|0
)brace
comma
(brace
l_int|2
multiline_comment|/*0b010 */
comma
l_int|4
multiline_comment|/*0b100 */
)brace
comma
(brace
l_int|2
multiline_comment|/*0b010 */
comma
l_int|2
multiline_comment|/*0b010 */
)brace
comma
(brace
l_int|4
multiline_comment|/*0b100 */
comma
l_int|4
multiline_comment|/*0b100 */
)brace
comma
(brace
l_int|7
multiline_comment|/*0b111 */
comma
l_int|7
multiline_comment|/*0b111 */
)brace
comma
)brace
suffix:semicolon
DECL|variable|auto_channel_select_table_adm1030
r_static
id|auto_chan_table_t
id|auto_channel_select_table_adm1030
op_assign
(brace
(brace
l_int|0
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|0
)brace
comma
(brace
l_int|2
multiline_comment|/*0b10 */
comma
l_int|0
)brace
comma
(brace
l_int|0xff
multiline_comment|/*invalid */
comma
l_int|0
)brace
comma
(brace
l_int|0xff
multiline_comment|/*invalid */
comma
l_int|0
)brace
comma
(brace
l_int|3
multiline_comment|/*0b11 */
comma
l_int|0
)brace
comma
)brace
suffix:semicolon
multiline_comment|/* That function checks if a bitfield is valid and returns the other bitfield&n; * nearest match if no exact match where found.&n; */
r_static
r_int
DECL|function|get_fan_auto_nearest
id|get_fan_auto_nearest
c_func
(paren
r_struct
id|adm1031_data
op_star
id|data
comma
r_int
id|chan
comma
id|u8
id|val
comma
id|u8
id|reg
comma
id|u8
op_star
id|new_reg
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|first_match
op_assign
op_minus
l_int|1
comma
id|exact_match
op_assign
op_minus
l_int|1
suffix:semicolon
id|u8
id|other_reg_val
op_assign
(paren
op_star
id|data-&gt;chan_select_table
)paren
(braket
id|FAN_CHAN_FROM_REG
c_func
(paren
id|reg
)paren
)braket
(braket
id|chan
ques
c_cond
l_int|0
suffix:colon
l_int|1
)braket
suffix:semicolon
r_if
c_cond
(paren
id|val
op_eq
l_int|0
)paren
(brace
op_star
id|new_reg
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|val
op_eq
(paren
op_star
id|data-&gt;chan_select_table
)paren
(braket
id|i
)braket
(braket
id|chan
)braket
)paren
op_logical_and
(paren
(paren
op_star
id|data-&gt;chan_select_table
)paren
(braket
id|i
)braket
(braket
id|chan
ques
c_cond
l_int|0
suffix:colon
l_int|1
)braket
op_eq
id|other_reg_val
)paren
)paren
(brace
multiline_comment|/* We found an exact match */
id|exact_match
op_assign
id|i
suffix:semicolon
r_break
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|val
op_eq
(paren
op_star
id|data-&gt;chan_select_table
)paren
(braket
id|i
)braket
(braket
id|chan
)braket
op_logical_and
id|first_match
op_eq
op_minus
l_int|1
)paren
(brace
multiline_comment|/* Save the first match in case of an exact match has not been&n;&t;&t;&t; * found &n;&t;&t;&t; */
id|first_match
op_assign
id|i
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|exact_match
op_ge
l_int|0
)paren
(brace
op_star
id|new_reg
op_assign
id|exact_match
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|first_match
op_ge
l_int|0
)paren
(brace
op_star
id|new_reg
op_assign
id|first_match
suffix:semicolon
)brace
r_else
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|show_fan_auto_channel
r_static
id|ssize_t
id|show_fan_auto_channel
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
comma
r_int
id|nr
)paren
(brace
r_struct
id|adm1031_data
op_star
id|data
op_assign
id|adm1031_update_device
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%d&bslash;n&quot;
comma
id|GET_FAN_AUTO_BITFIELD
c_func
(paren
id|data
comma
id|nr
)paren
)paren
suffix:semicolon
)brace
r_static
id|ssize_t
DECL|function|set_fan_auto_channel
id|set_fan_auto_channel
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
comma
r_int
id|nr
)paren
(brace
r_struct
id|i2c_client
op_star
id|client
op_assign
id|to_i2c_client
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|adm1031_data
op_star
id|data
op_assign
id|i2c_get_clientdata
c_func
(paren
id|client
)paren
suffix:semicolon
r_int
id|val
suffix:semicolon
id|u8
id|reg
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|u8
id|old_fan_mode
suffix:semicolon
id|old_fan_mode
op_assign
id|data-&gt;conf1
suffix:semicolon
id|down
c_func
(paren
op_amp
id|data-&gt;update_lock
)paren
suffix:semicolon
id|val
op_assign
id|simple_strtol
c_func
(paren
id|buf
comma
l_int|NULL
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|get_fan_auto_nearest
c_func
(paren
id|data
comma
id|nr
comma
id|val
comma
id|data-&gt;conf1
comma
op_amp
id|reg
)paren
)paren
)paren
(brace
id|up
c_func
(paren
op_amp
id|data-&gt;update_lock
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
(paren
id|data-&gt;conf1
op_assign
id|FAN_CHAN_TO_REG
c_func
(paren
id|reg
comma
id|data-&gt;conf1
)paren
)paren
op_amp
id|ADM1031_CONF1_AUTO_MODE
)paren
op_xor
(paren
id|old_fan_mode
op_amp
id|ADM1031_CONF1_AUTO_MODE
)paren
)paren
(brace
r_if
c_cond
(paren
id|data-&gt;conf1
op_amp
id|ADM1031_CONF1_AUTO_MODE
)paren
(brace
multiline_comment|/* Switch to Auto Fan Mode &n;&t;&t;&t; * Save PWM registers &n;&t;&t;&t; * Set PWM registers to 33% Both */
id|data-&gt;old_pwm
(braket
l_int|0
)braket
op_assign
id|data-&gt;pwm
(braket
l_int|0
)braket
suffix:semicolon
id|data-&gt;old_pwm
(braket
l_int|1
)braket
op_assign
id|data-&gt;pwm
(braket
l_int|1
)braket
suffix:semicolon
id|adm1031_write_value
c_func
(paren
id|client
comma
id|ADM1031_REG_PWM
comma
l_int|0x55
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Switch to Manual Mode */
id|data-&gt;pwm
(braket
l_int|0
)braket
op_assign
id|data-&gt;old_pwm
(braket
l_int|0
)braket
suffix:semicolon
id|data-&gt;pwm
(braket
l_int|1
)braket
op_assign
id|data-&gt;old_pwm
(braket
l_int|1
)braket
suffix:semicolon
multiline_comment|/* Restore PWM registers */
id|adm1031_write_value
c_func
(paren
id|client
comma
id|ADM1031_REG_PWM
comma
id|data-&gt;pwm
(braket
l_int|0
)braket
op_or
(paren
id|data-&gt;pwm
(braket
l_int|1
)braket
op_lshift
l_int|4
)paren
)paren
suffix:semicolon
)brace
)brace
id|data-&gt;conf1
op_assign
id|FAN_CHAN_TO_REG
c_func
(paren
id|reg
comma
id|data-&gt;conf1
)paren
suffix:semicolon
id|adm1031_write_value
c_func
(paren
id|client
comma
id|ADM1031_REG_CONF1
comma
id|data-&gt;conf1
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|data-&gt;update_lock
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
DECL|macro|fan_auto_channel_offset
mdefine_line|#define fan_auto_channel_offset(offset)&t;&t;&t;&t;&t;&t;&bslash;&n;static ssize_t show_fan_auto_channel_##offset (struct device *dev, char *buf)&t;&bslash;&n;{&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;return show_fan_auto_channel(dev, buf, offset - 1);&t;&t;&t;&bslash;&n;}&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;static ssize_t set_fan_auto_channel_##offset (struct device *dev,&t;&t;&bslash;&n;&t;const char *buf, size_t count)&t;&t;&t;&t;&t;&t;&bslash;&n;{&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;return set_fan_auto_channel(dev, buf, count, offset - 1);&t;&t;&bslash;&n;}&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;static DEVICE_ATTR(auto_fan##offset##_channel, S_IRUGO | S_IWUSR,&t;&t;&bslash;&n;&t;&t;   show_fan_auto_channel_##offset,&t;&t;&t;&t;&bslash;&n;&t;&t;   set_fan_auto_channel_##offset)
id|fan_auto_channel_offset
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|fan_auto_channel_offset
c_func
(paren
l_int|2
)paren
suffix:semicolon
multiline_comment|/* Auto Temps */
DECL|function|show_auto_temp_off
r_static
id|ssize_t
id|show_auto_temp_off
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
comma
r_int
id|nr
)paren
(brace
r_struct
id|adm1031_data
op_star
id|data
op_assign
id|adm1031_update_device
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%d&bslash;n&quot;
comma
id|AUTO_TEMP_OFF_FROM_REG
c_func
(paren
id|data-&gt;auto_temp
(braket
id|nr
)braket
)paren
)paren
suffix:semicolon
)brace
DECL|function|show_auto_temp_min
r_static
id|ssize_t
id|show_auto_temp_min
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
comma
r_int
id|nr
)paren
(brace
r_struct
id|adm1031_data
op_star
id|data
op_assign
id|adm1031_update_device
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%d&bslash;n&quot;
comma
id|AUTO_TEMP_MIN_FROM_REG
c_func
(paren
id|data-&gt;auto_temp
(braket
id|nr
)braket
)paren
)paren
suffix:semicolon
)brace
r_static
id|ssize_t
DECL|function|set_auto_temp_min
id|set_auto_temp_min
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
comma
r_int
id|nr
)paren
(brace
r_struct
id|i2c_client
op_star
id|client
op_assign
id|to_i2c_client
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|adm1031_data
op_star
id|data
op_assign
id|i2c_get_clientdata
c_func
(paren
id|client
)paren
suffix:semicolon
r_int
id|val
suffix:semicolon
id|down
c_func
(paren
op_amp
id|data-&gt;update_lock
)paren
suffix:semicolon
id|val
op_assign
id|simple_strtol
c_func
(paren
id|buf
comma
l_int|NULL
comma
l_int|10
)paren
suffix:semicolon
id|data-&gt;auto_temp
(braket
id|nr
)braket
op_assign
id|AUTO_TEMP_MIN_TO_REG
c_func
(paren
id|val
comma
id|data-&gt;auto_temp
(braket
id|nr
)braket
)paren
suffix:semicolon
id|adm1031_write_value
c_func
(paren
id|client
comma
id|ADM1031_REG_AUTO_TEMP
c_func
(paren
id|nr
)paren
comma
id|data-&gt;auto_temp
(braket
id|nr
)braket
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|data-&gt;update_lock
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
DECL|function|show_auto_temp_max
r_static
id|ssize_t
id|show_auto_temp_max
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
comma
r_int
id|nr
)paren
(brace
r_struct
id|adm1031_data
op_star
id|data
op_assign
id|adm1031_update_device
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%d&bslash;n&quot;
comma
id|AUTO_TEMP_MAX_FROM_REG
c_func
(paren
id|data-&gt;auto_temp
(braket
id|nr
)braket
)paren
)paren
suffix:semicolon
)brace
r_static
id|ssize_t
DECL|function|set_auto_temp_max
id|set_auto_temp_max
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
comma
r_int
id|nr
)paren
(brace
r_struct
id|i2c_client
op_star
id|client
op_assign
id|to_i2c_client
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|adm1031_data
op_star
id|data
op_assign
id|i2c_get_clientdata
c_func
(paren
id|client
)paren
suffix:semicolon
r_int
id|val
suffix:semicolon
id|down
c_func
(paren
op_amp
id|data-&gt;update_lock
)paren
suffix:semicolon
id|val
op_assign
id|simple_strtol
c_func
(paren
id|buf
comma
l_int|NULL
comma
l_int|10
)paren
suffix:semicolon
id|data-&gt;temp_max
(braket
id|nr
)braket
op_assign
id|AUTO_TEMP_MAX_TO_REG
c_func
(paren
id|val
comma
id|data-&gt;auto_temp
(braket
id|nr
)braket
comma
id|data-&gt;pwm
(braket
id|nr
)braket
)paren
suffix:semicolon
id|adm1031_write_value
c_func
(paren
id|client
comma
id|ADM1031_REG_AUTO_TEMP
c_func
(paren
id|nr
)paren
comma
id|data-&gt;temp_max
(braket
id|nr
)braket
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|data-&gt;update_lock
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
DECL|macro|auto_temp_reg
mdefine_line|#define auto_temp_reg(offset)&t;&t;&t;&t;&t;&t;&t;&bslash;&n;static ssize_t show_auto_temp_##offset##_off (struct device *dev, char *buf)&t;&bslash;&n;{&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;return show_auto_temp_off(dev, buf, offset - 1);&t;&t;&t;&bslash;&n;}&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;static ssize_t show_auto_temp_##offset##_min (struct device *dev, char *buf)&t;&bslash;&n;{&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;return show_auto_temp_min(dev, buf, offset - 1);&t;&t;&t;&bslash;&n;}&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;static ssize_t show_auto_temp_##offset##_max (struct device *dev, char *buf)&t;&bslash;&n;{&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;return show_auto_temp_max(dev, buf, offset - 1);&t;&t;&t;&bslash;&n;}&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;static ssize_t set_auto_temp_##offset##_min (struct device *dev,&t;&t;&bslash;&n;&t;&t;&t;&t;&t;     const char *buf, size_t count)&t;&bslash;&n;{&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;return set_auto_temp_min(dev, buf, count, offset - 1);&t;&t;&bslash;&n;}&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;static ssize_t set_auto_temp_##offset##_max (struct device *dev,&t;&t;&bslash;&n;&t;&t;&t;&t;&t;     const char *buf, size_t count)&t;&bslash;&n;{&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;return set_auto_temp_max(dev, buf, count, offset - 1);&t;&t;&bslash;&n;}&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;static DEVICE_ATTR(auto_temp##offset##_off, S_IRUGO,&t;&t;&t;&t;&bslash;&n;&t;&t;   show_auto_temp_##offset##_off, NULL);&t;&t;&t;&bslash;&n;static DEVICE_ATTR(auto_temp##offset##_min, S_IRUGO | S_IWUSR,&t;&t;&t;&bslash;&n;&t;&t;   show_auto_temp_##offset##_min, set_auto_temp_##offset##_min);&bslash;&n;static DEVICE_ATTR(auto_temp##offset##_max, S_IRUGO | S_IWUSR,&t;&t;&t;&bslash;&n;&t;&t;   show_auto_temp_##offset##_max, set_auto_temp_##offset##_max)
id|auto_temp_reg
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|auto_temp_reg
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|auto_temp_reg
c_func
(paren
l_int|3
)paren
suffix:semicolon
multiline_comment|/* pwm */
DECL|function|show_pwm
r_static
id|ssize_t
id|show_pwm
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
comma
r_int
id|nr
)paren
(brace
r_struct
id|adm1031_data
op_star
id|data
op_assign
id|adm1031_update_device
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%d&bslash;n&quot;
comma
id|PWM_FROM_REG
c_func
(paren
id|data-&gt;pwm
(braket
id|nr
)braket
)paren
)paren
suffix:semicolon
)brace
r_static
id|ssize_t
DECL|function|set_pwm
id|set_pwm
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
comma
r_int
id|nr
)paren
(brace
r_struct
id|i2c_client
op_star
id|client
op_assign
id|to_i2c_client
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|adm1031_data
op_star
id|data
op_assign
id|i2c_get_clientdata
c_func
(paren
id|client
)paren
suffix:semicolon
r_int
id|val
suffix:semicolon
r_int
id|reg
suffix:semicolon
id|down
c_func
(paren
op_amp
id|data-&gt;update_lock
)paren
suffix:semicolon
id|val
op_assign
id|simple_strtol
c_func
(paren
id|buf
comma
l_int|NULL
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|data-&gt;conf1
op_amp
id|ADM1031_CONF1_AUTO_MODE
)paren
op_logical_and
(paren
(paren
(paren
id|val
op_rshift
l_int|4
)paren
op_amp
l_int|0xf
)paren
op_ne
l_int|5
)paren
)paren
(brace
multiline_comment|/* In automatic mode, the only PWM accepted is 33% */
id|up
c_func
(paren
op_amp
id|data-&gt;update_lock
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|data-&gt;pwm
(braket
id|nr
)braket
op_assign
id|PWM_TO_REG
c_func
(paren
id|val
)paren
suffix:semicolon
id|reg
op_assign
id|adm1031_read_value
c_func
(paren
id|client
comma
id|ADM1031_REG_PWM
)paren
suffix:semicolon
id|adm1031_write_value
c_func
(paren
id|client
comma
id|ADM1031_REG_PWM
comma
id|nr
ques
c_cond
(paren
(paren
id|data-&gt;pwm
(braket
id|nr
)braket
op_lshift
l_int|4
)paren
op_amp
l_int|0xf0
)paren
op_or
(paren
id|reg
op_amp
l_int|0xf
)paren
suffix:colon
(paren
id|data-&gt;pwm
(braket
id|nr
)braket
op_amp
l_int|0xf
)paren
op_or
(paren
id|reg
op_amp
l_int|0xf0
)paren
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|data-&gt;update_lock
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
DECL|macro|pwm_reg
mdefine_line|#define pwm_reg(offset)&t;&t;&t;&t;&t;&t;&t;&bslash;&n;static ssize_t show_pwm_##offset (struct device *dev, char *buf)&t;&bslash;&n;{&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;return show_pwm(dev, buf, offset - 1);&t;&t;&t;&bslash;&n;}&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;static ssize_t set_pwm_##offset (struct device *dev,&t;&t;&t;&bslash;&n;&t;&t;&t;&t; const char *buf, size_t count)&t;&t;&bslash;&n;{&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;return set_pwm(dev, buf, count, offset - 1);&t;&t;&bslash;&n;}&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;static DEVICE_ATTR(pwm##offset, S_IRUGO | S_IWUSR,&t;&t;&t;&bslash;&n;&t;&t;   show_pwm_##offset, set_pwm_##offset)
id|pwm_reg
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|pwm_reg
c_func
(paren
l_int|2
)paren
suffix:semicolon
multiline_comment|/* Fans */
multiline_comment|/*&n; * That function checks the cases where the fan reading is not&n; * relevent.  It is used to provide 0 as fan reading when the fan is&n; * not supposed to run&n; */
DECL|function|trust_fan_readings
r_static
r_int
id|trust_fan_readings
c_func
(paren
r_struct
id|adm1031_data
op_star
id|data
comma
r_int
id|chan
)paren
(brace
r_int
id|res
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|data-&gt;conf1
op_amp
id|ADM1031_CONF1_AUTO_MODE
)paren
(brace
r_switch
c_cond
(paren
id|data-&gt;conf1
op_amp
l_int|0x60
)paren
(brace
r_case
l_int|0x00
suffix:colon
multiline_comment|/* remote temp1 controls fan1 remote temp2 controls fan2 */
id|res
op_assign
id|data-&gt;temp
(braket
id|chan
op_plus
l_int|1
)braket
op_ge
id|AUTO_TEMP_MIN_FROM_REG_DEG
c_func
(paren
id|data-&gt;auto_temp
(braket
id|chan
op_plus
l_int|1
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x20
suffix:colon
multiline_comment|/* remote temp1 controls both fans */
id|res
op_assign
id|data-&gt;temp
(braket
l_int|1
)braket
op_ge
id|AUTO_TEMP_MIN_FROM_REG_DEG
c_func
(paren
id|data-&gt;auto_temp
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x40
suffix:colon
multiline_comment|/* remote temp2 controls both fans */
id|res
op_assign
id|data-&gt;temp
(braket
l_int|2
)braket
op_ge
id|AUTO_TEMP_MIN_FROM_REG_DEG
c_func
(paren
id|data-&gt;auto_temp
(braket
l_int|2
)braket
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x60
suffix:colon
multiline_comment|/* max controls both fans */
id|res
op_assign
id|data-&gt;temp
(braket
l_int|0
)braket
op_ge
id|AUTO_TEMP_MIN_FROM_REG_DEG
c_func
(paren
id|data-&gt;auto_temp
(braket
l_int|0
)braket
)paren
op_logical_or
id|data-&gt;temp
(braket
l_int|1
)braket
op_ge
id|AUTO_TEMP_MIN_FROM_REG_DEG
c_func
(paren
id|data-&gt;auto_temp
(braket
l_int|1
)braket
)paren
op_logical_or
(paren
id|data-&gt;chip_type
op_eq
id|adm1031
op_logical_and
id|data-&gt;temp
(braket
l_int|2
)braket
op_ge
id|AUTO_TEMP_MIN_FROM_REG_DEG
c_func
(paren
id|data-&gt;auto_temp
(braket
l_int|2
)braket
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_else
(brace
id|res
op_assign
id|data-&gt;pwm
(braket
id|chan
)braket
OG
l_int|0
suffix:semicolon
)brace
r_return
id|res
suffix:semicolon
)brace
DECL|function|show_fan
r_static
id|ssize_t
id|show_fan
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
comma
r_int
id|nr
)paren
(brace
r_struct
id|adm1031_data
op_star
id|data
op_assign
id|adm1031_update_device
c_func
(paren
id|dev
)paren
suffix:semicolon
r_int
id|value
suffix:semicolon
id|value
op_assign
id|trust_fan_readings
c_func
(paren
id|data
comma
id|nr
)paren
ques
c_cond
id|FAN_FROM_REG
c_func
(paren
id|data-&gt;fan
(braket
id|nr
)braket
comma
id|FAN_DIV_FROM_REG
c_func
(paren
id|data-&gt;fan_div
(braket
id|nr
)braket
)paren
)paren
suffix:colon
l_int|0
suffix:semicolon
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%d&bslash;n&quot;
comma
id|value
)paren
suffix:semicolon
)brace
DECL|function|show_fan_div
r_static
id|ssize_t
id|show_fan_div
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
comma
r_int
id|nr
)paren
(brace
r_struct
id|adm1031_data
op_star
id|data
op_assign
id|adm1031_update_device
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%d&bslash;n&quot;
comma
id|FAN_DIV_FROM_REG
c_func
(paren
id|data-&gt;fan_div
(braket
id|nr
)braket
)paren
)paren
suffix:semicolon
)brace
DECL|function|show_fan_min
r_static
id|ssize_t
id|show_fan_min
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
comma
r_int
id|nr
)paren
(brace
r_struct
id|adm1031_data
op_star
id|data
op_assign
id|adm1031_update_device
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%d&bslash;n&quot;
comma
id|FAN_FROM_REG
c_func
(paren
id|data-&gt;fan_min
(braket
id|nr
)braket
comma
id|FAN_DIV_FROM_REG
c_func
(paren
id|data-&gt;fan_div
(braket
id|nr
)braket
)paren
)paren
)paren
suffix:semicolon
)brace
r_static
id|ssize_t
DECL|function|set_fan_min
id|set_fan_min
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
comma
r_int
id|nr
)paren
(brace
r_struct
id|i2c_client
op_star
id|client
op_assign
id|to_i2c_client
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|adm1031_data
op_star
id|data
op_assign
id|i2c_get_clientdata
c_func
(paren
id|client
)paren
suffix:semicolon
r_int
id|val
suffix:semicolon
id|down
c_func
(paren
op_amp
id|data-&gt;update_lock
)paren
suffix:semicolon
id|val
op_assign
id|simple_strtol
c_func
(paren
id|buf
comma
l_int|NULL
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val
)paren
(brace
id|data-&gt;fan_min
(braket
id|nr
)braket
op_assign
id|FAN_TO_REG
c_func
(paren
id|val
comma
id|FAN_DIV_FROM_REG
c_func
(paren
id|data-&gt;fan_div
(braket
id|nr
)braket
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|data-&gt;fan_min
(braket
id|nr
)braket
op_assign
l_int|0xff
suffix:semicolon
)brace
id|adm1031_write_value
c_func
(paren
id|client
comma
id|ADM1031_REG_FAN_MIN
c_func
(paren
id|nr
)paren
comma
id|data-&gt;fan_min
(braket
id|nr
)braket
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|data-&gt;update_lock
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
r_static
id|ssize_t
DECL|function|set_fan_div
id|set_fan_div
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
comma
r_int
id|nr
)paren
(brace
r_struct
id|i2c_client
op_star
id|client
op_assign
id|to_i2c_client
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|adm1031_data
op_star
id|data
op_assign
id|i2c_get_clientdata
c_func
(paren
id|client
)paren
suffix:semicolon
r_int
id|val
suffix:semicolon
id|u8
id|tmp
suffix:semicolon
r_int
id|old_div
op_assign
id|FAN_DIV_FROM_REG
c_func
(paren
id|data-&gt;fan_div
(braket
id|nr
)braket
)paren
suffix:semicolon
r_int
id|new_min
suffix:semicolon
id|val
op_assign
id|simple_strtol
c_func
(paren
id|buf
comma
l_int|NULL
comma
l_int|10
)paren
suffix:semicolon
id|tmp
op_assign
id|val
op_eq
l_int|8
ques
c_cond
l_int|0xc0
suffix:colon
id|val
op_eq
l_int|4
ques
c_cond
l_int|0x80
suffix:colon
id|val
op_eq
l_int|2
ques
c_cond
l_int|0x40
suffix:colon
id|val
op_eq
l_int|1
ques
c_cond
l_int|0x00
suffix:colon
l_int|0xff
suffix:semicolon
r_if
c_cond
(paren
id|tmp
op_eq
l_int|0xff
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|down
c_func
(paren
op_amp
id|data-&gt;update_lock
)paren
suffix:semicolon
id|data-&gt;fan_div
(braket
id|nr
)braket
op_assign
(paren
id|tmp
op_amp
l_int|0xC0
)paren
op_or
(paren
l_int|0x3f
op_amp
id|data-&gt;fan_div
(braket
id|nr
)braket
)paren
suffix:semicolon
id|new_min
op_assign
id|data-&gt;fan_min
(braket
id|nr
)braket
op_star
id|old_div
op_div
id|FAN_DIV_FROM_REG
c_func
(paren
id|data-&gt;fan_div
(braket
id|nr
)braket
)paren
suffix:semicolon
id|data-&gt;fan_min
(braket
id|nr
)braket
op_assign
id|new_min
OG
l_int|0xff
ques
c_cond
l_int|0xff
suffix:colon
id|new_min
suffix:semicolon
id|data-&gt;fan
(braket
id|nr
)braket
op_assign
id|data-&gt;fan
(braket
id|nr
)braket
op_star
id|old_div
op_div
id|FAN_DIV_FROM_REG
c_func
(paren
id|data-&gt;fan_div
(braket
id|nr
)braket
)paren
suffix:semicolon
id|adm1031_write_value
c_func
(paren
id|client
comma
id|ADM1031_REG_FAN_DIV
c_func
(paren
id|nr
)paren
comma
id|data-&gt;fan_div
(braket
id|nr
)braket
)paren
suffix:semicolon
id|adm1031_write_value
c_func
(paren
id|client
comma
id|ADM1031_REG_FAN_MIN
c_func
(paren
id|nr
)paren
comma
id|data-&gt;fan_min
(braket
id|nr
)braket
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|data-&gt;update_lock
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
DECL|macro|fan_offset
mdefine_line|#define fan_offset(offset)&t;&t;&t;&t;&t;&t;&bslash;&n;static ssize_t show_fan_##offset (struct device *dev, char *buf)&t;&bslash;&n;{&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;return show_fan(dev, buf, offset - 1);&t;&t;&t;&bslash;&n;}&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;static ssize_t show_fan_##offset##_min (struct device *dev, char *buf)&t;&bslash;&n;{&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;return show_fan_min(dev, buf, offset - 1);&t;&t;&t;&bslash;&n;}&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;static ssize_t show_fan_##offset##_div (struct device *dev, char *buf)&t;&bslash;&n;{&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;return show_fan_div(dev, buf, offset - 1);&t;&t;&t;&bslash;&n;}&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;static ssize_t set_fan_##offset##_min (struct device *dev,&t;&t;&bslash;&n;&t;const char *buf, size_t count)&t;&t;&t;&t;&t;&bslash;&n;{&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;return set_fan_min(dev, buf, count, offset - 1);&t;&t;&bslash;&n;}&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;static ssize_t set_fan_##offset##_div (struct device *dev,&t;&t;&bslash;&n;&t;const char *buf, size_t count)&t;&t;&t;&t;&t;&bslash;&n;{&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;return set_fan_div(dev, buf, count, offset - 1);&t;&t;&bslash;&n;}&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;static DEVICE_ATTR(fan##offset##_input, S_IRUGO, show_fan_##offset,&t;&bslash;&n;&t;&t;   NULL);&t;&t;&t;&t;&t;&t;&bslash;&n;static DEVICE_ATTR(fan##offset##_min, S_IRUGO | S_IWUSR,&t;&t;&bslash;&n;&t;&t;   show_fan_##offset##_min, set_fan_##offset##_min);&t;&bslash;&n;static DEVICE_ATTR(fan##offset##_div, S_IRUGO | S_IWUSR,&t;&t;&bslash;&n;&t;&t;   show_fan_##offset##_div, set_fan_##offset##_div);&t;&bslash;&n;static DEVICE_ATTR(auto_fan##offset##_min_pwm, S_IRUGO | S_IWUSR,&t;&bslash;&n;&t;&t;   show_pwm_##offset, set_pwm_##offset)
id|fan_offset
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|fan_offset
c_func
(paren
l_int|2
)paren
suffix:semicolon
multiline_comment|/* Temps */
DECL|function|show_temp
r_static
id|ssize_t
id|show_temp
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
comma
r_int
id|nr
)paren
(brace
r_struct
id|adm1031_data
op_star
id|data
op_assign
id|adm1031_update_device
c_func
(paren
id|dev
)paren
suffix:semicolon
r_int
id|ext
suffix:semicolon
id|ext
op_assign
id|nr
op_eq
l_int|0
ques
c_cond
(paren
(paren
id|data-&gt;ext_temp
(braket
id|nr
)braket
op_rshift
l_int|6
)paren
op_amp
l_int|0x3
)paren
op_star
l_int|2
suffix:colon
(paren
(paren
(paren
id|data-&gt;ext_temp
(braket
id|nr
)braket
op_rshift
(paren
(paren
id|nr
op_minus
l_int|1
)paren
op_star
l_int|3
)paren
)paren
op_amp
l_int|7
)paren
)paren
suffix:semicolon
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%d&bslash;n&quot;
comma
id|TEMP_FROM_REG_EXT
c_func
(paren
id|data-&gt;temp
(braket
id|nr
)braket
comma
id|ext
)paren
)paren
suffix:semicolon
)brace
DECL|function|show_temp_min
r_static
id|ssize_t
id|show_temp_min
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
comma
r_int
id|nr
)paren
(brace
r_struct
id|adm1031_data
op_star
id|data
op_assign
id|adm1031_update_device
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%d&bslash;n&quot;
comma
id|TEMP_FROM_REG
c_func
(paren
id|data-&gt;temp_min
(braket
id|nr
)braket
)paren
)paren
suffix:semicolon
)brace
DECL|function|show_temp_max
r_static
id|ssize_t
id|show_temp_max
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
comma
r_int
id|nr
)paren
(brace
r_struct
id|adm1031_data
op_star
id|data
op_assign
id|adm1031_update_device
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%d&bslash;n&quot;
comma
id|TEMP_FROM_REG
c_func
(paren
id|data-&gt;temp_max
(braket
id|nr
)braket
)paren
)paren
suffix:semicolon
)brace
DECL|function|show_temp_crit
r_static
id|ssize_t
id|show_temp_crit
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
comma
r_int
id|nr
)paren
(brace
r_struct
id|adm1031_data
op_star
id|data
op_assign
id|adm1031_update_device
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%d&bslash;n&quot;
comma
id|TEMP_FROM_REG
c_func
(paren
id|data-&gt;temp_crit
(braket
id|nr
)braket
)paren
)paren
suffix:semicolon
)brace
r_static
id|ssize_t
DECL|function|set_temp_min
id|set_temp_min
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
comma
r_int
id|nr
)paren
(brace
r_struct
id|i2c_client
op_star
id|client
op_assign
id|to_i2c_client
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|adm1031_data
op_star
id|data
op_assign
id|i2c_get_clientdata
c_func
(paren
id|client
)paren
suffix:semicolon
r_int
id|val
suffix:semicolon
id|val
op_assign
id|simple_strtol
c_func
(paren
id|buf
comma
l_int|NULL
comma
l_int|10
)paren
suffix:semicolon
id|val
op_assign
id|SENSORS_LIMIT
c_func
(paren
id|val
comma
op_minus
l_int|55000
comma
id|nr
op_eq
l_int|0
ques
c_cond
l_int|127750
suffix:colon
l_int|127875
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|data-&gt;update_lock
)paren
suffix:semicolon
id|data-&gt;temp_min
(braket
id|nr
)braket
op_assign
id|TEMP_TO_REG
c_func
(paren
id|val
)paren
suffix:semicolon
id|adm1031_write_value
c_func
(paren
id|client
comma
id|ADM1031_REG_TEMP_MIN
c_func
(paren
id|nr
)paren
comma
id|data-&gt;temp_min
(braket
id|nr
)braket
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|data-&gt;update_lock
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
r_static
id|ssize_t
DECL|function|set_temp_max
id|set_temp_max
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
comma
r_int
id|nr
)paren
(brace
r_struct
id|i2c_client
op_star
id|client
op_assign
id|to_i2c_client
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|adm1031_data
op_star
id|data
op_assign
id|i2c_get_clientdata
c_func
(paren
id|client
)paren
suffix:semicolon
r_int
id|val
suffix:semicolon
id|val
op_assign
id|simple_strtol
c_func
(paren
id|buf
comma
l_int|NULL
comma
l_int|10
)paren
suffix:semicolon
id|val
op_assign
id|SENSORS_LIMIT
c_func
(paren
id|val
comma
op_minus
l_int|55000
comma
id|nr
op_eq
l_int|0
ques
c_cond
l_int|127750
suffix:colon
l_int|127875
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|data-&gt;update_lock
)paren
suffix:semicolon
id|data-&gt;temp_max
(braket
id|nr
)braket
op_assign
id|TEMP_TO_REG
c_func
(paren
id|val
)paren
suffix:semicolon
id|adm1031_write_value
c_func
(paren
id|client
comma
id|ADM1031_REG_TEMP_MAX
c_func
(paren
id|nr
)paren
comma
id|data-&gt;temp_max
(braket
id|nr
)braket
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|data-&gt;update_lock
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
r_static
id|ssize_t
DECL|function|set_temp_crit
id|set_temp_crit
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
comma
r_int
id|nr
)paren
(brace
r_struct
id|i2c_client
op_star
id|client
op_assign
id|to_i2c_client
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|adm1031_data
op_star
id|data
op_assign
id|i2c_get_clientdata
c_func
(paren
id|client
)paren
suffix:semicolon
r_int
id|val
suffix:semicolon
id|val
op_assign
id|simple_strtol
c_func
(paren
id|buf
comma
l_int|NULL
comma
l_int|10
)paren
suffix:semicolon
id|val
op_assign
id|SENSORS_LIMIT
c_func
(paren
id|val
comma
op_minus
l_int|55000
comma
id|nr
op_eq
l_int|0
ques
c_cond
l_int|127750
suffix:colon
l_int|127875
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|data-&gt;update_lock
)paren
suffix:semicolon
id|data-&gt;temp_crit
(braket
id|nr
)braket
op_assign
id|TEMP_TO_REG
c_func
(paren
id|val
)paren
suffix:semicolon
id|adm1031_write_value
c_func
(paren
id|client
comma
id|ADM1031_REG_TEMP_CRIT
c_func
(paren
id|nr
)paren
comma
id|data-&gt;temp_crit
(braket
id|nr
)braket
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|data-&gt;update_lock
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
DECL|macro|temp_reg
mdefine_line|#define temp_reg(offset)&t;&t;&t;&t;&t;&t;&t;&bslash;&n;static ssize_t show_temp_##offset (struct device *dev, char *buf)&t;&t;&bslash;&n;{&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;return show_temp(dev, buf, offset - 1);&t;&t;&t;&t;&bslash;&n;}&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;static ssize_t show_temp_##offset##_min (struct device *dev, char *buf)&t;&t;&bslash;&n;{&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;return show_temp_min(dev, buf, offset - 1);&t;&t;&t;&t;&bslash;&n;}&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;static ssize_t show_temp_##offset##_max (struct device *dev, char *buf)&t;&t;&bslash;&n;{&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;return show_temp_max(dev, buf, offset - 1);&t;&t;&t;&t;&bslash;&n;}&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;static ssize_t show_temp_##offset##_crit (struct device *dev, char *buf)&t;&bslash;&n;{&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;return show_temp_crit(dev, buf, offset - 1);&t;&t;&t;&bslash;&n;}&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;static ssize_t set_temp_##offset##_min (struct device *dev,&t;&t;&t;&bslash;&n;&t;&t;&t;&t;&t;const char *buf, size_t count)&t;&t;&bslash;&n;{&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;return set_temp_min(dev, buf, count, offset - 1);&t;&t;&t;&bslash;&n;}&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;static ssize_t set_temp_##offset##_max (struct device *dev,&t;&t;&t;&bslash;&n;&t;&t;&t;&t;&t;const char *buf, size_t count)&t;&t;&bslash;&n;{&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;return set_temp_max(dev, buf, count, offset - 1);&t;&t;&t;&bslash;&n;}&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;static ssize_t set_temp_##offset##_crit (struct device *dev,&t;&t;&t;&bslash;&n;&t;&t;&t;&t;&t; const char *buf, size_t count)&t;&t;&bslash;&n;{&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;return set_temp_crit(dev, buf, count, offset - 1);&t;&t;&t;&bslash;&n;}&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;static DEVICE_ATTR(temp##offset##_input, S_IRUGO, show_temp_##offset,&t;&t;&bslash;&n;&t;&t;   NULL);&t;&t;&t;&t;&t;&t;&t;&bslash;&n;static DEVICE_ATTR(temp##offset##_min, S_IRUGO | S_IWUSR,&t;&t;&t;&bslash;&n;&t;&t;   show_temp_##offset##_min, set_temp_##offset##_min);&t;&t;&bslash;&n;static DEVICE_ATTR(temp##offset##_max, S_IRUGO | S_IWUSR,&t;&t;&t;&bslash;&n;&t;&t;   show_temp_##offset##_max, set_temp_##offset##_max);&t;&t;&bslash;&n;static DEVICE_ATTR(temp##offset##_crit, S_IRUGO | S_IWUSR,&t;&t;&t;&bslash;&n;&t;&t;   show_temp_##offset##_crit, set_temp_##offset##_crit)
id|temp_reg
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|temp_reg
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|temp_reg
c_func
(paren
l_int|3
)paren
suffix:semicolon
multiline_comment|/* Alarms */
DECL|function|show_alarms
r_static
id|ssize_t
id|show_alarms
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_char
op_star
id|buf
)paren
(brace
r_struct
id|adm1031_data
op_star
id|data
op_assign
id|adm1031_update_device
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%d&bslash;n&quot;
comma
id|data-&gt;alarm
)paren
suffix:semicolon
)brace
r_static
id|DEVICE_ATTR
c_func
(paren
id|alarms
comma
id|S_IRUGO
comma
id|show_alarms
comma
l_int|NULL
)paren
suffix:semicolon
DECL|function|adm1031_attach_adapter
r_static
r_int
id|adm1031_attach_adapter
c_func
(paren
r_struct
id|i2c_adapter
op_star
id|adapter
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|adapter
op_member_access_from_pointer
r_class
op_amp
id|I2C_CLASS_HWMON
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_return
id|i2c_detect
c_func
(paren
id|adapter
comma
op_amp
id|addr_data
comma
id|adm1031_detect
)paren
suffix:semicolon
)brace
multiline_comment|/* This function is called by i2c_detect */
DECL|function|adm1031_detect
r_static
r_int
id|adm1031_detect
c_func
(paren
r_struct
id|i2c_adapter
op_star
id|adapter
comma
r_int
id|address
comma
r_int
id|kind
)paren
(brace
r_struct
id|i2c_client
op_star
id|new_client
suffix:semicolon
r_struct
id|adm1031_data
op_star
id|data
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
r_const
r_char
op_star
id|name
op_assign
l_string|&quot;&quot;
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|i2c_check_functionality
c_func
(paren
id|adapter
comma
id|I2C_FUNC_SMBUS_BYTE_DATA
)paren
)paren
r_goto
m_exit
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|data
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|adm1031_data
)paren
comma
id|GFP_KERNEL
)paren
)paren
)paren
(brace
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
id|memset
c_func
(paren
id|data
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|adm1031_data
)paren
)paren
suffix:semicolon
id|new_client
op_assign
op_amp
id|data-&gt;client
suffix:semicolon
id|i2c_set_clientdata
c_func
(paren
id|new_client
comma
id|data
)paren
suffix:semicolon
id|new_client-&gt;addr
op_assign
id|address
suffix:semicolon
id|new_client-&gt;adapter
op_assign
id|adapter
suffix:semicolon
id|new_client-&gt;driver
op_assign
op_amp
id|adm1031_driver
suffix:semicolon
id|new_client-&gt;flags
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|kind
OL
l_int|0
)paren
(brace
r_int
id|id
comma
id|co
suffix:semicolon
id|id
op_assign
id|i2c_smbus_read_byte_data
c_func
(paren
id|new_client
comma
l_int|0x3d
)paren
suffix:semicolon
id|co
op_assign
id|i2c_smbus_read_byte_data
c_func
(paren
id|new_client
comma
l_int|0x3e
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
(paren
id|id
op_eq
l_int|0x31
op_logical_or
id|id
op_eq
l_int|0x30
)paren
op_logical_and
id|co
op_eq
l_int|0x41
)paren
)paren
r_goto
id|exit_free
suffix:semicolon
id|kind
op_assign
(paren
id|id
op_eq
l_int|0x30
)paren
ques
c_cond
id|adm1030
suffix:colon
id|adm1031
suffix:semicolon
)brace
r_if
c_cond
(paren
id|kind
op_le
l_int|0
)paren
id|kind
op_assign
id|adm1031
suffix:semicolon
multiline_comment|/* Given the detected chip type, set the chip name and the&n;&t; * auto fan control helper table. */
r_if
c_cond
(paren
id|kind
op_eq
id|adm1030
)paren
(brace
id|name
op_assign
l_string|&quot;adm1030&quot;
suffix:semicolon
id|data-&gt;chan_select_table
op_assign
op_amp
id|auto_channel_select_table_adm1030
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|kind
op_eq
id|adm1031
)paren
(brace
id|name
op_assign
l_string|&quot;adm1031&quot;
suffix:semicolon
id|data-&gt;chan_select_table
op_assign
op_amp
id|auto_channel_select_table_adm1031
suffix:semicolon
)brace
id|data-&gt;chip_type
op_assign
id|kind
suffix:semicolon
id|strlcpy
c_func
(paren
id|new_client-&gt;name
comma
id|name
comma
id|I2C_NAME_SIZE
)paren
suffix:semicolon
id|new_client-&gt;id
op_assign
id|adm1031_id
op_increment
suffix:semicolon
id|data-&gt;valid
op_assign
l_int|0
suffix:semicolon
id|init_MUTEX
c_func
(paren
op_amp
id|data-&gt;update_lock
)paren
suffix:semicolon
multiline_comment|/* Tell the I2C layer a new client has arrived */
r_if
c_cond
(paren
(paren
id|err
op_assign
id|i2c_attach_client
c_func
(paren
id|new_client
)paren
)paren
)paren
r_goto
id|exit_free
suffix:semicolon
multiline_comment|/* Initialize the ADM1031 chip */
id|adm1031_init_client
c_func
(paren
id|new_client
)paren
suffix:semicolon
multiline_comment|/* Register sysfs hooks */
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_fan1_input
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_fan1_div
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_fan1_min
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_pwm1
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_auto_fan1_channel
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_temp1_input
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_temp1_min
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_temp1_max
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_temp1_crit
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_temp2_input
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_temp2_min
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_temp2_max
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_temp2_crit
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_auto_temp1_off
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_auto_temp1_min
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_auto_temp1_max
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_auto_temp2_off
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_auto_temp2_min
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_auto_temp2_max
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_auto_fan1_min_pwm
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_alarms
)paren
suffix:semicolon
r_if
c_cond
(paren
id|kind
op_eq
id|adm1031
)paren
(brace
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_fan2_input
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_fan2_div
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_fan2_min
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_pwm2
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_auto_fan2_channel
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_temp3_input
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_temp3_min
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_temp3_max
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_temp3_crit
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_auto_temp3_off
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_auto_temp3_min
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_auto_temp3_max
)paren
suffix:semicolon
id|device_create_file
c_func
(paren
op_amp
id|new_client-&gt;dev
comma
op_amp
id|dev_attr_auto_fan2_min_pwm
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
id|exit_free
suffix:colon
id|kfree
c_func
(paren
id|new_client
)paren
suffix:semicolon
m_exit
suffix:colon
r_return
id|err
suffix:semicolon
)brace
DECL|function|adm1031_detach_client
r_static
r_int
id|adm1031_detach_client
c_func
(paren
r_struct
id|i2c_client
op_star
id|client
)paren
(brace
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|i2c_detach_client
c_func
(paren
id|client
)paren
)paren
op_ne
l_int|0
)paren
(brace
r_return
id|ret
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|client
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|adm1031_init_client
r_static
r_void
id|adm1031_init_client
c_func
(paren
r_struct
id|i2c_client
op_star
id|client
)paren
(brace
r_int
r_int
id|read_val
suffix:semicolon
r_int
r_int
id|mask
suffix:semicolon
r_struct
id|adm1031_data
op_star
id|data
op_assign
id|i2c_get_clientdata
c_func
(paren
id|client
)paren
suffix:semicolon
id|mask
op_assign
(paren
id|ADM1031_CONF2_PWM1_ENABLE
op_or
id|ADM1031_CONF2_TACH1_ENABLE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|data-&gt;chip_type
op_eq
id|adm1031
)paren
(brace
id|mask
op_or_assign
(paren
id|ADM1031_CONF2_PWM2_ENABLE
op_or
id|ADM1031_CONF2_TACH2_ENABLE
)paren
suffix:semicolon
)brace
multiline_comment|/* Initialize the ADM1031 chip (enables fan speed reading ) */
id|read_val
op_assign
id|adm1031_read_value
c_func
(paren
id|client
comma
id|ADM1031_REG_CONF2
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|read_val
op_or
id|mask
)paren
op_ne
id|read_val
)paren
(brace
id|adm1031_write_value
c_func
(paren
id|client
comma
id|ADM1031_REG_CONF2
comma
id|read_val
op_or
id|mask
)paren
suffix:semicolon
)brace
id|read_val
op_assign
id|adm1031_read_value
c_func
(paren
id|client
comma
id|ADM1031_REG_CONF1
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|read_val
op_or
id|ADM1031_CONF1_MONITOR_ENABLE
)paren
op_ne
id|read_val
)paren
(brace
id|adm1031_write_value
c_func
(paren
id|client
comma
id|ADM1031_REG_CONF1
comma
id|read_val
op_or
id|ADM1031_CONF1_MONITOR_ENABLE
)paren
suffix:semicolon
)brace
)brace
DECL|function|adm1031_update_device
r_static
r_struct
id|adm1031_data
op_star
id|adm1031_update_device
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|i2c_client
op_star
id|client
op_assign
id|to_i2c_client
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|adm1031_data
op_star
id|data
op_assign
id|i2c_get_clientdata
c_func
(paren
id|client
)paren
suffix:semicolon
r_int
id|chan
suffix:semicolon
id|down
c_func
(paren
op_amp
id|data-&gt;update_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|jiffies
op_minus
id|data-&gt;last_updated
OG
id|HZ
op_plus
id|HZ
op_div
l_int|2
)paren
op_logical_or
(paren
id|jiffies
OL
id|data-&gt;last_updated
)paren
op_logical_or
op_logical_neg
id|data-&gt;valid
)paren
(brace
id|dev_dbg
c_func
(paren
op_amp
id|client-&gt;dev
comma
l_string|&quot;Starting adm1031 update&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|chan
op_assign
l_int|0
suffix:semicolon
id|chan
OL
(paren
(paren
id|data-&gt;chip_type
op_eq
id|adm1031
)paren
ques
c_cond
l_int|3
suffix:colon
l_int|2
)paren
suffix:semicolon
id|chan
op_increment
)paren
(brace
id|u8
id|oldh
comma
id|newh
suffix:semicolon
id|oldh
op_assign
id|adm1031_read_value
c_func
(paren
id|client
comma
id|ADM1031_REG_TEMP
c_func
(paren
id|chan
)paren
)paren
suffix:semicolon
id|data-&gt;ext_temp
(braket
id|chan
)braket
op_assign
id|adm1031_read_value
c_func
(paren
id|client
comma
id|ADM1031_REG_EXT_TEMP
)paren
suffix:semicolon
id|newh
op_assign
id|adm1031_read_value
c_func
(paren
id|client
comma
id|ADM1031_REG_TEMP
c_func
(paren
id|chan
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|newh
op_ne
id|oldh
)paren
(brace
id|data-&gt;ext_temp
(braket
id|chan
)braket
op_assign
id|adm1031_read_value
c_func
(paren
id|client
comma
id|ADM1031_REG_EXT_TEMP
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|oldh
op_assign
id|adm1031_read_value
c_func
(paren
id|client
comma
id|ADM1031_REG_TEMP
c_func
(paren
id|chan
)paren
)paren
suffix:semicolon
multiline_comment|/* oldh is actually newer */
r_if
c_cond
(paren
id|newh
op_ne
id|oldh
)paren
id|dev_warn
c_func
(paren
op_amp
id|client-&gt;dev
comma
l_string|&quot;Remote temperature may be &quot;
l_string|&quot;wrong.&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
id|data-&gt;temp
(braket
id|chan
)braket
op_assign
id|newh
suffix:semicolon
id|data-&gt;temp_min
(braket
id|chan
)braket
op_assign
id|adm1031_read_value
c_func
(paren
id|client
comma
id|ADM1031_REG_TEMP_MIN
c_func
(paren
id|chan
)paren
)paren
suffix:semicolon
id|data-&gt;temp_max
(braket
id|chan
)braket
op_assign
id|adm1031_read_value
c_func
(paren
id|client
comma
id|ADM1031_REG_TEMP_MAX
c_func
(paren
id|chan
)paren
)paren
suffix:semicolon
id|data-&gt;temp_crit
(braket
id|chan
)braket
op_assign
id|adm1031_read_value
c_func
(paren
id|client
comma
id|ADM1031_REG_TEMP_CRIT
c_func
(paren
id|chan
)paren
)paren
suffix:semicolon
id|data-&gt;auto_temp
(braket
id|chan
)braket
op_assign
id|adm1031_read_value
c_func
(paren
id|client
comma
id|ADM1031_REG_AUTO_TEMP
c_func
(paren
id|chan
)paren
)paren
suffix:semicolon
)brace
id|data-&gt;conf1
op_assign
id|adm1031_read_value
c_func
(paren
id|client
comma
id|ADM1031_REG_CONF1
)paren
suffix:semicolon
id|data-&gt;conf2
op_assign
id|adm1031_read_value
c_func
(paren
id|client
comma
id|ADM1031_REG_CONF2
)paren
suffix:semicolon
id|data-&gt;alarm
op_assign
id|adm1031_read_value
c_func
(paren
id|client
comma
id|ADM1031_REG_STATUS
c_func
(paren
l_int|0
)paren
)paren
op_or
(paren
id|adm1031_read_value
c_func
(paren
id|client
comma
id|ADM1031_REG_STATUS
c_func
(paren
l_int|1
)paren
)paren
op_lshift
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|data-&gt;chip_type
op_eq
id|adm1030
)paren
(brace
id|data-&gt;alarm
op_and_assign
l_int|0xc0ff
suffix:semicolon
)brace
r_for
c_loop
(paren
id|chan
op_assign
l_int|0
suffix:semicolon
id|chan
OL
(paren
id|data-&gt;chip_type
op_eq
id|adm1030
ques
c_cond
l_int|1
suffix:colon
l_int|2
)paren
suffix:semicolon
id|chan
op_increment
)paren
(brace
id|data-&gt;fan_div
(braket
id|chan
)braket
op_assign
id|adm1031_read_value
c_func
(paren
id|client
comma
id|ADM1031_REG_FAN_DIV
c_func
(paren
id|chan
)paren
)paren
suffix:semicolon
id|data-&gt;fan_min
(braket
id|chan
)braket
op_assign
id|adm1031_read_value
c_func
(paren
id|client
comma
id|ADM1031_REG_FAN_MIN
c_func
(paren
id|chan
)paren
)paren
suffix:semicolon
id|data-&gt;fan
(braket
id|chan
)braket
op_assign
id|adm1031_read_value
c_func
(paren
id|client
comma
id|ADM1031_REG_FAN_SPEED
c_func
(paren
id|chan
)paren
)paren
suffix:semicolon
id|data-&gt;pwm
(braket
id|chan
)braket
op_assign
l_int|0xf
op_amp
(paren
id|adm1031_read_value
c_func
(paren
id|client
comma
id|ADM1031_REG_PWM
)paren
op_rshift
(paren
l_int|4
op_star
id|chan
)paren
)paren
suffix:semicolon
)brace
id|data-&gt;last_updated
op_assign
id|jiffies
suffix:semicolon
id|data-&gt;valid
op_assign
l_int|1
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|data-&gt;update_lock
)paren
suffix:semicolon
r_return
id|data
suffix:semicolon
)brace
DECL|function|sensors_adm1031_init
r_static
r_int
id|__init
id|sensors_adm1031_init
c_func
(paren
r_void
)paren
(brace
r_return
id|i2c_add_driver
c_func
(paren
op_amp
id|adm1031_driver
)paren
suffix:semicolon
)brace
DECL|function|sensors_adm1031_exit
r_static
r_void
id|__exit
id|sensors_adm1031_exit
c_func
(paren
r_void
)paren
(brace
id|i2c_del_driver
c_func
(paren
op_amp
id|adm1031_driver
)paren
suffix:semicolon
)brace
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Alexandre d&squot;Alton &lt;alex@alexdalton.org&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;ADM1031/ADM1030 driver&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
DECL|variable|sensors_adm1031_init
id|module_init
c_func
(paren
id|sensors_adm1031_init
)paren
suffix:semicolon
DECL|variable|sensors_adm1031_exit
id|module_exit
c_func
(paren
id|sensors_adm1031_exit
)paren
suffix:semicolon
eof
