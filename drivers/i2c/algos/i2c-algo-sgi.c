multiline_comment|/*&n; * i2c-algo-sgi.c: i2c driver algorithms for SGI adapters.&n; * &n; * This file is subject to the terms and conditions of the GNU General Public&n; * License version 2 as published by the Free Software Foundation.&n; *&n; * Copyright (C) 2003 Ladislav Michl &lt;ladis@linux-mips.org&gt;&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/i2c.h&gt;
macro_line|#include &lt;linux/i2c-algo-sgi.h&gt;
DECL|macro|SGI_I2C_FORCE_IDLE
mdefine_line|#define SGI_I2C_FORCE_IDLE&t;(0 &lt;&lt; 0)
DECL|macro|SGI_I2C_NOT_IDLE
mdefine_line|#define SGI_I2C_NOT_IDLE&t;(1 &lt;&lt; 0)
DECL|macro|SGI_I2C_WRITE
mdefine_line|#define SGI_I2C_WRITE&t;&t;(0 &lt;&lt; 1)
DECL|macro|SGI_I2C_READ
mdefine_line|#define SGI_I2C_READ&t;&t;(1 &lt;&lt; 1)
DECL|macro|SGI_I2C_RELEASE_BUS
mdefine_line|#define SGI_I2C_RELEASE_BUS&t;(0 &lt;&lt; 2)
DECL|macro|SGI_I2C_HOLD_BUS
mdefine_line|#define SGI_I2C_HOLD_BUS&t;(1 &lt;&lt; 2)
DECL|macro|SGI_I2C_XFER_DONE
mdefine_line|#define SGI_I2C_XFER_DONE&t;(0 &lt;&lt; 4)
DECL|macro|SGI_I2C_XFER_BUSY
mdefine_line|#define SGI_I2C_XFER_BUSY&t;(1 &lt;&lt; 4)
DECL|macro|SGI_I2C_ACK
mdefine_line|#define SGI_I2C_ACK&t;&t;(0 &lt;&lt; 5)
DECL|macro|SGI_I2C_NACK
mdefine_line|#define SGI_I2C_NACK&t;&t;(1 &lt;&lt; 5)
DECL|macro|SGI_I2C_BUS_OK
mdefine_line|#define SGI_I2C_BUS_OK&t;&t;(0 &lt;&lt; 7)
DECL|macro|SGI_I2C_BUS_ERR
mdefine_line|#define SGI_I2C_BUS_ERR&t;&t;(1 &lt;&lt; 7)
DECL|macro|get_control
mdefine_line|#define get_control()&t;&t;adap-&gt;getctrl(adap-&gt;data)
DECL|macro|set_control
mdefine_line|#define set_control(val)&t;adap-&gt;setctrl(adap-&gt;data, val)
DECL|macro|read_data
mdefine_line|#define read_data()&t;&t;adap-&gt;rdata(adap-&gt;data)
DECL|macro|write_data
mdefine_line|#define write_data(val)&t;&t;adap-&gt;wdata(adap-&gt;data, val)
DECL|function|wait_xfer_done
r_static
r_int
id|wait_xfer_done
c_func
(paren
r_struct
id|i2c_algo_sgi_data
op_star
id|adap
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|adap-&gt;xfer_timeout
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|get_control
c_func
(paren
)paren
op_amp
id|SGI_I2C_XFER_BUSY
)paren
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
)brace
DECL|function|wait_ack
r_static
r_int
id|wait_ack
c_func
(paren
r_struct
id|i2c_algo_sgi_data
op_star
id|adap
)paren
(brace
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|wait_xfer_done
c_func
(paren
id|adap
)paren
)paren
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|adap-&gt;ack_timeout
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|get_control
c_func
(paren
)paren
op_amp
id|SGI_I2C_NACK
)paren
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
)brace
DECL|function|force_idle
r_static
r_int
id|force_idle
c_func
(paren
r_struct
id|i2c_algo_sgi_data
op_star
id|adap
)paren
(brace
r_int
id|i
suffix:semicolon
id|set_control
c_func
(paren
id|SGI_I2C_FORCE_IDLE
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|adap-&gt;xfer_timeout
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|get_control
c_func
(paren
)paren
op_amp
id|SGI_I2C_NOT_IDLE
)paren
op_eq
l_int|0
)paren
r_goto
id|out
suffix:semicolon
id|udelay
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
id|out
suffix:colon
r_if
c_cond
(paren
id|get_control
c_func
(paren
)paren
op_amp
id|SGI_I2C_BUS_ERR
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|do_address
r_static
r_int
id|do_address
c_func
(paren
r_struct
id|i2c_algo_sgi_data
op_star
id|adap
comma
r_int
r_int
id|addr
comma
r_int
id|rd
)paren
(brace
r_if
c_cond
(paren
id|rd
)paren
id|set_control
c_func
(paren
id|SGI_I2C_NOT_IDLE
)paren
suffix:semicolon
multiline_comment|/* Check if bus is idle, eventually force it to do so */
r_if
c_cond
(paren
id|get_control
c_func
(paren
)paren
op_amp
id|SGI_I2C_NOT_IDLE
)paren
r_if
c_cond
(paren
id|force_idle
c_func
(paren
id|adap
)paren
)paren
r_return
op_minus
id|EIO
suffix:semicolon
multiline_comment|/* Write out the i2c chip address and specify operation */
id|set_control
c_func
(paren
id|SGI_I2C_HOLD_BUS
op_or
id|SGI_I2C_WRITE
op_or
id|SGI_I2C_NOT_IDLE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rd
)paren
id|addr
op_or_assign
l_int|1
suffix:semicolon
id|write_data
c_func
(paren
id|addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|wait_ack
c_func
(paren
id|adap
)paren
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|i2c_read
r_static
r_int
id|i2c_read
c_func
(paren
r_struct
id|i2c_algo_sgi_data
op_star
id|adap
comma
r_int
r_char
op_star
id|buf
comma
r_int
r_int
id|len
)paren
(brace
r_int
id|i
suffix:semicolon
id|set_control
c_func
(paren
id|SGI_I2C_HOLD_BUS
op_or
id|SGI_I2C_READ
op_or
id|SGI_I2C_NOT_IDLE
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|wait_xfer_done
c_func
(paren
id|adap
)paren
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|buf
(braket
id|i
)braket
op_assign
id|read_data
c_func
(paren
)paren
suffix:semicolon
)brace
id|set_control
c_func
(paren
id|SGI_I2C_RELEASE_BUS
op_or
id|SGI_I2C_FORCE_IDLE
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|i2c_write
r_static
r_int
id|i2c_write
c_func
(paren
r_struct
id|i2c_algo_sgi_data
op_star
id|adap
comma
r_int
r_char
op_star
id|buf
comma
r_int
r_int
id|len
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/* We are already in write state */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
id|i
op_increment
)paren
(brace
id|write_data
c_func
(paren
id|buf
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|wait_ack
c_func
(paren
id|adap
)paren
)paren
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sgi_xfer
r_static
r_int
id|sgi_xfer
c_func
(paren
r_struct
id|i2c_adapter
op_star
id|i2c_adap
comma
r_struct
id|i2c_msg
id|msgs
(braket
)braket
comma
r_int
id|num
)paren
(brace
r_struct
id|i2c_algo_sgi_data
op_star
id|adap
op_assign
id|i2c_adap-&gt;algo_data
suffix:semicolon
r_struct
id|i2c_msg
op_star
id|p
suffix:semicolon
r_int
id|i
comma
id|err
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
op_logical_neg
id|err
op_logical_and
id|i
OL
id|num
suffix:semicolon
id|i
op_increment
)paren
(brace
id|p
op_assign
op_amp
id|msgs
(braket
id|i
)braket
suffix:semicolon
id|err
op_assign
id|do_address
c_func
(paren
id|adap
comma
id|p-&gt;addr
comma
id|p-&gt;flags
op_amp
id|I2C_M_RD
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_logical_or
op_logical_neg
id|p-&gt;len
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|p-&gt;flags
op_amp
id|I2C_M_RD
)paren
id|err
op_assign
id|i2c_read
c_func
(paren
id|adap
comma
id|p-&gt;buf
comma
id|p-&gt;len
)paren
suffix:semicolon
r_else
id|err
op_assign
id|i2c_write
c_func
(paren
id|adap
comma
id|p-&gt;buf
comma
id|p-&gt;len
)paren
suffix:semicolon
)brace
r_return
id|err
suffix:semicolon
)brace
DECL|function|sgi_func
r_static
id|u32
id|sgi_func
c_func
(paren
r_struct
id|i2c_adapter
op_star
id|adap
)paren
(brace
r_return
id|I2C_FUNC_SMBUS_EMUL
suffix:semicolon
)brace
DECL|variable|sgi_algo
r_static
r_struct
id|i2c_algorithm
id|sgi_algo
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;SGI algorithm&quot;
comma
dot
id|id
op_assign
id|I2C_ALGO_SGI
comma
dot
id|master_xfer
op_assign
id|sgi_xfer
comma
dot
id|functionality
op_assign
id|sgi_func
comma
)brace
suffix:semicolon
multiline_comment|/* &n; * registering functions to load algorithms at runtime &n; */
DECL|function|i2c_sgi_add_bus
r_int
id|i2c_sgi_add_bus
c_func
(paren
r_struct
id|i2c_adapter
op_star
id|adap
)paren
(brace
id|adap-&gt;id
op_or_assign
id|sgi_algo.id
suffix:semicolon
id|adap-&gt;algo
op_assign
op_amp
id|sgi_algo
suffix:semicolon
r_return
id|i2c_add_adapter
c_func
(paren
id|adap
)paren
suffix:semicolon
)brace
DECL|function|i2c_sgi_del_bus
r_int
id|i2c_sgi_del_bus
c_func
(paren
r_struct
id|i2c_adapter
op_star
id|adap
)paren
(brace
r_return
id|i2c_del_adapter
c_func
(paren
id|adap
)paren
suffix:semicolon
)brace
DECL|variable|i2c_sgi_add_bus
id|EXPORT_SYMBOL
c_func
(paren
id|i2c_sgi_add_bus
)paren
suffix:semicolon
DECL|variable|i2c_sgi_del_bus
id|EXPORT_SYMBOL
c_func
(paren
id|i2c_sgi_del_bus
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Ladislav Michl &lt;ladis@linux-mips.org&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;I2C-Bus SGI algorithm&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
eof
