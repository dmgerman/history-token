multiline_comment|/*&n; *  i2c-algo-pca.c i2c driver algorithms for PCA9564 adapters                &n; *    Copyright (C) 2004 Arcom Control Systems&n; *&n; *  This program is free software; you can redistribute it and/or modify&n; *  it under the terms of the GNU General Public License as published by&n; *  the Free Software Foundation; either version 2 of the License, or&n; *  (at your option) any later version.&n; *&n; *  This program is distributed in the hope that it will be useful,&n; *  but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *  GNU General Public License for more details.&n; *&n; *  You should have received a copy of the GNU General Public License&n; *  along with this program; if not, write to the Free Software&n; *  Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/moduleparam.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/i2c.h&gt;
macro_line|#include &lt;linux/i2c-algo-pca.h&gt;
macro_line|#include &quot;i2c-algo-pca.h&quot;
DECL|macro|DRIVER
mdefine_line|#define DRIVER &quot;i2c-algo-pca&quot;
DECL|macro|DEB1
mdefine_line|#define DEB1(fmt, args...) do { if (i2c_debug&gt;=1) printk(fmt, ## args); } while(0)
DECL|macro|DEB2
mdefine_line|#define DEB2(fmt, args...) do { if (i2c_debug&gt;=2) printk(fmt, ## args); } while(0)
DECL|macro|DEB3
mdefine_line|#define DEB3(fmt, args...) do { if (i2c_debug&gt;=3) printk(fmt, ## args); } while(0)
DECL|variable|i2c_debug
r_static
r_int
id|i2c_debug
op_assign
l_int|0
suffix:semicolon
DECL|macro|pca_outw
mdefine_line|#define pca_outw(adap, reg, val) adap-&gt;write_byte(adap, reg, val)
DECL|macro|pca_inw
mdefine_line|#define pca_inw(adap, reg) adap-&gt;read_byte(adap, reg)
DECL|macro|pca_status
mdefine_line|#define pca_status(adap) pca_inw(adap, I2C_PCA_STA)
DECL|macro|pca_clock
mdefine_line|#define pca_clock(adap) adap-&gt;get_clock(adap)
DECL|macro|pca_own
mdefine_line|#define pca_own(adap) adap-&gt;get_own(adap)
DECL|macro|pca_set_con
mdefine_line|#define pca_set_con(adap, val) pca_outw(adap, I2C_PCA_CON, val)
DECL|macro|pca_get_con
mdefine_line|#define pca_get_con(adap) pca_inw(adap, I2C_PCA_CON)
DECL|macro|pca_wait
mdefine_line|#define pca_wait(adap) adap-&gt;wait_for_interrupt(adap)
multiline_comment|/*&n; * Generate a start condition on the i2c bus.&n; *&n; * returns after the start condition has occured&n; */
DECL|function|pca_start
r_static
r_void
id|pca_start
c_func
(paren
r_struct
id|i2c_algo_pca_data
op_star
id|adap
)paren
(brace
r_int
id|sta
op_assign
id|pca_get_con
c_func
(paren
id|adap
)paren
suffix:semicolon
id|DEB2
c_func
(paren
l_string|&quot;=== START&bslash;n&quot;
)paren
suffix:semicolon
id|sta
op_or_assign
id|I2C_PCA_CON_STA
suffix:semicolon
id|sta
op_and_assign
op_complement
(paren
id|I2C_PCA_CON_STO
op_or
id|I2C_PCA_CON_SI
)paren
suffix:semicolon
id|pca_set_con
c_func
(paren
id|adap
comma
id|sta
)paren
suffix:semicolon
id|pca_wait
c_func
(paren
id|adap
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Generate a repeated start condition on the i2c bus &n; *&n; * return after the repeated start condition has occured&n; */
DECL|function|pca_repeated_start
r_static
r_void
id|pca_repeated_start
c_func
(paren
r_struct
id|i2c_algo_pca_data
op_star
id|adap
)paren
(brace
r_int
id|sta
op_assign
id|pca_get_con
c_func
(paren
id|adap
)paren
suffix:semicolon
id|DEB2
c_func
(paren
l_string|&quot;=== REPEATED START&bslash;n&quot;
)paren
suffix:semicolon
id|sta
op_or_assign
id|I2C_PCA_CON_STA
suffix:semicolon
id|sta
op_and_assign
op_complement
(paren
id|I2C_PCA_CON_STO
op_or
id|I2C_PCA_CON_SI
)paren
suffix:semicolon
id|pca_set_con
c_func
(paren
id|adap
comma
id|sta
)paren
suffix:semicolon
id|pca_wait
c_func
(paren
id|adap
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Generate a stop condition on the i2c bus&n; *&n; * returns after the stop condition has been generated&n; *&n; * STOPs do not generate an interrupt or set the SI flag, since the&n; * part returns the the idle state (0xf8). Hence we don&squot;t need to&n; * pca_wait here.&n; */
DECL|function|pca_stop
r_static
r_void
id|pca_stop
c_func
(paren
r_struct
id|i2c_algo_pca_data
op_star
id|adap
)paren
(brace
r_int
id|sta
op_assign
id|pca_get_con
c_func
(paren
id|adap
)paren
suffix:semicolon
id|DEB2
c_func
(paren
l_string|&quot;=== STOP&bslash;n&quot;
)paren
suffix:semicolon
id|sta
op_or_assign
id|I2C_PCA_CON_STO
suffix:semicolon
id|sta
op_and_assign
op_complement
(paren
id|I2C_PCA_CON_STA
op_or
id|I2C_PCA_CON_SI
)paren
suffix:semicolon
id|pca_set_con
c_func
(paren
id|adap
comma
id|sta
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Send the slave address and R/W bit&n; *&n; * returns after the address has been sent&n; */
DECL|function|pca_address
r_static
r_void
id|pca_address
c_func
(paren
r_struct
id|i2c_algo_pca_data
op_star
id|adap
comma
r_struct
id|i2c_msg
op_star
id|msg
)paren
(brace
r_int
id|sta
op_assign
id|pca_get_con
c_func
(paren
id|adap
)paren
suffix:semicolon
r_int
id|addr
suffix:semicolon
id|addr
op_assign
(paren
(paren
l_int|0x7f
op_amp
id|msg-&gt;addr
)paren
op_lshift
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|msg-&gt;flags
op_amp
id|I2C_M_RD
)paren
id|addr
op_or_assign
l_int|1
suffix:semicolon
id|DEB2
c_func
(paren
l_string|&quot;=== SLAVE ADDRESS %#04x+%c=%#04x&bslash;n&quot;
comma
id|msg-&gt;addr
comma
id|msg-&gt;flags
op_amp
id|I2C_M_RD
ques
c_cond
l_char|&squot;R&squot;
suffix:colon
l_char|&squot;W&squot;
comma
id|addr
)paren
suffix:semicolon
id|pca_outw
c_func
(paren
id|adap
comma
id|I2C_PCA_DAT
comma
id|addr
)paren
suffix:semicolon
id|sta
op_and_assign
op_complement
(paren
id|I2C_PCA_CON_STO
op_or
id|I2C_PCA_CON_STA
op_or
id|I2C_PCA_CON_SI
)paren
suffix:semicolon
id|pca_set_con
c_func
(paren
id|adap
comma
id|sta
)paren
suffix:semicolon
id|pca_wait
c_func
(paren
id|adap
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Transmit a byte.&n; *&n; * Returns after the byte has been transmitted&n; */
DECL|function|pca_tx_byte
r_static
r_void
id|pca_tx_byte
c_func
(paren
r_struct
id|i2c_algo_pca_data
op_star
id|adap
comma
id|__u8
id|b
)paren
(brace
r_int
id|sta
op_assign
id|pca_get_con
c_func
(paren
id|adap
)paren
suffix:semicolon
id|DEB2
c_func
(paren
l_string|&quot;=== WRITE %#04x&bslash;n&quot;
comma
id|b
)paren
suffix:semicolon
id|pca_outw
c_func
(paren
id|adap
comma
id|I2C_PCA_DAT
comma
id|b
)paren
suffix:semicolon
id|sta
op_and_assign
op_complement
(paren
id|I2C_PCA_CON_STO
op_or
id|I2C_PCA_CON_STA
op_or
id|I2C_PCA_CON_SI
)paren
suffix:semicolon
id|pca_set_con
c_func
(paren
id|adap
comma
id|sta
)paren
suffix:semicolon
id|pca_wait
c_func
(paren
id|adap
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Receive a byte&n; *&n; * returns immediately.&n; */
DECL|function|pca_rx_byte
r_static
r_void
id|pca_rx_byte
c_func
(paren
r_struct
id|i2c_algo_pca_data
op_star
id|adap
comma
id|__u8
op_star
id|b
comma
r_int
id|ack
)paren
(brace
op_star
id|b
op_assign
id|pca_inw
c_func
(paren
id|adap
comma
id|I2C_PCA_DAT
)paren
suffix:semicolon
id|DEB2
c_func
(paren
l_string|&quot;=== READ %#04x %s&bslash;n&quot;
comma
op_star
id|b
comma
id|ack
ques
c_cond
l_string|&quot;ACK&quot;
suffix:colon
l_string|&quot;NACK&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* &n; * Setup ACK or NACK for next received byte and wait for it to arrive.&n; *&n; * Returns after next byte has arrived.&n; */
DECL|function|pca_rx_ack
r_static
r_void
id|pca_rx_ack
c_func
(paren
r_struct
id|i2c_algo_pca_data
op_star
id|adap
comma
r_int
id|ack
)paren
(brace
r_int
id|sta
op_assign
id|pca_get_con
c_func
(paren
id|adap
)paren
suffix:semicolon
id|sta
op_and_assign
op_complement
(paren
id|I2C_PCA_CON_STO
op_or
id|I2C_PCA_CON_STA
op_or
id|I2C_PCA_CON_SI
op_or
id|I2C_PCA_CON_AA
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ack
)paren
id|sta
op_or_assign
id|I2C_PCA_CON_AA
suffix:semicolon
id|pca_set_con
c_func
(paren
id|adap
comma
id|sta
)paren
suffix:semicolon
id|pca_wait
c_func
(paren
id|adap
)paren
suffix:semicolon
)brace
multiline_comment|/* &n; * Reset the i2c bus / SIO &n; */
DECL|function|pca_reset
r_static
r_void
id|pca_reset
c_func
(paren
r_struct
id|i2c_algo_pca_data
op_star
id|adap
)paren
(brace
multiline_comment|/* apparently only an external reset will do it. not a lot can be done */
id|printk
c_func
(paren
id|KERN_ERR
id|DRIVER
l_string|&quot;: Haven&squot;t figured out how to do a reset yet&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|pca_xfer
r_static
r_int
id|pca_xfer
c_func
(paren
r_struct
id|i2c_adapter
op_star
id|i2c_adap
comma
r_struct
id|i2c_msg
op_star
id|msgs
comma
r_int
id|num
)paren
(brace
r_struct
id|i2c_algo_pca_data
op_star
id|adap
op_assign
id|i2c_adap-&gt;algo_data
suffix:semicolon
r_struct
id|i2c_msg
op_star
id|msg
op_assign
l_int|NULL
suffix:semicolon
r_int
id|curmsg
suffix:semicolon
r_int
id|numbytes
op_assign
l_int|0
suffix:semicolon
r_int
id|state
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|state
op_assign
id|pca_status
c_func
(paren
id|adap
)paren
suffix:semicolon
r_if
c_cond
(paren
id|state
op_ne
l_int|0xF8
)paren
(brace
id|dev_dbg
c_func
(paren
op_amp
id|i2c_adap-&gt;dev
comma
l_string|&quot;bus is not idle. status is %#04x&bslash;n&quot;
comma
id|state
)paren
suffix:semicolon
multiline_comment|/* FIXME: what to do. Force stop ? */
r_return
op_minus
id|EREMOTEIO
suffix:semicolon
)brace
id|DEB1
c_func
(paren
l_string|&quot;{{{ XFER %d messages&bslash;n&quot;
comma
id|num
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i2c_debug
op_ge
l_int|2
)paren
(brace
r_for
c_loop
(paren
id|curmsg
op_assign
l_int|0
suffix:semicolon
id|curmsg
OL
id|num
suffix:semicolon
id|curmsg
op_increment
)paren
(brace
r_int
id|addr
comma
id|i
suffix:semicolon
id|msg
op_assign
op_amp
id|msgs
(braket
id|curmsg
)braket
suffix:semicolon
id|addr
op_assign
(paren
l_int|0x7f
op_amp
id|msg-&gt;addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|msg-&gt;flags
op_amp
id|I2C_M_RD
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;    [%02d] RD %d bytes from %#02x [%#02x, ...]&bslash;n&quot;
comma
id|curmsg
comma
id|msg-&gt;len
comma
id|addr
comma
(paren
id|addr
op_lshift
l_int|1
)paren
op_or
l_int|1
)paren
suffix:semicolon
r_else
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;    [%02d] WR %d bytes to %#02x [%#02x%s&quot;
comma
id|curmsg
comma
id|msg-&gt;len
comma
id|addr
comma
id|addr
op_lshift
l_int|1
comma
id|msg-&gt;len
op_eq
l_int|0
ques
c_cond
l_string|&quot;&quot;
suffix:colon
l_string|&quot;, &quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|msg-&gt;len
suffix:semicolon
id|i
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%#04x%s&quot;
comma
id|msg-&gt;buf
(braket
id|i
)braket
comma
id|i
op_eq
id|msg-&gt;len
op_minus
l_int|1
ques
c_cond
l_string|&quot;&quot;
suffix:colon
l_string|&quot;, &quot;
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;]&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
)brace
id|curmsg
op_assign
l_int|0
suffix:semicolon
id|ret
op_assign
op_minus
id|EREMOTEIO
suffix:semicolon
r_while
c_loop
(paren
id|curmsg
OL
id|num
)paren
(brace
id|state
op_assign
id|pca_status
c_func
(paren
id|adap
)paren
suffix:semicolon
id|DEB3
c_func
(paren
l_string|&quot;STATE is 0x%02x&bslash;n&quot;
comma
id|state
)paren
suffix:semicolon
id|msg
op_assign
op_amp
id|msgs
(braket
id|curmsg
)braket
suffix:semicolon
r_switch
c_cond
(paren
id|state
)paren
(brace
r_case
l_int|0xf8
suffix:colon
multiline_comment|/* On reset or stop the bus is idle */
id|pca_start
c_func
(paren
id|adap
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x08
suffix:colon
multiline_comment|/* A START condition has been transmitted */
r_case
l_int|0x10
suffix:colon
multiline_comment|/* A repeated start condition has been transmitted */
id|pca_address
c_func
(paren
id|adap
comma
id|msg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x18
suffix:colon
multiline_comment|/* SLA+W has been transmitted; ACK has been received */
r_case
l_int|0x28
suffix:colon
multiline_comment|/* Data byte in I2CDAT has been transmitted; ACK has been received */
r_if
c_cond
(paren
id|numbytes
OL
id|msg-&gt;len
)paren
(brace
id|pca_tx_byte
c_func
(paren
id|adap
comma
id|msg-&gt;buf
(braket
id|numbytes
)braket
)paren
suffix:semicolon
id|numbytes
op_increment
suffix:semicolon
r_break
suffix:semicolon
)brace
id|curmsg
op_increment
suffix:semicolon
id|numbytes
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|curmsg
op_eq
id|num
)paren
id|pca_stop
c_func
(paren
id|adap
)paren
suffix:semicolon
r_else
id|pca_repeated_start
c_func
(paren
id|adap
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x20
suffix:colon
multiline_comment|/* SLA+W has been transmitted; NOT ACK has been received */
id|DEB2
c_func
(paren
l_string|&quot;NOT ACK received after SLA+W&bslash;n&quot;
)paren
suffix:semicolon
id|pca_stop
c_func
(paren
id|adap
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
r_case
l_int|0x40
suffix:colon
multiline_comment|/* SLA+R has been transmitted; ACK has been received */
id|pca_rx_ack
c_func
(paren
id|adap
comma
id|msg-&gt;len
OG
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x50
suffix:colon
multiline_comment|/* Data bytes has been received; ACK has been returned */
r_if
c_cond
(paren
id|numbytes
OL
id|msg-&gt;len
)paren
(brace
id|pca_rx_byte
c_func
(paren
id|adap
comma
op_amp
id|msg-&gt;buf
(braket
id|numbytes
)braket
comma
l_int|1
)paren
suffix:semicolon
id|numbytes
op_increment
suffix:semicolon
id|pca_rx_ack
c_func
(paren
id|adap
comma
id|numbytes
OL
id|msg-&gt;len
op_minus
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|curmsg
op_increment
suffix:semicolon
id|numbytes
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|curmsg
op_eq
id|num
)paren
id|pca_stop
c_func
(paren
id|adap
)paren
suffix:semicolon
r_else
id|pca_repeated_start
c_func
(paren
id|adap
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x48
suffix:colon
multiline_comment|/* SLA+R has been transmitted; NOT ACK has been received */
id|DEB2
c_func
(paren
l_string|&quot;NOT ACK received after SLA+R&bslash;n&quot;
)paren
suffix:semicolon
id|pca_stop
c_func
(paren
id|adap
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
r_case
l_int|0x30
suffix:colon
multiline_comment|/* Data byte in I2CDAT has been transmitted; NOT ACK has been received */
id|DEB2
c_func
(paren
l_string|&quot;NOT ACK received after data byte&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
r_case
l_int|0x38
suffix:colon
multiline_comment|/* Arbitration lost during SLA+W, SLA+R or data bytes */
id|DEB2
c_func
(paren
l_string|&quot;Arbitration lost&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
r_case
l_int|0x58
suffix:colon
multiline_comment|/* Data byte has been received; NOT ACK has been returned */
r_if
c_cond
(paren
id|numbytes
op_eq
id|msg-&gt;len
op_minus
l_int|1
)paren
(brace
id|pca_rx_byte
c_func
(paren
id|adap
comma
op_amp
id|msg-&gt;buf
(braket
id|numbytes
)braket
comma
l_int|0
)paren
suffix:semicolon
id|curmsg
op_increment
suffix:semicolon
id|numbytes
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|curmsg
op_eq
id|num
)paren
id|pca_stop
c_func
(paren
id|adap
)paren
suffix:semicolon
r_else
id|pca_repeated_start
c_func
(paren
id|adap
)paren
suffix:semicolon
)brace
r_else
(brace
id|DEB2
c_func
(paren
l_string|&quot;NOT ACK sent after data byte received. &quot;
l_string|&quot;Not final byte. numbytes %d. len %d&bslash;n&quot;
comma
id|numbytes
comma
id|msg-&gt;len
)paren
suffix:semicolon
id|pca_stop
c_func
(paren
id|adap
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_int|0x70
suffix:colon
multiline_comment|/* Bus error - SDA stuck low */
id|DEB2
c_func
(paren
l_string|&quot;BUS ERROR - SDA Stuck low&bslash;n&quot;
)paren
suffix:semicolon
id|pca_reset
c_func
(paren
id|adap
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
r_case
l_int|0x90
suffix:colon
multiline_comment|/* Bus error - SCL stuck low */
id|DEB2
c_func
(paren
l_string|&quot;BUS ERROR - SCL Stuck low&bslash;n&quot;
)paren
suffix:semicolon
id|pca_reset
c_func
(paren
id|adap
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
r_case
l_int|0x00
suffix:colon
multiline_comment|/* Bus error during master or slave mode due to illegal START or STOP condition */
id|DEB2
c_func
(paren
l_string|&quot;BUS ERROR - Illegal START or STOP&bslash;n&quot;
)paren
suffix:semicolon
id|pca_reset
c_func
(paren
id|adap
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
id|DRIVER
l_string|&quot;: unhandled SIO state 0x%02x&bslash;n&quot;
comma
id|state
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|ret
op_assign
id|curmsg
suffix:semicolon
id|out
suffix:colon
id|DEB1
c_func
(paren
id|KERN_CRIT
l_string|&quot;}}} transfered %d/%d messages. &quot;
l_string|&quot;status is %#04x. control is %#04x&bslash;n&quot;
comma
id|curmsg
comma
id|num
comma
id|pca_status
c_func
(paren
id|adap
)paren
comma
id|pca_get_con
c_func
(paren
id|adap
)paren
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|pca_func
r_static
id|u32
id|pca_func
c_func
(paren
r_struct
id|i2c_adapter
op_star
id|adap
)paren
(brace
r_return
id|I2C_FUNC_I2C
op_or
id|I2C_FUNC_SMBUS_EMUL
suffix:semicolon
)brace
DECL|function|pca_init
r_static
r_int
id|pca_init
c_func
(paren
r_struct
id|i2c_algo_pca_data
op_star
id|adap
)paren
(brace
r_static
r_int
id|freqs
(braket
)braket
op_assign
(brace
l_int|330
comma
l_int|288
comma
l_int|217
comma
l_int|146
comma
l_int|88
comma
l_int|59
comma
l_int|44
comma
l_int|36
)brace
suffix:semicolon
r_int
id|own
comma
id|clock
suffix:semicolon
id|own
op_assign
id|pca_own
c_func
(paren
id|adap
)paren
suffix:semicolon
id|clock
op_assign
id|pca_clock
c_func
(paren
id|adap
)paren
suffix:semicolon
id|DEB1
c_func
(paren
id|KERN_INFO
id|DRIVER
l_string|&quot;: own address is %#04x&bslash;n&quot;
comma
id|own
)paren
suffix:semicolon
id|DEB1
c_func
(paren
id|KERN_INFO
id|DRIVER
l_string|&quot;: clock freqeuncy is %dkHz&bslash;n&quot;
comma
id|freqs
(braket
id|clock
)braket
)paren
suffix:semicolon
id|pca_outw
c_func
(paren
id|adap
comma
id|I2C_PCA_ADR
comma
id|own
op_lshift
l_int|1
)paren
suffix:semicolon
id|pca_set_con
c_func
(paren
id|adap
comma
id|I2C_PCA_CON_ENSIO
op_or
id|clock
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|500
)paren
suffix:semicolon
multiline_comment|/* 500 &#xfffd;s for oscilator to stabilise */
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|pca_algo
r_static
r_struct
id|i2c_algorithm
id|pca_algo
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;PCA9564 algorithm&quot;
comma
dot
id|id
op_assign
id|I2C_ALGO_PCA
comma
dot
id|master_xfer
op_assign
id|pca_xfer
comma
dot
id|functionality
op_assign
id|pca_func
comma
)brace
suffix:semicolon
multiline_comment|/* &n; * registering functions to load algorithms at runtime &n; */
DECL|function|i2c_pca_add_bus
r_int
id|i2c_pca_add_bus
c_func
(paren
r_struct
id|i2c_adapter
op_star
id|adap
)paren
(brace
r_struct
id|i2c_algo_pca_data
op_star
id|pca_adap
op_assign
id|adap-&gt;algo_data
suffix:semicolon
r_int
id|rval
suffix:semicolon
multiline_comment|/* register new adapter to i2c module... */
id|adap-&gt;id
op_or_assign
id|pca_algo.id
suffix:semicolon
id|adap-&gt;algo
op_assign
op_amp
id|pca_algo
suffix:semicolon
id|adap-&gt;timeout
op_assign
l_int|100
suffix:semicolon
multiline_comment|/* default values, should&t;*/
id|adap-&gt;retries
op_assign
l_int|3
suffix:semicolon
multiline_comment|/* be replaced by defines&t;*/
id|rval
op_assign
id|pca_init
c_func
(paren
id|pca_adap
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rval
)paren
id|i2c_add_adapter
c_func
(paren
id|adap
)paren
suffix:semicolon
r_return
id|rval
suffix:semicolon
)brace
DECL|function|i2c_pca_del_bus
r_int
id|i2c_pca_del_bus
c_func
(paren
r_struct
id|i2c_adapter
op_star
id|adap
)paren
(brace
r_return
id|i2c_del_adapter
c_func
(paren
id|adap
)paren
suffix:semicolon
)brace
DECL|variable|i2c_pca_add_bus
id|EXPORT_SYMBOL
c_func
(paren
id|i2c_pca_add_bus
)paren
suffix:semicolon
DECL|variable|i2c_pca_del_bus
id|EXPORT_SYMBOL
c_func
(paren
id|i2c_pca_del_bus
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Ian Campbell &lt;icampbell@arcom.com&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;I2C-Bus PCA9564 algorithm&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|module_param
c_func
(paren
id|i2c_debug
comma
r_int
comma
l_int|0
)paren
suffix:semicolon
eof
