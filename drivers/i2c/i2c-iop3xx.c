multiline_comment|/* ------------------------------------------------------------------------- */
multiline_comment|/* i2c-iop3xx.c i2c driver algorithms for Intel XScale IOP3xx                */
multiline_comment|/* ------------------------------------------------------------------------- */
multiline_comment|/*   Copyright (C) 2003 Peter Milne, D-TACQ Solutions Ltd&n; *                      &lt;Peter dot Milne at D hyphen TACQ dot com&gt;&n;&n;    This program is free software; you can redistribute it and/or modify&n;    it under the terms of the GNU General Public License as published by&n;    the Free Software Foundation, version 2.&n;&n;&n;    This program is distributed in the hope that it will be useful,&n;    but WITHOUT ANY WARRANTY; without even the implied warranty of&n;    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n;    GNU General Public License for more details.&n;&n;    You should have received a copy of the GNU General Public License&n;    along with this program; if not, write to the Free Software&n;    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.                */
multiline_comment|/* ------------------------------------------------------------------------- */
multiline_comment|/*&n;   With acknowledgements to i2c-algo-ibm_ocp.c by &n;   Ian DaSilva, MontaVista Software, Inc. idasilva@mvista.com&n;&n;   And i2c-algo-pcf.c, which was created by Simon G. Vogl and Hans Berglund:&n;&n;     Copyright (C) 1995-1997 Simon G. Vogl, 1998-2000 Hans Berglund&n;   &n;   And which acknowledged Ky&#xfffd;sti M&#xfffd;lkki &lt;kmalkki@cc.hut.fi&gt;,&n;   Frodo Looijaard &lt;frodol@dds.nl&gt;, Martin Bailey&lt;mbailey@littlefeet-inc.com&gt;&n;&n;  ---------------------------------------------------------------------------*/
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/i2c.h&gt;
macro_line|#include &lt;asm/arch-iop3xx/iop321.h&gt;
macro_line|#include &lt;asm/arch-iop3xx/iop321-irqs.h&gt;
macro_line|#include &quot;i2c-iop3xx.h&quot;
multiline_comment|/* ----- global defines ----------------------------------------------- */
DECL|macro|PASSERT
mdefine_line|#define PASSERT(x) do { if (!(x) ) &bslash;&n;                printk(KERN_CRIT &quot;PASSERT %s in %s:%d&bslash;n&quot;, #x, __FILE__, __LINE__ );&bslash;&n;        } while (0)
multiline_comment|/* ----- global variables ---------------------------------------------&t;*/
DECL|function|iic_cook_addr
r_static
r_inline
r_int
r_char
id|iic_cook_addr
c_func
(paren
r_struct
id|i2c_msg
op_star
id|msg
)paren
(brace
r_int
r_char
id|addr
suffix:semicolon
id|addr
op_assign
(paren
id|msg-&gt;addr
op_lshift
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|msg-&gt;flags
op_amp
id|I2C_M_RD
)paren
id|addr
op_or_assign
l_int|1
suffix:semicolon
multiline_comment|/* PGM: what is M_REV_DIR_ADDR - do we need it ?? */
r_if
c_cond
(paren
id|msg-&gt;flags
op_amp
id|I2C_M_REV_DIR_ADDR
)paren
id|addr
op_xor_assign
l_int|1
suffix:semicolon
r_return
id|addr
suffix:semicolon
)brace
DECL|function|iop3xx_adap_reset
r_static
r_inline
r_void
id|iop3xx_adap_reset
c_func
(paren
r_struct
id|i2c_algo_iop3xx_data
op_star
id|iop3xx_adap
)paren
(brace
singleline_comment|// Follows devman 9.3
op_star
id|iop3xx_adap-&gt;biu-&gt;CR
op_assign
id|IOP321_ICR_UNIT_RESET
suffix:semicolon
op_star
id|iop3xx_adap-&gt;biu-&gt;SR
op_assign
id|IOP321_ISR_CLEARBITS
suffix:semicolon
op_star
id|iop3xx_adap-&gt;biu-&gt;CR
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|iop3xx_adap_set_slave_addr
r_static
r_inline
r_void
id|iop3xx_adap_set_slave_addr
c_func
(paren
r_struct
id|i2c_algo_iop3xx_data
op_star
id|iop3xx_adap
)paren
(brace
op_star
id|iop3xx_adap-&gt;biu-&gt;SAR
op_assign
id|MYSAR
suffix:semicolon
)brace
DECL|function|iop3xx_adap_enable
r_static
r_inline
r_void
id|iop3xx_adap_enable
c_func
(paren
r_struct
id|i2c_algo_iop3xx_data
op_star
id|iop3xx_adap
)paren
(brace
id|u32
id|cr
op_assign
id|IOP321_ICR_GCD
op_or
id|IOP321_ICR_SCLEN
op_or
id|IOP321_ICR_UE
suffix:semicolon
multiline_comment|/* NB SR bits not same position as CR IE bits :-( */
id|iop3xx_adap-&gt;biu-&gt;SR_enabled
op_assign
id|IOP321_ISR_ALD
op_or
id|IOP321_ISR_BERRD
op_or
id|IOP321_ISR_RXFULL
op_or
id|IOP321_ISR_TXEMPTY
suffix:semicolon
id|cr
op_or_assign
id|IOP321_ICR_ALDIE
op_or
id|IOP321_ICR_BERRIE
op_or
id|IOP321_ICR_RXFULLIE
op_or
id|IOP321_ICR_TXEMPTYIE
suffix:semicolon
op_star
id|iop3xx_adap-&gt;biu-&gt;CR
op_assign
id|cr
suffix:semicolon
)brace
DECL|function|iop3xx_adap_transaction_cleanup
r_static
r_void
id|iop3xx_adap_transaction_cleanup
c_func
(paren
r_struct
id|i2c_algo_iop3xx_data
op_star
id|iop3xx_adap
)paren
(brace
r_int
id|cr
op_assign
op_star
id|iop3xx_adap-&gt;biu-&gt;CR
suffix:semicolon
id|cr
op_and_assign
op_complement
(paren
id|IOP321_ICR_MSTART
op_or
id|IOP321_ICR_TBYTE
op_or
id|IOP321_ICR_MSTOP
op_or
id|IOP321_ICR_SCLEN
)paren
suffix:semicolon
op_star
id|iop3xx_adap-&gt;biu-&gt;CR
op_assign
id|cr
suffix:semicolon
)brace
DECL|function|iop3xx_adap_final_cleanup
r_static
r_void
id|iop3xx_adap_final_cleanup
c_func
(paren
r_struct
id|i2c_algo_iop3xx_data
op_star
id|iop3xx_adap
)paren
(brace
r_int
id|cr
op_assign
op_star
id|iop3xx_adap-&gt;biu-&gt;CR
suffix:semicolon
id|cr
op_and_assign
op_complement
(paren
id|IOP321_ICR_ALDIE
op_or
id|IOP321_ICR_BERRIE
op_or
id|IOP321_ICR_RXFULLIE
op_or
id|IOP321_ICR_TXEMPTYIE
)paren
suffix:semicolon
id|iop3xx_adap-&gt;biu-&gt;SR_enabled
op_assign
l_int|0
suffix:semicolon
op_star
id|iop3xx_adap-&gt;biu-&gt;CR
op_assign
id|cr
suffix:semicolon
)brace
DECL|function|iop3xx_i2c_handler
r_static
r_void
id|iop3xx_i2c_handler
c_func
(paren
r_int
id|this_irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
multiline_comment|/* &n; * NB: the handler has to clear the source of the interrupt! &n; * Then it passes the SR flags of interest to BH via adap data&n; */
(brace
r_struct
id|i2c_algo_iop3xx_data
op_star
id|iop3xx_adap
op_assign
id|dev_id
suffix:semicolon
id|u32
id|sr
op_assign
op_star
id|iop3xx_adap-&gt;biu-&gt;SR
suffix:semicolon
r_if
c_cond
(paren
(paren
id|sr
op_and_assign
id|iop3xx_adap-&gt;biu-&gt;SR_enabled
)paren
)paren
(brace
op_star
id|iop3xx_adap-&gt;biu-&gt;SR
op_assign
id|sr
suffix:semicolon
id|iop3xx_adap-&gt;biu-&gt;SR_received
op_or_assign
id|sr
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|iop3xx_adap-&gt;waitq
)paren
suffix:semicolon
)brace
)brace
DECL|function|iop3xx_adap_error
r_static
r_int
id|iop3xx_adap_error
c_func
(paren
id|u32
id|sr
)paren
singleline_comment|// check all error conditions, clear them , report most important
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|sr
op_amp
id|IOP321_ISR_BERRD
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|rc
)paren
id|rc
op_assign
op_minus
id|I2C_ERR_BERR
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|sr
op_amp
id|IOP321_ISR_ALD
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|rc
)paren
id|rc
op_assign
op_minus
id|I2C_ERR_ALD
suffix:semicolon
)brace
r_return
id|rc
suffix:semicolon
)brace
DECL|function|get_srstat
r_static
r_inline
id|u32
id|get_srstat
c_func
(paren
r_struct
id|i2c_algo_iop3xx_data
op_star
id|iop3xx_adap
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|u32
id|sr
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|iop3xx_adap-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|sr
op_assign
id|iop3xx_adap-&gt;biu-&gt;SR_received
suffix:semicolon
id|iop3xx_adap-&gt;biu-&gt;SR_received
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|iop3xx_adap-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|sr
suffix:semicolon
)brace
multiline_comment|/*&n; * sleep until interrupted, then recover and analyse the SR&n; * saved by handler&n; */
DECL|typedef|CompareFunc
r_typedef
r_int
(paren
op_star
id|CompareFunc
)paren
(paren
r_int
id|test
comma
r_int
id|mask
)paren
suffix:semicolon
multiline_comment|/* returns 1 on correct comparison */
DECL|function|iop3xx_adap_wait_event
r_static
r_int
id|iop3xx_adap_wait_event
c_func
(paren
r_struct
id|i2c_algo_iop3xx_data
op_star
id|iop3xx_adap
comma
r_int
id|flags
comma
r_int
op_star
id|status
comma
id|CompareFunc
id|compare
)paren
(brace
r_int
id|sr
op_assign
l_int|0
suffix:semicolon
r_int
id|interrupted
suffix:semicolon
r_int
id|done
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_do
(brace
id|interrupted
op_assign
id|wait_event_interruptible_timeout
(paren
id|iop3xx_adap-&gt;waitq
comma
(paren
id|done
op_assign
id|compare
c_func
(paren
id|sr
op_assign
id|get_srstat
c_func
(paren
id|iop3xx_adap
)paren
comma
id|flags
)paren
)paren
comma
id|iop3xx_adap-&gt;timeout
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|iop3xx_adap_error
c_func
(paren
id|sr
)paren
)paren
OL
l_int|0
)paren
(brace
op_star
id|status
op_assign
id|sr
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|interrupted
)paren
(brace
op_star
id|status
op_assign
id|sr
suffix:semicolon
r_return
id|rc
op_assign
op_minus
id|ETIMEDOUT
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
op_logical_neg
id|done
)paren
(brace
suffix:semicolon
)brace
op_star
id|status
op_assign
id|sr
suffix:semicolon
r_return
id|rc
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Concrete CompareFuncs &n; */
DECL|function|all_bits_clear
r_static
r_int
id|all_bits_clear
c_func
(paren
r_int
id|test
comma
r_int
id|mask
)paren
(brace
r_return
(paren
id|test
op_amp
id|mask
)paren
op_eq
l_int|0
suffix:semicolon
)brace
DECL|function|any_bits_set
r_static
r_int
id|any_bits_set
c_func
(paren
r_int
id|test
comma
r_int
id|mask
)paren
(brace
r_return
(paren
id|test
op_amp
id|mask
)paren
op_ne
l_int|0
suffix:semicolon
)brace
DECL|function|iop3xx_adap_wait_tx_done
r_static
r_int
id|iop3xx_adap_wait_tx_done
c_func
(paren
r_struct
id|i2c_algo_iop3xx_data
op_star
id|iop3xx_adap
comma
r_int
op_star
id|status
)paren
(brace
r_return
id|iop3xx_adap_wait_event
c_func
(paren
id|iop3xx_adap
comma
id|IOP321_ISR_TXEMPTY
op_or
id|IOP321_ISR_ALD
op_or
id|IOP321_ISR_BERRD
comma
id|status
comma
id|any_bits_set
)paren
suffix:semicolon
)brace
DECL|function|iop3xx_adap_wait_rx_done
r_static
r_int
id|iop3xx_adap_wait_rx_done
c_func
(paren
r_struct
id|i2c_algo_iop3xx_data
op_star
id|iop3xx_adap
comma
r_int
op_star
id|status
)paren
(brace
r_return
id|iop3xx_adap_wait_event
c_func
(paren
id|iop3xx_adap
comma
id|IOP321_ISR_RXFULL
op_or
id|IOP321_ISR_ALD
op_or
id|IOP321_ISR_BERRD
comma
id|status
comma
id|any_bits_set
)paren
suffix:semicolon
)brace
DECL|function|iop3xx_adap_wait_idle
r_static
r_int
id|iop3xx_adap_wait_idle
c_func
(paren
r_struct
id|i2c_algo_iop3xx_data
op_star
id|iop3xx_adap
comma
r_int
op_star
id|status
)paren
(brace
r_return
id|iop3xx_adap_wait_event
c_func
(paren
id|iop3xx_adap
comma
id|IOP321_ISR_UNITBUSY
comma
id|status
comma
id|all_bits_clear
)paren
suffix:semicolon
)brace
singleline_comment|//
singleline_comment|// Description: This performs the IOP3xx initialization sequence
singleline_comment|// Valid for IOP321. Maybe valid for IOP310?.
singleline_comment|//
DECL|function|iop3xx_adap_init
r_static
r_int
id|iop3xx_adap_init
(paren
r_struct
id|i2c_algo_iop3xx_data
op_star
id|iop3xx_adap
)paren
(brace
op_star
id|IOP321_GPOD
op_and_assign
op_complement
(paren
id|iop3xx_adap-&gt;channel
op_eq
l_int|0
ques
c_cond
id|IOP321_GPOD_I2C0
suffix:colon
id|IOP321_GPOD_I2C1
)paren
suffix:semicolon
id|iop3xx_adap_reset
c_func
(paren
id|iop3xx_adap
)paren
suffix:semicolon
id|iop3xx_adap_set_slave_addr
c_func
(paren
id|iop3xx_adap
)paren
suffix:semicolon
id|iop3xx_adap_enable
c_func
(paren
id|iop3xx_adap
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|iop3xx_adap_send_target_slave_addr
r_static
r_int
id|iop3xx_adap_send_target_slave_addr
c_func
(paren
r_struct
id|i2c_algo_iop3xx_data
op_star
id|iop3xx_adap
comma
r_struct
id|i2c_msg
op_star
id|msg
)paren
(brace
r_int
id|cr
op_assign
op_star
id|iop3xx_adap-&gt;biu-&gt;CR
suffix:semicolon
r_int
id|status
suffix:semicolon
r_int
id|rc
suffix:semicolon
op_star
id|iop3xx_adap-&gt;biu-&gt;DBR
op_assign
id|iic_cook_addr
c_func
(paren
id|msg
)paren
suffix:semicolon
id|cr
op_and_assign
op_complement
(paren
id|IOP321_ICR_MSTOP
op_or
id|IOP321_ICR_NACK
)paren
suffix:semicolon
id|cr
op_or_assign
id|IOP321_ICR_MSTART
op_or
id|IOP321_ICR_TBYTE
suffix:semicolon
op_star
id|iop3xx_adap-&gt;biu-&gt;CR
op_assign
id|cr
suffix:semicolon
id|rc
op_assign
id|iop3xx_adap_wait_tx_done
c_func
(paren
id|iop3xx_adap
comma
op_amp
id|status
)paren
suffix:semicolon
multiline_comment|/* this assert fires every time, contrary to IOP manual&t;&n;&t;PASSERT( (status&amp;IOP321_ISR_UNITBUSY)!=0 );&n;*/
id|PASSERT
c_func
(paren
(paren
id|status
op_amp
id|IOP321_ISR_RXREAD
)paren
op_eq
l_int|0
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|iop3xx_adap_write_byte
r_static
r_int
id|iop3xx_adap_write_byte
c_func
(paren
r_struct
id|i2c_algo_iop3xx_data
op_star
id|iop3xx_adap
comma
r_char
id|byte
comma
r_int
id|stop
)paren
(brace
r_int
id|cr
op_assign
op_star
id|iop3xx_adap-&gt;biu-&gt;CR
suffix:semicolon
r_int
id|status
suffix:semicolon
r_int
id|rc
suffix:semicolon
op_star
id|iop3xx_adap-&gt;biu-&gt;DBR
op_assign
id|byte
suffix:semicolon
id|cr
op_and_assign
op_complement
id|IOP321_ICR_MSTART
suffix:semicolon
r_if
c_cond
(paren
id|stop
)paren
(brace
id|cr
op_or_assign
id|IOP321_ICR_MSTOP
suffix:semicolon
)brace
r_else
(brace
id|cr
op_and_assign
op_complement
id|IOP321_ICR_MSTOP
suffix:semicolon
)brace
op_star
id|iop3xx_adap-&gt;biu-&gt;CR
op_assign
id|cr
op_or_assign
id|IOP321_ICR_TBYTE
suffix:semicolon
id|rc
op_assign
id|iop3xx_adap_wait_tx_done
c_func
(paren
id|iop3xx_adap
comma
op_amp
id|status
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|iop3xx_adap_read_byte
r_static
r_int
id|iop3xx_adap_read_byte
c_func
(paren
r_struct
id|i2c_algo_iop3xx_data
op_star
id|iop3xx_adap
comma
r_char
op_star
id|byte
comma
r_int
id|stop
)paren
(brace
r_int
id|cr
op_assign
op_star
id|iop3xx_adap-&gt;biu-&gt;CR
suffix:semicolon
r_int
id|status
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|cr
op_and_assign
op_complement
id|IOP321_ICR_MSTART
suffix:semicolon
r_if
c_cond
(paren
id|stop
)paren
(brace
id|cr
op_or_assign
id|IOP321_ICR_MSTOP
op_or
id|IOP321_ICR_NACK
suffix:semicolon
)brace
r_else
(brace
id|cr
op_and_assign
op_complement
(paren
id|IOP321_ICR_MSTOP
op_or
id|IOP321_ICR_NACK
)paren
suffix:semicolon
)brace
op_star
id|iop3xx_adap-&gt;biu-&gt;CR
op_assign
id|cr
op_or_assign
id|IOP321_ICR_TBYTE
suffix:semicolon
id|rc
op_assign
id|iop3xx_adap_wait_rx_done
c_func
(paren
id|iop3xx_adap
comma
op_amp
id|status
)paren
suffix:semicolon
op_star
id|byte
op_assign
op_star
id|iop3xx_adap-&gt;biu-&gt;DBR
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|iop3xx_i2c_writebytes
r_static
r_int
id|iop3xx_i2c_writebytes
c_func
(paren
r_struct
id|i2c_adapter
op_star
id|i2c_adap
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_struct
id|i2c_algo_iop3xx_data
op_star
id|iop3xx_adap
op_assign
id|i2c_adap-&gt;algo_data
suffix:semicolon
r_int
id|ii
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|rc
op_eq
l_int|0
op_logical_and
id|ii
op_ne
id|count
suffix:semicolon
op_increment
id|ii
)paren
(brace
id|rc
op_assign
id|iop3xx_adap_write_byte
c_func
(paren
id|iop3xx_adap
comma
id|buf
(braket
id|ii
)braket
comma
id|ii
op_eq
id|count
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_return
id|rc
suffix:semicolon
)brace
DECL|function|iop3xx_i2c_readbytes
r_static
r_int
id|iop3xx_i2c_readbytes
c_func
(paren
r_struct
id|i2c_adapter
op_star
id|i2c_adap
comma
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_struct
id|i2c_algo_iop3xx_data
op_star
id|iop3xx_adap
op_assign
id|i2c_adap-&gt;algo_data
suffix:semicolon
r_int
id|ii
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|rc
op_eq
l_int|0
op_logical_and
id|ii
op_ne
id|count
suffix:semicolon
op_increment
id|ii
)paren
(brace
id|rc
op_assign
id|iop3xx_adap_read_byte
c_func
(paren
id|iop3xx_adap
comma
op_amp
id|buf
(braket
id|ii
)braket
comma
id|ii
op_eq
id|count
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*&n; * Description:  This function implements combined transactions.  Combined&n; * transactions consist of combinations of reading and writing blocks of data.&n; * FROM THE SAME ADDRESS&n; * Each transfer (i.e. a read or a write) is separated by a repeated start&n; * condition.&n; */
DECL|function|iop3xx_handle_msg
r_static
r_int
id|iop3xx_handle_msg
c_func
(paren
r_struct
id|i2c_adapter
op_star
id|i2c_adap
comma
r_struct
id|i2c_msg
op_star
id|pmsg
)paren
(brace
r_struct
id|i2c_algo_iop3xx_data
op_star
id|iop3xx_adap
op_assign
id|i2c_adap-&gt;algo_data
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|rc
op_assign
id|iop3xx_adap_send_target_slave_addr
c_func
(paren
id|iop3xx_adap
comma
id|pmsg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
(brace
r_return
id|rc
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|pmsg-&gt;flags
op_amp
id|I2C_M_RD
)paren
)paren
(brace
r_return
id|iop3xx_i2c_readbytes
c_func
(paren
id|i2c_adap
comma
id|pmsg-&gt;buf
comma
id|pmsg-&gt;len
)paren
suffix:semicolon
)brace
r_else
(brace
r_return
id|iop3xx_i2c_writebytes
c_func
(paren
id|i2c_adap
comma
id|pmsg-&gt;buf
comma
id|pmsg-&gt;len
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * master_xfer() - main read/write entry&n; */
DECL|function|iop3xx_master_xfer
r_static
r_int
id|iop3xx_master_xfer
c_func
(paren
r_struct
id|i2c_adapter
op_star
id|i2c_adap
comma
r_struct
id|i2c_msg
id|msgs
(braket
)braket
comma
r_int
id|num
)paren
(brace
r_struct
id|i2c_algo_iop3xx_data
op_star
id|iop3xx_adap
op_assign
id|i2c_adap-&gt;algo_data
suffix:semicolon
r_int
id|im
op_assign
l_int|0
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_int
id|status
suffix:semicolon
id|iop3xx_adap_wait_idle
c_func
(paren
id|iop3xx_adap
comma
op_amp
id|status
)paren
suffix:semicolon
id|iop3xx_adap_reset
c_func
(paren
id|iop3xx_adap
)paren
suffix:semicolon
id|iop3xx_adap_enable
c_func
(paren
id|iop3xx_adap
)paren
suffix:semicolon
r_for
c_loop
(paren
id|im
op_assign
l_int|0
suffix:semicolon
id|ret
op_eq
l_int|0
op_logical_and
id|im
op_ne
id|num
suffix:semicolon
op_increment
id|im
)paren
(brace
id|ret
op_assign
id|iop3xx_handle_msg
c_func
(paren
id|i2c_adap
comma
op_amp
id|msgs
(braket
id|im
)braket
)paren
suffix:semicolon
)brace
id|iop3xx_adap_transaction_cleanup
c_func
(paren
id|iop3xx_adap
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|algo_control
r_static
r_int
id|algo_control
c_func
(paren
r_struct
id|i2c_adapter
op_star
id|adapter
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|iic_func
r_static
id|u32
id|iic_func
c_func
(paren
r_struct
id|i2c_adapter
op_star
id|adap
)paren
(brace
r_return
id|I2C_FUNC_I2C
op_or
id|I2C_FUNC_SMBUS_EMUL
suffix:semicolon
)brace
multiline_comment|/* -----exported algorithm data: -------------------------------------&t;*/
DECL|variable|iic_algo
r_static
r_struct
id|i2c_algorithm
id|iic_algo
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;IOP3xx I2C algorithm&quot;
comma
dot
id|id
op_assign
id|I2C_ALGO_OCP_IOP3XX
comma
dot
id|master_xfer
op_assign
id|iop3xx_master_xfer
comma
dot
id|algo_control
op_assign
id|algo_control
comma
dot
id|functionality
op_assign
id|iic_func
comma
)brace
suffix:semicolon
multiline_comment|/* &n; * registering functions to load algorithms at runtime &n; */
DECL|function|i2c_iop3xx_add_bus
r_static
r_int
id|i2c_iop3xx_add_bus
c_func
(paren
r_struct
id|i2c_adapter
op_star
id|iic_adap
)paren
(brace
r_struct
id|i2c_algo_iop3xx_data
op_star
id|iop3xx_adap
op_assign
id|iic_adap-&gt;algo_data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|request_region
c_func
(paren
id|REGION_START
c_func
(paren
id|iop3xx_adap
)paren
comma
id|REGION_LENGTH
c_func
(paren
id|iop3xx_adap
)paren
comma
id|iic_adap-&gt;name
)paren
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|init_waitqueue_head
c_func
(paren
op_amp
id|iop3xx_adap-&gt;waitq
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|iop3xx_adap-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|iop3xx_adap-&gt;biu-&gt;irq
comma
id|iop3xx_i2c_handler
comma
multiline_comment|/* SA_SAMPLE_RANDOM */
l_int|0
comma
id|iic_adap-&gt;name
comma
id|iop3xx_adap
)paren
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* register new iic_adapter to i2c module... */
id|iic_adap-&gt;id
op_or_assign
id|iic_algo.id
suffix:semicolon
id|iic_adap-&gt;algo
op_assign
op_amp
id|iic_algo
suffix:semicolon
id|iic_adap-&gt;timeout
op_assign
l_int|100
suffix:semicolon
multiline_comment|/* default values, should&t;*/
id|iic_adap-&gt;retries
op_assign
l_int|3
suffix:semicolon
multiline_comment|/* be replaced by defines&t;*/
id|iop3xx_adap_init
c_func
(paren
id|iic_adap-&gt;algo_data
)paren
suffix:semicolon
id|i2c_add_adapter
c_func
(paren
id|iic_adap
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|i2c_iop3xx_del_bus
r_static
r_int
id|i2c_iop3xx_del_bus
c_func
(paren
r_struct
id|i2c_adapter
op_star
id|iic_adap
)paren
(brace
r_struct
id|i2c_algo_iop3xx_data
op_star
id|iop3xx_adap
op_assign
id|iic_adap-&gt;algo_data
suffix:semicolon
id|iop3xx_adap_final_cleanup
c_func
(paren
id|iop3xx_adap
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|iop3xx_adap-&gt;biu-&gt;irq
comma
id|iop3xx_adap
)paren
suffix:semicolon
id|release_region
c_func
(paren
id|REGION_START
c_func
(paren
id|iop3xx_adap
)paren
comma
id|REGION_LENGTH
c_func
(paren
id|iop3xx_adap
)paren
)paren
suffix:semicolon
r_return
id|i2c_del_adapter
c_func
(paren
id|iic_adap
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_ARCH_IOP321
DECL|variable|biu0
r_static
r_struct
id|iop3xx_biu
id|biu0
op_assign
(brace
dot
id|CR
op_assign
id|IOP321_ICR0
comma
dot
id|SR
op_assign
id|IOP321_ISR0
comma
dot
id|SAR
op_assign
id|IOP321_ISAR0
comma
dot
id|DBR
op_assign
id|IOP321_IDBR0
comma
dot
id|BMR
op_assign
id|IOP321_IBMR0
comma
dot
id|irq
op_assign
id|IRQ_IOP321_I2C_0
)brace
suffix:semicolon
DECL|variable|biu1
r_static
r_struct
id|iop3xx_biu
id|biu1
op_assign
(brace
dot
id|CR
op_assign
id|IOP321_ICR1
comma
dot
id|SR
op_assign
id|IOP321_ISR1
comma
dot
id|SAR
op_assign
id|IOP321_ISAR1
comma
dot
id|DBR
op_assign
id|IOP321_IDBR1
comma
dot
id|BMR
op_assign
id|IOP321_IBMR1
comma
dot
id|irq
op_assign
id|IRQ_IOP321_I2C_1
)brace
suffix:semicolon
DECL|macro|ADAPTER_NAME_ROOT
mdefine_line|#define ADAPTER_NAME_ROOT &quot;IOP321 i2c biu adapter &quot;
macro_line|#else
macro_line|#error Please define the BIU struct iop3xx_biu for your processor arch
macro_line|#endif
DECL|variable|algo_iop3xx_data0
r_static
r_struct
id|i2c_algo_iop3xx_data
id|algo_iop3xx_data0
op_assign
(brace
dot
id|channel
op_assign
l_int|0
comma
dot
id|biu
op_assign
op_amp
id|biu0
comma
dot
id|timeout
op_assign
l_int|1
op_star
id|HZ
)brace
suffix:semicolon
DECL|variable|algo_iop3xx_data1
r_static
r_struct
id|i2c_algo_iop3xx_data
id|algo_iop3xx_data1
op_assign
(brace
dot
id|channel
op_assign
l_int|1
comma
dot
id|biu
op_assign
op_amp
id|biu1
comma
dot
id|timeout
op_assign
l_int|1
op_star
id|HZ
)brace
suffix:semicolon
DECL|variable|iop3xx_ops0
r_static
r_struct
id|i2c_adapter
id|iop3xx_ops0
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|name
op_assign
id|ADAPTER_NAME_ROOT
l_string|&quot;0&quot;
comma
dot
id|id
op_assign
id|I2C_HW_IOP321
comma
dot
id|algo_data
op_assign
op_amp
id|algo_iop3xx_data0
)brace
suffix:semicolon
DECL|variable|iop3xx_ops1
r_static
r_struct
id|i2c_adapter
id|iop3xx_ops1
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|name
op_assign
id|ADAPTER_NAME_ROOT
l_string|&quot;1&quot;
comma
dot
id|id
op_assign
id|I2C_HW_IOP321
comma
dot
id|algo_data
op_assign
op_amp
id|algo_iop3xx_data1
)brace
suffix:semicolon
DECL|function|i2c_iop3xx_init
r_static
r_int
id|__init
id|i2c_iop3xx_init
(paren
r_void
)paren
(brace
r_return
id|i2c_iop3xx_add_bus
c_func
(paren
op_amp
id|iop3xx_ops0
)paren
op_logical_or
id|i2c_iop3xx_add_bus
c_func
(paren
op_amp
id|iop3xx_ops1
)paren
suffix:semicolon
)brace
DECL|function|i2c_iop3xx_exit
r_static
r_void
id|__exit
id|i2c_iop3xx_exit
(paren
r_void
)paren
(brace
id|i2c_iop3xx_del_bus
c_func
(paren
op_amp
id|iop3xx_ops0
)paren
suffix:semicolon
id|i2c_iop3xx_del_bus
c_func
(paren
op_amp
id|iop3xx_ops1
)paren
suffix:semicolon
)brace
DECL|variable|i2c_iop3xx_init
id|module_init
(paren
id|i2c_iop3xx_init
)paren
suffix:semicolon
DECL|variable|i2c_iop3xx_exit
id|module_exit
(paren
id|i2c_iop3xx_exit
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;D-TACQ Solutions Ltd &lt;www.d-tacq.com&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;IOP3xx iic algorithm and driver&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|i2c_debug
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|i2c_debug
comma
l_string|&quot;debug level - 0 off; 1 normal; 2,3 more verbose; 9 iic-protocol&quot;
)paren
suffix:semicolon
eof
