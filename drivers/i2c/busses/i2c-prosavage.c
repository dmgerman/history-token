multiline_comment|/*&n; *    kernel/busses/i2c-prosavage.c&n; *&n; *    i2c bus driver for S3/VIA 8365/8375 graphics processor.&n; *    Copyright (c) 2003 Henk Vergonet &lt;henk@god.dyndns.org&gt;&n; *    Based on code written by:&n; *&t;Frodo Looijaard &lt;frodol@dds.nl&gt;,&n; *&t;Philip Edelbrock &lt;phil@netroedge.com&gt;,&n; *&t;Ralph Metzler &lt;rjkm@thp.uni-koeln.de&gt;, and&n; *&t;Mark D. Studebaker &lt;mdsxyz123@yahoo.com&gt;&n; *&t;Simon Vogl&n; *&t;and others&n; *&n; *    Please read the lm_sensors documentation for details on use.&n; *&n; *    This program is free software; you can redistribute it and/or modify&n; *    it under the terms of the GNU General Public License as published by&n; *    the Free Software Foundation; either version 2 of the License, or&n; *    (at your option) any later version.&n; *&n; *    This program is distributed in the hope that it will be useful,&n; *    but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *    GNU General Public License for more details.&n; *&n; *    You should have received a copy of the GNU General Public License&n; *    along with this program; if not, write to the Free Software&n; *    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; */
multiline_comment|/*  18-05-2003 HVE - created&n; *  14-06-2003 HVE - adapted for lm_sensors2&n; *  17-06-2003 HVE - linux 2.5.xx compatible&n; *  18-06-2003 HVE - codingstyle&n; *  21-06-2003 HVE - compatibility lm_sensors2 and linux 2.5.xx&n; *&t;&t;     codingstyle, mmio enabled&n; *&n; *  This driver interfaces to the I2C bus of the VIA north bridge embedded&n; *  ProSavage4/8 devices. Usefull for gaining access to the TV Encoder chips.&n; *&n; *  Graphics cores:&n; *   S3/VIA KM266/VT8375 aka ProSavage8&n; *   S3/VIA KM133/VT8365 aka Savage4&n; *&n; *  Two serial busses are implemented:&n; *   SERIAL1 - I2C serial communications interface&n; *   SERIAL2 - DDC2 monitor communications interface&n; *&n; *  Tested on a FX41 mainboard, see http://www.shuttle.com&n; * &n; *&n; *  TODO:&n; *  - integration with prosavage framebuffer device&n; *    (Additional documentation needed :(&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/i2c.h&gt;
macro_line|#include &lt;linux/i2c-algo-bit.h&gt;
macro_line|#include &lt;asm/io.h&gt;
multiline_comment|/*&n; * driver configuration&n; */
DECL|macro|MAX_BUSSES
mdefine_line|#define MAX_BUSSES&t;2
DECL|struct|s_i2c_bus
r_struct
id|s_i2c_bus
(brace
DECL|member|mmvga
r_void
id|__iomem
op_star
id|mmvga
suffix:semicolon
DECL|member|i2c_reg
r_int
id|i2c_reg
suffix:semicolon
DECL|member|adap_ok
r_int
id|adap_ok
suffix:semicolon
DECL|member|adap
r_struct
id|i2c_adapter
id|adap
suffix:semicolon
DECL|member|algo
r_struct
id|i2c_algo_bit_data
id|algo
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|s_i2c_chip
r_struct
id|s_i2c_chip
(brace
DECL|member|mmio
r_void
id|__iomem
op_star
id|mmio
suffix:semicolon
DECL|member|i2c_bus
r_struct
id|s_i2c_bus
id|i2c_bus
(braket
id|MAX_BUSSES
)braket
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/*&n; * i2c configuration&n; */
macro_line|#ifndef I2C_HW_B_S3VIA
DECL|macro|I2C_HW_B_S3VIA
mdefine_line|#define I2C_HW_B_S3VIA&t;0x18&t;/* S3VIA ProSavage adapter&t;&t;*/
macro_line|#endif
multiline_comment|/* delays */
DECL|macro|CYCLE_DELAY
mdefine_line|#define CYCLE_DELAY&t;10
DECL|macro|TIMEOUT
mdefine_line|#define TIMEOUT&t;&t;(HZ / 2)
multiline_comment|/* &n; * S3/VIA 8365/8375 registers&n; */
DECL|macro|VGA_CR_IX
mdefine_line|#define VGA_CR_IX&t;0x3d4
DECL|macro|VGA_CR_DATA
mdefine_line|#define VGA_CR_DATA&t;0x3d5
DECL|macro|CR_SERIAL1
mdefine_line|#define CR_SERIAL1&t;0xa0&t;/* I2C serial communications interface */
DECL|macro|MM_SERIAL1
mdefine_line|#define MM_SERIAL1&t;0xff20
DECL|macro|CR_SERIAL2
mdefine_line|#define CR_SERIAL2&t;0xb1&t;/* DDC2 monitor communications interface */
multiline_comment|/* based on vt8365 documentation */
DECL|macro|I2C_ENAB
mdefine_line|#define I2C_ENAB&t;0x10
DECL|macro|I2C_SCL_OUT
mdefine_line|#define I2C_SCL_OUT&t;0x01
DECL|macro|I2C_SDA_OUT
mdefine_line|#define I2C_SDA_OUT&t;0x02
DECL|macro|I2C_SCL_IN
mdefine_line|#define I2C_SCL_IN&t;0x04
DECL|macro|I2C_SDA_IN
mdefine_line|#define I2C_SDA_IN&t;0x08
DECL|macro|SET_CR_IX
mdefine_line|#define SET_CR_IX(p, val)&t;writeb((val), (p)-&gt;mmvga + VGA_CR_IX)
DECL|macro|SET_CR_DATA
mdefine_line|#define SET_CR_DATA(p, val)&t;writeb((val), (p)-&gt;mmvga + VGA_CR_DATA)
DECL|macro|GET_CR_DATA
mdefine_line|#define GET_CR_DATA(p)&t;&t;readb((p)-&gt;mmvga + VGA_CR_DATA)
multiline_comment|/*&n; * Serial bus line handling&n; *&n; * serial communications register as parameter in private data&n; *&n; * TODO: locks with other code sections accessing video registers?&n; */
DECL|function|bit_s3via_setscl
r_static
r_void
id|bit_s3via_setscl
c_func
(paren
r_void
op_star
id|bus
comma
r_int
id|val
)paren
(brace
r_struct
id|s_i2c_bus
op_star
id|p
op_assign
(paren
r_struct
id|s_i2c_bus
op_star
)paren
id|bus
suffix:semicolon
r_int
r_int
id|r
suffix:semicolon
id|SET_CR_IX
c_func
(paren
id|p
comma
id|p-&gt;i2c_reg
)paren
suffix:semicolon
id|r
op_assign
id|GET_CR_DATA
c_func
(paren
id|p
)paren
suffix:semicolon
id|r
op_or_assign
id|I2C_ENAB
suffix:semicolon
r_if
c_cond
(paren
id|val
)paren
(brace
id|r
op_or_assign
id|I2C_SCL_OUT
suffix:semicolon
)brace
r_else
(brace
id|r
op_and_assign
op_complement
id|I2C_SCL_OUT
suffix:semicolon
)brace
id|SET_CR_DATA
c_func
(paren
id|p
comma
id|r
)paren
suffix:semicolon
)brace
DECL|function|bit_s3via_setsda
r_static
r_void
id|bit_s3via_setsda
c_func
(paren
r_void
op_star
id|bus
comma
r_int
id|val
)paren
(brace
r_struct
id|s_i2c_bus
op_star
id|p
op_assign
(paren
r_struct
id|s_i2c_bus
op_star
)paren
id|bus
suffix:semicolon
r_int
r_int
id|r
suffix:semicolon
id|SET_CR_IX
c_func
(paren
id|p
comma
id|p-&gt;i2c_reg
)paren
suffix:semicolon
id|r
op_assign
id|GET_CR_DATA
c_func
(paren
id|p
)paren
suffix:semicolon
id|r
op_or_assign
id|I2C_ENAB
suffix:semicolon
r_if
c_cond
(paren
id|val
)paren
(brace
id|r
op_or_assign
id|I2C_SDA_OUT
suffix:semicolon
)brace
r_else
(brace
id|r
op_and_assign
op_complement
id|I2C_SDA_OUT
suffix:semicolon
)brace
id|SET_CR_DATA
c_func
(paren
id|p
comma
id|r
)paren
suffix:semicolon
)brace
DECL|function|bit_s3via_getscl
r_static
r_int
id|bit_s3via_getscl
c_func
(paren
r_void
op_star
id|bus
)paren
(brace
r_struct
id|s_i2c_bus
op_star
id|p
op_assign
(paren
r_struct
id|s_i2c_bus
op_star
)paren
id|bus
suffix:semicolon
id|SET_CR_IX
c_func
(paren
id|p
comma
id|p-&gt;i2c_reg
)paren
suffix:semicolon
r_return
(paren
l_int|0
op_ne
(paren
id|GET_CR_DATA
c_func
(paren
id|p
)paren
op_amp
id|I2C_SCL_IN
)paren
)paren
suffix:semicolon
)brace
DECL|function|bit_s3via_getsda
r_static
r_int
id|bit_s3via_getsda
c_func
(paren
r_void
op_star
id|bus
)paren
(brace
r_struct
id|s_i2c_bus
op_star
id|p
op_assign
(paren
r_struct
id|s_i2c_bus
op_star
)paren
id|bus
suffix:semicolon
id|SET_CR_IX
c_func
(paren
id|p
comma
id|p-&gt;i2c_reg
)paren
suffix:semicolon
r_return
(paren
l_int|0
op_ne
(paren
id|GET_CR_DATA
c_func
(paren
id|p
)paren
op_amp
id|I2C_SDA_IN
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * adapter initialisation&n; */
DECL|function|i2c_register_bus
r_static
r_int
id|i2c_register_bus
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_struct
id|s_i2c_bus
op_star
id|p
comma
r_void
id|__iomem
op_star
id|mmvga
comma
id|u32
id|i2c_reg
)paren
(brace
r_int
id|ret
suffix:semicolon
id|p-&gt;adap.owner
op_assign
id|THIS_MODULE
suffix:semicolon
id|p-&gt;adap.id
op_assign
id|I2C_HW_B_S3VIA
suffix:semicolon
id|p-&gt;adap.algo_data
op_assign
op_amp
id|p-&gt;algo
suffix:semicolon
id|p-&gt;adap.dev.parent
op_assign
op_amp
id|dev-&gt;dev
suffix:semicolon
id|p-&gt;algo.setsda
op_assign
id|bit_s3via_setsda
suffix:semicolon
id|p-&gt;algo.setscl
op_assign
id|bit_s3via_setscl
suffix:semicolon
id|p-&gt;algo.getsda
op_assign
id|bit_s3via_getsda
suffix:semicolon
id|p-&gt;algo.getscl
op_assign
id|bit_s3via_getscl
suffix:semicolon
id|p-&gt;algo.udelay
op_assign
id|CYCLE_DELAY
suffix:semicolon
id|p-&gt;algo.mdelay
op_assign
id|CYCLE_DELAY
suffix:semicolon
id|p-&gt;algo.timeout
op_assign
id|TIMEOUT
suffix:semicolon
id|p-&gt;algo.data
op_assign
id|p
suffix:semicolon
id|p-&gt;mmvga
op_assign
id|mmvga
suffix:semicolon
id|p-&gt;i2c_reg
op_assign
id|i2c_reg
suffix:semicolon
id|ret
op_assign
id|i2c_bit_add_bus
c_func
(paren
op_amp
id|p-&gt;adap
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
r_return
id|ret
suffix:semicolon
)brace
id|p-&gt;adap_ok
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Cleanup stuff&n; */
DECL|function|prosavage_remove
r_static
r_void
id|prosavage_remove
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
r_struct
id|s_i2c_chip
op_star
id|chip
suffix:semicolon
r_int
id|i
comma
id|ret
suffix:semicolon
id|chip
op_assign
(paren
r_struct
id|s_i2c_chip
op_star
)paren
id|pci_get_drvdata
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|chip
)paren
(brace
r_return
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
id|MAX_BUSSES
op_minus
l_int|1
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
r_if
c_cond
(paren
id|chip-&gt;i2c_bus
(braket
id|i
)braket
dot
id|adap_ok
op_eq
l_int|0
)paren
r_continue
suffix:semicolon
id|ret
op_assign
id|i2c_bit_del_bus
c_func
(paren
op_amp
id|chip-&gt;i2c_bus
(braket
id|i
)braket
dot
id|adap
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|dev-&gt;dev
comma
l_string|&quot;%s not removed&bslash;n&quot;
comma
id|chip-&gt;i2c_bus
(braket
id|i
)braket
dot
id|adap.name
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|chip-&gt;mmio
)paren
(brace
id|iounmap
c_func
(paren
id|chip-&gt;mmio
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|chip
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Detect chip and initialize it&n; */
DECL|function|prosavage_probe
r_static
r_int
id|__devinit
id|prosavage_probe
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_const
r_struct
id|pci_device_id
op_star
id|id
)paren
(brace
r_int
id|ret
suffix:semicolon
r_int
r_int
id|base
comma
id|len
suffix:semicolon
r_struct
id|s_i2c_chip
op_star
id|chip
suffix:semicolon
r_struct
id|s_i2c_bus
op_star
id|bus
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|dev
comma
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|s_i2c_chip
)paren
comma
id|GFP_KERNEL
)paren
)paren
suffix:semicolon
id|chip
op_assign
(paren
r_struct
id|s_i2c_chip
op_star
)paren
id|pci_get_drvdata
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chip
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|chip
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|s_i2c_chip
)paren
)paren
suffix:semicolon
id|base
op_assign
id|dev-&gt;resource
(braket
l_int|0
)braket
dot
id|start
op_amp
id|PCI_BASE_ADDRESS_MEM_MASK
suffix:semicolon
id|len
op_assign
id|dev-&gt;resource
(braket
l_int|0
)braket
dot
id|end
op_minus
id|base
op_plus
l_int|1
suffix:semicolon
id|chip-&gt;mmio
op_assign
id|ioremap_nocache
c_func
(paren
id|base
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chip-&gt;mmio
op_eq
l_int|NULL
)paren
(brace
id|dev_err
c_func
(paren
op_amp
id|dev-&gt;dev
comma
l_string|&quot;ioremap failed&bslash;n&quot;
)paren
suffix:semicolon
id|prosavage_remove
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Chip initialisation&n;&t; */
multiline_comment|/* Unlock Extended IO Space ??? */
multiline_comment|/*&n;&t; * i2c bus registration&n;&t; */
id|bus
op_assign
op_amp
id|chip-&gt;i2c_bus
(braket
l_int|0
)braket
suffix:semicolon
id|snprintf
c_func
(paren
id|bus-&gt;adap.name
comma
r_sizeof
(paren
id|bus-&gt;adap.name
)paren
comma
l_string|&quot;ProSavage I2C bus at %02x:%02x.%x&quot;
comma
id|dev-&gt;bus-&gt;number
comma
id|PCI_SLOT
c_func
(paren
id|dev-&gt;devfn
)paren
comma
id|PCI_FUNC
c_func
(paren
id|dev-&gt;devfn
)paren
)paren
suffix:semicolon
id|ret
op_assign
id|i2c_register_bus
c_func
(paren
id|dev
comma
id|bus
comma
id|chip-&gt;mmio
op_plus
l_int|0x8000
comma
id|CR_SERIAL1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
r_goto
id|err_adap
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * ddc bus registration&n;&t; */
id|bus
op_assign
op_amp
id|chip-&gt;i2c_bus
(braket
l_int|1
)braket
suffix:semicolon
id|snprintf
c_func
(paren
id|bus-&gt;adap.name
comma
r_sizeof
(paren
id|bus-&gt;adap.name
)paren
comma
l_string|&quot;ProSavage DDC bus at %02x:%02x.%x&quot;
comma
id|dev-&gt;bus-&gt;number
comma
id|PCI_SLOT
c_func
(paren
id|dev-&gt;devfn
)paren
comma
id|PCI_FUNC
c_func
(paren
id|dev-&gt;devfn
)paren
)paren
suffix:semicolon
id|ret
op_assign
id|i2c_register_bus
c_func
(paren
id|dev
comma
id|bus
comma
id|chip-&gt;mmio
op_plus
l_int|0x8000
comma
id|CR_SERIAL2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
r_goto
id|err_adap
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
id|err_adap
suffix:colon
id|dev_err
c_func
(paren
op_amp
id|dev-&gt;dev
comma
l_string|&quot;%s failed&bslash;n&quot;
comma
id|bus-&gt;adap.name
)paren
suffix:semicolon
id|prosavage_remove
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n; * Data for PCI driver interface&n; */
DECL|variable|prosavage_pci_tbl
r_static
r_struct
id|pci_device_id
id|prosavage_pci_tbl
(braket
)braket
op_assign
(brace
(brace
id|PCI_DEVICE
c_func
(paren
id|PCI_VENDOR_ID_S3
comma
id|PCI_DEVICE_ID_S3_SAVAGE4
)paren
)brace
comma
(brace
id|PCI_DEVICE
c_func
(paren
id|PCI_VENDOR_ID_S3
comma
id|PCI_DEVICE_ID_S3_PROSAVAGE8
)paren
)brace
comma
(brace
l_int|0
comma
)brace
comma
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
(paren
id|pci
comma
id|prosavage_pci_tbl
)paren
suffix:semicolon
DECL|variable|prosavage_driver
r_static
r_struct
id|pci_driver
id|prosavage_driver
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;prosavage_smbus&quot;
comma
dot
id|id_table
op_assign
id|prosavage_pci_tbl
comma
dot
id|probe
op_assign
id|prosavage_probe
comma
dot
id|remove
op_assign
id|prosavage_remove
comma
)brace
suffix:semicolon
DECL|function|i2c_prosavage_init
r_static
r_int
id|__init
id|i2c_prosavage_init
c_func
(paren
r_void
)paren
(brace
r_return
id|pci_register_driver
c_func
(paren
op_amp
id|prosavage_driver
)paren
suffix:semicolon
)brace
DECL|function|i2c_prosavage_exit
r_static
r_void
id|__exit
id|i2c_prosavage_exit
c_func
(paren
r_void
)paren
(brace
id|pci_unregister_driver
c_func
(paren
op_amp
id|prosavage_driver
)paren
suffix:semicolon
)brace
id|MODULE_DEVICE_TABLE
c_func
(paren
id|pci
comma
id|prosavage_pci_tbl
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Henk Vergonet&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;ProSavage VIA 8365/8375 smbus driver&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
DECL|variable|i2c_prosavage_init
id|module_init
(paren
id|i2c_prosavage_init
)paren
suffix:semicolon
DECL|variable|i2c_prosavage_exit
id|module_exit
(paren
id|i2c_prosavage_exit
)paren
suffix:semicolon
eof
