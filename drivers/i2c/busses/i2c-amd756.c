multiline_comment|/*&n;    amd756.c - Part of lm_sensors, Linux kernel modules for hardware&n;              monitoring&n;&n;    Copyright (c) 1999-2002 Merlin Hughes &lt;merlin@merlin.org&gt;&n;&n;    Shamelessly ripped from i2c-piix4.c:&n;&n;    Copyright (c) 1998, 1999  Frodo Looijaard &lt;frodol@dds.nl&gt; and&n;    Philip Edelbrock &lt;phil@netroedge.com&gt;&n;&n;    This program is free software; you can redistribute it and/or modify&n;    it under the terms of the GNU General Public License as published by&n;    the Free Software Foundation; either version 2 of the License, or&n;    (at your option) any later version.&n;&n;    This program is distributed in the hope that it will be useful,&n;    but WITHOUT ANY WARRANTY; without even the implied warranty of&n;    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n;    GNU General Public License for more details.&n;&n;    You should have received a copy of the GNU General Public License&n;    along with this program; if not, write to the Free Software&n;    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n;*/
multiline_comment|/*&n;    2002-04-08: Added nForce support. (Csaba Halasz)&n;    2002-10-03: Fixed nForce PnP I/O port. (Michael Steil)&n;*/
multiline_comment|/*&n;   Supports AMD756, AMD766, AMD768 and nVidia nForce&n;   Note: we assume there can only be one device, with one SMBus interface.&n;*/
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/stddef.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/i2c.h&gt;
macro_line|#include &lt;linux/init.h&gt;
DECL|struct|sd
r_struct
id|sd
(brace
DECL|member|vendor
r_const
r_int
r_int
id|vendor
suffix:semicolon
DECL|member|device
r_const
r_int
r_int
id|device
suffix:semicolon
DECL|member|function
r_const
r_int
r_int
id|function
suffix:semicolon
DECL|member|name
r_const
r_char
op_star
id|name
suffix:semicolon
DECL|member|amdsetup
r_int
id|amdsetup
suffix:colon
l_int|1
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|supported
r_static
r_struct
id|sd
id|supported
(braket
)braket
op_assign
(brace
(brace
id|PCI_VENDOR_ID_AMD
comma
id|PCI_DEVICE_ID_AMD_VIPER_740B
comma
l_int|3
comma
l_string|&quot;AMD756&quot;
comma
l_int|1
)brace
comma
(brace
id|PCI_VENDOR_ID_AMD
comma
id|PCI_DEVICE_ID_AMD_VIPER_7413
comma
l_int|3
comma
l_string|&quot;AMD766&quot;
comma
l_int|1
)brace
comma
(brace
id|PCI_VENDOR_ID_AMD
comma
l_int|0x7443
comma
l_int|3
comma
l_string|&quot;AMD768&quot;
comma
l_int|1
)brace
comma
(brace
id|PCI_VENDOR_ID_NVIDIA
comma
l_int|0x01B4
comma
l_int|1
comma
l_string|&quot;nVidia nForce&quot;
comma
l_int|0
)brace
comma
(brace
l_int|0
comma
l_int|0
comma
l_int|0
)brace
)brace
suffix:semicolon
multiline_comment|/* AMD756 SMBus address offsets */
DECL|macro|SMB_ADDR_OFFSET
mdefine_line|#define SMB_ADDR_OFFSET        0xE0
DECL|macro|SMB_IOSIZE
mdefine_line|#define SMB_IOSIZE             16
DECL|macro|SMB_GLOBAL_STATUS
mdefine_line|#define SMB_GLOBAL_STATUS      (0x0 + amd756_smba)
DECL|macro|SMB_GLOBAL_ENABLE
mdefine_line|#define SMB_GLOBAL_ENABLE      (0x2 + amd756_smba)
DECL|macro|SMB_HOST_ADDRESS
mdefine_line|#define SMB_HOST_ADDRESS       (0x4 + amd756_smba)
DECL|macro|SMB_HOST_DATA
mdefine_line|#define SMB_HOST_DATA          (0x6 + amd756_smba)
DECL|macro|SMB_HOST_COMMAND
mdefine_line|#define SMB_HOST_COMMAND       (0x8 + amd756_smba)
DECL|macro|SMB_HOST_BLOCK_DATA
mdefine_line|#define SMB_HOST_BLOCK_DATA    (0x9 + amd756_smba)
DECL|macro|SMB_HAS_DATA
mdefine_line|#define SMB_HAS_DATA           (0xA + amd756_smba)
DECL|macro|SMB_HAS_DEVICE_ADDRESS
mdefine_line|#define SMB_HAS_DEVICE_ADDRESS (0xC + amd756_smba)
DECL|macro|SMB_HAS_HOST_ADDRESS
mdefine_line|#define SMB_HAS_HOST_ADDRESS   (0xE + amd756_smba)
DECL|macro|SMB_SNOOP_ADDRESS
mdefine_line|#define SMB_SNOOP_ADDRESS      (0xF + amd756_smba)
multiline_comment|/* PCI Address Constants */
multiline_comment|/* address of I/O space */
DECL|macro|SMBBA
mdefine_line|#define SMBBA     0x058&t;&t;/* mh */
DECL|macro|SMBBANFORCE
mdefine_line|#define SMBBANFORCE     0x014
multiline_comment|/* general configuration */
DECL|macro|SMBGCFG
mdefine_line|#define SMBGCFG   0x041&t;&t;/* mh */
multiline_comment|/* silicon revision code */
DECL|macro|SMBREV
mdefine_line|#define SMBREV    0x008
multiline_comment|/* Other settings */
DECL|macro|MAX_TIMEOUT
mdefine_line|#define MAX_TIMEOUT 500
multiline_comment|/* AMD756 constants */
DECL|macro|AMD756_QUICK
mdefine_line|#define AMD756_QUICK        0x00
DECL|macro|AMD756_BYTE
mdefine_line|#define AMD756_BYTE         0x01
DECL|macro|AMD756_BYTE_DATA
mdefine_line|#define AMD756_BYTE_DATA    0x02
DECL|macro|AMD756_WORD_DATA
mdefine_line|#define AMD756_WORD_DATA    0x03
DECL|macro|AMD756_PROCESS_CALL
mdefine_line|#define AMD756_PROCESS_CALL 0x04
DECL|macro|AMD756_BLOCK_DATA
mdefine_line|#define AMD756_BLOCK_DATA   0x05
multiline_comment|/* insmod parameters */
r_int
id|__init
id|i2c_amd756_init
c_func
(paren
r_void
)paren
suffix:semicolon
r_void
id|__exit
id|i2c_amd756_exit
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|amd756_cleanup
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|amd756_setup
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
id|s32
id|amd756_access
c_func
(paren
r_struct
id|i2c_adapter
op_star
id|adap
comma
id|u16
id|addr
comma
r_int
r_int
id|flags
comma
r_char
id|read_write
comma
id|u8
id|command
comma
r_int
id|size
comma
r_union
id|i2c_smbus_data
op_star
id|data
)paren
suffix:semicolon
r_static
r_void
id|amd756_do_pause
c_func
(paren
r_int
r_int
id|amount
)paren
suffix:semicolon
r_static
r_void
id|amd756_abort
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|amd756_transaction
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|amd756_inc
c_func
(paren
r_struct
id|i2c_adapter
op_star
id|adapter
)paren
suffix:semicolon
r_static
r_void
id|amd756_dec
c_func
(paren
r_struct
id|i2c_adapter
op_star
id|adapter
)paren
suffix:semicolon
r_static
id|u32
id|amd756_func
c_func
(paren
r_struct
id|i2c_adapter
op_star
id|adapter
)paren
suffix:semicolon
DECL|variable|smbus_algorithm
r_static
r_struct
id|i2c_algorithm
id|smbus_algorithm
op_assign
(brace
multiline_comment|/* name */
l_string|&quot;Non-I2C SMBus adapter&quot;
comma
multiline_comment|/* id */
id|I2C_ALGO_SMBUS
comma
multiline_comment|/* master_xfer */
l_int|NULL
comma
multiline_comment|/* smbus_access */
id|amd756_access
comma
multiline_comment|/* slave;_send */
l_int|NULL
comma
multiline_comment|/* slave_rcv */
l_int|NULL
comma
multiline_comment|/* algo_control */
l_int|NULL
comma
multiline_comment|/* functionality */
id|amd756_func
comma
)brace
suffix:semicolon
DECL|variable|amd756_adapter
r_static
r_struct
id|i2c_adapter
id|amd756_adapter
op_assign
(brace
l_string|&quot;unset&quot;
comma
id|I2C_ALGO_SMBUS
op_or
id|I2C_HW_SMBUS_AMD756
comma
op_amp
id|smbus_algorithm
comma
l_int|NULL
comma
id|amd756_inc
comma
id|amd756_dec
comma
l_int|NULL
comma
l_int|NULL
comma
)brace
suffix:semicolon
DECL|variable|amd756_initialized
r_static
r_int
id|__initdata
id|amd756_initialized
suffix:semicolon
DECL|variable|amd756_sd
r_static
r_struct
id|sd
op_star
id|amd756_sd
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|amd756_smba
r_static
r_int
r_int
id|amd756_smba
op_assign
l_int|0
suffix:semicolon
DECL|function|amd756_setup
r_int
id|amd756_setup
c_func
(paren
r_void
)paren
(brace
r_int
r_char
id|temp
suffix:semicolon
r_struct
id|sd
op_star
id|currdev
suffix:semicolon
r_struct
id|pci_dev
op_star
id|AMD756_dev
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|pci_present
c_func
(paren
)paren
op_eq
l_int|0
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* Look for a supported chip */
r_for
c_loop
(paren
id|currdev
op_assign
id|supported
suffix:semicolon
id|currdev-&gt;vendor
suffix:semicolon
)paren
(brace
id|AMD756_dev
op_assign
id|pci_find_device
c_func
(paren
id|currdev-&gt;vendor
comma
id|currdev-&gt;device
comma
id|AMD756_dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|AMD756_dev
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|PCI_FUNC
c_func
(paren
id|AMD756_dev-&gt;devfn
)paren
op_eq
id|currdev-&gt;function
)paren
r_break
suffix:semicolon
)brace
r_else
(brace
id|currdev
op_increment
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|AMD756_dev
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
l_string|&quot;i2c-amd756.o: Error: No AMD756 or compatible device detected!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;i2c-amd756.o: Found %s SMBus controller.&bslash;n&quot;
comma
id|currdev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|currdev-&gt;amdsetup
)paren
(brace
id|pci_read_config_byte
c_func
(paren
id|AMD756_dev
comma
id|SMBGCFG
comma
op_amp
id|temp
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|temp
op_amp
l_int|128
)paren
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;i2c-amd756.o: Error: SMBus controller I/O not enabled!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* Determine the address of the SMBus areas */
multiline_comment|/* Technically it is a dword but... */
id|pci_read_config_word
c_func
(paren
id|AMD756_dev
comma
id|SMBBA
comma
op_amp
id|amd756_smba
)paren
suffix:semicolon
id|amd756_smba
op_and_assign
l_int|0xff00
suffix:semicolon
id|amd756_smba
op_add_assign
id|SMB_ADDR_OFFSET
suffix:semicolon
)brace
r_else
(brace
id|pci_read_config_word
c_func
(paren
id|AMD756_dev
comma
id|SMBBANFORCE
comma
op_amp
id|amd756_smba
)paren
suffix:semicolon
id|amd756_smba
op_and_assign
l_int|0xfffc
suffix:semicolon
)brace
r_if
c_cond
(paren
id|amd756_smba
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;i2c-amd756.o: Error: SMB base address uninitialized&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_if
c_cond
(paren
id|check_region
c_func
(paren
id|amd756_smba
comma
id|SMB_IOSIZE
)paren
)paren
(brace
id|printk
(paren
l_string|&quot;i2c-amd756.o: SMB region 0x%x already in use!&bslash;n&quot;
comma
id|amd756_smba
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/* Everything is happy, let&squot;s grab the memory and set things up. */
id|request_region
c_func
(paren
id|amd756_smba
comma
id|SMB_IOSIZE
comma
l_string|&quot;amd756-smbus&quot;
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
id|pci_read_config_byte
c_func
(paren
id|AMD756_dev
comma
id|SMBREV
comma
op_amp
id|temp
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;i2c-amd756.o: SMBREV = 0x%X&bslash;n&quot;
comma
id|temp
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;i2c-amd756.o: AMD756_smba = 0x%X&bslash;n&quot;
comma
id|amd756_smba
)paren
suffix:semicolon
macro_line|#endif&t;&t;&t;&t;/* DEBUG */
multiline_comment|/* store struct sd * for future reference */
id|amd756_sd
op_assign
id|currdev
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* &n;  SMBUS event = I/O 28-29 bit 11&n;     see E0 for the status bits and enabled in E2&n;     &n;*/
multiline_comment|/* Internally used pause function */
DECL|function|amd756_do_pause
r_void
id|amd756_do_pause
c_func
(paren
r_int
r_int
id|amount
)paren
(brace
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|amount
)paren
suffix:semicolon
)brace
DECL|macro|GS_ABRT_STS
mdefine_line|#define GS_ABRT_STS (1 &lt;&lt; 0)
DECL|macro|GS_COL_STS
mdefine_line|#define GS_COL_STS (1 &lt;&lt; 1)
DECL|macro|GS_PRERR_STS
mdefine_line|#define GS_PRERR_STS (1 &lt;&lt; 2)
DECL|macro|GS_HST_STS
mdefine_line|#define GS_HST_STS (1 &lt;&lt; 3)
DECL|macro|GS_HCYC_STS
mdefine_line|#define GS_HCYC_STS (1 &lt;&lt; 4)
DECL|macro|GS_TO_STS
mdefine_line|#define GS_TO_STS (1 &lt;&lt; 5)
DECL|macro|GS_SMB_STS
mdefine_line|#define GS_SMB_STS (1 &lt;&lt; 11)
DECL|macro|GS_CLEAR_STS
mdefine_line|#define GS_CLEAR_STS (GS_ABRT_STS | GS_COL_STS | GS_PRERR_STS | &bslash;&n;  GS_HCYC_STS | GS_TO_STS )
DECL|macro|GE_CYC_TYPE_MASK
mdefine_line|#define GE_CYC_TYPE_MASK (7)
DECL|macro|GE_HOST_STC
mdefine_line|#define GE_HOST_STC (1 &lt;&lt; 3)
DECL|macro|GE_ABORT
mdefine_line|#define GE_ABORT (1 &lt;&lt; 5)
DECL|function|amd756_abort
r_void
id|amd756_abort
c_func
(paren
r_void
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;i2c-amd756.o: Sending abort.&bslash;n&quot;
)paren
suffix:semicolon
id|outw_p
c_func
(paren
id|inw
c_func
(paren
id|SMB_GLOBAL_ENABLE
)paren
op_or
id|GE_ABORT
comma
id|SMB_GLOBAL_ENABLE
)paren
suffix:semicolon
id|amd756_do_pause
c_func
(paren
l_int|100
)paren
suffix:semicolon
id|outw_p
c_func
(paren
id|GS_CLEAR_STS
comma
id|SMB_GLOBAL_STATUS
)paren
suffix:semicolon
)brace
DECL|function|amd756_transaction
r_int
id|amd756_transaction
c_func
(paren
r_void
)paren
(brace
r_int
id|temp
suffix:semicolon
r_int
id|result
op_assign
l_int|0
suffix:semicolon
r_int
id|timeout
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
(paren
l_string|&quot;i2c-amd756.o: Transaction (pre): GS=%04x, GE=%04x, ADD=%04x, DAT=%04x&bslash;n&quot;
comma
id|inw_p
c_func
(paren
id|SMB_GLOBAL_STATUS
)paren
comma
id|inw_p
c_func
(paren
id|SMB_GLOBAL_ENABLE
)paren
comma
id|inw_p
c_func
(paren
id|SMB_HOST_ADDRESS
)paren
comma
id|inb_p
c_func
(paren
id|SMB_HOST_DATA
)paren
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* Make sure the SMBus host is ready to start transmitting */
r_if
c_cond
(paren
(paren
id|temp
op_assign
id|inw_p
c_func
(paren
id|SMB_GLOBAL_STATUS
)paren
)paren
op_amp
(paren
id|GS_HST_STS
op_or
id|GS_SMB_STS
)paren
)paren
(brace
macro_line|#ifdef DEBUG
id|printk
(paren
l_string|&quot;i2c-amd756.o: SMBus busy (%04x). Waiting... &bslash;n&quot;
comma
id|temp
)paren
suffix:semicolon
macro_line|#endif
r_do
(brace
id|amd756_do_pause
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|temp
op_assign
id|inw_p
c_func
(paren
id|SMB_GLOBAL_STATUS
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|temp
op_amp
(paren
id|GS_HST_STS
op_or
id|GS_SMB_STS
)paren
)paren
op_logical_and
(paren
id|timeout
op_increment
OL
id|MAX_TIMEOUT
)paren
)paren
suffix:semicolon
multiline_comment|/* If the SMBus is still busy, we give up */
r_if
c_cond
(paren
id|timeout
op_ge
id|MAX_TIMEOUT
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;i2c-amd756.o: Busy wait timeout! (%04x)&bslash;n&quot;
comma
id|temp
)paren
suffix:semicolon
id|amd756_abort
c_func
(paren
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|timeout
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* start the transaction by setting the start bit */
id|outw_p
c_func
(paren
id|inw
c_func
(paren
id|SMB_GLOBAL_ENABLE
)paren
op_or
id|GE_HOST_STC
comma
id|SMB_GLOBAL_ENABLE
)paren
suffix:semicolon
multiline_comment|/* We will always wait for a fraction of a second! */
r_do
(brace
id|amd756_do_pause
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|temp
op_assign
id|inw_p
c_func
(paren
id|SMB_GLOBAL_STATUS
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|temp
op_amp
id|GS_HST_STS
)paren
op_logical_and
(paren
id|timeout
op_increment
OL
id|MAX_TIMEOUT
)paren
)paren
suffix:semicolon
multiline_comment|/* If the SMBus is still busy, we give up */
r_if
c_cond
(paren
id|timeout
op_ge
id|MAX_TIMEOUT
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;i2c-amd756.o: Completion timeout!&bslash;n&quot;
)paren
suffix:semicolon
id|amd756_abort
(paren
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|temp
op_amp
id|GS_PRERR_STS
)paren
(brace
id|result
op_assign
op_minus
l_int|1
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;i2c-amd756.o: SMBus Protocol error (no response)!&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
r_if
c_cond
(paren
id|temp
op_amp
id|GS_COL_STS
)paren
(brace
id|result
op_assign
op_minus
l_int|1
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;i2c-amd756.o: SMBus collision!&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|temp
op_amp
id|GS_TO_STS
)paren
(brace
id|result
op_assign
op_minus
l_int|1
suffix:semicolon
macro_line|#ifdef DEBUG
id|printk
c_func
(paren
l_string|&quot;i2c-amd756.o: SMBus protocol timeout!&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
)brace
macro_line|#ifdef DEBUG
r_if
c_cond
(paren
id|temp
op_amp
id|GS_HCYC_STS
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;i2c-amd756.o: SMBus protocol success!&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
id|outw_p
c_func
(paren
id|GS_CLEAR_STS
comma
id|SMB_GLOBAL_STATUS
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
r_if
c_cond
(paren
(paren
(paren
id|temp
op_assign
id|inw_p
c_func
(paren
id|SMB_GLOBAL_STATUS
)paren
)paren
op_amp
id|GS_CLEAR_STS
)paren
op_ne
l_int|0x00
)paren
(brace
id|printk
(paren
l_string|&quot;i2c-amd756.o: Failed reset at end of transaction (%04x)&bslash;n&quot;
comma
id|temp
)paren
suffix:semicolon
)brace
id|printk
(paren
l_string|&quot;i2c-amd756.o: Transaction (post): GS=%04x, GE=%04x, ADD=%04x, DAT=%04x&bslash;n&quot;
comma
id|inw_p
c_func
(paren
id|SMB_GLOBAL_STATUS
)paren
comma
id|inw_p
c_func
(paren
id|SMB_GLOBAL_ENABLE
)paren
comma
id|inw_p
c_func
(paren
id|SMB_HOST_ADDRESS
)paren
comma
id|inb_p
c_func
(paren
id|SMB_HOST_DATA
)paren
)paren
suffix:semicolon
macro_line|#endif
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/* Return -1 on error. */
DECL|function|amd756_access
id|s32
id|amd756_access
c_func
(paren
r_struct
id|i2c_adapter
op_star
id|adap
comma
id|u16
id|addr
comma
r_int
r_int
id|flags
comma
r_char
id|read_write
comma
id|u8
id|command
comma
r_int
id|size
comma
r_union
id|i2c_smbus_data
op_star
id|data
)paren
(brace
r_int
id|i
comma
id|len
suffix:semicolon
multiline_comment|/** TODO: Should I supporte the 10-bit transfers? */
r_switch
c_cond
(paren
id|size
)paren
(brace
r_case
id|I2C_SMBUS_PROC_CALL
suffix:colon
id|printk
(paren
l_string|&quot;i2c-amd756.o: I2C_SMBUS_PROC_CALL not supported!&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* TODO: Well... It is supported, I&squot;m just not sure what to do here... */
r_return
op_minus
l_int|1
suffix:semicolon
r_case
id|I2C_SMBUS_QUICK
suffix:colon
id|outw_p
c_func
(paren
(paren
(paren
id|addr
op_amp
l_int|0x7f
)paren
op_lshift
l_int|1
)paren
op_or
(paren
id|read_write
op_amp
l_int|0x01
)paren
comma
id|SMB_HOST_ADDRESS
)paren
suffix:semicolon
id|size
op_assign
id|AMD756_QUICK
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2C_SMBUS_BYTE
suffix:colon
id|outw_p
c_func
(paren
(paren
(paren
id|addr
op_amp
l_int|0x7f
)paren
op_lshift
l_int|1
)paren
op_or
(paren
id|read_write
op_amp
l_int|0x01
)paren
comma
id|SMB_HOST_ADDRESS
)paren
suffix:semicolon
multiline_comment|/* TODO: Why only during write? */
r_if
c_cond
(paren
id|read_write
op_eq
id|I2C_SMBUS_WRITE
)paren
id|outb_p
c_func
(paren
id|command
comma
id|SMB_HOST_COMMAND
)paren
suffix:semicolon
id|size
op_assign
id|AMD756_BYTE
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2C_SMBUS_BYTE_DATA
suffix:colon
id|outw_p
c_func
(paren
(paren
(paren
id|addr
op_amp
l_int|0x7f
)paren
op_lshift
l_int|1
)paren
op_or
(paren
id|read_write
op_amp
l_int|0x01
)paren
comma
id|SMB_HOST_ADDRESS
)paren
suffix:semicolon
id|outb_p
c_func
(paren
id|command
comma
id|SMB_HOST_COMMAND
)paren
suffix:semicolon
r_if
c_cond
(paren
id|read_write
op_eq
id|I2C_SMBUS_WRITE
)paren
id|outw_p
c_func
(paren
id|data-&gt;byte
comma
id|SMB_HOST_DATA
)paren
suffix:semicolon
id|size
op_assign
id|AMD756_BYTE_DATA
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2C_SMBUS_WORD_DATA
suffix:colon
id|outw_p
c_func
(paren
(paren
(paren
id|addr
op_amp
l_int|0x7f
)paren
op_lshift
l_int|1
)paren
op_or
(paren
id|read_write
op_amp
l_int|0x01
)paren
comma
id|SMB_HOST_ADDRESS
)paren
suffix:semicolon
id|outb_p
c_func
(paren
id|command
comma
id|SMB_HOST_COMMAND
)paren
suffix:semicolon
r_if
c_cond
(paren
id|read_write
op_eq
id|I2C_SMBUS_WRITE
)paren
id|outw_p
c_func
(paren
id|data-&gt;word
comma
id|SMB_HOST_DATA
)paren
suffix:semicolon
multiline_comment|/* TODO: endian???? */
id|size
op_assign
id|AMD756_WORD_DATA
suffix:semicolon
r_break
suffix:semicolon
r_case
id|I2C_SMBUS_BLOCK_DATA
suffix:colon
id|outw_p
c_func
(paren
(paren
(paren
id|addr
op_amp
l_int|0x7f
)paren
op_lshift
l_int|1
)paren
op_or
(paren
id|read_write
op_amp
l_int|0x01
)paren
comma
id|SMB_HOST_ADDRESS
)paren
suffix:semicolon
id|outb_p
c_func
(paren
id|command
comma
id|SMB_HOST_COMMAND
)paren
suffix:semicolon
r_if
c_cond
(paren
id|read_write
op_eq
id|I2C_SMBUS_WRITE
)paren
(brace
id|len
op_assign
id|data-&gt;block
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
l_int|0
)paren
id|len
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
l_int|32
)paren
id|len
op_assign
l_int|32
suffix:semicolon
id|outw_p
c_func
(paren
id|len
comma
id|SMB_HOST_DATA
)paren
suffix:semicolon
multiline_comment|/* i = inw_p(SMBHSTCNT); Reset SMBBLKDAT */
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
op_le
id|len
suffix:semicolon
id|i
op_increment
)paren
id|outb_p
c_func
(paren
id|data-&gt;block
(braket
id|i
)braket
comma
id|SMB_HOST_BLOCK_DATA
)paren
suffix:semicolon
)brace
id|size
op_assign
id|AMD756_BLOCK_DATA
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* How about enabling interrupts... */
id|outw_p
c_func
(paren
id|size
op_amp
id|GE_CYC_TYPE_MASK
comma
id|SMB_GLOBAL_ENABLE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|amd756_transaction
c_func
(paren
)paren
)paren
multiline_comment|/* Error in transaction */
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|read_write
op_eq
id|I2C_SMBUS_WRITE
)paren
op_logical_or
(paren
id|size
op_eq
id|AMD756_QUICK
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|size
)paren
(brace
r_case
id|AMD756_BYTE
suffix:colon
id|data-&gt;byte
op_assign
id|inw_p
c_func
(paren
id|SMB_HOST_DATA
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AMD756_BYTE_DATA
suffix:colon
id|data-&gt;byte
op_assign
id|inw_p
c_func
(paren
id|SMB_HOST_DATA
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AMD756_WORD_DATA
suffix:colon
id|data-&gt;word
op_assign
id|inw_p
c_func
(paren
id|SMB_HOST_DATA
)paren
suffix:semicolon
multiline_comment|/* TODO: endian???? */
r_break
suffix:semicolon
r_case
id|AMD756_BLOCK_DATA
suffix:colon
id|data-&gt;block
(braket
l_int|0
)braket
op_assign
id|inw_p
c_func
(paren
id|SMB_HOST_DATA
)paren
op_amp
l_int|0x3f
suffix:semicolon
r_if
c_cond
(paren
id|data-&gt;block
(braket
l_int|0
)braket
OG
l_int|32
)paren
(brace
id|data-&gt;block
(braket
l_int|0
)braket
op_assign
l_int|32
suffix:semicolon
)brace
multiline_comment|/* i = inw_p(SMBHSTCNT); Reset SMBBLKDAT */
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
op_le
id|data-&gt;block
(braket
l_int|0
)braket
suffix:semicolon
id|i
op_increment
)paren
id|data-&gt;block
(braket
id|i
)braket
op_assign
id|inb_p
c_func
(paren
id|SMB_HOST_BLOCK_DATA
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|amd756_inc
r_void
id|amd756_inc
c_func
(paren
r_struct
id|i2c_adapter
op_star
id|adapter
)paren
(brace
id|MOD_INC_USE_COUNT
suffix:semicolon
)brace
DECL|function|amd756_dec
r_void
id|amd756_dec
c_func
(paren
r_struct
id|i2c_adapter
op_star
id|adapter
)paren
(brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
DECL|function|amd756_func
id|u32
id|amd756_func
c_func
(paren
r_struct
id|i2c_adapter
op_star
id|adapter
)paren
(brace
r_return
id|I2C_FUNC_SMBUS_QUICK
op_or
id|I2C_FUNC_SMBUS_BYTE
op_or
id|I2C_FUNC_SMBUS_BYTE_DATA
op_or
id|I2C_FUNC_SMBUS_WORD_DATA
op_or
id|I2C_FUNC_SMBUS_BLOCK_DATA
op_or
id|I2C_FUNC_SMBUS_PROC_CALL
suffix:semicolon
)brace
DECL|function|i2c_amd756_init
r_int
id|__init
id|i2c_amd756_init
c_func
(paren
r_void
)paren
(brace
r_int
id|res
suffix:semicolon
macro_line|#ifdef DEBUG
multiline_comment|/* PE- It might be good to make this a permanent part of the code! */
r_if
c_cond
(paren
id|amd756_initialized
)paren
(brace
id|printk
(paren
l_string|&quot;i2c-amd756.o: Oops, amd756_init called a second time!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
macro_line|#endif
id|amd756_initialized
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|res
op_assign
id|amd756_setup
c_func
(paren
)paren
)paren
)paren
(brace
id|printk
(paren
l_string|&quot;i2c-amd756.o: AMD756 or compatible device not detected, module not inserted.&bslash;n&quot;
)paren
suffix:semicolon
id|amd756_cleanup
c_func
(paren
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
id|amd756_initialized
op_increment
suffix:semicolon
id|sprintf
c_func
(paren
id|amd756_adapter.name
comma
l_string|&quot;SMBus %s adapter at %04x&quot;
comma
id|amd756_sd-&gt;name
comma
id|amd756_smba
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|res
op_assign
id|i2c_add_adapter
c_func
(paren
op_amp
id|amd756_adapter
)paren
)paren
)paren
(brace
id|printk
(paren
l_string|&quot;i2c-amd756.o: Adapter registration failed, module not inserted.&bslash;n&quot;
)paren
suffix:semicolon
id|amd756_cleanup
c_func
(paren
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
id|amd756_initialized
op_increment
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;i2c-amd756.o: %s bus detected and initialized&bslash;n&quot;
comma
id|amd756_sd-&gt;name
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|i2c_amd756_exit
r_void
id|__exit
id|i2c_amd756_exit
c_func
(paren
r_void
)paren
(brace
id|amd756_cleanup
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|amd756_cleanup
r_static
r_int
id|amd756_cleanup
c_func
(paren
r_void
)paren
(brace
r_int
id|res
suffix:semicolon
r_if
c_cond
(paren
id|amd756_initialized
op_ge
l_int|2
)paren
(brace
r_if
c_cond
(paren
(paren
id|res
op_assign
id|i2c_del_adapter
c_func
(paren
op_amp
id|amd756_adapter
)paren
)paren
)paren
(brace
id|printk
(paren
l_string|&quot;i2c-amd756.o: i2c_del_adapter failed, module not removed&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
r_else
id|amd756_initialized
op_decrement
suffix:semicolon
)brace
r_if
c_cond
(paren
id|amd756_initialized
op_ge
l_int|1
)paren
(brace
id|release_region
c_func
(paren
id|amd756_smba
comma
id|SMB_IOSIZE
)paren
suffix:semicolon
id|amd756_initialized
op_decrement
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
id|EXPORT_NO_SYMBOLS
suffix:semicolon
macro_line|#ifdef MODULE
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Merlin Hughes &lt;merlin@merlin.org&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;AMD756/766/768/nVidia nForce SMBus driver&quot;
)paren
suffix:semicolon
macro_line|#ifdef MODULE_LICENSE
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
macro_line|#endif
macro_line|#endif&t;&t;&t;&t;/* MODULE */
id|module_init
c_func
(paren
id|i2c_amd756_init
)paren
id|module_exit
c_func
(paren
id|i2c_amd756_exit
)paren
eof
