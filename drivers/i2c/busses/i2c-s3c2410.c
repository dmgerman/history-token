multiline_comment|/* linux/drivers/i2c/busses/i2c-s3c2410.c&n; *&n; * Copyright (C) 2004 Simtec Electronics&n; *&t;Ben Dooks &lt;ben@simtec.co.uk&gt;&n; *&n; * S3C2410 I2C Controller&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation; either version 2 of the License, or&n; * (at your option) any later version.&n; *&n; * This program is distributed in the hope that it will be useful,&n; * but WITHOUT ANY WARRANTY; without even the implied warranty of&n; * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA&n;*/
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/i2c.h&gt;
macro_line|#include &lt;linux/i2c-id.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/time.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/err.h&gt;
macro_line|#include &lt;linux/device.h&gt;
macro_line|#include &lt;asm/hardware.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/hardware/clock.h&gt;
macro_line|#include &lt;asm/arch/regs-gpio.h&gt;
macro_line|#include &lt;asm/arch/regs-iic.h&gt;
macro_line|#include &lt;asm/arch/iic.h&gt;
multiline_comment|/* i2c controller state */
DECL|enum|s3c24xx_i2c_state
r_enum
id|s3c24xx_i2c_state
(brace
DECL|enumerator|STATE_IDLE
id|STATE_IDLE
comma
DECL|enumerator|STATE_START
id|STATE_START
comma
DECL|enumerator|STATE_READ
id|STATE_READ
comma
DECL|enumerator|STATE_WRITE
id|STATE_WRITE
comma
DECL|enumerator|STATE_STOP
id|STATE_STOP
)brace
suffix:semicolon
DECL|struct|s3c24xx_i2c
r_struct
id|s3c24xx_i2c
(brace
DECL|member|lock
id|spinlock_t
id|lock
suffix:semicolon
DECL|member|wait
id|wait_queue_head_t
id|wait
suffix:semicolon
DECL|member|msg
r_struct
id|i2c_msg
op_star
id|msg
suffix:semicolon
DECL|member|msg_num
r_int
r_int
id|msg_num
suffix:semicolon
DECL|member|msg_idx
r_int
r_int
id|msg_idx
suffix:semicolon
DECL|member|msg_ptr
r_int
r_int
id|msg_ptr
suffix:semicolon
DECL|member|state
r_enum
id|s3c24xx_i2c_state
id|state
suffix:semicolon
DECL|member|regs
r_void
id|__iomem
op_star
id|regs
suffix:semicolon
DECL|member|clk
r_struct
id|clk
op_star
id|clk
suffix:semicolon
DECL|member|dev
r_struct
id|device
op_star
id|dev
suffix:semicolon
DECL|member|irq
r_struct
id|resource
op_star
id|irq
suffix:semicolon
DECL|member|ioarea
r_struct
id|resource
op_star
id|ioarea
suffix:semicolon
DECL|member|adap
r_struct
id|i2c_adapter
id|adap
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* default platform data to use if not supplied in the platfrom_device&n;*/
DECL|variable|s3c24xx_i2c_default_platform
r_static
r_struct
id|s3c2410_platform_i2c
id|s3c24xx_i2c_default_platform
op_assign
(brace
dot
id|flags
op_assign
l_int|0
comma
dot
id|slave_addr
op_assign
l_int|0x10
comma
dot
id|bus_freq
op_assign
l_int|100
op_star
l_int|1000
comma
dot
id|max_freq
op_assign
l_int|400
op_star
l_int|1000
comma
)brace
suffix:semicolon
multiline_comment|/* s3c24xx_i2c_get_platformdata&n; *&n; * get the platform data associated with the given device, or return&n; * the default if there is none&n;*/
DECL|function|s3c24xx_i2c_get_platformdata
r_static
r_inline
r_struct
id|s3c2410_platform_i2c
op_star
id|s3c24xx_i2c_get_platformdata
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_if
c_cond
(paren
id|dev-&gt;platform_data
op_ne
l_int|NULL
)paren
r_return
(paren
r_struct
id|s3c2410_platform_i2c
op_star
)paren
id|dev-&gt;platform_data
suffix:semicolon
r_return
op_amp
id|s3c24xx_i2c_default_platform
suffix:semicolon
)brace
multiline_comment|/* s3c24xx_i2c_master_complete&n; *&n; * complete the message and wake up the caller, using the given return code,&n; * or zero to mean ok.&n;*/
DECL|function|s3c24xx_i2c_master_complete
r_static
r_inline
r_void
id|s3c24xx_i2c_master_complete
c_func
(paren
r_struct
id|s3c24xx_i2c
op_star
id|i2c
comma
r_int
id|ret
)paren
(brace
id|dev_dbg
c_func
(paren
id|i2c-&gt;dev
comma
l_string|&quot;master_complete %d&bslash;n&quot;
comma
id|ret
)paren
suffix:semicolon
id|i2c-&gt;msg_ptr
op_assign
l_int|0
suffix:semicolon
id|i2c-&gt;msg
op_assign
l_int|NULL
suffix:semicolon
id|i2c-&gt;msg_idx
op_increment
suffix:semicolon
id|i2c-&gt;msg_num
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
id|i2c-&gt;msg_idx
op_assign
id|ret
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|i2c-&gt;wait
)paren
suffix:semicolon
)brace
DECL|function|s3c24xx_i2c_disable_ack
r_static
r_inline
r_void
id|s3c24xx_i2c_disable_ack
c_func
(paren
r_struct
id|s3c24xx_i2c
op_star
id|i2c
)paren
(brace
r_int
r_int
id|tmp
suffix:semicolon
id|tmp
op_assign
id|readl
c_func
(paren
id|i2c-&gt;regs
op_plus
id|S3C2410_IICCON
)paren
suffix:semicolon
id|writel
c_func
(paren
id|tmp
op_amp
op_complement
id|S3C2410_IICCON_ACKEN
comma
id|i2c-&gt;regs
op_plus
id|S3C2410_IICCON
)paren
suffix:semicolon
)brace
DECL|function|s3c24xx_i2c_enable_ack
r_static
r_inline
r_void
id|s3c24xx_i2c_enable_ack
c_func
(paren
r_struct
id|s3c24xx_i2c
op_star
id|i2c
)paren
(brace
r_int
r_int
id|tmp
suffix:semicolon
id|tmp
op_assign
id|readl
c_func
(paren
id|i2c-&gt;regs
op_plus
id|S3C2410_IICCON
)paren
suffix:semicolon
id|writel
c_func
(paren
id|tmp
op_or
id|S3C2410_IICCON_ACKEN
comma
id|i2c-&gt;regs
op_plus
id|S3C2410_IICCON
)paren
suffix:semicolon
)brace
multiline_comment|/* irq enable/disable functions */
DECL|function|s3c24xx_i2c_disable_irq
r_static
r_inline
r_void
id|s3c24xx_i2c_disable_irq
c_func
(paren
r_struct
id|s3c24xx_i2c
op_star
id|i2c
)paren
(brace
r_int
r_int
id|tmp
suffix:semicolon
id|tmp
op_assign
id|readl
c_func
(paren
id|i2c-&gt;regs
op_plus
id|S3C2410_IICCON
)paren
suffix:semicolon
id|writel
c_func
(paren
id|tmp
op_amp
op_complement
id|S3C2410_IICCON_IRQEN
comma
id|i2c-&gt;regs
op_plus
id|S3C2410_IICCON
)paren
suffix:semicolon
)brace
DECL|function|s3c24xx_i2c_enable_irq
r_static
r_inline
r_void
id|s3c24xx_i2c_enable_irq
c_func
(paren
r_struct
id|s3c24xx_i2c
op_star
id|i2c
)paren
(brace
r_int
r_int
id|tmp
suffix:semicolon
id|tmp
op_assign
id|readl
c_func
(paren
id|i2c-&gt;regs
op_plus
id|S3C2410_IICCON
)paren
suffix:semicolon
id|writel
c_func
(paren
id|tmp
op_or
id|S3C2410_IICCON_IRQEN
comma
id|i2c-&gt;regs
op_plus
id|S3C2410_IICCON
)paren
suffix:semicolon
)brace
multiline_comment|/* s3c24xx_i2c_message_start&n; *&n; * put the start of a message onto the bus &n;*/
DECL|function|s3c24xx_i2c_message_start
r_static
r_void
id|s3c24xx_i2c_message_start
c_func
(paren
r_struct
id|s3c24xx_i2c
op_star
id|i2c
comma
r_struct
id|i2c_msg
op_star
id|msg
)paren
(brace
r_int
r_int
id|addr
op_assign
(paren
id|msg-&gt;addr
op_amp
l_int|0x7f
)paren
op_lshift
l_int|1
suffix:semicolon
r_int
r_int
id|stat
suffix:semicolon
id|stat
op_assign
id|readl
c_func
(paren
id|i2c-&gt;regs
op_plus
id|S3C2410_IICSTAT
)paren
suffix:semicolon
id|stat
op_and_assign
op_complement
id|S3C2410_IICSTAT_MODEMASK
suffix:semicolon
id|stat
op_or_assign
id|S3C2410_IICSTAT_START
suffix:semicolon
id|stat
op_or_assign
id|S3C2410_IICSTAT_TXRXEN
suffix:semicolon
r_if
c_cond
(paren
id|msg-&gt;flags
op_amp
id|I2C_M_RD
)paren
(brace
id|stat
op_or_assign
id|S3C2410_IICSTAT_MASTER_RX
suffix:semicolon
id|addr
op_or_assign
l_int|1
suffix:semicolon
)brace
r_else
id|stat
op_or_assign
id|S3C2410_IICSTAT_MASTER_TX
suffix:semicolon
singleline_comment|// todo - check for wether ack wanted or not
id|s3c24xx_i2c_enable_ack
c_func
(paren
id|i2c
)paren
suffix:semicolon
id|dev_dbg
c_func
(paren
id|i2c-&gt;dev
comma
l_string|&quot;START: %08lx to IICSTAT, %02x to DS&bslash;n&quot;
comma
id|stat
comma
id|addr
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|addr
comma
id|i2c-&gt;regs
op_plus
id|S3C2410_IICDS
)paren
suffix:semicolon
id|writel
c_func
(paren
id|stat
comma
id|i2c-&gt;regs
op_plus
id|S3C2410_IICSTAT
)paren
suffix:semicolon
)brace
DECL|function|s3c24xx_i2c_stop
r_static
r_inline
r_void
id|s3c24xx_i2c_stop
c_func
(paren
r_struct
id|s3c24xx_i2c
op_star
id|i2c
comma
r_int
id|ret
)paren
(brace
r_int
r_int
id|iicstat
op_assign
id|readl
c_func
(paren
id|i2c-&gt;regs
op_plus
id|S3C2410_IICSTAT
)paren
suffix:semicolon
id|dev_dbg
c_func
(paren
id|i2c-&gt;dev
comma
l_string|&quot;STOP&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* stop the transfer */
id|iicstat
op_and_assign
op_complement
id|S3C2410_IICSTAT_START
suffix:semicolon
id|writel
c_func
(paren
id|iicstat
comma
id|i2c-&gt;regs
op_plus
id|S3C2410_IICSTAT
)paren
suffix:semicolon
id|i2c-&gt;state
op_assign
id|STATE_STOP
suffix:semicolon
id|s3c24xx_i2c_master_complete
c_func
(paren
id|i2c
comma
id|ret
)paren
suffix:semicolon
id|s3c24xx_i2c_disable_irq
c_func
(paren
id|i2c
)paren
suffix:semicolon
)brace
multiline_comment|/* helper functions to determine the current state in the set of&n; * messages we are sending */
multiline_comment|/* is_lastmsg()&n; *&n; * returns TRUE if the current message is the last in the set &n;*/
DECL|function|is_lastmsg
r_static
r_inline
r_int
id|is_lastmsg
c_func
(paren
r_struct
id|s3c24xx_i2c
op_star
id|i2c
)paren
(brace
r_return
id|i2c-&gt;msg_idx
op_ge
(paren
id|i2c-&gt;msg_num
op_minus
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/* is_msglast&n; *&n; * returns TRUE if we this is the last byte in the current message&n;*/
DECL|function|is_msglast
r_static
r_inline
r_int
id|is_msglast
c_func
(paren
r_struct
id|s3c24xx_i2c
op_star
id|i2c
)paren
(brace
r_return
id|i2c-&gt;msg_ptr
op_eq
id|i2c-&gt;msg-&gt;len
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* is_msgend&n; *&n; * returns TRUE if we reached the end of the current message&n;*/
DECL|function|is_msgend
r_static
r_inline
r_int
id|is_msgend
c_func
(paren
r_struct
id|s3c24xx_i2c
op_star
id|i2c
)paren
(brace
r_return
id|i2c-&gt;msg_ptr
op_ge
id|i2c-&gt;msg-&gt;len
suffix:semicolon
)brace
multiline_comment|/* i2s_s3c_irq_nextbyte&n; *&n; * process an interrupt and work out what to do&n; */
DECL|function|i2s_s3c_irq_nextbyte
r_static
r_int
id|i2s_s3c_irq_nextbyte
c_func
(paren
r_struct
id|s3c24xx_i2c
op_star
id|i2c
comma
r_int
r_int
id|iicstat
)paren
(brace
r_int
r_int
id|tmp
suffix:semicolon
r_int
r_char
id|byte
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|i2c-&gt;state
)paren
(brace
r_case
id|STATE_IDLE
suffix:colon
id|dev_err
c_func
(paren
id|i2c-&gt;dev
comma
l_string|&quot;%s: called in STATE_IDLE&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
r_break
suffix:semicolon
r_case
id|STATE_STOP
suffix:colon
id|dev_err
c_func
(paren
id|i2c-&gt;dev
comma
l_string|&quot;%s: called in STATE_STOP&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|s3c24xx_i2c_disable_irq
c_func
(paren
id|i2c
)paren
suffix:semicolon
r_goto
id|out_ack
suffix:semicolon
r_case
id|STATE_START
suffix:colon
multiline_comment|/* last thing we did was send a start condition on the&n;&t;&t; * bus, or started a new i2c message&n;&t;&t; */
r_if
c_cond
(paren
id|iicstat
op_amp
id|S3C2410_IICSTAT_LASTBIT
op_logical_and
op_logical_neg
(paren
id|i2c-&gt;msg-&gt;flags
op_amp
id|I2C_M_IGNORE_NAK
)paren
)paren
(brace
multiline_comment|/* ack was not received... */
id|s3c24xx_i2c_stop
c_func
(paren
id|i2c
comma
op_minus
id|EREMOTEIO
)paren
suffix:semicolon
r_goto
id|out_ack
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i2c-&gt;msg-&gt;flags
op_amp
id|I2C_M_RD
)paren
id|i2c-&gt;state
op_assign
id|STATE_READ
suffix:semicolon
r_else
id|i2c-&gt;state
op_assign
id|STATE_WRITE
suffix:semicolon
multiline_comment|/* terminate the transfer if there is nothing to do&n;&t;&t; * (used by the i2c probe to find devices */
r_if
c_cond
(paren
id|is_lastmsg
c_func
(paren
id|i2c
)paren
op_logical_and
id|i2c-&gt;msg-&gt;len
op_eq
l_int|0
)paren
(brace
id|s3c24xx_i2c_stop
c_func
(paren
id|i2c
comma
l_int|0
)paren
suffix:semicolon
r_goto
id|out_ack
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i2c-&gt;state
op_eq
id|STATE_READ
)paren
r_goto
id|prepare_read
suffix:semicolon
multiline_comment|/* fall through to the write state, as we will need to &n;&t;&t; * send a byte as well */
r_case
id|STATE_WRITE
suffix:colon
multiline_comment|/* we are writing data to the device... check for the&n;&t;&t; * end of the message, and if so, work out what to do&n;&t;&t; */
id|retry_write
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|is_msgend
c_func
(paren
id|i2c
)paren
)paren
(brace
id|byte
op_assign
id|i2c-&gt;msg-&gt;buf
(braket
id|i2c-&gt;msg_ptr
op_increment
)braket
suffix:semicolon
id|writeb
c_func
(paren
id|byte
comma
id|i2c-&gt;regs
op_plus
id|S3C2410_IICDS
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|is_lastmsg
c_func
(paren
id|i2c
)paren
)paren
(brace
multiline_comment|/* we need to go to the next i2c message */
id|dev_dbg
c_func
(paren
id|i2c-&gt;dev
comma
l_string|&quot;WRITE: Next Message&bslash;n&quot;
)paren
suffix:semicolon
id|i2c-&gt;msg_ptr
op_assign
l_int|0
suffix:semicolon
id|i2c-&gt;msg_idx
op_increment
suffix:semicolon
id|i2c-&gt;msg
op_increment
suffix:semicolon
multiline_comment|/* check to see if we need to do another message */
r_if
c_cond
(paren
id|i2c-&gt;msg-&gt;flags
op_amp
id|I2C_M_NOSTART
)paren
(brace
r_if
c_cond
(paren
id|i2c-&gt;msg-&gt;flags
op_amp
id|I2C_M_RD
)paren
(brace
multiline_comment|/* cannot do this, the controller&n;&t;&t;&t;&t;&t; * forces us to send a new START&n;&t;&t;&t;&t;&t; * when we change direction */
id|s3c24xx_i2c_stop
c_func
(paren
id|i2c
comma
op_minus
id|EINVAL
)paren
suffix:semicolon
)brace
r_goto
id|retry_write
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* send the new start */
id|s3c24xx_i2c_message_start
c_func
(paren
id|i2c
comma
id|i2c-&gt;msg
)paren
suffix:semicolon
id|i2c-&gt;state
op_assign
id|STATE_START
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* send stop */
id|s3c24xx_i2c_stop
c_func
(paren
id|i2c
comma
l_int|0
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|STATE_READ
suffix:colon
multiline_comment|/* we have a byte of data in the data register, do &n;&t;&t; * something with it, and then work out wether we are&n;&t;&t; * going to do any more read/write&n;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|i2c-&gt;msg-&gt;flags
op_amp
id|I2C_M_IGNORE_NAK
)paren
op_logical_and
op_logical_neg
(paren
id|is_msglast
c_func
(paren
id|i2c
)paren
op_logical_and
id|is_lastmsg
c_func
(paren
id|i2c
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|iicstat
op_amp
id|S3C2410_IICSTAT_LASTBIT
)paren
(brace
id|dev_dbg
c_func
(paren
id|i2c-&gt;dev
comma
l_string|&quot;READ: No Ack&bslash;n&quot;
)paren
suffix:semicolon
id|s3c24xx_i2c_stop
c_func
(paren
id|i2c
comma
op_minus
id|ECONNREFUSED
)paren
suffix:semicolon
r_goto
id|out_ack
suffix:semicolon
)brace
)brace
id|byte
op_assign
id|readb
c_func
(paren
id|i2c-&gt;regs
op_plus
id|S3C2410_IICDS
)paren
suffix:semicolon
id|i2c-&gt;msg-&gt;buf
(braket
id|i2c-&gt;msg_ptr
op_increment
)braket
op_assign
id|byte
suffix:semicolon
id|prepare_read
suffix:colon
r_if
c_cond
(paren
id|is_msglast
c_func
(paren
id|i2c
)paren
)paren
(brace
multiline_comment|/* last byte of buffer */
r_if
c_cond
(paren
id|is_lastmsg
c_func
(paren
id|i2c
)paren
)paren
id|s3c24xx_i2c_disable_ack
c_func
(paren
id|i2c
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|is_msgend
c_func
(paren
id|i2c
)paren
)paren
(brace
multiline_comment|/* ok, we&squot;ve read the entire buffer, see if there&n;&t;&t;&t; * is anything else we need to do */
r_if
c_cond
(paren
id|is_lastmsg
c_func
(paren
id|i2c
)paren
)paren
(brace
multiline_comment|/* last message, send stop and complete */
id|dev_dbg
c_func
(paren
id|i2c-&gt;dev
comma
l_string|&quot;READ: Send Stop&bslash;n&quot;
)paren
suffix:semicolon
id|s3c24xx_i2c_stop
c_func
(paren
id|i2c
comma
l_int|0
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* go to the next transfer */
id|dev_dbg
c_func
(paren
id|i2c-&gt;dev
comma
l_string|&quot;READ: Next Transfer&bslash;n&quot;
)paren
suffix:semicolon
id|i2c-&gt;msg_ptr
op_assign
l_int|0
suffix:semicolon
id|i2c-&gt;msg_idx
op_increment
suffix:semicolon
id|i2c-&gt;msg
op_increment
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
)brace
multiline_comment|/* acknowlegde the IRQ and get back on with the work */
id|out_ack
suffix:colon
id|tmp
op_assign
id|readl
c_func
(paren
id|i2c-&gt;regs
op_plus
id|S3C2410_IICCON
)paren
suffix:semicolon
id|tmp
op_and_assign
op_complement
id|S3C2410_IICCON_IRQPEND
suffix:semicolon
id|writel
c_func
(paren
id|tmp
comma
id|i2c-&gt;regs
op_plus
id|S3C2410_IICCON
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* s3c24xx_i2c_irq&n; *&n; * top level IRQ servicing routine&n;*/
DECL|function|s3c24xx_i2c_irq
r_static
id|irqreturn_t
id|s3c24xx_i2c_irq
c_func
(paren
r_int
id|irqno
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|s3c24xx_i2c
op_star
id|i2c
op_assign
id|dev_id
suffix:semicolon
r_int
r_int
id|status
suffix:semicolon
r_int
r_int
id|tmp
suffix:semicolon
id|status
op_assign
id|readl
c_func
(paren
id|i2c-&gt;regs
op_plus
id|S3C2410_IICSTAT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_amp
id|S3C2410_IICSTAT_ARBITR
)paren
(brace
singleline_comment|// deal with arbitration loss
)brace
r_if
c_cond
(paren
id|i2c-&gt;state
op_eq
id|STATE_IDLE
)paren
(brace
id|dev_dbg
c_func
(paren
id|i2c-&gt;dev
comma
l_string|&quot;IRQ: error i2c-&gt;state == IDLE&bslash;n&quot;
)paren
suffix:semicolon
id|tmp
op_assign
id|readl
c_func
(paren
id|i2c-&gt;regs
op_plus
id|S3C2410_IICCON
)paren
suffix:semicolon
id|tmp
op_and_assign
op_complement
id|S3C2410_IICCON_IRQPEND
suffix:semicolon
id|writel
c_func
(paren
id|tmp
comma
id|i2c-&gt;regs
op_plus
id|S3C2410_IICCON
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* pretty much this leaves us with the fact that we&squot;ve&n;&t; * transmitted or received whatever byte we last sent */
id|i2s_s3c_irq_nextbyte
c_func
(paren
id|i2c
comma
id|status
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
multiline_comment|/* s3c24xx_i2c_set_master&n; *&n; * get the i2c bus for a master transaction&n;*/
DECL|function|s3c24xx_i2c_set_master
r_static
r_int
id|s3c24xx_i2c_set_master
c_func
(paren
r_struct
id|s3c24xx_i2c
op_star
id|i2c
)paren
(brace
r_int
r_int
id|iicstat
suffix:semicolon
r_int
id|timeout
op_assign
l_int|400
suffix:semicolon
r_while
c_loop
(paren
id|timeout
op_decrement
OG
l_int|0
)paren
(brace
id|iicstat
op_assign
id|readl
c_func
(paren
id|i2c-&gt;regs
op_plus
id|S3C2410_IICSTAT
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|iicstat
op_amp
id|S3C2410_IICSTAT_BUSBUSY
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|msleep
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
id|dev_dbg
c_func
(paren
id|i2c-&gt;dev
comma
l_string|&quot;timeout: GPEDAT is %08x&bslash;n&quot;
comma
id|__raw_readl
c_func
(paren
id|S3C2410_GPEDAT
)paren
)paren
suffix:semicolon
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
)brace
multiline_comment|/* s3c24xx_i2c_doxfer&n; *&n; * this starts an i2c transfer&n;*/
DECL|function|s3c24xx_i2c_doxfer
r_static
r_int
id|s3c24xx_i2c_doxfer
c_func
(paren
r_struct
id|s3c24xx_i2c
op_star
id|i2c
comma
r_struct
id|i2c_msg
id|msgs
(braket
)braket
comma
r_int
id|num
)paren
(brace
r_int
r_int
id|timeout
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|ret
op_assign
id|s3c24xx_i2c_set_master
c_func
(paren
id|i2c
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ne
l_int|0
)paren
(brace
id|dev_err
c_func
(paren
id|i2c-&gt;dev
comma
l_string|&quot;cannot get bus (error %d)&bslash;n&quot;
comma
id|ret
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|EAGAIN
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|spin_lock_irq
c_func
(paren
op_amp
id|i2c-&gt;lock
)paren
suffix:semicolon
id|i2c-&gt;msg
op_assign
id|msgs
suffix:semicolon
id|i2c-&gt;msg_num
op_assign
id|num
suffix:semicolon
id|i2c-&gt;msg_ptr
op_assign
l_int|0
suffix:semicolon
id|i2c-&gt;msg_idx
op_assign
l_int|0
suffix:semicolon
id|i2c-&gt;state
op_assign
id|STATE_START
suffix:semicolon
id|s3c24xx_i2c_enable_irq
c_func
(paren
id|i2c
)paren
suffix:semicolon
id|s3c24xx_i2c_message_start
c_func
(paren
id|i2c
comma
id|msgs
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|i2c-&gt;lock
)paren
suffix:semicolon
id|timeout
op_assign
id|wait_event_timeout
c_func
(paren
id|i2c-&gt;wait
comma
id|i2c-&gt;msg_num
op_eq
l_int|0
comma
id|HZ
op_star
l_int|5
)paren
suffix:semicolon
id|ret
op_assign
id|i2c-&gt;msg_idx
suffix:semicolon
multiline_comment|/* having these next two as dev_err() makes life very &n;&t; * noisy when doing an i2cdetect */
r_if
c_cond
(paren
id|timeout
op_eq
l_int|0
)paren
id|dev_dbg
c_func
(paren
id|i2c-&gt;dev
comma
l_string|&quot;timeout&bslash;n&quot;
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|ret
op_ne
id|num
)paren
id|dev_dbg
c_func
(paren
id|i2c-&gt;dev
comma
l_string|&quot;incomplete xfer (%d)&bslash;n&quot;
comma
id|ret
)paren
suffix:semicolon
multiline_comment|/* ensure the stop has been through the bus */
id|msleep
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* s3c24xx_i2c_xfer&n; *&n; * first port of call from the i2c bus code when an message needs&n; * transfering across the i2c bus.&n;*/
DECL|function|s3c24xx_i2c_xfer
r_static
r_int
id|s3c24xx_i2c_xfer
c_func
(paren
r_struct
id|i2c_adapter
op_star
id|adap
comma
r_struct
id|i2c_msg
id|msgs
(braket
)braket
comma
r_int
id|num
)paren
(brace
r_struct
id|s3c24xx_i2c
op_star
id|i2c
op_assign
(paren
r_struct
id|s3c24xx_i2c
op_star
)paren
id|adap-&gt;algo_data
suffix:semicolon
r_int
id|retry
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_for
c_loop
(paren
id|retry
op_assign
l_int|0
suffix:semicolon
id|retry
OL
id|adap-&gt;retries
suffix:semicolon
id|retry
op_increment
)paren
(brace
id|ret
op_assign
id|s3c24xx_i2c_doxfer
c_func
(paren
id|i2c
comma
id|msgs
comma
id|num
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ne
op_minus
id|EAGAIN
)paren
r_return
id|ret
suffix:semicolon
id|dev_dbg
c_func
(paren
id|i2c-&gt;dev
comma
l_string|&quot;Retrying transmission (%d)&bslash;n&quot;
comma
id|retry
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
)brace
r_return
op_minus
id|EREMOTEIO
suffix:semicolon
)brace
multiline_comment|/* i2c bus registration info */
DECL|variable|s3c24xx_i2c_algorithm
r_static
r_struct
id|i2c_algorithm
id|s3c24xx_i2c_algorithm
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;S3C2410-I2C-Algorithm&quot;
comma
dot
id|master_xfer
op_assign
id|s3c24xx_i2c_xfer
comma
)brace
suffix:semicolon
DECL|variable|s3c24xx_i2c
r_static
r_struct
id|s3c24xx_i2c
id|s3c24xx_i2c
op_assign
(brace
dot
id|lock
op_assign
id|SPIN_LOCK_UNLOCKED
comma
dot
id|wait
op_assign
id|__WAIT_QUEUE_HEAD_INITIALIZER
c_func
(paren
id|s3c24xx_i2c.wait
)paren
comma
dot
id|adap
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;s3c2410-i2c&quot;
comma
dot
id|algo
op_assign
op_amp
id|s3c24xx_i2c_algorithm
comma
dot
id|retries
op_assign
l_int|2
comma
)brace
comma
)brace
suffix:semicolon
multiline_comment|/* s3c24xx_i2c_calcdivisor&n; *&n; * return the divisor settings for a given frequency&n;*/
DECL|function|s3c24xx_i2c_calcdivisor
r_static
r_int
id|s3c24xx_i2c_calcdivisor
c_func
(paren
r_int
r_int
id|clkin
comma
r_int
r_int
id|wanted
comma
r_int
r_int
op_star
id|div1
comma
r_int
r_int
op_star
id|divs
)paren
(brace
r_int
r_int
id|calc_divs
op_assign
id|clkin
op_div
id|wanted
suffix:semicolon
r_int
r_int
id|calc_div1
suffix:semicolon
r_if
c_cond
(paren
id|calc_divs
OG
(paren
l_int|16
op_star
l_int|16
)paren
)paren
id|calc_div1
op_assign
l_int|512
suffix:semicolon
r_else
id|calc_div1
op_assign
l_int|16
suffix:semicolon
id|calc_divs
op_add_assign
id|calc_div1
op_minus
l_int|1
suffix:semicolon
id|calc_divs
op_div_assign
id|calc_div1
suffix:semicolon
r_if
c_cond
(paren
id|calc_divs
op_eq
l_int|0
)paren
id|calc_divs
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|calc_divs
OG
l_int|17
)paren
id|calc_divs
op_assign
l_int|17
suffix:semicolon
op_star
id|divs
op_assign
id|calc_divs
suffix:semicolon
op_star
id|div1
op_assign
id|calc_div1
suffix:semicolon
r_return
id|clkin
op_div
(paren
id|calc_divs
op_plus
id|calc_div1
)paren
suffix:semicolon
)brace
multiline_comment|/* freq_acceptable&n; *&n; * test wether a frequency is within the acceptable range of error&n;*/
DECL|function|freq_acceptable
r_static
r_inline
r_int
id|freq_acceptable
c_func
(paren
r_int
r_int
id|freq
comma
r_int
r_int
id|wanted
)paren
(brace
r_int
id|diff
op_assign
id|freq
op_minus
id|wanted
suffix:semicolon
r_return
(paren
id|diff
op_ge
op_minus
l_int|2
op_logical_and
id|diff
op_le
l_int|2
)paren
suffix:semicolon
)brace
multiline_comment|/* s3c24xx_i2c_getdivisor&n; *&n; * work out a divisor for the user requested frequency setting,&n; * either by the requested frequency, or scanning the acceptable&n; * range of frequencies until something is found&n;*/
DECL|function|s3c24xx_i2c_getdivisor
r_static
r_int
id|s3c24xx_i2c_getdivisor
c_func
(paren
r_struct
id|s3c24xx_i2c
op_star
id|i2c
comma
r_struct
id|s3c2410_platform_i2c
op_star
id|pdata
comma
r_int
r_int
op_star
id|iicon
comma
r_int
r_int
op_star
id|got
)paren
(brace
r_int
r_int
id|clkin
op_assign
id|clk_get_rate
c_func
(paren
id|i2c-&gt;clk
)paren
suffix:semicolon
r_int
r_int
id|divs
comma
id|div1
suffix:semicolon
r_int
id|freq
suffix:semicolon
r_int
id|start
comma
id|end
suffix:semicolon
id|clkin
op_div_assign
l_int|1000
suffix:semicolon
multiline_comment|/* clkin now in KHz */
id|dev_dbg
c_func
(paren
id|i2c-&gt;dev
comma
l_string|&quot;pdata %p, freq %lu %lu..%lu&bslash;n&quot;
comma
id|pdata
comma
id|pdata-&gt;bus_freq
comma
id|pdata-&gt;min_freq
comma
id|pdata-&gt;max_freq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pdata-&gt;bus_freq
op_ne
l_int|0
)paren
(brace
id|freq
op_assign
id|s3c24xx_i2c_calcdivisor
c_func
(paren
id|clkin
comma
id|pdata-&gt;bus_freq
op_div
l_int|1000
comma
op_amp
id|div1
comma
op_amp
id|divs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|freq_acceptable
c_func
(paren
id|freq
comma
id|pdata-&gt;bus_freq
op_div
l_int|1000
)paren
)paren
r_goto
id|found
suffix:semicolon
)brace
multiline_comment|/* ok, we may have to search for something suitable... */
id|start
op_assign
(paren
id|pdata-&gt;max_freq
op_eq
l_int|0
)paren
ques
c_cond
id|pdata-&gt;bus_freq
suffix:colon
id|pdata-&gt;max_freq
suffix:semicolon
id|end
op_assign
id|pdata-&gt;min_freq
suffix:semicolon
id|start
op_div_assign
l_int|1000
suffix:semicolon
id|end
op_div_assign
l_int|1000
suffix:semicolon
multiline_comment|/* search loop... */
r_for
c_loop
(paren
suffix:semicolon
id|start
OG
id|end
suffix:semicolon
id|start
op_decrement
)paren
(brace
id|freq
op_assign
id|s3c24xx_i2c_calcdivisor
c_func
(paren
id|clkin
comma
id|start
comma
op_amp
id|div1
comma
op_amp
id|divs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|freq_acceptable
c_func
(paren
id|freq
comma
id|start
)paren
)paren
r_goto
id|found
suffix:semicolon
)brace
multiline_comment|/* cannot find frequency spec */
r_return
op_minus
id|EINVAL
suffix:semicolon
id|found
suffix:colon
op_star
id|got
op_assign
id|freq
suffix:semicolon
op_star
id|iicon
op_or_assign
(paren
id|divs
op_minus
l_int|1
)paren
suffix:semicolon
op_star
id|iicon
op_or_assign
(paren
id|div1
op_eq
l_int|512
)paren
ques
c_cond
id|S3C2410_IICCON_TXDIV_512
suffix:colon
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* s3c24xx_i2c_init&n; *&n; * initialise the controller, set the IO lines and frequency &n;*/
DECL|function|s3c24xx_i2c_init
r_static
r_int
id|s3c24xx_i2c_init
c_func
(paren
r_struct
id|s3c24xx_i2c
op_star
id|i2c
)paren
(brace
r_int
r_int
id|iicon
op_assign
id|S3C2410_IICCON_IRQEN
op_or
id|S3C2410_IICCON_ACKEN
suffix:semicolon
r_struct
id|s3c2410_platform_i2c
op_star
id|pdata
suffix:semicolon
r_int
r_int
id|freq
suffix:semicolon
multiline_comment|/* get the plafrom data */
id|pdata
op_assign
id|s3c24xx_i2c_get_platformdata
c_func
(paren
id|i2c-&gt;adap.dev.parent
)paren
suffix:semicolon
multiline_comment|/* inititalise the gpio */
id|s3c2410_gpio_cfgpin
c_func
(paren
id|S3C2410_GPE15
comma
id|S3C2410_GPE15_IICSDA
)paren
suffix:semicolon
id|s3c2410_gpio_cfgpin
c_func
(paren
id|S3C2410_GPE14
comma
id|S3C2410_GPE14_IICSCL
)paren
suffix:semicolon
multiline_comment|/* write slave address */
id|writeb
c_func
(paren
id|pdata-&gt;slave_addr
comma
id|i2c-&gt;regs
op_plus
id|S3C2410_IICADD
)paren
suffix:semicolon
id|dev_info
c_func
(paren
id|i2c-&gt;dev
comma
l_string|&quot;slave address 0x%02x&bslash;n&quot;
comma
id|pdata-&gt;slave_addr
)paren
suffix:semicolon
multiline_comment|/* we need to work out the divisors for the clock... */
r_if
c_cond
(paren
id|s3c24xx_i2c_getdivisor
c_func
(paren
id|i2c
comma
id|pdata
comma
op_amp
id|iicon
comma
op_amp
id|freq
)paren
op_ne
l_int|0
)paren
(brace
id|dev_err
c_func
(paren
id|i2c-&gt;dev
comma
l_string|&quot;cannot meet bus frequency required&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* todo - check that the i2c lines aren&squot;t being dragged anywhere */
id|dev_info
c_func
(paren
id|i2c-&gt;dev
comma
l_string|&quot;bus frequency set to %d KHz&bslash;n&quot;
comma
id|freq
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|s3c24xx_i2c_free
r_static
r_void
id|s3c24xx_i2c_free
c_func
(paren
r_struct
id|s3c24xx_i2c
op_star
id|i2c
)paren
(brace
r_if
c_cond
(paren
id|i2c-&gt;clk
op_ne
l_int|NULL
op_logical_and
op_logical_neg
id|IS_ERR
c_func
(paren
id|i2c-&gt;clk
)paren
)paren
(brace
id|clk_disable
c_func
(paren
id|i2c-&gt;clk
)paren
suffix:semicolon
id|clk_unuse
c_func
(paren
id|i2c-&gt;clk
)paren
suffix:semicolon
id|clk_put
c_func
(paren
id|i2c-&gt;clk
)paren
suffix:semicolon
id|i2c-&gt;clk
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i2c-&gt;regs
op_ne
l_int|NULL
)paren
(brace
id|iounmap
c_func
(paren
id|i2c-&gt;regs
)paren
suffix:semicolon
id|i2c-&gt;regs
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i2c-&gt;ioarea
op_ne
l_int|NULL
)paren
(brace
id|release_resource
c_func
(paren
id|i2c-&gt;ioarea
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|i2c-&gt;ioarea
)paren
suffix:semicolon
id|i2c-&gt;ioarea
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
multiline_comment|/* s3c24xx_i2c_probe&n; *&n; * called by the bus driver when a suitable device is found&n;*/
DECL|function|s3c24xx_i2c_probe
r_static
r_int
id|s3c24xx_i2c_probe
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|platform_device
op_star
id|pdev
op_assign
id|to_platform_device
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|s3c24xx_i2c
op_star
id|i2c
op_assign
op_amp
id|s3c24xx_i2c
suffix:semicolon
r_struct
id|resource
op_star
id|res
suffix:semicolon
r_int
id|ret
suffix:semicolon
multiline_comment|/* find the clock and enable it */
id|i2c-&gt;dev
op_assign
id|dev
suffix:semicolon
id|i2c-&gt;clk
op_assign
id|clk_get
c_func
(paren
id|dev
comma
l_string|&quot;i2c&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|i2c-&gt;clk
)paren
)paren
(brace
id|dev_err
c_func
(paren
id|dev
comma
l_string|&quot;cannot get clock&bslash;n&quot;
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|ENOENT
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|dev_dbg
c_func
(paren
id|dev
comma
l_string|&quot;clock source %p&bslash;n&quot;
comma
id|i2c-&gt;clk
)paren
suffix:semicolon
id|clk_use
c_func
(paren
id|i2c-&gt;clk
)paren
suffix:semicolon
id|clk_enable
c_func
(paren
id|i2c-&gt;clk
)paren
suffix:semicolon
multiline_comment|/* map the registers */
id|res
op_assign
id|platform_get_resource
c_func
(paren
id|pdev
comma
id|IORESOURCE_MEM
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
op_eq
l_int|NULL
)paren
(brace
id|dev_err
c_func
(paren
id|dev
comma
l_string|&quot;cannot find IO resource&bslash;n&quot;
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|ENOENT
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|i2c-&gt;ioarea
op_assign
id|request_mem_region
c_func
(paren
id|res-&gt;start
comma
(paren
id|res-&gt;end
op_minus
id|res-&gt;start
)paren
op_plus
l_int|1
comma
id|pdev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i2c-&gt;ioarea
op_eq
l_int|NULL
)paren
(brace
id|dev_err
c_func
(paren
id|dev
comma
l_string|&quot;cannot request IO&bslash;n&quot;
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|ENXIO
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|i2c-&gt;regs
op_assign
id|ioremap
c_func
(paren
id|res-&gt;start
comma
(paren
id|res-&gt;end
op_minus
id|res-&gt;start
)paren
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i2c-&gt;regs
op_eq
l_int|NULL
)paren
(brace
id|dev_err
c_func
(paren
id|dev
comma
l_string|&quot;cannot map IO&bslash;n&quot;
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|ENXIO
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|dev_dbg
c_func
(paren
id|dev
comma
l_string|&quot;registers %p (%p, %p)&bslash;n&quot;
comma
id|i2c-&gt;regs
comma
id|i2c-&gt;ioarea
comma
id|res
)paren
suffix:semicolon
multiline_comment|/* setup info block for the i2c core */
id|i2c-&gt;adap.algo_data
op_assign
id|i2c
suffix:semicolon
id|i2c-&gt;adap.dev.parent
op_assign
id|dev
suffix:semicolon
multiline_comment|/* initialise the i2c controller */
id|ret
op_assign
id|s3c24xx_i2c_init
c_func
(paren
id|i2c
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ne
l_int|0
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* find the IRQ for this unit (note, this relies on the init call to&n;&t; * ensure no current IRQs pending &n;&t; */
id|res
op_assign
id|platform_get_resource
c_func
(paren
id|pdev
comma
id|IORESOURCE_IRQ
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
op_eq
l_int|NULL
)paren
(brace
id|dev_err
c_func
(paren
id|dev
comma
l_string|&quot;cannot find IRQ&bslash;n&quot;
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|ENOENT
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|ret
op_assign
id|request_irq
c_func
(paren
id|res-&gt;start
comma
id|s3c24xx_i2c_irq
comma
id|SA_INTERRUPT
comma
id|pdev-&gt;name
comma
id|i2c
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ne
l_int|0
)paren
(brace
id|dev_err
c_func
(paren
id|dev
comma
l_string|&quot;cannot claim IRQ&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|i2c-&gt;irq
op_assign
id|res
suffix:semicolon
id|dev_dbg
c_func
(paren
id|dev
comma
l_string|&quot;irq resource %p (%ld)&bslash;n&quot;
comma
id|res
comma
id|res-&gt;start
)paren
suffix:semicolon
id|ret
op_assign
id|i2c_add_adapter
c_func
(paren
op_amp
id|i2c-&gt;adap
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
id|dev_err
c_func
(paren
id|dev
comma
l_string|&quot;failed to add bus to i2c core&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|dev_set_drvdata
c_func
(paren
id|dev
comma
id|i2c
)paren
suffix:semicolon
id|dev_info
c_func
(paren
id|dev
comma
l_string|&quot;%s: S3C I2C adapter&bslash;n&quot;
comma
id|i2c-&gt;adap.dev.bus_id
)paren
suffix:semicolon
id|out
suffix:colon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
id|s3c24xx_i2c_free
c_func
(paren
id|i2c
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* s3c24xx_i2c_remove&n; *&n; * called when device is removed from the bus&n;*/
DECL|function|s3c24xx_i2c_remove
r_static
r_int
id|s3c24xx_i2c_remove
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|s3c24xx_i2c
op_star
id|i2c
op_assign
id|dev_get_drvdata
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i2c
op_ne
l_int|NULL
)paren
(brace
id|s3c24xx_i2c_free
c_func
(paren
id|i2c
)paren
suffix:semicolon
id|dev_set_drvdata
c_func
(paren
id|dev
comma
l_int|NULL
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_PM
DECL|function|s3c24xx_i2c_resume
r_static
r_int
id|s3c24xx_i2c_resume
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
id|u32
id|level
)paren
(brace
r_struct
id|s3c24xx_i2c
op_star
id|i2c
op_assign
id|dev_get_drvdata
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i2c
op_ne
l_int|NULL
op_logical_and
id|level
op_eq
id|RESUME_ENABLE
)paren
(brace
id|dev_dbg
c_func
(paren
id|dev
comma
l_string|&quot;resume: level %d&bslash;n&quot;
comma
id|level
)paren
suffix:semicolon
id|s3c24xx_i2c_init
c_func
(paren
id|i2c
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#else
DECL|macro|s3c24xx_i2c_resume
mdefine_line|#define s3c24xx_i2c_resume NULL
macro_line|#endif
multiline_comment|/* device driver for platform bus bits */
DECL|variable|s3c24xx_i2c_driver
r_static
r_struct
id|device_driver
id|s3c24xx_i2c_driver
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;s3c2410-i2c&quot;
comma
dot
id|bus
op_assign
op_amp
id|platform_bus_type
comma
dot
id|probe
op_assign
id|s3c24xx_i2c_probe
comma
dot
id|remove
op_assign
id|s3c24xx_i2c_remove
comma
dot
id|resume
op_assign
id|s3c24xx_i2c_resume
comma
)brace
suffix:semicolon
DECL|function|i2c_adap_s3c_init
r_static
r_int
id|__init
id|i2c_adap_s3c_init
c_func
(paren
r_void
)paren
(brace
r_return
id|driver_register
c_func
(paren
op_amp
id|s3c24xx_i2c_driver
)paren
suffix:semicolon
)brace
DECL|function|i2c_adap_s3c_exit
r_static
r_void
id|i2c_adap_s3c_exit
c_func
(paren
r_void
)paren
(brace
r_return
id|driver_unregister
c_func
(paren
op_amp
id|s3c24xx_i2c_driver
)paren
suffix:semicolon
)brace
DECL|variable|i2c_adap_s3c_init
id|module_init
c_func
(paren
id|i2c_adap_s3c_init
)paren
suffix:semicolon
DECL|variable|i2c_adap_s3c_exit
id|module_exit
c_func
(paren
id|i2c_adap_s3c_exit
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;S3C24XX I2C Bus driver&quot;
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Ben Dooks, &lt;ben@simtec.co.uk&gt;&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
eof
