multiline_comment|/* ------------------------------------------------------------------------- */
multiline_comment|/* i2c-iop3xx.c i2c driver algorithms for Intel XScale IOP3xx &amp; IXP46x       */
multiline_comment|/* ------------------------------------------------------------------------- */
multiline_comment|/* Copyright (C) 2003 Peter Milne, D-TACQ Solutions Ltd&n; *                    &lt;Peter dot Milne at D hyphen TACQ dot com&gt;&n; *&n; * With acknowledgements to i2c-algo-ibm_ocp.c by &n; * Ian DaSilva, MontaVista Software, Inc. idasilva@mvista.com&n; *&n; * And i2c-algo-pcf.c, which was created by Simon G. Vogl and Hans Berglund:&n; *&n; * Copyright (C) 1995-1997 Simon G. Vogl, 1998-2000 Hans Berglund&n; *  &n; * And which acknowledged Ky&#xfffd;sti M&#xfffd;lkki &lt;kmalkki@cc.hut.fi&gt;,&n; * Frodo Looijaard &lt;frodol@dds.nl&gt;, Martin Bailey&lt;mbailey@littlefeet-inc.com&gt;&n; *&n; * Major cleanup by Deepak Saxena &lt;dsaxena@plexity.net&gt;, 01/2005:&n; *&n; * - Use driver model to pass per-chip info instead of hardcoding and #ifdefs&n; * - Use ioremap/__raw_readl/__raw_writel instead of direct dereference&n; * - Make it work with IXP46x chips&n; * - Cleanup function names, coding style, etc&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License as published by&n; * the Free Software Foundation, version 2.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/device.h&gt;
macro_line|#include &lt;linux/i2c.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &quot;i2c-iop3xx.h&quot;
multiline_comment|/* global unit counter */
DECL|variable|i2c_id
r_static
r_int
id|i2c_id
op_assign
l_int|0
suffix:semicolon
r_static
r_inline
r_int
r_char
DECL|function|iic_cook_addr
id|iic_cook_addr
c_func
(paren
r_struct
id|i2c_msg
op_star
id|msg
)paren
(brace
r_int
r_char
id|addr
suffix:semicolon
id|addr
op_assign
(paren
id|msg-&gt;addr
op_lshift
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|msg-&gt;flags
op_amp
id|I2C_M_RD
)paren
id|addr
op_or_assign
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t; * Read or Write?&n;&t; */
r_if
c_cond
(paren
id|msg-&gt;flags
op_amp
id|I2C_M_REV_DIR_ADDR
)paren
id|addr
op_xor_assign
l_int|1
suffix:semicolon
r_return
id|addr
suffix:semicolon
)brace
r_static
r_void
DECL|function|iop3xx_i2c_reset
id|iop3xx_i2c_reset
c_func
(paren
r_struct
id|i2c_algo_iop3xx_data
op_star
id|iop3xx_adap
)paren
(brace
multiline_comment|/* Follows devman 9.3 */
id|__raw_writel
c_func
(paren
id|IOP3XX_ICR_UNIT_RESET
comma
id|iop3xx_adap-&gt;ioaddr
op_plus
id|CR_OFFSET
)paren
suffix:semicolon
id|__raw_writel
c_func
(paren
id|IOP3XX_ISR_CLEARBITS
comma
id|iop3xx_adap-&gt;ioaddr
op_plus
id|SR_OFFSET
)paren
suffix:semicolon
id|__raw_writel
c_func
(paren
l_int|0
comma
id|iop3xx_adap-&gt;ioaddr
op_plus
id|CR_OFFSET
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|iop3xx_i2c_set_slave_addr
id|iop3xx_i2c_set_slave_addr
c_func
(paren
r_struct
id|i2c_algo_iop3xx_data
op_star
id|iop3xx_adap
)paren
(brace
id|__raw_writel
c_func
(paren
id|MYSAR
comma
id|iop3xx_adap-&gt;ioaddr
op_plus
id|SAR_OFFSET
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|iop3xx_i2c_enable
id|iop3xx_i2c_enable
c_func
(paren
r_struct
id|i2c_algo_iop3xx_data
op_star
id|iop3xx_adap
)paren
(brace
id|u32
id|cr
op_assign
id|IOP3XX_ICR_GCD
op_or
id|IOP3XX_ICR_SCLEN
op_or
id|IOP3XX_ICR_UE
suffix:semicolon
multiline_comment|/* &n;&t; * Everytime unit enable is asserted, GPOD needs to be cleared&n;&t; * on IOP321 to avoid data corruption on the bus.&n;&t; */
macro_line|#ifdef CONFIG_ARCH_IOP321
DECL|macro|IOP321_GPOD_I2C0
mdefine_line|#define IOP321_GPOD_I2C0    0x00c0  /* clear these bits to enable ch0 */
DECL|macro|IOP321_GPOD_I2C1
mdefine_line|#define IOP321_GPOD_I2C1    0x0030  /* clear these bits to enable ch1 */
op_star
id|IOP321_GPOD
op_and_assign
(paren
id|iop3xx_adap-&gt;id
op_eq
l_int|0
)paren
ques
c_cond
op_complement
id|IOP321_GPOD_I2C0
suffix:colon
op_complement
id|IOP321_GPOD_I2C1
suffix:semicolon
macro_line|#endif
multiline_comment|/* NB SR bits not same position as CR IE bits :-( */
id|iop3xx_adap-&gt;SR_enabled
op_assign
id|IOP3XX_ISR_ALD
op_or
id|IOP3XX_ISR_BERRD
op_or
id|IOP3XX_ISR_RXFULL
op_or
id|IOP3XX_ISR_TXEMPTY
suffix:semicolon
id|cr
op_or_assign
id|IOP3XX_ICR_ALD_IE
op_or
id|IOP3XX_ICR_BERR_IE
op_or
id|IOP3XX_ICR_RXFULL_IE
op_or
id|IOP3XX_ICR_TXEMPTY_IE
suffix:semicolon
id|__raw_writel
c_func
(paren
id|cr
comma
id|iop3xx_adap-&gt;ioaddr
op_plus
id|CR_OFFSET
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|iop3xx_i2c_transaction_cleanup
id|iop3xx_i2c_transaction_cleanup
c_func
(paren
r_struct
id|i2c_algo_iop3xx_data
op_star
id|iop3xx_adap
)paren
(brace
r_int
r_int
id|cr
op_assign
id|__raw_readl
c_func
(paren
id|iop3xx_adap-&gt;ioaddr
op_plus
id|CR_OFFSET
)paren
suffix:semicolon
id|cr
op_and_assign
op_complement
(paren
id|IOP3XX_ICR_MSTART
op_or
id|IOP3XX_ICR_TBYTE
op_or
id|IOP3XX_ICR_MSTOP
op_or
id|IOP3XX_ICR_SCLEN
)paren
suffix:semicolon
id|__raw_writel
c_func
(paren
id|cr
comma
id|iop3xx_adap-&gt;ioaddr
op_plus
id|CR_OFFSET
)paren
suffix:semicolon
)brace
multiline_comment|/* &n; * NB: the handler has to clear the source of the interrupt! &n; * Then it passes the SR flags of interest to BH via adap data&n; */
r_static
id|irqreturn_t
DECL|function|iop3xx_i2c_irq_handler
id|iop3xx_i2c_irq_handler
c_func
(paren
r_int
id|this_irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|i2c_algo_iop3xx_data
op_star
id|iop3xx_adap
op_assign
id|dev_id
suffix:semicolon
id|u32
id|sr
op_assign
id|__raw_readl
c_func
(paren
id|iop3xx_adap-&gt;ioaddr
op_plus
id|SR_OFFSET
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|sr
op_and_assign
id|iop3xx_adap-&gt;SR_enabled
)paren
)paren
(brace
id|__raw_writel
c_func
(paren
id|sr
comma
id|iop3xx_adap-&gt;ioaddr
op_plus
id|SR_OFFSET
)paren
suffix:semicolon
id|iop3xx_adap-&gt;SR_received
op_or_assign
id|sr
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|iop3xx_adap-&gt;waitq
)paren
suffix:semicolon
)brace
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
multiline_comment|/* check all error conditions, clear them , report most important */
r_static
r_int
DECL|function|iop3xx_i2c_error
id|iop3xx_i2c_error
c_func
(paren
id|u32
id|sr
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|sr
op_amp
id|IOP3XX_ISR_BERRD
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|rc
)paren
id|rc
op_assign
op_minus
id|I2C_ERR_BERR
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|sr
op_amp
id|IOP3XX_ISR_ALD
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|rc
)paren
id|rc
op_assign
op_minus
id|I2C_ERR_ALD
suffix:semicolon
)brace
r_return
id|rc
suffix:semicolon
)brace
r_static
r_inline
id|u32
DECL|function|iop3xx_i2c_get_srstat
id|iop3xx_i2c_get_srstat
c_func
(paren
r_struct
id|i2c_algo_iop3xx_data
op_star
id|iop3xx_adap
)paren
(brace
r_int
r_int
id|flags
suffix:semicolon
id|u32
id|sr
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|iop3xx_adap-&gt;lock
comma
id|flags
)paren
suffix:semicolon
id|sr
op_assign
id|iop3xx_adap-&gt;SR_received
suffix:semicolon
id|iop3xx_adap-&gt;SR_received
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|iop3xx_adap-&gt;lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|sr
suffix:semicolon
)brace
multiline_comment|/*&n; * sleep until interrupted, then recover and analyse the SR&n; * saved by handler&n; */
DECL|typedef|compare_func
r_typedef
r_int
(paren
op_star
id|compare_func
)paren
(paren
r_int
id|test
comma
r_int
id|mask
)paren
suffix:semicolon
multiline_comment|/* returns 1 on correct comparison */
r_static
r_int
DECL|function|iop3xx_i2c_wait_event
id|iop3xx_i2c_wait_event
c_func
(paren
r_struct
id|i2c_algo_iop3xx_data
op_star
id|iop3xx_adap
comma
r_int
id|flags
comma
r_int
op_star
id|status
comma
id|compare_func
id|compare
)paren
(brace
r_int
id|sr
op_assign
l_int|0
suffix:semicolon
r_int
id|interrupted
suffix:semicolon
r_int
id|done
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_do
(brace
id|interrupted
op_assign
id|wait_event_interruptible_timeout
(paren
id|iop3xx_adap-&gt;waitq
comma
(paren
id|done
op_assign
id|compare
c_func
(paren
id|sr
op_assign
id|iop3xx_i2c_get_srstat
c_func
(paren
id|iop3xx_adap
)paren
comma
id|flags
)paren
)paren
comma
l_int|1
op_star
id|HZ
suffix:semicolon
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|iop3xx_i2c_error
c_func
(paren
id|sr
)paren
)paren
OL
l_int|0
)paren
(brace
op_star
id|status
op_assign
id|sr
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|interrupted
)paren
(brace
op_star
id|status
op_assign
id|sr
suffix:semicolon
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
op_logical_neg
id|done
)paren
(brace
suffix:semicolon
)brace
op_star
id|status
op_assign
id|sr
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Concrete compare_funcs &n; */
r_static
r_int
DECL|function|all_bits_clear
id|all_bits_clear
c_func
(paren
r_int
id|test
comma
r_int
id|mask
)paren
(brace
r_return
(paren
id|test
op_amp
id|mask
)paren
op_eq
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|any_bits_set
id|any_bits_set
c_func
(paren
r_int
id|test
comma
r_int
id|mask
)paren
(brace
r_return
(paren
id|test
op_amp
id|mask
)paren
op_ne
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|iop3xx_i2c_wait_tx_done
id|iop3xx_i2c_wait_tx_done
c_func
(paren
r_struct
id|i2c_algo_iop3xx_data
op_star
id|iop3xx_adap
comma
r_int
op_star
id|status
)paren
(brace
r_return
id|iop3xx_i2c_wait_event
c_func
(paren
id|iop3xx_adap
comma
id|IOP3XX_ISR_TXEMPTY
op_or
id|IOP3XX_ISR_ALD
op_or
id|IOP3XX_ISR_BERRD
comma
id|status
comma
id|any_bits_set
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|iop3xx_i2c_wait_rx_done
id|iop3xx_i2c_wait_rx_done
c_func
(paren
r_struct
id|i2c_algo_iop3xx_data
op_star
id|iop3xx_adap
comma
r_int
op_star
id|status
)paren
(brace
r_return
id|iop3xx_i2c_wait_event
c_func
(paren
id|iop3xx_adap
comma
id|IOP3XX_ISR_RXFULL
op_or
id|IOP3XX_ISR_ALD
op_or
id|IOP3XX_ISR_BERRD
comma
id|status
comma
id|any_bits_set
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|iop3xx_i2c_wait_idle
id|iop3xx_i2c_wait_idle
c_func
(paren
r_struct
id|i2c_algo_iop3xx_data
op_star
id|iop3xx_adap
comma
r_int
op_star
id|status
)paren
(brace
r_return
id|iop3xx_i2c_wait_event
c_func
(paren
id|iop3xx_adap
comma
id|IOP3XX_ISR_UNITBUSY
comma
id|status
comma
id|all_bits_clear
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|iop3xx_i2c_send_target_addr
id|iop3xx_i2c_send_target_addr
c_func
(paren
r_struct
id|i2c_algo_iop3xx_data
op_star
id|iop3xx_adap
comma
r_struct
id|i2c_msg
op_star
id|msg
)paren
(brace
r_int
r_int
id|cr
op_assign
id|__raw_readl
c_func
(paren
id|iop3xx_adap-&gt;ioaddr
op_plus
id|CR_OFFSET
)paren
suffix:semicolon
r_int
id|status
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|__raw_writel
c_func
(paren
id|iic_cook_addr
c_func
(paren
id|msg
)paren
comma
id|iop3xx_adap-&gt;ioaddr
op_plus
id|DBR_OFFSET
)paren
suffix:semicolon
id|cr
op_and_assign
op_complement
(paren
id|IOP3XX_ICR_MSTOP
op_or
id|IOP3XX_ICR_NACK
)paren
suffix:semicolon
id|cr
op_or_assign
id|IOP3XX_ICR_MSTART
op_or
id|IOP3XX_ICR_TBYTE
suffix:semicolon
id|__raw_writel
c_func
(paren
id|cr
comma
id|iop3xx_adap-&gt;ioaddr
op_plus
id|CR_OFFSET
)paren
suffix:semicolon
id|rc
op_assign
id|iop3xx_i2c_wait_tx_done
c_func
(paren
id|iop3xx_adap
comma
op_amp
id|status
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_static
r_int
DECL|function|iop3xx_i2c_write_byte
id|iop3xx_i2c_write_byte
c_func
(paren
r_struct
id|i2c_algo_iop3xx_data
op_star
id|iop3xx_adap
comma
r_char
id|byte
comma
r_int
id|stop
)paren
(brace
r_int
r_int
id|cr
op_assign
id|__raw_readl
c_func
(paren
id|iop3xx_adap-&gt;ioaddr
op_plus
id|CR_OFFSET
)paren
suffix:semicolon
r_int
id|status
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|__raw_writel
c_func
(paren
id|byte
comma
id|iop3xx_adap-&gt;ioaddr
op_plus
id|DBR_OFFSET
)paren
suffix:semicolon
id|cr
op_and_assign
op_complement
id|IOP3XX_ICR_MSTART
suffix:semicolon
r_if
c_cond
(paren
id|stop
)paren
(brace
id|cr
op_or_assign
id|IOP3XX_ICR_MSTOP
suffix:semicolon
)brace
r_else
(brace
id|cr
op_and_assign
op_complement
id|IOP3XX_ICR_MSTOP
suffix:semicolon
)brace
id|cr
op_or_assign
id|IOP3XX_ICR_TBYTE
suffix:semicolon
id|__raw_writel
c_func
(paren
id|cr
comma
id|iop3xx_adap-&gt;ioaddr
op_plus
id|CR_OFFSET
)paren
suffix:semicolon
id|rc
op_assign
id|iop3xx_i2c_wait_tx_done
c_func
(paren
id|iop3xx_adap
comma
op_amp
id|status
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_static
r_int
DECL|function|iop3xx_i2c_read_byte
id|iop3xx_i2c_read_byte
c_func
(paren
r_struct
id|i2c_algo_iop3xx_data
op_star
id|iop3xx_adap
comma
r_char
op_star
id|byte
comma
r_int
id|stop
)paren
(brace
r_int
r_int
id|cr
op_assign
id|__raw_readl
c_func
(paren
id|iop3xx_adap-&gt;ioaddr
op_plus
id|CR_OFFSET
)paren
suffix:semicolon
r_int
id|status
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|cr
op_and_assign
op_complement
id|IOP3XX_ICR_MSTART
suffix:semicolon
r_if
c_cond
(paren
id|stop
)paren
(brace
id|cr
op_or_assign
id|IOP3XX_ICR_MSTOP
op_or
id|IOP3XX_ICR_NACK
suffix:semicolon
)brace
r_else
(brace
id|cr
op_and_assign
op_complement
(paren
id|IOP3XX_ICR_MSTOP
op_or
id|IOP3XX_ICR_NACK
)paren
suffix:semicolon
)brace
id|cr
op_or_assign
id|IOP3XX_ICR_TBYTE
suffix:semicolon
id|__raw_writel
c_func
(paren
id|cr
comma
id|iop3xx_adap-&gt;ioaddr
op_plus
id|CR_OFFSET
)paren
suffix:semicolon
id|rc
op_assign
id|iop3xx_i2c_wait_rx_done
c_func
(paren
id|iop3xx_adap
comma
op_amp
id|status
)paren
suffix:semicolon
op_star
id|byte
op_assign
id|__raw_readl
c_func
(paren
id|iop3xx_adap-&gt;ioaddr
op_plus
id|DBR_OFFSET
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_static
r_int
DECL|function|iop3xx_i2c_writebytes
id|iop3xx_i2c_writebytes
c_func
(paren
r_struct
id|i2c_adapter
op_star
id|i2c_adap
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_struct
id|i2c_algo_iop3xx_data
op_star
id|iop3xx_adap
op_assign
id|i2c_adap-&gt;algo_data
suffix:semicolon
r_int
id|ii
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|rc
op_eq
l_int|0
op_logical_and
id|ii
op_ne
id|count
suffix:semicolon
op_increment
id|ii
)paren
id|rc
op_assign
id|iop3xx_i2c_write_byte
c_func
(paren
id|iop3xx_adap
comma
id|buf
(braket
id|ii
)braket
comma
id|ii
op_eq
id|count
op_minus
l_int|1
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_static
r_int
DECL|function|iop3xx_i2c_readbytes
id|iop3xx_i2c_readbytes
c_func
(paren
r_struct
id|i2c_adapter
op_star
id|i2c_adap
comma
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_struct
id|i2c_algo_iop3xx_data
op_star
id|iop3xx_adap
op_assign
id|i2c_adap-&gt;algo_data
suffix:semicolon
r_int
id|ii
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|ii
op_assign
l_int|0
suffix:semicolon
id|rc
op_eq
l_int|0
op_logical_and
id|ii
op_ne
id|count
suffix:semicolon
op_increment
id|ii
)paren
id|rc
op_assign
id|iop3xx_i2c_read_byte
c_func
(paren
id|iop3xx_adap
comma
op_amp
id|buf
(braket
id|ii
)braket
comma
id|ii
op_eq
id|count
op_minus
l_int|1
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*&n; * Description:  This function implements combined transactions.  Combined&n; * transactions consist of combinations of reading and writing blocks of data.&n; * FROM THE SAME ADDRESS&n; * Each transfer (i.e. a read or a write) is separated by a repeated start&n; * condition.&n; */
r_static
r_int
DECL|function|iop3xx_i2c_handle_msg
id|iop3xx_i2c_handle_msg
c_func
(paren
r_struct
id|i2c_adapter
op_star
id|i2c_adap
comma
r_struct
id|i2c_msg
op_star
id|pmsg
)paren
(brace
r_struct
id|i2c_algo_iop3xx_data
op_star
id|iop3xx_adap
op_assign
id|i2c_adap-&gt;algo_data
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|rc
op_assign
id|iop3xx_i2c_send_target_addr
c_func
(paren
id|iop3xx_adap
comma
id|pmsg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
(brace
r_return
id|rc
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|pmsg-&gt;flags
op_amp
id|I2C_M_RD
)paren
)paren
(brace
r_return
id|iop3xx_i2c_readbytes
c_func
(paren
id|i2c_adap
comma
id|pmsg-&gt;buf
comma
id|pmsg-&gt;len
)paren
suffix:semicolon
)brace
r_else
(brace
r_return
id|iop3xx_i2c_writebytes
c_func
(paren
id|i2c_adap
comma
id|pmsg-&gt;buf
comma
id|pmsg-&gt;len
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * master_xfer() - main read/write entry&n; */
r_static
r_int
DECL|function|iop3xx_i2c_master_xfer
id|iop3xx_i2c_master_xfer
c_func
(paren
r_struct
id|i2c_adapter
op_star
id|i2c_adap
comma
r_struct
id|i2c_msg
id|msgs
(braket
)braket
comma
r_int
id|num
)paren
(brace
r_struct
id|i2c_algo_iop3xx_data
op_star
id|iop3xx_adap
op_assign
id|i2c_adap-&gt;algo_data
suffix:semicolon
r_int
id|im
op_assign
l_int|0
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_int
id|status
suffix:semicolon
id|iop3xx_i2c_wait_idle
c_func
(paren
id|iop3xx_adap
comma
op_amp
id|status
)paren
suffix:semicolon
id|iop3xx_i2c_reset
c_func
(paren
id|iop3xx_adap
)paren
suffix:semicolon
id|iop3xx_i2c_enable
c_func
(paren
id|iop3xx_adap
)paren
suffix:semicolon
r_for
c_loop
(paren
id|im
op_assign
l_int|0
suffix:semicolon
id|ret
op_eq
l_int|0
op_logical_and
id|im
op_ne
id|num
suffix:semicolon
id|im
op_increment
)paren
(brace
id|ret
op_assign
id|iop3xx_i2c_handle_msg
c_func
(paren
id|i2c_adap
comma
op_amp
id|msgs
(braket
id|im
)braket
)paren
suffix:semicolon
)brace
id|iop3xx_i2c_transaction_cleanup
c_func
(paren
id|iop3xx_adap
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
r_return
id|ret
suffix:semicolon
)brace
r_return
id|im
suffix:semicolon
)brace
r_static
r_int
DECL|function|iop3xx_i2c_algo_control
id|iop3xx_i2c_algo_control
c_func
(paren
r_struct
id|i2c_adapter
op_star
id|adapter
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
id|u32
DECL|function|iop3xx_i2c_func
id|iop3xx_i2c_func
c_func
(paren
r_struct
id|i2c_adapter
op_star
id|adap
)paren
(brace
r_return
id|I2C_FUNC_I2C
op_or
id|I2C_FUNC_SMBUS_EMUL
suffix:semicolon
)brace
DECL|variable|iop3xx_i2c_algo
r_static
r_struct
id|i2c_algorithm
id|iop3xx_i2c_algo
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;IOP3xx I2C algorithm&quot;
comma
dot
id|id
op_assign
id|I2C_ALGO_IOP3XX
comma
dot
id|master_xfer
op_assign
id|iop3xx_i2c_master_xfer
comma
dot
id|algo_control
op_assign
id|iop3xx_i2c_algo_control
comma
dot
id|functionality
op_assign
id|iop3xx_i2c_func
comma
)brace
suffix:semicolon
r_static
r_int
DECL|function|iop3xx_i2c_remove
id|iop3xx_i2c_remove
c_func
(paren
r_struct
id|device
op_star
id|device
)paren
(brace
r_struct
id|platform_device
op_star
id|pdev
op_assign
id|to_platform_device
c_func
(paren
id|device
)paren
suffix:semicolon
r_struct
id|i2c_adapter
op_star
id|padapter
op_assign
id|dev_get_drvdata
c_func
(paren
op_amp
id|pdev-&gt;dev
)paren
suffix:semicolon
r_struct
id|i2c_algo_iop3xx_data
op_star
id|adapter_data
op_assign
(paren
r_struct
id|i2c_algo_iop3xx_data
op_star
)paren
id|padapter-&gt;algo_data
suffix:semicolon
r_struct
id|resource
op_star
id|res
op_assign
id|platform_get_resource
c_func
(paren
id|pdev
comma
id|IORESOURCE_MEM
comma
l_int|0
)paren
suffix:semicolon
r_int
r_int
id|cr
op_assign
id|__raw_readl
c_func
(paren
id|adapter_data-&gt;ioaddr
op_plus
id|CR_OFFSET
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Disable the actual HW unit&n;&t; */
id|cr
op_and_assign
op_complement
(paren
id|IOP3XX_ICR_ALD_IE
op_or
id|IOP3XX_ICR_BERR_IE
op_or
id|IOP3XX_ICR_RXFULL_IE
op_or
id|IOP3XX_ICR_TXEMPTY_IE
)paren
suffix:semicolon
id|__raw_writel
c_func
(paren
id|cr
comma
id|adapter_data-&gt;ioaddr
op_plus
id|CR_OFFSET
)paren
suffix:semicolon
id|iounmap
c_func
(paren
(paren
r_void
id|__iomem
op_star
)paren
id|adapter_data-&gt;ioaddr
)paren
suffix:semicolon
id|release_mem_region
c_func
(paren
id|res-&gt;start
comma
id|IOP3XX_I2C_IO_SIZE
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|adapter_data
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|padapter
)paren
suffix:semicolon
id|dev_set_drvdata
c_func
(paren
op_amp
id|pdev-&gt;dev
comma
l_int|NULL
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|iop3xx_i2c_probe
id|iop3xx_i2c_probe
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|platform_device
op_star
id|pdev
op_assign
id|to_platform_device
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|resource
op_star
id|res
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_struct
id|i2c_adapter
op_star
id|new_adapter
suffix:semicolon
r_struct
id|i2c_algo_iop3xx_data
op_star
id|adapter_data
suffix:semicolon
id|new_adapter
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|i2c_adapter
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|new_adapter
)paren
(brace
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|memset
c_func
(paren
(paren
r_void
op_star
)paren
id|new_adapter
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|new_adapter
)paren
)paren
suffix:semicolon
id|adapter_data
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|i2c_algo_iop3xx_data
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|adapter_data
)paren
(brace
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|free_adapter
suffix:semicolon
)brace
id|memset
c_func
(paren
(paren
r_void
op_star
)paren
id|adapter_data
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|adapter_data
)paren
)paren
suffix:semicolon
id|res
op_assign
id|platform_get_resource
c_func
(paren
id|pdev
comma
id|IORESOURCE_MEM
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|res
)paren
(brace
id|ret
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|free_both
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|request_mem_region
c_func
(paren
id|res-&gt;start
comma
id|IOP3XX_I2C_IO_SIZE
comma
id|pdev-&gt;name
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_goto
id|free_both
suffix:semicolon
)brace
multiline_comment|/* set the adapter enumeration # */
id|adapter_data-&gt;id
op_assign
id|i2c_id
op_increment
suffix:semicolon
id|adapter_data-&gt;ioaddr
op_assign
(paren
id|u32
)paren
id|ioremap
c_func
(paren
id|res-&gt;start
comma
id|IOP3XX_I2C_IO_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|adapter_data-&gt;ioaddr
)paren
(brace
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|release_region
suffix:semicolon
)brace
id|res
op_assign
id|request_irq
c_func
(paren
id|platform_get_irq
c_func
(paren
id|pdev
comma
l_int|0
)paren
comma
id|iop3xx_i2c_irq_handler
comma
l_int|0
comma
id|pdev-&gt;name
comma
id|adapter_data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
)paren
(brace
id|ret
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|unmap
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|new_adapter-&gt;name
comma
id|pdev-&gt;name
comma
id|strlen
c_func
(paren
id|pdev-&gt;name
)paren
)paren
suffix:semicolon
id|new_adapter-&gt;id
op_assign
id|I2C_HW_IOP3XX
suffix:semicolon
id|new_adapter-&gt;owner
op_assign
id|THIS_MODULE
suffix:semicolon
id|new_adapter-&gt;dev.parent
op_assign
op_amp
id|pdev-&gt;dev
suffix:semicolon
multiline_comment|/*&n;&t; * Default values...should these come in from board code?&n;&t; */
id|new_adapter-&gt;timeout
op_assign
l_int|100
suffix:semicolon
id|new_adapter-&gt;retries
op_assign
l_int|3
suffix:semicolon
id|new_adapter-&gt;algo
op_assign
op_amp
id|iop3xx_i2c_algo
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|adapter_data-&gt;waitq
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|adapter_data-&gt;lock
)paren
suffix:semicolon
id|iop3xx_i2c_reset
c_func
(paren
id|adapter_data
)paren
suffix:semicolon
id|iop3xx_i2c_set_slave_addr
c_func
(paren
id|adapter_data
)paren
suffix:semicolon
id|iop3xx_i2c_enable
c_func
(paren
id|adapter_data
)paren
suffix:semicolon
id|dev_set_drvdata
c_func
(paren
op_amp
id|pdev-&gt;dev
comma
id|new_adapter
)paren
suffix:semicolon
id|new_adapter-&gt;algo_data
op_assign
id|adapter_data
suffix:semicolon
id|i2c_add_adapter
c_func
(paren
id|new_adapter
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|unmap
suffix:colon
id|iounmap
c_func
(paren
(paren
r_void
id|__iomem
op_star
)paren
id|adapter_data-&gt;ioaddr
)paren
suffix:semicolon
id|release_region
suffix:colon
id|release_mem_region
c_func
(paren
id|res-&gt;start
comma
id|IOP3XX_I2C_IO_SIZE
)paren
suffix:semicolon
id|free_both
suffix:colon
id|kfree
c_func
(paren
id|adapter_data
)paren
suffix:semicolon
id|free_adapter
suffix:colon
id|kfree
c_func
(paren
id|new_adapter
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|ret
suffix:semicolon
)brace
DECL|variable|iop3xx_i2c_driver
r_static
r_struct
id|device_driver
id|iop3xx_i2c_driver
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;IOP3xx-I2C&quot;
comma
dot
id|bus
op_assign
op_amp
id|platform_bus_type
comma
dot
id|probe
op_assign
id|iop3xx_i2c_probe
comma
dot
id|remove
op_assign
id|iop3xx_i2c_remove
)brace
suffix:semicolon
r_static
r_int
id|__init
DECL|function|i2c_iop3xx_init
id|i2c_iop3xx_init
(paren
r_void
)paren
(brace
r_return
id|driver_register
c_func
(paren
op_amp
id|iop3xx_i2c_driver
)paren
suffix:semicolon
)brace
r_static
r_void
id|__exit
DECL|function|i2c_iop3xx_exit
id|i2c_iop3xx_exit
(paren
r_void
)paren
(brace
id|driver_unregister
c_func
(paren
op_amp
id|iop3xx_i2c_driver
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|variable|i2c_iop3xx_init
id|module_init
(paren
id|i2c_iop3xx_init
)paren
suffix:semicolon
DECL|variable|i2c_iop3xx_exit
id|module_exit
(paren
id|i2c_iop3xx_exit
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;D-TACQ Solutions Ltd &lt;www.d-tacq.com&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;IOP3xx iic algorithm and driver&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
eof
