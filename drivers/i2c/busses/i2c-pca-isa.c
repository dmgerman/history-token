multiline_comment|/*&n; *  i2c-pca-isa.c driver for PCA9564 on ISA boards&n; *    Copyright (C) 2004 Arcom Control Systems&n; *&n; *  This program is free software; you can redistribute it and/or modify&n; *  it under the terms of the GNU General Public License as published by&n; *  the Free Software Foundation; either version 2 of the License, or&n; *  (at your option) any later version.&n; *&n; *  This program is distributed in the hope that it will be useful,&n; *  but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *  GNU General Public License for more details.&n; *&n; *  You should have received a copy of the GNU General Public License&n; *  along with this program; if not, write to the Free Software&n; *  Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/moduleparam.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/wait.h&gt;
macro_line|#include &lt;linux/i2c.h&gt;
macro_line|#include &lt;linux/i2c-algo-pca.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &quot;../algos/i2c-algo-pca.h&quot;
DECL|macro|IO_SIZE
mdefine_line|#define IO_SIZE 4
DECL|macro|DEBUG_IO
macro_line|#undef DEBUG_IO
singleline_comment|//#define DEBUG_IO
DECL|variable|base
r_static
r_int
r_int
id|base
op_assign
l_int|0x330
suffix:semicolon
DECL|variable|irq
r_static
r_int
id|irq
op_assign
l_int|10
suffix:semicolon
multiline_comment|/* Data sheet recommends 59kHz for 100kHz operation due to variation&n; * in the actual clock rate */
DECL|variable|clock
r_static
r_int
id|clock
op_assign
id|I2C_PCA_CON_59kHz
suffix:semicolon
DECL|variable|own
r_static
r_int
id|own
op_assign
l_int|0x55
suffix:semicolon
DECL|variable|pca_wait
r_static
id|wait_queue_head_t
id|pca_wait
suffix:semicolon
DECL|function|pca_isa_getown
r_static
r_int
id|pca_isa_getown
c_func
(paren
r_struct
id|i2c_algo_pca_data
op_star
id|adap
)paren
(brace
r_return
(paren
id|own
)paren
suffix:semicolon
)brace
DECL|function|pca_isa_getclock
r_static
r_int
id|pca_isa_getclock
c_func
(paren
r_struct
id|i2c_algo_pca_data
op_star
id|adap
)paren
(brace
r_return
(paren
id|clock
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|pca_isa_writebyte
id|pca_isa_writebyte
c_func
(paren
r_struct
id|i2c_algo_pca_data
op_star
id|adap
comma
r_int
id|reg
comma
r_int
id|val
)paren
(brace
macro_line|#ifdef DEBUG_IO
r_static
r_char
op_star
id|names
(braket
)braket
op_assign
(brace
l_string|&quot;T/O&quot;
comma
l_string|&quot;DAT&quot;
comma
l_string|&quot;ADR&quot;
comma
l_string|&quot;CON&quot;
)brace
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;*** write %s at %#lx &lt;= %#04x&bslash;n&quot;
comma
id|names
(braket
id|reg
)braket
comma
id|base
op_plus
id|reg
comma
id|val
)paren
suffix:semicolon
macro_line|#endif
id|outb
c_func
(paren
id|val
comma
id|base
op_plus
id|reg
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|pca_isa_readbyte
id|pca_isa_readbyte
c_func
(paren
r_struct
id|i2c_algo_pca_data
op_star
id|adap
comma
r_int
id|reg
)paren
(brace
r_int
id|res
op_assign
id|inb
c_func
(paren
id|base
op_plus
id|reg
)paren
suffix:semicolon
macro_line|#ifdef DEBUG_IO
(brace
r_static
r_char
op_star
id|names
(braket
)braket
op_assign
(brace
l_string|&quot;STA&quot;
comma
l_string|&quot;DAT&quot;
comma
l_string|&quot;ADR&quot;
comma
l_string|&quot;CON&quot;
)brace
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;*** read  %s =&gt; %#04x&bslash;n&quot;
comma
id|names
(braket
id|reg
)braket
comma
id|res
)paren
suffix:semicolon
)brace
macro_line|#endif
r_return
id|res
suffix:semicolon
)brace
DECL|function|pca_isa_waitforinterrupt
r_static
r_int
id|pca_isa_waitforinterrupt
c_func
(paren
r_struct
id|i2c_algo_pca_data
op_star
id|adap
)paren
(brace
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|irq
OG
op_minus
l_int|1
)paren
(brace
id|ret
op_assign
id|wait_event_interruptible
c_func
(paren
id|pca_wait
comma
id|pca_isa_readbyte
c_func
(paren
id|adap
comma
id|I2C_PCA_CON
)paren
op_amp
id|I2C_PCA_CON_SI
)paren
suffix:semicolon
)brace
r_else
(brace
r_while
c_loop
(paren
(paren
id|pca_isa_readbyte
c_func
(paren
id|adap
comma
id|I2C_PCA_CON
)paren
op_amp
id|I2C_PCA_CON_SI
)paren
op_eq
l_int|0
)paren
id|udelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|function|pca_handler
r_static
id|irqreturn_t
id|pca_handler
c_func
(paren
r_int
id|this_irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|wake_up_interruptible
c_func
(paren
op_amp
id|pca_wait
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
DECL|variable|pca_isa_data
r_static
r_struct
id|i2c_algo_pca_data
id|pca_isa_data
op_assign
(brace
dot
id|get_own
op_assign
id|pca_isa_getown
comma
dot
id|get_clock
op_assign
id|pca_isa_getclock
comma
dot
id|write_byte
op_assign
id|pca_isa_writebyte
comma
dot
id|read_byte
op_assign
id|pca_isa_readbyte
comma
dot
id|wait_for_interrupt
op_assign
id|pca_isa_waitforinterrupt
comma
)brace
suffix:semicolon
DECL|variable|pca_isa_ops
r_static
r_struct
id|i2c_adapter
id|pca_isa_ops
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|id
op_assign
id|I2C_HW_A_ISA
comma
dot
id|algo_data
op_assign
op_amp
id|pca_isa_data
comma
dot
id|name
op_assign
l_string|&quot;PCA9564 ISA Adapter&quot;
comma
)brace
suffix:semicolon
DECL|function|pca_isa_init
r_static
r_int
id|__init
id|pca_isa_init
c_func
(paren
r_void
)paren
(brace
id|init_waitqueue_head
c_func
(paren
op_amp
id|pca_wait
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;i2c-pca-isa: i/o base %#08lx. irq %d&bslash;n&quot;
comma
id|base
comma
id|irq
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|request_region
c_func
(paren
id|base
comma
id|IO_SIZE
comma
l_string|&quot;i2c-pca-isa&quot;
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;i2c-pca-isa: I/O address %#08lx is in use.&bslash;n&quot;
comma
id|base
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|irq
OG
op_minus
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|irq
comma
id|pca_handler
comma
l_int|0
comma
l_string|&quot;i2c-pca-isa&quot;
comma
op_amp
id|pca_isa_ops
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;i2c-pca-isa: Request irq%d failed&bslash;n&quot;
comma
id|irq
)paren
suffix:semicolon
r_goto
id|out_region
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|i2c_pca_add_bus
c_func
(paren
op_amp
id|pca_isa_ops
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;i2c-pca-isa: Failed to add i2c bus&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out_irq
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
id|out_irq
suffix:colon
r_if
c_cond
(paren
id|irq
OG
op_minus
l_int|1
)paren
id|free_irq
c_func
(paren
id|irq
comma
op_amp
id|pca_isa_ops
)paren
suffix:semicolon
id|out_region
suffix:colon
id|release_region
c_func
(paren
id|base
comma
id|IO_SIZE
)paren
suffix:semicolon
id|out
suffix:colon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
DECL|function|pca_isa_exit
r_static
r_void
id|pca_isa_exit
c_func
(paren
r_void
)paren
(brace
id|i2c_pca_del_bus
c_func
(paren
op_amp
id|pca_isa_ops
)paren
suffix:semicolon
r_if
c_cond
(paren
id|irq
OG
l_int|0
)paren
(brace
id|disable_irq
c_func
(paren
id|irq
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|irq
comma
op_amp
id|pca_isa_ops
)paren
suffix:semicolon
)brace
id|release_region
c_func
(paren
id|base
comma
id|IO_SIZE
)paren
suffix:semicolon
)brace
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Ian Campbell &lt;icampbell@arcom.com&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;ISA base PCA9564 driver&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|module_param
c_func
(paren
id|base
comma
id|ulong
comma
l_int|0
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|base
comma
l_string|&quot;I/O base address&quot;
)paren
suffix:semicolon
id|module_param
c_func
(paren
id|irq
comma
r_int
comma
l_int|0
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|irq
comma
l_string|&quot;IRQ&quot;
)paren
suffix:semicolon
id|module_param
c_func
(paren
id|clock
comma
r_int
comma
l_int|0
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|clock
comma
l_string|&quot;Clock rate as described in table 1 of PCA9564 datasheet&quot;
)paren
suffix:semicolon
id|module_param
c_func
(paren
id|own
comma
r_int
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* the driver can&squot;t do slave mode, so there&squot;s no real point in this */
DECL|variable|pca_isa_init
id|module_init
c_func
(paren
id|pca_isa_init
)paren
suffix:semicolon
DECL|variable|pca_isa_exit
id|module_exit
c_func
(paren
id|pca_isa_exit
)paren
suffix:semicolon
eof
