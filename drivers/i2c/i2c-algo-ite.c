multiline_comment|/*&n;   -------------------------------------------------------------------------&n;   i2c-algo-ite.c i2c driver algorithms for ITE adapters&t;    &n;   &n;   Hai-Pao Fan, MontaVista Software, Inc.&n;   hpfan@mvista.com or source@mvista.com&n;&n;   Copyright 2000 MontaVista Software Inc.&n;&n;   ---------------------------------------------------------------------------&n;   This file was highly leveraged from i2c-algo-pcf.c, which was created&n;   by Simon G. Vogl and Hans Berglund:&n;&n;&n;     Copyright (C) 1995-1997 Simon G. Vogl&n;                   1998-2000 Hans Berglund&n;&n;    This program is free software; you can redistribute it and/or modify&n;    it under the terms of the GNU General Public License as published by&n;    the Free Software Foundation; either version 2 of the License, or&n;    (at your option) any later version.&n;&n;    This program is distributed in the hope that it will be useful,&n;    but WITHOUT ANY WARRANTY; without even the implied warranty of&n;    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n;    GNU General Public License for more details.&n;&n;    You should have received a copy of the GNU General Public License&n;    along with this program; if not, write to the Free Software&n;    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&t;&t;     */
multiline_comment|/* ------------------------------------------------------------------------- */
multiline_comment|/* With some changes from Ky&#xfffd;sti M&#xfffd;lkki &lt;kmalkki@cc.hut.fi&gt; and &n;   Frodo Looijaard &lt;frodol@dds.nl&gt; ,and also from Martin Bailey&n;   &lt;mbailey@littlefeet-inc.com&gt; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/i2c.h&gt;
macro_line|#include &lt;linux/i2c-algo-ite.h&gt;
macro_line|#include &quot;i2c-ite.h&quot;
DECL|macro|PM_DSR
mdefine_line|#define&t;PM_DSR&t;&t;IT8172_PCI_IO_BASE + IT_PM_DSR
DECL|macro|PM_IBSR
mdefine_line|#define&t;PM_IBSR&t;&t;IT8172_PCI_IO_BASE + IT_PM_DSR + 0x04 
DECL|macro|GPIO_CCR
mdefine_line|#define GPIO_CCR&t;IT8172_PCI_IO_BASE + IT_GPCCR
multiline_comment|/* ----- global defines ----------------------------------------------- */
DECL|macro|DEB
mdefine_line|#define DEB(x) if (i2c_debug&gt;=1) x
DECL|macro|DEB2
mdefine_line|#define DEB2(x) if (i2c_debug&gt;=2) x
DECL|macro|DEB3
mdefine_line|#define DEB3(x) if (i2c_debug&gt;=3) x /* print several statistical values*/
DECL|macro|DEBPROTO
mdefine_line|#define DEBPROTO(x) if (i2c_debug&gt;=9) x;
multiline_comment|/* debug the protocol by showing transferred bits */
DECL|macro|DEF_TIMEOUT
mdefine_line|#define DEF_TIMEOUT 16
multiline_comment|/* debugging - slow down transfer to have a look at the data .. &t;*/
multiline_comment|/* I use this with two leds&amp;resistors, each one connected to sda,scl &t;*/
multiline_comment|/* respectively. This makes sure that the algorithm works. Some chips   */
multiline_comment|/* might not like this, as they have an internal timeout of some mils&t;*/
multiline_comment|/*&n;#define SLO_IO      jif=jiffies;while(jiffies&lt;=jif+i2c_table[minor].veryslow)&bslash;&n;                        cond_resched();&n;*/
multiline_comment|/* ----- global variables ---------------------------------------------&t;*/
macro_line|#ifdef SLO_IO
DECL|variable|jif
r_int
id|jif
suffix:semicolon
macro_line|#endif
multiline_comment|/* module parameters:&n; */
DECL|variable|i2c_debug
r_static
r_int
id|i2c_debug
op_assign
l_int|1
suffix:semicolon
DECL|variable|iic_test
r_static
r_int
id|iic_test
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* see if the line-setting functions work&t;*/
DECL|variable|iic_scan
r_static
r_int
id|iic_scan
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* have a look at what&squot;s hanging &squot;round&t;&t;*/
multiline_comment|/* --- setting states on the bus with the right timing: ---------------&t;*/
DECL|macro|get_clock
mdefine_line|#define get_clock(adap) adap-&gt;getclock(adap-&gt;data)
DECL|macro|iic_outw
mdefine_line|#define iic_outw(adap, reg, val) adap-&gt;setiic(adap-&gt;data, reg, val)
DECL|macro|iic_inw
mdefine_line|#define iic_inw(adap, reg) adap-&gt;getiic(adap-&gt;data, reg)
multiline_comment|/* --- other auxiliary functions --------------------------------------&t;*/
DECL|function|iic_start
r_static
r_void
id|iic_start
c_func
(paren
r_struct
id|i2c_algo_iic_data
op_star
id|adap
)paren
(brace
id|iic_outw
c_func
(paren
id|adap
comma
id|ITE_I2CHCR
comma
id|ITE_CMD
)paren
suffix:semicolon
)brace
DECL|function|iic_stop
r_static
r_void
id|iic_stop
c_func
(paren
r_struct
id|i2c_algo_iic_data
op_star
id|adap
)paren
(brace
id|iic_outw
c_func
(paren
id|adap
comma
id|ITE_I2CHCR
comma
l_int|0
)paren
suffix:semicolon
id|iic_outw
c_func
(paren
id|adap
comma
id|ITE_I2CHSR
comma
id|ITE_I2CHSR_TDI
)paren
suffix:semicolon
)brace
DECL|function|iic_reset
r_static
r_void
id|iic_reset
c_func
(paren
r_struct
id|i2c_algo_iic_data
op_star
id|adap
)paren
(brace
id|iic_outw
c_func
(paren
id|adap
comma
id|PM_IBSR
comma
id|iic_inw
c_func
(paren
id|adap
comma
id|PM_IBSR
)paren
op_or
l_int|0x80
)paren
suffix:semicolon
)brace
DECL|function|wait_for_bb
r_static
r_int
id|wait_for_bb
c_func
(paren
r_struct
id|i2c_algo_iic_data
op_star
id|adap
)paren
(brace
r_int
id|timeout
op_assign
id|DEF_TIMEOUT
suffix:semicolon
r_int
id|status
suffix:semicolon
id|status
op_assign
id|iic_inw
c_func
(paren
id|adap
comma
id|ITE_I2CHSR
)paren
suffix:semicolon
macro_line|#ifndef STUB_I2C
r_while
c_loop
(paren
id|timeout
op_decrement
op_logical_and
(paren
id|status
op_amp
id|ITE_I2CHSR_HB
)paren
)paren
(brace
id|udelay
c_func
(paren
l_int|1000
)paren
suffix:semicolon
multiline_comment|/* How much is this? */
id|status
op_assign
id|iic_inw
c_func
(paren
id|adap
comma
id|ITE_I2CHSR
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|timeout
op_le
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Timeout, host is busy&bslash;n&quot;
)paren
suffix:semicolon
id|iic_reset
c_func
(paren
id|adap
)paren
suffix:semicolon
)brace
r_return
id|timeout
op_le
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Puts this process to sleep for a period equal to timeout &n; */
DECL|function|iic_sleep
r_static
r_inline
r_void
id|iic_sleep
c_func
(paren
r_int
r_int
id|timeout
)paren
(brace
id|schedule_timeout
c_func
(paren
id|timeout
op_star
id|HZ
)paren
suffix:semicolon
)brace
multiline_comment|/* After we issue a transaction on the IIC bus, this function&n; * is called.  It puts this process to sleep until we get an interrupt from&n; * from the controller telling us that the transaction we requested in complete.&n; */
DECL|function|wait_for_pin
r_static
r_int
id|wait_for_pin
c_func
(paren
r_struct
id|i2c_algo_iic_data
op_star
id|adap
comma
r_int
op_star
id|status
)paren
(brace
r_int
id|timeout
op_assign
id|DEF_TIMEOUT
suffix:semicolon
id|timeout
op_assign
id|wait_for_bb
c_func
(paren
id|adap
)paren
suffix:semicolon
r_if
c_cond
(paren
id|timeout
)paren
(brace
id|DEB2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Timeout waiting for host not busy&bslash;n&quot;
)paren
suffix:semicolon
)paren
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|timeout
op_assign
id|DEF_TIMEOUT
suffix:semicolon
op_star
id|status
op_assign
id|iic_inw
c_func
(paren
id|adap
comma
id|ITE_I2CHSR
)paren
suffix:semicolon
macro_line|#ifndef STUB_I2C
r_while
c_loop
(paren
id|timeout
op_decrement
op_logical_and
op_logical_neg
(paren
op_star
id|status
op_amp
id|ITE_I2CHSR_TDI
)paren
)paren
(brace
id|adap
op_member_access_from_pointer
id|waitforpin
c_func
(paren
)paren
suffix:semicolon
op_star
id|status
op_assign
id|iic_inw
c_func
(paren
id|adap
comma
id|ITE_I2CHSR
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|timeout
op_le
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_else
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|wait_for_fe
r_static
r_int
id|wait_for_fe
c_func
(paren
r_struct
id|i2c_algo_iic_data
op_star
id|adap
comma
r_int
op_star
id|status
)paren
(brace
r_int
id|timeout
op_assign
id|DEF_TIMEOUT
suffix:semicolon
op_star
id|status
op_assign
id|iic_inw
c_func
(paren
id|adap
comma
id|ITE_I2CFSR
)paren
suffix:semicolon
macro_line|#ifndef STUB_I2C 
r_while
c_loop
(paren
id|timeout
op_decrement
op_logical_and
(paren
op_star
id|status
op_amp
id|ITE_I2CFSR_FE
)paren
)paren
(brace
id|udelay
c_func
(paren
l_int|1000
)paren
suffix:semicolon
id|iic_inw
c_func
(paren
id|adap
comma
id|ITE_I2CFSR
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|timeout
op_le
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_else
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|iic_init
r_static
r_int
id|iic_init
(paren
r_struct
id|i2c_algo_iic_data
op_star
id|adap
)paren
(brace
r_int
id|i
suffix:semicolon
multiline_comment|/* Clear bit 7 to set I2C to normal operation mode */
id|i
op_assign
id|iic_inw
c_func
(paren
id|adap
comma
id|PM_DSR
)paren
op_amp
l_int|0xff7f
suffix:semicolon
id|iic_outw
c_func
(paren
id|adap
comma
id|PM_DSR
comma
id|i
)paren
suffix:semicolon
multiline_comment|/* set IT_GPCCR port C bit 2&amp;3 as function 2 */
id|i
op_assign
id|iic_inw
c_func
(paren
id|adap
comma
id|GPIO_CCR
)paren
op_amp
l_int|0xfc0f
suffix:semicolon
id|iic_outw
c_func
(paren
id|adap
comma
id|GPIO_CCR
comma
id|i
)paren
suffix:semicolon
multiline_comment|/* Clear slave address/sub-address */
id|iic_outw
c_func
(paren
id|adap
comma
id|ITE_I2CSAR
comma
l_int|0
)paren
suffix:semicolon
id|iic_outw
c_func
(paren
id|adap
comma
id|ITE_I2CSSAR
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Set clock counter register */
id|iic_outw
c_func
(paren
id|adap
comma
id|ITE_I2CCKCNT
comma
id|get_clock
c_func
(paren
id|adap
)paren
)paren
suffix:semicolon
multiline_comment|/* Set START/reSTART/STOP time registers */
id|iic_outw
c_func
(paren
id|adap
comma
id|ITE_I2CSHDR
comma
l_int|0x0a
)paren
suffix:semicolon
id|iic_outw
c_func
(paren
id|adap
comma
id|ITE_I2CRSUR
comma
l_int|0x0a
)paren
suffix:semicolon
id|iic_outw
c_func
(paren
id|adap
comma
id|ITE_I2CPSUR
comma
l_int|0x0a
)paren
suffix:semicolon
multiline_comment|/* Enable interrupts on completing the current transaction */
id|iic_outw
c_func
(paren
id|adap
comma
id|ITE_I2CHCR
comma
id|ITE_I2CHCR_IE
op_or
id|ITE_I2CHCR_HCE
)paren
suffix:semicolon
multiline_comment|/* Clear transfer count */
id|iic_outw
c_func
(paren
id|adap
comma
id|ITE_I2CFBCR
comma
l_int|0x0
)paren
suffix:semicolon
id|DEB2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;iic_init: Initialized IIC on ITE 0x%x&bslash;n&quot;
comma
id|iic_inw
c_func
(paren
id|adap
comma
id|ITE_I2CHSR
)paren
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Sanity check for the adapter hardware - check the reaction of&n; * the bus lines only if it seems to be idle.&n; */
DECL|function|test_bus
r_static
r_int
id|test_bus
c_func
(paren
r_struct
id|i2c_algo_iic_data
op_star
id|adap
comma
r_char
op_star
id|name
)paren
(brace
macro_line|#if 0
r_int
id|scl
comma
id|sda
suffix:semicolon
id|sda
op_assign
id|getsda
c_func
(paren
id|adap
)paren
suffix:semicolon
r_if
c_cond
(paren
id|adap-&gt;getscl
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;test_bus: Warning: Adapter can&squot;t read from clock line - skipping test.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|scl
op_assign
id|getscl
c_func
(paren
id|adap
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;test_bus: Adapter: %s scl: %d  sda: %d -- testing...&bslash;n&quot;
comma
id|name
comma
id|getscl
c_func
(paren
id|adap
)paren
comma
id|getsda
c_func
(paren
id|adap
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|scl
op_logical_or
op_logical_neg
id|sda
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;test_bus: %s seems to be busy.&bslash;n&quot;
comma
id|adap-&gt;name
)paren
suffix:semicolon
r_goto
id|bailout
suffix:semicolon
)brace
id|sdalo
c_func
(paren
id|adap
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;test_bus:1 scl: %d  sda: %d &bslash;n&quot;
comma
id|getscl
c_func
(paren
id|adap
)paren
comma
id|getsda
c_func
(paren
id|adap
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_ne
id|getsda
c_func
(paren
id|adap
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;test_bus: %s SDA stuck high!&bslash;n&quot;
comma
id|name
)paren
suffix:semicolon
id|sdahi
c_func
(paren
id|adap
)paren
suffix:semicolon
r_goto
id|bailout
suffix:semicolon
)brace
r_if
c_cond
(paren
l_int|0
op_eq
id|getscl
c_func
(paren
id|adap
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;test_bus: %s SCL unexpected low while pulling SDA low!&bslash;n&quot;
comma
id|name
)paren
suffix:semicolon
r_goto
id|bailout
suffix:semicolon
)brace
id|sdahi
c_func
(paren
id|adap
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;test_bus:2 scl: %d  sda: %d &bslash;n&quot;
comma
id|getscl
c_func
(paren
id|adap
)paren
comma
id|getsda
c_func
(paren
id|adap
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_eq
id|getsda
c_func
(paren
id|adap
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;test_bus: %s SDA stuck low!&bslash;n&quot;
comma
id|name
)paren
suffix:semicolon
id|sdahi
c_func
(paren
id|adap
)paren
suffix:semicolon
r_goto
id|bailout
suffix:semicolon
)brace
r_if
c_cond
(paren
l_int|0
op_eq
id|getscl
c_func
(paren
id|adap
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;test_bus: %s SCL unexpected low while SDA high!&bslash;n&quot;
comma
id|adap-&gt;name
)paren
suffix:semicolon
r_goto
id|bailout
suffix:semicolon
)brace
id|scllo
c_func
(paren
id|adap
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;test_bus:3 scl: %d  sda: %d &bslash;n&quot;
comma
id|getscl
c_func
(paren
id|adap
)paren
comma
id|getsda
c_func
(paren
id|adap
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_ne
id|getscl
c_func
(paren
id|adap
)paren
)paren
(brace
id|sclhi
c_func
(paren
id|adap
)paren
suffix:semicolon
r_goto
id|bailout
suffix:semicolon
)brace
r_if
c_cond
(paren
l_int|0
op_eq
id|getsda
c_func
(paren
id|adap
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;test_bus: %s SDA unexpected low while pulling SCL low!&bslash;n&quot;
comma
id|name
)paren
suffix:semicolon
r_goto
id|bailout
suffix:semicolon
)brace
id|sclhi
c_func
(paren
id|adap
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;test_bus:4 scl: %d  sda: %d &bslash;n&quot;
comma
id|getscl
c_func
(paren
id|adap
)paren
comma
id|getsda
c_func
(paren
id|adap
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_eq
id|getscl
c_func
(paren
id|adap
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;test_bus: %s SCL stuck low!&bslash;n&quot;
comma
id|name
)paren
suffix:semicolon
id|sclhi
c_func
(paren
id|adap
)paren
suffix:semicolon
r_goto
id|bailout
suffix:semicolon
)brace
r_if
c_cond
(paren
l_int|0
op_eq
id|getsda
c_func
(paren
id|adap
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;test_bus: %s SDA unexpected low while SCL high!&bslash;n&quot;
comma
id|name
)paren
suffix:semicolon
r_goto
id|bailout
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;test_bus: %s passed test.&bslash;n&quot;
comma
id|name
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|bailout
suffix:colon
id|sdahi
c_func
(paren
id|adap
)paren
suffix:semicolon
id|sclhi
c_func
(paren
id|adap
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
macro_line|#endif
r_return
(paren
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* ----- Utility functions&n; */
multiline_comment|/* Verify the device we want to talk to on the IIC bus really exists. */
DECL|function|try_address
r_static
r_inline
r_int
id|try_address
c_func
(paren
r_struct
id|i2c_algo_iic_data
op_star
id|adap
comma
r_int
r_int
id|addr
comma
r_int
id|retries
)paren
(brace
r_int
id|i
comma
id|ret
op_assign
op_minus
l_int|1
suffix:semicolon
r_int
id|status
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|retries
suffix:semicolon
id|i
op_increment
)paren
(brace
id|iic_outw
c_func
(paren
id|adap
comma
id|ITE_I2CSAR
comma
id|addr
)paren
suffix:semicolon
id|iic_start
c_func
(paren
id|adap
)paren
suffix:semicolon
r_if
c_cond
(paren
id|wait_for_pin
c_func
(paren
id|adap
comma
op_amp
id|status
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
(paren
id|status
op_amp
id|ITE_I2CHSR_DNE
)paren
op_eq
l_int|0
)paren
(brace
id|iic_stop
c_func
(paren
id|adap
)paren
suffix:semicolon
id|iic_outw
c_func
(paren
id|adap
comma
id|ITE_I2CFCR
comma
id|ITE_I2CFCR_FLUSH
)paren
suffix:semicolon
id|ret
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* success! */
)brace
)brace
id|iic_stop
c_func
(paren
id|adap
)paren
suffix:semicolon
id|udelay
c_func
(paren
id|adap-&gt;udelay
)paren
suffix:semicolon
)brace
id|DEB2
c_func
(paren
r_if
(paren
id|i
)paren
id|printk
c_func
(paren
l_string|&quot;try_address: needed %d retries for 0x%x&bslash;n&quot;
comma
id|i
comma
id|addr
)paren
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|iic_sendbytes
r_static
r_int
id|iic_sendbytes
c_func
(paren
r_struct
id|i2c_adapter
op_star
id|i2c_adap
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_struct
id|i2c_algo_iic_data
op_star
id|adap
op_assign
id|i2c_adap-&gt;algo_data
suffix:semicolon
r_int
id|wrcount
op_assign
l_int|0
comma
id|timeout
suffix:semicolon
r_int
id|status
suffix:semicolon
r_int
id|loops
comma
id|remainder
comma
id|i
comma
id|j
suffix:semicolon
r_union
(brace
r_char
id|byte
(braket
l_int|2
)braket
suffix:semicolon
r_int
r_int
id|word
suffix:semicolon
)brace
id|tmp
suffix:semicolon
id|iic_outw
c_func
(paren
id|adap
comma
id|ITE_I2CSSAR
comma
(paren
r_int
r_int
)paren
id|buf
(braket
id|wrcount
op_increment
)braket
)paren
suffix:semicolon
id|count
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|count
op_eq
l_int|0
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|loops
op_assign
id|count
op_div
l_int|32
suffix:semicolon
multiline_comment|/* 32-byte FIFO */
id|remainder
op_assign
id|count
op_mod
l_int|32
suffix:semicolon
r_if
c_cond
(paren
id|loops
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|loops
suffix:semicolon
id|i
op_increment
)paren
(brace
id|iic_outw
c_func
(paren
id|adap
comma
id|ITE_I2CFBCR
comma
l_int|32
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|32
op_div
l_int|2
suffix:semicolon
id|j
op_increment
)paren
(brace
id|tmp.byte
(braket
l_int|1
)braket
op_assign
id|buf
(braket
id|wrcount
op_increment
)braket
suffix:semicolon
id|tmp.byte
(braket
l_int|0
)braket
op_assign
id|buf
(braket
id|wrcount
op_increment
)braket
suffix:semicolon
id|iic_outw
c_func
(paren
id|adap
comma
id|ITE_I2CFDR
comma
id|tmp.word
)paren
suffix:semicolon
)brace
multiline_comment|/* status FIFO overrun */
id|iic_inw
c_func
(paren
id|adap
comma
id|ITE_I2CFSR
)paren
suffix:semicolon
id|iic_inw
c_func
(paren
id|adap
comma
id|ITE_I2CFBCR
)paren
suffix:semicolon
id|iic_outw
c_func
(paren
id|adap
comma
id|ITE_I2CHCR
comma
id|ITE_WRITE
)paren
suffix:semicolon
multiline_comment|/* Issue WRITE command */
multiline_comment|/* Wait for transmission to complete */
id|timeout
op_assign
id|wait_for_pin
c_func
(paren
id|adap
comma
op_amp
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|timeout
)paren
(brace
id|iic_stop
c_func
(paren
id|adap
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;iic_sendbytes: %s write timeout.&bslash;n&quot;
comma
id|i2c_adap-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|EREMOTEIO
suffix:semicolon
multiline_comment|/* got a better one ?? */
)brace
r_if
c_cond
(paren
id|status
op_amp
id|ITE_I2CHSR_DB
)paren
(brace
id|iic_stop
c_func
(paren
id|adap
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;iic_sendbytes: %s write error - no ack.&bslash;n&quot;
comma
id|i2c_adap-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|EREMOTEIO
suffix:semicolon
multiline_comment|/* got a better one ?? */
)brace
)brace
)brace
r_if
c_cond
(paren
id|remainder
)paren
(brace
id|iic_outw
c_func
(paren
id|adap
comma
id|ITE_I2CFBCR
comma
id|remainder
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|remainder
op_div
l_int|2
suffix:semicolon
id|i
op_increment
)paren
(brace
id|tmp.byte
(braket
l_int|1
)braket
op_assign
id|buf
(braket
id|wrcount
op_increment
)braket
suffix:semicolon
id|tmp.byte
(braket
l_int|0
)braket
op_assign
id|buf
(braket
id|wrcount
op_increment
)braket
suffix:semicolon
id|iic_outw
c_func
(paren
id|adap
comma
id|ITE_I2CFDR
comma
id|tmp.word
)paren
suffix:semicolon
)brace
multiline_comment|/* status FIFO overrun */
id|iic_inw
c_func
(paren
id|adap
comma
id|ITE_I2CFSR
)paren
suffix:semicolon
id|iic_inw
c_func
(paren
id|adap
comma
id|ITE_I2CFBCR
)paren
suffix:semicolon
id|iic_outw
c_func
(paren
id|adap
comma
id|ITE_I2CHCR
comma
id|ITE_WRITE
)paren
suffix:semicolon
multiline_comment|/* Issue WRITE command */
id|timeout
op_assign
id|wait_for_pin
c_func
(paren
id|adap
comma
op_amp
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|timeout
)paren
(brace
id|iic_stop
c_func
(paren
id|adap
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;iic_sendbytes: %s write timeout.&bslash;n&quot;
comma
id|i2c_adap-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|EREMOTEIO
suffix:semicolon
multiline_comment|/* got a better one ?? */
)brace
macro_line|#ifndef STUB_I2C
r_if
c_cond
(paren
id|status
op_amp
id|ITE_I2CHSR_DB
)paren
(brace
id|iic_stop
c_func
(paren
id|adap
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;iic_sendbytes: %s write error - no ack.&bslash;n&quot;
comma
id|i2c_adap-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|EREMOTEIO
suffix:semicolon
multiline_comment|/* got a better one ?? */
)brace
macro_line|#endif
)brace
id|iic_stop
c_func
(paren
id|adap
)paren
suffix:semicolon
r_return
id|wrcount
suffix:semicolon
)brace
DECL|function|iic_readbytes
r_static
r_int
id|iic_readbytes
c_func
(paren
r_struct
id|i2c_adapter
op_star
id|i2c_adap
comma
r_char
op_star
id|buf
comma
r_int
id|count
comma
r_int
id|sread
)paren
(brace
r_int
id|rdcount
op_assign
l_int|0
comma
id|i
comma
id|timeout
suffix:semicolon
r_int
id|status
suffix:semicolon
r_struct
id|i2c_algo_iic_data
op_star
id|adap
op_assign
id|i2c_adap-&gt;algo_data
suffix:semicolon
r_int
id|loops
comma
id|remainder
comma
id|j
suffix:semicolon
r_union
(brace
r_char
id|byte
(braket
l_int|2
)braket
suffix:semicolon
r_int
r_int
id|word
suffix:semicolon
)brace
id|tmp
suffix:semicolon
id|loops
op_assign
id|count
op_div
l_int|32
suffix:semicolon
multiline_comment|/* 32-byte FIFO */
id|remainder
op_assign
id|count
op_mod
l_int|32
suffix:semicolon
r_if
c_cond
(paren
id|loops
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|loops
suffix:semicolon
id|i
op_increment
)paren
(brace
id|iic_outw
c_func
(paren
id|adap
comma
id|ITE_I2CFBCR
comma
l_int|32
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sread
)paren
id|iic_outw
c_func
(paren
id|adap
comma
id|ITE_I2CHCR
comma
id|ITE_SREAD
)paren
suffix:semicolon
r_else
id|iic_outw
c_func
(paren
id|adap
comma
id|ITE_I2CHCR
comma
id|ITE_READ
)paren
suffix:semicolon
multiline_comment|/* Issue READ command */
id|timeout
op_assign
id|wait_for_pin
c_func
(paren
id|adap
comma
op_amp
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|timeout
)paren
(brace
id|iic_stop
c_func
(paren
id|adap
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;iic_readbytes:  %s read timeout.&bslash;n&quot;
comma
id|i2c_adap-&gt;name
)paren
suffix:semicolon
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
macro_line|#ifndef STUB_I2C
r_if
c_cond
(paren
id|status
op_amp
id|ITE_I2CHSR_DB
)paren
(brace
id|iic_stop
c_func
(paren
id|adap
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;iic_readbytes: %s read error - no ack.&bslash;n&quot;
comma
id|i2c_adap-&gt;name
)paren
suffix:semicolon
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
macro_line|#endif
id|timeout
op_assign
id|wait_for_fe
c_func
(paren
id|adap
comma
op_amp
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|timeout
)paren
(brace
id|iic_stop
c_func
(paren
id|adap
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;iic_readbytes:  %s FIFO is empty&bslash;n&quot;
comma
id|i2c_adap-&gt;name
)paren
suffix:semicolon
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
l_int|32
op_div
l_int|2
suffix:semicolon
id|j
op_increment
)paren
(brace
id|tmp.word
op_assign
id|iic_inw
c_func
(paren
id|adap
comma
id|ITE_I2CFDR
)paren
suffix:semicolon
id|buf
(braket
id|rdcount
op_increment
)braket
op_assign
id|tmp.byte
(braket
l_int|1
)braket
suffix:semicolon
id|buf
(braket
id|rdcount
op_increment
)braket
op_assign
id|tmp.byte
(braket
l_int|0
)braket
suffix:semicolon
)brace
multiline_comment|/* status FIFO underrun */
id|iic_inw
c_func
(paren
id|adap
comma
id|ITE_I2CFSR
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|remainder
)paren
(brace
id|remainder
op_assign
(paren
id|remainder
op_plus
l_int|1
)paren
op_div
l_int|2
op_star
l_int|2
suffix:semicolon
id|iic_outw
c_func
(paren
id|adap
comma
id|ITE_I2CFBCR
comma
id|remainder
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sread
)paren
id|iic_outw
c_func
(paren
id|adap
comma
id|ITE_I2CHCR
comma
id|ITE_SREAD
)paren
suffix:semicolon
r_else
id|iic_outw
c_func
(paren
id|adap
comma
id|ITE_I2CHCR
comma
id|ITE_READ
)paren
suffix:semicolon
multiline_comment|/* Issue READ command */
id|timeout
op_assign
id|wait_for_pin
c_func
(paren
id|adap
comma
op_amp
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|timeout
)paren
(brace
id|iic_stop
c_func
(paren
id|adap
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;iic_readbytes:  %s read timeout.&bslash;n&quot;
comma
id|i2c_adap-&gt;name
)paren
suffix:semicolon
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
macro_line|#ifndef STUB_I2C
r_if
c_cond
(paren
id|status
op_amp
id|ITE_I2CHSR_DB
)paren
(brace
id|iic_stop
c_func
(paren
id|adap
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;iic_readbytes: %s read error - no ack.&bslash;n&quot;
comma
id|i2c_adap-&gt;name
)paren
suffix:semicolon
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
macro_line|#endif
id|timeout
op_assign
id|wait_for_fe
c_func
(paren
id|adap
comma
op_amp
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|timeout
)paren
(brace
id|iic_stop
c_func
(paren
id|adap
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;iic_readbytes:  %s FIFO is empty&bslash;n&quot;
comma
id|i2c_adap-&gt;name
)paren
suffix:semicolon
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|remainder
op_plus
l_int|1
)paren
op_div
l_int|2
suffix:semicolon
id|i
op_increment
)paren
(brace
id|tmp.word
op_assign
id|iic_inw
c_func
(paren
id|adap
comma
id|ITE_I2CFDR
)paren
suffix:semicolon
id|buf
(braket
id|rdcount
op_increment
)braket
op_assign
id|tmp.byte
(braket
l_int|1
)braket
suffix:semicolon
id|buf
(braket
id|rdcount
op_increment
)braket
op_assign
id|tmp.byte
(braket
l_int|0
)braket
suffix:semicolon
)brace
multiline_comment|/* status FIFO underrun */
id|iic_inw
c_func
(paren
id|adap
comma
id|ITE_I2CFSR
)paren
suffix:semicolon
)brace
id|iic_stop
c_func
(paren
id|adap
)paren
suffix:semicolon
r_return
id|rdcount
suffix:semicolon
)brace
multiline_comment|/* This function implements combined transactions.  Combined&n; * transactions consist of combinations of reading and writing blocks of data.&n; * Each transfer (i.e. a read or a write) is separated by a repeated start&n; * condition.&n; */
macro_line|#if 0
r_static
r_int
id|iic_combined_transaction
c_func
(paren
r_struct
id|i2c_adapter
op_star
id|i2c_adap
comma
r_struct
id|i2c_msg
id|msgs
(braket
)braket
comma
r_int
id|num
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|i2c_msg
op_star
id|pmsg
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|DEB2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Beginning combined transaction&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|num
op_minus
l_int|1
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|pmsg
op_assign
op_amp
id|msgs
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|pmsg-&gt;flags
op_amp
id|I2C_M_RD
)paren
(brace
id|DEB2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;  This one is a read&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|ret
op_assign
id|iic_readbytes
c_func
(paren
id|i2c_adap
comma
id|pmsg-&gt;buf
comma
id|pmsg-&gt;len
comma
id|IIC_COMBINED_XFER
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
id|pmsg-&gt;flags
op_amp
id|I2C_M_RD
)paren
)paren
(brace
id|DEB2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;This one is a write&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|ret
op_assign
id|iic_sendbytes
c_func
(paren
id|i2c_adap
comma
id|pmsg-&gt;buf
comma
id|pmsg-&gt;len
comma
id|IIC_COMBINED_XFER
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Last read or write segment needs to be terminated with a stop */
id|pmsg
op_assign
op_amp
id|msgs
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|pmsg-&gt;flags
op_amp
id|I2C_M_RD
)paren
(brace
id|DEB2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Doing the last read&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|ret
op_assign
id|iic_readbytes
c_func
(paren
id|i2c_adap
comma
id|pmsg-&gt;buf
comma
id|pmsg-&gt;len
comma
id|IIC_SINGLE_XFER
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
id|pmsg-&gt;flags
op_amp
id|I2C_M_RD
)paren
)paren
(brace
id|DEB2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Doing the last write&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|ret
op_assign
id|iic_sendbytes
c_func
(paren
id|i2c_adap
comma
id|pmsg-&gt;buf
comma
id|pmsg-&gt;len
comma
id|IIC_SINGLE_XFER
)paren
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* Whenever we initiate a transaction, the first byte clocked&n; * onto the bus after the start condition is the address (7 bit) of the&n; * device we want to talk to.  This function manipulates the address specified&n; * so that it makes sense to the hardware when written to the IIC peripheral.&n; *&n; * Note: 10 bit addresses are not supported in this driver, although they are&n; * supported by the hardware.  This functionality needs to be implemented.&n; */
DECL|function|iic_doAddress
r_static
r_inline
r_int
id|iic_doAddress
c_func
(paren
r_struct
id|i2c_algo_iic_data
op_star
id|adap
comma
r_struct
id|i2c_msg
op_star
id|msg
comma
r_int
id|retries
)paren
(brace
r_int
r_int
id|flags
op_assign
id|msg-&gt;flags
suffix:semicolon
r_int
r_int
id|addr
suffix:semicolon
r_int
id|ret
suffix:semicolon
multiline_comment|/* Ten bit addresses not supported right now */
r_if
c_cond
(paren
(paren
id|flags
op_amp
id|I2C_M_TEN
)paren
)paren
(brace
macro_line|#if 0
id|addr
op_assign
l_int|0xf0
op_or
(paren
(paren
id|msg-&gt;addr
op_rshift
l_int|7
)paren
op_amp
l_int|0x03
)paren
suffix:semicolon
id|DEB2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;addr0: %d&bslash;n&quot;
comma
id|addr
)paren
)paren
suffix:semicolon
id|ret
op_assign
id|try_address
c_func
(paren
id|adap
comma
id|addr
comma
id|retries
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ne
l_int|1
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;iic_doAddress: died at extended address code.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EREMOTEIO
suffix:semicolon
)brace
id|iic_outw
c_func
(paren
id|adap
comma
id|msg-&gt;addr
op_amp
l_int|0x7f
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ne
l_int|1
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;iic_doAddress: died at 2nd address code.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EREMOTEIO
suffix:semicolon
)brace
r_if
c_cond
(paren
id|flags
op_amp
id|I2C_M_RD
)paren
(brace
id|i2c_repstart
c_func
(paren
id|adap
)paren
suffix:semicolon
id|addr
op_or_assign
l_int|0x01
suffix:semicolon
id|ret
op_assign
id|try_address
c_func
(paren
id|adap
comma
id|addr
comma
id|retries
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ne
l_int|1
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;iic_doAddress: died at extended address code.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EREMOTEIO
suffix:semicolon
)brace
)brace
macro_line|#endif
)brace
r_else
(brace
id|addr
op_assign
(paren
id|msg-&gt;addr
op_lshift
l_int|1
)paren
suffix:semicolon
macro_line|#if 0
r_if
c_cond
(paren
id|flags
op_amp
id|I2C_M_RD
)paren
id|addr
op_or_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
id|I2C_M_REV_DIR_ADDR
)paren
id|addr
op_xor_assign
l_int|1
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|iic_inw
c_func
(paren
id|adap
comma
id|ITE_I2CSAR
)paren
op_ne
id|addr
)paren
(brace
id|iic_outw
c_func
(paren
id|adap
comma
id|ITE_I2CSAR
comma
id|addr
)paren
suffix:semicolon
id|ret
op_assign
id|try_address
c_func
(paren
id|adap
comma
id|addr
comma
id|retries
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ne
l_int|1
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;iic_doAddress: died at address code.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EREMOTEIO
suffix:semicolon
)brace
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Description: Prepares the controller for a transaction (clearing status&n; * registers, data buffers, etc), and then calls either iic_readbytes or&n; * iic_sendbytes to do the actual transaction.&n; *&n; * still to be done: Before we issue a transaction, we should&n; * verify that the bus is not busy or in some unknown state.&n; */
DECL|function|iic_xfer
r_static
r_int
id|iic_xfer
c_func
(paren
r_struct
id|i2c_adapter
op_star
id|i2c_adap
comma
r_struct
id|i2c_msg
id|msgs
(braket
)braket
comma
r_int
id|num
)paren
(brace
r_struct
id|i2c_algo_iic_data
op_star
id|adap
op_assign
id|i2c_adap-&gt;algo_data
suffix:semicolon
r_struct
id|i2c_msg
op_star
id|pmsg
suffix:semicolon
r_int
id|i
op_assign
l_int|0
suffix:semicolon
r_int
id|ret
comma
id|timeout
suffix:semicolon
id|pmsg
op_assign
op_amp
id|msgs
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pmsg-&gt;len
)paren
(brace
id|DEB2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;iic_xfer: read/write length is 0&bslash;n&quot;
)paren
suffix:semicolon
)paren
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|pmsg-&gt;flags
op_amp
id|I2C_M_RD
)paren
op_logical_and
(paren
op_logical_neg
(paren
id|pmsg-&gt;len
)paren
op_mod
l_int|2
)paren
)paren
(brace
id|DEB2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;iic_xfer: write buffer length is not odd&bslash;n&quot;
)paren
suffix:semicolon
)paren
r_return
op_minus
id|EIO
suffix:semicolon
)brace
multiline_comment|/* Wait for any pending transfers to complete */
id|timeout
op_assign
id|wait_for_bb
c_func
(paren
id|adap
)paren
suffix:semicolon
r_if
c_cond
(paren
id|timeout
)paren
(brace
id|DEB2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;iic_xfer: Timeout waiting for host not busy&bslash;n&quot;
)paren
suffix:semicolon
)paren
r_return
op_minus
id|EIO
suffix:semicolon
)brace
multiline_comment|/* Flush FIFO */
id|iic_outw
c_func
(paren
id|adap
comma
id|ITE_I2CFCR
comma
id|ITE_I2CFCR_FLUSH
)paren
suffix:semicolon
multiline_comment|/* Load address */
id|ret
op_assign
id|iic_doAddress
c_func
(paren
id|adap
comma
id|pmsg
comma
id|i2c_adap-&gt;retries
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_return
op_minus
id|EIO
suffix:semicolon
macro_line|#if 0
multiline_comment|/* Combined transaction (read and write) */
r_if
c_cond
(paren
id|num
OG
l_int|1
)paren
(brace
id|DEB2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;iic_xfer: Call combined transaction&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|ret
op_assign
id|iic_combined_transaction
c_func
(paren
id|i2c_adap
comma
id|msgs
comma
id|num
)paren
suffix:semicolon
)brace
macro_line|#endif
id|DEB3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;iic_xfer: Msg %d, addr=0x%x, flags=0x%x, len=%d&bslash;n&quot;
comma
id|i
comma
id|msgs
(braket
id|i
)braket
dot
id|addr
comma
id|msgs
(braket
id|i
)braket
dot
id|flags
comma
id|msgs
(braket
id|i
)braket
dot
id|len
)paren
suffix:semicolon
)paren
r_if
c_cond
(paren
id|pmsg-&gt;flags
op_amp
id|I2C_M_RD
)paren
(brace
multiline_comment|/* Read */
id|ret
op_assign
id|iic_readbytes
c_func
(paren
id|i2c_adap
comma
id|pmsg-&gt;buf
comma
id|pmsg-&gt;len
comma
l_int|0
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Write */
id|udelay
c_func
(paren
l_int|1000
)paren
suffix:semicolon
id|ret
op_assign
id|iic_sendbytes
c_func
(paren
id|i2c_adap
comma
id|pmsg-&gt;buf
comma
id|pmsg-&gt;len
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ret
op_ne
id|pmsg-&gt;len
)paren
id|DEB3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;iic_xfer: error or fail on read/write %d bytes.&bslash;n&quot;
comma
id|ret
)paren
)paren
suffix:semicolon
r_else
id|DEB3
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;iic_xfer: read/write %d bytes.&bslash;n&quot;
comma
id|ret
)paren
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* Implements device specific ioctls.  Higher level ioctls can&n; * be found in i2c-core.c and are typical of any i2c controller (specifying&n; * slave address, timeouts, etc).  These ioctls take advantage of any hardware&n; * features built into the controller for which this algorithm-adapter set&n; * was written.  These ioctls allow you to take control of the data and clock&n; * lines and set the either high or low,&n; * similar to a GPIO pin.&n; */
DECL|function|algo_control
r_static
r_int
id|algo_control
c_func
(paren
r_struct
id|i2c_adapter
op_star
id|adapter
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_struct
id|i2c_algo_iic_data
op_star
id|adap
op_assign
id|adapter-&gt;algo_data
suffix:semicolon
r_struct
id|i2c_iic_msg
id|s_msg
suffix:semicolon
r_char
op_star
id|buf
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_eq
id|I2C_SREAD
)paren
(brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|s_msg
comma
(paren
r_struct
id|i2c_iic_msg
op_star
)paren
id|arg
comma
r_sizeof
(paren
r_struct
id|i2c_iic_msg
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|buf
op_assign
id|kmalloc
c_func
(paren
id|s_msg.len
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buf
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
multiline_comment|/* Flush FIFO */
id|iic_outw
c_func
(paren
id|adap
comma
id|ITE_I2CFCR
comma
id|ITE_I2CFCR_FLUSH
)paren
suffix:semicolon
multiline_comment|/* Load address */
id|iic_outw
c_func
(paren
id|adap
comma
id|ITE_I2CSAR
comma
id|s_msg.addr
op_lshift
l_int|1
)paren
suffix:semicolon
id|iic_outw
c_func
(paren
id|adap
comma
id|ITE_I2CSSAR
comma
id|s_msg.waddr
op_amp
l_int|0xff
)paren
suffix:semicolon
id|ret
op_assign
id|iic_readbytes
c_func
(paren
id|adapter
comma
id|buf
comma
id|s_msg.len
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ge
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|s_msg.buf
comma
id|buf
comma
id|s_msg.len
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
)brace
)brace
id|kfree
c_func
(paren
id|buf
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|iic_func
r_static
id|u32
id|iic_func
c_func
(paren
r_struct
id|i2c_adapter
op_star
id|adap
)paren
(brace
r_return
id|I2C_FUNC_SMBUS_EMUL
op_or
id|I2C_FUNC_10BIT_ADDR
op_or
id|I2C_FUNC_PROTOCOL_MANGLING
suffix:semicolon
)brace
multiline_comment|/* -----exported algorithm data: -------------------------------------&t;*/
DECL|variable|iic_algo
r_static
r_struct
id|i2c_algorithm
id|iic_algo
op_assign
(brace
l_string|&quot;ITE IIC algorithm&quot;
comma
id|I2C_ALGO_IIC
comma
id|iic_xfer
comma
multiline_comment|/* master_xfer&t;*/
l_int|NULL
comma
multiline_comment|/* smbus_xfer&t;*/
l_int|NULL
comma
multiline_comment|/* slave_xmit&t;&t;*/
l_int|NULL
comma
multiline_comment|/* slave_recv&t;&t;*/
id|algo_control
comma
multiline_comment|/* ioctl&t;&t;*/
id|iic_func
comma
multiline_comment|/* functionality&t;*/
)brace
suffix:semicolon
multiline_comment|/* &n; * registering functions to load algorithms at runtime &n; */
DECL|function|i2c_iic_add_bus
r_int
id|i2c_iic_add_bus
c_func
(paren
r_struct
id|i2c_adapter
op_star
id|adap
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|status
suffix:semicolon
r_struct
id|i2c_algo_iic_data
op_star
id|iic_adap
op_assign
id|adap-&gt;algo_data
suffix:semicolon
r_if
c_cond
(paren
id|iic_test
)paren
(brace
r_int
id|ret
op_assign
id|test_bus
c_func
(paren
id|iic_adap
comma
id|adap-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|DEB2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;i2c-algo-ite: hw routines for %s registered.&bslash;n&quot;
comma
id|adap-&gt;name
)paren
)paren
suffix:semicolon
multiline_comment|/* register new adapter to i2c module... */
id|adap-&gt;id
op_or_assign
id|iic_algo.id
suffix:semicolon
id|adap-&gt;algo
op_assign
op_amp
id|iic_algo
suffix:semicolon
id|adap-&gt;timeout
op_assign
l_int|100
suffix:semicolon
multiline_comment|/* default values, should&t;*/
id|adap-&gt;retries
op_assign
l_int|3
suffix:semicolon
multiline_comment|/* be replaced by defines&t;*/
id|adap-&gt;flags
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef MODULE
id|MOD_INC_USE_COUNT
suffix:semicolon
macro_line|#endif
id|i2c_add_adapter
c_func
(paren
id|adap
)paren
suffix:semicolon
id|iic_init
c_func
(paren
id|iic_adap
)paren
suffix:semicolon
multiline_comment|/* scan bus */
multiline_comment|/* By default scanning the bus is turned off. */
r_if
c_cond
(paren
id|iic_scan
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot; i2c-algo-ite: scanning bus %s.&bslash;n&quot;
comma
id|adap-&gt;name
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0x00
suffix:semicolon
id|i
OL
l_int|0xff
suffix:semicolon
id|i
op_add_assign
l_int|2
)paren
(brace
id|iic_outw
c_func
(paren
id|iic_adap
comma
id|ITE_I2CSAR
comma
id|i
)paren
suffix:semicolon
id|iic_start
c_func
(paren
id|iic_adap
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|wait_for_pin
c_func
(paren
id|iic_adap
comma
op_amp
id|status
)paren
op_eq
l_int|0
)paren
op_logical_and
(paren
(paren
id|status
op_amp
id|ITE_I2CHSR_DNE
)paren
op_eq
l_int|0
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;&bslash;n(%02x)&bslash;n&quot;
comma
id|i
op_rshift
l_int|1
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;.&quot;
)paren
suffix:semicolon
id|iic_reset
c_func
(paren
id|iic_adap
)paren
suffix:semicolon
)brace
id|udelay
c_func
(paren
id|iic_adap-&gt;udelay
)paren
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|i2c_iic_del_bus
r_int
id|i2c_iic_del_bus
c_func
(paren
r_struct
id|i2c_adapter
op_star
id|adap
)paren
(brace
r_int
id|res
suffix:semicolon
r_if
c_cond
(paren
(paren
id|res
op_assign
id|i2c_del_adapter
c_func
(paren
id|adap
)paren
)paren
OL
l_int|0
)paren
r_return
id|res
suffix:semicolon
id|DEB2
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;i2c-algo-ite: adapter unregistered: %s&bslash;n&quot;
comma
id|adap-&gt;name
)paren
)paren
suffix:semicolon
macro_line|#ifdef MODULE
id|MOD_DEC_USE_COUNT
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|i2c_algo_iic_init
r_int
id|__init
id|i2c_algo_iic_init
(paren
r_void
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;ITE iic (i2c) algorithm module&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|i2c_algo_iic_exit
r_void
id|i2c_algo_iic_exit
c_func
(paren
r_void
)paren
(brace
r_return
suffix:semicolon
)brace
DECL|variable|i2c_iic_add_bus
id|EXPORT_SYMBOL
c_func
(paren
id|i2c_iic_add_bus
)paren
suffix:semicolon
DECL|variable|i2c_iic_del_bus
id|EXPORT_SYMBOL
c_func
(paren
id|i2c_iic_del_bus
)paren
suffix:semicolon
multiline_comment|/* The MODULE_* macros resolve to nothing if MODULES is not defined&n; * when this file is compiled.&n; */
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;MontaVista Software &lt;www.mvista.com&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;ITE iic algorithm&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|iic_test
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|iic_scan
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM
c_func
(paren
id|i2c_debug
comma
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|iic_test
comma
l_string|&quot;Test if the I2C bus is available&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|iic_scan
comma
l_string|&quot;Scan for active chips on the bus&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|i2c_debug
comma
l_string|&quot;debug level - 0 off; 1 normal; 2,3 more verbose; 9 iic-protocol&quot;
)paren
suffix:semicolon
multiline_comment|/* This function resolves to init_module (the function invoked when a module&n; * is loaded via insmod) when this file is compiled with MODULES defined.&n; * Otherwise (i.e. if you want this driver statically linked to the kernel),&n; * a pointer to this function is stored in a table and called&n; * during the intialization of the kernel (in do_basic_setup in /init/main.c) &n; *&n; * All this functionality is complements of the macros defined in linux/init.h&n; */
DECL|variable|i2c_algo_iic_init
id|module_init
c_func
(paren
id|i2c_algo_iic_init
)paren
suffix:semicolon
multiline_comment|/* If MODULES is defined when this file is compiled, then this function will&n; * resolved to cleanup_module.&n; */
DECL|variable|i2c_algo_iic_exit
id|module_exit
c_func
(paren
id|i2c_algo_iic_exit
)paren
suffix:semicolon
eof
