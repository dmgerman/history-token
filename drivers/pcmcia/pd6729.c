multiline_comment|/*&n; * Driver for the Cirrus PD6729 PCI-PCMCIA bridge.&n; *&n; * Based on the i82092.c driver.&n; *&n; * This software may be used and distributed according to the terms of&n; * the GNU General Public License, incorporated herein by reference.&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/workqueue.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/device.h&gt;
macro_line|#include &lt;pcmcia/cs_types.h&gt;
macro_line|#include &lt;pcmcia/ss.h&gt;
macro_line|#include &lt;pcmcia/cs.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &quot;pd6729.h&quot;
macro_line|#include &quot;i82365.h&quot;
macro_line|#include &quot;cirrus.h&quot;
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Driver for the Cirrus PD6729 PCI-PCMCIA bridge&quot;
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Jun Komuro &lt;komurojun-mbn@nifty.com&gt;&quot;
)paren
suffix:semicolon
DECL|macro|MAX_SOCKETS
mdefine_line|#define MAX_SOCKETS 2
multiline_comment|/*&n; * simple helper functions&n; * External clock time, in nanoseconds.  120 ns = 8.33 MHz&n; */
DECL|macro|to_cycles
mdefine_line|#define to_cycles(ns)&t;((ns)/120)
macro_line|#ifndef NO_IRQ
DECL|macro|NO_IRQ
mdefine_line|#define NO_IRQ&t;((unsigned int)(0))
macro_line|#endif
multiline_comment|/*&n; * PARAMETERS&n; *  irq_mode=n&n; *     Specifies the interrupt delivery mode.  The default (1) is to use PCI&n; *     interrupts; a value of 0 selects ISA interrupts. This must be set for&n; *     correct operation of PCI card readers.&n; *&n; *  irq_list=i,j,...&n; *     This list limits the set of interrupts that can be used by PCMCIA&n; *     cards.&n; *     The default list is 3,4,5,7,9,10,11.&n; *     (irq_list parameter is not used, if irq_mode = 1)&n; */
DECL|variable|irq_mode
r_static
r_int
id|irq_mode
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* 0 = ISA interrupt, 1 = PCI interrupt */
DECL|variable|irq_list
r_static
r_int
id|irq_list
(braket
l_int|16
)braket
suffix:semicolon
DECL|variable|irq_list_count
r_static
r_int
id|irq_list_count
op_assign
l_int|0
suffix:semicolon
id|module_param
c_func
(paren
id|irq_mode
comma
r_int
comma
l_int|0444
)paren
suffix:semicolon
id|module_param_array
c_func
(paren
id|irq_list
comma
r_int
comma
op_amp
id|irq_list_count
comma
l_int|0444
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|irq_mode
comma
l_string|&quot;interrupt delivery mode. 0 = ISA, 1 = PCI. default is 1&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|irq_list
comma
l_string|&quot;interrupts that can be used by PCMCIA cards&quot;
)paren
suffix:semicolon
DECL|variable|port_lock
r_static
id|spinlock_t
id|port_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
multiline_comment|/* basic value read/write functions */
DECL|function|indirect_read
r_static
r_int
r_char
id|indirect_read
c_func
(paren
r_struct
id|pd6729_socket
op_star
id|socket
comma
r_int
r_int
id|reg
)paren
(brace
r_int
r_int
id|port
suffix:semicolon
r_int
r_char
id|val
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|port_lock
comma
id|flags
)paren
suffix:semicolon
id|reg
op_add_assign
id|socket-&gt;number
op_star
l_int|0x40
suffix:semicolon
id|port
op_assign
id|socket-&gt;io_base
suffix:semicolon
id|outb
c_func
(paren
id|reg
comma
id|port
)paren
suffix:semicolon
id|val
op_assign
id|inb
c_func
(paren
id|port
op_plus
l_int|1
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|port_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|val
suffix:semicolon
)brace
DECL|function|indirect_read16
r_static
r_int
r_int
id|indirect_read16
c_func
(paren
r_struct
id|pd6729_socket
op_star
id|socket
comma
r_int
r_int
id|reg
)paren
(brace
r_int
r_int
id|port
suffix:semicolon
r_int
r_int
id|tmp
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|port_lock
comma
id|flags
)paren
suffix:semicolon
id|reg
op_assign
id|reg
op_plus
id|socket-&gt;number
op_star
l_int|0x40
suffix:semicolon
id|port
op_assign
id|socket-&gt;io_base
suffix:semicolon
id|outb
c_func
(paren
id|reg
comma
id|port
)paren
suffix:semicolon
id|tmp
op_assign
id|inb
c_func
(paren
id|port
op_plus
l_int|1
)paren
suffix:semicolon
id|reg
op_increment
suffix:semicolon
id|outb
c_func
(paren
id|reg
comma
id|port
)paren
suffix:semicolon
id|tmp
op_assign
id|tmp
op_or
(paren
id|inb
c_func
(paren
id|port
op_plus
l_int|1
)paren
op_lshift
l_int|8
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|port_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|tmp
suffix:semicolon
)brace
DECL|function|indirect_write
r_static
r_void
id|indirect_write
c_func
(paren
r_struct
id|pd6729_socket
op_star
id|socket
comma
r_int
r_int
id|reg
comma
r_int
r_char
id|value
)paren
(brace
r_int
r_int
id|port
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|port_lock
comma
id|flags
)paren
suffix:semicolon
id|reg
op_assign
id|reg
op_plus
id|socket-&gt;number
op_star
l_int|0x40
suffix:semicolon
id|port
op_assign
id|socket-&gt;io_base
suffix:semicolon
id|outb
c_func
(paren
id|reg
comma
id|port
)paren
suffix:semicolon
id|outb
c_func
(paren
id|value
comma
id|port
op_plus
l_int|1
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|port_lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|indirect_setbit
r_static
r_void
id|indirect_setbit
c_func
(paren
r_struct
id|pd6729_socket
op_star
id|socket
comma
r_int
r_int
id|reg
comma
r_int
r_char
id|mask
)paren
(brace
r_int
r_int
id|port
suffix:semicolon
r_int
r_char
id|val
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|port_lock
comma
id|flags
)paren
suffix:semicolon
id|reg
op_assign
id|reg
op_plus
id|socket-&gt;number
op_star
l_int|0x40
suffix:semicolon
id|port
op_assign
id|socket-&gt;io_base
suffix:semicolon
id|outb
c_func
(paren
id|reg
comma
id|port
)paren
suffix:semicolon
id|val
op_assign
id|inb
c_func
(paren
id|port
op_plus
l_int|1
)paren
suffix:semicolon
id|val
op_or_assign
id|mask
suffix:semicolon
id|outb
c_func
(paren
id|reg
comma
id|port
)paren
suffix:semicolon
id|outb
c_func
(paren
id|val
comma
id|port
op_plus
l_int|1
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|port_lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|indirect_resetbit
r_static
r_void
id|indirect_resetbit
c_func
(paren
r_struct
id|pd6729_socket
op_star
id|socket
comma
r_int
r_int
id|reg
comma
r_int
r_char
id|mask
)paren
(brace
r_int
r_int
id|port
suffix:semicolon
r_int
r_char
id|val
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|port_lock
comma
id|flags
)paren
suffix:semicolon
id|reg
op_assign
id|reg
op_plus
id|socket-&gt;number
op_star
l_int|0x40
suffix:semicolon
id|port
op_assign
id|socket-&gt;io_base
suffix:semicolon
id|outb
c_func
(paren
id|reg
comma
id|port
)paren
suffix:semicolon
id|val
op_assign
id|inb
c_func
(paren
id|port
op_plus
l_int|1
)paren
suffix:semicolon
id|val
op_and_assign
op_complement
id|mask
suffix:semicolon
id|outb
c_func
(paren
id|reg
comma
id|port
)paren
suffix:semicolon
id|outb
c_func
(paren
id|val
comma
id|port
op_plus
l_int|1
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|port_lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|indirect_write16
r_static
r_void
id|indirect_write16
c_func
(paren
r_struct
id|pd6729_socket
op_star
id|socket
comma
r_int
r_int
id|reg
comma
r_int
r_int
id|value
)paren
(brace
r_int
r_int
id|port
suffix:semicolon
r_int
r_char
id|val
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|port_lock
comma
id|flags
)paren
suffix:semicolon
id|reg
op_assign
id|reg
op_plus
id|socket-&gt;number
op_star
l_int|0x40
suffix:semicolon
id|port
op_assign
id|socket-&gt;io_base
suffix:semicolon
id|outb
c_func
(paren
id|reg
comma
id|port
)paren
suffix:semicolon
id|val
op_assign
id|value
op_amp
l_int|255
suffix:semicolon
id|outb
c_func
(paren
id|val
comma
id|port
op_plus
l_int|1
)paren
suffix:semicolon
id|reg
op_increment
suffix:semicolon
id|outb
c_func
(paren
id|reg
comma
id|port
)paren
suffix:semicolon
id|val
op_assign
id|value
op_rshift
l_int|8
suffix:semicolon
id|outb
c_func
(paren
id|val
comma
id|port
op_plus
l_int|1
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|port_lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* Interrupt handler functionality */
DECL|function|pd6729_interrupt
r_static
id|irqreturn_t
id|pd6729_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|pd6729_socket
op_star
id|socket
op_assign
(paren
r_struct
id|pd6729_socket
op_star
)paren
id|dev
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|loopcount
op_assign
l_int|0
suffix:semicolon
r_int
id|handled
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|events
comma
id|active
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|loopcount
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|loopcount
OG
l_int|20
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;pd6729: infinite eventloop &quot;
l_string|&quot;in interrupt&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|active
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_SOCKETS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
r_int
id|csc
suffix:semicolon
multiline_comment|/* card status change register */
id|csc
op_assign
id|indirect_read
c_func
(paren
op_amp
id|socket
(braket
id|i
)braket
comma
id|I365_CSC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|csc
op_eq
l_int|0
)paren
multiline_comment|/* no events on this socket */
r_continue
suffix:semicolon
id|handled
op_assign
l_int|1
suffix:semicolon
id|events
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|csc
op_amp
id|I365_CSC_DETECT
)paren
(brace
id|events
op_or_assign
id|SS_DETECT
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;Card detected in socket %i!&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|indirect_read
c_func
(paren
op_amp
id|socket
(braket
id|i
)braket
comma
id|I365_INTCTL
)paren
op_amp
id|I365_PC_IOCARD
)paren
(brace
multiline_comment|/* For IO/CARDS, bit 0 means &quot;read the card&quot; */
id|events
op_or_assign
(paren
id|csc
op_amp
id|I365_CSC_STSCHG
)paren
ques
c_cond
id|SS_STSCHG
suffix:colon
l_int|0
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Check for battery/ready events */
id|events
op_or_assign
(paren
id|csc
op_amp
id|I365_CSC_BVD1
)paren
ques
c_cond
id|SS_BATDEAD
suffix:colon
l_int|0
suffix:semicolon
id|events
op_or_assign
(paren
id|csc
op_amp
id|I365_CSC_BVD2
)paren
ques
c_cond
id|SS_BATWARN
suffix:colon
l_int|0
suffix:semicolon
id|events
op_or_assign
(paren
id|csc
op_amp
id|I365_CSC_READY
)paren
ques
c_cond
id|SS_READY
suffix:colon
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|events
)paren
(brace
id|pcmcia_parse_events
c_func
(paren
op_amp
id|socket
(braket
id|i
)braket
dot
id|socket
comma
id|events
)paren
suffix:semicolon
)brace
id|active
op_or_assign
id|events
suffix:semicolon
)brace
r_if
c_cond
(paren
id|active
op_eq
l_int|0
)paren
multiline_comment|/* no more events to handle */
r_break
suffix:semicolon
)brace
r_return
id|IRQ_RETVAL
c_func
(paren
id|handled
)paren
suffix:semicolon
)brace
multiline_comment|/* socket functions */
DECL|function|pd6729_interrupt_wrapper
r_static
r_void
id|pd6729_interrupt_wrapper
c_func
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|pd6729_socket
op_star
id|socket
op_assign
(paren
r_struct
id|pd6729_socket
op_star
)paren
id|data
suffix:semicolon
id|pd6729_interrupt
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
id|socket
comma
l_int|NULL
)paren
suffix:semicolon
id|mod_timer
c_func
(paren
op_amp
id|socket-&gt;poll_timer
comma
id|jiffies
op_plus
id|HZ
)paren
suffix:semicolon
)brace
DECL|function|pd6729_get_status
r_static
r_int
id|pd6729_get_status
c_func
(paren
r_struct
id|pcmcia_socket
op_star
id|sock
comma
id|u_int
op_star
id|value
)paren
(brace
r_struct
id|pd6729_socket
op_star
id|socket
op_assign
id|container_of
c_func
(paren
id|sock
comma
r_struct
id|pd6729_socket
comma
id|socket
)paren
suffix:semicolon
r_int
r_int
id|status
suffix:semicolon
r_int
r_int
id|data
suffix:semicolon
r_struct
id|pd6729_socket
op_star
id|t
suffix:semicolon
multiline_comment|/* Interface Status Register */
id|status
op_assign
id|indirect_read
c_func
(paren
id|socket
comma
id|I365_STATUS
)paren
suffix:semicolon
op_star
id|value
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_amp
id|I365_CS_DETECT
)paren
op_eq
id|I365_CS_DETECT
)paren
(brace
op_star
id|value
op_or_assign
id|SS_DETECT
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * IO cards have a different meaning of bits 0,1&n;&t; * Also notice the inverse-logic on the bits&n;&t; */
r_if
c_cond
(paren
id|indirect_read
c_func
(paren
id|socket
comma
id|I365_INTCTL
)paren
op_amp
id|I365_PC_IOCARD
)paren
(brace
multiline_comment|/* IO card */
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_amp
id|I365_CS_STSCHG
)paren
)paren
op_star
id|value
op_or_assign
id|SS_STSCHG
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* non I/O card */
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_amp
id|I365_CS_BVD1
)paren
)paren
op_star
id|value
op_or_assign
id|SS_BATDEAD
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_amp
id|I365_CS_BVD2
)paren
)paren
op_star
id|value
op_or_assign
id|SS_BATWARN
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|I365_CS_WRPROT
)paren
op_star
id|value
op_or_assign
id|SS_WRPROT
suffix:semicolon
multiline_comment|/* card is write protected */
r_if
c_cond
(paren
id|status
op_amp
id|I365_CS_READY
)paren
op_star
id|value
op_or_assign
id|SS_READY
suffix:semicolon
multiline_comment|/* card is not busy */
r_if
c_cond
(paren
id|status
op_amp
id|I365_CS_POWERON
)paren
op_star
id|value
op_or_assign
id|SS_POWERON
suffix:semicolon
multiline_comment|/* power is applied to the card */
id|t
op_assign
(paren
id|socket-&gt;number
)paren
ques
c_cond
id|socket
suffix:colon
id|socket
op_plus
l_int|1
suffix:semicolon
id|indirect_write
c_func
(paren
id|t
comma
id|PD67_EXT_INDEX
comma
id|PD67_EXTERN_DATA
)paren
suffix:semicolon
id|data
op_assign
id|indirect_read16
c_func
(paren
id|t
comma
id|PD67_EXT_DATA
)paren
suffix:semicolon
op_star
id|value
op_or_assign
(paren
id|data
op_amp
id|PD67_EXD_VS1
c_func
(paren
id|socket-&gt;number
)paren
)paren
ques
c_cond
l_int|0
suffix:colon
id|SS_3VCARD
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pd6729_get_socket
r_static
r_int
id|pd6729_get_socket
c_func
(paren
r_struct
id|pcmcia_socket
op_star
id|sock
comma
id|socket_state_t
op_star
id|state
)paren
(brace
r_struct
id|pd6729_socket
op_star
id|socket
op_assign
id|container_of
c_func
(paren
id|sock
comma
r_struct
id|pd6729_socket
comma
id|socket
)paren
suffix:semicolon
r_int
r_char
id|reg
comma
id|vcc
comma
id|vpp
suffix:semicolon
id|state-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|state-&gt;Vcc
op_assign
l_int|0
suffix:semicolon
id|state-&gt;Vpp
op_assign
l_int|0
suffix:semicolon
id|state-&gt;io_irq
op_assign
l_int|0
suffix:semicolon
id|state-&gt;csc_mask
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* First the power status of the socket */
id|reg
op_assign
id|indirect_read
c_func
(paren
id|socket
comma
id|I365_POWER
)paren
suffix:semicolon
r_if
c_cond
(paren
id|reg
op_amp
id|I365_PWR_AUTO
)paren
id|state-&gt;flags
op_or_assign
id|SS_PWR_AUTO
suffix:semicolon
multiline_comment|/* Automatic Power Switch */
r_if
c_cond
(paren
id|reg
op_amp
id|I365_PWR_OUT
)paren
id|state-&gt;flags
op_or_assign
id|SS_OUTPUT_ENA
suffix:semicolon
multiline_comment|/* Output signals are enabled */
id|vcc
op_assign
id|reg
op_amp
id|I365_VCC_MASK
suffix:semicolon
id|vpp
op_assign
id|reg
op_amp
id|I365_VPP1_MASK
suffix:semicolon
r_if
c_cond
(paren
id|reg
op_amp
id|I365_VCC_5V
)paren
(brace
id|state-&gt;Vcc
op_assign
(paren
id|indirect_read
c_func
(paren
id|socket
comma
id|PD67_MISC_CTL_1
)paren
op_amp
id|PD67_MC1_VCC_3V
)paren
ques
c_cond
l_int|33
suffix:colon
l_int|50
suffix:semicolon
r_if
c_cond
(paren
id|vpp
op_eq
id|I365_VPP1_5V
)paren
(brace
r_if
c_cond
(paren
id|state-&gt;Vcc
op_eq
l_int|50
)paren
id|state-&gt;Vpp
op_assign
l_int|50
suffix:semicolon
r_else
id|state-&gt;Vpp
op_assign
l_int|33
suffix:semicolon
)brace
r_if
c_cond
(paren
id|vpp
op_eq
id|I365_VPP1_12V
)paren
id|state-&gt;Vpp
op_assign
l_int|120
suffix:semicolon
)brace
multiline_comment|/* Now the IO card, RESET flags and IO interrupt */
id|reg
op_assign
id|indirect_read
c_func
(paren
id|socket
comma
id|I365_INTCTL
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|reg
op_amp
id|I365_PC_RESET
)paren
op_eq
l_int|0
)paren
id|state-&gt;flags
op_or_assign
id|SS_RESET
suffix:semicolon
r_if
c_cond
(paren
id|reg
op_amp
id|I365_PC_IOCARD
)paren
id|state-&gt;flags
op_or_assign
id|SS_IOCARD
suffix:semicolon
multiline_comment|/* This is an IO card */
multiline_comment|/* Set the IRQ number */
id|state-&gt;io_irq
op_assign
id|socket-&gt;card_irq
suffix:semicolon
multiline_comment|/* Card status change */
id|reg
op_assign
id|indirect_read
c_func
(paren
id|socket
comma
id|I365_CSCINT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|reg
op_amp
id|I365_CSC_DETECT
)paren
id|state-&gt;csc_mask
op_or_assign
id|SS_DETECT
suffix:semicolon
multiline_comment|/* Card detect is enabled */
r_if
c_cond
(paren
id|state-&gt;flags
op_amp
id|SS_IOCARD
)paren
(brace
multiline_comment|/* IO Cards behave different */
r_if
c_cond
(paren
id|reg
op_amp
id|I365_CSC_STSCHG
)paren
id|state-&gt;csc_mask
op_or_assign
id|SS_STSCHG
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|reg
op_amp
id|I365_CSC_BVD1
)paren
id|state-&gt;csc_mask
op_or_assign
id|SS_BATDEAD
suffix:semicolon
r_if
c_cond
(paren
id|reg
op_amp
id|I365_CSC_BVD2
)paren
id|state-&gt;csc_mask
op_or_assign
id|SS_BATWARN
suffix:semicolon
r_if
c_cond
(paren
id|reg
op_amp
id|I365_CSC_READY
)paren
id|state-&gt;csc_mask
op_or_assign
id|SS_READY
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pd6729_set_socket
r_static
r_int
id|pd6729_set_socket
c_func
(paren
r_struct
id|pcmcia_socket
op_star
id|sock
comma
id|socket_state_t
op_star
id|state
)paren
(brace
r_struct
id|pd6729_socket
op_star
id|socket
op_assign
id|container_of
c_func
(paren
id|sock
comma
r_struct
id|pd6729_socket
comma
id|socket
)paren
suffix:semicolon
r_int
r_char
id|reg
comma
id|data
suffix:semicolon
multiline_comment|/* First, set the global controller options */
id|indirect_write
c_func
(paren
id|socket
comma
id|I365_GBLCTL
comma
l_int|0x00
)paren
suffix:semicolon
id|indirect_write
c_func
(paren
id|socket
comma
id|I365_GENCTL
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* Values for the IGENC register */
id|socket-&gt;card_irq
op_assign
id|state-&gt;io_irq
suffix:semicolon
id|reg
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* The reset bit has &quot;inverse&quot; logic */
r_if
c_cond
(paren
op_logical_neg
(paren
id|state-&gt;flags
op_amp
id|SS_RESET
)paren
)paren
id|reg
op_or_assign
id|I365_PC_RESET
suffix:semicolon
r_if
c_cond
(paren
id|state-&gt;flags
op_amp
id|SS_IOCARD
)paren
id|reg
op_or_assign
id|I365_PC_IOCARD
suffix:semicolon
multiline_comment|/* IGENC, Interrupt and General Control Register */
id|indirect_write
c_func
(paren
id|socket
comma
id|I365_INTCTL
comma
id|reg
)paren
suffix:semicolon
multiline_comment|/* Power registers */
id|reg
op_assign
id|I365_PWR_NORESET
suffix:semicolon
multiline_comment|/* default: disable resetdrv on resume */
r_if
c_cond
(paren
id|state-&gt;flags
op_amp
id|SS_PWR_AUTO
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;Auto power&bslash;n&quot;
)paren
suffix:semicolon
id|reg
op_or_assign
id|I365_PWR_AUTO
suffix:semicolon
multiline_comment|/* automatic power mngmnt */
)brace
r_if
c_cond
(paren
id|state-&gt;flags
op_amp
id|SS_OUTPUT_ENA
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;Power Enabled&bslash;n&quot;
)paren
suffix:semicolon
id|reg
op_or_assign
id|I365_PWR_OUT
suffix:semicolon
multiline_comment|/* enable power */
)brace
r_switch
c_cond
(paren
id|state-&gt;Vcc
)paren
(brace
r_case
l_int|0
suffix:colon
r_break
suffix:semicolon
r_case
l_int|33
suffix:colon
id|dprintk
c_func
(paren
l_string|&quot;setting voltage to Vcc to 3.3V on socket %i&bslash;n&quot;
comma
id|socket-&gt;number
)paren
suffix:semicolon
id|reg
op_or_assign
id|I365_VCC_5V
suffix:semicolon
id|indirect_setbit
c_func
(paren
id|socket
comma
id|PD67_MISC_CTL_1
comma
id|PD67_MC1_VCC_3V
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|50
suffix:colon
id|dprintk
c_func
(paren
l_string|&quot;setting voltage to Vcc to 5V on socket %i&bslash;n&quot;
comma
id|socket-&gt;number
)paren
suffix:semicolon
id|reg
op_or_assign
id|I365_VCC_5V
suffix:semicolon
id|indirect_resetbit
c_func
(paren
id|socket
comma
id|PD67_MISC_CTL_1
comma
id|PD67_MC1_VCC_3V
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|dprintk
c_func
(paren
l_string|&quot;pd6729: pd6729_set_socket called with &quot;
l_string|&quot;invalid VCC power value: %i&bslash;n&quot;
comma
id|state-&gt;Vcc
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|state-&gt;Vpp
)paren
(brace
r_case
l_int|0
suffix:colon
id|dprintk
c_func
(paren
l_string|&quot;not setting Vpp on socket %i&bslash;n&quot;
comma
id|socket-&gt;number
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|33
suffix:colon
r_case
l_int|50
suffix:colon
id|dprintk
c_func
(paren
l_string|&quot;setting Vpp to Vcc for socket %i&bslash;n&quot;
comma
id|socket-&gt;number
)paren
suffix:semicolon
id|reg
op_or_assign
id|I365_VPP1_5V
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|120
suffix:colon
id|dprintk
c_func
(paren
l_string|&quot;setting Vpp to 12.0&bslash;n&quot;
)paren
suffix:semicolon
id|reg
op_or_assign
id|I365_VPP1_12V
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|dprintk
c_func
(paren
l_string|&quot;pd6729: pd6729_set_socket called with invalid VPP power value: %i&bslash;n&quot;
comma
id|state-&gt;Vpp
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* only write if changed */
r_if
c_cond
(paren
id|reg
op_ne
id|indirect_read
c_func
(paren
id|socket
comma
id|I365_POWER
)paren
)paren
id|indirect_write
c_func
(paren
id|socket
comma
id|I365_POWER
comma
id|reg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|irq_mode
op_eq
l_int|1
)paren
(brace
multiline_comment|/* all interrupts are to be done as PCI interrupts */
id|data
op_assign
id|PD67_EC1_INV_MGMT_IRQ
op_or
id|PD67_EC1_INV_CARD_IRQ
suffix:semicolon
)brace
r_else
id|data
op_assign
l_int|0
suffix:semicolon
id|indirect_write
c_func
(paren
id|socket
comma
id|PD67_EXT_INDEX
comma
id|PD67_EXT_CTL_1
)paren
suffix:semicolon
id|indirect_write
c_func
(paren
id|socket
comma
id|PD67_EXT_DATA
comma
id|data
)paren
suffix:semicolon
multiline_comment|/* Enable specific interrupt events */
id|reg
op_assign
l_int|0x00
suffix:semicolon
r_if
c_cond
(paren
id|state-&gt;csc_mask
op_amp
id|SS_DETECT
)paren
(brace
id|reg
op_or_assign
id|I365_CSC_DETECT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|state-&gt;flags
op_amp
id|SS_IOCARD
)paren
(brace
r_if
c_cond
(paren
id|state-&gt;csc_mask
op_amp
id|SS_STSCHG
)paren
id|reg
op_or_assign
id|I365_CSC_STSCHG
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|state-&gt;csc_mask
op_amp
id|SS_BATDEAD
)paren
id|reg
op_or_assign
id|I365_CSC_BVD1
suffix:semicolon
r_if
c_cond
(paren
id|state-&gt;csc_mask
op_amp
id|SS_BATWARN
)paren
id|reg
op_or_assign
id|I365_CSC_BVD2
suffix:semicolon
r_if
c_cond
(paren
id|state-&gt;csc_mask
op_amp
id|SS_READY
)paren
id|reg
op_or_assign
id|I365_CSC_READY
suffix:semicolon
)brace
r_if
c_cond
(paren
id|irq_mode
op_eq
l_int|1
)paren
id|reg
op_or_assign
l_int|0x30
suffix:semicolon
multiline_comment|/* management IRQ: PCI INTA# = &quot;irq 3&quot; */
id|indirect_write
c_func
(paren
id|socket
comma
id|I365_CSCINT
comma
id|reg
)paren
suffix:semicolon
id|reg
op_assign
id|indirect_read
c_func
(paren
id|socket
comma
id|I365_INTCTL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|irq_mode
op_eq
l_int|1
)paren
id|reg
op_or_assign
l_int|0x03
suffix:semicolon
multiline_comment|/* card IRQ: PCI INTA# = &quot;irq 3&quot; */
r_else
id|reg
op_or_assign
id|socket-&gt;card_irq
suffix:semicolon
id|indirect_write
c_func
(paren
id|socket
comma
id|I365_INTCTL
comma
id|reg
)paren
suffix:semicolon
multiline_comment|/* now clear the (probably bogus) pending stuff by doing a dummy read */
(paren
r_void
)paren
id|indirect_read
c_func
(paren
id|socket
comma
id|I365_CSC
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pd6729_set_io_map
r_static
r_int
id|pd6729_set_io_map
c_func
(paren
r_struct
id|pcmcia_socket
op_star
id|sock
comma
r_struct
id|pccard_io_map
op_star
id|io
)paren
(brace
r_struct
id|pd6729_socket
op_star
id|socket
op_assign
id|container_of
c_func
(paren
id|sock
comma
r_struct
id|pd6729_socket
comma
id|socket
)paren
suffix:semicolon
r_int
r_char
id|map
comma
id|ioctl
suffix:semicolon
id|map
op_assign
id|io-&gt;map
suffix:semicolon
multiline_comment|/* Check error conditions */
r_if
c_cond
(paren
id|map
OG
l_int|1
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;pd6729_set_io_map with invalid map&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* Turn off the window before changing anything */
r_if
c_cond
(paren
id|indirect_read
c_func
(paren
id|socket
comma
id|I365_ADDRWIN
)paren
op_amp
id|I365_ENA_IO
c_func
(paren
id|map
)paren
)paren
id|indirect_resetbit
c_func
(paren
id|socket
comma
id|I365_ADDRWIN
comma
id|I365_ENA_IO
c_func
(paren
id|map
)paren
)paren
suffix:semicolon
multiline_comment|/* dprintk(&quot;set_io_map: Setting range to %x - %x&bslash;n&quot;,&n;&t;   io-&gt;start, io-&gt;stop);*/
multiline_comment|/* write the new values */
id|indirect_write16
c_func
(paren
id|socket
comma
id|I365_IO
c_func
(paren
id|map
)paren
op_plus
id|I365_W_START
comma
id|io-&gt;start
)paren
suffix:semicolon
id|indirect_write16
c_func
(paren
id|socket
comma
id|I365_IO
c_func
(paren
id|map
)paren
op_plus
id|I365_W_STOP
comma
id|io-&gt;stop
)paren
suffix:semicolon
id|ioctl
op_assign
id|indirect_read
c_func
(paren
id|socket
comma
id|I365_IOCTL
)paren
op_amp
op_complement
id|I365_IOCTL_MASK
c_func
(paren
id|map
)paren
suffix:semicolon
r_if
c_cond
(paren
id|io-&gt;flags
op_amp
id|MAP_0WS
)paren
id|ioctl
op_or_assign
id|I365_IOCTL_0WS
c_func
(paren
id|map
)paren
suffix:semicolon
r_if
c_cond
(paren
id|io-&gt;flags
op_amp
id|MAP_16BIT
)paren
id|ioctl
op_or_assign
id|I365_IOCTL_16BIT
c_func
(paren
id|map
)paren
suffix:semicolon
r_if
c_cond
(paren
id|io-&gt;flags
op_amp
id|MAP_AUTOSZ
)paren
id|ioctl
op_or_assign
id|I365_IOCTL_IOCS16
c_func
(paren
id|map
)paren
suffix:semicolon
id|indirect_write
c_func
(paren
id|socket
comma
id|I365_IOCTL
comma
id|ioctl
)paren
suffix:semicolon
multiline_comment|/* Turn the window back on if needed */
r_if
c_cond
(paren
id|io-&gt;flags
op_amp
id|MAP_ACTIVE
)paren
id|indirect_setbit
c_func
(paren
id|socket
comma
id|I365_ADDRWIN
comma
id|I365_ENA_IO
c_func
(paren
id|map
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pd6729_set_mem_map
r_static
r_int
id|pd6729_set_mem_map
c_func
(paren
r_struct
id|pcmcia_socket
op_star
id|sock
comma
r_struct
id|pccard_mem_map
op_star
id|mem
)paren
(brace
r_struct
id|pd6729_socket
op_star
id|socket
op_assign
id|container_of
c_func
(paren
id|sock
comma
r_struct
id|pd6729_socket
comma
id|socket
)paren
suffix:semicolon
r_int
r_int
id|base
comma
id|i
suffix:semicolon
r_int
r_char
id|map
suffix:semicolon
id|map
op_assign
id|mem-&gt;map
suffix:semicolon
r_if
c_cond
(paren
id|map
OG
l_int|4
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;pd6729_set_mem_map: invalid map&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|mem-&gt;res-&gt;start
OG
id|mem-&gt;res-&gt;end
)paren
op_logical_or
(paren
id|mem-&gt;speed
OG
l_int|1000
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;pd6729_set_mem_map: invalid address / speed&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* Turn off the window before changing anything */
r_if
c_cond
(paren
id|indirect_read
c_func
(paren
id|socket
comma
id|I365_ADDRWIN
)paren
op_amp
id|I365_ENA_MEM
c_func
(paren
id|map
)paren
)paren
id|indirect_resetbit
c_func
(paren
id|socket
comma
id|I365_ADDRWIN
comma
id|I365_ENA_MEM
c_func
(paren
id|map
)paren
)paren
suffix:semicolon
multiline_comment|/* write the start address */
id|base
op_assign
id|I365_MEM
c_func
(paren
id|map
)paren
suffix:semicolon
id|i
op_assign
(paren
id|mem-&gt;res-&gt;start
op_rshift
l_int|12
)paren
op_amp
l_int|0x0fff
suffix:semicolon
r_if
c_cond
(paren
id|mem-&gt;flags
op_amp
id|MAP_16BIT
)paren
id|i
op_or_assign
id|I365_MEM_16BIT
suffix:semicolon
r_if
c_cond
(paren
id|mem-&gt;flags
op_amp
id|MAP_0WS
)paren
id|i
op_or_assign
id|I365_MEM_0WS
suffix:semicolon
id|indirect_write16
c_func
(paren
id|socket
comma
id|base
op_plus
id|I365_W_START
comma
id|i
)paren
suffix:semicolon
multiline_comment|/* write the stop address */
id|i
op_assign
(paren
id|mem-&gt;res-&gt;end
op_rshift
l_int|12
)paren
op_amp
l_int|0x0fff
suffix:semicolon
r_switch
c_cond
(paren
id|to_cycles
c_func
(paren
id|mem-&gt;speed
)paren
)paren
(brace
r_case
l_int|0
suffix:colon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|i
op_or_assign
id|I365_MEM_WS0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|i
op_or_assign
id|I365_MEM_WS1
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|i
op_or_assign
id|I365_MEM_WS1
op_or
id|I365_MEM_WS0
suffix:semicolon
r_break
suffix:semicolon
)brace
id|indirect_write16
c_func
(paren
id|socket
comma
id|base
op_plus
id|I365_W_STOP
comma
id|i
)paren
suffix:semicolon
multiline_comment|/* Take care of high byte */
id|indirect_write
c_func
(paren
id|socket
comma
id|PD67_EXT_INDEX
comma
id|PD67_MEM_PAGE
c_func
(paren
id|map
)paren
)paren
suffix:semicolon
id|indirect_write
c_func
(paren
id|socket
comma
id|PD67_EXT_DATA
comma
id|mem-&gt;res-&gt;start
op_rshift
l_int|24
)paren
suffix:semicolon
multiline_comment|/* card start */
id|i
op_assign
(paren
(paren
id|mem-&gt;card_start
op_minus
id|mem-&gt;res-&gt;start
)paren
op_rshift
l_int|12
)paren
op_amp
l_int|0x3fff
suffix:semicolon
r_if
c_cond
(paren
id|mem-&gt;flags
op_amp
id|MAP_WRPROT
)paren
id|i
op_or_assign
id|I365_MEM_WRPROT
suffix:semicolon
r_if
c_cond
(paren
id|mem-&gt;flags
op_amp
id|MAP_ATTRIB
)paren
(brace
multiline_comment|/* dprintk(&quot;requesting attribute memory for socket %i&bslash;n&quot;,&n;&t;&t;&t;socket-&gt;number);*/
id|i
op_or_assign
id|I365_MEM_REG
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* dprintk(&quot;requesting normal memory for socket %i&bslash;n&quot;,&n;&t;&t;&t;socket-&gt;number);*/
)brace
id|indirect_write16
c_func
(paren
id|socket
comma
id|base
op_plus
id|I365_W_OFF
comma
id|i
)paren
suffix:semicolon
multiline_comment|/* Enable the window if necessary */
r_if
c_cond
(paren
id|mem-&gt;flags
op_amp
id|MAP_ACTIVE
)paren
id|indirect_setbit
c_func
(paren
id|socket
comma
id|I365_ADDRWIN
comma
id|I365_ENA_MEM
c_func
(paren
id|map
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pd6729_suspend
r_static
r_int
id|pd6729_suspend
c_func
(paren
r_struct
id|pcmcia_socket
op_star
id|sock
)paren
(brace
r_return
id|pd6729_set_socket
c_func
(paren
id|sock
comma
op_amp
id|dead_socket
)paren
suffix:semicolon
)brace
DECL|function|pd6729_init
r_static
r_int
id|pd6729_init
c_func
(paren
r_struct
id|pcmcia_socket
op_star
id|sock
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|resource
id|res
op_assign
(brace
dot
id|end
op_assign
l_int|0x0fff
)brace
suffix:semicolon
id|pccard_io_map
id|io
op_assign
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|1
)brace
suffix:semicolon
id|pccard_mem_map
id|mem
op_assign
(brace
dot
id|res
op_assign
op_amp
id|res
comma
)brace
suffix:semicolon
id|pd6729_set_socket
c_func
(paren
id|sock
comma
op_amp
id|dead_socket
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|2
suffix:semicolon
id|i
op_increment
)paren
(brace
id|io.map
op_assign
id|i
suffix:semicolon
id|pd6729_set_io_map
c_func
(paren
id|sock
comma
op_amp
id|io
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|5
suffix:semicolon
id|i
op_increment
)paren
(brace
id|mem.map
op_assign
id|i
suffix:semicolon
id|pd6729_set_mem_map
c_func
(paren
id|sock
comma
op_amp
id|mem
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* the pccard structure and its functions */
DECL|variable|pd6729_operations
r_static
r_struct
id|pccard_operations
id|pd6729_operations
op_assign
(brace
dot
id|init
op_assign
id|pd6729_init
comma
dot
id|suspend
op_assign
id|pd6729_suspend
comma
dot
id|get_status
op_assign
id|pd6729_get_status
comma
dot
id|get_socket
op_assign
id|pd6729_get_socket
comma
dot
id|set_socket
op_assign
id|pd6729_set_socket
comma
dot
id|set_io_map
op_assign
id|pd6729_set_io_map
comma
dot
id|set_mem_map
op_assign
id|pd6729_set_mem_map
comma
)brace
suffix:semicolon
DECL|function|pd6729_test
r_static
id|irqreturn_t
id|pd6729_test
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;-&gt; hit on irq %d&bslash;n&quot;
comma
id|irq
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
DECL|function|pd6729_check_irq
r_static
r_int
id|pd6729_check_irq
c_func
(paren
r_int
id|irq
comma
r_int
id|flags
)paren
(brace
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|irq
comma
id|pd6729_test
comma
id|flags
comma
l_string|&quot;x&quot;
comma
id|pd6729_test
)paren
op_ne
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|free_irq
c_func
(paren
id|irq
comma
id|pd6729_test
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pd6729_isa_scan
r_static
id|u_int
id|__init
id|pd6729_isa_scan
c_func
(paren
r_void
)paren
(brace
id|u_int
id|mask0
comma
id|mask
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|irq_mode
op_eq
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;pd6729: PCI card interrupts, &quot;
l_string|&quot;PCI status changes&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|irq_list_count
op_eq
l_int|0
)paren
id|mask0
op_assign
l_int|0xffff
suffix:semicolon
r_else
r_for
c_loop
(paren
id|i
op_assign
id|mask0
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|irq_list_count
suffix:semicolon
id|i
op_increment
)paren
id|mask0
op_or_assign
(paren
l_int|1
op_lshift
id|irq_list
(braket
id|i
)braket
)paren
suffix:semicolon
id|mask0
op_and_assign
id|PD67_MASK
suffix:semicolon
multiline_comment|/* just find interrupts that aren&squot;t in use */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
(paren
id|mask0
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
op_logical_and
(paren
id|pd6729_check_irq
c_func
(paren
id|i
comma
l_int|0
)paren
op_eq
l_int|0
)paren
)paren
id|mask
op_or_assign
(paren
l_int|1
op_lshift
id|i
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;pd6729: ISA irqs = &quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|mask
op_amp
(paren
l_int|1
op_lshift
id|i
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;%s%d&quot;
comma
(paren
(paren
id|mask
op_amp
(paren
(paren
l_int|1
op_lshift
id|i
)paren
op_minus
l_int|1
)paren
)paren
ques
c_cond
l_string|&quot;,&quot;
suffix:colon
l_string|&quot;&quot;
)paren
comma
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mask
op_eq
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;none!&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;  polling status changes.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|mask
suffix:semicolon
)brace
DECL|function|pd6729_pci_probe
r_static
r_int
id|__devinit
id|pd6729_pci_probe
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_const
r_struct
id|pci_device_id
op_star
id|id
)paren
(brace
r_int
id|i
comma
id|j
comma
id|ret
suffix:semicolon
id|u_int
id|mask
suffix:semicolon
r_char
id|configbyte
suffix:semicolon
r_struct
id|pd6729_socket
op_star
id|socket
suffix:semicolon
id|socket
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|pd6729_socket
)paren
op_star
id|MAX_SOCKETS
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|socket
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|socket
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|pd6729_socket
)paren
op_star
id|MAX_SOCKETS
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|pci_enable_device
c_func
(paren
id|dev
)paren
)paren
)paren
r_goto
id|err_out_free_mem
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;pd6729: Cirrus PD6729 PCI to PCMCIA Bridge &quot;
l_string|&quot;at 0x%lx on irq %d&bslash;n&quot;
comma
id|pci_resource_start
c_func
(paren
id|dev
comma
l_int|0
)paren
comma
id|dev-&gt;irq
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Since we have no memory BARs some firmware may not&n;&t; * have had PCI_COMMAND_MEMORY enabled, yet the device needs it.&n;&t; */
id|pci_read_config_byte
c_func
(paren
id|dev
comma
id|PCI_COMMAND
comma
op_amp
id|configbyte
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|configbyte
op_amp
id|PCI_COMMAND_MEMORY
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;pd6729: Enabling PCI_COMMAND_MEMORY.&bslash;n&quot;
)paren
suffix:semicolon
id|configbyte
op_or_assign
id|PCI_COMMAND_MEMORY
suffix:semicolon
id|pci_write_config_byte
c_func
(paren
id|dev
comma
id|PCI_COMMAND
comma
id|configbyte
)paren
suffix:semicolon
)brace
id|ret
op_assign
id|pci_request_regions
c_func
(paren
id|dev
comma
l_string|&quot;pd6729&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;pd6729: pci request region failed.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|err_out_disable
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dev-&gt;irq
op_eq
id|NO_IRQ
)paren
id|irq_mode
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* fall back to ISA interrupt mode */
id|mask
op_assign
id|pd6729_isa_scan
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|irq_mode
op_eq
l_int|0
op_logical_and
id|mask
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;pd6729: no ISA interrupt is available.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|err_out_free_res
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_SOCKETS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|socket
(braket
id|i
)braket
dot
id|io_base
op_assign
id|pci_resource_start
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
id|socket
(braket
id|i
)braket
dot
id|socket.features
op_or_assign
id|SS_CAP_PCCARD
suffix:semicolon
id|socket
(braket
id|i
)braket
dot
id|socket.map_size
op_assign
l_int|0x1000
suffix:semicolon
id|socket
(braket
id|i
)braket
dot
id|socket.irq_mask
op_assign
id|mask
suffix:semicolon
id|socket
(braket
id|i
)braket
dot
id|socket.pci_irq
op_assign
id|dev-&gt;irq
suffix:semicolon
id|socket
(braket
id|i
)braket
dot
id|socket.owner
op_assign
id|THIS_MODULE
suffix:semicolon
id|socket
(braket
id|i
)braket
dot
id|number
op_assign
id|i
suffix:semicolon
id|socket
(braket
id|i
)braket
dot
id|socket.ops
op_assign
op_amp
id|pd6729_operations
suffix:semicolon
id|socket
(braket
id|i
)braket
dot
id|socket.resource_ops
op_assign
op_amp
id|pccard_nonstatic_ops
suffix:semicolon
id|socket
(braket
id|i
)braket
dot
id|socket.dev.dev
op_assign
op_amp
id|dev-&gt;dev
suffix:semicolon
id|socket
(braket
id|i
)braket
dot
id|socket.driver_data
op_assign
op_amp
id|socket
(braket
id|i
)braket
suffix:semicolon
)brace
id|pci_set_drvdata
c_func
(paren
id|dev
comma
id|socket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|irq_mode
op_eq
l_int|1
)paren
(brace
multiline_comment|/* Register the interrupt handler */
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
id|pd6729_interrupt
comma
id|SA_SHIRQ
comma
l_string|&quot;pd6729&quot;
comma
id|socket
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;pd6729: Failed to register irq %d, &quot;
l_string|&quot;aborting&bslash;n&quot;
comma
id|dev-&gt;irq
)paren
suffix:semicolon
r_goto
id|err_out_free_res
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* poll Card status change */
id|init_timer
c_func
(paren
op_amp
id|socket-&gt;poll_timer
)paren
suffix:semicolon
id|socket-&gt;poll_timer.function
op_assign
id|pd6729_interrupt_wrapper
suffix:semicolon
id|socket-&gt;poll_timer.data
op_assign
(paren
r_int
r_int
)paren
id|socket
suffix:semicolon
id|socket-&gt;poll_timer.expires
op_assign
id|jiffies
op_plus
id|HZ
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|socket-&gt;poll_timer
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_SOCKETS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ret
op_assign
id|pcmcia_register_socket
c_func
(paren
op_amp
id|socket
(braket
id|i
)braket
dot
id|socket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;pd6729: pcmcia_register_socket &quot;
l_string|&quot;failed.&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|i
suffix:semicolon
id|j
op_increment
)paren
id|pcmcia_unregister_socket
c_func
(paren
op_amp
id|socket
(braket
id|j
)braket
dot
id|socket
)paren
suffix:semicolon
r_goto
id|err_out_free_res2
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
id|err_out_free_res2
suffix:colon
r_if
c_cond
(paren
id|irq_mode
op_eq
l_int|1
)paren
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|socket
)paren
suffix:semicolon
r_else
id|del_timer_sync
c_func
(paren
op_amp
id|socket-&gt;poll_timer
)paren
suffix:semicolon
id|err_out_free_res
suffix:colon
id|pci_release_regions
c_func
(paren
id|dev
)paren
suffix:semicolon
id|err_out_disable
suffix:colon
id|pci_disable_device
c_func
(paren
id|dev
)paren
suffix:semicolon
id|err_out_free_mem
suffix:colon
id|kfree
c_func
(paren
id|socket
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|pd6729_pci_remove
r_static
r_void
id|__devexit
id|pd6729_pci_remove
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|pd6729_socket
op_star
id|socket
op_assign
id|pci_get_drvdata
c_func
(paren
id|dev
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_SOCKETS
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* Turn off all interrupt sources */
id|indirect_write
c_func
(paren
op_amp
id|socket
(braket
id|i
)braket
comma
id|I365_CSCINT
comma
l_int|0
)paren
suffix:semicolon
id|indirect_write
c_func
(paren
op_amp
id|socket
(braket
id|i
)braket
comma
id|I365_INTCTL
comma
l_int|0
)paren
suffix:semicolon
id|pcmcia_unregister_socket
c_func
(paren
op_amp
id|socket
(braket
id|i
)braket
dot
id|socket
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|irq_mode
op_eq
l_int|1
)paren
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|socket
)paren
suffix:semicolon
r_else
id|del_timer_sync
c_func
(paren
op_amp
id|socket-&gt;poll_timer
)paren
suffix:semicolon
id|pci_release_regions
c_func
(paren
id|dev
)paren
suffix:semicolon
id|pci_disable_device
c_func
(paren
id|dev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|socket
)paren
suffix:semicolon
)brace
DECL|function|pd6729_socket_suspend
r_static
r_int
id|pd6729_socket_suspend
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
id|u32
id|state
)paren
(brace
r_return
id|pcmcia_socket_dev_suspend
c_func
(paren
op_amp
id|dev-&gt;dev
comma
id|state
)paren
suffix:semicolon
)brace
DECL|function|pd6729_socket_resume
r_static
r_int
id|pd6729_socket_resume
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
r_return
id|pcmcia_socket_dev_resume
c_func
(paren
op_amp
id|dev-&gt;dev
)paren
suffix:semicolon
)brace
DECL|variable|pd6729_pci_ids
r_static
r_struct
id|pci_device_id
id|pd6729_pci_ids
(braket
)braket
op_assign
(brace
(brace
dot
id|vendor
op_assign
id|PCI_VENDOR_ID_CIRRUS
comma
dot
id|device
op_assign
id|PCI_DEVICE_ID_CIRRUS_6729
comma
dot
id|subvendor
op_assign
id|PCI_ANY_ID
comma
dot
id|subdevice
op_assign
id|PCI_ANY_ID
comma
)brace
comma
(brace
)brace
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|pci
comma
id|pd6729_pci_ids
)paren
suffix:semicolon
DECL|variable|pd6729_pci_drv
r_static
r_struct
id|pci_driver
id|pd6729_pci_drv
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;pd6729&quot;
comma
dot
id|id_table
op_assign
id|pd6729_pci_ids
comma
dot
id|probe
op_assign
id|pd6729_pci_probe
comma
dot
id|remove
op_assign
id|__devexit_p
c_func
(paren
id|pd6729_pci_remove
)paren
comma
dot
id|suspend
op_assign
id|pd6729_socket_suspend
comma
dot
id|resume
op_assign
id|pd6729_socket_resume
comma
)brace
suffix:semicolon
DECL|function|pd6729_module_init
r_static
r_int
id|pd6729_module_init
c_func
(paren
r_void
)paren
(brace
r_return
id|pci_module_init
c_func
(paren
op_amp
id|pd6729_pci_drv
)paren
suffix:semicolon
)brace
DECL|function|pd6729_module_exit
r_static
r_void
id|pd6729_module_exit
c_func
(paren
r_void
)paren
(brace
id|pci_unregister_driver
c_func
(paren
op_amp
id|pd6729_pci_drv
)paren
suffix:semicolon
)brace
DECL|variable|pd6729_module_init
id|module_init
c_func
(paren
id|pd6729_module_init
)paren
suffix:semicolon
DECL|variable|pd6729_module_exit
id|module_exit
c_func
(paren
id|pd6729_module_exit
)paren
suffix:semicolon
eof
