multiline_comment|/*&n; * $Id$&n; *&n; * Device driver for the PCMCIA controller module of the&n; * Hitachi HD64465 handheld companion chip.&n; *&n; * Note that the HD64465 provides a very thin PCMCIA host bridge&n; * layer, requiring a lot of the work of supporting cards to be&n; * performed by the processor.  For example: mapping of card&n; * interrupts to processor IRQs is done by IRQ demuxing software;&n; * IO and memory mappings are fixed; setting voltages according&n; * to card Voltage Select pins etc is done in software.&n; *&n; * Note also that this driver uses only the simple, fixed,&n; * 16MB, 16-bit wide mappings to PCMCIA spaces defined by the&n; * HD64465.  Larger mappings, smaller mappings, or mappings of&n; * different width to the same socket, are all possible only by&n; * involving the SH7750&squot;s MMU, which is considered unnecessary here.&n; * The downside is that it may be possible for some drivers to&n; * break because they need or expect 8-bit mappings.&n; *&n; * This driver currently supports only the following configuration:&n; * SH7750 CPU, HD64465, TPS2206 voltage control chip.&n; *&n; * by Greg Banks &lt;gbanks@pocketpenguins.com&gt;&n; * (c) 2000 PocketPenguins Inc&n; *&n; */
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/vmalloc.h&gt;
macro_line|#include &lt;asm/errno.h&gt;
macro_line|#include &lt;linux/irq.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/hd64465.h&gt;
macro_line|#include &lt;pcmcia/version.h&gt;
macro_line|#include &lt;pcmcia/cs_types.h&gt;
macro_line|#include &lt;pcmcia/cs.h&gt;
macro_line|#include &lt;pcmcia/ss.h&gt;
macro_line|#include &lt;pcmcia/bulkmem.h&gt;
macro_line|#include &lt;pcmcia/cistpl.h&gt;
macro_line|#include &quot;cs_internal.h&quot;
DECL|macro|MODNAME
mdefine_line|#define MODNAME &quot;hd64465_ss&quot;
multiline_comment|/* #define HD64465_DEBUG 1 */
macro_line|#ifndef HD64465_DEBUG
DECL|macro|HD64465_DEBUG
mdefine_line|#define HD64465_DEBUG 0
macro_line|#endif
macro_line|#if HD64465_DEBUG
DECL|macro|DPRINTK
mdefine_line|#define DPRINTK(args...)&t;printk(MODNAME &quot;: &quot; args)
macro_line|#else
DECL|macro|DPRINTK
mdefine_line|#define DPRINTK(args...)
macro_line|#endif
r_extern
r_int
id|hd64465_io_debug
suffix:semicolon
multiline_comment|/*============================================================*/
DECL|macro|HS_IO_MAP_SIZE
mdefine_line|#define HS_IO_MAP_SIZE &t;(64*1024)
DECL|struct|hs_socket_t
r_typedef
r_struct
id|hs_socket_t
(brace
DECL|member|irq
id|u_int
id|irq
suffix:semicolon
DECL|member|mem_base
id|u_long
id|mem_base
suffix:semicolon
DECL|member|mem_length
id|u_long
id|mem_length
suffix:semicolon
DECL|member|handler
r_void
(paren
op_star
id|handler
)paren
(paren
r_void
op_star
id|info
comma
id|u_int
id|events
)paren
suffix:semicolon
DECL|member|handler_info
r_void
op_star
id|handler_info
suffix:semicolon
DECL|member|pending_events
id|u_int
id|pending_events
suffix:semicolon
DECL|member|ctrl_base
id|u_int
id|ctrl_base
suffix:semicolon
DECL|member|state
id|socket_state_t
id|state
suffix:semicolon
DECL|member|io_maps
id|pccard_io_map
id|io_maps
(braket
id|MAX_IO_WIN
)braket
suffix:semicolon
DECL|member|mem_maps
id|pccard_mem_map
id|mem_maps
(braket
id|MAX_WIN
)braket
suffix:semicolon
DECL|member|io_vma
r_struct
id|vm_struct
op_star
id|io_vma
suffix:semicolon
multiline_comment|/* allocated kernel vm for mapping IO space */
DECL|typedef|hs_socket_t
)brace
id|hs_socket_t
suffix:semicolon
DECL|macro|HS_MAX_SOCKETS
mdefine_line|#define HS_MAX_SOCKETS 2
DECL|variable|hs_sockets
r_static
id|hs_socket_t
id|hs_sockets
(braket
id|HS_MAX_SOCKETS
)braket
suffix:semicolon
DECL|variable|hs_pending_event_lock
r_static
id|spinlock_t
id|hs_pending_event_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
multiline_comment|/* Calculate socket number from ptr into hs_sockets[] */
DECL|macro|hs_sockno
mdefine_line|#define hs_sockno(sp) &t;(sp - hs_sockets)
DECL|variable|hs_socket_cap
r_static
id|socket_cap_t
id|hs_socket_cap
op_assign
(brace
id|SS_CAP_PCCARD
multiline_comment|/* support 16 bit cards */
op_or
id|SS_CAP_STATIC_MAP
multiline_comment|/* mappings are fixed in host memory */
comma
l_int|0xffde
multiline_comment|/*0xffff*/
comma
multiline_comment|/* IRQs mapped in s/w so can do any, really */
id|HD64465_PCC_WINDOW
comma
multiline_comment|/* 16MB fixed window size */
l_int|0
comma
multiline_comment|/* no PCI support */
l_int|0
comma
multiline_comment|/* no CardBus support */
l_int|0
multiline_comment|/* no bus operations needed */
)brace
suffix:semicolon
DECL|macro|hs_in
mdefine_line|#define hs_in(sp, r)&t;    inb((sp)-&gt;ctrl_base + (r))
DECL|macro|hs_out
mdefine_line|#define hs_out(sp, v, r)    outb(v, (sp)-&gt;ctrl_base + (r))
multiline_comment|/* translate a boolean value to a bit in a register */
DECL|macro|bool_to_regbit
mdefine_line|#define bool_to_regbit(sp, r, bi, bo)&t;    &t;&bslash;&n;    do {    &t;    &t;    &t;    &t;    &t;&bslash;&n;    &t;unsigned short v = hs_in(sp, r);    &t;&bslash;&n;&t;if (bo)     &t;    &t;    &t;    &t;&bslash;&n;&t;    v |= (bi);&t;    &t;    &t;    &t;&bslash;&n;&t;else&t;    &t;    &t;    &t;    &t;&bslash;&n;&t;    v &amp;= ~(bi);     &t;    &t;    &t;&bslash;&n;&t;hs_out(sp, v, r);   &t;    &t;    &t;&bslash;&n;    } while(0)
multiline_comment|/* register offsets from HD64465_REG_PCC[01]ISR */
DECL|macro|ISR
mdefine_line|#define ISR &t;0x0
DECL|macro|GCR
mdefine_line|#define GCR &t;0x2
DECL|macro|CSCR
mdefine_line|#define CSCR &t;0x4
DECL|macro|CSCIER
mdefine_line|#define CSCIER &t;0x6
DECL|macro|SCR
mdefine_line|#define SCR &t;0x8
multiline_comment|/* Mask and values for CSCIER register */
DECL|macro|IER_MASK
mdefine_line|#define IER_MASK    0x80
DECL|macro|IER_ON
mdefine_line|#define IER_ON&t;    0x3f    &t;/* interrupts on */
DECL|macro|IER_OFF
mdefine_line|#define IER_OFF     0x00    &t;/* interrupts off */
multiline_comment|/*============================================================*/
macro_line|#if HD64465_DEBUG &gt; 10
DECL|function|cis_hex_dump
r_static
r_void
id|cis_hex_dump
c_func
(paren
r_const
r_int
r_char
op_star
id|x
comma
r_int
id|len
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|i
op_amp
l_int|0xf
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;&bslash;n%08x&quot;
comma
(paren
r_int
)paren
(paren
id|x
op_plus
id|i
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; %02x&quot;
comma
op_star
(paren
r_volatile
r_int
r_int
op_star
)paren
id|x
)paren
suffix:semicolon
id|x
op_add_assign
l_int|2
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*============================================================*/
multiline_comment|/*&n; * This code helps create the illusion that the IREQ line from&n; * the PC card is mapped to one of the CPU&squot;s IRQ lines by the&n; * host bridge hardware (which is how every host bridge *except*&n; * the HD64465 works).  In particular, it supports enabling&n; * and disabling the IREQ line by code which knows nothing&n; * about the host bridge (e.g. device drivers, IDE code) using&n; * the request_irq(), free_irq(), probe_irq_on() and probe_irq_off()&n; * functions.  Also, it supports sharing the mapped IRQ with&n; * real hardware IRQs from the -IRL0-3 lines.&n; */
DECL|macro|HS_NUM_MAPPED_IRQS
mdefine_line|#define HS_NUM_MAPPED_IRQS  16&t;/* Limitation of the PCMCIA code */
r_static
r_struct
(brace
multiline_comment|/* index is mapped irq number */
DECL|member|sock
id|hs_socket_t
op_star
id|sock
suffix:semicolon
DECL|member|old_handler
id|hw_irq_controller
op_star
id|old_handler
suffix:semicolon
DECL|variable|hs_mapped_irq
)brace
id|hs_mapped_irq
(braket
id|HS_NUM_MAPPED_IRQS
)braket
suffix:semicolon
DECL|function|hs_socket_enable_ireq
r_static
r_void
id|hs_socket_enable_ireq
c_func
(paren
id|hs_socket_t
op_star
id|sp
)paren
(brace
r_int
r_int
id|cscier
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;hs_socket_enable_ireq(sock=%d)&bslash;n&quot;
comma
id|hs_sockno
c_func
(paren
id|sp
)paren
)paren
suffix:semicolon
id|cscier
op_assign
id|hs_in
c_func
(paren
id|sp
comma
id|CSCIER
)paren
suffix:semicolon
id|cscier
op_and_assign
op_complement
id|HD64465_PCCCSCIER_PIREQE_MASK
suffix:semicolon
id|cscier
op_or_assign
id|HD64465_PCCCSCIER_PIREQE_LEVEL
suffix:semicolon
id|hs_out
c_func
(paren
id|sp
comma
id|cscier
comma
id|CSCIER
)paren
suffix:semicolon
)brace
DECL|function|hs_socket_disable_ireq
r_static
r_void
id|hs_socket_disable_ireq
c_func
(paren
id|hs_socket_t
op_star
id|sp
)paren
(brace
r_int
r_int
id|cscier
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;hs_socket_disable_ireq(sock=%d)&bslash;n&quot;
comma
id|hs_sockno
c_func
(paren
id|sp
)paren
)paren
suffix:semicolon
id|cscier
op_assign
id|hs_in
c_func
(paren
id|sp
comma
id|CSCIER
)paren
suffix:semicolon
id|cscier
op_and_assign
op_complement
id|HD64465_PCCCSCIER_PIREQE_MASK
suffix:semicolon
id|hs_out
c_func
(paren
id|sp
comma
id|cscier
comma
id|CSCIER
)paren
suffix:semicolon
)brace
DECL|function|hs_startup_irq
r_static
r_int
r_int
id|hs_startup_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
id|hs_socket_enable_ireq
c_func
(paren
id|hs_mapped_irq
(braket
id|irq
)braket
dot
id|sock
)paren
suffix:semicolon
id|hs_mapped_irq
(braket
id|irq
)braket
dot
id|old_handler
op_member_access_from_pointer
id|startup
c_func
(paren
id|irq
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|hs_shutdown_irq
r_static
r_void
id|hs_shutdown_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
id|hs_socket_disable_ireq
c_func
(paren
id|hs_mapped_irq
(braket
id|irq
)braket
dot
id|sock
)paren
suffix:semicolon
id|hs_mapped_irq
(braket
id|irq
)braket
dot
id|old_handler
op_member_access_from_pointer
id|shutdown
c_func
(paren
id|irq
)paren
suffix:semicolon
)brace
DECL|function|hs_enable_irq
r_static
r_void
id|hs_enable_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
id|hs_socket_enable_ireq
c_func
(paren
id|hs_mapped_irq
(braket
id|irq
)braket
dot
id|sock
)paren
suffix:semicolon
id|hs_mapped_irq
(braket
id|irq
)braket
dot
id|old_handler
op_member_access_from_pointer
id|enable
c_func
(paren
id|irq
)paren
suffix:semicolon
)brace
DECL|function|hs_disable_irq
r_static
r_void
id|hs_disable_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
id|hs_socket_disable_ireq
c_func
(paren
id|hs_mapped_irq
(braket
id|irq
)braket
dot
id|sock
)paren
suffix:semicolon
id|hs_mapped_irq
(braket
id|irq
)braket
dot
id|old_handler
op_member_access_from_pointer
id|disable
c_func
(paren
id|irq
)paren
suffix:semicolon
)brace
r_extern
r_struct
id|hw_interrupt_type
id|no_irq_type
suffix:semicolon
DECL|function|hs_mask_and_ack_irq
r_static
r_void
id|hs_mask_and_ack_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
id|hs_socket_disable_ireq
c_func
(paren
id|hs_mapped_irq
(braket
id|irq
)braket
dot
id|sock
)paren
suffix:semicolon
multiline_comment|/* ack_none() spuriously complains about an unexpected IRQ */
r_if
c_cond
(paren
id|hs_mapped_irq
(braket
id|irq
)braket
dot
id|old_handler
op_ne
op_amp
id|no_irq_type
)paren
id|hs_mapped_irq
(braket
id|irq
)braket
dot
id|old_handler
op_member_access_from_pointer
id|ack
c_func
(paren
id|irq
)paren
suffix:semicolon
)brace
DECL|function|hs_end_irq
r_static
r_void
id|hs_end_irq
c_func
(paren
r_int
r_int
id|irq
)paren
(brace
id|hs_socket_enable_ireq
c_func
(paren
id|hs_mapped_irq
(braket
id|irq
)braket
dot
id|sock
)paren
suffix:semicolon
id|hs_mapped_irq
(braket
id|irq
)braket
dot
id|old_handler
op_member_access_from_pointer
id|end
c_func
(paren
id|irq
)paren
suffix:semicolon
)brace
DECL|variable|hd64465_ss_irq_type
r_static
r_struct
id|hw_interrupt_type
id|hd64465_ss_irq_type
op_assign
(brace
r_typename
suffix:colon
l_string|&quot;PCMCIA-IRQ&quot;
comma
id|startup
suffix:colon
id|hs_startup_irq
comma
id|shutdown
suffix:colon
id|hs_shutdown_irq
comma
id|enable
suffix:colon
id|hs_enable_irq
comma
id|disable
suffix:colon
id|hs_disable_irq
comma
id|ack
suffix:colon
id|hs_mask_and_ack_irq
comma
id|end
suffix:colon
id|hs_end_irq
)brace
suffix:semicolon
multiline_comment|/* &n; * This function should only ever be called with interrupts disabled.&n; */
DECL|function|hs_map_irq
r_static
r_void
id|hs_map_irq
c_func
(paren
id|hs_socket_t
op_star
id|sp
comma
r_int
r_int
id|irq
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;hs_map_irq(sock=%d irq=%d)&bslash;n&quot;
comma
id|hs_sockno
c_func
(paren
id|sp
)paren
comma
id|irq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|irq
op_ge
id|HS_NUM_MAPPED_IRQS
)paren
r_return
suffix:semicolon
id|hs_mapped_irq
(braket
id|irq
)braket
dot
id|sock
op_assign
id|sp
suffix:semicolon
multiline_comment|/* insert ourselves as the irq controller */
id|hs_mapped_irq
(braket
id|irq
)braket
dot
id|old_handler
op_assign
id|irq_desc
(braket
id|irq
)braket
dot
id|handler
suffix:semicolon
id|irq_desc
(braket
id|irq
)braket
dot
id|handler
op_assign
op_amp
id|hd64465_ss_irq_type
suffix:semicolon
)brace
multiline_comment|/* &n; * This function should only ever be called with interrupts disabled.&n; */
DECL|function|hs_unmap_irq
r_static
r_void
id|hs_unmap_irq
c_func
(paren
id|hs_socket_t
op_star
id|sp
comma
r_int
r_int
id|irq
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;hs_unmap_irq(sock=%d irq=%d)&bslash;n&quot;
comma
id|hs_sockno
c_func
(paren
id|sp
)paren
comma
id|irq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|irq
op_ge
id|HS_NUM_MAPPED_IRQS
)paren
r_return
suffix:semicolon
multiline_comment|/* restore the original irq controller */
id|irq_desc
(braket
id|irq
)braket
dot
id|handler
op_assign
id|hs_mapped_irq
(braket
id|irq
)braket
dot
id|old_handler
suffix:semicolon
)brace
multiline_comment|/*============================================================*/
multiline_comment|/*&n; * Set Vpp and Vcc (in tenths of a Volt).  Does not&n; * support the hi-Z state.&n; *&n; * Note, this assumes the board uses a TPS2206 chip to control&n; * the Vcc and Vpp voltages to the hs_sockets.  If your board&n; * uses the MIC2563 (also supported by the HD64465) then you&n; * will have to modify this function.&n; */
multiline_comment|/* 0V   3.3V  5.5V */
DECL|variable|hs_tps2206_avcc
r_static
r_const
id|u_char
id|hs_tps2206_avcc
(braket
l_int|3
)braket
op_assign
(brace
l_int|0x00
comma
l_int|0x04
comma
l_int|0x08
)brace
suffix:semicolon
DECL|variable|hs_tps2206_bvcc
r_static
r_const
id|u_char
id|hs_tps2206_bvcc
(braket
l_int|3
)braket
op_assign
(brace
l_int|0x00
comma
l_int|0x80
comma
l_int|0x40
)brace
suffix:semicolon
DECL|function|hs_set_voltages
r_static
r_int
id|hs_set_voltages
c_func
(paren
id|hs_socket_t
op_star
id|sp
comma
r_int
id|Vcc
comma
r_int
id|Vpp
)paren
(brace
id|u_int
id|psr
suffix:semicolon
id|u_int
id|vcci
op_assign
l_int|0
suffix:semicolon
id|u_int
id|sock
op_assign
id|hs_sockno
c_func
(paren
id|sp
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;hs_set_voltage(%d, %d, %d)&bslash;n&quot;
comma
id|sock
comma
id|Vcc
comma
id|Vpp
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|Vcc
)paren
(brace
r_case
l_int|0
suffix:colon
id|vcci
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|33
suffix:colon
id|vcci
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|50
suffix:colon
id|vcci
op_assign
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Note: Vpp = 120 not supported -- Greg Banks */
r_if
c_cond
(paren
id|Vpp
op_ne
l_int|0
op_logical_and
id|Vpp
op_ne
id|Vcc
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* The PSR register holds 8 of the 9 bits which control&n;&t; * the TPS2206 via its serial interface.&n;&t; */
id|psr
op_assign
id|inw
c_func
(paren
id|HD64465_REG_PCCPSR
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|sock
)paren
(brace
r_case
l_int|0
suffix:colon
id|psr
op_and_assign
l_int|0x0f
suffix:semicolon
id|psr
op_or_assign
id|hs_tps2206_avcc
(braket
id|vcci
)braket
suffix:semicolon
id|psr
op_or_assign
(paren
id|Vpp
op_eq
l_int|0
ques
c_cond
l_int|0x00
suffix:colon
l_int|0x02
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|psr
op_and_assign
l_int|0xf0
suffix:semicolon
id|psr
op_or_assign
id|hs_tps2206_bvcc
(braket
id|vcci
)braket
suffix:semicolon
id|psr
op_or_assign
(paren
id|Vpp
op_eq
l_int|0
ques
c_cond
l_int|0x00
suffix:colon
l_int|0x20
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
suffix:semicolon
id|outw
c_func
(paren
id|psr
comma
id|HD64465_REG_PCCPSR
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*============================================================*/
multiline_comment|/*&n; * Drive the RESET line to the card.&n; */
DECL|function|hs_reset_socket
r_static
r_void
id|hs_reset_socket
c_func
(paren
id|hs_socket_t
op_star
id|sp
comma
r_int
id|on
)paren
(brace
r_int
r_int
id|v
suffix:semicolon
id|v
op_assign
id|hs_in
c_func
(paren
id|sp
comma
id|GCR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|on
)paren
id|v
op_or_assign
id|HD64465_PCCGCR_PCCR
suffix:semicolon
r_else
id|v
op_and_assign
op_complement
id|HD64465_PCCGCR_PCCR
suffix:semicolon
id|hs_out
c_func
(paren
id|sp
comma
id|v
comma
id|GCR
)paren
suffix:semicolon
)brace
multiline_comment|/*============================================================*/
DECL|function|hs_init
r_static
r_int
id|hs_init
c_func
(paren
r_int
r_int
id|sock
)paren
(brace
id|hs_socket_t
op_star
id|sp
op_assign
op_amp
id|hs_sockets
(braket
id|sock
)braket
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;hs_init(%d)&bslash;n&quot;
comma
id|sock
)paren
suffix:semicolon
id|sp-&gt;pending_events
op_assign
l_int|0
suffix:semicolon
id|sp-&gt;state.Vcc
op_assign
l_int|0
suffix:semicolon
id|sp-&gt;state.Vpp
op_assign
l_int|0
suffix:semicolon
id|hs_set_voltages
c_func
(paren
id|sp
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*============================================================*/
DECL|function|hs_suspend
r_static
r_int
id|hs_suspend
c_func
(paren
r_int
r_int
id|sock
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;hs_suspend(%d)&bslash;n&quot;
comma
id|sock
)paren
suffix:semicolon
multiline_comment|/* TODO */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*============================================================*/
DECL|function|hs_register_callback
r_static
r_int
id|hs_register_callback
c_func
(paren
r_int
r_int
id|sock
comma
r_void
(paren
op_star
id|handler
)paren
(paren
r_void
op_star
comma
r_int
r_int
)paren
comma
r_void
op_star
id|info
)paren
(brace
id|hs_socket_t
op_star
id|sp
op_assign
op_amp
id|hs_sockets
(braket
id|sock
)braket
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;hs_register_callback(%d)&bslash;n&quot;
comma
id|sock
)paren
suffix:semicolon
id|sp-&gt;handler
op_assign
id|handler
suffix:semicolon
id|sp-&gt;handler_info
op_assign
id|info
suffix:semicolon
r_if
c_cond
(paren
id|handler
op_eq
l_int|0
)paren
(brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
r_else
(brace
id|MOD_INC_USE_COUNT
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*============================================================*/
DECL|function|hs_inquire_socket
r_static
r_int
id|hs_inquire_socket
c_func
(paren
r_int
r_int
id|sock
comma
id|socket_cap_t
op_star
id|cap
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;hs_inquire_socket(%d)&bslash;n&quot;
comma
id|sock
)paren
suffix:semicolon
op_star
id|cap
op_assign
id|hs_socket_cap
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*============================================================*/
DECL|function|hs_get_status
r_static
r_int
id|hs_get_status
c_func
(paren
r_int
r_int
id|sock
comma
id|u_int
op_star
id|value
)paren
(brace
id|hs_socket_t
op_star
id|sp
op_assign
op_amp
id|hs_sockets
(braket
id|sock
)braket
suffix:semicolon
r_int
r_int
id|isr
suffix:semicolon
id|u_int
id|status
op_assign
l_int|0
suffix:semicolon
id|isr
op_assign
id|hs_in
c_func
(paren
id|sp
comma
id|ISR
)paren
suffix:semicolon
multiline_comment|/* Card is seated and powered when *both* CD pins are low */
r_if
c_cond
(paren
(paren
id|isr
op_amp
id|HD64465_PCCISR_PCD_MASK
)paren
op_eq
l_int|0
)paren
(brace
id|status
op_or_assign
id|SS_DETECT
suffix:semicolon
multiline_comment|/* card present */
r_switch
c_cond
(paren
id|isr
op_amp
id|HD64465_PCCISR_PBVD_MASK
)paren
(brace
r_case
id|HD64465_PCCISR_PBVD_BATGOOD
suffix:colon
r_break
suffix:semicolon
r_case
id|HD64465_PCCISR_PBVD_BATWARN
suffix:colon
id|status
op_or_assign
id|SS_BATWARN
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|status
op_or_assign
id|SS_BATDEAD
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|isr
op_amp
id|HD64465_PCCISR_PREADY
)paren
id|status
op_or_assign
id|SS_READY
suffix:semicolon
r_if
c_cond
(paren
id|isr
op_amp
id|HD64465_PCCISR_PMWP
)paren
id|status
op_or_assign
id|SS_WRPROT
suffix:semicolon
multiline_comment|/* Voltage Select pins interpreted as per Table 4-5 of the std.&n;&t;     * Assuming we have the TPS2206, the socket is a &quot;Low Voltage&n;&t;     * key, 3.3V and 5V available, no X.XV available&quot;.&n;&t;     */
r_switch
c_cond
(paren
id|isr
op_amp
(paren
id|HD64465_PCCISR_PVS2
op_or
id|HD64465_PCCISR_PVS1
)paren
)paren
(brace
r_case
id|HD64465_PCCISR_PVS1
suffix:colon
id|printk
c_func
(paren
id|KERN_NOTICE
id|MODNAME
l_string|&quot;: cannot handle X.XV card, ignored&bslash;n&quot;
)paren
suffix:semicolon
id|status
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0
suffix:colon
r_case
id|HD64465_PCCISR_PVS2
suffix:colon
multiline_comment|/* 3.3V */
id|status
op_or_assign
id|SS_3VCARD
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HD64465_PCCISR_PVS2
op_or
id|HD64465_PCCISR_PVS1
suffix:colon
multiline_comment|/* 5V */
r_break
suffix:semicolon
)brace
multiline_comment|/* TODO: SS_POWERON */
multiline_comment|/* TODO: SS_STSCHG */
)brace
id|DPRINTK
c_func
(paren
l_string|&quot;hs_get_status(%d) = %x&bslash;n&quot;
comma
id|sock
comma
id|status
)paren
suffix:semicolon
op_star
id|value
op_assign
id|status
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*============================================================*/
DECL|function|hs_get_socket
r_static
r_int
id|hs_get_socket
c_func
(paren
r_int
r_int
id|sock
comma
id|socket_state_t
op_star
id|state
)paren
(brace
id|hs_socket_t
op_star
id|sp
op_assign
op_amp
id|hs_sockets
(braket
id|sock
)braket
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;hs_get_socket(%d)&bslash;n&quot;
comma
id|sock
)paren
suffix:semicolon
op_star
id|state
op_assign
id|sp-&gt;state
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*============================================================*/
DECL|function|hs_set_socket
r_static
r_int
id|hs_set_socket
c_func
(paren
r_int
r_int
id|sock
comma
id|socket_state_t
op_star
id|state
)paren
(brace
id|hs_socket_t
op_star
id|sp
op_assign
op_amp
id|hs_sockets
(braket
id|sock
)braket
suffix:semicolon
id|u_long
id|flags
suffix:semicolon
id|u_int
id|changed
suffix:semicolon
r_int
r_int
id|cscier
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;hs_set_socket(sock=%d, flags=%x, csc_mask=%x, Vcc=%d, Vpp=%d, io_irq=%d)&bslash;n&quot;
comma
id|sock
comma
id|state-&gt;flags
comma
id|state-&gt;csc_mask
comma
id|state-&gt;Vcc
comma
id|state-&gt;Vpp
comma
id|state-&gt;io_irq
)paren
suffix:semicolon
id|save_and_cli
c_func
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/* Don&squot;t want interrupts happening here */
r_if
c_cond
(paren
id|state-&gt;Vpp
op_ne
id|sp-&gt;state.Vpp
op_logical_or
id|state-&gt;Vcc
op_ne
id|sp-&gt;state.Vcc
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|hs_set_voltages
c_func
(paren
id|sp
comma
id|state-&gt;Vcc
comma
id|state-&gt;Vpp
)paren
)paren
(brace
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
multiline_comment|/*    &t;hd64465_io_debug = 1; */
multiline_comment|/*&n;&t; * Handle changes in the Card Status Change mask,&n;&t; * by propagating to the CSCR register&n;&t; */
id|changed
op_assign
id|sp-&gt;state.csc_mask
op_xor
id|state-&gt;csc_mask
suffix:semicolon
id|cscier
op_assign
id|hs_in
c_func
(paren
id|sp
comma
id|CSCIER
)paren
suffix:semicolon
r_if
c_cond
(paren
id|changed
op_amp
id|SS_DETECT
)paren
(brace
r_if
c_cond
(paren
id|state-&gt;csc_mask
op_amp
id|SS_DETECT
)paren
id|cscier
op_or_assign
id|HD64465_PCCCSCIER_PCDE
suffix:semicolon
r_else
id|cscier
op_and_assign
op_complement
id|HD64465_PCCCSCIER_PCDE
suffix:semicolon
)brace
r_if
c_cond
(paren
id|changed
op_amp
id|SS_READY
)paren
(brace
r_if
c_cond
(paren
id|state-&gt;csc_mask
op_amp
id|SS_READY
)paren
id|cscier
op_or_assign
id|HD64465_PCCCSCIER_PRE
suffix:semicolon
r_else
id|cscier
op_and_assign
op_complement
id|HD64465_PCCCSCIER_PRE
suffix:semicolon
)brace
r_if
c_cond
(paren
id|changed
op_amp
id|SS_BATDEAD
)paren
(brace
r_if
c_cond
(paren
id|state-&gt;csc_mask
op_amp
id|SS_BATDEAD
)paren
id|cscier
op_or_assign
id|HD64465_PCCCSCIER_PBDE
suffix:semicolon
r_else
id|cscier
op_and_assign
op_complement
id|HD64465_PCCCSCIER_PBDE
suffix:semicolon
)brace
r_if
c_cond
(paren
id|changed
op_amp
id|SS_BATWARN
)paren
(brace
r_if
c_cond
(paren
id|state-&gt;csc_mask
op_amp
id|SS_BATWARN
)paren
id|cscier
op_or_assign
id|HD64465_PCCCSCIER_PBWE
suffix:semicolon
r_else
id|cscier
op_and_assign
op_complement
id|HD64465_PCCCSCIER_PBWE
suffix:semicolon
)brace
r_if
c_cond
(paren
id|changed
op_amp
id|SS_STSCHG
)paren
(brace
r_if
c_cond
(paren
id|state-&gt;csc_mask
op_amp
id|SS_STSCHG
)paren
id|cscier
op_or_assign
id|HD64465_PCCCSCIER_PSCE
suffix:semicolon
r_else
id|cscier
op_and_assign
op_complement
id|HD64465_PCCCSCIER_PSCE
suffix:semicolon
)brace
id|hs_out
c_func
(paren
id|sp
comma
id|cscier
comma
id|CSCIER
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sp-&gt;state.io_irq
op_logical_and
op_logical_neg
id|state-&gt;io_irq
)paren
id|hs_unmap_irq
c_func
(paren
id|sp
comma
id|sp-&gt;state.io_irq
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|sp-&gt;state.io_irq
op_logical_and
id|state-&gt;io_irq
)paren
id|hs_map_irq
c_func
(paren
id|sp
comma
id|state-&gt;io_irq
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Handle changes in the flags field,&n;&t; * by propagating to config registers.&n;&t; */
id|changed
op_assign
id|sp-&gt;state.flags
op_xor
id|state-&gt;flags
suffix:semicolon
r_if
c_cond
(paren
id|changed
op_amp
id|SS_IOCARD
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;card type: %s&bslash;n&quot;
comma
(paren
id|state-&gt;flags
op_amp
id|SS_IOCARD
ques
c_cond
l_string|&quot;i/o&quot;
suffix:colon
l_string|&quot;memory&quot;
)paren
)paren
suffix:semicolon
id|bool_to_regbit
c_func
(paren
id|sp
comma
id|GCR
comma
id|HD64465_PCCGCR_PCCT
comma
id|state-&gt;flags
op_amp
id|SS_IOCARD
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|changed
op_amp
id|SS_RESET
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;%s reset card&bslash;n&quot;
comma
(paren
id|state-&gt;flags
op_amp
id|SS_RESET
ques
c_cond
l_string|&quot;start&quot;
suffix:colon
l_string|&quot;stop&quot;
)paren
)paren
suffix:semicolon
id|bool_to_regbit
c_func
(paren
id|sp
comma
id|GCR
comma
id|HD64465_PCCGCR_PCCR
comma
id|state-&gt;flags
op_amp
id|SS_RESET
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|changed
op_amp
id|SS_OUTPUT_ENA
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;%sabling card output&bslash;n&quot;
comma
(paren
id|state-&gt;flags
op_amp
id|SS_OUTPUT_ENA
ques
c_cond
l_string|&quot;en&quot;
suffix:colon
l_string|&quot;dis&quot;
)paren
)paren
suffix:semicolon
id|bool_to_regbit
c_func
(paren
id|sp
comma
id|GCR
comma
id|HD64465_PCCGCR_PDRV
comma
id|state-&gt;flags
op_amp
id|SS_OUTPUT_ENA
)paren
suffix:semicolon
)brace
multiline_comment|/* TODO: SS_SPKR_ENA */
multiline_comment|/*    &t;hd64465_io_debug = 0; */
id|sp-&gt;state
op_assign
op_star
id|state
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
macro_line|#if HD64465_DEBUG &gt; 10
r_if
c_cond
(paren
id|state-&gt;flags
op_amp
id|SS_OUTPUT_ENA
)paren
id|cis_hex_dump
c_func
(paren
(paren
r_const
r_int
r_char
op_star
)paren
id|sp-&gt;mem_base
comma
l_int|0x100
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*============================================================*/
DECL|function|hs_get_io_map
r_static
r_int
id|hs_get_io_map
c_func
(paren
r_int
r_int
id|sock
comma
r_struct
id|pccard_io_map
op_star
id|io
)paren
(brace
id|hs_socket_t
op_star
id|sp
op_assign
op_amp
id|hs_sockets
(braket
id|sock
)braket
suffix:semicolon
r_int
id|map
op_assign
id|io-&gt;map
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;hs_get_io_map(%d, %d)&bslash;n&quot;
comma
id|sock
comma
id|map
)paren
suffix:semicolon
r_if
c_cond
(paren
id|map
op_ge
id|MAX_IO_WIN
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
op_star
id|io
op_assign
id|sp-&gt;io_maps
(braket
id|map
)braket
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*============================================================*/
DECL|function|hs_set_io_map
r_static
r_int
id|hs_set_io_map
c_func
(paren
r_int
r_int
id|sock
comma
r_struct
id|pccard_io_map
op_star
id|io
)paren
(brace
id|hs_socket_t
op_star
id|sp
op_assign
op_amp
id|hs_sockets
(braket
id|sock
)braket
suffix:semicolon
r_int
id|map
op_assign
id|io-&gt;map
suffix:semicolon
r_struct
id|pccard_io_map
op_star
id|sio
suffix:semicolon
id|pgprot_t
id|prot
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;hs_set_io_map(sock=%d, map=%d, flags=0x%x, speed=%dns, start=0x%04x, stop=0x%04x)&bslash;n&quot;
comma
id|sock
comma
id|map
comma
id|io-&gt;flags
comma
id|io-&gt;speed
comma
id|io-&gt;start
comma
id|io-&gt;stop
)paren
suffix:semicolon
r_if
c_cond
(paren
id|map
op_ge
id|MAX_IO_WIN
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|sio
op_assign
op_amp
id|sp-&gt;io_maps
(braket
id|map
)braket
suffix:semicolon
multiline_comment|/* check for null changes */
r_if
c_cond
(paren
id|io-&gt;flags
op_eq
id|sio-&gt;flags
op_logical_and
id|io-&gt;start
op_eq
id|sio-&gt;start
op_logical_and
id|io-&gt;stop
op_eq
id|sio-&gt;stop
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|io-&gt;flags
op_amp
id|MAP_AUTOSZ
)paren
id|prot
op_assign
id|PAGE_KERNEL_PCC
c_func
(paren
id|sock
comma
id|_PAGE_PCC_IODYN
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|io-&gt;flags
op_amp
id|MAP_16BIT
)paren
id|prot
op_assign
id|PAGE_KERNEL_PCC
c_func
(paren
id|sock
comma
id|_PAGE_PCC_IO16
)paren
suffix:semicolon
r_else
id|prot
op_assign
id|PAGE_KERNEL_PCC
c_func
(paren
id|sock
comma
id|_PAGE_PCC_IO8
)paren
suffix:semicolon
multiline_comment|/* TODO: handle MAP_USE_WAIT */
r_if
c_cond
(paren
id|io-&gt;flags
op_amp
id|MAP_USE_WAIT
)paren
id|printk
c_func
(paren
id|KERN_INFO
id|MODNAME
l_string|&quot;: MAP_USE_WAIT unimplemented&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* TODO: handle MAP_PREFETCH */
r_if
c_cond
(paren
id|io-&gt;flags
op_amp
id|MAP_PREFETCH
)paren
id|printk
c_func
(paren
id|KERN_INFO
id|MODNAME
l_string|&quot;: MAP_PREFETCH unimplemented&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* TODO: handle MAP_WRPROT */
r_if
c_cond
(paren
id|io-&gt;flags
op_amp
id|MAP_WRPROT
)paren
id|printk
c_func
(paren
id|KERN_INFO
id|MODNAME
l_string|&quot;: MAP_WRPROT unimplemented&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* TODO: handle MAP_0WS */
r_if
c_cond
(paren
id|io-&gt;flags
op_amp
id|MAP_0WS
)paren
id|printk
c_func
(paren
id|KERN_INFO
id|MODNAME
l_string|&quot;: MAP_0WS unimplemented&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|io-&gt;flags
op_amp
id|MAP_ACTIVE
)paren
(brace
r_int
r_int
id|pstart
comma
id|psize
comma
id|paddrbase
comma
id|vaddrbase
suffix:semicolon
id|paddrbase
op_assign
id|virt_to_phys
c_func
(paren
(paren
r_void
op_star
)paren
(paren
id|sp-&gt;mem_base
op_plus
l_int|2
op_star
id|HD64465_PCC_WINDOW
)paren
)paren
suffix:semicolon
id|vaddrbase
op_assign
(paren
r_int
r_int
)paren
id|sp-&gt;io_vma-&gt;addr
suffix:semicolon
id|pstart
op_assign
id|io-&gt;start
op_amp
id|PAGE_MASK
suffix:semicolon
id|psize
op_assign
(paren
(paren
id|io-&gt;stop
op_plus
id|PAGE_SIZE
)paren
op_amp
id|PAGE_MASK
)paren
op_minus
id|pstart
suffix:semicolon
multiline_comment|/*&n;&t;     * Change PTEs in only that portion of the mapping requested&n;&t;     * by the caller.  This means that most of the time, most of&n;&t;     * the PTEs in the io_vma will be unmapped and only the bottom&n;&t;     * page will be mapped.  But the code allows for weird cards&n;&t;     * that might want IO ports &gt; 4K.&n;&t;     */
id|DPRINTK
c_func
(paren
l_string|&quot;remap_page_range(vaddr=0x%08lx, paddr=0x%08lx, size=0x%08lxx)&bslash;n&quot;
comma
id|vaddrbase
op_plus
id|pstart
comma
id|paddrbase
op_plus
id|pstart
comma
id|psize
)paren
suffix:semicolon
id|remap_page_range
c_func
(paren
id|vaddrbase
op_plus
id|pstart
comma
id|paddrbase
op_plus
id|pstart
comma
id|psize
comma
id|prot
)paren
suffix:semicolon
multiline_comment|/*&n;&t;     * Change the mapping used by inb() outb() etc&n;&t;     */
id|hd64465_port_map
c_func
(paren
id|io-&gt;start
comma
id|io-&gt;stop
op_minus
id|io-&gt;start
op_plus
l_int|1
comma
id|vaddrbase
op_plus
id|io-&gt;start
)paren
suffix:semicolon
)brace
r_else
(brace
id|hd64465_port_unmap
c_func
(paren
id|sio-&gt;start
comma
id|sio-&gt;stop
op_minus
id|sio-&gt;start
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* TODO: remap_page_range() to mark pages not present ? */
)brace
op_star
id|sio
op_assign
op_star
id|io
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*============================================================*/
DECL|function|hs_get_mem_map
r_static
r_int
id|hs_get_mem_map
c_func
(paren
r_int
r_int
id|sock
comma
r_struct
id|pccard_mem_map
op_star
id|mem
)paren
(brace
id|hs_socket_t
op_star
id|sp
op_assign
op_amp
id|hs_sockets
(braket
id|sock
)braket
suffix:semicolon
r_int
id|map
op_assign
id|mem-&gt;map
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;hs_get_mem_map(%d, %d)&bslash;n&quot;
comma
id|sock
comma
id|map
)paren
suffix:semicolon
r_if
c_cond
(paren
id|map
op_ge
id|MAX_WIN
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
op_star
id|mem
op_assign
id|sp-&gt;mem_maps
(braket
id|map
)braket
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*============================================================*/
DECL|function|hs_set_mem_map
r_static
r_int
id|hs_set_mem_map
c_func
(paren
r_int
r_int
id|sock
comma
r_struct
id|pccard_mem_map
op_star
id|mem
)paren
(brace
id|hs_socket_t
op_star
id|sp
op_assign
op_amp
id|hs_sockets
(braket
id|sock
)braket
suffix:semicolon
r_struct
id|pccard_mem_map
op_star
id|smem
suffix:semicolon
r_int
id|map
op_assign
id|mem-&gt;map
suffix:semicolon
r_int
r_int
id|paddr
comma
id|size
suffix:semicolon
macro_line|#if 0
id|DPRINTK
c_func
(paren
l_string|&quot;hs_set_mem_map(sock=%d, map=%d, flags=0x%x, sys_start=0x%08lx, sys_end=0x%08lx, card_start=0x%08x)&bslash;n&quot;
comma
id|sock
comma
id|map
comma
id|mem-&gt;flags
comma
id|mem-&gt;sys_start
comma
id|mem-&gt;sys_stop
comma
id|mem-&gt;card_start
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|map
op_ge
id|MAX_WIN
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|smem
op_assign
op_amp
id|sp-&gt;mem_maps
(braket
id|map
)braket
suffix:semicolon
id|size
op_assign
id|mem-&gt;sys_stop
op_minus
id|mem-&gt;sys_start
op_plus
l_int|1
suffix:semicolon
id|paddr
op_assign
id|sp-&gt;mem_base
suffix:semicolon
multiline_comment|/* base of Attribute mapping */
r_if
c_cond
(paren
op_logical_neg
(paren
id|mem-&gt;flags
op_amp
id|MAP_ATTRIB
)paren
)paren
id|paddr
op_add_assign
id|HD64465_PCC_WINDOW
suffix:semicolon
multiline_comment|/* base of Common mapping */
id|paddr
op_add_assign
id|mem-&gt;card_start
suffix:semicolon
multiline_comment|/* Because we specified SS_CAP_STATIC_MAP, we are obliged&n;&t; * at this time to report the system address corresponding&n;&t; * to the card address requested.  This is how Socket Services&n;&t; * queries our fixed mapping.  I wish this fact had been&n;&t; * documented - Greg Banks.&n;&t; */
id|mem-&gt;sys_start
op_assign
id|paddr
suffix:semicolon
id|mem-&gt;sys_stop
op_assign
id|paddr
op_plus
id|size
op_minus
l_int|1
suffix:semicolon
op_star
id|smem
op_assign
op_star
id|mem
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* TODO: do we need to use the MMU to access Common memory ??? */
multiline_comment|/*============================================================*/
DECL|function|hs_proc_setup
r_static
r_void
id|hs_proc_setup
c_func
(paren
r_int
r_int
id|sock
comma
r_struct
id|proc_dir_entry
op_star
id|base
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;hs_proc_setup(%d)&bslash;n&quot;
comma
id|sock
)paren
suffix:semicolon
)brace
multiline_comment|/*============================================================*/
multiline_comment|/*&n; * This function is registered with the HD64465 glue code to do a&n; * secondary demux step on the PCMCIA interrupts.  It handles &n; * mapping the IREQ request from the card to a standard Linux&n; * IRQ, as requested by SocketServices.&n; */
DECL|function|hs_irq_demux
r_static
r_int
id|hs_irq_demux
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev
)paren
(brace
id|hs_socket_t
op_star
id|sp
op_assign
(paren
id|hs_socket_t
op_star
)paren
id|dev
suffix:semicolon
id|u_int
id|cscr
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;hs_irq_demux(irq=%d)&bslash;n&quot;
comma
id|irq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sp-&gt;state.io_irq
op_logical_and
(paren
id|cscr
op_assign
id|hs_in
c_func
(paren
id|sp
comma
id|CSCR
)paren
)paren
op_amp
id|HD64465_PCCCSCR_PIREQ
)paren
(brace
id|cscr
op_and_assign
op_complement
id|HD64465_PCCCSCR_PIREQ
suffix:semicolon
id|hs_out
c_func
(paren
id|sp
comma
id|cscr
comma
id|CSCR
)paren
suffix:semicolon
r_return
id|sp-&gt;state.io_irq
suffix:semicolon
)brace
r_return
id|irq
suffix:semicolon
)brace
multiline_comment|/*============================================================*/
multiline_comment|/*&n; * Interrupt handling routine.&n; *&n; * This uses the schedule_task() technique to cause reportable events&n; * such as card insertion and removal to be handled in keventd&squot;s&n; * process context.&n; */
DECL|function|hs_events_bh
r_static
r_void
id|hs_events_bh
c_func
(paren
r_void
op_star
id|dummy
)paren
(brace
id|hs_socket_t
op_star
id|sp
suffix:semicolon
id|u_int
id|events
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|HS_MAX_SOCKETS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|sp
op_assign
op_amp
id|hs_sockets
(braket
id|i
)braket
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|hs_pending_event_lock
)paren
suffix:semicolon
id|events
op_assign
id|sp-&gt;pending_events
suffix:semicolon
id|sp-&gt;pending_events
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|hs_pending_event_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sp-&gt;handler
)paren
id|sp
op_member_access_from_pointer
id|handler
c_func
(paren
id|sp-&gt;handler_info
comma
id|events
)paren
suffix:semicolon
)brace
)brace
DECL|variable|hs_events_task
r_static
r_struct
id|tq_struct
id|hs_events_task
op_assign
(brace
id|routine
suffix:colon
id|hs_events_bh
)brace
suffix:semicolon
DECL|function|hs_interrupt
r_static
r_void
id|hs_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
id|hs_socket_t
op_star
id|sp
op_assign
(paren
id|hs_socket_t
op_star
)paren
id|dev
suffix:semicolon
id|u_int
id|events
op_assign
l_int|0
suffix:semicolon
id|u_int
id|cscr
suffix:semicolon
id|cscr
op_assign
id|hs_in
c_func
(paren
id|sp
comma
id|CSCR
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;hs_interrupt, cscr=%04x&bslash;n&quot;
comma
id|cscr
)paren
suffix:semicolon
multiline_comment|/* check for bus-related changes to be reported to Socket Services */
r_if
c_cond
(paren
id|cscr
op_amp
id|HD64465_PCCCSCR_PCDC
)paren
(brace
multiline_comment|/* double-check for a 16-bit card, as we don&squot;t support CardBus */
r_if
c_cond
(paren
(paren
id|hs_in
c_func
(paren
id|sp
comma
id|ISR
)paren
op_amp
id|HD64465_PCCISR_PCD_MASK
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
id|MODNAME
l_string|&quot;: socket %d, card not a supported card type or not inserted correctly&bslash;n&quot;
comma
id|hs_sockno
c_func
(paren
id|sp
)paren
)paren
suffix:semicolon
multiline_comment|/* Don&squot;t do the rest unless a card is present */
id|cscr
op_and_assign
op_complement
(paren
id|HD64465_PCCCSCR_PCDC
op_or
id|HD64465_PCCCSCR_PRC
op_or
id|HD64465_PCCCSCR_PBW
op_or
id|HD64465_PCCCSCR_PBD
op_or
id|HD64465_PCCCSCR_PSC
)paren
suffix:semicolon
)brace
r_else
(brace
id|cscr
op_and_assign
op_complement
id|HD64465_PCCCSCR_PCDC
suffix:semicolon
id|events
op_or_assign
id|SS_DETECT
suffix:semicolon
multiline_comment|/* card insertion or removal */
)brace
)brace
r_if
c_cond
(paren
id|cscr
op_amp
id|HD64465_PCCCSCR_PRC
)paren
(brace
id|cscr
op_and_assign
op_complement
id|HD64465_PCCCSCR_PRC
suffix:semicolon
id|events
op_or_assign
id|SS_READY
suffix:semicolon
multiline_comment|/* ready signal changed */
)brace
r_if
c_cond
(paren
id|cscr
op_amp
id|HD64465_PCCCSCR_PBW
)paren
(brace
id|cscr
op_and_assign
op_complement
id|HD64465_PCCCSCR_PSC
suffix:semicolon
id|events
op_or_assign
id|SS_BATWARN
suffix:semicolon
multiline_comment|/* battery warning */
)brace
r_if
c_cond
(paren
id|cscr
op_amp
id|HD64465_PCCCSCR_PBD
)paren
(brace
id|cscr
op_and_assign
op_complement
id|HD64465_PCCCSCR_PSC
suffix:semicolon
id|events
op_or_assign
id|SS_BATDEAD
suffix:semicolon
multiline_comment|/* battery dead */
)brace
r_if
c_cond
(paren
id|cscr
op_amp
id|HD64465_PCCCSCR_PSC
)paren
(brace
id|cscr
op_and_assign
op_complement
id|HD64465_PCCCSCR_PSC
suffix:semicolon
id|events
op_or_assign
id|SS_STSCHG
suffix:semicolon
multiline_comment|/* STSCHG (status changed) signal */
)brace
r_if
c_cond
(paren
id|cscr
op_amp
id|HD64465_PCCCSCR_PIREQ
)paren
(brace
id|cscr
op_and_assign
op_complement
id|HD64465_PCCCSCR_PIREQ
suffix:semicolon
multiline_comment|/* This should have been dealt with during irq demux */
id|printk
c_func
(paren
id|KERN_NOTICE
id|MODNAME
l_string|&quot;: unexpected IREQ from card&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|hs_out
c_func
(paren
id|sp
comma
id|cscr
comma
id|CSCR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|events
)paren
(brace
multiline_comment|/*&n;    &t;     * Arrange for events to be reported to the registered&n;&t;     * event handler function (from CardServices) in a process&n;&t;     * context (keventd) &quot;soon&quot;.&n;&t;     */
id|spin_lock
c_func
(paren
op_amp
id|hs_pending_event_lock
)paren
suffix:semicolon
id|sp-&gt;pending_events
op_or_assign
id|events
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|hs_pending_event_lock
)paren
suffix:semicolon
id|schedule_task
c_func
(paren
op_amp
id|hs_events_task
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*============================================================*/
DECL|variable|hs_operations
r_static
r_struct
id|pccard_operations
id|hs_operations
op_assign
(brace
id|hs_init
comma
id|hs_suspend
comma
id|hs_register_callback
comma
id|hs_inquire_socket
comma
id|hs_get_status
comma
id|hs_get_socket
comma
id|hs_set_socket
comma
id|hs_get_io_map
comma
id|hs_set_io_map
comma
id|hs_get_mem_map
comma
id|hs_set_mem_map
comma
id|hs_proc_setup
)brace
suffix:semicolon
DECL|function|hs_init_socket
r_static
r_int
id|hs_init_socket
c_func
(paren
id|hs_socket_t
op_star
id|sp
comma
r_int
id|irq
comma
r_int
r_int
id|mem_base
comma
r_int
r_int
id|ctrl_base
)paren
(brace
r_int
r_int
id|v
suffix:semicolon
r_int
id|i
comma
id|err
suffix:semicolon
id|memset
c_func
(paren
id|sp
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|sp
)paren
)paren
suffix:semicolon
id|sp-&gt;irq
op_assign
id|irq
suffix:semicolon
id|sp-&gt;mem_base
op_assign
id|mem_base
suffix:semicolon
id|sp-&gt;mem_length
op_assign
l_int|4
op_star
id|HD64465_PCC_WINDOW
suffix:semicolon
multiline_comment|/* 16MB */
id|sp-&gt;ctrl_base
op_assign
id|ctrl_base
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_IO_WIN
suffix:semicolon
id|i
op_increment
)paren
id|sp-&gt;io_maps
(braket
id|i
)braket
dot
id|map
op_assign
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_WIN
suffix:semicolon
id|i
op_increment
)paren
id|sp-&gt;mem_maps
(braket
id|i
)braket
dot
id|map
op_assign
id|i
suffix:semicolon
r_if
c_cond
(paren
(paren
id|sp-&gt;io_vma
op_assign
id|get_vm_area
c_func
(paren
id|HS_IO_MAP_SIZE
comma
id|VM_IOREMAP
)paren
)paren
op_eq
l_int|0
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|hd64465_register_irq_demux
c_func
(paren
id|sp-&gt;irq
comma
id|hs_irq_demux
comma
id|sp
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|request_irq
c_func
(paren
id|sp-&gt;irq
comma
id|hs_interrupt
comma
id|SA_INTERRUPT
comma
id|MODNAME
comma
id|sp
)paren
)paren
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
r_if
c_cond
(paren
id|request_mem_region
c_func
(paren
id|sp-&gt;mem_base
comma
id|sp-&gt;mem_length
comma
id|MODNAME
)paren
op_eq
l_int|0
)paren
(brace
id|sp-&gt;mem_base
op_assign
l_int|0
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/* According to section 3.2 of the PCMCIA standard, low-voltage&n;&t; * capable cards must implement cold insertion, i.e. Vpp and&n;&t; * Vcc set to 0 before card is inserted.&n;&t; */
multiline_comment|/*hs_set_voltages(sp, 0, 0);*/
multiline_comment|/* hi-Z the outputs to the card and set 16MB map mode */
id|v
op_assign
id|hs_in
c_func
(paren
id|sp
comma
id|GCR
)paren
suffix:semicolon
id|v
op_and_assign
op_complement
id|HD64465_PCCGCR_PCCT
suffix:semicolon
multiline_comment|/* memory-only card */
id|hs_out
c_func
(paren
id|sp
comma
id|v
comma
id|GCR
)paren
suffix:semicolon
id|v
op_assign
id|hs_in
c_func
(paren
id|sp
comma
id|GCR
)paren
suffix:semicolon
id|v
op_or_assign
id|HD64465_PCCGCR_PDRV
suffix:semicolon
multiline_comment|/* enable outputs to card */
id|hs_out
c_func
(paren
id|sp
comma
id|v
comma
id|GCR
)paren
suffix:semicolon
id|v
op_assign
id|hs_in
c_func
(paren
id|sp
comma
id|GCR
)paren
suffix:semicolon
id|v
op_or_assign
id|HD64465_PCCGCR_PMMOD
suffix:semicolon
multiline_comment|/* 16MB mapping mode */
id|hs_out
c_func
(paren
id|sp
comma
id|v
comma
id|GCR
)paren
suffix:semicolon
id|v
op_assign
id|hs_in
c_func
(paren
id|sp
comma
id|GCR
)paren
suffix:semicolon
multiline_comment|/* lowest 16MB of Common */
id|v
op_and_assign
op_complement
(paren
id|HD64465_PCCGCR_PPA25
op_or
id|HD64465_PCCGCR_PPA24
)paren
suffix:semicolon
id|hs_out
c_func
(paren
id|sp
comma
id|v
comma
id|GCR
)paren
suffix:semicolon
id|hs_reset_socket
c_func
(paren
id|sp
comma
l_int|1
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|hs_exit_socket
r_static
r_void
id|hs_exit_socket
c_func
(paren
id|hs_socket_t
op_star
id|sp
)paren
(brace
r_int
r_int
id|cscier
comma
id|gcr
suffix:semicolon
multiline_comment|/* turn off interrupts in hardware */
id|cscier
op_assign
id|hs_in
c_func
(paren
id|sp
comma
id|CSCIER
)paren
suffix:semicolon
id|cscier
op_assign
(paren
id|cscier
op_amp
id|IER_MASK
)paren
op_or
id|IER_OFF
suffix:semicolon
id|hs_out
c_func
(paren
id|sp
comma
id|cscier
comma
id|CSCIER
)paren
suffix:semicolon
multiline_comment|/* hi-Z the outputs to the card */
id|gcr
op_assign
id|hs_in
c_func
(paren
id|sp
comma
id|GCR
)paren
suffix:semicolon
id|gcr
op_and_assign
id|HD64465_PCCGCR_PDRV
suffix:semicolon
id|hs_out
c_func
(paren
id|sp
comma
id|gcr
comma
id|GCR
)paren
suffix:semicolon
multiline_comment|/* power the card down */
id|hs_set_voltages
c_func
(paren
id|sp
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sp-&gt;mem_base
op_ne
l_int|0
)paren
id|release_mem_region
c_func
(paren
id|sp-&gt;mem_base
comma
id|sp-&gt;mem_length
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sp-&gt;irq
op_ne
l_int|0
)paren
(brace
id|free_irq
c_func
(paren
id|sp-&gt;irq
comma
id|hs_interrupt
)paren
suffix:semicolon
id|hd64465_unregister_irq_demux
c_func
(paren
id|sp-&gt;irq
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sp-&gt;io_vma
op_ne
l_int|0
)paren
id|vfree
c_func
(paren
id|sp-&gt;io_vma-&gt;addr
)paren
suffix:semicolon
)brace
DECL|function|init_hs
r_static
r_int
id|__init
id|init_hs
c_func
(paren
r_void
)paren
(brace
id|servinfo_t
id|serv
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
r_int
id|v
suffix:semicolon
multiline_comment|/*&n;&t; * Check API version&n;&t; */
id|pcmcia_get_card_services_info
c_func
(paren
op_amp
id|serv
)paren
suffix:semicolon
r_if
c_cond
(paren
id|serv.Revision
op_ne
id|CS_RELEASE_CODE
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
id|MODNAME
l_string|&quot;: Card Services release does not match!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
multiline_comment|/*&t;hd64465_io_debug = 1; */
multiline_comment|/* Wake both sockets out of STANDBY mode */
multiline_comment|/* TODO: wait 15ms */
id|v
op_assign
id|inw
c_func
(paren
id|HD64465_REG_SMSCR
)paren
suffix:semicolon
id|v
op_and_assign
op_complement
(paren
id|HD64465_SMSCR_PC0ST
op_or
id|HD64465_SMSCR_PC1ST
)paren
suffix:semicolon
id|outw
c_func
(paren
id|v
comma
id|HD64465_REG_SMSCR
)paren
suffix:semicolon
multiline_comment|/* keep power controller out of shutdown mode */
id|v
op_assign
id|inb
c_func
(paren
id|HD64465_REG_PCC0SCR
)paren
suffix:semicolon
id|v
op_or_assign
id|HD64465_PCCSCR_SHDN
suffix:semicolon
id|outb
c_func
(paren
id|v
comma
id|HD64465_REG_PCC0SCR
)paren
suffix:semicolon
multiline_comment|/* use serial (TPS2206) power controller */
id|v
op_assign
id|inb
c_func
(paren
id|HD64465_REG_PCC0CSCR
)paren
suffix:semicolon
id|v
op_or_assign
id|HD64465_PCCCSCR_PSWSEL
suffix:semicolon
id|outb
c_func
(paren
id|v
comma
id|HD64465_REG_PCC0CSCR
)paren
suffix:semicolon
id|hs_set_voltages
c_func
(paren
op_amp
id|hs_sockets
(braket
l_int|0
)braket
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|hs_set_voltages
c_func
(paren
op_amp
id|hs_sockets
(braket
l_int|1
)braket
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Setup hs_sockets[] structures and request system resources.&n;&t; * TODO: on memory allocation failure, power down the socket&n;&t; *       before quitting.&n;&t; */
id|i
op_assign
id|hs_init_socket
c_func
(paren
op_amp
id|hs_sockets
(braket
l_int|0
)braket
comma
id|HD64465_IRQ_PCMCIA0
comma
id|HD64465_PCC0_BASE
comma
id|HD64465_REG_PCC0ISR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
r_return
id|i
suffix:semicolon
id|i
op_assign
id|hs_init_socket
c_func
(paren
op_amp
id|hs_sockets
(braket
l_int|1
)braket
comma
id|HD64465_IRQ_PCMCIA1
comma
id|HD64465_PCC1_BASE
comma
id|HD64465_REG_PCC1ISR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
l_int|0
)paren
r_return
id|i
suffix:semicolon
multiline_comment|/*&t;hd64465_io_debug = 0; */
r_if
c_cond
(paren
id|register_ss_entry
c_func
(paren
id|HS_MAX_SOCKETS
comma
op_amp
id|hs_operations
)paren
op_ne
l_int|0
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|HS_MAX_SOCKETS
suffix:semicolon
id|i
op_increment
)paren
id|hs_exit_socket
c_func
(paren
op_amp
id|hs_sockets
(braket
id|i
)braket
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;HD64465 PCMCIA bridge:&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|HS_MAX_SOCKETS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|hs_socket_t
op_star
id|sp
op_assign
op_amp
id|hs_sockets
(braket
id|i
)braket
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;  socket %d at 0x%08lx irq %d io window %ldK@0x%08lx&bslash;n&quot;
comma
id|i
comma
id|sp-&gt;mem_base
comma
id|sp-&gt;irq
comma
id|sp-&gt;io_vma-&gt;size
op_rshift
l_int|10
comma
(paren
r_int
r_int
)paren
id|sp-&gt;io_vma-&gt;addr
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|exit_hs
r_static
r_void
id|__exit
id|exit_hs
c_func
(paren
r_void
)paren
(brace
id|u_long
id|flags
suffix:semicolon
r_int
id|i
suffix:semicolon
id|save_and_cli
c_func
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Release kernel resources&n;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|HS_MAX_SOCKETS
suffix:semicolon
id|i
op_increment
)paren
id|hs_exit_socket
c_func
(paren
op_amp
id|hs_sockets
(braket
id|i
)braket
)paren
suffix:semicolon
id|unregister_ss_entry
c_func
(paren
op_amp
id|hs_operations
)paren
suffix:semicolon
id|restore_flags
c_func
(paren
id|flags
)paren
suffix:semicolon
)brace
DECL|variable|init_hs
id|module_init
c_func
(paren
id|init_hs
)paren
suffix:semicolon
DECL|variable|exit_hs
id|module_exit
c_func
(paren
id|exit_hs
)paren
suffix:semicolon
multiline_comment|/*============================================================*/
multiline_comment|/*END*/
eof
