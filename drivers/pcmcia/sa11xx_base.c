multiline_comment|/*======================================================================&n;&n;    Device driver for the PCMCIA control functionality of StrongARM&n;    SA-1100 microprocessors.&n;&n;    The contents of this file are subject to the Mozilla Public&n;    License Version 1.1 (the &quot;License&quot;); you may not use this file&n;    except in compliance with the License. You may obtain a copy of&n;    the License at http://www.mozilla.org/MPL/&n;&n;    Software distributed under the License is distributed on an &quot;AS&n;    IS&quot; basis, WITHOUT WARRANTY OF ANY KIND, either express or&n;    implied. See the License for the specific language governing&n;    rights and limitations under the License.&n;&n;    The initial developer of the original code is John G. Dorsey&n;    &lt;john+@cs.cmu.edu&gt;.  Portions created by John G. Dorsey are&n;    Copyright (C) 1999 John G. Dorsey.  All Rights Reserved.&n;&n;    Alternatively, the contents of this file may be used under the&n;    terms of the GNU Public License version 2 (the &quot;GPL&quot;), in which&n;    case the provisions of the GPL are applicable instead of the&n;    above.  If you wish to allow the use of your version of this file&n;    only under the terms of the GPL and not to allow others to use&n;    your version of this file under the MPL, indicate your decision&n;    by deleting the provisions above and replace them with the notice&n;    and other provisions required by the GPL.  If you do not delete&n;    the provisions above, a recipient may use your version of this&n;    file under either the MPL or the GPL.&n;&n;======================================================================*/
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/cpufreq.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/notifier.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;asm/hardware.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/irq.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &quot;soc_common.h&quot;
macro_line|#include &quot;sa11xx_base.h&quot;
multiline_comment|/*&n; * sa1100_pcmcia_default_mecr_timing&n; * ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^&n; *&n; * Calculate MECR clock wait states for given CPU clock&n; * speed and command wait state. This function can be over-&n; * written by a board specific version.&n; *&n; * The default is to simply calculate the BS values as specified in&n; * the INTEL SA1100 development manual&n; * &quot;Expansion Memory (PCMCIA) Configuration Register (MECR)&quot;&n; * that&squot;s section 10.2.5 in _my_ version of the manual ;)&n; */
r_static
r_int
r_int
DECL|function|sa1100_pcmcia_default_mecr_timing
id|sa1100_pcmcia_default_mecr_timing
c_func
(paren
r_struct
id|soc_pcmcia_socket
op_star
id|skt
comma
r_int
r_int
id|cpu_speed
comma
r_int
r_int
id|cmd_time
)paren
(brace
r_return
id|sa1100_pcmcia_mecr_bs
c_func
(paren
id|cmd_time
comma
id|cpu_speed
)paren
suffix:semicolon
)brace
multiline_comment|/* sa1100_pcmcia_set_mecr()&n; * ^^^^^^^^^^^^^^^^^^^^^^^^&n; *&n; * set MECR value for socket &lt;sock&gt; based on this sockets&n; * io, mem and attribute space access speed.&n; * Call board specific BS value calculation to allow boards&n; * to tweak the BS values.&n; */
r_static
r_int
DECL|function|sa1100_pcmcia_set_mecr
id|sa1100_pcmcia_set_mecr
c_func
(paren
r_struct
id|soc_pcmcia_socket
op_star
id|skt
comma
r_int
r_int
id|cpu_clock
)paren
(brace
r_struct
id|soc_pcmcia_timing
id|timing
suffix:semicolon
id|u32
id|mecr
comma
id|old_mecr
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_int
r_int
id|bs_io
comma
id|bs_mem
comma
id|bs_attr
suffix:semicolon
id|soc_common_pcmcia_get_timing
c_func
(paren
id|skt
comma
op_amp
id|timing
)paren
suffix:semicolon
id|bs_io
op_assign
id|skt-&gt;ops
op_member_access_from_pointer
id|get_timing
c_func
(paren
id|skt
comma
id|cpu_clock
comma
id|timing.io
)paren
suffix:semicolon
id|bs_mem
op_assign
id|skt-&gt;ops
op_member_access_from_pointer
id|get_timing
c_func
(paren
id|skt
comma
id|cpu_clock
comma
id|timing.mem
)paren
suffix:semicolon
id|bs_attr
op_assign
id|skt-&gt;ops
op_member_access_from_pointer
id|get_timing
c_func
(paren
id|skt
comma
id|cpu_clock
comma
id|timing.attr
)paren
suffix:semicolon
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
id|old_mecr
op_assign
id|mecr
op_assign
id|MECR
suffix:semicolon
id|MECR_FAST_SET
c_func
(paren
id|mecr
comma
id|skt-&gt;nr
comma
l_int|0
)paren
suffix:semicolon
id|MECR_BSIO_SET
c_func
(paren
id|mecr
comma
id|skt-&gt;nr
comma
id|bs_io
)paren
suffix:semicolon
id|MECR_BSA_SET
c_func
(paren
id|mecr
comma
id|skt-&gt;nr
comma
id|bs_attr
)paren
suffix:semicolon
id|MECR_BSM_SET
c_func
(paren
id|mecr
comma
id|skt-&gt;nr
comma
id|bs_mem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|old_mecr
op_ne
id|mecr
)paren
id|MECR
op_assign
id|mecr
suffix:semicolon
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
id|debug
c_func
(paren
id|skt
comma
l_int|2
comma
l_string|&quot;FAST %X  BSM %X  BSA %X  BSIO %X&bslash;n&quot;
comma
id|MECR_FAST_GET
c_func
(paren
id|mecr
comma
id|skt-&gt;nr
)paren
comma
id|MECR_BSM_GET
c_func
(paren
id|mecr
comma
id|skt-&gt;nr
)paren
comma
id|MECR_BSA_GET
c_func
(paren
id|mecr
comma
id|skt-&gt;nr
)paren
comma
id|MECR_BSIO_GET
c_func
(paren
id|mecr
comma
id|skt-&gt;nr
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|sa1100_pcmcia_set_timing
id|sa1100_pcmcia_set_timing
c_func
(paren
r_struct
id|soc_pcmcia_socket
op_star
id|skt
)paren
(brace
r_return
id|sa1100_pcmcia_set_mecr
c_func
(paren
id|skt
comma
id|cpufreq_get
c_func
(paren
l_int|0
)paren
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|sa1100_pcmcia_show_timing
id|sa1100_pcmcia_show_timing
c_func
(paren
r_struct
id|soc_pcmcia_socket
op_star
id|skt
comma
r_char
op_star
id|buf
)paren
(brace
r_struct
id|soc_pcmcia_timing
id|timing
suffix:semicolon
r_int
r_int
id|clock
op_assign
id|cpufreq_get
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_int
r_int
id|mecr
op_assign
id|MECR
suffix:semicolon
r_char
op_star
id|p
op_assign
id|buf
suffix:semicolon
id|soc_common_pcmcia_get_timing
c_func
(paren
id|skt
comma
op_amp
id|timing
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;I/O      : %u (%u)&bslash;n&quot;
comma
id|timing.io
comma
id|sa1100_pcmcia_cmd_time
c_func
(paren
id|clock
comma
id|MECR_BSIO_GET
c_func
(paren
id|mecr
comma
id|skt-&gt;nr
)paren
)paren
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;attribute: %u (%u)&bslash;n&quot;
comma
id|timing.attr
comma
id|sa1100_pcmcia_cmd_time
c_func
(paren
id|clock
comma
id|MECR_BSA_GET
c_func
(paren
id|mecr
comma
id|skt-&gt;nr
)paren
)paren
)paren
suffix:semicolon
id|p
op_add_assign
id|sprintf
c_func
(paren
id|p
comma
l_string|&quot;common   : %u (%u)&bslash;n&quot;
comma
id|timing.mem
comma
id|sa1100_pcmcia_cmd_time
c_func
(paren
id|clock
comma
id|MECR_BSM_GET
c_func
(paren
id|mecr
comma
id|skt-&gt;nr
)paren
)paren
)paren
suffix:semicolon
r_return
id|p
op_minus
id|buf
suffix:semicolon
)brace
DECL|function|sa11xx_drv_pcmcia_probe
r_int
id|sa11xx_drv_pcmcia_probe
c_func
(paren
r_struct
id|device
op_star
id|dev
comma
r_struct
id|pcmcia_low_level
op_star
id|ops
comma
r_int
id|first
comma
r_int
id|nr
)paren
(brace
multiline_comment|/*&n;&t; * set default MECR calculation if the board specific&n;&t; * code did not specify one...&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|ops-&gt;get_timing
)paren
id|ops-&gt;get_timing
op_assign
id|sa1100_pcmcia_default_mecr_timing
suffix:semicolon
multiline_comment|/* Provide our SA11x0 specific timing routines. */
id|ops-&gt;set_timing
op_assign
id|sa1100_pcmcia_set_timing
suffix:semicolon
id|ops-&gt;show_timing
op_assign
id|sa1100_pcmcia_show_timing
suffix:semicolon
r_return
id|soc_common_drv_pcmcia_probe
c_func
(paren
id|dev
comma
id|ops
comma
id|first
comma
id|nr
)paren
suffix:semicolon
)brace
DECL|variable|sa11xx_drv_pcmcia_probe
id|EXPORT_SYMBOL
c_func
(paren
id|sa11xx_drv_pcmcia_probe
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_CPU_FREQ
multiline_comment|/* sa1100_pcmcia_update_mecr()&n; * ^^^^^^^^^^^^^^^^^^^^^^^^^^^&n; * When sa1100_pcmcia_notifier() decides that a MECR adjustment (due&n; * to a core clock frequency change) is needed, this routine establishes&n; * new BS_xx values consistent with the clock speed `clock&squot;.&n; */
DECL|function|sa1100_pcmcia_update_mecr
r_static
r_void
id|sa1100_pcmcia_update_mecr
c_func
(paren
r_int
r_int
id|clock
)paren
(brace
r_struct
id|soc_pcmcia_socket
op_star
id|skt
suffix:semicolon
id|down
c_func
(paren
op_amp
id|soc_pcmcia_sockets_lock
)paren
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|skt
comma
op_amp
id|soc_pcmcia_sockets
comma
id|node
)paren
id|sa1100_pcmcia_set_mecr
c_func
(paren
id|skt
comma
id|clock
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|soc_pcmcia_sockets_lock
)paren
suffix:semicolon
)brace
multiline_comment|/* sa1100_pcmcia_notifier()&n; * ^^^^^^^^^^^^^^^^^^^^^^^^&n; * When changing the processor core clock frequency, it is necessary&n; * to adjust the MECR timings accordingly. We&squot;ve recorded the timings&n; * requested by Card Services, so this is just a matter of finding&n; * out what our current speed is, and then recomputing the new MECR&n; * values.&n; *&n; * Returns: 0 on success, -1 on error&n; */
r_static
r_int
DECL|function|sa1100_pcmcia_notifier
id|sa1100_pcmcia_notifier
c_func
(paren
r_struct
id|notifier_block
op_star
id|nb
comma
r_int
r_int
id|val
comma
r_void
op_star
id|data
)paren
(brace
r_struct
id|cpufreq_freqs
op_star
id|freqs
op_assign
id|data
suffix:semicolon
r_switch
c_cond
(paren
id|val
)paren
(brace
r_case
id|CPUFREQ_PRECHANGE
suffix:colon
r_if
c_cond
(paren
id|freqs
op_member_access_from_pointer
r_new
OG
id|freqs-&gt;old
)paren
id|sa1100_pcmcia_update_mecr
c_func
(paren
id|freqs
op_member_access_from_pointer
r_new
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CPUFREQ_POSTCHANGE
suffix:colon
r_if
c_cond
(paren
id|freqs
op_member_access_from_pointer
r_new
OL
id|freqs-&gt;old
)paren
id|sa1100_pcmcia_update_mecr
c_func
(paren
id|freqs
op_member_access_from_pointer
r_new
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CPUFREQ_RESUMECHANGE
suffix:colon
id|sa1100_pcmcia_update_mecr
c_func
(paren
id|freqs
op_member_access_from_pointer
r_new
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|sa1100_pcmcia_notifier_block
r_static
r_struct
id|notifier_block
id|sa1100_pcmcia_notifier_block
op_assign
(brace
dot
id|notifier_call
op_assign
id|sa1100_pcmcia_notifier
)brace
suffix:semicolon
DECL|function|sa11xx_pcmcia_init
r_static
r_int
id|__init
id|sa11xx_pcmcia_init
c_func
(paren
r_void
)paren
(brace
r_int
id|ret
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;SA11xx PCMCIA&bslash;n&quot;
)paren
suffix:semicolon
id|ret
op_assign
id|cpufreq_register_notifier
c_func
(paren
op_amp
id|sa1100_pcmcia_notifier_block
comma
id|CPUFREQ_TRANSITION_NOTIFIER
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Unable to register CPU frequency change &quot;
l_string|&quot;notifier (%d)&bslash;n&quot;
comma
id|ret
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|variable|sa11xx_pcmcia_init
id|module_init
c_func
(paren
id|sa11xx_pcmcia_init
)paren
suffix:semicolon
DECL|function|sa11xx_pcmcia_exit
r_static
r_void
id|__exit
id|sa11xx_pcmcia_exit
c_func
(paren
r_void
)paren
(brace
id|cpufreq_unregister_notifier
c_func
(paren
op_amp
id|sa1100_pcmcia_notifier_block
comma
id|CPUFREQ_TRANSITION_NOTIFIER
)paren
suffix:semicolon
)brace
DECL|variable|sa11xx_pcmcia_exit
id|module_exit
c_func
(paren
id|sa11xx_pcmcia_exit
)paren
suffix:semicolon
macro_line|#endif
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;John Dorsey &lt;john+@cs.cmu.edu&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Linux PCMCIA Card Services: SA-11xx core socket driver&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;Dual MPL/GPL&quot;
)paren
suffix:semicolon
eof
