multiline_comment|/*&n; * Regular cardbus driver (&quot;yenta_socket&quot;)&n; *&n; * (C) Copyright 1999, 2000 Linus Torvalds&n; *&n; * Changelog:&n; * Aug 2002: Manfred Spraul &lt;manfred@colorfullife.com&gt;&n; * &t;Dynamically adjust the size of the bridge resource&n; * &t;&n; * May 2003: Dominik Brodowski &lt;linux@brodo.de&gt;&n; * &t;Merge pci_socket.c and yenta.c into one file&n; */
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/workqueue.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;pcmcia/version.h&gt;
macro_line|#include &lt;pcmcia/cs_types.h&gt;
macro_line|#include &lt;pcmcia/ss.h&gt;
macro_line|#include &lt;pcmcia/cs.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &quot;yenta_socket.h&quot;
macro_line|#include &quot;i82365.h&quot;
DECL|variable|disable_clkrun
r_static
r_int
id|disable_clkrun
suffix:semicolon
id|module_param
c_func
(paren
id|disable_clkrun
comma
r_bool
comma
l_int|0444
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|disable_clkrun
comma
l_string|&quot;If PC card doesn&squot;t function properly, please try this option&quot;
)paren
suffix:semicolon
macro_line|#if 0
mdefine_line|#define debug(x,args...) printk(KERN_DEBUG &quot;%s: &quot; x, __func__ , ##args)
macro_line|#else
DECL|macro|debug
mdefine_line|#define debug(x,args...)
macro_line|#endif
multiline_comment|/* Don&squot;t ask.. */
DECL|macro|to_cycles
mdefine_line|#define to_cycles(ns)&t;((ns)/120)
DECL|macro|to_ns
mdefine_line|#define to_ns(cycles)&t;((cycles)*120)
r_static
r_int
id|yenta_probe_cb_irq
c_func
(paren
r_struct
id|yenta_socket
op_star
id|socket
)paren
suffix:semicolon
multiline_comment|/*&n; * Generate easy-to-use ways of reading a cardbus sockets&n; * regular memory space (&quot;cb_xxx&quot;), configuration space&n; * (&quot;config_xxx&quot;) and compatibility space (&quot;exca_xxxx&quot;)&n; */
DECL|function|cb_readl
r_static
r_inline
id|u32
id|cb_readl
c_func
(paren
r_struct
id|yenta_socket
op_star
id|socket
comma
r_int
id|reg
)paren
(brace
id|u32
id|val
op_assign
id|readl
c_func
(paren
id|socket-&gt;base
op_plus
id|reg
)paren
suffix:semicolon
id|debug
c_func
(paren
l_string|&quot;%p %04x %08x&bslash;n&quot;
comma
id|socket
comma
id|reg
comma
id|val
)paren
suffix:semicolon
r_return
id|val
suffix:semicolon
)brace
DECL|function|cb_writel
r_static
r_inline
r_void
id|cb_writel
c_func
(paren
r_struct
id|yenta_socket
op_star
id|socket
comma
r_int
id|reg
comma
id|u32
id|val
)paren
(brace
id|debug
c_func
(paren
l_string|&quot;%p %04x %08x&bslash;n&quot;
comma
id|socket
comma
id|reg
comma
id|val
)paren
suffix:semicolon
id|writel
c_func
(paren
id|val
comma
id|socket-&gt;base
op_plus
id|reg
)paren
suffix:semicolon
)brace
DECL|function|config_readb
r_static
r_inline
id|u8
id|config_readb
c_func
(paren
r_struct
id|yenta_socket
op_star
id|socket
comma
r_int
id|offset
)paren
(brace
id|u8
id|val
suffix:semicolon
id|pci_read_config_byte
c_func
(paren
id|socket-&gt;dev
comma
id|offset
comma
op_amp
id|val
)paren
suffix:semicolon
id|debug
c_func
(paren
l_string|&quot;%p %04x %02x&bslash;n&quot;
comma
id|socket
comma
id|offset
comma
id|val
)paren
suffix:semicolon
r_return
id|val
suffix:semicolon
)brace
DECL|function|config_readw
r_static
r_inline
id|u16
id|config_readw
c_func
(paren
r_struct
id|yenta_socket
op_star
id|socket
comma
r_int
id|offset
)paren
(brace
id|u16
id|val
suffix:semicolon
id|pci_read_config_word
c_func
(paren
id|socket-&gt;dev
comma
id|offset
comma
op_amp
id|val
)paren
suffix:semicolon
id|debug
c_func
(paren
l_string|&quot;%p %04x %04x&bslash;n&quot;
comma
id|socket
comma
id|offset
comma
id|val
)paren
suffix:semicolon
r_return
id|val
suffix:semicolon
)brace
DECL|function|config_readl
r_static
r_inline
id|u32
id|config_readl
c_func
(paren
r_struct
id|yenta_socket
op_star
id|socket
comma
r_int
id|offset
)paren
(brace
id|u32
id|val
suffix:semicolon
id|pci_read_config_dword
c_func
(paren
id|socket-&gt;dev
comma
id|offset
comma
op_amp
id|val
)paren
suffix:semicolon
id|debug
c_func
(paren
l_string|&quot;%p %04x %08x&bslash;n&quot;
comma
id|socket
comma
id|offset
comma
id|val
)paren
suffix:semicolon
r_return
id|val
suffix:semicolon
)brace
DECL|function|config_writeb
r_static
r_inline
r_void
id|config_writeb
c_func
(paren
r_struct
id|yenta_socket
op_star
id|socket
comma
r_int
id|offset
comma
id|u8
id|val
)paren
(brace
id|debug
c_func
(paren
l_string|&quot;%p %04x %02x&bslash;n&quot;
comma
id|socket
comma
id|offset
comma
id|val
)paren
suffix:semicolon
id|pci_write_config_byte
c_func
(paren
id|socket-&gt;dev
comma
id|offset
comma
id|val
)paren
suffix:semicolon
)brace
DECL|function|config_writew
r_static
r_inline
r_void
id|config_writew
c_func
(paren
r_struct
id|yenta_socket
op_star
id|socket
comma
r_int
id|offset
comma
id|u16
id|val
)paren
(brace
id|debug
c_func
(paren
l_string|&quot;%p %04x %04x&bslash;n&quot;
comma
id|socket
comma
id|offset
comma
id|val
)paren
suffix:semicolon
id|pci_write_config_word
c_func
(paren
id|socket-&gt;dev
comma
id|offset
comma
id|val
)paren
suffix:semicolon
)brace
DECL|function|config_writel
r_static
r_inline
r_void
id|config_writel
c_func
(paren
r_struct
id|yenta_socket
op_star
id|socket
comma
r_int
id|offset
comma
id|u32
id|val
)paren
(brace
id|debug
c_func
(paren
l_string|&quot;%p %04x %08x&bslash;n&quot;
comma
id|socket
comma
id|offset
comma
id|val
)paren
suffix:semicolon
id|pci_write_config_dword
c_func
(paren
id|socket-&gt;dev
comma
id|offset
comma
id|val
)paren
suffix:semicolon
)brace
DECL|function|exca_readb
r_static
r_inline
id|u8
id|exca_readb
c_func
(paren
r_struct
id|yenta_socket
op_star
id|socket
comma
r_int
id|reg
)paren
(brace
id|u8
id|val
op_assign
id|readb
c_func
(paren
id|socket-&gt;base
op_plus
l_int|0x800
op_plus
id|reg
)paren
suffix:semicolon
id|debug
c_func
(paren
l_string|&quot;%p %04x %02x&bslash;n&quot;
comma
id|socket
comma
id|reg
comma
id|val
)paren
suffix:semicolon
r_return
id|val
suffix:semicolon
)brace
DECL|function|exca_readw
r_static
r_inline
id|u8
id|exca_readw
c_func
(paren
r_struct
id|yenta_socket
op_star
id|socket
comma
r_int
id|reg
)paren
(brace
id|u16
id|val
suffix:semicolon
id|val
op_assign
id|readb
c_func
(paren
id|socket-&gt;base
op_plus
l_int|0x800
op_plus
id|reg
)paren
suffix:semicolon
id|val
op_or_assign
id|readb
c_func
(paren
id|socket-&gt;base
op_plus
l_int|0x800
op_plus
id|reg
op_plus
l_int|1
)paren
op_lshift
l_int|8
suffix:semicolon
id|debug
c_func
(paren
l_string|&quot;%p %04x %04x&bslash;n&quot;
comma
id|socket
comma
id|reg
comma
id|val
)paren
suffix:semicolon
r_return
id|val
suffix:semicolon
)brace
DECL|function|exca_writeb
r_static
r_inline
r_void
id|exca_writeb
c_func
(paren
r_struct
id|yenta_socket
op_star
id|socket
comma
r_int
id|reg
comma
id|u8
id|val
)paren
(brace
id|debug
c_func
(paren
l_string|&quot;%p %04x %02x&bslash;n&quot;
comma
id|socket
comma
id|reg
comma
id|val
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|val
comma
id|socket-&gt;base
op_plus
l_int|0x800
op_plus
id|reg
)paren
suffix:semicolon
)brace
DECL|function|exca_writew
r_static
r_void
id|exca_writew
c_func
(paren
r_struct
id|yenta_socket
op_star
id|socket
comma
r_int
id|reg
comma
id|u16
id|val
)paren
(brace
id|debug
c_func
(paren
l_string|&quot;%p %04x %04x&bslash;n&quot;
comma
id|socket
comma
id|reg
comma
id|val
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|val
comma
id|socket-&gt;base
op_plus
l_int|0x800
op_plus
id|reg
)paren
suffix:semicolon
id|writeb
c_func
(paren
id|val
op_rshift
l_int|8
comma
id|socket-&gt;base
op_plus
l_int|0x800
op_plus
id|reg
op_plus
l_int|1
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Ugh, mixed-mode cardbus and 16-bit pccard state: things depend&n; * on what kind of card is inserted..&n; */
DECL|function|yenta_get_status
r_static
r_int
id|yenta_get_status
c_func
(paren
r_struct
id|pcmcia_socket
op_star
id|sock
comma
r_int
r_int
op_star
id|value
)paren
(brace
r_struct
id|yenta_socket
op_star
id|socket
op_assign
id|container_of
c_func
(paren
id|sock
comma
r_struct
id|yenta_socket
comma
id|socket
)paren
suffix:semicolon
r_int
r_int
id|val
suffix:semicolon
id|u32
id|state
op_assign
id|cb_readl
c_func
(paren
id|socket
comma
id|CB_SOCKET_STATE
)paren
suffix:semicolon
id|val
op_assign
(paren
id|state
op_amp
id|CB_3VCARD
)paren
ques
c_cond
id|SS_3VCARD
suffix:colon
l_int|0
suffix:semicolon
id|val
op_or_assign
(paren
id|state
op_amp
id|CB_XVCARD
)paren
ques
c_cond
id|SS_XVCARD
suffix:colon
l_int|0
suffix:semicolon
id|val
op_or_assign
(paren
id|state
op_amp
(paren
id|CB_CDETECT1
op_or
id|CB_CDETECT2
op_or
id|CB_5VCARD
op_or
id|CB_3VCARD
op_or
id|CB_XVCARD
op_or
id|CB_YVCARD
)paren
)paren
ques
c_cond
l_int|0
suffix:colon
id|SS_PENDING
suffix:semicolon
r_if
c_cond
(paren
id|state
op_amp
id|CB_CBCARD
)paren
(brace
id|val
op_or_assign
id|SS_CARDBUS
suffix:semicolon
id|val
op_or_assign
(paren
id|state
op_amp
id|CB_CARDSTS
)paren
ques
c_cond
id|SS_STSCHG
suffix:colon
l_int|0
suffix:semicolon
id|val
op_or_assign
(paren
id|state
op_amp
(paren
id|CB_CDETECT1
op_or
id|CB_CDETECT2
)paren
)paren
ques
c_cond
l_int|0
suffix:colon
id|SS_DETECT
suffix:semicolon
id|val
op_or_assign
(paren
id|state
op_amp
id|CB_PWRCYCLE
)paren
ques
c_cond
id|SS_POWERON
op_or
id|SS_READY
suffix:colon
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|u8
id|status
op_assign
id|exca_readb
c_func
(paren
id|socket
comma
id|I365_STATUS
)paren
suffix:semicolon
id|val
op_or_assign
(paren
(paren
id|status
op_amp
id|I365_CS_DETECT
)paren
op_eq
id|I365_CS_DETECT
)paren
ques
c_cond
id|SS_DETECT
suffix:colon
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|exca_readb
c_func
(paren
id|socket
comma
id|I365_INTCTL
)paren
op_amp
id|I365_PC_IOCARD
)paren
(brace
id|val
op_or_assign
(paren
id|status
op_amp
id|I365_CS_STSCHG
)paren
ques
c_cond
l_int|0
suffix:colon
id|SS_STSCHG
suffix:semicolon
)brace
r_else
(brace
id|val
op_or_assign
(paren
id|status
op_amp
id|I365_CS_BVD1
)paren
ques
c_cond
l_int|0
suffix:colon
id|SS_BATDEAD
suffix:semicolon
id|val
op_or_assign
(paren
id|status
op_amp
id|I365_CS_BVD2
)paren
ques
c_cond
l_int|0
suffix:colon
id|SS_BATWARN
suffix:semicolon
)brace
id|val
op_or_assign
(paren
id|status
op_amp
id|I365_CS_WRPROT
)paren
ques
c_cond
id|SS_WRPROT
suffix:colon
l_int|0
suffix:semicolon
id|val
op_or_assign
(paren
id|status
op_amp
id|I365_CS_READY
)paren
ques
c_cond
id|SS_READY
suffix:colon
l_int|0
suffix:semicolon
id|val
op_or_assign
(paren
id|status
op_amp
id|I365_CS_POWERON
)paren
ques
c_cond
id|SS_POWERON
suffix:colon
l_int|0
suffix:semicolon
)brace
op_star
id|value
op_assign
id|val
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|yenta_Vcc_power
r_static
r_int
id|yenta_Vcc_power
c_func
(paren
id|u32
id|control
)paren
(brace
r_switch
c_cond
(paren
id|control
op_amp
id|CB_SC_VCC_MASK
)paren
(brace
r_case
id|CB_SC_VCC_5V
suffix:colon
r_return
l_int|50
suffix:semicolon
r_case
id|CB_SC_VCC_3V
suffix:colon
r_return
l_int|33
suffix:semicolon
r_default
suffix:colon
r_return
l_int|0
suffix:semicolon
)brace
)brace
DECL|function|yenta_Vpp_power
r_static
r_int
id|yenta_Vpp_power
c_func
(paren
id|u32
id|control
)paren
(brace
r_switch
c_cond
(paren
id|control
op_amp
id|CB_SC_VPP_MASK
)paren
(brace
r_case
id|CB_SC_VPP_12V
suffix:colon
r_return
l_int|120
suffix:semicolon
r_case
id|CB_SC_VPP_5V
suffix:colon
r_return
l_int|50
suffix:semicolon
r_case
id|CB_SC_VPP_3V
suffix:colon
r_return
l_int|33
suffix:semicolon
r_default
suffix:colon
r_return
l_int|0
suffix:semicolon
)brace
)brace
DECL|function|yenta_get_socket
r_static
r_int
id|yenta_get_socket
c_func
(paren
r_struct
id|pcmcia_socket
op_star
id|sock
comma
id|socket_state_t
op_star
id|state
)paren
(brace
r_struct
id|yenta_socket
op_star
id|socket
op_assign
id|container_of
c_func
(paren
id|sock
comma
r_struct
id|yenta_socket
comma
id|socket
)paren
suffix:semicolon
id|u8
id|reg
suffix:semicolon
id|u32
id|control
suffix:semicolon
id|control
op_assign
id|cb_readl
c_func
(paren
id|socket
comma
id|CB_SOCKET_CONTROL
)paren
suffix:semicolon
id|state-&gt;Vcc
op_assign
id|yenta_Vcc_power
c_func
(paren
id|control
)paren
suffix:semicolon
id|state-&gt;Vpp
op_assign
id|yenta_Vpp_power
c_func
(paren
id|control
)paren
suffix:semicolon
id|state-&gt;io_irq
op_assign
id|socket-&gt;io_irq
suffix:semicolon
r_if
c_cond
(paren
id|cb_readl
c_func
(paren
id|socket
comma
id|CB_SOCKET_STATE
)paren
op_amp
id|CB_CBCARD
)paren
(brace
id|u16
id|bridge
op_assign
id|config_readw
c_func
(paren
id|socket
comma
id|CB_BRIDGE_CONTROL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bridge
op_amp
id|CB_BRIDGE_CRST
)paren
id|state-&gt;flags
op_or_assign
id|SS_RESET
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* 16-bit card state.. */
id|reg
op_assign
id|exca_readb
c_func
(paren
id|socket
comma
id|I365_POWER
)paren
suffix:semicolon
id|state-&gt;flags
op_assign
(paren
id|reg
op_amp
id|I365_PWR_AUTO
)paren
ques
c_cond
id|SS_PWR_AUTO
suffix:colon
l_int|0
suffix:semicolon
id|state-&gt;flags
op_or_assign
(paren
id|reg
op_amp
id|I365_PWR_OUT
)paren
ques
c_cond
id|SS_OUTPUT_ENA
suffix:colon
l_int|0
suffix:semicolon
id|reg
op_assign
id|exca_readb
c_func
(paren
id|socket
comma
id|I365_INTCTL
)paren
suffix:semicolon
id|state-&gt;flags
op_or_assign
(paren
id|reg
op_amp
id|I365_PC_RESET
)paren
ques
c_cond
l_int|0
suffix:colon
id|SS_RESET
suffix:semicolon
id|state-&gt;flags
op_or_assign
(paren
id|reg
op_amp
id|I365_PC_IOCARD
)paren
ques
c_cond
id|SS_IOCARD
suffix:colon
l_int|0
suffix:semicolon
id|reg
op_assign
id|exca_readb
c_func
(paren
id|socket
comma
id|I365_CSCINT
)paren
suffix:semicolon
id|state-&gt;csc_mask
op_assign
(paren
id|reg
op_amp
id|I365_CSC_DETECT
)paren
ques
c_cond
id|SS_DETECT
suffix:colon
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|state-&gt;flags
op_amp
id|SS_IOCARD
)paren
(brace
id|state-&gt;csc_mask
op_or_assign
(paren
id|reg
op_amp
id|I365_CSC_STSCHG
)paren
ques
c_cond
id|SS_STSCHG
suffix:colon
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|state-&gt;csc_mask
op_or_assign
(paren
id|reg
op_amp
id|I365_CSC_BVD1
)paren
ques
c_cond
id|SS_BATDEAD
suffix:colon
l_int|0
suffix:semicolon
id|state-&gt;csc_mask
op_or_assign
(paren
id|reg
op_amp
id|I365_CSC_BVD2
)paren
ques
c_cond
id|SS_BATWARN
suffix:colon
l_int|0
suffix:semicolon
id|state-&gt;csc_mask
op_or_assign
(paren
id|reg
op_amp
id|I365_CSC_READY
)paren
ques
c_cond
id|SS_READY
suffix:colon
l_int|0
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|yenta_set_power
r_static
r_void
id|yenta_set_power
c_func
(paren
r_struct
id|yenta_socket
op_star
id|socket
comma
id|socket_state_t
op_star
id|state
)paren
(brace
id|u32
id|reg
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* CB_SC_STPCLK? */
r_switch
c_cond
(paren
id|state-&gt;Vcc
)paren
(brace
r_case
l_int|33
suffix:colon
id|reg
op_assign
id|CB_SC_VCC_3V
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|50
suffix:colon
id|reg
op_assign
id|CB_SC_VCC_5V
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|reg
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|state-&gt;Vpp
)paren
(brace
r_case
l_int|33
suffix:colon
id|reg
op_or_assign
id|CB_SC_VPP_3V
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|50
suffix:colon
id|reg
op_or_assign
id|CB_SC_VPP_5V
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|120
suffix:colon
id|reg
op_or_assign
id|CB_SC_VPP_12V
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|reg
op_ne
id|cb_readl
c_func
(paren
id|socket
comma
id|CB_SOCKET_CONTROL
)paren
)paren
id|cb_writel
c_func
(paren
id|socket
comma
id|CB_SOCKET_CONTROL
comma
id|reg
)paren
suffix:semicolon
)brace
DECL|function|yenta_set_socket
r_static
r_int
id|yenta_set_socket
c_func
(paren
r_struct
id|pcmcia_socket
op_star
id|sock
comma
id|socket_state_t
op_star
id|state
)paren
(brace
r_struct
id|yenta_socket
op_star
id|socket
op_assign
id|container_of
c_func
(paren
id|sock
comma
r_struct
id|yenta_socket
comma
id|socket
)paren
suffix:semicolon
id|u16
id|bridge
suffix:semicolon
id|yenta_set_power
c_func
(paren
id|socket
comma
id|state
)paren
suffix:semicolon
id|socket-&gt;io_irq
op_assign
id|state-&gt;io_irq
suffix:semicolon
id|bridge
op_assign
id|config_readw
c_func
(paren
id|socket
comma
id|CB_BRIDGE_CONTROL
)paren
op_amp
op_complement
(paren
id|CB_BRIDGE_CRST
op_or
id|CB_BRIDGE_INTR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cb_readl
c_func
(paren
id|socket
comma
id|CB_SOCKET_STATE
)paren
op_amp
id|CB_CBCARD
)paren
(brace
id|u8
id|intr
suffix:semicolon
id|bridge
op_or_assign
(paren
id|state-&gt;flags
op_amp
id|SS_RESET
)paren
ques
c_cond
id|CB_BRIDGE_CRST
suffix:colon
l_int|0
suffix:semicolon
multiline_comment|/* ISA interrupt control? */
id|intr
op_assign
id|exca_readb
c_func
(paren
id|socket
comma
id|I365_INTCTL
)paren
suffix:semicolon
id|intr
op_assign
(paren
id|intr
op_amp
op_complement
l_int|0xf
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|socket-&gt;cb_irq
)paren
(brace
id|intr
op_or_assign
id|state-&gt;io_irq
suffix:semicolon
id|bridge
op_or_assign
id|CB_BRIDGE_INTR
suffix:semicolon
)brace
id|exca_writeb
c_func
(paren
id|socket
comma
id|I365_INTCTL
comma
id|intr
)paren
suffix:semicolon
)brace
r_else
(brace
id|u8
id|reg
suffix:semicolon
id|reg
op_assign
id|exca_readb
c_func
(paren
id|socket
comma
id|I365_INTCTL
)paren
op_amp
(paren
id|I365_RING_ENA
op_or
id|I365_INTR_ENA
)paren
suffix:semicolon
id|reg
op_or_assign
(paren
id|state-&gt;flags
op_amp
id|SS_RESET
)paren
ques
c_cond
l_int|0
suffix:colon
id|I365_PC_RESET
suffix:semicolon
id|reg
op_or_assign
(paren
id|state-&gt;flags
op_amp
id|SS_IOCARD
)paren
ques
c_cond
id|I365_PC_IOCARD
suffix:colon
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|state-&gt;io_irq
op_ne
id|socket-&gt;cb_irq
)paren
(brace
id|reg
op_or_assign
id|state-&gt;io_irq
suffix:semicolon
id|bridge
op_or_assign
id|CB_BRIDGE_INTR
suffix:semicolon
)brace
id|exca_writeb
c_func
(paren
id|socket
comma
id|I365_INTCTL
comma
id|reg
)paren
suffix:semicolon
id|reg
op_assign
id|exca_readb
c_func
(paren
id|socket
comma
id|I365_POWER
)paren
op_amp
(paren
id|I365_VCC_MASK
op_or
id|I365_VPP1_MASK
)paren
suffix:semicolon
id|reg
op_or_assign
id|I365_PWR_NORESET
suffix:semicolon
r_if
c_cond
(paren
id|state-&gt;flags
op_amp
id|SS_PWR_AUTO
)paren
id|reg
op_or_assign
id|I365_PWR_AUTO
suffix:semicolon
r_if
c_cond
(paren
id|state-&gt;flags
op_amp
id|SS_OUTPUT_ENA
)paren
id|reg
op_or_assign
id|I365_PWR_OUT
suffix:semicolon
r_if
c_cond
(paren
id|exca_readb
c_func
(paren
id|socket
comma
id|I365_POWER
)paren
op_ne
id|reg
)paren
id|exca_writeb
c_func
(paren
id|socket
comma
id|I365_POWER
comma
id|reg
)paren
suffix:semicolon
multiline_comment|/* CSC interrupt: no ISA irq for CSC */
id|reg
op_assign
id|I365_CSC_DETECT
suffix:semicolon
r_if
c_cond
(paren
id|state-&gt;flags
op_amp
id|SS_IOCARD
)paren
(brace
r_if
c_cond
(paren
id|state-&gt;csc_mask
op_amp
id|SS_STSCHG
)paren
id|reg
op_or_assign
id|I365_CSC_STSCHG
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|state-&gt;csc_mask
op_amp
id|SS_BATDEAD
)paren
id|reg
op_or_assign
id|I365_CSC_BVD1
suffix:semicolon
r_if
c_cond
(paren
id|state-&gt;csc_mask
op_amp
id|SS_BATWARN
)paren
id|reg
op_or_assign
id|I365_CSC_BVD2
suffix:semicolon
r_if
c_cond
(paren
id|state-&gt;csc_mask
op_amp
id|SS_READY
)paren
id|reg
op_or_assign
id|I365_CSC_READY
suffix:semicolon
)brace
id|exca_writeb
c_func
(paren
id|socket
comma
id|I365_CSCINT
comma
id|reg
)paren
suffix:semicolon
id|exca_readb
c_func
(paren
id|socket
comma
id|I365_CSC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sock-&gt;zoom_video
)paren
(brace
id|sock
op_member_access_from_pointer
id|zoom_video
c_func
(paren
id|sock
comma
id|state-&gt;flags
op_amp
id|SS_ZVCARD
)paren
suffix:semicolon
)brace
)brace
id|config_writew
c_func
(paren
id|socket
comma
id|CB_BRIDGE_CONTROL
comma
id|bridge
)paren
suffix:semicolon
multiline_comment|/* Socket event mask: get card insert/remove events.. */
id|cb_writel
c_func
(paren
id|socket
comma
id|CB_SOCKET_EVENT
comma
op_minus
l_int|1
)paren
suffix:semicolon
id|cb_writel
c_func
(paren
id|socket
comma
id|CB_SOCKET_MASK
comma
id|CB_CDMASK
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|yenta_set_io_map
r_static
r_int
id|yenta_set_io_map
c_func
(paren
r_struct
id|pcmcia_socket
op_star
id|sock
comma
r_struct
id|pccard_io_map
op_star
id|io
)paren
(brace
r_struct
id|yenta_socket
op_star
id|socket
op_assign
id|container_of
c_func
(paren
id|sock
comma
r_struct
id|yenta_socket
comma
id|socket
)paren
suffix:semicolon
r_int
id|map
suffix:semicolon
r_int
r_char
id|ioctl
comma
id|addr
comma
id|enable
suffix:semicolon
id|map
op_assign
id|io-&gt;map
suffix:semicolon
r_if
c_cond
(paren
id|map
OG
l_int|1
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|enable
op_assign
id|I365_ENA_IO
c_func
(paren
id|map
)paren
suffix:semicolon
id|addr
op_assign
id|exca_readb
c_func
(paren
id|socket
comma
id|I365_ADDRWIN
)paren
suffix:semicolon
multiline_comment|/* Disable the window before changing it.. */
r_if
c_cond
(paren
id|addr
op_amp
id|enable
)paren
(brace
id|addr
op_and_assign
op_complement
id|enable
suffix:semicolon
id|exca_writeb
c_func
(paren
id|socket
comma
id|I365_ADDRWIN
comma
id|addr
)paren
suffix:semicolon
)brace
id|exca_writew
c_func
(paren
id|socket
comma
id|I365_IO
c_func
(paren
id|map
)paren
op_plus
id|I365_W_START
comma
id|io-&gt;start
)paren
suffix:semicolon
id|exca_writew
c_func
(paren
id|socket
comma
id|I365_IO
c_func
(paren
id|map
)paren
op_plus
id|I365_W_STOP
comma
id|io-&gt;stop
)paren
suffix:semicolon
id|ioctl
op_assign
id|exca_readb
c_func
(paren
id|socket
comma
id|I365_IOCTL
)paren
op_amp
op_complement
id|I365_IOCTL_MASK
c_func
(paren
id|map
)paren
suffix:semicolon
r_if
c_cond
(paren
id|io-&gt;flags
op_amp
id|MAP_0WS
)paren
id|ioctl
op_or_assign
id|I365_IOCTL_0WS
c_func
(paren
id|map
)paren
suffix:semicolon
r_if
c_cond
(paren
id|io-&gt;flags
op_amp
id|MAP_16BIT
)paren
id|ioctl
op_or_assign
id|I365_IOCTL_16BIT
c_func
(paren
id|map
)paren
suffix:semicolon
r_if
c_cond
(paren
id|io-&gt;flags
op_amp
id|MAP_AUTOSZ
)paren
id|ioctl
op_or_assign
id|I365_IOCTL_IOCS16
c_func
(paren
id|map
)paren
suffix:semicolon
id|exca_writeb
c_func
(paren
id|socket
comma
id|I365_IOCTL
comma
id|ioctl
)paren
suffix:semicolon
r_if
c_cond
(paren
id|io-&gt;flags
op_amp
id|MAP_ACTIVE
)paren
id|exca_writeb
c_func
(paren
id|socket
comma
id|I365_ADDRWIN
comma
id|addr
op_or
id|enable
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|yenta_set_mem_map
r_static
r_int
id|yenta_set_mem_map
c_func
(paren
r_struct
id|pcmcia_socket
op_star
id|sock
comma
r_struct
id|pccard_mem_map
op_star
id|mem
)paren
(brace
r_struct
id|yenta_socket
op_star
id|socket
op_assign
id|container_of
c_func
(paren
id|sock
comma
r_struct
id|yenta_socket
comma
id|socket
)paren
suffix:semicolon
r_struct
id|pci_bus_region
id|region
suffix:semicolon
r_int
id|map
suffix:semicolon
r_int
r_char
id|addr
comma
id|enable
suffix:semicolon
r_int
r_int
id|start
comma
id|stop
comma
id|card_start
suffix:semicolon
r_int
r_int
id|word
suffix:semicolon
id|pcibios_resource_to_bus
c_func
(paren
id|socket-&gt;dev
comma
op_amp
id|region
comma
id|mem-&gt;res
)paren
suffix:semicolon
id|map
op_assign
id|mem-&gt;map
suffix:semicolon
id|start
op_assign
id|region.start
suffix:semicolon
id|stop
op_assign
id|region.end
suffix:semicolon
id|card_start
op_assign
id|mem-&gt;card_start
suffix:semicolon
r_if
c_cond
(paren
id|map
OG
l_int|4
op_logical_or
id|start
OG
id|stop
op_logical_or
(paren
(paren
id|start
op_xor
id|stop
)paren
op_rshift
l_int|24
)paren
op_logical_or
(paren
id|card_start
op_rshift
l_int|26
)paren
op_logical_or
id|mem-&gt;speed
OG
l_int|1000
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|enable
op_assign
id|I365_ENA_MEM
c_func
(paren
id|map
)paren
suffix:semicolon
id|addr
op_assign
id|exca_readb
c_func
(paren
id|socket
comma
id|I365_ADDRWIN
)paren
suffix:semicolon
r_if
c_cond
(paren
id|addr
op_amp
id|enable
)paren
(brace
id|addr
op_and_assign
op_complement
id|enable
suffix:semicolon
id|exca_writeb
c_func
(paren
id|socket
comma
id|I365_ADDRWIN
comma
id|addr
)paren
suffix:semicolon
)brace
id|exca_writeb
c_func
(paren
id|socket
comma
id|CB_MEM_PAGE
c_func
(paren
id|map
)paren
comma
id|start
op_rshift
l_int|24
)paren
suffix:semicolon
id|word
op_assign
(paren
id|start
op_rshift
l_int|12
)paren
op_amp
l_int|0x0fff
suffix:semicolon
r_if
c_cond
(paren
id|mem-&gt;flags
op_amp
id|MAP_16BIT
)paren
id|word
op_or_assign
id|I365_MEM_16BIT
suffix:semicolon
r_if
c_cond
(paren
id|mem-&gt;flags
op_amp
id|MAP_0WS
)paren
id|word
op_or_assign
id|I365_MEM_0WS
suffix:semicolon
id|exca_writew
c_func
(paren
id|socket
comma
id|I365_MEM
c_func
(paren
id|map
)paren
op_plus
id|I365_W_START
comma
id|word
)paren
suffix:semicolon
id|word
op_assign
(paren
id|stop
op_rshift
l_int|12
)paren
op_amp
l_int|0x0fff
suffix:semicolon
r_switch
c_cond
(paren
id|to_cycles
c_func
(paren
id|mem-&gt;speed
)paren
)paren
(brace
r_case
l_int|0
suffix:colon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|word
op_or_assign
id|I365_MEM_WS0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|word
op_or_assign
id|I365_MEM_WS1
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|word
op_or_assign
id|I365_MEM_WS1
op_or
id|I365_MEM_WS0
suffix:semicolon
r_break
suffix:semicolon
)brace
id|exca_writew
c_func
(paren
id|socket
comma
id|I365_MEM
c_func
(paren
id|map
)paren
op_plus
id|I365_W_STOP
comma
id|word
)paren
suffix:semicolon
id|word
op_assign
(paren
(paren
id|card_start
op_minus
id|start
)paren
op_rshift
l_int|12
)paren
op_amp
l_int|0x3fff
suffix:semicolon
r_if
c_cond
(paren
id|mem-&gt;flags
op_amp
id|MAP_WRPROT
)paren
id|word
op_or_assign
id|I365_MEM_WRPROT
suffix:semicolon
r_if
c_cond
(paren
id|mem-&gt;flags
op_amp
id|MAP_ATTRIB
)paren
id|word
op_or_assign
id|I365_MEM_REG
suffix:semicolon
id|exca_writew
c_func
(paren
id|socket
comma
id|I365_MEM
c_func
(paren
id|map
)paren
op_plus
id|I365_W_OFF
comma
id|word
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mem-&gt;flags
op_amp
id|MAP_ACTIVE
)paren
id|exca_writeb
c_func
(paren
id|socket
comma
id|I365_ADDRWIN
comma
id|addr
op_or
id|enable
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|yenta_events
r_static
r_int
r_int
id|yenta_events
c_func
(paren
r_struct
id|yenta_socket
op_star
id|socket
)paren
(brace
id|u8
id|csc
suffix:semicolon
id|u32
id|cb_event
suffix:semicolon
r_int
r_int
id|events
suffix:semicolon
multiline_comment|/* Clear interrupt status for the event */
id|cb_event
op_assign
id|cb_readl
c_func
(paren
id|socket
comma
id|CB_SOCKET_EVENT
)paren
suffix:semicolon
id|cb_writel
c_func
(paren
id|socket
comma
id|CB_SOCKET_EVENT
comma
id|cb_event
)paren
suffix:semicolon
id|csc
op_assign
id|exca_readb
c_func
(paren
id|socket
comma
id|I365_CSC
)paren
suffix:semicolon
id|events
op_assign
(paren
id|cb_event
op_amp
(paren
id|CB_CD1EVENT
op_or
id|CB_CD2EVENT
)paren
)paren
ques
c_cond
id|SS_DETECT
suffix:colon
l_int|0
suffix:semicolon
id|events
op_or_assign
(paren
id|csc
op_amp
id|I365_CSC_DETECT
)paren
ques
c_cond
id|SS_DETECT
suffix:colon
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|exca_readb
c_func
(paren
id|socket
comma
id|I365_INTCTL
)paren
op_amp
id|I365_PC_IOCARD
)paren
(brace
id|events
op_or_assign
(paren
id|csc
op_amp
id|I365_CSC_STSCHG
)paren
ques
c_cond
id|SS_STSCHG
suffix:colon
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|events
op_or_assign
(paren
id|csc
op_amp
id|I365_CSC_BVD1
)paren
ques
c_cond
id|SS_BATDEAD
suffix:colon
l_int|0
suffix:semicolon
id|events
op_or_assign
(paren
id|csc
op_amp
id|I365_CSC_BVD2
)paren
ques
c_cond
id|SS_BATWARN
suffix:colon
l_int|0
suffix:semicolon
id|events
op_or_assign
(paren
id|csc
op_amp
id|I365_CSC_READY
)paren
ques
c_cond
id|SS_READY
suffix:colon
l_int|0
suffix:semicolon
)brace
r_return
id|events
suffix:semicolon
)brace
DECL|function|yenta_interrupt
r_static
id|irqreturn_t
id|yenta_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
r_int
id|events
suffix:semicolon
r_struct
id|yenta_socket
op_star
id|socket
op_assign
(paren
r_struct
id|yenta_socket
op_star
)paren
id|dev_id
suffix:semicolon
id|events
op_assign
id|yenta_events
c_func
(paren
id|socket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|events
)paren
(brace
id|pcmcia_parse_events
c_func
(paren
op_amp
id|socket-&gt;socket
comma
id|events
)paren
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
r_return
id|IRQ_NONE
suffix:semicolon
)brace
DECL|function|yenta_interrupt_wrapper
r_static
r_void
id|yenta_interrupt_wrapper
c_func
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|yenta_socket
op_star
id|socket
op_assign
(paren
r_struct
id|yenta_socket
op_star
)paren
id|data
suffix:semicolon
id|yenta_interrupt
c_func
(paren
l_int|0
comma
(paren
r_void
op_star
)paren
id|socket
comma
l_int|NULL
)paren
suffix:semicolon
id|socket-&gt;poll_timer.expires
op_assign
id|jiffies
op_plus
id|HZ
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|socket-&gt;poll_timer
)paren
suffix:semicolon
)brace
DECL|function|yenta_clear_maps
r_static
r_void
id|yenta_clear_maps
c_func
(paren
r_struct
id|yenta_socket
op_star
id|socket
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|resource
id|res
op_assign
(brace
dot
id|start
op_assign
l_int|0
comma
dot
id|end
op_assign
l_int|0x0fff
)brace
suffix:semicolon
id|pccard_io_map
id|io
op_assign
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|1
)brace
suffix:semicolon
id|pccard_mem_map
id|mem
op_assign
(brace
dot
id|res
op_assign
op_amp
id|res
comma
)brace
suffix:semicolon
id|yenta_set_socket
c_func
(paren
op_amp
id|socket-&gt;socket
comma
op_amp
id|dead_socket
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|2
suffix:semicolon
id|i
op_increment
)paren
(brace
id|io.map
op_assign
id|i
suffix:semicolon
id|yenta_set_io_map
c_func
(paren
op_amp
id|socket-&gt;socket
comma
op_amp
id|io
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|5
suffix:semicolon
id|i
op_increment
)paren
(brace
id|mem.map
op_assign
id|i
suffix:semicolon
id|yenta_set_mem_map
c_func
(paren
op_amp
id|socket-&gt;socket
comma
op_amp
id|mem
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Called at resume and initialization events */
DECL|function|yenta_sock_init
r_static
r_int
id|yenta_sock_init
c_func
(paren
r_struct
id|pcmcia_socket
op_star
id|sock
)paren
(brace
r_struct
id|yenta_socket
op_star
id|socket
op_assign
id|container_of
c_func
(paren
id|sock
comma
r_struct
id|yenta_socket
comma
id|socket
)paren
suffix:semicolon
id|u32
id|state
suffix:semicolon
id|u16
id|bridge
suffix:semicolon
id|bridge
op_assign
id|config_readw
c_func
(paren
id|socket
comma
id|CB_BRIDGE_CONTROL
)paren
op_amp
op_complement
id|CB_BRIDGE_INTR
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|socket-&gt;cb_irq
)paren
id|bridge
op_or_assign
id|CB_BRIDGE_INTR
suffix:semicolon
id|config_writew
c_func
(paren
id|socket
comma
id|CB_BRIDGE_CONTROL
comma
id|bridge
)paren
suffix:semicolon
id|exca_writeb
c_func
(paren
id|socket
comma
id|I365_GBLCTL
comma
l_int|0x00
)paren
suffix:semicolon
id|exca_writeb
c_func
(paren
id|socket
comma
id|I365_GENCTL
comma
l_int|0x00
)paren
suffix:semicolon
multiline_comment|/* Redo card voltage interrogation */
id|state
op_assign
id|cb_readl
c_func
(paren
id|socket
comma
id|CB_SOCKET_STATE
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|state
op_amp
(paren
id|CB_CDETECT1
op_or
id|CB_CDETECT2
op_or
id|CB_5VCARD
op_or
id|CB_3VCARD
op_or
id|CB_XVCARD
op_or
id|CB_YVCARD
)paren
)paren
)paren
id|cb_writel
c_func
(paren
id|socket
comma
id|CB_SOCKET_FORCE
comma
id|CB_CVSTEST
)paren
suffix:semicolon
id|yenta_clear_maps
c_func
(paren
id|socket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|socket-&gt;type
op_logical_and
id|socket-&gt;type-&gt;sock_init
)paren
id|socket-&gt;type
op_member_access_from_pointer
id|sock_init
c_func
(paren
id|socket
)paren
suffix:semicolon
multiline_comment|/* Re-enable CSC interrupts */
id|cb_writel
c_func
(paren
id|socket
comma
id|CB_SOCKET_MASK
comma
id|CB_CDMASK
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|yenta_sock_suspend
r_static
r_int
id|yenta_sock_suspend
c_func
(paren
r_struct
id|pcmcia_socket
op_star
id|sock
)paren
(brace
r_struct
id|yenta_socket
op_star
id|socket
op_assign
id|container_of
c_func
(paren
id|sock
comma
r_struct
id|yenta_socket
comma
id|socket
)paren
suffix:semicolon
id|yenta_set_socket
c_func
(paren
id|sock
comma
op_amp
id|dead_socket
)paren
suffix:semicolon
multiline_comment|/* Disable CSC interrupts */
id|cb_writel
c_func
(paren
id|socket
comma
id|CB_SOCKET_MASK
comma
l_int|0x0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Use an adaptive allocation for the memory resource,&n; * sometimes the memory behind pci bridges is limited:&n; * 1/8 of the size of the io window of the parent.&n; * max 4 MB, min 16 kB.&n; */
DECL|macro|BRIDGE_MEM_MAX
mdefine_line|#define BRIDGE_MEM_MAX 4*1024*1024
DECL|macro|BRIDGE_MEM_MIN
mdefine_line|#define BRIDGE_MEM_MIN 16*1024
DECL|macro|BRIDGE_IO_MAX
mdefine_line|#define BRIDGE_IO_MAX 256
DECL|macro|BRIDGE_IO_MIN
mdefine_line|#define BRIDGE_IO_MIN 32
macro_line|#ifndef PCIBIOS_MIN_CARDBUS_IO
DECL|macro|PCIBIOS_MIN_CARDBUS_IO
mdefine_line|#define PCIBIOS_MIN_CARDBUS_IO PCIBIOS_MIN_IO
macro_line|#endif
DECL|function|yenta_allocate_res
r_static
r_void
id|yenta_allocate_res
c_func
(paren
r_struct
id|yenta_socket
op_star
id|socket
comma
r_int
id|nr
comma
r_int
id|type
)paren
(brace
r_struct
id|pci_bus
op_star
id|bus
suffix:semicolon
r_struct
id|resource
op_star
id|root
comma
op_star
id|res
suffix:semicolon
id|u32
id|start
comma
id|end
suffix:semicolon
id|u32
id|align
comma
id|size
comma
id|min
suffix:semicolon
r_int
id|offset
suffix:semicolon
r_int
id|mask
suffix:semicolon
multiline_comment|/* The granularity of the memory limit is 4kB, on IO it&squot;s 4 bytes */
id|mask
op_assign
op_complement
l_int|0xfff
suffix:semicolon
r_if
c_cond
(paren
id|type
op_amp
id|IORESOURCE_IO
)paren
id|mask
op_assign
op_complement
l_int|3
suffix:semicolon
id|offset
op_assign
l_int|0x1c
op_plus
l_int|8
op_star
id|nr
suffix:semicolon
id|bus
op_assign
id|socket-&gt;dev-&gt;subordinate
suffix:semicolon
id|res
op_assign
id|socket-&gt;dev-&gt;resource
op_plus
id|PCI_BRIDGE_RESOURCES
op_plus
id|nr
suffix:semicolon
id|res-&gt;name
op_assign
id|bus-&gt;name
suffix:semicolon
id|res-&gt;flags
op_assign
id|type
suffix:semicolon
id|res-&gt;start
op_assign
l_int|0
suffix:semicolon
id|res-&gt;end
op_assign
l_int|0
suffix:semicolon
id|root
op_assign
id|pci_find_parent_resource
c_func
(paren
id|socket-&gt;dev
comma
id|res
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|root
)paren
r_return
suffix:semicolon
id|start
op_assign
id|config_readl
c_func
(paren
id|socket
comma
id|offset
)paren
op_amp
id|mask
suffix:semicolon
id|end
op_assign
id|config_readl
c_func
(paren
id|socket
comma
id|offset
op_plus
l_int|4
)paren
op_or
op_complement
id|mask
suffix:semicolon
r_if
c_cond
(paren
id|start
op_logical_and
id|end
OG
id|start
)paren
(brace
id|res-&gt;start
op_assign
id|start
suffix:semicolon
id|res-&gt;end
op_assign
id|end
suffix:semicolon
r_if
c_cond
(paren
id|request_resource
c_func
(paren
id|root
comma
id|res
)paren
op_eq
l_int|0
)paren
r_return
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;yenta %s: Preassigned resource %d busy, reconfiguring...&bslash;n&quot;
comma
id|pci_name
c_func
(paren
id|socket-&gt;dev
)paren
comma
id|nr
)paren
suffix:semicolon
id|res-&gt;start
op_assign
id|res-&gt;end
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|type
op_amp
id|IORESOURCE_IO
)paren
(brace
id|align
op_assign
l_int|1024
suffix:semicolon
id|size
op_assign
id|BRIDGE_IO_MAX
suffix:semicolon
id|min
op_assign
id|BRIDGE_IO_MIN
suffix:semicolon
id|start
op_assign
id|PCIBIOS_MIN_CARDBUS_IO
suffix:semicolon
id|end
op_assign
op_complement
l_int|0U
suffix:semicolon
)brace
r_else
(brace
r_int
r_int
id|avail
op_assign
id|root-&gt;end
op_minus
id|root-&gt;start
suffix:semicolon
r_int
id|i
suffix:semicolon
id|size
op_assign
id|BRIDGE_MEM_MAX
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
id|avail
op_div
l_int|8
)paren
(brace
id|size
op_assign
(paren
id|avail
op_plus
l_int|1
)paren
op_div
l_int|8
suffix:semicolon
multiline_comment|/* round size down to next power of 2 */
id|i
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
id|size
op_div_assign
l_int|2
)paren
op_ne
l_int|0
)paren
id|i
op_increment
suffix:semicolon
id|size
op_assign
l_int|1
op_lshift
id|i
suffix:semicolon
)brace
r_if
c_cond
(paren
id|size
OL
id|BRIDGE_MEM_MIN
)paren
id|size
op_assign
id|BRIDGE_MEM_MIN
suffix:semicolon
id|min
op_assign
id|BRIDGE_MEM_MIN
suffix:semicolon
id|align
op_assign
id|size
suffix:semicolon
id|start
op_assign
id|PCIBIOS_MIN_MEM
suffix:semicolon
id|end
op_assign
op_complement
l_int|0U
suffix:semicolon
)brace
r_do
(brace
r_if
c_cond
(paren
id|allocate_resource
c_func
(paren
id|root
comma
id|res
comma
id|size
comma
id|start
comma
id|end
comma
id|align
comma
l_int|NULL
comma
l_int|NULL
)paren
op_eq
l_int|0
)paren
(brace
id|config_writel
c_func
(paren
id|socket
comma
id|offset
comma
id|res-&gt;start
)paren
suffix:semicolon
id|config_writel
c_func
(paren
id|socket
comma
id|offset
op_plus
l_int|4
comma
id|res-&gt;end
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|size
op_assign
id|size
op_div
l_int|2
suffix:semicolon
id|align
op_assign
id|size
suffix:semicolon
)brace
r_while
c_loop
(paren
id|size
op_ge
id|min
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;yenta %s: no resource of type %x available, trying to continue...&bslash;n&quot;
comma
id|pci_name
c_func
(paren
id|socket-&gt;dev
)paren
comma
id|type
)paren
suffix:semicolon
id|res-&gt;start
op_assign
id|res-&gt;end
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Allocate the bridge mappings for the device..&n; */
DECL|function|yenta_allocate_resources
r_static
r_void
id|yenta_allocate_resources
c_func
(paren
r_struct
id|yenta_socket
op_star
id|socket
)paren
(brace
id|yenta_allocate_res
c_func
(paren
id|socket
comma
l_int|0
comma
id|IORESOURCE_MEM
op_or
id|IORESOURCE_PREFETCH
)paren
suffix:semicolon
id|yenta_allocate_res
c_func
(paren
id|socket
comma
l_int|1
comma
id|IORESOURCE_MEM
)paren
suffix:semicolon
id|yenta_allocate_res
c_func
(paren
id|socket
comma
l_int|2
comma
id|IORESOURCE_IO
)paren
suffix:semicolon
id|yenta_allocate_res
c_func
(paren
id|socket
comma
l_int|3
comma
id|IORESOURCE_IO
)paren
suffix:semicolon
multiline_comment|/* PCI isn&squot;t clever enough to use this one yet */
)brace
multiline_comment|/*&n; * Free the bridge mappings for the device..&n; */
DECL|function|yenta_free_resources
r_static
r_void
id|yenta_free_resources
c_func
(paren
r_struct
id|yenta_socket
op_star
id|socket
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|resource
op_star
id|res
suffix:semicolon
id|res
op_assign
id|socket-&gt;dev-&gt;resource
op_plus
id|PCI_BRIDGE_RESOURCES
op_plus
id|i
suffix:semicolon
r_if
c_cond
(paren
id|res-&gt;start
op_ne
l_int|0
op_logical_and
id|res-&gt;end
op_ne
l_int|0
)paren
id|release_resource
c_func
(paren
id|res
)paren
suffix:semicolon
id|res-&gt;start
op_assign
id|res-&gt;end
op_assign
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Close it down - release our resources and go home..&n; */
DECL|function|yenta_close
r_static
r_void
id|yenta_close
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
r_struct
id|yenta_socket
op_star
id|sock
op_assign
id|pci_get_drvdata
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* we don&squot;t want a dying socket registered */
id|pcmcia_unregister_socket
c_func
(paren
op_amp
id|sock-&gt;socket
)paren
suffix:semicolon
multiline_comment|/* Disable all events so we don&squot;t die in an IRQ storm */
id|cb_writel
c_func
(paren
id|sock
comma
id|CB_SOCKET_MASK
comma
l_int|0x0
)paren
suffix:semicolon
id|exca_writeb
c_func
(paren
id|sock
comma
id|I365_CSCINT
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sock-&gt;cb_irq
)paren
id|free_irq
c_func
(paren
id|sock-&gt;cb_irq
comma
id|sock
)paren
suffix:semicolon
r_else
id|del_timer_sync
c_func
(paren
op_amp
id|sock-&gt;poll_timer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sock-&gt;base
)paren
id|iounmap
c_func
(paren
id|sock-&gt;base
)paren
suffix:semicolon
id|yenta_free_resources
c_func
(paren
id|sock
)paren
suffix:semicolon
id|pci_release_regions
c_func
(paren
id|dev
)paren
suffix:semicolon
id|pci_disable_device
c_func
(paren
id|dev
)paren
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|dev
comma
l_int|NULL
)paren
suffix:semicolon
)brace
DECL|variable|yenta_socket_operations
r_static
r_struct
id|pccard_operations
id|yenta_socket_operations
op_assign
(brace
dot
id|init
op_assign
id|yenta_sock_init
comma
dot
id|suspend
op_assign
id|yenta_sock_suspend
comma
dot
id|get_status
op_assign
id|yenta_get_status
comma
dot
id|get_socket
op_assign
id|yenta_get_socket
comma
dot
id|set_socket
op_assign
id|yenta_set_socket
comma
dot
id|set_io_map
op_assign
id|yenta_set_io_map
comma
dot
id|set_mem_map
op_assign
id|yenta_set_mem_map
comma
)brace
suffix:semicolon
macro_line|#include &quot;ti113x.h&quot;
macro_line|#include &quot;ricoh.h&quot;
macro_line|#include &quot;topic.h&quot;
macro_line|#include &quot;o2micro.h&quot;
r_enum
(brace
DECL|enumerator|CARDBUS_TYPE_DEFAULT
id|CARDBUS_TYPE_DEFAULT
op_assign
op_minus
l_int|1
comma
DECL|enumerator|CARDBUS_TYPE_TI
id|CARDBUS_TYPE_TI
comma
DECL|enumerator|CARDBUS_TYPE_TI113X
id|CARDBUS_TYPE_TI113X
comma
DECL|enumerator|CARDBUS_TYPE_TI12XX
id|CARDBUS_TYPE_TI12XX
comma
DECL|enumerator|CARDBUS_TYPE_TI1250
id|CARDBUS_TYPE_TI1250
comma
DECL|enumerator|CARDBUS_TYPE_RICOH
id|CARDBUS_TYPE_RICOH
comma
DECL|enumerator|CARDBUS_TYPE_TOPIC97
id|CARDBUS_TYPE_TOPIC97
comma
DECL|enumerator|CARDBUS_TYPE_O2MICRO
id|CARDBUS_TYPE_O2MICRO
comma
)brace
suffix:semicolon
multiline_comment|/*&n; * Different cardbus controllers have slightly different&n; * initialization sequences etc details. List them here..&n; */
DECL|variable|cardbus_type
r_static
r_struct
id|cardbus_type
id|cardbus_type
(braket
)braket
op_assign
(brace
(braket
id|CARDBUS_TYPE_TI
)braket
op_assign
(brace
dot
id|override
op_assign
id|ti_override
comma
dot
id|save_state
op_assign
id|ti_save_state
comma
dot
id|restore_state
op_assign
id|ti_restore_state
comma
dot
id|sock_init
op_assign
id|ti_init
comma
)brace
comma
(braket
id|CARDBUS_TYPE_TI113X
)braket
op_assign
(brace
dot
id|override
op_assign
id|ti113x_override
comma
dot
id|save_state
op_assign
id|ti_save_state
comma
dot
id|restore_state
op_assign
id|ti_restore_state
comma
dot
id|sock_init
op_assign
id|ti_init
comma
)brace
comma
(braket
id|CARDBUS_TYPE_TI12XX
)braket
op_assign
(brace
dot
id|override
op_assign
id|ti12xx_override
comma
dot
id|save_state
op_assign
id|ti_save_state
comma
dot
id|restore_state
op_assign
id|ti_restore_state
comma
dot
id|sock_init
op_assign
id|ti_init
comma
)brace
comma
(braket
id|CARDBUS_TYPE_TI1250
)braket
op_assign
(brace
dot
id|override
op_assign
id|ti1250_override
comma
dot
id|save_state
op_assign
id|ti_save_state
comma
dot
id|restore_state
op_assign
id|ti_restore_state
comma
dot
id|sock_init
op_assign
id|ti_init
comma
)brace
comma
(braket
id|CARDBUS_TYPE_RICOH
)braket
op_assign
(brace
dot
id|override
op_assign
id|ricoh_override
comma
dot
id|save_state
op_assign
id|ricoh_save_state
comma
dot
id|restore_state
op_assign
id|ricoh_restore_state
comma
)brace
comma
(braket
id|CARDBUS_TYPE_TOPIC97
)braket
op_assign
(brace
dot
id|override
op_assign
id|topic97_override
comma
)brace
comma
(braket
id|CARDBUS_TYPE_O2MICRO
)braket
op_assign
(brace
dot
id|override
op_assign
id|o2micro_override
comma
dot
id|restore_state
op_assign
id|o2micro_restore_state
comma
)brace
comma
)brace
suffix:semicolon
multiline_comment|/*&n; * Only probe &quot;regular&quot; interrupts, don&squot;t&n; * touch dangerous spots like the mouse irq,&n; * because there are mice that apparently&n; * get really confused if they get fondled&n; * too intimately.&n; *&n; * Default to 11, 10, 9, 7, 6, 5, 4, 3.&n; */
DECL|variable|isa_interrupts
r_static
id|u32
id|isa_interrupts
op_assign
l_int|0x0ef8
suffix:semicolon
DECL|function|yenta_probe_irq
r_static
r_int
r_int
id|yenta_probe_irq
c_func
(paren
r_struct
id|yenta_socket
op_star
id|socket
comma
id|u32
id|isa_irq_mask
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
r_int
id|val
suffix:semicolon
id|u16
id|bridge_ctrl
suffix:semicolon
id|u32
id|mask
suffix:semicolon
multiline_comment|/* Set up ISA irq routing to probe the ISA irqs.. */
id|bridge_ctrl
op_assign
id|config_readw
c_func
(paren
id|socket
comma
id|CB_BRIDGE_CONTROL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|bridge_ctrl
op_amp
id|CB_BRIDGE_INTR
)paren
)paren
(brace
id|bridge_ctrl
op_or_assign
id|CB_BRIDGE_INTR
suffix:semicolon
id|config_writew
c_func
(paren
id|socket
comma
id|CB_BRIDGE_CONTROL
comma
id|bridge_ctrl
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Probe for usable interrupts using the force&n;&t; * register to generate bogus card status events.&n;&t; */
id|cb_writel
c_func
(paren
id|socket
comma
id|CB_SOCKET_EVENT
comma
op_minus
l_int|1
)paren
suffix:semicolon
id|cb_writel
c_func
(paren
id|socket
comma
id|CB_SOCKET_MASK
comma
id|CB_CSTSMASK
)paren
suffix:semicolon
id|exca_writeb
c_func
(paren
id|socket
comma
id|I365_CSCINT
comma
l_int|0
)paren
suffix:semicolon
id|val
op_assign
id|probe_irq_on
c_func
(paren
)paren
op_amp
id|isa_irq_mask
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
(paren
id|val
op_rshift
id|i
)paren
op_amp
l_int|1
)paren
)paren
r_continue
suffix:semicolon
id|exca_writeb
c_func
(paren
id|socket
comma
id|I365_CSCINT
comma
id|I365_CSC_STSCHG
op_or
(paren
id|i
op_lshift
l_int|4
)paren
)paren
suffix:semicolon
id|cb_writel
c_func
(paren
id|socket
comma
id|CB_SOCKET_FORCE
comma
id|CB_FCARDSTS
)paren
suffix:semicolon
id|udelay
c_func
(paren
l_int|100
)paren
suffix:semicolon
id|cb_writel
c_func
(paren
id|socket
comma
id|CB_SOCKET_EVENT
comma
op_minus
l_int|1
)paren
suffix:semicolon
)brace
id|cb_writel
c_func
(paren
id|socket
comma
id|CB_SOCKET_MASK
comma
l_int|0
)paren
suffix:semicolon
id|exca_writeb
c_func
(paren
id|socket
comma
id|I365_CSCINT
comma
l_int|0
)paren
suffix:semicolon
id|mask
op_assign
id|probe_irq_mask
c_func
(paren
id|val
)paren
op_amp
l_int|0xffff
suffix:semicolon
id|bridge_ctrl
op_and_assign
op_complement
id|CB_BRIDGE_INTR
suffix:semicolon
id|config_writew
c_func
(paren
id|socket
comma
id|CB_BRIDGE_CONTROL
comma
id|bridge_ctrl
)paren
suffix:semicolon
r_return
id|mask
suffix:semicolon
)brace
multiline_comment|/* interrupt handler, only used during probing */
DECL|function|yenta_probe_handler
r_static
id|irqreturn_t
id|yenta_probe_handler
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev_id
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_struct
id|yenta_socket
op_star
id|socket
op_assign
(paren
r_struct
id|yenta_socket
op_star
)paren
id|dev_id
suffix:semicolon
id|u8
id|csc
suffix:semicolon
id|u32
id|cb_event
suffix:semicolon
multiline_comment|/* Clear interrupt status for the event */
id|cb_event
op_assign
id|cb_readl
c_func
(paren
id|socket
comma
id|CB_SOCKET_EVENT
)paren
suffix:semicolon
id|cb_writel
c_func
(paren
id|socket
comma
id|CB_SOCKET_EVENT
comma
op_minus
l_int|1
)paren
suffix:semicolon
id|csc
op_assign
id|exca_readb
c_func
(paren
id|socket
comma
id|I365_CSC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cb_event
op_logical_or
id|csc
)paren
(brace
id|socket-&gt;probe_status
op_assign
l_int|1
suffix:semicolon
r_return
id|IRQ_HANDLED
suffix:semicolon
)brace
r_return
id|IRQ_NONE
suffix:semicolon
)brace
multiline_comment|/* probes the PCI interrupt, use only on override functions */
DECL|function|yenta_probe_cb_irq
r_static
r_int
id|yenta_probe_cb_irq
c_func
(paren
r_struct
id|yenta_socket
op_star
id|socket
)paren
(brace
id|u16
id|bridge_ctrl
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|socket-&gt;cb_irq
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|socket-&gt;probe_status
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* disable ISA interrupts */
id|bridge_ctrl
op_assign
id|config_readw
c_func
(paren
id|socket
comma
id|CB_BRIDGE_CONTROL
)paren
suffix:semicolon
id|bridge_ctrl
op_and_assign
op_complement
id|CB_BRIDGE_INTR
suffix:semicolon
id|config_writew
c_func
(paren
id|socket
comma
id|CB_BRIDGE_CONTROL
comma
id|bridge_ctrl
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|socket-&gt;cb_irq
comma
id|yenta_probe_handler
comma
id|SA_SHIRQ
comma
l_string|&quot;yenta&quot;
comma
id|socket
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Yenta: request_irq() in yenta_probe_cb_irq() failed!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* generate interrupt, wait */
id|exca_writeb
c_func
(paren
id|socket
comma
id|I365_CSCINT
comma
id|I365_CSC_STSCHG
)paren
suffix:semicolon
id|cb_writel
c_func
(paren
id|socket
comma
id|CB_SOCKET_EVENT
comma
op_minus
l_int|1
)paren
suffix:semicolon
id|cb_writel
c_func
(paren
id|socket
comma
id|CB_SOCKET_MASK
comma
id|CB_CSTSMASK
)paren
suffix:semicolon
id|cb_writel
c_func
(paren
id|socket
comma
id|CB_SOCKET_FORCE
comma
id|CB_FCARDSTS
)paren
suffix:semicolon
id|msleep
c_func
(paren
l_int|100
)paren
suffix:semicolon
multiline_comment|/* disable interrupts */
id|cb_writel
c_func
(paren
id|socket
comma
id|CB_SOCKET_MASK
comma
l_int|0
)paren
suffix:semicolon
id|exca_writeb
c_func
(paren
id|socket
comma
id|I365_CSCINT
comma
l_int|0
)paren
suffix:semicolon
id|cb_writel
c_func
(paren
id|socket
comma
id|CB_SOCKET_EVENT
comma
op_minus
l_int|1
)paren
suffix:semicolon
id|exca_readb
c_func
(paren
id|socket
comma
id|I365_CSC
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|socket-&gt;cb_irq
comma
id|socket
)paren
suffix:semicolon
r_return
(paren
r_int
)paren
id|socket-&gt;probe_status
suffix:semicolon
)brace
multiline_comment|/*&n; * Set static data that doesn&squot;t need re-initializing..&n; */
DECL|function|yenta_get_socket_capabilities
r_static
r_void
id|yenta_get_socket_capabilities
c_func
(paren
r_struct
id|yenta_socket
op_star
id|socket
comma
id|u32
id|isa_irq_mask
)paren
(brace
id|socket-&gt;socket.features
op_or_assign
id|SS_CAP_PAGE_REGS
op_or
id|SS_CAP_PCCARD
op_or
id|SS_CAP_CARDBUS
suffix:semicolon
id|socket-&gt;socket.map_size
op_assign
l_int|0x1000
suffix:semicolon
id|socket-&gt;socket.pci_irq
op_assign
id|socket-&gt;cb_irq
suffix:semicolon
id|socket-&gt;socket.irq_mask
op_assign
id|yenta_probe_irq
c_func
(paren
id|socket
comma
id|isa_irq_mask
)paren
suffix:semicolon
id|socket-&gt;socket.cb_dev
op_assign
id|socket-&gt;dev
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Yenta: ISA IRQ mask 0x%04x, PCI irq %d&bslash;n&quot;
comma
id|socket-&gt;socket.irq_mask
comma
id|socket-&gt;cb_irq
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Initialize the standard cardbus registers&n; */
DECL|function|yenta_config_init
r_static
r_void
id|yenta_config_init
c_func
(paren
r_struct
id|yenta_socket
op_star
id|socket
)paren
(brace
id|u16
id|bridge
suffix:semicolon
r_struct
id|pci_dev
op_star
id|dev
op_assign
id|socket-&gt;dev
suffix:semicolon
id|pci_set_power_state
c_func
(paren
id|socket-&gt;dev
comma
l_int|0
)paren
suffix:semicolon
id|config_writel
c_func
(paren
id|socket
comma
id|CB_LEGACY_MODE_BASE
comma
l_int|0
)paren
suffix:semicolon
id|config_writel
c_func
(paren
id|socket
comma
id|PCI_BASE_ADDRESS_0
comma
id|dev-&gt;resource
(braket
l_int|0
)braket
dot
id|start
)paren
suffix:semicolon
id|config_writew
c_func
(paren
id|socket
comma
id|PCI_COMMAND
comma
id|PCI_COMMAND_IO
op_or
id|PCI_COMMAND_MEMORY
op_or
id|PCI_COMMAND_MASTER
op_or
id|PCI_COMMAND_WAIT
)paren
suffix:semicolon
multiline_comment|/* MAGIC NUMBERS! Fixme */
id|config_writeb
c_func
(paren
id|socket
comma
id|PCI_CACHE_LINE_SIZE
comma
id|L1_CACHE_BYTES
op_div
l_int|4
)paren
suffix:semicolon
id|config_writeb
c_func
(paren
id|socket
comma
id|PCI_LATENCY_TIMER
comma
l_int|168
)paren
suffix:semicolon
id|config_writel
c_func
(paren
id|socket
comma
id|PCI_PRIMARY_BUS
comma
(paren
l_int|176
op_lshift
l_int|24
)paren
op_or
multiline_comment|/* sec. latency timer */
(paren
id|dev-&gt;subordinate-&gt;subordinate
op_lshift
l_int|16
)paren
op_or
multiline_comment|/* subordinate bus */
(paren
id|dev-&gt;subordinate-&gt;secondary
op_lshift
l_int|8
)paren
op_or
multiline_comment|/* secondary bus */
id|dev-&gt;subordinate-&gt;primary
)paren
suffix:semicolon
multiline_comment|/* primary bus */
multiline_comment|/*&n;&t; * Set up the bridging state:&n;&t; *  - enable write posting.&n;&t; *  - memory window 0 prefetchable, window 1 non-prefetchable&n;&t; *  - PCI interrupts enabled if a PCI interrupt exists..&n;&t; */
id|bridge
op_assign
id|config_readw
c_func
(paren
id|socket
comma
id|CB_BRIDGE_CONTROL
)paren
suffix:semicolon
id|bridge
op_and_assign
op_complement
(paren
id|CB_BRIDGE_CRST
op_or
id|CB_BRIDGE_PREFETCH1
op_or
id|CB_BRIDGE_INTR
op_or
id|CB_BRIDGE_ISAEN
op_or
id|CB_BRIDGE_VGAEN
)paren
suffix:semicolon
id|bridge
op_or_assign
id|CB_BRIDGE_PREFETCH0
op_or
id|CB_BRIDGE_POSTEN
op_or
id|CB_BRIDGE_INTR
suffix:semicolon
id|config_writew
c_func
(paren
id|socket
comma
id|CB_BRIDGE_CONTROL
comma
id|bridge
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Initialize a cardbus controller. Make sure we have a usable&n; * interrupt, and that we can map the cardbus area. Fill in the&n; * socket information structure..&n; */
DECL|function|yenta_probe
r_static
r_int
id|__devinit
id|yenta_probe
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_const
r_struct
id|pci_device_id
op_star
id|id
)paren
(brace
r_struct
id|yenta_socket
op_star
id|socket
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|socket
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|yenta_socket
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|socket
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|socket
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|socket
)paren
)paren
suffix:semicolon
multiline_comment|/* prepare pcmcia_socket */
id|socket-&gt;socket.ops
op_assign
op_amp
id|yenta_socket_operations
suffix:semicolon
id|socket-&gt;socket.dev.dev
op_assign
op_amp
id|dev-&gt;dev
suffix:semicolon
id|socket-&gt;socket.driver_data
op_assign
id|socket
suffix:semicolon
id|socket-&gt;socket.owner
op_assign
id|THIS_MODULE
suffix:semicolon
multiline_comment|/* prepare struct yenta_socket */
id|socket-&gt;dev
op_assign
id|dev
suffix:semicolon
id|pci_set_drvdata
c_func
(paren
id|dev
comma
id|socket
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Do some basic sanity checking..&n;&t; */
r_if
c_cond
(paren
id|pci_enable_device
c_func
(paren
id|dev
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_goto
id|free
suffix:semicolon
)brace
id|ret
op_assign
id|pci_request_regions
c_func
(paren
id|dev
comma
l_string|&quot;yenta_socket&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_goto
id|disable
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pci_resource_start
c_func
(paren
id|dev
comma
l_int|0
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;No cardbus resource!&bslash;n&quot;
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_goto
id|release
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Ok, start setup.. Map the cardbus registers,&n;&t; * and request the IRQ.&n;&t; */
id|socket-&gt;base
op_assign
id|ioremap
c_func
(paren
id|pci_resource_start
c_func
(paren
id|dev
comma
l_int|0
)paren
comma
l_int|0x1000
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|socket-&gt;base
)paren
(brace
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|release
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * report the subsystem vendor and device for help debugging&n;&t; * the irq stuff...&n;&t; */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Yenta: CardBus bridge found at %s [%04x:%04x]&bslash;n&quot;
comma
id|dev-&gt;slot_name
comma
id|dev-&gt;subsystem_vendor
comma
id|dev-&gt;subsystem_device
)paren
suffix:semicolon
id|yenta_config_init
c_func
(paren
id|socket
)paren
suffix:semicolon
multiline_comment|/* Disable all events */
id|cb_writel
c_func
(paren
id|socket
comma
id|CB_SOCKET_MASK
comma
l_int|0x0
)paren
suffix:semicolon
multiline_comment|/* Set up the bridge regions.. */
id|yenta_allocate_resources
c_func
(paren
id|socket
)paren
suffix:semicolon
id|socket-&gt;cb_irq
op_assign
id|dev-&gt;irq
suffix:semicolon
multiline_comment|/* Do we have special options for the device? */
r_if
c_cond
(paren
id|id-&gt;driver_data
op_ne
id|CARDBUS_TYPE_DEFAULT
op_logical_and
id|id-&gt;driver_data
OL
id|ARRAY_SIZE
c_func
(paren
id|cardbus_type
)paren
)paren
(brace
id|socket-&gt;type
op_assign
op_amp
id|cardbus_type
(braket
id|id-&gt;driver_data
)braket
suffix:semicolon
id|ret
op_assign
id|socket-&gt;type
op_member_access_from_pointer
id|override
c_func
(paren
id|socket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
r_goto
id|unmap
suffix:semicolon
)brace
multiline_comment|/* We must finish initialization here */
r_if
c_cond
(paren
op_logical_neg
id|socket-&gt;cb_irq
op_logical_or
id|request_irq
c_func
(paren
id|socket-&gt;cb_irq
comma
id|yenta_interrupt
comma
id|SA_SHIRQ
comma
l_string|&quot;yenta&quot;
comma
id|socket
)paren
)paren
(brace
multiline_comment|/* No IRQ or request_irq failed. Poll */
id|socket-&gt;cb_irq
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* But zero is a valid IRQ number. */
id|init_timer
c_func
(paren
op_amp
id|socket-&gt;poll_timer
)paren
suffix:semicolon
id|socket-&gt;poll_timer.function
op_assign
id|yenta_interrupt_wrapper
suffix:semicolon
id|socket-&gt;poll_timer.data
op_assign
(paren
r_int
r_int
)paren
id|socket
suffix:semicolon
id|socket-&gt;poll_timer.expires
op_assign
id|jiffies
op_plus
id|HZ
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|socket-&gt;poll_timer
)paren
suffix:semicolon
)brace
multiline_comment|/* Figure out what the dang thing can do for the PCMCIA layer... */
id|yenta_get_socket_capabilities
c_func
(paren
id|socket
comma
id|isa_interrupts
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;Socket status: %08x&bslash;n&quot;
comma
id|cb_readl
c_func
(paren
id|socket
comma
id|CB_SOCKET_STATE
)paren
)paren
suffix:semicolon
multiline_comment|/* Register it with the pcmcia layer.. */
id|ret
op_assign
id|pcmcia_register_socket
c_func
(paren
op_amp
id|socket-&gt;socket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
l_int|0
)paren
r_goto
id|out
suffix:semicolon
id|unmap
suffix:colon
id|iounmap
c_func
(paren
id|socket-&gt;base
)paren
suffix:semicolon
id|release
suffix:colon
id|pci_release_regions
c_func
(paren
id|dev
)paren
suffix:semicolon
id|disable
suffix:colon
id|pci_disable_device
c_func
(paren
id|dev
)paren
suffix:semicolon
id|free
suffix:colon
id|kfree
c_func
(paren
id|socket
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|yenta_dev_suspend
r_static
r_int
id|yenta_dev_suspend
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
id|u32
id|state
)paren
(brace
r_struct
id|yenta_socket
op_star
id|socket
op_assign
id|pci_get_drvdata
c_func
(paren
id|dev
)paren
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|ret
op_assign
id|pcmcia_socket_dev_suspend
c_func
(paren
op_amp
id|dev-&gt;dev
comma
id|state
)paren
suffix:semicolon
r_if
c_cond
(paren
id|socket
)paren
(brace
r_if
c_cond
(paren
id|socket-&gt;type
op_logical_and
id|socket-&gt;type-&gt;save_state
)paren
id|socket-&gt;type
op_member_access_from_pointer
id|save_state
c_func
(paren
id|socket
)paren
suffix:semicolon
multiline_comment|/* FIXME: pci_save_state needs to have a better interface */
id|pci_save_state
c_func
(paren
id|dev
)paren
suffix:semicolon
id|pci_read_config_dword
c_func
(paren
id|dev
comma
l_int|16
op_star
l_int|4
comma
op_amp
id|socket-&gt;saved_state
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|pci_read_config_dword
c_func
(paren
id|dev
comma
l_int|17
op_star
l_int|4
comma
op_amp
id|socket-&gt;saved_state
(braket
l_int|1
)braket
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Some laptops (IBM T22) do not like us putting the Cardbus&n;&t;&t; * bridge into D3.  At a guess, some other laptop will&n;&t;&t; * probably require this, so leave it commented out for now.&n;&t;&t; */
multiline_comment|/* pci_set_power_state(dev, 3); */
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|function|yenta_dev_resume
r_static
r_int
id|yenta_dev_resume
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
r_struct
id|yenta_socket
op_star
id|socket
op_assign
id|pci_get_drvdata
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|socket
)paren
(brace
id|pci_set_power_state
c_func
(paren
id|dev
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* FIXME: pci_restore_state needs to have a better interface */
id|pci_restore_state
c_func
(paren
id|dev
)paren
suffix:semicolon
id|pci_write_config_dword
c_func
(paren
id|dev
comma
l_int|16
op_star
l_int|4
comma
id|socket-&gt;saved_state
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|pci_write_config_dword
c_func
(paren
id|dev
comma
l_int|17
op_star
l_int|4
comma
id|socket-&gt;saved_state
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|socket-&gt;type
op_logical_and
id|socket-&gt;type-&gt;restore_state
)paren
id|socket-&gt;type
op_member_access_from_pointer
id|restore_state
c_func
(paren
id|socket
)paren
suffix:semicolon
)brace
r_return
id|pcmcia_socket_dev_resume
c_func
(paren
op_amp
id|dev-&gt;dev
)paren
suffix:semicolon
)brace
DECL|macro|CB_ID
mdefine_line|#define CB_ID(vend,dev,type)&t;&t;&t;&t;&bslash;&n;&t;{&t;&t;&t;&t;&t;&t;&bslash;&n;&t;&t;.vendor&t;&t;= vend,&t;&t;&t;&bslash;&n;&t;&t;.device&t;&t;= dev,&t;&t;&t;&bslash;&n;&t;&t;.subvendor&t;= PCI_ANY_ID,&t;&t;&bslash;&n;&t;&t;.subdevice&t;= PCI_ANY_ID,&t;&t;&bslash;&n;&t;&t;.class&t;&t;= PCI_CLASS_BRIDGE_CARDBUS &lt;&lt; 8, &bslash;&n;&t;&t;.class_mask&t;= ~0,&t;&t;&t;&bslash;&n;&t;&t;.driver_data&t;= CARDBUS_TYPE_##type,&t;&bslash;&n;&t;}
DECL|variable|yenta_table
r_static
r_struct
id|pci_device_id
id|yenta_table
(braket
)braket
op_assign
(brace
id|CB_ID
c_func
(paren
id|PCI_VENDOR_ID_TI
comma
id|PCI_DEVICE_ID_TI_1031
comma
id|TI
)paren
comma
multiline_comment|/*&n;&t; * TBD: Check if these TI variants can use more&n;&t; * advanced overrides instead.  (I can&squot;t get the&n;&t; * data sheets for these devices. --rmk)&n;&t; */
id|CB_ID
c_func
(paren
id|PCI_VENDOR_ID_TI
comma
id|PCI_DEVICE_ID_TI_1210
comma
id|TI
)paren
comma
id|CB_ID
c_func
(paren
id|PCI_VENDOR_ID_TI
comma
id|PCI_DEVICE_ID_TI_1130
comma
id|TI113X
)paren
comma
id|CB_ID
c_func
(paren
id|PCI_VENDOR_ID_TI
comma
id|PCI_DEVICE_ID_TI_1131
comma
id|TI113X
)paren
comma
id|CB_ID
c_func
(paren
id|PCI_VENDOR_ID_TI
comma
id|PCI_DEVICE_ID_TI_1211
comma
id|TI12XX
)paren
comma
id|CB_ID
c_func
(paren
id|PCI_VENDOR_ID_TI
comma
id|PCI_DEVICE_ID_TI_1220
comma
id|TI12XX
)paren
comma
id|CB_ID
c_func
(paren
id|PCI_VENDOR_ID_TI
comma
id|PCI_DEVICE_ID_TI_1221
comma
id|TI12XX
)paren
comma
id|CB_ID
c_func
(paren
id|PCI_VENDOR_ID_TI
comma
id|PCI_DEVICE_ID_TI_1225
comma
id|TI12XX
)paren
comma
id|CB_ID
c_func
(paren
id|PCI_VENDOR_ID_TI
comma
id|PCI_DEVICE_ID_TI_1251A
comma
id|TI12XX
)paren
comma
id|CB_ID
c_func
(paren
id|PCI_VENDOR_ID_TI
comma
id|PCI_DEVICE_ID_TI_1251B
comma
id|TI12XX
)paren
comma
id|CB_ID
c_func
(paren
id|PCI_VENDOR_ID_TI
comma
id|PCI_DEVICE_ID_TI_1420
comma
id|TI12XX
)paren
comma
id|CB_ID
c_func
(paren
id|PCI_VENDOR_ID_TI
comma
id|PCI_DEVICE_ID_TI_1450
comma
id|TI12XX
)paren
comma
id|CB_ID
c_func
(paren
id|PCI_VENDOR_ID_TI
comma
id|PCI_DEVICE_ID_TI_1451A
comma
id|TI12XX
)paren
comma
id|CB_ID
c_func
(paren
id|PCI_VENDOR_ID_TI
comma
id|PCI_DEVICE_ID_TI_1510
comma
id|TI12XX
)paren
comma
id|CB_ID
c_func
(paren
id|PCI_VENDOR_ID_TI
comma
id|PCI_DEVICE_ID_TI_1520
comma
id|TI12XX
)paren
comma
id|CB_ID
c_func
(paren
id|PCI_VENDOR_ID_TI
comma
id|PCI_DEVICE_ID_TI_1620
comma
id|TI12XX
)paren
comma
id|CB_ID
c_func
(paren
id|PCI_VENDOR_ID_TI
comma
id|PCI_DEVICE_ID_TI_4410
comma
id|TI12XX
)paren
comma
id|CB_ID
c_func
(paren
id|PCI_VENDOR_ID_TI
comma
id|PCI_DEVICE_ID_TI_4450
comma
id|TI12XX
)paren
comma
id|CB_ID
c_func
(paren
id|PCI_VENDOR_ID_TI
comma
id|PCI_DEVICE_ID_TI_4451
comma
id|TI12XX
)paren
comma
id|CB_ID
c_func
(paren
id|PCI_VENDOR_ID_TI
comma
id|PCI_DEVICE_ID_TI_4520
comma
id|TI12XX
)paren
comma
id|CB_ID
c_func
(paren
id|PCI_VENDOR_ID_TI
comma
id|PCI_DEVICE_ID_TI_1250
comma
id|TI1250
)paren
comma
id|CB_ID
c_func
(paren
id|PCI_VENDOR_ID_TI
comma
id|PCI_DEVICE_ID_TI_1410
comma
id|TI1250
)paren
comma
id|CB_ID
c_func
(paren
id|PCI_VENDOR_ID_ENE
comma
id|PCI_DEVICE_ID_ENE_1211
comma
id|TI12XX
)paren
comma
id|CB_ID
c_func
(paren
id|PCI_VENDOR_ID_ENE
comma
id|PCI_DEVICE_ID_ENE_1225
comma
id|TI12XX
)paren
comma
id|CB_ID
c_func
(paren
id|PCI_VENDOR_ID_ENE
comma
id|PCI_DEVICE_ID_ENE_1410
comma
id|TI1250
)paren
comma
id|CB_ID
c_func
(paren
id|PCI_VENDOR_ID_ENE
comma
id|PCI_DEVICE_ID_ENE_1420
comma
id|TI12XX
)paren
comma
id|CB_ID
c_func
(paren
id|PCI_VENDOR_ID_RICOH
comma
id|PCI_DEVICE_ID_RICOH_RL5C465
comma
id|RICOH
)paren
comma
id|CB_ID
c_func
(paren
id|PCI_VENDOR_ID_RICOH
comma
id|PCI_DEVICE_ID_RICOH_RL5C466
comma
id|RICOH
)paren
comma
id|CB_ID
c_func
(paren
id|PCI_VENDOR_ID_RICOH
comma
id|PCI_DEVICE_ID_RICOH_RL5C475
comma
id|RICOH
)paren
comma
id|CB_ID
c_func
(paren
id|PCI_VENDOR_ID_RICOH
comma
id|PCI_DEVICE_ID_RICOH_RL5C476
comma
id|RICOH
)paren
comma
id|CB_ID
c_func
(paren
id|PCI_VENDOR_ID_RICOH
comma
id|PCI_DEVICE_ID_RICOH_RL5C478
comma
id|RICOH
)paren
comma
id|CB_ID
c_func
(paren
id|PCI_VENDOR_ID_TOSHIBA
comma
id|PCI_DEVICE_ID_TOSHIBA_TOPIC97
comma
id|TOPIC97
)paren
comma
id|CB_ID
c_func
(paren
id|PCI_VENDOR_ID_TOSHIBA
comma
id|PCI_DEVICE_ID_TOSHIBA_TOPIC100
comma
id|TOPIC97
)paren
comma
id|CB_ID
c_func
(paren
id|PCI_VENDOR_ID_O2
comma
id|PCI_ANY_ID
comma
id|O2MICRO
)paren
comma
multiline_comment|/* match any cardbus bridge */
id|CB_ID
c_func
(paren
id|PCI_ANY_ID
comma
id|PCI_ANY_ID
comma
id|DEFAULT
)paren
comma
(brace
multiline_comment|/* all zeroes */
)brace
)brace
suffix:semicolon
id|MODULE_DEVICE_TABLE
c_func
(paren
id|pci
comma
id|yenta_table
)paren
suffix:semicolon
DECL|variable|yenta_cardbus_driver
r_static
r_struct
id|pci_driver
id|yenta_cardbus_driver
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;yenta_cardbus&quot;
comma
dot
id|id_table
op_assign
id|yenta_table
comma
dot
id|probe
op_assign
id|yenta_probe
comma
dot
id|remove
op_assign
id|__devexit_p
c_func
(paren
id|yenta_close
)paren
comma
dot
id|suspend
op_assign
id|yenta_dev_suspend
comma
dot
id|resume
op_assign
id|yenta_dev_resume
comma
)brace
suffix:semicolon
DECL|function|yenta_socket_init
r_static
r_int
id|__init
id|yenta_socket_init
c_func
(paren
r_void
)paren
(brace
r_return
id|pci_register_driver
(paren
op_amp
id|yenta_cardbus_driver
)paren
suffix:semicolon
)brace
DECL|function|yenta_socket_exit
r_static
r_void
id|__exit
id|yenta_socket_exit
(paren
r_void
)paren
(brace
id|pci_unregister_driver
(paren
op_amp
id|yenta_cardbus_driver
)paren
suffix:semicolon
)brace
DECL|variable|yenta_socket_init
id|module_init
c_func
(paren
id|yenta_socket_init
)paren
suffix:semicolon
DECL|variable|yenta_socket_exit
id|module_exit
c_func
(paren
id|yenta_socket_exit
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
eof
