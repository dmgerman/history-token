multiline_comment|/* &n; * Driver for Intel I82092AA PCI-PCMCIA bridge.&n; *&n; * (C) 2001 Red Hat, Inc.&n; *&n; * Author: Arjan Van De Ven &lt;arjanv@redhat.com&gt;&n; * Loosly based on i82365.c from the pcmcia-cs package&n; *&n; * $Id: i82092aa.c,v 1.2 2001/10/23 14:43:34 arjanv Exp $&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;pcmcia/cs_types.h&gt;
macro_line|#include &lt;pcmcia/ss.h&gt;
macro_line|#include &lt;pcmcia/cs.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &quot;i82092aa.h&quot;
macro_line|#include &quot;i82365.h&quot;
multiline_comment|/* PCI core routines */
DECL|variable|i82092aa_pci_ids
r_static
r_struct
id|pci_device_id
id|i82092aa_pci_ids
(braket
)braket
op_assign
(brace
(brace
id|vendor
suffix:colon
id|PCI_VENDOR_ID_INTEL
comma
id|device
suffix:colon
id|PCI_DEVICE_ID_INTEL_82092AA_0
comma
id|subvendor
suffix:colon
id|PCI_ANY_ID
comma
id|subdevice
suffix:colon
id|PCI_ANY_ID
comma
r_class
suffix:colon
l_int|0
comma
id|class_mask
suffix:colon
l_int|0
comma
)brace
comma
(brace
)brace
)brace
suffix:semicolon
DECL|variable|i82092aa_pci_drv
r_static
r_struct
id|pci_driver
id|i82092aa_pci_drv
op_assign
(brace
id|name
suffix:colon
l_string|&quot;i82092aa&quot;
comma
id|id_table
suffix:colon
id|i82092aa_pci_ids
comma
id|probe
suffix:colon
id|i82092aa_pci_probe
comma
id|remove
suffix:colon
id|i82092aa_pci_remove
comma
id|suspend
suffix:colon
l_int|NULL
comma
id|resume
suffix:colon
l_int|NULL
)brace
suffix:semicolon
multiline_comment|/* the pccard structure and its functions */
DECL|variable|i82092aa_operations
r_static
r_struct
id|pccard_operations
id|i82092aa_operations
op_assign
(brace
id|init
suffix:colon
id|i82092aa_init
comma
id|suspend
suffix:colon
id|i82092aa_suspend
comma
id|register_callback
suffix:colon
id|i82092aa_register_callback
comma
id|inquire_socket
suffix:colon
id|i82092aa_inquire_socket
comma
id|get_status
suffix:colon
id|i82092aa_get_status
comma
id|get_socket
suffix:colon
id|i82092aa_get_socket
comma
id|set_socket
suffix:colon
id|i82092aa_set_socket
comma
id|get_io_map
suffix:colon
id|i82092aa_get_io_map
comma
id|set_io_map
suffix:colon
id|i82092aa_set_io_map
comma
id|get_mem_map
suffix:colon
id|i82092aa_get_mem_map
comma
id|set_mem_map
suffix:colon
id|i82092aa_set_mem_map
comma
id|proc_setup
suffix:colon
id|i82092aa_proc_setup
comma
)brace
suffix:semicolon
multiline_comment|/* The card can do upto 4 sockets, allocate a structure for each of them */
DECL|struct|socket_info
r_struct
id|socket_info
(brace
DECL|member|card_state
r_int
id|card_state
suffix:semicolon
multiline_comment|/*  0 = no socket,&n;&t;&t;&t;&t;    1 = empty socket, &n;&t;&t;&t;&t;    2 = card but not initialized,&n;&t;&t;&t;&t;    3 = operational card */
DECL|member|io_base
r_int
id|io_base
suffix:semicolon
multiline_comment|/* base io address of the socket */
DECL|member|cap
id|socket_cap_t
id|cap
suffix:semicolon
DECL|member|pending_events
r_int
r_int
id|pending_events
suffix:semicolon
multiline_comment|/* Pending events on this interface */
DECL|member|handler
r_void
(paren
op_star
id|handler
)paren
(paren
r_void
op_star
id|info
comma
id|u_int
id|events
)paren
suffix:semicolon
multiline_comment|/* callback to the driver of the card */
DECL|member|info
r_void
op_star
id|info
suffix:semicolon
multiline_comment|/* to be passed to the handler */
DECL|member|dev
r_struct
id|pci_dev
op_star
id|dev
suffix:semicolon
multiline_comment|/* The PCI device for the socket */
)brace
suffix:semicolon
DECL|macro|MAX_SOCKETS
mdefine_line|#define MAX_SOCKETS 4
DECL|variable|sockets
r_static
r_struct
id|socket_info
id|sockets
(braket
id|MAX_SOCKETS
)braket
suffix:semicolon
DECL|variable|socket_count
r_static
r_int
id|socket_count
suffix:semicolon
multiline_comment|/* shortcut */
DECL|function|i82092aa_pci_probe
r_static
r_int
id|__init
id|i82092aa_pci_probe
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
comma
r_const
r_struct
id|pci_device_id
op_star
id|id
)paren
(brace
r_int
r_char
id|configbyte
suffix:semicolon
r_int
id|i
suffix:semicolon
id|enter
c_func
(paren
l_string|&quot;i82092aa_pci_probe&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pci_enable_device
c_func
(paren
id|dev
)paren
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|pci_read_config_byte
c_func
(paren
id|dev
comma
l_int|0x40
comma
op_amp
id|configbyte
)paren
suffix:semicolon
multiline_comment|/* PCI Configuration Control */
r_switch
c_cond
(paren
id|configbyte
op_amp
l_int|6
)paren
(brace
r_case
l_int|0
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;i82092aa: configured as a 2 socket device.&bslash;n&quot;
)paren
suffix:semicolon
id|socket_count
op_assign
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;i82092aa: configured as a 1 socket device.&bslash;n&quot;
)paren
suffix:semicolon
id|socket_count
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|4
suffix:colon
r_case
l_int|6
suffix:colon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;i82092aa: configured as a 4 socket device.&bslash;n&quot;
)paren
suffix:semicolon
id|socket_count
op_assign
l_int|4
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;i82092aa: Oops, you did something we didn&squot;t think of.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
r_break
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|socket_count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|sockets
(braket
id|i
)braket
dot
id|card_state
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* 1 = present but empty */
id|sockets
(braket
id|i
)braket
dot
id|io_base
op_assign
(paren
id|dev-&gt;resource
(braket
l_int|0
)braket
dot
id|start
op_amp
op_complement
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sockets
(braket
id|i
)braket
dot
id|io_base
OG
l_int|0
)paren
id|request_region
c_func
(paren
id|sockets
(braket
id|i
)braket
dot
id|io_base
comma
l_int|2
comma
l_string|&quot;i82092aa&quot;
)paren
suffix:semicolon
id|sockets
(braket
id|i
)braket
dot
id|cap.features
op_or_assign
id|SS_CAP_PCCARD
suffix:semicolon
id|sockets
(braket
id|i
)braket
dot
id|cap.map_size
op_assign
l_int|0x1000
suffix:semicolon
id|sockets
(braket
id|i
)braket
dot
id|cap.irq_mask
op_assign
l_int|0
suffix:semicolon
id|sockets
(braket
id|i
)braket
dot
id|cap.pci_irq
op_assign
id|dev-&gt;irq
suffix:semicolon
r_if
c_cond
(paren
id|card_present
c_func
(paren
id|i
)paren
)paren
(brace
id|sockets
(braket
id|i
)braket
dot
id|card_state
op_assign
l_int|3
suffix:semicolon
id|dprintk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;i82092aa: slot %i is occupied&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
)brace
r_else
(brace
id|dprintk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;i82092aa: slot %i is vacant&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Now, specifiy that all interrupts are to be done as PCI interrupts */
id|configbyte
op_assign
l_int|0xFF
suffix:semicolon
multiline_comment|/* bitmask, one bit per event, 1 = PCI interrupt, 0 = ISA interrupt */
id|pci_write_config_byte
c_func
(paren
id|dev
comma
l_int|0x50
comma
id|configbyte
)paren
suffix:semicolon
multiline_comment|/* PCI Interrupt Routing Register */
multiline_comment|/* Register the interrupt handler */
id|dprintk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Requesting interrupt %i &bslash;n&quot;
comma
id|dev-&gt;irq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_irq
c_func
(paren
id|dev-&gt;irq
comma
id|i82092aa_interrupt
comma
id|SA_SHIRQ
comma
l_string|&quot;i82092aa&quot;
comma
id|i82092aa_interrupt
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;i82092aa: Failed to register IRQ %d, aborting&bslash;n&quot;
comma
id|dev-&gt;irq
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_if
c_cond
(paren
id|register_ss_entry
c_func
(paren
id|socket_count
comma
op_amp
id|i82092aa_operations
)paren
op_ne
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;i82092aa: register_ss_entry() failed&bslash;n&quot;
)paren
suffix:semicolon
id|leave
c_func
(paren
l_string|&quot;i82092aa_pci_probe&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|i82092aa_pci_remove
r_static
r_void
id|__exit
id|i82092aa_pci_remove
c_func
(paren
r_struct
id|pci_dev
op_star
id|dev
)paren
(brace
id|enter
c_func
(paren
l_string|&quot;i82092aa_pci_remove&quot;
)paren
suffix:semicolon
id|free_irq
c_func
(paren
id|dev-&gt;irq
comma
id|i82092aa_interrupt
)paren
suffix:semicolon
id|leave
c_func
(paren
l_string|&quot;i82092aa_pci_remove&quot;
)paren
suffix:semicolon
)brace
DECL|variable|port_lock
r_static
id|spinlock_t
id|port_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
multiline_comment|/* basic value read/write functions */
DECL|function|indirect_read
r_static
r_int
r_char
id|indirect_read
c_func
(paren
r_int
id|socket
comma
r_int
r_int
id|reg
)paren
(brace
r_int
r_int
r_int
id|port
suffix:semicolon
r_int
r_char
id|val
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|port_lock
comma
id|flags
)paren
suffix:semicolon
id|reg
op_add_assign
id|socket
op_star
l_int|0x40
suffix:semicolon
id|port
op_assign
id|sockets
(braket
id|socket
)braket
dot
id|io_base
suffix:semicolon
id|outb
c_func
(paren
id|reg
comma
id|port
)paren
suffix:semicolon
id|val
op_assign
id|inb
c_func
(paren
id|port
op_plus
l_int|1
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|port_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|val
suffix:semicolon
)brace
DECL|function|indirect_read16
r_static
r_int
r_int
id|indirect_read16
c_func
(paren
r_int
id|socket
comma
r_int
r_int
id|reg
)paren
(brace
r_int
r_int
r_int
id|port
suffix:semicolon
r_int
r_int
id|tmp
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|port_lock
comma
id|flags
)paren
suffix:semicolon
id|reg
op_assign
id|reg
op_plus
id|socket
op_star
l_int|0x40
suffix:semicolon
id|port
op_assign
id|sockets
(braket
id|socket
)braket
dot
id|io_base
suffix:semicolon
id|outb
c_func
(paren
id|reg
comma
id|port
)paren
suffix:semicolon
id|tmp
op_assign
id|inb
c_func
(paren
id|port
op_plus
l_int|1
)paren
suffix:semicolon
id|reg
op_increment
suffix:semicolon
id|outb
c_func
(paren
id|reg
comma
id|port
)paren
suffix:semicolon
id|tmp
op_assign
id|tmp
op_or
(paren
id|inb
c_func
(paren
id|port
op_plus
l_int|1
)paren
op_lshift
l_int|8
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|port_lock
comma
id|flags
)paren
suffix:semicolon
r_return
id|tmp
suffix:semicolon
)brace
DECL|function|indirect_write
r_static
r_void
id|indirect_write
c_func
(paren
r_int
id|socket
comma
r_int
r_int
id|reg
comma
r_int
r_char
id|value
)paren
(brace
r_int
r_int
r_int
id|port
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|port_lock
comma
id|flags
)paren
suffix:semicolon
id|reg
op_assign
id|reg
op_plus
id|socket
op_star
l_int|0x40
suffix:semicolon
id|port
op_assign
id|sockets
(braket
id|socket
)braket
dot
id|io_base
suffix:semicolon
id|outb
c_func
(paren
id|reg
comma
id|port
)paren
suffix:semicolon
id|outb
c_func
(paren
id|value
comma
id|port
op_plus
l_int|1
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|port_lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|indirect_setbit
r_static
r_void
id|indirect_setbit
c_func
(paren
r_int
id|socket
comma
r_int
r_int
id|reg
comma
r_int
r_char
id|mask
)paren
(brace
r_int
r_int
r_int
id|port
suffix:semicolon
r_int
r_char
id|val
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|port_lock
comma
id|flags
)paren
suffix:semicolon
id|reg
op_assign
id|reg
op_plus
id|socket
op_star
l_int|0x40
suffix:semicolon
id|port
op_assign
id|sockets
(braket
id|socket
)braket
dot
id|io_base
suffix:semicolon
id|outb
c_func
(paren
id|reg
comma
id|port
)paren
suffix:semicolon
id|val
op_assign
id|inb
c_func
(paren
id|port
op_plus
l_int|1
)paren
suffix:semicolon
id|val
op_or_assign
id|mask
suffix:semicolon
id|outb
c_func
(paren
id|reg
comma
id|port
)paren
suffix:semicolon
id|outb
c_func
(paren
id|val
comma
id|port
op_plus
l_int|1
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|port_lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|indirect_resetbit
r_static
r_void
id|indirect_resetbit
c_func
(paren
r_int
id|socket
comma
r_int
r_int
id|reg
comma
r_int
r_char
id|mask
)paren
(brace
r_int
r_int
r_int
id|port
suffix:semicolon
r_int
r_char
id|val
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|port_lock
comma
id|flags
)paren
suffix:semicolon
id|reg
op_assign
id|reg
op_plus
id|socket
op_star
l_int|0x40
suffix:semicolon
id|port
op_assign
id|sockets
(braket
id|socket
)braket
dot
id|io_base
suffix:semicolon
id|outb
c_func
(paren
id|reg
comma
id|port
)paren
suffix:semicolon
id|val
op_assign
id|inb
c_func
(paren
id|port
op_plus
l_int|1
)paren
suffix:semicolon
id|val
op_and_assign
op_complement
id|mask
suffix:semicolon
id|outb
c_func
(paren
id|reg
comma
id|port
)paren
suffix:semicolon
id|outb
c_func
(paren
id|val
comma
id|port
op_plus
l_int|1
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|port_lock
comma
id|flags
)paren
suffix:semicolon
)brace
DECL|function|indirect_write16
r_static
r_void
id|indirect_write16
c_func
(paren
r_int
id|socket
comma
r_int
r_int
id|reg
comma
r_int
r_int
id|value
)paren
(brace
r_int
r_int
r_int
id|port
suffix:semicolon
r_int
r_char
id|val
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|port_lock
comma
id|flags
)paren
suffix:semicolon
id|reg
op_assign
id|reg
op_plus
id|socket
op_star
l_int|0x40
suffix:semicolon
id|port
op_assign
id|sockets
(braket
id|socket
)braket
dot
id|io_base
suffix:semicolon
id|outb
c_func
(paren
id|reg
comma
id|port
)paren
suffix:semicolon
id|val
op_assign
id|value
op_amp
l_int|255
suffix:semicolon
id|outb
c_func
(paren
id|val
comma
id|port
op_plus
l_int|1
)paren
suffix:semicolon
id|reg
op_increment
suffix:semicolon
id|outb
c_func
(paren
id|reg
comma
id|port
)paren
suffix:semicolon
id|val
op_assign
id|value
op_rshift
l_int|8
suffix:semicolon
id|outb
c_func
(paren
id|val
comma
id|port
op_plus
l_int|1
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|port_lock
comma
id|flags
)paren
suffix:semicolon
)brace
multiline_comment|/* simple helper functions */
multiline_comment|/* External clock time, in nanoseconds.  120 ns = 8.33 MHz */
DECL|variable|cycle_time
r_static
r_int
id|cycle_time
op_assign
l_int|120
suffix:semicolon
DECL|function|to_cycles
r_static
r_int
id|to_cycles
c_func
(paren
r_int
id|ns
)paren
(brace
r_if
c_cond
(paren
id|cycle_time
op_ne
l_int|0
)paren
r_return
id|ns
op_div
id|cycle_time
suffix:semicolon
r_else
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|to_ns
r_static
r_int
id|to_ns
c_func
(paren
r_int
id|cycles
)paren
(brace
r_return
id|cycle_time
op_star
id|cycles
suffix:semicolon
)brace
multiline_comment|/* Interrupt handler functionality */
DECL|function|i82092aa_bh
r_static
r_void
id|i82092aa_bh
c_func
(paren
r_void
op_star
id|dummy
)paren
(brace
r_int
r_int
id|events
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|socket_count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|events
op_assign
id|xchg
c_func
(paren
op_amp
(paren
id|sockets
(braket
id|i
)braket
dot
id|pending_events
)paren
comma
l_int|0
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;events = %x &bslash;n&quot;
comma
id|events
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sockets
(braket
id|i
)braket
dot
id|handler
)paren
id|sockets
(braket
id|i
)braket
dot
id|handler
c_func
(paren
id|sockets
(braket
id|i
)braket
dot
id|info
comma
id|events
)paren
suffix:semicolon
)brace
)brace
DECL|variable|i82092aa_task
r_static
r_struct
id|tq_struct
id|i82092aa_task
op_assign
(brace
id|routine
suffix:colon
id|i82092aa_bh
)brace
suffix:semicolon
DECL|function|i82092aa_interrupt
r_static
r_void
id|i82092aa_interrupt
c_func
(paren
r_int
id|irq
comma
r_void
op_star
id|dev
comma
r_struct
id|pt_regs
op_star
id|regs
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|loopcount
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|events
comma
id|active
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&t;enter(&quot;i82092aa_interrupt&quot;);*/
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|loopcount
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|loopcount
OG
l_int|20
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;i82092aa: infinite eventloop in interrupt &bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|active
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|socket_count
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
id|csc
suffix:semicolon
r_if
c_cond
(paren
id|sockets
(braket
id|i
)braket
dot
id|card_state
op_eq
l_int|0
)paren
multiline_comment|/* Inactive socket, should not happen */
r_continue
suffix:semicolon
id|csc
op_assign
id|indirect_read
c_func
(paren
id|i
comma
id|I365_CSC
)paren
suffix:semicolon
multiline_comment|/* card status change register */
r_if
c_cond
(paren
(paren
id|csc
op_eq
l_int|0
)paren
op_logical_or
multiline_comment|/* no events on this socket */
(paren
id|sockets
(braket
id|i
)braket
dot
id|handler
op_eq
l_int|NULL
)paren
)paren
multiline_comment|/* no way to handle events */
r_continue
suffix:semicolon
id|events
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|csc
op_amp
id|I365_CSC_DETECT
)paren
(brace
id|events
op_or_assign
id|SS_DETECT
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Card detected in socket %i!&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|indirect_read
c_func
(paren
id|i
comma
id|I365_INTCTL
)paren
op_amp
id|I365_PC_IOCARD
)paren
(brace
multiline_comment|/* For IO/CARDS, bit 0 means &quot;read the card&quot; */
id|events
op_or_assign
(paren
id|csc
op_amp
id|I365_CSC_STSCHG
)paren
ques
c_cond
id|SS_STSCHG
suffix:colon
l_int|0
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Check for battery/ready events */
id|events
op_or_assign
(paren
id|csc
op_amp
id|I365_CSC_BVD1
)paren
ques
c_cond
id|SS_BATDEAD
suffix:colon
l_int|0
suffix:semicolon
id|events
op_or_assign
(paren
id|csc
op_amp
id|I365_CSC_BVD2
)paren
ques
c_cond
id|SS_BATWARN
suffix:colon
l_int|0
suffix:semicolon
id|events
op_or_assign
(paren
id|csc
op_amp
id|I365_CSC_READY
)paren
ques
c_cond
id|SS_READY
suffix:colon
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|events
)paren
(brace
id|sockets
(braket
id|i
)braket
dot
id|pending_events
op_or_assign
id|events
suffix:semicolon
id|schedule_task
c_func
(paren
op_amp
id|i82092aa_task
)paren
suffix:semicolon
)brace
id|active
op_or_assign
id|events
suffix:semicolon
)brace
r_if
c_cond
(paren
id|active
op_eq
l_int|0
)paren
multiline_comment|/* no more events to handle */
r_break
suffix:semicolon
)brace
multiline_comment|/*&t;leave(&quot;i82092aa_interrupt&quot;);*/
)brace
multiline_comment|/* socket functions */
DECL|function|card_present
r_static
r_int
id|card_present
c_func
(paren
r_int
id|socketno
)paren
(brace
r_int
r_int
id|val
suffix:semicolon
id|enter
c_func
(paren
l_string|&quot;card_present&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|socketno
OL
l_int|0
)paren
op_logical_or
(paren
id|socketno
OG
id|MAX_SOCKETS
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|sockets
(braket
id|socketno
)braket
dot
id|io_base
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
id|val
op_assign
id|indirect_read
c_func
(paren
id|socketno
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Interface status register */
r_if
c_cond
(paren
(paren
id|val
op_amp
l_int|12
)paren
op_eq
l_int|12
)paren
(brace
id|leave
c_func
(paren
l_string|&quot;card_present 1&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|leave
c_func
(paren
l_string|&quot;card_present 0&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|set_bridge_state
r_static
r_void
id|set_bridge_state
c_func
(paren
r_int
id|sock
)paren
(brace
id|enter
c_func
(paren
l_string|&quot;set_bridge_state&quot;
)paren
suffix:semicolon
id|indirect_write
c_func
(paren
id|sock
comma
id|I365_GBLCTL
comma
l_int|0x00
)paren
suffix:semicolon
id|indirect_write
c_func
(paren
id|sock
comma
id|I365_GENCTL
comma
l_int|0x00
)paren
suffix:semicolon
id|indirect_setbit
c_func
(paren
id|sock
comma
id|I365_INTCTL
comma
l_int|0x08
)paren
suffix:semicolon
id|leave
c_func
(paren
l_string|&quot;set_bridge_state&quot;
)paren
suffix:semicolon
)brace
DECL|function|i82092aa_init
r_static
r_int
id|i82092aa_init
c_func
(paren
r_int
r_int
id|s
)paren
(brace
r_int
id|i
suffix:semicolon
id|pccard_io_map
id|io
op_assign
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|1
)brace
suffix:semicolon
id|pccard_mem_map
id|mem
op_assign
(brace
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
id|enter
c_func
(paren
l_string|&quot;i82092aa_init&quot;
)paren
suffix:semicolon
id|mem.sys_stop
op_assign
l_int|0x0fff
suffix:semicolon
id|i82092aa_set_socket
c_func
(paren
id|s
comma
op_amp
id|dead_socket
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|2
suffix:semicolon
id|i
op_increment
)paren
(brace
id|io.map
op_assign
id|i
suffix:semicolon
id|i82092aa_set_io_map
c_func
(paren
id|s
comma
op_amp
id|io
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|5
suffix:semicolon
id|i
op_increment
)paren
(brace
id|mem.map
op_assign
id|i
suffix:semicolon
id|i82092aa_set_mem_map
c_func
(paren
id|s
comma
op_amp
id|mem
)paren
suffix:semicolon
)brace
id|leave
c_func
(paren
l_string|&quot;i82092aa_init&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|i82092aa_suspend
r_static
r_int
id|i82092aa_suspend
c_func
(paren
r_int
r_int
id|sock
)paren
(brace
r_int
id|retval
suffix:semicolon
id|enter
c_func
(paren
l_string|&quot;i82092aa_suspend&quot;
)paren
suffix:semicolon
id|retval
op_assign
id|i82092aa_set_socket
c_func
(paren
id|sock
comma
op_amp
id|dead_socket
)paren
suffix:semicolon
id|leave
c_func
(paren
l_string|&quot;i82092aa_suspend&quot;
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
DECL|function|i82092aa_register_callback
r_static
r_int
id|i82092aa_register_callback
c_func
(paren
r_int
r_int
id|sock
comma
r_void
(paren
op_star
id|handler
)paren
(paren
r_void
op_star
comma
r_int
r_int
)paren
comma
r_void
op_star
id|info
)paren
(brace
id|enter
c_func
(paren
l_string|&quot;i82092aa_register_callback&quot;
)paren
suffix:semicolon
id|sockets
(braket
id|sock
)braket
dot
id|handler
op_assign
id|handler
suffix:semicolon
id|sockets
(braket
id|sock
)braket
dot
id|info
op_assign
id|info
suffix:semicolon
r_if
c_cond
(paren
id|handler
op_eq
l_int|NULL
)paren
(brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
r_else
(brace
id|MOD_INC_USE_COUNT
suffix:semicolon
)brace
id|leave
c_func
(paren
l_string|&quot;i82092aa_register_callback&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* i82092aa_register_callback */
DECL|function|i82092aa_inquire_socket
r_static
r_int
id|i82092aa_inquire_socket
c_func
(paren
r_int
r_int
id|sock
comma
id|socket_cap_t
op_star
id|cap
)paren
(brace
id|enter
c_func
(paren
l_string|&quot;i82092aa_inquire_socket&quot;
)paren
suffix:semicolon
op_star
id|cap
op_assign
id|sockets
(braket
id|sock
)braket
dot
id|cap
suffix:semicolon
id|leave
c_func
(paren
l_string|&quot;i82092aa_inquire_socket&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* i82092aa_inquire_socket */
DECL|function|i82092aa_get_status
r_static
r_int
id|i82092aa_get_status
c_func
(paren
r_int
r_int
id|sock
comma
id|u_int
op_star
id|value
)paren
(brace
r_int
r_int
id|status
suffix:semicolon
id|enter
c_func
(paren
l_string|&quot;i82092aa_get_status&quot;
)paren
suffix:semicolon
id|status
op_assign
id|indirect_read
c_func
(paren
id|sock
comma
id|I365_STATUS
)paren
suffix:semicolon
multiline_comment|/* Interface Status Register */
op_star
id|value
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_amp
id|I365_CS_DETECT
)paren
op_eq
id|I365_CS_DETECT
)paren
(brace
op_star
id|value
op_or_assign
id|SS_DETECT
suffix:semicolon
)brace
multiline_comment|/* IO cards have a different meaning of bits 0,1 */
multiline_comment|/* Also notice the inverse-logic on the bits */
r_if
c_cond
(paren
id|indirect_read
c_func
(paren
id|sock
comma
id|I365_INTCTL
)paren
op_amp
id|I365_PC_IOCARD
)paren
(brace
multiline_comment|/* IO card */
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_amp
id|I365_CS_STSCHG
)paren
)paren
op_star
id|value
op_or_assign
id|SS_STSCHG
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* non I/O card */
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_amp
id|I365_CS_BVD1
)paren
)paren
op_star
id|value
op_or_assign
id|SS_BATDEAD
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|status
op_amp
id|I365_CS_BVD2
)paren
)paren
op_star
id|value
op_or_assign
id|SS_BATWARN
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_amp
id|I365_CS_WRPROT
)paren
(paren
op_star
id|value
)paren
op_or_assign
id|SS_WRPROT
suffix:semicolon
multiline_comment|/* card is write protected */
r_if
c_cond
(paren
id|status
op_amp
id|I365_CS_READY
)paren
(paren
op_star
id|value
)paren
op_or_assign
id|SS_READY
suffix:semicolon
multiline_comment|/* card is not busy */
r_if
c_cond
(paren
id|status
op_amp
id|I365_CS_POWERON
)paren
(paren
op_star
id|value
)paren
op_or_assign
id|SS_POWERON
suffix:semicolon
multiline_comment|/* power is applied to the card */
id|leave
c_func
(paren
l_string|&quot;i82092aa_get_status&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|i82092aa_get_socket
r_static
r_int
id|i82092aa_get_socket
c_func
(paren
r_int
r_int
id|sock
comma
id|socket_state_t
op_star
id|state
)paren
(brace
r_int
r_char
id|reg
comma
id|vcc
comma
id|vpp
suffix:semicolon
id|enter
c_func
(paren
l_string|&quot;i82092aa_get_socket&quot;
)paren
suffix:semicolon
id|state-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|state-&gt;Vcc
op_assign
l_int|0
suffix:semicolon
id|state-&gt;Vpp
op_assign
l_int|0
suffix:semicolon
id|state-&gt;io_irq
op_assign
l_int|0
suffix:semicolon
id|state-&gt;csc_mask
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* First the power status of the socket */
id|reg
op_assign
id|indirect_read
c_func
(paren
id|sock
comma
id|I365_POWER
)paren
suffix:semicolon
multiline_comment|/* PCTRL - Power Control Register */
r_if
c_cond
(paren
id|reg
op_amp
id|I365_PWR_AUTO
)paren
id|state-&gt;flags
op_or_assign
id|SS_PWR_AUTO
suffix:semicolon
multiline_comment|/* Automatic Power Switch */
r_if
c_cond
(paren
id|reg
op_amp
id|I365_PWR_OUT
)paren
id|state-&gt;flags
op_or_assign
id|SS_OUTPUT_ENA
suffix:semicolon
multiline_comment|/* Output signals are enabled */
id|vcc
op_assign
id|reg
op_amp
id|I365_VCC_MASK
suffix:semicolon
id|vpp
op_assign
id|reg
op_amp
id|I365_VPP1_MASK
suffix:semicolon
r_if
c_cond
(paren
id|reg
op_amp
id|I365_VCC_5V
)paren
(brace
multiline_comment|/* Can still be 3.3V, in this case the Vcc value will be overwritten later */
id|state-&gt;Vcc
op_assign
l_int|50
suffix:semicolon
r_if
c_cond
(paren
id|vpp
op_eq
id|I365_VPP1_5V
)paren
id|state-&gt;Vpp
op_assign
l_int|50
suffix:semicolon
r_if
c_cond
(paren
id|vpp
op_eq
id|I365_VPP1_12V
)paren
id|state-&gt;Vpp
op_assign
l_int|120
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|reg
op_amp
id|I365_VCC_3V
)paren
op_eq
id|I365_VCC_3V
)paren
id|state-&gt;Vcc
op_assign
l_int|33
suffix:semicolon
multiline_comment|/* Now the IO card, RESET flags and IO interrupt */
id|reg
op_assign
id|indirect_read
c_func
(paren
id|sock
comma
id|I365_INTCTL
)paren
suffix:semicolon
multiline_comment|/* IGENC, Interrupt and General Control */
r_if
c_cond
(paren
(paren
id|reg
op_amp
id|I365_PC_RESET
)paren
op_eq
l_int|0
)paren
id|state-&gt;flags
op_or_assign
id|SS_RESET
suffix:semicolon
r_if
c_cond
(paren
id|reg
op_amp
id|I365_PC_IOCARD
)paren
id|state-&gt;flags
op_or_assign
id|SS_IOCARD
suffix:semicolon
multiline_comment|/* This is an IO card */
multiline_comment|/* Set the IRQ number */
r_if
c_cond
(paren
id|sockets
(braket
id|sock
)braket
dot
id|dev
op_ne
l_int|NULL
)paren
id|state-&gt;io_irq
op_assign
id|sockets
(braket
id|sock
)braket
dot
id|dev-&gt;irq
suffix:semicolon
multiline_comment|/* Card status change */
id|reg
op_assign
id|indirect_read
c_func
(paren
id|sock
comma
id|I365_CSCINT
)paren
suffix:semicolon
multiline_comment|/* CSCICR, Card Status Change Interrupt Configuration */
r_if
c_cond
(paren
id|reg
op_amp
id|I365_CSC_DETECT
)paren
id|state-&gt;csc_mask
op_or_assign
id|SS_DETECT
suffix:semicolon
multiline_comment|/* Card detect is enabled */
r_if
c_cond
(paren
id|state-&gt;flags
op_amp
id|SS_IOCARD
)paren
(brace
multiline_comment|/* IO Cards behave different */
r_if
c_cond
(paren
id|reg
op_amp
id|I365_CSC_STSCHG
)paren
id|state-&gt;csc_mask
op_or_assign
id|SS_STSCHG
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|reg
op_amp
id|I365_CSC_BVD1
)paren
id|state-&gt;csc_mask
op_or_assign
id|SS_BATDEAD
suffix:semicolon
r_if
c_cond
(paren
id|reg
op_amp
id|I365_CSC_BVD2
)paren
id|state-&gt;csc_mask
op_or_assign
id|SS_BATWARN
suffix:semicolon
r_if
c_cond
(paren
id|reg
op_amp
id|I365_CSC_READY
)paren
id|state-&gt;csc_mask
op_or_assign
id|SS_READY
suffix:semicolon
)brace
id|leave
c_func
(paren
l_string|&quot;i82092aa_get_socket&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|i82092aa_set_socket
r_static
r_int
id|i82092aa_set_socket
c_func
(paren
r_int
r_int
id|sock
comma
id|socket_state_t
op_star
id|state
)paren
(brace
r_int
r_char
id|reg
suffix:semicolon
id|enter
c_func
(paren
l_string|&quot;i82092aa_set_socket&quot;
)paren
suffix:semicolon
multiline_comment|/* First, set the global controller options */
id|set_bridge_state
c_func
(paren
id|sock
)paren
suffix:semicolon
multiline_comment|/* Values for the IGENC register */
id|reg
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|state-&gt;flags
op_amp
id|SS_RESET
)paren
)paren
multiline_comment|/* The reset bit has &quot;inverse&quot; logic */
id|reg
op_assign
id|reg
op_or
id|I365_PC_RESET
suffix:semicolon
r_if
c_cond
(paren
id|state-&gt;flags
op_amp
id|SS_IOCARD
)paren
id|reg
op_assign
id|reg
op_or
id|I365_PC_IOCARD
suffix:semicolon
id|indirect_write
c_func
(paren
id|sock
comma
id|I365_INTCTL
comma
id|reg
)paren
suffix:semicolon
multiline_comment|/* IGENC, Interrupt and General Control Register */
multiline_comment|/* Power registers */
id|reg
op_assign
id|I365_PWR_NORESET
suffix:semicolon
multiline_comment|/* default: disable resetdrv on resume */
r_if
c_cond
(paren
id|state-&gt;flags
op_amp
id|SS_PWR_AUTO
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Auto power&bslash;n&quot;
)paren
suffix:semicolon
id|reg
op_or_assign
id|I365_PWR_AUTO
suffix:semicolon
multiline_comment|/* automatic power mngmnt */
)brace
r_if
c_cond
(paren
id|state-&gt;flags
op_amp
id|SS_OUTPUT_ENA
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Power Enabled &bslash;n&quot;
)paren
suffix:semicolon
id|reg
op_or_assign
id|I365_PWR_OUT
suffix:semicolon
multiline_comment|/* enable power */
)brace
r_switch
c_cond
(paren
id|state-&gt;Vcc
)paren
(brace
r_case
l_int|0
suffix:colon
r_break
suffix:semicolon
r_case
l_int|50
suffix:colon
id|printk
c_func
(paren
l_string|&quot;setting voltage to Vcc to 5V on socket %i&bslash;n&quot;
comma
id|sock
)paren
suffix:semicolon
id|reg
op_or_assign
id|I365_VCC_5V
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;i82092aa: i82092aa_set_socket called with invalid VCC power value: %i &quot;
comma
id|state-&gt;Vcc
)paren
suffix:semicolon
id|leave
c_func
(paren
l_string|&quot;i82092aa_set_socket&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|state-&gt;Vpp
)paren
(brace
r_case
l_int|0
suffix:colon
id|printk
c_func
(paren
l_string|&quot;not setting Vpp on socket %i&bslash;n&quot;
comma
id|sock
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|50
suffix:colon
id|printk
c_func
(paren
l_string|&quot;setting Vpp to 5.0 for socket %i&bslash;n&quot;
comma
id|sock
)paren
suffix:semicolon
id|reg
op_or_assign
id|I365_VPP1_5V
op_or
id|I365_VPP2_5V
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|120
suffix:colon
id|printk
c_func
(paren
l_string|&quot;setting Vpp to 12.0&bslash;n&quot;
)paren
suffix:semicolon
id|reg
op_or_assign
id|I365_VPP1_12V
op_or
id|I365_VPP2_12V
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;i82092aa: i82092aa_set_socket called with invalid VPP power value: %i &quot;
comma
id|state-&gt;Vcc
)paren
suffix:semicolon
id|leave
c_func
(paren
l_string|&quot;i82092aa_set_socket&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|reg
op_ne
id|indirect_read
c_func
(paren
id|sock
comma
id|I365_POWER
)paren
)paren
multiline_comment|/* only write if changed */
id|indirect_write
c_func
(paren
id|sock
comma
id|I365_POWER
comma
id|reg
)paren
suffix:semicolon
multiline_comment|/* Enable specific interrupt events */
id|reg
op_assign
l_int|0x00
suffix:semicolon
r_if
c_cond
(paren
id|state-&gt;csc_mask
op_amp
id|SS_DETECT
)paren
(brace
id|reg
op_or_assign
id|I365_CSC_DETECT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|state-&gt;flags
op_amp
id|SS_IOCARD
)paren
(brace
r_if
c_cond
(paren
id|state-&gt;csc_mask
op_amp
id|SS_STSCHG
)paren
id|reg
op_or_assign
id|I365_CSC_STSCHG
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|state-&gt;csc_mask
op_amp
id|SS_BATDEAD
)paren
id|reg
op_or_assign
id|I365_CSC_BVD1
suffix:semicolon
r_if
c_cond
(paren
id|state-&gt;csc_mask
op_amp
id|SS_BATWARN
)paren
id|reg
op_or_assign
id|I365_CSC_BVD2
suffix:semicolon
r_if
c_cond
(paren
id|state-&gt;csc_mask
op_amp
id|SS_READY
)paren
id|reg
op_or_assign
id|I365_CSC_READY
suffix:semicolon
)brace
multiline_comment|/* now write the value and clear the (probably bogus) pending stuff by doing a dummy read*/
id|indirect_write
c_func
(paren
id|sock
comma
id|I365_CSCINT
comma
id|reg
)paren
suffix:semicolon
(paren
r_void
)paren
id|indirect_read
c_func
(paren
id|sock
comma
id|I365_CSC
)paren
suffix:semicolon
id|leave
c_func
(paren
l_string|&quot;i82092aa_set_socket&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|i82092aa_get_io_map
r_static
r_int
id|i82092aa_get_io_map
c_func
(paren
r_int
r_int
id|sock
comma
r_struct
id|pccard_io_map
op_star
id|io
)paren
(brace
r_int
r_char
id|map
comma
id|ioctl
comma
id|addr
suffix:semicolon
id|enter
c_func
(paren
l_string|&quot;i82092aa_get_io_map&quot;
)paren
suffix:semicolon
id|map
op_assign
id|io-&gt;map
suffix:semicolon
r_if
c_cond
(paren
id|map
OG
l_int|1
)paren
(brace
id|leave
c_func
(paren
l_string|&quot;i82092aa_get_io_map with -EINVAL&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* FIXME: How does this fit in with the PCI resource (re)allocation */
id|io-&gt;start
op_assign
id|indirect_read16
c_func
(paren
id|sock
comma
id|I365_IO
c_func
(paren
id|map
)paren
op_plus
id|I365_W_START
)paren
suffix:semicolon
id|io-&gt;stop
op_assign
id|indirect_read16
c_func
(paren
id|sock
comma
id|I365_IO
c_func
(paren
id|map
)paren
op_plus
id|I365_W_START
)paren
suffix:semicolon
id|ioctl
op_assign
id|indirect_read
c_func
(paren
id|sock
comma
id|I365_IOCTL
)paren
suffix:semicolon
multiline_comment|/* IOCREG: I/O Control Register */
id|addr
op_assign
id|indirect_read
c_func
(paren
id|sock
comma
id|I365_ADDRWIN
)paren
suffix:semicolon
multiline_comment|/* */
id|io-&gt;speed
op_assign
id|to_ns
c_func
(paren
id|ioctl
op_amp
id|I365_IOCTL_WAIT
c_func
(paren
id|map
)paren
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
multiline_comment|/* check this out later */
id|io-&gt;flags
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|addr
op_amp
id|I365_IOCTL_16BIT
c_func
(paren
id|map
)paren
)paren
id|io-&gt;flags
op_or_assign
id|MAP_AUTOSZ
suffix:semicolon
id|leave
c_func
(paren
l_string|&quot;i82092aa_get_io_map&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|i82092aa_set_io_map
r_static
r_int
id|i82092aa_set_io_map
c_func
(paren
r_int
id|sock
comma
r_struct
id|pccard_io_map
op_star
id|io
)paren
(brace
r_int
r_char
id|map
comma
id|ioctl
suffix:semicolon
id|enter
c_func
(paren
l_string|&quot;i82092aa_set_io_map&quot;
)paren
suffix:semicolon
id|map
op_assign
id|io-&gt;map
suffix:semicolon
multiline_comment|/* Check error conditions */
r_if
c_cond
(paren
id|map
OG
l_int|1
)paren
(brace
id|leave
c_func
(paren
l_string|&quot;i82092aa_set_io_map with invalid map&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|io-&gt;start
OG
l_int|0xffff
)paren
op_logical_or
(paren
id|io-&gt;stop
OG
l_int|0xffff
)paren
op_logical_or
(paren
id|io-&gt;stop
OL
id|io-&gt;start
)paren
)paren
(brace
id|leave
c_func
(paren
l_string|&quot;i82092aa_set_io_map with invalid io&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* Turn off the window before changing anything */
r_if
c_cond
(paren
id|indirect_read
c_func
(paren
id|sock
comma
id|I365_ADDRWIN
)paren
op_amp
id|I365_ENA_IO
c_func
(paren
id|map
)paren
)paren
id|indirect_resetbit
c_func
(paren
id|sock
comma
id|I365_ADDRWIN
comma
id|I365_ENA_IO
c_func
(paren
id|map
)paren
)paren
suffix:semicolon
multiline_comment|/*&t;printk(&quot;set_io_map: Setting range to %x - %x &bslash;n&quot;,io-&gt;start,io-&gt;stop);  */
multiline_comment|/* write the new values */
id|indirect_write16
c_func
(paren
id|sock
comma
id|I365_IO
c_func
(paren
id|map
)paren
op_plus
id|I365_W_START
comma
id|io-&gt;start
)paren
suffix:semicolon
id|indirect_write16
c_func
(paren
id|sock
comma
id|I365_IO
c_func
(paren
id|map
)paren
op_plus
id|I365_W_STOP
comma
id|io-&gt;stop
)paren
suffix:semicolon
id|ioctl
op_assign
id|indirect_read
c_func
(paren
id|sock
comma
id|I365_IOCTL
)paren
op_amp
op_complement
id|I365_IOCTL_MASK
c_func
(paren
id|map
)paren
suffix:semicolon
r_if
c_cond
(paren
id|io-&gt;flags
op_amp
(paren
id|MAP_16BIT
op_or
id|MAP_AUTOSZ
)paren
)paren
id|ioctl
op_or_assign
id|I365_IOCTL_16BIT
c_func
(paren
id|map
)paren
suffix:semicolon
id|indirect_write
c_func
(paren
id|sock
comma
id|I365_IOCTL
comma
id|ioctl
)paren
suffix:semicolon
multiline_comment|/* Turn the window back on if needed */
r_if
c_cond
(paren
id|io-&gt;flags
op_amp
id|MAP_ACTIVE
)paren
id|indirect_setbit
c_func
(paren
id|sock
comma
id|I365_ADDRWIN
comma
id|I365_ENA_IO
c_func
(paren
id|map
)paren
)paren
suffix:semicolon
id|leave
c_func
(paren
l_string|&quot;i82092aa_set_io_map&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|i82092aa_get_mem_map
r_static
r_int
id|i82092aa_get_mem_map
c_func
(paren
r_int
id|sock
comma
r_struct
id|pccard_mem_map
op_star
id|mem
)paren
(brace
r_int
r_int
id|base
comma
id|i
suffix:semicolon
r_int
r_char
id|map
comma
id|addr
suffix:semicolon
id|enter
c_func
(paren
l_string|&quot;i82092aa_get_mem_map&quot;
)paren
suffix:semicolon
id|mem-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|mem-&gt;speed
op_assign
l_int|0
suffix:semicolon
id|map
op_assign
id|mem-&gt;map
suffix:semicolon
r_if
c_cond
(paren
id|map
OG
l_int|4
)paren
(brace
id|leave
c_func
(paren
l_string|&quot;i82092aa_get_mem_map: -EINVAL&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|addr
op_assign
id|indirect_read
c_func
(paren
id|sock
comma
id|I365_ADDRWIN
)paren
suffix:semicolon
r_if
c_cond
(paren
id|addr
op_amp
id|I365_ENA_MEM
c_func
(paren
id|map
)paren
)paren
id|mem-&gt;flags
op_or_assign
id|MAP_ACTIVE
suffix:semicolon
multiline_comment|/* yes this mapping is active */
id|base
op_assign
id|I365_MEM
c_func
(paren
id|map
)paren
suffix:semicolon
multiline_comment|/* Find the start address - this register also has mapping info */
id|i
op_assign
id|indirect_read16
c_func
(paren
id|sock
comma
id|base
op_plus
id|I365_W_START
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_amp
id|I365_MEM_16BIT
)paren
id|mem-&gt;flags
op_or_assign
id|MAP_16BIT
suffix:semicolon
r_if
c_cond
(paren
id|i
op_amp
id|I365_MEM_0WS
)paren
id|mem-&gt;flags
op_or_assign
id|MAP_0WS
suffix:semicolon
id|mem-&gt;sys_start
op_assign
(paren
(paren
r_int
r_int
)paren
(paren
id|i
op_amp
l_int|0x0fff
)paren
op_lshift
l_int|12
)paren
suffix:semicolon
multiline_comment|/* Find the end address - this register also has speed info */
id|i
op_assign
id|indirect_read16
c_func
(paren
id|sock
comma
id|base
op_plus
id|I365_W_STOP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_amp
id|I365_MEM_WS0
)paren
id|mem-&gt;speed
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|i
op_amp
id|I365_MEM_WS1
)paren
id|mem-&gt;speed
op_add_assign
l_int|2
suffix:semicolon
id|mem-&gt;speed
op_assign
id|to_ns
c_func
(paren
id|mem-&gt;speed
)paren
suffix:semicolon
id|mem-&gt;sys_stop
op_assign
(paren
(paren
r_int
r_int
)paren
(paren
id|i
op_amp
l_int|0x0fff
)paren
op_lshift
l_int|12
)paren
op_plus
l_int|0x0fff
suffix:semicolon
multiline_comment|/* Find the card start address, also some more MAP attributes */
id|i
op_assign
id|indirect_read16
c_func
(paren
id|sock
comma
id|base
op_plus
id|I365_W_OFF
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_amp
id|I365_MEM_WRPROT
)paren
id|mem-&gt;flags
op_or_assign
id|MAP_WRPROT
suffix:semicolon
r_if
c_cond
(paren
id|i
op_amp
id|I365_MEM_REG
)paren
id|mem-&gt;flags
op_or_assign
id|MAP_ATTRIB
suffix:semicolon
id|mem-&gt;card_start
op_assign
(paren
(paren
r_int
r_int
)paren
(paren
id|i
op_amp
l_int|0x3fff
)paren
OL
l_int|12
)paren
op_plus
id|mem-&gt;sys_start
suffix:semicolon
id|mem-&gt;card_start
op_and_assign
l_int|0x3ffffff
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Card %i is from %x to %x &bslash;n&quot;
comma
id|sock
comma
id|mem-&gt;sys_start
comma
id|mem-&gt;sys_stop
)paren
suffix:semicolon
id|leave
c_func
(paren
l_string|&quot;i82092aa_get_mem_map&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|i82092aa_set_mem_map
r_static
r_int
id|i82092aa_set_mem_map
c_func
(paren
r_int
id|sock
comma
r_struct
id|pccard_mem_map
op_star
id|mem
)paren
(brace
r_int
r_int
id|base
comma
id|i
suffix:semicolon
r_int
r_char
id|map
suffix:semicolon
id|enter
c_func
(paren
l_string|&quot;i82092aa_set_mem_map&quot;
)paren
suffix:semicolon
id|map
op_assign
id|mem-&gt;map
suffix:semicolon
r_if
c_cond
(paren
id|map
OG
l_int|4
)paren
(brace
id|leave
c_func
(paren
l_string|&quot;i82092aa_set_mem_map: invalid map&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|mem-&gt;card_start
OG
l_int|0x3ffffff
)paren
op_logical_or
(paren
id|mem-&gt;sys_start
OG
id|mem-&gt;sys_stop
)paren
op_logical_or
(paren
id|mem-&gt;speed
OG
l_int|1000
)paren
)paren
(brace
id|leave
c_func
(paren
l_string|&quot;i82092aa_set_mem_map: invalid address / speed&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;invalid mem map for socket %i : %x to %x with a start of %x &bslash;n&quot;
comma
id|sock
comma
id|mem-&gt;sys_start
comma
id|mem-&gt;sys_stop
comma
id|mem-&gt;card_start
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* Turn off the window before changing anything */
r_if
c_cond
(paren
id|indirect_read
c_func
(paren
id|sock
comma
id|I365_ADDRWIN
)paren
op_amp
id|I365_ENA_MEM
c_func
(paren
id|map
)paren
)paren
id|indirect_resetbit
c_func
(paren
id|sock
comma
id|I365_ADDRWIN
comma
id|I365_ENA_MEM
c_func
(paren
id|map
)paren
)paren
suffix:semicolon
multiline_comment|/* &t;printk(&quot;set_mem_map: Setting map %i range to %x - %x on socket %i, speed is %i, active = %i &bslash;n&quot;,map, mem-&gt;sys_start,mem-&gt;sys_stop,sock,mem-&gt;speed,mem-&gt;flags &amp; MAP_ACTIVE);  */
multiline_comment|/* write the start address */
id|base
op_assign
id|I365_MEM
c_func
(paren
id|map
)paren
suffix:semicolon
id|i
op_assign
(paren
id|mem-&gt;sys_start
op_rshift
l_int|12
)paren
op_amp
l_int|0x0fff
suffix:semicolon
r_if
c_cond
(paren
id|mem-&gt;flags
op_amp
id|MAP_16BIT
)paren
id|i
op_or_assign
id|I365_MEM_16BIT
suffix:semicolon
r_if
c_cond
(paren
id|mem-&gt;flags
op_amp
id|MAP_0WS
)paren
id|i
op_or_assign
id|I365_MEM_0WS
suffix:semicolon
id|indirect_write16
c_func
(paren
id|sock
comma
id|base
op_plus
id|I365_W_START
comma
id|i
)paren
suffix:semicolon
multiline_comment|/* write the stop address */
id|i
op_assign
(paren
id|mem-&gt;sys_stop
op_rshift
l_int|12
)paren
op_amp
l_int|0x0fff
suffix:semicolon
r_switch
c_cond
(paren
id|to_cycles
c_func
(paren
id|mem-&gt;speed
)paren
)paren
(brace
r_case
l_int|0
suffix:colon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
id|i
op_or_assign
id|I365_MEM_WS0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|i
op_or_assign
id|I365_MEM_WS1
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|i
op_or_assign
id|I365_MEM_WS1
op_or
id|I365_MEM_WS0
suffix:semicolon
r_break
suffix:semicolon
)brace
id|indirect_write16
c_func
(paren
id|sock
comma
id|base
op_plus
id|I365_W_STOP
comma
id|i
)paren
suffix:semicolon
multiline_comment|/* card start */
id|i
op_assign
(paren
(paren
id|mem-&gt;card_start
op_minus
id|mem-&gt;sys_start
)paren
op_rshift
l_int|12
)paren
op_amp
l_int|0x3fff
suffix:semicolon
r_if
c_cond
(paren
id|mem-&gt;flags
op_amp
id|MAP_WRPROT
)paren
id|i
op_or_assign
id|I365_MEM_WRPROT
suffix:semicolon
r_if
c_cond
(paren
id|mem-&gt;flags
op_amp
id|MAP_ATTRIB
)paren
(brace
multiline_comment|/*&t;&t;printk(&quot;requesting attribute memory for socket %i&bslash;n&quot;,sock);*/
id|i
op_or_assign
id|I365_MEM_REG
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*&t;&t;printk(&quot;requesting normal memory for socket %i&bslash;n&quot;,sock);*/
)brace
id|indirect_write16
c_func
(paren
id|sock
comma
id|base
op_plus
id|I365_W_OFF
comma
id|i
)paren
suffix:semicolon
multiline_comment|/* Enable the window if necessary */
r_if
c_cond
(paren
id|mem-&gt;flags
op_amp
id|MAP_ACTIVE
)paren
id|indirect_setbit
c_func
(paren
id|sock
comma
id|I365_ADDRWIN
comma
id|I365_ENA_MEM
c_func
(paren
id|map
)paren
)paren
suffix:semicolon
id|leave
c_func
(paren
l_string|&quot;i82092aa_set_mem_map&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|i82092aa_proc_setup
r_static
r_void
id|i82092aa_proc_setup
c_func
(paren
r_int
r_int
id|sock
comma
r_struct
id|proc_dir_entry
op_star
id|base
)paren
(brace
)brace
multiline_comment|/* Module stuff */
DECL|function|i82092aa_module_init
r_static
r_int
id|i82092aa_module_init
c_func
(paren
r_void
)paren
(brace
id|enter
c_func
(paren
l_string|&quot;i82092aa_module_init&quot;
)paren
suffix:semicolon
id|pci_register_driver
c_func
(paren
op_amp
id|i82092aa_pci_drv
)paren
suffix:semicolon
id|leave
c_func
(paren
l_string|&quot;i82092aa_module_init&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|i82092aa_module_exit
r_static
r_void
id|i82092aa_module_exit
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|enter
c_func
(paren
l_string|&quot;i82092aa_module_exit&quot;
)paren
suffix:semicolon
id|pci_unregister_driver
c_func
(paren
op_amp
id|i82092aa_pci_drv
)paren
suffix:semicolon
id|unregister_ss_entry
c_func
(paren
op_amp
id|i82092aa_operations
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sockets
(braket
l_int|0
)braket
dot
id|io_base
OG
l_int|0
)paren
id|release_region
c_func
(paren
id|sockets
(braket
l_int|0
)braket
dot
id|io_base
comma
l_int|2
)paren
suffix:semicolon
id|leave
c_func
(paren
l_string|&quot;i82092aa_module_exit&quot;
)paren
suffix:semicolon
)brace
DECL|variable|i82092aa_module_init
id|module_init
c_func
(paren
id|i82092aa_module_init
)paren
suffix:semicolon
DECL|variable|i82092aa_module_exit
id|module_exit
c_func
(paren
id|i82092aa_module_exit
)paren
suffix:semicolon
eof
