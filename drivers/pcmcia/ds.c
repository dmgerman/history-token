multiline_comment|/*&n; * ds.c -- 16-bit PCMCIA core support&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License version 2 as&n; * published by the Free Software Foundation.&n; *&n; * The initial developer of the original code is David A. Hinds&n; * &lt;dahinds@users.sourceforge.net&gt;.  Portions created by David A. Hinds&n; * are Copyright (C) 1999 David A. Hinds.  All Rights Reserved.&n; *&n; * (C) 1999&t;&t;David A. Hinds&n; * (C) 2003 - 2004&t;Dominik Brodowski&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/moduleparam.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/major.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/ioctl.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/poll.h&gt;
macro_line|#include &lt;linux/pci.h&gt;
macro_line|#include &lt;linux/list.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/workqueue.h&gt;
macro_line|#include &lt;asm/atomic.h&gt;
DECL|macro|IN_CARD_SERVICES
mdefine_line|#define IN_CARD_SERVICES
macro_line|#include &lt;pcmcia/version.h&gt;
macro_line|#include &lt;pcmcia/cs_types.h&gt;
macro_line|#include &lt;pcmcia/cs.h&gt;
macro_line|#include &lt;pcmcia/bulkmem.h&gt;
macro_line|#include &lt;pcmcia/cistpl.h&gt;
macro_line|#include &lt;pcmcia/ds.h&gt;
macro_line|#include &lt;pcmcia/ss.h&gt;
macro_line|#include &quot;cs_internal.h&quot;
multiline_comment|/*====================================================================*/
multiline_comment|/* Module parameters */
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;David Hinds &lt;dahinds@users.sourceforge.net&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;PCMCIA Driver Services&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
macro_line|#ifdef DEBUG
DECL|variable|ds_pc_debug
r_int
id|ds_pc_debug
suffix:semicolon
id|module_param_named
c_func
(paren
id|pc_debug
comma
id|ds_pc_debug
comma
r_int
comma
l_int|0644
)paren
suffix:semicolon
DECL|macro|ds_dbg
mdefine_line|#define ds_dbg(lvl, fmt, arg...) do {&t;&t;&t;&t;&bslash;&n;&t;if (ds_pc_debug &gt; (lvl))&t;&t;&t;&t;&t;&bslash;&n;&t;&t;printk(KERN_DEBUG &quot;ds: &quot; fmt , ## arg);&t;&t;&bslash;&n;} while (0)
macro_line|#else
DECL|macro|ds_dbg
mdefine_line|#define ds_dbg(lvl, fmt, arg...) do { } while (0)
macro_line|#endif
multiline_comment|/*====================================================================*/
DECL|struct|socket_bind_t
r_typedef
r_struct
id|socket_bind_t
(brace
DECL|member|driver
r_struct
id|pcmcia_driver
op_star
id|driver
suffix:semicolon
DECL|member|function
id|u_char
id|function
suffix:semicolon
DECL|member|instance
id|dev_link_t
op_star
id|instance
suffix:semicolon
DECL|member|next
r_struct
id|socket_bind_t
op_star
id|next
suffix:semicolon
DECL|typedef|socket_bind_t
)brace
id|socket_bind_t
suffix:semicolon
multiline_comment|/* Device user information */
DECL|macro|MAX_EVENTS
mdefine_line|#define MAX_EVENTS&t;32
DECL|macro|USER_MAGIC
mdefine_line|#define USER_MAGIC&t;0x7ea4
DECL|macro|CHECK_USER
mdefine_line|#define CHECK_USER(u) &bslash;&n;    (((u) == NULL) || ((u)-&gt;user_magic != USER_MAGIC))
DECL|struct|user_info_t
r_typedef
r_struct
id|user_info_t
(brace
DECL|member|user_magic
id|u_int
id|user_magic
suffix:semicolon
DECL|member|event_head
DECL|member|event_tail
r_int
id|event_head
comma
id|event_tail
suffix:semicolon
DECL|member|event
id|event_t
id|event
(braket
id|MAX_EVENTS
)braket
suffix:semicolon
DECL|member|next
r_struct
id|user_info_t
op_star
id|next
suffix:semicolon
DECL|member|socket
r_struct
id|pcmcia_bus_socket
op_star
id|socket
suffix:semicolon
DECL|typedef|user_info_t
)brace
id|user_info_t
suffix:semicolon
multiline_comment|/* Socket state information */
DECL|struct|pcmcia_bus_socket
r_struct
id|pcmcia_bus_socket
(brace
DECL|member|refcount
id|atomic_t
id|refcount
suffix:semicolon
DECL|member|callback
r_struct
id|pcmcia_callback
id|callback
suffix:semicolon
DECL|member|state
r_int
id|state
suffix:semicolon
DECL|member|user
id|user_info_t
op_star
id|user
suffix:semicolon
DECL|member|req_pending
DECL|member|req_result
r_int
id|req_pending
comma
id|req_result
suffix:semicolon
DECL|member|queue
DECL|member|request
id|wait_queue_head_t
id|queue
comma
id|request
suffix:semicolon
DECL|member|bind
id|socket_bind_t
op_star
id|bind
suffix:semicolon
DECL|member|parent
r_struct
id|pcmcia_socket
op_star
id|parent
suffix:semicolon
multiline_comment|/* the PCMCIA devices connected to this socket (normally one, more&n;&t; * for multifunction devices: */
DECL|member|devices_list
r_struct
id|list_head
id|devices_list
suffix:semicolon
DECL|member|device_count
id|u8
id|device_count
suffix:semicolon
multiline_comment|/* the number of devices, used&n;&t;&t;&t;&t;&t;       * only internally and subject&n;&t;&t;&t;&t;&t;       * to incorrectness and change */
)brace
suffix:semicolon
DECL|variable|pcmcia_dev_list_lock
r_static
id|spinlock_t
id|pcmcia_dev_list_lock
suffix:semicolon
DECL|macro|DS_SOCKET_PRESENT
mdefine_line|#define DS_SOCKET_PRESENT&t;&t;0x01
DECL|macro|DS_SOCKET_BUSY
mdefine_line|#define DS_SOCKET_BUSY&t;&t;&t;0x02
DECL|macro|DS_SOCKET_REMOVAL_PENDING
mdefine_line|#define DS_SOCKET_REMOVAL_PENDING&t;0x10
DECL|macro|DS_SOCKET_DEAD
mdefine_line|#define DS_SOCKET_DEAD&t;&t;&t;0x80
multiline_comment|/*====================================================================*/
DECL|variable|major_dev
r_static
r_int
id|major_dev
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/*====================================================================*/
multiline_comment|/* code which was in cs.c before */
multiline_comment|/* String tables for error messages */
DECL|struct|lookup_t
r_typedef
r_struct
id|lookup_t
(brace
DECL|member|key
r_int
id|key
suffix:semicolon
DECL|member|msg
r_char
op_star
id|msg
suffix:semicolon
DECL|typedef|lookup_t
)brace
id|lookup_t
suffix:semicolon
DECL|variable|error_table
r_static
r_const
id|lookup_t
id|error_table
(braket
)braket
op_assign
(brace
(brace
id|CS_SUCCESS
comma
l_string|&quot;Operation succeeded&quot;
)brace
comma
(brace
id|CS_BAD_ADAPTER
comma
l_string|&quot;Bad adapter&quot;
)brace
comma
(brace
id|CS_BAD_ATTRIBUTE
comma
l_string|&quot;Bad attribute&quot;
comma
)brace
comma
(brace
id|CS_BAD_BASE
comma
l_string|&quot;Bad base address&quot;
)brace
comma
(brace
id|CS_BAD_EDC
comma
l_string|&quot;Bad EDC&quot;
)brace
comma
(brace
id|CS_BAD_IRQ
comma
l_string|&quot;Bad IRQ&quot;
)brace
comma
(brace
id|CS_BAD_OFFSET
comma
l_string|&quot;Bad offset&quot;
)brace
comma
(brace
id|CS_BAD_PAGE
comma
l_string|&quot;Bad page number&quot;
)brace
comma
(brace
id|CS_READ_FAILURE
comma
l_string|&quot;Read failure&quot;
)brace
comma
(brace
id|CS_BAD_SIZE
comma
l_string|&quot;Bad size&quot;
)brace
comma
(brace
id|CS_BAD_SOCKET
comma
l_string|&quot;Bad socket&quot;
)brace
comma
(brace
id|CS_BAD_TYPE
comma
l_string|&quot;Bad type&quot;
)brace
comma
(brace
id|CS_BAD_VCC
comma
l_string|&quot;Bad Vcc&quot;
)brace
comma
(brace
id|CS_BAD_VPP
comma
l_string|&quot;Bad Vpp&quot;
)brace
comma
(brace
id|CS_BAD_WINDOW
comma
l_string|&quot;Bad window&quot;
)brace
comma
(brace
id|CS_WRITE_FAILURE
comma
l_string|&quot;Write failure&quot;
)brace
comma
(brace
id|CS_NO_CARD
comma
l_string|&quot;No card present&quot;
)brace
comma
(brace
id|CS_UNSUPPORTED_FUNCTION
comma
l_string|&quot;Usupported function&quot;
)brace
comma
(brace
id|CS_UNSUPPORTED_MODE
comma
l_string|&quot;Unsupported mode&quot;
)brace
comma
(brace
id|CS_BAD_SPEED
comma
l_string|&quot;Bad speed&quot;
)brace
comma
(brace
id|CS_BUSY
comma
l_string|&quot;Resource busy&quot;
)brace
comma
(brace
id|CS_GENERAL_FAILURE
comma
l_string|&quot;General failure&quot;
)brace
comma
(brace
id|CS_WRITE_PROTECTED
comma
l_string|&quot;Write protected&quot;
)brace
comma
(brace
id|CS_BAD_ARG_LENGTH
comma
l_string|&quot;Bad argument length&quot;
)brace
comma
(brace
id|CS_BAD_ARGS
comma
l_string|&quot;Bad arguments&quot;
)brace
comma
(brace
id|CS_CONFIGURATION_LOCKED
comma
l_string|&quot;Configuration locked&quot;
)brace
comma
(brace
id|CS_IN_USE
comma
l_string|&quot;Resource in use&quot;
)brace
comma
(brace
id|CS_NO_MORE_ITEMS
comma
l_string|&quot;No more items&quot;
)brace
comma
(brace
id|CS_OUT_OF_RESOURCE
comma
l_string|&quot;Out of resource&quot;
)brace
comma
(brace
id|CS_BAD_HANDLE
comma
l_string|&quot;Bad handle&quot;
)brace
comma
(brace
id|CS_BAD_TUPLE
comma
l_string|&quot;Bad CIS tuple&quot;
)brace
)brace
suffix:semicolon
DECL|variable|service_table
r_static
r_const
id|lookup_t
id|service_table
(braket
)braket
op_assign
(brace
(brace
id|AccessConfigurationRegister
comma
l_string|&quot;AccessConfigurationRegister&quot;
)brace
comma
(brace
id|AddSocketServices
comma
l_string|&quot;AddSocketServices&quot;
)brace
comma
(brace
id|AdjustResourceInfo
comma
l_string|&quot;AdjustResourceInfo&quot;
)brace
comma
(brace
id|CheckEraseQueue
comma
l_string|&quot;CheckEraseQueue&quot;
)brace
comma
(brace
id|CloseMemory
comma
l_string|&quot;CloseMemory&quot;
)brace
comma
(brace
id|DeregisterClient
comma
l_string|&quot;DeregisterClient&quot;
)brace
comma
(brace
id|DeregisterEraseQueue
comma
l_string|&quot;DeregisterEraseQueue&quot;
)brace
comma
(brace
id|GetCardServicesInfo
comma
l_string|&quot;GetCardServicesInfo&quot;
)brace
comma
(brace
id|GetClientInfo
comma
l_string|&quot;GetClientInfo&quot;
)brace
comma
(brace
id|GetConfigurationInfo
comma
l_string|&quot;GetConfigurationInfo&quot;
)brace
comma
(brace
id|GetEventMask
comma
l_string|&quot;GetEventMask&quot;
)brace
comma
(brace
id|GetFirstClient
comma
l_string|&quot;GetFirstClient&quot;
)brace
comma
(brace
id|GetFirstRegion
comma
l_string|&quot;GetFirstRegion&quot;
)brace
comma
(brace
id|GetFirstTuple
comma
l_string|&quot;GetFirstTuple&quot;
)brace
comma
(brace
id|GetNextClient
comma
l_string|&quot;GetNextClient&quot;
)brace
comma
(brace
id|GetNextRegion
comma
l_string|&quot;GetNextRegion&quot;
)brace
comma
(brace
id|GetNextTuple
comma
l_string|&quot;GetNextTuple&quot;
)brace
comma
(brace
id|GetStatus
comma
l_string|&quot;GetStatus&quot;
)brace
comma
(brace
id|GetTupleData
comma
l_string|&quot;GetTupleData&quot;
)brace
comma
(brace
id|MapMemPage
comma
l_string|&quot;MapMemPage&quot;
)brace
comma
(brace
id|ModifyConfiguration
comma
l_string|&quot;ModifyConfiguration&quot;
)brace
comma
(brace
id|ModifyWindow
comma
l_string|&quot;ModifyWindow&quot;
)brace
comma
(brace
id|OpenMemory
comma
l_string|&quot;OpenMemory&quot;
)brace
comma
(brace
id|ParseTuple
comma
l_string|&quot;ParseTuple&quot;
)brace
comma
(brace
id|ReadMemory
comma
l_string|&quot;ReadMemory&quot;
)brace
comma
(brace
id|RegisterClient
comma
l_string|&quot;RegisterClient&quot;
)brace
comma
(brace
id|RegisterEraseQueue
comma
l_string|&quot;RegisterEraseQueue&quot;
)brace
comma
(brace
id|RegisterMTD
comma
l_string|&quot;RegisterMTD&quot;
)brace
comma
(brace
id|ReleaseConfiguration
comma
l_string|&quot;ReleaseConfiguration&quot;
)brace
comma
(brace
id|ReleaseIO
comma
l_string|&quot;ReleaseIO&quot;
)brace
comma
(brace
id|ReleaseIRQ
comma
l_string|&quot;ReleaseIRQ&quot;
)brace
comma
(brace
id|ReleaseWindow
comma
l_string|&quot;ReleaseWindow&quot;
)brace
comma
(brace
id|RequestConfiguration
comma
l_string|&quot;RequestConfiguration&quot;
)brace
comma
(brace
id|RequestIO
comma
l_string|&quot;RequestIO&quot;
)brace
comma
(brace
id|RequestIRQ
comma
l_string|&quot;RequestIRQ&quot;
)brace
comma
(brace
id|RequestSocketMask
comma
l_string|&quot;RequestSocketMask&quot;
)brace
comma
(brace
id|RequestWindow
comma
l_string|&quot;RequestWindow&quot;
)brace
comma
(brace
id|ResetCard
comma
l_string|&quot;ResetCard&quot;
)brace
comma
(brace
id|SetEventMask
comma
l_string|&quot;SetEventMask&quot;
)brace
comma
(brace
id|ValidateCIS
comma
l_string|&quot;ValidateCIS&quot;
)brace
comma
(brace
id|WriteMemory
comma
l_string|&quot;WriteMemory&quot;
)brace
comma
(brace
id|BindDevice
comma
l_string|&quot;BindDevice&quot;
)brace
comma
(brace
id|BindMTD
comma
l_string|&quot;BindMTD&quot;
)brace
comma
(brace
id|ReportError
comma
l_string|&quot;ReportError&quot;
)brace
comma
(brace
id|SuspendCard
comma
l_string|&quot;SuspendCard&quot;
)brace
comma
(brace
id|ResumeCard
comma
l_string|&quot;ResumeCard&quot;
)brace
comma
(brace
id|EjectCard
comma
l_string|&quot;EjectCard&quot;
)brace
comma
(brace
id|InsertCard
comma
l_string|&quot;InsertCard&quot;
)brace
comma
(brace
id|ReplaceCIS
comma
l_string|&quot;ReplaceCIS&quot;
)brace
)brace
suffix:semicolon
DECL|function|pcmcia_report_error
r_int
id|pcmcia_report_error
c_func
(paren
id|client_handle_t
id|handle
comma
id|error_info_t
op_star
id|err
)paren
(brace
r_int
id|i
suffix:semicolon
r_char
op_star
id|serv
suffix:semicolon
r_if
c_cond
(paren
id|CHECK_HANDLE
c_func
(paren
id|handle
)paren
)paren
id|printk
c_func
(paren
id|KERN_NOTICE
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;%s: &quot;
comma
id|handle-&gt;dev_info
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ARRAY_SIZE
c_func
(paren
id|service_table
)paren
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|service_table
(braket
id|i
)braket
dot
id|key
op_eq
id|err-&gt;func
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
id|ARRAY_SIZE
c_func
(paren
id|service_table
)paren
)paren
id|serv
op_assign
id|service_table
(braket
id|i
)braket
dot
id|msg
suffix:semicolon
r_else
id|serv
op_assign
l_string|&quot;Unknown service number&quot;
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ARRAY_SIZE
c_func
(paren
id|error_table
)paren
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|error_table
(braket
id|i
)braket
dot
id|key
op_eq
id|err-&gt;retcode
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
id|ARRAY_SIZE
c_func
(paren
id|error_table
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;%s: %s&bslash;n&quot;
comma
id|serv
comma
id|error_table
(braket
id|i
)braket
dot
id|msg
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
l_string|&quot;%s: Unknown error code %#x&bslash;n&quot;
comma
id|serv
comma
id|err-&gt;retcode
)paren
suffix:semicolon
r_return
id|CS_SUCCESS
suffix:semicolon
)brace
multiline_comment|/* report_error */
DECL|variable|pcmcia_report_error
id|EXPORT_SYMBOL
c_func
(paren
id|pcmcia_report_error
)paren
suffix:semicolon
multiline_comment|/* end of code which was in cs.c before */
multiline_comment|/*======================================================================*/
DECL|function|cs_error
r_void
id|cs_error
c_func
(paren
id|client_handle_t
id|handle
comma
r_int
id|func
comma
r_int
id|ret
)paren
(brace
id|error_info_t
id|err
op_assign
(brace
id|func
comma
id|ret
)brace
suffix:semicolon
id|pcmcia_report_error
c_func
(paren
id|handle
comma
op_amp
id|err
)paren
suffix:semicolon
)brace
DECL|variable|cs_error
id|EXPORT_SYMBOL
c_func
(paren
id|cs_error
)paren
suffix:semicolon
multiline_comment|/*======================================================================*/
r_static
r_struct
id|pcmcia_driver
op_star
id|get_pcmcia_driver
(paren
id|dev_info_t
op_star
id|dev_info
)paren
suffix:semicolon
r_static
r_struct
id|pcmcia_bus_socket
op_star
id|get_socket_info_by_nr
c_func
(paren
r_int
r_int
id|nr
)paren
suffix:semicolon
DECL|function|pcmcia_put_bus_socket
r_static
r_void
id|pcmcia_put_bus_socket
c_func
(paren
r_struct
id|pcmcia_bus_socket
op_star
id|s
)paren
(brace
r_if
c_cond
(paren
id|atomic_dec_and_test
c_func
(paren
op_amp
id|s-&gt;refcount
)paren
)paren
id|kfree
c_func
(paren
id|s
)paren
suffix:semicolon
)brace
DECL|function|pcmcia_get_bus_socket
r_static
r_struct
id|pcmcia_bus_socket
op_star
id|pcmcia_get_bus_socket
c_func
(paren
r_int
id|nr
)paren
(brace
r_struct
id|pcmcia_bus_socket
op_star
id|s
suffix:semicolon
id|s
op_assign
id|get_socket_info_by_nr
c_func
(paren
id|nr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
)paren
(brace
id|WARN_ON
c_func
(paren
id|atomic_read
c_func
(paren
op_amp
id|s-&gt;refcount
)paren
op_eq
l_int|0
)paren
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|s-&gt;refcount
)paren
suffix:semicolon
)brace
r_return
id|s
suffix:semicolon
)brace
multiline_comment|/**&n; * pcmcia_register_driver - register a PCMCIA driver with the bus core&n; *&n; * Registers a PCMCIA driver with the PCMCIA bus core.&n; */
DECL|function|pcmcia_register_driver
r_int
id|pcmcia_register_driver
c_func
(paren
r_struct
id|pcmcia_driver
op_star
id|driver
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|driver
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|driver-&gt;use_count
op_assign
l_int|0
suffix:semicolon
id|driver-&gt;drv.bus
op_assign
op_amp
id|pcmcia_bus_type
suffix:semicolon
r_return
id|driver_register
c_func
(paren
op_amp
id|driver-&gt;drv
)paren
suffix:semicolon
)brace
DECL|variable|pcmcia_register_driver
id|EXPORT_SYMBOL
c_func
(paren
id|pcmcia_register_driver
)paren
suffix:semicolon
multiline_comment|/**&n; * pcmcia_unregister_driver - unregister a PCMCIA driver with the bus core&n; */
DECL|function|pcmcia_unregister_driver
r_void
id|pcmcia_unregister_driver
c_func
(paren
r_struct
id|pcmcia_driver
op_star
id|driver
)paren
(brace
id|driver_unregister
c_func
(paren
op_amp
id|driver-&gt;drv
)paren
suffix:semicolon
)brace
DECL|variable|pcmcia_unregister_driver
id|EXPORT_SYMBOL
c_func
(paren
id|pcmcia_unregister_driver
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_PROC_FS
DECL|variable|proc_pccard
r_static
r_struct
id|proc_dir_entry
op_star
id|proc_pccard
op_assign
l_int|NULL
suffix:semicolon
DECL|function|proc_read_drivers_callback
r_static
r_int
id|proc_read_drivers_callback
c_func
(paren
r_struct
id|device_driver
op_star
id|driver
comma
r_void
op_star
id|d
)paren
(brace
r_char
op_star
op_star
id|p
op_assign
id|d
suffix:semicolon
r_struct
id|pcmcia_driver
op_star
id|p_dev
op_assign
id|container_of
c_func
(paren
id|driver
comma
r_struct
id|pcmcia_driver
comma
id|drv
)paren
suffix:semicolon
op_star
id|p
op_add_assign
id|sprintf
c_func
(paren
op_star
id|p
comma
l_string|&quot;%-24.24s 1 %d&bslash;n&quot;
comma
id|driver-&gt;name
comma
id|p_dev-&gt;use_count
)paren
suffix:semicolon
id|d
op_assign
(paren
r_void
op_star
)paren
id|p
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|proc_read_drivers
r_static
r_int
id|proc_read_drivers
c_func
(paren
r_char
op_star
id|buf
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|pos
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
r_char
op_star
id|p
op_assign
id|buf
suffix:semicolon
id|bus_for_each_drv
c_func
(paren
op_amp
id|pcmcia_bus_type
comma
l_int|NULL
comma
(paren
r_void
op_star
)paren
op_amp
id|p
comma
id|proc_read_drivers_callback
)paren
suffix:semicolon
r_return
(paren
id|p
op_minus
id|buf
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* pcmcia_device handling */
DECL|function|pcmcia_release_dev
r_static
r_void
id|pcmcia_release_dev
c_func
(paren
r_struct
id|device
op_star
id|dev
)paren
(brace
r_struct
id|pcmcia_device
op_star
id|p_dev
op_assign
id|to_pcmcia_dev
c_func
(paren
id|dev
)paren
suffix:semicolon
id|p_dev-&gt;socket-&gt;pcmcia-&gt;device_count
op_assign
l_int|0
suffix:semicolon
id|kfree
c_func
(paren
id|p_dev
)paren
suffix:semicolon
)brace
multiline_comment|/*======================================================================&n;&n;    These manage a ring buffer of events pending for one user process&n;    &n;======================================================================*/
DECL|function|queue_empty
r_static
r_int
id|queue_empty
c_func
(paren
id|user_info_t
op_star
id|user
)paren
(brace
r_return
(paren
id|user-&gt;event_head
op_eq
id|user-&gt;event_tail
)paren
suffix:semicolon
)brace
DECL|function|get_queued_event
r_static
id|event_t
id|get_queued_event
c_func
(paren
id|user_info_t
op_star
id|user
)paren
(brace
id|user-&gt;event_tail
op_assign
(paren
id|user-&gt;event_tail
op_plus
l_int|1
)paren
op_mod
id|MAX_EVENTS
suffix:semicolon
r_return
id|user-&gt;event
(braket
id|user-&gt;event_tail
)braket
suffix:semicolon
)brace
DECL|function|queue_event
r_static
r_void
id|queue_event
c_func
(paren
id|user_info_t
op_star
id|user
comma
id|event_t
id|event
)paren
(brace
id|user-&gt;event_head
op_assign
(paren
id|user-&gt;event_head
op_plus
l_int|1
)paren
op_mod
id|MAX_EVENTS
suffix:semicolon
r_if
c_cond
(paren
id|user-&gt;event_head
op_eq
id|user-&gt;event_tail
)paren
id|user-&gt;event_tail
op_assign
(paren
id|user-&gt;event_tail
op_plus
l_int|1
)paren
op_mod
id|MAX_EVENTS
suffix:semicolon
id|user-&gt;event
(braket
id|user-&gt;event_head
)braket
op_assign
id|event
suffix:semicolon
)brace
DECL|function|handle_event
r_static
r_void
id|handle_event
c_func
(paren
r_struct
id|pcmcia_bus_socket
op_star
id|s
comma
id|event_t
id|event
)paren
(brace
id|user_info_t
op_star
id|user
suffix:semicolon
r_for
c_loop
(paren
id|user
op_assign
id|s-&gt;user
suffix:semicolon
id|user
suffix:semicolon
id|user
op_assign
id|user-&gt;next
)paren
id|queue_event
c_func
(paren
id|user
comma
id|event
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|s-&gt;queue
)paren
suffix:semicolon
)brace
DECL|function|handle_request
r_static
r_int
id|handle_request
c_func
(paren
r_struct
id|pcmcia_bus_socket
op_star
id|s
comma
id|event_t
id|event
)paren
(brace
r_if
c_cond
(paren
id|s-&gt;req_pending
op_ne
l_int|0
)paren
r_return
id|CS_IN_USE
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;state
op_amp
id|DS_SOCKET_BUSY
)paren
id|s-&gt;req_pending
op_assign
l_int|1
suffix:semicolon
id|handle_event
c_func
(paren
id|s
comma
id|event
)paren
suffix:semicolon
r_if
c_cond
(paren
id|wait_event_interruptible
c_func
(paren
id|s-&gt;request
comma
id|s-&gt;req_pending
op_le
l_int|0
)paren
)paren
r_return
id|CS_IN_USE
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;state
op_amp
id|DS_SOCKET_BUSY
)paren
r_return
id|s-&gt;req_result
suffix:semicolon
r_return
id|CS_SUCCESS
suffix:semicolon
)brace
multiline_comment|/*======================================================================&n;&n;    The card status event handler.&n;    &n;======================================================================*/
DECL|function|send_event
r_static
r_int
id|send_event
c_func
(paren
r_struct
id|pcmcia_socket
op_star
id|s
comma
id|event_t
id|event
comma
r_int
id|priority
)paren
(brace
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
id|client_t
op_star
id|client
suffix:semicolon
r_for
c_loop
(paren
id|client
op_assign
id|s-&gt;clients
suffix:semicolon
id|client
suffix:semicolon
id|client
op_assign
id|client-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|client-&gt;state
op_amp
(paren
id|CLIENT_UNBOUND
op_or
id|CLIENT_STALE
)paren
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|client-&gt;EventMask
op_amp
id|event
)paren
(brace
id|ret
op_assign
id|EVENT
c_func
(paren
id|client
comma
id|event
comma
id|priority
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ne
l_int|0
)paren
r_return
id|ret
suffix:semicolon
)brace
)brace
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* send_event */
multiline_comment|/* Normally, the event is passed to individual drivers after&n; * informing userspace. Only for CS_EVENT_CARD_REMOVAL this&n; * is inversed to maintain historic compatibility.&n; */
DECL|function|ds_event
r_static
r_int
id|ds_event
c_func
(paren
r_struct
id|pcmcia_socket
op_star
id|skt
comma
id|event_t
id|event
comma
r_int
id|priority
)paren
(brace
r_struct
id|pcmcia_bus_socket
op_star
id|s
op_assign
id|skt-&gt;pcmcia
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
id|ds_dbg
c_func
(paren
l_int|1
comma
l_string|&quot;ds_event(0x%06x, %d, 0x%p)&bslash;n&quot;
comma
id|event
comma
id|priority
comma
id|s
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|event
)paren
(brace
r_case
id|CS_EVENT_CARD_REMOVAL
suffix:colon
id|s-&gt;state
op_and_assign
op_complement
id|DS_SOCKET_PRESENT
suffix:semicolon
id|send_event
c_func
(paren
id|skt
comma
id|event
comma
id|priority
)paren
suffix:semicolon
id|handle_event
c_func
(paren
id|s
comma
id|event
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS_EVENT_CARD_INSERTION
suffix:colon
id|s-&gt;state
op_or_assign
id|DS_SOCKET_PRESENT
suffix:semicolon
id|handle_event
c_func
(paren
id|s
comma
id|event
)paren
suffix:semicolon
id|send_event
c_func
(paren
id|skt
comma
id|event
comma
id|priority
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS_EVENT_EJECTION_REQUEST
suffix:colon
id|ret
op_assign
id|handle_request
c_func
(paren
id|s
comma
id|event
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_break
suffix:semicolon
id|ret
op_assign
id|send_event
c_func
(paren
id|skt
comma
id|event
comma
id|priority
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|handle_event
c_func
(paren
id|s
comma
id|event
)paren
suffix:semicolon
id|send_event
c_func
(paren
id|skt
comma
id|event
comma
id|priority
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* ds_event */
multiline_comment|/*======================================================================&n;&n;    bind_mtd() connects a memory region with an MTD client.&n;    &n;======================================================================*/
DECL|function|bind_mtd
r_static
r_int
id|bind_mtd
c_func
(paren
r_struct
id|pcmcia_bus_socket
op_star
id|bus_sock
comma
id|mtd_info_t
op_star
id|mtd_info
)paren
(brace
r_struct
id|pcmcia_socket
op_star
id|s
op_assign
id|bus_sock-&gt;parent
suffix:semicolon
id|memory_handle_t
id|region
suffix:semicolon
r_if
c_cond
(paren
id|mtd_info-&gt;Attributes
op_amp
id|REGION_TYPE_AM
)paren
id|region
op_assign
id|s-&gt;a_region
suffix:semicolon
r_else
id|region
op_assign
id|s-&gt;c_region
suffix:semicolon
r_while
c_loop
(paren
id|region
)paren
(brace
r_if
c_cond
(paren
id|region-&gt;info.CardOffset
op_eq
id|mtd_info-&gt;CardOffset
)paren
r_break
suffix:semicolon
id|region
op_assign
id|region-&gt;info.next
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|region
op_logical_or
(paren
id|region-&gt;mtd
op_ne
l_int|NULL
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|strlcpy
c_func
(paren
id|region-&gt;dev_info
comma
id|mtd_info-&gt;dev_info
comma
id|DEV_NAME_LEN
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* bind_mtd */
multiline_comment|/*======================================================================&n;&n;    bind_request() and bind_device() are merged by now. Individual&n;    descriptions:&n;&n;    bind_request() connects a socket to a particular client driver.&n;    It looks up the specified device ID in the list of registered&n;    drivers, binds it to the socket, and tries to create an instance&n;    of the device.  unbind_request() deletes a driver instance.&n;    &n;    Bind_device() associates a device driver with a particular socket.&n;    It is normally called by Driver Services after it has identified&n;    a newly inserted card.  An instance of that driver will then be&n;    eligible to register as a client of this socket.&n;&n;======================================================================*/
DECL|function|bind_request
r_static
r_int
id|bind_request
c_func
(paren
r_struct
id|pcmcia_bus_socket
op_star
id|s
comma
id|bind_info_t
op_star
id|bind_info
)paren
(brace
r_struct
id|pcmcia_driver
op_star
id|driver
suffix:semicolon
r_struct
id|pcmcia_device
op_star
id|p_dev
suffix:semicolon
id|socket_bind_t
op_star
id|b
suffix:semicolon
id|client_t
op_star
id|client
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|s
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|ds_dbg
c_func
(paren
l_int|2
comma
l_string|&quot;bind_request(%d, &squot;%s&squot;)&bslash;n&quot;
comma
id|s-&gt;parent-&gt;sock
comma
(paren
r_char
op_star
)paren
id|bind_info-&gt;dev_info
)paren
suffix:semicolon
id|driver
op_assign
id|get_pcmcia_driver
c_func
(paren
op_amp
id|bind_info-&gt;dev_info
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|driver
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_for
c_loop
(paren
id|b
op_assign
id|s-&gt;bind
suffix:semicolon
id|b
suffix:semicolon
id|b
op_assign
id|b-&gt;next
)paren
r_if
c_cond
(paren
(paren
id|driver
op_eq
id|b-&gt;driver
)paren
op_logical_and
(paren
id|bind_info-&gt;function
op_eq
id|b-&gt;function
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|b
op_ne
l_int|NULL
)paren
(brace
id|bind_info-&gt;instance
op_assign
id|b-&gt;instance
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|try_module_get
c_func
(paren
id|driver-&gt;owner
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|client
op_assign
(paren
id|client_t
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|client_t
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|client
)paren
(brace
id|module_put
c_func
(paren
id|driver-&gt;owner
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|client
comma
l_int|0
comma
r_sizeof
(paren
id|client_t
)paren
)paren
suffix:semicolon
id|client-&gt;client_magic
op_assign
id|CLIENT_MAGIC
suffix:semicolon
id|client-&gt;Socket
op_assign
id|s-&gt;parent
suffix:semicolon
id|client-&gt;Function
op_assign
id|bind_info-&gt;function
suffix:semicolon
id|client-&gt;state
op_assign
id|CLIENT_UNBOUND
suffix:semicolon
id|client-&gt;next
op_assign
id|s-&gt;parent-&gt;clients
suffix:semicolon
id|strlcpy
c_func
(paren
id|client-&gt;dev_info
comma
id|driver-&gt;drv.name
comma
id|DEV_NAME_LEN
)paren
suffix:semicolon
id|s-&gt;parent-&gt;clients
op_assign
id|client
suffix:semicolon
multiline_comment|/* Add binding to list for this socket */
id|b
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|socket_bind_t
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|b
)paren
(brace
id|module_put
c_func
(paren
id|driver-&gt;owner
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|b-&gt;driver
op_assign
id|driver
suffix:semicolon
id|b-&gt;function
op_assign
id|bind_info-&gt;function
suffix:semicolon
id|b-&gt;instance
op_assign
l_int|NULL
suffix:semicolon
id|b-&gt;next
op_assign
id|s-&gt;bind
suffix:semicolon
id|s-&gt;bind
op_assign
id|b
suffix:semicolon
multiline_comment|/* Currently, the userspace pcmcia cardmgr detects pcmcia devices.&n;&t; * Here this information is translated into a kernel&n;&t; * struct pcmcia_device.&n;&t; */
id|p_dev
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|pcmcia_device
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|p_dev
)paren
(brace
multiline_comment|/* FIXME: client isn&squot;t freed here */
r_goto
id|no_p_dev
suffix:semicolon
)brace
id|memset
c_func
(paren
id|p_dev
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|pcmcia_device
)paren
)paren
suffix:semicolon
id|p_dev-&gt;socket
op_assign
id|s-&gt;parent
suffix:semicolon
id|p_dev-&gt;device_no
op_assign
(paren
id|s-&gt;device_count
op_increment
)paren
suffix:semicolon
id|p_dev-&gt;func
op_assign
id|bind_info-&gt;function
suffix:semicolon
id|p_dev-&gt;dev.bus
op_assign
op_amp
id|pcmcia_bus_type
suffix:semicolon
id|p_dev-&gt;dev.parent
op_assign
id|s-&gt;parent-&gt;dev.dev
suffix:semicolon
id|p_dev-&gt;dev.release
op_assign
id|pcmcia_release_dev
suffix:semicolon
id|sprintf
(paren
id|p_dev-&gt;dev.bus_id
comma
l_string|&quot;pcmcia%d.%d&quot;
comma
id|p_dev-&gt;socket-&gt;sock
comma
id|p_dev-&gt;device_no
)paren
suffix:semicolon
id|p_dev-&gt;dev.driver
op_assign
op_amp
id|driver-&gt;drv
suffix:semicolon
r_if
c_cond
(paren
id|device_register
c_func
(paren
op_amp
id|p_dev-&gt;dev
)paren
)paren
(brace
multiline_comment|/* FIXME: client isn&squot;t freed here */
id|kfree
c_func
(paren
id|p_dev
)paren
suffix:semicolon
r_goto
id|no_p_dev
suffix:semicolon
)brace
id|spin_lock_irqsave
c_func
(paren
op_amp
id|pcmcia_dev_list_lock
comma
id|flags
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|p_dev-&gt;socket_device_list
comma
op_amp
id|s-&gt;devices_list
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|pcmcia_dev_list_lock
comma
id|flags
)paren
suffix:semicolon
id|no_p_dev
suffix:colon
id|driver-&gt;use_count
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|driver-&gt;attach
)paren
(brace
id|b-&gt;instance
op_assign
id|driver
op_member_access_from_pointer
id|attach
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|b-&gt;instance
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;ds: unable to create instance &quot;
l_string|&quot;of &squot;%s&squot;!&bslash;n&quot;
comma
(paren
r_char
op_star
)paren
id|bind_info-&gt;dev_info
)paren
suffix:semicolon
id|module_put
c_func
(paren
id|driver-&gt;owner
)paren
suffix:semicolon
multiline_comment|/* FIXME: client isn&squot;t freed here */
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* bind_request */
multiline_comment|/*====================================================================*/
r_extern
r_struct
id|pci_bus
op_star
id|pcmcia_lookup_bus
c_func
(paren
r_struct
id|pcmcia_socket
op_star
id|s
)paren
suffix:semicolon
DECL|function|get_device_info
r_static
r_int
id|get_device_info
c_func
(paren
r_struct
id|pcmcia_bus_socket
op_star
id|s
comma
id|bind_info_t
op_star
id|bind_info
comma
r_int
id|first
)paren
(brace
id|socket_bind_t
op_star
id|b
suffix:semicolon
id|dev_node_t
op_star
id|node
suffix:semicolon
macro_line|#ifdef CONFIG_CARDBUS
multiline_comment|/*&n;     * Some unbelievably ugly code to associate the PCI cardbus&n;     * device and its driver with the PCMCIA &quot;bind&quot; information.&n;     */
(brace
r_struct
id|pci_bus
op_star
id|bus
suffix:semicolon
id|bus
op_assign
id|pcmcia_lookup_bus
c_func
(paren
id|s-&gt;parent
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bus
)paren
(brace
r_struct
id|list_head
op_star
id|list
suffix:semicolon
r_struct
id|pci_dev
op_star
id|dev
op_assign
l_int|NULL
suffix:semicolon
id|list
op_assign
id|bus-&gt;devices.next
suffix:semicolon
r_while
c_loop
(paren
id|list
op_ne
op_amp
id|bus-&gt;devices
)paren
(brace
r_struct
id|pci_dev
op_star
id|pdev
op_assign
id|pci_dev_b
c_func
(paren
id|list
)paren
suffix:semicolon
id|list
op_assign
id|list-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|first
)paren
(brace
id|dev
op_assign
id|pdev
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* Try to handle &quot;next&quot; here some way? */
)brace
r_if
c_cond
(paren
id|dev
op_logical_and
id|dev-&gt;driver
)paren
(brace
id|strlcpy
c_func
(paren
id|bind_info-&gt;name
comma
id|dev-&gt;driver-&gt;name
comma
id|DEV_NAME_LEN
)paren
suffix:semicolon
id|bind_info-&gt;major
op_assign
l_int|0
suffix:semicolon
id|bind_info-&gt;minor
op_assign
l_int|0
suffix:semicolon
id|bind_info-&gt;next
op_assign
l_int|NULL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
)brace
macro_line|#endif
r_for
c_loop
(paren
id|b
op_assign
id|s-&gt;bind
suffix:semicolon
id|b
suffix:semicolon
id|b
op_assign
id|b-&gt;next
)paren
r_if
c_cond
(paren
(paren
id|strcmp
c_func
(paren
(paren
r_char
op_star
)paren
id|b-&gt;driver-&gt;drv.name
comma
(paren
r_char
op_star
)paren
id|bind_info-&gt;dev_info
)paren
op_eq
l_int|0
)paren
op_logical_and
(paren
id|b-&gt;function
op_eq
id|bind_info-&gt;function
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|b
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
(paren
id|b-&gt;instance
op_eq
l_int|NULL
)paren
op_logical_or
(paren
id|b-&gt;instance-&gt;state
op_amp
id|DEV_CONFIG_PENDING
)paren
)paren
r_return
op_minus
id|EAGAIN
suffix:semicolon
r_if
c_cond
(paren
id|first
)paren
id|node
op_assign
id|b-&gt;instance-&gt;dev
suffix:semicolon
r_else
r_for
c_loop
(paren
id|node
op_assign
id|b-&gt;instance-&gt;dev
suffix:semicolon
id|node
suffix:semicolon
id|node
op_assign
id|node-&gt;next
)paren
r_if
c_cond
(paren
id|node
op_eq
id|bind_info-&gt;next
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|node
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|strlcpy
c_func
(paren
id|bind_info-&gt;name
comma
id|node-&gt;dev_name
comma
id|DEV_NAME_LEN
)paren
suffix:semicolon
id|bind_info-&gt;major
op_assign
id|node-&gt;major
suffix:semicolon
id|bind_info-&gt;minor
op_assign
id|node-&gt;minor
suffix:semicolon
id|bind_info-&gt;next
op_assign
id|node-&gt;next
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* get_device_info */
multiline_comment|/*====================================================================*/
DECL|function|unbind_request
r_static
r_int
id|unbind_request
c_func
(paren
r_struct
id|pcmcia_bus_socket
op_star
id|s
comma
id|bind_info_t
op_star
id|bind_info
)paren
(brace
id|socket_bind_t
op_star
op_star
id|b
comma
op_star
id|c
suffix:semicolon
r_struct
id|pcmcia_device
op_star
id|p_dev
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
id|ds_dbg
c_func
(paren
l_int|2
comma
l_string|&quot;unbind_request(%d, &squot;%s&squot;)&bslash;n&quot;
comma
id|s-&gt;parent-&gt;sock
comma
(paren
r_char
op_star
)paren
id|bind_info-&gt;dev_info
)paren
suffix:semicolon
r_for
c_loop
(paren
id|b
op_assign
op_amp
id|s-&gt;bind
suffix:semicolon
op_star
id|b
suffix:semicolon
id|b
op_assign
op_amp
(paren
op_star
id|b
)paren
op_member_access_from_pointer
id|next
)paren
r_if
c_cond
(paren
(paren
id|strcmp
c_func
(paren
(paren
r_char
op_star
)paren
(paren
op_star
id|b
)paren
op_member_access_from_pointer
id|driver-&gt;drv.name
comma
(paren
r_char
op_star
)paren
id|bind_info-&gt;dev_info
)paren
op_eq
l_int|0
)paren
op_logical_and
(paren
(paren
op_star
id|b
)paren
op_member_access_from_pointer
id|function
op_eq
id|bind_info-&gt;function
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
op_star
id|b
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|c
op_assign
op_star
id|b
suffix:semicolon
id|c-&gt;driver-&gt;use_count
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|c-&gt;driver-&gt;detach
)paren
(brace
r_if
c_cond
(paren
id|c-&gt;instance
)paren
id|c-&gt;driver
op_member_access_from_pointer
id|detach
c_func
(paren
id|c-&gt;instance
)paren
suffix:semicolon
)brace
id|module_put
c_func
(paren
id|c-&gt;driver-&gt;owner
)paren
suffix:semicolon
op_star
id|b
op_assign
id|c-&gt;next
suffix:semicolon
id|kfree
c_func
(paren
id|c
)paren
suffix:semicolon
id|restart
suffix:colon
multiline_comment|/* unregister the pcmcia_device */
id|spin_lock_irqsave
c_func
(paren
op_amp
id|pcmcia_dev_list_lock
comma
id|flags
)paren
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|p_dev
comma
op_amp
id|s-&gt;devices_list
comma
id|socket_device_list
)paren
(brace
r_if
c_cond
(paren
id|p_dev-&gt;func
op_eq
id|bind_info-&gt;function
)paren
(brace
id|list_del
c_func
(paren
op_amp
id|p_dev-&gt;socket_device_list
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|pcmcia_dev_list_lock
comma
id|flags
)paren
suffix:semicolon
id|device_unregister
c_func
(paren
op_amp
id|p_dev-&gt;dev
)paren
suffix:semicolon
multiline_comment|/* multiple devices may be registered to this &quot;function&quot; */
r_goto
id|restart
suffix:semicolon
)brace
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|pcmcia_dev_list_lock
comma
id|flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* unbind_request */
multiline_comment|/*======================================================================&n;&n;    The user-mode PC Card device interface&n;&n;======================================================================*/
DECL|function|ds_open
r_static
r_int
id|ds_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
id|socket_t
id|i
op_assign
id|iminor
c_func
(paren
id|inode
)paren
suffix:semicolon
r_struct
id|pcmcia_bus_socket
op_star
id|s
suffix:semicolon
id|user_info_t
op_star
id|user
suffix:semicolon
id|ds_dbg
c_func
(paren
l_int|0
comma
l_string|&quot;ds_open(socket %d)&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
id|s
op_assign
id|pcmcia_get_bus_socket
c_func
(paren
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|s
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
(paren
id|file-&gt;f_flags
op_amp
id|O_ACCMODE
)paren
op_ne
id|O_RDONLY
)paren
(brace
r_if
c_cond
(paren
id|s-&gt;state
op_amp
id|DS_SOCKET_BUSY
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
r_else
id|s-&gt;state
op_or_assign
id|DS_SOCKET_BUSY
suffix:semicolon
)brace
id|user
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|user_info_t
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|user
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|user-&gt;event_tail
op_assign
id|user-&gt;event_head
op_assign
l_int|0
suffix:semicolon
id|user-&gt;next
op_assign
id|s-&gt;user
suffix:semicolon
id|user-&gt;user_magic
op_assign
id|USER_MAGIC
suffix:semicolon
id|user-&gt;socket
op_assign
id|s
suffix:semicolon
id|s-&gt;user
op_assign
id|user
suffix:semicolon
id|file-&gt;private_data
op_assign
id|user
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;state
op_amp
id|DS_SOCKET_PRESENT
)paren
id|queue_event
c_func
(paren
id|user
comma
id|CS_EVENT_CARD_INSERTION
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* ds_open */
multiline_comment|/*====================================================================*/
DECL|function|ds_release
r_static
r_int
id|ds_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|pcmcia_bus_socket
op_star
id|s
suffix:semicolon
id|user_info_t
op_star
id|user
comma
op_star
op_star
id|link
suffix:semicolon
id|ds_dbg
c_func
(paren
l_int|0
comma
l_string|&quot;ds_release(socket %d)&bslash;n&quot;
comma
id|iminor
c_func
(paren
id|inode
)paren
)paren
suffix:semicolon
id|user
op_assign
id|file-&gt;private_data
suffix:semicolon
r_if
c_cond
(paren
id|CHECK_USER
c_func
(paren
id|user
)paren
)paren
r_goto
id|out
suffix:semicolon
id|s
op_assign
id|user-&gt;socket
suffix:semicolon
multiline_comment|/* Unlink user data structure */
r_if
c_cond
(paren
(paren
id|file-&gt;f_flags
op_amp
id|O_ACCMODE
)paren
op_ne
id|O_RDONLY
)paren
(brace
id|s-&gt;state
op_and_assign
op_complement
id|DS_SOCKET_BUSY
suffix:semicolon
id|s-&gt;req_pending
op_assign
l_int|0
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|s-&gt;request
)paren
suffix:semicolon
)brace
id|file-&gt;private_data
op_assign
l_int|NULL
suffix:semicolon
r_for
c_loop
(paren
id|link
op_assign
op_amp
id|s-&gt;user
suffix:semicolon
op_star
id|link
suffix:semicolon
id|link
op_assign
op_amp
(paren
op_star
id|link
)paren
op_member_access_from_pointer
id|next
)paren
r_if
c_cond
(paren
op_star
id|link
op_eq
id|user
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|link
op_eq
l_int|NULL
)paren
r_goto
id|out
suffix:semicolon
op_star
id|link
op_assign
id|user-&gt;next
suffix:semicolon
id|user-&gt;user_magic
op_assign
l_int|0
suffix:semicolon
id|kfree
c_func
(paren
id|user
)paren
suffix:semicolon
id|pcmcia_put_bus_socket
c_func
(paren
id|s
)paren
suffix:semicolon
id|out
suffix:colon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* ds_release */
multiline_comment|/*====================================================================*/
DECL|function|ds_read
r_static
id|ssize_t
id|ds_read
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_char
id|__user
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_struct
id|pcmcia_bus_socket
op_star
id|s
suffix:semicolon
id|user_info_t
op_star
id|user
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|ds_dbg
c_func
(paren
l_int|2
comma
l_string|&quot;ds_read(socket %d)&bslash;n&quot;
comma
id|iminor
c_func
(paren
id|file-&gt;f_dentry-&gt;d_inode
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
OL
l_int|4
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|user
op_assign
id|file-&gt;private_data
suffix:semicolon
r_if
c_cond
(paren
id|CHECK_USER
c_func
(paren
id|user
)paren
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|s
op_assign
id|user-&gt;socket
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;state
op_amp
id|DS_SOCKET_DEAD
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|ret
op_assign
id|wait_event_interruptible
c_func
(paren
id|s-&gt;queue
comma
op_logical_neg
id|queue_empty
c_func
(paren
id|user
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
l_int|0
)paren
id|ret
op_assign
id|put_user
c_func
(paren
id|get_queued_event
c_func
(paren
id|user
)paren
comma
(paren
r_int
id|__user
op_star
)paren
id|buf
)paren
ques
c_cond
op_minus
id|EFAULT
suffix:colon
l_int|4
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* ds_read */
multiline_comment|/*====================================================================*/
DECL|function|ds_write
r_static
id|ssize_t
id|ds_write
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
id|__user
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_struct
id|pcmcia_bus_socket
op_star
id|s
suffix:semicolon
id|user_info_t
op_star
id|user
suffix:semicolon
id|ds_dbg
c_func
(paren
l_int|2
comma
l_string|&quot;ds_write(socket %d)&bslash;n&quot;
comma
id|iminor
c_func
(paren
id|file-&gt;f_dentry-&gt;d_inode
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
op_ne
l_int|4
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
(paren
id|file-&gt;f_flags
op_amp
id|O_ACCMODE
)paren
op_eq
id|O_RDONLY
)paren
r_return
op_minus
id|EBADF
suffix:semicolon
id|user
op_assign
id|file-&gt;private_data
suffix:semicolon
r_if
c_cond
(paren
id|CHECK_USER
c_func
(paren
id|user
)paren
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|s
op_assign
id|user-&gt;socket
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;state
op_amp
id|DS_SOCKET_DEAD
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;req_pending
)paren
(brace
id|s-&gt;req_pending
op_decrement
suffix:semicolon
id|get_user
c_func
(paren
id|s-&gt;req_result
comma
(paren
r_int
id|__user
op_star
)paren
id|buf
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|s-&gt;req_result
op_ne
l_int|0
)paren
op_logical_or
(paren
id|s-&gt;req_pending
op_eq
l_int|0
)paren
)paren
id|wake_up_interruptible
c_func
(paren
op_amp
id|s-&gt;request
)paren
suffix:semicolon
)brace
r_else
r_return
op_minus
id|EIO
suffix:semicolon
r_return
l_int|4
suffix:semicolon
)brace
multiline_comment|/* ds_write */
multiline_comment|/*====================================================================*/
multiline_comment|/* No kernel lock - fine */
DECL|function|ds_poll
r_static
id|u_int
id|ds_poll
c_func
(paren
r_struct
id|file
op_star
id|file
comma
id|poll_table
op_star
id|wait
)paren
(brace
r_struct
id|pcmcia_bus_socket
op_star
id|s
suffix:semicolon
id|user_info_t
op_star
id|user
suffix:semicolon
id|ds_dbg
c_func
(paren
l_int|2
comma
l_string|&quot;ds_poll(socket %d)&bslash;n&quot;
comma
id|iminor
c_func
(paren
id|file-&gt;f_dentry-&gt;d_inode
)paren
)paren
suffix:semicolon
id|user
op_assign
id|file-&gt;private_data
suffix:semicolon
r_if
c_cond
(paren
id|CHECK_USER
c_func
(paren
id|user
)paren
)paren
r_return
id|POLLERR
suffix:semicolon
id|s
op_assign
id|user-&gt;socket
suffix:semicolon
multiline_comment|/*&n;     * We don&squot;t check for a dead socket here since that&n;     * will send cardmgr into an endless spin.&n;     */
id|poll_wait
c_func
(paren
id|file
comma
op_amp
id|s-&gt;queue
comma
id|wait
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|queue_empty
c_func
(paren
id|user
)paren
)paren
r_return
id|POLLIN
op_or
id|POLLRDNORM
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* ds_poll */
multiline_comment|/*====================================================================*/
r_extern
r_int
id|pcmcia_adjust_resource_info
c_func
(paren
id|adjust_t
op_star
id|adj
)paren
suffix:semicolon
r_extern
r_int
id|pccard_get_next_region
c_func
(paren
r_struct
id|pcmcia_socket
op_star
id|s
comma
id|region_info_t
op_star
id|rgn
)paren
suffix:semicolon
r_extern
r_int
id|pccard_get_first_region
c_func
(paren
r_struct
id|pcmcia_socket
op_star
id|s
comma
id|region_info_t
op_star
id|rgn
)paren
suffix:semicolon
DECL|function|ds_ioctl
r_static
r_int
id|ds_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
id|u_int
id|cmd
comma
id|u_long
id|arg
)paren
(brace
r_struct
id|pcmcia_bus_socket
op_star
id|s
suffix:semicolon
r_void
id|__user
op_star
id|uarg
op_assign
(paren
r_char
id|__user
op_star
)paren
id|arg
suffix:semicolon
id|u_int
id|size
suffix:semicolon
r_int
id|ret
comma
id|err
suffix:semicolon
id|ds_ioctl_arg_t
id|buf
suffix:semicolon
id|user_info_t
op_star
id|user
suffix:semicolon
id|ds_dbg
c_func
(paren
l_int|2
comma
l_string|&quot;ds_ioctl(socket %d, %#x, %#lx)&bslash;n&quot;
comma
id|iminor
c_func
(paren
id|inode
)paren
comma
id|cmd
comma
id|arg
)paren
suffix:semicolon
id|user
op_assign
id|file-&gt;private_data
suffix:semicolon
r_if
c_cond
(paren
id|CHECK_USER
c_func
(paren
id|user
)paren
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|s
op_assign
id|user-&gt;socket
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;state
op_amp
id|DS_SOCKET_DEAD
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|size
op_assign
(paren
id|cmd
op_amp
id|IOCSIZE_MASK
)paren
op_rshift
id|IOCSIZE_SHIFT
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
r_sizeof
(paren
id|ds_ioctl_arg_t
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* Permission check */
r_if
c_cond
(paren
op_logical_neg
(paren
id|cmd
op_amp
id|IOC_OUT
)paren
op_logical_and
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_ADMIN
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_amp
id|IOC_IN
)paren
(brace
id|err
op_assign
id|verify_area
c_func
(paren
id|VERIFY_READ
comma
id|uarg
comma
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|ds_dbg
c_func
(paren
l_int|3
comma
l_string|&quot;ds_ioctl(): verify_read = %d&bslash;n&quot;
comma
id|err
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|cmd
op_amp
id|IOC_OUT
)paren
(brace
id|err
op_assign
id|verify_area
c_func
(paren
id|VERIFY_WRITE
comma
id|uarg
comma
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|ds_dbg
c_func
(paren
l_int|3
comma
l_string|&quot;ds_ioctl(): verify_write = %d&bslash;n&quot;
comma
id|err
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
)brace
id|err
op_assign
id|ret
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_amp
id|IOC_IN
)paren
id|__copy_from_user
c_func
(paren
(paren
r_char
op_star
)paren
op_amp
id|buf
comma
id|uarg
comma
id|size
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|DS_ADJUST_RESOURCE_INFO
suffix:colon
id|ret
op_assign
id|pcmcia_adjust_resource_info
c_func
(paren
op_amp
id|buf.adjust
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DS_GET_CARD_SERVICES_INFO
suffix:colon
id|ret
op_assign
id|pcmcia_get_card_services_info
c_func
(paren
op_amp
id|buf.servinfo
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DS_GET_CONFIGURATION_INFO
suffix:colon
r_if
c_cond
(paren
id|buf.config.Function
op_logical_and
(paren
id|buf.config.Function
op_ge
id|s-&gt;parent-&gt;functions
)paren
)paren
id|ret
op_assign
id|CS_BAD_ARGS
suffix:semicolon
r_else
id|ret
op_assign
id|pccard_get_configuration_info
c_func
(paren
id|s-&gt;parent
comma
id|buf.config.Function
comma
op_amp
id|buf.config
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DS_GET_FIRST_TUPLE
suffix:colon
id|pcmcia_validate_mem
c_func
(paren
id|s-&gt;parent
)paren
suffix:semicolon
id|ret
op_assign
id|pccard_get_first_tuple
c_func
(paren
id|s-&gt;parent
comma
id|BIND_FN_ALL
comma
op_amp
id|buf.tuple
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DS_GET_NEXT_TUPLE
suffix:colon
id|ret
op_assign
id|pccard_get_next_tuple
c_func
(paren
id|s-&gt;parent
comma
id|BIND_FN_ALL
comma
op_amp
id|buf.tuple
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DS_GET_TUPLE_DATA
suffix:colon
id|buf.tuple.TupleData
op_assign
id|buf.tuple_parse.data
suffix:semicolon
id|buf.tuple.TupleDataMax
op_assign
r_sizeof
(paren
id|buf.tuple_parse.data
)paren
suffix:semicolon
id|ret
op_assign
id|pccard_get_tuple_data
c_func
(paren
id|s-&gt;parent
comma
op_amp
id|buf.tuple
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DS_PARSE_TUPLE
suffix:colon
id|buf.tuple.TupleData
op_assign
id|buf.tuple_parse.data
suffix:semicolon
id|ret
op_assign
id|pccard_parse_tuple
c_func
(paren
op_amp
id|buf.tuple
comma
op_amp
id|buf.tuple_parse.parse
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DS_RESET_CARD
suffix:colon
id|ret
op_assign
id|pccard_reset_card
c_func
(paren
id|s-&gt;parent
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DS_GET_STATUS
suffix:colon
r_if
c_cond
(paren
id|buf.status.Function
op_logical_and
(paren
id|buf.status.Function
op_ge
id|s-&gt;parent-&gt;functions
)paren
)paren
id|ret
op_assign
id|CS_BAD_ARGS
suffix:semicolon
r_else
id|ret
op_assign
id|pccard_get_status
c_func
(paren
id|s-&gt;parent
comma
id|buf.status.Function
comma
op_amp
id|buf.status
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DS_VALIDATE_CIS
suffix:colon
id|pcmcia_validate_mem
c_func
(paren
id|s-&gt;parent
)paren
suffix:semicolon
id|ret
op_assign
id|pccard_validate_cis
c_func
(paren
id|s-&gt;parent
comma
id|BIND_FN_ALL
comma
op_amp
id|buf.cisinfo
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DS_SUSPEND_CARD
suffix:colon
id|ret
op_assign
id|pcmcia_suspend_card
c_func
(paren
id|s-&gt;parent
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DS_RESUME_CARD
suffix:colon
id|ret
op_assign
id|pcmcia_resume_card
c_func
(paren
id|s-&gt;parent
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DS_EJECT_CARD
suffix:colon
id|err
op_assign
id|pcmcia_eject_card
c_func
(paren
id|s-&gt;parent
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DS_INSERT_CARD
suffix:colon
id|err
op_assign
id|pcmcia_insert_card
c_func
(paren
id|s-&gt;parent
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DS_ACCESS_CONFIGURATION_REGISTER
suffix:colon
r_if
c_cond
(paren
(paren
id|buf.conf_reg.Action
op_eq
id|CS_WRITE
)paren
op_logical_and
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_ADMIN
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
r_if
c_cond
(paren
id|buf.conf_reg.Function
op_logical_and
(paren
id|buf.conf_reg.Function
op_ge
id|s-&gt;parent-&gt;functions
)paren
)paren
id|ret
op_assign
id|CS_BAD_ARGS
suffix:semicolon
r_else
id|ret
op_assign
id|pccard_access_configuration_register
c_func
(paren
id|s-&gt;parent
comma
id|buf.conf_reg.Function
comma
op_amp
id|buf.conf_reg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DS_GET_FIRST_REGION
suffix:colon
id|ret
op_assign
id|pccard_get_first_region
c_func
(paren
id|s-&gt;parent
comma
op_amp
id|buf.region
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DS_GET_NEXT_REGION
suffix:colon
id|ret
op_assign
id|pccard_get_next_region
c_func
(paren
id|s-&gt;parent
comma
op_amp
id|buf.region
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DS_GET_FIRST_WINDOW
suffix:colon
id|ret
op_assign
id|pcmcia_get_window
c_func
(paren
id|s-&gt;parent
comma
op_amp
id|buf.win_info.handle
comma
l_int|0
comma
op_amp
id|buf.win_info.window
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DS_GET_NEXT_WINDOW
suffix:colon
id|ret
op_assign
id|pcmcia_get_window
c_func
(paren
id|s-&gt;parent
comma
op_amp
id|buf.win_info.handle
comma
id|buf.win_info.handle-&gt;index
op_plus
l_int|1
comma
op_amp
id|buf.win_info.window
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DS_GET_MEM_PAGE
suffix:colon
id|ret
op_assign
id|pcmcia_get_mem_page
c_func
(paren
id|buf.win_info.handle
comma
op_amp
id|buf.win_info.map
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DS_REPLACE_CIS
suffix:colon
id|ret
op_assign
id|pcmcia_replace_cis
c_func
(paren
id|s-&gt;parent
comma
op_amp
id|buf.cisdump
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DS_BIND_REQUEST
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_ADMIN
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
id|err
op_assign
id|bind_request
c_func
(paren
id|s
comma
op_amp
id|buf.bind_info
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DS_GET_DEVICE_INFO
suffix:colon
id|err
op_assign
id|get_device_info
c_func
(paren
id|s
comma
op_amp
id|buf.bind_info
comma
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DS_GET_NEXT_DEVICE
suffix:colon
id|err
op_assign
id|get_device_info
c_func
(paren
id|s
comma
op_amp
id|buf.bind_info
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DS_UNBIND_REQUEST
suffix:colon
id|err
op_assign
id|unbind_request
c_func
(paren
id|s
comma
op_amp
id|buf.bind_info
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DS_BIND_MTD
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_ADMIN
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
id|err
op_assign
id|bind_mtd
c_func
(paren
id|s
comma
op_amp
id|buf.mtd_info
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|err
op_eq
l_int|0
)paren
op_logical_and
(paren
id|ret
op_ne
id|CS_SUCCESS
)paren
)paren
(brace
id|ds_dbg
c_func
(paren
l_int|2
comma
l_string|&quot;ds_ioctl: ret = %d&bslash;n&quot;
comma
id|ret
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|ret
)paren
(brace
r_case
id|CS_BAD_SOCKET
suffix:colon
r_case
id|CS_NO_CARD
suffix:colon
id|err
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS_BAD_ARGS
suffix:colon
r_case
id|CS_BAD_ATTRIBUTE
suffix:colon
r_case
id|CS_BAD_IRQ
suffix:colon
r_case
id|CS_BAD_TUPLE
suffix:colon
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS_IN_USE
suffix:colon
id|err
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS_OUT_OF_RESOURCE
suffix:colon
id|err
op_assign
op_minus
id|ENOSPC
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS_NO_MORE_ITEMS
suffix:colon
id|err
op_assign
op_minus
id|ENODATA
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CS_UNSUPPORTED_FUNCTION
suffix:colon
id|err
op_assign
op_minus
id|ENOSYS
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|err
op_assign
op_minus
id|EIO
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|cmd
op_amp
id|IOC_OUT
)paren
(brace
r_if
c_cond
(paren
id|__copy_to_user
c_func
(paren
id|uarg
comma
(paren
r_char
op_star
)paren
op_amp
id|buf
comma
id|size
)paren
)paren
id|err
op_assign
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/* ds_ioctl */
multiline_comment|/*====================================================================*/
DECL|variable|ds_fops
r_static
r_struct
id|file_operations
id|ds_fops
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|open
op_assign
id|ds_open
comma
dot
id|release
op_assign
id|ds_release
comma
dot
id|ioctl
op_assign
id|ds_ioctl
comma
dot
id|read
op_assign
id|ds_read
comma
dot
id|write
op_assign
id|ds_write
comma
dot
id|poll
op_assign
id|ds_poll
comma
)brace
suffix:semicolon
DECL|function|pcmcia_bus_add_socket
r_static
r_int
id|__devinit
id|pcmcia_bus_add_socket
c_func
(paren
r_struct
id|class_device
op_star
id|class_dev
)paren
(brace
r_struct
id|pcmcia_socket
op_star
id|socket
op_assign
id|class_dev-&gt;class_data
suffix:semicolon
r_struct
id|pcmcia_bus_socket
op_star
id|s
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|s
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|pcmcia_bus_socket
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|s
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|s
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|pcmcia_bus_socket
)paren
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|s-&gt;refcount
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Ugly. But we want to wait for the socket threads to have started up.&n;&t; * We really should let the drivers themselves drive some of this..&n;&t; */
id|msleep
c_func
(paren
l_int|250
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|s-&gt;queue
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|s-&gt;request
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|s-&gt;devices_list
)paren
suffix:semicolon
multiline_comment|/* initialize data */
id|s-&gt;parent
op_assign
id|socket
suffix:semicolon
multiline_comment|/* Set up hotline to Card Services */
id|s-&gt;callback.owner
op_assign
id|THIS_MODULE
suffix:semicolon
id|s-&gt;callback.event
op_assign
op_amp
id|ds_event
suffix:semicolon
id|socket-&gt;pcmcia
op_assign
id|s
suffix:semicolon
id|ret
op_assign
id|pccard_register_pcmcia
c_func
(paren
id|socket
comma
op_amp
id|s-&gt;callback
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;PCMCIA registration PCCard core failed for socket %p&bslash;n&quot;
comma
id|socket
)paren
suffix:semicolon
id|pcmcia_put_bus_socket
c_func
(paren
id|s
)paren
suffix:semicolon
id|socket-&gt;pcmcia
op_assign
l_int|NULL
suffix:semicolon
r_return
(paren
id|ret
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pcmcia_bus_remove_socket
r_static
r_void
id|pcmcia_bus_remove_socket
c_func
(paren
r_struct
id|class_device
op_star
id|class_dev
)paren
(brace
r_struct
id|pcmcia_socket
op_star
id|socket
op_assign
id|class_dev-&gt;class_data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|socket
op_logical_or
op_logical_neg
id|socket-&gt;pcmcia
)paren
r_return
suffix:semicolon
id|pccard_register_pcmcia
c_func
(paren
id|socket
comma
l_int|NULL
)paren
suffix:semicolon
id|socket-&gt;pcmcia-&gt;state
op_or_assign
id|DS_SOCKET_DEAD
suffix:semicolon
id|pcmcia_put_bus_socket
c_func
(paren
id|socket-&gt;pcmcia
)paren
suffix:semicolon
id|socket-&gt;pcmcia
op_assign
l_int|NULL
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* the pcmcia_bus_interface is used to handle pcmcia socket devices */
DECL|variable|pcmcia_bus_interface
r_static
r_struct
id|class_interface
id|pcmcia_bus_interface
op_assign
(brace
dot
r_class
op_assign
op_amp
id|pcmcia_socket_class
comma
dot
id|add
op_assign
op_amp
id|pcmcia_bus_add_socket
comma
dot
id|remove
op_assign
op_amp
id|pcmcia_bus_remove_socket
comma
)brace
suffix:semicolon
DECL|variable|pcmcia_bus_type
r_struct
id|bus_type
id|pcmcia_bus_type
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;pcmcia&quot;
comma
)brace
suffix:semicolon
DECL|variable|pcmcia_bus_type
id|EXPORT_SYMBOL
c_func
(paren
id|pcmcia_bus_type
)paren
suffix:semicolon
DECL|function|init_pcmcia_bus
r_static
r_int
id|__init
id|init_pcmcia_bus
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|pcmcia_dev_list_lock
)paren
suffix:semicolon
id|bus_register
c_func
(paren
op_amp
id|pcmcia_bus_type
)paren
suffix:semicolon
id|class_interface_register
c_func
(paren
op_amp
id|pcmcia_bus_interface
)paren
suffix:semicolon
multiline_comment|/* Set up character device for user mode clients */
id|i
op_assign
id|register_chrdev
c_func
(paren
l_int|0
comma
l_string|&quot;pcmcia&quot;
comma
op_amp
id|ds_fops
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
op_minus
id|EBUSY
)paren
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;unable to find a free device # for &quot;
l_string|&quot;Driver Services&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|major_dev
op_assign
id|i
suffix:semicolon
macro_line|#ifdef CONFIG_PROC_FS
id|proc_pccard
op_assign
id|proc_mkdir
c_func
(paren
l_string|&quot;pccard&quot;
comma
id|proc_bus
)paren
suffix:semicolon
r_if
c_cond
(paren
id|proc_pccard
)paren
id|create_proc_read_entry
c_func
(paren
l_string|&quot;drivers&quot;
comma
l_int|0
comma
id|proc_pccard
comma
id|proc_read_drivers
comma
l_int|NULL
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|init_pcmcia_bus
id|fs_initcall
c_func
(paren
id|init_pcmcia_bus
)paren
suffix:semicolon
multiline_comment|/* one level after subsys_initcall so that &n;&t;&t;&t;       * pcmcia_socket_class is already registered */
DECL|function|exit_pcmcia_bus
r_static
r_void
id|__exit
id|exit_pcmcia_bus
c_func
(paren
r_void
)paren
(brace
id|class_interface_unregister
c_func
(paren
op_amp
id|pcmcia_bus_interface
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_PROC_FS
r_if
c_cond
(paren
id|proc_pccard
)paren
(brace
id|remove_proc_entry
c_func
(paren
l_string|&quot;drivers&quot;
comma
id|proc_pccard
)paren
suffix:semicolon
id|remove_proc_entry
c_func
(paren
l_string|&quot;pccard&quot;
comma
id|proc_bus
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|major_dev
op_ne
op_minus
l_int|1
)paren
id|unregister_chrdev
c_func
(paren
id|major_dev
comma
l_string|&quot;pcmcia&quot;
)paren
suffix:semicolon
id|bus_unregister
c_func
(paren
op_amp
id|pcmcia_bus_type
)paren
suffix:semicolon
)brace
DECL|variable|exit_pcmcia_bus
id|module_exit
c_func
(paren
id|exit_pcmcia_bus
)paren
suffix:semicolon
multiline_comment|/* helpers for backwards-compatible functions */
DECL|function|get_socket_info_by_nr
r_static
r_struct
id|pcmcia_bus_socket
op_star
id|get_socket_info_by_nr
c_func
(paren
r_int
r_int
id|nr
)paren
(brace
r_struct
id|pcmcia_socket
op_star
id|s
op_assign
id|pcmcia_get_socket_by_nr
c_func
(paren
id|nr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
op_logical_and
id|s-&gt;pcmcia
)paren
r_return
id|s-&gt;pcmcia
suffix:semicolon
r_else
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* backwards-compatible accessing of driver --- by name! */
DECL|struct|cmp_data
r_struct
id|cmp_data
(brace
DECL|member|dev_info
r_void
op_star
id|dev_info
suffix:semicolon
DECL|member|drv
r_struct
id|pcmcia_driver
op_star
id|drv
suffix:semicolon
)brace
suffix:semicolon
DECL|function|cmp_drv_callback
r_static
r_int
id|cmp_drv_callback
c_func
(paren
r_struct
id|device_driver
op_star
id|drv
comma
r_void
op_star
id|data
)paren
(brace
r_struct
id|cmp_data
op_star
id|cmp
op_assign
id|data
suffix:semicolon
r_if
c_cond
(paren
id|strncmp
c_func
(paren
(paren
r_char
op_star
)paren
id|cmp-&gt;dev_info
comma
(paren
r_char
op_star
)paren
id|drv-&gt;name
comma
id|DEV_NAME_LEN
)paren
op_eq
l_int|0
)paren
(brace
id|cmp-&gt;drv
op_assign
id|container_of
c_func
(paren
id|drv
comma
r_struct
id|pcmcia_driver
comma
id|drv
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|get_pcmcia_driver
r_static
r_struct
id|pcmcia_driver
op_star
id|get_pcmcia_driver
(paren
id|dev_info_t
op_star
id|dev_info
)paren
(brace
r_int
id|ret
suffix:semicolon
r_struct
id|cmp_data
id|cmp
op_assign
(brace
dot
id|dev_info
op_assign
id|dev_info
comma
)brace
suffix:semicolon
id|ret
op_assign
id|bus_for_each_drv
c_func
(paren
op_amp
id|pcmcia_bus_type
comma
l_int|NULL
comma
op_amp
id|cmp
comma
id|cmp_drv_callback
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_return
id|cmp.drv
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|MODULE_ALIAS
c_func
(paren
l_string|&quot;ds&quot;
)paren
suffix:semicolon
eof
