macro_line|#include &lt;linux/stop_machine.h&gt;
macro_line|#include &lt;linux/kthread.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/cpu.h&gt;
macro_line|#include &lt;linux/err.h&gt;
macro_line|#include &lt;linux/syscalls.h&gt;
macro_line|#include &lt;asm/atomic.h&gt;
macro_line|#include &lt;asm/semaphore.h&gt;
multiline_comment|/* Since we effect priority and affinity (both of which are visible&n; * to, and settable by outside processes) we do indirection via a&n; * kthread. */
multiline_comment|/* Thread to stop each CPU in user context. */
DECL|enum|stopmachine_state
r_enum
id|stopmachine_state
(brace
DECL|enumerator|STOPMACHINE_WAIT
id|STOPMACHINE_WAIT
comma
DECL|enumerator|STOPMACHINE_PREPARE
id|STOPMACHINE_PREPARE
comma
DECL|enumerator|STOPMACHINE_DISABLE_IRQ
id|STOPMACHINE_DISABLE_IRQ
comma
DECL|enumerator|STOPMACHINE_EXIT
id|STOPMACHINE_EXIT
comma
)brace
suffix:semicolon
DECL|variable|stopmachine_state
r_static
r_enum
id|stopmachine_state
id|stopmachine_state
suffix:semicolon
DECL|variable|stopmachine_num_threads
r_static
r_int
r_int
id|stopmachine_num_threads
suffix:semicolon
DECL|variable|stopmachine_thread_ack
r_static
id|atomic_t
id|stopmachine_thread_ack
suffix:semicolon
r_static
id|DECLARE_MUTEX
c_func
(paren
id|stopmachine_mutex
)paren
suffix:semicolon
DECL|function|stopmachine
r_static
r_int
id|stopmachine
c_func
(paren
r_void
op_star
id|cpu
)paren
(brace
r_int
id|irqs_disabled
op_assign
l_int|0
suffix:semicolon
r_int
id|prepared
op_assign
l_int|0
suffix:semicolon
id|set_cpus_allowed
c_func
(paren
id|current
comma
id|cpumask_of_cpu
c_func
(paren
(paren
r_int
)paren
(paren
r_int
)paren
id|cpu
)paren
)paren
suffix:semicolon
multiline_comment|/* Ack: we are alive */
id|mb
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Theoretically the ack = 0 might not be on this CPU yet. */
id|atomic_inc
c_func
(paren
op_amp
id|stopmachine_thread_ack
)paren
suffix:semicolon
multiline_comment|/* Simple state machine */
r_while
c_loop
(paren
id|stopmachine_state
op_ne
id|STOPMACHINE_EXIT
)paren
(brace
r_if
c_cond
(paren
id|stopmachine_state
op_eq
id|STOPMACHINE_DISABLE_IRQ
op_logical_and
op_logical_neg
id|irqs_disabled
)paren
(brace
id|local_irq_disable
c_func
(paren
)paren
suffix:semicolon
id|irqs_disabled
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Ack: irqs disabled. */
id|mb
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Must read state first. */
id|atomic_inc
c_func
(paren
op_amp
id|stopmachine_thread_ack
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|stopmachine_state
op_eq
id|STOPMACHINE_PREPARE
op_logical_and
op_logical_neg
id|prepared
)paren
(brace
multiline_comment|/* Everyone is in place, hold CPU. */
id|preempt_disable
c_func
(paren
)paren
suffix:semicolon
id|prepared
op_assign
l_int|1
suffix:semicolon
id|mb
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Must read state first. */
id|atomic_inc
c_func
(paren
op_amp
id|stopmachine_thread_ack
)paren
suffix:semicolon
)brace
multiline_comment|/* Yield in first stage: migration threads need to&n;&t;&t; * help our sisters onto their CPUs. */
r_if
c_cond
(paren
op_logical_neg
id|prepared
op_logical_and
op_logical_neg
id|irqs_disabled
)paren
id|yield
c_func
(paren
)paren
suffix:semicolon
r_else
id|cpu_relax
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Ack: we are exiting. */
id|mb
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Must read state first. */
id|atomic_inc
c_func
(paren
op_amp
id|stopmachine_thread_ack
)paren
suffix:semicolon
r_if
c_cond
(paren
id|irqs_disabled
)paren
id|local_irq_enable
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|prepared
)paren
id|preempt_enable
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Change the thread state */
DECL|function|stopmachine_set_state
r_static
r_void
id|stopmachine_set_state
c_func
(paren
r_enum
id|stopmachine_state
id|state
)paren
(brace
id|atomic_set
c_func
(paren
op_amp
id|stopmachine_thread_ack
comma
l_int|0
)paren
suffix:semicolon
id|wmb
c_func
(paren
)paren
suffix:semicolon
id|stopmachine_state
op_assign
id|state
suffix:semicolon
r_while
c_loop
(paren
id|atomic_read
c_func
(paren
op_amp
id|stopmachine_thread_ack
)paren
op_ne
id|stopmachine_num_threads
)paren
id|cpu_relax
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|stop_machine
r_static
r_int
id|stop_machine
c_func
(paren
r_void
)paren
(brace
r_int
id|i
comma
id|ret
op_assign
l_int|0
suffix:semicolon
r_struct
id|sched_param
id|param
op_assign
(brace
dot
id|sched_priority
op_assign
id|MAX_RT_PRIO
op_minus
l_int|1
)brace
suffix:semicolon
multiline_comment|/* One high-prio thread per cpu.  We&squot;ll do this one. */
id|sys_sched_setscheduler
c_func
(paren
id|current-&gt;pid
comma
id|SCHED_FIFO
comma
op_amp
id|param
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|stopmachine_thread_ack
comma
l_int|0
)paren
suffix:semicolon
id|stopmachine_num_threads
op_assign
l_int|0
suffix:semicolon
id|stopmachine_state
op_assign
id|STOPMACHINE_WAIT
suffix:semicolon
id|for_each_online_cpu
c_func
(paren
id|i
)paren
(brace
r_if
c_cond
(paren
id|i
op_eq
id|smp_processor_id
c_func
(paren
)paren
)paren
r_continue
suffix:semicolon
id|ret
op_assign
id|kernel_thread
c_func
(paren
id|stopmachine
comma
(paren
r_void
op_star
)paren
(paren
r_int
)paren
id|i
comma
id|CLONE_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
r_break
suffix:semicolon
id|stopmachine_num_threads
op_increment
suffix:semicolon
)brace
multiline_comment|/* Wait for them all to come to life. */
r_while
c_loop
(paren
id|atomic_read
c_func
(paren
op_amp
id|stopmachine_thread_ack
)paren
op_ne
id|stopmachine_num_threads
)paren
id|yield
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* If some failed, kill them all. */
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
id|stopmachine_set_state
c_func
(paren
id|STOPMACHINE_EXIT
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|stopmachine_mutex
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* Don&squot;t schedule us away at this point, please. */
id|local_irq_disable
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Now they are all started, make them hold the CPUs, ready. */
id|stopmachine_set_state
c_func
(paren
id|STOPMACHINE_PREPARE
)paren
suffix:semicolon
multiline_comment|/* Make them disable irqs. */
id|stopmachine_set_state
c_func
(paren
id|STOPMACHINE_DISABLE_IRQ
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|restart_machine
r_static
r_void
id|restart_machine
c_func
(paren
r_void
)paren
(brace
id|stopmachine_set_state
c_func
(paren
id|STOPMACHINE_EXIT
)paren
suffix:semicolon
id|local_irq_enable
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|struct|stop_machine_data
r_struct
id|stop_machine_data
(brace
DECL|member|fn
r_int
(paren
op_star
id|fn
)paren
(paren
r_void
op_star
)paren
suffix:semicolon
DECL|member|data
r_void
op_star
id|data
suffix:semicolon
DECL|member|done
r_struct
id|completion
id|done
suffix:semicolon
)brace
suffix:semicolon
DECL|function|do_stop
r_static
r_int
id|do_stop
c_func
(paren
r_void
op_star
id|_smdata
)paren
(brace
r_struct
id|stop_machine_data
op_star
id|smdata
op_assign
id|_smdata
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|ret
op_assign
id|stop_machine
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
l_int|0
)paren
(brace
id|ret
op_assign
id|smdata
op_member_access_from_pointer
id|fn
c_func
(paren
id|smdata-&gt;data
)paren
suffix:semicolon
id|restart_machine
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* We&squot;re done: you can kthread_stop us now */
id|complete
c_func
(paren
op_amp
id|smdata-&gt;done
)paren
suffix:semicolon
multiline_comment|/* Wait for kthread_stop */
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|kthread_should_stop
c_func
(paren
)paren
)paren
(brace
id|schedule
c_func
(paren
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
)brace
id|__set_current_state
c_func
(paren
id|TASK_RUNNING
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|__stop_machine_run
r_struct
id|task_struct
op_star
id|__stop_machine_run
c_func
(paren
r_int
(paren
op_star
id|fn
)paren
(paren
r_void
op_star
)paren
comma
r_void
op_star
id|data
comma
r_int
r_int
id|cpu
)paren
(brace
r_struct
id|stop_machine_data
id|smdata
suffix:semicolon
r_struct
id|task_struct
op_star
id|p
suffix:semicolon
id|smdata.fn
op_assign
id|fn
suffix:semicolon
id|smdata.data
op_assign
id|data
suffix:semicolon
id|init_completion
c_func
(paren
op_amp
id|smdata.done
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|stopmachine_mutex
)paren
suffix:semicolon
multiline_comment|/* If they don&squot;t care which CPU fn runs on, bind to any online one. */
r_if
c_cond
(paren
id|cpu
op_eq
id|NR_CPUS
)paren
id|cpu
op_assign
id|smp_processor_id
c_func
(paren
)paren
suffix:semicolon
id|p
op_assign
id|kthread_create
c_func
(paren
id|do_stop
comma
op_amp
id|smdata
comma
l_string|&quot;kstopmachine&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|IS_ERR
c_func
(paren
id|p
)paren
)paren
(brace
id|kthread_bind
c_func
(paren
id|p
comma
id|cpu
)paren
suffix:semicolon
id|wake_up_process
c_func
(paren
id|p
)paren
suffix:semicolon
id|wait_for_completion
c_func
(paren
op_amp
id|smdata.done
)paren
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|stopmachine_mutex
)paren
suffix:semicolon
r_return
id|p
suffix:semicolon
)brace
DECL|function|stop_machine_run
r_int
id|stop_machine_run
c_func
(paren
r_int
(paren
op_star
id|fn
)paren
(paren
r_void
op_star
)paren
comma
r_void
op_star
id|data
comma
r_int
r_int
id|cpu
)paren
(brace
r_struct
id|task_struct
op_star
id|p
suffix:semicolon
r_int
id|ret
suffix:semicolon
multiline_comment|/* No CPUs can come up or down during this. */
id|lock_cpu_hotplug
c_func
(paren
)paren
suffix:semicolon
id|p
op_assign
id|__stop_machine_run
c_func
(paren
id|fn
comma
id|data
comma
id|cpu
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|IS_ERR
c_func
(paren
id|p
)paren
)paren
id|ret
op_assign
id|kthread_stop
c_func
(paren
id|p
)paren
suffix:semicolon
r_else
id|ret
op_assign
id|PTR_ERR
c_func
(paren
id|p
)paren
suffix:semicolon
id|unlock_cpu_hotplug
c_func
(paren
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
eof
