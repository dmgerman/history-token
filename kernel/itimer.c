multiline_comment|/*&n; * linux/kernel/itimer.c&n; *&n; * Copyright (C) 1992 Darren Senn&n; */
multiline_comment|/* These are all the functions necessary to implement itimers */
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/syscalls.h&gt;
macro_line|#include &lt;linux/time.h&gt;
macro_line|#include &lt;linux/posix-timers.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
DECL|function|it_real_value
r_static
r_int
r_int
id|it_real_value
c_func
(paren
r_struct
id|signal_struct
op_star
id|sig
)paren
(brace
r_int
r_int
id|val
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|timer_pending
c_func
(paren
op_amp
id|sig-&gt;real_timer
)paren
)paren
(brace
id|val
op_assign
id|sig-&gt;real_timer.expires
op_minus
id|jiffies
suffix:semicolon
multiline_comment|/* look out for negative/zero itimer.. */
r_if
c_cond
(paren
(paren
r_int
)paren
id|val
op_le
l_int|0
)paren
id|val
op_assign
l_int|1
suffix:semicolon
)brace
r_return
id|val
suffix:semicolon
)brace
DECL|function|do_getitimer
r_int
id|do_getitimer
c_func
(paren
r_int
id|which
comma
r_struct
id|itimerval
op_star
id|value
)paren
(brace
r_struct
id|task_struct
op_star
id|tsk
op_assign
id|current
suffix:semicolon
r_int
r_int
id|interval
comma
id|val
suffix:semicolon
id|cputime_t
id|cinterval
comma
id|cval
suffix:semicolon
r_switch
c_cond
(paren
id|which
)paren
(brace
r_case
id|ITIMER_REAL
suffix:colon
id|spin_lock_irq
c_func
(paren
op_amp
id|tsk-&gt;sighand-&gt;siglock
)paren
suffix:semicolon
id|interval
op_assign
id|tsk-&gt;signal-&gt;it_real_incr
suffix:semicolon
id|val
op_assign
id|it_real_value
c_func
(paren
id|tsk-&gt;signal
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|tsk-&gt;sighand-&gt;siglock
)paren
suffix:semicolon
id|jiffies_to_timeval
c_func
(paren
id|val
comma
op_amp
id|value-&gt;it_value
)paren
suffix:semicolon
id|jiffies_to_timeval
c_func
(paren
id|interval
comma
op_amp
id|value-&gt;it_interval
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ITIMER_VIRTUAL
suffix:colon
id|read_lock
c_func
(paren
op_amp
id|tasklist_lock
)paren
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|tsk-&gt;sighand-&gt;siglock
)paren
suffix:semicolon
id|cval
op_assign
id|tsk-&gt;signal-&gt;it_virt_expires
suffix:semicolon
id|cinterval
op_assign
id|tsk-&gt;signal-&gt;it_virt_incr
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cputime_eq
c_func
(paren
id|cval
comma
id|cputime_zero
)paren
)paren
(brace
r_struct
id|task_struct
op_star
id|t
op_assign
id|tsk
suffix:semicolon
id|cputime_t
id|utime
op_assign
id|tsk-&gt;signal-&gt;utime
suffix:semicolon
r_do
(brace
id|utime
op_assign
id|cputime_add
c_func
(paren
id|utime
comma
id|t-&gt;utime
)paren
suffix:semicolon
id|t
op_assign
id|next_thread
c_func
(paren
id|t
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|t
op_ne
id|tsk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cputime_le
c_func
(paren
id|cval
comma
id|utime
)paren
)paren
(brace
multiline_comment|/* about to fire */
id|cval
op_assign
id|jiffies_to_cputime
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_else
(brace
id|cval
op_assign
id|cputime_sub
c_func
(paren
id|cval
comma
id|utime
)paren
suffix:semicolon
)brace
)brace
id|spin_unlock_irq
c_func
(paren
op_amp
id|tsk-&gt;sighand-&gt;siglock
)paren
suffix:semicolon
id|read_unlock
c_func
(paren
op_amp
id|tasklist_lock
)paren
suffix:semicolon
id|cputime_to_timeval
c_func
(paren
id|cval
comma
op_amp
id|value-&gt;it_value
)paren
suffix:semicolon
id|cputime_to_timeval
c_func
(paren
id|cinterval
comma
op_amp
id|value-&gt;it_interval
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ITIMER_PROF
suffix:colon
id|read_lock
c_func
(paren
op_amp
id|tasklist_lock
)paren
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|tsk-&gt;sighand-&gt;siglock
)paren
suffix:semicolon
id|cval
op_assign
id|tsk-&gt;signal-&gt;it_prof_expires
suffix:semicolon
id|cinterval
op_assign
id|tsk-&gt;signal-&gt;it_prof_incr
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cputime_eq
c_func
(paren
id|cval
comma
id|cputime_zero
)paren
)paren
(brace
r_struct
id|task_struct
op_star
id|t
op_assign
id|tsk
suffix:semicolon
id|cputime_t
id|ptime
op_assign
id|cputime_add
c_func
(paren
id|tsk-&gt;signal-&gt;utime
comma
id|tsk-&gt;signal-&gt;stime
)paren
suffix:semicolon
r_do
(brace
id|ptime
op_assign
id|cputime_add
c_func
(paren
id|ptime
comma
id|cputime_add
c_func
(paren
id|t-&gt;utime
comma
id|t-&gt;stime
)paren
)paren
suffix:semicolon
id|t
op_assign
id|next_thread
c_func
(paren
id|t
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|t
op_ne
id|tsk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cputime_le
c_func
(paren
id|cval
comma
id|ptime
)paren
)paren
(brace
multiline_comment|/* about to fire */
id|cval
op_assign
id|jiffies_to_cputime
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
r_else
(brace
id|cval
op_assign
id|cputime_sub
c_func
(paren
id|cval
comma
id|ptime
)paren
suffix:semicolon
)brace
)brace
id|spin_unlock_irq
c_func
(paren
op_amp
id|tsk-&gt;sighand-&gt;siglock
)paren
suffix:semicolon
id|read_unlock
c_func
(paren
op_amp
id|tasklist_lock
)paren
suffix:semicolon
id|cputime_to_timeval
c_func
(paren
id|cval
comma
op_amp
id|value-&gt;it_value
)paren
suffix:semicolon
id|cputime_to_timeval
c_func
(paren
id|cinterval
comma
op_amp
id|value-&gt;it_interval
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sys_getitimer
id|asmlinkage
r_int
id|sys_getitimer
c_func
(paren
r_int
id|which
comma
r_struct
id|itimerval
id|__user
op_star
id|value
)paren
(brace
r_int
id|error
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_struct
id|itimerval
id|get_buffer
suffix:semicolon
r_if
c_cond
(paren
id|value
)paren
(brace
id|error
op_assign
id|do_getitimer
c_func
(paren
id|which
comma
op_amp
id|get_buffer
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|error
op_logical_and
id|copy_to_user
c_func
(paren
id|value
comma
op_amp
id|get_buffer
comma
r_sizeof
(paren
id|get_buffer
)paren
)paren
)paren
id|error
op_assign
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
id|error
suffix:semicolon
)brace
multiline_comment|/*&n; * Called with P-&gt;sighand-&gt;siglock held and P-&gt;signal-&gt;real_timer inactive.&n; * If interval is nonzero, arm the timer for interval ticks from now.&n; */
DECL|function|it_real_arm
r_static
r_inline
r_void
id|it_real_arm
c_func
(paren
r_struct
id|task_struct
op_star
id|p
comma
r_int
r_int
id|interval
)paren
(brace
id|p-&gt;signal-&gt;it_real_value
op_assign
id|interval
suffix:semicolon
multiline_comment|/* XXX unnecessary field?? */
r_if
c_cond
(paren
id|interval
op_eq
l_int|0
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|interval
OG
(paren
r_int
r_int
)paren
id|LONG_MAX
)paren
id|interval
op_assign
id|LONG_MAX
suffix:semicolon
id|p-&gt;signal-&gt;real_timer.expires
op_assign
id|jiffies
op_plus
id|interval
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|p-&gt;signal-&gt;real_timer
)paren
suffix:semicolon
)brace
DECL|function|it_real_fn
r_void
id|it_real_fn
c_func
(paren
r_int
r_int
id|__data
)paren
(brace
r_struct
id|task_struct
op_star
id|p
op_assign
(paren
r_struct
id|task_struct
op_star
)paren
id|__data
suffix:semicolon
id|send_group_sig_info
c_func
(paren
id|SIGALRM
comma
id|SEND_SIG_PRIV
comma
id|p
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Now restart the timer if necessary.  We don&squot;t need any locking&n;&t; * here because do_setitimer makes sure we have finished running&n;&t; * before it touches anything.&n;&t; */
id|it_real_arm
c_func
(paren
id|p
comma
id|p-&gt;signal-&gt;it_real_incr
)paren
suffix:semicolon
)brace
DECL|function|do_setitimer
r_int
id|do_setitimer
c_func
(paren
r_int
id|which
comma
r_struct
id|itimerval
op_star
id|value
comma
r_struct
id|itimerval
op_star
id|ovalue
)paren
(brace
r_struct
id|task_struct
op_star
id|tsk
op_assign
id|current
suffix:semicolon
r_int
r_int
id|val
comma
id|interval
suffix:semicolon
id|cputime_t
id|cval
comma
id|cinterval
comma
id|nval
comma
id|ninterval
suffix:semicolon
r_switch
c_cond
(paren
id|which
)paren
(brace
r_case
id|ITIMER_REAL
suffix:colon
id|spin_lock_irq
c_func
(paren
op_amp
id|tsk-&gt;sighand-&gt;siglock
)paren
suffix:semicolon
id|interval
op_assign
id|tsk-&gt;signal-&gt;it_real_incr
suffix:semicolon
id|val
op_assign
id|it_real_value
c_func
(paren
id|tsk-&gt;signal
)paren
suffix:semicolon
r_if
c_cond
(paren
id|val
)paren
id|del_timer_sync
c_func
(paren
op_amp
id|tsk-&gt;signal-&gt;real_timer
)paren
suffix:semicolon
id|tsk-&gt;signal-&gt;it_real_incr
op_assign
id|timeval_to_jiffies
c_func
(paren
op_amp
id|value-&gt;it_interval
)paren
suffix:semicolon
id|it_real_arm
c_func
(paren
id|tsk
comma
id|timeval_to_jiffies
c_func
(paren
op_amp
id|value-&gt;it_value
)paren
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|tsk-&gt;sighand-&gt;siglock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ovalue
)paren
(brace
id|jiffies_to_timeval
c_func
(paren
id|val
comma
op_amp
id|ovalue-&gt;it_value
)paren
suffix:semicolon
id|jiffies_to_timeval
c_func
(paren
id|interval
comma
op_amp
id|ovalue-&gt;it_interval
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ITIMER_VIRTUAL
suffix:colon
id|nval
op_assign
id|timeval_to_cputime
c_func
(paren
op_amp
id|value-&gt;it_value
)paren
suffix:semicolon
id|ninterval
op_assign
id|timeval_to_cputime
c_func
(paren
op_amp
id|value-&gt;it_interval
)paren
suffix:semicolon
id|read_lock
c_func
(paren
op_amp
id|tasklist_lock
)paren
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|tsk-&gt;sighand-&gt;siglock
)paren
suffix:semicolon
id|cval
op_assign
id|tsk-&gt;signal-&gt;it_virt_expires
suffix:semicolon
id|cinterval
op_assign
id|tsk-&gt;signal-&gt;it_virt_incr
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cputime_eq
c_func
(paren
id|cval
comma
id|cputime_zero
)paren
op_logical_or
op_logical_neg
id|cputime_eq
c_func
(paren
id|nval
comma
id|cputime_zero
)paren
)paren
(brace
r_if
c_cond
(paren
id|cputime_gt
c_func
(paren
id|nval
comma
id|cputime_zero
)paren
)paren
id|nval
op_assign
id|cputime_add
c_func
(paren
id|nval
comma
id|jiffies_to_cputime
c_func
(paren
l_int|1
)paren
)paren
suffix:semicolon
id|set_process_cpu_timer
c_func
(paren
id|tsk
comma
id|CPUCLOCK_VIRT
comma
op_amp
id|nval
comma
op_amp
id|cval
)paren
suffix:semicolon
)brace
id|tsk-&gt;signal-&gt;it_virt_expires
op_assign
id|nval
suffix:semicolon
id|tsk-&gt;signal-&gt;it_virt_incr
op_assign
id|ninterval
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|tsk-&gt;sighand-&gt;siglock
)paren
suffix:semicolon
id|read_unlock
c_func
(paren
op_amp
id|tasklist_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ovalue
)paren
(brace
id|cputime_to_timeval
c_func
(paren
id|cval
comma
op_amp
id|ovalue-&gt;it_value
)paren
suffix:semicolon
id|cputime_to_timeval
c_func
(paren
id|cinterval
comma
op_amp
id|ovalue-&gt;it_interval
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ITIMER_PROF
suffix:colon
id|nval
op_assign
id|timeval_to_cputime
c_func
(paren
op_amp
id|value-&gt;it_value
)paren
suffix:semicolon
id|ninterval
op_assign
id|timeval_to_cputime
c_func
(paren
op_amp
id|value-&gt;it_interval
)paren
suffix:semicolon
id|read_lock
c_func
(paren
op_amp
id|tasklist_lock
)paren
suffix:semicolon
id|spin_lock_irq
c_func
(paren
op_amp
id|tsk-&gt;sighand-&gt;siglock
)paren
suffix:semicolon
id|cval
op_assign
id|tsk-&gt;signal-&gt;it_prof_expires
suffix:semicolon
id|cinterval
op_assign
id|tsk-&gt;signal-&gt;it_prof_incr
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cputime_eq
c_func
(paren
id|cval
comma
id|cputime_zero
)paren
op_logical_or
op_logical_neg
id|cputime_eq
c_func
(paren
id|nval
comma
id|cputime_zero
)paren
)paren
(brace
r_if
c_cond
(paren
id|cputime_gt
c_func
(paren
id|nval
comma
id|cputime_zero
)paren
)paren
id|nval
op_assign
id|cputime_add
c_func
(paren
id|nval
comma
id|jiffies_to_cputime
c_func
(paren
l_int|1
)paren
)paren
suffix:semicolon
id|set_process_cpu_timer
c_func
(paren
id|tsk
comma
id|CPUCLOCK_PROF
comma
op_amp
id|nval
comma
op_amp
id|cval
)paren
suffix:semicolon
)brace
id|tsk-&gt;signal-&gt;it_prof_expires
op_assign
id|nval
suffix:semicolon
id|tsk-&gt;signal-&gt;it_prof_incr
op_assign
id|ninterval
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|tsk-&gt;sighand-&gt;siglock
)paren
suffix:semicolon
id|read_unlock
c_func
(paren
op_amp
id|tasklist_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ovalue
)paren
(brace
id|cputime_to_timeval
c_func
(paren
id|cval
comma
op_amp
id|ovalue-&gt;it_value
)paren
suffix:semicolon
id|cputime_to_timeval
c_func
(paren
id|cinterval
comma
op_amp
id|ovalue-&gt;it_interval
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|sys_setitimer
id|asmlinkage
r_int
id|sys_setitimer
c_func
(paren
r_int
id|which
comma
r_struct
id|itimerval
id|__user
op_star
id|value
comma
r_struct
id|itimerval
id|__user
op_star
id|ovalue
)paren
(brace
r_struct
id|itimerval
id|set_buffer
comma
id|get_buffer
suffix:semicolon
r_int
id|error
suffix:semicolon
r_if
c_cond
(paren
id|value
)paren
(brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|set_buffer
comma
id|value
comma
r_sizeof
(paren
id|set_buffer
)paren
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
)brace
r_else
id|memset
c_func
(paren
(paren
r_char
op_star
)paren
op_amp
id|set_buffer
comma
l_int|0
comma
r_sizeof
(paren
id|set_buffer
)paren
)paren
suffix:semicolon
id|error
op_assign
id|do_setitimer
c_func
(paren
id|which
comma
op_amp
id|set_buffer
comma
id|ovalue
ques
c_cond
op_amp
id|get_buffer
suffix:colon
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
op_logical_or
op_logical_neg
id|ovalue
)paren
r_return
id|error
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|ovalue
comma
op_amp
id|get_buffer
comma
r_sizeof
(paren
id|get_buffer
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
eof
