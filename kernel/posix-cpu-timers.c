multiline_comment|/*&n; * Implement CPU time clocks for the POSIX clock interface.&n; */
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/posix-timers.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
DECL|union|cpu_time_count
r_union
id|cpu_time_count
(brace
DECL|member|cpu
id|cputime_t
id|cpu
suffix:semicolon
DECL|member|sched
r_int
r_int
r_int
id|sched
suffix:semicolon
)brace
suffix:semicolon
DECL|function|check_clock
r_static
r_int
id|check_clock
c_func
(paren
id|clockid_t
id|which_clock
)paren
(brace
r_int
id|error
op_assign
l_int|0
suffix:semicolon
r_struct
id|task_struct
op_star
id|p
suffix:semicolon
r_const
id|pid_t
id|pid
op_assign
id|CPUCLOCK_PID
c_func
(paren
id|which_clock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|CPUCLOCK_WHICH
c_func
(paren
id|which_clock
)paren
op_ge
id|CPUCLOCK_MAX
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|pid
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
id|read_lock
c_func
(paren
op_amp
id|tasklist_lock
)paren
suffix:semicolon
id|p
op_assign
id|find_task_by_pid
c_func
(paren
id|pid
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|p
op_logical_or
(paren
id|CPUCLOCK_PERTHREAD
c_func
(paren
id|which_clock
)paren
ques
c_cond
id|p-&gt;tgid
op_ne
id|current-&gt;tgid
suffix:colon
id|p-&gt;tgid
op_ne
id|pid
)paren
)paren
(brace
id|error
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
id|read_unlock
c_func
(paren
op_amp
id|tasklist_lock
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|function|sample_to_timespec
r_static
r_void
id|sample_to_timespec
c_func
(paren
id|clockid_t
id|which_clock
comma
r_union
id|cpu_time_count
id|cpu
comma
r_struct
id|timespec
op_star
id|tp
)paren
(brace
r_if
c_cond
(paren
id|CPUCLOCK_WHICH
c_func
(paren
id|which_clock
)paren
op_eq
id|CPUCLOCK_SCHED
)paren
(brace
id|tp-&gt;tv_sec
op_assign
id|div_long_long_rem
c_func
(paren
id|cpu.sched
comma
id|NSEC_PER_SEC
comma
op_amp
id|tp-&gt;tv_nsec
)paren
suffix:semicolon
)brace
r_else
(brace
id|cputime_to_timespec
c_func
(paren
id|cpu.cpu
comma
id|tp
)paren
suffix:semicolon
)brace
)brace
DECL|function|prof_ticks
r_static
r_inline
id|cputime_t
id|prof_ticks
c_func
(paren
r_struct
id|task_struct
op_star
id|p
)paren
(brace
r_return
id|cputime_add
c_func
(paren
id|p-&gt;utime
comma
id|p-&gt;stime
)paren
suffix:semicolon
)brace
DECL|function|virt_ticks
r_static
r_inline
id|cputime_t
id|virt_ticks
c_func
(paren
r_struct
id|task_struct
op_star
id|p
)paren
(brace
r_return
id|p-&gt;utime
suffix:semicolon
)brace
DECL|function|sched_ns
r_static
r_inline
r_int
r_int
r_int
id|sched_ns
c_func
(paren
r_struct
id|task_struct
op_star
id|p
)paren
(brace
r_return
(paren
id|p
op_eq
id|current
)paren
ques
c_cond
id|current_sched_time
c_func
(paren
id|p
)paren
suffix:colon
id|p-&gt;sched_time
suffix:semicolon
)brace
DECL|function|posix_cpu_clock_getres
r_int
id|posix_cpu_clock_getres
c_func
(paren
id|clockid_t
id|which_clock
comma
r_struct
id|timespec
op_star
id|tp
)paren
(brace
r_int
id|error
op_assign
id|check_clock
c_func
(paren
id|which_clock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|error
)paren
(brace
id|tp-&gt;tv_sec
op_assign
l_int|0
suffix:semicolon
id|tp-&gt;tv_nsec
op_assign
(paren
(paren
id|NSEC_PER_SEC
op_plus
id|HZ
op_minus
l_int|1
)paren
op_div
id|HZ
)paren
suffix:semicolon
r_if
c_cond
(paren
id|CPUCLOCK_WHICH
c_func
(paren
id|which_clock
)paren
op_eq
id|CPUCLOCK_SCHED
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * If sched_clock is using a cycle counter, we&n;&t;&t;&t; * don&squot;t have any idea of its true resolution&n;&t;&t;&t; * exported, but it is much more than 1s/HZ.&n;&t;&t;&t; */
id|tp-&gt;tv_nsec
op_assign
l_int|1
suffix:semicolon
)brace
)brace
r_return
id|error
suffix:semicolon
)brace
DECL|function|posix_cpu_clock_set
r_int
id|posix_cpu_clock_set
c_func
(paren
id|clockid_t
id|which_clock
comma
r_const
r_struct
id|timespec
op_star
id|tp
)paren
(brace
multiline_comment|/*&n;&t; * You can never reset a CPU clock, but we check for other errors&n;&t; * in the call before failing with EPERM.&n;&t; */
r_int
id|error
op_assign
id|check_clock
c_func
(paren
id|which_clock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
op_eq
l_int|0
)paren
(brace
id|error
op_assign
op_minus
id|EPERM
suffix:semicolon
)brace
r_return
id|error
suffix:semicolon
)brace
multiline_comment|/*&n; * Sample a per-thread clock for the given task.&n; */
DECL|function|cpu_clock_sample
r_static
r_int
id|cpu_clock_sample
c_func
(paren
id|clockid_t
id|which_clock
comma
r_struct
id|task_struct
op_star
id|p
comma
r_union
id|cpu_time_count
op_star
id|cpu
)paren
(brace
r_switch
c_cond
(paren
id|CPUCLOCK_WHICH
c_func
(paren
id|which_clock
)paren
)paren
(brace
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
r_case
id|CPUCLOCK_PROF
suffix:colon
id|cpu-&gt;cpu
op_assign
id|prof_ticks
c_func
(paren
id|p
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CPUCLOCK_VIRT
suffix:colon
id|cpu-&gt;cpu
op_assign
id|virt_ticks
c_func
(paren
id|p
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CPUCLOCK_SCHED
suffix:colon
id|cpu-&gt;sched
op_assign
id|sched_ns
c_func
(paren
id|p
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Sample a process (thread group) clock for the given group_leader task.&n; * Must be called with tasklist_lock held for reading.&n; */
DECL|function|cpu_clock_sample_group
r_static
r_int
id|cpu_clock_sample_group
c_func
(paren
id|clockid_t
id|which_clock
comma
r_struct
id|task_struct
op_star
id|p
comma
r_union
id|cpu_time_count
op_star
id|cpu
)paren
(brace
r_struct
id|task_struct
op_star
id|t
op_assign
id|p
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_switch
c_cond
(paren
id|CPUCLOCK_WHICH
c_func
(paren
id|which_clock
)paren
)paren
(brace
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
r_case
id|CPUCLOCK_PROF
suffix:colon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|p-&gt;sighand-&gt;siglock
comma
id|flags
)paren
suffix:semicolon
id|cpu-&gt;cpu
op_assign
id|cputime_add
c_func
(paren
id|p-&gt;signal-&gt;utime
comma
id|p-&gt;signal-&gt;stime
)paren
suffix:semicolon
r_do
(brace
id|cpu-&gt;cpu
op_assign
id|cputime_add
c_func
(paren
id|cpu-&gt;cpu
comma
id|prof_ticks
c_func
(paren
id|t
)paren
)paren
suffix:semicolon
id|t
op_assign
id|next_thread
c_func
(paren
id|t
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|t
op_ne
id|p
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|p-&gt;sighand-&gt;siglock
comma
id|flags
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CPUCLOCK_VIRT
suffix:colon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|p-&gt;sighand-&gt;siglock
comma
id|flags
)paren
suffix:semicolon
id|cpu-&gt;cpu
op_assign
id|p-&gt;signal-&gt;utime
suffix:semicolon
r_do
(brace
id|cpu-&gt;cpu
op_assign
id|cputime_add
c_func
(paren
id|cpu-&gt;cpu
comma
id|virt_ticks
c_func
(paren
id|t
)paren
)paren
suffix:semicolon
id|t
op_assign
id|next_thread
c_func
(paren
id|t
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|t
op_ne
id|p
)paren
suffix:semicolon
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|p-&gt;sighand-&gt;siglock
comma
id|flags
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|CPUCLOCK_SCHED
suffix:colon
id|spin_lock_irqsave
c_func
(paren
op_amp
id|p-&gt;sighand-&gt;siglock
comma
id|flags
)paren
suffix:semicolon
id|cpu-&gt;sched
op_assign
id|p-&gt;signal-&gt;sched_time
suffix:semicolon
multiline_comment|/* Add in each other live thread.  */
r_while
c_loop
(paren
(paren
id|t
op_assign
id|next_thread
c_func
(paren
id|t
)paren
)paren
op_ne
id|p
)paren
(brace
id|cpu-&gt;sched
op_add_assign
id|t-&gt;sched_time
suffix:semicolon
)brace
r_if
c_cond
(paren
id|p-&gt;tgid
op_eq
id|current-&gt;tgid
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * We&squot;re sampling ourselves, so include the&n;&t;&t;&t; * cycles not yet banked.  We still omit&n;&t;&t;&t; * other threads running on other CPUs,&n;&t;&t;&t; * so the total can always be behind as&n;&t;&t;&t; * much as max(nthreads-1,ncpus) * (NSEC_PER_SEC/HZ).&n;&t;&t;&t; */
id|cpu-&gt;sched
op_add_assign
id|current_sched_time
c_func
(paren
id|current
)paren
suffix:semicolon
)brace
r_else
(brace
id|cpu-&gt;sched
op_add_assign
id|p-&gt;sched_time
suffix:semicolon
)brace
id|spin_unlock_irqrestore
c_func
(paren
op_amp
id|p-&gt;sighand-&gt;siglock
comma
id|flags
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|posix_cpu_clock_get
r_int
id|posix_cpu_clock_get
c_func
(paren
id|clockid_t
id|which_clock
comma
r_struct
id|timespec
op_star
id|tp
)paren
(brace
r_const
id|pid_t
id|pid
op_assign
id|CPUCLOCK_PID
c_func
(paren
id|which_clock
)paren
suffix:semicolon
r_int
id|error
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_union
id|cpu_time_count
id|rtn
suffix:semicolon
r_if
c_cond
(paren
id|pid
op_eq
l_int|0
)paren
(brace
multiline_comment|/*&n;&t;&t; * Special case constant value for our own clocks.&n;&t;&t; * We don&squot;t have to do any lookup to find ourselves.&n;&t;&t; */
r_if
c_cond
(paren
id|CPUCLOCK_PERTHREAD
c_func
(paren
id|which_clock
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * Sampling just ourselves we can do with no locking.&n;&t;&t;&t; */
id|error
op_assign
id|cpu_clock_sample
c_func
(paren
id|which_clock
comma
id|current
comma
op_amp
id|rtn
)paren
suffix:semicolon
)brace
r_else
(brace
id|read_lock
c_func
(paren
op_amp
id|tasklist_lock
)paren
suffix:semicolon
id|error
op_assign
id|cpu_clock_sample_group
c_func
(paren
id|which_clock
comma
id|current
comma
op_amp
id|rtn
)paren
suffix:semicolon
id|read_unlock
c_func
(paren
op_amp
id|tasklist_lock
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t; * Find the given PID, and validate that the caller&n;&t;&t; * should be able to see it.&n;&t;&t; */
r_struct
id|task_struct
op_star
id|p
suffix:semicolon
id|read_lock
c_func
(paren
op_amp
id|tasklist_lock
)paren
suffix:semicolon
id|p
op_assign
id|find_task_by_pid
c_func
(paren
id|pid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p
)paren
(brace
r_if
c_cond
(paren
id|CPUCLOCK_PERTHREAD
c_func
(paren
id|which_clock
)paren
)paren
(brace
r_if
c_cond
(paren
id|p-&gt;tgid
op_eq
id|current-&gt;tgid
)paren
(brace
id|error
op_assign
id|cpu_clock_sample
c_func
(paren
id|which_clock
comma
id|p
comma
op_amp
id|rtn
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|p-&gt;tgid
op_eq
id|pid
op_logical_and
id|p-&gt;signal
)paren
(brace
id|error
op_assign
id|cpu_clock_sample_group
c_func
(paren
id|which_clock
comma
id|p
comma
op_amp
id|rtn
)paren
suffix:semicolon
)brace
)brace
id|read_unlock
c_func
(paren
op_amp
id|tasklist_lock
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|error
)paren
r_return
id|error
suffix:semicolon
id|sample_to_timespec
c_func
(paren
id|which_clock
comma
id|rtn
comma
id|tp
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * These can&squot;t be called, since timer_create never works.&n; */
DECL|function|posix_cpu_timer_set
r_int
id|posix_cpu_timer_set
c_func
(paren
r_struct
id|k_itimer
op_star
id|timer
comma
r_int
id|flags
comma
r_struct
id|itimerspec
op_star
id|old
comma
r_struct
id|itimerspec
op_star
r_new
)paren
(brace
id|BUG
c_func
(paren
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|posix_cpu_timer_del
r_int
id|posix_cpu_timer_del
c_func
(paren
r_struct
id|k_itimer
op_star
id|timer
)paren
(brace
id|BUG
c_func
(paren
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|posix_cpu_timer_get
r_void
id|posix_cpu_timer_get
c_func
(paren
r_struct
id|k_itimer
op_star
id|timer
comma
r_struct
id|itimerspec
op_star
id|spec
)paren
(brace
id|BUG
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|macro|PROCESS_CLOCK
mdefine_line|#define PROCESS_CLOCK&t;MAKE_PROCESS_CPUCLOCK(0, CPUCLOCK_SCHED)
DECL|macro|THREAD_CLOCK
mdefine_line|#define THREAD_CLOCK&t;MAKE_THREAD_CPUCLOCK(0, CPUCLOCK_SCHED)
DECL|function|process_cpu_clock_getres
r_static
r_int
id|process_cpu_clock_getres
c_func
(paren
id|clockid_t
id|which_clock
comma
r_struct
id|timespec
op_star
id|tp
)paren
(brace
r_return
id|posix_cpu_clock_getres
c_func
(paren
id|PROCESS_CLOCK
comma
id|tp
)paren
suffix:semicolon
)brace
DECL|function|process_cpu_clock_get
r_static
r_int
id|process_cpu_clock_get
c_func
(paren
id|clockid_t
id|which_clock
comma
r_struct
id|timespec
op_star
id|tp
)paren
(brace
r_return
id|posix_cpu_clock_get
c_func
(paren
id|PROCESS_CLOCK
comma
id|tp
)paren
suffix:semicolon
)brace
DECL|function|thread_cpu_clock_getres
r_static
r_int
id|thread_cpu_clock_getres
c_func
(paren
id|clockid_t
id|which_clock
comma
r_struct
id|timespec
op_star
id|tp
)paren
(brace
r_return
id|posix_cpu_clock_getres
c_func
(paren
id|THREAD_CLOCK
comma
id|tp
)paren
suffix:semicolon
)brace
DECL|function|thread_cpu_clock_get
r_static
r_int
id|thread_cpu_clock_get
c_func
(paren
id|clockid_t
id|which_clock
comma
r_struct
id|timespec
op_star
id|tp
)paren
(brace
r_return
id|posix_cpu_clock_get
c_func
(paren
id|THREAD_CLOCK
comma
id|tp
)paren
suffix:semicolon
)brace
DECL|function|init_posix_cpu_timers
r_static
id|__init
r_int
id|init_posix_cpu_timers
c_func
(paren
r_void
)paren
(brace
r_struct
id|k_clock
id|process
op_assign
(brace
dot
id|clock_getres
op_assign
id|process_cpu_clock_getres
comma
dot
id|clock_get
op_assign
id|process_cpu_clock_get
comma
dot
id|clock_set
op_assign
id|do_posix_clock_nosettime
comma
dot
id|timer_create
op_assign
id|do_posix_clock_notimer_create
comma
dot
id|nsleep
op_assign
id|do_posix_clock_nonanosleep
comma
)brace
suffix:semicolon
r_struct
id|k_clock
id|thread
op_assign
(brace
dot
id|clock_getres
op_assign
id|thread_cpu_clock_getres
comma
dot
id|clock_get
op_assign
id|thread_cpu_clock_get
comma
dot
id|clock_set
op_assign
id|do_posix_clock_nosettime
comma
dot
id|timer_create
op_assign
id|do_posix_clock_notimer_create
comma
dot
id|nsleep
op_assign
id|do_posix_clock_nonanosleep
comma
)brace
suffix:semicolon
id|register_posix_clock
c_func
(paren
id|CLOCK_PROCESS_CPUTIME_ID
comma
op_amp
id|process
)paren
suffix:semicolon
id|register_posix_clock
c_func
(paren
id|CLOCK_THREAD_CPUTIME_ID
comma
op_amp
id|thread
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|init_posix_cpu_timers
id|__initcall
c_func
(paren
id|init_posix_cpu_timers
)paren
suffix:semicolon
eof
