multiline_comment|/*&n; * Handling of different ABIs (personalities).&n; *&n; * We group personalities into execution domains which have their&n; * own handlers for kernel entry points, signal mapping, etc...&n; *&n; * 2001-05-06&t;Complete rewrite,  Christoph Hellwig (hch@caldera.de)&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/kmod.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/personality.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/sysctl.h&gt;
macro_line|#include &lt;linux/types.h&gt;
r_static
r_void
id|default_handler
c_func
(paren
r_int
comma
r_struct
id|pt_regs
op_star
)paren
suffix:semicolon
DECL|variable|exec_domains
r_static
r_struct
id|exec_domain
op_star
id|exec_domains
op_assign
op_amp
id|default_exec_domain
suffix:semicolon
DECL|variable|exec_domains_lock
r_static
id|rwlock_t
id|exec_domains_lock
op_assign
id|RW_LOCK_UNLOCKED
suffix:semicolon
DECL|variable|ident_map
r_static
id|u_long
id|ident_map
(braket
l_int|32
)braket
op_assign
(brace
l_int|0
comma
l_int|1
comma
l_int|2
comma
l_int|3
comma
l_int|4
comma
l_int|5
comma
l_int|6
comma
l_int|7
comma
l_int|8
comma
l_int|9
comma
l_int|10
comma
l_int|11
comma
l_int|12
comma
l_int|13
comma
l_int|14
comma
l_int|15
comma
l_int|16
comma
l_int|17
comma
l_int|18
comma
l_int|19
comma
l_int|20
comma
l_int|21
comma
l_int|22
comma
l_int|23
comma
l_int|24
comma
l_int|25
comma
l_int|26
comma
l_int|27
comma
l_int|28
comma
l_int|29
comma
l_int|30
comma
l_int|31
)brace
suffix:semicolon
DECL|variable|default_exec_domain
r_struct
id|exec_domain
id|default_exec_domain
op_assign
(brace
l_string|&quot;Linux&quot;
comma
multiline_comment|/* name */
id|default_handler
comma
multiline_comment|/* lcall7 causes a seg fault. */
l_int|0
comma
l_int|0
comma
multiline_comment|/* PER_LINUX personality. */
id|ident_map
comma
multiline_comment|/* Identity map signals. */
id|ident_map
comma
multiline_comment|/*  - both ways. */
)brace
suffix:semicolon
r_static
r_void
DECL|function|default_handler
id|default_handler
c_func
(paren
r_int
id|segment
comma
r_struct
id|pt_regs
op_star
id|regp
)paren
(brace
id|u_long
id|pers
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; * This may have been a static linked SVr4 binary, so we would&n;&t; * have the personality set incorrectly. Or it might have been&n;&t; * a Solaris/x86 binary. We can tell which because the former&n;&t; * uses lcall7, while the latter used lcall 0x27.&n;&t; * Try to find or load the appropriate personality, and fall back&n;&t; * to just forcing a SEGV.&n;&t; *&n;&t; * XXX: this is IA32-specific and should be moved to the MD-tree.&n;&t; */
r_switch
c_cond
(paren
id|segment
)paren
(brace
macro_line|#ifdef __i386__
r_case
l_int|0x07
suffix:colon
id|pers
op_assign
id|abi_defhandler_lcall7
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|0x27
suffix:colon
id|pers
op_assign
id|PER_SOLARIS
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
)brace
id|set_personality
c_func
(paren
id|pers
)paren
suffix:semicolon
r_if
c_cond
(paren
id|current-&gt;exec_domain-&gt;handler
op_ne
id|default_handler
)paren
id|current-&gt;exec_domain
op_member_access_from_pointer
id|handler
c_func
(paren
id|segment
comma
id|regp
)paren
suffix:semicolon
r_else
id|send_sig
c_func
(paren
id|SIGSEGV
comma
id|current
comma
l_int|1
)paren
suffix:semicolon
)brace
r_static
r_struct
id|exec_domain
op_star
DECL|function|lookup_exec_domain
id|lookup_exec_domain
c_func
(paren
id|u_long
id|personality
)paren
(brace
r_struct
id|exec_domain
op_star
id|ep
suffix:semicolon
id|u_long
id|pers
op_assign
id|personality
c_func
(paren
id|personality
)paren
suffix:semicolon
id|read_lock
c_func
(paren
op_amp
id|exec_domains_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|ep
op_assign
id|exec_domains
suffix:semicolon
id|ep
suffix:semicolon
id|ep
op_assign
id|ep-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|pers
op_ge
id|ep-&gt;pers_low
op_logical_and
id|pers
op_le
id|ep-&gt;pers_high
)paren
r_if
c_cond
(paren
id|try_inc_mod_count
c_func
(paren
id|ep-&gt;module
)paren
)paren
r_goto
id|out
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_KMOD
id|read_unlock
c_func
(paren
op_amp
id|exec_domains_lock
)paren
suffix:semicolon
(brace
r_char
id|buffer
(braket
l_int|30
)braket
suffix:semicolon
id|sprintf
c_func
(paren
id|buffer
comma
l_string|&quot;personality-%ld&quot;
comma
id|pers
)paren
suffix:semicolon
id|request_module
c_func
(paren
id|buffer
)paren
suffix:semicolon
)brace
id|read_lock
c_func
(paren
op_amp
id|exec_domains_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|ep
op_assign
id|exec_domains
suffix:semicolon
id|ep
suffix:semicolon
id|ep
op_assign
id|ep-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|pers
op_ge
id|ep-&gt;pers_low
op_logical_and
id|pers
op_le
id|ep-&gt;pers_high
)paren
r_if
c_cond
(paren
id|try_inc_mod_count
c_func
(paren
id|ep-&gt;module
)paren
)paren
r_goto
id|out
suffix:semicolon
)brace
macro_line|#endif
id|ep
op_assign
l_int|NULL
suffix:semicolon
id|out
suffix:colon
id|read_unlock
c_func
(paren
op_amp
id|exec_domains_lock
)paren
suffix:semicolon
r_return
(paren
id|ep
)paren
suffix:semicolon
)brace
r_int
DECL|function|register_exec_domain
id|register_exec_domain
c_func
(paren
r_struct
id|exec_domain
op_star
id|ep
)paren
(brace
r_struct
id|exec_domain
op_star
id|tmp
suffix:semicolon
r_int
id|err
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_if
c_cond
(paren
id|ep
op_eq
l_int|NULL
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|ep-&gt;next
op_ne
l_int|NULL
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
id|write_lock
c_func
(paren
op_amp
id|exec_domains_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|tmp
op_assign
id|exec_domains
suffix:semicolon
id|tmp
suffix:semicolon
id|tmp
op_assign
id|tmp-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|tmp
op_eq
id|ep
)paren
r_goto
id|out
suffix:semicolon
)brace
id|ep-&gt;next
op_assign
id|exec_domains
suffix:semicolon
id|exec_domains
op_assign
id|ep
suffix:semicolon
id|err
op_assign
l_int|0
suffix:semicolon
id|out
suffix:colon
id|write_unlock
c_func
(paren
op_amp
id|exec_domains_lock
)paren
suffix:semicolon
r_return
(paren
id|err
)paren
suffix:semicolon
)brace
r_int
DECL|function|unregister_exec_domain
id|unregister_exec_domain
c_func
(paren
r_struct
id|exec_domain
op_star
id|ep
)paren
(brace
r_struct
id|exec_domain
op_star
op_star
id|epp
suffix:semicolon
id|epp
op_assign
op_amp
id|exec_domains
suffix:semicolon
id|write_lock
c_func
(paren
op_amp
id|exec_domains_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|epp
op_assign
op_amp
id|exec_domains
suffix:semicolon
op_star
id|epp
suffix:semicolon
id|epp
op_assign
op_amp
(paren
op_star
id|epp
)paren
op_member_access_from_pointer
id|next
)paren
(brace
r_if
c_cond
(paren
id|ep
op_eq
op_star
id|epp
)paren
r_goto
id|unregister
suffix:semicolon
)brace
id|write_unlock
c_func
(paren
op_amp
id|exec_domains_lock
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
id|unregister
suffix:colon
op_star
id|epp
op_assign
id|ep-&gt;next
suffix:semicolon
id|ep-&gt;next
op_assign
l_int|NULL
suffix:semicolon
id|write_unlock
c_func
(paren
op_amp
id|exec_domains_lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|__set_personality
id|__set_personality
c_func
(paren
id|u_long
id|personality
)paren
(brace
r_struct
id|exec_domain
op_star
id|ep
comma
op_star
id|oep
suffix:semicolon
id|ep
op_assign
id|lookup_exec_domain
c_func
(paren
id|personality
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ep
op_eq
l_int|NULL
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|ep
op_eq
id|current-&gt;exec_domain
)paren
(brace
id|current-&gt;personality
op_assign
id|personality
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|current-&gt;fs-&gt;count
)paren
op_ne
l_int|1
)paren
(brace
r_struct
id|fs_struct
op_star
id|fsp
comma
op_star
id|ofsp
suffix:semicolon
id|fsp
op_assign
id|copy_fs_struct
c_func
(paren
id|current-&gt;fs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fsp
op_eq
l_int|NULL
)paren
(brace
id|put_exec_domain
c_func
(paren
id|ep
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
suffix:semicolon
)brace
id|task_lock
c_func
(paren
id|current
)paren
suffix:semicolon
id|ofsp
op_assign
id|current-&gt;fs
suffix:semicolon
id|current-&gt;fs
op_assign
id|fsp
suffix:semicolon
id|task_unlock
c_func
(paren
id|current
)paren
suffix:semicolon
id|put_fs_struct
c_func
(paren
id|ofsp
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * At that point we are guaranteed to be the sole owner of&n;&t; * current-&gt;fs.&n;&t; */
id|current-&gt;personality
op_assign
id|personality
suffix:semicolon
id|oep
op_assign
id|current-&gt;exec_domain
suffix:semicolon
id|current-&gt;exec_domain
op_assign
id|ep
suffix:semicolon
id|set_fs_altroot
c_func
(paren
)paren
suffix:semicolon
id|put_exec_domain
c_func
(paren
id|oep
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;[%s:%d]: set personality to %lx&bslash;n&quot;
comma
id|current-&gt;comm
comma
id|current-&gt;pid
comma
id|personality
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|get_exec_domain_list
id|get_exec_domain_list
c_func
(paren
r_char
op_star
id|page
)paren
(brace
r_struct
id|exec_domain
op_star
id|ep
suffix:semicolon
r_int
id|len
op_assign
l_int|0
suffix:semicolon
id|read_lock
c_func
(paren
op_amp
id|exec_domains_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|ep
op_assign
id|exec_domains
suffix:semicolon
id|ep
op_logical_and
id|len
OL
id|PAGE_SIZE
op_minus
l_int|80
suffix:semicolon
id|ep
op_assign
id|ep-&gt;next
)paren
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot;%d-%d&bslash;t%-16s&bslash;t[%s]&bslash;n&quot;
comma
id|ep-&gt;pers_low
comma
id|ep-&gt;pers_high
comma
id|ep-&gt;name
comma
id|ep-&gt;module
ques
c_cond
id|ep-&gt;module-&gt;name
suffix:colon
l_string|&quot;kernel&quot;
)paren
suffix:semicolon
id|read_unlock
c_func
(paren
op_amp
id|exec_domains_lock
)paren
suffix:semicolon
r_return
(paren
id|len
)paren
suffix:semicolon
)brace
id|asmlinkage
r_int
DECL|function|sys_personality
id|sys_personality
c_func
(paren
id|u_long
id|personality
)paren
(brace
id|u_long
id|old
op_assign
id|current-&gt;personality
suffix:semicolon
suffix:semicolon
r_if
c_cond
(paren
id|personality
op_ne
l_int|0xffffffff
)paren
(brace
id|set_personality
c_func
(paren
id|personality
)paren
suffix:semicolon
r_if
c_cond
(paren
id|current-&gt;personality
op_ne
id|personality
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
(paren
r_int
)paren
id|old
suffix:semicolon
)brace
DECL|variable|register_exec_domain
id|EXPORT_SYMBOL
c_func
(paren
id|register_exec_domain
)paren
suffix:semicolon
DECL|variable|unregister_exec_domain
id|EXPORT_SYMBOL
c_func
(paren
id|unregister_exec_domain
)paren
suffix:semicolon
DECL|variable|__set_personality
id|EXPORT_SYMBOL
c_func
(paren
id|__set_personality
)paren
suffix:semicolon
multiline_comment|/*&n; * We have to have all sysctl handling for the Linux-ABI&n; * in one place as the dynamic registration of sysctls is&n; * horribly crufty in Linux &lt;= 2.4.&n; *&n; * I hope the new sysctl schemes discussed for future versions&n; * will obsolete this.&n; *&n; * &t;&t;&t;&t;--hch&n; */
DECL|variable|abi_defhandler_coff
id|u_long
id|abi_defhandler_coff
op_assign
id|PER_SCOSVR3
suffix:semicolon
DECL|variable|abi_defhandler_elf
id|u_long
id|abi_defhandler_elf
op_assign
id|PER_LINUX
suffix:semicolon
DECL|variable|abi_defhandler_lcall7
id|u_long
id|abi_defhandler_lcall7
op_assign
id|PER_SVR4
suffix:semicolon
DECL|variable|abi_defhandler_libcso
id|u_long
id|abi_defhandler_libcso
op_assign
id|PER_SVR4
suffix:semicolon
DECL|variable|abi_traceflg
id|u_int
id|abi_traceflg
suffix:semicolon
DECL|variable|abi_fake_utsname
r_int
id|abi_fake_utsname
suffix:semicolon
DECL|variable|abi_table
r_static
r_struct
id|ctl_table
id|abi_table
(braket
)braket
op_assign
(brace
(brace
id|ABI_DEFHANDLER_COFF
comma
l_string|&quot;defhandler_coff&quot;
comma
op_amp
id|abi_defhandler_coff
comma
r_sizeof
(paren
r_int
)paren
comma
l_int|0644
comma
l_int|NULL
comma
op_amp
id|proc_doulongvec_minmax
)brace
comma
(brace
id|ABI_DEFHANDLER_ELF
comma
l_string|&quot;defhandler_elf&quot;
comma
op_amp
id|abi_defhandler_elf
comma
r_sizeof
(paren
r_int
)paren
comma
l_int|0644
comma
l_int|NULL
comma
op_amp
id|proc_doulongvec_minmax
)brace
comma
(brace
id|ABI_DEFHANDLER_LCALL7
comma
l_string|&quot;defhandler_lcall7&quot;
comma
op_amp
id|abi_defhandler_lcall7
comma
r_sizeof
(paren
r_int
)paren
comma
l_int|0644
comma
l_int|NULL
comma
op_amp
id|proc_doulongvec_minmax
)brace
comma
(brace
id|ABI_DEFHANDLER_LIBCSO
comma
l_string|&quot;defhandler_libcso&quot;
comma
op_amp
id|abi_defhandler_libcso
comma
r_sizeof
(paren
r_int
)paren
comma
l_int|0644
comma
l_int|NULL
comma
op_amp
id|proc_doulongvec_minmax
)brace
comma
(brace
id|ABI_TRACE
comma
l_string|&quot;trace&quot;
comma
op_amp
id|abi_traceflg
comma
r_sizeof
(paren
id|u_int
)paren
comma
l_int|0644
comma
l_int|NULL
comma
op_amp
id|proc_dointvec
)brace
comma
(brace
id|ABI_FAKE_UTSNAME
comma
l_string|&quot;fake_utsname&quot;
comma
op_amp
id|abi_fake_utsname
comma
r_sizeof
(paren
r_int
)paren
comma
l_int|0644
comma
l_int|NULL
comma
op_amp
id|proc_dointvec
)brace
comma
(brace
l_int|0
)brace
)brace
suffix:semicolon
DECL|variable|abi_root_table
r_static
r_struct
id|ctl_table
id|abi_root_table
(braket
)braket
op_assign
(brace
(brace
id|CTL_ABI
comma
l_string|&quot;abi&quot;
comma
l_int|NULL
comma
l_int|0
comma
l_int|0555
comma
id|abi_table
)brace
comma
(brace
l_int|0
)brace
)brace
suffix:semicolon
r_static
r_int
id|__init
DECL|function|abi_register_sysctl
id|abi_register_sysctl
c_func
(paren
r_void
)paren
(brace
id|register_sysctl_table
c_func
(paren
id|abi_root_table
comma
l_int|1
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|abi_register_sysctl
id|__initcall
c_func
(paren
id|abi_register_sysctl
)paren
suffix:semicolon
DECL|variable|abi_defhandler_coff
id|EXPORT_SYMBOL
c_func
(paren
id|abi_defhandler_coff
)paren
suffix:semicolon
DECL|variable|abi_defhandler_elf
id|EXPORT_SYMBOL
c_func
(paren
id|abi_defhandler_elf
)paren
suffix:semicolon
DECL|variable|abi_defhandler_lcall7
id|EXPORT_SYMBOL
c_func
(paren
id|abi_defhandler_lcall7
)paren
suffix:semicolon
DECL|variable|abi_defhandler_libcso
id|EXPORT_SYMBOL
c_func
(paren
id|abi_defhandler_libcso
)paren
suffix:semicolon
DECL|variable|abi_traceflg
id|EXPORT_SYMBOL
c_func
(paren
id|abi_traceflg
)paren
suffix:semicolon
DECL|variable|abi_fake_utsname
id|EXPORT_SYMBOL
c_func
(paren
id|abi_fake_utsname
)paren
suffix:semicolon
eof
