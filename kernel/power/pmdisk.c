multiline_comment|/*&n; * kernel/power/pmdisk.c - Suspend-to-disk implmentation&n; *&n; * This STD implementation is initially derived from swsusp (suspend-to-swap).&n; * The original copyright on that was: &n; *&n; * Copyright (C) 1998-2001 Gabor Kuti &lt;seasons@fornax.hu&gt;&n; * Copyright (C) 1998,2001,2002 Pavel Machek &lt;pavel@suse.cz&gt;&n; *&n; * The additional parts are: &n; * &n; * Copyright (C) 2003 Patrick Mochel&n; * Copyright (C) 2003 Open Source Development Lab&n; * &n; * This file is released under the GPLv2. &n; *&n; * For more information, please see the text files in Documentation/power/&n; *&n; */
DECL|macro|DEBUG
macro_line|#undef DEBUG
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/bio.h&gt;
macro_line|#include &lt;linux/suspend.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/reboot.h&gt;
macro_line|#include &lt;linux/device.h&gt;
macro_line|#include &lt;linux/swapops.h&gt;
macro_line|#include &lt;linux/bootmem.h&gt;
macro_line|#include &lt;asm/mmu_context.h&gt;
macro_line|#include &quot;power.h&quot;
multiline_comment|/* For resume= kernel option */
DECL|variable|resume_file
r_static
r_char
id|resume_file
(braket
l_int|256
)braket
op_assign
id|CONFIG_PM_DISK_PARTITION
suffix:semicolon
DECL|variable|resume_device
r_static
id|dev_t
id|resume_device
suffix:semicolon
r_extern
id|suspend_pagedir_t
op_star
id|pagedir_save
suffix:semicolon
multiline_comment|/*&n; * Saving part...&n; */
r_extern
r_void
id|swsusp_swap_lock
c_func
(paren
r_void
)paren
suffix:semicolon
multiline_comment|/**&n; *&t;suspend_save_image - Prepare and write saved image to swap.&n; *&n; *&t;IRQs are re-enabled here so we can resume devices and safely write&n; *&t;to the swap devices. We disable them again before we leave.&n; *&n; *&t;The second swsusp_swap_lock() will unlock ignored swap devices since&n; *&t;writing is finished.&n; *&t;It is important _NOT_ to umount filesystems at this point. We want&n; *&t;them synced (in case something goes wrong) but we DO not want to mark&n; *&t;filesystem clean: it is not. (And it does not matter, if we resume&n; *&t;correctly, we&squot;ll mark system clean, anyway.)&n; */
DECL|function|suspend_save_image
r_static
r_int
id|suspend_save_image
c_func
(paren
r_void
)paren
(brace
r_extern
r_int
id|write_suspend_image
c_func
(paren
r_void
)paren
suffix:semicolon
r_int
id|error
suffix:semicolon
id|device_resume
c_func
(paren
)paren
suffix:semicolon
id|swsusp_swap_lock
c_func
(paren
)paren
suffix:semicolon
id|error
op_assign
id|write_suspend_image
c_func
(paren
)paren
suffix:semicolon
id|swsusp_swap_lock
c_func
(paren
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
multiline_comment|/* More restore stuff */
r_extern
r_struct
id|block_device
op_star
id|resume_bdev
suffix:semicolon
r_extern
id|dev_t
id|__init
id|name_to_dev_t
c_func
(paren
r_const
r_char
op_star
id|line
)paren
suffix:semicolon
multiline_comment|/**&n; *&t;pmdisk_write - Write saved memory image to swap.&n; *&n; *&t;pmdisk_arch_suspend(0) returns after system is resumed.&n; *&n; *&t;pmdisk_arch_suspend() copies all &quot;used&quot; memory to &quot;free&quot; memory,&n; *&t;then unsuspends all device drivers, and writes memory to disk&n; *&t;using normal kernel mechanism.&n; */
DECL|function|pmdisk_write
r_int
id|pmdisk_write
c_func
(paren
r_void
)paren
(brace
r_return
id|suspend_save_image
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;pmdisk_read - Read saved image from swap.&n; */
DECL|function|pmdisk_read
r_int
id|__init
id|pmdisk_read
c_func
(paren
r_void
)paren
(brace
r_extern
r_int
id|read_suspend_image
c_func
(paren
r_void
)paren
suffix:semicolon
r_int
id|error
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strlen
c_func
(paren
id|resume_file
)paren
)paren
r_return
op_minus
id|ENOENT
suffix:semicolon
id|resume_device
op_assign
id|name_to_dev_t
c_func
(paren
id|resume_file
)paren
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;pmdisk: Resume From Partition: %s&bslash;n&quot;
comma
id|resume_file
)paren
suffix:semicolon
id|resume_bdev
op_assign
id|open_by_devnum
c_func
(paren
id|resume_device
comma
id|FMODE_READ
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|IS_ERR
c_func
(paren
id|resume_bdev
)paren
)paren
(brace
id|set_blocksize
c_func
(paren
id|resume_bdev
comma
id|PAGE_SIZE
)paren
suffix:semicolon
id|error
op_assign
id|read_suspend_image
c_func
(paren
)paren
suffix:semicolon
id|blkdev_put
c_func
(paren
id|resume_bdev
)paren
suffix:semicolon
)brace
r_else
id|error
op_assign
id|PTR_ERR
c_func
(paren
id|resume_bdev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|error
)paren
id|pr_debug
c_func
(paren
l_string|&quot;Reading resume file was successful&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|pr_debug
c_func
(paren
l_string|&quot;pmdisk: Error %d resuming&bslash;n&quot;
comma
id|error
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;pmdisk_free - Free memory allocated to hold snapshot.&n; */
DECL|function|pmdisk_free
r_int
id|pmdisk_free
c_func
(paren
r_void
)paren
(brace
r_extern
r_void
id|free_suspend_pagedir
c_func
(paren
r_int
r_int
id|this_pagedir
)paren
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;Freeing prev allocated pagedir&bslash;n&quot;
)paren
suffix:semicolon
id|free_suspend_pagedir
c_func
(paren
(paren
r_int
r_int
)paren
id|pagedir_save
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|pmdisk_setup
r_static
r_int
id|__init
id|pmdisk_setup
c_func
(paren
r_char
op_star
id|str
)paren
(brace
r_if
c_cond
(paren
id|strlen
c_func
(paren
id|str
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|str
comma
l_string|&quot;off&quot;
)paren
)paren
id|resume_file
(braket
l_int|0
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_else
id|strncpy
c_func
(paren
id|resume_file
comma
id|str
comma
l_int|255
)paren
suffix:semicolon
)brace
r_else
id|resume_file
(braket
l_int|0
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|__setup
c_func
(paren
l_string|&quot;pmdisk=&quot;
comma
id|pmdisk_setup
)paren
suffix:semicolon
eof
