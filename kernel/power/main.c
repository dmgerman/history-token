multiline_comment|/*&n; * kernel/power/main.c - PM subsystem core functionality.&n; *&n; * Copyright (c) 2003 Patrick Mochel&n; * Copyright (c) 2003 Open Source Development Lab&n; * &n; * This file is release under the GPLv2&n; *&n; */
macro_line|#include &lt;linux/suspend.h&gt;
macro_line|#include &lt;linux/kobject.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/pm.h&gt;
r_static
id|DECLARE_MUTEX
c_func
(paren
id|pm_sem
)paren
suffix:semicolon
DECL|variable|pm_ops
r_static
r_struct
id|pm_ops
op_star
id|pm_ops
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/**&n; *&t;pm_set_ops - Set the global power method table. &n; *&t;@ops:&t;Pointer to ops structure.&n; */
DECL|function|pm_set_ops
r_void
id|pm_set_ops
c_func
(paren
r_struct
id|pm_ops
op_star
id|ops
)paren
(brace
id|down
c_func
(paren
op_amp
id|pm_sem
)paren
suffix:semicolon
id|pm_ops
op_assign
id|ops
suffix:semicolon
id|up
c_func
(paren
op_amp
id|pm_sem
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;pm_suspend_standby - Enter &squot;standby&squot; state.&n; *&t;&n; *&t;&squot;standby&squot; is also known as &squot;Power-On Suspend&squot;. Here, we power down&n; *&t;devices, disable interrupts, and enter the state.&n; */
DECL|function|pm_suspend_standby
r_static
r_int
id|pm_suspend_standby
c_func
(paren
r_void
)paren
(brace
r_int
id|error
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pm_ops
op_logical_or
op_logical_neg
id|pm_ops-&gt;enter
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
r_if
c_cond
(paren
(paren
id|error
op_assign
id|device_pm_power_down
c_func
(paren
id|PM_SUSPEND_STANDBY
)paren
)paren
)paren
r_goto
id|Done
suffix:semicolon
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
id|error
op_assign
id|pm_ops
op_member_access_from_pointer
id|enter
c_func
(paren
id|PM_SUSPEND_STANDBY
)paren
suffix:semicolon
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
id|device_pm_power_up
c_func
(paren
)paren
suffix:semicolon
id|Done
suffix:colon
r_return
id|error
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;pm_suspend_mem - Enter suspend-to-RAM state.&n; *&n; *&t;Identical to pm_suspend_standby() - we power down devices, disable &n; *&t;interrupts, and enter the low-power state.&n; */
DECL|function|pm_suspend_mem
r_static
r_int
id|pm_suspend_mem
c_func
(paren
r_void
)paren
(brace
r_int
id|error
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pm_ops
op_logical_or
op_logical_neg
id|pm_ops-&gt;enter
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
r_if
c_cond
(paren
(paren
id|error
op_assign
id|device_pm_power_down
c_func
(paren
id|PM_SUSPEND_STANDBY
)paren
)paren
)paren
r_goto
id|Done
suffix:semicolon
id|local_irq_save
c_func
(paren
id|flags
)paren
suffix:semicolon
id|error
op_assign
id|pm_ops
op_member_access_from_pointer
id|enter
c_func
(paren
id|PM_SUSPEND_STANDBY
)paren
suffix:semicolon
id|local_irq_restore
c_func
(paren
id|flags
)paren
suffix:semicolon
id|device_pm_power_up
c_func
(paren
)paren
suffix:semicolon
id|Done
suffix:colon
r_return
id|error
suffix:semicolon
)brace
DECL|function|pm_suspend_disk
r_static
r_int
id|pm_suspend_disk
c_func
(paren
r_void
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|macro|decl_state
mdefine_line|#define decl_state(_name) &bslash;&n;&t;{ .name = __stringify(_name), .fn = pm_suspend_##_name }
DECL|struct|pm_state
r_struct
id|pm_state
(brace
DECL|member|name
r_char
op_star
id|name
suffix:semicolon
DECL|member|fn
r_int
(paren
op_star
id|fn
)paren
(paren
r_void
)paren
suffix:semicolon
DECL|variable|pm_states
)brace
id|pm_states
(braket
)braket
op_assign
(brace
(braket
id|PM_SUSPEND_STANDBY
)braket
op_assign
id|decl_state
c_func
(paren
id|standby
)paren
comma
(braket
id|PM_SUSPEND_MEM
)braket
op_assign
id|decl_state
c_func
(paren
id|mem
)paren
comma
(braket
id|PM_SUSPEND_DISK
)braket
op_assign
id|decl_state
c_func
(paren
id|disk
)paren
comma
(brace
l_int|NULL
)brace
comma
)brace
suffix:semicolon
multiline_comment|/**&n; *&t;suspend_prepare - Do prep work before entering low-power state.&n; *&t;@state:&t;&t;State we&squot;re entering.&n; *&n; *&t;This is common code that is called for each state that we&squot;re &n; *&t;entering. Allocate a console, stop all processes, then make sure&n; *&t;the platform can enter the requested state.&n; */
DECL|function|suspend_prepare
r_static
r_int
id|suspend_prepare
c_func
(paren
id|u32
id|state
)paren
(brace
r_int
id|error
op_assign
l_int|0
suffix:semicolon
id|pm_prepare_console
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|freeze_processes
c_func
(paren
)paren
)paren
(brace
id|error
op_assign
op_minus
id|EAGAIN
suffix:semicolon
r_goto
id|Thaw
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pm_ops
op_logical_and
id|pm_ops-&gt;prepare
)paren
(brace
r_if
c_cond
(paren
(paren
id|error
op_assign
id|pm_ops
op_member_access_from_pointer
id|prepare
c_func
(paren
id|state
)paren
)paren
)paren
r_goto
id|Thaw
suffix:semicolon
)brace
id|Done
suffix:colon
id|pm_restore_console
c_func
(paren
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
id|Thaw
suffix:colon
id|thaw_processes
c_func
(paren
)paren
suffix:semicolon
r_goto
id|Done
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;suspend_finish - Do final work before exiting suspend sequence.&n; *&t;@state:&t;&t;State we&squot;re coming out of.&n; *&n; *&t;Call platform code to clean up, restart processes, and free the &n; *&t;console that we&squot;ve allocated.&n; */
DECL|function|suspend_finish
r_static
r_void
id|suspend_finish
c_func
(paren
id|u32
id|state
)paren
(brace
r_if
c_cond
(paren
id|pm_ops
op_logical_and
id|pm_ops-&gt;finish
)paren
id|pm_ops
op_member_access_from_pointer
id|finish
c_func
(paren
id|state
)paren
suffix:semicolon
id|thaw_processes
c_func
(paren
)paren
suffix:semicolon
id|pm_restore_console
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;enter_state - Do common work of entering low-power state.&n; *&t;@state:&t;&t;pm_state structure for state we&squot;re entering.&n; *&n; *&t;Make sure we&squot;re the only ones trying to enter a sleep state. Fail&n; *&t;if someone has beat us to it, since we don&squot;t want anything weird to&n; *&t;happen when we wake up.&n; *&t;Then, do the setup for suspend, enter the state, and cleaup (after&n; *&t;we&squot;ve woken up).&n; */
DECL|function|enter_state
r_static
r_int
id|enter_state
c_func
(paren
id|u32
id|state
)paren
(brace
r_int
id|error
suffix:semicolon
r_struct
id|pm_state
op_star
id|s
op_assign
op_amp
id|pm_states
(braket
id|state
)braket
suffix:semicolon
r_if
c_cond
(paren
id|down_trylock
c_func
(paren
op_amp
id|pm_sem
)paren
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
multiline_comment|/* Suspend is hard to get right on SMP. */
r_if
c_cond
(paren
id|num_online_cpus
c_func
(paren
)paren
op_ne
l_int|1
)paren
(brace
id|error
op_assign
op_minus
id|EPERM
suffix:semicolon
r_goto
id|Unlock
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|error
op_assign
id|suspend_prepare
c_func
(paren
id|state
)paren
)paren
)paren
r_goto
id|Unlock
suffix:semicolon
r_if
c_cond
(paren
(paren
id|error
op_assign
id|device_pm_suspend
c_func
(paren
id|state
)paren
)paren
)paren
r_goto
id|Finish
suffix:semicolon
id|error
op_assign
id|s
op_member_access_from_pointer
id|fn
c_func
(paren
)paren
suffix:semicolon
id|device_pm_resume
c_func
(paren
)paren
suffix:semicolon
id|Finish
suffix:colon
id|suspend_finish
c_func
(paren
id|state
)paren
suffix:semicolon
id|Unlock
suffix:colon
id|up
c_func
(paren
op_amp
id|pm_sem
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;pm_suspend - Externally visible function for suspending system.&n; *&t;@state:&t;&t;Enumarted value of state to enter.&n; *&n; *&t;Determine whether or not value is within range, get state &n; *&t;structure, and enter (above).&n; */
DECL|function|pm_suspend
r_int
id|pm_suspend
c_func
(paren
id|u32
id|state
)paren
(brace
r_if
c_cond
(paren
id|state
OG
id|PM_SUSPEND_ON
op_logical_and
id|state
OL
id|PM_SUSPEND_MAX
)paren
r_return
id|enter_state
c_func
(paren
id|state
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|decl_subsys
c_func
(paren
id|power
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
DECL|macro|power_attr
mdefine_line|#define power_attr(_name) &bslash;&n;static struct subsys_attribute _name##_attr = {&t;&bslash;&n;&t;.attr&t;= {&t;&t;&t;&t;&bslash;&n;&t;&t;.name = __stringify(_name),&t;&bslash;&n;&t;&t;.mode = 0644,&t;&t;&t;&bslash;&n;&t;},&t;&t;&t;&t;&t;&bslash;&n;&t;.show&t;= _name##_show,&t;&t;&t;&bslash;&n;&t;.store&t;= _name##_store,&t;&t;&bslash;&n;}
multiline_comment|/**&n; *&t;state - control system power state.&n; *&n; *&t;show() returns what states are supported, which is hard-coded to&n; *&t;&squot;standby&squot; (Power-On Suspend), &squot;mem&squot; (Suspend-to-RAM), and&n; *&t;&squot;disk&squot; (Suspend-to-Disk).&n; *&n; *&t;store() accepts one of those strings, translates it into the &n; *&t;proper enumerated value, and initiates a suspend transition.&n; */
DECL|function|state_show
r_static
id|ssize_t
id|state_show
c_func
(paren
r_struct
id|subsystem
op_star
id|subsys
comma
r_char
op_star
id|buf
)paren
(brace
r_struct
id|pm_state
op_star
id|state
suffix:semicolon
r_char
op_star
id|s
op_assign
id|buf
suffix:semicolon
r_for
c_loop
(paren
id|state
op_assign
op_amp
id|pm_states
(braket
l_int|0
)braket
suffix:semicolon
id|state-&gt;name
suffix:semicolon
id|state
op_increment
)paren
id|s
op_add_assign
id|sprintf
c_func
(paren
id|s
comma
l_string|&quot;%s &quot;
comma
id|state-&gt;name
)paren
suffix:semicolon
id|s
op_add_assign
id|sprintf
c_func
(paren
id|s
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_return
(paren
id|s
op_minus
id|buf
)paren
suffix:semicolon
)brace
DECL|function|state_store
r_static
id|ssize_t
id|state_store
c_func
(paren
r_struct
id|subsystem
op_star
id|subsys
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|n
)paren
(brace
id|u32
id|state
suffix:semicolon
r_struct
id|pm_state
op_star
id|s
suffix:semicolon
r_int
id|error
suffix:semicolon
r_char
op_star
id|end
op_assign
id|strchr
c_func
(paren
id|buf
comma
l_char|&squot;&bslash;n&squot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|end
)paren
op_star
id|end
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_for
c_loop
(paren
id|state
op_assign
l_int|0
suffix:semicolon
id|state
OL
id|PM_SUSPEND_MAX
suffix:semicolon
id|state
op_increment
)paren
(brace
id|s
op_assign
op_amp
id|pm_states
(braket
id|state
)braket
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;name
op_logical_and
op_logical_neg
id|strcmp
c_func
(paren
id|buf
comma
id|s-&gt;name
)paren
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s
)paren
id|error
op_assign
id|enter_state
c_func
(paren
id|state
)paren
suffix:semicolon
r_else
id|error
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_return
id|error
ques
c_cond
id|error
suffix:colon
id|n
suffix:semicolon
)brace
DECL|variable|state
id|power_attr
c_func
(paren
id|state
)paren
suffix:semicolon
DECL|variable|g
r_static
r_struct
id|attribute
op_star
id|g
(braket
)braket
op_assign
(brace
op_amp
id|state_attr.attr
comma
l_int|NULL
comma
)brace
suffix:semicolon
DECL|variable|attr_group
r_static
r_struct
id|attribute_group
id|attr_group
op_assign
(brace
dot
id|attrs
op_assign
id|g
comma
)brace
suffix:semicolon
DECL|function|pm_init
r_static
r_int
id|pm_init
c_func
(paren
r_void
)paren
(brace
r_int
id|error
op_assign
id|subsystem_register
c_func
(paren
op_amp
id|power_subsys
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|error
)paren
id|error
op_assign
id|sysfs_create_group
c_func
(paren
op_amp
id|power_subsys.kset.kobj
comma
op_amp
id|attr_group
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|variable|pm_init
id|core_initcall
c_func
(paren
id|pm_init
)paren
suffix:semicolon
eof
