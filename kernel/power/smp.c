multiline_comment|/*&n; * drivers/power/smp.c - Functions for stopping other CPUs.&n; *&n; * Copyright 2004 Pavel Machek &lt;pavel@suse.cz&gt;&n; * Copyright (C) 2002-2003 Nigel Cunningham &lt;ncunningham@clear.net.nz&gt;&n; *&n; * This file is released under the GPLv2.&n; */
DECL|macro|DEBUG
macro_line|#undef DEBUG
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/suspend.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;asm/atomic.h&gt;
macro_line|#include &lt;asm/tlbflush.h&gt;
DECL|variable|cpu_counter
DECL|variable|freeze
r_static
id|atomic_t
id|cpu_counter
comma
id|freeze
suffix:semicolon
DECL|function|smp_pause
r_static
r_void
id|smp_pause
c_func
(paren
r_void
op_star
id|data
)paren
(brace
r_struct
id|saved_context
id|ctxt
suffix:semicolon
id|__save_processor_state
c_func
(paren
op_amp
id|ctxt
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Sleeping in:&bslash;n&quot;
)paren
suffix:semicolon
id|dump_stack
c_func
(paren
)paren
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|cpu_counter
)paren
suffix:semicolon
r_while
c_loop
(paren
id|atomic_read
c_func
(paren
op_amp
id|freeze
)paren
)paren
(brace
multiline_comment|/* FIXME: restore takes place at random piece inside this.&n;&t;&t;   This should probably be written in assembly, and&n;&t;&t;   preserve general-purpose registers, too&n;&n;&t;&t;   What about stack? We may need to move to new stack here.&n;&n;&t;&t;   This should better be ran with interrupts disabled.&n;&t;&t; */
id|cpu_relax
c_func
(paren
)paren
suffix:semicolon
id|barrier
c_func
(paren
)paren
suffix:semicolon
)brace
id|atomic_dec
c_func
(paren
op_amp
id|cpu_counter
)paren
suffix:semicolon
id|__restore_processor_state
c_func
(paren
op_amp
id|ctxt
)paren
suffix:semicolon
)brace
DECL|variable|oldmask
id|cpumask_t
id|oldmask
suffix:semicolon
DECL|function|disable_nonboot_cpus
r_void
id|disable_nonboot_cpus
c_func
(paren
r_void
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Freezing CPUs (at %d)&quot;
comma
id|smp_processor_id
c_func
(paren
)paren
)paren
suffix:semicolon
id|oldmask
op_assign
id|current-&gt;cpus_allowed
suffix:semicolon
id|set_cpus_allowed
c_func
(paren
id|current
comma
id|cpumask_of_cpu
c_func
(paren
l_int|0
)paren
)paren
suffix:semicolon
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|HZ
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;...&quot;
)paren
suffix:semicolon
id|BUG_ON
c_func
(paren
id|smp_processor_id
c_func
(paren
)paren
op_ne
l_int|0
)paren
suffix:semicolon
multiline_comment|/* FIXME: for this to work, all the CPUs must be running&n;&t; * &quot;idle&quot; thread (or we deadlock). Is that guaranteed? */
id|atomic_set
c_func
(paren
op_amp
id|cpu_counter
comma
l_int|0
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|freeze
comma
l_int|1
)paren
suffix:semicolon
id|smp_call_function
c_func
(paren
id|smp_pause
comma
l_int|NULL
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_while
c_loop
(paren
id|atomic_read
c_func
(paren
op_amp
id|cpu_counter
)paren
OL
(paren
id|num_online_cpus
c_func
(paren
)paren
op_minus
l_int|1
)paren
)paren
(brace
id|cpu_relax
c_func
(paren
)paren
suffix:semicolon
id|barrier
c_func
(paren
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;ok&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|enable_nonboot_cpus
r_void
id|enable_nonboot_cpus
c_func
(paren
r_void
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Restarting CPUs&quot;
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|freeze
comma
l_int|0
)paren
suffix:semicolon
r_while
c_loop
(paren
id|atomic_read
c_func
(paren
op_amp
id|cpu_counter
)paren
)paren
(brace
id|cpu_relax
c_func
(paren
)paren
suffix:semicolon
id|barrier
c_func
(paren
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;...&quot;
)paren
suffix:semicolon
id|set_cpus_allowed
c_func
(paren
id|current
comma
id|oldmask
)paren
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;ok&bslash;n&quot;
)paren
suffix:semicolon
)brace
eof
