multiline_comment|/* CPU control.&n; * (C) 2001, 2002, 2003, 2004 Rusty Russell&n; *&n; * This code is licenced under the GPL.&n; */
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/smp.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/notifier.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/unistd.h&gt;
macro_line|#include &lt;linux/cpu.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kmod.h&gt;&t;&t;/* for hotplug_path */
macro_line|#include &lt;linux/kthread.h&gt;
macro_line|#include &lt;linux/stop_machine.h&gt;
macro_line|#include &lt;asm/semaphore.h&gt;
multiline_comment|/* This protects CPUs going up and down... */
DECL|variable|cpucontrol
id|DECLARE_MUTEX
c_func
(paren
id|cpucontrol
)paren
suffix:semicolon
DECL|variable|cpu_chain
r_static
r_struct
id|notifier_block
op_star
id|cpu_chain
suffix:semicolon
multiline_comment|/* Need to know about CPUs going up/down? */
DECL|function|register_cpu_notifier
r_int
id|register_cpu_notifier
c_func
(paren
r_struct
id|notifier_block
op_star
id|nb
)paren
(brace
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|down_interruptible
c_func
(paren
op_amp
id|cpucontrol
)paren
)paren
op_ne
l_int|0
)paren
r_return
id|ret
suffix:semicolon
id|ret
op_assign
id|notifier_chain_register
c_func
(paren
op_amp
id|cpu_chain
comma
id|nb
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|cpucontrol
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|variable|register_cpu_notifier
id|EXPORT_SYMBOL
c_func
(paren
id|register_cpu_notifier
)paren
suffix:semicolon
DECL|function|unregister_cpu_notifier
r_void
id|unregister_cpu_notifier
c_func
(paren
r_struct
id|notifier_block
op_star
id|nb
)paren
(brace
id|down
c_func
(paren
op_amp
id|cpucontrol
)paren
suffix:semicolon
id|notifier_chain_unregister
c_func
(paren
op_amp
id|cpu_chain
comma
id|nb
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|cpucontrol
)paren
suffix:semicolon
)brace
DECL|variable|unregister_cpu_notifier
id|EXPORT_SYMBOL
c_func
(paren
id|unregister_cpu_notifier
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_HOTPLUG_CPU
DECL|function|check_for_tasks
r_static
r_inline
r_void
id|check_for_tasks
c_func
(paren
r_int
id|cpu
)paren
(brace
r_struct
id|task_struct
op_star
id|p
suffix:semicolon
id|write_lock_irq
c_func
(paren
op_amp
id|tasklist_lock
)paren
suffix:semicolon
id|for_each_process
c_func
(paren
id|p
)paren
(brace
r_if
c_cond
(paren
id|task_cpu
c_func
(paren
id|p
)paren
op_eq
id|cpu
op_logical_and
(paren
id|p-&gt;utime
op_ne
l_int|0
op_logical_or
id|p-&gt;stime
op_ne
l_int|0
)paren
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Task %s (pid = %d) is on cpu %d&bslash;&n;&t;&t;&t;&t;(state = %ld, flags = %lx) &bslash;n&quot;
comma
id|p-&gt;comm
comma
id|p-&gt;pid
comma
id|cpu
comma
id|p-&gt;state
comma
id|p-&gt;flags
)paren
suffix:semicolon
)brace
id|write_unlock_irq
c_func
(paren
op_amp
id|tasklist_lock
)paren
suffix:semicolon
)brace
multiline_comment|/* Take this CPU down. */
DECL|function|take_cpu_down
r_static
r_int
id|take_cpu_down
c_func
(paren
r_void
op_star
id|unused
)paren
(brace
r_int
id|err
suffix:semicolon
multiline_comment|/* Take offline: makes arch_cpu_down somewhat easier. */
id|cpu_clear
c_func
(paren
id|smp_processor_id
c_func
(paren
)paren
comma
id|cpu_online_map
)paren
suffix:semicolon
multiline_comment|/* Ensure this CPU doesn&squot;t handle any more interrupts. */
id|err
op_assign
id|__cpu_disable
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
id|cpu_set
c_func
(paren
id|smp_processor_id
c_func
(paren
)paren
comma
id|cpu_online_map
)paren
suffix:semicolon
r_else
multiline_comment|/* Force idle task to run as soon as we yield: it should&n;&t;&t;   immediately notice cpu is offline and die quickly. */
id|sched_idle_next
c_func
(paren
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|cpu_down
r_int
id|cpu_down
c_func
(paren
r_int
r_int
id|cpu
)paren
(brace
r_int
id|err
suffix:semicolon
r_struct
id|task_struct
op_star
id|p
suffix:semicolon
id|cpumask_t
id|old_allowed
comma
id|tmp
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|lock_cpu_hotplug_interruptible
c_func
(paren
)paren
)paren
op_ne
l_int|0
)paren
r_return
id|err
suffix:semicolon
r_if
c_cond
(paren
id|num_online_cpus
c_func
(paren
)paren
op_eq
l_int|1
)paren
(brace
id|err
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|cpu_online
c_func
(paren
id|cpu
)paren
)paren
(brace
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|err
op_assign
id|notifier_call_chain
c_func
(paren
op_amp
id|cpu_chain
comma
id|CPU_DOWN_PREPARE
comma
(paren
r_void
op_star
)paren
(paren
r_int
)paren
id|cpu
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_eq
id|NOTIFY_BAD
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: attempt to take down CPU %u failed&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|cpu
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* Ensure that we are not runnable on dying cpu */
id|old_allowed
op_assign
id|current-&gt;cpus_allowed
suffix:semicolon
id|tmp
op_assign
id|CPU_MASK_ALL
suffix:semicolon
id|cpu_clear
c_func
(paren
id|cpu
comma
id|tmp
)paren
suffix:semicolon
id|set_cpus_allowed
c_func
(paren
id|current
comma
id|tmp
)paren
suffix:semicolon
id|p
op_assign
id|__stop_machine_run
c_func
(paren
id|take_cpu_down
comma
l_int|NULL
comma
id|cpu
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|p
)paren
)paren
(brace
multiline_comment|/* CPU didn&squot;t die: tell everyone.  Can&squot;t complain. */
r_if
c_cond
(paren
id|notifier_call_chain
c_func
(paren
op_amp
id|cpu_chain
comma
id|CPU_DOWN_FAILED
comma
(paren
r_void
op_star
)paren
(paren
r_int
)paren
id|cpu
)paren
op_eq
id|NOTIFY_BAD
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
id|err
op_assign
id|PTR_ERR
c_func
(paren
id|p
)paren
suffix:semicolon
r_goto
id|out_allowed
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cpu_online
c_func
(paren
id|cpu
)paren
)paren
r_goto
id|out_thread
suffix:semicolon
multiline_comment|/* Wait for it to sleep (leaving idle task). */
r_while
c_loop
(paren
op_logical_neg
id|idle_cpu
c_func
(paren
id|cpu
)paren
)paren
id|yield
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* This actually kills the CPU. */
id|__cpu_die
c_func
(paren
id|cpu
)paren
suffix:semicolon
multiline_comment|/* Move it here so it can run. */
id|kthread_bind
c_func
(paren
id|p
comma
id|smp_processor_id
c_func
(paren
)paren
)paren
suffix:semicolon
multiline_comment|/* CPU is completely dead: tell everyone.  Too late to complain. */
r_if
c_cond
(paren
id|notifier_call_chain
c_func
(paren
op_amp
id|cpu_chain
comma
id|CPU_DEAD
comma
(paren
r_void
op_star
)paren
(paren
r_int
)paren
id|cpu
)paren
op_eq
id|NOTIFY_BAD
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
id|check_for_tasks
c_func
(paren
id|cpu
)paren
suffix:semicolon
id|out_thread
suffix:colon
id|err
op_assign
id|kthread_stop
c_func
(paren
id|p
)paren
suffix:semicolon
id|out_allowed
suffix:colon
id|set_cpus_allowed
c_func
(paren
id|current
comma
id|old_allowed
)paren
suffix:semicolon
id|out
suffix:colon
id|unlock_cpu_hotplug
c_func
(paren
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
macro_line|#endif /*CONFIG_HOTPLUG_CPU*/
DECL|function|cpu_up
r_int
id|__devinit
id|cpu_up
c_func
(paren
r_int
r_int
id|cpu
)paren
(brace
r_int
id|ret
suffix:semicolon
r_void
op_star
id|hcpu
op_assign
(paren
r_void
op_star
)paren
(paren
r_int
)paren
id|cpu
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|down_interruptible
c_func
(paren
op_amp
id|cpucontrol
)paren
)paren
op_ne
l_int|0
)paren
r_return
id|ret
suffix:semicolon
r_if
c_cond
(paren
id|cpu_online
c_func
(paren
id|cpu
)paren
op_logical_or
op_logical_neg
id|cpu_present
c_func
(paren
id|cpu
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|ret
op_assign
id|notifier_call_chain
c_func
(paren
op_amp
id|cpu_chain
comma
id|CPU_UP_PREPARE
comma
id|hcpu
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
id|NOTIFY_BAD
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: attempt to bring up CPU %u failed&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|cpu
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|out_notify
suffix:semicolon
)brace
multiline_comment|/* Arch-specific enabling code. */
id|ret
op_assign
id|__cpu_up
c_func
(paren
id|cpu
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ne
l_int|0
)paren
r_goto
id|out_notify
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cpu_online
c_func
(paren
id|cpu
)paren
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Now call notifier in preparation. */
id|notifier_call_chain
c_func
(paren
op_amp
id|cpu_chain
comma
id|CPU_ONLINE
comma
id|hcpu
)paren
suffix:semicolon
id|out_notify
suffix:colon
r_if
c_cond
(paren
id|ret
op_ne
l_int|0
)paren
id|notifier_call_chain
c_func
(paren
op_amp
id|cpu_chain
comma
id|CPU_UP_CANCELED
comma
id|hcpu
)paren
suffix:semicolon
id|out
suffix:colon
id|up
c_func
(paren
op_amp
id|cpucontrol
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
eof
