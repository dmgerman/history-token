multiline_comment|/* unaligned.h: unaligned access handler&n; *&n; * Copyright (C) 2004 Red Hat, Inc. All Rights Reserved.&n; * Written by David Howells (dhowells@redhat.com)&n; *&n; * This program is free software; you can redistribute it and/or&n; * modify it under the terms of the GNU General Public License&n; * as published by the Free Software Foundation; either version&n; * 2 of the License, or (at your option) any later version.&n; */
macro_line|#ifndef _ASM_UNALIGNED_H
DECL|macro|_ASM_UNALIGNED_H
mdefine_line|#define _ASM_UNALIGNED_H
macro_line|#include &lt;linux/config.h&gt;
multiline_comment|/*&n; * Unaligned accesses on uClinux can&squot;t be performed in a fault handler - the&n; * CPU detects them as imprecise exceptions making this impossible.&n; *&n; * With the FR451, however, they are precise, and so we used to fix them up in&n; * the memory access fault handler.  However, instruction bundling make this&n; * impractical.  So, now we fall back to using memcpy.&n; */
macro_line|#ifdef CONFIG_MMU
multiline_comment|/*&n; * The asm statement in the macros below is a way to get GCC to copy a&n; * value from one variable to another without having any clue it&squot;s&n; * actually doing so, so that it won&squot;t have any idea that the values&n; * in the two variables are related.&n; */
DECL|macro|get_unaligned
mdefine_line|#define get_unaligned(ptr) ({&t;&t;&t;&t;&bslash;&n;&t;typeof((*(ptr))) __x;&t;&t;&t;&t;&bslash;&n;&t;void *__ptrcopy;&t;&t;&t;&t;&bslash;&n;&t;asm(&quot;&quot; : &quot;=r&quot; (__ptrcopy) : &quot;0&quot; (ptr));&t;&t;&bslash;&n;&t;memcpy(&amp;__x, __ptrcopy, sizeof(*(ptr)));&t;&bslash;&n;&t;__x;&t;&t;&t;&t;&t;&t;&bslash;&n;})
DECL|macro|put_unaligned
mdefine_line|#define put_unaligned(val, ptr) ({&t;&t;&t;&bslash;&n;&t;typeof((*(ptr))) __x = (val);&t;&t;&t;&bslash;&n;&t;void *__ptrcopy;&t;&t;&t;&t;&bslash;&n;&t;asm(&quot;&quot; : &quot;=r&quot; (__ptrcopy) : &quot;0&quot; (ptr));&t;&t;&bslash;&n;&t;memcpy(__ptrcopy, &amp;__x, sizeof(*(ptr)));&t;&bslash;&n;})
r_extern
r_int
id|handle_misalignment
c_func
(paren
r_int
r_int
id|esr0
comma
r_int
r_int
id|ear0
comma
r_int
r_int
id|epcr0
)paren
suffix:semicolon
macro_line|#else
DECL|macro|get_unaligned
mdefine_line|#define get_unaligned(ptr)&t;&t;&t;&t;&t;&t;&t;&bslash;&n;({&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;typeof(*(ptr)) x;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;const char *__p = (const char *) (ptr);&t;&t;&t;&t;&t;&bslash;&n;&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;switch (sizeof(x)) {&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;case 1:&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;&t;x = *(ptr);&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;&t;break;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;case 2:&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;{&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;&t;uint8_t a;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;&t;asm(&quot;&t;ldub%I2&t;&t;%M2,%0&t;&t;&bslash;n&quot;&t;&t;&t;&bslash;&n;&t;&t;    &quot;&t;ldub%I3.p&t;%M3,%1&t;&t;&bslash;n&quot;&t;&t;&t;&bslash;&n;&t;&t;    &quot;&t;slli&t;&t;%0,#8,%0&t;&bslash;n&quot;&t;&t;&t;&bslash;&n;&t;&t;    &quot;&t;or&t;&t;%0,%1,%0&t;&bslash;n&quot;&t;&t;&t;&bslash;&n;&t;&t;    : &quot;=&amp;r&quot;(x), &quot;=&amp;r&quot;(a)&t;&t;&t;&t;&t;&bslash;&n;&t;&t;    : &quot;m&quot;(__p[0]),  &quot;m&quot;(__p[1])&t;&t;&t;&t;&t;&bslash;&n;&t;&t;    );&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;&t;break;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;}&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;case 4:&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;{&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;&t;uint8_t a;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;&t;asm(&quot;&t;ldub%I2&t;&t;%M2,%0&t;&t;&bslash;n&quot;&t;&t;&t;&bslash;&n;&t;&t;    &quot;&t;ldub%I3.p&t;%M3,%1&t;&t;&bslash;n&quot;&t;&t;&t;&bslash;&n;&t;&t;    &quot;&t;slli&t;&t;%0,#8,%0&t;&bslash;n&quot;&t;&t;&t;&bslash;&n;&t;&t;    &quot;&t;or&t;&t;%0,%1,%0&t;&bslash;n&quot;&t;&t;&t;&bslash;&n;&t;&t;    &quot;&t;ldub%I4.p&t;%M4,%1&t;&t;&bslash;n&quot;&t;&t;&t;&bslash;&n;&t;&t;    &quot;&t;slli&t;&t;%0,#8,%0&t;&bslash;n&quot;&t;&t;&t;&bslash;&n;&t;&t;    &quot;&t;or&t;&t;%0,%1,%0&t;&bslash;n&quot;&t;&t;&t;&bslash;&n;&t;&t;    &quot;&t;ldub%I5.p&t;%M5,%1&t;&t;&bslash;n&quot;&t;&t;&t;&bslash;&n;&t;&t;    &quot;&t;slli&t;&t;%0,#8,%0&t;&bslash;n&quot;&t;&t;&t;&bslash;&n;&t;&t;    &quot;&t;or&t;&t;%0,%1,%0&t;&bslash;n&quot;&t;&t;&t;&bslash;&n;&t;&t;    : &quot;=&amp;r&quot;(x), &quot;=&amp;r&quot;(a)&t;&t;&t;&t;&t;&bslash;&n;&t;&t;    : &quot;m&quot;(__p[0]),  &quot;m&quot;(__p[1]), &quot;m&quot;(__p[2]), &quot;m&quot;(__p[3])&t;&bslash;&n;&t;&t;    );&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;&t;break;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;}&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;case 8:&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;{&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;&t;union { uint64_t x; u32 y[2]; } z;&t;&t;&t;&t;&bslash;&n;&t;&t;uint8_t a;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;&t;asm(&quot;&t;ldub%I3&t;&t;%M3,%0&t;&t;&bslash;n&quot;&t;&t;&t;&bslash;&n;&t;&t;    &quot;&t;ldub%I4.p&t;%M4,%2&t;&t;&bslash;n&quot;&t;&t;&t;&bslash;&n;&t;&t;    &quot;&t;slli&t;&t;%0,#8,%0&t;&bslash;n&quot;&t;&t;&t;&bslash;&n;&t;&t;    &quot;&t;or&t;&t;%0,%2,%0&t;&bslash;n&quot;&t;&t;&t;&bslash;&n;&t;&t;    &quot;&t;ldub%I5.p&t;%M5,%2&t;&t;&bslash;n&quot;&t;&t;&t;&bslash;&n;&t;&t;    &quot;&t;slli&t;&t;%0,#8,%0&t;&bslash;n&quot;&t;&t;&t;&bslash;&n;&t;&t;    &quot;&t;or&t;&t;%0,%2,%0&t;&bslash;n&quot;&t;&t;&t;&bslash;&n;&t;&t;    &quot;&t;ldub%I6.p&t;%M6,%2&t;&t;&bslash;n&quot;&t;&t;&t;&bslash;&n;&t;&t;    &quot;&t;slli&t;&t;%0,#8,%0&t;&bslash;n&quot;&t;&t;&t;&bslash;&n;&t;&t;    &quot;&t;or&t;&t;%0,%2,%0&t;&bslash;n&quot;&t;&t;&t;&bslash;&n;&t;&t;    &quot;&t;ldub%I7&t;&t;%M7,%1&t;&t;&bslash;n&quot;&t;&t;&t;&bslash;&n;&t;&t;    &quot;&t;ldub%I8.p&t;%M8,%2&t;&t;&bslash;n&quot;&t;&t;&t;&bslash;&n;&t;&t;    &quot;&t;slli&t;&t;%1,#8,%1&t;&bslash;n&quot;&t;&t;&t;&bslash;&n;&t;&t;    &quot;&t;or&t;&t;%1,%2,%1&t;&bslash;n&quot;&t;&t;&t;&bslash;&n;&t;&t;    &quot;&t;ldub%I9.p&t;%M9,%2&t;&t;&bslash;n&quot;&t;&t;&t;&bslash;&n;&t;&t;    &quot;&t;slli&t;&t;%1,#8,%1&t;&bslash;n&quot;&t;&t;&t;&bslash;&n;&t;&t;    &quot;&t;or&t;&t;%1,%2,%1&t;&bslash;n&quot;&t;&t;&t;&bslash;&n;&t;&t;    &quot;&t;ldub%I10.p&t;%M10,%2&t;&t;&bslash;n&quot;&t;&t;&t;&bslash;&n;&t;&t;    &quot;&t;slli&t;&t;%1,#8,%1&t;&bslash;n&quot;&t;&t;&t;&bslash;&n;&t;&t;    &quot;&t;or&t;&t;%1,%2,%1&t;&bslash;n&quot;&t;&t;&t;&bslash;&n;&t;&t;    : &quot;=&amp;r&quot;(z.y[0]), &quot;=&amp;r&quot;(z.y[1]), &quot;=&amp;r&quot;(a)&t;&t;&t;&bslash;&n;&t;&t;    : &quot;m&quot;(__p[0]), &quot;m&quot;(__p[1]), &quot;m&quot;(__p[2]), &quot;m&quot;(__p[3]),&t;&bslash;&n;&t;&t;      &quot;m&quot;(__p[4]), &quot;m&quot;(__p[5]), &quot;m&quot;(__p[6]), &quot;m&quot;(__p[7])&t;&bslash;&n;&t;&t;    );&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;&t;x = z.x;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;&t;break;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;}&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;default:&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;&t;x = 0;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;&t;BUG();&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;&t;break;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;}&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;x;&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;})
DECL|macro|put_unaligned
mdefine_line|#define put_unaligned(val, ptr)&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;do {&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;char *__p = (char *) (ptr);&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;int x;&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;switch (sizeof(*ptr)) {&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;case 2:&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;{&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;&t;asm(&quot;&t;stb%I1.p&t;%0,%M1&t;&t;&bslash;n&quot;&t;&t;&t;&t;&bslash;&n;&t;&t;    &quot;&t;srli&t;&t;%0,#8,%0&t;&bslash;n&quot;&t;&t;&t;&t;&bslash;&n;&t;&t;    &quot;&t;stb%I2&t;&t;%0,%M2&t;&t;&bslash;n&quot;&t;&t;&t;&t;&bslash;&n;&t;&t;    : &quot;=r&quot;(x), &quot;=m&quot;(__p[1]),  &quot;=m&quot;(__p[0])&t;&t;&t;&t;&bslash;&n;&t;&t;    : &quot;0&quot;(val)&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;&t;    );&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;&t;break;&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;}&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;case 4:&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;{&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;&t;asm(&quot;&t;stb%I1.p&t;%0,%M1&t;&t;&bslash;n&quot;&t;&t;&t;&t;&bslash;&n;&t;&t;    &quot;&t;srli&t;&t;%0,#8,%0&t;&bslash;n&quot;&t;&t;&t;&t;&bslash;&n;&t;&t;    &quot;&t;stb%I2.p&t;%0,%M2&t;&t;&bslash;n&quot;&t;&t;&t;&t;&bslash;&n;&t;&t;    &quot;&t;srli&t;&t;%0,#8,%0&t;&bslash;n&quot;&t;&t;&t;&t;&bslash;&n;&t;&t;    &quot;&t;stb%I3.p&t;%0,%M3&t;&t;&bslash;n&quot;&t;&t;&t;&t;&bslash;&n;&t;&t;    &quot;&t;srli&t;&t;%0,#8,%0&t;&bslash;n&quot;&t;&t;&t;&t;&bslash;&n;&t;&t;    &quot;&t;stb%I4&t;&t;%0,%M4&t;&t;&bslash;n&quot;&t;&t;&t;&t;&bslash;&n;&t;&t;    : &quot;=r&quot;(x), &quot;=m&quot;(__p[3]),  &quot;=m&quot;(__p[2]), &quot;=m&quot;(__p[1]), &quot;=m&quot;(__p[0])&t;&bslash;&n;&t;&t;    : &quot;0&quot;(val)&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;&t;    );&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;&t;break;&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;}&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;case 8:&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;{&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;&t;uint32_t __high, __low;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;&t;__high = (uint64_t)val &gt;&gt; 32;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;&t;__low = val &amp; 0xffffffff;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;&t;asm(&quot;&t;stb%I2.p&t;%0,%M2&t;&t;&bslash;n&quot;&t;&t;&t;&t;&bslash;&n;&t;&t;    &quot;&t;srli&t;&t;%0,#8,%0&t;&bslash;n&quot;&t;&t;&t;&t;&bslash;&n;&t;&t;    &quot;&t;stb%I3.p&t;%0,%M3&t;&t;&bslash;n&quot;&t;&t;&t;&t;&bslash;&n;&t;&t;    &quot;&t;srli&t;&t;%0,#8,%0&t;&bslash;n&quot;&t;&t;&t;&t;&bslash;&n;&t;&t;    &quot;&t;stb%I4.p&t;%0,%M4&t;&t;&bslash;n&quot;&t;&t;&t;&t;&bslash;&n;&t;&t;    &quot;&t;srli&t;&t;%0,#8,%0&t;&bslash;n&quot;&t;&t;&t;&t;&bslash;&n;&t;&t;    &quot;&t;stb%I5.p&t;%0,%M5&t;&t;&bslash;n&quot;&t;&t;&t;&t;&bslash;&n;&t;&t;    &quot;&t;srli&t;&t;%0,#8,%0&t;&bslash;n&quot;&t;&t;&t;&t;&bslash;&n;&t;&t;    &quot;&t;stb%I6.p&t;%1,%M6&t;&t;&bslash;n&quot;&t;&t;&t;&t;&bslash;&n;&t;&t;    &quot;&t;srli&t;&t;%1,#8,%1&t;&bslash;n&quot;&t;&t;&t;&t;&bslash;&n;&t;&t;    &quot;&t;stb%I7.p&t;%1,%M7&t;&t;&bslash;n&quot;&t;&t;&t;&t;&bslash;&n;&t;&t;    &quot;&t;srli&t;&t;%1,#8,%1&t;&bslash;n&quot;&t;&t;&t;&t;&bslash;&n;&t;&t;    &quot;&t;stb%I8.p&t;%1,%M8&t;&t;&bslash;n&quot;&t;&t;&t;&t;&bslash;&n;&t;&t;    &quot;&t;srli&t;&t;%1,#8,%1&t;&bslash;n&quot;&t;&t;&t;&t;&bslash;&n;&t;&t;    &quot;&t;stb%I9&t;&t;%1,%M9&t;&t;&bslash;n&quot;&t;&t;&t;&t;&bslash;&n;&t;&t;    : &quot;=&amp;r&quot;(__low), &quot;=&amp;r&quot;(__high), &quot;=m&quot;(__p[7]), &quot;=m&quot;(__p[6]), &t;&t;&bslash;&n;&t;&t;      &quot;=m&quot;(__p[5]), &quot;=m&quot;(__p[4]), &quot;=m&quot;(__p[3]), &quot;=m&quot;(__p[2]), &t;&t;&bslash;&n;&t;&t;      &quot;=m&quot;(__p[1]), &quot;=m&quot;(__p[0])&t;&t;&t;&t;&t;&bslash;&n;&t;&t;    : &quot;0&quot;(__low), &quot;1&quot;(__high)&t;&t;&t;&t;&t;&t;&bslash;&n;&t;&t;    );&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;&t;break;&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;}&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;        default:&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;&t;*(ptr) = (val);&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;&t;break;&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;&t;}&t;&t;&t;&t;&t;&t;&t;&t;&t;&t;&bslash;&n;} while(0)
macro_line|#endif
macro_line|#endif
eof
