multiline_comment|/* Hook for machine specific memory setup.&n; *&n; * This is included late in kernel/setup.c so that it can make use of all of&n; * the static functions. */
DECL|function|machine_specific_memory_setup
r_static
r_inline
r_char
op_star
id|__init
id|machine_specific_memory_setup
c_func
(paren
r_void
)paren
(brace
r_char
op_star
id|who
suffix:semicolon
id|who
op_assign
l_string|&quot;NOT VOYAGER&quot;
suffix:semicolon
r_if
c_cond
(paren
id|voyager_level
op_eq
l_int|5
)paren
(brace
id|__u32
id|addr
comma
id|length
suffix:semicolon
r_int
id|i
suffix:semicolon
id|who
op_assign
l_string|&quot;Voyager-SUS&quot;
suffix:semicolon
id|e820.nr_map
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|voyager_memory_detect
c_func
(paren
id|i
comma
op_amp
id|addr
comma
op_amp
id|length
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
id|add_memory_region
c_func
(paren
id|addr
comma
id|length
comma
id|E820_RAM
)paren
suffix:semicolon
)brace
r_return
id|who
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|voyager_level
op_eq
l_int|4
)paren
(brace
id|__u32
id|tom
suffix:semicolon
id|__u16
id|catbase
op_assign
id|inb
c_func
(paren
id|VOYAGER_SSPB_RELOCATION_PORT
)paren
op_lshift
l_int|8
suffix:semicolon
multiline_comment|/* select the DINO config space */
id|outb
c_func
(paren
id|VOYAGER_DINO
comma
id|VOYAGER_CAT_CONFIG_PORT
)paren
suffix:semicolon
multiline_comment|/* Read DINO top of memory register */
id|tom
op_assign
(paren
(paren
id|inb
c_func
(paren
id|catbase
op_plus
l_int|0x4
)paren
op_amp
l_int|0xf0
)paren
op_lshift
l_int|16
)paren
op_plus
(paren
(paren
id|inb
c_func
(paren
id|catbase
op_plus
l_int|0x5
)paren
op_amp
l_int|0x7f
)paren
op_lshift
l_int|24
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inb
c_func
(paren
id|catbase
)paren
op_ne
id|VOYAGER_DINO
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Voyager: Failed to get DINO for L4, setting tom to EXT_MEM_K&bslash;n&quot;
)paren
suffix:semicolon
id|tom
op_assign
(paren
id|EXT_MEM_K
)paren
op_lshift
l_int|10
suffix:semicolon
)brace
id|who
op_assign
l_string|&quot;Voyager-TOM&quot;
suffix:semicolon
id|add_memory_region
c_func
(paren
l_int|0
comma
l_int|0x9f000
comma
id|E820_RAM
)paren
suffix:semicolon
multiline_comment|/* map from 1M to top of memory */
id|add_memory_region
c_func
(paren
l_int|1
op_star
l_int|1024
op_star
l_int|1024
comma
id|tom
op_minus
l_int|1
op_star
l_int|1024
op_star
l_int|1024
comma
id|E820_RAM
)paren
suffix:semicolon
multiline_comment|/* FIXME: Should check the ASICs to see if I need to&n;&t;&t; * take out the 8M window.  Just do it at the moment&n;&t;&t; * */
id|add_memory_region
c_func
(paren
l_int|8
op_star
l_int|1024
op_star
l_int|1024
comma
l_int|8
op_star
l_int|1024
op_star
l_int|1024
comma
id|E820_RESERVED
)paren
suffix:semicolon
r_return
id|who
suffix:semicolon
)brace
id|who
op_assign
l_string|&quot;BIOS-e820&quot;
suffix:semicolon
multiline_comment|/*&n;&t; * Try to copy the BIOS-supplied E820-map.&n;&t; *&n;&t; * Otherwise fake a memory map; one section from 0k-&gt;640k,&n;&t; * the next section from 1mb-&gt;appropriate_mem_k&n;&t; */
id|sanitize_e820_map
c_func
(paren
id|E820_MAP
comma
op_amp
id|E820_MAP_NR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_e820_map
c_func
(paren
id|E820_MAP
comma
id|E820_MAP_NR
)paren
OL
l_int|0
)paren
(brace
r_int
r_int
id|mem_size
suffix:semicolon
multiline_comment|/* compare results from other methods and take the greater */
r_if
c_cond
(paren
id|ALT_MEM_K
OL
id|EXT_MEM_K
)paren
(brace
id|mem_size
op_assign
id|EXT_MEM_K
suffix:semicolon
id|who
op_assign
l_string|&quot;BIOS-88&quot;
suffix:semicolon
)brace
r_else
(brace
id|mem_size
op_assign
id|ALT_MEM_K
suffix:semicolon
id|who
op_assign
l_string|&quot;BIOS-e801&quot;
suffix:semicolon
)brace
id|e820.nr_map
op_assign
l_int|0
suffix:semicolon
id|add_memory_region
c_func
(paren
l_int|0
comma
id|LOWMEMSIZE
c_func
(paren
)paren
comma
id|E820_RAM
)paren
suffix:semicolon
id|add_memory_region
c_func
(paren
id|HIGH_MEMORY
comma
id|mem_size
op_lshift
l_int|10
comma
id|E820_RAM
)paren
suffix:semicolon
)brace
r_return
id|who
suffix:semicolon
)brace
eof
