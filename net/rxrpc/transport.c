multiline_comment|/* transport.c: Rx Transport routines&n; *&n; * Copyright (C) 2002 Red Hat, Inc. All Rights Reserved.&n; * Written by David Howells (dhowells@redhat.com)&n; *&n; * This program is free software; you can redistribute it and/or&n; * modify it under the terms of the GNU General Public License&n; * as published by the Free Software Foundation; either version&n; * 2 of the License, or (at your option) any later version.&n; */
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;rxrpc/transport.h&gt;
macro_line|#include &lt;rxrpc/peer.h&gt;
macro_line|#include &lt;rxrpc/connection.h&gt;
macro_line|#include &lt;rxrpc/call.h&gt;
macro_line|#include &lt;rxrpc/message.h&gt;
macro_line|#include &lt;rxrpc/krxiod.h&gt;
macro_line|#include &lt;rxrpc/krxsecd.h&gt;
macro_line|#include &lt;linux/udp.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/in6.h&gt;
macro_line|#include &lt;linux/icmp.h&gt;
macro_line|#include &lt;net/sock.h&gt;
macro_line|#include &lt;net/ip.h&gt;
macro_line|#if defined(CONFIG_IPV6) || defined (CONFIG_IPV6_MODULE)
macro_line|#include &lt;linux/ipv6.h&gt;&t;/* this should _really_ be in errqueue.h.. */
macro_line|#endif
macro_line|#include &lt;linux/errqueue.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/checksum.h&gt;
macro_line|#include &quot;internal.h&quot;
DECL|struct|errormsg
r_struct
id|errormsg
(brace
DECL|member|cmsg
r_struct
id|cmsghdr
id|cmsg
suffix:semicolon
multiline_comment|/* control message header */
DECL|member|ee
r_struct
id|sock_extended_err
id|ee
suffix:semicolon
multiline_comment|/* extended error information */
DECL|member|icmp_src
r_struct
id|sockaddr_in
id|icmp_src
suffix:semicolon
multiline_comment|/* ICMP packet source address */
)brace
suffix:semicolon
r_static
id|DEFINE_SPINLOCK
c_func
(paren
id|rxrpc_transports_lock
)paren
suffix:semicolon
DECL|variable|rxrpc_transports
r_static
r_struct
id|list_head
id|rxrpc_transports
op_assign
id|LIST_HEAD_INIT
c_func
(paren
id|rxrpc_transports
)paren
suffix:semicolon
DECL|variable|rxrpc_transport_count
id|__RXACCT_DECL
c_func
(paren
id|atomic_t
id|rxrpc_transport_count
)paren
suffix:semicolon
DECL|variable|rxrpc_proc_transports
id|LIST_HEAD
c_func
(paren
id|rxrpc_proc_transports
)paren
suffix:semicolon
DECL|variable|rxrpc_proc_transports_sem
id|DECLARE_RWSEM
c_func
(paren
id|rxrpc_proc_transports_sem
)paren
suffix:semicolon
r_static
r_void
id|rxrpc_data_ready
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_int
id|count
)paren
suffix:semicolon
r_static
r_void
id|rxrpc_error_report
c_func
(paren
r_struct
id|sock
op_star
id|sk
)paren
suffix:semicolon
r_static
r_int
id|rxrpc_trans_receive_new_call
c_func
(paren
r_struct
id|rxrpc_transport
op_star
id|trans
comma
r_struct
id|list_head
op_star
id|msgq
)paren
suffix:semicolon
r_static
r_void
id|rxrpc_trans_receive_error_report
c_func
(paren
r_struct
id|rxrpc_transport
op_star
id|trans
)paren
suffix:semicolon
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * create a new transport endpoint using the specified UDP port&n; */
DECL|function|rxrpc_create_transport
r_int
id|rxrpc_create_transport
c_func
(paren
r_int
r_int
id|port
comma
r_struct
id|rxrpc_transport
op_star
op_star
id|_trans
)paren
(brace
r_struct
id|rxrpc_transport
op_star
id|trans
suffix:semicolon
r_struct
id|sockaddr_in
id|sin
suffix:semicolon
id|mm_segment_t
id|oldfs
suffix:semicolon
r_struct
id|sock
op_star
id|sock
suffix:semicolon
r_int
id|ret
comma
id|opt
suffix:semicolon
id|_enter
c_func
(paren
l_string|&quot;%hu&quot;
comma
id|port
)paren
suffix:semicolon
id|trans
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|rxrpc_transport
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|trans
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|trans
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|rxrpc_transport
)paren
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|trans-&gt;usage
comma
l_int|1
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|trans-&gt;services
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|trans-&gt;link
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|trans-&gt;krxiodq_link
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|trans-&gt;lock
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|trans-&gt;peer_active
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|trans-&gt;peer_graveyard
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|trans-&gt;peer_gylock
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|trans-&gt;peer_gy_waitq
)paren
suffix:semicolon
id|rwlock_init
c_func
(paren
op_amp
id|trans-&gt;peer_lock
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|trans-&gt;peer_count
comma
l_int|0
)paren
suffix:semicolon
id|trans-&gt;port
op_assign
id|port
suffix:semicolon
multiline_comment|/* create a UDP socket to be my actual transport endpoint */
id|ret
op_assign
id|sock_create_kern
c_func
(paren
id|PF_INET
comma
id|SOCK_DGRAM
comma
id|IPPROTO_UDP
comma
op_amp
id|trans-&gt;socket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
r_goto
id|error
suffix:semicolon
multiline_comment|/* use the specified port */
r_if
c_cond
(paren
id|port
)paren
(brace
id|memset
c_func
(paren
op_amp
id|sin
comma
l_int|0
comma
r_sizeof
(paren
id|sin
)paren
)paren
suffix:semicolon
id|sin.sin_family
op_assign
id|AF_INET
suffix:semicolon
id|sin.sin_port
op_assign
id|htons
c_func
(paren
id|port
)paren
suffix:semicolon
id|ret
op_assign
id|trans-&gt;socket-&gt;ops
op_member_access_from_pointer
id|bind
c_func
(paren
id|trans-&gt;socket
comma
(paren
r_struct
id|sockaddr
op_star
)paren
op_amp
id|sin
comma
r_sizeof
(paren
id|sin
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
r_goto
id|error
suffix:semicolon
)brace
id|opt
op_assign
l_int|1
suffix:semicolon
id|oldfs
op_assign
id|get_fs
c_func
(paren
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|KERNEL_DS
)paren
suffix:semicolon
id|ret
op_assign
id|trans-&gt;socket-&gt;ops
op_member_access_from_pointer
id|setsockopt
c_func
(paren
id|trans-&gt;socket
comma
id|SOL_IP
comma
id|IP_RECVERR
comma
(paren
r_char
op_star
)paren
op_amp
id|opt
comma
r_sizeof
(paren
id|opt
)paren
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|oldfs
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|rxrpc_transports_lock
)paren
suffix:semicolon
id|list_add
c_func
(paren
op_amp
id|trans-&gt;link
comma
op_amp
id|rxrpc_transports
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|rxrpc_transports_lock
)paren
suffix:semicolon
multiline_comment|/* set the socket up */
id|sock
op_assign
id|trans-&gt;socket-&gt;sk
suffix:semicolon
id|sock-&gt;sk_user_data
op_assign
id|trans
suffix:semicolon
id|sock-&gt;sk_data_ready
op_assign
id|rxrpc_data_ready
suffix:semicolon
id|sock-&gt;sk_error_report
op_assign
id|rxrpc_error_report
suffix:semicolon
id|down_write
c_func
(paren
op_amp
id|rxrpc_proc_transports_sem
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|trans-&gt;proc_link
comma
op_amp
id|rxrpc_proc_transports
)paren
suffix:semicolon
id|up_write
c_func
(paren
op_amp
id|rxrpc_proc_transports_sem
)paren
suffix:semicolon
id|__RXACCT
c_func
(paren
id|atomic_inc
c_func
(paren
op_amp
id|rxrpc_transport_count
)paren
)paren
suffix:semicolon
op_star
id|_trans
op_assign
id|trans
suffix:semicolon
id|_leave
c_func
(paren
l_string|&quot; = 0 (%p)&quot;
comma
id|trans
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|error
suffix:colon
multiline_comment|/* finish cleaning up the transport (not really needed here, but...) */
r_if
c_cond
(paren
id|trans-&gt;socket
)paren
id|trans-&gt;socket-&gt;ops
op_member_access_from_pointer
id|shutdown
c_func
(paren
id|trans-&gt;socket
comma
l_int|2
)paren
suffix:semicolon
multiline_comment|/* close the socket */
r_if
c_cond
(paren
id|trans-&gt;socket
)paren
(brace
id|trans-&gt;socket-&gt;sk-&gt;sk_user_data
op_assign
l_int|NULL
suffix:semicolon
id|sock_release
c_func
(paren
id|trans-&gt;socket
)paren
suffix:semicolon
id|trans-&gt;socket
op_assign
l_int|NULL
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|trans
)paren
suffix:semicolon
id|_leave
c_func
(paren
l_string|&quot; = %d&quot;
comma
id|ret
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* end rxrpc_create_transport() */
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * destroy a transport endpoint&n; */
DECL|function|rxrpc_put_transport
r_void
id|rxrpc_put_transport
c_func
(paren
r_struct
id|rxrpc_transport
op_star
id|trans
)paren
(brace
id|_enter
c_func
(paren
l_string|&quot;%p{u=%d p=%hu}&quot;
comma
id|trans
comma
id|atomic_read
c_func
(paren
op_amp
id|trans-&gt;usage
)paren
comma
id|trans-&gt;port
)paren
suffix:semicolon
id|BUG_ON
c_func
(paren
id|atomic_read
c_func
(paren
op_amp
id|trans-&gt;usage
)paren
op_le
l_int|0
)paren
suffix:semicolon
multiline_comment|/* to prevent a race, the decrement and the dequeue must be&n;&t; * effectively atomic */
id|spin_lock
c_func
(paren
op_amp
id|rxrpc_transports_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|likely
c_func
(paren
op_logical_neg
id|atomic_dec_and_test
c_func
(paren
op_amp
id|trans-&gt;usage
)paren
)paren
)paren
(brace
id|spin_unlock
c_func
(paren
op_amp
id|rxrpc_transports_lock
)paren
suffix:semicolon
id|_leave
c_func
(paren
l_string|&quot;&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|list_del
c_func
(paren
op_amp
id|trans-&gt;link
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|rxrpc_transports_lock
)paren
suffix:semicolon
multiline_comment|/* finish cleaning up the transport */
r_if
c_cond
(paren
id|trans-&gt;socket
)paren
id|trans-&gt;socket-&gt;ops
op_member_access_from_pointer
id|shutdown
c_func
(paren
id|trans-&gt;socket
comma
l_int|2
)paren
suffix:semicolon
id|rxrpc_krxsecd_clear_transport
c_func
(paren
id|trans
)paren
suffix:semicolon
id|rxrpc_krxiod_dequeue_transport
c_func
(paren
id|trans
)paren
suffix:semicolon
multiline_comment|/* discard all peer information */
id|rxrpc_peer_clearall
c_func
(paren
id|trans
)paren
suffix:semicolon
id|down_write
c_func
(paren
op_amp
id|rxrpc_proc_transports_sem
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|trans-&gt;proc_link
)paren
suffix:semicolon
id|up_write
c_func
(paren
op_amp
id|rxrpc_proc_transports_sem
)paren
suffix:semicolon
id|__RXACCT
c_func
(paren
id|atomic_dec
c_func
(paren
op_amp
id|rxrpc_transport_count
)paren
)paren
suffix:semicolon
multiline_comment|/* close the socket */
r_if
c_cond
(paren
id|trans-&gt;socket
)paren
(brace
id|trans-&gt;socket-&gt;sk-&gt;sk_user_data
op_assign
l_int|NULL
suffix:semicolon
id|sock_release
c_func
(paren
id|trans-&gt;socket
)paren
suffix:semicolon
id|trans-&gt;socket
op_assign
l_int|NULL
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|trans
)paren
suffix:semicolon
id|_leave
c_func
(paren
l_string|&quot;&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* end rxrpc_put_transport() */
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * add a service to a transport to be listened upon&n; */
DECL|function|rxrpc_add_service
r_int
id|rxrpc_add_service
c_func
(paren
r_struct
id|rxrpc_transport
op_star
id|trans
comma
r_struct
id|rxrpc_service
op_star
id|newsrv
)paren
(brace
r_struct
id|rxrpc_service
op_star
id|srv
suffix:semicolon
r_struct
id|list_head
op_star
id|_p
suffix:semicolon
r_int
id|ret
op_assign
op_minus
id|EEXIST
suffix:semicolon
id|_enter
c_func
(paren
l_string|&quot;%p{%hu},%p{%hu}&quot;
comma
id|trans
comma
id|trans-&gt;port
comma
id|newsrv
comma
id|newsrv-&gt;service_id
)paren
suffix:semicolon
multiline_comment|/* verify that the service ID is not already present */
id|spin_lock
c_func
(paren
op_amp
id|trans-&gt;lock
)paren
suffix:semicolon
id|list_for_each
c_func
(paren
id|_p
comma
op_amp
id|trans-&gt;services
)paren
(brace
id|srv
op_assign
id|list_entry
c_func
(paren
id|_p
comma
r_struct
id|rxrpc_service
comma
id|link
)paren
suffix:semicolon
r_if
c_cond
(paren
id|srv-&gt;service_id
op_eq
id|newsrv-&gt;service_id
)paren
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* okay - add the transport to the list */
id|list_add_tail
c_func
(paren
op_amp
id|newsrv-&gt;link
comma
op_amp
id|trans-&gt;services
)paren
suffix:semicolon
id|rxrpc_get_transport
c_func
(paren
id|trans
)paren
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
id|out
suffix:colon
id|spin_unlock
c_func
(paren
op_amp
id|trans-&gt;lock
)paren
suffix:semicolon
id|_leave
c_func
(paren
l_string|&quot;= %d&quot;
comma
id|ret
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* end rxrpc_add_service() */
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * remove a service from a transport&n; */
DECL|function|rxrpc_del_service
r_void
id|rxrpc_del_service
c_func
(paren
r_struct
id|rxrpc_transport
op_star
id|trans
comma
r_struct
id|rxrpc_service
op_star
id|srv
)paren
(brace
id|_enter
c_func
(paren
l_string|&quot;%p{%hu},%p{%hu}&quot;
comma
id|trans
comma
id|trans-&gt;port
comma
id|srv
comma
id|srv-&gt;service_id
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|trans-&gt;lock
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|srv-&gt;link
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|trans-&gt;lock
)paren
suffix:semicolon
id|rxrpc_put_transport
c_func
(paren
id|trans
)paren
suffix:semicolon
id|_leave
c_func
(paren
l_string|&quot;&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* end rxrpc_del_service() */
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * INET callback when data has been received on the socket.&n; */
DECL|function|rxrpc_data_ready
r_static
r_void
id|rxrpc_data_ready
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_int
id|count
)paren
(brace
r_struct
id|rxrpc_transport
op_star
id|trans
suffix:semicolon
id|_enter
c_func
(paren
l_string|&quot;%p{t=%p},%d&quot;
comma
id|sk
comma
id|sk-&gt;sk_user_data
comma
id|count
)paren
suffix:semicolon
multiline_comment|/* queue the transport for attention by krxiod */
id|trans
op_assign
(paren
r_struct
id|rxrpc_transport
op_star
)paren
id|sk-&gt;sk_user_data
suffix:semicolon
r_if
c_cond
(paren
id|trans
)paren
id|rxrpc_krxiod_queue_transport
c_func
(paren
id|trans
)paren
suffix:semicolon
multiline_comment|/* wake up anyone waiting on the socket */
r_if
c_cond
(paren
id|sk-&gt;sk_sleep
op_logical_and
id|waitqueue_active
c_func
(paren
id|sk-&gt;sk_sleep
)paren
)paren
id|wake_up_interruptible
c_func
(paren
id|sk-&gt;sk_sleep
)paren
suffix:semicolon
id|_leave
c_func
(paren
l_string|&quot;&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* end rxrpc_data_ready() */
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * INET callback when an ICMP error packet is received&n; * - sk-&gt;err is error (EHOSTUNREACH, EPROTO or EMSGSIZE)&n; */
DECL|function|rxrpc_error_report
r_static
r_void
id|rxrpc_error_report
c_func
(paren
r_struct
id|sock
op_star
id|sk
)paren
(brace
r_struct
id|rxrpc_transport
op_star
id|trans
suffix:semicolon
id|_enter
c_func
(paren
l_string|&quot;%p{t=%p}&quot;
comma
id|sk
comma
id|sk-&gt;sk_user_data
)paren
suffix:semicolon
multiline_comment|/* queue the transport for attention by krxiod */
id|trans
op_assign
(paren
r_struct
id|rxrpc_transport
op_star
)paren
id|sk-&gt;sk_user_data
suffix:semicolon
r_if
c_cond
(paren
id|trans
)paren
(brace
id|trans-&gt;error_rcvd
op_assign
l_int|1
suffix:semicolon
id|rxrpc_krxiod_queue_transport
c_func
(paren
id|trans
)paren
suffix:semicolon
)brace
multiline_comment|/* wake up anyone waiting on the socket */
r_if
c_cond
(paren
id|sk-&gt;sk_sleep
op_logical_and
id|waitqueue_active
c_func
(paren
id|sk-&gt;sk_sleep
)paren
)paren
id|wake_up_interruptible
c_func
(paren
id|sk-&gt;sk_sleep
)paren
suffix:semicolon
id|_leave
c_func
(paren
l_string|&quot;&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* end rxrpc_error_report() */
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * split a message up, allocating message records and filling them in&n; * from the contents of a socket buffer&n; */
DECL|function|rxrpc_incoming_msg
r_static
r_int
id|rxrpc_incoming_msg
c_func
(paren
r_struct
id|rxrpc_transport
op_star
id|trans
comma
r_struct
id|sk_buff
op_star
id|pkt
comma
r_struct
id|list_head
op_star
id|msgq
)paren
(brace
r_struct
id|rxrpc_message
op_star
id|msg
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|_enter
c_func
(paren
l_string|&quot;&quot;
)paren
suffix:semicolon
id|msg
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|rxrpc_message
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|msg
)paren
(brace
id|_leave
c_func
(paren
l_string|&quot; = -ENOMEM&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|msg
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|msg
)paren
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|msg-&gt;usage
comma
l_int|1
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|msg-&gt;link
comma
id|msgq
)paren
suffix:semicolon
multiline_comment|/* dig out the Rx routing parameters */
r_if
c_cond
(paren
id|skb_copy_bits
c_func
(paren
id|pkt
comma
r_sizeof
(paren
r_struct
id|udphdr
)paren
comma
op_amp
id|msg-&gt;hdr
comma
r_sizeof
(paren
id|msg-&gt;hdr
)paren
)paren
OL
l_int|0
)paren
(brace
id|ret
op_assign
op_minus
id|EBADMSG
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
id|msg-&gt;trans
op_assign
id|trans
suffix:semicolon
id|msg-&gt;state
op_assign
id|RXRPC_MSG_RECEIVED
suffix:semicolon
id|msg-&gt;stamp
op_assign
id|pkt-&gt;stamp
suffix:semicolon
r_if
c_cond
(paren
id|msg-&gt;stamp.tv_sec
op_eq
l_int|0
)paren
(brace
id|do_gettimeofday
c_func
(paren
op_amp
id|msg-&gt;stamp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pkt-&gt;sk
)paren
id|sock_enable_timestamp
c_func
(paren
id|pkt-&gt;sk
)paren
suffix:semicolon
)brace
id|msg-&gt;seq
op_assign
id|ntohl
c_func
(paren
id|msg-&gt;hdr.seq
)paren
suffix:semicolon
multiline_comment|/* attach the packet */
id|skb_get
c_func
(paren
id|pkt
)paren
suffix:semicolon
id|msg-&gt;pkt
op_assign
id|pkt
suffix:semicolon
id|msg-&gt;offset
op_assign
r_sizeof
(paren
r_struct
id|udphdr
)paren
op_plus
r_sizeof
(paren
r_struct
id|rxrpc_header
)paren
suffix:semicolon
id|msg-&gt;dsize
op_assign
id|msg-&gt;pkt-&gt;len
op_minus
id|msg-&gt;offset
suffix:semicolon
id|_net
c_func
(paren
l_string|&quot;Rx Received packet from %s (%08x;%08x,%1x,%d,%s,%02x,%d,%d)&quot;
comma
id|msg-&gt;hdr.flags
op_amp
id|RXRPC_CLIENT_INITIATED
ques
c_cond
l_string|&quot;client&quot;
suffix:colon
l_string|&quot;server&quot;
comma
id|ntohl
c_func
(paren
id|msg-&gt;hdr.epoch
)paren
comma
(paren
id|ntohl
c_func
(paren
id|msg-&gt;hdr.cid
)paren
op_amp
id|RXRPC_CIDMASK
)paren
op_rshift
id|RXRPC_CIDSHIFT
comma
id|ntohl
c_func
(paren
id|msg-&gt;hdr.cid
)paren
op_amp
id|RXRPC_CHANNELMASK
comma
id|ntohl
c_func
(paren
id|msg-&gt;hdr.callNumber
)paren
comma
id|rxrpc_pkts
(braket
id|msg-&gt;hdr.type
)braket
comma
id|msg-&gt;hdr.flags
comma
id|ntohs
c_func
(paren
id|msg-&gt;hdr.serviceId
)paren
comma
id|msg-&gt;hdr.securityIndex
)paren
suffix:semicolon
id|__RXACCT
c_func
(paren
id|atomic_inc
c_func
(paren
op_amp
id|rxrpc_message_count
)paren
)paren
suffix:semicolon
multiline_comment|/* split off jumbo packets */
r_while
c_loop
(paren
id|msg-&gt;hdr.type
op_eq
id|RXRPC_PACKET_TYPE_DATA
op_logical_and
id|msg-&gt;hdr.flags
op_amp
id|RXRPC_JUMBO_PACKET
)paren
(brace
r_struct
id|rxrpc_jumbo_header
id|jumbo
suffix:semicolon
r_struct
id|rxrpc_message
op_star
id|jumbomsg
op_assign
id|msg
suffix:semicolon
id|_debug
c_func
(paren
l_string|&quot;split jumbo packet&quot;
)paren
suffix:semicolon
multiline_comment|/* quick sanity check */
id|ret
op_assign
op_minus
id|EBADMSG
suffix:semicolon
r_if
c_cond
(paren
id|msg-&gt;dsize
OL
id|RXRPC_JUMBO_DATALEN
op_plus
r_sizeof
(paren
r_struct
id|rxrpc_jumbo_header
)paren
)paren
r_goto
id|error
suffix:semicolon
r_if
c_cond
(paren
id|msg-&gt;hdr.flags
op_amp
id|RXRPC_LAST_PACKET
)paren
r_goto
id|error
suffix:semicolon
multiline_comment|/* dig out the secondary header */
r_if
c_cond
(paren
id|skb_copy_bits
c_func
(paren
id|pkt
comma
id|msg-&gt;offset
op_plus
id|RXRPC_JUMBO_DATALEN
comma
op_amp
id|jumbo
comma
r_sizeof
(paren
id|jumbo
)paren
)paren
OL
l_int|0
)paren
r_goto
id|error
suffix:semicolon
multiline_comment|/* allocate a new message record */
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
id|msg
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|rxrpc_message
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|msg
)paren
r_goto
id|error
suffix:semicolon
id|memcpy
c_func
(paren
id|msg
comma
id|jumbomsg
comma
r_sizeof
(paren
op_star
id|msg
)paren
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|msg-&gt;link
comma
id|msgq
)paren
suffix:semicolon
multiline_comment|/* adjust the jumbo packet */
id|jumbomsg-&gt;dsize
op_assign
id|RXRPC_JUMBO_DATALEN
suffix:semicolon
multiline_comment|/* attach the packet here too */
id|skb_get
c_func
(paren
id|pkt
)paren
suffix:semicolon
multiline_comment|/* adjust the parameters */
id|msg-&gt;seq
op_increment
suffix:semicolon
id|msg-&gt;hdr.seq
op_assign
id|htonl
c_func
(paren
id|msg-&gt;seq
)paren
suffix:semicolon
id|msg-&gt;hdr.serial
op_assign
id|htonl
c_func
(paren
id|ntohl
c_func
(paren
id|msg-&gt;hdr.serial
)paren
op_plus
l_int|1
)paren
suffix:semicolon
id|msg-&gt;offset
op_add_assign
id|RXRPC_JUMBO_DATALEN
op_plus
r_sizeof
(paren
r_struct
id|rxrpc_jumbo_header
)paren
suffix:semicolon
id|msg-&gt;dsize
op_sub_assign
id|RXRPC_JUMBO_DATALEN
op_plus
r_sizeof
(paren
r_struct
id|rxrpc_jumbo_header
)paren
suffix:semicolon
id|msg-&gt;hdr.flags
op_assign
id|jumbo.flags
suffix:semicolon
id|msg-&gt;hdr._rsvd
op_assign
id|jumbo._rsvd
suffix:semicolon
id|_net
c_func
(paren
l_string|&quot;Rx Split jumbo packet from %s&quot;
l_string|&quot; (%08x;%08x,%1x,%d,%s,%02x,%d,%d)&quot;
comma
id|msg-&gt;hdr.flags
op_amp
id|RXRPC_CLIENT_INITIATED
ques
c_cond
l_string|&quot;client&quot;
suffix:colon
l_string|&quot;server&quot;
comma
id|ntohl
c_func
(paren
id|msg-&gt;hdr.epoch
)paren
comma
(paren
id|ntohl
c_func
(paren
id|msg-&gt;hdr.cid
)paren
op_amp
id|RXRPC_CIDMASK
)paren
op_rshift
id|RXRPC_CIDSHIFT
comma
id|ntohl
c_func
(paren
id|msg-&gt;hdr.cid
)paren
op_amp
id|RXRPC_CHANNELMASK
comma
id|ntohl
c_func
(paren
id|msg-&gt;hdr.callNumber
)paren
comma
id|rxrpc_pkts
(braket
id|msg-&gt;hdr.type
)braket
comma
id|msg-&gt;hdr.flags
comma
id|ntohs
c_func
(paren
id|msg-&gt;hdr.serviceId
)paren
comma
id|msg-&gt;hdr.securityIndex
)paren
suffix:semicolon
id|__RXACCT
c_func
(paren
id|atomic_inc
c_func
(paren
op_amp
id|rxrpc_message_count
)paren
)paren
suffix:semicolon
)brace
id|_leave
c_func
(paren
l_string|&quot; = 0 #%d&quot;
comma
id|atomic_read
c_func
(paren
op_amp
id|rxrpc_message_count
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|error
suffix:colon
r_while
c_loop
(paren
op_logical_neg
id|list_empty
c_func
(paren
id|msgq
)paren
)paren
(brace
id|msg
op_assign
id|list_entry
c_func
(paren
id|msgq-&gt;next
comma
r_struct
id|rxrpc_message
comma
id|link
)paren
suffix:semicolon
id|list_del_init
c_func
(paren
op_amp
id|msg-&gt;link
)paren
suffix:semicolon
id|rxrpc_put_message
c_func
(paren
id|msg
)paren
suffix:semicolon
)brace
id|_leave
c_func
(paren
l_string|&quot; = %d&quot;
comma
id|ret
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* end rxrpc_incoming_msg() */
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * accept a new call&n; * - called from krxiod in process context&n; */
DECL|function|rxrpc_trans_receive_packet
r_void
id|rxrpc_trans_receive_packet
c_func
(paren
r_struct
id|rxrpc_transport
op_star
id|trans
)paren
(brace
r_struct
id|rxrpc_message
op_star
id|msg
suffix:semicolon
r_struct
id|rxrpc_peer
op_star
id|peer
suffix:semicolon
r_struct
id|sk_buff
op_star
id|pkt
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|__be32
id|addr
suffix:semicolon
id|__be16
id|port
suffix:semicolon
id|LIST_HEAD
c_func
(paren
id|msgq
)paren
suffix:semicolon
id|_enter
c_func
(paren
l_string|&quot;%p{%d}&quot;
comma
id|trans
comma
id|trans-&gt;port
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
multiline_comment|/* deal with outstanting errors first */
r_if
c_cond
(paren
id|trans-&gt;error_rcvd
)paren
id|rxrpc_trans_receive_error_report
c_func
(paren
id|trans
)paren
suffix:semicolon
multiline_comment|/* attempt to receive a packet */
id|pkt
op_assign
id|skb_recv_datagram
c_func
(paren
id|trans-&gt;socket-&gt;sk
comma
l_int|0
comma
l_int|1
comma
op_amp
id|ret
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pkt
)paren
(brace
r_if
c_cond
(paren
id|ret
op_eq
op_minus
id|EAGAIN
)paren
(brace
id|_leave
c_func
(paren
l_string|&quot; EAGAIN&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* an icmp error may have occurred */
id|rxrpc_krxiod_queue_transport
c_func
(paren
id|trans
)paren
suffix:semicolon
id|_leave
c_func
(paren
l_string|&quot; error %d&bslash;n&quot;
comma
id|ret
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* we&squot;ll probably need to checksum it (didn&squot;t call&n;&t;&t; * sock_recvmsg) */
r_if
c_cond
(paren
id|pkt-&gt;ip_summed
op_ne
id|CHECKSUM_UNNECESSARY
)paren
(brace
r_if
c_cond
(paren
(paren
r_int
r_int
)paren
id|csum_fold
c_func
(paren
id|skb_checksum
c_func
(paren
id|pkt
comma
l_int|0
comma
id|pkt-&gt;len
comma
id|pkt-&gt;csum
)paren
)paren
)paren
(brace
id|kfree_skb
c_func
(paren
id|pkt
)paren
suffix:semicolon
id|rxrpc_krxiod_queue_transport
c_func
(paren
id|trans
)paren
suffix:semicolon
id|_leave
c_func
(paren
l_string|&quot; CSUM failed&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
id|addr
op_assign
id|pkt-&gt;nh.iph-&gt;saddr
suffix:semicolon
id|port
op_assign
id|pkt-&gt;h.uh-&gt;source
suffix:semicolon
id|_net
c_func
(paren
l_string|&quot;Rx Received UDP packet from %08x:%04hu&quot;
comma
id|ntohl
c_func
(paren
id|addr
)paren
comma
id|ntohs
c_func
(paren
id|port
)paren
)paren
suffix:semicolon
multiline_comment|/* unmarshall the Rx parameters and split jumbo packets */
id|ret
op_assign
id|rxrpc_incoming_msg
c_func
(paren
id|trans
comma
id|pkt
comma
op_amp
id|msgq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
id|kfree_skb
c_func
(paren
id|pkt
)paren
suffix:semicolon
id|rxrpc_krxiod_queue_transport
c_func
(paren
id|trans
)paren
suffix:semicolon
id|_leave
c_func
(paren
l_string|&quot; bad packet&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|BUG_ON
c_func
(paren
id|list_empty
c_func
(paren
op_amp
id|msgq
)paren
)paren
suffix:semicolon
id|msg
op_assign
id|list_entry
c_func
(paren
id|msgq.next
comma
r_struct
id|rxrpc_message
comma
id|link
)paren
suffix:semicolon
multiline_comment|/* locate the record for the peer from which it&n;&t;&t; * originated */
id|ret
op_assign
id|rxrpc_peer_lookup
c_func
(paren
id|trans
comma
id|addr
comma
op_amp
id|peer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
id|kdebug
c_func
(paren
l_string|&quot;Rx No connections from that peer&quot;
)paren
suffix:semicolon
id|rxrpc_trans_immediate_abort
c_func
(paren
id|trans
comma
id|msg
comma
op_minus
id|EINVAL
)paren
suffix:semicolon
r_goto
id|finished_msg
suffix:semicolon
)brace
multiline_comment|/* try and find a matching connection */
id|ret
op_assign
id|rxrpc_connection_lookup
c_func
(paren
id|peer
comma
id|msg
comma
op_amp
id|msg-&gt;conn
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
id|kdebug
c_func
(paren
l_string|&quot;Rx Unknown Connection&quot;
)paren
suffix:semicolon
id|rxrpc_trans_immediate_abort
c_func
(paren
id|trans
comma
id|msg
comma
op_minus
id|EINVAL
)paren
suffix:semicolon
id|rxrpc_put_peer
c_func
(paren
id|peer
)paren
suffix:semicolon
r_goto
id|finished_msg
suffix:semicolon
)brace
id|rxrpc_put_peer
c_func
(paren
id|peer
)paren
suffix:semicolon
multiline_comment|/* deal with the first packet of a new call */
r_if
c_cond
(paren
id|msg-&gt;hdr.flags
op_amp
id|RXRPC_CLIENT_INITIATED
op_logical_and
id|msg-&gt;hdr.type
op_eq
id|RXRPC_PACKET_TYPE_DATA
op_logical_and
id|ntohl
c_func
(paren
id|msg-&gt;hdr.seq
)paren
op_eq
l_int|1
)paren
(brace
id|_debug
c_func
(paren
l_string|&quot;Rx New server call&quot;
)paren
suffix:semicolon
id|rxrpc_trans_receive_new_call
c_func
(paren
id|trans
comma
op_amp
id|msgq
)paren
suffix:semicolon
r_goto
id|finished_msg
suffix:semicolon
)brace
multiline_comment|/* deal with subsequent packet(s) of call */
id|_debug
c_func
(paren
l_string|&quot;Rx Call packet&quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|msgq
)paren
)paren
(brace
id|msg
op_assign
id|list_entry
c_func
(paren
id|msgq.next
comma
r_struct
id|rxrpc_message
comma
id|link
)paren
suffix:semicolon
id|list_del_init
c_func
(paren
op_amp
id|msg-&gt;link
)paren
suffix:semicolon
id|ret
op_assign
id|rxrpc_conn_receive_call_packet
c_func
(paren
id|msg-&gt;conn
comma
l_int|NULL
comma
id|msg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
id|rxrpc_trans_immediate_abort
c_func
(paren
id|trans
comma
id|msg
comma
id|ret
)paren
suffix:semicolon
id|rxrpc_put_message
c_func
(paren
id|msg
)paren
suffix:semicolon
r_goto
id|finished_msg
suffix:semicolon
)brace
id|rxrpc_put_message
c_func
(paren
id|msg
)paren
suffix:semicolon
)brace
r_goto
id|finished_msg
suffix:semicolon
multiline_comment|/* dispose of the packets */
id|finished_msg
suffix:colon
r_while
c_loop
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|msgq
)paren
)paren
(brace
id|msg
op_assign
id|list_entry
c_func
(paren
id|msgq.next
comma
r_struct
id|rxrpc_message
comma
id|link
)paren
suffix:semicolon
id|list_del_init
c_func
(paren
op_amp
id|msg-&gt;link
)paren
suffix:semicolon
id|rxrpc_put_message
c_func
(paren
id|msg
)paren
suffix:semicolon
)brace
id|kfree_skb
c_func
(paren
id|pkt
)paren
suffix:semicolon
)brace
id|_leave
c_func
(paren
l_string|&quot;&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* end rxrpc_trans_receive_packet() */
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * accept a new call from a client trying to connect to one of my services&n; * - called in process context&n; */
DECL|function|rxrpc_trans_receive_new_call
r_static
r_int
id|rxrpc_trans_receive_new_call
c_func
(paren
r_struct
id|rxrpc_transport
op_star
id|trans
comma
r_struct
id|list_head
op_star
id|msgq
)paren
(brace
r_struct
id|rxrpc_message
op_star
id|msg
suffix:semicolon
id|_enter
c_func
(paren
l_string|&quot;&quot;
)paren
suffix:semicolon
multiline_comment|/* only bother with the first packet */
id|msg
op_assign
id|list_entry
c_func
(paren
id|msgq-&gt;next
comma
r_struct
id|rxrpc_message
comma
id|link
)paren
suffix:semicolon
id|list_del_init
c_func
(paren
op_amp
id|msg-&gt;link
)paren
suffix:semicolon
id|rxrpc_krxsecd_queue_incoming_call
c_func
(paren
id|msg
)paren
suffix:semicolon
id|rxrpc_put_message
c_func
(paren
id|msg
)paren
suffix:semicolon
id|_leave
c_func
(paren
l_string|&quot; = 0&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* end rxrpc_trans_receive_new_call() */
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * perform an immediate abort without connection or call structures&n; */
DECL|function|rxrpc_trans_immediate_abort
r_int
id|rxrpc_trans_immediate_abort
c_func
(paren
r_struct
id|rxrpc_transport
op_star
id|trans
comma
r_struct
id|rxrpc_message
op_star
id|msg
comma
r_int
id|error
)paren
(brace
r_struct
id|rxrpc_header
id|ahdr
suffix:semicolon
r_struct
id|sockaddr_in
id|sin
suffix:semicolon
r_struct
id|msghdr
id|msghdr
suffix:semicolon
r_struct
id|kvec
id|iov
(braket
l_int|2
)braket
suffix:semicolon
id|__be32
id|_error
suffix:semicolon
r_int
id|len
comma
id|ret
suffix:semicolon
id|_enter
c_func
(paren
l_string|&quot;%p,%p,%d&quot;
comma
id|trans
comma
id|msg
comma
id|error
)paren
suffix:semicolon
multiline_comment|/* don&squot;t abort an abort packet */
r_if
c_cond
(paren
id|msg-&gt;hdr.type
op_eq
id|RXRPC_PACKET_TYPE_ABORT
)paren
(brace
id|_leave
c_func
(paren
l_string|&quot; = 0&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|_error
op_assign
id|htonl
c_func
(paren
op_minus
id|error
)paren
suffix:semicolon
multiline_comment|/* set up the message to be transmitted */
id|memcpy
c_func
(paren
op_amp
id|ahdr
comma
op_amp
id|msg-&gt;hdr
comma
r_sizeof
(paren
id|ahdr
)paren
)paren
suffix:semicolon
id|ahdr.epoch
op_assign
id|msg-&gt;hdr.epoch
suffix:semicolon
id|ahdr.serial
op_assign
id|htonl
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|ahdr.seq
op_assign
l_int|0
suffix:semicolon
id|ahdr.type
op_assign
id|RXRPC_PACKET_TYPE_ABORT
suffix:semicolon
id|ahdr.flags
op_assign
id|RXRPC_LAST_PACKET
suffix:semicolon
id|ahdr.flags
op_or_assign
op_complement
id|msg-&gt;hdr.flags
op_amp
id|RXRPC_CLIENT_INITIATED
suffix:semicolon
id|iov
(braket
l_int|0
)braket
dot
id|iov_len
op_assign
r_sizeof
(paren
id|ahdr
)paren
suffix:semicolon
id|iov
(braket
l_int|0
)braket
dot
id|iov_base
op_assign
op_amp
id|ahdr
suffix:semicolon
id|iov
(braket
l_int|1
)braket
dot
id|iov_len
op_assign
r_sizeof
(paren
id|_error
)paren
suffix:semicolon
id|iov
(braket
l_int|1
)braket
dot
id|iov_base
op_assign
op_amp
id|_error
suffix:semicolon
id|len
op_assign
r_sizeof
(paren
id|ahdr
)paren
op_plus
r_sizeof
(paren
id|_error
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|sin
comma
l_int|0
comma
r_sizeof
(paren
id|sin
)paren
)paren
suffix:semicolon
id|sin.sin_family
op_assign
id|AF_INET
suffix:semicolon
id|sin.sin_port
op_assign
id|msg-&gt;pkt-&gt;h.uh-&gt;source
suffix:semicolon
id|sin.sin_addr.s_addr
op_assign
id|msg-&gt;pkt-&gt;nh.iph-&gt;saddr
suffix:semicolon
id|msghdr.msg_name
op_assign
op_amp
id|sin
suffix:semicolon
id|msghdr.msg_namelen
op_assign
r_sizeof
(paren
id|sin
)paren
suffix:semicolon
id|msghdr.msg_control
op_assign
l_int|NULL
suffix:semicolon
id|msghdr.msg_controllen
op_assign
l_int|0
suffix:semicolon
id|msghdr.msg_flags
op_assign
id|MSG_DONTWAIT
suffix:semicolon
id|_net
c_func
(paren
l_string|&quot;Sending message type %d of %d bytes to %08x:%d&quot;
comma
id|ahdr.type
comma
id|len
comma
id|ntohl
c_func
(paren
id|sin.sin_addr.s_addr
)paren
comma
id|ntohs
c_func
(paren
id|sin.sin_port
)paren
)paren
suffix:semicolon
multiline_comment|/* send the message */
id|ret
op_assign
id|kernel_sendmsg
c_func
(paren
id|trans-&gt;socket
comma
op_amp
id|msghdr
comma
id|iov
comma
l_int|2
comma
id|len
)paren
suffix:semicolon
id|_leave
c_func
(paren
l_string|&quot; = %d&quot;
comma
id|ret
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* end rxrpc_trans_immediate_abort() */
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * receive an ICMP error report and percolate it to all connections&n; * heading to the affected host or port&n; */
DECL|function|rxrpc_trans_receive_error_report
r_static
r_void
id|rxrpc_trans_receive_error_report
c_func
(paren
r_struct
id|rxrpc_transport
op_star
id|trans
)paren
(brace
r_struct
id|rxrpc_connection
op_star
id|conn
suffix:semicolon
r_struct
id|sockaddr_in
id|sin
suffix:semicolon
r_struct
id|rxrpc_peer
op_star
id|peer
suffix:semicolon
r_struct
id|list_head
id|connq
comma
op_star
id|_p
suffix:semicolon
r_struct
id|errormsg
id|emsg
suffix:semicolon
r_struct
id|msghdr
id|msg
suffix:semicolon
id|__be16
id|port
suffix:semicolon
r_int
id|local
comma
id|err
suffix:semicolon
id|_enter
c_func
(paren
l_string|&quot;%p&quot;
comma
id|trans
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|trans-&gt;error_rcvd
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* try and receive an error message */
id|msg.msg_name
op_assign
op_amp
id|sin
suffix:semicolon
id|msg.msg_namelen
op_assign
r_sizeof
(paren
id|sin
)paren
suffix:semicolon
id|msg.msg_control
op_assign
op_amp
id|emsg
suffix:semicolon
id|msg.msg_controllen
op_assign
r_sizeof
(paren
id|emsg
)paren
suffix:semicolon
id|msg.msg_flags
op_assign
l_int|0
suffix:semicolon
id|err
op_assign
id|kernel_recvmsg
c_func
(paren
id|trans-&gt;socket
comma
op_amp
id|msg
comma
l_int|NULL
comma
l_int|0
comma
l_int|0
comma
id|MSG_ERRQUEUE
op_or
id|MSG_DONTWAIT
op_or
id|MSG_TRUNC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_eq
op_minus
id|EAGAIN
)paren
(brace
id|_leave
c_func
(paren
l_string|&quot;&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: unable to recv an error report: %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|err
)paren
suffix:semicolon
id|_leave
c_func
(paren
l_string|&quot;&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|msg.msg_controllen
op_assign
(paren
r_char
op_star
)paren
id|msg.msg_control
op_minus
(paren
r_char
op_star
)paren
op_amp
id|emsg
suffix:semicolon
r_if
c_cond
(paren
id|msg.msg_controllen
OL
r_sizeof
(paren
id|emsg.cmsg
)paren
op_logical_or
id|msg.msg_namelen
OL
r_sizeof
(paren
id|sin
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: short control message&quot;
l_string|&quot; (nlen=%u clen=%Zu fl=%x)&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|msg.msg_namelen
comma
id|msg.msg_controllen
comma
id|msg.msg_flags
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|_net
c_func
(paren
l_string|&quot;Rx Received control message&quot;
l_string|&quot; { len=%Zu level=%u type=%u }&quot;
comma
id|emsg.cmsg.cmsg_len
comma
id|emsg.cmsg.cmsg_level
comma
id|emsg.cmsg.cmsg_type
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sin.sin_family
op_ne
id|AF_INET
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Rx Ignoring error report with non-INET address&quot;
l_string|&quot; (fam=%u)&quot;
comma
id|sin.sin_family
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|_net
c_func
(paren
l_string|&quot;Rx Received message pertaining to host addr=%x port=%hu&quot;
comma
id|ntohl
c_func
(paren
id|sin.sin_addr.s_addr
)paren
comma
id|ntohs
c_func
(paren
id|sin.sin_port
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|emsg.cmsg.cmsg_level
op_ne
id|SOL_IP
op_logical_or
id|emsg.cmsg.cmsg_type
op_ne
id|IP_RECVERR
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Rx Ignoring unknown error report&quot;
l_string|&quot; { level=%u type=%u }&quot;
comma
id|emsg.cmsg.cmsg_level
comma
id|emsg.cmsg.cmsg_type
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|msg.msg_controllen
OL
r_sizeof
(paren
id|emsg.cmsg
)paren
op_plus
r_sizeof
(paren
id|emsg.ee
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s: short error message (%Zu)&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|msg.msg_controllen
)paren
suffix:semicolon
id|_leave
c_func
(paren
l_string|&quot;&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|port
op_assign
id|sin.sin_port
suffix:semicolon
r_switch
c_cond
(paren
id|emsg.ee.ee_origin
)paren
(brace
r_case
id|SO_EE_ORIGIN_ICMP
suffix:colon
id|local
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|emsg.ee.ee_type
)paren
(brace
r_case
id|ICMP_DEST_UNREACH
suffix:colon
r_switch
c_cond
(paren
id|emsg.ee.ee_code
)paren
(brace
r_case
id|ICMP_NET_UNREACH
suffix:colon
id|_net
c_func
(paren
l_string|&quot;Rx Received ICMP Network Unreachable&quot;
)paren
suffix:semicolon
id|port
op_assign
l_int|0
suffix:semicolon
id|err
op_assign
op_minus
id|ENETUNREACH
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ICMP_HOST_UNREACH
suffix:colon
id|_net
c_func
(paren
l_string|&quot;Rx Received ICMP Host Unreachable&quot;
)paren
suffix:semicolon
id|port
op_assign
l_int|0
suffix:semicolon
id|err
op_assign
op_minus
id|EHOSTUNREACH
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ICMP_PORT_UNREACH
suffix:colon
id|_net
c_func
(paren
l_string|&quot;Rx Received ICMP Port Unreachable&quot;
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|ECONNREFUSED
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ICMP_NET_UNKNOWN
suffix:colon
id|_net
c_func
(paren
l_string|&quot;Rx Received ICMP Unknown Network&quot;
)paren
suffix:semicolon
id|port
op_assign
l_int|0
suffix:semicolon
id|err
op_assign
op_minus
id|ENETUNREACH
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ICMP_HOST_UNKNOWN
suffix:colon
id|_net
c_func
(paren
l_string|&quot;Rx Received ICMP Unknown Host&quot;
)paren
suffix:semicolon
id|port
op_assign
l_int|0
suffix:semicolon
id|err
op_assign
op_minus
id|EHOSTUNREACH
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|_net
c_func
(paren
l_string|&quot;Rx Received ICMP DestUnreach { code=%u }&quot;
comma
id|emsg.ee.ee_code
)paren
suffix:semicolon
id|err
op_assign
id|emsg.ee.ee_errno
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|ICMP_TIME_EXCEEDED
suffix:colon
id|_net
c_func
(paren
l_string|&quot;Rx Received ICMP TTL Exceeded&quot;
)paren
suffix:semicolon
id|err
op_assign
id|emsg.ee.ee_errno
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|_proto
c_func
(paren
l_string|&quot;Rx Received ICMP error { type=%u code=%u }&quot;
comma
id|emsg.ee.ee_type
comma
id|emsg.ee.ee_code
)paren
suffix:semicolon
id|err
op_assign
id|emsg.ee.ee_errno
suffix:semicolon
r_break
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|SO_EE_ORIGIN_LOCAL
suffix:colon
id|_proto
c_func
(paren
l_string|&quot;Rx Received local error { error=%d }&quot;
comma
id|emsg.ee.ee_errno
)paren
suffix:semicolon
id|local
op_assign
l_int|1
suffix:semicolon
id|err
op_assign
id|emsg.ee.ee_errno
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SO_EE_ORIGIN_NONE
suffix:colon
r_case
id|SO_EE_ORIGIN_ICMP6
suffix:colon
r_default
suffix:colon
id|_proto
c_func
(paren
l_string|&quot;Rx Received error report { orig=%u }&quot;
comma
id|emsg.ee.ee_origin
)paren
suffix:semicolon
id|local
op_assign
l_int|0
suffix:semicolon
id|err
op_assign
id|emsg.ee.ee_errno
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* find all the connections between this transport and the&n;&t;&t; * affected destination */
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|connq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rxrpc_peer_lookup
c_func
(paren
id|trans
comma
id|sin.sin_addr.s_addr
comma
op_amp
id|peer
)paren
op_eq
l_int|0
)paren
(brace
id|read_lock
c_func
(paren
op_amp
id|peer-&gt;conn_lock
)paren
suffix:semicolon
id|list_for_each
c_func
(paren
id|_p
comma
op_amp
id|peer-&gt;conn_active
)paren
(brace
id|conn
op_assign
id|list_entry
c_func
(paren
id|_p
comma
r_struct
id|rxrpc_connection
comma
id|link
)paren
suffix:semicolon
r_if
c_cond
(paren
id|port
op_logical_and
id|conn-&gt;addr.sin_port
op_ne
id|port
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|conn-&gt;err_link
)paren
)paren
r_continue
suffix:semicolon
id|rxrpc_get_connection
c_func
(paren
id|conn
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|conn-&gt;err_link
comma
op_amp
id|connq
)paren
suffix:semicolon
)brace
id|read_unlock
c_func
(paren
op_amp
id|peer-&gt;conn_lock
)paren
suffix:semicolon
multiline_comment|/* service all those connections */
r_while
c_loop
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|connq
)paren
)paren
(brace
id|conn
op_assign
id|list_entry
c_func
(paren
id|connq.next
comma
r_struct
id|rxrpc_connection
comma
id|err_link
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|conn-&gt;err_link
)paren
suffix:semicolon
id|rxrpc_conn_handle_error
c_func
(paren
id|conn
comma
id|local
comma
id|err
)paren
suffix:semicolon
id|rxrpc_put_connection
c_func
(paren
id|conn
)paren
suffix:semicolon
)brace
id|rxrpc_put_peer
c_func
(paren
id|peer
)paren
suffix:semicolon
)brace
)brace
id|_leave
c_func
(paren
l_string|&quot;&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* end rxrpc_trans_receive_error_report() */
eof
