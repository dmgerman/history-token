multiline_comment|/* connection.c: Rx connection routines&n; *&n; * Copyright (C) 2002 Red Hat, Inc. All Rights Reserved.&n; * Written by David Howells (dhowells@redhat.com)&n; *&n; * This program is free software; you can redistribute it and/or&n; * modify it under the terms of the GNU General Public License&n; * as published by the Free Software Foundation; either version&n; * 2 of the License, or (at your option) any later version.&n; */
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;rxrpc/rxrpc.h&gt;
macro_line|#include &lt;rxrpc/transport.h&gt;
macro_line|#include &lt;rxrpc/peer.h&gt;
macro_line|#include &lt;rxrpc/connection.h&gt;
macro_line|#include &lt;rxrpc/call.h&gt;
macro_line|#include &lt;rxrpc/message.h&gt;
macro_line|#include &lt;linux/udp.h&gt;
macro_line|#include &lt;linux/ip.h&gt;
macro_line|#include &lt;net/sock.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &quot;internal.h&quot;
DECL|variable|rxrpc_connection_count
id|__RXACCT_DECL
c_func
(paren
id|atomic_t
id|rxrpc_connection_count
)paren
suffix:semicolon
DECL|variable|rxrpc_conns
id|LIST_HEAD
c_func
(paren
id|rxrpc_conns
)paren
suffix:semicolon
DECL|variable|rxrpc_conns_sem
id|DECLARE_RWSEM
c_func
(paren
id|rxrpc_conns_sem
)paren
suffix:semicolon
DECL|variable|rxrpc_conn_timeout
r_int
r_int
id|rxrpc_conn_timeout
op_assign
l_int|60
op_star
l_int|60
suffix:semicolon
r_static
r_void
id|rxrpc_conn_do_timeout
c_func
(paren
r_struct
id|rxrpc_connection
op_star
id|conn
)paren
suffix:semicolon
DECL|function|__rxrpc_conn_timeout
r_static
r_void
id|__rxrpc_conn_timeout
c_func
(paren
id|rxrpc_timer_t
op_star
id|timer
)paren
(brace
r_struct
id|rxrpc_connection
op_star
id|conn
op_assign
id|list_entry
c_func
(paren
id|timer
comma
r_struct
id|rxrpc_connection
comma
id|timeout
)paren
suffix:semicolon
id|_debug
c_func
(paren
l_string|&quot;Rx CONN TIMEOUT [%p{u=%d}]&quot;
comma
id|conn
comma
id|atomic_read
c_func
(paren
op_amp
id|conn-&gt;usage
)paren
)paren
suffix:semicolon
id|rxrpc_conn_do_timeout
c_func
(paren
id|conn
)paren
suffix:semicolon
)brace
DECL|variable|rxrpc_conn_timer_ops
r_static
r_const
r_struct
id|rxrpc_timer_ops
id|rxrpc_conn_timer_ops
op_assign
(brace
dot
id|timed_out
op_assign
id|__rxrpc_conn_timeout
comma
)brace
suffix:semicolon
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * create a new connection record&n; */
DECL|function|__rxrpc_create_connection
r_static
r_inline
r_int
id|__rxrpc_create_connection
c_func
(paren
r_struct
id|rxrpc_peer
op_star
id|peer
comma
r_struct
id|rxrpc_connection
op_star
op_star
id|_conn
)paren
(brace
r_struct
id|rxrpc_connection
op_star
id|conn
suffix:semicolon
id|_enter
c_func
(paren
l_string|&quot;%p&quot;
comma
id|peer
)paren
suffix:semicolon
multiline_comment|/* allocate and initialise a connection record */
id|conn
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|rxrpc_connection
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|conn
)paren
(brace
id|_leave
c_func
(paren
l_string|&quot; = -ENOMEM&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|conn
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|rxrpc_connection
)paren
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|conn-&gt;usage
comma
l_int|1
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|conn-&gt;link
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|conn-&gt;id_link
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|conn-&gt;chanwait
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|conn-&gt;lock
)paren
suffix:semicolon
id|rxrpc_timer_init
c_func
(paren
op_amp
id|conn-&gt;timeout
comma
op_amp
id|rxrpc_conn_timer_ops
)paren
suffix:semicolon
id|do_gettimeofday
c_func
(paren
op_amp
id|conn-&gt;atime
)paren
suffix:semicolon
id|conn-&gt;mtu_size
op_assign
l_int|1024
suffix:semicolon
id|conn-&gt;peer
op_assign
id|peer
suffix:semicolon
id|conn-&gt;trans
op_assign
id|peer-&gt;trans
suffix:semicolon
id|__RXACCT
c_func
(paren
id|atomic_inc
c_func
(paren
op_amp
id|rxrpc_connection_count
)paren
)paren
suffix:semicolon
op_star
id|_conn
op_assign
id|conn
suffix:semicolon
id|_leave
c_func
(paren
l_string|&quot; = 0 (%p)&quot;
comma
id|conn
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* end __rxrpc_create_connection() */
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * create a new connection record for outgoing connections&n; */
DECL|function|rxrpc_create_connection
r_int
id|rxrpc_create_connection
c_func
(paren
r_struct
id|rxrpc_transport
op_star
id|trans
comma
id|__be16
id|port
comma
id|__be32
id|addr
comma
r_uint16
id|service_id
comma
r_void
op_star
id|security
comma
r_struct
id|rxrpc_connection
op_star
op_star
id|_conn
)paren
(brace
r_struct
id|rxrpc_connection
op_star
id|candidate
comma
op_star
id|conn
suffix:semicolon
r_struct
id|rxrpc_peer
op_star
id|peer
suffix:semicolon
r_struct
id|list_head
op_star
id|_p
suffix:semicolon
id|__be32
id|connid
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|_enter
c_func
(paren
l_string|&quot;%p{%hu},%u,%hu&quot;
comma
id|trans
comma
id|trans-&gt;port
comma
id|ntohs
c_func
(paren
id|port
)paren
comma
id|service_id
)paren
suffix:semicolon
multiline_comment|/* get a peer record */
id|ret
op_assign
id|rxrpc_peer_lookup
c_func
(paren
id|trans
comma
id|addr
comma
op_amp
id|peer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
id|_leave
c_func
(paren
l_string|&quot; = %d&quot;
comma
id|ret
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* allocate and initialise a connection record */
id|ret
op_assign
id|__rxrpc_create_connection
c_func
(paren
id|peer
comma
op_amp
id|candidate
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
id|rxrpc_put_peer
c_func
(paren
id|peer
)paren
suffix:semicolon
id|_leave
c_func
(paren
l_string|&quot; = %d&quot;
comma
id|ret
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* fill in the specific bits */
id|candidate-&gt;addr.sin_family
op_assign
id|AF_INET
suffix:semicolon
id|candidate-&gt;addr.sin_port
op_assign
id|port
suffix:semicolon
id|candidate-&gt;addr.sin_addr.s_addr
op_assign
id|addr
suffix:semicolon
id|candidate-&gt;in_epoch
op_assign
id|rxrpc_epoch
suffix:semicolon
id|candidate-&gt;out_epoch
op_assign
id|rxrpc_epoch
suffix:semicolon
id|candidate-&gt;in_clientflag
op_assign
l_int|0
suffix:semicolon
id|candidate-&gt;out_clientflag
op_assign
id|RXRPC_CLIENT_INITIATED
suffix:semicolon
id|candidate-&gt;service_id
op_assign
id|htons
c_func
(paren
id|service_id
)paren
suffix:semicolon
multiline_comment|/* invent a unique connection ID */
id|write_lock
c_func
(paren
op_amp
id|peer-&gt;conn_idlock
)paren
suffix:semicolon
id|try_next_id
suffix:colon
id|connid
op_assign
id|htonl
c_func
(paren
id|peer-&gt;conn_idcounter
op_amp
id|RXRPC_CIDMASK
)paren
suffix:semicolon
id|peer-&gt;conn_idcounter
op_add_assign
id|RXRPC_MAXCALLS
suffix:semicolon
id|list_for_each
c_func
(paren
id|_p
comma
op_amp
id|peer-&gt;conn_idlist
)paren
(brace
id|conn
op_assign
id|list_entry
c_func
(paren
id|_p
comma
r_struct
id|rxrpc_connection
comma
id|id_link
)paren
suffix:semicolon
r_if
c_cond
(paren
id|connid
op_eq
id|conn-&gt;conn_id
)paren
r_goto
id|try_next_id
suffix:semicolon
r_if
c_cond
(paren
id|connid
OG
id|conn-&gt;conn_id
)paren
r_break
suffix:semicolon
)brace
id|_debug
c_func
(paren
l_string|&quot;selected candidate conn ID %x.%u&quot;
comma
id|ntohl
c_func
(paren
id|peer-&gt;addr.s_addr
)paren
comma
id|ntohl
c_func
(paren
id|connid
)paren
)paren
suffix:semicolon
id|candidate-&gt;conn_id
op_assign
id|connid
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|candidate-&gt;id_link
comma
id|_p
)paren
suffix:semicolon
id|write_unlock
c_func
(paren
op_amp
id|peer-&gt;conn_idlock
)paren
suffix:semicolon
multiline_comment|/* attach to peer */
id|candidate-&gt;peer
op_assign
id|peer
suffix:semicolon
id|write_lock
c_func
(paren
op_amp
id|peer-&gt;conn_lock
)paren
suffix:semicolon
multiline_comment|/* search the peer&squot;s transport graveyard list */
id|spin_lock
c_func
(paren
op_amp
id|peer-&gt;conn_gylock
)paren
suffix:semicolon
id|list_for_each
c_func
(paren
id|_p
comma
op_amp
id|peer-&gt;conn_graveyard
)paren
(brace
id|conn
op_assign
id|list_entry
c_func
(paren
id|_p
comma
r_struct
id|rxrpc_connection
comma
id|link
)paren
suffix:semicolon
r_if
c_cond
(paren
id|conn-&gt;addr.sin_port
op_eq
id|candidate-&gt;addr.sin_port
op_logical_and
id|conn-&gt;security_ix
op_eq
id|candidate-&gt;security_ix
op_logical_and
id|conn-&gt;service_id
op_eq
id|candidate-&gt;service_id
op_logical_and
id|conn-&gt;in_clientflag
op_eq
l_int|0
)paren
r_goto
id|found_in_graveyard
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|peer-&gt;conn_gylock
)paren
suffix:semicolon
multiline_comment|/* pick the new candidate */
id|_debug
c_func
(paren
l_string|&quot;created connection: {%08x} [out]&quot;
comma
id|ntohl
c_func
(paren
id|candidate-&gt;conn_id
)paren
)paren
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|peer-&gt;conn_count
)paren
suffix:semicolon
id|conn
op_assign
id|candidate
suffix:semicolon
id|candidate
op_assign
l_int|NULL
suffix:semicolon
id|make_active
suffix:colon
id|list_add_tail
c_func
(paren
op_amp
id|conn-&gt;link
comma
op_amp
id|peer-&gt;conn_active
)paren
suffix:semicolon
id|write_unlock
c_func
(paren
op_amp
id|peer-&gt;conn_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|candidate
)paren
(brace
id|write_lock
c_func
(paren
op_amp
id|peer-&gt;conn_idlock
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|candidate-&gt;id_link
)paren
suffix:semicolon
id|write_unlock
c_func
(paren
op_amp
id|peer-&gt;conn_idlock
)paren
suffix:semicolon
id|__RXACCT
c_func
(paren
id|atomic_dec
c_func
(paren
op_amp
id|rxrpc_connection_count
)paren
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|candidate
)paren
suffix:semicolon
)brace
r_else
(brace
id|down_write
c_func
(paren
op_amp
id|rxrpc_conns_sem
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|conn-&gt;proc_link
comma
op_amp
id|rxrpc_conns
)paren
suffix:semicolon
id|up_write
c_func
(paren
op_amp
id|rxrpc_conns_sem
)paren
suffix:semicolon
)brace
op_star
id|_conn
op_assign
id|conn
suffix:semicolon
id|_leave
c_func
(paren
l_string|&quot; = 0 (%p)&quot;
comma
id|conn
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* handle resurrecting a connection from the graveyard */
id|found_in_graveyard
suffix:colon
id|_debug
c_func
(paren
l_string|&quot;resurrecting connection: {%08x} [out]&quot;
comma
id|ntohl
c_func
(paren
id|conn-&gt;conn_id
)paren
)paren
suffix:semicolon
id|rxrpc_get_connection
c_func
(paren
id|conn
)paren
suffix:semicolon
id|rxrpc_krxtimod_del_timer
c_func
(paren
op_amp
id|conn-&gt;timeout
)paren
suffix:semicolon
id|list_del_init
c_func
(paren
op_amp
id|conn-&gt;link
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|peer-&gt;conn_gylock
)paren
suffix:semicolon
r_goto
id|make_active
suffix:semicolon
)brace
multiline_comment|/* end rxrpc_create_connection() */
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * lookup the connection for an incoming packet&n; * - create a new connection record for unrecorded incoming connections&n; */
DECL|function|rxrpc_connection_lookup
r_int
id|rxrpc_connection_lookup
c_func
(paren
r_struct
id|rxrpc_peer
op_star
id|peer
comma
r_struct
id|rxrpc_message
op_star
id|msg
comma
r_struct
id|rxrpc_connection
op_star
op_star
id|_conn
)paren
(brace
r_struct
id|rxrpc_connection
op_star
id|conn
comma
op_star
id|candidate
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|list_head
op_star
id|_p
suffix:semicolon
r_int
id|ret
comma
id|fresh
op_assign
l_int|0
suffix:semicolon
id|__be32
id|x_epoch
comma
id|x_connid
suffix:semicolon
id|__be16
id|x_port
comma
id|x_servid
suffix:semicolon
id|__u32
id|x_secix
suffix:semicolon
id|u8
id|x_clflag
suffix:semicolon
id|_enter
c_func
(paren
l_string|&quot;%p{{%hu}},%u,%hu&quot;
comma
id|peer
comma
id|peer-&gt;trans-&gt;port
comma
id|ntohs
c_func
(paren
id|msg-&gt;pkt-&gt;h.uh-&gt;source
)paren
comma
id|ntohs
c_func
(paren
id|msg-&gt;hdr.serviceId
)paren
)paren
suffix:semicolon
id|x_port
op_assign
id|msg-&gt;pkt-&gt;h.uh-&gt;source
suffix:semicolon
id|x_epoch
op_assign
id|msg-&gt;hdr.epoch
suffix:semicolon
id|x_clflag
op_assign
id|msg-&gt;hdr.flags
op_amp
id|RXRPC_CLIENT_INITIATED
suffix:semicolon
id|x_connid
op_assign
id|htonl
c_func
(paren
id|ntohl
c_func
(paren
id|msg-&gt;hdr.cid
)paren
op_amp
id|RXRPC_CIDMASK
)paren
suffix:semicolon
id|x_servid
op_assign
id|msg-&gt;hdr.serviceId
suffix:semicolon
id|x_secix
op_assign
id|msg-&gt;hdr.securityIndex
suffix:semicolon
multiline_comment|/* [common case] search the transport&squot;s active list first */
id|read_lock
c_func
(paren
op_amp
id|peer-&gt;conn_lock
)paren
suffix:semicolon
id|list_for_each
c_func
(paren
id|_p
comma
op_amp
id|peer-&gt;conn_active
)paren
(brace
id|conn
op_assign
id|list_entry
c_func
(paren
id|_p
comma
r_struct
id|rxrpc_connection
comma
id|link
)paren
suffix:semicolon
r_if
c_cond
(paren
id|conn-&gt;addr.sin_port
op_eq
id|x_port
op_logical_and
id|conn-&gt;in_epoch
op_eq
id|x_epoch
op_logical_and
id|conn-&gt;conn_id
op_eq
id|x_connid
op_logical_and
id|conn-&gt;security_ix
op_eq
id|x_secix
op_logical_and
id|conn-&gt;service_id
op_eq
id|x_servid
op_logical_and
id|conn-&gt;in_clientflag
op_eq
id|x_clflag
)paren
r_goto
id|found_active
suffix:semicolon
)brace
id|read_unlock
c_func
(paren
op_amp
id|peer-&gt;conn_lock
)paren
suffix:semicolon
multiline_comment|/* [uncommon case] not active &n;&t; * - create a candidate for a new record if an inbound connection&n;&t; * - only examine the graveyard for an outbound connection&n;&t; */
r_if
c_cond
(paren
id|x_clflag
)paren
(brace
id|ret
op_assign
id|__rxrpc_create_connection
c_func
(paren
id|peer
comma
op_amp
id|candidate
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
id|_leave
c_func
(paren
l_string|&quot; = %d&quot;
comma
id|ret
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* fill in the specifics */
id|candidate-&gt;addr.sin_family
op_assign
id|AF_INET
suffix:semicolon
id|candidate-&gt;addr.sin_port
op_assign
id|x_port
suffix:semicolon
id|candidate-&gt;addr.sin_addr.s_addr
op_assign
id|msg-&gt;pkt-&gt;nh.iph-&gt;saddr
suffix:semicolon
id|candidate-&gt;in_epoch
op_assign
id|x_epoch
suffix:semicolon
id|candidate-&gt;out_epoch
op_assign
id|x_epoch
suffix:semicolon
id|candidate-&gt;in_clientflag
op_assign
id|RXRPC_CLIENT_INITIATED
suffix:semicolon
id|candidate-&gt;out_clientflag
op_assign
l_int|0
suffix:semicolon
id|candidate-&gt;conn_id
op_assign
id|x_connid
suffix:semicolon
id|candidate-&gt;service_id
op_assign
id|x_servid
suffix:semicolon
id|candidate-&gt;security_ix
op_assign
id|x_secix
suffix:semicolon
)brace
multiline_comment|/* search the active list again, just in case it appeared whilst we&n;&t; * were busy */
id|write_lock
c_func
(paren
op_amp
id|peer-&gt;conn_lock
)paren
suffix:semicolon
id|list_for_each
c_func
(paren
id|_p
comma
op_amp
id|peer-&gt;conn_active
)paren
(brace
id|conn
op_assign
id|list_entry
c_func
(paren
id|_p
comma
r_struct
id|rxrpc_connection
comma
id|link
)paren
suffix:semicolon
r_if
c_cond
(paren
id|conn-&gt;addr.sin_port
op_eq
id|x_port
op_logical_and
id|conn-&gt;in_epoch
op_eq
id|x_epoch
op_logical_and
id|conn-&gt;conn_id
op_eq
id|x_connid
op_logical_and
id|conn-&gt;security_ix
op_eq
id|x_secix
op_logical_and
id|conn-&gt;service_id
op_eq
id|x_servid
op_logical_and
id|conn-&gt;in_clientflag
op_eq
id|x_clflag
)paren
r_goto
id|found_active_second_chance
suffix:semicolon
)brace
multiline_comment|/* search the transport&squot;s graveyard list */
id|spin_lock
c_func
(paren
op_amp
id|peer-&gt;conn_gylock
)paren
suffix:semicolon
id|list_for_each
c_func
(paren
id|_p
comma
op_amp
id|peer-&gt;conn_graveyard
)paren
(brace
id|conn
op_assign
id|list_entry
c_func
(paren
id|_p
comma
r_struct
id|rxrpc_connection
comma
id|link
)paren
suffix:semicolon
r_if
c_cond
(paren
id|conn-&gt;addr.sin_port
op_eq
id|x_port
op_logical_and
id|conn-&gt;in_epoch
op_eq
id|x_epoch
op_logical_and
id|conn-&gt;conn_id
op_eq
id|x_connid
op_logical_and
id|conn-&gt;security_ix
op_eq
id|x_secix
op_logical_and
id|conn-&gt;service_id
op_eq
id|x_servid
op_logical_and
id|conn-&gt;in_clientflag
op_eq
id|x_clflag
)paren
r_goto
id|found_in_graveyard
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|peer-&gt;conn_gylock
)paren
suffix:semicolon
multiline_comment|/* outbound connections aren&squot;t created here */
r_if
c_cond
(paren
op_logical_neg
id|x_clflag
)paren
(brace
id|write_unlock
c_func
(paren
op_amp
id|peer-&gt;conn_lock
)paren
suffix:semicolon
id|_leave
c_func
(paren
l_string|&quot; = -ENOENT&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOENT
suffix:semicolon
)brace
multiline_comment|/* we can now add the new candidate to the list */
id|_debug
c_func
(paren
l_string|&quot;created connection: {%08x} [in]&quot;
comma
id|ntohl
c_func
(paren
id|candidate-&gt;conn_id
)paren
)paren
suffix:semicolon
id|rxrpc_get_peer
c_func
(paren
id|peer
)paren
suffix:semicolon
id|conn
op_assign
id|candidate
suffix:semicolon
id|candidate
op_assign
l_int|NULL
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|peer-&gt;conn_count
)paren
suffix:semicolon
id|fresh
op_assign
l_int|1
suffix:semicolon
id|make_active
suffix:colon
id|list_add_tail
c_func
(paren
op_amp
id|conn-&gt;link
comma
op_amp
id|peer-&gt;conn_active
)paren
suffix:semicolon
id|success_uwfree
suffix:colon
id|write_unlock
c_func
(paren
op_amp
id|peer-&gt;conn_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|candidate
)paren
(brace
id|write_lock
c_func
(paren
op_amp
id|peer-&gt;conn_idlock
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|candidate-&gt;id_link
)paren
suffix:semicolon
id|write_unlock
c_func
(paren
op_amp
id|peer-&gt;conn_idlock
)paren
suffix:semicolon
id|__RXACCT
c_func
(paren
id|atomic_dec
c_func
(paren
op_amp
id|rxrpc_connection_count
)paren
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|candidate
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fresh
)paren
(brace
id|down_write
c_func
(paren
op_amp
id|rxrpc_conns_sem
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|conn-&gt;proc_link
comma
op_amp
id|rxrpc_conns
)paren
suffix:semicolon
id|up_write
c_func
(paren
op_amp
id|rxrpc_conns_sem
)paren
suffix:semicolon
)brace
id|success
suffix:colon
op_star
id|_conn
op_assign
id|conn
suffix:semicolon
id|_leave
c_func
(paren
l_string|&quot; = 0 (%p)&quot;
comma
id|conn
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* handle the connection being found in the active list straight off */
id|found_active
suffix:colon
id|rxrpc_get_connection
c_func
(paren
id|conn
)paren
suffix:semicolon
id|read_unlock
c_func
(paren
op_amp
id|peer-&gt;conn_lock
)paren
suffix:semicolon
r_goto
id|success
suffix:semicolon
multiline_comment|/* handle resurrecting a connection from the graveyard */
id|found_in_graveyard
suffix:colon
id|_debug
c_func
(paren
l_string|&quot;resurrecting connection: {%08x} [in]&quot;
comma
id|ntohl
c_func
(paren
id|conn-&gt;conn_id
)paren
)paren
suffix:semicolon
id|rxrpc_get_peer
c_func
(paren
id|peer
)paren
suffix:semicolon
id|rxrpc_get_connection
c_func
(paren
id|conn
)paren
suffix:semicolon
id|rxrpc_krxtimod_del_timer
c_func
(paren
op_amp
id|conn-&gt;timeout
)paren
suffix:semicolon
id|list_del_init
c_func
(paren
op_amp
id|conn-&gt;link
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|peer-&gt;conn_gylock
)paren
suffix:semicolon
r_goto
id|make_active
suffix:semicolon
multiline_comment|/* handle finding the connection on the second time through the active&n;&t; * list */
id|found_active_second_chance
suffix:colon
id|rxrpc_get_connection
c_func
(paren
id|conn
)paren
suffix:semicolon
r_goto
id|success_uwfree
suffix:semicolon
)brace
multiline_comment|/* end rxrpc_connection_lookup() */
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * finish using a connection record&n; * - it will be transferred to the peer&squot;s connection graveyard when refcount&n; *   reaches 0&n; */
DECL|function|rxrpc_put_connection
r_void
id|rxrpc_put_connection
c_func
(paren
r_struct
id|rxrpc_connection
op_star
id|conn
)paren
(brace
r_struct
id|rxrpc_peer
op_star
id|peer
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|conn
)paren
r_return
suffix:semicolon
id|_enter
c_func
(paren
l_string|&quot;%p{u=%d p=%hu}&quot;
comma
id|conn
comma
id|atomic_read
c_func
(paren
op_amp
id|conn-&gt;usage
)paren
comma
id|ntohs
c_func
(paren
id|conn-&gt;addr.sin_port
)paren
)paren
suffix:semicolon
id|peer
op_assign
id|conn-&gt;peer
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|peer-&gt;conn_gylock
)paren
suffix:semicolon
multiline_comment|/* sanity check */
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|conn-&gt;usage
)paren
op_le
l_int|0
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|likely
c_func
(paren
op_logical_neg
id|atomic_dec_and_test
c_func
(paren
op_amp
id|conn-&gt;usage
)paren
)paren
)paren
(brace
id|spin_unlock
c_func
(paren
op_amp
id|peer-&gt;conn_gylock
)paren
suffix:semicolon
id|_leave
c_func
(paren
l_string|&quot;&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* move to graveyard queue */
id|_debug
c_func
(paren
l_string|&quot;burying connection: {%08x}&quot;
comma
id|ntohl
c_func
(paren
id|conn-&gt;conn_id
)paren
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|conn-&gt;link
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|conn-&gt;link
comma
op_amp
id|peer-&gt;conn_graveyard
)paren
suffix:semicolon
id|rxrpc_krxtimod_add_timer
c_func
(paren
op_amp
id|conn-&gt;timeout
comma
id|rxrpc_conn_timeout
op_star
id|HZ
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|peer-&gt;conn_gylock
)paren
suffix:semicolon
id|rxrpc_put_peer
c_func
(paren
id|conn-&gt;peer
)paren
suffix:semicolon
id|_leave
c_func
(paren
l_string|&quot; [killed]&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* end rxrpc_put_connection() */
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * free a connection record&n; */
DECL|function|rxrpc_conn_do_timeout
r_static
r_void
id|rxrpc_conn_do_timeout
c_func
(paren
r_struct
id|rxrpc_connection
op_star
id|conn
)paren
(brace
r_struct
id|rxrpc_peer
op_star
id|peer
suffix:semicolon
id|_enter
c_func
(paren
l_string|&quot;%p{u=%d p=%hu}&quot;
comma
id|conn
comma
id|atomic_read
c_func
(paren
op_amp
id|conn-&gt;usage
)paren
comma
id|ntohs
c_func
(paren
id|conn-&gt;addr.sin_port
)paren
)paren
suffix:semicolon
id|peer
op_assign
id|conn-&gt;peer
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|conn-&gt;usage
)paren
OL
l_int|0
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* remove from graveyard if still dead */
id|spin_lock
c_func
(paren
op_amp
id|peer-&gt;conn_gylock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|conn-&gt;usage
)paren
op_eq
l_int|0
)paren
(brace
id|list_del_init
c_func
(paren
op_amp
id|conn-&gt;link
)paren
suffix:semicolon
)brace
r_else
(brace
id|conn
op_assign
l_int|NULL
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|peer-&gt;conn_gylock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|conn
)paren
(brace
id|_leave
c_func
(paren
l_string|&quot;&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
multiline_comment|/* resurrected */
)brace
id|_debug
c_func
(paren
l_string|&quot;--- Destroying Connection %p{%08x} ---&quot;
comma
id|conn
comma
id|ntohl
c_func
(paren
id|conn-&gt;conn_id
)paren
)paren
suffix:semicolon
id|down_write
c_func
(paren
op_amp
id|rxrpc_conns_sem
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|conn-&gt;proc_link
)paren
suffix:semicolon
id|up_write
c_func
(paren
op_amp
id|rxrpc_conns_sem
)paren
suffix:semicolon
id|write_lock
c_func
(paren
op_amp
id|peer-&gt;conn_idlock
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|conn-&gt;id_link
)paren
suffix:semicolon
id|write_unlock
c_func
(paren
op_amp
id|peer-&gt;conn_idlock
)paren
suffix:semicolon
id|__RXACCT
c_func
(paren
id|atomic_dec
c_func
(paren
op_amp
id|rxrpc_connection_count
)paren
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|conn
)paren
suffix:semicolon
multiline_comment|/* if the graveyard is now empty, wake up anyone waiting for that */
r_if
c_cond
(paren
id|atomic_dec_and_test
c_func
(paren
op_amp
id|peer-&gt;conn_count
)paren
)paren
id|wake_up
c_func
(paren
op_amp
id|peer-&gt;conn_gy_waitq
)paren
suffix:semicolon
id|_leave
c_func
(paren
l_string|&quot; [destroyed]&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* end rxrpc_conn_do_timeout() */
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * clear all connection records from a peer endpoint&n; */
DECL|function|rxrpc_conn_clearall
r_void
id|rxrpc_conn_clearall
c_func
(paren
r_struct
id|rxrpc_peer
op_star
id|peer
)paren
(brace
id|DECLARE_WAITQUEUE
c_func
(paren
id|myself
comma
id|current
)paren
suffix:semicolon
r_struct
id|rxrpc_connection
op_star
id|conn
suffix:semicolon
r_int
id|err
suffix:semicolon
id|_enter
c_func
(paren
l_string|&quot;%p&quot;
comma
id|peer
)paren
suffix:semicolon
multiline_comment|/* there shouldn&squot;t be any active conns remaining */
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|peer-&gt;conn_active
)paren
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* manually timeout all conns in the graveyard */
id|spin_lock
c_func
(paren
op_amp
id|peer-&gt;conn_gylock
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|peer-&gt;conn_graveyard
)paren
)paren
(brace
id|conn
op_assign
id|list_entry
c_func
(paren
id|peer-&gt;conn_graveyard.next
comma
r_struct
id|rxrpc_connection
comma
id|link
)paren
suffix:semicolon
id|err
op_assign
id|rxrpc_krxtimod_del_timer
c_func
(paren
op_amp
id|conn-&gt;timeout
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|peer-&gt;conn_gylock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_eq
l_int|0
)paren
id|rxrpc_conn_do_timeout
c_func
(paren
id|conn
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|peer-&gt;conn_gylock
)paren
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|peer-&gt;conn_gylock
)paren
suffix:semicolon
multiline_comment|/* wait for the the conn graveyard to be completely cleared */
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|add_wait_queue
c_func
(paren
op_amp
id|peer-&gt;conn_gy_waitq
comma
op_amp
id|myself
)paren
suffix:semicolon
r_while
c_loop
(paren
id|atomic_read
c_func
(paren
op_amp
id|peer-&gt;conn_count
)paren
op_ne
l_int|0
)paren
(brace
id|schedule
c_func
(paren
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
)brace
id|remove_wait_queue
c_func
(paren
op_amp
id|peer-&gt;conn_gy_waitq
comma
op_amp
id|myself
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_RUNNING
)paren
suffix:semicolon
id|_leave
c_func
(paren
l_string|&quot;&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* end rxrpc_conn_clearall() */
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * allocate and prepare a message for sending out through the transport&n; * endpoint&n; */
DECL|function|rxrpc_conn_newmsg
r_int
id|rxrpc_conn_newmsg
c_func
(paren
r_struct
id|rxrpc_connection
op_star
id|conn
comma
r_struct
id|rxrpc_call
op_star
id|call
comma
r_uint8
id|type
comma
r_int
id|dcount
comma
r_struct
id|kvec
id|diov
(braket
)braket
comma
r_int
id|alloc_flags
comma
r_struct
id|rxrpc_message
op_star
op_star
id|_msg
)paren
(brace
r_struct
id|rxrpc_message
op_star
id|msg
suffix:semicolon
r_int
id|loop
suffix:semicolon
id|_enter
c_func
(paren
l_string|&quot;%p{%d},%p,%u&quot;
comma
id|conn
comma
id|ntohs
c_func
(paren
id|conn-&gt;addr.sin_port
)paren
comma
id|call
comma
id|type
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dcount
OG
l_int|3
)paren
(brace
id|_leave
c_func
(paren
l_string|&quot; = -EINVAL&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|msg
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|rxrpc_message
)paren
comma
id|alloc_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|msg
)paren
(brace
id|_leave
c_func
(paren
l_string|&quot; = -ENOMEM&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|msg
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|msg
)paren
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|msg-&gt;usage
comma
l_int|1
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|msg-&gt;link
)paren
suffix:semicolon
id|msg-&gt;state
op_assign
id|RXRPC_MSG_PREPARED
suffix:semicolon
id|msg-&gt;hdr.epoch
op_assign
id|conn-&gt;out_epoch
suffix:semicolon
id|msg-&gt;hdr.cid
op_assign
id|conn-&gt;conn_id
op_or
(paren
id|call
ques
c_cond
id|call-&gt;chan_ix
suffix:colon
l_int|0
)paren
suffix:semicolon
id|msg-&gt;hdr.callNumber
op_assign
id|call
ques
c_cond
id|call-&gt;call_id
suffix:colon
l_int|0
suffix:semicolon
id|msg-&gt;hdr.type
op_assign
id|type
suffix:semicolon
id|msg-&gt;hdr.flags
op_assign
id|conn-&gt;out_clientflag
suffix:semicolon
id|msg-&gt;hdr.securityIndex
op_assign
id|conn-&gt;security_ix
suffix:semicolon
id|msg-&gt;hdr.serviceId
op_assign
id|conn-&gt;service_id
suffix:semicolon
multiline_comment|/* generate sequence numbers for data packets */
r_if
c_cond
(paren
id|call
)paren
(brace
r_switch
c_cond
(paren
id|type
)paren
(brace
r_case
id|RXRPC_PACKET_TYPE_DATA
suffix:colon
id|msg-&gt;seq
op_assign
op_increment
id|call-&gt;snd_seq_count
suffix:semicolon
id|msg-&gt;hdr.seq
op_assign
id|htonl
c_func
(paren
id|msg-&gt;seq
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|RXRPC_PACKET_TYPE_ACK
suffix:colon
multiline_comment|/* ACK sequence numbers are complicated. The following&n;&t;&t;&t; * may be wrong:&n;&t;&t;&t; * - jumbo packet ACKs should have a seq number&n;&t;&t;&t; * - normal ACKs should not&n;&t;&t;&t; */
r_default
suffix:colon
r_break
suffix:semicolon
)brace
)brace
id|msg-&gt;dcount
op_assign
id|dcount
op_plus
l_int|1
suffix:semicolon
id|msg-&gt;dsize
op_assign
r_sizeof
(paren
id|msg-&gt;hdr
)paren
suffix:semicolon
id|msg-&gt;data
(braket
l_int|0
)braket
dot
id|iov_len
op_assign
r_sizeof
(paren
id|msg-&gt;hdr
)paren
suffix:semicolon
id|msg-&gt;data
(braket
l_int|0
)braket
dot
id|iov_base
op_assign
op_amp
id|msg-&gt;hdr
suffix:semicolon
r_for
c_loop
(paren
id|loop
op_assign
l_int|0
suffix:semicolon
id|loop
OL
id|dcount
suffix:semicolon
id|loop
op_increment
)paren
(brace
id|msg-&gt;dsize
op_add_assign
id|diov
(braket
id|loop
)braket
dot
id|iov_len
suffix:semicolon
id|msg-&gt;data
(braket
id|loop
op_plus
l_int|1
)braket
dot
id|iov_len
op_assign
id|diov
(braket
id|loop
)braket
dot
id|iov_len
suffix:semicolon
id|msg-&gt;data
(braket
id|loop
op_plus
l_int|1
)braket
dot
id|iov_base
op_assign
id|diov
(braket
id|loop
)braket
dot
id|iov_base
suffix:semicolon
)brace
id|__RXACCT
c_func
(paren
id|atomic_inc
c_func
(paren
op_amp
id|rxrpc_message_count
)paren
)paren
suffix:semicolon
op_star
id|_msg
op_assign
id|msg
suffix:semicolon
id|_leave
c_func
(paren
l_string|&quot; = 0 (%p) #%d&quot;
comma
id|msg
comma
id|atomic_read
c_func
(paren
op_amp
id|rxrpc_message_count
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* end rxrpc_conn_newmsg() */
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * free a message&n; */
DECL|function|__rxrpc_put_message
r_void
id|__rxrpc_put_message
c_func
(paren
r_struct
id|rxrpc_message
op_star
id|msg
)paren
(brace
r_int
id|loop
suffix:semicolon
id|_enter
c_func
(paren
l_string|&quot;%p #%d&quot;
comma
id|msg
comma
id|atomic_read
c_func
(paren
op_amp
id|rxrpc_message_count
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|msg-&gt;pkt
)paren
id|kfree_skb
c_func
(paren
id|msg-&gt;pkt
)paren
suffix:semicolon
id|rxrpc_put_connection
c_func
(paren
id|msg-&gt;conn
)paren
suffix:semicolon
r_for
c_loop
(paren
id|loop
op_assign
l_int|0
suffix:semicolon
id|loop
OL
l_int|8
suffix:semicolon
id|loop
op_increment
)paren
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|loop
comma
op_amp
id|msg-&gt;dfree
)paren
)paren
id|kfree
c_func
(paren
id|msg-&gt;data
(braket
id|loop
)braket
dot
id|iov_base
)paren
suffix:semicolon
id|__RXACCT
c_func
(paren
id|atomic_dec
c_func
(paren
op_amp
id|rxrpc_message_count
)paren
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|msg
)paren
suffix:semicolon
id|_leave
c_func
(paren
l_string|&quot;&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* end __rxrpc_put_message() */
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * send a message out through the transport endpoint&n; */
DECL|function|rxrpc_conn_sendmsg
r_int
id|rxrpc_conn_sendmsg
c_func
(paren
r_struct
id|rxrpc_connection
op_star
id|conn
comma
r_struct
id|rxrpc_message
op_star
id|msg
)paren
(brace
r_struct
id|msghdr
id|msghdr
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|_enter
c_func
(paren
l_string|&quot;%p{%d}&quot;
comma
id|conn
comma
id|ntohs
c_func
(paren
id|conn-&gt;addr.sin_port
)paren
)paren
suffix:semicolon
multiline_comment|/* fill in some fields in the header */
id|spin_lock
c_func
(paren
op_amp
id|conn-&gt;lock
)paren
suffix:semicolon
id|msg-&gt;hdr.serial
op_assign
id|htonl
c_func
(paren
op_increment
id|conn-&gt;serial_counter
)paren
suffix:semicolon
id|msg-&gt;rttdone
op_assign
l_int|0
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|conn-&gt;lock
)paren
suffix:semicolon
multiline_comment|/* set up the message to be transmitted */
id|msghdr.msg_name
op_assign
op_amp
id|conn-&gt;addr
suffix:semicolon
id|msghdr.msg_namelen
op_assign
r_sizeof
(paren
id|conn-&gt;addr
)paren
suffix:semicolon
id|msghdr.msg_control
op_assign
l_int|NULL
suffix:semicolon
id|msghdr.msg_controllen
op_assign
l_int|0
suffix:semicolon
id|msghdr.msg_flags
op_assign
id|MSG_CONFIRM
op_or
id|MSG_DONTWAIT
suffix:semicolon
id|_net
c_func
(paren
l_string|&quot;Sending message type %d of %Zd bytes to %08x:%d&quot;
comma
id|msg-&gt;hdr.type
comma
id|msg-&gt;dsize
comma
id|ntohl
c_func
(paren
id|conn-&gt;addr.sin_addr.s_addr
)paren
comma
id|ntohs
c_func
(paren
id|conn-&gt;addr.sin_port
)paren
)paren
suffix:semicolon
multiline_comment|/* send the message */
id|ret
op_assign
id|kernel_sendmsg
c_func
(paren
id|conn-&gt;trans-&gt;socket
comma
op_amp
id|msghdr
comma
id|msg-&gt;data
comma
id|msg-&gt;dcount
comma
id|msg-&gt;dsize
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
id|msg-&gt;state
op_assign
id|RXRPC_MSG_ERROR
suffix:semicolon
)brace
r_else
(brace
id|msg-&gt;state
op_assign
id|RXRPC_MSG_SENT
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|conn-&gt;lock
)paren
suffix:semicolon
id|do_gettimeofday
c_func
(paren
op_amp
id|conn-&gt;atime
)paren
suffix:semicolon
id|msg-&gt;stamp
op_assign
id|conn-&gt;atime
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|conn-&gt;lock
)paren
suffix:semicolon
)brace
id|_leave
c_func
(paren
l_string|&quot; = %d&quot;
comma
id|ret
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* end rxrpc_conn_sendmsg() */
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * deal with a subsequent call packet&n; */
DECL|function|rxrpc_conn_receive_call_packet
r_int
id|rxrpc_conn_receive_call_packet
c_func
(paren
r_struct
id|rxrpc_connection
op_star
id|conn
comma
r_struct
id|rxrpc_call
op_star
id|call
comma
r_struct
id|rxrpc_message
op_star
id|msg
)paren
(brace
r_struct
id|rxrpc_message
op_star
id|pmsg
suffix:semicolon
r_struct
id|list_head
op_star
id|_p
suffix:semicolon
r_int
id|cix
comma
id|seq
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
id|_enter
c_func
(paren
l_string|&quot;%p,%p,%p&quot;
comma
id|conn
comma
id|call
comma
id|msg
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|call
)paren
(brace
id|cix
op_assign
id|ntohl
c_func
(paren
id|msg-&gt;hdr.cid
)paren
op_amp
id|RXRPC_CHANNELMASK
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|conn-&gt;lock
)paren
suffix:semicolon
id|call
op_assign
id|conn-&gt;channels
(braket
id|cix
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|call
op_logical_or
id|call-&gt;call_id
op_ne
id|msg-&gt;hdr.callNumber
)paren
(brace
id|spin_unlock
c_func
(paren
op_amp
id|conn-&gt;lock
)paren
suffix:semicolon
id|rxrpc_trans_immediate_abort
c_func
(paren
id|conn-&gt;trans
comma
id|msg
comma
op_minus
id|ENOENT
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_else
(brace
id|rxrpc_get_call
c_func
(paren
id|call
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|conn-&gt;lock
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|rxrpc_get_call
c_func
(paren
id|call
)paren
suffix:semicolon
)brace
id|_proto
c_func
(paren
l_string|&quot;Received packet %%%u [%u] on call %hu:%u:%u&quot;
comma
id|ntohl
c_func
(paren
id|msg-&gt;hdr.serial
)paren
comma
id|ntohl
c_func
(paren
id|msg-&gt;hdr.seq
)paren
comma
id|ntohs
c_func
(paren
id|msg-&gt;hdr.serviceId
)paren
comma
id|ntohl
c_func
(paren
id|conn-&gt;conn_id
)paren
comma
id|ntohl
c_func
(paren
id|call-&gt;call_id
)paren
)paren
suffix:semicolon
id|call-&gt;pkt_rcv_count
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|msg-&gt;pkt-&gt;dst
op_logical_and
id|msg-&gt;pkt-&gt;dst-&gt;dev
)paren
id|conn-&gt;peer-&gt;if_mtu
op_assign
id|msg-&gt;pkt-&gt;dst-&gt;dev-&gt;mtu
op_minus
id|msg-&gt;pkt-&gt;dst-&gt;dev-&gt;hard_header_len
suffix:semicolon
multiline_comment|/* queue on the call in seq order */
id|rxrpc_get_message
c_func
(paren
id|msg
)paren
suffix:semicolon
id|seq
op_assign
id|msg-&gt;seq
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|call-&gt;lock
)paren
suffix:semicolon
id|list_for_each
c_func
(paren
id|_p
comma
op_amp
id|call-&gt;rcv_receiveq
)paren
(brace
id|pmsg
op_assign
id|list_entry
c_func
(paren
id|_p
comma
r_struct
id|rxrpc_message
comma
id|link
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pmsg-&gt;seq
OG
id|seq
)paren
r_break
suffix:semicolon
)brace
id|list_add_tail
c_func
(paren
op_amp
id|msg-&gt;link
comma
id|_p
)paren
suffix:semicolon
multiline_comment|/* reset the activity timeout */
id|call-&gt;flags
op_or_assign
id|RXRPC_CALL_RCV_PKT
suffix:semicolon
id|mod_timer
c_func
(paren
op_amp
id|call-&gt;rcv_timeout
comma
id|jiffies
op_plus
id|rxrpc_call_rcv_timeout
op_star
id|HZ
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|call-&gt;lock
)paren
suffix:semicolon
id|rxrpc_krxiod_queue_call
c_func
(paren
id|call
)paren
suffix:semicolon
id|rxrpc_put_call
c_func
(paren
id|call
)paren
suffix:semicolon
id|out
suffix:colon
id|_leave
c_func
(paren
l_string|&quot; = %d&quot;
comma
id|ret
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* end rxrpc_conn_receive_call_packet() */
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * handle an ICMP error being applied to a connection&n; */
DECL|function|rxrpc_conn_handle_error
r_void
id|rxrpc_conn_handle_error
c_func
(paren
r_struct
id|rxrpc_connection
op_star
id|conn
comma
r_int
id|local
comma
r_int
id|errno
)paren
(brace
r_struct
id|rxrpc_call
op_star
id|calls
(braket
l_int|4
)braket
suffix:semicolon
r_int
id|loop
suffix:semicolon
id|_enter
c_func
(paren
l_string|&quot;%p{%d},%d&quot;
comma
id|conn
comma
id|ntohs
c_func
(paren
id|conn-&gt;addr.sin_port
)paren
comma
id|errno
)paren
suffix:semicolon
multiline_comment|/* get a ref to all my calls in one go */
id|memset
c_func
(paren
id|calls
comma
l_int|0
comma
r_sizeof
(paren
id|calls
)paren
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|conn-&gt;lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|loop
op_assign
l_int|3
suffix:semicolon
id|loop
op_ge
l_int|0
suffix:semicolon
id|loop
op_decrement
)paren
(brace
r_if
c_cond
(paren
id|conn-&gt;channels
(braket
id|loop
)braket
)paren
(brace
id|calls
(braket
id|loop
)braket
op_assign
id|conn-&gt;channels
(braket
id|loop
)braket
suffix:semicolon
id|rxrpc_get_call
c_func
(paren
id|calls
(braket
id|loop
)braket
)paren
suffix:semicolon
)brace
)brace
id|spin_unlock
c_func
(paren
op_amp
id|conn-&gt;lock
)paren
suffix:semicolon
multiline_comment|/* now kick them all */
r_for
c_loop
(paren
id|loop
op_assign
l_int|3
suffix:semicolon
id|loop
op_ge
l_int|0
suffix:semicolon
id|loop
op_decrement
)paren
(brace
r_if
c_cond
(paren
id|calls
(braket
id|loop
)braket
)paren
(brace
id|rxrpc_call_handle_error
c_func
(paren
id|calls
(braket
id|loop
)braket
comma
id|local
comma
id|errno
)paren
suffix:semicolon
id|rxrpc_put_call
c_func
(paren
id|calls
(braket
id|loop
)braket
)paren
suffix:semicolon
)brace
)brace
id|_leave
c_func
(paren
l_string|&quot;&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* end rxrpc_conn_handle_error() */
eof
