multiline_comment|/* call.c: Rx call routines&n; *&n; * Copyright (C) 2002 Red Hat, Inc. All Rights Reserved.&n; * Written by David Howells (dhowells@redhat.com)&n; *&n; * This program is free software; you can redistribute it and/or&n; * modify it under the terms of the GNU General Public License&n; * as published by the Free Software Foundation; either version&n; * 2 of the License, or (at your option) any later version.&n; */
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;rxrpc/rxrpc.h&gt;
macro_line|#include &lt;rxrpc/transport.h&gt;
macro_line|#include &lt;rxrpc/peer.h&gt;
macro_line|#include &lt;rxrpc/connection.h&gt;
macro_line|#include &lt;rxrpc/call.h&gt;
macro_line|#include &lt;rxrpc/message.h&gt;
macro_line|#include &quot;internal.h&quot;
DECL|variable|rxrpc_call_count
id|__RXACCT_DECL
c_func
(paren
id|atomic_t
id|rxrpc_call_count
)paren
suffix:semicolon
DECL|variable|rxrpc_message_count
id|__RXACCT_DECL
c_func
(paren
id|atomic_t
id|rxrpc_message_count
)paren
suffix:semicolon
DECL|variable|rxrpc_calls
id|LIST_HEAD
c_func
(paren
id|rxrpc_calls
)paren
suffix:semicolon
DECL|variable|rxrpc_calls_sem
id|DECLARE_RWSEM
c_func
(paren
id|rxrpc_calls_sem
)paren
suffix:semicolon
DECL|variable|rxrpc_call_rcv_timeout
r_int
id|rxrpc_call_rcv_timeout
op_assign
id|HZ
op_div
l_int|3
suffix:semicolon
DECL|variable|rxrpc_call_acks_timeout
r_static
r_int
id|rxrpc_call_acks_timeout
op_assign
id|HZ
op_div
l_int|3
suffix:semicolon
DECL|variable|rxrpc_call_dfr_ack_timeout
r_static
r_int
id|rxrpc_call_dfr_ack_timeout
op_assign
id|HZ
op_div
l_int|20
suffix:semicolon
DECL|variable|rxrpc_call_max_resend
r_static
r_int
r_int
id|rxrpc_call_max_resend
op_assign
id|HZ
op_div
l_int|10
suffix:semicolon
DECL|variable|rxrpc_call_states
r_const
r_char
op_star
id|rxrpc_call_states
(braket
)braket
op_assign
(brace
l_string|&quot;COMPLETE&quot;
comma
l_string|&quot;ERROR&quot;
comma
l_string|&quot;SRVR_RCV_OPID&quot;
comma
l_string|&quot;SRVR_RCV_ARGS&quot;
comma
l_string|&quot;SRVR_GOT_ARGS&quot;
comma
l_string|&quot;SRVR_SND_REPLY&quot;
comma
l_string|&quot;SRVR_RCV_FINAL_ACK&quot;
comma
l_string|&quot;CLNT_SND_ARGS&quot;
comma
l_string|&quot;CLNT_RCV_REPLY&quot;
comma
l_string|&quot;CLNT_GOT_REPLY&quot;
)brace
suffix:semicolon
DECL|variable|rxrpc_call_error_states
r_const
r_char
op_star
id|rxrpc_call_error_states
(braket
)braket
op_assign
(brace
l_string|&quot;NO_ERROR&quot;
comma
l_string|&quot;LOCAL_ABORT&quot;
comma
l_string|&quot;PEER_ABORT&quot;
comma
l_string|&quot;LOCAL_ERROR&quot;
comma
l_string|&quot;REMOTE_ERROR&quot;
)brace
suffix:semicolon
DECL|variable|rxrpc_pkts
r_const
r_char
op_star
id|rxrpc_pkts
(braket
)braket
op_assign
(brace
l_string|&quot;?00&quot;
comma
l_string|&quot;data&quot;
comma
l_string|&quot;ack&quot;
comma
l_string|&quot;busy&quot;
comma
l_string|&quot;abort&quot;
comma
l_string|&quot;ackall&quot;
comma
l_string|&quot;chall&quot;
comma
l_string|&quot;resp&quot;
comma
l_string|&quot;debug&quot;
comma
l_string|&quot;?09&quot;
comma
l_string|&quot;?10&quot;
comma
l_string|&quot;?11&quot;
comma
l_string|&quot;?12&quot;
comma
l_string|&quot;?13&quot;
comma
l_string|&quot;?14&quot;
comma
l_string|&quot;?15&quot;
)brace
suffix:semicolon
DECL|variable|rxrpc_acks
r_static
r_const
r_char
op_star
id|rxrpc_acks
(braket
)braket
op_assign
(brace
l_string|&quot;---&quot;
comma
l_string|&quot;REQ&quot;
comma
l_string|&quot;DUP&quot;
comma
l_string|&quot;SEQ&quot;
comma
l_string|&quot;WIN&quot;
comma
l_string|&quot;MEM&quot;
comma
l_string|&quot;PNG&quot;
comma
l_string|&quot;PNR&quot;
comma
l_string|&quot;DLY&quot;
comma
l_string|&quot;IDL&quot;
comma
l_string|&quot;-?-&quot;
)brace
suffix:semicolon
DECL|variable|_acktype
r_static
r_const
r_char
id|_acktype
(braket
)braket
op_assign
l_string|&quot;NA-&quot;
suffix:semicolon
r_static
r_void
id|rxrpc_call_receive_packet
c_func
(paren
r_struct
id|rxrpc_call
op_star
id|call
)paren
suffix:semicolon
r_static
r_void
id|rxrpc_call_receive_data_packet
c_func
(paren
r_struct
id|rxrpc_call
op_star
id|call
comma
r_struct
id|rxrpc_message
op_star
id|msg
)paren
suffix:semicolon
r_static
r_void
id|rxrpc_call_receive_ack_packet
c_func
(paren
r_struct
id|rxrpc_call
op_star
id|call
comma
r_struct
id|rxrpc_message
op_star
id|msg
)paren
suffix:semicolon
r_static
r_void
id|rxrpc_call_definitively_ACK
c_func
(paren
r_struct
id|rxrpc_call
op_star
id|call
comma
id|rxrpc_seq_t
id|higest
)paren
suffix:semicolon
r_static
r_void
id|rxrpc_call_resend
c_func
(paren
r_struct
id|rxrpc_call
op_star
id|call
comma
id|rxrpc_seq_t
id|highest
)paren
suffix:semicolon
r_static
r_int
id|__rxrpc_call_read_data
c_func
(paren
r_struct
id|rxrpc_call
op_star
id|call
)paren
suffix:semicolon
r_static
r_int
id|rxrpc_call_record_ACK
c_func
(paren
r_struct
id|rxrpc_call
op_star
id|call
comma
r_struct
id|rxrpc_message
op_star
id|msg
comma
id|rxrpc_seq_t
id|seq
comma
r_int
id|count
)paren
suffix:semicolon
r_static
r_int
id|rxrpc_call_flush
c_func
(paren
r_struct
id|rxrpc_call
op_star
id|call
)paren
suffix:semicolon
DECL|macro|_state
mdefine_line|#define _state(call) &bslash;&n;&t;_debug(&quot;[[[ state %s ]]]&quot;, rxrpc_call_states[call-&gt;app_call_state]);
DECL|function|rxrpc_call_default_attn_func
r_static
r_void
id|rxrpc_call_default_attn_func
c_func
(paren
r_struct
id|rxrpc_call
op_star
id|call
)paren
(brace
id|wake_up
c_func
(paren
op_amp
id|call-&gt;waitq
)paren
suffix:semicolon
)brace
DECL|function|rxrpc_call_default_error_func
r_static
r_void
id|rxrpc_call_default_error_func
c_func
(paren
r_struct
id|rxrpc_call
op_star
id|call
)paren
(brace
id|wake_up
c_func
(paren
op_amp
id|call-&gt;waitq
)paren
suffix:semicolon
)brace
DECL|function|rxrpc_call_default_aemap_func
r_static
r_void
id|rxrpc_call_default_aemap_func
c_func
(paren
r_struct
id|rxrpc_call
op_star
id|call
)paren
(brace
r_switch
c_cond
(paren
id|call-&gt;app_err_state
)paren
(brace
r_case
id|RXRPC_ESTATE_LOCAL_ABORT
suffix:colon
id|call-&gt;app_abort_code
op_assign
op_minus
id|call-&gt;app_errno
suffix:semicolon
r_case
id|RXRPC_ESTATE_PEER_ABORT
suffix:colon
id|call-&gt;app_errno
op_assign
op_minus
id|ECONNABORTED
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
)brace
DECL|function|__rxrpc_call_acks_timeout
r_static
r_void
id|__rxrpc_call_acks_timeout
c_func
(paren
r_int
r_int
id|_call
)paren
(brace
r_struct
id|rxrpc_call
op_star
id|call
op_assign
(paren
r_struct
id|rxrpc_call
op_star
)paren
id|_call
suffix:semicolon
id|_debug
c_func
(paren
l_string|&quot;ACKS TIMEOUT %05lu&quot;
comma
id|jiffies
op_minus
id|call-&gt;cjif
)paren
suffix:semicolon
id|call-&gt;flags
op_or_assign
id|RXRPC_CALL_ACKS_TIMO
suffix:semicolon
id|rxrpc_krxiod_queue_call
c_func
(paren
id|call
)paren
suffix:semicolon
)brace
DECL|function|__rxrpc_call_rcv_timeout
r_static
r_void
id|__rxrpc_call_rcv_timeout
c_func
(paren
r_int
r_int
id|_call
)paren
(brace
r_struct
id|rxrpc_call
op_star
id|call
op_assign
(paren
r_struct
id|rxrpc_call
op_star
)paren
id|_call
suffix:semicolon
id|_debug
c_func
(paren
l_string|&quot;RCV TIMEOUT %05lu&quot;
comma
id|jiffies
op_minus
id|call-&gt;cjif
)paren
suffix:semicolon
id|call-&gt;flags
op_or_assign
id|RXRPC_CALL_RCV_TIMO
suffix:semicolon
id|rxrpc_krxiod_queue_call
c_func
(paren
id|call
)paren
suffix:semicolon
)brace
DECL|function|__rxrpc_call_ackr_timeout
r_static
r_void
id|__rxrpc_call_ackr_timeout
c_func
(paren
r_int
r_int
id|_call
)paren
(brace
r_struct
id|rxrpc_call
op_star
id|call
op_assign
(paren
r_struct
id|rxrpc_call
op_star
)paren
id|_call
suffix:semicolon
id|_debug
c_func
(paren
l_string|&quot;ACKR TIMEOUT %05lu&quot;
comma
id|jiffies
op_minus
id|call-&gt;cjif
)paren
suffix:semicolon
id|call-&gt;flags
op_or_assign
id|RXRPC_CALL_ACKR_TIMO
suffix:semicolon
id|rxrpc_krxiod_queue_call
c_func
(paren
id|call
)paren
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * calculate a timeout based on an RTT value&n; */
DECL|function|__rxrpc_rtt_based_timeout
r_static
r_inline
r_int
r_int
id|__rxrpc_rtt_based_timeout
c_func
(paren
r_struct
id|rxrpc_call
op_star
id|call
comma
r_int
r_int
id|val
)paren
(brace
r_int
r_int
id|expiry
op_assign
id|call-&gt;conn-&gt;peer-&gt;rtt
op_div
(paren
l_int|1000000
op_div
id|HZ
)paren
suffix:semicolon
id|expiry
op_add_assign
l_int|10
suffix:semicolon
r_if
c_cond
(paren
id|expiry
OL
id|HZ
op_div
l_int|25
)paren
id|expiry
op_assign
id|HZ
op_div
l_int|25
suffix:semicolon
r_if
c_cond
(paren
id|expiry
OG
id|HZ
)paren
id|expiry
op_assign
id|HZ
suffix:semicolon
id|_leave
c_func
(paren
l_string|&quot; = %lu jiffies&quot;
comma
id|expiry
)paren
suffix:semicolon
r_return
id|jiffies
op_plus
id|expiry
suffix:semicolon
)brace
multiline_comment|/* end __rxrpc_rtt_based_timeout() */
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * create a new call record&n; */
DECL|function|__rxrpc_create_call
r_static
r_inline
r_int
id|__rxrpc_create_call
c_func
(paren
r_struct
id|rxrpc_connection
op_star
id|conn
comma
r_struct
id|rxrpc_call
op_star
op_star
id|_call
)paren
(brace
r_struct
id|rxrpc_call
op_star
id|call
suffix:semicolon
id|_enter
c_func
(paren
l_string|&quot;%p&quot;
comma
id|conn
)paren
suffix:semicolon
multiline_comment|/* allocate and initialise a call record */
id|call
op_assign
(paren
r_struct
id|rxrpc_call
op_star
)paren
id|get_zeroed_page
c_func
(paren
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|call
)paren
(brace
id|_leave
c_func
(paren
l_string|&quot; ENOMEM&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|atomic_set
c_func
(paren
op_amp
id|call-&gt;usage
comma
l_int|1
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|call-&gt;waitq
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|call-&gt;lock
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|call-&gt;link
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|call-&gt;acks_pendq
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|call-&gt;rcv_receiveq
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|call-&gt;rcv_krxiodq_lk
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|call-&gt;app_readyq
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|call-&gt;app_unreadyq
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|call-&gt;app_link
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|call-&gt;app_attn_link
)paren
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|call-&gt;acks_timeout
)paren
suffix:semicolon
id|call-&gt;acks_timeout.data
op_assign
(paren
r_int
r_int
)paren
id|call
suffix:semicolon
id|call-&gt;acks_timeout.function
op_assign
id|__rxrpc_call_acks_timeout
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|call-&gt;rcv_timeout
)paren
suffix:semicolon
id|call-&gt;rcv_timeout.data
op_assign
(paren
r_int
r_int
)paren
id|call
suffix:semicolon
id|call-&gt;rcv_timeout.function
op_assign
id|__rxrpc_call_rcv_timeout
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|call-&gt;ackr_dfr_timo
)paren
suffix:semicolon
id|call-&gt;ackr_dfr_timo.data
op_assign
(paren
r_int
r_int
)paren
id|call
suffix:semicolon
id|call-&gt;ackr_dfr_timo.function
op_assign
id|__rxrpc_call_ackr_timeout
suffix:semicolon
id|call-&gt;conn
op_assign
id|conn
suffix:semicolon
id|call-&gt;ackr_win_bot
op_assign
l_int|1
suffix:semicolon
id|call-&gt;ackr_win_top
op_assign
id|call-&gt;ackr_win_bot
op_plus
id|RXRPC_CALL_ACK_WINDOW_SIZE
op_minus
l_int|1
suffix:semicolon
id|call-&gt;ackr_prev_seq
op_assign
l_int|0
suffix:semicolon
id|call-&gt;app_mark
op_assign
id|RXRPC_APP_MARK_EOF
suffix:semicolon
id|call-&gt;app_attn_func
op_assign
id|rxrpc_call_default_attn_func
suffix:semicolon
id|call-&gt;app_error_func
op_assign
id|rxrpc_call_default_error_func
suffix:semicolon
id|call-&gt;app_aemap_func
op_assign
id|rxrpc_call_default_aemap_func
suffix:semicolon
id|call-&gt;app_scr_alloc
op_assign
id|call-&gt;app_scratch
suffix:semicolon
id|call-&gt;cjif
op_assign
id|jiffies
suffix:semicolon
id|_leave
c_func
(paren
l_string|&quot; = 0 (%p)&quot;
comma
id|call
)paren
suffix:semicolon
op_star
id|_call
op_assign
id|call
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* end __rxrpc_create_call() */
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * create a new call record for outgoing calls&n; */
DECL|function|rxrpc_create_call
r_int
id|rxrpc_create_call
c_func
(paren
r_struct
id|rxrpc_connection
op_star
id|conn
comma
id|rxrpc_call_attn_func_t
id|attn
comma
id|rxrpc_call_error_func_t
id|error
comma
id|rxrpc_call_aemap_func_t
id|aemap
comma
r_struct
id|rxrpc_call
op_star
op_star
id|_call
)paren
(brace
id|DECLARE_WAITQUEUE
c_func
(paren
id|myself
comma
id|current
)paren
suffix:semicolon
r_struct
id|rxrpc_call
op_star
id|call
suffix:semicolon
r_int
id|ret
comma
id|cix
comma
id|loop
suffix:semicolon
id|_enter
c_func
(paren
l_string|&quot;%p&quot;
comma
id|conn
)paren
suffix:semicolon
multiline_comment|/* allocate and initialise a call record */
id|ret
op_assign
id|__rxrpc_create_call
c_func
(paren
id|conn
comma
op_amp
id|call
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
id|_leave
c_func
(paren
l_string|&quot; = %d&quot;
comma
id|ret
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
id|call-&gt;app_call_state
op_assign
id|RXRPC_CSTATE_CLNT_SND_ARGS
suffix:semicolon
r_if
c_cond
(paren
id|attn
)paren
id|call-&gt;app_attn_func
op_assign
id|attn
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
id|call-&gt;app_error_func
op_assign
id|error
suffix:semicolon
r_if
c_cond
(paren
id|aemap
)paren
id|call-&gt;app_aemap_func
op_assign
id|aemap
suffix:semicolon
id|_state
c_func
(paren
id|call
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|conn-&gt;lock
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|add_wait_queue
c_func
(paren
op_amp
id|conn-&gt;chanwait
comma
op_amp
id|myself
)paren
suffix:semicolon
id|try_again
suffix:colon
multiline_comment|/* try to find an unused channel */
r_for
c_loop
(paren
id|cix
op_assign
l_int|0
suffix:semicolon
id|cix
OL
l_int|4
suffix:semicolon
id|cix
op_increment
)paren
r_if
c_cond
(paren
op_logical_neg
id|conn-&gt;channels
(braket
id|cix
)braket
)paren
r_goto
id|obtained_chan
suffix:semicolon
multiline_comment|/* no free channels - wait for one to become available */
id|ret
op_assign
op_minus
id|EINTR
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
r_goto
id|error_unwait
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|conn-&gt;lock
)paren
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|conn-&gt;lock
)paren
suffix:semicolon
r_goto
id|try_again
suffix:semicolon
multiline_comment|/* got a channel - now attach to the connection */
id|obtained_chan
suffix:colon
id|remove_wait_queue
c_func
(paren
op_amp
id|conn-&gt;chanwait
comma
op_amp
id|myself
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_RUNNING
)paren
suffix:semicolon
multiline_comment|/* concoct a unique call number */
id|next_callid
suffix:colon
id|call-&gt;call_id
op_assign
id|htonl
c_func
(paren
op_increment
id|conn-&gt;call_counter
)paren
suffix:semicolon
r_for
c_loop
(paren
id|loop
op_assign
l_int|0
suffix:semicolon
id|loop
OL
l_int|4
suffix:semicolon
id|loop
op_increment
)paren
r_if
c_cond
(paren
id|conn-&gt;channels
(braket
id|loop
)braket
op_logical_and
id|conn-&gt;channels
(braket
id|loop
)braket
op_member_access_from_pointer
id|call_id
op_eq
id|call-&gt;call_id
)paren
r_goto
id|next_callid
suffix:semicolon
id|rxrpc_get_connection
c_func
(paren
id|conn
)paren
suffix:semicolon
id|conn-&gt;channels
(braket
id|cix
)braket
op_assign
id|call
suffix:semicolon
multiline_comment|/* assign _after_ done callid check loop */
id|do_gettimeofday
c_func
(paren
op_amp
id|conn-&gt;atime
)paren
suffix:semicolon
id|call-&gt;chan_ix
op_assign
id|htonl
c_func
(paren
id|cix
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|conn-&gt;lock
)paren
suffix:semicolon
id|down_write
c_func
(paren
op_amp
id|rxrpc_calls_sem
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|call-&gt;call_link
comma
op_amp
id|rxrpc_calls
)paren
suffix:semicolon
id|up_write
c_func
(paren
op_amp
id|rxrpc_calls_sem
)paren
suffix:semicolon
id|__RXACCT
c_func
(paren
id|atomic_inc
c_func
(paren
op_amp
id|rxrpc_call_count
)paren
)paren
suffix:semicolon
op_star
id|_call
op_assign
id|call
suffix:semicolon
id|_leave
c_func
(paren
l_string|&quot; = 0 (call=%p cix=%u)&quot;
comma
id|call
comma
id|cix
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|error_unwait
suffix:colon
id|remove_wait_queue
c_func
(paren
op_amp
id|conn-&gt;chanwait
comma
op_amp
id|myself
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_RUNNING
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|conn-&gt;lock
)paren
suffix:semicolon
id|free_page
c_func
(paren
(paren
r_int
r_int
)paren
id|call
)paren
suffix:semicolon
id|_leave
c_func
(paren
l_string|&quot; = %d&quot;
comma
id|ret
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* end rxrpc_create_call() */
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * create a new call record for incoming calls&n; */
DECL|function|rxrpc_incoming_call
r_int
id|rxrpc_incoming_call
c_func
(paren
r_struct
id|rxrpc_connection
op_star
id|conn
comma
r_struct
id|rxrpc_message
op_star
id|msg
comma
r_struct
id|rxrpc_call
op_star
op_star
id|_call
)paren
(brace
r_struct
id|rxrpc_call
op_star
id|call
suffix:semicolon
r_int
id|cix
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|cix
op_assign
id|ntohl
c_func
(paren
id|msg-&gt;hdr.cid
)paren
op_amp
id|RXRPC_CHANNELMASK
suffix:semicolon
id|_enter
c_func
(paren
l_string|&quot;%p,%u,%u&quot;
comma
id|conn
comma
id|ntohl
c_func
(paren
id|msg-&gt;hdr.callNumber
)paren
comma
id|cix
)paren
suffix:semicolon
multiline_comment|/* allocate and initialise a call record */
id|ret
op_assign
id|__rxrpc_create_call
c_func
(paren
id|conn
comma
op_amp
id|call
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
id|_leave
c_func
(paren
l_string|&quot; = %d&quot;
comma
id|ret
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
id|call-&gt;pkt_rcv_count
op_assign
l_int|1
suffix:semicolon
id|call-&gt;app_call_state
op_assign
id|RXRPC_CSTATE_SRVR_RCV_OPID
suffix:semicolon
id|call-&gt;app_mark
op_assign
r_sizeof
(paren
r_uint32
)paren
suffix:semicolon
id|_state
c_func
(paren
id|call
)paren
suffix:semicolon
multiline_comment|/* attach to the connection */
id|ret
op_assign
op_minus
id|EBUSY
suffix:semicolon
id|call-&gt;chan_ix
op_assign
id|htonl
c_func
(paren
id|cix
)paren
suffix:semicolon
id|call-&gt;call_id
op_assign
id|msg-&gt;hdr.callNumber
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|conn-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|conn-&gt;channels
(braket
id|cix
)braket
op_logical_or
id|conn-&gt;channels
(braket
id|cix
)braket
op_member_access_from_pointer
id|app_call_state
op_eq
id|RXRPC_CSTATE_COMPLETE
op_logical_or
id|conn-&gt;channels
(braket
id|cix
)braket
op_member_access_from_pointer
id|app_call_state
op_eq
id|RXRPC_CSTATE_ERROR
)paren
(brace
id|conn-&gt;channels
(braket
id|cix
)braket
op_assign
id|call
suffix:semicolon
id|rxrpc_get_connection
c_func
(paren
id|conn
)paren
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|conn-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
id|free_page
c_func
(paren
(paren
r_int
r_int
)paren
id|call
)paren
suffix:semicolon
id|call
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ret
op_eq
l_int|0
)paren
(brace
id|down_write
c_func
(paren
op_amp
id|rxrpc_calls_sem
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|call-&gt;call_link
comma
op_amp
id|rxrpc_calls
)paren
suffix:semicolon
id|up_write
c_func
(paren
op_amp
id|rxrpc_calls_sem
)paren
suffix:semicolon
id|__RXACCT
c_func
(paren
id|atomic_inc
c_func
(paren
op_amp
id|rxrpc_call_count
)paren
)paren
suffix:semicolon
op_star
id|_call
op_assign
id|call
suffix:semicolon
)brace
id|_leave
c_func
(paren
l_string|&quot; = %d [%p]&quot;
comma
id|ret
comma
id|call
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* end rxrpc_incoming_call() */
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * free a call record&n; */
DECL|function|rxrpc_put_call
r_void
id|rxrpc_put_call
c_func
(paren
r_struct
id|rxrpc_call
op_star
id|call
)paren
(brace
r_struct
id|rxrpc_connection
op_star
id|conn
op_assign
id|call-&gt;conn
suffix:semicolon
r_struct
id|rxrpc_message
op_star
id|msg
suffix:semicolon
id|_enter
c_func
(paren
l_string|&quot;%p{u=%d}&quot;
comma
id|call
comma
id|atomic_read
c_func
(paren
op_amp
id|call-&gt;usage
)paren
)paren
suffix:semicolon
multiline_comment|/* sanity check */
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|call-&gt;usage
)paren
op_le
l_int|0
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* to prevent a race, the decrement and the de-list must be effectively&n;&t; * atomic */
id|spin_lock
c_func
(paren
op_amp
id|conn-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|likely
c_func
(paren
op_logical_neg
id|atomic_dec_and_test
c_func
(paren
op_amp
id|call-&gt;usage
)paren
)paren
)paren
(brace
id|spin_unlock
c_func
(paren
op_amp
id|conn-&gt;lock
)paren
suffix:semicolon
id|_leave
c_func
(paren
l_string|&quot;&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|conn-&gt;channels
(braket
id|ntohl
c_func
(paren
id|call-&gt;chan_ix
)paren
)braket
op_eq
id|call
)paren
id|conn-&gt;channels
(braket
id|ntohl
c_func
(paren
id|call-&gt;chan_ix
)paren
)braket
op_assign
l_int|NULL
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|conn-&gt;lock
)paren
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|conn-&gt;chanwait
)paren
suffix:semicolon
id|rxrpc_put_connection
c_func
(paren
id|conn
)paren
suffix:semicolon
multiline_comment|/* clear the timers and dequeue from krxiod */
id|del_timer_sync
c_func
(paren
op_amp
id|call-&gt;acks_timeout
)paren
suffix:semicolon
id|del_timer_sync
c_func
(paren
op_amp
id|call-&gt;rcv_timeout
)paren
suffix:semicolon
id|del_timer_sync
c_func
(paren
op_amp
id|call-&gt;ackr_dfr_timo
)paren
suffix:semicolon
id|rxrpc_krxiod_dequeue_call
c_func
(paren
id|call
)paren
suffix:semicolon
multiline_comment|/* clean up the contents of the struct */
r_if
c_cond
(paren
id|call-&gt;snd_nextmsg
)paren
id|rxrpc_put_message
c_func
(paren
id|call-&gt;snd_nextmsg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|call-&gt;snd_ping
)paren
id|rxrpc_put_message
c_func
(paren
id|call-&gt;snd_ping
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|call-&gt;acks_pendq
)paren
)paren
(brace
id|msg
op_assign
id|list_entry
c_func
(paren
id|call-&gt;acks_pendq.next
comma
r_struct
id|rxrpc_message
comma
id|link
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|msg-&gt;link
)paren
suffix:semicolon
id|rxrpc_put_message
c_func
(paren
id|msg
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|call-&gt;rcv_receiveq
)paren
)paren
(brace
id|msg
op_assign
id|list_entry
c_func
(paren
id|call-&gt;rcv_receiveq.next
comma
r_struct
id|rxrpc_message
comma
id|link
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|msg-&gt;link
)paren
suffix:semicolon
id|rxrpc_put_message
c_func
(paren
id|msg
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|call-&gt;app_readyq
)paren
)paren
(brace
id|msg
op_assign
id|list_entry
c_func
(paren
id|call-&gt;app_readyq.next
comma
r_struct
id|rxrpc_message
comma
id|link
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|msg-&gt;link
)paren
suffix:semicolon
id|rxrpc_put_message
c_func
(paren
id|msg
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|call-&gt;app_unreadyq
)paren
)paren
(brace
id|msg
op_assign
id|list_entry
c_func
(paren
id|call-&gt;app_unreadyq.next
comma
r_struct
id|rxrpc_message
comma
id|link
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|msg-&gt;link
)paren
suffix:semicolon
id|rxrpc_put_message
c_func
(paren
id|msg
)paren
suffix:semicolon
)brace
id|module_put
c_func
(paren
id|call-&gt;owner
)paren
suffix:semicolon
id|down_write
c_func
(paren
op_amp
id|rxrpc_calls_sem
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|call-&gt;call_link
)paren
suffix:semicolon
id|up_write
c_func
(paren
op_amp
id|rxrpc_calls_sem
)paren
suffix:semicolon
id|__RXACCT
c_func
(paren
id|atomic_dec
c_func
(paren
op_amp
id|rxrpc_call_count
)paren
)paren
suffix:semicolon
id|free_page
c_func
(paren
(paren
r_int
r_int
)paren
id|call
)paren
suffix:semicolon
id|_leave
c_func
(paren
l_string|&quot; [destroyed]&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* end rxrpc_put_call() */
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * actually generate a normal ACK&n; */
DECL|function|__rxrpc_call_gen_normal_ACK
r_static
r_inline
r_int
id|__rxrpc_call_gen_normal_ACK
c_func
(paren
r_struct
id|rxrpc_call
op_star
id|call
comma
id|rxrpc_seq_t
id|seq
)paren
(brace
r_struct
id|rxrpc_message
op_star
id|msg
suffix:semicolon
r_struct
id|kvec
id|diov
(braket
l_int|3
)braket
suffix:semicolon
id|__be32
id|aux
(braket
l_int|4
)braket
suffix:semicolon
r_int
id|delta
comma
id|ret
suffix:semicolon
multiline_comment|/* ACKs default to DELAY */
r_if
c_cond
(paren
op_logical_neg
id|call-&gt;ackr.reason
)paren
id|call-&gt;ackr.reason
op_assign
id|RXRPC_ACK_DELAY
suffix:semicolon
id|_proto
c_func
(paren
l_string|&quot;Rx %05lu Sending ACK { m=%hu f=#%u p=#%u s=%%%u r=%s n=%u }&quot;
comma
id|jiffies
op_minus
id|call-&gt;cjif
comma
id|ntohs
c_func
(paren
id|call-&gt;ackr.maxSkew
)paren
comma
id|ntohl
c_func
(paren
id|call-&gt;ackr.firstPacket
)paren
comma
id|ntohl
c_func
(paren
id|call-&gt;ackr.previousPacket
)paren
comma
id|ntohl
c_func
(paren
id|call-&gt;ackr.serial
)paren
comma
id|rxrpc_acks
(braket
id|call-&gt;ackr.reason
)braket
comma
id|call-&gt;ackr.nAcks
)paren
suffix:semicolon
id|aux
(braket
l_int|0
)braket
op_assign
id|htonl
c_func
(paren
id|call-&gt;conn-&gt;peer-&gt;if_mtu
)paren
suffix:semicolon
multiline_comment|/* interface MTU */
id|aux
(braket
l_int|1
)braket
op_assign
id|htonl
c_func
(paren
l_int|1444
)paren
suffix:semicolon
multiline_comment|/* max MTU */
id|aux
(braket
l_int|2
)braket
op_assign
id|htonl
c_func
(paren
l_int|16
)paren
suffix:semicolon
multiline_comment|/* rwind */
id|aux
(braket
l_int|3
)braket
op_assign
id|htonl
c_func
(paren
l_int|4
)paren
suffix:semicolon
multiline_comment|/* max packets */
id|diov
(braket
l_int|0
)braket
dot
id|iov_len
op_assign
r_sizeof
(paren
r_struct
id|rxrpc_ackpacket
)paren
suffix:semicolon
id|diov
(braket
l_int|0
)braket
dot
id|iov_base
op_assign
op_amp
id|call-&gt;ackr
suffix:semicolon
id|diov
(braket
l_int|1
)braket
dot
id|iov_len
op_assign
id|call-&gt;ackr_pend_cnt
op_plus
l_int|3
suffix:semicolon
id|diov
(braket
l_int|1
)braket
dot
id|iov_base
op_assign
id|call-&gt;ackr_array
suffix:semicolon
id|diov
(braket
l_int|2
)braket
dot
id|iov_len
op_assign
r_sizeof
(paren
id|aux
)paren
suffix:semicolon
id|diov
(braket
l_int|2
)braket
dot
id|iov_base
op_assign
op_amp
id|aux
suffix:semicolon
multiline_comment|/* build and send the message */
id|ret
op_assign
id|rxrpc_conn_newmsg
c_func
(paren
id|call-&gt;conn
comma
id|call
comma
id|RXRPC_PACKET_TYPE_ACK
comma
l_int|3
comma
id|diov
comma
id|GFP_KERNEL
comma
op_amp
id|msg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
r_goto
id|out
suffix:semicolon
id|msg-&gt;seq
op_assign
id|seq
suffix:semicolon
id|msg-&gt;hdr.seq
op_assign
id|htonl
c_func
(paren
id|seq
)paren
suffix:semicolon
id|msg-&gt;hdr.flags
op_or_assign
id|RXRPC_SLOW_START_OK
suffix:semicolon
id|ret
op_assign
id|rxrpc_conn_sendmsg
c_func
(paren
id|call-&gt;conn
comma
id|msg
)paren
suffix:semicolon
id|rxrpc_put_message
c_func
(paren
id|msg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
r_goto
id|out
suffix:semicolon
id|call-&gt;pkt_snd_count
op_increment
suffix:semicolon
multiline_comment|/* count how many actual ACKs there were at the front */
r_for
c_loop
(paren
id|delta
op_assign
l_int|0
suffix:semicolon
id|delta
OL
id|call-&gt;ackr_pend_cnt
suffix:semicolon
id|delta
op_increment
)paren
r_if
c_cond
(paren
id|call-&gt;ackr_array
(braket
id|delta
)braket
op_ne
id|RXRPC_ACK_TYPE_ACK
)paren
r_break
suffix:semicolon
id|call-&gt;ackr_pend_cnt
op_sub_assign
id|delta
suffix:semicolon
multiline_comment|/* all ACK&squot;d to this point */
multiline_comment|/* crank the ACK window around */
r_if
c_cond
(paren
id|delta
op_eq
l_int|0
)paren
(brace
multiline_comment|/* un-ACK&squot;d window */
)brace
r_else
r_if
c_cond
(paren
id|delta
OL
id|RXRPC_CALL_ACK_WINDOW_SIZE
)paren
(brace
multiline_comment|/* partially ACK&squot;d window&n;&t;&t; * - shuffle down to avoid losing out-of-sequence packets&n;&t;&t; */
id|call-&gt;ackr_win_bot
op_add_assign
id|delta
suffix:semicolon
id|call-&gt;ackr_win_top
op_add_assign
id|delta
suffix:semicolon
id|memmove
c_func
(paren
op_amp
id|call-&gt;ackr_array
(braket
l_int|0
)braket
comma
op_amp
id|call-&gt;ackr_array
(braket
id|delta
)braket
comma
id|call-&gt;ackr_pend_cnt
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|call-&gt;ackr_array
(braket
id|call-&gt;ackr_pend_cnt
)braket
comma
id|RXRPC_ACK_TYPE_NACK
comma
r_sizeof
(paren
id|call-&gt;ackr_array
)paren
op_minus
id|call-&gt;ackr_pend_cnt
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* fully ACK&squot;d window&n;&t;&t; * - just clear the whole thing&n;&t;&t; */
id|memset
c_func
(paren
op_amp
id|call-&gt;ackr_array
comma
id|RXRPC_ACK_TYPE_NACK
comma
r_sizeof
(paren
id|call-&gt;ackr_array
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* clear this ACK */
id|memset
c_func
(paren
op_amp
id|call-&gt;ackr
comma
l_int|0
comma
r_sizeof
(paren
id|call-&gt;ackr
)paren
)paren
suffix:semicolon
id|out
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|call-&gt;app_call_state
)paren
id|printk
c_func
(paren
l_string|&quot;___ STATE 0 ___&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* end __rxrpc_call_gen_normal_ACK() */
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * note the reception of a packet in the call&squot;s ACK records and generate an&n; * appropriate ACK packet if necessary&n; * - returns 0 if packet should be processed, 1 if packet should be ignored&n; *   and -ve on an error&n; */
DECL|function|rxrpc_call_generate_ACK
r_static
r_int
id|rxrpc_call_generate_ACK
c_func
(paren
r_struct
id|rxrpc_call
op_star
id|call
comma
r_struct
id|rxrpc_header
op_star
id|hdr
comma
r_struct
id|rxrpc_ackpacket
op_star
id|ack
)paren
(brace
r_struct
id|rxrpc_message
op_star
id|msg
suffix:semicolon
id|rxrpc_seq_t
id|seq
suffix:semicolon
r_int
id|offset
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
comma
id|err
suffix:semicolon
id|u8
id|special_ACK
comma
id|do_ACK
comma
id|force
suffix:semicolon
id|_enter
c_func
(paren
l_string|&quot;%p,%p { seq=%d tp=%d fl=%02x }&quot;
comma
id|call
comma
id|hdr
comma
id|ntohl
c_func
(paren
id|hdr-&gt;seq
)paren
comma
id|hdr-&gt;type
comma
id|hdr-&gt;flags
)paren
suffix:semicolon
id|seq
op_assign
id|ntohl
c_func
(paren
id|hdr-&gt;seq
)paren
suffix:semicolon
id|offset
op_assign
id|seq
op_minus
id|call-&gt;ackr_win_bot
suffix:semicolon
id|do_ACK
op_assign
id|RXRPC_ACK_DELAY
suffix:semicolon
id|special_ACK
op_assign
l_int|0
suffix:semicolon
id|force
op_assign
(paren
id|seq
op_eq
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|call-&gt;ackr_high_seq
OL
id|seq
)paren
id|call-&gt;ackr_high_seq
op_assign
id|seq
suffix:semicolon
multiline_comment|/* deal with generation of obvious special ACKs first */
r_if
c_cond
(paren
id|ack
op_logical_and
id|ack-&gt;reason
op_eq
id|RXRPC_ACK_PING
)paren
(brace
id|special_ACK
op_assign
id|RXRPC_ACK_PING_RESPONSE
suffix:semicolon
id|ret
op_assign
l_int|1
suffix:semicolon
r_goto
id|gen_ACK
suffix:semicolon
)brace
r_if
c_cond
(paren
id|seq
OL
id|call-&gt;ackr_win_bot
)paren
(brace
id|special_ACK
op_assign
id|RXRPC_ACK_DUPLICATE
suffix:semicolon
id|ret
op_assign
l_int|1
suffix:semicolon
r_goto
id|gen_ACK
suffix:semicolon
)brace
r_if
c_cond
(paren
id|seq
op_ge
id|call-&gt;ackr_win_top
)paren
(brace
id|special_ACK
op_assign
id|RXRPC_ACK_EXCEEDS_WINDOW
suffix:semicolon
id|ret
op_assign
l_int|1
suffix:semicolon
r_goto
id|gen_ACK
suffix:semicolon
)brace
r_if
c_cond
(paren
id|call-&gt;ackr_array
(braket
id|offset
)braket
op_ne
id|RXRPC_ACK_TYPE_NACK
)paren
(brace
id|special_ACK
op_assign
id|RXRPC_ACK_DUPLICATE
suffix:semicolon
id|ret
op_assign
l_int|1
suffix:semicolon
r_goto
id|gen_ACK
suffix:semicolon
)brace
multiline_comment|/* okay... it&squot;s a normal data packet inside the ACK window */
id|call-&gt;ackr_array
(braket
id|offset
)braket
op_assign
id|RXRPC_ACK_TYPE_ACK
suffix:semicolon
r_if
c_cond
(paren
id|offset
OL
id|call-&gt;ackr_pend_cnt
)paren
(brace
)brace
r_else
r_if
c_cond
(paren
id|offset
OG
id|call-&gt;ackr_pend_cnt
)paren
(brace
id|do_ACK
op_assign
id|RXRPC_ACK_OUT_OF_SEQUENCE
suffix:semicolon
id|call-&gt;ackr_pend_cnt
op_assign
id|offset
suffix:semicolon
r_goto
id|gen_ACK
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hdr-&gt;flags
op_amp
id|RXRPC_REQUEST_ACK
)paren
(brace
id|do_ACK
op_assign
id|RXRPC_ACK_REQUESTED
suffix:semicolon
)brace
multiline_comment|/* generate an ACK on the final packet of a reply just received */
r_if
c_cond
(paren
id|hdr-&gt;flags
op_amp
id|RXRPC_LAST_PACKET
)paren
(brace
r_if
c_cond
(paren
id|call-&gt;conn-&gt;out_clientflag
)paren
id|force
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
(paren
id|hdr-&gt;flags
op_amp
id|RXRPC_MORE_PACKETS
)paren
)paren
(brace
id|do_ACK
op_assign
id|RXRPC_ACK_REQUESTED
suffix:semicolon
)brace
multiline_comment|/* re-ACK packets previously received out-of-order */
r_for
c_loop
(paren
id|offset
op_increment
suffix:semicolon
id|offset
OL
id|RXRPC_CALL_ACK_WINDOW_SIZE
suffix:semicolon
id|offset
op_increment
)paren
r_if
c_cond
(paren
id|call-&gt;ackr_array
(braket
id|offset
)braket
op_ne
id|RXRPC_ACK_TYPE_ACK
)paren
r_break
suffix:semicolon
id|call-&gt;ackr_pend_cnt
op_assign
id|offset
suffix:semicolon
multiline_comment|/* generate an ACK if we fill up the window */
r_if
c_cond
(paren
id|call-&gt;ackr_pend_cnt
op_ge
id|RXRPC_CALL_ACK_WINDOW_SIZE
)paren
id|force
op_assign
l_int|1
suffix:semicolon
id|gen_ACK
suffix:colon
id|_debug
c_func
(paren
l_string|&quot;%05lu ACKs pend=%u norm=%s special=%s%s&quot;
comma
id|jiffies
op_minus
id|call-&gt;cjif
comma
id|call-&gt;ackr_pend_cnt
comma
id|rxrpc_acks
(braket
id|do_ACK
)braket
comma
id|rxrpc_acks
(braket
id|special_ACK
)braket
comma
id|force
ques
c_cond
l_string|&quot; immediate&quot;
suffix:colon
id|do_ACK
op_eq
id|RXRPC_ACK_REQUESTED
ques
c_cond
l_string|&quot; merge-req&quot;
suffix:colon
id|hdr-&gt;flags
op_amp
id|RXRPC_LAST_PACKET
ques
c_cond
l_string|&quot; finalise&quot;
suffix:colon
l_string|&quot; defer&quot;
)paren
suffix:semicolon
multiline_comment|/* send any pending normal ACKs if need be */
r_if
c_cond
(paren
id|call-&gt;ackr_pend_cnt
OG
l_int|0
)paren
(brace
multiline_comment|/* fill out the appropriate form */
id|call-&gt;ackr.bufferSpace
op_assign
id|htons
c_func
(paren
id|RXRPC_CALL_ACK_WINDOW_SIZE
)paren
suffix:semicolon
id|call-&gt;ackr.maxSkew
op_assign
id|htons
c_func
(paren
id|min
c_func
(paren
id|call-&gt;ackr_high_seq
op_minus
id|seq
comma
l_int|65535U
)paren
)paren
suffix:semicolon
id|call-&gt;ackr.firstPacket
op_assign
id|htonl
c_func
(paren
id|call-&gt;ackr_win_bot
)paren
suffix:semicolon
id|call-&gt;ackr.previousPacket
op_assign
id|call-&gt;ackr_prev_seq
suffix:semicolon
id|call-&gt;ackr.serial
op_assign
id|hdr-&gt;serial
suffix:semicolon
id|call-&gt;ackr.nAcks
op_assign
id|call-&gt;ackr_pend_cnt
suffix:semicolon
r_if
c_cond
(paren
id|do_ACK
op_eq
id|RXRPC_ACK_REQUESTED
)paren
id|call-&gt;ackr.reason
op_assign
id|do_ACK
suffix:semicolon
multiline_comment|/* generate the ACK immediately if necessary */
r_if
c_cond
(paren
id|special_ACK
op_logical_or
id|force
)paren
(brace
id|err
op_assign
id|__rxrpc_call_gen_normal_ACK
c_func
(paren
id|call
comma
id|do_ACK
op_eq
id|RXRPC_ACK_DELAY
ques
c_cond
l_int|0
suffix:colon
id|seq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
id|ret
op_assign
id|err
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|call-&gt;ackr.reason
op_eq
id|RXRPC_ACK_REQUESTED
)paren
id|call-&gt;ackr_dfr_seq
op_assign
id|seq
suffix:semicolon
multiline_comment|/* start the ACK timer if not running if there are any pending deferred&n;&t; * ACKs */
r_if
c_cond
(paren
id|call-&gt;ackr_pend_cnt
OG
l_int|0
op_logical_and
id|call-&gt;ackr.reason
op_ne
id|RXRPC_ACK_REQUESTED
op_logical_and
op_logical_neg
id|timer_pending
c_func
(paren
op_amp
id|call-&gt;ackr_dfr_timo
)paren
)paren
(brace
r_int
r_int
id|timo
suffix:semicolon
id|timo
op_assign
id|rxrpc_call_dfr_ack_timeout
op_plus
id|jiffies
suffix:semicolon
id|_debug
c_func
(paren
l_string|&quot;START ACKR TIMER for cj=%lu&quot;
comma
id|timo
op_minus
id|call-&gt;cjif
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|call-&gt;lock
)paren
suffix:semicolon
id|mod_timer
c_func
(paren
op_amp
id|call-&gt;ackr_dfr_timo
comma
id|timo
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|call-&gt;lock
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|call-&gt;ackr_pend_cnt
op_eq
l_int|0
op_logical_or
id|call-&gt;ackr.reason
op_eq
id|RXRPC_ACK_REQUESTED
)paren
op_logical_and
id|timer_pending
c_func
(paren
op_amp
id|call-&gt;ackr_dfr_timo
)paren
)paren
(brace
multiline_comment|/* stop timer if no pending ACKs */
id|_debug
c_func
(paren
l_string|&quot;CLEAR ACKR TIMER&quot;
)paren
suffix:semicolon
id|del_timer_sync
c_func
(paren
op_amp
id|call-&gt;ackr_dfr_timo
)paren
suffix:semicolon
)brace
multiline_comment|/* send a special ACK if one is required */
r_if
c_cond
(paren
id|special_ACK
)paren
(brace
r_struct
id|rxrpc_ackpacket
id|ack
suffix:semicolon
r_struct
id|kvec
id|diov
(braket
l_int|2
)braket
suffix:semicolon
r_uint8
id|acks
(braket
l_int|1
)braket
op_assign
(brace
id|RXRPC_ACK_TYPE_ACK
)brace
suffix:semicolon
multiline_comment|/* fill out the appropriate form */
id|ack.bufferSpace
op_assign
id|htons
c_func
(paren
id|RXRPC_CALL_ACK_WINDOW_SIZE
)paren
suffix:semicolon
id|ack.maxSkew
op_assign
id|htons
c_func
(paren
id|min
c_func
(paren
id|call-&gt;ackr_high_seq
op_minus
id|seq
comma
l_int|65535U
)paren
)paren
suffix:semicolon
id|ack.firstPacket
op_assign
id|htonl
c_func
(paren
id|call-&gt;ackr_win_bot
)paren
suffix:semicolon
id|ack.previousPacket
op_assign
id|call-&gt;ackr_prev_seq
suffix:semicolon
id|ack.serial
op_assign
id|hdr-&gt;serial
suffix:semicolon
id|ack.reason
op_assign
id|special_ACK
suffix:semicolon
id|ack.nAcks
op_assign
l_int|0
suffix:semicolon
id|_proto
c_func
(paren
l_string|&quot;Rx Sending s-ACK&quot;
l_string|&quot; { m=%hu f=#%u p=#%u s=%%%u r=%s n=%u }&quot;
comma
id|ntohs
c_func
(paren
id|ack.maxSkew
)paren
comma
id|ntohl
c_func
(paren
id|ack.firstPacket
)paren
comma
id|ntohl
c_func
(paren
id|ack.previousPacket
)paren
comma
id|ntohl
c_func
(paren
id|ack.serial
)paren
comma
id|rxrpc_acks
(braket
id|ack.reason
)braket
comma
id|ack.nAcks
)paren
suffix:semicolon
id|diov
(braket
l_int|0
)braket
dot
id|iov_len
op_assign
r_sizeof
(paren
r_struct
id|rxrpc_ackpacket
)paren
suffix:semicolon
id|diov
(braket
l_int|0
)braket
dot
id|iov_base
op_assign
op_amp
id|ack
suffix:semicolon
id|diov
(braket
l_int|1
)braket
dot
id|iov_len
op_assign
r_sizeof
(paren
id|acks
)paren
suffix:semicolon
id|diov
(braket
l_int|1
)braket
dot
id|iov_base
op_assign
id|acks
suffix:semicolon
multiline_comment|/* build and send the message */
id|err
op_assign
id|rxrpc_conn_newmsg
c_func
(paren
id|call-&gt;conn
comma
id|call
comma
id|RXRPC_PACKET_TYPE_ACK
comma
id|hdr-&gt;seq
ques
c_cond
l_int|2
suffix:colon
l_int|1
comma
id|diov
comma
id|GFP_KERNEL
comma
op_amp
id|msg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
id|ret
op_assign
id|err
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|msg-&gt;seq
op_assign
id|seq
suffix:semicolon
id|msg-&gt;hdr.seq
op_assign
id|htonl
c_func
(paren
id|seq
)paren
suffix:semicolon
id|msg-&gt;hdr.flags
op_or_assign
id|RXRPC_SLOW_START_OK
suffix:semicolon
id|err
op_assign
id|rxrpc_conn_sendmsg
c_func
(paren
id|call-&gt;conn
comma
id|msg
)paren
suffix:semicolon
id|rxrpc_put_message
c_func
(paren
id|msg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
id|ret
op_assign
id|err
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|call-&gt;pkt_snd_count
op_increment
suffix:semicolon
)brace
id|out
suffix:colon
r_if
c_cond
(paren
id|hdr-&gt;seq
)paren
id|call-&gt;ackr_prev_seq
op_assign
id|hdr-&gt;seq
suffix:semicolon
id|_leave
c_func
(paren
l_string|&quot; = %d&quot;
comma
id|ret
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* end rxrpc_call_generate_ACK() */
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * handle work to be done on a call&n; * - includes packet reception and timeout processing&n; */
DECL|function|rxrpc_call_do_stuff
r_void
id|rxrpc_call_do_stuff
c_func
(paren
r_struct
id|rxrpc_call
op_star
id|call
)paren
(brace
id|_enter
c_func
(paren
l_string|&quot;%p{flags=%lx}&quot;
comma
id|call
comma
id|call-&gt;flags
)paren
suffix:semicolon
multiline_comment|/* handle packet reception */
r_if
c_cond
(paren
id|call-&gt;flags
op_amp
id|RXRPC_CALL_RCV_PKT
)paren
(brace
id|_debug
c_func
(paren
l_string|&quot;- receive packet&quot;
)paren
suffix:semicolon
id|call-&gt;flags
op_and_assign
op_complement
id|RXRPC_CALL_RCV_PKT
suffix:semicolon
id|rxrpc_call_receive_packet
c_func
(paren
id|call
)paren
suffix:semicolon
)brace
multiline_comment|/* handle overdue ACKs */
r_if
c_cond
(paren
id|call-&gt;flags
op_amp
id|RXRPC_CALL_ACKS_TIMO
)paren
(brace
id|_debug
c_func
(paren
l_string|&quot;- overdue ACK timeout&quot;
)paren
suffix:semicolon
id|call-&gt;flags
op_and_assign
op_complement
id|RXRPC_CALL_ACKS_TIMO
suffix:semicolon
id|rxrpc_call_resend
c_func
(paren
id|call
comma
id|call-&gt;snd_seq_count
)paren
suffix:semicolon
)brace
multiline_comment|/* handle lack of reception */
r_if
c_cond
(paren
id|call-&gt;flags
op_amp
id|RXRPC_CALL_RCV_TIMO
)paren
(brace
id|_debug
c_func
(paren
l_string|&quot;- reception timeout&quot;
)paren
suffix:semicolon
id|call-&gt;flags
op_and_assign
op_complement
id|RXRPC_CALL_RCV_TIMO
suffix:semicolon
id|rxrpc_call_abort
c_func
(paren
id|call
comma
op_minus
id|EIO
)paren
suffix:semicolon
)brace
multiline_comment|/* handle deferred ACKs */
r_if
c_cond
(paren
id|call-&gt;flags
op_amp
id|RXRPC_CALL_ACKR_TIMO
op_logical_or
(paren
id|call-&gt;ackr.nAcks
OG
l_int|0
op_logical_and
id|call-&gt;ackr.reason
op_eq
id|RXRPC_ACK_REQUESTED
)paren
)paren
(brace
id|_debug
c_func
(paren
l_string|&quot;- deferred ACK timeout: cj=%05lu r=%s n=%u&quot;
comma
id|jiffies
op_minus
id|call-&gt;cjif
comma
id|rxrpc_acks
(braket
id|call-&gt;ackr.reason
)braket
comma
id|call-&gt;ackr.nAcks
)paren
suffix:semicolon
id|call-&gt;flags
op_and_assign
op_complement
id|RXRPC_CALL_ACKR_TIMO
suffix:semicolon
r_if
c_cond
(paren
id|call-&gt;ackr.nAcks
OG
l_int|0
op_logical_and
id|call-&gt;app_call_state
op_ne
id|RXRPC_CSTATE_ERROR
)paren
(brace
multiline_comment|/* generate ACK */
id|__rxrpc_call_gen_normal_ACK
c_func
(paren
id|call
comma
id|call-&gt;ackr_dfr_seq
)paren
suffix:semicolon
id|call-&gt;ackr_dfr_seq
op_assign
l_int|0
suffix:semicolon
)brace
)brace
id|_leave
c_func
(paren
l_string|&quot;&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* end rxrpc_call_do_stuff() */
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * send an abort message at call or connection level&n; * - must be called with call-&gt;lock held&n; * - the supplied error code is sent as the packet data&n; */
DECL|function|__rxrpc_call_abort
r_static
r_int
id|__rxrpc_call_abort
c_func
(paren
r_struct
id|rxrpc_call
op_star
id|call
comma
r_int
id|errno
)paren
(brace
r_struct
id|rxrpc_connection
op_star
id|conn
op_assign
id|call-&gt;conn
suffix:semicolon
r_struct
id|rxrpc_message
op_star
id|msg
suffix:semicolon
r_struct
id|kvec
id|diov
(braket
l_int|1
)braket
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|__be32
id|_error
suffix:semicolon
id|_enter
c_func
(paren
l_string|&quot;%p{%08x},%p{%d},%d&quot;
comma
id|conn
comma
id|ntohl
c_func
(paren
id|conn-&gt;conn_id
)paren
comma
id|call
comma
id|ntohl
c_func
(paren
id|call-&gt;call_id
)paren
comma
id|errno
)paren
suffix:semicolon
multiline_comment|/* if this call is already aborted, then just wake up any waiters */
r_if
c_cond
(paren
id|call-&gt;app_call_state
op_eq
id|RXRPC_CSTATE_ERROR
)paren
(brace
id|spin_unlock
c_func
(paren
op_amp
id|call-&gt;lock
)paren
suffix:semicolon
id|call
op_member_access_from_pointer
id|app_error_func
c_func
(paren
id|call
)paren
suffix:semicolon
id|_leave
c_func
(paren
l_string|&quot; = 0&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|rxrpc_get_call
c_func
(paren
id|call
)paren
suffix:semicolon
multiline_comment|/* change the state _with_ the lock still held */
id|call-&gt;app_call_state
op_assign
id|RXRPC_CSTATE_ERROR
suffix:semicolon
id|call-&gt;app_err_state
op_assign
id|RXRPC_ESTATE_LOCAL_ABORT
suffix:semicolon
id|call-&gt;app_errno
op_assign
id|errno
suffix:semicolon
id|call-&gt;app_mark
op_assign
id|RXRPC_APP_MARK_EOF
suffix:semicolon
id|call-&gt;app_read_buf
op_assign
l_int|NULL
suffix:semicolon
id|call-&gt;app_async_read
op_assign
l_int|0
suffix:semicolon
id|_state
c_func
(paren
id|call
)paren
suffix:semicolon
multiline_comment|/* ask the app to translate the error code */
id|call
op_member_access_from_pointer
id|app_aemap_func
c_func
(paren
id|call
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|call-&gt;lock
)paren
suffix:semicolon
multiline_comment|/* flush any outstanding ACKs */
id|del_timer_sync
c_func
(paren
op_amp
id|call-&gt;acks_timeout
)paren
suffix:semicolon
id|del_timer_sync
c_func
(paren
op_amp
id|call-&gt;rcv_timeout
)paren
suffix:semicolon
id|del_timer_sync
c_func
(paren
op_amp
id|call-&gt;ackr_dfr_timo
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rxrpc_call_is_ack_pending
c_func
(paren
id|call
)paren
)paren
id|__rxrpc_call_gen_normal_ACK
c_func
(paren
id|call
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* send the abort packet only if we actually traded some other&n;&t; * packets */
id|ret
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|call-&gt;pkt_snd_count
op_logical_or
id|call-&gt;pkt_rcv_count
)paren
(brace
multiline_comment|/* actually send the abort */
id|_proto
c_func
(paren
l_string|&quot;Rx Sending Call ABORT { data=%d }&quot;
comma
id|call-&gt;app_abort_code
)paren
suffix:semicolon
id|_error
op_assign
id|htonl
c_func
(paren
id|call-&gt;app_abort_code
)paren
suffix:semicolon
id|diov
(braket
l_int|0
)braket
dot
id|iov_len
op_assign
r_sizeof
(paren
id|_error
)paren
suffix:semicolon
id|diov
(braket
l_int|0
)braket
dot
id|iov_base
op_assign
op_amp
id|_error
suffix:semicolon
id|ret
op_assign
id|rxrpc_conn_newmsg
c_func
(paren
id|conn
comma
id|call
comma
id|RXRPC_PACKET_TYPE_ABORT
comma
l_int|1
comma
id|diov
comma
id|GFP_KERNEL
comma
op_amp
id|msg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
l_int|0
)paren
(brace
id|ret
op_assign
id|rxrpc_conn_sendmsg
c_func
(paren
id|conn
comma
id|msg
)paren
suffix:semicolon
id|rxrpc_put_message
c_func
(paren
id|msg
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* tell the app layer to let go */
id|call
op_member_access_from_pointer
id|app_error_func
c_func
(paren
id|call
)paren
suffix:semicolon
id|rxrpc_put_call
c_func
(paren
id|call
)paren
suffix:semicolon
id|_leave
c_func
(paren
l_string|&quot; = %d&quot;
comma
id|ret
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* end __rxrpc_call_abort() */
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * send an abort message at call or connection level&n; * - the supplied error code is sent as the packet data&n; */
DECL|function|rxrpc_call_abort
r_int
id|rxrpc_call_abort
c_func
(paren
r_struct
id|rxrpc_call
op_star
id|call
comma
r_int
id|error
)paren
(brace
id|spin_lock
c_func
(paren
op_amp
id|call-&gt;lock
)paren
suffix:semicolon
r_return
id|__rxrpc_call_abort
c_func
(paren
id|call
comma
id|error
)paren
suffix:semicolon
)brace
multiline_comment|/* end rxrpc_call_abort() */
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * process packets waiting for this call&n; */
DECL|function|rxrpc_call_receive_packet
r_static
r_void
id|rxrpc_call_receive_packet
c_func
(paren
r_struct
id|rxrpc_call
op_star
id|call
)paren
(brace
r_struct
id|rxrpc_message
op_star
id|msg
suffix:semicolon
r_struct
id|list_head
op_star
id|_p
suffix:semicolon
id|_enter
c_func
(paren
l_string|&quot;%p&quot;
comma
id|call
)paren
suffix:semicolon
id|rxrpc_get_call
c_func
(paren
id|call
)paren
suffix:semicolon
multiline_comment|/* must not go away too soon if aborted by&n;&t;&t;&t;       * app-layer */
r_while
c_loop
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|call-&gt;rcv_receiveq
)paren
)paren
(brace
multiline_comment|/* try to get next packet */
id|_p
op_assign
l_int|NULL
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|call-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|call-&gt;rcv_receiveq
)paren
)paren
(brace
id|_p
op_assign
id|call-&gt;rcv_receiveq.next
suffix:semicolon
id|list_del_init
c_func
(paren
id|_p
)paren
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|call-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|_p
)paren
r_break
suffix:semicolon
id|msg
op_assign
id|list_entry
c_func
(paren
id|_p
comma
r_struct
id|rxrpc_message
comma
id|link
)paren
suffix:semicolon
id|_proto
c_func
(paren
l_string|&quot;Rx %05lu Received %s packet (%%%u,#%u,%c%c%c%c%c)&quot;
comma
id|jiffies
op_minus
id|call-&gt;cjif
comma
id|rxrpc_pkts
(braket
id|msg-&gt;hdr.type
)braket
comma
id|ntohl
c_func
(paren
id|msg-&gt;hdr.serial
)paren
comma
id|msg-&gt;seq
comma
id|msg-&gt;hdr.flags
op_amp
id|RXRPC_JUMBO_PACKET
ques
c_cond
l_char|&squot;j&squot;
suffix:colon
l_char|&squot;-&squot;
comma
id|msg-&gt;hdr.flags
op_amp
id|RXRPC_MORE_PACKETS
ques
c_cond
l_char|&squot;m&squot;
suffix:colon
l_char|&squot;-&squot;
comma
id|msg-&gt;hdr.flags
op_amp
id|RXRPC_LAST_PACKET
ques
c_cond
l_char|&squot;l&squot;
suffix:colon
l_char|&squot;-&squot;
comma
id|msg-&gt;hdr.flags
op_amp
id|RXRPC_REQUEST_ACK
ques
c_cond
l_char|&squot;r&squot;
suffix:colon
l_char|&squot;-&squot;
comma
id|msg-&gt;hdr.flags
op_amp
id|RXRPC_CLIENT_INITIATED
ques
c_cond
l_char|&squot;C&squot;
suffix:colon
l_char|&squot;S&squot;
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|msg-&gt;hdr.type
)paren
(brace
multiline_comment|/* deal with data packets */
r_case
id|RXRPC_PACKET_TYPE_DATA
suffix:colon
multiline_comment|/* ACK the packet if necessary */
r_switch
c_cond
(paren
id|rxrpc_call_generate_ACK
c_func
(paren
id|call
comma
op_amp
id|msg-&gt;hdr
comma
l_int|NULL
)paren
)paren
(brace
r_case
l_int|0
suffix:colon
multiline_comment|/* useful packet */
id|rxrpc_call_receive_data_packet
c_func
(paren
id|call
comma
id|msg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
multiline_comment|/* duplicate or out-of-window packet */
r_break
suffix:semicolon
r_default
suffix:colon
id|rxrpc_put_message
c_func
(paren
id|msg
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_break
suffix:semicolon
multiline_comment|/* deal with ACK packets */
r_case
id|RXRPC_PACKET_TYPE_ACK
suffix:colon
id|rxrpc_call_receive_ack_packet
c_func
(paren
id|call
comma
id|msg
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* deal with abort packets */
r_case
id|RXRPC_PACKET_TYPE_ABORT
suffix:colon
(brace
id|__be32
id|_dbuf
comma
op_star
id|dp
suffix:semicolon
id|dp
op_assign
id|skb_header_pointer
c_func
(paren
id|msg-&gt;pkt
comma
id|msg-&gt;offset
comma
r_sizeof
(paren
id|_dbuf
)paren
comma
op_amp
id|_dbuf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dp
op_eq
l_int|NULL
)paren
id|printk
c_func
(paren
l_string|&quot;Rx Received short ABORT packet&bslash;n&quot;
)paren
suffix:semicolon
id|_proto
c_func
(paren
l_string|&quot;Rx Received Call ABORT { data=%d }&quot;
comma
(paren
id|dp
ques
c_cond
id|ntohl
c_func
(paren
op_star
id|dp
)paren
suffix:colon
l_int|0
)paren
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|call-&gt;lock
)paren
suffix:semicolon
id|call-&gt;app_call_state
op_assign
id|RXRPC_CSTATE_ERROR
suffix:semicolon
id|call-&gt;app_err_state
op_assign
id|RXRPC_ESTATE_PEER_ABORT
suffix:semicolon
id|call-&gt;app_abort_code
op_assign
(paren
id|dp
ques
c_cond
id|ntohl
c_func
(paren
op_star
id|dp
)paren
suffix:colon
l_int|0
)paren
suffix:semicolon
id|call-&gt;app_errno
op_assign
op_minus
id|ECONNABORTED
suffix:semicolon
id|call-&gt;app_mark
op_assign
id|RXRPC_APP_MARK_EOF
suffix:semicolon
id|call-&gt;app_read_buf
op_assign
l_int|NULL
suffix:semicolon
id|call-&gt;app_async_read
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* ask the app to translate the error code */
id|call
op_member_access_from_pointer
id|app_aemap_func
c_func
(paren
id|call
)paren
suffix:semicolon
id|_state
c_func
(paren
id|call
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|call-&gt;lock
)paren
suffix:semicolon
id|call
op_member_access_from_pointer
id|app_error_func
c_func
(paren
id|call
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_default
suffix:colon
multiline_comment|/* deal with other packet types */
id|_proto
c_func
(paren
l_string|&quot;Rx Unsupported packet type %u (#%u)&quot;
comma
id|msg-&gt;hdr.type
comma
id|msg-&gt;seq
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|rxrpc_put_message
c_func
(paren
id|msg
)paren
suffix:semicolon
)brace
id|out
suffix:colon
id|rxrpc_put_call
c_func
(paren
id|call
)paren
suffix:semicolon
id|_leave
c_func
(paren
l_string|&quot;&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* end rxrpc_call_receive_packet() */
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * process next data packet&n; * - as the next data packet arrives:&n; *   - it is queued on app_readyq _if_ it is the next one expected&n; *     (app_ready_seq+1)&n; *   - it is queued on app_unreadyq _if_ it is not the next one expected&n; *   - if a packet placed on app_readyq completely fills a hole leading up to&n; *     the first packet on app_unreadyq, then packets now in sequence are&n; *     tranferred to app_readyq&n; * - the application layer can only see packets on app_readyq&n; *   (app_ready_qty bytes)&n; * - the application layer is prodded every time a new packet arrives&n; */
DECL|function|rxrpc_call_receive_data_packet
r_static
r_void
id|rxrpc_call_receive_data_packet
c_func
(paren
r_struct
id|rxrpc_call
op_star
id|call
comma
r_struct
id|rxrpc_message
op_star
id|msg
)paren
(brace
r_const
r_struct
id|rxrpc_operation
op_star
id|optbl
comma
op_star
id|op
suffix:semicolon
r_struct
id|rxrpc_message
op_star
id|pmsg
suffix:semicolon
r_struct
id|list_head
op_star
id|_p
suffix:semicolon
r_int
id|ret
comma
id|lo
comma
id|hi
comma
id|rmtimo
suffix:semicolon
id|__be32
id|opid
suffix:semicolon
id|_enter
c_func
(paren
l_string|&quot;%p{%u},%p{%u}&quot;
comma
id|call
comma
id|ntohl
c_func
(paren
id|call-&gt;call_id
)paren
comma
id|msg
comma
id|msg-&gt;seq
)paren
suffix:semicolon
id|rxrpc_get_message
c_func
(paren
id|msg
)paren
suffix:semicolon
multiline_comment|/* add to the unready queue if we&squot;d have to create a hole in the ready&n;&t; * queue otherwise */
r_if
c_cond
(paren
id|msg-&gt;seq
op_ne
id|call-&gt;app_ready_seq
op_plus
l_int|1
)paren
(brace
id|_debug
c_func
(paren
l_string|&quot;Call add packet %d to unreadyq&quot;
comma
id|msg-&gt;seq
)paren
suffix:semicolon
multiline_comment|/* insert in seq order */
id|list_for_each
c_func
(paren
id|_p
comma
op_amp
id|call-&gt;app_unreadyq
)paren
(brace
id|pmsg
op_assign
id|list_entry
c_func
(paren
id|_p
comma
r_struct
id|rxrpc_message
comma
id|link
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pmsg-&gt;seq
OG
id|msg-&gt;seq
)paren
r_break
suffix:semicolon
)brace
id|list_add_tail
c_func
(paren
op_amp
id|msg-&gt;link
comma
id|_p
)paren
suffix:semicolon
id|_leave
c_func
(paren
l_string|&quot; [unreadyq]&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* next in sequence - simply append into the call&squot;s ready queue */
id|_debug
c_func
(paren
l_string|&quot;Call add packet %d to readyq (+%Zd =&gt; %Zd bytes)&quot;
comma
id|msg-&gt;seq
comma
id|msg-&gt;dsize
comma
id|call-&gt;app_ready_qty
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|call-&gt;lock
)paren
suffix:semicolon
id|call-&gt;app_ready_seq
op_assign
id|msg-&gt;seq
suffix:semicolon
id|call-&gt;app_ready_qty
op_add_assign
id|msg-&gt;dsize
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|msg-&gt;link
comma
op_amp
id|call-&gt;app_readyq
)paren
suffix:semicolon
multiline_comment|/* move unready packets to the readyq if we got rid of a hole */
r_while
c_loop
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|call-&gt;app_unreadyq
)paren
)paren
(brace
id|pmsg
op_assign
id|list_entry
c_func
(paren
id|call-&gt;app_unreadyq.next
comma
r_struct
id|rxrpc_message
comma
id|link
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pmsg-&gt;seq
op_ne
id|call-&gt;app_ready_seq
op_plus
l_int|1
)paren
r_break
suffix:semicolon
multiline_comment|/* next in sequence - just move list-to-list */
id|_debug
c_func
(paren
l_string|&quot;Call transfer packet %d to readyq (+%Zd =&gt; %Zd bytes)&quot;
comma
id|pmsg-&gt;seq
comma
id|pmsg-&gt;dsize
comma
id|call-&gt;app_ready_qty
)paren
suffix:semicolon
id|call-&gt;app_ready_seq
op_assign
id|pmsg-&gt;seq
suffix:semicolon
id|call-&gt;app_ready_qty
op_add_assign
id|pmsg-&gt;dsize
suffix:semicolon
id|list_del_init
c_func
(paren
op_amp
id|pmsg-&gt;link
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|pmsg-&gt;link
comma
op_amp
id|call-&gt;app_readyq
)paren
suffix:semicolon
)brace
multiline_comment|/* see if we&squot;ve got the last packet yet */
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|call-&gt;app_readyq
)paren
)paren
(brace
id|pmsg
op_assign
id|list_entry
c_func
(paren
id|call-&gt;app_readyq.prev
comma
r_struct
id|rxrpc_message
comma
id|link
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pmsg-&gt;hdr.flags
op_amp
id|RXRPC_LAST_PACKET
)paren
(brace
id|call-&gt;app_last_rcv
op_assign
l_int|1
suffix:semicolon
id|_debug
c_func
(paren
l_string|&quot;Last packet on readyq&quot;
)paren
suffix:semicolon
)brace
)brace
r_switch
c_cond
(paren
id|call-&gt;app_call_state
)paren
(brace
multiline_comment|/* do nothing if call already aborted */
r_case
id|RXRPC_CSTATE_ERROR
suffix:colon
id|spin_unlock
c_func
(paren
op_amp
id|call-&gt;lock
)paren
suffix:semicolon
id|_leave
c_func
(paren
l_string|&quot; [error]&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
multiline_comment|/* extract the operation ID from an incoming call if that&squot;s not&n;&t;&t; * yet been done */
r_case
id|RXRPC_CSTATE_SRVR_RCV_OPID
suffix:colon
id|spin_unlock
c_func
(paren
op_amp
id|call-&gt;lock
)paren
suffix:semicolon
multiline_comment|/* handle as yet insufficient data for the operation ID */
r_if
c_cond
(paren
id|call-&gt;app_ready_qty
OL
l_int|4
)paren
(brace
r_if
c_cond
(paren
id|call-&gt;app_last_rcv
)paren
multiline_comment|/* trouble - last packet seen */
id|rxrpc_call_abort
c_func
(paren
id|call
comma
op_minus
id|EINVAL
)paren
suffix:semicolon
id|_leave
c_func
(paren
l_string|&quot;&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* pull the operation ID out of the buffer */
id|ret
op_assign
id|rxrpc_call_read_data
c_func
(paren
id|call
comma
op_amp
id|opid
comma
r_sizeof
(paren
id|opid
)paren
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Unexpected error from read-data: %d&bslash;n&quot;
comma
id|ret
)paren
suffix:semicolon
r_if
c_cond
(paren
id|call-&gt;app_call_state
op_ne
id|RXRPC_CSTATE_ERROR
)paren
id|rxrpc_call_abort
c_func
(paren
id|call
comma
id|ret
)paren
suffix:semicolon
id|_leave
c_func
(paren
l_string|&quot;&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|call-&gt;app_opcode
op_assign
id|ntohl
c_func
(paren
id|opid
)paren
suffix:semicolon
multiline_comment|/* locate the operation in the available ops table */
id|optbl
op_assign
id|call-&gt;conn-&gt;service-&gt;ops_begin
suffix:semicolon
id|lo
op_assign
l_int|0
suffix:semicolon
id|hi
op_assign
id|call-&gt;conn-&gt;service-&gt;ops_end
op_minus
id|optbl
suffix:semicolon
r_while
c_loop
(paren
id|lo
OL
id|hi
)paren
(brace
r_int
id|mid
op_assign
(paren
id|hi
op_plus
id|lo
)paren
op_div
l_int|2
suffix:semicolon
id|op
op_assign
op_amp
id|optbl
(braket
id|mid
)braket
suffix:semicolon
r_if
c_cond
(paren
id|call-&gt;app_opcode
op_eq
id|op-&gt;id
)paren
r_goto
id|found_op
suffix:semicolon
r_if
c_cond
(paren
id|call-&gt;app_opcode
OG
id|op-&gt;id
)paren
id|lo
op_assign
id|mid
op_plus
l_int|1
suffix:semicolon
r_else
id|hi
op_assign
id|mid
suffix:semicolon
)brace
multiline_comment|/* search failed */
id|kproto
c_func
(paren
l_string|&quot;Rx Client requested operation %d from %s service&quot;
comma
id|call-&gt;app_opcode
comma
id|call-&gt;conn-&gt;service-&gt;name
)paren
suffix:semicolon
id|rxrpc_call_abort
c_func
(paren
id|call
comma
op_minus
id|EINVAL
)paren
suffix:semicolon
id|_leave
c_func
(paren
l_string|&quot; [inval]&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
id|found_op
suffix:colon
id|_proto
c_func
(paren
l_string|&quot;Rx Client requested operation %s from %s service&quot;
comma
id|op-&gt;name
comma
id|call-&gt;conn-&gt;service-&gt;name
)paren
suffix:semicolon
multiline_comment|/* we&squot;re now waiting for the argument block (unless the call&n;&t;&t; * was aborted) */
id|spin_lock
c_func
(paren
op_amp
id|call-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|call-&gt;app_call_state
op_eq
id|RXRPC_CSTATE_SRVR_RCV_OPID
op_logical_or
id|call-&gt;app_call_state
op_eq
id|RXRPC_CSTATE_SRVR_SND_REPLY
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|call-&gt;app_last_rcv
)paren
id|call-&gt;app_call_state
op_assign
id|RXRPC_CSTATE_SRVR_RCV_ARGS
suffix:semicolon
r_else
r_if
c_cond
(paren
id|call-&gt;app_ready_qty
OG
l_int|0
)paren
id|call-&gt;app_call_state
op_assign
id|RXRPC_CSTATE_SRVR_GOT_ARGS
suffix:semicolon
r_else
id|call-&gt;app_call_state
op_assign
id|RXRPC_CSTATE_SRVR_SND_REPLY
suffix:semicolon
id|call-&gt;app_mark
op_assign
id|op-&gt;asize
suffix:semicolon
id|call-&gt;app_user
op_assign
id|op-&gt;user
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|call-&gt;lock
)paren
suffix:semicolon
id|_state
c_func
(paren
id|call
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|RXRPC_CSTATE_SRVR_RCV_ARGS
suffix:colon
multiline_comment|/* change state if just received last packet of arg block */
r_if
c_cond
(paren
id|call-&gt;app_last_rcv
)paren
id|call-&gt;app_call_state
op_assign
id|RXRPC_CSTATE_SRVR_GOT_ARGS
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|call-&gt;lock
)paren
suffix:semicolon
id|_state
c_func
(paren
id|call
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|RXRPC_CSTATE_CLNT_RCV_REPLY
suffix:colon
multiline_comment|/* change state if just received last packet of reply block */
id|rmtimo
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|call-&gt;app_last_rcv
)paren
(brace
id|call-&gt;app_call_state
op_assign
id|RXRPC_CSTATE_CLNT_GOT_REPLY
suffix:semicolon
id|rmtimo
op_assign
l_int|1
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|call-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rmtimo
)paren
(brace
id|del_timer_sync
c_func
(paren
op_amp
id|call-&gt;acks_timeout
)paren
suffix:semicolon
id|del_timer_sync
c_func
(paren
op_amp
id|call-&gt;rcv_timeout
)paren
suffix:semicolon
id|del_timer_sync
c_func
(paren
op_amp
id|call-&gt;ackr_dfr_timo
)paren
suffix:semicolon
)brace
id|_state
c_func
(paren
id|call
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* deal with data reception in an unexpected state */
id|printk
c_func
(paren
l_string|&quot;Unexpected state [[[ %u ]]]&bslash;n&quot;
comma
id|call-&gt;app_call_state
)paren
suffix:semicolon
id|__rxrpc_call_abort
c_func
(paren
id|call
comma
op_minus
id|EBADMSG
)paren
suffix:semicolon
id|_leave
c_func
(paren
l_string|&quot;&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|call-&gt;app_call_state
op_eq
id|RXRPC_CSTATE_CLNT_RCV_REPLY
op_logical_and
id|call-&gt;app_last_rcv
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* otherwise just invoke the data function whenever we can satisfy its desire for more&n;&t; * data&n;&t; */
id|_proto
c_func
(paren
l_string|&quot;Rx Received Op Data: st=%u qty=%Zu mk=%Zu%s&quot;
comma
id|call-&gt;app_call_state
comma
id|call-&gt;app_ready_qty
comma
id|call-&gt;app_mark
comma
id|call-&gt;app_last_rcv
ques
c_cond
l_string|&quot; last-rcvd&quot;
suffix:colon
l_string|&quot;&quot;
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|call-&gt;lock
)paren
suffix:semicolon
id|ret
op_assign
id|__rxrpc_call_read_data
c_func
(paren
id|call
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|ret
)paren
(brace
r_case
l_int|0
suffix:colon
id|spin_unlock
c_func
(paren
op_amp
id|call-&gt;lock
)paren
suffix:semicolon
id|call
op_member_access_from_pointer
id|app_attn_func
c_func
(paren
id|call
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
op_minus
id|EAGAIN
suffix:colon
id|spin_unlock
c_func
(paren
op_amp
id|call-&gt;lock
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
op_minus
id|ECONNABORTED
suffix:colon
id|spin_unlock
c_func
(paren
op_amp
id|call-&gt;lock
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|__rxrpc_call_abort
c_func
(paren
id|call
comma
id|ret
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|_state
c_func
(paren
id|call
)paren
suffix:semicolon
id|_leave
c_func
(paren
l_string|&quot;&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* end rxrpc_call_receive_data_packet() */
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * received an ACK packet&n; */
DECL|function|rxrpc_call_receive_ack_packet
r_static
r_void
id|rxrpc_call_receive_ack_packet
c_func
(paren
r_struct
id|rxrpc_call
op_star
id|call
comma
r_struct
id|rxrpc_message
op_star
id|msg
)paren
(brace
r_struct
id|rxrpc_ackpacket
id|_ack
comma
op_star
id|ap
suffix:semicolon
id|rxrpc_serial_net_t
id|serial
suffix:semicolon
id|rxrpc_seq_t
id|seq
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|_enter
c_func
(paren
l_string|&quot;%p{%u},%p{%u}&quot;
comma
id|call
comma
id|ntohl
c_func
(paren
id|call-&gt;call_id
)paren
comma
id|msg
comma
id|msg-&gt;seq
)paren
suffix:semicolon
multiline_comment|/* extract the basic ACK record */
id|ap
op_assign
id|skb_header_pointer
c_func
(paren
id|msg-&gt;pkt
comma
id|msg-&gt;offset
comma
r_sizeof
(paren
id|_ack
)paren
comma
op_amp
id|_ack
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ap
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Rx Received short ACK packet&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|msg-&gt;offset
op_add_assign
r_sizeof
(paren
id|_ack
)paren
suffix:semicolon
id|serial
op_assign
id|ap-&gt;serial
suffix:semicolon
id|seq
op_assign
id|ntohl
c_func
(paren
id|ap-&gt;firstPacket
)paren
suffix:semicolon
id|_proto
c_func
(paren
l_string|&quot;Rx Received ACK %%%d { b=%hu m=%hu f=%u p=%u s=%u r=%s n=%u }&quot;
comma
id|ntohl
c_func
(paren
id|msg-&gt;hdr.serial
)paren
comma
id|ntohs
c_func
(paren
id|ap-&gt;bufferSpace
)paren
comma
id|ntohs
c_func
(paren
id|ap-&gt;maxSkew
)paren
comma
id|seq
comma
id|ntohl
c_func
(paren
id|ap-&gt;previousPacket
)paren
comma
id|ntohl
c_func
(paren
id|serial
)paren
comma
id|rxrpc_acks
(braket
id|ap-&gt;reason
)braket
comma
id|call-&gt;ackr.nAcks
)paren
suffix:semicolon
multiline_comment|/* check the other side isn&squot;t ACK&squot;ing a sequence number I haven&squot;t sent&n;&t; * yet */
r_if
c_cond
(paren
id|ap-&gt;nAcks
OG
l_int|0
op_logical_and
(paren
id|seq
OG
id|call-&gt;snd_seq_count
op_logical_or
id|seq
op_plus
id|ap-&gt;nAcks
op_minus
l_int|1
OG
id|call-&gt;snd_seq_count
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Received ACK (#%u-#%u) for unsent packet&bslash;n&quot;
comma
id|seq
comma
id|seq
op_plus
id|ap-&gt;nAcks
op_minus
l_int|1
)paren
suffix:semicolon
id|rxrpc_call_abort
c_func
(paren
id|call
comma
op_minus
id|EINVAL
)paren
suffix:semicolon
id|_leave
c_func
(paren
l_string|&quot;&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* deal with RTT calculation */
r_if
c_cond
(paren
id|serial
)paren
(brace
r_struct
id|rxrpc_message
op_star
id|rttmsg
suffix:semicolon
multiline_comment|/* find the prompting packet */
id|spin_lock
c_func
(paren
op_amp
id|call-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|call-&gt;snd_ping
op_logical_and
id|call-&gt;snd_ping-&gt;hdr.serial
op_eq
id|serial
)paren
(brace
multiline_comment|/* it was a ping packet */
id|rttmsg
op_assign
id|call-&gt;snd_ping
suffix:semicolon
id|call-&gt;snd_ping
op_assign
l_int|NULL
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|call-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rttmsg
)paren
(brace
id|rttmsg-&gt;rttdone
op_assign
l_int|1
suffix:semicolon
id|rxrpc_peer_calculate_rtt
c_func
(paren
id|call-&gt;conn-&gt;peer
comma
id|rttmsg
comma
id|msg
)paren
suffix:semicolon
id|rxrpc_put_message
c_func
(paren
id|rttmsg
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
r_struct
id|list_head
op_star
id|_p
suffix:semicolon
multiline_comment|/* it ought to be a data packet - look in the pending&n;&t;&t;&t; * ACK list */
id|list_for_each
c_func
(paren
id|_p
comma
op_amp
id|call-&gt;acks_pendq
)paren
(brace
id|rttmsg
op_assign
id|list_entry
c_func
(paren
id|_p
comma
r_struct
id|rxrpc_message
comma
id|link
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rttmsg-&gt;hdr.serial
op_eq
id|serial
)paren
(brace
r_if
c_cond
(paren
id|rttmsg-&gt;rttdone
)paren
multiline_comment|/* never do RTT twice without&n;&t;&t;&t;&t;&t;&t; * resending */
r_break
suffix:semicolon
id|rttmsg-&gt;rttdone
op_assign
l_int|1
suffix:semicolon
id|rxrpc_peer_calculate_rtt
c_func
(paren
id|call-&gt;conn-&gt;peer
comma
id|rttmsg
comma
id|msg
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|spin_unlock
c_func
(paren
op_amp
id|call-&gt;lock
)paren
suffix:semicolon
)brace
)brace
r_switch
c_cond
(paren
id|ap-&gt;reason
)paren
(brace
multiline_comment|/* deal with negative/positive acknowledgement of data&n;&t;&t; * packets */
r_case
id|RXRPC_ACK_REQUESTED
suffix:colon
r_case
id|RXRPC_ACK_DELAY
suffix:colon
r_case
id|RXRPC_ACK_IDLE
suffix:colon
id|rxrpc_call_definitively_ACK
c_func
(paren
id|call
comma
id|seq
op_minus
l_int|1
)paren
suffix:semicolon
r_case
id|RXRPC_ACK_DUPLICATE
suffix:colon
r_case
id|RXRPC_ACK_OUT_OF_SEQUENCE
suffix:colon
r_case
id|RXRPC_ACK_EXCEEDS_WINDOW
suffix:colon
id|call-&gt;snd_resend_cnt
op_assign
l_int|0
suffix:semicolon
id|ret
op_assign
id|rxrpc_call_record_ACK
c_func
(paren
id|call
comma
id|msg
comma
id|seq
comma
id|ap-&gt;nAcks
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
id|rxrpc_call_abort
c_func
(paren
id|call
comma
id|ret
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* respond to ping packets immediately */
r_case
id|RXRPC_ACK_PING
suffix:colon
id|rxrpc_call_generate_ACK
c_func
(paren
id|call
comma
op_amp
id|msg-&gt;hdr
comma
id|ap
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* only record RTT on ping response packets */
r_case
id|RXRPC_ACK_PING_RESPONSE
suffix:colon
r_if
c_cond
(paren
id|call-&gt;snd_ping
)paren
(brace
r_struct
id|rxrpc_message
op_star
id|rttmsg
suffix:semicolon
multiline_comment|/* only do RTT stuff if the response matches the&n;&t;&t;&t; * retained ping */
id|rttmsg
op_assign
l_int|NULL
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|call-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|call-&gt;snd_ping
op_logical_and
id|call-&gt;snd_ping-&gt;hdr.serial
op_eq
id|ap-&gt;serial
)paren
(brace
id|rttmsg
op_assign
id|call-&gt;snd_ping
suffix:semicolon
id|call-&gt;snd_ping
op_assign
l_int|NULL
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|call-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rttmsg
)paren
(brace
id|rttmsg-&gt;rttdone
op_assign
l_int|1
suffix:semicolon
id|rxrpc_peer_calculate_rtt
c_func
(paren
id|call-&gt;conn-&gt;peer
comma
id|rttmsg
comma
id|msg
)paren
suffix:semicolon
id|rxrpc_put_message
c_func
(paren
id|rttmsg
)paren
suffix:semicolon
)brace
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;Unsupported ACK reason %u&bslash;n&quot;
comma
id|ap-&gt;reason
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|_leave
c_func
(paren
l_string|&quot;&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* end rxrpc_call_receive_ack_packet() */
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * record definitive ACKs for all messages up to and including the one with the&n; * &squot;highest&squot; seq&n; */
DECL|function|rxrpc_call_definitively_ACK
r_static
r_void
id|rxrpc_call_definitively_ACK
c_func
(paren
r_struct
id|rxrpc_call
op_star
id|call
comma
id|rxrpc_seq_t
id|highest
)paren
(brace
r_struct
id|rxrpc_message
op_star
id|msg
suffix:semicolon
r_int
id|now_complete
suffix:semicolon
id|_enter
c_func
(paren
l_string|&quot;%p{ads=%u},%u&quot;
comma
id|call
comma
id|call-&gt;acks_dftv_seq
comma
id|highest
)paren
suffix:semicolon
r_while
c_loop
(paren
id|call-&gt;acks_dftv_seq
OL
id|highest
)paren
(brace
id|call-&gt;acks_dftv_seq
op_increment
suffix:semicolon
id|_proto
c_func
(paren
l_string|&quot;Definitive ACK on packet #%u&quot;
comma
id|call-&gt;acks_dftv_seq
)paren
suffix:semicolon
multiline_comment|/* discard those at front of queue until message with highest&n;&t;&t; * ACK is found */
id|spin_lock
c_func
(paren
op_amp
id|call-&gt;lock
)paren
suffix:semicolon
id|msg
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|call-&gt;acks_pendq
)paren
)paren
(brace
id|msg
op_assign
id|list_entry
c_func
(paren
id|call-&gt;acks_pendq.next
comma
r_struct
id|rxrpc_message
comma
id|link
)paren
suffix:semicolon
id|list_del_init
c_func
(paren
op_amp
id|msg-&gt;link
)paren
suffix:semicolon
multiline_comment|/* dequeue */
r_if
c_cond
(paren
id|msg-&gt;state
op_eq
id|RXRPC_MSG_SENT
)paren
id|call-&gt;acks_pend_cnt
op_decrement
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|call-&gt;lock
)paren
suffix:semicolon
multiline_comment|/* insanity check */
r_if
c_cond
(paren
op_logical_neg
id|msg
)paren
id|panic
c_func
(paren
l_string|&quot;%s(): acks_pendq unexpectedly empty&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_if
c_cond
(paren
id|msg-&gt;seq
op_ne
id|call-&gt;acks_dftv_seq
)paren
id|panic
c_func
(paren
l_string|&quot;%s(): Packet #%u expected at front of acks_pendq&quot;
l_string|&quot; (#%u found)&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|call-&gt;acks_dftv_seq
comma
id|msg-&gt;seq
)paren
suffix:semicolon
multiline_comment|/* discard the message */
id|msg-&gt;state
op_assign
id|RXRPC_MSG_DONE
suffix:semicolon
id|rxrpc_put_message
c_func
(paren
id|msg
)paren
suffix:semicolon
)brace
multiline_comment|/* if all sent packets are definitively ACK&squot;d then prod any sleepers just in case */
id|now_complete
op_assign
l_int|0
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|call-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|call-&gt;acks_dftv_seq
op_eq
id|call-&gt;snd_seq_count
)paren
(brace
r_if
c_cond
(paren
id|call-&gt;app_call_state
op_ne
id|RXRPC_CSTATE_COMPLETE
)paren
(brace
id|call-&gt;app_call_state
op_assign
id|RXRPC_CSTATE_COMPLETE
suffix:semicolon
id|_state
c_func
(paren
id|call
)paren
suffix:semicolon
id|now_complete
op_assign
l_int|1
suffix:semicolon
)brace
)brace
id|spin_unlock
c_func
(paren
op_amp
id|call-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|now_complete
)paren
(brace
id|del_timer_sync
c_func
(paren
op_amp
id|call-&gt;acks_timeout
)paren
suffix:semicolon
id|del_timer_sync
c_func
(paren
op_amp
id|call-&gt;rcv_timeout
)paren
suffix:semicolon
id|del_timer_sync
c_func
(paren
op_amp
id|call-&gt;ackr_dfr_timo
)paren
suffix:semicolon
id|call
op_member_access_from_pointer
id|app_attn_func
c_func
(paren
id|call
)paren
suffix:semicolon
)brace
id|_leave
c_func
(paren
l_string|&quot;&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* end rxrpc_call_definitively_ACK() */
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * record the specified amount of ACKs/NAKs&n; */
DECL|function|rxrpc_call_record_ACK
r_static
r_int
id|rxrpc_call_record_ACK
c_func
(paren
r_struct
id|rxrpc_call
op_star
id|call
comma
r_struct
id|rxrpc_message
op_star
id|msg
comma
id|rxrpc_seq_t
id|seq
comma
r_int
id|count
)paren
(brace
r_struct
id|rxrpc_message
op_star
id|dmsg
suffix:semicolon
r_struct
id|list_head
op_star
id|_p
suffix:semicolon
id|rxrpc_seq_t
id|highest
suffix:semicolon
r_int
id|ix
suffix:semicolon
r_int
id|chunk
suffix:semicolon
r_char
id|resend
comma
id|now_complete
suffix:semicolon
id|u8
id|acks
(braket
l_int|16
)braket
suffix:semicolon
id|_enter
c_func
(paren
l_string|&quot;%p{apc=%u ads=%u},%p,%u,%Zu&quot;
comma
id|call
comma
id|call-&gt;acks_pend_cnt
comma
id|call-&gt;acks_dftv_seq
comma
id|msg
comma
id|seq
comma
id|count
)paren
suffix:semicolon
multiline_comment|/* handle re-ACK&squot;ing of definitively ACK&squot;d packets (may be out-of-order&n;&t; * ACKs) */
r_if
c_cond
(paren
id|seq
op_le
id|call-&gt;acks_dftv_seq
)paren
(brace
r_int
id|delta
op_assign
id|call-&gt;acks_dftv_seq
op_minus
id|seq
suffix:semicolon
r_if
c_cond
(paren
id|count
op_le
id|delta
)paren
(brace
id|_leave
c_func
(paren
l_string|&quot; = 0 [all definitively ACK&squot;d]&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|seq
op_add_assign
id|delta
suffix:semicolon
id|count
op_sub_assign
id|delta
suffix:semicolon
id|msg-&gt;offset
op_add_assign
id|delta
suffix:semicolon
)brace
id|highest
op_assign
id|seq
op_plus
id|count
op_minus
l_int|1
suffix:semicolon
id|resend
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|count
OG
l_int|0
)paren
(brace
multiline_comment|/* extract up to 16 ACK slots at a time */
id|chunk
op_assign
id|min
c_func
(paren
id|count
comma
r_sizeof
(paren
id|acks
)paren
)paren
suffix:semicolon
id|count
op_sub_assign
id|chunk
suffix:semicolon
id|memset
c_func
(paren
id|acks
comma
l_int|2
comma
r_sizeof
(paren
id|acks
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb_copy_bits
c_func
(paren
id|msg-&gt;pkt
comma
id|msg-&gt;offset
comma
op_amp
id|acks
comma
id|chunk
)paren
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Rx Received short ACK packet&bslash;n&quot;
)paren
suffix:semicolon
id|_leave
c_func
(paren
l_string|&quot; = -EINVAL&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|msg-&gt;offset
op_add_assign
id|chunk
suffix:semicolon
multiline_comment|/* check that the ACK set is valid */
r_for
c_loop
(paren
id|ix
op_assign
l_int|0
suffix:semicolon
id|ix
OL
id|chunk
suffix:semicolon
id|ix
op_increment
)paren
(brace
r_switch
c_cond
(paren
id|acks
(braket
id|ix
)braket
)paren
(brace
r_case
id|RXRPC_ACK_TYPE_ACK
suffix:colon
r_break
suffix:semicolon
r_case
id|RXRPC_ACK_TYPE_NACK
suffix:colon
id|resend
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;Rx Received unsupported ACK state&quot;
l_string|&quot; %u&bslash;n&quot;
comma
id|acks
(braket
id|ix
)braket
)paren
suffix:semicolon
id|_leave
c_func
(paren
l_string|&quot; = -EINVAL&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
id|_proto
c_func
(paren
l_string|&quot;Rx ACK of packets #%u-#%u &quot;
l_string|&quot;[%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c] (pend=%u)&quot;
comma
id|seq
comma
(paren
r_int
)paren
(paren
id|seq
op_plus
id|chunk
op_minus
l_int|1
)paren
comma
id|_acktype
(braket
id|acks
(braket
l_int|0x0
)braket
)braket
comma
id|_acktype
(braket
id|acks
(braket
l_int|0x1
)braket
)braket
comma
id|_acktype
(braket
id|acks
(braket
l_int|0x2
)braket
)braket
comma
id|_acktype
(braket
id|acks
(braket
l_int|0x3
)braket
)braket
comma
id|_acktype
(braket
id|acks
(braket
l_int|0x4
)braket
)braket
comma
id|_acktype
(braket
id|acks
(braket
l_int|0x5
)braket
)braket
comma
id|_acktype
(braket
id|acks
(braket
l_int|0x6
)braket
)braket
comma
id|_acktype
(braket
id|acks
(braket
l_int|0x7
)braket
)braket
comma
id|_acktype
(braket
id|acks
(braket
l_int|0x8
)braket
)braket
comma
id|_acktype
(braket
id|acks
(braket
l_int|0x9
)braket
)braket
comma
id|_acktype
(braket
id|acks
(braket
l_int|0xA
)braket
)braket
comma
id|_acktype
(braket
id|acks
(braket
l_int|0xB
)braket
)braket
comma
id|_acktype
(braket
id|acks
(braket
l_int|0xC
)braket
)braket
comma
id|_acktype
(braket
id|acks
(braket
l_int|0xD
)braket
)braket
comma
id|_acktype
(braket
id|acks
(braket
l_int|0xE
)braket
)braket
comma
id|_acktype
(braket
id|acks
(braket
l_int|0xF
)braket
)braket
comma
id|call-&gt;acks_pend_cnt
)paren
suffix:semicolon
multiline_comment|/* mark the packets in the ACK queue as being provisionally&n;&t;&t; * ACK&squot;d */
id|ix
op_assign
l_int|0
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|call-&gt;lock
)paren
suffix:semicolon
multiline_comment|/* find the first packet ACK&squot;d/NAK&squot;d here */
id|list_for_each
c_func
(paren
id|_p
comma
op_amp
id|call-&gt;acks_pendq
)paren
(brace
id|dmsg
op_assign
id|list_entry
c_func
(paren
id|_p
comma
r_struct
id|rxrpc_message
comma
id|link
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dmsg-&gt;seq
op_eq
id|seq
)paren
r_goto
id|found_first
suffix:semicolon
id|_debug
c_func
(paren
l_string|&quot;- %u: skipping #%u&quot;
comma
id|ix
comma
id|dmsg-&gt;seq
)paren
suffix:semicolon
)brace
r_goto
id|bad_queue
suffix:semicolon
id|found_first
suffix:colon
r_do
(brace
id|_debug
c_func
(paren
l_string|&quot;- %u: processing #%u (%c) apc=%u&quot;
comma
id|ix
comma
id|dmsg-&gt;seq
comma
id|_acktype
(braket
id|acks
(braket
id|ix
)braket
)braket
comma
id|call-&gt;acks_pend_cnt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|acks
(braket
id|ix
)braket
op_eq
id|RXRPC_ACK_TYPE_ACK
)paren
(brace
r_if
c_cond
(paren
id|dmsg-&gt;state
op_eq
id|RXRPC_MSG_SENT
)paren
id|call-&gt;acks_pend_cnt
op_decrement
suffix:semicolon
id|dmsg-&gt;state
op_assign
id|RXRPC_MSG_ACKED
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|dmsg-&gt;state
op_eq
id|RXRPC_MSG_ACKED
)paren
id|call-&gt;acks_pend_cnt
op_increment
suffix:semicolon
id|dmsg-&gt;state
op_assign
id|RXRPC_MSG_SENT
suffix:semicolon
)brace
id|ix
op_increment
suffix:semicolon
id|seq
op_increment
suffix:semicolon
id|_p
op_assign
id|dmsg-&gt;link.next
suffix:semicolon
id|dmsg
op_assign
id|list_entry
c_func
(paren
id|_p
comma
r_struct
id|rxrpc_message
comma
id|link
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|ix
OL
id|chunk
op_logical_and
id|_p
op_ne
op_amp
id|call-&gt;acks_pendq
op_logical_and
id|dmsg-&gt;seq
op_eq
id|seq
)paren
(brace
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ix
OL
id|chunk
)paren
r_goto
id|bad_queue
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|call-&gt;lock
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|resend
)paren
id|rxrpc_call_resend
c_func
(paren
id|call
comma
id|highest
)paren
suffix:semicolon
multiline_comment|/* if all packets are provisionally ACK&squot;d, then wake up anyone who&squot;s&n;&t; * waiting for that */
id|now_complete
op_assign
l_int|0
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|call-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|call-&gt;acks_pend_cnt
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|call-&gt;app_call_state
op_eq
id|RXRPC_CSTATE_SRVR_RCV_FINAL_ACK
)paren
(brace
id|call-&gt;app_call_state
op_assign
id|RXRPC_CSTATE_COMPLETE
suffix:semicolon
id|_state
c_func
(paren
id|call
)paren
suffix:semicolon
)brace
id|now_complete
op_assign
l_int|1
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|call-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|now_complete
)paren
(brace
id|_debug
c_func
(paren
l_string|&quot;- wake up waiters&quot;
)paren
suffix:semicolon
id|del_timer_sync
c_func
(paren
op_amp
id|call-&gt;acks_timeout
)paren
suffix:semicolon
id|del_timer_sync
c_func
(paren
op_amp
id|call-&gt;rcv_timeout
)paren
suffix:semicolon
id|del_timer_sync
c_func
(paren
op_amp
id|call-&gt;ackr_dfr_timo
)paren
suffix:semicolon
id|call
op_member_access_from_pointer
id|app_attn_func
c_func
(paren
id|call
)paren
suffix:semicolon
)brace
id|_leave
c_func
(paren
l_string|&quot; = 0 (apc=%u)&quot;
comma
id|call-&gt;acks_pend_cnt
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|bad_queue
suffix:colon
id|panic
c_func
(paren
l_string|&quot;%s(): acks_pendq in bad state (packet #%u absent)&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|seq
)paren
suffix:semicolon
)brace
multiline_comment|/* end rxrpc_call_record_ACK() */
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * transfer data from the ready packet queue to the asynchronous read buffer&n; * - since this func is the only one going to look at packets queued on&n; *   app_readyq, we don&squot;t need a lock to modify or access them, only to modify&n; *   the queue pointers&n; * - called with call-&gt;lock held&n; * - the buffer must be in kernel space&n; * - returns:&n; *&t;0 if buffer filled&n; *&t;-EAGAIN if buffer not filled and more data to come&n; *&t;-EBADMSG if last packet received and insufficient data left&n; *&t;-ECONNABORTED if the call has in an error state&n; */
DECL|function|__rxrpc_call_read_data
r_static
r_int
id|__rxrpc_call_read_data
c_func
(paren
r_struct
id|rxrpc_call
op_star
id|call
)paren
(brace
r_struct
id|rxrpc_message
op_star
id|msg
suffix:semicolon
r_int
id|qty
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|_enter
c_func
(paren
l_string|&quot;%p{as=%d buf=%p qty=%Zu/%Zu}&quot;
comma
id|call
comma
id|call-&gt;app_async_read
comma
id|call-&gt;app_read_buf
comma
id|call-&gt;app_ready_qty
comma
id|call-&gt;app_mark
)paren
suffix:semicolon
multiline_comment|/* check the state */
r_switch
c_cond
(paren
id|call-&gt;app_call_state
)paren
(brace
r_case
id|RXRPC_CSTATE_SRVR_RCV_ARGS
suffix:colon
r_case
id|RXRPC_CSTATE_CLNT_RCV_REPLY
suffix:colon
r_if
c_cond
(paren
id|call-&gt;app_last_rcv
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s(%p,%p,%Zd):&quot;
l_string|&quot; Inconsistent call state (%s, last pkt)&quot;
comma
id|__FUNCTION__
comma
id|call
comma
id|call-&gt;app_read_buf
comma
id|call-&gt;app_mark
comma
id|rxrpc_call_states
(braket
id|call-&gt;app_call_state
)braket
)paren
suffix:semicolon
id|BUG
c_func
(paren
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|RXRPC_CSTATE_SRVR_RCV_OPID
suffix:colon
r_case
id|RXRPC_CSTATE_SRVR_GOT_ARGS
suffix:colon
r_case
id|RXRPC_CSTATE_CLNT_GOT_REPLY
suffix:colon
r_break
suffix:semicolon
r_case
id|RXRPC_CSTATE_SRVR_SND_REPLY
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|call-&gt;app_last_rcv
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%s(%p,%p,%Zd):&quot;
l_string|&quot; Inconsistent call state (%s, not last pkt)&quot;
comma
id|__FUNCTION__
comma
id|call
comma
id|call-&gt;app_read_buf
comma
id|call-&gt;app_mark
comma
id|rxrpc_call_states
(braket
id|call-&gt;app_call_state
)braket
)paren
suffix:semicolon
id|BUG
c_func
(paren
)paren
suffix:semicolon
)brace
id|_debug
c_func
(paren
l_string|&quot;Trying to read data from call in SND_REPLY state&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|RXRPC_CSTATE_ERROR
suffix:colon
id|_leave
c_func
(paren
l_string|&quot; = -ECONNABORTED&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ECONNABORTED
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;reading in unexpected state [[[ %u ]]]&bslash;n&quot;
comma
id|call-&gt;app_call_state
)paren
suffix:semicolon
id|BUG
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* handle the case of not having an async buffer */
r_if
c_cond
(paren
op_logical_neg
id|call-&gt;app_async_read
)paren
(brace
r_if
c_cond
(paren
id|call-&gt;app_mark
op_eq
id|RXRPC_APP_MARK_EOF
)paren
(brace
id|ret
op_assign
id|call-&gt;app_last_rcv
ques
c_cond
l_int|0
suffix:colon
op_minus
id|EAGAIN
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|call-&gt;app_mark
op_ge
id|call-&gt;app_ready_qty
)paren
(brace
id|call-&gt;app_mark
op_assign
id|RXRPC_APP_MARK_EOF
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|ret
op_assign
id|call-&gt;app_last_rcv
ques
c_cond
op_minus
id|EBADMSG
suffix:colon
op_minus
id|EAGAIN
suffix:semicolon
)brace
)brace
id|_leave
c_func
(paren
l_string|&quot; = %d [no buf]&quot;
comma
id|ret
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_while
c_loop
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|call-&gt;app_readyq
)paren
op_logical_and
id|call-&gt;app_mark
OG
l_int|0
)paren
(brace
id|msg
op_assign
id|list_entry
c_func
(paren
id|call-&gt;app_readyq.next
comma
r_struct
id|rxrpc_message
comma
id|link
)paren
suffix:semicolon
multiline_comment|/* drag as much data as we need out of this packet */
id|qty
op_assign
id|min
c_func
(paren
id|call-&gt;app_mark
comma
id|msg-&gt;dsize
)paren
suffix:semicolon
id|_debug
c_func
(paren
l_string|&quot;reading %Zu from skb=%p off=%lu&quot;
comma
id|qty
comma
id|msg-&gt;pkt
comma
id|msg-&gt;offset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|call-&gt;app_read_buf
)paren
r_if
c_cond
(paren
id|skb_copy_bits
c_func
(paren
id|msg-&gt;pkt
comma
id|msg-&gt;offset
comma
id|call-&gt;app_read_buf
comma
id|qty
)paren
OL
l_int|0
)paren
id|panic
c_func
(paren
l_string|&quot;%s: Failed to copy data from packet:&quot;
l_string|&quot; (%p,%p,%Zd)&quot;
comma
id|__FUNCTION__
comma
id|call
comma
id|call-&gt;app_read_buf
comma
id|qty
)paren
suffix:semicolon
multiline_comment|/* if that packet is now empty, discard it */
id|call-&gt;app_ready_qty
op_sub_assign
id|qty
suffix:semicolon
id|msg-&gt;dsize
op_sub_assign
id|qty
suffix:semicolon
r_if
c_cond
(paren
id|msg-&gt;dsize
op_eq
l_int|0
)paren
(brace
id|list_del_init
c_func
(paren
op_amp
id|msg-&gt;link
)paren
suffix:semicolon
id|rxrpc_put_message
c_func
(paren
id|msg
)paren
suffix:semicolon
)brace
r_else
(brace
id|msg-&gt;offset
op_add_assign
id|qty
suffix:semicolon
)brace
id|call-&gt;app_mark
op_sub_assign
id|qty
suffix:semicolon
r_if
c_cond
(paren
id|call-&gt;app_read_buf
)paren
id|call-&gt;app_read_buf
op_add_assign
id|qty
suffix:semicolon
)brace
r_if
c_cond
(paren
id|call-&gt;app_mark
op_eq
l_int|0
)paren
(brace
id|call-&gt;app_async_read
op_assign
l_int|0
suffix:semicolon
id|call-&gt;app_mark
op_assign
id|RXRPC_APP_MARK_EOF
suffix:semicolon
id|call-&gt;app_read_buf
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* adjust the state if used up all packets */
r_if
c_cond
(paren
id|list_empty
c_func
(paren
op_amp
id|call-&gt;app_readyq
)paren
op_logical_and
id|call-&gt;app_last_rcv
)paren
(brace
r_switch
c_cond
(paren
id|call-&gt;app_call_state
)paren
(brace
r_case
id|RXRPC_CSTATE_SRVR_RCV_OPID
suffix:colon
id|call-&gt;app_call_state
op_assign
id|RXRPC_CSTATE_SRVR_SND_REPLY
suffix:semicolon
id|call-&gt;app_mark
op_assign
id|RXRPC_APP_MARK_EOF
suffix:semicolon
id|_state
c_func
(paren
id|call
)paren
suffix:semicolon
id|del_timer_sync
c_func
(paren
op_amp
id|call-&gt;rcv_timeout
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|RXRPC_CSTATE_SRVR_GOT_ARGS
suffix:colon
id|call-&gt;app_call_state
op_assign
id|RXRPC_CSTATE_SRVR_SND_REPLY
suffix:semicolon
id|_state
c_func
(paren
id|call
)paren
suffix:semicolon
id|del_timer_sync
c_func
(paren
op_amp
id|call-&gt;rcv_timeout
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|call-&gt;app_call_state
op_assign
id|RXRPC_CSTATE_COMPLETE
suffix:semicolon
id|_state
c_func
(paren
id|call
)paren
suffix:semicolon
id|del_timer_sync
c_func
(paren
op_amp
id|call-&gt;acks_timeout
)paren
suffix:semicolon
id|del_timer_sync
c_func
(paren
op_amp
id|call-&gt;ackr_dfr_timo
)paren
suffix:semicolon
id|del_timer_sync
c_func
(paren
op_amp
id|call-&gt;rcv_timeout
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|_leave
c_func
(paren
l_string|&quot; = 0&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|call-&gt;app_last_rcv
)paren
(brace
id|_debug
c_func
(paren
l_string|&quot;Insufficient data (%Zu/%Zu)&quot;
comma
id|call-&gt;app_ready_qty
comma
id|call-&gt;app_mark
)paren
suffix:semicolon
id|call-&gt;app_async_read
op_assign
l_int|0
suffix:semicolon
id|call-&gt;app_mark
op_assign
id|RXRPC_APP_MARK_EOF
suffix:semicolon
id|call-&gt;app_read_buf
op_assign
l_int|NULL
suffix:semicolon
id|_leave
c_func
(paren
l_string|&quot; = -EBADMSG&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EBADMSG
suffix:semicolon
)brace
id|_leave
c_func
(paren
l_string|&quot; = -EAGAIN&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
multiline_comment|/* end __rxrpc_call_read_data() */
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * attempt to read the specified amount of data from the call&squot;s ready queue&n; * into the buffer provided&n; * - since this func is the only one going to look at packets queued on&n; *   app_readyq, we don&squot;t need a lock to modify or access them, only to modify&n; *   the queue pointers&n; * - if the buffer pointer is NULL, then data is merely drained, not copied&n; * - if flags&amp;RXRPC_CALL_READ_BLOCK, then the function will wait until there is&n; *   enough data or an error will be generated&n; *   - note that the caller must have added the calling task to the call&squot;s wait&n; *     queue beforehand&n; * - if flags&amp;RXRPC_CALL_READ_ALL, then an error will be generated if this&n; *   function doesn&squot;t read all available data&n; */
DECL|function|rxrpc_call_read_data
r_int
id|rxrpc_call_read_data
c_func
(paren
r_struct
id|rxrpc_call
op_star
id|call
comma
r_void
op_star
id|buffer
comma
r_int
id|size
comma
r_int
id|flags
)paren
(brace
r_int
id|ret
suffix:semicolon
id|_enter
c_func
(paren
l_string|&quot;%p{arq=%Zu},%p,%Zd,%x&quot;
comma
id|call
comma
id|call-&gt;app_ready_qty
comma
id|buffer
comma
id|size
comma
id|flags
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|call-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
op_logical_neg
op_logical_neg
id|call-&gt;app_read_buf
)paren
)paren
(brace
id|spin_unlock
c_func
(paren
op_amp
id|call-&gt;lock
)paren
suffix:semicolon
id|_leave
c_func
(paren
l_string|&quot; = -EBUSY&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|call-&gt;app_mark
op_assign
id|size
suffix:semicolon
id|call-&gt;app_read_buf
op_assign
id|buffer
suffix:semicolon
id|call-&gt;app_async_read
op_assign
l_int|1
suffix:semicolon
id|call-&gt;app_read_count
op_increment
suffix:semicolon
multiline_comment|/* read as much data as possible */
id|ret
op_assign
id|__rxrpc_call_read_data
c_func
(paren
id|call
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|ret
)paren
(brace
r_case
l_int|0
suffix:colon
r_if
c_cond
(paren
id|flags
op_amp
id|RXRPC_CALL_READ_ALL
op_logical_and
(paren
op_logical_neg
id|call-&gt;app_last_rcv
op_logical_or
id|call-&gt;app_ready_qty
OG
l_int|0
)paren
)paren
(brace
id|_leave
c_func
(paren
l_string|&quot; = -EBADMSG&quot;
)paren
suffix:semicolon
id|__rxrpc_call_abort
c_func
(paren
id|call
comma
op_minus
id|EBADMSG
)paren
suffix:semicolon
r_return
op_minus
id|EBADMSG
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|call-&gt;lock
)paren
suffix:semicolon
id|call
op_member_access_from_pointer
id|app_attn_func
c_func
(paren
id|call
)paren
suffix:semicolon
id|_leave
c_func
(paren
l_string|&quot; = 0&quot;
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
r_case
op_minus
id|ECONNABORTED
suffix:colon
id|spin_unlock
c_func
(paren
op_amp
id|call-&gt;lock
)paren
suffix:semicolon
id|_leave
c_func
(paren
l_string|&quot; = %d [aborted]&quot;
comma
id|ret
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
r_default
suffix:colon
id|__rxrpc_call_abort
c_func
(paren
id|call
comma
id|ret
)paren
suffix:semicolon
id|_leave
c_func
(paren
l_string|&quot; = %d&quot;
comma
id|ret
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
r_case
op_minus
id|EAGAIN
suffix:colon
id|spin_unlock
c_func
(paren
op_amp
id|call-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|flags
op_amp
id|RXRPC_CALL_READ_BLOCK
)paren
)paren
(brace
id|_leave
c_func
(paren
l_string|&quot; = -EAGAIN&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
multiline_comment|/* wait for the data to arrive */
id|_debug
c_func
(paren
l_string|&quot;blocking for data arrival&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|call-&gt;app_async_read
op_logical_or
id|signal_pending
c_func
(paren
id|current
)paren
)paren
r_break
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
)brace
id|set_current_state
c_func
(paren
id|TASK_RUNNING
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
id|_leave
c_func
(paren
l_string|&quot; = -EINTR&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINTR
suffix:semicolon
)brace
r_if
c_cond
(paren
id|call-&gt;app_call_state
op_eq
id|RXRPC_CSTATE_ERROR
)paren
(brace
id|_leave
c_func
(paren
l_string|&quot; = -ECONNABORTED&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ECONNABORTED
suffix:semicolon
)brace
id|_leave
c_func
(paren
l_string|&quot; = 0&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/* end rxrpc_call_read_data() */
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * write data to a call&n; * - the data may not be sent immediately if it doesn&squot;t fill a buffer&n; * - if we can&squot;t queue all the data for buffering now, siov[] will have been&n; *   adjusted to take account of what has been sent&n; */
DECL|function|rxrpc_call_write_data
r_int
id|rxrpc_call_write_data
c_func
(paren
r_struct
id|rxrpc_call
op_star
id|call
comma
r_int
id|sioc
comma
r_struct
id|kvec
op_star
id|siov
comma
id|u8
id|rxhdr_flags
comma
r_int
id|alloc_flags
comma
r_int
id|dup_data
comma
r_int
op_star
id|size_sent
)paren
(brace
r_struct
id|rxrpc_message
op_star
id|msg
suffix:semicolon
r_struct
id|kvec
op_star
id|sptr
suffix:semicolon
r_int
id|space
comma
id|size
comma
id|chunk
comma
id|tmp
suffix:semicolon
r_char
op_star
id|buf
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|_enter
c_func
(paren
l_string|&quot;%p,%Zu,%p,%02x,%x,%d,%p&quot;
comma
id|call
comma
id|sioc
comma
id|siov
comma
id|rxhdr_flags
comma
id|alloc_flags
comma
id|dup_data
comma
id|size_sent
)paren
suffix:semicolon
op_star
id|size_sent
op_assign
l_int|0
suffix:semicolon
id|size
op_assign
l_int|0
suffix:semicolon
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* can&squot;t send more if we&squot;ve sent last packet from this end */
r_switch
c_cond
(paren
id|call-&gt;app_call_state
)paren
(brace
r_case
id|RXRPC_CSTATE_SRVR_SND_REPLY
suffix:colon
r_case
id|RXRPC_CSTATE_CLNT_SND_ARGS
suffix:colon
r_break
suffix:semicolon
r_case
id|RXRPC_CSTATE_ERROR
suffix:colon
id|ret
op_assign
id|call-&gt;app_errno
suffix:semicolon
r_default
suffix:colon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* calculate how much data we&squot;ve been given */
id|sptr
op_assign
id|siov
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|sioc
OG
l_int|0
suffix:semicolon
id|sptr
op_increment
comma
id|sioc
op_decrement
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|sptr-&gt;iov_len
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sptr-&gt;iov_base
)paren
r_goto
id|out
suffix:semicolon
id|size
op_add_assign
id|sptr-&gt;iov_len
suffix:semicolon
)brace
id|_debug
c_func
(paren
l_string|&quot;- size=%Zu mtu=%Zu&quot;
comma
id|size
comma
id|call-&gt;conn-&gt;mtu_size
)paren
suffix:semicolon
r_do
(brace
multiline_comment|/* make sure there&squot;s a message under construction */
r_if
c_cond
(paren
op_logical_neg
id|call-&gt;snd_nextmsg
)paren
(brace
multiline_comment|/* no - allocate a message with no data yet attached */
id|ret
op_assign
id|rxrpc_conn_newmsg
c_func
(paren
id|call-&gt;conn
comma
id|call
comma
id|RXRPC_PACKET_TYPE_DATA
comma
l_int|0
comma
l_int|NULL
comma
id|alloc_flags
comma
op_amp
id|call-&gt;snd_nextmsg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
r_goto
id|out
suffix:semicolon
id|_debug
c_func
(paren
l_string|&quot;- allocated new message [ds=%Zu]&quot;
comma
id|call-&gt;snd_nextmsg-&gt;dsize
)paren
suffix:semicolon
)brace
id|msg
op_assign
id|call-&gt;snd_nextmsg
suffix:semicolon
id|msg-&gt;hdr.flags
op_or_assign
id|rxhdr_flags
suffix:semicolon
multiline_comment|/* deal with zero-length terminal packet */
r_if
c_cond
(paren
id|size
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|rxhdr_flags
op_amp
id|RXRPC_LAST_PACKET
)paren
(brace
id|ret
op_assign
id|rxrpc_call_flush
c_func
(paren
id|call
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
r_goto
id|out
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
multiline_comment|/* work out how much space current packet has available */
id|space
op_assign
id|call-&gt;conn-&gt;mtu_size
op_minus
id|msg-&gt;dsize
suffix:semicolon
id|chunk
op_assign
id|min
c_func
(paren
id|space
comma
id|size
)paren
suffix:semicolon
id|_debug
c_func
(paren
l_string|&quot;- [before] space=%Zu chunk=%Zu&quot;
comma
id|space
comma
id|chunk
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|siov-&gt;iov_len
)paren
id|siov
op_increment
suffix:semicolon
multiline_comment|/* if we are going to have to duplicate the data then coalesce&n;&t;&t; * it too */
r_if
c_cond
(paren
id|dup_data
)paren
(brace
multiline_comment|/* don&squot;t allocate more that 1 page at a time */
r_if
c_cond
(paren
id|chunk
OG
id|PAGE_SIZE
)paren
id|chunk
op_assign
id|PAGE_SIZE
suffix:semicolon
multiline_comment|/* allocate a data buffer and attach to the message */
id|buf
op_assign
id|kmalloc
c_func
(paren
id|chunk
comma
id|alloc_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
op_logical_neg
id|buf
)paren
)paren
(brace
r_if
c_cond
(paren
id|msg-&gt;dsize
op_eq
r_sizeof
(paren
r_struct
id|rxrpc_header
)paren
)paren
(brace
multiline_comment|/* discard an empty msg and wind back&n;&t;&t;&t;&t;&t; * the seq counter */
id|rxrpc_put_message
c_func
(paren
id|msg
)paren
suffix:semicolon
id|call-&gt;snd_nextmsg
op_assign
l_int|NULL
suffix:semicolon
id|call-&gt;snd_seq_count
op_decrement
suffix:semicolon
)brace
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|tmp
op_assign
id|msg-&gt;dcount
op_increment
suffix:semicolon
id|set_bit
c_func
(paren
id|tmp
comma
op_amp
id|msg-&gt;dfree
)paren
suffix:semicolon
id|msg-&gt;data
(braket
id|tmp
)braket
dot
id|iov_base
op_assign
id|buf
suffix:semicolon
id|msg-&gt;data
(braket
id|tmp
)braket
dot
id|iov_len
op_assign
id|chunk
suffix:semicolon
id|msg-&gt;dsize
op_add_assign
id|chunk
suffix:semicolon
op_star
id|size_sent
op_add_assign
id|chunk
suffix:semicolon
id|size
op_sub_assign
id|chunk
suffix:semicolon
multiline_comment|/* load the buffer with data */
r_while
c_loop
(paren
id|chunk
OG
l_int|0
)paren
(brace
id|tmp
op_assign
id|min
c_func
(paren
id|chunk
comma
id|siov-&gt;iov_len
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|buf
comma
id|siov-&gt;iov_base
comma
id|tmp
)paren
suffix:semicolon
id|buf
op_add_assign
id|tmp
suffix:semicolon
id|siov-&gt;iov_base
op_add_assign
id|tmp
suffix:semicolon
id|siov-&gt;iov_len
op_sub_assign
id|tmp
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|siov-&gt;iov_len
)paren
id|siov
op_increment
suffix:semicolon
id|chunk
op_sub_assign
id|tmp
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* we want to attach the supplied buffers directly */
r_while
c_loop
(paren
id|chunk
OG
l_int|0
op_logical_and
id|msg-&gt;dcount
OL
id|RXRPC_MSG_MAX_IOCS
)paren
(brace
id|tmp
op_assign
id|msg-&gt;dcount
op_increment
suffix:semicolon
id|msg-&gt;data
(braket
id|tmp
)braket
dot
id|iov_base
op_assign
id|siov-&gt;iov_base
suffix:semicolon
id|msg-&gt;data
(braket
id|tmp
)braket
dot
id|iov_len
op_assign
id|siov-&gt;iov_len
suffix:semicolon
id|msg-&gt;dsize
op_add_assign
id|siov-&gt;iov_len
suffix:semicolon
op_star
id|size_sent
op_add_assign
id|siov-&gt;iov_len
suffix:semicolon
id|size
op_sub_assign
id|siov-&gt;iov_len
suffix:semicolon
id|chunk
op_sub_assign
id|siov-&gt;iov_len
suffix:semicolon
id|siov
op_increment
suffix:semicolon
)brace
)brace
id|_debug
c_func
(paren
l_string|&quot;- [loaded] chunk=%Zu size=%Zu&quot;
comma
id|chunk
comma
id|size
)paren
suffix:semicolon
multiline_comment|/* dispatch the message when full, final or requesting ACK */
r_if
c_cond
(paren
id|msg-&gt;dsize
op_ge
id|call-&gt;conn-&gt;mtu_size
op_logical_or
id|rxhdr_flags
)paren
(brace
id|ret
op_assign
id|rxrpc_call_flush
c_func
(paren
id|call
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
r_goto
id|out
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|size
OG
l_int|0
)paren
(brace
suffix:semicolon
)brace
id|ret
op_assign
l_int|0
suffix:semicolon
id|out
suffix:colon
id|_leave
c_func
(paren
l_string|&quot; = %d (%Zd queued, %Zd rem)&quot;
comma
id|ret
comma
op_star
id|size_sent
comma
id|size
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* end rxrpc_call_write_data() */
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * flush outstanding packets to the network&n; */
DECL|function|rxrpc_call_flush
r_static
r_int
id|rxrpc_call_flush
c_func
(paren
r_struct
id|rxrpc_call
op_star
id|call
)paren
(brace
r_struct
id|rxrpc_message
op_star
id|msg
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
id|_enter
c_func
(paren
l_string|&quot;%p&quot;
comma
id|call
)paren
suffix:semicolon
id|rxrpc_get_call
c_func
(paren
id|call
)paren
suffix:semicolon
multiline_comment|/* if there&squot;s a packet under construction, then dispatch it now */
r_if
c_cond
(paren
id|call-&gt;snd_nextmsg
)paren
(brace
id|msg
op_assign
id|call-&gt;snd_nextmsg
suffix:semicolon
id|call-&gt;snd_nextmsg
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|msg-&gt;hdr.flags
op_amp
id|RXRPC_LAST_PACKET
)paren
(brace
id|msg-&gt;hdr.flags
op_and_assign
op_complement
id|RXRPC_MORE_PACKETS
suffix:semicolon
r_if
c_cond
(paren
id|call-&gt;app_call_state
op_ne
id|RXRPC_CSTATE_CLNT_SND_ARGS
)paren
id|msg-&gt;hdr.flags
op_or_assign
id|RXRPC_REQUEST_ACK
suffix:semicolon
)brace
r_else
(brace
id|msg-&gt;hdr.flags
op_or_assign
id|RXRPC_MORE_PACKETS
suffix:semicolon
)brace
id|_proto
c_func
(paren
l_string|&quot;Sending DATA message { ds=%Zu dc=%u df=%02lu }&quot;
comma
id|msg-&gt;dsize
comma
id|msg-&gt;dcount
comma
id|msg-&gt;dfree
)paren
suffix:semicolon
multiline_comment|/* queue and adjust call state */
id|spin_lock
c_func
(paren
op_amp
id|call-&gt;lock
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|msg-&gt;link
comma
op_amp
id|call-&gt;acks_pendq
)paren
suffix:semicolon
multiline_comment|/* decide what to do depending on current state and if this is&n;&t;&t; * the last packet */
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_switch
c_cond
(paren
id|call-&gt;app_call_state
)paren
(brace
r_case
id|RXRPC_CSTATE_SRVR_SND_REPLY
suffix:colon
r_if
c_cond
(paren
id|msg-&gt;hdr.flags
op_amp
id|RXRPC_LAST_PACKET
)paren
(brace
id|call-&gt;app_call_state
op_assign
id|RXRPC_CSTATE_SRVR_RCV_FINAL_ACK
suffix:semicolon
id|_state
c_func
(paren
id|call
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|RXRPC_CSTATE_CLNT_SND_ARGS
suffix:colon
r_if
c_cond
(paren
id|msg-&gt;hdr.flags
op_amp
id|RXRPC_LAST_PACKET
)paren
(brace
id|call-&gt;app_call_state
op_assign
id|RXRPC_CSTATE_CLNT_RCV_REPLY
suffix:semicolon
id|_state
c_func
(paren
id|call
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|RXRPC_CSTATE_ERROR
suffix:colon
id|ret
op_assign
id|call-&gt;app_errno
suffix:semicolon
r_default
suffix:colon
id|spin_unlock
c_func
(paren
op_amp
id|call-&gt;lock
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|call-&gt;acks_pend_cnt
op_increment
suffix:semicolon
id|mod_timer
c_func
(paren
op_amp
id|call-&gt;acks_timeout
comma
id|__rxrpc_rtt_based_timeout
c_func
(paren
id|call
comma
id|rxrpc_call_acks_timeout
)paren
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|call-&gt;lock
)paren
suffix:semicolon
id|ret
op_assign
id|rxrpc_conn_sendmsg
c_func
(paren
id|call-&gt;conn
comma
id|msg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
l_int|0
)paren
id|call-&gt;pkt_snd_count
op_increment
suffix:semicolon
)brace
id|out
suffix:colon
id|rxrpc_put_call
c_func
(paren
id|call
)paren
suffix:semicolon
id|_leave
c_func
(paren
l_string|&quot; = %d&quot;
comma
id|ret
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* end rxrpc_call_flush() */
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * resend NAK&squot;d or unacknowledged packets up to the highest one specified&n; */
DECL|function|rxrpc_call_resend
r_static
r_void
id|rxrpc_call_resend
c_func
(paren
r_struct
id|rxrpc_call
op_star
id|call
comma
id|rxrpc_seq_t
id|highest
)paren
(brace
r_struct
id|rxrpc_message
op_star
id|msg
suffix:semicolon
r_struct
id|list_head
op_star
id|_p
suffix:semicolon
id|rxrpc_seq_t
id|seq
op_assign
l_int|0
suffix:semicolon
id|_enter
c_func
(paren
l_string|&quot;%p,%u&quot;
comma
id|call
comma
id|highest
)paren
suffix:semicolon
id|_proto
c_func
(paren
l_string|&quot;Rx Resend required&quot;
)paren
suffix:semicolon
multiline_comment|/* handle too many resends */
r_if
c_cond
(paren
id|call-&gt;snd_resend_cnt
op_ge
id|rxrpc_call_max_resend
)paren
(brace
id|_debug
c_func
(paren
l_string|&quot;Aborting due to too many resends (rcv=%d)&quot;
comma
id|call-&gt;pkt_rcv_count
)paren
suffix:semicolon
id|rxrpc_call_abort
c_func
(paren
id|call
comma
id|call-&gt;pkt_rcv_count
OG
l_int|0
ques
c_cond
op_minus
id|EIO
suffix:colon
op_minus
id|ETIMEDOUT
)paren
suffix:semicolon
id|_leave
c_func
(paren
l_string|&quot;&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|spin_lock
c_func
(paren
op_amp
id|call-&gt;lock
)paren
suffix:semicolon
id|call-&gt;snd_resend_cnt
op_increment
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
multiline_comment|/* determine which the next packet we might need to ACK is */
r_if
c_cond
(paren
id|seq
op_le
id|call-&gt;acks_dftv_seq
)paren
id|seq
op_assign
id|call-&gt;acks_dftv_seq
suffix:semicolon
id|seq
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|seq
OG
id|highest
)paren
r_break
suffix:semicolon
multiline_comment|/* look for the packet in the pending-ACK queue */
id|list_for_each
c_func
(paren
id|_p
comma
op_amp
id|call-&gt;acks_pendq
)paren
(brace
id|msg
op_assign
id|list_entry
c_func
(paren
id|_p
comma
r_struct
id|rxrpc_message
comma
id|link
)paren
suffix:semicolon
r_if
c_cond
(paren
id|msg-&gt;seq
op_eq
id|seq
)paren
r_goto
id|found_msg
suffix:semicolon
)brace
id|panic
c_func
(paren
l_string|&quot;%s(%p,%d):&quot;
l_string|&quot; Inconsistent pending-ACK queue (ds=%u sc=%u sq=%u)&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|call
comma
id|highest
comma
id|call-&gt;acks_dftv_seq
comma
id|call-&gt;snd_seq_count
comma
id|seq
)paren
suffix:semicolon
id|found_msg
suffix:colon
r_if
c_cond
(paren
id|msg-&gt;state
op_ne
id|RXRPC_MSG_SENT
)paren
r_continue
suffix:semicolon
multiline_comment|/* only un-ACK&squot;d packets */
id|rxrpc_get_message
c_func
(paren
id|msg
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|call-&gt;lock
)paren
suffix:semicolon
multiline_comment|/* send each message again (and ignore any errors we might&n;&t;&t; * incur) */
id|_proto
c_func
(paren
l_string|&quot;Resending DATA message { ds=%Zu dc=%u df=%02lu }&quot;
comma
id|msg-&gt;dsize
comma
id|msg-&gt;dcount
comma
id|msg-&gt;dfree
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rxrpc_conn_sendmsg
c_func
(paren
id|call-&gt;conn
comma
id|msg
)paren
op_eq
l_int|0
)paren
id|call-&gt;pkt_snd_count
op_increment
suffix:semicolon
id|rxrpc_put_message
c_func
(paren
id|msg
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|call-&gt;lock
)paren
suffix:semicolon
)brace
multiline_comment|/* reset the timeout */
id|mod_timer
c_func
(paren
op_amp
id|call-&gt;acks_timeout
comma
id|__rxrpc_rtt_based_timeout
c_func
(paren
id|call
comma
id|rxrpc_call_acks_timeout
)paren
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|call-&gt;lock
)paren
suffix:semicolon
id|_leave
c_func
(paren
l_string|&quot;&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* end rxrpc_call_resend() */
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * handle an ICMP error being applied to a call&n; */
DECL|function|rxrpc_call_handle_error
r_void
id|rxrpc_call_handle_error
c_func
(paren
r_struct
id|rxrpc_call
op_star
id|call
comma
r_int
id|local
comma
r_int
id|errno
)paren
(brace
id|_enter
c_func
(paren
l_string|&quot;%p{%u},%d&quot;
comma
id|call
comma
id|ntohl
c_func
(paren
id|call-&gt;call_id
)paren
comma
id|errno
)paren
suffix:semicolon
multiline_comment|/* if this call is already aborted, then just wake up any waiters */
r_if
c_cond
(paren
id|call-&gt;app_call_state
op_eq
id|RXRPC_CSTATE_ERROR
)paren
(brace
id|call
op_member_access_from_pointer
id|app_error_func
c_func
(paren
id|call
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* tell the app layer what happened */
id|spin_lock
c_func
(paren
op_amp
id|call-&gt;lock
)paren
suffix:semicolon
id|call-&gt;app_call_state
op_assign
id|RXRPC_CSTATE_ERROR
suffix:semicolon
id|_state
c_func
(paren
id|call
)paren
suffix:semicolon
r_if
c_cond
(paren
id|local
)paren
id|call-&gt;app_err_state
op_assign
id|RXRPC_ESTATE_LOCAL_ERROR
suffix:semicolon
r_else
id|call-&gt;app_err_state
op_assign
id|RXRPC_ESTATE_REMOTE_ERROR
suffix:semicolon
id|call-&gt;app_errno
op_assign
id|errno
suffix:semicolon
id|call-&gt;app_mark
op_assign
id|RXRPC_APP_MARK_EOF
suffix:semicolon
id|call-&gt;app_read_buf
op_assign
l_int|NULL
suffix:semicolon
id|call-&gt;app_async_read
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* map the error */
id|call
op_member_access_from_pointer
id|app_aemap_func
c_func
(paren
id|call
)paren
suffix:semicolon
id|del_timer_sync
c_func
(paren
op_amp
id|call-&gt;acks_timeout
)paren
suffix:semicolon
id|del_timer_sync
c_func
(paren
op_amp
id|call-&gt;rcv_timeout
)paren
suffix:semicolon
id|del_timer_sync
c_func
(paren
op_amp
id|call-&gt;ackr_dfr_timo
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|call-&gt;lock
)paren
suffix:semicolon
id|call
op_member_access_from_pointer
id|app_error_func
c_func
(paren
id|call
)paren
suffix:semicolon
)brace
id|_leave
c_func
(paren
l_string|&quot;&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* end rxrpc_call_handle_error() */
eof
