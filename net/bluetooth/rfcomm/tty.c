multiline_comment|/* &n;   RFCOMM implementation for Linux Bluetooth stack (BlueZ).&n;   Copyright (C) 2002 Maxim Krasnyansky &lt;maxk@qualcomm.com&gt;&n;   Copyright (C) 2002 Marcel Holtmann &lt;marcel@holtmann.org&gt;&n;&n;   This program is free software; you can redistribute it and/or modify&n;   it under the terms of the GNU General Public License version 2 as&n;   published by the Free Software Foundation;&n;&n;   THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS&n;   OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,&n;   FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT OF THIRD PARTY RIGHTS.&n;   IN NO EVENT SHALL THE COPYRIGHT HOLDER(S) AND AUTHOR(S) BE LIABLE FOR ANY&n;   CLAIM, OR ANY SPECIAL INDIRECT OR CONSEQUENTIAL DAMAGES, OR ANY DAMAGES &n;   WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN &n;   ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF &n;   OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.&n;&n;   ALL LIABILITY, INCLUDING LIABILITY FOR INFRINGEMENT OF ANY PATENTS, &n;   COPYRIGHTS, TRADEMARKS OR OTHER RIGHTS, RELATING TO USE OF THIS &n;   SOFTWARE IS DISCLAIMED.&n;*/
multiline_comment|/*&n; * RFCOMM TTY.&n; *&n; * $Id: tty.c,v 1.24 2002/10/03 01:54:38 holtmann Exp $&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/tty_driver.h&gt;
macro_line|#include &lt;linux/tty_flip.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;net/bluetooth/bluetooth.h&gt;
macro_line|#include &lt;net/bluetooth/rfcomm.h&gt;
macro_line|#ifndef CONFIG_BT_RFCOMM_DEBUG
DECL|macro|BT_DBG
macro_line|#undef  BT_DBG
DECL|macro|BT_DBG
mdefine_line|#define BT_DBG(D...)
macro_line|#endif
DECL|macro|RFCOMM_TTY_MAGIC
mdefine_line|#define RFCOMM_TTY_MAGIC 0x6d02&t;&t;/* magic number for rfcomm struct */
DECL|macro|RFCOMM_TTY_PORTS
mdefine_line|#define RFCOMM_TTY_PORTS RFCOMM_MAX_DEV&t;/* whole lotta rfcomm devices */
DECL|macro|RFCOMM_TTY_MAJOR
mdefine_line|#define RFCOMM_TTY_MAJOR 216&t;&t;/* device node major id of the usb/bluetooth.c driver */
DECL|macro|RFCOMM_TTY_MINOR
mdefine_line|#define RFCOMM_TTY_MINOR 0
DECL|variable|rfcomm_tty_driver
r_static
r_struct
id|tty_driver
op_star
id|rfcomm_tty_driver
suffix:semicolon
DECL|struct|rfcomm_dev
r_struct
id|rfcomm_dev
(brace
DECL|member|list
r_struct
id|list_head
id|list
suffix:semicolon
DECL|member|refcnt
id|atomic_t
id|refcnt
suffix:semicolon
DECL|member|name
r_char
id|name
(braket
l_int|12
)braket
suffix:semicolon
DECL|member|id
r_int
id|id
suffix:semicolon
DECL|member|flags
r_int
r_int
id|flags
suffix:semicolon
DECL|member|opened
r_int
id|opened
suffix:semicolon
DECL|member|err
r_int
id|err
suffix:semicolon
DECL|member|src
id|bdaddr_t
id|src
suffix:semicolon
DECL|member|dst
id|bdaddr_t
id|dst
suffix:semicolon
DECL|member|channel
id|u8
id|channel
suffix:semicolon
DECL|member|modem_status
id|uint
id|modem_status
suffix:semicolon
DECL|member|dlc
r_struct
id|rfcomm_dlc
op_star
id|dlc
suffix:semicolon
DECL|member|tty
r_struct
id|tty_struct
op_star
id|tty
suffix:semicolon
DECL|member|wait
id|wait_queue_head_t
id|wait
suffix:semicolon
DECL|member|wakeup_task
r_struct
id|tasklet_struct
id|wakeup_task
suffix:semicolon
DECL|member|wmem_alloc
id|atomic_t
id|wmem_alloc
suffix:semicolon
)brace
suffix:semicolon
r_static
id|LIST_HEAD
c_func
(paren
id|rfcomm_dev_list
)paren
suffix:semicolon
r_static
id|DEFINE_RWLOCK
c_func
(paren
id|rfcomm_dev_lock
)paren
suffix:semicolon
r_static
r_void
id|rfcomm_dev_data_ready
c_func
(paren
r_struct
id|rfcomm_dlc
op_star
id|dlc
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
suffix:semicolon
r_static
r_void
id|rfcomm_dev_state_change
c_func
(paren
r_struct
id|rfcomm_dlc
op_star
id|dlc
comma
r_int
id|err
)paren
suffix:semicolon
r_static
r_void
id|rfcomm_dev_modem_status
c_func
(paren
r_struct
id|rfcomm_dlc
op_star
id|dlc
comma
id|u8
id|v24_sig
)paren
suffix:semicolon
r_static
r_void
id|rfcomm_tty_wakeup
c_func
(paren
r_int
r_int
id|arg
)paren
suffix:semicolon
multiline_comment|/* ---- Device functions ---- */
DECL|function|rfcomm_dev_destruct
r_static
r_void
id|rfcomm_dev_destruct
c_func
(paren
r_struct
id|rfcomm_dev
op_star
id|dev
)paren
(brace
r_struct
id|rfcomm_dlc
op_star
id|dlc
op_assign
id|dev-&gt;dlc
suffix:semicolon
id|BT_DBG
c_func
(paren
l_string|&quot;dev %p dlc %p&quot;
comma
id|dev
comma
id|dlc
)paren
suffix:semicolon
id|rfcomm_dlc_lock
c_func
(paren
id|dlc
)paren
suffix:semicolon
multiline_comment|/* Detach DLC if it&squot;s owned by this dev */
r_if
c_cond
(paren
id|dlc-&gt;owner
op_eq
id|dev
)paren
id|dlc-&gt;owner
op_assign
l_int|NULL
suffix:semicolon
id|rfcomm_dlc_unlock
c_func
(paren
id|dlc
)paren
suffix:semicolon
id|rfcomm_dlc_put
c_func
(paren
id|dlc
)paren
suffix:semicolon
id|tty_unregister_device
c_func
(paren
id|rfcomm_tty_driver
comma
id|dev-&gt;id
)paren
suffix:semicolon
multiline_comment|/* Refcount should only hit zero when called from rfcomm_dev_del()&n;&t;   which will have taken us off the list. Everything else are&n;&t;   refcounting bugs. */
id|BUG_ON
c_func
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|dev-&gt;list
)paren
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* It&squot;s safe to call module_put() here because socket still &n;&t;   holds reference to this module. */
id|module_put
c_func
(paren
id|THIS_MODULE
)paren
suffix:semicolon
)brace
DECL|function|rfcomm_dev_hold
r_static
r_inline
r_void
id|rfcomm_dev_hold
c_func
(paren
r_struct
id|rfcomm_dev
op_star
id|dev
)paren
(brace
id|atomic_inc
c_func
(paren
op_amp
id|dev-&gt;refcnt
)paren
suffix:semicolon
)brace
DECL|function|rfcomm_dev_put
r_static
r_inline
r_void
id|rfcomm_dev_put
c_func
(paren
r_struct
id|rfcomm_dev
op_star
id|dev
)paren
(brace
multiline_comment|/* The reason this isn&squot;t actually a race, as you no&n;&t;   doubt have a little voice screaming at you in your&n;&t;   head, is that the refcount should never actually&n;&t;   reach zero unless the device has already been taken&n;&t;   off the list, in rfcomm_dev_del(). And if that&squot;s not&n;&t;   true, we&squot;ll hit the BUG() in rfcomm_dev_destruct()&n;&t;   anyway. */
r_if
c_cond
(paren
id|atomic_dec_and_test
c_func
(paren
op_amp
id|dev-&gt;refcnt
)paren
)paren
id|rfcomm_dev_destruct
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
DECL|function|__rfcomm_dev_get
r_static
r_struct
id|rfcomm_dev
op_star
id|__rfcomm_dev_get
c_func
(paren
r_int
id|id
)paren
(brace
r_struct
id|rfcomm_dev
op_star
id|dev
suffix:semicolon
r_struct
id|list_head
op_star
id|p
suffix:semicolon
id|list_for_each
c_func
(paren
id|p
comma
op_amp
id|rfcomm_dev_list
)paren
(brace
id|dev
op_assign
id|list_entry
c_func
(paren
id|p
comma
r_struct
id|rfcomm_dev
comma
id|list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;id
op_eq
id|id
)paren
r_return
id|dev
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|rfcomm_dev_get
r_static
r_inline
r_struct
id|rfcomm_dev
op_star
id|rfcomm_dev_get
c_func
(paren
r_int
id|id
)paren
(brace
r_struct
id|rfcomm_dev
op_star
id|dev
suffix:semicolon
id|read_lock
c_func
(paren
op_amp
id|rfcomm_dev_lock
)paren
suffix:semicolon
id|dev
op_assign
id|__rfcomm_dev_get
c_func
(paren
id|id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev
)paren
id|rfcomm_dev_hold
c_func
(paren
id|dev
)paren
suffix:semicolon
id|read_unlock
c_func
(paren
op_amp
id|rfcomm_dev_lock
)paren
suffix:semicolon
r_return
id|dev
suffix:semicolon
)brace
DECL|function|rfcomm_dev_add
r_static
r_int
id|rfcomm_dev_add
c_func
(paren
r_struct
id|rfcomm_dev_req
op_star
id|req
comma
r_struct
id|rfcomm_dlc
op_star
id|dlc
)paren
(brace
r_struct
id|rfcomm_dev
op_star
id|dev
suffix:semicolon
r_struct
id|list_head
op_star
id|head
op_assign
op_amp
id|rfcomm_dev_list
comma
op_star
id|p
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
id|BT_DBG
c_func
(paren
l_string|&quot;id %d channel %d&quot;
comma
id|req-&gt;dev_id
comma
id|req-&gt;channel
)paren
suffix:semicolon
id|dev
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|rfcomm_dev
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|dev
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|rfcomm_dev
)paren
)paren
suffix:semicolon
id|write_lock_bh
c_func
(paren
op_amp
id|rfcomm_dev_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|req-&gt;dev_id
OL
l_int|0
)paren
(brace
id|dev-&gt;id
op_assign
l_int|0
suffix:semicolon
id|list_for_each
c_func
(paren
id|p
comma
op_amp
id|rfcomm_dev_list
)paren
(brace
r_if
c_cond
(paren
id|list_entry
c_func
(paren
id|p
comma
r_struct
id|rfcomm_dev
comma
id|list
)paren
op_member_access_from_pointer
id|id
op_ne
id|dev-&gt;id
)paren
r_break
suffix:semicolon
id|dev-&gt;id
op_increment
suffix:semicolon
id|head
op_assign
id|p
suffix:semicolon
)brace
)brace
r_else
(brace
id|dev-&gt;id
op_assign
id|req-&gt;dev_id
suffix:semicolon
id|list_for_each
c_func
(paren
id|p
comma
op_amp
id|rfcomm_dev_list
)paren
(brace
r_struct
id|rfcomm_dev
op_star
id|entry
op_assign
id|list_entry
c_func
(paren
id|p
comma
r_struct
id|rfcomm_dev
comma
id|list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|entry-&gt;id
op_eq
id|dev-&gt;id
)paren
(brace
id|err
op_assign
op_minus
id|EADDRINUSE
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|entry-&gt;id
OG
id|dev-&gt;id
op_minus
l_int|1
)paren
r_break
suffix:semicolon
id|head
op_assign
id|p
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
(paren
id|dev-&gt;id
OL
l_int|0
)paren
op_logical_or
(paren
id|dev-&gt;id
OG
id|RFCOMM_MAX_DEV
op_minus
l_int|1
)paren
)paren
(brace
id|err
op_assign
op_minus
id|ENFILE
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|sprintf
c_func
(paren
id|dev-&gt;name
comma
l_string|&quot;rfcomm%d&quot;
comma
id|dev-&gt;id
)paren
suffix:semicolon
id|list_add
c_func
(paren
op_amp
id|dev-&gt;list
comma
id|head
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|dev-&gt;refcnt
comma
l_int|1
)paren
suffix:semicolon
id|bacpy
c_func
(paren
op_amp
id|dev-&gt;src
comma
op_amp
id|req-&gt;src
)paren
suffix:semicolon
id|bacpy
c_func
(paren
op_amp
id|dev-&gt;dst
comma
op_amp
id|req-&gt;dst
)paren
suffix:semicolon
id|dev-&gt;channel
op_assign
id|req-&gt;channel
suffix:semicolon
id|dev-&gt;flags
op_assign
id|req-&gt;flags
op_amp
(paren
(paren
l_int|1
op_lshift
id|RFCOMM_RELEASE_ONHUP
)paren
op_or
(paren
l_int|1
op_lshift
id|RFCOMM_REUSE_DLC
)paren
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|dev-&gt;wait
)paren
suffix:semicolon
id|tasklet_init
c_func
(paren
op_amp
id|dev-&gt;wakeup_task
comma
id|rfcomm_tty_wakeup
comma
(paren
r_int
r_int
)paren
id|dev
)paren
suffix:semicolon
id|rfcomm_dlc_lock
c_func
(paren
id|dlc
)paren
suffix:semicolon
id|dlc-&gt;data_ready
op_assign
id|rfcomm_dev_data_ready
suffix:semicolon
id|dlc-&gt;state_change
op_assign
id|rfcomm_dev_state_change
suffix:semicolon
id|dlc-&gt;modem_status
op_assign
id|rfcomm_dev_modem_status
suffix:semicolon
id|dlc-&gt;owner
op_assign
id|dev
suffix:semicolon
id|dev-&gt;dlc
op_assign
id|dlc
suffix:semicolon
id|rfcomm_dlc_unlock
c_func
(paren
id|dlc
)paren
suffix:semicolon
multiline_comment|/* It&squot;s safe to call __module_get() here because socket already &n;&t;   holds reference to this module. */
id|__module_get
c_func
(paren
id|THIS_MODULE
)paren
suffix:semicolon
id|out
suffix:colon
id|write_unlock_bh
c_func
(paren
op_amp
id|rfcomm_dev_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|kfree
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|tty_register_device
c_func
(paren
id|rfcomm_tty_driver
comma
id|dev-&gt;id
comma
l_int|NULL
)paren
suffix:semicolon
r_return
id|dev-&gt;id
suffix:semicolon
)brace
DECL|function|rfcomm_dev_del
r_static
r_void
id|rfcomm_dev_del
c_func
(paren
r_struct
id|rfcomm_dev
op_star
id|dev
)paren
(brace
id|BT_DBG
c_func
(paren
l_string|&quot;dev %p&quot;
comma
id|dev
)paren
suffix:semicolon
id|write_lock_bh
c_func
(paren
op_amp
id|rfcomm_dev_lock
)paren
suffix:semicolon
id|list_del_init
c_func
(paren
op_amp
id|dev-&gt;list
)paren
suffix:semicolon
id|write_unlock_bh
c_func
(paren
op_amp
id|rfcomm_dev_lock
)paren
suffix:semicolon
id|rfcomm_dev_put
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
multiline_comment|/* ---- Send buffer ---- */
DECL|function|rfcomm_room
r_static
r_inline
r_int
r_int
id|rfcomm_room
c_func
(paren
r_struct
id|rfcomm_dlc
op_star
id|dlc
)paren
(brace
multiline_comment|/* We can&squot;t let it be zero, because we don&squot;t get a callback&n;&t;   when tx_credits becomes nonzero, hence we&squot;d never wake up */
r_return
id|dlc-&gt;mtu
op_star
(paren
id|dlc-&gt;tx_credits
ques
c_cond
suffix:colon
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|rfcomm_wfree
r_static
r_void
id|rfcomm_wfree
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|rfcomm_dev
op_star
id|dev
op_assign
(paren
r_void
op_star
)paren
id|skb-&gt;sk
suffix:semicolon
id|atomic_sub
c_func
(paren
id|skb-&gt;truesize
comma
op_amp
id|dev-&gt;wmem_alloc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|RFCOMM_TTY_ATTACHED
comma
op_amp
id|dev-&gt;flags
)paren
)paren
id|tasklet_schedule
c_func
(paren
op_amp
id|dev-&gt;wakeup_task
)paren
suffix:semicolon
id|rfcomm_dev_put
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
DECL|function|rfcomm_set_owner_w
r_static
r_inline
r_void
id|rfcomm_set_owner_w
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|rfcomm_dev
op_star
id|dev
)paren
(brace
id|rfcomm_dev_hold
c_func
(paren
id|dev
)paren
suffix:semicolon
id|atomic_add
c_func
(paren
id|skb-&gt;truesize
comma
op_amp
id|dev-&gt;wmem_alloc
)paren
suffix:semicolon
id|skb-&gt;sk
op_assign
(paren
r_void
op_star
)paren
id|dev
suffix:semicolon
id|skb-&gt;destructor
op_assign
id|rfcomm_wfree
suffix:semicolon
)brace
DECL|function|rfcomm_wmalloc
r_static
r_struct
id|sk_buff
op_star
id|rfcomm_wmalloc
c_func
(paren
r_struct
id|rfcomm_dev
op_star
id|dev
comma
r_int
r_int
id|size
comma
r_int
id|priority
)paren
(brace
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|dev-&gt;wmem_alloc
)paren
OL
id|rfcomm_room
c_func
(paren
id|dev-&gt;dlc
)paren
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
op_assign
id|alloc_skb
c_func
(paren
id|size
comma
id|priority
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
)paren
(brace
id|rfcomm_set_owner_w
c_func
(paren
id|skb
comma
id|dev
)paren
suffix:semicolon
r_return
id|skb
suffix:semicolon
)brace
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* ---- Device IOCTLs ---- */
DECL|macro|NOCAP_FLAGS
mdefine_line|#define NOCAP_FLAGS ((1 &lt;&lt; RFCOMM_REUSE_DLC) | (1 &lt;&lt; RFCOMM_RELEASE_ONHUP))
DECL|function|rfcomm_create_dev
r_static
r_int
id|rfcomm_create_dev
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_void
id|__user
op_star
id|arg
)paren
(brace
r_struct
id|rfcomm_dev_req
id|req
suffix:semicolon
r_struct
id|rfcomm_dlc
op_star
id|dlc
suffix:semicolon
r_int
id|id
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|req
comma
id|arg
comma
r_sizeof
(paren
id|req
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|BT_DBG
c_func
(paren
l_string|&quot;sk %p dev_id %id flags 0x%x&quot;
comma
id|sk
comma
id|req.dev_id
comma
id|req.flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|req.flags
op_ne
id|NOCAP_FLAGS
op_logical_and
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
r_if
c_cond
(paren
id|req.flags
op_amp
(paren
l_int|1
op_lshift
id|RFCOMM_REUSE_DLC
)paren
)paren
(brace
multiline_comment|/* Socket must be connected */
r_if
c_cond
(paren
id|sk-&gt;sk_state
op_ne
id|BT_CONNECTED
)paren
r_return
op_minus
id|EBADFD
suffix:semicolon
id|dlc
op_assign
id|rfcomm_pi
c_func
(paren
id|sk
)paren
op_member_access_from_pointer
id|dlc
suffix:semicolon
id|rfcomm_dlc_hold
c_func
(paren
id|dlc
)paren
suffix:semicolon
)brace
r_else
(brace
id|dlc
op_assign
id|rfcomm_dlc_alloc
c_func
(paren
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dlc
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|id
op_assign
id|rfcomm_dev_add
c_func
(paren
op_amp
id|req
comma
id|dlc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|id
OL
l_int|0
)paren
(brace
id|rfcomm_dlc_put
c_func
(paren
id|dlc
)paren
suffix:semicolon
r_return
id|id
suffix:semicolon
)brace
r_if
c_cond
(paren
id|req.flags
op_amp
(paren
l_int|1
op_lshift
id|RFCOMM_REUSE_DLC
)paren
)paren
(brace
multiline_comment|/* DLC is now used by device.&n;&t;&t; * Socket must be disconnected */
id|sk-&gt;sk_state
op_assign
id|BT_CLOSED
suffix:semicolon
)brace
r_return
id|id
suffix:semicolon
)brace
DECL|function|rfcomm_release_dev
r_static
r_int
id|rfcomm_release_dev
c_func
(paren
r_void
id|__user
op_star
id|arg
)paren
(brace
r_struct
id|rfcomm_dev_req
id|req
suffix:semicolon
r_struct
id|rfcomm_dev
op_star
id|dev
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|req
comma
id|arg
comma
r_sizeof
(paren
id|req
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|BT_DBG
c_func
(paren
l_string|&quot;dev_id %id flags 0x%x&quot;
comma
id|req.dev_id
comma
id|req.flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|dev
op_assign
id|rfcomm_dev_get
c_func
(paren
id|req.dev_id
)paren
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_ne
id|NOCAP_FLAGS
op_logical_and
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
(brace
id|rfcomm_dev_put
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
op_minus
id|EPERM
suffix:semicolon
)brace
r_if
c_cond
(paren
id|req.flags
op_amp
(paren
l_int|1
op_lshift
id|RFCOMM_HANGUP_NOW
)paren
)paren
id|rfcomm_dlc_close
c_func
(paren
id|dev-&gt;dlc
comma
l_int|0
)paren
suffix:semicolon
id|rfcomm_dev_del
c_func
(paren
id|dev
)paren
suffix:semicolon
id|rfcomm_dev_put
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|rfcomm_get_dev_list
r_static
r_int
id|rfcomm_get_dev_list
c_func
(paren
r_void
id|__user
op_star
id|arg
)paren
(brace
r_struct
id|rfcomm_dev_list_req
op_star
id|dl
suffix:semicolon
r_struct
id|rfcomm_dev_info
op_star
id|di
suffix:semicolon
r_struct
id|list_head
op_star
id|p
suffix:semicolon
r_int
id|n
op_assign
l_int|0
comma
id|size
comma
id|err
suffix:semicolon
id|u16
id|dev_num
suffix:semicolon
id|BT_DBG
c_func
(paren
l_string|&quot;&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|dev_num
comma
(paren
id|u16
id|__user
op_star
)paren
id|arg
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev_num
op_logical_or
id|dev_num
OG
(paren
id|PAGE_SIZE
op_star
l_int|4
)paren
op_div
r_sizeof
(paren
op_star
id|di
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|size
op_assign
r_sizeof
(paren
op_star
id|dl
)paren
op_plus
id|dev_num
op_star
r_sizeof
(paren
op_star
id|di
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|dl
op_assign
id|kmalloc
c_func
(paren
id|size
comma
id|GFP_KERNEL
)paren
)paren
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|di
op_assign
id|dl-&gt;dev_info
suffix:semicolon
id|read_lock_bh
c_func
(paren
op_amp
id|rfcomm_dev_lock
)paren
suffix:semicolon
id|list_for_each
c_func
(paren
id|p
comma
op_amp
id|rfcomm_dev_list
)paren
(brace
r_struct
id|rfcomm_dev
op_star
id|dev
op_assign
id|list_entry
c_func
(paren
id|p
comma
r_struct
id|rfcomm_dev
comma
id|list
)paren
suffix:semicolon
(paren
id|di
op_plus
id|n
)paren
op_member_access_from_pointer
id|id
op_assign
id|dev-&gt;id
suffix:semicolon
(paren
id|di
op_plus
id|n
)paren
op_member_access_from_pointer
id|flags
op_assign
id|dev-&gt;flags
suffix:semicolon
(paren
id|di
op_plus
id|n
)paren
op_member_access_from_pointer
id|state
op_assign
id|dev-&gt;dlc-&gt;state
suffix:semicolon
(paren
id|di
op_plus
id|n
)paren
op_member_access_from_pointer
id|channel
op_assign
id|dev-&gt;channel
suffix:semicolon
id|bacpy
c_func
(paren
op_amp
(paren
id|di
op_plus
id|n
)paren
op_member_access_from_pointer
id|src
comma
op_amp
id|dev-&gt;src
)paren
suffix:semicolon
id|bacpy
c_func
(paren
op_amp
(paren
id|di
op_plus
id|n
)paren
op_member_access_from_pointer
id|dst
comma
op_amp
id|dev-&gt;dst
)paren
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|n
op_ge
id|dev_num
)paren
r_break
suffix:semicolon
)brace
id|read_unlock_bh
c_func
(paren
op_amp
id|rfcomm_dev_lock
)paren
suffix:semicolon
id|dl-&gt;dev_num
op_assign
id|n
suffix:semicolon
id|size
op_assign
r_sizeof
(paren
op_star
id|dl
)paren
op_plus
id|n
op_star
r_sizeof
(paren
op_star
id|di
)paren
suffix:semicolon
id|err
op_assign
id|copy_to_user
c_func
(paren
id|arg
comma
id|dl
comma
id|size
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dl
)paren
suffix:semicolon
r_return
id|err
ques
c_cond
op_minus
id|EFAULT
suffix:colon
l_int|0
suffix:semicolon
)brace
DECL|function|rfcomm_get_dev_info
r_static
r_int
id|rfcomm_get_dev_info
c_func
(paren
r_void
id|__user
op_star
id|arg
)paren
(brace
r_struct
id|rfcomm_dev
op_star
id|dev
suffix:semicolon
r_struct
id|rfcomm_dev_info
id|di
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
id|BT_DBG
c_func
(paren
l_string|&quot;&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|di
comma
id|arg
comma
r_sizeof
(paren
id|di
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|dev
op_assign
id|rfcomm_dev_get
c_func
(paren
id|di.id
)paren
)paren
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|di.flags
op_assign
id|dev-&gt;flags
suffix:semicolon
id|di.channel
op_assign
id|dev-&gt;channel
suffix:semicolon
id|di.state
op_assign
id|dev-&gt;dlc-&gt;state
suffix:semicolon
id|bacpy
c_func
(paren
op_amp
id|di.src
comma
op_amp
id|dev-&gt;src
)paren
suffix:semicolon
id|bacpy
c_func
(paren
op_amp
id|di.dst
comma
op_amp
id|dev-&gt;dst
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|di
comma
r_sizeof
(paren
id|di
)paren
)paren
)paren
id|err
op_assign
op_minus
id|EFAULT
suffix:semicolon
id|rfcomm_dev_put
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|rfcomm_dev_ioctl
r_int
id|rfcomm_dev_ioctl
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_int
r_int
id|cmd
comma
r_void
id|__user
op_star
id|arg
)paren
(brace
id|BT_DBG
c_func
(paren
l_string|&quot;cmd %d arg %p&quot;
comma
id|cmd
comma
id|arg
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|RFCOMMCREATEDEV
suffix:colon
r_return
id|rfcomm_create_dev
c_func
(paren
id|sk
comma
id|arg
)paren
suffix:semicolon
r_case
id|RFCOMMRELEASEDEV
suffix:colon
r_return
id|rfcomm_release_dev
c_func
(paren
id|arg
)paren
suffix:semicolon
r_case
id|RFCOMMGETDEVLIST
suffix:colon
r_return
id|rfcomm_get_dev_list
c_func
(paren
id|arg
)paren
suffix:semicolon
r_case
id|RFCOMMGETDEVINFO
suffix:colon
r_return
id|rfcomm_get_dev_info
c_func
(paren
id|arg
)paren
suffix:semicolon
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* ---- DLC callbacks ---- */
DECL|function|rfcomm_dev_data_ready
r_static
r_void
id|rfcomm_dev_data_ready
c_func
(paren
r_struct
id|rfcomm_dlc
op_star
id|dlc
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|rfcomm_dev
op_star
id|dev
op_assign
id|dlc-&gt;owner
suffix:semicolon
r_struct
id|tty_struct
op_star
id|tty
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
op_logical_or
op_logical_neg
(paren
id|tty
op_assign
id|dev-&gt;tty
)paren
)paren
(brace
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|BT_DBG
c_func
(paren
l_string|&quot;dlc %p tty %p len %d&quot;
comma
id|dlc
comma
id|tty
comma
id|skb-&gt;len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|TTY_DONT_FLIP
comma
op_amp
id|tty-&gt;flags
)paren
)paren
(brace
r_register
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|skb-&gt;len
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|tty-&gt;flip.count
op_ge
id|TTY_FLIPBUF_SIZE
)paren
id|tty_flip_buffer_push
c_func
(paren
id|tty
)paren
suffix:semicolon
id|tty_insert_flip_char
c_func
(paren
id|tty
comma
id|skb-&gt;data
(braket
id|i
)braket
comma
l_int|0
)paren
suffix:semicolon
)brace
id|tty_flip_buffer_push
c_func
(paren
id|tty
)paren
suffix:semicolon
)brace
r_else
id|tty-&gt;ldisc
dot
id|receive_buf
c_func
(paren
id|tty
comma
id|skb-&gt;data
comma
l_int|NULL
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
DECL|function|rfcomm_dev_state_change
r_static
r_void
id|rfcomm_dev_state_change
c_func
(paren
r_struct
id|rfcomm_dlc
op_star
id|dlc
comma
r_int
id|err
)paren
(brace
r_struct
id|rfcomm_dev
op_star
id|dev
op_assign
id|dlc-&gt;owner
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_return
suffix:semicolon
id|BT_DBG
c_func
(paren
l_string|&quot;dlc %p dev %p err %d&quot;
comma
id|dlc
comma
id|dev
comma
id|err
)paren
suffix:semicolon
id|dev-&gt;err
op_assign
id|err
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|dev-&gt;wait
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dlc-&gt;state
op_eq
id|BT_CLOSED
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|dev-&gt;tty
)paren
(brace
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|RFCOMM_RELEASE_ONHUP
comma
op_amp
id|dev-&gt;flags
)paren
)paren
(brace
id|rfcomm_dev_hold
c_func
(paren
id|dev
)paren
suffix:semicolon
id|rfcomm_dev_del
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* We have to drop DLC lock here, otherwise&n;&t;&t;&t;&t;   rfcomm_dev_put() will dead lock if it&squot;s&n;&t;&t;&t;&t;   the last reference. */
id|rfcomm_dlc_unlock
c_func
(paren
id|dlc
)paren
suffix:semicolon
id|rfcomm_dev_put
c_func
(paren
id|dev
)paren
suffix:semicolon
id|rfcomm_dlc_lock
c_func
(paren
id|dlc
)paren
suffix:semicolon
)brace
)brace
r_else
id|tty_hangup
c_func
(paren
id|dev-&gt;tty
)paren
suffix:semicolon
)brace
)brace
DECL|function|rfcomm_dev_modem_status
r_static
r_void
id|rfcomm_dev_modem_status
c_func
(paren
r_struct
id|rfcomm_dlc
op_star
id|dlc
comma
id|u8
id|v24_sig
)paren
(brace
r_struct
id|rfcomm_dev
op_star
id|dev
op_assign
id|dlc-&gt;owner
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_return
suffix:semicolon
id|BT_DBG
c_func
(paren
l_string|&quot;dlc %p dev %p v24_sig 0x%02x&quot;
comma
id|dlc
comma
id|dev
comma
id|v24_sig
)paren
suffix:semicolon
id|dev-&gt;modem_status
op_assign
(paren
(paren
id|v24_sig
op_amp
id|RFCOMM_V24_RTC
)paren
ques
c_cond
(paren
id|TIOCM_DSR
op_or
id|TIOCM_DTR
)paren
suffix:colon
l_int|0
)paren
op_or
(paren
(paren
id|v24_sig
op_amp
id|RFCOMM_V24_RTR
)paren
ques
c_cond
(paren
id|TIOCM_RTS
op_or
id|TIOCM_CTS
)paren
suffix:colon
l_int|0
)paren
op_or
(paren
(paren
id|v24_sig
op_amp
id|RFCOMM_V24_IC
)paren
ques
c_cond
id|TIOCM_RI
suffix:colon
l_int|0
)paren
op_or
(paren
(paren
id|v24_sig
op_amp
id|RFCOMM_V24_DV
)paren
ques
c_cond
id|TIOCM_CD
suffix:colon
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* ---- TTY functions ---- */
DECL|function|rfcomm_tty_wakeup
r_static
r_void
id|rfcomm_tty_wakeup
c_func
(paren
r_int
r_int
id|arg
)paren
(brace
r_struct
id|rfcomm_dev
op_star
id|dev
op_assign
(paren
r_void
op_star
)paren
id|arg
suffix:semicolon
r_struct
id|tty_struct
op_star
id|tty
op_assign
id|dev-&gt;tty
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tty
)paren
r_return
suffix:semicolon
id|BT_DBG
c_func
(paren
l_string|&quot;dev %p tty %p&quot;
comma
id|dev
comma
id|tty
)paren
suffix:semicolon
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|TTY_DO_WRITE_WAKEUP
comma
op_amp
id|tty-&gt;flags
)paren
op_logical_and
id|tty-&gt;ldisc.write_wakeup
)paren
(paren
id|tty-&gt;ldisc.write_wakeup
)paren
(paren
id|tty
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|tty-&gt;write_wait
)paren
suffix:semicolon
macro_line|#ifdef SERIAL_HAVE_POLL_WAIT
id|wake_up_interruptible
c_func
(paren
op_amp
id|tty-&gt;poll_wait
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|rfcomm_tty_open
r_static
r_int
id|rfcomm_tty_open
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
id|DECLARE_WAITQUEUE
c_func
(paren
id|wait
comma
id|current
)paren
suffix:semicolon
r_struct
id|rfcomm_dev
op_star
id|dev
suffix:semicolon
r_struct
id|rfcomm_dlc
op_star
id|dlc
suffix:semicolon
r_int
id|err
comma
id|id
suffix:semicolon
id|id
op_assign
id|tty-&gt;index
suffix:semicolon
id|BT_DBG
c_func
(paren
l_string|&quot;tty %p id %d&quot;
comma
id|tty
comma
id|id
)paren
suffix:semicolon
multiline_comment|/* We don&squot;t leak this refcount. For reasons which are not entirely&n;&t;   clear, the TTY layer will call our -&gt;close() method even if the&n;&t;   open fails. We decrease the refcount there, and decreasing it&n;&t;   here too would cause breakage. */
id|dev
op_assign
id|rfcomm_dev_get
c_func
(paren
id|id
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|BT_DBG
c_func
(paren
l_string|&quot;dev %p dst %s channel %d opened %d&quot;
comma
id|dev
comma
id|batostr
c_func
(paren
op_amp
id|dev-&gt;dst
)paren
comma
id|dev-&gt;channel
comma
id|dev-&gt;opened
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;opened
op_increment
op_ne
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
id|dlc
op_assign
id|dev-&gt;dlc
suffix:semicolon
multiline_comment|/* Attach TTY and open DLC */
id|rfcomm_dlc_lock
c_func
(paren
id|dlc
)paren
suffix:semicolon
id|tty-&gt;driver_data
op_assign
id|dev
suffix:semicolon
id|dev-&gt;tty
op_assign
id|tty
suffix:semicolon
id|rfcomm_dlc_unlock
c_func
(paren
id|dlc
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|RFCOMM_TTY_ATTACHED
comma
op_amp
id|dev-&gt;flags
)paren
suffix:semicolon
id|err
op_assign
id|rfcomm_dlc_open
c_func
(paren
id|dlc
comma
op_amp
id|dev-&gt;src
comma
op_amp
id|dev-&gt;dst
comma
id|dev-&gt;channel
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
multiline_comment|/* Wait for DLC to connect */
id|add_wait_queue
c_func
(paren
op_amp
id|dev-&gt;wait
comma
op_amp
id|wait
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dlc-&gt;state
op_eq
id|BT_CLOSED
)paren
(brace
id|err
op_assign
op_minus
id|dev-&gt;err
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dlc-&gt;state
op_eq
id|BT_CONNECTED
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
id|err
op_assign
op_minus
id|EINTR
suffix:semicolon
r_break
suffix:semicolon
)brace
id|schedule
c_func
(paren
)paren
suffix:semicolon
)brace
id|set_current_state
c_func
(paren
id|TASK_RUNNING
)paren
suffix:semicolon
id|remove_wait_queue
c_func
(paren
op_amp
id|dev-&gt;wait
comma
op_amp
id|wait
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|rfcomm_tty_close
r_static
r_void
id|rfcomm_tty_close
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_struct
id|rfcomm_dev
op_star
id|dev
op_assign
(paren
r_struct
id|rfcomm_dev
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_return
suffix:semicolon
id|BT_DBG
c_func
(paren
l_string|&quot;tty %p dev %p dlc %p opened %d&quot;
comma
id|tty
comma
id|dev
comma
id|dev-&gt;dlc
comma
id|dev-&gt;opened
)paren
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|dev-&gt;opened
op_eq
l_int|0
)paren
(brace
multiline_comment|/* Close DLC and dettach TTY */
id|rfcomm_dlc_close
c_func
(paren
id|dev-&gt;dlc
comma
l_int|0
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|RFCOMM_TTY_ATTACHED
comma
op_amp
id|dev-&gt;flags
)paren
suffix:semicolon
id|tasklet_kill
c_func
(paren
op_amp
id|dev-&gt;wakeup_task
)paren
suffix:semicolon
id|rfcomm_dlc_lock
c_func
(paren
id|dev-&gt;dlc
)paren
suffix:semicolon
id|tty-&gt;driver_data
op_assign
l_int|NULL
suffix:semicolon
id|dev-&gt;tty
op_assign
l_int|NULL
suffix:semicolon
id|rfcomm_dlc_unlock
c_func
(paren
id|dev-&gt;dlc
)paren
suffix:semicolon
)brace
id|rfcomm_dev_put
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
DECL|function|rfcomm_tty_write
r_static
r_int
id|rfcomm_tty_write
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_const
r_int
r_char
op_star
id|buf
comma
r_int
id|count
)paren
(brace
r_struct
id|rfcomm_dev
op_star
id|dev
op_assign
(paren
r_struct
id|rfcomm_dev
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_struct
id|rfcomm_dlc
op_star
id|dlc
op_assign
id|dev-&gt;dlc
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|err
op_assign
l_int|0
comma
id|sent
op_assign
l_int|0
comma
id|size
suffix:semicolon
id|BT_DBG
c_func
(paren
l_string|&quot;tty %p count %d&quot;
comma
id|tty
comma
id|count
)paren
suffix:semicolon
r_while
c_loop
(paren
id|count
)paren
(brace
id|size
op_assign
id|min_t
c_func
(paren
id|uint
comma
id|count
comma
id|dlc-&gt;mtu
)paren
suffix:semicolon
id|skb
op_assign
id|rfcomm_wmalloc
c_func
(paren
id|dev
comma
id|size
op_plus
id|RFCOMM_SKB_RESERVE
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
r_break
suffix:semicolon
id|skb_reserve
c_func
(paren
id|skb
comma
id|RFCOMM_SKB_HEAD_RESERVE
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|size
)paren
comma
id|buf
op_plus
id|sent
comma
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|rfcomm_dlc_send
c_func
(paren
id|dlc
comma
id|skb
)paren
)paren
OL
l_int|0
)paren
(brace
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|sent
op_add_assign
id|size
suffix:semicolon
id|count
op_sub_assign
id|size
suffix:semicolon
)brace
r_return
id|sent
ques
c_cond
id|sent
suffix:colon
id|err
suffix:semicolon
)brace
DECL|function|rfcomm_tty_write_room
r_static
r_int
id|rfcomm_tty_write_room
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_struct
id|rfcomm_dev
op_star
id|dev
op_assign
(paren
r_struct
id|rfcomm_dev
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_int
id|room
suffix:semicolon
id|BT_DBG
c_func
(paren
l_string|&quot;tty %p&quot;
comma
id|tty
)paren
suffix:semicolon
id|room
op_assign
id|rfcomm_room
c_func
(paren
id|dev-&gt;dlc
)paren
op_minus
id|atomic_read
c_func
(paren
op_amp
id|dev-&gt;wmem_alloc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|room
OL
l_int|0
)paren
id|room
op_assign
l_int|0
suffix:semicolon
r_return
id|room
suffix:semicolon
)brace
DECL|function|rfcomm_tty_ioctl
r_static
r_int
id|rfcomm_tty_ioctl
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|filp
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
id|BT_DBG
c_func
(paren
l_string|&quot;tty %p cmd 0x%02x&quot;
comma
id|tty
comma
id|cmd
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|TCGETS
suffix:colon
id|BT_DBG
c_func
(paren
l_string|&quot;TCGETS is not supported&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
r_case
id|TCSETS
suffix:colon
id|BT_DBG
c_func
(paren
l_string|&quot;TCSETS is not supported&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
r_case
id|TIOCMIWAIT
suffix:colon
id|BT_DBG
c_func
(paren
l_string|&quot;TIOCMIWAIT&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TIOCGICOUNT
suffix:colon
id|BT_DBG
c_func
(paren
l_string|&quot;TIOCGICOUNT&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|TIOCGSERIAL
suffix:colon
id|BT_ERR
c_func
(paren
l_string|&quot;TIOCGSERIAL is not supported&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
r_case
id|TIOCSSERIAL
suffix:colon
id|BT_ERR
c_func
(paren
l_string|&quot;TIOCSSERIAL is not supported&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
r_case
id|TIOCSERGSTRUCT
suffix:colon
id|BT_ERR
c_func
(paren
l_string|&quot;TIOCSERGSTRUCT is not supported&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
r_case
id|TIOCSERGETLSR
suffix:colon
id|BT_ERR
c_func
(paren
l_string|&quot;TIOCSERGETLSR is not supported&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
r_case
id|TIOCSERCONFIG
suffix:colon
id|BT_ERR
c_func
(paren
l_string|&quot;TIOCSERCONFIG is not supported&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
multiline_comment|/* ioctls which we must ignore */
)brace
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
)brace
DECL|macro|RELEVANT_IFLAG
mdefine_line|#define RELEVANT_IFLAG(iflag) (iflag &amp; (IGNBRK|BRKINT|IGNPAR|PARMRK|INPCK))
DECL|function|rfcomm_tty_set_termios
r_static
r_void
id|rfcomm_tty_set_termios
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|termios
op_star
id|old
)paren
(brace
id|BT_DBG
c_func
(paren
l_string|&quot;tty %p&quot;
comma
id|tty
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tty-&gt;termios-&gt;c_cflag
op_eq
id|old-&gt;c_cflag
)paren
op_logical_and
(paren
id|RELEVANT_IFLAG
c_func
(paren
id|tty-&gt;termios-&gt;c_iflag
)paren
op_eq
id|RELEVANT_IFLAG
c_func
(paren
id|old-&gt;c_iflag
)paren
)paren
)paren
r_return
suffix:semicolon
multiline_comment|/* handle turning off CRTSCTS */
r_if
c_cond
(paren
(paren
id|old-&gt;c_cflag
op_amp
id|CRTSCTS
)paren
op_logical_and
op_logical_neg
(paren
id|tty-&gt;termios-&gt;c_cflag
op_amp
id|CRTSCTS
)paren
)paren
(brace
id|BT_DBG
c_func
(paren
l_string|&quot;turning off CRTSCTS&quot;
)paren
suffix:semicolon
)brace
)brace
DECL|function|rfcomm_tty_throttle
r_static
r_void
id|rfcomm_tty_throttle
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_struct
id|rfcomm_dev
op_star
id|dev
op_assign
(paren
r_struct
id|rfcomm_dev
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
id|BT_DBG
c_func
(paren
l_string|&quot;tty %p dev %p&quot;
comma
id|tty
comma
id|dev
)paren
suffix:semicolon
id|rfcomm_dlc_throttle
c_func
(paren
id|dev-&gt;dlc
)paren
suffix:semicolon
)brace
DECL|function|rfcomm_tty_unthrottle
r_static
r_void
id|rfcomm_tty_unthrottle
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_struct
id|rfcomm_dev
op_star
id|dev
op_assign
(paren
r_struct
id|rfcomm_dev
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
id|BT_DBG
c_func
(paren
l_string|&quot;tty %p dev %p&quot;
comma
id|tty
comma
id|dev
)paren
suffix:semicolon
id|rfcomm_dlc_unthrottle
c_func
(paren
id|dev-&gt;dlc
)paren
suffix:semicolon
)brace
DECL|function|rfcomm_tty_chars_in_buffer
r_static
r_int
id|rfcomm_tty_chars_in_buffer
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_struct
id|rfcomm_dev
op_star
id|dev
op_assign
(paren
r_struct
id|rfcomm_dev
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_struct
id|rfcomm_dlc
op_star
id|dlc
op_assign
id|dev-&gt;dlc
suffix:semicolon
id|BT_DBG
c_func
(paren
l_string|&quot;tty %p dev %p&quot;
comma
id|tty
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb_queue_len
c_func
(paren
op_amp
id|dlc-&gt;tx_queue
)paren
)paren
r_return
id|dlc-&gt;mtu
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|rfcomm_tty_flush_buffer
r_static
r_void
id|rfcomm_tty_flush_buffer
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_struct
id|rfcomm_dev
op_star
id|dev
op_assign
(paren
r_struct
id|rfcomm_dev
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_return
suffix:semicolon
id|BT_DBG
c_func
(paren
l_string|&quot;tty %p dev %p&quot;
comma
id|tty
comma
id|dev
)paren
suffix:semicolon
id|skb_queue_purge
c_func
(paren
op_amp
id|dev-&gt;dlc-&gt;tx_queue
)paren
suffix:semicolon
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|TTY_DO_WRITE_WAKEUP
comma
op_amp
id|tty-&gt;flags
)paren
op_logical_and
id|tty-&gt;ldisc.write_wakeup
)paren
id|tty-&gt;ldisc
dot
id|write_wakeup
c_func
(paren
id|tty
)paren
suffix:semicolon
)brace
DECL|function|rfcomm_tty_send_xchar
r_static
r_void
id|rfcomm_tty_send_xchar
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_char
id|ch
)paren
(brace
id|BT_DBG
c_func
(paren
l_string|&quot;tty %p ch %c&quot;
comma
id|tty
comma
id|ch
)paren
suffix:semicolon
)brace
DECL|function|rfcomm_tty_wait_until_sent
r_static
r_void
id|rfcomm_tty_wait_until_sent
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_int
id|timeout
)paren
(brace
id|BT_DBG
c_func
(paren
l_string|&quot;tty %p timeout %d&quot;
comma
id|tty
comma
id|timeout
)paren
suffix:semicolon
)brace
DECL|function|rfcomm_tty_hangup
r_static
r_void
id|rfcomm_tty_hangup
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
)paren
(brace
r_struct
id|rfcomm_dev
op_star
id|dev
op_assign
(paren
r_struct
id|rfcomm_dev
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_return
suffix:semicolon
id|BT_DBG
c_func
(paren
l_string|&quot;tty %p dev %p&quot;
comma
id|tty
comma
id|dev
)paren
suffix:semicolon
id|rfcomm_tty_flush_buffer
c_func
(paren
id|tty
)paren
suffix:semicolon
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|RFCOMM_RELEASE_ONHUP
comma
op_amp
id|dev-&gt;flags
)paren
)paren
id|rfcomm_dev_del
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
DECL|function|rfcomm_tty_read_proc
r_static
r_int
id|rfcomm_tty_read_proc
c_func
(paren
r_char
op_star
id|buf
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|len
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|unused
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|rfcomm_tty_tiocmget
r_static
r_int
id|rfcomm_tty_tiocmget
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_struct
id|rfcomm_dev
op_star
id|dev
op_assign
(paren
r_struct
id|rfcomm_dev
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
id|BT_DBG
c_func
(paren
l_string|&quot;tty %p dev %p&quot;
comma
id|tty
comma
id|dev
)paren
suffix:semicolon
r_return
id|dev-&gt;modem_status
suffix:semicolon
)brace
DECL|function|rfcomm_tty_tiocmset
r_static
r_int
id|rfcomm_tty_tiocmset
c_func
(paren
r_struct
id|tty_struct
op_star
id|tty
comma
r_struct
id|file
op_star
id|filp
comma
r_int
r_int
id|set
comma
r_int
r_int
id|clear
)paren
(brace
r_struct
id|rfcomm_dev
op_star
id|dev
op_assign
(paren
r_struct
id|rfcomm_dev
op_star
)paren
id|tty-&gt;driver_data
suffix:semicolon
r_struct
id|rfcomm_dlc
op_star
id|dlc
op_assign
id|dev-&gt;dlc
suffix:semicolon
id|u8
id|v24_sig
suffix:semicolon
id|BT_DBG
c_func
(paren
l_string|&quot;tty %p dev %p set 0x%02x clear 0x%02x&quot;
comma
id|tty
comma
id|dev
comma
id|set
comma
id|clear
)paren
suffix:semicolon
id|rfcomm_dlc_get_modem_status
c_func
(paren
id|dlc
comma
op_amp
id|v24_sig
)paren
suffix:semicolon
r_if
c_cond
(paren
id|set
op_amp
id|TIOCM_DSR
op_logical_or
id|set
op_amp
id|TIOCM_DTR
)paren
id|v24_sig
op_or_assign
id|RFCOMM_V24_RTC
suffix:semicolon
r_if
c_cond
(paren
id|set
op_amp
id|TIOCM_RTS
op_logical_or
id|set
op_amp
id|TIOCM_CTS
)paren
id|v24_sig
op_or_assign
id|RFCOMM_V24_RTR
suffix:semicolon
r_if
c_cond
(paren
id|set
op_amp
id|TIOCM_RI
)paren
id|v24_sig
op_or_assign
id|RFCOMM_V24_IC
suffix:semicolon
r_if
c_cond
(paren
id|set
op_amp
id|TIOCM_CD
)paren
id|v24_sig
op_or_assign
id|RFCOMM_V24_DV
suffix:semicolon
r_if
c_cond
(paren
id|clear
op_amp
id|TIOCM_DSR
op_logical_or
id|clear
op_amp
id|TIOCM_DTR
)paren
id|v24_sig
op_and_assign
op_complement
id|RFCOMM_V24_RTC
suffix:semicolon
r_if
c_cond
(paren
id|clear
op_amp
id|TIOCM_RTS
op_logical_or
id|clear
op_amp
id|TIOCM_CTS
)paren
id|v24_sig
op_and_assign
op_complement
id|RFCOMM_V24_RTR
suffix:semicolon
r_if
c_cond
(paren
id|clear
op_amp
id|TIOCM_RI
)paren
id|v24_sig
op_and_assign
op_complement
id|RFCOMM_V24_IC
suffix:semicolon
r_if
c_cond
(paren
id|clear
op_amp
id|TIOCM_CD
)paren
id|v24_sig
op_and_assign
op_complement
id|RFCOMM_V24_DV
suffix:semicolon
id|rfcomm_dlc_set_modem_status
c_func
(paren
id|dlc
comma
id|v24_sig
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* ---- TTY structure ---- */
DECL|variable|rfcomm_ops
r_static
r_struct
id|tty_operations
id|rfcomm_ops
op_assign
(brace
dot
id|open
op_assign
id|rfcomm_tty_open
comma
dot
id|close
op_assign
id|rfcomm_tty_close
comma
dot
id|write
op_assign
id|rfcomm_tty_write
comma
dot
id|write_room
op_assign
id|rfcomm_tty_write_room
comma
dot
id|chars_in_buffer
op_assign
id|rfcomm_tty_chars_in_buffer
comma
dot
id|flush_buffer
op_assign
id|rfcomm_tty_flush_buffer
comma
dot
id|ioctl
op_assign
id|rfcomm_tty_ioctl
comma
dot
id|throttle
op_assign
id|rfcomm_tty_throttle
comma
dot
id|unthrottle
op_assign
id|rfcomm_tty_unthrottle
comma
dot
id|set_termios
op_assign
id|rfcomm_tty_set_termios
comma
dot
id|send_xchar
op_assign
id|rfcomm_tty_send_xchar
comma
dot
id|hangup
op_assign
id|rfcomm_tty_hangup
comma
dot
id|wait_until_sent
op_assign
id|rfcomm_tty_wait_until_sent
comma
dot
id|read_proc
op_assign
id|rfcomm_tty_read_proc
comma
dot
id|tiocmget
op_assign
id|rfcomm_tty_tiocmget
comma
dot
id|tiocmset
op_assign
id|rfcomm_tty_tiocmset
comma
)brace
suffix:semicolon
DECL|function|rfcomm_init_ttys
r_int
id|rfcomm_init_ttys
c_func
(paren
r_void
)paren
(brace
id|rfcomm_tty_driver
op_assign
id|alloc_tty_driver
c_func
(paren
id|RFCOMM_TTY_PORTS
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rfcomm_tty_driver
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|rfcomm_tty_driver-&gt;owner
op_assign
id|THIS_MODULE
suffix:semicolon
id|rfcomm_tty_driver-&gt;driver_name
op_assign
l_string|&quot;rfcomm&quot;
suffix:semicolon
id|rfcomm_tty_driver-&gt;devfs_name
op_assign
l_string|&quot;bluetooth/rfcomm/&quot;
suffix:semicolon
id|rfcomm_tty_driver-&gt;name
op_assign
l_string|&quot;rfcomm&quot;
suffix:semicolon
id|rfcomm_tty_driver-&gt;major
op_assign
id|RFCOMM_TTY_MAJOR
suffix:semicolon
id|rfcomm_tty_driver-&gt;minor_start
op_assign
id|RFCOMM_TTY_MINOR
suffix:semicolon
id|rfcomm_tty_driver-&gt;type
op_assign
id|TTY_DRIVER_TYPE_SERIAL
suffix:semicolon
id|rfcomm_tty_driver-&gt;subtype
op_assign
id|SERIAL_TYPE_NORMAL
suffix:semicolon
id|rfcomm_tty_driver-&gt;flags
op_assign
id|TTY_DRIVER_REAL_RAW
op_or
id|TTY_DRIVER_NO_DEVFS
suffix:semicolon
id|rfcomm_tty_driver-&gt;init_termios
op_assign
id|tty_std_termios
suffix:semicolon
id|rfcomm_tty_driver-&gt;init_termios.c_cflag
op_assign
id|B9600
op_or
id|CS8
op_or
id|CREAD
op_or
id|HUPCL
op_or
id|CLOCAL
suffix:semicolon
id|tty_set_operations
c_func
(paren
id|rfcomm_tty_driver
comma
op_amp
id|rfcomm_ops
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tty_register_driver
c_func
(paren
id|rfcomm_tty_driver
)paren
)paren
(brace
id|BT_ERR
c_func
(paren
l_string|&quot;Can&squot;t register RFCOMM TTY driver&quot;
)paren
suffix:semicolon
id|put_tty_driver
c_func
(paren
id|rfcomm_tty_driver
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|BT_INFO
c_func
(paren
l_string|&quot;RFCOMM TTY layer initialized&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|rfcomm_cleanup_ttys
r_void
id|rfcomm_cleanup_ttys
c_func
(paren
r_void
)paren
(brace
id|tty_unregister_driver
c_func
(paren
id|rfcomm_tty_driver
)paren
suffix:semicolon
id|put_tty_driver
c_func
(paren
id|rfcomm_tty_driver
)paren
suffix:semicolon
)brace
eof
