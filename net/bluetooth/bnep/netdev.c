multiline_comment|/* &n;   BNEP implementation for Linux Bluetooth stack (BlueZ).&n;   Copyright (C) 2001-2002 Inventel Systemes&n;   Written 2001-2002 by&n;&t;Cl&#xfffd;ment Moreau &lt;clement.moreau@inventel.fr&gt;&n;&t;David Libault  &lt;david.libault@inventel.fr&gt;&n;&n;   Copyright (C) 2002 Maxim Krasnyanskiy &lt;maxk@qualcomm.com&gt;&n;&n;   This program is free software; you can redistribute it and/or modify&n;   it under the terms of the GNU General Public License version 2 as&n;   published by the Free Software Foundation;&n;&n;   THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS&n;   OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,&n;   FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT OF THIRD PARTY RIGHTS.&n;   IN NO EVENT SHALL THE COPYRIGHT HOLDER(S) AND AUTHOR(S) BE LIABLE FOR ANY&n;   CLAIM, OR ANY SPECIAL INDIRECT OR CONSEQUENTIAL DAMAGES, OR ANY DAMAGES &n;   WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN &n;   ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF &n;   OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.&n;&n;   ALL LIABILITY, INCLUDING LIABILITY FOR INFRINGEMENT OF ANY PATENTS, &n;   COPYRIGHTS, TRADEMARKS OR OTHER RIGHTS, RELATING TO USE OF THIS &n;   SOFTWARE IS DISCLAIMED.&n;*/
multiline_comment|/*&n; * $Id: netdev.c,v 1.8 2002/08/04 21:23:58 maxk Exp $&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/socket.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/wait.h&gt;
macro_line|#include &lt;asm/unaligned.h&gt;
macro_line|#include &lt;net/bluetooth/bluetooth.h&gt;
macro_line|#include &lt;net/bluetooth/hci_core.h&gt;
macro_line|#include &lt;net/bluetooth/l2cap.h&gt;
macro_line|#include &quot;bnep.h&quot;
macro_line|#ifndef CONFIG_BT_BNEP_DEBUG
DECL|macro|BT_DBG
macro_line|#undef  BT_DBG
DECL|macro|BT_DBG
mdefine_line|#define BT_DBG( A... )
macro_line|#endif
DECL|macro|BNEP_TX_QUEUE_LEN
mdefine_line|#define BNEP_TX_QUEUE_LEN 20
DECL|function|bnep_net_open
r_static
r_int
id|bnep_net_open
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|netif_start_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|bnep_net_close
r_static
r_int
id|bnep_net_close
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|bnep_net_get_stats
r_static
r_struct
id|net_device_stats
op_star
id|bnep_net_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|bnep_session
op_star
id|s
op_assign
id|dev-&gt;priv
suffix:semicolon
r_return
op_amp
id|s-&gt;stats
suffix:semicolon
)brace
DECL|function|bnep_net_set_mc_list
r_static
r_void
id|bnep_net_set_mc_list
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
macro_line|#ifdef CONFIG_BT_BNEP_MC_FILTER
r_struct
id|bnep_session
op_star
id|s
op_assign
id|dev-&gt;priv
suffix:semicolon
r_struct
id|sock
op_star
id|sk
op_assign
id|s-&gt;sock-&gt;sk
suffix:semicolon
r_struct
id|bnep_set_filter_req
op_star
id|r
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|size
suffix:semicolon
id|BT_DBG
c_func
(paren
l_string|&quot;%s mc_count %d&quot;
comma
id|dev-&gt;name
comma
id|dev-&gt;mc_count
)paren
suffix:semicolon
id|size
op_assign
r_sizeof
(paren
op_star
id|r
)paren
op_plus
(paren
id|BNEP_MAX_MULTICAST_FILTERS
op_plus
l_int|1
)paren
op_star
id|ETH_ALEN
op_star
l_int|2
suffix:semicolon
id|skb
op_assign
id|alloc_skb
c_func
(paren
id|size
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
(brace
id|BT_ERR
c_func
(paren
l_string|&quot;%s Multicast list allocation failed&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|r
op_assign
(paren
r_void
op_star
)paren
id|skb-&gt;data
suffix:semicolon
id|__skb_put
c_func
(paren
id|skb
comma
r_sizeof
(paren
op_star
id|r
)paren
)paren
suffix:semicolon
id|r-&gt;type
op_assign
id|BNEP_CONTROL
suffix:semicolon
id|r-&gt;ctrl
op_assign
id|BNEP_FILTER_MULTI_ADDR_SET
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
(paren
id|IFF_PROMISC
op_or
id|IFF_ALLMULTI
)paren
)paren
(brace
id|u8
id|start
(braket
id|ETH_ALEN
)braket
op_assign
(brace
l_int|0x01
)brace
suffix:semicolon
multiline_comment|/* Request all addresses */
id|memcpy
c_func
(paren
id|__skb_put
c_func
(paren
id|skb
comma
id|ETH_ALEN
)paren
comma
id|start
comma
id|ETH_ALEN
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|__skb_put
c_func
(paren
id|skb
comma
id|ETH_ALEN
)paren
comma
id|dev-&gt;broadcast
comma
id|ETH_ALEN
)paren
suffix:semicolon
id|r-&gt;len
op_assign
id|htons
c_func
(paren
id|ETH_ALEN
op_star
l_int|2
)paren
suffix:semicolon
)brace
r_else
(brace
r_struct
id|dev_mc_list
op_star
id|dmi
op_assign
id|dev-&gt;mc_list
suffix:semicolon
r_int
id|i
comma
id|len
op_assign
id|skb-&gt;len
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_BROADCAST
)paren
(brace
id|memcpy
c_func
(paren
id|__skb_put
c_func
(paren
id|skb
comma
id|ETH_ALEN
)paren
comma
id|dev-&gt;broadcast
comma
id|ETH_ALEN
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|__skb_put
c_func
(paren
id|skb
comma
id|ETH_ALEN
)paren
comma
id|dev-&gt;broadcast
comma
id|ETH_ALEN
)paren
suffix:semicolon
)brace
multiline_comment|/* FIXME: We should group addresses here. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|dev-&gt;mc_count
op_logical_and
id|i
OL
id|BNEP_MAX_MULTICAST_FILTERS
suffix:semicolon
id|i
op_increment
)paren
(brace
id|memcpy
c_func
(paren
id|__skb_put
c_func
(paren
id|skb
comma
id|ETH_ALEN
)paren
comma
id|dmi-&gt;dmi_addr
comma
id|ETH_ALEN
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|__skb_put
c_func
(paren
id|skb
comma
id|ETH_ALEN
)paren
comma
id|dmi-&gt;dmi_addr
comma
id|ETH_ALEN
)paren
suffix:semicolon
id|dmi
op_assign
id|dmi-&gt;next
suffix:semicolon
)brace
id|r-&gt;len
op_assign
id|htons
c_func
(paren
id|skb-&gt;len
op_minus
id|len
)paren
suffix:semicolon
)brace
id|skb_queue_tail
c_func
(paren
op_amp
id|sk-&gt;write_queue
comma
id|skb
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
id|sk-&gt;sleep
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|bnep_net_set_mac_addr
r_static
r_int
id|bnep_net_set_mac_addr
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_void
op_star
id|arg
)paren
(brace
id|BT_DBG
c_func
(paren
l_string|&quot;%s&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|bnep_net_timeout
r_static
r_void
id|bnep_net_timeout
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|BT_DBG
c_func
(paren
l_string|&quot;net_timeout&quot;
)paren
suffix:semicolon
id|netif_wake_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
DECL|function|bnep_net_ioctl
r_static
r_int
id|bnep_net_ioctl
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ifreq
op_star
id|ifr
comma
r_int
id|cmd
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_BT_BNEP_MC_FILTER
DECL|function|bnep_net_mc_filter
r_static
r_inline
r_int
id|bnep_net_mc_filter
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|bnep_session
op_star
id|s
)paren
(brace
r_struct
id|ethhdr
op_star
id|eh
op_assign
(paren
r_void
op_star
)paren
id|skb-&gt;data
suffix:semicolon
r_if
c_cond
(paren
(paren
id|eh-&gt;h_dest
(braket
l_int|0
)braket
op_amp
l_int|1
)paren
op_logical_and
op_logical_neg
id|test_bit
c_func
(paren
id|bnep_mc_hash
c_func
(paren
id|eh-&gt;h_dest
)paren
comma
(paren
id|ulong
op_star
)paren
op_amp
id|s-&gt;mc_filter
)paren
)paren
r_return
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifdef CONFIG_BT_BNEP_PROTO_FILTER
multiline_comment|/* Determine ether protocol. Based on eth_type_trans. */
DECL|function|bnep_net_eth_proto
r_static
r_inline
id|u16
id|bnep_net_eth_proto
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|ethhdr
op_star
id|eh
op_assign
(paren
r_void
op_star
)paren
id|skb-&gt;data
suffix:semicolon
r_if
c_cond
(paren
id|ntohs
c_func
(paren
id|eh-&gt;h_proto
)paren
op_ge
l_int|1536
)paren
r_return
id|eh-&gt;h_proto
suffix:semicolon
r_if
c_cond
(paren
id|get_unaligned
c_func
(paren
(paren
id|u16
op_star
)paren
id|skb-&gt;data
)paren
op_eq
l_int|0xFFFF
)paren
r_return
id|htons
c_func
(paren
id|ETH_P_802_3
)paren
suffix:semicolon
r_return
id|htons
c_func
(paren
id|ETH_P_802_2
)paren
suffix:semicolon
)brace
DECL|function|bnep_net_proto_filter
r_static
r_inline
r_int
id|bnep_net_proto_filter
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|bnep_session
op_star
id|s
)paren
(brace
id|u16
id|proto
op_assign
id|bnep_net_eth_proto
c_func
(paren
id|skb
)paren
suffix:semicolon
r_struct
id|bnep_proto_filter
op_star
id|f
op_assign
id|s-&gt;proto_filter
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|BNEP_MAX_PROTO_FILTERS
op_logical_and
id|f
(braket
id|i
)braket
dot
id|end
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|proto
op_ge
id|f
(braket
id|i
)braket
dot
id|start
op_logical_and
id|proto
op_le
id|f
(braket
id|i
)braket
dot
id|end
)paren
r_return
l_int|0
suffix:semicolon
)brace
id|BT_DBG
c_func
(paren
l_string|&quot;BNEP: filtered skb %p, proto 0x%.4x&quot;
comma
id|skb
comma
id|proto
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
macro_line|#endif
DECL|function|bnep_net_xmit
r_static
r_int
id|bnep_net_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|bnep_session
op_star
id|s
op_assign
id|dev-&gt;priv
suffix:semicolon
r_struct
id|sock
op_star
id|sk
op_assign
id|s-&gt;sock-&gt;sk
suffix:semicolon
id|BT_DBG
c_func
(paren
l_string|&quot;skb %p, dev %p&quot;
comma
id|skb
comma
id|dev
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_BT_BNEP_MC_FILTER
r_if
c_cond
(paren
id|bnep_net_mc_filter
c_func
(paren
id|skb
comma
id|s
)paren
)paren
(brace
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifdef CONFIG_BT_BNEP_PROTO_FILTER
r_if
c_cond
(paren
id|bnep_net_proto_filter
c_func
(paren
id|skb
comma
id|s
)paren
)paren
(brace
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n;&t; * We cannot send L2CAP packets from here as we are potentially in a bh.&n;&t; * So we have to queue them and wake up session thread which is sleeping&n;&t; * on the sk-&gt;sleep.&n;&t; */
id|dev-&gt;trans_start
op_assign
id|jiffies
suffix:semicolon
id|skb_queue_tail
c_func
(paren
op_amp
id|sk-&gt;write_queue
comma
id|skb
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
id|sk-&gt;sleep
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb_queue_len
c_func
(paren
op_amp
id|sk-&gt;write_queue
)paren
op_ge
id|BNEP_TX_QUEUE_LEN
)paren
(brace
id|BT_DBG
c_func
(paren
l_string|&quot;tx queue is full&quot;
)paren
suffix:semicolon
multiline_comment|/* Stop queuing.&n;&t;&t; * Session thread will do netif_wake_queue() */
id|netif_stop_queue
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|bnep_net_init
r_int
id|bnep_net_init
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|bnep_session
op_star
id|s
op_assign
id|dev-&gt;priv
suffix:semicolon
id|memcpy
c_func
(paren
id|dev-&gt;dev_addr
comma
id|s-&gt;eh.h_dest
comma
id|ETH_ALEN
)paren
suffix:semicolon
id|dev-&gt;addr_len
op_assign
id|ETH_ALEN
suffix:semicolon
id|ether_setup
c_func
(paren
id|dev
)paren
suffix:semicolon
id|dev-&gt;open
op_assign
id|bnep_net_open
suffix:semicolon
id|dev-&gt;stop
op_assign
id|bnep_net_close
suffix:semicolon
id|dev-&gt;hard_start_xmit
op_assign
id|bnep_net_xmit
suffix:semicolon
id|dev-&gt;get_stats
op_assign
id|bnep_net_get_stats
suffix:semicolon
id|dev-&gt;do_ioctl
op_assign
id|bnep_net_ioctl
suffix:semicolon
id|dev-&gt;set_mac_address
op_assign
id|bnep_net_set_mac_addr
suffix:semicolon
id|dev-&gt;set_multicast_list
op_assign
id|bnep_net_set_mc_list
suffix:semicolon
id|dev-&gt;watchdog_timeo
op_assign
id|HZ
op_star
l_int|2
suffix:semicolon
id|dev-&gt;tx_timeout
op_assign
id|bnep_net_timeout
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
eof
