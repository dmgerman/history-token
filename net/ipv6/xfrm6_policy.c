multiline_comment|/*&n; * xfrm6_policy.c: based on xfrm4_policy.c&n; *&n; * Authors:&n; *&t;Mitsuru KANDA @USAGI&n; * &t;Kazunori MIYAZAWA @USAGI&n; * &t;Kunihiro Ishiguro &lt;kunihiro@ipinfusion.com&gt;&n; * &t;&t;IPv6 support&n; * &t;YOSHIFUJI Hideaki&n; * &t;&t;Split up af-specific portion&n; * &n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;net/xfrm.h&gt;
macro_line|#include &lt;net/ip.h&gt;
macro_line|#include &lt;net/ipv6.h&gt;
macro_line|#include &lt;net/ip6_route.h&gt;
r_extern
r_struct
id|dst_ops
id|xfrm6_dst_ops
suffix:semicolon
r_extern
r_struct
id|xfrm_policy_afinfo
id|xfrm6_policy_afinfo
suffix:semicolon
DECL|variable|xfrm6_type_map
r_static
r_struct
id|xfrm_type_map
id|xfrm6_type_map
op_assign
(brace
dot
id|lock
op_assign
id|RW_LOCK_UNLOCKED
)brace
suffix:semicolon
DECL|function|xfrm6_dst_lookup
r_int
id|xfrm6_dst_lookup
c_func
(paren
r_struct
id|xfrm_dst
op_star
op_star
id|dst
comma
r_struct
id|flowi
op_star
id|fl
)paren
(brace
r_int
id|err
op_assign
l_int|0
suffix:semicolon
op_star
id|dst
op_assign
(paren
r_struct
id|xfrm_dst
op_star
)paren
id|ip6_route_output
c_func
(paren
l_int|NULL
comma
id|fl
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
op_star
id|dst
)paren
id|err
op_assign
op_minus
id|ENETUNREACH
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/* Check that the bundle accepts the flow and its components are&n; * still valid.&n; */
DECL|function|__xfrm6_bundle_ok
r_static
r_int
id|__xfrm6_bundle_ok
c_func
(paren
r_struct
id|xfrm_dst
op_star
id|xdst
comma
r_struct
id|flowi
op_star
id|fl
)paren
(brace
r_do
(brace
r_if
c_cond
(paren
id|xdst-&gt;u.dst.ops
op_ne
op_amp
id|xfrm6_dst_ops
)paren
r_return
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|xfrm_selector_match
c_func
(paren
op_amp
id|xdst-&gt;u.dst.xfrm-&gt;sel
comma
id|fl
comma
id|AF_INET6
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|xdst-&gt;u.dst.xfrm-&gt;km.state
op_ne
id|XFRM_STATE_VALID
op_logical_or
id|xdst-&gt;u.dst.path-&gt;obsolete
OG
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
id|xdst
op_assign
(paren
r_struct
id|xfrm_dst
op_star
)paren
id|xdst-&gt;u.dst.child
suffix:semicolon
)brace
r_while
c_loop
(paren
id|xdst
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_struct
id|dst_entry
op_star
DECL|function|__xfrm6_find_bundle
id|__xfrm6_find_bundle
c_func
(paren
r_struct
id|flowi
op_star
id|fl
comma
r_struct
id|xfrm_policy
op_star
id|policy
)paren
(brace
r_struct
id|dst_entry
op_star
id|dst
suffix:semicolon
multiline_comment|/* Still not clear if we should set fl-&gt;fl6_{src,dst}... */
id|read_lock_bh
c_func
(paren
op_amp
id|policy-&gt;lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|dst
op_assign
id|policy-&gt;bundles
suffix:semicolon
id|dst
suffix:semicolon
id|dst
op_assign
id|dst-&gt;next
)paren
(brace
r_struct
id|xfrm_dst
op_star
id|xdst
op_assign
(paren
r_struct
id|xfrm_dst
op_star
)paren
id|dst
suffix:semicolon
r_struct
id|in6_addr
id|fl_dst_prefix
comma
id|fl_src_prefix
suffix:semicolon
id|ipv6_addr_prefix
c_func
(paren
op_amp
id|fl_dst_prefix
comma
op_amp
id|fl-&gt;fl6_dst
comma
id|xdst-&gt;u.rt6.rt6i_dst.plen
)paren
suffix:semicolon
id|ipv6_addr_prefix
c_func
(paren
op_amp
id|fl_src_prefix
comma
op_amp
id|fl-&gt;fl6_src
comma
id|xdst-&gt;u.rt6.rt6i_src.plen
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ipv6_addr_cmp
c_func
(paren
op_amp
id|xdst-&gt;u.rt6.rt6i_dst.addr
comma
op_amp
id|fl_dst_prefix
)paren
op_logical_and
op_logical_neg
id|ipv6_addr_cmp
c_func
(paren
op_amp
id|xdst-&gt;u.rt6.rt6i_src.addr
comma
op_amp
id|fl_src_prefix
)paren
op_logical_and
id|__xfrm6_bundle_ok
c_func
(paren
id|xdst
comma
id|fl
)paren
)paren
(brace
id|dst_clone
c_func
(paren
id|dst
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|read_unlock_bh
c_func
(paren
op_amp
id|policy-&gt;lock
)paren
suffix:semicolon
r_return
id|dst
suffix:semicolon
)brace
multiline_comment|/* Allocate chain of dst_entry&squot;s, attach known xfrm&squot;s, calculate&n; * all the metrics... Shortly, bundle a bundle.&n; */
r_static
r_int
DECL|function|__xfrm6_bundle_create
id|__xfrm6_bundle_create
c_func
(paren
r_struct
id|xfrm_policy
op_star
id|policy
comma
r_struct
id|xfrm_state
op_star
op_star
id|xfrm
comma
r_int
id|nx
comma
r_struct
id|flowi
op_star
id|fl
comma
r_struct
id|dst_entry
op_star
op_star
id|dst_p
)paren
(brace
r_struct
id|dst_entry
op_star
id|dst
comma
op_star
id|dst_prev
suffix:semicolon
r_struct
id|rt6_info
op_star
id|rt0
op_assign
(paren
r_struct
id|rt6_info
op_star
)paren
(paren
op_star
id|dst_p
)paren
suffix:semicolon
r_struct
id|rt6_info
op_star
id|rt
op_assign
id|rt0
suffix:semicolon
r_struct
id|in6_addr
op_star
id|remote
op_assign
op_amp
id|fl-&gt;fl6_dst
suffix:semicolon
r_struct
id|in6_addr
op_star
id|local
op_assign
op_amp
id|fl-&gt;fl6_src
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
r_int
id|header_len
op_assign
l_int|0
suffix:semicolon
r_int
id|trailer_len
op_assign
l_int|0
suffix:semicolon
id|dst
op_assign
id|dst_prev
op_assign
l_int|NULL
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|nx
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|dst_entry
op_star
id|dst1
op_assign
id|dst_alloc
c_func
(paren
op_amp
id|xfrm6_dst_ops
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|dst1
op_eq
l_int|NULL
)paren
)paren
(brace
id|err
op_assign
op_minus
id|ENOBUFS
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
id|dst1-&gt;xfrm
op_assign
id|xfrm
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dst
)paren
id|dst
op_assign
id|dst1
suffix:semicolon
r_else
(brace
id|dst_prev-&gt;child
op_assign
id|dst1
suffix:semicolon
id|dst1-&gt;flags
op_or_assign
id|DST_NOHASH
suffix:semicolon
id|dst_clone
c_func
(paren
id|dst1
)paren
suffix:semicolon
)brace
id|dst_prev
op_assign
id|dst1
suffix:semicolon
r_if
c_cond
(paren
id|xfrm
(braket
id|i
)braket
op_member_access_from_pointer
id|props.mode
)paren
(brace
id|remote
op_assign
(paren
r_struct
id|in6_addr
op_star
)paren
op_amp
id|xfrm
(braket
id|i
)braket
op_member_access_from_pointer
id|id.daddr
suffix:semicolon
id|local
op_assign
(paren
r_struct
id|in6_addr
op_star
)paren
op_amp
id|xfrm
(braket
id|i
)braket
op_member_access_from_pointer
id|props.saddr
suffix:semicolon
)brace
id|header_len
op_add_assign
id|xfrm
(braket
id|i
)braket
op_member_access_from_pointer
id|props.header_len
suffix:semicolon
id|trailer_len
op_add_assign
id|xfrm
(braket
id|i
)braket
op_member_access_from_pointer
id|props.trailer_len
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ipv6_addr_cmp
c_func
(paren
id|remote
comma
op_amp
id|fl-&gt;fl6_dst
)paren
)paren
(brace
r_struct
id|flowi
id|fl_tunnel
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|fl_tunnel
comma
l_int|0
comma
r_sizeof
(paren
id|fl_tunnel
)paren
)paren
suffix:semicolon
id|ipv6_addr_copy
c_func
(paren
op_amp
id|fl_tunnel.fl6_dst
comma
id|remote
)paren
suffix:semicolon
id|ipv6_addr_copy
c_func
(paren
op_amp
id|fl_tunnel.fl6_src
comma
id|local
)paren
suffix:semicolon
id|err
op_assign
id|xfrm_dst_lookup
c_func
(paren
(paren
r_struct
id|xfrm_dst
op_star
op_star
)paren
op_amp
id|rt
comma
op_amp
id|fl_tunnel
comma
id|AF_INET6
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|error
suffix:semicolon
)brace
r_else
(brace
id|dst_hold
c_func
(paren
op_amp
id|rt-&gt;u.dst
)paren
suffix:semicolon
)brace
id|dst_prev-&gt;child
op_assign
op_amp
id|rt-&gt;u.dst
suffix:semicolon
r_for
c_loop
(paren
id|dst_prev
op_assign
id|dst
suffix:semicolon
id|dst_prev
op_ne
op_amp
id|rt-&gt;u.dst
suffix:semicolon
id|dst_prev
op_assign
id|dst_prev-&gt;child
)paren
(brace
r_struct
id|xfrm_dst
op_star
id|x
op_assign
(paren
r_struct
id|xfrm_dst
op_star
)paren
id|dst_prev
suffix:semicolon
id|dst_prev-&gt;dev
op_assign
id|rt-&gt;u.dst.dev
suffix:semicolon
r_if
c_cond
(paren
id|rt-&gt;u.dst.dev
)paren
id|dev_hold
c_func
(paren
id|rt-&gt;u.dst.dev
)paren
suffix:semicolon
id|dst_prev-&gt;obsolete
op_assign
op_minus
l_int|1
suffix:semicolon
id|dst_prev-&gt;flags
op_or_assign
id|DST_HOST
suffix:semicolon
id|dst_prev-&gt;lastuse
op_assign
id|jiffies
suffix:semicolon
id|dst_prev-&gt;header_len
op_assign
id|header_len
suffix:semicolon
id|dst_prev-&gt;trailer_len
op_assign
id|trailer_len
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|dst_prev-&gt;metrics
comma
op_amp
id|rt-&gt;u.dst.metrics
comma
r_sizeof
(paren
id|dst_prev-&gt;metrics
)paren
)paren
suffix:semicolon
id|dst_prev-&gt;path
op_assign
op_amp
id|rt-&gt;u.dst
suffix:semicolon
multiline_comment|/* Copy neighbour for reachability confirmation */
id|dst_prev-&gt;neighbour
op_assign
id|neigh_clone
c_func
(paren
id|rt-&gt;u.dst.neighbour
)paren
suffix:semicolon
id|dst_prev-&gt;input
op_assign
id|rt-&gt;u.dst.input
suffix:semicolon
id|dst_prev-&gt;output
op_assign
id|dst_prev-&gt;xfrm-&gt;type-&gt;output
suffix:semicolon
multiline_comment|/* Sheit... I remember I did this right. Apparently,&n;&t;&t; * it was magically lost, so this code needs audit */
id|x-&gt;u.rt6.rt6i_flags
op_assign
id|rt0-&gt;rt6i_flags
op_amp
(paren
id|RTCF_BROADCAST
op_or
id|RTCF_MULTICAST
op_or
id|RTCF_LOCAL
)paren
suffix:semicolon
id|x-&gt;u.rt6.rt6i_metric
op_assign
id|rt0-&gt;rt6i_metric
suffix:semicolon
id|x-&gt;u.rt6.rt6i_node
op_assign
id|rt0-&gt;rt6i_node
suffix:semicolon
id|x-&gt;u.rt6.rt6i_gateway
op_assign
id|rt0-&gt;rt6i_gateway
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|x-&gt;u.rt6.rt6i_gateway
comma
op_amp
id|rt0-&gt;rt6i_gateway
comma
r_sizeof
(paren
id|x-&gt;u.rt6.rt6i_gateway
)paren
)paren
suffix:semicolon
id|x-&gt;u.rt6.rt6i_dst
op_assign
id|rt0-&gt;rt6i_dst
suffix:semicolon
id|x-&gt;u.rt6.rt6i_src
op_assign
id|rt0-&gt;rt6i_src
suffix:semicolon
id|header_len
op_sub_assign
id|x-&gt;u.dst.xfrm-&gt;props.header_len
suffix:semicolon
id|trailer_len
op_sub_assign
id|x-&gt;u.dst.xfrm-&gt;props.trailer_len
suffix:semicolon
)brace
op_star
id|dst_p
op_assign
id|dst
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|error
suffix:colon
r_if
c_cond
(paren
id|dst
)paren
id|dst_free
c_func
(paren
id|dst
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|_decode_session6
id|_decode_session6
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|flowi
op_star
id|fl
)paren
(brace
id|u16
id|offset
op_assign
r_sizeof
(paren
r_struct
id|ipv6hdr
)paren
suffix:semicolon
r_struct
id|ipv6hdr
op_star
id|hdr
op_assign
id|skb-&gt;nh.ipv6h
suffix:semicolon
r_struct
id|ipv6_opt_hdr
op_star
id|exthdr
op_assign
(paren
r_struct
id|ipv6_opt_hdr
op_star
)paren
(paren
id|skb-&gt;nh.raw
op_plus
id|offset
)paren
suffix:semicolon
id|u8
id|nexthdr
op_assign
id|skb-&gt;nh.ipv6h-&gt;nexthdr
suffix:semicolon
id|memset
c_func
(paren
id|fl
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|flowi
)paren
)paren
suffix:semicolon
id|ipv6_addr_copy
c_func
(paren
op_amp
id|fl-&gt;fl6_dst
comma
op_amp
id|hdr-&gt;daddr
)paren
suffix:semicolon
id|ipv6_addr_copy
c_func
(paren
op_amp
id|fl-&gt;fl6_src
comma
op_amp
id|hdr-&gt;saddr
)paren
suffix:semicolon
r_while
c_loop
(paren
id|pskb_may_pull
c_func
(paren
id|skb
comma
id|skb-&gt;nh.raw
op_plus
id|offset
op_plus
l_int|1
op_minus
id|skb-&gt;data
)paren
)paren
(brace
r_switch
c_cond
(paren
id|nexthdr
)paren
(brace
r_case
id|NEXTHDR_ROUTING
suffix:colon
r_case
id|NEXTHDR_HOP
suffix:colon
r_case
id|NEXTHDR_DEST
suffix:colon
id|offset
op_add_assign
id|ipv6_optlen
c_func
(paren
id|exthdr
)paren
suffix:semicolon
id|nexthdr
op_assign
id|exthdr-&gt;nexthdr
suffix:semicolon
id|exthdr
op_assign
(paren
r_struct
id|ipv6_opt_hdr
op_star
)paren
(paren
id|skb-&gt;nh.raw
op_plus
id|offset
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPPROTO_UDP
suffix:colon
r_case
id|IPPROTO_TCP
suffix:colon
r_case
id|IPPROTO_SCTP
suffix:colon
r_if
c_cond
(paren
id|pskb_may_pull
c_func
(paren
id|skb
comma
id|skb-&gt;nh.raw
op_plus
id|offset
op_plus
l_int|4
op_minus
id|skb-&gt;data
)paren
)paren
(brace
id|u16
op_star
id|ports
op_assign
(paren
id|u16
op_star
)paren
id|exthdr
suffix:semicolon
id|fl-&gt;fl_ip_sport
op_assign
id|ports
(braket
l_int|0
)braket
suffix:semicolon
id|fl-&gt;fl_ip_dport
op_assign
id|ports
(braket
l_int|1
)braket
suffix:semicolon
)brace
id|fl-&gt;proto
op_assign
id|nexthdr
suffix:semicolon
r_return
suffix:semicolon
multiline_comment|/* XXX Why are there these headers? */
r_case
id|IPPROTO_AH
suffix:colon
r_case
id|IPPROTO_ESP
suffix:colon
r_case
id|IPPROTO_COMP
suffix:colon
r_default
suffix:colon
id|fl-&gt;fl_ipsec_spi
op_assign
l_int|0
suffix:semicolon
id|fl-&gt;proto
op_assign
id|nexthdr
suffix:semicolon
r_return
suffix:semicolon
)brace
suffix:semicolon
)brace
)brace
DECL|function|xfrm6_garbage_collect
r_static
r_inline
r_int
id|xfrm6_garbage_collect
c_func
(paren
r_void
)paren
(brace
id|read_lock
c_func
(paren
op_amp
id|xfrm6_policy_afinfo.lock
)paren
suffix:semicolon
id|xfrm6_policy_afinfo
dot
id|garbage_collect
c_func
(paren
)paren
suffix:semicolon
id|read_unlock
c_func
(paren
op_amp
id|xfrm6_policy_afinfo.lock
)paren
suffix:semicolon
r_return
(paren
id|atomic_read
c_func
(paren
op_amp
id|xfrm6_dst_ops.entries
)paren
OG
id|xfrm6_dst_ops.gc_thresh
op_star
l_int|2
)paren
suffix:semicolon
)brace
DECL|function|xfrm6_update_pmtu
r_static
r_void
id|xfrm6_update_pmtu
c_func
(paren
r_struct
id|dst_entry
op_star
id|dst
comma
id|u32
id|mtu
)paren
(brace
r_struct
id|dst_entry
op_star
id|path
op_assign
id|dst-&gt;path
suffix:semicolon
r_if
c_cond
(paren
id|mtu
op_ge
id|IPV6_MIN_MTU
op_logical_and
id|mtu
OL
id|dst_pmtu
c_func
(paren
id|dst
)paren
)paren
id|path-&gt;ops
op_member_access_from_pointer
id|update_pmtu
c_func
(paren
id|path
comma
id|mtu
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|variable|xfrm6_dst_ops
r_struct
id|dst_ops
id|xfrm6_dst_ops
op_assign
(brace
dot
id|family
op_assign
id|AF_INET6
comma
dot
id|protocol
op_assign
id|__constant_htons
c_func
(paren
id|ETH_P_IPV6
)paren
comma
dot
id|gc
op_assign
id|xfrm6_garbage_collect
comma
dot
id|update_pmtu
op_assign
id|xfrm6_update_pmtu
comma
dot
id|gc_thresh
op_assign
l_int|1024
comma
dot
id|entry_size
op_assign
r_sizeof
(paren
r_struct
id|xfrm_dst
)paren
comma
)brace
suffix:semicolon
DECL|variable|xfrm6_policy_afinfo
r_struct
id|xfrm_policy_afinfo
id|xfrm6_policy_afinfo
op_assign
(brace
dot
id|family
op_assign
id|AF_INET6
comma
dot
id|lock
op_assign
id|RW_LOCK_UNLOCKED
comma
dot
id|type_map
op_assign
op_amp
id|xfrm6_type_map
comma
dot
id|dst_ops
op_assign
op_amp
id|xfrm6_dst_ops
comma
dot
id|dst_lookup
op_assign
id|xfrm6_dst_lookup
comma
dot
id|find_bundle
op_assign
id|__xfrm6_find_bundle
comma
dot
id|bundle_create
op_assign
id|__xfrm6_bundle_create
comma
dot
id|decode_session
op_assign
id|_decode_session6
comma
)brace
suffix:semicolon
DECL|function|xfrm6_policy_init
r_void
id|__init
id|xfrm6_policy_init
c_func
(paren
r_void
)paren
(brace
id|xfrm_policy_register_afinfo
c_func
(paren
op_amp
id|xfrm6_policy_afinfo
)paren
suffix:semicolon
)brace
DECL|function|xfrm6_policy_fini
r_void
id|__exit
id|xfrm6_policy_fini
c_func
(paren
r_void
)paren
(brace
id|xfrm_policy_unregister_afinfo
c_func
(paren
op_amp
id|xfrm6_policy_afinfo
)paren
suffix:semicolon
)brace
DECL|function|xfrm6_init
r_void
id|__init
id|xfrm6_init
c_func
(paren
r_void
)paren
(brace
id|xfrm6_policy_init
c_func
(paren
)paren
suffix:semicolon
id|xfrm6_state_init
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|xfrm6_fini
r_void
id|__exit
id|xfrm6_fini
c_func
(paren
r_void
)paren
(brace
singleline_comment|//xfrm6_input_fini();
id|xfrm6_policy_fini
c_func
(paren
)paren
suffix:semicolon
id|xfrm6_state_fini
c_func
(paren
)paren
suffix:semicolon
)brace
eof
