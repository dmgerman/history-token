multiline_comment|/*&n; * This is a module which is used for queueing IPv6 packets and&n; * communicating with userspace via netlink.&n; *&n; * (C) 2001 Fernando Anton, this code is GPL.&n; *     IPv64 Project - Work based in IPv64 draft by Arturo Azcorra.&n; *     Universidad Carlos III de Madrid - Leganes (Madrid) - Spain&n; *     Universidad Politecnica de Alcala de Henares - Alcala de H. (Madrid) - Spain&n; *     email: fanton@it.uc3m.es&n; *&n; * 2001-11-06: First try. Working with ip_queue.c for IPv4 and trying&n; *             to adapt it to IPv6&n; *             HEAVILY based in ipqueue.c by James Morris. It&squot;s just&n; *             a little modified version of it, so he&squot;s nearly the&n; *             real coder of this.&n; *             Few changes needed, mainly the hard_routing code and&n; *             the netlink socket protocol (we&squot;re NETLINK_IP6_FW).&n; *&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/ipv6.h&gt;
macro_line|#include &lt;linux/notifier.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/netfilter.h&gt;
macro_line|#include &lt;linux/netlink.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/rtnetlink.h&gt;
macro_line|#include &lt;linux/sysctl.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;net/sock.h&gt;
macro_line|#include &lt;net/ipv6.h&gt;
macro_line|#include &lt;net/ip6_route.h&gt;
multiline_comment|/* We&squot;re still usign the following structs. No need to change them: */
multiline_comment|/*   ipq_packet_msg                                                 */
multiline_comment|/*   ipq_mode_msg                                                   */
multiline_comment|/*   ipq_verdict_msg                                                */
multiline_comment|/*   ipq_peer_msg                                                   */
macro_line|#include &lt;linux/netfilter_ipv4/ip_queue.h&gt;
macro_line|#include &lt;linux/netfilter_ipv4/ip_tables.h&gt;
macro_line|#include &lt;linux/netfilter_ipv6/ip6_tables.h&gt;
DECL|macro|IPQ_QMAX_DEFAULT
mdefine_line|#define IPQ_QMAX_DEFAULT 1024
DECL|macro|IPQ_PROC_FS_NAME
mdefine_line|#define IPQ_PROC_FS_NAME &quot;ip6_queue&quot;
DECL|macro|NET_IPQ_QMAX
mdefine_line|#define NET_IPQ_QMAX 2088
DECL|macro|NET_IPQ_QMAX_NAME
mdefine_line|#define NET_IPQ_QMAX_NAME &quot;ip6_queue_maxlen&quot;
DECL|struct|ip6q_rt_info
r_typedef
r_struct
id|ip6q_rt_info
(brace
DECL|member|daddr
r_struct
id|in6_addr
id|daddr
suffix:semicolon
DECL|member|saddr
r_struct
id|in6_addr
id|saddr
suffix:semicolon
DECL|typedef|ip6q_rt_info_t
)brace
id|ip6q_rt_info_t
suffix:semicolon
DECL|struct|ip6q_queue_element
r_typedef
r_struct
id|ip6q_queue_element
(brace
DECL|member|list
r_struct
id|list_head
id|list
suffix:semicolon
multiline_comment|/* Links element into queue */
DECL|member|verdict
r_int
id|verdict
suffix:semicolon
multiline_comment|/* Current verdict */
DECL|member|info
r_struct
id|nf_info
op_star
id|info
suffix:semicolon
multiline_comment|/* Extra info from netfilter */
DECL|member|skb
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
multiline_comment|/* Packet inside */
DECL|member|rt_info
id|ip6q_rt_info_t
id|rt_info
suffix:semicolon
multiline_comment|/* May need post-mangle routing */
DECL|typedef|ip6q_queue_element_t
)brace
id|ip6q_queue_element_t
suffix:semicolon
DECL|typedef|ip6q_send_cb_t
r_typedef
r_int
(paren
op_star
id|ip6q_send_cb_t
)paren
(paren
id|ip6q_queue_element_t
op_star
id|e
)paren
suffix:semicolon
DECL|struct|ip6q_peer
r_typedef
r_struct
id|ip6q_peer
(brace
DECL|member|pid
id|pid_t
id|pid
suffix:semicolon
multiline_comment|/* PID of userland peer */
DECL|member|died
r_int
r_char
id|died
suffix:semicolon
multiline_comment|/* We think the peer died */
DECL|member|copy_mode
r_int
r_char
id|copy_mode
suffix:semicolon
multiline_comment|/* Copy packet as well as metadata? */
DECL|member|copy_range
r_int
id|copy_range
suffix:semicolon
multiline_comment|/* Range past metadata to copy */
DECL|member|send
id|ip6q_send_cb_t
id|send
suffix:semicolon
multiline_comment|/* Callback for sending data to peer */
DECL|typedef|ip6q_peer_t
)brace
id|ip6q_peer_t
suffix:semicolon
DECL|struct|ip6q_queue
r_typedef
r_struct
id|ip6q_queue
(brace
DECL|member|len
r_int
id|len
suffix:semicolon
multiline_comment|/* Current queue len */
DECL|member|maxlen
r_int
op_star
id|maxlen
suffix:semicolon
multiline_comment|/* Maximum queue len, via sysctl */
DECL|member|flushing
r_int
r_char
id|flushing
suffix:semicolon
multiline_comment|/* If queue is being flushed */
DECL|member|terminate
r_int
r_char
id|terminate
suffix:semicolon
multiline_comment|/* If the queue is being terminated */
DECL|member|list
r_struct
id|list_head
id|list
suffix:semicolon
multiline_comment|/* Head of packet queue */
DECL|member|lock
id|spinlock_t
id|lock
suffix:semicolon
multiline_comment|/* Queue spinlock */
DECL|member|peer
id|ip6q_peer_t
id|peer
suffix:semicolon
multiline_comment|/* Userland peer */
DECL|typedef|ip6q_queue_t
)brace
id|ip6q_queue_t
suffix:semicolon
multiline_comment|/****************************************************************************&n; *&n; * Packet queue&n; *&n; ****************************************************************************/
multiline_comment|/* Dequeue a packet if matched by cmp, or the next available if cmp is NULL */
r_static
id|ip6q_queue_element_t
op_star
DECL|function|ip6q_dequeue
id|ip6q_dequeue
c_func
(paren
id|ip6q_queue_t
op_star
id|q
comma
r_int
(paren
op_star
id|cmp
)paren
(paren
id|ip6q_queue_element_t
op_star
comma
r_int
r_int
)paren
comma
r_int
r_int
id|data
)paren
(brace
r_struct
id|list_head
op_star
id|i
suffix:semicolon
id|spin_lock_bh
c_func
(paren
op_amp
id|q-&gt;lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|q-&gt;list.prev
suffix:semicolon
id|i
op_ne
op_amp
id|q-&gt;list
suffix:semicolon
id|i
op_assign
id|i-&gt;prev
)paren
(brace
id|ip6q_queue_element_t
op_star
id|e
op_assign
(paren
id|ip6q_queue_element_t
op_star
)paren
id|i
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cmp
op_logical_or
id|cmp
c_func
(paren
id|e
comma
id|data
)paren
)paren
(brace
id|list_del
c_func
(paren
op_amp
id|e-&gt;list
)paren
suffix:semicolon
id|q-&gt;len
op_decrement
suffix:semicolon
id|spin_unlock_bh
c_func
(paren
op_amp
id|q-&gt;lock
)paren
suffix:semicolon
r_return
id|e
suffix:semicolon
)brace
)brace
id|spin_unlock_bh
c_func
(paren
op_amp
id|q-&gt;lock
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* Flush all packets */
DECL|function|ip6q_flush
r_static
r_void
id|ip6q_flush
c_func
(paren
id|ip6q_queue_t
op_star
id|q
)paren
(brace
id|ip6q_queue_element_t
op_star
id|e
suffix:semicolon
id|spin_lock_bh
c_func
(paren
op_amp
id|q-&gt;lock
)paren
suffix:semicolon
id|q-&gt;flushing
op_assign
l_int|1
suffix:semicolon
id|spin_unlock_bh
c_func
(paren
op_amp
id|q-&gt;lock
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|e
op_assign
id|ip6q_dequeue
c_func
(paren
id|q
comma
l_int|NULL
comma
l_int|0
)paren
)paren
)paren
(brace
id|e-&gt;verdict
op_assign
id|NF_DROP
suffix:semicolon
id|nf_reinject
c_func
(paren
id|e-&gt;skb
comma
id|e-&gt;info
comma
id|e-&gt;verdict
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|e
)paren
suffix:semicolon
)brace
id|spin_lock_bh
c_func
(paren
op_amp
id|q-&gt;lock
)paren
suffix:semicolon
id|q-&gt;flushing
op_assign
l_int|0
suffix:semicolon
id|spin_unlock_bh
c_func
(paren
op_amp
id|q-&gt;lock
)paren
suffix:semicolon
)brace
DECL|function|ip6q_create_queue
r_static
id|ip6q_queue_t
op_star
id|ip6q_create_queue
c_func
(paren
id|nf_queue_outfn_t
id|outfn
comma
id|ip6q_send_cb_t
id|send_cb
comma
r_int
op_star
id|errp
comma
r_int
op_star
id|sysctl_qmax
)paren
(brace
r_int
id|status
suffix:semicolon
id|ip6q_queue_t
op_star
id|q
suffix:semicolon
op_star
id|errp
op_assign
l_int|0
suffix:semicolon
id|q
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|ip6q_queue_t
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|q
op_eq
l_int|NULL
)paren
(brace
op_star
id|errp
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|q-&gt;peer.pid
op_assign
l_int|0
suffix:semicolon
id|q-&gt;peer.died
op_assign
l_int|0
suffix:semicolon
id|q-&gt;peer.copy_mode
op_assign
id|IPQ_COPY_NONE
suffix:semicolon
id|q-&gt;peer.copy_range
op_assign
l_int|0
suffix:semicolon
id|q-&gt;peer.send
op_assign
id|send_cb
suffix:semicolon
id|q-&gt;len
op_assign
l_int|0
suffix:semicolon
id|q-&gt;maxlen
op_assign
id|sysctl_qmax
suffix:semicolon
id|q-&gt;flushing
op_assign
l_int|0
suffix:semicolon
id|q-&gt;terminate
op_assign
l_int|0
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|q-&gt;list
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|q-&gt;lock
)paren
suffix:semicolon
id|status
op_assign
id|nf_register_queue_handler
c_func
(paren
id|PF_INET6
comma
id|outfn
comma
id|q
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
OL
l_int|0
)paren
(brace
op_star
id|errp
op_assign
op_minus
id|EBUSY
suffix:semicolon
id|kfree
c_func
(paren
id|q
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_return
id|q
suffix:semicolon
)brace
DECL|function|ip6q_enqueue
r_static
r_int
id|ip6q_enqueue
c_func
(paren
id|ip6q_queue_t
op_star
id|q
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|nf_info
op_star
id|info
)paren
(brace
id|ip6q_queue_element_t
op_star
id|e
suffix:semicolon
r_int
id|status
suffix:semicolon
id|e
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|e
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|e
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ip6_queue: OOM in enqueue&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|e-&gt;verdict
op_assign
id|NF_DROP
suffix:semicolon
id|e-&gt;info
op_assign
id|info
suffix:semicolon
id|e-&gt;skb
op_assign
id|skb
suffix:semicolon
r_if
c_cond
(paren
id|e-&gt;info-&gt;hook
op_eq
id|NF_IP_LOCAL_OUT
)paren
(brace
r_struct
id|ipv6hdr
op_star
id|iph
op_assign
id|skb-&gt;nh.ipv6h
suffix:semicolon
id|e-&gt;rt_info.daddr
op_assign
id|iph-&gt;daddr
suffix:semicolon
id|e-&gt;rt_info.saddr
op_assign
id|iph-&gt;saddr
suffix:semicolon
)brace
id|spin_lock_bh
c_func
(paren
op_amp
id|q-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|q-&gt;len
op_ge
op_star
id|q-&gt;maxlen
)paren
(brace
id|spin_unlock_bh
c_func
(paren
op_amp
id|q-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|net_ratelimit
c_func
(paren
)paren
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;ip6_queue: full at %d entries, &quot;
l_string|&quot;dropping packet(s).&bslash;n&quot;
comma
id|q-&gt;len
)paren
suffix:semicolon
r_goto
id|free_drop
suffix:semicolon
)brace
r_if
c_cond
(paren
id|q-&gt;flushing
op_logical_or
id|q-&gt;peer.copy_mode
op_eq
id|IPQ_COPY_NONE
op_logical_or
id|q-&gt;peer.pid
op_eq
l_int|0
op_logical_or
id|q-&gt;peer.died
op_logical_or
id|q-&gt;terminate
)paren
(brace
id|spin_unlock_bh
c_func
(paren
op_amp
id|q-&gt;lock
)paren
suffix:semicolon
r_goto
id|free_drop
suffix:semicolon
)brace
id|status
op_assign
id|q-&gt;peer
dot
id|send
c_func
(paren
id|e
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
OG
l_int|0
)paren
(brace
id|list_add
c_func
(paren
op_amp
id|e-&gt;list
comma
op_amp
id|q-&gt;list
)paren
suffix:semicolon
id|q-&gt;len
op_increment
suffix:semicolon
id|spin_unlock_bh
c_func
(paren
op_amp
id|q-&gt;lock
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
id|spin_unlock_bh
c_func
(paren
op_amp
id|q-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_eq
op_minus
id|ECONNREFUSED
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;ip6_queue: peer %d died, &quot;
l_string|&quot;resetting state and flushing queue&bslash;n&quot;
comma
id|q-&gt;peer.pid
)paren
suffix:semicolon
id|q-&gt;peer.died
op_assign
l_int|1
suffix:semicolon
id|q-&gt;peer.pid
op_assign
l_int|0
suffix:semicolon
id|q-&gt;peer.copy_mode
op_assign
id|IPQ_COPY_NONE
suffix:semicolon
id|q-&gt;peer.copy_range
op_assign
l_int|0
suffix:semicolon
id|ip6q_flush
c_func
(paren
id|q
)paren
suffix:semicolon
)brace
id|free_drop
suffix:colon
id|kfree
c_func
(paren
id|e
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
DECL|function|ip6q_destroy_queue
r_static
r_void
id|ip6q_destroy_queue
c_func
(paren
id|ip6q_queue_t
op_star
id|q
)paren
(brace
id|nf_unregister_queue_handler
c_func
(paren
id|PF_INET6
)paren
suffix:semicolon
id|spin_lock_bh
c_func
(paren
op_amp
id|q-&gt;lock
)paren
suffix:semicolon
id|q-&gt;terminate
op_assign
l_int|1
suffix:semicolon
id|spin_unlock_bh
c_func
(paren
op_amp
id|q-&gt;lock
)paren
suffix:semicolon
id|ip6q_flush
c_func
(paren
id|q
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|q
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Taken from net/ipv6/ip6_output.c&n; *&n; * We should use the one there, but is defined static&n; * so we put this just here and let the things as&n; * they are now.&n; *&n; * If that one is modified, this one should be modified too.&n; */
DECL|function|route6_me_harder
r_static
r_int
id|route6_me_harder
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|ipv6hdr
op_star
id|iph
op_assign
id|skb-&gt;nh.ipv6h
suffix:semicolon
r_struct
id|dst_entry
op_star
id|dst
suffix:semicolon
r_struct
id|flowi
id|fl
suffix:semicolon
id|fl.proto
op_assign
id|iph-&gt;nexthdr
suffix:semicolon
id|fl.fl6_dst
op_assign
op_amp
id|iph-&gt;daddr
suffix:semicolon
id|fl.fl6_src
op_assign
op_amp
id|iph-&gt;saddr
suffix:semicolon
id|fl.oif
op_assign
id|skb-&gt;sk
ques
c_cond
id|skb-&gt;sk-&gt;bound_dev_if
suffix:colon
l_int|0
suffix:semicolon
id|fl.fl6_flowlabel
op_assign
l_int|0
suffix:semicolon
id|fl.uli_u.ports.dport
op_assign
l_int|0
suffix:semicolon
id|fl.uli_u.ports.sport
op_assign
l_int|0
suffix:semicolon
id|dst
op_assign
id|ip6_route_output
c_func
(paren
id|skb-&gt;sk
comma
op_amp
id|fl
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dst-&gt;error
)paren
(brace
r_if
c_cond
(paren
id|net_ratelimit
c_func
(paren
)paren
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;route6_me_harder: No more route.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* Drop old route. */
id|dst_release
c_func
(paren
id|skb-&gt;dst
)paren
suffix:semicolon
id|skb-&gt;dst
op_assign
id|dst
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ip6q_mangle_ipv6
r_static
r_int
id|ip6q_mangle_ipv6
c_func
(paren
id|ipq_verdict_msg_t
op_star
id|v
comma
id|ip6q_queue_element_t
op_star
id|e
)paren
(brace
r_int
id|diff
suffix:semicolon
r_struct
id|ipv6hdr
op_star
id|user_iph
op_assign
(paren
r_struct
id|ipv6hdr
op_star
)paren
id|v-&gt;payload
suffix:semicolon
r_if
c_cond
(paren
id|v-&gt;data_len
OL
r_sizeof
(paren
op_star
id|user_iph
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|diff
op_assign
id|v-&gt;data_len
op_minus
id|e-&gt;skb-&gt;len
suffix:semicolon
r_if
c_cond
(paren
id|diff
OL
l_int|0
)paren
id|skb_trim
c_func
(paren
id|e-&gt;skb
comma
id|v-&gt;data_len
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|diff
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|v-&gt;data_len
OG
l_int|0xFFFF
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|diff
OG
id|skb_tailroom
c_func
(paren
id|e-&gt;skb
)paren
)paren
(brace
r_struct
id|sk_buff
op_star
id|newskb
suffix:semicolon
id|newskb
op_assign
id|skb_copy_expand
c_func
(paren
id|e-&gt;skb
comma
id|skb_headroom
c_func
(paren
id|e-&gt;skb
)paren
comma
id|diff
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|newskb
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;ip6_queue: OOM &quot;
l_string|&quot;in mangle, dropping packet&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_if
c_cond
(paren
id|e-&gt;skb-&gt;sk
)paren
id|skb_set_owner_w
c_func
(paren
id|newskb
comma
id|e-&gt;skb-&gt;sk
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|e-&gt;skb
)paren
suffix:semicolon
id|e-&gt;skb
op_assign
id|newskb
suffix:semicolon
)brace
id|skb_put
c_func
(paren
id|e-&gt;skb
comma
id|diff
)paren
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|e-&gt;skb-&gt;data
comma
id|v-&gt;payload
comma
id|v-&gt;data_len
)paren
suffix:semicolon
id|e-&gt;skb-&gt;nfcache
op_or_assign
id|NFC_ALTERED
suffix:semicolon
multiline_comment|/*&n;&t; * Extra routing may needed on local out, as the QUEUE target never&n;&t; * returns control to the table.&n;         * Not a nice way to cmp, but works&n;&t; */
r_if
c_cond
(paren
id|e-&gt;info-&gt;hook
op_eq
id|NF_IP_LOCAL_OUT
)paren
(brace
r_struct
id|ipv6hdr
op_star
id|iph
op_assign
id|e-&gt;skb-&gt;nh.ipv6h
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|iph-&gt;daddr.in6_u.u6_addr32
(braket
l_int|0
)braket
op_eq
id|e-&gt;rt_info.daddr.in6_u.u6_addr32
(braket
l_int|0
)braket
op_logical_and
id|iph-&gt;daddr.in6_u.u6_addr32
(braket
l_int|1
)braket
op_eq
id|e-&gt;rt_info.daddr.in6_u.u6_addr32
(braket
l_int|1
)braket
op_logical_and
id|iph-&gt;daddr.in6_u.u6_addr32
(braket
l_int|2
)braket
op_eq
id|e-&gt;rt_info.daddr.in6_u.u6_addr32
(braket
l_int|2
)braket
op_logical_and
id|iph-&gt;daddr.in6_u.u6_addr32
(braket
l_int|3
)braket
op_eq
id|e-&gt;rt_info.daddr.in6_u.u6_addr32
(braket
l_int|3
)braket
op_logical_and
id|iph-&gt;saddr.in6_u.u6_addr32
(braket
l_int|0
)braket
op_eq
id|e-&gt;rt_info.saddr.in6_u.u6_addr32
(braket
l_int|0
)braket
op_logical_and
id|iph-&gt;saddr.in6_u.u6_addr32
(braket
l_int|1
)braket
op_eq
id|e-&gt;rt_info.saddr.in6_u.u6_addr32
(braket
l_int|1
)braket
op_logical_and
id|iph-&gt;saddr.in6_u.u6_addr32
(braket
l_int|2
)braket
op_eq
id|e-&gt;rt_info.saddr.in6_u.u6_addr32
(braket
l_int|2
)braket
op_logical_and
id|iph-&gt;saddr.in6_u.u6_addr32
(braket
l_int|3
)braket
op_eq
id|e-&gt;rt_info.saddr.in6_u.u6_addr32
(braket
l_int|3
)braket
)paren
)paren
r_return
id|route6_me_harder
c_func
(paren
id|e-&gt;skb
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|id_cmp
r_static
r_inline
r_int
id|id_cmp
c_func
(paren
id|ip6q_queue_element_t
op_star
id|e
comma
r_int
r_int
id|id
)paren
(brace
r_return
(paren
id|id
op_eq
(paren
r_int
r_int
)paren
id|e
)paren
suffix:semicolon
)brace
DECL|function|ip6q_set_verdict
r_static
r_int
id|ip6q_set_verdict
c_func
(paren
id|ip6q_queue_t
op_star
id|q
comma
id|ipq_verdict_msg_t
op_star
id|v
comma
r_int
r_int
id|len
)paren
(brace
id|ip6q_queue_element_t
op_star
id|e
suffix:semicolon
r_if
c_cond
(paren
id|v-&gt;value
OG
id|NF_MAX_VERDICT
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|e
op_assign
id|ip6q_dequeue
c_func
(paren
id|q
comma
id|id_cmp
comma
id|v-&gt;id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|e
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOENT
suffix:semicolon
r_else
(brace
id|e-&gt;verdict
op_assign
id|v-&gt;value
suffix:semicolon
r_if
c_cond
(paren
id|v-&gt;data_len
op_logical_and
id|v-&gt;data_len
op_eq
id|len
)paren
r_if
c_cond
(paren
id|ip6q_mangle_ipv6
c_func
(paren
id|v
comma
id|e
)paren
OL
l_int|0
)paren
id|e-&gt;verdict
op_assign
id|NF_DROP
suffix:semicolon
id|nf_reinject
c_func
(paren
id|e-&gt;skb
comma
id|e-&gt;info
comma
id|e-&gt;verdict
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|e
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
DECL|function|ip6q_receive_peer
r_static
r_int
id|ip6q_receive_peer
c_func
(paren
id|ip6q_queue_t
op_star
id|q
comma
id|ipq_peer_msg_t
op_star
id|m
comma
r_int
r_char
id|type
comma
r_int
r_int
id|len
)paren
(brace
r_int
id|status
op_assign
l_int|0
suffix:semicolon
r_int
id|busy
suffix:semicolon
id|spin_lock_bh
c_func
(paren
op_amp
id|q-&gt;lock
)paren
suffix:semicolon
id|busy
op_assign
(paren
id|q-&gt;terminate
op_logical_or
id|q-&gt;flushing
)paren
suffix:semicolon
id|spin_unlock_bh
c_func
(paren
op_amp
id|q-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|busy
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
r_sizeof
(paren
id|ipq_peer_msg_t
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_switch
c_cond
(paren
id|type
)paren
(brace
r_case
id|IPQM_MODE
suffix:colon
r_switch
c_cond
(paren
id|m-&gt;msg.mode.value
)paren
(brace
r_case
id|IPQ_COPY_META
suffix:colon
id|q-&gt;peer.copy_mode
op_assign
id|IPQ_COPY_META
suffix:semicolon
id|q-&gt;peer.copy_range
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPQ_COPY_PACKET
suffix:colon
id|q-&gt;peer.copy_mode
op_assign
id|IPQ_COPY_PACKET
suffix:semicolon
id|q-&gt;peer.copy_range
op_assign
id|m-&gt;msg.mode.range
suffix:semicolon
r_if
c_cond
(paren
id|q-&gt;peer.copy_range
OG
l_int|0xFFFF
)paren
id|q-&gt;peer.copy_range
op_assign
l_int|0xFFFF
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|status
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|IPQM_VERDICT
suffix:colon
r_if
c_cond
(paren
id|m-&gt;msg.verdict.value
OG
id|NF_MAX_VERDICT
)paren
id|status
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_else
id|status
op_assign
id|ip6q_set_verdict
c_func
(paren
id|q
comma
op_amp
id|m-&gt;msg.verdict
comma
id|len
op_minus
r_sizeof
(paren
op_star
id|m
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|status
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
id|status
suffix:semicolon
)brace
DECL|function|dev_cmp
r_static
r_inline
r_int
id|dev_cmp
c_func
(paren
id|ip6q_queue_element_t
op_star
id|e
comma
r_int
r_int
id|ifindex
)paren
(brace
r_if
c_cond
(paren
id|e-&gt;info-&gt;indev
)paren
r_if
c_cond
(paren
id|e-&gt;info-&gt;indev-&gt;ifindex
op_eq
id|ifindex
)paren
r_return
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|e-&gt;info-&gt;outdev
)paren
r_if
c_cond
(paren
id|e-&gt;info-&gt;outdev-&gt;ifindex
op_eq
id|ifindex
)paren
r_return
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Drop any queued packets associated with device ifindex */
DECL|function|ip6q_dev_drop
r_static
r_void
id|ip6q_dev_drop
c_func
(paren
id|ip6q_queue_t
op_star
id|q
comma
r_int
id|ifindex
)paren
(brace
id|ip6q_queue_element_t
op_star
id|e
suffix:semicolon
r_while
c_loop
(paren
(paren
id|e
op_assign
id|ip6q_dequeue
c_func
(paren
id|q
comma
id|dev_cmp
comma
id|ifindex
)paren
)paren
)paren
(brace
id|e-&gt;verdict
op_assign
id|NF_DROP
suffix:semicolon
id|nf_reinject
c_func
(paren
id|e-&gt;skb
comma
id|e-&gt;info
comma
id|e-&gt;verdict
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|e
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/****************************************************************************&n; *&n; * Netfilter interface&n; *&n; ****************************************************************************/
multiline_comment|/*&n; * Packets arrive here from netfilter for queuing to userspace.&n; * All of them must be fed back via nf_reinject() or Alexey will kill Rusty.&n; */
DECL|function|netfilter6_receive
r_static
r_int
id|netfilter6_receive
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|nf_info
op_star
id|info
comma
r_void
op_star
id|data
)paren
(brace
r_return
id|ip6q_enqueue
c_func
(paren
(paren
id|ip6q_queue_t
op_star
)paren
id|data
comma
id|skb
comma
id|info
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *&n; * Netlink interface.&n; *&n; ****************************************************************************/
DECL|variable|nfnl
r_static
r_struct
id|sock
op_star
id|nfnl
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* This is not a static one, so we should not repeat its name */
DECL|variable|nlq6
id|ip6q_queue_t
op_star
id|nlq6
op_assign
l_int|NULL
suffix:semicolon
DECL|function|netlink_build_message
r_static
r_struct
id|sk_buff
op_star
id|netlink_build_message
c_func
(paren
id|ip6q_queue_element_t
op_star
id|e
comma
r_int
op_star
id|errp
)paren
(brace
r_int
r_char
op_star
id|old_tail
suffix:semicolon
r_int
id|size
op_assign
l_int|0
suffix:semicolon
r_int
id|data_len
op_assign
l_int|0
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|ipq_packet_msg_t
op_star
id|pm
suffix:semicolon
r_struct
id|nlmsghdr
op_star
id|nlh
suffix:semicolon
r_switch
c_cond
(paren
id|nlq6-&gt;peer.copy_mode
)paren
(brace
r_int
id|copy_range
suffix:semicolon
r_case
id|IPQ_COPY_META
suffix:colon
id|size
op_assign
id|NLMSG_SPACE
c_func
(paren
r_sizeof
(paren
op_star
id|pm
)paren
)paren
suffix:semicolon
id|data_len
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPQ_COPY_PACKET
suffix:colon
id|copy_range
op_assign
id|nlq6-&gt;peer.copy_range
suffix:semicolon
r_if
c_cond
(paren
id|copy_range
op_eq
l_int|0
op_logical_or
id|copy_range
OG
id|e-&gt;skb-&gt;len
)paren
id|data_len
op_assign
id|e-&gt;skb-&gt;len
suffix:semicolon
r_else
id|data_len
op_assign
id|copy_range
suffix:semicolon
id|size
op_assign
id|NLMSG_SPACE
c_func
(paren
r_sizeof
(paren
op_star
id|pm
)paren
op_plus
id|data_len
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPQ_COPY_NONE
suffix:colon
r_default
suffix:colon
op_star
id|errp
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|skb
op_assign
id|alloc_skb
c_func
(paren
id|size
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
r_goto
id|nlmsg_failure
suffix:semicolon
id|old_tail
op_assign
id|skb-&gt;tail
suffix:semicolon
id|nlh
op_assign
id|NLMSG_PUT
c_func
(paren
id|skb
comma
l_int|0
comma
l_int|0
comma
id|IPQM_PACKET
comma
id|size
op_minus
r_sizeof
(paren
op_star
id|nlh
)paren
)paren
suffix:semicolon
id|pm
op_assign
id|NLMSG_DATA
c_func
(paren
id|nlh
)paren
suffix:semicolon
id|memset
c_func
(paren
id|pm
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|pm
)paren
)paren
suffix:semicolon
id|pm-&gt;packet_id
op_assign
(paren
r_int
r_int
)paren
id|e
suffix:semicolon
id|pm-&gt;data_len
op_assign
id|data_len
suffix:semicolon
id|pm-&gt;timestamp_sec
op_assign
id|e-&gt;skb-&gt;stamp.tv_sec
suffix:semicolon
id|pm-&gt;timestamp_usec
op_assign
id|e-&gt;skb-&gt;stamp.tv_usec
suffix:semicolon
id|pm-&gt;mark
op_assign
id|e-&gt;skb-&gt;nfmark
suffix:semicolon
id|pm-&gt;hook
op_assign
id|e-&gt;info-&gt;hook
suffix:semicolon
r_if
c_cond
(paren
id|e-&gt;info-&gt;indev
)paren
id|strcpy
c_func
(paren
id|pm-&gt;indev_name
comma
id|e-&gt;info-&gt;indev-&gt;name
)paren
suffix:semicolon
r_else
id|pm-&gt;indev_name
(braket
l_int|0
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_if
c_cond
(paren
id|e-&gt;info-&gt;outdev
)paren
id|strcpy
c_func
(paren
id|pm-&gt;outdev_name
comma
id|e-&gt;info-&gt;outdev-&gt;name
)paren
suffix:semicolon
r_else
id|pm-&gt;outdev_name
(braket
l_int|0
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|pm-&gt;hw_protocol
op_assign
id|e-&gt;skb-&gt;protocol
suffix:semicolon
r_if
c_cond
(paren
id|e-&gt;info-&gt;indev
op_logical_and
id|e-&gt;skb-&gt;dev
)paren
(brace
id|pm-&gt;hw_type
op_assign
id|e-&gt;skb-&gt;dev-&gt;type
suffix:semicolon
r_if
c_cond
(paren
id|e-&gt;skb-&gt;dev-&gt;hard_header_parse
)paren
id|pm-&gt;hw_addrlen
op_assign
id|e-&gt;skb-&gt;dev
op_member_access_from_pointer
id|hard_header_parse
c_func
(paren
id|e-&gt;skb
comma
id|pm-&gt;hw_addr
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|data_len
)paren
id|memcpy
c_func
(paren
id|pm-&gt;payload
comma
id|e-&gt;skb-&gt;data
comma
id|data_len
)paren
suffix:semicolon
id|nlh-&gt;nlmsg_len
op_assign
id|skb-&gt;tail
op_minus
id|old_tail
suffix:semicolon
id|NETLINK_CB
c_func
(paren
id|skb
)paren
dot
id|dst_groups
op_assign
l_int|0
suffix:semicolon
r_return
id|skb
suffix:semicolon
id|nlmsg_failure
suffix:colon
r_if
c_cond
(paren
id|skb
)paren
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
op_star
id|errp
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ip6_queue: error creating netlink message&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|netlink_send_peer
r_static
r_int
id|netlink_send_peer
c_func
(paren
id|ip6q_queue_element_t
op_star
id|e
)paren
(brace
r_int
id|status
op_assign
l_int|0
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|skb
op_assign
id|netlink_build_message
c_func
(paren
id|e
comma
op_amp
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
r_return
id|status
suffix:semicolon
r_return
id|netlink_unicast
c_func
(paren
id|nfnl
comma
id|skb
comma
id|nlq6-&gt;peer.pid
comma
id|MSG_DONTWAIT
)paren
suffix:semicolon
)brace
DECL|macro|RCV_SKB_FAIL
mdefine_line|#define RCV_SKB_FAIL(err) do { netlink_ack(skb, nlh, (err)); return; } while (0);
DECL|function|netlink_receive_user_skb
r_static
id|__inline__
r_void
id|netlink_receive_user_skb
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_int
id|status
comma
id|type
suffix:semicolon
r_struct
id|nlmsghdr
op_star
id|nlh
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;len
OL
r_sizeof
(paren
r_struct
id|nlmsghdr
)paren
)paren
r_return
suffix:semicolon
id|nlh
op_assign
(paren
r_struct
id|nlmsghdr
op_star
)paren
id|skb-&gt;data
suffix:semicolon
r_if
c_cond
(paren
id|nlh-&gt;nlmsg_len
OL
r_sizeof
(paren
r_struct
id|nlmsghdr
)paren
op_logical_or
id|skb-&gt;len
OL
id|nlh-&gt;nlmsg_len
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|nlh-&gt;nlmsg_pid
op_le
l_int|0
op_logical_or
op_logical_neg
(paren
id|nlh-&gt;nlmsg_flags
op_amp
id|NLM_F_REQUEST
)paren
op_logical_or
id|nlh-&gt;nlmsg_flags
op_amp
id|NLM_F_MULTI
)paren
(brace
id|RCV_SKB_FAIL
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|nlh-&gt;nlmsg_flags
op_amp
id|MSG_TRUNC
)paren
id|RCV_SKB_FAIL
c_func
(paren
op_minus
id|ECOMM
)paren
suffix:semicolon
id|type
op_assign
id|nlh-&gt;nlmsg_type
suffix:semicolon
r_if
c_cond
(paren
id|type
OL
id|NLMSG_NOOP
op_logical_or
id|type
op_ge
id|IPQM_MAX
)paren
id|RCV_SKB_FAIL
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|type
op_le
id|IPQM_BASE
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cap_raised
c_func
(paren
id|NETLINK_CB
c_func
(paren
id|skb
)paren
dot
id|eff_cap
comma
id|CAP_NET_ADMIN
)paren
)paren
(brace
id|RCV_SKB_FAIL
c_func
(paren
op_minus
id|EPERM
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|nlq6-&gt;peer.pid
op_logical_and
op_logical_neg
id|nlq6-&gt;peer.died
op_logical_and
(paren
id|nlq6-&gt;peer.pid
op_ne
id|nlh-&gt;nlmsg_pid
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;ip6_queue: peer pid changed from %d to &quot;
l_string|&quot;%d, flushing queue&bslash;n&quot;
comma
id|nlq6-&gt;peer.pid
comma
id|nlh-&gt;nlmsg_pid
)paren
suffix:semicolon
id|ip6q_flush
c_func
(paren
id|nlq6
)paren
suffix:semicolon
)brace
id|nlq6-&gt;peer.pid
op_assign
id|nlh-&gt;nlmsg_pid
suffix:semicolon
id|nlq6-&gt;peer.died
op_assign
l_int|0
suffix:semicolon
id|status
op_assign
id|ip6q_receive_peer
c_func
(paren
id|nlq6
comma
id|NLMSG_DATA
c_func
(paren
id|nlh
)paren
comma
id|type
comma
id|skb-&gt;len
op_minus
id|NLMSG_LENGTH
c_func
(paren
l_int|0
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
OL
l_int|0
)paren
id|RCV_SKB_FAIL
c_func
(paren
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|nlh-&gt;nlmsg_flags
op_amp
id|NLM_F_ACK
)paren
id|netlink_ack
c_func
(paren
id|skb
comma
id|nlh
comma
l_int|0
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Note: we are only dealing with single part messages at the moment. */
DECL|function|netlink_receive_user_sk
r_static
r_void
id|netlink_receive_user_sk
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_int
id|len
)paren
(brace
r_do
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_if
c_cond
(paren
id|rtnl_shlock_nowait
c_func
(paren
)paren
)paren
r_return
suffix:semicolon
r_while
c_loop
(paren
(paren
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|sk-&gt;receive_queue
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|netlink_receive_user_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|rtnl_sem
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|nfnl
op_logical_and
id|nfnl-&gt;receive_queue.qlen
)paren
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *&n; * System events&n; *&n; ****************************************************************************/
DECL|function|receive_event
r_static
r_int
id|receive_event
c_func
(paren
r_struct
id|notifier_block
op_star
id|this
comma
r_int
r_int
id|event
comma
r_void
op_star
id|ptr
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|ptr
suffix:semicolon
multiline_comment|/* Drop any packets associated with the downed device */
r_if
c_cond
(paren
id|event
op_eq
id|NETDEV_DOWN
)paren
id|ip6q_dev_drop
c_func
(paren
id|nlq6
comma
id|dev-&gt;ifindex
)paren
suffix:semicolon
r_return
id|NOTIFY_DONE
suffix:semicolon
)brace
DECL|variable|ip6q_dev_notifier
r_struct
id|notifier_block
id|ip6q_dev_notifier
op_assign
(brace
id|receive_event
comma
l_int|NULL
comma
l_int|0
)brace
suffix:semicolon
multiline_comment|/****************************************************************************&n; *&n; * Sysctl - queue tuning.&n; *&n; ****************************************************************************/
DECL|variable|sysctl_maxlen
r_static
r_int
id|sysctl_maxlen
op_assign
id|IPQ_QMAX_DEFAULT
suffix:semicolon
DECL|variable|ip6q_sysctl_header
r_static
r_struct
id|ctl_table_header
op_star
id|ip6q_sysctl_header
suffix:semicolon
DECL|variable|ip6q_table
r_static
id|ctl_table
id|ip6q_table
(braket
)braket
op_assign
(brace
(brace
id|NET_IPQ_QMAX
comma
id|NET_IPQ_QMAX_NAME
comma
op_amp
id|sysctl_maxlen
comma
r_sizeof
(paren
id|sysctl_maxlen
)paren
comma
l_int|0644
comma
l_int|NULL
comma
id|proc_dointvec
)brace
comma
(brace
l_int|0
)brace
)brace
suffix:semicolon
DECL|variable|ip6q_dir_table
r_static
id|ctl_table
id|ip6q_dir_table
(braket
)braket
op_assign
(brace
(brace
id|NET_IPV6
comma
l_string|&quot;ipv6&quot;
comma
l_int|NULL
comma
l_int|0
comma
l_int|0555
comma
id|ip6q_table
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
(brace
l_int|0
)brace
)brace
suffix:semicolon
DECL|variable|ip6q_root_table
r_static
id|ctl_table
id|ip6q_root_table
(braket
)braket
op_assign
(brace
(brace
id|CTL_NET
comma
l_string|&quot;net&quot;
comma
l_int|NULL
comma
l_int|0
comma
l_int|0555
comma
id|ip6q_dir_table
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
comma
(brace
l_int|0
)brace
)brace
suffix:semicolon
multiline_comment|/****************************************************************************&n; *&n; * Procfs - debugging info.&n; *&n; ****************************************************************************/
DECL|function|ip6q_get_info
r_static
r_int
id|ip6q_get_info
c_func
(paren
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|length
)paren
(brace
r_int
id|len
suffix:semicolon
id|spin_lock_bh
c_func
(paren
op_amp
id|nlq6-&gt;lock
)paren
suffix:semicolon
id|len
op_assign
id|sprintf
c_func
(paren
id|buffer
comma
l_string|&quot;Peer pid            : %d&bslash;n&quot;
l_string|&quot;Peer died           : %d&bslash;n&quot;
l_string|&quot;Peer copy mode      : %d&bslash;n&quot;
l_string|&quot;Peer copy range     : %Zu&bslash;n&quot;
l_string|&quot;Queue length        : %d&bslash;n&quot;
l_string|&quot;Queue max. length   : %d&bslash;n&quot;
l_string|&quot;Queue flushing      : %d&bslash;n&quot;
l_string|&quot;Queue terminate     : %d&bslash;n&quot;
comma
id|nlq6-&gt;peer.pid
comma
id|nlq6-&gt;peer.died
comma
id|nlq6-&gt;peer.copy_mode
comma
id|nlq6-&gt;peer.copy_range
comma
id|nlq6-&gt;len
comma
op_star
id|nlq6-&gt;maxlen
comma
id|nlq6-&gt;flushing
comma
id|nlq6-&gt;terminate
)paren
suffix:semicolon
id|spin_unlock_bh
c_func
(paren
op_amp
id|nlq6-&gt;lock
)paren
suffix:semicolon
op_star
id|start
op_assign
id|buffer
op_plus
id|offset
suffix:semicolon
id|len
op_sub_assign
id|offset
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|length
)paren
id|len
op_assign
id|length
suffix:semicolon
r_else
r_if
c_cond
(paren
id|len
OL
l_int|0
)paren
id|len
op_assign
l_int|0
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
multiline_comment|/****************************************************************************&n; *&n; * Module stuff.&n; *&n; ****************************************************************************/
DECL|function|init
r_static
r_int
id|__init
id|init
c_func
(paren
r_void
)paren
(brace
r_int
id|status
op_assign
l_int|0
suffix:semicolon
r_struct
id|proc_dir_entry
op_star
id|proc
suffix:semicolon
multiline_comment|/* We must create the NETLINK_IP6_FW protocol service */
id|nfnl
op_assign
id|netlink_kernel_create
c_func
(paren
id|NETLINK_IP6_FW
comma
id|netlink_receive_user_sk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|nfnl
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ip6_queue: initialisation failed: unable to &quot;
l_string|&quot;create kernel netlink socket&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|nlq6
op_assign
id|ip6q_create_queue
c_func
(paren
id|netfilter6_receive
comma
id|netlink_send_peer
comma
op_amp
id|status
comma
op_amp
id|sysctl_maxlen
)paren
suffix:semicolon
r_if
c_cond
(paren
id|nlq6
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ip6_queue: initialisation failed: unable to &quot;
l_string|&quot;create queue&bslash;n&quot;
)paren
suffix:semicolon
id|sock_release
c_func
(paren
id|nfnl-&gt;socket
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/* The file will be /proc/net/ip6_queue */
id|proc
op_assign
id|proc_net_create
c_func
(paren
id|IPQ_PROC_FS_NAME
comma
l_int|0
comma
id|ip6q_get_info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|proc
)paren
id|proc-&gt;owner
op_assign
id|THIS_MODULE
suffix:semicolon
r_else
(brace
id|ip6q_destroy_queue
c_func
(paren
id|nlq6
)paren
suffix:semicolon
id|sock_release
c_func
(paren
id|nfnl-&gt;socket
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|register_netdevice_notifier
c_func
(paren
op_amp
id|ip6q_dev_notifier
)paren
suffix:semicolon
id|ip6q_sysctl_header
op_assign
id|register_sysctl_table
c_func
(paren
id|ip6q_root_table
comma
l_int|0
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
DECL|function|fini
r_static
r_void
id|__exit
id|fini
c_func
(paren
r_void
)paren
(brace
id|unregister_sysctl_table
c_func
(paren
id|ip6q_sysctl_header
)paren
suffix:semicolon
id|proc_net_remove
c_func
(paren
id|IPQ_PROC_FS_NAME
)paren
suffix:semicolon
id|unregister_netdevice_notifier
c_func
(paren
op_amp
id|ip6q_dev_notifier
)paren
suffix:semicolon
id|ip6q_destroy_queue
c_func
(paren
id|nlq6
)paren
suffix:semicolon
id|sock_release
c_func
(paren
id|nfnl-&gt;socket
)paren
suffix:semicolon
)brace
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;IPv6 packet queue handler&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
DECL|variable|init
id|module_init
c_func
(paren
id|init
)paren
suffix:semicolon
DECL|variable|fini
id|module_exit
c_func
(paren
id|fini
)paren
suffix:semicolon
eof
