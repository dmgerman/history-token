multiline_comment|/*&n; *&t;IPv6 output functions&n; *&t;Linux INET6 implementation &n; *&n; *&t;Authors:&n; *&t;Pedro Roque&t;&t;&lt;roque@di.fc.ul.pt&gt;&t;&n; *&n; *&t;$Id: ip6_output.c,v 1.34 2002/02/01 22:01:04 davem Exp $&n; *&n; *&t;Based on linux/net/ipv4/ip_output.c&n; *&n; *&t;This program is free software; you can redistribute it and/or&n; *      modify it under the terms of the GNU General Public License&n; *      as published by the Free Software Foundation; either version&n; *      2 of the License, or (at your option) any later version.&n; *&n; *&t;Changes:&n; *&t;A.N.Kuznetsov&t;:&t;airthmetics in fragmentation.&n; *&t;&t;&t;&t;extension headers are implemented.&n; *&t;&t;&t;&t;route changes now work.&n; *&t;&t;&t;&t;ip6_forward does not confuse sniffers.&n; *&t;&t;&t;&t;etc.&n; *&n; *      H. von Brand    :       Added missing #include &lt;linux/string.h&gt;&n; *&t;Imran Patel&t;: &t;frag id should be in NBO&n; *      Kazunori MIYAZAWA @USAGI&n; *&t;&t;&t;:       add ip6_append_data and related functions&n; *&t;&t;&t;&t;for datagram xmit&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/socket.h&gt;
macro_line|#include &lt;linux/net.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/if_arp.h&gt;
macro_line|#include &lt;linux/in6.h&gt;
macro_line|#include &lt;linux/tcp.h&gt;
macro_line|#include &lt;linux/route.h&gt;
macro_line|#include &lt;linux/netfilter.h&gt;
macro_line|#include &lt;linux/netfilter_ipv6.h&gt;
macro_line|#include &lt;net/sock.h&gt;
macro_line|#include &lt;net/snmp.h&gt;
macro_line|#include &lt;net/ipv6.h&gt;
macro_line|#include &lt;net/ndisc.h&gt;
macro_line|#include &lt;net/protocol.h&gt;
macro_line|#include &lt;net/ip6_route.h&gt;
macro_line|#include &lt;net/addrconf.h&gt;
macro_line|#include &lt;net/rawv6.h&gt;
macro_line|#include &lt;net/icmp.h&gt;
macro_line|#include &lt;net/xfrm.h&gt;
r_static
r_int
id|ip6_fragment
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_int
(paren
op_star
id|output
)paren
(paren
r_struct
id|sk_buff
op_star
)paren
)paren
suffix:semicolon
DECL|function|ipv6_select_ident
r_static
id|__inline__
r_void
id|ipv6_select_ident
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|frag_hdr
op_star
id|fhdr
)paren
(brace
r_static
id|u32
id|ipv6_fragmentation_id
op_assign
l_int|1
suffix:semicolon
r_static
id|spinlock_t
id|ip6_id_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
id|spin_lock_bh
c_func
(paren
op_amp
id|ip6_id_lock
)paren
suffix:semicolon
id|fhdr-&gt;identification
op_assign
id|htonl
c_func
(paren
id|ipv6_fragmentation_id
)paren
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|ipv6_fragmentation_id
op_eq
l_int|0
)paren
id|ipv6_fragmentation_id
op_assign
l_int|1
suffix:semicolon
id|spin_unlock_bh
c_func
(paren
op_amp
id|ip6_id_lock
)paren
suffix:semicolon
)brace
DECL|function|ip6_output_finish
r_static
r_inline
r_int
id|ip6_output_finish
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|dst_entry
op_star
id|dst
op_assign
id|skb-&gt;dst
suffix:semicolon
r_struct
id|hh_cache
op_star
id|hh
op_assign
id|dst-&gt;hh
suffix:semicolon
r_if
c_cond
(paren
id|hh
)paren
(brace
r_int
id|hh_alen
suffix:semicolon
id|read_lock_bh
c_func
(paren
op_amp
id|hh-&gt;hh_lock
)paren
suffix:semicolon
id|hh_alen
op_assign
id|HH_DATA_ALIGN
c_func
(paren
id|hh-&gt;hh_len
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|skb-&gt;data
op_minus
id|hh_alen
comma
id|hh-&gt;hh_data
comma
id|hh_alen
)paren
suffix:semicolon
id|read_unlock_bh
c_func
(paren
op_amp
id|hh-&gt;hh_lock
)paren
suffix:semicolon
id|skb_push
c_func
(paren
id|skb
comma
id|hh-&gt;hh_len
)paren
suffix:semicolon
r_return
id|hh
op_member_access_from_pointer
id|hh_output
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|dst-&gt;neighbour
)paren
r_return
id|dst-&gt;neighbour
op_member_access_from_pointer
id|output
c_func
(paren
id|skb
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* dev_loopback_xmit for use with netfilter. */
DECL|function|ip6_dev_loopback_xmit
r_static
r_int
id|ip6_dev_loopback_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|newskb
)paren
(brace
id|newskb-&gt;mac.raw
op_assign
id|newskb-&gt;data
suffix:semicolon
id|__skb_pull
c_func
(paren
id|newskb
comma
id|newskb-&gt;nh.raw
op_minus
id|newskb-&gt;data
)paren
suffix:semicolon
id|newskb-&gt;pkt_type
op_assign
id|PACKET_LOOPBACK
suffix:semicolon
id|newskb-&gt;ip_summed
op_assign
id|CHECKSUM_UNNECESSARY
suffix:semicolon
id|BUG_TRAP
c_func
(paren
id|newskb-&gt;dst
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|newskb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ip6_output2
r_int
id|ip6_output2
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|dst_entry
op_star
id|dst
op_assign
id|skb-&gt;dst
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
id|dst-&gt;dev
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|htons
c_func
(paren
id|ETH_P_IPV6
)paren
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
r_if
c_cond
(paren
id|ipv6_addr_is_multicast
c_func
(paren
op_amp
id|skb-&gt;nh.ipv6h-&gt;daddr
)paren
)paren
(brace
r_struct
id|ipv6_pinfo
op_star
id|np
op_assign
id|skb-&gt;sk
ques
c_cond
id|inet6_sk
c_func
(paren
id|skb-&gt;sk
)paren
suffix:colon
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|dev-&gt;flags
op_amp
id|IFF_LOOPBACK
)paren
op_logical_and
(paren
op_logical_neg
id|np
op_logical_or
id|np-&gt;mc_loop
)paren
op_logical_and
id|ipv6_chk_mcast_addr
c_func
(paren
id|dev
comma
op_amp
id|skb-&gt;nh.ipv6h-&gt;daddr
comma
op_amp
id|skb-&gt;nh.ipv6h-&gt;saddr
)paren
)paren
(brace
r_struct
id|sk_buff
op_star
id|newskb
op_assign
id|skb_clone
c_func
(paren
id|skb
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
multiline_comment|/* Do not check for IFF_ALLMULTI; multicast routing&n;&t;&t;&t;   is not supported in any case.&n;&t;&t;&t; */
r_if
c_cond
(paren
id|newskb
)paren
id|NF_HOOK
c_func
(paren
id|PF_INET6
comma
id|NF_IP6_POST_ROUTING
comma
id|newskb
comma
l_int|NULL
comma
id|newskb-&gt;dev
comma
id|ip6_dev_loopback_xmit
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;nh.ipv6h-&gt;hop_limit
op_eq
l_int|0
)paren
(brace
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
id|IP6_INC_STATS
c_func
(paren
id|Ip6OutMcastPkts
)paren
suffix:semicolon
)brace
r_return
id|NF_HOOK
c_func
(paren
id|PF_INET6
comma
id|NF_IP6_POST_ROUTING
comma
id|skb
comma
l_int|NULL
comma
id|skb-&gt;dev
comma
id|ip6_output_finish
)paren
suffix:semicolon
)brace
DECL|function|ip6_output
r_int
id|ip6_output
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_if
c_cond
(paren
(paren
id|skb-&gt;len
OG
id|dst_pmtu
c_func
(paren
id|skb-&gt;dst
)paren
op_logical_or
id|skb_shinfo
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|frag_list
)paren
)paren
r_return
id|ip6_fragment
c_func
(paren
id|skb
comma
id|ip6_output2
)paren
suffix:semicolon
r_else
r_return
id|ip6_output2
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_NETFILTER
DECL|function|ip6_route_me_harder
r_int
id|ip6_route_me_harder
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|ipv6hdr
op_star
id|iph
op_assign
id|skb-&gt;nh.ipv6h
suffix:semicolon
r_struct
id|dst_entry
op_star
id|dst
suffix:semicolon
r_struct
id|flowi
id|fl
op_assign
(brace
dot
id|oif
op_assign
id|skb-&gt;sk
ques
c_cond
id|skb-&gt;sk-&gt;sk_bound_dev_if
suffix:colon
l_int|0
comma
dot
id|nl_u
op_assign
(brace
dot
id|ip6_u
op_assign
(brace
dot
id|daddr
op_assign
id|iph-&gt;daddr
comma
dot
id|saddr
op_assign
id|iph-&gt;saddr
comma
)brace
)brace
comma
dot
id|proto
op_assign
id|iph-&gt;nexthdr
comma
)brace
suffix:semicolon
id|dst
op_assign
id|ip6_route_output
c_func
(paren
id|skb-&gt;sk
comma
op_amp
id|fl
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dst-&gt;error
)paren
(brace
r_if
c_cond
(paren
id|net_ratelimit
c_func
(paren
)paren
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;ip6_route_me_harder: No more route.&bslash;n&quot;
)paren
suffix:semicolon
id|dst_release
c_func
(paren
id|dst
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* Drop old route. */
id|dst_release
c_func
(paren
id|skb-&gt;dst
)paren
suffix:semicolon
id|skb-&gt;dst
op_assign
id|dst
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
DECL|function|ip6_maybe_reroute
r_static
r_inline
r_int
id|ip6_maybe_reroute
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
macro_line|#ifdef CONFIG_NETFILTER
r_if
c_cond
(paren
id|skb-&gt;nfcache
op_amp
id|NFC_ALTERED
)paren
(brace
r_if
c_cond
(paren
id|ip6_route_me_harder
c_func
(paren
id|skb
)paren
op_ne
l_int|0
)paren
(brace
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
macro_line|#endif /* CONFIG_NETFILTER */
r_return
id|dst_output
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;xmit an sk_buff (used by TCP)&n; */
DECL|function|ip6_xmit
r_int
id|ip6_xmit
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|flowi
op_star
id|fl
comma
r_struct
id|ipv6_txoptions
op_star
id|opt
comma
r_int
id|ipfragok
)paren
(brace
r_struct
id|ipv6_pinfo
op_star
id|np
op_assign
id|sk
ques
c_cond
id|inet6_sk
c_func
(paren
id|sk
)paren
suffix:colon
l_int|NULL
suffix:semicolon
r_struct
id|in6_addr
op_star
id|first_hop
op_assign
op_amp
id|fl-&gt;fl6_dst
suffix:semicolon
r_struct
id|dst_entry
op_star
id|dst
op_assign
id|skb-&gt;dst
suffix:semicolon
r_struct
id|ipv6hdr
op_star
id|hdr
suffix:semicolon
id|u8
id|proto
op_assign
id|fl-&gt;proto
suffix:semicolon
r_int
id|seg_len
op_assign
id|skb-&gt;len
suffix:semicolon
r_int
id|hlimit
suffix:semicolon
id|u32
id|mtu
suffix:semicolon
r_if
c_cond
(paren
id|opt
)paren
(brace
r_int
id|head_room
suffix:semicolon
multiline_comment|/* First: exthdrs may take lots of space (~8K for now)&n;&t;&t;   MAX_HEADER is not enough.&n;&t;&t; */
id|head_room
op_assign
id|opt-&gt;opt_nflen
op_plus
id|opt-&gt;opt_flen
suffix:semicolon
id|seg_len
op_add_assign
id|head_room
suffix:semicolon
id|head_room
op_add_assign
r_sizeof
(paren
r_struct
id|ipv6hdr
)paren
op_plus
(paren
(paren
id|dst-&gt;dev-&gt;hard_header_len
op_plus
l_int|15
)paren
op_amp
op_complement
l_int|15
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb_headroom
c_func
(paren
id|skb
)paren
OL
id|head_room
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb2
op_assign
id|skb_realloc_headroom
c_func
(paren
id|skb
comma
id|head_room
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|skb
op_assign
id|skb2
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOBUFS
suffix:semicolon
r_if
c_cond
(paren
id|sk
)paren
id|skb_set_owner_w
c_func
(paren
id|skb
comma
id|sk
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|opt-&gt;opt_flen
)paren
id|ipv6_push_frag_opts
c_func
(paren
id|skb
comma
id|opt
comma
op_amp
id|proto
)paren
suffix:semicolon
r_if
c_cond
(paren
id|opt-&gt;opt_nflen
)paren
id|ipv6_push_nfrag_opts
c_func
(paren
id|skb
comma
id|opt
comma
op_amp
id|proto
comma
op_amp
id|first_hop
)paren
suffix:semicolon
)brace
id|hdr
op_assign
id|skb-&gt;nh.ipv6h
op_assign
(paren
r_struct
id|ipv6hdr
op_star
)paren
id|skb_push
c_func
(paren
id|skb
comma
r_sizeof
(paren
r_struct
id|ipv6hdr
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Fill in the IPv6 header&n;&t; */
op_star
(paren
id|u32
op_star
)paren
id|hdr
op_assign
id|htonl
c_func
(paren
l_int|0x60000000
)paren
op_or
id|fl-&gt;fl6_flowlabel
suffix:semicolon
id|hlimit
op_assign
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|np
)paren
id|hlimit
op_assign
id|np-&gt;hop_limit
suffix:semicolon
r_if
c_cond
(paren
id|hlimit
OL
l_int|0
)paren
id|hlimit
op_assign
id|dst_metric
c_func
(paren
id|dst
comma
id|RTAX_HOPLIMIT
)paren
suffix:semicolon
id|hdr-&gt;payload_len
op_assign
id|htons
c_func
(paren
id|seg_len
)paren
suffix:semicolon
id|hdr-&gt;nexthdr
op_assign
id|proto
suffix:semicolon
id|hdr-&gt;hop_limit
op_assign
id|hlimit
suffix:semicolon
id|ipv6_addr_copy
c_func
(paren
op_amp
id|hdr-&gt;saddr
comma
op_amp
id|fl-&gt;fl6_src
)paren
suffix:semicolon
id|ipv6_addr_copy
c_func
(paren
op_amp
id|hdr-&gt;daddr
comma
id|first_hop
)paren
suffix:semicolon
id|mtu
op_assign
id|dst_pmtu
c_func
(paren
id|dst
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|skb-&gt;len
op_le
id|mtu
)paren
op_logical_or
id|ipfragok
)paren
(brace
id|IP6_INC_STATS
c_func
(paren
id|Ip6OutRequests
)paren
suffix:semicolon
r_return
id|NF_HOOK
c_func
(paren
id|PF_INET6
comma
id|NF_IP6_LOCAL_OUT
comma
id|skb
comma
l_int|NULL
comma
id|dst-&gt;dev
comma
id|ip6_maybe_reroute
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|net_ratelimit
c_func
(paren
)paren
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;IPv6: sending pkt_too_big to self&bslash;n&quot;
)paren
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dst-&gt;dev
suffix:semicolon
id|icmpv6_send
c_func
(paren
id|skb
comma
id|ICMPV6_PKT_TOOBIG
comma
l_int|0
comma
id|mtu
comma
id|skb-&gt;dev
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
op_minus
id|EMSGSIZE
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;To avoid extra problems ND packets are send through this&n; *&t;routine. It&squot;s code duplication but I really want to avoid&n; *&t;extra checks since ipv6_build_header is used by TCP (which&n; *&t;is for us performance critical)&n; */
DECL|function|ip6_nd_hdr
r_int
id|ip6_nd_hdr
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|in6_addr
op_star
id|saddr
comma
r_struct
id|in6_addr
op_star
id|daddr
comma
r_int
id|proto
comma
r_int
id|len
)paren
(brace
r_struct
id|ipv6_pinfo
op_star
id|np
op_assign
id|inet6_sk
c_func
(paren
id|sk
)paren
suffix:semicolon
r_struct
id|ipv6hdr
op_star
id|hdr
suffix:semicolon
r_int
id|totlen
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|htons
c_func
(paren
id|ETH_P_IPV6
)paren
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|totlen
op_assign
id|len
op_plus
r_sizeof
(paren
r_struct
id|ipv6hdr
)paren
suffix:semicolon
id|hdr
op_assign
(paren
r_struct
id|ipv6hdr
op_star
)paren
id|skb_put
c_func
(paren
id|skb
comma
r_sizeof
(paren
r_struct
id|ipv6hdr
)paren
)paren
suffix:semicolon
id|skb-&gt;nh.ipv6h
op_assign
id|hdr
suffix:semicolon
op_star
(paren
id|u32
op_star
)paren
id|hdr
op_assign
id|htonl
c_func
(paren
l_int|0x60000000
)paren
suffix:semicolon
id|hdr-&gt;payload_len
op_assign
id|htons
c_func
(paren
id|len
)paren
suffix:semicolon
id|hdr-&gt;nexthdr
op_assign
id|proto
suffix:semicolon
id|hdr-&gt;hop_limit
op_assign
id|np-&gt;hop_limit
suffix:semicolon
id|ipv6_addr_copy
c_func
(paren
op_amp
id|hdr-&gt;saddr
comma
id|saddr
)paren
suffix:semicolon
id|ipv6_addr_copy
c_func
(paren
op_amp
id|hdr-&gt;daddr
comma
id|daddr
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ip6_bld_1
r_static
r_struct
id|ipv6hdr
op_star
id|ip6_bld_1
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|flowi
op_star
id|fl
comma
r_int
id|hlimit
comma
r_int
id|pktlength
)paren
(brace
r_struct
id|ipv6hdr
op_star
id|hdr
suffix:semicolon
id|skb-&gt;nh.raw
op_assign
id|skb_put
c_func
(paren
id|skb
comma
r_sizeof
(paren
r_struct
id|ipv6hdr
)paren
)paren
suffix:semicolon
id|hdr
op_assign
id|skb-&gt;nh.ipv6h
suffix:semicolon
op_star
(paren
id|u32
op_star
)paren
id|hdr
op_assign
id|fl-&gt;fl6_flowlabel
op_or
id|htonl
c_func
(paren
l_int|0x60000000
)paren
suffix:semicolon
id|hdr-&gt;payload_len
op_assign
id|htons
c_func
(paren
id|pktlength
op_minus
r_sizeof
(paren
r_struct
id|ipv6hdr
)paren
)paren
suffix:semicolon
id|hdr-&gt;hop_limit
op_assign
id|hlimit
suffix:semicolon
id|hdr-&gt;nexthdr
op_assign
id|fl-&gt;proto
suffix:semicolon
id|ipv6_addr_copy
c_func
(paren
op_amp
id|hdr-&gt;saddr
comma
op_amp
id|fl-&gt;fl6_src
)paren
suffix:semicolon
id|ipv6_addr_copy
c_func
(paren
op_amp
id|hdr-&gt;daddr
comma
op_amp
id|fl-&gt;fl6_dst
)paren
suffix:semicolon
r_return
id|hdr
suffix:semicolon
)brace
DECL|function|ipv6_build_fraghdr
r_static
id|__inline__
id|u8
op_star
id|ipv6_build_fraghdr
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
id|u8
op_star
id|prev_hdr
comma
r_int
id|offset
)paren
(brace
r_struct
id|frag_hdr
op_star
id|fhdr
suffix:semicolon
id|fhdr
op_assign
(paren
r_struct
id|frag_hdr
op_star
)paren
id|skb_put
c_func
(paren
id|skb
comma
r_sizeof
(paren
r_struct
id|frag_hdr
)paren
)paren
suffix:semicolon
id|fhdr-&gt;nexthdr
op_assign
op_star
id|prev_hdr
suffix:semicolon
op_star
id|prev_hdr
op_assign
id|NEXTHDR_FRAGMENT
suffix:semicolon
id|prev_hdr
op_assign
op_amp
id|fhdr-&gt;nexthdr
suffix:semicolon
id|fhdr-&gt;reserved
op_assign
l_int|0
suffix:semicolon
id|fhdr-&gt;frag_off
op_assign
id|htons
c_func
(paren
id|offset
)paren
suffix:semicolon
id|ipv6_select_ident
c_func
(paren
id|skb
comma
id|fhdr
)paren
suffix:semicolon
r_return
op_amp
id|fhdr-&gt;nexthdr
suffix:semicolon
)brace
DECL|function|ip6_frag_xmit
r_static
r_int
id|ip6_frag_xmit
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
id|inet_getfrag_t
id|getfrag
comma
r_const
r_void
op_star
id|data
comma
r_struct
id|dst_entry
op_star
id|dst
comma
r_struct
id|flowi
op_star
id|fl
comma
r_struct
id|ipv6_txoptions
op_star
id|opt
comma
r_struct
id|in6_addr
op_star
id|final_dst
comma
r_int
id|hlimit
comma
r_int
id|flags
comma
r_int
id|length
comma
r_int
id|mtu
)paren
(brace
r_struct
id|ipv6hdr
op_star
id|hdr
suffix:semicolon
r_struct
id|sk_buff
op_star
id|last_skb
suffix:semicolon
id|u8
op_star
id|prev_hdr
suffix:semicolon
r_int
id|unfrag_len
suffix:semicolon
r_int
id|frag_len
suffix:semicolon
r_int
id|last_len
suffix:semicolon
r_int
id|nfrags
suffix:semicolon
r_int
id|fhdr_dist
suffix:semicolon
r_int
id|frag_off
suffix:semicolon
r_int
id|data_off
suffix:semicolon
r_int
id|err
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Fragmentation&n;&t; *&n;&t; *&t;Extension header order:&n;&t; *&t;Hop-by-hop -&gt; Dest0 -&gt; Routing -&gt; Fragment -&gt; Auth -&gt; Dest1 -&gt; rest (...)&n;&t; *&t;&n;&t; *&t;We must build the non-fragmented part that&n;&t; *&t;will be in every packet... this also means&n;&t; *&t;that other extension headers (Dest, Auth, etc)&n;&t; *&t;must be considered in the data to be fragmented&n;&t; */
id|unfrag_len
op_assign
r_sizeof
(paren
r_struct
id|ipv6hdr
)paren
op_plus
r_sizeof
(paren
r_struct
id|frag_hdr
)paren
suffix:semicolon
id|last_len
op_assign
id|length
suffix:semicolon
r_if
c_cond
(paren
id|opt
)paren
(brace
id|unfrag_len
op_add_assign
id|opt-&gt;opt_nflen
suffix:semicolon
id|last_len
op_add_assign
id|opt-&gt;opt_flen
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *&t;Length of fragmented part on every packet but &n;&t; *&t;the last must be an:&n;&t; *&t;&quot;integer multiple of 8 octets&quot;.&n;&t; */
id|frag_len
op_assign
(paren
id|mtu
op_minus
id|unfrag_len
)paren
op_amp
op_complement
l_int|0x7
suffix:semicolon
multiline_comment|/* Unfragmentable part exceeds mtu. */
r_if
c_cond
(paren
id|frag_len
op_le
l_int|0
)paren
(brace
id|ipv6_local_error
c_func
(paren
id|sk
comma
id|EMSGSIZE
comma
id|fl
comma
id|mtu
)paren
suffix:semicolon
r_return
op_minus
id|EMSGSIZE
suffix:semicolon
)brace
id|nfrags
op_assign
id|last_len
op_div
id|frag_len
suffix:semicolon
multiline_comment|/*&n;&t; *&t;We must send from end to start because of &n;&t; *&t;UDP/ICMP checksums. We do a funny trick:&n;&t; *&t;fill the last skb first with the fixed&n;&t; *&t;header (and its data) and then use it&n;&t; *&t;to create the following segments and send it&n;&t; *&t;in the end. If the peer is checking the M_flag&n;&t; *&t;to trigger the reassembly code then this &n;&t; *&t;might be a good idea.&n;&t; */
id|frag_off
op_assign
id|nfrags
op_star
id|frag_len
suffix:semicolon
id|last_len
op_sub_assign
id|frag_off
suffix:semicolon
r_if
c_cond
(paren
id|last_len
op_eq
l_int|0
)paren
(brace
id|last_len
op_assign
id|frag_len
suffix:semicolon
id|frag_off
op_sub_assign
id|frag_len
suffix:semicolon
id|nfrags
op_decrement
suffix:semicolon
)brace
id|data_off
op_assign
id|frag_off
suffix:semicolon
multiline_comment|/* And it is implementation problem: for now we assume, that&n;&t;   all the exthdrs will fit to the first fragment.&n;&t; */
r_if
c_cond
(paren
id|opt
)paren
(brace
r_if
c_cond
(paren
id|frag_len
OL
id|opt-&gt;opt_flen
)paren
(brace
id|ipv6_local_error
c_func
(paren
id|sk
comma
id|EMSGSIZE
comma
id|fl
comma
id|mtu
)paren
suffix:semicolon
r_return
op_minus
id|EMSGSIZE
suffix:semicolon
)brace
id|data_off
op_assign
id|frag_off
op_minus
id|opt-&gt;opt_flen
suffix:semicolon
)brace
r_if
c_cond
(paren
id|flags
op_amp
id|MSG_PROBE
)paren
r_return
l_int|0
suffix:semicolon
id|last_skb
op_assign
id|sock_alloc_send_skb
c_func
(paren
id|sk
comma
id|unfrag_len
op_plus
id|frag_len
op_plus
id|dst-&gt;dev-&gt;hard_header_len
op_plus
l_int|15
comma
id|flags
op_amp
id|MSG_DONTWAIT
comma
op_amp
id|err
)paren
suffix:semicolon
r_if
c_cond
(paren
id|last_skb
op_eq
l_int|NULL
)paren
r_return
id|err
suffix:semicolon
id|last_skb-&gt;dst
op_assign
id|dst_clone
c_func
(paren
id|dst
)paren
suffix:semicolon
id|skb_reserve
c_func
(paren
id|last_skb
comma
(paren
id|dst-&gt;dev-&gt;hard_header_len
op_plus
l_int|15
)paren
op_amp
op_complement
l_int|15
)paren
suffix:semicolon
id|hdr
op_assign
id|ip6_bld_1
c_func
(paren
id|sk
comma
id|last_skb
comma
id|fl
comma
id|hlimit
comma
id|frag_len
op_plus
id|unfrag_len
)paren
suffix:semicolon
id|prev_hdr
op_assign
op_amp
id|hdr-&gt;nexthdr
suffix:semicolon
r_if
c_cond
(paren
id|opt
op_logical_and
id|opt-&gt;opt_nflen
)paren
id|prev_hdr
op_assign
id|ipv6_build_nfrag_opts
c_func
(paren
id|last_skb
comma
id|prev_hdr
comma
id|opt
comma
id|final_dst
comma
l_int|0
)paren
suffix:semicolon
id|prev_hdr
op_assign
id|ipv6_build_fraghdr
c_func
(paren
id|last_skb
comma
id|prev_hdr
comma
id|frag_off
)paren
suffix:semicolon
id|fhdr_dist
op_assign
id|prev_hdr
op_minus
id|last_skb-&gt;data
suffix:semicolon
id|err
op_assign
id|getfrag
c_func
(paren
id|data
comma
op_amp
id|hdr-&gt;saddr
comma
id|last_skb-&gt;tail
comma
id|data_off
comma
id|last_len
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|err
)paren
(brace
r_while
c_loop
(paren
id|nfrags
op_decrement
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_struct
id|frag_hdr
op_star
id|fhdr2
suffix:semicolon
id|skb
op_assign
id|skb_copy
c_func
(paren
id|last_skb
comma
id|sk-&gt;sk_allocation
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|IP6_INC_STATS
c_func
(paren
id|Ip6FragFails
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|last_skb
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|frag_off
op_sub_assign
id|frag_len
suffix:semicolon
id|data_off
op_sub_assign
id|frag_len
suffix:semicolon
id|fhdr2
op_assign
(paren
r_struct
id|frag_hdr
op_star
)paren
(paren
id|skb-&gt;data
op_plus
id|fhdr_dist
)paren
suffix:semicolon
multiline_comment|/* more flag on */
id|fhdr2-&gt;frag_off
op_assign
id|htons
c_func
(paren
id|frag_off
op_or
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Write fragmentable exthdrs to the first chunk */
r_if
c_cond
(paren
id|nfrags
op_eq
l_int|0
op_logical_and
id|opt
op_logical_and
id|opt-&gt;opt_flen
)paren
(brace
id|ipv6_build_frag_opts
c_func
(paren
id|skb
comma
op_amp
id|fhdr2-&gt;nexthdr
comma
id|opt
)paren
suffix:semicolon
id|frag_len
op_sub_assign
id|opt-&gt;opt_flen
suffix:semicolon
id|data_off
op_assign
l_int|0
suffix:semicolon
)brace
id|err
op_assign
id|getfrag
c_func
(paren
id|data
comma
op_amp
id|hdr-&gt;saddr
comma
id|skb_put
c_func
(paren
id|skb
comma
id|frag_len
)paren
comma
id|data_off
comma
id|frag_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|IP6_INC_STATS
c_func
(paren
id|Ip6FragCreates
)paren
suffix:semicolon
id|IP6_INC_STATS
c_func
(paren
id|Ip6OutRequests
)paren
suffix:semicolon
id|err
op_assign
id|NF_HOOK
c_func
(paren
id|PF_INET6
comma
id|NF_IP6_LOCAL_OUT
comma
id|skb
comma
l_int|NULL
comma
id|dst-&gt;dev
comma
id|ip6_maybe_reroute
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|kfree_skb
c_func
(paren
id|last_skb
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|err
)paren
(brace
id|IP6_INC_STATS
c_func
(paren
id|Ip6FragFails
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|last_skb
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|hdr-&gt;payload_len
op_assign
id|htons
c_func
(paren
id|unfrag_len
op_plus
id|last_len
op_minus
r_sizeof
(paren
r_struct
id|ipv6hdr
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;update last_skb to reflect the getfrag we did&n;&t; *&t;on start.&n;&t; */
id|skb_put
c_func
(paren
id|last_skb
comma
id|last_len
)paren
suffix:semicolon
id|IP6_INC_STATS
c_func
(paren
id|Ip6FragCreates
)paren
suffix:semicolon
id|IP6_INC_STATS
c_func
(paren
id|Ip6FragOKs
)paren
suffix:semicolon
id|IP6_INC_STATS
c_func
(paren
id|Ip6OutRequests
)paren
suffix:semicolon
r_return
id|NF_HOOK
c_func
(paren
id|PF_INET6
comma
id|NF_IP6_LOCAL_OUT
comma
id|last_skb
comma
l_int|NULL
comma
id|dst-&gt;dev
comma
id|ip6_maybe_reroute
)paren
suffix:semicolon
)brace
DECL|function|ip6_build_xmit
r_int
id|ip6_build_xmit
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
id|inet_getfrag_t
id|getfrag
comma
r_const
r_void
op_star
id|data
comma
r_struct
id|flowi
op_star
id|fl
comma
r_int
id|length
comma
r_struct
id|ipv6_txoptions
op_star
id|opt
comma
r_int
id|hlimit
comma
r_int
id|flags
)paren
(brace
r_struct
id|inet_opt
op_star
id|inet
op_assign
id|inet_sk
c_func
(paren
id|sk
)paren
suffix:semicolon
r_struct
id|ipv6_pinfo
op_star
id|np
op_assign
id|inet6_sk
c_func
(paren
id|sk
)paren
suffix:semicolon
r_struct
id|in6_addr
id|final_dst_buf
comma
op_star
id|final_dst
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|dst_entry
op_star
id|dst
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|pktlength
comma
id|jumbolen
comma
id|mtu
suffix:semicolon
r_if
c_cond
(paren
id|opt
op_logical_and
id|opt-&gt;srcrt
)paren
(brace
r_struct
id|rt0_hdr
op_star
id|rt0
op_assign
(paren
r_struct
id|rt0_hdr
op_star
)paren
id|opt-&gt;srcrt
suffix:semicolon
id|ipv6_addr_copy
c_func
(paren
op_amp
id|final_dst_buf
comma
op_amp
id|fl-&gt;fl6_dst
)paren
suffix:semicolon
id|final_dst
op_assign
op_amp
id|final_dst_buf
suffix:semicolon
id|ipv6_addr_copy
c_func
(paren
op_amp
id|fl-&gt;fl6_dst
comma
id|rt0-&gt;addr
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|fl-&gt;oif
op_logical_and
id|ipv6_addr_is_multicast
c_func
(paren
op_amp
id|fl-&gt;fl6_dst
)paren
)paren
id|fl-&gt;oif
op_assign
id|np-&gt;mcast_oif
suffix:semicolon
id|dst
op_assign
id|__sk_dst_check
c_func
(paren
id|sk
comma
id|np-&gt;dst_cookie
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dst
)paren
(brace
r_struct
id|rt6_info
op_star
id|rt
op_assign
(paren
r_struct
id|rt6_info
op_star
)paren
id|dst
suffix:semicolon
multiline_comment|/* Yes, checking route validity in not connected&n;&t;&t;&t;   case is not very simple. Take into account,&n;&t;&t;&t;   that we do not support routing by source, TOS,&n;&t;&t;&t;   and MSG_DONTROUTE &t;&t;--ANK (980726)&n;&n;&t;&t;&t;   1. If route was host route, check that&n;&t;&t;&t;      cached destination is current.&n;&t;&t;&t;      If it is network route, we still may&n;&t;&t;&t;      check its validity using saved pointer&n;&t;&t;&t;      to the last used address: daddr_cache.&n;&t;&t;&t;      We do not want to save whole address now,&n;&t;&t;&t;      (because main consumer of this service&n;&t;&t;&t;       is tcp, which has not this problem),&n;&t;&t;&t;      so that the last trick works only on connected&n;&t;&t;&t;      sockets.&n;&t;&t;&t;   2. oif also should be the same.&n;&t;&t;&t; */
r_if
c_cond
(paren
(paren
(paren
id|rt-&gt;rt6i_dst.plen
op_ne
l_int|128
op_logical_or
id|ipv6_addr_cmp
c_func
(paren
op_amp
id|fl-&gt;fl6_dst
comma
op_amp
id|rt-&gt;rt6i_dst.addr
)paren
)paren
op_logical_and
(paren
id|np-&gt;daddr_cache
op_eq
l_int|NULL
op_logical_or
id|ipv6_addr_cmp
c_func
(paren
op_amp
id|fl-&gt;fl6_dst
comma
id|np-&gt;daddr_cache
)paren
)paren
)paren
op_logical_or
(paren
id|fl-&gt;oif
op_logical_and
id|fl-&gt;oif
op_ne
id|dst-&gt;dev-&gt;ifindex
)paren
)paren
(brace
id|dst
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
id|dst_hold
c_func
(paren
id|dst
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dst
op_eq
l_int|NULL
)paren
id|dst
op_assign
id|ip6_route_output
c_func
(paren
id|sk
comma
id|fl
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dst-&gt;error
)paren
(brace
id|IP6_INC_STATS
c_func
(paren
id|Ip6OutNoRoutes
)paren
suffix:semicolon
id|dst_release
c_func
(paren
id|dst
)paren
suffix:semicolon
r_return
op_minus
id|ENETUNREACH
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ipv6_addr_any
c_func
(paren
op_amp
id|fl-&gt;fl6_src
)paren
)paren
(brace
id|err
op_assign
id|ipv6_get_saddr
c_func
(paren
id|dst
comma
op_amp
id|fl-&gt;fl6_dst
comma
op_amp
id|fl-&gt;fl6_src
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
macro_line|#if IP6_DEBUG &gt;= 2
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;ip6_build_xmit: &quot;
l_string|&quot;no available source address&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_goto
id|out
suffix:semicolon
)brace
)brace
id|pktlength
op_assign
id|length
suffix:semicolon
r_if
c_cond
(paren
id|dst
)paren
(brace
r_if
c_cond
(paren
(paren
id|err
op_assign
id|xfrm_lookup
c_func
(paren
op_amp
id|dst
comma
id|fl
comma
id|sk
comma
l_int|0
)paren
)paren
OL
l_int|0
)paren
(brace
id|dst_release
c_func
(paren
id|dst
)paren
suffix:semicolon
r_return
op_minus
id|ENETUNREACH
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|hlimit
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|ipv6_addr_is_multicast
c_func
(paren
op_amp
id|fl-&gt;fl6_dst
)paren
)paren
id|hlimit
op_assign
id|np-&gt;mcast_hops
suffix:semicolon
r_else
id|hlimit
op_assign
id|np-&gt;hop_limit
suffix:semicolon
r_if
c_cond
(paren
id|hlimit
OL
l_int|0
)paren
id|hlimit
op_assign
id|dst_metric
c_func
(paren
id|dst
comma
id|RTAX_HOPLIMIT
)paren
suffix:semicolon
)brace
id|jumbolen
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|inet-&gt;hdrincl
)paren
(brace
id|pktlength
op_add_assign
r_sizeof
(paren
r_struct
id|ipv6hdr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|opt
)paren
id|pktlength
op_add_assign
id|opt-&gt;opt_flen
op_plus
id|opt-&gt;opt_nflen
suffix:semicolon
r_if
c_cond
(paren
id|pktlength
OG
r_sizeof
(paren
r_struct
id|ipv6hdr
)paren
op_plus
id|IPV6_MAXPLEN
)paren
(brace
multiline_comment|/* Jumbo datagram.&n;&t;&t;&t;   It is assumed, that in the case of hdrincl&n;&t;&t;&t;   jumbo option is supplied by user.&n;&t;&t;&t; */
id|pktlength
op_add_assign
l_int|8
suffix:semicolon
id|jumbolen
op_assign
id|pktlength
op_minus
r_sizeof
(paren
r_struct
id|ipv6hdr
)paren
suffix:semicolon
)brace
)brace
id|mtu
op_assign
id|dst_pmtu
c_func
(paren
id|dst
)paren
suffix:semicolon
r_if
c_cond
(paren
id|np-&gt;frag_size
OL
id|mtu
)paren
(brace
r_if
c_cond
(paren
id|np-&gt;frag_size
)paren
id|mtu
op_assign
id|np-&gt;frag_size
suffix:semicolon
r_else
r_if
c_cond
(paren
id|np-&gt;pmtudisc
op_eq
id|IPV6_PMTUDISC_DONT
)paren
id|mtu
op_assign
id|IPV6_MIN_MTU
suffix:semicolon
)brace
multiline_comment|/* Critical arithmetic overflow check.&n;&t;   FIXME: may gcc optimize it out? --ANK (980726)&n;&t; */
r_if
c_cond
(paren
id|pktlength
OL
id|length
)paren
(brace
id|ipv6_local_error
c_func
(paren
id|sk
comma
id|EMSGSIZE
comma
id|fl
comma
id|mtu
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EMSGSIZE
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|flags
op_amp
id|MSG_CONFIRM
)paren
id|dst_confirm
c_func
(paren
id|dst
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pktlength
op_le
id|mtu
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_struct
id|ipv6hdr
op_star
id|hdr
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
id|dst-&gt;dev
suffix:semicolon
id|err
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
id|MSG_PROBE
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* alloc skb with mtu as we do in the IPv4 stack for IPsec */
id|skb
op_assign
id|sock_alloc_send_skb
c_func
(paren
id|sk
comma
id|mtu
op_plus
id|LL_RESERVED_SPACE
c_func
(paren
id|dev
)paren
comma
id|flags
op_amp
id|MSG_DONTWAIT
comma
op_amp
id|err
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
id|IP6_INC_STATS
c_func
(paren
id|Ip6OutDiscards
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|skb-&gt;dst
op_assign
id|dst_clone
c_func
(paren
id|dst
)paren
suffix:semicolon
id|skb_reserve
c_func
(paren
id|skb
comma
(paren
id|dev-&gt;hard_header_len
op_plus
l_int|15
)paren
op_amp
op_complement
l_int|15
)paren
suffix:semicolon
id|hdr
op_assign
(paren
r_struct
id|ipv6hdr
op_star
)paren
id|skb-&gt;tail
suffix:semicolon
id|skb-&gt;nh.ipv6h
op_assign
id|hdr
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|inet-&gt;hdrincl
)paren
(brace
id|ip6_bld_1
c_func
(paren
id|sk
comma
id|skb
comma
id|fl
comma
id|hlimit
comma
id|jumbolen
ques
c_cond
r_sizeof
(paren
r_struct
id|ipv6hdr
)paren
suffix:colon
id|pktlength
)paren
suffix:semicolon
r_if
c_cond
(paren
id|opt
op_logical_or
id|jumbolen
)paren
(brace
id|u8
op_star
id|prev_hdr
op_assign
op_amp
id|hdr-&gt;nexthdr
suffix:semicolon
id|prev_hdr
op_assign
id|ipv6_build_nfrag_opts
c_func
(paren
id|skb
comma
id|prev_hdr
comma
id|opt
comma
id|final_dst
comma
id|jumbolen
)paren
suffix:semicolon
r_if
c_cond
(paren
id|opt
op_logical_and
id|opt-&gt;opt_flen
)paren
id|ipv6_build_frag_opts
c_func
(paren
id|skb
comma
id|prev_hdr
comma
id|opt
)paren
suffix:semicolon
)brace
)brace
id|skb_put
c_func
(paren
id|skb
comma
id|length
)paren
suffix:semicolon
id|err
op_assign
id|getfrag
c_func
(paren
id|data
comma
op_amp
id|hdr-&gt;saddr
comma
(paren
(paren
r_char
op_star
)paren
id|hdr
)paren
op_plus
(paren
id|pktlength
op_minus
id|length
)paren
comma
l_int|0
comma
id|length
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|opt
op_logical_or
op_logical_neg
id|opt-&gt;dst1opt
)paren
id|skb-&gt;h.raw
op_assign
(paren
(paren
r_char
op_star
)paren
id|hdr
)paren
op_plus
(paren
id|pktlength
op_minus
id|length
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|err
)paren
(brace
id|IP6_INC_STATS
c_func
(paren
id|Ip6OutRequests
)paren
suffix:semicolon
id|err
op_assign
id|NF_HOOK
c_func
(paren
id|PF_INET6
comma
id|NF_IP6_LOCAL_OUT
comma
id|skb
comma
l_int|NULL
comma
id|dst-&gt;dev
comma
id|ip6_maybe_reroute
)paren
suffix:semicolon
)brace
r_else
(brace
id|err
op_assign
op_minus
id|EFAULT
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|inet-&gt;hdrincl
op_logical_or
id|jumbolen
op_logical_or
id|np-&gt;pmtudisc
op_eq
id|IPV6_PMTUDISC_DO
)paren
(brace
id|ipv6_local_error
c_func
(paren
id|sk
comma
id|EMSGSIZE
comma
id|fl
comma
id|mtu
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EMSGSIZE
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|err
op_assign
id|ip6_frag_xmit
c_func
(paren
id|sk
comma
id|getfrag
comma
id|data
comma
id|dst
comma
id|fl
comma
id|opt
comma
id|final_dst
comma
id|hlimit
comma
id|flags
comma
id|length
comma
id|mtu
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *&t;cleanup&n;&t; */
id|out
suffix:colon
id|ip6_dst_store
c_func
(paren
id|sk
comma
id|dst
comma
op_logical_neg
id|ipv6_addr_cmp
c_func
(paren
op_amp
id|fl-&gt;fl6_dst
comma
op_amp
id|np-&gt;daddr
)paren
ques
c_cond
op_amp
id|np-&gt;daddr
suffix:colon
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OG
l_int|0
)paren
id|err
op_assign
id|np-&gt;recverr
ques
c_cond
id|net_xmit_errno
c_func
(paren
id|err
)paren
suffix:colon
l_int|0
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|ip6_call_ra_chain
r_int
id|ip6_call_ra_chain
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_int
id|sel
)paren
(brace
r_struct
id|ip6_ra_chain
op_star
id|ra
suffix:semicolon
r_struct
id|sock
op_star
id|last
op_assign
l_int|NULL
suffix:semicolon
id|read_lock
c_func
(paren
op_amp
id|ip6_ra_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|ra
op_assign
id|ip6_ra_chain
suffix:semicolon
id|ra
suffix:semicolon
id|ra
op_assign
id|ra-&gt;next
)paren
(brace
r_struct
id|sock
op_star
id|sk
op_assign
id|ra-&gt;sk
suffix:semicolon
r_if
c_cond
(paren
id|sk
op_logical_and
id|ra-&gt;sel
op_eq
id|sel
)paren
(brace
r_if
c_cond
(paren
id|last
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb2
op_assign
id|skb_clone
c_func
(paren
id|skb
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb2
)paren
id|rawv6_rcv
c_func
(paren
id|last
comma
id|skb2
)paren
suffix:semicolon
)brace
id|last
op_assign
id|sk
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|last
)paren
(brace
id|rawv6_rcv
c_func
(paren
id|last
comma
id|skb
)paren
suffix:semicolon
id|read_unlock
c_func
(paren
op_amp
id|ip6_ra_lock
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|read_unlock
c_func
(paren
op_amp
id|ip6_ra_lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ip6_forward_finish
r_static
r_inline
r_int
id|ip6_forward_finish
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_return
id|dst_output
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
DECL|function|ip6_forward
r_int
id|ip6_forward
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|dst_entry
op_star
id|dst
op_assign
id|skb-&gt;dst
suffix:semicolon
r_struct
id|ipv6hdr
op_star
id|hdr
op_assign
id|skb-&gt;nh.ipv6h
suffix:semicolon
r_struct
id|inet6_skb_parm
op_star
id|opt
op_assign
(paren
r_struct
id|inet6_skb_parm
op_star
)paren
id|skb-&gt;cb
suffix:semicolon
r_if
c_cond
(paren
id|ipv6_devconf.forwarding
op_eq
l_int|0
)paren
r_goto
id|error
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|xfrm6_policy_check
c_func
(paren
l_int|NULL
comma
id|XFRM_POLICY_FWD
comma
id|skb
)paren
)paren
r_goto
id|drop
suffix:semicolon
id|skb-&gt;ip_summed
op_assign
id|CHECKSUM_NONE
suffix:semicolon
multiline_comment|/*&n;&t; *&t;We DO NOT make any processing on&n;&t; *&t;RA packets, pushing them to user level AS IS&n;&t; *&t;without ane WARRANTY that application will be able&n;&t; *&t;to interpret them. The reason is that we&n;&t; *&t;cannot make anything clever here.&n;&t; *&n;&t; *&t;We are not end-node, so that if packet contains&n;&t; *&t;AH/ESP, we cannot make anything.&n;&t; *&t;Defragmentation also would be mistake, RA packets&n;&t; *&t;cannot be fragmented, because there is no warranty&n;&t; *&t;that different fragments will go along one path. --ANK&n;&t; */
r_if
c_cond
(paren
id|opt-&gt;ra
)paren
(brace
id|u8
op_star
id|ptr
op_assign
id|skb-&gt;nh.raw
op_plus
id|opt-&gt;ra
suffix:semicolon
r_if
c_cond
(paren
id|ip6_call_ra_chain
c_func
(paren
id|skb
comma
(paren
id|ptr
(braket
l_int|2
)braket
op_lshift
l_int|8
)paren
op_plus
id|ptr
(braket
l_int|3
)braket
)paren
)paren
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *&t;check and decrement ttl&n;&t; */
r_if
c_cond
(paren
id|hdr-&gt;hop_limit
op_le
l_int|1
)paren
(brace
multiline_comment|/* Force OUTPUT device used as source address */
id|skb-&gt;dev
op_assign
id|dst-&gt;dev
suffix:semicolon
id|icmpv6_send
c_func
(paren
id|skb
comma
id|ICMPV6_TIME_EXCEED
comma
id|ICMPV6_EXC_HOPLIMIT
comma
l_int|0
comma
id|skb-&gt;dev
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
op_minus
id|ETIMEDOUT
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|xfrm6_route_forward
c_func
(paren
id|skb
)paren
)paren
r_goto
id|drop
suffix:semicolon
multiline_comment|/* IPv6 specs say nothing about it, but it is clear that we cannot&n;&t;   send redirects to source routed frames.&n;&t; */
r_if
c_cond
(paren
id|skb-&gt;dev
op_eq
id|dst-&gt;dev
op_logical_and
id|dst-&gt;neighbour
op_logical_and
id|opt-&gt;srcrt
op_eq
l_int|0
)paren
(brace
r_struct
id|in6_addr
op_star
id|target
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|rt6_info
op_star
id|rt
suffix:semicolon
r_struct
id|neighbour
op_star
id|n
op_assign
id|dst-&gt;neighbour
suffix:semicolon
multiline_comment|/*&n;&t;&t; *&t;incoming and outgoing devices are the same&n;&t;&t; *&t;send a redirect.&n;&t;&t; */
id|rt
op_assign
(paren
r_struct
id|rt6_info
op_star
)paren
id|dst
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rt-&gt;rt6i_flags
op_amp
id|RTF_GATEWAY
)paren
)paren
id|target
op_assign
(paren
r_struct
id|in6_addr
op_star
)paren
op_amp
id|n-&gt;primary_key
suffix:semicolon
r_else
id|target
op_assign
op_amp
id|hdr-&gt;daddr
suffix:semicolon
multiline_comment|/* Limit redirects both by destination (here)&n;&t;&t;   and by source (inside ndisc_send_redirect)&n;&t;&t; */
r_if
c_cond
(paren
id|xrlim_allow
c_func
(paren
id|dst
comma
l_int|1
op_star
id|HZ
)paren
)paren
id|ndisc_send_redirect
c_func
(paren
id|skb
comma
id|n
comma
id|target
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ipv6_addr_type
c_func
(paren
op_amp
id|hdr-&gt;saddr
)paren
op_amp
(paren
id|IPV6_ADDR_MULTICAST
op_or
id|IPV6_ADDR_LOOPBACK
op_or
id|IPV6_ADDR_LINKLOCAL
)paren
)paren
(brace
multiline_comment|/* This check is security critical. */
r_goto
id|error
suffix:semicolon
)brace
r_if
c_cond
(paren
id|skb-&gt;len
OG
id|dst_pmtu
c_func
(paren
id|dst
)paren
)paren
(brace
multiline_comment|/* Again, force OUTPUT device used as source address */
id|skb-&gt;dev
op_assign
id|dst-&gt;dev
suffix:semicolon
id|icmpv6_send
c_func
(paren
id|skb
comma
id|ICMPV6_PKT_TOOBIG
comma
l_int|0
comma
id|dst_pmtu
c_func
(paren
id|dst
)paren
comma
id|skb-&gt;dev
)paren
suffix:semicolon
id|IP6_INC_STATS_BH
c_func
(paren
id|Ip6InTooBigErrors
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
op_minus
id|EMSGSIZE
suffix:semicolon
)brace
r_if
c_cond
(paren
id|skb_cow
c_func
(paren
id|skb
comma
id|dst-&gt;dev-&gt;hard_header_len
)paren
)paren
r_goto
id|drop
suffix:semicolon
id|hdr
op_assign
id|skb-&gt;nh.ipv6h
suffix:semicolon
multiline_comment|/* Mangling hops number delayed to point after skb COW */
id|hdr-&gt;hop_limit
op_decrement
suffix:semicolon
id|IP6_INC_STATS_BH
c_func
(paren
id|Ip6OutForwDatagrams
)paren
suffix:semicolon
r_return
id|NF_HOOK
c_func
(paren
id|PF_INET6
comma
id|NF_IP6_FORWARD
comma
id|skb
comma
id|skb-&gt;dev
comma
id|dst-&gt;dev
comma
id|ip6_forward_finish
)paren
suffix:semicolon
id|error
suffix:colon
id|IP6_INC_STATS_BH
c_func
(paren
id|Ip6InAddrErrors
)paren
suffix:semicolon
id|drop
suffix:colon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|ip6_copy_metadata
r_static
r_void
id|ip6_copy_metadata
c_func
(paren
r_struct
id|sk_buff
op_star
id|to
comma
r_struct
id|sk_buff
op_star
id|from
)paren
(brace
id|to-&gt;pkt_type
op_assign
id|from-&gt;pkt_type
suffix:semicolon
id|to-&gt;priority
op_assign
id|from-&gt;priority
suffix:semicolon
id|to-&gt;protocol
op_assign
id|from-&gt;protocol
suffix:semicolon
id|to-&gt;security
op_assign
id|from-&gt;security
suffix:semicolon
id|to-&gt;dst
op_assign
id|dst_clone
c_func
(paren
id|from-&gt;dst
)paren
suffix:semicolon
id|to-&gt;dev
op_assign
id|from-&gt;dev
suffix:semicolon
macro_line|#ifdef CONFIG_NET_SCHED
id|to-&gt;tc_index
op_assign
id|from-&gt;tc_index
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_NETFILTER
id|to-&gt;nfmark
op_assign
id|from-&gt;nfmark
suffix:semicolon
multiline_comment|/* Connection association is same as pre-frag packet */
id|to-&gt;nfct
op_assign
id|from-&gt;nfct
suffix:semicolon
id|nf_conntrack_get
c_func
(paren
id|to-&gt;nfct
)paren
suffix:semicolon
macro_line|#if defined(CONFIG_BRIDGE) || defined(CONFIG_BRIDGE_MODULE)
id|to-&gt;nf_bridge
op_assign
id|from-&gt;nf_bridge
suffix:semicolon
id|nf_bridge_get
c_func
(paren
id|to-&gt;nf_bridge
)paren
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_NETFILTER_DEBUG
id|to-&gt;nf_debug
op_assign
id|from-&gt;nf_debug
suffix:semicolon
macro_line|#endif
macro_line|#endif
)brace
DECL|function|ip6_find_1stfragopt
r_int
id|ip6_find_1stfragopt
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
id|u8
op_star
op_star
id|nexthdr
)paren
(brace
id|u16
id|offset
op_assign
r_sizeof
(paren
r_struct
id|ipv6hdr
)paren
suffix:semicolon
r_struct
id|ipv6_opt_hdr
op_star
id|exthdr
op_assign
(paren
r_struct
id|ipv6_opt_hdr
op_star
)paren
(paren
id|skb-&gt;nh.ipv6h
op_plus
l_int|1
)paren
suffix:semicolon
r_int
r_int
id|packet_len
op_assign
id|skb-&gt;tail
op_minus
id|skb-&gt;nh.raw
suffix:semicolon
r_int
id|found_rhdr
op_assign
l_int|0
suffix:semicolon
op_star
id|nexthdr
op_assign
op_amp
id|skb-&gt;nh.ipv6h-&gt;nexthdr
suffix:semicolon
r_while
c_loop
(paren
id|offset
op_plus
l_int|1
op_le
id|packet_len
)paren
(brace
r_switch
c_cond
(paren
op_star
op_star
id|nexthdr
)paren
(brace
r_case
id|NEXTHDR_HOP
suffix:colon
r_case
id|NEXTHDR_ROUTING
suffix:colon
r_case
id|NEXTHDR_DEST
suffix:colon
r_if
c_cond
(paren
op_star
op_star
id|nexthdr
op_eq
id|NEXTHDR_ROUTING
)paren
id|found_rhdr
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_star
op_star
id|nexthdr
op_eq
id|NEXTHDR_DEST
op_logical_and
id|found_rhdr
)paren
r_return
id|offset
suffix:semicolon
id|offset
op_add_assign
id|ipv6_optlen
c_func
(paren
id|exthdr
)paren
suffix:semicolon
op_star
id|nexthdr
op_assign
op_amp
id|exthdr-&gt;nexthdr
suffix:semicolon
id|exthdr
op_assign
(paren
r_struct
id|ipv6_opt_hdr
op_star
)paren
(paren
id|skb-&gt;nh.raw
op_plus
id|offset
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
id|offset
suffix:semicolon
)brace
)brace
r_return
id|offset
suffix:semicolon
)brace
DECL|function|ip6_fragment
r_static
r_int
id|ip6_fragment
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_int
(paren
op_star
id|output
)paren
(paren
r_struct
id|sk_buff
op_star
)paren
)paren
(brace
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_struct
id|rt6_info
op_star
id|rt
op_assign
(paren
r_struct
id|rt6_info
op_star
)paren
id|skb-&gt;dst
suffix:semicolon
r_struct
id|sk_buff
op_star
id|frag
suffix:semicolon
r_struct
id|ipv6hdr
op_star
id|tmp_hdr
suffix:semicolon
r_struct
id|frag_hdr
op_star
id|fh
suffix:semicolon
r_int
r_int
id|mtu
comma
id|hlen
comma
id|left
comma
id|len
suffix:semicolon
id|u32
id|frag_id
op_assign
l_int|0
suffix:semicolon
r_int
id|ptr
comma
id|offset
op_assign
l_int|0
comma
id|err
op_assign
l_int|0
suffix:semicolon
id|u8
op_star
id|prevhdr
comma
id|nexthdr
op_assign
l_int|0
suffix:semicolon
id|dev
op_assign
id|rt-&gt;u.dst.dev
suffix:semicolon
id|hlen
op_assign
id|ip6_find_1stfragopt
c_func
(paren
id|skb
comma
op_amp
id|prevhdr
)paren
suffix:semicolon
id|nexthdr
op_assign
op_star
id|prevhdr
suffix:semicolon
id|mtu
op_assign
id|dst_pmtu
c_func
(paren
op_amp
id|rt-&gt;u.dst
)paren
op_minus
id|hlen
op_minus
r_sizeof
(paren
r_struct
id|frag_hdr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb_shinfo
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|frag_list
)paren
(brace
r_int
id|first_len
op_assign
id|skb_pagelen
c_func
(paren
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|first_len
op_minus
id|hlen
OG
id|mtu
op_logical_or
(paren
(paren
id|first_len
op_minus
id|hlen
)paren
op_amp
l_int|7
)paren
op_logical_or
id|skb_cloned
c_func
(paren
id|skb
)paren
)paren
r_goto
id|slow_path
suffix:semicolon
r_for
c_loop
(paren
id|frag
op_assign
id|skb_shinfo
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|frag_list
suffix:semicolon
id|frag
suffix:semicolon
id|frag
op_assign
id|frag-&gt;next
)paren
(brace
multiline_comment|/* Correct geometry. */
r_if
c_cond
(paren
id|frag-&gt;len
OG
id|mtu
op_logical_or
(paren
(paren
id|frag-&gt;len
op_amp
l_int|7
)paren
op_logical_and
id|frag-&gt;next
)paren
op_logical_or
id|skb_headroom
c_func
(paren
id|frag
)paren
OL
id|hlen
)paren
r_goto
id|slow_path
suffix:semicolon
multiline_comment|/* Correct socket ownership. */
r_if
c_cond
(paren
id|frag-&gt;sk
op_eq
l_int|NULL
)paren
r_goto
id|slow_path
suffix:semicolon
multiline_comment|/* Partially cloned skb? */
r_if
c_cond
(paren
id|skb_shared
c_func
(paren
id|frag
)paren
)paren
r_goto
id|slow_path
suffix:semicolon
)brace
id|err
op_assign
l_int|0
suffix:semicolon
id|offset
op_assign
l_int|0
suffix:semicolon
id|frag
op_assign
id|skb_shinfo
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|frag_list
suffix:semicolon
id|skb_shinfo
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|frag_list
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* BUILD HEADER */
id|tmp_hdr
op_assign
id|kmalloc
c_func
(paren
id|hlen
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tmp_hdr
)paren
(brace
id|IP6_INC_STATS
c_func
(paren
id|Ip6FragFails
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
op_star
id|prevhdr
op_assign
id|NEXTHDR_FRAGMENT
suffix:semicolon
id|memcpy
c_func
(paren
id|tmp_hdr
comma
id|skb-&gt;nh.raw
comma
id|hlen
)paren
suffix:semicolon
id|__skb_pull
c_func
(paren
id|skb
comma
id|hlen
)paren
suffix:semicolon
id|fh
op_assign
(paren
r_struct
id|frag_hdr
op_star
)paren
id|__skb_push
c_func
(paren
id|skb
comma
r_sizeof
(paren
r_struct
id|frag_hdr
)paren
)paren
suffix:semicolon
id|skb-&gt;nh.raw
op_assign
id|__skb_push
c_func
(paren
id|skb
comma
id|hlen
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|skb-&gt;nh.raw
comma
id|tmp_hdr
comma
id|hlen
)paren
suffix:semicolon
id|ipv6_select_ident
c_func
(paren
id|skb
comma
id|fh
)paren
suffix:semicolon
id|fh-&gt;nexthdr
op_assign
id|nexthdr
suffix:semicolon
id|fh-&gt;reserved
op_assign
l_int|0
suffix:semicolon
id|fh-&gt;frag_off
op_assign
id|htons
c_func
(paren
id|IP6_MF
)paren
suffix:semicolon
id|frag_id
op_assign
id|fh-&gt;identification
suffix:semicolon
id|first_len
op_assign
id|skb_pagelen
c_func
(paren
id|skb
)paren
suffix:semicolon
id|skb-&gt;data_len
op_assign
id|first_len
op_minus
id|skb_headlen
c_func
(paren
id|skb
)paren
suffix:semicolon
id|skb-&gt;len
op_assign
id|first_len
suffix:semicolon
id|skb-&gt;nh.ipv6h-&gt;payload_len
op_assign
id|htons
c_func
(paren
id|first_len
op_minus
r_sizeof
(paren
r_struct
id|ipv6hdr
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
multiline_comment|/* Prepare header of the next frame,&n;&t;&t;&t; * before previous one went down. */
r_if
c_cond
(paren
id|frag
)paren
(brace
id|frag-&gt;h.raw
op_assign
id|frag-&gt;data
suffix:semicolon
id|fh
op_assign
(paren
r_struct
id|frag_hdr
op_star
)paren
id|__skb_push
c_func
(paren
id|frag
comma
r_sizeof
(paren
r_struct
id|frag_hdr
)paren
)paren
suffix:semicolon
id|frag-&gt;nh.raw
op_assign
id|__skb_push
c_func
(paren
id|frag
comma
id|hlen
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|frag-&gt;nh.raw
comma
id|tmp_hdr
comma
id|hlen
)paren
suffix:semicolon
id|offset
op_add_assign
id|skb-&gt;len
op_minus
id|hlen
op_minus
r_sizeof
(paren
r_struct
id|frag_hdr
)paren
suffix:semicolon
id|fh-&gt;nexthdr
op_assign
id|nexthdr
suffix:semicolon
id|fh-&gt;reserved
op_assign
l_int|0
suffix:semicolon
id|fh-&gt;frag_off
op_assign
id|htons
c_func
(paren
id|offset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|frag-&gt;next
op_ne
l_int|NULL
)paren
id|fh-&gt;frag_off
op_or_assign
id|htons
c_func
(paren
id|IP6_MF
)paren
suffix:semicolon
id|fh-&gt;identification
op_assign
id|frag_id
suffix:semicolon
id|frag-&gt;nh.ipv6h-&gt;payload_len
op_assign
id|htons
c_func
(paren
id|frag-&gt;len
op_minus
r_sizeof
(paren
r_struct
id|ipv6hdr
)paren
)paren
suffix:semicolon
id|ip6_copy_metadata
c_func
(paren
id|frag
comma
id|skb
)paren
suffix:semicolon
)brace
id|err
op_assign
id|output
c_func
(paren
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_logical_or
op_logical_neg
id|frag
)paren
r_break
suffix:semicolon
id|skb
op_assign
id|frag
suffix:semicolon
id|frag
op_assign
id|skb-&gt;next
suffix:semicolon
id|skb-&gt;next
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tmp_hdr
)paren
id|kfree
c_func
(paren
id|tmp_hdr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_eq
l_int|0
)paren
(brace
id|IP6_INC_STATS
c_func
(paren
id|Ip6FragOKs
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_while
c_loop
(paren
id|frag
)paren
(brace
id|skb
op_assign
id|frag-&gt;next
suffix:semicolon
id|kfree_skb
c_func
(paren
id|frag
)paren
suffix:semicolon
id|frag
op_assign
id|skb
suffix:semicolon
)brace
id|IP6_INC_STATS
c_func
(paren
id|Ip6FragFails
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|slow_path
suffix:colon
id|left
op_assign
id|skb-&gt;len
op_minus
id|hlen
suffix:semicolon
multiline_comment|/* Space per frame */
id|ptr
op_assign
id|hlen
suffix:semicolon
multiline_comment|/* Where to start from */
multiline_comment|/*&n;&t; *&t;Fragment the datagram.&n;&t; */
op_star
id|prevhdr
op_assign
id|NEXTHDR_FRAGMENT
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Keep copying data until we run out.&n;&t; */
r_while
c_loop
(paren
id|left
OG
l_int|0
)paren
(brace
id|len
op_assign
id|left
suffix:semicolon
multiline_comment|/* IF: it doesn&squot;t fit, use &squot;mtu&squot; - the data space left */
r_if
c_cond
(paren
id|len
OG
id|mtu
)paren
id|len
op_assign
id|mtu
suffix:semicolon
multiline_comment|/* IF: we are not sending upto and including the packet end&n;&t;&t;   then align the next start on an eight byte boundary */
r_if
c_cond
(paren
id|len
OL
id|left
)paren
(brace
id|len
op_and_assign
op_complement
l_int|7
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; *&t;Allocate buffer.&n;&t;&t; */
r_if
c_cond
(paren
(paren
id|frag
op_assign
id|alloc_skb
c_func
(paren
id|len
op_plus
id|hlen
op_plus
r_sizeof
(paren
r_struct
id|frag_hdr
)paren
op_plus
id|LL_RESERVED_SPACE
c_func
(paren
id|rt-&gt;u.dst.dev
)paren
comma
id|GFP_ATOMIC
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|NETDEBUG
c_func
(paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;IPv6: frag: no memory for new fragment!&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|fail
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; *&t;Set up data on packet&n;&t;&t; */
id|ip6_copy_metadata
c_func
(paren
id|frag
comma
id|skb
)paren
suffix:semicolon
id|skb_reserve
c_func
(paren
id|frag
comma
id|LL_RESERVED_SPACE
c_func
(paren
id|rt-&gt;u.dst.dev
)paren
)paren
suffix:semicolon
id|skb_put
c_func
(paren
id|frag
comma
id|len
op_plus
id|hlen
op_plus
r_sizeof
(paren
r_struct
id|frag_hdr
)paren
)paren
suffix:semicolon
id|frag-&gt;nh.raw
op_assign
id|frag-&gt;data
suffix:semicolon
id|fh
op_assign
(paren
r_struct
id|frag_hdr
op_star
)paren
(paren
id|frag-&gt;data
op_plus
id|hlen
)paren
suffix:semicolon
id|frag-&gt;h.raw
op_assign
id|frag-&gt;data
op_plus
id|hlen
op_plus
r_sizeof
(paren
r_struct
id|frag_hdr
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; *&t;Charge the memory for the fragment to any owner&n;&t;&t; *&t;it might possess&n;&t;&t; */
r_if
c_cond
(paren
id|skb-&gt;sk
)paren
id|skb_set_owner_w
c_func
(paren
id|frag
comma
id|skb-&gt;sk
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; *&t;Copy the packet header into the new buffer.&n;&t;&t; */
id|memcpy
c_func
(paren
id|frag-&gt;nh.raw
comma
id|skb-&gt;data
comma
id|hlen
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; *&t;Build fragment header.&n;&t;&t; */
id|fh-&gt;nexthdr
op_assign
id|nexthdr
suffix:semicolon
id|fh-&gt;reserved
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|frag_id
)paren
(brace
id|ipv6_select_ident
c_func
(paren
id|skb
comma
id|fh
)paren
suffix:semicolon
id|frag_id
op_assign
id|fh-&gt;identification
suffix:semicolon
)brace
r_else
id|fh-&gt;identification
op_assign
id|frag_id
suffix:semicolon
multiline_comment|/*&n;&t;&t; *&t;Copy a block of the IP datagram.&n;&t;&t; */
r_if
c_cond
(paren
id|skb_copy_bits
c_func
(paren
id|skb
comma
id|ptr
comma
id|frag-&gt;h.raw
comma
id|len
)paren
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
id|left
op_sub_assign
id|len
suffix:semicolon
id|fh-&gt;frag_off
op_assign
id|htons
c_func
(paren
id|offset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|left
OG
l_int|0
)paren
id|fh-&gt;frag_off
op_or_assign
id|htons
c_func
(paren
id|IP6_MF
)paren
suffix:semicolon
id|frag-&gt;nh.ipv6h-&gt;payload_len
op_assign
id|htons
c_func
(paren
id|frag-&gt;len
op_minus
r_sizeof
(paren
r_struct
id|ipv6hdr
)paren
)paren
suffix:semicolon
id|ptr
op_add_assign
id|len
suffix:semicolon
id|offset
op_add_assign
id|len
suffix:semicolon
multiline_comment|/*&n;&t;&t; *&t;Put this fragment into the sending queue.&n;&t;&t; */
id|IP6_INC_STATS
c_func
(paren
id|Ip6FragCreates
)paren
suffix:semicolon
id|err
op_assign
id|output
c_func
(paren
id|frag
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|fail
suffix:semicolon
)brace
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|IP6_INC_STATS
c_func
(paren
id|Ip6FragOKs
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
id|fail
suffix:colon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|IP6_INC_STATS
c_func
(paren
id|Ip6FragFails
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|ip6_dst_lookup
r_struct
id|dst_entry
op_star
id|ip6_dst_lookup
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_struct
id|flowi
op_star
id|fl
)paren
(brace
r_struct
id|dst_entry
op_star
id|dst
op_assign
l_int|NULL
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|sk
)paren
(brace
r_struct
id|ipv6_pinfo
op_star
id|np
op_assign
id|inet6_sk
c_func
(paren
id|sk
)paren
suffix:semicolon
id|dst
op_assign
id|__sk_dst_check
c_func
(paren
id|sk
comma
id|np-&gt;dst_cookie
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dst
)paren
(brace
r_struct
id|rt6_info
op_star
id|rt
op_assign
(paren
r_struct
id|rt6_info
op_star
)paren
id|dst
suffix:semicolon
multiline_comment|/* Yes, checking route validity in not connected&n;&t;&t;&t;&t;   case is not very simple. Take into account,&n;&t;&t;&t;&t;   that we do not support routing by source, TOS,&n;&t;&t;&t;&t;   and MSG_DONTROUTE &t;&t;--ANK (980726)&n;&t;&n;&t;&t;&t;&t;   1. If route was host route, check that&n;&t;&t;&t;&t;      cached destination is current.&n;&t;&t;&t;&t;      If it is network route, we still may&n;&t;&t;&t;&t;      check its validity using saved pointer&n;&t;&t;&t;&t;      to the last used address: daddr_cache.&n;&t;&t;&t;&t;      We do not want to save whole address now,&n;&t;&t;&t;&t;      (because main consumer of this service&n;&t;&t;&t;&t;       is tcp, which has not this problem),&n;&t;&t;&t;&t;      so that the last trick works only on connected&n;&t;&t;&t;&t;      sockets.&n;&t;&t;&t;&t;   2. oif also should be the same.&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
(paren
(paren
id|rt-&gt;rt6i_dst.plen
op_ne
l_int|128
op_logical_or
id|ipv6_addr_cmp
c_func
(paren
op_amp
id|fl-&gt;fl6_dst
comma
op_amp
id|rt-&gt;rt6i_dst.addr
)paren
)paren
op_logical_and
(paren
id|np-&gt;daddr_cache
op_eq
l_int|NULL
op_logical_or
id|ipv6_addr_cmp
c_func
(paren
op_amp
id|fl-&gt;fl6_dst
comma
id|np-&gt;daddr_cache
)paren
)paren
)paren
op_logical_or
(paren
id|fl-&gt;oif
op_logical_and
id|fl-&gt;oif
op_ne
id|dst-&gt;dev-&gt;ifindex
)paren
)paren
(brace
id|dst
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
id|dst_hold
c_func
(paren
id|dst
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|dst
op_eq
l_int|NULL
)paren
id|dst
op_assign
id|ip6_route_output
c_func
(paren
id|sk
comma
id|fl
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dst-&gt;error
)paren
r_return
id|dst
suffix:semicolon
r_if
c_cond
(paren
id|ipv6_addr_any
c_func
(paren
op_amp
id|fl-&gt;fl6_src
)paren
)paren
(brace
id|err
op_assign
id|ipv6_get_saddr
c_func
(paren
id|dst
comma
op_amp
id|fl-&gt;fl6_dst
comma
op_amp
id|fl-&gt;fl6_src
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
macro_line|#if IP6_DEBUG &gt;= 2
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;ip6_build_xmit: &quot;
l_string|&quot;no available source address&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|dst-&gt;error
op_assign
id|err
suffix:semicolon
r_return
id|dst
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|dst
)paren
(brace
r_if
c_cond
(paren
(paren
id|err
op_assign
id|xfrm_lookup
c_func
(paren
op_amp
id|dst
comma
id|fl
comma
id|sk
comma
l_int|0
)paren
)paren
OL
l_int|0
)paren
(brace
id|dst-&gt;error
op_assign
op_minus
id|ENETUNREACH
suffix:semicolon
)brace
)brace
r_return
id|dst
suffix:semicolon
)brace
DECL|function|ip6_append_data
r_int
id|ip6_append_data
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_int
id|getfrag
c_func
(paren
r_void
op_star
id|from
comma
r_char
op_star
id|to
comma
r_int
id|offset
comma
r_int
id|len
comma
r_int
id|odd
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
comma
r_void
op_star
id|from
comma
r_int
id|length
comma
r_int
id|transhdrlen
comma
r_int
id|hlimit
comma
r_struct
id|ipv6_txoptions
op_star
id|opt
comma
r_struct
id|flowi
op_star
id|fl
comma
r_struct
id|rt6_info
op_star
id|rt
comma
r_int
r_int
id|flags
)paren
(brace
r_struct
id|inet_opt
op_star
id|inet
op_assign
id|inet_sk
c_func
(paren
id|sk
)paren
suffix:semicolon
r_struct
id|ipv6_pinfo
op_star
id|np
op_assign
id|inet6_sk
c_func
(paren
id|sk
)paren
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
r_int
id|maxfraglen
comma
id|fragheaderlen
suffix:semicolon
r_int
id|exthdrlen
suffix:semicolon
r_int
id|hh_len
suffix:semicolon
r_int
id|mtu
suffix:semicolon
r_int
id|copy
op_assign
l_int|0
suffix:semicolon
r_int
id|err
suffix:semicolon
r_int
id|offset
op_assign
l_int|0
suffix:semicolon
r_int
id|csummode
op_assign
id|CHECKSUM_NONE
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
id|MSG_PROBE
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|skb_queue_empty
c_func
(paren
op_amp
id|sk-&gt;sk_write_queue
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t; * setup for corking&n;&t;&t; */
r_if
c_cond
(paren
id|opt
)paren
(brace
r_if
c_cond
(paren
id|np-&gt;cork.opt
op_eq
l_int|NULL
)paren
id|np-&gt;cork.opt
op_assign
id|kmalloc
c_func
(paren
id|opt-&gt;tot_len
comma
id|sk-&gt;sk_allocation
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|np-&gt;cork.opt
comma
id|opt
comma
id|opt-&gt;tot_len
)paren
suffix:semicolon
id|inet-&gt;cork.flags
op_or_assign
id|IPCORK_OPT
suffix:semicolon
multiline_comment|/* need source address above miyazawa*/
)brace
id|dst_hold
c_func
(paren
op_amp
id|rt-&gt;u.dst
)paren
suffix:semicolon
id|np-&gt;cork.rt
op_assign
id|rt
suffix:semicolon
id|np-&gt;cork.fl
op_assign
id|fl
suffix:semicolon
id|np-&gt;cork.hop_limit
op_assign
id|hlimit
suffix:semicolon
id|inet-&gt;cork.fragsize
op_assign
id|mtu
op_assign
id|dst_pmtu
c_func
(paren
op_amp
id|rt-&gt;u.dst
)paren
suffix:semicolon
id|inet-&gt;cork.length
op_assign
l_int|0
suffix:semicolon
id|inet-&gt;sndmsg_page
op_assign
l_int|NULL
suffix:semicolon
id|inet-&gt;sndmsg_off
op_assign
l_int|0
suffix:semicolon
id|exthdrlen
op_assign
id|rt-&gt;u.dst.header_len
op_plus
(paren
id|opt
ques
c_cond
id|opt-&gt;opt_flen
suffix:colon
l_int|0
)paren
suffix:semicolon
id|length
op_add_assign
id|exthdrlen
suffix:semicolon
id|transhdrlen
op_add_assign
id|exthdrlen
suffix:semicolon
)brace
r_else
(brace
id|rt
op_assign
id|np-&gt;cork.rt
suffix:semicolon
r_if
c_cond
(paren
id|inet-&gt;cork.flags
op_amp
id|IPCORK_OPT
)paren
id|opt
op_assign
id|np-&gt;cork.opt
suffix:semicolon
id|transhdrlen
op_assign
l_int|0
suffix:semicolon
id|exthdrlen
op_assign
l_int|0
suffix:semicolon
id|mtu
op_assign
id|inet-&gt;cork.fragsize
suffix:semicolon
)brace
id|hh_len
op_assign
(paren
id|rt-&gt;u.dst.dev-&gt;hard_header_len
op_amp
op_complement
l_int|15
)paren
op_plus
l_int|16
suffix:semicolon
id|fragheaderlen
op_assign
r_sizeof
(paren
r_struct
id|ipv6hdr
)paren
op_plus
(paren
id|opt
ques
c_cond
id|opt-&gt;opt_nflen
suffix:colon
l_int|0
)paren
suffix:semicolon
id|maxfraglen
op_assign
(paren
(paren
id|mtu
op_minus
id|fragheaderlen
)paren
op_amp
op_complement
l_int|7
)paren
op_plus
id|fragheaderlen
op_minus
r_sizeof
(paren
r_struct
id|frag_hdr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mtu
op_le
r_sizeof
(paren
r_struct
id|ipv6hdr
)paren
op_plus
id|IPV6_MAXPLEN
)paren
(brace
r_if
c_cond
(paren
id|inet-&gt;cork.length
op_plus
id|length
OG
r_sizeof
(paren
r_struct
id|ipv6hdr
)paren
op_plus
id|IPV6_MAXPLEN
op_minus
id|fragheaderlen
)paren
(brace
id|ipv6_local_error
c_func
(paren
id|sk
comma
id|EMSGSIZE
comma
id|fl
comma
id|mtu
op_minus
id|exthdrlen
)paren
suffix:semicolon
r_return
op_minus
id|EMSGSIZE
suffix:semicolon
)brace
)brace
id|inet-&gt;cork.length
op_add_assign
id|length
suffix:semicolon
r_if
c_cond
(paren
(paren
id|skb
op_assign
id|skb_peek_tail
c_func
(paren
op_amp
id|sk-&gt;sk_write_queue
)paren
)paren
op_eq
l_int|NULL
)paren
r_goto
id|alloc_new_skb
suffix:semicolon
r_while
c_loop
(paren
id|length
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
(paren
id|copy
op_assign
id|maxfraglen
op_minus
id|skb-&gt;len
)paren
op_le
l_int|0
)paren
(brace
r_char
op_star
id|data
suffix:semicolon
r_int
r_int
id|datalen
suffix:semicolon
r_int
r_int
id|fraglen
suffix:semicolon
r_int
r_int
id|alloclen
suffix:semicolon
id|BUG_TRAP
c_func
(paren
id|copy
op_eq
l_int|0
)paren
suffix:semicolon
id|alloc_new_skb
suffix:colon
id|datalen
op_assign
id|maxfraglen
op_minus
id|fragheaderlen
suffix:semicolon
r_if
c_cond
(paren
id|datalen
OG
id|length
)paren
id|datalen
op_assign
id|length
suffix:semicolon
id|fraglen
op_assign
id|datalen
op_plus
id|fragheaderlen
suffix:semicolon
r_if
c_cond
(paren
(paren
id|flags
op_amp
id|MSG_MORE
)paren
op_logical_and
op_logical_neg
(paren
id|rt-&gt;u.dst.dev-&gt;features
op_amp
id|NETIF_F_SG
)paren
)paren
id|alloclen
op_assign
id|maxfraglen
suffix:semicolon
r_else
id|alloclen
op_assign
id|fraglen
suffix:semicolon
id|alloclen
op_add_assign
r_sizeof
(paren
r_struct
id|frag_hdr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|transhdrlen
)paren
(brace
id|skb
op_assign
id|sock_alloc_send_skb
c_func
(paren
id|sk
comma
id|alloclen
op_plus
id|hh_len
op_plus
l_int|15
comma
(paren
id|flags
op_amp
id|MSG_DONTWAIT
)paren
comma
op_amp
id|err
)paren
suffix:semicolon
)brace
r_else
(brace
id|skb
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|sk-&gt;sk_wmem_alloc
)paren
op_le
l_int|2
op_star
id|sk-&gt;sk_sndbuf
)paren
id|skb
op_assign
id|sock_wmalloc
c_func
(paren
id|sk
comma
id|alloclen
op_plus
id|hh_len
op_plus
l_int|15
comma
l_int|1
comma
id|sk-&gt;sk_allocation
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|skb
op_eq
l_int|NULL
)paren
)paren
id|err
op_assign
op_minus
id|ENOBUFS
suffix:semicolon
)brace
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
r_goto
id|error
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; *&t;Fill in the control structures&n;&t;&t;&t; */
id|skb-&gt;ip_summed
op_assign
id|csummode
suffix:semicolon
id|skb-&gt;csum
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* reserve 8 byte for fragmentation */
id|skb_reserve
c_func
(paren
id|skb
comma
id|hh_len
op_plus
r_sizeof
(paren
r_struct
id|frag_hdr
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; *&t;Find where to start putting bytes&n;&t;&t;&t; */
id|data
op_assign
id|skb_put
c_func
(paren
id|skb
comma
id|fraglen
)paren
suffix:semicolon
id|skb-&gt;nh.raw
op_assign
id|data
op_plus
id|exthdrlen
suffix:semicolon
id|data
op_add_assign
id|fragheaderlen
suffix:semicolon
id|skb-&gt;h.raw
op_assign
id|data
op_plus
id|exthdrlen
suffix:semicolon
id|copy
op_assign
id|datalen
op_minus
id|transhdrlen
suffix:semicolon
r_if
c_cond
(paren
id|copy
OG
l_int|0
op_logical_and
id|getfrag
c_func
(paren
id|from
comma
id|data
op_plus
id|transhdrlen
comma
id|offset
comma
id|copy
comma
l_int|0
comma
id|skb
)paren
OL
l_int|0
)paren
(brace
id|err
op_assign
op_minus
id|EFAULT
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
id|offset
op_add_assign
id|copy
suffix:semicolon
id|length
op_sub_assign
id|datalen
suffix:semicolon
id|transhdrlen
op_assign
l_int|0
suffix:semicolon
id|exthdrlen
op_assign
l_int|0
suffix:semicolon
id|csummode
op_assign
id|CHECKSUM_NONE
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * Put the packet on the pending queue&n;&t;&t;&t; */
id|__skb_queue_tail
c_func
(paren
op_amp
id|sk-&gt;sk_write_queue
comma
id|skb
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy
OG
id|length
)paren
id|copy
op_assign
id|length
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|rt-&gt;u.dst.dev-&gt;features
op_amp
id|NETIF_F_SG
)paren
)paren
(brace
r_int
r_int
id|off
suffix:semicolon
id|off
op_assign
id|skb-&gt;len
suffix:semicolon
r_if
c_cond
(paren
id|getfrag
c_func
(paren
id|from
comma
id|skb_put
c_func
(paren
id|skb
comma
id|copy
)paren
comma
id|offset
comma
id|copy
comma
id|off
comma
id|skb
)paren
OL
l_int|0
)paren
(brace
id|__skb_trim
c_func
(paren
id|skb
comma
id|off
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
)brace
r_else
(brace
r_int
id|i
op_assign
id|skb_shinfo
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|nr_frags
suffix:semicolon
id|skb_frag_t
op_star
id|frag
op_assign
op_amp
id|skb_shinfo
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|frags
(braket
id|i
op_minus
l_int|1
)braket
suffix:semicolon
r_struct
id|page
op_star
id|page
op_assign
id|inet-&gt;sndmsg_page
suffix:semicolon
r_int
id|off
op_assign
id|inet-&gt;sndmsg_off
suffix:semicolon
r_int
r_int
id|left
suffix:semicolon
r_if
c_cond
(paren
id|page
op_logical_and
(paren
id|left
op_assign
id|PAGE_SIZE
op_minus
id|off
)paren
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|copy
op_ge
id|left
)paren
id|copy
op_assign
id|left
suffix:semicolon
r_if
c_cond
(paren
id|page
op_ne
id|frag-&gt;page
)paren
(brace
r_if
c_cond
(paren
id|i
op_eq
id|MAX_SKB_FRAGS
)paren
(brace
id|err
op_assign
op_minus
id|EMSGSIZE
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
id|get_page
c_func
(paren
id|page
)paren
suffix:semicolon
id|skb_fill_page_desc
c_func
(paren
id|skb
comma
id|i
comma
id|page
comma
id|inet-&gt;sndmsg_off
comma
l_int|0
)paren
suffix:semicolon
id|frag
op_assign
op_amp
id|skb_shinfo
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|frags
(braket
id|i
)braket
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|i
OL
id|MAX_SKB_FRAGS
)paren
(brace
r_if
c_cond
(paren
id|copy
OG
id|PAGE_SIZE
)paren
id|copy
op_assign
id|PAGE_SIZE
suffix:semicolon
id|page
op_assign
id|alloc_pages
c_func
(paren
id|sk-&gt;sk_allocation
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|page
op_eq
l_int|NULL
)paren
(brace
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
id|inet-&gt;sndmsg_page
op_assign
id|page
suffix:semicolon
id|inet-&gt;sndmsg_off
op_assign
l_int|0
suffix:semicolon
id|skb_fill_page_desc
c_func
(paren
id|skb
comma
id|i
comma
id|page
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|frag
op_assign
op_amp
id|skb_shinfo
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|frags
(braket
id|i
)braket
suffix:semicolon
id|skb-&gt;truesize
op_add_assign
id|PAGE_SIZE
suffix:semicolon
id|atomic_add
c_func
(paren
id|PAGE_SIZE
comma
op_amp
id|sk-&gt;sk_wmem_alloc
)paren
suffix:semicolon
)brace
r_else
(brace
id|err
op_assign
op_minus
id|EMSGSIZE
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
r_if
c_cond
(paren
id|getfrag
c_func
(paren
id|from
comma
id|page_address
c_func
(paren
id|frag-&gt;page
)paren
op_plus
id|frag-&gt;page_offset
op_plus
id|frag-&gt;size
comma
id|offset
comma
id|copy
comma
id|skb-&gt;len
comma
id|skb
)paren
OL
l_int|0
)paren
(brace
id|err
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
id|inet-&gt;sndmsg_off
op_add_assign
id|copy
suffix:semicolon
id|frag-&gt;size
op_add_assign
id|copy
suffix:semicolon
id|skb-&gt;len
op_add_assign
id|copy
suffix:semicolon
id|skb-&gt;data_len
op_add_assign
id|copy
suffix:semicolon
)brace
id|offset
op_add_assign
id|copy
suffix:semicolon
id|length
op_sub_assign
id|copy
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
id|error
suffix:colon
id|inet-&gt;cork.length
op_sub_assign
id|length
suffix:semicolon
id|IP6_INC_STATS
c_func
(paren
id|Ip6OutDiscards
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|ip6_push_pending_frames
r_int
id|ip6_push_pending_frames
c_func
(paren
r_struct
id|sock
op_star
id|sk
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
comma
op_star
id|tmp_skb
suffix:semicolon
r_struct
id|sk_buff
op_star
op_star
id|tail_skb
suffix:semicolon
r_struct
id|in6_addr
id|final_dst_buf
comma
op_star
id|final_dst
op_assign
op_amp
id|final_dst_buf
suffix:semicolon
r_struct
id|inet_opt
op_star
id|inet
op_assign
id|inet_sk
c_func
(paren
id|sk
)paren
suffix:semicolon
r_struct
id|ipv6_pinfo
op_star
id|np
op_assign
id|inet6_sk
c_func
(paren
id|sk
)paren
suffix:semicolon
r_struct
id|ipv6hdr
op_star
id|hdr
suffix:semicolon
r_struct
id|ipv6_txoptions
op_star
id|opt
op_assign
id|np-&gt;cork.opt
suffix:semicolon
r_struct
id|rt6_info
op_star
id|rt
op_assign
id|np-&gt;cork.rt
suffix:semicolon
r_struct
id|flowi
op_star
id|fl
op_assign
id|np-&gt;cork.fl
suffix:semicolon
r_int
r_char
id|proto
op_assign
id|fl-&gt;proto
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|skb
op_assign
id|__skb_dequeue
c_func
(paren
op_amp
id|sk-&gt;sk_write_queue
)paren
)paren
op_eq
l_int|NULL
)paren
r_goto
id|out
suffix:semicolon
id|tail_skb
op_assign
op_amp
(paren
id|skb_shinfo
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|frag_list
)paren
suffix:semicolon
multiline_comment|/* move skb-&gt;data to ip header from ext header */
r_if
c_cond
(paren
id|skb-&gt;data
OL
id|skb-&gt;nh.raw
)paren
id|__skb_pull
c_func
(paren
id|skb
comma
id|skb-&gt;nh.raw
op_minus
id|skb-&gt;data
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|tmp_skb
op_assign
id|__skb_dequeue
c_func
(paren
op_amp
id|sk-&gt;sk_write_queue
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|__skb_pull
c_func
(paren
id|tmp_skb
comma
id|skb-&gt;h.raw
op_minus
id|skb-&gt;nh.raw
)paren
suffix:semicolon
op_star
id|tail_skb
op_assign
id|tmp_skb
suffix:semicolon
id|tail_skb
op_assign
op_amp
(paren
id|tmp_skb-&gt;next
)paren
suffix:semicolon
id|skb-&gt;len
op_add_assign
id|tmp_skb-&gt;len
suffix:semicolon
id|skb-&gt;data_len
op_add_assign
id|tmp_skb-&gt;len
suffix:semicolon
macro_line|#if 0 /* Logically correct, but useless work, ip_fragment() will have to undo */
id|skb-&gt;truesize
op_add_assign
id|tmp_skb-&gt;truesize
suffix:semicolon
id|__sock_put
c_func
(paren
id|tmp_skb-&gt;sk
)paren
suffix:semicolon
id|tmp_skb-&gt;destructor
op_assign
l_int|NULL
suffix:semicolon
id|tmp_skb-&gt;sk
op_assign
l_int|NULL
suffix:semicolon
macro_line|#endif
)brace
id|ipv6_addr_copy
c_func
(paren
id|final_dst
comma
op_amp
id|fl-&gt;fl6_dst
)paren
suffix:semicolon
id|__skb_pull
c_func
(paren
id|skb
comma
id|skb-&gt;h.raw
op_minus
id|skb-&gt;nh.raw
)paren
suffix:semicolon
r_if
c_cond
(paren
id|opt
op_logical_and
id|opt-&gt;opt_flen
)paren
id|ipv6_push_frag_opts
c_func
(paren
id|skb
comma
id|opt
comma
op_amp
id|proto
)paren
suffix:semicolon
r_if
c_cond
(paren
id|opt
op_logical_and
id|opt-&gt;opt_nflen
)paren
id|ipv6_push_nfrag_opts
c_func
(paren
id|skb
comma
id|opt
comma
op_amp
id|proto
comma
op_amp
id|final_dst
)paren
suffix:semicolon
id|skb-&gt;nh.ipv6h
op_assign
id|hdr
op_assign
(paren
r_struct
id|ipv6hdr
op_star
)paren
id|skb_push
c_func
(paren
id|skb
comma
r_sizeof
(paren
r_struct
id|ipv6hdr
)paren
)paren
suffix:semicolon
op_star
(paren
id|u32
op_star
)paren
id|hdr
op_assign
id|fl-&gt;fl6_flowlabel
op_or
id|htonl
c_func
(paren
l_int|0x60000000
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;len
op_le
r_sizeof
(paren
r_struct
id|ipv6hdr
)paren
op_plus
id|IPV6_MAXPLEN
)paren
id|hdr-&gt;payload_len
op_assign
id|htons
c_func
(paren
id|skb-&gt;len
op_minus
r_sizeof
(paren
r_struct
id|ipv6hdr
)paren
)paren
suffix:semicolon
r_else
id|hdr-&gt;payload_len
op_assign
l_int|0
suffix:semicolon
id|hdr-&gt;hop_limit
op_assign
id|np-&gt;cork.hop_limit
suffix:semicolon
id|hdr-&gt;nexthdr
op_assign
id|proto
suffix:semicolon
id|ipv6_addr_copy
c_func
(paren
op_amp
id|hdr-&gt;saddr
comma
op_amp
id|fl-&gt;fl6_src
)paren
suffix:semicolon
id|ipv6_addr_copy
c_func
(paren
op_amp
id|hdr-&gt;daddr
comma
id|final_dst
)paren
suffix:semicolon
id|skb-&gt;dst
op_assign
id|dst_clone
c_func
(paren
op_amp
id|rt-&gt;u.dst
)paren
suffix:semicolon
id|err
op_assign
id|NF_HOOK
c_func
(paren
id|PF_INET6
comma
id|NF_IP6_LOCAL_OUT
comma
id|skb
comma
l_int|NULL
comma
id|skb-&gt;dst-&gt;dev
comma
id|dst_output
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
r_if
c_cond
(paren
id|err
OG
l_int|0
)paren
id|err
op_assign
id|inet-&gt;recverr
ques
c_cond
id|net_xmit_errno
c_func
(paren
id|err
)paren
suffix:colon
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|error
suffix:semicolon
)brace
id|out
suffix:colon
id|inet-&gt;cork.flags
op_and_assign
op_complement
id|IPCORK_OPT
suffix:semicolon
r_if
c_cond
(paren
id|np-&gt;cork.opt
)paren
(brace
id|kfree
c_func
(paren
id|np-&gt;cork.opt
)paren
suffix:semicolon
id|np-&gt;cork.opt
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|np-&gt;cork.rt
)paren
(brace
id|np-&gt;cork.rt
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|np-&gt;cork.fl
)paren
(brace
id|np-&gt;cork.fl
op_assign
l_int|NULL
suffix:semicolon
)brace
r_return
id|err
suffix:semicolon
id|error
suffix:colon
r_goto
id|out
suffix:semicolon
)brace
DECL|function|ip6_flush_pending_frames
r_void
id|ip6_flush_pending_frames
c_func
(paren
r_struct
id|sock
op_star
id|sk
)paren
(brace
r_struct
id|inet_opt
op_star
id|inet
op_assign
id|inet_sk
c_func
(paren
id|sk
)paren
suffix:semicolon
r_struct
id|ipv6_pinfo
op_star
id|np
op_assign
id|inet6_sk
c_func
(paren
id|sk
)paren
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_while
c_loop
(paren
(paren
id|skb
op_assign
id|__skb_dequeue_tail
c_func
(paren
op_amp
id|sk-&gt;sk_write_queue
)paren
)paren
op_ne
l_int|NULL
)paren
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|inet-&gt;cork.flags
op_and_assign
op_complement
id|IPCORK_OPT
suffix:semicolon
r_if
c_cond
(paren
id|np-&gt;cork.opt
)paren
(brace
id|kfree
c_func
(paren
id|np-&gt;cork.opt
)paren
suffix:semicolon
id|np-&gt;cork.opt
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|np-&gt;cork.rt
)paren
(brace
id|np-&gt;cork.rt
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|np-&gt;cork.fl
)paren
(brace
id|np-&gt;cork.fl
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
eof
