multiline_comment|/******************************************************************************&n; * vlanproc.c&t;VLAN Module. /proc filesystem interface.&n; *&n; *&t;&t;This module is completely hardware-independent and provides&n; *&t;&t;access to the router using Linux /proc filesystem.&n; *&n; * Author:&t;Ben Greear, &lt;greearb@candelatech.com&gt; coppied from wanproc.c&n; *               by: Gene Kozin&t;&lt;genek@compuserve.com&gt;&n; *&n; * Copyright:&t;(c) 1998 Ben Greear&n; *&n; *&t;&t;This program is free software; you can redistribute it and/or&n; *&t;&t;modify it under the terms of the GNU General Public License&n; *&t;&t;as published by the Free Software Foundation; either version&n; *&t;&t;2 of the License, or (at your option) any later version.&n; * ============================================================================&n; * Jan 20, 1998        Ben Greear     Initial Version&n; *****************************************************************************/
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/stddef.h&gt;&t;/* offsetof(), etc. */
macro_line|#include &lt;linux/errno.h&gt;&t;/* return codes */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/malloc.h&gt;&t;/* kmalloc(), kfree() */
macro_line|#include &lt;linux/mm.h&gt;&t;&t;/* verify_area(), etc. */
macro_line|#include &lt;linux/string.h&gt;&t;/* inline mem*, str* functions */
macro_line|#include &lt;linux/init.h&gt;&t;&t;/* __initfunc et al. */
macro_line|#include &lt;asm/segment.h&gt;&t;/* kernel &lt;-&gt; user copy */
macro_line|#include &lt;asm/byteorder.h&gt;&t;/* htons(), etc. */
macro_line|#include &lt;asm/uaccess.h&gt;&t;/* copy_to_user */
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/if_vlan.h&gt;
macro_line|#include &quot;vlanproc.h&quot;
macro_line|#include &quot;vlan.h&quot;
multiline_comment|/****** Function Prototypes *************************************************/
macro_line|#ifdef CONFIG_PROC_FS
multiline_comment|/* Proc filesystem interface */
r_static
id|ssize_t
id|vlan_proc_read
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
suffix:semicolon
multiline_comment|/* Methods for preparing data for reading proc entries */
r_static
r_int
id|vlan_config_get_info
c_func
(paren
r_char
op_star
id|buf
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offs
comma
r_int
id|len
)paren
suffix:semicolon
r_static
r_int
id|vlandev_get_info
c_func
(paren
r_char
op_star
id|buf
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offs
comma
r_int
id|len
)paren
suffix:semicolon
multiline_comment|/* Miscellaneous */
multiline_comment|/*&n; *&t;Global Data&n; */
multiline_comment|/*&n; *&t;Names of the proc directory entries &n; */
DECL|variable|name_root
r_static
r_char
id|name_root
(braket
)braket
op_assign
l_string|&quot;vlan&quot;
suffix:semicolon
DECL|variable|name_conf
r_static
r_char
id|name_conf
(braket
)braket
op_assign
l_string|&quot;config&quot;
suffix:semicolon
DECL|variable|term_msg
r_static
r_char
id|term_msg
(braket
)braket
op_assign
l_string|&quot;***KERNEL:  Out of buffer space!***&bslash;n&quot;
suffix:semicolon
multiline_comment|/*&n; *&t;Structures for interfacing with the /proc filesystem.&n; *&t;VLAN creates its own directory /proc/net/vlan with the folowing&n; *&t;entries:&n; *&t;config&t;&t;device status/configuration&n; *&t;&lt;device&gt;&t;entry for each  device&n; */
multiline_comment|/*&n; *&t;Generic /proc/net/vlan/&lt;file&gt; file and inode operations &n; */
DECL|variable|vlan_fops
r_static
r_struct
id|file_operations
id|vlan_fops
op_assign
(brace
id|read
suffix:colon
id|vlan_proc_read
comma
id|ioctl
suffix:colon
l_int|NULL
comma
multiline_comment|/* vlan_proc_ioctl */
)brace
suffix:semicolon
multiline_comment|/*&n; *&t;/proc/net/vlan/&lt;device&gt; file and inode operations&n; */
DECL|variable|vlandev_fops
r_static
r_struct
id|file_operations
id|vlandev_fops
op_assign
(brace
id|read
suffix:colon
id|vlan_proc_read
comma
id|ioctl
suffix:colon
l_int|NULL
comma
multiline_comment|/* vlan_proc_ioctl */
)brace
suffix:semicolon
multiline_comment|/*&n; * Proc filesystem derectory entries.&n; */
multiline_comment|/*&n; *&t;/proc/net/vlan &n; */
DECL|variable|proc_vlan_dir
r_static
r_struct
id|proc_dir_entry
op_star
id|proc_vlan_dir
suffix:semicolon
multiline_comment|/*&n; *&t;/proc/net/vlan/config &n; */
DECL|variable|proc_vlan_conf
r_static
r_struct
id|proc_dir_entry
op_star
id|proc_vlan_conf
suffix:semicolon
multiline_comment|/* Strings */
DECL|variable|conf_hdr
r_static
r_char
id|conf_hdr
(braket
)braket
op_assign
l_string|&quot;VLAN Dev name&t; | VLAN ID&bslash;n&quot;
suffix:semicolon
multiline_comment|/*&n; *&t;Interface functions&n; */
multiline_comment|/*&n; *&t;Clean up /proc/net/vlan entries&n; */
DECL|function|vlan_proc_cleanup
r_void
id|__exit
id|vlan_proc_cleanup
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|proc_vlan_conf
)paren
id|remove_proc_entry
c_func
(paren
id|name_conf
comma
id|proc_vlan_dir
)paren
suffix:semicolon
r_if
c_cond
(paren
id|proc_vlan_dir
)paren
id|proc_net_remove
c_func
(paren
id|name_root
)paren
suffix:semicolon
multiline_comment|/* Dynamically added entries should be cleaned up as their vlan_device&n;&t; * is removed, so we should not have to take care of it here...&n;&t; */
)brace
multiline_comment|/*&n; *&t;Create /proc/net/vlan entries&n; */
DECL|function|vlan_proc_init
r_int
id|__init
id|vlan_proc_init
c_func
(paren
r_void
)paren
(brace
id|proc_vlan_dir
op_assign
id|proc_mkdir
c_func
(paren
id|name_root
comma
id|proc_net
)paren
suffix:semicolon
r_if
c_cond
(paren
id|proc_vlan_dir
)paren
(brace
id|proc_vlan_conf
op_assign
id|create_proc_entry
c_func
(paren
id|name_conf
comma
id|S_IFREG
op_or
id|S_IRUSR
op_or
id|S_IWUSR
comma
id|proc_vlan_dir
)paren
suffix:semicolon
r_if
c_cond
(paren
id|proc_vlan_conf
)paren
(brace
id|proc_vlan_conf-&gt;proc_fops
op_assign
op_amp
id|vlan_fops
suffix:semicolon
id|proc_vlan_conf-&gt;get_info
op_assign
id|vlan_config_get_info
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
id|vlan_proc_cleanup
c_func
(paren
)paren
suffix:semicolon
r_return
op_minus
id|ENOBUFS
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Add directory entry for VLAN device.&n; */
DECL|function|vlan_proc_add_dev
r_int
id|vlan_proc_add_dev
(paren
r_struct
id|net_device
op_star
id|vlandev
)paren
(brace
r_struct
id|vlan_dev_info
op_star
id|dev_info
op_assign
id|VLAN_DEV_INFO
c_func
(paren
id|vlandev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|vlandev-&gt;priv_flags
op_amp
id|IFF_802_1Q_VLAN
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ERROR:&t;vlan_proc_add, device -:%s:- is NOT a VLAN&bslash;n&quot;
comma
id|vlandev-&gt;name
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|dev_info-&gt;dent
op_assign
id|create_proc_entry
c_func
(paren
id|vlandev-&gt;name
comma
id|S_IFREG
op_or
id|S_IRUSR
op_or
id|S_IWUSR
comma
id|proc_vlan_dir
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev_info-&gt;dent
)paren
r_return
op_minus
id|ENOBUFS
suffix:semicolon
id|dev_info-&gt;dent-&gt;proc_fops
op_assign
op_amp
id|vlandev_fops
suffix:semicolon
id|dev_info-&gt;dent-&gt;get_info
op_assign
op_amp
id|vlandev_get_info
suffix:semicolon
id|dev_info-&gt;dent-&gt;data
op_assign
id|vlandev
suffix:semicolon
macro_line|#ifdef VLAN_DEBUG
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;vlan_proc_add, device -:%s:- being added.&bslash;n&quot;
comma
id|vlandev-&gt;name
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Delete directory entry for VLAN device.&n; */
DECL|function|vlan_proc_rem_dev
r_int
id|vlan_proc_rem_dev
c_func
(paren
r_struct
id|net_device
op_star
id|vlandev
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|vlandev
)paren
(brace
id|printk
c_func
(paren
id|VLAN_ERR
id|__FUNCTION__
l_string|&quot;: invalid argument: %p&bslash;n&quot;
comma
id|vlandev
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|vlandev-&gt;priv_flags
op_amp
id|IFF_802_1Q_VLAN
)paren
)paren
(brace
id|printk
c_func
(paren
id|VLAN_DBG
id|__FUNCTION__
l_string|&quot;: invalid argument, device: %s is not a VLAN device, priv_flags: 0x%4hX.&bslash;n&quot;
comma
id|vlandev-&gt;name
comma
id|vlandev-&gt;priv_flags
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
macro_line|#ifdef VLAN_DEBUG
id|printk
c_func
(paren
id|VLAN_DBG
id|__FUNCTION__
l_string|&quot;: dev: %p&bslash;n&quot;
comma
id|vlandev
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/** NOTE:  This will consume the memory pointed to by dent, it seems. */
id|remove_proc_entry
c_func
(paren
id|VLAN_DEV_INFO
c_func
(paren
id|vlandev
)paren
op_member_access_from_pointer
id|dent-&gt;name
comma
id|proc_vlan_dir
)paren
suffix:semicolon
id|VLAN_DEV_INFO
c_func
(paren
id|vlandev
)paren
op_member_access_from_pointer
id|dent
op_assign
l_int|NULL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/****** Proc filesystem entry points ****************************************/
multiline_comment|/*&n; *&t;Read VLAN proc directory entry.&n; *&t;This is universal routine for reading all entries in /proc/net/vlan&n; *&t;directory.  Each directory entry contains a pointer to the &squot;method&squot; for&n; *&t;preparing data for that entry.&n; *&t;o verify arguments&n; *&t;o allocate kernel buffer&n; *&t;o call get_info() to prepare data&n; *&t;o copy data to user space&n; *&t;o release kernel buffer&n; *&n; *&t;Return:&t;number of bytes copied to user space (0, if no data)&n; *&t;&t;&lt;0&t;error&n; */
DECL|function|vlan_proc_read
r_static
id|ssize_t
id|vlan_proc_read
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_struct
id|inode
op_star
id|inode
op_assign
id|file-&gt;f_dentry-&gt;d_inode
suffix:semicolon
r_struct
id|proc_dir_entry
op_star
id|dent
suffix:semicolon
r_char
op_star
id|page
suffix:semicolon
r_int
id|pos
comma
id|offs
comma
id|len
suffix:semicolon
r_if
c_cond
(paren
id|count
op_le
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
id|dent
op_assign
id|inode-&gt;u.generic_ip
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dent
op_eq
l_int|NULL
)paren
op_logical_or
(paren
id|dent-&gt;get_info
op_eq
l_int|NULL
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|page
op_assign
id|kmalloc
c_func
(paren
id|VLAN_PROC_BUFSZ
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|VLAN_MEM_DBG
c_func
(paren
l_string|&quot;page malloc, addr: %p  size: %i&bslash;n&quot;
comma
id|page
comma
id|VLAN_PROC_BUFSZ
)paren
suffix:semicolon
r_if
c_cond
(paren
id|page
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOBUFS
suffix:semicolon
id|pos
op_assign
id|dent
op_member_access_from_pointer
id|get_info
c_func
(paren
id|page
comma
id|dent-&gt;data
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|offs
op_assign
id|file-&gt;f_pos
suffix:semicolon
r_if
c_cond
(paren
id|offs
OL
id|pos
)paren
(brace
id|len
op_assign
id|min_t
c_func
(paren
r_int
comma
id|pos
op_minus
id|offs
comma
id|count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|buf
comma
(paren
id|page
op_plus
id|offs
)paren
comma
id|len
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|file-&gt;f_pos
op_add_assign
id|len
suffix:semicolon
)brace
r_else
(brace
id|len
op_assign
l_int|0
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|page
)paren
suffix:semicolon
id|VLAN_FMEM_DBG
c_func
(paren
l_string|&quot;page free, addr: %p&bslash;n&quot;
comma
id|page
)paren
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
multiline_comment|/*&n; * The following few functions build the content of /proc/net/vlan/config&n; */
DECL|function|vlan_proc_get_vlan_info
r_static
r_int
id|vlan_proc_get_vlan_info
c_func
(paren
r_char
op_star
id|buf
comma
r_int
r_int
id|cnt
)paren
(brace
r_struct
id|net_device
op_star
id|vlandev
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|vlan_group
op_star
id|grp
op_assign
l_int|NULL
suffix:semicolon
r_int
id|i
op_assign
l_int|0
suffix:semicolon
r_char
op_star
id|nm_type
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|vlan_dev_info
op_star
id|dev_info
op_assign
l_int|NULL
suffix:semicolon
macro_line|#ifdef VLAN_DEBUG
id|printk
c_func
(paren
id|VLAN_DBG
id|__FUNCTION__
l_string|&quot;: cnt == %i&bslash;n&quot;
comma
id|cnt
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|vlan_name_type
op_eq
id|VLAN_NAME_TYPE_RAW_PLUS_VID
)paren
(brace
id|nm_type
op_assign
l_string|&quot;VLAN_NAME_TYPE_RAW_PLUS_VID&quot;
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|vlan_name_type
op_eq
id|VLAN_NAME_TYPE_PLUS_VID_NO_PAD
)paren
(brace
id|nm_type
op_assign
l_string|&quot;VLAN_NAME_TYPE_PLUS_VID_NO_PAD&quot;
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|vlan_name_type
op_eq
id|VLAN_NAME_TYPE_RAW_PLUS_VID_NO_PAD
)paren
(brace
id|nm_type
op_assign
l_string|&quot;VLAN_NAME_TYPE_RAW_PLUS_VID_NO_PAD&quot;
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|vlan_name_type
op_eq
id|VLAN_NAME_TYPE_PLUS_VID
)paren
(brace
id|nm_type
op_assign
l_string|&quot;VLAN_NAME_TYPE_PLUS_VID&quot;
suffix:semicolon
)brace
r_else
(brace
id|nm_type
op_assign
l_string|&quot;UNKNOWN&quot;
suffix:semicolon
)brace
id|cnt
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|cnt
comma
l_string|&quot;Name-Type: %s  bad_proto_recvd: %lu&bslash;n&quot;
comma
id|nm_type
comma
id|vlan_bad_proto_recvd
)paren
suffix:semicolon
r_for
c_loop
(paren
id|grp
op_assign
id|p802_1Q_vlan_list
suffix:semicolon
id|grp
op_ne
l_int|NULL
suffix:semicolon
id|grp
op_assign
id|grp-&gt;next
)paren
(brace
multiline_comment|/* loop through all devices for this device */
macro_line|#ifdef VLAN_DEBUG
id|printk
c_func
(paren
id|VLAN_DBG
id|__FUNCTION__
l_string|&quot;: found a group, addr: %p&bslash;n&quot;
comma
id|grp
)paren
suffix:semicolon
macro_line|#endif
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|VLAN_GROUP_ARRAY_LEN
suffix:semicolon
id|i
op_increment
)paren
(brace
id|vlandev
op_assign
id|grp-&gt;vlan_devices
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|vlandev
)paren
r_continue
suffix:semicolon
macro_line|#ifdef VLAN_DEBUG
id|printk
c_func
(paren
id|VLAN_DBG
id|__FUNCTION__
l_string|&quot;: found a vlan_dev, addr: %p&bslash;n&quot;
comma
id|vlandev
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|cnt
op_plus
l_int|100
)paren
OG
id|VLAN_PROC_BUFSZ
)paren
(brace
r_if
c_cond
(paren
(paren
id|cnt
op_plus
id|strlen
c_func
(paren
id|term_msg
)paren
)paren
OL
id|VLAN_PROC_BUFSZ
)paren
id|cnt
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|cnt
comma
l_string|&quot;%s&quot;
comma
id|term_msg
)paren
suffix:semicolon
r_return
id|cnt
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|vlandev-&gt;priv
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|__FUNCTION__
l_string|&quot;: ERROR: vlandev-&gt;priv is NULL&bslash;n&quot;
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|dev_info
op_assign
id|VLAN_DEV_INFO
c_func
(paren
id|vlandev
)paren
suffix:semicolon
macro_line|#ifdef VLAN_DEBUG
id|printk
c_func
(paren
id|VLAN_DBG
id|__FUNCTION__
l_string|&quot;: got a good vlandev, addr: %p&bslash;n&quot;
comma
id|VLAN_DEV_INFO
c_func
(paren
id|vlandev
)paren
)paren
suffix:semicolon
macro_line|#endif
id|cnt
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|cnt
comma
l_string|&quot;%-15s| %d  | %s&bslash;n&quot;
comma
id|vlandev-&gt;name
comma
id|dev_info-&gt;vlan_id
comma
id|dev_info-&gt;real_dev-&gt;name
)paren
suffix:semicolon
)brace
)brace
r_return
id|cnt
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Prepare data for reading &squot;Config&squot; entry.&n; *&t;Return length of data.&n; */
DECL|function|vlan_config_get_info
r_static
r_int
id|vlan_config_get_info
c_func
(paren
r_char
op_star
id|buf
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offs
comma
r_int
id|len
)paren
(brace
id|strcpy
c_func
(paren
id|buf
comma
id|conf_hdr
)paren
suffix:semicolon
r_return
id|vlan_proc_get_vlan_info
c_func
(paren
id|buf
comma
(paren
r_int
r_int
)paren
(paren
id|strlen
c_func
(paren
id|conf_hdr
)paren
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Prepare data for reading &lt;device&gt; entry.&n; *&t;Return length of data.&n; *&n; *&t;On entry, the &squot;start&squot; argument will contain a pointer to VLAN device&n; *&t;data space.&n; */
DECL|function|vlandev_get_info
r_static
r_int
id|vlandev_get_info
c_func
(paren
r_char
op_star
id|buf
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offs
comma
r_int
id|len
)paren
(brace
r_struct
id|net_device
op_star
id|vlandev
op_assign
(paren
r_void
op_star
)paren
id|start
suffix:semicolon
r_struct
id|net_device_stats
op_star
id|stats
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|vlan_dev_info
op_star
id|dev_info
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|vlan_priority_tci_mapping
op_star
id|mp
suffix:semicolon
r_int
id|cnt
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
macro_line|#ifdef VLAN_DEBUG
id|printk
c_func
(paren
id|VLAN_DBG
id|__FUNCTION__
l_string|&quot;: vlandev: %p&bslash;n&quot;
comma
id|vlandev
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|vlandev
op_eq
l_int|NULL
)paren
op_logical_or
(paren
op_logical_neg
id|vlandev-&gt;priv_flags
op_amp
id|IFF_802_1Q_VLAN
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|dev_info
op_assign
id|VLAN_DEV_INFO
c_func
(paren
id|vlandev
)paren
suffix:semicolon
id|cnt
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|cnt
comma
l_string|&quot;%s  VID: %d&t; REORDER_HDR: %i  dev-&gt;priv_flags: %hx&bslash;n&quot;
comma
id|vlandev-&gt;name
comma
id|dev_info-&gt;vlan_id
comma
(paren
r_int
)paren
(paren
id|dev_info-&gt;flags
op_amp
l_int|1
)paren
comma
id|vlandev-&gt;priv_flags
)paren
suffix:semicolon
id|stats
op_assign
id|vlan_dev_get_stats
c_func
(paren
id|vlandev
)paren
suffix:semicolon
id|cnt
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|cnt
comma
l_string|&quot;%30s: %12lu&bslash;n&quot;
comma
l_string|&quot;total frames received&quot;
comma
id|stats-&gt;rx_packets
)paren
suffix:semicolon
id|cnt
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|cnt
comma
l_string|&quot;%30s: %12lu&bslash;n&quot;
comma
l_string|&quot;total bytes received&quot;
comma
id|stats-&gt;rx_bytes
)paren
suffix:semicolon
id|cnt
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|cnt
comma
l_string|&quot;%30s: %12lu&bslash;n&quot;
comma
l_string|&quot;Broadcast/Multicast Rcvd&quot;
comma
id|stats-&gt;multicast
)paren
suffix:semicolon
id|cnt
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|cnt
comma
l_string|&quot;&bslash;n%30s: %12lu&bslash;n&quot;
comma
l_string|&quot;total frames transmitted&quot;
comma
id|stats-&gt;tx_packets
)paren
suffix:semicolon
id|cnt
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|cnt
comma
l_string|&quot;%30s: %12lu&bslash;n&quot;
comma
l_string|&quot;total bytes transmitted&quot;
comma
id|stats-&gt;tx_bytes
)paren
suffix:semicolon
id|cnt
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|cnt
comma
l_string|&quot;%30s: %12lu&bslash;n&quot;
comma
l_string|&quot;total headroom inc&quot;
comma
id|dev_info-&gt;cnt_inc_headroom_on_tx
)paren
suffix:semicolon
id|cnt
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|cnt
comma
l_string|&quot;%30s: %12lu&bslash;n&quot;
comma
l_string|&quot;total encap on xmit&quot;
comma
id|dev_info-&gt;cnt_encap_on_xmit
)paren
suffix:semicolon
id|cnt
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|cnt
comma
l_string|&quot;Device: %s&quot;
comma
id|dev_info-&gt;real_dev-&gt;name
)paren
suffix:semicolon
multiline_comment|/* now show all PRIORITY mappings relating to this VLAN */
id|cnt
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|cnt
comma
l_string|&quot;&bslash;nINGRESS priority mappings: 0:%lu  1:%lu  2:%lu  3:%lu  4:%lu  5:%lu  6:%lu 7:%lu&bslash;n&quot;
comma
id|dev_info-&gt;ingress_priority_map
(braket
l_int|0
)braket
comma
id|dev_info-&gt;ingress_priority_map
(braket
l_int|1
)braket
comma
id|dev_info-&gt;ingress_priority_map
(braket
l_int|2
)braket
comma
id|dev_info-&gt;ingress_priority_map
(braket
l_int|3
)braket
comma
id|dev_info-&gt;ingress_priority_map
(braket
l_int|4
)braket
comma
id|dev_info-&gt;ingress_priority_map
(braket
l_int|5
)braket
comma
id|dev_info-&gt;ingress_priority_map
(braket
l_int|6
)braket
comma
id|dev_info-&gt;ingress_priority_map
(braket
l_int|7
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|cnt
op_plus
l_int|100
)paren
OG
id|VLAN_PROC_BUFSZ
)paren
(brace
r_if
c_cond
(paren
(paren
id|cnt
op_plus
id|strlen
c_func
(paren
id|term_msg
)paren
)paren
op_ge
id|VLAN_PROC_BUFSZ
)paren
(brace
multiline_comment|/* should never get here */
r_return
id|cnt
suffix:semicolon
)brace
r_else
(brace
id|cnt
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|cnt
comma
l_string|&quot;%s&quot;
comma
id|term_msg
)paren
suffix:semicolon
r_return
id|cnt
suffix:semicolon
)brace
)brace
id|cnt
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|cnt
comma
l_string|&quot;EGRESSS priority Mappings: &quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
id|mp
op_assign
id|dev_info-&gt;egress_priority_map
(braket
id|i
)braket
suffix:semicolon
r_while
c_loop
(paren
id|mp
)paren
(brace
id|cnt
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|cnt
comma
l_string|&quot;%lu:%hu &quot;
comma
id|mp-&gt;priority
comma
(paren
(paren
id|mp-&gt;vlan_qos
op_rshift
l_int|13
)paren
op_amp
l_int|0x7
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|cnt
op_plus
l_int|100
)paren
OG
id|VLAN_PROC_BUFSZ
)paren
(brace
r_if
c_cond
(paren
(paren
id|cnt
op_plus
id|strlen
c_func
(paren
id|term_msg
)paren
)paren
op_ge
id|VLAN_PROC_BUFSZ
)paren
(brace
multiline_comment|/* should never get here */
r_return
id|cnt
suffix:semicolon
)brace
r_else
(brace
id|cnt
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|cnt
comma
l_string|&quot;%s&quot;
comma
id|term_msg
)paren
suffix:semicolon
r_return
id|cnt
suffix:semicolon
)brace
)brace
id|mp
op_assign
id|mp-&gt;next
suffix:semicolon
)brace
)brace
id|cnt
op_add_assign
id|sprintf
c_func
(paren
id|buf
op_plus
id|cnt
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|cnt
suffix:semicolon
)brace
macro_line|#else /* No CONFIG_PROC_FS */
multiline_comment|/*&n; *&t;No /proc - output stubs&n; */
DECL|function|vlan_proc_init
r_int
id|__init
id|vlan_proc_init
(paren
r_void
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|vlan_proc_cleanup
r_void
id|__exit
id|vlan_proc_cleanup
c_func
(paren
r_void
)paren
(brace
r_return
suffix:semicolon
)brace
DECL|function|vlan_proc_add_dev
r_int
id|vlan_proc_add_dev
c_func
(paren
r_struct
id|net_device
op_star
id|vlandev
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|vlan_proc_rem_dev
r_int
id|vlan_proc_rem_dev
c_func
(paren
r_struct
id|net_device
op_star
id|vlandev
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif /* No CONFIG_PROC_FS */
eof
