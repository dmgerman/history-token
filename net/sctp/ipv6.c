multiline_comment|/* SCTP kernel reference Implementation&n; * Copyright (c) 2001 Nokia, Inc.&n; * Copyright (c) 2001 La Monte H.P. Yarroll&n; * Copyright (c) 2002 International Business Machines, Corp.&n; *&n; * This file is part of the SCTP kernel reference Implementation&n; *&n; * SCTP over IPv6.&n; *&n; * The SCTP reference implementation is free software;&n; * you can redistribute it and/or modify it under the terms of&n; * the GNU General Public License as published by&n; * the Free Software Foundation; either version 2, or (at your option)&n; * any later version.&n; *&n; * The SCTP reference implementation is distributed in the hope that it&n; * will be useful, but WITHOUT ANY WARRANTY; without even the implied&n; *                 ************************&n; * warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.&n; * See the GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with GNU CC; see the file COPYING.  If not, write to&n; * the Free Software Foundation, 59 Temple Place - Suite 330,&n; * Boston, MA 02111-1307, USA.&n; *&n; * Please send any bug reports or fixes you make to the&n; * email address(es):&n; *    lksctp developers &lt;lksctp-developers@lists.sourceforge.net&gt;&n; *&n; * Or submit a bug report through the following website:&n; *    http://www.sf.net/projects/lksctp&n; *&n; * Written or modified by:&n; *    Le Yanqun             &lt;yanqun.le@nokia.com&gt;&n; *    Hui Huang&t;&t;    &lt;hui.huang@nokia.com&gt;&n; *    La Monte H.P. Yarroll &lt;piggy@acm.org&gt;&n; *    Sridhar Samudrala&t;    &lt;sri@us.ibm.com&gt;&n; *    Jon Grimm             &lt;jgrimm@us.ibm.com&gt;&n; *&n; * Based on:&n; *      linux/net/ipv6/tcp_ipv6.c&n; *&n; * Any bugs reported given to us we will try to fix... any fixes shared will&n; * be incorporated into the next SCTP release.&n; */
DECL|macro|__NO_VERSION__
mdefine_line|#define __NO_VERSION__
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/socket.h&gt;
macro_line|#include &lt;linux/sockios.h&gt;
macro_line|#include &lt;linux/net.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/in6.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/ipsec.h&gt;
macro_line|#include &lt;linux/ipv6.h&gt;
macro_line|#include &lt;linux/icmpv6.h&gt;
macro_line|#include &lt;linux/random.h&gt;
macro_line|#include &lt;net/protocol.h&gt;
macro_line|#include &lt;net/tcp.h&gt;
macro_line|#include &lt;net/ndisc.h&gt;
macro_line|#include &lt;net/ipv6.h&gt;
macro_line|#include &lt;net/transp_v6.h&gt;
macro_line|#include &lt;net/addrconf.h&gt;
macro_line|#include &lt;net/ip6_route.h&gt;
macro_line|#include &lt;net/inet_common.h&gt;
macro_line|#include &lt;net/inet_ecn.h&gt;
macro_line|#include &lt;net/sctp/sctp.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
multiline_comment|/* FIXME: Cleanup so we don&squot;t need TEST_FRAME here. */
macro_line|#ifndef TEST_FRAME
multiline_comment|/* FIXME: Comments. */
DECL|function|sctp_v6_err
r_static
r_inline
r_void
id|sctp_v6_err
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|inet6_skb_parm
op_star
id|opt
comma
r_int
id|type
comma
r_int
id|code
comma
r_int
id|offset
comma
id|__u32
id|info
)paren
(brace
multiline_comment|/* BUG.  WRITE ME.  */
)brace
multiline_comment|/* Based on tcp_v6_xmit() in tcp_ipv6.c. */
DECL|function|sctp_v6_xmit
r_static
r_inline
r_int
id|sctp_v6_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|sock
op_star
id|sk
op_assign
id|skb-&gt;sk
suffix:semicolon
r_struct
id|ipv6_pinfo
op_star
id|np
op_assign
id|inet6_sk
c_func
(paren
id|sk
)paren
suffix:semicolon
r_struct
id|flowi
id|fl
suffix:semicolon
r_struct
id|dst_entry
op_star
id|dst
suffix:semicolon
r_struct
id|in6_addr
id|saddr
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
id|fl.proto
op_assign
id|sk-&gt;protocol
suffix:semicolon
id|fl.fl6_dst
op_assign
op_amp
id|np-&gt;daddr
suffix:semicolon
id|fl.fl6_src
op_assign
l_int|NULL
suffix:semicolon
id|fl.fl6_flowlabel
op_assign
id|np-&gt;flow_label
suffix:semicolon
id|IP6_ECN_flow_xmit
c_func
(paren
id|sk
comma
id|fl.fl6_flowlabel
)paren
suffix:semicolon
id|fl.oif
op_assign
id|sk-&gt;bound_dev_if
suffix:semicolon
id|fl.uli_u.ports.sport
op_assign
id|inet_sk
c_func
(paren
id|sk
)paren
op_member_access_from_pointer
id|sport
suffix:semicolon
id|fl.uli_u.ports.dport
op_assign
id|inet_sk
c_func
(paren
id|sk
)paren
op_member_access_from_pointer
id|dport
suffix:semicolon
r_if
c_cond
(paren
id|np-&gt;opt
op_logical_and
id|np-&gt;opt-&gt;srcrt
)paren
(brace
r_struct
id|rt0_hdr
op_star
id|rt0
op_assign
(paren
r_struct
id|rt0_hdr
op_star
)paren
id|np-&gt;opt-&gt;srcrt
suffix:semicolon
id|fl.nl_u.ip6_u.daddr
op_assign
id|rt0-&gt;addr
suffix:semicolon
)brace
id|dst
op_assign
id|__sk_dst_check
c_func
(paren
id|sk
comma
id|np-&gt;dst_cookie
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dst
op_eq
l_int|NULL
)paren
(brace
id|dst
op_assign
id|ip6_route_output
c_func
(paren
id|sk
comma
op_amp
id|fl
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dst-&gt;error
)paren
(brace
id|sk-&gt;err_soft
op_assign
op_minus
id|dst-&gt;error
suffix:semicolon
id|dst_release
c_func
(paren
id|dst
)paren
suffix:semicolon
r_return
op_minus
id|sk-&gt;err_soft
suffix:semicolon
)brace
id|ip6_dst_store
c_func
(paren
id|sk
comma
id|dst
comma
l_int|NULL
)paren
suffix:semicolon
)brace
id|skb-&gt;dst
op_assign
id|dst_clone
c_func
(paren
id|dst
)paren
suffix:semicolon
multiline_comment|/* FIXME: This is all temporary until real source address&n;&t; * selection is done.&n;&t; */
r_if
c_cond
(paren
id|ipv6_addr_any
c_func
(paren
op_amp
id|np-&gt;saddr
)paren
)paren
(brace
id|err
op_assign
id|ipv6_get_saddr
c_func
(paren
id|dst
comma
id|fl.fl6_dst
comma
op_amp
id|saddr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;sctp_v6_xmit: no saddr available&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* FIXME: This is a workaround until we get&n;&t;&t; * real source address selection done.  This is here&n;&t;&t; * to disallow loopback when the scoping rules have&n;&t;&t; * not bound loopback to the endpoint.&n;&t;&t; */
r_if
c_cond
(paren
id|sctp_ipv6_addr_type
c_func
(paren
op_amp
id|saddr
)paren
op_amp
id|IPV6_ADDR_LOOPBACK
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|sctp_ipv6_addr_type
c_func
(paren
op_amp
id|np-&gt;daddr
)paren
op_amp
id|IPV6_ADDR_LOOPBACK
)paren
)paren
(brace
id|ipv6_addr_copy
c_func
(paren
op_amp
id|saddr
comma
op_amp
id|np-&gt;daddr
)paren
suffix:semicolon
)brace
)brace
id|fl.fl6_src
op_assign
op_amp
id|saddr
suffix:semicolon
)brace
r_else
(brace
id|fl.fl6_src
op_assign
op_amp
id|np-&gt;saddr
suffix:semicolon
)brace
multiline_comment|/* Restore final destination back after routing done */
id|fl.nl_u.ip6_u.daddr
op_assign
op_amp
id|np-&gt;daddr
suffix:semicolon
r_return
id|ip6_xmit
c_func
(paren
id|sk
comma
id|skb
comma
op_amp
id|fl
comma
id|np-&gt;opt
)paren
suffix:semicolon
)brace
macro_line|#endif /* TEST_FRAME */
multiline_comment|/* Returns the mtu for the given v6 destination address. */
DECL|function|sctp_v6_get_dst_mtu
r_int
id|sctp_v6_get_dst_mtu
c_func
(paren
r_const
id|sockaddr_storage_t
op_star
id|address
)paren
(brace
r_struct
id|dst_entry
op_star
id|dst
suffix:semicolon
r_struct
id|flowi
id|fl
suffix:semicolon
r_int
id|dst_mtu
op_assign
id|SCTP_DEFAULT_MAXSEGMENT
suffix:semicolon
id|fl.proto
op_assign
l_int|0
suffix:semicolon
id|fl.fl6_dst
op_assign
(paren
r_struct
id|in6_addr
op_star
)paren
op_amp
id|address-&gt;v6.sin6_addr
suffix:semicolon
id|fl.fl6_src
op_assign
l_int|NULL
suffix:semicolon
id|fl.fl6_flowlabel
op_assign
l_int|0
suffix:semicolon
id|fl.oif
op_assign
l_int|0
suffix:semicolon
id|fl.uli_u.ports.sport
op_assign
l_int|0
suffix:semicolon
id|fl.uli_u.ports.dport
op_assign
l_int|0
suffix:semicolon
id|dst
op_assign
id|ip6_route_output
c_func
(paren
l_int|NULL
comma
op_amp
id|fl
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dst
)paren
(brace
id|dst_mtu
op_assign
id|dst-&gt;pmtu
suffix:semicolon
id|SCTP_DEBUG_PRINTK
c_func
(paren
l_string|&quot;sctp_v6_get_dst_mtu: &quot;
l_string|&quot;ip6_route_output: dev:%s pmtu:%d&bslash;n&quot;
comma
id|dst-&gt;dev-&gt;name
comma
id|dst_mtu
)paren
suffix:semicolon
id|dst_release
c_func
(paren
id|dst
)paren
suffix:semicolon
)brace
r_else
(brace
id|SCTP_DEBUG_PRINTK
c_func
(paren
l_string|&quot;sctp_v6_get_dst_mtu: &quot;
l_string|&quot;ip6_route_output failed, returning &quot;
l_string|&quot;%d as dst_mtu&bslash;n&quot;
comma
id|dst_mtu
)paren
suffix:semicolon
)brace
r_return
id|dst_mtu
suffix:semicolon
)brace
multiline_comment|/* Initialize a PF_INET6 socket msg_name. */
DECL|function|sctp_inet6_msgname
r_static
r_void
id|sctp_inet6_msgname
c_func
(paren
r_char
op_star
id|msgname
comma
r_int
op_star
id|addr_len
)paren
(brace
r_struct
id|sockaddr_in6
op_star
id|sin6
suffix:semicolon
id|sin6
op_assign
(paren
r_struct
id|sockaddr_in6
op_star
)paren
id|msgname
suffix:semicolon
id|sin6-&gt;sin6_family
op_assign
id|AF_INET6
suffix:semicolon
id|sin6-&gt;sin6_flowinfo
op_assign
l_int|0
suffix:semicolon
id|sin6-&gt;sin6_scope_id
op_assign
l_int|0
suffix:semicolon
op_star
id|addr_len
op_assign
r_sizeof
(paren
r_struct
id|sockaddr_in6
)paren
suffix:semicolon
)brace
multiline_comment|/* Initialize a PF_INET msgname from a ulpevent. */
DECL|function|sctp_inet6_event_msgname
r_static
r_void
id|sctp_inet6_event_msgname
c_func
(paren
id|sctp_ulpevent_t
op_star
id|event
comma
r_char
op_star
id|msgname
comma
r_int
op_star
id|addrlen
)paren
(brace
r_struct
id|sockaddr_in6
op_star
id|sin6
comma
op_star
id|sin6from
suffix:semicolon
r_if
c_cond
(paren
id|msgname
)paren
(brace
id|sockaddr_storage_t
op_star
id|addr
suffix:semicolon
id|sctp_inet6_msgname
c_func
(paren
id|msgname
comma
id|addrlen
)paren
suffix:semicolon
id|sin6
op_assign
(paren
r_struct
id|sockaddr_in6
op_star
)paren
id|msgname
suffix:semicolon
id|sin6-&gt;sin6_port
op_assign
id|htons
c_func
(paren
id|event-&gt;asoc-&gt;peer.port
)paren
suffix:semicolon
id|addr
op_assign
op_amp
id|event-&gt;asoc-&gt;peer.primary_addr
suffix:semicolon
multiline_comment|/* Note: If we go to a common v6 format, this code&n;&t;&t; * will change.&n;&t;&t; */
multiline_comment|/* Map ipv4 address into v4-mapped-on-v6 address.  */
r_if
c_cond
(paren
id|AF_INET
op_eq
id|addr-&gt;sa.sa_family
)paren
(brace
multiline_comment|/* FIXME: Easy, but there was no way to test this&n;&t;&t;&t; * yet.&n;&t;&t;&t; */
r_return
suffix:semicolon
)brace
id|sin6from
op_assign
op_amp
id|event-&gt;asoc-&gt;peer.primary_addr.v6
suffix:semicolon
id|ipv6_addr_copy
c_func
(paren
op_amp
id|sin6-&gt;sin6_addr
comma
op_amp
id|sin6from-&gt;sin6_addr
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Initialize a msg_name from an inbound skb. */
DECL|function|sctp_inet6_skb_msgname
r_static
r_void
id|sctp_inet6_skb_msgname
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_char
op_star
id|msgname
comma
r_int
op_star
id|addr_len
)paren
(brace
r_struct
id|sctphdr
op_star
id|sh
suffix:semicolon
r_struct
id|sockaddr_in6
op_star
id|sin6
suffix:semicolon
r_if
c_cond
(paren
id|msgname
)paren
(brace
id|sctp_inet6_msgname
c_func
(paren
id|msgname
comma
id|addr_len
)paren
suffix:semicolon
id|sin6
op_assign
(paren
r_struct
id|sockaddr_in6
op_star
)paren
id|msgname
suffix:semicolon
id|sh
op_assign
(paren
r_struct
id|sctphdr
op_star
)paren
id|skb-&gt;h.raw
suffix:semicolon
id|sin6-&gt;sin6_port
op_assign
id|sh-&gt;source
suffix:semicolon
multiline_comment|/* FIXME: Map ipv4 address into v4-mapped-on-v6 address. */
r_if
c_cond
(paren
id|__constant_htons
c_func
(paren
id|ETH_P_IP
)paren
op_eq
id|skb-&gt;protocol
)paren
(brace
multiline_comment|/* FIXME: Easy, but there was no way to test this&n;&t;&t;&t; * yet.&n;&t;&t;&t; */
r_return
suffix:semicolon
)brace
multiline_comment|/* Otherwise, just copy the v6 address. */
id|ipv6_addr_copy
c_func
(paren
op_amp
id|sin6-&gt;sin6_addr
comma
op_amp
id|skb-&gt;nh.ipv6h-&gt;saddr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ipv6_addr_type
c_func
(paren
op_amp
id|sin6-&gt;sin6_addr
)paren
op_amp
id|IPV6_ADDR_LINKLOCAL
)paren
(brace
r_struct
id|inet6_skb_parm
op_star
id|opt
op_assign
(paren
r_struct
id|inet6_skb_parm
op_star
)paren
id|skb-&gt;cb
suffix:semicolon
id|sin6-&gt;sin6_scope_id
op_assign
id|opt-&gt;iif
suffix:semicolon
)brace
)brace
)brace
DECL|variable|inet6_seqpacket_ops
r_static
r_struct
id|proto_ops
id|inet6_seqpacket_ops
op_assign
(brace
dot
id|family
op_assign
id|PF_INET6
comma
dot
id|release
op_assign
id|inet6_release
comma
dot
id|bind
op_assign
id|inet6_bind
comma
dot
id|connect
op_assign
id|inet_dgram_connect
comma
dot
id|socketpair
op_assign
id|sock_no_socketpair
comma
dot
id|accept
op_assign
id|inet_accept
comma
dot
id|getname
op_assign
id|inet6_getname
comma
dot
id|poll
op_assign
id|sctp_poll
comma
dot
id|ioctl
op_assign
id|inet6_ioctl
comma
dot
id|listen
op_assign
id|sctp_inet_listen
comma
dot
id|shutdown
op_assign
id|inet_shutdown
comma
dot
id|setsockopt
op_assign
id|inet_setsockopt
comma
dot
id|getsockopt
op_assign
id|inet_getsockopt
comma
dot
id|sendmsg
op_assign
id|inet_sendmsg
comma
dot
id|recvmsg
op_assign
id|inet_recvmsg
comma
dot
id|mmap
op_assign
id|sock_no_mmap
comma
)brace
suffix:semicolon
DECL|variable|sctpv6_protosw
r_static
r_struct
id|inet_protosw
id|sctpv6_protosw
op_assign
(brace
dot
id|type
op_assign
id|SOCK_SEQPACKET
comma
dot
id|protocol
op_assign
id|IPPROTO_SCTP
comma
dot
id|prot
op_assign
op_amp
id|sctp_prot
comma
dot
id|ops
op_assign
op_amp
id|inet6_seqpacket_ops
comma
dot
id|capability
op_assign
op_minus
l_int|1
comma
dot
id|no_check
op_assign
l_int|0
comma
dot
id|flags
op_assign
id|SCTP_PROTOSW_FLAG
)brace
suffix:semicolon
DECL|variable|sctpv6_protocol
r_static
r_struct
id|inet6_protocol
id|sctpv6_protocol
op_assign
(brace
dot
id|handler
op_assign
id|sctp_rcv
comma
dot
id|err_handler
op_assign
id|sctp_v6_err
comma
dot
id|next
op_assign
l_int|NULL
comma
dot
id|protocol
op_assign
id|IPPROTO_SCTP
comma
dot
id|copy
op_assign
l_int|0
comma
dot
id|data
op_assign
l_int|NULL
comma
dot
id|name
op_assign
l_string|&quot;SCTPv6&quot;
)brace
suffix:semicolon
DECL|variable|sctp_ipv6_specific
r_static
id|sctp_func_t
id|sctp_ipv6_specific
op_assign
(brace
dot
id|queue_xmit
op_assign
id|sctp_v6_xmit
comma
dot
id|setsockopt
op_assign
id|ipv6_setsockopt
comma
dot
id|getsockopt
op_assign
id|ipv6_getsockopt
comma
dot
id|get_dst_mtu
op_assign
id|sctp_v6_get_dst_mtu
comma
dot
id|net_header_len
op_assign
r_sizeof
(paren
r_struct
id|ipv6hdr
)paren
comma
dot
id|sockaddr_len
op_assign
r_sizeof
(paren
r_struct
id|sockaddr_in6
)paren
comma
dot
id|sa_family
op_assign
id|AF_INET6
comma
)brace
suffix:semicolon
DECL|variable|sctp_pf_inet6_specific
r_static
id|sctp_pf_t
id|sctp_pf_inet6_specific
op_assign
(brace
dot
id|event_msgname
op_assign
id|sctp_inet6_event_msgname
comma
dot
id|skb_msgname
op_assign
id|sctp_inet6_skb_msgname
comma
)brace
suffix:semicolon
multiline_comment|/* Initialize IPv6 support and register with inet6 stack.  */
DECL|function|sctp_v6_init
r_int
id|sctp_v6_init
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* Add SCTPv6 to inetsw6 linked list. */
id|inet6_register_protosw
c_func
(paren
op_amp
id|sctpv6_protosw
)paren
suffix:semicolon
multiline_comment|/* Register inet6 protocol. */
id|inet6_add_protocol
c_func
(paren
op_amp
id|sctpv6_protocol
)paren
suffix:semicolon
multiline_comment|/* Register the SCTP specfic PF_INET6 functions. */
id|sctp_set_pf_specific
c_func
(paren
id|PF_INET6
comma
op_amp
id|sctp_pf_inet6_specific
)paren
suffix:semicolon
multiline_comment|/* Fill in address family info.  */
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|sctp_ipv6_specific.list
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|sctp_ipv6_specific.list
comma
op_amp
id|sctp_proto.address_families
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* IPv6 specific exit support. */
DECL|function|sctp_v6_exit
r_void
id|sctp_v6_exit
c_func
(paren
r_void
)paren
(brace
id|list_del
c_func
(paren
op_amp
id|sctp_ipv6_specific.list
)paren
suffix:semicolon
id|inet6_del_protocol
c_func
(paren
op_amp
id|sctpv6_protocol
)paren
suffix:semicolon
id|inet6_unregister_protosw
c_func
(paren
op_amp
id|sctpv6_protosw
)paren
suffix:semicolon
)brace
eof
