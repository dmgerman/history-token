multiline_comment|/* SCTP kernel reference Implementation&n; * Copyright (c) 1999-2000 Cisco, Inc.&n; * Copyright (c) 1999-2001 Motorola, Inc.&n; * Copyright (c) 2001-2002 Intel Corp.&n; * Copyright (c) 2001-2002 International Business Machines Corp.&n; *&n; * This file is part of the SCTP kernel reference Implementation&n; *&n; * This file includes part of the implementation of the add-IP extension,&n; * based on &lt;draft-ietf-tsvwg-addip-sctp-02.txt&gt; June 29, 2001,&n; * for the SCTP kernel reference Implementation.&n; *&n; * These functions work with the state functions in sctp_sm_statefuns.c&n; * to implement the state operations.  These functions implement the&n; * steps which require modifying existing data structures.&n; *&n; * The SCTP reference implementation is free software;&n; * you can redistribute it and/or modify it under the terms of&n; * the GNU General Public License as published by&n; * the Free Software Foundation; either version 2, or (at your option)&n; * any later version.&n; *&n; * The SCTP reference implementation is distributed in the hope that it&n; * will be useful, but WITHOUT ANY WARRANTY; without even the implied&n; *                 ************************&n; * warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.&n; * See the GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with GNU CC; see the file COPYING.  If not, write to&n; * the Free Software Foundation, 59 Temple Place - Suite 330,&n; * Boston, MA 02111-1307, USA.&n; *&n; * Please send any bug reports or fixes you make to the&n; * email address(es):&n; *    lksctp developers &lt;lksctp-developers@lists.sourceforge.net&gt;&n; *&n; * Or submit a bug report through the following website:&n; *    http://www.sf.net/projects/lksctp&n; *&n; * Written or modified by:&n; *    La Monte H.P. Yarroll &lt;piggy@acm.org&gt;&n; *    Karl Knutson          &lt;karl@athena.chicago.il.us&gt;&n; *    C. Robin              &lt;chris@hundredacre.ac.uk&gt;&n; *    Jon Grimm             &lt;jgrimm@us.ibm.com&gt;&n; *    Xingang Guo           &lt;xingang.guo@intel.com&gt;&n; *    Dajiang Zhang&t;    &lt;dajiang.zhang@nokia.com&gt;&n; *    Sridhar Samudrala&t;    &lt;sri@us.ibm.com&gt;&n; *    Daisy Chang&t;    &lt;daisyc@us.ibm.com&gt;&n; *    Ardelle Fan&t;    &lt;ardelle.fan@intel.com&gt;&n; *&n; * Any bugs reported given to us we will try to fix... any fixes shared will&n; * be incorporated into the next SCTP release.&n; */
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/ip.h&gt;
macro_line|#include &lt;linux/ipv6.h&gt;
macro_line|#include &lt;linux/net.h&gt;
macro_line|#include &lt;linux/inet.h&gt;
macro_line|#include &lt;asm/scatterlist.h&gt;
macro_line|#include &lt;linux/crypto.h&gt;
macro_line|#include &lt;net/sock.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/random.h&gt;&t;/* for get_random_bytes */
macro_line|#include &lt;net/sctp/sctp.h&gt;
macro_line|#include &lt;net/sctp/sm.h&gt;
multiline_comment|/* What was the inbound interface for this chunk? */
DECL|function|sctp_chunk_iif
r_int
id|sctp_chunk_iif
c_func
(paren
r_const
r_struct
id|sctp_chunk
op_star
id|chunk
)paren
(brace
r_struct
id|sctp_af
op_star
id|af
suffix:semicolon
r_int
id|iif
op_assign
l_int|0
suffix:semicolon
id|af
op_assign
id|sctp_get_af_specific
c_func
(paren
id|ipver2af
c_func
(paren
id|chunk-&gt;skb-&gt;nh.iph-&gt;version
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|af
)paren
id|iif
op_assign
id|af
op_member_access_from_pointer
id|skb_iif
c_func
(paren
id|chunk-&gt;skb
)paren
suffix:semicolon
r_return
id|iif
suffix:semicolon
)brace
multiline_comment|/* RFC 2960 3.3.2 Initiation (INIT) (1)&n; *&n; * Note 2: The ECN capable field is reserved for future use of&n; * Explicit Congestion Notification.&n; */
DECL|variable|ecap_param
r_static
r_const
id|sctp_ecn_capable_param_t
id|ecap_param
op_assign
(brace
(brace
id|SCTP_PARAM_ECN_CAPABLE
comma
id|__constant_htons
c_func
(paren
r_sizeof
(paren
id|sctp_ecn_capable_param_t
)paren
)paren
comma
)brace
)brace
suffix:semicolon
multiline_comment|/* A helper to initilize to initilize an op error inside a&n; * provided chunk, as most cause codes will be embedded inside an&n; * abort chunk.&n; */
DECL|function|sctp_init_cause
r_void
id|sctp_init_cause
c_func
(paren
id|sctp_chunk_t
op_star
id|chunk
comma
id|__u16
id|cause_code
comma
r_const
r_void
op_star
id|payload
comma
r_int
id|paylen
)paren
(brace
id|sctp_errhdr_t
id|err
suffix:semicolon
r_int
id|padlen
suffix:semicolon
id|__u16
id|len
suffix:semicolon
multiline_comment|/* Cause code constants are now defined in network order.  */
id|err.cause
op_assign
id|cause_code
suffix:semicolon
id|len
op_assign
r_sizeof
(paren
id|sctp_errhdr_t
)paren
op_plus
id|paylen
suffix:semicolon
id|padlen
op_assign
id|len
op_mod
l_int|4
suffix:semicolon
id|err.length
op_assign
id|htons
c_func
(paren
id|len
)paren
suffix:semicolon
id|len
op_add_assign
id|padlen
suffix:semicolon
id|sctp_addto_chunk
c_func
(paren
id|chunk
comma
r_sizeof
(paren
id|sctp_errhdr_t
)paren
comma
op_amp
id|err
)paren
suffix:semicolon
id|chunk-&gt;subh.err_hdr
op_assign
id|sctp_addto_chunk
c_func
(paren
id|chunk
comma
id|paylen
comma
id|payload
)paren
suffix:semicolon
)brace
multiline_comment|/* 3.3.2 Initiation (INIT) (1)&n; *&n; * This chunk is used to initiate a SCTP association between two&n; * endpoints. The format of the INIT chunk is shown below:&n; *&n; *     0                   1                   2                   3&n; *     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1&n; *    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+&n; *    |   Type = 1    |  Chunk Flags  |      Chunk Length             |&n; *    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+&n; *    |                         Initiate Tag                          |&n; *    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+&n; *    |           Advertised Receiver Window Credit (a_rwnd)          |&n; *    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+&n; *    |  Number of Outbound Streams   |  Number of Inbound Streams    |&n; *    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+&n; *    |                          Initial TSN                          |&n; *    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+&n; *    &bslash;                                                               &bslash;&n; *    /              Optional/Variable-Length Parameters              /&n; *    &bslash;                                                               &bslash;&n; *    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+&n; *&n; *&n; * The INIT chunk contains the following parameters. Unless otherwise&n; * noted, each parameter MUST only be included once in the INIT chunk.&n; *&n; * Fixed Parameters                     Status&n; * ----------------------------------------------&n; * Initiate Tag                        Mandatory&n; * Advertised Receiver Window Credit   Mandatory&n; * Number of Outbound Streams          Mandatory&n; * Number of Inbound Streams           Mandatory&n; * Initial TSN                         Mandatory&n; *&n; * Variable Parameters                  Status     Type Value&n; * -------------------------------------------------------------&n; * IPv4 Address (Note 1)               Optional    5&n; * IPv6 Address (Note 1)               Optional    6&n; * Cookie Preservative                 Optional    9&n; * Reserved for ECN Capable (Note 2)   Optional    32768 (0x8000)&n; * Host Name Address (Note 3)          Optional    11&n; * Supported Address Types (Note 4)    Optional    12&n; */
DECL|function|sctp_make_init
id|sctp_chunk_t
op_star
id|sctp_make_init
c_func
(paren
r_const
r_struct
id|sctp_association
op_star
id|asoc
comma
r_const
id|sctp_bind_addr_t
op_star
id|bp
comma
r_int
id|gfp
comma
r_int
id|vparam_len
)paren
(brace
id|sctp_inithdr_t
id|init
suffix:semicolon
r_union
id|sctp_params
id|addrs
suffix:semicolon
r_int
id|chunksize
suffix:semicolon
id|sctp_chunk_t
op_star
id|retval
op_assign
l_int|NULL
suffix:semicolon
r_int
id|num_types
comma
id|addrs_len
op_assign
l_int|0
suffix:semicolon
r_struct
id|sctp_opt
op_star
id|sp
suffix:semicolon
id|sctp_supported_addrs_param_t
id|sat
suffix:semicolon
id|__u16
id|types
(braket
l_int|2
)braket
suffix:semicolon
multiline_comment|/* RFC 2960 3.3.2 Initiation (INIT) (1)&n;&t; *&n;&t; * Note 1: The INIT chunks can contain multiple addresses that&n;&t; * can be IPv4 and/or IPv6 in any combination.&n;&t; */
id|retval
op_assign
l_int|NULL
suffix:semicolon
id|addrs.v
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Convert the provided bind address list to raw format */
id|addrs
op_assign
id|sctp_bind_addrs_to_raw
c_func
(paren
id|bp
comma
op_amp
id|addrs_len
comma
id|gfp
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|addrs.v
)paren
r_goto
id|nodata
suffix:semicolon
id|init.init_tag
op_assign
id|htonl
c_func
(paren
id|asoc-&gt;c.my_vtag
)paren
suffix:semicolon
id|init.a_rwnd
op_assign
id|htonl
c_func
(paren
id|asoc-&gt;rwnd
)paren
suffix:semicolon
id|init.num_outbound_streams
op_assign
id|htons
c_func
(paren
id|asoc-&gt;c.sinit_num_ostreams
)paren
suffix:semicolon
id|init.num_inbound_streams
op_assign
id|htons
c_func
(paren
id|asoc-&gt;c.sinit_max_instreams
)paren
suffix:semicolon
id|init.initial_tsn
op_assign
id|htonl
c_func
(paren
id|asoc-&gt;c.initial_tsn
)paren
suffix:semicolon
multiline_comment|/* How many address types are needed? */
id|sp
op_assign
id|sctp_sk
c_func
(paren
id|asoc-&gt;base.sk
)paren
suffix:semicolon
id|num_types
op_assign
id|sp-&gt;pf
op_member_access_from_pointer
id|supported_addrs
c_func
(paren
id|sp
comma
id|types
)paren
suffix:semicolon
id|chunksize
op_assign
r_sizeof
(paren
id|init
)paren
op_plus
id|addrs_len
op_plus
id|SCTP_SAT_LEN
c_func
(paren
id|num_types
)paren
suffix:semicolon
id|chunksize
op_add_assign
r_sizeof
(paren
id|ecap_param
)paren
suffix:semicolon
id|chunksize
op_add_assign
id|vparam_len
suffix:semicolon
multiline_comment|/* RFC 2960 3.3.2 Initiation (INIT) (1)&n;&t; *&n;&t; * Note 3: An INIT chunk MUST NOT contain more than one Host&n;&t; * Name address parameter. Moreover, the sender of the INIT&n;&t; * MUST NOT combine any other address types with the Host Name&n;&t; * address in the INIT. The receiver of INIT MUST ignore any&n;&t; * other address types if the Host Name address parameter is&n;&t; * present in the received INIT chunk.&n;&t; *&n;&t; * PLEASE DO NOT FIXME [This version does not support Host Name.]&n;&t; */
id|retval
op_assign
id|sctp_make_chunk
c_func
(paren
id|asoc
comma
id|SCTP_CID_INIT
comma
l_int|0
comma
id|chunksize
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
r_goto
id|nodata
suffix:semicolon
id|retval-&gt;subh.init_hdr
op_assign
id|sctp_addto_chunk
c_func
(paren
id|retval
comma
r_sizeof
(paren
id|init
)paren
comma
op_amp
id|init
)paren
suffix:semicolon
id|retval-&gt;param_hdr.v
op_assign
id|sctp_addto_chunk
c_func
(paren
id|retval
comma
id|addrs_len
comma
id|addrs.v
)paren
suffix:semicolon
multiline_comment|/* RFC 2960 3.3.2 Initiation (INIT) (1)&n;&t; *&n;&t; * Note 4: This parameter, when present, specifies all the&n;&t; * address types the sending endpoint can support. The absence&n;&t; * of this parameter indicates that the sending endpoint can&n;&t; * support any address type.&n;&t; */
id|sat.param_hdr.type
op_assign
id|SCTP_PARAM_SUPPORTED_ADDRESS_TYPES
suffix:semicolon
id|sat.param_hdr.length
op_assign
id|htons
c_func
(paren
id|SCTP_SAT_LEN
c_func
(paren
id|num_types
)paren
)paren
suffix:semicolon
id|sctp_addto_chunk
c_func
(paren
id|retval
comma
r_sizeof
(paren
id|sat
)paren
comma
op_amp
id|sat
)paren
suffix:semicolon
id|sctp_addto_chunk
c_func
(paren
id|retval
comma
id|num_types
op_star
r_sizeof
(paren
id|__u16
)paren
comma
op_amp
id|types
)paren
suffix:semicolon
id|sctp_addto_chunk
c_func
(paren
id|retval
comma
r_sizeof
(paren
id|ecap_param
)paren
comma
op_amp
id|ecap_param
)paren
suffix:semicolon
id|nodata
suffix:colon
r_if
c_cond
(paren
id|addrs.v
)paren
id|kfree
c_func
(paren
id|addrs.v
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
DECL|function|sctp_make_init_ack
id|sctp_chunk_t
op_star
id|sctp_make_init_ack
c_func
(paren
r_const
r_struct
id|sctp_association
op_star
id|asoc
comma
r_const
id|sctp_chunk_t
op_star
id|chunk
comma
r_int
id|gfp
comma
r_int
id|unkparam_len
)paren
(brace
id|sctp_inithdr_t
id|initack
suffix:semicolon
id|sctp_chunk_t
op_star
id|retval
suffix:semicolon
r_union
id|sctp_params
id|addrs
suffix:semicolon
r_int
id|addrs_len
suffix:semicolon
id|sctp_cookie_param_t
op_star
id|cookie
suffix:semicolon
r_int
id|cookie_len
suffix:semicolon
r_int
id|chunksize
suffix:semicolon
id|retval
op_assign
l_int|NULL
suffix:semicolon
id|addrs
op_assign
id|sctp_bind_addrs_to_raw
c_func
(paren
op_amp
id|asoc-&gt;base.bind_addr
comma
op_amp
id|addrs_len
comma
id|gfp
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|addrs.v
)paren
r_goto
id|nomem_rawaddr
suffix:semicolon
id|initack.init_tag
op_assign
id|htonl
c_func
(paren
id|asoc-&gt;c.my_vtag
)paren
suffix:semicolon
id|initack.a_rwnd
op_assign
id|htonl
c_func
(paren
id|asoc-&gt;rwnd
)paren
suffix:semicolon
id|initack.num_outbound_streams
op_assign
id|htons
c_func
(paren
id|asoc-&gt;c.sinit_num_ostreams
)paren
suffix:semicolon
id|initack.num_inbound_streams
op_assign
id|htons
c_func
(paren
id|asoc-&gt;c.sinit_max_instreams
)paren
suffix:semicolon
id|initack.initial_tsn
op_assign
id|htonl
c_func
(paren
id|asoc-&gt;c.initial_tsn
)paren
suffix:semicolon
multiline_comment|/* FIXME:  We really ought to build the cookie right&n;&t; * into the packet instead of allocating more fresh memory.&n;&t; */
id|cookie
op_assign
id|sctp_pack_cookie
c_func
(paren
id|asoc-&gt;ep
comma
id|asoc
comma
id|chunk
comma
op_amp
id|cookie_len
comma
id|addrs.v
comma
id|addrs_len
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cookie
)paren
r_goto
id|nomem_cookie
suffix:semicolon
multiline_comment|/* Calculate the total size of allocation, include the reserved&n;&t; * space for reporting unknown parameters if it is specified.&n;&t; */
id|chunksize
op_assign
r_sizeof
(paren
id|initack
)paren
op_plus
id|addrs_len
op_plus
id|cookie_len
op_plus
id|unkparam_len
suffix:semicolon
multiline_comment|/* Tell peer that we&squot;ll do ECN only if peer advertised such cap.  */
r_if
c_cond
(paren
id|asoc-&gt;peer.ecn_capable
)paren
id|chunksize
op_add_assign
r_sizeof
(paren
id|ecap_param
)paren
suffix:semicolon
multiline_comment|/* Now allocate and fill out the chunk.  */
id|retval
op_assign
id|sctp_make_chunk
c_func
(paren
id|asoc
comma
id|SCTP_CID_INIT_ACK
comma
l_int|0
comma
id|chunksize
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
r_goto
id|nomem_chunk
suffix:semicolon
multiline_comment|/* Per the advice in RFC 2960 6.4, send this reply to&n;&t; * the source of the INIT packet.&n;&t; */
id|retval-&gt;transport
op_assign
id|chunk-&gt;transport
suffix:semicolon
id|retval-&gt;subh.init_hdr
op_assign
id|sctp_addto_chunk
c_func
(paren
id|retval
comma
r_sizeof
(paren
id|initack
)paren
comma
op_amp
id|initack
)paren
suffix:semicolon
id|retval-&gt;param_hdr.v
op_assign
id|sctp_addto_chunk
c_func
(paren
id|retval
comma
id|addrs_len
comma
id|addrs.v
)paren
suffix:semicolon
id|sctp_addto_chunk
c_func
(paren
id|retval
comma
id|cookie_len
comma
id|cookie
)paren
suffix:semicolon
r_if
c_cond
(paren
id|asoc-&gt;peer.ecn_capable
)paren
id|sctp_addto_chunk
c_func
(paren
id|retval
comma
r_sizeof
(paren
id|ecap_param
)paren
comma
op_amp
id|ecap_param
)paren
suffix:semicolon
multiline_comment|/* We need to remove the const qualifier at this point.  */
id|retval-&gt;asoc
op_assign
(paren
r_struct
id|sctp_association
op_star
)paren
id|asoc
suffix:semicolon
multiline_comment|/* RFC 2960 6.4 Multi-homed SCTP Endpoints&n;&t; *&n;&t; * An endpoint SHOULD transmit reply chunks (e.g., SACK,&n;&t; * HEARTBEAT ACK, * etc.) to the same destination transport&n;&t; * address from which it received the DATA or control chunk&n;&t; * to which it is replying.&n;&t; *&n;&t; * [INIT ACK back to where the INIT came from.]&n;&t; */
r_if
c_cond
(paren
id|chunk
)paren
id|retval-&gt;transport
op_assign
id|chunk-&gt;transport
suffix:semicolon
id|nomem_chunk
suffix:colon
id|kfree
c_func
(paren
id|cookie
)paren
suffix:semicolon
id|nomem_cookie
suffix:colon
id|kfree
c_func
(paren
id|addrs.v
)paren
suffix:semicolon
id|nomem_rawaddr
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* 3.3.11 Cookie Echo (COOKIE ECHO) (10):&n; *&n; * This chunk is used only during the initialization of an association.&n; * It is sent by the initiator of an association to its peer to complete&n; * the initialization process. This chunk MUST precede any DATA chunk&n; * sent within the association, but MAY be bundled with one or more DATA&n; * chunks in the same packet.&n; *&n; *      0                   1                   2                   3&n; *      0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1&n; *     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+&n; *     |   Type = 10   |Chunk  Flags   |         Length                |&n; *     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+&n; *     /                     Cookie                                    /&n; *     &bslash;                                                               &bslash;&n; *     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+&n; *&n; * Chunk Flags: 8 bit&n; *&n; *   Set to zero on transmit and ignored on receipt.&n; *&n; * Length: 16 bits (unsigned integer)&n; *&n; *   Set to the size of the chunk in bytes, including the 4 bytes of&n; *   the chunk header and the size of the Cookie.&n; *&n; * Cookie: variable size&n; *&n; *   This field must contain the exact cookie received in the&n; *   State Cookie parameter from the previous INIT ACK.&n; *&n; *   An implementation SHOULD make the cookie as small as possible&n; *   to insure interoperability.&n; */
DECL|function|sctp_make_cookie_echo
id|sctp_chunk_t
op_star
id|sctp_make_cookie_echo
c_func
(paren
r_const
r_struct
id|sctp_association
op_star
id|asoc
comma
r_const
id|sctp_chunk_t
op_star
id|chunk
)paren
(brace
id|sctp_chunk_t
op_star
id|retval
suffix:semicolon
r_void
op_star
id|cookie
suffix:semicolon
r_int
id|cookie_len
suffix:semicolon
id|cookie
op_assign
id|asoc-&gt;peer.cookie
suffix:semicolon
id|cookie_len
op_assign
id|asoc-&gt;peer.cookie_len
suffix:semicolon
multiline_comment|/* Build a cookie echo chunk.  */
id|retval
op_assign
id|sctp_make_chunk
c_func
(paren
id|asoc
comma
id|SCTP_CID_COOKIE_ECHO
comma
l_int|0
comma
id|cookie_len
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
r_goto
id|nodata
suffix:semicolon
id|retval-&gt;subh.cookie_hdr
op_assign
id|sctp_addto_chunk
c_func
(paren
id|retval
comma
id|cookie_len
comma
id|cookie
)paren
suffix:semicolon
multiline_comment|/* RFC 2960 6.4 Multi-homed SCTP Endpoints&n;&t; *&n;&t; * An endpoint SHOULD transmit reply chunks (e.g., SACK,&n;&t; * HEARTBEAT ACK, * etc.) to the same destination transport&n;&t; * address from which it * received the DATA or control chunk&n;&t; * to which it is replying.&n;&t; *&n;&t; * [COOKIE ECHO back to where the INIT ACK came from.]&n;&t; */
r_if
c_cond
(paren
id|chunk
)paren
id|retval-&gt;transport
op_assign
id|chunk-&gt;transport
suffix:semicolon
id|nodata
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* 3.3.12 Cookie Acknowledgement (COOKIE ACK) (11):&n; *&n; * This chunk is used only during the initialization of an&n; * association.  It is used to acknowledge the receipt of a COOKIE&n; * ECHO chunk.  This chunk MUST precede any DATA or SACK chunk sent&n; * within the association, but MAY be bundled with one or more DATA&n; * chunks or SACK chunk in the same SCTP packet.&n; *&n; *      0                   1                   2                   3&n; *      0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1&n; *     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+&n; *     |   Type = 11   |Chunk  Flags   |     Length = 4                |&n; *     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+&n; *&n; * Chunk Flags: 8 bits&n; *&n; *   Set to zero on transmit and ignored on receipt.&n; */
DECL|function|sctp_make_cookie_ack
id|sctp_chunk_t
op_star
id|sctp_make_cookie_ack
c_func
(paren
r_const
r_struct
id|sctp_association
op_star
id|asoc
comma
r_const
id|sctp_chunk_t
op_star
id|chunk
)paren
(brace
id|sctp_chunk_t
op_star
id|retval
suffix:semicolon
id|retval
op_assign
id|sctp_make_chunk
c_func
(paren
id|asoc
comma
id|SCTP_CID_COOKIE_ACK
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* RFC 2960 6.4 Multi-homed SCTP Endpoints&n;&t; *&n;&t; * An endpoint SHOULD transmit reply chunks (e.g., SACK,&n;&t; * HEARTBEAT ACK, * etc.) to the same destination transport&n;&t; * address from which it * received the DATA or control chunk&n;&t; * to which it is replying.&n;&t; *&n;&t; * [COOKIE ACK back to where the COOKIE ECHO came from.]&n;&t; */
r_if
c_cond
(paren
id|retval
op_logical_and
id|chunk
)paren
id|retval-&gt;transport
op_assign
id|chunk-&gt;transport
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; *  Appendix A: Explicit Congestion Notification:&n; *  CWR:&n; *&n; *  RFC 2481 details a specific bit for a sender to send in the header of&n; *  its next outbound TCP segment to indicate to its peer that it has&n; *  reduced its congestion window.  This is termed the CWR bit.  For&n; *  SCTP the same indication is made by including the CWR chunk.&n; *  This chunk contains one data element, i.e. the TSN number that&n; *  was sent in the ECNE chunk.  This element represents the lowest&n; *  TSN number in the datagram that was originally marked with the&n; *  CE bit.&n; *&n; *     0                   1                   2                   3&n; *     0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1&n; *    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+&n; *    | Chunk Type=13 | Flags=00000000|    Chunk Length = 8           |&n; *    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+&n; *    |                      Lowest TSN Number                        |&n; *    +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+&n; *&n; *     Note: The CWR is considered a Control chunk.&n; */
DECL|function|sctp_make_cwr
id|sctp_chunk_t
op_star
id|sctp_make_cwr
c_func
(paren
r_const
r_struct
id|sctp_association
op_star
id|asoc
comma
r_const
id|__u32
id|lowest_tsn
comma
r_const
id|sctp_chunk_t
op_star
id|chunk
)paren
(brace
id|sctp_chunk_t
op_star
id|retval
suffix:semicolon
id|sctp_cwrhdr_t
id|cwr
suffix:semicolon
id|cwr.lowest_tsn
op_assign
id|htonl
c_func
(paren
id|lowest_tsn
)paren
suffix:semicolon
id|retval
op_assign
id|sctp_make_chunk
c_func
(paren
id|asoc
comma
id|SCTP_CID_ECN_CWR
comma
l_int|0
comma
r_sizeof
(paren
id|sctp_cwrhdr_t
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
r_goto
id|nodata
suffix:semicolon
id|retval-&gt;subh.ecn_cwr_hdr
op_assign
id|sctp_addto_chunk
c_func
(paren
id|retval
comma
r_sizeof
(paren
id|cwr
)paren
comma
op_amp
id|cwr
)paren
suffix:semicolon
multiline_comment|/* RFC 2960 6.4 Multi-homed SCTP Endpoints&n;&t; *&n;&t; * An endpoint SHOULD transmit reply chunks (e.g., SACK,&n;&t; * HEARTBEAT ACK, * etc.) to the same destination transport&n;&t; * address from which it * received the DATA or control chunk&n;&t; * to which it is replying.&n;&t; *&n;&t; * [Report a reduced congestion window back to where the ECNE&n;&t; * came from.]&n;&t; */
r_if
c_cond
(paren
id|chunk
)paren
id|retval-&gt;transport
op_assign
id|chunk-&gt;transport
suffix:semicolon
id|nodata
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* Make an ECNE chunk.  This is a congestion experienced report.  */
DECL|function|sctp_make_ecne
id|sctp_chunk_t
op_star
id|sctp_make_ecne
c_func
(paren
r_const
r_struct
id|sctp_association
op_star
id|asoc
comma
r_const
id|__u32
id|lowest_tsn
)paren
(brace
id|sctp_chunk_t
op_star
id|retval
suffix:semicolon
id|sctp_ecnehdr_t
id|ecne
suffix:semicolon
id|ecne.lowest_tsn
op_assign
id|htonl
c_func
(paren
id|lowest_tsn
)paren
suffix:semicolon
id|retval
op_assign
id|sctp_make_chunk
c_func
(paren
id|asoc
comma
id|SCTP_CID_ECN_ECNE
comma
l_int|0
comma
r_sizeof
(paren
id|sctp_ecnehdr_t
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
r_goto
id|nodata
suffix:semicolon
id|retval-&gt;subh.ecne_hdr
op_assign
id|sctp_addto_chunk
c_func
(paren
id|retval
comma
r_sizeof
(paren
id|ecne
)paren
comma
op_amp
id|ecne
)paren
suffix:semicolon
id|nodata
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* Make a DATA chunk for the given association from the provided&n; * parameters.  However, do not populate the data payload.&n; */
DECL|function|sctp_make_datafrag_empty
id|sctp_chunk_t
op_star
id|sctp_make_datafrag_empty
c_func
(paren
r_struct
id|sctp_association
op_star
id|asoc
comma
r_const
r_struct
id|sctp_sndrcvinfo
op_star
id|sinfo
comma
r_int
id|data_len
comma
id|__u8
id|flags
comma
id|__u16
id|ssn
)paren
(brace
id|sctp_chunk_t
op_star
id|retval
suffix:semicolon
id|sctp_datahdr_t
id|dp
suffix:semicolon
r_int
id|chunk_len
suffix:semicolon
multiline_comment|/* We assign the TSN as LATE as possible, not here when&n;&t; * creating the chunk.&n;&t; */
id|dp.tsn
op_assign
l_int|1000000
suffix:semicolon
multiline_comment|/* This marker is a debugging aid. */
id|dp.stream
op_assign
id|htons
c_func
(paren
id|sinfo-&gt;sinfo_stream
)paren
suffix:semicolon
id|dp.ppid
op_assign
id|htonl
c_func
(paren
id|sinfo-&gt;sinfo_ppid
)paren
suffix:semicolon
id|dp.ssn
op_assign
id|htons
c_func
(paren
id|ssn
)paren
suffix:semicolon
multiline_comment|/* Set the flags for an unordered send.  */
r_if
c_cond
(paren
id|sinfo-&gt;sinfo_flags
op_amp
id|MSG_UNORDERED
)paren
id|flags
op_or_assign
id|SCTP_DATA_UNORDERED
suffix:semicolon
id|chunk_len
op_assign
r_sizeof
(paren
id|dp
)paren
op_plus
id|data_len
suffix:semicolon
id|retval
op_assign
id|sctp_make_chunk
c_func
(paren
id|asoc
comma
id|SCTP_CID_DATA
comma
id|flags
comma
id|chunk_len
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
r_goto
id|nodata
suffix:semicolon
id|retval-&gt;subh.data_hdr
op_assign
id|sctp_addto_chunk
c_func
(paren
id|retval
comma
r_sizeof
(paren
id|dp
)paren
comma
op_amp
id|dp
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|retval-&gt;sinfo
comma
id|sinfo
comma
r_sizeof
(paren
r_struct
id|sctp_sndrcvinfo
)paren
)paren
suffix:semicolon
id|nodata
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* Make a DATA chunk for the given association.  Populate the data&n; * payload.&n; */
DECL|function|sctp_make_datafrag
id|sctp_chunk_t
op_star
id|sctp_make_datafrag
c_func
(paren
r_struct
id|sctp_association
op_star
id|asoc
comma
r_const
r_struct
id|sctp_sndrcvinfo
op_star
id|sinfo
comma
r_int
id|data_len
comma
r_const
id|__u8
op_star
id|data
comma
id|__u8
id|flags
comma
id|__u16
id|ssn
)paren
(brace
id|sctp_chunk_t
op_star
id|retval
suffix:semicolon
id|retval
op_assign
id|sctp_make_datafrag_empty
c_func
(paren
id|asoc
comma
id|sinfo
comma
id|data_len
comma
id|flags
comma
id|ssn
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
id|sctp_addto_chunk
c_func
(paren
id|retval
comma
id|data_len
comma
id|data
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* Make a DATA chunk for the given association to ride on stream id&n; * &squot;stream&squot;, with a payload id of &squot;payload&squot;, and a body of &squot;data&squot;.&n; */
DECL|function|sctp_make_data
id|sctp_chunk_t
op_star
id|sctp_make_data
c_func
(paren
r_struct
id|sctp_association
op_star
id|asoc
comma
r_const
r_struct
id|sctp_sndrcvinfo
op_star
id|sinfo
comma
r_int
id|data_len
comma
r_const
id|__u8
op_star
id|data
)paren
(brace
id|sctp_chunk_t
op_star
id|retval
op_assign
l_int|NULL
suffix:semicolon
id|retval
op_assign
id|sctp_make_data_empty
c_func
(paren
id|asoc
comma
id|sinfo
comma
id|data_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retval
)paren
id|sctp_addto_chunk
c_func
(paren
id|retval
comma
id|data_len
comma
id|data
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* Make a DATA chunk for the given association to ride on stream id&n; * &squot;stream&squot;, with a payload id of &squot;payload&squot;, and a body big enough to&n; * hold &squot;data_len&squot; octets of data.  We use this version when we need&n; * to build the message AFTER allocating memory.&n; */
DECL|function|sctp_make_data_empty
id|sctp_chunk_t
op_star
id|sctp_make_data_empty
c_func
(paren
r_struct
id|sctp_association
op_star
id|asoc
comma
r_const
r_struct
id|sctp_sndrcvinfo
op_star
id|sinfo
comma
r_int
id|data_len
)paren
(brace
id|__u8
id|flags
op_assign
id|SCTP_DATA_NOT_FRAG
suffix:semicolon
r_return
id|sctp_make_datafrag_empty
c_func
(paren
id|asoc
comma
id|sinfo
comma
id|data_len
comma
id|flags
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* Create a selective ackowledgement (SACK) for the given&n; * association.  This reports on which TSN&squot;s we&squot;ve seen to date,&n; * including duplicates and gaps.&n; */
DECL|function|sctp_make_sack
id|sctp_chunk_t
op_star
id|sctp_make_sack
c_func
(paren
r_const
r_struct
id|sctp_association
op_star
id|asoc
)paren
(brace
id|sctp_chunk_t
op_star
id|retval
suffix:semicolon
id|sctp_sackhdr_t
id|sack
suffix:semicolon
id|sctp_gap_ack_block_t
id|gab
suffix:semicolon
r_int
id|length
suffix:semicolon
id|__u32
id|ctsn
suffix:semicolon
r_struct
id|sctp_tsnmap_iter
id|iter
suffix:semicolon
id|__u16
id|num_gabs
comma
id|num_dup_tsns
suffix:semicolon
r_struct
id|sctp_tsnmap
op_star
id|map
op_assign
(paren
r_struct
id|sctp_tsnmap
op_star
)paren
op_amp
id|asoc-&gt;peer.tsn_map
suffix:semicolon
id|ctsn
op_assign
id|sctp_tsnmap_get_ctsn
c_func
(paren
id|map
)paren
suffix:semicolon
id|SCTP_DEBUG_PRINTK
c_func
(paren
l_string|&quot;sackCTSNAck sent is 0x%x.&bslash;n&quot;
comma
id|ctsn
)paren
suffix:semicolon
multiline_comment|/* Count the number of Gap Ack Blocks.  */
id|num_gabs
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|sctp_tsnmap_has_gap
c_func
(paren
id|map
)paren
)paren
(brace
id|sctp_tsnmap_iter_init
c_func
(paren
id|map
comma
op_amp
id|iter
)paren
suffix:semicolon
r_while
c_loop
(paren
id|sctp_tsnmap_next_gap_ack
c_func
(paren
id|map
comma
op_amp
id|iter
comma
op_amp
id|gab.start
comma
op_amp
id|gab.end
)paren
)paren
id|num_gabs
op_increment
suffix:semicolon
)brace
id|num_dup_tsns
op_assign
id|sctp_tsnmap_num_dups
c_func
(paren
id|map
)paren
suffix:semicolon
multiline_comment|/* Initialize the SACK header.  */
id|sack.cum_tsn_ack
op_assign
id|htonl
c_func
(paren
id|ctsn
)paren
suffix:semicolon
id|sack.a_rwnd
op_assign
id|htonl
c_func
(paren
id|asoc-&gt;a_rwnd
)paren
suffix:semicolon
id|sack.num_gap_ack_blocks
op_assign
id|htons
c_func
(paren
id|num_gabs
)paren
suffix:semicolon
id|sack.num_dup_tsns
op_assign
id|htons
c_func
(paren
id|num_dup_tsns
)paren
suffix:semicolon
id|length
op_assign
r_sizeof
(paren
id|sack
)paren
op_plus
r_sizeof
(paren
id|sctp_gap_ack_block_t
)paren
op_star
id|num_gabs
op_plus
r_sizeof
(paren
id|__u32
)paren
op_star
id|num_dup_tsns
suffix:semicolon
multiline_comment|/* Create the chunk.  */
id|retval
op_assign
id|sctp_make_chunk
c_func
(paren
id|asoc
comma
id|SCTP_CID_SACK
comma
l_int|0
comma
id|length
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
r_goto
id|nodata
suffix:semicolon
multiline_comment|/* RFC 2960 6.4 Multi-homed SCTP Endpoints&n;&t; *&n;&t; * An endpoint SHOULD transmit reply chunks (e.g., SACK,&n;&t; * HEARTBEAT ACK, etc.) to the same destination transport&n;&t; * address from which it received the DATA or control chunk to&n;&t; * which it is replying.  This rule should also be followed if&n;&t; * the endpoint is bundling DATA chunks together with the&n;&t; * reply chunk.&n;&t; *&n;&t; * However, when acknowledging multiple DATA chunks received&n;&t; * in packets from different source addresses in a single&n;&t; * SACK, the SACK chunk may be transmitted to one of the&n;&t; * destination transport addresses from which the DATA or&n;&t; * control chunks being acknowledged were received.&n;&t; *&n;&t; * [BUG:  We do not implement the following paragraph.&n;&t; * Perhaps we should remember the last transport we used for a&n;&t; * SACK and avoid that (if possible) if we have seen any&n;&t; * duplicates. --piggy]&n;&t; *&n;&t; * When a receiver of a duplicate DATA chunk sends a SACK to a&n;&t; * multi- homed endpoint it MAY be beneficial to vary the&n;&t; * destination address and not use the source address of the&n;&t; * DATA chunk.  The reason being that receiving a duplicate&n;&t; * from a multi-homed endpoint might indicate that the return&n;&t; * path (as specified in the source address of the DATA chunk)&n;&t; * for the SACK is broken.&n;&t; *&n;&t; * [Send to the address from which we last received a DATA chunk.]&n;&t; */
id|retval-&gt;transport
op_assign
id|asoc-&gt;peer.last_data_from
suffix:semicolon
id|retval-&gt;subh.sack_hdr
op_assign
id|sctp_addto_chunk
c_func
(paren
id|retval
comma
r_sizeof
(paren
id|sack
)paren
comma
op_amp
id|sack
)paren
suffix:semicolon
multiline_comment|/* Put the Gap Ack Blocks into the chunk.  */
r_if
c_cond
(paren
id|num_gabs
)paren
(brace
id|sctp_tsnmap_iter_init
c_func
(paren
id|map
comma
op_amp
id|iter
)paren
suffix:semicolon
r_while
c_loop
(paren
id|sctp_tsnmap_next_gap_ack
c_func
(paren
id|map
comma
op_amp
id|iter
comma
op_amp
id|gab.start
comma
op_amp
id|gab.end
)paren
)paren
(brace
id|gab.start
op_assign
id|htons
c_func
(paren
id|gab.start
)paren
suffix:semicolon
id|gab.end
op_assign
id|htons
c_func
(paren
id|gab.end
)paren
suffix:semicolon
id|sctp_addto_chunk
c_func
(paren
id|retval
comma
r_sizeof
(paren
id|sctp_gap_ack_block_t
)paren
comma
op_amp
id|gab
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Register the duplicates.  */
id|sctp_addto_chunk
c_func
(paren
id|retval
comma
r_sizeof
(paren
id|__u32
)paren
op_star
id|num_dup_tsns
comma
id|sctp_tsnmap_get_dups
c_func
(paren
id|map
)paren
)paren
suffix:semicolon
id|nodata
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* Make a SHUTDOWN chunk. */
DECL|function|sctp_make_shutdown
id|sctp_chunk_t
op_star
id|sctp_make_shutdown
c_func
(paren
r_const
r_struct
id|sctp_association
op_star
id|asoc
)paren
(brace
id|sctp_chunk_t
op_star
id|retval
suffix:semicolon
id|sctp_shutdownhdr_t
id|shut
suffix:semicolon
id|__u32
id|ctsn
suffix:semicolon
id|ctsn
op_assign
id|sctp_tsnmap_get_ctsn
c_func
(paren
op_amp
id|asoc-&gt;peer.tsn_map
)paren
suffix:semicolon
id|shut.cum_tsn_ack
op_assign
id|htonl
c_func
(paren
id|ctsn
)paren
suffix:semicolon
id|retval
op_assign
id|sctp_make_chunk
c_func
(paren
id|asoc
comma
id|SCTP_CID_SHUTDOWN
comma
l_int|0
comma
r_sizeof
(paren
id|sctp_shutdownhdr_t
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
r_goto
id|nodata
suffix:semicolon
id|retval-&gt;subh.shutdown_hdr
op_assign
id|sctp_addto_chunk
c_func
(paren
id|retval
comma
r_sizeof
(paren
id|shut
)paren
comma
op_amp
id|shut
)paren
suffix:semicolon
id|nodata
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
DECL|function|sctp_make_shutdown_ack
id|sctp_chunk_t
op_star
id|sctp_make_shutdown_ack
c_func
(paren
r_const
r_struct
id|sctp_association
op_star
id|asoc
comma
r_const
id|sctp_chunk_t
op_star
id|chunk
)paren
(brace
id|sctp_chunk_t
op_star
id|retval
suffix:semicolon
id|retval
op_assign
id|sctp_make_chunk
c_func
(paren
id|asoc
comma
id|SCTP_CID_SHUTDOWN_ACK
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* RFC 2960 6.4 Multi-homed SCTP Endpoints&n;&t; *&n;&t; * An endpoint SHOULD transmit reply chunks (e.g., SACK,&n;&t; * HEARTBEAT ACK, * etc.) to the same destination transport&n;&t; * address from which it * received the DATA or control chunk&n;&t; * to which it is replying.&n;&t; *&n;&t; * [ACK back to where the SHUTDOWN came from.]&n;&t; */
r_if
c_cond
(paren
id|retval
op_logical_and
id|chunk
)paren
id|retval-&gt;transport
op_assign
id|chunk-&gt;transport
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
DECL|function|sctp_make_shutdown_complete
id|sctp_chunk_t
op_star
id|sctp_make_shutdown_complete
c_func
(paren
r_const
r_struct
id|sctp_association
op_star
id|asoc
comma
r_const
id|sctp_chunk_t
op_star
id|chunk
)paren
(brace
id|sctp_chunk_t
op_star
id|retval
suffix:semicolon
id|__u8
id|flags
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Maybe set the T-bit if we have no association. */
id|flags
op_or_assign
id|asoc
ques
c_cond
l_int|0
suffix:colon
id|SCTP_CHUNK_FLAG_T
suffix:semicolon
id|retval
op_assign
id|sctp_make_chunk
c_func
(paren
id|asoc
comma
id|SCTP_CID_SHUTDOWN_COMPLETE
comma
id|flags
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* RFC 2960 6.4 Multi-homed SCTP Endpoints&n;&t; *&n;&t; * An endpoint SHOULD transmit reply chunks (e.g., SACK,&n;&t; * HEARTBEAT ACK, * etc.) to the same destination transport&n;&t; * address from which it * received the DATA or control chunk&n;&t; * to which it is replying.&n;&t; *&n;&t; * [Report SHUTDOWN COMPLETE back to where the SHUTDOWN ACK&n;&t; * came from.]&n;&t; */
r_if
c_cond
(paren
id|retval
op_logical_and
id|chunk
)paren
id|retval-&gt;transport
op_assign
id|chunk-&gt;transport
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* Create an ABORT.  Note that we set the T bit if we have no&n; * association.&n; */
DECL|function|sctp_make_abort
id|sctp_chunk_t
op_star
id|sctp_make_abort
c_func
(paren
r_const
r_struct
id|sctp_association
op_star
id|asoc
comma
r_const
id|sctp_chunk_t
op_star
id|chunk
comma
r_const
r_int
id|hint
)paren
(brace
id|sctp_chunk_t
op_star
id|retval
suffix:semicolon
id|__u8
id|flags
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Maybe set the T-bit if we have no association.  */
id|flags
op_or_assign
id|asoc
ques
c_cond
l_int|0
suffix:colon
id|SCTP_CHUNK_FLAG_T
suffix:semicolon
id|retval
op_assign
id|sctp_make_chunk
c_func
(paren
id|asoc
comma
id|SCTP_CID_ABORT
comma
id|flags
comma
id|hint
)paren
suffix:semicolon
multiline_comment|/* RFC 2960 6.4 Multi-homed SCTP Endpoints&n;&t; *&n;&t; * An endpoint SHOULD transmit reply chunks (e.g., SACK,&n;&t; * HEARTBEAT ACK, * etc.) to the same destination transport&n;&t; * address from which it * received the DATA or control chunk&n;&t; * to which it is replying.&n;&t; *&n;&t; * [ABORT back to where the offender came from.]&n;&t; */
r_if
c_cond
(paren
id|retval
op_logical_and
id|chunk
)paren
id|retval-&gt;transport
op_assign
id|chunk-&gt;transport
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* Helper to create ABORT with a NO_USER_DATA error.  */
DECL|function|sctp_make_abort_no_data
id|sctp_chunk_t
op_star
id|sctp_make_abort_no_data
c_func
(paren
r_const
r_struct
id|sctp_association
op_star
id|asoc
comma
r_const
id|sctp_chunk_t
op_star
id|chunk
comma
id|__u32
id|tsn
)paren
(brace
id|sctp_chunk_t
op_star
id|retval
suffix:semicolon
id|__u32
id|payload
suffix:semicolon
id|retval
op_assign
id|sctp_make_abort
c_func
(paren
id|asoc
comma
id|chunk
comma
r_sizeof
(paren
id|sctp_errhdr_t
)paren
op_plus
r_sizeof
(paren
id|tsn
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
r_goto
id|no_mem
suffix:semicolon
multiline_comment|/* Put the tsn back into network byte order.  */
id|payload
op_assign
id|htonl
c_func
(paren
id|tsn
)paren
suffix:semicolon
id|sctp_init_cause
c_func
(paren
id|retval
comma
id|SCTP_ERROR_NO_DATA
comma
(paren
r_const
r_void
op_star
)paren
op_amp
id|payload
comma
r_sizeof
(paren
id|payload
)paren
)paren
suffix:semicolon
multiline_comment|/* RFC 2960 6.4 Multi-homed SCTP Endpoints&n;&t; *&n;&t; * An endpoint SHOULD transmit reply chunks (e.g., SACK,&n;&t; * HEARTBEAT ACK, * etc.) to the same destination transport&n;&t; * address from which it * received the DATA or control chunk&n;&t; * to which it is replying.&n;&t; *&n;&t; * [ABORT back to where the offender came from.]&n;&t; */
r_if
c_cond
(paren
id|chunk
)paren
id|retval-&gt;transport
op_assign
id|chunk-&gt;transport
suffix:semicolon
id|no_mem
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* Helper to create ABORT with a SCTP_ERROR_USER_ABORT error.  */
DECL|function|sctp_make_abort_user
id|sctp_chunk_t
op_star
id|sctp_make_abort_user
c_func
(paren
r_const
r_struct
id|sctp_association
op_star
id|asoc
comma
r_const
id|sctp_chunk_t
op_star
id|chunk
comma
r_const
r_struct
id|msghdr
op_star
id|msg
)paren
(brace
id|sctp_chunk_t
op_star
id|retval
suffix:semicolon
r_void
op_star
id|payload
op_assign
l_int|NULL
comma
op_star
id|payoff
suffix:semicolon
r_int
id|paylen
suffix:semicolon
r_struct
id|iovec
op_star
id|iov
op_assign
id|msg-&gt;msg_iov
suffix:semicolon
r_int
id|iovlen
op_assign
id|msg-&gt;msg_iovlen
suffix:semicolon
id|paylen
op_assign
id|get_user_iov_size
c_func
(paren
id|iov
comma
id|iovlen
)paren
suffix:semicolon
id|retval
op_assign
id|sctp_make_abort
c_func
(paren
id|asoc
comma
id|chunk
comma
r_sizeof
(paren
id|sctp_errhdr_t
)paren
op_plus
id|paylen
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
r_goto
id|err_chunk
suffix:semicolon
r_if
c_cond
(paren
id|paylen
)paren
(brace
multiline_comment|/* Put the msg_iov together into payload.  */
id|payload
op_assign
id|kmalloc
c_func
(paren
id|paylen
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|payload
)paren
r_goto
id|err_payload
suffix:semicolon
id|payoff
op_assign
id|payload
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|iovlen
OG
l_int|0
suffix:semicolon
op_decrement
id|iovlen
)paren
(brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|payoff
comma
id|iov-&gt;iov_base
comma
id|iov-&gt;iov_len
)paren
)paren
r_goto
id|err_copy
suffix:semicolon
id|payoff
op_add_assign
id|iov-&gt;iov_len
suffix:semicolon
id|iov
op_increment
suffix:semicolon
)brace
)brace
id|sctp_init_cause
c_func
(paren
id|retval
comma
id|SCTP_ERROR_USER_ABORT
comma
id|payload
comma
id|paylen
)paren
suffix:semicolon
r_if
c_cond
(paren
id|paylen
)paren
id|kfree
c_func
(paren
id|payload
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
id|err_copy
suffix:colon
id|kfree
c_func
(paren
id|payload
)paren
suffix:semicolon
id|err_payload
suffix:colon
id|sctp_free_chunk
c_func
(paren
id|retval
)paren
suffix:semicolon
id|retval
op_assign
l_int|NULL
suffix:semicolon
id|err_chunk
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* Make a HEARTBEAT chunk.  */
DECL|function|sctp_make_heartbeat
id|sctp_chunk_t
op_star
id|sctp_make_heartbeat
c_func
(paren
r_const
r_struct
id|sctp_association
op_star
id|asoc
comma
r_const
r_struct
id|sctp_transport
op_star
id|transport
comma
r_const
r_void
op_star
id|payload
comma
r_const
r_int
id|paylen
)paren
(brace
id|sctp_chunk_t
op_star
id|retval
op_assign
id|sctp_make_chunk
c_func
(paren
id|asoc
comma
id|SCTP_CID_HEARTBEAT
comma
l_int|0
comma
id|paylen
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
r_goto
id|nodata
suffix:semicolon
multiline_comment|/* Cast away the &squot;const&squot;, as this is just telling the chunk&n;&t; * what transport it belongs to.&n;&t; */
id|retval-&gt;transport
op_assign
(paren
r_struct
id|sctp_transport
op_star
)paren
id|transport
suffix:semicolon
id|retval-&gt;subh.hbs_hdr
op_assign
id|sctp_addto_chunk
c_func
(paren
id|retval
comma
id|paylen
comma
id|payload
)paren
suffix:semicolon
id|nodata
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
DECL|function|sctp_make_heartbeat_ack
id|sctp_chunk_t
op_star
id|sctp_make_heartbeat_ack
c_func
(paren
r_const
r_struct
id|sctp_association
op_star
id|asoc
comma
r_const
id|sctp_chunk_t
op_star
id|chunk
comma
r_const
r_void
op_star
id|payload
comma
r_const
r_int
id|paylen
)paren
(brace
id|sctp_chunk_t
op_star
id|retval
op_assign
id|sctp_make_chunk
c_func
(paren
id|asoc
comma
id|SCTP_CID_HEARTBEAT_ACK
comma
l_int|0
comma
id|paylen
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
r_goto
id|nodata
suffix:semicolon
id|retval-&gt;subh.hbs_hdr
op_assign
id|sctp_addto_chunk
c_func
(paren
id|retval
comma
id|paylen
comma
id|payload
)paren
suffix:semicolon
multiline_comment|/* RFC 2960 6.4 Multi-homed SCTP Endpoints&n;&t; *&n;&t; * An endpoint SHOULD transmit reply chunks (e.g., SACK,&n;&t; * HEARTBEAT ACK, * etc.) to the same destination transport&n;&t; * address from which it * received the DATA or control chunk&n;&t; * to which it is replying.&n;&t; *&n;&t; * [HBACK back to where the HEARTBEAT came from.]&n;&t; */
r_if
c_cond
(paren
id|chunk
)paren
id|retval-&gt;transport
op_assign
id|chunk-&gt;transport
suffix:semicolon
id|nodata
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* Create an Operation Error chunk with the specified space reserved.&n; * This routine can be used for containing multiple causes in the chunk.&n; */
DECL|function|sctp_make_op_error_space
id|sctp_chunk_t
op_star
id|sctp_make_op_error_space
c_func
(paren
r_const
r_struct
id|sctp_association
op_star
id|asoc
comma
r_const
id|sctp_chunk_t
op_star
id|chunk
comma
r_int
id|size
)paren
(brace
id|sctp_chunk_t
op_star
id|retval
suffix:semicolon
id|retval
op_assign
id|sctp_make_chunk
c_func
(paren
id|asoc
comma
id|SCTP_CID_ERROR
comma
l_int|0
comma
r_sizeof
(paren
id|sctp_errhdr_t
)paren
op_plus
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
r_goto
id|nodata
suffix:semicolon
multiline_comment|/* RFC 2960 6.4 Multi-homed SCTP Endpoints&n;&t; *&n;&t; * An endpoint SHOULD transmit reply chunks (e.g., SACK,&n;&t; * HEARTBEAT ACK, etc.) to the same destination transport&n;&t; * address from which it received the DATA or control chunk&n;&t; * to which it is replying.&n;&t; *&n;&t; */
r_if
c_cond
(paren
id|chunk
)paren
id|retval-&gt;transport
op_assign
id|chunk-&gt;transport
suffix:semicolon
id|nodata
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* Create an Operation Error chunk.  */
DECL|function|sctp_make_op_error
id|sctp_chunk_t
op_star
id|sctp_make_op_error
c_func
(paren
r_const
r_struct
id|sctp_association
op_star
id|asoc
comma
r_const
id|sctp_chunk_t
op_star
id|chunk
comma
id|__u16
id|cause_code
comma
r_const
r_void
op_star
id|payload
comma
r_int
id|paylen
)paren
(brace
id|sctp_chunk_t
op_star
id|retval
op_assign
id|sctp_make_op_error_space
c_func
(paren
id|asoc
comma
id|chunk
comma
id|paylen
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
r_goto
id|nodata
suffix:semicolon
id|sctp_init_cause
c_func
(paren
id|retval
comma
id|cause_code
comma
id|payload
comma
id|paylen
)paren
suffix:semicolon
id|nodata
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/********************************************************************&n; * 2nd Level Abstractions&n; ********************************************************************/
multiline_comment|/* Turn an skb into a chunk.&n; * FIXME: Eventually move the structure directly inside the skb-&gt;cb[].&n; */
DECL|function|sctp_chunkify
id|sctp_chunk_t
op_star
id|sctp_chunkify
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_const
r_struct
id|sctp_association
op_star
id|asoc
comma
r_struct
id|sock
op_star
id|sk
)paren
(brace
id|sctp_chunk_t
op_star
id|retval
op_assign
id|t_new
c_func
(paren
id|sctp_chunk_t
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
r_goto
id|nodata
suffix:semicolon
id|memset
c_func
(paren
id|retval
comma
l_int|0
comma
r_sizeof
(paren
id|sctp_chunk_t
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sk
)paren
(brace
id|SCTP_DEBUG_PRINTK
c_func
(paren
l_string|&quot;chunkifying skb %p w/o an sk&bslash;n&quot;
comma
id|skb
)paren
suffix:semicolon
)brace
id|retval-&gt;skb
op_assign
id|skb
suffix:semicolon
id|retval-&gt;asoc
op_assign
(paren
r_struct
id|sctp_association
op_star
)paren
id|asoc
suffix:semicolon
id|retval-&gt;num_times_sent
op_assign
l_int|0
suffix:semicolon
id|retval-&gt;has_tsn
op_assign
l_int|0
suffix:semicolon
id|retval-&gt;has_ssn
op_assign
l_int|0
suffix:semicolon
id|retval-&gt;rtt_in_progress
op_assign
l_int|0
suffix:semicolon
id|retval-&gt;sent_at
op_assign
id|jiffies
suffix:semicolon
id|retval-&gt;singleton
op_assign
l_int|1
suffix:semicolon
id|retval-&gt;end_of_packet
op_assign
l_int|0
suffix:semicolon
id|retval-&gt;ecn_ce_done
op_assign
l_int|0
suffix:semicolon
id|retval-&gt;pdiscard
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* sctpimpguide-05.txt Section 2.8.2&n;&t; * M1) Each time a new DATA chunk is transmitted&n;&t; * set the &squot;TSN.Missing.Report&squot; count for that TSN to 0. The&n;&t; * &squot;TSN.Missing.Report&squot; count will be used to determine missing chunks&n;&t; * and when to fast retransmit.&n;&t; */
id|retval-&gt;tsn_missing_report
op_assign
l_int|0
suffix:semicolon
id|retval-&gt;tsn_gap_acked
op_assign
l_int|0
suffix:semicolon
id|retval-&gt;fast_retransmit
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Polish the bead hole.  */
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|retval-&gt;transmitted_list
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|retval-&gt;frag_list
)paren
suffix:semicolon
id|SCTP_DBG_OBJCNT_INC
c_func
(paren
id|chunk
)paren
suffix:semicolon
id|nodata
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* Set chunk-&gt;source and dest based on the IP header in chunk-&gt;skb.  */
DECL|function|sctp_init_addrs
r_void
id|sctp_init_addrs
c_func
(paren
id|sctp_chunk_t
op_star
id|chunk
comma
r_union
id|sctp_addr
op_star
id|src
comma
r_union
id|sctp_addr
op_star
id|dest
)paren
(brace
id|memcpy
c_func
(paren
op_amp
id|chunk-&gt;source
comma
id|src
comma
r_sizeof
(paren
r_union
id|sctp_addr
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|chunk-&gt;dest
comma
id|dest
comma
r_sizeof
(paren
r_union
id|sctp_addr
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Extract the source address from a chunk.  */
DECL|function|sctp_source
r_const
r_union
id|sctp_addr
op_star
id|sctp_source
c_func
(paren
r_const
id|sctp_chunk_t
op_star
id|chunk
)paren
(brace
multiline_comment|/* If we have a known transport, use that.  */
r_if
c_cond
(paren
id|chunk-&gt;transport
)paren
(brace
r_return
op_amp
id|chunk-&gt;transport-&gt;ipaddr
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Otherwise, extract it from the IP header.  */
r_return
op_amp
id|chunk-&gt;source
suffix:semicolon
)brace
)brace
multiline_comment|/* Create a new chunk, setting the type and flags headers from the&n; * arguments, reserving enough space for a &squot;paylen&squot; byte payload.&n; */
DECL|function|sctp_make_chunk
id|sctp_chunk_t
op_star
id|sctp_make_chunk
c_func
(paren
r_const
r_struct
id|sctp_association
op_star
id|asoc
comma
id|__u8
id|type
comma
id|__u8
id|flags
comma
r_int
id|paylen
)paren
(brace
id|sctp_chunk_t
op_star
id|retval
suffix:semicolon
id|sctp_chunkhdr_t
op_star
id|chunk_hdr
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_struct
id|sock
op_star
id|sk
suffix:semicolon
multiline_comment|/* No need to allocate LL here, as this is only a chunk. */
id|skb
op_assign
id|alloc_skb
c_func
(paren
id|WORD_ROUND
c_func
(paren
r_sizeof
(paren
id|sctp_chunkhdr_t
)paren
op_plus
id|paylen
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
r_goto
id|nodata
suffix:semicolon
multiline_comment|/* Make room for the chunk header.  */
id|chunk_hdr
op_assign
(paren
id|sctp_chunkhdr_t
op_star
)paren
id|skb_put
c_func
(paren
id|skb
comma
r_sizeof
(paren
id|sctp_chunkhdr_t
)paren
)paren
suffix:semicolon
id|chunk_hdr-&gt;type
op_assign
id|type
suffix:semicolon
id|chunk_hdr-&gt;flags
op_assign
id|flags
suffix:semicolon
id|chunk_hdr-&gt;length
op_assign
id|htons
c_func
(paren
r_sizeof
(paren
id|sctp_chunkhdr_t
)paren
)paren
suffix:semicolon
id|sk
op_assign
id|asoc
ques
c_cond
id|asoc-&gt;base.sk
suffix:colon
l_int|NULL
suffix:semicolon
id|retval
op_assign
id|sctp_chunkify
c_func
(paren
id|skb
comma
id|asoc
comma
id|sk
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
(brace
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_goto
id|nodata
suffix:semicolon
)brace
id|retval-&gt;chunk_hdr
op_assign
id|chunk_hdr
suffix:semicolon
id|retval-&gt;chunk_end
op_assign
(paren
(paren
id|__u8
op_star
)paren
id|chunk_hdr
)paren
op_plus
r_sizeof
(paren
id|sctp_chunkhdr_t
)paren
suffix:semicolon
multiline_comment|/* Set the skb to the belonging sock for accounting.  */
id|skb-&gt;sk
op_assign
id|sk
suffix:semicolon
r_return
id|retval
suffix:semicolon
id|nodata
suffix:colon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* Release the memory occupied by a chunk.  */
DECL|function|sctp_free_chunk
r_void
id|sctp_free_chunk
c_func
(paren
id|sctp_chunk_t
op_star
id|chunk
)paren
(brace
multiline_comment|/* Make sure that we are not on any list.  */
id|skb_unlink
c_func
(paren
(paren
r_struct
id|sk_buff
op_star
)paren
id|chunk
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|chunk-&gt;transmitted_list
)paren
suffix:semicolon
multiline_comment|/* Free the chunk skb data and the SCTP_chunk stub itself. */
id|dev_kfree_skb
c_func
(paren
id|chunk-&gt;skb
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|chunk
)paren
suffix:semicolon
id|SCTP_DBG_OBJCNT_DEC
c_func
(paren
id|chunk
)paren
suffix:semicolon
)brace
multiline_comment|/* Append bytes to the end of a chunk.  Will panic if chunk is not big&n; * enough.&n; */
DECL|function|sctp_addto_chunk
r_void
op_star
id|sctp_addto_chunk
c_func
(paren
id|sctp_chunk_t
op_star
id|chunk
comma
r_int
id|len
comma
r_const
r_void
op_star
id|data
)paren
(brace
r_void
op_star
id|target
suffix:semicolon
r_void
op_star
id|padding
suffix:semicolon
r_int
id|chunklen
op_assign
id|ntohs
c_func
(paren
id|chunk-&gt;chunk_hdr-&gt;length
)paren
suffix:semicolon
r_int
id|padlen
op_assign
id|chunklen
op_mod
l_int|4
suffix:semicolon
id|padding
op_assign
id|skb_put
c_func
(paren
id|chunk-&gt;skb
comma
id|padlen
)paren
suffix:semicolon
id|target
op_assign
id|skb_put
c_func
(paren
id|chunk-&gt;skb
comma
id|len
)paren
suffix:semicolon
id|memset
c_func
(paren
id|padding
comma
l_int|0
comma
id|padlen
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|target
comma
id|data
comma
id|len
)paren
suffix:semicolon
multiline_comment|/* Adjust the chunk length field.  */
id|chunk-&gt;chunk_hdr-&gt;length
op_assign
id|htons
c_func
(paren
id|chunklen
op_plus
id|padlen
op_plus
id|len
)paren
suffix:semicolon
id|chunk-&gt;chunk_end
op_assign
id|chunk-&gt;skb-&gt;tail
suffix:semicolon
r_return
id|target
suffix:semicolon
)brace
multiline_comment|/* Append bytes from user space to the end of a chunk.  Will panic if&n; * chunk is not big enough.&n; * Returns a kernel err value.&n; */
DECL|function|sctp_user_addto_chunk
r_static
r_int
id|sctp_user_addto_chunk
c_func
(paren
id|sctp_chunk_t
op_star
id|chunk
comma
r_int
id|off
comma
r_int
id|len
comma
r_struct
id|iovec
op_star
id|data
)paren
(brace
id|__u8
op_star
id|target
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Make room in chunk for data.  */
id|target
op_assign
id|skb_put
c_func
(paren
id|chunk-&gt;skb
comma
id|len
)paren
suffix:semicolon
multiline_comment|/* Copy data (whole iovec) into chunk */
r_if
c_cond
(paren
(paren
id|err
op_assign
id|memcpy_fromiovecend
c_func
(paren
id|target
comma
id|data
comma
id|off
comma
id|len
)paren
)paren
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* Adjust the chunk length field.  */
id|chunk-&gt;chunk_hdr-&gt;length
op_assign
id|htons
c_func
(paren
id|ntohs
c_func
(paren
id|chunk-&gt;chunk_hdr-&gt;length
)paren
op_plus
id|len
)paren
suffix:semicolon
id|chunk-&gt;chunk_end
op_assign
id|chunk-&gt;skb-&gt;tail
suffix:semicolon
id|out
suffix:colon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/* A data chunk can have a maximum payload of (2^16 - 20).  Break&n; * down any such message into smaller chunks.  Opportunistically, fragment&n; * the chunks down to the current MTU constraints.  We may get refragmented&n; * later if the PMTU changes, but it is _much better_ to fragment immediately&n; * with a reasonable guess than always doing our fragmentation on the&n; * soft-interrupt.&n; */
DECL|function|sctp_datachunks_from_user
r_int
id|sctp_datachunks_from_user
c_func
(paren
r_struct
id|sctp_association
op_star
id|asoc
comma
r_const
r_struct
id|sctp_sndrcvinfo
op_star
id|sinfo
comma
r_struct
id|msghdr
op_star
id|msg
comma
r_int
id|msg_len
comma
r_struct
id|sk_buff_head
op_star
id|chunks
)paren
(brace
r_int
id|max
comma
id|whole
comma
id|i
comma
id|offset
comma
id|over
comma
id|err
suffix:semicolon
r_int
id|len
comma
id|first_len
suffix:semicolon
id|sctp_chunk_t
op_star
id|chunk
suffix:semicolon
id|__u8
id|frag
suffix:semicolon
multiline_comment|/* What is a reasonable fragmentation point right now? */
id|max
op_assign
id|asoc-&gt;pmtu
suffix:semicolon
r_if
c_cond
(paren
id|max
OL
id|SCTP_MIN_PMTU
)paren
id|max
op_assign
id|SCTP_MIN_PMTU
suffix:semicolon
id|max
op_sub_assign
id|SCTP_IP_OVERHEAD
suffix:semicolon
multiline_comment|/* Make sure not beyond maximum chunk size. */
r_if
c_cond
(paren
id|max
OG
id|SCTP_MAX_CHUNK_LEN
)paren
id|max
op_assign
id|SCTP_MAX_CHUNK_LEN
suffix:semicolon
multiline_comment|/* Subtract out the overhead of a data chunk header. */
id|max
op_sub_assign
r_sizeof
(paren
r_struct
id|sctp_data_chunk
)paren
suffix:semicolon
id|whole
op_assign
l_int|0
suffix:semicolon
id|first_len
op_assign
id|max
suffix:semicolon
multiline_comment|/* Encourage Cookie-ECHO bundling. */
r_if
c_cond
(paren
id|asoc-&gt;state
OL
id|SCTP_STATE_COOKIE_ECHOED
)paren
(brace
id|whole
op_assign
id|msg_len
op_div
(paren
id|max
op_minus
id|SCTP_ARBITRARY_COOKIE_ECHO_LEN
)paren
suffix:semicolon
multiline_comment|/* Account for the DATA to be bundled with the COOKIE-ECHO. */
r_if
c_cond
(paren
id|whole
)paren
(brace
id|first_len
op_assign
id|max
op_minus
id|SCTP_ARBITRARY_COOKIE_ECHO_LEN
suffix:semicolon
id|msg_len
op_sub_assign
id|first_len
suffix:semicolon
id|whole
op_assign
l_int|1
suffix:semicolon
)brace
)brace
multiline_comment|/* How many full sized?  How many bytes leftover? */
id|whole
op_add_assign
id|msg_len
op_div
id|max
suffix:semicolon
id|over
op_assign
id|msg_len
op_mod
id|max
suffix:semicolon
id|offset
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|whole
op_logical_and
id|over
)paren
id|SCTP_INC_STATS_USER
c_func
(paren
id|SctpFragUsrMsgs
)paren
suffix:semicolon
multiline_comment|/* Create chunks for all the full sized DATA chunks. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|len
op_assign
id|first_len
suffix:semicolon
id|i
OL
id|whole
suffix:semicolon
id|i
op_increment
)paren
(brace
id|frag
op_assign
id|SCTP_DATA_MIDDLE_FRAG
suffix:semicolon
r_if
c_cond
(paren
l_int|0
op_eq
id|i
)paren
id|frag
op_or_assign
id|SCTP_DATA_FIRST_FRAG
suffix:semicolon
r_if
c_cond
(paren
(paren
id|i
op_eq
(paren
id|whole
op_minus
l_int|1
)paren
)paren
op_logical_and
op_logical_neg
id|over
)paren
id|frag
op_or_assign
id|SCTP_DATA_LAST_FRAG
suffix:semicolon
id|chunk
op_assign
id|sctp_make_datafrag_empty
c_func
(paren
id|asoc
comma
id|sinfo
comma
id|len
comma
id|frag
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|chunk
)paren
r_goto
id|nomem
suffix:semicolon
id|err
op_assign
id|sctp_user_addto_chunk
c_func
(paren
id|chunk
comma
id|offset
comma
id|len
comma
id|msg-&gt;msg_iov
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
r_goto
id|errout
suffix:semicolon
id|offset
op_add_assign
id|len
suffix:semicolon
multiline_comment|/* Put the chunk-&gt;skb back into the form expected by send.  */
id|__skb_pull
c_func
(paren
id|chunk-&gt;skb
comma
(paren
id|__u8
op_star
)paren
id|chunk-&gt;chunk_hdr
op_minus
(paren
id|__u8
op_star
)paren
id|chunk-&gt;skb-&gt;data
)paren
suffix:semicolon
id|__skb_queue_tail
c_func
(paren
id|chunks
comma
(paren
r_struct
id|sk_buff
op_star
)paren
id|chunk
)paren
suffix:semicolon
multiline_comment|/* The first chunk, the first chunk was likely short&n;&t;&t; * to allow bundling, so reset to full size.&n;&t;&t; */
r_if
c_cond
(paren
l_int|0
op_eq
id|i
)paren
id|len
op_assign
id|max
suffix:semicolon
)brace
multiline_comment|/* .. now the leftover bytes. */
r_if
c_cond
(paren
id|over
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|whole
)paren
id|frag
op_assign
id|SCTP_DATA_NOT_FRAG
suffix:semicolon
r_else
id|frag
op_assign
id|SCTP_DATA_LAST_FRAG
suffix:semicolon
id|chunk
op_assign
id|sctp_make_datafrag_empty
c_func
(paren
id|asoc
comma
id|sinfo
comma
id|over
comma
id|frag
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|chunk
)paren
r_goto
id|nomem
suffix:semicolon
id|err
op_assign
id|sctp_user_addto_chunk
c_func
(paren
id|chunk
comma
id|offset
comma
id|over
comma
id|msg-&gt;msg_iov
)paren
suffix:semicolon
multiline_comment|/* Put the chunk-&gt;skb back into the form expected by send.  */
id|__skb_pull
c_func
(paren
id|chunk-&gt;skb
comma
(paren
id|__u8
op_star
)paren
id|chunk-&gt;chunk_hdr
op_minus
(paren
id|__u8
op_star
)paren
id|chunk-&gt;skb-&gt;data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
r_goto
id|errout
suffix:semicolon
id|__skb_queue_tail
c_func
(paren
id|chunks
comma
(paren
r_struct
id|sk_buff
op_star
)paren
id|chunk
)paren
suffix:semicolon
)brace
id|err
op_assign
l_int|0
suffix:semicolon
r_goto
id|out
suffix:semicolon
id|nomem
suffix:colon
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
id|errout
suffix:colon
r_while
c_loop
(paren
(paren
id|chunk
op_assign
(paren
id|sctp_chunk_t
op_star
)paren
id|__skb_dequeue
c_func
(paren
id|chunks
)paren
)paren
)paren
id|sctp_free_chunk
c_func
(paren
id|chunk
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/* Helper function to assign a TSN if needed.  This assumes that both&n; * the data_hdr and association have already been assigned.&n; */
DECL|function|sctp_chunk_assign_ssn
r_void
id|sctp_chunk_assign_ssn
c_func
(paren
id|sctp_chunk_t
op_star
id|chunk
)paren
(brace
id|__u16
id|ssn
suffix:semicolon
id|__u16
id|sid
suffix:semicolon
r_if
c_cond
(paren
id|chunk-&gt;has_ssn
)paren
r_return
suffix:semicolon
multiline_comment|/* This is the last possible instant to assign a SSN. */
r_if
c_cond
(paren
id|chunk-&gt;chunk_hdr-&gt;flags
op_amp
id|SCTP_DATA_UNORDERED
)paren
(brace
id|ssn
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|sid
op_assign
id|htons
c_func
(paren
id|chunk-&gt;subh.data_hdr-&gt;stream
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chunk-&gt;chunk_hdr-&gt;flags
op_amp
id|SCTP_DATA_LAST_FRAG
)paren
id|ssn
op_assign
id|sctp_ssn_next
c_func
(paren
op_amp
id|chunk-&gt;asoc-&gt;ssnmap-&gt;out
comma
id|sid
)paren
suffix:semicolon
r_else
id|ssn
op_assign
id|sctp_ssn_peek
c_func
(paren
op_amp
id|chunk-&gt;asoc-&gt;ssnmap-&gt;out
comma
id|sid
)paren
suffix:semicolon
id|ssn
op_assign
id|htons
c_func
(paren
id|ssn
)paren
suffix:semicolon
)brace
id|chunk-&gt;subh.data_hdr-&gt;ssn
op_assign
id|ssn
suffix:semicolon
id|chunk-&gt;has_ssn
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Helper function to assign a TSN if needed.  This assumes that both&n; * the data_hdr and association have already been assigned.&n; */
DECL|function|sctp_chunk_assign_tsn
r_void
id|sctp_chunk_assign_tsn
c_func
(paren
id|sctp_chunk_t
op_star
id|chunk
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|chunk-&gt;has_tsn
)paren
(brace
multiline_comment|/* This is the last possible instant to&n;&t;&t; * assign a TSN.&n;&t;&t; */
id|chunk-&gt;subh.data_hdr-&gt;tsn
op_assign
id|htonl
c_func
(paren
id|sctp_association_get_next_tsn
c_func
(paren
id|chunk-&gt;asoc
)paren
)paren
suffix:semicolon
id|chunk-&gt;has_tsn
op_assign
l_int|1
suffix:semicolon
)brace
)brace
multiline_comment|/* Create a CLOSED association to use with an incoming packet.  */
DECL|function|sctp_make_temp_asoc
r_struct
id|sctp_association
op_star
id|sctp_make_temp_asoc
c_func
(paren
r_const
r_struct
id|sctp_endpoint
op_star
id|ep
comma
r_struct
id|sctp_chunk
op_star
id|chunk
comma
r_int
id|gfp
)paren
(brace
r_struct
id|sctp_association
op_star
id|asoc
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|sctp_scope_t
id|scope
suffix:semicolon
multiline_comment|/* Create the bare association.  */
id|scope
op_assign
id|sctp_scope
c_func
(paren
id|sctp_source
c_func
(paren
id|chunk
)paren
)paren
suffix:semicolon
id|asoc
op_assign
id|sctp_association_new
c_func
(paren
id|ep
comma
id|ep-&gt;base.sk
comma
id|scope
comma
id|gfp
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|asoc
)paren
r_goto
id|nodata
suffix:semicolon
id|skb
op_assign
id|chunk-&gt;skb
suffix:semicolon
multiline_comment|/* Create an entry for the source address of the packet.  */
multiline_comment|/* FIXME: Use the af specific helpers. */
r_switch
c_cond
(paren
id|skb-&gt;nh.iph-&gt;version
)paren
(brace
r_case
l_int|4
suffix:colon
id|asoc-&gt;c.peer_addr.v4.sin_family
op_assign
id|AF_INET
suffix:semicolon
id|asoc-&gt;c.peer_addr.v4.sin_port
op_assign
id|ntohs
c_func
(paren
id|chunk-&gt;sctp_hdr-&gt;source
)paren
suffix:semicolon
id|asoc-&gt;c.peer_addr.v4.sin_addr.s_addr
op_assign
id|skb-&gt;nh.iph-&gt;saddr
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|6
suffix:colon
id|asoc-&gt;c.peer_addr.v6.sin6_family
op_assign
id|AF_INET6
suffix:semicolon
id|asoc-&gt;c.peer_addr.v6.sin6_port
op_assign
id|ntohs
c_func
(paren
id|chunk-&gt;sctp_hdr-&gt;source
)paren
suffix:semicolon
id|asoc-&gt;c.peer_addr.v6.sin6_flowinfo
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* BUG BUG BUG */
id|asoc-&gt;c.peer_addr.v6.sin6_addr
op_assign
id|skb-&gt;nh.ipv6h-&gt;saddr
suffix:semicolon
id|asoc-&gt;c.peer_addr.v6.sin6_scope_id
op_assign
(paren
(paren
r_struct
id|inet6_skb_parm
op_star
)paren
id|skb-&gt;cb
)paren
op_member_access_from_pointer
id|iif
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* Yikes!  I never heard of this kind of address.  */
r_goto
id|fail
suffix:semicolon
)brace
suffix:semicolon
id|nodata
suffix:colon
r_return
id|asoc
suffix:semicolon
id|fail
suffix:colon
id|sctp_association_free
c_func
(paren
id|asoc
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* Build a cookie representing asoc.&n; * This INCLUDES the param header needed to put the cookie in the INIT ACK.&n; */
DECL|function|sctp_pack_cookie
id|sctp_cookie_param_t
op_star
id|sctp_pack_cookie
c_func
(paren
r_const
r_struct
id|sctp_endpoint
op_star
id|ep
comma
r_const
r_struct
id|sctp_association
op_star
id|asoc
comma
r_const
id|sctp_chunk_t
op_star
id|init_chunk
comma
r_int
op_star
id|cookie_len
comma
r_const
id|__u8
op_star
id|raw_addrs
comma
r_int
id|addrs_len
)paren
(brace
id|sctp_cookie_param_t
op_star
id|retval
suffix:semicolon
id|sctp_signed_cookie_t
op_star
id|cookie
suffix:semicolon
r_struct
id|scatterlist
id|sg
suffix:semicolon
r_int
id|headersize
comma
id|bodysize
suffix:semicolon
r_int
r_int
id|keylen
suffix:semicolon
r_char
op_star
id|key
suffix:semicolon
id|headersize
op_assign
r_sizeof
(paren
id|sctp_paramhdr_t
)paren
op_plus
id|SCTP_SECRET_SIZE
suffix:semicolon
id|bodysize
op_assign
r_sizeof
(paren
id|sctp_cookie_t
)paren
op_plus
id|ntohs
c_func
(paren
id|init_chunk-&gt;chunk_hdr-&gt;length
)paren
op_plus
id|addrs_len
suffix:semicolon
multiline_comment|/* Pad out the cookie to a multiple to make the signature&n;&t; * functions simpler to write.&n;&t; */
r_if
c_cond
(paren
id|bodysize
op_mod
id|SCTP_COOKIE_MULTIPLE
)paren
id|bodysize
op_add_assign
id|SCTP_COOKIE_MULTIPLE
op_minus
(paren
id|bodysize
op_mod
id|SCTP_COOKIE_MULTIPLE
)paren
suffix:semicolon
op_star
id|cookie_len
op_assign
id|headersize
op_plus
id|bodysize
suffix:semicolon
id|retval
op_assign
(paren
id|sctp_cookie_param_t
op_star
)paren
id|kmalloc
c_func
(paren
op_star
id|cookie_len
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
(brace
op_star
id|cookie_len
op_assign
l_int|0
suffix:semicolon
r_goto
id|nodata
suffix:semicolon
)brace
multiline_comment|/* Clear this memory since we are sending this data structure&n;&t; * out on the network.&n;&t; */
id|memset
c_func
(paren
id|retval
comma
l_int|0x00
comma
op_star
id|cookie_len
)paren
suffix:semicolon
id|cookie
op_assign
(paren
id|sctp_signed_cookie_t
op_star
)paren
id|retval-&gt;body
suffix:semicolon
multiline_comment|/* Set up the parameter header.  */
id|retval-&gt;p.type
op_assign
id|SCTP_PARAM_STATE_COOKIE
suffix:semicolon
id|retval-&gt;p.length
op_assign
id|htons
c_func
(paren
op_star
id|cookie_len
)paren
suffix:semicolon
multiline_comment|/* Copy the cookie part of the association itself.  */
id|cookie-&gt;c
op_assign
id|asoc-&gt;c
suffix:semicolon
multiline_comment|/* Save the raw address list length in the cookie. */
id|cookie-&gt;c.raw_addr_list_len
op_assign
id|addrs_len
suffix:semicolon
multiline_comment|/* Set an expiration time for the cookie.  */
id|do_gettimeofday
c_func
(paren
op_amp
id|cookie-&gt;c.expiration
)paren
suffix:semicolon
id|tv_add
c_func
(paren
op_amp
id|asoc-&gt;cookie_life
comma
op_amp
id|cookie-&gt;c.expiration
)paren
suffix:semicolon
multiline_comment|/* Copy the peer&squot;s init packet.  */
id|memcpy
c_func
(paren
op_amp
id|cookie-&gt;c.peer_init
(braket
l_int|0
)braket
comma
id|init_chunk-&gt;chunk_hdr
comma
id|ntohs
c_func
(paren
id|init_chunk-&gt;chunk_hdr-&gt;length
)paren
)paren
suffix:semicolon
multiline_comment|/* Copy the raw local address list of the association. */
id|memcpy
c_func
(paren
(paren
id|__u8
op_star
)paren
op_amp
id|cookie-&gt;c.peer_init
(braket
l_int|0
)braket
op_plus
id|ntohs
c_func
(paren
id|init_chunk-&gt;chunk_hdr-&gt;length
)paren
comma
id|raw_addrs
comma
id|addrs_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sctp_sk
c_func
(paren
id|ep-&gt;base.sk
)paren
op_member_access_from_pointer
id|hmac
)paren
(brace
multiline_comment|/* Sign the message.  */
id|sg.page
op_assign
id|virt_to_page
c_func
(paren
op_amp
id|cookie-&gt;c
)paren
suffix:semicolon
id|sg.offset
op_assign
(paren
r_int
r_int
)paren
(paren
op_amp
id|cookie-&gt;c
)paren
op_mod
id|PAGE_SIZE
suffix:semicolon
id|sg.length
op_assign
id|bodysize
suffix:semicolon
id|keylen
op_assign
id|SCTP_SECRET_SIZE
suffix:semicolon
id|key
op_assign
(paren
r_char
op_star
)paren
id|ep-&gt;secret_key
(braket
id|ep-&gt;current_key
)braket
suffix:semicolon
id|sctp_crypto_hmac
c_func
(paren
id|sctp_sk
c_func
(paren
id|ep-&gt;base.sk
)paren
op_member_access_from_pointer
id|hmac
comma
id|key
comma
op_amp
id|keylen
comma
op_amp
id|sg
comma
l_int|1
comma
id|cookie-&gt;signature
)paren
suffix:semicolon
)brace
id|nodata
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* Unpack the cookie from COOKIE ECHO chunk, recreating the association.  */
DECL|function|sctp_unpack_cookie
r_struct
id|sctp_association
op_star
id|sctp_unpack_cookie
c_func
(paren
r_const
r_struct
id|sctp_endpoint
op_star
id|ep
comma
r_const
r_struct
id|sctp_association
op_star
id|asoc
comma
id|sctp_chunk_t
op_star
id|chunk
comma
r_int
id|gfp
comma
r_int
op_star
id|error
comma
id|sctp_chunk_t
op_star
op_star
id|errp
)paren
(brace
r_struct
id|sctp_association
op_star
id|retval
op_assign
l_int|NULL
suffix:semicolon
id|sctp_signed_cookie_t
op_star
id|cookie
suffix:semicolon
id|sctp_cookie_t
op_star
id|bear_cookie
suffix:semicolon
r_int
id|headersize
comma
id|bodysize
comma
id|fixed_size
suffix:semicolon
id|__u8
id|digest
(braket
id|SCTP_SIGNATURE_SIZE
)braket
suffix:semicolon
r_struct
id|scatterlist
id|sg
suffix:semicolon
r_int
r_int
id|keylen
suffix:semicolon
r_char
op_star
id|key
suffix:semicolon
id|sctp_scope_t
id|scope
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
op_assign
id|chunk-&gt;skb
suffix:semicolon
id|headersize
op_assign
r_sizeof
(paren
id|sctp_chunkhdr_t
)paren
op_plus
id|SCTP_SECRET_SIZE
suffix:semicolon
id|bodysize
op_assign
id|ntohs
c_func
(paren
id|chunk-&gt;chunk_hdr-&gt;length
)paren
op_minus
id|headersize
suffix:semicolon
id|fixed_size
op_assign
id|headersize
op_plus
r_sizeof
(paren
id|sctp_cookie_t
)paren
suffix:semicolon
multiline_comment|/* Verify that the chunk looks like it even has a cookie.&n;&t; * There must be enough room for our cookie and our peer&squot;s&n;&t; * INIT chunk.&n;&t; */
r_if
c_cond
(paren
id|ntohs
c_func
(paren
id|chunk-&gt;chunk_hdr-&gt;length
)paren
OL
(paren
id|fixed_size
op_plus
r_sizeof
(paren
id|sctp_chunkhdr_t
)paren
)paren
)paren
r_goto
id|malformed
suffix:semicolon
multiline_comment|/* Verify that the cookie has been padded out. */
r_if
c_cond
(paren
id|bodysize
op_mod
id|SCTP_COOKIE_MULTIPLE
)paren
r_goto
id|malformed
suffix:semicolon
multiline_comment|/* Process the cookie.  */
id|cookie
op_assign
id|chunk-&gt;subh.cookie_hdr
suffix:semicolon
id|bear_cookie
op_assign
op_amp
id|cookie-&gt;c
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sctp_sk
c_func
(paren
id|ep-&gt;base.sk
)paren
op_member_access_from_pointer
id|hmac
)paren
r_goto
id|no_hmac
suffix:semicolon
multiline_comment|/* Check the signature.  */
id|keylen
op_assign
id|SCTP_SECRET_SIZE
suffix:semicolon
id|sg.page
op_assign
id|virt_to_page
c_func
(paren
id|bear_cookie
)paren
suffix:semicolon
id|sg.offset
op_assign
(paren
r_int
r_int
)paren
(paren
id|bear_cookie
)paren
op_mod
id|PAGE_SIZE
suffix:semicolon
id|sg.length
op_assign
id|bodysize
suffix:semicolon
id|key
op_assign
(paren
r_char
op_star
)paren
id|ep-&gt;secret_key
(braket
id|ep-&gt;current_key
)braket
suffix:semicolon
id|memset
c_func
(paren
id|digest
comma
l_int|0x00
comma
r_sizeof
(paren
id|digest
)paren
)paren
suffix:semicolon
id|sctp_crypto_hmac
c_func
(paren
id|sctp_sk
c_func
(paren
id|ep-&gt;base.sk
)paren
op_member_access_from_pointer
id|hmac
comma
id|key
comma
op_amp
id|keylen
comma
op_amp
id|sg
comma
l_int|1
comma
id|digest
)paren
suffix:semicolon
r_if
c_cond
(paren
id|memcmp
c_func
(paren
id|digest
comma
id|cookie-&gt;signature
comma
id|SCTP_SIGNATURE_SIZE
)paren
)paren
(brace
multiline_comment|/* Try the previous key. */
id|key
op_assign
(paren
r_char
op_star
)paren
id|ep-&gt;secret_key
(braket
id|ep-&gt;last_key
)braket
suffix:semicolon
id|memset
c_func
(paren
id|digest
comma
l_int|0x00
comma
r_sizeof
(paren
id|digest
)paren
)paren
suffix:semicolon
id|sctp_crypto_hmac
c_func
(paren
id|sctp_sk
c_func
(paren
id|ep-&gt;base.sk
)paren
op_member_access_from_pointer
id|hmac
comma
id|key
comma
op_amp
id|keylen
comma
op_amp
id|sg
comma
l_int|1
comma
id|digest
)paren
suffix:semicolon
r_if
c_cond
(paren
id|memcmp
c_func
(paren
id|digest
comma
id|cookie-&gt;signature
comma
id|SCTP_SIGNATURE_SIZE
)paren
)paren
(brace
multiline_comment|/* Yikes!  Still bad signature! */
op_star
id|error
op_assign
op_minus
id|SCTP_IERROR_BAD_SIG
suffix:semicolon
r_goto
id|fail
suffix:semicolon
)brace
)brace
id|no_hmac
suffix:colon
multiline_comment|/* Check to see if the cookie is stale.  If there is already&n;&t; * an association, there is no need to check cookie&squot;s expiration&n;&t; * for init collision case of lost COOKIE ACK.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|asoc
op_logical_and
id|tv_lt
c_func
(paren
id|bear_cookie-&gt;expiration
comma
id|skb-&gt;stamp
)paren
)paren
(brace
id|__u16
id|len
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Section 3.3.10.3 Stale Cookie Error (3)&n;&t;&t; *&n;&t;&t; * Cause of error&n;&t;&t; * ---------------&n;&t;&t; * Stale Cookie Error:  Indicates the receipt of a valid State&n;&t;&t; * Cookie that has expired.&n;&t;&t; */
id|len
op_assign
id|ntohs
c_func
(paren
id|chunk-&gt;chunk_hdr-&gt;length
)paren
suffix:semicolon
op_star
id|errp
op_assign
id|sctp_make_op_error_space
c_func
(paren
id|asoc
comma
id|chunk
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|errp
)paren
(brace
id|suseconds_t
id|usecs
op_assign
(paren
id|skb-&gt;stamp.tv_sec
op_minus
id|bear_cookie-&gt;expiration.tv_sec
)paren
op_star
l_int|1000000L
op_plus
id|skb-&gt;stamp.tv_usec
op_minus
id|bear_cookie-&gt;expiration.tv_usec
suffix:semicolon
id|usecs
op_assign
id|htonl
c_func
(paren
id|usecs
)paren
suffix:semicolon
id|sctp_init_cause
c_func
(paren
op_star
id|errp
comma
id|SCTP_ERROR_STALE_COOKIE
comma
op_amp
id|usecs
comma
r_sizeof
(paren
id|usecs
)paren
)paren
suffix:semicolon
op_star
id|error
op_assign
op_minus
id|SCTP_IERROR_STALE_COOKIE
suffix:semicolon
)brace
r_else
op_star
id|error
op_assign
op_minus
id|SCTP_IERROR_NOMEM
suffix:semicolon
r_goto
id|fail
suffix:semicolon
)brace
multiline_comment|/* Make a new base association.  */
id|scope
op_assign
id|sctp_scope
c_func
(paren
id|sctp_source
c_func
(paren
id|chunk
)paren
)paren
suffix:semicolon
id|retval
op_assign
id|sctp_association_new
c_func
(paren
id|ep
comma
id|ep-&gt;base.sk
comma
id|scope
comma
id|gfp
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
(brace
op_star
id|error
op_assign
op_minus
id|SCTP_IERROR_NOMEM
suffix:semicolon
r_goto
id|fail
suffix:semicolon
)brace
multiline_comment|/* Set up our peer&squot;s port number.  */
id|retval-&gt;peer.port
op_assign
id|ntohs
c_func
(paren
id|chunk-&gt;sctp_hdr-&gt;source
)paren
suffix:semicolon
multiline_comment|/* Populate the association from the cookie.  */
id|retval-&gt;c
op_assign
op_star
id|bear_cookie
suffix:semicolon
r_if
c_cond
(paren
id|sctp_assoc_set_bind_addr_from_cookie
c_func
(paren
id|retval
comma
id|bear_cookie
comma
id|GFP_ATOMIC
)paren
OL
l_int|0
)paren
(brace
op_star
id|error
op_assign
op_minus
id|SCTP_IERROR_NOMEM
suffix:semicolon
r_goto
id|fail
suffix:semicolon
)brace
id|retval-&gt;next_tsn
op_assign
id|retval-&gt;c.initial_tsn
suffix:semicolon
id|retval-&gt;ctsn_ack_point
op_assign
id|retval-&gt;next_tsn
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* The INIT stuff will be done by the side effects.  */
r_return
id|retval
suffix:semicolon
id|fail
suffix:colon
r_if
c_cond
(paren
id|retval
)paren
id|sctp_association_free
c_func
(paren
id|retval
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
id|malformed
suffix:colon
multiline_comment|/* Yikes!  The packet is either corrupt or deliberately&n;&t; * malformed.&n;&t; */
op_star
id|error
op_assign
op_minus
id|SCTP_IERROR_MALFORMED
suffix:semicolon
r_goto
id|fail
suffix:semicolon
)brace
multiline_comment|/********************************************************************&n; * 3rd Level Abstractions&n; ********************************************************************/
DECL|struct|__sctp_missing
r_struct
id|__sctp_missing
(brace
DECL|member|num_missing
id|__u32
id|num_missing
suffix:semicolon
DECL|member|type
id|__u16
id|type
suffix:semicolon
)brace
id|__attribute__
c_func
(paren
(paren
id|packed
)paren
)paren
suffix:semicolon
suffix:semicolon
multiline_comment|/*&n; * Report a missing mandatory parameter.&n; */
DECL|function|sctp_process_missing_param
r_static
r_int
id|sctp_process_missing_param
c_func
(paren
r_const
r_struct
id|sctp_association
op_star
id|asoc
comma
id|sctp_param_t
id|paramtype
comma
id|sctp_chunk_t
op_star
id|chunk
comma
id|sctp_chunk_t
op_star
op_star
id|errp
)paren
(brace
r_struct
id|__sctp_missing
id|report
suffix:semicolon
id|__u16
id|len
suffix:semicolon
id|len
op_assign
id|WORD_ROUND
c_func
(paren
r_sizeof
(paren
id|report
)paren
)paren
suffix:semicolon
multiline_comment|/* Make an ERROR chunk, preparing enough room for&n;&t; * returning multiple unknown parameters.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
op_star
id|errp
)paren
op_star
id|errp
op_assign
id|sctp_make_op_error_space
c_func
(paren
id|asoc
comma
id|chunk
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|errp
)paren
(brace
id|report.num_missing
op_assign
id|htonl
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|report.type
op_assign
id|paramtype
suffix:semicolon
id|sctp_init_cause
c_func
(paren
op_star
id|errp
comma
id|SCTP_ERROR_INV_PARAM
comma
op_amp
id|report
comma
r_sizeof
(paren
id|report
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Stop processing this chunk. */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Report an Invalid Mandatory Parameter.  */
DECL|function|sctp_process_inv_mandatory
r_static
r_int
id|sctp_process_inv_mandatory
c_func
(paren
r_const
r_struct
id|sctp_association
op_star
id|asoc
comma
id|sctp_chunk_t
op_star
id|chunk
comma
id|sctp_chunk_t
op_star
op_star
id|errp
)paren
(brace
multiline_comment|/* Invalid Mandatory Parameter Error has no payload. */
r_if
c_cond
(paren
op_logical_neg
op_star
id|errp
)paren
op_star
id|errp
op_assign
id|sctp_make_op_error_space
c_func
(paren
id|asoc
comma
id|chunk
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|errp
)paren
id|sctp_init_cause
c_func
(paren
op_star
id|errp
comma
id|SCTP_ERROR_INV_PARAM
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Stop processing this chunk. */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Do not attempt to handle the HOST_NAME parm.  However, do&n; * send back an indicator to the peer.&n; */
DECL|function|sctp_process_hn_param
r_static
r_int
id|sctp_process_hn_param
c_func
(paren
r_const
r_struct
id|sctp_association
op_star
id|asoc
comma
r_union
id|sctp_params
id|param
comma
id|sctp_chunk_t
op_star
id|chunk
comma
id|sctp_chunk_t
op_star
op_star
id|errp
)paren
(brace
id|__u16
id|len
op_assign
id|ntohs
c_func
(paren
id|param.p-&gt;length
)paren
suffix:semicolon
multiline_comment|/* Make an ERROR chunk. */
r_if
c_cond
(paren
op_logical_neg
op_star
id|errp
)paren
op_star
id|errp
op_assign
id|sctp_make_op_error_space
c_func
(paren
id|asoc
comma
id|chunk
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|errp
)paren
id|sctp_init_cause
c_func
(paren
op_star
id|errp
comma
id|SCTP_ERROR_DNS_FAILED
comma
id|param.v
comma
id|len
)paren
suffix:semicolon
multiline_comment|/* Stop processing this chunk. */
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* RFC 3.2.1 &amp; the Implementers Guide 2.2.&n; *&n; * The Parameter Types are encoded such that the&n; * highest-order two bits specify the action that must be&n; * taken if the processing endpoint does not recognize the&n; * Parameter Type.&n; *&n; * 00 - Stop processing this SCTP chunk and discard it,&n; *&t;do not process any further chunks within it.&n; *&n; * 01 - Stop processing this SCTP chunk and discard it,&n; *&t;do not process any further chunks within it, and report&n; *&t;the unrecognized parameter in an &squot;Unrecognized&n; *&t;Parameter Type&squot; (in either an ERROR or in the INIT ACK).&n; *&n; * 10 - Skip this parameter and continue processing.&n; *&n; * 11 - Skip this parameter and continue processing but&n; *&t;report the unrecognized parameter in an&n; *&t;&squot;Unrecognized Parameter Type&squot; (in either an ERROR or in&n; *&t;the INIT ACK).&n; *&n; * Return value:&n; * &t;0 - discard the chunk&n; * &t;1 - continue with the chunk&n; */
DECL|function|sctp_process_unk_param
r_static
r_int
id|sctp_process_unk_param
c_func
(paren
r_const
r_struct
id|sctp_association
op_star
id|asoc
comma
r_union
id|sctp_params
id|param
comma
id|sctp_chunk_t
op_star
id|chunk
comma
id|sctp_chunk_t
op_star
op_star
id|errp
)paren
(brace
r_int
id|retval
op_assign
l_int|1
suffix:semicolon
r_switch
c_cond
(paren
id|param.p-&gt;type
op_amp
id|SCTP_PARAM_ACTION_MASK
)paren
(brace
r_case
id|SCTP_PARAM_ACTION_DISCARD
suffix:colon
id|retval
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SCTP_PARAM_ACTION_DISCARD_ERR
suffix:colon
id|retval
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Make an ERROR chunk, preparing enough room for&n;&t;&t; * returning multiple unknown parameters.&n;&t;&t; */
r_if
c_cond
(paren
l_int|NULL
op_eq
op_star
id|errp
)paren
op_star
id|errp
op_assign
id|sctp_make_op_error_space
c_func
(paren
id|asoc
comma
id|chunk
comma
id|ntohs
c_func
(paren
id|chunk-&gt;chunk_hdr-&gt;length
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|errp
)paren
id|sctp_init_cause
c_func
(paren
op_star
id|errp
comma
id|SCTP_ERROR_UNKNOWN_PARAM
comma
id|param.v
comma
id|WORD_ROUND
c_func
(paren
id|ntohs
c_func
(paren
id|param.p-&gt;length
)paren
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SCTP_PARAM_ACTION_SKIP
suffix:colon
r_break
suffix:semicolon
r_case
id|SCTP_PARAM_ACTION_SKIP_ERR
suffix:colon
multiline_comment|/* Make an ERROR chunk, preparing enough room for&n;&t;&t; * returning multiple unknown parameters.&n;&t;&t; */
r_if
c_cond
(paren
l_int|NULL
op_eq
op_star
id|errp
)paren
op_star
id|errp
op_assign
id|sctp_make_op_error_space
c_func
(paren
id|asoc
comma
id|chunk
comma
id|ntohs
c_func
(paren
id|chunk-&gt;chunk_hdr-&gt;length
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|errp
)paren
(brace
id|sctp_init_cause
c_func
(paren
op_star
id|errp
comma
id|SCTP_ERROR_UNKNOWN_PARAM
comma
id|param.v
comma
id|WORD_ROUND
c_func
(paren
id|ntohs
c_func
(paren
id|param.p-&gt;length
)paren
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* If there is no memory for generating the ERROR&n;&t;&t;&t; * report as specified, an ABORT will be triggered&n;&t;&t;&t; * to the peer and the association won&squot;t be&n;&t;&t;&t; * established.&n;&t;&t;&t; */
id|retval
op_assign
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* Find unrecognized parameters in the chunk.&n; * Return values:&n; * &t;0 - discard the chunk&n; * &t;1 - continue with the chunk&n; */
DECL|function|sctp_verify_param
r_static
r_int
id|sctp_verify_param
c_func
(paren
r_const
r_struct
id|sctp_association
op_star
id|asoc
comma
r_union
id|sctp_params
id|param
comma
id|sctp_cid_t
id|cid
comma
id|sctp_chunk_t
op_star
id|chunk
comma
id|sctp_chunk_t
op_star
op_star
id|err_chunk
)paren
(brace
r_int
id|retval
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* FIXME - This routine is not looking at each parameter per the&n;&t; * chunk type, i.e., unrecognized parameters should be further&n;&t; * identified based on the chunk id.&n;&t; */
r_switch
c_cond
(paren
id|param.p-&gt;type
)paren
(brace
r_case
id|SCTP_PARAM_IPV4_ADDRESS
suffix:colon
r_case
id|SCTP_PARAM_IPV6_ADDRESS
suffix:colon
r_case
id|SCTP_PARAM_COOKIE_PRESERVATIVE
suffix:colon
r_case
id|SCTP_PARAM_SUPPORTED_ADDRESS_TYPES
suffix:colon
r_case
id|SCTP_PARAM_STATE_COOKIE
suffix:colon
r_case
id|SCTP_PARAM_HEARTBEAT_INFO
suffix:colon
r_case
id|SCTP_PARAM_UNRECOGNIZED_PARAMETERS
suffix:colon
r_case
id|SCTP_PARAM_ECN_CAPABLE
suffix:colon
r_break
suffix:semicolon
r_case
id|SCTP_PARAM_HOST_NAME_ADDRESS
suffix:colon
multiline_comment|/* Tell the peer, we won&squot;t support this param.  */
r_return
id|sctp_process_hn_param
c_func
(paren
id|asoc
comma
id|param
comma
id|chunk
comma
id|err_chunk
)paren
suffix:semicolon
r_default
suffix:colon
id|SCTP_DEBUG_PRINTK
c_func
(paren
l_string|&quot;Unrecognized param: %d for chunk %d.&bslash;n&quot;
comma
id|ntohs
c_func
(paren
id|param.p-&gt;type
)paren
comma
id|cid
)paren
suffix:semicolon
r_return
id|sctp_process_unk_param
c_func
(paren
id|asoc
comma
id|param
comma
id|chunk
comma
id|err_chunk
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* Verify the INIT packet before we process it.  */
DECL|function|sctp_verify_init
r_int
id|sctp_verify_init
c_func
(paren
r_const
r_struct
id|sctp_association
op_star
id|asoc
comma
id|sctp_cid_t
id|cid
comma
id|sctp_init_chunk_t
op_star
id|peer_init
comma
id|sctp_chunk_t
op_star
id|chunk
comma
id|sctp_chunk_t
op_star
op_star
id|errp
)paren
(brace
r_union
id|sctp_params
id|param
suffix:semicolon
r_int
id|has_cookie
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Verify stream values are non-zero. */
r_if
c_cond
(paren
(paren
l_int|0
op_eq
id|peer_init-&gt;init_hdr.num_outbound_streams
)paren
op_logical_or
(paren
l_int|0
op_eq
id|peer_init-&gt;init_hdr.num_inbound_streams
)paren
)paren
(brace
id|sctp_process_inv_mandatory
c_func
(paren
id|asoc
comma
id|chunk
comma
id|errp
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Check for missing mandatory parameters.  */
id|sctp_walk_params
c_func
(paren
id|param
comma
id|peer_init
comma
id|init_hdr.params
)paren
(brace
r_if
c_cond
(paren
id|SCTP_PARAM_STATE_COOKIE
op_eq
id|param.p-&gt;type
)paren
id|has_cookie
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* for (loop through all parameters) */
multiline_comment|/* The only missing mandatory param possible today is&n;&t; * the state cookie for an INIT-ACK chunk.&n;&t; */
r_if
c_cond
(paren
(paren
id|SCTP_CID_INIT_ACK
op_eq
id|cid
)paren
op_logical_and
op_logical_neg
id|has_cookie
)paren
(brace
id|sctp_process_missing_param
c_func
(paren
id|asoc
comma
id|SCTP_PARAM_STATE_COOKIE
comma
id|chunk
comma
id|errp
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Find unrecognized parameters. */
id|sctp_walk_params
c_func
(paren
id|param
comma
id|peer_init
comma
id|init_hdr.params
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|sctp_verify_param
c_func
(paren
id|asoc
comma
id|param
comma
id|cid
comma
id|chunk
comma
id|errp
)paren
)paren
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* for (loop through all parameters) */
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Unpack the parameters in an INIT packet into an association.&n; * Returns 0 on failure, else success.&n; * FIXME:  This is an association method.&n; */
DECL|function|sctp_process_init
r_int
id|sctp_process_init
c_func
(paren
r_struct
id|sctp_association
op_star
id|asoc
comma
id|sctp_cid_t
id|cid
comma
r_const
r_union
id|sctp_addr
op_star
id|peer_addr
comma
id|sctp_init_chunk_t
op_star
id|peer_init
comma
r_int
id|gfp
)paren
(brace
r_union
id|sctp_params
id|param
suffix:semicolon
r_struct
id|sctp_transport
op_star
id|transport
suffix:semicolon
r_struct
id|list_head
op_star
id|pos
comma
op_star
id|temp
suffix:semicolon
r_char
op_star
id|cookie
suffix:semicolon
multiline_comment|/* We must include the address that the INIT packet came from.&n;&t; * This is the only address that matters for an INIT packet.&n;&t; * When processing a COOKIE ECHO, we retrieve the from address&n;&t; * of the INIT from the cookie.&n;&t; */
multiline_comment|/* This implementation defaults to making the first transport&n;&t; * added as the primary transport.  The source address seems to&n;&t; * be a a better choice than any of the embedded addresses.&n;&t; */
r_if
c_cond
(paren
id|peer_addr
)paren
r_if
c_cond
(paren
op_logical_neg
id|sctp_assoc_add_peer
c_func
(paren
id|asoc
comma
id|peer_addr
comma
id|gfp
)paren
)paren
(brace
r_goto
id|nomem
suffix:semicolon
)brace
multiline_comment|/* Process the initialization parameters.  */
id|sctp_walk_params
c_func
(paren
id|param
comma
id|peer_init
comma
id|init_hdr.params
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|sctp_process_param
c_func
(paren
id|asoc
comma
id|param
comma
id|peer_addr
comma
id|gfp
)paren
)paren
r_goto
id|clean_up
suffix:semicolon
)brace
multiline_comment|/* The fixed INIT headers are always in network byte&n;&t; * order.&n;&t; */
id|asoc-&gt;peer.i.init_tag
op_assign
id|ntohl
c_func
(paren
id|peer_init-&gt;init_hdr.init_tag
)paren
suffix:semicolon
id|asoc-&gt;peer.i.a_rwnd
op_assign
id|ntohl
c_func
(paren
id|peer_init-&gt;init_hdr.a_rwnd
)paren
suffix:semicolon
id|asoc-&gt;peer.i.num_outbound_streams
op_assign
id|ntohs
c_func
(paren
id|peer_init-&gt;init_hdr.num_outbound_streams
)paren
suffix:semicolon
id|asoc-&gt;peer.i.num_inbound_streams
op_assign
id|ntohs
c_func
(paren
id|peer_init-&gt;init_hdr.num_inbound_streams
)paren
suffix:semicolon
id|asoc-&gt;peer.i.initial_tsn
op_assign
id|ntohl
c_func
(paren
id|peer_init-&gt;init_hdr.initial_tsn
)paren
suffix:semicolon
multiline_comment|/* Apply the upper bounds for output streams based on peer&squot;s&n;&t; * number of inbound streams.&n;&t; */
r_if
c_cond
(paren
id|asoc-&gt;c.sinit_num_ostreams
OG
id|ntohs
c_func
(paren
id|peer_init-&gt;init_hdr.num_inbound_streams
)paren
)paren
(brace
id|asoc-&gt;c.sinit_num_ostreams
op_assign
id|ntohs
c_func
(paren
id|peer_init-&gt;init_hdr.num_inbound_streams
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|asoc-&gt;c.sinit_max_instreams
OG
id|ntohs
c_func
(paren
id|peer_init-&gt;init_hdr.num_outbound_streams
)paren
)paren
(brace
id|asoc-&gt;c.sinit_max_instreams
op_assign
id|ntohs
c_func
(paren
id|peer_init-&gt;init_hdr.num_outbound_streams
)paren
suffix:semicolon
)brace
multiline_comment|/* Copy Initiation tag from INIT to VT_peer in cookie.   */
id|asoc-&gt;c.peer_vtag
op_assign
id|asoc-&gt;peer.i.init_tag
suffix:semicolon
multiline_comment|/* Peer Rwnd   : Current calculated value of the peer&squot;s rwnd.  */
id|asoc-&gt;peer.rwnd
op_assign
id|asoc-&gt;peer.i.a_rwnd
suffix:semicolon
multiline_comment|/* Copy cookie in case we need to resend COOKIE-ECHO. */
id|cookie
op_assign
id|asoc-&gt;peer.cookie
suffix:semicolon
r_if
c_cond
(paren
id|cookie
)paren
(brace
id|asoc-&gt;peer.cookie
op_assign
id|kmalloc
c_func
(paren
id|asoc-&gt;peer.cookie_len
comma
id|gfp
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|asoc-&gt;peer.cookie
)paren
r_goto
id|clean_up
suffix:semicolon
id|memcpy
c_func
(paren
id|asoc-&gt;peer.cookie
comma
id|cookie
comma
id|asoc-&gt;peer.cookie_len
)paren
suffix:semicolon
)brace
multiline_comment|/* RFC 2960 7.2.1 The initial value of ssthresh MAY be arbitrarily&n;&t; * high (for example, implementations MAY use the size of the receiver&n;&t; * advertised window).&n;&t; */
id|list_for_each
c_func
(paren
id|pos
comma
op_amp
id|asoc-&gt;peer.transport_addr_list
)paren
(brace
id|transport
op_assign
id|list_entry
c_func
(paren
id|pos
comma
r_struct
id|sctp_transport
comma
id|transports
)paren
suffix:semicolon
id|transport-&gt;ssthresh
op_assign
id|asoc-&gt;peer.i.a_rwnd
suffix:semicolon
)brace
multiline_comment|/* Set up the TSN tracking pieces.  */
id|sctp_tsnmap_init
c_func
(paren
op_amp
id|asoc-&gt;peer.tsn_map
comma
id|SCTP_TSN_MAP_SIZE
comma
id|asoc-&gt;peer.i.initial_tsn
)paren
suffix:semicolon
multiline_comment|/* RFC 2960 6.5 Stream Identifier and Stream Sequence Number&n;&t; *&n;&t; * The stream sequence number in all the streams shall start&n;&t; * from 0 when the association is established.  Also, when the&n;&t; * stream sequence number reaches the value 65535 the next&n;&t; * stream sequence number shall be set to 0.&n;&t; */
multiline_comment|/* Allocate storage for the negotiated streams. */
id|asoc-&gt;ssnmap
op_assign
id|sctp_ssnmap_new
c_func
(paren
id|asoc-&gt;peer.i.num_outbound_streams
comma
id|asoc-&gt;c.sinit_num_ostreams
comma
id|gfp
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|asoc-&gt;ssnmap
)paren
r_goto
id|nomem_ssnmap
suffix:semicolon
multiline_comment|/* ADDIP Section 4.1 ASCONF Chunk Procedures&n;&t; *&n;&t; * When an endpoint has an ASCONF signaled change to be sent to the&n;&t; * remote endpoint it should do the following:&n;&t; * ...&n;&t; * A2) A serial number should be assigned to the Chunk. The serial&n;&t; * number should be a monotonically increasing number. All serial&n;&t; * numbers are defined to be initialized at the start of the&n;&t; * association to the same value as the Initial TSN.&n;&t; */
id|asoc-&gt;peer.addip_serial
op_assign
id|asoc-&gt;peer.i.initial_tsn
op_minus
l_int|1
suffix:semicolon
r_return
l_int|1
suffix:semicolon
id|nomem_ssnmap
suffix:colon
id|clean_up
suffix:colon
multiline_comment|/* Release the transport structures. */
id|list_for_each_safe
c_func
(paren
id|pos
comma
id|temp
comma
op_amp
id|asoc-&gt;peer.transport_addr_list
)paren
(brace
id|transport
op_assign
id|list_entry
c_func
(paren
id|pos
comma
r_struct
id|sctp_transport
comma
id|transports
)paren
suffix:semicolon
id|list_del
c_func
(paren
id|pos
)paren
suffix:semicolon
id|sctp_transport_free
c_func
(paren
id|transport
)paren
suffix:semicolon
)brace
id|nomem
suffix:colon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Update asoc with the option described in param.&n; *&n; * RFC2960 3.3.2.1 Optional/Variable Length Parameters in INIT&n; *&n; * asoc is the association to update.&n; * param is the variable length parameter to use for update.&n; * cid tells us if this is an INIT, INIT ACK or COOKIE ECHO.&n; * If the current packet is an INIT we want to minimize the amount of&n; * work we do.  In particular, we should not build transport&n; * structures for the addresses.&n; */
DECL|function|sctp_process_param
r_int
id|sctp_process_param
c_func
(paren
r_struct
id|sctp_association
op_star
id|asoc
comma
r_union
id|sctp_params
id|param
comma
r_const
r_union
id|sctp_addr
op_star
id|peer_addr
comma
r_int
id|gfp
)paren
(brace
r_union
id|sctp_addr
id|addr
suffix:semicolon
r_int
id|i
suffix:semicolon
id|__u16
id|sat
suffix:semicolon
r_int
id|retval
op_assign
l_int|1
suffix:semicolon
id|sctp_scope_t
id|scope
suffix:semicolon
id|time_t
id|stale
suffix:semicolon
multiline_comment|/* We maintain all INIT parameters in network byte order all the&n;&t; * time.  This allows us to not worry about whether the parameters&n;&t; * came from a fresh INIT, and INIT ACK, or were stored in a cookie.&n;&t; */
r_switch
c_cond
(paren
id|param.p-&gt;type
)paren
(brace
r_case
id|SCTP_PARAM_IPV6_ADDRESS
suffix:colon
r_if
c_cond
(paren
id|PF_INET6
op_ne
id|asoc-&gt;base.sk-&gt;family
)paren
(brace
r_break
suffix:semicolon
)brace
multiline_comment|/* Fall through. */
r_case
id|SCTP_PARAM_IPV4_ADDRESS
suffix:colon
id|sctp_param2sockaddr
c_func
(paren
op_amp
id|addr
comma
id|param.addr
comma
id|asoc-&gt;peer.port
comma
l_int|0
)paren
suffix:semicolon
id|scope
op_assign
id|sctp_scope
c_func
(paren
id|peer_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sctp_in_scope
c_func
(paren
op_amp
id|addr
comma
id|scope
)paren
)paren
r_if
c_cond
(paren
op_logical_neg
id|sctp_assoc_add_peer
c_func
(paren
id|asoc
comma
op_amp
id|addr
comma
id|gfp
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SCTP_PARAM_COOKIE_PRESERVATIVE
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|sctp_proto.cookie_preserve_enable
)paren
r_break
suffix:semicolon
id|stale
op_assign
id|ntohl
c_func
(paren
id|param.life-&gt;lifespan_increment
)paren
suffix:semicolon
multiline_comment|/* Suggested Cookie Life span increment&squot;s unit is msec,&n;&t;&t; * (1/1000sec).&n;&t;&t; */
id|asoc-&gt;cookie_life.tv_sec
op_add_assign
id|stale
op_div
l_int|1000
suffix:semicolon
id|asoc-&gt;cookie_life.tv_usec
op_add_assign
(paren
id|stale
op_mod
l_int|1000
)paren
op_star
l_int|1000
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SCTP_PARAM_HOST_NAME_ADDRESS
suffix:colon
id|SCTP_DEBUG_PRINTK
c_func
(paren
l_string|&quot;unimplemented SCTP_HOST_NAME_ADDRESS&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SCTP_PARAM_SUPPORTED_ADDRESS_TYPES
suffix:colon
multiline_comment|/* Turn off the default values first so we&squot;ll know which&n;&t;&t; * ones are really set by the peer.&n;&t;&t; */
id|asoc-&gt;peer.ipv4_address
op_assign
l_int|0
suffix:semicolon
id|asoc-&gt;peer.ipv6_address
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Cycle through address types; avoid divide by 0. */
id|sat
op_assign
id|ntohs
c_func
(paren
id|param.p-&gt;length
)paren
op_minus
r_sizeof
(paren
id|sctp_paramhdr_t
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sat
)paren
id|sat
op_div_assign
r_sizeof
(paren
id|__u16
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|sat
suffix:semicolon
op_increment
id|i
)paren
(brace
r_switch
c_cond
(paren
id|param.sat-&gt;types
(braket
id|i
)braket
)paren
(brace
r_case
id|SCTP_PARAM_IPV4_ADDRESS
suffix:colon
id|asoc-&gt;peer.ipv4_address
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SCTP_PARAM_IPV6_ADDRESS
suffix:colon
id|asoc-&gt;peer.ipv6_address
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SCTP_PARAM_HOST_NAME_ADDRESS
suffix:colon
id|asoc-&gt;peer.hostname_address
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* Just ignore anything else.  */
r_break
suffix:semicolon
)brace
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|SCTP_PARAM_STATE_COOKIE
suffix:colon
id|asoc-&gt;peer.cookie_len
op_assign
id|ntohs
c_func
(paren
id|param.p-&gt;length
)paren
op_minus
r_sizeof
(paren
id|sctp_paramhdr_t
)paren
suffix:semicolon
id|asoc-&gt;peer.cookie
op_assign
id|param.cookie-&gt;body
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SCTP_PARAM_HEARTBEAT_INFO
suffix:colon
multiline_comment|/* Would be odd to receive, but it causes no problems. */
r_break
suffix:semicolon
r_case
id|SCTP_PARAM_UNRECOGNIZED_PARAMETERS
suffix:colon
multiline_comment|/* Rejected during verify stage. */
r_break
suffix:semicolon
r_case
id|SCTP_PARAM_ECN_CAPABLE
suffix:colon
id|asoc-&gt;peer.ecn_capable
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
multiline_comment|/* Any unrecognized parameters should have been caught&n;&t;&t; * and handled by sctp_verify_param() which should be&n;&t;&t; * called prior to this routine.  Simply log the error&n;&t;&t; * here.&n;&t;&t; */
id|SCTP_DEBUG_PRINTK
c_func
(paren
l_string|&quot;Ignoring param: %d for association %p.&bslash;n&quot;
comma
id|ntohs
c_func
(paren
id|param.p-&gt;type
)paren
comma
id|asoc
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* Select a new verification tag.  */
DECL|function|sctp_generate_tag
id|__u32
id|sctp_generate_tag
c_func
(paren
r_const
r_struct
id|sctp_endpoint
op_star
id|ep
)paren
(brace
multiline_comment|/* I believe that this random number generator complies with RFC1750.&n;&t; * A tag of 0 is reserved for special cases (e.g. INIT).&n;&t; */
id|__u32
id|x
suffix:semicolon
r_do
(brace
id|get_random_bytes
c_func
(paren
op_amp
id|x
comma
r_sizeof
(paren
id|__u32
)paren
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|x
op_eq
l_int|0
)paren
suffix:semicolon
r_return
id|x
suffix:semicolon
)brace
multiline_comment|/* Select an initial TSN to send during startup.  */
DECL|function|sctp_generate_tsn
id|__u32
id|sctp_generate_tsn
c_func
(paren
r_const
r_struct
id|sctp_endpoint
op_star
id|ep
)paren
(brace
id|__u32
id|retval
suffix:semicolon
id|get_random_bytes
c_func
(paren
op_amp
id|retval
comma
r_sizeof
(paren
id|__u32
)paren
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/********************************************************************&n; * 4th Level Abstractions&n; ********************************************************************/
multiline_comment|/* Convert from an SCTP IP parameter to a union sctp_addr.  */
DECL|function|sctp_param2sockaddr
r_void
id|sctp_param2sockaddr
c_func
(paren
r_union
id|sctp_addr
op_star
id|addr
comma
id|sctp_addr_param_t
op_star
id|param
comma
id|__u16
id|port
comma
r_int
id|iif
)paren
(brace
r_switch
c_cond
(paren
id|param-&gt;v4.param_hdr.type
)paren
(brace
r_case
id|SCTP_PARAM_IPV4_ADDRESS
suffix:colon
id|addr-&gt;v4.sin_family
op_assign
id|AF_INET
suffix:semicolon
id|addr-&gt;v4.sin_port
op_assign
id|port
suffix:semicolon
id|addr-&gt;v4.sin_addr.s_addr
op_assign
id|param-&gt;v4.addr.s_addr
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SCTP_PARAM_IPV6_ADDRESS
suffix:colon
id|addr-&gt;v6.sin6_family
op_assign
id|AF_INET6
suffix:semicolon
id|addr-&gt;v6.sin6_port
op_assign
id|port
suffix:semicolon
id|addr-&gt;v6.sin6_flowinfo
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* BUG */
id|addr-&gt;v6.sin6_addr
op_assign
id|param-&gt;v6.addr
suffix:semicolon
id|addr-&gt;v6.sin6_scope_id
op_assign
id|iif
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|SCTP_DEBUG_PRINTK
c_func
(paren
l_string|&quot;Illegal address type %d&bslash;n&quot;
comma
id|ntohs
c_func
(paren
id|param-&gt;v4.param_hdr.type
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
suffix:semicolon
)brace
multiline_comment|/* Convert an IP address in an SCTP param into a sockaddr_in.  */
multiline_comment|/* Returns true if a valid conversion was possible.  */
DECL|function|sctp_addr2sockaddr
r_int
id|sctp_addr2sockaddr
c_func
(paren
r_union
id|sctp_params
id|p
comma
r_union
id|sctp_addr
op_star
id|sa
)paren
(brace
r_switch
c_cond
(paren
id|p.p-&gt;type
)paren
(brace
r_case
id|SCTP_PARAM_IPV4_ADDRESS
suffix:colon
id|sa-&gt;v4.sin_addr
op_assign
op_star
(paren
(paren
r_struct
id|in_addr
op_star
)paren
op_amp
id|p.v4-&gt;addr
)paren
suffix:semicolon
id|sa-&gt;v4.sin_family
op_assign
id|AF_INET
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SCTP_PARAM_IPV6_ADDRESS
suffix:colon
op_star
(paren
(paren
r_struct
id|in6_addr
op_star
)paren
op_amp
id|sa-&gt;v4.sin_addr
)paren
op_assign
id|p.v6-&gt;addr
suffix:semicolon
id|sa-&gt;v4.sin_family
op_assign
id|AF_INET6
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
l_int|0
suffix:semicolon
)brace
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Convert a sockaddr_in to an IP address in an SCTP param.&n; * Returns len if a valid conversion was possible.&n; */
DECL|function|sockaddr2sctp_addr
r_int
id|sockaddr2sctp_addr
c_func
(paren
r_const
r_union
id|sctp_addr
op_star
id|sa
comma
id|sctp_addr_param_t
op_star
id|p
)paren
(brace
r_int
id|len
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|sa-&gt;v4.sin_family
)paren
(brace
r_case
id|AF_INET
suffix:colon
id|p-&gt;v4.param_hdr.type
op_assign
id|SCTP_PARAM_IPV4_ADDRESS
suffix:semicolon
id|p-&gt;v4.param_hdr.length
op_assign
id|ntohs
c_func
(paren
r_sizeof
(paren
id|sctp_ipv4addr_param_t
)paren
)paren
suffix:semicolon
id|len
op_assign
r_sizeof
(paren
id|sctp_ipv4addr_param_t
)paren
suffix:semicolon
id|p-&gt;v4.addr.s_addr
op_assign
id|sa-&gt;v4.sin_addr.s_addr
suffix:semicolon
r_break
suffix:semicolon
r_case
id|AF_INET6
suffix:colon
id|p-&gt;v6.param_hdr.type
op_assign
id|SCTP_PARAM_IPV6_ADDRESS
suffix:semicolon
id|p-&gt;v6.param_hdr.length
op_assign
id|ntohs
c_func
(paren
r_sizeof
(paren
id|sctp_ipv6addr_param_t
)paren
)paren
suffix:semicolon
id|len
op_assign
r_sizeof
(paren
id|sctp_ipv6addr_param_t
)paren
suffix:semicolon
id|p-&gt;v6.addr
op_assign
op_star
(paren
op_amp
id|sa-&gt;v6.sin6_addr
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;sockaddr2sctp_addr: Illegal family %d.&bslash;n&quot;
comma
id|sa-&gt;v4.sin_family
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
eof
