multiline_comment|/*&n; *&t;DDP:&t;An implementation of the AppleTalk DDP protocol for&n; *&t;&t;Ethernet &squot;ELAP&squot;.&n; *&n; *&t;&t;Alan Cox  &lt;Alan.Cox@linux.org&gt;&n; *&n; *&t;&t;With more than a little assistance from&n; *&n; *&t;&t;Wesley Craig &lt;netatalk@umich.edu&gt;&n; *&n; *&t;Fixes:&n; *&t;&t;Michael Callahan&t;:&t;Made routing work&n; *&t;&t;Wesley Craig&t;&t;:&t;Fix probing to listen to a&n; *&t;&t;&t;&t;&t;&t;passed node id.&n; *&t;&t;Alan Cox&t;&t;:&t;Added send/recvmsg support&n; *&t;&t;Alan Cox&t;&t;:&t;Moved at. to protinfo in&n; *&t;&t;&t;&t;&t;&t;socket.&n; *&t;&t;Alan Cox&t;&t;:&t;Added firewall hooks.&n; *&t;&t;Alan Cox&t;&t;:&t;Supports new ARPHRD_LOOPBACK&n; *&t;&t;Christer Weinigel&t;: &t;Routing and /proc fixes.&n; *&t;&t;Bradford Johnson&t;:&t;LocalTalk.&n; *&t;&t;Tom Dyas&t;&t;:&t;Module support.&n; *&t;&t;Alan Cox&t;&t;:&t;Hooks for PPP (based on the&n; *&t;&t;&t;&t;&t;&t;LocalTalk hook).&n; *&t;&t;Alan Cox&t;&t;:&t;Posix bits&n; *&t;&t;Alan Cox/Mike Freeman&t;:&t;Possible fix to NBP problems&n; *&t;&t;Bradford Johnson&t;:&t;IP-over-DDP (experimental)&n; *&t;&t;Jay Schulist&t;&t;:&t;Moved IP-over-DDP to its own&n; *&t;&t;&t;&t;&t;&t;driver file. (ipddp.c &amp; ipddp.h)&n; *&t;&t;Jay Schulist&t;&t;:&t;Made work as module with &n; *&t;&t;&t;&t;&t;&t;AppleTalk drivers, cleaned it.&n; *&t;&t;Rob Newberry&t;&t;:&t;Added proxy AARP and AARP&n; *&t;&t;&t;&t;&t;&t;procfs, moved probing to AARP&n; *&t;&t;&t;&t;&t;&t;module.&n; *              Adrian Sun/ &n; *              Michael Zuelsdorff      :       fix for net.0 packets. don&squot;t &n; *                                              allow illegal ether/tokentalk&n; *                                              port assignment. we lose a &n; *                                              valid localtalk port as a &n; *                                              result.&n; *&t;&t;Arnaldo C. de Melo&t;:&t;Cleanup, in preparation for&n; *&t;&t;&t;&t;&t;&t;shared skb support 8)&n; *&t;&t;Arnaldo C. de Melo&t;:&t;Move proc stuff to atalk_proc.c,&n; *&t;&t;&t;&t;&t;&t;use seq_file&n; *&n; *&t;&t;This program is free software; you can redistribute it and/or&n; *&t;&t;modify it under the terms of the GNU General Public License&n; *&t;&t;as published by the Free Software Foundation; either version&n; *&t;&t;2 of the License, or (at your option) any later version.&n; * &n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/tcp.h&gt;
macro_line|#include &lt;linux/if_arp.h&gt;
macro_line|#include &lt;linux/termios.h&gt;&t;/* For TIOCOUTQ/INQ */
macro_line|#include &lt;net/datalink.h&gt;
macro_line|#include &lt;net/psnap.h&gt;
macro_line|#include &lt;net/sock.h&gt;
macro_line|#include &lt;net/route.h&gt;
macro_line|#include &lt;linux/atalk.h&gt;
DECL|variable|ddp_dl
DECL|variable|aarp_dl
r_struct
id|datalink_proto
op_star
id|ddp_dl
comma
op_star
id|aarp_dl
suffix:semicolon
DECL|variable|atalk_dgram_ops
r_static
r_struct
id|proto_ops
id|atalk_dgram_ops
suffix:semicolon
multiline_comment|/**************************************************************************&bslash;&n;*                                                                          *&n;* Handlers for the socket list.                                            *&n;*                                                                          *&n;&bslash;**************************************************************************/
DECL|variable|atalk_sockets
id|HLIST_HEAD
c_func
(paren
id|atalk_sockets
)paren
suffix:semicolon
DECL|variable|atalk_sockets_lock
id|DEFINE_RWLOCK
c_func
(paren
id|atalk_sockets_lock
)paren
suffix:semicolon
DECL|function|__atalk_insert_socket
r_static
r_inline
r_void
id|__atalk_insert_socket
c_func
(paren
r_struct
id|sock
op_star
id|sk
)paren
(brace
id|sk_add_node
c_func
(paren
id|sk
comma
op_amp
id|atalk_sockets
)paren
suffix:semicolon
)brace
DECL|function|atalk_remove_socket
r_static
r_inline
r_void
id|atalk_remove_socket
c_func
(paren
r_struct
id|sock
op_star
id|sk
)paren
(brace
id|write_lock_bh
c_func
(paren
op_amp
id|atalk_sockets_lock
)paren
suffix:semicolon
id|sk_del_node_init
c_func
(paren
id|sk
)paren
suffix:semicolon
id|write_unlock_bh
c_func
(paren
op_amp
id|atalk_sockets_lock
)paren
suffix:semicolon
)brace
DECL|function|atalk_search_socket
r_static
r_struct
id|sock
op_star
id|atalk_search_socket
c_func
(paren
r_struct
id|sockaddr_at
op_star
id|to
comma
r_struct
id|atalk_iface
op_star
id|atif
)paren
(brace
r_struct
id|sock
op_star
id|s
suffix:semicolon
r_struct
id|hlist_node
op_star
id|node
suffix:semicolon
id|read_lock_bh
c_func
(paren
op_amp
id|atalk_sockets_lock
)paren
suffix:semicolon
id|sk_for_each
c_func
(paren
id|s
comma
id|node
comma
op_amp
id|atalk_sockets
)paren
(brace
r_struct
id|atalk_sock
op_star
id|at
op_assign
id|at_sk
c_func
(paren
id|s
)paren
suffix:semicolon
r_if
c_cond
(paren
id|to-&gt;sat_port
op_ne
id|at-&gt;src_port
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|to-&gt;sat_addr.s_net
op_eq
id|ATADDR_ANYNET
op_logical_and
id|to-&gt;sat_addr.s_node
op_eq
id|ATADDR_BCAST
op_logical_and
id|at-&gt;src_net
op_eq
id|atif-&gt;address.s_net
)paren
r_goto
id|found
suffix:semicolon
r_if
c_cond
(paren
id|to-&gt;sat_addr.s_net
op_eq
id|at-&gt;src_net
op_logical_and
(paren
id|to-&gt;sat_addr.s_node
op_eq
id|at-&gt;src_node
op_logical_or
id|to-&gt;sat_addr.s_node
op_eq
id|ATADDR_BCAST
op_logical_or
id|to-&gt;sat_addr.s_node
op_eq
id|ATADDR_ANYNODE
)paren
)paren
r_goto
id|found
suffix:semicolon
multiline_comment|/* XXXX.0 -- we got a request for this router. make sure&n;&t;&t; * that the node is appropriately set. */
r_if
c_cond
(paren
id|to-&gt;sat_addr.s_node
op_eq
id|ATADDR_ANYNODE
op_logical_and
id|to-&gt;sat_addr.s_net
op_ne
id|ATADDR_ANYNET
op_logical_and
id|atif-&gt;address.s_node
op_eq
id|at-&gt;src_node
)paren
(brace
id|to-&gt;sat_addr.s_node
op_assign
id|atif-&gt;address.s_node
suffix:semicolon
r_goto
id|found
suffix:semicolon
)brace
)brace
id|s
op_assign
l_int|NULL
suffix:semicolon
id|found
suffix:colon
id|read_unlock_bh
c_func
(paren
op_amp
id|atalk_sockets_lock
)paren
suffix:semicolon
r_return
id|s
suffix:semicolon
)brace
multiline_comment|/**&n; * atalk_find_or_insert_socket - Try to find a socket matching ADDR&n; * @sk - socket to insert in the list if it is not there already&n; * @sat - address to search for&n; *&n; * Try to find a socket matching ADDR in the socket list, if found then return&n; * it. If not, insert SK into the socket list.&n; *&n; * This entire operation must execute atomically.&n; */
DECL|function|atalk_find_or_insert_socket
r_static
r_struct
id|sock
op_star
id|atalk_find_or_insert_socket
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_struct
id|sockaddr_at
op_star
id|sat
)paren
(brace
r_struct
id|sock
op_star
id|s
suffix:semicolon
r_struct
id|hlist_node
op_star
id|node
suffix:semicolon
r_struct
id|atalk_sock
op_star
id|at
suffix:semicolon
id|write_lock_bh
c_func
(paren
op_amp
id|atalk_sockets_lock
)paren
suffix:semicolon
id|sk_for_each
c_func
(paren
id|s
comma
id|node
comma
op_amp
id|atalk_sockets
)paren
(brace
id|at
op_assign
id|at_sk
c_func
(paren
id|s
)paren
suffix:semicolon
r_if
c_cond
(paren
id|at-&gt;src_net
op_eq
id|sat-&gt;sat_addr.s_net
op_logical_and
id|at-&gt;src_node
op_eq
id|sat-&gt;sat_addr.s_node
op_logical_and
id|at-&gt;src_port
op_eq
id|sat-&gt;sat_port
)paren
r_goto
id|found
suffix:semicolon
)brace
id|s
op_assign
l_int|NULL
suffix:semicolon
id|__atalk_insert_socket
c_func
(paren
id|sk
)paren
suffix:semicolon
multiline_comment|/* Wheee, it&squot;s free, assign and insert. */
id|found
suffix:colon
id|write_unlock_bh
c_func
(paren
op_amp
id|atalk_sockets_lock
)paren
suffix:semicolon
r_return
id|s
suffix:semicolon
)brace
DECL|function|atalk_destroy_timer
r_static
r_void
id|atalk_destroy_timer
c_func
(paren
r_int
r_int
id|data
)paren
(brace
r_struct
id|sock
op_star
id|sk
op_assign
(paren
r_struct
id|sock
op_star
)paren
id|data
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|sk-&gt;sk_wmem_alloc
)paren
op_logical_or
id|atomic_read
c_func
(paren
op_amp
id|sk-&gt;sk_rmem_alloc
)paren
)paren
(brace
id|sk-&gt;sk_timer.expires
op_assign
id|jiffies
op_plus
id|SOCK_DESTROY_TIME
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|sk-&gt;sk_timer
)paren
suffix:semicolon
)brace
r_else
id|sock_put
c_func
(paren
id|sk
)paren
suffix:semicolon
)brace
DECL|function|atalk_destroy_socket
r_static
r_inline
r_void
id|atalk_destroy_socket
c_func
(paren
r_struct
id|sock
op_star
id|sk
)paren
(brace
id|atalk_remove_socket
c_func
(paren
id|sk
)paren
suffix:semicolon
id|skb_queue_purge
c_func
(paren
op_amp
id|sk-&gt;sk_receive_queue
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|sk-&gt;sk_wmem_alloc
)paren
op_logical_or
id|atomic_read
c_func
(paren
op_amp
id|sk-&gt;sk_rmem_alloc
)paren
)paren
(brace
id|init_timer
c_func
(paren
op_amp
id|sk-&gt;sk_timer
)paren
suffix:semicolon
id|sk-&gt;sk_timer.expires
op_assign
id|jiffies
op_plus
id|SOCK_DESTROY_TIME
suffix:semicolon
id|sk-&gt;sk_timer.function
op_assign
id|atalk_destroy_timer
suffix:semicolon
id|sk-&gt;sk_timer.data
op_assign
(paren
r_int
r_int
)paren
id|sk
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|sk-&gt;sk_timer
)paren
suffix:semicolon
)brace
r_else
id|sock_put
c_func
(paren
id|sk
)paren
suffix:semicolon
)brace
multiline_comment|/**************************************************************************&bslash;&n;*                                                                          *&n;* Routing tables for the AppleTalk socket layer.                           *&n;*                                                                          *&n;&bslash;**************************************************************************/
multiline_comment|/* Anti-deadlock ordering is atalk_routes_lock --&gt; iface_lock -DaveM */
DECL|variable|atalk_routes
r_struct
id|atalk_route
op_star
id|atalk_routes
suffix:semicolon
DECL|variable|atalk_routes_lock
id|DEFINE_RWLOCK
c_func
(paren
id|atalk_routes_lock
)paren
suffix:semicolon
DECL|variable|atalk_interfaces
r_struct
id|atalk_iface
op_star
id|atalk_interfaces
suffix:semicolon
DECL|variable|atalk_interfaces_lock
id|DEFINE_RWLOCK
c_func
(paren
id|atalk_interfaces_lock
)paren
suffix:semicolon
multiline_comment|/* For probing devices or in a routerless network */
DECL|variable|atrtr_default
r_struct
id|atalk_route
id|atrtr_default
suffix:semicolon
multiline_comment|/* AppleTalk interface control */
multiline_comment|/*&n; * Drop a device. Doesn&squot;t drop any of its routes - that is the caller&squot;s&n; * problem. Called when we down the interface or delete the address.&n; */
DECL|function|atif_drop_device
r_static
r_void
id|atif_drop_device
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|atalk_iface
op_star
op_star
id|iface
op_assign
op_amp
id|atalk_interfaces
suffix:semicolon
r_struct
id|atalk_iface
op_star
id|tmp
suffix:semicolon
id|write_lock_bh
c_func
(paren
op_amp
id|atalk_interfaces_lock
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|tmp
op_assign
op_star
id|iface
)paren
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|tmp-&gt;dev
op_eq
id|dev
)paren
(brace
op_star
id|iface
op_assign
id|tmp-&gt;next
suffix:semicolon
id|dev_put
c_func
(paren
id|dev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|tmp
)paren
suffix:semicolon
id|dev-&gt;atalk_ptr
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
id|iface
op_assign
op_amp
id|tmp-&gt;next
suffix:semicolon
)brace
id|write_unlock_bh
c_func
(paren
op_amp
id|atalk_interfaces_lock
)paren
suffix:semicolon
)brace
DECL|function|atif_add_device
r_static
r_struct
id|atalk_iface
op_star
id|atif_add_device
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|atalk_addr
op_star
id|sa
)paren
(brace
r_struct
id|atalk_iface
op_star
id|iface
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|iface
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|iface
)paren
r_goto
id|out
suffix:semicolon
id|memset
c_func
(paren
id|iface
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|iface
)paren
)paren
suffix:semicolon
id|dev_hold
c_func
(paren
id|dev
)paren
suffix:semicolon
id|iface-&gt;dev
op_assign
id|dev
suffix:semicolon
id|dev-&gt;atalk_ptr
op_assign
id|iface
suffix:semicolon
id|iface-&gt;address
op_assign
op_star
id|sa
suffix:semicolon
id|iface-&gt;status
op_assign
l_int|0
suffix:semicolon
id|write_lock_bh
c_func
(paren
op_amp
id|atalk_interfaces_lock
)paren
suffix:semicolon
id|iface-&gt;next
op_assign
id|atalk_interfaces
suffix:semicolon
id|atalk_interfaces
op_assign
id|iface
suffix:semicolon
id|write_unlock_bh
c_func
(paren
op_amp
id|atalk_interfaces_lock
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|iface
suffix:semicolon
)brace
multiline_comment|/* Perform phase 2 AARP probing on our tentative address */
DECL|function|atif_probe_device
r_static
r_int
id|atif_probe_device
c_func
(paren
r_struct
id|atalk_iface
op_star
id|atif
)paren
(brace
r_int
id|netrange
op_assign
id|ntohs
c_func
(paren
id|atif-&gt;nets.nr_lastnet
)paren
op_minus
id|ntohs
c_func
(paren
id|atif-&gt;nets.nr_firstnet
)paren
op_plus
l_int|1
suffix:semicolon
r_int
id|probe_net
op_assign
id|ntohs
c_func
(paren
id|atif-&gt;address.s_net
)paren
suffix:semicolon
r_int
id|probe_node
op_assign
id|atif-&gt;address.s_node
suffix:semicolon
r_int
id|netct
comma
id|nodect
suffix:semicolon
multiline_comment|/* Offset the network we start probing with */
r_if
c_cond
(paren
id|probe_net
op_eq
id|ATADDR_ANYNET
)paren
(brace
id|probe_net
op_assign
id|ntohs
c_func
(paren
id|atif-&gt;nets.nr_firstnet
)paren
suffix:semicolon
r_if
c_cond
(paren
id|netrange
)paren
id|probe_net
op_add_assign
id|jiffies
op_mod
id|netrange
suffix:semicolon
)brace
r_if
c_cond
(paren
id|probe_node
op_eq
id|ATADDR_ANYNODE
)paren
id|probe_node
op_assign
id|jiffies
op_amp
l_int|0xFF
suffix:semicolon
multiline_comment|/* Scan the networks */
id|atif-&gt;status
op_or_assign
id|ATIF_PROBE
suffix:semicolon
r_for
c_loop
(paren
id|netct
op_assign
l_int|0
suffix:semicolon
id|netct
op_le
id|netrange
suffix:semicolon
id|netct
op_increment
)paren
(brace
multiline_comment|/* Sweep the available nodes from a given start */
id|atif-&gt;address.s_net
op_assign
id|htons
c_func
(paren
id|probe_net
)paren
suffix:semicolon
r_for
c_loop
(paren
id|nodect
op_assign
l_int|0
suffix:semicolon
id|nodect
OL
l_int|256
suffix:semicolon
id|nodect
op_increment
)paren
(brace
id|atif-&gt;address.s_node
op_assign
(paren
id|nodect
op_plus
id|probe_node
)paren
op_amp
l_int|0xFF
suffix:semicolon
r_if
c_cond
(paren
id|atif-&gt;address.s_node
OG
l_int|0
op_logical_and
id|atif-&gt;address.s_node
OL
l_int|254
)paren
(brace
multiline_comment|/* Probe a proposed address */
id|aarp_probe_network
c_func
(paren
id|atif
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|atif-&gt;status
op_amp
id|ATIF_PROBE_FAIL
)paren
)paren
(brace
id|atif-&gt;status
op_and_assign
op_complement
id|ATIF_PROBE
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
id|atif-&gt;status
op_and_assign
op_complement
id|ATIF_PROBE_FAIL
suffix:semicolon
)brace
id|probe_net
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|probe_net
OG
id|ntohs
c_func
(paren
id|atif-&gt;nets.nr_lastnet
)paren
)paren
id|probe_net
op_assign
id|ntohs
c_func
(paren
id|atif-&gt;nets.nr_firstnet
)paren
suffix:semicolon
)brace
id|atif-&gt;status
op_and_assign
op_complement
id|ATIF_PROBE
suffix:semicolon
r_return
op_minus
id|EADDRINUSE
suffix:semicolon
multiline_comment|/* Network is full... */
)brace
multiline_comment|/* Perform AARP probing for a proxy address */
DECL|function|atif_proxy_probe_device
r_static
r_int
id|atif_proxy_probe_device
c_func
(paren
r_struct
id|atalk_iface
op_star
id|atif
comma
r_struct
id|atalk_addr
op_star
id|proxy_addr
)paren
(brace
r_int
id|netrange
op_assign
id|ntohs
c_func
(paren
id|atif-&gt;nets.nr_lastnet
)paren
op_minus
id|ntohs
c_func
(paren
id|atif-&gt;nets.nr_firstnet
)paren
op_plus
l_int|1
suffix:semicolon
multiline_comment|/* we probe the interface&squot;s network */
r_int
id|probe_net
op_assign
id|ntohs
c_func
(paren
id|atif-&gt;address.s_net
)paren
suffix:semicolon
r_int
id|probe_node
op_assign
id|ATADDR_ANYNODE
suffix:semicolon
multiline_comment|/* we&squot;ll take anything */
r_int
id|netct
comma
id|nodect
suffix:semicolon
multiline_comment|/* Offset the network we start probing with */
r_if
c_cond
(paren
id|probe_net
op_eq
id|ATADDR_ANYNET
)paren
(brace
id|probe_net
op_assign
id|ntohs
c_func
(paren
id|atif-&gt;nets.nr_firstnet
)paren
suffix:semicolon
r_if
c_cond
(paren
id|netrange
)paren
id|probe_net
op_add_assign
id|jiffies
op_mod
id|netrange
suffix:semicolon
)brace
r_if
c_cond
(paren
id|probe_node
op_eq
id|ATADDR_ANYNODE
)paren
id|probe_node
op_assign
id|jiffies
op_amp
l_int|0xFF
suffix:semicolon
multiline_comment|/* Scan the networks */
r_for
c_loop
(paren
id|netct
op_assign
l_int|0
suffix:semicolon
id|netct
op_le
id|netrange
suffix:semicolon
id|netct
op_increment
)paren
(brace
multiline_comment|/* Sweep the available nodes from a given start */
id|proxy_addr-&gt;s_net
op_assign
id|htons
c_func
(paren
id|probe_net
)paren
suffix:semicolon
r_for
c_loop
(paren
id|nodect
op_assign
l_int|0
suffix:semicolon
id|nodect
OL
l_int|256
suffix:semicolon
id|nodect
op_increment
)paren
(brace
id|proxy_addr-&gt;s_node
op_assign
(paren
id|nodect
op_plus
id|probe_node
)paren
op_amp
l_int|0xFF
suffix:semicolon
r_if
c_cond
(paren
id|proxy_addr-&gt;s_node
OG
l_int|0
op_logical_and
id|proxy_addr-&gt;s_node
OL
l_int|254
)paren
(brace
multiline_comment|/* Tell AARP to probe a proposed address */
r_int
id|ret
op_assign
id|aarp_proxy_probe_network
c_func
(paren
id|atif
comma
id|proxy_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ne
op_minus
id|EADDRINUSE
)paren
r_return
id|ret
suffix:semicolon
)brace
)brace
id|probe_net
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|probe_net
OG
id|ntohs
c_func
(paren
id|atif-&gt;nets.nr_lastnet
)paren
)paren
id|probe_net
op_assign
id|ntohs
c_func
(paren
id|atif-&gt;nets.nr_firstnet
)paren
suffix:semicolon
)brace
r_return
op_minus
id|EADDRINUSE
suffix:semicolon
multiline_comment|/* Network is full... */
)brace
DECL|function|atalk_find_dev_addr
r_struct
id|atalk_addr
op_star
id|atalk_find_dev_addr
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|atalk_iface
op_star
id|iface
op_assign
id|dev-&gt;atalk_ptr
suffix:semicolon
r_return
id|iface
ques
c_cond
op_amp
id|iface-&gt;address
suffix:colon
l_int|NULL
suffix:semicolon
)brace
DECL|function|atalk_find_primary
r_static
r_struct
id|atalk_addr
op_star
id|atalk_find_primary
c_func
(paren
r_void
)paren
(brace
r_struct
id|atalk_iface
op_star
id|fiface
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|atalk_addr
op_star
id|retval
suffix:semicolon
r_struct
id|atalk_iface
op_star
id|iface
suffix:semicolon
multiline_comment|/*&n;&t; * Return a point-to-point interface only if&n;&t; * there is no non-ptp interface available.&n;&t; */
id|read_lock_bh
c_func
(paren
op_amp
id|atalk_interfaces_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|iface
op_assign
id|atalk_interfaces
suffix:semicolon
id|iface
suffix:semicolon
id|iface
op_assign
id|iface-&gt;next
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|fiface
op_logical_and
op_logical_neg
(paren
id|iface-&gt;dev-&gt;flags
op_amp
id|IFF_LOOPBACK
)paren
)paren
id|fiface
op_assign
id|iface
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|iface-&gt;dev-&gt;flags
op_amp
(paren
id|IFF_LOOPBACK
op_or
id|IFF_POINTOPOINT
)paren
)paren
)paren
(brace
id|retval
op_assign
op_amp
id|iface-&gt;address
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|fiface
)paren
id|retval
op_assign
op_amp
id|fiface-&gt;address
suffix:semicolon
r_else
r_if
c_cond
(paren
id|atalk_interfaces
)paren
id|retval
op_assign
op_amp
id|atalk_interfaces-&gt;address
suffix:semicolon
r_else
id|retval
op_assign
l_int|NULL
suffix:semicolon
id|out
suffix:colon
id|read_unlock_bh
c_func
(paren
op_amp
id|atalk_interfaces_lock
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * Find a match for &squot;any network&squot; - ie any of our interfaces with that&n; * node number will do just nicely.&n; */
DECL|function|atalk_find_anynet
r_static
r_struct
id|atalk_iface
op_star
id|atalk_find_anynet
c_func
(paren
r_int
id|node
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|atalk_iface
op_star
id|iface
op_assign
id|dev-&gt;atalk_ptr
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|iface
op_logical_or
id|iface-&gt;status
op_amp
id|ATIF_PROBE
)paren
r_goto
id|out_err
suffix:semicolon
r_if
c_cond
(paren
id|node
op_ne
id|ATADDR_BCAST
op_logical_and
id|iface-&gt;address.s_node
op_ne
id|node
op_logical_and
id|node
op_ne
id|ATADDR_ANYNODE
)paren
r_goto
id|out_err
suffix:semicolon
id|out
suffix:colon
r_return
id|iface
suffix:semicolon
id|out_err
suffix:colon
id|iface
op_assign
l_int|NULL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* Find a match for a specific network:node pair */
DECL|function|atalk_find_interface
r_static
r_struct
id|atalk_iface
op_star
id|atalk_find_interface
c_func
(paren
r_int
id|net
comma
r_int
id|node
)paren
(brace
r_struct
id|atalk_iface
op_star
id|iface
suffix:semicolon
id|read_lock_bh
c_func
(paren
op_amp
id|atalk_interfaces_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|iface
op_assign
id|atalk_interfaces
suffix:semicolon
id|iface
suffix:semicolon
id|iface
op_assign
id|iface-&gt;next
)paren
(brace
r_if
c_cond
(paren
(paren
id|node
op_eq
id|ATADDR_BCAST
op_logical_or
id|node
op_eq
id|ATADDR_ANYNODE
op_logical_or
id|iface-&gt;address.s_node
op_eq
id|node
)paren
op_logical_and
id|iface-&gt;address.s_net
op_eq
id|net
op_logical_and
op_logical_neg
(paren
id|iface-&gt;status
op_amp
id|ATIF_PROBE
)paren
)paren
r_break
suffix:semicolon
multiline_comment|/* XXXX.0 -- net.0 returns the iface associated with net */
r_if
c_cond
(paren
id|node
op_eq
id|ATADDR_ANYNODE
op_logical_and
id|net
op_ne
id|ATADDR_ANYNET
op_logical_and
id|ntohs
c_func
(paren
id|iface-&gt;nets.nr_firstnet
)paren
op_le
id|ntohs
c_func
(paren
id|net
)paren
op_logical_and
id|ntohs
c_func
(paren
id|net
)paren
op_le
id|ntohs
c_func
(paren
id|iface-&gt;nets.nr_lastnet
)paren
)paren
r_break
suffix:semicolon
)brace
id|read_unlock_bh
c_func
(paren
op_amp
id|atalk_interfaces_lock
)paren
suffix:semicolon
r_return
id|iface
suffix:semicolon
)brace
multiline_comment|/*&n; * Find a route for an AppleTalk packet. This ought to get cached in&n; * the socket (later on...). We know about host routes and the fact&n; * that a route must be direct to broadcast.&n; */
DECL|function|atrtr_find
r_static
r_struct
id|atalk_route
op_star
id|atrtr_find
c_func
(paren
r_struct
id|atalk_addr
op_star
id|target
)paren
(brace
multiline_comment|/*&n;&t; * we must search through all routes unless we find a &n;&t; * host route, because some host routes might overlap&n;&t; * network routes&n;&t; */
r_struct
id|atalk_route
op_star
id|net_route
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|atalk_route
op_star
id|r
suffix:semicolon
id|read_lock_bh
c_func
(paren
op_amp
id|atalk_routes_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|r
op_assign
id|atalk_routes
suffix:semicolon
id|r
suffix:semicolon
id|r
op_assign
id|r-&gt;next
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|r-&gt;flags
op_amp
id|RTF_UP
)paren
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|r-&gt;target.s_net
op_eq
id|target-&gt;s_net
)paren
(brace
r_if
c_cond
(paren
id|r-&gt;flags
op_amp
id|RTF_HOST
)paren
(brace
multiline_comment|/*&n;&t;&t;&t;&t; * if this host route is for the target,&n;&t;&t;&t;&t; * the we&squot;re done&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
id|r-&gt;target.s_node
op_eq
id|target-&gt;s_node
)paren
r_goto
id|out
suffix:semicolon
)brace
r_else
multiline_comment|/*&n;&t;&t;&t;&t; * this route will work if there isn&squot;t a&n;&t;&t;&t;&t; * direct host route, so cache it&n;&t;&t;&t;&t; */
id|net_route
op_assign
id|r
suffix:semicolon
)brace
)brace
multiline_comment|/* &n;&t; * if we found a network route but not a direct host&n;&t; * route, then return it&n;&t; */
r_if
c_cond
(paren
id|net_route
)paren
id|r
op_assign
id|net_route
suffix:semicolon
r_else
r_if
c_cond
(paren
id|atrtr_default.dev
)paren
id|r
op_assign
op_amp
id|atrtr_default
suffix:semicolon
r_else
multiline_comment|/* No route can be found */
id|r
op_assign
l_int|NULL
suffix:semicolon
id|out
suffix:colon
id|read_unlock_bh
c_func
(paren
op_amp
id|atalk_routes_lock
)paren
suffix:semicolon
r_return
id|r
suffix:semicolon
)brace
multiline_comment|/*&n; * Given an AppleTalk network, find the device to use. This can be&n; * a simple lookup.&n; */
DECL|function|atrtr_get_dev
r_struct
id|net_device
op_star
id|atrtr_get_dev
c_func
(paren
r_struct
id|atalk_addr
op_star
id|sa
)paren
(brace
r_struct
id|atalk_route
op_star
id|atr
op_assign
id|atrtr_find
c_func
(paren
id|sa
)paren
suffix:semicolon
r_return
id|atr
ques
c_cond
id|atr-&gt;dev
suffix:colon
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* Set up a default router */
DECL|function|atrtr_set_default
r_static
r_void
id|atrtr_set_default
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|atrtr_default.dev
op_assign
id|dev
suffix:semicolon
id|atrtr_default.flags
op_assign
id|RTF_UP
suffix:semicolon
id|atrtr_default.gateway.s_net
op_assign
id|htons
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|atrtr_default.gateway.s_node
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Add a router. Basically make sure it looks valid and stuff the&n; * entry in the list. While it uses netranges we always set them to one&n; * entry to work like netatalk.&n; */
DECL|function|atrtr_create
r_static
r_int
id|atrtr_create
c_func
(paren
r_struct
id|rtentry
op_star
id|r
comma
r_struct
id|net_device
op_star
id|devhint
)paren
(brace
r_struct
id|sockaddr_at
op_star
id|ta
op_assign
(paren
r_struct
id|sockaddr_at
op_star
)paren
op_amp
id|r-&gt;rt_dst
suffix:semicolon
r_struct
id|sockaddr_at
op_star
id|ga
op_assign
(paren
r_struct
id|sockaddr_at
op_star
)paren
op_amp
id|r-&gt;rt_gateway
suffix:semicolon
r_struct
id|atalk_route
op_star
id|rt
suffix:semicolon
r_struct
id|atalk_iface
op_star
id|iface
comma
op_star
id|riface
suffix:semicolon
r_int
id|retval
op_assign
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/*&n;&t; * Fixme: Raise/Lower a routing change semaphore for these&n;&t; * operations.&n;&t; */
multiline_comment|/* Validate the request */
r_if
c_cond
(paren
id|ta-&gt;sat_family
op_ne
id|AF_APPLETALK
op_logical_or
(paren
op_logical_neg
id|devhint
op_logical_and
id|ga-&gt;sat_family
op_ne
id|AF_APPLETALK
)paren
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* Now walk the routing table and make our decisions */
id|write_lock_bh
c_func
(paren
op_amp
id|atalk_routes_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|rt
op_assign
id|atalk_routes
suffix:semicolon
id|rt
suffix:semicolon
id|rt
op_assign
id|rt-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|r-&gt;rt_flags
op_ne
id|rt-&gt;flags
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|ta-&gt;sat_addr.s_net
op_eq
id|rt-&gt;target.s_net
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|rt-&gt;flags
op_amp
id|RTF_HOST
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|ta-&gt;sat_addr.s_node
op_eq
id|rt-&gt;target.s_node
)paren
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|devhint
)paren
(brace
id|riface
op_assign
l_int|NULL
suffix:semicolon
id|read_lock_bh
c_func
(paren
op_amp
id|atalk_interfaces_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|iface
op_assign
id|atalk_interfaces
suffix:semicolon
id|iface
suffix:semicolon
id|iface
op_assign
id|iface-&gt;next
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|riface
op_logical_and
id|ntohs
c_func
(paren
id|ga-&gt;sat_addr.s_net
)paren
op_ge
id|ntohs
c_func
(paren
id|iface-&gt;nets.nr_firstnet
)paren
op_logical_and
id|ntohs
c_func
(paren
id|ga-&gt;sat_addr.s_net
)paren
op_le
id|ntohs
c_func
(paren
id|iface-&gt;nets.nr_lastnet
)paren
)paren
id|riface
op_assign
id|iface
suffix:semicolon
r_if
c_cond
(paren
id|ga-&gt;sat_addr.s_net
op_eq
id|iface-&gt;address.s_net
op_logical_and
id|ga-&gt;sat_addr.s_node
op_eq
id|iface-&gt;address.s_node
)paren
id|riface
op_assign
id|iface
suffix:semicolon
)brace
id|read_unlock_bh
c_func
(paren
op_amp
id|atalk_interfaces_lock
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|ENETUNREACH
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|riface
)paren
r_goto
id|out_unlock
suffix:semicolon
id|devhint
op_assign
id|riface-&gt;dev
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|rt
)paren
(brace
id|rt
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|rt
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
id|retval
op_assign
op_minus
id|ENOBUFS
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rt
)paren
r_goto
id|out_unlock
suffix:semicolon
id|memset
c_func
(paren
id|rt
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|rt
)paren
)paren
suffix:semicolon
id|rt-&gt;next
op_assign
id|atalk_routes
suffix:semicolon
id|atalk_routes
op_assign
id|rt
suffix:semicolon
)brace
multiline_comment|/* Fill in the routing entry */
id|rt-&gt;target
op_assign
id|ta-&gt;sat_addr
suffix:semicolon
id|rt-&gt;dev
op_assign
id|devhint
suffix:semicolon
id|rt-&gt;flags
op_assign
id|r-&gt;rt_flags
suffix:semicolon
id|rt-&gt;gateway
op_assign
id|ga-&gt;sat_addr
suffix:semicolon
id|retval
op_assign
l_int|0
suffix:semicolon
id|out_unlock
suffix:colon
id|write_unlock_bh
c_func
(paren
op_amp
id|atalk_routes_lock
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/* Delete a route. Find it and discard it */
DECL|function|atrtr_delete
r_static
r_int
id|atrtr_delete
c_func
(paren
r_struct
id|atalk_addr
op_star
id|addr
)paren
(brace
r_struct
id|atalk_route
op_star
op_star
id|r
op_assign
op_amp
id|atalk_routes
suffix:semicolon
r_int
id|retval
op_assign
l_int|0
suffix:semicolon
r_struct
id|atalk_route
op_star
id|tmp
suffix:semicolon
id|write_lock_bh
c_func
(paren
op_amp
id|atalk_routes_lock
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|tmp
op_assign
op_star
id|r
)paren
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|tmp-&gt;target.s_net
op_eq
id|addr-&gt;s_net
op_logical_and
(paren
op_logical_neg
(paren
id|tmp-&gt;flags
op_amp
id|RTF_GATEWAY
)paren
op_logical_or
id|tmp-&gt;target.s_node
op_eq
id|addr-&gt;s_node
)paren
)paren
(brace
op_star
id|r
op_assign
id|tmp-&gt;next
suffix:semicolon
id|dev_put
c_func
(paren
id|tmp-&gt;dev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|tmp
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|r
op_assign
op_amp
id|tmp-&gt;next
suffix:semicolon
)brace
id|retval
op_assign
op_minus
id|ENOENT
suffix:semicolon
id|out
suffix:colon
id|write_unlock_bh
c_func
(paren
op_amp
id|atalk_routes_lock
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * Called when a device is downed. Just throw away any routes&n; * via it.&n; */
DECL|function|atrtr_device_down
r_static
r_void
id|atrtr_device_down
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|atalk_route
op_star
op_star
id|r
op_assign
op_amp
id|atalk_routes
suffix:semicolon
r_struct
id|atalk_route
op_star
id|tmp
suffix:semicolon
id|write_lock_bh
c_func
(paren
op_amp
id|atalk_routes_lock
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|tmp
op_assign
op_star
id|r
)paren
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|tmp-&gt;dev
op_eq
id|dev
)paren
(brace
op_star
id|r
op_assign
id|tmp-&gt;next
suffix:semicolon
id|dev_put
c_func
(paren
id|dev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|tmp
)paren
suffix:semicolon
)brace
r_else
id|r
op_assign
op_amp
id|tmp-&gt;next
suffix:semicolon
)brace
id|write_unlock_bh
c_func
(paren
op_amp
id|atalk_routes_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atrtr_default.dev
op_eq
id|dev
)paren
id|atrtr_set_default
c_func
(paren
l_int|NULL
)paren
suffix:semicolon
)brace
multiline_comment|/* Actually down the interface */
DECL|function|atalk_dev_down
r_static
r_inline
r_void
id|atalk_dev_down
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|atrtr_device_down
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Remove all routes for the device */
id|aarp_device_down
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Remove AARP entries for the device */
id|atif_drop_device
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Remove the device */
)brace
multiline_comment|/*&n; * A device event has occurred. Watch for devices going down and&n; * delete our use of them (iface and route).&n; */
DECL|function|ddp_device_event
r_static
r_int
id|ddp_device_event
c_func
(paren
r_struct
id|notifier_block
op_star
id|this
comma
r_int
r_int
id|event
comma
r_void
op_star
id|ptr
)paren
(brace
r_if
c_cond
(paren
id|event
op_eq
id|NETDEV_DOWN
)paren
multiline_comment|/* Discard any use of this */
id|atalk_dev_down
c_func
(paren
id|ptr
)paren
suffix:semicolon
r_return
id|NOTIFY_DONE
suffix:semicolon
)brace
multiline_comment|/* ioctl calls. Shouldn&squot;t even need touching */
multiline_comment|/* Device configuration ioctl calls */
DECL|function|atif_ioctl
r_static
r_int
id|atif_ioctl
c_func
(paren
r_int
id|cmd
comma
r_void
id|__user
op_star
id|arg
)paren
(brace
r_static
r_char
id|aarp_mcast
(braket
l_int|6
)braket
op_assign
(brace
l_int|0x09
comma
l_int|0x00
comma
l_int|0x00
comma
l_int|0xFF
comma
l_int|0xFF
comma
l_int|0xFF
)brace
suffix:semicolon
r_struct
id|ifreq
id|atreq
suffix:semicolon
r_struct
id|atalk_netrange
op_star
id|nr
suffix:semicolon
r_struct
id|sockaddr_at
op_star
id|sa
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_struct
id|atalk_iface
op_star
id|atif
suffix:semicolon
r_int
id|ct
suffix:semicolon
r_int
id|limit
suffix:semicolon
r_struct
id|rtentry
id|rtdef
suffix:semicolon
r_int
id|add_route
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|atreq
comma
id|arg
comma
r_sizeof
(paren
id|atreq
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|dev
op_assign
id|__dev_get_by_name
c_func
(paren
id|atreq.ifr_name
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|sa
op_assign
(paren
r_struct
id|sockaddr_at
op_star
)paren
op_amp
id|atreq.ifr_addr
suffix:semicolon
id|atif
op_assign
id|atalk_find_dev
c_func
(paren
id|dev
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SIOCSIFADDR
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
r_if
c_cond
(paren
id|sa-&gt;sat_family
op_ne
id|AF_APPLETALK
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;type
op_ne
id|ARPHRD_ETHER
op_logical_and
id|dev-&gt;type
op_ne
id|ARPHRD_LOOPBACK
op_logical_and
id|dev-&gt;type
op_ne
id|ARPHRD_LOCALTLK
op_logical_and
id|dev-&gt;type
op_ne
id|ARPHRD_PPP
)paren
r_return
op_minus
id|EPROTONOSUPPORT
suffix:semicolon
id|nr
op_assign
(paren
r_struct
id|atalk_netrange
op_star
)paren
op_amp
id|sa-&gt;sat_zero
(braket
l_int|0
)braket
suffix:semicolon
id|add_route
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * if this is a point-to-point iface, and we already&n;&t;&t;&t; * have an iface for this AppleTalk address, then we&n;&t;&t;&t; * should not add a route&n;&t;&t;&t; */
r_if
c_cond
(paren
(paren
id|dev-&gt;flags
op_amp
id|IFF_POINTOPOINT
)paren
op_logical_and
id|atalk_find_interface
c_func
(paren
id|sa-&gt;sat_addr.s_net
comma
id|sa-&gt;sat_addr.s_node
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;AppleTalk: point-to-point &quot;
l_string|&quot;interface added with &quot;
l_string|&quot;existing address&bslash;n&quot;
)paren
suffix:semicolon
id|add_route
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t;&t; * Phase 1 is fine on LocalTalk but we don&squot;t do&n;&t;&t;&t; * EtherTalk phase 1. Anyone wanting to add it go ahead.&n;&t;&t;&t; */
r_if
c_cond
(paren
id|dev-&gt;type
op_eq
id|ARPHRD_ETHER
op_logical_and
id|nr-&gt;nr_phase
op_ne
l_int|2
)paren
r_return
op_minus
id|EPROTONOSUPPORT
suffix:semicolon
r_if
c_cond
(paren
id|sa-&gt;sat_addr.s_node
op_eq
id|ATADDR_BCAST
op_logical_or
id|sa-&gt;sat_addr.s_node
op_eq
l_int|254
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|atif
)paren
(brace
multiline_comment|/* Already setting address */
r_if
c_cond
(paren
id|atif-&gt;status
op_amp
id|ATIF_PROBE
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
id|atif-&gt;address.s_net
op_assign
id|sa-&gt;sat_addr.s_net
suffix:semicolon
id|atif-&gt;address.s_node
op_assign
id|sa-&gt;sat_addr.s_node
suffix:semicolon
id|atrtr_device_down
c_func
(paren
id|dev
)paren
suffix:semicolon
multiline_comment|/* Flush old routes */
)brace
r_else
(brace
id|atif
op_assign
id|atif_add_device
c_func
(paren
id|dev
comma
op_amp
id|sa-&gt;sat_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|atif
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|atif-&gt;nets
op_assign
op_star
id|nr
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * Check if the chosen address is used. If so we&n;&t;&t;&t; * error and atalkd will try another.&n;&t;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|dev-&gt;flags
op_amp
id|IFF_LOOPBACK
)paren
op_logical_and
op_logical_neg
(paren
id|dev-&gt;flags
op_amp
id|IFF_POINTOPOINT
)paren
op_logical_and
id|atif_probe_device
c_func
(paren
id|atif
)paren
OL
l_int|0
)paren
(brace
id|atif_drop_device
c_func
(paren
id|dev
)paren
suffix:semicolon
r_return
op_minus
id|EADDRINUSE
suffix:semicolon
)brace
multiline_comment|/* Hey it worked - add the direct routes */
id|sa
op_assign
(paren
r_struct
id|sockaddr_at
op_star
)paren
op_amp
id|rtdef.rt_gateway
suffix:semicolon
id|sa-&gt;sat_family
op_assign
id|AF_APPLETALK
suffix:semicolon
id|sa-&gt;sat_addr.s_net
op_assign
id|atif-&gt;address.s_net
suffix:semicolon
id|sa-&gt;sat_addr.s_node
op_assign
id|atif-&gt;address.s_node
suffix:semicolon
id|sa
op_assign
(paren
r_struct
id|sockaddr_at
op_star
)paren
op_amp
id|rtdef.rt_dst
suffix:semicolon
id|rtdef.rt_flags
op_assign
id|RTF_UP
suffix:semicolon
id|sa-&gt;sat_family
op_assign
id|AF_APPLETALK
suffix:semicolon
id|sa-&gt;sat_addr.s_node
op_assign
id|ATADDR_ANYNODE
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_LOOPBACK
op_logical_or
id|dev-&gt;flags
op_amp
id|IFF_POINTOPOINT
)paren
id|rtdef.rt_flags
op_or_assign
id|RTF_HOST
suffix:semicolon
multiline_comment|/* Routerless initial state */
r_if
c_cond
(paren
id|nr-&gt;nr_firstnet
op_eq
id|htons
c_func
(paren
l_int|0
)paren
op_logical_and
id|nr-&gt;nr_lastnet
op_eq
id|htons
c_func
(paren
l_int|0xFFFE
)paren
)paren
(brace
id|sa-&gt;sat_addr.s_net
op_assign
id|atif-&gt;address.s_net
suffix:semicolon
id|atrtr_create
c_func
(paren
op_amp
id|rtdef
comma
id|dev
)paren
suffix:semicolon
id|atrtr_set_default
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
r_else
(brace
id|limit
op_assign
id|ntohs
c_func
(paren
id|nr-&gt;nr_lastnet
)paren
suffix:semicolon
r_if
c_cond
(paren
id|limit
op_minus
id|ntohs
c_func
(paren
id|nr-&gt;nr_firstnet
)paren
OG
l_int|4096
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Too many routes/&quot;
l_string|&quot;iface.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|add_route
)paren
r_for
c_loop
(paren
id|ct
op_assign
id|ntohs
c_func
(paren
id|nr-&gt;nr_firstnet
)paren
suffix:semicolon
id|ct
op_le
id|limit
suffix:semicolon
id|ct
op_increment
)paren
(brace
id|sa-&gt;sat_addr.s_net
op_assign
id|htons
c_func
(paren
id|ct
)paren
suffix:semicolon
id|atrtr_create
c_func
(paren
op_amp
id|rtdef
comma
id|dev
)paren
suffix:semicolon
)brace
)brace
id|dev_mc_add
c_func
(paren
id|dev
comma
id|aarp_mcast
comma
l_int|6
comma
l_int|1
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SIOCGIFADDR
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|atif
)paren
r_return
op_minus
id|EADDRNOTAVAIL
suffix:semicolon
id|sa-&gt;sat_family
op_assign
id|AF_APPLETALK
suffix:semicolon
id|sa-&gt;sat_addr
op_assign
id|atif-&gt;address
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SIOCGIFBRDADDR
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|atif
)paren
r_return
op_minus
id|EADDRNOTAVAIL
suffix:semicolon
id|sa-&gt;sat_family
op_assign
id|AF_APPLETALK
suffix:semicolon
id|sa-&gt;sat_addr.s_net
op_assign
id|atif-&gt;address.s_net
suffix:semicolon
id|sa-&gt;sat_addr.s_node
op_assign
id|ATADDR_BCAST
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SIOCATALKDIFADDR
suffix:colon
r_case
id|SIOCDIFADDR
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
r_if
c_cond
(paren
id|sa-&gt;sat_family
op_ne
id|AF_APPLETALK
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|atalk_dev_down
c_func
(paren
id|dev
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SIOCSARP
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
r_if
c_cond
(paren
id|sa-&gt;sat_family
op_ne
id|AF_APPLETALK
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|atif
)paren
r_return
op_minus
id|EADDRNOTAVAIL
suffix:semicolon
multiline_comment|/*&n;                         * for now, we only support proxy AARP on ELAP;&n;                         * we should be able to do it for LocalTalk, too.&n;                         */
r_if
c_cond
(paren
id|dev-&gt;type
op_ne
id|ARPHRD_ETHER
)paren
r_return
op_minus
id|EPROTONOSUPPORT
suffix:semicolon
multiline_comment|/*&n;                         * atif points to the current interface on this network;&n;                         * we aren&squot;t concerned about its current status (at&n;&t;&t;&t; * least for now), but it has all the settings about&n;&t;&t;&t; * the network we&squot;re going to probe. Consequently, it&n;&t;&t;&t; * must exist.&n;                         */
r_if
c_cond
(paren
op_logical_neg
id|atif
)paren
r_return
op_minus
id|EADDRNOTAVAIL
suffix:semicolon
id|nr
op_assign
(paren
r_struct
id|atalk_netrange
op_star
)paren
op_amp
(paren
id|atif-&gt;nets
)paren
suffix:semicolon
multiline_comment|/*&n;                         * Phase 1 is fine on Localtalk but we don&squot;t do&n;                         * Ethertalk phase 1. Anyone wanting to add it go ahead.&n;                         */
r_if
c_cond
(paren
id|dev-&gt;type
op_eq
id|ARPHRD_ETHER
op_logical_and
id|nr-&gt;nr_phase
op_ne
l_int|2
)paren
r_return
op_minus
id|EPROTONOSUPPORT
suffix:semicolon
r_if
c_cond
(paren
id|sa-&gt;sat_addr.s_node
op_eq
id|ATADDR_BCAST
op_logical_or
id|sa-&gt;sat_addr.s_node
op_eq
l_int|254
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/*&n;                         * Check if the chosen address is used. If so we&n;                         * error and ATCP will try another.&n;                         */
r_if
c_cond
(paren
id|atif_proxy_probe_device
c_func
(paren
id|atif
comma
op_amp
(paren
id|sa-&gt;sat_addr
)paren
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EADDRINUSE
suffix:semicolon
multiline_comment|/*&n;                         * We now have an address on the local network, and&n;&t;&t;&t; * the AARP code will defend it for us until we take it&n;&t;&t;&t; * down. We don&squot;t set up any routes right now, because&n;&t;&t;&t; * ATCP will install them manually via SIOCADDRT.&n;                         */
r_break
suffix:semicolon
r_case
id|SIOCDARP
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
r_if
c_cond
(paren
id|sa-&gt;sat_family
op_ne
id|AF_APPLETALK
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|atif
)paren
r_return
op_minus
id|EADDRNOTAVAIL
suffix:semicolon
multiline_comment|/* give to aarp module to remove proxy entry */
id|aarp_proxy_remove
c_func
(paren
id|atif-&gt;dev
comma
op_amp
(paren
id|sa-&gt;sat_addr
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|atreq
comma
r_sizeof
(paren
id|atreq
)paren
)paren
ques
c_cond
op_minus
id|EFAULT
suffix:colon
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Routing ioctl() calls */
DECL|function|atrtr_ioctl
r_static
r_int
id|atrtr_ioctl
c_func
(paren
r_int
r_int
id|cmd
comma
r_void
id|__user
op_star
id|arg
)paren
(brace
r_struct
id|rtentry
id|rt
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|rt
comma
id|arg
comma
r_sizeof
(paren
id|rt
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SIOCDELRT
suffix:colon
r_if
c_cond
(paren
id|rt.rt_dst.sa_family
op_ne
id|AF_APPLETALK
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_return
id|atrtr_delete
c_func
(paren
op_amp
(paren
(paren
r_struct
id|sockaddr_at
op_star
)paren
op_amp
id|rt.rt_dst
)paren
op_member_access_from_pointer
id|sat_addr
)paren
suffix:semicolon
r_case
id|SIOCADDRT
suffix:colon
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|rt.rt_dev
)paren
(brace
r_char
id|name
(braket
id|IFNAMSIZ
)braket
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|name
comma
id|rt.rt_dev
comma
id|IFNAMSIZ
op_minus
l_int|1
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|name
(braket
id|IFNAMSIZ
op_minus
l_int|1
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|dev
op_assign
id|__dev_get_by_name
c_func
(paren
id|name
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_return
id|atrtr_create
c_func
(paren
op_amp
id|rt
comma
id|dev
)paren
suffix:semicolon
)brace
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/**************************************************************************&bslash;&n;*                                                                          *&n;* Handling for system calls applied via the various interfaces to an       *&n;* AppleTalk socket object.                                                 *&n;*                                                                          *&n;&bslash;**************************************************************************/
multiline_comment|/*&n; * Checksum: This is &squot;optional&squot;. It&squot;s quite likely also a good&n; * candidate for assembler hackery 8)&n; */
DECL|function|atalk_sum_partial
r_static
r_int
r_int
id|atalk_sum_partial
c_func
(paren
r_const
r_int
r_char
op_star
id|data
comma
r_int
id|len
comma
r_int
r_int
id|sum
)paren
(brace
multiline_comment|/* This ought to be unwrapped neatly. I&squot;ll trust gcc for now */
r_while
c_loop
(paren
id|len
op_decrement
)paren
(brace
id|sum
op_add_assign
op_star
id|data
suffix:semicolon
id|sum
op_lshift_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|sum
op_amp
l_int|0x10000
)paren
(brace
id|sum
op_increment
suffix:semicolon
id|sum
op_and_assign
l_int|0xffff
suffix:semicolon
)brace
id|data
op_increment
suffix:semicolon
)brace
r_return
id|sum
suffix:semicolon
)brace
multiline_comment|/*  Checksum skb data --  similar to skb_checksum  */
DECL|function|atalk_sum_skb
r_static
r_int
r_int
id|atalk_sum_skb
c_func
(paren
r_const
r_struct
id|sk_buff
op_star
id|skb
comma
r_int
id|offset
comma
r_int
id|len
comma
r_int
r_int
id|sum
)paren
(brace
r_int
id|start
op_assign
id|skb_headlen
c_func
(paren
id|skb
)paren
suffix:semicolon
r_int
id|i
comma
id|copy
suffix:semicolon
multiline_comment|/* checksum stuff in header space */
r_if
c_cond
(paren
(paren
id|copy
op_assign
id|start
op_minus
id|offset
)paren
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|copy
OG
id|len
)paren
id|copy
op_assign
id|len
suffix:semicolon
id|sum
op_assign
id|atalk_sum_partial
c_func
(paren
id|skb-&gt;data
op_plus
id|offset
comma
id|copy
comma
id|sum
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|len
op_sub_assign
id|copy
)paren
op_eq
l_int|0
)paren
r_return
id|sum
suffix:semicolon
id|offset
op_add_assign
id|copy
suffix:semicolon
)brace
multiline_comment|/* checksum stuff in frags */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|skb_shinfo
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|nr_frags
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
id|end
suffix:semicolon
id|BUG_TRAP
c_func
(paren
id|start
op_le
id|offset
op_plus
id|len
)paren
suffix:semicolon
id|end
op_assign
id|start
op_plus
id|skb_shinfo
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|frags
(braket
id|i
)braket
dot
id|size
suffix:semicolon
r_if
c_cond
(paren
(paren
id|copy
op_assign
id|end
op_minus
id|offset
)paren
OG
l_int|0
)paren
(brace
id|u8
op_star
id|vaddr
suffix:semicolon
id|skb_frag_t
op_star
id|frag
op_assign
op_amp
id|skb_shinfo
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|frags
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|copy
OG
id|len
)paren
id|copy
op_assign
id|len
suffix:semicolon
id|vaddr
op_assign
id|kmap_skb_frag
c_func
(paren
id|frag
)paren
suffix:semicolon
id|sum
op_assign
id|atalk_sum_partial
c_func
(paren
id|vaddr
op_plus
id|frag-&gt;page_offset
op_plus
id|offset
op_minus
id|start
comma
id|copy
comma
id|sum
)paren
suffix:semicolon
id|kunmap_skb_frag
c_func
(paren
id|vaddr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|len
op_sub_assign
id|copy
)paren
)paren
r_return
id|sum
suffix:semicolon
id|offset
op_add_assign
id|copy
suffix:semicolon
)brace
id|start
op_assign
id|end
suffix:semicolon
)brace
r_if
c_cond
(paren
id|skb_shinfo
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|frag_list
)paren
(brace
r_struct
id|sk_buff
op_star
id|list
op_assign
id|skb_shinfo
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|frag_list
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|list
suffix:semicolon
id|list
op_assign
id|list-&gt;next
)paren
(brace
r_int
id|end
suffix:semicolon
id|BUG_TRAP
c_func
(paren
id|start
op_le
id|offset
op_plus
id|len
)paren
suffix:semicolon
id|end
op_assign
id|start
op_plus
id|list-&gt;len
suffix:semicolon
r_if
c_cond
(paren
(paren
id|copy
op_assign
id|end
op_minus
id|offset
)paren
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|copy
OG
id|len
)paren
id|copy
op_assign
id|len
suffix:semicolon
id|sum
op_assign
id|atalk_sum_skb
c_func
(paren
id|list
comma
id|offset
op_minus
id|start
comma
id|copy
comma
id|sum
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|len
op_sub_assign
id|copy
)paren
op_eq
l_int|0
)paren
r_return
id|sum
suffix:semicolon
id|offset
op_add_assign
id|copy
suffix:semicolon
)brace
id|start
op_assign
id|end
suffix:semicolon
)brace
)brace
id|BUG_ON
c_func
(paren
id|len
OG
l_int|0
)paren
suffix:semicolon
r_return
id|sum
suffix:semicolon
)brace
DECL|function|atalk_checksum
r_static
r_int
r_int
id|atalk_checksum
c_func
(paren
r_const
r_struct
id|sk_buff
op_star
id|skb
comma
r_int
id|len
)paren
(brace
r_int
r_int
id|sum
suffix:semicolon
multiline_comment|/* skip header 4 bytes */
id|sum
op_assign
id|atalk_sum_skb
c_func
(paren
id|skb
comma
l_int|4
comma
id|len
op_minus
l_int|4
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Use 0xFFFF for 0. 0 itself means none */
r_return
id|sum
ques
c_cond
id|htons
c_func
(paren
(paren
r_int
r_int
)paren
id|sum
)paren
suffix:colon
l_int|0xFFFF
suffix:semicolon
)brace
multiline_comment|/*&n; * Create a socket. Initialise the socket, blank the addresses&n; * set the state.&n; */
DECL|function|atalk_create
r_static
r_int
id|atalk_create
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_int
id|protocol
)paren
(brace
r_struct
id|sock
op_star
id|sk
suffix:semicolon
r_struct
id|atalk_sock
op_star
id|at
suffix:semicolon
r_int
id|rc
op_assign
op_minus
id|ESOCKTNOSUPPORT
suffix:semicolon
multiline_comment|/*&n;&t; * We permit SOCK_DGRAM and RAW is an extension. It is trivial to do&n;&t; * and gives you the full ELAP frame. Should be handy for CAP 8) &n;&t; */
r_if
c_cond
(paren
id|sock-&gt;type
op_ne
id|SOCK_RAW
op_logical_and
id|sock-&gt;type
op_ne
id|SOCK_DGRAM
)paren
r_goto
id|out
suffix:semicolon
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
id|sk
op_assign
id|sk_alloc
c_func
(paren
id|PF_APPLETALK
comma
id|GFP_KERNEL
comma
l_int|1
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sk
)paren
r_goto
id|out
suffix:semicolon
id|at
op_assign
id|sk-&gt;sk_protinfo
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|at
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|at
)paren
r_goto
id|outsk
suffix:semicolon
id|memset
c_func
(paren
id|at
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|at
)paren
)paren
suffix:semicolon
id|rc
op_assign
l_int|0
suffix:semicolon
id|sock-&gt;ops
op_assign
op_amp
id|atalk_dgram_ops
suffix:semicolon
id|sock_init_data
c_func
(paren
id|sock
comma
id|sk
)paren
suffix:semicolon
id|sk_set_owner
c_func
(paren
id|sk
comma
id|THIS_MODULE
)paren
suffix:semicolon
multiline_comment|/* Checksums on by default */
id|sk-&gt;sk_zapped
op_assign
l_int|1
suffix:semicolon
id|out
suffix:colon
r_return
id|rc
suffix:semicolon
id|outsk
suffix:colon
id|sk_free
c_func
(paren
id|sk
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* Free a socket. No work needed */
DECL|function|atalk_release
r_static
r_int
id|atalk_release
c_func
(paren
r_struct
id|socket
op_star
id|sock
)paren
(brace
r_struct
id|sock
op_star
id|sk
op_assign
id|sock-&gt;sk
suffix:semicolon
r_if
c_cond
(paren
id|sk
)paren
(brace
id|sock_orphan
c_func
(paren
id|sk
)paren
suffix:semicolon
id|sock-&gt;sk
op_assign
l_int|NULL
suffix:semicolon
id|atalk_destroy_socket
c_func
(paren
id|sk
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; * atalk_pick_and_bind_port - Pick a source port when one is not given&n; * @sk - socket to insert into the tables&n; * @sat - address to search for&n; *&n; * Pick a source port when one is not given. If we can find a suitable free&n; * one, we insert the socket into the tables using it.&n; *&n; * This whole operation must be atomic.&n; */
DECL|function|atalk_pick_and_bind_port
r_static
r_int
id|atalk_pick_and_bind_port
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_struct
id|sockaddr_at
op_star
id|sat
)paren
(brace
r_int
id|retval
suffix:semicolon
id|write_lock_bh
c_func
(paren
op_amp
id|atalk_sockets_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|sat-&gt;sat_port
op_assign
id|ATPORT_RESERVED
suffix:semicolon
id|sat-&gt;sat_port
OL
id|ATPORT_LAST
suffix:semicolon
id|sat-&gt;sat_port
op_increment
)paren
(brace
r_struct
id|sock
op_star
id|s
suffix:semicolon
r_struct
id|hlist_node
op_star
id|node
suffix:semicolon
id|sk_for_each
c_func
(paren
id|s
comma
id|node
comma
op_amp
id|atalk_sockets
)paren
(brace
r_struct
id|atalk_sock
op_star
id|at
op_assign
id|at_sk
c_func
(paren
id|s
)paren
suffix:semicolon
r_if
c_cond
(paren
id|at-&gt;src_net
op_eq
id|sat-&gt;sat_addr.s_net
op_logical_and
id|at-&gt;src_node
op_eq
id|sat-&gt;sat_addr.s_node
op_logical_and
id|at-&gt;src_port
op_eq
id|sat-&gt;sat_port
)paren
r_goto
id|try_next_port
suffix:semicolon
)brace
multiline_comment|/* Wheee, it&squot;s free, assign and insert. */
id|__atalk_insert_socket
c_func
(paren
id|sk
)paren
suffix:semicolon
id|at_sk
c_func
(paren
id|sk
)paren
op_member_access_from_pointer
id|src_port
op_assign
id|sat-&gt;sat_port
suffix:semicolon
id|retval
op_assign
l_int|0
suffix:semicolon
r_goto
id|out
suffix:semicolon
id|try_next_port
suffix:colon
suffix:semicolon
)brace
id|retval
op_assign
op_minus
id|EBUSY
suffix:semicolon
id|out
suffix:colon
id|write_unlock_bh
c_func
(paren
op_amp
id|atalk_sockets_lock
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
DECL|function|atalk_autobind
r_static
r_int
id|atalk_autobind
c_func
(paren
r_struct
id|sock
op_star
id|sk
)paren
(brace
r_struct
id|atalk_sock
op_star
id|at
op_assign
id|at_sk
c_func
(paren
id|sk
)paren
suffix:semicolon
r_struct
id|sockaddr_at
id|sat
suffix:semicolon
r_struct
id|atalk_addr
op_star
id|ap
op_assign
id|atalk_find_primary
c_func
(paren
)paren
suffix:semicolon
r_int
id|n
op_assign
op_minus
id|EADDRNOTAVAIL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ap
op_logical_or
id|ap-&gt;s_net
op_eq
id|htons
c_func
(paren
id|ATADDR_ANYNET
)paren
)paren
r_goto
id|out
suffix:semicolon
id|at-&gt;src_net
op_assign
id|sat.sat_addr.s_net
op_assign
id|ap-&gt;s_net
suffix:semicolon
id|at-&gt;src_node
op_assign
id|sat.sat_addr.s_node
op_assign
id|ap-&gt;s_node
suffix:semicolon
id|n
op_assign
id|atalk_pick_and_bind_port
c_func
(paren
id|sk
comma
op_amp
id|sat
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|n
)paren
id|sk-&gt;sk_zapped
op_assign
l_int|0
suffix:semicolon
id|out
suffix:colon
r_return
id|n
suffix:semicolon
)brace
multiline_comment|/* Set the address &squot;our end&squot; of the connection */
DECL|function|atalk_bind
r_static
r_int
id|atalk_bind
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_struct
id|sockaddr
op_star
id|uaddr
comma
r_int
id|addr_len
)paren
(brace
r_struct
id|sockaddr_at
op_star
id|addr
op_assign
(paren
r_struct
id|sockaddr_at
op_star
)paren
id|uaddr
suffix:semicolon
r_struct
id|sock
op_star
id|sk
op_assign
id|sock-&gt;sk
suffix:semicolon
r_struct
id|atalk_sock
op_star
id|at
op_assign
id|at_sk
c_func
(paren
id|sk
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sk-&gt;sk_zapped
op_logical_or
id|addr_len
op_ne
r_sizeof
(paren
r_struct
id|sockaddr_at
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|addr-&gt;sat_family
op_ne
id|AF_APPLETALK
)paren
r_return
op_minus
id|EAFNOSUPPORT
suffix:semicolon
r_if
c_cond
(paren
id|addr-&gt;sat_addr.s_net
op_eq
id|htons
c_func
(paren
id|ATADDR_ANYNET
)paren
)paren
(brace
r_struct
id|atalk_addr
op_star
id|ap
op_assign
id|atalk_find_primary
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ap
)paren
r_return
op_minus
id|EADDRNOTAVAIL
suffix:semicolon
id|at-&gt;src_net
op_assign
id|addr-&gt;sat_addr.s_net
op_assign
id|ap-&gt;s_net
suffix:semicolon
id|at-&gt;src_node
op_assign
id|addr-&gt;sat_addr.s_node
op_assign
id|ap-&gt;s_node
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
op_logical_neg
id|atalk_find_interface
c_func
(paren
id|addr-&gt;sat_addr.s_net
comma
id|addr-&gt;sat_addr.s_node
)paren
)paren
r_return
op_minus
id|EADDRNOTAVAIL
suffix:semicolon
id|at-&gt;src_net
op_assign
id|addr-&gt;sat_addr.s_net
suffix:semicolon
id|at-&gt;src_node
op_assign
id|addr-&gt;sat_addr.s_node
suffix:semicolon
)brace
r_if
c_cond
(paren
id|addr-&gt;sat_port
op_eq
id|ATADDR_ANYPORT
)paren
(brace
r_int
id|n
op_assign
id|atalk_pick_and_bind_port
c_func
(paren
id|sk
comma
id|addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|n
OL
l_int|0
)paren
r_return
id|n
suffix:semicolon
)brace
r_else
(brace
id|at-&gt;src_port
op_assign
id|addr-&gt;sat_port
suffix:semicolon
r_if
c_cond
(paren
id|atalk_find_or_insert_socket
c_func
(paren
id|sk
comma
id|addr
)paren
)paren
r_return
op_minus
id|EADDRINUSE
suffix:semicolon
)brace
id|sk-&gt;sk_zapped
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Set the address we talk to */
DECL|function|atalk_connect
r_static
r_int
id|atalk_connect
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_struct
id|sockaddr
op_star
id|uaddr
comma
r_int
id|addr_len
comma
r_int
id|flags
)paren
(brace
r_struct
id|sock
op_star
id|sk
op_assign
id|sock-&gt;sk
suffix:semicolon
r_struct
id|atalk_sock
op_star
id|at
op_assign
id|at_sk
c_func
(paren
id|sk
)paren
suffix:semicolon
r_struct
id|sockaddr_at
op_star
id|addr
suffix:semicolon
id|sk-&gt;sk_state
op_assign
id|TCP_CLOSE
suffix:semicolon
id|sock-&gt;state
op_assign
id|SS_UNCONNECTED
suffix:semicolon
r_if
c_cond
(paren
id|addr_len
op_ne
r_sizeof
(paren
op_star
id|addr
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|addr
op_assign
(paren
r_struct
id|sockaddr_at
op_star
)paren
id|uaddr
suffix:semicolon
r_if
c_cond
(paren
id|addr-&gt;sat_family
op_ne
id|AF_APPLETALK
)paren
r_return
op_minus
id|EAFNOSUPPORT
suffix:semicolon
r_if
c_cond
(paren
id|addr-&gt;sat_addr.s_node
op_eq
id|ATADDR_BCAST
op_logical_and
op_logical_neg
id|sock_flag
c_func
(paren
id|sk
comma
id|SOCK_BROADCAST
)paren
)paren
(brace
macro_line|#if 1&t;
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s is broken and did not set &quot;
l_string|&quot;SO_BROADCAST. It will break when 2.2 is &quot;
l_string|&quot;released.&bslash;n&quot;
comma
id|current-&gt;comm
)paren
suffix:semicolon
macro_line|#else
r_return
op_minus
id|EACCES
suffix:semicolon
macro_line|#endif&t;&t;&t;
)brace
r_if
c_cond
(paren
id|sk-&gt;sk_zapped
)paren
r_if
c_cond
(paren
id|atalk_autobind
c_func
(paren
id|sk
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|atrtr_get_dev
c_func
(paren
op_amp
id|addr-&gt;sat_addr
)paren
)paren
r_return
op_minus
id|ENETUNREACH
suffix:semicolon
id|at-&gt;dest_port
op_assign
id|addr-&gt;sat_port
suffix:semicolon
id|at-&gt;dest_net
op_assign
id|addr-&gt;sat_addr.s_net
suffix:semicolon
id|at-&gt;dest_node
op_assign
id|addr-&gt;sat_addr.s_node
suffix:semicolon
id|sock-&gt;state
op_assign
id|SS_CONNECTED
suffix:semicolon
id|sk-&gt;sk_state
op_assign
id|TCP_ESTABLISHED
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Find the name of an AppleTalk socket. Just copy the right&n; * fields into the sockaddr.&n; */
DECL|function|atalk_getname
r_static
r_int
id|atalk_getname
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_struct
id|sockaddr
op_star
id|uaddr
comma
r_int
op_star
id|uaddr_len
comma
r_int
id|peer
)paren
(brace
r_struct
id|sockaddr_at
id|sat
suffix:semicolon
r_struct
id|sock
op_star
id|sk
op_assign
id|sock-&gt;sk
suffix:semicolon
r_struct
id|atalk_sock
op_star
id|at
op_assign
id|at_sk
c_func
(paren
id|sk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;sk_zapped
)paren
r_if
c_cond
(paren
id|atalk_autobind
c_func
(paren
id|sk
)paren
OL
l_int|0
)paren
r_return
op_minus
id|ENOBUFS
suffix:semicolon
op_star
id|uaddr_len
op_assign
r_sizeof
(paren
r_struct
id|sockaddr_at
)paren
suffix:semicolon
r_if
c_cond
(paren
id|peer
)paren
(brace
r_if
c_cond
(paren
id|sk-&gt;sk_state
op_ne
id|TCP_ESTABLISHED
)paren
r_return
op_minus
id|ENOTCONN
suffix:semicolon
id|sat.sat_addr.s_net
op_assign
id|at-&gt;dest_net
suffix:semicolon
id|sat.sat_addr.s_node
op_assign
id|at-&gt;dest_node
suffix:semicolon
id|sat.sat_port
op_assign
id|at-&gt;dest_port
suffix:semicolon
)brace
r_else
(brace
id|sat.sat_addr.s_net
op_assign
id|at-&gt;src_net
suffix:semicolon
id|sat.sat_addr.s_node
op_assign
id|at-&gt;src_node
suffix:semicolon
id|sat.sat_port
op_assign
id|at-&gt;src_port
suffix:semicolon
)brace
id|sat.sat_family
op_assign
id|AF_APPLETALK
suffix:semicolon
id|memcpy
c_func
(paren
id|uaddr
comma
op_amp
id|sat
comma
r_sizeof
(paren
id|sat
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#if defined(CONFIG_IPDDP) || defined(CONFIG_IPDDP_MODULE)
DECL|function|is_ip_over_ddp
r_static
id|__inline__
r_int
id|is_ip_over_ddp
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_return
id|skb-&gt;data
(braket
l_int|12
)braket
op_eq
l_int|22
suffix:semicolon
)brace
DECL|function|handle_ip_over_ddp
r_static
r_int
id|handle_ip_over_ddp
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|__dev_get_by_name
c_func
(paren
l_string|&quot;ipddp0&quot;
)paren
suffix:semicolon
r_struct
id|net_device_stats
op_star
id|stats
suffix:semicolon
multiline_comment|/* This needs to be able to handle ipddp&quot;N&quot; devices */
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|htons
c_func
(paren
id|ETH_P_IP
)paren
suffix:semicolon
id|skb_pull
c_func
(paren
id|skb
comma
l_int|13
)paren
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb-&gt;h.raw
op_assign
id|skb-&gt;data
suffix:semicolon
id|stats
op_assign
id|dev-&gt;priv
suffix:semicolon
id|stats-&gt;rx_packets
op_increment
suffix:semicolon
id|stats-&gt;rx_bytes
op_add_assign
id|skb-&gt;len
op_plus
l_int|13
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
multiline_comment|/* Send the SKB up to a higher place. */
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#else
multiline_comment|/* make it easy for gcc to optimize this test out, i.e. kill the code */
DECL|macro|is_ip_over_ddp
mdefine_line|#define is_ip_over_ddp(skb) 0
DECL|macro|handle_ip_over_ddp
mdefine_line|#define handle_ip_over_ddp(skb) 0
macro_line|#endif
DECL|function|atalk_route_packet
r_static
r_void
id|atalk_route_packet
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|ddpehdr
op_star
id|ddp
comma
r_struct
id|ddpebits
op_star
id|ddphv
comma
r_int
id|origlen
)paren
(brace
r_struct
id|atalk_route
op_star
id|rt
suffix:semicolon
r_struct
id|atalk_addr
id|ta
suffix:semicolon
multiline_comment|/*&n;&t; * Don&squot;t route multicast, etc., packets, or packets sent to &quot;this&n;&t; * network&quot; &n;&t; */
r_if
c_cond
(paren
id|skb-&gt;pkt_type
op_ne
id|PACKET_HOST
op_logical_or
op_logical_neg
id|ddp-&gt;deh_dnet
)paren
(brace
multiline_comment|/*&n;&t;&t; * FIXME:&n;&t;&t; *&n;&t;&t; * Can it ever happen that a packet is from a PPP iface and&n;&t;&t; * needs to be broadcast onto the default network?&n;&t;&t; */
r_if
c_cond
(paren
id|dev-&gt;type
op_eq
id|ARPHRD_PPP
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;AppleTalk: didn&squot;t forward broadcast &quot;
l_string|&quot;packet received from PPP iface&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|free_it
suffix:semicolon
)brace
id|ta.s_net
op_assign
id|ddp-&gt;deh_dnet
suffix:semicolon
id|ta.s_node
op_assign
id|ddp-&gt;deh_dnode
suffix:semicolon
multiline_comment|/* Route the packet */
id|rt
op_assign
id|atrtr_find
c_func
(paren
op_amp
id|ta
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rt
op_logical_or
id|ddphv-&gt;deh_hops
op_eq
id|DDP_MAXHOPS
)paren
r_goto
id|free_it
suffix:semicolon
multiline_comment|/* FIXME: use skb-&gt;cb to be able to use shared skbs */
id|ddphv-&gt;deh_hops
op_increment
suffix:semicolon
multiline_comment|/*&n;&t; * Route goes through another gateway, so set the target to the&n;&t; * gateway instead.&n;&t; */
r_if
c_cond
(paren
id|rt-&gt;flags
op_amp
id|RTF_GATEWAY
)paren
(brace
id|ta.s_net
op_assign
id|rt-&gt;gateway.s_net
suffix:semicolon
id|ta.s_node
op_assign
id|rt-&gt;gateway.s_node
suffix:semicolon
)brace
multiline_comment|/* Fix up skb-&gt;len field */
id|skb_trim
c_func
(paren
id|skb
comma
id|min_t
c_func
(paren
r_int
r_int
comma
id|origlen
comma
(paren
id|rt-&gt;dev-&gt;hard_header_len
op_plus
id|ddp_dl-&gt;header_length
op_plus
id|ddphv-&gt;deh_len
)paren
)paren
)paren
suffix:semicolon
multiline_comment|/* Mend the byte order */
multiline_comment|/* FIXME: use skb-&gt;cb to be able to use shared skbs */
op_star
(paren
(paren
id|__u16
op_star
)paren
id|ddp
)paren
op_assign
id|ntohs
c_func
(paren
op_star
(paren
(paren
id|__u16
op_star
)paren
id|ddphv
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Send the buffer onwards&n;&t; *&n;&t; * Now we must always be careful. If it&squot;s come from LocalTalk to&n;&t; * EtherTalk it might not fit&n;&t; *&n;&t; * Order matters here: If a packet has to be copied to make a new&n;&t; * headroom (rare hopefully) then it won&squot;t need unsharing.&n;&t; *&n;&t; * Note. ddp-&gt; becomes invalid at the realloc.&n;&t; */
r_if
c_cond
(paren
id|skb_headroom
c_func
(paren
id|skb
)paren
OL
l_int|22
)paren
(brace
multiline_comment|/* 22 bytes - 12 ether, 2 len, 3 802.2 5 snap */
r_struct
id|sk_buff
op_star
id|nskb
op_assign
id|skb_realloc_headroom
c_func
(paren
id|skb
comma
l_int|32
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|nskb
)paren
r_goto
id|out
suffix:semicolon
id|skb
op_assign
id|nskb
suffix:semicolon
)brace
r_else
id|skb
op_assign
id|skb_unshare
c_func
(paren
id|skb
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * If the buffer didn&squot;t vanish into the lack of space bitbucket we can&n;&t; * send it.&n;&t; */
r_if
c_cond
(paren
id|skb
op_logical_and
id|aarp_send_ddp
c_func
(paren
id|rt-&gt;dev
comma
id|skb
comma
op_amp
id|ta
comma
l_int|NULL
)paren
op_eq
op_minus
l_int|1
)paren
r_goto
id|free_it
suffix:semicolon
id|out
suffix:colon
r_return
suffix:semicolon
id|free_it
suffix:colon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;atalk_rcv - Receive a packet (in skb) from device dev&n; *&t;@skb - packet received&n; *&t;@dev - network device where the packet comes from&n; *&t;@pt - packet type&n; *&n; *&t;Receive a packet (in skb) from device dev. This has come from the SNAP&n; *&t;decoder, and on entry skb-&gt;h.raw is the DDP header, skb-&gt;len is the DDP&n; *&t;header, skb-&gt;len is the DDP length. The physical headers have been&n; *&t;extracted. PPP should probably pass frames marked as for this layer.&n; *&t;[ie ARPHRD_ETHERTALK]&n; */
DECL|function|atalk_rcv
r_static
r_int
id|atalk_rcv
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|packet_type
op_star
id|pt
)paren
(brace
r_struct
id|ddpehdr
op_star
id|ddp
suffix:semicolon
r_struct
id|sock
op_star
id|sock
suffix:semicolon
r_struct
id|atalk_iface
op_star
id|atif
suffix:semicolon
r_struct
id|sockaddr_at
id|tosat
suffix:semicolon
r_int
id|origlen
suffix:semicolon
r_struct
id|ddpebits
id|ddphv
suffix:semicolon
multiline_comment|/* Don&squot;t mangle buffer if shared */
r_if
c_cond
(paren
op_logical_neg
(paren
id|skb
op_assign
id|skb_share_check
c_func
(paren
id|skb
comma
id|GFP_ATOMIC
)paren
)paren
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* Size check and make sure header is contiguous */
r_if
c_cond
(paren
op_logical_neg
id|pskb_may_pull
c_func
(paren
id|skb
comma
r_sizeof
(paren
op_star
id|ddp
)paren
)paren
)paren
r_goto
id|freeit
suffix:semicolon
id|ddp
op_assign
id|ddp_hdr
c_func
(paren
id|skb
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Fix up the length field&t;[Ok this is horrible but otherwise&n;&t; *&t;I end up with unions of bit fields and messy bit field order&n;&t; *&t;compiler/endian dependencies..]&n;&t; */
op_star
(paren
(paren
id|__u16
op_star
)paren
op_amp
id|ddphv
)paren
op_assign
id|ntohs
c_func
(paren
op_star
(paren
(paren
id|__u16
op_star
)paren
id|ddp
)paren
)paren
suffix:semicolon
multiline_comment|/* Trim buffer in case of stray trailing data */
id|origlen
op_assign
id|skb-&gt;len
suffix:semicolon
id|skb_trim
c_func
(paren
id|skb
comma
id|min_t
c_func
(paren
r_int
r_int
comma
id|skb-&gt;len
comma
id|ddphv.deh_len
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Size check to see if ddp-&gt;deh_len was crap&n;&t; * (Otherwise we&squot;ll detonate most spectacularly&n;&t; * in the middle of recvmsg()).&n;&t; */
r_if
c_cond
(paren
id|skb-&gt;len
OL
r_sizeof
(paren
op_star
id|ddp
)paren
)paren
r_goto
id|freeit
suffix:semicolon
multiline_comment|/*&n;&t; * Any checksums. Note we don&squot;t do htons() on this == is assumed to be&n;&t; * valid for net byte orders all over the networking code...&n;&t; */
r_if
c_cond
(paren
id|ddp-&gt;deh_sum
op_logical_and
id|atalk_checksum
c_func
(paren
id|skb
comma
id|ddphv.deh_len
)paren
op_ne
id|ddp-&gt;deh_sum
)paren
multiline_comment|/* Not a valid AppleTalk frame - dustbin time */
r_goto
id|freeit
suffix:semicolon
multiline_comment|/* Check the packet is aimed at us */
r_if
c_cond
(paren
op_logical_neg
id|ddp-&gt;deh_dnet
)paren
multiline_comment|/* Net 0 is &squot;this network&squot; */
id|atif
op_assign
id|atalk_find_anynet
c_func
(paren
id|ddp-&gt;deh_dnode
comma
id|dev
)paren
suffix:semicolon
r_else
id|atif
op_assign
id|atalk_find_interface
c_func
(paren
id|ddp-&gt;deh_dnet
comma
id|ddp-&gt;deh_dnode
)paren
suffix:semicolon
multiline_comment|/* Not ours, so we route the packet via the correct AppleTalk iface */
r_if
c_cond
(paren
op_logical_neg
id|atif
)paren
(brace
id|atalk_route_packet
c_func
(paren
id|skb
comma
id|dev
comma
id|ddp
comma
op_amp
id|ddphv
comma
id|origlen
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* if IP over DDP is not selected this code will be optimized out */
r_if
c_cond
(paren
id|is_ip_over_ddp
c_func
(paren
id|skb
)paren
)paren
r_return
id|handle_ip_over_ddp
c_func
(paren
id|skb
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Which socket - atalk_search_socket() looks for a *full match*&n;&t; * of the &lt;net, node, port&gt; tuple.&n;&t; */
id|tosat.sat_addr.s_net
op_assign
id|ddp-&gt;deh_dnet
suffix:semicolon
id|tosat.sat_addr.s_node
op_assign
id|ddp-&gt;deh_dnode
suffix:semicolon
id|tosat.sat_port
op_assign
id|ddp-&gt;deh_dport
suffix:semicolon
id|sock
op_assign
id|atalk_search_socket
c_func
(paren
op_amp
id|tosat
comma
id|atif
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sock
)paren
multiline_comment|/* But not one of our sockets */
r_goto
id|freeit
suffix:semicolon
multiline_comment|/* Queue packet (standard) */
id|skb-&gt;sk
op_assign
id|sock
suffix:semicolon
r_if
c_cond
(paren
id|sock_queue_rcv_skb
c_func
(paren
id|sock
comma
id|skb
)paren
OL
l_int|0
)paren
r_goto
id|freeit
suffix:semicolon
id|out
suffix:colon
r_return
l_int|0
suffix:semicolon
id|freeit
suffix:colon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/*&n; * Receive a LocalTalk frame. We make some demands on the caller here.&n; * Caller must provide enough headroom on the packet to pull the short&n; * header and append a long one.&n; */
DECL|function|ltalk_rcv
r_static
r_int
id|ltalk_rcv
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|packet_type
op_star
id|pt
)paren
(brace
multiline_comment|/* Expand any short form frames */
r_if
c_cond
(paren
id|skb-&gt;mac.raw
(braket
l_int|2
)braket
op_eq
l_int|1
)paren
(brace
r_struct
id|ddpehdr
op_star
id|ddp
suffix:semicolon
multiline_comment|/* Find our address */
r_struct
id|atalk_addr
op_star
id|ap
op_assign
id|atalk_find_dev_addr
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ap
op_logical_or
id|skb-&gt;len
OL
r_sizeof
(paren
r_struct
id|ddpshdr
)paren
)paren
r_goto
id|freeit
suffix:semicolon
multiline_comment|/* Don&squot;t mangle buffer if shared */
r_if
c_cond
(paren
op_logical_neg
(paren
id|skb
op_assign
id|skb_share_check
c_func
(paren
id|skb
comma
id|GFP_ATOMIC
)paren
)paren
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t;&t; * The push leaves us with a ddephdr not an shdr, and&n;&t;&t; * handily the port bytes in the right place preset.&n;&t;&t; */
id|ddp
op_assign
(paren
r_struct
id|ddpehdr
op_star
)paren
id|skb_push
c_func
(paren
id|skb
comma
r_sizeof
(paren
op_star
id|ddp
)paren
op_minus
l_int|4
)paren
suffix:semicolon
multiline_comment|/* Now fill in the long header */
multiline_comment|/*&n;&t; &t; * These two first. The mac overlays the new source/dest&n;&t; &t; * network information so we MUST copy these before&n;&t; &t; * we write the network numbers !&n;&t; &t; */
id|ddp-&gt;deh_dnode
op_assign
id|skb-&gt;mac.raw
(braket
l_int|0
)braket
suffix:semicolon
multiline_comment|/* From physical header */
id|ddp-&gt;deh_snode
op_assign
id|skb-&gt;mac.raw
(braket
l_int|1
)braket
suffix:semicolon
multiline_comment|/* From physical header */
id|ddp-&gt;deh_dnet
op_assign
id|ap-&gt;s_net
suffix:semicolon
multiline_comment|/* Network number */
id|ddp-&gt;deh_snet
op_assign
id|ap-&gt;s_net
suffix:semicolon
id|ddp-&gt;deh_sum
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* No checksum */
multiline_comment|/*&n;&t;&t; * Not sure about this bit...&n;&t;&t; */
id|ddp-&gt;deh_len
op_assign
id|skb-&gt;len
suffix:semicolon
id|ddp-&gt;deh_hops
op_assign
id|DDP_MAXHOPS
suffix:semicolon
multiline_comment|/* Non routable, so force a drop&n;&t;&t;&t;&t;&t;&t;   if we slip up later */
multiline_comment|/* Mend the byte order */
op_star
(paren
(paren
id|__u16
op_star
)paren
id|ddp
)paren
op_assign
id|htons
c_func
(paren
op_star
(paren
(paren
id|__u16
op_star
)paren
id|ddp
)paren
)paren
suffix:semicolon
)brace
id|skb-&gt;h.raw
op_assign
id|skb-&gt;data
suffix:semicolon
r_return
id|atalk_rcv
c_func
(paren
id|skb
comma
id|dev
comma
id|pt
)paren
suffix:semicolon
id|freeit
suffix:colon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|atalk_sendmsg
r_static
r_int
id|atalk_sendmsg
c_func
(paren
r_struct
id|kiocb
op_star
id|iocb
comma
r_struct
id|socket
op_star
id|sock
comma
r_struct
id|msghdr
op_star
id|msg
comma
r_int
id|len
)paren
(brace
r_struct
id|sock
op_star
id|sk
op_assign
id|sock-&gt;sk
suffix:semicolon
r_struct
id|atalk_sock
op_star
id|at
op_assign
id|at_sk
c_func
(paren
id|sk
)paren
suffix:semicolon
r_struct
id|sockaddr_at
op_star
id|usat
op_assign
(paren
r_struct
id|sockaddr_at
op_star
)paren
id|msg-&gt;msg_name
suffix:semicolon
r_int
id|flags
op_assign
id|msg-&gt;msg_flags
suffix:semicolon
r_int
id|loopback
op_assign
l_int|0
suffix:semicolon
r_struct
id|sockaddr_at
id|local_satalk
comma
id|gsat
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_struct
id|ddpehdr
op_star
id|ddp
suffix:semicolon
r_int
id|size
suffix:semicolon
r_struct
id|atalk_route
op_star
id|rt
suffix:semicolon
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
op_complement
(paren
id|MSG_DONTWAIT
op_or
id|MSG_CMSG_COMPAT
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|DDP_MAXSZ
)paren
r_return
op_minus
id|EMSGSIZE
suffix:semicolon
r_if
c_cond
(paren
id|usat
)paren
(brace
r_if
c_cond
(paren
id|sk-&gt;sk_zapped
)paren
r_if
c_cond
(paren
id|atalk_autobind
c_func
(paren
id|sk
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
r_if
c_cond
(paren
id|msg-&gt;msg_namelen
OL
r_sizeof
(paren
op_star
id|usat
)paren
op_logical_or
id|usat-&gt;sat_family
op_ne
id|AF_APPLETALK
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* netatalk doesn&squot;t implement this check */
r_if
c_cond
(paren
id|usat-&gt;sat_addr.s_node
op_eq
id|ATADDR_BCAST
op_logical_and
op_logical_neg
id|sock_flag
c_func
(paren
id|sk
comma
id|SOCK_BROADCAST
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;SO_BROADCAST: Fix your netatalk as &quot;
l_string|&quot;it will break before 2.2&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#if 0
r_return
op_minus
id|EPERM
suffix:semicolon
macro_line|#endif
)brace
)brace
r_else
(brace
r_if
c_cond
(paren
id|sk-&gt;sk_state
op_ne
id|TCP_ESTABLISHED
)paren
r_return
op_minus
id|ENOTCONN
suffix:semicolon
id|usat
op_assign
op_amp
id|local_satalk
suffix:semicolon
id|usat-&gt;sat_family
op_assign
id|AF_APPLETALK
suffix:semicolon
id|usat-&gt;sat_port
op_assign
id|at-&gt;dest_port
suffix:semicolon
id|usat-&gt;sat_addr.s_node
op_assign
id|at-&gt;dest_node
suffix:semicolon
id|usat-&gt;sat_addr.s_net
op_assign
id|at-&gt;dest_net
suffix:semicolon
)brace
multiline_comment|/* Build a packet */
id|SOCK_DEBUG
c_func
(paren
id|sk
comma
l_string|&quot;SK %p: Got address.&bslash;n&quot;
comma
id|sk
)paren
suffix:semicolon
multiline_comment|/* For headers */
id|size
op_assign
r_sizeof
(paren
r_struct
id|ddpehdr
)paren
op_plus
id|len
op_plus
id|ddp_dl-&gt;header_length
suffix:semicolon
r_if
c_cond
(paren
id|usat-&gt;sat_addr.s_net
op_logical_or
id|usat-&gt;sat_addr.s_node
op_eq
id|ATADDR_ANYNODE
)paren
(brace
id|rt
op_assign
id|atrtr_find
c_func
(paren
op_amp
id|usat-&gt;sat_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rt
)paren
r_return
op_minus
id|ENETUNREACH
suffix:semicolon
id|dev
op_assign
id|rt-&gt;dev
suffix:semicolon
)brace
r_else
(brace
r_struct
id|atalk_addr
id|at_hint
suffix:semicolon
id|at_hint.s_node
op_assign
l_int|0
suffix:semicolon
id|at_hint.s_net
op_assign
id|at-&gt;src_net
suffix:semicolon
id|rt
op_assign
id|atrtr_find
c_func
(paren
op_amp
id|at_hint
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rt
)paren
r_return
op_minus
id|ENETUNREACH
suffix:semicolon
id|dev
op_assign
id|rt-&gt;dev
suffix:semicolon
)brace
id|SOCK_DEBUG
c_func
(paren
id|sk
comma
l_string|&quot;SK %p: Size needed %d, device %s&bslash;n&quot;
comma
id|sk
comma
id|size
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|size
op_add_assign
id|dev-&gt;hard_header_len
suffix:semicolon
id|skb
op_assign
id|sock_alloc_send_skb
c_func
(paren
id|sk
comma
id|size
comma
(paren
id|flags
op_amp
id|MSG_DONTWAIT
)paren
comma
op_amp
id|err
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
r_return
id|err
suffix:semicolon
id|skb-&gt;sk
op_assign
id|sk
suffix:semicolon
id|skb_reserve
c_func
(paren
id|skb
comma
id|ddp_dl-&gt;header_length
)paren
suffix:semicolon
id|skb_reserve
c_func
(paren
id|skb
comma
id|dev-&gt;hard_header_len
)paren
suffix:semicolon
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|SOCK_DEBUG
c_func
(paren
id|sk
comma
l_string|&quot;SK %p: Begin build.&bslash;n&quot;
comma
id|sk
)paren
suffix:semicolon
id|ddp
op_assign
(paren
r_struct
id|ddpehdr
op_star
)paren
id|skb_put
c_func
(paren
id|skb
comma
r_sizeof
(paren
r_struct
id|ddpehdr
)paren
)paren
suffix:semicolon
id|ddp-&gt;deh_pad
op_assign
l_int|0
suffix:semicolon
id|ddp-&gt;deh_hops
op_assign
l_int|0
suffix:semicolon
id|ddp-&gt;deh_len
op_assign
id|len
op_plus
r_sizeof
(paren
op_star
id|ddp
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Fix up the length field [Ok this is horrible but otherwise&n;&t; * I end up with unions of bit fields and messy bit field order&n;&t; * compiler/endian dependencies..&n;&t; */
op_star
(paren
(paren
id|__u16
op_star
)paren
id|ddp
)paren
op_assign
id|ntohs
c_func
(paren
op_star
(paren
(paren
id|__u16
op_star
)paren
id|ddp
)paren
)paren
suffix:semicolon
id|ddp-&gt;deh_dnet
op_assign
id|usat-&gt;sat_addr.s_net
suffix:semicolon
id|ddp-&gt;deh_snet
op_assign
id|at-&gt;src_net
suffix:semicolon
id|ddp-&gt;deh_dnode
op_assign
id|usat-&gt;sat_addr.s_node
suffix:semicolon
id|ddp-&gt;deh_snode
op_assign
id|at-&gt;src_node
suffix:semicolon
id|ddp-&gt;deh_dport
op_assign
id|usat-&gt;sat_port
suffix:semicolon
id|ddp-&gt;deh_sport
op_assign
id|at-&gt;src_port
suffix:semicolon
id|SOCK_DEBUG
c_func
(paren
id|sk
comma
l_string|&quot;SK %p: Copy user data (%Zd bytes).&bslash;n&quot;
comma
id|sk
comma
id|len
)paren
suffix:semicolon
id|err
op_assign
id|memcpy_fromiovec
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|len
)paren
comma
id|msg-&gt;msg_iov
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sk-&gt;sk_no_check
op_eq
l_int|1
)paren
id|ddp-&gt;deh_sum
op_assign
l_int|0
suffix:semicolon
r_else
id|ddp-&gt;deh_sum
op_assign
id|atalk_checksum
c_func
(paren
id|skb
comma
id|len
op_plus
r_sizeof
(paren
op_star
id|ddp
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Loopback broadcast packets to non gateway targets (ie routes&n;&t; * to group we are in)&n;&t; */
r_if
c_cond
(paren
id|ddp-&gt;deh_dnode
op_eq
id|ATADDR_BCAST
op_logical_and
op_logical_neg
(paren
id|rt-&gt;flags
op_amp
id|RTF_GATEWAY
)paren
op_logical_and
op_logical_neg
(paren
id|dev-&gt;flags
op_amp
id|IFF_LOOPBACK
)paren
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb2
op_assign
id|skb_copy
c_func
(paren
id|skb
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb2
)paren
(brace
id|loopback
op_assign
l_int|1
suffix:semicolon
id|SOCK_DEBUG
c_func
(paren
id|sk
comma
l_string|&quot;SK %p: send out(copy).&bslash;n&quot;
comma
id|sk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|aarp_send_ddp
c_func
(paren
id|dev
comma
id|skb2
comma
op_amp
id|usat-&gt;sat_addr
comma
l_int|NULL
)paren
op_eq
op_minus
l_int|1
)paren
id|kfree_skb
c_func
(paren
id|skb2
)paren
suffix:semicolon
multiline_comment|/* else queued/sent above in the aarp queue */
)brace
)brace
r_if
c_cond
(paren
id|dev-&gt;flags
op_amp
id|IFF_LOOPBACK
op_logical_or
id|loopback
)paren
(brace
id|SOCK_DEBUG
c_func
(paren
id|sk
comma
l_string|&quot;SK %p: Loop back.&bslash;n&quot;
comma
id|sk
)paren
suffix:semicolon
multiline_comment|/* loop back */
id|skb_orphan
c_func
(paren
id|skb
)paren
suffix:semicolon
id|ddp_dl
op_member_access_from_pointer
id|request
c_func
(paren
id|ddp_dl
comma
id|skb
comma
id|dev-&gt;dev_addr
)paren
suffix:semicolon
)brace
r_else
(brace
id|SOCK_DEBUG
c_func
(paren
id|sk
comma
l_string|&quot;SK %p: send out.&bslash;n&quot;
comma
id|sk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rt-&gt;flags
op_amp
id|RTF_GATEWAY
)paren
(brace
id|gsat.sat_addr
op_assign
id|rt-&gt;gateway
suffix:semicolon
id|usat
op_assign
op_amp
id|gsat
suffix:semicolon
)brace
r_if
c_cond
(paren
id|aarp_send_ddp
c_func
(paren
id|dev
comma
id|skb
comma
op_amp
id|usat-&gt;sat_addr
comma
l_int|NULL
)paren
op_eq
op_minus
l_int|1
)paren
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
multiline_comment|/* else queued/sent above in the aarp queue */
)brace
id|SOCK_DEBUG
c_func
(paren
id|sk
comma
l_string|&quot;SK %p: Done write (%Zd).&bslash;n&quot;
comma
id|sk
comma
id|len
)paren
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
DECL|function|atalk_recvmsg
r_static
r_int
id|atalk_recvmsg
c_func
(paren
r_struct
id|kiocb
op_star
id|iocb
comma
r_struct
id|socket
op_star
id|sock
comma
r_struct
id|msghdr
op_star
id|msg
comma
r_int
id|size
comma
r_int
id|flags
)paren
(brace
r_struct
id|sock
op_star
id|sk
op_assign
id|sock-&gt;sk
suffix:semicolon
r_struct
id|sockaddr_at
op_star
id|sat
op_assign
(paren
r_struct
id|sockaddr_at
op_star
)paren
id|msg-&gt;msg_name
suffix:semicolon
r_struct
id|ddpehdr
op_star
id|ddp
suffix:semicolon
r_int
id|copied
op_assign
l_int|0
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
r_struct
id|ddpebits
id|ddphv
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
op_assign
id|skb_recv_datagram
c_func
(paren
id|sk
comma
id|flags
op_amp
op_complement
id|MSG_DONTWAIT
comma
id|flags
op_amp
id|MSG_DONTWAIT
comma
op_amp
id|err
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
r_return
id|err
suffix:semicolon
multiline_comment|/* FIXME: use skb-&gt;cb to be able to use shared skbs */
id|ddp
op_assign
id|ddp_hdr
c_func
(paren
id|skb
)paren
suffix:semicolon
op_star
(paren
(paren
id|__u16
op_star
)paren
op_amp
id|ddphv
)paren
op_assign
id|ntohs
c_func
(paren
op_star
(paren
(paren
id|__u16
op_star
)paren
id|ddp
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;sk_type
op_eq
id|SOCK_RAW
)paren
(brace
id|copied
op_assign
id|ddphv.deh_len
suffix:semicolon
r_if
c_cond
(paren
id|copied
OG
id|size
)paren
(brace
id|copied
op_assign
id|size
suffix:semicolon
id|msg-&gt;msg_flags
op_or_assign
id|MSG_TRUNC
suffix:semicolon
)brace
id|err
op_assign
id|skb_copy_datagram_iovec
c_func
(paren
id|skb
comma
l_int|0
comma
id|msg-&gt;msg_iov
comma
id|copied
)paren
suffix:semicolon
)brace
r_else
(brace
id|copied
op_assign
id|ddphv.deh_len
op_minus
r_sizeof
(paren
op_star
id|ddp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copied
OG
id|size
)paren
(brace
id|copied
op_assign
id|size
suffix:semicolon
id|msg-&gt;msg_flags
op_or_assign
id|MSG_TRUNC
suffix:semicolon
)brace
id|err
op_assign
id|skb_copy_datagram_iovec
c_func
(paren
id|skb
comma
r_sizeof
(paren
op_star
id|ddp
)paren
comma
id|msg-&gt;msg_iov
comma
id|copied
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|err
)paren
(brace
r_if
c_cond
(paren
id|sat
)paren
(brace
id|sat-&gt;sat_family
op_assign
id|AF_APPLETALK
suffix:semicolon
id|sat-&gt;sat_port
op_assign
id|ddp-&gt;deh_sport
suffix:semicolon
id|sat-&gt;sat_addr.s_node
op_assign
id|ddp-&gt;deh_snode
suffix:semicolon
id|sat-&gt;sat_addr.s_net
op_assign
id|ddp-&gt;deh_snet
suffix:semicolon
)brace
id|msg-&gt;msg_namelen
op_assign
r_sizeof
(paren
op_star
id|sat
)paren
suffix:semicolon
)brace
id|skb_free_datagram
c_func
(paren
id|sk
comma
id|skb
)paren
suffix:semicolon
multiline_comment|/* Free the datagram. */
r_return
id|err
ques
c_cond
suffix:colon
id|copied
suffix:semicolon
)brace
multiline_comment|/*&n; * AppleTalk ioctl calls.&n; */
DECL|function|atalk_ioctl
r_static
r_int
id|atalk_ioctl
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_int
id|rc
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_struct
id|sock
op_star
id|sk
op_assign
id|sock-&gt;sk
suffix:semicolon
r_void
id|__user
op_star
id|argp
op_assign
(paren
r_void
id|__user
op_star
)paren
id|arg
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
multiline_comment|/* Protocol layer */
r_case
id|TIOCOUTQ
suffix:colon
(brace
r_int
id|amount
op_assign
id|sk-&gt;sk_sndbuf
op_minus
id|atomic_read
c_func
(paren
op_amp
id|sk-&gt;sk_wmem_alloc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|amount
OL
l_int|0
)paren
id|amount
op_assign
l_int|0
suffix:semicolon
id|rc
op_assign
id|put_user
c_func
(paren
id|amount
comma
(paren
r_int
id|__user
op_star
)paren
id|argp
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
id|TIOCINQ
suffix:colon
(brace
multiline_comment|/*&n;&t;&t;&t; * These two are safe on a single CPU system as only&n;&t;&t;&t; * user tasks fiddle here&n;&t;&t;&t; */
r_struct
id|sk_buff
op_star
id|skb
op_assign
id|skb_peek
c_func
(paren
op_amp
id|sk-&gt;sk_receive_queue
)paren
suffix:semicolon
r_int
id|amount
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|skb
)paren
id|amount
op_assign
id|skb-&gt;len
op_minus
r_sizeof
(paren
r_struct
id|ddpehdr
)paren
suffix:semicolon
id|rc
op_assign
id|put_user
c_func
(paren
id|amount
comma
(paren
r_int
id|__user
op_star
)paren
id|argp
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_case
id|SIOCGSTAMP
suffix:colon
id|rc
op_assign
id|sock_get_timestamp
c_func
(paren
id|sk
comma
id|argp
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* Routing */
r_case
id|SIOCADDRT
suffix:colon
r_case
id|SIOCDELRT
suffix:colon
id|rc
op_assign
op_minus
id|EPERM
suffix:semicolon
r_if
c_cond
(paren
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
id|rc
op_assign
id|atrtr_ioctl
c_func
(paren
id|cmd
comma
id|argp
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* Interface */
r_case
id|SIOCGIFADDR
suffix:colon
r_case
id|SIOCSIFADDR
suffix:colon
r_case
id|SIOCGIFBRDADDR
suffix:colon
r_case
id|SIOCATALKDIFADDR
suffix:colon
r_case
id|SIOCDIFADDR
suffix:colon
r_case
id|SIOCSARP
suffix:colon
multiline_comment|/* proxy AARP */
r_case
id|SIOCDARP
suffix:colon
multiline_comment|/* proxy AARP */
id|rtnl_lock
c_func
(paren
)paren
suffix:semicolon
id|rc
op_assign
id|atif_ioctl
c_func
(paren
id|cmd
comma
id|argp
)paren
suffix:semicolon
id|rtnl_unlock
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/* Physical layer ioctl calls */
r_case
id|SIOCSIFLINK
suffix:colon
r_case
id|SIOCGIFHWADDR
suffix:colon
r_case
id|SIOCSIFHWADDR
suffix:colon
r_case
id|SIOCGIFFLAGS
suffix:colon
r_case
id|SIOCSIFFLAGS
suffix:colon
r_case
id|SIOCGIFMTU
suffix:colon
r_case
id|SIOCGIFCONF
suffix:colon
r_case
id|SIOCADDMULTI
suffix:colon
r_case
id|SIOCDELMULTI
suffix:colon
r_case
id|SIOCGIFCOUNT
suffix:colon
r_case
id|SIOCGIFINDEX
suffix:colon
r_case
id|SIOCGIFNAME
suffix:colon
id|rc
op_assign
id|dev_ioctl
c_func
(paren
id|cmd
comma
id|argp
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|rc
suffix:semicolon
)brace
DECL|variable|atalk_family_ops
r_static
r_struct
id|net_proto_family
id|atalk_family_ops
op_assign
(brace
dot
id|family
op_assign
id|PF_APPLETALK
comma
dot
id|create
op_assign
id|atalk_create
comma
dot
id|owner
op_assign
id|THIS_MODULE
comma
)brace
suffix:semicolon
DECL|variable|atalk_dgram_ops
r_static
r_struct
id|proto_ops
id|SOCKOPS_WRAPPED
c_func
(paren
id|atalk_dgram_ops
)paren
op_assign
(brace
dot
id|family
op_assign
id|PF_APPLETALK
comma
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|release
op_assign
id|atalk_release
comma
dot
id|bind
op_assign
id|atalk_bind
comma
dot
id|connect
op_assign
id|atalk_connect
comma
dot
id|socketpair
op_assign
id|sock_no_socketpair
comma
dot
id|accept
op_assign
id|sock_no_accept
comma
dot
id|getname
op_assign
id|atalk_getname
comma
dot
id|poll
op_assign
id|datagram_poll
comma
dot
id|ioctl
op_assign
id|atalk_ioctl
comma
dot
id|listen
op_assign
id|sock_no_listen
comma
dot
id|shutdown
op_assign
id|sock_no_shutdown
comma
dot
id|setsockopt
op_assign
id|sock_no_setsockopt
comma
dot
id|getsockopt
op_assign
id|sock_no_getsockopt
comma
dot
id|sendmsg
op_assign
id|atalk_sendmsg
comma
dot
id|recvmsg
op_assign
id|atalk_recvmsg
comma
dot
id|mmap
op_assign
id|sock_no_mmap
comma
dot
id|sendpage
op_assign
id|sock_no_sendpage
comma
)brace
suffix:semicolon
macro_line|#include &lt;linux/smp_lock.h&gt;
id|SOCKOPS_WRAP
c_func
(paren
id|atalk_dgram
comma
id|PF_APPLETALK
)paren
suffix:semicolon
DECL|variable|ddp_notifier
r_static
r_struct
id|notifier_block
id|ddp_notifier
op_assign
(brace
dot
id|notifier_call
op_assign
id|ddp_device_event
comma
)brace
suffix:semicolon
DECL|variable|ltalk_packet_type
r_static
r_struct
id|packet_type
id|ltalk_packet_type
op_assign
(brace
dot
id|type
op_assign
id|__constant_htons
c_func
(paren
id|ETH_P_LOCALTALK
)paren
comma
dot
id|func
op_assign
id|ltalk_rcv
comma
)brace
suffix:semicolon
DECL|variable|ppptalk_packet_type
r_static
r_struct
id|packet_type
id|ppptalk_packet_type
op_assign
(brace
dot
id|type
op_assign
id|__constant_htons
c_func
(paren
id|ETH_P_PPPTALK
)paren
comma
dot
id|func
op_assign
id|atalk_rcv
comma
)brace
suffix:semicolon
DECL|variable|ddp_snap_id
r_static
r_int
r_char
id|ddp_snap_id
(braket
)braket
op_assign
(brace
l_int|0x08
comma
l_int|0x00
comma
l_int|0x07
comma
l_int|0x80
comma
l_int|0x9B
)brace
suffix:semicolon
multiline_comment|/* Export symbols for use by drivers when AppleTalk is a module */
DECL|variable|aarp_send_ddp
id|EXPORT_SYMBOL
c_func
(paren
id|aarp_send_ddp
)paren
suffix:semicolon
DECL|variable|atrtr_get_dev
id|EXPORT_SYMBOL
c_func
(paren
id|atrtr_get_dev
)paren
suffix:semicolon
DECL|variable|atalk_find_dev_addr
id|EXPORT_SYMBOL
c_func
(paren
id|atalk_find_dev_addr
)paren
suffix:semicolon
DECL|variable|__initdata
r_static
r_char
id|atalk_err_snap
(braket
)braket
id|__initdata
op_assign
id|KERN_CRIT
l_string|&quot;Unable to register DDP with SNAP.&bslash;n&quot;
suffix:semicolon
multiline_comment|/* Called by proto.c on kernel start up */
DECL|function|atalk_init
r_static
r_int
id|__init
id|atalk_init
c_func
(paren
r_void
)paren
(brace
(paren
r_void
)paren
id|sock_register
c_func
(paren
op_amp
id|atalk_family_ops
)paren
suffix:semicolon
id|ddp_dl
op_assign
id|register_snap_client
c_func
(paren
id|ddp_snap_id
comma
id|atalk_rcv
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ddp_dl
)paren
id|printk
c_func
(paren
id|atalk_err_snap
)paren
suffix:semicolon
id|dev_add_pack
c_func
(paren
op_amp
id|ltalk_packet_type
)paren
suffix:semicolon
id|dev_add_pack
c_func
(paren
op_amp
id|ppptalk_packet_type
)paren
suffix:semicolon
id|register_netdevice_notifier
c_func
(paren
op_amp
id|ddp_notifier
)paren
suffix:semicolon
id|aarp_proto_init
c_func
(paren
)paren
suffix:semicolon
id|atalk_proc_init
c_func
(paren
)paren
suffix:semicolon
id|atalk_register_sysctl
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|atalk_init
id|module_init
c_func
(paren
id|atalk_init
)paren
suffix:semicolon
multiline_comment|/*&n; * No explicit module reference count manipulation is needed in the&n; * protocol. Socket layer sets module reference count for us&n; * and interfaces reference counting is done&n; * by the network device layer.&n; *&n; * Ergo, before the AppleTalk module can be removed, all AppleTalk&n; * sockets be closed from user space.&n; */
DECL|function|atalk_exit
r_static
r_void
id|__exit
id|atalk_exit
c_func
(paren
r_void
)paren
(brace
macro_line|#ifdef CONFIG_SYSCTL
id|atalk_unregister_sysctl
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_SYSCTL */
id|atalk_proc_exit
c_func
(paren
)paren
suffix:semicolon
id|aarp_cleanup_module
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* General aarp clean-up. */
id|unregister_netdevice_notifier
c_func
(paren
op_amp
id|ddp_notifier
)paren
suffix:semicolon
id|dev_remove_pack
c_func
(paren
op_amp
id|ltalk_packet_type
)paren
suffix:semicolon
id|dev_remove_pack
c_func
(paren
op_amp
id|ppptalk_packet_type
)paren
suffix:semicolon
id|unregister_snap_client
c_func
(paren
id|ddp_dl
)paren
suffix:semicolon
id|sock_unregister
c_func
(paren
id|PF_APPLETALK
)paren
suffix:semicolon
)brace
DECL|variable|atalk_exit
id|module_exit
c_func
(paren
id|atalk_exit
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Alan Cox &lt;Alan.Cox@linux.org&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;AppleTalk 0.20&bslash;n&quot;
)paren
suffix:semicolon
DECL|variable|PF_APPLETALK
id|MODULE_ALIAS_NETPROTO
c_func
(paren
id|PF_APPLETALK
)paren
suffix:semicolon
eof
