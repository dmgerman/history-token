multiline_comment|/*&n; * llc_if.c - Defines LLC interface to upper layer&n; *&n; * Copyright (c) 1997 by Procom Technology, Inc.&n; * &t;&t; 2001-2003 by Arnaldo Carvalho de Melo &lt;acme@conectiva.com.br&gt;&n; *&n; * This program can be redistributed or modified under the terms of the&n; * GNU General Public License as published by the Free Software Foundation.&n; * This program is distributed without any warranty or implied warranty&n; * of merchantability or fitness for a particular purpose.&n; *&n; * See the GNU General Public License for more details.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/tcp.h&gt;
macro_line|#include &lt;asm/errno.h&gt;
macro_line|#include &lt;net/llc_if.h&gt;
macro_line|#include &lt;net/llc_sap.h&gt;
macro_line|#include &lt;net/llc_s_ev.h&gt;
macro_line|#include &lt;net/llc_conn.h&gt;
macro_line|#include &lt;net/sock.h&gt;
macro_line|#include &lt;net/llc_c_ev.h&gt;
macro_line|#include &lt;net/llc_c_ac.h&gt;
macro_line|#include &lt;net/llc_c_st.h&gt;
macro_line|#include &lt;net/llc_main.h&gt;
multiline_comment|/**&n; *&t;llc_sap_open - open interface to the upper layers.&n; *&t;@lsap: SAP number.&n; *&t;@func: rcv func for datalink protos&n; *&n; *&t;Interface function to upper layer. Each one who wants to get a SAP&n; *&t;(for example NetBEUI) should call this function. Returns the opened&n; *&t;SAP for success, NULL for failure.&n; */
DECL|function|llc_sap_open
r_struct
id|llc_sap
op_star
id|llc_sap_open
c_func
(paren
id|u8
id|lsap
comma
r_int
(paren
op_star
id|func
)paren
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|packet_type
op_star
id|pt
)paren
)paren
(brace
multiline_comment|/* verify this SAP is not already open; if so, return error */
r_struct
id|llc_sap
op_star
id|sap
suffix:semicolon
id|sap
op_assign
id|llc_sap_find
c_func
(paren
id|lsap
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sap
)paren
(brace
multiline_comment|/* SAP already exists */
id|sap
op_assign
l_int|NULL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* sap requested does not yet exist */
id|sap
op_assign
id|llc_sap_alloc
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sap
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* allocated a SAP; initialize it and clear out its memory pool */
id|sap-&gt;laddr.lsap
op_assign
id|lsap
suffix:semicolon
id|sap-&gt;rcv_func
op_assign
id|func
suffix:semicolon
id|sap-&gt;station
op_assign
op_amp
id|llc_main_station
suffix:semicolon
multiline_comment|/* initialized SAP; add it to list of SAPs this station manages */
id|llc_sap_save
c_func
(paren
id|sap
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|sap
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;llc_sap_close - close interface for upper layers.&n; *&t;@sap: SAP to be closed.&n; *&n; *&t;Close interface function to upper layer. Each one who wants to&n; *&t;close an open SAP (for example NetBEUI) should call this function.&n; */
DECL|function|llc_sap_close
r_void
id|llc_sap_close
c_func
(paren
r_struct
id|llc_sap
op_star
id|sap
)paren
(brace
id|llc_free_sap
c_func
(paren
id|sap
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;llc_build_and_send_ui_pkt - unitdata request interface for upper layers&n; *&t;@sap: sap to use&n; *&t;@skb: packet to send&n; *&t;@dmac: destination mac address&n; *&t;@dsap: destination sap&n; *&n; *&t;Upper layers calls this function when upper layer wants to send data&n; *&t;using connection-less mode communication (UI pdu).&n; *&n; *&t;Accept data frame from network layer to be sent using connection-&n; *&t;less mode communication; timeout/retries handled by network layer;&n; *&t;package primitive as an event and send to SAP event handler&n; */
DECL|function|llc_build_and_send_ui_pkt
r_void
id|llc_build_and_send_ui_pkt
c_func
(paren
r_struct
id|llc_sap
op_star
id|sap
comma
r_struct
id|sk_buff
op_star
id|skb
comma
id|u8
op_star
id|dmac
comma
id|u8
id|dsap
)paren
(brace
r_struct
id|llc_sap_state_ev
op_star
id|ev
op_assign
id|llc_sap_ev
c_func
(paren
id|skb
)paren
suffix:semicolon
id|ev-&gt;saddr.lsap
op_assign
id|sap-&gt;laddr.lsap
suffix:semicolon
id|ev-&gt;daddr.lsap
op_assign
id|dsap
suffix:semicolon
id|memcpy
c_func
(paren
id|ev-&gt;saddr.mac
comma
id|skb-&gt;dev-&gt;dev_addr
comma
id|IFHWADDRLEN
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|ev-&gt;daddr.mac
comma
id|dmac
comma
id|IFHWADDRLEN
)paren
suffix:semicolon
id|ev-&gt;type
op_assign
id|LLC_SAP_EV_TYPE_PRIM
suffix:semicolon
id|ev-&gt;prim
op_assign
id|LLC_DATAUNIT_PRIM
suffix:semicolon
id|ev-&gt;prim_type
op_assign
id|LLC_PRIM_TYPE_REQ
suffix:semicolon
id|llc_sap_state_process
c_func
(paren
id|sap
comma
id|skb
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;llc_build_and_send_test_pkt - TEST interface for upper layers.&n; *&t;@sap: sap to use&n; *&t;@skb: packet to send&n; *&t;@dmac: destination mac address&n; *&t;@dsap: destination sap&n; *&n; *&t;This function is called when upper layer wants to send a TEST pdu.&n; *&t;Returns 0 for success, 1 otherwise.&n; */
DECL|function|llc_build_and_send_test_pkt
r_void
id|llc_build_and_send_test_pkt
c_func
(paren
r_struct
id|llc_sap
op_star
id|sap
comma
r_struct
id|sk_buff
op_star
id|skb
comma
id|u8
op_star
id|dmac
comma
id|u8
id|dsap
)paren
(brace
r_struct
id|llc_sap_state_ev
op_star
id|ev
op_assign
id|llc_sap_ev
c_func
(paren
id|skb
)paren
suffix:semicolon
id|ev-&gt;saddr.lsap
op_assign
id|sap-&gt;laddr.lsap
suffix:semicolon
id|ev-&gt;daddr.lsap
op_assign
id|dsap
suffix:semicolon
id|memcpy
c_func
(paren
id|ev-&gt;saddr.mac
comma
id|skb-&gt;dev-&gt;dev_addr
comma
id|IFHWADDRLEN
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|ev-&gt;daddr.mac
comma
id|dmac
comma
id|IFHWADDRLEN
)paren
suffix:semicolon
id|ev-&gt;type
op_assign
id|LLC_SAP_EV_TYPE_PRIM
suffix:semicolon
id|ev-&gt;prim
op_assign
id|LLC_TEST_PRIM
suffix:semicolon
id|ev-&gt;prim_type
op_assign
id|LLC_PRIM_TYPE_REQ
suffix:semicolon
id|llc_sap_state_process
c_func
(paren
id|sap
comma
id|skb
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;llc_build_and_send_xid_pkt - XID interface for upper layers&n; *&t;@sap: sap to use&n; *&t;@skb: packet to send&n; *&t;@dmac: destination mac address&n; *&t;@dsap: destination sap&n; *&n; *&t;This function is called when upper layer wants to send a XID pdu.&n; *&t;Returns 0 for success, 1 otherwise.&n; */
DECL|function|llc_build_and_send_xid_pkt
r_void
id|llc_build_and_send_xid_pkt
c_func
(paren
r_struct
id|llc_sap
op_star
id|sap
comma
r_struct
id|sk_buff
op_star
id|skb
comma
id|u8
op_star
id|dmac
comma
id|u8
id|dsap
)paren
(brace
r_struct
id|llc_sap_state_ev
op_star
id|ev
op_assign
id|llc_sap_ev
c_func
(paren
id|skb
)paren
suffix:semicolon
id|ev-&gt;saddr.lsap
op_assign
id|sap-&gt;laddr.lsap
suffix:semicolon
id|ev-&gt;daddr.lsap
op_assign
id|dsap
suffix:semicolon
id|memcpy
c_func
(paren
id|ev-&gt;saddr.mac
comma
id|skb-&gt;dev-&gt;dev_addr
comma
id|IFHWADDRLEN
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|ev-&gt;daddr.mac
comma
id|dmac
comma
id|IFHWADDRLEN
)paren
suffix:semicolon
id|ev-&gt;type
op_assign
id|LLC_SAP_EV_TYPE_PRIM
suffix:semicolon
id|ev-&gt;prim
op_assign
id|LLC_XID_PRIM
suffix:semicolon
id|ev-&gt;prim_type
op_assign
id|LLC_PRIM_TYPE_REQ
suffix:semicolon
id|llc_sap_state_process
c_func
(paren
id|sap
comma
id|skb
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;llc_build_and_send_pkt - Connection data sending for upper layers.&n; *&t;@sk: connection&n; *&t;@skb: packet to send&n; *&n; *&t;This function is called when upper layer wants to send data using&n; *&t;connection oriented communication mode. During sending data, connection&n; *&t;will be locked and received frames and expired timers will be queued.&n; *&t;Returns 0 for success, -ECONNABORTED when the connection already&n; *&t;closed and -EBUSY when sending data is not permitted in this state or&n; *&t;LLC has send an I pdu with p bit set to 1 and is waiting for it&squot;s&n; *&t;response.&n; */
DECL|function|llc_build_and_send_pkt
r_int
id|llc_build_and_send_pkt
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|llc_conn_state_ev
op_star
id|ev
suffix:semicolon
r_int
id|rc
op_assign
op_minus
id|ECONNABORTED
suffix:semicolon
r_struct
id|llc_opt
op_star
id|llc
op_assign
id|llc_sk
c_func
(paren
id|sk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|llc-&gt;state
op_eq
id|LLC_CONN_STATE_ADM
)paren
r_goto
id|out
suffix:semicolon
id|rc
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_if
c_cond
(paren
id|llc_data_accept_state
c_func
(paren
id|llc-&gt;state
)paren
)paren
(brace
multiline_comment|/* data_conn_refuse */
id|llc-&gt;failed_data_req
op_assign
l_int|1
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|llc-&gt;p_flag
)paren
(brace
id|llc-&gt;failed_data_req
op_assign
l_int|1
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|ev
op_assign
id|llc_conn_ev
c_func
(paren
id|skb
)paren
suffix:semicolon
id|ev-&gt;type
op_assign
id|LLC_CONN_EV_TYPE_PRIM
suffix:semicolon
id|ev-&gt;prim
op_assign
id|LLC_DATA_PRIM
suffix:semicolon
id|ev-&gt;prim_type
op_assign
id|LLC_PRIM_TYPE_REQ
suffix:semicolon
id|skb-&gt;dev
op_assign
id|llc-&gt;dev
suffix:semicolon
id|rc
op_assign
id|llc_conn_state_process
c_func
(paren
id|sk
comma
id|skb
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;llc_establish_connection - Called by upper layer to establish a conn&n; *&t;@sk: connection&n; *&t;@lmac: local mac address&n; *&t;@dmac: destination mac address&n; *&t;@dsap: destination sap&n; *&n; *&t;Upper layer calls this to establish an LLC connection with a remote&n; *&t;machine. This function packages a proper event and sends it connection&n; *&t;component state machine. Success or failure of connection&n; *&t;establishment will inform to upper layer via calling it&squot;s confirm&n; *&t;function and passing proper information.&n; */
DECL|function|llc_establish_connection
r_int
id|llc_establish_connection
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
id|u8
op_star
id|lmac
comma
id|u8
op_star
id|dmac
comma
id|u8
id|dsap
)paren
(brace
r_int
id|rc
op_assign
op_minus
id|EISCONN
suffix:semicolon
r_struct
id|llc_addr
id|laddr
comma
id|daddr
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_struct
id|llc_opt
op_star
id|llc
op_assign
id|llc_sk
c_func
(paren
id|sk
)paren
suffix:semicolon
r_struct
id|sock
op_star
id|existing
suffix:semicolon
id|laddr.lsap
op_assign
id|llc-&gt;sap-&gt;laddr.lsap
suffix:semicolon
id|daddr.lsap
op_assign
id|dsap
suffix:semicolon
id|memcpy
c_func
(paren
id|daddr.mac
comma
id|dmac
comma
r_sizeof
(paren
id|daddr.mac
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|laddr.mac
comma
id|lmac
comma
r_sizeof
(paren
id|laddr.mac
)paren
)paren
suffix:semicolon
id|existing
op_assign
id|llc_lookup_established
c_func
(paren
id|llc-&gt;sap
comma
op_amp
id|daddr
comma
op_amp
id|laddr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|existing
)paren
(brace
r_if
c_cond
(paren
id|existing-&gt;state
op_eq
id|TCP_ESTABLISHED
)paren
(brace
id|sk
op_assign
id|existing
suffix:semicolon
r_goto
id|out_put
suffix:semicolon
)brace
r_else
id|sock_put
c_func
(paren
id|existing
)paren
suffix:semicolon
)brace
id|sock_hold
c_func
(paren
id|sk
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
id|skb
op_assign
id|alloc_skb
c_func
(paren
l_int|0
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
)paren
(brace
r_struct
id|llc_conn_state_ev
op_star
id|ev
op_assign
id|llc_conn_ev
c_func
(paren
id|skb
)paren
suffix:semicolon
id|ev-&gt;type
op_assign
id|LLC_CONN_EV_TYPE_PRIM
suffix:semicolon
id|ev-&gt;prim
op_assign
id|LLC_CONN_PRIM
suffix:semicolon
id|ev-&gt;prim_type
op_assign
id|LLC_PRIM_TYPE_REQ
suffix:semicolon
id|rc
op_assign
id|llc_conn_state_process
c_func
(paren
id|sk
comma
id|skb
)paren
suffix:semicolon
)brace
id|out_put
suffix:colon
id|sock_put
c_func
(paren
id|sk
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;llc_send_disc - Called by upper layer to close a connection&n; *&t;@sk: connection to be closed&n; *&n; *&t;Upper layer calls this when it wants to close an established LLC&n; *&t;connection with a remote machine. This function packages a proper event&n; *&t;and sends it to connection component state machine. Returns 0 for&n; *&t;success, 1 otherwise.&n; */
DECL|function|llc_send_disc
r_int
id|llc_send_disc
c_func
(paren
r_struct
id|sock
op_star
id|sk
)paren
(brace
id|u16
id|rc
op_assign
l_int|1
suffix:semicolon
r_struct
id|llc_conn_state_ev
op_star
id|ev
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|sock_hold
c_func
(paren
id|sk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;type
op_ne
id|SOCK_STREAM
op_logical_or
id|sk-&gt;state
op_ne
id|TCP_ESTABLISHED
op_logical_or
id|llc_sk
c_func
(paren
id|sk
)paren
op_member_access_from_pointer
id|state
op_eq
id|LLC_CONN_STATE_ADM
op_logical_or
id|llc_sk
c_func
(paren
id|sk
)paren
op_member_access_from_pointer
id|state
op_eq
id|LLC_CONN_OUT_OF_SVC
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/*&n;&t; * Postpone unassigning the connection from its SAP and returning the&n;&t; * connection until all ACTIONs have been completely executed&n;&t; */
id|skb
op_assign
id|alloc_skb
c_func
(paren
l_int|0
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
r_goto
id|out
suffix:semicolon
id|sk-&gt;state
op_assign
id|TCP_CLOSING
suffix:semicolon
id|ev
op_assign
id|llc_conn_ev
c_func
(paren
id|skb
)paren
suffix:semicolon
id|ev-&gt;type
op_assign
id|LLC_CONN_EV_TYPE_PRIM
suffix:semicolon
id|ev-&gt;prim
op_assign
id|LLC_DISC_PRIM
suffix:semicolon
id|ev-&gt;prim_type
op_assign
id|LLC_PRIM_TYPE_REQ
suffix:semicolon
id|rc
op_assign
id|llc_conn_state_process
c_func
(paren
id|sk
comma
id|skb
)paren
suffix:semicolon
id|out
suffix:colon
id|sock_put
c_func
(paren
id|sk
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;llc_build_and_send_reset_pkt - Resets an established LLC connection&n; *&t;@prim: pointer to structure that contains service parameters.&n; *&n; *&t;Called when upper layer wants to reset an established LLC connection&n; *&t;with a remote machine. This function packages a proper event and sends&n; *&t;it to connection component state machine. Returns 0 for success, 1&n; *&t;otherwise.&n; */
DECL|function|llc_build_and_send_reset_pkt
r_int
id|llc_build_and_send_reset_pkt
c_func
(paren
r_struct
id|sock
op_star
id|sk
)paren
(brace
r_int
id|rc
op_assign
l_int|1
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
op_assign
id|alloc_skb
c_func
(paren
l_int|0
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
)paren
(brace
r_struct
id|llc_conn_state_ev
op_star
id|ev
op_assign
id|llc_conn_ev
c_func
(paren
id|skb
)paren
suffix:semicolon
id|ev-&gt;type
op_assign
id|LLC_CONN_EV_TYPE_PRIM
suffix:semicolon
id|ev-&gt;prim
op_assign
id|LLC_RESET_PRIM
suffix:semicolon
id|ev-&gt;prim_type
op_assign
id|LLC_PRIM_TYPE_REQ
suffix:semicolon
id|rc
op_assign
id|llc_conn_state_process
c_func
(paren
id|sk
comma
id|skb
)paren
suffix:semicolon
)brace
r_return
id|rc
suffix:semicolon
)brace
DECL|variable|llc_sap_open
id|EXPORT_SYMBOL
c_func
(paren
id|llc_sap_open
)paren
suffix:semicolon
DECL|variable|llc_sap_close
id|EXPORT_SYMBOL
c_func
(paren
id|llc_sap_close
)paren
suffix:semicolon
DECL|variable|llc_build_and_send_ui_pkt
id|EXPORT_SYMBOL
c_func
(paren
id|llc_build_and_send_ui_pkt
)paren
suffix:semicolon
eof
