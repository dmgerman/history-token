multiline_comment|/*&n; * llc_if.c - Defines LLC interface to upper layer&n; *&n; * Copyright (c) 1997 by Procom Technology, Inc.&n; * &t;&t; 2001 by Arnaldo Carvalho de Melo &lt;acme@conectiva.com.br&gt;&n; *&n; * This program can be redistributed or modified under the terms of the&n; * GNU General Public License as published by the Free Software Foundation.&n; * This program is distributed without any warranty or implied warranty&n; * of merchantability or fitness for a particular purpose.&n; *&n; * See the GNU General Public License for more details.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;asm/errno.h&gt;
macro_line|#include &lt;net/llc_if.h&gt;
macro_line|#include &lt;net/llc_sap.h&gt;
macro_line|#include &lt;net/llc_s_ev.h&gt;
macro_line|#include &lt;net/llc_conn.h&gt;
macro_line|#include &lt;net/sock.h&gt;
macro_line|#include &lt;net/llc_c_ev.h&gt;
macro_line|#include &lt;net/llc_c_ac.h&gt;
macro_line|#include &lt;net/llc_c_st.h&gt;
macro_line|#include &lt;net/llc_main.h&gt;
macro_line|#include &lt;net/llc_mac.h&gt;
r_static
r_int
id|llc_sap_req
c_func
(paren
r_struct
id|llc_prim_if_block
op_star
id|prim
)paren
suffix:semicolon
r_static
r_int
id|llc_unitdata_req_handler
c_func
(paren
r_struct
id|llc_prim_if_block
op_star
id|prim
)paren
suffix:semicolon
r_static
r_int
id|llc_test_req_handler
c_func
(paren
r_struct
id|llc_prim_if_block
op_star
id|prim
)paren
suffix:semicolon
r_static
r_int
id|llc_xid_req_handler
c_func
(paren
r_struct
id|llc_prim_if_block
op_star
id|prim
)paren
suffix:semicolon
r_static
r_int
id|llc_data_req_handler
c_func
(paren
r_struct
id|llc_prim_if_block
op_star
id|prim
)paren
suffix:semicolon
r_static
r_int
id|llc_conn_req_handler
c_func
(paren
r_struct
id|llc_prim_if_block
op_star
id|prim
)paren
suffix:semicolon
r_static
r_int
id|llc_disc_req_handler
c_func
(paren
r_struct
id|llc_prim_if_block
op_star
id|prim
)paren
suffix:semicolon
r_static
r_int
id|llc_rst_req_handler
c_func
(paren
r_struct
id|llc_prim_if_block
op_star
id|prim
)paren
suffix:semicolon
r_static
r_int
id|llc_flowcontrol_req_handler
c_func
(paren
r_struct
id|llc_prim_if_block
op_star
id|prim
)paren
suffix:semicolon
r_static
r_int
id|llc_sap_resp
c_func
(paren
r_struct
id|llc_prim_if_block
op_star
id|prim
)paren
suffix:semicolon
r_static
r_int
id|llc_conn_rsp_handler
c_func
(paren
r_struct
id|llc_prim_if_block
op_star
id|prim
)paren
suffix:semicolon
r_static
r_int
id|llc_rst_rsp_handler
c_func
(paren
r_struct
id|llc_prim_if_block
op_star
id|prim
)paren
suffix:semicolon
r_static
r_int
id|llc_no_rsp_handler
c_func
(paren
r_struct
id|llc_prim_if_block
op_star
id|prim
)paren
suffix:semicolon
r_extern
r_void
id|llc_register_sap
c_func
(paren
r_int
r_char
id|sap
comma
r_int
(paren
op_star
id|rcvfunc
)paren
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|packet_type
op_star
id|pt
)paren
)paren
suffix:semicolon
r_extern
r_void
id|llc_unregister_sap
c_func
(paren
r_int
r_char
id|sap
)paren
suffix:semicolon
multiline_comment|/* table of request handler functions */
DECL|variable|llc_req_prim
r_static
id|llc_prim_call_t
id|llc_req_prim
(braket
id|LLC_NBR_PRIMITIVES
)braket
op_assign
(brace
(braket
id|LLC_DATAUNIT_PRIM
)braket
op_assign
id|llc_unitdata_req_handler
comma
(braket
id|LLC_CONN_PRIM
)braket
op_assign
id|llc_conn_req_handler
comma
(braket
id|LLC_DATA_PRIM
)braket
op_assign
id|llc_data_req_handler
comma
(braket
id|LLC_DISC_PRIM
)braket
op_assign
id|llc_disc_req_handler
comma
(braket
id|LLC_RESET_PRIM
)braket
op_assign
id|llc_rst_req_handler
comma
(braket
id|LLC_FLOWCONTROL_PRIM
)braket
op_assign
id|llc_flowcontrol_req_handler
comma
(braket
id|LLC_XID_PRIM
)braket
op_assign
id|llc_xid_req_handler
comma
(braket
id|LLC_TEST_PRIM
)braket
op_assign
id|llc_test_req_handler
comma
)brace
suffix:semicolon
multiline_comment|/* table of response handler functions */
DECL|variable|llc_resp_prim
r_static
id|llc_prim_call_t
id|llc_resp_prim
(braket
id|LLC_NBR_PRIMITIVES
)braket
op_assign
(brace
(braket
id|LLC_DATAUNIT_PRIM
)braket
op_assign
id|llc_no_rsp_handler
comma
(braket
id|LLC_CONN_PRIM
)braket
op_assign
id|llc_conn_rsp_handler
comma
(braket
id|LLC_DATA_PRIM
)braket
op_assign
id|llc_no_rsp_handler
comma
(braket
id|LLC_DISC_PRIM
)braket
op_assign
id|llc_no_rsp_handler
comma
(braket
id|LLC_RESET_PRIM
)braket
op_assign
id|llc_rst_rsp_handler
comma
(braket
id|LLC_FLOWCONTROL_PRIM
)braket
op_assign
id|llc_no_rsp_handler
comma
)brace
suffix:semicolon
multiline_comment|/**&n; *&t;llc_sap_open - open interface to the upper layers.&n; *&t;@nw_indicate: pointer to indicate function of upper layer.&n; *&t;@nw_confirm: pointer to confirm function of upper layer.&n; *&t;@lsap: SAP number.&n; *&t;@sap: pointer to allocated SAP (output argument).&n; *&n; *&t;Interface function to upper layer. each one who wants to get a SAP&n; *&t;(for example NetBEUI) should call this function. Returns 0 for&n; *&t;success, 1 for failure.&n; */
DECL|function|llc_sap_open
r_struct
id|llc_sap
op_star
id|llc_sap_open
c_func
(paren
id|llc_prim_call_t
id|nw_indicate
comma
id|llc_prim_call_t
id|nw_confirm
comma
id|u8
id|lsap
)paren
(brace
multiline_comment|/* verify this SAP is not already open; if so, return error */
r_struct
id|llc_sap
op_star
id|sap
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
id|sap
op_assign
id|llc_sap_find
c_func
(paren
id|lsap
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sap
)paren
(brace
multiline_comment|/* SAP already exists */
id|sap
op_assign
l_int|NULL
suffix:semicolon
r_goto
id|err
suffix:semicolon
)brace
multiline_comment|/* sap requested does not yet exist */
id|sap
op_assign
id|llc_sap_alloc
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sap
)paren
r_goto
id|err
suffix:semicolon
multiline_comment|/* allocated a SAP; initialize it and clear out its memory pool */
id|sap-&gt;laddr.lsap
op_assign
id|lsap
suffix:semicolon
id|sap-&gt;req
op_assign
id|llc_sap_req
suffix:semicolon
id|sap-&gt;resp
op_assign
id|llc_sap_resp
suffix:semicolon
id|sap-&gt;ind
op_assign
id|nw_indicate
suffix:semicolon
id|sap-&gt;conf
op_assign
id|nw_confirm
suffix:semicolon
id|sap-&gt;parent_station
op_assign
id|llc_station_get
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* initialized SAP; add it to list of SAPs this station manages */
id|llc_sap_save
c_func
(paren
id|sap
)paren
suffix:semicolon
id|llc_register_sap
c_func
(paren
id|lsap
comma
id|mac_indicate
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|sap
suffix:semicolon
id|err
suffix:colon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;llc_sap_close - close interface for upper layers.&n; *&t;@sap: SAP to be closed.&n; *&n; *&t;Close interface function to upper layer. each one who wants to&n; *&t;close an open SAP (for example NetBEUI) should call this function.&n; */
DECL|function|llc_sap_close
r_void
id|llc_sap_close
c_func
(paren
r_struct
id|llc_sap
op_star
id|sap
)paren
(brace
id|llc_unregister_sap
c_func
(paren
id|sap-&gt;laddr.lsap
)paren
suffix:semicolon
id|llc_free_sap
c_func
(paren
id|sap
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;llc_sap_req - Request interface for upper layers&n; *&t;@prim: pointer to structure that contains service parameters.&n; *&n; *&t;Request interface function to upper layer. each one who wants to&n; *&t;request a service from LLC, must call this function. details of&n; *&t;requested service is defined in input argument(prim).  Returns 0 for&n; *&t;success, 1 otherwise.&n; */
DECL|function|llc_sap_req
r_static
r_int
id|llc_sap_req
c_func
(paren
r_struct
id|llc_prim_if_block
op_star
id|prim
)paren
(brace
r_int
id|rc
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|prim-&gt;prim
OG
l_int|8
op_logical_or
id|prim-&gt;prim
op_eq
l_int|6
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
id|__FUNCTION__
l_string|&quot;: invalid primitive %d&bslash;n&quot;
comma
id|prim-&gt;prim
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* receive REQUEST primitive from network layer; call the appropriate&n;&t; * primitive handler which then packages it up as an event and sends it&n;&t; * to the SAP or CONNECTION event handler&n;&t; */
r_if
c_cond
(paren
id|prim-&gt;prim
OL
id|LLC_NBR_PRIMITIVES
)paren
multiline_comment|/* valid primitive; call the function to handle it */
id|rc
op_assign
id|llc_req_prim
(braket
id|prim-&gt;prim
)braket
(paren
id|prim
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;llc_unitdata_req_handler - unitdata request interface for upper layers&n; *&t;@prim: pointer to structure that contains service parameters&n; *&n; *&t;Upper layers calls this function when upper layer wants to send data&n; *&t;using connection-less mode communication (UI pdu). Returns 0 for&n; *&t;success, 1 otherwise.&n; */
DECL|function|llc_unitdata_req_handler
r_static
r_int
id|llc_unitdata_req_handler
c_func
(paren
r_struct
id|llc_prim_if_block
op_star
id|prim
)paren
(brace
r_int
id|rc
op_assign
l_int|1
suffix:semicolon
r_struct
id|llc_sap_state_ev
op_star
id|ev
suffix:semicolon
multiline_comment|/* accept data frame from network layer to be sent using connection-&n;&t; * less mode communication; timeout/retries handled by network layer;&n;&t; * package primitive as an event and send to SAP event handler&n;&t; */
r_struct
id|llc_sap
op_star
id|sap
op_assign
id|llc_sap_find
c_func
(paren
id|prim-&gt;data-&gt;udata.saddr.lsap
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sap
)paren
r_goto
id|out
suffix:semicolon
id|ev
op_assign
id|llc_sap_alloc_ev
c_func
(paren
id|sap
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ev
)paren
r_goto
id|out
suffix:semicolon
id|ev-&gt;type
op_assign
id|LLC_SAP_EV_TYPE_PRIM
suffix:semicolon
id|ev-&gt;data.prim.prim
op_assign
id|LLC_DATAUNIT_PRIM
suffix:semicolon
id|ev-&gt;data.prim.type
op_assign
id|LLC_PRIM_TYPE_REQ
suffix:semicolon
id|ev-&gt;data.prim.data
op_assign
id|prim
suffix:semicolon
id|rc
op_assign
l_int|0
suffix:semicolon
id|llc_sap_send_ev
c_func
(paren
id|sap
comma
id|ev
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;llc_test_req_handler - TEST interface for upper layers.&n; *&t;@prim: pointer to structure that contains service parameters.&n; *&n; *&t;This function is called when upper layer wants to send a TEST pdu.&n; *&t;Returns 0 for success, 1 otherwise.&n; */
DECL|function|llc_test_req_handler
r_static
r_int
id|llc_test_req_handler
c_func
(paren
r_struct
id|llc_prim_if_block
op_star
id|prim
)paren
(brace
r_int
id|rc
op_assign
l_int|1
suffix:semicolon
r_struct
id|llc_sap_state_ev
op_star
id|ev
suffix:semicolon
multiline_comment|/* package primitive as an event and send to SAP event handler */
r_struct
id|llc_sap
op_star
id|sap
op_assign
id|llc_sap_find
c_func
(paren
id|prim-&gt;data-&gt;udata.saddr.lsap
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sap
)paren
r_goto
id|out
suffix:semicolon
id|ev
op_assign
id|llc_sap_alloc_ev
c_func
(paren
id|sap
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ev
)paren
r_goto
id|out
suffix:semicolon
id|ev-&gt;type
op_assign
id|LLC_SAP_EV_TYPE_PRIM
suffix:semicolon
id|ev-&gt;data.prim.prim
op_assign
id|LLC_TEST_PRIM
suffix:semicolon
id|ev-&gt;data.prim.type
op_assign
id|LLC_PRIM_TYPE_REQ
suffix:semicolon
id|ev-&gt;data.prim.data
op_assign
id|prim
suffix:semicolon
id|rc
op_assign
l_int|0
suffix:semicolon
id|llc_sap_send_ev
c_func
(paren
id|sap
comma
id|ev
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;llc_xid_req_handler - XID interface for upper layers&n; *&t;@prim: pointer to structure that contains service parameters.&n; *&n; *&t;This function is called when upper layer wants to send a XID pdu.&n; *&t;Returns 0 for success, 1 otherwise.&n; */
DECL|function|llc_xid_req_handler
r_static
r_int
id|llc_xid_req_handler
c_func
(paren
r_struct
id|llc_prim_if_block
op_star
id|prim
)paren
(brace
r_int
id|rc
op_assign
l_int|1
suffix:semicolon
r_struct
id|llc_sap_state_ev
op_star
id|ev
suffix:semicolon
multiline_comment|/* package primitive as an event and send to SAP event handler */
r_struct
id|llc_sap
op_star
id|sap
op_assign
id|llc_sap_find
c_func
(paren
id|prim-&gt;data-&gt;udata.saddr.lsap
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sap
)paren
r_goto
id|out
suffix:semicolon
id|ev
op_assign
id|llc_sap_alloc_ev
c_func
(paren
id|sap
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ev
)paren
r_goto
id|out
suffix:semicolon
id|ev-&gt;type
op_assign
id|LLC_SAP_EV_TYPE_PRIM
suffix:semicolon
id|ev-&gt;data.prim.prim
op_assign
id|LLC_XID_PRIM
suffix:semicolon
id|ev-&gt;data.prim.type
op_assign
id|LLC_PRIM_TYPE_REQ
suffix:semicolon
id|ev-&gt;data.prim.data
op_assign
id|prim
suffix:semicolon
id|rc
op_assign
l_int|0
suffix:semicolon
id|llc_sap_send_ev
c_func
(paren
id|sap
comma
id|ev
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;llc_data_req_handler - Connection data sending for upper layers.&n; *&t;@prim: pointer to structure that contains service parameters&n; *&n; *&t;This function is called when upper layer wants to send data using&n; *&t;connection oriented communication mode. during sending data, connection&n; *&t;will be locked and received frames and expired timers will be queued.&n; *&t;Returns 0 for success, -ECONNABORTED when the connection already&n; *&t;closed. and -EBUSY when sending data is not permitted in this state or&n; *&t;LLC has send an I pdu with p bit set to 1 and is waiting for it&squot;s&n; *&t;response.&n; */
DECL|function|llc_data_req_handler
r_static
r_int
id|llc_data_req_handler
c_func
(paren
r_struct
id|llc_prim_if_block
op_star
id|prim
)paren
(brace
r_struct
id|llc_conn_state_ev
op_star
id|ev
suffix:semicolon
r_int
id|rc
op_assign
op_minus
id|ECONNABORTED
suffix:semicolon
multiline_comment|/* accept data frame from network layer to be sent using connection&n;&t; * mode communication; timeout/retries handled by this layer;&n;&t; * package primitive as an event and send to connection event handler&n;&t; */
r_struct
id|sock
op_star
id|sk
op_assign
id|prim-&gt;data-&gt;data.sk
suffix:semicolon
r_struct
id|llc_opt
op_star
id|llc
op_assign
id|llc_sk
c_func
(paren
id|sk
)paren
suffix:semicolon
id|lock_sock
c_func
(paren
id|sk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|llc-&gt;state
op_eq
id|LLC_CONN_STATE_ADM
)paren
r_goto
id|out
suffix:semicolon
id|rc
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_if
c_cond
(paren
id|llc_data_accept_state
c_func
(paren
id|llc-&gt;state
)paren
)paren
(brace
multiline_comment|/* data_conn_refuse */
id|llc-&gt;failed_data_req
op_assign
l_int|1
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|llc-&gt;p_flag
)paren
(brace
id|llc-&gt;failed_data_req
op_assign
l_int|1
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
id|ev
op_assign
id|llc_conn_alloc_ev
c_func
(paren
id|sk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ev
)paren
(brace
id|ev-&gt;type
op_assign
id|LLC_CONN_EV_TYPE_PRIM
suffix:semicolon
id|ev-&gt;data.prim.prim
op_assign
id|LLC_DATA_PRIM
suffix:semicolon
id|ev-&gt;data.prim.type
op_assign
id|LLC_PRIM_TYPE_REQ
suffix:semicolon
id|ev-&gt;data.prim.data
op_assign
id|prim
suffix:semicolon
id|prim-&gt;data-&gt;data.skb-&gt;dev
op_assign
id|llc-&gt;dev
suffix:semicolon
id|rc
op_assign
id|llc_conn_send_ev
c_func
(paren
id|sk
comma
id|ev
)paren
suffix:semicolon
)brace
id|out
suffix:colon
id|release_sock
c_func
(paren
id|sk
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;confirm_impossible - Informs upper layer about failed connection&n; *&t;@prim: pointer to structure that contains confirmation data.&n; *&n; *&t;Informs upper layer about failing in connection establishment. This&n; *&t;function is called by llc_conn_req_handler.&n; */
DECL|function|confirm_impossible
r_static
r_void
id|confirm_impossible
c_func
(paren
r_struct
id|llc_prim_if_block
op_star
id|prim
)paren
(brace
id|prim-&gt;data-&gt;conn.status
op_assign
id|LLC_STATUS_IMPOSSIBLE
suffix:semicolon
id|prim-&gt;sap
op_member_access_from_pointer
id|conf
c_func
(paren
id|prim
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;llc_conn_req_handler - Called by upper layer to establish a conn&n; *&t;@prim: pointer to structure that contains service parameters.&n; *&n; *&t;Upper layer calls this to establish an LLC connection with a remote&n; *&t;machine. this function packages a proper event and sends it connection&n; *&t;component state machine.  Success or failure of connection&n; *&t;establishment will inform to upper layer via calling it&squot;s confirm&n; *&t;function and passing proper information.&n; */
DECL|function|llc_conn_req_handler
r_static
r_int
id|llc_conn_req_handler
c_func
(paren
r_struct
id|llc_prim_if_block
op_star
id|prim
)paren
(brace
r_int
id|rc
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_struct
id|llc_opt
op_star
id|llc
suffix:semicolon
r_struct
id|llc_sap
op_star
id|sap
op_assign
id|prim-&gt;sap
suffix:semicolon
r_struct
id|llc_conn_state_ev
op_star
id|ev
suffix:semicolon
r_struct
id|net_device
op_star
id|ddev
op_assign
id|mac_dev_peer
c_func
(paren
id|prim-&gt;data-&gt;conn.dev
comma
id|prim-&gt;data-&gt;conn.dev-&gt;type
comma
id|prim-&gt;data-&gt;conn.daddr.mac
)paren
comma
op_star
id|sdev
op_assign
(paren
id|ddev-&gt;flags
op_amp
id|IFF_LOOPBACK
)paren
ques
c_cond
id|ddev
suffix:colon
id|prim-&gt;data-&gt;conn.dev
suffix:semicolon
r_struct
id|llc_addr
id|laddr
comma
id|daddr
suffix:semicolon
multiline_comment|/* network layer supplies addressing required to establish connection;&n;&t; * package as an event and send it to the connection event handler&n;&t; */
r_struct
id|sock
op_star
id|sk
suffix:semicolon
id|memcpy
c_func
(paren
id|laddr.mac
comma
id|sdev-&gt;dev_addr
comma
r_sizeof
(paren
id|laddr.mac
)paren
)paren
suffix:semicolon
id|laddr.lsap
op_assign
id|prim-&gt;data-&gt;conn.saddr.lsap
suffix:semicolon
id|memcpy
c_func
(paren
id|daddr.mac
comma
id|ddev-&gt;dev_addr
comma
r_sizeof
(paren
id|daddr.mac
)paren
)paren
suffix:semicolon
id|daddr.lsap
op_assign
id|prim-&gt;data-&gt;conn.daddr.lsap
suffix:semicolon
id|sk
op_assign
id|llc_find_sock
c_func
(paren
id|sap
comma
op_amp
id|daddr
comma
op_amp
id|laddr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sk
)paren
(brace
id|confirm_impossible
c_func
(paren
id|prim
)paren
suffix:semicolon
r_goto
id|out_put
suffix:semicolon
)brace
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
id|prim-&gt;data-&gt;conn.sk
)paren
(brace
id|sk
op_assign
id|prim-&gt;data-&gt;conn.sk
suffix:semicolon
r_if
c_cond
(paren
id|llc_sock_init
c_func
(paren
id|sk
)paren
)paren
r_goto
id|out
suffix:semicolon
)brace
r_else
(brace
id|sk
op_assign
id|llc_sock_alloc
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sk
)paren
(brace
id|confirm_impossible
c_func
(paren
id|prim
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|prim-&gt;data-&gt;conn.sk
op_assign
id|sk
suffix:semicolon
)brace
id|sock_hold
c_func
(paren
id|sk
)paren
suffix:semicolon
id|lock_sock
c_func
(paren
id|sk
)paren
suffix:semicolon
multiline_comment|/* assign new connection to it&squot;s SAP */
id|llc_sap_assign_sock
c_func
(paren
id|sap
comma
id|sk
)paren
suffix:semicolon
id|llc
op_assign
id|llc_sk
c_func
(paren
id|sk
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|llc-&gt;daddr
comma
op_amp
id|daddr
comma
r_sizeof
(paren
id|llc-&gt;daddr
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|llc-&gt;laddr
comma
op_amp
id|laddr
comma
r_sizeof
(paren
id|llc-&gt;laddr
)paren
)paren
suffix:semicolon
id|llc-&gt;dev
op_assign
id|ddev
suffix:semicolon
id|llc-&gt;link
op_assign
id|prim-&gt;data-&gt;conn.link
suffix:semicolon
id|llc-&gt;handler
op_assign
id|prim-&gt;data-&gt;conn.handler
suffix:semicolon
id|ev
op_assign
id|llc_conn_alloc_ev
c_func
(paren
id|sk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ev
)paren
(brace
id|ev-&gt;type
op_assign
id|LLC_CONN_EV_TYPE_PRIM
suffix:semicolon
id|ev-&gt;data.prim.prim
op_assign
id|LLC_CONN_PRIM
suffix:semicolon
id|ev-&gt;data.prim.type
op_assign
id|LLC_PRIM_TYPE_REQ
suffix:semicolon
id|ev-&gt;data.prim.data
op_assign
id|prim
suffix:semicolon
id|rc
op_assign
id|llc_conn_send_ev
c_func
(paren
id|sk
comma
id|ev
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rc
)paren
(brace
id|llc_sap_unassign_sock
c_func
(paren
id|sap
comma
id|sk
)paren
suffix:semicolon
id|llc_sock_free
c_func
(paren
id|sk
)paren
suffix:semicolon
id|confirm_impossible
c_func
(paren
id|prim
)paren
suffix:semicolon
)brace
id|release_sock
c_func
(paren
id|sk
)paren
suffix:semicolon
id|out_put
suffix:colon
id|sock_put
c_func
(paren
id|sk
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;llc_disc_req_handler - Called by upper layer to close a connection&n; *&t;@prim: pointer to structure that contains service parameters.&n; *&n; *&t;Upper layer calls this when it wants to close an established LLC&n; *&t;connection with a remote machine. this function packages a proper event&n; *&t;and sends it to connection component state machine. Returns 0 for&n; *&t;success, 1 otherwise.&n; */
DECL|function|llc_disc_req_handler
r_static
r_int
id|llc_disc_req_handler
c_func
(paren
r_struct
id|llc_prim_if_block
op_star
id|prim
)paren
(brace
id|u16
id|rc
op_assign
l_int|1
suffix:semicolon
r_struct
id|llc_conn_state_ev
op_star
id|ev
suffix:semicolon
r_struct
id|sock
op_star
id|sk
op_assign
id|prim-&gt;data-&gt;disc.sk
suffix:semicolon
id|sock_hold
c_func
(paren
id|sk
)paren
suffix:semicolon
id|lock_sock
c_func
(paren
id|sk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|llc_sk
c_func
(paren
id|sk
)paren
op_member_access_from_pointer
id|state
op_eq
id|LLC_CONN_STATE_ADM
op_logical_or
id|llc_sk
c_func
(paren
id|sk
)paren
op_member_access_from_pointer
id|state
op_eq
id|LLC_CONN_OUT_OF_SVC
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* postpone unassigning the connection from its SAP and returning the&n;&t; * connection until all ACTIONs have been completely executed&n;&t; */
id|ev
op_assign
id|llc_conn_alloc_ev
c_func
(paren
id|sk
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ev
)paren
r_goto
id|out
suffix:semicolon
id|ev-&gt;type
op_assign
id|LLC_CONN_EV_TYPE_PRIM
suffix:semicolon
id|ev-&gt;data.prim.prim
op_assign
id|LLC_DISC_PRIM
suffix:semicolon
id|ev-&gt;data.prim.type
op_assign
id|LLC_PRIM_TYPE_REQ
suffix:semicolon
id|ev-&gt;data.prim.data
op_assign
id|prim
suffix:semicolon
id|rc
op_assign
id|llc_conn_send_ev
c_func
(paren
id|sk
comma
id|ev
)paren
suffix:semicolon
id|out
suffix:colon
id|release_sock
c_func
(paren
id|sk
)paren
suffix:semicolon
id|sock_put
c_func
(paren
id|sk
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;llc_rst_req_handler - Resets an established LLC connection&n; *&t;@prim: pointer to structure that contains service parameters.&n; *&n; *&t;Called when upper layer wants to reset an established LLC connection&n; *&t;with a remote machine. this function packages a proper event and sends&n; *&t;it to connection component state machine. Returns 0 for success, 1&n; *&t;otherwise.&n; */
DECL|function|llc_rst_req_handler
r_static
r_int
id|llc_rst_req_handler
c_func
(paren
r_struct
id|llc_prim_if_block
op_star
id|prim
)paren
(brace
r_int
id|rc
op_assign
l_int|1
suffix:semicolon
r_struct
id|sock
op_star
id|sk
op_assign
id|prim-&gt;data-&gt;res.sk
suffix:semicolon
r_struct
id|llc_conn_state_ev
op_star
id|ev
suffix:semicolon
id|lock_sock
c_func
(paren
id|sk
)paren
suffix:semicolon
id|ev
op_assign
id|llc_conn_alloc_ev
c_func
(paren
id|sk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ev
)paren
(brace
id|ev-&gt;type
op_assign
id|LLC_CONN_EV_TYPE_PRIM
suffix:semicolon
id|ev-&gt;data.prim.prim
op_assign
id|LLC_RESET_PRIM
suffix:semicolon
id|ev-&gt;data.prim.type
op_assign
id|LLC_PRIM_TYPE_REQ
suffix:semicolon
id|ev-&gt;data.prim.data
op_assign
id|prim
suffix:semicolon
id|rc
op_assign
id|llc_conn_send_ev
c_func
(paren
id|sk
comma
id|ev
)paren
suffix:semicolon
)brace
id|release_sock
c_func
(paren
id|sk
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/* We don&squot;t support flow control. The original code from procom has&n; * some bits, but for now I&squot;m cleaning this&n; */
DECL|function|llc_flowcontrol_req_handler
r_static
r_int
id|llc_flowcontrol_req_handler
c_func
(paren
r_struct
id|llc_prim_if_block
op_star
id|prim
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;llc_sap_resp - Sends response to peer&n; *&t;@prim: pointer to structure that contains service parameters&n; *&n; *&t;This function is a interface function to upper layer. each one who&n; *&t;wants to response to an indicate can call this function via calling&n; *&t;sap_resp with proper service parameters. Returns 0 for success, 1&n; *&t;otherwise.&n; */
DECL|function|llc_sap_resp
r_static
r_int
id|llc_sap_resp
c_func
(paren
r_struct
id|llc_prim_if_block
op_star
id|prim
)paren
(brace
id|u16
id|rc
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* network layer RESPONSE primitive received; package primitive&n;&t; * as an event and send it to the connection event handler&n;&t; */
r_if
c_cond
(paren
id|prim-&gt;prim
OL
id|LLC_NBR_PRIMITIVES
)paren
multiline_comment|/* valid primitive; call the function to handle it */
id|rc
op_assign
id|llc_resp_prim
(braket
id|prim-&gt;prim
)braket
(paren
id|prim
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;llc_conn_rsp_handler - Response to connect indication&n; *&t;@prim: pointer to structure that contains response info.&n; *&n; *&t;Response to connect indication.&n; */
DECL|function|llc_conn_rsp_handler
r_static
r_int
id|llc_conn_rsp_handler
c_func
(paren
r_struct
id|llc_prim_if_block
op_star
id|prim
)paren
(brace
r_struct
id|sock
op_star
id|sk
op_assign
id|prim-&gt;data-&gt;conn.sk
suffix:semicolon
id|llc_sk
c_func
(paren
id|sk
)paren
op_member_access_from_pointer
id|link
op_assign
id|prim-&gt;data-&gt;conn.link
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;llc_rst_rsp_handler - Response to RESET indication&n; *&t;@prim: pointer to structure that contains response info&n; *&n; *&t;Returns 0 for success, 1 otherwise&n; */
DECL|function|llc_rst_rsp_handler
r_static
r_int
id|llc_rst_rsp_handler
c_func
(paren
r_struct
id|llc_prim_if_block
op_star
id|prim
)paren
(brace
r_int
id|rc
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* network layer supplies connection handle; map it to a connection;&n;&t; * package as event and send it to connection event handler&n;&t; */
r_struct
id|sock
op_star
id|sk
op_assign
id|prim-&gt;data-&gt;res.sk
suffix:semicolon
r_struct
id|llc_conn_state_ev
op_star
id|ev
op_assign
id|llc_conn_alloc_ev
c_func
(paren
id|sk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ev
)paren
(brace
id|ev-&gt;type
op_assign
id|LLC_CONN_EV_TYPE_PRIM
suffix:semicolon
id|ev-&gt;data.prim.prim
op_assign
id|LLC_RESET_PRIM
suffix:semicolon
id|ev-&gt;data.prim.type
op_assign
id|LLC_PRIM_TYPE_RESP
suffix:semicolon
id|ev-&gt;data.prim.data
op_assign
id|prim
suffix:semicolon
id|rc
op_assign
id|llc_conn_send_ev
c_func
(paren
id|sk
comma
id|ev
)paren
suffix:semicolon
)brace
r_return
id|rc
suffix:semicolon
)brace
DECL|function|llc_no_rsp_handler
r_static
r_int
id|llc_no_rsp_handler
c_func
(paren
r_struct
id|llc_prim_if_block
op_star
id|prim
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|llc_sap_open
id|EXPORT_SYMBOL
c_func
(paren
id|llc_sap_open
)paren
suffix:semicolon
DECL|variable|llc_sap_close
id|EXPORT_SYMBOL
c_func
(paren
id|llc_sap_close
)paren
suffix:semicolon
eof
