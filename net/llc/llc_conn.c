multiline_comment|/*&n; * llc_conn.c - Driver routines for connection component.&n; *&n; * Copyright (c) 1997 by Procom Technology, Inc.&n; *&t;&t; 2001-2003 by Arnaldo Carvalho de Melo &lt;acme@conectiva.com.br&gt;&n; *&n; * This program can be redistributed or modified under the terms of the&n; * GNU General Public License as published by the Free Software Foundation.&n; * This program is distributed without any warranty or implied warranty&n; * of merchantability or fitness for a particular purpose.&n; *&n; * See the GNU General Public License for more details.&n; */
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;net/llc_sap.h&gt;
macro_line|#include &lt;net/llc_conn.h&gt;
macro_line|#include &lt;net/sock.h&gt;
macro_line|#include &lt;linux/tcp.h&gt;
macro_line|#include &lt;net/llc_c_ev.h&gt;
macro_line|#include &lt;net/llc_c_ac.h&gt;
macro_line|#include &lt;net/llc_c_st.h&gt;
macro_line|#include &lt;net/llc_pdu.h&gt;
macro_line|#if 0
mdefine_line|#define dprintk(args...) printk(KERN_DEBUG args)
macro_line|#else
DECL|macro|dprintk
mdefine_line|#define dprintk(args...)
macro_line|#endif
r_static
r_int
id|llc_find_offset
c_func
(paren
r_int
id|state
comma
r_int
id|ev_type
)paren
suffix:semicolon
r_static
r_void
id|llc_conn_send_pdus
c_func
(paren
r_struct
id|sock
op_star
id|sk
)paren
suffix:semicolon
r_static
r_int
id|llc_conn_service
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
suffix:semicolon
r_static
r_int
id|llc_exec_conn_trans_actions
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_struct
id|llc_conn_state_trans
op_star
id|trans
comma
r_struct
id|sk_buff
op_star
id|ev
)paren
suffix:semicolon
r_static
r_struct
id|llc_conn_state_trans
op_star
id|llc_qualify_conn_ev
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
suffix:semicolon
multiline_comment|/* Offset table on connection states transition diagram */
DECL|variable|llc_offset_table
r_static
r_int
id|llc_offset_table
(braket
id|NBR_CONN_STATES
)braket
(braket
id|NBR_CONN_EV
)braket
suffix:semicolon
multiline_comment|/**&n; *&t;llc_conn_state_process - sends event to connection state machine&n; *&t;@sk: connection&n; *&t;@skb: occurred event&n; *&n; *&t;Sends an event to connection state machine. After processing event&n; *&t;(executing it&squot;s actions and changing state), upper layer will be&n; *&t;indicated or confirmed, if needed. Returns 0 for success, 1 for&n; *&t;failure. The socket lock has to be held before calling this function.&n; */
DECL|function|llc_conn_state_process
r_int
id|llc_conn_state_process
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_int
id|rc
suffix:semicolon
r_struct
id|llc_opt
op_star
id|llc
op_assign
id|llc_sk
c_func
(paren
id|sk
)paren
suffix:semicolon
r_struct
id|llc_conn_state_ev
op_star
id|ev
op_assign
id|llc_conn_ev
c_func
(paren
id|skb
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * We have to hold the skb, because llc_conn_service will kfree it in&n;&t; * the sending path and we need to look at the skb-&gt;cb, where we encode&n;&t; * llc_conn_state_ev.&n;&t; */
id|skb_get
c_func
(paren
id|skb
)paren
suffix:semicolon
id|ev-&gt;ind_prim
op_assign
id|ev-&gt;cfm_prim
op_assign
l_int|0
suffix:semicolon
id|rc
op_assign
id|llc_conn_service
c_func
(paren
id|sk
comma
id|skb
)paren
suffix:semicolon
multiline_comment|/* sending event to state machine */
r_if
c_cond
(paren
id|rc
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: llc_conn_service failed&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_goto
id|out_kfree_skb
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|ev-&gt;ind_prim
op_logical_and
op_logical_neg
id|ev-&gt;cfm_prim
)paren
(brace
multiline_comment|/* indicate or confirm not required */
r_if
c_cond
(paren
op_logical_neg
id|skb-&gt;list
)paren
r_goto
id|out_kfree_skb
suffix:semicolon
r_goto
id|out_skb_put
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ev-&gt;ind_prim
op_logical_and
id|ev-&gt;cfm_prim
)paren
multiline_comment|/* Paranoia */
id|skb_get
c_func
(paren
id|skb
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|ev-&gt;ind_prim
)paren
(brace
r_case
id|LLC_DATA_PRIM
suffix:colon
id|llc_save_primitive
c_func
(paren
id|skb
comma
id|LLC_DATA_PRIM
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sock_queue_rcv_skb
c_func
(paren
id|sk
comma
id|skb
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * shouldn&squot;t happen&n;&t;&t;&t; */
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: sock_queue_rcv_skb failed!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|LLC_CONN_PRIM
suffix:colon
(brace
r_struct
id|sock
op_star
id|parent
op_assign
id|skb-&gt;sk
suffix:semicolon
id|skb-&gt;sk
op_assign
id|sk
suffix:semicolon
id|skb_queue_tail
c_func
(paren
op_amp
id|parent-&gt;sk_receive_queue
comma
id|skb
)paren
suffix:semicolon
id|sk
op_member_access_from_pointer
id|sk_state_change
c_func
(paren
id|parent
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|LLC_DISC_PRIM
suffix:colon
id|sock_hold
c_func
(paren
id|sk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;sk_type
op_eq
id|SOCK_STREAM
op_logical_and
id|sk-&gt;sk_state
op_eq
id|TCP_ESTABLISHED
)paren
(brace
id|sk-&gt;sk_shutdown
op_assign
id|SHUTDOWN_MASK
suffix:semicolon
id|sk-&gt;sk_socket-&gt;state
op_assign
id|SS_UNCONNECTED
suffix:semicolon
id|sk-&gt;sk_state
op_assign
id|TCP_CLOSE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sock_flag
c_func
(paren
id|sk
comma
id|SOCK_DEAD
)paren
)paren
(brace
id|sk
op_member_access_from_pointer
id|sk_state_change
c_func
(paren
id|sk
)paren
suffix:semicolon
id|sock_set_flag
c_func
(paren
id|sk
comma
id|SOCK_DEAD
)paren
suffix:semicolon
)brace
)brace
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|sock_put
c_func
(paren
id|sk
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LLC_RESET_PRIM
suffix:colon
multiline_comment|/*&n;&t;&t; * FIXME:&n;&t;&t; * RESET is not being notified to upper layers for now&n;&t;&t; */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: received a reset ind!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
r_if
c_cond
(paren
id|ev-&gt;ind_prim
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: received unknown %d prim!&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|ev-&gt;ind_prim
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
multiline_comment|/* No indication */
r_break
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|ev-&gt;cfm_prim
)paren
(brace
r_case
id|LLC_DATA_PRIM
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|llc_data_accept_state
c_func
(paren
id|llc-&gt;state
)paren
)paren
id|sk
op_member_access_from_pointer
id|sk_write_space
c_func
(paren
id|sk
)paren
suffix:semicolon
r_else
id|rc
op_assign
id|llc-&gt;failed_data_req
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LLC_CONN_PRIM
suffix:colon
r_if
c_cond
(paren
id|sk-&gt;sk_type
op_eq
id|SOCK_STREAM
op_logical_and
id|sk-&gt;sk_state
op_eq
id|TCP_SYN_SENT
)paren
(brace
r_if
c_cond
(paren
id|ev-&gt;status
)paren
(brace
id|sk-&gt;sk_socket-&gt;state
op_assign
id|SS_UNCONNECTED
suffix:semicolon
id|sk-&gt;sk_state
op_assign
id|TCP_CLOSE
suffix:semicolon
)brace
r_else
(brace
id|sk-&gt;sk_socket-&gt;state
op_assign
id|SS_CONNECTED
suffix:semicolon
id|sk-&gt;sk_state
op_assign
id|TCP_ESTABLISHED
suffix:semicolon
)brace
id|sk
op_member_access_from_pointer
id|sk_state_change
c_func
(paren
id|sk
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|LLC_DISC_PRIM
suffix:colon
id|sock_hold
c_func
(paren
id|sk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;sk_type
op_eq
id|SOCK_STREAM
op_logical_and
id|sk-&gt;sk_state
op_eq
id|TCP_CLOSING
)paren
(brace
id|sk-&gt;sk_socket-&gt;state
op_assign
id|SS_UNCONNECTED
suffix:semicolon
id|sk-&gt;sk_state
op_assign
id|TCP_CLOSE
suffix:semicolon
id|sk
op_member_access_from_pointer
id|sk_state_change
c_func
(paren
id|sk
)paren
suffix:semicolon
)brace
id|sock_put
c_func
(paren
id|sk
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LLC_RESET_PRIM
suffix:colon
multiline_comment|/*&n;&t;&t; * FIXME:&n;&t;&t; * RESET is not being notified to upper layers for now&n;&t;&t; */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: received a reset conf!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
r_if
c_cond
(paren
id|ev-&gt;cfm_prim
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: received unknown %d prim!&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|ev-&gt;cfm_prim
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_goto
id|out_skb_put
suffix:semicolon
multiline_comment|/* No confirmation */
)brace
id|out_kfree_skb
suffix:colon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|out_skb_put
suffix:colon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|llc_conn_send_pdu
r_void
id|llc_conn_send_pdu
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
multiline_comment|/* queue PDU to send to MAC layer */
id|skb_queue_tail
c_func
(paren
op_amp
id|sk-&gt;sk_write_queue
comma
id|skb
)paren
suffix:semicolon
id|llc_conn_send_pdus
c_func
(paren
id|sk
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;llc_conn_rtn_pdu - sends received data pdu to upper layer&n; *&t;@sk: Active connection&n; *&t;@skb: Received data frame&n; *&n; *&t;Sends received data pdu to upper layer (by using indicate function).&n; *&t;Prepares service parameters (prim and prim_data). calling indication&n; *&t;function will be done in llc_conn_state_process.&n; */
DECL|function|llc_conn_rtn_pdu
r_void
id|llc_conn_rtn_pdu
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|llc_conn_state_ev
op_star
id|ev
op_assign
id|llc_conn_ev
c_func
(paren
id|skb
)paren
suffix:semicolon
id|ev-&gt;ind_prim
op_assign
id|LLC_DATA_PRIM
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;llc_conn_resend_i_pdu_as_cmd - resend all all unacknowledged I PDUs&n; *&t;@sk: active connection&n; *&t;@nr: NR&n; *&t;@first_p_bit: p_bit value of first pdu&n; *&n; *&t;Resend all unacknowledged I PDUs, starting with the NR; send first as&n; *&t;command PDU with P bit equal first_p_bit; if more than one send&n; *&t;subsequent as command PDUs with P bit equal zero (0).&n; */
DECL|function|llc_conn_resend_i_pdu_as_cmd
r_void
id|llc_conn_resend_i_pdu_as_cmd
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
id|u8
id|nr
comma
id|u8
id|first_p_bit
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_struct
id|llc_pdu_sn
op_star
id|pdu
suffix:semicolon
id|u16
id|nbr_unack_pdus
suffix:semicolon
r_struct
id|llc_opt
op_star
id|llc
suffix:semicolon
id|u8
id|howmany_resend
op_assign
l_int|0
suffix:semicolon
id|llc_conn_remove_acked_pdus
c_func
(paren
id|sk
comma
id|nr
comma
op_amp
id|nbr_unack_pdus
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|nbr_unack_pdus
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/*&n;&t; * Process unack PDUs only if unack queue is not empty; remove&n;&t; * appropriate PDUs, fix them up, and put them on mac_pdu_q.&n;&t; */
id|llc
op_assign
id|llc_sk
c_func
(paren
id|sk
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|llc-&gt;pdu_unack_q
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|pdu
op_assign
id|llc_pdu_sn_hdr
c_func
(paren
id|skb
)paren
suffix:semicolon
id|llc_pdu_set_cmd_rsp
c_func
(paren
id|skb
comma
id|LLC_PDU_CMD
)paren
suffix:semicolon
id|llc_pdu_set_pf_bit
c_func
(paren
id|skb
comma
id|first_p_bit
)paren
suffix:semicolon
id|skb_queue_tail
c_func
(paren
op_amp
id|sk-&gt;sk_write_queue
comma
id|skb
)paren
suffix:semicolon
id|first_p_bit
op_assign
l_int|0
suffix:semicolon
id|llc-&gt;vS
op_assign
id|LLC_I_GET_NS
c_func
(paren
id|pdu
)paren
suffix:semicolon
id|howmany_resend
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|howmany_resend
OG
l_int|0
)paren
id|llc-&gt;vS
op_assign
(paren
id|llc-&gt;vS
op_plus
l_int|1
)paren
op_mod
id|LLC_2_SEQ_NBR_MODULO
suffix:semicolon
multiline_comment|/* any PDUs to re-send are queued up; start sending to MAC */
id|llc_conn_send_pdus
c_func
(paren
id|sk
)paren
suffix:semicolon
id|out
suffix:colon
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;llc_conn_resend_i_pdu_as_rsp - Resend all unacknowledged I PDUs&n; *&t;@sk: active connection.&n; *&t;@nr: NR&n; *&t;@first_f_bit: f_bit value of first pdu.&n; *&n; *&t;Resend all unacknowledged I PDUs, starting with the NR; send first as&n; *&t;response PDU with F bit equal first_f_bit; if more than one send&n; *&t;subsequent as response PDUs with F bit equal zero (0).&n; */
DECL|function|llc_conn_resend_i_pdu_as_rsp
r_void
id|llc_conn_resend_i_pdu_as_rsp
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
id|u8
id|nr
comma
id|u8
id|first_f_bit
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|u16
id|nbr_unack_pdus
suffix:semicolon
r_struct
id|llc_opt
op_star
id|llc
op_assign
id|llc_sk
c_func
(paren
id|sk
)paren
suffix:semicolon
id|u8
id|howmany_resend
op_assign
l_int|0
suffix:semicolon
id|llc_conn_remove_acked_pdus
c_func
(paren
id|sk
comma
id|nr
comma
op_amp
id|nbr_unack_pdus
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|nbr_unack_pdus
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/*&n;&t; * Process unack PDUs only if unack queue is not empty; remove&n;&t; * appropriate PDUs, fix them up, and put them on mac_pdu_q&n;&t; */
r_while
c_loop
(paren
(paren
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|llc-&gt;pdu_unack_q
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
r_struct
id|llc_pdu_sn
op_star
id|pdu
op_assign
id|llc_pdu_sn_hdr
c_func
(paren
id|skb
)paren
suffix:semicolon
id|llc_pdu_set_cmd_rsp
c_func
(paren
id|skb
comma
id|LLC_PDU_RSP
)paren
suffix:semicolon
id|llc_pdu_set_pf_bit
c_func
(paren
id|skb
comma
id|first_f_bit
)paren
suffix:semicolon
id|skb_queue_tail
c_func
(paren
op_amp
id|sk-&gt;sk_write_queue
comma
id|skb
)paren
suffix:semicolon
id|first_f_bit
op_assign
l_int|0
suffix:semicolon
id|llc-&gt;vS
op_assign
id|LLC_I_GET_NS
c_func
(paren
id|pdu
)paren
suffix:semicolon
id|howmany_resend
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|howmany_resend
OG
l_int|0
)paren
id|llc-&gt;vS
op_assign
(paren
id|llc-&gt;vS
op_plus
l_int|1
)paren
op_mod
id|LLC_2_SEQ_NBR_MODULO
suffix:semicolon
multiline_comment|/* any PDUs to re-send are queued up; start sending to MAC */
id|llc_conn_send_pdus
c_func
(paren
id|sk
)paren
suffix:semicolon
id|out
suffix:colon
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;llc_conn_remove_acked_pdus - Removes acknowledged pdus from tx queue&n; *&t;@sk: active connection&n; *&t;nr: NR&n; *&t;how_many_unacked: size of pdu_unack_q after removing acked pdus&n; *&n; *&t;Removes acknowledged pdus from transmit queue (pdu_unack_q). Returns&n; *&t;the number of pdus that removed from queue.&n; */
DECL|function|llc_conn_remove_acked_pdus
r_int
id|llc_conn_remove_acked_pdus
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
id|u8
id|nr
comma
id|u16
op_star
id|how_many_unacked
)paren
(brace
r_int
id|pdu_pos
comma
id|i
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_struct
id|llc_pdu_sn
op_star
id|pdu
suffix:semicolon
r_int
id|nbr_acked
op_assign
l_int|0
suffix:semicolon
r_struct
id|llc_opt
op_star
id|llc
op_assign
id|llc_sk
c_func
(paren
id|sk
)paren
suffix:semicolon
r_int
id|q_len
op_assign
id|skb_queue_len
c_func
(paren
op_amp
id|llc-&gt;pdu_unack_q
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|q_len
)paren
r_goto
id|out
suffix:semicolon
id|skb
op_assign
id|skb_peek
c_func
(paren
op_amp
id|llc-&gt;pdu_unack_q
)paren
suffix:semicolon
id|pdu
op_assign
id|llc_pdu_sn_hdr
c_func
(paren
id|skb
)paren
suffix:semicolon
multiline_comment|/* finding position of last acked pdu in queue */
id|pdu_pos
op_assign
(paren
(paren
r_int
)paren
id|LLC_2_SEQ_NBR_MODULO
op_plus
(paren
r_int
)paren
id|nr
op_minus
(paren
r_int
)paren
id|LLC_I_GET_NS
c_func
(paren
id|pdu
)paren
)paren
op_mod
id|LLC_2_SEQ_NBR_MODULO
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|pdu_pos
op_logical_and
id|i
OL
id|q_len
suffix:semicolon
id|i
op_increment
)paren
(brace
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|llc-&gt;pdu_unack_q
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
)paren
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|nbr_acked
op_increment
suffix:semicolon
)brace
id|out
suffix:colon
op_star
id|how_many_unacked
op_assign
id|skb_queue_len
c_func
(paren
op_amp
id|llc-&gt;pdu_unack_q
)paren
suffix:semicolon
r_return
id|nbr_acked
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;llc_conn_send_pdus - Sends queued PDUs&n; *&t;@sk: active connection&n; *&n; *&t;Sends queued pdus to MAC layer for transmission.&n; */
DECL|function|llc_conn_send_pdus
r_static
r_void
id|llc_conn_send_pdus
c_func
(paren
r_struct
id|sock
op_star
id|sk
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_while
c_loop
(paren
(paren
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|sk-&gt;sk_write_queue
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
r_struct
id|llc_pdu_sn
op_star
id|pdu
op_assign
id|llc_pdu_sn_hdr
c_func
(paren
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|LLC_PDU_TYPE_IS_I
c_func
(paren
id|pdu
)paren
op_logical_and
op_logical_neg
(paren
id|skb-&gt;dev-&gt;flags
op_amp
id|IFF_LOOPBACK
)paren
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb2
op_assign
id|skb_clone
c_func
(paren
id|skb
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
id|skb_queue_tail
c_func
(paren
op_amp
id|llc_sk
c_func
(paren
id|sk
)paren
op_member_access_from_pointer
id|pdu_unack_q
comma
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb2
)paren
r_break
suffix:semicolon
id|skb
op_assign
id|skb2
suffix:semicolon
)brace
id|dev_queue_xmit
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/**&n; *&t;llc_conn_service - finds transition and changes state of connection&n; *&t;@sk: connection&n; *&t;@skb: happened event&n; *&n; *&t;This function finds transition that matches with happened event, then&n; *&t;executes related actions and finally changes state of connection.&n; *&t;Returns 0 for success, 1 for failure.&n; */
DECL|function|llc_conn_service
r_static
r_int
id|llc_conn_service
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_int
id|rc
op_assign
l_int|1
suffix:semicolon
r_struct
id|llc_opt
op_star
id|llc
op_assign
id|llc_sk
c_func
(paren
id|sk
)paren
suffix:semicolon
r_struct
id|llc_conn_state_trans
op_star
id|trans
suffix:semicolon
r_if
c_cond
(paren
id|llc-&gt;state
OG
id|NBR_CONN_STATES
)paren
r_goto
id|out
suffix:semicolon
id|rc
op_assign
l_int|0
suffix:semicolon
id|trans
op_assign
id|llc_qualify_conn_ev
c_func
(paren
id|sk
comma
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|trans
)paren
(brace
id|rc
op_assign
id|llc_exec_conn_trans_actions
c_func
(paren
id|sk
comma
id|trans
comma
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rc
op_logical_and
id|trans-&gt;next_state
op_ne
id|NO_STATE_CHANGE
)paren
(brace
id|llc-&gt;state
op_assign
id|trans-&gt;next_state
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|llc_data_accept_state
c_func
(paren
id|llc-&gt;state
)paren
)paren
id|sk
op_member_access_from_pointer
id|sk_state_change
c_func
(paren
id|sk
)paren
suffix:semicolon
)brace
)brace
id|out
suffix:colon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;llc_qualify_conn_ev - finds transition for event&n; *&t;@sk: connection&n; *&t;@skb: happened event&n; *&n; *&t;This function finds transition that matches with happened event.&n; *&t;Returns pointer to found transition on success, %NULL otherwise.&n; */
DECL|function|llc_qualify_conn_ev
r_static
r_struct
id|llc_conn_state_trans
op_star
id|llc_qualify_conn_ev
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|llc_conn_state_trans
op_star
op_star
id|next_trans
suffix:semicolon
id|llc_conn_ev_qfyr_t
op_star
id|next_qualifier
suffix:semicolon
r_struct
id|llc_conn_state_ev
op_star
id|ev
op_assign
id|llc_conn_ev
c_func
(paren
id|skb
)paren
suffix:semicolon
r_struct
id|llc_opt
op_star
id|llc
op_assign
id|llc_sk
c_func
(paren
id|sk
)paren
suffix:semicolon
r_struct
id|llc_conn_state
op_star
id|curr_state
op_assign
op_amp
id|llc_conn_state_table
(braket
id|llc-&gt;state
op_minus
l_int|1
)braket
suffix:semicolon
multiline_comment|/* search thru events for this state until&n;&t; * list exhausted or until no more&n;&t; */
r_for
c_loop
(paren
id|next_trans
op_assign
id|curr_state-&gt;transitions
op_plus
id|llc_find_offset
c_func
(paren
id|llc-&gt;state
op_minus
l_int|1
comma
id|ev-&gt;type
)paren
suffix:semicolon
(paren
op_star
id|next_trans
)paren
op_member_access_from_pointer
id|ev
suffix:semicolon
id|next_trans
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
(paren
op_star
id|next_trans
)paren
op_member_access_from_pointer
id|ev
)paren
(paren
id|sk
comma
id|skb
)paren
)paren
(brace
multiline_comment|/* got POSSIBLE event match; the event may require&n;&t;&t;&t; * qualification based on the values of a number of&n;&t;&t;&t; * state flags; if all qualifications are met (i.e.,&n;&t;&t;&t; * if all qualifying functions return success, or 0,&n;&t;&t;&t; * then this is THE event we&squot;re looking for&n;&t;&t;&t; */
r_for
c_loop
(paren
id|next_qualifier
op_assign
(paren
op_star
id|next_trans
)paren
op_member_access_from_pointer
id|ev_qualifiers
suffix:semicolon
id|next_qualifier
op_logical_and
op_star
id|next_qualifier
op_logical_and
op_logical_neg
(paren
op_star
id|next_qualifier
)paren
(paren
id|sk
comma
id|skb
)paren
suffix:semicolon
id|next_qualifier
op_increment
)paren
multiline_comment|/* nothing */
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|next_qualifier
op_logical_or
op_logical_neg
op_star
id|next_qualifier
)paren
multiline_comment|/* all qualifiers executed successfully; this is&n;&t;&t;&t;&t; * our transition; return it so we can perform&n;&t;&t;&t;&t; * the associated actions &amp; change the state&n;&t;&t;&t;&t; */
r_return
op_star
id|next_trans
suffix:semicolon
)brace
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;llc_exec_conn_trans_actions - executes related actions&n; *&t;@sk: connection&n; *&t;@trans: transition that it&squot;s actions must be performed&n; *&t;@skb: event&n; *&n; *&t;Executes actions that is related to happened event. Returns 0 for&n; *&t;success, 1 to indicate failure of at least one action.&n; */
DECL|function|llc_exec_conn_trans_actions
r_static
r_int
id|llc_exec_conn_trans_actions
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_struct
id|llc_conn_state_trans
op_star
id|trans
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|llc_conn_action_t
op_star
id|next_action
suffix:semicolon
r_for
c_loop
(paren
id|next_action
op_assign
id|trans-&gt;ev_actions
suffix:semicolon
id|next_action
op_logical_and
op_star
id|next_action
suffix:semicolon
id|next_action
op_increment
)paren
(brace
r_int
id|rc2
op_assign
(paren
op_star
id|next_action
)paren
(paren
id|sk
comma
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc2
op_eq
l_int|2
)paren
(brace
id|rc
op_assign
id|rc2
suffix:semicolon
r_break
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|rc2
)paren
id|rc
op_assign
l_int|1
suffix:semicolon
)brace
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;llc_lookup_established - Finds connection for the remote/local sap/mac&n; *&t;@sap: SAP&n; *&t;@daddr: address of remote LLC (MAC + SAP)&n; *&t;@laddr: address of local LLC (MAC + SAP)&n; *&n; *&t;Search connection list of the SAP and finds connection using the remote&n; *&t;mac, remote sap, local mac, and local sap. Returns pointer for&n; *&t;connection found, %NULL otherwise.&n; */
DECL|function|llc_lookup_established
r_struct
id|sock
op_star
id|llc_lookup_established
c_func
(paren
r_struct
id|llc_sap
op_star
id|sap
comma
r_struct
id|llc_addr
op_star
id|daddr
comma
r_struct
id|llc_addr
op_star
id|laddr
)paren
(brace
r_struct
id|sock
op_star
id|rc
suffix:semicolon
r_struct
id|hlist_node
op_star
id|node
suffix:semicolon
id|read_lock_bh
c_func
(paren
op_amp
id|sap-&gt;sk_list.lock
)paren
suffix:semicolon
id|sk_for_each
c_func
(paren
id|rc
comma
id|node
comma
op_amp
id|sap-&gt;sk_list.list
)paren
(brace
r_struct
id|llc_opt
op_star
id|llc
op_assign
id|llc_sk
c_func
(paren
id|rc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|llc-&gt;laddr.lsap
op_eq
id|laddr-&gt;lsap
op_logical_and
id|llc-&gt;daddr.lsap
op_eq
id|daddr-&gt;lsap
op_logical_and
id|llc_mac_match
c_func
(paren
id|llc-&gt;laddr.mac
comma
id|laddr-&gt;mac
)paren
op_logical_and
id|llc_mac_match
c_func
(paren
id|llc-&gt;daddr.mac
comma
id|daddr-&gt;mac
)paren
)paren
(brace
id|sock_hold
c_func
(paren
id|rc
)paren
suffix:semicolon
r_goto
id|found
suffix:semicolon
)brace
)brace
id|rc
op_assign
l_int|NULL
suffix:semicolon
id|found
suffix:colon
id|read_unlock_bh
c_func
(paren
op_amp
id|sap-&gt;sk_list.lock
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;llc_lookup_listener - Finds listener for local MAC + SAP&n; *&t;@sap: SAP&n; *&t;@laddr: address of local LLC (MAC + SAP)&n; *&n; *&t;Search connection list of the SAP and finds connection listening on&n; *&t;local mac, and local sap. Returns pointer for parent socket found,&n; *&t;%NULL otherwise.&n; */
DECL|function|llc_lookup_listener
r_static
r_struct
id|sock
op_star
id|llc_lookup_listener
c_func
(paren
r_struct
id|llc_sap
op_star
id|sap
comma
r_struct
id|llc_addr
op_star
id|laddr
)paren
(brace
r_struct
id|sock
op_star
id|rc
suffix:semicolon
r_struct
id|hlist_node
op_star
id|node
suffix:semicolon
id|read_lock_bh
c_func
(paren
op_amp
id|sap-&gt;sk_list.lock
)paren
suffix:semicolon
id|sk_for_each
c_func
(paren
id|rc
comma
id|node
comma
op_amp
id|sap-&gt;sk_list.list
)paren
(brace
r_struct
id|llc_opt
op_star
id|llc
op_assign
id|llc_sk
c_func
(paren
id|rc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc-&gt;sk_type
op_eq
id|SOCK_STREAM
op_logical_and
id|rc-&gt;sk_state
op_eq
id|TCP_LISTEN
op_logical_and
id|llc-&gt;laddr.lsap
op_eq
id|laddr-&gt;lsap
op_logical_and
(paren
id|llc_mac_match
c_func
(paren
id|llc-&gt;laddr.mac
comma
id|laddr-&gt;mac
)paren
op_logical_or
id|llc_mac_null
c_func
(paren
id|llc-&gt;laddr.mac
)paren
)paren
)paren
(brace
id|sock_hold
c_func
(paren
id|rc
)paren
suffix:semicolon
r_goto
id|found
suffix:semicolon
)brace
)brace
id|rc
op_assign
l_int|NULL
suffix:semicolon
id|found
suffix:colon
id|read_unlock_bh
c_func
(paren
op_amp
id|sap-&gt;sk_list.lock
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;llc_data_accept_state - designates if in this state data can be sent.&n; *&t;@state: state of connection.&n; *&n; *&t;Returns 0 if data can be sent, 1 otherwise.&n; */
DECL|function|llc_data_accept_state
id|u8
id|llc_data_accept_state
c_func
(paren
id|u8
id|state
)paren
(brace
r_return
id|state
op_ne
id|LLC_CONN_STATE_NORMAL
op_logical_and
id|state
op_ne
id|LLC_CONN_STATE_BUSY
op_logical_and
id|state
op_ne
id|LLC_CONN_STATE_REJ
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;find_next_offset - finds offset for next category of transitions&n; *&t;@state: state table.&n; *&t;@offset: start offset.&n; *&n; *&t;Finds offset of next category of transitions in transition table.&n; *&t;Returns the start index of next category.&n; */
DECL|function|find_next_offset
r_static
id|u16
id|find_next_offset
c_func
(paren
r_struct
id|llc_conn_state
op_star
id|state
comma
id|u16
id|offset
)paren
(brace
id|u16
id|cnt
op_assign
l_int|0
suffix:semicolon
r_struct
id|llc_conn_state_trans
op_star
op_star
id|next_trans
suffix:semicolon
r_for
c_loop
(paren
id|next_trans
op_assign
id|state-&gt;transitions
op_plus
id|offset
suffix:semicolon
(paren
op_star
id|next_trans
)paren
op_member_access_from_pointer
id|ev
suffix:semicolon
id|next_trans
op_increment
)paren
op_increment
id|cnt
suffix:semicolon
r_return
id|cnt
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;llc_build_offset_table - builds offset table of connection&n; *&n; *&t;Fills offset table of connection state transition table&n; *&t;(llc_offset_table).&n; */
DECL|function|llc_build_offset_table
r_void
id|__init
id|llc_build_offset_table
c_func
(paren
r_void
)paren
(brace
r_struct
id|llc_conn_state
op_star
id|curr_state
suffix:semicolon
r_int
id|state
comma
id|ev_type
comma
id|next_offset
suffix:semicolon
r_for
c_loop
(paren
id|state
op_assign
l_int|0
suffix:semicolon
id|state
OL
id|NBR_CONN_STATES
suffix:semicolon
id|state
op_increment
)paren
(brace
id|curr_state
op_assign
op_amp
id|llc_conn_state_table
(braket
id|state
)braket
suffix:semicolon
id|next_offset
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|ev_type
op_assign
l_int|0
suffix:semicolon
id|ev_type
OL
id|NBR_CONN_EV
suffix:semicolon
id|ev_type
op_increment
)paren
(brace
id|llc_offset_table
(braket
id|state
)braket
(braket
id|ev_type
)braket
op_assign
id|next_offset
suffix:semicolon
id|next_offset
op_add_assign
id|find_next_offset
c_func
(paren
id|curr_state
comma
id|next_offset
)paren
op_plus
l_int|1
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/**&n; *&t;llc_find_offset - finds start offset of category of transitions&n; *&t;@state: state of connection&n; *&t;@ev_type: type of happened event&n; *&n; *&t;Finds start offset of desired category of transitions. Returns the&n; *&t;desired start offset.&n; */
DECL|function|llc_find_offset
r_static
r_int
id|llc_find_offset
c_func
(paren
r_int
id|state
comma
r_int
id|ev_type
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* at this stage, llc_offset_table[..][2] is not important. it is for&n;&t; * init_pf_cycle and I don&squot;t know what is it.&n;&t; */
r_switch
c_cond
(paren
id|ev_type
)paren
(brace
r_case
id|LLC_CONN_EV_TYPE_PRIM
suffix:colon
id|rc
op_assign
id|llc_offset_table
(braket
id|state
)braket
(braket
l_int|0
)braket
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LLC_CONN_EV_TYPE_PDU
suffix:colon
id|rc
op_assign
id|llc_offset_table
(braket
id|state
)braket
(braket
l_int|4
)braket
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LLC_CONN_EV_TYPE_SIMPLE
suffix:colon
id|rc
op_assign
id|llc_offset_table
(braket
id|state
)braket
(braket
l_int|1
)braket
suffix:semicolon
r_break
suffix:semicolon
r_case
id|LLC_CONN_EV_TYPE_P_TMR
suffix:colon
r_case
id|LLC_CONN_EV_TYPE_ACK_TMR
suffix:colon
r_case
id|LLC_CONN_EV_TYPE_REJ_TMR
suffix:colon
r_case
id|LLC_CONN_EV_TYPE_BUSY_TMR
suffix:colon
id|rc
op_assign
id|llc_offset_table
(braket
id|state
)braket
(braket
l_int|3
)braket
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;llc_sap_add_socket - adds a socket to a SAP&n; *&t;@sap: SAP&n; *&t;@sk: socket&n; *&n; *&t;This function adds a socket to sk_list of a SAP.&n; */
DECL|function|llc_sap_add_socket
r_void
id|llc_sap_add_socket
c_func
(paren
r_struct
id|llc_sap
op_star
id|sap
comma
r_struct
id|sock
op_star
id|sk
)paren
(brace
id|write_lock_bh
c_func
(paren
op_amp
id|sap-&gt;sk_list.lock
)paren
suffix:semicolon
id|llc_sk
c_func
(paren
id|sk
)paren
op_member_access_from_pointer
id|sap
op_assign
id|sap
suffix:semicolon
id|sk_add_node
c_func
(paren
id|sk
comma
op_amp
id|sap-&gt;sk_list.list
)paren
suffix:semicolon
id|write_unlock_bh
c_func
(paren
op_amp
id|sap-&gt;sk_list.lock
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;llc_sap_remove_socket - removes a socket from SAP&n; *&t;@sap: SAP&n; *&t;@sk: socket&n; *&n; *&t;This function removes a connection from sk_list.list of a SAP if&n; *&t;the connection was in this list.&n; */
DECL|function|llc_sap_remove_socket
r_void
id|llc_sap_remove_socket
c_func
(paren
r_struct
id|llc_sap
op_star
id|sap
comma
r_struct
id|sock
op_star
id|sk
)paren
(brace
id|write_lock_bh
c_func
(paren
op_amp
id|sap-&gt;sk_list.lock
)paren
suffix:semicolon
id|sk_del_node_init
c_func
(paren
id|sk
)paren
suffix:semicolon
id|write_unlock_bh
c_func
(paren
op_amp
id|sap-&gt;sk_list.lock
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;llc_conn_rcv - sends received pdus to the connection state machine&n; *&t;@sk: current connection structure.&n; *&t;@skb: received frame.&n; *&n; *&t;Sends received pdus to the connection state machine.&n; */
DECL|function|llc_conn_rcv
r_static
r_int
id|llc_conn_rcv
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|llc_conn_state_ev
op_star
id|ev
op_assign
id|llc_conn_ev
c_func
(paren
id|skb
)paren
suffix:semicolon
r_struct
id|llc_opt
op_star
id|llc
op_assign
id|llc_sk
c_func
(paren
id|sk
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|llc-&gt;dev
)paren
id|llc-&gt;dev
op_assign
id|skb-&gt;dev
suffix:semicolon
id|ev-&gt;type
op_assign
id|LLC_CONN_EV_TYPE_PDU
suffix:semicolon
id|ev-&gt;reason
op_assign
l_int|0
suffix:semicolon
r_return
id|llc_conn_state_process
c_func
(paren
id|sk
comma
id|skb
)paren
suffix:semicolon
)brace
DECL|function|llc_conn_handler
r_void
id|llc_conn_handler
c_func
(paren
r_struct
id|llc_sap
op_star
id|sap
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|llc_addr
id|saddr
comma
id|daddr
suffix:semicolon
r_struct
id|sock
op_star
id|sk
suffix:semicolon
id|llc_pdu_decode_sa
c_func
(paren
id|skb
comma
id|saddr.mac
)paren
suffix:semicolon
id|llc_pdu_decode_ssap
c_func
(paren
id|skb
comma
op_amp
id|saddr.lsap
)paren
suffix:semicolon
id|llc_pdu_decode_da
c_func
(paren
id|skb
comma
id|daddr.mac
)paren
suffix:semicolon
id|llc_pdu_decode_dsap
c_func
(paren
id|skb
comma
op_amp
id|daddr.lsap
)paren
suffix:semicolon
id|sk
op_assign
id|llc_lookup_established
c_func
(paren
id|sap
comma
op_amp
id|saddr
comma
op_amp
id|daddr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sk
)paren
(brace
multiline_comment|/*&n;&t;&t; * Didn&squot;t find an active connection; verify if there&n;&t;&t; * is a listening socket for this llc addr&n;&t;&t; */
r_struct
id|llc_opt
op_star
id|llc
suffix:semicolon
r_struct
id|sock
op_star
id|parent
op_assign
id|llc_lookup_listener
c_func
(paren
id|sap
comma
op_amp
id|daddr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|parent
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;llc_lookup_listener failed!&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|drop
suffix:semicolon
)brace
id|sk
op_assign
id|llc_sk_alloc
c_func
(paren
id|parent-&gt;sk_family
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sk
)paren
(brace
id|sock_put
c_func
(paren
id|parent
)paren
suffix:semicolon
r_goto
id|drop
suffix:semicolon
)brace
id|llc
op_assign
id|llc_sk
c_func
(paren
id|sk
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|llc-&gt;laddr
comma
op_amp
id|daddr
comma
r_sizeof
(paren
id|llc-&gt;laddr
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|llc-&gt;daddr
comma
op_amp
id|saddr
comma
r_sizeof
(paren
id|llc-&gt;daddr
)paren
)paren
suffix:semicolon
id|llc_sap_add_socket
c_func
(paren
id|sap
comma
id|sk
)paren
suffix:semicolon
id|sock_hold
c_func
(paren
id|sk
)paren
suffix:semicolon
id|sock_put
c_func
(paren
id|parent
)paren
suffix:semicolon
id|skb-&gt;sk
op_assign
id|parent
suffix:semicolon
)brace
r_else
id|skb-&gt;sk
op_assign
id|sk
suffix:semicolon
id|bh_lock_sock
c_func
(paren
id|sk
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sock_owned_by_user
c_func
(paren
id|sk
)paren
)paren
id|llc_conn_rcv
c_func
(paren
id|sk
comma
id|skb
)paren
suffix:semicolon
r_else
(brace
id|dprintk
c_func
(paren
l_string|&quot;%s: adding to backlog...&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|llc_set_backlog_type
c_func
(paren
id|skb
comma
id|LLC_PACKET
)paren
suffix:semicolon
id|sk_add_backlog
c_func
(paren
id|sk
comma
id|skb
)paren
suffix:semicolon
)brace
id|bh_unlock_sock
c_func
(paren
id|sk
)paren
suffix:semicolon
id|sock_put
c_func
(paren
id|sk
)paren
suffix:semicolon
r_return
suffix:semicolon
id|drop
suffix:colon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
DECL|macro|LLC_REFCNT_DEBUG
macro_line|#undef LLC_REFCNT_DEBUG
macro_line|#ifdef LLC_REFCNT_DEBUG
DECL|variable|llc_sock_nr
r_static
id|atomic_t
id|llc_sock_nr
suffix:semicolon
macro_line|#endif
multiline_comment|/**&n; *&t;llc_release_sockets - releases all sockets in a sap&n; *&t;@sap: sap to release its sockets&n; *&n; *&t;Releases all connections of a sap. Returns 0 if all actions complete&n; *&t;successfully, nonzero otherwise&n; */
DECL|function|llc_release_sockets
r_int
id|llc_release_sockets
c_func
(paren
r_struct
id|llc_sap
op_star
id|sap
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_struct
id|sock
op_star
id|sk
suffix:semicolon
r_struct
id|hlist_node
op_star
id|node
suffix:semicolon
id|write_lock_bh
c_func
(paren
op_amp
id|sap-&gt;sk_list.lock
)paren
suffix:semicolon
id|sk_for_each
c_func
(paren
id|sk
comma
id|node
comma
op_amp
id|sap-&gt;sk_list.list
)paren
(brace
id|llc_sk
c_func
(paren
id|sk
)paren
op_member_access_from_pointer
id|state
op_assign
id|LLC_CONN_STATE_TEMP
suffix:semicolon
r_if
c_cond
(paren
id|llc_send_disc
c_func
(paren
id|sk
)paren
)paren
id|rc
op_assign
l_int|1
suffix:semicolon
)brace
id|write_unlock_bh
c_func
(paren
op_amp
id|sap-&gt;sk_list.lock
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;llc_backlog_rcv - Processes rx frames and expired timers.&n; *&t;@sk: LLC sock (p8022 connection)&n; *&t;@skb: queued rx frame or event&n; *&n; *&t;This function processes frames that has received and timers that has&n; *&t;expired during sending an I pdu (refer to data_req_handler).  frames&n; *&t;queue by llc_rcv function (llc_mac.c) and timers queue by timer&n; *&t;callback functions(llc_c_ac.c).&n; */
DECL|function|llc_backlog_rcv
r_static
r_int
id|llc_backlog_rcv
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_struct
id|llc_opt
op_star
id|llc
op_assign
id|llc_sk
c_func
(paren
id|sk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|llc_backlog_type
c_func
(paren
id|skb
)paren
op_eq
id|LLC_PACKET
)paren
(brace
r_if
c_cond
(paren
id|llc-&gt;state
OG
l_int|1
)paren
multiline_comment|/* not closed */
id|rc
op_assign
id|llc_conn_rcv
c_func
(paren
id|sk
comma
id|skb
)paren
suffix:semicolon
r_else
r_goto
id|out_kfree_skb
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|llc_backlog_type
c_func
(paren
id|skb
)paren
op_eq
id|LLC_EVENT
)paren
(brace
multiline_comment|/* timer expiration event */
r_if
c_cond
(paren
id|llc-&gt;state
OG
l_int|1
)paren
multiline_comment|/* not closed */
id|rc
op_assign
id|llc_conn_state_process
c_func
(paren
id|sk
comma
id|skb
)paren
suffix:semicolon
r_else
r_goto
id|out_kfree_skb
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: invalid skb in backlog&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_goto
id|out_kfree_skb
suffix:semicolon
)brace
id|out
suffix:colon
r_return
id|rc
suffix:semicolon
id|out_kfree_skb
suffix:colon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/**&n; *     llc_sk_init - Initializes a socket with default llc values.&n; *     @sk: socket to initialize.&n; *&n; *     Initializes a socket with default llc values.&n; */
DECL|function|llc_sk_init
r_static
r_int
id|llc_sk_init
c_func
(paren
r_struct
id|sock
op_star
id|sk
)paren
(brace
r_struct
id|llc_opt
op_star
id|llc
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|llc
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_int
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|llc
)paren
r_goto
id|out
suffix:semicolon
id|memset
c_func
(paren
id|llc
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|llc
)paren
)paren
suffix:semicolon
id|rc
op_assign
l_int|0
suffix:semicolon
id|llc-&gt;sk
op_assign
id|sk
suffix:semicolon
id|llc-&gt;state
op_assign
id|LLC_CONN_STATE_ADM
suffix:semicolon
id|llc-&gt;inc_cntr
op_assign
id|llc-&gt;dec_cntr
op_assign
l_int|2
suffix:semicolon
id|llc-&gt;dec_step
op_assign
id|llc-&gt;connect_step
op_assign
l_int|1
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|llc-&gt;ack_timer.timer
)paren
suffix:semicolon
id|llc-&gt;ack_timer.expire
op_assign
id|LLC_ACK_TIME
suffix:semicolon
id|llc-&gt;ack_timer.timer.data
op_assign
(paren
r_int
r_int
)paren
id|sk
suffix:semicolon
id|llc-&gt;ack_timer.timer.function
op_assign
id|llc_conn_ack_tmr_cb
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|llc-&gt;pf_cycle_timer.timer
)paren
suffix:semicolon
id|llc-&gt;pf_cycle_timer.expire
op_assign
id|LLC_P_TIME
suffix:semicolon
id|llc-&gt;pf_cycle_timer.timer.data
op_assign
(paren
r_int
r_int
)paren
id|sk
suffix:semicolon
id|llc-&gt;pf_cycle_timer.timer.function
op_assign
id|llc_conn_pf_cycle_tmr_cb
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|llc-&gt;rej_sent_timer.timer
)paren
suffix:semicolon
id|llc-&gt;rej_sent_timer.expire
op_assign
id|LLC_REJ_TIME
suffix:semicolon
id|llc-&gt;rej_sent_timer.timer.data
op_assign
(paren
r_int
r_int
)paren
id|sk
suffix:semicolon
id|llc-&gt;rej_sent_timer.timer.function
op_assign
id|llc_conn_rej_tmr_cb
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|llc-&gt;busy_state_timer.timer
)paren
suffix:semicolon
id|llc-&gt;busy_state_timer.expire
op_assign
id|LLC_BUSY_TIME
suffix:semicolon
id|llc-&gt;busy_state_timer.timer.data
op_assign
(paren
r_int
r_int
)paren
id|sk
suffix:semicolon
id|llc-&gt;busy_state_timer.timer.function
op_assign
id|llc_conn_busy_tmr_cb
suffix:semicolon
id|llc-&gt;n2
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* max retransmit */
id|llc-&gt;k
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* tx win size, will adjust dynam */
id|llc-&gt;rw
op_assign
l_int|128
suffix:semicolon
multiline_comment|/* rx win size (opt and equal to&n;&t;&t;        * tx_win of remote LLC) */
id|skb_queue_head_init
c_func
(paren
op_amp
id|llc-&gt;pdu_unack_q
)paren
suffix:semicolon
id|sk-&gt;sk_backlog_rcv
op_assign
id|llc_backlog_rcv
suffix:semicolon
id|sk-&gt;sk_protinfo
op_assign
id|llc
suffix:semicolon
id|out
suffix:colon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;llc_sk_alloc - Allocates LLC sock&n; *&t;@family: upper layer protocol family&n; *&t;@priority: for allocation (%GFP_KERNEL, %GFP_ATOMIC, etc)&n; *&n; *&t;Allocates a LLC sock and initializes it. Returns the new LLC sock&n; *&t;or %NULL if there&squot;s no memory available for one&n; */
DECL|function|llc_sk_alloc
r_struct
id|sock
op_star
id|llc_sk_alloc
c_func
(paren
r_int
id|family
comma
r_int
id|priority
)paren
(brace
r_struct
id|sock
op_star
id|sk
op_assign
id|sk_alloc
c_func
(paren
id|family
comma
id|priority
comma
l_int|1
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sk
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|llc_sk_init
c_func
(paren
id|sk
)paren
)paren
r_goto
id|outsk
suffix:semicolon
id|sock_init_data
c_func
(paren
l_int|NULL
comma
id|sk
)paren
suffix:semicolon
id|sk_set_owner
c_func
(paren
id|sk
comma
id|THIS_MODULE
)paren
suffix:semicolon
macro_line|#ifdef LLC_REFCNT_DEBUG
id|atomic_inc
c_func
(paren
op_amp
id|llc_sock_nr
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;LLC socket %p created in %s, now we have %d alive&bslash;n&quot;
comma
id|sk
comma
id|__FUNCTION__
comma
id|atomic_read
c_func
(paren
op_amp
id|llc_sock_nr
)paren
)paren
suffix:semicolon
macro_line|#endif
id|out
suffix:colon
r_return
id|sk
suffix:semicolon
id|outsk
suffix:colon
id|sk_free
c_func
(paren
id|sk
)paren
suffix:semicolon
id|sk
op_assign
l_int|NULL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;llc_sk_free - Frees a LLC socket&n; *&t;@sk - socket to free&n; *&n; *&t;Frees a LLC socket&n; */
DECL|function|llc_sk_free
r_void
id|llc_sk_free
c_func
(paren
r_struct
id|sock
op_star
id|sk
)paren
(brace
r_struct
id|llc_opt
op_star
id|llc
op_assign
id|llc_sk
c_func
(paren
id|sk
)paren
suffix:semicolon
id|llc-&gt;state
op_assign
id|LLC_CONN_OUT_OF_SVC
suffix:semicolon
multiline_comment|/* Stop all (possibly) running timers */
id|llc_conn_ac_stop_all_timers
c_func
(paren
id|sk
comma
l_int|NULL
)paren
suffix:semicolon
macro_line|#ifdef DEBUG_LLC_CONN_ALLOC
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;%s: unackq=%d, txq=%d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|skb_queue_len
c_func
(paren
op_amp
id|llc-&gt;pdu_unack_q
)paren
comma
id|skb_queue_len
c_func
(paren
op_amp
id|sk-&gt;sk_write_queue
)paren
)paren
suffix:semicolon
macro_line|#endif
id|skb_queue_purge
c_func
(paren
op_amp
id|sk-&gt;sk_receive_queue
)paren
suffix:semicolon
id|skb_queue_purge
c_func
(paren
op_amp
id|sk-&gt;sk_write_queue
)paren
suffix:semicolon
id|skb_queue_purge
c_func
(paren
op_amp
id|llc-&gt;pdu_unack_q
)paren
suffix:semicolon
macro_line|#ifdef LLC_REFCNT_DEBUG
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|sk-&gt;sk_refcnt
)paren
op_ne
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Destruction of LLC sock %p delayed in %s, cnt=%d&bslash;n&quot;
comma
id|sk
comma
id|__FUNCTION__
comma
id|atomic_read
c_func
(paren
op_amp
id|sk-&gt;sk_refcnt
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%d LLC sockets are still alive&bslash;n&quot;
comma
id|atomic_read
c_func
(paren
op_amp
id|llc_sock_nr
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|atomic_dec
c_func
(paren
op_amp
id|llc_sock_nr
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;LLC socket %p released in %s, %d are still alive&bslash;n&quot;
comma
id|sk
comma
id|__FUNCTION__
comma
id|atomic_read
c_func
(paren
op_amp
id|llc_sock_nr
)paren
)paren
suffix:semicolon
)brace
macro_line|#endif
id|sock_put
c_func
(paren
id|sk
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; *&t;llc_sk_reset - resets a connection&n; *&t;@sk: LLC socket to reset&n; *&n; *&t;Resets a connection to the out of service state. Stops its timers&n; *&t;and frees any frames in the queues of the connection.&n; */
DECL|function|llc_sk_reset
r_void
id|llc_sk_reset
c_func
(paren
r_struct
id|sock
op_star
id|sk
)paren
(brace
r_struct
id|llc_opt
op_star
id|llc
op_assign
id|llc_sk
c_func
(paren
id|sk
)paren
suffix:semicolon
id|llc_conn_ac_stop_all_timers
c_func
(paren
id|sk
comma
l_int|NULL
)paren
suffix:semicolon
id|skb_queue_purge
c_func
(paren
op_amp
id|sk-&gt;sk_write_queue
)paren
suffix:semicolon
id|skb_queue_purge
c_func
(paren
op_amp
id|llc-&gt;pdu_unack_q
)paren
suffix:semicolon
id|llc-&gt;remote_busy_flag
op_assign
l_int|0
suffix:semicolon
id|llc-&gt;cause_flag
op_assign
l_int|0
suffix:semicolon
id|llc-&gt;retry_count
op_assign
l_int|0
suffix:semicolon
id|llc_conn_set_p_flag
c_func
(paren
id|sk
comma
l_int|0
)paren
suffix:semicolon
id|llc-&gt;f_flag
op_assign
l_int|0
suffix:semicolon
id|llc-&gt;s_flag
op_assign
l_int|0
suffix:semicolon
id|llc-&gt;ack_pf
op_assign
l_int|0
suffix:semicolon
id|llc-&gt;first_pdu_Ns
op_assign
l_int|0
suffix:semicolon
id|llc-&gt;ack_must_be_send
op_assign
l_int|0
suffix:semicolon
id|llc-&gt;dec_step
op_assign
l_int|1
suffix:semicolon
id|llc-&gt;inc_cntr
op_assign
l_int|2
suffix:semicolon
id|llc-&gt;dec_cntr
op_assign
l_int|2
suffix:semicolon
id|llc-&gt;X
op_assign
l_int|0
suffix:semicolon
id|llc-&gt;failed_data_req
op_assign
l_int|0
suffix:semicolon
id|llc-&gt;last_nr
op_assign
l_int|0
suffix:semicolon
)brace
eof
