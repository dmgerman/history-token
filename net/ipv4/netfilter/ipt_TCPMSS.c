multiline_comment|/*&n; * This is a module which is used for setting the MSS option in TCP packets.&n; *&n; * Copyright (c) 2000 Marc Boucher&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/ip.h&gt;
macro_line|#include &lt;net/tcp.h&gt;
macro_line|#include &lt;linux/netfilter_ipv4/ip_tables.h&gt;
macro_line|#include &lt;linux/netfilter_ipv4/ipt_TCPMSS.h&gt;
macro_line|#if 0
mdefine_line|#define DEBUGP printk
macro_line|#else
DECL|macro|DEBUGP
mdefine_line|#define DEBUGP(format, args...)
macro_line|#endif
r_static
id|u_int16_t
DECL|function|cheat_check
id|cheat_check
c_func
(paren
id|u_int32_t
id|oldvalinv
comma
id|u_int32_t
id|newval
comma
id|u_int16_t
id|oldcheck
)paren
(brace
id|u_int32_t
id|diffs
(braket
)braket
op_assign
(brace
id|oldvalinv
comma
id|newval
)brace
suffix:semicolon
r_return
id|csum_fold
c_func
(paren
id|csum_partial
c_func
(paren
(paren
r_char
op_star
)paren
id|diffs
comma
r_sizeof
(paren
id|diffs
)paren
comma
id|oldcheck
op_xor
l_int|0xFFFF
)paren
)paren
suffix:semicolon
)brace
r_static
r_inline
r_int
r_int
DECL|function|optlen
id|optlen
c_func
(paren
r_const
id|u_int8_t
op_star
id|opt
comma
r_int
r_int
id|offset
)paren
(brace
multiline_comment|/* Beware zero-length options: make finite progress */
r_if
c_cond
(paren
id|opt
(braket
id|offset
)braket
op_le
id|TCPOPT_NOP
op_logical_or
id|opt
(braket
id|offset
op_plus
l_int|1
)braket
op_eq
l_int|0
)paren
r_return
l_int|1
suffix:semicolon
r_else
r_return
id|opt
(braket
id|offset
op_plus
l_int|1
)braket
suffix:semicolon
)brace
r_static
r_int
r_int
DECL|function|ipt_tcpmss_target
id|ipt_tcpmss_target
c_func
(paren
r_struct
id|sk_buff
op_star
op_star
id|pskb
comma
r_int
r_int
id|hooknum
comma
r_const
r_struct
id|net_device
op_star
id|in
comma
r_const
r_struct
id|net_device
op_star
id|out
comma
r_const
r_void
op_star
id|targinfo
comma
r_void
op_star
id|userinfo
)paren
(brace
r_const
r_struct
id|ipt_tcpmss_info
op_star
id|tcpmssinfo
op_assign
id|targinfo
suffix:semicolon
r_struct
id|tcphdr
op_star
id|tcph
suffix:semicolon
r_struct
id|iphdr
op_star
id|iph
suffix:semicolon
id|u_int16_t
id|tcplen
comma
id|newtotlen
comma
id|oldval
comma
id|newmss
suffix:semicolon
r_int
r_int
id|i
suffix:semicolon
id|u_int8_t
op_star
id|opt
suffix:semicolon
multiline_comment|/* raw socket (tcpdump) may have clone of incoming skb: don&squot;t&n;&t;   disturb it --RR */
r_if
c_cond
(paren
id|skb_cloned
c_func
(paren
op_star
id|pskb
)paren
op_logical_and
op_logical_neg
(paren
op_star
id|pskb
)paren
op_member_access_from_pointer
id|sk
)paren
(brace
r_struct
id|sk_buff
op_star
id|nskb
op_assign
id|skb_copy
c_func
(paren
op_star
id|pskb
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|nskb
)paren
r_return
id|NF_DROP
suffix:semicolon
id|kfree_skb
c_func
(paren
op_star
id|pskb
)paren
suffix:semicolon
op_star
id|pskb
op_assign
id|nskb
suffix:semicolon
)brace
id|iph
op_assign
(paren
op_star
id|pskb
)paren
op_member_access_from_pointer
id|nh.iph
suffix:semicolon
id|tcplen
op_assign
(paren
op_star
id|pskb
)paren
op_member_access_from_pointer
id|len
op_minus
id|iph-&gt;ihl
op_star
l_int|4
suffix:semicolon
id|tcph
op_assign
(paren
r_void
op_star
)paren
id|iph
op_plus
id|iph-&gt;ihl
op_star
l_int|4
suffix:semicolon
multiline_comment|/* Since it passed flags test in tcp match, we know it is is&n;&t;   not a fragment, and has data &gt;= tcp header length.  SYN&n;&t;   packets should not contain data: if they did, then we risk&n;&t;   running over MTU, sending Frag Needed and breaking things&n;&t;   badly. --RR */
r_if
c_cond
(paren
id|tcplen
op_ne
id|tcph-&gt;doff
op_star
l_int|4
)paren
(brace
r_if
c_cond
(paren
id|net_ratelimit
c_func
(paren
)paren
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ipt_tcpmss_target: bad length (%d bytes)&bslash;n&quot;
comma
(paren
op_star
id|pskb
)paren
op_member_access_from_pointer
id|len
)paren
suffix:semicolon
r_return
id|NF_DROP
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tcpmssinfo-&gt;mss
op_eq
id|IPT_TCPMSS_CLAMP_PMTU
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
op_star
id|pskb
)paren
op_member_access_from_pointer
id|dst
)paren
(brace
r_if
c_cond
(paren
id|net_ratelimit
c_func
(paren
)paren
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ipt_tcpmss_target: no dst?! can&squot;t determine path-MTU&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|NF_DROP
suffix:semicolon
multiline_comment|/* or IPT_CONTINUE ?? */
)brace
r_if
c_cond
(paren
id|dst_pmtu
c_func
(paren
(paren
op_star
id|pskb
)paren
op_member_access_from_pointer
id|dst
)paren
op_le
(paren
r_sizeof
(paren
r_struct
id|iphdr
)paren
op_plus
r_sizeof
(paren
r_struct
id|tcphdr
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|net_ratelimit
c_func
(paren
)paren
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ipt_tcpmss_target: unknown or invalid path-MTU (%d)&bslash;n&quot;
comma
id|dst_pmtu
c_func
(paren
(paren
op_star
id|pskb
)paren
op_member_access_from_pointer
id|dst
)paren
)paren
suffix:semicolon
r_return
id|NF_DROP
suffix:semicolon
multiline_comment|/* or IPT_CONTINUE ?? */
)brace
id|newmss
op_assign
id|dst_pmtu
c_func
(paren
(paren
op_star
id|pskb
)paren
op_member_access_from_pointer
id|dst-&gt;pmtu
)paren
op_minus
r_sizeof
(paren
r_struct
id|iphdr
)paren
op_minus
r_sizeof
(paren
r_struct
id|tcphdr
)paren
suffix:semicolon
)brace
r_else
id|newmss
op_assign
id|tcpmssinfo-&gt;mss
suffix:semicolon
id|opt
op_assign
(paren
id|u_int8_t
op_star
)paren
id|tcph
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
r_sizeof
(paren
r_struct
id|tcphdr
)paren
suffix:semicolon
id|i
OL
id|tcph-&gt;doff
op_star
l_int|4
suffix:semicolon
id|i
op_add_assign
id|optlen
c_func
(paren
id|opt
comma
id|i
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|opt
(braket
id|i
)braket
op_eq
id|TCPOPT_MSS
)paren
op_logical_and
(paren
(paren
id|tcph-&gt;doff
op_star
l_int|4
op_minus
id|i
)paren
op_ge
id|TCPOLEN_MSS
)paren
op_logical_and
(paren
id|opt
(braket
id|i
op_plus
l_int|1
)braket
op_eq
id|TCPOLEN_MSS
)paren
)paren
(brace
id|u_int16_t
id|oldmss
suffix:semicolon
id|oldmss
op_assign
(paren
id|opt
(braket
id|i
op_plus
l_int|2
)braket
op_lshift
l_int|8
)paren
op_or
id|opt
(braket
id|i
op_plus
l_int|3
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tcpmssinfo-&gt;mss
op_eq
id|IPT_TCPMSS_CLAMP_PMTU
)paren
op_logical_and
(paren
id|oldmss
op_le
id|newmss
)paren
)paren
(brace
r_return
id|IPT_CONTINUE
suffix:semicolon
)brace
id|opt
(braket
id|i
op_plus
l_int|2
)braket
op_assign
(paren
id|newmss
op_amp
l_int|0xff00
)paren
op_rshift
l_int|8
suffix:semicolon
id|opt
(braket
id|i
op_plus
l_int|3
)braket
op_assign
(paren
id|newmss
op_amp
l_int|0x00ff
)paren
suffix:semicolon
id|tcph-&gt;check
op_assign
id|cheat_check
c_func
(paren
id|htons
c_func
(paren
id|oldmss
)paren
op_xor
l_int|0xFFFF
comma
id|htons
c_func
(paren
id|newmss
)paren
comma
id|tcph-&gt;check
)paren
suffix:semicolon
id|DEBUGP
c_func
(paren
id|KERN_INFO
l_string|&quot;ipt_tcpmss_target: %u.%u.%u.%u:%hu&quot;
l_string|&quot;-&gt;%u.%u.%u.%u:%hu changed TCP MSS option&quot;
l_string|&quot; (from %u to %u)&bslash;n&quot;
comma
id|NIPQUAD
c_func
(paren
(paren
op_star
id|pskb
)paren
op_member_access_from_pointer
id|nh.iph-&gt;saddr
)paren
comma
id|ntohs
c_func
(paren
id|tcph-&gt;source
)paren
comma
id|NIPQUAD
c_func
(paren
(paren
op_star
id|pskb
)paren
op_member_access_from_pointer
id|nh.iph-&gt;daddr
)paren
comma
id|ntohs
c_func
(paren
id|tcph-&gt;dest
)paren
comma
id|oldmss
comma
id|newmss
)paren
suffix:semicolon
r_goto
id|retmodified
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t; * MSS Option not found ?! add it..&n;&t; */
r_if
c_cond
(paren
id|skb_tailroom
c_func
(paren
(paren
op_star
id|pskb
)paren
)paren
OL
id|TCPOLEN_MSS
)paren
(brace
r_struct
id|sk_buff
op_star
id|newskb
suffix:semicolon
id|newskb
op_assign
id|skb_copy_expand
c_func
(paren
op_star
id|pskb
comma
id|skb_headroom
c_func
(paren
op_star
id|pskb
)paren
comma
id|TCPOLEN_MSS
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|newskb
)paren
(brace
r_if
c_cond
(paren
id|net_ratelimit
c_func
(paren
)paren
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;ipt_tcpmss_target:&quot;
l_string|&quot; unable to allocate larger skb&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|NF_DROP
suffix:semicolon
)brace
id|kfree_skb
c_func
(paren
op_star
id|pskb
)paren
suffix:semicolon
op_star
id|pskb
op_assign
id|newskb
suffix:semicolon
id|iph
op_assign
(paren
op_star
id|pskb
)paren
op_member_access_from_pointer
id|nh.iph
suffix:semicolon
id|tcph
op_assign
(paren
r_void
op_star
)paren
id|iph
op_plus
id|iph-&gt;ihl
op_star
l_int|4
suffix:semicolon
)brace
id|skb_put
c_func
(paren
(paren
op_star
id|pskb
)paren
comma
id|TCPOLEN_MSS
)paren
suffix:semicolon
id|opt
op_assign
(paren
id|u_int8_t
op_star
)paren
id|tcph
op_plus
r_sizeof
(paren
r_struct
id|tcphdr
)paren
suffix:semicolon
id|memmove
c_func
(paren
id|opt
op_plus
id|TCPOLEN_MSS
comma
id|opt
comma
id|tcplen
op_minus
r_sizeof
(paren
r_struct
id|tcphdr
)paren
)paren
suffix:semicolon
id|tcph-&gt;check
op_assign
id|cheat_check
c_func
(paren
id|htons
c_func
(paren
id|tcplen
)paren
op_xor
l_int|0xFFFF
comma
id|htons
c_func
(paren
id|tcplen
op_plus
id|TCPOLEN_MSS
)paren
comma
id|tcph-&gt;check
)paren
suffix:semicolon
id|tcplen
op_add_assign
id|TCPOLEN_MSS
suffix:semicolon
id|opt
(braket
l_int|0
)braket
op_assign
id|TCPOPT_MSS
suffix:semicolon
id|opt
(braket
l_int|1
)braket
op_assign
id|TCPOLEN_MSS
suffix:semicolon
id|opt
(braket
l_int|2
)braket
op_assign
(paren
id|newmss
op_amp
l_int|0xff00
)paren
op_rshift
l_int|8
suffix:semicolon
id|opt
(braket
l_int|3
)braket
op_assign
(paren
id|newmss
op_amp
l_int|0x00ff
)paren
suffix:semicolon
id|tcph-&gt;check
op_assign
id|cheat_check
c_func
(paren
op_complement
l_int|0
comma
op_star
(paren
(paren
id|u_int32_t
op_star
)paren
id|opt
)paren
comma
id|tcph-&gt;check
)paren
suffix:semicolon
id|oldval
op_assign
(paren
(paren
id|u_int16_t
op_star
)paren
id|tcph
)paren
(braket
l_int|6
)braket
suffix:semicolon
id|tcph-&gt;doff
op_add_assign
id|TCPOLEN_MSS
op_div
l_int|4
suffix:semicolon
id|tcph-&gt;check
op_assign
id|cheat_check
c_func
(paren
id|oldval
op_xor
l_int|0xFFFF
comma
(paren
(paren
id|u_int16_t
op_star
)paren
id|tcph
)paren
(braket
l_int|6
)braket
comma
id|tcph-&gt;check
)paren
suffix:semicolon
id|newtotlen
op_assign
id|htons
c_func
(paren
id|ntohs
c_func
(paren
id|iph-&gt;tot_len
)paren
op_plus
id|TCPOLEN_MSS
)paren
suffix:semicolon
id|iph-&gt;check
op_assign
id|cheat_check
c_func
(paren
id|iph-&gt;tot_len
op_xor
l_int|0xFFFF
comma
id|newtotlen
comma
id|iph-&gt;check
)paren
suffix:semicolon
id|iph-&gt;tot_len
op_assign
id|newtotlen
suffix:semicolon
id|DEBUGP
c_func
(paren
id|KERN_INFO
l_string|&quot;ipt_tcpmss_target: %u.%u.%u.%u:%hu&quot;
l_string|&quot;-&gt;%u.%u.%u.%u:%hu added TCP MSS option (%u)&bslash;n&quot;
comma
id|NIPQUAD
c_func
(paren
(paren
op_star
id|pskb
)paren
op_member_access_from_pointer
id|nh.iph-&gt;saddr
)paren
comma
id|ntohs
c_func
(paren
id|tcph-&gt;source
)paren
comma
id|NIPQUAD
c_func
(paren
(paren
op_star
id|pskb
)paren
op_member_access_from_pointer
id|nh.iph-&gt;daddr
)paren
comma
id|ntohs
c_func
(paren
id|tcph-&gt;dest
)paren
comma
id|newmss
)paren
suffix:semicolon
id|retmodified
suffix:colon
multiline_comment|/* If we had a hardware checksum before, it&squot;s now invalid */
(paren
op_star
id|pskb
)paren
op_member_access_from_pointer
id|ip_summed
op_assign
id|CHECKSUM_NONE
suffix:semicolon
(paren
op_star
id|pskb
)paren
op_member_access_from_pointer
id|nfcache
op_or_assign
id|NFC_UNKNOWN
op_or
id|NFC_ALTERED
suffix:semicolon
r_return
id|IPT_CONTINUE
suffix:semicolon
)brace
DECL|macro|TH_SYN
mdefine_line|#define TH_SYN 0x02
DECL|function|find_syn_match
r_static
r_inline
r_int
id|find_syn_match
c_func
(paren
r_const
r_struct
id|ipt_entry_match
op_star
id|m
)paren
(brace
r_const
r_struct
id|ipt_tcp
op_star
id|tcpinfo
op_assign
(paren
r_const
r_struct
id|ipt_tcp
op_star
)paren
id|m-&gt;data
suffix:semicolon
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|m-&gt;u.kernel.match-&gt;name
comma
l_string|&quot;tcp&quot;
)paren
op_eq
l_int|0
op_logical_and
(paren
id|tcpinfo-&gt;flg_cmp
op_amp
id|TH_SYN
)paren
op_logical_and
op_logical_neg
(paren
id|tcpinfo-&gt;invflags
op_amp
id|IPT_TCP_INV_FLAGS
)paren
)paren
r_return
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Must specify -p tcp --syn/--tcp-flags SYN */
r_static
r_int
DECL|function|ipt_tcpmss_checkentry
id|ipt_tcpmss_checkentry
c_func
(paren
r_const
r_char
op_star
id|tablename
comma
r_const
r_struct
id|ipt_entry
op_star
id|e
comma
r_void
op_star
id|targinfo
comma
r_int
r_int
id|targinfosize
comma
r_int
r_int
id|hook_mask
)paren
(brace
r_const
r_struct
id|ipt_tcpmss_info
op_star
id|tcpmssinfo
op_assign
id|targinfo
suffix:semicolon
r_if
c_cond
(paren
id|targinfosize
op_ne
id|IPT_ALIGN
c_func
(paren
r_sizeof
(paren
r_struct
id|ipt_tcpmss_info
)paren
)paren
)paren
(brace
id|DEBUGP
c_func
(paren
l_string|&quot;ipt_tcpmss_checkentry: targinfosize %u != %u&bslash;n&quot;
comma
id|targinfosize
comma
id|IPT_ALIGN
c_func
(paren
r_sizeof
(paren
r_struct
id|ipt_tcpmss_info
)paren
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|tcpmssinfo-&gt;mss
op_eq
id|IPT_TCPMSS_CLAMP_PMTU
)paren
op_logical_and
(paren
(paren
id|hook_mask
op_amp
op_complement
(paren
(paren
l_int|1
op_lshift
id|NF_IP_FORWARD
)paren
op_or
(paren
l_int|1
op_lshift
id|NF_IP_LOCAL_OUT
)paren
op_or
(paren
l_int|1
op_lshift
id|NF_IP_POST_ROUTING
)paren
)paren
)paren
op_ne
l_int|0
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;TCPMSS: path-MTU clamping only supported in FORWARD, OUTPUT and POSTROUTING hooks&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|e-&gt;ip.proto
op_eq
id|IPPROTO_TCP
op_logical_and
op_logical_neg
(paren
id|e-&gt;ip.invflags
op_amp
id|IPT_INV_PROTO
)paren
op_logical_and
id|IPT_MATCH_ITERATE
c_func
(paren
id|e
comma
id|find_syn_match
)paren
)paren
r_return
l_int|1
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;TCPMSS: Only works on TCP SYN packets&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|ipt_tcpmss_reg
r_static
r_struct
id|ipt_target
id|ipt_tcpmss_reg
op_assign
(brace
(brace
l_int|NULL
comma
l_int|NULL
)brace
comma
l_string|&quot;TCPMSS&quot;
comma
id|ipt_tcpmss_target
comma
id|ipt_tcpmss_checkentry
comma
l_int|NULL
comma
id|THIS_MODULE
)brace
suffix:semicolon
DECL|function|init
r_static
r_int
id|__init
id|init
c_func
(paren
r_void
)paren
(brace
r_return
id|ipt_register_target
c_func
(paren
op_amp
id|ipt_tcpmss_reg
)paren
suffix:semicolon
)brace
DECL|function|fini
r_static
r_void
id|__exit
id|fini
c_func
(paren
r_void
)paren
(brace
id|ipt_unregister_target
c_func
(paren
op_amp
id|ipt_tcpmss_reg
)paren
suffix:semicolon
)brace
DECL|variable|init
id|module_init
c_func
(paren
id|init
)paren
suffix:semicolon
DECL|variable|fini
id|module_exit
c_func
(paren
id|fini
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
eof
