multiline_comment|/* IRC extension for IP connection tracking, Version 1.19&n; * (C) 2000 by Harald Welte &lt;laforge@gnumonks.org&gt;&n; * based on RR&squot;s ip_conntrack_ftp.c&t;&n; *&n; * ip_conntrack_irc.c,v 1.19 2001/10/25 14:34:21 laforge Exp&n; *&n; *      This program is free software; you can redistribute it and/or&n; *      modify it under the terms of the GNU General Public License&n; *      as published by the Free Software Foundation; either version&n; *      2 of the License, or (at your option) any later version.&n; **&n; *&t;Module load syntax:&n; * &t;insmod ip_nat_irc.o ports=port1,port2,...port&lt;MAX_PORTS&gt;&n; *&t;&n; * &t;please give the ports of all IRC servers You wish to connect to.&n; *&t;If You don&squot;t specify ports, the default will be port 6667&n; *&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/netfilter.h&gt;
macro_line|#include &lt;linux/ip.h&gt;
macro_line|#include &lt;net/checksum.h&gt;
macro_line|#include &lt;net/tcp.h&gt;
macro_line|#include &lt;linux/netfilter_ipv4/lockhelp.h&gt;
macro_line|#include &lt;linux/netfilter_ipv4/ip_conntrack_helper.h&gt;
macro_line|#include &lt;linux/netfilter_ipv4/ip_conntrack_irc.h&gt;
DECL|macro|MAX_PORTS
mdefine_line|#define MAX_PORTS 8
DECL|variable|ports
r_static
r_int
id|ports
(braket
id|MAX_PORTS
)braket
suffix:semicolon
DECL|variable|ports_n_c
r_static
r_int
id|ports_n_c
op_assign
l_int|0
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Harald Welte &lt;laforge@gnumonks.org&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;IRC (DCC) connection tracking module&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
macro_line|#ifdef MODULE_PARM
id|MODULE_PARM
c_func
(paren
id|ports
comma
l_string|&quot;1-&quot;
id|__MODULE_STRING
c_func
(paren
id|MAX_PORTS
)paren
l_string|&quot;i&quot;
)paren
suffix:semicolon
id|MODULE_PARM_DESC
c_func
(paren
id|ports
comma
l_string|&quot;port numbers of IRC servers&quot;
)paren
suffix:semicolon
macro_line|#endif
DECL|macro|NUM_DCCPROTO
mdefine_line|#define NUM_DCCPROTO &t;5
DECL|variable|dccprotos
r_struct
id|dccproto
id|dccprotos
(braket
id|NUM_DCCPROTO
)braket
op_assign
(brace
(brace
l_string|&quot;SEND &quot;
comma
l_int|5
)brace
comma
(brace
l_string|&quot;CHAT &quot;
comma
l_int|5
)brace
comma
(brace
l_string|&quot;MOVE &quot;
comma
l_int|5
)brace
comma
(brace
l_string|&quot;TSEND &quot;
comma
l_int|6
)brace
comma
(brace
l_string|&quot;SCHAT &quot;
comma
l_int|6
)brace
)brace
suffix:semicolon
DECL|macro|MAXMATCHLEN
mdefine_line|#define MAXMATCHLEN&t;6
DECL|variable|ip_irc_lock
id|DECLARE_LOCK
c_func
(paren
id|ip_irc_lock
)paren
suffix:semicolon
DECL|variable|ip_conntrack_irc
r_struct
id|module
op_star
id|ip_conntrack_irc
op_assign
id|THIS_MODULE
suffix:semicolon
macro_line|#if 0
mdefine_line|#define DEBUGP(format, args...) printk(KERN_DEBUG __FILE__ &quot;:&quot; __FUNCTION__ &bslash;&n;&t;&t;&t;&t;&t;&quot;:&quot; format, ## args)
macro_line|#else
DECL|macro|DEBUGP
mdefine_line|#define DEBUGP(format, args...)
macro_line|#endif
DECL|function|parse_dcc
r_int
id|parse_dcc
c_func
(paren
r_char
op_star
id|data
comma
r_char
op_star
id|data_end
comma
id|u_int32_t
op_star
id|ip
comma
id|u_int16_t
op_star
id|port
comma
r_char
op_star
op_star
id|ad_beg_p
comma
r_char
op_star
op_star
id|ad_end_p
)paren
multiline_comment|/* tries to get the ip_addr and port out of a dcc command&n;   return value: -1 on failure, 0 on success &n;&t;data&t;&t;pointer to first byte of DCC command data&n;&t;data_end&t;pointer to last byte of dcc command data&n;&t;ip&t;&t;returns parsed ip of dcc command&n;&t;port&t;&t;returns parsed port of dcc command&n;&t;ad_beg_p&t;returns pointer to first byte of addr data&n;&t;ad_end_p&t;returns pointer to last byte of addr data */
(brace
multiline_comment|/* at least 12: &quot;AAAAAAAA P&bslash;1&bslash;n&quot; */
r_while
c_loop
(paren
op_star
id|data
op_increment
op_ne
l_char|&squot; &squot;
)paren
r_if
c_cond
(paren
id|data
OG
id|data_end
op_minus
l_int|12
)paren
r_return
op_minus
l_int|1
suffix:semicolon
op_star
id|ad_beg_p
op_assign
id|data
suffix:semicolon
op_star
id|ip
op_assign
id|simple_strtoul
c_func
(paren
id|data
comma
op_amp
id|data
comma
l_int|10
)paren
suffix:semicolon
multiline_comment|/* skip blanks between ip and port */
r_while
c_loop
(paren
op_star
id|data
op_eq
l_char|&squot; &squot;
)paren
id|data
op_increment
suffix:semicolon
op_star
id|port
op_assign
id|simple_strtoul
c_func
(paren
id|data
comma
op_amp
id|data
comma
l_int|10
)paren
suffix:semicolon
op_star
id|ad_end_p
op_assign
id|data
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* FIXME: This should be in userspace.  Later. */
DECL|function|help
r_static
r_int
id|help
c_func
(paren
r_const
r_struct
id|iphdr
op_star
id|iph
comma
r_int
id|len
comma
r_struct
id|ip_conntrack
op_star
id|ct
comma
r_enum
id|ip_conntrack_info
id|ctinfo
)paren
(brace
multiline_comment|/* tcplen not negative guarenteed by ip_conntrack_tcp.c */
r_struct
id|tcphdr
op_star
id|tcph
op_assign
(paren
r_void
op_star
)paren
id|iph
op_plus
id|iph-&gt;ihl
op_star
l_int|4
suffix:semicolon
r_const
r_char
op_star
id|data
op_assign
(paren
r_const
r_char
op_star
)paren
id|tcph
op_plus
id|tcph-&gt;doff
op_star
l_int|4
suffix:semicolon
r_const
r_char
op_star
id|_data
op_assign
id|data
suffix:semicolon
r_char
op_star
id|data_limit
suffix:semicolon
id|u_int32_t
id|tcplen
op_assign
id|len
op_minus
id|iph-&gt;ihl
op_star
l_int|4
suffix:semicolon
id|u_int32_t
id|datalen
op_assign
id|tcplen
op_minus
id|tcph-&gt;doff
op_star
l_int|4
suffix:semicolon
r_int
id|dir
op_assign
id|CTINFO2DIR
c_func
(paren
id|ctinfo
)paren
suffix:semicolon
r_struct
id|ip_conntrack_tuple
id|t
comma
id|mask
suffix:semicolon
id|u_int32_t
id|dcc_ip
suffix:semicolon
id|u_int16_t
id|dcc_port
suffix:semicolon
r_int
id|i
suffix:semicolon
r_char
op_star
id|addr_beg_p
comma
op_star
id|addr_end_p
suffix:semicolon
r_struct
id|ip_ct_irc
op_star
id|info
op_assign
op_amp
id|ct-&gt;help.ct_irc_info
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|mask
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|ip_conntrack_tuple
)paren
)paren
suffix:semicolon
id|mask.dst.u.tcp.port
op_assign
l_int|0xFFFF
suffix:semicolon
id|mask.dst.protonum
op_assign
l_int|0xFFFF
suffix:semicolon
id|DEBUGP
c_func
(paren
l_string|&quot;entered&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Can&squot;t track connections formed before we registered */
r_if
c_cond
(paren
op_logical_neg
id|info
)paren
r_return
id|NF_ACCEPT
suffix:semicolon
multiline_comment|/* If packet is coming from IRC server */
r_if
c_cond
(paren
id|dir
op_eq
id|IP_CT_DIR_REPLY
)paren
r_return
id|NF_ACCEPT
suffix:semicolon
multiline_comment|/* Until there&squot;s been traffic both ways, don&squot;t look in packets. */
r_if
c_cond
(paren
id|ctinfo
op_ne
id|IP_CT_ESTABLISHED
op_logical_and
id|ctinfo
op_ne
id|IP_CT_ESTABLISHED
op_plus
id|IP_CT_IS_REPLY
)paren
(brace
id|DEBUGP
c_func
(paren
l_string|&quot;Conntrackinfo = %u&bslash;n&quot;
comma
id|ctinfo
)paren
suffix:semicolon
r_return
id|NF_ACCEPT
suffix:semicolon
)brace
multiline_comment|/* Not whole TCP header? */
r_if
c_cond
(paren
id|tcplen
OL
r_sizeof
(paren
r_struct
id|tcphdr
)paren
op_logical_or
id|tcplen
OL
id|tcph-&gt;doff
op_star
l_int|4
)paren
(brace
id|DEBUGP
c_func
(paren
l_string|&quot;tcplen = %u&bslash;n&quot;
comma
(paren
r_int
)paren
id|tcplen
)paren
suffix:semicolon
r_return
id|NF_ACCEPT
suffix:semicolon
)brace
multiline_comment|/* Checksum invalid?  Ignore. */
multiline_comment|/* FIXME: Source route IP option packets --RR */
r_if
c_cond
(paren
id|tcp_v4_check
c_func
(paren
id|tcph
comma
id|tcplen
comma
id|iph-&gt;saddr
comma
id|iph-&gt;daddr
comma
id|csum_partial
c_func
(paren
(paren
r_char
op_star
)paren
id|tcph
comma
id|tcplen
comma
l_int|0
)paren
)paren
)paren
(brace
id|DEBUGP
c_func
(paren
l_string|&quot;bad csum: %p %u %u.%u.%u.%u %u.%u.%u.%u&bslash;n&quot;
comma
id|tcph
comma
id|tcplen
comma
id|NIPQUAD
c_func
(paren
id|iph-&gt;saddr
)paren
comma
id|NIPQUAD
c_func
(paren
id|iph-&gt;daddr
)paren
)paren
suffix:semicolon
r_return
id|NF_ACCEPT
suffix:semicolon
)brace
id|data_limit
op_assign
(paren
r_char
op_star
)paren
id|data
op_plus
id|datalen
suffix:semicolon
r_while
c_loop
(paren
id|data
OL
(paren
id|data_limit
op_minus
(paren
l_int|22
op_plus
id|MAXMATCHLEN
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|memcmp
c_func
(paren
id|data
comma
l_string|&quot;&bslash;1DCC &quot;
comma
l_int|5
)paren
)paren
(brace
id|data
op_increment
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|data
op_add_assign
l_int|5
suffix:semicolon
id|DEBUGP
c_func
(paren
l_string|&quot;DCC found in master %u.%u.%u.%u:%u %u.%u.%u.%u:%u...&bslash;n&quot;
comma
id|NIPQUAD
c_func
(paren
id|iph-&gt;saddr
)paren
comma
id|ntohs
c_func
(paren
id|tcph-&gt;source
)paren
comma
id|NIPQUAD
c_func
(paren
id|iph-&gt;daddr
)paren
comma
id|ntohs
c_func
(paren
id|tcph-&gt;dest
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NUM_DCCPROTO
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|memcmp
c_func
(paren
id|data
comma
id|dccprotos
(braket
id|i
)braket
dot
id|match
comma
id|dccprotos
(braket
id|i
)braket
dot
id|matchlen
)paren
)paren
(brace
multiline_comment|/* no match */
r_continue
suffix:semicolon
)brace
id|DEBUGP
c_func
(paren
l_string|&quot;DCC %s detected&bslash;n&quot;
comma
id|dccprotos
(braket
id|i
)braket
dot
id|match
)paren
suffix:semicolon
id|data
op_add_assign
id|dccprotos
(braket
id|i
)braket
dot
id|matchlen
suffix:semicolon
r_if
c_cond
(paren
id|parse_dcc
c_func
(paren
(paren
r_char
op_star
)paren
id|data
comma
id|data_limit
comma
op_amp
id|dcc_ip
comma
op_amp
id|dcc_port
comma
op_amp
id|addr_beg_p
comma
op_amp
id|addr_end_p
)paren
)paren
(brace
multiline_comment|/* unable to parse */
id|DEBUGP
c_func
(paren
l_string|&quot;unable to parse dcc command&bslash;n&quot;
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|DEBUGP
c_func
(paren
l_string|&quot;DCC bound ip/port: %u.%u.%u.%u:%u&bslash;n&quot;
comma
id|HIPQUAD
c_func
(paren
id|dcc_ip
)paren
comma
id|dcc_port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ct-&gt;tuplehash
(braket
id|dir
)braket
dot
id|tuple.src.ip
op_ne
id|htonl
c_func
(paren
id|dcc_ip
)paren
)paren
(brace
r_if
c_cond
(paren
id|net_ratelimit
c_func
(paren
)paren
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Forged DCC command from &quot;
l_string|&quot;%u.%u.%u.%u: %u.%u.%u.%u:%u&bslash;n&quot;
comma
id|NIPQUAD
c_func
(paren
id|ct-&gt;tuplehash
(braket
id|dir
)braket
dot
id|tuple.src.ip
)paren
comma
id|HIPQUAD
c_func
(paren
id|dcc_ip
)paren
comma
id|dcc_port
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|LOCK_BH
c_func
(paren
op_amp
id|ip_irc_lock
)paren
suffix:semicolon
multiline_comment|/* save position of address in dcc string,&n;&t;&t;&t; * neccessary for NAT */
id|info-&gt;is_irc
op_assign
id|IP_CONNTR_IRC
suffix:semicolon
id|DEBUGP
c_func
(paren
l_string|&quot;tcph-&gt;seq = %u&bslash;n&quot;
comma
id|tcph-&gt;seq
)paren
suffix:semicolon
id|info-&gt;seq
op_assign
id|ntohl
c_func
(paren
id|tcph-&gt;seq
)paren
op_plus
(paren
id|addr_beg_p
op_minus
id|_data
)paren
suffix:semicolon
id|info-&gt;len
op_assign
(paren
id|addr_end_p
op_minus
id|addr_beg_p
)paren
suffix:semicolon
id|info-&gt;port
op_assign
id|dcc_port
suffix:semicolon
id|DEBUGP
c_func
(paren
l_string|&quot;wrote info seq=%u (ofs=%u), len=%d&bslash;n&quot;
comma
id|info-&gt;seq
comma
(paren
id|addr_end_p
op_minus
id|_data
)paren
comma
id|info-&gt;len
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|t
comma
l_int|0
comma
r_sizeof
(paren
id|t
)paren
)paren
suffix:semicolon
id|t.src.ip
op_assign
l_int|0
suffix:semicolon
id|t.src.u.tcp.port
op_assign
l_int|0
suffix:semicolon
id|t.dst.ip
op_assign
id|htonl
c_func
(paren
id|dcc_ip
)paren
suffix:semicolon
id|t.dst.u.tcp.port
op_assign
id|htons
c_func
(paren
id|info-&gt;port
)paren
suffix:semicolon
id|t.dst.protonum
op_assign
id|IPPROTO_TCP
suffix:semicolon
id|DEBUGP
c_func
(paren
l_string|&quot;expect_related %u.%u.%u.%u:%u-%u.%u.%u.%u:%u&bslash;n&quot;
comma
id|NIPQUAD
c_func
(paren
id|t.src.ip
)paren
comma
id|ntohs
c_func
(paren
id|t.src.u.tcp.port
)paren
comma
id|NIPQUAD
c_func
(paren
id|t.dst.ip
)paren
comma
id|ntohs
c_func
(paren
id|t.dst.u.tcp.port
)paren
)paren
suffix:semicolon
id|ip_conntrack_expect_related
c_func
(paren
id|ct
comma
op_amp
id|t
comma
op_amp
id|mask
comma
l_int|NULL
)paren
suffix:semicolon
id|UNLOCK_BH
c_func
(paren
op_amp
id|ip_irc_lock
)paren
suffix:semicolon
r_return
id|NF_ACCEPT
suffix:semicolon
)brace
multiline_comment|/* for .. NUM_DCCPROTO */
)brace
multiline_comment|/* while data &lt; ... */
r_return
id|NF_ACCEPT
suffix:semicolon
)brace
DECL|variable|irc_helpers
r_static
r_struct
id|ip_conntrack_helper
id|irc_helpers
(braket
id|MAX_PORTS
)braket
suffix:semicolon
r_static
r_void
id|fini
c_func
(paren
r_void
)paren
suffix:semicolon
DECL|function|init
r_static
r_int
id|__init
id|init
c_func
(paren
r_void
)paren
(brace
r_int
id|i
comma
id|ret
suffix:semicolon
multiline_comment|/* If no port given, default to standard irc port */
r_if
c_cond
(paren
id|ports
(braket
l_int|0
)braket
op_eq
l_int|0
)paren
id|ports
(braket
l_int|0
)braket
op_assign
l_int|6667
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
id|i
OL
id|MAX_PORTS
)paren
op_logical_and
id|ports
(braket
id|i
)braket
suffix:semicolon
id|i
op_increment
)paren
(brace
id|memset
c_func
(paren
op_amp
id|irc_helpers
(braket
id|i
)braket
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|ip_conntrack_helper
)paren
)paren
suffix:semicolon
id|irc_helpers
(braket
id|i
)braket
dot
id|tuple.src.u.tcp.port
op_assign
id|htons
c_func
(paren
id|ports
(braket
id|i
)braket
)paren
suffix:semicolon
id|irc_helpers
(braket
id|i
)braket
dot
id|tuple.dst.protonum
op_assign
id|IPPROTO_TCP
suffix:semicolon
id|irc_helpers
(braket
id|i
)braket
dot
id|mask.src.u.tcp.port
op_assign
l_int|0xFFFF
suffix:semicolon
id|irc_helpers
(braket
id|i
)braket
dot
id|mask.dst.protonum
op_assign
l_int|0xFFFF
suffix:semicolon
id|irc_helpers
(braket
id|i
)braket
dot
id|help
op_assign
id|help
suffix:semicolon
id|DEBUGP
c_func
(paren
l_string|&quot;port #%d: %d&bslash;n&quot;
comma
id|i
comma
id|ports
(braket
id|i
)braket
)paren
suffix:semicolon
id|ret
op_assign
id|ip_conntrack_helper_register
c_func
(paren
op_amp
id|irc_helpers
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ip_conntrack_irc: ERROR registering port %d&bslash;n&quot;
comma
id|ports
(braket
id|i
)braket
)paren
suffix:semicolon
id|fini
c_func
(paren
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|ports_n_c
op_increment
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* This function is intentionally _NOT_ defined as __exit, because &n; * it is needed by the init function */
DECL|function|fini
r_static
r_void
id|fini
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
(paren
id|i
OL
id|MAX_PORTS
)paren
op_logical_and
id|ports
(braket
id|i
)braket
suffix:semicolon
id|i
op_increment
)paren
(brace
id|DEBUGP
c_func
(paren
l_string|&quot;unregistering port %d&bslash;n&quot;
comma
id|ports
(braket
id|i
)braket
)paren
suffix:semicolon
id|ip_conntrack_helper_unregister
c_func
(paren
op_amp
id|irc_helpers
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
)brace
DECL|variable|init
id|module_init
c_func
(paren
id|init
)paren
suffix:semicolon
DECL|variable|fini
id|module_exit
c_func
(paren
id|fini
)paren
suffix:semicolon
eof
