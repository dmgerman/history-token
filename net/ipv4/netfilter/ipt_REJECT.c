multiline_comment|/*&n; * This is a module which is used for rejecting packets.&n; * Added support for customized reject packets (Jozsef Kadlecsik).&n; * Added support for ICMP type-3-code-13 (Maciej Soltysiak). [RFC 1812]&n; */
multiline_comment|/* (C) 1999-2001 Paul `Rusty&squot; Russell&n; * (C) 2002-2004 Netfilter Core Team &lt;coreteam@netfilter.org&gt;&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License version 2 as&n; * published by the Free Software Foundation.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/ip.h&gt;
macro_line|#include &lt;linux/udp.h&gt;
macro_line|#include &lt;linux/icmp.h&gt;
macro_line|#include &lt;net/icmp.h&gt;
macro_line|#include &lt;net/ip.h&gt;
macro_line|#include &lt;net/tcp.h&gt;
macro_line|#include &lt;net/route.h&gt;
macro_line|#include &lt;net/dst.h&gt;
macro_line|#include &lt;linux/netfilter_ipv4/ip_tables.h&gt;
macro_line|#include &lt;linux/netfilter_ipv4/ipt_REJECT.h&gt;
macro_line|#ifdef CONFIG_BRIDGE_NETFILTER
macro_line|#include &lt;linux/netfilter_bridge.h&gt;
macro_line|#endif
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Netfilter Core Team &lt;coreteam@netfilter.org&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;iptables REJECT target module&quot;
)paren
suffix:semicolon
macro_line|#if 0
mdefine_line|#define DEBUGP printk
macro_line|#else
DECL|macro|DEBUGP
mdefine_line|#define DEBUGP(format, args...)
macro_line|#endif
DECL|function|route_reverse
r_static
r_inline
r_struct
id|rtable
op_star
id|route_reverse
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|tcphdr
op_star
id|tcph
comma
r_int
id|hook
)paren
(brace
r_struct
id|iphdr
op_star
id|iph
op_assign
id|skb-&gt;nh.iph
suffix:semicolon
r_struct
id|dst_entry
op_star
id|odst
suffix:semicolon
r_struct
id|flowi
id|fl
op_assign
(brace
)brace
suffix:semicolon
r_struct
id|rtable
op_star
id|rt
suffix:semicolon
multiline_comment|/* We don&squot;t require ip forwarding to be enabled to be able to&n;&t; * send a RST reply for bridged traffic. */
r_if
c_cond
(paren
id|hook
op_ne
id|NF_IP_FORWARD
macro_line|#ifdef CONFIG_BRIDGE_NETFILTER
op_logical_or
(paren
id|skb-&gt;nf_bridge
op_logical_and
id|skb-&gt;nf_bridge-&gt;mask
op_amp
id|BRNF_BRIDGED
)paren
macro_line|#endif
)paren
(brace
id|fl.nl_u.ip4_u.daddr
op_assign
id|iph-&gt;saddr
suffix:semicolon
r_if
c_cond
(paren
id|hook
op_eq
id|NF_IP_LOCAL_IN
)paren
id|fl.nl_u.ip4_u.saddr
op_assign
id|iph-&gt;daddr
suffix:semicolon
id|fl.nl_u.ip4_u.tos
op_assign
id|RT_TOS
c_func
(paren
id|iph-&gt;tos
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ip_route_output_key
c_func
(paren
op_amp
id|rt
comma
op_amp
id|fl
)paren
op_ne
l_int|0
)paren
r_return
l_int|NULL
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* non-local src, find valid iif to satisfy&n;&t;&t; * rp-filter when calling ip_route_input. */
id|fl.nl_u.ip4_u.daddr
op_assign
id|iph-&gt;daddr
suffix:semicolon
r_if
c_cond
(paren
id|ip_route_output_key
c_func
(paren
op_amp
id|rt
comma
op_amp
id|fl
)paren
op_ne
l_int|0
)paren
r_return
l_int|NULL
suffix:semicolon
id|odst
op_assign
id|skb-&gt;dst
suffix:semicolon
r_if
c_cond
(paren
id|ip_route_input
c_func
(paren
id|skb
comma
id|iph-&gt;saddr
comma
id|iph-&gt;daddr
comma
id|RT_TOS
c_func
(paren
id|iph-&gt;tos
)paren
comma
id|rt-&gt;u.dst.dev
)paren
op_ne
l_int|0
)paren
(brace
id|dst_release
c_func
(paren
op_amp
id|rt-&gt;u.dst
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|dst_release
c_func
(paren
op_amp
id|rt-&gt;u.dst
)paren
suffix:semicolon
id|rt
op_assign
(paren
r_struct
id|rtable
op_star
)paren
id|skb-&gt;dst
suffix:semicolon
id|skb-&gt;dst
op_assign
id|odst
suffix:semicolon
id|fl.nl_u.ip4_u.daddr
op_assign
id|iph-&gt;saddr
suffix:semicolon
id|fl.nl_u.ip4_u.saddr
op_assign
id|iph-&gt;daddr
suffix:semicolon
id|fl.nl_u.ip4_u.tos
op_assign
id|RT_TOS
c_func
(paren
id|iph-&gt;tos
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rt-&gt;u.dst.error
)paren
(brace
id|dst_release
c_func
(paren
op_amp
id|rt-&gt;u.dst
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|fl.proto
op_assign
id|IPPROTO_TCP
suffix:semicolon
id|fl.fl_ip_sport
op_assign
id|tcph-&gt;dest
suffix:semicolon
id|fl.fl_ip_dport
op_assign
id|tcph-&gt;source
suffix:semicolon
r_if
c_cond
(paren
id|xfrm_lookup
c_func
(paren
(paren
r_struct
id|dst_entry
op_star
op_star
)paren
op_amp
id|rt
comma
op_amp
id|fl
comma
l_int|NULL
comma
l_int|0
)paren
)paren
(brace
id|dst_release
c_func
(paren
op_amp
id|rt-&gt;u.dst
)paren
suffix:semicolon
id|rt
op_assign
l_int|NULL
suffix:semicolon
)brace
r_return
id|rt
suffix:semicolon
)brace
multiline_comment|/* Send RST reply */
DECL|function|send_reset
r_static
r_void
id|send_reset
c_func
(paren
r_struct
id|sk_buff
op_star
id|oldskb
comma
r_int
id|hook
)paren
(brace
r_struct
id|sk_buff
op_star
id|nskb
suffix:semicolon
r_struct
id|tcphdr
id|_otcph
comma
op_star
id|oth
comma
op_star
id|tcph
suffix:semicolon
r_struct
id|rtable
op_star
id|rt
suffix:semicolon
id|u_int16_t
id|tmp_port
suffix:semicolon
id|u_int32_t
id|tmp_addr
suffix:semicolon
r_int
id|needs_ack
suffix:semicolon
r_int
id|hh_len
suffix:semicolon
multiline_comment|/* IP header checks: fragment. */
r_if
c_cond
(paren
id|oldskb-&gt;nh.iph-&gt;frag_off
op_amp
id|htons
c_func
(paren
id|IP_OFFSET
)paren
)paren
r_return
suffix:semicolon
id|oth
op_assign
id|skb_header_pointer
c_func
(paren
id|oldskb
comma
id|oldskb-&gt;nh.iph-&gt;ihl
op_star
l_int|4
comma
r_sizeof
(paren
id|_otcph
)paren
comma
op_amp
id|_otcph
)paren
suffix:semicolon
r_if
c_cond
(paren
id|oth
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
multiline_comment|/* No RST for RST. */
r_if
c_cond
(paren
id|oth-&gt;rst
)paren
r_return
suffix:semicolon
multiline_comment|/* FIXME: Check checksum --RR */
r_if
c_cond
(paren
(paren
id|rt
op_assign
id|route_reverse
c_func
(paren
id|oldskb
comma
id|oth
comma
id|hook
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|hh_len
op_assign
id|LL_RESERVED_SPACE
c_func
(paren
id|rt-&gt;u.dst.dev
)paren
suffix:semicolon
multiline_comment|/* We need a linear, writeable skb.  We also need to expand&n;&t;   headroom in case hh_len of incoming interface &lt; hh_len of&n;&t;   outgoing interface */
id|nskb
op_assign
id|skb_copy_expand
c_func
(paren
id|oldskb
comma
id|hh_len
comma
id|skb_tailroom
c_func
(paren
id|oldskb
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|nskb
)paren
(brace
id|dst_release
c_func
(paren
op_amp
id|rt-&gt;u.dst
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|dst_release
c_func
(paren
id|nskb-&gt;dst
)paren
suffix:semicolon
id|nskb-&gt;dst
op_assign
op_amp
id|rt-&gt;u.dst
suffix:semicolon
multiline_comment|/* This packet will not be the same as the other: clear nf fields */
id|nf_reset
c_func
(paren
id|nskb
)paren
suffix:semicolon
id|nskb-&gt;nfcache
op_assign
l_int|0
suffix:semicolon
id|nskb-&gt;nfmark
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef CONFIG_BRIDGE_NETFILTER
id|nf_bridge_put
c_func
(paren
id|nskb-&gt;nf_bridge
)paren
suffix:semicolon
id|nskb-&gt;nf_bridge
op_assign
l_int|NULL
suffix:semicolon
macro_line|#endif
id|tcph
op_assign
(paren
r_struct
id|tcphdr
op_star
)paren
(paren
(paren
id|u_int32_t
op_star
)paren
id|nskb-&gt;nh.iph
op_plus
id|nskb-&gt;nh.iph-&gt;ihl
)paren
suffix:semicolon
multiline_comment|/* Swap source and dest */
id|tmp_addr
op_assign
id|nskb-&gt;nh.iph-&gt;saddr
suffix:semicolon
id|nskb-&gt;nh.iph-&gt;saddr
op_assign
id|nskb-&gt;nh.iph-&gt;daddr
suffix:semicolon
id|nskb-&gt;nh.iph-&gt;daddr
op_assign
id|tmp_addr
suffix:semicolon
id|tmp_port
op_assign
id|tcph-&gt;source
suffix:semicolon
id|tcph-&gt;source
op_assign
id|tcph-&gt;dest
suffix:semicolon
id|tcph-&gt;dest
op_assign
id|tmp_port
suffix:semicolon
multiline_comment|/* Truncate to length (no data) */
id|tcph-&gt;doff
op_assign
r_sizeof
(paren
r_struct
id|tcphdr
)paren
op_div
l_int|4
suffix:semicolon
id|skb_trim
c_func
(paren
id|nskb
comma
id|nskb-&gt;nh.iph-&gt;ihl
op_star
l_int|4
op_plus
r_sizeof
(paren
r_struct
id|tcphdr
)paren
)paren
suffix:semicolon
id|nskb-&gt;nh.iph-&gt;tot_len
op_assign
id|htons
c_func
(paren
id|nskb-&gt;len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tcph-&gt;ack
)paren
(brace
id|needs_ack
op_assign
l_int|0
suffix:semicolon
id|tcph-&gt;seq
op_assign
id|oth-&gt;ack_seq
suffix:semicolon
id|tcph-&gt;ack_seq
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|needs_ack
op_assign
l_int|1
suffix:semicolon
id|tcph-&gt;ack_seq
op_assign
id|htonl
c_func
(paren
id|ntohl
c_func
(paren
id|oth-&gt;seq
)paren
op_plus
id|oth-&gt;syn
op_plus
id|oth-&gt;fin
op_plus
id|oldskb-&gt;len
op_minus
id|oldskb-&gt;nh.iph-&gt;ihl
op_star
l_int|4
op_minus
(paren
id|oth-&gt;doff
op_lshift
l_int|2
)paren
)paren
suffix:semicolon
id|tcph-&gt;seq
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Reset flags */
(paren
(paren
id|u_int8_t
op_star
)paren
id|tcph
)paren
(braket
l_int|13
)braket
op_assign
l_int|0
suffix:semicolon
id|tcph-&gt;rst
op_assign
l_int|1
suffix:semicolon
id|tcph-&gt;ack
op_assign
id|needs_ack
suffix:semicolon
id|tcph-&gt;window
op_assign
l_int|0
suffix:semicolon
id|tcph-&gt;urg_ptr
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Adjust TCP checksum */
id|tcph-&gt;check
op_assign
l_int|0
suffix:semicolon
id|tcph-&gt;check
op_assign
id|tcp_v4_check
c_func
(paren
id|tcph
comma
r_sizeof
(paren
r_struct
id|tcphdr
)paren
comma
id|nskb-&gt;nh.iph-&gt;saddr
comma
id|nskb-&gt;nh.iph-&gt;daddr
comma
id|csum_partial
c_func
(paren
(paren
r_char
op_star
)paren
id|tcph
comma
r_sizeof
(paren
r_struct
id|tcphdr
)paren
comma
l_int|0
)paren
)paren
suffix:semicolon
multiline_comment|/* Adjust IP TTL, DF */
id|nskb-&gt;nh.iph-&gt;ttl
op_assign
id|MAXTTL
suffix:semicolon
multiline_comment|/* Set DF, id = 0 */
id|nskb-&gt;nh.iph-&gt;frag_off
op_assign
id|htons
c_func
(paren
id|IP_DF
)paren
suffix:semicolon
id|nskb-&gt;nh.iph-&gt;id
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Adjust IP checksum */
id|nskb-&gt;nh.iph-&gt;check
op_assign
l_int|0
suffix:semicolon
id|nskb-&gt;nh.iph-&gt;check
op_assign
id|ip_fast_csum
c_func
(paren
(paren
r_int
r_char
op_star
)paren
id|nskb-&gt;nh.iph
comma
id|nskb-&gt;nh.iph-&gt;ihl
)paren
suffix:semicolon
multiline_comment|/* &quot;Never happens&quot; */
r_if
c_cond
(paren
id|nskb-&gt;len
OG
id|dst_mtu
c_func
(paren
id|nskb-&gt;dst
)paren
)paren
r_goto
id|free_nskb
suffix:semicolon
id|nf_ct_attach
c_func
(paren
id|nskb
comma
id|oldskb
)paren
suffix:semicolon
id|NF_HOOK
c_func
(paren
id|PF_INET
comma
id|NF_IP_LOCAL_OUT
comma
id|nskb
comma
l_int|NULL
comma
id|nskb-&gt;dst-&gt;dev
comma
id|dst_output
)paren
suffix:semicolon
r_return
suffix:semicolon
id|free_nskb
suffix:colon
id|kfree_skb
c_func
(paren
id|nskb
)paren
suffix:semicolon
)brace
DECL|function|send_unreach
r_static
r_inline
r_void
id|send_unreach
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb_in
comma
r_int
id|code
)paren
(brace
id|icmp_send
c_func
(paren
id|skb_in
comma
id|ICMP_DEST_UNREACH
comma
id|code
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|reject
r_static
r_int
r_int
id|reject
c_func
(paren
r_struct
id|sk_buff
op_star
op_star
id|pskb
comma
r_const
r_struct
id|net_device
op_star
id|in
comma
r_const
r_struct
id|net_device
op_star
id|out
comma
r_int
r_int
id|hooknum
comma
r_const
r_void
op_star
id|targinfo
comma
r_void
op_star
id|userinfo
)paren
(brace
r_const
r_struct
id|ipt_reject_info
op_star
id|reject
op_assign
id|targinfo
suffix:semicolon
multiline_comment|/* Our naive response construction doesn&squot;t deal with IP&n;           options, and probably shouldn&squot;t try. */
r_if
c_cond
(paren
(paren
op_star
id|pskb
)paren
op_member_access_from_pointer
id|nh.iph-&gt;ihl
op_lshift
l_int|2
op_ne
r_sizeof
(paren
r_struct
id|iphdr
)paren
)paren
r_return
id|NF_DROP
suffix:semicolon
multiline_comment|/* WARNING: This code causes reentry within iptables.&n;&t;   This means that the iptables jump stack is now crap.  We&n;&t;   must return an absolute verdict. --RR */
r_switch
c_cond
(paren
id|reject-&gt;with
)paren
(brace
r_case
id|IPT_ICMP_NET_UNREACHABLE
suffix:colon
id|send_unreach
c_func
(paren
op_star
id|pskb
comma
id|ICMP_NET_UNREACH
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPT_ICMP_HOST_UNREACHABLE
suffix:colon
id|send_unreach
c_func
(paren
op_star
id|pskb
comma
id|ICMP_HOST_UNREACH
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPT_ICMP_PROT_UNREACHABLE
suffix:colon
id|send_unreach
c_func
(paren
op_star
id|pskb
comma
id|ICMP_PROT_UNREACH
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPT_ICMP_PORT_UNREACHABLE
suffix:colon
id|send_unreach
c_func
(paren
op_star
id|pskb
comma
id|ICMP_PORT_UNREACH
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPT_ICMP_NET_PROHIBITED
suffix:colon
id|send_unreach
c_func
(paren
op_star
id|pskb
comma
id|ICMP_NET_ANO
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPT_ICMP_HOST_PROHIBITED
suffix:colon
id|send_unreach
c_func
(paren
op_star
id|pskb
comma
id|ICMP_HOST_ANO
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPT_ICMP_ADMIN_PROHIBITED
suffix:colon
id|send_unreach
c_func
(paren
op_star
id|pskb
comma
id|ICMP_PKT_FILTERED
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPT_TCP_RESET
suffix:colon
id|send_reset
c_func
(paren
op_star
id|pskb
comma
id|hooknum
)paren
suffix:semicolon
r_case
id|IPT_ICMP_ECHOREPLY
suffix:colon
multiline_comment|/* Doesn&squot;t happen. */
r_break
suffix:semicolon
)brace
r_return
id|NF_DROP
suffix:semicolon
)brace
DECL|function|check
r_static
r_int
id|check
c_func
(paren
r_const
r_char
op_star
id|tablename
comma
r_const
r_struct
id|ipt_entry
op_star
id|e
comma
r_void
op_star
id|targinfo
comma
r_int
r_int
id|targinfosize
comma
r_int
r_int
id|hook_mask
)paren
(brace
r_const
r_struct
id|ipt_reject_info
op_star
id|rejinfo
op_assign
id|targinfo
suffix:semicolon
r_if
c_cond
(paren
id|targinfosize
op_ne
id|IPT_ALIGN
c_func
(paren
r_sizeof
(paren
r_struct
id|ipt_reject_info
)paren
)paren
)paren
(brace
id|DEBUGP
c_func
(paren
l_string|&quot;REJECT: targinfosize %u != 0&bslash;n&quot;
comma
id|targinfosize
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Only allow these for packet filtering. */
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|tablename
comma
l_string|&quot;filter&quot;
)paren
op_ne
l_int|0
)paren
(brace
id|DEBUGP
c_func
(paren
l_string|&quot;REJECT: bad table `%s&squot;.&bslash;n&quot;
comma
id|tablename
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|hook_mask
op_amp
op_complement
(paren
(paren
l_int|1
op_lshift
id|NF_IP_LOCAL_IN
)paren
op_or
(paren
l_int|1
op_lshift
id|NF_IP_FORWARD
)paren
op_or
(paren
l_int|1
op_lshift
id|NF_IP_LOCAL_OUT
)paren
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|DEBUGP
c_func
(paren
l_string|&quot;REJECT: bad hook mask %X&bslash;n&quot;
comma
id|hook_mask
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rejinfo-&gt;with
op_eq
id|IPT_ICMP_ECHOREPLY
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;REJECT: ECHOREPLY no longer supported.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|rejinfo-&gt;with
op_eq
id|IPT_TCP_RESET
)paren
(brace
multiline_comment|/* Must specify that it&squot;s a TCP packet */
r_if
c_cond
(paren
id|e-&gt;ip.proto
op_ne
id|IPPROTO_TCP
op_logical_or
(paren
id|e-&gt;ip.invflags
op_amp
id|IPT_INV_PROTO
)paren
)paren
(brace
id|DEBUGP
c_func
(paren
l_string|&quot;REJECT: TCP_RESET invalid for non-tcp&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_return
l_int|1
suffix:semicolon
)brace
DECL|variable|ipt_reject_reg
r_static
r_struct
id|ipt_target
id|ipt_reject_reg
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;REJECT&quot;
comma
dot
id|target
op_assign
id|reject
comma
dot
id|checkentry
op_assign
id|check
comma
dot
id|me
op_assign
id|THIS_MODULE
comma
)brace
suffix:semicolon
DECL|function|init
r_static
r_int
id|__init
id|init
c_func
(paren
r_void
)paren
(brace
r_return
id|ipt_register_target
c_func
(paren
op_amp
id|ipt_reject_reg
)paren
suffix:semicolon
)brace
DECL|function|fini
r_static
r_void
id|__exit
id|fini
c_func
(paren
r_void
)paren
(brace
id|ipt_unregister_target
c_func
(paren
op_amp
id|ipt_reject_reg
)paren
suffix:semicolon
)brace
DECL|variable|init
id|module_init
c_func
(paren
id|init
)paren
suffix:semicolon
DECL|variable|fini
id|module_exit
c_func
(paren
id|fini
)paren
suffix:semicolon
eof
