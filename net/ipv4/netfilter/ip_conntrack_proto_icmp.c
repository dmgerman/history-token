multiline_comment|/* (C) 1999-2001 Paul `Rusty&squot; Russell&n; * (C) 2002-2004 Netfilter Core Team &lt;coreteam@netfilter.org&gt;&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License version 2 as&n; * published by the Free Software Foundation.&n; */
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/netfilter.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/icmp.h&gt;
macro_line|#include &lt;net/ip.h&gt;
macro_line|#include &lt;net/checksum.h&gt;
macro_line|#include &lt;linux/netfilter.h&gt;
macro_line|#include &lt;linux/netfilter_ipv4/ip_conntrack.h&gt;
macro_line|#include &lt;linux/netfilter_ipv4/ip_conntrack_core.h&gt;
macro_line|#include &lt;linux/netfilter_ipv4/ip_conntrack_protocol.h&gt;
DECL|variable|ip_ct_icmp_timeout
r_int
r_int
id|ip_ct_icmp_timeout
op_assign
l_int|30
op_star
id|HZ
suffix:semicolon
macro_line|#if 0
mdefine_line|#define DEBUGP printk
macro_line|#else
DECL|macro|DEBUGP
mdefine_line|#define DEBUGP(format, args...)
macro_line|#endif
DECL|function|icmp_pkt_to_tuple
r_static
r_int
id|icmp_pkt_to_tuple
c_func
(paren
r_const
r_struct
id|sk_buff
op_star
id|skb
comma
r_int
r_int
id|dataoff
comma
r_struct
id|ip_conntrack_tuple
op_star
id|tuple
)paren
(brace
r_struct
id|icmphdr
id|_hdr
comma
op_star
id|hp
suffix:semicolon
id|hp
op_assign
id|skb_header_pointer
c_func
(paren
id|skb
comma
id|dataoff
comma
r_sizeof
(paren
id|_hdr
)paren
comma
op_amp
id|_hdr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hp
op_eq
l_int|NULL
)paren
r_return
l_int|0
suffix:semicolon
id|tuple-&gt;dst.u.icmp.type
op_assign
id|hp-&gt;type
suffix:semicolon
id|tuple-&gt;src.u.icmp.id
op_assign
id|hp-&gt;un.echo.id
suffix:semicolon
id|tuple-&gt;dst.u.icmp.code
op_assign
id|hp-&gt;code
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|icmp_invert_tuple
r_static
r_int
id|icmp_invert_tuple
c_func
(paren
r_struct
id|ip_conntrack_tuple
op_star
id|tuple
comma
r_const
r_struct
id|ip_conntrack_tuple
op_star
id|orig
)paren
(brace
multiline_comment|/* Add 1; spaces filled with 0. */
r_static
id|u_int8_t
id|invmap
(braket
)braket
op_assign
(brace
(braket
id|ICMP_ECHO
)braket
op_assign
id|ICMP_ECHOREPLY
op_plus
l_int|1
comma
(braket
id|ICMP_ECHOREPLY
)braket
op_assign
id|ICMP_ECHO
op_plus
l_int|1
comma
(braket
id|ICMP_TIMESTAMP
)braket
op_assign
id|ICMP_TIMESTAMPREPLY
op_plus
l_int|1
comma
(braket
id|ICMP_TIMESTAMPREPLY
)braket
op_assign
id|ICMP_TIMESTAMP
op_plus
l_int|1
comma
(braket
id|ICMP_INFO_REQUEST
)braket
op_assign
id|ICMP_INFO_REPLY
op_plus
l_int|1
comma
(braket
id|ICMP_INFO_REPLY
)braket
op_assign
id|ICMP_INFO_REQUEST
op_plus
l_int|1
comma
(braket
id|ICMP_ADDRESS
)braket
op_assign
id|ICMP_ADDRESSREPLY
op_plus
l_int|1
comma
(braket
id|ICMP_ADDRESSREPLY
)braket
op_assign
id|ICMP_ADDRESS
op_plus
l_int|1
)brace
suffix:semicolon
r_if
c_cond
(paren
id|orig-&gt;dst.u.icmp.type
op_ge
r_sizeof
(paren
id|invmap
)paren
op_logical_or
op_logical_neg
id|invmap
(braket
id|orig-&gt;dst.u.icmp.type
)braket
)paren
r_return
l_int|0
suffix:semicolon
id|tuple-&gt;src.u.icmp.id
op_assign
id|orig-&gt;src.u.icmp.id
suffix:semicolon
id|tuple-&gt;dst.u.icmp.type
op_assign
id|invmap
(braket
id|orig-&gt;dst.u.icmp.type
)braket
op_minus
l_int|1
suffix:semicolon
id|tuple-&gt;dst.u.icmp.code
op_assign
id|orig-&gt;dst.u.icmp.code
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Print out the per-protocol part of the tuple. */
DECL|function|icmp_print_tuple
r_static
r_int
r_int
id|icmp_print_tuple
c_func
(paren
r_char
op_star
id|buffer
comma
r_const
r_struct
id|ip_conntrack_tuple
op_star
id|tuple
)paren
(brace
r_return
id|sprintf
c_func
(paren
id|buffer
comma
l_string|&quot;type=%u code=%u id=%u &quot;
comma
id|tuple-&gt;dst.u.icmp.type
comma
id|tuple-&gt;dst.u.icmp.code
comma
id|ntohs
c_func
(paren
id|tuple-&gt;src.u.icmp.id
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Print out the private part of the conntrack. */
DECL|function|icmp_print_conntrack
r_static
r_int
r_int
id|icmp_print_conntrack
c_func
(paren
r_char
op_star
id|buffer
comma
r_const
r_struct
id|ip_conntrack
op_star
id|conntrack
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Returns verdict for packet, or -1 for invalid. */
DECL|function|icmp_packet
r_static
r_int
id|icmp_packet
c_func
(paren
r_struct
id|ip_conntrack
op_star
id|ct
comma
r_const
r_struct
id|sk_buff
op_star
id|skb
comma
r_enum
id|ip_conntrack_info
id|ctinfo
)paren
(brace
multiline_comment|/* Try to delete connection immediately after all replies:&n;           won&squot;t actually vanish as we still have skb, and del_timer&n;           means this will only run once even if count hits zero twice&n;           (theoretically possible with SMP) */
r_if
c_cond
(paren
id|CTINFO2DIR
c_func
(paren
id|ctinfo
)paren
op_eq
id|IP_CT_DIR_REPLY
)paren
(brace
r_if
c_cond
(paren
id|atomic_dec_and_test
c_func
(paren
op_amp
id|ct-&gt;proto.icmp.count
)paren
op_logical_and
id|del_timer
c_func
(paren
op_amp
id|ct-&gt;timeout
)paren
)paren
id|ct-&gt;timeout
dot
id|function
c_func
(paren
(paren
r_int
r_int
)paren
id|ct
)paren
suffix:semicolon
)brace
r_else
(brace
id|atomic_inc
c_func
(paren
op_amp
id|ct-&gt;proto.icmp.count
)paren
suffix:semicolon
id|ip_ct_refresh_acct
c_func
(paren
id|ct
comma
id|ctinfo
comma
id|skb
comma
id|ip_ct_icmp_timeout
)paren
suffix:semicolon
)brace
r_return
id|NF_ACCEPT
suffix:semicolon
)brace
multiline_comment|/* Called when a new connection for this protocol found. */
DECL|function|icmp_new
r_static
r_int
id|icmp_new
c_func
(paren
r_struct
id|ip_conntrack
op_star
id|conntrack
comma
r_const
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_static
id|u_int8_t
id|valid_new
(braket
)braket
op_assign
(brace
(braket
id|ICMP_ECHO
)braket
op_assign
l_int|1
comma
(braket
id|ICMP_TIMESTAMP
)braket
op_assign
l_int|1
comma
(braket
id|ICMP_INFO_REQUEST
)braket
op_assign
l_int|1
comma
(braket
id|ICMP_ADDRESS
)braket
op_assign
l_int|1
)brace
suffix:semicolon
r_if
c_cond
(paren
id|conntrack-&gt;tuplehash
(braket
l_int|0
)braket
dot
id|tuple.dst.u.icmp.type
op_ge
r_sizeof
(paren
id|valid_new
)paren
op_logical_or
op_logical_neg
id|valid_new
(braket
id|conntrack-&gt;tuplehash
(braket
l_int|0
)braket
dot
id|tuple.dst.u.icmp.type
)braket
)paren
(brace
multiline_comment|/* Can&squot;t create a new ICMP `conn&squot; with this. */
id|DEBUGP
c_func
(paren
l_string|&quot;icmp: can&squot;t create new conn with type %u&bslash;n&quot;
comma
id|conntrack-&gt;tuplehash
(braket
l_int|0
)braket
dot
id|tuple.dst.u.icmp.type
)paren
suffix:semicolon
id|DUMP_TUPLE
c_func
(paren
op_amp
id|conntrack-&gt;tuplehash
(braket
l_int|0
)braket
dot
id|tuple
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|atomic_set
c_func
(paren
op_amp
id|conntrack-&gt;proto.icmp.count
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_static
r_int
DECL|function|icmp_error_message
id|icmp_error_message
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_enum
id|ip_conntrack_info
op_star
id|ctinfo
comma
r_int
r_int
id|hooknum
)paren
(brace
r_struct
id|ip_conntrack_tuple
id|innertuple
comma
id|origtuple
suffix:semicolon
r_struct
(brace
r_struct
id|icmphdr
id|icmp
suffix:semicolon
r_struct
id|iphdr
id|ip
suffix:semicolon
)brace
id|inside
suffix:semicolon
r_struct
id|ip_conntrack_protocol
op_star
id|innerproto
suffix:semicolon
r_struct
id|ip_conntrack_tuple_hash
op_star
id|h
suffix:semicolon
r_int
id|dataoff
suffix:semicolon
id|IP_NF_ASSERT
c_func
(paren
id|skb-&gt;nfct
op_eq
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/* Not enough header? */
r_if
c_cond
(paren
id|skb_copy_bits
c_func
(paren
id|skb
comma
id|skb-&gt;nh.iph-&gt;ihl
op_star
l_int|4
comma
op_amp
id|inside
comma
r_sizeof
(paren
id|inside
)paren
)paren
op_ne
l_int|0
)paren
r_return
id|NF_ACCEPT
suffix:semicolon
multiline_comment|/* Ignore ICMP&squot;s containing fragments (shouldn&squot;t happen) */
r_if
c_cond
(paren
id|inside.ip.frag_off
op_amp
id|htons
c_func
(paren
id|IP_OFFSET
)paren
)paren
(brace
id|DEBUGP
c_func
(paren
l_string|&quot;icmp_error_track: fragment of proto %u&bslash;n&quot;
comma
id|inside.ip.protocol
)paren
suffix:semicolon
r_return
id|NF_ACCEPT
suffix:semicolon
)brace
id|innerproto
op_assign
id|ip_ct_find_proto
c_func
(paren
id|inside.ip.protocol
)paren
suffix:semicolon
id|dataoff
op_assign
id|skb-&gt;nh.iph-&gt;ihl
op_star
l_int|4
op_plus
r_sizeof
(paren
id|inside.icmp
)paren
op_plus
id|inside.ip.ihl
op_star
l_int|4
suffix:semicolon
multiline_comment|/* Are they talking about one of our connections? */
r_if
c_cond
(paren
op_logical_neg
id|ip_ct_get_tuple
c_func
(paren
op_amp
id|inside.ip
comma
id|skb
comma
id|dataoff
comma
op_amp
id|origtuple
comma
id|innerproto
)paren
)paren
(brace
id|DEBUGP
c_func
(paren
l_string|&quot;icmp_error: ! get_tuple p=%u&quot;
comma
id|inside.ip.protocol
)paren
suffix:semicolon
r_return
id|NF_ACCEPT
suffix:semicolon
)brace
multiline_comment|/* Ordinarily, we&squot;d expect the inverted tupleproto, but it&squot;s&n;&t;   been preserved inside the ICMP. */
r_if
c_cond
(paren
op_logical_neg
id|ip_ct_invert_tuple
c_func
(paren
op_amp
id|innertuple
comma
op_amp
id|origtuple
comma
id|innerproto
)paren
)paren
(brace
id|DEBUGP
c_func
(paren
l_string|&quot;icmp_error_track: Can&squot;t invert tuple&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|NF_ACCEPT
suffix:semicolon
)brace
op_star
id|ctinfo
op_assign
id|IP_CT_RELATED
suffix:semicolon
id|h
op_assign
id|ip_conntrack_find_get
c_func
(paren
op_amp
id|innertuple
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|h
)paren
(brace
multiline_comment|/* Locally generated ICMPs will match inverted if they&n;&t;&t;   haven&squot;t been SNAT&squot;ed yet */
multiline_comment|/* FIXME: NAT code has to handle half-done double NAT --RR */
r_if
c_cond
(paren
id|hooknum
op_eq
id|NF_IP_LOCAL_OUT
)paren
id|h
op_assign
id|ip_conntrack_find_get
c_func
(paren
op_amp
id|origtuple
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|h
)paren
(brace
id|DEBUGP
c_func
(paren
l_string|&quot;icmp_error_track: no match&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|NF_ACCEPT
suffix:semicolon
)brace
multiline_comment|/* Reverse direction from that found */
r_if
c_cond
(paren
id|DIRECTION
c_func
(paren
id|h
)paren
op_ne
id|IP_CT_DIR_REPLY
)paren
op_star
id|ctinfo
op_add_assign
id|IP_CT_IS_REPLY
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|DIRECTION
c_func
(paren
id|h
)paren
op_eq
id|IP_CT_DIR_REPLY
)paren
op_star
id|ctinfo
op_add_assign
id|IP_CT_IS_REPLY
suffix:semicolon
)brace
multiline_comment|/* Update skb to refer to this connection */
id|skb-&gt;nfct
op_assign
op_amp
id|h-&gt;ctrack-&gt;infos
(braket
op_star
id|ctinfo
)braket
suffix:semicolon
r_return
op_minus
id|NF_ACCEPT
suffix:semicolon
)brace
multiline_comment|/* Small and modified version of icmp_rcv */
r_static
r_int
DECL|function|icmp_error
id|icmp_error
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_enum
id|ip_conntrack_info
op_star
id|ctinfo
comma
r_int
r_int
id|hooknum
)paren
(brace
r_struct
id|icmphdr
id|icmph
suffix:semicolon
multiline_comment|/* Not enough header? */
r_if
c_cond
(paren
id|skb_copy_bits
c_func
(paren
id|skb
comma
id|skb-&gt;nh.iph-&gt;ihl
op_star
l_int|4
comma
op_amp
id|icmph
comma
r_sizeof
(paren
id|icmph
)paren
)paren
op_ne
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|LOG_INVALID
c_func
(paren
id|IPPROTO_ICMP
)paren
)paren
id|nf_log_packet
c_func
(paren
id|PF_INET
comma
l_int|0
comma
id|skb
comma
l_int|NULL
comma
l_int|NULL
comma
l_string|&quot;ip_ct_icmp: short packet &quot;
)paren
suffix:semicolon
r_return
op_minus
id|NF_ACCEPT
suffix:semicolon
)brace
multiline_comment|/* See ip_conntrack_proto_tcp.c */
r_if
c_cond
(paren
id|hooknum
op_ne
id|NF_IP_PRE_ROUTING
)paren
r_goto
id|checksum_skipped
suffix:semicolon
r_switch
c_cond
(paren
id|skb-&gt;ip_summed
)paren
(brace
r_case
id|CHECKSUM_HW
suffix:colon
r_if
c_cond
(paren
op_logical_neg
(paren
id|u16
)paren
id|csum_fold
c_func
(paren
id|skb-&gt;csum
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|LOG_INVALID
c_func
(paren
id|IPPROTO_ICMP
)paren
)paren
id|nf_log_packet
c_func
(paren
id|PF_INET
comma
l_int|0
comma
id|skb
comma
l_int|NULL
comma
l_int|NULL
comma
l_string|&quot;ip_ct_icmp: bad HW ICMP checksum &quot;
)paren
suffix:semicolon
r_return
op_minus
id|NF_ACCEPT
suffix:semicolon
r_case
id|CHECKSUM_NONE
suffix:colon
r_if
c_cond
(paren
(paren
id|u16
)paren
id|csum_fold
c_func
(paren
id|skb_checksum
c_func
(paren
id|skb
comma
l_int|0
comma
id|skb-&gt;len
comma
l_int|0
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|LOG_INVALID
c_func
(paren
id|IPPROTO_ICMP
)paren
)paren
id|nf_log_packet
c_func
(paren
id|PF_INET
comma
l_int|0
comma
id|skb
comma
l_int|NULL
comma
l_int|NULL
comma
l_string|&quot;ip_ct_icmp: bad ICMP checksum &quot;
)paren
suffix:semicolon
r_return
op_minus
id|NF_ACCEPT
suffix:semicolon
)brace
r_default
suffix:colon
r_break
suffix:semicolon
)brace
id|checksum_skipped
suffix:colon
multiline_comment|/*&n;&t; *&t;18 is the highest &squot;known&squot; ICMP type. Anything else is a mystery&n;&t; *&n;&t; *&t;RFC 1122: 3.2.2  Unknown ICMP messages types MUST be silently&n;&t; *&t;&t;  discarded.&n;&t; */
r_if
c_cond
(paren
id|icmph.type
OG
id|NR_ICMP_TYPES
)paren
(brace
r_if
c_cond
(paren
id|LOG_INVALID
c_func
(paren
id|IPPROTO_ICMP
)paren
)paren
id|nf_log_packet
c_func
(paren
id|PF_INET
comma
l_int|0
comma
id|skb
comma
l_int|NULL
comma
l_int|NULL
comma
l_string|&quot;ip_ct_icmp: invalid ICMP type &quot;
)paren
suffix:semicolon
r_return
op_minus
id|NF_ACCEPT
suffix:semicolon
)brace
multiline_comment|/* Need to track icmp error message? */
r_if
c_cond
(paren
id|icmph.type
op_ne
id|ICMP_DEST_UNREACH
op_logical_and
id|icmph.type
op_ne
id|ICMP_SOURCE_QUENCH
op_logical_and
id|icmph.type
op_ne
id|ICMP_TIME_EXCEEDED
op_logical_and
id|icmph.type
op_ne
id|ICMP_PARAMETERPROB
op_logical_and
id|icmph.type
op_ne
id|ICMP_REDIRECT
)paren
r_return
id|NF_ACCEPT
suffix:semicolon
r_return
id|icmp_error_message
c_func
(paren
id|skb
comma
id|ctinfo
comma
id|hooknum
)paren
suffix:semicolon
)brace
DECL|variable|ip_conntrack_protocol_icmp
r_struct
id|ip_conntrack_protocol
id|ip_conntrack_protocol_icmp
op_assign
(brace
dot
id|proto
op_assign
id|IPPROTO_ICMP
comma
dot
id|name
op_assign
l_string|&quot;icmp&quot;
comma
dot
id|pkt_to_tuple
op_assign
id|icmp_pkt_to_tuple
comma
dot
id|invert_tuple
op_assign
id|icmp_invert_tuple
comma
dot
id|print_tuple
op_assign
id|icmp_print_tuple
comma
dot
id|print_conntrack
op_assign
id|icmp_print_conntrack
comma
dot
id|packet
op_assign
id|icmp_packet
comma
dot
r_new
op_assign
id|icmp_new
comma
dot
id|error
op_assign
id|icmp_error
comma
)brace
suffix:semicolon
eof
