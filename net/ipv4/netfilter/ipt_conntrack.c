multiline_comment|/* Kernel module to match connection tracking information.&n; * Superset of Rusty&squot;s minimalistic state match.&n; * GPL (C) 2001  Marc Boucher (marc@mbsi.ca).&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/netfilter_ipv4/ip_conntrack.h&gt;
macro_line|#include &lt;linux/netfilter_ipv4/ip_tables.h&gt;
macro_line|#include &lt;linux/netfilter_ipv4/ipt_conntrack.h&gt;
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Marc Boucher &lt;marc@mbsi.ca&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;iptables connection tracking match module&quot;
)paren
suffix:semicolon
r_static
r_int
DECL|function|match
id|match
c_func
(paren
r_const
r_struct
id|sk_buff
op_star
id|skb
comma
r_const
r_struct
id|net_device
op_star
id|in
comma
r_const
r_struct
id|net_device
op_star
id|out
comma
r_const
r_void
op_star
id|matchinfo
comma
r_int
id|offset
comma
r_int
op_star
id|hotdrop
)paren
(brace
r_const
r_struct
id|ipt_conntrack_info
op_star
id|sinfo
op_assign
id|matchinfo
suffix:semicolon
r_struct
id|ip_conntrack
op_star
id|ct
suffix:semicolon
r_enum
id|ip_conntrack_info
id|ctinfo
suffix:semicolon
r_int
r_int
id|statebit
suffix:semicolon
id|ct
op_assign
id|ip_conntrack_get
c_func
(paren
(paren
r_struct
id|sk_buff
op_star
)paren
id|skb
comma
op_amp
id|ctinfo
)paren
suffix:semicolon
DECL|macro|FWINV
mdefine_line|#define FWINV(bool,invflg) ((bool) ^ !!(sinfo-&gt;invflags &amp; invflg))
r_if
c_cond
(paren
id|ct
)paren
id|statebit
op_assign
id|IPT_CONNTRACK_STATE_BIT
c_func
(paren
id|ctinfo
)paren
suffix:semicolon
r_else
id|statebit
op_assign
id|IPT_CONNTRACK_STATE_INVALID
suffix:semicolon
r_if
c_cond
(paren
id|sinfo-&gt;flags
op_amp
id|IPT_CONNTRACK_STATE
)paren
(brace
r_if
c_cond
(paren
id|ct
)paren
(brace
r_if
c_cond
(paren
id|ct-&gt;tuplehash
(braket
id|IP_CT_DIR_ORIGINAL
)braket
dot
id|tuple.src.ip
op_ne
id|ct-&gt;tuplehash
(braket
id|IP_CT_DIR_REPLY
)braket
dot
id|tuple.dst.ip
)paren
(brace
id|statebit
op_or_assign
id|IPT_CONNTRACK_STATE_SNAT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ct-&gt;tuplehash
(braket
id|IP_CT_DIR_ORIGINAL
)braket
dot
id|tuple.dst.ip
op_ne
id|ct-&gt;tuplehash
(braket
id|IP_CT_DIR_REPLY
)braket
dot
id|tuple.src.ip
)paren
(brace
id|statebit
op_or_assign
id|IPT_CONNTRACK_STATE_DNAT
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|FWINV
c_func
(paren
(paren
id|statebit
op_amp
id|sinfo-&gt;statemask
)paren
op_eq
l_int|0
comma
id|IPT_CONNTRACK_STATE
)paren
)paren
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sinfo-&gt;flags
op_amp
id|IPT_CONNTRACK_PROTO
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ct
op_logical_or
id|FWINV
c_func
(paren
id|ct-&gt;tuplehash
(braket
id|IP_CT_DIR_ORIGINAL
)braket
dot
id|tuple.dst.protonum
op_ne
id|sinfo-&gt;tuple
(braket
id|IP_CT_DIR_ORIGINAL
)braket
dot
id|dst.protonum
comma
id|IPT_CONNTRACK_PROTO
)paren
)paren
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sinfo-&gt;flags
op_amp
id|IPT_CONNTRACK_ORIGSRC
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ct
op_logical_or
id|FWINV
c_func
(paren
(paren
id|ct-&gt;tuplehash
(braket
id|IP_CT_DIR_ORIGINAL
)braket
dot
id|tuple.src.ip
op_amp
id|sinfo-&gt;sipmsk
(braket
id|IP_CT_DIR_ORIGINAL
)braket
dot
id|s_addr
)paren
op_ne
id|sinfo-&gt;tuple
(braket
id|IP_CT_DIR_ORIGINAL
)braket
dot
id|src.ip
comma
id|IPT_CONNTRACK_ORIGSRC
)paren
)paren
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sinfo-&gt;flags
op_amp
id|IPT_CONNTRACK_ORIGDST
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ct
op_logical_or
id|FWINV
c_func
(paren
(paren
id|ct-&gt;tuplehash
(braket
id|IP_CT_DIR_ORIGINAL
)braket
dot
id|tuple.dst.ip
op_amp
id|sinfo-&gt;dipmsk
(braket
id|IP_CT_DIR_ORIGINAL
)braket
dot
id|s_addr
)paren
op_ne
id|sinfo-&gt;tuple
(braket
id|IP_CT_DIR_ORIGINAL
)braket
dot
id|dst.ip
comma
id|IPT_CONNTRACK_ORIGDST
)paren
)paren
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sinfo-&gt;flags
op_amp
id|IPT_CONNTRACK_REPLSRC
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ct
op_logical_or
id|FWINV
c_func
(paren
(paren
id|ct-&gt;tuplehash
(braket
id|IP_CT_DIR_REPLY
)braket
dot
id|tuple.src.ip
op_amp
id|sinfo-&gt;sipmsk
(braket
id|IP_CT_DIR_REPLY
)braket
dot
id|s_addr
)paren
op_ne
id|sinfo-&gt;tuple
(braket
id|IP_CT_DIR_REPLY
)braket
dot
id|src.ip
comma
id|IPT_CONNTRACK_REPLSRC
)paren
)paren
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sinfo-&gt;flags
op_amp
id|IPT_CONNTRACK_REPLDST
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ct
op_logical_or
id|FWINV
c_func
(paren
(paren
id|ct-&gt;tuplehash
(braket
id|IP_CT_DIR_REPLY
)braket
dot
id|tuple.dst.ip
op_amp
id|sinfo-&gt;dipmsk
(braket
id|IP_CT_DIR_REPLY
)braket
dot
id|s_addr
)paren
op_ne
id|sinfo-&gt;tuple
(braket
id|IP_CT_DIR_REPLY
)braket
dot
id|dst.ip
comma
id|IPT_CONNTRACK_REPLDST
)paren
)paren
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sinfo-&gt;flags
op_amp
id|IPT_CONNTRACK_STATUS
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ct
op_logical_or
id|FWINV
c_func
(paren
(paren
id|ct-&gt;status
op_amp
id|sinfo-&gt;statusmask
)paren
op_eq
l_int|0
comma
id|IPT_CONNTRACK_STATUS
)paren
)paren
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sinfo-&gt;flags
op_amp
id|IPT_CONNTRACK_EXPIRES
)paren
(brace
r_int
r_int
id|expires
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ct
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|expires
op_assign
id|timer_pending
c_func
(paren
op_amp
id|ct-&gt;timeout
)paren
ques
c_cond
(paren
id|ct-&gt;timeout.expires
op_minus
id|jiffies
)paren
op_div
id|HZ
suffix:colon
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|FWINV
c_func
(paren
op_logical_neg
(paren
id|expires
op_ge
id|sinfo-&gt;expires_min
op_logical_and
id|expires
op_le
id|sinfo-&gt;expires_max
)paren
comma
id|IPT_CONNTRACK_EXPIRES
)paren
)paren
r_return
l_int|0
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|check
r_static
r_int
id|check
c_func
(paren
r_const
r_char
op_star
id|tablename
comma
r_const
r_struct
id|ipt_ip
op_star
id|ip
comma
r_void
op_star
id|matchinfo
comma
r_int
r_int
id|matchsize
comma
r_int
r_int
id|hook_mask
)paren
(brace
r_if
c_cond
(paren
id|matchsize
op_ne
id|IPT_ALIGN
c_func
(paren
r_sizeof
(paren
r_struct
id|ipt_conntrack_info
)paren
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|variable|conntrack_match
r_static
r_struct
id|ipt_match
id|conntrack_match
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;conntrack&quot;
comma
dot
id|match
op_assign
op_amp
id|match
comma
dot
id|checkentry
op_assign
op_amp
id|check
comma
dot
id|me
op_assign
id|THIS_MODULE
comma
)brace
suffix:semicolon
DECL|function|init
r_static
r_int
id|__init
id|init
c_func
(paren
r_void
)paren
(brace
id|need_ip_conntrack
c_func
(paren
)paren
suffix:semicolon
r_return
id|ipt_register_match
c_func
(paren
op_amp
id|conntrack_match
)paren
suffix:semicolon
)brace
DECL|function|fini
r_static
r_void
id|__exit
id|fini
c_func
(paren
r_void
)paren
(brace
id|ipt_unregister_match
c_func
(paren
op_amp
id|conntrack_match
)paren
suffix:semicolon
)brace
DECL|variable|init
id|module_init
c_func
(paren
id|init
)paren
suffix:semicolon
DECL|variable|fini
id|module_exit
c_func
(paren
id|fini
)paren
suffix:semicolon
eof
