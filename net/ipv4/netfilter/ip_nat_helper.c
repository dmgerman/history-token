multiline_comment|/* ip_nat_helper.c - generic support functions for NAT helpers &n; *&n; * (C) 2000-2002 Harald Welte &lt;laforge@netfilter.org&gt;&n; * (C) 2003-2004 Netfilter Core Team &lt;coreteam@netfilter.org&gt;&n; *&n; * This program is free software; you can redistribute it and/or modify&n; * it under the terms of the GNU General Public License version 2 as&n; * published by the Free Software Foundation.&n; *&n; * &t;14 Jan 2002 Harald Welte &lt;laforge@gnumonks.org&gt;:&n; *&t;&t;- add support for SACK adjustment &n; *&t;14 Mar 2002 Harald Welte &lt;laforge@gnumonks.org&gt;:&n; *&t;&t;- merge SACK support into newnat API&n; *&t;16 Aug 2002 Brian J. Murrell &lt;netfilter@interlinx.bc.ca&gt;:&n; *&t;&t;- make ip_nat_resize_packet more generic (TCP and UDP)&n; *&t;&t;- add ip_nat_mangle_udp_packet&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kmod.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/netfilter_ipv4.h&gt;
macro_line|#include &lt;net/checksum.h&gt;
macro_line|#include &lt;net/icmp.h&gt;
macro_line|#include &lt;net/ip.h&gt;
macro_line|#include &lt;net/tcp.h&gt;
macro_line|#include &lt;net/udp.h&gt;
DECL|macro|ASSERT_READ_LOCK
mdefine_line|#define ASSERT_READ_LOCK(x) MUST_BE_READ_LOCKED(&amp;ip_nat_lock)
DECL|macro|ASSERT_WRITE_LOCK
mdefine_line|#define ASSERT_WRITE_LOCK(x) MUST_BE_WRITE_LOCKED(&amp;ip_nat_lock)
macro_line|#include &lt;linux/netfilter_ipv4/ip_conntrack.h&gt;
macro_line|#include &lt;linux/netfilter_ipv4/ip_conntrack_helper.h&gt;
macro_line|#include &lt;linux/netfilter_ipv4/ip_nat.h&gt;
macro_line|#include &lt;linux/netfilter_ipv4/ip_nat_protocol.h&gt;
macro_line|#include &lt;linux/netfilter_ipv4/ip_nat_core.h&gt;
macro_line|#include &lt;linux/netfilter_ipv4/ip_nat_helper.h&gt;
macro_line|#include &lt;linux/netfilter_ipv4/listhelp.h&gt;
macro_line|#if 0
mdefine_line|#define DEBUGP printk
mdefine_line|#define DUMP_OFFSET(x)&t;printk(&quot;offset_before=%d, offset_after=%d, correction_pos=%u&bslash;n&quot;, x-&gt;offset_before, x-&gt;offset_after, x-&gt;correction_pos);
macro_line|#else
DECL|macro|DEBUGP
mdefine_line|#define DEBUGP(format, args...)
DECL|macro|DUMP_OFFSET
mdefine_line|#define DUMP_OFFSET(x)
macro_line|#endif
r_static
id|LIST_HEAD
c_func
(paren
id|helpers
)paren
suffix:semicolon
DECL|variable|ip_nat_seqofs_lock
id|DECLARE_LOCK
c_func
(paren
id|ip_nat_seqofs_lock
)paren
suffix:semicolon
multiline_comment|/* Setup TCP sequence correction given this change at this sequence */
r_static
r_inline
r_void
DECL|function|adjust_tcp_sequence
id|adjust_tcp_sequence
c_func
(paren
id|u32
id|seq
comma
r_int
id|sizediff
comma
r_struct
id|ip_conntrack
op_star
id|ct
comma
r_enum
id|ip_conntrack_info
id|ctinfo
)paren
(brace
r_int
id|dir
suffix:semicolon
r_struct
id|ip_nat_seq
op_star
id|this_way
comma
op_star
id|other_way
suffix:semicolon
id|DEBUGP
c_func
(paren
l_string|&quot;ip_nat_resize_packet: old_size = %u, new_size = %u&bslash;n&quot;
comma
(paren
op_star
id|skb
)paren
op_member_access_from_pointer
id|len
comma
id|new_size
)paren
suffix:semicolon
id|dir
op_assign
id|CTINFO2DIR
c_func
(paren
id|ctinfo
)paren
suffix:semicolon
id|this_way
op_assign
op_amp
id|ct-&gt;nat.info.seq
(braket
id|dir
)braket
suffix:semicolon
id|other_way
op_assign
op_amp
id|ct-&gt;nat.info.seq
(braket
op_logical_neg
id|dir
)braket
suffix:semicolon
id|DEBUGP
c_func
(paren
l_string|&quot;ip_nat_resize_packet: Seq_offset before: &quot;
)paren
suffix:semicolon
id|DUMP_OFFSET
c_func
(paren
id|this_way
)paren
suffix:semicolon
id|LOCK_BH
c_func
(paren
op_amp
id|ip_nat_seqofs_lock
)paren
suffix:semicolon
multiline_comment|/* SYN adjust. If it&squot;s uninitialized, or this is after last&n;&t; * correction, record it: we don&squot;t handle more than one&n;&t; * adjustment in the window, but do deal with common case of a&n;&t; * retransmit */
r_if
c_cond
(paren
id|this_way-&gt;offset_before
op_eq
id|this_way-&gt;offset_after
op_logical_or
id|before
c_func
(paren
id|this_way-&gt;correction_pos
comma
id|seq
)paren
)paren
(brace
id|this_way-&gt;correction_pos
op_assign
id|seq
suffix:semicolon
id|this_way-&gt;offset_before
op_assign
id|this_way-&gt;offset_after
suffix:semicolon
id|this_way-&gt;offset_after
op_add_assign
id|sizediff
suffix:semicolon
)brace
id|UNLOCK_BH
c_func
(paren
op_amp
id|ip_nat_seqofs_lock
)paren
suffix:semicolon
id|DEBUGP
c_func
(paren
l_string|&quot;ip_nat_resize_packet: Seq_offset after: &quot;
)paren
suffix:semicolon
id|DUMP_OFFSET
c_func
(paren
id|this_way
)paren
suffix:semicolon
)brace
multiline_comment|/* Frobs data inside this packet, which is linear. */
DECL|function|mangle_contents
r_static
r_void
id|mangle_contents
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_int
r_int
id|dataoff
comma
r_int
r_int
id|match_offset
comma
r_int
r_int
id|match_len
comma
r_const
r_char
op_star
id|rep_buffer
comma
r_int
r_int
id|rep_len
)paren
(brace
r_int
r_char
op_star
id|data
suffix:semicolon
id|BUG_ON
c_func
(paren
id|skb_is_nonlinear
c_func
(paren
id|skb
)paren
)paren
suffix:semicolon
id|data
op_assign
(paren
r_int
r_char
op_star
)paren
id|skb-&gt;nh.iph
op_plus
id|dataoff
suffix:semicolon
multiline_comment|/* move post-replacement */
id|memmove
c_func
(paren
id|data
op_plus
id|match_offset
op_plus
id|rep_len
comma
id|data
op_plus
id|match_offset
op_plus
id|match_len
comma
id|skb-&gt;tail
op_minus
(paren
id|data
op_plus
id|match_offset
op_plus
id|match_len
)paren
)paren
suffix:semicolon
multiline_comment|/* insert data from buffer */
id|memcpy
c_func
(paren
id|data
op_plus
id|match_offset
comma
id|rep_buffer
comma
id|rep_len
)paren
suffix:semicolon
multiline_comment|/* update skb info */
r_if
c_cond
(paren
id|rep_len
OG
id|match_len
)paren
(brace
id|DEBUGP
c_func
(paren
l_string|&quot;ip_nat_mangle_packet: Extending packet by &quot;
l_string|&quot;%u from %u bytes&bslash;n&quot;
comma
id|rep_len
op_minus
id|match_len
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|skb_put
c_func
(paren
id|skb
comma
id|rep_len
op_minus
id|match_len
)paren
suffix:semicolon
)brace
r_else
(brace
id|DEBUGP
c_func
(paren
l_string|&quot;ip_nat_mangle_packet: Shrinking packet from &quot;
l_string|&quot;%u from %u bytes&bslash;n&quot;
comma
id|match_len
op_minus
id|rep_len
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|__skb_trim
c_func
(paren
id|skb
comma
id|skb-&gt;len
op_plus
id|rep_len
op_minus
id|match_len
)paren
suffix:semicolon
)brace
multiline_comment|/* fix IP hdr checksum information */
id|skb-&gt;nh.iph-&gt;tot_len
op_assign
id|htons
c_func
(paren
id|skb-&gt;len
)paren
suffix:semicolon
id|ip_send_check
c_func
(paren
id|skb-&gt;nh.iph
)paren
suffix:semicolon
)brace
multiline_comment|/* Unusual, but possible case. */
DECL|function|enlarge_skb
r_static
r_int
id|enlarge_skb
c_func
(paren
r_struct
id|sk_buff
op_star
op_star
id|pskb
comma
r_int
r_int
id|extra
)paren
(brace
r_struct
id|sk_buff
op_star
id|nskb
suffix:semicolon
r_if
c_cond
(paren
(paren
op_star
id|pskb
)paren
op_member_access_from_pointer
id|len
op_plus
id|extra
OG
l_int|65535
)paren
r_return
l_int|0
suffix:semicolon
id|nskb
op_assign
id|skb_copy_expand
c_func
(paren
op_star
id|pskb
comma
id|skb_headroom
c_func
(paren
op_star
id|pskb
)paren
comma
id|extra
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|nskb
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Transfer socket to new skb. */
r_if
c_cond
(paren
(paren
op_star
id|pskb
)paren
op_member_access_from_pointer
id|sk
)paren
id|skb_set_owner_w
c_func
(paren
id|nskb
comma
(paren
op_star
id|pskb
)paren
op_member_access_from_pointer
id|sk
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_NETFILTER_DEBUG
id|nskb-&gt;nf_debug
op_assign
(paren
op_star
id|pskb
)paren
op_member_access_from_pointer
id|nf_debug
suffix:semicolon
macro_line|#endif
id|kfree_skb
c_func
(paren
op_star
id|pskb
)paren
suffix:semicolon
op_star
id|pskb
op_assign
id|nskb
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Generic function for mangling variable-length address changes inside&n; * NATed TCP connections (like the PORT XXX,XXX,XXX,XXX,XXX,XXX&n; * command in FTP).&n; *&n; * Takes care about all the nasty sequence number changes, checksumming,&n; * skb enlargement, ...&n; *&n; * */
r_int
DECL|function|ip_nat_mangle_tcp_packet
id|ip_nat_mangle_tcp_packet
c_func
(paren
r_struct
id|sk_buff
op_star
op_star
id|pskb
comma
r_struct
id|ip_conntrack
op_star
id|ct
comma
r_enum
id|ip_conntrack_info
id|ctinfo
comma
r_int
r_int
id|match_offset
comma
r_int
r_int
id|match_len
comma
r_const
r_char
op_star
id|rep_buffer
comma
r_int
r_int
id|rep_len
)paren
(brace
r_struct
id|iphdr
op_star
id|iph
suffix:semicolon
r_struct
id|tcphdr
op_star
id|tcph
suffix:semicolon
r_int
id|datalen
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb_ip_make_writable
c_func
(paren
id|pskb
comma
(paren
op_star
id|pskb
)paren
op_member_access_from_pointer
id|len
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|rep_len
OG
id|match_len
op_logical_and
id|rep_len
op_minus
id|match_len
OG
id|skb_tailroom
c_func
(paren
op_star
id|pskb
)paren
op_logical_and
op_logical_neg
id|enlarge_skb
c_func
(paren
id|pskb
comma
id|rep_len
op_minus
id|match_len
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|SKB_LINEAR_ASSERT
c_func
(paren
op_star
id|pskb
)paren
suffix:semicolon
id|iph
op_assign
(paren
op_star
id|pskb
)paren
op_member_access_from_pointer
id|nh.iph
suffix:semicolon
id|tcph
op_assign
(paren
r_void
op_star
)paren
id|iph
op_plus
id|iph-&gt;ihl
op_star
l_int|4
suffix:semicolon
id|mangle_contents
c_func
(paren
op_star
id|pskb
comma
id|iph-&gt;ihl
op_star
l_int|4
op_plus
id|tcph-&gt;doff
op_star
l_int|4
comma
id|match_offset
comma
id|match_len
comma
id|rep_buffer
comma
id|rep_len
)paren
suffix:semicolon
id|datalen
op_assign
(paren
op_star
id|pskb
)paren
op_member_access_from_pointer
id|len
op_minus
id|iph-&gt;ihl
op_star
l_int|4
suffix:semicolon
id|tcph-&gt;check
op_assign
l_int|0
suffix:semicolon
id|tcph-&gt;check
op_assign
id|tcp_v4_check
c_func
(paren
id|tcph
comma
id|datalen
comma
id|iph-&gt;saddr
comma
id|iph-&gt;daddr
comma
id|csum_partial
c_func
(paren
(paren
r_char
op_star
)paren
id|tcph
comma
id|datalen
comma
l_int|0
)paren
)paren
suffix:semicolon
id|adjust_tcp_sequence
c_func
(paren
id|ntohl
c_func
(paren
id|tcph-&gt;seq
)paren
comma
(paren
r_int
)paren
id|rep_len
op_minus
(paren
r_int
)paren
id|match_len
comma
id|ct
comma
id|ctinfo
)paren
suffix:semicolon
multiline_comment|/* Tell connection tracking about seq change, to expand window */
id|ip_conntrack_tcp_update
c_func
(paren
op_star
id|pskb
comma
id|ct
comma
id|CTINFO2DIR
c_func
(paren
id|ctinfo
)paren
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Generic function for mangling variable-length address changes inside&n; * NATed UDP connections (like the CONNECT DATA XXXXX MESG XXXXX INDEX XXXXX&n; * command in the Amanda protocol)&n; *&n; * Takes care about all the nasty sequence number changes, checksumming,&n; * skb enlargement, ...&n; *&n; * XXX - This function could be merged with ip_nat_mangle_tcp_packet which&n; *       should be fairly easy to do.&n; */
r_int
DECL|function|ip_nat_mangle_udp_packet
id|ip_nat_mangle_udp_packet
c_func
(paren
r_struct
id|sk_buff
op_star
op_star
id|pskb
comma
r_struct
id|ip_conntrack
op_star
id|ct
comma
r_enum
id|ip_conntrack_info
id|ctinfo
comma
r_int
r_int
id|match_offset
comma
r_int
r_int
id|match_len
comma
r_const
r_char
op_star
id|rep_buffer
comma
r_int
r_int
id|rep_len
)paren
(brace
r_struct
id|iphdr
op_star
id|iph
suffix:semicolon
r_struct
id|udphdr
op_star
id|udph
suffix:semicolon
multiline_comment|/* UDP helpers might accidentally mangle the wrong packet */
id|iph
op_assign
(paren
op_star
id|pskb
)paren
op_member_access_from_pointer
id|nh.iph
suffix:semicolon
r_if
c_cond
(paren
(paren
op_star
id|pskb
)paren
op_member_access_from_pointer
id|len
OL
id|iph-&gt;ihl
op_star
l_int|4
op_plus
r_sizeof
(paren
op_star
id|udph
)paren
op_plus
id|match_offset
op_plus
id|match_len
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb_ip_make_writable
c_func
(paren
id|pskb
comma
(paren
op_star
id|pskb
)paren
op_member_access_from_pointer
id|len
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|rep_len
OG
id|match_len
op_logical_and
id|rep_len
op_minus
id|match_len
OG
id|skb_tailroom
c_func
(paren
op_star
id|pskb
)paren
op_logical_and
op_logical_neg
id|enlarge_skb
c_func
(paren
id|pskb
comma
id|rep_len
op_minus
id|match_len
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|iph
op_assign
(paren
op_star
id|pskb
)paren
op_member_access_from_pointer
id|nh.iph
suffix:semicolon
id|udph
op_assign
(paren
r_void
op_star
)paren
id|iph
op_plus
id|iph-&gt;ihl
op_star
l_int|4
suffix:semicolon
id|mangle_contents
c_func
(paren
op_star
id|pskb
comma
id|iph-&gt;ihl
op_star
l_int|4
op_plus
r_sizeof
(paren
op_star
id|udph
)paren
comma
id|match_offset
comma
id|match_len
comma
id|rep_buffer
comma
id|rep_len
)paren
suffix:semicolon
multiline_comment|/* update the length of the UDP packet */
id|udph-&gt;len
op_assign
id|htons
c_func
(paren
(paren
op_star
id|pskb
)paren
op_member_access_from_pointer
id|len
op_minus
id|iph-&gt;ihl
op_star
l_int|4
)paren
suffix:semicolon
multiline_comment|/* fix udp checksum if udp checksum was previously calculated */
r_if
c_cond
(paren
id|udph-&gt;check
)paren
(brace
r_int
id|datalen
op_assign
(paren
op_star
id|pskb
)paren
op_member_access_from_pointer
id|len
op_minus
id|iph-&gt;ihl
op_star
l_int|4
suffix:semicolon
id|udph-&gt;check
op_assign
l_int|0
suffix:semicolon
id|udph-&gt;check
op_assign
id|csum_tcpudp_magic
c_func
(paren
id|iph-&gt;saddr
comma
id|iph-&gt;daddr
comma
id|datalen
comma
id|IPPROTO_UDP
comma
id|csum_partial
c_func
(paren
(paren
r_char
op_star
)paren
id|udph
comma
id|datalen
comma
l_int|0
)paren
)paren
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Adjust one found SACK option including checksum correction */
r_static
r_void
DECL|function|sack_adjust
id|sack_adjust
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|tcphdr
op_star
id|tcph
comma
r_int
r_int
id|sackoff
comma
r_int
r_int
id|sackend
comma
r_struct
id|ip_nat_seq
op_star
id|natseq
)paren
(brace
r_while
c_loop
(paren
id|sackoff
OL
id|sackend
)paren
(brace
r_struct
id|tcp_sack_block
op_star
id|sack
suffix:semicolon
id|u_int32_t
id|new_start_seq
comma
id|new_end_seq
suffix:semicolon
id|sack
op_assign
(paren
r_void
op_star
)paren
id|skb-&gt;data
op_plus
id|sackoff
suffix:semicolon
r_if
c_cond
(paren
id|after
c_func
(paren
id|ntohl
c_func
(paren
id|sack-&gt;start_seq
)paren
op_minus
id|natseq-&gt;offset_before
comma
id|natseq-&gt;correction_pos
)paren
)paren
id|new_start_seq
op_assign
id|ntohl
c_func
(paren
id|sack-&gt;start_seq
)paren
op_minus
id|natseq-&gt;offset_after
suffix:semicolon
r_else
id|new_start_seq
op_assign
id|ntohl
c_func
(paren
id|sack-&gt;start_seq
)paren
op_minus
id|natseq-&gt;offset_before
suffix:semicolon
id|new_start_seq
op_assign
id|htonl
c_func
(paren
id|new_start_seq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|after
c_func
(paren
id|ntohl
c_func
(paren
id|sack-&gt;end_seq
)paren
op_minus
id|natseq-&gt;offset_before
comma
id|natseq-&gt;correction_pos
)paren
)paren
id|new_end_seq
op_assign
id|ntohl
c_func
(paren
id|sack-&gt;end_seq
)paren
op_minus
id|natseq-&gt;offset_after
suffix:semicolon
r_else
id|new_end_seq
op_assign
id|ntohl
c_func
(paren
id|sack-&gt;end_seq
)paren
op_minus
id|natseq-&gt;offset_before
suffix:semicolon
id|new_end_seq
op_assign
id|htonl
c_func
(paren
id|new_end_seq
)paren
suffix:semicolon
id|DEBUGP
c_func
(paren
l_string|&quot;sack_adjust: start_seq: %d-&gt;%d, end_seq: %d-&gt;%d&bslash;n&quot;
comma
id|ntohl
c_func
(paren
id|sack-&gt;start_seq
)paren
comma
id|new_start_seq
comma
id|ntohl
c_func
(paren
id|sack-&gt;end_seq
)paren
comma
id|new_end_seq
)paren
suffix:semicolon
id|tcph-&gt;check
op_assign
id|ip_nat_cheat_check
c_func
(paren
op_complement
id|sack-&gt;start_seq
comma
id|new_start_seq
comma
id|ip_nat_cheat_check
c_func
(paren
op_complement
id|sack-&gt;end_seq
comma
id|new_end_seq
comma
id|tcph-&gt;check
)paren
)paren
suffix:semicolon
id|sack-&gt;start_seq
op_assign
id|new_start_seq
suffix:semicolon
id|sack-&gt;end_seq
op_assign
id|new_end_seq
suffix:semicolon
id|sackoff
op_add_assign
r_sizeof
(paren
op_star
id|sack
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* TCP SACK sequence number adjustment */
r_static
r_inline
r_int
r_int
DECL|function|ip_nat_sack_adjust
id|ip_nat_sack_adjust
c_func
(paren
r_struct
id|sk_buff
op_star
op_star
id|pskb
comma
r_struct
id|tcphdr
op_star
id|tcph
comma
r_struct
id|ip_conntrack
op_star
id|ct
comma
r_enum
id|ip_conntrack_info
id|ctinfo
)paren
(brace
r_int
r_int
id|dir
comma
id|optoff
comma
id|optend
suffix:semicolon
id|optoff
op_assign
(paren
op_star
id|pskb
)paren
op_member_access_from_pointer
id|nh.iph-&gt;ihl
op_star
l_int|4
op_plus
r_sizeof
(paren
r_struct
id|tcphdr
)paren
suffix:semicolon
id|optend
op_assign
(paren
op_star
id|pskb
)paren
op_member_access_from_pointer
id|nh.iph-&gt;ihl
op_star
l_int|4
op_plus
id|tcph-&gt;doff
op_star
l_int|4
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb_ip_make_writable
c_func
(paren
id|pskb
comma
id|optend
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|dir
op_assign
id|CTINFO2DIR
c_func
(paren
id|ctinfo
)paren
suffix:semicolon
r_while
c_loop
(paren
id|optoff
OL
id|optend
)paren
(brace
multiline_comment|/* Usually: option, length. */
r_int
r_char
op_star
id|op
op_assign
(paren
op_star
id|pskb
)paren
op_member_access_from_pointer
id|data
op_plus
id|optoff
suffix:semicolon
r_switch
c_cond
(paren
id|op
(braket
l_int|0
)braket
)paren
(brace
r_case
id|TCPOPT_EOL
suffix:colon
r_return
l_int|1
suffix:semicolon
r_case
id|TCPOPT_NOP
suffix:colon
id|optoff
op_increment
suffix:semicolon
r_continue
suffix:semicolon
r_default
suffix:colon
(brace
)brace
multiline_comment|/* no partial options */
r_if
c_cond
(paren
id|optoff
op_plus
l_int|1
op_eq
id|optend
op_logical_or
id|optoff
op_plus
id|op
(braket
l_int|1
)braket
OG
id|optend
op_logical_or
id|op
(braket
l_int|1
)braket
OL
l_int|2
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|op
(braket
l_int|0
)braket
op_eq
id|TCPOPT_SACK
op_logical_and
id|op
(braket
l_int|1
)braket
op_ge
l_int|2
op_plus
id|TCPOLEN_SACK_PERBLOCK
op_logical_and
(paren
(paren
id|op
(braket
l_int|1
)braket
op_minus
l_int|2
)paren
op_mod
id|TCPOLEN_SACK_PERBLOCK
)paren
op_eq
l_int|0
)paren
id|sack_adjust
c_func
(paren
op_star
id|pskb
comma
id|tcph
comma
id|optoff
op_plus
l_int|2
comma
id|optoff
op_plus
id|op
(braket
l_int|1
)braket
comma
op_amp
id|ct-&gt;nat.info.seq
(braket
op_logical_neg
id|dir
)braket
)paren
suffix:semicolon
id|optoff
op_add_assign
id|op
(braket
l_int|1
)braket
suffix:semicolon
)brace
)brace
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* TCP sequence number adjustment.  Returns 1 on success, 0 on failure */
r_int
DECL|function|ip_nat_seq_adjust
id|ip_nat_seq_adjust
c_func
(paren
r_struct
id|sk_buff
op_star
op_star
id|pskb
comma
r_struct
id|ip_conntrack
op_star
id|ct
comma
r_enum
id|ip_conntrack_info
id|ctinfo
)paren
(brace
r_struct
id|tcphdr
op_star
id|tcph
suffix:semicolon
r_int
id|dir
comma
id|newseq
comma
id|newack
suffix:semicolon
r_struct
id|ip_nat_seq
op_star
id|this_way
comma
op_star
id|other_way
suffix:semicolon
id|dir
op_assign
id|CTINFO2DIR
c_func
(paren
id|ctinfo
)paren
suffix:semicolon
id|this_way
op_assign
op_amp
id|ct-&gt;nat.info.seq
(braket
id|dir
)braket
suffix:semicolon
id|other_way
op_assign
op_amp
id|ct-&gt;nat.info.seq
(braket
op_logical_neg
id|dir
)braket
suffix:semicolon
multiline_comment|/* No adjustments to make?  Very common case. */
r_if
c_cond
(paren
op_logical_neg
id|this_way-&gt;offset_before
op_logical_and
op_logical_neg
id|this_way-&gt;offset_after
op_logical_and
op_logical_neg
id|other_way-&gt;offset_before
op_logical_and
op_logical_neg
id|other_way-&gt;offset_after
)paren
r_return
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb_ip_make_writable
c_func
(paren
id|pskb
comma
(paren
op_star
id|pskb
)paren
op_member_access_from_pointer
id|nh.iph-&gt;ihl
op_star
l_int|4
op_plus
r_sizeof
(paren
op_star
id|tcph
)paren
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|tcph
op_assign
(paren
r_void
op_star
)paren
(paren
op_star
id|pskb
)paren
op_member_access_from_pointer
id|data
op_plus
(paren
op_star
id|pskb
)paren
op_member_access_from_pointer
id|nh.iph-&gt;ihl
op_star
l_int|4
suffix:semicolon
r_if
c_cond
(paren
id|after
c_func
(paren
id|ntohl
c_func
(paren
id|tcph-&gt;seq
)paren
comma
id|this_way-&gt;correction_pos
)paren
)paren
id|newseq
op_assign
id|ntohl
c_func
(paren
id|tcph-&gt;seq
)paren
op_plus
id|this_way-&gt;offset_after
suffix:semicolon
r_else
id|newseq
op_assign
id|ntohl
c_func
(paren
id|tcph-&gt;seq
)paren
op_plus
id|this_way-&gt;offset_before
suffix:semicolon
id|newseq
op_assign
id|htonl
c_func
(paren
id|newseq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|after
c_func
(paren
id|ntohl
c_func
(paren
id|tcph-&gt;ack_seq
)paren
op_minus
id|other_way-&gt;offset_before
comma
id|other_way-&gt;correction_pos
)paren
)paren
id|newack
op_assign
id|ntohl
c_func
(paren
id|tcph-&gt;ack_seq
)paren
op_minus
id|other_way-&gt;offset_after
suffix:semicolon
r_else
id|newack
op_assign
id|ntohl
c_func
(paren
id|tcph-&gt;ack_seq
)paren
op_minus
id|other_way-&gt;offset_before
suffix:semicolon
id|newack
op_assign
id|htonl
c_func
(paren
id|newack
)paren
suffix:semicolon
id|tcph-&gt;check
op_assign
id|ip_nat_cheat_check
c_func
(paren
op_complement
id|tcph-&gt;seq
comma
id|newseq
comma
id|ip_nat_cheat_check
c_func
(paren
op_complement
id|tcph-&gt;ack_seq
comma
id|newack
comma
id|tcph-&gt;check
)paren
)paren
suffix:semicolon
id|DEBUGP
c_func
(paren
l_string|&quot;Adjusting sequence number from %u-&gt;%u, ack from %u-&gt;%u&bslash;n&quot;
comma
id|ntohl
c_func
(paren
id|tcph-&gt;seq
)paren
comma
id|ntohl
c_func
(paren
id|newseq
)paren
comma
id|ntohl
c_func
(paren
id|tcph-&gt;ack_seq
)paren
comma
id|ntohl
c_func
(paren
id|newack
)paren
)paren
suffix:semicolon
id|tcph-&gt;seq
op_assign
id|newseq
suffix:semicolon
id|tcph-&gt;ack_seq
op_assign
id|newack
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ip_nat_sack_adjust
c_func
(paren
id|pskb
comma
id|tcph
comma
id|ct
comma
id|ctinfo
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|ip_conntrack_tcp_update
c_func
(paren
op_star
id|pskb
comma
id|ct
comma
id|dir
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* We look at the master&squot;s nat fields without ip_nat_lock.  This works&n;   because the master&squot;s NAT must be fully initialized, because we&n;   don&squot;t match expectations set up by unconfirmed connections.  We&n;   can&squot;t grab the lock because we hold the ip_conntrack_lock, and that&n;   would be backwards from other locking orders. */
DECL|function|ip_nat_copy_manip
r_static
r_void
id|ip_nat_copy_manip
c_func
(paren
r_struct
id|ip_nat_info
op_star
id|master
comma
r_struct
id|ip_conntrack_expect
op_star
id|exp
comma
r_struct
id|ip_conntrack
op_star
id|ct
)paren
(brace
r_struct
id|ip_nat_range
id|range
suffix:semicolon
r_int
r_int
id|i
suffix:semicolon
id|range.flags
op_assign
id|IP_NAT_RANGE_MAP_IPS
suffix:semicolon
multiline_comment|/* Find what master is mapped to (if any), so we can do the same. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|master-&gt;num_manips
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|master-&gt;manips
(braket
id|i
)braket
dot
id|direction
op_ne
id|exp-&gt;dir
)paren
r_continue
suffix:semicolon
id|range.min_ip
op_assign
id|range.max_ip
op_assign
id|master-&gt;manips
(braket
id|i
)braket
dot
id|manip.ip
suffix:semicolon
multiline_comment|/* If this is a DST manip, map port here to where it&squot;s&n;&t;&t; * expected. */
r_if
c_cond
(paren
id|master-&gt;manips
(braket
id|i
)braket
dot
id|maniptype
op_eq
id|IP_NAT_MANIP_DST
)paren
(brace
id|range.flags
op_or_assign
id|IP_NAT_RANGE_PROTO_SPECIFIED
suffix:semicolon
id|range.min
op_assign
id|range.max
op_assign
id|exp-&gt;saved_proto
suffix:semicolon
)brace
id|ip_nat_setup_info
c_func
(paren
id|ct
comma
op_amp
id|range
comma
id|master-&gt;manips
(braket
id|i
)braket
dot
id|hooknum
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Setup NAT on this expected conntrack so it follows master. */
multiline_comment|/* If we fail to get a free NAT slot, we&squot;ll get dropped on confirm */
DECL|function|ip_nat_follow_master
r_void
id|ip_nat_follow_master
c_func
(paren
r_struct
id|ip_conntrack
op_star
id|ct
)paren
(brace
r_struct
id|ip_nat_info
op_star
id|master
op_assign
op_amp
id|ct-&gt;master-&gt;expectant-&gt;nat.info
suffix:semicolon
multiline_comment|/* This must be a fresh one. */
id|BUG_ON
c_func
(paren
id|ct-&gt;nat.info.initialized
)paren
suffix:semicolon
id|ip_nat_copy_manip
c_func
(paren
id|master
comma
id|ct-&gt;master
comma
id|ct
)paren
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|helper_cmp
id|helper_cmp
c_func
(paren
r_const
r_struct
id|ip_nat_helper
op_star
id|helper
comma
r_const
r_struct
id|ip_conntrack_tuple
op_star
id|tuple
)paren
(brace
r_return
id|ip_ct_tuple_mask_cmp
c_func
(paren
id|tuple
comma
op_amp
id|helper-&gt;tuple
comma
op_amp
id|helper-&gt;mask
)paren
suffix:semicolon
)brace
DECL|function|ip_nat_helper_register
r_int
id|ip_nat_helper_register
c_func
(paren
r_struct
id|ip_nat_helper
op_star
id|me
)paren
(brace
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
id|WRITE_LOCK
c_func
(paren
op_amp
id|ip_nat_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|LIST_FIND
c_func
(paren
op_amp
id|helpers
comma
id|helper_cmp
comma
r_struct
id|ip_nat_helper
op_star
comma
op_amp
id|me-&gt;tuple
)paren
)paren
id|ret
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_else
id|list_prepend
c_func
(paren
op_amp
id|helpers
comma
id|me
)paren
suffix:semicolon
id|WRITE_UNLOCK
c_func
(paren
op_amp
id|ip_nat_lock
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
r_struct
id|ip_nat_helper
op_star
DECL|function|__ip_nat_find_helper
id|__ip_nat_find_helper
c_func
(paren
r_const
r_struct
id|ip_conntrack_tuple
op_star
id|tuple
)paren
(brace
r_return
id|LIST_FIND
c_func
(paren
op_amp
id|helpers
comma
id|helper_cmp
comma
r_struct
id|ip_nat_helper
op_star
comma
id|tuple
)paren
suffix:semicolon
)brace
r_struct
id|ip_nat_helper
op_star
DECL|function|ip_nat_find_helper
id|ip_nat_find_helper
c_func
(paren
r_const
r_struct
id|ip_conntrack_tuple
op_star
id|tuple
)paren
(brace
r_struct
id|ip_nat_helper
op_star
id|h
suffix:semicolon
id|READ_LOCK
c_func
(paren
op_amp
id|ip_nat_lock
)paren
suffix:semicolon
id|h
op_assign
id|__ip_nat_find_helper
c_func
(paren
id|tuple
)paren
suffix:semicolon
id|READ_UNLOCK
c_func
(paren
op_amp
id|ip_nat_lock
)paren
suffix:semicolon
r_return
id|h
suffix:semicolon
)brace
r_static
r_int
DECL|function|kill_helper
id|kill_helper
c_func
(paren
r_struct
id|ip_conntrack
op_star
id|i
comma
r_void
op_star
id|helper
)paren
(brace
r_int
id|ret
suffix:semicolon
id|READ_LOCK
c_func
(paren
op_amp
id|ip_nat_lock
)paren
suffix:semicolon
id|ret
op_assign
(paren
id|i-&gt;nat.info.helper
op_eq
id|helper
)paren
suffix:semicolon
id|READ_UNLOCK
c_func
(paren
op_amp
id|ip_nat_lock
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|ip_nat_helper_unregister
r_void
id|ip_nat_helper_unregister
c_func
(paren
r_struct
id|ip_nat_helper
op_star
id|me
)paren
(brace
id|WRITE_LOCK
c_func
(paren
op_amp
id|ip_nat_lock
)paren
suffix:semicolon
multiline_comment|/* Autoloading conntrack helper might have failed */
r_if
c_cond
(paren
id|LIST_FIND
c_func
(paren
op_amp
id|helpers
comma
id|helper_cmp
comma
r_struct
id|ip_nat_helper
op_star
comma
op_amp
id|me-&gt;tuple
)paren
)paren
(brace
id|LIST_DELETE
c_func
(paren
op_amp
id|helpers
comma
id|me
)paren
suffix:semicolon
)brace
id|WRITE_UNLOCK
c_func
(paren
op_amp
id|ip_nat_lock
)paren
suffix:semicolon
multiline_comment|/* Someone could be still looking at the helper in a bh. */
id|synchronize_net
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Find anything using it, and umm, kill them.  We can&squot;t turn&n;&t;   them into normal connections: if we&squot;ve adjusted SYNs, then&n;&t;   they&squot;ll ackstorm.  So we just drop it.  We used to just&n;&t;   bump module count when a connection existed, but that&n;&t;   forces admins to gen fake RSTs or bounce box, either of&n;&t;   which is just a long-winded way of making things&n;&t;   worse. --RR */
id|ip_ct_iterate_cleanup
c_func
(paren
id|kill_helper
comma
id|me
)paren
suffix:semicolon
)brace
eof
