multiline_comment|/*&n; *              Weighted random policy for multipath.&n; *&n; *&n; * Version:&t;$Id: multipath_wrandom.c,v 1.1.2.3 2004/09/22 07:51:40 elueck Exp $&n; *&n; * Authors:&t;Einar Lueck &lt;elueck@de.ibm.com&gt;&lt;lkml@einar-lueck.de&gt;&n; *&n; *&t;&t;This program is free software; you can redistribute it and/or&n; *&t;&t;modify it under the terms of the GNU General Public License&n; *&t;&t;as published by the Free Software Foundation; either version&n; *&t;&t;2 of the License, or (at your option) any later version.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/socket.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/inet.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/inetdevice.h&gt;
macro_line|#include &lt;linux/igmp.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/seq_file.h&gt;
macro_line|#include &lt;linux/mroute.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;net/ip.h&gt;
macro_line|#include &lt;net/protocol.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;net/sock.h&gt;
macro_line|#include &lt;net/icmp.h&gt;
macro_line|#include &lt;net/udp.h&gt;
macro_line|#include &lt;net/raw.h&gt;
macro_line|#include &lt;linux/notifier.h&gt;
macro_line|#include &lt;linux/if_arp.h&gt;
macro_line|#include &lt;linux/netfilter_ipv4.h&gt;
macro_line|#include &lt;net/ipip.h&gt;
macro_line|#include &lt;net/checksum.h&gt;
macro_line|#include &lt;net/ip_fib.h&gt;
macro_line|#include &lt;net/ip_mp_alg.h&gt;
DECL|macro|MPprint
mdefine_line|#define MPprint(a...)&t;
singleline_comment|// printk(KERN_DEBUG a)
DECL|macro|MULTIPATH_STATE_SIZE
mdefine_line|#define MULTIPATH_STATE_SIZE 15
DECL|struct|multipath_candidate
r_struct
id|multipath_candidate
(brace
DECL|member|next
r_struct
id|multipath_candidate
op_star
id|next
suffix:semicolon
DECL|member|power
r_int
id|power
suffix:semicolon
DECL|member|rt
r_struct
id|rtable
op_star
id|rt
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|multipath_dest
r_struct
id|multipath_dest
(brace
DECL|member|list
r_struct
id|list_head
id|list
suffix:semicolon
DECL|member|nh_info
r_const
r_struct
id|fib_nh
op_star
id|nh_info
suffix:semicolon
DECL|member|netmask
id|__u32
id|netmask
suffix:semicolon
DECL|member|network
id|__u32
id|network
suffix:semicolon
DECL|member|prefixlen
r_int
r_char
id|prefixlen
suffix:semicolon
DECL|member|rcu
r_struct
id|rcu_head
id|rcu
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|multipath_bucket
r_struct
id|multipath_bucket
(brace
DECL|member|head
r_struct
id|list_head
id|head
suffix:semicolon
DECL|member|lock
id|spinlock_t
id|lock
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|multipath_route
r_struct
id|multipath_route
(brace
DECL|member|list
r_struct
id|list_head
id|list
suffix:semicolon
DECL|member|oif
r_int
id|oif
suffix:semicolon
DECL|member|gw
id|__u32
id|gw
suffix:semicolon
DECL|member|dests
r_struct
id|list_head
id|dests
suffix:semicolon
DECL|member|rcu
r_struct
id|rcu_head
id|rcu
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* state: primarily weight per route information */
DECL|variable|multipath_state_initialized
r_static
r_int
id|multipath_state_initialized
op_assign
l_int|0
suffix:semicolon
DECL|variable|state_big_lock
r_static
id|spinlock_t
id|state_big_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
DECL|variable|state
r_static
r_struct
id|multipath_bucket
id|state
(braket
id|MULTIPATH_STATE_SIZE
)braket
suffix:semicolon
multiline_comment|/* interface to random number generation */
DECL|variable|RANDOM_SEED
r_static
r_int
r_int
id|RANDOM_SEED
op_assign
l_int|93186752
suffix:semicolon
r_static
id|__inline__
r_int
r_int
id|random
c_func
(paren
r_int
r_int
id|ubound
)paren
suffix:semicolon
DECL|function|__multipath_lookup_weight
r_static
r_int
r_char
id|__multipath_lookup_weight
c_func
(paren
r_const
r_struct
id|flowi
op_star
id|fl
comma
r_const
r_struct
id|rtable
op_star
id|rt
)paren
(brace
r_const
r_int
id|state_idx
op_assign
id|rt-&gt;idev-&gt;dev-&gt;ifindex
op_mod
id|MULTIPATH_STATE_SIZE
suffix:semicolon
r_struct
id|multipath_route
op_star
id|r
suffix:semicolon
r_struct
id|multipath_route
op_star
id|target_route
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|multipath_dest
op_star
id|d
suffix:semicolon
r_int
id|weight
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* lookup the weight information for a certain route */
id|rcu_read_lock
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* find state entry for gateway or add one if necessary */
id|list_for_each_entry_rcu
c_func
(paren
id|r
comma
op_amp
id|state
(braket
id|state_idx
)braket
dot
id|head
comma
id|list
)paren
(brace
r_if
c_cond
(paren
id|r-&gt;gw
op_eq
id|rt-&gt;rt_gateway
op_logical_and
id|r-&gt;oif
op_eq
id|rt-&gt;idev-&gt;dev-&gt;ifindex
)paren
(brace
id|target_route
op_assign
id|r
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|target_route
)paren
(brace
multiline_comment|/* this should not happen... but we are prepared */
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;%s: missing state for gateway: %u and &quot;
"&bslash;"
l_string|&quot;device %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|rt-&gt;rt_gateway
comma
id|rt-&gt;idev-&gt;dev-&gt;ifindex
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* find state entry for destination */
id|list_for_each_entry_rcu
c_func
(paren
id|d
comma
op_amp
id|target_route-&gt;dests
comma
id|list
)paren
(brace
id|__u32
id|targetnetwork
op_assign
id|fl-&gt;fl4_dst
op_amp
(paren
l_int|0xFFFFFFFF
op_rshift
(paren
l_int|32
op_minus
id|d-&gt;prefixlen
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|targetnetwork
op_amp
id|d-&gt;netmask
)paren
op_eq
id|d-&gt;network
)paren
(brace
id|weight
op_assign
id|d-&gt;nh_info-&gt;nh_weight
suffix:semicolon
id|MPprint
c_func
(paren
l_string|&quot;%s: found weight %d for gateway %u&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|weight
comma
id|rt-&gt;rt_gateway
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
id|out
suffix:colon
id|rcu_read_unlock
c_func
(paren
)paren
suffix:semicolon
r_return
id|weight
suffix:semicolon
)brace
DECL|function|__multipath_init_state
r_static
r_void
id|__multipath_init_state
c_func
(paren
r_void
)paren
(brace
id|spin_lock
c_func
(paren
op_amp
id|state_big_lock
)paren
suffix:semicolon
multiline_comment|/* check again due to SMP and to prevent contention */
r_if
c_cond
(paren
op_logical_neg
id|multipath_state_initialized
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MULTIPATH_STATE_SIZE
suffix:semicolon
op_increment
id|i
)paren
(brace
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|state
(braket
id|i
)braket
dot
id|head
)paren
suffix:semicolon
id|state
(braket
id|i
)braket
dot
id|lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
)brace
)brace
multiline_comment|/* now mark initialized */
id|multipath_state_initialized
op_assign
l_int|1
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|state_big_lock
)paren
suffix:semicolon
)brace
DECL|function|__multipath_init
r_static
r_void
r_inline
id|__multipath_init
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* do not spinlock to reduce unnecessary contention */
r_if
c_cond
(paren
op_logical_neg
id|multipath_state_initialized
)paren
id|__multipath_init_state
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|__multipath_selectroute
r_void
id|__multipath_selectroute
c_func
(paren
r_const
r_struct
id|flowi
op_star
id|flp
comma
r_struct
id|rtable
op_star
id|first
comma
r_struct
id|rtable
op_star
op_star
id|rp
)paren
(brace
r_struct
id|rtable
op_star
id|rt
suffix:semicolon
r_struct
id|rtable
op_star
id|decision
suffix:semicolon
r_struct
id|multipath_candidate
op_star
id|first_mpc
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|multipath_candidate
op_star
id|mpc
comma
op_star
id|last_mpc
op_assign
l_int|NULL
suffix:semicolon
r_int
id|power
op_assign
l_int|0
suffix:semicolon
r_int
id|last_power
suffix:semicolon
r_int
id|selector
suffix:semicolon
r_const
r_int
id|size_mpc
op_assign
r_sizeof
(paren
r_struct
id|multipath_candidate
)paren
suffix:semicolon
multiline_comment|/* init state if necessary */
id|__multipath_init
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* collect all candidates and identify their weights */
r_for
c_loop
(paren
id|rt
op_assign
id|rcu_dereference
c_func
(paren
id|first
)paren
suffix:semicolon
id|rt
suffix:semicolon
id|rt
op_assign
id|rcu_dereference
c_func
(paren
id|rt-&gt;u.rt_next
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|rt-&gt;u.dst.flags
op_amp
id|DST_BALANCED
)paren
op_ne
l_int|0
op_logical_and
id|multipath_comparekeys
c_func
(paren
op_amp
id|rt-&gt;fl
comma
id|flp
)paren
)paren
(brace
r_struct
id|multipath_candidate
op_star
id|mpc
op_assign
(paren
r_struct
id|multipath_candidate
op_star
)paren
id|kmalloc
c_func
(paren
id|size_mpc
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|power
op_add_assign
id|__multipath_lookup_weight
c_func
(paren
id|flp
comma
id|rt
)paren
op_star
l_int|10000
suffix:semicolon
id|mpc-&gt;power
op_assign
id|power
suffix:semicolon
id|mpc-&gt;rt
op_assign
id|rt
suffix:semicolon
id|mpc-&gt;next
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|first_mpc
)paren
id|first_mpc
op_assign
id|mpc
suffix:semicolon
r_else
id|last_mpc-&gt;next
op_assign
id|mpc
suffix:semicolon
id|last_mpc
op_assign
id|mpc
suffix:semicolon
)brace
)brace
multiline_comment|/* choose a weighted random candidate */
id|decision
op_assign
id|first
suffix:semicolon
id|selector
op_assign
id|random
c_func
(paren
id|power
)paren
suffix:semicolon
id|MPprint
c_func
(paren
l_string|&quot;%s: random number %d in range %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|selector
comma
id|power
)paren
suffix:semicolon
id|last_power
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* select candidate, adjust GC data and cleanup local state */
id|decision
op_assign
id|first
suffix:semicolon
id|last_mpc
op_assign
l_int|NULL
suffix:semicolon
r_for
c_loop
(paren
id|mpc
op_assign
id|first_mpc
suffix:semicolon
id|mpc
suffix:semicolon
id|mpc
op_assign
id|mpc-&gt;next
)paren
(brace
id|mpc-&gt;rt-&gt;u.dst.lastuse
op_assign
id|jiffies
suffix:semicolon
id|MPprint
c_func
(paren
l_string|&quot;%s: last_power = %d, selector: %d, mpc-&gt;power: %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|last_power
comma
id|selector
comma
id|mpc-&gt;power
)paren
suffix:semicolon
r_if
c_cond
(paren
id|last_power
op_le
id|selector
op_logical_and
id|selector
OL
id|mpc-&gt;power
)paren
(brace
id|decision
op_assign
id|mpc-&gt;rt
suffix:semicolon
id|MPprint
c_func
(paren
l_string|&quot;%s: selected %u&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|decision-&gt;rt_gateway
)paren
suffix:semicolon
)brace
id|last_power
op_assign
id|mpc-&gt;power
suffix:semicolon
r_if
c_cond
(paren
id|last_mpc
)paren
id|kfree
c_func
(paren
id|last_mpc
)paren
suffix:semicolon
id|last_mpc
op_assign
id|mpc
suffix:semicolon
)brace
r_if
c_cond
(paren
id|last_mpc
)paren
(brace
multiline_comment|/* concurrent __multipath_flush may lead to !last_mpc */
id|kfree
c_func
(paren
id|last_mpc
)paren
suffix:semicolon
)brace
id|decision-&gt;u.dst.__use
op_increment
suffix:semicolon
op_star
id|rp
op_assign
id|decision
suffix:semicolon
)brace
DECL|function|__multipath_set_nhinfo
r_void
id|__multipath_set_nhinfo
c_func
(paren
id|__u32
id|network
comma
id|__u32
id|netmask
comma
r_int
r_char
id|prefixlen
comma
r_const
r_struct
id|fib_nh
op_star
id|nh
)paren
(brace
r_const
r_int
id|state_idx
op_assign
id|nh-&gt;nh_oif
op_mod
id|MULTIPATH_STATE_SIZE
suffix:semicolon
r_struct
id|multipath_route
op_star
id|r
comma
op_star
id|target_route
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|multipath_dest
op_star
id|d
comma
op_star
id|target_dest
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* init state if necessary */
id|__multipath_init
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* store the weight information for a certain route */
id|spin_lock
c_func
(paren
op_amp
id|state
(braket
id|state_idx
)braket
dot
id|lock
)paren
suffix:semicolon
multiline_comment|/* find state entry for gateway or add one if necessary */
id|list_for_each_entry_rcu
c_func
(paren
id|r
comma
op_amp
id|state
(braket
id|state_idx
)braket
dot
id|head
comma
id|list
)paren
(brace
r_if
c_cond
(paren
id|r-&gt;gw
op_eq
id|nh-&gt;nh_gw
op_logical_and
id|r-&gt;oif
op_eq
id|nh-&gt;nh_oif
)paren
(brace
id|target_route
op_assign
id|r
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|target_route
)paren
(brace
r_const
r_int
id|size_rt
op_assign
r_sizeof
(paren
r_struct
id|multipath_route
)paren
suffix:semicolon
id|target_route
op_assign
(paren
r_struct
id|multipath_route
op_star
)paren
id|kmalloc
c_func
(paren
id|size_rt
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|target_route-&gt;gw
op_assign
id|nh-&gt;nh_gw
suffix:semicolon
id|target_route-&gt;oif
op_assign
id|nh-&gt;nh_oif
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|target_route-&gt;rcu
comma
r_sizeof
(paren
r_struct
id|rcu_head
)paren
comma
l_int|0
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|target_route-&gt;dests
)paren
suffix:semicolon
id|list_add_rcu
c_func
(paren
op_amp
id|target_route-&gt;list
comma
op_amp
id|state
(braket
id|state_idx
)braket
dot
id|head
)paren
suffix:semicolon
)brace
multiline_comment|/* find state entry for destination or add one if necessary */
id|list_for_each_entry_rcu
c_func
(paren
id|d
comma
op_amp
id|target_route-&gt;dests
comma
id|list
)paren
(brace
r_if
c_cond
(paren
id|d-&gt;nh_info
op_eq
id|nh
)paren
(brace
id|target_dest
op_assign
id|d
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|target_dest
)paren
(brace
r_const
r_int
id|size_dst
op_assign
r_sizeof
(paren
r_struct
id|multipath_dest
)paren
suffix:semicolon
id|target_dest
op_assign
(paren
r_struct
id|multipath_dest
op_star
)paren
id|kmalloc
c_func
(paren
id|size_dst
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|target_dest-&gt;nh_info
op_assign
id|nh
suffix:semicolon
id|target_dest-&gt;network
op_assign
id|network
suffix:semicolon
id|target_dest-&gt;netmask
op_assign
id|netmask
suffix:semicolon
id|target_dest-&gt;prefixlen
op_assign
id|prefixlen
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|target_dest-&gt;rcu
comma
r_sizeof
(paren
r_struct
id|rcu_head
)paren
comma
l_int|0
)paren
suffix:semicolon
id|list_add_rcu
c_func
(paren
op_amp
id|target_dest-&gt;list
comma
op_amp
id|target_route-&gt;dests
)paren
suffix:semicolon
)brace
multiline_comment|/* else: we already stored this info for another destination =&gt;&n;&t; * we are finished&n;&t; */
id|spin_unlock
c_func
(paren
op_amp
id|state
(braket
id|state_idx
)braket
dot
id|lock
)paren
suffix:semicolon
)brace
DECL|function|__multipath_free
r_static
r_void
id|__multipath_free
c_func
(paren
r_struct
id|rcu_head
op_star
id|head
)paren
(brace
r_struct
id|multipath_route
op_star
id|rt
op_assign
id|container_of
c_func
(paren
id|head
comma
r_struct
id|multipath_route
comma
id|rcu
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|rt
)paren
suffix:semicolon
)brace
DECL|function|__multipath_free_dst
r_static
r_void
id|__multipath_free_dst
c_func
(paren
r_struct
id|rcu_head
op_star
id|head
)paren
(brace
r_struct
id|multipath_dest
op_star
id|dst
op_assign
id|container_of
c_func
(paren
id|head
comma
r_struct
id|multipath_dest
comma
id|rcu
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dst
)paren
suffix:semicolon
)brace
DECL|function|__multipath_flush
r_void
id|__multipath_flush
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|MPprint
c_func
(paren
l_string|&quot;%s: called&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
multiline_comment|/* init state if necessary */
id|__multipath_init
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* defere delete to all entries */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MULTIPATH_STATE_SIZE
suffix:semicolon
op_increment
id|i
)paren
(brace
r_struct
id|multipath_route
op_star
id|r
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|state
(braket
id|i
)braket
dot
id|lock
)paren
suffix:semicolon
id|list_for_each_entry_rcu
c_func
(paren
id|r
comma
op_amp
id|state
(braket
id|i
)braket
dot
id|head
comma
id|list
)paren
(brace
r_struct
id|multipath_dest
op_star
id|d
suffix:semicolon
id|list_for_each_entry_rcu
c_func
(paren
id|d
comma
op_amp
id|r-&gt;dests
comma
id|list
)paren
(brace
id|list_del_rcu
c_func
(paren
op_amp
id|d-&gt;list
)paren
suffix:semicolon
id|call_rcu
c_func
(paren
op_amp
id|d-&gt;rcu
comma
id|__multipath_free_dst
)paren
suffix:semicolon
)brace
id|list_del_rcu
c_func
(paren
op_amp
id|r-&gt;list
)paren
suffix:semicolon
id|call_rcu
c_func
(paren
op_amp
id|r-&gt;rcu
comma
id|__multipath_free
)paren
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|state
(braket
id|i
)braket
dot
id|lock
)paren
suffix:semicolon
)brace
id|MPprint
c_func
(paren
l_string|&quot;%s: finished&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
)brace
DECL|function|random
r_static
id|__inline__
r_int
r_int
id|random
c_func
(paren
r_int
r_int
id|ubound
)paren
(brace
r_static
r_int
r_int
id|a
op_assign
l_int|1588635695
comma
id|q
op_assign
l_int|2
comma
id|r
op_assign
l_int|1117695901
suffix:semicolon
id|RANDOM_SEED
op_assign
id|a
op_star
(paren
id|RANDOM_SEED
op_mod
id|q
)paren
op_minus
id|r
op_star
(paren
id|RANDOM_SEED
op_div
id|q
)paren
suffix:semicolon
r_return
id|RANDOM_SEED
op_mod
id|ubound
suffix:semicolon
)brace
eof
