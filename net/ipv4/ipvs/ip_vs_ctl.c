multiline_comment|/*&n; * IPVS         An implementation of the IP virtual server support for the&n; *              LINUX operating system.  IPVS is now implemented as a module&n; *              over the NetFilter framework. IPVS can be used to build a&n; *              high-performance and highly available server based on a&n; *              cluster of servers.&n; *&n; * Version:     $Id: ip_vs_ctl.c,v 1.36 2003/06/08 09:31:19 wensong Exp $&n; *&n; * Authors:     Wensong Zhang &lt;wensong@linuxvirtualserver.org&gt;&n; *              Peter Kese &lt;peter.kese@ijs.si&gt;&n; *              Julian Anastasov &lt;ja@ssi.bg&gt;&n; *&n; *              This program is free software; you can redistribute it and/or&n; *              modify it under the terms of the GNU General Public License&n; *              as published by the Free Software Foundation; either version&n; *              2 of the License, or (at your option) any later version.&n; *&n; * Changes:&n; *&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/sysctl.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/swap.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/seq_file.h&gt;
macro_line|#include &lt;linux/netfilter.h&gt;
macro_line|#include &lt;linux/netfilter_ipv4.h&gt;
macro_line|#include &lt;net/ip.h&gt;
macro_line|#include &lt;net/sock.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;net/ip_vs.h&gt;
multiline_comment|/* semaphore for IPVS sockopts. And, [gs]etsockopt may sleep. */
r_static
id|DECLARE_MUTEX
c_func
(paren
id|__ip_vs_mutex
)paren
suffix:semicolon
multiline_comment|/* lock for service table */
DECL|variable|__ip_vs_svc_lock
r_static
id|rwlock_t
id|__ip_vs_svc_lock
op_assign
id|RW_LOCK_UNLOCKED
suffix:semicolon
multiline_comment|/* lock for table with the real services */
DECL|variable|__ip_vs_rs_lock
r_static
id|rwlock_t
id|__ip_vs_rs_lock
op_assign
id|RW_LOCK_UNLOCKED
suffix:semicolon
multiline_comment|/* lock for state and timeout tables */
DECL|variable|__ip_vs_securetcp_lock
r_static
id|rwlock_t
id|__ip_vs_securetcp_lock
op_assign
id|RW_LOCK_UNLOCKED
suffix:semicolon
multiline_comment|/* lock for drop entry handling */
DECL|variable|__ip_vs_dropentry_lock
r_static
id|spinlock_t
id|__ip_vs_dropentry_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
multiline_comment|/* lock for drop packet handling */
DECL|variable|__ip_vs_droppacket_lock
r_static
id|spinlock_t
id|__ip_vs_droppacket_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
multiline_comment|/* 1/rate drop and drop-entry variables */
DECL|variable|ip_vs_drop_rate
r_int
id|ip_vs_drop_rate
op_assign
l_int|0
suffix:semicolon
DECL|variable|ip_vs_drop_counter
r_int
id|ip_vs_drop_counter
op_assign
l_int|0
suffix:semicolon
DECL|variable|ip_vs_dropentry
id|atomic_t
id|ip_vs_dropentry
op_assign
id|ATOMIC_INIT
c_func
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/* number of virtual services */
DECL|variable|ip_vs_num_services
r_static
r_int
id|ip_vs_num_services
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* sysctl variables */
DECL|variable|sysctl_ip_vs_drop_entry
r_static
r_int
id|sysctl_ip_vs_drop_entry
op_assign
l_int|0
suffix:semicolon
DECL|variable|sysctl_ip_vs_drop_packet
r_static
r_int
id|sysctl_ip_vs_drop_packet
op_assign
l_int|0
suffix:semicolon
DECL|variable|sysctl_ip_vs_secure_tcp
r_static
r_int
id|sysctl_ip_vs_secure_tcp
op_assign
l_int|0
suffix:semicolon
DECL|variable|sysctl_ip_vs_amemthresh
r_static
r_int
id|sysctl_ip_vs_amemthresh
op_assign
l_int|1024
suffix:semicolon
DECL|variable|sysctl_ip_vs_am_droprate
r_static
r_int
id|sysctl_ip_vs_am_droprate
op_assign
l_int|10
suffix:semicolon
DECL|variable|sysctl_ip_vs_cache_bypass
r_int
id|sysctl_ip_vs_cache_bypass
op_assign
l_int|0
suffix:semicolon
DECL|variable|sysctl_ip_vs_expire_nodest_conn
r_int
id|sysctl_ip_vs_expire_nodest_conn
op_assign
l_int|0
suffix:semicolon
DECL|variable|sysctl_ip_vs_sync_threshold
r_int
id|sysctl_ip_vs_sync_threshold
(braket
l_int|2
)braket
op_assign
(brace
l_int|3
comma
l_int|50
)brace
suffix:semicolon
DECL|variable|sysctl_ip_vs_nat_icmp_send
r_int
id|sysctl_ip_vs_nat_icmp_send
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef CONFIG_IP_VS_DEBUG
DECL|variable|sysctl_ip_vs_debug_level
r_static
r_int
id|sysctl_ip_vs_debug_level
op_assign
l_int|0
suffix:semicolon
DECL|function|ip_vs_get_debug_level
r_int
id|ip_vs_get_debug_level
c_func
(paren
r_void
)paren
(brace
r_return
id|sysctl_ip_vs_debug_level
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n; *&t;update_defense_level is called from timer bh and from sysctl.&n; */
DECL|function|update_defense_level
r_static
r_void
id|update_defense_level
c_func
(paren
r_void
)paren
(brace
r_struct
id|sysinfo
id|i
suffix:semicolon
r_static
r_int
id|old_secure_tcp
op_assign
l_int|0
suffix:semicolon
r_int
id|availmem
suffix:semicolon
r_int
id|nomem
suffix:semicolon
r_int
id|to_change
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* we only count free and buffered memory (in pages) */
id|si_meminfo
c_func
(paren
op_amp
id|i
)paren
suffix:semicolon
id|availmem
op_assign
id|i.freeram
op_plus
id|i.bufferram
suffix:semicolon
multiline_comment|/* however in linux 2.5 the i.bufferram is total page cache size,&n;&t;   we need adjust it */
multiline_comment|/* si_swapinfo(&amp;i); */
multiline_comment|/* availmem = availmem - (i.totalswap - i.freeswap); */
id|nomem
op_assign
(paren
id|availmem
OL
id|sysctl_ip_vs_amemthresh
)paren
suffix:semicolon
multiline_comment|/* drop_entry */
id|spin_lock
c_func
(paren
op_amp
id|__ip_vs_dropentry_lock
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|sysctl_ip_vs_drop_entry
)paren
(brace
r_case
l_int|0
suffix:colon
id|atomic_set
c_func
(paren
op_amp
id|ip_vs_dropentry
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
r_if
c_cond
(paren
id|nomem
)paren
(brace
id|atomic_set
c_func
(paren
op_amp
id|ip_vs_dropentry
comma
l_int|1
)paren
suffix:semicolon
id|sysctl_ip_vs_drop_entry
op_assign
l_int|2
suffix:semicolon
)brace
r_else
(brace
id|atomic_set
c_func
(paren
op_amp
id|ip_vs_dropentry
comma
l_int|0
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
r_if
c_cond
(paren
id|nomem
)paren
(brace
id|atomic_set
c_func
(paren
op_amp
id|ip_vs_dropentry
comma
l_int|1
)paren
suffix:semicolon
)brace
r_else
(brace
id|atomic_set
c_func
(paren
op_amp
id|ip_vs_dropentry
comma
l_int|0
)paren
suffix:semicolon
id|sysctl_ip_vs_drop_entry
op_assign
l_int|1
suffix:semicolon
)brace
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
id|atomic_set
c_func
(paren
op_amp
id|ip_vs_dropentry
comma
l_int|1
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|__ip_vs_dropentry_lock
)paren
suffix:semicolon
multiline_comment|/* drop_packet */
id|spin_lock
c_func
(paren
op_amp
id|__ip_vs_droppacket_lock
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|sysctl_ip_vs_drop_packet
)paren
(brace
r_case
l_int|0
suffix:colon
id|ip_vs_drop_rate
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
r_if
c_cond
(paren
id|nomem
)paren
(brace
id|ip_vs_drop_rate
op_assign
id|ip_vs_drop_counter
op_assign
id|sysctl_ip_vs_amemthresh
op_div
(paren
id|sysctl_ip_vs_amemthresh
op_minus
id|availmem
)paren
suffix:semicolon
id|sysctl_ip_vs_drop_packet
op_assign
l_int|2
suffix:semicolon
)brace
r_else
(brace
id|ip_vs_drop_rate
op_assign
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
r_if
c_cond
(paren
id|nomem
)paren
(brace
id|ip_vs_drop_rate
op_assign
id|ip_vs_drop_counter
op_assign
id|sysctl_ip_vs_amemthresh
op_div
(paren
id|sysctl_ip_vs_amemthresh
op_minus
id|availmem
)paren
suffix:semicolon
)brace
r_else
(brace
id|ip_vs_drop_rate
op_assign
l_int|0
suffix:semicolon
id|sysctl_ip_vs_drop_packet
op_assign
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
id|ip_vs_drop_rate
op_assign
id|sysctl_ip_vs_am_droprate
suffix:semicolon
r_break
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|__ip_vs_droppacket_lock
)paren
suffix:semicolon
multiline_comment|/* secure_tcp */
id|write_lock
c_func
(paren
op_amp
id|__ip_vs_securetcp_lock
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|sysctl_ip_vs_secure_tcp
)paren
(brace
r_case
l_int|0
suffix:colon
r_if
c_cond
(paren
id|old_secure_tcp
op_ge
l_int|2
)paren
id|to_change
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
r_if
c_cond
(paren
id|nomem
)paren
(brace
r_if
c_cond
(paren
id|old_secure_tcp
OL
l_int|2
)paren
id|to_change
op_assign
l_int|1
suffix:semicolon
id|sysctl_ip_vs_secure_tcp
op_assign
l_int|2
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|old_secure_tcp
op_ge
l_int|2
)paren
id|to_change
op_assign
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
r_if
c_cond
(paren
id|nomem
)paren
(brace
r_if
c_cond
(paren
id|old_secure_tcp
OL
l_int|2
)paren
id|to_change
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|old_secure_tcp
op_ge
l_int|2
)paren
id|to_change
op_assign
l_int|0
suffix:semicolon
id|sysctl_ip_vs_secure_tcp
op_assign
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
l_int|3
suffix:colon
r_if
c_cond
(paren
id|old_secure_tcp
OL
l_int|2
)paren
id|to_change
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
id|old_secure_tcp
op_assign
id|sysctl_ip_vs_secure_tcp
suffix:semicolon
r_if
c_cond
(paren
id|to_change
op_ge
l_int|0
)paren
id|ip_vs_protocol_timeout_change
c_func
(paren
id|sysctl_ip_vs_secure_tcp
OG
l_int|1
)paren
suffix:semicolon
id|write_unlock
c_func
(paren
op_amp
id|__ip_vs_securetcp_lock
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Timer for checking the defense&n; */
DECL|variable|defense_timer
r_static
r_struct
id|timer_list
id|defense_timer
suffix:semicolon
DECL|macro|DEFENSE_TIMER_PERIOD
mdefine_line|#define DEFENSE_TIMER_PERIOD&t;1*HZ
DECL|function|defense_timer_handler
r_static
r_void
id|defense_timer_handler
c_func
(paren
r_int
r_int
id|data
)paren
(brace
id|update_defense_level
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|ip_vs_dropentry
)paren
)paren
id|ip_vs_random_dropentry
c_func
(paren
)paren
suffix:semicolon
id|mod_timer
c_func
(paren
op_amp
id|defense_timer
comma
id|jiffies
op_plus
id|DEFENSE_TIMER_PERIOD
)paren
suffix:semicolon
)brace
r_int
DECL|function|ip_vs_use_count_inc
id|ip_vs_use_count_inc
c_func
(paren
r_void
)paren
(brace
r_return
id|try_module_get
c_func
(paren
id|THIS_MODULE
)paren
suffix:semicolon
)brace
r_void
DECL|function|ip_vs_use_count_dec
id|ip_vs_use_count_dec
c_func
(paren
r_void
)paren
(brace
id|module_put
c_func
(paren
id|THIS_MODULE
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Hash table: for virtual service lookups&n; */
DECL|macro|IP_VS_SVC_TAB_BITS
mdefine_line|#define IP_VS_SVC_TAB_BITS 8
DECL|macro|IP_VS_SVC_TAB_SIZE
mdefine_line|#define IP_VS_SVC_TAB_SIZE (1 &lt;&lt; IP_VS_SVC_TAB_BITS)
DECL|macro|IP_VS_SVC_TAB_MASK
mdefine_line|#define IP_VS_SVC_TAB_MASK (IP_VS_SVC_TAB_SIZE - 1)
multiline_comment|/* the service table hashed by &lt;protocol, addr, port&gt; */
DECL|variable|ip_vs_svc_table
r_static
r_struct
id|list_head
id|ip_vs_svc_table
(braket
id|IP_VS_SVC_TAB_SIZE
)braket
suffix:semicolon
multiline_comment|/* the service table hashed by fwmark */
DECL|variable|ip_vs_svc_fwm_table
r_static
r_struct
id|list_head
id|ip_vs_svc_fwm_table
(braket
id|IP_VS_SVC_TAB_SIZE
)braket
suffix:semicolon
multiline_comment|/*&n; *&t;Hash table: for real service lookups&n; */
DECL|macro|IP_VS_RTAB_BITS
mdefine_line|#define IP_VS_RTAB_BITS 4
DECL|macro|IP_VS_RTAB_SIZE
mdefine_line|#define IP_VS_RTAB_SIZE (1 &lt;&lt; IP_VS_RTAB_BITS)
DECL|macro|IP_VS_RTAB_MASK
mdefine_line|#define IP_VS_RTAB_MASK (IP_VS_RTAB_SIZE - 1)
DECL|variable|ip_vs_rtable
r_static
r_struct
id|list_head
id|ip_vs_rtable
(braket
id|IP_VS_RTAB_SIZE
)braket
suffix:semicolon
multiline_comment|/*&n; *&t;Trash for destinations&n; */
r_static
id|LIST_HEAD
c_func
(paren
id|ip_vs_dest_trash
)paren
suffix:semicolon
multiline_comment|/*&n; *&t;FTP &amp; NULL virtual service counters&n; */
DECL|variable|ip_vs_ftpsvc_counter
r_static
id|atomic_t
id|ip_vs_ftpsvc_counter
op_assign
id|ATOMIC_INIT
c_func
(paren
l_int|0
)paren
suffix:semicolon
DECL|variable|ip_vs_nullsvc_counter
r_static
id|atomic_t
id|ip_vs_nullsvc_counter
op_assign
id|ATOMIC_INIT
c_func
(paren
l_int|0
)paren
suffix:semicolon
multiline_comment|/*&n; *&t;Returns hash value for virtual service&n; */
r_static
id|__inline__
r_int
DECL|function|ip_vs_svc_hashkey
id|ip_vs_svc_hashkey
c_func
(paren
r_int
id|proto
comma
id|__u32
id|addr
comma
id|__u16
id|port
)paren
(brace
r_register
r_int
id|porth
op_assign
id|ntohs
c_func
(paren
id|port
)paren
suffix:semicolon
r_return
(paren
id|proto
op_xor
id|ntohl
c_func
(paren
id|addr
)paren
op_xor
(paren
id|porth
op_rshift
id|IP_VS_SVC_TAB_BITS
)paren
op_xor
id|porth
)paren
op_amp
id|IP_VS_SVC_TAB_MASK
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Returns hash value of fwmark for virtual service lookup&n; */
DECL|function|ip_vs_svc_fwm_hashkey
r_static
id|__inline__
r_int
id|ip_vs_svc_fwm_hashkey
c_func
(paren
id|__u32
id|fwmark
)paren
(brace
r_return
id|fwmark
op_amp
id|IP_VS_SVC_TAB_MASK
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Hashes a service in the ip_vs_svc_table by &lt;proto,addr,port&gt;&n; *&t;or in the ip_vs_svc_fwm_table by fwmark.&n; *&t;Should be called with locked tables.&n; */
DECL|function|ip_vs_svc_hash
r_static
r_int
id|ip_vs_svc_hash
c_func
(paren
r_struct
id|ip_vs_service
op_star
id|svc
)paren
(brace
r_int
id|hash
suffix:semicolon
r_if
c_cond
(paren
id|svc-&gt;flags
op_amp
id|IP_VS_SVC_F_HASHED
)paren
(brace
id|IP_VS_ERR
c_func
(paren
l_string|&quot;ip_vs_svc_hash(): request for already hashed, &quot;
l_string|&quot;called from %p&bslash;n&quot;
comma
id|__builtin_return_address
c_func
(paren
l_int|0
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|svc-&gt;fwmark
op_eq
l_int|0
)paren
(brace
multiline_comment|/*&n;&t;&t; *  Hash it by &lt;protocol,addr,port&gt; in ip_vs_svc_table&n;&t;&t; */
id|hash
op_assign
id|ip_vs_svc_hashkey
c_func
(paren
id|svc-&gt;protocol
comma
id|svc-&gt;addr
comma
id|svc-&gt;port
)paren
suffix:semicolon
id|list_add
c_func
(paren
op_amp
id|svc-&gt;s_list
comma
op_amp
id|ip_vs_svc_table
(braket
id|hash
)braket
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t; *  Hash it by fwmark in ip_vs_svc_fwm_table&n;&t;&t; */
id|hash
op_assign
id|ip_vs_svc_fwm_hashkey
c_func
(paren
id|svc-&gt;fwmark
)paren
suffix:semicolon
id|list_add
c_func
(paren
op_amp
id|svc-&gt;f_list
comma
op_amp
id|ip_vs_svc_fwm_table
(braket
id|hash
)braket
)paren
suffix:semicolon
)brace
id|svc-&gt;flags
op_or_assign
id|IP_VS_SVC_F_HASHED
suffix:semicolon
multiline_comment|/* increase its refcnt because it is referenced by the svc table */
id|atomic_inc
c_func
(paren
op_amp
id|svc-&gt;refcnt
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Unhashes a service from ip_vs_svc_table/ip_vs_svc_fwm_table.&n; *&t;Should be called with locked tables.&n; */
DECL|function|ip_vs_svc_unhash
r_static
r_int
id|ip_vs_svc_unhash
c_func
(paren
r_struct
id|ip_vs_service
op_star
id|svc
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|svc-&gt;flags
op_amp
id|IP_VS_SVC_F_HASHED
)paren
)paren
(brace
id|IP_VS_ERR
c_func
(paren
l_string|&quot;ip_vs_svc_unhash(): request for unhash flagged, &quot;
l_string|&quot;called from %p&bslash;n&quot;
comma
id|__builtin_return_address
c_func
(paren
l_int|0
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|svc-&gt;fwmark
op_eq
l_int|0
)paren
(brace
multiline_comment|/* Remove it from the ip_vs_svc_table table */
id|list_del
c_func
(paren
op_amp
id|svc-&gt;s_list
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Remove it from the ip_vs_svc_fwm_table table */
id|list_del
c_func
(paren
op_amp
id|svc-&gt;f_list
)paren
suffix:semicolon
)brace
id|svc-&gt;flags
op_and_assign
op_complement
id|IP_VS_SVC_F_HASHED
suffix:semicolon
id|atomic_dec
c_func
(paren
op_amp
id|svc-&gt;refcnt
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Get service by {proto,addr,port} in the service table.&n; */
r_static
id|__inline__
r_struct
id|ip_vs_service
op_star
DECL|function|__ip_vs_service_get
id|__ip_vs_service_get
c_func
(paren
id|__u16
id|protocol
comma
id|__u32
id|vaddr
comma
id|__u16
id|vport
)paren
(brace
r_int
id|hash
suffix:semicolon
r_struct
id|ip_vs_service
op_star
id|svc
suffix:semicolon
multiline_comment|/* Check for &quot;full&quot; addressed entries */
id|hash
op_assign
id|ip_vs_svc_hashkey
c_func
(paren
id|protocol
comma
id|vaddr
comma
id|vport
)paren
suffix:semicolon
(def_block
id|list_for_each_entry
c_func
(paren
id|svc
comma
op_amp
id|ip_vs_svc_table
(braket
id|hash
)braket
comma
id|s_list
)paren
(brace
r_if
c_cond
(paren
(paren
id|svc-&gt;addr
op_eq
id|vaddr
)paren
op_logical_and
(paren
id|svc-&gt;port
op_eq
id|vport
)paren
op_logical_and
(paren
id|svc-&gt;protocol
op_eq
id|protocol
)paren
)paren
(brace
multiline_comment|/* HIT */
id|atomic_inc
c_func
(paren
op_amp
id|svc-&gt;usecnt
)paren
suffix:semicolon
r_return
id|svc
suffix:semicolon
)brace
)brace
)def_block
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Get service by {fwmark} in the service table.&n; */
DECL|function|__ip_vs_svc_fwm_get
r_static
id|__inline__
r_struct
id|ip_vs_service
op_star
id|__ip_vs_svc_fwm_get
c_func
(paren
id|__u32
id|fwmark
)paren
(brace
r_int
id|hash
suffix:semicolon
r_struct
id|ip_vs_service
op_star
id|svc
suffix:semicolon
multiline_comment|/* Check for fwmark addressed entries */
id|hash
op_assign
id|ip_vs_svc_fwm_hashkey
c_func
(paren
id|fwmark
)paren
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|svc
comma
op_amp
id|ip_vs_svc_fwm_table
(braket
id|hash
)braket
comma
id|f_list
)paren
(brace
r_if
c_cond
(paren
id|svc-&gt;fwmark
op_eq
id|fwmark
)paren
(brace
multiline_comment|/* HIT */
id|atomic_inc
c_func
(paren
op_amp
id|svc-&gt;usecnt
)paren
suffix:semicolon
r_return
id|svc
suffix:semicolon
)brace
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
r_struct
id|ip_vs_service
op_star
DECL|function|ip_vs_service_get
id|ip_vs_service_get
c_func
(paren
id|__u32
id|fwmark
comma
id|__u16
id|protocol
comma
id|__u32
id|vaddr
comma
id|__u16
id|vport
)paren
(brace
r_struct
id|ip_vs_service
op_star
id|svc
suffix:semicolon
id|read_lock
c_func
(paren
op_amp
id|__ip_vs_svc_lock
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Check the table hashed by fwmark first&n;&t; */
r_if
c_cond
(paren
id|fwmark
op_logical_and
(paren
id|svc
op_assign
id|__ip_vs_svc_fwm_get
c_func
(paren
id|fwmark
)paren
)paren
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Check the table hashed by &lt;protocol,addr,port&gt;&n;&t; *&t;for &quot;full&quot; addressed entries&n;&t; */
id|svc
op_assign
id|__ip_vs_service_get
c_func
(paren
id|protocol
comma
id|vaddr
comma
id|vport
)paren
suffix:semicolon
r_if
c_cond
(paren
id|svc
op_eq
l_int|NULL
op_logical_and
id|protocol
op_eq
id|IPPROTO_TCP
op_logical_and
id|atomic_read
c_func
(paren
op_amp
id|ip_vs_ftpsvc_counter
)paren
op_logical_and
(paren
id|vport
op_eq
id|FTPDATA
op_logical_or
id|ntohs
c_func
(paren
id|vport
)paren
op_ge
id|PROT_SOCK
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t; * Check if ftp service entry exists, the packet&n;&t;&t; * might belong to FTP data connections.&n;&t;&t; */
id|svc
op_assign
id|__ip_vs_service_get
c_func
(paren
id|protocol
comma
id|vaddr
comma
id|FTPPORT
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|svc
op_eq
l_int|NULL
op_logical_and
id|atomic_read
c_func
(paren
op_amp
id|ip_vs_nullsvc_counter
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t; * Check if the catch-all port (port zero) exists&n;&t;&t; */
id|svc
op_assign
id|__ip_vs_service_get
c_func
(paren
id|protocol
comma
id|vaddr
comma
l_int|0
)paren
suffix:semicolon
)brace
id|out
suffix:colon
id|read_unlock
c_func
(paren
op_amp
id|__ip_vs_svc_lock
)paren
suffix:semicolon
id|IP_VS_DBG
c_func
(paren
l_int|6
comma
l_string|&quot;lookup service: fwm %u %s %u.%u.%u.%u:%u %s&bslash;n&quot;
comma
id|fwmark
comma
id|ip_vs_proto_name
c_func
(paren
id|protocol
)paren
comma
id|NIPQUAD
c_func
(paren
id|vaddr
)paren
comma
id|ntohs
c_func
(paren
id|vport
)paren
comma
id|svc
ques
c_cond
l_string|&quot;hit&quot;
suffix:colon
l_string|&quot;not hit&quot;
)paren
suffix:semicolon
r_return
id|svc
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|__ip_vs_bind_svc
id|__ip_vs_bind_svc
c_func
(paren
r_struct
id|ip_vs_dest
op_star
id|dest
comma
r_struct
id|ip_vs_service
op_star
id|svc
)paren
(brace
id|atomic_inc
c_func
(paren
op_amp
id|svc-&gt;refcnt
)paren
suffix:semicolon
id|dest-&gt;svc
op_assign
id|svc
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|__ip_vs_unbind_svc
id|__ip_vs_unbind_svc
c_func
(paren
r_struct
id|ip_vs_dest
op_star
id|dest
)paren
(brace
r_struct
id|ip_vs_service
op_star
id|svc
op_assign
id|dest-&gt;svc
suffix:semicolon
id|dest-&gt;svc
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|atomic_dec_and_test
c_func
(paren
op_amp
id|svc-&gt;refcnt
)paren
)paren
id|kfree
c_func
(paren
id|svc
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Returns hash value for real service&n; */
DECL|function|ip_vs_rs_hashkey
r_static
id|__inline__
r_int
id|ip_vs_rs_hashkey
c_func
(paren
id|__u32
id|addr
comma
id|__u16
id|port
)paren
(brace
r_register
r_int
id|porth
op_assign
id|ntohs
c_func
(paren
id|port
)paren
suffix:semicolon
r_return
(paren
id|ntohl
c_func
(paren
id|addr
)paren
op_xor
(paren
id|porth
op_rshift
id|IP_VS_RTAB_BITS
)paren
op_xor
id|porth
)paren
op_amp
id|IP_VS_RTAB_MASK
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Hashes ip_vs_dest in ip_vs_rtable by &lt;proto,addr,port&gt;.&n; *&t;should be called with locked tables.&n; */
DECL|function|ip_vs_rs_hash
r_static
r_int
id|ip_vs_rs_hash
c_func
(paren
r_struct
id|ip_vs_dest
op_star
id|dest
)paren
(brace
r_int
id|hash
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|dest-&gt;d_list
)paren
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *&t;Hash by proto,addr,port,&n;&t; *&t;which are the parameters of the real service.&n;&t; */
id|hash
op_assign
id|ip_vs_rs_hashkey
c_func
(paren
id|dest-&gt;addr
comma
id|dest-&gt;port
)paren
suffix:semicolon
id|list_add
c_func
(paren
op_amp
id|dest-&gt;d_list
comma
op_amp
id|ip_vs_rtable
(braket
id|hash
)braket
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;UNhashes ip_vs_dest from ip_vs_rtable.&n; *&t;should be called with locked tables.&n; */
DECL|function|ip_vs_rs_unhash
r_static
r_int
id|ip_vs_rs_unhash
c_func
(paren
r_struct
id|ip_vs_dest
op_star
id|dest
)paren
(brace
multiline_comment|/*&n;&t; * Remove it from the ip_vs_rtable table.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|dest-&gt;d_list
)paren
)paren
(brace
id|list_del
c_func
(paren
op_amp
id|dest-&gt;d_list
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|dest-&gt;d_list
)paren
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Lookup real service by &lt;proto,addr,port&gt; in the real service table.&n; */
r_struct
id|ip_vs_dest
op_star
DECL|function|ip_vs_lookup_real_service
id|ip_vs_lookup_real_service
c_func
(paren
id|__u16
id|protocol
comma
id|__u32
id|daddr
comma
id|__u16
id|dport
)paren
(brace
r_int
id|hash
suffix:semicolon
r_struct
id|ip_vs_dest
op_star
id|dest
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Check for &quot;full&quot; addressed entries&n;&t; *&t;Return the first found entry&n;&t; */
id|hash
op_assign
id|ip_vs_rs_hashkey
c_func
(paren
id|daddr
comma
id|dport
)paren
suffix:semicolon
id|read_lock
c_func
(paren
op_amp
id|__ip_vs_rs_lock
)paren
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|dest
comma
op_amp
id|ip_vs_rtable
(braket
id|hash
)braket
comma
id|d_list
)paren
(brace
r_if
c_cond
(paren
(paren
id|dest-&gt;addr
op_eq
id|daddr
)paren
op_logical_and
(paren
id|dest-&gt;port
op_eq
id|dport
)paren
op_logical_and
(paren
(paren
id|dest-&gt;protocol
op_eq
id|protocol
)paren
op_logical_or
id|dest-&gt;vfwmark
)paren
)paren
(brace
multiline_comment|/* HIT */
id|read_unlock
c_func
(paren
op_amp
id|__ip_vs_rs_lock
)paren
suffix:semicolon
r_return
id|dest
suffix:semicolon
)brace
)brace
id|read_unlock
c_func
(paren
op_amp
id|__ip_vs_rs_lock
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Lookup destination by {addr,port} in the given service&n; */
r_static
r_struct
id|ip_vs_dest
op_star
DECL|function|ip_vs_lookup_dest
id|ip_vs_lookup_dest
c_func
(paren
r_struct
id|ip_vs_service
op_star
id|svc
comma
id|__u32
id|daddr
comma
id|__u16
id|dport
)paren
(brace
r_struct
id|ip_vs_dest
op_star
id|dest
suffix:semicolon
multiline_comment|/*&n;&t; * Find the destination for the given service&n;&t; */
id|list_for_each_entry
c_func
(paren
id|dest
comma
op_amp
id|svc-&gt;destinations
comma
id|n_list
)paren
(brace
r_if
c_cond
(paren
(paren
id|dest-&gt;addr
op_eq
id|daddr
)paren
op_logical_and
(paren
id|dest-&gt;port
op_eq
id|dport
)paren
)paren
(brace
multiline_comment|/* HIT */
r_return
id|dest
suffix:semicolon
)brace
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; *  Lookup dest by {svc,addr,port} in the destination trash.&n; *  The destination trash is used to hold the destinations that are removed&n; *  from the service table but are still referenced by some conn entries.&n; *  The reason to add the destination trash is when the dest is temporary&n; *  down (either by administrator or by monitor program), the dest can be&n; *  picked back from the trash, the remaining connections to the dest can&n; *  continue, and the counting information of the dest is also useful for&n; *  scheduling.&n; */
r_static
r_struct
id|ip_vs_dest
op_star
DECL|function|ip_vs_trash_get_dest
id|ip_vs_trash_get_dest
c_func
(paren
r_struct
id|ip_vs_service
op_star
id|svc
comma
id|__u32
id|daddr
comma
id|__u16
id|dport
)paren
(brace
r_struct
id|ip_vs_dest
op_star
id|dest
comma
op_star
id|nxt
suffix:semicolon
multiline_comment|/*&n;&t; * Find the destination in trash&n;&t; */
id|list_for_each_entry_safe
c_func
(paren
id|dest
comma
id|nxt
comma
op_amp
id|ip_vs_dest_trash
comma
id|n_list
)paren
(brace
id|IP_VS_DBG
c_func
(paren
l_int|3
comma
l_string|&quot;Destination %u/%u.%u.%u.%u:%u still in trash, &quot;
l_string|&quot;refcnt=%d&bslash;n&quot;
comma
id|dest-&gt;vfwmark
comma
id|NIPQUAD
c_func
(paren
id|dest-&gt;addr
)paren
comma
id|ntohs
c_func
(paren
id|dest-&gt;port
)paren
comma
id|atomic_read
c_func
(paren
op_amp
id|dest-&gt;refcnt
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dest-&gt;addr
op_eq
id|daddr
op_logical_and
id|dest-&gt;port
op_eq
id|dport
op_logical_and
id|dest-&gt;vfwmark
op_eq
id|svc-&gt;fwmark
op_logical_and
id|dest-&gt;protocol
op_eq
id|svc-&gt;protocol
op_logical_and
(paren
id|svc-&gt;fwmark
op_logical_or
(paren
id|dest-&gt;vaddr
op_eq
id|svc-&gt;addr
op_logical_and
id|dest-&gt;vport
op_eq
id|svc-&gt;port
)paren
)paren
)paren
(brace
multiline_comment|/* HIT */
r_return
id|dest
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * Try to purge the destination from trash if not referenced&n;&t;&t; */
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|dest-&gt;refcnt
)paren
op_eq
l_int|1
)paren
(brace
id|IP_VS_DBG
c_func
(paren
l_int|3
comma
l_string|&quot;Removing destination %u/%u.%u.%u.%u:%u &quot;
l_string|&quot;from trash&bslash;n&quot;
comma
id|dest-&gt;vfwmark
comma
id|NIPQUAD
c_func
(paren
id|dest-&gt;addr
)paren
comma
id|ntohs
c_func
(paren
id|dest-&gt;port
)paren
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|dest-&gt;n_list
)paren
suffix:semicolon
id|ip_vs_dst_reset
c_func
(paren
id|dest
)paren
suffix:semicolon
id|__ip_vs_unbind_svc
c_func
(paren
id|dest
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dest
)paren
suffix:semicolon
)brace
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; *  Clean up all the destinations in the trash&n; *  Called by the ip_vs_control_cleanup()&n; *&n; *  When the ip_vs_control_clearup is activated by ipvs module exit,&n; *  the service tables must have been flushed and all the connections&n; *  are expired, and the refcnt of each destination in the trash must&n; *  be 1, so we simply release them here.&n; */
DECL|function|ip_vs_trash_cleanup
r_static
r_void
id|ip_vs_trash_cleanup
c_func
(paren
r_void
)paren
(brace
r_struct
id|ip_vs_dest
op_star
id|dest
comma
op_star
id|nxt
suffix:semicolon
id|list_for_each_entry_safe
c_func
(paren
id|dest
comma
id|nxt
comma
op_amp
id|ip_vs_dest_trash
comma
id|n_list
)paren
(brace
id|list_del
c_func
(paren
op_amp
id|dest-&gt;n_list
)paren
suffix:semicolon
id|ip_vs_dst_reset
c_func
(paren
id|dest
)paren
suffix:semicolon
id|__ip_vs_unbind_svc
c_func
(paren
id|dest
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dest
)paren
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|ip_vs_zero_stats
id|ip_vs_zero_stats
c_func
(paren
r_struct
id|ip_vs_stats
op_star
id|stats
)paren
(brace
id|spin_lock_bh
c_func
(paren
op_amp
id|stats-&gt;lock
)paren
suffix:semicolon
id|memset
c_func
(paren
id|stats
comma
l_int|0
comma
(paren
r_char
op_star
)paren
op_amp
id|stats-&gt;lock
op_minus
(paren
r_char
op_star
)paren
id|stats
)paren
suffix:semicolon
id|spin_unlock_bh
c_func
(paren
op_amp
id|stats-&gt;lock
)paren
suffix:semicolon
id|ip_vs_zero_estimator
c_func
(paren
id|stats
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Update a destination in the given service&n; */
r_static
r_void
DECL|function|__ip_vs_update_dest
id|__ip_vs_update_dest
c_func
(paren
r_struct
id|ip_vs_service
op_star
id|svc
comma
r_struct
id|ip_vs_dest
op_star
id|dest
comma
r_struct
id|ip_vs_dest_user
op_star
id|udest
)paren
(brace
r_int
id|conn_flags
suffix:semicolon
multiline_comment|/* set the weight and the flags */
id|atomic_set
c_func
(paren
op_amp
id|dest-&gt;weight
comma
id|udest-&gt;weight
)paren
suffix:semicolon
id|conn_flags
op_assign
id|udest-&gt;conn_flags
op_or
id|IP_VS_CONN_F_INACTIVE
suffix:semicolon
multiline_comment|/* check if local node and update the flags */
r_if
c_cond
(paren
id|inet_addr_type
c_func
(paren
id|udest-&gt;addr
)paren
op_eq
id|RTN_LOCAL
)paren
(brace
id|conn_flags
op_assign
(paren
id|conn_flags
op_amp
op_complement
id|IP_VS_CONN_F_FWD_MASK
)paren
op_or
id|IP_VS_CONN_F_LOCALNODE
suffix:semicolon
)brace
multiline_comment|/* set the IP_VS_CONN_F_NOOUTPUT flag if not masquerading/NAT */
r_if
c_cond
(paren
(paren
id|conn_flags
op_amp
id|IP_VS_CONN_F_FWD_MASK
)paren
op_ne
l_int|0
)paren
(brace
id|conn_flags
op_or_assign
id|IP_VS_CONN_F_NOOUTPUT
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t; *    Put the real service in ip_vs_rtable if not present.&n;&t;&t; *    For now only for NAT!&n;&t;&t; */
id|write_lock_bh
c_func
(paren
op_amp
id|__ip_vs_rs_lock
)paren
suffix:semicolon
id|ip_vs_rs_hash
c_func
(paren
id|dest
)paren
suffix:semicolon
id|write_unlock_bh
c_func
(paren
op_amp
id|__ip_vs_rs_lock
)paren
suffix:semicolon
)brace
id|atomic_set
c_func
(paren
op_amp
id|dest-&gt;conn_flags
comma
id|conn_flags
)paren
suffix:semicolon
multiline_comment|/* bind the service */
r_if
c_cond
(paren
op_logical_neg
id|dest-&gt;svc
)paren
(brace
id|__ip_vs_bind_svc
c_func
(paren
id|dest
comma
id|svc
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|dest-&gt;svc
op_ne
id|svc
)paren
(brace
id|__ip_vs_unbind_svc
c_func
(paren
id|dest
)paren
suffix:semicolon
id|ip_vs_zero_stats
c_func
(paren
op_amp
id|dest-&gt;stats
)paren
suffix:semicolon
id|__ip_vs_bind_svc
c_func
(paren
id|dest
comma
id|svc
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* set the dest status flags */
id|dest-&gt;flags
op_or_assign
id|IP_VS_DEST_F_AVAILABLE
suffix:semicolon
r_if
c_cond
(paren
id|udest-&gt;u_threshold
op_eq
l_int|0
op_logical_or
id|udest-&gt;u_threshold
OG
id|dest-&gt;u_threshold
)paren
id|dest-&gt;flags
op_and_assign
op_complement
id|IP_VS_DEST_F_OVERLOAD
suffix:semicolon
id|dest-&gt;u_threshold
op_assign
id|udest-&gt;u_threshold
suffix:semicolon
id|dest-&gt;l_threshold
op_assign
id|udest-&gt;l_threshold
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Create a destination for the given service&n; */
r_static
r_int
DECL|function|ip_vs_new_dest
id|ip_vs_new_dest
c_func
(paren
r_struct
id|ip_vs_service
op_star
id|svc
comma
r_struct
id|ip_vs_dest_user
op_star
id|udest
comma
r_struct
id|ip_vs_dest
op_star
op_star
id|dest_p
)paren
(brace
r_struct
id|ip_vs_dest
op_star
id|dest
suffix:semicolon
r_int
id|atype
suffix:semicolon
id|EnterFunction
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|atype
op_assign
id|inet_addr_type
c_func
(paren
id|udest-&gt;addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atype
op_ne
id|RTN_LOCAL
op_logical_and
id|atype
op_ne
id|RTN_UNICAST
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|dest
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|ip_vs_dest
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dest
op_eq
l_int|NULL
)paren
(brace
id|IP_VS_ERR
c_func
(paren
l_string|&quot;ip_vs_new_dest: kmalloc failed.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|dest
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|ip_vs_dest
)paren
)paren
suffix:semicolon
id|dest-&gt;protocol
op_assign
id|svc-&gt;protocol
suffix:semicolon
id|dest-&gt;vaddr
op_assign
id|svc-&gt;addr
suffix:semicolon
id|dest-&gt;vport
op_assign
id|svc-&gt;port
suffix:semicolon
id|dest-&gt;vfwmark
op_assign
id|svc-&gt;fwmark
suffix:semicolon
id|dest-&gt;addr
op_assign
id|udest-&gt;addr
suffix:semicolon
id|dest-&gt;port
op_assign
id|udest-&gt;port
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|dest-&gt;activeconns
comma
l_int|0
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|dest-&gt;inactconns
comma
l_int|0
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|dest-&gt;persistconns
comma
l_int|0
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|dest-&gt;refcnt
comma
l_int|0
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|dest-&gt;d_list
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|dest-&gt;dst_lock
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|dest-&gt;stats.lock
)paren
suffix:semicolon
id|__ip_vs_update_dest
c_func
(paren
id|svc
comma
id|dest
comma
id|udest
)paren
suffix:semicolon
id|ip_vs_new_estimator
c_func
(paren
op_amp
id|dest-&gt;stats
)paren
suffix:semicolon
op_star
id|dest_p
op_assign
id|dest
suffix:semicolon
id|LeaveFunction
c_func
(paren
l_int|2
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Add a destination into an existing service&n; */
r_static
r_int
DECL|function|ip_vs_add_dest
id|ip_vs_add_dest
c_func
(paren
r_struct
id|ip_vs_service
op_star
id|svc
comma
r_struct
id|ip_vs_dest_user
op_star
id|udest
)paren
(brace
r_struct
id|ip_vs_dest
op_star
id|dest
suffix:semicolon
id|__u32
id|daddr
op_assign
id|udest-&gt;addr
suffix:semicolon
id|__u16
id|dport
op_assign
id|udest-&gt;port
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|EnterFunction
c_func
(paren
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|udest-&gt;weight
OL
l_int|0
)paren
(brace
id|IP_VS_ERR
c_func
(paren
l_string|&quot;ip_vs_add_dest(): server weight less than zero&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ERANGE
suffix:semicolon
)brace
r_if
c_cond
(paren
id|udest-&gt;l_threshold
OG
id|udest-&gt;u_threshold
)paren
(brace
id|IP_VS_ERR
c_func
(paren
l_string|&quot;ip_vs_add_dest(): lower threshold is higher than &quot;
l_string|&quot;upper threshold&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ERANGE
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Check if the dest already exists in the list&n;&t; */
id|dest
op_assign
id|ip_vs_lookup_dest
c_func
(paren
id|svc
comma
id|daddr
comma
id|dport
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dest
op_ne
l_int|NULL
)paren
(brace
id|IP_VS_DBG
c_func
(paren
l_int|1
comma
l_string|&quot;ip_vs_add_dest(): dest already exists&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EEXIST
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Check if the dest already exists in the trash and&n;&t; * is from the same service&n;&t; */
id|dest
op_assign
id|ip_vs_trash_get_dest
c_func
(paren
id|svc
comma
id|daddr
comma
id|dport
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dest
op_ne
l_int|NULL
)paren
(brace
id|IP_VS_DBG
c_func
(paren
l_int|3
comma
l_string|&quot;Get destination %u.%u.%u.%u:%u from trash, &quot;
l_string|&quot;refcnt=%d, service %u/%u.%u.%u.%u:%u&bslash;n&quot;
comma
id|NIPQUAD
c_func
(paren
id|daddr
)paren
comma
id|ntohs
c_func
(paren
id|dport
)paren
comma
id|atomic_read
c_func
(paren
op_amp
id|dest-&gt;refcnt
)paren
comma
id|dest-&gt;vfwmark
comma
id|NIPQUAD
c_func
(paren
id|dest-&gt;vaddr
)paren
comma
id|ntohs
c_func
(paren
id|dest-&gt;vport
)paren
)paren
suffix:semicolon
id|__ip_vs_update_dest
c_func
(paren
id|svc
comma
id|dest
comma
id|udest
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Get the destination from the trash&n;&t;&t; */
id|list_del
c_func
(paren
op_amp
id|dest-&gt;n_list
)paren
suffix:semicolon
id|ip_vs_new_estimator
c_func
(paren
op_amp
id|dest-&gt;stats
)paren
suffix:semicolon
id|write_lock_bh
c_func
(paren
op_amp
id|__ip_vs_svc_lock
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Wait until all other svc users go away.&n;&t;&t; */
id|IP_VS_WAIT_WHILE
c_func
(paren
id|atomic_read
c_func
(paren
op_amp
id|svc-&gt;usecnt
)paren
OG
l_int|1
)paren
suffix:semicolon
id|list_add
c_func
(paren
op_amp
id|dest-&gt;n_list
comma
op_amp
id|svc-&gt;destinations
)paren
suffix:semicolon
id|svc-&gt;num_dests
op_increment
suffix:semicolon
multiline_comment|/* call the update_service function of its scheduler */
id|svc-&gt;scheduler
op_member_access_from_pointer
id|update_service
c_func
(paren
id|svc
)paren
suffix:semicolon
id|write_unlock_bh
c_func
(paren
op_amp
id|__ip_vs_svc_lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Allocate and initialize the dest structure&n;&t; */
id|ret
op_assign
id|ip_vs_new_dest
c_func
(paren
id|svc
comma
id|udest
comma
op_amp
id|dest
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Add the dest entry into the list&n;&t; */
id|atomic_inc
c_func
(paren
op_amp
id|dest-&gt;refcnt
)paren
suffix:semicolon
id|write_lock_bh
c_func
(paren
op_amp
id|__ip_vs_svc_lock
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Wait until all other svc users go away.&n;&t; */
id|IP_VS_WAIT_WHILE
c_func
(paren
id|atomic_read
c_func
(paren
op_amp
id|svc-&gt;usecnt
)paren
OG
l_int|1
)paren
suffix:semicolon
id|list_add
c_func
(paren
op_amp
id|dest-&gt;n_list
comma
op_amp
id|svc-&gt;destinations
)paren
suffix:semicolon
id|svc-&gt;num_dests
op_increment
suffix:semicolon
multiline_comment|/* call the update_service function of its scheduler */
id|svc-&gt;scheduler
op_member_access_from_pointer
id|update_service
c_func
(paren
id|svc
)paren
suffix:semicolon
id|write_unlock_bh
c_func
(paren
op_amp
id|__ip_vs_svc_lock
)paren
suffix:semicolon
id|LeaveFunction
c_func
(paren
l_int|2
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Edit a destination in the given service&n; */
r_static
r_int
DECL|function|ip_vs_edit_dest
id|ip_vs_edit_dest
c_func
(paren
r_struct
id|ip_vs_service
op_star
id|svc
comma
r_struct
id|ip_vs_dest_user
op_star
id|udest
)paren
(brace
r_struct
id|ip_vs_dest
op_star
id|dest
suffix:semicolon
id|__u32
id|daddr
op_assign
id|udest-&gt;addr
suffix:semicolon
id|__u16
id|dport
op_assign
id|udest-&gt;port
suffix:semicolon
id|EnterFunction
c_func
(paren
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|udest-&gt;weight
OL
l_int|0
)paren
(brace
id|IP_VS_ERR
c_func
(paren
l_string|&quot;ip_vs_edit_dest(): server weight less than zero&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ERANGE
suffix:semicolon
)brace
r_if
c_cond
(paren
id|udest-&gt;l_threshold
OG
id|udest-&gt;u_threshold
)paren
(brace
id|IP_VS_ERR
c_func
(paren
l_string|&quot;ip_vs_edit_dest(): lower threshold is higher than &quot;
l_string|&quot;upper threshold&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ERANGE
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *  Lookup the destination list&n;&t; */
id|dest
op_assign
id|ip_vs_lookup_dest
c_func
(paren
id|svc
comma
id|daddr
comma
id|dport
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dest
op_eq
l_int|NULL
)paren
(brace
id|IP_VS_DBG
c_func
(paren
l_int|1
comma
l_string|&quot;ip_vs_edit_dest(): dest doesn&squot;t exist&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOENT
suffix:semicolon
)brace
id|__ip_vs_update_dest
c_func
(paren
id|svc
comma
id|dest
comma
id|udest
)paren
suffix:semicolon
id|write_lock_bh
c_func
(paren
op_amp
id|__ip_vs_svc_lock
)paren
suffix:semicolon
multiline_comment|/* Wait until all other svc users go away */
r_while
c_loop
(paren
id|atomic_read
c_func
(paren
op_amp
id|svc-&gt;usecnt
)paren
OG
l_int|1
)paren
(brace
)brace
suffix:semicolon
multiline_comment|/* call the update_service, because server weight may be changed */
id|svc-&gt;scheduler
op_member_access_from_pointer
id|update_service
c_func
(paren
id|svc
)paren
suffix:semicolon
id|write_unlock_bh
c_func
(paren
op_amp
id|__ip_vs_svc_lock
)paren
suffix:semicolon
id|LeaveFunction
c_func
(paren
l_int|2
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Delete a destination (must be already unlinked from the service)&n; */
DECL|function|__ip_vs_del_dest
r_static
r_void
id|__ip_vs_del_dest
c_func
(paren
r_struct
id|ip_vs_dest
op_star
id|dest
)paren
(brace
id|ip_vs_kill_estimator
c_func
(paren
op_amp
id|dest-&gt;stats
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *  Remove it from the d-linked list with the real services.&n;&t; */
id|write_lock_bh
c_func
(paren
op_amp
id|__ip_vs_rs_lock
)paren
suffix:semicolon
id|ip_vs_rs_unhash
c_func
(paren
id|dest
)paren
suffix:semicolon
id|write_unlock_bh
c_func
(paren
op_amp
id|__ip_vs_rs_lock
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *  Decrease the refcnt of the dest, and free the dest&n;&t; *  if nobody refers to it (refcnt=0). Otherwise, throw&n;&t; *  the destination into the trash.&n;&t; */
r_if
c_cond
(paren
id|atomic_dec_and_test
c_func
(paren
op_amp
id|dest-&gt;refcnt
)paren
)paren
(brace
id|ip_vs_dst_reset
c_func
(paren
id|dest
)paren
suffix:semicolon
multiline_comment|/* simply decrease svc-&gt;refcnt here, let the caller check&n;&t;&t;   and release the service if nobody refers to it.&n;&t;&t;   Only user context can release destination and service,&n;&t;&t;   and only one user context can update virtual service at a&n;&t;&t;   time, so the operation here is OK */
id|atomic_dec
c_func
(paren
op_amp
id|dest-&gt;svc-&gt;refcnt
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dest
)paren
suffix:semicolon
)brace
r_else
(brace
id|IP_VS_DBG
c_func
(paren
l_int|3
comma
l_string|&quot;Moving dest %u.%u.%u.%u:%u into trash, refcnt=%d&bslash;n&quot;
comma
id|NIPQUAD
c_func
(paren
id|dest-&gt;addr
)paren
comma
id|ntohs
c_func
(paren
id|dest-&gt;port
)paren
comma
id|atomic_read
c_func
(paren
op_amp
id|dest-&gt;refcnt
)paren
)paren
suffix:semicolon
id|list_add
c_func
(paren
op_amp
id|dest-&gt;n_list
comma
op_amp
id|ip_vs_dest_trash
)paren
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|dest-&gt;refcnt
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; *&t;Unlink a destination from the given service&n; */
DECL|function|__ip_vs_unlink_dest
r_static
r_void
id|__ip_vs_unlink_dest
c_func
(paren
r_struct
id|ip_vs_service
op_star
id|svc
comma
r_struct
id|ip_vs_dest
op_star
id|dest
comma
r_int
id|svcupd
)paren
(brace
id|dest-&gt;flags
op_and_assign
op_complement
id|IP_VS_DEST_F_AVAILABLE
suffix:semicolon
multiline_comment|/*&n;&t; *  Remove it from the d-linked destination list.&n;&t; */
id|list_del
c_func
(paren
op_amp
id|dest-&gt;n_list
)paren
suffix:semicolon
id|svc-&gt;num_dests
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|svcupd
)paren
(brace
multiline_comment|/*&n;&t;&t; *  Call the update_service function of its scheduler&n;&t;&t; */
id|svc-&gt;scheduler
op_member_access_from_pointer
id|update_service
c_func
(paren
id|svc
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; *&t;Delete a destination server in the given service&n; */
r_static
r_int
DECL|function|ip_vs_del_dest
id|ip_vs_del_dest
c_func
(paren
r_struct
id|ip_vs_service
op_star
id|svc
comma
r_struct
id|ip_vs_dest_user
op_star
id|udest
)paren
(brace
r_struct
id|ip_vs_dest
op_star
id|dest
suffix:semicolon
id|__u32
id|daddr
op_assign
id|udest-&gt;addr
suffix:semicolon
id|__u16
id|dport
op_assign
id|udest-&gt;port
suffix:semicolon
id|EnterFunction
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|dest
op_assign
id|ip_vs_lookup_dest
c_func
(paren
id|svc
comma
id|daddr
comma
id|dport
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dest
op_eq
l_int|NULL
)paren
(brace
id|IP_VS_DBG
c_func
(paren
l_int|1
comma
l_string|&quot;ip_vs_del_dest(): destination not found!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOENT
suffix:semicolon
)brace
id|write_lock_bh
c_func
(paren
op_amp
id|__ip_vs_svc_lock
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Wait until all other svc users go away.&n;&t; */
id|IP_VS_WAIT_WHILE
c_func
(paren
id|atomic_read
c_func
(paren
op_amp
id|svc-&gt;usecnt
)paren
OG
l_int|1
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Unlink dest from the service&n;&t; */
id|__ip_vs_unlink_dest
c_func
(paren
id|svc
comma
id|dest
comma
l_int|1
)paren
suffix:semicolon
id|write_unlock_bh
c_func
(paren
op_amp
id|__ip_vs_svc_lock
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Delete the destination&n;&t; */
id|__ip_vs_del_dest
c_func
(paren
id|dest
)paren
suffix:semicolon
id|LeaveFunction
c_func
(paren
l_int|2
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Add a service into the service hash table&n; */
r_static
r_int
DECL|function|ip_vs_add_service
id|ip_vs_add_service
c_func
(paren
r_struct
id|ip_vs_service_user
op_star
id|u
comma
r_struct
id|ip_vs_service
op_star
op_star
id|svc_p
)paren
(brace
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_struct
id|ip_vs_scheduler
op_star
id|sched
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|ip_vs_service
op_star
id|svc
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* increase the module use count */
id|ip_vs_use_count_inc
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Lookup the scheduler by &squot;u-&gt;sched_name&squot; */
id|sched
op_assign
id|ip_vs_scheduler_get
c_func
(paren
id|u-&gt;sched_name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sched
op_eq
l_int|NULL
)paren
(brace
id|IP_VS_INFO
c_func
(paren
l_string|&quot;Scheduler module ip_vs_%s not found&bslash;n&quot;
comma
id|u-&gt;sched_name
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|ENOENT
suffix:semicolon
r_goto
id|out_mod_dec
suffix:semicolon
)brace
id|svc
op_assign
(paren
r_struct
id|ip_vs_service
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|ip_vs_service
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|svc
op_eq
l_int|NULL
)paren
(brace
id|IP_VS_DBG
c_func
(paren
l_int|1
comma
l_string|&quot;ip_vs_add_service: kmalloc failed.&bslash;n&quot;
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|out_err
suffix:semicolon
)brace
id|memset
c_func
(paren
id|svc
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|ip_vs_service
)paren
)paren
suffix:semicolon
multiline_comment|/* I&squot;m the first user of the service */
id|atomic_set
c_func
(paren
op_amp
id|svc-&gt;usecnt
comma
l_int|1
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|svc-&gt;refcnt
comma
l_int|0
)paren
suffix:semicolon
id|svc-&gt;protocol
op_assign
id|u-&gt;protocol
suffix:semicolon
id|svc-&gt;addr
op_assign
id|u-&gt;addr
suffix:semicolon
id|svc-&gt;port
op_assign
id|u-&gt;port
suffix:semicolon
id|svc-&gt;fwmark
op_assign
id|u-&gt;fwmark
suffix:semicolon
id|svc-&gt;flags
op_assign
id|u-&gt;flags
suffix:semicolon
id|svc-&gt;timeout
op_assign
id|u-&gt;timeout
op_star
id|HZ
suffix:semicolon
id|svc-&gt;netmask
op_assign
id|u-&gt;netmask
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|svc-&gt;destinations
)paren
suffix:semicolon
id|rwlock_init
c_func
(paren
op_amp
id|svc-&gt;sched_lock
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|svc-&gt;stats.lock
)paren
suffix:semicolon
multiline_comment|/* Bind the scheduler */
id|ret
op_assign
id|ip_vs_bind_scheduler
c_func
(paren
id|svc
comma
id|sched
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_goto
id|out_err
suffix:semicolon
id|sched
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Update the virtual service counters */
r_if
c_cond
(paren
id|svc-&gt;port
op_eq
id|FTPPORT
)paren
id|atomic_inc
c_func
(paren
op_amp
id|ip_vs_ftpsvc_counter
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|svc-&gt;port
op_eq
l_int|0
)paren
id|atomic_inc
c_func
(paren
op_amp
id|ip_vs_nullsvc_counter
)paren
suffix:semicolon
id|ip_vs_new_estimator
c_func
(paren
op_amp
id|svc-&gt;stats
)paren
suffix:semicolon
id|ip_vs_num_services
op_increment
suffix:semicolon
multiline_comment|/* Hash the service into the service table */
id|write_lock_bh
c_func
(paren
op_amp
id|__ip_vs_svc_lock
)paren
suffix:semicolon
id|ip_vs_svc_hash
c_func
(paren
id|svc
)paren
suffix:semicolon
id|write_unlock_bh
c_func
(paren
op_amp
id|__ip_vs_svc_lock
)paren
suffix:semicolon
op_star
id|svc_p
op_assign
id|svc
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|out_err
suffix:colon
r_if
c_cond
(paren
id|svc
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|svc-&gt;scheduler
)paren
id|ip_vs_unbind_scheduler
c_func
(paren
id|svc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|svc-&gt;inc
)paren
(brace
id|local_bh_disable
c_func
(paren
)paren
suffix:semicolon
id|ip_vs_app_inc_put
c_func
(paren
id|svc-&gt;inc
)paren
suffix:semicolon
id|local_bh_enable
c_func
(paren
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|svc
)paren
suffix:semicolon
)brace
id|ip_vs_scheduler_put
c_func
(paren
id|sched
)paren
suffix:semicolon
id|out_mod_dec
suffix:colon
multiline_comment|/* decrease the module use count */
id|ip_vs_use_count_dec
c_func
(paren
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Edit a service and bind it with a new scheduler&n; */
r_static
r_int
DECL|function|ip_vs_edit_service
id|ip_vs_edit_service
c_func
(paren
r_struct
id|ip_vs_service
op_star
id|svc
comma
r_struct
id|ip_vs_service_user
op_star
id|u
)paren
(brace
r_struct
id|ip_vs_scheduler
op_star
id|sched
comma
op_star
id|old_sched
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; * Lookup the scheduler, by &squot;u-&gt;sched_name&squot;&n;&t; */
id|sched
op_assign
id|ip_vs_scheduler_get
c_func
(paren
id|u-&gt;sched_name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sched
op_eq
l_int|NULL
)paren
(brace
id|IP_VS_INFO
c_func
(paren
l_string|&quot;Scheduler module ip_vs_%s not found&bslash;n&quot;
comma
id|u-&gt;sched_name
)paren
suffix:semicolon
r_return
op_minus
id|ENOENT
suffix:semicolon
)brace
id|old_sched
op_assign
id|sched
suffix:semicolon
id|write_lock_bh
c_func
(paren
op_amp
id|__ip_vs_svc_lock
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Wait until all other svc users go away.&n;&t; */
id|IP_VS_WAIT_WHILE
c_func
(paren
id|atomic_read
c_func
(paren
op_amp
id|svc-&gt;usecnt
)paren
OG
l_int|1
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Set the flags and timeout value&n;&t; */
id|svc-&gt;flags
op_assign
id|u-&gt;flags
op_or
id|IP_VS_SVC_F_HASHED
suffix:semicolon
id|svc-&gt;timeout
op_assign
id|u-&gt;timeout
op_star
id|HZ
suffix:semicolon
id|svc-&gt;netmask
op_assign
id|u-&gt;netmask
suffix:semicolon
id|old_sched
op_assign
id|svc-&gt;scheduler
suffix:semicolon
r_if
c_cond
(paren
id|sched
op_ne
id|old_sched
)paren
(brace
multiline_comment|/*&n;&t;&t; * Unbind the old scheduler&n;&t;&t; */
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|ip_vs_unbind_scheduler
c_func
(paren
id|svc
)paren
)paren
)paren
(brace
id|old_sched
op_assign
id|sched
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * Bind the new scheduler&n;&t;&t; */
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|ip_vs_bind_scheduler
c_func
(paren
id|svc
comma
id|sched
)paren
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * If ip_vs_bind_scheduler fails, restore the old&n;&t;&t;&t; * scheduler.&n;&t;&t;&t; * The main reason of failure is out of memory.&n;&t;&t;&t; *&n;&t;&t;&t; * The question is if the old scheduler can be&n;&t;&t;&t; * restored all the time. TODO: if it cannot be&n;&t;&t;&t; * restored some time, we must delete the service,&n;&t;&t;&t; * otherwise the system may crash.&n;&t;&t;&t; */
id|ip_vs_bind_scheduler
c_func
(paren
id|svc
comma
id|old_sched
)paren
suffix:semicolon
id|old_sched
op_assign
id|sched
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
id|out
suffix:colon
id|write_unlock_bh
c_func
(paren
op_amp
id|__ip_vs_svc_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|old_sched
)paren
id|ip_vs_scheduler_put
c_func
(paren
id|old_sched
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Delete a service from the service list&n; *&t;- The service must be unlinked, unlocked and not referenced!&n; *&t;- We are called under _bh lock&n; */
DECL|function|__ip_vs_del_service
r_static
r_void
id|__ip_vs_del_service
c_func
(paren
r_struct
id|ip_vs_service
op_star
id|svc
)paren
(brace
r_struct
id|ip_vs_dest
op_star
id|dest
comma
op_star
id|nxt
suffix:semicolon
r_struct
id|ip_vs_scheduler
op_star
id|old_sched
suffix:semicolon
id|ip_vs_num_services
op_decrement
suffix:semicolon
id|ip_vs_kill_estimator
c_func
(paren
op_amp
id|svc-&gt;stats
)paren
suffix:semicolon
multiline_comment|/* Unbind scheduler */
id|old_sched
op_assign
id|svc-&gt;scheduler
suffix:semicolon
id|ip_vs_unbind_scheduler
c_func
(paren
id|svc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|old_sched
)paren
id|ip_vs_scheduler_put
c_func
(paren
id|old_sched
)paren
suffix:semicolon
multiline_comment|/* Unbind app inc */
r_if
c_cond
(paren
id|svc-&gt;inc
)paren
(brace
id|ip_vs_app_inc_put
c_func
(paren
id|svc-&gt;inc
)paren
suffix:semicolon
id|svc-&gt;inc
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *    Unlink the whole destination list&n;&t; */
id|list_for_each_entry_safe
c_func
(paren
id|dest
comma
id|nxt
comma
op_amp
id|svc-&gt;destinations
comma
id|n_list
)paren
(brace
id|__ip_vs_unlink_dest
c_func
(paren
id|svc
comma
id|dest
comma
l_int|0
)paren
suffix:semicolon
id|__ip_vs_del_dest
c_func
(paren
id|dest
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; *    Update the virtual service counters&n;&t; */
r_if
c_cond
(paren
id|svc-&gt;port
op_eq
id|FTPPORT
)paren
id|atomic_dec
c_func
(paren
op_amp
id|ip_vs_ftpsvc_counter
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|svc-&gt;port
op_eq
l_int|0
)paren
id|atomic_dec
c_func
(paren
op_amp
id|ip_vs_nullsvc_counter
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *    Free the service if nobody refers to it&n;&t; */
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|svc-&gt;refcnt
)paren
op_eq
l_int|0
)paren
id|kfree
c_func
(paren
id|svc
)paren
suffix:semicolon
multiline_comment|/* decrease the module use count */
id|ip_vs_use_count_dec
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Delete a service from the service list&n; */
DECL|function|ip_vs_del_service
r_static
r_int
id|ip_vs_del_service
c_func
(paren
r_struct
id|ip_vs_service
op_star
id|svc
)paren
(brace
r_if
c_cond
(paren
id|svc
op_eq
l_int|NULL
)paren
r_return
op_minus
id|EEXIST
suffix:semicolon
multiline_comment|/*&n;&t; * Unhash it from the service table&n;&t; */
id|write_lock_bh
c_func
(paren
op_amp
id|__ip_vs_svc_lock
)paren
suffix:semicolon
id|ip_vs_svc_unhash
c_func
(paren
id|svc
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Wait until all the svc users go away.&n;&t; */
id|IP_VS_WAIT_WHILE
c_func
(paren
id|atomic_read
c_func
(paren
op_amp
id|svc-&gt;usecnt
)paren
OG
l_int|1
)paren
suffix:semicolon
id|__ip_vs_del_service
c_func
(paren
id|svc
)paren
suffix:semicolon
id|write_unlock_bh
c_func
(paren
op_amp
id|__ip_vs_svc_lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Flush all the virtual services&n; */
DECL|function|ip_vs_flush
r_static
r_int
id|ip_vs_flush
c_func
(paren
r_void
)paren
(brace
r_int
id|idx
suffix:semicolon
r_struct
id|ip_vs_service
op_star
id|svc
comma
op_star
id|nxt
suffix:semicolon
multiline_comment|/*&n;&t; * Flush the service table hashed by &lt;protocol,addr,port&gt;&n;&t; */
r_for
c_loop
(paren
id|idx
op_assign
l_int|0
suffix:semicolon
id|idx
OL
id|IP_VS_SVC_TAB_SIZE
suffix:semicolon
id|idx
op_increment
)paren
(brace
id|list_for_each_entry_safe
c_func
(paren
id|svc
comma
id|nxt
comma
op_amp
id|ip_vs_svc_table
(braket
id|idx
)braket
comma
id|s_list
)paren
(brace
id|write_lock_bh
c_func
(paren
op_amp
id|__ip_vs_svc_lock
)paren
suffix:semicolon
id|ip_vs_svc_unhash
c_func
(paren
id|svc
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * Wait until all the svc users go away.&n;&t;&t;&t; */
id|IP_VS_WAIT_WHILE
c_func
(paren
id|atomic_read
c_func
(paren
op_amp
id|svc-&gt;usecnt
)paren
OG
l_int|0
)paren
suffix:semicolon
id|__ip_vs_del_service
c_func
(paren
id|svc
)paren
suffix:semicolon
id|write_unlock_bh
c_func
(paren
op_amp
id|__ip_vs_svc_lock
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t; * Flush the service table hashed by fwmark&n;&t; */
r_for
c_loop
(paren
id|idx
op_assign
l_int|0
suffix:semicolon
id|idx
OL
id|IP_VS_SVC_TAB_SIZE
suffix:semicolon
id|idx
op_increment
)paren
(brace
id|list_for_each_entry_safe
c_func
(paren
id|svc
comma
id|nxt
comma
op_amp
id|ip_vs_svc_fwm_table
(braket
id|idx
)braket
comma
id|f_list
)paren
(brace
id|write_lock_bh
c_func
(paren
op_amp
id|__ip_vs_svc_lock
)paren
suffix:semicolon
id|ip_vs_svc_unhash
c_func
(paren
id|svc
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * Wait until all the svc users go away.&n;&t;&t;&t; */
id|IP_VS_WAIT_WHILE
c_func
(paren
id|atomic_read
c_func
(paren
op_amp
id|svc-&gt;usecnt
)paren
OG
l_int|0
)paren
suffix:semicolon
id|__ip_vs_del_service
c_func
(paren
id|svc
)paren
suffix:semicolon
id|write_unlock_bh
c_func
(paren
op_amp
id|__ip_vs_svc_lock
)paren
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Zero counters in a service or all services&n; */
DECL|function|ip_vs_zero_service
r_static
r_int
id|ip_vs_zero_service
c_func
(paren
r_struct
id|ip_vs_service
op_star
id|svc
)paren
(brace
r_struct
id|ip_vs_dest
op_star
id|dest
suffix:semicolon
id|write_lock_bh
c_func
(paren
op_amp
id|__ip_vs_svc_lock
)paren
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|dest
comma
op_amp
id|svc-&gt;destinations
comma
id|n_list
)paren
(brace
id|ip_vs_zero_stats
c_func
(paren
op_amp
id|dest-&gt;stats
)paren
suffix:semicolon
)brace
id|ip_vs_zero_stats
c_func
(paren
op_amp
id|svc-&gt;stats
)paren
suffix:semicolon
id|write_unlock_bh
c_func
(paren
op_amp
id|__ip_vs_svc_lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ip_vs_zero_all
r_static
r_int
id|ip_vs_zero_all
c_func
(paren
r_void
)paren
(brace
r_int
id|idx
suffix:semicolon
r_struct
id|ip_vs_service
op_star
id|svc
suffix:semicolon
r_for
c_loop
(paren
id|idx
op_assign
l_int|0
suffix:semicolon
id|idx
OL
id|IP_VS_SVC_TAB_SIZE
suffix:semicolon
id|idx
op_increment
)paren
(brace
id|list_for_each_entry
c_func
(paren
id|svc
comma
op_amp
id|ip_vs_svc_table
(braket
id|idx
)braket
comma
id|s_list
)paren
(brace
id|ip_vs_zero_service
c_func
(paren
id|svc
)paren
suffix:semicolon
)brace
)brace
r_for
c_loop
(paren
id|idx
op_assign
l_int|0
suffix:semicolon
id|idx
OL
id|IP_VS_SVC_TAB_SIZE
suffix:semicolon
id|idx
op_increment
)paren
(brace
id|list_for_each_entry
c_func
(paren
id|svc
comma
op_amp
id|ip_vs_svc_fwm_table
(braket
id|idx
)braket
comma
id|f_list
)paren
(brace
id|ip_vs_zero_service
c_func
(paren
id|svc
)paren
suffix:semicolon
)brace
)brace
id|ip_vs_zero_stats
c_func
(paren
op_amp
id|ip_vs_stats
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|proc_do_defense_mode
id|proc_do_defense_mode
c_func
(paren
id|ctl_table
op_star
id|table
comma
r_int
id|write
comma
r_struct
id|file
op_star
id|filp
comma
r_void
id|__user
op_star
id|buffer
comma
r_int
op_star
id|lenp
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_int
op_star
id|valp
op_assign
id|table-&gt;data
suffix:semicolon
r_int
id|val
op_assign
op_star
id|valp
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|rc
op_assign
id|proc_dointvec
c_func
(paren
id|table
comma
id|write
comma
id|filp
comma
id|buffer
comma
id|lenp
comma
id|ppos
)paren
suffix:semicolon
r_if
c_cond
(paren
id|write
op_logical_and
(paren
op_star
id|valp
op_ne
id|val
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
op_star
id|valp
OL
l_int|0
)paren
op_logical_or
(paren
op_star
id|valp
OG
l_int|3
)paren
)paren
(brace
multiline_comment|/* Restore the correct value */
op_star
id|valp
op_assign
id|val
suffix:semicolon
)brace
r_else
(brace
id|local_bh_disable
c_func
(paren
)paren
suffix:semicolon
id|update_defense_level
c_func
(paren
)paren
suffix:semicolon
id|local_bh_enable
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
r_return
id|rc
suffix:semicolon
)brace
r_static
r_int
DECL|function|proc_do_sync_threshold
id|proc_do_sync_threshold
c_func
(paren
id|ctl_table
op_star
id|table
comma
r_int
id|write
comma
r_struct
id|file
op_star
id|filp
comma
r_void
id|__user
op_star
id|buffer
comma
r_int
op_star
id|lenp
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_int
op_star
id|valp
op_assign
id|table-&gt;data
suffix:semicolon
r_int
id|val
(braket
l_int|2
)braket
suffix:semicolon
r_int
id|rc
suffix:semicolon
multiline_comment|/* backup the value first */
id|memcpy
c_func
(paren
id|val
comma
id|valp
comma
r_sizeof
(paren
id|val
)paren
)paren
suffix:semicolon
id|rc
op_assign
id|proc_dointvec
c_func
(paren
id|table
comma
id|write
comma
id|filp
comma
id|buffer
comma
id|lenp
comma
id|ppos
)paren
suffix:semicolon
r_if
c_cond
(paren
id|write
op_logical_and
(paren
id|valp
(braket
l_int|0
)braket
OL
l_int|0
op_logical_or
id|valp
(braket
l_int|1
)braket
OL
l_int|0
op_logical_or
id|valp
(braket
l_int|0
)braket
op_ge
id|valp
(braket
l_int|1
)braket
)paren
)paren
(brace
multiline_comment|/* Restore the correct value */
id|memcpy
c_func
(paren
id|valp
comma
id|val
comma
r_sizeof
(paren
id|val
)paren
)paren
suffix:semicolon
)brace
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;IPVS sysctl table (under the /proc/sys/net/ipv4/vs/)&n; */
DECL|variable|vs_vars
r_static
r_struct
id|ctl_table
id|vs_vars
(braket
)braket
op_assign
(brace
(brace
dot
id|ctl_name
op_assign
id|NET_IPV4_VS_AMEMTHRESH
comma
dot
id|procname
op_assign
l_string|&quot;amemthresh&quot;
comma
dot
id|data
op_assign
op_amp
id|sysctl_ip_vs_amemthresh
comma
dot
id|maxlen
op_assign
r_sizeof
(paren
r_int
)paren
comma
dot
id|mode
op_assign
l_int|0644
comma
dot
id|proc_handler
op_assign
op_amp
id|proc_dointvec
comma
)brace
comma
macro_line|#ifdef CONFIG_IP_VS_DEBUG
(brace
dot
id|ctl_name
op_assign
id|NET_IPV4_VS_DEBUG_LEVEL
comma
dot
id|procname
op_assign
l_string|&quot;debug_level&quot;
comma
dot
id|data
op_assign
op_amp
id|sysctl_ip_vs_debug_level
comma
dot
id|maxlen
op_assign
r_sizeof
(paren
r_int
)paren
comma
dot
id|mode
op_assign
l_int|0644
comma
dot
id|proc_handler
op_assign
op_amp
id|proc_dointvec
comma
)brace
comma
macro_line|#endif
(brace
dot
id|ctl_name
op_assign
id|NET_IPV4_VS_AMDROPRATE
comma
dot
id|procname
op_assign
l_string|&quot;am_droprate&quot;
comma
dot
id|data
op_assign
op_amp
id|sysctl_ip_vs_am_droprate
comma
dot
id|maxlen
op_assign
r_sizeof
(paren
r_int
)paren
comma
dot
id|mode
op_assign
l_int|0644
comma
dot
id|proc_handler
op_assign
op_amp
id|proc_dointvec
comma
)brace
comma
(brace
dot
id|ctl_name
op_assign
id|NET_IPV4_VS_DROP_ENTRY
comma
dot
id|procname
op_assign
l_string|&quot;drop_entry&quot;
comma
dot
id|data
op_assign
op_amp
id|sysctl_ip_vs_drop_entry
comma
dot
id|maxlen
op_assign
r_sizeof
(paren
r_int
)paren
comma
dot
id|mode
op_assign
l_int|0644
comma
dot
id|proc_handler
op_assign
op_amp
id|proc_do_defense_mode
comma
)brace
comma
(brace
dot
id|ctl_name
op_assign
id|NET_IPV4_VS_DROP_PACKET
comma
dot
id|procname
op_assign
l_string|&quot;drop_packet&quot;
comma
dot
id|data
op_assign
op_amp
id|sysctl_ip_vs_drop_packet
comma
dot
id|maxlen
op_assign
r_sizeof
(paren
r_int
)paren
comma
dot
id|mode
op_assign
l_int|0644
comma
dot
id|proc_handler
op_assign
op_amp
id|proc_do_defense_mode
comma
)brace
comma
(brace
dot
id|ctl_name
op_assign
id|NET_IPV4_VS_SECURE_TCP
comma
dot
id|procname
op_assign
l_string|&quot;secure_tcp&quot;
comma
dot
id|data
op_assign
op_amp
id|sysctl_ip_vs_secure_tcp
comma
dot
id|maxlen
op_assign
r_sizeof
(paren
r_int
)paren
comma
dot
id|mode
op_assign
l_int|0644
comma
dot
id|proc_handler
op_assign
op_amp
id|proc_do_defense_mode
comma
)brace
comma
macro_line|#if 0
(brace
dot
id|ctl_name
op_assign
id|NET_IPV4_VS_TO_ES
comma
dot
id|procname
op_assign
l_string|&quot;timeout_established&quot;
comma
dot
id|data
op_assign
op_amp
id|vs_timeout_table_dos.timeout
(braket
id|IP_VS_S_ESTABLISHED
)braket
comma
dot
id|maxlen
op_assign
r_sizeof
(paren
r_int
)paren
comma
dot
id|mode
op_assign
l_int|0644
comma
dot
id|proc_handler
op_assign
op_amp
id|proc_dointvec_jiffies
comma
)brace
comma
(brace
dot
id|ctl_name
op_assign
id|NET_IPV4_VS_TO_SS
comma
dot
id|procname
op_assign
l_string|&quot;timeout_synsent&quot;
comma
dot
id|data
op_assign
op_amp
id|vs_timeout_table_dos.timeout
(braket
id|IP_VS_S_SYN_SENT
)braket
comma
dot
id|maxlen
op_assign
r_sizeof
(paren
r_int
)paren
comma
dot
id|mode
op_assign
l_int|0644
comma
dot
id|proc_handler
op_assign
op_amp
id|proc_dointvec_jiffies
comma
)brace
comma
(brace
dot
id|ctl_name
op_assign
id|NET_IPV4_VS_TO_SR
comma
dot
id|procname
op_assign
l_string|&quot;timeout_synrecv&quot;
comma
dot
id|data
op_assign
op_amp
id|vs_timeout_table_dos.timeout
(braket
id|IP_VS_S_SYN_RECV
)braket
comma
dot
id|maxlen
op_assign
r_sizeof
(paren
r_int
)paren
comma
dot
id|mode
op_assign
l_int|0644
comma
dot
id|proc_handler
op_assign
op_amp
id|proc_dointvec_jiffies
comma
)brace
comma
(brace
dot
id|ctl_name
op_assign
id|NET_IPV4_VS_TO_FW
comma
dot
id|procname
op_assign
l_string|&quot;timeout_finwait&quot;
comma
dot
id|data
op_assign
op_amp
id|vs_timeout_table_dos.timeout
(braket
id|IP_VS_S_FIN_WAIT
)braket
comma
dot
id|maxlen
op_assign
r_sizeof
(paren
r_int
)paren
comma
dot
id|mode
op_assign
l_int|0644
comma
dot
id|proc_handler
op_assign
op_amp
id|proc_dointvec_jiffies
comma
)brace
comma
(brace
dot
id|ctl_name
op_assign
id|NET_IPV4_VS_TO_TW
comma
dot
id|procname
op_assign
l_string|&quot;timeout_timewait&quot;
comma
dot
id|data
op_assign
op_amp
id|vs_timeout_table_dos.timeout
(braket
id|IP_VS_S_TIME_WAIT
)braket
comma
dot
id|maxlen
op_assign
r_sizeof
(paren
r_int
)paren
comma
dot
id|mode
op_assign
l_int|0644
comma
dot
id|proc_handler
op_assign
op_amp
id|proc_dointvec_jiffies
comma
)brace
comma
(brace
dot
id|ctl_name
op_assign
id|NET_IPV4_VS_TO_CL
comma
dot
id|procname
op_assign
l_string|&quot;timeout_close&quot;
comma
dot
id|data
op_assign
op_amp
id|vs_timeout_table_dos.timeout
(braket
id|IP_VS_S_CLOSE
)braket
comma
dot
id|maxlen
op_assign
r_sizeof
(paren
r_int
)paren
comma
dot
id|mode
op_assign
l_int|0644
comma
dot
id|proc_handler
op_assign
op_amp
id|proc_dointvec_jiffies
comma
)brace
comma
(brace
dot
id|ctl_name
op_assign
id|NET_IPV4_VS_TO_CW
comma
dot
id|procname
op_assign
l_string|&quot;timeout_closewait&quot;
comma
dot
id|data
op_assign
op_amp
id|vs_timeout_table_dos.timeout
(braket
id|IP_VS_S_CLOSE_WAIT
)braket
comma
dot
id|maxlen
op_assign
r_sizeof
(paren
r_int
)paren
comma
dot
id|mode
op_assign
l_int|0644
comma
dot
id|proc_handler
op_assign
op_amp
id|proc_dointvec_jiffies
comma
)brace
comma
(brace
dot
id|ctl_name
op_assign
id|NET_IPV4_VS_TO_LA
comma
dot
id|procname
op_assign
l_string|&quot;timeout_lastack&quot;
comma
dot
id|data
op_assign
op_amp
id|vs_timeout_table_dos.timeout
(braket
id|IP_VS_S_LAST_ACK
)braket
comma
dot
id|maxlen
op_assign
r_sizeof
(paren
r_int
)paren
comma
dot
id|mode
op_assign
l_int|0644
comma
dot
id|proc_handler
op_assign
op_amp
id|proc_dointvec_jiffies
comma
)brace
comma
(brace
dot
id|ctl_name
op_assign
id|NET_IPV4_VS_TO_LI
comma
dot
id|procname
op_assign
l_string|&quot;timeout_listen&quot;
comma
dot
id|data
op_assign
op_amp
id|vs_timeout_table_dos.timeout
(braket
id|IP_VS_S_LISTEN
)braket
comma
dot
id|maxlen
op_assign
r_sizeof
(paren
r_int
)paren
comma
dot
id|mode
op_assign
l_int|0644
comma
dot
id|proc_handler
op_assign
op_amp
id|proc_dointvec_jiffies
comma
)brace
comma
(brace
dot
id|ctl_name
op_assign
id|NET_IPV4_VS_TO_SA
comma
dot
id|procname
op_assign
l_string|&quot;timeout_synack&quot;
comma
dot
id|data
op_assign
op_amp
id|vs_timeout_table_dos.timeout
(braket
id|IP_VS_S_SYNACK
)braket
comma
dot
id|maxlen
op_assign
r_sizeof
(paren
r_int
)paren
comma
dot
id|mode
op_assign
l_int|0644
comma
dot
id|proc_handler
op_assign
op_amp
id|proc_dointvec_jiffies
comma
)brace
comma
(brace
dot
id|ctl_name
op_assign
id|NET_IPV4_VS_TO_UDP
comma
dot
id|procname
op_assign
l_string|&quot;timeout_udp&quot;
comma
dot
id|data
op_assign
op_amp
id|vs_timeout_table_dos.timeout
(braket
id|IP_VS_S_UDP
)braket
comma
dot
id|maxlen
op_assign
r_sizeof
(paren
r_int
)paren
comma
dot
id|mode
op_assign
l_int|0644
comma
dot
id|proc_handler
op_assign
op_amp
id|proc_dointvec_jiffies
comma
)brace
comma
(brace
dot
id|ctl_name
op_assign
id|NET_IPV4_VS_TO_ICMP
comma
dot
id|procname
op_assign
l_string|&quot;timeout_icmp&quot;
comma
dot
id|data
op_assign
op_amp
id|vs_timeout_table_dos.timeout
(braket
id|IP_VS_S_ICMP
)braket
comma
dot
id|maxlen
op_assign
r_sizeof
(paren
r_int
)paren
comma
dot
id|mode
op_assign
l_int|0644
comma
dot
id|proc_handler
op_assign
op_amp
id|proc_dointvec_jiffies
comma
)brace
comma
macro_line|#endif
(brace
dot
id|ctl_name
op_assign
id|NET_IPV4_VS_CACHE_BYPASS
comma
dot
id|procname
op_assign
l_string|&quot;cache_bypass&quot;
comma
dot
id|data
op_assign
op_amp
id|sysctl_ip_vs_cache_bypass
comma
dot
id|maxlen
op_assign
r_sizeof
(paren
r_int
)paren
comma
dot
id|mode
op_assign
l_int|0644
comma
dot
id|proc_handler
op_assign
op_amp
id|proc_dointvec
comma
)brace
comma
(brace
dot
id|ctl_name
op_assign
id|NET_IPV4_VS_EXPIRE_NODEST_CONN
comma
dot
id|procname
op_assign
l_string|&quot;expire_nodest_conn&quot;
comma
dot
id|data
op_assign
op_amp
id|sysctl_ip_vs_expire_nodest_conn
comma
dot
id|maxlen
op_assign
r_sizeof
(paren
r_int
)paren
comma
dot
id|mode
op_assign
l_int|0644
comma
dot
id|proc_handler
op_assign
op_amp
id|proc_dointvec
comma
)brace
comma
(brace
dot
id|ctl_name
op_assign
id|NET_IPV4_VS_SYNC_THRESHOLD
comma
dot
id|procname
op_assign
l_string|&quot;sync_threshold&quot;
comma
dot
id|data
op_assign
op_amp
id|sysctl_ip_vs_sync_threshold
comma
dot
id|maxlen
op_assign
r_sizeof
(paren
id|sysctl_ip_vs_sync_threshold
)paren
comma
dot
id|mode
op_assign
l_int|0644
comma
dot
id|proc_handler
op_assign
op_amp
id|proc_do_sync_threshold
comma
)brace
comma
(brace
dot
id|ctl_name
op_assign
id|NET_IPV4_VS_NAT_ICMP_SEND
comma
dot
id|procname
op_assign
l_string|&quot;nat_icmp_send&quot;
comma
dot
id|data
op_assign
op_amp
id|sysctl_ip_vs_nat_icmp_send
comma
dot
id|maxlen
op_assign
r_sizeof
(paren
r_int
)paren
comma
dot
id|mode
op_assign
l_int|0644
comma
dot
id|proc_handler
op_assign
op_amp
id|proc_dointvec
comma
)brace
comma
(brace
dot
id|ctl_name
op_assign
l_int|0
)brace
)brace
suffix:semicolon
DECL|variable|vs_table
r_static
id|ctl_table
id|vs_table
(braket
)braket
op_assign
(brace
(brace
dot
id|ctl_name
op_assign
id|NET_IPV4_VS
comma
dot
id|procname
op_assign
l_string|&quot;vs&quot;
comma
dot
id|mode
op_assign
l_int|0555
comma
dot
id|child
op_assign
id|vs_vars
)brace
comma
(brace
dot
id|ctl_name
op_assign
l_int|0
)brace
)brace
suffix:semicolon
DECL|variable|ipv4_table
r_static
id|ctl_table
id|ipv4_table
(braket
)braket
op_assign
(brace
(brace
dot
id|ctl_name
op_assign
id|NET_IPV4
comma
dot
id|procname
op_assign
l_string|&quot;ipv4&quot;
comma
dot
id|mode
op_assign
l_int|0555
comma
dot
id|child
op_assign
id|vs_table
comma
)brace
comma
(brace
dot
id|ctl_name
op_assign
l_int|0
)brace
)brace
suffix:semicolon
DECL|variable|vs_root_table
r_static
id|ctl_table
id|vs_root_table
(braket
)braket
op_assign
(brace
(brace
dot
id|ctl_name
op_assign
id|CTL_NET
comma
dot
id|procname
op_assign
l_string|&quot;net&quot;
comma
dot
id|mode
op_assign
l_int|0555
comma
dot
id|child
op_assign
id|ipv4_table
comma
)brace
comma
(brace
dot
id|ctl_name
op_assign
l_int|0
)brace
)brace
suffix:semicolon
DECL|variable|sysctl_header
r_static
r_struct
id|ctl_table_header
op_star
id|sysctl_header
suffix:semicolon
macro_line|#ifdef CONFIG_PROC_FS
DECL|struct|ip_vs_iter
r_struct
id|ip_vs_iter
(brace
DECL|member|table
r_struct
id|list_head
op_star
id|table
suffix:semicolon
DECL|member|bucket
r_int
id|bucket
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/*&n; *&t;Write the contents of the VS rule table to a PROCfs file.&n; *&t;(It is kept just for backward compatibility)&n; */
DECL|function|ip_vs_fwd_name
r_static
r_inline
r_const
r_char
op_star
id|ip_vs_fwd_name
c_func
(paren
r_int
id|flags
)paren
(brace
r_switch
c_cond
(paren
id|flags
op_amp
id|IP_VS_CONN_F_FWD_MASK
)paren
(brace
r_case
id|IP_VS_CONN_F_LOCALNODE
suffix:colon
r_return
l_string|&quot;Local&quot;
suffix:semicolon
r_case
id|IP_VS_CONN_F_TUNNEL
suffix:colon
r_return
l_string|&quot;Tunnel&quot;
suffix:semicolon
r_case
id|IP_VS_CONN_F_DROUTE
suffix:colon
r_return
l_string|&quot;Route&quot;
suffix:semicolon
r_default
suffix:colon
r_return
l_string|&quot;Masq&quot;
suffix:semicolon
)brace
)brace
multiline_comment|/* Get the Nth entry in the two lists */
DECL|function|ip_vs_info_array
r_static
r_struct
id|ip_vs_service
op_star
id|ip_vs_info_array
c_func
(paren
r_struct
id|seq_file
op_star
id|seq
comma
id|loff_t
id|pos
)paren
(brace
r_struct
id|ip_vs_iter
op_star
id|iter
op_assign
id|seq
op_member_access_from_pointer
r_private
suffix:semicolon
r_int
id|idx
suffix:semicolon
r_struct
id|ip_vs_service
op_star
id|svc
suffix:semicolon
multiline_comment|/* look in hash by protocol */
r_for
c_loop
(paren
id|idx
op_assign
l_int|0
suffix:semicolon
id|idx
OL
id|IP_VS_SVC_TAB_SIZE
suffix:semicolon
id|idx
op_increment
)paren
(brace
id|list_for_each_entry
c_func
(paren
id|svc
comma
op_amp
id|ip_vs_svc_table
(braket
id|idx
)braket
comma
id|s_list
)paren
(brace
r_if
c_cond
(paren
id|pos
op_decrement
op_eq
l_int|0
)paren
(brace
id|iter-&gt;table
op_assign
id|ip_vs_svc_table
suffix:semicolon
id|iter-&gt;bucket
op_assign
id|idx
suffix:semicolon
r_return
id|svc
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* keep looking in fwmark */
r_for
c_loop
(paren
id|idx
op_assign
l_int|0
suffix:semicolon
id|idx
OL
id|IP_VS_SVC_TAB_SIZE
suffix:semicolon
id|idx
op_increment
)paren
(brace
id|list_for_each_entry
c_func
(paren
id|svc
comma
op_amp
id|ip_vs_svc_fwm_table
(braket
id|idx
)braket
comma
id|f_list
)paren
(brace
r_if
c_cond
(paren
id|pos
op_decrement
op_eq
l_int|0
)paren
(brace
id|iter-&gt;table
op_assign
id|ip_vs_svc_fwm_table
suffix:semicolon
id|iter-&gt;bucket
op_assign
id|idx
suffix:semicolon
r_return
id|svc
suffix:semicolon
)brace
)brace
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|ip_vs_info_seq_start
r_static
r_void
op_star
id|ip_vs_info_seq_start
c_func
(paren
r_struct
id|seq_file
op_star
id|seq
comma
id|loff_t
op_star
id|pos
)paren
(brace
id|read_lock_bh
c_func
(paren
op_amp
id|__ip_vs_svc_lock
)paren
suffix:semicolon
r_return
op_star
id|pos
ques
c_cond
id|ip_vs_info_array
c_func
(paren
id|seq
comma
op_star
id|pos
op_minus
l_int|1
)paren
suffix:colon
id|SEQ_START_TOKEN
suffix:semicolon
)brace
DECL|function|ip_vs_info_seq_next
r_static
r_void
op_star
id|ip_vs_info_seq_next
c_func
(paren
r_struct
id|seq_file
op_star
id|seq
comma
r_void
op_star
id|v
comma
id|loff_t
op_star
id|pos
)paren
(brace
r_struct
id|list_head
op_star
id|e
suffix:semicolon
r_struct
id|ip_vs_iter
op_star
id|iter
suffix:semicolon
r_struct
id|ip_vs_service
op_star
id|svc
suffix:semicolon
op_increment
op_star
id|pos
suffix:semicolon
r_if
c_cond
(paren
id|v
op_eq
id|SEQ_START_TOKEN
)paren
r_return
id|ip_vs_info_array
c_func
(paren
id|seq
comma
l_int|0
)paren
suffix:semicolon
id|svc
op_assign
id|v
suffix:semicolon
id|iter
op_assign
id|seq
op_member_access_from_pointer
r_private
suffix:semicolon
r_if
c_cond
(paren
id|iter-&gt;table
op_eq
id|ip_vs_svc_table
)paren
(brace
multiline_comment|/* next service in table hashed by protocol */
r_if
c_cond
(paren
(paren
id|e
op_assign
id|svc-&gt;s_list.next
)paren
op_ne
op_amp
id|ip_vs_svc_table
(braket
id|iter-&gt;bucket
)braket
)paren
r_return
id|list_entry
c_func
(paren
id|e
comma
r_struct
id|ip_vs_service
comma
id|s_list
)paren
suffix:semicolon
r_while
c_loop
(paren
op_increment
id|iter-&gt;bucket
OL
id|IP_VS_SVC_TAB_SIZE
)paren
(brace
id|list_for_each_entry
c_func
(paren
id|svc
comma
op_amp
id|ip_vs_svc_table
(braket
id|iter-&gt;bucket
)braket
comma
id|s_list
)paren
(brace
r_return
id|svc
suffix:semicolon
)brace
)brace
id|iter-&gt;table
op_assign
id|ip_vs_svc_fwm_table
suffix:semicolon
id|iter-&gt;bucket
op_assign
op_minus
l_int|1
suffix:semicolon
r_goto
id|scan_fwmark
suffix:semicolon
)brace
multiline_comment|/* next service in hashed by fwmark */
r_if
c_cond
(paren
(paren
id|e
op_assign
id|svc-&gt;f_list.next
)paren
op_ne
op_amp
id|ip_vs_svc_fwm_table
(braket
id|iter-&gt;bucket
)braket
)paren
r_return
id|list_entry
c_func
(paren
id|e
comma
r_struct
id|ip_vs_service
comma
id|f_list
)paren
suffix:semicolon
id|scan_fwmark
suffix:colon
r_while
c_loop
(paren
op_increment
id|iter-&gt;bucket
OL
id|IP_VS_SVC_TAB_SIZE
)paren
(brace
id|list_for_each_entry
c_func
(paren
id|svc
comma
op_amp
id|ip_vs_svc_fwm_table
(braket
id|iter-&gt;bucket
)braket
comma
id|f_list
)paren
r_return
id|svc
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|ip_vs_info_seq_stop
r_static
r_void
id|ip_vs_info_seq_stop
c_func
(paren
r_struct
id|seq_file
op_star
id|seq
comma
r_void
op_star
id|v
)paren
(brace
id|read_unlock_bh
c_func
(paren
op_amp
id|__ip_vs_svc_lock
)paren
suffix:semicolon
)brace
DECL|function|ip_vs_info_seq_show
r_static
r_int
id|ip_vs_info_seq_show
c_func
(paren
r_struct
id|seq_file
op_star
id|seq
comma
r_void
op_star
id|v
)paren
(brace
r_if
c_cond
(paren
id|v
op_eq
id|SEQ_START_TOKEN
)paren
(brace
id|seq_printf
c_func
(paren
id|seq
comma
l_string|&quot;IP Virtual Server version %d.%d.%d (size=%d)&bslash;n&quot;
comma
id|NVERSION
c_func
(paren
id|IP_VS_VERSION_CODE
)paren
comma
id|IP_VS_CONN_TAB_SIZE
)paren
suffix:semicolon
id|seq_puts
c_func
(paren
id|seq
comma
l_string|&quot;Prot LocalAddress:Port Scheduler Flags&bslash;n&quot;
)paren
suffix:semicolon
id|seq_puts
c_func
(paren
id|seq
comma
l_string|&quot;  -&gt; RemoteAddress:Port Forward Weight ActiveConn InActConn&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
r_const
r_struct
id|ip_vs_service
op_star
id|svc
op_assign
id|v
suffix:semicolon
r_const
r_struct
id|ip_vs_iter
op_star
id|iter
op_assign
id|seq
op_member_access_from_pointer
r_private
suffix:semicolon
r_const
r_struct
id|ip_vs_dest
op_star
id|dest
suffix:semicolon
r_if
c_cond
(paren
id|iter-&gt;table
op_eq
id|ip_vs_svc_table
)paren
id|seq_printf
c_func
(paren
id|seq
comma
l_string|&quot;%s  %08X:%04X %s &quot;
comma
id|ip_vs_proto_name
c_func
(paren
id|svc-&gt;protocol
)paren
comma
id|ntohl
c_func
(paren
id|svc-&gt;addr
)paren
comma
id|ntohs
c_func
(paren
id|svc-&gt;port
)paren
comma
id|svc-&gt;scheduler-&gt;name
)paren
suffix:semicolon
r_else
id|seq_printf
c_func
(paren
id|seq
comma
l_string|&quot;FWM  %08X %s &quot;
comma
id|svc-&gt;fwmark
comma
id|svc-&gt;scheduler-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|svc-&gt;flags
op_amp
id|IP_VS_SVC_F_PERSISTENT
)paren
id|seq_printf
c_func
(paren
id|seq
comma
l_string|&quot;persistent %d %08X&bslash;n&quot;
comma
id|svc-&gt;timeout
comma
id|ntohl
c_func
(paren
id|svc-&gt;netmask
)paren
)paren
suffix:semicolon
r_else
id|seq_putc
c_func
(paren
id|seq
comma
l_char|&squot;&bslash;n&squot;
)paren
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|dest
comma
op_amp
id|svc-&gt;destinations
comma
id|n_list
)paren
(brace
id|seq_printf
c_func
(paren
id|seq
comma
l_string|&quot;  -&gt; %08X:%04X      %-7s %-6d %-10d %-10d&bslash;n&quot;
comma
id|ntohl
c_func
(paren
id|dest-&gt;addr
)paren
comma
id|ntohs
c_func
(paren
id|dest-&gt;port
)paren
comma
id|ip_vs_fwd_name
c_func
(paren
id|atomic_read
c_func
(paren
op_amp
id|dest-&gt;conn_flags
)paren
)paren
comma
id|atomic_read
c_func
(paren
op_amp
id|dest-&gt;weight
)paren
comma
id|atomic_read
c_func
(paren
op_amp
id|dest-&gt;activeconns
)paren
comma
id|atomic_read
c_func
(paren
op_amp
id|dest-&gt;inactconns
)paren
)paren
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|ip_vs_info_seq_ops
r_static
r_struct
id|seq_operations
id|ip_vs_info_seq_ops
op_assign
(brace
dot
id|start
op_assign
id|ip_vs_info_seq_start
comma
dot
id|next
op_assign
id|ip_vs_info_seq_next
comma
dot
id|stop
op_assign
id|ip_vs_info_seq_stop
comma
dot
id|show
op_assign
id|ip_vs_info_seq_show
comma
)brace
suffix:semicolon
DECL|function|ip_vs_info_open
r_static
r_int
id|ip_vs_info_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|seq_file
op_star
id|seq
suffix:semicolon
r_int
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_struct
id|ip_vs_iter
op_star
id|s
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|s
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|s
)paren
r_goto
id|out
suffix:semicolon
id|rc
op_assign
id|seq_open
c_func
(paren
id|file
comma
op_amp
id|ip_vs_info_seq_ops
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_goto
id|out_kfree
suffix:semicolon
id|seq
op_assign
id|file-&gt;private_data
suffix:semicolon
id|seq
op_member_access_from_pointer
r_private
op_assign
id|s
suffix:semicolon
id|memset
c_func
(paren
id|s
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|s
)paren
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|rc
suffix:semicolon
id|out_kfree
suffix:colon
id|kfree
c_func
(paren
id|s
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
DECL|variable|ip_vs_info_fops
r_static
r_struct
id|file_operations
id|ip_vs_info_fops
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|open
op_assign
id|ip_vs_info_open
comma
dot
id|read
op_assign
id|seq_read
comma
dot
id|llseek
op_assign
id|seq_lseek
comma
dot
id|release
op_assign
id|seq_release_private
comma
)brace
suffix:semicolon
macro_line|#endif
DECL|variable|ip_vs_stats
r_struct
id|ip_vs_stats
id|ip_vs_stats
suffix:semicolon
macro_line|#ifdef CONFIG_PROC_FS
DECL|function|ip_vs_stats_show
r_static
r_int
id|ip_vs_stats_show
c_func
(paren
r_struct
id|seq_file
op_star
id|seq
comma
r_void
op_star
id|v
)paren
(brace
multiline_comment|/*               01234567 01234567 01234567 0123456701234567 0123456701234567 */
id|seq_puts
c_func
(paren
id|seq
comma
l_string|&quot;   Total Incoming Outgoing         Incoming         Outgoing&bslash;n&quot;
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|seq
comma
l_string|&quot;   Conns  Packets  Packets            Bytes            Bytes&bslash;n&quot;
)paren
suffix:semicolon
id|spin_lock_bh
c_func
(paren
op_amp
id|ip_vs_stats.lock
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|seq
comma
l_string|&quot;%8X %8X %8X %16LX %16LX&bslash;n&bslash;n&quot;
comma
id|ip_vs_stats.conns
comma
id|ip_vs_stats.inpkts
comma
id|ip_vs_stats.outpkts
comma
(paren
r_int
r_int
r_int
)paren
id|ip_vs_stats.inbytes
comma
(paren
r_int
r_int
r_int
)paren
id|ip_vs_stats.outbytes
)paren
suffix:semicolon
multiline_comment|/*                 01234567 01234567 01234567 0123456701234567 0123456701234567 */
id|seq_puts
c_func
(paren
id|seq
comma
l_string|&quot; Conns/s   Pkts/s   Pkts/s          Bytes/s          Bytes/s&bslash;n&quot;
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|seq
comma
l_string|&quot;%8X %8X %8X %16X %16X&bslash;n&quot;
comma
id|ip_vs_stats.cps
comma
id|ip_vs_stats.inpps
comma
id|ip_vs_stats.outpps
comma
id|ip_vs_stats.inbps
comma
id|ip_vs_stats.outbps
)paren
suffix:semicolon
id|spin_unlock_bh
c_func
(paren
op_amp
id|ip_vs_stats.lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ip_vs_stats_seq_open
r_static
r_int
id|ip_vs_stats_seq_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_return
id|single_open
c_func
(paren
id|file
comma
id|ip_vs_stats_show
comma
l_int|NULL
)paren
suffix:semicolon
)brace
DECL|variable|ip_vs_stats_fops
r_static
r_struct
id|file_operations
id|ip_vs_stats_fops
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|open
op_assign
id|ip_vs_stats_seq_open
comma
dot
id|read
op_assign
id|seq_read
comma
dot
id|llseek
op_assign
id|seq_lseek
comma
dot
id|release
op_assign
id|single_release
comma
)brace
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n; *&t;Set timeout values for tcp tcpfin udp in the timeout_table.&n; */
DECL|function|ip_vs_set_timeout
r_static
r_int
id|ip_vs_set_timeout
c_func
(paren
r_struct
id|ip_vs_timeout_user
op_star
id|u
)paren
(brace
id|IP_VS_DBG
c_func
(paren
l_int|2
comma
l_string|&quot;Setting timeout tcp:%d tcpfin:%d udp:%d&bslash;n&quot;
comma
id|u-&gt;tcp_timeout
comma
id|u-&gt;tcp_fin_timeout
comma
id|u-&gt;udp_timeout
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_IP_VS_PROTO_TCP
r_if
c_cond
(paren
id|u-&gt;tcp_timeout
)paren
(brace
id|ip_vs_protocol_tcp.timeout_table
(braket
id|IP_VS_TCP_S_ESTABLISHED
)braket
op_assign
id|u-&gt;tcp_timeout
op_star
id|HZ
suffix:semicolon
)brace
r_if
c_cond
(paren
id|u-&gt;tcp_fin_timeout
)paren
(brace
id|ip_vs_protocol_tcp.timeout_table
(braket
id|IP_VS_TCP_S_FIN_WAIT
)braket
op_assign
id|u-&gt;tcp_fin_timeout
op_star
id|HZ
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifdef CONFIG_IP_VS_PROTO_UDP
r_if
c_cond
(paren
id|u-&gt;udp_timeout
)paren
(brace
id|ip_vs_protocol_udp.timeout_table
(braket
id|IP_VS_UDP_S_NORMAL
)braket
op_assign
id|u-&gt;udp_timeout
op_star
id|HZ
suffix:semicolon
)brace
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
DECL|macro|SET_CMDID
mdefine_line|#define SET_CMDID(cmd)&t;&t;(cmd - IP_VS_BASE_CTL)
DECL|macro|SERVICE_ARG_LEN
mdefine_line|#define SERVICE_ARG_LEN&t;&t;(sizeof(struct ip_vs_service_user))
DECL|macro|SVCDEST_ARG_LEN
mdefine_line|#define SVCDEST_ARG_LEN&t;&t;(sizeof(struct ip_vs_service_user) +&t;&bslash;&n;&t;&t;&t;&t; sizeof(struct ip_vs_dest_user))
DECL|macro|TIMEOUT_ARG_LEN
mdefine_line|#define TIMEOUT_ARG_LEN&t;&t;(sizeof(struct ip_vs_timeout_user))
DECL|macro|DAEMON_ARG_LEN
mdefine_line|#define DAEMON_ARG_LEN&t;&t;(sizeof(struct ip_vs_daemon_user))
DECL|macro|MAX_ARG_LEN
mdefine_line|#define MAX_ARG_LEN&t;&t;SVCDEST_ARG_LEN
DECL|variable|set_arglen
r_static
r_int
r_char
id|set_arglen
(braket
id|SET_CMDID
c_func
(paren
id|IP_VS_SO_SET_MAX
)paren
op_plus
l_int|1
)braket
op_assign
(brace
(braket
id|SET_CMDID
c_func
(paren
id|IP_VS_SO_SET_ADD
)paren
)braket
op_assign
id|SERVICE_ARG_LEN
comma
(braket
id|SET_CMDID
c_func
(paren
id|IP_VS_SO_SET_EDIT
)paren
)braket
op_assign
id|SERVICE_ARG_LEN
comma
(braket
id|SET_CMDID
c_func
(paren
id|IP_VS_SO_SET_DEL
)paren
)braket
op_assign
id|SERVICE_ARG_LEN
comma
(braket
id|SET_CMDID
c_func
(paren
id|IP_VS_SO_SET_FLUSH
)paren
)braket
op_assign
l_int|0
comma
(braket
id|SET_CMDID
c_func
(paren
id|IP_VS_SO_SET_ADDDEST
)paren
)braket
op_assign
id|SVCDEST_ARG_LEN
comma
(braket
id|SET_CMDID
c_func
(paren
id|IP_VS_SO_SET_DELDEST
)paren
)braket
op_assign
id|SVCDEST_ARG_LEN
comma
(braket
id|SET_CMDID
c_func
(paren
id|IP_VS_SO_SET_EDITDEST
)paren
)braket
op_assign
id|SVCDEST_ARG_LEN
comma
(braket
id|SET_CMDID
c_func
(paren
id|IP_VS_SO_SET_TIMEOUT
)paren
)braket
op_assign
id|TIMEOUT_ARG_LEN
comma
(braket
id|SET_CMDID
c_func
(paren
id|IP_VS_SO_SET_STARTDAEMON
)paren
)braket
op_assign
id|DAEMON_ARG_LEN
comma
(braket
id|SET_CMDID
c_func
(paren
id|IP_VS_SO_SET_STOPDAEMON
)paren
)braket
op_assign
id|DAEMON_ARG_LEN
comma
(braket
id|SET_CMDID
c_func
(paren
id|IP_VS_SO_SET_ZERO
)paren
)braket
op_assign
id|SERVICE_ARG_LEN
comma
)brace
suffix:semicolon
r_static
r_int
DECL|function|do_ip_vs_set_ctl
id|do_ip_vs_set_ctl
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_int
id|cmd
comma
r_void
id|__user
op_star
id|user
comma
r_int
r_int
id|len
)paren
(brace
r_int
id|ret
suffix:semicolon
r_int
r_char
id|arg
(braket
id|MAX_ARG_LEN
)braket
suffix:semicolon
r_struct
id|ip_vs_service_user
op_star
id|usvc
suffix:semicolon
r_struct
id|ip_vs_service
op_star
id|svc
suffix:semicolon
r_struct
id|ip_vs_dest_user
op_star
id|udest
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
r_if
c_cond
(paren
id|len
op_ne
id|set_arglen
(braket
id|SET_CMDID
c_func
(paren
id|cmd
)paren
)braket
)paren
(brace
id|IP_VS_ERR
c_func
(paren
l_string|&quot;set_ctl: len %u != %u&bslash;n&quot;
comma
id|len
comma
id|set_arglen
(braket
id|SET_CMDID
c_func
(paren
id|cmd
)paren
)braket
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|arg
comma
id|user
comma
id|len
)paren
op_ne
l_int|0
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
multiline_comment|/* increase the module use count */
id|ip_vs_use_count_inc
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|down_interruptible
c_func
(paren
op_amp
id|__ip_vs_mutex
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|ERESTARTSYS
suffix:semicolon
r_goto
id|out_dec
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cmd
op_eq
id|IP_VS_SO_SET_FLUSH
)paren
(brace
multiline_comment|/* Flush the virtual service */
id|ret
op_assign
id|ip_vs_flush
c_func
(paren
)paren
suffix:semicolon
r_goto
id|out_unlock
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|cmd
op_eq
id|IP_VS_SO_SET_TIMEOUT
)paren
(brace
multiline_comment|/* Set timeout values for (tcp tcpfin udp) */
id|ret
op_assign
id|ip_vs_set_timeout
c_func
(paren
(paren
r_struct
id|ip_vs_timeout_user
op_star
)paren
id|arg
)paren
suffix:semicolon
r_goto
id|out_unlock
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|cmd
op_eq
id|IP_VS_SO_SET_STARTDAEMON
)paren
(brace
r_struct
id|ip_vs_daemon_user
op_star
id|dm
op_assign
(paren
r_struct
id|ip_vs_daemon_user
op_star
)paren
id|arg
suffix:semicolon
id|ret
op_assign
id|start_sync_thread
c_func
(paren
id|dm-&gt;state
comma
id|dm-&gt;mcast_ifn
comma
id|dm-&gt;syncid
)paren
suffix:semicolon
r_goto
id|out_unlock
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|cmd
op_eq
id|IP_VS_SO_SET_STOPDAEMON
)paren
(brace
r_struct
id|ip_vs_daemon_user
op_star
id|dm
op_assign
(paren
r_struct
id|ip_vs_daemon_user
op_star
)paren
id|arg
suffix:semicolon
id|ret
op_assign
id|stop_sync_thread
c_func
(paren
id|dm-&gt;state
)paren
suffix:semicolon
r_goto
id|out_unlock
suffix:semicolon
)brace
id|usvc
op_assign
(paren
r_struct
id|ip_vs_service_user
op_star
)paren
id|arg
suffix:semicolon
id|udest
op_assign
(paren
r_struct
id|ip_vs_dest_user
op_star
)paren
(paren
id|usvc
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_eq
id|IP_VS_SO_SET_ZERO
)paren
(brace
multiline_comment|/* if no service address is set, zero counters in all */
r_if
c_cond
(paren
op_logical_neg
id|usvc-&gt;fwmark
op_logical_and
op_logical_neg
id|usvc-&gt;addr
op_logical_and
op_logical_neg
id|usvc-&gt;port
)paren
(brace
id|ret
op_assign
id|ip_vs_zero_all
c_func
(paren
)paren
suffix:semicolon
r_goto
id|out_unlock
suffix:semicolon
)brace
)brace
multiline_comment|/* Check for valid protocol: TCP or UDP, even for fwmark!=0 */
r_if
c_cond
(paren
id|usvc-&gt;protocol
op_ne
id|IPPROTO_TCP
op_logical_and
id|usvc-&gt;protocol
op_ne
id|IPPROTO_UDP
)paren
(brace
id|IP_VS_ERR
c_func
(paren
l_string|&quot;set_ctl: invalid protocol: %d %d.%d.%d.%d:%d %s&bslash;n&quot;
comma
id|usvc-&gt;protocol
comma
id|NIPQUAD
c_func
(paren
id|usvc-&gt;addr
)paren
comma
id|ntohs
c_func
(paren
id|usvc-&gt;port
)paren
comma
id|usvc-&gt;sched_name
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
id|out_unlock
suffix:semicolon
)brace
multiline_comment|/* Lookup the exact service by &lt;protocol, addr, port&gt; or fwmark */
r_if
c_cond
(paren
id|usvc-&gt;fwmark
op_eq
l_int|0
)paren
id|svc
op_assign
id|__ip_vs_service_get
c_func
(paren
id|usvc-&gt;protocol
comma
id|usvc-&gt;addr
comma
id|usvc-&gt;port
)paren
suffix:semicolon
r_else
id|svc
op_assign
id|__ip_vs_svc_fwm_get
c_func
(paren
id|usvc-&gt;fwmark
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_ne
id|IP_VS_SO_SET_ADD
op_logical_and
(paren
id|svc
op_eq
l_int|NULL
op_logical_or
id|svc-&gt;protocol
op_ne
id|usvc-&gt;protocol
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|ESRCH
suffix:semicolon
r_goto
id|out_unlock
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|IP_VS_SO_SET_ADD
suffix:colon
r_if
c_cond
(paren
id|svc
op_ne
l_int|NULL
)paren
id|ret
op_assign
op_minus
id|EEXIST
suffix:semicolon
r_else
id|ret
op_assign
id|ip_vs_add_service
c_func
(paren
id|usvc
comma
op_amp
id|svc
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IP_VS_SO_SET_EDIT
suffix:colon
id|ret
op_assign
id|ip_vs_edit_service
c_func
(paren
id|svc
comma
id|usvc
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IP_VS_SO_SET_DEL
suffix:colon
id|ret
op_assign
id|ip_vs_del_service
c_func
(paren
id|svc
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
r_goto
id|out_unlock
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IP_VS_SO_SET_ZERO
suffix:colon
id|ret
op_assign
id|ip_vs_zero_service
c_func
(paren
id|svc
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IP_VS_SO_SET_ADDDEST
suffix:colon
id|ret
op_assign
id|ip_vs_add_dest
c_func
(paren
id|svc
comma
id|udest
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IP_VS_SO_SET_EDITDEST
suffix:colon
id|ret
op_assign
id|ip_vs_edit_dest
c_func
(paren
id|svc
comma
id|udest
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IP_VS_SO_SET_DELDEST
suffix:colon
id|ret
op_assign
id|ip_vs_del_dest
c_func
(paren
id|svc
comma
id|udest
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|svc
)paren
id|ip_vs_service_put
c_func
(paren
id|svc
)paren
suffix:semicolon
id|out_unlock
suffix:colon
id|up
c_func
(paren
op_amp
id|__ip_vs_mutex
)paren
suffix:semicolon
id|out_dec
suffix:colon
multiline_comment|/* decrease the module use count */
id|ip_vs_use_count_dec
c_func
(paren
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
r_static
r_void
DECL|function|ip_vs_copy_stats
id|ip_vs_copy_stats
c_func
(paren
r_struct
id|ip_vs_stats_user
op_star
id|dst
comma
r_struct
id|ip_vs_stats
op_star
id|src
)paren
(brace
id|spin_lock_bh
c_func
(paren
op_amp
id|src-&gt;lock
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|dst
comma
id|src
comma
(paren
r_char
op_star
)paren
op_amp
id|src-&gt;lock
op_minus
(paren
r_char
op_star
)paren
id|src
)paren
suffix:semicolon
id|spin_unlock_bh
c_func
(paren
op_amp
id|src-&gt;lock
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|ip_vs_copy_service
id|ip_vs_copy_service
c_func
(paren
r_struct
id|ip_vs_service_entry
op_star
id|dst
comma
r_struct
id|ip_vs_service
op_star
id|src
)paren
(brace
id|dst-&gt;protocol
op_assign
id|src-&gt;protocol
suffix:semicolon
id|dst-&gt;addr
op_assign
id|src-&gt;addr
suffix:semicolon
id|dst-&gt;port
op_assign
id|src-&gt;port
suffix:semicolon
id|dst-&gt;fwmark
op_assign
id|src-&gt;fwmark
suffix:semicolon
id|strcpy
c_func
(paren
id|dst-&gt;sched_name
comma
id|src-&gt;scheduler-&gt;name
)paren
suffix:semicolon
id|dst-&gt;flags
op_assign
id|src-&gt;flags
suffix:semicolon
id|dst-&gt;timeout
op_assign
id|src-&gt;timeout
op_div
id|HZ
suffix:semicolon
id|dst-&gt;netmask
op_assign
id|src-&gt;netmask
suffix:semicolon
id|dst-&gt;num_dests
op_assign
id|src-&gt;num_dests
suffix:semicolon
id|ip_vs_copy_stats
c_func
(paren
op_amp
id|dst-&gt;stats
comma
op_amp
id|src-&gt;stats
)paren
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|__ip_vs_get_service_entries
id|__ip_vs_get_service_entries
c_func
(paren
r_const
r_struct
id|ip_vs_get_services
op_star
id|get
comma
r_struct
id|ip_vs_get_services
id|__user
op_star
id|uptr
)paren
(brace
r_int
id|idx
comma
id|count
op_assign
l_int|0
suffix:semicolon
r_struct
id|ip_vs_service
op_star
id|svc
suffix:semicolon
r_struct
id|ip_vs_service_entry
id|entry
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|idx
op_assign
l_int|0
suffix:semicolon
id|idx
OL
id|IP_VS_SVC_TAB_SIZE
suffix:semicolon
id|idx
op_increment
)paren
(brace
id|list_for_each_entry
c_func
(paren
id|svc
comma
op_amp
id|ip_vs_svc_table
(braket
id|idx
)braket
comma
id|s_list
)paren
(brace
r_if
c_cond
(paren
id|count
op_ge
id|get-&gt;num_services
)paren
r_goto
id|out
suffix:semicolon
id|ip_vs_copy_service
c_func
(paren
op_amp
id|entry
comma
id|svc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
op_amp
id|uptr-&gt;entrytable
(braket
id|count
)braket
comma
op_amp
id|entry
comma
r_sizeof
(paren
id|entry
)paren
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|count
op_increment
suffix:semicolon
)brace
)brace
r_for
c_loop
(paren
id|idx
op_assign
l_int|0
suffix:semicolon
id|idx
OL
id|IP_VS_SVC_TAB_SIZE
suffix:semicolon
id|idx
op_increment
)paren
(brace
id|list_for_each_entry
c_func
(paren
id|svc
comma
op_amp
id|ip_vs_svc_fwm_table
(braket
id|idx
)braket
comma
id|f_list
)paren
(brace
r_if
c_cond
(paren
id|count
op_ge
id|get-&gt;num_services
)paren
r_goto
id|out
suffix:semicolon
id|ip_vs_copy_service
c_func
(paren
op_amp
id|entry
comma
id|svc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
op_amp
id|uptr-&gt;entrytable
(braket
id|count
)braket
comma
op_amp
id|entry
comma
r_sizeof
(paren
id|entry
)paren
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|count
op_increment
suffix:semicolon
)brace
)brace
id|out
suffix:colon
r_return
id|ret
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|__ip_vs_get_dest_entries
id|__ip_vs_get_dest_entries
c_func
(paren
r_const
r_struct
id|ip_vs_get_dests
op_star
id|get
comma
r_struct
id|ip_vs_get_dests
id|__user
op_star
id|uptr
)paren
(brace
r_struct
id|ip_vs_service
op_star
id|svc
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|get-&gt;fwmark
)paren
id|svc
op_assign
id|__ip_vs_svc_fwm_get
c_func
(paren
id|get-&gt;fwmark
)paren
suffix:semicolon
r_else
id|svc
op_assign
id|__ip_vs_service_get
c_func
(paren
id|get-&gt;protocol
comma
id|get-&gt;addr
comma
id|get-&gt;port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|svc
)paren
(brace
r_int
id|count
op_assign
l_int|0
suffix:semicolon
r_struct
id|ip_vs_dest
op_star
id|dest
suffix:semicolon
r_struct
id|ip_vs_dest_entry
id|entry
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|dest
comma
op_amp
id|svc-&gt;destinations
comma
id|n_list
)paren
(brace
r_if
c_cond
(paren
id|count
op_ge
id|get-&gt;num_dests
)paren
r_break
suffix:semicolon
id|entry.addr
op_assign
id|dest-&gt;addr
suffix:semicolon
id|entry.port
op_assign
id|dest-&gt;port
suffix:semicolon
id|entry.conn_flags
op_assign
id|atomic_read
c_func
(paren
op_amp
id|dest-&gt;conn_flags
)paren
suffix:semicolon
id|entry.weight
op_assign
id|atomic_read
c_func
(paren
op_amp
id|dest-&gt;weight
)paren
suffix:semicolon
id|entry.u_threshold
op_assign
id|dest-&gt;u_threshold
suffix:semicolon
id|entry.l_threshold
op_assign
id|dest-&gt;l_threshold
suffix:semicolon
id|entry.activeconns
op_assign
id|atomic_read
c_func
(paren
op_amp
id|dest-&gt;activeconns
)paren
suffix:semicolon
id|entry.inactconns
op_assign
id|atomic_read
c_func
(paren
op_amp
id|dest-&gt;inactconns
)paren
suffix:semicolon
id|entry.persistconns
op_assign
id|atomic_read
c_func
(paren
op_amp
id|dest-&gt;persistconns
)paren
suffix:semicolon
id|ip_vs_copy_stats
c_func
(paren
op_amp
id|entry.stats
comma
op_amp
id|dest-&gt;stats
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
op_amp
id|uptr-&gt;entrytable
(braket
id|count
)braket
comma
op_amp
id|entry
comma
r_sizeof
(paren
id|entry
)paren
)paren
)paren
(brace
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
)brace
id|count
op_increment
suffix:semicolon
)brace
id|ip_vs_service_put
c_func
(paren
id|svc
)paren
suffix:semicolon
)brace
r_else
id|ret
op_assign
op_minus
id|ESRCH
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|__ip_vs_get_timeouts
id|__ip_vs_get_timeouts
c_func
(paren
r_struct
id|ip_vs_timeout_user
op_star
id|u
)paren
(brace
macro_line|#ifdef CONFIG_IP_VS_PROTO_TCP
id|u-&gt;tcp_timeout
op_assign
id|ip_vs_protocol_tcp.timeout_table
(braket
id|IP_VS_TCP_S_ESTABLISHED
)braket
op_div
id|HZ
suffix:semicolon
id|u-&gt;tcp_fin_timeout
op_assign
id|ip_vs_protocol_tcp.timeout_table
(braket
id|IP_VS_TCP_S_FIN_WAIT
)braket
op_div
id|HZ
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_IP_VS_PROTO_UDP
id|u-&gt;udp_timeout
op_assign
id|ip_vs_protocol_udp.timeout_table
(braket
id|IP_VS_UDP_S_NORMAL
)braket
op_div
id|HZ
suffix:semicolon
macro_line|#endif
)brace
DECL|macro|GET_CMDID
mdefine_line|#define GET_CMDID(cmd)&t;&t;(cmd - IP_VS_BASE_CTL)
DECL|macro|GET_INFO_ARG_LEN
mdefine_line|#define GET_INFO_ARG_LEN&t;(sizeof(struct ip_vs_getinfo))
DECL|macro|GET_SERVICES_ARG_LEN
mdefine_line|#define GET_SERVICES_ARG_LEN&t;(sizeof(struct ip_vs_get_services))
DECL|macro|GET_SERVICE_ARG_LEN
mdefine_line|#define GET_SERVICE_ARG_LEN&t;(sizeof(struct ip_vs_service_entry))
DECL|macro|GET_DESTS_ARG_LEN
mdefine_line|#define GET_DESTS_ARG_LEN&t;(sizeof(struct ip_vs_get_dests))
DECL|macro|GET_TIMEOUT_ARG_LEN
mdefine_line|#define GET_TIMEOUT_ARG_LEN&t;(sizeof(struct ip_vs_timeout_user))
DECL|macro|GET_DAEMON_ARG_LEN
mdefine_line|#define GET_DAEMON_ARG_LEN&t;(sizeof(struct ip_vs_daemon_user) * 2)
DECL|variable|get_arglen
r_static
r_int
r_char
id|get_arglen
(braket
id|GET_CMDID
c_func
(paren
id|IP_VS_SO_GET_MAX
)paren
op_plus
l_int|1
)braket
op_assign
(brace
(braket
id|GET_CMDID
c_func
(paren
id|IP_VS_SO_GET_VERSION
)paren
)braket
op_assign
l_int|64
comma
(braket
id|GET_CMDID
c_func
(paren
id|IP_VS_SO_GET_INFO
)paren
)braket
op_assign
id|GET_INFO_ARG_LEN
comma
(braket
id|GET_CMDID
c_func
(paren
id|IP_VS_SO_GET_SERVICES
)paren
)braket
op_assign
id|GET_SERVICES_ARG_LEN
comma
(braket
id|GET_CMDID
c_func
(paren
id|IP_VS_SO_GET_SERVICE
)paren
)braket
op_assign
id|GET_SERVICE_ARG_LEN
comma
(braket
id|GET_CMDID
c_func
(paren
id|IP_VS_SO_GET_DESTS
)paren
)braket
op_assign
id|GET_DESTS_ARG_LEN
comma
(braket
id|GET_CMDID
c_func
(paren
id|IP_VS_SO_GET_TIMEOUT
)paren
)braket
op_assign
id|GET_TIMEOUT_ARG_LEN
comma
(braket
id|GET_CMDID
c_func
(paren
id|IP_VS_SO_GET_DAEMON
)paren
)braket
op_assign
id|GET_DAEMON_ARG_LEN
comma
)brace
suffix:semicolon
r_static
r_int
DECL|function|do_ip_vs_get_ctl
id|do_ip_vs_get_ctl
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_int
id|cmd
comma
r_void
id|__user
op_star
id|user
comma
r_int
op_star
id|len
)paren
(brace
r_int
r_char
id|arg
(braket
l_int|128
)braket
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
r_if
c_cond
(paren
op_star
id|len
OL
id|get_arglen
(braket
id|GET_CMDID
c_func
(paren
id|cmd
)paren
)braket
)paren
(brace
id|IP_VS_ERR
c_func
(paren
l_string|&quot;get_ctl: len %u &lt; %u&bslash;n&quot;
comma
op_star
id|len
comma
id|get_arglen
(braket
id|GET_CMDID
c_func
(paren
id|cmd
)paren
)braket
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|arg
comma
id|user
comma
id|get_arglen
(braket
id|GET_CMDID
c_func
(paren
id|cmd
)paren
)braket
)paren
op_ne
l_int|0
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|down_interruptible
c_func
(paren
op_amp
id|__ip_vs_mutex
)paren
)paren
r_return
op_minus
id|ERESTARTSYS
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|IP_VS_SO_GET_VERSION
suffix:colon
(brace
r_char
id|buf
(braket
l_int|64
)braket
suffix:semicolon
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;IP Virtual Server version %d.%d.%d (size=%d)&quot;
comma
id|NVERSION
c_func
(paren
id|IP_VS_VERSION_CODE
)paren
comma
id|IP_VS_CONN_TAB_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|user
comma
id|buf
comma
id|strlen
c_func
(paren
id|buf
)paren
op_plus
l_int|1
)paren
op_ne
l_int|0
)paren
(brace
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
op_star
id|len
op_assign
id|strlen
c_func
(paren
id|buf
)paren
op_plus
l_int|1
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|IP_VS_SO_GET_INFO
suffix:colon
(brace
r_struct
id|ip_vs_getinfo
id|info
suffix:semicolon
id|info.version
op_assign
id|IP_VS_VERSION_CODE
suffix:semicolon
id|info.size
op_assign
id|IP_VS_CONN_TAB_SIZE
suffix:semicolon
id|info.num_services
op_assign
id|ip_vs_num_services
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|user
comma
op_amp
id|info
comma
r_sizeof
(paren
id|info
)paren
)paren
op_ne
l_int|0
)paren
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|IP_VS_SO_GET_SERVICES
suffix:colon
(brace
r_struct
id|ip_vs_get_services
op_star
id|get
suffix:semicolon
r_int
id|size
suffix:semicolon
id|get
op_assign
(paren
r_struct
id|ip_vs_get_services
op_star
)paren
id|arg
suffix:semicolon
id|size
op_assign
r_sizeof
(paren
op_star
id|get
)paren
op_plus
r_sizeof
(paren
r_struct
id|ip_vs_service_entry
)paren
op_star
id|get-&gt;num_services
suffix:semicolon
r_if
c_cond
(paren
op_star
id|len
op_ne
id|size
)paren
(brace
id|IP_VS_ERR
c_func
(paren
l_string|&quot;length: %u != %u&bslash;n&quot;
comma
op_star
id|len
comma
id|size
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|ret
op_assign
id|__ip_vs_get_service_entries
c_func
(paren
id|get
comma
id|user
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|IP_VS_SO_GET_SERVICE
suffix:colon
(brace
r_struct
id|ip_vs_service_entry
op_star
id|entry
suffix:semicolon
r_struct
id|ip_vs_service
op_star
id|svc
suffix:semicolon
id|entry
op_assign
(paren
r_struct
id|ip_vs_service_entry
op_star
)paren
id|arg
suffix:semicolon
r_if
c_cond
(paren
id|entry-&gt;fwmark
)paren
id|svc
op_assign
id|__ip_vs_svc_fwm_get
c_func
(paren
id|entry-&gt;fwmark
)paren
suffix:semicolon
r_else
id|svc
op_assign
id|__ip_vs_service_get
c_func
(paren
id|entry-&gt;protocol
comma
id|entry-&gt;addr
comma
id|entry-&gt;port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|svc
)paren
(brace
id|ip_vs_copy_service
c_func
(paren
id|entry
comma
id|svc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|user
comma
id|entry
comma
r_sizeof
(paren
op_star
id|entry
)paren
)paren
op_ne
l_int|0
)paren
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
id|ip_vs_service_put
c_func
(paren
id|svc
)paren
suffix:semicolon
)brace
r_else
id|ret
op_assign
op_minus
id|ESRCH
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|IP_VS_SO_GET_DESTS
suffix:colon
(brace
r_struct
id|ip_vs_get_dests
op_star
id|get
suffix:semicolon
r_int
id|size
suffix:semicolon
id|get
op_assign
(paren
r_struct
id|ip_vs_get_dests
op_star
)paren
id|arg
suffix:semicolon
id|size
op_assign
r_sizeof
(paren
op_star
id|get
)paren
op_plus
r_sizeof
(paren
r_struct
id|ip_vs_dest_entry
)paren
op_star
id|get-&gt;num_dests
suffix:semicolon
r_if
c_cond
(paren
op_star
id|len
op_ne
id|size
)paren
(brace
id|IP_VS_ERR
c_func
(paren
l_string|&quot;length: %u != %u&bslash;n&quot;
comma
op_star
id|len
comma
id|size
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|ret
op_assign
id|__ip_vs_get_dest_entries
c_func
(paren
id|get
comma
id|user
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|IP_VS_SO_GET_TIMEOUT
suffix:colon
(brace
r_struct
id|ip_vs_timeout_user
id|t
suffix:semicolon
id|__ip_vs_get_timeouts
c_func
(paren
op_amp
id|t
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|user
comma
op_amp
id|t
comma
r_sizeof
(paren
id|t
)paren
)paren
op_ne
l_int|0
)paren
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|IP_VS_SO_GET_DAEMON
suffix:colon
(brace
r_struct
id|ip_vs_daemon_user
id|d
(braket
l_int|2
)braket
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|d
comma
l_int|0
comma
r_sizeof
(paren
id|d
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ip_vs_sync_state
op_amp
id|IP_VS_STATE_MASTER
)paren
(brace
id|d
(braket
l_int|0
)braket
dot
id|state
op_assign
id|IP_VS_STATE_MASTER
suffix:semicolon
id|strcpy
c_func
(paren
id|d
(braket
l_int|0
)braket
dot
id|mcast_ifn
comma
id|ip_vs_master_mcast_ifn
)paren
suffix:semicolon
id|d
(braket
l_int|0
)braket
dot
id|syncid
op_assign
id|ip_vs_master_syncid
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ip_vs_sync_state
op_amp
id|IP_VS_STATE_BACKUP
)paren
(brace
id|d
(braket
l_int|1
)braket
dot
id|state
op_assign
id|IP_VS_STATE_BACKUP
suffix:semicolon
id|strcpy
c_func
(paren
id|d
(braket
l_int|1
)braket
dot
id|mcast_ifn
comma
id|ip_vs_backup_mcast_ifn
)paren
suffix:semicolon
id|d
(braket
l_int|1
)braket
dot
id|syncid
op_assign
id|ip_vs_backup_syncid
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|user
comma
op_amp
id|d
comma
r_sizeof
(paren
id|d
)paren
)paren
op_ne
l_int|0
)paren
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
id|out
suffix:colon
id|up
c_func
(paren
op_amp
id|__ip_vs_mutex
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|variable|ip_vs_sockopts
r_static
r_struct
id|nf_sockopt_ops
id|ip_vs_sockopts
op_assign
(brace
dot
id|pf
op_assign
id|PF_INET
comma
dot
id|set_optmin
op_assign
id|IP_VS_BASE_CTL
comma
dot
id|set_optmax
op_assign
id|IP_VS_SO_SET_MAX
op_plus
l_int|1
comma
dot
id|set
op_assign
id|do_ip_vs_set_ctl
comma
dot
id|get_optmin
op_assign
id|IP_VS_BASE_CTL
comma
dot
id|get_optmax
op_assign
id|IP_VS_SO_GET_MAX
op_plus
l_int|1
comma
dot
id|get
op_assign
id|do_ip_vs_get_ctl
comma
)brace
suffix:semicolon
DECL|function|ip_vs_control_init
r_int
id|ip_vs_control_init
c_func
(paren
r_void
)paren
(brace
r_int
id|ret
suffix:semicolon
r_int
id|idx
suffix:semicolon
id|EnterFunction
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|ret
op_assign
id|nf_register_sockopt
c_func
(paren
op_amp
id|ip_vs_sockopts
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|IP_VS_ERR
c_func
(paren
l_string|&quot;cannot register sockopt.&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
id|proc_net_fops_create
c_func
(paren
l_string|&quot;ip_vs&quot;
comma
l_int|0
comma
op_amp
id|ip_vs_info_fops
)paren
suffix:semicolon
id|proc_net_fops_create
c_func
(paren
l_string|&quot;ip_vs_stats&quot;
comma
l_int|0
comma
op_amp
id|ip_vs_stats_fops
)paren
suffix:semicolon
id|sysctl_header
op_assign
id|register_sysctl_table
c_func
(paren
id|vs_root_table
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Initialize ip_vs_svc_table, ip_vs_svc_fwm_table, ip_vs_rtable */
r_for
c_loop
(paren
id|idx
op_assign
l_int|0
suffix:semicolon
id|idx
OL
id|IP_VS_SVC_TAB_SIZE
suffix:semicolon
id|idx
op_increment
)paren
(brace
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|ip_vs_svc_table
(braket
id|idx
)braket
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|ip_vs_svc_fwm_table
(braket
id|idx
)braket
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|idx
op_assign
l_int|0
suffix:semicolon
id|idx
OL
id|IP_VS_RTAB_SIZE
suffix:semicolon
id|idx
op_increment
)paren
(brace
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|ip_vs_rtable
(braket
id|idx
)braket
)paren
suffix:semicolon
)brace
id|memset
c_func
(paren
op_amp
id|ip_vs_stats
comma
l_int|0
comma
r_sizeof
(paren
id|ip_vs_stats
)paren
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|ip_vs_stats.lock
)paren
suffix:semicolon
id|ip_vs_new_estimator
c_func
(paren
op_amp
id|ip_vs_stats
)paren
suffix:semicolon
multiline_comment|/* Hook the defense timer */
id|init_timer
c_func
(paren
op_amp
id|defense_timer
)paren
suffix:semicolon
id|defense_timer.function
op_assign
id|defense_timer_handler
suffix:semicolon
id|defense_timer.expires
op_assign
id|jiffies
op_plus
id|DEFENSE_TIMER_PERIOD
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|defense_timer
)paren
suffix:semicolon
id|LeaveFunction
c_func
(paren
l_int|2
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ip_vs_control_cleanup
r_void
id|ip_vs_control_cleanup
c_func
(paren
r_void
)paren
(brace
id|EnterFunction
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|ip_vs_trash_cleanup
c_func
(paren
)paren
suffix:semicolon
id|del_timer_sync
c_func
(paren
op_amp
id|defense_timer
)paren
suffix:semicolon
id|ip_vs_kill_estimator
c_func
(paren
op_amp
id|ip_vs_stats
)paren
suffix:semicolon
id|unregister_sysctl_table
c_func
(paren
id|sysctl_header
)paren
suffix:semicolon
id|proc_net_remove
c_func
(paren
l_string|&quot;ip_vs_stats&quot;
)paren
suffix:semicolon
id|proc_net_remove
c_func
(paren
l_string|&quot;ip_vs&quot;
)paren
suffix:semicolon
id|nf_unregister_sockopt
c_func
(paren
op_amp
id|ip_vs_sockopts
)paren
suffix:semicolon
id|LeaveFunction
c_func
(paren
l_int|2
)paren
suffix:semicolon
)brace
eof
