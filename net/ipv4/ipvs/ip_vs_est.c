multiline_comment|/*&n; * ip_vs_est.c: simple rate estimator for IPVS&n; *&n; * Version:     $Id: ip_vs_est.c,v 1.4 2002/11/30 01:50:35 wensong Exp $&n; *&n; * Authors:     Wensong Zhang &lt;wensong@linuxvirtualserver.org&gt;&n; *&n; *              This program is free software; you can redistribute it and/or&n; *              modify it under the terms of the GNU General Public License&n; *              as published by the Free Software Foundation; either version&n; *              2 of the License, or (at your option) any later version.&n; *&n; * Changes:&n; *&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;net/ip_vs.h&gt;
multiline_comment|/*&n;  This code is to estimate rate in a shorter interval (such as 8&n;  seconds) for virtual services and real servers. For measure rate in a&n;  long interval, it is easy to implement a user level daemon which&n;  periodically reads those statistical counters and measure rate.&n;&n;  Currently, the measurement is activated by slow timer handler. Hope&n;  this measurement will not introduce too much load.&n;&n;  We measure rate during the last 8 seconds every 2 seconds:&n;&n;    avgrate = avgrate*(1-W) + rate*W&n;&n;    where W = 2^(-2)&n;&n;  NOTES.&n;&n;  * The stored value for average bps is scaled by 2^5, so that maximal&n;    rate is ~2.15Gbits/s, average pps and cps are scaled by 2^10.&n;&n;  * A lot code is taken from net/sched/estimator.c&n; */
DECL|struct|ip_vs_estimator
r_struct
id|ip_vs_estimator
(brace
DECL|member|next
r_struct
id|ip_vs_estimator
op_star
id|next
suffix:semicolon
DECL|member|stats
r_struct
id|ip_vs_stats
op_star
id|stats
suffix:semicolon
DECL|member|last_conns
id|u32
id|last_conns
suffix:semicolon
DECL|member|last_inpkts
id|u32
id|last_inpkts
suffix:semicolon
DECL|member|last_outpkts
id|u32
id|last_outpkts
suffix:semicolon
DECL|member|last_inbytes
id|u64
id|last_inbytes
suffix:semicolon
DECL|member|last_outbytes
id|u64
id|last_outbytes
suffix:semicolon
DECL|member|cps
id|u32
id|cps
suffix:semicolon
DECL|member|inpps
id|u32
id|inpps
suffix:semicolon
DECL|member|outpps
id|u32
id|outpps
suffix:semicolon
DECL|member|inbps
id|u32
id|inbps
suffix:semicolon
DECL|member|outbps
id|u32
id|outbps
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|est_list
r_static
r_struct
id|ip_vs_estimator
op_star
id|est_list
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|est_lock
r_static
id|rwlock_t
id|est_lock
op_assign
id|RW_LOCK_UNLOCKED
suffix:semicolon
DECL|variable|est_timer
r_static
r_struct
id|timer_list
id|est_timer
suffix:semicolon
DECL|function|estimation_timer
r_static
r_void
id|estimation_timer
c_func
(paren
r_int
r_int
id|arg
)paren
(brace
r_struct
id|ip_vs_estimator
op_star
id|e
suffix:semicolon
r_struct
id|ip_vs_stats
op_star
id|s
suffix:semicolon
id|u32
id|n_conns
suffix:semicolon
id|u32
id|n_inpkts
comma
id|n_outpkts
suffix:semicolon
id|u64
id|n_inbytes
comma
id|n_outbytes
suffix:semicolon
id|u32
id|rate
suffix:semicolon
id|read_lock
c_func
(paren
op_amp
id|est_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|e
op_assign
id|est_list
suffix:semicolon
id|e
suffix:semicolon
id|e
op_assign
id|e-&gt;next
)paren
(brace
id|s
op_assign
id|e-&gt;stats
suffix:semicolon
id|n_conns
op_assign
id|s-&gt;conns
suffix:semicolon
id|n_inpkts
op_assign
id|s-&gt;inpkts
suffix:semicolon
id|n_outpkts
op_assign
id|s-&gt;outpkts
suffix:semicolon
id|n_inbytes
op_assign
id|s-&gt;inbytes
suffix:semicolon
id|n_outbytes
op_assign
id|s-&gt;outbytes
suffix:semicolon
multiline_comment|/* scaled by 2^10, but divided 2 seconds */
id|rate
op_assign
(paren
id|n_conns
op_minus
id|e-&gt;last_conns
)paren
op_lshift
l_int|9
suffix:semicolon
id|e-&gt;last_conns
op_assign
id|n_conns
suffix:semicolon
id|e-&gt;cps
op_add_assign
(paren
(paren
r_int
)paren
id|rate
op_minus
(paren
r_int
)paren
id|e-&gt;cps
)paren
op_rshift
l_int|2
suffix:semicolon
id|s-&gt;cps
op_assign
(paren
id|e-&gt;cps
op_plus
l_int|0x1FF
)paren
op_rshift
l_int|10
suffix:semicolon
id|rate
op_assign
(paren
id|n_inpkts
op_minus
id|e-&gt;last_inpkts
)paren
op_lshift
l_int|9
suffix:semicolon
id|e-&gt;last_inpkts
op_assign
id|n_inpkts
suffix:semicolon
id|e-&gt;inpps
op_add_assign
(paren
(paren
r_int
)paren
id|rate
op_minus
(paren
r_int
)paren
id|e-&gt;inpps
)paren
op_rshift
l_int|2
suffix:semicolon
id|s-&gt;inpps
op_assign
(paren
id|e-&gt;inpps
op_plus
l_int|0x1FF
)paren
op_rshift
l_int|10
suffix:semicolon
id|rate
op_assign
(paren
id|n_outpkts
op_minus
id|e-&gt;last_outpkts
)paren
op_lshift
l_int|9
suffix:semicolon
id|e-&gt;last_outpkts
op_assign
id|n_outpkts
suffix:semicolon
id|e-&gt;outpps
op_add_assign
(paren
(paren
r_int
)paren
id|rate
op_minus
(paren
r_int
)paren
id|e-&gt;outpps
)paren
op_rshift
l_int|2
suffix:semicolon
id|s-&gt;outpps
op_assign
(paren
id|e-&gt;outpps
op_plus
l_int|0x1FF
)paren
op_rshift
l_int|10
suffix:semicolon
id|rate
op_assign
(paren
id|n_inbytes
op_minus
id|e-&gt;last_inbytes
)paren
op_lshift
l_int|4
suffix:semicolon
id|e-&gt;last_inbytes
op_assign
id|n_inbytes
suffix:semicolon
id|e-&gt;inbps
op_add_assign
(paren
(paren
r_int
)paren
id|rate
op_minus
(paren
r_int
)paren
id|e-&gt;inbps
)paren
op_rshift
l_int|2
suffix:semicolon
id|s-&gt;inbps
op_assign
(paren
id|e-&gt;inbps
op_plus
l_int|0xF
)paren
op_rshift
l_int|5
suffix:semicolon
id|rate
op_assign
(paren
id|n_outbytes
op_minus
id|e-&gt;last_outbytes
)paren
op_lshift
l_int|4
suffix:semicolon
id|e-&gt;last_outbytes
op_assign
id|n_outbytes
suffix:semicolon
id|e-&gt;outbps
op_add_assign
(paren
(paren
r_int
)paren
id|rate
op_minus
(paren
r_int
)paren
id|e-&gt;outbps
)paren
op_rshift
l_int|2
suffix:semicolon
id|s-&gt;outbps
op_assign
(paren
id|e-&gt;outbps
op_plus
l_int|0xF
)paren
op_rshift
l_int|5
suffix:semicolon
)brace
id|read_unlock
c_func
(paren
op_amp
id|est_lock
)paren
suffix:semicolon
id|mod_timer
c_func
(paren
op_amp
id|est_timer
comma
id|jiffies
op_plus
l_int|2
op_star
id|HZ
)paren
suffix:semicolon
)brace
DECL|function|ip_vs_new_estimator
r_int
id|ip_vs_new_estimator
c_func
(paren
r_struct
id|ip_vs_stats
op_star
id|stats
)paren
(brace
r_struct
id|ip_vs_estimator
op_star
id|est
suffix:semicolon
id|est
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|est
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|est
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|est
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|est
)paren
)paren
suffix:semicolon
id|est-&gt;stats
op_assign
id|stats
suffix:semicolon
id|est-&gt;last_conns
op_assign
id|stats-&gt;conns
suffix:semicolon
id|est-&gt;cps
op_assign
id|stats-&gt;cps
op_lshift
l_int|10
suffix:semicolon
id|est-&gt;last_inpkts
op_assign
id|stats-&gt;inpkts
suffix:semicolon
id|est-&gt;inpps
op_assign
id|stats-&gt;inpps
op_lshift
l_int|10
suffix:semicolon
id|est-&gt;last_outpkts
op_assign
id|stats-&gt;outpkts
suffix:semicolon
id|est-&gt;outpps
op_assign
id|stats-&gt;outpps
op_lshift
l_int|10
suffix:semicolon
id|est-&gt;last_inbytes
op_assign
id|stats-&gt;inbytes
suffix:semicolon
id|est-&gt;inbps
op_assign
id|stats-&gt;inbps
op_lshift
l_int|5
suffix:semicolon
id|est-&gt;last_outbytes
op_assign
id|stats-&gt;outbytes
suffix:semicolon
id|est-&gt;outbps
op_assign
id|stats-&gt;outbps
op_lshift
l_int|5
suffix:semicolon
id|write_lock_bh
c_func
(paren
op_amp
id|est_lock
)paren
suffix:semicolon
id|est-&gt;next
op_assign
id|est_list
suffix:semicolon
r_if
c_cond
(paren
id|est-&gt;next
op_eq
l_int|NULL
)paren
(brace
id|init_timer
c_func
(paren
op_amp
id|est_timer
)paren
suffix:semicolon
id|est_timer.expires
op_assign
id|jiffies
op_plus
l_int|2
op_star
id|HZ
suffix:semicolon
id|est_timer.function
op_assign
id|estimation_timer
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|est_timer
)paren
suffix:semicolon
)brace
id|est_list
op_assign
id|est
suffix:semicolon
id|write_unlock_bh
c_func
(paren
op_amp
id|est_lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ip_vs_kill_estimator
r_void
id|ip_vs_kill_estimator
c_func
(paren
r_struct
id|ip_vs_stats
op_star
id|stats
)paren
(brace
r_struct
id|ip_vs_estimator
op_star
id|est
comma
op_star
op_star
id|pest
suffix:semicolon
r_int
id|killed
op_assign
l_int|0
suffix:semicolon
id|write_lock_bh
c_func
(paren
op_amp
id|est_lock
)paren
suffix:semicolon
id|pest
op_assign
op_amp
id|est_list
suffix:semicolon
r_while
c_loop
(paren
(paren
id|est
op_assign
op_star
id|pest
)paren
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|est-&gt;stats
op_ne
id|stats
)paren
(brace
id|pest
op_assign
op_amp
id|est-&gt;next
suffix:semicolon
r_continue
suffix:semicolon
)brace
op_star
id|pest
op_assign
id|est-&gt;next
suffix:semicolon
id|kfree
c_func
(paren
id|est
)paren
suffix:semicolon
id|killed
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|killed
op_logical_and
id|est_list
op_eq
l_int|NULL
)paren
id|del_timer_sync
c_func
(paren
op_amp
id|est_timer
)paren
suffix:semicolon
id|write_unlock_bh
c_func
(paren
op_amp
id|est_lock
)paren
suffix:semicolon
)brace
DECL|function|ip_vs_zero_estimator
r_void
id|ip_vs_zero_estimator
c_func
(paren
r_struct
id|ip_vs_stats
op_star
id|stats
)paren
(brace
r_struct
id|ip_vs_estimator
op_star
id|e
suffix:semicolon
id|write_lock_bh
c_func
(paren
op_amp
id|est_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|e
op_assign
id|est_list
suffix:semicolon
id|e
suffix:semicolon
id|e
op_assign
id|e-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|e-&gt;stats
op_ne
id|stats
)paren
r_continue
suffix:semicolon
multiline_comment|/* set counters zero */
id|e-&gt;last_conns
op_assign
l_int|0
suffix:semicolon
id|e-&gt;last_inpkts
op_assign
l_int|0
suffix:semicolon
id|e-&gt;last_outpkts
op_assign
l_int|0
suffix:semicolon
id|e-&gt;last_inbytes
op_assign
l_int|0
suffix:semicolon
id|e-&gt;last_outbytes
op_assign
l_int|0
suffix:semicolon
id|e-&gt;cps
op_assign
l_int|0
suffix:semicolon
id|e-&gt;inpps
op_assign
l_int|0
suffix:semicolon
id|e-&gt;outpps
op_assign
l_int|0
suffix:semicolon
id|e-&gt;inbps
op_assign
l_int|0
suffix:semicolon
id|e-&gt;outbps
op_assign
l_int|0
suffix:semicolon
)brace
id|write_unlock_bh
c_func
(paren
op_amp
id|est_lock
)paren
suffix:semicolon
)brace
eof
