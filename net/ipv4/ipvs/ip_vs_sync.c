multiline_comment|/*&n; * IPVS         An implementation of the IP virtual server support for the&n; *              LINUX operating system.  IPVS is now implemented as a module&n; *              over the NetFilter framework. IPVS can be used to build a&n; *              high-performance and highly available server based on a&n; *              cluster of servers.&n; *&n; * Version:     $Id: ip_vs_sync.c,v 1.13 2003/06/08 09:31:19 wensong Exp $&n; *&n; * Authors:     Wensong Zhang &lt;wensong@linuxvirtualserver.org&gt;&n; *&n; * ip_vs_sync:  sync connection info from master load balancer to backups&n; *              through multicast&n; *&n; * Changes:&n; *&t;Alexandre Cassen&t;:&t;Added master &amp; backup support at a time.&n; *&t;Alexandre Cassen&t;:&t;Added SyncID support for incoming sync&n; *&t;&t;&t;&t;&t;messages filtering.&n; *&t;Justin Ossevoort&t;:&t;Fix endian problem on sync message size.&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/net.h&gt;
macro_line|#include &lt;linux/completion.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/igmp.h&gt;                 /* for ip_mc_join_group */
macro_line|#include &lt;net/ip.h&gt;
macro_line|#include &lt;net/sock.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;                /* for get_fs and set_fs */
macro_line|#include &lt;net/ip_vs.h&gt;
DECL|macro|IP_VS_SYNC_GROUP
mdefine_line|#define IP_VS_SYNC_GROUP 0xe0000051    /* multicast addr - 224.0.0.81 */
DECL|macro|IP_VS_SYNC_PORT
mdefine_line|#define IP_VS_SYNC_PORT  8848          /* multicast port */
multiline_comment|/*&n; *&t;IPVS sync connection entry&n; */
DECL|struct|ip_vs_sync_conn
r_struct
id|ip_vs_sync_conn
(brace
DECL|member|reserved
id|__u8
id|reserved
suffix:semicolon
multiline_comment|/* Protocol, addresses and port numbers */
DECL|member|protocol
id|__u8
id|protocol
suffix:semicolon
multiline_comment|/* Which protocol (TCP/UDP) */
DECL|member|cport
id|__u16
id|cport
suffix:semicolon
DECL|member|vport
id|__u16
id|vport
suffix:semicolon
DECL|member|dport
id|__u16
id|dport
suffix:semicolon
DECL|member|caddr
id|__u32
id|caddr
suffix:semicolon
multiline_comment|/* client address */
DECL|member|vaddr
id|__u32
id|vaddr
suffix:semicolon
multiline_comment|/* virtual address */
DECL|member|daddr
id|__u32
id|daddr
suffix:semicolon
multiline_comment|/* destination address */
multiline_comment|/* Flags and state transition */
DECL|member|flags
id|__u16
id|flags
suffix:semicolon
multiline_comment|/* status flags */
DECL|member|state
id|__u16
id|state
suffix:semicolon
multiline_comment|/* state info */
multiline_comment|/* The sequence options start here */
)brace
suffix:semicolon
DECL|struct|ip_vs_sync_conn_options
r_struct
id|ip_vs_sync_conn_options
(brace
DECL|member|in_seq
r_struct
id|ip_vs_seq
id|in_seq
suffix:semicolon
multiline_comment|/* incoming seq. struct */
DECL|member|out_seq
r_struct
id|ip_vs_seq
id|out_seq
suffix:semicolon
multiline_comment|/* outgoing seq. struct */
)brace
suffix:semicolon
DECL|macro|IP_VS_SYNC_CONN_TIMEOUT
mdefine_line|#define IP_VS_SYNC_CONN_TIMEOUT (3*60*HZ)
DECL|macro|SIMPLE_CONN_SIZE
mdefine_line|#define SIMPLE_CONN_SIZE  (sizeof(struct ip_vs_sync_conn))
DECL|macro|FULL_CONN_SIZE
mdefine_line|#define FULL_CONN_SIZE  &bslash;&n;(sizeof(struct ip_vs_sync_conn) + sizeof(struct ip_vs_sync_conn_options))
multiline_comment|/*&n;  The master mulitcasts messages to the backup load balancers in the&n;  following format.&n;&n;       0                   1                   2                   3&n;       0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1&n;      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+&n;      |  Count Conns  |    SyncID     |            Size               |&n;      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+&n;      |                                                               |&n;      |                    IPVS Sync Connection (1)                   |&n;      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+&n;      |                            .                                  |&n;      |                            .                                  |&n;      |                            .                                  |&n;      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+&n;      |                                                               |&n;      |                    IPVS Sync Connection (n)                   |&n;      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+&n;*/
DECL|macro|SYNC_MESG_HEADER_LEN
mdefine_line|#define SYNC_MESG_HEADER_LEN&t;4
DECL|struct|ip_vs_sync_mesg
r_struct
id|ip_vs_sync_mesg
(brace
DECL|member|nr_conns
id|__u8
id|nr_conns
suffix:semicolon
DECL|member|syncid
id|__u8
id|syncid
suffix:semicolon
DECL|member|size
id|__u16
id|size
suffix:semicolon
multiline_comment|/* ip_vs_sync_conn entries start here */
)brace
suffix:semicolon
multiline_comment|/* the maximum length of sync (sending/receiving) message */
DECL|variable|sync_send_mesg_maxlen
r_static
r_int
id|sync_send_mesg_maxlen
suffix:semicolon
DECL|variable|sync_recv_mesg_maxlen
r_static
r_int
id|sync_recv_mesg_maxlen
suffix:semicolon
DECL|struct|ip_vs_sync_buff
r_struct
id|ip_vs_sync_buff
(brace
DECL|member|list
r_struct
id|list_head
id|list
suffix:semicolon
DECL|member|firstuse
r_int
r_int
id|firstuse
suffix:semicolon
multiline_comment|/* pointers for the message data */
DECL|member|mesg
r_struct
id|ip_vs_sync_mesg
op_star
id|mesg
suffix:semicolon
DECL|member|head
r_int
r_char
op_star
id|head
suffix:semicolon
DECL|member|end
r_int
r_char
op_star
id|end
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* the sync_buff list head and the lock */
r_static
id|LIST_HEAD
c_func
(paren
id|ip_vs_sync_queue
)paren
suffix:semicolon
DECL|variable|ip_vs_sync_lock
r_static
id|spinlock_t
id|ip_vs_sync_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
multiline_comment|/* current sync_buff for accepting new conn entries */
DECL|variable|curr_sb
r_static
r_struct
id|ip_vs_sync_buff
op_star
id|curr_sb
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|curr_sb_lock
r_static
id|spinlock_t
id|curr_sb_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
multiline_comment|/* ipvs sync daemon state */
DECL|variable|ip_vs_sync_state
r_volatile
r_int
id|ip_vs_sync_state
op_assign
id|IP_VS_STATE_NONE
suffix:semicolon
DECL|variable|ip_vs_master_syncid
r_volatile
r_int
id|ip_vs_master_syncid
op_assign
l_int|0
suffix:semicolon
DECL|variable|ip_vs_backup_syncid
r_volatile
r_int
id|ip_vs_backup_syncid
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* multicast interface name */
DECL|variable|ip_vs_master_mcast_ifn
r_char
id|ip_vs_master_mcast_ifn
(braket
id|IP_VS_IFNAME_MAXLEN
)braket
suffix:semicolon
DECL|variable|ip_vs_backup_mcast_ifn
r_char
id|ip_vs_backup_mcast_ifn
(braket
id|IP_VS_IFNAME_MAXLEN
)braket
suffix:semicolon
multiline_comment|/* multicast addr */
DECL|variable|mcast_addr
r_static
r_struct
id|sockaddr_in
id|mcast_addr
suffix:semicolon
DECL|function|sb_queue_tail
r_static
r_inline
r_void
id|sb_queue_tail
c_func
(paren
r_struct
id|ip_vs_sync_buff
op_star
id|sb
)paren
(brace
id|spin_lock
c_func
(paren
op_amp
id|ip_vs_sync_lock
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|sb-&gt;list
comma
op_amp
id|ip_vs_sync_queue
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|ip_vs_sync_lock
)paren
suffix:semicolon
)brace
DECL|function|sb_dequeue
r_static
r_inline
r_struct
id|ip_vs_sync_buff
op_star
id|sb_dequeue
c_func
(paren
r_void
)paren
(brace
r_struct
id|ip_vs_sync_buff
op_star
id|sb
suffix:semicolon
id|spin_lock_bh
c_func
(paren
op_amp
id|ip_vs_sync_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|list_empty
c_func
(paren
op_amp
id|ip_vs_sync_queue
)paren
)paren
(brace
id|sb
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
(brace
id|sb
op_assign
id|list_entry
c_func
(paren
id|ip_vs_sync_queue.next
comma
r_struct
id|ip_vs_sync_buff
comma
id|list
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|sb-&gt;list
)paren
suffix:semicolon
)brace
id|spin_unlock_bh
c_func
(paren
op_amp
id|ip_vs_sync_lock
)paren
suffix:semicolon
r_return
id|sb
suffix:semicolon
)brace
DECL|function|ip_vs_sync_buff_create
r_static
r_inline
r_struct
id|ip_vs_sync_buff
op_star
id|ip_vs_sync_buff_create
c_func
(paren
r_void
)paren
(brace
r_struct
id|ip_vs_sync_buff
op_star
id|sb
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|sb
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|ip_vs_sync_buff
)paren
comma
id|GFP_ATOMIC
)paren
)paren
)paren
r_return
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|sb-&gt;mesg
op_assign
id|kmalloc
c_func
(paren
id|sync_send_mesg_maxlen
comma
id|GFP_ATOMIC
)paren
)paren
)paren
(brace
id|kfree
c_func
(paren
id|sb
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|sb-&gt;mesg-&gt;nr_conns
op_assign
l_int|0
suffix:semicolon
id|sb-&gt;mesg-&gt;syncid
op_assign
id|ip_vs_master_syncid
suffix:semicolon
id|sb-&gt;mesg-&gt;size
op_assign
l_int|4
suffix:semicolon
id|sb-&gt;head
op_assign
(paren
r_int
r_char
op_star
)paren
id|sb-&gt;mesg
op_plus
l_int|4
suffix:semicolon
id|sb-&gt;end
op_assign
(paren
r_int
r_char
op_star
)paren
id|sb-&gt;mesg
op_plus
id|sync_send_mesg_maxlen
suffix:semicolon
id|sb-&gt;firstuse
op_assign
id|jiffies
suffix:semicolon
r_return
id|sb
suffix:semicolon
)brace
DECL|function|ip_vs_sync_buff_release
r_static
r_inline
r_void
id|ip_vs_sync_buff_release
c_func
(paren
r_struct
id|ip_vs_sync_buff
op_star
id|sb
)paren
(brace
id|kfree
c_func
(paren
id|sb-&gt;mesg
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|sb
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Get the current sync buffer if it has been created for more&n; *&t;than the specified time or the specified time is zero.&n; */
r_static
r_inline
r_struct
id|ip_vs_sync_buff
op_star
DECL|function|get_curr_sync_buff
id|get_curr_sync_buff
c_func
(paren
r_int
r_int
id|time
)paren
(brace
r_struct
id|ip_vs_sync_buff
op_star
id|sb
suffix:semicolon
id|spin_lock_bh
c_func
(paren
op_amp
id|curr_sb_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|curr_sb
op_logical_and
(paren
id|time
op_eq
l_int|0
op_logical_or
id|time_before
c_func
(paren
id|jiffies
op_minus
id|curr_sb-&gt;firstuse
comma
id|time
)paren
)paren
)paren
(brace
id|sb
op_assign
id|curr_sb
suffix:semicolon
id|curr_sb
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
id|sb
op_assign
l_int|NULL
suffix:semicolon
id|spin_unlock_bh
c_func
(paren
op_amp
id|curr_sb_lock
)paren
suffix:semicolon
r_return
id|sb
suffix:semicolon
)brace
multiline_comment|/*&n; *      Add an ip_vs_conn information into the current sync_buff.&n; *      Called by ip_vs_in.&n; */
DECL|function|ip_vs_sync_conn
r_void
id|ip_vs_sync_conn
c_func
(paren
r_struct
id|ip_vs_conn
op_star
id|cp
)paren
(brace
r_struct
id|ip_vs_sync_mesg
op_star
id|m
suffix:semicolon
r_struct
id|ip_vs_sync_conn
op_star
id|s
suffix:semicolon
r_int
id|len
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|curr_sb_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|curr_sb
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|curr_sb
op_assign
id|ip_vs_sync_buff_create
c_func
(paren
)paren
)paren
)paren
(brace
id|spin_unlock
c_func
(paren
op_amp
id|curr_sb_lock
)paren
suffix:semicolon
id|IP_VS_ERR
c_func
(paren
l_string|&quot;ip_vs_sync_buff_create failed.&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
id|len
op_assign
(paren
id|cp-&gt;flags
op_amp
id|IP_VS_CONN_F_SEQ_MASK
)paren
ques
c_cond
id|FULL_CONN_SIZE
suffix:colon
id|SIMPLE_CONN_SIZE
suffix:semicolon
id|m
op_assign
id|curr_sb-&gt;mesg
suffix:semicolon
id|s
op_assign
(paren
r_struct
id|ip_vs_sync_conn
op_star
)paren
id|curr_sb-&gt;head
suffix:semicolon
multiline_comment|/* copy members */
id|s-&gt;protocol
op_assign
id|cp-&gt;protocol
suffix:semicolon
id|s-&gt;cport
op_assign
id|cp-&gt;cport
suffix:semicolon
id|s-&gt;vport
op_assign
id|cp-&gt;vport
suffix:semicolon
id|s-&gt;dport
op_assign
id|cp-&gt;dport
suffix:semicolon
id|s-&gt;caddr
op_assign
id|cp-&gt;caddr
suffix:semicolon
id|s-&gt;vaddr
op_assign
id|cp-&gt;vaddr
suffix:semicolon
id|s-&gt;daddr
op_assign
id|cp-&gt;daddr
suffix:semicolon
id|s-&gt;flags
op_assign
id|htons
c_func
(paren
id|cp-&gt;flags
op_amp
op_complement
id|IP_VS_CONN_F_HASHED
)paren
suffix:semicolon
id|s-&gt;state
op_assign
id|htons
c_func
(paren
id|cp-&gt;state
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cp-&gt;flags
op_amp
id|IP_VS_CONN_F_SEQ_MASK
)paren
(brace
r_struct
id|ip_vs_sync_conn_options
op_star
id|opt
op_assign
(paren
r_struct
id|ip_vs_sync_conn_options
op_star
)paren
op_amp
id|s
(braket
l_int|1
)braket
suffix:semicolon
id|memcpy
c_func
(paren
id|opt
comma
op_amp
id|cp-&gt;in_seq
comma
r_sizeof
(paren
op_star
id|opt
)paren
)paren
suffix:semicolon
)brace
id|m-&gt;nr_conns
op_increment
suffix:semicolon
id|m-&gt;size
op_add_assign
id|len
suffix:semicolon
id|curr_sb-&gt;head
op_add_assign
id|len
suffix:semicolon
multiline_comment|/* check if there is a space for next one */
r_if
c_cond
(paren
id|curr_sb-&gt;head
op_plus
id|FULL_CONN_SIZE
OG
id|curr_sb-&gt;end
)paren
(brace
id|sb_queue_tail
c_func
(paren
id|curr_sb
)paren
suffix:semicolon
id|curr_sb
op_assign
l_int|NULL
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|curr_sb_lock
)paren
suffix:semicolon
multiline_comment|/* synchronize its controller if it has */
r_if
c_cond
(paren
id|cp-&gt;control
)paren
id|ip_vs_sync_conn
c_func
(paren
id|cp-&gt;control
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *      Process received multicast message and create the corresponding&n; *      ip_vs_conn entries.&n; */
DECL|function|ip_vs_process_message
r_static
r_void
id|ip_vs_process_message
c_func
(paren
r_const
r_char
op_star
id|buffer
comma
r_const
r_int
id|buflen
)paren
(brace
r_struct
id|ip_vs_sync_mesg
op_star
id|m
op_assign
(paren
r_struct
id|ip_vs_sync_mesg
op_star
)paren
id|buffer
suffix:semicolon
r_struct
id|ip_vs_sync_conn
op_star
id|s
suffix:semicolon
r_struct
id|ip_vs_sync_conn_options
op_star
id|opt
suffix:semicolon
r_struct
id|ip_vs_conn
op_star
id|cp
suffix:semicolon
r_char
op_star
id|p
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* Convert size back to host byte order */
id|m-&gt;size
op_assign
id|ntohs
c_func
(paren
id|m-&gt;size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buflen
op_ne
id|m-&gt;size
)paren
(brace
id|IP_VS_ERR
c_func
(paren
l_string|&quot;bogus message&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* SyncID sanity check */
r_if
c_cond
(paren
id|ip_vs_backup_syncid
op_ne
l_int|0
op_logical_and
id|m-&gt;syncid
op_ne
id|ip_vs_backup_syncid
)paren
(brace
id|IP_VS_DBG
c_func
(paren
l_int|7
comma
l_string|&quot;Ignoring incoming msg with syncid = %d&bslash;n&quot;
comma
id|m-&gt;syncid
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|p
op_assign
(paren
r_char
op_star
)paren
id|buffer
op_plus
r_sizeof
(paren
r_struct
id|ip_vs_sync_mesg
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|m-&gt;nr_conns
suffix:semicolon
id|i
op_increment
)paren
(brace
id|s
op_assign
(paren
r_struct
id|ip_vs_sync_conn
op_star
)paren
id|p
suffix:semicolon
id|cp
op_assign
id|ip_vs_conn_in_get
c_func
(paren
id|s-&gt;protocol
comma
id|s-&gt;caddr
comma
id|s-&gt;cport
comma
id|s-&gt;vaddr
comma
id|s-&gt;vport
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cp
)paren
(brace
id|cp
op_assign
id|ip_vs_conn_new
c_func
(paren
id|s-&gt;protocol
comma
id|s-&gt;caddr
comma
id|s-&gt;cport
comma
id|s-&gt;vaddr
comma
id|s-&gt;vport
comma
id|s-&gt;daddr
comma
id|s-&gt;dport
comma
id|ntohs
c_func
(paren
id|s-&gt;flags
)paren
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cp
)paren
(brace
id|IP_VS_ERR
c_func
(paren
l_string|&quot;ip_vs_conn_new failed&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|cp-&gt;state
op_assign
id|ntohs
c_func
(paren
id|s-&gt;state
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|cp-&gt;dest
)paren
(brace
multiline_comment|/* it is an entry created by the synchronization */
id|cp-&gt;state
op_assign
id|ntohs
c_func
(paren
id|s-&gt;state
)paren
suffix:semicolon
id|cp-&gt;flags
op_assign
id|ntohs
c_func
(paren
id|s-&gt;flags
)paren
op_or
id|IP_VS_CONN_F_HASHED
suffix:semicolon
)brace
multiline_comment|/* Note that we don&squot;t touch its state and flags&n;&t;&t;&t;   if it is a normal entry. */
r_if
c_cond
(paren
id|ntohs
c_func
(paren
id|s-&gt;flags
)paren
op_amp
id|IP_VS_CONN_F_SEQ_MASK
)paren
(brace
id|opt
op_assign
(paren
r_struct
id|ip_vs_sync_conn_options
op_star
)paren
op_amp
id|s
(braket
l_int|1
)braket
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|cp-&gt;in_seq
comma
id|opt
comma
r_sizeof
(paren
op_star
id|opt
)paren
)paren
suffix:semicolon
id|p
op_add_assign
id|FULL_CONN_SIZE
suffix:semicolon
)brace
r_else
id|p
op_add_assign
id|SIMPLE_CONN_SIZE
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|cp-&gt;in_pkts
comma
id|sysctl_ip_vs_sync_threshold
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|cp-&gt;timeout
op_assign
id|IP_VS_SYNC_CONN_TIMEOUT
suffix:semicolon
id|ip_vs_conn_put
c_func
(paren
id|cp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p
OG
id|buffer
op_plus
id|buflen
)paren
(brace
id|IP_VS_ERR
c_func
(paren
l_string|&quot;bogus message&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*&n; *      Setup loopback of outgoing multicasts on a sending socket&n; */
DECL|function|set_mcast_loop
r_static
r_void
id|set_mcast_loop
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
id|u_char
id|loop
)paren
(brace
r_struct
id|inet_sock
op_star
id|inet
op_assign
id|inet_sk
c_func
(paren
id|sk
)paren
suffix:semicolon
multiline_comment|/* setsockopt(sock, SOL_IP, IP_MULTICAST_LOOP, &amp;loop, sizeof(loop)); */
id|lock_sock
c_func
(paren
id|sk
)paren
suffix:semicolon
id|inet-&gt;mc_loop
op_assign
id|loop
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|release_sock
c_func
(paren
id|sk
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *      Specify TTL for outgoing multicasts on a sending socket&n; */
DECL|function|set_mcast_ttl
r_static
r_void
id|set_mcast_ttl
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
id|u_char
id|ttl
)paren
(brace
r_struct
id|inet_sock
op_star
id|inet
op_assign
id|inet_sk
c_func
(paren
id|sk
)paren
suffix:semicolon
multiline_comment|/* setsockopt(sock, SOL_IP, IP_MULTICAST_TTL, &amp;ttl, sizeof(ttl)); */
id|lock_sock
c_func
(paren
id|sk
)paren
suffix:semicolon
id|inet-&gt;mc_ttl
op_assign
id|ttl
suffix:semicolon
id|release_sock
c_func
(paren
id|sk
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *      Specifiy default interface for outgoing multicasts&n; */
DECL|function|set_mcast_if
r_static
r_int
id|set_mcast_if
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_char
op_star
id|ifname
)paren
(brace
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_struct
id|inet_sock
op_star
id|inet
op_assign
id|inet_sk
c_func
(paren
id|sk
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dev
op_assign
id|__dev_get_by_name
c_func
(paren
id|ifname
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;sk_bound_dev_if
op_logical_and
id|dev-&gt;ifindex
op_ne
id|sk-&gt;sk_bound_dev_if
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|lock_sock
c_func
(paren
id|sk
)paren
suffix:semicolon
id|inet-&gt;mc_index
op_assign
id|dev-&gt;ifindex
suffix:semicolon
multiline_comment|/*  inet-&gt;mc_addr  = 0; */
id|release_sock
c_func
(paren
id|sk
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Set the maximum length of sync message according to the&n; *&t;specified interface&squot;s MTU.&n; */
DECL|function|set_sync_mesg_maxlen
r_static
r_int
id|set_sync_mesg_maxlen
c_func
(paren
r_int
id|sync_state
)paren
(brace
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_int
id|num
suffix:semicolon
r_if
c_cond
(paren
id|sync_state
op_eq
id|IP_VS_STATE_MASTER
)paren
(brace
r_if
c_cond
(paren
(paren
id|dev
op_assign
id|__dev_get_by_name
c_func
(paren
id|ip_vs_master_mcast_ifn
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|num
op_assign
(paren
id|dev-&gt;mtu
op_minus
r_sizeof
(paren
r_struct
id|iphdr
)paren
op_minus
r_sizeof
(paren
r_struct
id|udphdr
)paren
op_minus
id|SYNC_MESG_HEADER_LEN
op_minus
l_int|20
)paren
op_div
id|SIMPLE_CONN_SIZE
suffix:semicolon
id|sync_send_mesg_maxlen
op_assign
id|SYNC_MESG_HEADER_LEN
op_plus
id|SIMPLE_CONN_SIZE
op_star
id|num
suffix:semicolon
id|IP_VS_DBG
c_func
(paren
l_int|7
comma
l_string|&quot;setting the maximum length of sync sending &quot;
l_string|&quot;message %d.&bslash;n&quot;
comma
id|sync_send_mesg_maxlen
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|sync_state
op_eq
id|IP_VS_STATE_BACKUP
)paren
(brace
r_if
c_cond
(paren
(paren
id|dev
op_assign
id|__dev_get_by_name
c_func
(paren
id|ip_vs_backup_mcast_ifn
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|sync_recv_mesg_maxlen
op_assign
id|dev-&gt;mtu
op_minus
r_sizeof
(paren
r_struct
id|iphdr
)paren
op_minus
r_sizeof
(paren
r_struct
id|udphdr
)paren
suffix:semicolon
id|IP_VS_DBG
c_func
(paren
l_int|7
comma
l_string|&quot;setting the maximum length of sync receiving &quot;
l_string|&quot;message %d.&bslash;n&quot;
comma
id|sync_recv_mesg_maxlen
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *      Join a multicast group.&n; *      the group is specified by a class D multicast address 224.0.0.0/8&n; *      in the in_addr structure passed in as a parameter.&n; */
r_static
r_int
DECL|function|join_mcast_group
id|join_mcast_group
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_struct
id|in_addr
op_star
id|addr
comma
r_char
op_star
id|ifname
)paren
(brace
r_struct
id|ip_mreqn
id|mreq
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|mreq
comma
l_int|0
comma
r_sizeof
(paren
id|mreq
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|mreq.imr_multiaddr
comma
id|addr
comma
r_sizeof
(paren
r_struct
id|in_addr
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dev
op_assign
id|__dev_get_by_name
c_func
(paren
id|ifname
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;sk_bound_dev_if
op_logical_and
id|dev-&gt;ifindex
op_ne
id|sk-&gt;sk_bound_dev_if
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|mreq.imr_ifindex
op_assign
id|dev-&gt;ifindex
suffix:semicolon
id|lock_sock
c_func
(paren
id|sk
)paren
suffix:semicolon
id|ret
op_assign
id|ip_mc_join_group
c_func
(paren
id|sk
comma
op_amp
id|mreq
)paren
suffix:semicolon
id|release_sock
c_func
(paren
id|sk
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|bind_mcastif_addr
r_static
r_int
id|bind_mcastif_addr
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_char
op_star
id|ifname
)paren
(brace
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
id|u32
id|addr
suffix:semicolon
r_struct
id|sockaddr_in
id|sin
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dev
op_assign
id|__dev_get_by_name
c_func
(paren
id|ifname
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|addr
op_assign
id|inet_select_addr
c_func
(paren
id|dev
comma
l_int|0
comma
id|RT_SCOPE_UNIVERSE
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|addr
)paren
id|IP_VS_ERR
c_func
(paren
l_string|&quot;You probably need to specify IP address on &quot;
l_string|&quot;multicast interface.&bslash;n&quot;
)paren
suffix:semicolon
id|IP_VS_DBG
c_func
(paren
l_int|7
comma
l_string|&quot;binding socket with (%s) %u.%u.%u.%u&bslash;n&quot;
comma
id|ifname
comma
id|NIPQUAD
c_func
(paren
id|addr
)paren
)paren
suffix:semicolon
multiline_comment|/* Now bind the socket with the address of multicast interface */
id|sin.sin_family
op_assign
id|AF_INET
suffix:semicolon
id|sin.sin_addr.s_addr
op_assign
id|addr
suffix:semicolon
id|sin.sin_port
op_assign
l_int|0
suffix:semicolon
r_return
id|sock-&gt;ops
op_member_access_from_pointer
id|bind
c_func
(paren
id|sock
comma
(paren
r_struct
id|sockaddr
op_star
)paren
op_amp
id|sin
comma
r_sizeof
(paren
id|sin
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *      Set up sending multicast socket over UDP&n; */
DECL|function|make_send_sock
r_static
r_struct
id|socket
op_star
id|make_send_sock
c_func
(paren
r_void
)paren
(brace
r_struct
id|socket
op_star
id|sock
suffix:semicolon
multiline_comment|/* First create a socket */
r_if
c_cond
(paren
id|sock_create_kern
c_func
(paren
id|PF_INET
comma
id|SOCK_DGRAM
comma
id|IPPROTO_UDP
comma
op_amp
id|sock
)paren
OL
l_int|0
)paren
(brace
id|IP_VS_ERR
c_func
(paren
l_string|&quot;Error during creation of socket; terminating&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|set_mcast_if
c_func
(paren
id|sock-&gt;sk
comma
id|ip_vs_master_mcast_ifn
)paren
OL
l_int|0
)paren
(brace
id|IP_VS_ERR
c_func
(paren
l_string|&quot;Error setting outbound mcast interface&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
id|set_mcast_loop
c_func
(paren
id|sock-&gt;sk
comma
l_int|0
)paren
suffix:semicolon
id|set_mcast_ttl
c_func
(paren
id|sock-&gt;sk
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bind_mcastif_addr
c_func
(paren
id|sock
comma
id|ip_vs_master_mcast_ifn
)paren
OL
l_int|0
)paren
(brace
id|IP_VS_ERR
c_func
(paren
l_string|&quot;Error binding address of the mcast interface&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sock-&gt;ops
op_member_access_from_pointer
id|connect
c_func
(paren
id|sock
comma
(paren
r_struct
id|sockaddr
op_star
)paren
op_amp
id|mcast_addr
comma
r_sizeof
(paren
r_struct
id|sockaddr
)paren
comma
l_int|0
)paren
OL
l_int|0
)paren
(brace
id|IP_VS_ERR
c_func
(paren
l_string|&quot;Error connecting to the multicast addr&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
r_return
id|sock
suffix:semicolon
id|error
suffix:colon
id|sock_release
c_func
(paren
id|sock
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; *      Set up receiving multicast socket over UDP&n; */
DECL|function|make_receive_sock
r_static
r_struct
id|socket
op_star
id|make_receive_sock
c_func
(paren
r_void
)paren
(brace
r_struct
id|socket
op_star
id|sock
suffix:semicolon
multiline_comment|/* First create a socket */
r_if
c_cond
(paren
id|sock_create_kern
c_func
(paren
id|PF_INET
comma
id|SOCK_DGRAM
comma
id|IPPROTO_UDP
comma
op_amp
id|sock
)paren
OL
l_int|0
)paren
(brace
id|IP_VS_ERR
c_func
(paren
l_string|&quot;Error during creation of socket; terminating&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* it is equivalent to the REUSEADDR option in user-space */
id|sock-&gt;sk-&gt;sk_reuse
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|sock-&gt;ops
op_member_access_from_pointer
id|bind
c_func
(paren
id|sock
comma
(paren
r_struct
id|sockaddr
op_star
)paren
op_amp
id|mcast_addr
comma
r_sizeof
(paren
r_struct
id|sockaddr
)paren
)paren
OL
l_int|0
)paren
(brace
id|IP_VS_ERR
c_func
(paren
l_string|&quot;Error binding to the multicast addr&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
multiline_comment|/* join the multicast group */
r_if
c_cond
(paren
id|join_mcast_group
c_func
(paren
id|sock-&gt;sk
comma
(paren
r_struct
id|in_addr
op_star
)paren
op_amp
id|mcast_addr.sin_addr
comma
id|ip_vs_backup_mcast_ifn
)paren
OL
l_int|0
)paren
(brace
id|IP_VS_ERR
c_func
(paren
l_string|&quot;Error joining to the multicast group&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
r_return
id|sock
suffix:semicolon
id|error
suffix:colon
id|sock_release
c_func
(paren
id|sock
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_static
r_int
DECL|function|ip_vs_send_async
id|ip_vs_send_async
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_const
r_char
op_star
id|buffer
comma
r_const
r_int
id|length
)paren
(brace
r_struct
id|msghdr
id|msg
op_assign
(brace
dot
id|msg_flags
op_assign
id|MSG_DONTWAIT
op_or
id|MSG_NOSIGNAL
)brace
suffix:semicolon
r_struct
id|kvec
id|iov
suffix:semicolon
r_int
id|len
suffix:semicolon
id|EnterFunction
c_func
(paren
l_int|7
)paren
suffix:semicolon
id|iov.iov_base
op_assign
(paren
r_void
op_star
)paren
id|buffer
suffix:semicolon
id|iov.iov_len
op_assign
id|length
suffix:semicolon
id|len
op_assign
id|kernel_sendmsg
c_func
(paren
id|sock
comma
op_amp
id|msg
comma
op_amp
id|iov
comma
l_int|1
comma
(paren
r_int
)paren
(paren
id|length
)paren
)paren
suffix:semicolon
id|LeaveFunction
c_func
(paren
l_int|7
)paren
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
r_static
r_void
DECL|function|ip_vs_send_sync_msg
id|ip_vs_send_sync_msg
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_struct
id|ip_vs_sync_mesg
op_star
id|msg
)paren
(brace
r_int
id|msize
suffix:semicolon
id|msize
op_assign
id|msg-&gt;size
suffix:semicolon
multiline_comment|/* Put size in network byte order */
id|msg-&gt;size
op_assign
id|htons
c_func
(paren
id|msg-&gt;size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ip_vs_send_async
c_func
(paren
id|sock
comma
(paren
r_char
op_star
)paren
id|msg
comma
id|msize
)paren
op_ne
id|msize
)paren
id|IP_VS_ERR
c_func
(paren
l_string|&quot;ip_vs_send_async error&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|ip_vs_receive
id|ip_vs_receive
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_char
op_star
id|buffer
comma
r_const
r_int
id|buflen
)paren
(brace
r_struct
id|msghdr
id|msg
op_assign
(brace
l_int|NULL
comma
)brace
suffix:semicolon
r_struct
id|kvec
id|iov
suffix:semicolon
r_int
id|len
suffix:semicolon
id|EnterFunction
c_func
(paren
l_int|7
)paren
suffix:semicolon
multiline_comment|/* Receive a packet */
id|iov.iov_base
op_assign
id|buffer
suffix:semicolon
id|iov.iov_len
op_assign
(paren
r_int
)paren
id|buflen
suffix:semicolon
id|len
op_assign
id|kernel_recvmsg
c_func
(paren
id|sock
comma
op_amp
id|msg
comma
op_amp
id|iov
comma
l_int|1
comma
id|buflen
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
l_int|0
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|LeaveFunction
c_func
(paren
l_int|7
)paren
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
r_static
id|DECLARE_WAIT_QUEUE_HEAD
c_func
(paren
id|sync_wait
)paren
suffix:semicolon
DECL|variable|sync_master_pid
r_static
id|pid_t
id|sync_master_pid
op_assign
l_int|0
suffix:semicolon
DECL|variable|sync_backup_pid
r_static
id|pid_t
id|sync_backup_pid
op_assign
l_int|0
suffix:semicolon
r_static
id|DECLARE_WAIT_QUEUE_HEAD
c_func
(paren
id|stop_sync_wait
)paren
suffix:semicolon
DECL|variable|stop_master_sync
r_static
r_int
id|stop_master_sync
op_assign
l_int|0
suffix:semicolon
DECL|variable|stop_backup_sync
r_static
r_int
id|stop_backup_sync
op_assign
l_int|0
suffix:semicolon
DECL|function|sync_master_loop
r_static
r_void
id|sync_master_loop
c_func
(paren
r_void
)paren
(brace
r_struct
id|socket
op_star
id|sock
suffix:semicolon
r_struct
id|ip_vs_sync_buff
op_star
id|sb
suffix:semicolon
multiline_comment|/* create the sending multicast socket */
id|sock
op_assign
id|make_send_sock
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sock
)paren
r_return
suffix:semicolon
id|IP_VS_INFO
c_func
(paren
l_string|&quot;sync thread started: state = MASTER, mcast_ifn = %s, &quot;
l_string|&quot;syncid = %d&bslash;n&quot;
comma
id|ip_vs_master_mcast_ifn
comma
id|ip_vs_master_syncid
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
r_while
c_loop
(paren
(paren
id|sb
op_assign
id|sb_dequeue
c_func
(paren
)paren
)paren
)paren
(brace
id|ip_vs_send_sync_msg
c_func
(paren
id|sock
comma
id|sb-&gt;mesg
)paren
suffix:semicolon
id|ip_vs_sync_buff_release
c_func
(paren
id|sb
)paren
suffix:semicolon
)brace
multiline_comment|/* check if entries stay in curr_sb for 2 seconds */
r_if
c_cond
(paren
(paren
id|sb
op_assign
id|get_curr_sync_buff
c_func
(paren
l_int|2
op_star
id|HZ
)paren
)paren
)paren
(brace
id|ip_vs_send_sync_msg
c_func
(paren
id|sock
comma
id|sb-&gt;mesg
)paren
suffix:semicolon
id|ip_vs_sync_buff_release
c_func
(paren
id|sb
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|stop_master_sync
)paren
r_break
suffix:semicolon
id|__set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|HZ
)paren
suffix:semicolon
)brace
multiline_comment|/* clean up the sync_buff queue */
r_while
c_loop
(paren
(paren
id|sb
op_assign
id|sb_dequeue
c_func
(paren
)paren
)paren
)paren
(brace
id|ip_vs_sync_buff_release
c_func
(paren
id|sb
)paren
suffix:semicolon
)brace
multiline_comment|/* clean up the current sync_buff */
r_if
c_cond
(paren
(paren
id|sb
op_assign
id|get_curr_sync_buff
c_func
(paren
l_int|0
)paren
)paren
)paren
(brace
id|ip_vs_sync_buff_release
c_func
(paren
id|sb
)paren
suffix:semicolon
)brace
multiline_comment|/* release the sending multicast socket */
id|sock_release
c_func
(paren
id|sock
)paren
suffix:semicolon
)brace
DECL|function|sync_backup_loop
r_static
r_void
id|sync_backup_loop
c_func
(paren
r_void
)paren
(brace
r_struct
id|socket
op_star
id|sock
suffix:semicolon
r_char
op_star
id|buf
suffix:semicolon
r_int
id|len
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|buf
op_assign
id|kmalloc
c_func
(paren
id|sync_recv_mesg_maxlen
comma
id|GFP_ATOMIC
)paren
)paren
)paren
(brace
id|IP_VS_ERR
c_func
(paren
l_string|&quot;sync_backup_loop: kmalloc error&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* create the receiving multicast socket */
id|sock
op_assign
id|make_receive_sock
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sock
)paren
r_goto
id|out
suffix:semicolon
id|IP_VS_INFO
c_func
(paren
l_string|&quot;sync thread started: state = BACKUP, mcast_ifn = %s, &quot;
l_string|&quot;syncid = %d&bslash;n&quot;
comma
id|ip_vs_backup_mcast_ifn
comma
id|ip_vs_backup_syncid
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
multiline_comment|/* do you have data now? */
r_while
c_loop
(paren
op_logical_neg
id|skb_queue_empty
c_func
(paren
op_amp
(paren
id|sock-&gt;sk-&gt;sk_receive_queue
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|len
op_assign
id|ip_vs_receive
c_func
(paren
id|sock
comma
id|buf
comma
id|sync_recv_mesg_maxlen
)paren
)paren
op_le
l_int|0
)paren
(brace
id|IP_VS_ERR
c_func
(paren
l_string|&quot;receiving message error&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* disable bottom half, because it accessed the data&n;&t;&t;&t;   shared by softirq while getting/creating conns */
id|local_bh_disable
c_func
(paren
)paren
suffix:semicolon
id|ip_vs_process_message
c_func
(paren
id|buf
comma
id|len
)paren
suffix:semicolon
id|local_bh_enable
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|stop_backup_sync
)paren
r_break
suffix:semicolon
id|__set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|HZ
)paren
suffix:semicolon
)brace
multiline_comment|/* release the sending multicast socket */
id|sock_release
c_func
(paren
id|sock
)paren
suffix:semicolon
id|out
suffix:colon
id|kfree
c_func
(paren
id|buf
)paren
suffix:semicolon
)brace
DECL|function|set_sync_pid
r_static
r_void
id|set_sync_pid
c_func
(paren
r_int
id|sync_state
comma
id|pid_t
id|sync_pid
)paren
(brace
r_if
c_cond
(paren
id|sync_state
op_eq
id|IP_VS_STATE_MASTER
)paren
id|sync_master_pid
op_assign
id|sync_pid
suffix:semicolon
r_else
r_if
c_cond
(paren
id|sync_state
op_eq
id|IP_VS_STATE_BACKUP
)paren
id|sync_backup_pid
op_assign
id|sync_pid
suffix:semicolon
)brace
DECL|function|set_stop_sync
r_static
r_void
id|set_stop_sync
c_func
(paren
r_int
id|sync_state
comma
r_int
id|set
)paren
(brace
r_if
c_cond
(paren
id|sync_state
op_eq
id|IP_VS_STATE_MASTER
)paren
id|stop_master_sync
op_assign
id|set
suffix:semicolon
r_else
r_if
c_cond
(paren
id|sync_state
op_eq
id|IP_VS_STATE_BACKUP
)paren
id|stop_backup_sync
op_assign
id|set
suffix:semicolon
r_else
(brace
id|stop_master_sync
op_assign
id|set
suffix:semicolon
id|stop_backup_sync
op_assign
id|set
suffix:semicolon
)brace
)brace
DECL|function|sync_thread
r_static
r_int
id|sync_thread
c_func
(paren
r_void
op_star
id|startup
)paren
(brace
id|DECLARE_WAITQUEUE
c_func
(paren
id|wait
comma
id|current
)paren
suffix:semicolon
id|mm_segment_t
id|oldmm
suffix:semicolon
r_int
id|state
suffix:semicolon
r_const
r_char
op_star
id|name
suffix:semicolon
multiline_comment|/* increase the module use count */
id|ip_vs_use_count_inc
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ip_vs_sync_state
op_amp
id|IP_VS_STATE_MASTER
op_logical_and
op_logical_neg
id|sync_master_pid
)paren
(brace
id|state
op_assign
id|IP_VS_STATE_MASTER
suffix:semicolon
id|name
op_assign
l_string|&quot;ipvs_syncmaster&quot;
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ip_vs_sync_state
op_amp
id|IP_VS_STATE_BACKUP
op_logical_and
op_logical_neg
id|sync_backup_pid
)paren
(brace
id|state
op_assign
id|IP_VS_STATE_BACKUP
suffix:semicolon
id|name
op_assign
l_string|&quot;ipvs_syncbackup&quot;
suffix:semicolon
)brace
r_else
(brace
id|IP_VS_BUG
c_func
(paren
)paren
suffix:semicolon
id|ip_vs_use_count_dec
c_func
(paren
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|daemonize
c_func
(paren
id|name
)paren
suffix:semicolon
id|oldmm
op_assign
id|get_fs
c_func
(paren
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|KERNEL_DS
)paren
suffix:semicolon
multiline_comment|/* Block all signals */
id|spin_lock_irq
c_func
(paren
op_amp
id|current-&gt;sighand-&gt;siglock
)paren
suffix:semicolon
id|siginitsetinv
c_func
(paren
op_amp
id|current-&gt;blocked
comma
l_int|0
)paren
suffix:semicolon
id|recalc_sigpending
c_func
(paren
)paren
suffix:semicolon
id|spin_unlock_irq
c_func
(paren
op_amp
id|current-&gt;sighand-&gt;siglock
)paren
suffix:semicolon
multiline_comment|/* set the maximum length of sync message */
id|set_sync_mesg_maxlen
c_func
(paren
id|state
)paren
suffix:semicolon
multiline_comment|/* set up multicast address */
id|mcast_addr.sin_family
op_assign
id|AF_INET
suffix:semicolon
id|mcast_addr.sin_port
op_assign
id|htons
c_func
(paren
id|IP_VS_SYNC_PORT
)paren
suffix:semicolon
id|mcast_addr.sin_addr.s_addr
op_assign
id|htonl
c_func
(paren
id|IP_VS_SYNC_GROUP
)paren
suffix:semicolon
id|add_wait_queue
c_func
(paren
op_amp
id|sync_wait
comma
op_amp
id|wait
)paren
suffix:semicolon
id|set_sync_pid
c_func
(paren
id|state
comma
id|current-&gt;pid
)paren
suffix:semicolon
id|complete
c_func
(paren
(paren
r_struct
id|completion
op_star
)paren
id|startup
)paren
suffix:semicolon
multiline_comment|/* processing master/backup loop here */
r_if
c_cond
(paren
id|state
op_eq
id|IP_VS_STATE_MASTER
)paren
id|sync_master_loop
c_func
(paren
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|state
op_eq
id|IP_VS_STATE_BACKUP
)paren
id|sync_backup_loop
c_func
(paren
)paren
suffix:semicolon
r_else
id|IP_VS_BUG
c_func
(paren
)paren
suffix:semicolon
id|remove_wait_queue
c_func
(paren
op_amp
id|sync_wait
comma
op_amp
id|wait
)paren
suffix:semicolon
multiline_comment|/* thread exits */
id|set_sync_pid
c_func
(paren
id|state
comma
l_int|0
)paren
suffix:semicolon
id|IP_VS_INFO
c_func
(paren
l_string|&quot;sync thread stopped!&bslash;n&quot;
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|oldmm
)paren
suffix:semicolon
multiline_comment|/* decrease the module use count */
id|ip_vs_use_count_dec
c_func
(paren
)paren
suffix:semicolon
id|set_stop_sync
c_func
(paren
id|state
comma
l_int|0
)paren
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|stop_sync_wait
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|fork_sync_thread
r_static
r_int
id|fork_sync_thread
c_func
(paren
r_void
op_star
id|startup
)paren
(brace
id|pid_t
id|pid
suffix:semicolon
multiline_comment|/* fork the sync thread here, then the parent process of the&n;&t;   sync thread is the init process after this thread exits. */
id|repeat
suffix:colon
r_if
c_cond
(paren
(paren
id|pid
op_assign
id|kernel_thread
c_func
(paren
id|sync_thread
comma
id|startup
comma
l_int|0
)paren
)paren
OL
l_int|0
)paren
(brace
id|IP_VS_ERR
c_func
(paren
l_string|&quot;could not create sync_thread due to %d... &quot;
l_string|&quot;retrying.&bslash;n&quot;
comma
id|pid
)paren
suffix:semicolon
id|current-&gt;state
op_assign
id|TASK_UNINTERRUPTIBLE
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|HZ
)paren
suffix:semicolon
r_goto
id|repeat
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|start_sync_thread
r_int
id|start_sync_thread
c_func
(paren
r_int
id|state
comma
r_char
op_star
id|mcast_ifn
comma
id|__u8
id|syncid
)paren
(brace
id|DECLARE_COMPLETION
c_func
(paren
id|startup
)paren
suffix:semicolon
id|pid_t
id|pid
suffix:semicolon
r_if
c_cond
(paren
(paren
id|state
op_eq
id|IP_VS_STATE_MASTER
op_logical_and
id|sync_master_pid
)paren
op_logical_or
(paren
id|state
op_eq
id|IP_VS_STATE_BACKUP
op_logical_and
id|sync_backup_pid
)paren
)paren
r_return
op_minus
id|EEXIST
suffix:semicolon
id|IP_VS_DBG
c_func
(paren
l_int|7
comma
l_string|&quot;%s: pid %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|current-&gt;pid
)paren
suffix:semicolon
id|IP_VS_DBG
c_func
(paren
l_int|7
comma
l_string|&quot;Each ip_vs_sync_conn entry need %Zd bytes&bslash;n&quot;
comma
r_sizeof
(paren
r_struct
id|ip_vs_sync_conn
)paren
)paren
suffix:semicolon
id|ip_vs_sync_state
op_or_assign
id|state
suffix:semicolon
r_if
c_cond
(paren
id|state
op_eq
id|IP_VS_STATE_MASTER
)paren
(brace
id|strcpy
c_func
(paren
id|ip_vs_master_mcast_ifn
comma
id|mcast_ifn
)paren
suffix:semicolon
id|ip_vs_master_syncid
op_assign
id|syncid
suffix:semicolon
)brace
r_else
(brace
id|strcpy
c_func
(paren
id|ip_vs_backup_mcast_ifn
comma
id|mcast_ifn
)paren
suffix:semicolon
id|ip_vs_backup_syncid
op_assign
id|syncid
suffix:semicolon
)brace
id|repeat
suffix:colon
r_if
c_cond
(paren
(paren
id|pid
op_assign
id|kernel_thread
c_func
(paren
id|fork_sync_thread
comma
op_amp
id|startup
comma
l_int|0
)paren
)paren
OL
l_int|0
)paren
(brace
id|IP_VS_ERR
c_func
(paren
l_string|&quot;could not create fork_sync_thread due to %d... &quot;
l_string|&quot;retrying.&bslash;n&quot;
comma
id|pid
)paren
suffix:semicolon
id|current-&gt;state
op_assign
id|TASK_UNINTERRUPTIBLE
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|HZ
)paren
suffix:semicolon
r_goto
id|repeat
suffix:semicolon
)brace
id|wait_for_completion
c_func
(paren
op_amp
id|startup
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|stop_sync_thread
r_int
id|stop_sync_thread
c_func
(paren
r_int
id|state
)paren
(brace
id|DECLARE_WAITQUEUE
c_func
(paren
id|wait
comma
id|current
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|state
op_eq
id|IP_VS_STATE_MASTER
op_logical_and
op_logical_neg
id|sync_master_pid
)paren
op_logical_or
(paren
id|state
op_eq
id|IP_VS_STATE_BACKUP
op_logical_and
op_logical_neg
id|sync_backup_pid
)paren
)paren
r_return
op_minus
id|ESRCH
suffix:semicolon
id|IP_VS_DBG
c_func
(paren
l_int|7
comma
l_string|&quot;%s: pid %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|current-&gt;pid
)paren
suffix:semicolon
id|IP_VS_INFO
c_func
(paren
l_string|&quot;stopping sync thread %d ...&bslash;n&quot;
comma
(paren
id|state
op_eq
id|IP_VS_STATE_MASTER
)paren
ques
c_cond
id|sync_master_pid
suffix:colon
id|sync_backup_pid
)paren
suffix:semicolon
id|__set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|add_wait_queue
c_func
(paren
op_amp
id|stop_sync_wait
comma
op_amp
id|wait
)paren
suffix:semicolon
id|set_stop_sync
c_func
(paren
id|state
comma
l_int|1
)paren
suffix:semicolon
id|ip_vs_sync_state
op_sub_assign
id|state
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|sync_wait
)paren
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
id|__set_current_state
c_func
(paren
id|TASK_RUNNING
)paren
suffix:semicolon
id|remove_wait_queue
c_func
(paren
op_amp
id|stop_sync_wait
comma
op_amp
id|wait
)paren
suffix:semicolon
multiline_comment|/* Note: no need to reap the sync thread, because its parent&n;&t;   process is the init process */
r_if
c_cond
(paren
(paren
id|state
op_eq
id|IP_VS_STATE_MASTER
op_logical_and
id|stop_master_sync
)paren
op_logical_or
(paren
id|state
op_eq
id|IP_VS_STATE_BACKUP
op_logical_and
id|stop_backup_sync
)paren
)paren
id|IP_VS_BUG
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
eof
