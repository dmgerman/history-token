multiline_comment|/*&n; * ip_vs_app.c: Application module support for IPVS&n; *&n; * Version:     $Id: ip_vs_app.c,v 1.17 2003/03/22 06:31:21 wensong Exp $&n; *&n; * Authors:     Wensong Zhang &lt;wensong@linuxvirtualserver.org&gt;&n; *&n; *              This program is free software; you can redistribute it and/or&n; *              modify it under the terms of the GNU General Public License&n; *              as published by the Free Software Foundation; either version&n; *              2 of the License, or (at your option) any later version.&n; *&n; * Most code here is taken from ip_masq_app.c in kernel 2.2. The difference&n; * is that ip_vs_app module handles the reverse direction (incoming requests&n; * and outgoing responses).&n; *&n; *&t;&t;IP_MASQ_APP application masquerading module&n; *&n; * Author:&t;Juan Jose Ciarlante, &lt;jjciarla@raiz.uncu.edu.ar&gt;&n; *&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/ip.h&gt;
macro_line|#include &lt;net/protocol.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/seq_file.h&gt;
macro_line|#include &lt;net/ip_vs.h&gt;
DECL|variable|register_ip_vs_app
id|EXPORT_SYMBOL
c_func
(paren
id|register_ip_vs_app
)paren
suffix:semicolon
DECL|variable|unregister_ip_vs_app
id|EXPORT_SYMBOL
c_func
(paren
id|unregister_ip_vs_app
)paren
suffix:semicolon
DECL|variable|register_ip_vs_app_inc
id|EXPORT_SYMBOL
c_func
(paren
id|register_ip_vs_app_inc
)paren
suffix:semicolon
multiline_comment|/* ipvs application list head */
r_static
id|LIST_HEAD
c_func
(paren
id|ip_vs_app_list
)paren
suffix:semicolon
r_static
id|DECLARE_MUTEX
c_func
(paren
id|__ip_vs_app_mutex
)paren
suffix:semicolon
multiline_comment|/*&n; *&t;Get an ip_vs_app object&n; */
DECL|function|ip_vs_app_get
r_static
r_inline
r_int
id|ip_vs_app_get
c_func
(paren
r_struct
id|ip_vs_app
op_star
id|app
)paren
(brace
multiline_comment|/* test and get the module atomically */
r_if
c_cond
(paren
id|app-&gt;module
)paren
r_return
id|try_module_get
c_func
(paren
id|app-&gt;module
)paren
suffix:semicolon
r_else
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|ip_vs_app_put
r_static
r_inline
r_void
id|ip_vs_app_put
c_func
(paren
r_struct
id|ip_vs_app
op_star
id|app
)paren
(brace
r_if
c_cond
(paren
id|app-&gt;module
)paren
id|module_put
c_func
(paren
id|app-&gt;module
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Allocate/initialize app incarnation and register it in proto apps.&n; */
r_static
r_int
DECL|function|ip_vs_app_inc_new
id|ip_vs_app_inc_new
c_func
(paren
r_struct
id|ip_vs_app
op_star
id|app
comma
id|__u16
id|proto
comma
id|__u16
id|port
)paren
(brace
r_struct
id|ip_vs_protocol
op_star
id|pp
suffix:semicolon
r_struct
id|ip_vs_app
op_star
id|inc
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|pp
op_assign
id|ip_vs_proto_get
c_func
(paren
id|proto
)paren
)paren
)paren
r_return
op_minus
id|EPROTONOSUPPORT
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pp-&gt;unregister_app
)paren
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
id|inc
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|ip_vs_app
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|inc
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memcpy
c_func
(paren
id|inc
comma
id|app
comma
r_sizeof
(paren
op_star
id|inc
)paren
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|inc-&gt;p_list
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|inc-&gt;incs_list
)paren
suffix:semicolon
id|inc-&gt;app
op_assign
id|app
suffix:semicolon
id|inc-&gt;port
op_assign
id|htons
c_func
(paren
id|port
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|inc-&gt;usecnt
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|app-&gt;timeouts
)paren
(brace
id|inc-&gt;timeout_table
op_assign
id|ip_vs_create_timeout_table
c_func
(paren
id|app-&gt;timeouts
comma
id|app-&gt;timeouts_size
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|inc-&gt;timeout_table
)paren
(brace
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
id|ret
op_assign
id|pp
op_member_access_from_pointer
id|register_app
c_func
(paren
id|inc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_goto
id|out
suffix:semicolon
id|list_add
c_func
(paren
op_amp
id|inc-&gt;a_list
comma
op_amp
id|app-&gt;incs_list
)paren
suffix:semicolon
id|IP_VS_DBG
c_func
(paren
l_int|9
comma
l_string|&quot;%s application %s:%u registered&bslash;n&quot;
comma
id|pp-&gt;name
comma
id|inc-&gt;name
comma
id|inc-&gt;port
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|out
suffix:colon
r_if
c_cond
(paren
id|inc-&gt;timeout_table
)paren
id|kfree
c_func
(paren
id|inc-&gt;timeout_table
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|inc
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Release app incarnation&n; */
r_static
r_void
DECL|function|ip_vs_app_inc_release
id|ip_vs_app_inc_release
c_func
(paren
r_struct
id|ip_vs_app
op_star
id|inc
)paren
(brace
r_struct
id|ip_vs_protocol
op_star
id|pp
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|pp
op_assign
id|ip_vs_proto_get
c_func
(paren
id|inc-&gt;protocol
)paren
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|pp-&gt;unregister_app
)paren
id|pp
op_member_access_from_pointer
id|unregister_app
c_func
(paren
id|inc
)paren
suffix:semicolon
id|IP_VS_DBG
c_func
(paren
l_int|9
comma
l_string|&quot;%s App %s:%u unregistered&bslash;n&quot;
comma
id|pp-&gt;name
comma
id|inc-&gt;name
comma
id|inc-&gt;port
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|inc-&gt;a_list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inc-&gt;timeout_table
op_ne
l_int|NULL
)paren
id|kfree
c_func
(paren
id|inc-&gt;timeout_table
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|inc
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Get reference to app inc (only called from softirq)&n; *&n; */
DECL|function|ip_vs_app_inc_get
r_int
id|ip_vs_app_inc_get
c_func
(paren
r_struct
id|ip_vs_app
op_star
id|inc
)paren
(brace
r_int
id|result
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|inc-&gt;usecnt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
(paren
id|result
op_assign
id|ip_vs_app_get
c_func
(paren
id|inc-&gt;app
)paren
)paren
op_ne
l_int|1
)paren
)paren
id|atomic_dec
c_func
(paren
op_amp
id|inc-&gt;usecnt
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Put the app inc (only called from timer or net softirq)&n; */
DECL|function|ip_vs_app_inc_put
r_void
id|ip_vs_app_inc_put
c_func
(paren
r_struct
id|ip_vs_app
op_star
id|inc
)paren
(brace
id|ip_vs_app_put
c_func
(paren
id|inc-&gt;app
)paren
suffix:semicolon
id|atomic_dec
c_func
(paren
op_amp
id|inc-&gt;usecnt
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Register an application incarnation in protocol applications&n; */
r_int
DECL|function|register_ip_vs_app_inc
id|register_ip_vs_app_inc
c_func
(paren
r_struct
id|ip_vs_app
op_star
id|app
comma
id|__u16
id|proto
comma
id|__u16
id|port
)paren
(brace
r_int
id|result
suffix:semicolon
id|down
c_func
(paren
op_amp
id|__ip_vs_app_mutex
)paren
suffix:semicolon
id|result
op_assign
id|ip_vs_app_inc_new
c_func
(paren
id|app
comma
id|proto
comma
id|port
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|__ip_vs_app_mutex
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;ip_vs_app registration routine&n; */
DECL|function|register_ip_vs_app
r_int
id|register_ip_vs_app
c_func
(paren
r_struct
id|ip_vs_app
op_star
id|app
)paren
(brace
multiline_comment|/* increase the module use count */
id|ip_vs_use_count_inc
c_func
(paren
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|__ip_vs_app_mutex
)paren
suffix:semicolon
id|list_add
c_func
(paren
op_amp
id|app-&gt;a_list
comma
op_amp
id|ip_vs_app_list
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|__ip_vs_app_mutex
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;ip_vs_app unregistration routine&n; *&t;We are sure there are no app incarnations attached to services&n; */
DECL|function|unregister_ip_vs_app
r_void
id|unregister_ip_vs_app
c_func
(paren
r_struct
id|ip_vs_app
op_star
id|app
)paren
(brace
r_struct
id|ip_vs_app
op_star
id|inc
comma
op_star
id|nxt
suffix:semicolon
id|down
c_func
(paren
op_amp
id|__ip_vs_app_mutex
)paren
suffix:semicolon
id|list_for_each_entry_safe
c_func
(paren
id|inc
comma
id|nxt
comma
op_amp
id|app-&gt;incs_list
comma
id|a_list
)paren
(brace
id|ip_vs_app_inc_release
c_func
(paren
id|inc
)paren
suffix:semicolon
)brace
id|list_del
c_func
(paren
op_amp
id|app-&gt;a_list
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|__ip_vs_app_mutex
)paren
suffix:semicolon
multiline_comment|/* decrease the module use count */
id|ip_vs_use_count_dec
c_func
(paren
)paren
suffix:semicolon
)brace
macro_line|#if 0000
multiline_comment|/*&n; *&t;Get reference to app by name (called from user context)&n; */
r_struct
id|ip_vs_app
op_star
id|ip_vs_app_get_by_name
c_func
(paren
r_char
op_star
id|appname
)paren
(brace
r_struct
id|ip_vs_app
op_star
id|app
comma
op_star
id|a
op_assign
l_int|NULL
suffix:semicolon
id|down
c_func
(paren
op_amp
id|__ip_vs_app_mutex
)paren
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|ent
comma
op_amp
id|ip_vs_app_list
comma
id|a_list
)paren
(brace
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|app-&gt;name
comma
id|appname
)paren
)paren
r_continue
suffix:semicolon
multiline_comment|/* softirq may call ip_vs_app_get too, so the caller&n;&t;&t;   must disable softirq on the current CPU */
r_if
c_cond
(paren
id|ip_vs_app_get
c_func
(paren
id|app
)paren
)paren
id|a
op_assign
id|app
suffix:semicolon
r_break
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|__ip_vs_app_mutex
)paren
suffix:semicolon
r_return
id|a
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n; *&t;Bind ip_vs_conn to its ip_vs_app (called by cp constructor)&n; */
DECL|function|ip_vs_bind_app
r_int
id|ip_vs_bind_app
c_func
(paren
r_struct
id|ip_vs_conn
op_star
id|cp
comma
r_struct
id|ip_vs_protocol
op_star
id|pp
)paren
(brace
r_return
id|pp
op_member_access_from_pointer
id|app_conn_bind
c_func
(paren
id|cp
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Unbind cp from application incarnation (called by cp destructor)&n; */
DECL|function|ip_vs_unbind_app
r_void
id|ip_vs_unbind_app
c_func
(paren
r_struct
id|ip_vs_conn
op_star
id|cp
)paren
(brace
r_struct
id|ip_vs_app
op_star
id|inc
op_assign
id|cp-&gt;app
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|inc
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|inc-&gt;unbind_conn
)paren
id|inc
op_member_access_from_pointer
id|unbind_conn
c_func
(paren
id|inc
comma
id|cp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inc-&gt;done_conn
)paren
id|inc
op_member_access_from_pointer
id|done_conn
c_func
(paren
id|inc
comma
id|cp
)paren
suffix:semicolon
id|ip_vs_app_inc_put
c_func
(paren
id|inc
)paren
suffix:semicolon
id|cp-&gt;app
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Fixes th-&gt;seq based on ip_vs_seq info.&n; */
DECL|function|vs_fix_seq
r_static
r_inline
r_void
id|vs_fix_seq
c_func
(paren
r_const
r_struct
id|ip_vs_seq
op_star
id|vseq
comma
r_struct
id|tcphdr
op_star
id|th
)paren
(brace
id|__u32
id|seq
op_assign
id|ntohl
c_func
(paren
id|th-&gt;seq
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Adjust seq with delta-offset for all packets after&n;&t; *&t;the most recent resized pkt seq and with previous_delta offset&n;&t; *&t;for all packets&t;before most recent resized pkt seq.&n;&t; */
r_if
c_cond
(paren
id|vseq-&gt;delta
op_logical_or
id|vseq-&gt;previous_delta
)paren
(brace
r_if
c_cond
(paren
id|after
c_func
(paren
id|seq
comma
id|vseq-&gt;init_seq
)paren
)paren
(brace
id|th-&gt;seq
op_assign
id|htonl
c_func
(paren
id|seq
op_plus
id|vseq-&gt;delta
)paren
suffix:semicolon
id|IP_VS_DBG
c_func
(paren
l_int|9
comma
l_string|&quot;vs_fix_seq(): added delta (%d) to seq&bslash;n&quot;
comma
id|vseq-&gt;delta
)paren
suffix:semicolon
)brace
r_else
(brace
id|th-&gt;seq
op_assign
id|htonl
c_func
(paren
id|seq
op_plus
id|vseq-&gt;previous_delta
)paren
suffix:semicolon
id|IP_VS_DBG
c_func
(paren
l_int|9
comma
l_string|&quot;vs_fix_seq(): added previous_delta &quot;
l_string|&quot;(%d) to seq&bslash;n&quot;
comma
id|vseq-&gt;previous_delta
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*&n; *&t;Fixes th-&gt;ack_seq based on ip_vs_seq info.&n; */
r_static
r_inline
r_void
DECL|function|vs_fix_ack_seq
id|vs_fix_ack_seq
c_func
(paren
r_const
r_struct
id|ip_vs_seq
op_star
id|vseq
comma
r_struct
id|tcphdr
op_star
id|th
)paren
(brace
id|__u32
id|ack_seq
op_assign
id|ntohl
c_func
(paren
id|th-&gt;ack_seq
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Adjust ack_seq with delta-offset for&n;&t; * the packets AFTER most recent resized pkt has caused a shift&n;&t; * for packets before most recent resized pkt, use previous_delta&n;&t; */
r_if
c_cond
(paren
id|vseq-&gt;delta
op_logical_or
id|vseq-&gt;previous_delta
)paren
(brace
multiline_comment|/* since ack_seq is the number of octet that is expected&n;&t;&t;   to receive next, so compare it with init_seq+delta */
r_if
c_cond
(paren
id|after
c_func
(paren
id|ack_seq
comma
id|vseq-&gt;init_seq
op_plus
id|vseq-&gt;delta
)paren
)paren
(brace
id|th-&gt;ack_seq
op_assign
id|htonl
c_func
(paren
id|ack_seq
op_minus
id|vseq-&gt;delta
)paren
suffix:semicolon
id|IP_VS_DBG
c_func
(paren
l_int|9
comma
l_string|&quot;vs_fix_ack_seq(): subtracted delta &quot;
l_string|&quot;(%d) from ack_seq&bslash;n&quot;
comma
id|vseq-&gt;delta
)paren
suffix:semicolon
)brace
r_else
(brace
id|th-&gt;ack_seq
op_assign
id|htonl
c_func
(paren
id|ack_seq
op_minus
id|vseq-&gt;previous_delta
)paren
suffix:semicolon
id|IP_VS_DBG
c_func
(paren
l_int|9
comma
l_string|&quot;vs_fix_ack_seq(): subtracted &quot;
l_string|&quot;previous_delta (%d) from ack_seq&bslash;n&quot;
comma
id|vseq-&gt;previous_delta
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*&n; *&t;Updates ip_vs_seq if pkt has been resized&n; *&t;Assumes already checked proto==IPPROTO_TCP and diff!=0.&n; */
DECL|function|vs_seq_update
r_static
r_inline
r_void
id|vs_seq_update
c_func
(paren
r_struct
id|ip_vs_conn
op_star
id|cp
comma
r_struct
id|ip_vs_seq
op_star
id|vseq
comma
r_int
id|flag
comma
id|__u32
id|seq
comma
r_int
id|diff
)paren
(brace
multiline_comment|/* spinlock is to keep updating cp-&gt;flags atomic */
id|spin_lock
c_func
(paren
op_amp
id|cp-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|cp-&gt;flags
op_amp
id|flag
)paren
op_logical_or
id|after
c_func
(paren
id|seq
comma
id|vseq-&gt;init_seq
)paren
)paren
(brace
id|vseq-&gt;previous_delta
op_assign
id|vseq-&gt;delta
suffix:semicolon
id|vseq-&gt;delta
op_add_assign
id|diff
suffix:semicolon
id|vseq-&gt;init_seq
op_assign
id|seq
suffix:semicolon
id|cp-&gt;flags
op_or_assign
id|flag
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|cp-&gt;lock
)paren
suffix:semicolon
)brace
DECL|function|app_tcp_pkt_out
r_static
r_inline
r_int
id|app_tcp_pkt_out
c_func
(paren
r_struct
id|ip_vs_conn
op_star
id|cp
comma
r_struct
id|sk_buff
op_star
op_star
id|pskb
comma
r_struct
id|ip_vs_app
op_star
id|app
)paren
(brace
r_int
id|diff
suffix:semicolon
r_int
r_int
id|tcp_offset
op_assign
(paren
op_star
id|pskb
)paren
op_member_access_from_pointer
id|nh.iph-&gt;ihl
op_star
l_int|4
suffix:semicolon
r_struct
id|tcphdr
op_star
id|th
suffix:semicolon
id|__u32
id|seq
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ip_vs_make_skb_writable
c_func
(paren
id|pskb
comma
id|tcp_offset
op_plus
r_sizeof
(paren
op_star
id|th
)paren
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|th
op_assign
(paren
r_struct
id|tcphdr
op_star
)paren
(paren
(paren
op_star
id|pskb
)paren
op_member_access_from_pointer
id|nh.raw
op_plus
id|tcp_offset
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Remember seq number in case this pkt gets resized&n;&t; */
id|seq
op_assign
id|ntohl
c_func
(paren
id|th-&gt;seq
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Fix seq stuff if flagged as so.&n;&t; */
r_if
c_cond
(paren
id|cp-&gt;flags
op_amp
id|IP_VS_CONN_F_OUT_SEQ
)paren
id|vs_fix_seq
c_func
(paren
op_amp
id|cp-&gt;out_seq
comma
id|th
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cp-&gt;flags
op_amp
id|IP_VS_CONN_F_IN_SEQ
)paren
id|vs_fix_ack_seq
c_func
(paren
op_amp
id|cp-&gt;in_seq
comma
id|th
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Call private output hook function&n;&t; */
r_if
c_cond
(paren
id|app-&gt;pkt_out
op_eq
l_int|NULL
)paren
r_return
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|app
op_member_access_from_pointer
id|pkt_out
c_func
(paren
id|app
comma
id|cp
comma
id|pskb
comma
op_amp
id|diff
)paren
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Update ip_vs seq stuff if len has changed.&n;&t; */
r_if
c_cond
(paren
id|diff
op_ne
l_int|0
)paren
id|vs_seq_update
c_func
(paren
id|cp
comma
op_amp
id|cp-&gt;out_seq
comma
id|IP_VS_CONN_F_OUT_SEQ
comma
id|seq
comma
id|diff
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Output pkt hook. Will call bound ip_vs_app specific function&n; *&t;called by ipvs packet handler, assumes previously checked cp!=NULL&n; *&t;returns false if it can&squot;t handle packet (oom)&n; */
DECL|function|ip_vs_app_pkt_out
r_int
id|ip_vs_app_pkt_out
c_func
(paren
r_struct
id|ip_vs_conn
op_star
id|cp
comma
r_struct
id|sk_buff
op_star
op_star
id|pskb
)paren
(brace
r_struct
id|ip_vs_app
op_star
id|app
suffix:semicolon
multiline_comment|/*&n;&t; *&t;check if application module is bound to&n;&t; *&t;this ip_vs_conn.&n;&t; */
r_if
c_cond
(paren
(paren
id|app
op_assign
id|cp-&gt;app
)paren
op_eq
l_int|NULL
)paren
r_return
l_int|1
suffix:semicolon
multiline_comment|/* TCP is complicated */
r_if
c_cond
(paren
id|cp-&gt;protocol
op_eq
id|IPPROTO_TCP
)paren
r_return
id|app_tcp_pkt_out
c_func
(paren
id|cp
comma
id|pskb
comma
id|app
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Call private output hook function&n;&t; */
r_if
c_cond
(paren
id|app-&gt;pkt_out
op_eq
l_int|NULL
)paren
r_return
l_int|1
suffix:semicolon
r_return
id|app
op_member_access_from_pointer
id|pkt_out
c_func
(paren
id|app
comma
id|cp
comma
id|pskb
comma
l_int|NULL
)paren
suffix:semicolon
)brace
DECL|function|app_tcp_pkt_in
r_static
r_inline
r_int
id|app_tcp_pkt_in
c_func
(paren
r_struct
id|ip_vs_conn
op_star
id|cp
comma
r_struct
id|sk_buff
op_star
op_star
id|pskb
comma
r_struct
id|ip_vs_app
op_star
id|app
)paren
(brace
r_int
id|diff
suffix:semicolon
r_int
r_int
id|tcp_offset
op_assign
(paren
op_star
id|pskb
)paren
op_member_access_from_pointer
id|nh.iph-&gt;ihl
op_star
l_int|4
suffix:semicolon
r_struct
id|tcphdr
op_star
id|th
suffix:semicolon
id|__u32
id|seq
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ip_vs_make_skb_writable
c_func
(paren
id|pskb
comma
id|tcp_offset
op_plus
r_sizeof
(paren
op_star
id|th
)paren
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|th
op_assign
(paren
r_struct
id|tcphdr
op_star
)paren
(paren
(paren
op_star
id|pskb
)paren
op_member_access_from_pointer
id|nh.raw
op_plus
id|tcp_offset
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Remember seq number in case this pkt gets resized&n;&t; */
id|seq
op_assign
id|ntohl
c_func
(paren
id|th-&gt;seq
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Fix seq stuff if flagged as so.&n;&t; */
r_if
c_cond
(paren
id|cp-&gt;flags
op_amp
id|IP_VS_CONN_F_IN_SEQ
)paren
id|vs_fix_seq
c_func
(paren
op_amp
id|cp-&gt;in_seq
comma
id|th
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cp-&gt;flags
op_amp
id|IP_VS_CONN_F_OUT_SEQ
)paren
id|vs_fix_ack_seq
c_func
(paren
op_amp
id|cp-&gt;out_seq
comma
id|th
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Call private input hook function&n;&t; */
r_if
c_cond
(paren
id|app-&gt;pkt_in
op_eq
l_int|NULL
)paren
r_return
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|app
op_member_access_from_pointer
id|pkt_in
c_func
(paren
id|app
comma
id|cp
comma
id|pskb
comma
op_amp
id|diff
)paren
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Update ip_vs seq stuff if len has changed.&n;&t; */
r_if
c_cond
(paren
id|diff
op_ne
l_int|0
)paren
id|vs_seq_update
c_func
(paren
id|cp
comma
op_amp
id|cp-&gt;in_seq
comma
id|IP_VS_CONN_F_IN_SEQ
comma
id|seq
comma
id|diff
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Input pkt hook. Will call bound ip_vs_app specific function&n; *&t;called by ipvs packet handler, assumes previously checked cp!=NULL.&n; *&t;returns false if can&squot;t handle packet (oom).&n; */
DECL|function|ip_vs_app_pkt_in
r_int
id|ip_vs_app_pkt_in
c_func
(paren
r_struct
id|ip_vs_conn
op_star
id|cp
comma
r_struct
id|sk_buff
op_star
op_star
id|pskb
)paren
(brace
r_struct
id|ip_vs_app
op_star
id|app
suffix:semicolon
multiline_comment|/*&n;&t; *&t;check if application module is bound to&n;&t; *&t;this ip_vs_conn.&n;&t; */
r_if
c_cond
(paren
(paren
id|app
op_assign
id|cp-&gt;app
)paren
op_eq
l_int|NULL
)paren
r_return
l_int|1
suffix:semicolon
multiline_comment|/* TCP is complicated */
r_if
c_cond
(paren
id|cp-&gt;protocol
op_eq
id|IPPROTO_TCP
)paren
r_return
id|app_tcp_pkt_in
c_func
(paren
id|cp
comma
id|pskb
comma
id|app
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *&t;Call private input hook function&n;&t; */
r_if
c_cond
(paren
id|app-&gt;pkt_in
op_eq
l_int|NULL
)paren
r_return
l_int|1
suffix:semicolon
r_return
id|app
op_member_access_from_pointer
id|pkt_in
c_func
(paren
id|app
comma
id|cp
comma
id|pskb
comma
l_int|NULL
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_PROC_FS
multiline_comment|/*&n; *&t;/proc/net/ip_vs_app entry function&n; */
DECL|function|ip_vs_app_idx
r_static
r_struct
id|ip_vs_app
op_star
id|ip_vs_app_idx
c_func
(paren
id|loff_t
id|pos
)paren
(brace
r_struct
id|ip_vs_app
op_star
id|app
comma
op_star
id|inc
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|app
comma
op_amp
id|ip_vs_app_list
comma
id|a_list
)paren
(brace
id|list_for_each_entry
c_func
(paren
id|inc
comma
op_amp
id|app-&gt;incs_list
comma
id|a_list
)paren
(brace
r_if
c_cond
(paren
id|pos
op_decrement
op_eq
l_int|0
)paren
r_return
id|inc
suffix:semicolon
)brace
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|ip_vs_app_seq_start
r_static
r_void
op_star
id|ip_vs_app_seq_start
c_func
(paren
r_struct
id|seq_file
op_star
id|seq
comma
id|loff_t
op_star
id|pos
)paren
(brace
id|down
c_func
(paren
op_amp
id|__ip_vs_app_mutex
)paren
suffix:semicolon
r_return
op_star
id|pos
ques
c_cond
id|ip_vs_app_idx
c_func
(paren
op_star
id|pos
op_minus
l_int|1
)paren
suffix:colon
id|SEQ_START_TOKEN
suffix:semicolon
)brace
DECL|function|ip_vs_app_seq_next
r_static
r_void
op_star
id|ip_vs_app_seq_next
c_func
(paren
r_struct
id|seq_file
op_star
id|seq
comma
r_void
op_star
id|v
comma
id|loff_t
op_star
id|pos
)paren
(brace
r_struct
id|ip_vs_app
op_star
id|inc
comma
op_star
id|app
suffix:semicolon
r_struct
id|list_head
op_star
id|e
suffix:semicolon
op_increment
op_star
id|pos
suffix:semicolon
r_if
c_cond
(paren
id|v
op_eq
id|SEQ_START_TOKEN
)paren
r_return
id|ip_vs_app_idx
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|inc
op_assign
id|v
suffix:semicolon
id|app
op_assign
id|inc-&gt;app
suffix:semicolon
r_if
c_cond
(paren
(paren
id|e
op_assign
id|inc-&gt;a_list.next
)paren
op_ne
op_amp
id|app-&gt;incs_list
)paren
r_return
id|list_entry
c_func
(paren
id|e
comma
r_struct
id|ip_vs_app
comma
id|a_list
)paren
suffix:semicolon
multiline_comment|/* go on to next application */
r_for
c_loop
(paren
id|e
op_assign
id|app-&gt;a_list.next
suffix:semicolon
id|e
op_ne
op_amp
id|ip_vs_app_list
suffix:semicolon
id|e
op_assign
id|e-&gt;next
)paren
(brace
id|app
op_assign
id|list_entry
c_func
(paren
id|e
comma
r_struct
id|ip_vs_app
comma
id|a_list
)paren
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|inc
comma
op_amp
id|app-&gt;incs_list
comma
id|a_list
)paren
(brace
r_return
id|inc
suffix:semicolon
)brace
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|ip_vs_app_seq_stop
r_static
r_void
id|ip_vs_app_seq_stop
c_func
(paren
r_struct
id|seq_file
op_star
id|seq
comma
r_void
op_star
id|v
)paren
(brace
id|up
c_func
(paren
op_amp
id|__ip_vs_app_mutex
)paren
suffix:semicolon
)brace
DECL|function|ip_vs_app_seq_show
r_static
r_int
id|ip_vs_app_seq_show
c_func
(paren
r_struct
id|seq_file
op_star
id|seq
comma
r_void
op_star
id|v
)paren
(brace
r_if
c_cond
(paren
id|v
op_eq
id|SEQ_START_TOKEN
)paren
id|seq_puts
c_func
(paren
id|seq
comma
l_string|&quot;prot port    usecnt name&bslash;n&quot;
)paren
suffix:semicolon
r_else
(brace
r_const
r_struct
id|ip_vs_app
op_star
id|inc
op_assign
id|v
suffix:semicolon
id|seq_printf
c_func
(paren
id|seq
comma
l_string|&quot;%-3s  %-7u %-6d %-17s&bslash;n&quot;
comma
id|ip_vs_proto_name
c_func
(paren
id|inc-&gt;protocol
)paren
comma
id|ntohs
c_func
(paren
id|inc-&gt;port
)paren
comma
id|atomic_read
c_func
(paren
op_amp
id|inc-&gt;usecnt
)paren
comma
id|inc-&gt;name
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|ip_vs_app_seq_ops
r_static
r_struct
id|seq_operations
id|ip_vs_app_seq_ops
op_assign
(brace
dot
id|start
op_assign
id|ip_vs_app_seq_start
comma
dot
id|next
op_assign
id|ip_vs_app_seq_next
comma
dot
id|stop
op_assign
id|ip_vs_app_seq_stop
comma
dot
id|show
op_assign
id|ip_vs_app_seq_show
comma
)brace
suffix:semicolon
DECL|function|ip_vs_app_open
r_static
r_int
id|ip_vs_app_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_return
id|seq_open
c_func
(paren
id|file
comma
op_amp
id|ip_vs_app_seq_ops
)paren
suffix:semicolon
)brace
DECL|variable|ip_vs_app_fops
r_static
r_struct
id|file_operations
id|ip_vs_app_fops
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|open
op_assign
id|ip_vs_app_open
comma
dot
id|read
op_assign
id|seq_read
comma
dot
id|llseek
op_assign
id|seq_lseek
comma
dot
id|release
op_assign
id|seq_release
comma
)brace
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n; *&t;Replace a segment of data with a new segment&n; */
DECL|function|ip_vs_skb_replace
r_int
id|ip_vs_skb_replace
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_int
id|pri
comma
r_char
op_star
id|o_buf
comma
r_int
id|o_len
comma
r_char
op_star
id|n_buf
comma
r_int
id|n_len
)paren
(brace
r_struct
id|iphdr
op_star
id|iph
suffix:semicolon
r_int
id|diff
suffix:semicolon
r_int
id|o_offset
suffix:semicolon
r_int
id|o_left
suffix:semicolon
id|EnterFunction
c_func
(paren
l_int|9
)paren
suffix:semicolon
id|diff
op_assign
id|n_len
op_minus
id|o_len
suffix:semicolon
id|o_offset
op_assign
id|o_buf
op_minus
(paren
r_char
op_star
)paren
id|skb-&gt;data
suffix:semicolon
multiline_comment|/* The length of left data after o_buf+o_len in the skb data */
id|o_left
op_assign
id|skb-&gt;len
op_minus
(paren
id|o_offset
op_plus
id|o_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|diff
op_le
l_int|0
)paren
(brace
id|memmove
c_func
(paren
id|o_buf
op_plus
id|n_len
comma
id|o_buf
op_plus
id|o_len
comma
id|o_left
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|o_buf
comma
id|n_buf
comma
id|n_len
)paren
suffix:semicolon
id|skb_trim
c_func
(paren
id|skb
comma
id|skb-&gt;len
op_plus
id|diff
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|diff
op_le
id|skb_tailroom
c_func
(paren
id|skb
)paren
)paren
(brace
id|skb_put
c_func
(paren
id|skb
comma
id|diff
)paren
suffix:semicolon
id|memmove
c_func
(paren
id|o_buf
op_plus
id|n_len
comma
id|o_buf
op_plus
id|o_len
comma
id|o_left
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|o_buf
comma
id|n_buf
comma
id|n_len
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|pskb_expand_head
c_func
(paren
id|skb
comma
id|skb_headroom
c_func
(paren
id|skb
)paren
comma
id|diff
comma
id|pri
)paren
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|skb_put
c_func
(paren
id|skb
comma
id|diff
)paren
suffix:semicolon
id|memmove
c_func
(paren
id|skb-&gt;data
op_plus
id|o_offset
op_plus
id|n_len
comma
id|skb-&gt;data
op_plus
id|o_offset
op_plus
id|o_len
comma
id|o_left
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|skb-&gt;data
op_plus
id|o_offset
comma
id|n_buf
comma
id|n_len
)paren
suffix:semicolon
)brace
multiline_comment|/* must update the iph total length here */
id|iph
op_assign
id|skb-&gt;nh.iph
suffix:semicolon
id|iph-&gt;tot_len
op_assign
id|htons
c_func
(paren
id|skb-&gt;len
)paren
suffix:semicolon
id|LeaveFunction
c_func
(paren
l_int|9
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ip_vs_app_init
r_int
id|ip_vs_app_init
c_func
(paren
r_void
)paren
(brace
multiline_comment|/* we will replace it with proc_net_ipvs_create() soon */
id|proc_net_fops_create
c_func
(paren
l_string|&quot;ip_vs_app&quot;
comma
l_int|0
comma
op_amp
id|ip_vs_app_fops
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ip_vs_app_cleanup
r_void
id|ip_vs_app_cleanup
c_func
(paren
r_void
)paren
(brace
id|proc_net_remove
c_func
(paren
l_string|&quot;ip_vs_app&quot;
)paren
suffix:semicolon
)brace
eof
