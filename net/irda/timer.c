multiline_comment|/*********************************************************************&n; *                &n; * Filename:      timer.c&n; * Version:       &n; * Description:   &n; * Status:        Experimental.&n; * Author:        Dag Brattli &lt;dagb@cs.uit.no&gt;&n; * Created at:    Sat Aug 16 00:59:29 1997&n; * Modified at:   Wed Dec  8 12:50:34 1999&n; * Modified by:   Dag Brattli &lt;dagb@cs.uit.no&gt;&n; * &n; *     Copyright (c) 1997, 1999 Dag Brattli &lt;dagb@cs.uit.no&gt;, &n; *     All Rights Reserved.&n; *     Copyright (c) 2000-2002 Jean Tourrilhes &lt;jt@hpl.hp.com&gt;&n; *     &n; *     This program is free software; you can redistribute it and/or &n; *     modify it under the terms of the GNU General Public License as &n; *     published by the Free Software Foundation; either version 2 of &n; *     the License, or (at your option) any later version.&n; *&n; *     Neither Dag Brattli nor University of Troms&#xfffd; admit liability nor&n; *     provide warranty for any of this software. This material is &n; *     provided &quot;AS-IS&quot; and at no charge.&n; *&n; ********************************************************************/
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;net/irda/timer.h&gt;
macro_line|#include &lt;net/irda/irda.h&gt;
macro_line|#include &lt;net/irda/irda_device.h&gt;
macro_line|#include &lt;net/irda/irlap.h&gt;
macro_line|#include &lt;net/irda/irlmp.h&gt;
r_extern
r_int
id|sysctl_slot_timeout
suffix:semicolon
r_static
r_void
id|irlap_slot_timer_expired
c_func
(paren
r_void
op_star
id|data
)paren
suffix:semicolon
r_static
r_void
id|irlap_query_timer_expired
c_func
(paren
r_void
op_star
id|data
)paren
suffix:semicolon
r_static
r_void
id|irlap_final_timer_expired
c_func
(paren
r_void
op_star
id|data
)paren
suffix:semicolon
r_static
r_void
id|irlap_wd_timer_expired
c_func
(paren
r_void
op_star
id|data
)paren
suffix:semicolon
r_static
r_void
id|irlap_backoff_timer_expired
c_func
(paren
r_void
op_star
id|data
)paren
suffix:semicolon
r_static
r_void
id|irlap_media_busy_expired
c_func
(paren
r_void
op_star
id|data
)paren
suffix:semicolon
DECL|function|irlap_start_slot_timer
r_void
id|irlap_start_slot_timer
c_func
(paren
r_struct
id|irlap_cb
op_star
id|self
comma
r_int
id|timeout
)paren
(brace
id|irda_start_timer
c_func
(paren
op_amp
id|self-&gt;slot_timer
comma
id|timeout
comma
(paren
r_void
op_star
)paren
id|self
comma
id|irlap_slot_timer_expired
)paren
suffix:semicolon
)brace
DECL|function|irlap_start_query_timer
r_void
id|irlap_start_query_timer
c_func
(paren
r_struct
id|irlap_cb
op_star
id|self
comma
r_int
id|S
comma
r_int
id|s
)paren
(brace
r_int
id|timeout
suffix:semicolon
multiline_comment|/* Calculate when the peer discovery should end. Normally, we&n;&t; * get the end-of-discovery frame, so this is just in case&n;&t; * we miss it.&n;&t; * Basically, we multiply the number of remaining slots by our&n;&t; * slot time, plus add some extra time to properly receive the last&n;&t; * discovery packet (which is longer due to extra discovery info),&n;&t; * to avoid messing with for incomming connections requests and&n;&t; * to accomodate devices that perform discovery slower than us.&n;&t; * Jean II */
id|timeout
op_assign
(paren
(paren
id|sysctl_slot_timeout
op_star
id|HZ
op_div
l_int|1000
)paren
op_star
(paren
id|S
op_minus
id|s
)paren
op_plus
id|XIDEXTRA_TIMEOUT
op_plus
id|SMALLBUSY_TIMEOUT
)paren
suffix:semicolon
multiline_comment|/* Set or re-set the timer. We reset the timer for each received&n;&t; * discovery query, which allow us to automatically adjust to&n;&t; * the speed of the peer discovery (faster or slower). Jean II */
id|irda_start_timer
c_func
(paren
op_amp
id|self-&gt;query_timer
comma
id|timeout
comma
(paren
r_void
op_star
)paren
id|self
comma
id|irlap_query_timer_expired
)paren
suffix:semicolon
)brace
DECL|function|irlap_start_final_timer
r_void
id|irlap_start_final_timer
c_func
(paren
r_struct
id|irlap_cb
op_star
id|self
comma
r_int
id|timeout
)paren
(brace
id|irda_start_timer
c_func
(paren
op_amp
id|self-&gt;final_timer
comma
id|timeout
comma
(paren
r_void
op_star
)paren
id|self
comma
id|irlap_final_timer_expired
)paren
suffix:semicolon
)brace
DECL|function|irlap_start_wd_timer
r_void
id|irlap_start_wd_timer
c_func
(paren
r_struct
id|irlap_cb
op_star
id|self
comma
r_int
id|timeout
)paren
(brace
id|irda_start_timer
c_func
(paren
op_amp
id|self-&gt;wd_timer
comma
id|timeout
comma
(paren
r_void
op_star
)paren
id|self
comma
id|irlap_wd_timer_expired
)paren
suffix:semicolon
)brace
DECL|function|irlap_start_backoff_timer
r_void
id|irlap_start_backoff_timer
c_func
(paren
r_struct
id|irlap_cb
op_star
id|self
comma
r_int
id|timeout
)paren
(brace
id|irda_start_timer
c_func
(paren
op_amp
id|self-&gt;backoff_timer
comma
id|timeout
comma
(paren
r_void
op_star
)paren
id|self
comma
id|irlap_backoff_timer_expired
)paren
suffix:semicolon
)brace
DECL|function|irlap_start_mbusy_timer
r_void
id|irlap_start_mbusy_timer
c_func
(paren
r_struct
id|irlap_cb
op_star
id|self
comma
r_int
id|timeout
)paren
(brace
id|irda_start_timer
c_func
(paren
op_amp
id|self-&gt;media_busy_timer
comma
id|timeout
comma
(paren
r_void
op_star
)paren
id|self
comma
id|irlap_media_busy_expired
)paren
suffix:semicolon
)brace
DECL|function|irlap_stop_mbusy_timer
r_void
id|irlap_stop_mbusy_timer
c_func
(paren
r_struct
id|irlap_cb
op_star
id|self
)paren
(brace
multiline_comment|/* If timer is activated, kill it! */
id|del_timer
c_func
(paren
op_amp
id|self-&gt;media_busy_timer
)paren
suffix:semicolon
multiline_comment|/* If we are in NDM, there is a bunch of events in LAP that&n;&t; * that be pending due to the media_busy condition, such as&n;&t; * CONNECT_REQUEST and SEND_UI_FRAME. If we don&squot;t generate&n;&t; * an event, they will wait forever...&n;&t; * Jean II */
r_if
c_cond
(paren
id|self-&gt;state
op_eq
id|LAP_NDM
)paren
id|irlap_do_event
c_func
(paren
id|self
comma
id|MEDIA_BUSY_TIMER_EXPIRED
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
)brace
DECL|function|irlmp_start_watchdog_timer
r_void
id|irlmp_start_watchdog_timer
c_func
(paren
r_struct
id|lsap_cb
op_star
id|self
comma
r_int
id|timeout
)paren
(brace
id|irda_start_timer
c_func
(paren
op_amp
id|self-&gt;watchdog_timer
comma
id|timeout
comma
(paren
r_void
op_star
)paren
id|self
comma
id|irlmp_watchdog_timer_expired
)paren
suffix:semicolon
)brace
DECL|function|irlmp_start_discovery_timer
r_void
id|irlmp_start_discovery_timer
c_func
(paren
r_struct
id|irlmp_cb
op_star
id|self
comma
r_int
id|timeout
)paren
(brace
id|irda_start_timer
c_func
(paren
op_amp
id|self-&gt;discovery_timer
comma
id|timeout
comma
(paren
r_void
op_star
)paren
id|self
comma
id|irlmp_discovery_timer_expired
)paren
suffix:semicolon
)brace
DECL|function|irlmp_start_idle_timer
r_void
id|irlmp_start_idle_timer
c_func
(paren
r_struct
id|lap_cb
op_star
id|self
comma
r_int
id|timeout
)paren
(brace
id|irda_start_timer
c_func
(paren
op_amp
id|self-&gt;idle_timer
comma
id|timeout
comma
(paren
r_void
op_star
)paren
id|self
comma
id|irlmp_idle_timer_expired
)paren
suffix:semicolon
)brace
DECL|function|irlmp_stop_idle_timer
r_void
id|irlmp_stop_idle_timer
c_func
(paren
r_struct
id|lap_cb
op_star
id|self
)paren
(brace
multiline_comment|/* If timer is activated, kill it! */
id|del_timer
c_func
(paren
op_amp
id|self-&gt;idle_timer
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlap_slot_timer_expired (data)&n; *&n; *    IrLAP slot timer has expired&n; *&n; */
DECL|function|irlap_slot_timer_expired
r_static
r_void
id|irlap_slot_timer_expired
c_func
(paren
r_void
op_star
id|data
)paren
(brace
r_struct
id|irlap_cb
op_star
id|self
op_assign
(paren
r_struct
id|irlap_cb
op_star
)paren
id|data
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|LAP_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|irlap_do_event
c_func
(paren
id|self
comma
id|SLOT_TIMER_EXPIRED
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irlap_query_timer_expired (data)&n; *&n; *    IrLAP query timer has expired&n; *&n; */
DECL|function|irlap_query_timer_expired
r_static
r_void
id|irlap_query_timer_expired
c_func
(paren
r_void
op_star
id|data
)paren
(brace
r_struct
id|irlap_cb
op_star
id|self
op_assign
(paren
r_struct
id|irlap_cb
op_star
)paren
id|data
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|LAP_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|irlap_do_event
c_func
(paren
id|self
comma
id|QUERY_TIMER_EXPIRED
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irda_final_timer_expired (data)&n; *&n; *    &n; *&n; */
DECL|function|irlap_final_timer_expired
r_static
r_void
id|irlap_final_timer_expired
c_func
(paren
r_void
op_star
id|data
)paren
(brace
r_struct
id|irlap_cb
op_star
id|self
op_assign
(paren
r_struct
id|irlap_cb
op_star
)paren
id|data
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|LAP_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|irlap_do_event
c_func
(paren
id|self
comma
id|FINAL_TIMER_EXPIRED
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irda_wd_timer_expired (data)&n; *&n; *    &n; *&n; */
DECL|function|irlap_wd_timer_expired
r_static
r_void
id|irlap_wd_timer_expired
c_func
(paren
r_void
op_star
id|data
)paren
(brace
r_struct
id|irlap_cb
op_star
id|self
op_assign
(paren
r_struct
id|irlap_cb
op_star
)paren
id|data
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|LAP_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|irlap_do_event
c_func
(paren
id|self
comma
id|WD_TIMER_EXPIRED
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irda_backoff_timer_expired (data)&n; *&n; *    &n; *&n; */
DECL|function|irlap_backoff_timer_expired
r_static
r_void
id|irlap_backoff_timer_expired
c_func
(paren
r_void
op_star
id|data
)paren
(brace
r_struct
id|irlap_cb
op_star
id|self
op_assign
(paren
r_struct
id|irlap_cb
op_star
)paren
id|data
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|ASSERT
c_func
(paren
id|self-&gt;magic
op_eq
id|LAP_MAGIC
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|irlap_do_event
c_func
(paren
id|self
comma
id|BACKOFF_TIMER_EXPIRED
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Function irtty_media_busy_expired (data)&n; *&n; *    &n; */
DECL|function|irlap_media_busy_expired
r_void
id|irlap_media_busy_expired
c_func
(paren
r_void
op_star
id|data
)paren
(brace
r_struct
id|irlap_cb
op_star
id|self
op_assign
(paren
r_struct
id|irlap_cb
op_star
)paren
id|data
suffix:semicolon
id|ASSERT
c_func
(paren
id|self
op_ne
l_int|NULL
comma
r_return
suffix:semicolon
)paren
suffix:semicolon
id|irda_device_set_media_busy
c_func
(paren
id|self-&gt;netdev
comma
id|FALSE
)paren
suffix:semicolon
multiline_comment|/* Note : the LAP event will be send in irlap_stop_mbusy_timer(),&n;&t;* to catch other cases where the flag is cleared (for example&n;&t;* after a discovery) - Jean II */
)brace
eof
