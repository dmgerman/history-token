multiline_comment|/*&n; * linux/net/sunrpc/svcauth.c&n; *&n; * The generic interface for RPC authentication on the server side.&n; * &n; * Copyright (C) 1995, 1996 Olaf Kirch &lt;okir@monad.swb.de&gt;&n; *&n; * CHANGES&n; * 19-Apr-2000 Chris Evans      - Security fix&n; */
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/sunrpc/types.h&gt;
macro_line|#include &lt;linux/sunrpc/xdr.h&gt;
macro_line|#include &lt;linux/sunrpc/svcauth.h&gt;
macro_line|#include &lt;linux/sunrpc/svcsock.h&gt;
macro_line|#include &lt;linux/err.h&gt;
DECL|macro|RPCDBG_FACILITY
mdefine_line|#define RPCDBG_FACILITY&t;RPCDBG_AUTH
multiline_comment|/*&n; * Builtin auth flavors&n; */
r_static
r_int
id|svcauth_null_accept
c_func
(paren
r_struct
id|svc_rqst
op_star
id|rqstp
comma
id|u32
op_star
id|authp
comma
r_int
id|proc
)paren
suffix:semicolon
r_static
r_int
id|svcauth_null_release
c_func
(paren
r_struct
id|svc_rqst
op_star
id|rqstp
)paren
suffix:semicolon
r_static
r_int
id|svcauth_unix_accept
c_func
(paren
r_struct
id|svc_rqst
op_star
id|rqstp
comma
id|u32
op_star
id|authp
comma
r_int
id|proc
)paren
suffix:semicolon
r_static
r_int
id|svcauth_unix_release
c_func
(paren
r_struct
id|svc_rqst
op_star
id|rqstp
)paren
suffix:semicolon
DECL|variable|svcauth_null
r_struct
id|auth_ops
id|svcauth_null
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;null&quot;
comma
dot
id|flavour
op_assign
id|RPC_AUTH_NULL
comma
dot
id|accept
op_assign
id|svcauth_null_accept
comma
dot
id|release
op_assign
id|svcauth_null_release
comma
)brace
suffix:semicolon
DECL|variable|svcauth_unix
r_struct
id|auth_ops
id|svcauth_unix
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;unix&quot;
comma
dot
id|flavour
op_assign
id|RPC_AUTH_UNIX
comma
dot
id|accept
op_assign
id|svcauth_unix_accept
comma
dot
id|release
op_assign
id|svcauth_unix_release
comma
)brace
suffix:semicolon
multiline_comment|/*&n; * Table of authenticators&n; */
DECL|variable|authtab
r_static
r_struct
id|auth_ops
op_star
id|authtab
(braket
id|RPC_AUTH_MAXFLAVOR
)braket
op_assign
(brace
(braket
l_int|0
)braket
op_assign
op_amp
id|svcauth_null
comma
(braket
l_int|1
)braket
op_assign
op_amp
id|svcauth_unix
comma
)brace
suffix:semicolon
r_int
DECL|function|svc_authenticate
id|svc_authenticate
c_func
(paren
r_struct
id|svc_rqst
op_star
id|rqstp
comma
id|u32
op_star
id|statp
comma
id|u32
op_star
id|authp
comma
r_int
id|proc
)paren
(brace
id|rpc_authflavor_t
id|flavor
suffix:semicolon
r_struct
id|auth_ops
op_star
id|aops
suffix:semicolon
op_star
id|statp
op_assign
id|rpc_success
suffix:semicolon
op_star
id|authp
op_assign
id|rpc_auth_ok
suffix:semicolon
id|svc_getu32
c_func
(paren
op_amp
id|rqstp-&gt;rq_argbuf
comma
id|flavor
)paren
suffix:semicolon
id|flavor
op_assign
id|ntohl
c_func
(paren
id|flavor
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;svc: svc_authenticate (%d)&bslash;n&quot;
comma
id|flavor
)paren
suffix:semicolon
r_if
c_cond
(paren
id|flavor
op_ge
id|RPC_AUTH_MAXFLAVOR
op_logical_or
op_logical_neg
(paren
id|aops
op_assign
id|authtab
(braket
id|flavor
)braket
)paren
)paren
(brace
op_star
id|authp
op_assign
id|rpc_autherr_badcred
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|rqstp-&gt;rq_authop
op_assign
id|aops
suffix:semicolon
r_switch
c_cond
(paren
id|aops
op_member_access_from_pointer
id|accept
c_func
(paren
id|rqstp
comma
id|authp
comma
id|proc
)paren
)paren
(brace
r_case
id|SVC_OK
suffix:colon
r_return
l_int|0
suffix:semicolon
r_case
id|SVC_GARBAGE
suffix:colon
op_star
id|statp
op_assign
id|rpc_garbage_args
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SVC_SYSERR
suffix:colon
op_star
id|statp
op_assign
id|rpc_system_err
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|SVC_DENIED
suffix:colon
r_return
l_int|0
suffix:semicolon
r_case
id|SVC_DROP
suffix:colon
r_break
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
multiline_comment|/* drop the request */
)brace
multiline_comment|/* A reqeust, which was authenticated, has now executed.&n; * Time to finalise the the credentials and verifier&n; * and release and resources&n; */
DECL|function|svc_authorise
r_int
id|svc_authorise
c_func
(paren
r_struct
id|svc_rqst
op_star
id|rqstp
)paren
(brace
r_struct
id|auth_ops
op_star
id|aops
op_assign
id|rqstp-&gt;rq_authop
suffix:semicolon
r_int
id|rv
op_assign
l_int|0
suffix:semicolon
id|rqstp-&gt;rq_authop
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|aops
)paren
id|rv
op_assign
id|aops
op_member_access_from_pointer
id|release
c_func
(paren
id|rqstp
)paren
suffix:semicolon
multiline_comment|/* FIXME should I count and release authops */
r_return
id|rv
suffix:semicolon
)brace
r_int
DECL|function|svc_auth_register
id|svc_auth_register
c_func
(paren
id|rpc_authflavor_t
id|flavor
comma
r_struct
id|auth_ops
op_star
id|aops
)paren
(brace
r_if
c_cond
(paren
id|flavor
op_ge
id|RPC_AUTH_MAXFLAVOR
op_logical_or
id|authtab
(braket
id|flavor
)braket
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|authtab
(braket
id|flavor
)braket
op_assign
id|aops
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_void
DECL|function|svc_auth_unregister
id|svc_auth_unregister
c_func
(paren
id|rpc_authflavor_t
id|flavor
)paren
(brace
r_if
c_cond
(paren
id|flavor
OL
id|RPC_AUTH_MAXFLAVOR
)paren
id|authtab
(braket
id|flavor
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
r_static
r_int
DECL|function|svcauth_null_accept
id|svcauth_null_accept
c_func
(paren
r_struct
id|svc_rqst
op_star
id|rqstp
comma
id|u32
op_star
id|authp
comma
r_int
id|proc
)paren
(brace
r_struct
id|svc_buf
op_star
id|argp
op_assign
op_amp
id|rqstp-&gt;rq_argbuf
suffix:semicolon
r_struct
id|svc_buf
op_star
id|resp
op_assign
op_amp
id|rqstp-&gt;rq_resbuf
suffix:semicolon
r_if
c_cond
(paren
(paren
id|argp-&gt;len
op_sub_assign
l_int|3
)paren
OL
l_int|0
)paren
(brace
r_return
id|SVC_GARBAGE
suffix:semicolon
)brace
r_if
c_cond
(paren
op_star
(paren
id|argp-&gt;buf
)paren
op_increment
op_ne
l_int|0
)paren
(brace
multiline_comment|/* we already skipped the flavor */
id|dprintk
c_func
(paren
l_string|&quot;svc: bad null cred&bslash;n&quot;
)paren
suffix:semicolon
op_star
id|authp
op_assign
id|rpc_autherr_badcred
suffix:semicolon
r_return
id|SVC_DENIED
suffix:semicolon
)brace
r_if
c_cond
(paren
op_star
(paren
id|argp-&gt;buf
)paren
op_increment
op_ne
id|RPC_AUTH_NULL
op_logical_or
op_star
(paren
id|argp-&gt;buf
)paren
op_increment
op_ne
l_int|0
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;svc: bad null verf&bslash;n&quot;
)paren
suffix:semicolon
op_star
id|authp
op_assign
id|rpc_autherr_badverf
suffix:semicolon
r_return
id|SVC_DENIED
suffix:semicolon
)brace
multiline_comment|/* Signal that mapping to nobody uid/gid is required */
id|rqstp-&gt;rq_cred.cr_uid
op_assign
(paren
id|uid_t
)paren
op_minus
l_int|1
suffix:semicolon
id|rqstp-&gt;rq_cred.cr_gid
op_assign
(paren
id|gid_t
)paren
op_minus
l_int|1
suffix:semicolon
id|rqstp-&gt;rq_cred.cr_groups
(braket
l_int|0
)braket
op_assign
id|NOGROUP
suffix:semicolon
multiline_comment|/* Put NULL verifier */
id|svc_putu32
c_func
(paren
id|resp
comma
id|RPC_AUTH_NULL
)paren
suffix:semicolon
id|svc_putu32
c_func
(paren
id|resp
comma
l_int|0
)paren
suffix:semicolon
r_return
id|SVC_OK
suffix:semicolon
)brace
r_static
r_int
DECL|function|svcauth_null_release
id|svcauth_null_release
c_func
(paren
r_struct
id|svc_rqst
op_star
id|rqstp
)paren
(brace
r_return
l_int|0
suffix:semicolon
multiline_comment|/* don&squot;t drop */
)brace
r_static
r_int
DECL|function|svcauth_unix_accept
id|svcauth_unix_accept
c_func
(paren
r_struct
id|svc_rqst
op_star
id|rqstp
comma
id|u32
op_star
id|authp
comma
r_int
id|proc
)paren
(brace
r_struct
id|svc_buf
op_star
id|argp
op_assign
op_amp
id|rqstp-&gt;rq_argbuf
suffix:semicolon
r_struct
id|svc_buf
op_star
id|resp
op_assign
op_amp
id|rqstp-&gt;rq_resbuf
suffix:semicolon
r_struct
id|svc_cred
op_star
id|cred
op_assign
op_amp
id|rqstp-&gt;rq_cred
suffix:semicolon
id|u32
op_star
id|bufp
op_assign
id|argp-&gt;buf
comma
id|slen
comma
id|i
suffix:semicolon
r_int
id|len
op_assign
id|argp-&gt;len
suffix:semicolon
r_if
c_cond
(paren
(paren
id|len
op_sub_assign
l_int|3
)paren
OL
l_int|0
)paren
r_return
id|SVC_GARBAGE
suffix:semicolon
id|bufp
op_increment
suffix:semicolon
multiline_comment|/* length */
id|bufp
op_increment
suffix:semicolon
multiline_comment|/* time stamp */
id|slen
op_assign
id|XDR_QUADLEN
c_func
(paren
id|ntohl
c_func
(paren
op_star
id|bufp
op_increment
)paren
)paren
suffix:semicolon
multiline_comment|/* machname length */
r_if
c_cond
(paren
id|slen
OG
l_int|64
op_logical_or
(paren
id|len
op_sub_assign
id|slen
op_plus
l_int|3
)paren
OL
l_int|0
)paren
r_goto
id|badcred
suffix:semicolon
id|bufp
op_add_assign
id|slen
suffix:semicolon
multiline_comment|/* skip machname */
id|cred-&gt;cr_uid
op_assign
id|ntohl
c_func
(paren
op_star
id|bufp
op_increment
)paren
suffix:semicolon
multiline_comment|/* uid */
id|cred-&gt;cr_gid
op_assign
id|ntohl
c_func
(paren
op_star
id|bufp
op_increment
)paren
suffix:semicolon
multiline_comment|/* gid */
id|slen
op_assign
id|ntohl
c_func
(paren
op_star
id|bufp
op_increment
)paren
suffix:semicolon
multiline_comment|/* gids length */
r_if
c_cond
(paren
id|slen
OG
l_int|16
op_logical_or
(paren
id|len
op_sub_assign
id|slen
op_plus
l_int|2
)paren
OL
l_int|0
)paren
r_goto
id|badcred
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NGROUPS
op_logical_and
id|i
OL
id|slen
suffix:semicolon
id|i
op_increment
)paren
id|cred-&gt;cr_groups
(braket
id|i
)braket
op_assign
id|ntohl
c_func
(paren
op_star
id|bufp
op_increment
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
OL
id|NGROUPS
)paren
id|cred-&gt;cr_groups
(braket
id|i
)braket
op_assign
id|NOGROUP
suffix:semicolon
id|bufp
op_add_assign
(paren
id|slen
op_minus
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|bufp
op_increment
op_ne
id|RPC_AUTH_NULL
op_logical_or
op_star
id|bufp
op_increment
op_ne
l_int|0
)paren
(brace
op_star
id|authp
op_assign
id|rpc_autherr_badverf
suffix:semicolon
r_return
id|SVC_DENIED
suffix:semicolon
)brace
id|argp-&gt;buf
op_assign
id|bufp
suffix:semicolon
id|argp-&gt;len
op_assign
id|len
suffix:semicolon
multiline_comment|/* Put NULL verifier */
id|svc_putu32
c_func
(paren
id|resp
comma
id|RPC_AUTH_NULL
)paren
suffix:semicolon
id|svc_putu32
c_func
(paren
id|resp
comma
l_int|0
)paren
suffix:semicolon
r_return
id|SVC_OK
suffix:semicolon
id|badcred
suffix:colon
op_star
id|authp
op_assign
id|rpc_autherr_badcred
suffix:semicolon
r_return
id|SVC_DENIED
suffix:semicolon
)brace
r_static
r_int
DECL|function|svcauth_unix_release
id|svcauth_unix_release
c_func
(paren
r_struct
id|svc_rqst
op_star
id|rqstp
)paren
(brace
multiline_comment|/* Verifier (such as it is) is already in place.&n;&t; */
r_return
l_int|0
suffix:semicolon
)brace
eof
