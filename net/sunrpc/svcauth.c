multiline_comment|/*&n; * linux/net/sunrpc/svcauth.c&n; *&n; * The generic interface for RPC authentication on the server side.&n; * &n; * Copyright (C) 1995, 1996 Olaf Kirch &lt;okir@monad.swb.de&gt;&n; *&n; * CHANGES&n; * 19-Apr-2000 Chris Evans      - Security fix&n; */
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/sunrpc/types.h&gt;
macro_line|#include &lt;linux/sunrpc/xdr.h&gt;
macro_line|#include &lt;linux/sunrpc/svcsock.h&gt;
macro_line|#include &lt;linux/sunrpc/svcauth.h&gt;
macro_line|#include &lt;linux/err.h&gt;
macro_line|#include &lt;linux/hash.h&gt;
DECL|macro|RPCDBG_FACILITY
mdefine_line|#define RPCDBG_FACILITY&t;RPCDBG_AUTH
multiline_comment|/*&n; * Table of authenticators&n; */
r_extern
r_struct
id|auth_ops
id|svcauth_null
suffix:semicolon
r_extern
r_struct
id|auth_ops
id|svcauth_unix
suffix:semicolon
r_static
id|DEFINE_SPINLOCK
c_func
(paren
id|authtab_lock
)paren
suffix:semicolon
DECL|variable|authtab
r_static
r_struct
id|auth_ops
op_star
id|authtab
(braket
id|RPC_AUTH_MAXFLAVOR
)braket
op_assign
(brace
(braket
l_int|0
)braket
op_assign
op_amp
id|svcauth_null
comma
(braket
l_int|1
)braket
op_assign
op_amp
id|svcauth_unix
comma
)brace
suffix:semicolon
r_int
DECL|function|svc_authenticate
id|svc_authenticate
c_func
(paren
r_struct
id|svc_rqst
op_star
id|rqstp
comma
id|u32
op_star
id|authp
)paren
(brace
id|rpc_authflavor_t
id|flavor
suffix:semicolon
r_struct
id|auth_ops
op_star
id|aops
suffix:semicolon
op_star
id|authp
op_assign
id|rpc_auth_ok
suffix:semicolon
id|flavor
op_assign
id|ntohl
c_func
(paren
id|svc_getu32
c_func
(paren
op_amp
id|rqstp-&gt;rq_arg.head
(braket
l_int|0
)braket
)paren
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;svc: svc_authenticate (%d)&bslash;n&quot;
comma
id|flavor
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|authtab_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|flavor
op_ge
id|RPC_AUTH_MAXFLAVOR
op_logical_or
op_logical_neg
(paren
id|aops
op_assign
id|authtab
(braket
id|flavor
)braket
)paren
op_logical_or
op_logical_neg
id|try_module_get
c_func
(paren
id|aops-&gt;owner
)paren
)paren
(brace
id|spin_unlock
c_func
(paren
op_amp
id|authtab_lock
)paren
suffix:semicolon
op_star
id|authp
op_assign
id|rpc_autherr_badcred
suffix:semicolon
r_return
id|SVC_DENIED
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|authtab_lock
)paren
suffix:semicolon
id|rqstp-&gt;rq_authop
op_assign
id|aops
suffix:semicolon
r_return
id|aops
op_member_access_from_pointer
id|accept
c_func
(paren
id|rqstp
comma
id|authp
)paren
suffix:semicolon
)brace
DECL|function|svc_set_client
r_int
id|svc_set_client
c_func
(paren
r_struct
id|svc_rqst
op_star
id|rqstp
)paren
(brace
r_return
id|rqstp-&gt;rq_authop
op_member_access_from_pointer
id|set_client
c_func
(paren
id|rqstp
)paren
suffix:semicolon
)brace
multiline_comment|/* A request, which was authenticated, has now executed.&n; * Time to finalise the the credentials and verifier&n; * and release and resources&n; */
DECL|function|svc_authorise
r_int
id|svc_authorise
c_func
(paren
r_struct
id|svc_rqst
op_star
id|rqstp
)paren
(brace
r_struct
id|auth_ops
op_star
id|aops
op_assign
id|rqstp-&gt;rq_authop
suffix:semicolon
r_int
id|rv
op_assign
l_int|0
suffix:semicolon
id|rqstp-&gt;rq_authop
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|aops
)paren
(brace
id|rv
op_assign
id|aops
op_member_access_from_pointer
id|release
c_func
(paren
id|rqstp
)paren
suffix:semicolon
id|module_put
c_func
(paren
id|aops-&gt;owner
)paren
suffix:semicolon
)brace
r_return
id|rv
suffix:semicolon
)brace
r_int
DECL|function|svc_auth_register
id|svc_auth_register
c_func
(paren
id|rpc_authflavor_t
id|flavor
comma
r_struct
id|auth_ops
op_star
id|aops
)paren
(brace
r_int
id|rv
op_assign
op_minus
id|EINVAL
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|authtab_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|flavor
OL
id|RPC_AUTH_MAXFLAVOR
op_logical_and
id|authtab
(braket
id|flavor
)braket
op_eq
l_int|NULL
)paren
(brace
id|authtab
(braket
id|flavor
)braket
op_assign
id|aops
suffix:semicolon
id|rv
op_assign
l_int|0
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|authtab_lock
)paren
suffix:semicolon
r_return
id|rv
suffix:semicolon
)brace
r_void
DECL|function|svc_auth_unregister
id|svc_auth_unregister
c_func
(paren
id|rpc_authflavor_t
id|flavor
)paren
(brace
id|spin_lock
c_func
(paren
op_amp
id|authtab_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|flavor
OL
id|RPC_AUTH_MAXFLAVOR
)paren
id|authtab
(braket
id|flavor
)braket
op_assign
l_int|NULL
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|authtab_lock
)paren
suffix:semicolon
)brace
DECL|variable|svc_auth_unregister
id|EXPORT_SYMBOL
c_func
(paren
id|svc_auth_unregister
)paren
suffix:semicolon
multiline_comment|/**************************************************&n; * cache for domain name to auth_domain&n; * Entries are only added by flavours which will normally&n; * have a structure that &squot;inherits&squot; from auth_domain.&n; * e.g. when an IP -&gt; domainname is given to  auth_unix,&n; * and the domain name doesn&squot;t exist, it will create a&n; * auth_unix_domain and add it to this hash table.&n; * If it finds the name does exist, but isn&squot;t AUTH_UNIX,&n; * it will complain.&n; */
multiline_comment|/*&n; * Auth auth_domain cache is somewhat different to other caches,&n; * largely because the entries are possibly of different types:&n; * each auth flavour has it&squot;s own type.&n; * One consequence of this that DefineCacheLookup cannot&n; * allocate a new structure as it cannot know the size.&n; * Notice that the &quot;INIT&quot; code fragment is quite different&n; * from other caches.  When auth_domain_lookup might be&n; * creating a new domain, the new domain is passed in&n; * complete and it is used as-is rather than being copied into&n; * another structure.&n; */
DECL|macro|DN_HASHBITS
mdefine_line|#define&t;DN_HASHBITS&t;6
DECL|macro|DN_HASHMAX
mdefine_line|#define&t;DN_HASHMAX&t;(1&lt;&lt;DN_HASHBITS)
DECL|macro|DN_HASHMASK
mdefine_line|#define&t;DN_HASHMASK&t;(DN_HASHMAX-1)
DECL|variable|auth_domain_table
r_static
r_struct
id|cache_head
op_star
id|auth_domain_table
(braket
id|DN_HASHMAX
)braket
suffix:semicolon
DECL|function|auth_domain_drop
r_static
r_void
id|auth_domain_drop
c_func
(paren
r_struct
id|cache_head
op_star
id|item
comma
r_struct
id|cache_detail
op_star
id|cd
)paren
(brace
r_struct
id|auth_domain
op_star
id|dom
op_assign
id|container_of
c_func
(paren
id|item
comma
r_struct
id|auth_domain
comma
id|h
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cache_put
c_func
(paren
id|item
comma
id|cd
)paren
)paren
id|authtab
(braket
id|dom-&gt;flavour
)braket
op_member_access_from_pointer
id|domain_release
c_func
(paren
id|dom
)paren
suffix:semicolon
)brace
DECL|variable|auth_domain_cache
r_struct
id|cache_detail
id|auth_domain_cache
op_assign
(brace
dot
id|hash_size
op_assign
id|DN_HASHMAX
comma
dot
id|hash_table
op_assign
id|auth_domain_table
comma
dot
id|name
op_assign
l_string|&quot;auth.domain&quot;
comma
dot
id|cache_put
op_assign
id|auth_domain_drop
comma
)brace
suffix:semicolon
DECL|function|auth_domain_put
r_void
id|auth_domain_put
c_func
(paren
r_struct
id|auth_domain
op_star
id|dom
)paren
(brace
id|auth_domain_drop
c_func
(paren
op_amp
id|dom-&gt;h
comma
op_amp
id|auth_domain_cache
)paren
suffix:semicolon
)brace
DECL|function|auth_domain_hash
r_static
r_inline
r_int
id|auth_domain_hash
c_func
(paren
r_struct
id|auth_domain
op_star
id|item
)paren
(brace
r_return
id|hash_str
c_func
(paren
id|item-&gt;name
comma
id|DN_HASHBITS
)paren
suffix:semicolon
)brace
DECL|function|auth_domain_match
r_static
r_inline
r_int
id|auth_domain_match
c_func
(paren
r_struct
id|auth_domain
op_star
id|tmp
comma
r_struct
id|auth_domain
op_star
id|item
)paren
(brace
r_return
id|strcmp
c_func
(paren
id|tmp-&gt;name
comma
id|item-&gt;name
)paren
op_eq
l_int|0
suffix:semicolon
)brace
r_struct
id|auth_domain
op_star
DECL|function|auth_domain_lookup
id|auth_domain_lookup
c_func
(paren
r_struct
id|auth_domain
op_star
id|item
comma
r_int
id|set
)paren
(brace
r_struct
id|auth_domain
op_star
id|tmp
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|cache_head
op_star
op_star
id|hp
comma
op_star
op_star
id|head
suffix:semicolon
id|head
op_assign
op_amp
id|auth_domain_cache.hash_table
(braket
id|auth_domain_hash
c_func
(paren
id|item
)paren
)braket
suffix:semicolon
r_if
c_cond
(paren
id|set
)paren
id|write_lock
c_func
(paren
op_amp
id|auth_domain_cache.hash_lock
)paren
suffix:semicolon
r_else
id|read_lock
c_func
(paren
op_amp
id|auth_domain_cache.hash_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|hp
op_assign
id|head
suffix:semicolon
op_star
id|hp
op_ne
l_int|NULL
suffix:semicolon
id|hp
op_assign
op_amp
id|tmp-&gt;h.next
)paren
(brace
id|tmp
op_assign
id|container_of
c_func
(paren
op_star
id|hp
comma
r_struct
id|auth_domain
comma
id|h
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|auth_domain_match
c_func
(paren
id|tmp
comma
id|item
)paren
)paren
r_continue
suffix:semicolon
id|cache_get
c_func
(paren
op_amp
id|tmp-&gt;h
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|set
)paren
r_goto
id|out_noset
suffix:semicolon
op_star
id|hp
op_assign
id|tmp-&gt;h.next
suffix:semicolon
id|tmp-&gt;h.next
op_assign
l_int|NULL
suffix:semicolon
id|clear_bit
c_func
(paren
id|CACHE_HASHED
comma
op_amp
id|tmp-&gt;h.flags
)paren
suffix:semicolon
id|auth_domain_drop
c_func
(paren
op_amp
id|tmp-&gt;h
comma
op_amp
id|auth_domain_cache
)paren
suffix:semicolon
r_goto
id|out_set
suffix:semicolon
)brace
multiline_comment|/* Didn&squot;t find anything */
r_if
c_cond
(paren
op_logical_neg
id|set
)paren
r_goto
id|out_nada
suffix:semicolon
id|auth_domain_cache.entries
op_increment
suffix:semicolon
id|out_set
suffix:colon
id|set_bit
c_func
(paren
id|CACHE_HASHED
comma
op_amp
id|item-&gt;h.flags
)paren
suffix:semicolon
id|item-&gt;h.next
op_assign
op_star
id|head
suffix:semicolon
op_star
id|head
op_assign
op_amp
id|item-&gt;h
suffix:semicolon
id|write_unlock
c_func
(paren
op_amp
id|auth_domain_cache.hash_lock
)paren
suffix:semicolon
id|cache_fresh
c_func
(paren
op_amp
id|auth_domain_cache
comma
op_amp
id|item-&gt;h
comma
id|item-&gt;h.expiry_time
)paren
suffix:semicolon
id|cache_get
c_func
(paren
op_amp
id|item-&gt;h
)paren
suffix:semicolon
r_return
id|item
suffix:semicolon
id|out_nada
suffix:colon
id|tmp
op_assign
l_int|NULL
suffix:semicolon
id|out_noset
suffix:colon
id|read_unlock
c_func
(paren
op_amp
id|auth_domain_cache.hash_lock
)paren
suffix:semicolon
r_return
id|tmp
suffix:semicolon
)brace
DECL|function|auth_domain_find
r_struct
id|auth_domain
op_star
id|auth_domain_find
c_func
(paren
r_char
op_star
id|name
)paren
(brace
r_struct
id|auth_domain
op_star
id|rv
comma
id|ad
suffix:semicolon
id|ad.name
op_assign
id|name
suffix:semicolon
id|rv
op_assign
id|auth_domain_lookup
c_func
(paren
op_amp
id|ad
comma
l_int|0
)paren
suffix:semicolon
r_return
id|rv
suffix:semicolon
)brace
eof
