multiline_comment|/*&n; *  linux/net/sunrpc/gss_mech_switch.c&n; *&n; *  Copyright (c) 2001 The Regents of the University of Michigan.&n; *  All rights reserved.&n; *&n; *  J. Bruce Fields   &lt;bfields@umich.edu&gt;&n; *&n; *  Redistribution and use in source and binary forms, with or without &n; *  modification, are permitted provided that the following conditions&n; *  are met:&n; *&n; *  1. Redistributions of source code must retain the above copyright&n; *     notice, this list of conditions and the following disclaimer.&n; *  2. Redistributions in binary form must reproduce the above copyright&n; *     notice, this list of conditions and the following disclaimer in the &n; *     documentation and/or other materials provided with the distribution.&n; *  3. Neither the name of the University nor the names of its&n; *     contributors may be used to endorse or promote products derived&n; *     from this software without specific prior written permission.&n; *&n; *  THIS SOFTWARE IS PROVIDED ``AS IS&squot;&squot; AND ANY EXPRESS OR IMPLIED&n; *  WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF&n; *  MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE&n; *  DISCLAIMED. IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE&n; *  FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR&n; *  CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF&n; *  SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR&n; *  BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF&n; *  LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING&n; *  NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS&n; *  SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.&n; *&n; */
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/socket.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/sunrpc/msg_prot.h&gt;
macro_line|#include &lt;linux/sunrpc/gss_asn1.h&gt;
macro_line|#include &lt;linux/sunrpc/auth_gss.h&gt;
macro_line|#include &lt;linux/sunrpc/svcauth_gss.h&gt;
macro_line|#include &lt;linux/sunrpc/gss_err.h&gt;
macro_line|#include &lt;linux/sunrpc/sched.h&gt;
macro_line|#include &lt;linux/sunrpc/gss_api.h&gt;
macro_line|#include &lt;linux/sunrpc/clnt.h&gt;
macro_line|#ifdef RPC_DEBUG
DECL|macro|RPCDBG_FACILITY
macro_line|# define RPCDBG_FACILITY        RPCDBG_AUTH
macro_line|#endif
r_static
id|LIST_HEAD
c_func
(paren
id|registered_mechs
)paren
suffix:semicolon
r_static
id|DEFINE_SPINLOCK
c_func
(paren
id|registered_mechs_lock
)paren
suffix:semicolon
r_static
r_void
DECL|function|gss_mech_free
id|gss_mech_free
c_func
(paren
r_struct
id|gss_api_mech
op_star
id|gm
)paren
(brace
r_struct
id|pf_desc
op_star
id|pf
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|gm-&gt;gm_pf_num
suffix:semicolon
id|i
op_increment
)paren
(brace
id|pf
op_assign
op_amp
id|gm-&gt;gm_pfs
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|pf-&gt;auth_domain_name
)paren
id|kfree
c_func
(paren
id|pf-&gt;auth_domain_name
)paren
suffix:semicolon
id|pf-&gt;auth_domain_name
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
r_static
r_inline
r_char
op_star
DECL|function|make_auth_domain_name
id|make_auth_domain_name
c_func
(paren
r_char
op_star
id|name
)paren
(brace
r_static
r_char
op_star
id|prefix
op_assign
l_string|&quot;gss/&quot;
suffix:semicolon
r_char
op_star
r_new
suffix:semicolon
r_new
op_assign
id|kmalloc
c_func
(paren
id|strlen
c_func
(paren
id|name
)paren
op_plus
id|strlen
c_func
(paren
id|prefix
)paren
op_plus
l_int|1
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
r_new
)paren
(brace
id|strcpy
c_func
(paren
r_new
comma
id|prefix
)paren
suffix:semicolon
id|strcat
c_func
(paren
r_new
comma
id|name
)paren
suffix:semicolon
)brace
r_return
r_new
suffix:semicolon
)brace
r_static
r_int
DECL|function|gss_mech_svc_setup
id|gss_mech_svc_setup
c_func
(paren
r_struct
id|gss_api_mech
op_star
id|gm
)paren
(brace
r_struct
id|pf_desc
op_star
id|pf
suffix:semicolon
r_int
id|i
comma
id|status
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|gm-&gt;gm_pf_num
suffix:semicolon
id|i
op_increment
)paren
(brace
id|pf
op_assign
op_amp
id|gm-&gt;gm_pfs
(braket
id|i
)braket
suffix:semicolon
id|pf-&gt;auth_domain_name
op_assign
id|make_auth_domain_name
c_func
(paren
id|pf-&gt;name
)paren
suffix:semicolon
id|status
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
id|pf-&gt;auth_domain_name
op_eq
l_int|NULL
)paren
r_goto
id|out
suffix:semicolon
id|status
op_assign
id|svcauth_gss_register_pseudoflavor
c_func
(paren
id|pf-&gt;pseudoflavor
comma
id|pf-&gt;auth_domain_name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
r_goto
id|out
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
id|out
suffix:colon
id|gss_mech_free
c_func
(paren
id|gm
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
r_int
DECL|function|gss_mech_register
id|gss_mech_register
c_func
(paren
r_struct
id|gss_api_mech
op_star
id|gm
)paren
(brace
r_int
id|status
suffix:semicolon
id|status
op_assign
id|gss_mech_svc_setup
c_func
(paren
id|gm
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
r_return
id|status
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|registered_mechs_lock
)paren
suffix:semicolon
id|list_add
c_func
(paren
op_amp
id|gm-&gt;gm_list
comma
op_amp
id|registered_mechs
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|registered_mechs_lock
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;RPC:      registered gss mechanism %s&bslash;n&quot;
comma
id|gm-&gt;gm_name
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|gss_mech_register
id|EXPORT_SYMBOL
c_func
(paren
id|gss_mech_register
)paren
suffix:semicolon
r_void
DECL|function|gss_mech_unregister
id|gss_mech_unregister
c_func
(paren
r_struct
id|gss_api_mech
op_star
id|gm
)paren
(brace
id|spin_lock
c_func
(paren
op_amp
id|registered_mechs_lock
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|gm-&gt;gm_list
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|registered_mechs_lock
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;RPC:      unregistered gss mechanism %s&bslash;n&quot;
comma
id|gm-&gt;gm_name
)paren
suffix:semicolon
id|gss_mech_free
c_func
(paren
id|gm
)paren
suffix:semicolon
)brace
DECL|variable|gss_mech_unregister
id|EXPORT_SYMBOL
c_func
(paren
id|gss_mech_unregister
)paren
suffix:semicolon
r_struct
id|gss_api_mech
op_star
DECL|function|gss_mech_get
id|gss_mech_get
c_func
(paren
r_struct
id|gss_api_mech
op_star
id|gm
)paren
(brace
id|__module_get
c_func
(paren
id|gm-&gt;gm_owner
)paren
suffix:semicolon
r_return
id|gm
suffix:semicolon
)brace
DECL|variable|gss_mech_get
id|EXPORT_SYMBOL
c_func
(paren
id|gss_mech_get
)paren
suffix:semicolon
r_struct
id|gss_api_mech
op_star
DECL|function|gss_mech_get_by_name
id|gss_mech_get_by_name
c_func
(paren
r_const
r_char
op_star
id|name
)paren
(brace
r_struct
id|gss_api_mech
op_star
id|pos
comma
op_star
id|gm
op_assign
l_int|NULL
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|registered_mechs_lock
)paren
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|pos
comma
op_amp
id|registered_mechs
comma
id|gm_list
)paren
(brace
r_if
c_cond
(paren
l_int|0
op_eq
id|strcmp
c_func
(paren
id|name
comma
id|pos-&gt;gm_name
)paren
)paren
(brace
r_if
c_cond
(paren
id|try_module_get
c_func
(paren
id|pos-&gt;gm_owner
)paren
)paren
id|gm
op_assign
id|pos
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|spin_unlock
c_func
(paren
op_amp
id|registered_mechs_lock
)paren
suffix:semicolon
r_return
id|gm
suffix:semicolon
)brace
DECL|variable|gss_mech_get_by_name
id|EXPORT_SYMBOL
c_func
(paren
id|gss_mech_get_by_name
)paren
suffix:semicolon
r_static
r_inline
r_int
DECL|function|mech_supports_pseudoflavor
id|mech_supports_pseudoflavor
c_func
(paren
r_struct
id|gss_api_mech
op_star
id|gm
comma
id|u32
id|pseudoflavor
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|gm-&gt;gm_pf_num
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|gm-&gt;gm_pfs
(braket
id|i
)braket
dot
id|pseudoflavor
op_eq
id|pseudoflavor
)paren
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_struct
id|gss_api_mech
op_star
DECL|function|gss_mech_get_by_pseudoflavor
id|gss_mech_get_by_pseudoflavor
c_func
(paren
id|u32
id|pseudoflavor
)paren
(brace
r_struct
id|gss_api_mech
op_star
id|pos
comma
op_star
id|gm
op_assign
l_int|NULL
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|registered_mechs_lock
)paren
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|pos
comma
op_amp
id|registered_mechs
comma
id|gm_list
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|mech_supports_pseudoflavor
c_func
(paren
id|pos
comma
id|pseudoflavor
)paren
)paren
(brace
id|module_put
c_func
(paren
id|pos-&gt;gm_owner
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|try_module_get
c_func
(paren
id|pos-&gt;gm_owner
)paren
)paren
id|gm
op_assign
id|pos
suffix:semicolon
r_break
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|registered_mechs_lock
)paren
suffix:semicolon
r_return
id|gm
suffix:semicolon
)brace
DECL|variable|gss_mech_get_by_pseudoflavor
id|EXPORT_SYMBOL
c_func
(paren
id|gss_mech_get_by_pseudoflavor
)paren
suffix:semicolon
id|u32
DECL|function|gss_pseudoflavor_to_service
id|gss_pseudoflavor_to_service
c_func
(paren
r_struct
id|gss_api_mech
op_star
id|gm
comma
id|u32
id|pseudoflavor
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|gm-&gt;gm_pf_num
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|gm-&gt;gm_pfs
(braket
id|i
)braket
dot
id|pseudoflavor
op_eq
id|pseudoflavor
)paren
r_return
id|gm-&gt;gm_pfs
(braket
id|i
)braket
dot
id|service
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|gss_pseudoflavor_to_service
id|EXPORT_SYMBOL
c_func
(paren
id|gss_pseudoflavor_to_service
)paren
suffix:semicolon
r_char
op_star
DECL|function|gss_service_to_auth_domain_name
id|gss_service_to_auth_domain_name
c_func
(paren
r_struct
id|gss_api_mech
op_star
id|gm
comma
id|u32
id|service
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|gm-&gt;gm_pf_num
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|gm-&gt;gm_pfs
(braket
id|i
)braket
dot
id|service
op_eq
id|service
)paren
r_return
id|gm-&gt;gm_pfs
(braket
id|i
)braket
dot
id|auth_domain_name
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|variable|gss_service_to_auth_domain_name
id|EXPORT_SYMBOL
c_func
(paren
id|gss_service_to_auth_domain_name
)paren
suffix:semicolon
r_void
DECL|function|gss_mech_put
id|gss_mech_put
c_func
(paren
r_struct
id|gss_api_mech
op_star
id|gm
)paren
(brace
id|module_put
c_func
(paren
id|gm-&gt;gm_owner
)paren
suffix:semicolon
)brace
DECL|variable|gss_mech_put
id|EXPORT_SYMBOL
c_func
(paren
id|gss_mech_put
)paren
suffix:semicolon
multiline_comment|/* The mech could probably be determined from the token instead, but it&squot;s just&n; * as easy for now to pass it in. */
r_int
DECL|function|gss_import_sec_context
id|gss_import_sec_context
c_func
(paren
r_const
r_void
op_star
id|input_token
comma
r_int
id|bufsize
comma
r_struct
id|gss_api_mech
op_star
id|mech
comma
r_struct
id|gss_ctx
op_star
op_star
id|ctx_id
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
op_star
id|ctx_id
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
op_star
id|ctx_id
)paren
comma
id|GFP_KERNEL
)paren
)paren
)paren
r_return
id|GSS_S_FAILURE
suffix:semicolon
id|memset
c_func
(paren
op_star
id|ctx_id
comma
l_int|0
comma
r_sizeof
(paren
op_star
op_star
id|ctx_id
)paren
)paren
suffix:semicolon
(paren
op_star
id|ctx_id
)paren
op_member_access_from_pointer
id|mech_type
op_assign
id|gss_mech_get
c_func
(paren
id|mech
)paren
suffix:semicolon
r_return
id|mech-&gt;gm_ops
op_member_access_from_pointer
id|gss_import_sec_context
c_func
(paren
id|input_token
comma
id|bufsize
comma
op_star
id|ctx_id
)paren
suffix:semicolon
)brace
multiline_comment|/* gss_get_mic: compute a mic over message and return mic_token. */
id|u32
DECL|function|gss_get_mic
id|gss_get_mic
c_func
(paren
r_struct
id|gss_ctx
op_star
id|context_handle
comma
id|u32
id|qop
comma
r_struct
id|xdr_buf
op_star
id|message
comma
r_struct
id|xdr_netobj
op_star
id|mic_token
)paren
(brace
r_return
id|context_handle-&gt;mech_type-&gt;gm_ops
op_member_access_from_pointer
id|gss_get_mic
c_func
(paren
id|context_handle
comma
id|qop
comma
id|message
comma
id|mic_token
)paren
suffix:semicolon
)brace
multiline_comment|/* gss_verify_mic: check whether the provided mic_token verifies message. */
id|u32
DECL|function|gss_verify_mic
id|gss_verify_mic
c_func
(paren
r_struct
id|gss_ctx
op_star
id|context_handle
comma
r_struct
id|xdr_buf
op_star
id|message
comma
r_struct
id|xdr_netobj
op_star
id|mic_token
comma
id|u32
op_star
id|qstate
)paren
(brace
r_return
id|context_handle-&gt;mech_type-&gt;gm_ops
op_member_access_from_pointer
id|gss_verify_mic
c_func
(paren
id|context_handle
comma
id|message
comma
id|mic_token
comma
id|qstate
)paren
suffix:semicolon
)brace
multiline_comment|/* gss_delete_sec_context: free all resources associated with context_handle.&n; * Note this differs from the RFC 2744-specified prototype in that we don&squot;t&n; * bother returning an output token, since it would never be used anyway. */
id|u32
DECL|function|gss_delete_sec_context
id|gss_delete_sec_context
c_func
(paren
r_struct
id|gss_ctx
op_star
op_star
id|context_handle
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;RPC:      gss_delete_sec_context deleting %p&bslash;n&quot;
comma
op_star
id|context_handle
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
op_star
id|context_handle
)paren
r_return
id|GSS_S_NO_CONTEXT
suffix:semicolon
r_if
c_cond
(paren
(paren
op_star
id|context_handle
)paren
op_member_access_from_pointer
id|internal_ctx_id
op_ne
l_int|0
)paren
(paren
op_star
id|context_handle
)paren
op_member_access_from_pointer
id|mech_type-&gt;gm_ops
op_member_access_from_pointer
id|gss_delete_sec_context
c_func
(paren
(paren
op_star
id|context_handle
)paren
op_member_access_from_pointer
id|internal_ctx_id
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_star
id|context_handle
)paren
op_member_access_from_pointer
id|mech_type
)paren
id|gss_mech_put
c_func
(paren
(paren
op_star
id|context_handle
)paren
op_member_access_from_pointer
id|mech_type
)paren
suffix:semicolon
id|kfree
c_func
(paren
op_star
id|context_handle
)paren
suffix:semicolon
op_star
id|context_handle
op_assign
l_int|NULL
suffix:semicolon
r_return
id|GSS_S_COMPLETE
suffix:semicolon
)brace
eof
