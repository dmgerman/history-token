multiline_comment|/*&n; *  linux/net/sunrpc/gss_union.c&n; *&n; *  Adapted from MIT Kerberos 5-1.2.1 lib/gssapi/generic code&n; *&n; *  Copyright (c) 2001 The Regents of the University of Michigan.&n; *  All rights reserved.&n; *&n; *  Andy Adamson   &lt;andros@umich.edu&gt;&n; *&n; */
multiline_comment|/*&n; * Copyright 1993 by OpenVision Technologies, Inc.&n; *&n; * Permission to use, copy, modify, distribute, and sell this software&n; * and its documentation for any purpose is hereby granted without fee,&n; * provided that the above copyright notice appears in all copies and&n; * that both that copyright notice and this permission notice appear in&n; * supporting documentation, and that the name of OpenVision not be used&n; * in advertising or publicity pertaining to distribution of the software&n; * without specific, written prior permission. OpenVision makes no&n; * representations about the suitability of this software for any&n; * purpose.  It is provided &quot;as is&quot; without express or implied warranty.&n; *&n; * OPENVISION DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE,&n; * INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS, IN NO&n; * EVENT SHALL OPENVISION BE LIABLE FOR ANY SPECIAL, INDIRECT OR&n; * CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF&n; * USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR&n; * OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR&n; * PERFORMANCE OF THIS SOFTWARE.&n; */
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/socket.h&gt;
macro_line|#include &lt;linux/sunrpc/gss_asn1.h&gt;
macro_line|#include &lt;linux/sunrpc/auth_gss.h&gt;
macro_line|#ifdef RPC_DEBUG
DECL|macro|RPCDBG_FACILITY
macro_line|# define RPCDBG_FACILITY        RPCDBG_AUTH
macro_line|#endif
r_static
id|LIST_HEAD
c_func
(paren
id|registered_triples
)paren
suffix:semicolon
DECL|variable|registered_triples_lock
r_static
id|spinlock_t
id|registered_triples_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
multiline_comment|/* The following must be called with spinlock held: */
r_static
r_struct
id|sup_sec_triple
op_star
DECL|function|do_lookup_triple_by_pseudoflavor
id|do_lookup_triple_by_pseudoflavor
c_func
(paren
id|u32
id|pseudoflavor
)paren
(brace
r_struct
id|sup_sec_triple
op_star
id|pos
comma
op_star
id|triple
op_assign
l_int|NULL
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|pos
comma
op_amp
id|registered_triples
comma
id|triples
)paren
(brace
r_if
c_cond
(paren
id|pos-&gt;pseudoflavor
op_eq
id|pseudoflavor
)paren
(brace
id|triple
op_assign
id|pos
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_return
id|triple
suffix:semicolon
)brace
multiline_comment|/* XXX Need to think about reference counting of triples and of mechs.&n; * Currently we do no reference counting of triples, and I think that&squot;s&n; * probably OK given the reference counting on mechs, but there&squot;s probably&n; * a better way to do all this. */
r_int
DECL|function|gss_register_triple
id|gss_register_triple
c_func
(paren
id|u32
id|pseudoflavor
comma
r_struct
id|gss_api_mech
op_star
id|mech
comma
id|u32
id|qop
comma
id|u32
id|service
)paren
(brace
r_struct
id|sup_sec_triple
op_star
id|triple
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|triple
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|triple
)paren
comma
id|GFP_KERNEL
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Alloc failed in gss_register_triple&quot;
)paren
suffix:semicolon
r_goto
id|err
suffix:semicolon
)brace
id|triple-&gt;pseudoflavor
op_assign
id|pseudoflavor
suffix:semicolon
id|triple-&gt;mech
op_assign
id|gss_mech_get_by_OID
c_func
(paren
op_amp
id|mech-&gt;gm_oid
)paren
suffix:semicolon
id|triple-&gt;qop
op_assign
id|qop
suffix:semicolon
id|triple-&gt;service
op_assign
id|service
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|registered_triples_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|do_lookup_triple_by_pseudoflavor
c_func
(paren
id|pseudoflavor
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Registered pseudoflavor %d again&bslash;n&quot;
comma
id|pseudoflavor
)paren
suffix:semicolon
r_goto
id|err_unlock
suffix:semicolon
)brace
id|list_add
c_func
(paren
op_amp
id|triple-&gt;triples
comma
op_amp
id|registered_triples
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|registered_triples_lock
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;RPC: registered pseudoflavor %d&bslash;n&quot;
comma
id|pseudoflavor
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|err_unlock
suffix:colon
id|kfree
c_func
(paren
id|triple
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|registered_triples_lock
)paren
suffix:semicolon
id|err
suffix:colon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_int
DECL|function|gss_unregister_triple
id|gss_unregister_triple
c_func
(paren
id|u32
id|pseudoflavor
)paren
(brace
r_struct
id|sup_sec_triple
op_star
id|triple
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|registered_triples_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|triple
op_assign
id|do_lookup_triple_by_pseudoflavor
c_func
(paren
id|pseudoflavor
)paren
)paren
)paren
(brace
id|spin_unlock
c_func
(paren
op_amp
id|registered_triples_lock
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Can&squot;t unregister unregistered pseudoflavor %d&bslash;n&quot;
comma
id|pseudoflavor
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|list_del
c_func
(paren
op_amp
id|triple-&gt;triples
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|registered_triples_lock
)paren
suffix:semicolon
id|gss_mech_put
c_func
(paren
id|triple-&gt;mech
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|triple
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_void
DECL|function|print_sec_triple
id|print_sec_triple
c_func
(paren
r_struct
id|xdr_netobj
op_star
id|oid
comma
id|u32
id|qop
comma
id|u32
id|service
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;RPC: print_sec_triple:&bslash;n&quot;
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;                     oid_len %d&bslash;n  oid :&bslash;n&quot;
comma
id|oid-&gt;len
)paren
suffix:semicolon
id|print_hexl
c_func
(paren
(paren
id|u32
op_star
)paren
id|oid-&gt;data
comma
id|oid-&gt;len
comma
l_int|0
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;                     qop %d&bslash;n&quot;
comma
id|qop
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;                     service %d&bslash;n&quot;
comma
id|service
)paren
suffix:semicolon
)brace
multiline_comment|/* Function: gss_get_cmp_triples&n; *&n; * Description: search sec_triples for a matching security triple&n; * return pseudoflavor if match, else 0&n; * (Note that 0 is a valid pseudoflavor, but not for any gss pseudoflavor&n; * (0 means auth_null), so this shouldn&squot;t cause confusion.)&n; */
id|u32
DECL|function|gss_cmp_triples
id|gss_cmp_triples
c_func
(paren
id|u32
id|oid_len
comma
r_char
op_star
id|oid_data
comma
id|u32
id|qop
comma
id|u32
id|service
)paren
(brace
r_struct
id|sup_sec_triple
op_star
id|triple
suffix:semicolon
id|u32
id|pseudoflavor
op_assign
l_int|0
suffix:semicolon
r_struct
id|xdr_netobj
id|oid
suffix:semicolon
id|oid.len
op_assign
id|oid_len
suffix:semicolon
id|oid.data
op_assign
id|oid_data
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;RPC: gss_cmp_triples &bslash;n&quot;
)paren
suffix:semicolon
id|print_sec_triple
c_func
(paren
op_amp
id|oid
comma
id|qop
comma
id|service
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|registered_triples_lock
)paren
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|triple
comma
op_amp
id|registered_triples
comma
id|triples
)paren
(brace
r_if
c_cond
(paren
(paren
id|g_OID_equal
c_func
(paren
op_amp
id|oid
comma
op_amp
id|triple-&gt;mech-&gt;gm_oid
)paren
)paren
op_logical_and
(paren
id|qop
op_eq
id|triple-&gt;qop
)paren
op_logical_and
(paren
id|service
op_eq
id|triple-&gt;service
)paren
)paren
(brace
id|pseudoflavor
op_assign
id|triple-&gt;pseudoflavor
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|spin_unlock
c_func
(paren
op_amp
id|registered_triples_lock
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;RPC: gss_cmp_triples return %d&bslash;n&quot;
comma
id|pseudoflavor
)paren
suffix:semicolon
r_return
id|pseudoflavor
suffix:semicolon
)brace
id|u32
DECL|function|gss_get_pseudoflavor
id|gss_get_pseudoflavor
c_func
(paren
r_struct
id|gss_ctx
op_star
id|ctx
comma
id|u32
id|qop
comma
id|u32
id|service
)paren
(brace
r_return
id|gss_cmp_triples
c_func
(paren
id|ctx-&gt;mech_type-&gt;gm_oid.len
comma
id|ctx-&gt;mech_type-&gt;gm_oid.data
comma
id|qop
comma
id|service
)paren
suffix:semicolon
)brace
multiline_comment|/* Returns nonzero iff the given pseudoflavor is in the supported list.&n; * (Note that without incrementing a reference count or anything, this&n; * doesn&squot;t give any guarantees.) */
r_int
DECL|function|gss_pseudoflavor_supported
id|gss_pseudoflavor_supported
c_func
(paren
id|u32
id|pseudoflavor
)paren
(brace
r_struct
id|sup_sec_triple
op_star
id|triple
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|registered_triples_lock
)paren
suffix:semicolon
id|triple
op_assign
id|do_lookup_triple_by_pseudoflavor
c_func
(paren
id|pseudoflavor
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|registered_triples_lock
)paren
suffix:semicolon
r_return
(paren
id|triple
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
)brace
id|u32
DECL|function|gss_pseudoflavor_to_service
id|gss_pseudoflavor_to_service
c_func
(paren
id|u32
id|pseudoflavor
)paren
(brace
r_struct
id|sup_sec_triple
op_star
id|triple
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|registered_triples_lock
)paren
suffix:semicolon
id|triple
op_assign
id|do_lookup_triple_by_pseudoflavor
c_func
(paren
id|pseudoflavor
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|registered_triples_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|triple
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;RPC: gss_pseudoflavor_to_service called with&quot;
l_string|&quot; unsupported pseudoflavor %d&bslash;n&quot;
comma
id|pseudoflavor
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
id|triple-&gt;service
suffix:semicolon
)brace
r_struct
id|gss_api_mech
op_star
DECL|function|gss_pseudoflavor_to_mech
id|gss_pseudoflavor_to_mech
c_func
(paren
id|u32
id|pseudoflavor
)paren
(brace
r_struct
id|sup_sec_triple
op_star
id|triple
suffix:semicolon
r_struct
id|gss_api_mech
op_star
id|mech
op_assign
l_int|NULL
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|registered_triples_lock
)paren
suffix:semicolon
id|triple
op_assign
id|do_lookup_triple_by_pseudoflavor
c_func
(paren
id|pseudoflavor
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|registered_triples_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|triple
)paren
id|mech
op_assign
id|gss_mech_get
c_func
(paren
id|triple-&gt;mech
)paren
suffix:semicolon
r_else
id|dprintk
c_func
(paren
l_string|&quot;RPC: gss_pseudoflavor_to_mech called with&quot;
l_string|&quot; unsupported pseudoflavor %d&bslash;n&quot;
comma
id|pseudoflavor
)paren
suffix:semicolon
r_return
id|mech
suffix:semicolon
)brace
r_int
DECL|function|gss_pseudoflavor_to_mechOID
id|gss_pseudoflavor_to_mechOID
c_func
(paren
id|u32
id|pseudoflavor
comma
r_struct
id|xdr_netobj
op_star
id|oid
)paren
(brace
r_struct
id|gss_api_mech
op_star
id|mech
suffix:semicolon
id|mech
op_assign
id|gss_pseudoflavor_to_mech
c_func
(paren
id|pseudoflavor
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mech
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;RPC: gss_pseudoflavor_to_mechOID called with&quot;
l_string|&quot; unsupported pseudoflavor %d&bslash;n&quot;
comma
id|pseudoflavor
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|oid-&gt;len
op_assign
id|mech-&gt;gm_oid.len
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|oid-&gt;data
op_assign
id|kmalloc
c_func
(paren
id|oid-&gt;len
comma
id|GFP_KERNEL
)paren
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|memcpy
c_func
(paren
id|oid-&gt;data
comma
id|mech-&gt;gm_oid.data
comma
id|oid-&gt;len
)paren
suffix:semicolon
id|gss_mech_put
c_func
(paren
id|mech
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
eof
