multiline_comment|/*&n; * Neil Brown &lt;neilb@cse.unsw.edu.au&gt;&n; * J. Bruce Fields &lt;bfields@umich.edu&gt;&n; * Andy Adamson &lt;andros@umich.edu&gt;&n; * Dug Song &lt;dugsong@monkey.org&gt;&n; *&n; * RPCSEC_GSS server authentication.&n; * This implements RPCSEC_GSS as defined in rfc2203 (rpcsec_gss) and rfc2078&n; * (gssapi)&n; *&n; * The RPCSEC_GSS involves three stages:&n; *  1/ context creation&n; *  2/ data exchange&n; *  3/ context destruction&n; *&n; * Context creation is handled largely by upcalls to user-space.&n; *  In particular, GSS_Accept_sec_context is handled by an upcall&n; * Data exchange is handled entirely within the kernel&n; *  In particular, GSS_GetMIC, GSS_VerifyMIC, GSS_Seal, GSS_Unseal are in-kernel.&n; * Context destruction is handled in-kernel&n; *  GSS_Delete_sec_context is in-kernel&n; *&n; * Context creation is initiated by a RPCSEC_GSS_INIT request arriving.&n; * The context handle and gss_token are used as a key into the rpcsec_init cache.&n; * The content of this cache includes some of the outputs of GSS_Accept_sec_context,&n; * being major_status, minor_status, context_handle, reply_token.&n; * These are sent back to the client.&n; * Sequence window management is handled by the kernel.  The window size if currently&n; * a compile time constant.&n; *&n; * When user-space is happy that a context is established, it places an entry&n; * in the rpcsec_context cache. The key for this cache is the context_handle.&n; * The content includes:&n; *   uid/gidlist - for determining access rights&n; *   mechanism type&n; *   mechanism specific information, such as a key&n; *&n; */
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/pagemap.h&gt;
macro_line|#include &lt;linux/sunrpc/auth_gss.h&gt;
macro_line|#include &lt;linux/sunrpc/svcauth.h&gt;
macro_line|#include &lt;linux/sunrpc/gss_err.h&gt;
macro_line|#include &lt;linux/sunrpc/svcauth.h&gt;
macro_line|#include &lt;linux/sunrpc/svcauth_gss.h&gt;
macro_line|#include &lt;linux/sunrpc/cache.h&gt;
macro_line|#ifdef RPC_DEBUG
DECL|macro|RPCDBG_FACILITY
macro_line|# define RPCDBG_FACILITY&t;RPCDBG_AUTH
macro_line|#endif
multiline_comment|/* The rpcsec_init cache is used for mapping RPCSEC_GSS_{,CONT_}INIT requests&n; * into replies.&n; *&n; * Key is context handle (&bslash;x if empty) and gss_token.&n; * Content is major_status minor_status (integers) context_handle, reply_token.&n; *&n; */
DECL|function|netobj_equal
r_static
r_int
id|netobj_equal
c_func
(paren
r_struct
id|xdr_netobj
op_star
id|a
comma
r_struct
id|xdr_netobj
op_star
id|b
)paren
(brace
r_return
id|a-&gt;len
op_eq
id|b-&gt;len
op_logical_and
l_int|0
op_eq
id|memcmp
c_func
(paren
id|a-&gt;data
comma
id|b-&gt;data
comma
id|a-&gt;len
)paren
suffix:semicolon
)brace
DECL|macro|RSI_HASHBITS
mdefine_line|#define&t;RSI_HASHBITS&t;6
DECL|macro|RSI_HASHMAX
mdefine_line|#define&t;RSI_HASHMAX&t;(1&lt;&lt;RSI_HASHBITS)
DECL|macro|RSI_HASHMASK
mdefine_line|#define&t;RSI_HASHMASK&t;(RSI_HASHMAX-1)
DECL|struct|rsi
r_struct
id|rsi
(brace
DECL|member|h
r_struct
id|cache_head
id|h
suffix:semicolon
DECL|member|in_handle
DECL|member|in_token
r_struct
id|xdr_netobj
id|in_handle
comma
id|in_token
suffix:semicolon
DECL|member|out_handle
DECL|member|out_token
r_struct
id|xdr_netobj
id|out_handle
comma
id|out_token
suffix:semicolon
DECL|member|major_status
DECL|member|minor_status
r_int
id|major_status
comma
id|minor_status
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|rsi_table
r_static
r_struct
id|cache_head
op_star
id|rsi_table
(braket
id|RSI_HASHMAX
)braket
suffix:semicolon
DECL|variable|rsi_cache
r_static
r_struct
id|cache_detail
id|rsi_cache
suffix:semicolon
r_static
r_struct
id|rsi
op_star
id|rsi_lookup
c_func
(paren
r_struct
id|rsi
op_star
id|item
comma
r_int
id|set
)paren
suffix:semicolon
DECL|function|rsi_free
r_static
r_void
id|rsi_free
c_func
(paren
r_struct
id|rsi
op_star
id|rsii
)paren
(brace
id|kfree
c_func
(paren
id|rsii-&gt;in_handle.data
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|rsii-&gt;in_token.data
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|rsii-&gt;out_handle.data
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|rsii-&gt;out_token.data
)paren
suffix:semicolon
)brace
DECL|function|rsi_put
r_static
r_void
id|rsi_put
c_func
(paren
r_struct
id|cache_head
op_star
id|item
comma
r_struct
id|cache_detail
op_star
id|cd
)paren
(brace
r_struct
id|rsi
op_star
id|rsii
op_assign
id|container_of
c_func
(paren
id|item
comma
r_struct
id|rsi
comma
id|h
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cache_put
c_func
(paren
id|item
comma
id|cd
)paren
)paren
(brace
id|rsi_free
c_func
(paren
id|rsii
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|rsii
)paren
suffix:semicolon
)brace
)brace
DECL|function|rsi_hash
r_static
r_inline
r_int
id|rsi_hash
c_func
(paren
r_struct
id|rsi
op_star
id|item
)paren
(brace
r_return
id|hash_mem
c_func
(paren
id|item-&gt;in_handle.data
comma
id|item-&gt;in_handle.len
comma
id|RSI_HASHBITS
)paren
op_xor
id|hash_mem
c_func
(paren
id|item-&gt;in_token.data
comma
id|item-&gt;in_token.len
comma
id|RSI_HASHBITS
)paren
suffix:semicolon
)brace
DECL|function|rsi_match
r_static
r_inline
r_int
id|rsi_match
c_func
(paren
r_struct
id|rsi
op_star
id|item
comma
r_struct
id|rsi
op_star
id|tmp
)paren
(brace
r_return
id|netobj_equal
c_func
(paren
op_amp
id|item-&gt;in_handle
comma
op_amp
id|tmp-&gt;in_handle
)paren
op_logical_and
id|netobj_equal
c_func
(paren
op_amp
id|item-&gt;in_token
comma
op_amp
id|tmp-&gt;in_token
)paren
suffix:semicolon
)brace
DECL|function|dup_to_netobj
r_static
r_int
id|dup_to_netobj
c_func
(paren
r_struct
id|xdr_netobj
op_star
id|dst
comma
r_char
op_star
id|src
comma
r_int
id|len
)paren
(brace
id|dst-&gt;len
op_assign
id|len
suffix:semicolon
id|dst-&gt;data
op_assign
(paren
id|len
ques
c_cond
id|kmalloc
c_func
(paren
id|len
comma
id|GFP_KERNEL
)paren
suffix:colon
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dst-&gt;data
)paren
id|memcpy
c_func
(paren
id|dst-&gt;data
comma
id|src
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
op_logical_and
op_logical_neg
id|dst-&gt;data
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|dup_netobj
r_static
r_inline
r_int
id|dup_netobj
c_func
(paren
r_struct
id|xdr_netobj
op_star
id|dst
comma
r_struct
id|xdr_netobj
op_star
id|src
)paren
(brace
r_return
id|dup_to_netobj
c_func
(paren
id|dst
comma
id|src-&gt;data
comma
id|src-&gt;len
)paren
suffix:semicolon
)brace
DECL|function|rsi_init
r_static
r_inline
r_void
id|rsi_init
c_func
(paren
r_struct
id|rsi
op_star
r_new
comma
r_struct
id|rsi
op_star
id|item
)paren
(brace
r_new
op_member_access_from_pointer
id|out_handle.data
op_assign
l_int|NULL
suffix:semicolon
r_new
op_member_access_from_pointer
id|out_handle.len
op_assign
l_int|0
suffix:semicolon
r_new
op_member_access_from_pointer
id|out_token.data
op_assign
l_int|NULL
suffix:semicolon
r_new
op_member_access_from_pointer
id|out_token.len
op_assign
l_int|0
suffix:semicolon
r_new
op_member_access_from_pointer
id|in_handle.len
op_assign
id|item-&gt;in_handle.len
suffix:semicolon
id|item-&gt;in_handle.len
op_assign
l_int|0
suffix:semicolon
r_new
op_member_access_from_pointer
id|in_token.len
op_assign
id|item-&gt;in_token.len
suffix:semicolon
id|item-&gt;in_token.len
op_assign
l_int|0
suffix:semicolon
r_new
op_member_access_from_pointer
id|in_handle.data
op_assign
id|item-&gt;in_handle.data
suffix:semicolon
id|item-&gt;in_handle.data
op_assign
l_int|NULL
suffix:semicolon
r_new
op_member_access_from_pointer
id|in_token.data
op_assign
id|item-&gt;in_token.data
suffix:semicolon
id|item-&gt;in_token.data
op_assign
l_int|NULL
suffix:semicolon
)brace
DECL|function|rsi_update
r_static
r_inline
r_void
id|rsi_update
c_func
(paren
r_struct
id|rsi
op_star
r_new
comma
r_struct
id|rsi
op_star
id|item
)paren
(brace
id|BUG_ON
c_func
(paren
r_new
op_member_access_from_pointer
id|out_handle.data
op_logical_or
r_new
op_member_access_from_pointer
id|out_token.data
)paren
suffix:semicolon
r_new
op_member_access_from_pointer
id|out_handle.len
op_assign
id|item-&gt;out_handle.len
suffix:semicolon
id|item-&gt;out_handle.len
op_assign
l_int|0
suffix:semicolon
r_new
op_member_access_from_pointer
id|out_token.len
op_assign
id|item-&gt;out_token.len
suffix:semicolon
id|item-&gt;out_token.len
op_assign
l_int|0
suffix:semicolon
r_new
op_member_access_from_pointer
id|out_handle.data
op_assign
id|item-&gt;out_handle.data
suffix:semicolon
id|item-&gt;out_handle.data
op_assign
l_int|NULL
suffix:semicolon
r_new
op_member_access_from_pointer
id|out_token.data
op_assign
id|item-&gt;out_token.data
suffix:semicolon
id|item-&gt;out_token.data
op_assign
l_int|NULL
suffix:semicolon
r_new
op_member_access_from_pointer
id|major_status
op_assign
id|item-&gt;major_status
suffix:semicolon
r_new
op_member_access_from_pointer
id|minor_status
op_assign
id|item-&gt;minor_status
suffix:semicolon
)brace
DECL|function|rsi_request
r_static
r_void
id|rsi_request
c_func
(paren
r_struct
id|cache_detail
op_star
id|cd
comma
r_struct
id|cache_head
op_star
id|h
comma
r_char
op_star
op_star
id|bpp
comma
r_int
op_star
id|blen
)paren
(brace
r_struct
id|rsi
op_star
id|rsii
op_assign
id|container_of
c_func
(paren
id|h
comma
r_struct
id|rsi
comma
id|h
)paren
suffix:semicolon
id|qword_addhex
c_func
(paren
id|bpp
comma
id|blen
comma
id|rsii-&gt;in_handle.data
comma
id|rsii-&gt;in_handle.len
)paren
suffix:semicolon
id|qword_addhex
c_func
(paren
id|bpp
comma
id|blen
comma
id|rsii-&gt;in_token.data
comma
id|rsii-&gt;in_token.len
)paren
suffix:semicolon
(paren
op_star
id|bpp
)paren
(braket
op_minus
l_int|1
)braket
op_assign
l_char|&squot;&bslash;n&squot;
suffix:semicolon
)brace
DECL|function|rsi_parse
r_static
r_int
id|rsi_parse
c_func
(paren
r_struct
id|cache_detail
op_star
id|cd
comma
r_char
op_star
id|mesg
comma
r_int
id|mlen
)paren
(brace
multiline_comment|/* context token expiry major minor context token */
r_char
op_star
id|buf
op_assign
id|mesg
suffix:semicolon
r_char
op_star
id|ep
suffix:semicolon
r_int
id|len
suffix:semicolon
r_struct
id|rsi
id|rsii
comma
op_star
id|rsip
op_assign
l_int|NULL
suffix:semicolon
id|time_t
id|expiry
suffix:semicolon
r_int
id|status
op_assign
op_minus
id|EINVAL
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|rsii
comma
l_int|0
comma
r_sizeof
(paren
id|rsii
)paren
)paren
suffix:semicolon
multiline_comment|/* handle */
id|len
op_assign
id|qword_get
c_func
(paren
op_amp
id|mesg
comma
id|buf
comma
id|mlen
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
l_int|0
)paren
r_goto
id|out
suffix:semicolon
id|status
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
id|dup_to_netobj
c_func
(paren
op_amp
id|rsii.in_handle
comma
id|buf
comma
id|len
)paren
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* token */
id|len
op_assign
id|qword_get
c_func
(paren
op_amp
id|mesg
comma
id|buf
comma
id|mlen
)paren
suffix:semicolon
id|status
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
l_int|0
)paren
r_goto
id|out
suffix:semicolon
id|status
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
id|dup_to_netobj
c_func
(paren
op_amp
id|rsii.in_token
comma
id|buf
comma
id|len
)paren
)paren
r_goto
id|out
suffix:semicolon
id|rsii.h.flags
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* expiry */
id|expiry
op_assign
id|get_expiry
c_func
(paren
op_amp
id|mesg
)paren
suffix:semicolon
id|status
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|expiry
op_eq
l_int|0
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* major/minor */
id|len
op_assign
id|qword_get
c_func
(paren
op_amp
id|mesg
comma
id|buf
comma
id|mlen
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
l_int|0
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|len
op_eq
l_int|0
)paren
(brace
r_goto
id|out
suffix:semicolon
)brace
r_else
(brace
id|rsii.major_status
op_assign
id|simple_strtoul
c_func
(paren
id|buf
comma
op_amp
id|ep
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|ep
)paren
r_goto
id|out
suffix:semicolon
id|len
op_assign
id|qword_get
c_func
(paren
op_amp
id|mesg
comma
id|buf
comma
id|mlen
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
op_le
l_int|0
)paren
r_goto
id|out
suffix:semicolon
id|rsii.minor_status
op_assign
id|simple_strtoul
c_func
(paren
id|buf
comma
op_amp
id|ep
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|ep
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* out_handle */
id|len
op_assign
id|qword_get
c_func
(paren
op_amp
id|mesg
comma
id|buf
comma
id|mlen
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
l_int|0
)paren
r_goto
id|out
suffix:semicolon
id|status
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
id|dup_to_netobj
c_func
(paren
op_amp
id|rsii.out_handle
comma
id|buf
comma
id|len
)paren
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* out_token */
id|len
op_assign
id|qword_get
c_func
(paren
op_amp
id|mesg
comma
id|buf
comma
id|mlen
)paren
suffix:semicolon
id|status
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
l_int|0
)paren
r_goto
id|out
suffix:semicolon
id|status
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
id|dup_to_netobj
c_func
(paren
op_amp
id|rsii.out_token
comma
id|buf
comma
id|len
)paren
)paren
r_goto
id|out
suffix:semicolon
)brace
id|rsii.h.expiry_time
op_assign
id|expiry
suffix:semicolon
id|rsip
op_assign
id|rsi_lookup
c_func
(paren
op_amp
id|rsii
comma
l_int|1
)paren
suffix:semicolon
id|status
op_assign
l_int|0
suffix:semicolon
id|out
suffix:colon
id|rsi_free
c_func
(paren
op_amp
id|rsii
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rsip
)paren
id|rsi_put
c_func
(paren
op_amp
id|rsip-&gt;h
comma
op_amp
id|rsi_cache
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
DECL|variable|rsi_cache
r_static
r_struct
id|cache_detail
id|rsi_cache
op_assign
(brace
dot
id|hash_size
op_assign
id|RSI_HASHMAX
comma
dot
id|hash_table
op_assign
id|rsi_table
comma
dot
id|name
op_assign
l_string|&quot;auth.rpcsec.init&quot;
comma
dot
id|cache_put
op_assign
id|rsi_put
comma
dot
id|cache_request
op_assign
id|rsi_request
comma
dot
id|cache_parse
op_assign
id|rsi_parse
comma
)brace
suffix:semicolon
r_static
id|DefineSimpleCacheLookup
c_func
(paren
id|rsi
comma
l_int|0
)paren
multiline_comment|/*&n; * The rpcsec_context cache is used to store a context that is&n; * used in data exchange.&n; * The key is a context handle. The content is:&n; *  uid, gidlist, mechanism, service-set, mech-specific-data&n; */
DECL|macro|RSC_HASHBITS
mdefine_line|#define&t;RSC_HASHBITS&t;10
DECL|macro|RSC_HASHMAX
mdefine_line|#define&t;RSC_HASHMAX&t;(1&lt;&lt;RSC_HASHBITS)
DECL|macro|RSC_HASHMASK
mdefine_line|#define&t;RSC_HASHMASK&t;(RSC_HASHMAX-1)
DECL|macro|GSS_SEQ_WIN
mdefine_line|#define GSS_SEQ_WIN&t;128
DECL|struct|gss_svc_seq_data
r_struct
id|gss_svc_seq_data
(brace
multiline_comment|/* highest seq number seen so far: */
DECL|member|sd_max
r_int
id|sd_max
suffix:semicolon
multiline_comment|/* for i such that sd_max-GSS_SEQ_WIN &lt; i &lt;= sd_max, the i-th bit of&n;&t; * sd_win is nonzero iff sequence number i has been seen already: */
DECL|member|sd_win
r_int
r_int
id|sd_win
(braket
id|GSS_SEQ_WIN
op_div
id|BITS_PER_LONG
)braket
suffix:semicolon
DECL|member|sd_lock
id|spinlock_t
id|sd_lock
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|rsc
r_struct
id|rsc
(brace
DECL|member|h
r_struct
id|cache_head
id|h
suffix:semicolon
DECL|member|handle
r_struct
id|xdr_netobj
id|handle
suffix:semicolon
DECL|member|cred
r_struct
id|svc_cred
id|cred
suffix:semicolon
DECL|member|seqdata
r_struct
id|gss_svc_seq_data
id|seqdata
suffix:semicolon
DECL|member|mechctx
r_struct
id|gss_ctx
op_star
id|mechctx
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|rsc_table
r_static
r_struct
id|cache_head
op_star
id|rsc_table
(braket
id|RSC_HASHMAX
)braket
suffix:semicolon
DECL|variable|rsc_cache
r_static
r_struct
id|cache_detail
id|rsc_cache
suffix:semicolon
r_static
r_struct
id|rsc
op_star
id|rsc_lookup
c_func
(paren
r_struct
id|rsc
op_star
id|item
comma
r_int
id|set
)paren
suffix:semicolon
DECL|function|rsc_free
r_static
r_void
id|rsc_free
c_func
(paren
r_struct
id|rsc
op_star
id|rsci
)paren
(brace
id|kfree
c_func
(paren
id|rsci-&gt;handle.data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rsci-&gt;mechctx
)paren
id|gss_delete_sec_context
c_func
(paren
op_amp
id|rsci-&gt;mechctx
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rsci-&gt;cred.cr_group_info
)paren
id|put_group_info
c_func
(paren
id|rsci-&gt;cred.cr_group_info
)paren
suffix:semicolon
)brace
DECL|function|rsc_put
r_static
r_void
id|rsc_put
c_func
(paren
r_struct
id|cache_head
op_star
id|item
comma
r_struct
id|cache_detail
op_star
id|cd
)paren
(brace
r_struct
id|rsc
op_star
id|rsci
op_assign
id|container_of
c_func
(paren
id|item
comma
r_struct
id|rsc
comma
id|h
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cache_put
c_func
(paren
id|item
comma
id|cd
)paren
)paren
(brace
id|rsc_free
c_func
(paren
id|rsci
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|rsci
)paren
suffix:semicolon
)brace
)brace
r_static
r_inline
r_int
DECL|function|rsc_hash
id|rsc_hash
c_func
(paren
r_struct
id|rsc
op_star
id|rsci
)paren
(brace
r_return
id|hash_mem
c_func
(paren
id|rsci-&gt;handle.data
comma
id|rsci-&gt;handle.len
comma
id|RSC_HASHBITS
)paren
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|rsc_match
id|rsc_match
c_func
(paren
r_struct
id|rsc
op_star
r_new
comma
r_struct
id|rsc
op_star
id|tmp
)paren
(brace
r_return
id|netobj_equal
c_func
(paren
op_amp
r_new
op_member_access_from_pointer
id|handle
comma
op_amp
id|tmp-&gt;handle
)paren
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|rsc_init
id|rsc_init
c_func
(paren
r_struct
id|rsc
op_star
r_new
comma
r_struct
id|rsc
op_star
id|tmp
)paren
(brace
r_new
op_member_access_from_pointer
id|handle.len
op_assign
id|tmp-&gt;handle.len
suffix:semicolon
id|tmp-&gt;handle.len
op_assign
l_int|0
suffix:semicolon
r_new
op_member_access_from_pointer
id|handle.data
op_assign
id|tmp-&gt;handle.data
suffix:semicolon
id|tmp-&gt;handle.data
op_assign
l_int|NULL
suffix:semicolon
r_new
op_member_access_from_pointer
id|mechctx
op_assign
l_int|NULL
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|rsc_update
id|rsc_update
c_func
(paren
r_struct
id|rsc
op_star
r_new
comma
r_struct
id|rsc
op_star
id|tmp
)paren
(brace
r_new
op_member_access_from_pointer
id|mechctx
op_assign
id|tmp-&gt;mechctx
suffix:semicolon
id|tmp-&gt;mechctx
op_assign
l_int|NULL
suffix:semicolon
id|memset
c_func
(paren
op_amp
r_new
op_member_access_from_pointer
id|seqdata
comma
l_int|0
comma
r_sizeof
(paren
r_new
op_member_access_from_pointer
id|seqdata
)paren
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
r_new
op_member_access_from_pointer
id|seqdata.sd_lock
)paren
suffix:semicolon
r_new
op_member_access_from_pointer
id|cred
op_assign
id|tmp-&gt;cred
suffix:semicolon
id|tmp-&gt;cred.cr_group_info
op_assign
l_int|NULL
suffix:semicolon
)brace
DECL|function|rsc_parse
r_static
r_int
id|rsc_parse
c_func
(paren
r_struct
id|cache_detail
op_star
id|cd
comma
r_char
op_star
id|mesg
comma
r_int
id|mlen
)paren
(brace
multiline_comment|/* contexthandle expiry [ uid gid N &lt;n gids&gt; mechname ...mechdata... ] */
r_char
op_star
id|buf
op_assign
id|mesg
suffix:semicolon
r_int
id|len
comma
id|rv
suffix:semicolon
r_struct
id|rsc
id|rsci
comma
op_star
id|rscp
op_assign
l_int|NULL
suffix:semicolon
id|time_t
id|expiry
suffix:semicolon
r_int
id|status
op_assign
op_minus
id|EINVAL
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|rsci
comma
l_int|0
comma
r_sizeof
(paren
id|rsci
)paren
)paren
suffix:semicolon
multiline_comment|/* context handle */
id|len
op_assign
id|qword_get
c_func
(paren
op_amp
id|mesg
comma
id|buf
comma
id|mlen
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
l_int|0
)paren
r_goto
id|out
suffix:semicolon
id|status
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
id|dup_to_netobj
c_func
(paren
op_amp
id|rsci.handle
comma
id|buf
comma
id|len
)paren
)paren
r_goto
id|out
suffix:semicolon
id|rsci.h.flags
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* expiry */
id|expiry
op_assign
id|get_expiry
c_func
(paren
op_amp
id|mesg
)paren
suffix:semicolon
id|status
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|expiry
op_eq
l_int|0
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* uid, or NEGATIVE */
id|rv
op_assign
id|get_int
c_func
(paren
op_amp
id|mesg
comma
op_amp
id|rsci.cred.cr_uid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rv
op_eq
op_minus
id|EINVAL
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|rv
op_eq
op_minus
id|ENOENT
)paren
id|set_bit
c_func
(paren
id|CACHE_NEGATIVE
comma
op_amp
id|rsci.h.flags
)paren
suffix:semicolon
r_else
(brace
r_int
id|N
comma
id|i
suffix:semicolon
r_struct
id|gss_api_mech
op_star
id|gm
suffix:semicolon
r_struct
id|xdr_netobj
id|tmp_buf
suffix:semicolon
multiline_comment|/* gid */
r_if
c_cond
(paren
id|get_int
c_func
(paren
op_amp
id|mesg
comma
op_amp
id|rsci.cred.cr_gid
)paren
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* number of additional gid&squot;s */
r_if
c_cond
(paren
id|get_int
c_func
(paren
op_amp
id|mesg
comma
op_amp
id|N
)paren
)paren
r_goto
id|out
suffix:semicolon
id|status
op_assign
op_minus
id|ENOMEM
suffix:semicolon
id|rsci.cred.cr_group_info
op_assign
id|groups_alloc
c_func
(paren
id|N
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rsci.cred.cr_group_info
op_eq
l_int|NULL
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* gid&squot;s */
id|status
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|N
suffix:semicolon
id|i
op_increment
)paren
(brace
id|gid_t
id|gid
suffix:semicolon
r_if
c_cond
(paren
id|get_int
c_func
(paren
op_amp
id|mesg
comma
op_amp
id|gid
)paren
)paren
r_goto
id|out
suffix:semicolon
id|GROUP_AT
c_func
(paren
id|rsci.cred.cr_group_info
comma
id|i
)paren
op_assign
id|gid
suffix:semicolon
)brace
multiline_comment|/* mech name */
id|len
op_assign
id|qword_get
c_func
(paren
op_amp
id|mesg
comma
id|buf
comma
id|mlen
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
l_int|0
)paren
r_goto
id|out
suffix:semicolon
id|gm
op_assign
id|gss_mech_get_by_name
c_func
(paren
id|buf
)paren
suffix:semicolon
id|status
op_assign
op_minus
id|EOPNOTSUPP
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|gm
)paren
r_goto
id|out
suffix:semicolon
id|status
op_assign
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* mech-specific data: */
id|len
op_assign
id|qword_get
c_func
(paren
op_amp
id|mesg
comma
id|buf
comma
id|mlen
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
l_int|0
)paren
(brace
id|gss_mech_put
c_func
(paren
id|gm
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|tmp_buf.len
op_assign
id|len
suffix:semicolon
id|tmp_buf.data
op_assign
id|buf
suffix:semicolon
r_if
c_cond
(paren
id|gss_import_sec_context
c_func
(paren
op_amp
id|tmp_buf
comma
id|gm
comma
op_amp
id|rsci.mechctx
)paren
)paren
(brace
id|gss_mech_put
c_func
(paren
id|gm
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|gss_mech_put
c_func
(paren
id|gm
)paren
suffix:semicolon
)brace
id|rsci.h.expiry_time
op_assign
id|expiry
suffix:semicolon
id|rscp
op_assign
id|rsc_lookup
c_func
(paren
op_amp
id|rsci
comma
l_int|1
)paren
suffix:semicolon
id|status
op_assign
l_int|0
suffix:semicolon
id|out
suffix:colon
id|rsc_free
c_func
(paren
op_amp
id|rsci
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rscp
)paren
id|rsc_put
c_func
(paren
op_amp
id|rscp-&gt;h
comma
op_amp
id|rsc_cache
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
DECL|variable|rsc_cache
r_static
r_struct
id|cache_detail
id|rsc_cache
op_assign
(brace
dot
id|hash_size
op_assign
id|RSC_HASHMAX
comma
dot
id|hash_table
op_assign
id|rsc_table
comma
dot
id|name
op_assign
l_string|&quot;auth.rpcsec.context&quot;
comma
dot
id|cache_put
op_assign
id|rsc_put
comma
dot
id|cache_parse
op_assign
id|rsc_parse
comma
)brace
suffix:semicolon
r_static
id|DefineSimpleCacheLookup
c_func
(paren
id|rsc
comma
l_int|0
)paren
suffix:semicolon
r_struct
id|rsc
op_star
DECL|function|gss_svc_searchbyctx
id|gss_svc_searchbyctx
c_func
(paren
r_struct
id|xdr_netobj
op_star
id|handle
)paren
(brace
r_struct
id|rsc
id|rsci
suffix:semicolon
r_struct
id|rsc
op_star
id|found
suffix:semicolon
id|rsci.handle
op_assign
op_star
id|handle
suffix:semicolon
id|found
op_assign
id|rsc_lookup
c_func
(paren
op_amp
id|rsci
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|found
)paren
r_return
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|cache_check
c_func
(paren
op_amp
id|rsc_cache
comma
op_amp
id|found-&gt;h
comma
l_int|NULL
)paren
)paren
r_return
l_int|NULL
suffix:semicolon
r_return
id|found
suffix:semicolon
)brace
multiline_comment|/* Implements sequence number algorithm as specified in RFC 2203. */
r_static
r_int
DECL|function|gss_check_seq_num
id|gss_check_seq_num
c_func
(paren
r_struct
id|rsc
op_star
id|rsci
comma
r_int
id|seq_num
)paren
(brace
r_struct
id|gss_svc_seq_data
op_star
id|sd
op_assign
op_amp
id|rsci-&gt;seqdata
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|sd-&gt;sd_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|seq_num
OG
id|sd-&gt;sd_max
)paren
(brace
r_if
c_cond
(paren
id|seq_num
op_ge
id|sd-&gt;sd_max
op_plus
id|GSS_SEQ_WIN
)paren
(brace
id|memset
c_func
(paren
id|sd-&gt;sd_win
comma
l_int|0
comma
r_sizeof
(paren
id|sd-&gt;sd_win
)paren
)paren
suffix:semicolon
id|sd-&gt;sd_max
op_assign
id|seq_num
suffix:semicolon
)brace
r_else
r_while
c_loop
(paren
id|sd-&gt;sd_max
OL
id|seq_num
)paren
(brace
id|sd-&gt;sd_max
op_increment
suffix:semicolon
id|__clear_bit
c_func
(paren
id|sd-&gt;sd_max
op_mod
id|GSS_SEQ_WIN
comma
id|sd-&gt;sd_win
)paren
suffix:semicolon
)brace
id|__set_bit
c_func
(paren
id|seq_num
op_mod
id|GSS_SEQ_WIN
comma
id|sd-&gt;sd_win
)paren
suffix:semicolon
r_goto
id|ok
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|seq_num
op_le
id|sd-&gt;sd_max
op_minus
id|GSS_SEQ_WIN
)paren
(brace
r_goto
id|drop
suffix:semicolon
)brace
multiline_comment|/* sd_max - GSS_SEQ_WIN &lt; seq_num &lt;= sd_max */
r_if
c_cond
(paren
id|__test_and_set_bit
c_func
(paren
id|seq_num
op_mod
id|GSS_SEQ_WIN
comma
id|sd-&gt;sd_win
)paren
)paren
r_goto
id|drop
suffix:semicolon
id|ok
suffix:colon
id|spin_unlock
c_func
(paren
op_amp
id|sd-&gt;sd_lock
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
id|drop
suffix:colon
id|spin_unlock
c_func
(paren
op_amp
id|sd-&gt;sd_lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|round_up_to_quad
r_static
r_inline
id|u32
id|round_up_to_quad
c_func
(paren
id|u32
id|i
)paren
(brace
r_return
(paren
id|i
op_plus
l_int|3
)paren
op_amp
op_complement
l_int|3
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|svc_safe_getnetobj
id|svc_safe_getnetobj
c_func
(paren
r_struct
id|iovec
op_star
id|argv
comma
r_struct
id|xdr_netobj
op_star
id|o
)paren
(brace
r_int
id|l
suffix:semicolon
r_if
c_cond
(paren
id|argv-&gt;iov_len
OL
l_int|4
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|o-&gt;len
op_assign
id|ntohl
c_func
(paren
id|svc_getu32
c_func
(paren
id|argv
)paren
)paren
suffix:semicolon
id|l
op_assign
id|round_up_to_quad
c_func
(paren
id|o-&gt;len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|argv-&gt;iov_len
OL
id|l
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|o-&gt;data
op_assign
id|argv-&gt;iov_base
suffix:semicolon
id|argv-&gt;iov_base
op_add_assign
id|l
suffix:semicolon
id|argv-&gt;iov_len
op_sub_assign
id|l
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|svc_safe_putnetobj
id|svc_safe_putnetobj
c_func
(paren
r_struct
id|iovec
op_star
id|resv
comma
r_struct
id|xdr_netobj
op_star
id|o
)paren
(brace
id|u32
op_star
id|p
suffix:semicolon
r_if
c_cond
(paren
id|resv-&gt;iov_len
op_plus
l_int|4
OG
id|PAGE_SIZE
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|svc_putu32
c_func
(paren
id|resv
comma
id|htonl
c_func
(paren
id|o-&gt;len
)paren
)paren
suffix:semicolon
id|p
op_assign
id|resv-&gt;iov_base
op_plus
id|resv-&gt;iov_len
suffix:semicolon
id|resv-&gt;iov_len
op_add_assign
id|round_up_to_quad
c_func
(paren
id|o-&gt;len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|resv-&gt;iov_len
OG
id|PAGE_SIZE
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|memcpy
c_func
(paren
id|p
comma
id|o-&gt;data
comma
id|o-&gt;len
)paren
suffix:semicolon
id|memset
c_func
(paren
(paren
id|u8
op_star
)paren
id|p
op_plus
id|o-&gt;len
comma
l_int|0
comma
id|round_up_to_quad
c_func
(paren
id|o-&gt;len
)paren
op_minus
id|o-&gt;len
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Verify the checksum on the header and return SVC_OK on success.&n; * Otherwise, return SVC_DROP (in the case of a bad sequence number)&n; * or return SVC_DENIED and indicate error in authp.&n; */
r_static
r_int
DECL|function|gss_verify_header
id|gss_verify_header
c_func
(paren
r_struct
id|svc_rqst
op_star
id|rqstp
comma
r_struct
id|rsc
op_star
id|rsci
comma
id|u32
op_star
id|rpcstart
comma
r_struct
id|rpc_gss_wire_cred
op_star
id|gc
comma
id|u32
op_star
id|authp
)paren
(brace
r_struct
id|gss_ctx
op_star
id|ctx_id
op_assign
id|rsci-&gt;mechctx
suffix:semicolon
r_struct
id|xdr_buf
id|rpchdr
suffix:semicolon
r_struct
id|xdr_netobj
id|checksum
suffix:semicolon
id|u32
id|flavor
op_assign
l_int|0
suffix:semicolon
r_struct
id|iovec
op_star
id|argv
op_assign
op_amp
id|rqstp-&gt;rq_arg.head
(braket
l_int|0
)braket
suffix:semicolon
r_struct
id|iovec
id|iov
suffix:semicolon
multiline_comment|/* data to compute the checksum over: */
id|iov.iov_base
op_assign
id|rpcstart
suffix:semicolon
id|iov.iov_len
op_assign
(paren
id|u8
op_star
)paren
id|argv-&gt;iov_base
op_minus
(paren
id|u8
op_star
)paren
id|rpcstart
suffix:semicolon
id|xdr_buf_from_iov
c_func
(paren
op_amp
id|iov
comma
op_amp
id|rpchdr
)paren
suffix:semicolon
op_star
id|authp
op_assign
id|rpc_autherr_badverf
suffix:semicolon
r_if
c_cond
(paren
id|argv-&gt;iov_len
OL
l_int|4
)paren
r_return
id|SVC_DENIED
suffix:semicolon
id|flavor
op_assign
id|ntohl
c_func
(paren
id|svc_getu32
c_func
(paren
id|argv
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|flavor
op_ne
id|RPC_AUTH_GSS
)paren
r_return
id|SVC_DENIED
suffix:semicolon
r_if
c_cond
(paren
id|svc_safe_getnetobj
c_func
(paren
id|argv
comma
op_amp
id|checksum
)paren
)paren
r_return
id|SVC_DENIED
suffix:semicolon
r_if
c_cond
(paren
id|rqstp-&gt;rq_deferred
)paren
multiline_comment|/* skip verification of revisited request */
r_return
id|SVC_OK
suffix:semicolon
r_if
c_cond
(paren
id|gss_verify_mic
c_func
(paren
id|ctx_id
comma
op_amp
id|rpchdr
comma
op_amp
id|checksum
comma
l_int|NULL
)paren
op_ne
id|GSS_S_COMPLETE
)paren
(brace
op_star
id|authp
op_assign
id|rpcsec_gsserr_credproblem
suffix:semicolon
r_return
id|SVC_DENIED
suffix:semicolon
)brace
r_if
c_cond
(paren
id|gc-&gt;gc_seq
OG
id|MAXSEQ
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;svcauth_gss: discarding request with large&quot;
l_string|&quot; sequence number %d&bslash;n&quot;
comma
id|gc-&gt;gc_seq
)paren
suffix:semicolon
op_star
id|authp
op_assign
id|rpcsec_gsserr_ctxproblem
suffix:semicolon
r_return
id|SVC_DENIED
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|gss_check_seq_num
c_func
(paren
id|rsci
comma
id|gc-&gt;gc_seq
)paren
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;svcauth_gss: discarding request with old&quot;
l_string|&quot; sequence number %d&bslash;n&quot;
comma
id|gc-&gt;gc_seq
)paren
suffix:semicolon
r_return
id|SVC_DROP
suffix:semicolon
)brace
r_return
id|SVC_OK
suffix:semicolon
)brace
r_static
r_int
DECL|function|gss_write_verf
id|gss_write_verf
c_func
(paren
r_struct
id|svc_rqst
op_star
id|rqstp
comma
r_struct
id|gss_ctx
op_star
id|ctx_id
comma
id|u32
id|seq
)paren
(brace
id|u32
id|xdr_seq
suffix:semicolon
id|u32
id|maj_stat
suffix:semicolon
r_struct
id|xdr_buf
id|verf_data
suffix:semicolon
r_struct
id|xdr_netobj
id|mic
suffix:semicolon
id|u32
op_star
id|p
suffix:semicolon
r_struct
id|iovec
id|iov
suffix:semicolon
id|svc_putu32
c_func
(paren
id|rqstp-&gt;rq_res.head
comma
id|htonl
c_func
(paren
id|RPC_AUTH_GSS
)paren
)paren
suffix:semicolon
id|xdr_seq
op_assign
id|htonl
c_func
(paren
id|seq
)paren
suffix:semicolon
id|iov.iov_base
op_assign
op_amp
id|xdr_seq
suffix:semicolon
id|iov.iov_len
op_assign
r_sizeof
(paren
id|xdr_seq
)paren
suffix:semicolon
id|xdr_buf_from_iov
c_func
(paren
op_amp
id|iov
comma
op_amp
id|verf_data
)paren
suffix:semicolon
id|p
op_assign
id|rqstp-&gt;rq_res.head-&gt;iov_base
op_plus
id|rqstp-&gt;rq_res.head-&gt;iov_len
suffix:semicolon
id|mic.data
op_assign
(paren
id|u8
op_star
)paren
(paren
id|p
op_plus
l_int|1
)paren
suffix:semicolon
id|maj_stat
op_assign
id|gss_get_mic
c_func
(paren
id|ctx_id
comma
l_int|0
comma
op_amp
id|verf_data
comma
op_amp
id|mic
)paren
suffix:semicolon
r_if
c_cond
(paren
id|maj_stat
op_ne
id|GSS_S_COMPLETE
)paren
r_return
op_minus
l_int|1
suffix:semicolon
op_star
id|p
op_increment
op_assign
id|htonl
c_func
(paren
id|mic.len
)paren
suffix:semicolon
id|memset
c_func
(paren
(paren
id|u8
op_star
)paren
id|p
op_plus
id|mic.len
comma
l_int|0
comma
id|round_up_to_quad
c_func
(paren
id|mic.len
)paren
op_minus
id|mic.len
)paren
suffix:semicolon
id|p
op_add_assign
id|XDR_QUADLEN
c_func
(paren
id|mic.len
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|xdr_ressize_check
c_func
(paren
id|rqstp
comma
id|p
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|struct|gss_domain
r_struct
id|gss_domain
(brace
DECL|member|h
r_struct
id|auth_domain
id|h
suffix:semicolon
DECL|member|pseudoflavor
id|u32
id|pseudoflavor
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* XXX this should be done in gss_pseudoflavors, and shouldn&squot;t be hardcoded: */
r_static
r_struct
id|auth_domain
op_star
DECL|function|find_gss_auth_domain
id|find_gss_auth_domain
c_func
(paren
r_struct
id|gss_ctx
op_star
id|ctx
comma
id|u32
id|svc
)paren
(brace
r_switch
c_cond
(paren
id|gss_get_pseudoflavor
c_func
(paren
id|ctx
comma
l_int|0
comma
id|svc
)paren
)paren
(brace
r_case
id|RPC_AUTH_GSS_KRB5
suffix:colon
r_return
id|auth_domain_find
c_func
(paren
l_string|&quot;gss/krb5&quot;
)paren
suffix:semicolon
r_case
id|RPC_AUTH_GSS_KRB5I
suffix:colon
r_return
id|auth_domain_find
c_func
(paren
l_string|&quot;gss/krb5i&quot;
)paren
suffix:semicolon
r_case
id|RPC_AUTH_GSS_KRB5P
suffix:colon
r_return
id|auth_domain_find
c_func
(paren
l_string|&quot;gss/krb5p&quot;
)paren
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
r_int
DECL|function|svcauth_gss_register_pseudoflavor
id|svcauth_gss_register_pseudoflavor
c_func
(paren
id|u32
id|pseudoflavor
comma
r_char
op_star
id|name
)paren
(brace
r_struct
id|gss_domain
op_star
r_new
suffix:semicolon
r_struct
id|auth_domain
op_star
id|test
suffix:semicolon
r_static
r_char
op_star
id|prefix
op_assign
l_string|&quot;gss/&quot;
suffix:semicolon
r_int
id|stat
op_assign
op_minus
l_int|1
suffix:semicolon
r_new
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
r_new
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
r_new
)paren
r_goto
id|out
suffix:semicolon
id|cache_init
c_func
(paren
op_amp
r_new
op_member_access_from_pointer
id|h.h
)paren
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
r_new
op_member_access_from_pointer
id|h.h.refcnt
)paren
suffix:semicolon
r_new
op_member_access_from_pointer
id|h.name
op_assign
id|kmalloc
c_func
(paren
id|strlen
c_func
(paren
id|name
)paren
op_plus
id|strlen
c_func
(paren
id|prefix
)paren
op_plus
l_int|1
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
r_new
op_member_access_from_pointer
id|h.name
)paren
r_goto
id|out_free_dom
suffix:semicolon
id|strcpy
c_func
(paren
r_new
op_member_access_from_pointer
id|h.name
comma
id|prefix
)paren
suffix:semicolon
id|strcat
c_func
(paren
r_new
op_member_access_from_pointer
id|h.name
comma
id|name
)paren
suffix:semicolon
r_new
op_member_access_from_pointer
id|h.flavour
op_assign
id|RPC_AUTH_GSS
suffix:semicolon
r_new
op_member_access_from_pointer
id|pseudoflavor
op_assign
id|pseudoflavor
suffix:semicolon
r_new
op_member_access_from_pointer
id|h.h.expiry_time
op_assign
id|NEVER
suffix:semicolon
r_new
op_member_access_from_pointer
id|h.h.flags
op_assign
l_int|0
suffix:semicolon
id|test
op_assign
id|auth_domain_lookup
c_func
(paren
op_amp
r_new
op_member_access_from_pointer
id|h
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|test
op_eq
op_amp
r_new
op_member_access_from_pointer
id|h
)paren
(brace
id|BUG_ON
c_func
(paren
id|atomic_dec_and_test
c_func
(paren
op_amp
r_new
op_member_access_from_pointer
id|h.h.refcnt
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* XXX Duplicate registration? */
id|auth_domain_put
c_func
(paren
op_amp
r_new
op_member_access_from_pointer
id|h
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
id|out_free_dom
suffix:colon
id|kfree
c_func
(paren
r_new
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|stat
suffix:semicolon
)brace
multiline_comment|/*&n; * Accept an rpcsec packet.&n; * If context establishment, punt to user space&n; * If data exchange, verify/decrypt&n; * If context destruction, handle here&n; * In the context establishment and destruction case we encode&n; * response here and return SVC_COMPLETE.&n; */
r_static
r_int
DECL|function|svcauth_gss_accept
id|svcauth_gss_accept
c_func
(paren
r_struct
id|svc_rqst
op_star
id|rqstp
comma
id|u32
op_star
id|authp
)paren
(brace
r_struct
id|iovec
op_star
id|argv
op_assign
op_amp
id|rqstp-&gt;rq_arg.head
(braket
l_int|0
)braket
suffix:semicolon
r_struct
id|iovec
op_star
id|resv
op_assign
op_amp
id|rqstp-&gt;rq_res.head
(braket
l_int|0
)braket
suffix:semicolon
id|u32
id|crlen
suffix:semicolon
r_struct
id|xdr_netobj
id|tmpobj
suffix:semicolon
r_struct
id|gss_svc_data
op_star
id|svcdata
op_assign
id|rqstp-&gt;rq_auth_data
suffix:semicolon
r_struct
id|rpc_gss_wire_cred
op_star
id|gc
suffix:semicolon
r_struct
id|rsc
op_star
id|rsci
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|rsi
op_star
id|rsip
comma
id|rsikey
suffix:semicolon
id|u32
op_star
id|rpcstart
suffix:semicolon
id|u32
op_star
id|reject_stat
op_assign
id|resv-&gt;iov_base
op_plus
id|resv-&gt;iov_len
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;RPC: svcauth_gss: argv-&gt;iov_len = %zd&bslash;n&quot;
comma
id|argv-&gt;iov_len
)paren
suffix:semicolon
op_star
id|authp
op_assign
id|rpc_autherr_badcred
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|svcdata
)paren
id|svcdata
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|svcdata
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|svcdata
)paren
r_goto
id|auth_err
suffix:semicolon
id|rqstp-&gt;rq_auth_data
op_assign
id|svcdata
suffix:semicolon
id|gc
op_assign
op_amp
id|svcdata-&gt;clcred
suffix:semicolon
multiline_comment|/* start of rpc packet is 7 u32&squot;s back from here:&n;&t; * xid direction rpcversion prog vers proc flavour&n;&t; */
id|rpcstart
op_assign
id|argv-&gt;iov_base
suffix:semicolon
id|rpcstart
op_sub_assign
l_int|7
suffix:semicolon
multiline_comment|/* credential is:&n;&t; *   version(==1), proc(0,1,2,3), seq, service (1,2,3), handle&n;&t; * at least 5 u32s, and is preceeded by length, so that makes 6.&n;&t; */
r_if
c_cond
(paren
id|argv-&gt;iov_len
OL
l_int|5
op_star
l_int|4
)paren
r_goto
id|auth_err
suffix:semicolon
id|crlen
op_assign
id|ntohl
c_func
(paren
id|svc_getu32
c_func
(paren
id|argv
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ntohl
c_func
(paren
id|svc_getu32
c_func
(paren
id|argv
)paren
)paren
op_ne
id|RPC_GSS_VERSION
)paren
r_goto
id|auth_err
suffix:semicolon
id|gc-&gt;gc_proc
op_assign
id|ntohl
c_func
(paren
id|svc_getu32
c_func
(paren
id|argv
)paren
)paren
suffix:semicolon
id|gc-&gt;gc_seq
op_assign
id|ntohl
c_func
(paren
id|svc_getu32
c_func
(paren
id|argv
)paren
)paren
suffix:semicolon
id|gc-&gt;gc_svc
op_assign
id|ntohl
c_func
(paren
id|svc_getu32
c_func
(paren
id|argv
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|svc_safe_getnetobj
c_func
(paren
id|argv
comma
op_amp
id|gc-&gt;gc_ctx
)paren
)paren
r_goto
id|auth_err
suffix:semicolon
r_if
c_cond
(paren
id|crlen
op_ne
id|round_up_to_quad
c_func
(paren
id|gc-&gt;gc_ctx.len
)paren
op_plus
l_int|5
op_star
l_int|4
)paren
r_goto
id|auth_err
suffix:semicolon
r_if
c_cond
(paren
(paren
id|gc-&gt;gc_proc
op_ne
id|RPC_GSS_PROC_DATA
)paren
op_logical_and
(paren
id|rqstp-&gt;rq_proc
op_ne
l_int|0
)paren
)paren
r_goto
id|auth_err
suffix:semicolon
multiline_comment|/*&n;&t; * We&squot;ve successfully parsed the credential. Let&squot;s check out the&n;&t; * verifier.  An AUTH_NULL verifier is allowed (and required) for&n;&t; * INIT and CONTINUE_INIT requests. AUTH_RPCSEC_GSS is required for&n;&t; * PROC_DATA and PROC_DESTROY.&n;&t; *&n;&t; * AUTH_NULL verifier is 0 (AUTH_NULL), 0 (length).&n;&t; * AUTH_RPCSEC_GSS verifier is:&n;&t; *   6 (AUTH_RPCSEC_GSS), length, checksum.&n;&t; * checksum is calculated over rpcheader from xid up to here.&n;&t; */
op_star
id|authp
op_assign
id|rpc_autherr_badverf
suffix:semicolon
r_switch
c_cond
(paren
id|gc-&gt;gc_proc
)paren
(brace
r_case
id|RPC_GSS_PROC_INIT
suffix:colon
r_case
id|RPC_GSS_PROC_CONTINUE_INIT
suffix:colon
r_if
c_cond
(paren
id|argv-&gt;iov_len
OL
l_int|2
op_star
l_int|4
)paren
r_goto
id|auth_err
suffix:semicolon
r_if
c_cond
(paren
id|ntohl
c_func
(paren
id|svc_getu32
c_func
(paren
id|argv
)paren
)paren
op_ne
id|RPC_AUTH_NULL
)paren
r_goto
id|auth_err
suffix:semicolon
r_if
c_cond
(paren
id|ntohl
c_func
(paren
id|svc_getu32
c_func
(paren
id|argv
)paren
)paren
op_ne
l_int|0
)paren
r_goto
id|auth_err
suffix:semicolon
r_break
suffix:semicolon
r_case
id|RPC_GSS_PROC_DATA
suffix:colon
r_case
id|RPC_GSS_PROC_DESTROY
suffix:colon
multiline_comment|/* integrity and privacy unsupported: */
r_if
c_cond
(paren
id|gc-&gt;gc_svc
op_ne
id|RPC_GSS_SVC_NONE
)paren
r_goto
id|auth_err
suffix:semicolon
op_star
id|authp
op_assign
id|rpcsec_gsserr_credproblem
suffix:semicolon
id|rsci
op_assign
id|gss_svc_searchbyctx
c_func
(paren
op_amp
id|gc-&gt;gc_ctx
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rsci
)paren
r_goto
id|auth_err
suffix:semicolon
r_switch
c_cond
(paren
id|gss_verify_header
c_func
(paren
id|rqstp
comma
id|rsci
comma
id|rpcstart
comma
id|gc
comma
id|authp
)paren
)paren
(brace
r_case
id|SVC_OK
suffix:colon
r_break
suffix:semicolon
r_case
id|SVC_DENIED
suffix:colon
r_goto
id|auth_err
suffix:semicolon
r_case
id|SVC_DROP
suffix:colon
r_goto
id|drop
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
op_star
id|authp
op_assign
id|rpc_autherr_rejectedcred
suffix:semicolon
r_goto
id|auth_err
suffix:semicolon
)brace
multiline_comment|/* now act upon the command: */
r_switch
c_cond
(paren
id|gc-&gt;gc_proc
)paren
(brace
r_case
id|RPC_GSS_PROC_INIT
suffix:colon
r_case
id|RPC_GSS_PROC_CONTINUE_INIT
suffix:colon
op_star
id|authp
op_assign
id|rpc_autherr_badcred
suffix:semicolon
r_if
c_cond
(paren
id|gc-&gt;gc_proc
op_eq
id|RPC_GSS_PROC_INIT
op_logical_and
id|gc-&gt;gc_ctx.len
op_ne
l_int|0
)paren
r_goto
id|auth_err
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|rsikey
comma
l_int|0
comma
r_sizeof
(paren
id|rsikey
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dup_netobj
c_func
(paren
op_amp
id|rsikey.in_handle
comma
op_amp
id|gc-&gt;gc_ctx
)paren
)paren
r_goto
id|drop
suffix:semicolon
op_star
id|authp
op_assign
id|rpc_autherr_badverf
suffix:semicolon
r_if
c_cond
(paren
id|svc_safe_getnetobj
c_func
(paren
id|argv
comma
op_amp
id|tmpobj
)paren
)paren
(brace
id|kfree
c_func
(paren
id|rsikey.in_handle.data
)paren
suffix:semicolon
r_goto
id|auth_err
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dup_netobj
c_func
(paren
op_amp
id|rsikey.in_token
comma
op_amp
id|tmpobj
)paren
)paren
(brace
id|kfree
c_func
(paren
id|rsikey.in_handle.data
)paren
suffix:semicolon
r_goto
id|drop
suffix:semicolon
)brace
id|rsip
op_assign
id|rsi_lookup
c_func
(paren
op_amp
id|rsikey
comma
l_int|0
)paren
suffix:semicolon
id|rsi_free
c_func
(paren
op_amp
id|rsikey
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rsip
)paren
(brace
r_goto
id|drop
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|cache_check
c_func
(paren
op_amp
id|rsi_cache
comma
op_amp
id|rsip-&gt;h
comma
op_amp
id|rqstp-&gt;rq_chandle
)paren
)paren
(brace
r_case
op_minus
id|EAGAIN
suffix:colon
r_goto
id|drop
suffix:semicolon
r_case
op_minus
id|ENOENT
suffix:colon
r_goto
id|drop
suffix:semicolon
r_case
l_int|0
suffix:colon
id|rsci
op_assign
id|gss_svc_searchbyctx
c_func
(paren
op_amp
id|rsip-&gt;out_handle
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rsci
)paren
(brace
r_goto
id|drop
suffix:semicolon
)brace
r_if
c_cond
(paren
id|gss_write_verf
c_func
(paren
id|rqstp
comma
id|rsci-&gt;mechctx
comma
id|GSS_SEQ_WIN
)paren
)paren
r_goto
id|drop
suffix:semicolon
r_if
c_cond
(paren
id|resv-&gt;iov_len
op_plus
l_int|4
OG
id|PAGE_SIZE
)paren
r_goto
id|drop
suffix:semicolon
id|svc_putu32
c_func
(paren
id|resv
comma
id|rpc_success
)paren
suffix:semicolon
r_if
c_cond
(paren
id|svc_safe_putnetobj
c_func
(paren
id|resv
comma
op_amp
id|rsip-&gt;out_handle
)paren
)paren
r_goto
id|drop
suffix:semicolon
r_if
c_cond
(paren
id|resv-&gt;iov_len
op_plus
l_int|3
op_star
l_int|4
OG
id|PAGE_SIZE
)paren
r_goto
id|drop
suffix:semicolon
id|svc_putu32
c_func
(paren
id|resv
comma
id|htonl
c_func
(paren
id|rsip-&gt;major_status
)paren
)paren
suffix:semicolon
id|svc_putu32
c_func
(paren
id|resv
comma
id|htonl
c_func
(paren
id|rsip-&gt;minor_status
)paren
)paren
suffix:semicolon
id|svc_putu32
c_func
(paren
id|resv
comma
id|htonl
c_func
(paren
id|GSS_SEQ_WIN
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|svc_safe_putnetobj
c_func
(paren
id|resv
comma
op_amp
id|rsip-&gt;out_token
)paren
)paren
r_goto
id|drop
suffix:semicolon
id|rqstp-&gt;rq_client
op_assign
l_int|NULL
suffix:semicolon
)brace
r_goto
id|complete
suffix:semicolon
r_case
id|RPC_GSS_PROC_DESTROY
suffix:colon
id|set_bit
c_func
(paren
id|CACHE_NEGATIVE
comma
op_amp
id|rsci-&gt;h.flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|resv-&gt;iov_len
op_plus
l_int|4
OG
id|PAGE_SIZE
)paren
r_goto
id|drop
suffix:semicolon
id|svc_putu32
c_func
(paren
id|resv
comma
id|rpc_success
)paren
suffix:semicolon
r_goto
id|complete
suffix:semicolon
r_case
id|RPC_GSS_PROC_DATA
suffix:colon
id|rqstp-&gt;rq_client
op_assign
id|find_gss_auth_domain
c_func
(paren
id|rsci-&gt;mechctx
comma
id|gc-&gt;gc_svc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rqstp-&gt;rq_client
op_eq
l_int|NULL
)paren
r_goto
id|auth_err
suffix:semicolon
op_star
id|authp
op_assign
id|rpcsec_gsserr_ctxproblem
suffix:semicolon
r_if
c_cond
(paren
id|gss_write_verf
c_func
(paren
id|rqstp
comma
id|rsci-&gt;mechctx
comma
id|gc-&gt;gc_seq
)paren
)paren
r_goto
id|auth_err
suffix:semicolon
multiline_comment|/* For use when wrapping: */
id|svcdata-&gt;body_start
op_assign
id|resv-&gt;iov_base
op_plus
l_int|1
suffix:semicolon
id|rqstp-&gt;rq_cred
op_assign
id|rsci-&gt;cred
suffix:semicolon
id|get_group_info
c_func
(paren
id|rsci-&gt;cred.cr_group_info
)paren
suffix:semicolon
id|ret
op_assign
id|SVC_OK
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|auth_err
suffix:colon
multiline_comment|/* Restore write pointer to original value: */
id|xdr_ressize_check
c_func
(paren
id|rqstp
comma
id|reject_stat
)paren
suffix:semicolon
id|ret
op_assign
id|SVC_DENIED
suffix:semicolon
r_goto
id|out
suffix:semicolon
id|complete
suffix:colon
id|ret
op_assign
id|SVC_COMPLETE
suffix:semicolon
r_goto
id|out
suffix:semicolon
id|drop
suffix:colon
id|ret
op_assign
id|SVC_DROP
suffix:semicolon
id|out
suffix:colon
r_if
c_cond
(paren
id|rsci
)paren
id|rsc_put
c_func
(paren
op_amp
id|rsci-&gt;h
comma
op_amp
id|rsc_cache
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
r_static
r_int
DECL|function|svcauth_gss_release
id|svcauth_gss_release
c_func
(paren
r_struct
id|svc_rqst
op_star
id|rqstp
)paren
(brace
r_if
c_cond
(paren
id|rqstp-&gt;rq_client
)paren
id|auth_domain_put
c_func
(paren
id|rqstp-&gt;rq_client
)paren
suffix:semicolon
id|rqstp-&gt;rq_client
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|rqstp-&gt;rq_cred.cr_group_info
)paren
id|put_group_info
c_func
(paren
id|rqstp-&gt;rq_cred.cr_group_info
)paren
suffix:semicolon
id|rqstp-&gt;rq_cred.cr_group_info
op_assign
l_int|NULL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|svcauth_gss_domain_release
id|svcauth_gss_domain_release
c_func
(paren
r_struct
id|auth_domain
op_star
id|dom
)paren
(brace
r_struct
id|gss_domain
op_star
id|gd
op_assign
id|container_of
c_func
(paren
id|dom
comma
r_struct
id|gss_domain
comma
id|h
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|dom-&gt;name
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|gd
)paren
suffix:semicolon
)brace
DECL|variable|svcauthops_gss
r_struct
id|auth_ops
id|svcauthops_gss
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;rpcsec_gss&quot;
comma
dot
id|flavour
op_assign
id|RPC_AUTH_GSS
comma
dot
id|accept
op_assign
id|svcauth_gss_accept
comma
dot
id|release
op_assign
id|svcauth_gss_release
comma
dot
id|domain_release
op_assign
id|svcauth_gss_domain_release
comma
)brace
suffix:semicolon
r_int
DECL|function|gss_svc_init
id|gss_svc_init
c_func
(paren
r_void
)paren
(brace
id|cache_register
c_func
(paren
op_amp
id|rsc_cache
)paren
suffix:semicolon
id|cache_register
c_func
(paren
op_amp
id|rsi_cache
)paren
suffix:semicolon
id|svc_auth_register
c_func
(paren
id|RPC_AUTH_GSS
comma
op_amp
id|svcauthops_gss
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
eof
