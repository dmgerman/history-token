multiline_comment|/*&n; *  linux/net/sunrpc/gss_spkm3_seal.c&n; *&n; *  Copyright (c) 2003 The Regents of the University of Michigan.&n; *  All rights reserved.&n; *&n; *  Andy Adamson &lt;andros@umich.edu&gt;&n; *&n; *  Redistribution and use in source and binary forms, with or without&n; *  modification, are permitted provided that the following conditions&n; *  are met:&n; *&n; *  1. Redistributions of source code must retain the above copyright&n; *     notice, this list of conditions and the following disclaimer.&n; *  2. Redistributions in binary form must reproduce the above copyright&n; *     notice, this list of conditions and the following disclaimer in the&n; *     documentation and/or other materials provided with the distribution.&n; *  3. Neither the name of the University nor the names of its&n; *     contributors may be used to endorse or promote products derived&n; *     from this software without specific prior written permission.&n; *&n; *  THIS SOFTWARE IS PROVIDED ``AS IS&squot;&squot; AND ANY EXPRESS OR IMPLIED&n; *  WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF&n; *  MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE&n; *  DISCLAIMED. IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE&n; *  FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR&n; *  CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF&n; *  SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR&n; *  BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF&n; *  LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING&n; *  NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS&n; *  SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.&n; *&n; */
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/jiffies.h&gt;
macro_line|#include &lt;linux/sunrpc/gss_spkm3.h&gt;
macro_line|#include &lt;linux/random.h&gt;
macro_line|#include &lt;linux/crypto.h&gt;
macro_line|#ifdef RPC_DEBUG
DECL|macro|RPCDBG_FACILITY
macro_line|# define RPCDBG_FACILITY        RPCDBG_AUTH
macro_line|#endif
multiline_comment|/*&n; * spkm3_make_token()&n; *&n; * Only SPKM_MIC_TOK with md5 intg-alg is supported&n; */
id|u32
DECL|function|spkm3_make_token
id|spkm3_make_token
c_func
(paren
r_struct
id|spkm3_ctx
op_star
id|ctx
comma
r_int
id|qop_req
comma
r_struct
id|xdr_buf
op_star
id|text
comma
r_struct
id|xdr_netobj
op_star
id|token
comma
r_int
id|toktype
)paren
(brace
id|s32
id|checksum_type
suffix:semicolon
r_char
id|tokhdrbuf
(braket
l_int|25
)braket
suffix:semicolon
r_struct
id|xdr_netobj
id|md5cksum
op_assign
(brace
dot
id|len
op_assign
l_int|0
comma
dot
id|data
op_assign
l_int|NULL
)brace
suffix:semicolon
r_struct
id|xdr_netobj
id|mic_hdr
op_assign
(brace
dot
id|len
op_assign
l_int|0
comma
dot
id|data
op_assign
id|tokhdrbuf
)brace
suffix:semicolon
r_int
id|tmsglen
comma
id|tokenlen
op_assign
l_int|0
suffix:semicolon
r_int
r_char
op_star
id|ptr
suffix:semicolon
id|s32
id|now
suffix:semicolon
r_int
id|ctxelen
op_assign
l_int|0
comma
id|ctxzbit
op_assign
l_int|0
suffix:semicolon
r_int
id|md5elen
op_assign
l_int|0
comma
id|md5zbit
op_assign
l_int|0
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;RPC: spkm3_make_token&bslash;n&quot;
)paren
suffix:semicolon
id|now
op_assign
id|jiffies
suffix:semicolon
r_if
c_cond
(paren
id|qop_req
op_ne
l_int|0
)paren
r_goto
id|out_err
suffix:semicolon
r_if
c_cond
(paren
id|ctx-&gt;ctx_id.len
op_ne
l_int|16
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;RPC: spkm3_make_token BAD ctx_id.len %d&bslash;n&quot;
comma
id|ctx-&gt;ctx_id.len
)paren
suffix:semicolon
r_goto
id|out_err
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|ctx-&gt;intg_alg
)paren
(brace
r_case
id|NID_md5
suffix:colon
id|checksum_type
op_assign
id|CKSUMTYPE_RSA_MD5
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|dprintk
c_func
(paren
l_string|&quot;RPC: gss_spkm3_seal: ctx-&gt;signalg %d not&quot;
l_string|&quot; supported&bslash;n&quot;
comma
id|ctx-&gt;intg_alg
)paren
suffix:semicolon
r_goto
id|out_err
suffix:semicolon
)brace
multiline_comment|/* XXX since we don&squot;t support WRAP, perhaps we don&squot;t care... */
r_if
c_cond
(paren
id|ctx-&gt;conf_alg
op_ne
id|NID_cast5_cbc
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;RPC: gss_spkm3_seal: ctx-&gt;sealalg %d not supported&bslash;n&quot;
comma
id|ctx-&gt;conf_alg
)paren
suffix:semicolon
r_goto
id|out_err
suffix:semicolon
)brace
r_if
c_cond
(paren
id|toktype
op_eq
id|SPKM_MIC_TOK
)paren
(brace
id|tmsglen
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Calculate checksum over the mic-header */
id|asn1_bitstring_len
c_func
(paren
op_amp
id|ctx-&gt;ctx_id
comma
op_amp
id|ctxelen
comma
op_amp
id|ctxzbit
)paren
suffix:semicolon
id|spkm3_mic_header
c_func
(paren
op_amp
id|mic_hdr.data
comma
op_amp
id|mic_hdr.len
comma
id|ctx-&gt;ctx_id.data
comma
id|ctxelen
comma
id|ctxzbit
)paren
suffix:semicolon
r_if
c_cond
(paren
id|make_checksum
c_func
(paren
id|checksum_type
comma
id|mic_hdr.data
comma
id|mic_hdr.len
comma
id|text
comma
op_amp
id|md5cksum
)paren
)paren
r_goto
id|out_err
suffix:semicolon
id|asn1_bitstring_len
c_func
(paren
op_amp
id|md5cksum
comma
op_amp
id|md5elen
comma
op_amp
id|md5zbit
)paren
suffix:semicolon
id|tokenlen
op_assign
l_int|10
op_plus
id|ctxelen
op_plus
l_int|1
op_plus
l_int|2
op_plus
id|md5elen
op_plus
l_int|1
suffix:semicolon
multiline_comment|/* Create token header using generic routines */
id|token-&gt;len
op_assign
id|g_token_size
c_func
(paren
op_amp
id|ctx-&gt;mech_used
comma
id|tokenlen
op_plus
id|tmsglen
)paren
suffix:semicolon
id|ptr
op_assign
id|token-&gt;data
suffix:semicolon
id|g_make_token_header
c_func
(paren
op_amp
id|ctx-&gt;mech_used
comma
id|tokenlen
op_plus
id|tmsglen
comma
op_amp
id|ptr
)paren
suffix:semicolon
id|spkm3_make_mic_token
c_func
(paren
op_amp
id|ptr
comma
id|tokenlen
comma
op_amp
id|mic_hdr
comma
op_amp
id|md5cksum
comma
id|md5elen
comma
id|md5zbit
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|toktype
op_eq
id|SPKM_WRAP_TOK
)paren
(brace
multiline_comment|/* Not Supported */
id|dprintk
c_func
(paren
l_string|&quot;RPC: gss_spkm3_seal: SPKM_WRAP_TOK not supported&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out_err
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|md5cksum.data
)paren
suffix:semicolon
multiline_comment|/* XXX need to implement sequence numbers, and ctx-&gt;expired */
r_return
id|GSS_S_COMPLETE
suffix:semicolon
id|out_err
suffix:colon
r_if
c_cond
(paren
id|md5cksum.data
)paren
id|kfree
c_func
(paren
id|md5cksum.data
)paren
suffix:semicolon
id|token-&gt;data
op_assign
l_int|0
suffix:semicolon
id|token-&gt;len
op_assign
l_int|0
suffix:semicolon
r_return
id|GSS_S_FAILURE
suffix:semicolon
)brace
eof
