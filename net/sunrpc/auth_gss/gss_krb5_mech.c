multiline_comment|/*&n; *  linux/net/sunrpc/gss_krb5_mech.c&n; *&n; *  Copyright (c) 2001 The Regents of the University of Michigan.&n; *  All rights reserved.&n; *&n; *  Andy Adamson &lt;andros@umich.edu&gt;&n; *  J. Bruce Fields &lt;bfields@umich.edu&gt;&n; *&n; *  Redistribution and use in source and binary forms, with or without&n; *  modification, are permitted provided that the following conditions&n; *  are met:&n; *&n; *  1. Redistributions of source code must retain the above copyright&n; *     notice, this list of conditions and the following disclaimer.&n; *  2. Redistributions in binary form must reproduce the above copyright&n; *     notice, this list of conditions and the following disclaimer in the&n; *     documentation and/or other materials provided with the distribution.&n; *  3. Neither the name of the University nor the names of its&n; *     contributors may be used to endorse or promote products derived&n; *     from this software without specific prior written permission.&n; *&n; *  THIS SOFTWARE IS PROVIDED ``AS IS&squot;&squot; AND ANY EXPRESS OR IMPLIED&n; *  WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF&n; *  MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE&n; *  DISCLAIMED. IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE&n; *  FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR&n; *  CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF&n; *  SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR&n; *  BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF&n; *  LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING&n; *  NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS&n; *  SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.&n; *&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/sunrpc/auth.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/sunrpc/gss_krb5.h&gt;
macro_line|#include &lt;linux/sunrpc/xdr.h&gt;
macro_line|#include &lt;linux/crypto.h&gt;
macro_line|#ifdef RPC_DEBUG
DECL|macro|RPCDBG_FACILITY
macro_line|# define RPCDBG_FACILITY&t;RPCDBG_AUTH
macro_line|#endif
DECL|variable|gss_mech_krb5_oid
r_struct
id|xdr_netobj
id|gss_mech_krb5_oid
op_assign
(brace
l_int|9
comma
l_string|&quot;&bslash;052&bslash;206&bslash;110&bslash;206&bslash;367&bslash;022&bslash;001&bslash;002&bslash;002&quot;
)brace
suffix:semicolon
r_static
r_inline
r_int
DECL|function|get_bytes
id|get_bytes
c_func
(paren
r_char
op_star
op_star
id|ptr
comma
r_const
r_char
op_star
id|end
comma
r_void
op_star
id|res
comma
r_int
id|len
)paren
(brace
r_char
op_star
id|p
comma
op_star
id|q
suffix:semicolon
id|p
op_assign
op_star
id|ptr
suffix:semicolon
id|q
op_assign
id|p
op_plus
id|len
suffix:semicolon
r_if
c_cond
(paren
id|q
OG
id|end
op_logical_or
id|q
OL
id|p
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|memcpy
c_func
(paren
id|res
comma
id|p
comma
id|len
)paren
suffix:semicolon
op_star
id|ptr
op_assign
id|q
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|get_netobj
id|get_netobj
c_func
(paren
r_char
op_star
op_star
id|ptr
comma
r_const
r_char
op_star
id|end
comma
r_struct
id|xdr_netobj
op_star
id|res
)paren
(brace
r_char
op_star
id|p
comma
op_star
id|q
suffix:semicolon
id|p
op_assign
op_star
id|ptr
suffix:semicolon
r_if
c_cond
(paren
id|get_bytes
c_func
(paren
op_amp
id|p
comma
id|end
comma
op_amp
id|res-&gt;len
comma
r_sizeof
(paren
id|res-&gt;len
)paren
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|q
op_assign
id|p
op_plus
id|res-&gt;len
suffix:semicolon
r_if
c_cond
(paren
id|q
OG
id|end
op_logical_or
id|q
OL
id|p
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|res-&gt;data
op_assign
id|kmalloc
c_func
(paren
id|res-&gt;len
comma
id|GFP_KERNEL
)paren
)paren
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|memcpy
c_func
(paren
id|res-&gt;data
comma
id|p
comma
id|res-&gt;len
)paren
suffix:semicolon
op_star
id|ptr
op_assign
id|q
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|get_key
id|get_key
c_func
(paren
r_char
op_star
op_star
id|p
comma
r_char
op_star
id|end
comma
r_struct
id|crypto_tfm
op_star
op_star
id|res
)paren
(brace
r_struct
id|xdr_netobj
id|key
suffix:semicolon
r_int
id|alg
comma
id|alg_mode
suffix:semicolon
r_char
op_star
id|alg_name
suffix:semicolon
r_if
c_cond
(paren
id|get_bytes
c_func
(paren
id|p
comma
id|end
comma
op_amp
id|alg
comma
r_sizeof
(paren
id|alg
)paren
)paren
)paren
r_goto
id|out_err
suffix:semicolon
r_if
c_cond
(paren
(paren
id|get_netobj
c_func
(paren
id|p
comma
id|end
comma
op_amp
id|key
)paren
)paren
)paren
r_goto
id|out_err
suffix:semicolon
r_switch
c_cond
(paren
id|alg
)paren
(brace
r_case
id|ENCTYPE_DES_CBC_RAW
suffix:colon
id|alg_name
op_assign
l_string|&quot;des&quot;
suffix:semicolon
id|alg_mode
op_assign
id|CRYPTO_TFM_MODE_CBC
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|dprintk
c_func
(paren
l_string|&quot;RPC:      get_key: unsupported algorithm %d&bslash;n&quot;
comma
id|alg
)paren
suffix:semicolon
r_goto
id|out_err_free_key
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
op_star
id|res
op_assign
id|crypto_alloc_tfm
c_func
(paren
id|alg_name
comma
id|alg_mode
)paren
)paren
)paren
r_goto
id|out_err_free_key
suffix:semicolon
r_if
c_cond
(paren
id|crypto_cipher_setkey
c_func
(paren
op_star
id|res
comma
id|key.data
comma
id|key.len
)paren
)paren
r_goto
id|out_err_free_tfm
suffix:semicolon
id|kfree
c_func
(paren
id|key.data
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|out_err_free_tfm
suffix:colon
id|crypto_free_tfm
c_func
(paren
op_star
id|res
)paren
suffix:semicolon
id|out_err_free_key
suffix:colon
id|kfree
c_func
(paren
id|key.data
)paren
suffix:semicolon
id|out_err
suffix:colon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_static
id|u32
DECL|function|gss_import_sec_context_kerberos
id|gss_import_sec_context_kerberos
c_func
(paren
r_struct
id|xdr_netobj
op_star
id|inbuf
comma
r_struct
id|gss_ctx
op_star
id|ctx_id
)paren
(brace
r_char
op_star
id|p
op_assign
id|inbuf-&gt;data
suffix:semicolon
r_char
op_star
id|end
op_assign
id|inbuf-&gt;data
op_plus
id|inbuf-&gt;len
suffix:semicolon
r_struct
id|krb5_ctx
op_star
id|ctx
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|ctx
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|ctx
)paren
comma
id|GFP_KERNEL
)paren
)paren
)paren
r_goto
id|out_err
suffix:semicolon
id|memset
c_func
(paren
id|ctx
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|ctx
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|get_bytes
c_func
(paren
op_amp
id|p
comma
id|end
comma
op_amp
id|ctx-&gt;initiate
comma
r_sizeof
(paren
id|ctx-&gt;initiate
)paren
)paren
)paren
r_goto
id|out_err_free_ctx
suffix:semicolon
r_if
c_cond
(paren
id|get_bytes
c_func
(paren
op_amp
id|p
comma
id|end
comma
op_amp
id|ctx-&gt;seed_init
comma
r_sizeof
(paren
id|ctx-&gt;seed_init
)paren
)paren
)paren
r_goto
id|out_err_free_ctx
suffix:semicolon
r_if
c_cond
(paren
id|get_bytes
c_func
(paren
op_amp
id|p
comma
id|end
comma
id|ctx-&gt;seed
comma
r_sizeof
(paren
id|ctx-&gt;seed
)paren
)paren
)paren
r_goto
id|out_err_free_ctx
suffix:semicolon
r_if
c_cond
(paren
id|get_bytes
c_func
(paren
op_amp
id|p
comma
id|end
comma
op_amp
id|ctx-&gt;signalg
comma
r_sizeof
(paren
id|ctx-&gt;signalg
)paren
)paren
)paren
r_goto
id|out_err_free_ctx
suffix:semicolon
r_if
c_cond
(paren
id|get_bytes
c_func
(paren
op_amp
id|p
comma
id|end
comma
op_amp
id|ctx-&gt;sealalg
comma
r_sizeof
(paren
id|ctx-&gt;sealalg
)paren
)paren
)paren
r_goto
id|out_err_free_ctx
suffix:semicolon
r_if
c_cond
(paren
id|get_bytes
c_func
(paren
op_amp
id|p
comma
id|end
comma
op_amp
id|ctx-&gt;endtime
comma
r_sizeof
(paren
id|ctx-&gt;endtime
)paren
)paren
)paren
r_goto
id|out_err_free_ctx
suffix:semicolon
r_if
c_cond
(paren
id|get_bytes
c_func
(paren
op_amp
id|p
comma
id|end
comma
op_amp
id|ctx-&gt;seq_send
comma
r_sizeof
(paren
id|ctx-&gt;seq_send
)paren
)paren
)paren
r_goto
id|out_err_free_ctx
suffix:semicolon
r_if
c_cond
(paren
id|get_netobj
c_func
(paren
op_amp
id|p
comma
id|end
comma
op_amp
id|ctx-&gt;mech_used
)paren
)paren
r_goto
id|out_err_free_ctx
suffix:semicolon
r_if
c_cond
(paren
id|get_key
c_func
(paren
op_amp
id|p
comma
id|end
comma
op_amp
id|ctx-&gt;enc
)paren
)paren
r_goto
id|out_err_free_mech
suffix:semicolon
r_if
c_cond
(paren
id|get_key
c_func
(paren
op_amp
id|p
comma
id|end
comma
op_amp
id|ctx-&gt;seq
)paren
)paren
r_goto
id|out_err_free_key1
suffix:semicolon
r_if
c_cond
(paren
id|p
op_ne
id|end
)paren
r_goto
id|out_err_free_key2
suffix:semicolon
id|ctx_id-&gt;internal_ctx_id
op_assign
id|ctx
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;RPC:      Succesfully imported new context.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|out_err_free_key2
suffix:colon
id|crypto_free_tfm
c_func
(paren
id|ctx-&gt;seq
)paren
suffix:semicolon
id|out_err_free_key1
suffix:colon
id|crypto_free_tfm
c_func
(paren
id|ctx-&gt;enc
)paren
suffix:semicolon
id|out_err_free_mech
suffix:colon
id|kfree
c_func
(paren
id|ctx-&gt;mech_used.data
)paren
suffix:semicolon
id|out_err_free_ctx
suffix:colon
id|kfree
c_func
(paren
id|ctx
)paren
suffix:semicolon
id|out_err
suffix:colon
r_return
id|GSS_S_FAILURE
suffix:semicolon
)brace
r_static
r_void
DECL|function|gss_delete_sec_context_kerberos
id|gss_delete_sec_context_kerberos
c_func
(paren
r_void
op_star
id|internal_ctx
)paren
(brace
r_struct
id|krb5_ctx
op_star
id|kctx
op_assign
id|internal_ctx
suffix:semicolon
r_if
c_cond
(paren
id|kctx-&gt;seq
)paren
id|crypto_free_tfm
c_func
(paren
id|kctx-&gt;seq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|kctx-&gt;enc
)paren
id|crypto_free_tfm
c_func
(paren
id|kctx-&gt;enc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|kctx-&gt;mech_used.data
)paren
id|kfree
c_func
(paren
id|kctx-&gt;mech_used.data
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|kctx
)paren
suffix:semicolon
)brace
r_static
id|u32
DECL|function|gss_verify_mic_kerberos
id|gss_verify_mic_kerberos
c_func
(paren
r_struct
id|gss_ctx
op_star
id|ctx
comma
r_struct
id|xdr_buf
op_star
id|message
comma
r_struct
id|xdr_netobj
op_star
id|mic_token
comma
id|u32
op_star
id|qstate
)paren
(brace
id|u32
id|maj_stat
op_assign
l_int|0
suffix:semicolon
r_int
id|qop_state
suffix:semicolon
r_struct
id|krb5_ctx
op_star
id|kctx
op_assign
id|ctx-&gt;internal_ctx_id
suffix:semicolon
id|maj_stat
op_assign
id|krb5_read_token
c_func
(paren
id|kctx
comma
id|mic_token
comma
id|message
comma
op_amp
id|qop_state
comma
id|KG_TOK_MIC_MSG
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|maj_stat
op_logical_and
id|qop_state
)paren
op_star
id|qstate
op_assign
id|qop_state
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;RPC:      gss_verify_mic_kerberos returning %d&bslash;n&quot;
comma
id|maj_stat
)paren
suffix:semicolon
r_return
id|maj_stat
suffix:semicolon
)brace
r_static
id|u32
DECL|function|gss_get_mic_kerberos
id|gss_get_mic_kerberos
c_func
(paren
r_struct
id|gss_ctx
op_star
id|ctx
comma
id|u32
id|qop
comma
r_struct
id|xdr_buf
op_star
id|message
comma
r_struct
id|xdr_netobj
op_star
id|mic_token
)paren
(brace
id|u32
id|err
op_assign
l_int|0
suffix:semicolon
r_struct
id|krb5_ctx
op_star
id|kctx
op_assign
id|ctx-&gt;internal_ctx_id
suffix:semicolon
id|err
op_assign
id|krb5_make_token
c_func
(paren
id|kctx
comma
id|qop
comma
id|message
comma
id|mic_token
comma
id|KG_TOK_MIC_MSG
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;RPC:      gss_get_mic_kerberos returning %d&bslash;n&quot;
comma
id|err
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|variable|gss_kerberos_ops
r_static
r_struct
id|gss_api_ops
id|gss_kerberos_ops
op_assign
(brace
dot
id|gss_import_sec_context
op_assign
id|gss_import_sec_context_kerberos
comma
dot
id|gss_get_mic
op_assign
id|gss_get_mic_kerberos
comma
dot
id|gss_verify_mic
op_assign
id|gss_verify_mic_kerberos
comma
dot
id|gss_delete_sec_context
op_assign
id|gss_delete_sec_context_kerberos
comma
)brace
suffix:semicolon
DECL|variable|gss_kerberos_mech
r_static
r_struct
id|gss_api_mech
id|gss_kerberos_mech
op_assign
(brace
dot
id|gm_name
op_assign
l_string|&quot;krb5&quot;
comma
dot
id|gm_owner
op_assign
id|THIS_MODULE
comma
dot
id|gm_ops
op_assign
op_amp
id|gss_kerberos_ops
comma
dot
id|gm_pf_num
op_assign
l_int|2
comma
dot
id|gm_pfs
op_assign
(brace
(brace
id|RPC_AUTH_GSS_KRB5
comma
l_int|0
comma
id|RPC_GSS_SVC_NONE
comma
l_string|&quot;krb5&quot;
)brace
comma
(brace
id|RPC_AUTH_GSS_KRB5I
comma
l_int|0
comma
id|RPC_GSS_SVC_INTEGRITY
comma
l_string|&quot;krb5i&quot;
)brace
comma
)brace
comma
)brace
suffix:semicolon
DECL|function|init_kerberos_module
r_static
r_int
id|__init
id|init_kerberos_module
c_func
(paren
r_void
)paren
(brace
r_int
id|status
suffix:semicolon
id|status
op_assign
id|gss_mech_register
c_func
(paren
op_amp
id|gss_kerberos_mech
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
id|printk
c_func
(paren
l_string|&quot;Failed to register kerberos gss mechanism!&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
DECL|function|cleanup_kerberos_module
r_static
r_void
id|__exit
id|cleanup_kerberos_module
c_func
(paren
r_void
)paren
(brace
id|gss_mech_unregister
c_func
(paren
op_amp
id|gss_kerberos_mech
)paren
suffix:semicolon
)brace
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
DECL|variable|init_kerberos_module
id|module_init
c_func
(paren
id|init_kerberos_module
)paren
suffix:semicolon
DECL|variable|cleanup_kerberos_module
id|module_exit
c_func
(paren
id|cleanup_kerberos_module
)paren
suffix:semicolon
eof
