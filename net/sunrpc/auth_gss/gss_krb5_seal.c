multiline_comment|/*&n; *  linux/net/sunrpc/gss_krb5_seal.c&n; *&n; *  Adapted from MIT Kerberos 5-1.2.1 lib/gssapi/krb5/k5seal.c&n; *&n; *  Copyright (c) 2000 The Regents of the University of Michigan.&n; *  All rights reserved.&n; *&n; *  Andy Adamson&t;&lt;andros@umich.edu&gt;&n; *  J. Bruce Fields&t;&lt;bfields@umich.edu&gt;&n; */
multiline_comment|/*&n; * Copyright 1993 by OpenVision Technologies, Inc.&n; *&n; * Permission to use, copy, modify, distribute, and sell this software&n; * and its documentation for any purpose is hereby granted without fee,&n; * provided that the above copyright notice appears in all copies and&n; * that both that copyright notice and this permission notice appear in&n; * supporting documentation, and that the name of OpenVision not be used&n; * in advertising or publicity pertaining to distribution of the software&n; * without specific, written prior permission. OpenVision makes no&n; * representations about the suitability of this software for any&n; * purpose.  It is provided &quot;as is&quot; without express or implied warranty.&n; *&n; * OPENVISION DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE,&n; * INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS, IN NO&n; * EVENT SHALL OPENVISION BE LIABLE FOR ANY SPECIAL, INDIRECT OR&n; * CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF&n; * USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR&n; * OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR&n; * PERFORMANCE OF THIS SOFTWARE.&n; */
multiline_comment|/*&n; * Copyright (C) 1998 by the FundsXpress, INC.&n; *&n; * All rights reserved.&n; *&n; * Export of this software from the United States of America may require&n; * a specific license from the United States Government.  It is the&n; * responsibility of any person or organization contemplating export to&n; * obtain such a license before exporting.&n; *&n; * WITHIN THAT CONSTRAINT, permission to use, copy, modify, and&n; * distribute this software and its documentation for any purpose and&n; * without fee is hereby granted, provided that the above copyright&n; * notice appear in all copies and that both that copyright notice and&n; * this permission notice appear in supporting documentation, and that&n; * the name of FundsXpress. not be used in advertising or publicity pertaining&n; * to distribution of the software without specific, written prior&n; * permission.  FundsXpress makes no representations about the suitability of&n; * this software for any purpose.  It is provided &quot;as is&quot; without express&n; * or implied warranty.&n; *&n; * THIS SOFTWARE IS PROVIDED ``AS IS&squot;&squot; AND WITHOUT ANY EXPRESS OR&n; * IMPLIED WARRANTIES, INCLUDING, WITHOUT LIMITATION, THE IMPLIED&n; * WARRANTIES OF MERCHANTIBILITY AND FITNESS FOR A PARTICULAR PURPOSE.&n; */
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/jiffies.h&gt;
macro_line|#include &lt;linux/sunrpc/gss_krb5.h&gt;
macro_line|#include &lt;linux/random.h&gt;
macro_line|#include &lt;linux/crypto.h&gt;
macro_line|#ifdef RPC_DEBUG
DECL|macro|RPCDBG_FACILITY
macro_line|# define RPCDBG_FACILITY        RPCDBG_AUTH
macro_line|#endif
DECL|macro|CKSUM_SIZE
mdefine_line|#define CKSUM_SIZE&t;8
r_static
r_inline
r_int
DECL|function|gss_krb5_padding
id|gss_krb5_padding
c_func
(paren
r_int
id|blocksize
comma
r_int
id|length
)paren
(brace
multiline_comment|/* Most of the code is block-size independent but in practice we&n;&t; * use only 8: */
id|BUG_ON
c_func
(paren
id|blocksize
op_ne
l_int|8
)paren
suffix:semicolon
r_return
l_int|8
op_minus
(paren
id|length
op_amp
l_int|7
)paren
suffix:semicolon
)brace
multiline_comment|/* checksum the plaintext data and the first 8 bytes of the krb5 token header,&n; * as specified by the rfc: */
r_static
id|u32
DECL|function|compute_checksum
id|compute_checksum
c_func
(paren
id|s32
id|checksum_type
comma
r_char
op_star
id|header
comma
r_char
op_star
id|body
comma
r_int
id|body_len
comma
r_struct
id|xdr_netobj
op_star
id|md5cksum
)paren
(brace
r_char
op_star
id|data_ptr
suffix:semicolon
r_struct
id|xdr_netobj
id|plaind
suffix:semicolon
id|u32
id|code
op_assign
id|GSS_S_FAILURE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|data_ptr
op_assign
id|kmalloc
c_func
(paren
l_int|8
op_plus
id|body_len
comma
id|GFP_KERNEL
)paren
)paren
)paren
r_goto
id|out
suffix:semicolon
id|memcpy
c_func
(paren
id|data_ptr
comma
id|header
comma
l_int|8
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|data_ptr
op_plus
l_int|8
comma
id|body
comma
id|body_len
)paren
suffix:semicolon
id|plaind.len
op_assign
l_int|8
op_plus
id|body_len
suffix:semicolon
id|plaind.data
op_assign
id|data_ptr
suffix:semicolon
id|code
op_assign
id|krb5_make_checksum
c_func
(paren
id|checksum_type
comma
op_amp
id|plaind
comma
id|md5cksum
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|data_ptr
)paren
suffix:semicolon
id|code
op_assign
l_int|0
suffix:semicolon
id|out
suffix:colon
r_return
id|code
suffix:semicolon
)brace
id|u32
DECL|function|krb5_make_token
id|krb5_make_token
c_func
(paren
r_struct
id|krb5_ctx
op_star
id|ctx
comma
r_int
id|qop_req
comma
r_struct
id|xdr_netobj
op_star
id|text
comma
r_struct
id|xdr_netobj
op_star
id|token
comma
r_int
id|toktype
)paren
(brace
id|s32
id|checksum_type
suffix:semicolon
r_struct
id|xdr_netobj
id|md5cksum
op_assign
(brace
dot
id|len
op_assign
l_int|0
comma
dot
id|data
op_assign
l_int|NULL
)brace
suffix:semicolon
r_int
id|blocksize
op_assign
l_int|0
comma
id|tmsglen
suffix:semicolon
r_int
r_char
op_star
id|ptr
comma
op_star
id|krb5_hdr
comma
op_star
id|msg_start
suffix:semicolon
id|s32
id|now
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;RPC: gss_krb5_seal&quot;
)paren
suffix:semicolon
id|now
op_assign
id|jiffies
suffix:semicolon
r_if
c_cond
(paren
id|qop_req
op_ne
l_int|0
)paren
r_goto
id|out_err
suffix:semicolon
r_switch
c_cond
(paren
id|ctx-&gt;signalg
)paren
(brace
r_case
id|SGN_ALG_DES_MAC_MD5
suffix:colon
id|checksum_type
op_assign
id|CKSUMTYPE_RSA_MD5
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|dprintk
c_func
(paren
l_string|&quot;RPC: gss_krb5_seal: ctx-&gt;signalg %d not&quot;
l_string|&quot; supported&bslash;n&quot;
comma
id|ctx-&gt;signalg
)paren
suffix:semicolon
r_goto
id|out_err
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ctx-&gt;sealalg
op_ne
id|SEAL_ALG_NONE
op_logical_and
id|ctx-&gt;sealalg
op_ne
id|SEAL_ALG_DES
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;RPC: gss_krb5_seal: ctx-&gt;sealalg %d not supported&bslash;n&quot;
comma
id|ctx-&gt;sealalg
)paren
suffix:semicolon
r_goto
id|out_err
suffix:semicolon
)brace
r_if
c_cond
(paren
id|toktype
op_eq
id|KG_TOK_WRAP_MSG
)paren
(brace
id|blocksize
op_assign
id|crypto_tfm_alg_blocksize
c_func
(paren
id|ctx-&gt;enc
)paren
suffix:semicolon
id|tmsglen
op_assign
id|blocksize
op_plus
id|text-&gt;len
op_plus
id|gss_krb5_padding
c_func
(paren
id|blocksize
comma
id|blocksize
op_plus
id|text-&gt;len
)paren
suffix:semicolon
)brace
r_else
(brace
id|tmsglen
op_assign
l_int|0
suffix:semicolon
)brace
id|token-&gt;len
op_assign
id|g_token_size
c_func
(paren
op_amp
id|ctx-&gt;mech_used
comma
l_int|22
op_plus
id|tmsglen
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|token-&gt;data
op_assign
id|kmalloc
c_func
(paren
id|token-&gt;len
comma
id|GFP_KERNEL
)paren
)paren
op_eq
l_int|NULL
)paren
r_goto
id|out_err
suffix:semicolon
id|ptr
op_assign
id|token-&gt;data
suffix:semicolon
id|g_make_token_header
c_func
(paren
op_amp
id|ctx-&gt;mech_used
comma
l_int|22
op_plus
id|tmsglen
comma
op_amp
id|ptr
comma
id|toktype
)paren
suffix:semicolon
multiline_comment|/* ptr now at byte 2 of header described in rfc 1964, section 1.2.1: */
id|krb5_hdr
op_assign
id|ptr
op_minus
l_int|2
suffix:semicolon
id|msg_start
op_assign
id|krb5_hdr
op_plus
l_int|24
suffix:semicolon
op_star
(paren
id|u16
op_star
)paren
(paren
id|krb5_hdr
op_plus
l_int|2
)paren
op_assign
id|htons
c_func
(paren
id|ctx-&gt;signalg
)paren
suffix:semicolon
id|memset
c_func
(paren
id|krb5_hdr
op_plus
l_int|4
comma
l_int|0xff
comma
l_int|4
)paren
suffix:semicolon
r_if
c_cond
(paren
id|toktype
op_eq
id|KG_TOK_WRAP_MSG
)paren
op_star
(paren
id|u16
op_star
)paren
(paren
id|krb5_hdr
op_plus
l_int|4
)paren
op_assign
id|htons
c_func
(paren
id|ctx-&gt;sealalg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|toktype
op_eq
id|KG_TOK_WRAP_MSG
)paren
(brace
r_int
r_char
id|pad
op_assign
id|gss_krb5_padding
c_func
(paren
id|blocksize
comma
id|text-&gt;len
)paren
suffix:semicolon
id|get_random_bytes
c_func
(paren
id|msg_start
comma
id|blocksize
)paren
suffix:semicolon
multiline_comment|/* &quot;confounder&quot; */
id|memcpy
c_func
(paren
id|msg_start
op_plus
id|blocksize
comma
id|text-&gt;data
comma
id|text-&gt;len
)paren
suffix:semicolon
id|memset
c_func
(paren
id|msg_start
op_plus
id|blocksize
op_plus
id|text-&gt;len
comma
id|pad
comma
id|pad
)paren
suffix:semicolon
r_if
c_cond
(paren
id|compute_checksum
c_func
(paren
id|checksum_type
comma
id|krb5_hdr
comma
id|msg_start
comma
id|tmsglen
comma
op_amp
id|md5cksum
)paren
)paren
r_goto
id|out_err
suffix:semicolon
r_if
c_cond
(paren
id|krb5_encrypt
c_func
(paren
id|ctx-&gt;enc
comma
l_int|NULL
comma
id|msg_start
comma
id|msg_start
comma
id|tmsglen
)paren
)paren
r_goto
id|out_err
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* Sign only.  */
r_if
c_cond
(paren
id|compute_checksum
c_func
(paren
id|checksum_type
comma
id|krb5_hdr
comma
id|text-&gt;data
comma
id|text-&gt;len
comma
op_amp
id|md5cksum
)paren
)paren
r_goto
id|out_err
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|ctx-&gt;signalg
)paren
(brace
r_case
id|SGN_ALG_DES_MAC_MD5
suffix:colon
r_if
c_cond
(paren
id|krb5_encrypt
c_func
(paren
id|ctx-&gt;seq
comma
l_int|NULL
comma
id|md5cksum.data
comma
id|md5cksum.data
comma
id|md5cksum.len
)paren
)paren
r_goto
id|out_err
suffix:semicolon
id|memcpy
c_func
(paren
id|krb5_hdr
op_plus
l_int|16
comma
id|md5cksum.data
op_plus
id|md5cksum.len
op_minus
id|CKSUM_SIZE
comma
id|CKSUM_SIZE
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;make_seal_token: cksum data: &bslash;n&quot;
)paren
suffix:semicolon
id|print_hexl
c_func
(paren
(paren
id|u32
op_star
)paren
(paren
id|krb5_hdr
op_plus
l_int|16
)paren
comma
id|CKSUM_SIZE
comma
l_int|0
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|BUG
c_func
(paren
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|md5cksum.data
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|krb5_make_seq_num
c_func
(paren
id|ctx-&gt;seq
comma
id|ctx-&gt;initiate
ques
c_cond
l_int|0
suffix:colon
l_int|0xff
comma
id|ctx-&gt;seq_send
comma
id|krb5_hdr
op_plus
l_int|16
comma
id|krb5_hdr
op_plus
l_int|8
)paren
)paren
)paren
r_goto
id|out_err
suffix:semicolon
id|ctx-&gt;seq_send
op_increment
suffix:semicolon
r_return
(paren
(paren
id|ctx-&gt;endtime
OL
id|now
)paren
ques
c_cond
id|GSS_S_CONTEXT_EXPIRED
suffix:colon
id|GSS_S_COMPLETE
)paren
suffix:semicolon
id|out_err
suffix:colon
r_if
c_cond
(paren
id|md5cksum.data
)paren
id|kfree
c_func
(paren
id|md5cksum.data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|token-&gt;data
)paren
id|kfree
c_func
(paren
id|token-&gt;data
)paren
suffix:semicolon
id|token-&gt;data
op_assign
l_int|0
suffix:semicolon
id|token-&gt;len
op_assign
l_int|0
suffix:semicolon
r_return
id|GSS_S_FAILURE
suffix:semicolon
)brace
eof
