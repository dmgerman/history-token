multiline_comment|/*****************************************************************************&n;* wanproc.c&t;WAN Router Module. /proc filesystem interface.&n;*&n;*&t;&t;This module is completely hardware-independent and provides&n;*&t;&t;access to the router using Linux /proc filesystem.&n;*&n;* Author: &t;Gideon Hack&t;&n;*&n;* Copyright:&t;(c) 1995-1999 Sangoma Technologies Inc.&n;*&n;*&t;&t;This program is free software; you can redistribute it and/or&n;*&t;&t;modify it under the terms of the GNU General Public License&n;*&t;&t;as published by the Free Software Foundation; either version&n;*&t;&t;2 of the License, or (at your option) any later version.&n;* ============================================================================&n;* Jun 02, 1999  Gideon Hack&t;Updates for Linux 2.2.X kernels.&n;* Jun 29, 1997&t;Alan Cox&t;Merged with 1.0.3 vendor code&n;* Jan 29, 1997&t;Gene Kozin&t;v1.0.1. Implemented /proc read routines&n;* Jan 30, 1997&t;Alan Cox&t;Hacked around for 2.1&n;* Dec 13, 1996&t;Gene Kozin&t;Initial version (based on Sangoma&squot;s WANPIPE)&n;*****************************************************************************/
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/stddef.h&gt;&t;/* offsetof(), etc. */
macro_line|#include &lt;linux/errno.h&gt;&t;/* return codes */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/slab.h&gt;&t;/* kmalloc(), kfree() */
macro_line|#include &lt;linux/mm.h&gt;&t;&t;/* verify_area(), etc. */
macro_line|#include &lt;linux/string.h&gt;&t;/* inline mem*, str* functions */
macro_line|#include &lt;asm/byteorder.h&gt;&t;/* htons(), etc. */
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;linux/wanrouter.h&gt;&t;/* WAN router API definitions */
macro_line|#include &lt;linux/seq_file.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/init.h&gt;&t;/* __initfunc et al. */
macro_line|#include &lt;asm/uaccess.h&gt;       /* copy_to_user */
DECL|macro|PROC_STATS_FORMAT
mdefine_line|#define PROC_STATS_FORMAT &quot;%30s: %12lu&bslash;n&quot;
multiline_comment|/****** Defines and Macros **************************************************/
DECL|macro|PROT_DECODE
mdefine_line|#define PROT_DECODE(prot) ((prot == WANCONFIG_FR) ? &quot; FR&quot; :&bslash;&n;&t;&t;&t;      (prot == WANCONFIG_X25) ? &quot; X25&quot; : &bslash;&n;&t;&t;&t;         (prot == WANCONFIG_PPP) ? &quot; PPP&quot; : &bslash;&n;&t;&t;&t;&t;    (prot == WANCONFIG_CHDLC) ? &quot; CHDLC&quot;: &bslash;&n;&t;&t;&t;&t;       (prot == WANCONFIG_MPPP) ? &quot; MPPP&quot; : &bslash;&n;&t;&t;&t;&t;           &quot; Unknown&quot; )
multiline_comment|/****** Data Types **********************************************************/
DECL|struct|wan_stat_entry
r_typedef
r_struct
id|wan_stat_entry
(brace
DECL|member|next
r_struct
id|wan_stat_entry
op_star
id|next
suffix:semicolon
DECL|member|description
r_char
op_star
id|description
suffix:semicolon
multiline_comment|/* description string */
DECL|member|data
r_void
op_star
id|data
suffix:semicolon
multiline_comment|/* -&gt; data */
DECL|member|data_type
r_int
id|data_type
suffix:semicolon
multiline_comment|/* data type */
DECL|typedef|wan_stat_entry_t
)brace
id|wan_stat_entry_t
suffix:semicolon
multiline_comment|/****** Function Prototypes *************************************************/
macro_line|#ifdef CONFIG_PROC_FS
multiline_comment|/* Proc filesystem interface */
r_static
r_int
id|router_proc_perms
c_func
(paren
r_struct
id|inode
op_star
comma
r_int
)paren
suffix:semicolon
multiline_comment|/* Miscellaneous */
multiline_comment|/*&n; *&t;Structures for interfacing with the /proc filesystem.&n; *&t;Router creates its own directory /proc/net/router with the folowing&n; *&t;entries:&n; *&t;config&t;&t;device configuration&n; *&t;status&t;&t;global device statistics&n; *&t;&lt;device&gt;&t;entry for each WAN device&n; */
multiline_comment|/*&n; *&t;Generic /proc/net/router/&lt;file&gt; file and inode operations &n; */
DECL|variable|router_inode
r_static
r_struct
id|inode_operations
id|router_inode
op_assign
(brace
id|permission
suffix:colon
id|router_proc_perms
comma
)brace
suffix:semicolon
multiline_comment|/*&n; *&t;/proc/net/router &n; */
DECL|variable|proc_router
r_static
r_struct
id|proc_dir_entry
op_star
id|proc_router
suffix:semicolon
multiline_comment|/* Strings */
multiline_comment|/*&n; *&t;Interface functions&n; */
multiline_comment|/****** Proc filesystem entry points ****************************************/
multiline_comment|/*&n; *&t;Verify access rights.&n; */
DECL|function|router_proc_perms
r_static
r_int
id|router_proc_perms
(paren
r_struct
id|inode
op_star
id|inode
comma
r_int
id|op
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Iterator&n; */
DECL|function|r_start
r_static
r_void
op_star
id|r_start
c_func
(paren
r_struct
id|seq_file
op_star
id|m
comma
id|loff_t
op_star
id|pos
)paren
(brace
id|wan_device_t
op_star
id|wandev
suffix:semicolon
id|loff_t
id|l
op_assign
op_star
id|pos
suffix:semicolon
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|l
op_decrement
)paren
r_return
(paren
r_void
op_star
)paren
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|wandev
op_assign
id|router_devlist
suffix:semicolon
id|l
op_decrement
op_logical_and
id|wandev
suffix:semicolon
id|wandev
op_assign
id|wandev-&gt;next
)paren
suffix:semicolon
r_return
id|wandev
suffix:semicolon
)brace
DECL|function|r_next
r_static
r_void
op_star
id|r_next
c_func
(paren
r_struct
id|seq_file
op_star
id|m
comma
r_void
op_star
id|v
comma
id|loff_t
op_star
id|pos
)paren
(brace
id|wan_device_t
op_star
id|wandev
op_assign
id|v
suffix:semicolon
(paren
op_star
id|pos
)paren
op_increment
suffix:semicolon
r_return
(paren
id|v
op_eq
(paren
r_void
op_star
)paren
l_int|1
)paren
ques
c_cond
id|router_devlist
suffix:colon
id|wandev-&gt;next
suffix:semicolon
)brace
DECL|function|r_stop
r_static
r_void
id|r_stop
c_func
(paren
r_struct
id|seq_file
op_star
id|m
comma
r_void
op_star
id|v
)paren
(brace
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|config_show
r_static
r_int
id|config_show
c_func
(paren
r_struct
id|seq_file
op_star
id|m
comma
r_void
op_star
id|v
)paren
(brace
id|wan_device_t
op_star
id|p
op_assign
id|v
suffix:semicolon
r_if
c_cond
(paren
id|v
op_eq
(paren
r_void
op_star
)paren
l_int|1
)paren
(brace
id|seq_puts
c_func
(paren
id|m
comma
l_string|&quot;Device name    | port |IRQ|DMA|  mem.addr  |&quot;
)paren
suffix:semicolon
id|seq_puts
c_func
(paren
id|m
comma
l_string|&quot;mem.size|option1|option2|option3|option4&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|p-&gt;state
)paren
r_return
l_int|0
suffix:semicolon
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;%-15s|0x%-4X|%3u|%3u| 0x%-8lX |0x%-6X|%7u|%7u|%7u|%7u&bslash;n&quot;
comma
id|p-&gt;name
comma
id|p-&gt;ioport
comma
id|p-&gt;irq
comma
id|p-&gt;dma
comma
id|p-&gt;maddr
comma
id|p-&gt;msize
comma
id|p-&gt;hw_opt
(braket
l_int|0
)braket
comma
id|p-&gt;hw_opt
(braket
l_int|1
)braket
comma
id|p-&gt;hw_opt
(braket
l_int|2
)braket
comma
id|p-&gt;hw_opt
(braket
l_int|3
)braket
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|status_show
r_static
r_int
id|status_show
c_func
(paren
r_struct
id|seq_file
op_star
id|m
comma
r_void
op_star
id|v
)paren
(brace
id|wan_device_t
op_star
id|p
op_assign
id|v
suffix:semicolon
r_if
c_cond
(paren
id|v
op_eq
(paren
r_void
op_star
)paren
l_int|1
)paren
(brace
id|seq_puts
c_func
(paren
id|m
comma
l_string|&quot;Device name    |protocol|station|interface|&quot;
)paren
suffix:semicolon
id|seq_puts
c_func
(paren
id|m
comma
l_string|&quot;clocking|baud rate| MTU |ndev|link state&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|p-&gt;state
)paren
r_return
l_int|0
suffix:semicolon
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;%-15s|%-8s|%-7s|%-9s|%-8s|%9u|%5u|%3u |&quot;
comma
id|p-&gt;name
comma
id|PROT_DECODE
c_func
(paren
id|p-&gt;config_id
)paren
comma
id|p-&gt;config_id
op_eq
id|WANCONFIG_FR
ques
c_cond
(paren
id|p-&gt;station
ques
c_cond
l_string|&quot; Node&quot;
suffix:colon
l_string|&quot; CPE&quot;
)paren
suffix:colon
(paren
id|p-&gt;config_id
op_eq
id|WANCONFIG_X25
ques
c_cond
(paren
id|p-&gt;station
ques
c_cond
l_string|&quot; DCE&quot;
suffix:colon
l_string|&quot; DTE&quot;
)paren
suffix:colon
(paren
l_string|&quot; N/A&quot;
)paren
)paren
comma
id|p-&gt;interface
ques
c_cond
l_string|&quot; V.35&quot;
suffix:colon
l_string|&quot; RS-232&quot;
comma
id|p-&gt;clocking
ques
c_cond
l_string|&quot;internal&quot;
suffix:colon
l_string|&quot;external&quot;
comma
id|p-&gt;bps
comma
id|p-&gt;mtu
comma
id|p-&gt;ndev
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|p-&gt;state
)paren
(brace
r_case
id|WAN_UNCONFIGURED
suffix:colon
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;%-12s&bslash;n&quot;
comma
l_string|&quot;unconfigured&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|WAN_DISCONNECTED
suffix:colon
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;%-12s&bslash;n&quot;
comma
l_string|&quot;disconnected&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|WAN_CONNECTING
suffix:colon
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;%-12s&bslash;n&quot;
comma
l_string|&quot;connecting&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|WAN_CONNECTED
suffix:colon
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;%-12s&bslash;n&quot;
comma
l_string|&quot;connected&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;%-12s&bslash;n&quot;
comma
l_string|&quot;invalid&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|config_op
r_static
r_struct
id|seq_operations
id|config_op
op_assign
(brace
id|start
suffix:colon
id|r_start
comma
id|next
suffix:colon
id|r_next
comma
id|stop
suffix:colon
id|r_stop
comma
id|show
suffix:colon
id|config_show
)brace
suffix:semicolon
DECL|variable|status_op
r_static
r_struct
id|seq_operations
id|status_op
op_assign
(brace
id|start
suffix:colon
id|r_start
comma
id|next
suffix:colon
id|r_next
comma
id|stop
suffix:colon
id|r_stop
comma
id|show
suffix:colon
id|status_show
)brace
suffix:semicolon
DECL|function|config_open
r_static
r_int
id|config_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_return
id|seq_open
c_func
(paren
id|file
comma
op_amp
id|config_op
)paren
suffix:semicolon
)brace
DECL|function|status_open
r_static
r_int
id|status_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_return
id|seq_open
c_func
(paren
id|file
comma
op_amp
id|status_op
)paren
suffix:semicolon
)brace
DECL|variable|config_fops
r_static
r_struct
id|file_operations
id|config_fops
op_assign
(brace
id|open
suffix:colon
id|config_open
comma
id|read
suffix:colon
id|seq_read
comma
id|llseek
suffix:colon
id|seq_lseek
comma
id|release
suffix:colon
id|seq_release
comma
)brace
suffix:semicolon
DECL|variable|status_fops
r_static
r_struct
id|file_operations
id|status_fops
op_assign
(brace
id|open
suffix:colon
id|status_open
comma
id|read
suffix:colon
id|seq_read
comma
id|llseek
suffix:colon
id|seq_lseek
comma
id|release
suffix:colon
id|seq_release
comma
)brace
suffix:semicolon
DECL|function|single_start
r_static
r_void
op_star
id|single_start
c_func
(paren
r_struct
id|seq_file
op_star
id|p
comma
id|loff_t
op_star
id|pos
)paren
(brace
r_return
op_star
id|pos
op_eq
l_int|0
ques
c_cond
id|p
op_member_access_from_pointer
r_private
suffix:colon
l_int|NULL
suffix:semicolon
)brace
DECL|function|single_next
r_static
r_void
op_star
id|single_next
c_func
(paren
r_struct
id|seq_file
op_star
id|p
comma
r_void
op_star
id|v
comma
id|loff_t
op_star
id|pos
)paren
(brace
op_increment
op_star
id|pos
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|single_stop
r_static
r_void
id|single_stop
c_func
(paren
r_struct
id|seq_file
op_star
id|p
comma
r_void
op_star
id|v
)paren
(brace
)brace
DECL|function|wandev_show
r_static
r_int
id|wandev_show
c_func
(paren
r_struct
id|seq_file
op_star
id|m
comma
r_void
op_star
id|v
)paren
(brace
id|wan_device_t
op_star
id|wandev
op_assign
id|v
suffix:semicolon
r_if
c_cond
(paren
id|wandev-&gt;magic
op_ne
id|ROUTER_MAGIC
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|wandev-&gt;state
)paren
(brace
id|seq_puts
c_func
(paren
id|m
comma
l_string|&quot;device is not configured!&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Update device statistics */
r_if
c_cond
(paren
id|wandev-&gt;update
)paren
(brace
r_int
id|err
op_assign
id|wandev
op_member_access_from_pointer
id|update
c_func
(paren
id|wandev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_eq
op_minus
id|EAGAIN
)paren
(brace
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;Device is busy!&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|err
)paren
(brace
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;Device is not configured!&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
id|seq_printf
c_func
(paren
id|m
comma
id|PROC_STATS_FORMAT
comma
l_string|&quot;total packets received&quot;
comma
id|wandev-&gt;stats.rx_packets
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|m
comma
id|PROC_STATS_FORMAT
comma
l_string|&quot;total packets transmitted&quot;
comma
id|wandev-&gt;stats.tx_packets
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|m
comma
id|PROC_STATS_FORMAT
comma
l_string|&quot;total bytes received&quot;
comma
id|wandev-&gt;stats.rx_bytes
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|m
comma
id|PROC_STATS_FORMAT
comma
l_string|&quot;total bytes transmitted&quot;
comma
id|wandev-&gt;stats.tx_bytes
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|m
comma
id|PROC_STATS_FORMAT
comma
l_string|&quot;bad packets received&quot;
comma
id|wandev-&gt;stats.rx_errors
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|m
comma
id|PROC_STATS_FORMAT
comma
l_string|&quot;packet transmit problems&quot;
comma
id|wandev-&gt;stats.tx_errors
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|m
comma
id|PROC_STATS_FORMAT
comma
l_string|&quot;received frames dropped&quot;
comma
id|wandev-&gt;stats.rx_dropped
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|m
comma
id|PROC_STATS_FORMAT
comma
l_string|&quot;transmit frames dropped&quot;
comma
id|wandev-&gt;stats.tx_dropped
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|m
comma
id|PROC_STATS_FORMAT
comma
l_string|&quot;multicast packets received&quot;
comma
id|wandev-&gt;stats.multicast
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|m
comma
id|PROC_STATS_FORMAT
comma
l_string|&quot;transmit collisions&quot;
comma
id|wandev-&gt;stats.collisions
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|m
comma
id|PROC_STATS_FORMAT
comma
l_string|&quot;receive length errors&quot;
comma
id|wandev-&gt;stats.rx_length_errors
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|m
comma
id|PROC_STATS_FORMAT
comma
l_string|&quot;receiver overrun errors&quot;
comma
id|wandev-&gt;stats.rx_over_errors
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|m
comma
id|PROC_STATS_FORMAT
comma
l_string|&quot;CRC errors&quot;
comma
id|wandev-&gt;stats.rx_crc_errors
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|m
comma
id|PROC_STATS_FORMAT
comma
l_string|&quot;frame format errors (aborts)&quot;
comma
id|wandev-&gt;stats.rx_frame_errors
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|m
comma
id|PROC_STATS_FORMAT
comma
l_string|&quot;receiver fifo overrun&quot;
comma
id|wandev-&gt;stats.rx_fifo_errors
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|m
comma
id|PROC_STATS_FORMAT
comma
l_string|&quot;receiver missed packet&quot;
comma
id|wandev-&gt;stats.rx_missed_errors
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|m
comma
id|PROC_STATS_FORMAT
comma
l_string|&quot;aborted frames transmitted&quot;
comma
id|wandev-&gt;stats.tx_aborted_errors
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|wandev_op
r_static
r_struct
id|seq_operations
id|wandev_op
op_assign
(brace
id|start
suffix:colon
id|single_start
comma
id|next
suffix:colon
id|single_next
comma
id|stop
suffix:colon
id|single_stop
comma
id|show
suffix:colon
id|wandev_show
comma
)brace
suffix:semicolon
DECL|function|wandev_open
r_static
r_int
id|wandev_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_int
id|ret
op_assign
id|seq_open
c_func
(paren
id|file
comma
op_amp
id|wandev_op
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
(brace
r_struct
id|seq_file
op_star
id|m
op_assign
id|file-&gt;private_data
suffix:semicolon
id|m
op_member_access_from_pointer
r_private
op_assign
id|PDE
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|data
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|variable|wandev_fops
r_static
r_struct
id|file_operations
id|wandev_fops
op_assign
(brace
id|open
suffix:colon
id|wandev_open
comma
id|read
suffix:colon
id|seq_read
comma
id|llseek
suffix:colon
id|seq_lseek
comma
id|release
suffix:colon
id|seq_release
comma
id|ioctl
suffix:colon
id|wanrouter_ioctl
comma
)brace
suffix:semicolon
multiline_comment|/*&n; *&t;Initialize router proc interface.&n; */
DECL|function|wanrouter_proc_init
r_int
id|__init
id|wanrouter_proc_init
(paren
r_void
)paren
(brace
r_struct
id|proc_dir_entry
op_star
id|p
suffix:semicolon
id|proc_router
op_assign
id|proc_mkdir
c_func
(paren
id|ROUTER_NAME
comma
id|proc_net
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|proc_router
)paren
r_goto
id|fail
suffix:semicolon
id|p
op_assign
id|create_proc_entry
c_func
(paren
l_string|&quot;config&quot;
comma
l_int|0
comma
id|proc_router
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|p
)paren
r_goto
id|fail_config
suffix:semicolon
id|p-&gt;proc_fops
op_assign
op_amp
id|config_fops
suffix:semicolon
id|p-&gt;proc_iops
op_assign
op_amp
id|router_inode
suffix:semicolon
id|p
op_assign
id|create_proc_entry
c_func
(paren
l_string|&quot;status&quot;
comma
l_int|0
comma
id|proc_router
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|p
)paren
r_goto
id|fail_stat
suffix:semicolon
id|p-&gt;proc_fops
op_assign
op_amp
id|status_fops
suffix:semicolon
id|p-&gt;proc_iops
op_assign
op_amp
id|router_inode
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|fail_stat
suffix:colon
id|remove_proc_entry
c_func
(paren
l_string|&quot;config&quot;
comma
id|proc_router
)paren
suffix:semicolon
id|fail_config
suffix:colon
id|remove_proc_entry
c_func
(paren
id|ROUTER_NAME
comma
id|proc_net
)paren
suffix:semicolon
id|fail
suffix:colon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Clean up router proc interface.&n; */
DECL|function|wanrouter_proc_cleanup
r_void
id|wanrouter_proc_cleanup
(paren
r_void
)paren
(brace
id|remove_proc_entry
c_func
(paren
l_string|&quot;config&quot;
comma
id|proc_router
)paren
suffix:semicolon
id|remove_proc_entry
c_func
(paren
l_string|&quot;status&quot;
comma
id|proc_router
)paren
suffix:semicolon
id|remove_proc_entry
c_func
(paren
id|ROUTER_NAME
comma
id|proc_net
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Add directory entry for WAN device.&n; */
DECL|function|wanrouter_proc_add
r_int
id|wanrouter_proc_add
(paren
id|wan_device_t
op_star
id|wandev
)paren
(brace
r_if
c_cond
(paren
id|wandev-&gt;magic
op_ne
id|ROUTER_MAGIC
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|wandev-&gt;dent
op_assign
id|create_proc_entry
c_func
(paren
id|wandev-&gt;name
comma
l_int|0
comma
id|proc_router
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|wandev-&gt;dent
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|wandev-&gt;dent-&gt;proc_fops
op_assign
op_amp
id|wandev_fops
suffix:semicolon
id|wandev-&gt;dent-&gt;proc_iops
op_assign
op_amp
id|router_inode
suffix:semicolon
id|wandev-&gt;dent-&gt;data
op_assign
id|wandev
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Delete directory entry for WAN device.&n; */
DECL|function|wanrouter_proc_delete
r_int
id|wanrouter_proc_delete
c_func
(paren
id|wan_device_t
op_star
id|wandev
)paren
(brace
r_if
c_cond
(paren
id|wandev-&gt;magic
op_ne
id|ROUTER_MAGIC
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|remove_proc_entry
c_func
(paren
id|wandev-&gt;name
comma
id|proc_router
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#else
multiline_comment|/*&n; *&t;No /proc - output stubs&n; */
DECL|function|wanrouter_proc_init
r_int
id|__init
id|wanrouter_proc_init
c_func
(paren
r_void
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|wanrouter_proc_cleanup
r_void
id|wanrouter_proc_cleanup
c_func
(paren
r_void
)paren
(brace
)brace
DECL|function|wanrouter_proc_add
r_int
id|wanrouter_proc_add
c_func
(paren
id|wan_device_t
op_star
id|wandev
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|wanrouter_proc_delete
r_int
id|wanrouter_proc_delete
c_func
(paren
id|wan_device_t
op_star
id|wandev
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/*&n; *&t;End&n; */
eof
