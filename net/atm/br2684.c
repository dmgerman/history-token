multiline_comment|/*&n;Experimental ethernet netdevice using ATM AAL5 as underlying carrier&n;(RFC1483 obsoleted by RFC2684) for Linux 2.4&n;Author: Marcell GAL, 2000, XDSL Ltd, Hungary&n;*/
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/list.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/rtnetlink.h&gt;
macro_line|#include &lt;linux/ip.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;net/arp.h&gt;
macro_line|#include &lt;linux/atm.h&gt;
macro_line|#include &lt;linux/atmdev.h&gt;
macro_line|#include &lt;linux/seq_file.h&gt;
macro_line|#include &lt;linux/atmbr2684.h&gt;
macro_line|#include &quot;common.h&quot;
macro_line|#include &quot;ipcommon.h&quot;
multiline_comment|/*&n; * Define this to use a version of the code which interacts with the higher&n; * layers in a more intellegent way, by always reserving enough space for&n; * our header at the begining of the packet.  However, there may still be&n; * some problems with programs like tcpdump.  In 2.5 we&squot;ll sort out what&n; * we need to do to get this perfect.  For now we just will copy the packet&n; * if we need space for the header&n; */
multiline_comment|/* #define FASTER_VERSION */
macro_line|#ifdef DEBUG
DECL|macro|DPRINTK
mdefine_line|#define DPRINTK(format, args...) printk(KERN_DEBUG &quot;br2684: &quot; format, ##args)
macro_line|#else
DECL|macro|DPRINTK
mdefine_line|#define DPRINTK(format, args...)
macro_line|#endif
macro_line|#ifdef SKB_DEBUG
DECL|function|skb_debug
r_static
r_void
id|skb_debug
c_func
(paren
r_const
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
DECL|macro|NUM2PRINT
mdefine_line|#define NUM2PRINT 50
r_char
id|buf
(braket
id|NUM2PRINT
op_star
l_int|3
op_plus
l_int|1
)braket
suffix:semicolon
multiline_comment|/* 3 chars per byte */
r_int
id|i
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|skb-&gt;len
op_logical_and
id|i
OL
id|NUM2PRINT
suffix:semicolon
id|i
op_increment
)paren
(brace
id|sprintf
c_func
(paren
id|buf
op_plus
id|i
op_star
l_int|3
comma
l_string|&quot;%2.2x &quot;
comma
l_int|0xff
op_amp
id|skb-&gt;data
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;br2684: skb: %s&bslash;n&quot;
comma
id|buf
)paren
suffix:semicolon
)brace
macro_line|#else
DECL|macro|skb_debug
mdefine_line|#define skb_debug(skb)&t;do {} while (0)
macro_line|#endif
DECL|variable|llc_oui_pid_pad
r_static
r_int
r_char
id|llc_oui_pid_pad
(braket
)braket
op_assign
(brace
l_int|0xAA
comma
l_int|0xAA
comma
l_int|0x03
comma
l_int|0x00
comma
l_int|0x80
comma
l_int|0xC2
comma
l_int|0x00
comma
l_int|0x07
comma
l_int|0x00
comma
l_int|0x00
)brace
suffix:semicolon
DECL|macro|PADLEN
mdefine_line|#define PADLEN&t;(2)
DECL|enum|br2684_encaps
r_enum
id|br2684_encaps
(brace
DECL|enumerator|e_vc
id|e_vc
op_assign
id|BR2684_ENCAPS_VC
comma
DECL|enumerator|e_llc
id|e_llc
op_assign
id|BR2684_ENCAPS_LLC
comma
)brace
suffix:semicolon
DECL|struct|br2684_vcc
r_struct
id|br2684_vcc
(brace
DECL|member|atmvcc
r_struct
id|atm_vcc
op_star
id|atmvcc
suffix:semicolon
DECL|member|device
r_struct
id|net_device
op_star
id|device
suffix:semicolon
multiline_comment|/* keep old push,pop functions for chaining */
DECL|member|old_push
r_void
(paren
op_star
id|old_push
)paren
(paren
r_struct
id|atm_vcc
op_star
id|vcc
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
suffix:semicolon
multiline_comment|/* void (*old_pop)(struct atm_vcc *vcc,struct sk_buff *skb); */
DECL|member|encaps
r_enum
id|br2684_encaps
id|encaps
suffix:semicolon
DECL|member|brvccs
r_struct
id|list_head
id|brvccs
suffix:semicolon
macro_line|#ifdef CONFIG_ATM_BR2684_IPFILTER
DECL|member|filter
r_struct
id|br2684_filter
id|filter
suffix:semicolon
macro_line|#endif /* CONFIG_ATM_BR2684_IPFILTER */
macro_line|#ifndef FASTER_VERSION
DECL|member|copies_needed
DECL|member|copies_failed
r_int
id|copies_needed
comma
id|copies_failed
suffix:semicolon
macro_line|#endif /* FASTER_VERSION */
)brace
suffix:semicolon
DECL|struct|br2684_dev
r_struct
id|br2684_dev
(brace
DECL|member|net_dev
r_struct
id|net_device
op_star
id|net_dev
suffix:semicolon
DECL|member|br2684_devs
r_struct
id|list_head
id|br2684_devs
suffix:semicolon
DECL|member|number
r_int
id|number
suffix:semicolon
DECL|member|brvccs
r_struct
id|list_head
id|brvccs
suffix:semicolon
multiline_comment|/* one device &lt;=&gt; one vcc (before xmas) */
DECL|member|stats
r_struct
id|net_device_stats
id|stats
suffix:semicolon
DECL|member|mac_was_set
r_int
id|mac_was_set
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/*&n; * This lock should be held for writing any time the list of devices or&n; * their attached vcc&squot;s could be altered.  It should be held for reading&n; * any time these are being queried.  Note that we sometimes need to&n; * do read-locking under interrupt context, so write locking must block&n; * the current CPU&squot;s interrupts&n; */
DECL|variable|devs_lock
r_static
id|rwlock_t
id|devs_lock
op_assign
id|RW_LOCK_UNLOCKED
suffix:semicolon
r_static
id|LIST_HEAD
c_func
(paren
id|br2684_devs
)paren
suffix:semicolon
DECL|function|BRPRIV
r_static
r_inline
r_struct
id|br2684_dev
op_star
id|BRPRIV
c_func
(paren
r_const
r_struct
id|net_device
op_star
id|net_dev
)paren
(brace
r_return
(paren
r_struct
id|br2684_dev
op_star
)paren
id|net_dev-&gt;priv
suffix:semicolon
)brace
DECL|function|list_entry_brdev
r_static
r_inline
r_struct
id|net_device
op_star
id|list_entry_brdev
c_func
(paren
r_const
r_struct
id|list_head
op_star
id|le
)paren
(brace
r_return
id|list_entry
c_func
(paren
id|le
comma
r_struct
id|br2684_dev
comma
id|br2684_devs
)paren
op_member_access_from_pointer
id|net_dev
suffix:semicolon
)brace
DECL|function|BR2684_VCC
r_static
r_inline
r_struct
id|br2684_vcc
op_star
id|BR2684_VCC
c_func
(paren
r_const
r_struct
id|atm_vcc
op_star
id|atmvcc
)paren
(brace
r_return
(paren
r_struct
id|br2684_vcc
op_star
)paren
(paren
id|atmvcc-&gt;user_back
)paren
suffix:semicolon
)brace
DECL|function|list_entry_brvcc
r_static
r_inline
r_struct
id|br2684_vcc
op_star
id|list_entry_brvcc
c_func
(paren
r_const
r_struct
id|list_head
op_star
id|le
)paren
(brace
r_return
id|list_entry
c_func
(paren
id|le
comma
r_struct
id|br2684_vcc
comma
id|brvccs
)paren
suffix:semicolon
)brace
multiline_comment|/* Caller should hold read_lock(&amp;devs_lock) */
DECL|function|br2684_find_dev
r_static
r_struct
id|net_device
op_star
id|br2684_find_dev
c_func
(paren
r_const
r_struct
id|br2684_if_spec
op_star
id|s
)paren
(brace
r_struct
id|list_head
op_star
id|lh
suffix:semicolon
r_struct
id|net_device
op_star
id|net_dev
suffix:semicolon
r_switch
c_cond
(paren
id|s-&gt;method
)paren
(brace
r_case
id|BR2684_FIND_BYNUM
suffix:colon
id|list_for_each
c_func
(paren
id|lh
comma
op_amp
id|br2684_devs
)paren
(brace
id|net_dev
op_assign
id|list_entry_brdev
c_func
(paren
id|lh
)paren
suffix:semicolon
r_if
c_cond
(paren
id|BRPRIV
c_func
(paren
id|net_dev
)paren
op_member_access_from_pointer
id|number
op_eq
id|s-&gt;spec.devnum
)paren
r_return
id|net_dev
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|BR2684_FIND_BYIFNAME
suffix:colon
id|list_for_each
c_func
(paren
id|lh
comma
op_amp
id|br2684_devs
)paren
(brace
id|net_dev
op_assign
id|list_entry_brdev
c_func
(paren
id|lh
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strncmp
c_func
(paren
id|net_dev-&gt;name
comma
id|s-&gt;spec.ifname
comma
id|IFNAMSIZ
)paren
)paren
r_return
id|net_dev
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; * Send a packet out a particular vcc.  Not to useful right now, but paves&n; * the way for multiple vcc&squot;s per itf.  Returns true if we can send,&n; * otherwise false&n; */
DECL|function|br2684_xmit_vcc
r_static
r_int
id|br2684_xmit_vcc
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|br2684_dev
op_star
id|brdev
comma
r_struct
id|br2684_vcc
op_star
id|brvcc
)paren
(brace
r_struct
id|atm_vcc
op_star
id|atmvcc
suffix:semicolon
macro_line|#ifdef FASTER_VERSION
r_if
c_cond
(paren
id|brvcc-&gt;encaps
op_eq
id|e_llc
)paren
id|memcpy
c_func
(paren
id|skb_push
c_func
(paren
id|skb
comma
l_int|8
)paren
comma
id|llc_oui_pid_pad
comma
l_int|8
)paren
suffix:semicolon
multiline_comment|/* last 2 bytes of llc_oui_pid_pad are managed by header routines;&n;&t;   yes, you got it: 8 + 2 = sizeof(llc_oui_pid_pad)&n;&t; */
macro_line|#else
r_int
id|minheadroom
op_assign
(paren
id|brvcc-&gt;encaps
op_eq
id|e_llc
)paren
ques
c_cond
l_int|10
suffix:colon
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|skb_headroom
c_func
(paren
id|skb
)paren
OL
id|minheadroom
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb2
op_assign
id|skb_realloc_headroom
c_func
(paren
id|skb
comma
id|minheadroom
)paren
suffix:semicolon
id|brvcc-&gt;copies_needed
op_increment
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb2
op_eq
l_int|NULL
)paren
(brace
id|brvcc-&gt;copies_failed
op_increment
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|skb
op_assign
id|skb2
suffix:semicolon
)brace
id|skb_push
c_func
(paren
id|skb
comma
id|minheadroom
)paren
suffix:semicolon
r_if
c_cond
(paren
id|brvcc-&gt;encaps
op_eq
id|e_llc
)paren
id|memcpy
c_func
(paren
id|skb-&gt;data
comma
id|llc_oui_pid_pad
comma
l_int|10
)paren
suffix:semicolon
r_else
id|memset
c_func
(paren
id|skb-&gt;data
comma
l_int|0
comma
l_int|2
)paren
suffix:semicolon
macro_line|#endif /* FASTER_VERSION */
id|skb_debug
c_func
(paren
id|skb
)paren
suffix:semicolon
id|ATM_SKB
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|vcc
op_assign
id|atmvcc
op_assign
id|brvcc-&gt;atmvcc
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;atm_skb(%p)-&gt;vcc(%p)-&gt;dev(%p)&bslash;n&quot;
comma
id|skb
comma
id|atmvcc
comma
id|atmvcc-&gt;dev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|atm_may_send
c_func
(paren
id|atmvcc
comma
id|skb-&gt;truesize
)paren
)paren
(brace
multiline_comment|/* we free this here for now, because we cannot know in a higher &n;&t;&t;&t;layer whether the skb point it supplied wasn&squot;t freed yet.&n;&t;&t;&t;now, it always is.&n;&t;&t;*/
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|atomic_add
c_func
(paren
id|skb-&gt;truesize
comma
op_amp
id|atmvcc-&gt;sk-&gt;sk_wmem_alloc
)paren
suffix:semicolon
id|ATM_SKB
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|atm_options
op_assign
id|atmvcc-&gt;atm_options
suffix:semicolon
id|brdev-&gt;stats.tx_packets
op_increment
suffix:semicolon
id|brdev-&gt;stats.tx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
id|atmvcc
op_member_access_from_pointer
id|send
c_func
(paren
id|atmvcc
comma
id|skb
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|pick_outgoing_vcc
r_static
r_inline
r_struct
id|br2684_vcc
op_star
id|pick_outgoing_vcc
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|br2684_dev
op_star
id|brdev
)paren
(brace
r_return
id|list_empty
c_func
(paren
op_amp
id|brdev-&gt;brvccs
)paren
ques
c_cond
l_int|NULL
suffix:colon
id|list_entry_brvcc
c_func
(paren
id|brdev-&gt;brvccs.next
)paren
suffix:semicolon
multiline_comment|/* 1 vcc/dev right now */
)brace
DECL|function|br2684_start_xmit
r_static
r_int
id|br2684_start_xmit
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|br2684_dev
op_star
id|brdev
op_assign
id|BRPRIV
c_func
(paren
id|dev
)paren
suffix:semicolon
r_struct
id|br2684_vcc
op_star
id|brvcc
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;br2684_start_xmit, skb-&gt;dst=%p&bslash;n&quot;
comma
id|skb-&gt;dst
)paren
suffix:semicolon
id|read_lock
c_func
(paren
op_amp
id|devs_lock
)paren
suffix:semicolon
id|brvcc
op_assign
id|pick_outgoing_vcc
c_func
(paren
id|skb
comma
id|brdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|brvcc
op_eq
l_int|NULL
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;no vcc attached to dev %s&bslash;n&quot;
comma
id|dev-&gt;name
)paren
suffix:semicolon
id|brdev-&gt;stats.tx_errors
op_increment
suffix:semicolon
id|brdev-&gt;stats.tx_carrier_errors
op_increment
suffix:semicolon
multiline_comment|/* netif_stop_queue(dev); */
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|read_unlock
c_func
(paren
op_amp
id|devs_lock
)paren
suffix:semicolon
r_return
op_minus
id|EUNATCH
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|br2684_xmit_vcc
c_func
(paren
id|skb
comma
id|brdev
comma
id|brvcc
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t; * We should probably use netif_*_queue() here, but that&n;&t;&t; * involves added complication.  We need to walk before&n;&t;&t; * we can run&n;&t;&t; */
multiline_comment|/* don&squot;t free here! this pointer might be no longer valid!&n;&t;&t;dev_kfree_skb(skb);&n;&t;&t;*/
id|brdev-&gt;stats.tx_errors
op_increment
suffix:semicolon
id|brdev-&gt;stats.tx_fifo_errors
op_increment
suffix:semicolon
)brace
id|read_unlock
c_func
(paren
op_amp
id|devs_lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|br2684_get_stats
r_static
r_struct
id|net_device_stats
op_star
id|br2684_get_stats
c_func
(paren
r_struct
id|net_device
op_star
id|dev
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;br2684_get_stats&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_amp
id|BRPRIV
c_func
(paren
id|dev
)paren
op_member_access_from_pointer
id|stats
suffix:semicolon
)brace
macro_line|#ifdef FASTER_VERSION
multiline_comment|/*&n; * These mirror eth_header and eth_header_cache.  They are not usually&n; * exported for use in modules, so we grab them from net_device&n; * after ether_setup() is done with it.  Bit of a hack.&n; */
DECL|variable|my_eth_header
r_static
r_int
(paren
op_star
id|my_eth_header
)paren
(paren
r_struct
id|sk_buff
op_star
comma
r_struct
id|net_device
op_star
comma
r_int
r_int
comma
r_void
op_star
comma
r_void
op_star
comma
r_int
)paren
suffix:semicolon
DECL|variable|my_eth_header_cache
r_static
r_int
(paren
op_star
id|my_eth_header_cache
)paren
(paren
r_struct
id|neighbour
op_star
comma
r_struct
id|hh_cache
op_star
)paren
suffix:semicolon
r_static
r_int
DECL|function|br2684_header
id|br2684_header
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
comma
r_int
r_int
id|type
comma
r_void
op_star
id|daddr
comma
r_void
op_star
id|saddr
comma
r_int
id|len
)paren
(brace
id|u16
op_star
id|pad_before_eth
suffix:semicolon
r_int
id|t
op_assign
id|my_eth_header
c_func
(paren
id|skb
comma
id|dev
comma
id|type
comma
id|daddr
comma
id|saddr
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|t
OG
l_int|0
)paren
(brace
id|pad_before_eth
op_assign
(paren
id|u16
op_star
)paren
id|skb_push
c_func
(paren
id|skb
comma
l_int|2
)paren
suffix:semicolon
op_star
id|pad_before_eth
op_assign
l_int|0
suffix:semicolon
r_return
id|dev-&gt;hard_header_len
suffix:semicolon
multiline_comment|/* or return 16; ? */
)brace
r_else
r_return
id|t
suffix:semicolon
)brace
r_static
r_int
DECL|function|br2684_header_cache
id|br2684_header_cache
c_func
(paren
r_struct
id|neighbour
op_star
id|neigh
comma
r_struct
id|hh_cache
op_star
id|hh
)paren
(brace
multiline_comment|/* hh_data is 16 bytes long. if encaps is ether-llc we need 24, so&n;xmit will add the additional header part in that case */
id|u16
op_star
id|pad_before_eth
op_assign
(paren
id|u16
op_star
)paren
(paren
id|hh-&gt;hh_data
)paren
suffix:semicolon
r_int
id|t
op_assign
id|my_eth_header_cache
c_func
(paren
id|neigh
comma
id|hh
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;br2684_header_cache, neigh=%p, hh_cache=%p&bslash;n&quot;
comma
id|neigh
comma
id|hh
)paren
suffix:semicolon
r_if
c_cond
(paren
id|t
OL
l_int|0
)paren
r_return
id|t
suffix:semicolon
r_else
(brace
op_star
id|pad_before_eth
op_assign
l_int|0
suffix:semicolon
id|hh-&gt;hh_len
op_assign
id|PADLEN
op_plus
id|ETH_HLEN
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * This is similar to eth_type_trans, which cannot be used because of&n; * our dev-&gt;hard_header_len&n; */
DECL|function|br_type_trans
r_static
r_inline
r_int
r_int
id|br_type_trans
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
)paren
(brace
r_struct
id|ethhdr
op_star
id|eth
suffix:semicolon
r_int
r_char
op_star
id|rawp
suffix:semicolon
id|eth
op_assign
id|skb-&gt;mac.ethernet
suffix:semicolon
r_if
c_cond
(paren
op_star
id|eth-&gt;h_dest
op_amp
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|memcmp
c_func
(paren
id|eth-&gt;h_dest
comma
id|dev-&gt;broadcast
comma
id|ETH_ALEN
)paren
op_eq
l_int|0
)paren
id|skb-&gt;pkt_type
op_assign
id|PACKET_BROADCAST
suffix:semicolon
r_else
id|skb-&gt;pkt_type
op_assign
id|PACKET_MULTICAST
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|memcmp
c_func
(paren
id|eth-&gt;h_dest
comma
id|dev-&gt;dev_addr
comma
id|ETH_ALEN
)paren
)paren
id|skb-&gt;pkt_type
op_assign
id|PACKET_OTHERHOST
suffix:semicolon
r_if
c_cond
(paren
id|ntohs
c_func
(paren
id|eth-&gt;h_proto
)paren
op_ge
l_int|1536
)paren
r_return
id|eth-&gt;h_proto
suffix:semicolon
id|rawp
op_assign
id|skb-&gt;data
suffix:semicolon
multiline_comment|/*&n;&t; * This is a magic hack to spot IPX packets. Older Novell breaks&n;&t; * the protocol design and runs IPX over 802.3 without an 802.2 LLC&n;&t; * layer. We look for FFFF which isn&squot;t a used 802.2 SSAP/DSAP. This&n;&t; * won&squot;t work for fault tolerant netware but does for the rest.&n;&t; */
r_if
c_cond
(paren
op_star
(paren
r_int
r_int
op_star
)paren
id|rawp
op_eq
l_int|0xFFFF
)paren
r_return
id|htons
c_func
(paren
id|ETH_P_802_3
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Real 802.2 LLC&n;&t; */
r_return
id|htons
c_func
(paren
id|ETH_P_802_2
)paren
suffix:semicolon
)brace
macro_line|#endif /* FASTER_VERSION */
multiline_comment|/*&n; * We remember when the MAC gets set, so we don&squot;t override it later with&n; * the ESI of the ATM card of the first VC&n; */
DECL|variable|my_eth_mac_addr
r_static
r_int
(paren
op_star
id|my_eth_mac_addr
)paren
(paren
r_struct
id|net_device
op_star
comma
r_void
op_star
)paren
suffix:semicolon
DECL|function|br2684_mac_addr
r_static
r_int
id|br2684_mac_addr
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_void
op_star
id|p
)paren
(brace
r_int
id|err
op_assign
id|my_eth_mac_addr
c_func
(paren
id|dev
comma
id|p
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|err
)paren
id|BRPRIV
c_func
(paren
id|dev
)paren
op_member_access_from_pointer
id|mac_was_set
op_assign
l_int|1
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_ATM_BR2684_IPFILTER
multiline_comment|/* this IOCTL is experimental. */
DECL|function|br2684_setfilt
r_static
r_int
id|br2684_setfilt
c_func
(paren
r_struct
id|atm_vcc
op_star
id|atmvcc
comma
r_void
id|__user
op_star
id|arg
)paren
(brace
r_struct
id|br2684_vcc
op_star
id|brvcc
suffix:semicolon
r_struct
id|br2684_filter_set
id|fs
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|fs
comma
id|arg
comma
r_sizeof
id|fs
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|fs.ifspec.method
op_ne
id|BR2684_FIND_BYNOTHING
)paren
(brace
multiline_comment|/*&n;&t;&t; * This is really a per-vcc thing, but we can also search&n;&t;&t; * by device&n;&t;&t; */
r_struct
id|br2684_dev
op_star
id|brdev
suffix:semicolon
id|read_lock
c_func
(paren
op_amp
id|devs_lock
)paren
suffix:semicolon
id|brdev
op_assign
id|BRPRIV
c_func
(paren
id|br2684_find_dev
c_func
(paren
op_amp
id|fs.ifspec
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|brdev
op_eq
l_int|NULL
op_logical_or
id|list_empty
c_func
(paren
op_amp
id|brdev-&gt;brvccs
)paren
op_logical_or
id|brdev-&gt;brvccs.next
op_ne
id|brdev-&gt;brvccs.prev
)paren
multiline_comment|/* &gt;1 VCC */
id|brvcc
op_assign
l_int|NULL
suffix:semicolon
r_else
id|brvcc
op_assign
id|list_entry_brvcc
c_func
(paren
id|brdev-&gt;brvccs.next
)paren
suffix:semicolon
id|read_unlock
c_func
(paren
op_amp
id|devs_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|brvcc
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ESRCH
suffix:semicolon
)brace
r_else
id|brvcc
op_assign
id|BR2684_VCC
c_func
(paren
id|atmvcc
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|brvcc-&gt;filter
comma
op_amp
id|fs.filter
comma
r_sizeof
(paren
id|brvcc-&gt;filter
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Returns 1 if packet should be dropped */
r_static
r_inline
r_int
DECL|function|packet_fails_filter
id|packet_fails_filter
c_func
(paren
id|u16
id|type
comma
r_struct
id|br2684_vcc
op_star
id|brvcc
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_if
c_cond
(paren
id|brvcc-&gt;filter.netmask
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* no filter in place */
r_if
c_cond
(paren
id|type
op_eq
id|__constant_htons
c_func
(paren
id|ETH_P_IP
)paren
op_logical_and
(paren
(paren
(paren
r_struct
id|iphdr
op_star
)paren
(paren
id|skb-&gt;data
)paren
)paren
op_member_access_from_pointer
id|daddr
op_amp
id|brvcc-&gt;filter
dot
id|netmask
)paren
op_eq
id|brvcc-&gt;filter.prefix
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|type
op_eq
id|__constant_htons
c_func
(paren
id|ETH_P_ARP
)paren
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* TODO: we should probably filter ARPs too.. don&squot;t want to have&n;&t; *   them returning values that don&squot;t make sense, or is that ok?&n;&t; */
r_return
l_int|1
suffix:semicolon
multiline_comment|/* drop */
)brace
macro_line|#endif /* CONFIG_ATM_BR2684_IPFILTER */
DECL|function|br2684_close_vcc
r_static
r_void
id|br2684_close_vcc
c_func
(paren
r_struct
id|br2684_vcc
op_star
id|brvcc
)paren
(brace
id|DPRINTK
c_func
(paren
l_string|&quot;removing VCC %p from dev %p&bslash;n&quot;
comma
id|brvcc
comma
id|brvcc-&gt;device
)paren
suffix:semicolon
id|write_lock_irq
c_func
(paren
op_amp
id|devs_lock
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|brvcc-&gt;brvccs
)paren
suffix:semicolon
id|write_unlock_irq
c_func
(paren
op_amp
id|devs_lock
)paren
suffix:semicolon
id|brvcc-&gt;atmvcc-&gt;user_back
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* what about vcc-&gt;recvq ??? */
id|brvcc
op_member_access_from_pointer
id|old_push
c_func
(paren
id|brvcc-&gt;atmvcc
comma
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/* pass on the bad news */
id|kfree
c_func
(paren
id|brvcc
)paren
suffix:semicolon
id|module_put
c_func
(paren
id|THIS_MODULE
)paren
suffix:semicolon
)brace
multiline_comment|/* when AAL5 PDU comes in: */
DECL|function|br2684_push
r_static
r_void
id|br2684_push
c_func
(paren
r_struct
id|atm_vcc
op_star
id|atmvcc
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|br2684_vcc
op_star
id|brvcc
op_assign
id|BR2684_VCC
c_func
(paren
id|atmvcc
)paren
suffix:semicolon
r_struct
id|net_device
op_star
id|net_dev
op_assign
id|brvcc-&gt;device
suffix:semicolon
r_struct
id|br2684_dev
op_star
id|brdev
op_assign
id|BRPRIV
c_func
(paren
id|net_dev
)paren
suffix:semicolon
r_int
id|plen
op_assign
r_sizeof
(paren
id|llc_oui_pid_pad
)paren
op_plus
id|ETH_HLEN
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;br2684_push&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|skb
op_eq
l_int|NULL
)paren
)paren
(brace
multiline_comment|/* skb==NULL means VCC is being destroyed */
id|br2684_close_vcc
c_func
(paren
id|brvcc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|list_empty
c_func
(paren
op_amp
id|brdev-&gt;brvccs
)paren
)paren
(brace
id|read_lock
c_func
(paren
op_amp
id|devs_lock
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|brdev-&gt;br2684_devs
)paren
suffix:semicolon
id|read_unlock
c_func
(paren
op_amp
id|devs_lock
)paren
suffix:semicolon
id|unregister_netdev
c_func
(paren
id|net_dev
)paren
suffix:semicolon
id|free_netdev
c_func
(paren
id|net_dev
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
id|skb_debug
c_func
(paren
id|skb
)paren
suffix:semicolon
id|atm_return
c_func
(paren
id|atmvcc
comma
id|skb-&gt;truesize
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;skb from brdev %p&bslash;n&quot;
comma
id|brdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|brvcc-&gt;encaps
op_eq
id|e_llc
)paren
(brace
multiline_comment|/* let us waste some time for checking the encapsulation.&n;&t;&t;   Note, that only 7 char is checked so frames with a valid FCS&n;&t;&t;   are also accepted (but FCS is not checked of course) */
r_if
c_cond
(paren
id|memcmp
c_func
(paren
id|skb-&gt;data
comma
id|llc_oui_pid_pad
comma
l_int|7
)paren
)paren
(brace
id|brdev-&gt;stats.rx_errors
op_increment
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Strip FCS if present */
r_if
c_cond
(paren
id|skb-&gt;len
OG
l_int|7
op_logical_and
id|skb-&gt;data
(braket
l_int|7
)braket
op_eq
l_int|0x01
)paren
id|__skb_trim
c_func
(paren
id|skb
comma
id|skb-&gt;len
op_minus
l_int|4
)paren
suffix:semicolon
)brace
r_else
(brace
id|plen
op_assign
id|PADLEN
op_plus
id|ETH_HLEN
suffix:semicolon
multiline_comment|/* pad, dstmac,srcmac, ethtype */
multiline_comment|/* first 2 chars should be 0 */
r_if
c_cond
(paren
op_star
(paren
(paren
id|u16
op_star
)paren
(paren
id|skb-&gt;data
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|brdev-&gt;stats.rx_errors
op_increment
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|skb-&gt;len
OL
id|plen
)paren
(brace
id|brdev-&gt;stats.rx_errors
op_increment
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
multiline_comment|/* dev_ not needed? */
r_return
suffix:semicolon
)brace
macro_line|#ifdef FASTER_VERSION
multiline_comment|/* FIXME: tcpdump shows that pointer to mac header is 2 bytes earlier,&n;&t;   than should be. What else should I set? */
id|skb_pull
c_func
(paren
id|skb
comma
id|plen
)paren
suffix:semicolon
id|skb-&gt;mac.raw
op_assign
(paren
(paren
r_char
op_star
)paren
(paren
id|skb-&gt;data
)paren
)paren
op_minus
id|ETH_HLEN
suffix:semicolon
id|skb-&gt;pkt_type
op_assign
id|PACKET_HOST
suffix:semicolon
macro_line|#ifdef CONFIG_BR2684_FAST_TRANS
id|skb-&gt;protocol
op_assign
(paren
(paren
id|u16
op_star
)paren
id|skb-&gt;data
)paren
(braket
op_minus
l_int|1
)braket
suffix:semicolon
macro_line|#else&t;&t;&t;&t;/* some protocols might require this: */
id|skb-&gt;protocol
op_assign
id|br_type_trans
c_func
(paren
id|skb
comma
id|net_dev
)paren
suffix:semicolon
macro_line|#endif /* CONFIG_BR2684_FAST_TRANS */
macro_line|#else
id|skb_pull
c_func
(paren
id|skb
comma
id|plen
op_minus
id|ETH_HLEN
)paren
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|eth_type_trans
c_func
(paren
id|skb
comma
id|net_dev
)paren
suffix:semicolon
macro_line|#endif /* FASTER_VERSION */
macro_line|#ifdef CONFIG_ATM_BR2684_IPFILTER
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|packet_fails_filter
c_func
(paren
id|skb-&gt;protocol
comma
id|brvcc
comma
id|skb
)paren
)paren
)paren
(brace
id|brdev-&gt;stats.rx_dropped
op_increment
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_ATM_BR2684_IPFILTER */
id|skb-&gt;dev
op_assign
id|net_dev
suffix:semicolon
id|ATM_SKB
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|vcc
op_assign
id|atmvcc
suffix:semicolon
multiline_comment|/* needed ? */
id|DPRINTK
c_func
(paren
l_string|&quot;received packet&squot;s protocol: %x&bslash;n&quot;
comma
id|ntohs
c_func
(paren
id|skb-&gt;protocol
)paren
)paren
suffix:semicolon
id|skb_debug
c_func
(paren
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
op_logical_neg
(paren
id|net_dev-&gt;flags
op_amp
id|IFF_UP
)paren
)paren
)paren
(brace
multiline_comment|/* sigh, interface is down */
id|brdev-&gt;stats.rx_dropped
op_increment
suffix:semicolon
id|dev_kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|brdev-&gt;stats.rx_packets
op_increment
suffix:semicolon
id|brdev-&gt;stats.rx_bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
id|memset
c_func
(paren
id|ATM_SKB
c_func
(paren
id|skb
)paren
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|atm_skb_data
)paren
)paren
suffix:semicolon
id|netif_rx
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
DECL|function|br2684_regvcc
r_static
r_int
id|br2684_regvcc
c_func
(paren
r_struct
id|atm_vcc
op_star
id|atmvcc
comma
r_void
id|__user
op_star
id|arg
)paren
(brace
multiline_comment|/* assign a vcc to a dev&n;Note: we do not have explicit unassign, but look at _push()&n;*/
r_int
id|err
suffix:semicolon
r_struct
id|br2684_vcc
op_star
id|brvcc
suffix:semicolon
r_struct
id|sk_buff_head
id|copy
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_struct
id|br2684_dev
op_star
id|brdev
suffix:semicolon
r_struct
id|net_device
op_star
id|net_dev
suffix:semicolon
r_struct
id|atm_backend_br2684
id|be
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|be
comma
id|arg
comma
r_sizeof
id|be
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|brvcc
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|br2684_vcc
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|brvcc
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|brvcc
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|br2684_vcc
)paren
)paren
suffix:semicolon
id|write_lock_irq
c_func
(paren
op_amp
id|devs_lock
)paren
suffix:semicolon
id|net_dev
op_assign
id|br2684_find_dev
c_func
(paren
op_amp
id|be.ifspec
)paren
suffix:semicolon
r_if
c_cond
(paren
id|net_dev
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;br2684: tried to attach to non-existant device&bslash;n&quot;
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|ENXIO
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
id|brdev
op_assign
id|BRPRIV
c_func
(paren
id|net_dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atmvcc-&gt;push
op_eq
l_int|NULL
)paren
(brace
id|err
op_assign
op_minus
id|EBADFD
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|brdev-&gt;brvccs
)paren
)paren
(brace
multiline_comment|/* Only 1 VCC/dev right now */
id|err
op_assign
op_minus
id|EEXIST
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
r_if
c_cond
(paren
id|be.fcs_in
op_ne
id|BR2684_FCSIN_NO
op_logical_or
id|be.fcs_out
op_ne
id|BR2684_FCSOUT_NO
op_logical_or
id|be.fcs_auto
op_logical_or
id|be.has_vpiid
op_logical_or
id|be.send_padding
op_logical_or
(paren
id|be.encaps
op_ne
id|BR2684_ENCAPS_VC
op_logical_and
id|be.encaps
op_ne
id|BR2684_ENCAPS_LLC
)paren
op_logical_or
id|be.min_size
op_ne
l_int|0
)paren
(brace
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
id|DPRINTK
c_func
(paren
l_string|&quot;br2684_regvcc vcc=%p, encaps=%d, brvcc=%p&bslash;n&quot;
comma
id|atmvcc
comma
id|be.encaps
comma
id|brvcc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|list_empty
c_func
(paren
op_amp
id|brdev-&gt;brvccs
)paren
op_logical_and
op_logical_neg
id|brdev-&gt;mac_was_set
)paren
(brace
r_int
r_char
op_star
id|esi
op_assign
id|atmvcc-&gt;dev-&gt;esi
suffix:semicolon
r_if
c_cond
(paren
id|esi
(braket
l_int|0
)braket
op_or
id|esi
(braket
l_int|1
)braket
op_or
id|esi
(braket
l_int|2
)braket
op_or
id|esi
(braket
l_int|3
)braket
op_or
id|esi
(braket
l_int|4
)braket
op_or
id|esi
(braket
l_int|5
)braket
)paren
id|memcpy
c_func
(paren
id|net_dev-&gt;dev_addr
comma
id|esi
comma
id|net_dev-&gt;addr_len
)paren
suffix:semicolon
r_else
id|net_dev-&gt;dev_addr
(braket
l_int|2
)braket
op_assign
l_int|1
suffix:semicolon
)brace
id|list_add
c_func
(paren
op_amp
id|brvcc-&gt;brvccs
comma
op_amp
id|brdev-&gt;brvccs
)paren
suffix:semicolon
id|write_unlock_irq
c_func
(paren
op_amp
id|devs_lock
)paren
suffix:semicolon
id|brvcc-&gt;device
op_assign
id|net_dev
suffix:semicolon
id|brvcc-&gt;atmvcc
op_assign
id|atmvcc
suffix:semicolon
id|atmvcc-&gt;user_back
op_assign
id|brvcc
suffix:semicolon
id|brvcc-&gt;encaps
op_assign
(paren
r_enum
id|br2684_encaps
)paren
id|be.encaps
suffix:semicolon
id|brvcc-&gt;old_push
op_assign
id|atmvcc-&gt;push
suffix:semicolon
id|barrier
c_func
(paren
)paren
suffix:semicolon
id|atmvcc-&gt;push
op_assign
id|br2684_push
suffix:semicolon
id|skb_queue_head_init
c_func
(paren
op_amp
id|copy
)paren
suffix:semicolon
id|skb_migrate
c_func
(paren
op_amp
id|atmvcc-&gt;sk-&gt;sk_receive_queue
comma
op_amp
id|copy
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|copy
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|BRPRIV
c_func
(paren
id|skb-&gt;dev
)paren
op_member_access_from_pointer
id|stats.rx_bytes
op_sub_assign
id|skb-&gt;len
suffix:semicolon
id|BRPRIV
c_func
(paren
id|skb-&gt;dev
)paren
op_member_access_from_pointer
id|stats.rx_packets
op_decrement
suffix:semicolon
id|br2684_push
c_func
(paren
id|atmvcc
comma
id|skb
)paren
suffix:semicolon
)brace
(paren
r_void
)paren
id|try_module_get
c_func
(paren
id|THIS_MODULE
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|error
suffix:colon
id|write_unlock_irq
c_func
(paren
op_amp
id|devs_lock
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|brvcc
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|br2684_setup
r_static
r_void
id|br2684_setup
c_func
(paren
r_struct
id|net_device
op_star
id|netdev
)paren
(brace
r_struct
id|br2684_dev
op_star
id|brdev
op_assign
id|BRPRIV
c_func
(paren
id|netdev
)paren
suffix:semicolon
id|ether_setup
c_func
(paren
id|netdev
)paren
suffix:semicolon
id|brdev-&gt;net_dev
op_assign
id|netdev
suffix:semicolon
macro_line|#ifdef FASTER_VERSION
id|my_eth_header
op_assign
id|netdev-&gt;hard_header
suffix:semicolon
id|netdev-&gt;hard_header
op_assign
id|br2684_header
suffix:semicolon
id|my_eth_header_cache
op_assign
id|netdev-&gt;hard_header_cache
suffix:semicolon
id|netdev-&gt;hard_header_cache
op_assign
id|br2684_header_cache
suffix:semicolon
id|netdev-&gt;hard_header_len
op_assign
r_sizeof
(paren
id|llc_oui_pid_pad
)paren
op_plus
id|ETH_HLEN
suffix:semicolon
multiline_comment|/* 10 + 14 */
macro_line|#endif
id|my_eth_mac_addr
op_assign
id|netdev-&gt;set_mac_address
suffix:semicolon
id|netdev-&gt;set_mac_address
op_assign
id|br2684_mac_addr
suffix:semicolon
id|netdev-&gt;hard_start_xmit
op_assign
id|br2684_start_xmit
suffix:semicolon
id|netdev-&gt;get_stats
op_assign
id|br2684_get_stats
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|brdev-&gt;brvccs
)paren
suffix:semicolon
)brace
DECL|function|br2684_create
r_static
r_int
id|br2684_create
c_func
(paren
r_void
id|__user
op_star
id|arg
)paren
(brace
r_int
id|err
suffix:semicolon
r_struct
id|net_device
op_star
id|netdev
suffix:semicolon
r_struct
id|br2684_dev
op_star
id|brdev
suffix:semicolon
r_struct
id|atm_newif_br2684
id|ni
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;br2684_create&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|ni
comma
id|arg
comma
r_sizeof
id|ni
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ni.media
op_ne
id|BR2684_MEDIA_ETHERNET
op_logical_or
id|ni.mtu
op_ne
l_int|1500
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|netdev
op_assign
id|alloc_netdev
c_func
(paren
r_sizeof
(paren
r_struct
id|br2684_dev
)paren
comma
id|ni.ifname
(braket
l_int|0
)braket
ques
c_cond
id|ni.ifname
suffix:colon
l_string|&quot;nas%d&quot;
comma
id|br2684_setup
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|netdev
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|brdev
op_assign
id|BRPRIV
c_func
(paren
id|netdev
)paren
suffix:semicolon
id|DPRINTK
c_func
(paren
l_string|&quot;registered netdev %s&bslash;n&quot;
comma
id|netdev-&gt;name
)paren
suffix:semicolon
multiline_comment|/* open, stop, do_ioctl ? */
id|err
op_assign
id|register_netdev
c_func
(paren
id|netdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;br2684_create: register_netdev failed&bslash;n&quot;
)paren
suffix:semicolon
id|free_netdev
c_func
(paren
id|netdev
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|write_lock_irq
c_func
(paren
op_amp
id|devs_lock
)paren
suffix:semicolon
id|brdev-&gt;number
op_assign
id|list_empty
c_func
(paren
op_amp
id|br2684_devs
)paren
ques
c_cond
l_int|1
suffix:colon
id|BRPRIV
c_func
(paren
id|list_entry_brdev
c_func
(paren
id|br2684_devs.prev
)paren
)paren
op_member_access_from_pointer
id|number
op_plus
l_int|1
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|brdev-&gt;br2684_devs
comma
op_amp
id|br2684_devs
)paren
suffix:semicolon
id|write_unlock_irq
c_func
(paren
op_amp
id|devs_lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * This handles ioctls actually performed on our vcc - we must return&n; * -ENOIOCTLCMD for any unrecognized ioctl&n; */
DECL|function|br2684_ioctl
r_static
r_int
id|br2684_ioctl
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_struct
id|atm_vcc
op_star
id|atmvcc
op_assign
id|ATM_SD
c_func
(paren
id|sock
)paren
suffix:semicolon
r_void
id|__user
op_star
id|argp
op_assign
(paren
r_void
id|__user
op_star
)paren
id|arg
suffix:semicolon
r_int
id|err
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|ATM_SETBACKEND
suffix:colon
r_case
id|ATM_NEWBACKENDIF
suffix:colon
(brace
id|atm_backend_t
id|b
suffix:semicolon
id|err
op_assign
id|get_user
c_func
(paren
id|b
comma
(paren
id|atm_backend_t
id|__user
op_star
)paren
id|argp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|b
op_ne
id|ATM_BACKEND_BR2684
)paren
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_eq
id|ATM_SETBACKEND
)paren
r_return
id|br2684_regvcc
c_func
(paren
id|atmvcc
comma
id|argp
)paren
suffix:semicolon
r_else
r_return
id|br2684_create
c_func
(paren
id|argp
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_ATM_BR2684_IPFILTER
r_case
id|BR2684_SETFILT
suffix:colon
r_if
c_cond
(paren
id|atmvcc-&gt;push
op_ne
id|br2684_push
)paren
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
id|err
op_assign
id|br2684_setfilt
c_func
(paren
id|atmvcc
comma
id|argp
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
macro_line|#endif /* CONFIG_ATM_BR2684_IPFILTER */
)brace
r_return
op_minus
id|ENOIOCTLCMD
suffix:semicolon
)brace
DECL|variable|br2684_ioctl_ops
r_static
r_struct
id|atm_ioctl
id|br2684_ioctl_ops
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|ioctl
op_assign
id|br2684_ioctl
comma
)brace
suffix:semicolon
macro_line|#ifdef CONFIG_PROC_FS
DECL|function|br2684_seq_start
r_static
r_void
op_star
id|br2684_seq_start
c_func
(paren
r_struct
id|seq_file
op_star
id|seq
comma
id|loff_t
op_star
id|pos
)paren
(brace
id|loff_t
id|offs
op_assign
l_int|0
suffix:semicolon
r_struct
id|br2684_dev
op_star
id|brd
suffix:semicolon
id|read_lock
c_func
(paren
op_amp
id|devs_lock
)paren
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|brd
comma
op_amp
id|br2684_devs
comma
id|br2684_devs
)paren
(brace
r_if
c_cond
(paren
id|offs
op_eq
op_star
id|pos
)paren
r_return
id|brd
suffix:semicolon
op_increment
id|offs
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|br2684_seq_next
r_static
r_void
op_star
id|br2684_seq_next
c_func
(paren
r_struct
id|seq_file
op_star
id|seq
comma
r_void
op_star
id|v
comma
id|loff_t
op_star
id|pos
)paren
(brace
r_struct
id|br2684_dev
op_star
id|brd
op_assign
id|v
suffix:semicolon
op_increment
op_star
id|pos
suffix:semicolon
id|brd
op_assign
id|list_entry
c_func
(paren
id|brd-&gt;br2684_devs.next
comma
r_struct
id|br2684_dev
comma
id|br2684_devs
)paren
suffix:semicolon
r_return
(paren
op_amp
id|brd-&gt;br2684_devs
op_ne
op_amp
id|br2684_devs
)paren
ques
c_cond
id|brd
suffix:colon
l_int|NULL
suffix:semicolon
)brace
DECL|function|br2684_seq_stop
r_static
r_void
id|br2684_seq_stop
c_func
(paren
r_struct
id|seq_file
op_star
id|seq
comma
r_void
op_star
id|v
)paren
(brace
id|read_unlock
c_func
(paren
op_amp
id|devs_lock
)paren
suffix:semicolon
)brace
DECL|function|br2684_seq_show
r_static
r_int
id|br2684_seq_show
c_func
(paren
r_struct
id|seq_file
op_star
id|seq
comma
r_void
op_star
id|v
)paren
(brace
r_const
r_struct
id|br2684_dev
op_star
id|brdev
op_assign
id|v
suffix:semicolon
r_const
r_struct
id|net_device
op_star
id|net_dev
op_assign
id|brdev-&gt;net_dev
suffix:semicolon
r_const
r_struct
id|br2684_vcc
op_star
id|brvcc
suffix:semicolon
id|seq_printf
c_func
(paren
id|seq
comma
l_string|&quot;dev %.16s: num=%d, mac=%02X:%02X:&quot;
l_string|&quot;%02X:%02X:%02X:%02X (%s)&bslash;n&quot;
comma
id|net_dev-&gt;name
comma
id|brdev-&gt;number
comma
id|net_dev-&gt;dev_addr
(braket
l_int|0
)braket
comma
id|net_dev-&gt;dev_addr
(braket
l_int|1
)braket
comma
id|net_dev-&gt;dev_addr
(braket
l_int|2
)braket
comma
id|net_dev-&gt;dev_addr
(braket
l_int|3
)braket
comma
id|net_dev-&gt;dev_addr
(braket
l_int|4
)braket
comma
id|net_dev-&gt;dev_addr
(braket
l_int|5
)braket
comma
id|brdev-&gt;mac_was_set
ques
c_cond
l_string|&quot;set&quot;
suffix:colon
l_string|&quot;auto&quot;
)paren
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|brvcc
comma
op_amp
id|brdev-&gt;brvccs
comma
id|brvccs
)paren
(brace
id|seq_printf
c_func
(paren
id|seq
comma
l_string|&quot;  vcc %d.%d.%d: encaps=%s&quot;
macro_line|#ifndef FASTER_VERSION
l_string|&quot;, failed copies %u/%u&quot;
macro_line|#endif /* FASTER_VERSION */
l_string|&quot;&bslash;n&quot;
comma
id|brvcc-&gt;atmvcc-&gt;dev-&gt;number
comma
id|brvcc-&gt;atmvcc-&gt;vpi
comma
id|brvcc-&gt;atmvcc-&gt;vci
comma
(paren
id|brvcc-&gt;encaps
op_eq
id|e_llc
)paren
ques
c_cond
l_string|&quot;LLC&quot;
suffix:colon
l_string|&quot;VC&quot;
macro_line|#ifndef FASTER_VERSION
comma
id|brvcc-&gt;copies_failed
comma
id|brvcc-&gt;copies_needed
macro_line|#endif /* FASTER_VERSION */
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_ATM_BR2684_IPFILTER
DECL|macro|b1
mdefine_line|#define b1(var, byte)&t;((u8 *) &amp;brvcc-&gt;filter.var)[byte]
DECL|macro|bs
mdefine_line|#define bs(var)&t;&t;b1(var, 0), b1(var, 1), b1(var, 2), b1(var, 3)
r_if
c_cond
(paren
id|brvcc-&gt;filter.netmask
op_ne
l_int|0
)paren
id|seq_printf
c_func
(paren
id|seq
comma
l_string|&quot;    filter=%d.%d.%d.%d/&quot;
l_string|&quot;%d.%d.%d.%d&bslash;n&quot;
comma
id|bs
c_func
(paren
id|prefix
)paren
comma
id|bs
c_func
(paren
id|netmask
)paren
)paren
suffix:semicolon
DECL|macro|bs
macro_line|#undef bs
DECL|macro|b1
macro_line|#undef b1
macro_line|#endif /* CONFIG_ATM_BR2684_IPFILTER */
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|br2684_seq_ops
r_static
r_struct
id|seq_operations
id|br2684_seq_ops
op_assign
(brace
dot
id|start
op_assign
id|br2684_seq_start
comma
dot
id|next
op_assign
id|br2684_seq_next
comma
dot
id|stop
op_assign
id|br2684_seq_stop
comma
dot
id|show
op_assign
id|br2684_seq_show
comma
)brace
suffix:semicolon
DECL|function|br2684_proc_open
r_static
r_int
id|br2684_proc_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_return
id|seq_open
c_func
(paren
id|file
comma
op_amp
id|br2684_seq_ops
)paren
suffix:semicolon
)brace
DECL|variable|br2684_proc_ops
r_static
r_struct
id|file_operations
id|br2684_proc_ops
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|open
op_assign
id|br2684_proc_open
comma
dot
id|read
op_assign
id|seq_read
comma
dot
id|llseek
op_assign
id|seq_lseek
comma
dot
id|release
op_assign
id|seq_release
comma
)brace
suffix:semicolon
r_extern
r_struct
id|proc_dir_entry
op_star
id|atm_proc_root
suffix:semicolon
multiline_comment|/* from proc.c */
macro_line|#endif
DECL|function|br2684_init
r_static
r_int
id|__init
id|br2684_init
c_func
(paren
r_void
)paren
(brace
macro_line|#ifdef CONFIG_PROC_FS
r_struct
id|proc_dir_entry
op_star
id|p
suffix:semicolon
r_if
c_cond
(paren
(paren
id|p
op_assign
id|create_proc_entry
c_func
(paren
l_string|&quot;br2684&quot;
comma
l_int|0
comma
id|atm_proc_root
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|p-&gt;proc_fops
op_assign
op_amp
id|br2684_proc_ops
suffix:semicolon
macro_line|#endif
id|register_atm_ioctl
c_func
(paren
op_amp
id|br2684_ioctl_ops
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|br2684_exit
r_static
r_void
id|__exit
id|br2684_exit
c_func
(paren
r_void
)paren
(brace
r_struct
id|net_device
op_star
id|net_dev
suffix:semicolon
r_struct
id|br2684_dev
op_star
id|brdev
suffix:semicolon
r_struct
id|br2684_vcc
op_star
id|brvcc
suffix:semicolon
id|deregister_atm_ioctl
c_func
(paren
op_amp
id|br2684_ioctl_ops
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_PROC_FS
id|remove_proc_entry
c_func
(paren
l_string|&quot;br2684&quot;
comma
id|atm_proc_root
)paren
suffix:semicolon
macro_line|#endif
r_while
c_loop
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|br2684_devs
)paren
)paren
(brace
id|net_dev
op_assign
id|list_entry_brdev
c_func
(paren
id|br2684_devs.next
)paren
suffix:semicolon
id|brdev
op_assign
id|BRPRIV
c_func
(paren
id|net_dev
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|brdev-&gt;brvccs
)paren
)paren
(brace
id|brvcc
op_assign
id|list_entry_brvcc
c_func
(paren
id|brdev-&gt;brvccs.next
)paren
suffix:semicolon
id|br2684_close_vcc
c_func
(paren
id|brvcc
)paren
suffix:semicolon
)brace
id|list_del
c_func
(paren
op_amp
id|brdev-&gt;br2684_devs
)paren
suffix:semicolon
id|unregister_netdev
c_func
(paren
id|net_dev
)paren
suffix:semicolon
id|free_netdev
c_func
(paren
id|net_dev
)paren
suffix:semicolon
)brace
)brace
DECL|variable|br2684_init
id|module_init
c_func
(paren
id|br2684_init
)paren
suffix:semicolon
DECL|variable|br2684_exit
id|module_exit
c_func
(paren
id|br2684_exit
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Marcell GAL&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;RFC2684 bridged protocols over ATM/AAL5&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
eof
