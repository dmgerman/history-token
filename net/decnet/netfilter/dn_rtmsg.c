multiline_comment|/*&n; * DECnet       An implementation of the DECnet protocol suite for the LINUX&n; *              operating system.  DECnet is implemented using the  BSD Socket&n; *              interface as the means of communication with the user level.&n; *&n; *              DECnet Routing Message Grabulator&n; *&n; *              (C) 2000 ChyGwyn Limited  -  http://www.chygwyn.com/&n; *              This code may be copied under the GPL v.2 or at your option&n; *              any later version.&n; *&n; * Author:      Steven Whitehouse &lt;steve@chygwyn.com&gt;&n; *&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/netfilter.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;linux/netlink.h&gt;
macro_line|#include &lt;net/sock.h&gt;
macro_line|#include &lt;net/flow.h&gt;
macro_line|#include &lt;net/dn.h&gt;
macro_line|#include &lt;net/dn_route.h&gt;
macro_line|#include &lt;linux/netfilter_decnet.h&gt;
DECL|variable|dnrmg
r_static
r_struct
id|sock
op_star
id|dnrmg
op_assign
l_int|NULL
suffix:semicolon
DECL|function|dnrmg_build_message
r_static
r_struct
id|sk_buff
op_star
id|dnrmg_build_message
c_func
(paren
r_struct
id|sk_buff
op_star
id|rt_skb
comma
r_int
op_star
id|errp
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
op_assign
l_int|NULL
suffix:semicolon
r_int
id|size
suffix:semicolon
r_int
r_char
op_star
id|old_tail
suffix:semicolon
r_struct
id|nlmsghdr
op_star
id|nlh
suffix:semicolon
r_int
r_char
op_star
id|ptr
suffix:semicolon
r_struct
id|nf_dn_rtmsg
op_star
id|rtm
suffix:semicolon
id|size
op_assign
id|NLMSG_SPACE
c_func
(paren
id|rt_skb-&gt;len
)paren
suffix:semicolon
id|size
op_add_assign
id|NLMSG_ALIGN
c_func
(paren
r_sizeof
(paren
r_struct
id|nf_dn_rtmsg
)paren
)paren
suffix:semicolon
id|skb
op_assign
id|alloc_skb
c_func
(paren
id|size
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
r_goto
id|nlmsg_failure
suffix:semicolon
id|old_tail
op_assign
id|skb-&gt;tail
suffix:semicolon
id|nlh
op_assign
id|NLMSG_PUT
c_func
(paren
id|skb
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
id|size
op_minus
r_sizeof
(paren
op_star
id|nlh
)paren
)paren
suffix:semicolon
id|rtm
op_assign
(paren
r_struct
id|nf_dn_rtmsg
op_star
)paren
id|NLMSG_DATA
c_func
(paren
id|nlh
)paren
suffix:semicolon
id|rtm-&gt;nfdn_ifindex
op_assign
id|rt_skb-&gt;dev-&gt;ifindex
suffix:semicolon
id|ptr
op_assign
id|NFDN_RTMSG
c_func
(paren
id|rtm
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|ptr
comma
id|rt_skb-&gt;data
comma
id|rt_skb-&gt;len
)paren
suffix:semicolon
id|nlh-&gt;nlmsg_len
op_assign
id|skb-&gt;tail
op_minus
id|old_tail
suffix:semicolon
r_return
id|skb
suffix:semicolon
id|nlmsg_failure
suffix:colon
r_if
c_cond
(paren
id|skb
)paren
id|kfree
c_func
(paren
id|skb
)paren
suffix:semicolon
op_star
id|errp
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
id|net_ratelimit
c_func
(paren
)paren
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;dn_rtmsg: error creating netlink message&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|dnrmg_send_peer
r_static
r_void
id|dnrmg_send_peer
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb2
suffix:semicolon
r_int
id|status
op_assign
l_int|0
suffix:semicolon
r_int
id|group
op_assign
l_int|0
suffix:semicolon
r_int
r_char
id|flags
op_assign
op_star
id|skb-&gt;data
suffix:semicolon
r_switch
c_cond
(paren
id|flags
op_amp
id|DN_RT_CNTL_MSK
)paren
(brace
r_case
id|DN_RT_PKT_L1RT
suffix:colon
id|group
op_assign
id|DNRMG_L1_GROUP
suffix:semicolon
r_break
suffix:semicolon
r_case
id|DN_RT_PKT_L2RT
suffix:colon
id|group
op_assign
id|DNRMG_L2_GROUP
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
suffix:semicolon
)brace
id|skb2
op_assign
id|dnrmg_build_message
c_func
(paren
id|skb
comma
op_amp
id|status
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb2
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
id|NETLINK_CB
c_func
(paren
id|skb2
)paren
dot
id|dst_groups
op_assign
id|group
suffix:semicolon
id|netlink_broadcast
c_func
(paren
id|dnrmg
comma
id|skb2
comma
l_int|0
comma
id|group
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
)brace
DECL|function|dnrmg_hook
r_static
r_int
r_int
id|dnrmg_hook
c_func
(paren
r_int
r_int
id|hook
comma
r_struct
id|sk_buff
op_star
op_star
id|pskb
comma
r_const
r_struct
id|net_device
op_star
id|in
comma
r_const
r_struct
id|net_device
op_star
id|out
comma
r_int
(paren
op_star
id|okfn
)paren
(paren
r_struct
id|sk_buff
op_star
)paren
)paren
(brace
id|dnrmg_send_peer
c_func
(paren
op_star
id|pskb
)paren
suffix:semicolon
r_return
id|NF_ACCEPT
suffix:semicolon
)brace
DECL|macro|RCV_SKB_FAIL
mdefine_line|#define RCV_SKB_FAIL(err) do { netlink_ack(skb, nlh, (err)); return; } while (0)
DECL|function|dnrmg_receive_user_skb
r_static
r_inline
r_void
id|dnrmg_receive_user_skb
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|nlmsghdr
op_star
id|nlh
op_assign
(paren
r_struct
id|nlmsghdr
op_star
)paren
id|skb-&gt;data
suffix:semicolon
r_if
c_cond
(paren
id|nlh-&gt;nlmsg_len
OL
r_sizeof
(paren
op_star
id|nlh
)paren
op_logical_or
id|skb-&gt;len
OL
id|nlh-&gt;nlmsg_len
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cap_raised
c_func
(paren
id|NETLINK_CB
c_func
(paren
id|skb
)paren
dot
id|eff_cap
comma
id|CAP_NET_ADMIN
)paren
)paren
id|RCV_SKB_FAIL
c_func
(paren
op_minus
id|EPERM
)paren
suffix:semicolon
multiline_comment|/* Eventually we might send routing messages too */
id|RCV_SKB_FAIL
c_func
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
)brace
DECL|function|dnrmg_receive_user_sk
r_static
r_void
id|dnrmg_receive_user_sk
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_int
id|len
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_while
c_loop
(paren
(paren
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|sk-&gt;receive_queue
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|dnrmg_receive_user_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
)brace
DECL|variable|dnrmg_ops
r_static
r_struct
id|nf_hook_ops
id|dnrmg_ops
op_assign
(brace
dot
id|hook
op_assign
id|dnrmg_hook
comma
dot
id|pf
op_assign
id|PF_DECnet
comma
dot
id|hooknum
op_assign
id|NF_DN_ROUTE
comma
dot
id|priority
op_assign
id|NF_DN_PRI_DNRTMSG
comma
)brace
suffix:semicolon
DECL|function|init
r_static
r_int
id|__init
id|init
c_func
(paren
r_void
)paren
(brace
r_int
id|rv
op_assign
l_int|0
suffix:semicolon
id|dnrmg
op_assign
id|netlink_kernel_create
c_func
(paren
id|NETLINK_DNRTMSG
comma
id|dnrmg_receive_user_sk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dnrmg
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;dn_rtmsg: Cannot create netlink socket&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|rv
op_assign
id|nf_register_hook
c_func
(paren
op_amp
id|dnrmg_ops
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rv
)paren
(brace
id|sock_release
c_func
(paren
id|dnrmg-&gt;socket
)paren
suffix:semicolon
)brace
r_return
id|rv
suffix:semicolon
)brace
DECL|function|fini
r_static
r_void
id|__exit
id|fini
c_func
(paren
r_void
)paren
(brace
id|nf_unregister_hook
c_func
(paren
op_amp
id|dnrmg_ops
)paren
suffix:semicolon
id|sock_release
c_func
(paren
id|dnrmg-&gt;socket
)paren
suffix:semicolon
)brace
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;DECnet Routing Message Grabulator&quot;
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Steven Whitehouse &lt;steve@chygwyn.com&gt;&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
DECL|variable|init
id|module_init
c_func
(paren
id|init
)paren
suffix:semicolon
DECL|variable|fini
id|module_exit
c_func
(paren
id|fini
)paren
suffix:semicolon
eof
