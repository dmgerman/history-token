multiline_comment|/* flow.c: Generic flow cache.&n; *&n; * Copyright (C) 2003 Alexey N. Kuznetsov (kuznet@ms2.inr.ac.ru)&n; * Copyright (C) 2003 David S. Miller (davem@redhat.com)&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/list.h&gt;
macro_line|#include &lt;linux/jhash.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/random.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;net/flow.h&gt;
macro_line|#include &lt;asm/atomic.h&gt;
DECL|struct|flow_cache_entry
r_struct
id|flow_cache_entry
(brace
DECL|member|next
r_struct
id|flow_cache_entry
op_star
id|next
suffix:semicolon
DECL|member|family
id|u16
id|family
suffix:semicolon
DECL|member|dir
id|u8
id|dir
suffix:semicolon
DECL|member|key
r_struct
id|flowi
id|key
suffix:semicolon
DECL|member|genid
id|u32
id|genid
suffix:semicolon
DECL|member|object
r_void
op_star
id|object
suffix:semicolon
DECL|member|object_ref
id|atomic_t
op_star
id|object_ref
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|flow_cache_genid
id|atomic_t
id|flow_cache_genid
op_assign
id|ATOMIC_INIT
c_func
(paren
l_int|0
)paren
suffix:semicolon
DECL|variable|flow_hash_shift
r_static
id|u32
id|flow_hash_shift
suffix:semicolon
DECL|macro|flow_hash_size
mdefine_line|#define flow_hash_size&t;(1 &lt;&lt; flow_hash_shift)
DECL|variable|flow_table
r_static
r_struct
id|flow_cache_entry
op_star
op_star
id|flow_table
suffix:semicolon
DECL|variable|flow_cachep
r_static
id|kmem_cache_t
op_star
id|flow_cachep
suffix:semicolon
DECL|variable|flow_lwm
DECL|variable|flow_hwm
r_static
r_int
id|flow_lwm
comma
id|flow_hwm
suffix:semicolon
DECL|struct|flow_percpu_info
r_struct
id|flow_percpu_info
(brace
DECL|member|hash_rnd_recalc
r_int
id|hash_rnd_recalc
suffix:semicolon
DECL|member|hash_rnd
id|u32
id|hash_rnd
suffix:semicolon
DECL|member|count
r_int
id|count
suffix:semicolon
DECL|variable|____cacheline_aligned
)brace
id|____cacheline_aligned
suffix:semicolon
DECL|variable|flow_hash_info
r_static
r_struct
id|flow_percpu_info
id|flow_hash_info
(braket
id|NR_CPUS
)braket
suffix:semicolon
DECL|macro|flow_hash_rnd_recalc
mdefine_line|#define flow_hash_rnd_recalc(cpu)&t;(flow_hash_info[cpu].hash_rnd_recalc)
DECL|macro|flow_hash_rnd
mdefine_line|#define flow_hash_rnd(cpu)&t;&t;(flow_hash_info[cpu].hash_rnd)
DECL|macro|flow_count
mdefine_line|#define flow_count(cpu)&t;&t;&t;(flow_hash_info[cpu].count)
DECL|variable|flow_hash_rnd_timer
r_static
r_struct
id|timer_list
id|flow_hash_rnd_timer
suffix:semicolon
DECL|macro|FLOW_HASH_RND_PERIOD
mdefine_line|#define FLOW_HASH_RND_PERIOD&t;(10 * 60 * HZ)
DECL|function|flow_cache_new_hashrnd
r_static
r_void
id|flow_cache_new_hashrnd
c_func
(paren
r_int
r_int
id|arg
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_CPUS
suffix:semicolon
id|i
op_increment
)paren
id|flow_hash_rnd_recalc
c_func
(paren
id|i
)paren
op_assign
l_int|1
suffix:semicolon
id|flow_hash_rnd_timer.expires
op_assign
id|jiffies
op_plus
id|FLOW_HASH_RND_PERIOD
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|flow_hash_rnd_timer
)paren
suffix:semicolon
)brace
DECL|function|__flow_cache_shrink
r_static
r_void
id|__flow_cache_shrink
c_func
(paren
r_int
id|cpu
comma
r_int
id|shrink_to
)paren
(brace
r_struct
id|flow_cache_entry
op_star
id|fle
comma
op_star
op_star
id|flp
suffix:semicolon
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|flow_hash_size
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
id|k
op_assign
l_int|0
suffix:semicolon
id|flp
op_assign
op_amp
id|flow_table
(braket
id|cpu
op_star
id|flow_hash_size
op_plus
id|i
)braket
suffix:semicolon
r_while
c_loop
(paren
(paren
id|fle
op_assign
op_star
id|flp
)paren
op_ne
l_int|NULL
op_logical_and
id|k
OL
id|shrink_to
)paren
(brace
id|k
op_increment
suffix:semicolon
id|flp
op_assign
op_amp
id|fle-&gt;next
suffix:semicolon
)brace
r_while
c_loop
(paren
(paren
id|fle
op_assign
op_star
id|flp
)paren
op_ne
l_int|NULL
)paren
(brace
op_star
id|flp
op_assign
id|fle-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|fle-&gt;object
)paren
id|atomic_dec
c_func
(paren
id|fle-&gt;object_ref
)paren
suffix:semicolon
id|kmem_cache_free
c_func
(paren
id|flow_cachep
comma
id|fle
)paren
suffix:semicolon
id|flow_count
c_func
(paren
id|cpu
)paren
op_decrement
suffix:semicolon
)brace
)brace
)brace
DECL|function|flow_cache_shrink
r_static
r_void
id|flow_cache_shrink
c_func
(paren
r_int
id|cpu
)paren
(brace
r_int
id|shrink_to
op_assign
id|flow_lwm
op_div
id|flow_hash_size
suffix:semicolon
id|__flow_cache_shrink
c_func
(paren
id|cpu
comma
id|shrink_to
)paren
suffix:semicolon
)brace
DECL|function|flow_new_hash_rnd
r_static
r_void
id|flow_new_hash_rnd
c_func
(paren
r_int
id|cpu
)paren
(brace
id|get_random_bytes
c_func
(paren
op_amp
id|flow_hash_rnd
c_func
(paren
id|cpu
)paren
comma
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
id|flow_hash_rnd_recalc
c_func
(paren
id|cpu
)paren
op_assign
l_int|0
suffix:semicolon
id|__flow_cache_shrink
c_func
(paren
id|cpu
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|flow_hash_code
r_static
id|u32
id|flow_hash_code
c_func
(paren
r_struct
id|flowi
op_star
id|key
comma
r_int
id|cpu
)paren
(brace
id|u32
op_star
id|k
op_assign
(paren
id|u32
op_star
)paren
id|key
suffix:semicolon
r_return
(paren
id|jhash2
c_func
(paren
id|k
comma
(paren
r_sizeof
(paren
op_star
id|key
)paren
op_div
r_sizeof
(paren
id|u32
)paren
)paren
comma
id|flow_hash_rnd
c_func
(paren
id|cpu
)paren
)paren
op_amp
(paren
id|flow_hash_size
op_minus
l_int|1
)paren
)paren
suffix:semicolon
)brace
macro_line|#if (BITS_PER_LONG == 64)
DECL|typedef|flow_compare_t
r_typedef
id|u64
id|flow_compare_t
suffix:semicolon
macro_line|#else
DECL|typedef|flow_compare_t
r_typedef
id|u32
id|flow_compare_t
suffix:semicolon
macro_line|#endif
r_extern
r_void
id|flowi_is_missized
c_func
(paren
r_void
)paren
suffix:semicolon
multiline_comment|/* I hear what you&squot;re saying, use memcmp.  But memcmp cannot make&n; * important assumptions that we can here, such as alignment and&n; * constant size.&n; */
DECL|function|flow_key_compare
r_static
r_int
id|flow_key_compare
c_func
(paren
r_struct
id|flowi
op_star
id|key1
comma
r_struct
id|flowi
op_star
id|key2
)paren
(brace
id|flow_compare_t
op_star
id|k1
comma
op_star
id|k1_lim
comma
op_star
id|k2
suffix:semicolon
r_const
r_int
id|n_elem
op_assign
r_sizeof
(paren
r_struct
id|flowi
)paren
op_div
r_sizeof
(paren
id|flow_compare_t
)paren
suffix:semicolon
r_if
c_cond
(paren
r_sizeof
(paren
r_struct
id|flowi
)paren
op_mod
r_sizeof
(paren
id|flow_compare_t
)paren
)paren
id|flowi_is_missized
c_func
(paren
)paren
suffix:semicolon
id|k1
op_assign
(paren
id|flow_compare_t
op_star
)paren
id|key1
suffix:semicolon
id|k1_lim
op_assign
id|k1
op_plus
id|n_elem
suffix:semicolon
id|k2
op_assign
(paren
id|flow_compare_t
op_star
)paren
id|key2
suffix:semicolon
r_do
(brace
r_if
c_cond
(paren
op_star
id|k1
op_increment
op_ne
op_star
id|k2
op_increment
)paren
r_return
l_int|1
suffix:semicolon
)brace
r_while
c_loop
(paren
id|k1
OL
id|k1_lim
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|flow_cache_lookup
r_void
op_star
id|flow_cache_lookup
c_func
(paren
r_struct
id|flowi
op_star
id|key
comma
id|u16
id|family
comma
id|u8
id|dir
comma
id|flow_resolve_t
id|resolver
)paren
(brace
r_struct
id|flow_cache_entry
op_star
id|fle
comma
op_star
op_star
id|head
suffix:semicolon
r_int
r_int
id|hash
suffix:semicolon
r_int
id|cpu
suffix:semicolon
id|local_bh_disable
c_func
(paren
)paren
suffix:semicolon
id|cpu
op_assign
id|smp_processor_id
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|flow_hash_rnd_recalc
c_func
(paren
id|cpu
)paren
)paren
id|flow_new_hash_rnd
c_func
(paren
id|cpu
)paren
suffix:semicolon
id|hash
op_assign
id|flow_hash_code
c_func
(paren
id|key
comma
id|cpu
)paren
suffix:semicolon
id|head
op_assign
op_amp
id|flow_table
(braket
(paren
id|cpu
op_lshift
id|flow_hash_shift
)paren
op_plus
id|hash
)braket
suffix:semicolon
r_for
c_loop
(paren
id|fle
op_assign
op_star
id|head
suffix:semicolon
id|fle
suffix:semicolon
id|fle
op_assign
id|fle-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|fle-&gt;family
op_eq
id|family
op_logical_and
id|fle-&gt;dir
op_eq
id|dir
op_logical_and
id|flow_key_compare
c_func
(paren
id|key
comma
op_amp
id|fle-&gt;key
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|fle-&gt;genid
op_eq
id|atomic_read
c_func
(paren
op_amp
id|flow_cache_genid
)paren
)paren
(brace
r_void
op_star
id|ret
op_assign
id|fle-&gt;object
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
id|atomic_inc
c_func
(paren
id|fle-&gt;object_ref
)paren
suffix:semicolon
id|local_bh_enable
c_func
(paren
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
)brace
(brace
r_void
op_star
id|obj
suffix:semicolon
id|atomic_t
op_star
id|obj_ref
suffix:semicolon
id|resolver
c_func
(paren
id|key
comma
id|family
comma
id|dir
comma
op_amp
id|obj
comma
op_amp
id|obj_ref
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fle
)paren
(brace
id|fle-&gt;genid
op_assign
id|atomic_read
c_func
(paren
op_amp
id|flow_cache_genid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fle-&gt;object
)paren
id|atomic_dec
c_func
(paren
id|fle-&gt;object_ref
)paren
suffix:semicolon
id|fle-&gt;object
op_assign
id|obj
suffix:semicolon
id|fle-&gt;object_ref
op_assign
id|obj_ref
suffix:semicolon
r_if
c_cond
(paren
id|obj
)paren
id|atomic_inc
c_func
(paren
id|fle-&gt;object_ref
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|flow_count
c_func
(paren
id|cpu
)paren
OG
id|flow_hwm
)paren
id|flow_cache_shrink
c_func
(paren
id|cpu
)paren
suffix:semicolon
id|fle
op_assign
id|kmem_cache_alloc
c_func
(paren
id|flow_cachep
comma
id|SLAB_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fle
)paren
(brace
id|fle-&gt;next
op_assign
op_star
id|head
suffix:semicolon
op_star
id|head
op_assign
id|fle
suffix:semicolon
id|fle-&gt;family
op_assign
id|family
suffix:semicolon
id|fle-&gt;dir
op_assign
id|dir
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|fle-&gt;key
comma
id|key
comma
r_sizeof
(paren
op_star
id|key
)paren
)paren
suffix:semicolon
id|fle-&gt;genid
op_assign
id|atomic_read
c_func
(paren
op_amp
id|flow_cache_genid
)paren
suffix:semicolon
id|fle-&gt;object
op_assign
id|obj
suffix:semicolon
id|fle-&gt;object_ref
op_assign
id|obj_ref
suffix:semicolon
r_if
c_cond
(paren
id|obj
)paren
id|atomic_inc
c_func
(paren
id|fle-&gt;object_ref
)paren
suffix:semicolon
id|flow_count
c_func
(paren
id|cpu
)paren
op_increment
suffix:semicolon
)brace
)brace
id|local_bh_enable
c_func
(paren
)paren
suffix:semicolon
r_return
id|obj
suffix:semicolon
)brace
)brace
DECL|function|flow_cache_init
r_static
r_int
id|__init
id|flow_cache_init
c_func
(paren
r_void
)paren
(brace
r_int
r_int
id|order
suffix:semicolon
r_int
id|i
suffix:semicolon
id|flow_cachep
op_assign
id|kmem_cache_create
c_func
(paren
l_string|&quot;flow_cache&quot;
comma
r_sizeof
(paren
r_struct
id|flow_cache_entry
)paren
comma
l_int|0
comma
id|SLAB_HWCACHE_ALIGN
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|flow_cachep
)paren
id|panic
c_func
(paren
l_string|&quot;NET: failed to allocate flow cache slab&bslash;n&quot;
)paren
suffix:semicolon
id|flow_hash_shift
op_assign
l_int|10
suffix:semicolon
id|flow_lwm
op_assign
l_int|2
op_star
id|flow_hash_size
suffix:semicolon
id|flow_hwm
op_assign
l_int|4
op_star
id|flow_hash_size
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NR_CPUS
suffix:semicolon
id|i
op_increment
)paren
id|flow_hash_rnd_recalc
c_func
(paren
id|i
)paren
op_assign
l_int|1
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|flow_hash_rnd_timer
)paren
suffix:semicolon
id|flow_hash_rnd_timer.function
op_assign
id|flow_cache_new_hashrnd
suffix:semicolon
id|flow_hash_rnd_timer.expires
op_assign
id|jiffies
op_plus
id|FLOW_HASH_RND_PERIOD
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|flow_hash_rnd_timer
)paren
suffix:semicolon
r_for
c_loop
(paren
id|order
op_assign
l_int|0
suffix:semicolon
(paren
id|PAGE_SIZE
op_lshift
id|order
)paren
OL
(paren
id|NR_CPUS
op_star
r_sizeof
(paren
r_struct
id|flow_entry
op_star
)paren
op_star
id|flow_hash_size
)paren
suffix:semicolon
id|order
op_increment
)paren
multiline_comment|/* NOTHING */
suffix:semicolon
id|flow_table
op_assign
(paren
r_struct
id|flow_cache_entry
op_star
op_star
)paren
id|__get_free_pages
c_func
(paren
id|GFP_ATOMIC
comma
id|order
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|flow_table
)paren
id|panic
c_func
(paren
l_string|&quot;Failed to allocate flow cache hash table&bslash;n&quot;
)paren
suffix:semicolon
id|memset
c_func
(paren
id|flow_table
comma
l_int|0
comma
id|PAGE_SIZE
op_lshift
id|order
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|flow_cache_init
id|module_init
c_func
(paren
id|flow_cache_init
)paren
suffix:semicolon
eof
