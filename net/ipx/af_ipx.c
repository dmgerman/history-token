multiline_comment|/*&n; *&t;Implements an IPX socket layer.&n; *&n; *&t;This code is derived from work by&n; *&t;&t;Ross Biro&t;: &t;Writing the original IP stack&n; *&t;&t;Fred Van Kempen :&t;Tidying up the TCP/IP&n; *&n; *&t;Many thanks go to Keith Baker, Institute For Industrial Information&n; *&t;Technology Ltd, Swansea University for allowing me to work on this&n; *&t;in my own time even though it was in some ways related to commercial&n; *&t;work I am currently employed to do there.&n; *&n; *&t;All the material in this file is subject to the Gnu license version 2.&n; *&t;Neither Alan Cox nor the Swansea University Computer Society admit &n; *&t;liability nor provide warranty for any of this software. This material&n; *&t;is provided as is and at no charge.&n; *&n; *&t;Portions Copyright (c) 2000-2002 Conectiva, Inc. &lt;acme@conectiva.com.br&gt;&n; *&t;Neither Arnaldo Carvalho de Melo nor Conectiva, Inc. admit liability nor&n; *&t;provide warranty for any of this software. This material is provided&n; *&t;&quot;AS-IS&quot; and at no charge.&n; *&n; * &t;Portions Copyright (c) 1995 Caldera, Inc. &lt;greg@caldera.com&gt;&n; *&t;Neither Greg Page nor Caldera, Inc. admit liability nor provide&n; *&t;warranty for any of this software. This material is provided&n; *&t;&quot;AS-IS&quot; and at no charge.&n; *&n; *&t;See net/ipx/ChangeLog.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/socket.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/timer.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/sockios.h&gt;
macro_line|#include &lt;linux/net.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;net/ipx.h&gt;
macro_line|#include &lt;linux/inet.h&gt;
macro_line|#include &lt;linux/tcp.h&gt;
macro_line|#include &lt;linux/route.h&gt;
macro_line|#include &lt;net/sock.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/termios.h&gt;&t;/* For TIOCOUTQ/INQ */
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;net/p8022.h&gt;
macro_line|#include &lt;net/psnap.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/if_arp.h&gt;
macro_line|#ifdef CONFIG_SYSCTL
r_extern
r_void
id|ipx_register_sysctl
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_void
id|ipx_unregister_sysctl
c_func
(paren
r_void
)paren
suffix:semicolon
macro_line|#else
DECL|macro|ipx_register_sysctl
mdefine_line|#define ipx_register_sysctl()
DECL|macro|ipx_unregister_sysctl
mdefine_line|#define ipx_unregister_sysctl()
macro_line|#endif
multiline_comment|/* Configuration Variables */
DECL|variable|ipxcfg_max_hops
r_static
r_int
r_char
id|ipxcfg_max_hops
op_assign
l_int|16
suffix:semicolon
DECL|variable|ipxcfg_auto_select_primary
r_static
r_char
id|ipxcfg_auto_select_primary
suffix:semicolon
DECL|variable|ipxcfg_auto_create_interfaces
r_static
r_char
id|ipxcfg_auto_create_interfaces
suffix:semicolon
DECL|variable|sysctl_ipx_pprop_broadcasting
r_int
id|sysctl_ipx_pprop_broadcasting
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Global Variables */
DECL|variable|p8022_datalink
r_static
r_struct
id|datalink_proto
op_star
id|p8022_datalink
suffix:semicolon
DECL|variable|pEII_datalink
r_static
r_struct
id|datalink_proto
op_star
id|pEII_datalink
suffix:semicolon
DECL|variable|p8023_datalink
r_static
r_struct
id|datalink_proto
op_star
id|p8023_datalink
suffix:semicolon
DECL|variable|pSNAP_datalink
r_static
r_struct
id|datalink_proto
op_star
id|pSNAP_datalink
suffix:semicolon
DECL|variable|ipx_dgram_ops
r_static
r_struct
id|proto_ops
id|ipx_dgram_ops
suffix:semicolon
DECL|variable|ipx_routes
r_struct
id|ipx_route
op_star
id|ipx_routes
suffix:semicolon
DECL|variable|ipx_routes_lock
id|rwlock_t
id|ipx_routes_lock
op_assign
id|RW_LOCK_UNLOCKED
suffix:semicolon
DECL|variable|ipx_interfaces
r_struct
id|ipx_interface
op_star
id|ipx_interfaces
suffix:semicolon
DECL|variable|ipx_interfaces_lock
id|spinlock_t
id|ipx_interfaces_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
DECL|variable|ipx_primary_net
r_struct
id|ipx_interface
op_star
id|ipx_primary_net
suffix:semicolon
DECL|variable|ipx_internal_net
r_static
r_struct
id|ipx_interface
op_star
id|ipx_internal_net
suffix:semicolon
DECL|macro|IPX_REFCNT_DEBUG
macro_line|#undef IPX_REFCNT_DEBUG
macro_line|#ifdef IPX_REFCNT_DEBUG
DECL|variable|ipx_sock_nr
id|atomic_t
id|ipx_sock_nr
suffix:semicolon
macro_line|#endif
DECL|function|ipxcfg_set_auto_create
r_static
r_void
id|ipxcfg_set_auto_create
c_func
(paren
r_char
id|val
)paren
(brace
r_if
c_cond
(paren
id|ipxcfg_auto_create_interfaces
op_ne
id|val
)paren
(brace
r_if
c_cond
(paren
id|val
)paren
id|MOD_INC_USE_COUNT
suffix:semicolon
r_else
id|MOD_DEC_USE_COUNT
suffix:semicolon
id|ipxcfg_auto_create_interfaces
op_assign
id|val
suffix:semicolon
)brace
)brace
DECL|function|ipxcfg_set_auto_select
r_static
r_void
id|ipxcfg_set_auto_select
c_func
(paren
r_char
id|val
)paren
(brace
id|ipxcfg_auto_select_primary
op_assign
id|val
suffix:semicolon
r_if
c_cond
(paren
id|val
op_logical_and
op_logical_neg
id|ipx_primary_net
)paren
id|ipx_primary_net
op_assign
id|ipx_interfaces
suffix:semicolon
)brace
DECL|function|ipxcfg_get_config_data
r_static
r_int
id|ipxcfg_get_config_data
c_func
(paren
r_struct
id|ipx_config_data
op_star
id|arg
)paren
(brace
r_struct
id|ipx_config_data
id|vals
suffix:semicolon
id|vals.ipxcfg_auto_create_interfaces
op_assign
id|ipxcfg_auto_create_interfaces
suffix:semicolon
id|vals.ipxcfg_auto_select_primary
op_assign
id|ipxcfg_auto_select_primary
suffix:semicolon
r_return
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|vals
comma
r_sizeof
(paren
id|vals
)paren
)paren
ques
c_cond
op_minus
id|EFAULT
suffix:colon
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Handlers for the socket list. */
DECL|function|ipxitf_hold
r_static
id|__inline__
r_void
id|ipxitf_hold
c_func
(paren
r_struct
id|ipx_interface
op_star
id|intrfc
)paren
(brace
id|atomic_inc
c_func
(paren
op_amp
id|intrfc-&gt;refcnt
)paren
suffix:semicolon
)brace
r_static
r_void
id|ipxitf_down
c_func
(paren
r_struct
id|ipx_interface
op_star
id|intrfc
)paren
suffix:semicolon
DECL|function|ipxitf_put
r_static
id|__inline__
r_void
id|ipxitf_put
c_func
(paren
r_struct
id|ipx_interface
op_star
id|intrfc
)paren
(brace
r_if
c_cond
(paren
id|atomic_dec_and_test
c_func
(paren
op_amp
id|intrfc-&gt;refcnt
)paren
)paren
id|ipxitf_down
c_func
(paren
id|intrfc
)paren
suffix:semicolon
)brace
r_static
r_void
id|__ipxitf_down
c_func
(paren
r_struct
id|ipx_interface
op_star
id|intrfc
)paren
suffix:semicolon
DECL|function|__ipxitf_put
r_static
id|__inline__
r_void
id|__ipxitf_put
c_func
(paren
r_struct
id|ipx_interface
op_star
id|intrfc
)paren
(brace
r_if
c_cond
(paren
id|atomic_dec_and_test
c_func
(paren
op_amp
id|intrfc-&gt;refcnt
)paren
)paren
id|__ipxitf_down
c_func
(paren
id|intrfc
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Note: Sockets may not be removed _during_ an interrupt or inet_bh&n; * handler using this technique. They can be added although we do not&n; * use this facility.&n; */
DECL|function|ipx_remove_socket
r_static
r_void
id|ipx_remove_socket
c_func
(paren
r_struct
id|sock
op_star
id|sk
)paren
(brace
r_struct
id|sock
op_star
id|s
suffix:semicolon
multiline_comment|/* Determine interface with which socket is associated */
r_struct
id|ipx_interface
op_star
id|intrfc
op_assign
id|ipx_sk
c_func
(paren
id|sk
)paren
op_member_access_from_pointer
id|intrfc
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|intrfc
)paren
r_goto
id|out
suffix:semicolon
id|ipxitf_hold
c_func
(paren
id|intrfc
)paren
suffix:semicolon
id|spin_lock_bh
c_func
(paren
op_amp
id|intrfc-&gt;if_sklist_lock
)paren
suffix:semicolon
id|s
op_assign
id|intrfc-&gt;if_sklist
suffix:semicolon
r_if
c_cond
(paren
id|s
op_eq
id|sk
)paren
(brace
id|intrfc-&gt;if_sklist
op_assign
id|s-&gt;next
suffix:semicolon
r_goto
id|out_unlock
suffix:semicolon
)brace
r_while
c_loop
(paren
id|s
op_logical_and
id|s-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|s-&gt;next
op_eq
id|sk
)paren
(brace
id|s-&gt;next
op_assign
id|sk-&gt;next
suffix:semicolon
r_goto
id|out_unlock
suffix:semicolon
)brace
id|s
op_assign
id|s-&gt;next
suffix:semicolon
)brace
id|out_unlock
suffix:colon
id|spin_unlock_bh
c_func
(paren
op_amp
id|intrfc-&gt;if_sklist_lock
)paren
suffix:semicolon
id|sock_put
c_func
(paren
id|sk
)paren
suffix:semicolon
id|ipxitf_put
c_func
(paren
id|intrfc
)paren
suffix:semicolon
id|out
suffix:colon
r_return
suffix:semicolon
)brace
DECL|function|ipx_destroy_socket
r_static
r_void
id|ipx_destroy_socket
c_func
(paren
r_struct
id|sock
op_star
id|sk
)paren
(brace
id|ipx_remove_socket
c_func
(paren
id|sk
)paren
suffix:semicolon
id|skb_queue_purge
c_func
(paren
op_amp
id|sk-&gt;receive_queue
)paren
suffix:semicolon
macro_line|#ifdef IPX_REFCNT_DEBUG
id|atomic_dec
c_func
(paren
op_amp
id|ipx_sock_nr
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;IPX socket %p released, %d are still alive&bslash;n&quot;
comma
id|sk
comma
id|atomic_read
c_func
(paren
op_amp
id|ipx_sock_nr
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|sk-&gt;refcnt
)paren
op_ne
l_int|1
)paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Destruction sock ipx %p delayed, cnt=%d&bslash;n&quot;
comma
id|sk
comma
id|atomic_read
c_func
(paren
op_amp
id|sk-&gt;refcnt
)paren
)paren
suffix:semicolon
macro_line|#endif
id|sock_put
c_func
(paren
id|sk
)paren
suffix:semicolon
)brace
multiline_comment|/* &n; * The following code is used to support IPX Interfaces (IPXITF).  An&n; * IPX interface is defined by a physical device and a frame type.&n; */
r_static
r_struct
id|ipx_route
op_star
id|ipxrtr_lookup
c_func
(paren
id|__u32
id|net
)paren
suffix:semicolon
multiline_comment|/* ipxitf_clear_primary_net has to be called with ipx_interfaces_lock held */
DECL|function|ipxitf_clear_primary_net
r_static
r_void
id|ipxitf_clear_primary_net
c_func
(paren
r_void
)paren
(brace
id|ipx_primary_net
op_assign
id|ipxcfg_auto_select_primary
ques
c_cond
id|ipx_interfaces
suffix:colon
l_int|NULL
suffix:semicolon
)brace
DECL|function|__ipxitf_find_using_phys
r_static
r_struct
id|ipx_interface
op_star
id|__ipxitf_find_using_phys
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
r_int
id|datalink
)paren
(brace
r_struct
id|ipx_interface
op_star
id|i
op_assign
id|ipx_interfaces
suffix:semicolon
r_while
c_loop
(paren
id|i
op_logical_and
(paren
id|i-&gt;if_dev
op_ne
id|dev
op_logical_or
id|i-&gt;if_dlink_type
op_ne
id|datalink
)paren
)paren
id|i
op_assign
id|i-&gt;if_next
suffix:semicolon
r_return
id|i
suffix:semicolon
)brace
DECL|function|ipxitf_find_using_phys
r_static
r_struct
id|ipx_interface
op_star
id|ipxitf_find_using_phys
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
r_int
id|datalink
)paren
(brace
r_struct
id|ipx_interface
op_star
id|i
suffix:semicolon
id|spin_lock_bh
c_func
(paren
op_amp
id|ipx_interfaces_lock
)paren
suffix:semicolon
id|i
op_assign
id|__ipxitf_find_using_phys
c_func
(paren
id|dev
comma
id|datalink
)paren
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
id|ipxitf_hold
c_func
(paren
id|i
)paren
suffix:semicolon
id|spin_unlock_bh
c_func
(paren
op_amp
id|ipx_interfaces_lock
)paren
suffix:semicolon
r_return
id|i
suffix:semicolon
)brace
DECL|function|ipxitf_find_using_net
r_static
r_struct
id|ipx_interface
op_star
id|ipxitf_find_using_net
c_func
(paren
id|__u32
id|net
)paren
(brace
r_struct
id|ipx_interface
op_star
id|i
suffix:semicolon
id|spin_lock_bh
c_func
(paren
op_amp
id|ipx_interfaces_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|net
)paren
r_for
c_loop
(paren
id|i
op_assign
id|ipx_interfaces
suffix:semicolon
id|i
op_logical_and
id|i-&gt;if_netnum
op_ne
id|net
suffix:semicolon
id|i
op_assign
id|i-&gt;if_next
)paren
suffix:semicolon
r_else
id|i
op_assign
id|ipx_primary_net
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
id|ipxitf_hold
c_func
(paren
id|i
)paren
suffix:semicolon
id|spin_unlock_bh
c_func
(paren
op_amp
id|ipx_interfaces_lock
)paren
suffix:semicolon
r_return
id|i
suffix:semicolon
)brace
multiline_comment|/* Sockets are bound to a particular IPX interface. */
DECL|function|ipxitf_insert_socket
r_static
r_void
id|ipxitf_insert_socket
c_func
(paren
r_struct
id|ipx_interface
op_star
id|intrfc
comma
r_struct
id|sock
op_star
id|sk
)paren
(brace
id|ipxitf_hold
c_func
(paren
id|intrfc
)paren
suffix:semicolon
id|sock_hold
c_func
(paren
id|sk
)paren
suffix:semicolon
id|spin_lock_bh
c_func
(paren
op_amp
id|intrfc-&gt;if_sklist_lock
)paren
suffix:semicolon
id|ipx_sk
c_func
(paren
id|sk
)paren
op_member_access_from_pointer
id|intrfc
op_assign
id|intrfc
suffix:semicolon
id|sk-&gt;next
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|intrfc-&gt;if_sklist
)paren
id|intrfc-&gt;if_sklist
op_assign
id|sk
suffix:semicolon
r_else
(brace
r_struct
id|sock
op_star
id|s
op_assign
id|intrfc-&gt;if_sklist
suffix:semicolon
r_while
c_loop
(paren
id|s-&gt;next
)paren
id|s
op_assign
id|s-&gt;next
suffix:semicolon
id|s-&gt;next
op_assign
id|sk
suffix:semicolon
)brace
id|spin_unlock_bh
c_func
(paren
op_amp
id|intrfc-&gt;if_sklist_lock
)paren
suffix:semicolon
id|ipxitf_put
c_func
(paren
id|intrfc
)paren
suffix:semicolon
)brace
multiline_comment|/* caller must hold intrfc-&gt;if_sklist_lock */
DECL|function|__ipxitf_find_socket
r_static
r_struct
id|sock
op_star
id|__ipxitf_find_socket
c_func
(paren
r_struct
id|ipx_interface
op_star
id|intrfc
comma
r_int
r_int
id|port
)paren
(brace
r_struct
id|sock
op_star
id|s
op_assign
id|intrfc-&gt;if_sklist
suffix:semicolon
r_while
c_loop
(paren
id|s
op_logical_and
id|ipx_sk
c_func
(paren
id|s
)paren
op_member_access_from_pointer
id|port
op_ne
id|port
)paren
id|s
op_assign
id|s-&gt;next
suffix:semicolon
r_return
id|s
suffix:semicolon
)brace
multiline_comment|/* caller must hold a reference to intrfc */
DECL|function|ipxitf_find_socket
r_static
r_struct
id|sock
op_star
id|ipxitf_find_socket
c_func
(paren
r_struct
id|ipx_interface
op_star
id|intrfc
comma
r_int
r_int
id|port
)paren
(brace
r_struct
id|sock
op_star
id|s
suffix:semicolon
id|spin_lock_bh
c_func
(paren
op_amp
id|intrfc-&gt;if_sklist_lock
)paren
suffix:semicolon
id|s
op_assign
id|__ipxitf_find_socket
c_func
(paren
id|intrfc
comma
id|port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
)paren
id|sock_hold
c_func
(paren
id|s
)paren
suffix:semicolon
id|spin_unlock_bh
c_func
(paren
op_amp
id|intrfc-&gt;if_sklist_lock
)paren
suffix:semicolon
r_return
id|s
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_IPX_INTERN
DECL|function|ipxitf_find_internal_socket
r_static
r_struct
id|sock
op_star
id|ipxitf_find_internal_socket
c_func
(paren
r_struct
id|ipx_interface
op_star
id|intrfc
comma
r_int
r_char
op_star
id|node
comma
r_int
r_int
id|port
)paren
(brace
r_struct
id|sock
op_star
id|s
suffix:semicolon
id|ipxitf_hold
c_func
(paren
id|intrfc
)paren
suffix:semicolon
id|spin_lock_bh
c_func
(paren
op_amp
id|intrfc-&gt;if_sklist_lock
)paren
suffix:semicolon
id|s
op_assign
id|intrfc-&gt;if_sklist
suffix:semicolon
r_while
c_loop
(paren
id|s
)paren
(brace
r_struct
id|ipx_opt
op_star
id|ipxs
op_assign
id|ipx_sk
c_func
(paren
id|s
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ipxs-&gt;port
op_eq
id|port
op_logical_and
op_logical_neg
id|memcmp
c_func
(paren
id|node
comma
id|ipxs-&gt;node
comma
id|IPX_NODE_LEN
)paren
)paren
r_break
suffix:semicolon
id|s
op_assign
id|s-&gt;next
suffix:semicolon
)brace
id|spin_unlock_bh
c_func
(paren
op_amp
id|intrfc-&gt;if_sklist_lock
)paren
suffix:semicolon
id|ipxitf_put
c_func
(paren
id|intrfc
)paren
suffix:semicolon
r_return
id|s
suffix:semicolon
)brace
macro_line|#endif
r_static
r_void
id|ipxrtr_del_routes
c_func
(paren
r_struct
id|ipx_interface
op_star
id|intrfc
)paren
suffix:semicolon
DECL|function|__ipxitf_down
r_static
r_void
id|__ipxitf_down
c_func
(paren
r_struct
id|ipx_interface
op_star
id|intrfc
)paren
(brace
r_struct
id|sock
op_star
id|s
comma
op_star
id|t
suffix:semicolon
multiline_comment|/* Delete all routes associated with this interface */
id|ipxrtr_del_routes
c_func
(paren
id|intrfc
)paren
suffix:semicolon
id|spin_lock_bh
c_func
(paren
op_amp
id|intrfc-&gt;if_sklist_lock
)paren
suffix:semicolon
multiline_comment|/* error sockets */
r_for
c_loop
(paren
id|s
op_assign
id|intrfc-&gt;if_sklist
suffix:semicolon
id|s
suffix:semicolon
)paren
(brace
r_struct
id|ipx_opt
op_star
id|ipxs
op_assign
id|ipx_sk
c_func
(paren
id|s
)paren
suffix:semicolon
id|s-&gt;err
op_assign
id|ENOLINK
suffix:semicolon
id|s
op_member_access_from_pointer
id|error_report
c_func
(paren
id|s
)paren
suffix:semicolon
id|ipxs-&gt;intrfc
op_assign
l_int|NULL
suffix:semicolon
id|ipxs-&gt;port
op_assign
l_int|0
suffix:semicolon
id|s-&gt;zapped
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Indicates it is no longer bound */
id|t
op_assign
id|s
suffix:semicolon
id|s
op_assign
id|s-&gt;next
suffix:semicolon
id|t-&gt;next
op_assign
l_int|NULL
suffix:semicolon
)brace
id|intrfc-&gt;if_sklist
op_assign
l_int|NULL
suffix:semicolon
id|spin_unlock_bh
c_func
(paren
op_amp
id|intrfc-&gt;if_sklist_lock
)paren
suffix:semicolon
multiline_comment|/* remove this interface from list */
r_if
c_cond
(paren
id|intrfc
op_eq
id|ipx_interfaces
)paren
id|ipx_interfaces
op_assign
id|intrfc-&gt;if_next
suffix:semicolon
r_else
(brace
r_struct
id|ipx_interface
op_star
id|i
op_assign
id|ipx_interfaces
suffix:semicolon
r_while
c_loop
(paren
id|i
op_logical_and
id|i-&gt;if_next
op_ne
id|intrfc
)paren
id|i
op_assign
id|i-&gt;if_next
suffix:semicolon
r_if
c_cond
(paren
id|i
op_logical_and
id|i-&gt;if_next
op_eq
id|intrfc
)paren
id|i-&gt;if_next
op_assign
id|intrfc-&gt;if_next
suffix:semicolon
)brace
multiline_comment|/* remove this interface from *special* networks */
r_if
c_cond
(paren
id|intrfc
op_eq
id|ipx_primary_net
)paren
id|ipxitf_clear_primary_net
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|intrfc
op_eq
id|ipx_internal_net
)paren
id|ipx_internal_net
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|intrfc-&gt;if_dev
)paren
id|dev_put
c_func
(paren
id|intrfc-&gt;if_dev
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|intrfc
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
)brace
DECL|function|ipxitf_down
r_static
r_void
id|ipxitf_down
c_func
(paren
r_struct
id|ipx_interface
op_star
id|intrfc
)paren
(brace
id|spin_lock_bh
c_func
(paren
op_amp
id|ipx_interfaces_lock
)paren
suffix:semicolon
id|__ipxitf_down
c_func
(paren
id|intrfc
)paren
suffix:semicolon
id|spin_unlock_bh
c_func
(paren
op_amp
id|ipx_interfaces_lock
)paren
suffix:semicolon
)brace
DECL|function|ipxitf_device_event
r_static
r_int
id|ipxitf_device_event
c_func
(paren
r_struct
id|notifier_block
op_star
id|notifier
comma
r_int
r_int
id|event
comma
r_void
op_star
id|ptr
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|ptr
suffix:semicolon
r_struct
id|ipx_interface
op_star
id|i
comma
op_star
id|tmp
suffix:semicolon
r_if
c_cond
(paren
id|event
op_ne
id|NETDEV_DOWN
op_logical_and
id|event
op_ne
id|NETDEV_UP
)paren
r_goto
id|out
suffix:semicolon
id|spin_lock_bh
c_func
(paren
op_amp
id|ipx_interfaces_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|ipx_interfaces
suffix:semicolon
id|i
suffix:semicolon
)paren
(brace
id|tmp
op_assign
id|i-&gt;if_next
suffix:semicolon
r_if
c_cond
(paren
id|i-&gt;if_dev
op_eq
id|dev
)paren
(brace
r_if
c_cond
(paren
id|event
op_eq
id|NETDEV_UP
)paren
id|ipxitf_hold
c_func
(paren
id|i
)paren
suffix:semicolon
r_else
id|__ipxitf_put
c_func
(paren
id|i
)paren
suffix:semicolon
)brace
id|i
op_assign
id|tmp
suffix:semicolon
)brace
id|spin_unlock_bh
c_func
(paren
op_amp
id|ipx_interfaces_lock
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|NOTIFY_DONE
suffix:semicolon
)brace
DECL|function|ipxitf_def_skb_handler
r_static
r_void
id|ipxitf_def_skb_handler
c_func
(paren
r_struct
id|sock
op_star
id|sock
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_if
c_cond
(paren
id|sock_queue_rcv_skb
c_func
(paren
id|sock
comma
id|skb
)paren
OL
l_int|0
)paren
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * On input skb-&gt;sk is NULL. Nobody is charged for the memory.&n; */
multiline_comment|/* caller must hold a reference to intrfc */
macro_line|#ifdef CONFIG_IPX_INTERN
DECL|function|ipxitf_demux_socket
r_static
r_int
id|ipxitf_demux_socket
c_func
(paren
r_struct
id|ipx_interface
op_star
id|intrfc
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_int
id|copy
)paren
(brace
r_struct
id|ipxhdr
op_star
id|ipx
op_assign
id|ipx_hdr
c_func
(paren
id|skb
)paren
suffix:semicolon
r_int
id|is_broadcast
op_assign
op_logical_neg
id|memcmp
c_func
(paren
id|ipx-&gt;ipx_dest.node
comma
id|ipx_broadcast_node
comma
id|IPX_NODE_LEN
)paren
suffix:semicolon
r_struct
id|sock
op_star
id|s
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|spin_lock_bh
c_func
(paren
op_amp
id|intrfc-&gt;if_sklist_lock
)paren
suffix:semicolon
id|s
op_assign
id|intrfc-&gt;if_sklist
suffix:semicolon
r_while
c_loop
(paren
id|s
)paren
(brace
r_struct
id|ipx_opt
op_star
id|ipxs
op_assign
id|ipx_sk
c_func
(paren
id|s
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ipxs-&gt;port
op_eq
id|ipx-&gt;ipx_dest.sock
op_logical_and
(paren
id|is_broadcast
op_logical_or
op_logical_neg
id|memcmp
c_func
(paren
id|ipx-&gt;ipx_dest.node
comma
id|ipxs-&gt;node
comma
id|IPX_NODE_LEN
)paren
)paren
)paren
(brace
multiline_comment|/* We found a socket to which to send */
r_struct
id|sk_buff
op_star
id|skb1
suffix:semicolon
r_if
c_cond
(paren
id|copy
)paren
(brace
id|skb1
op_assign
id|skb_clone
c_func
(paren
id|skb
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb1
)paren
r_goto
id|out
suffix:semicolon
)brace
r_else
(brace
id|skb1
op_assign
id|skb
suffix:semicolon
id|copy
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* skb may only be used once */
)brace
id|ipxitf_def_skb_handler
c_func
(paren
id|s
comma
id|skb1
)paren
suffix:semicolon
multiline_comment|/* On an external interface, one socket can listen */
r_if
c_cond
(paren
id|intrfc
op_ne
id|ipx_internal_net
)paren
r_break
suffix:semicolon
)brace
id|s
op_assign
id|s-&gt;next
suffix:semicolon
)brace
multiline_comment|/* skb was solely for us, and we did not make a copy, so free it. */
r_if
c_cond
(paren
op_logical_neg
id|copy
)paren
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
id|out
suffix:colon
id|spin_unlock_bh
c_func
(paren
op_amp
id|intrfc-&gt;if_sklist_lock
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
macro_line|#else
DECL|function|ncp_connection_hack
r_static
r_struct
id|sock
op_star
id|ncp_connection_hack
c_func
(paren
r_struct
id|ipx_interface
op_star
id|intrfc
comma
r_struct
id|ipxhdr
op_star
id|ipx
)paren
(brace
multiline_comment|/* The packet&squot;s target is a NCP connection handler. We want to hand it&n;&t; * to the correct socket directly within the kernel, so that the&n;&t; * mars_nwe packet distribution process does not have to do it. Here we&n;&t; * only care about NCP and BURST packets.&n;&t; *&n;&t; * You might call this a hack, but believe me, you do not want a&n;&t; * complete NCP layer in the kernel, and this is VERY fast as well. */
r_struct
id|sock
op_star
id|sk
op_assign
l_int|NULL
suffix:semicolon
r_int
id|connection
op_assign
l_int|0
suffix:semicolon
id|u8
op_star
id|ncphdr
op_assign
(paren
id|u8
op_star
)paren
(paren
id|ipx
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|ncphdr
op_eq
l_int|0x22
op_logical_and
op_star
(paren
id|ncphdr
op_plus
l_int|1
)paren
op_eq
l_int|0x22
)paren
multiline_comment|/* NCP request */
id|connection
op_assign
(paren
(paren
(paren
r_int
)paren
op_star
(paren
id|ncphdr
op_plus
l_int|5
)paren
)paren
op_lshift
l_int|8
)paren
op_or
(paren
r_int
)paren
op_star
(paren
id|ncphdr
op_plus
l_int|3
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
op_star
id|ncphdr
op_eq
l_int|0x77
op_logical_and
op_star
(paren
id|ncphdr
op_plus
l_int|1
)paren
op_eq
l_int|0x77
)paren
multiline_comment|/* BURST packet */
id|connection
op_assign
(paren
(paren
(paren
r_int
)paren
op_star
(paren
id|ncphdr
op_plus
l_int|9
)paren
)paren
op_lshift
l_int|8
)paren
op_or
(paren
r_int
)paren
op_star
(paren
id|ncphdr
op_plus
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|connection
)paren
(brace
multiline_comment|/* Now we have to look for a special NCP connection handling&n;&t;&t; * socket. Only these sockets have ipx_ncp_conn != 0, set by&n;&t;&t; * SIOCIPXNCPCONN. */
id|spin_lock_bh
c_func
(paren
op_amp
id|intrfc-&gt;if_sklist_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|sk
op_assign
id|intrfc-&gt;if_sklist
suffix:semicolon
id|sk
op_logical_and
id|ipx_sk
c_func
(paren
id|sk
)paren
op_member_access_from_pointer
id|ipx_ncp_conn
op_ne
id|connection
suffix:semicolon
id|sk
op_assign
id|sk-&gt;next
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sk
)paren
id|sock_hold
c_func
(paren
id|sk
)paren
suffix:semicolon
id|spin_unlock_bh
c_func
(paren
op_amp
id|intrfc-&gt;if_sklist_lock
)paren
suffix:semicolon
)brace
r_return
id|sk
suffix:semicolon
)brace
DECL|function|ipxitf_demux_socket
r_static
r_int
id|ipxitf_demux_socket
c_func
(paren
r_struct
id|ipx_interface
op_star
id|intrfc
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_int
id|copy
)paren
(brace
r_struct
id|ipxhdr
op_star
id|ipx
op_assign
id|ipx_hdr
c_func
(paren
id|skb
)paren
suffix:semicolon
r_struct
id|sock
op_star
id|sock1
op_assign
l_int|NULL
comma
op_star
id|sock2
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb1
op_assign
l_int|NULL
comma
op_star
id|skb2
op_assign
l_int|NULL
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
id|intrfc
op_eq
id|ipx_primary_net
op_logical_and
id|ntohs
c_func
(paren
id|ipx-&gt;ipx_dest.sock
)paren
op_eq
l_int|0x451
)paren
id|sock1
op_assign
id|ncp_connection_hack
c_func
(paren
id|intrfc
comma
id|ipx
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sock1
)paren
multiline_comment|/* No special socket found, forward the packet the normal way */
id|sock1
op_assign
id|ipxitf_find_socket
c_func
(paren
id|intrfc
comma
id|ipx-&gt;ipx_dest.sock
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * We need to check if there is a primary net and if&n;&t; * this is addressed to one of the *SPECIAL* sockets because&n;&t; * these need to be propagated to the primary net.&n;&t; * The *SPECIAL* socket list contains: 0x452(SAP), 0x453(RIP) and&n;&t; * 0x456(Diagnostic).&n;&t; */
r_if
c_cond
(paren
id|ipx_primary_net
op_logical_and
id|intrfc
op_ne
id|ipx_primary_net
)paren
(brace
r_const
r_int
id|dsock
op_assign
id|ntohs
c_func
(paren
id|ipx-&gt;ipx_dest.sock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dsock
op_eq
l_int|0x452
op_logical_or
id|dsock
op_eq
l_int|0x453
op_logical_or
id|dsock
op_eq
l_int|0x456
)paren
multiline_comment|/* The appropriate thing to do here is to dup the&n;&t;&t;&t; * packet and route to the primary net interface via&n;&t;&t;&t; * ipxitf_send; however, we&squot;ll cheat and just demux it&n;&t;&t;&t; * here. */
id|sock2
op_assign
id|ipxitf_find_socket
c_func
(paren
id|ipx_primary_net
comma
id|ipx-&gt;ipx_dest.sock
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * If there is nothing to do return. The kfree will cancel any charging.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|sock1
op_logical_and
op_logical_neg
id|sock2
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|copy
)paren
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * This next segment of code is a little awkward, but it sets it up&n;&t; * so that the appropriate number of copies of the SKB are made and&n;&t; * that skb1 and skb2 point to it (them) so that it (they) can be&n;&t; * demuxed to sock1 and/or sock2.  If we are unable to make enough&n;&t; * copies, we do as much as is possible.&n;&t; */
r_if
c_cond
(paren
id|copy
)paren
id|skb1
op_assign
id|skb_clone
c_func
(paren
id|skb
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_else
id|skb1
op_assign
id|skb
suffix:semicolon
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb1
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* Do we need 2 SKBs? */
r_if
c_cond
(paren
id|sock1
op_logical_and
id|sock2
)paren
id|skb2
op_assign
id|skb_clone
c_func
(paren
id|skb1
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_else
id|skb2
op_assign
id|skb1
suffix:semicolon
r_if
c_cond
(paren
id|sock1
)paren
id|ipxitf_def_skb_handler
c_func
(paren
id|sock1
comma
id|skb1
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb2
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|sock2
)paren
id|ipxitf_def_skb_handler
c_func
(paren
id|sock2
comma
id|skb2
)paren
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
id|out
suffix:colon
r_if
c_cond
(paren
id|sock1
)paren
id|sock_put
c_func
(paren
id|sock1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sock2
)paren
id|sock_put
c_func
(paren
id|sock2
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
macro_line|#endif&t;/* CONFIG_IPX_INTERN */
DECL|function|ipxitf_adjust_skbuff
r_static
r_struct
id|sk_buff
op_star
id|ipxitf_adjust_skbuff
c_func
(paren
r_struct
id|ipx_interface
op_star
id|intrfc
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb2
suffix:semicolon
r_int
id|in_offset
op_assign
(paren
r_int
r_char
op_star
)paren
id|ipx_hdr
c_func
(paren
id|skb
)paren
op_minus
id|skb-&gt;head
suffix:semicolon
r_int
id|out_offset
op_assign
id|intrfc-&gt;if_ipx_offset
suffix:semicolon
r_int
id|len
suffix:semicolon
multiline_comment|/* Hopefully, most cases */
r_if
c_cond
(paren
id|in_offset
op_ge
id|out_offset
)paren
r_return
id|skb
suffix:semicolon
multiline_comment|/* Need new SKB */
id|len
op_assign
id|skb-&gt;len
op_plus
id|out_offset
suffix:semicolon
id|skb2
op_assign
id|alloc_skb
c_func
(paren
id|len
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb2
)paren
(brace
id|skb_reserve
c_func
(paren
id|skb2
comma
id|out_offset
)paren
suffix:semicolon
id|skb2-&gt;nh.raw
op_assign
id|skb2-&gt;h.raw
op_assign
id|skb_put
c_func
(paren
id|skb2
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|ipx_hdr
c_func
(paren
id|skb2
)paren
comma
id|ipx_hdr
c_func
(paren
id|skb
)paren
comma
id|skb-&gt;len
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|skb2-&gt;cb
comma
id|skb-&gt;cb
comma
r_sizeof
(paren
id|skb-&gt;cb
)paren
)paren
suffix:semicolon
)brace
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
id|skb2
suffix:semicolon
)brace
multiline_comment|/* caller must hold a reference to intrfc and the skb has to be unshared */
DECL|function|ipxitf_send
r_static
r_int
id|ipxitf_send
c_func
(paren
r_struct
id|ipx_interface
op_star
id|intrfc
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_char
op_star
id|node
)paren
(brace
r_struct
id|ipxhdr
op_star
id|ipx
op_assign
id|ipx_hdr
c_func
(paren
id|skb
)paren
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
op_assign
id|intrfc-&gt;if_dev
suffix:semicolon
r_struct
id|datalink_proto
op_star
id|dl
op_assign
id|intrfc-&gt;if_dlink
suffix:semicolon
r_char
id|dest_node
(braket
id|IPX_NODE_LEN
)braket
suffix:semicolon
r_int
id|send_to_wire
op_assign
l_int|1
suffix:semicolon
r_int
id|addr_len
suffix:semicolon
id|ipx-&gt;ipx_tctrl
op_assign
id|IPX_SKB_CB
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|ipx_tctrl
suffix:semicolon
id|ipx-&gt;ipx_dest.net
op_assign
id|IPX_SKB_CB
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|ipx_dest_net
suffix:semicolon
id|ipx-&gt;ipx_source.net
op_assign
id|IPX_SKB_CB
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|ipx_source_net
suffix:semicolon
multiline_comment|/* see if we need to include the netnum in the route list */
r_if
c_cond
(paren
id|IPX_SKB_CB
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|last_hop.index
op_ge
l_int|0
)paren
(brace
id|u32
op_star
id|last_hop
op_assign
(paren
id|u32
op_star
)paren
(paren
(paren
(paren
id|u8
op_star
)paren
id|skb-&gt;data
)paren
op_plus
r_sizeof
(paren
r_struct
id|ipxhdr
)paren
op_plus
id|IPX_SKB_CB
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|last_hop.index
op_star
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
op_star
id|last_hop
op_assign
id|IPX_SKB_CB
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|last_hop.netnum
suffix:semicolon
id|IPX_SKB_CB
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|last_hop.index
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* &n;&t; * We need to know how many skbuffs it will take to send out this&n;&t; * packet to avoid unnecessary copies.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|dl
op_logical_or
op_logical_neg
id|dev
op_logical_or
id|dev-&gt;flags
op_amp
id|IFF_LOOPBACK
)paren
id|send_to_wire
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* No non looped */
multiline_comment|/*&n;&t; * See if this should be demuxed to sockets on this interface &n;&t; *&n;&t; * We want to ensure the original was eaten or that we only use&n;&t; * up clones.&n;&t; */
r_if
c_cond
(paren
id|ipx-&gt;ipx_dest.net
op_eq
id|intrfc-&gt;if_netnum
)paren
(brace
multiline_comment|/*&n;&t;&t; * To our own node, loop and free the original.&n;&t;&t; * The internal net will receive on all node address.&n;&t;&t; */
r_if
c_cond
(paren
id|intrfc
op_eq
id|ipx_internal_net
op_logical_or
op_logical_neg
id|memcmp
c_func
(paren
id|intrfc-&gt;if_node
comma
id|node
comma
id|IPX_NODE_LEN
)paren
)paren
(brace
multiline_comment|/* Don&squot;t charge sender */
id|skb_orphan
c_func
(paren
id|skb
)paren
suffix:semicolon
multiline_comment|/* Will charge receiver */
r_return
id|ipxitf_demux_socket
c_func
(paren
id|intrfc
comma
id|skb
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/* Broadcast, loop and possibly keep to send on. */
r_if
c_cond
(paren
op_logical_neg
id|memcmp
c_func
(paren
id|ipx_broadcast_node
comma
id|node
comma
id|IPX_NODE_LEN
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|send_to_wire
)paren
id|skb_orphan
c_func
(paren
id|skb
)paren
suffix:semicolon
id|ipxitf_demux_socket
c_func
(paren
id|intrfc
comma
id|skb
comma
id|send_to_wire
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|send_to_wire
)paren
r_goto
id|out
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t; * If the originating net is not equal to our net; this is routed&n;&t; * We are still charging the sender. Which is right - the driver&n;&t; * free will handle this fairly.&n;&t; */
r_if
c_cond
(paren
id|ipx-&gt;ipx_source.net
op_ne
id|intrfc-&gt;if_netnum
)paren
(brace
multiline_comment|/*&n;&t;&t; * Unshare the buffer before modifying the count in&n;&t;&t; * case its a flood or tcpdump&n;&t;&t; */
id|skb
op_assign
id|skb_unshare
c_func
(paren
id|skb
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|ipx-&gt;ipx_tctrl
OG
id|ipxcfg_max_hops
)paren
id|send_to_wire
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|send_to_wire
)paren
(brace
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* Determine the appropriate hardware address */
id|addr_len
op_assign
id|dev-&gt;addr_len
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|memcmp
c_func
(paren
id|ipx_broadcast_node
comma
id|node
comma
id|IPX_NODE_LEN
)paren
)paren
id|memcpy
c_func
(paren
id|dest_node
comma
id|dev-&gt;broadcast
comma
id|addr_len
)paren
suffix:semicolon
r_else
id|memcpy
c_func
(paren
id|dest_node
comma
op_amp
(paren
id|node
(braket
id|IPX_NODE_LEN
op_minus
id|addr_len
)braket
)paren
comma
id|addr_len
)paren
suffix:semicolon
multiline_comment|/* Make any compensation for differing physical/data link size */
id|skb
op_assign
id|ipxitf_adjust_skbuff
c_func
(paren
id|intrfc
comma
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* set up data link and physical headers */
id|skb-&gt;dev
op_assign
id|dev
suffix:semicolon
id|skb-&gt;protocol
op_assign
id|htons
c_func
(paren
id|ETH_P_IPX
)paren
suffix:semicolon
multiline_comment|/* Send it out */
id|dl
op_member_access_from_pointer
id|request
c_func
(paren
id|dl
comma
id|skb
comma
id|dest_node
)paren
suffix:semicolon
id|out
suffix:colon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
id|ipxrtr_add_route
c_func
(paren
id|__u32
id|network
comma
r_struct
id|ipx_interface
op_star
id|intrfc
comma
r_int
r_char
op_star
)paren
suffix:semicolon
DECL|function|ipxitf_add_local_route
r_static
r_int
id|ipxitf_add_local_route
c_func
(paren
r_struct
id|ipx_interface
op_star
id|intrfc
)paren
(brace
r_return
id|ipxrtr_add_route
c_func
(paren
id|intrfc-&gt;if_netnum
comma
id|intrfc
comma
l_int|NULL
)paren
suffix:semicolon
)brace
r_static
r_void
id|ipxitf_discover_netnum
c_func
(paren
r_struct
id|ipx_interface
op_star
id|intrfc
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
suffix:semicolon
r_static
r_int
id|ipxitf_pprop
c_func
(paren
r_struct
id|ipx_interface
op_star
id|intrfc
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
suffix:semicolon
r_static
r_int
id|ipxrtr_route_skb
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
suffix:semicolon
DECL|function|ipxitf_rcv
r_static
r_int
id|ipxitf_rcv
c_func
(paren
r_struct
id|ipx_interface
op_star
id|intrfc
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|ipxhdr
op_star
id|ipx
op_assign
id|ipx_hdr
c_func
(paren
id|skb
)paren
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
id|ipxitf_hold
c_func
(paren
id|intrfc
)paren
suffix:semicolon
multiline_comment|/* See if we should update our network number */
r_if
c_cond
(paren
op_logical_neg
id|intrfc-&gt;if_netnum
)paren
multiline_comment|/* net number of intrfc not known yet */
id|ipxitf_discover_netnum
c_func
(paren
id|intrfc
comma
id|skb
)paren
suffix:semicolon
id|IPX_SKB_CB
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|last_hop.index
op_assign
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|ipx-&gt;ipx_type
op_eq
id|IPX_TYPE_PPROP
)paren
(brace
id|ret
op_assign
id|ipxitf_pprop
c_func
(paren
id|intrfc
comma
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_goto
id|out_free_skb
suffix:semicolon
)brace
multiline_comment|/* local processing follows */
r_if
c_cond
(paren
op_logical_neg
id|IPX_SKB_CB
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|ipx_dest_net
)paren
id|IPX_SKB_CB
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|ipx_dest_net
op_assign
id|intrfc-&gt;if_netnum
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|IPX_SKB_CB
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|ipx_source_net
)paren
id|IPX_SKB_CB
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|ipx_source_net
op_assign
id|intrfc-&gt;if_netnum
suffix:semicolon
multiline_comment|/* it doesn&squot;t make sense to route a pprop packet, there&squot;s no meaning&n;&t; * in the ipx_dest_net for such packets */
r_if
c_cond
(paren
id|ipx-&gt;ipx_type
op_ne
id|IPX_TYPE_PPROP
op_logical_and
id|intrfc-&gt;if_netnum
op_ne
id|IPX_SKB_CB
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|ipx_dest_net
)paren
(brace
multiline_comment|/* We only route point-to-point packets. */
r_if
c_cond
(paren
id|skb-&gt;pkt_type
op_eq
id|PACKET_HOST
)paren
(brace
id|skb
op_assign
id|skb_unshare
c_func
(paren
id|skb
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
)paren
id|ret
op_assign
id|ipxrtr_route_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_goto
id|out_intrfc
suffix:semicolon
)brace
r_goto
id|out_free_skb
suffix:semicolon
)brace
multiline_comment|/* see if we should keep it */
r_if
c_cond
(paren
op_logical_neg
id|memcmp
c_func
(paren
id|ipx_broadcast_node
comma
id|ipx-&gt;ipx_dest.node
comma
id|IPX_NODE_LEN
)paren
op_logical_or
op_logical_neg
id|memcmp
c_func
(paren
id|intrfc-&gt;if_node
comma
id|ipx-&gt;ipx_dest.node
comma
id|IPX_NODE_LEN
)paren
)paren
(brace
id|ret
op_assign
id|ipxitf_demux_socket
c_func
(paren
id|intrfc
comma
id|skb
comma
l_int|0
)paren
suffix:semicolon
r_goto
id|out_intrfc
suffix:semicolon
)brace
multiline_comment|/* we couldn&squot;t pawn it off so unload it */
id|out_free_skb
suffix:colon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|out_intrfc
suffix:colon
id|ipxitf_put
c_func
(paren
id|intrfc
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|ipxitf_discover_netnum
r_static
r_void
id|ipxitf_discover_netnum
c_func
(paren
r_struct
id|ipx_interface
op_star
id|intrfc
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_const
r_struct
id|ipx_cb
op_star
id|cb
op_assign
id|IPX_SKB_CB
c_func
(paren
id|skb
)paren
suffix:semicolon
multiline_comment|/* see if this is an intra packet: source_net == dest_net */
r_if
c_cond
(paren
id|cb-&gt;ipx_source_net
op_eq
id|cb-&gt;ipx_dest_net
op_logical_and
id|cb-&gt;ipx_source_net
)paren
(brace
r_struct
id|ipx_interface
op_star
id|i
op_assign
id|ipxitf_find_using_net
c_func
(paren
id|cb-&gt;ipx_source_net
)paren
suffix:semicolon
multiline_comment|/* NB: NetWare servers lie about their hop count so we&n;&t;&t; * dropped the test based on it. This is the best way&n;&t;&t; * to determine this is a 0 hop count packet. */
r_if
c_cond
(paren
op_logical_neg
id|i
)paren
(brace
id|intrfc-&gt;if_netnum
op_assign
id|cb-&gt;ipx_source_net
suffix:semicolon
id|ipxitf_add_local_route
c_func
(paren
id|intrfc
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;IPX: Network number collision &quot;
l_string|&quot;%lx&bslash;n        %s %s and %s %s&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|htonl
c_func
(paren
id|cb-&gt;ipx_source_net
)paren
comma
id|ipx_device_name
c_func
(paren
id|i
)paren
comma
id|ipx_frame_name
c_func
(paren
id|i-&gt;if_dlink_type
)paren
comma
id|ipx_device_name
c_func
(paren
id|intrfc
)paren
comma
id|ipx_frame_name
c_func
(paren
id|intrfc-&gt;if_dlink_type
)paren
)paren
suffix:semicolon
id|ipxitf_put
c_func
(paren
id|i
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/**&n; * ipxitf_pprop - Process packet propagation IPX packet type 0x14, used for&n; * &t;&t;  NetBIOS broadcasts&n; * @intrfc: IPX interface receiving this packet&n; * @skb: Received packet&n; *&n; * Checks if packet is valid: if its more than %IPX_MAX_PPROP_HOPS hops or if it&n; * is smaller than a IPX header + the room for %IPX_MAX_PPROP_HOPS hops we drop&n; * it, not even processing it locally, if it has exact %IPX_MAX_PPROP_HOPS we&n; * don&squot;t broadcast it, but process it locally. See chapter 5 of Novell&squot;s &quot;IPX&n; * RIP and SAP Router Specification&quot;, Part Number 107-000029-001.&n; * &n; * If it is valid, check if we have pprop broadcasting enabled by the user,&n; * if not, just return zero for local processing.&n; *&n; * If it is enabled check the packet and don&squot;t broadcast it if we have already&n; * seen this packet.&n; *&n; * Broadcast: send it to the interfaces that aren&squot;t on the packet visited nets&n; * array, just after the IPX header.&n; *&n; * Returns -EINVAL for invalid packets, so that the calling function drops&n; * the packet without local processing. 0 if packet is to be locally processed.&n; */
DECL|function|ipxitf_pprop
r_static
r_int
id|ipxitf_pprop
c_func
(paren
r_struct
id|ipx_interface
op_star
id|intrfc
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|ipxhdr
op_star
id|ipx
op_assign
id|ipx_hdr
c_func
(paren
id|skb
)paren
suffix:semicolon
r_int
id|i
comma
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_struct
id|ipx_interface
op_star
id|ifcs
suffix:semicolon
r_char
op_star
id|c
suffix:semicolon
id|u32
op_star
id|l
suffix:semicolon
multiline_comment|/* Illegal packet - too many hops or too short */
multiline_comment|/* We decide to throw it away: no broadcasting, no local processing.&n;&t; * NetBIOS unaware implementations route them as normal packets -&n;&t; * tctrl &lt;= 15, any data payload... */
r_if
c_cond
(paren
id|IPX_SKB_CB
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|ipx_tctrl
OG
id|IPX_MAX_PPROP_HOPS
op_logical_or
id|ntohs
c_func
(paren
id|ipx-&gt;ipx_pktsize
)paren
OL
r_sizeof
(paren
r_struct
id|ipxhdr
)paren
op_plus
id|IPX_MAX_PPROP_HOPS
op_star
r_sizeof
(paren
id|u32
)paren
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* are we broadcasting this damn thing? */
id|ret
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sysctl_ipx_pprop_broadcasting
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* We do broadcast packet on the IPX_MAX_PPROP_HOPS hop, but we&n;&t; * process it locally. All previous hops broadcasted it, and process it&n;&t; * locally. */
r_if
c_cond
(paren
id|IPX_SKB_CB
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|ipx_tctrl
op_eq
id|IPX_MAX_PPROP_HOPS
)paren
r_goto
id|out
suffix:semicolon
id|c
op_assign
(paren
(paren
id|u8
op_star
)paren
id|ipx
)paren
op_plus
r_sizeof
(paren
r_struct
id|ipxhdr
)paren
suffix:semicolon
id|l
op_assign
(paren
id|u32
op_star
)paren
id|c
suffix:semicolon
multiline_comment|/* Don&squot;t broadcast packet if already seen this net */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|IPX_SKB_CB
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|ipx_tctrl
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
op_star
id|l
op_increment
op_eq
id|intrfc-&gt;if_netnum
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* &lt; IPX_MAX_PPROP_HOPS hops &amp;&amp; input interface not in list. Save the&n;&t; * position where we will insert recvd netnum into list, later on,&n;&t; * in ipxitf_send */
id|IPX_SKB_CB
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|last_hop.index
op_assign
id|i
suffix:semicolon
id|IPX_SKB_CB
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|last_hop.netnum
op_assign
id|intrfc-&gt;if_netnum
suffix:semicolon
multiline_comment|/* xmit on all other interfaces... */
id|spin_lock_bh
c_func
(paren
op_amp
id|ipx_interfaces_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|ifcs
op_assign
id|ipx_interfaces
suffix:semicolon
id|ifcs
suffix:semicolon
id|ifcs
op_assign
id|ifcs-&gt;if_next
)paren
(brace
multiline_comment|/* Except unconfigured interfaces */
r_if
c_cond
(paren
op_logical_neg
id|ifcs-&gt;if_netnum
)paren
r_continue
suffix:semicolon
multiline_comment|/* That aren&squot;t in the list */
r_if
c_cond
(paren
id|ifcs
op_eq
id|intrfc
)paren
r_continue
suffix:semicolon
id|l
op_assign
(paren
id|__u32
op_star
)paren
id|c
suffix:semicolon
multiline_comment|/* don&squot;t consider the last entry in the packet list,&n;&t;&t; * it is our netnum, and it is not there yet */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|IPX_SKB_CB
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|ipx_tctrl
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|ifcs-&gt;if_netnum
op_eq
op_star
id|l
op_increment
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|i
op_eq
id|IPX_SKB_CB
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|ipx_tctrl
)paren
(brace
r_struct
id|sk_buff
op_star
id|s
op_assign
id|skb_copy
c_func
(paren
id|skb
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
)paren
(brace
id|IPX_SKB_CB
c_func
(paren
id|s
)paren
op_member_access_from_pointer
id|ipx_dest_net
op_assign
id|ifcs-&gt;if_netnum
suffix:semicolon
id|ipxrtr_route_skb
c_func
(paren
id|s
)paren
suffix:semicolon
)brace
)brace
)brace
id|spin_unlock_bh
c_func
(paren
op_amp
id|ipx_interfaces_lock
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|ipxitf_insert
r_static
r_void
id|ipxitf_insert
c_func
(paren
r_struct
id|ipx_interface
op_star
id|intrfc
)paren
(brace
id|intrfc-&gt;if_next
op_assign
l_int|NULL
suffix:semicolon
id|spin_lock_bh
c_func
(paren
op_amp
id|ipx_interfaces_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ipx_interfaces
)paren
id|ipx_interfaces
op_assign
id|intrfc
suffix:semicolon
r_else
(brace
r_struct
id|ipx_interface
op_star
id|i
op_assign
id|ipx_interfaces
suffix:semicolon
r_while
c_loop
(paren
id|i-&gt;if_next
)paren
id|i
op_assign
id|i-&gt;if_next
suffix:semicolon
id|i-&gt;if_next
op_assign
id|intrfc
suffix:semicolon
)brace
id|spin_unlock_bh
c_func
(paren
op_amp
id|ipx_interfaces_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ipxcfg_auto_select_primary
op_logical_and
op_logical_neg
id|ipx_primary_net
)paren
id|ipx_primary_net
op_assign
id|intrfc
suffix:semicolon
)brace
DECL|function|ipxitf_alloc
r_static
r_struct
id|ipx_interface
op_star
id|ipxitf_alloc
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
id|__u32
id|netnum
comma
r_int
r_int
id|dlink_type
comma
r_struct
id|datalink_proto
op_star
id|dlink
comma
r_int
r_char
id|internal
comma
r_int
id|ipx_offset
)paren
(brace
r_struct
id|ipx_interface
op_star
id|intrfc
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|intrfc
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|intrfc
)paren
(brace
id|intrfc-&gt;if_dev
op_assign
id|dev
suffix:semicolon
id|intrfc-&gt;if_netnum
op_assign
id|netnum
suffix:semicolon
id|intrfc-&gt;if_dlink_type
op_assign
id|dlink_type
suffix:semicolon
id|intrfc-&gt;if_dlink
op_assign
id|dlink
suffix:semicolon
id|intrfc-&gt;if_internal
op_assign
id|internal
suffix:semicolon
id|intrfc-&gt;if_ipx_offset
op_assign
id|ipx_offset
suffix:semicolon
id|intrfc-&gt;if_sknum
op_assign
id|IPX_MIN_EPHEMERAL_SOCKET
suffix:semicolon
id|intrfc-&gt;if_sklist
op_assign
l_int|NULL
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|intrfc-&gt;refcnt
comma
l_int|1
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|intrfc-&gt;if_sklist_lock
)paren
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
)brace
r_return
id|intrfc
suffix:semicolon
)brace
DECL|function|ipxitf_create_internal
r_static
r_int
id|ipxitf_create_internal
c_func
(paren
r_struct
id|ipx_interface_definition
op_star
id|idef
)paren
(brace
r_struct
id|ipx_interface
op_star
id|intrfc
suffix:semicolon
r_int
id|ret
op_assign
op_minus
id|EEXIST
suffix:semicolon
multiline_comment|/* Only one primary network allowed */
r_if
c_cond
(paren
id|ipx_primary_net
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* Must have a valid network number */
id|ret
op_assign
op_minus
id|EADDRNOTAVAIL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|idef-&gt;ipx_network
)paren
r_goto
id|out
suffix:semicolon
id|intrfc
op_assign
id|ipxitf_find_using_net
c_func
(paren
id|idef-&gt;ipx_network
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|EADDRINUSE
suffix:semicolon
r_if
c_cond
(paren
id|intrfc
)paren
(brace
id|ipxitf_put
c_func
(paren
id|intrfc
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|intrfc
op_assign
id|ipxitf_alloc
c_func
(paren
l_int|NULL
comma
id|idef-&gt;ipx_network
comma
l_int|0
comma
l_int|NULL
comma
l_int|1
comma
l_int|0
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|EAGAIN
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|intrfc
)paren
r_goto
id|out
suffix:semicolon
id|memcpy
c_func
(paren
(paren
r_char
op_star
)paren
op_amp
(paren
id|intrfc-&gt;if_node
)paren
comma
id|idef-&gt;ipx_node
comma
id|IPX_NODE_LEN
)paren
suffix:semicolon
id|ipx_internal_net
op_assign
id|ipx_primary_net
op_assign
id|intrfc
suffix:semicolon
id|ipxitf_hold
c_func
(paren
id|intrfc
)paren
suffix:semicolon
id|ipxitf_insert
c_func
(paren
id|intrfc
)paren
suffix:semicolon
id|ret
op_assign
id|ipxitf_add_local_route
c_func
(paren
id|intrfc
)paren
suffix:semicolon
id|ipxitf_put
c_func
(paren
id|intrfc
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|ipx_map_frame_type
r_static
r_int
id|ipx_map_frame_type
c_func
(paren
r_int
r_char
id|type
)paren
(brace
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|type
)paren
(brace
r_case
id|IPX_FRAME_ETHERII
suffix:colon
id|ret
op_assign
id|htons
c_func
(paren
id|ETH_P_IPX
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPX_FRAME_8022
suffix:colon
id|ret
op_assign
id|htons
c_func
(paren
id|ETH_P_802_2
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPX_FRAME_SNAP
suffix:colon
id|ret
op_assign
id|htons
c_func
(paren
id|ETH_P_SNAP
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPX_FRAME_8023
suffix:colon
id|ret
op_assign
id|htons
c_func
(paren
id|ETH_P_802_3
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|function|ipxitf_create
r_static
r_int
id|ipxitf_create
c_func
(paren
r_struct
id|ipx_interface_definition
op_star
id|idef
)paren
(brace
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_int
r_int
id|dlink_type
op_assign
l_int|0
suffix:semicolon
r_struct
id|datalink_proto
op_star
id|datalink
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|ipx_interface
op_star
id|intrfc
suffix:semicolon
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
id|idef-&gt;ipx_special
op_eq
id|IPX_INTERNAL
)paren
(brace
id|err
op_assign
id|ipxitf_create_internal
c_func
(paren
id|idef
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|err
op_assign
op_minus
id|EEXIST
suffix:semicolon
r_if
c_cond
(paren
id|idef-&gt;ipx_special
op_eq
id|IPX_PRIMARY
op_logical_and
id|ipx_primary_net
)paren
r_goto
id|out
suffix:semicolon
id|intrfc
op_assign
id|ipxitf_find_using_net
c_func
(paren
id|idef-&gt;ipx_network
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EADDRINUSE
suffix:semicolon
r_if
c_cond
(paren
id|idef-&gt;ipx_network
op_logical_and
id|intrfc
)paren
(brace
id|ipxitf_put
c_func
(paren
id|intrfc
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|intrfc
)paren
id|ipxitf_put
c_func
(paren
id|intrfc
)paren
suffix:semicolon
id|dev
op_assign
id|dev_get_by_name
c_func
(paren
id|idef-&gt;ipx_device
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_goto
id|out
suffix:semicolon
r_switch
c_cond
(paren
id|idef-&gt;ipx_dlink_type
)paren
(brace
r_case
id|IPX_FRAME_TR_8022
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;IPX frame type 802.2TR is &quot;
l_string|&quot;obsolete Use 802.2 instead.&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* fall through */
r_case
id|IPX_FRAME_8022
suffix:colon
id|dlink_type
op_assign
id|htons
c_func
(paren
id|ETH_P_802_2
)paren
suffix:semicolon
id|datalink
op_assign
id|p8022_datalink
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPX_FRAME_ETHERII
suffix:colon
r_if
c_cond
(paren
id|dev-&gt;type
op_ne
id|ARPHRD_IEEE802
)paren
(brace
id|dlink_type
op_assign
id|htons
c_func
(paren
id|ETH_P_IPX
)paren
suffix:semicolon
id|datalink
op_assign
id|pEII_datalink
suffix:semicolon
r_break
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;IPX frame type EtherII &quot;
l_string|&quot;over token-ring is obsolete. Use SNAP &quot;
l_string|&quot;instead.&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* fall through */
r_case
id|IPX_FRAME_SNAP
suffix:colon
id|dlink_type
op_assign
id|htons
c_func
(paren
id|ETH_P_SNAP
)paren
suffix:semicolon
id|datalink
op_assign
id|pSNAP_datalink
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPX_FRAME_8023
suffix:colon
id|dlink_type
op_assign
id|htons
c_func
(paren
id|ETH_P_802_3
)paren
suffix:semicolon
id|datalink
op_assign
id|p8023_datalink
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IPX_FRAME_NONE
suffix:colon
r_default
suffix:colon
id|err
op_assign
op_minus
id|EPROTONOSUPPORT
suffix:semicolon
r_goto
id|out_dev
suffix:semicolon
)brace
id|err
op_assign
op_minus
id|ENETDOWN
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|dev-&gt;flags
op_amp
id|IFF_UP
)paren
)paren
r_goto
id|out_dev
suffix:semicolon
multiline_comment|/* Check addresses are suitable */
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|dev-&gt;addr_len
OG
id|IPX_NODE_LEN
)paren
r_goto
id|out_dev
suffix:semicolon
id|intrfc
op_assign
id|ipxitf_find_using_phys
c_func
(paren
id|dev
comma
id|dlink_type
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|intrfc
)paren
(brace
multiline_comment|/* Ok now create */
id|intrfc
op_assign
id|ipxitf_alloc
c_func
(paren
id|dev
comma
id|idef-&gt;ipx_network
comma
id|dlink_type
comma
id|datalink
comma
l_int|0
comma
id|dev-&gt;hard_header_len
op_plus
id|datalink-&gt;header_length
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EAGAIN
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|intrfc
)paren
r_goto
id|out_dev
suffix:semicolon
multiline_comment|/* Setup primary if necessary */
r_if
c_cond
(paren
id|idef-&gt;ipx_special
op_eq
id|IPX_PRIMARY
)paren
id|ipx_primary_net
op_assign
id|intrfc
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|memcmp
c_func
(paren
id|idef-&gt;ipx_node
comma
l_string|&quot;&bslash;000&bslash;000&bslash;000&bslash;000&bslash;000&bslash;000&quot;
comma
id|IPX_NODE_LEN
)paren
)paren
(brace
id|memset
c_func
(paren
id|intrfc-&gt;if_node
comma
l_int|0
comma
id|IPX_NODE_LEN
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|intrfc-&gt;if_node
op_plus
id|IPX_NODE_LEN
op_minus
id|dev-&gt;addr_len
comma
id|dev-&gt;dev_addr
comma
id|dev-&gt;addr_len
)paren
suffix:semicolon
)brace
r_else
id|memcpy
c_func
(paren
id|intrfc-&gt;if_node
comma
id|idef-&gt;ipx_node
comma
id|IPX_NODE_LEN
)paren
suffix:semicolon
id|ipxitf_hold
c_func
(paren
id|intrfc
)paren
suffix:semicolon
id|ipxitf_insert
c_func
(paren
id|intrfc
)paren
suffix:semicolon
)brace
multiline_comment|/* If the network number is known, add a route */
id|err
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|intrfc-&gt;if_netnum
)paren
r_goto
id|out_intrfc
suffix:semicolon
id|err
op_assign
id|ipxitf_add_local_route
c_func
(paren
id|intrfc
)paren
suffix:semicolon
id|out_intrfc
suffix:colon
id|ipxitf_put
c_func
(paren
id|intrfc
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
id|out_dev
suffix:colon
id|dev_put
c_func
(paren
id|dev
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|err
suffix:semicolon
)brace
DECL|function|ipxitf_delete
r_static
r_int
id|ipxitf_delete
c_func
(paren
r_struct
id|ipx_interface_definition
op_star
id|idef
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
l_int|NULL
suffix:semicolon
r_int
r_int
id|dlink_type
op_assign
l_int|0
suffix:semicolon
r_struct
id|ipx_interface
op_star
id|intrfc
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
id|spin_lock_bh
c_func
(paren
op_amp
id|ipx_interfaces_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|idef-&gt;ipx_special
op_eq
id|IPX_INTERNAL
)paren
(brace
r_if
c_cond
(paren
id|ipx_internal_net
)paren
(brace
id|__ipxitf_put
c_func
(paren
id|ipx_internal_net
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|ret
op_assign
op_minus
id|ENOENT
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|dlink_type
op_assign
id|ipx_map_frame_type
c_func
(paren
id|idef-&gt;ipx_dlink_type
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|EPROTONOSUPPORT
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dlink_type
)paren
r_goto
id|out
suffix:semicolon
id|dev
op_assign
id|__dev_get_by_name
c_func
(paren
id|idef-&gt;ipx_device
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_goto
id|out
suffix:semicolon
id|intrfc
op_assign
id|__ipxitf_find_using_phys
c_func
(paren
id|dev
comma
id|dlink_type
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|intrfc
)paren
r_goto
id|out
suffix:semicolon
id|__ipxitf_put
c_func
(paren
id|intrfc
)paren
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
id|out
suffix:colon
id|spin_unlock_bh
c_func
(paren
op_amp
id|ipx_interfaces_lock
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|ipxitf_auto_create
r_static
r_struct
id|ipx_interface
op_star
id|ipxitf_auto_create
c_func
(paren
r_struct
id|net_device
op_star
id|dev
comma
r_int
r_int
id|dlink_type
)paren
(brace
r_struct
id|ipx_interface
op_star
id|intrfc
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|datalink_proto
op_star
id|datalink
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* Check addresses are suitable */
r_if
c_cond
(paren
id|dev-&gt;addr_len
OG
id|IPX_NODE_LEN
)paren
r_goto
id|out
suffix:semicolon
r_switch
c_cond
(paren
id|htons
c_func
(paren
id|dlink_type
)paren
)paren
(brace
r_case
id|ETH_P_IPX
suffix:colon
id|datalink
op_assign
id|pEII_datalink
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ETH_P_802_2
suffix:colon
id|datalink
op_assign
id|p8022_datalink
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ETH_P_SNAP
suffix:colon
id|datalink
op_assign
id|pSNAP_datalink
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ETH_P_802_3
suffix:colon
id|datalink
op_assign
id|p8023_datalink
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_goto
id|out
suffix:semicolon
)brace
id|intrfc
op_assign
id|ipxitf_alloc
c_func
(paren
id|dev
comma
l_int|0
comma
id|dlink_type
comma
id|datalink
comma
l_int|0
comma
id|dev-&gt;hard_header_len
op_plus
id|datalink-&gt;header_length
)paren
suffix:semicolon
r_if
c_cond
(paren
id|intrfc
)paren
(brace
id|memset
c_func
(paren
id|intrfc-&gt;if_node
comma
l_int|0
comma
id|IPX_NODE_LEN
)paren
suffix:semicolon
id|memcpy
c_func
(paren
(paren
r_char
op_star
)paren
op_amp
(paren
id|intrfc-&gt;if_node
(braket
id|IPX_NODE_LEN
op_minus
id|dev-&gt;addr_len
)braket
)paren
comma
id|dev-&gt;dev_addr
comma
id|dev-&gt;addr_len
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|intrfc-&gt;if_sklist_lock
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|intrfc-&gt;refcnt
comma
l_int|1
)paren
suffix:semicolon
id|ipxitf_insert
c_func
(paren
id|intrfc
)paren
suffix:semicolon
id|dev_hold
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
id|out
suffix:colon
r_return
id|intrfc
suffix:semicolon
)brace
DECL|function|ipxitf_ioctl
r_static
r_int
id|ipxitf_ioctl
c_func
(paren
r_int
r_int
id|cmd
comma
r_void
op_star
id|arg
)paren
(brace
r_struct
id|ifreq
id|ifr
suffix:semicolon
r_int
id|val
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SIOCSIFADDR
suffix:colon
(brace
r_struct
id|sockaddr_ipx
op_star
id|sipx
suffix:semicolon
r_struct
id|ipx_interface_definition
id|f
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|ifr
comma
id|arg
comma
r_sizeof
(paren
id|ifr
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|sipx
op_assign
(paren
r_struct
id|sockaddr_ipx
op_star
)paren
op_amp
id|ifr.ifr_addr
suffix:semicolon
r_if
c_cond
(paren
id|sipx-&gt;sipx_family
op_ne
id|AF_IPX
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|f.ipx_network
op_assign
id|sipx-&gt;sipx_network
suffix:semicolon
id|memcpy
c_func
(paren
id|f.ipx_device
comma
id|ifr.ifr_name
comma
r_sizeof
(paren
id|f.ipx_device
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|f.ipx_node
comma
id|sipx-&gt;sipx_node
comma
id|IPX_NODE_LEN
)paren
suffix:semicolon
id|f.ipx_dlink_type
op_assign
id|sipx-&gt;sipx_type
suffix:semicolon
id|f.ipx_special
op_assign
id|sipx-&gt;sipx_special
suffix:semicolon
r_if
c_cond
(paren
id|sipx-&gt;sipx_action
op_eq
id|IPX_DLTITF
)paren
r_return
id|ipxitf_delete
c_func
(paren
op_amp
id|f
)paren
suffix:semicolon
r_else
r_return
id|ipxitf_create
c_func
(paren
op_amp
id|f
)paren
suffix:semicolon
)brace
r_case
id|SIOCGIFADDR
suffix:colon
(brace
r_int
id|err
op_assign
l_int|0
suffix:semicolon
r_struct
id|sockaddr_ipx
op_star
id|sipx
suffix:semicolon
r_struct
id|ipx_interface
op_star
id|ipxif
suffix:semicolon
r_struct
id|net_device
op_star
id|dev
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|ifr
comma
id|arg
comma
r_sizeof
(paren
id|ifr
)paren
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|sipx
op_assign
(paren
r_struct
id|sockaddr_ipx
op_star
)paren
op_amp
id|ifr.ifr_addr
suffix:semicolon
id|dev
op_assign
id|__dev_get_by_name
c_func
(paren
id|ifr.ifr_name
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dev
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|ipxif
op_assign
id|ipxitf_find_using_phys
c_func
(paren
id|dev
comma
id|ipx_map_frame_type
c_func
(paren
id|sipx-&gt;sipx_type
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ipxif
)paren
r_return
op_minus
id|EADDRNOTAVAIL
suffix:semicolon
id|sipx-&gt;sipx_family
op_assign
id|AF_IPX
suffix:semicolon
id|sipx-&gt;sipx_network
op_assign
id|ipxif-&gt;if_netnum
suffix:semicolon
id|memcpy
c_func
(paren
id|sipx-&gt;sipx_node
comma
id|ipxif-&gt;if_node
comma
r_sizeof
(paren
id|sipx-&gt;sipx_node
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|arg
comma
op_amp
id|ifr
comma
r_sizeof
(paren
id|ifr
)paren
)paren
)paren
id|err
op_assign
op_minus
id|EFAULT
suffix:semicolon
id|ipxitf_put
c_func
(paren
id|ipxif
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
r_case
id|SIOCAIPXITFCRT
suffix:colon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|val
comma
(paren
r_int
r_char
op_star
)paren
id|arg
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|ipxcfg_set_auto_create
c_func
(paren
id|val
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SIOCAIPXPRISLT
suffix:colon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|val
comma
(paren
r_int
r_char
op_star
)paren
id|arg
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
id|ipxcfg_set_auto_select
c_func
(paren
id|val
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Routing tables for the IPX socket layer. */
DECL|function|ipxrtr_hold
r_static
id|__inline__
r_void
id|ipxrtr_hold
c_func
(paren
r_struct
id|ipx_route
op_star
id|rt
)paren
(brace
id|atomic_inc
c_func
(paren
op_amp
id|rt-&gt;refcnt
)paren
suffix:semicolon
)brace
DECL|function|ipxrtr_put
r_static
id|__inline__
r_void
id|ipxrtr_put
c_func
(paren
r_struct
id|ipx_route
op_star
id|rt
)paren
(brace
r_if
c_cond
(paren
id|atomic_dec_and_test
c_func
(paren
op_amp
id|rt-&gt;refcnt
)paren
)paren
id|kfree
c_func
(paren
id|rt
)paren
suffix:semicolon
)brace
DECL|function|ipxrtr_lookup
r_static
r_struct
id|ipx_route
op_star
id|ipxrtr_lookup
c_func
(paren
id|__u32
id|net
)paren
(brace
r_struct
id|ipx_route
op_star
id|r
suffix:semicolon
id|read_lock_bh
c_func
(paren
op_amp
id|ipx_routes_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|r
op_assign
id|ipx_routes
suffix:semicolon
id|r
op_logical_and
id|r-&gt;ir_net
op_ne
id|net
suffix:semicolon
id|r
op_assign
id|r-&gt;ir_next
)paren
suffix:semicolon
r_if
c_cond
(paren
id|r
)paren
id|ipxrtr_hold
c_func
(paren
id|r
)paren
suffix:semicolon
id|read_unlock_bh
c_func
(paren
op_amp
id|ipx_routes_lock
)paren
suffix:semicolon
r_return
id|r
suffix:semicolon
)brace
multiline_comment|/* caller must hold a reference to intrfc */
DECL|function|ipxrtr_add_route
r_static
r_int
id|ipxrtr_add_route
c_func
(paren
id|__u32
id|network
comma
r_struct
id|ipx_interface
op_star
id|intrfc
comma
r_int
r_char
op_star
id|node
)paren
(brace
r_struct
id|ipx_route
op_star
id|rt
suffix:semicolon
r_int
id|ret
suffix:semicolon
multiline_comment|/* Get a route structure; either existing or create */
id|rt
op_assign
id|ipxrtr_lookup
c_func
(paren
id|network
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rt
)paren
(brace
id|rt
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|rt
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|EAGAIN
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rt
)paren
r_goto
id|out
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|rt-&gt;refcnt
comma
l_int|1
)paren
suffix:semicolon
id|ipxrtr_hold
c_func
(paren
id|rt
)paren
suffix:semicolon
id|write_lock_bh
c_func
(paren
op_amp
id|ipx_routes_lock
)paren
suffix:semicolon
id|rt-&gt;ir_next
op_assign
id|ipx_routes
suffix:semicolon
id|ipx_routes
op_assign
id|rt
suffix:semicolon
id|write_unlock_bh
c_func
(paren
op_amp
id|ipx_routes_lock
)paren
suffix:semicolon
)brace
r_else
(brace
id|ret
op_assign
op_minus
id|EEXIST
suffix:semicolon
r_if
c_cond
(paren
id|intrfc
op_eq
id|ipx_internal_net
)paren
r_goto
id|out_put
suffix:semicolon
)brace
id|rt-&gt;ir_net
op_assign
id|network
suffix:semicolon
id|rt-&gt;ir_intrfc
op_assign
id|intrfc
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|node
)paren
(brace
id|memset
c_func
(paren
id|rt-&gt;ir_router_node
comma
l_char|&squot;&bslash;0&squot;
comma
id|IPX_NODE_LEN
)paren
suffix:semicolon
id|rt-&gt;ir_routed
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|memcpy
c_func
(paren
id|rt-&gt;ir_router_node
comma
id|node
comma
id|IPX_NODE_LEN
)paren
suffix:semicolon
id|rt-&gt;ir_routed
op_assign
l_int|1
suffix:semicolon
)brace
id|ret
op_assign
l_int|0
suffix:semicolon
id|out_put
suffix:colon
id|ipxrtr_put
c_func
(paren
id|rt
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|ipxrtr_del_routes
r_static
r_void
id|ipxrtr_del_routes
c_func
(paren
r_struct
id|ipx_interface
op_star
id|intrfc
)paren
(brace
r_struct
id|ipx_route
op_star
op_star
id|r
comma
op_star
id|tmp
suffix:semicolon
id|write_lock_bh
c_func
(paren
op_amp
id|ipx_routes_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|r
op_assign
op_amp
id|ipx_routes
suffix:semicolon
(paren
id|tmp
op_assign
op_star
id|r
)paren
op_ne
l_int|NULL
suffix:semicolon
)paren
(brace
r_if
c_cond
(paren
id|tmp-&gt;ir_intrfc
op_eq
id|intrfc
)paren
(brace
op_star
id|r
op_assign
id|tmp-&gt;ir_next
suffix:semicolon
id|ipxrtr_put
c_func
(paren
id|tmp
)paren
suffix:semicolon
)brace
r_else
id|r
op_assign
op_amp
(paren
id|tmp-&gt;ir_next
)paren
suffix:semicolon
)brace
id|write_unlock_bh
c_func
(paren
op_amp
id|ipx_routes_lock
)paren
suffix:semicolon
)brace
DECL|function|ipxrtr_create
r_static
r_int
id|ipxrtr_create
c_func
(paren
r_struct
id|ipx_route_definition
op_star
id|rd
)paren
(brace
r_struct
id|ipx_interface
op_star
id|intrfc
suffix:semicolon
r_int
id|ret
op_assign
op_minus
id|ENETUNREACH
suffix:semicolon
multiline_comment|/* Find the appropriate interface */
id|intrfc
op_assign
id|ipxitf_find_using_net
c_func
(paren
id|rd-&gt;ipx_router_network
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|intrfc
)paren
r_goto
id|out
suffix:semicolon
id|ret
op_assign
id|ipxrtr_add_route
c_func
(paren
id|rd-&gt;ipx_network
comma
id|intrfc
comma
id|rd-&gt;ipx_router_node
)paren
suffix:semicolon
id|ipxitf_put
c_func
(paren
id|intrfc
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|ipxrtr_delete
r_static
r_int
id|ipxrtr_delete
c_func
(paren
r_int
id|net
)paren
(brace
r_struct
id|ipx_route
op_star
op_star
id|r
suffix:semicolon
r_struct
id|ipx_route
op_star
id|tmp
suffix:semicolon
r_int
id|err
suffix:semicolon
id|write_lock_bh
c_func
(paren
op_amp
id|ipx_routes_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|r
op_assign
op_amp
id|ipx_routes
suffix:semicolon
(paren
id|tmp
op_assign
op_star
id|r
)paren
op_ne
l_int|NULL
suffix:semicolon
)paren
(brace
r_if
c_cond
(paren
id|tmp-&gt;ir_net
op_eq
id|net
)paren
(brace
multiline_comment|/* Directly connected; can&squot;t lose route */
id|err
op_assign
op_minus
id|EPERM
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tmp-&gt;ir_routed
)paren
r_goto
id|out
suffix:semicolon
op_star
id|r
op_assign
id|tmp-&gt;ir_next
suffix:semicolon
id|ipxrtr_put
c_func
(paren
id|tmp
)paren
suffix:semicolon
id|err
op_assign
l_int|0
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|r
op_assign
op_amp
(paren
id|tmp-&gt;ir_next
)paren
suffix:semicolon
)brace
id|err
op_assign
op_minus
id|ENOENT
suffix:semicolon
id|out
suffix:colon
id|write_unlock_bh
c_func
(paren
op_amp
id|ipx_routes_lock
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Checksum routine for IPX&n; */
multiline_comment|/* Note: We assume ipx_tctrl==0 and htons(length)==ipx_pktsize */
multiline_comment|/* This functions should *not* mess with packet contents */
DECL|function|ipx_cksum
r_static
id|__u16
id|ipx_cksum
c_func
(paren
r_struct
id|ipxhdr
op_star
id|packet
comma
r_int
id|length
)paren
(brace
multiline_comment|/* &n;&t; *&t;NOTE: sum is a net byte order quantity, which optimizes the &n;&t; *&t;loop. This only works on big and little endian machines. (I&n;&t; *&t;don&squot;t know of a machine that isn&squot;t.)&n;&t; */
multiline_comment|/* start at ipx_dest - We skip the checksum field and start with&n;&t; * ipx_type before the loop, not considering ipx_tctrl in the calc */
id|__u16
op_star
id|p
op_assign
(paren
id|__u16
op_star
)paren
op_amp
id|packet-&gt;ipx_dest
suffix:semicolon
id|__u32
id|i
op_assign
(paren
id|length
op_rshift
l_int|1
)paren
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* Number of complete words */
id|__u32
id|sum
op_assign
id|packet-&gt;ipx_type
op_lshift
r_sizeof
(paren
id|packet-&gt;ipx_tctrl
)paren
suffix:semicolon
multiline_comment|/* Loop through all complete words except the checksum field,&n;&t; * ipx_type (accounted above) and ipx_tctrl (not used in the cksum) */
r_while
c_loop
(paren
op_decrement
id|i
)paren
id|sum
op_add_assign
op_star
id|p
op_increment
suffix:semicolon
multiline_comment|/* Add on the last part word if it exists */
r_if
c_cond
(paren
id|packet-&gt;ipx_pktsize
op_amp
id|htons
c_func
(paren
l_int|1
)paren
)paren
id|sum
op_add_assign
id|ntohs
c_func
(paren
l_int|0xff00
)paren
op_amp
op_star
id|p
suffix:semicolon
multiline_comment|/* Do final fixup */
id|sum
op_assign
(paren
id|sum
op_amp
l_int|0xffff
)paren
op_plus
(paren
id|sum
op_rshift
l_int|16
)paren
suffix:semicolon
multiline_comment|/* It&squot;s a pity there&squot;s no concept of carry in C */
r_if
c_cond
(paren
id|sum
op_ge
l_int|0x10000
)paren
id|sum
op_increment
suffix:semicolon
r_return
op_complement
id|sum
suffix:semicolon
)brace
multiline_comment|/*&n; * Route an outgoing frame from a socket.&n; */
DECL|function|ipxrtr_route_packet
r_static
r_int
id|ipxrtr_route_packet
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_struct
id|sockaddr_ipx
op_star
id|usipx
comma
r_struct
id|iovec
op_star
id|iov
comma
r_int
id|len
comma
r_int
id|noblock
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_struct
id|ipx_opt
op_star
id|ipxs
op_assign
id|ipx_sk
c_func
(paren
id|sk
)paren
suffix:semicolon
r_struct
id|ipx_interface
op_star
id|intrfc
suffix:semicolon
r_struct
id|ipxhdr
op_star
id|ipx
suffix:semicolon
r_int
id|size
suffix:semicolon
r_int
id|ipx_offset
suffix:semicolon
r_struct
id|ipx_route
op_star
id|rt
op_assign
l_int|NULL
suffix:semicolon
r_int
id|err
suffix:semicolon
multiline_comment|/* Find the appropriate interface on which to send packet */
r_if
c_cond
(paren
op_logical_neg
id|usipx-&gt;sipx_network
op_logical_and
id|ipx_primary_net
)paren
(brace
id|usipx-&gt;sipx_network
op_assign
id|ipx_primary_net-&gt;if_netnum
suffix:semicolon
id|intrfc
op_assign
id|ipx_primary_net
suffix:semicolon
)brace
r_else
(brace
id|rt
op_assign
id|ipxrtr_lookup
c_func
(paren
id|usipx-&gt;sipx_network
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|ENETUNREACH
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rt
)paren
r_goto
id|out
suffix:semicolon
id|intrfc
op_assign
id|rt-&gt;ir_intrfc
suffix:semicolon
)brace
id|ipxitf_hold
c_func
(paren
id|intrfc
)paren
suffix:semicolon
id|ipx_offset
op_assign
id|intrfc-&gt;if_ipx_offset
suffix:semicolon
id|size
op_assign
r_sizeof
(paren
r_struct
id|ipxhdr
)paren
op_plus
id|len
op_plus
id|ipx_offset
suffix:semicolon
id|skb
op_assign
id|sock_alloc_send_skb
c_func
(paren
id|sk
comma
id|size
comma
id|noblock
comma
op_amp
id|err
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
r_goto
id|out_put
suffix:semicolon
id|skb_reserve
c_func
(paren
id|skb
comma
id|ipx_offset
)paren
suffix:semicolon
id|skb-&gt;sk
op_assign
id|sk
suffix:semicolon
multiline_comment|/* Fill in IPX header */
id|skb-&gt;h.raw
op_assign
id|skb-&gt;nh.raw
op_assign
id|skb_put
c_func
(paren
id|skb
comma
r_sizeof
(paren
r_struct
id|ipxhdr
)paren
)paren
suffix:semicolon
id|ipx
op_assign
id|ipx_hdr
c_func
(paren
id|skb
)paren
suffix:semicolon
id|ipx-&gt;ipx_pktsize
op_assign
id|htons
c_func
(paren
id|len
op_plus
r_sizeof
(paren
r_struct
id|ipxhdr
)paren
)paren
suffix:semicolon
id|IPX_SKB_CB
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|ipx_tctrl
op_assign
l_int|0
suffix:semicolon
id|ipx-&gt;ipx_type
op_assign
id|usipx-&gt;sipx_type
suffix:semicolon
id|IPX_SKB_CB
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|last_hop.index
op_assign
op_minus
l_int|1
suffix:semicolon
macro_line|#ifdef CONFIG_IPX_INTERN
id|IPX_SKB_CB
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|ipx_source_net
op_assign
id|ipxs-&gt;intrfc-&gt;if_netnum
suffix:semicolon
id|memcpy
c_func
(paren
id|ipx-&gt;ipx_source.node
comma
id|ipxs-&gt;node
comma
id|IPX_NODE_LEN
)paren
suffix:semicolon
macro_line|#else
id|err
op_assign
id|ntohs
c_func
(paren
id|ipxs-&gt;port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_eq
l_int|0x453
op_logical_or
id|err
op_eq
l_int|0x452
)paren
(brace
multiline_comment|/* RIP/SAP special handling for mars_nwe */
id|IPX_SKB_CB
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|ipx_source_net
op_assign
id|intrfc-&gt;if_netnum
suffix:semicolon
id|memcpy
c_func
(paren
id|ipx-&gt;ipx_source.node
comma
id|intrfc-&gt;if_node
comma
id|IPX_NODE_LEN
)paren
suffix:semicolon
)brace
r_else
(brace
id|IPX_SKB_CB
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|ipx_source_net
op_assign
id|ipxs-&gt;intrfc-&gt;if_netnum
suffix:semicolon
id|memcpy
c_func
(paren
id|ipx-&gt;ipx_source.node
comma
id|ipxs-&gt;intrfc-&gt;if_node
comma
id|IPX_NODE_LEN
)paren
suffix:semicolon
)brace
macro_line|#endif&t;/* CONFIG_IPX_INTERN */
id|ipx-&gt;ipx_source.sock
op_assign
id|ipxs-&gt;port
suffix:semicolon
id|IPX_SKB_CB
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|ipx_dest_net
op_assign
id|usipx-&gt;sipx_network
suffix:semicolon
id|memcpy
c_func
(paren
id|ipx-&gt;ipx_dest.node
comma
id|usipx-&gt;sipx_node
comma
id|IPX_NODE_LEN
)paren
suffix:semicolon
id|ipx-&gt;ipx_dest.sock
op_assign
id|usipx-&gt;sipx_port
suffix:semicolon
id|err
op_assign
id|memcpy_fromiovec
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|len
)paren
comma
id|iov
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_goto
id|out_put
suffix:semicolon
)brace
multiline_comment|/* Apply checksum. Not allowed on 802.3 links. */
r_if
c_cond
(paren
id|sk-&gt;no_check
op_logical_or
id|intrfc-&gt;if_dlink_type
op_eq
id|IPX_FRAME_8023
)paren
id|ipx-&gt;ipx_checksum
op_assign
l_int|0xFFFF
suffix:semicolon
r_else
id|ipx-&gt;ipx_checksum
op_assign
id|ipx_cksum
c_func
(paren
id|ipx
comma
id|len
op_plus
r_sizeof
(paren
r_struct
id|ipxhdr
)paren
)paren
suffix:semicolon
id|err
op_assign
id|ipxitf_send
c_func
(paren
id|intrfc
comma
id|skb
comma
(paren
id|rt
op_logical_and
id|rt-&gt;ir_routed
)paren
ques
c_cond
id|rt-&gt;ir_router_node
suffix:colon
id|ipx-&gt;ipx_dest.node
)paren
suffix:semicolon
id|out_put
suffix:colon
id|ipxitf_put
c_func
(paren
id|intrfc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rt
)paren
id|ipxrtr_put
c_func
(paren
id|rt
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/* the skb has to be unshared, we&squot;ll end up calling ipxitf_send, that&squot;ll&n; * modify the packet */
DECL|function|ipxrtr_route_skb
r_int
id|ipxrtr_route_skb
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|ipxhdr
op_star
id|ipx
op_assign
id|ipx_hdr
c_func
(paren
id|skb
)paren
suffix:semicolon
r_struct
id|ipx_route
op_star
id|r
op_assign
id|ipxrtr_lookup
c_func
(paren
id|IPX_SKB_CB
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|ipx_dest_net
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|r
)paren
(brace
multiline_comment|/* no known route */
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|ipxitf_hold
c_func
(paren
id|r-&gt;ir_intrfc
)paren
suffix:semicolon
id|ipxitf_send
c_func
(paren
id|r-&gt;ir_intrfc
comma
id|skb
comma
id|r-&gt;ir_routed
ques
c_cond
id|r-&gt;ir_router_node
suffix:colon
id|ipx-&gt;ipx_dest.node
)paren
suffix:semicolon
id|ipxitf_put
c_func
(paren
id|r-&gt;ir_intrfc
)paren
suffix:semicolon
id|ipxrtr_put
c_func
(paren
id|r
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * We use a normal struct rtentry for route handling&n; */
DECL|function|ipxrtr_ioctl
r_static
r_int
id|ipxrtr_ioctl
c_func
(paren
r_int
r_int
id|cmd
comma
r_void
op_star
id|arg
)paren
(brace
r_struct
id|rtentry
id|rt
suffix:semicolon
multiline_comment|/* Use these to behave like &squot;other&squot; stacks */
r_struct
id|sockaddr_ipx
op_star
id|sg
comma
op_star
id|st
suffix:semicolon
r_int
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|rt
comma
id|arg
comma
r_sizeof
(paren
id|rt
)paren
)paren
)paren
r_goto
id|out
suffix:semicolon
id|sg
op_assign
(paren
r_struct
id|sockaddr_ipx
op_star
)paren
op_amp
id|rt.rt_gateway
suffix:semicolon
id|st
op_assign
(paren
r_struct
id|sockaddr_ipx
op_star
)paren
op_amp
id|rt.rt_dst
suffix:semicolon
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|rt.rt_flags
op_amp
id|RTF_GATEWAY
)paren
op_logical_or
multiline_comment|/* Direct routes are fixed */
id|sg-&gt;sipx_family
op_ne
id|AF_IPX
op_logical_or
id|st-&gt;sipx_family
op_ne
id|AF_IPX
)paren
r_goto
id|out
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SIOCDELRT
suffix:colon
id|ret
op_assign
id|ipxrtr_delete
c_func
(paren
id|st-&gt;sipx_network
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SIOCADDRT
suffix:colon
(brace
r_struct
id|ipx_route_definition
id|f
suffix:semicolon
id|f.ipx_network
op_assign
id|st-&gt;sipx_network
suffix:semicolon
id|f.ipx_router_network
op_assign
id|sg-&gt;sipx_network
suffix:semicolon
id|memcpy
c_func
(paren
id|f.ipx_router_node
comma
id|sg-&gt;sipx_node
comma
id|IPX_NODE_LEN
)paren
suffix:semicolon
id|ret
op_assign
id|ipxrtr_create
c_func
(paren
op_amp
id|f
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|out
suffix:colon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|ipx_frame_name
r_const
r_char
op_star
id|ipx_frame_name
c_func
(paren
r_int
r_int
id|frame
)paren
(brace
r_char
op_star
id|ret
op_assign
l_string|&quot;None&quot;
suffix:semicolon
r_switch
c_cond
(paren
id|ntohs
c_func
(paren
id|frame
)paren
)paren
(brace
r_case
id|ETH_P_IPX
suffix:colon
id|ret
op_assign
l_string|&quot;EtherII&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ETH_P_802_2
suffix:colon
id|ret
op_assign
l_string|&quot;802.2&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ETH_P_SNAP
suffix:colon
id|ret
op_assign
l_string|&quot;SNAP&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ETH_P_802_3
suffix:colon
id|ret
op_assign
l_string|&quot;802.3&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
id|ETH_P_TR_802_2
suffix:colon
id|ret
op_assign
l_string|&quot;802.2TR&quot;
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|function|ipx_device_name
r_const
r_char
op_star
id|ipx_device_name
c_func
(paren
r_struct
id|ipx_interface
op_star
id|intrfc
)paren
(brace
r_return
id|intrfc-&gt;if_internal
ques
c_cond
l_string|&quot;Internal&quot;
suffix:colon
id|intrfc-&gt;if_dev
ques
c_cond
id|intrfc-&gt;if_dev-&gt;name
suffix:colon
l_string|&quot;Unknown&quot;
suffix:semicolon
)brace
multiline_comment|/* Handling for system calls applied via the various interfaces to an IPX&n; * socket object. */
DECL|function|ipx_setsockopt
r_static
r_int
id|ipx_setsockopt
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_int
id|level
comma
r_int
id|optname
comma
r_char
op_star
id|optval
comma
r_int
id|optlen
)paren
(brace
r_struct
id|sock
op_star
id|sk
op_assign
id|sock-&gt;sk
suffix:semicolon
r_int
id|opt
suffix:semicolon
r_int
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|optlen
op_ne
r_sizeof
(paren
r_int
)paren
)paren
r_goto
id|out
suffix:semicolon
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|opt
comma
(paren
r_int
r_int
op_star
)paren
id|optval
)paren
)paren
r_goto
id|out
suffix:semicolon
id|ret
op_assign
op_minus
id|ENOPROTOOPT
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|level
op_eq
id|SOL_IPX
op_logical_and
id|optname
op_eq
id|IPX_TYPE
)paren
)paren
r_goto
id|out
suffix:semicolon
id|ipx_sk
c_func
(paren
id|sk
)paren
op_member_access_from_pointer
id|type
op_assign
id|opt
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
id|out
suffix:colon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|ipx_getsockopt
r_static
r_int
id|ipx_getsockopt
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_int
id|level
comma
r_int
id|optname
comma
r_char
op_star
id|optval
comma
r_int
op_star
id|optlen
)paren
(brace
r_struct
id|sock
op_star
id|sk
op_assign
id|sock-&gt;sk
suffix:semicolon
r_int
id|val
op_assign
l_int|0
suffix:semicolon
r_int
id|len
suffix:semicolon
r_int
id|ret
op_assign
op_minus
id|ENOPROTOOPT
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|level
op_eq
id|SOL_IPX
op_logical_and
id|optname
op_eq
id|IPX_TYPE
)paren
)paren
r_goto
id|out
suffix:semicolon
id|val
op_assign
id|ipx_sk
c_func
(paren
id|sk
)paren
op_member_access_from_pointer
id|type
suffix:semicolon
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|get_user
c_func
(paren
id|len
comma
id|optlen
)paren
)paren
r_goto
id|out
suffix:semicolon
id|len
op_assign
id|min_t
c_func
(paren
r_int
r_int
comma
id|len
comma
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
l_int|0
)paren
(brace
r_goto
id|out
suffix:semicolon
)brace
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|put_user
c_func
(paren
id|len
comma
id|optlen
)paren
op_logical_or
id|copy_to_user
c_func
(paren
id|optval
comma
op_amp
id|val
comma
id|len
)paren
)paren
r_goto
id|out
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
id|out
suffix:colon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|ipx_create
r_static
r_int
id|ipx_create
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_int
id|protocol
)paren
(brace
r_int
id|ret
op_assign
op_minus
id|ESOCKTNOSUPPORT
suffix:semicolon
r_struct
id|ipx_opt
op_star
id|ipx
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|sock
op_star
id|sk
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
r_switch
c_cond
(paren
id|sock-&gt;type
)paren
(brace
r_case
id|SOCK_DGRAM
suffix:colon
id|sk
op_assign
id|sk_alloc
c_func
(paren
id|PF_IPX
comma
id|GFP_KERNEL
comma
l_int|1
comma
l_int|NULL
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sk
)paren
r_goto
id|decmod
suffix:semicolon
id|ipx
op_assign
id|ipx_sk
c_func
(paren
id|sk
)paren
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|ipx
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ipx
)paren
r_goto
id|outsk
suffix:semicolon
id|memset
c_func
(paren
id|ipx
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|ipx
)paren
)paren
suffix:semicolon
id|sock-&gt;ops
op_assign
op_amp
id|ipx_dgram_ops
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SOCK_SEQPACKET
suffix:colon
multiline_comment|/*&n;&t;&t;&t; * SPX support is not anymore in the kernel sources. If&n;&t;&t;&t; * you want to ressurrect it, completing it and making&n;&t;&t;&t; * it understand shared skbs, be fully multithreaded,&n;&t;&t;&t; * etc, grab the sources in an early 2.5 kernel tree.&n;&t;&t;&t; */
r_case
id|SOCK_STREAM
suffix:colon
multiline_comment|/* Allow higher levels to piggyback */
r_default
suffix:colon
r_goto
id|decmod
suffix:semicolon
)brace
macro_line|#ifdef IPX_REFCNT_DEBUG
id|atomic_inc
c_func
(paren
op_amp
id|ipx_sock_nr
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;IPX socket %p created, now we have %d alive&bslash;n&quot;
comma
id|sk
comma
id|atomic_read
c_func
(paren
op_amp
id|ipx_sock_nr
)paren
)paren
suffix:semicolon
macro_line|#endif
id|sock_init_data
c_func
(paren
id|sock
comma
id|sk
)paren
suffix:semicolon
id|sk-&gt;no_check
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Checksum off by default */
id|ret
op_assign
l_int|0
suffix:semicolon
id|out
suffix:colon
r_return
id|ret
suffix:semicolon
id|outsk
suffix:colon
id|sk_free
c_func
(paren
id|sk
)paren
suffix:semicolon
id|decmod
suffix:colon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
DECL|function|ipx_release
r_static
r_int
id|ipx_release
c_func
(paren
r_struct
id|socket
op_star
id|sock
)paren
(brace
r_struct
id|sock
op_star
id|sk
op_assign
id|sock-&gt;sk
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sk
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sk-&gt;dead
)paren
id|sk
op_member_access_from_pointer
id|state_change
c_func
(paren
id|sk
)paren
suffix:semicolon
id|sk-&gt;dead
op_assign
l_int|1
suffix:semicolon
id|sock-&gt;sk
op_assign
l_int|NULL
suffix:semicolon
id|ipx_destroy_socket
c_func
(paren
id|sk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sock-&gt;type
op_eq
id|SOCK_DGRAM
)paren
id|MOD_DEC_USE_COUNT
suffix:semicolon
id|out
suffix:colon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* caller must hold a reference to intrfc */
DECL|function|ipx_first_free_socketnum
r_static
r_int
r_int
id|ipx_first_free_socketnum
c_func
(paren
r_struct
id|ipx_interface
op_star
id|intrfc
)paren
(brace
r_int
r_int
id|socketNum
op_assign
id|intrfc-&gt;if_sknum
suffix:semicolon
id|spin_lock_bh
c_func
(paren
op_amp
id|intrfc-&gt;if_sklist_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|socketNum
OL
id|IPX_MIN_EPHEMERAL_SOCKET
)paren
id|socketNum
op_assign
id|IPX_MIN_EPHEMERAL_SOCKET
suffix:semicolon
r_while
c_loop
(paren
id|__ipxitf_find_socket
c_func
(paren
id|intrfc
comma
id|ntohs
c_func
(paren
id|socketNum
)paren
)paren
)paren
r_if
c_cond
(paren
id|socketNum
OG
id|IPX_MAX_EPHEMERAL_SOCKET
)paren
id|socketNum
op_assign
id|IPX_MIN_EPHEMERAL_SOCKET
suffix:semicolon
r_else
id|socketNum
op_increment
suffix:semicolon
id|spin_unlock_bh
c_func
(paren
op_amp
id|intrfc-&gt;if_sklist_lock
)paren
suffix:semicolon
id|intrfc-&gt;if_sknum
op_assign
id|socketNum
suffix:semicolon
r_return
id|ntohs
c_func
(paren
id|socketNum
)paren
suffix:semicolon
)brace
DECL|function|ipx_bind
r_static
r_int
id|ipx_bind
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_struct
id|sockaddr
op_star
id|uaddr
comma
r_int
id|addr_len
)paren
(brace
r_struct
id|sock
op_star
id|sk
op_assign
id|sock-&gt;sk
suffix:semicolon
r_struct
id|ipx_opt
op_star
id|ipxs
op_assign
id|ipx_sk
c_func
(paren
id|sk
)paren
suffix:semicolon
r_struct
id|ipx_interface
op_star
id|intrfc
suffix:semicolon
r_struct
id|sockaddr_ipx
op_star
id|addr
op_assign
(paren
r_struct
id|sockaddr_ipx
op_star
)paren
id|uaddr
suffix:semicolon
r_int
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sk-&gt;zapped
op_logical_or
id|addr_len
op_ne
r_sizeof
(paren
r_struct
id|sockaddr_ipx
)paren
)paren
r_goto
id|out
suffix:semicolon
id|intrfc
op_assign
id|ipxitf_find_using_net
c_func
(paren
id|addr-&gt;sipx_network
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|EADDRNOTAVAIL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|intrfc
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|addr-&gt;sipx_port
)paren
(brace
id|addr-&gt;sipx_port
op_assign
id|ipx_first_free_socketnum
c_func
(paren
id|intrfc
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|addr-&gt;sipx_port
)paren
r_goto
id|out_put
suffix:semicolon
)brace
multiline_comment|/* protect IPX system stuff like routing/sap */
id|ret
op_assign
op_minus
id|EACCES
suffix:semicolon
r_if
c_cond
(paren
id|ntohs
c_func
(paren
id|addr-&gt;sipx_port
)paren
OL
id|IPX_MIN_EPHEMERAL_SOCKET
op_logical_and
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
r_goto
id|out_put
suffix:semicolon
id|ipxs-&gt;port
op_assign
id|addr-&gt;sipx_port
suffix:semicolon
macro_line|#ifdef CONFIG_IPX_INTERN
r_if
c_cond
(paren
id|intrfc
op_eq
id|ipx_internal_net
)paren
(brace
multiline_comment|/* The source address is to be set explicitly if the&n;&t;&t; * socket is to be bound on the internal network. If a&n;&t;&t; * node number 0 was specified, the default is used.&n;&t;&t; */
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|memcmp
c_func
(paren
id|addr-&gt;sipx_node
comma
id|ipx_broadcast_node
comma
id|IPX_NODE_LEN
)paren
)paren
r_goto
id|out_put
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|memcmp
c_func
(paren
id|addr-&gt;sipx_node
comma
id|ipx_this_node
comma
id|IPX_NODE_LEN
)paren
)paren
id|memcpy
c_func
(paren
id|ipxs-&gt;node
comma
id|intrfc-&gt;if_node
comma
id|IPX_NODE_LEN
)paren
suffix:semicolon
r_else
id|memcpy
c_func
(paren
id|ipxs-&gt;node
comma
id|addr-&gt;sipx_node
comma
id|IPX_NODE_LEN
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|EADDRINUSE
suffix:semicolon
r_if
c_cond
(paren
id|ipxitf_find_internal_socket
c_func
(paren
id|intrfc
comma
id|ipxs-&gt;node
comma
id|ipxs-&gt;port
)paren
)paren
(brace
id|SOCK_DEBUG
c_func
(paren
id|sk
comma
l_string|&quot;IPX: bind failed because port %X in use.&bslash;n&quot;
comma
id|ntohs
c_func
(paren
(paren
r_int
)paren
id|addr-&gt;sipx_port
)paren
)paren
suffix:semicolon
r_goto
id|out_put
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* Source addresses are easy. It must be our&n;&t;&t; * network:node pair for an interface routed to IPX&n;&t;&t; * with the ipx routing ioctl()&n;&t;&t; */
id|memcpy
c_func
(paren
id|ipxs-&gt;node
comma
id|intrfc-&gt;if_node
comma
id|IPX_NODE_LEN
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|EADDRINUSE
suffix:semicolon
r_if
c_cond
(paren
id|ipxitf_find_socket
c_func
(paren
id|intrfc
comma
id|addr-&gt;sipx_port
)paren
)paren
(brace
id|SOCK_DEBUG
c_func
(paren
id|sk
comma
l_string|&quot;IPX: bind failed because port %X in use.&bslash;n&quot;
comma
id|ntohs
c_func
(paren
(paren
r_int
)paren
id|addr-&gt;sipx_port
)paren
)paren
suffix:semicolon
r_goto
id|out_put
suffix:semicolon
)brace
)brace
macro_line|#else&t;/* !def CONFIG_IPX_INTERN */
multiline_comment|/* Source addresses are easy. It must be our network:node pair for&n;&t;   an interface routed to IPX with the ipx routing ioctl() */
id|ret
op_assign
op_minus
id|EADDRINUSE
suffix:semicolon
r_if
c_cond
(paren
id|ipxitf_find_socket
c_func
(paren
id|intrfc
comma
id|addr-&gt;sipx_port
)paren
)paren
(brace
id|SOCK_DEBUG
c_func
(paren
id|sk
comma
l_string|&quot;IPX: bind failed because port %X in use.&bslash;n&quot;
comma
id|ntohs
c_func
(paren
(paren
r_int
)paren
id|addr-&gt;sipx_port
)paren
)paren
suffix:semicolon
r_goto
id|out_put
suffix:semicolon
)brace
macro_line|#endif&t;/* CONFIG_IPX_INTERN */
id|ipxitf_insert_socket
c_func
(paren
id|intrfc
comma
id|sk
)paren
suffix:semicolon
id|sk-&gt;zapped
op_assign
l_int|0
suffix:semicolon
id|SOCK_DEBUG
c_func
(paren
id|sk
comma
l_string|&quot;IPX: bound socket 0x%04X.&bslash;n&quot;
comma
id|ntohs
c_func
(paren
id|addr-&gt;sipx_port
)paren
)paren
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
id|out_put
suffix:colon
id|ipxitf_put
c_func
(paren
id|intrfc
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|ipx_connect
r_static
r_int
id|ipx_connect
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_struct
id|sockaddr
op_star
id|uaddr
comma
r_int
id|addr_len
comma
r_int
id|flags
)paren
(brace
r_struct
id|sock
op_star
id|sk
op_assign
id|sock-&gt;sk
suffix:semicolon
r_struct
id|ipx_opt
op_star
id|ipxs
op_assign
id|ipx_sk
c_func
(paren
id|sk
)paren
suffix:semicolon
r_struct
id|sockaddr_ipx
op_star
id|addr
suffix:semicolon
r_int
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_struct
id|ipx_route
op_star
id|rt
suffix:semicolon
id|sk-&gt;state
op_assign
id|TCP_CLOSE
suffix:semicolon
id|sock-&gt;state
op_assign
id|SS_UNCONNECTED
suffix:semicolon
r_if
c_cond
(paren
id|addr_len
op_ne
r_sizeof
(paren
op_star
id|addr
)paren
)paren
r_goto
id|out
suffix:semicolon
id|addr
op_assign
(paren
r_struct
id|sockaddr_ipx
op_star
)paren
id|uaddr
suffix:semicolon
multiline_comment|/* put the autobinding in */
r_if
c_cond
(paren
op_logical_neg
id|ipxs-&gt;port
)paren
(brace
r_struct
id|sockaddr_ipx
id|uaddr
suffix:semicolon
id|uaddr.sipx_port
op_assign
l_int|0
suffix:semicolon
id|uaddr.sipx_network
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef CONFIG_IPX_INTERN
id|ret
op_assign
op_minus
id|ENETDOWN
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ipxs-&gt;intrfc
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* Someone zonked the iface */
id|memcpy
c_func
(paren
id|uaddr.sipx_node
comma
id|ipxs-&gt;intrfc-&gt;if_node
comma
id|IPX_NODE_LEN
)paren
suffix:semicolon
macro_line|#endif&t;/* CONFIG_IPX_INTERN */
id|ret
op_assign
id|ipx_bind
c_func
(paren
id|sock
comma
(paren
r_struct
id|sockaddr
op_star
)paren
op_amp
id|uaddr
comma
r_sizeof
(paren
r_struct
id|sockaddr_ipx
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* We can either connect to primary network or somewhere&n;&t; * we can route to */
id|rt
op_assign
id|ipxrtr_lookup
c_func
(paren
id|addr-&gt;sipx_network
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|ENETUNREACH
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rt
op_logical_and
op_logical_neg
(paren
op_logical_neg
id|addr-&gt;sipx_network
op_logical_and
id|ipx_primary_net
)paren
)paren
r_goto
id|out
suffix:semicolon
id|ipxs-&gt;dest_addr.net
op_assign
id|addr-&gt;sipx_network
suffix:semicolon
id|ipxs-&gt;dest_addr.sock
op_assign
id|addr-&gt;sipx_port
suffix:semicolon
id|memcpy
c_func
(paren
id|ipxs-&gt;dest_addr.node
comma
id|addr-&gt;sipx_node
comma
id|IPX_NODE_LEN
)paren
suffix:semicolon
id|ipxs-&gt;type
op_assign
id|addr-&gt;sipx_type
suffix:semicolon
r_if
c_cond
(paren
id|sock-&gt;type
op_eq
id|SOCK_DGRAM
)paren
(brace
id|sock-&gt;state
op_assign
id|SS_CONNECTED
suffix:semicolon
id|sk-&gt;state
op_assign
id|TCP_ESTABLISHED
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rt
)paren
id|ipxrtr_put
c_func
(paren
id|rt
)paren
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
id|out
suffix:colon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|ipx_getname
r_static
r_int
id|ipx_getname
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_struct
id|sockaddr
op_star
id|uaddr
comma
r_int
op_star
id|uaddr_len
comma
r_int
id|peer
)paren
(brace
r_struct
id|ipx_address
op_star
id|addr
suffix:semicolon
r_struct
id|sockaddr_ipx
id|sipx
suffix:semicolon
r_struct
id|sock
op_star
id|sk
op_assign
id|sock-&gt;sk
suffix:semicolon
r_struct
id|ipx_opt
op_star
id|ipxs
op_assign
id|ipx_sk
c_func
(paren
id|sk
)paren
suffix:semicolon
r_int
id|ret
suffix:semicolon
op_star
id|uaddr_len
op_assign
r_sizeof
(paren
r_struct
id|sockaddr_ipx
)paren
suffix:semicolon
r_if
c_cond
(paren
id|peer
)paren
(brace
id|ret
op_assign
op_minus
id|ENOTCONN
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;state
op_ne
id|TCP_ESTABLISHED
)paren
r_goto
id|out
suffix:semicolon
id|addr
op_assign
op_amp
id|ipxs-&gt;dest_addr
suffix:semicolon
id|sipx.sipx_network
op_assign
id|addr-&gt;net
suffix:semicolon
id|sipx.sipx_port
op_assign
id|addr-&gt;sock
suffix:semicolon
id|memcpy
c_func
(paren
id|sipx.sipx_node
comma
id|addr-&gt;node
comma
id|IPX_NODE_LEN
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|ipxs-&gt;intrfc
)paren
(brace
id|sipx.sipx_network
op_assign
id|ipxs-&gt;intrfc-&gt;if_netnum
suffix:semicolon
macro_line|#ifdef CONFIG_IPX_INTERN
id|memcpy
c_func
(paren
id|sipx.sipx_node
comma
id|ipxs-&gt;node
comma
id|IPX_NODE_LEN
)paren
suffix:semicolon
macro_line|#else
id|memcpy
c_func
(paren
id|sipx.sipx_node
comma
id|ipxs-&gt;intrfc-&gt;if_node
comma
id|IPX_NODE_LEN
)paren
suffix:semicolon
macro_line|#endif&t;/* CONFIG_IPX_INTERN */
)brace
r_else
(brace
id|sipx.sipx_network
op_assign
l_int|0
suffix:semicolon
id|memset
c_func
(paren
id|sipx.sipx_node
comma
l_char|&squot;&bslash;0&squot;
comma
id|IPX_NODE_LEN
)paren
suffix:semicolon
)brace
id|sipx.sipx_port
op_assign
id|ipxs-&gt;port
suffix:semicolon
)brace
id|sipx.sipx_family
op_assign
id|AF_IPX
suffix:semicolon
id|sipx.sipx_type
op_assign
id|ipxs-&gt;type
suffix:semicolon
id|memcpy
c_func
(paren
id|uaddr
comma
op_amp
id|sipx
comma
r_sizeof
(paren
id|sipx
)paren
)paren
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
id|out
suffix:colon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|ipx_rcv
r_int
id|ipx_rcv
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|net_device
op_star
id|dev
comma
r_struct
id|packet_type
op_star
id|pt
)paren
(brace
multiline_comment|/* NULL here for pt means the packet was looped back */
r_struct
id|ipx_interface
op_star
id|intrfc
suffix:semicolon
r_struct
id|ipxhdr
op_star
id|ipx
suffix:semicolon
id|u16
id|ipx_pktsize
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Not ours */
r_if
c_cond
(paren
id|skb-&gt;pkt_type
op_eq
id|PACKET_OTHERHOST
)paren
r_goto
id|drop
suffix:semicolon
r_if
c_cond
(paren
(paren
id|skb
op_assign
id|skb_share_check
c_func
(paren
id|skb
comma
id|GFP_ATOMIC
)paren
)paren
op_eq
l_int|NULL
)paren
r_goto
id|out
suffix:semicolon
id|ipx
op_assign
id|ipx_hdr
c_func
(paren
id|skb
)paren
suffix:semicolon
id|ipx_pktsize
op_assign
id|ntohs
c_func
(paren
id|ipx-&gt;ipx_pktsize
)paren
suffix:semicolon
multiline_comment|/* Too small or invalid header? */
r_if
c_cond
(paren
id|ipx_pktsize
template_param
id|skb-&gt;len
)paren
r_goto
id|drop
suffix:semicolon
r_if
c_cond
(paren
id|ipx-&gt;ipx_checksum
op_ne
id|IPX_NO_CHECKSUM
op_logical_and
id|ipx-&gt;ipx_checksum
op_ne
id|ipx_cksum
c_func
(paren
id|ipx
comma
id|ipx_pktsize
)paren
)paren
r_goto
id|drop
suffix:semicolon
id|IPX_SKB_CB
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|ipx_tctrl
op_assign
id|ipx-&gt;ipx_tctrl
suffix:semicolon
id|IPX_SKB_CB
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|ipx_dest_net
op_assign
id|ipx-&gt;ipx_dest.net
suffix:semicolon
id|IPX_SKB_CB
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|ipx_source_net
op_assign
id|ipx-&gt;ipx_source.net
suffix:semicolon
multiline_comment|/* Determine what local ipx endpoint this is */
id|intrfc
op_assign
id|ipxitf_find_using_phys
c_func
(paren
id|dev
comma
id|pt-&gt;type
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|intrfc
)paren
(brace
r_if
c_cond
(paren
id|ipxcfg_auto_create_interfaces
op_logical_and
id|ntohl
c_func
(paren
id|IPX_SKB_CB
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|ipx_dest_net
)paren
)paren
(brace
id|intrfc
op_assign
id|ipxitf_auto_create
c_func
(paren
id|dev
comma
id|pt-&gt;type
)paren
suffix:semicolon
r_if
c_cond
(paren
id|intrfc
)paren
id|ipxitf_hold
c_func
(paren
id|intrfc
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|intrfc
)paren
multiline_comment|/* Not one of ours */
multiline_comment|/* or invalid packet for auto creation */
r_goto
id|drop
suffix:semicolon
)brace
id|ret
op_assign
id|ipxitf_rcv
c_func
(paren
id|intrfc
comma
id|skb
)paren
suffix:semicolon
id|ipxitf_put
c_func
(paren
id|intrfc
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
id|drop
suffix:colon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|ipx_sendmsg
r_static
r_int
id|ipx_sendmsg
c_func
(paren
r_struct
id|kiocb
op_star
id|iocb
comma
r_struct
id|socket
op_star
id|sock
comma
r_struct
id|msghdr
op_star
id|msg
comma
r_int
id|len
comma
r_struct
id|scm_cookie
op_star
id|scm
)paren
(brace
r_struct
id|sock
op_star
id|sk
op_assign
id|sock-&gt;sk
suffix:semicolon
r_struct
id|ipx_opt
op_star
id|ipxs
op_assign
id|ipx_sk
c_func
(paren
id|sk
)paren
suffix:semicolon
r_struct
id|sockaddr_ipx
op_star
id|usipx
op_assign
(paren
r_struct
id|sockaddr_ipx
op_star
)paren
id|msg-&gt;msg_name
suffix:semicolon
r_struct
id|sockaddr_ipx
id|local_sipx
suffix:semicolon
r_int
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_int
id|flags
op_assign
id|msg-&gt;msg_flags
suffix:semicolon
multiline_comment|/* Socket gets bound below anyway */
multiline_comment|/*&t;if (sk-&gt;zapped)&n;&t;&t;return -EIO; */
multiline_comment|/* Socket not bound */
r_if
c_cond
(paren
id|flags
op_amp
op_complement
id|MSG_DONTWAIT
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|usipx
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ipxs-&gt;port
)paren
(brace
r_struct
id|sockaddr_ipx
id|uaddr
suffix:semicolon
id|uaddr.sipx_port
op_assign
l_int|0
suffix:semicolon
id|uaddr.sipx_network
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef CONFIG_IPX_INTERN
id|ret
op_assign
op_minus
id|ENETDOWN
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ipxs-&gt;intrfc
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* Someone zonked the iface */
id|memcpy
c_func
(paren
id|uaddr.sipx_node
comma
id|ipxs-&gt;intrfc-&gt;if_node
comma
id|IPX_NODE_LEN
)paren
suffix:semicolon
macro_line|#endif
id|ret
op_assign
id|ipx_bind
c_func
(paren
id|sock
comma
(paren
r_struct
id|sockaddr
op_star
)paren
op_amp
id|uaddr
comma
r_sizeof
(paren
r_struct
id|sockaddr_ipx
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_goto
id|out
suffix:semicolon
)brace
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|msg-&gt;msg_namelen
OL
r_sizeof
(paren
op_star
id|usipx
)paren
op_logical_or
id|usipx-&gt;sipx_family
op_ne
id|AF_IPX
)paren
r_goto
id|out
suffix:semicolon
)brace
r_else
(brace
id|ret
op_assign
op_minus
id|ENOTCONN
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;state
op_ne
id|TCP_ESTABLISHED
)paren
r_goto
id|out
suffix:semicolon
id|usipx
op_assign
op_amp
id|local_sipx
suffix:semicolon
id|usipx-&gt;sipx_family
op_assign
id|AF_IPX
suffix:semicolon
id|usipx-&gt;sipx_type
op_assign
id|ipxs-&gt;type
suffix:semicolon
id|usipx-&gt;sipx_port
op_assign
id|ipxs-&gt;dest_addr.sock
suffix:semicolon
id|usipx-&gt;sipx_network
op_assign
id|ipxs-&gt;dest_addr.net
suffix:semicolon
id|memcpy
c_func
(paren
id|usipx-&gt;sipx_node
comma
id|ipxs-&gt;dest_addr.node
comma
id|IPX_NODE_LEN
)paren
suffix:semicolon
)brace
id|ret
op_assign
id|ipxrtr_route_packet
c_func
(paren
id|sk
comma
id|usipx
comma
id|msg-&gt;msg_iov
comma
id|len
comma
id|flags
op_amp
id|MSG_DONTWAIT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ge
l_int|0
)paren
id|ret
op_assign
id|len
suffix:semicolon
id|out
suffix:colon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|ipx_recvmsg
r_static
r_int
id|ipx_recvmsg
c_func
(paren
r_struct
id|kiocb
op_star
id|iocb
comma
r_struct
id|socket
op_star
id|sock
comma
r_struct
id|msghdr
op_star
id|msg
comma
r_int
id|size
comma
r_int
id|flags
comma
r_struct
id|scm_cookie
op_star
id|scm
)paren
(brace
r_struct
id|sock
op_star
id|sk
op_assign
id|sock-&gt;sk
suffix:semicolon
r_struct
id|ipx_opt
op_star
id|ipxs
op_assign
id|ipx_sk
c_func
(paren
id|sk
)paren
suffix:semicolon
r_struct
id|sockaddr_ipx
op_star
id|sipx
op_assign
(paren
r_struct
id|sockaddr_ipx
op_star
)paren
id|msg-&gt;msg_name
suffix:semicolon
r_struct
id|ipxhdr
op_star
id|ipx
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|copied
comma
id|err
suffix:semicolon
multiline_comment|/* put the autobinding in */
r_if
c_cond
(paren
op_logical_neg
id|ipxs-&gt;port
)paren
(brace
r_struct
id|sockaddr_ipx
id|uaddr
suffix:semicolon
id|uaddr.sipx_port
op_assign
l_int|0
suffix:semicolon
id|uaddr.sipx_network
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef CONFIG_IPX_INTERN
id|err
op_assign
op_minus
id|ENETDOWN
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ipxs-&gt;intrfc
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* Someone zonked the iface */
id|memcpy
c_func
(paren
id|uaddr.sipx_node
comma
id|ipxs-&gt;intrfc-&gt;if_node
comma
id|IPX_NODE_LEN
)paren
suffix:semicolon
macro_line|#endif&t;/* CONFIG_IPX_INTERN */
id|err
op_assign
id|ipx_bind
c_func
(paren
id|sock
comma
(paren
r_struct
id|sockaddr
op_star
)paren
op_amp
id|uaddr
comma
r_sizeof
(paren
r_struct
id|sockaddr_ipx
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|out
suffix:semicolon
)brace
id|err
op_assign
op_minus
id|ENOTCONN
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;zapped
)paren
r_goto
id|out
suffix:semicolon
id|skb
op_assign
id|skb_recv_datagram
c_func
(paren
id|sk
comma
id|flags
op_amp
op_complement
id|MSG_DONTWAIT
comma
id|flags
op_amp
id|MSG_DONTWAIT
comma
op_amp
id|err
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
r_goto
id|out
suffix:semicolon
id|ipx
op_assign
id|ipx_hdr
c_func
(paren
id|skb
)paren
suffix:semicolon
id|copied
op_assign
id|ntohs
c_func
(paren
id|ipx-&gt;ipx_pktsize
)paren
op_minus
r_sizeof
(paren
r_struct
id|ipxhdr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copied
OG
id|size
)paren
(brace
id|copied
op_assign
id|size
suffix:semicolon
id|msg-&gt;msg_flags
op_or_assign
id|MSG_TRUNC
suffix:semicolon
)brace
id|err
op_assign
id|skb_copy_datagram_iovec
c_func
(paren
id|skb
comma
r_sizeof
(paren
r_struct
id|ipxhdr
)paren
comma
id|msg-&gt;msg_iov
comma
id|copied
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|out_free
suffix:semicolon
id|sk-&gt;stamp
op_assign
id|skb-&gt;stamp
suffix:semicolon
id|msg-&gt;msg_namelen
op_assign
r_sizeof
(paren
op_star
id|sipx
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sipx
)paren
(brace
id|sipx-&gt;sipx_family
op_assign
id|AF_IPX
suffix:semicolon
id|sipx-&gt;sipx_port
op_assign
id|ipx-&gt;ipx_source.sock
suffix:semicolon
id|memcpy
c_func
(paren
id|sipx-&gt;sipx_node
comma
id|ipx-&gt;ipx_source.node
comma
id|IPX_NODE_LEN
)paren
suffix:semicolon
id|sipx-&gt;sipx_network
op_assign
id|IPX_SKB_CB
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|ipx_source_net
suffix:semicolon
id|sipx-&gt;sipx_type
op_assign
id|ipx-&gt;ipx_type
suffix:semicolon
)brace
id|err
op_assign
id|copied
suffix:semicolon
id|out_free
suffix:colon
id|skb_free_datagram
c_func
(paren
id|sk
comma
id|skb
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|err
suffix:semicolon
)brace
DECL|function|ipx_ioctl
r_static
r_int
id|ipx_ioctl
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_int
id|amount
op_assign
l_int|0
suffix:semicolon
r_struct
id|sock
op_star
id|sk
op_assign
id|sock-&gt;sk
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|TIOCOUTQ
suffix:colon
id|amount
op_assign
id|sk-&gt;sndbuf
op_minus
id|atomic_read
c_func
(paren
op_amp
id|sk-&gt;wmem_alloc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|amount
OL
l_int|0
)paren
id|amount
op_assign
l_int|0
suffix:semicolon
r_return
id|put_user
c_func
(paren
id|amount
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|TIOCINQ
suffix:colon
(brace
r_struct
id|sk_buff
op_star
id|skb
op_assign
id|skb_peek
c_func
(paren
op_amp
id|sk-&gt;receive_queue
)paren
suffix:semicolon
multiline_comment|/* These two are safe on a single CPU system as only&n;&t;&t;&t; * user tasks fiddle here */
r_if
c_cond
(paren
id|skb
)paren
id|amount
op_assign
id|skb-&gt;len
op_minus
r_sizeof
(paren
r_struct
id|ipxhdr
)paren
suffix:semicolon
r_return
id|put_user
c_func
(paren
id|amount
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
)brace
r_case
id|SIOCADDRT
suffix:colon
r_case
id|SIOCDELRT
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
r_return
id|ipxrtr_ioctl
c_func
(paren
id|cmd
comma
(paren
r_void
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SIOCSIFADDR
suffix:colon
r_case
id|SIOCAIPXITFCRT
suffix:colon
r_case
id|SIOCAIPXPRISLT
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
r_case
id|SIOCGIFADDR
suffix:colon
r_return
id|ipxitf_ioctl
c_func
(paren
id|cmd
comma
(paren
r_void
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SIOCIPXCFGDATA
suffix:colon
r_return
id|ipxcfg_get_config_data
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
)paren
suffix:semicolon
r_case
id|SIOCIPXNCPCONN
suffix:colon
multiline_comment|/*&n;&t;&t;&t; * This socket wants to take care of the NCP connection&n;&t;&t;&t; * handed to us in arg.&n;&t;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
id|capable
c_func
(paren
id|CAP_NET_ADMIN
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
r_return
id|get_user
c_func
(paren
id|ipx_sk
c_func
(paren
id|sk
)paren
op_member_access_from_pointer
id|ipx_ncp_conn
comma
(paren
r_const
r_int
r_int
op_star
)paren
(paren
id|arg
)paren
)paren
suffix:semicolon
r_case
id|SIOCGSTAMP
suffix:colon
(brace
r_int
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|sk
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|sk-&gt;stamp.tv_sec
)paren
r_return
op_minus
id|ENOENT
suffix:semicolon
id|ret
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|copy_to_user
c_func
(paren
(paren
r_void
op_star
)paren
id|arg
comma
op_amp
id|sk-&gt;stamp
comma
r_sizeof
(paren
r_struct
id|timeval
)paren
)paren
)paren
id|ret
op_assign
l_int|0
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
r_case
id|SIOCGIFDSTADDR
suffix:colon
r_case
id|SIOCSIFDSTADDR
suffix:colon
r_case
id|SIOCGIFBRDADDR
suffix:colon
r_case
id|SIOCSIFBRDADDR
suffix:colon
r_case
id|SIOCGIFNETMASK
suffix:colon
r_case
id|SIOCSIFNETMASK
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
r_default
suffix:colon
r_return
id|dev_ioctl
c_func
(paren
id|cmd
comma
(paren
r_void
op_star
)paren
id|arg
)paren
suffix:semicolon
)brace
multiline_comment|/*NOT REACHED*/
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Socket family declarations&n; */
DECL|variable|ipx_family_ops
r_static
r_struct
id|net_proto_family
id|ipx_family_ops
op_assign
(brace
dot
id|family
op_assign
id|PF_IPX
comma
dot
id|create
op_assign
id|ipx_create
comma
)brace
suffix:semicolon
DECL|variable|ipx_dgram_ops
r_static
r_struct
id|proto_ops
id|SOCKOPS_WRAPPED
c_func
(paren
id|ipx_dgram_ops
)paren
op_assign
(brace
dot
id|family
op_assign
id|PF_IPX
comma
dot
id|release
op_assign
id|ipx_release
comma
dot
id|bind
op_assign
id|ipx_bind
comma
dot
id|connect
op_assign
id|ipx_connect
comma
dot
id|socketpair
op_assign
id|sock_no_socketpair
comma
dot
id|accept
op_assign
id|sock_no_accept
comma
dot
id|getname
op_assign
id|ipx_getname
comma
dot
id|poll
op_assign
id|datagram_poll
comma
dot
id|ioctl
op_assign
id|ipx_ioctl
comma
dot
id|listen
op_assign
id|sock_no_listen
comma
dot
id|shutdown
op_assign
id|sock_no_shutdown
comma
multiline_comment|/* FIXME: support shutdown */
dot
id|setsockopt
op_assign
id|ipx_setsockopt
comma
dot
id|getsockopt
op_assign
id|ipx_getsockopt
comma
dot
id|sendmsg
op_assign
id|ipx_sendmsg
comma
dot
id|recvmsg
op_assign
id|ipx_recvmsg
comma
dot
id|mmap
op_assign
id|sock_no_mmap
comma
dot
id|sendpage
op_assign
id|sock_no_sendpage
comma
)brace
suffix:semicolon
macro_line|#include &lt;linux/smp_lock.h&gt;
id|SOCKOPS_WRAP
c_func
(paren
id|ipx_dgram
comma
id|PF_IPX
)paren
suffix:semicolon
DECL|variable|ipx_8023_packet_type
r_static
r_struct
id|packet_type
id|ipx_8023_packet_type
op_assign
(brace
dot
id|type
op_assign
id|__constant_htons
c_func
(paren
id|ETH_P_802_3
)paren
comma
dot
id|func
op_assign
id|ipx_rcv
comma
dot
id|data
op_assign
(paren
r_void
op_star
)paren
l_int|1
comma
multiline_comment|/* yap, I understand shared skbs :-) */
)brace
suffix:semicolon
DECL|variable|ipx_dix_packet_type
r_static
r_struct
id|packet_type
id|ipx_dix_packet_type
op_assign
(brace
dot
id|type
op_assign
id|__constant_htons
c_func
(paren
id|ETH_P_IPX
)paren
comma
dot
id|func
op_assign
id|ipx_rcv
comma
dot
id|data
op_assign
(paren
r_void
op_star
)paren
l_int|1
comma
multiline_comment|/* yap, I understand shared skbs :-) */
)brace
suffix:semicolon
DECL|variable|ipx_dev_notifier
r_static
r_struct
id|notifier_block
id|ipx_dev_notifier
op_assign
(brace
dot
id|notifier_call
op_assign
id|ipxitf_device_event
comma
)brace
suffix:semicolon
r_extern
r_struct
id|datalink_proto
op_star
id|make_EII_client
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_struct
id|datalink_proto
op_star
id|make_8023_client
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_void
id|destroy_EII_client
c_func
(paren
r_struct
id|datalink_proto
op_star
)paren
suffix:semicolon
r_extern
r_void
id|destroy_8023_client
c_func
(paren
r_struct
id|datalink_proto
op_star
)paren
suffix:semicolon
DECL|variable|ipx_8022_type
r_static
r_int
r_char
id|ipx_8022_type
op_assign
l_int|0xE0
suffix:semicolon
DECL|variable|ipx_snap_id
r_static
r_int
r_char
id|ipx_snap_id
(braket
l_int|5
)braket
op_assign
(brace
l_int|0x0
comma
l_int|0x0
comma
l_int|0x0
comma
l_int|0x81
comma
l_int|0x37
)brace
suffix:semicolon
DECL|variable|__initdata
r_static
r_char
id|ipx_banner
(braket
)braket
id|__initdata
op_assign
id|KERN_INFO
l_string|&quot;NET4: Linux IPX 0.50 for NET4.0&bslash;n&quot;
id|KERN_INFO
l_string|&quot;IPX Portions Copyright (c) 1995 Caldera, Inc.&bslash;n&quot;
"&bslash;"
id|KERN_INFO
l_string|&quot;IPX Portions Copyright (c) 2000-2002 Conectiva, Inc.&bslash;n&quot;
suffix:semicolon
DECL|variable|__initdata
r_static
r_char
id|ipx_EII_err_msg
(braket
)braket
id|__initdata
op_assign
id|KERN_CRIT
l_string|&quot;IPX: Unable to register with Ethernet II&bslash;n&quot;
suffix:semicolon
DECL|variable|__initdata
r_static
r_char
id|ipx_8023_err_msg
(braket
)braket
id|__initdata
op_assign
id|KERN_CRIT
l_string|&quot;IPX: Unable to register with 802.3&bslash;n&quot;
suffix:semicolon
DECL|variable|__initdata
r_static
r_char
id|ipx_llc_err_msg
(braket
)braket
id|__initdata
op_assign
id|KERN_CRIT
l_string|&quot;IPX: Unable to register with 802.2&bslash;n&quot;
suffix:semicolon
DECL|variable|__initdata
r_static
r_char
id|ipx_snap_err_msg
(braket
)braket
id|__initdata
op_assign
id|KERN_CRIT
l_string|&quot;IPX: Unable to register with SNAP&bslash;n&quot;
suffix:semicolon
DECL|function|ipx_init
r_static
r_int
id|__init
id|ipx_init
c_func
(paren
r_void
)paren
(brace
id|sock_register
c_func
(paren
op_amp
id|ipx_family_ops
)paren
suffix:semicolon
id|pEII_datalink
op_assign
id|make_EII_client
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pEII_datalink
)paren
id|dev_add_pack
c_func
(paren
op_amp
id|ipx_dix_packet_type
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
id|ipx_EII_err_msg
)paren
suffix:semicolon
id|p8023_datalink
op_assign
id|make_8023_client
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p8023_datalink
)paren
id|dev_add_pack
c_func
(paren
op_amp
id|ipx_8023_packet_type
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
id|ipx_8023_err_msg
)paren
suffix:semicolon
id|p8022_datalink
op_assign
id|register_8022_client
c_func
(paren
id|ipx_8022_type
comma
id|ipx_rcv
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|p8022_datalink
)paren
id|printk
c_func
(paren
id|ipx_llc_err_msg
)paren
suffix:semicolon
id|pSNAP_datalink
op_assign
id|register_snap_client
c_func
(paren
id|ipx_snap_id
comma
id|ipx_rcv
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pSNAP_datalink
)paren
id|printk
c_func
(paren
id|ipx_snap_err_msg
)paren
suffix:semicolon
id|register_netdevice_notifier
c_func
(paren
op_amp
id|ipx_dev_notifier
)paren
suffix:semicolon
id|ipx_register_sysctl
c_func
(paren
)paren
suffix:semicolon
id|ipx_proc_init
c_func
(paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|ipx_banner
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|ipx_init
id|module_init
c_func
(paren
id|ipx_init
)paren
suffix:semicolon
multiline_comment|/* Note on MOD_{INC,DEC}_USE_COUNT:&n; *&n; * Use counts are incremented/decremented when&n; * sockets are created/deleted.&n; *&n; * Routes are always associated with an interface, and&n; * allocs/frees will remain properly accounted for by&n; * their associated interfaces.&n; *&n; * Ergo, before the ipx module can be removed, all IPX&n; * sockets be closed from user space.&n; */
DECL|function|ipx_proto_finito
r_static
r_void
id|__exit
id|ipx_proto_finito
c_func
(paren
r_void
)paren
(brace
multiline_comment|/*&n;&t; * No need to worry about having anything on the ipx_interfaces list,&n;&t; * when a interface is created we increment the module usage count, so&n;&t; * the module will only be unloaded when there are no more interfaces&n;&t; */
id|ipx_proc_exit
c_func
(paren
)paren
suffix:semicolon
id|ipx_unregister_sysctl
c_func
(paren
)paren
suffix:semicolon
id|unregister_netdevice_notifier
c_func
(paren
op_amp
id|ipx_dev_notifier
)paren
suffix:semicolon
id|unregister_snap_client
c_func
(paren
id|pSNAP_datalink
)paren
suffix:semicolon
id|pSNAP_datalink
op_assign
l_int|NULL
suffix:semicolon
id|unregister_8022_client
c_func
(paren
id|p8022_datalink
)paren
suffix:semicolon
id|p8022_datalink
op_assign
l_int|NULL
suffix:semicolon
id|dev_remove_pack
c_func
(paren
op_amp
id|ipx_8023_packet_type
)paren
suffix:semicolon
id|destroy_8023_client
c_func
(paren
id|p8023_datalink
)paren
suffix:semicolon
id|p8023_datalink
op_assign
l_int|NULL
suffix:semicolon
id|dev_remove_pack
c_func
(paren
op_amp
id|ipx_dix_packet_type
)paren
suffix:semicolon
id|destroy_EII_client
c_func
(paren
id|pEII_datalink
)paren
suffix:semicolon
id|pEII_datalink
op_assign
l_int|NULL
suffix:semicolon
id|sock_unregister
c_func
(paren
id|ipx_family_ops.family
)paren
suffix:semicolon
)brace
DECL|variable|ipx_proto_finito
id|module_exit
c_func
(paren
id|ipx_proto_finito
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
eof
