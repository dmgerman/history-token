multiline_comment|/*&n; *&t;Implements the IPX routing routines.&n; *&t;Code moved from af_ipx.c.&n; *&n; *&t;Arnaldo Carvalho de Melo &lt;acme@conectiva.com.br&gt;, 2003&n; *&n; *&t;See net/ipx/ChangeLog.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/list.h&gt;
macro_line|#include &lt;linux/route.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
macro_line|#include &lt;net/ipx.h&gt;
macro_line|#include &lt;net/sock.h&gt;
DECL|variable|ipx_routes
id|LIST_HEAD
c_func
(paren
id|ipx_routes
)paren
suffix:semicolon
DECL|variable|ipx_routes_lock
id|DEFINE_RWLOCK
c_func
(paren
id|ipx_routes_lock
)paren
suffix:semicolon
r_extern
r_struct
id|ipx_interface
op_star
id|ipx_internal_net
suffix:semicolon
r_extern
id|__u16
id|ipx_cksum
c_func
(paren
r_struct
id|ipxhdr
op_star
id|packet
comma
r_int
id|length
)paren
suffix:semicolon
r_extern
r_struct
id|ipx_interface
op_star
id|ipxitf_find_using_net
c_func
(paren
id|__u32
id|net
)paren
suffix:semicolon
r_extern
r_int
id|ipxitf_demux_socket
c_func
(paren
r_struct
id|ipx_interface
op_star
id|intrfc
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_int
id|copy
)paren
suffix:semicolon
r_extern
r_int
id|ipxitf_demux_socket
c_func
(paren
r_struct
id|ipx_interface
op_star
id|intrfc
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_int
id|copy
)paren
suffix:semicolon
r_extern
r_int
id|ipxitf_send
c_func
(paren
r_struct
id|ipx_interface
op_star
id|intrfc
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_char
op_star
id|node
)paren
suffix:semicolon
r_extern
r_struct
id|ipx_interface
op_star
id|ipxitf_find_using_net
c_func
(paren
id|__u32
id|net
)paren
suffix:semicolon
DECL|function|ipxrtr_lookup
r_struct
id|ipx_route
op_star
id|ipxrtr_lookup
c_func
(paren
id|__u32
id|net
)paren
(brace
r_struct
id|ipx_route
op_star
id|r
suffix:semicolon
id|read_lock_bh
c_func
(paren
op_amp
id|ipx_routes_lock
)paren
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|r
comma
op_amp
id|ipx_routes
comma
id|node
)paren
r_if
c_cond
(paren
id|r-&gt;ir_net
op_eq
id|net
)paren
(brace
id|ipxrtr_hold
c_func
(paren
id|r
)paren
suffix:semicolon
r_goto
id|unlock
suffix:semicolon
)brace
id|r
op_assign
l_int|NULL
suffix:semicolon
id|unlock
suffix:colon
id|read_unlock_bh
c_func
(paren
op_amp
id|ipx_routes_lock
)paren
suffix:semicolon
r_return
id|r
suffix:semicolon
)brace
multiline_comment|/*&n; * Caller must hold a reference to intrfc&n; */
DECL|function|ipxrtr_add_route
r_int
id|ipxrtr_add_route
c_func
(paren
id|__u32
id|network
comma
r_struct
id|ipx_interface
op_star
id|intrfc
comma
r_int
r_char
op_star
id|node
)paren
(brace
r_struct
id|ipx_route
op_star
id|rt
suffix:semicolon
r_int
id|rc
suffix:semicolon
multiline_comment|/* Get a route structure; either existing or create */
id|rt
op_assign
id|ipxrtr_lookup
c_func
(paren
id|network
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rt
)paren
(brace
id|rt
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|rt
)paren
comma
id|GFP_ATOMIC
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|EAGAIN
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rt
)paren
r_goto
id|out
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|rt-&gt;refcnt
comma
l_int|1
)paren
suffix:semicolon
id|ipxrtr_hold
c_func
(paren
id|rt
)paren
suffix:semicolon
id|write_lock_bh
c_func
(paren
op_amp
id|ipx_routes_lock
)paren
suffix:semicolon
id|list_add
c_func
(paren
op_amp
id|rt-&gt;node
comma
op_amp
id|ipx_routes
)paren
suffix:semicolon
id|write_unlock_bh
c_func
(paren
op_amp
id|ipx_routes_lock
)paren
suffix:semicolon
)brace
r_else
(brace
id|rc
op_assign
op_minus
id|EEXIST
suffix:semicolon
r_if
c_cond
(paren
id|intrfc
op_eq
id|ipx_internal_net
)paren
r_goto
id|out_put
suffix:semicolon
)brace
id|rt-&gt;ir_net
op_assign
id|network
suffix:semicolon
id|rt-&gt;ir_intrfc
op_assign
id|intrfc
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|node
)paren
(brace
id|memset
c_func
(paren
id|rt-&gt;ir_router_node
comma
l_char|&squot;&bslash;0&squot;
comma
id|IPX_NODE_LEN
)paren
suffix:semicolon
id|rt-&gt;ir_routed
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|memcpy
c_func
(paren
id|rt-&gt;ir_router_node
comma
id|node
comma
id|IPX_NODE_LEN
)paren
suffix:semicolon
id|rt-&gt;ir_routed
op_assign
l_int|1
suffix:semicolon
)brace
id|rc
op_assign
l_int|0
suffix:semicolon
id|out_put
suffix:colon
id|ipxrtr_put
c_func
(paren
id|rt
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|ipxrtr_del_routes
r_void
id|ipxrtr_del_routes
c_func
(paren
r_struct
id|ipx_interface
op_star
id|intrfc
)paren
(brace
r_struct
id|ipx_route
op_star
id|r
comma
op_star
id|tmp
suffix:semicolon
id|write_lock_bh
c_func
(paren
op_amp
id|ipx_routes_lock
)paren
suffix:semicolon
id|list_for_each_entry_safe
c_func
(paren
id|r
comma
id|tmp
comma
op_amp
id|ipx_routes
comma
id|node
)paren
r_if
c_cond
(paren
id|r-&gt;ir_intrfc
op_eq
id|intrfc
)paren
(brace
id|list_del
c_func
(paren
op_amp
id|r-&gt;node
)paren
suffix:semicolon
id|ipxrtr_put
c_func
(paren
id|r
)paren
suffix:semicolon
)brace
id|write_unlock_bh
c_func
(paren
op_amp
id|ipx_routes_lock
)paren
suffix:semicolon
)brace
DECL|function|ipxrtr_create
r_static
r_int
id|ipxrtr_create
c_func
(paren
r_struct
id|ipx_route_definition
op_star
id|rd
)paren
(brace
r_struct
id|ipx_interface
op_star
id|intrfc
suffix:semicolon
r_int
id|rc
op_assign
op_minus
id|ENETUNREACH
suffix:semicolon
multiline_comment|/* Find the appropriate interface */
id|intrfc
op_assign
id|ipxitf_find_using_net
c_func
(paren
id|rd-&gt;ipx_router_network
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|intrfc
)paren
r_goto
id|out
suffix:semicolon
id|rc
op_assign
id|ipxrtr_add_route
c_func
(paren
id|rd-&gt;ipx_network
comma
id|intrfc
comma
id|rd-&gt;ipx_router_node
)paren
suffix:semicolon
id|ipxitf_put
c_func
(paren
id|intrfc
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|ipxrtr_delete
r_static
r_int
id|ipxrtr_delete
c_func
(paren
r_int
id|net
)paren
(brace
r_struct
id|ipx_route
op_star
id|r
comma
op_star
id|tmp
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|write_lock_bh
c_func
(paren
op_amp
id|ipx_routes_lock
)paren
suffix:semicolon
id|list_for_each_entry_safe
c_func
(paren
id|r
comma
id|tmp
comma
op_amp
id|ipx_routes
comma
id|node
)paren
r_if
c_cond
(paren
id|r-&gt;ir_net
op_eq
id|net
)paren
(brace
multiline_comment|/* Directly connected; can&squot;t lose route */
id|rc
op_assign
op_minus
id|EPERM
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|r-&gt;ir_routed
)paren
r_goto
id|out
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|r-&gt;node
)paren
suffix:semicolon
id|ipxrtr_put
c_func
(paren
id|r
)paren
suffix:semicolon
id|rc
op_assign
l_int|0
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|rc
op_assign
op_minus
id|ENOENT
suffix:semicolon
id|out
suffix:colon
id|write_unlock_bh
c_func
(paren
op_amp
id|ipx_routes_lock
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*&n; * The skb has to be unshared, we&squot;ll end up calling ipxitf_send, that&squot;ll&n; * modify the packet&n; */
DECL|function|ipxrtr_route_skb
r_int
id|ipxrtr_route_skb
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|ipxhdr
op_star
id|ipx
op_assign
id|ipx_hdr
c_func
(paren
id|skb
)paren
suffix:semicolon
r_struct
id|ipx_route
op_star
id|r
op_assign
id|ipxrtr_lookup
c_func
(paren
id|IPX_SKB_CB
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|ipx_dest_net
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|r
)paren
(brace
multiline_comment|/* no known route */
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|ipxitf_hold
c_func
(paren
id|r-&gt;ir_intrfc
)paren
suffix:semicolon
id|ipxitf_send
c_func
(paren
id|r-&gt;ir_intrfc
comma
id|skb
comma
id|r-&gt;ir_routed
ques
c_cond
id|r-&gt;ir_router_node
suffix:colon
id|ipx-&gt;ipx_dest.node
)paren
suffix:semicolon
id|ipxitf_put
c_func
(paren
id|r-&gt;ir_intrfc
)paren
suffix:semicolon
id|ipxrtr_put
c_func
(paren
id|r
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Route an outgoing frame from a socket.&n; */
DECL|function|ipxrtr_route_packet
r_int
id|ipxrtr_route_packet
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_struct
id|sockaddr_ipx
op_star
id|usipx
comma
r_struct
id|iovec
op_star
id|iov
comma
r_int
id|len
comma
r_int
id|noblock
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_struct
id|ipx_sock
op_star
id|ipxs
op_assign
id|ipx_sk
c_func
(paren
id|sk
)paren
suffix:semicolon
r_struct
id|ipx_interface
op_star
id|intrfc
suffix:semicolon
r_struct
id|ipxhdr
op_star
id|ipx
suffix:semicolon
r_int
id|size
suffix:semicolon
r_int
id|ipx_offset
suffix:semicolon
r_struct
id|ipx_route
op_star
id|rt
op_assign
l_int|NULL
suffix:semicolon
r_int
id|rc
suffix:semicolon
multiline_comment|/* Find the appropriate interface on which to send packet */
r_if
c_cond
(paren
op_logical_neg
id|usipx-&gt;sipx_network
op_logical_and
id|ipx_primary_net
)paren
(brace
id|usipx-&gt;sipx_network
op_assign
id|ipx_primary_net-&gt;if_netnum
suffix:semicolon
id|intrfc
op_assign
id|ipx_primary_net
suffix:semicolon
)brace
r_else
(brace
id|rt
op_assign
id|ipxrtr_lookup
c_func
(paren
id|usipx-&gt;sipx_network
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|ENETUNREACH
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rt
)paren
r_goto
id|out
suffix:semicolon
id|intrfc
op_assign
id|rt-&gt;ir_intrfc
suffix:semicolon
)brace
id|ipxitf_hold
c_func
(paren
id|intrfc
)paren
suffix:semicolon
id|ipx_offset
op_assign
id|intrfc-&gt;if_ipx_offset
suffix:semicolon
id|size
op_assign
r_sizeof
(paren
r_struct
id|ipxhdr
)paren
op_plus
id|len
op_plus
id|ipx_offset
suffix:semicolon
id|skb
op_assign
id|sock_alloc_send_skb
c_func
(paren
id|sk
comma
id|size
comma
id|noblock
comma
op_amp
id|rc
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
r_goto
id|out_put
suffix:semicolon
id|skb_reserve
c_func
(paren
id|skb
comma
id|ipx_offset
)paren
suffix:semicolon
id|skb-&gt;sk
op_assign
id|sk
suffix:semicolon
multiline_comment|/* Fill in IPX header */
id|skb-&gt;h.raw
op_assign
id|skb-&gt;nh.raw
op_assign
id|skb_put
c_func
(paren
id|skb
comma
r_sizeof
(paren
r_struct
id|ipxhdr
)paren
)paren
suffix:semicolon
id|ipx
op_assign
id|ipx_hdr
c_func
(paren
id|skb
)paren
suffix:semicolon
id|ipx-&gt;ipx_pktsize
op_assign
id|htons
c_func
(paren
id|len
op_plus
r_sizeof
(paren
r_struct
id|ipxhdr
)paren
)paren
suffix:semicolon
id|IPX_SKB_CB
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|ipx_tctrl
op_assign
l_int|0
suffix:semicolon
id|ipx-&gt;ipx_type
op_assign
id|usipx-&gt;sipx_type
suffix:semicolon
id|IPX_SKB_CB
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|last_hop.index
op_assign
op_minus
l_int|1
suffix:semicolon
macro_line|#ifdef CONFIG_IPX_INTERN
id|IPX_SKB_CB
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|ipx_source_net
op_assign
id|ipxs-&gt;intrfc-&gt;if_netnum
suffix:semicolon
id|memcpy
c_func
(paren
id|ipx-&gt;ipx_source.node
comma
id|ipxs-&gt;node
comma
id|IPX_NODE_LEN
)paren
suffix:semicolon
macro_line|#else
id|rc
op_assign
id|ntohs
c_func
(paren
id|ipxs-&gt;port
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
l_int|0x453
op_logical_or
id|rc
op_eq
l_int|0x452
)paren
(brace
multiline_comment|/* RIP/SAP special handling for mars_nwe */
id|IPX_SKB_CB
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|ipx_source_net
op_assign
id|intrfc-&gt;if_netnum
suffix:semicolon
id|memcpy
c_func
(paren
id|ipx-&gt;ipx_source.node
comma
id|intrfc-&gt;if_node
comma
id|IPX_NODE_LEN
)paren
suffix:semicolon
)brace
r_else
(brace
id|IPX_SKB_CB
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|ipx_source_net
op_assign
id|ipxs-&gt;intrfc-&gt;if_netnum
suffix:semicolon
id|memcpy
c_func
(paren
id|ipx-&gt;ipx_source.node
comma
id|ipxs-&gt;intrfc-&gt;if_node
comma
id|IPX_NODE_LEN
)paren
suffix:semicolon
)brace
macro_line|#endif&t;/* CONFIG_IPX_INTERN */
id|ipx-&gt;ipx_source.sock
op_assign
id|ipxs-&gt;port
suffix:semicolon
id|IPX_SKB_CB
c_func
(paren
id|skb
)paren
op_member_access_from_pointer
id|ipx_dest_net
op_assign
id|usipx-&gt;sipx_network
suffix:semicolon
id|memcpy
c_func
(paren
id|ipx-&gt;ipx_dest.node
comma
id|usipx-&gt;sipx_node
comma
id|IPX_NODE_LEN
)paren
suffix:semicolon
id|ipx-&gt;ipx_dest.sock
op_assign
id|usipx-&gt;sipx_port
suffix:semicolon
id|rc
op_assign
id|memcpy_fromiovec
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|len
)paren
comma
id|iov
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_goto
id|out_put
suffix:semicolon
)brace
multiline_comment|/* Apply checksum. Not allowed on 802.3 links. */
r_if
c_cond
(paren
id|sk-&gt;sk_no_check
op_logical_or
id|intrfc-&gt;if_dlink_type
op_eq
id|IPX_FRAME_8023
)paren
id|ipx-&gt;ipx_checksum
op_assign
l_int|0xFFFF
suffix:semicolon
r_else
id|ipx-&gt;ipx_checksum
op_assign
id|ipx_cksum
c_func
(paren
id|ipx
comma
id|len
op_plus
r_sizeof
(paren
r_struct
id|ipxhdr
)paren
)paren
suffix:semicolon
id|rc
op_assign
id|ipxitf_send
c_func
(paren
id|intrfc
comma
id|skb
comma
(paren
id|rt
op_logical_and
id|rt-&gt;ir_routed
)paren
ques
c_cond
id|rt-&gt;ir_router_node
suffix:colon
id|ipx-&gt;ipx_dest.node
)paren
suffix:semicolon
id|out_put
suffix:colon
id|ipxitf_put
c_func
(paren
id|intrfc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rt
)paren
id|ipxrtr_put
c_func
(paren
id|rt
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*&n; * We use a normal struct rtentry for route handling&n; */
DECL|function|ipxrtr_ioctl
r_int
id|ipxrtr_ioctl
c_func
(paren
r_int
r_int
id|cmd
comma
r_void
id|__user
op_star
id|arg
)paren
(brace
r_struct
id|rtentry
id|rt
suffix:semicolon
multiline_comment|/* Use these to behave like &squot;other&squot; stacks */
r_struct
id|sockaddr_ipx
op_star
id|sg
comma
op_star
id|st
suffix:semicolon
r_int
id|rc
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|rt
comma
id|arg
comma
r_sizeof
(paren
id|rt
)paren
)paren
)paren
r_goto
id|out
suffix:semicolon
id|sg
op_assign
(paren
r_struct
id|sockaddr_ipx
op_star
)paren
op_amp
id|rt.rt_gateway
suffix:semicolon
id|st
op_assign
(paren
r_struct
id|sockaddr_ipx
op_star
)paren
op_amp
id|rt.rt_dst
suffix:semicolon
id|rc
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|rt.rt_flags
op_amp
id|RTF_GATEWAY
)paren
op_logical_or
multiline_comment|/* Direct routes are fixed */
id|sg-&gt;sipx_family
op_ne
id|AF_IPX
op_logical_or
id|st-&gt;sipx_family
op_ne
id|AF_IPX
)paren
r_goto
id|out
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SIOCDELRT
suffix:colon
id|rc
op_assign
id|ipxrtr_delete
c_func
(paren
id|st-&gt;sipx_network
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SIOCADDRT
suffix:colon
(brace
r_struct
id|ipx_route_definition
id|f
suffix:semicolon
id|f.ipx_network
op_assign
id|st-&gt;sipx_network
suffix:semicolon
id|f.ipx_router_network
op_assign
id|sg-&gt;sipx_network
suffix:semicolon
id|memcpy
c_func
(paren
id|f.ipx_router_node
comma
id|sg-&gt;sipx_node
comma
id|IPX_NODE_LEN
)paren
suffix:semicolon
id|rc
op_assign
id|ipxrtr_create
c_func
(paren
op_amp
id|f
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|out
suffix:colon
r_return
id|rc
suffix:semicolon
)brace
eof
