multiline_comment|/*&n; * net/sched/sch_netem.c&t;Network emulator&n; *&n; * &t;&t;This program is free software; you can redistribute it and/or&n; * &t;&t;modify it under the terms of the GNU General Public License&n; * &t;&t;as published by the Free Software Foundation; either version&n; * &t;&t;2 of the License, or (at your option) any later version.&n; *&n; * Authors:&t;Stephen Hemminger &lt;shemminger@osdl.org&gt;&n; *&t;&t;Catalin(ux aka Dino) BOIE &lt;catab at umbrella dot ro&gt;&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/rtnetlink.h&gt;
macro_line|#include &lt;net/pkt_sched.h&gt;
multiline_comment|/*&t;Network emulator&n; *&n; *&t;This scheduler can alters spacing and order&n; *&t;Similar to NISTnet and BSD Dummynet.&n; */
DECL|struct|netem_sched_data
r_struct
id|netem_sched_data
(brace
DECL|member|qnormal
r_struct
id|sk_buff_head
id|qnormal
suffix:semicolon
DECL|member|qdelay
r_struct
id|sk_buff_head
id|qdelay
suffix:semicolon
DECL|member|timer
r_struct
id|timer_list
id|timer
suffix:semicolon
DECL|member|latency
id|u32
id|latency
suffix:semicolon
DECL|member|loss
id|u32
id|loss
suffix:semicolon
DECL|member|counter
id|u32
id|counter
suffix:semicolon
DECL|member|gap
id|u32
id|gap
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* Time stamp put into socket buffer control block */
DECL|struct|netem_skb_cb
r_struct
id|netem_skb_cb
(brace
DECL|member|time_to_send
id|psched_time_t
id|time_to_send
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* Enqueue packets with underlying discipline (fifo)&n; * but mark them with current time first.&n; */
DECL|function|netem_enqueue
r_static
r_int
id|netem_enqueue
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|Qdisc
op_star
id|sch
)paren
(brace
r_struct
id|netem_sched_data
op_star
id|q
op_assign
(paren
r_struct
id|netem_sched_data
op_star
)paren
id|sch-&gt;data
suffix:semicolon
r_struct
id|netem_skb_cb
op_star
id|cb
op_assign
(paren
r_struct
id|netem_skb_cb
op_star
)paren
id|skb-&gt;cb
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;netem_enqueue skb=%p @%lu&bslash;n&quot;
comma
id|skb
comma
id|jiffies
)paren
suffix:semicolon
multiline_comment|/* Random packet drop 0 =&gt; none, ~0 =&gt; all */
r_if
c_cond
(paren
id|q-&gt;loss
op_logical_and
id|q-&gt;loss
op_ge
id|net_random
c_func
(paren
)paren
)paren
(brace
id|sch-&gt;stats.drops
op_increment
suffix:semicolon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* lie about loss so TCP doesn&squot;t know */
)brace
r_if
c_cond
(paren
id|q-&gt;qnormal.qlen
OL
id|sch-&gt;dev-&gt;tx_queue_len
)paren
(brace
id|PSCHED_GET_TIME
c_func
(paren
id|cb-&gt;time_to_send
)paren
suffix:semicolon
id|PSCHED_TADD
c_func
(paren
id|cb-&gt;time_to_send
comma
id|q-&gt;latency
)paren
suffix:semicolon
id|__skb_queue_tail
c_func
(paren
op_amp
id|q-&gt;qnormal
comma
id|skb
)paren
suffix:semicolon
id|sch-&gt;q.qlen
op_increment
suffix:semicolon
id|sch-&gt;stats.bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
id|sch-&gt;stats.packets
op_increment
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|sch-&gt;stats.drops
op_increment
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
id|NET_XMIT_DROP
suffix:semicolon
)brace
multiline_comment|/* Requeue packets but don&squot;t change time stamp */
DECL|function|netem_requeue
r_static
r_int
id|netem_requeue
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|Qdisc
op_star
id|sch
)paren
(brace
r_struct
id|netem_sched_data
op_star
id|q
op_assign
(paren
r_struct
id|netem_sched_data
op_star
)paren
id|sch-&gt;data
suffix:semicolon
id|__skb_queue_head
c_func
(paren
op_amp
id|q-&gt;qnormal
comma
id|skb
)paren
suffix:semicolon
id|sch-&gt;q.qlen
op_increment
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Check the look aside buffer list, and see if any freshly baked buffers.&n; * If head of queue is not baked, set timer.&n; */
DECL|function|netem_get_delayed
r_static
r_struct
id|sk_buff
op_star
id|netem_get_delayed
c_func
(paren
r_struct
id|netem_sched_data
op_star
id|q
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|psched_time_t
id|now
suffix:semicolon
r_int
id|delay
suffix:semicolon
id|skb
op_assign
id|skb_peek
c_func
(paren
op_amp
id|q-&gt;qdelay
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
)paren
(brace
r_const
r_struct
id|netem_skb_cb
op_star
id|cb
op_assign
(paren
r_const
r_struct
id|netem_skb_cb
op_star
)paren
id|skb-&gt;cb
suffix:semicolon
id|PSCHED_GET_TIME
c_func
(paren
id|now
)paren
suffix:semicolon
id|delay
op_assign
id|PSCHED_US2JIFFIE
c_func
(paren
id|PSCHED_TDIFF
c_func
(paren
id|cb-&gt;time_to_send
comma
id|now
)paren
)paren
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;netem_dequeue: delay queue %p@%lu %ld&bslash;n&quot;
comma
id|skb
comma
id|jiffies
comma
id|delay
)paren
suffix:semicolon
multiline_comment|/* it&squot;s baked enough */
r_if
c_cond
(paren
id|delay
op_le
l_int|0
)paren
(brace
id|__skb_unlink
c_func
(paren
id|skb
comma
op_amp
id|q-&gt;qdelay
)paren
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|q-&gt;timer
)paren
suffix:semicolon
r_return
id|skb
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|timer_pending
c_func
(paren
op_amp
id|q-&gt;timer
)paren
)paren
(brace
id|q-&gt;timer.expires
op_assign
id|jiffies
op_plus
id|delay
suffix:semicolon
id|add_timer
c_func
(paren
op_amp
id|q-&gt;timer
)paren
suffix:semicolon
)brace
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* Dequeue packet.&n; * If packet needs to be held up, then put in the delay&n; * queue and set timer to wakeup later.&n; */
DECL|function|netem_dequeue
r_static
r_struct
id|sk_buff
op_star
id|netem_dequeue
c_func
(paren
r_struct
id|Qdisc
op_star
id|sch
)paren
(brace
r_struct
id|netem_sched_data
op_star
id|q
op_assign
(paren
r_struct
id|netem_sched_data
op_star
)paren
id|sch-&gt;data
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|skb
op_assign
id|netem_get_delayed
c_func
(paren
id|q
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
op_logical_and
(paren
id|skb
op_assign
id|__skb_dequeue
c_func
(paren
op_amp
id|q-&gt;qnormal
)paren
)paren
)paren
(brace
multiline_comment|/* are we doing out of order packet skip? */
r_if
c_cond
(paren
id|q-&gt;counter
OL
id|q-&gt;gap
)paren
(brace
id|pr_debug
c_func
(paren
l_string|&quot;netem_dequeue: send %p normally&bslash;n&quot;
comma
id|skb
)paren
suffix:semicolon
id|q-&gt;counter
op_increment
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* don&squot;t send now hold for later */
id|pr_debug
c_func
(paren
l_string|&quot;netem_dequeue: hold [%p]@%lu&bslash;n&quot;
comma
id|skb
comma
id|jiffies
)paren
suffix:semicolon
id|__skb_queue_tail
c_func
(paren
op_amp
id|q-&gt;qdelay
comma
id|skb
)paren
suffix:semicolon
id|q-&gt;counter
op_assign
l_int|0
suffix:semicolon
id|skb
op_assign
id|netem_get_delayed
c_func
(paren
id|q
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|skb
)paren
id|sch-&gt;q.qlen
op_decrement
suffix:semicolon
r_return
id|skb
suffix:semicolon
)brace
DECL|function|netem_timer
r_static
r_void
id|netem_timer
c_func
(paren
r_int
r_int
id|arg
)paren
(brace
r_struct
id|Qdisc
op_star
id|sch
op_assign
(paren
r_struct
id|Qdisc
op_star
)paren
id|arg
suffix:semicolon
id|pr_debug
c_func
(paren
l_string|&quot;netem_timer: fired @%lu&bslash;n&quot;
comma
id|jiffies
)paren
suffix:semicolon
id|netif_schedule
c_func
(paren
id|sch-&gt;dev
)paren
suffix:semicolon
)brace
DECL|function|netem_reset
r_static
r_void
id|netem_reset
c_func
(paren
r_struct
id|Qdisc
op_star
id|sch
)paren
(brace
r_struct
id|netem_sched_data
op_star
id|q
op_assign
(paren
r_struct
id|netem_sched_data
op_star
)paren
id|sch-&gt;data
suffix:semicolon
id|skb_queue_purge
c_func
(paren
op_amp
id|q-&gt;qnormal
)paren
suffix:semicolon
id|skb_queue_purge
c_func
(paren
op_amp
id|q-&gt;qdelay
)paren
suffix:semicolon
id|sch-&gt;q.qlen
op_assign
l_int|0
suffix:semicolon
id|del_timer_sync
c_func
(paren
op_amp
id|q-&gt;timer
)paren
suffix:semicolon
)brace
DECL|function|netem_change
r_static
r_int
id|netem_change
c_func
(paren
r_struct
id|Qdisc
op_star
id|sch
comma
r_struct
id|rtattr
op_star
id|opt
)paren
(brace
r_struct
id|netem_sched_data
op_star
id|q
op_assign
(paren
r_struct
id|netem_sched_data
op_star
)paren
id|sch-&gt;data
suffix:semicolon
r_struct
id|tc_netem_qopt
op_star
id|qopt
op_assign
id|RTA_DATA
c_func
(paren
id|opt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|qopt-&gt;limit
)paren
id|sch-&gt;dev-&gt;tx_queue_len
op_assign
id|qopt-&gt;limit
suffix:semicolon
id|q-&gt;gap
op_assign
id|qopt-&gt;gap
suffix:semicolon
id|q-&gt;loss
op_assign
id|qopt-&gt;loss
suffix:semicolon
id|q-&gt;latency
op_assign
id|qopt-&gt;latency
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|netem_init
r_static
r_int
id|netem_init
c_func
(paren
r_struct
id|Qdisc
op_star
id|sch
comma
r_struct
id|rtattr
op_star
id|opt
)paren
(brace
r_struct
id|netem_sched_data
op_star
id|q
op_assign
(paren
r_struct
id|netem_sched_data
op_star
)paren
id|sch-&gt;data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|opt
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|skb_queue_head_init
c_func
(paren
op_amp
id|q-&gt;qnormal
)paren
suffix:semicolon
id|skb_queue_head_init
c_func
(paren
op_amp
id|q-&gt;qdelay
)paren
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|q-&gt;timer
)paren
suffix:semicolon
id|q-&gt;timer.function
op_assign
id|netem_timer
suffix:semicolon
id|q-&gt;timer.data
op_assign
(paren
r_int
r_int
)paren
id|sch
suffix:semicolon
id|q-&gt;counter
op_assign
l_int|0
suffix:semicolon
r_return
id|netem_change
c_func
(paren
id|sch
comma
id|opt
)paren
suffix:semicolon
)brace
DECL|function|netem_destroy
r_static
r_void
id|netem_destroy
c_func
(paren
r_struct
id|Qdisc
op_star
id|sch
)paren
(brace
r_struct
id|netem_sched_data
op_star
id|q
op_assign
(paren
r_struct
id|netem_sched_data
op_star
)paren
id|sch-&gt;data
suffix:semicolon
id|del_timer_sync
c_func
(paren
op_amp
id|q-&gt;timer
)paren
suffix:semicolon
)brace
DECL|function|netem_dump
r_static
r_int
id|netem_dump
c_func
(paren
r_struct
id|Qdisc
op_star
id|sch
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|netem_sched_data
op_star
id|q
op_assign
(paren
r_struct
id|netem_sched_data
op_star
)paren
id|sch-&gt;data
suffix:semicolon
r_int
r_char
op_star
id|b
op_assign
id|skb-&gt;tail
suffix:semicolon
r_struct
id|tc_netem_qopt
id|qopt
suffix:semicolon
id|qopt.latency
op_assign
id|q-&gt;latency
suffix:semicolon
id|qopt.limit
op_assign
id|sch-&gt;dev-&gt;tx_queue_len
suffix:semicolon
id|qopt.loss
op_assign
id|q-&gt;loss
suffix:semicolon
id|qopt.gap
op_assign
id|q-&gt;gap
suffix:semicolon
id|RTA_PUT
c_func
(paren
id|skb
comma
id|TCA_OPTIONS
comma
r_sizeof
(paren
id|qopt
)paren
comma
op_amp
id|qopt
)paren
suffix:semicolon
r_return
id|skb-&gt;len
suffix:semicolon
id|rtattr_failure
suffix:colon
id|skb_trim
c_func
(paren
id|skb
comma
id|b
op_minus
id|skb-&gt;data
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
DECL|variable|netem_qdisc_ops
r_static
r_struct
id|Qdisc_ops
id|netem_qdisc_ops
op_assign
(brace
dot
id|id
op_assign
l_string|&quot;netem&quot;
comma
dot
id|priv_size
op_assign
r_sizeof
(paren
r_struct
id|netem_sched_data
)paren
comma
dot
id|enqueue
op_assign
id|netem_enqueue
comma
dot
id|dequeue
op_assign
id|netem_dequeue
comma
dot
id|requeue
op_assign
id|netem_requeue
comma
dot
id|init
op_assign
id|netem_init
comma
dot
id|reset
op_assign
id|netem_reset
comma
dot
id|destroy
op_assign
id|netem_destroy
comma
dot
id|change
op_assign
id|netem_change
comma
dot
id|dump
op_assign
id|netem_dump
comma
dot
id|owner
op_assign
id|THIS_MODULE
comma
)brace
suffix:semicolon
DECL|function|netem_module_init
r_static
r_int
id|__init
id|netem_module_init
c_func
(paren
r_void
)paren
(brace
r_return
id|register_qdisc
c_func
(paren
op_amp
id|netem_qdisc_ops
)paren
suffix:semicolon
)brace
DECL|function|netem_module_exit
r_static
r_void
id|__exit
id|netem_module_exit
c_func
(paren
r_void
)paren
(brace
id|unregister_qdisc
c_func
(paren
op_amp
id|netem_qdisc_ops
)paren
suffix:semicolon
)brace
id|module_init
c_func
(paren
id|netem_module_init
)paren
id|module_exit
c_func
(paren
id|netem_module_exit
)paren
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
eof
