multiline_comment|/*&n; * net/sched/sch_delay.c&t;Simple constant delay&n; *&n; * &t;&t;This program is free software; you can redistribute it and/or&n; * &t;&t;modify it under the terms of the GNU General Public License&n; * &t;&t;as published by the Free Software Foundation; either version&n; * &t;&t;2 of the License, or (at your option) any later version.&n; *&n; * Authors:&t;Stephen Hemminger &lt;shemminger@osdl.org&gt;&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/socket.h&gt;
macro_line|#include &lt;linux/sockios.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/if_ether.h&gt;
macro_line|#include &lt;linux/inet.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/notifier.h&gt;
macro_line|#include &lt;net/ip.h&gt;
macro_line|#include &lt;net/route.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;net/sock.h&gt;
macro_line|#include &lt;net/pkt_sched.h&gt;
multiline_comment|/*&t;Network delay simulator&n;&t;This scheduler adds a fixed delay to all packets.&n;&t;Similar to NISTnet and BSD Dummynet.&n;&n;&t;It uses byte fifo underneath similar to TBF */
DECL|struct|dly_sched_data
r_struct
id|dly_sched_data
(brace
DECL|member|latency
id|u32
id|latency
suffix:semicolon
DECL|member|limit
id|u32
id|limit
suffix:semicolon
DECL|member|timer
r_struct
id|timer_list
id|timer
suffix:semicolon
DECL|member|qdisc
r_struct
id|Qdisc
op_star
id|qdisc
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* Time stamp put into socket buffer control block */
DECL|struct|dly_skb_cb
r_struct
id|dly_skb_cb
(brace
DECL|member|queuetime
id|psched_time_t
id|queuetime
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/* Enqueue packets with underlying discipline (fifo)&n; * but mark them with current time first.&n; */
DECL|function|dly_enqueue
r_static
r_int
id|dly_enqueue
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|Qdisc
op_star
id|sch
)paren
(brace
r_struct
id|dly_sched_data
op_star
id|q
op_assign
(paren
r_struct
id|dly_sched_data
op_star
)paren
id|sch-&gt;data
suffix:semicolon
r_struct
id|dly_skb_cb
op_star
id|cb
op_assign
(paren
r_struct
id|dly_skb_cb
op_star
)paren
id|skb-&gt;cb
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|PSCHED_GET_TIME
c_func
(paren
id|cb-&gt;queuetime
)paren
suffix:semicolon
multiline_comment|/* Queue to underlying scheduler */
id|ret
op_assign
id|q-&gt;qdisc
op_member_access_from_pointer
id|enqueue
c_func
(paren
id|skb
comma
id|q-&gt;qdisc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
id|sch-&gt;stats.drops
op_increment
suffix:semicolon
r_else
(brace
id|sch-&gt;q.qlen
op_increment
suffix:semicolon
id|sch-&gt;stats.bytes
op_add_assign
id|skb-&gt;len
suffix:semicolon
id|sch-&gt;stats.packets
op_increment
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* Requeue packets but don&squot;t change time stamp */
DECL|function|dly_requeue
r_static
r_int
id|dly_requeue
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|Qdisc
op_star
id|sch
)paren
(brace
r_struct
id|dly_sched_data
op_star
id|q
op_assign
(paren
r_struct
id|dly_sched_data
op_star
)paren
id|sch-&gt;data
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|ret
op_assign
id|q-&gt;qdisc-&gt;ops
op_member_access_from_pointer
id|requeue
c_func
(paren
id|skb
comma
id|q-&gt;qdisc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
l_int|0
)paren
id|sch-&gt;q.qlen
op_increment
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|dly_drop
r_static
r_int
r_int
id|dly_drop
c_func
(paren
r_struct
id|Qdisc
op_star
id|sch
)paren
(brace
r_struct
id|dly_sched_data
op_star
id|q
op_assign
(paren
r_struct
id|dly_sched_data
op_star
)paren
id|sch-&gt;data
suffix:semicolon
r_int
r_int
id|len
suffix:semicolon
id|len
op_assign
id|q-&gt;qdisc-&gt;ops
op_member_access_from_pointer
id|drop
c_func
(paren
id|q-&gt;qdisc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
)paren
(brace
id|sch-&gt;q.qlen
op_decrement
suffix:semicolon
id|sch-&gt;stats.drops
op_increment
suffix:semicolon
)brace
r_return
id|len
suffix:semicolon
)brace
multiline_comment|/* Dequeue packet.&n; * If packet needs to be held up, then stop the&n; * queue and set timer to wakeup later.&n; */
DECL|function|dly_dequeue
r_static
r_struct
id|sk_buff
op_star
id|dly_dequeue
c_func
(paren
r_struct
id|Qdisc
op_star
id|sch
)paren
(brace
r_struct
id|dly_sched_data
op_star
id|q
op_assign
(paren
r_struct
id|dly_sched_data
op_star
)paren
id|sch-&gt;data
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|retry
suffix:colon
id|skb
op_assign
id|q-&gt;qdisc
op_member_access_from_pointer
id|dequeue
c_func
(paren
id|q-&gt;qdisc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
)paren
(brace
r_struct
id|dly_skb_cb
op_star
id|cb
op_assign
(paren
r_struct
id|dly_skb_cb
op_star
)paren
id|skb-&gt;cb
suffix:semicolon
id|psched_time_t
id|now
suffix:semicolon
r_int
id|diff
suffix:semicolon
id|PSCHED_GET_TIME
c_func
(paren
id|now
)paren
suffix:semicolon
id|diff
op_assign
id|q-&gt;latency
op_minus
id|PSCHED_TDIFF
c_func
(paren
id|now
comma
id|cb-&gt;queuetime
)paren
suffix:semicolon
r_if
c_cond
(paren
id|diff
op_le
l_int|0
)paren
(brace
id|sch-&gt;q.qlen
op_decrement
suffix:semicolon
id|sch-&gt;flags
op_and_assign
op_complement
id|TCQ_F_THROTTLED
suffix:semicolon
r_return
id|skb
suffix:semicolon
)brace
r_if
c_cond
(paren
id|q-&gt;qdisc-&gt;ops
op_member_access_from_pointer
id|requeue
c_func
(paren
id|skb
comma
id|q-&gt;qdisc
)paren
op_ne
id|NET_XMIT_SUCCESS
)paren
(brace
id|sch-&gt;q.qlen
op_decrement
suffix:semicolon
id|sch-&gt;stats.drops
op_increment
suffix:semicolon
r_goto
id|retry
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|netif_queue_stopped
c_func
(paren
id|sch-&gt;dev
)paren
)paren
(brace
r_int
id|delay
op_assign
id|PSCHED_US2JIFFIE
c_func
(paren
id|diff
)paren
suffix:semicolon
r_if
c_cond
(paren
id|delay
op_le
l_int|0
)paren
id|delay
op_assign
l_int|1
suffix:semicolon
id|mod_timer
c_func
(paren
op_amp
id|q-&gt;timer
comma
id|jiffies
op_plus
id|delay
)paren
suffix:semicolon
)brace
id|sch-&gt;flags
op_or_assign
id|TCQ_F_THROTTLED
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|dly_reset
r_static
r_void
id|dly_reset
c_func
(paren
r_struct
id|Qdisc
op_star
id|sch
)paren
(brace
r_struct
id|dly_sched_data
op_star
id|q
op_assign
(paren
r_struct
id|dly_sched_data
op_star
)paren
id|sch-&gt;data
suffix:semicolon
id|qdisc_reset
c_func
(paren
id|q-&gt;qdisc
)paren
suffix:semicolon
id|sch-&gt;q.qlen
op_assign
l_int|0
suffix:semicolon
id|sch-&gt;flags
op_and_assign
op_complement
id|TCQ_F_THROTTLED
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|q-&gt;timer
)paren
suffix:semicolon
)brace
DECL|function|dly_timer
r_static
r_void
id|dly_timer
c_func
(paren
r_int
r_int
id|arg
)paren
(brace
r_struct
id|Qdisc
op_star
id|sch
op_assign
(paren
r_struct
id|Qdisc
op_star
)paren
id|arg
suffix:semicolon
id|sch-&gt;flags
op_and_assign
op_complement
id|TCQ_F_THROTTLED
suffix:semicolon
id|netif_schedule
c_func
(paren
id|sch-&gt;dev
)paren
suffix:semicolon
)brace
multiline_comment|/* Tell Fifo the new limit. */
DECL|function|change_limit
r_static
r_int
id|change_limit
c_func
(paren
r_struct
id|Qdisc
op_star
id|q
comma
id|u32
id|limit
)paren
(brace
r_struct
id|rtattr
op_star
id|rta
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|rta
op_assign
id|kmalloc
c_func
(paren
id|RTA_LENGTH
c_func
(paren
r_sizeof
(paren
r_struct
id|tc_fifo_qopt
)paren
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rta
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|rta-&gt;rta_type
op_assign
id|RTM_NEWQDISC
suffix:semicolon
id|rta-&gt;rta_len
op_assign
id|RTA_LENGTH
c_func
(paren
r_sizeof
(paren
r_struct
id|tc_fifo_qopt
)paren
)paren
suffix:semicolon
(paren
(paren
r_struct
id|tc_fifo_qopt
op_star
)paren
id|RTA_DATA
c_func
(paren
id|rta
)paren
)paren
op_member_access_from_pointer
id|limit
op_assign
id|limit
suffix:semicolon
id|ret
op_assign
id|q-&gt;ops
op_member_access_from_pointer
id|change
c_func
(paren
id|q
comma
id|rta
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|rta
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* Setup underlying FIFO discipline */
DECL|function|dly_change
r_static
r_int
id|dly_change
c_func
(paren
r_struct
id|Qdisc
op_star
id|sch
comma
r_struct
id|rtattr
op_star
id|opt
)paren
(brace
r_struct
id|dly_sched_data
op_star
id|q
op_assign
(paren
r_struct
id|dly_sched_data
op_star
)paren
id|sch-&gt;data
suffix:semicolon
r_struct
id|tc_dly_qopt
op_star
id|qopt
op_assign
id|RTA_DATA
c_func
(paren
id|opt
)paren
suffix:semicolon
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
id|q-&gt;qdisc
op_eq
op_amp
id|noop_qdisc
)paren
(brace
r_struct
id|Qdisc
op_star
id|child
op_assign
id|qdisc_create_dflt
c_func
(paren
id|sch-&gt;dev
comma
op_amp
id|bfifo_qdisc_ops
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|child
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|q-&gt;qdisc
op_assign
id|child
suffix:semicolon
)brace
id|err
op_assign
id|change_limit
c_func
(paren
id|q-&gt;qdisc
comma
id|qopt-&gt;limit
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|qdisc_destroy
c_func
(paren
id|q-&gt;qdisc
)paren
suffix:semicolon
id|q-&gt;qdisc
op_assign
op_amp
id|noop_qdisc
suffix:semicolon
)brace
r_else
(brace
id|q-&gt;latency
op_assign
id|qopt-&gt;latency
suffix:semicolon
id|q-&gt;limit
op_assign
id|qopt-&gt;limit
suffix:semicolon
)brace
r_return
id|err
suffix:semicolon
)brace
DECL|function|dly_init
r_static
r_int
id|dly_init
c_func
(paren
r_struct
id|Qdisc
op_star
id|sch
comma
r_struct
id|rtattr
op_star
id|opt
)paren
(brace
r_struct
id|dly_sched_data
op_star
id|q
op_assign
(paren
r_struct
id|dly_sched_data
op_star
)paren
id|sch-&gt;data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|opt
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|init_timer
c_func
(paren
op_amp
id|q-&gt;timer
)paren
suffix:semicolon
id|q-&gt;timer.function
op_assign
id|dly_timer
suffix:semicolon
id|q-&gt;timer.data
op_assign
(paren
r_int
r_int
)paren
id|sch
suffix:semicolon
id|q-&gt;qdisc
op_assign
op_amp
id|noop_qdisc
suffix:semicolon
r_return
id|dly_change
c_func
(paren
id|sch
comma
id|opt
)paren
suffix:semicolon
)brace
DECL|function|dly_destroy
r_static
r_void
id|dly_destroy
c_func
(paren
r_struct
id|Qdisc
op_star
id|sch
)paren
(brace
r_struct
id|dly_sched_data
op_star
id|q
op_assign
(paren
r_struct
id|dly_sched_data
op_star
)paren
id|sch-&gt;data
suffix:semicolon
id|del_timer
c_func
(paren
op_amp
id|q-&gt;timer
)paren
suffix:semicolon
id|qdisc_destroy
c_func
(paren
id|q-&gt;qdisc
)paren
suffix:semicolon
id|q-&gt;qdisc
op_assign
op_amp
id|noop_qdisc
suffix:semicolon
)brace
DECL|function|dly_dump
r_static
r_int
id|dly_dump
c_func
(paren
r_struct
id|Qdisc
op_star
id|sch
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|dly_sched_data
op_star
id|q
op_assign
(paren
r_struct
id|dly_sched_data
op_star
)paren
id|sch-&gt;data
suffix:semicolon
r_int
r_char
op_star
id|b
op_assign
id|skb-&gt;tail
suffix:semicolon
r_struct
id|tc_dly_qopt
id|qopt
suffix:semicolon
id|qopt.latency
op_assign
id|q-&gt;latency
suffix:semicolon
id|qopt.limit
op_assign
id|q-&gt;limit
suffix:semicolon
id|RTA_PUT
c_func
(paren
id|skb
comma
id|TCA_OPTIONS
comma
r_sizeof
(paren
id|qopt
)paren
comma
op_amp
id|qopt
)paren
suffix:semicolon
r_return
id|skb-&gt;len
suffix:semicolon
id|rtattr_failure
suffix:colon
id|skb_trim
c_func
(paren
id|skb
comma
id|b
op_minus
id|skb-&gt;data
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
DECL|variable|dly_qdisc_ops
r_static
r_struct
id|Qdisc_ops
id|dly_qdisc_ops
op_assign
(brace
dot
id|id
op_assign
l_string|&quot;delay&quot;
comma
dot
id|priv_size
op_assign
r_sizeof
(paren
r_struct
id|dly_sched_data
)paren
comma
dot
id|enqueue
op_assign
id|dly_enqueue
comma
dot
id|dequeue
op_assign
id|dly_dequeue
comma
dot
id|requeue
op_assign
id|dly_requeue
comma
dot
id|drop
op_assign
id|dly_drop
comma
dot
id|init
op_assign
id|dly_init
comma
dot
id|reset
op_assign
id|dly_reset
comma
dot
id|destroy
op_assign
id|dly_destroy
comma
dot
id|change
op_assign
id|dly_change
comma
dot
id|dump
op_assign
id|dly_dump
comma
dot
id|owner
op_assign
id|THIS_MODULE
comma
)brace
suffix:semicolon
DECL|function|dly_module_init
r_static
r_int
id|__init
id|dly_module_init
c_func
(paren
r_void
)paren
(brace
r_return
id|register_qdisc
c_func
(paren
op_amp
id|dly_qdisc_ops
)paren
suffix:semicolon
)brace
DECL|function|dly_module_exit
r_static
r_void
id|__exit
id|dly_module_exit
c_func
(paren
r_void
)paren
(brace
id|unregister_qdisc
c_func
(paren
op_amp
id|dly_qdisc_ops
)paren
suffix:semicolon
)brace
id|module_init
c_func
(paren
id|dly_module_init
)paren
id|module_exit
c_func
(paren
id|dly_module_exit
)paren
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
eof
