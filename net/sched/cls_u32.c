multiline_comment|/*&n; * net/sched/cls_u32.c&t;Ugly (or Universal) 32bit key Packet Classifier.&n; *&n; *&t;&t;This program is free software; you can redistribute it and/or&n; *&t;&t;modify it under the terms of the GNU General Public License&n; *&t;&t;as published by the Free Software Foundation; either version&n; *&t;&t;2 of the License, or (at your option) any later version.&n; *&n; * Authors:&t;Alexey Kuznetsov, &lt;kuznet@ms2.inr.ac.ru&gt;&n; *&n; *&t;The filters are packed to hash tables of key nodes&n; *&t;with a set of 32bit key/mask pairs at every node.&n; *&t;Nodes reference next level hash tables etc.&n; *&n; *&t;This scheme is the best universal classifier I managed to&n; *&t;invent; it is not super-fast, but it is not slow (provided you&n; *&t;program it correctly), and general enough.  And its relative&n; *&t;speed grows as the number of rules becomes larger.&n; *&n; *&t;It seems that it represents the best middle point between&n; *&t;speed and manageability both by human and by machine.&n; *&n; *&t;It is especially useful for link sharing combined with QoS;&n; *&t;pure RSVP doesn&squot;t need such a general approach and can use&n; *&t;much simpler (and faster) schemes, sort of cls_rsvp.c.&n; *&n; *&t;JHS: We should remove the CONFIG_NET_CLS_IND from here&n; *&t;eventually when the meta match extension is made available&n; *&n; */
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/socket.h&gt;
macro_line|#include &lt;linux/sockios.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &lt;linux/if_ether.h&gt;
macro_line|#include &lt;linux/inet.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/etherdevice.h&gt;
macro_line|#include &lt;linux/notifier.h&gt;
macro_line|#include &lt;linux/rtnetlink.h&gt;
macro_line|#include &lt;net/ip.h&gt;
macro_line|#include &lt;net/route.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;net/sock.h&gt;
macro_line|#include &lt;net/pkt_sched.h&gt;
DECL|struct|tc_u_knode
r_struct
id|tc_u_knode
(brace
DECL|member|next
r_struct
id|tc_u_knode
op_star
id|next
suffix:semicolon
DECL|member|handle
id|u32
id|handle
suffix:semicolon
DECL|member|ht_up
r_struct
id|tc_u_hnode
op_star
id|ht_up
suffix:semicolon
macro_line|#ifdef CONFIG_NET_CLS_ACT
DECL|member|action
r_struct
id|tc_action
op_star
id|action
suffix:semicolon
macro_line|#ifdef CONFIG_NET_CLS_IND
DECL|member|indev
r_char
id|indev
(braket
id|IFNAMSIZ
)braket
suffix:semicolon
macro_line|#endif
macro_line|#else
macro_line|#ifdef CONFIG_NET_CLS_POLICE
DECL|member|police
r_struct
id|tcf_police
op_star
id|police
suffix:semicolon
macro_line|#endif
macro_line|#endif
DECL|member|fshift
id|u8
id|fshift
suffix:semicolon
DECL|member|res
r_struct
id|tcf_result
id|res
suffix:semicolon
DECL|member|ht_down
r_struct
id|tc_u_hnode
op_star
id|ht_down
suffix:semicolon
DECL|member|sel
r_struct
id|tc_u32_sel
id|sel
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|tc_u_hnode
r_struct
id|tc_u_hnode
(brace
DECL|member|next
r_struct
id|tc_u_hnode
op_star
id|next
suffix:semicolon
DECL|member|handle
id|u32
id|handle
suffix:semicolon
DECL|member|tp_c
r_struct
id|tc_u_common
op_star
id|tp_c
suffix:semicolon
DECL|member|refcnt
r_int
id|refcnt
suffix:semicolon
DECL|member|divisor
r_int
id|divisor
suffix:semicolon
DECL|member|hgenerator
id|u32
id|hgenerator
suffix:semicolon
DECL|member|ht
r_struct
id|tc_u_knode
op_star
id|ht
(braket
l_int|1
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|tc_u_common
r_struct
id|tc_u_common
(brace
DECL|member|next
r_struct
id|tc_u_common
op_star
id|next
suffix:semicolon
DECL|member|hlist
r_struct
id|tc_u_hnode
op_star
id|hlist
suffix:semicolon
DECL|member|q
r_struct
id|Qdisc
op_star
id|q
suffix:semicolon
DECL|member|refcnt
r_int
id|refcnt
suffix:semicolon
DECL|member|hgenerator
id|u32
id|hgenerator
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|u32_list
r_static
r_struct
id|tc_u_common
op_star
id|u32_list
suffix:semicolon
DECL|function|u32_hash_fold
r_static
id|__inline__
r_int
id|u32_hash_fold
c_func
(paren
id|u32
id|key
comma
r_struct
id|tc_u32_sel
op_star
id|sel
comma
id|u8
id|fshift
)paren
(brace
macro_line|#ifndef fix_u32_bug
r_int
id|h
op_assign
(paren
id|key
op_amp
id|sel-&gt;hmask
)paren
op_rshift
id|fshift
suffix:semicolon
macro_line|#else
r_int
id|h
op_assign
(paren
id|key
op_amp
id|sel-&gt;hmask
)paren
suffix:semicolon
id|h
op_xor_assign
id|h
op_rshift
l_int|16
suffix:semicolon
id|h
op_xor_assign
id|h
op_rshift
l_int|8
suffix:semicolon
macro_line|#endif
r_return
id|h
suffix:semicolon
)brace
DECL|function|u32_classify
r_static
r_int
id|u32_classify
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|tcf_proto
op_star
id|tp
comma
r_struct
id|tcf_result
op_star
id|res
)paren
(brace
r_struct
(brace
r_struct
id|tc_u_knode
op_star
id|knode
suffix:semicolon
id|u8
op_star
id|ptr
suffix:semicolon
)brace
id|stack
(braket
id|TC_U32_MAXDEPTH
)braket
suffix:semicolon
r_struct
id|tc_u_hnode
op_star
id|ht
op_assign
(paren
r_struct
id|tc_u_hnode
op_star
)paren
id|tp-&gt;root
suffix:semicolon
id|u8
op_star
id|ptr
op_assign
id|skb-&gt;nh.raw
suffix:semicolon
r_struct
id|tc_u_knode
op_star
id|n
suffix:semicolon
r_int
id|sdepth
op_assign
l_int|0
suffix:semicolon
r_int
id|off2
op_assign
l_int|0
suffix:semicolon
r_int
id|sel
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
id|next_ht
suffix:colon
id|n
op_assign
id|ht-&gt;ht
(braket
id|sel
)braket
suffix:semicolon
id|next_knode
suffix:colon
r_if
c_cond
(paren
id|n
)paren
(brace
r_struct
id|tc_u32_key
op_star
id|key
op_assign
id|n-&gt;sel.keys
suffix:semicolon
macro_line|#ifdef CONFIG_CLS_U32_PERF
id|n-&gt;sel.rcnt
op_add_assign
l_int|1
suffix:semicolon
macro_line|#endif
r_for
c_loop
(paren
id|i
op_assign
id|n-&gt;sel.nkeys
suffix:semicolon
id|i
OG
l_int|0
suffix:semicolon
id|i
op_decrement
comma
id|key
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
op_star
(paren
id|u32
op_star
)paren
(paren
id|ptr
op_plus
id|key-&gt;off
op_plus
(paren
id|off2
op_amp
id|key-&gt;offmask
)paren
)paren
op_xor
id|key-&gt;val
)paren
op_amp
id|key-&gt;mask
)paren
(brace
id|n
op_assign
id|n-&gt;next
suffix:semicolon
r_goto
id|next_knode
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_CLS_U32_PERF
id|key-&gt;kcnt
op_add_assign
l_int|1
suffix:semicolon
macro_line|#endif
)brace
r_if
c_cond
(paren
id|n-&gt;ht_down
op_eq
l_int|NULL
)paren
(brace
id|check_terminal
suffix:colon
r_if
c_cond
(paren
id|n-&gt;sel.flags
op_amp
id|TC_U32_TERMINAL
)paren
(brace
op_star
id|res
op_assign
id|n-&gt;res
suffix:semicolon
macro_line|#ifdef CONFIG_NET_CLS_ACT
macro_line|#ifdef CONFIG_NET_CLS_IND
multiline_comment|/* yes, i know it sucks but the feature is &n;&t;&t;&t;&t;** optional dammit! - JHS */
r_if
c_cond
(paren
l_int|0
op_ne
id|n-&gt;indev
(braket
l_int|0
)braket
)paren
(brace
r_if
c_cond
(paren
l_int|NULL
op_eq
id|skb-&gt;input_dev
)paren
(brace
id|n
op_assign
id|n-&gt;next
suffix:semicolon
r_goto
id|next_knode
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
l_int|0
op_ne
id|strcmp
c_func
(paren
id|n-&gt;indev
comma
id|skb-&gt;input_dev-&gt;name
)paren
)paren
(brace
id|n
op_assign
id|n-&gt;next
suffix:semicolon
r_goto
id|next_knode
suffix:semicolon
)brace
)brace
)brace
macro_line|#endif
macro_line|#ifdef CONFIG_CLS_U32_PERF
id|n-&gt;sel.rhit
op_add_assign
l_int|1
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|n-&gt;action
)paren
(brace
r_int
id|pol_res
op_assign
id|tcf_action_exec
c_func
(paren
id|skb
comma
id|n-&gt;action
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;tc_classid
OG
l_int|0
)paren
(brace
id|res-&gt;classid
op_assign
id|skb-&gt;tc_classid
suffix:semicolon
id|skb-&gt;tc_classid
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pol_res
op_ge
l_int|0
)paren
r_return
id|pol_res
suffix:semicolon
)brace
r_else
macro_line|#else
macro_line|#ifdef CONFIG_NET_CLS_POLICE
r_if
c_cond
(paren
id|n-&gt;police
)paren
(brace
r_int
id|pol_res
op_assign
id|tcf_police
c_func
(paren
id|skb
comma
id|n-&gt;police
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pol_res
op_ge
l_int|0
)paren
r_return
id|pol_res
suffix:semicolon
)brace
r_else
macro_line|#endif
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
id|n
op_assign
id|n-&gt;next
suffix:semicolon
r_goto
id|next_knode
suffix:semicolon
)brace
multiline_comment|/* PUSH */
r_if
c_cond
(paren
id|sdepth
op_ge
id|TC_U32_MAXDEPTH
)paren
r_goto
id|deadloop
suffix:semicolon
id|stack
(braket
id|sdepth
)braket
dot
id|knode
op_assign
id|n
suffix:semicolon
id|stack
(braket
id|sdepth
)braket
dot
id|ptr
op_assign
id|ptr
suffix:semicolon
id|sdepth
op_increment
suffix:semicolon
id|ht
op_assign
id|n-&gt;ht_down
suffix:semicolon
id|sel
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ht-&gt;divisor
)paren
id|sel
op_assign
id|ht-&gt;divisor
op_amp
id|u32_hash_fold
c_func
(paren
op_star
(paren
id|u32
op_star
)paren
(paren
id|ptr
op_plus
id|n-&gt;sel.hoff
)paren
comma
op_amp
id|n-&gt;sel
comma
id|n-&gt;fshift
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|n-&gt;sel.flags
op_amp
(paren
id|TC_U32_VAROFFSET
op_or
id|TC_U32_OFFSET
op_or
id|TC_U32_EAT
)paren
)paren
)paren
r_goto
id|next_ht
suffix:semicolon
r_if
c_cond
(paren
id|n-&gt;sel.flags
op_amp
(paren
id|TC_U32_OFFSET
op_or
id|TC_U32_VAROFFSET
)paren
)paren
(brace
id|off2
op_assign
id|n-&gt;sel.off
op_plus
l_int|3
suffix:semicolon
r_if
c_cond
(paren
id|n-&gt;sel.flags
op_amp
id|TC_U32_VAROFFSET
)paren
id|off2
op_add_assign
id|ntohs
c_func
(paren
id|n-&gt;sel.offmask
op_amp
op_star
(paren
id|u16
op_star
)paren
(paren
id|ptr
op_plus
id|n-&gt;sel.offoff
)paren
)paren
op_rshift
id|n-&gt;sel.offshift
suffix:semicolon
id|off2
op_and_assign
op_complement
l_int|3
suffix:semicolon
)brace
r_if
c_cond
(paren
id|n-&gt;sel.flags
op_amp
id|TC_U32_EAT
)paren
(brace
id|ptr
op_add_assign
id|off2
suffix:semicolon
id|off2
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ptr
OL
id|skb-&gt;tail
)paren
r_goto
id|next_ht
suffix:semicolon
)brace
multiline_comment|/* POP */
r_if
c_cond
(paren
id|sdepth
op_decrement
)paren
(brace
id|n
op_assign
id|stack
(braket
id|sdepth
)braket
dot
id|knode
suffix:semicolon
id|ht
op_assign
id|n-&gt;ht_up
suffix:semicolon
id|ptr
op_assign
id|stack
(braket
id|sdepth
)braket
dot
id|ptr
suffix:semicolon
r_goto
id|check_terminal
suffix:semicolon
)brace
r_return
op_minus
l_int|1
suffix:semicolon
id|deadloop
suffix:colon
r_if
c_cond
(paren
id|net_ratelimit
c_func
(paren
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;cls_u32: dead loop&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_static
id|__inline__
r_struct
id|tc_u_hnode
op_star
DECL|function|u32_lookup_ht
id|u32_lookup_ht
c_func
(paren
r_struct
id|tc_u_common
op_star
id|tp_c
comma
id|u32
id|handle
)paren
(brace
r_struct
id|tc_u_hnode
op_star
id|ht
suffix:semicolon
r_for
c_loop
(paren
id|ht
op_assign
id|tp_c-&gt;hlist
suffix:semicolon
id|ht
suffix:semicolon
id|ht
op_assign
id|ht-&gt;next
)paren
r_if
c_cond
(paren
id|ht-&gt;handle
op_eq
id|handle
)paren
r_break
suffix:semicolon
r_return
id|ht
suffix:semicolon
)brace
r_static
id|__inline__
r_struct
id|tc_u_knode
op_star
DECL|function|u32_lookup_key
id|u32_lookup_key
c_func
(paren
r_struct
id|tc_u_hnode
op_star
id|ht
comma
id|u32
id|handle
)paren
(brace
r_int
id|sel
suffix:semicolon
r_struct
id|tc_u_knode
op_star
id|n
op_assign
l_int|NULL
suffix:semicolon
id|sel
op_assign
id|TC_U32_HASH
c_func
(paren
id|handle
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sel
OG
id|ht-&gt;divisor
)paren
r_goto
id|out
suffix:semicolon
r_for
c_loop
(paren
id|n
op_assign
id|ht-&gt;ht
(braket
id|sel
)braket
suffix:semicolon
id|n
suffix:semicolon
id|n
op_assign
id|n-&gt;next
)paren
r_if
c_cond
(paren
id|n-&gt;handle
op_eq
id|handle
)paren
r_break
suffix:semicolon
id|out
suffix:colon
r_return
id|n
suffix:semicolon
)brace
DECL|function|u32_get
r_static
r_int
r_int
id|u32_get
c_func
(paren
r_struct
id|tcf_proto
op_star
id|tp
comma
id|u32
id|handle
)paren
(brace
r_struct
id|tc_u_hnode
op_star
id|ht
suffix:semicolon
r_struct
id|tc_u_common
op_star
id|tp_c
op_assign
id|tp-&gt;data
suffix:semicolon
r_if
c_cond
(paren
id|TC_U32_HTID
c_func
(paren
id|handle
)paren
op_eq
id|TC_U32_ROOT
)paren
id|ht
op_assign
id|tp-&gt;root
suffix:semicolon
r_else
id|ht
op_assign
id|u32_lookup_ht
c_func
(paren
id|tp_c
comma
id|TC_U32_HTID
c_func
(paren
id|handle
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ht
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|TC_U32_KEY
c_func
(paren
id|handle
)paren
op_eq
l_int|0
)paren
r_return
(paren
r_int
r_int
)paren
id|ht
suffix:semicolon
r_return
(paren
r_int
r_int
)paren
id|u32_lookup_key
c_func
(paren
id|ht
comma
id|handle
)paren
suffix:semicolon
)brace
DECL|function|u32_put
r_static
r_void
id|u32_put
c_func
(paren
r_struct
id|tcf_proto
op_star
id|tp
comma
r_int
r_int
id|f
)paren
(brace
)brace
DECL|function|gen_new_htid
r_static
id|u32
id|gen_new_htid
c_func
(paren
r_struct
id|tc_u_common
op_star
id|tp_c
)paren
(brace
r_int
id|i
op_assign
l_int|0x800
suffix:semicolon
r_do
(brace
r_if
c_cond
(paren
op_increment
id|tp_c-&gt;hgenerator
op_eq
l_int|0x7FF
)paren
id|tp_c-&gt;hgenerator
op_assign
l_int|1
suffix:semicolon
)brace
r_while
c_loop
(paren
op_decrement
id|i
OG
l_int|0
op_logical_and
id|u32_lookup_ht
c_func
(paren
id|tp_c
comma
(paren
id|tp_c-&gt;hgenerator
op_or
l_int|0x800
)paren
op_lshift
l_int|20
)paren
)paren
suffix:semicolon
r_return
id|i
OG
l_int|0
ques
c_cond
(paren
id|tp_c-&gt;hgenerator
op_or
l_int|0x800
)paren
op_lshift
l_int|20
suffix:colon
l_int|0
suffix:semicolon
)brace
DECL|function|u32_init
r_static
r_int
id|u32_init
c_func
(paren
r_struct
id|tcf_proto
op_star
id|tp
)paren
(brace
r_struct
id|tc_u_hnode
op_star
id|root_ht
suffix:semicolon
r_struct
id|tc_u_common
op_star
id|tp_c
suffix:semicolon
r_for
c_loop
(paren
id|tp_c
op_assign
id|u32_list
suffix:semicolon
id|tp_c
suffix:semicolon
id|tp_c
op_assign
id|tp_c-&gt;next
)paren
r_if
c_cond
(paren
id|tp_c-&gt;q
op_eq
id|tp-&gt;q
)paren
r_break
suffix:semicolon
id|root_ht
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|root_ht
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|root_ht
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOBUFS
suffix:semicolon
id|memset
c_func
(paren
id|root_ht
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|root_ht
)paren
)paren
suffix:semicolon
id|root_ht-&gt;divisor
op_assign
l_int|0
suffix:semicolon
id|root_ht-&gt;refcnt
op_increment
suffix:semicolon
id|root_ht-&gt;handle
op_assign
id|tp_c
ques
c_cond
id|gen_new_htid
c_func
(paren
id|tp_c
)paren
suffix:colon
l_int|0x80000000
suffix:semicolon
r_if
c_cond
(paren
id|tp_c
op_eq
l_int|NULL
)paren
(brace
id|tp_c
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|tp_c
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tp_c
op_eq
l_int|NULL
)paren
(brace
id|kfree
c_func
(paren
id|root_ht
)paren
suffix:semicolon
r_return
op_minus
id|ENOBUFS
suffix:semicolon
)brace
id|memset
c_func
(paren
id|tp_c
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|tp_c
)paren
)paren
suffix:semicolon
id|tp_c-&gt;q
op_assign
id|tp-&gt;q
suffix:semicolon
id|tp_c-&gt;next
op_assign
id|u32_list
suffix:semicolon
id|u32_list
op_assign
id|tp_c
suffix:semicolon
)brace
id|tp_c-&gt;refcnt
op_increment
suffix:semicolon
id|root_ht-&gt;next
op_assign
id|tp_c-&gt;hlist
suffix:semicolon
id|tp_c-&gt;hlist
op_assign
id|root_ht
suffix:semicolon
id|root_ht-&gt;tp_c
op_assign
id|tp_c
suffix:semicolon
id|tp-&gt;root
op_assign
id|root_ht
suffix:semicolon
id|tp-&gt;data
op_assign
id|tp_c
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|u32_destroy_key
r_static
r_int
id|u32_destroy_key
c_func
(paren
r_struct
id|tcf_proto
op_star
id|tp
comma
r_struct
id|tc_u_knode
op_star
id|n
)paren
(brace
r_int
r_int
id|cl
suffix:semicolon
r_if
c_cond
(paren
(paren
id|cl
op_assign
id|__cls_set_class
c_func
(paren
op_amp
id|n-&gt;res
dot
r_class
comma
l_int|0
)paren
)paren
op_ne
l_int|0
)paren
id|tp-&gt;q-&gt;ops-&gt;cl_ops
op_member_access_from_pointer
id|unbind_tcf
c_func
(paren
id|tp-&gt;q
comma
id|cl
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_NET_CLS_ACT
r_if
c_cond
(paren
id|n-&gt;action
)paren
(brace
id|tcf_action_destroy
c_func
(paren
id|n-&gt;action
comma
id|TCA_ACT_UNBIND
)paren
suffix:semicolon
)brace
macro_line|#else
macro_line|#ifdef CONFIG_NET_CLS_POLICE
id|tcf_police_release
c_func
(paren
id|n-&gt;police
comma
id|TCA_ACT_UNBIND
)paren
suffix:semicolon
macro_line|#endif
macro_line|#endif
r_if
c_cond
(paren
id|n-&gt;ht_down
)paren
id|n-&gt;ht_down-&gt;refcnt
op_decrement
suffix:semicolon
id|kfree
c_func
(paren
id|n
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|u32_delete_key
r_static
r_int
id|u32_delete_key
c_func
(paren
r_struct
id|tcf_proto
op_star
id|tp
comma
r_struct
id|tc_u_knode
op_star
id|key
)paren
(brace
r_struct
id|tc_u_knode
op_star
op_star
id|kp
suffix:semicolon
r_struct
id|tc_u_hnode
op_star
id|ht
op_assign
id|key-&gt;ht_up
suffix:semicolon
r_if
c_cond
(paren
id|ht
)paren
(brace
r_for
c_loop
(paren
id|kp
op_assign
op_amp
id|ht-&gt;ht
(braket
id|TC_U32_HASH
c_func
(paren
id|key-&gt;handle
)paren
)braket
suffix:semicolon
op_star
id|kp
suffix:semicolon
id|kp
op_assign
op_amp
(paren
op_star
id|kp
)paren
op_member_access_from_pointer
id|next
)paren
(brace
r_if
c_cond
(paren
op_star
id|kp
op_eq
id|key
)paren
(brace
id|tcf_tree_lock
c_func
(paren
id|tp
)paren
suffix:semicolon
op_star
id|kp
op_assign
id|key-&gt;next
suffix:semicolon
id|tcf_tree_unlock
c_func
(paren
id|tp
)paren
suffix:semicolon
id|u32_destroy_key
c_func
(paren
id|tp
comma
id|key
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
)brace
id|BUG_TRAP
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|u32_clear_hnode
r_static
r_void
id|u32_clear_hnode
c_func
(paren
r_struct
id|tcf_proto
op_star
id|tp
comma
r_struct
id|tc_u_hnode
op_star
id|ht
)paren
(brace
r_struct
id|tc_u_knode
op_star
id|n
suffix:semicolon
r_int
id|h
suffix:semicolon
r_for
c_loop
(paren
id|h
op_assign
l_int|0
suffix:semicolon
id|h
op_le
id|ht-&gt;divisor
suffix:semicolon
id|h
op_increment
)paren
(brace
r_while
c_loop
(paren
(paren
id|n
op_assign
id|ht-&gt;ht
(braket
id|h
)braket
)paren
op_ne
l_int|NULL
)paren
(brace
id|ht-&gt;ht
(braket
id|h
)braket
op_assign
id|n-&gt;next
suffix:semicolon
id|u32_destroy_key
c_func
(paren
id|tp
comma
id|n
)paren
suffix:semicolon
)brace
)brace
)brace
DECL|function|u32_destroy_hnode
r_static
r_int
id|u32_destroy_hnode
c_func
(paren
r_struct
id|tcf_proto
op_star
id|tp
comma
r_struct
id|tc_u_hnode
op_star
id|ht
)paren
(brace
r_struct
id|tc_u_common
op_star
id|tp_c
op_assign
id|tp-&gt;data
suffix:semicolon
r_struct
id|tc_u_hnode
op_star
op_star
id|hn
suffix:semicolon
id|BUG_TRAP
c_func
(paren
op_logical_neg
id|ht-&gt;refcnt
)paren
suffix:semicolon
id|u32_clear_hnode
c_func
(paren
id|tp
comma
id|ht
)paren
suffix:semicolon
r_for
c_loop
(paren
id|hn
op_assign
op_amp
id|tp_c-&gt;hlist
suffix:semicolon
op_star
id|hn
suffix:semicolon
id|hn
op_assign
op_amp
(paren
op_star
id|hn
)paren
op_member_access_from_pointer
id|next
)paren
(brace
r_if
c_cond
(paren
op_star
id|hn
op_eq
id|ht
)paren
(brace
op_star
id|hn
op_assign
id|ht-&gt;next
suffix:semicolon
id|kfree
c_func
(paren
id|ht
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
id|BUG_TRAP
c_func
(paren
l_int|0
)paren
suffix:semicolon
r_return
op_minus
id|ENOENT
suffix:semicolon
)brace
DECL|function|u32_destroy
r_static
r_void
id|u32_destroy
c_func
(paren
r_struct
id|tcf_proto
op_star
id|tp
)paren
(brace
r_struct
id|tc_u_common
op_star
id|tp_c
op_assign
id|tp-&gt;data
suffix:semicolon
r_struct
id|tc_u_hnode
op_star
id|root_ht
op_assign
id|xchg
c_func
(paren
op_amp
id|tp-&gt;root
comma
l_int|NULL
)paren
suffix:semicolon
id|BUG_TRAP
c_func
(paren
id|root_ht
op_ne
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|root_ht
op_logical_and
op_decrement
id|root_ht-&gt;refcnt
op_eq
l_int|0
)paren
id|u32_destroy_hnode
c_func
(paren
id|tp
comma
id|root_ht
)paren
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|tp_c-&gt;refcnt
op_eq
l_int|0
)paren
(brace
r_struct
id|tc_u_hnode
op_star
id|ht
suffix:semicolon
r_struct
id|tc_u_common
op_star
op_star
id|tp_cp
suffix:semicolon
r_for
c_loop
(paren
id|tp_cp
op_assign
op_amp
id|u32_list
suffix:semicolon
op_star
id|tp_cp
suffix:semicolon
id|tp_cp
op_assign
op_amp
(paren
op_star
id|tp_cp
)paren
op_member_access_from_pointer
id|next
)paren
(brace
r_if
c_cond
(paren
op_star
id|tp_cp
op_eq
id|tp_c
)paren
(brace
op_star
id|tp_cp
op_assign
id|tp_c-&gt;next
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_for
c_loop
(paren
id|ht
op_assign
id|tp_c-&gt;hlist
suffix:semicolon
id|ht
suffix:semicolon
id|ht
op_assign
id|ht-&gt;next
)paren
id|u32_clear_hnode
c_func
(paren
id|tp
comma
id|ht
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|ht
op_assign
id|tp_c-&gt;hlist
)paren
op_ne
l_int|NULL
)paren
(brace
id|tp_c-&gt;hlist
op_assign
id|ht-&gt;next
suffix:semicolon
id|BUG_TRAP
c_func
(paren
id|ht-&gt;refcnt
op_eq
l_int|0
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|ht
)paren
suffix:semicolon
)brace
suffix:semicolon
id|kfree
c_func
(paren
id|tp_c
)paren
suffix:semicolon
)brace
id|tp-&gt;data
op_assign
l_int|NULL
suffix:semicolon
)brace
DECL|function|u32_delete
r_static
r_int
id|u32_delete
c_func
(paren
r_struct
id|tcf_proto
op_star
id|tp
comma
r_int
r_int
id|arg
)paren
(brace
r_struct
id|tc_u_hnode
op_star
id|ht
op_assign
(paren
r_struct
id|tc_u_hnode
op_star
)paren
id|arg
suffix:semicolon
r_if
c_cond
(paren
id|ht
op_eq
l_int|NULL
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|TC_U32_KEY
c_func
(paren
id|ht-&gt;handle
)paren
)paren
r_return
id|u32_delete_key
c_func
(paren
id|tp
comma
(paren
r_struct
id|tc_u_knode
op_star
)paren
id|ht
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tp-&gt;root
op_eq
id|ht
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|ht-&gt;refcnt
op_eq
l_int|0
)paren
id|u32_destroy_hnode
c_func
(paren
id|tp
comma
id|ht
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|gen_new_kid
r_static
id|u32
id|gen_new_kid
c_func
(paren
r_struct
id|tc_u_hnode
op_star
id|ht
comma
id|u32
id|handle
)paren
(brace
r_struct
id|tc_u_knode
op_star
id|n
suffix:semicolon
r_int
id|i
op_assign
l_int|0x7FF
suffix:semicolon
r_for
c_loop
(paren
id|n
op_assign
id|ht-&gt;ht
(braket
id|TC_U32_HASH
c_func
(paren
id|handle
)paren
)braket
suffix:semicolon
id|n
suffix:semicolon
id|n
op_assign
id|n-&gt;next
)paren
r_if
c_cond
(paren
id|i
OL
id|TC_U32_NODE
c_func
(paren
id|n-&gt;handle
)paren
)paren
id|i
op_assign
id|TC_U32_NODE
c_func
(paren
id|n-&gt;handle
)paren
suffix:semicolon
id|i
op_increment
suffix:semicolon
r_return
id|handle
op_or
(paren
id|i
OG
l_int|0xFFF
ques
c_cond
l_int|0xFFF
suffix:colon
id|i
)paren
suffix:semicolon
)brace
DECL|function|u32_set_parms
r_static
r_int
id|u32_set_parms
c_func
(paren
r_struct
id|Qdisc
op_star
id|q
comma
r_int
r_int
id|base
comma
r_struct
id|tc_u_hnode
op_star
id|ht
comma
r_struct
id|tc_u_knode
op_star
id|n
comma
r_struct
id|rtattr
op_star
op_star
id|tb
comma
r_struct
id|rtattr
op_star
id|est
)paren
(brace
macro_line|#ifdef CONFIG_NET_CLS_ACT
r_struct
id|tc_action
op_star
id|act
op_assign
l_int|NULL
suffix:semicolon
r_int
id|ret
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|tb
(braket
id|TCA_U32_LINK
op_minus
l_int|1
)braket
)paren
(brace
id|u32
id|handle
op_assign
op_star
(paren
id|u32
op_star
)paren
id|RTA_DATA
c_func
(paren
id|tb
(braket
id|TCA_U32_LINK
op_minus
l_int|1
)braket
)paren
suffix:semicolon
r_struct
id|tc_u_hnode
op_star
id|ht_down
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|TC_U32_KEY
c_func
(paren
id|handle
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|handle
)paren
(brace
id|ht_down
op_assign
id|u32_lookup_ht
c_func
(paren
id|ht-&gt;tp_c
comma
id|handle
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ht_down
op_eq
l_int|NULL
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|ht_down-&gt;refcnt
op_increment
suffix:semicolon
)brace
id|sch_tree_lock
c_func
(paren
id|q
)paren
suffix:semicolon
id|ht_down
op_assign
id|xchg
c_func
(paren
op_amp
id|n-&gt;ht_down
comma
id|ht_down
)paren
suffix:semicolon
id|sch_tree_unlock
c_func
(paren
id|q
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ht_down
)paren
id|ht_down-&gt;refcnt
op_decrement
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tb
(braket
id|TCA_U32_CLASSID
op_minus
l_int|1
)braket
)paren
(brace
r_int
r_int
id|cl
suffix:semicolon
id|n-&gt;res.classid
op_assign
op_star
(paren
id|u32
op_star
)paren
id|RTA_DATA
c_func
(paren
id|tb
(braket
id|TCA_U32_CLASSID
op_minus
l_int|1
)braket
)paren
suffix:semicolon
id|sch_tree_lock
c_func
(paren
id|q
)paren
suffix:semicolon
id|cl
op_assign
id|__cls_set_class
c_func
(paren
op_amp
id|n-&gt;res
dot
r_class
comma
id|q-&gt;ops-&gt;cl_ops
op_member_access_from_pointer
id|bind_tcf
c_func
(paren
id|q
comma
id|base
comma
id|n-&gt;res.classid
)paren
)paren
suffix:semicolon
id|sch_tree_unlock
c_func
(paren
id|q
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cl
)paren
id|q-&gt;ops-&gt;cl_ops
op_member_access_from_pointer
id|unbind_tcf
c_func
(paren
id|q
comma
id|cl
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_NET_CLS_ACT
multiline_comment|/*backward compatibility */
r_if
c_cond
(paren
id|tb
(braket
id|TCA_U32_POLICE
op_minus
l_int|1
)braket
)paren
(brace
id|act
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|act
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_eq
id|act
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|act
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|act
)paren
)paren
suffix:semicolon
id|ret
op_assign
id|tcf_action_init_1
c_func
(paren
id|tb
(braket
id|TCA_U32_POLICE
op_minus
l_int|1
)braket
comma
id|est
comma
id|act
comma
l_string|&quot;police&quot;
comma
id|TCA_ACT_NOREPLACE
comma
id|TCA_ACT_BIND
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|0
OG
id|ret
)paren
(brace
id|tcf_action_destroy
c_func
(paren
id|act
comma
id|TCA_ACT_UNBIND
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
id|act-&gt;type
op_assign
id|TCA_OLD_COMPAT
suffix:semicolon
id|sch_tree_lock
c_func
(paren
id|q
)paren
suffix:semicolon
id|act
op_assign
id|xchg
c_func
(paren
op_amp
id|n-&gt;action
comma
id|act
)paren
suffix:semicolon
id|sch_tree_unlock
c_func
(paren
id|q
)paren
suffix:semicolon
id|tcf_action_destroy
c_func
(paren
id|act
comma
id|TCA_ACT_UNBIND
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tb
(braket
id|TCA_U32_ACT
op_minus
l_int|1
)braket
)paren
(brace
id|act
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|act
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_eq
id|act
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|act
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|act
)paren
)paren
suffix:semicolon
id|ret
op_assign
id|tcf_action_init
c_func
(paren
id|tb
(braket
id|TCA_U32_ACT
op_minus
l_int|1
)braket
comma
id|est
comma
id|act
comma
l_int|NULL
comma
id|TCA_ACT_NOREPLACE
comma
id|TCA_ACT_BIND
)paren
suffix:semicolon
r_if
c_cond
(paren
l_int|0
OG
id|ret
)paren
(brace
id|tcf_action_destroy
c_func
(paren
id|act
comma
id|TCA_ACT_UNBIND
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
id|sch_tree_lock
c_func
(paren
id|q
)paren
suffix:semicolon
id|act
op_assign
id|xchg
c_func
(paren
op_amp
id|n-&gt;action
comma
id|act
)paren
suffix:semicolon
id|sch_tree_unlock
c_func
(paren
id|q
)paren
suffix:semicolon
id|tcf_action_destroy
c_func
(paren
id|act
comma
id|TCA_ACT_UNBIND
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_NET_CLS_IND
id|n-&gt;indev
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|tb
(braket
id|TCA_U32_INDEV
op_minus
l_int|1
)braket
)paren
(brace
r_struct
id|rtattr
op_star
id|input_dev
op_assign
id|tb
(braket
id|TCA_U32_INDEV
op_minus
l_int|1
)braket
suffix:semicolon
r_if
c_cond
(paren
id|RTA_PAYLOAD
c_func
(paren
id|input_dev
)paren
op_ge
id|IFNAMSIZ
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;cls_u32: bad indev name %s&bslash;n&quot;
comma
(paren
r_char
op_star
)paren
id|RTA_DATA
c_func
(paren
id|input_dev
)paren
)paren
suffix:semicolon
multiline_comment|/* should we clear state first? */
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|sprintf
c_func
(paren
id|n-&gt;indev
comma
l_string|&quot;%s&quot;
comma
(paren
r_char
op_star
)paren
id|RTA_DATA
c_func
(paren
id|input_dev
)paren
)paren
suffix:semicolon
)brace
macro_line|#endif
macro_line|#else
macro_line|#ifdef CONFIG_NET_CLS_POLICE
r_if
c_cond
(paren
id|tb
(braket
id|TCA_U32_POLICE
op_minus
l_int|1
)braket
)paren
(brace
r_struct
id|tcf_police
op_star
id|police
op_assign
id|tcf_police_locate
c_func
(paren
id|tb
(braket
id|TCA_U32_POLICE
op_minus
l_int|1
)braket
comma
id|est
)paren
suffix:semicolon
id|sch_tree_lock
c_func
(paren
id|q
)paren
suffix:semicolon
id|police
op_assign
id|xchg
c_func
(paren
op_amp
id|n-&gt;police
comma
id|police
)paren
suffix:semicolon
id|sch_tree_unlock
c_func
(paren
id|q
)paren
suffix:semicolon
id|tcf_police_release
c_func
(paren
id|police
comma
id|TCA_ACT_UNBIND
)paren
suffix:semicolon
)brace
macro_line|#endif
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|u32_change
r_static
r_int
id|u32_change
c_func
(paren
r_struct
id|tcf_proto
op_star
id|tp
comma
r_int
r_int
id|base
comma
id|u32
id|handle
comma
r_struct
id|rtattr
op_star
op_star
id|tca
comma
r_int
r_int
op_star
id|arg
)paren
(brace
r_struct
id|tc_u_common
op_star
id|tp_c
op_assign
id|tp-&gt;data
suffix:semicolon
r_struct
id|tc_u_hnode
op_star
id|ht
suffix:semicolon
r_struct
id|tc_u_knode
op_star
id|n
suffix:semicolon
r_struct
id|tc_u32_sel
op_star
id|s
suffix:semicolon
r_struct
id|rtattr
op_star
id|opt
op_assign
id|tca
(braket
id|TCA_OPTIONS
op_minus
l_int|1
)braket
suffix:semicolon
r_struct
id|rtattr
op_star
id|tb
(braket
id|TCA_U32_MAX
)braket
suffix:semicolon
id|u32
id|htid
suffix:semicolon
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
id|opt
op_eq
l_int|NULL
)paren
r_return
id|handle
ques
c_cond
op_minus
id|EINVAL
suffix:colon
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|rtattr_parse
c_func
(paren
id|tb
comma
id|TCA_U32_MAX
comma
id|RTA_DATA
c_func
(paren
id|opt
)paren
comma
id|RTA_PAYLOAD
c_func
(paren
id|opt
)paren
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
(paren
id|n
op_assign
(paren
r_struct
id|tc_u_knode
op_star
)paren
op_star
id|arg
)paren
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|TC_U32_KEY
c_func
(paren
id|n-&gt;handle
)paren
op_eq
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_return
id|u32_set_parms
c_func
(paren
id|tp-&gt;q
comma
id|base
comma
id|n-&gt;ht_up
comma
id|n
comma
id|tb
comma
id|tca
(braket
id|TCA_RATE
op_minus
l_int|1
)braket
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tb
(braket
id|TCA_U32_DIVISOR
op_minus
l_int|1
)braket
)paren
(brace
r_int
id|divisor
op_assign
op_star
(paren
r_int
op_star
)paren
id|RTA_DATA
c_func
(paren
id|tb
(braket
id|TCA_U32_DIVISOR
op_minus
l_int|1
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|divisor
OG
l_int|0x100
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|TC_U32_KEY
c_func
(paren
id|handle
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|handle
op_eq
l_int|0
)paren
(brace
id|handle
op_assign
id|gen_new_htid
c_func
(paren
id|tp-&gt;data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|handle
op_eq
l_int|0
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|ht
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|ht
)paren
op_plus
id|divisor
op_star
r_sizeof
(paren
r_void
op_star
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ht
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOBUFS
suffix:semicolon
id|memset
c_func
(paren
id|ht
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|ht
)paren
op_plus
id|divisor
op_star
r_sizeof
(paren
r_void
op_star
)paren
)paren
suffix:semicolon
id|ht-&gt;tp_c
op_assign
id|tp_c
suffix:semicolon
id|ht-&gt;refcnt
op_assign
l_int|0
suffix:semicolon
id|ht-&gt;divisor
op_assign
id|divisor
suffix:semicolon
id|ht-&gt;handle
op_assign
id|handle
suffix:semicolon
id|ht-&gt;next
op_assign
id|tp_c-&gt;hlist
suffix:semicolon
id|tp_c-&gt;hlist
op_assign
id|ht
suffix:semicolon
op_star
id|arg
op_assign
(paren
r_int
r_int
)paren
id|ht
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tb
(braket
id|TCA_U32_HASH
op_minus
l_int|1
)braket
)paren
(brace
id|htid
op_assign
op_star
(paren
r_int
op_star
)paren
id|RTA_DATA
c_func
(paren
id|tb
(braket
id|TCA_U32_HASH
op_minus
l_int|1
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|TC_U32_HTID
c_func
(paren
id|htid
)paren
op_eq
id|TC_U32_ROOT
)paren
(brace
id|ht
op_assign
id|tp-&gt;root
suffix:semicolon
id|htid
op_assign
id|ht-&gt;handle
suffix:semicolon
)brace
r_else
(brace
id|ht
op_assign
id|u32_lookup_ht
c_func
(paren
id|tp-&gt;data
comma
id|TC_U32_HTID
c_func
(paren
id|htid
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ht
op_eq
l_int|NULL
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
r_else
(brace
id|ht
op_assign
id|tp-&gt;root
suffix:semicolon
id|htid
op_assign
id|ht-&gt;handle
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ht-&gt;divisor
OL
id|TC_U32_HASH
c_func
(paren
id|htid
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|handle
)paren
(brace
r_if
c_cond
(paren
id|TC_U32_HTID
c_func
(paren
id|handle
)paren
op_logical_and
id|TC_U32_HTID
c_func
(paren
id|handle
op_xor
id|htid
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|handle
op_assign
id|htid
op_or
id|TC_U32_NODE
c_func
(paren
id|handle
)paren
suffix:semicolon
)brace
r_else
id|handle
op_assign
id|gen_new_kid
c_func
(paren
id|ht
comma
id|htid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tb
(braket
id|TCA_U32_SEL
op_minus
l_int|1
)braket
op_eq
l_int|0
op_logical_or
id|RTA_PAYLOAD
c_func
(paren
id|tb
(braket
id|TCA_U32_SEL
op_minus
l_int|1
)braket
)paren
OL
r_sizeof
(paren
r_struct
id|tc_u32_sel
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|s
op_assign
id|RTA_DATA
c_func
(paren
id|tb
(braket
id|TCA_U32_SEL
op_minus
l_int|1
)braket
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_CLS_U32_PERF
r_if
c_cond
(paren
id|RTA_PAYLOAD
c_func
(paren
id|tb
(braket
id|TCA_U32_SEL
op_minus
l_int|1
)braket
)paren
OL
(paren
id|s-&gt;nkeys
op_star
r_sizeof
(paren
r_struct
id|tc_u32_key
)paren
)paren
op_plus
r_sizeof
(paren
r_struct
id|tc_u32_sel
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Please upgrade your iproute2 tools or compile proper options in!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
macro_line|#endif
id|n
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|n
)paren
op_plus
id|s-&gt;nkeys
op_star
r_sizeof
(paren
r_struct
id|tc_u32_key
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|n
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOBUFS
suffix:semicolon
id|memset
c_func
(paren
id|n
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|n
)paren
op_plus
id|s-&gt;nkeys
op_star
r_sizeof
(paren
r_struct
id|tc_u32_key
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|n-&gt;sel
comma
id|s
comma
r_sizeof
(paren
op_star
id|s
)paren
op_plus
id|s-&gt;nkeys
op_star
r_sizeof
(paren
r_struct
id|tc_u32_key
)paren
)paren
suffix:semicolon
id|n-&gt;ht_up
op_assign
id|ht
suffix:semicolon
id|n-&gt;handle
op_assign
id|handle
suffix:semicolon
(brace
id|u8
id|i
op_assign
l_int|0
suffix:semicolon
id|u32
id|mask
op_assign
id|s-&gt;hmask
suffix:semicolon
r_if
c_cond
(paren
id|mask
)paren
(brace
r_while
c_loop
(paren
op_logical_neg
(paren
id|mask
op_amp
l_int|1
)paren
)paren
(brace
id|i
op_increment
suffix:semicolon
id|mask
op_rshift_assign
l_int|1
suffix:semicolon
)brace
)brace
id|n-&gt;fshift
op_assign
id|i
suffix:semicolon
)brace
id|err
op_assign
id|u32_set_parms
c_func
(paren
id|tp-&gt;q
comma
id|base
comma
id|ht
comma
id|n
comma
id|tb
comma
id|tca
(braket
id|TCA_RATE
op_minus
l_int|1
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_eq
l_int|0
)paren
(brace
r_struct
id|tc_u_knode
op_star
op_star
id|ins
suffix:semicolon
r_for
c_loop
(paren
id|ins
op_assign
op_amp
id|ht-&gt;ht
(braket
id|TC_U32_HASH
c_func
(paren
id|handle
)paren
)braket
suffix:semicolon
op_star
id|ins
suffix:semicolon
id|ins
op_assign
op_amp
(paren
op_star
id|ins
)paren
op_member_access_from_pointer
id|next
)paren
r_if
c_cond
(paren
id|TC_U32_NODE
c_func
(paren
id|handle
)paren
OL
id|TC_U32_NODE
c_func
(paren
(paren
op_star
id|ins
)paren
op_member_access_from_pointer
id|handle
)paren
)paren
r_break
suffix:semicolon
id|n-&gt;next
op_assign
op_star
id|ins
suffix:semicolon
id|wmb
c_func
(paren
)paren
suffix:semicolon
op_star
id|ins
op_assign
id|n
suffix:semicolon
op_star
id|arg
op_assign
(paren
r_int
r_int
)paren
id|n
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|n
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|u32_walk
r_static
r_void
id|u32_walk
c_func
(paren
r_struct
id|tcf_proto
op_star
id|tp
comma
r_struct
id|tcf_walker
op_star
id|arg
)paren
(brace
r_struct
id|tc_u_common
op_star
id|tp_c
op_assign
id|tp-&gt;data
suffix:semicolon
r_struct
id|tc_u_hnode
op_star
id|ht
suffix:semicolon
r_struct
id|tc_u_knode
op_star
id|n
suffix:semicolon
r_int
id|h
suffix:semicolon
r_if
c_cond
(paren
id|arg-&gt;stop
)paren
r_return
suffix:semicolon
r_for
c_loop
(paren
id|ht
op_assign
id|tp_c-&gt;hlist
suffix:semicolon
id|ht
suffix:semicolon
id|ht
op_assign
id|ht-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|arg-&gt;count
op_ge
id|arg-&gt;skip
)paren
(brace
r_if
c_cond
(paren
id|arg
op_member_access_from_pointer
id|fn
c_func
(paren
id|tp
comma
(paren
r_int
r_int
)paren
id|ht
comma
id|arg
)paren
OL
l_int|0
)paren
(brace
id|arg-&gt;stop
op_assign
l_int|1
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
id|arg-&gt;count
op_increment
suffix:semicolon
r_for
c_loop
(paren
id|h
op_assign
l_int|0
suffix:semicolon
id|h
op_le
id|ht-&gt;divisor
suffix:semicolon
id|h
op_increment
)paren
(brace
r_for
c_loop
(paren
id|n
op_assign
id|ht-&gt;ht
(braket
id|h
)braket
suffix:semicolon
id|n
suffix:semicolon
id|n
op_assign
id|n-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|arg-&gt;count
OL
id|arg-&gt;skip
)paren
(brace
id|arg-&gt;count
op_increment
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|arg
op_member_access_from_pointer
id|fn
c_func
(paren
id|tp
comma
(paren
r_int
r_int
)paren
id|n
comma
id|arg
)paren
OL
l_int|0
)paren
(brace
id|arg-&gt;stop
op_assign
l_int|1
suffix:semicolon
r_return
suffix:semicolon
)brace
id|arg-&gt;count
op_increment
suffix:semicolon
)brace
)brace
)brace
)brace
DECL|function|u32_dump
r_static
r_int
id|u32_dump
c_func
(paren
r_struct
id|tcf_proto
op_star
id|tp
comma
r_int
r_int
id|fh
comma
r_struct
id|sk_buff
op_star
id|skb
comma
r_struct
id|tcmsg
op_star
id|t
)paren
(brace
r_struct
id|tc_u_knode
op_star
id|n
op_assign
(paren
r_struct
id|tc_u_knode
op_star
)paren
id|fh
suffix:semicolon
r_int
r_char
op_star
id|b
op_assign
id|skb-&gt;tail
suffix:semicolon
r_struct
id|rtattr
op_star
id|rta
suffix:semicolon
r_if
c_cond
(paren
id|n
op_eq
l_int|NULL
)paren
r_return
id|skb-&gt;len
suffix:semicolon
id|t-&gt;tcm_handle
op_assign
id|n-&gt;handle
suffix:semicolon
id|rta
op_assign
(paren
r_struct
id|rtattr
op_star
)paren
id|b
suffix:semicolon
id|RTA_PUT
c_func
(paren
id|skb
comma
id|TCA_OPTIONS
comma
l_int|0
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|TC_U32_KEY
c_func
(paren
id|n-&gt;handle
)paren
op_eq
l_int|0
)paren
(brace
r_struct
id|tc_u_hnode
op_star
id|ht
op_assign
(paren
r_struct
id|tc_u_hnode
op_star
)paren
id|fh
suffix:semicolon
id|u32
id|divisor
op_assign
id|ht-&gt;divisor
op_plus
l_int|1
suffix:semicolon
id|RTA_PUT
c_func
(paren
id|skb
comma
id|TCA_U32_DIVISOR
comma
l_int|4
comma
op_amp
id|divisor
)paren
suffix:semicolon
)brace
r_else
(brace
id|RTA_PUT
c_func
(paren
id|skb
comma
id|TCA_U32_SEL
comma
r_sizeof
(paren
id|n-&gt;sel
)paren
op_plus
id|n-&gt;sel.nkeys
op_star
r_sizeof
(paren
r_struct
id|tc_u32_key
)paren
comma
op_amp
id|n-&gt;sel
)paren
suffix:semicolon
r_if
c_cond
(paren
id|n-&gt;ht_up
)paren
(brace
id|u32
id|htid
op_assign
id|n-&gt;handle
op_amp
l_int|0xFFFFF000
suffix:semicolon
id|RTA_PUT
c_func
(paren
id|skb
comma
id|TCA_U32_HASH
comma
l_int|4
comma
op_amp
id|htid
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|n-&gt;res.classid
)paren
id|RTA_PUT
c_func
(paren
id|skb
comma
id|TCA_U32_CLASSID
comma
l_int|4
comma
op_amp
id|n-&gt;res.classid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|n-&gt;ht_down
)paren
id|RTA_PUT
c_func
(paren
id|skb
comma
id|TCA_U32_LINK
comma
l_int|4
comma
op_amp
id|n-&gt;ht_down-&gt;handle
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_CLS_U32_PERF2
id|n-&gt;sel.rcnt
op_assign
id|n-&gt;sel.rhit
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_NET_CLS_ACT
multiline_comment|/* again for backward compatible mode - we want&n;&t;&t;*  to work with both old and new modes of entering&n;&t;&t;*  tc data even if iproute2  was newer - jhs &n;&t;&t;*/
r_if
c_cond
(paren
id|n-&gt;action
)paren
(brace
r_struct
id|rtattr
op_star
id|p_rta
op_assign
(paren
r_struct
id|rtattr
op_star
)paren
id|skb-&gt;tail
suffix:semicolon
r_if
c_cond
(paren
id|n-&gt;action-&gt;type
op_ne
id|TCA_OLD_COMPAT
)paren
(brace
id|RTA_PUT
c_func
(paren
id|skb
comma
id|TCA_U32_ACT
comma
l_int|0
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tcf_action_dump
c_func
(paren
id|skb
comma
id|n-&gt;action
comma
l_int|0
comma
l_int|0
)paren
OL
l_int|0
)paren
(brace
r_goto
id|rtattr_failure
suffix:semicolon
)brace
)brace
r_else
(brace
id|RTA_PUT
c_func
(paren
id|skb
comma
id|TCA_U32_POLICE
comma
l_int|0
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tcf_action_dump_old
c_func
(paren
id|skb
comma
id|n-&gt;action
comma
l_int|0
comma
l_int|0
)paren
OL
l_int|0
)paren
(brace
r_goto
id|rtattr_failure
suffix:semicolon
)brace
)brace
id|p_rta-&gt;rta_len
op_assign
id|skb-&gt;tail
op_minus
(paren
id|u8
op_star
)paren
id|p_rta
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_NET_CLS_IND
r_if
c_cond
(paren
id|strlen
c_func
(paren
id|n-&gt;indev
)paren
)paren
(brace
r_struct
id|rtattr
op_star
id|p_rta
op_assign
(paren
r_struct
id|rtattr
op_star
)paren
id|skb-&gt;tail
suffix:semicolon
id|RTA_PUT
c_func
(paren
id|skb
comma
id|TCA_U32_INDEV
comma
id|IFNAMSIZ
comma
id|n-&gt;indev
)paren
suffix:semicolon
id|p_rta-&gt;rta_len
op_assign
id|skb-&gt;tail
op_minus
(paren
id|u8
op_star
)paren
id|p_rta
suffix:semicolon
)brace
macro_line|#endif
macro_line|#else
macro_line|#ifdef CONFIG_NET_CLS_POLICE
r_if
c_cond
(paren
id|n-&gt;police
)paren
(brace
r_struct
id|rtattr
op_star
id|p_rta
op_assign
(paren
r_struct
id|rtattr
op_star
)paren
id|skb-&gt;tail
suffix:semicolon
id|RTA_PUT
c_func
(paren
id|skb
comma
id|TCA_U32_POLICE
comma
l_int|0
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tcf_police_dump
c_func
(paren
id|skb
comma
id|n-&gt;police
)paren
OL
l_int|0
)paren
r_goto
id|rtattr_failure
suffix:semicolon
id|p_rta-&gt;rta_len
op_assign
id|skb-&gt;tail
op_minus
(paren
id|u8
op_star
)paren
id|p_rta
suffix:semicolon
)brace
macro_line|#endif
macro_line|#endif
)brace
id|rta-&gt;rta_len
op_assign
id|skb-&gt;tail
op_minus
id|b
suffix:semicolon
macro_line|#ifdef CONFIG_NET_CLS_ACT
r_if
c_cond
(paren
id|TC_U32_KEY
c_func
(paren
id|n-&gt;handle
)paren
op_logical_and
id|n-&gt;action
op_logical_and
id|n-&gt;action-&gt;type
op_eq
id|TCA_OLD_COMPAT
)paren
(brace
r_if
c_cond
(paren
id|tcf_action_copy_stats
c_func
(paren
id|skb
comma
id|n-&gt;action
)paren
)paren
r_goto
id|rtattr_failure
suffix:semicolon
)brace
macro_line|#else
macro_line|#ifdef CONFIG_NET_CLS_POLICE
r_if
c_cond
(paren
id|TC_U32_KEY
c_func
(paren
id|n-&gt;handle
)paren
op_logical_and
id|n-&gt;police
)paren
(brace
r_if
c_cond
(paren
id|qdisc_copy_stats
c_func
(paren
id|skb
comma
op_amp
id|n-&gt;police-&gt;stats
comma
id|n-&gt;police-&gt;stats_lock
)paren
)paren
r_goto
id|rtattr_failure
suffix:semicolon
)brace
macro_line|#endif
macro_line|#endif
r_return
id|skb-&gt;len
suffix:semicolon
id|rtattr_failure
suffix:colon
id|skb_trim
c_func
(paren
id|skb
comma
id|b
op_minus
id|skb-&gt;data
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
DECL|variable|cls_u32_ops
r_static
r_struct
id|tcf_proto_ops
id|cls_u32_ops
op_assign
(brace
dot
id|next
op_assign
l_int|NULL
comma
dot
id|kind
op_assign
l_string|&quot;u32&quot;
comma
dot
id|classify
op_assign
id|u32_classify
comma
dot
id|init
op_assign
id|u32_init
comma
dot
id|destroy
op_assign
id|u32_destroy
comma
dot
id|get
op_assign
id|u32_get
comma
dot
id|put
op_assign
id|u32_put
comma
dot
id|change
op_assign
id|u32_change
comma
dot
r_delete
op_assign
id|u32_delete
comma
dot
id|walk
op_assign
id|u32_walk
comma
dot
id|dump
op_assign
id|u32_dump
comma
dot
id|owner
op_assign
id|THIS_MODULE
comma
)brace
suffix:semicolon
DECL|function|init_u32
r_static
r_int
id|__init
id|init_u32
c_func
(paren
r_void
)paren
(brace
r_return
id|register_tcf_proto_ops
c_func
(paren
op_amp
id|cls_u32_ops
)paren
suffix:semicolon
)brace
DECL|function|exit_u32
r_static
r_void
id|__exit
id|exit_u32
c_func
(paren
r_void
)paren
(brace
id|unregister_tcf_proto_ops
c_func
(paren
op_amp
id|cls_u32_ops
)paren
suffix:semicolon
)brace
id|module_init
c_func
(paren
id|init_u32
)paren
id|module_exit
c_func
(paren
id|exit_u32
)paren
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
eof
