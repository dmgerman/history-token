multiline_comment|/*&n; * NET4:&t;Implementation of BSD Unix domain sockets.&n; *&n; * Authors:&t;Alan Cox, &lt;alan.cox@linux.org&gt;&n; *&n; *&t;&t;This program is free software; you can redistribute it and/or&n; *&t;&t;modify it under the terms of the GNU General Public License&n; *&t;&t;as published by the Free Software Foundation; either version&n; *&t;&t;2 of the License, or (at your option) any later version.&n; *&n; * Version:&t;$Id: af_unix.c,v 1.133 2002/02/08 03:57:19 davem Exp $&n; *&n; * Fixes:&n; *&t;&t;Linus Torvalds&t;:&t;Assorted bug cures.&n; *&t;&t;Niibe Yutaka&t;:&t;async I/O support.&n; *&t;&t;Carsten Paeth&t;:&t;PF_UNIX check, address fixes.&n; *&t;&t;Alan Cox&t;:&t;Limit size of allocated blocks.&n; *&t;&t;Alan Cox&t;:&t;Fixed the stupid socketpair bug.&n; *&t;&t;Alan Cox&t;:&t;BSD compatibility fine tuning.&n; *&t;&t;Alan Cox&t;:&t;Fixed a bug in connect when interrupted.&n; *&t;&t;Alan Cox&t;:&t;Sorted out a proper draft version of&n; *&t;&t;&t;&t;&t;file descriptor passing hacked up from&n; *&t;&t;&t;&t;&t;Mike Shaver&squot;s work.&n; *&t;&t;Marty Leisner&t;:&t;Fixes to fd passing&n; *&t;&t;Nick Nevin&t;:&t;recvmsg bugfix.&n; *&t;&t;Alan Cox&t;:&t;Started proper garbage collector&n; *&t;&t;Heiko EiBfeldt&t;:&t;Missing verify_area check&n; *&t;&t;Alan Cox&t;:&t;Started POSIXisms&n; *&t;&t;Andreas Schwab&t;:&t;Replace inode by dentry for proper&n; *&t;&t;&t;&t;&t;reference counting&n; *&t;&t;Kirk Petersen&t;:&t;Made this a module&n; *&t;    Christoph Rohland&t;:&t;Elegant non-blocking accept/connect algorithm.&n; *&t;&t;&t;&t;&t;Lots of bug fixes.&n; *&t;     Alexey Kuznetosv&t;:&t;Repaired (I hope) bugs introduces&n; *&t;&t;&t;&t;&t;by above two patches.&n; *&t;     Andrea Arcangeli&t;:&t;If possible we block in connect(2)&n; *&t;&t;&t;&t;&t;if the max backlog of the listen socket&n; *&t;&t;&t;&t;&t;is been reached. This won&squot;t break&n; *&t;&t;&t;&t;&t;old apps and it will avoid huge amount&n; *&t;&t;&t;&t;&t;of socks hashed (this for unix_gc()&n; *&t;&t;&t;&t;&t;performances reasons).&n; *&t;&t;&t;&t;&t;Security fix that limits the max&n; *&t;&t;&t;&t;&t;number of socks to 2*max_files and&n; *&t;&t;&t;&t;&t;the number of skb queueable in the&n; *&t;&t;&t;&t;&t;dgram receiver.&n; *&t;&t;Artur Skawina   :&t;Hash function optimizations&n; *&t;     Alexey Kuznetsov   :&t;Full scale SMP. Lot of bugs are introduced 8)&n; *&t;      Malcolm Beattie   :&t;Set peercred for socketpair&n; *&t;     Michal Ostrowski   :       Module initialization cleanup.&n; *&t;     Arnaldo C. Melo&t;:&t;Remove MOD_{INC,DEC}_USE_COUNT,&n; *&t;     &t;&t;&t;&t;the core infrastructure is doing that&n; *&t;     &t;&t;&t;&t;for all net proto families now (2.5.69+)&n; *&n; *&n; * Known differences from reference BSD that was tested:&n; *&n; *&t;[TO FIX]&n; *&t;ECONNREFUSED is not returned from one end of a connected() socket to the&n; *&t;&t;other the moment one end closes.&n; *&t;fstat() doesn&squot;t return st_dev=NODEV, and give the blksize as high water mark&n; *&t;&t;and a fake inode identifier (nor the BSD first socket fstat twice bug).&n; *&t;[NOT TO FIX]&n; *&t;accept() returns a path name even if the connecting socket has closed&n; *&t;&t;in the meantime (BSD loses the path and gives up).&n; *&t;accept() returns 0 length path for an unbound connector. BSD returns 16&n; *&t;&t;and a null first byte in the path (but not for gethost/peername - BSD bug ??)&n; *&t;socketpair(...SOCK_RAW..) doesn&squot;t panic the kernel.&n; *&t;BSD af_unix apparently has connect forgetting to block properly.&n; *&t;&t;(need to check this with the POSIX spec in detail)&n; *&n; * Differences from 2.0.0-11-... (ANK)&n; *&t;Bug fixes and improvements.&n; *&t;&t;- client shutdown killed server socket.&n; *&t;&t;- removed all useless cli/sti pairs.&n; *&n; *&t;Semantic changes/extensions.&n; *&t;&t;- generic control message passing.&n; *&t;&t;- SCM_CREDENTIALS control message.&n; *&t;&t;- &quot;Abstract&quot; (not FS based) socket bindings.&n; *&t;&t;  Abstract names are sequences of bytes (not zero terminated)&n; *&t;&t;  started by 0, so that this name space does not intersect&n; *&t;&t;  with BSD names.&n; */
DECL|macro|unix
macro_line|#undef unix&t;/* KBUILD_MODNAME */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/major.h&gt;
macro_line|#include &lt;linux/signal.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/dcache.h&gt;
macro_line|#include &lt;linux/namei.h&gt;
macro_line|#include &lt;linux/socket.h&gt;
macro_line|#include &lt;linux/un.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/termios.h&gt;
macro_line|#include &lt;linux/sockios.h&gt;
macro_line|#include &lt;linux/net.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;net/sock.h&gt;
macro_line|#include &lt;linux/tcp.h&gt;
macro_line|#include &lt;net/af_unix.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;net/scm.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/poll.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/rtnetlink.h&gt;
macro_line|#include &lt;linux/mount.h&gt;
macro_line|#include &lt;net/checksum.h&gt;
macro_line|#include &lt;linux/security.h&gt;
DECL|variable|sysctl_unix_max_dgram_qlen
r_int
id|sysctl_unix_max_dgram_qlen
op_assign
l_int|10
suffix:semicolon
DECL|variable|unix_sk_cachep
id|kmem_cache_t
op_star
id|unix_sk_cachep
suffix:semicolon
DECL|variable|unix_socket_table
r_struct
id|hlist_head
id|unix_socket_table
(braket
id|UNIX_HASH_SIZE
op_plus
l_int|1
)braket
suffix:semicolon
DECL|variable|unix_table_lock
id|rwlock_t
id|unix_table_lock
op_assign
id|RW_LOCK_UNLOCKED
suffix:semicolon
DECL|variable|unix_nr_socks
r_static
id|atomic_t
id|unix_nr_socks
op_assign
id|ATOMIC_INIT
c_func
(paren
l_int|0
)paren
suffix:semicolon
DECL|macro|unix_sockets_unbound
mdefine_line|#define unix_sockets_unbound&t;(&amp;unix_socket_table[UNIX_HASH_SIZE])
DECL|macro|UNIX_ABSTRACT
mdefine_line|#define UNIX_ABSTRACT(sk)&t;(unix_sk(sk)-&gt;addr-&gt;hash != UNIX_HASH_SIZE)
multiline_comment|/*&n; *  SMP locking strategy:&n; *    hash table is protected with rwlock unix_table_lock&n; *    each socket state is protected by separate rwlock.&n; */
DECL|function|unix_hash_fold
r_static
r_inline
r_int
id|unix_hash_fold
c_func
(paren
r_int
id|hash
)paren
(brace
id|hash
op_xor_assign
id|hash
op_rshift
l_int|16
suffix:semicolon
id|hash
op_xor_assign
id|hash
op_rshift
l_int|8
suffix:semicolon
r_return
id|hash
op_amp
(paren
id|UNIX_HASH_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
)brace
DECL|macro|unix_peer
mdefine_line|#define unix_peer(sk) ((sk)-&gt;sk_pair)
DECL|function|unix_our_peer
r_static
r_inline
r_int
id|unix_our_peer
c_func
(paren
id|unix_socket
op_star
id|sk
comma
id|unix_socket
op_star
id|osk
)paren
(brace
r_return
id|unix_peer
c_func
(paren
id|osk
)paren
op_eq
id|sk
suffix:semicolon
)brace
DECL|function|unix_may_send
r_static
r_inline
r_int
id|unix_may_send
c_func
(paren
id|unix_socket
op_star
id|sk
comma
id|unix_socket
op_star
id|osk
)paren
(brace
r_return
(paren
id|unix_peer
c_func
(paren
id|osk
)paren
op_eq
l_int|NULL
op_logical_or
id|unix_our_peer
c_func
(paren
id|sk
comma
id|osk
)paren
)paren
suffix:semicolon
)brace
DECL|function|unix_peer_get
r_static
id|unix_socket
op_star
id|unix_peer_get
c_func
(paren
id|unix_socket
op_star
id|s
)paren
(brace
id|unix_socket
op_star
id|peer
suffix:semicolon
id|unix_state_rlock
c_func
(paren
id|s
)paren
suffix:semicolon
id|peer
op_assign
id|unix_peer
c_func
(paren
id|s
)paren
suffix:semicolon
r_if
c_cond
(paren
id|peer
)paren
id|sock_hold
c_func
(paren
id|peer
)paren
suffix:semicolon
id|unix_state_runlock
c_func
(paren
id|s
)paren
suffix:semicolon
r_return
id|peer
suffix:semicolon
)brace
DECL|function|unix_release_addr
r_static
r_inline
r_void
id|unix_release_addr
c_func
(paren
r_struct
id|unix_address
op_star
id|addr
)paren
(brace
r_if
c_cond
(paren
id|atomic_dec_and_test
c_func
(paren
op_amp
id|addr-&gt;refcnt
)paren
)paren
id|kfree
c_func
(paren
id|addr
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Check unix socket name:&n; *&t;&t;- should be not zero length.&n; *&t;        - if started by not zero, should be NULL terminated (FS object)&n; *&t;&t;- if started by zero, it is abstract name.&n; */
DECL|function|unix_mkname
r_static
r_int
id|unix_mkname
c_func
(paren
r_struct
id|sockaddr_un
op_star
id|sunaddr
comma
r_int
id|len
comma
r_int
op_star
id|hashp
)paren
(brace
r_if
c_cond
(paren
id|len
op_le
r_sizeof
(paren
r_int
)paren
op_logical_or
id|len
OG
r_sizeof
(paren
op_star
id|sunaddr
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sunaddr
op_logical_or
id|sunaddr-&gt;sun_family
op_ne
id|AF_UNIX
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|sunaddr-&gt;sun_path
(braket
l_int|0
)braket
)paren
(brace
multiline_comment|/*&n;&t;&t; *&t;This may look like an off by one error but it is&n;&t;&t; *&t;a bit more subtle. 108 is the longest valid AF_UNIX&n;&t;&t; *&t;path for a binding. sun_path[108] doesn&squot;t as such&n;&t;&t; *&t;exist. However in kernel space we are guaranteed that&n;&t;&t; *&t;it is a valid memory location in our kernel&n;&t;&t; *&t;address buffer.&n;&t;&t; */
r_if
c_cond
(paren
id|len
OG
r_sizeof
(paren
op_star
id|sunaddr
)paren
)paren
id|len
op_assign
r_sizeof
(paren
op_star
id|sunaddr
)paren
suffix:semicolon
(paren
(paren
r_char
op_star
)paren
id|sunaddr
)paren
(braket
id|len
)braket
op_assign
l_int|0
suffix:semicolon
id|len
op_assign
id|strlen
c_func
(paren
id|sunaddr-&gt;sun_path
)paren
op_plus
l_int|1
op_plus
r_sizeof
(paren
r_int
)paren
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
op_star
id|hashp
op_assign
id|unix_hash_fold
c_func
(paren
id|csum_partial
c_func
(paren
(paren
r_char
op_star
)paren
id|sunaddr
comma
id|len
comma
l_int|0
)paren
)paren
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
DECL|function|__unix_remove_socket
r_static
r_void
id|__unix_remove_socket
c_func
(paren
id|unix_socket
op_star
id|sk
)paren
(brace
r_if
c_cond
(paren
id|sk_del_node_init
c_func
(paren
id|sk
)paren
)paren
id|__sock_put
c_func
(paren
id|sk
)paren
suffix:semicolon
)brace
DECL|function|__unix_insert_socket
r_static
r_void
id|__unix_insert_socket
c_func
(paren
r_struct
id|hlist_head
op_star
id|list
comma
id|unix_socket
op_star
id|sk
)paren
(brace
id|BUG_TRAP
c_func
(paren
id|sk_unhashed
c_func
(paren
id|sk
)paren
)paren
suffix:semicolon
id|sk_add_node
c_func
(paren
id|sk
comma
id|list
)paren
suffix:semicolon
id|sock_hold
c_func
(paren
id|sk
)paren
suffix:semicolon
)brace
DECL|function|unix_remove_socket
r_static
r_inline
r_void
id|unix_remove_socket
c_func
(paren
id|unix_socket
op_star
id|sk
)paren
(brace
id|write_lock
c_func
(paren
op_amp
id|unix_table_lock
)paren
suffix:semicolon
id|__unix_remove_socket
c_func
(paren
id|sk
)paren
suffix:semicolon
id|write_unlock
c_func
(paren
op_amp
id|unix_table_lock
)paren
suffix:semicolon
)brace
DECL|function|unix_insert_socket
r_static
r_inline
r_void
id|unix_insert_socket
c_func
(paren
r_struct
id|hlist_head
op_star
id|list
comma
id|unix_socket
op_star
id|sk
)paren
(brace
id|write_lock
c_func
(paren
op_amp
id|unix_table_lock
)paren
suffix:semicolon
id|__unix_insert_socket
c_func
(paren
id|list
comma
id|sk
)paren
suffix:semicolon
id|write_unlock
c_func
(paren
op_amp
id|unix_table_lock
)paren
suffix:semicolon
)brace
DECL|function|__unix_find_socket_byname
r_static
id|unix_socket
op_star
id|__unix_find_socket_byname
c_func
(paren
r_struct
id|sockaddr_un
op_star
id|sunname
comma
r_int
id|len
comma
r_int
id|type
comma
r_int
id|hash
)paren
(brace
id|unix_socket
op_star
id|s
suffix:semicolon
r_struct
id|hlist_node
op_star
id|node
suffix:semicolon
id|sk_for_each
c_func
(paren
id|s
comma
id|node
comma
op_amp
id|unix_socket_table
(braket
id|hash
op_xor
id|type
)braket
)paren
(brace
r_struct
id|unix_sock
op_star
id|u
op_assign
id|unix_sk
c_func
(paren
id|s
)paren
suffix:semicolon
r_if
c_cond
(paren
id|u-&gt;addr-&gt;len
op_eq
id|len
op_logical_and
op_logical_neg
id|memcmp
c_func
(paren
id|u-&gt;addr-&gt;name
comma
id|sunname
comma
id|len
)paren
)paren
r_goto
id|found
suffix:semicolon
)brace
id|s
op_assign
l_int|NULL
suffix:semicolon
id|found
suffix:colon
r_return
id|s
suffix:semicolon
)brace
r_static
r_inline
id|unix_socket
op_star
DECL|function|unix_find_socket_byname
id|unix_find_socket_byname
c_func
(paren
r_struct
id|sockaddr_un
op_star
id|sunname
comma
r_int
id|len
comma
r_int
id|type
comma
r_int
id|hash
)paren
(brace
id|unix_socket
op_star
id|s
suffix:semicolon
id|read_lock
c_func
(paren
op_amp
id|unix_table_lock
)paren
suffix:semicolon
id|s
op_assign
id|__unix_find_socket_byname
c_func
(paren
id|sunname
comma
id|len
comma
id|type
comma
id|hash
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s
)paren
id|sock_hold
c_func
(paren
id|s
)paren
suffix:semicolon
id|read_unlock
c_func
(paren
op_amp
id|unix_table_lock
)paren
suffix:semicolon
r_return
id|s
suffix:semicolon
)brace
DECL|function|unix_find_socket_byinode
r_static
id|unix_socket
op_star
id|unix_find_socket_byinode
c_func
(paren
r_struct
id|inode
op_star
id|i
)paren
(brace
id|unix_socket
op_star
id|s
suffix:semicolon
r_struct
id|hlist_node
op_star
id|node
suffix:semicolon
id|read_lock
c_func
(paren
op_amp
id|unix_table_lock
)paren
suffix:semicolon
id|sk_for_each
c_func
(paren
id|s
comma
id|node
comma
op_amp
id|unix_socket_table
(braket
id|i-&gt;i_ino
op_amp
(paren
id|UNIX_HASH_SIZE
op_minus
l_int|1
)paren
)braket
)paren
(brace
r_struct
id|dentry
op_star
id|dentry
op_assign
id|unix_sk
c_func
(paren
id|s
)paren
op_member_access_from_pointer
id|dentry
suffix:semicolon
r_if
c_cond
(paren
id|dentry
op_logical_and
id|dentry-&gt;d_inode
op_eq
id|i
)paren
(brace
id|sock_hold
c_func
(paren
id|s
)paren
suffix:semicolon
r_goto
id|found
suffix:semicolon
)brace
)brace
id|s
op_assign
l_int|NULL
suffix:semicolon
id|found
suffix:colon
id|read_unlock
c_func
(paren
op_amp
id|unix_table_lock
)paren
suffix:semicolon
r_return
id|s
suffix:semicolon
)brace
DECL|function|unix_writable
r_static
r_inline
r_int
id|unix_writable
c_func
(paren
r_struct
id|sock
op_star
id|sk
)paren
(brace
r_return
(paren
id|atomic_read
c_func
(paren
op_amp
id|sk-&gt;sk_wmem_alloc
)paren
op_lshift
l_int|2
)paren
op_le
id|sk-&gt;sk_sndbuf
suffix:semicolon
)brace
DECL|function|unix_write_space
r_static
r_void
id|unix_write_space
c_func
(paren
r_struct
id|sock
op_star
id|sk
)paren
(brace
id|read_lock
c_func
(paren
op_amp
id|sk-&gt;sk_callback_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unix_writable
c_func
(paren
id|sk
)paren
)paren
(brace
r_if
c_cond
(paren
id|sk-&gt;sk_sleep
op_logical_and
id|waitqueue_active
c_func
(paren
id|sk-&gt;sk_sleep
)paren
)paren
id|wake_up_interruptible
c_func
(paren
id|sk-&gt;sk_sleep
)paren
suffix:semicolon
id|sk_wake_async
c_func
(paren
id|sk
comma
l_int|2
comma
id|POLL_OUT
)paren
suffix:semicolon
)brace
id|read_unlock
c_func
(paren
op_amp
id|sk-&gt;sk_callback_lock
)paren
suffix:semicolon
)brace
multiline_comment|/* When dgram socket disconnects (or changes its peer), we clear its receive&n; * queue of packets arrived from previous peer. First, it allows to do&n; * flow control based only on wmem_alloc; second, sk connected to peer&n; * may receive messages only from that peer. */
DECL|function|unix_dgram_disconnected
r_static
r_void
id|unix_dgram_disconnected
c_func
(paren
r_struct
id|sock
op_star
id|sk
comma
r_struct
id|sock
op_star
id|other
)paren
(brace
r_if
c_cond
(paren
id|skb_queue_len
c_func
(paren
op_amp
id|sk-&gt;sk_receive_queue
)paren
)paren
(brace
id|skb_queue_purge
c_func
(paren
op_amp
id|sk-&gt;sk_receive_queue
)paren
suffix:semicolon
id|wake_up_interruptible_all
c_func
(paren
op_amp
id|unix_sk
c_func
(paren
id|sk
)paren
op_member_access_from_pointer
id|peer_wait
)paren
suffix:semicolon
multiline_comment|/* If one link of bidirectional dgram pipe is disconnected,&n;&t;&t; * we signal error. Messages are lost. Do not make this,&n;&t;&t; * when peer was not connected to us.&n;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
id|sock_flag
c_func
(paren
id|other
comma
id|SOCK_DEAD
)paren
op_logical_and
id|unix_peer
c_func
(paren
id|other
)paren
op_eq
id|sk
)paren
(brace
id|other-&gt;sk_err
op_assign
id|ECONNRESET
suffix:semicolon
id|other
op_member_access_from_pointer
id|sk_error_report
c_func
(paren
id|other
)paren
suffix:semicolon
)brace
)brace
)brace
DECL|function|unix_sock_destructor
r_static
r_void
id|unix_sock_destructor
c_func
(paren
r_struct
id|sock
op_star
id|sk
)paren
(brace
r_struct
id|unix_sock
op_star
id|u
op_assign
id|unix_sk
c_func
(paren
id|sk
)paren
suffix:semicolon
id|skb_queue_purge
c_func
(paren
op_amp
id|sk-&gt;sk_receive_queue
)paren
suffix:semicolon
id|BUG_TRAP
c_func
(paren
op_logical_neg
id|atomic_read
c_func
(paren
op_amp
id|sk-&gt;sk_wmem_alloc
)paren
)paren
suffix:semicolon
id|BUG_TRAP
c_func
(paren
id|sk_unhashed
c_func
(paren
id|sk
)paren
)paren
suffix:semicolon
id|BUG_TRAP
c_func
(paren
op_logical_neg
id|sk-&gt;sk_socket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sock_flag
c_func
(paren
id|sk
comma
id|SOCK_DEAD
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Attempt to release alive unix socket: %p&bslash;n&quot;
comma
id|sk
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|u-&gt;addr
)paren
id|unix_release_addr
c_func
(paren
id|u-&gt;addr
)paren
suffix:semicolon
id|atomic_dec
c_func
(paren
op_amp
id|unix_nr_socks
)paren
suffix:semicolon
macro_line|#ifdef UNIX_REFCNT_DEBUG
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;UNIX %p is destroyed, %d are still alive.&bslash;n&quot;
comma
id|sk
comma
id|atomic_read
c_func
(paren
op_amp
id|unix_nr_socks
)paren
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|unix_release_sock
r_static
r_int
id|unix_release_sock
(paren
id|unix_socket
op_star
id|sk
comma
r_int
id|embrion
)paren
(brace
r_struct
id|unix_sock
op_star
id|u
op_assign
id|unix_sk
c_func
(paren
id|sk
)paren
suffix:semicolon
r_struct
id|dentry
op_star
id|dentry
suffix:semicolon
r_struct
id|vfsmount
op_star
id|mnt
suffix:semicolon
id|unix_socket
op_star
id|skpair
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|state
suffix:semicolon
id|unix_remove_socket
c_func
(paren
id|sk
)paren
suffix:semicolon
multiline_comment|/* Clear state */
id|unix_state_wlock
c_func
(paren
id|sk
)paren
suffix:semicolon
id|sock_orphan
c_func
(paren
id|sk
)paren
suffix:semicolon
id|sk-&gt;sk_shutdown
op_assign
id|SHUTDOWN_MASK
suffix:semicolon
id|dentry
op_assign
id|u-&gt;dentry
suffix:semicolon
id|u-&gt;dentry
op_assign
l_int|NULL
suffix:semicolon
id|mnt
op_assign
id|u-&gt;mnt
suffix:semicolon
id|u-&gt;mnt
op_assign
l_int|NULL
suffix:semicolon
id|state
op_assign
id|sk-&gt;sk_state
suffix:semicolon
id|sk-&gt;sk_state
op_assign
id|TCP_CLOSE
suffix:semicolon
id|unix_state_wunlock
c_func
(paren
id|sk
)paren
suffix:semicolon
id|wake_up_interruptible_all
c_func
(paren
op_amp
id|u-&gt;peer_wait
)paren
suffix:semicolon
id|skpair
op_assign
id|unix_peer
c_func
(paren
id|sk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skpair
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|sk-&gt;sk_type
op_eq
id|SOCK_STREAM
)paren
(brace
id|unix_state_wlock
c_func
(paren
id|skpair
)paren
suffix:semicolon
multiline_comment|/* No more writes */
id|skpair-&gt;sk_shutdown
op_assign
id|SHUTDOWN_MASK
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb_queue_empty
c_func
(paren
op_amp
id|sk-&gt;sk_receive_queue
)paren
op_logical_or
id|embrion
)paren
id|skpair-&gt;sk_err
op_assign
id|ECONNRESET
suffix:semicolon
id|unix_state_wunlock
c_func
(paren
id|skpair
)paren
suffix:semicolon
id|skpair
op_member_access_from_pointer
id|sk_state_change
c_func
(paren
id|skpair
)paren
suffix:semicolon
id|read_lock
c_func
(paren
op_amp
id|skpair-&gt;sk_callback_lock
)paren
suffix:semicolon
id|sk_wake_async
c_func
(paren
id|skpair
comma
l_int|1
comma
id|POLL_HUP
)paren
suffix:semicolon
id|read_unlock
c_func
(paren
op_amp
id|skpair-&gt;sk_callback_lock
)paren
suffix:semicolon
)brace
id|sock_put
c_func
(paren
id|skpair
)paren
suffix:semicolon
multiline_comment|/* It may now die */
id|unix_peer
c_func
(paren
id|sk
)paren
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* Try to flush out this socket. Throw out buffers at least */
r_while
c_loop
(paren
(paren
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|sk-&gt;sk_receive_queue
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|state
op_eq
id|TCP_LISTEN
)paren
id|unix_release_sock
c_func
(paren
id|skb-&gt;sk
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* passed fds are erased in the kfree_skb hook&t;      */
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dentry
)paren
(brace
id|dput
c_func
(paren
id|dentry
)paren
suffix:semicolon
id|mntput
c_func
(paren
id|mnt
)paren
suffix:semicolon
)brace
id|sock_put
c_func
(paren
id|sk
)paren
suffix:semicolon
multiline_comment|/* ---- Socket is dead now and most probably destroyed ---- */
multiline_comment|/*&n;&t; * Fixme: BSD difference: In BSD all sockets connected to use get&n;&t; *&t;  ECONNRESET and we die on the spot. In Linux we behave&n;&t; *&t;  like files and pipes do and wait for the last&n;&t; *&t;  dereference.&n;&t; *&n;&t; * Can&squot;t we simply set sock-&gt;err?&n;&t; *&n;&t; *&t;  What the above comment does talk about? --ANK(980817)&n;&t; */
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|unix_tot_inflight
)paren
)paren
id|unix_gc
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Garbage collect fds */
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|unix_listen
r_static
r_int
id|unix_listen
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_int
id|backlog
)paren
(brace
r_int
id|err
suffix:semicolon
r_struct
id|sock
op_star
id|sk
op_assign
id|sock-&gt;sk
suffix:semicolon
r_struct
id|unix_sock
op_star
id|u
op_assign
id|unix_sk
c_func
(paren
id|sk
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EOPNOTSUPP
suffix:semicolon
r_if
c_cond
(paren
id|sock-&gt;type
op_ne
id|SOCK_STREAM
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* Only stream sockets accept */
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|u-&gt;addr
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* No listens on an unbound socket */
id|unix_state_wlock
c_func
(paren
id|sk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;sk_state
op_ne
id|TCP_CLOSE
op_logical_and
id|sk-&gt;sk_state
op_ne
id|TCP_LISTEN
)paren
r_goto
id|out_unlock
suffix:semicolon
r_if
c_cond
(paren
id|backlog
OG
id|sk-&gt;sk_max_ack_backlog
)paren
id|wake_up_interruptible_all
c_func
(paren
op_amp
id|u-&gt;peer_wait
)paren
suffix:semicolon
id|sk-&gt;sk_max_ack_backlog
op_assign
id|backlog
suffix:semicolon
id|sk-&gt;sk_state
op_assign
id|TCP_LISTEN
suffix:semicolon
multiline_comment|/* set credentials so connect can copy them */
id|sk-&gt;sk_peercred.pid
op_assign
id|current-&gt;pid
suffix:semicolon
id|sk-&gt;sk_peercred.uid
op_assign
id|current-&gt;euid
suffix:semicolon
id|sk-&gt;sk_peercred.gid
op_assign
id|current-&gt;egid
suffix:semicolon
id|err
op_assign
l_int|0
suffix:semicolon
id|out_unlock
suffix:colon
id|unix_state_wunlock
c_func
(paren
id|sk
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|err
suffix:semicolon
)brace
r_extern
r_struct
id|proto_ops
id|unix_stream_ops
suffix:semicolon
r_extern
r_struct
id|proto_ops
id|unix_dgram_ops
suffix:semicolon
DECL|function|unix_create1
r_static
r_struct
id|sock
op_star
id|unix_create1
c_func
(paren
r_struct
id|socket
op_star
id|sock
)paren
(brace
r_struct
id|sock
op_star
id|sk
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|unix_sock
op_star
id|u
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|unix_nr_socks
)paren
op_ge
l_int|2
op_star
id|files_stat.max_files
)paren
r_goto
id|out
suffix:semicolon
id|sk
op_assign
id|sk_alloc
c_func
(paren
id|PF_UNIX
comma
id|GFP_KERNEL
comma
r_sizeof
(paren
r_struct
id|unix_sock
)paren
comma
id|unix_sk_cachep
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sk
)paren
r_goto
id|out
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|unix_nr_socks
)paren
suffix:semicolon
id|sock_init_data
c_func
(paren
id|sock
comma
id|sk
)paren
suffix:semicolon
id|sk_set_owner
c_func
(paren
id|sk
comma
id|THIS_MODULE
)paren
suffix:semicolon
id|sk-&gt;sk_write_space
op_assign
id|unix_write_space
suffix:semicolon
id|sk-&gt;sk_max_ack_backlog
op_assign
id|sysctl_unix_max_dgram_qlen
suffix:semicolon
id|sk-&gt;sk_destruct
op_assign
id|unix_sock_destructor
suffix:semicolon
id|u
op_assign
id|unix_sk
c_func
(paren
id|sk
)paren
suffix:semicolon
id|u-&gt;dentry
op_assign
l_int|NULL
suffix:semicolon
id|u-&gt;mnt
op_assign
l_int|NULL
suffix:semicolon
id|rwlock_init
c_func
(paren
op_amp
id|u-&gt;lock
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|u-&gt;inflight
comma
id|sock
ques
c_cond
l_int|0
suffix:colon
op_minus
l_int|1
)paren
suffix:semicolon
id|init_MUTEX
c_func
(paren
op_amp
id|u-&gt;readsem
)paren
suffix:semicolon
multiline_comment|/* single task reading lock */
id|init_waitqueue_head
c_func
(paren
op_amp
id|u-&gt;peer_wait
)paren
suffix:semicolon
id|unix_insert_socket
c_func
(paren
id|unix_sockets_unbound
comma
id|sk
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|sk
suffix:semicolon
)brace
DECL|function|unix_create
r_static
r_int
id|unix_create
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_int
id|protocol
)paren
(brace
r_if
c_cond
(paren
id|protocol
op_logical_and
id|protocol
op_ne
id|PF_UNIX
)paren
r_return
op_minus
id|EPROTONOSUPPORT
suffix:semicolon
id|sock-&gt;state
op_assign
id|SS_UNCONNECTED
suffix:semicolon
r_switch
c_cond
(paren
id|sock-&gt;type
)paren
(brace
r_case
id|SOCK_STREAM
suffix:colon
id|sock-&gt;ops
op_assign
op_amp
id|unix_stream_ops
suffix:semicolon
r_break
suffix:semicolon
multiline_comment|/*&n;&t;&t; *&t;Believe it or not BSD has AF_UNIX, SOCK_RAW though&n;&t;&t; *&t;nothing uses it.&n;&t;&t; */
r_case
id|SOCK_RAW
suffix:colon
id|sock-&gt;type
op_assign
id|SOCK_DGRAM
suffix:semicolon
r_case
id|SOCK_DGRAM
suffix:colon
id|sock-&gt;ops
op_assign
op_amp
id|unix_dgram_ops
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
op_minus
id|ESOCKTNOSUPPORT
suffix:semicolon
)brace
r_return
id|unix_create1
c_func
(paren
id|sock
)paren
ques
c_cond
l_int|0
suffix:colon
op_minus
id|ENOMEM
suffix:semicolon
)brace
DECL|function|unix_release
r_static
r_int
id|unix_release
c_func
(paren
r_struct
id|socket
op_star
id|sock
)paren
(brace
id|unix_socket
op_star
id|sk
op_assign
id|sock-&gt;sk
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sk
)paren
r_return
l_int|0
suffix:semicolon
id|sock-&gt;sk
op_assign
l_int|NULL
suffix:semicolon
r_return
id|unix_release_sock
(paren
id|sk
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|unix_autobind
r_static
r_int
id|unix_autobind
c_func
(paren
r_struct
id|socket
op_star
id|sock
)paren
(brace
r_struct
id|sock
op_star
id|sk
op_assign
id|sock-&gt;sk
suffix:semicolon
r_struct
id|unix_sock
op_star
id|u
op_assign
id|unix_sk
c_func
(paren
id|sk
)paren
suffix:semicolon
r_static
id|u32
id|ordernum
op_assign
l_int|1
suffix:semicolon
r_struct
id|unix_address
op_star
id|addr
suffix:semicolon
r_int
id|err
suffix:semicolon
id|down
c_func
(paren
op_amp
id|u-&gt;readsem
)paren
suffix:semicolon
id|err
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|u-&gt;addr
)paren
r_goto
id|out
suffix:semicolon
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
id|addr
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|addr
)paren
op_plus
r_sizeof
(paren
r_int
)paren
op_plus
l_int|16
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|addr
)paren
r_goto
id|out
suffix:semicolon
id|memset
c_func
(paren
id|addr
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|addr
)paren
op_plus
r_sizeof
(paren
r_int
)paren
op_plus
l_int|16
)paren
suffix:semicolon
id|addr-&gt;name-&gt;sun_family
op_assign
id|AF_UNIX
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|addr-&gt;refcnt
comma
l_int|1
)paren
suffix:semicolon
id|retry
suffix:colon
id|addr-&gt;len
op_assign
id|sprintf
c_func
(paren
id|addr-&gt;name-&gt;sun_path
op_plus
l_int|1
comma
l_string|&quot;%05x&quot;
comma
id|ordernum
)paren
op_plus
l_int|1
op_plus
r_sizeof
(paren
r_int
)paren
suffix:semicolon
id|addr-&gt;hash
op_assign
id|unix_hash_fold
c_func
(paren
id|csum_partial
c_func
(paren
(paren
r_void
op_star
)paren
id|addr-&gt;name
comma
id|addr-&gt;len
comma
l_int|0
)paren
)paren
suffix:semicolon
id|write_lock
c_func
(paren
op_amp
id|unix_table_lock
)paren
suffix:semicolon
id|ordernum
op_assign
(paren
id|ordernum
op_plus
l_int|1
)paren
op_amp
l_int|0xFFFFF
suffix:semicolon
r_if
c_cond
(paren
id|__unix_find_socket_byname
c_func
(paren
id|addr-&gt;name
comma
id|addr-&gt;len
comma
id|sock-&gt;type
comma
id|addr-&gt;hash
)paren
)paren
(brace
id|write_unlock
c_func
(paren
op_amp
id|unix_table_lock
)paren
suffix:semicolon
multiline_comment|/* Sanity yield. It is unusual case, but yet... */
r_if
c_cond
(paren
op_logical_neg
(paren
id|ordernum
op_amp
l_int|0xFF
)paren
)paren
id|yield
c_func
(paren
)paren
suffix:semicolon
r_goto
id|retry
suffix:semicolon
)brace
id|addr-&gt;hash
op_xor_assign
id|sk-&gt;sk_type
suffix:semicolon
id|__unix_remove_socket
c_func
(paren
id|sk
)paren
suffix:semicolon
id|u-&gt;addr
op_assign
id|addr
suffix:semicolon
id|__unix_insert_socket
c_func
(paren
op_amp
id|unix_socket_table
(braket
id|addr-&gt;hash
)braket
comma
id|sk
)paren
suffix:semicolon
id|write_unlock
c_func
(paren
op_amp
id|unix_table_lock
)paren
suffix:semicolon
id|err
op_assign
l_int|0
suffix:semicolon
id|out
suffix:colon
id|up
c_func
(paren
op_amp
id|u-&gt;readsem
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|unix_find_other
r_static
id|unix_socket
op_star
id|unix_find_other
c_func
(paren
r_struct
id|sockaddr_un
op_star
id|sunname
comma
r_int
id|len
comma
r_int
id|type
comma
r_int
id|hash
comma
r_int
op_star
id|error
)paren
(brace
id|unix_socket
op_star
id|u
suffix:semicolon
r_struct
id|nameidata
id|nd
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|sunname-&gt;sun_path
(braket
l_int|0
)braket
)paren
(brace
id|err
op_assign
id|path_lookup
c_func
(paren
id|sunname-&gt;sun_path
comma
id|LOOKUP_FOLLOW
comma
op_amp
id|nd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|fail
suffix:semicolon
id|err
op_assign
id|permission
c_func
(paren
id|nd.dentry-&gt;d_inode
comma
id|MAY_WRITE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|put_fail
suffix:semicolon
id|err
op_assign
op_minus
id|ECONNREFUSED
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|S_ISSOCK
c_func
(paren
id|nd.dentry-&gt;d_inode-&gt;i_mode
)paren
)paren
r_goto
id|put_fail
suffix:semicolon
id|u
op_assign
id|unix_find_socket_byinode
c_func
(paren
id|nd.dentry-&gt;d_inode
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|u
)paren
r_goto
id|put_fail
suffix:semicolon
r_if
c_cond
(paren
id|u-&gt;sk_type
op_eq
id|type
)paren
id|update_atime
c_func
(paren
id|nd.dentry-&gt;d_inode
)paren
suffix:semicolon
id|path_release
c_func
(paren
op_amp
id|nd
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EPROTOTYPE
suffix:semicolon
r_if
c_cond
(paren
id|u-&gt;sk_type
op_ne
id|type
)paren
(brace
id|sock_put
c_func
(paren
id|u
)paren
suffix:semicolon
r_goto
id|fail
suffix:semicolon
)brace
)brace
r_else
(brace
id|err
op_assign
op_minus
id|ECONNREFUSED
suffix:semicolon
id|u
op_assign
id|unix_find_socket_byname
c_func
(paren
id|sunname
comma
id|len
comma
id|type
comma
id|hash
)paren
suffix:semicolon
r_if
c_cond
(paren
id|u
)paren
(brace
r_struct
id|dentry
op_star
id|dentry
suffix:semicolon
id|dentry
op_assign
id|unix_sk
c_func
(paren
id|u
)paren
op_member_access_from_pointer
id|dentry
suffix:semicolon
r_if
c_cond
(paren
id|dentry
)paren
id|update_atime
c_func
(paren
id|dentry-&gt;d_inode
)paren
suffix:semicolon
)brace
r_else
r_goto
id|fail
suffix:semicolon
)brace
r_return
id|u
suffix:semicolon
id|put_fail
suffix:colon
id|path_release
c_func
(paren
op_amp
id|nd
)paren
suffix:semicolon
id|fail
suffix:colon
op_star
id|error
op_assign
id|err
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|unix_bind
r_static
r_int
id|unix_bind
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_struct
id|sockaddr
op_star
id|uaddr
comma
r_int
id|addr_len
)paren
(brace
r_struct
id|sock
op_star
id|sk
op_assign
id|sock-&gt;sk
suffix:semicolon
r_struct
id|unix_sock
op_star
id|u
op_assign
id|unix_sk
c_func
(paren
id|sk
)paren
suffix:semicolon
r_struct
id|sockaddr_un
op_star
id|sunaddr
op_assign
(paren
r_struct
id|sockaddr_un
op_star
)paren
id|uaddr
suffix:semicolon
r_struct
id|dentry
op_star
id|dentry
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|nameidata
id|nd
suffix:semicolon
r_int
id|err
suffix:semicolon
r_int
id|hash
suffix:semicolon
r_struct
id|unix_address
op_star
id|addr
suffix:semicolon
r_struct
id|hlist_head
op_star
id|list
suffix:semicolon
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|sunaddr-&gt;sun_family
op_ne
id|AF_UNIX
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|addr_len
op_eq
r_sizeof
(paren
r_int
)paren
)paren
(brace
id|err
op_assign
id|unix_autobind
c_func
(paren
id|sock
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|err
op_assign
id|unix_mkname
c_func
(paren
id|sunaddr
comma
id|addr_len
comma
op_amp
id|hash
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
r_goto
id|out
suffix:semicolon
id|addr_len
op_assign
id|err
suffix:semicolon
id|down
c_func
(paren
op_amp
id|u-&gt;readsem
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|u-&gt;addr
)paren
r_goto
id|out_up
suffix:semicolon
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
id|addr
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|addr
)paren
op_plus
id|addr_len
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|addr
)paren
r_goto
id|out_up
suffix:semicolon
id|memcpy
c_func
(paren
id|addr-&gt;name
comma
id|sunaddr
comma
id|addr_len
)paren
suffix:semicolon
id|addr-&gt;len
op_assign
id|addr_len
suffix:semicolon
id|addr-&gt;hash
op_assign
id|hash
op_xor
id|sk-&gt;sk_type
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|addr-&gt;refcnt
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sunaddr-&gt;sun_path
(braket
l_int|0
)braket
)paren
(brace
r_int
r_int
id|mode
suffix:semicolon
id|err
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Get the parent directory, calculate the hash for last&n;&t;&t; * component.&n;&t;&t; */
id|err
op_assign
id|path_lookup
c_func
(paren
id|sunaddr-&gt;sun_path
comma
id|LOOKUP_PARENT
comma
op_amp
id|nd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|out_mknod_parent
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Yucky last component or no last component at all?&n;&t;&t; * (foo/., foo/.., /////)&n;&t;&t; */
id|err
op_assign
op_minus
id|EEXIST
suffix:semicolon
r_if
c_cond
(paren
id|nd.last_type
op_ne
id|LAST_NORM
)paren
r_goto
id|out_mknod
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Lock the directory.&n;&t;&t; */
id|down
c_func
(paren
op_amp
id|nd.dentry-&gt;d_inode-&gt;i_sem
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Do the final lookup.&n;&t;&t; */
id|dentry
op_assign
id|lookup_hash
c_func
(paren
op_amp
id|nd.last
comma
id|nd.dentry
)paren
suffix:semicolon
id|err
op_assign
id|PTR_ERR
c_func
(paren
id|dentry
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|dentry
)paren
)paren
r_goto
id|out_mknod_unlock
suffix:semicolon
id|err
op_assign
op_minus
id|ENOENT
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Special case - lookup gave negative, but... we had foo/bar/&n;&t;&t; * From the vfs_mknod() POV we just have a negative dentry -&n;&t;&t; * all is fine. Let&squot;s be bastards - you had / on the end, you&squot;ve&n;&t;&t; * been asking for (non-existent) directory. -ENOENT for you.&n;&t;&t; */
r_if
c_cond
(paren
id|nd.last.name
(braket
id|nd.last.len
)braket
op_logical_and
op_logical_neg
id|dentry-&gt;d_inode
)paren
r_goto
id|out_mknod_dput
suffix:semicolon
multiline_comment|/*&n;&t;&t; * All right, let&squot;s create it.&n;&t;&t; */
id|mode
op_assign
id|S_IFSOCK
op_or
(paren
id|SOCK_INODE
c_func
(paren
id|sock
)paren
op_member_access_from_pointer
id|i_mode
op_amp
op_complement
id|current-&gt;fs-&gt;umask
)paren
suffix:semicolon
id|err
op_assign
id|vfs_mknod
c_func
(paren
id|nd.dentry-&gt;d_inode
comma
id|dentry
comma
id|mode
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|out_mknod_dput
suffix:semicolon
id|up
c_func
(paren
op_amp
id|nd.dentry-&gt;d_inode-&gt;i_sem
)paren
suffix:semicolon
id|dput
c_func
(paren
id|nd.dentry
)paren
suffix:semicolon
id|nd.dentry
op_assign
id|dentry
suffix:semicolon
id|addr-&gt;hash
op_assign
id|UNIX_HASH_SIZE
suffix:semicolon
)brace
id|write_lock
c_func
(paren
op_amp
id|unix_table_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sunaddr-&gt;sun_path
(braket
l_int|0
)braket
)paren
(brace
id|err
op_assign
op_minus
id|EADDRINUSE
suffix:semicolon
r_if
c_cond
(paren
id|__unix_find_socket_byname
c_func
(paren
id|sunaddr
comma
id|addr_len
comma
id|sk-&gt;sk_type
comma
id|hash
)paren
)paren
(brace
id|unix_release_addr
c_func
(paren
id|addr
)paren
suffix:semicolon
r_goto
id|out_unlock
suffix:semicolon
)brace
id|list
op_assign
op_amp
id|unix_socket_table
(braket
id|addr-&gt;hash
)braket
suffix:semicolon
)brace
r_else
(brace
id|list
op_assign
op_amp
id|unix_socket_table
(braket
id|dentry-&gt;d_inode-&gt;i_ino
op_amp
(paren
id|UNIX_HASH_SIZE
op_minus
l_int|1
)paren
)braket
suffix:semicolon
id|u-&gt;dentry
op_assign
id|nd.dentry
suffix:semicolon
id|u-&gt;mnt
op_assign
id|nd.mnt
suffix:semicolon
)brace
id|err
op_assign
l_int|0
suffix:semicolon
id|__unix_remove_socket
c_func
(paren
id|sk
)paren
suffix:semicolon
id|u-&gt;addr
op_assign
id|addr
suffix:semicolon
id|__unix_insert_socket
c_func
(paren
id|list
comma
id|sk
)paren
suffix:semicolon
id|out_unlock
suffix:colon
id|write_unlock
c_func
(paren
op_amp
id|unix_table_lock
)paren
suffix:semicolon
id|out_up
suffix:colon
id|up
c_func
(paren
op_amp
id|u-&gt;readsem
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|err
suffix:semicolon
id|out_mknod_dput
suffix:colon
id|dput
c_func
(paren
id|dentry
)paren
suffix:semicolon
id|out_mknod_unlock
suffix:colon
id|up
c_func
(paren
op_amp
id|nd.dentry-&gt;d_inode-&gt;i_sem
)paren
suffix:semicolon
id|out_mknod
suffix:colon
id|path_release
c_func
(paren
op_amp
id|nd
)paren
suffix:semicolon
id|out_mknod_parent
suffix:colon
r_if
c_cond
(paren
id|err
op_eq
op_minus
id|EEXIST
)paren
id|err
op_assign
op_minus
id|EADDRINUSE
suffix:semicolon
id|unix_release_addr
c_func
(paren
id|addr
)paren
suffix:semicolon
r_goto
id|out_up
suffix:semicolon
)brace
DECL|function|unix_dgram_connect
r_static
r_int
id|unix_dgram_connect
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_struct
id|sockaddr
op_star
id|addr
comma
r_int
id|alen
comma
r_int
id|flags
)paren
(brace
r_struct
id|sock
op_star
id|sk
op_assign
id|sock-&gt;sk
suffix:semicolon
r_struct
id|sockaddr_un
op_star
id|sunaddr
op_assign
(paren
r_struct
id|sockaddr_un
op_star
)paren
id|addr
suffix:semicolon
r_struct
id|sock
op_star
id|other
suffix:semicolon
r_int
id|hash
suffix:semicolon
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
id|addr-&gt;sa_family
op_ne
id|AF_UNSPEC
)paren
(brace
id|err
op_assign
id|unix_mkname
c_func
(paren
id|sunaddr
comma
id|alen
comma
op_amp
id|hash
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
r_goto
id|out
suffix:semicolon
id|alen
op_assign
id|err
suffix:semicolon
r_if
c_cond
(paren
id|sock-&gt;passcred
op_logical_and
op_logical_neg
id|unix_sk
c_func
(paren
id|sk
)paren
op_member_access_from_pointer
id|addr
op_logical_and
(paren
id|err
op_assign
id|unix_autobind
c_func
(paren
id|sock
)paren
)paren
op_ne
l_int|0
)paren
r_goto
id|out
suffix:semicolon
id|other
op_assign
id|unix_find_other
c_func
(paren
id|sunaddr
comma
id|alen
comma
id|sock-&gt;type
comma
id|hash
comma
op_amp
id|err
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|other
)paren
r_goto
id|out
suffix:semicolon
id|unix_state_wlock
c_func
(paren
id|sk
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EPERM
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|unix_may_send
c_func
(paren
id|sk
comma
id|other
)paren
)paren
r_goto
id|out_unlock
suffix:semicolon
id|err
op_assign
id|security_unix_may_send
c_func
(paren
id|sk-&gt;sk_socket
comma
id|other-&gt;sk_socket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|out_unlock
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t; *&t;1003.1g breaking connected state with AF_UNSPEC&n;&t;&t; */
id|other
op_assign
l_int|NULL
suffix:semicolon
id|unix_state_wlock
c_func
(paren
id|sk
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * If it was connected, reconnect.&n;&t; */
r_if
c_cond
(paren
id|unix_peer
c_func
(paren
id|sk
)paren
)paren
(brace
r_struct
id|sock
op_star
id|old_peer
op_assign
id|unix_peer
c_func
(paren
id|sk
)paren
suffix:semicolon
id|unix_peer
c_func
(paren
id|sk
)paren
op_assign
id|other
suffix:semicolon
id|unix_state_wunlock
c_func
(paren
id|sk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|other
op_ne
id|old_peer
)paren
id|unix_dgram_disconnected
c_func
(paren
id|sk
comma
id|old_peer
)paren
suffix:semicolon
id|sock_put
c_func
(paren
id|old_peer
)paren
suffix:semicolon
)brace
r_else
(brace
id|unix_peer
c_func
(paren
id|sk
)paren
op_assign
id|other
suffix:semicolon
id|unix_state_wunlock
c_func
(paren
id|sk
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
id|out_unlock
suffix:colon
id|unix_state_wunlock
c_func
(paren
id|sk
)paren
suffix:semicolon
id|sock_put
c_func
(paren
id|other
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|err
suffix:semicolon
)brace
DECL|function|unix_wait_for_peer
r_static
r_int
id|unix_wait_for_peer
c_func
(paren
id|unix_socket
op_star
id|other
comma
r_int
id|timeo
)paren
(brace
r_struct
id|unix_sock
op_star
id|u
op_assign
id|unix_sk
c_func
(paren
id|other
)paren
suffix:semicolon
r_int
id|sched
suffix:semicolon
id|DEFINE_WAIT
c_func
(paren
id|wait
)paren
suffix:semicolon
id|prepare_to_wait_exclusive
c_func
(paren
op_amp
id|u-&gt;peer_wait
comma
op_amp
id|wait
comma
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|sched
op_assign
op_logical_neg
id|sock_flag
c_func
(paren
id|other
comma
id|SOCK_DEAD
)paren
op_logical_and
op_logical_neg
(paren
id|other-&gt;sk_shutdown
op_amp
id|RCV_SHUTDOWN
)paren
op_logical_and
(paren
id|skb_queue_len
c_func
(paren
op_amp
id|other-&gt;sk_receive_queue
)paren
OG
id|other-&gt;sk_max_ack_backlog
)paren
suffix:semicolon
id|unix_state_runlock
c_func
(paren
id|other
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sched
)paren
id|timeo
op_assign
id|schedule_timeout
c_func
(paren
id|timeo
)paren
suffix:semicolon
id|finish_wait
c_func
(paren
op_amp
id|u-&gt;peer_wait
comma
op_amp
id|wait
)paren
suffix:semicolon
r_return
id|timeo
suffix:semicolon
)brace
DECL|function|unix_stream_connect
r_static
r_int
id|unix_stream_connect
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_struct
id|sockaddr
op_star
id|uaddr
comma
r_int
id|addr_len
comma
r_int
id|flags
)paren
(brace
r_struct
id|sockaddr_un
op_star
id|sunaddr
op_assign
(paren
r_struct
id|sockaddr_un
op_star
)paren
id|uaddr
suffix:semicolon
r_struct
id|sock
op_star
id|sk
op_assign
id|sock-&gt;sk
suffix:semicolon
r_struct
id|unix_sock
op_star
id|u
op_assign
id|unix_sk
c_func
(paren
id|sk
)paren
comma
op_star
id|newu
comma
op_star
id|otheru
suffix:semicolon
r_struct
id|sock
op_star
id|newsk
op_assign
l_int|NULL
suffix:semicolon
id|unix_socket
op_star
id|other
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
op_assign
l_int|NULL
suffix:semicolon
r_int
id|hash
suffix:semicolon
r_int
id|st
suffix:semicolon
r_int
id|err
suffix:semicolon
r_int
id|timeo
suffix:semicolon
id|err
op_assign
id|unix_mkname
c_func
(paren
id|sunaddr
comma
id|addr_len
comma
op_amp
id|hash
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
r_goto
id|out
suffix:semicolon
id|addr_len
op_assign
id|err
suffix:semicolon
r_if
c_cond
(paren
id|sock-&gt;passcred
op_logical_and
op_logical_neg
id|u-&gt;addr
op_logical_and
(paren
id|err
op_assign
id|unix_autobind
c_func
(paren
id|sock
)paren
)paren
op_ne
l_int|0
)paren
r_goto
id|out
suffix:semicolon
id|timeo
op_assign
id|sock_sndtimeo
c_func
(paren
id|sk
comma
id|flags
op_amp
id|O_NONBLOCK
)paren
suffix:semicolon
multiline_comment|/* First of all allocate resources.&n;&t;   If we will make it after state is locked,&n;&t;   we will have to recheck all again in any case.&n;&t; */
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
multiline_comment|/* create new sock for complete connection */
id|newsk
op_assign
id|unix_create1
c_func
(paren
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|newsk
op_eq
l_int|NULL
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* Allocate skb for sending to listening sock */
id|skb
op_assign
id|sock_wmalloc
c_func
(paren
id|newsk
comma
l_int|1
comma
l_int|0
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
r_goto
id|out
suffix:semicolon
id|restart
suffix:colon
multiline_comment|/*  Find listening sock. */
id|other
op_assign
id|unix_find_other
c_func
(paren
id|sunaddr
comma
id|addr_len
comma
id|sk-&gt;sk_type
comma
id|hash
comma
op_amp
id|err
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|other
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* Latch state of peer */
id|unix_state_rlock
c_func
(paren
id|other
)paren
suffix:semicolon
multiline_comment|/* Apparently VFS overslept socket death. Retry. */
r_if
c_cond
(paren
id|sock_flag
c_func
(paren
id|other
comma
id|SOCK_DEAD
)paren
)paren
(brace
id|unix_state_runlock
c_func
(paren
id|other
)paren
suffix:semicolon
id|sock_put
c_func
(paren
id|other
)paren
suffix:semicolon
r_goto
id|restart
suffix:semicolon
)brace
id|err
op_assign
op_minus
id|ECONNREFUSED
suffix:semicolon
r_if
c_cond
(paren
id|other-&gt;sk_state
op_ne
id|TCP_LISTEN
)paren
r_goto
id|out_unlock
suffix:semicolon
r_if
c_cond
(paren
id|skb_queue_len
c_func
(paren
op_amp
id|other-&gt;sk_receive_queue
)paren
OG
id|other-&gt;sk_max_ack_backlog
)paren
(brace
id|err
op_assign
op_minus
id|EAGAIN
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|timeo
)paren
r_goto
id|out_unlock
suffix:semicolon
id|timeo
op_assign
id|unix_wait_for_peer
c_func
(paren
id|other
comma
id|timeo
)paren
suffix:semicolon
id|err
op_assign
id|sock_intr_errno
c_func
(paren
id|timeo
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
r_goto
id|out
suffix:semicolon
id|sock_put
c_func
(paren
id|other
)paren
suffix:semicolon
r_goto
id|restart
suffix:semicolon
)brace
multiline_comment|/* Latch our state.&n;&n;&t;   It is tricky place. We need to grab write lock and cannot&n;&t;   drop lock on peer. It is dangerous because deadlock is&n;&t;   possible. Connect to self case and simultaneous&n;&t;   attempt to connect are eliminated by checking socket&n;&t;   state. other is TCP_LISTEN, if sk is TCP_LISTEN we&n;&t;   check this before attempt to grab lock.&n;&n;&t;   Well, and we have to recheck the state after socket locked.&n;&t; */
id|st
op_assign
id|sk-&gt;sk_state
suffix:semicolon
r_switch
c_cond
(paren
id|st
)paren
(brace
r_case
id|TCP_CLOSE
suffix:colon
multiline_comment|/* This is ok... continue with connect */
r_break
suffix:semicolon
r_case
id|TCP_ESTABLISHED
suffix:colon
multiline_comment|/* Socket is already connected */
id|err
op_assign
op_minus
id|EISCONN
suffix:semicolon
r_goto
id|out_unlock
suffix:semicolon
r_default
suffix:colon
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|out_unlock
suffix:semicolon
)brace
id|unix_state_wlock
c_func
(paren
id|sk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;sk_state
op_ne
id|st
)paren
(brace
id|unix_state_wunlock
c_func
(paren
id|sk
)paren
suffix:semicolon
id|unix_state_runlock
c_func
(paren
id|other
)paren
suffix:semicolon
id|sock_put
c_func
(paren
id|other
)paren
suffix:semicolon
r_goto
id|restart
suffix:semicolon
)brace
id|err
op_assign
id|security_unix_stream_connect
c_func
(paren
id|sock
comma
id|other-&gt;sk_socket
comma
id|newsk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|unix_state_wunlock
c_func
(paren
id|sk
)paren
suffix:semicolon
r_goto
id|out_unlock
suffix:semicolon
)brace
multiline_comment|/* The way is open! Fastly set all the necessary fields... */
id|sock_hold
c_func
(paren
id|sk
)paren
suffix:semicolon
id|unix_peer
c_func
(paren
id|newsk
)paren
op_assign
id|sk
suffix:semicolon
id|newsk-&gt;sk_state
op_assign
id|TCP_ESTABLISHED
suffix:semicolon
id|newsk-&gt;sk_type
op_assign
id|SOCK_STREAM
suffix:semicolon
id|newsk-&gt;sk_peercred.pid
op_assign
id|current-&gt;pid
suffix:semicolon
id|newsk-&gt;sk_peercred.uid
op_assign
id|current-&gt;euid
suffix:semicolon
id|newsk-&gt;sk_peercred.gid
op_assign
id|current-&gt;egid
suffix:semicolon
id|newu
op_assign
id|unix_sk
c_func
(paren
id|newsk
)paren
suffix:semicolon
id|newsk-&gt;sk_sleep
op_assign
op_amp
id|newu-&gt;peer_wait
suffix:semicolon
id|otheru
op_assign
id|unix_sk
c_func
(paren
id|other
)paren
suffix:semicolon
multiline_comment|/* copy address information from listening to new sock*/
r_if
c_cond
(paren
id|otheru-&gt;addr
)paren
(brace
id|atomic_inc
c_func
(paren
op_amp
id|otheru-&gt;addr-&gt;refcnt
)paren
suffix:semicolon
id|newu-&gt;addr
op_assign
id|otheru-&gt;addr
suffix:semicolon
)brace
r_if
c_cond
(paren
id|otheru-&gt;dentry
)paren
(brace
id|newu-&gt;dentry
op_assign
id|dget
c_func
(paren
id|otheru-&gt;dentry
)paren
suffix:semicolon
id|newu-&gt;mnt
op_assign
id|mntget
c_func
(paren
id|otheru-&gt;mnt
)paren
suffix:semicolon
)brace
multiline_comment|/* Set credentials */
id|sk-&gt;sk_peercred
op_assign
id|other-&gt;sk_peercred
suffix:semicolon
id|sock_hold
c_func
(paren
id|newsk
)paren
suffix:semicolon
id|unix_peer
c_func
(paren
id|sk
)paren
op_assign
id|newsk
suffix:semicolon
id|sock-&gt;state
op_assign
id|SS_CONNECTED
suffix:semicolon
id|sk-&gt;sk_state
op_assign
id|TCP_ESTABLISHED
suffix:semicolon
id|unix_state_wunlock
c_func
(paren
id|sk
)paren
suffix:semicolon
multiline_comment|/* take ten and and send info to listening sock */
id|spin_lock
c_func
(paren
op_amp
id|other-&gt;sk_receive_queue.lock
)paren
suffix:semicolon
id|__skb_queue_tail
c_func
(paren
op_amp
id|other-&gt;sk_receive_queue
comma
id|skb
)paren
suffix:semicolon
multiline_comment|/* Undo artificially decreased inflight after embrion&n;&t; * is installed to listening socket. */
id|atomic_inc
c_func
(paren
op_amp
id|newu-&gt;inflight
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|other-&gt;sk_receive_queue.lock
)paren
suffix:semicolon
id|unix_state_runlock
c_func
(paren
id|other
)paren
suffix:semicolon
id|other
op_member_access_from_pointer
id|sk_data_ready
c_func
(paren
id|other
comma
l_int|0
)paren
suffix:semicolon
id|sock_put
c_func
(paren
id|other
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|out_unlock
suffix:colon
r_if
c_cond
(paren
id|other
)paren
id|unix_state_runlock
c_func
(paren
id|other
)paren
suffix:semicolon
id|out
suffix:colon
r_if
c_cond
(paren
id|skb
)paren
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|newsk
)paren
id|unix_release_sock
c_func
(paren
id|newsk
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|other
)paren
id|sock_put
c_func
(paren
id|other
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|unix_socketpair
r_static
r_int
id|unix_socketpair
c_func
(paren
r_struct
id|socket
op_star
id|socka
comma
r_struct
id|socket
op_star
id|sockb
)paren
(brace
r_struct
id|sock
op_star
id|ska
op_assign
id|socka-&gt;sk
comma
op_star
id|skb
op_assign
id|sockb-&gt;sk
suffix:semicolon
multiline_comment|/* Join our sockets back to back */
id|sock_hold
c_func
(paren
id|ska
)paren
suffix:semicolon
id|sock_hold
c_func
(paren
id|skb
)paren
suffix:semicolon
id|unix_peer
c_func
(paren
id|ska
)paren
op_assign
id|skb
suffix:semicolon
id|unix_peer
c_func
(paren
id|skb
)paren
op_assign
id|ska
suffix:semicolon
id|ska-&gt;sk_peercred.pid
op_assign
id|skb-&gt;sk_peercred.pid
op_assign
id|current-&gt;pid
suffix:semicolon
id|ska-&gt;sk_peercred.uid
op_assign
id|skb-&gt;sk_peercred.uid
op_assign
id|current-&gt;euid
suffix:semicolon
id|ska-&gt;sk_peercred.gid
op_assign
id|skb-&gt;sk_peercred.gid
op_assign
id|current-&gt;egid
suffix:semicolon
r_if
c_cond
(paren
id|ska-&gt;sk_type
op_ne
id|SOCK_DGRAM
)paren
(brace
id|ska-&gt;sk_state
op_assign
id|TCP_ESTABLISHED
suffix:semicolon
id|skb-&gt;sk_state
op_assign
id|TCP_ESTABLISHED
suffix:semicolon
id|socka-&gt;state
op_assign
id|SS_CONNECTED
suffix:semicolon
id|sockb-&gt;state
op_assign
id|SS_CONNECTED
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|unix_accept
r_static
r_int
id|unix_accept
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_struct
id|socket
op_star
id|newsock
comma
r_int
id|flags
)paren
(brace
id|unix_socket
op_star
id|sk
op_assign
id|sock-&gt;sk
suffix:semicolon
id|unix_socket
op_star
id|tsk
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|err
suffix:semicolon
id|err
op_assign
op_minus
id|EOPNOTSUPP
suffix:semicolon
r_if
c_cond
(paren
id|sock-&gt;type
op_ne
id|SOCK_STREAM
)paren
r_goto
id|out
suffix:semicolon
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;sk_state
op_ne
id|TCP_LISTEN
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* If socket state is TCP_LISTEN it cannot change (for now...),&n;&t; * so that no locks are necessary.&n;&t; */
id|skb
op_assign
id|skb_recv_datagram
c_func
(paren
id|sk
comma
l_int|0
comma
id|flags
op_amp
id|O_NONBLOCK
comma
op_amp
id|err
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
(brace
multiline_comment|/* This means receive shutdown. */
r_if
c_cond
(paren
id|err
op_eq
l_int|0
)paren
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|tsk
op_assign
id|skb-&gt;sk
suffix:semicolon
id|skb_free_datagram
c_func
(paren
id|sk
comma
id|skb
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|unix_sk
c_func
(paren
id|sk
)paren
op_member_access_from_pointer
id|peer_wait
)paren
suffix:semicolon
multiline_comment|/* attach accepted sock to socket */
id|unix_state_wlock
c_func
(paren
id|tsk
)paren
suffix:semicolon
id|newsock-&gt;state
op_assign
id|SS_CONNECTED
suffix:semicolon
id|sock_graft
c_func
(paren
id|tsk
comma
id|newsock
)paren
suffix:semicolon
id|unix_state_wunlock
c_func
(paren
id|tsk
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|out
suffix:colon
r_return
id|err
suffix:semicolon
)brace
DECL|function|unix_getname
r_static
r_int
id|unix_getname
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_struct
id|sockaddr
op_star
id|uaddr
comma
r_int
op_star
id|uaddr_len
comma
r_int
id|peer
)paren
(brace
r_struct
id|sock
op_star
id|sk
op_assign
id|sock-&gt;sk
suffix:semicolon
r_struct
id|unix_sock
op_star
id|u
suffix:semicolon
r_struct
id|sockaddr_un
op_star
id|sunaddr
op_assign
(paren
r_struct
id|sockaddr_un
op_star
)paren
id|uaddr
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|peer
)paren
(brace
id|sk
op_assign
id|unix_peer_get
c_func
(paren
id|sk
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|ENOTCONN
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sk
)paren
r_goto
id|out
suffix:semicolon
id|err
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|sock_hold
c_func
(paren
id|sk
)paren
suffix:semicolon
)brace
id|u
op_assign
id|unix_sk
c_func
(paren
id|sk
)paren
suffix:semicolon
id|unix_state_rlock
c_func
(paren
id|sk
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|u-&gt;addr
)paren
(brace
id|sunaddr-&gt;sun_family
op_assign
id|AF_UNIX
suffix:semicolon
id|sunaddr-&gt;sun_path
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
op_star
id|uaddr_len
op_assign
r_sizeof
(paren
r_int
)paren
suffix:semicolon
)brace
r_else
(brace
r_struct
id|unix_address
op_star
id|addr
op_assign
id|u-&gt;addr
suffix:semicolon
op_star
id|uaddr_len
op_assign
id|addr-&gt;len
suffix:semicolon
id|memcpy
c_func
(paren
id|sunaddr
comma
id|addr-&gt;name
comma
op_star
id|uaddr_len
)paren
suffix:semicolon
)brace
id|unix_state_runlock
c_func
(paren
id|sk
)paren
suffix:semicolon
id|sock_put
c_func
(paren
id|sk
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|err
suffix:semicolon
)brace
DECL|function|unix_detach_fds
r_static
r_void
id|unix_detach_fds
c_func
(paren
r_struct
id|scm_cookie
op_star
id|scm
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_int
id|i
suffix:semicolon
id|scm-&gt;fp
op_assign
id|UNIXCB
c_func
(paren
id|skb
)paren
dot
id|fp
suffix:semicolon
id|skb-&gt;destructor
op_assign
id|sock_wfree
suffix:semicolon
id|UNIXCB
c_func
(paren
id|skb
)paren
dot
id|fp
op_assign
l_int|NULL
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|scm-&gt;fp-&gt;count
op_minus
l_int|1
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
id|unix_notinflight
c_func
(paren
id|scm-&gt;fp-&gt;fp
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
DECL|function|unix_destruct_fds
r_static
r_void
id|unix_destruct_fds
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|scm_cookie
id|scm
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|scm
comma
l_int|0
comma
r_sizeof
(paren
id|scm
)paren
)paren
suffix:semicolon
id|unix_detach_fds
c_func
(paren
op_amp
id|scm
comma
id|skb
)paren
suffix:semicolon
multiline_comment|/* Alas, it calls VFS */
multiline_comment|/* So fscking what? fput() had been SMP-safe since the last Summer */
id|scm_destroy
c_func
(paren
op_amp
id|scm
)paren
suffix:semicolon
id|sock_wfree
c_func
(paren
id|skb
)paren
suffix:semicolon
)brace
DECL|function|unix_attach_fds
r_static
r_void
id|unix_attach_fds
c_func
(paren
r_struct
id|scm_cookie
op_star
id|scm
comma
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|scm-&gt;fp-&gt;count
op_minus
l_int|1
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
id|unix_inflight
c_func
(paren
id|scm-&gt;fp-&gt;fp
(braket
id|i
)braket
)paren
suffix:semicolon
id|UNIXCB
c_func
(paren
id|skb
)paren
dot
id|fp
op_assign
id|scm-&gt;fp
suffix:semicolon
id|skb-&gt;destructor
op_assign
id|unix_destruct_fds
suffix:semicolon
id|scm-&gt;fp
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Send AF_UNIX data.&n; */
DECL|function|unix_dgram_sendmsg
r_static
r_int
id|unix_dgram_sendmsg
c_func
(paren
r_struct
id|kiocb
op_star
id|kiocb
comma
r_struct
id|socket
op_star
id|sock
comma
r_struct
id|msghdr
op_star
id|msg
comma
r_int
id|len
)paren
(brace
r_struct
id|sock_iocb
op_star
id|siocb
op_assign
id|kiocb_to_siocb
c_func
(paren
id|kiocb
)paren
suffix:semicolon
r_struct
id|sock
op_star
id|sk
op_assign
id|sock-&gt;sk
suffix:semicolon
r_struct
id|unix_sock
op_star
id|u
op_assign
id|unix_sk
c_func
(paren
id|sk
)paren
suffix:semicolon
r_struct
id|sockaddr_un
op_star
id|sunaddr
op_assign
id|msg-&gt;msg_name
suffix:semicolon
id|unix_socket
op_star
id|other
op_assign
l_int|NULL
suffix:semicolon
r_int
id|namelen
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* fake GCC */
r_int
id|err
suffix:semicolon
r_int
id|hash
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|timeo
suffix:semicolon
r_struct
id|scm_cookie
id|tmp_scm
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_eq
id|siocb-&gt;scm
)paren
id|siocb-&gt;scm
op_assign
op_amp
id|tmp_scm
suffix:semicolon
id|err
op_assign
id|scm_send
c_func
(paren
id|sock
comma
id|msg
comma
id|siocb-&gt;scm
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
id|err
op_assign
op_minus
id|EOPNOTSUPP
suffix:semicolon
r_if
c_cond
(paren
id|msg-&gt;msg_flags
op_amp
id|MSG_OOB
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|msg-&gt;msg_namelen
)paren
(brace
id|err
op_assign
id|unix_mkname
c_func
(paren
id|sunaddr
comma
id|msg-&gt;msg_namelen
comma
op_amp
id|hash
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
r_goto
id|out
suffix:semicolon
id|namelen
op_assign
id|err
suffix:semicolon
)brace
r_else
(brace
id|sunaddr
op_assign
l_int|NULL
suffix:semicolon
id|err
op_assign
op_minus
id|ENOTCONN
suffix:semicolon
id|other
op_assign
id|unix_peer_get
c_func
(paren
id|sk
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|other
)paren
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sock-&gt;passcred
op_logical_and
op_logical_neg
id|u-&gt;addr
op_logical_and
(paren
id|err
op_assign
id|unix_autobind
c_func
(paren
id|sock
)paren
)paren
op_ne
l_int|0
)paren
r_goto
id|out
suffix:semicolon
id|err
op_assign
op_minus
id|EMSGSIZE
suffix:semicolon
r_if
c_cond
(paren
(paren
r_int
)paren
id|len
OG
id|sk-&gt;sk_sndbuf
op_minus
l_int|32
)paren
r_goto
id|out
suffix:semicolon
id|skb
op_assign
id|sock_alloc_send_skb
c_func
(paren
id|sk
comma
id|len
comma
id|msg-&gt;msg_flags
op_amp
id|MSG_DONTWAIT
comma
op_amp
id|err
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
r_goto
id|out
suffix:semicolon
id|memcpy
c_func
(paren
id|UNIXCREDS
c_func
(paren
id|skb
)paren
comma
op_amp
id|siocb-&gt;scm-&gt;creds
comma
r_sizeof
(paren
r_struct
id|ucred
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|siocb-&gt;scm-&gt;fp
)paren
id|unix_attach_fds
c_func
(paren
id|siocb-&gt;scm
comma
id|skb
)paren
suffix:semicolon
id|skb-&gt;h.raw
op_assign
id|skb-&gt;data
suffix:semicolon
id|err
op_assign
id|memcpy_fromiovec
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|len
)paren
comma
id|msg-&gt;msg_iov
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|out_free
suffix:semicolon
id|timeo
op_assign
id|sock_sndtimeo
c_func
(paren
id|sk
comma
id|msg-&gt;msg_flags
op_amp
id|MSG_DONTWAIT
)paren
suffix:semicolon
id|restart
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|other
)paren
(brace
id|err
op_assign
op_minus
id|ECONNRESET
suffix:semicolon
r_if
c_cond
(paren
id|sunaddr
op_eq
l_int|NULL
)paren
r_goto
id|out_free
suffix:semicolon
id|other
op_assign
id|unix_find_other
c_func
(paren
id|sunaddr
comma
id|namelen
comma
id|sk-&gt;sk_type
comma
id|hash
comma
op_amp
id|err
)paren
suffix:semicolon
r_if
c_cond
(paren
id|other
op_eq
l_int|NULL
)paren
r_goto
id|out_free
suffix:semicolon
)brace
id|unix_state_rlock
c_func
(paren
id|other
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EPERM
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|unix_may_send
c_func
(paren
id|sk
comma
id|other
)paren
)paren
r_goto
id|out_unlock
suffix:semicolon
r_if
c_cond
(paren
id|sock_flag
c_func
(paren
id|other
comma
id|SOCK_DEAD
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t; *&t;Check with 1003.1g - what should&n;&t;&t; *&t;datagram error&n;&t;&t; */
id|unix_state_runlock
c_func
(paren
id|other
)paren
suffix:semicolon
id|sock_put
c_func
(paren
id|other
)paren
suffix:semicolon
id|err
op_assign
l_int|0
suffix:semicolon
id|unix_state_wlock
c_func
(paren
id|sk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unix_peer
c_func
(paren
id|sk
)paren
op_eq
id|other
)paren
(brace
id|unix_peer
c_func
(paren
id|sk
)paren
op_assign
l_int|NULL
suffix:semicolon
id|unix_state_wunlock
c_func
(paren
id|sk
)paren
suffix:semicolon
id|unix_dgram_disconnected
c_func
(paren
id|sk
comma
id|other
)paren
suffix:semicolon
id|sock_put
c_func
(paren
id|other
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|ECONNREFUSED
suffix:semicolon
)brace
r_else
(brace
id|unix_state_wunlock
c_func
(paren
id|sk
)paren
suffix:semicolon
)brace
id|other
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|out_free
suffix:semicolon
r_goto
id|restart
suffix:semicolon
)brace
id|err
op_assign
op_minus
id|EPIPE
suffix:semicolon
r_if
c_cond
(paren
id|other-&gt;sk_shutdown
op_amp
id|RCV_SHUTDOWN
)paren
r_goto
id|out_unlock
suffix:semicolon
id|err
op_assign
id|security_unix_may_send
c_func
(paren
id|sk-&gt;sk_socket
comma
id|other-&gt;sk_socket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|out_unlock
suffix:semicolon
r_if
c_cond
(paren
id|unix_peer
c_func
(paren
id|other
)paren
op_ne
id|sk
op_logical_and
(paren
id|skb_queue_len
c_func
(paren
op_amp
id|other-&gt;sk_receive_queue
)paren
OG
id|other-&gt;sk_max_ack_backlog
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|timeo
)paren
(brace
id|err
op_assign
op_minus
id|EAGAIN
suffix:semicolon
r_goto
id|out_unlock
suffix:semicolon
)brace
id|timeo
op_assign
id|unix_wait_for_peer
c_func
(paren
id|other
comma
id|timeo
)paren
suffix:semicolon
id|err
op_assign
id|sock_intr_errno
c_func
(paren
id|timeo
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
r_goto
id|out_free
suffix:semicolon
r_goto
id|restart
suffix:semicolon
)brace
id|skb_queue_tail
c_func
(paren
op_amp
id|other-&gt;sk_receive_queue
comma
id|skb
)paren
suffix:semicolon
id|unix_state_runlock
c_func
(paren
id|other
)paren
suffix:semicolon
id|other
op_member_access_from_pointer
id|sk_data_ready
c_func
(paren
id|other
comma
id|len
)paren
suffix:semicolon
id|sock_put
c_func
(paren
id|other
)paren
suffix:semicolon
id|scm_destroy
c_func
(paren
id|siocb-&gt;scm
)paren
suffix:semicolon
r_return
id|len
suffix:semicolon
id|out_unlock
suffix:colon
id|unix_state_runlock
c_func
(paren
id|other
)paren
suffix:semicolon
id|out_free
suffix:colon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|out
suffix:colon
r_if
c_cond
(paren
id|other
)paren
id|sock_put
c_func
(paren
id|other
)paren
suffix:semicolon
id|scm_destroy
c_func
(paren
id|siocb-&gt;scm
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|unix_stream_sendmsg
r_static
r_int
id|unix_stream_sendmsg
c_func
(paren
r_struct
id|kiocb
op_star
id|kiocb
comma
r_struct
id|socket
op_star
id|sock
comma
r_struct
id|msghdr
op_star
id|msg
comma
r_int
id|len
)paren
(brace
r_struct
id|sock_iocb
op_star
id|siocb
op_assign
id|kiocb_to_siocb
c_func
(paren
id|kiocb
)paren
suffix:semicolon
r_struct
id|sock
op_star
id|sk
op_assign
id|sock-&gt;sk
suffix:semicolon
id|unix_socket
op_star
id|other
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|sockaddr_un
op_star
id|sunaddr
op_assign
id|msg-&gt;msg_name
suffix:semicolon
r_int
id|err
comma
id|size
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|sent
op_assign
l_int|0
suffix:semicolon
r_struct
id|scm_cookie
id|tmp_scm
suffix:semicolon
r_if
c_cond
(paren
l_int|NULL
op_eq
id|siocb-&gt;scm
)paren
id|siocb-&gt;scm
op_assign
op_amp
id|tmp_scm
suffix:semicolon
id|err
op_assign
id|scm_send
c_func
(paren
id|sock
comma
id|msg
comma
id|siocb-&gt;scm
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
OL
l_int|0
)paren
r_return
id|err
suffix:semicolon
id|err
op_assign
op_minus
id|EOPNOTSUPP
suffix:semicolon
r_if
c_cond
(paren
id|msg-&gt;msg_flags
op_amp
id|MSG_OOB
)paren
r_goto
id|out_err
suffix:semicolon
r_if
c_cond
(paren
id|msg-&gt;msg_namelen
)paren
(brace
id|err
op_assign
id|sk-&gt;sk_state
op_eq
id|TCP_ESTABLISHED
ques
c_cond
op_minus
id|EISCONN
suffix:colon
op_minus
id|EOPNOTSUPP
suffix:semicolon
r_goto
id|out_err
suffix:semicolon
)brace
r_else
(brace
id|sunaddr
op_assign
l_int|NULL
suffix:semicolon
id|err
op_assign
op_minus
id|ENOTCONN
suffix:semicolon
id|other
op_assign
id|unix_peer_get
c_func
(paren
id|sk
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|other
)paren
r_goto
id|out_err
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sk-&gt;sk_shutdown
op_amp
id|SEND_SHUTDOWN
)paren
r_goto
id|pipe_err
suffix:semicolon
r_while
c_loop
(paren
id|sent
OL
id|len
)paren
(brace
multiline_comment|/*&n;&t;&t; *&t;Optimisation for the fact that under 0.01% of X messages typically&n;&t;&t; *&t;need breaking up.&n;&t;&t; */
id|size
op_assign
id|len
op_minus
id|sent
suffix:semicolon
multiline_comment|/* Keep two messages in the pipe so it schedules better */
r_if
c_cond
(paren
id|size
OG
id|sk-&gt;sk_sndbuf
op_div
l_int|2
op_minus
l_int|64
)paren
id|size
op_assign
id|sk-&gt;sk_sndbuf
op_div
l_int|2
op_minus
l_int|64
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
id|SKB_MAX_ALLOC
)paren
id|size
op_assign
id|SKB_MAX_ALLOC
suffix:semicolon
multiline_comment|/*&n;&t;&t; *&t;Grab a buffer&n;&t;&t; */
id|skb
op_assign
id|sock_alloc_send_skb
c_func
(paren
id|sk
comma
id|size
comma
id|msg-&gt;msg_flags
op_amp
id|MSG_DONTWAIT
comma
op_amp
id|err
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
r_goto
id|out_err
suffix:semicolon
multiline_comment|/*&n;&t;&t; *&t;If you pass two values to the sock_alloc_send_skb&n;&t;&t; *&t;it tries to grab the large buffer with GFP_NOFS&n;&t;&t; *&t;(which can fail easily), and if it fails grab the&n;&t;&t; *&t;fallback size buffer which is under a page and will&n;&t;&t; *&t;succeed. [Alan]&n;&t;&t; */
id|size
op_assign
id|min_t
c_func
(paren
r_int
comma
id|size
comma
id|skb_tailroom
c_func
(paren
id|skb
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|UNIXCREDS
c_func
(paren
id|skb
)paren
comma
op_amp
id|siocb-&gt;scm-&gt;creds
comma
r_sizeof
(paren
r_struct
id|ucred
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|siocb-&gt;scm-&gt;fp
)paren
id|unix_attach_fds
c_func
(paren
id|siocb-&gt;scm
comma
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|memcpy_fromiovec
c_func
(paren
id|skb_put
c_func
(paren
id|skb
comma
id|size
)paren
comma
id|msg-&gt;msg_iov
comma
id|size
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_goto
id|out_err
suffix:semicolon
)brace
id|unix_state_rlock
c_func
(paren
id|other
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sock_flag
c_func
(paren
id|other
comma
id|SOCK_DEAD
)paren
op_logical_or
(paren
id|other-&gt;sk_shutdown
op_amp
id|RCV_SHUTDOWN
)paren
)paren
r_goto
id|pipe_err_free
suffix:semicolon
id|skb_queue_tail
c_func
(paren
op_amp
id|other-&gt;sk_receive_queue
comma
id|skb
)paren
suffix:semicolon
id|unix_state_runlock
c_func
(paren
id|other
)paren
suffix:semicolon
id|other
op_member_access_from_pointer
id|sk_data_ready
c_func
(paren
id|other
comma
id|size
)paren
suffix:semicolon
id|sent
op_add_assign
id|size
suffix:semicolon
)brace
id|sock_put
c_func
(paren
id|other
)paren
suffix:semicolon
id|scm_destroy
c_func
(paren
id|siocb-&gt;scm
)paren
suffix:semicolon
id|siocb-&gt;scm
op_assign
l_int|NULL
suffix:semicolon
r_return
id|sent
suffix:semicolon
id|pipe_err_free
suffix:colon
id|unix_state_runlock
c_func
(paren
id|other
)paren
suffix:semicolon
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|pipe_err
suffix:colon
r_if
c_cond
(paren
id|sent
op_eq
l_int|0
op_logical_and
op_logical_neg
(paren
id|msg-&gt;msg_flags
op_amp
id|MSG_NOSIGNAL
)paren
)paren
id|send_sig
c_func
(paren
id|SIGPIPE
comma
id|current
comma
l_int|0
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EPIPE
suffix:semicolon
id|out_err
suffix:colon
r_if
c_cond
(paren
id|other
)paren
id|sock_put
c_func
(paren
id|other
)paren
suffix:semicolon
id|scm_destroy
c_func
(paren
id|siocb-&gt;scm
)paren
suffix:semicolon
id|siocb-&gt;scm
op_assign
l_int|NULL
suffix:semicolon
r_return
id|sent
ques
c_cond
suffix:colon
id|err
suffix:semicolon
)brace
DECL|function|unix_copy_addr
r_static
r_void
id|unix_copy_addr
c_func
(paren
r_struct
id|msghdr
op_star
id|msg
comma
r_struct
id|sock
op_star
id|sk
)paren
(brace
r_struct
id|unix_sock
op_star
id|u
op_assign
id|unix_sk
c_func
(paren
id|sk
)paren
suffix:semicolon
id|msg-&gt;msg_namelen
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|u-&gt;addr
)paren
(brace
id|msg-&gt;msg_namelen
op_assign
id|u-&gt;addr-&gt;len
suffix:semicolon
id|memcpy
c_func
(paren
id|msg-&gt;msg_name
comma
id|u-&gt;addr-&gt;name
comma
id|u-&gt;addr-&gt;len
)paren
suffix:semicolon
)brace
)brace
DECL|function|unix_dgram_recvmsg
r_static
r_int
id|unix_dgram_recvmsg
c_func
(paren
r_struct
id|kiocb
op_star
id|iocb
comma
r_struct
id|socket
op_star
id|sock
comma
r_struct
id|msghdr
op_star
id|msg
comma
r_int
id|size
comma
r_int
id|flags
)paren
(brace
r_struct
id|sock_iocb
op_star
id|siocb
op_assign
id|kiocb_to_siocb
c_func
(paren
id|iocb
)paren
suffix:semicolon
r_struct
id|scm_cookie
id|tmp_scm
suffix:semicolon
r_struct
id|sock
op_star
id|sk
op_assign
id|sock-&gt;sk
suffix:semicolon
r_struct
id|unix_sock
op_star
id|u
op_assign
id|unix_sk
c_func
(paren
id|sk
)paren
suffix:semicolon
r_int
id|noblock
op_assign
id|flags
op_amp
id|MSG_DONTWAIT
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_int
id|err
suffix:semicolon
id|err
op_assign
op_minus
id|EOPNOTSUPP
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
id|MSG_OOB
)paren
r_goto
id|out
suffix:semicolon
id|msg-&gt;msg_namelen
op_assign
l_int|0
suffix:semicolon
id|skb
op_assign
id|skb_recv_datagram
c_func
(paren
id|sk
comma
id|flags
comma
id|noblock
comma
op_amp
id|err
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb
)paren
r_goto
id|out
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|u-&gt;peer_wait
)paren
suffix:semicolon
r_if
c_cond
(paren
id|msg-&gt;msg_name
)paren
id|unix_copy_addr
c_func
(paren
id|msg
comma
id|skb-&gt;sk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
id|skb-&gt;len
)paren
id|size
op_assign
id|skb-&gt;len
suffix:semicolon
r_else
r_if
c_cond
(paren
id|size
OL
id|skb-&gt;len
)paren
id|msg-&gt;msg_flags
op_or_assign
id|MSG_TRUNC
suffix:semicolon
id|err
op_assign
id|skb_copy_datagram_iovec
c_func
(paren
id|skb
comma
l_int|0
comma
id|msg-&gt;msg_iov
comma
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|out_free
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|siocb-&gt;scm
)paren
(brace
id|siocb-&gt;scm
op_assign
op_amp
id|tmp_scm
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|tmp_scm
comma
l_int|0
comma
r_sizeof
(paren
id|tmp_scm
)paren
)paren
suffix:semicolon
)brace
id|siocb-&gt;scm-&gt;creds
op_assign
op_star
id|UNIXCREDS
c_func
(paren
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|flags
op_amp
id|MSG_PEEK
)paren
)paren
(brace
r_if
c_cond
(paren
id|UNIXCB
c_func
(paren
id|skb
)paren
dot
id|fp
)paren
id|unix_detach_fds
c_func
(paren
id|siocb-&gt;scm
comma
id|skb
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* It is questionable: on PEEK we could:&n;&t;&t;   - do not return fds - good, but too simple 8)&n;&t;&t;   - return fds, and do not return them on read (old strategy,&n;&t;&t;     apparently wrong)&n;&t;&t;   - clone fds (I chose it for now, it is the most universal&n;&t;&t;     solution)&n;&t;&t;&n;&t;           POSIX 1003.1g does not actually define this clearly&n;&t;           at all. POSIX 1003.1g doesn&squot;t define a lot of things&n;&t;           clearly however!&t;&t;     &n;&t;&t;   &n;&t;&t;*/
r_if
c_cond
(paren
id|UNIXCB
c_func
(paren
id|skb
)paren
dot
id|fp
)paren
id|siocb-&gt;scm-&gt;fp
op_assign
id|scm_fp_dup
c_func
(paren
id|UNIXCB
c_func
(paren
id|skb
)paren
dot
id|fp
)paren
suffix:semicolon
)brace
id|err
op_assign
id|size
suffix:semicolon
id|scm_recv
c_func
(paren
id|sock
comma
id|msg
comma
id|siocb-&gt;scm
comma
id|flags
)paren
suffix:semicolon
id|out_free
suffix:colon
id|skb_free_datagram
c_func
(paren
id|sk
comma
id|skb
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*&n; *&t;Sleep until data has arrive. But check for races..&n; */
DECL|function|unix_stream_data_wait
r_static
r_int
id|unix_stream_data_wait
c_func
(paren
id|unix_socket
op_star
id|sk
comma
r_int
id|timeo
)paren
(brace
id|DEFINE_WAIT
c_func
(paren
id|wait
)paren
suffix:semicolon
id|unix_state_rlock
c_func
(paren
id|sk
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|prepare_to_wait
c_func
(paren
id|sk-&gt;sk_sleep
comma
op_amp
id|wait
comma
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb_queue_len
c_func
(paren
op_amp
id|sk-&gt;sk_receive_queue
)paren
op_logical_or
id|sk-&gt;sk_err
op_logical_or
(paren
id|sk-&gt;sk_shutdown
op_amp
id|RCV_SHUTDOWN
)paren
op_logical_or
id|signal_pending
c_func
(paren
id|current
)paren
op_logical_or
op_logical_neg
id|timeo
)paren
r_break
suffix:semicolon
id|set_bit
c_func
(paren
id|SOCK_ASYNC_WAITDATA
comma
op_amp
id|sk-&gt;sk_socket-&gt;flags
)paren
suffix:semicolon
id|unix_state_runlock
c_func
(paren
id|sk
)paren
suffix:semicolon
id|timeo
op_assign
id|schedule_timeout
c_func
(paren
id|timeo
)paren
suffix:semicolon
id|unix_state_rlock
c_func
(paren
id|sk
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|SOCK_ASYNC_WAITDATA
comma
op_amp
id|sk-&gt;sk_socket-&gt;flags
)paren
suffix:semicolon
)brace
id|finish_wait
c_func
(paren
id|sk-&gt;sk_sleep
comma
op_amp
id|wait
)paren
suffix:semicolon
id|unix_state_runlock
c_func
(paren
id|sk
)paren
suffix:semicolon
r_return
id|timeo
suffix:semicolon
)brace
DECL|function|unix_stream_recvmsg
r_static
r_int
id|unix_stream_recvmsg
c_func
(paren
r_struct
id|kiocb
op_star
id|iocb
comma
r_struct
id|socket
op_star
id|sock
comma
r_struct
id|msghdr
op_star
id|msg
comma
r_int
id|size
comma
r_int
id|flags
)paren
(brace
r_struct
id|sock_iocb
op_star
id|siocb
op_assign
id|kiocb_to_siocb
c_func
(paren
id|iocb
)paren
suffix:semicolon
r_struct
id|scm_cookie
id|tmp_scm
suffix:semicolon
r_struct
id|sock
op_star
id|sk
op_assign
id|sock-&gt;sk
suffix:semicolon
r_struct
id|unix_sock
op_star
id|u
op_assign
id|unix_sk
c_func
(paren
id|sk
)paren
suffix:semicolon
r_struct
id|sockaddr_un
op_star
id|sunaddr
op_assign
id|msg-&gt;msg_name
suffix:semicolon
r_int
id|copied
op_assign
l_int|0
suffix:semicolon
r_int
id|check_creds
op_assign
l_int|0
suffix:semicolon
r_int
id|target
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
r_int
id|timeo
suffix:semicolon
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;sk_state
op_ne
id|TCP_ESTABLISHED
)paren
r_goto
id|out
suffix:semicolon
id|err
op_assign
op_minus
id|EOPNOTSUPP
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
id|MSG_OOB
)paren
r_goto
id|out
suffix:semicolon
id|target
op_assign
id|sock_rcvlowat
c_func
(paren
id|sk
comma
id|flags
op_amp
id|MSG_WAITALL
comma
id|size
)paren
suffix:semicolon
id|timeo
op_assign
id|sock_rcvtimeo
c_func
(paren
id|sk
comma
id|flags
op_amp
id|MSG_DONTWAIT
)paren
suffix:semicolon
id|msg-&gt;msg_namelen
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Lock the socket to prevent queue disordering&n;&t; * while sleeps in memcpy_tomsg&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|siocb-&gt;scm
)paren
(brace
id|siocb-&gt;scm
op_assign
op_amp
id|tmp_scm
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|tmp_scm
comma
l_int|0
comma
r_sizeof
(paren
id|tmp_scm
)paren
)paren
suffix:semicolon
)brace
id|down
c_func
(paren
op_amp
id|u-&gt;readsem
)paren
suffix:semicolon
r_do
(brace
r_int
id|chunk
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
id|skb
op_assign
id|skb_dequeue
c_func
(paren
op_amp
id|sk-&gt;sk_receive_queue
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
op_eq
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|copied
op_ge
id|target
)paren
r_break
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; *&t;POSIX 1003.1g mandates this order.&n;&t;&t;&t; */
r_if
c_cond
(paren
(paren
id|err
op_assign
id|sock_error
c_func
(paren
id|sk
)paren
)paren
op_ne
l_int|0
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;sk_shutdown
op_amp
id|RCV_SHUTDOWN
)paren
r_break
suffix:semicolon
id|err
op_assign
op_minus
id|EAGAIN
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|timeo
)paren
r_break
suffix:semicolon
id|up
c_func
(paren
op_amp
id|u-&gt;readsem
)paren
suffix:semicolon
id|timeo
op_assign
id|unix_stream_data_wait
c_func
(paren
id|sk
comma
id|timeo
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
id|err
op_assign
id|sock_intr_errno
c_func
(paren
id|timeo
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|down
c_func
(paren
op_amp
id|u-&gt;readsem
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|check_creds
)paren
(brace
multiline_comment|/* Never glue messages from different writers */
r_if
c_cond
(paren
id|memcmp
c_func
(paren
id|UNIXCREDS
c_func
(paren
id|skb
)paren
comma
op_amp
id|siocb-&gt;scm-&gt;creds
comma
r_sizeof
(paren
id|siocb-&gt;scm-&gt;creds
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|skb_queue_head
c_func
(paren
op_amp
id|sk-&gt;sk_receive_queue
comma
id|skb
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* Copy credentials */
id|siocb-&gt;scm-&gt;creds
op_assign
op_star
id|UNIXCREDS
c_func
(paren
id|skb
)paren
suffix:semicolon
id|check_creds
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* Copy address just once */
r_if
c_cond
(paren
id|sunaddr
)paren
(brace
id|unix_copy_addr
c_func
(paren
id|msg
comma
id|skb-&gt;sk
)paren
suffix:semicolon
id|sunaddr
op_assign
l_int|NULL
suffix:semicolon
)brace
id|chunk
op_assign
id|min_t
c_func
(paren
r_int
r_int
comma
id|skb-&gt;len
comma
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|memcpy_toiovec
c_func
(paren
id|msg-&gt;msg_iov
comma
id|skb-&gt;data
comma
id|chunk
)paren
)paren
(brace
id|skb_queue_head
c_func
(paren
op_amp
id|sk-&gt;sk_receive_queue
comma
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copied
op_eq
l_int|0
)paren
id|copied
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_break
suffix:semicolon
)brace
id|copied
op_add_assign
id|chunk
suffix:semicolon
id|size
op_sub_assign
id|chunk
suffix:semicolon
multiline_comment|/* Mark read part of skb as used */
r_if
c_cond
(paren
op_logical_neg
(paren
id|flags
op_amp
id|MSG_PEEK
)paren
)paren
(brace
id|skb_pull
c_func
(paren
id|skb
comma
id|chunk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|UNIXCB
c_func
(paren
id|skb
)paren
dot
id|fp
)paren
id|unix_detach_fds
c_func
(paren
id|siocb-&gt;scm
comma
id|skb
)paren
suffix:semicolon
multiline_comment|/* put the skb back if we didn&squot;t use it up.. */
r_if
c_cond
(paren
id|skb-&gt;len
)paren
(brace
id|skb_queue_head
c_func
(paren
op_amp
id|sk-&gt;sk_receive_queue
comma
id|skb
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|siocb-&gt;scm-&gt;fp
)paren
r_break
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* It is questionable, see note in unix_dgram_recvmsg.&n;&t;&t;&t; */
r_if
c_cond
(paren
id|UNIXCB
c_func
(paren
id|skb
)paren
dot
id|fp
)paren
id|siocb-&gt;scm-&gt;fp
op_assign
id|scm_fp_dup
c_func
(paren
id|UNIXCB
c_func
(paren
id|skb
)paren
dot
id|fp
)paren
suffix:semicolon
multiline_comment|/* put message back and return */
id|skb_queue_head
c_func
(paren
op_amp
id|sk-&gt;sk_receive_queue
comma
id|skb
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|size
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|u-&gt;readsem
)paren
suffix:semicolon
id|scm_recv
c_func
(paren
id|sock
comma
id|msg
comma
id|siocb-&gt;scm
comma
id|flags
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|copied
ques
c_cond
suffix:colon
id|err
suffix:semicolon
)brace
DECL|function|unix_shutdown
r_static
r_int
id|unix_shutdown
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_int
id|mode
)paren
(brace
r_struct
id|sock
op_star
id|sk
op_assign
id|sock-&gt;sk
suffix:semicolon
id|unix_socket
op_star
id|other
suffix:semicolon
id|mode
op_assign
(paren
id|mode
op_plus
l_int|1
)paren
op_amp
(paren
id|RCV_SHUTDOWN
op_or
id|SEND_SHUTDOWN
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mode
)paren
(brace
id|unix_state_wlock
c_func
(paren
id|sk
)paren
suffix:semicolon
id|sk-&gt;sk_shutdown
op_or_assign
id|mode
suffix:semicolon
id|other
op_assign
id|unix_peer
c_func
(paren
id|sk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|other
)paren
id|sock_hold
c_func
(paren
id|other
)paren
suffix:semicolon
id|unix_state_wunlock
c_func
(paren
id|sk
)paren
suffix:semicolon
id|sk
op_member_access_from_pointer
id|sk_state_change
c_func
(paren
id|sk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|other
op_logical_and
id|sk-&gt;sk_type
op_eq
id|SOCK_STREAM
)paren
(brace
r_int
id|peer_mode
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|mode
op_amp
id|RCV_SHUTDOWN
)paren
id|peer_mode
op_or_assign
id|SEND_SHUTDOWN
suffix:semicolon
r_if
c_cond
(paren
id|mode
op_amp
id|SEND_SHUTDOWN
)paren
id|peer_mode
op_or_assign
id|RCV_SHUTDOWN
suffix:semicolon
id|unix_state_wlock
c_func
(paren
id|other
)paren
suffix:semicolon
id|other-&gt;sk_shutdown
op_or_assign
id|peer_mode
suffix:semicolon
id|unix_state_wunlock
c_func
(paren
id|other
)paren
suffix:semicolon
id|other
op_member_access_from_pointer
id|sk_state_change
c_func
(paren
id|other
)paren
suffix:semicolon
id|read_lock
c_func
(paren
op_amp
id|other-&gt;sk_callback_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|peer_mode
op_eq
id|SHUTDOWN_MASK
)paren
id|sk_wake_async
c_func
(paren
id|other
comma
l_int|1
comma
id|POLL_HUP
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|peer_mode
op_amp
id|RCV_SHUTDOWN
)paren
id|sk_wake_async
c_func
(paren
id|other
comma
l_int|1
comma
id|POLL_IN
)paren
suffix:semicolon
id|read_unlock
c_func
(paren
op_amp
id|other-&gt;sk_callback_lock
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|other
)paren
id|sock_put
c_func
(paren
id|other
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|unix_ioctl
r_static
r_int
id|unix_ioctl
c_func
(paren
r_struct
id|socket
op_star
id|sock
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_struct
id|sock
op_star
id|sk
op_assign
id|sock-&gt;sk
suffix:semicolon
r_int
id|amount
op_assign
l_int|0
suffix:semicolon
r_int
id|err
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|SIOCOUTQ
suffix:colon
id|amount
op_assign
id|atomic_read
c_func
(paren
op_amp
id|sk-&gt;sk_wmem_alloc
)paren
suffix:semicolon
id|err
op_assign
id|put_user
c_func
(paren
id|amount
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SIOCINQ
suffix:colon
(brace
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;sk_state
op_eq
id|TCP_LISTEN
)paren
(brace
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_break
suffix:semicolon
)brace
id|spin_lock
c_func
(paren
op_amp
id|sk-&gt;sk_receive_queue.lock
)paren
suffix:semicolon
id|skb
op_assign
id|skb_peek
c_func
(paren
op_amp
id|sk-&gt;sk_receive_queue
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb
)paren
id|amount
op_assign
id|skb-&gt;len
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|sk-&gt;sk_receive_queue.lock
)paren
suffix:semicolon
id|err
op_assign
id|put_user
c_func
(paren
id|amount
comma
(paren
r_int
op_star
)paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_default
suffix:colon
id|err
op_assign
id|dev_ioctl
c_func
(paren
id|cmd
comma
(paren
r_void
op_star
)paren
id|arg
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|err
suffix:semicolon
)brace
DECL|function|unix_poll
r_static
r_int
r_int
id|unix_poll
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_struct
id|socket
op_star
id|sock
comma
id|poll_table
op_star
id|wait
)paren
(brace
r_struct
id|sock
op_star
id|sk
op_assign
id|sock-&gt;sk
suffix:semicolon
r_int
r_int
id|mask
suffix:semicolon
id|poll_wait
c_func
(paren
id|file
comma
id|sk-&gt;sk_sleep
comma
id|wait
)paren
suffix:semicolon
id|mask
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* exceptional events? */
r_if
c_cond
(paren
id|sk-&gt;sk_err
)paren
id|mask
op_or_assign
id|POLLERR
suffix:semicolon
r_if
c_cond
(paren
id|sk-&gt;sk_shutdown
op_eq
id|SHUTDOWN_MASK
)paren
id|mask
op_or_assign
id|POLLHUP
suffix:semicolon
multiline_comment|/* readable? */
r_if
c_cond
(paren
op_logical_neg
id|skb_queue_empty
c_func
(paren
op_amp
id|sk-&gt;sk_receive_queue
)paren
op_logical_or
(paren
id|sk-&gt;sk_shutdown
op_amp
id|RCV_SHUTDOWN
)paren
)paren
id|mask
op_or_assign
id|POLLIN
op_or
id|POLLRDNORM
suffix:semicolon
multiline_comment|/* Connection-based need to check for termination and startup */
r_if
c_cond
(paren
id|sk-&gt;sk_type
op_eq
id|SOCK_STREAM
op_logical_and
id|sk-&gt;sk_state
op_eq
id|TCP_CLOSE
)paren
id|mask
op_or_assign
id|POLLHUP
suffix:semicolon
multiline_comment|/*&n;&t; * we set writable also when the other side has shut down the&n;&t; * connection. This prevents stuck sockets.&n;&t; */
r_if
c_cond
(paren
id|unix_writable
c_func
(paren
id|sk
)paren
)paren
id|mask
op_or_assign
id|POLLOUT
op_or
id|POLLWRNORM
op_or
id|POLLWRBAND
suffix:semicolon
r_return
id|mask
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_PROC_FS
DECL|function|unix_read_proc
r_static
r_int
id|unix_read_proc
c_func
(paren
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|length
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
id|off_t
id|pos
op_assign
l_int|0
suffix:semicolon
id|off_t
id|begin
op_assign
l_int|0
suffix:semicolon
r_int
id|len
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
id|unix_socket
op_star
id|s
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
comma
l_string|&quot;Num       RefCount Protocol Flags    Type St &quot;
l_string|&quot;Inode Path&bslash;n&quot;
)paren
suffix:semicolon
id|read_lock
c_func
(paren
op_amp
id|unix_table_lock
)paren
suffix:semicolon
id|forall_unix_sockets
(paren
id|i
comma
id|s
)paren
(brace
r_struct
id|unix_sock
op_star
id|u
op_assign
id|unix_sk
c_func
(paren
id|s
)paren
suffix:semicolon
id|unix_state_rlock
c_func
(paren
id|s
)paren
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
op_plus
id|len
comma
l_string|&quot;%p: %08X %08X %08X %04X %02X %5lu&quot;
comma
id|s
comma
id|atomic_read
c_func
(paren
op_amp
id|s-&gt;sk_refcnt
)paren
comma
l_int|0
comma
id|s-&gt;sk_state
op_eq
id|TCP_LISTEN
ques
c_cond
id|__SO_ACCEPTCON
suffix:colon
l_int|0
comma
id|s-&gt;sk_type
comma
id|s-&gt;sk_socket
ques
c_cond
(paren
id|s-&gt;sk_state
op_eq
id|TCP_ESTABLISHED
ques
c_cond
id|SS_CONNECTED
suffix:colon
id|SS_UNCONNECTED
)paren
suffix:colon
(paren
id|s-&gt;sk_state
op_eq
id|TCP_ESTABLISHED
ques
c_cond
id|SS_CONNECTING
suffix:colon
id|SS_DISCONNECTING
)paren
comma
id|sock_i_ino
c_func
(paren
id|s
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|u-&gt;addr
)paren
(brace
id|buffer
(braket
id|len
op_increment
)braket
op_assign
l_char|&squot; &squot;
suffix:semicolon
id|memcpy
c_func
(paren
id|buffer
op_plus
id|len
comma
id|u-&gt;addr-&gt;name-&gt;sun_path
comma
id|u-&gt;addr-&gt;len
op_minus
r_sizeof
(paren
r_int
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|UNIX_ABSTRACT
c_func
(paren
id|s
)paren
)paren
id|len
op_decrement
suffix:semicolon
r_else
id|buffer
(braket
id|len
)braket
op_assign
l_char|&squot;@&squot;
suffix:semicolon
id|len
op_add_assign
id|u-&gt;addr-&gt;len
op_minus
r_sizeof
(paren
r_int
)paren
suffix:semicolon
)brace
id|unix_state_runlock
c_func
(paren
id|s
)paren
suffix:semicolon
id|buffer
(braket
id|len
op_increment
)braket
op_assign
l_char|&squot;&bslash;n&squot;
suffix:semicolon
id|pos
op_assign
id|begin
op_plus
id|len
suffix:semicolon
r_if
c_cond
(paren
id|pos
OL
id|offset
)paren
(brace
id|len
op_assign
l_int|0
suffix:semicolon
id|begin
op_assign
id|pos
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pos
OG
id|offset
op_plus
id|length
)paren
(brace
r_goto
id|done
suffix:semicolon
)brace
)brace
op_star
id|eof
op_assign
l_int|1
suffix:semicolon
id|done
suffix:colon
id|read_unlock
c_func
(paren
op_amp
id|unix_table_lock
)paren
suffix:semicolon
op_star
id|start
op_assign
id|buffer
op_plus
(paren
id|offset
op_minus
id|begin
)paren
suffix:semicolon
id|len
op_sub_assign
(paren
id|offset
op_minus
id|begin
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|length
)paren
(brace
id|len
op_assign
id|length
suffix:semicolon
)brace
r_if
c_cond
(paren
id|len
OL
l_int|0
)paren
id|len
op_assign
l_int|0
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
macro_line|#endif
DECL|variable|unix_stream_ops
r_struct
id|proto_ops
id|unix_stream_ops
op_assign
(brace
dot
id|family
op_assign
id|PF_UNIX
comma
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|release
op_assign
id|unix_release
comma
dot
id|bind
op_assign
id|unix_bind
comma
dot
id|connect
op_assign
id|unix_stream_connect
comma
dot
id|socketpair
op_assign
id|unix_socketpair
comma
dot
id|accept
op_assign
id|unix_accept
comma
dot
id|getname
op_assign
id|unix_getname
comma
dot
id|poll
op_assign
id|unix_poll
comma
dot
id|ioctl
op_assign
id|unix_ioctl
comma
dot
id|listen
op_assign
id|unix_listen
comma
dot
id|shutdown
op_assign
id|unix_shutdown
comma
dot
id|setsockopt
op_assign
id|sock_no_setsockopt
comma
dot
id|getsockopt
op_assign
id|sock_no_getsockopt
comma
dot
id|sendmsg
op_assign
id|unix_stream_sendmsg
comma
dot
id|recvmsg
op_assign
id|unix_stream_recvmsg
comma
dot
id|mmap
op_assign
id|sock_no_mmap
comma
dot
id|sendpage
op_assign
id|sock_no_sendpage
comma
)brace
suffix:semicolon
DECL|variable|unix_dgram_ops
r_struct
id|proto_ops
id|unix_dgram_ops
op_assign
(brace
dot
id|family
op_assign
id|PF_UNIX
comma
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|release
op_assign
id|unix_release
comma
dot
id|bind
op_assign
id|unix_bind
comma
dot
id|connect
op_assign
id|unix_dgram_connect
comma
dot
id|socketpair
op_assign
id|unix_socketpair
comma
dot
id|accept
op_assign
id|sock_no_accept
comma
dot
id|getname
op_assign
id|unix_getname
comma
dot
id|poll
op_assign
id|datagram_poll
comma
dot
id|ioctl
op_assign
id|unix_ioctl
comma
dot
id|listen
op_assign
id|sock_no_listen
comma
dot
id|shutdown
op_assign
id|unix_shutdown
comma
dot
id|setsockopt
op_assign
id|sock_no_setsockopt
comma
dot
id|getsockopt
op_assign
id|sock_no_getsockopt
comma
dot
id|sendmsg
op_assign
id|unix_dgram_sendmsg
comma
dot
id|recvmsg
op_assign
id|unix_dgram_recvmsg
comma
dot
id|mmap
op_assign
id|sock_no_mmap
comma
dot
id|sendpage
op_assign
id|sock_no_sendpage
comma
)brace
suffix:semicolon
DECL|variable|unix_family_ops
r_struct
id|net_proto_family
id|unix_family_ops
op_assign
(brace
dot
id|family
op_assign
id|PF_UNIX
comma
dot
id|create
op_assign
id|unix_create
comma
dot
id|owner
op_assign
id|THIS_MODULE
comma
)brace
suffix:semicolon
macro_line|#ifdef CONFIG_SYSCTL
r_extern
r_void
id|unix_sysctl_register
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_void
id|unix_sysctl_unregister
c_func
(paren
r_void
)paren
suffix:semicolon
macro_line|#else
DECL|function|unix_sysctl_register
r_static
r_inline
r_void
id|unix_sysctl_register
c_func
(paren
r_void
)paren
(brace
)brace
DECL|function|unix_sysctl_unregister
r_static
r_inline
r_void
id|unix_sysctl_unregister
c_func
(paren
r_void
)paren
(brace
)brace
macro_line|#endif
DECL|variable|__initdata
r_static
r_char
id|banner
(braket
)braket
id|__initdata
op_assign
id|KERN_INFO
l_string|&quot;NET4: Unix domain sockets 1.0/SMP for Linux NET4.0.&bslash;n&quot;
suffix:semicolon
DECL|function|af_unix_init
r_static
r_int
id|__init
id|af_unix_init
c_func
(paren
r_void
)paren
(brace
r_struct
id|sk_buff
op_star
id|dummy_skb
suffix:semicolon
id|printk
c_func
(paren
id|banner
)paren
suffix:semicolon
r_if
c_cond
(paren
r_sizeof
(paren
r_struct
id|unix_skb_parms
)paren
OG
r_sizeof
(paren
id|dummy_skb-&gt;cb
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;%s: panic&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* allocate our sock slab cache */
id|unix_sk_cachep
op_assign
id|kmem_cache_create
c_func
(paren
l_string|&quot;unix_sock&quot;
comma
r_sizeof
(paren
r_struct
id|unix_sock
)paren
comma
l_int|0
comma
id|SLAB_HWCACHE_ALIGN
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|unix_sk_cachep
)paren
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;af_unix_init: Cannot create unix_sock SLAB cache!&bslash;n&quot;
)paren
suffix:semicolon
id|sock_register
c_func
(paren
op_amp
id|unix_family_ops
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_PROC_FS
id|create_proc_read_entry
c_func
(paren
l_string|&quot;net/unix&quot;
comma
l_int|0
comma
l_int|0
comma
id|unix_read_proc
comma
l_int|NULL
)paren
suffix:semicolon
macro_line|#endif
id|unix_sysctl_register
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|af_unix_exit
r_static
r_void
id|__exit
id|af_unix_exit
c_func
(paren
r_void
)paren
(brace
id|sock_unregister
c_func
(paren
id|PF_UNIX
)paren
suffix:semicolon
id|unix_sysctl_unregister
c_func
(paren
)paren
suffix:semicolon
id|remove_proc_entry
c_func
(paren
l_string|&quot;net/unix&quot;
comma
l_int|0
)paren
suffix:semicolon
id|kmem_cache_destroy
c_func
(paren
id|unix_sk_cachep
)paren
suffix:semicolon
)brace
DECL|variable|af_unix_init
id|module_init
c_func
(paren
id|af_unix_init
)paren
suffix:semicolon
DECL|variable|af_unix_exit
id|module_exit
c_func
(paren
id|af_unix_exit
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
eof
