multiline_comment|/*&n; *  ebt_limit&n; *&n; *&t;Authors:&n; *&t;Tom Marshall &lt;tommy@home.tig-grr.com&gt;&n; *&n; *&t;Mostly copied from netfilter&squot;s ipt_limit.c, see that file for&n; *&t;more explanation&n; *&n; *  September, 2003&n; *&n; */
macro_line|#include &lt;linux/netfilter_bridge/ebtables.h&gt;
macro_line|#include &lt;linux/netfilter_bridge/ebt_limit.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/spinlock.h&gt;
r_static
id|DEFINE_SPINLOCK
c_func
(paren
id|limit_lock
)paren
suffix:semicolon
DECL|macro|MAX_CPJ
mdefine_line|#define MAX_CPJ (0xFFFFFFFF / (HZ*60*60*24))
DECL|macro|_POW2_BELOW2
mdefine_line|#define _POW2_BELOW2(x) ((x)|((x)&gt;&gt;1))
DECL|macro|_POW2_BELOW4
mdefine_line|#define _POW2_BELOW4(x) (_POW2_BELOW2(x)|_POW2_BELOW2((x)&gt;&gt;2))
DECL|macro|_POW2_BELOW8
mdefine_line|#define _POW2_BELOW8(x) (_POW2_BELOW4(x)|_POW2_BELOW4((x)&gt;&gt;4))
DECL|macro|_POW2_BELOW16
mdefine_line|#define _POW2_BELOW16(x) (_POW2_BELOW8(x)|_POW2_BELOW8((x)&gt;&gt;8))
DECL|macro|_POW2_BELOW32
mdefine_line|#define _POW2_BELOW32(x) (_POW2_BELOW16(x)|_POW2_BELOW16((x)&gt;&gt;16))
DECL|macro|POW2_BELOW32
mdefine_line|#define POW2_BELOW32(x) ((_POW2_BELOW32(x)&gt;&gt;1) + 1)
DECL|macro|CREDITS_PER_JIFFY
mdefine_line|#define CREDITS_PER_JIFFY POW2_BELOW32(MAX_CPJ)
DECL|function|ebt_limit_match
r_static
r_int
id|ebt_limit_match
c_func
(paren
r_const
r_struct
id|sk_buff
op_star
id|skb
comma
r_const
r_struct
id|net_device
op_star
id|in
comma
r_const
r_struct
id|net_device
op_star
id|out
comma
r_const
r_void
op_star
id|data
comma
r_int
r_int
id|datalen
)paren
(brace
r_struct
id|ebt_limit_info
op_star
id|info
op_assign
(paren
r_struct
id|ebt_limit_info
op_star
)paren
id|data
suffix:semicolon
r_int
r_int
id|now
op_assign
id|jiffies
suffix:semicolon
id|spin_lock_bh
c_func
(paren
op_amp
id|limit_lock
)paren
suffix:semicolon
id|info-&gt;credit
op_add_assign
(paren
id|now
op_minus
id|xchg
c_func
(paren
op_amp
id|info-&gt;prev
comma
id|now
)paren
)paren
op_star
id|CREDITS_PER_JIFFY
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;credit
OG
id|info-&gt;credit_cap
)paren
id|info-&gt;credit
op_assign
id|info-&gt;credit_cap
suffix:semicolon
r_if
c_cond
(paren
id|info-&gt;credit
op_ge
id|info-&gt;cost
)paren
(brace
multiline_comment|/* We&squot;re not limited. */
id|info-&gt;credit
op_sub_assign
id|info-&gt;cost
suffix:semicolon
id|spin_unlock_bh
c_func
(paren
op_amp
id|limit_lock
)paren
suffix:semicolon
r_return
id|EBT_MATCH
suffix:semicolon
)brace
id|spin_unlock_bh
c_func
(paren
op_amp
id|limit_lock
)paren
suffix:semicolon
r_return
id|EBT_NOMATCH
suffix:semicolon
)brace
multiline_comment|/* Precision saver. */
r_static
id|u_int32_t
DECL|function|user2credits
id|user2credits
c_func
(paren
id|u_int32_t
id|user
)paren
(brace
multiline_comment|/* If multiplying would overflow... */
r_if
c_cond
(paren
id|user
OG
l_int|0xFFFFFFFF
op_div
(paren
id|HZ
op_star
id|CREDITS_PER_JIFFY
)paren
)paren
multiline_comment|/* Divide first. */
r_return
(paren
id|user
op_div
id|EBT_LIMIT_SCALE
)paren
op_star
id|HZ
op_star
id|CREDITS_PER_JIFFY
suffix:semicolon
r_return
(paren
id|user
op_star
id|HZ
op_star
id|CREDITS_PER_JIFFY
)paren
op_div
id|EBT_LIMIT_SCALE
suffix:semicolon
)brace
DECL|function|ebt_limit_check
r_static
r_int
id|ebt_limit_check
c_func
(paren
r_const
r_char
op_star
id|tablename
comma
r_int
r_int
id|hookmask
comma
r_const
r_struct
id|ebt_entry
op_star
id|e
comma
r_void
op_star
id|data
comma
r_int
r_int
id|datalen
)paren
(brace
r_struct
id|ebt_limit_info
op_star
id|info
op_assign
(paren
r_struct
id|ebt_limit_info
op_star
)paren
id|data
suffix:semicolon
r_if
c_cond
(paren
id|datalen
op_ne
id|EBT_ALIGN
c_func
(paren
r_sizeof
(paren
r_struct
id|ebt_limit_info
)paren
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* Check for overflow. */
r_if
c_cond
(paren
id|info-&gt;burst
op_eq
l_int|0
op_logical_or
id|user2credits
c_func
(paren
id|info-&gt;avg
op_star
id|info-&gt;burst
)paren
OL
id|user2credits
c_func
(paren
id|info-&gt;avg
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Overflow in ebt_limit, try lower: %u/%u&bslash;n&quot;
comma
id|info-&gt;avg
comma
id|info-&gt;burst
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* User avg in seconds * EBT_LIMIT_SCALE: convert to jiffies * 128. */
id|info-&gt;prev
op_assign
id|jiffies
suffix:semicolon
id|info-&gt;credit
op_assign
id|user2credits
c_func
(paren
id|info-&gt;avg
op_star
id|info-&gt;burst
)paren
suffix:semicolon
id|info-&gt;credit_cap
op_assign
id|user2credits
c_func
(paren
id|info-&gt;avg
op_star
id|info-&gt;burst
)paren
suffix:semicolon
id|info-&gt;cost
op_assign
id|user2credits
c_func
(paren
id|info-&gt;avg
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|ebt_limit_reg
r_static
r_struct
id|ebt_match
id|ebt_limit_reg
op_assign
(brace
dot
id|name
op_assign
id|EBT_LIMIT_MATCH
comma
dot
id|match
op_assign
id|ebt_limit_match
comma
dot
id|check
op_assign
id|ebt_limit_check
comma
dot
id|me
op_assign
id|THIS_MODULE
comma
)brace
suffix:semicolon
DECL|function|init
r_static
r_int
id|__init
id|init
c_func
(paren
r_void
)paren
(brace
r_return
id|ebt_register_match
c_func
(paren
op_amp
id|ebt_limit_reg
)paren
suffix:semicolon
)brace
DECL|function|fini
r_static
r_void
id|__exit
id|fini
c_func
(paren
r_void
)paren
(brace
id|ebt_unregister_match
c_func
(paren
op_amp
id|ebt_limit_reg
)paren
suffix:semicolon
)brace
DECL|variable|init
id|module_init
c_func
(paren
id|init
)paren
suffix:semicolon
DECL|variable|fini
id|module_exit
c_func
(paren
id|fini
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
eof
