multiline_comment|/*&n; *&t;Handle firewalling&n; *&t;Linux ethernet bridge&n; *&n; *&t;Authors:&n; *&t;Lennert Buytenhek               &lt;buytenh@gnu.org&gt;&n; *&t;Bart De Schuymer&t;&t;&lt;bdschuym@pandora.be&gt;&n; *&n; *&t;This program is free software; you can redistribute it and/or&n; *&t;modify it under the terms of the GNU General Public License&n; *&t;as published by the Free Software Foundation; either version&n; *&t;2 of the License, or (at your option) any later version.&n; *&n; *&t;Lennert dedicates this file to Kerstin Wurdinger.&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/ip.h&gt;
macro_line|#include &lt;linux/netdevice.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/if_ether.h&gt;
macro_line|#include &lt;linux/netfilter_bridge.h&gt;
macro_line|#include &lt;linux/netfilter_ipv4.h&gt;
macro_line|#include &lt;linux/netfilter_arp.h&gt;
macro_line|#include &lt;linux/in_route.h&gt;
macro_line|#include &lt;net/ip.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/checksum.h&gt;
macro_line|#include &quot;br_private.h&quot;
DECL|macro|skb_origaddr
mdefine_line|#define skb_origaddr(skb)&t; (((struct bridge_skb_cb *) &bslash;&n;&t;&t;&t;&t; (skb-&gt;cb))-&gt;daddr.ipv4)
DECL|macro|store_orig_dstaddr
mdefine_line|#define store_orig_dstaddr(skb)&t; (skb_origaddr(skb) = (skb)-&gt;nh.iph-&gt;daddr)
DECL|macro|dnat_took_place
mdefine_line|#define dnat_took_place(skb)&t; (skb_origaddr(skb) != (skb)-&gt;nh.iph-&gt;daddr)
DECL|macro|clear_cb
mdefine_line|#define clear_cb(skb)&t;&t; (memset(&amp;skb_origaddr(skb), 0, &bslash;&n;&t;&t;&t;&t; sizeof(struct bridge_skb_cb)))
DECL|macro|has_bridge_parent
mdefine_line|#define has_bridge_parent(device)&t;((device)-&gt;br_port != NULL)
DECL|macro|bridge_parent
mdefine_line|#define bridge_parent(device)&t;&t;((device)-&gt;br_port-&gt;br-&gt;dev)
multiline_comment|/* We need these fake structures to make netfilter happy --&n; * lots of places assume that skb-&gt;dst != NULL, which isn&squot;t&n; * all that unreasonable.&n; *&n; * Currently, we fill in the PMTU entry because netfilter&n; * refragmentation needs it, and the rt_flags entry because&n; * ipt_REJECT needs it.  Future netfilter modules might&n; * require us to fill additional fields.&n; */
DECL|variable|__fake_net_device
r_static
r_struct
id|net_device
id|__fake_net_device
op_assign
(brace
dot
id|hard_header_len
op_assign
id|ETH_HLEN
)brace
suffix:semicolon
DECL|variable|__fake_rtable
r_static
r_struct
id|rtable
id|__fake_rtable
op_assign
(brace
dot
id|u
op_assign
(brace
dot
id|dst
op_assign
(brace
dot
id|__refcnt
op_assign
id|ATOMIC_INIT
c_func
(paren
l_int|1
)paren
comma
dot
id|dev
op_assign
op_amp
id|__fake_net_device
comma
dot
id|path
op_assign
op_amp
id|__fake_rtable.u.dst
comma
dot
id|metrics
op_assign
(brace
(braket
id|RTAX_MTU
op_minus
l_int|1
)braket
op_assign
l_int|1500
)brace
comma
)brace
)brace
comma
dot
id|rt_flags
op_assign
l_int|0
)brace
suffix:semicolon
multiline_comment|/* PF_BRIDGE/PRE_ROUTING *********************************************/
DECL|function|__br_dnat_complain
r_static
r_void
id|__br_dnat_complain
c_func
(paren
r_void
)paren
(brace
r_static
r_int
r_int
id|last_complaint
suffix:semicolon
r_if
c_cond
(paren
id|jiffies
op_minus
id|last_complaint
op_ge
l_int|5
op_star
id|HZ
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Performing cross-bridge DNAT requires IP &quot;
l_string|&quot;forwarding to be enabled&bslash;n&quot;
)paren
suffix:semicolon
id|last_complaint
op_assign
id|jiffies
suffix:semicolon
)brace
)brace
multiline_comment|/* This requires some explaining. If DNAT has taken place,&n; * we will need to fix up the destination Ethernet address,&n; * and this is a tricky process.&n; *&n; * There are two cases to consider:&n; * 1. The packet was DNAT&squot;ed to a device in the same bridge&n; *    port group as it was received on. We can still bridge&n; *    the packet.&n; * 2. The packet was DNAT&squot;ed to a different device, either&n; *    a non-bridged device or another bridge port group.&n; *    The packet will need to be routed.&n; *&n; * The correct way of distinguishing between these two cases is to&n; * call ip_route_input() and to look at skb-&gt;dst-&gt;dev, which is&n; * changed to the destination device if ip_route_input() succeeds.&n; *&n; * Let us first consider the case that ip_route_input() succeeds:&n; *&n; * If skb-&gt;dst-&gt;dev equals the logical bridge device the packet&n; * came in on, we can consider this bridging. We then call&n; * skb-&gt;dst-&gt;output() which will make the packet enter br_nf_local_out()&n; * not much later. In that function it is assured that the iptables&n; * FORWARD chain is traversed for the packet.&n; *&n; * Otherwise, the packet is considered to be routed and we just&n; * change the destination MAC address so that the packet will&n; * later be passed up to the IP stack to be routed.&n; *&n; * Let us now consider the case that ip_route_input() fails:&n; *&n; * After a &quot;echo &squot;0&squot; &gt; /proc/sys/net/ipv4/ip_forward&quot; ip_route_input()&n; * will fail, while __ip_route_output_key() will return success. The source&n; * address for __ip_route_output_key() is set to zero, so __ip_route_output_key&n; * thinks we&squot;re handling a locally generated packet and won&squot;t care&n; * if IP forwarding is allowed. We send a warning message to the users&squot;s&n; * log telling her to put IP forwarding on.&n; *&n; * ip_route_input() will also fail if there is no route available.&n; * In that case we just drop the packet.&n; *&n; * --Lennert, 20020411&n; * --Bart, 20020416 (updated)&n; * --Bart, 20021007 (updated)&n; */
DECL|function|br_nf_pre_routing_finish_bridge
r_static
r_int
id|br_nf_pre_routing_finish_bridge
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
macro_line|#ifdef CONFIG_NETFILTER_DEBUG
id|skb-&gt;nf_debug
op_or_assign
(paren
l_int|1
op_lshift
id|NF_BR_PRE_ROUTING
)paren
op_or
(paren
l_int|1
op_lshift
id|NF_BR_FORWARD
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|skb-&gt;pkt_type
op_eq
id|PACKET_OTHERHOST
)paren
(brace
id|skb-&gt;pkt_type
op_assign
id|PACKET_HOST
suffix:semicolon
id|skb-&gt;nf_bridge-&gt;mask
op_or_assign
id|BRNF_PKT_TYPE
suffix:semicolon
)brace
id|skb-&gt;dev
op_assign
id|bridge_parent
c_func
(paren
id|skb-&gt;dev
)paren
suffix:semicolon
id|skb-&gt;dst
op_member_access_from_pointer
id|output
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|br_nf_pre_routing_finish
r_static
r_int
id|br_nf_pre_routing_finish
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|net_device
op_star
id|dev
op_assign
id|skb-&gt;dev
suffix:semicolon
r_struct
id|iphdr
op_star
id|iph
op_assign
id|skb-&gt;nh.iph
suffix:semicolon
r_struct
id|nf_bridge_info
op_star
id|nf_bridge
op_assign
id|skb-&gt;nf_bridge
suffix:semicolon
macro_line|#ifdef CONFIG_NETFILTER_DEBUG
id|skb-&gt;nf_debug
op_xor_assign
(paren
l_int|1
op_lshift
id|NF_BR_PRE_ROUTING
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|nf_bridge-&gt;mask
op_amp
id|BRNF_PKT_TYPE
)paren
(brace
id|skb-&gt;pkt_type
op_assign
id|PACKET_OTHERHOST
suffix:semicolon
id|nf_bridge-&gt;mask
op_xor_assign
id|BRNF_PKT_TYPE
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dnat_took_place
c_func
(paren
id|skb
)paren
)paren
(brace
r_if
c_cond
(paren
id|ip_route_input
c_func
(paren
id|skb
comma
id|iph-&gt;daddr
comma
id|iph-&gt;saddr
comma
id|iph-&gt;tos
comma
id|dev
)paren
)paren
(brace
r_struct
id|rtable
op_star
id|rt
suffix:semicolon
r_struct
id|flowi
id|fl
op_assign
(brace
dot
id|nl_u
op_assign
(brace
dot
id|ip4_u
op_assign
(brace
dot
id|daddr
op_assign
id|iph-&gt;daddr
comma
dot
id|saddr
op_assign
l_int|0
comma
dot
id|tos
op_assign
id|iph-&gt;tos
)brace
)brace
comma
dot
id|proto
op_assign
l_int|0
)brace
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ip_route_output_key
c_func
(paren
op_amp
id|rt
comma
op_amp
id|fl
)paren
)paren
(brace
multiline_comment|/* Bridged-and-DNAT&squot;ed traffic doesn&squot;t&n;&t;&t;&t;&t; * require ip_forwarding.&n;&t;&t;&t;&t; */
r_if
c_cond
(paren
(paren
(paren
r_struct
id|dst_entry
op_star
)paren
id|rt
)paren
op_member_access_from_pointer
id|dev
op_eq
id|dev
)paren
(brace
id|skb-&gt;dst
op_assign
(paren
r_struct
id|dst_entry
op_star
)paren
id|rt
suffix:semicolon
r_goto
id|bridged_dnat
suffix:semicolon
)brace
id|__br_dnat_complain
c_func
(paren
)paren
suffix:semicolon
id|dst_release
c_func
(paren
(paren
r_struct
id|dst_entry
op_star
)paren
id|rt
)paren
suffix:semicolon
)brace
id|kfree_skb
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|skb-&gt;dst-&gt;dev
op_eq
id|dev
)paren
(brace
id|bridged_dnat
suffix:colon
multiline_comment|/* Tell br_nf_local_out this is a&n;&t;&t;&t;&t; * bridged frame&n;&t;&t;&t;&t; */
id|nf_bridge-&gt;mask
op_or_assign
id|BRNF_BRIDGED_DNAT
suffix:semicolon
id|skb-&gt;dev
op_assign
id|nf_bridge-&gt;physindev
suffix:semicolon
id|clear_cb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|NF_HOOK_THRESH
c_func
(paren
id|PF_BRIDGE
comma
id|NF_BR_PRE_ROUTING
comma
id|skb
comma
id|skb-&gt;dev
comma
l_int|NULL
comma
id|br_nf_pre_routing_finish_bridge
comma
l_int|1
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|skb-&gt;mac.ethernet-&gt;h_dest
comma
id|dev-&gt;dev_addr
comma
id|ETH_ALEN
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|skb-&gt;dst
op_assign
(paren
r_struct
id|dst_entry
op_star
)paren
op_amp
id|__fake_rtable
suffix:semicolon
id|dst_hold
c_func
(paren
id|skb-&gt;dst
)paren
suffix:semicolon
)brace
id|clear_cb
c_func
(paren
id|skb
)paren
suffix:semicolon
id|skb-&gt;dev
op_assign
id|nf_bridge-&gt;physindev
suffix:semicolon
id|NF_HOOK_THRESH
c_func
(paren
id|PF_BRIDGE
comma
id|NF_BR_PRE_ROUTING
comma
id|skb
comma
id|skb-&gt;dev
comma
l_int|NULL
comma
id|br_handle_frame_finish
comma
l_int|1
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Replicate the checks that IPv4 does on packet reception.&n; * Set skb-&gt;dev to the bridge device (i.e. parent of the&n; * receiving device) to make netfilter happy, the REDIRECT&n; * target in particular.  Save the original destination IP&n; * address to be able to detect DNAT afterwards.&n; */
DECL|function|br_nf_pre_routing
r_static
r_int
r_int
id|br_nf_pre_routing
c_func
(paren
r_int
r_int
id|hook
comma
r_struct
id|sk_buff
op_star
op_star
id|pskb
comma
r_const
r_struct
id|net_device
op_star
id|in
comma
r_const
r_struct
id|net_device
op_star
id|out
comma
r_int
(paren
op_star
id|okfn
)paren
(paren
r_struct
id|sk_buff
op_star
)paren
)paren
(brace
r_struct
id|iphdr
op_star
id|iph
suffix:semicolon
id|__u32
id|len
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
suffix:semicolon
r_struct
id|nf_bridge_info
op_star
id|nf_bridge
suffix:semicolon
r_if
c_cond
(paren
(paren
op_star
id|pskb
)paren
op_member_access_from_pointer
id|protocol
op_ne
id|__constant_htons
c_func
(paren
id|ETH_P_IP
)paren
)paren
r_return
id|NF_ACCEPT
suffix:semicolon
r_if
c_cond
(paren
(paren
id|skb
op_assign
id|skb_share_check
c_func
(paren
op_star
id|pskb
comma
id|GFP_ATOMIC
)paren
)paren
op_eq
l_int|NULL
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pskb_may_pull
c_func
(paren
id|skb
comma
r_sizeof
(paren
r_struct
id|iphdr
)paren
)paren
)paren
r_goto
id|inhdr_error
suffix:semicolon
id|iph
op_assign
id|skb-&gt;nh.iph
suffix:semicolon
r_if
c_cond
(paren
id|iph-&gt;ihl
OL
l_int|5
op_logical_or
id|iph-&gt;version
op_ne
l_int|4
)paren
r_goto
id|inhdr_error
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pskb_may_pull
c_func
(paren
id|skb
comma
l_int|4
op_star
id|iph-&gt;ihl
)paren
)paren
r_goto
id|inhdr_error
suffix:semicolon
id|iph
op_assign
id|skb-&gt;nh.iph
suffix:semicolon
r_if
c_cond
(paren
id|ip_fast_csum
c_func
(paren
(paren
id|__u8
op_star
)paren
id|iph
comma
id|iph-&gt;ihl
)paren
op_ne
l_int|0
)paren
r_goto
id|inhdr_error
suffix:semicolon
id|len
op_assign
id|ntohs
c_func
(paren
id|iph-&gt;tot_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;len
OL
id|len
op_logical_or
id|len
OL
l_int|4
op_star
id|iph-&gt;ihl
)paren
r_goto
id|inhdr_error
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;len
OG
id|len
)paren
(brace
id|__pskb_trim
c_func
(paren
id|skb
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;ip_summed
op_eq
id|CHECKSUM_HW
)paren
id|skb-&gt;ip_summed
op_assign
id|CHECKSUM_NONE
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_NETFILTER_DEBUG
id|skb-&gt;nf_debug
op_xor_assign
(paren
l_int|1
op_lshift
id|NF_IP_PRE_ROUTING
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
(paren
id|nf_bridge
op_assign
id|nf_bridge_alloc
c_func
(paren
id|skb
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
id|NF_DROP
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;pkt_type
op_eq
id|PACKET_OTHERHOST
)paren
(brace
id|skb-&gt;pkt_type
op_assign
id|PACKET_HOST
suffix:semicolon
id|nf_bridge-&gt;mask
op_or_assign
id|BRNF_PKT_TYPE
suffix:semicolon
)brace
id|nf_bridge-&gt;physindev
op_assign
id|skb-&gt;dev
suffix:semicolon
id|skb-&gt;dev
op_assign
id|bridge_parent
c_func
(paren
id|skb-&gt;dev
)paren
suffix:semicolon
id|store_orig_dstaddr
c_func
(paren
id|skb
)paren
suffix:semicolon
id|NF_HOOK
c_func
(paren
id|PF_INET
comma
id|NF_IP_PRE_ROUTING
comma
id|skb
comma
id|skb-&gt;dev
comma
l_int|NULL
comma
id|br_nf_pre_routing_finish
)paren
suffix:semicolon
r_return
id|NF_STOLEN
suffix:semicolon
id|inhdr_error
suffix:colon
singleline_comment|//&t;IP_INC_STATS_BH(IpInHdrErrors);
id|out
suffix:colon
r_return
id|NF_DROP
suffix:semicolon
)brace
multiline_comment|/* PF_BRIDGE/LOCAL_IN ************************************************/
multiline_comment|/* The packet is locally destined, which requires a real&n; * dst_entry, so detach the fake one.  On the way up, the&n; * packet would pass through PRE_ROUTING again (which already&n; * took place when the packet entered the bridge), but we&n; * register an IPv4 PRE_ROUTING &squot;sabotage&squot; hook that will&n; * prevent this from happening.&n; */
DECL|function|br_nf_local_in
r_static
r_int
r_int
id|br_nf_local_in
c_func
(paren
r_int
r_int
id|hook
comma
r_struct
id|sk_buff
op_star
op_star
id|pskb
comma
r_const
r_struct
id|net_device
op_star
id|in
comma
r_const
r_struct
id|net_device
op_star
id|out
comma
r_int
(paren
op_star
id|okfn
)paren
(paren
r_struct
id|sk_buff
op_star
)paren
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
op_assign
op_star
id|pskb
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;protocol
op_ne
id|__constant_htons
c_func
(paren
id|ETH_P_IP
)paren
)paren
r_return
id|NF_ACCEPT
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;dst
op_eq
(paren
r_struct
id|dst_entry
op_star
)paren
op_amp
id|__fake_rtable
)paren
(brace
id|dst_release
c_func
(paren
id|skb-&gt;dst
)paren
suffix:semicolon
id|skb-&gt;dst
op_assign
l_int|NULL
suffix:semicolon
)brace
r_return
id|NF_ACCEPT
suffix:semicolon
)brace
multiline_comment|/* PF_BRIDGE/FORWARD *************************************************/
DECL|function|br_nf_forward_finish
r_static
r_int
id|br_nf_forward_finish
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
r_struct
id|nf_bridge_info
op_star
id|nf_bridge
op_assign
id|skb-&gt;nf_bridge
suffix:semicolon
r_struct
id|net_device
op_star
id|in
suffix:semicolon
macro_line|#ifdef CONFIG_NETFILTER_DEBUG
id|skb-&gt;nf_debug
op_xor_assign
(paren
l_int|1
op_lshift
id|NF_BR_FORWARD
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|skb-&gt;protocol
op_eq
id|__constant_htons
c_func
(paren
id|ETH_P_IP
)paren
)paren
(brace
id|in
op_assign
id|nf_bridge-&gt;physindev
suffix:semicolon
r_if
c_cond
(paren
id|nf_bridge-&gt;mask
op_amp
id|BRNF_PKT_TYPE
)paren
(brace
id|skb-&gt;pkt_type
op_assign
id|PACKET_OTHERHOST
suffix:semicolon
id|nf_bridge-&gt;mask
op_xor_assign
id|BRNF_PKT_TYPE
suffix:semicolon
)brace
)brace
r_else
(brace
id|in
op_assign
op_star
(paren
(paren
r_struct
id|net_device
op_star
op_star
)paren
(paren
id|skb-&gt;cb
)paren
)paren
suffix:semicolon
)brace
id|NF_HOOK_THRESH
c_func
(paren
id|PF_BRIDGE
comma
id|NF_BR_FORWARD
comma
id|skb
comma
id|in
comma
id|skb-&gt;dev
comma
id|br_forward_finish
comma
l_int|1
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* This is the &squot;purely bridged&squot; case.  For IP, we pass the packet to&n; * netfilter with indev and outdev set to the bridge device,&n; * but we are still able to filter on the &squot;real&squot; indev/outdev&n; * because of the ipt_physdev.c module. For ARP, indev and outdev are the&n; * bridge ports.&n; */
DECL|function|br_nf_forward
r_static
r_int
r_int
id|br_nf_forward
c_func
(paren
r_int
r_int
id|hook
comma
r_struct
id|sk_buff
op_star
op_star
id|pskb
comma
r_const
r_struct
id|net_device
op_star
id|in
comma
r_const
r_struct
id|net_device
op_star
id|out
comma
r_int
(paren
op_star
id|okfn
)paren
(paren
r_struct
id|sk_buff
op_star
)paren
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
op_assign
op_star
id|pskb
suffix:semicolon
r_struct
id|nf_bridge_info
op_star
id|nf_bridge
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;protocol
op_ne
id|__constant_htons
c_func
(paren
id|ETH_P_IP
)paren
op_logical_and
id|skb-&gt;protocol
op_ne
id|__constant_htons
c_func
(paren
id|ETH_P_ARP
)paren
)paren
r_return
id|NF_ACCEPT
suffix:semicolon
macro_line|#ifdef CONFIG_NETFILTER_DEBUG
id|skb-&gt;nf_debug
op_xor_assign
(paren
l_int|1
op_lshift
id|NF_BR_FORWARD
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|skb-&gt;protocol
op_eq
id|__constant_htons
c_func
(paren
id|ETH_P_IP
)paren
)paren
(brace
id|nf_bridge
op_assign
id|skb-&gt;nf_bridge
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;pkt_type
op_eq
id|PACKET_OTHERHOST
)paren
(brace
id|skb-&gt;pkt_type
op_assign
id|PACKET_HOST
suffix:semicolon
id|nf_bridge-&gt;mask
op_or_assign
id|BRNF_PKT_TYPE
suffix:semicolon
)brace
multiline_comment|/* The physdev module checks on this */
id|nf_bridge-&gt;mask
op_or_assign
id|BRNF_BRIDGED
suffix:semicolon
id|nf_bridge-&gt;physoutdev
op_assign
id|skb-&gt;dev
suffix:semicolon
id|NF_HOOK
c_func
(paren
id|PF_INET
comma
id|NF_IP_FORWARD
comma
id|skb
comma
id|bridge_parent
c_func
(paren
id|in
)paren
comma
id|bridge_parent
c_func
(paren
id|out
)paren
comma
id|br_nf_forward_finish
)paren
suffix:semicolon
)brace
r_else
(brace
r_struct
id|net_device
op_star
op_star
id|d
op_assign
(paren
r_struct
id|net_device
op_star
op_star
)paren
(paren
id|skb-&gt;cb
)paren
suffix:semicolon
op_star
id|d
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|in
suffix:semicolon
id|NF_HOOK
c_func
(paren
id|NF_ARP
comma
id|NF_ARP_FORWARD
comma
id|skb
comma
(paren
r_struct
id|net_device
op_star
)paren
id|in
comma
(paren
r_struct
id|net_device
op_star
)paren
id|out
comma
id|br_nf_forward_finish
)paren
suffix:semicolon
)brace
r_return
id|NF_STOLEN
suffix:semicolon
)brace
multiline_comment|/* PF_BRIDGE/LOCAL_OUT ***********************************************/
DECL|function|br_nf_local_out_finish
r_static
r_int
id|br_nf_local_out_finish
c_func
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
(brace
macro_line|#ifdef CONFIG_NETFILTER_DEBUG
id|skb-&gt;nf_debug
op_and_assign
op_complement
(paren
l_int|1
op_lshift
id|NF_BR_LOCAL_OUT
)paren
suffix:semicolon
macro_line|#endif
id|NF_HOOK_THRESH
c_func
(paren
id|PF_BRIDGE
comma
id|NF_BR_LOCAL_OUT
comma
id|skb
comma
l_int|NULL
comma
id|skb-&gt;dev
comma
id|br_forward_finish
comma
id|NF_BR_PRI_FIRST
op_plus
l_int|1
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* This function sees both locally originated IP packets and forwarded&n; * IP packets (in both cases the destination device is a bridge&n; * device). It also sees bridged-and-DNAT&squot;ed packets.&n; * To be able to filter on the physical bridge devices (with the ipt_physdev.c&n; * module), we steal packets destined to a bridge device away from the&n; * PF_INET/FORWARD and PF_INET/OUTPUT hook functions, and give them back later,&n; * when we have determined the real output device. This is done in here.&n; *&n; * If (nf_bridge-&gt;mask &amp; BRNF_BRIDGED_DNAT) then the packet is bridged&n; * and we fake the PF_BRIDGE/FORWARD hook. The function br_nf_forward()&n; * will then fake the PF_INET/FORWARD hook. br_nf_local_out() has priority&n; * NF_BR_PRI_FIRST, so no relevant PF_BRIDGE/INPUT functions have been nor&n; * will be executed.&n; * Otherwise, if nf_bridge-&gt;physindev is NULL, the bridge-nf code never touched&n; * this packet before, and so the packet was locally originated. We fake&n; * the PF_INET/LOCAL_OUT hook.&n; * Finally, if nf_bridge-&gt;physindev isn&squot;t NULL, then the packet was IP routed,&n; * so we fake the PF_INET/FORWARD hook. ipv4_sabotage_out() makes sure&n; * even routed packets that didn&squot;t arrive on a bridge interface have their&n; * nf_bridge-&gt;physindev set.&n; */
DECL|function|br_nf_local_out
r_static
r_int
r_int
id|br_nf_local_out
c_func
(paren
r_int
r_int
id|hook
comma
r_struct
id|sk_buff
op_star
op_star
id|pskb
comma
r_const
r_struct
id|net_device
op_star
id|in
comma
r_const
r_struct
id|net_device
op_star
id|out
comma
r_int
(paren
op_star
id|_okfn
)paren
(paren
r_struct
id|sk_buff
op_star
)paren
)paren
(brace
r_int
(paren
op_star
id|okfn
)paren
(paren
r_struct
id|sk_buff
op_star
id|skb
)paren
suffix:semicolon
r_struct
id|net_device
op_star
id|realindev
suffix:semicolon
r_struct
id|sk_buff
op_star
id|skb
op_assign
op_star
id|pskb
suffix:semicolon
r_struct
id|nf_bridge_info
op_star
id|nf_bridge
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;protocol
op_ne
id|__constant_htons
c_func
(paren
id|ETH_P_IP
)paren
)paren
r_return
id|NF_ACCEPT
suffix:semicolon
multiline_comment|/* Sometimes we get packets with NULL -&gt;dst here (for example,&n;&t; * running a dhcp client daemon triggers this).&n;&t; */
r_if
c_cond
(paren
id|skb-&gt;dst
op_eq
l_int|NULL
)paren
r_return
id|NF_ACCEPT
suffix:semicolon
id|nf_bridge
op_assign
id|skb-&gt;nf_bridge
suffix:semicolon
id|nf_bridge-&gt;physoutdev
op_assign
id|skb-&gt;dev
suffix:semicolon
id|realindev
op_assign
id|nf_bridge-&gt;physindev
suffix:semicolon
multiline_comment|/* Bridged, take PF_BRIDGE/FORWARD.&n;&t; * (see big note in front of br_nf_pre_routing_finish)&n;&t; */
r_if
c_cond
(paren
id|nf_bridge-&gt;mask
op_amp
id|BRNF_BRIDGED_DNAT
)paren
(brace
id|okfn
op_assign
id|br_forward_finish
suffix:semicolon
r_if
c_cond
(paren
id|nf_bridge-&gt;mask
op_amp
id|BRNF_PKT_TYPE
)paren
(brace
id|skb-&gt;pkt_type
op_assign
id|PACKET_OTHERHOST
suffix:semicolon
id|nf_bridge-&gt;mask
op_xor_assign
id|BRNF_PKT_TYPE
suffix:semicolon
)brace
id|NF_HOOK
c_func
(paren
id|PF_BRIDGE
comma
id|NF_BR_FORWARD
comma
id|skb
comma
id|realindev
comma
id|skb-&gt;dev
comma
id|okfn
)paren
suffix:semicolon
)brace
r_else
(brace
id|okfn
op_assign
id|br_nf_local_out_finish
suffix:semicolon
multiline_comment|/* IP forwarded traffic has a physindev, locally&n;&t;&t; * generated traffic hasn&squot;t.&n;&t;&t; */
r_if
c_cond
(paren
id|realindev
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
(paren
(paren
id|nf_bridge-&gt;mask
op_amp
id|BRNF_DONT_TAKE_PARENT
)paren
op_eq
l_int|0
)paren
op_logical_and
id|has_bridge_parent
c_func
(paren
id|realindev
)paren
)paren
id|realindev
op_assign
id|bridge_parent
c_func
(paren
id|realindev
)paren
suffix:semicolon
id|NF_HOOK_THRESH
c_func
(paren
id|PF_INET
comma
id|NF_IP_FORWARD
comma
id|skb
comma
id|realindev
comma
id|bridge_parent
c_func
(paren
id|skb-&gt;dev
)paren
comma
id|okfn
comma
id|NF_IP_PRI_BRIDGE_SABOTAGE_FORWARD
op_plus
l_int|1
)paren
suffix:semicolon
)brace
r_else
(brace
macro_line|#ifdef CONFIG_NETFILTER_DEBUG
id|skb-&gt;nf_debug
op_xor_assign
(paren
l_int|1
op_lshift
id|NF_IP_LOCAL_OUT
)paren
suffix:semicolon
macro_line|#endif
id|NF_HOOK_THRESH
c_func
(paren
id|PF_INET
comma
id|NF_IP_LOCAL_OUT
comma
id|skb
comma
id|realindev
comma
id|bridge_parent
c_func
(paren
id|skb-&gt;dev
)paren
comma
id|okfn
comma
id|NF_IP_PRI_BRIDGE_SABOTAGE_LOCAL_OUT
op_plus
l_int|1
)paren
suffix:semicolon
)brace
)brace
r_return
id|NF_STOLEN
suffix:semicolon
)brace
multiline_comment|/* PF_BRIDGE/POST_ROUTING ********************************************/
DECL|function|br_nf_post_routing
r_static
r_int
r_int
id|br_nf_post_routing
c_func
(paren
r_int
r_int
id|hook
comma
r_struct
id|sk_buff
op_star
op_star
id|pskb
comma
r_const
r_struct
id|net_device
op_star
id|in
comma
r_const
r_struct
id|net_device
op_star
id|out
comma
r_int
(paren
op_star
id|okfn
)paren
(paren
r_struct
id|sk_buff
op_star
)paren
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
op_assign
op_star
id|pskb
suffix:semicolon
r_struct
id|nf_bridge_info
op_star
id|nf_bridge
op_assign
(paren
op_star
id|pskb
)paren
op_member_access_from_pointer
id|nf_bridge
suffix:semicolon
multiline_comment|/* Be very paranoid. Must be a device driver bug. */
r_if
c_cond
(paren
id|skb-&gt;mac.raw
template_param
id|skb-&gt;data
)paren
(brace
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;br_netfilter: Argh!! br_nf_post_routing: &quot;
l_string|&quot;bad mac.raw pointer.&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|skb-&gt;dev
op_ne
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;[%s]&quot;
comma
id|skb-&gt;dev-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|has_bridge_parent
c_func
(paren
id|skb-&gt;dev
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;[%s]&quot;
comma
id|bridge_parent
c_func
(paren
id|skb-&gt;dev
)paren
op_member_access_from_pointer
id|name
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|NF_ACCEPT
suffix:semicolon
)brace
r_if
c_cond
(paren
id|skb-&gt;protocol
op_ne
id|__constant_htons
c_func
(paren
id|ETH_P_IP
)paren
)paren
r_return
id|NF_ACCEPT
suffix:semicolon
multiline_comment|/* Sometimes we get packets with NULL -&gt;dst here (for example,&n;&t; * running a dhcp client daemon triggers this).&n;&t; */
r_if
c_cond
(paren
id|skb-&gt;dst
op_eq
l_int|NULL
)paren
r_return
id|NF_ACCEPT
suffix:semicolon
macro_line|#ifdef CONFIG_NETFILTER_DEBUG
id|skb-&gt;nf_debug
op_xor_assign
(paren
l_int|1
op_lshift
id|NF_IP_POST_ROUTING
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* We assume any code from br_dev_queue_push_xmit onwards doesn&squot;t care&n;&t; * about the value of skb-&gt;pkt_type.&n;&t; */
r_if
c_cond
(paren
id|skb-&gt;pkt_type
op_eq
id|PACKET_OTHERHOST
)paren
(brace
id|skb-&gt;pkt_type
op_assign
id|PACKET_HOST
suffix:semicolon
id|nf_bridge-&gt;mask
op_or_assign
id|BRNF_PKT_TYPE
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|nf_bridge-&gt;hh
comma
id|skb-&gt;data
op_minus
l_int|16
comma
l_int|16
)paren
suffix:semicolon
id|NF_HOOK
c_func
(paren
id|PF_INET
comma
id|NF_IP_POST_ROUTING
comma
id|skb
comma
l_int|NULL
comma
id|bridge_parent
c_func
(paren
id|skb-&gt;dev
)paren
comma
id|br_dev_queue_push_xmit
)paren
suffix:semicolon
r_return
id|NF_STOLEN
suffix:semicolon
)brace
multiline_comment|/* IPv4/SABOTAGE *****************************************************/
multiline_comment|/* Don&squot;t hand locally destined packets to PF_INET/PRE_ROUTING&n; * for the second time.&n; */
DECL|function|ipv4_sabotage_in
r_static
r_int
r_int
id|ipv4_sabotage_in
c_func
(paren
r_int
r_int
id|hook
comma
r_struct
id|sk_buff
op_star
op_star
id|pskb
comma
r_const
r_struct
id|net_device
op_star
id|in
comma
r_const
r_struct
id|net_device
op_star
id|out
comma
r_int
(paren
op_star
id|okfn
)paren
(paren
r_struct
id|sk_buff
op_star
)paren
)paren
(brace
r_if
c_cond
(paren
id|in-&gt;hard_start_xmit
op_eq
id|br_dev_xmit
op_logical_and
id|okfn
op_ne
id|br_nf_pre_routing_finish
)paren
(brace
id|okfn
c_func
(paren
op_star
id|pskb
)paren
suffix:semicolon
r_return
id|NF_STOLEN
suffix:semicolon
)brace
r_return
id|NF_ACCEPT
suffix:semicolon
)brace
multiline_comment|/* Postpone execution of PF_INET/FORWARD, PF_INET/LOCAL_OUT&n; * and PF_INET/POST_ROUTING until we have done the forwarding&n; * decision in the bridge code and have determined skb-&gt;physoutdev.&n; */
DECL|function|ipv4_sabotage_out
r_static
r_int
r_int
id|ipv4_sabotage_out
c_func
(paren
r_int
r_int
id|hook
comma
r_struct
id|sk_buff
op_star
op_star
id|pskb
comma
r_const
r_struct
id|net_device
op_star
id|in
comma
r_const
r_struct
id|net_device
op_star
id|out
comma
r_int
(paren
op_star
id|okfn
)paren
(paren
r_struct
id|sk_buff
op_star
)paren
)paren
(brace
r_if
c_cond
(paren
id|out-&gt;hard_start_xmit
op_eq
id|br_dev_xmit
op_logical_and
id|okfn
op_ne
id|br_nf_forward_finish
op_logical_and
id|okfn
op_ne
id|br_nf_local_out_finish
op_logical_and
id|okfn
op_ne
id|br_dev_queue_push_xmit
)paren
(brace
r_struct
id|sk_buff
op_star
id|skb
op_assign
op_star
id|pskb
suffix:semicolon
r_struct
id|nf_bridge_info
op_star
id|nf_bridge
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|skb-&gt;nf_bridge
op_logical_and
op_logical_neg
id|nf_bridge_alloc
c_func
(paren
id|skb
)paren
)paren
r_return
id|NF_DROP
suffix:semicolon
id|nf_bridge
op_assign
id|skb-&gt;nf_bridge
suffix:semicolon
multiline_comment|/* This frame will arrive on PF_BRIDGE/LOCAL_OUT and we&n;&t;&t; * will need the indev then. For a brouter, the real indev&n;&t;&t; * can be a bridge port, so we make sure br_nf_local_out()&n;&t;&t; * doesn&squot;t use the bridge parent of the indev by using&n;&t;&t; * the BRNF_DONT_TAKE_PARENT mask.&n;&t;&t; */
r_if
c_cond
(paren
id|hook
op_eq
id|NF_IP_FORWARD
op_logical_and
id|nf_bridge-&gt;physindev
op_eq
l_int|NULL
)paren
(brace
id|nf_bridge-&gt;mask
op_and_assign
id|BRNF_DONT_TAKE_PARENT
suffix:semicolon
id|nf_bridge-&gt;physindev
op_assign
(paren
r_struct
id|net_device
op_star
)paren
id|in
suffix:semicolon
)brace
id|okfn
c_func
(paren
id|skb
)paren
suffix:semicolon
r_return
id|NF_STOLEN
suffix:semicolon
)brace
r_return
id|NF_ACCEPT
suffix:semicolon
)brace
multiline_comment|/* For br_nf_local_out we need (prio = NF_BR_PRI_FIRST), to insure that innocent&n; * PF_BRIDGE/NF_BR_LOCAL_OUT functions don&squot;t get bridged traffic as input.&n; * For br_nf_post_routing, we need (prio = NF_BR_PRI_LAST), because&n; * ip_refrag() can return NF_STOLEN.&n; */
DECL|variable|br_nf_ops
r_static
r_struct
id|nf_hook_ops
id|br_nf_ops
(braket
)braket
op_assign
(brace
(brace
dot
id|hook
op_assign
id|br_nf_pre_routing
comma
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|pf
op_assign
id|PF_BRIDGE
comma
dot
id|hooknum
op_assign
id|NF_BR_PRE_ROUTING
comma
dot
id|priority
op_assign
id|NF_BR_PRI_BRNF
comma
)brace
comma
(brace
dot
id|hook
op_assign
id|br_nf_local_in
comma
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|pf
op_assign
id|PF_BRIDGE
comma
dot
id|hooknum
op_assign
id|NF_BR_LOCAL_IN
comma
dot
id|priority
op_assign
id|NF_BR_PRI_BRNF
comma
)brace
comma
(brace
dot
id|hook
op_assign
id|br_nf_forward
comma
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|pf
op_assign
id|PF_BRIDGE
comma
dot
id|hooknum
op_assign
id|NF_BR_FORWARD
comma
dot
id|priority
op_assign
id|NF_BR_PRI_BRNF
comma
)brace
comma
(brace
dot
id|hook
op_assign
id|br_nf_local_out
comma
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|pf
op_assign
id|PF_BRIDGE
comma
dot
id|hooknum
op_assign
id|NF_BR_LOCAL_OUT
comma
dot
id|priority
op_assign
id|NF_BR_PRI_FIRST
comma
)brace
comma
(brace
dot
id|hook
op_assign
id|br_nf_post_routing
comma
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|pf
op_assign
id|PF_BRIDGE
comma
dot
id|hooknum
op_assign
id|NF_BR_POST_ROUTING
comma
dot
id|priority
op_assign
id|NF_BR_PRI_LAST
comma
)brace
comma
(brace
dot
id|hook
op_assign
id|ipv4_sabotage_in
comma
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|pf
op_assign
id|PF_INET
comma
dot
id|hooknum
op_assign
id|NF_IP_PRE_ROUTING
comma
dot
id|priority
op_assign
id|NF_IP_PRI_FIRST
comma
)brace
comma
(brace
dot
id|hook
op_assign
id|ipv4_sabotage_out
comma
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|pf
op_assign
id|PF_INET
comma
dot
id|hooknum
op_assign
id|NF_IP_FORWARD
comma
dot
id|priority
op_assign
id|NF_IP_PRI_BRIDGE_SABOTAGE_FORWARD
comma
)brace
comma
(brace
dot
id|hook
op_assign
id|ipv4_sabotage_out
comma
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|pf
op_assign
id|PF_INET
comma
dot
id|hooknum
op_assign
id|NF_IP_LOCAL_OUT
comma
dot
id|priority
op_assign
id|NF_IP_PRI_BRIDGE_SABOTAGE_LOCAL_OUT
comma
)brace
comma
(brace
dot
id|hook
op_assign
id|ipv4_sabotage_out
comma
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|pf
op_assign
id|PF_INET
comma
dot
id|hooknum
op_assign
id|NF_IP_POST_ROUTING
comma
dot
id|priority
op_assign
id|NF_IP_PRI_FIRST
comma
)brace
comma
)brace
suffix:semicolon
DECL|function|br_netfilter_init
r_int
id|br_netfilter_init
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ARRAY_SIZE
c_func
(paren
id|br_nf_ops
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|nf_register_hook
c_func
(paren
op_amp
id|br_nf_ops
(braket
id|i
)braket
)paren
)paren
op_ge
l_int|0
)paren
r_continue
suffix:semicolon
r_while
c_loop
(paren
id|i
op_decrement
)paren
id|nf_unregister_hook
c_func
(paren
op_amp
id|br_nf_ops
(braket
id|i
)braket
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;Bridge firewalling registered&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|br_netfilter_fini
r_void
id|br_netfilter_fini
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|ARRAY_SIZE
c_func
(paren
id|br_nf_ops
)paren
op_minus
l_int|1
suffix:semicolon
id|i
op_ge
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
id|nf_unregister_hook
c_func
(paren
op_amp
id|br_nf_ops
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
eof
