multiline_comment|/*&n; * super.c&n; *&n; * Copyright (C) 2001-2002 Will Dyson &lt;will_dyson@pobox.com&gt;&n; *&n; * Licensed under the GNU GPL. See the file COPYING for details.&n; *&n; */
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &quot;befs.h&quot;
macro_line|#include &quot;super.h&quot;
macro_line|#include &quot;endian.h&quot;
multiline_comment|/**&n; * load_befs_sb -- Read from disk and properly byteswap all the fields&n; * of the befs superblock&n; *&n; *&n; *&n; *&n; */
r_int
DECL|function|befs_load_sb
id|befs_load_sb
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
id|befs_super_block
op_star
id|disk_sb
)paren
(brace
id|befs_sb_info
op_star
id|befs_sb
op_assign
id|BEFS_SB
c_func
(paren
id|sb
)paren
suffix:semicolon
multiline_comment|/* Check the byte order of the filesystem */
r_if
c_cond
(paren
id|le32_to_cpu
c_func
(paren
id|disk_sb-&gt;fs_byte_order
)paren
op_eq
id|BEFS_BYTEORDER_NATIVE
)paren
id|befs_sb-&gt;byte_order
op_assign
id|BEFS_BYTESEX_LE
suffix:semicolon
r_else
r_if
c_cond
(paren
id|be32_to_cpu
c_func
(paren
id|disk_sb-&gt;fs_byte_order
)paren
op_eq
id|BEFS_BYTEORDER_NATIVE
)paren
id|befs_sb-&gt;byte_order
op_assign
id|BEFS_BYTESEX_BE
suffix:semicolon
id|befs_sb-&gt;magic1
op_assign
id|fs32_to_cpu
c_func
(paren
id|sb
comma
id|disk_sb-&gt;magic1
)paren
suffix:semicolon
id|befs_sb-&gt;magic2
op_assign
id|fs32_to_cpu
c_func
(paren
id|sb
comma
id|disk_sb-&gt;magic2
)paren
suffix:semicolon
id|befs_sb-&gt;magic3
op_assign
id|fs32_to_cpu
c_func
(paren
id|sb
comma
id|disk_sb-&gt;magic3
)paren
suffix:semicolon
id|befs_sb-&gt;block_size
op_assign
id|fs32_to_cpu
c_func
(paren
id|sb
comma
id|disk_sb-&gt;block_size
)paren
suffix:semicolon
id|befs_sb-&gt;block_shift
op_assign
id|fs32_to_cpu
c_func
(paren
id|sb
comma
id|disk_sb-&gt;block_shift
)paren
suffix:semicolon
id|befs_sb-&gt;num_blocks
op_assign
id|fs64_to_cpu
c_func
(paren
id|sb
comma
id|disk_sb-&gt;num_blocks
)paren
suffix:semicolon
id|befs_sb-&gt;used_blocks
op_assign
id|fs64_to_cpu
c_func
(paren
id|sb
comma
id|disk_sb-&gt;used_blocks
)paren
suffix:semicolon
id|befs_sb-&gt;inode_size
op_assign
id|fs32_to_cpu
c_func
(paren
id|sb
comma
id|disk_sb-&gt;inode_size
)paren
suffix:semicolon
id|befs_sb-&gt;blocks_per_ag
op_assign
id|fs32_to_cpu
c_func
(paren
id|sb
comma
id|disk_sb-&gt;blocks_per_ag
)paren
suffix:semicolon
id|befs_sb-&gt;ag_shift
op_assign
id|fs32_to_cpu
c_func
(paren
id|sb
comma
id|disk_sb-&gt;ag_shift
)paren
suffix:semicolon
id|befs_sb-&gt;num_ags
op_assign
id|fs32_to_cpu
c_func
(paren
id|sb
comma
id|disk_sb-&gt;num_ags
)paren
suffix:semicolon
id|befs_sb-&gt;log_blocks
op_assign
id|fsrun_to_cpu
c_func
(paren
id|sb
comma
id|disk_sb-&gt;log_blocks
)paren
suffix:semicolon
id|befs_sb-&gt;log_start
op_assign
id|fs64_to_cpu
c_func
(paren
id|sb
comma
id|disk_sb-&gt;log_start
)paren
suffix:semicolon
id|befs_sb-&gt;log_end
op_assign
id|fs64_to_cpu
c_func
(paren
id|sb
comma
id|disk_sb-&gt;log_end
)paren
suffix:semicolon
id|befs_sb-&gt;root_dir
op_assign
id|fsrun_to_cpu
c_func
(paren
id|sb
comma
id|disk_sb-&gt;root_dir
)paren
suffix:semicolon
id|befs_sb-&gt;indices
op_assign
id|fsrun_to_cpu
c_func
(paren
id|sb
comma
id|disk_sb-&gt;indices
)paren
suffix:semicolon
id|befs_sb-&gt;nls
op_assign
l_int|NULL
suffix:semicolon
r_return
id|BEFS_OK
suffix:semicolon
)brace
r_int
DECL|function|befs_check_sb
id|befs_check_sb
c_func
(paren
r_struct
id|super_block
op_star
id|sb
)paren
(brace
id|befs_sb_info
op_star
id|befs_sb
op_assign
id|BEFS_SB
c_func
(paren
id|sb
)paren
suffix:semicolon
multiline_comment|/* Check magic headers of super block */
r_if
c_cond
(paren
(paren
id|befs_sb-&gt;magic1
op_ne
id|BEFS_SUPER_MAGIC1
)paren
op_logical_or
(paren
id|befs_sb-&gt;magic2
op_ne
id|BEFS_SUPER_MAGIC2
)paren
op_logical_or
(paren
id|befs_sb-&gt;magic3
op_ne
id|BEFS_SUPER_MAGIC3
)paren
)paren
(brace
id|befs_error
c_func
(paren
id|sb
comma
l_string|&quot;invalid magic header&quot;
)paren
suffix:semicolon
r_return
id|BEFS_ERR
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Check blocksize of BEFS.&n;&t; *&n;&t; * Blocksize of BEFS is 1024, 2048, 4096 or 8192.&n;&t; */
r_if
c_cond
(paren
(paren
id|befs_sb-&gt;block_size
op_ne
l_int|1024
)paren
op_logical_and
(paren
id|befs_sb-&gt;block_size
op_ne
l_int|2048
)paren
op_logical_and
(paren
id|befs_sb-&gt;block_size
op_ne
l_int|4096
)paren
op_logical_and
(paren
id|befs_sb-&gt;block_size
op_ne
l_int|8192
)paren
)paren
(brace
id|befs_error
c_func
(paren
id|sb
comma
l_string|&quot;invalid blocksize: %u&quot;
comma
id|befs_sb-&gt;block_size
)paren
suffix:semicolon
r_return
id|BEFS_ERR
suffix:semicolon
)brace
r_if
c_cond
(paren
id|befs_sb-&gt;block_size
OG
id|PAGE_SIZE
)paren
(brace
id|befs_error
c_func
(paren
id|sb
comma
l_string|&quot;blocksize(%u) cannot be larger&quot;
l_string|&quot;than system pagesize(%lu)&quot;
comma
id|befs_sb-&gt;block_size
comma
id|PAGE_SIZE
)paren
suffix:semicolon
r_return
id|BEFS_ERR
suffix:semicolon
)brace
multiline_comment|/*&n;&t;   * block_shift and block_size encode the same information&n;&t;   * in different ways as a consistency check.&n;&t; */
r_if
c_cond
(paren
(paren
l_int|1
op_lshift
id|befs_sb-&gt;block_shift
)paren
op_ne
id|befs_sb-&gt;block_size
)paren
(brace
id|befs_error
c_func
(paren
id|sb
comma
l_string|&quot;block_shift disagrees with block_size. &quot;
l_string|&quot;Corruption likely.&quot;
)paren
suffix:semicolon
r_return
id|BEFS_ERR
suffix:semicolon
)brace
r_if
c_cond
(paren
id|befs_sb-&gt;log_start
op_ne
id|befs_sb-&gt;log_end
)paren
(brace
id|befs_error
c_func
(paren
id|sb
comma
l_string|&quot;Filesystem not clean! There are blocks in the &quot;
l_string|&quot;journal. You must boot into BeOS and mount this volume &quot;
l_string|&quot;to make it clean.&quot;
)paren
suffix:semicolon
r_return
id|BEFS_ERR
suffix:semicolon
)brace
r_return
id|BEFS_OK
suffix:semicolon
)brace
eof
