multiline_comment|/*&n; * linux/fs/befs/linuxvfs.c&n; *&n; * Copyright (C) 2001 Will Dyson &lt;will_dyson@pobox.com&n; *&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/nls.h&gt;
macro_line|#include &lt;linux/buffer_head.h&gt;
macro_line|#include &lt;linux/vfs.h&gt;
macro_line|#include &quot;befs.h&quot;
macro_line|#include &quot;btree.h&quot;
macro_line|#include &quot;inode.h&quot;
macro_line|#include &quot;datastream.h&quot;
macro_line|#include &quot;super.h&quot;
macro_line|#include &quot;io.h&quot;
macro_line|#include &quot;endian.h&quot;
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;BeOS File System (BeFS) driver&quot;
)paren
suffix:semicolon
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Will Dyson&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
multiline_comment|/* The units the vfs expects inode-&gt;i_blocks to be in */
DECL|macro|VFS_BLOCK_SIZE
mdefine_line|#define VFS_BLOCK_SIZE 512
r_static
r_int
id|befs_readdir
c_func
(paren
r_struct
id|file
op_star
comma
r_void
op_star
comma
id|filldir_t
)paren
suffix:semicolon
r_static
r_int
id|befs_get_block
c_func
(paren
r_struct
id|inode
op_star
comma
id|sector_t
comma
r_struct
id|buffer_head
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|befs_readpage
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_struct
id|page
op_star
id|page
)paren
suffix:semicolon
r_static
id|sector_t
id|befs_bmap
c_func
(paren
r_struct
id|address_space
op_star
id|mapping
comma
id|sector_t
id|block
)paren
suffix:semicolon
r_static
r_struct
id|dentry
op_star
id|befs_lookup
c_func
(paren
r_struct
id|inode
op_star
comma
r_struct
id|dentry
op_star
)paren
suffix:semicolon
r_static
r_void
id|befs_read_inode
c_func
(paren
r_struct
id|inode
op_star
id|ino
)paren
suffix:semicolon
r_static
r_struct
id|inode
op_star
id|befs_alloc_inode
c_func
(paren
r_struct
id|super_block
op_star
id|sb
)paren
suffix:semicolon
r_static
r_void
id|befs_destroy_inode
c_func
(paren
r_struct
id|inode
op_star
id|inode
)paren
suffix:semicolon
r_static
r_int
id|befs_init_inodecache
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_void
id|befs_destroy_inodecache
c_func
(paren
r_void
)paren
suffix:semicolon
r_static
r_int
id|befs_readlink
c_func
(paren
r_struct
id|dentry
op_star
comma
r_char
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|befs_follow_link
c_func
(paren
r_struct
id|dentry
op_star
comma
r_struct
id|nameidata
op_star
id|nd
)paren
suffix:semicolon
r_static
r_int
id|befs_utf2nls
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_const
r_char
op_star
id|in
comma
r_int
id|in_len
comma
r_char
op_star
op_star
id|out
comma
r_int
op_star
id|out_len
)paren
suffix:semicolon
r_static
r_int
id|befs_nls2utf
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_const
r_char
op_star
id|in
comma
r_int
id|in_len
comma
r_char
op_star
op_star
id|out
comma
r_int
op_star
id|out_len
)paren
suffix:semicolon
r_static
r_void
id|befs_put_super
c_func
(paren
r_struct
id|super_block
op_star
)paren
suffix:semicolon
r_static
r_int
id|befs_remount
c_func
(paren
r_struct
id|super_block
op_star
comma
r_int
op_star
comma
r_char
op_star
)paren
suffix:semicolon
r_static
r_int
id|befs_statfs
c_func
(paren
r_struct
id|super_block
op_star
comma
r_struct
id|kstatfs
op_star
)paren
suffix:semicolon
r_static
r_int
id|parse_options
c_func
(paren
r_char
op_star
comma
id|befs_mount_options
op_star
)paren
suffix:semicolon
DECL|variable|befs_sops
r_static
r_const
r_struct
id|super_operations
id|befs_sops
op_assign
(brace
dot
id|read_inode
op_assign
id|befs_read_inode
comma
multiline_comment|/* initialize &amp; read inode */
dot
id|alloc_inode
op_assign
id|befs_alloc_inode
comma
multiline_comment|/* allocate a new inode */
dot
id|destroy_inode
op_assign
id|befs_destroy_inode
comma
multiline_comment|/* deallocate an inode */
dot
id|put_super
op_assign
id|befs_put_super
comma
multiline_comment|/* uninit super */
dot
id|statfs
op_assign
id|befs_statfs
comma
multiline_comment|/* statfs */
dot
id|remount_fs
op_assign
id|befs_remount
comma
)brace
suffix:semicolon
multiline_comment|/* slab cache for befs_inode_info objects */
DECL|variable|befs_inode_cachep
r_static
id|kmem_cache_t
op_star
id|befs_inode_cachep
suffix:semicolon
DECL|variable|befs_dir_operations
r_struct
id|file_operations
id|befs_dir_operations
op_assign
(brace
dot
id|read
op_assign
id|generic_read_dir
comma
dot
id|readdir
op_assign
id|befs_readdir
comma
)brace
suffix:semicolon
DECL|variable|befs_dir_inode_operations
r_struct
id|inode_operations
id|befs_dir_inode_operations
op_assign
(brace
dot
id|lookup
op_assign
id|befs_lookup
comma
)brace
suffix:semicolon
DECL|variable|befs_file_operations
r_struct
id|file_operations
id|befs_file_operations
op_assign
(brace
dot
id|llseek
op_assign
id|default_llseek
comma
dot
id|read
op_assign
id|generic_file_read
comma
dot
id|mmap
op_assign
id|generic_file_readonly_mmap
comma
)brace
suffix:semicolon
DECL|variable|befs_aops
r_struct
id|address_space_operations
id|befs_aops
op_assign
(brace
dot
id|readpage
op_assign
id|befs_readpage
comma
dot
id|sync_page
op_assign
id|block_sync_page
comma
dot
id|bmap
op_assign
id|befs_bmap
comma
)brace
suffix:semicolon
DECL|variable|befs_symlink_inode_operations
r_static
r_struct
id|inode_operations
id|befs_symlink_inode_operations
op_assign
(brace
dot
id|readlink
op_assign
id|befs_readlink
comma
dot
id|follow_link
op_assign
id|befs_follow_link
comma
)brace
suffix:semicolon
multiline_comment|/* &n; * Called by generic_file_read() to read a page of data&n; * &n; * In turn, simply calls a generic block read function and&n; * passes it the address of befs_get_block, for mapping file&n; * positions to disk blocks.&n; */
r_static
r_int
DECL|function|befs_readpage
id|befs_readpage
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_struct
id|page
op_star
id|page
)paren
(brace
r_return
id|block_read_full_page
c_func
(paren
id|page
comma
id|befs_get_block
)paren
suffix:semicolon
)brace
r_static
id|sector_t
DECL|function|befs_bmap
id|befs_bmap
c_func
(paren
r_struct
id|address_space
op_star
id|mapping
comma
id|sector_t
id|block
)paren
(brace
r_return
id|generic_block_bmap
c_func
(paren
id|mapping
comma
id|block
comma
id|befs_get_block
)paren
suffix:semicolon
)brace
multiline_comment|/* &n; * Generic function to map a file position (block) to a &n; * disk offset (passed back in bh_result).&n; *&n; * Used by many higher level functions.&n; *&n; * Calls befs_fblock2brun() in datastream.c to do the real work.&n; *&n; * -WD 10-26-01&n; */
r_static
r_int
DECL|function|befs_get_block
id|befs_get_block
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
id|sector_t
id|block
comma
r_struct
id|buffer_head
op_star
id|bh_result
comma
r_int
id|create
)paren
(brace
r_struct
id|super_block
op_star
id|sb
op_assign
id|inode-&gt;i_sb
suffix:semicolon
id|befs_data_stream
op_star
id|ds
op_assign
op_amp
id|BEFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|i_data.ds
suffix:semicolon
id|befs_block_run
id|run
op_assign
id|BAD_IADDR
suffix:semicolon
r_int
id|res
op_assign
l_int|0
suffix:semicolon
id|ulong
id|disk_off
suffix:semicolon
id|befs_debug
c_func
(paren
id|sb
comma
l_string|&quot;---&gt; befs_get_block() for inode %lu, block %ld&quot;
comma
id|inode-&gt;i_ino
comma
id|block
)paren
suffix:semicolon
r_if
c_cond
(paren
id|block
OL
l_int|0
)paren
(brace
id|befs_error
c_func
(paren
id|sb
comma
l_string|&quot;befs_get_block() was asked for a block &quot;
l_string|&quot;number less than zero: block %ld in inode %lu&quot;
comma
id|block
comma
id|inode-&gt;i_ino
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_if
c_cond
(paren
id|create
)paren
(brace
id|befs_error
c_func
(paren
id|sb
comma
l_string|&quot;befs_get_block() was asked to write to &quot;
l_string|&quot;block %ld in inode %lu&quot;
comma
id|block
comma
id|inode-&gt;i_ino
)paren
suffix:semicolon
r_return
op_minus
id|EPERM
suffix:semicolon
)brace
id|res
op_assign
id|befs_fblock2brun
c_func
(paren
id|sb
comma
id|ds
comma
id|block
comma
op_amp
id|run
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
op_ne
id|BEFS_OK
)paren
(brace
id|befs_error
c_func
(paren
id|sb
comma
l_string|&quot;&lt;--- befs_get_block() for inode %lu, block &quot;
l_string|&quot;%ld ERROR&quot;
comma
id|inode-&gt;i_ino
comma
id|block
)paren
suffix:semicolon
r_return
op_minus
id|EFBIG
suffix:semicolon
)brace
id|disk_off
op_assign
(paren
id|ulong
)paren
id|iaddr2blockno
c_func
(paren
id|sb
comma
op_amp
id|run
)paren
suffix:semicolon
id|map_bh
c_func
(paren
id|bh_result
comma
id|inode-&gt;i_sb
comma
id|disk_off
)paren
suffix:semicolon
id|befs_debug
c_func
(paren
id|sb
comma
l_string|&quot;&lt;--- befs_get_block() for inode %lu, block %ld, &quot;
l_string|&quot;disk address %lu&quot;
comma
id|inode-&gt;i_ino
comma
id|block
comma
id|disk_off
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_struct
id|dentry
op_star
DECL|function|befs_lookup
id|befs_lookup
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|dentry
op_star
id|dentry
)paren
(brace
r_struct
id|inode
op_star
id|inode
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|super_block
op_star
id|sb
op_assign
id|dir-&gt;i_sb
suffix:semicolon
id|befs_data_stream
op_star
id|ds
op_assign
op_amp
id|BEFS_I
c_func
(paren
id|dir
)paren
op_member_access_from_pointer
id|i_data.ds
suffix:semicolon
id|befs_off_t
id|offset
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_int
id|utfnamelen
suffix:semicolon
r_char
op_star
id|utfname
suffix:semicolon
r_const
r_char
op_star
id|name
op_assign
id|dentry-&gt;d_name.name
suffix:semicolon
id|befs_debug
c_func
(paren
id|sb
comma
l_string|&quot;---&gt; befs_lookup() &quot;
l_string|&quot;name %s inode %ld&quot;
comma
id|dentry-&gt;d_name.name
comma
id|dir-&gt;i_ino
)paren
suffix:semicolon
multiline_comment|/* Convert to UTF-8 */
r_if
c_cond
(paren
id|BEFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|nls
)paren
(brace
id|ret
op_assign
id|befs_nls2utf
c_func
(paren
id|sb
comma
id|name
comma
id|strlen
c_func
(paren
id|name
)paren
comma
op_amp
id|utfname
comma
op_amp
id|utfnamelen
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
id|befs_debug
c_func
(paren
id|sb
comma
l_string|&quot;&lt;--- befs_lookup() ERROR&quot;
)paren
suffix:semicolon
r_return
id|ERR_PTR
c_func
(paren
id|ret
)paren
suffix:semicolon
)brace
id|ret
op_assign
id|befs_btree_find
c_func
(paren
id|sb
comma
id|ds
comma
id|utfname
comma
op_amp
id|offset
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|utfname
)paren
suffix:semicolon
)brace
r_else
(brace
id|ret
op_assign
id|befs_btree_find
c_func
(paren
id|sb
comma
id|ds
comma
id|dentry-&gt;d_name.name
comma
op_amp
id|offset
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ret
op_eq
id|BEFS_BT_NOT_FOUND
)paren
(brace
id|befs_debug
c_func
(paren
id|sb
comma
l_string|&quot;&lt;--- befs_lookup() %s not found&quot;
comma
id|dentry-&gt;d_name.name
)paren
suffix:semicolon
r_return
id|ERR_PTR
c_func
(paren
op_minus
id|ENOENT
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ret
op_ne
id|BEFS_OK
op_logical_or
id|offset
op_eq
l_int|0
)paren
(brace
id|befs_warning
c_func
(paren
id|sb
comma
l_string|&quot;&lt;--- befs_lookup() Error&quot;
)paren
suffix:semicolon
r_return
id|ERR_PTR
c_func
(paren
op_minus
id|ENODATA
)paren
suffix:semicolon
)brace
id|inode
op_assign
id|iget
c_func
(paren
id|dir-&gt;i_sb
comma
(paren
id|ino_t
)paren
id|offset
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|inode
)paren
r_return
id|ERR_PTR
c_func
(paren
op_minus
id|EACCES
)paren
suffix:semicolon
id|d_add
c_func
(paren
id|dentry
comma
id|inode
)paren
suffix:semicolon
id|befs_debug
c_func
(paren
id|sb
comma
l_string|&quot;&lt;--- befs_lookup()&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_static
r_int
DECL|function|befs_readdir
id|befs_readdir
c_func
(paren
r_struct
id|file
op_star
id|filp
comma
r_void
op_star
id|dirent
comma
id|filldir_t
id|filldir
)paren
(brace
r_struct
id|inode
op_star
id|inode
op_assign
id|filp-&gt;f_dentry-&gt;d_inode
suffix:semicolon
r_struct
id|super_block
op_star
id|sb
op_assign
id|inode-&gt;i_sb
suffix:semicolon
id|befs_data_stream
op_star
id|ds
op_assign
op_amp
id|BEFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|i_data.ds
suffix:semicolon
id|befs_off_t
id|value
suffix:semicolon
r_int
id|result
suffix:semicolon
r_int
id|keysize
suffix:semicolon
r_int
r_char
id|d_type
suffix:semicolon
r_char
id|keybuf
(braket
id|BEFS_NAME_LEN
op_plus
l_int|1
)braket
suffix:semicolon
r_char
op_star
id|nlsname
suffix:semicolon
r_int
id|nlsnamelen
suffix:semicolon
r_const
r_char
op_star
id|dirname
op_assign
id|filp-&gt;f_dentry-&gt;d_name.name
suffix:semicolon
id|befs_debug
c_func
(paren
id|sb
comma
l_string|&quot;---&gt; befs_readdir() &quot;
l_string|&quot;name %s, inode %ld, filp-&gt;f_pos %Ld&quot;
comma
id|dirname
comma
id|inode-&gt;i_ino
comma
id|filp-&gt;f_pos
)paren
suffix:semicolon
id|result
op_assign
id|befs_btree_read
c_func
(paren
id|sb
comma
id|ds
comma
id|filp-&gt;f_pos
comma
id|BEFS_NAME_LEN
op_plus
l_int|1
comma
id|keybuf
comma
op_amp
id|keysize
comma
op_amp
id|value
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_eq
id|BEFS_ERR
)paren
(brace
id|befs_debug
c_func
(paren
id|sb
comma
l_string|&quot;&lt;--- befs_readdir() ERROR&quot;
)paren
suffix:semicolon
id|befs_error
c_func
(paren
id|sb
comma
l_string|&quot;IO error reading %s (inode %lu)&quot;
comma
id|dirname
comma
id|inode-&gt;i_ino
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|result
op_eq
id|BEFS_BT_END
)paren
(brace
id|befs_debug
c_func
(paren
id|sb
comma
l_string|&quot;&lt;--- befs_readdir() END&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|result
op_eq
id|BEFS_BT_EMPTY
)paren
(brace
id|befs_debug
c_func
(paren
id|sb
comma
l_string|&quot;&lt;--- befs_readdir() Empty directory&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|d_type
op_assign
id|DT_UNKNOWN
suffix:semicolon
multiline_comment|/* Convert to NLS */
r_if
c_cond
(paren
id|BEFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|nls
)paren
(brace
id|result
op_assign
id|befs_utf2nls
c_func
(paren
id|sb
comma
id|keybuf
comma
id|keysize
comma
op_amp
id|nlsname
comma
op_amp
id|nlsnamelen
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
(brace
id|befs_debug
c_func
(paren
id|sb
comma
l_string|&quot;&lt;--- befs_readdir() ERROR&quot;
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
id|result
op_assign
id|filldir
c_func
(paren
id|dirent
comma
id|nlsname
comma
id|nlsnamelen
comma
id|filp-&gt;f_pos
comma
(paren
id|ino_t
)paren
id|value
comma
id|d_type
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|nlsname
)paren
suffix:semicolon
)brace
r_else
(brace
id|result
op_assign
id|filldir
c_func
(paren
id|dirent
comma
id|keybuf
comma
id|keysize
comma
id|filp-&gt;f_pos
comma
(paren
id|ino_t
)paren
id|value
comma
id|d_type
)paren
suffix:semicolon
)brace
id|filp-&gt;f_pos
op_increment
suffix:semicolon
id|befs_debug
c_func
(paren
id|sb
comma
l_string|&quot;&lt;--- befs_readdir() filp-&gt;f_pos %Ld&quot;
comma
id|filp-&gt;f_pos
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_struct
id|inode
op_star
DECL|function|befs_alloc_inode
id|befs_alloc_inode
c_func
(paren
r_struct
id|super_block
op_star
id|sb
)paren
(brace
r_struct
id|befs_inode_info
op_star
id|bi
suffix:semicolon
id|bi
op_assign
(paren
r_struct
id|befs_inode_info
op_star
)paren
id|kmem_cache_alloc
c_func
(paren
id|befs_inode_cachep
comma
id|SLAB_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bi
)paren
r_return
l_int|NULL
suffix:semicolon
r_return
op_amp
id|bi-&gt;vfs_inode
suffix:semicolon
)brace
r_static
r_void
DECL|function|befs_destroy_inode
id|befs_destroy_inode
c_func
(paren
r_struct
id|inode
op_star
id|inode
)paren
(brace
id|kmem_cache_free
c_func
(paren
id|befs_inode_cachep
comma
id|BEFS_I
c_func
(paren
id|inode
)paren
)paren
suffix:semicolon
)brace
DECL|function|init_once
r_static
r_void
id|init_once
c_func
(paren
r_void
op_star
id|foo
comma
id|kmem_cache_t
op_star
id|cachep
comma
r_int
r_int
id|flags
)paren
(brace
r_struct
id|befs_inode_info
op_star
id|bi
op_assign
(paren
r_struct
id|befs_inode_info
op_star
)paren
id|foo
suffix:semicolon
r_if
c_cond
(paren
(paren
id|flags
op_amp
(paren
id|SLAB_CTOR_VERIFY
op_or
id|SLAB_CTOR_CONSTRUCTOR
)paren
)paren
op_eq
id|SLAB_CTOR_CONSTRUCTOR
)paren
(brace
id|inode_init_once
c_func
(paren
op_amp
id|bi-&gt;vfs_inode
)paren
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|befs_read_inode
id|befs_read_inode
c_func
(paren
r_struct
id|inode
op_star
id|inode
)paren
(brace
r_struct
id|buffer_head
op_star
id|bh
op_assign
l_int|NULL
suffix:semicolon
id|befs_inode
op_star
id|raw_inode
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|super_block
op_star
id|sb
op_assign
id|inode-&gt;i_sb
suffix:semicolon
id|befs_sb_info
op_star
id|befs_sb
op_assign
id|BEFS_SB
c_func
(paren
id|sb
)paren
suffix:semicolon
id|befs_inode_info
op_star
id|befs_ino
op_assign
l_int|NULL
suffix:semicolon
id|befs_debug
c_func
(paren
id|sb
comma
l_string|&quot;---&gt; befs_read_inode() &quot;
l_string|&quot;inode = %lu&quot;
comma
id|inode-&gt;i_ino
)paren
suffix:semicolon
id|befs_ino
op_assign
id|BEFS_I
c_func
(paren
id|inode
)paren
suffix:semicolon
multiline_comment|/* convert from vfs&squot;s inode number to befs&squot;s inode number */
id|befs_ino-&gt;i_inode_num
op_assign
id|blockno2iaddr
c_func
(paren
id|sb
comma
id|inode-&gt;i_ino
)paren
suffix:semicolon
id|befs_debug
c_func
(paren
id|sb
comma
l_string|&quot;  real inode number [%u, %hu, %hu]&quot;
comma
id|befs_ino-&gt;i_inode_num.allocation_group
comma
id|befs_ino-&gt;i_inode_num.start
comma
id|befs_ino-&gt;i_inode_num.len
)paren
suffix:semicolon
id|bh
op_assign
id|befs_bread_iaddr
c_func
(paren
id|sb
comma
id|befs_ino-&gt;i_inode_num
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bh
)paren
(brace
id|befs_error
c_func
(paren
id|sb
comma
l_string|&quot;unable to read inode block - &quot;
l_string|&quot;inode = %lu&quot;
comma
id|inode-&gt;i_ino
)paren
suffix:semicolon
r_goto
id|unaquire_none
suffix:semicolon
)brace
id|raw_inode
op_assign
(paren
id|befs_inode
op_star
)paren
id|bh-&gt;b_data
suffix:semicolon
id|befs_dump_inode
c_func
(paren
id|sb
comma
id|raw_inode
)paren
suffix:semicolon
r_if
c_cond
(paren
id|befs_check_inode
c_func
(paren
id|sb
comma
id|raw_inode
comma
id|inode-&gt;i_ino
)paren
op_ne
id|BEFS_OK
)paren
(brace
id|befs_error
c_func
(paren
id|sb
comma
l_string|&quot;Bad inode: %lu&quot;
comma
id|inode-&gt;i_ino
)paren
suffix:semicolon
r_goto
id|unaquire_bh
suffix:semicolon
)brace
id|inode-&gt;i_mode
op_assign
(paren
id|umode_t
)paren
id|fs32_to_cpu
c_func
(paren
id|sb
comma
id|raw_inode-&gt;mode
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * set uid and gid.  But since current BeOS is single user OS, so&n;&t; * you can change by &quot;uid&quot; or &quot;gid&quot; options.&n;&t; */
id|inode-&gt;i_uid
op_assign
id|befs_sb-&gt;mount_opts.use_uid
ques
c_cond
id|befs_sb-&gt;mount_opts.uid
suffix:colon
(paren
id|uid_t
)paren
id|fs32_to_cpu
c_func
(paren
id|sb
comma
id|raw_inode-&gt;uid
)paren
suffix:semicolon
id|inode-&gt;i_gid
op_assign
id|befs_sb-&gt;mount_opts.use_gid
ques
c_cond
id|befs_sb-&gt;mount_opts.gid
suffix:colon
(paren
id|gid_t
)paren
id|fs32_to_cpu
c_func
(paren
id|sb
comma
id|raw_inode-&gt;gid
)paren
suffix:semicolon
id|inode-&gt;i_nlink
op_assign
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t; * BEFS&squot;s time is 64 bits, but current VFS is 32 bits...&n;&t; * BEFS don&squot;t have access time. Nor inode change time. VFS&n;&t; * doesn&squot;t have creation time.&n;&t; * Also, the lower 16 bits of the last_modified_time and &n;&t; * create_time are just a counter to help ensure uniqueness&n;&t; * for indexing purposes. (PFD, page 54)&n;&t; */
id|inode-&gt;i_mtime.tv_sec
op_assign
id|fs64_to_cpu
c_func
(paren
id|sb
comma
id|raw_inode-&gt;last_modified_time
)paren
op_rshift
l_int|16
suffix:semicolon
id|inode-&gt;i_mtime.tv_nsec
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* lower 16 bits are not a time */
id|inode-&gt;i_ctime
op_assign
id|inode-&gt;i_mtime
suffix:semicolon
id|inode-&gt;i_atime
op_assign
id|inode-&gt;i_mtime
suffix:semicolon
id|inode-&gt;i_blksize
op_assign
id|befs_sb-&gt;block_size
suffix:semicolon
id|befs_ino-&gt;i_inode_num
op_assign
id|fsrun_to_cpu
c_func
(paren
id|sb
comma
id|raw_inode-&gt;inode_num
)paren
suffix:semicolon
id|befs_ino-&gt;i_parent
op_assign
id|fsrun_to_cpu
c_func
(paren
id|sb
comma
id|raw_inode-&gt;parent
)paren
suffix:semicolon
id|befs_ino-&gt;i_attribute
op_assign
id|fsrun_to_cpu
c_func
(paren
id|sb
comma
id|raw_inode-&gt;attributes
)paren
suffix:semicolon
id|befs_ino-&gt;i_flags
op_assign
id|fs32_to_cpu
c_func
(paren
id|sb
comma
id|raw_inode-&gt;flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|S_ISLNK
c_func
(paren
id|inode-&gt;i_mode
)paren
op_logical_and
op_logical_neg
(paren
id|inode-&gt;i_flags
op_amp
id|BEFS_LONG_SYMLINK
)paren
)paren
(brace
id|inode-&gt;i_size
op_assign
l_int|0
suffix:semicolon
id|inode-&gt;i_blocks
op_assign
id|befs_sb-&gt;block_size
op_div
id|VFS_BLOCK_SIZE
suffix:semicolon
id|strncpy
c_func
(paren
id|befs_ino-&gt;i_data.symlink
comma
id|raw_inode-&gt;data.symlink
comma
id|BEFS_SYMLINK_LEN
)paren
suffix:semicolon
)brace
r_else
(brace
r_int
id|num_blks
suffix:semicolon
id|befs_ino-&gt;i_data.ds
op_assign
id|fsds_to_cpu
c_func
(paren
id|sb
comma
id|raw_inode-&gt;data.datastream
)paren
suffix:semicolon
id|num_blks
op_assign
id|befs_count_blocks
c_func
(paren
id|sb
comma
op_amp
id|befs_ino-&gt;i_data.ds
)paren
suffix:semicolon
id|inode-&gt;i_blocks
op_assign
id|num_blks
op_star
(paren
id|befs_sb-&gt;block_size
op_div
id|VFS_BLOCK_SIZE
)paren
suffix:semicolon
id|inode-&gt;i_size
op_assign
id|befs_ino-&gt;i_data.ds.size
suffix:semicolon
)brace
id|inode-&gt;i_mapping-&gt;a_ops
op_assign
op_amp
id|befs_aops
suffix:semicolon
r_if
c_cond
(paren
id|S_ISREG
c_func
(paren
id|inode-&gt;i_mode
)paren
)paren
(brace
id|inode-&gt;i_fop
op_assign
op_amp
id|befs_file_operations
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|S_ISDIR
c_func
(paren
id|inode-&gt;i_mode
)paren
)paren
(brace
id|inode-&gt;i_op
op_assign
op_amp
id|befs_dir_inode_operations
suffix:semicolon
id|inode-&gt;i_fop
op_assign
op_amp
id|befs_dir_operations
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|S_ISLNK
c_func
(paren
id|inode-&gt;i_mode
)paren
)paren
(brace
id|inode-&gt;i_op
op_assign
op_amp
id|befs_symlink_inode_operations
suffix:semicolon
)brace
r_else
(brace
id|befs_error
c_func
(paren
id|sb
comma
l_string|&quot;Inode %lu is not a regular file, &quot;
l_string|&quot;directory or symlink. THAT IS WRONG! BeFS has no &quot;
l_string|&quot;on disk special files&quot;
comma
id|inode-&gt;i_ino
)paren
suffix:semicolon
r_goto
id|unaquire_bh
suffix:semicolon
)brace
id|brelse
c_func
(paren
id|bh
)paren
suffix:semicolon
id|befs_debug
c_func
(paren
id|sb
comma
l_string|&quot;&lt;--- befs_read_inode()&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
id|unaquire_bh
suffix:colon
id|brelse
c_func
(paren
id|bh
)paren
suffix:semicolon
id|unaquire_none
suffix:colon
id|make_bad_inode
c_func
(paren
id|inode
)paren
suffix:semicolon
id|befs_debug
c_func
(paren
id|sb
comma
l_string|&quot;&lt;--- befs_read_inode() - Bad inode&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Initialize the inode cache. Called at fs setup.&n; * &n; * Taken from NFS implementation by Al Viro.&n; */
r_static
r_int
DECL|function|befs_init_inodecache
id|befs_init_inodecache
c_func
(paren
r_void
)paren
(brace
id|befs_inode_cachep
op_assign
id|kmem_cache_create
c_func
(paren
l_string|&quot;befs_inode_cache&quot;
comma
r_sizeof
(paren
r_struct
id|befs_inode_info
)paren
comma
l_int|0
comma
id|SLAB_HWCACHE_ALIGN
op_or
id|SLAB_RECLAIM_ACCOUNT
comma
id|init_once
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|befs_inode_cachep
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;befs_init_inodecache: &quot;
l_string|&quot;Couldn&squot;t initalize inode slabcache&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Called at fs teardown.&n; * &n; * Taken from NFS implementation by Al Viro.&n; */
r_static
r_void
DECL|function|befs_destroy_inodecache
id|befs_destroy_inodecache
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|kmem_cache_destroy
c_func
(paren
id|befs_inode_cachep
)paren
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;befs_destroy_inodecache: &quot;
l_string|&quot;not all structures were freed&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * The inode of symbolic link is different to data stream.&n; * The data stream become link name. Unless the LONG_SYMLINK&n; * flag is set.&n; */
r_static
r_int
DECL|function|befs_follow_link
id|befs_follow_link
c_func
(paren
r_struct
id|dentry
op_star
id|dentry
comma
r_struct
id|nameidata
op_star
id|nd
)paren
(brace
r_struct
id|super_block
op_star
id|sb
op_assign
id|dentry-&gt;d_sb
suffix:semicolon
id|befs_inode_info
op_star
id|befs_ino
op_assign
id|BEFS_I
c_func
(paren
id|dentry-&gt;d_inode
)paren
suffix:semicolon
r_char
op_star
id|link
suffix:semicolon
r_int
id|res
suffix:semicolon
r_if
c_cond
(paren
id|befs_ino-&gt;i_flags
op_amp
id|BEFS_LONG_SYMLINK
)paren
(brace
id|befs_data_stream
op_star
id|data
op_assign
op_amp
id|befs_ino-&gt;i_data.ds
suffix:semicolon
id|befs_off_t
id|linklen
op_assign
id|data-&gt;size
suffix:semicolon
id|befs_debug
c_func
(paren
id|sb
comma
l_string|&quot;Follow long symlink&quot;
)paren
suffix:semicolon
id|link
op_assign
id|kmalloc
c_func
(paren
id|linklen
comma
id|GFP_NOFS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|link
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
id|befs_read_lsymlink
c_func
(paren
id|sb
comma
id|data
comma
id|link
comma
id|linklen
)paren
op_ne
id|linklen
)paren
(brace
id|kfree
c_func
(paren
id|link
)paren
suffix:semicolon
id|befs_error
c_func
(paren
id|sb
comma
l_string|&quot;Failed to read entire long symlink&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|res
op_assign
id|vfs_follow_link
c_func
(paren
id|nd
comma
id|link
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|link
)paren
suffix:semicolon
)brace
r_else
(brace
id|link
op_assign
id|befs_ino-&gt;i_data.symlink
suffix:semicolon
id|res
op_assign
id|vfs_follow_link
c_func
(paren
id|nd
comma
id|link
)paren
suffix:semicolon
)brace
r_return
id|res
suffix:semicolon
)brace
r_static
r_int
DECL|function|befs_readlink
id|befs_readlink
c_func
(paren
r_struct
id|dentry
op_star
id|dentry
comma
r_char
op_star
id|buffer
comma
r_int
id|buflen
)paren
(brace
r_struct
id|super_block
op_star
id|sb
op_assign
id|dentry-&gt;d_sb
suffix:semicolon
id|befs_inode_info
op_star
id|befs_ino
op_assign
id|BEFS_I
c_func
(paren
id|dentry-&gt;d_inode
)paren
suffix:semicolon
r_char
op_star
id|link
suffix:semicolon
r_int
id|res
suffix:semicolon
r_if
c_cond
(paren
id|befs_ino-&gt;i_flags
op_amp
id|BEFS_LONG_SYMLINK
)paren
(brace
id|befs_data_stream
op_star
id|data
op_assign
op_amp
id|befs_ino-&gt;i_data.ds
suffix:semicolon
id|befs_off_t
id|linklen
op_assign
id|data-&gt;size
suffix:semicolon
id|befs_debug
c_func
(paren
id|sb
comma
l_string|&quot;Read long symlink&quot;
)paren
suffix:semicolon
id|link
op_assign
id|kmalloc
c_func
(paren
id|linklen
comma
id|GFP_NOFS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|link
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
id|befs_read_lsymlink
c_func
(paren
id|sb
comma
id|data
comma
id|link
comma
id|linklen
)paren
op_ne
id|linklen
)paren
(brace
id|kfree
c_func
(paren
id|link
)paren
suffix:semicolon
id|befs_error
c_func
(paren
id|sb
comma
l_string|&quot;Failed to read entire long symlink&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|res
op_assign
id|vfs_readlink
c_func
(paren
id|dentry
comma
id|buffer
comma
id|buflen
comma
id|link
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|link
)paren
suffix:semicolon
)brace
r_else
(brace
id|link
op_assign
id|befs_ino-&gt;i_data.symlink
suffix:semicolon
id|res
op_assign
id|vfs_readlink
c_func
(paren
id|dentry
comma
id|buffer
comma
id|buflen
comma
id|link
)paren
suffix:semicolon
)brace
r_return
id|res
suffix:semicolon
)brace
multiline_comment|/*&n; * UTF-8 to NLS charset  convert routine&n; * &n; *&n; * Changed 8/10/01 by Will Dyson. Now use uni2char() / char2uni() rather than&n; * the nls tables directly&n; */
r_static
r_int
DECL|function|befs_utf2nls
id|befs_utf2nls
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_const
r_char
op_star
id|in
comma
r_int
id|in_len
comma
r_char
op_star
op_star
id|out
comma
r_int
op_star
id|out_len
)paren
(brace
r_struct
id|nls_table
op_star
id|nls
op_assign
id|BEFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|nls
suffix:semicolon
r_int
id|i
comma
id|o
suffix:semicolon
m_wchar_t
id|uni
suffix:semicolon
r_int
id|unilen
comma
id|utflen
suffix:semicolon
r_char
op_star
id|result
suffix:semicolon
r_int
id|maxlen
op_assign
id|in_len
suffix:semicolon
multiline_comment|/* The utf8-&gt;nls conversion can&squot;t make more chars */
id|befs_debug
c_func
(paren
id|sb
comma
l_string|&quot;---&gt; utf2nls()&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|nls
)paren
(brace
id|befs_error
c_func
(paren
id|sb
comma
l_string|&quot;befs_utf2nls called with no NLS table loaded&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
op_star
id|out
op_assign
id|result
op_assign
id|kmalloc
c_func
(paren
id|maxlen
comma
id|GFP_NOFS
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
op_star
id|out
)paren
(brace
id|befs_error
c_func
(paren
id|sb
comma
l_string|&quot;befs_utf2nls() cannot allocate memory&quot;
)paren
suffix:semicolon
op_star
id|out_len
op_assign
l_int|0
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
id|o
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|in_len
suffix:semicolon
id|i
op_add_assign
id|utflen
comma
id|o
op_add_assign
id|unilen
)paren
(brace
multiline_comment|/* convert from UTF-8 to Unicode */
id|utflen
op_assign
id|utf8_mbtowc
c_func
(paren
op_amp
id|uni
comma
op_amp
id|in
(braket
id|i
)braket
comma
id|in_len
op_minus
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|utflen
OL
l_int|0
)paren
(brace
r_goto
id|conv_err
suffix:semicolon
)brace
multiline_comment|/* convert from Unicode to nls */
id|unilen
op_assign
id|nls
op_member_access_from_pointer
id|uni2char
c_func
(paren
id|uni
comma
op_amp
id|result
(braket
id|o
)braket
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unilen
OL
l_int|0
)paren
(brace
r_goto
id|conv_err
suffix:semicolon
)brace
)brace
id|result
(braket
id|o
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
op_star
id|out_len
op_assign
id|o
suffix:semicolon
id|befs_debug
c_func
(paren
id|sb
comma
l_string|&quot;&lt;--- utf2nls()&quot;
)paren
suffix:semicolon
r_return
id|o
suffix:semicolon
id|conv_err
suffix:colon
id|befs_error
c_func
(paren
id|sb
comma
l_string|&quot;Name using charecter set %s contains a charecter that &quot;
l_string|&quot;cannot be converted to unicode.&quot;
comma
id|nls-&gt;charset
)paren
suffix:semicolon
id|befs_debug
c_func
(paren
id|sb
comma
l_string|&quot;&lt;--- utf2nls()&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|result
)paren
suffix:semicolon
r_return
op_minus
id|EILSEQ
suffix:semicolon
)brace
multiline_comment|/**&n; * befs_nls2utf - Convert NLS string to utf8 encodeing&n; * @sb: Superblock&n; * @src: Input string buffer in NLS format&n; * @srclen: Length of input string in bytes&n; * @dest: The output string in UTF8 format&n; * @destlen: Length of the output buffer&n; * &n; * Converts input string @src, which is in the format of the loaded NLS map,&n; * into a utf8 string.&n; * &n; * The destination string @dest is allocated by this function and the caller is&n; * responsible for freeing it with kfree()&n; * &n; * On return, *@destlen is the length of @dest in bytes.&n; *&n; * On success, the return value is the number of utf8 characters written to&n; * the output buffer @dest.&n; *  &n; * On Failure, a negative number coresponding to the error code is returned.&n; */
r_static
r_int
DECL|function|befs_nls2utf
id|befs_nls2utf
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_const
r_char
op_star
id|in
comma
r_int
id|in_len
comma
r_char
op_star
op_star
id|out
comma
r_int
op_star
id|out_len
)paren
(brace
r_struct
id|nls_table
op_star
id|nls
op_assign
id|BEFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|nls
suffix:semicolon
r_int
id|i
comma
id|o
suffix:semicolon
m_wchar_t
id|uni
suffix:semicolon
r_int
id|unilen
comma
id|utflen
suffix:semicolon
r_char
op_star
id|result
suffix:semicolon
r_int
id|maxlen
op_assign
l_int|3
op_star
id|in_len
suffix:semicolon
id|befs_debug
c_func
(paren
id|sb
comma
l_string|&quot;---&gt; nls2utf()&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|nls
)paren
(brace
id|befs_error
c_func
(paren
id|sb
comma
l_string|&quot;befs_nls2utf called with no NLS table loaded.&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
op_star
id|out
op_assign
id|result
op_assign
id|kmalloc
c_func
(paren
id|maxlen
comma
id|GFP_NOFS
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
op_star
id|out
)paren
(brace
id|befs_error
c_func
(paren
id|sb
comma
l_string|&quot;befs_nls2utf() cannot allocate memory&quot;
)paren
suffix:semicolon
op_star
id|out_len
op_assign
l_int|0
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
id|o
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|in_len
suffix:semicolon
id|i
op_add_assign
id|unilen
comma
id|o
op_add_assign
id|utflen
)paren
(brace
multiline_comment|/* convert from nls to unicode */
id|unilen
op_assign
id|nls
op_member_access_from_pointer
id|char2uni
c_func
(paren
op_amp
id|in
(braket
id|i
)braket
comma
id|in_len
op_minus
id|i
comma
op_amp
id|uni
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unilen
OL
l_int|0
)paren
(brace
r_goto
id|conv_err
suffix:semicolon
)brace
multiline_comment|/* convert from unicode to UTF-8 */
id|utflen
op_assign
id|utf8_wctomb
c_func
(paren
op_amp
id|result
(braket
id|o
)braket
comma
id|uni
comma
l_int|3
)paren
suffix:semicolon
r_if
c_cond
(paren
id|utflen
op_le
l_int|0
)paren
(brace
r_goto
id|conv_err
suffix:semicolon
)brace
)brace
id|result
(braket
id|o
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
op_star
id|out_len
op_assign
id|o
suffix:semicolon
id|befs_debug
c_func
(paren
id|sb
comma
l_string|&quot;&lt;--- nls2utf()&quot;
)paren
suffix:semicolon
r_return
id|i
suffix:semicolon
id|conv_err
suffix:colon
id|befs_error
c_func
(paren
id|sb
comma
l_string|&quot;Name using charecter set %s contains a charecter that &quot;
l_string|&quot;cannot be converted to unicode.&quot;
comma
id|nls-&gt;charset
)paren
suffix:semicolon
id|befs_debug
c_func
(paren
id|sb
comma
l_string|&quot;&lt;--- nls2utf()&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|result
)paren
suffix:semicolon
r_return
op_minus
id|EILSEQ
suffix:semicolon
)brace
r_static
r_int
DECL|function|parse_options
id|parse_options
c_func
(paren
r_char
op_star
id|options
comma
id|befs_mount_options
op_star
id|opts
)paren
(brace
r_char
op_star
id|this_char
suffix:semicolon
r_char
op_star
id|value
suffix:semicolon
r_int
id|ret
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Initialize options */
id|opts-&gt;uid
op_assign
l_int|0
suffix:semicolon
id|opts-&gt;gid
op_assign
l_int|0
suffix:semicolon
id|opts-&gt;use_uid
op_assign
l_int|0
suffix:semicolon
id|opts-&gt;use_gid
op_assign
l_int|0
suffix:semicolon
id|opts-&gt;iocharset
op_assign
l_int|NULL
suffix:semicolon
id|opts-&gt;debug
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|options
)paren
r_return
id|ret
suffix:semicolon
r_while
c_loop
(paren
(paren
id|this_char
op_assign
id|strsep
c_func
(paren
op_amp
id|options
comma
l_string|&quot;,&quot;
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
(paren
id|value
op_assign
id|strchr
c_func
(paren
id|this_char
comma
l_char|&squot;=&squot;
)paren
)paren
op_ne
l_int|NULL
)paren
op_star
id|value
op_increment
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|this_char
comma
l_string|&quot;uid&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|value
op_logical_or
op_logical_neg
op_star
id|value
)paren
(brace
id|ret
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|opts-&gt;uid
op_assign
id|simple_strtoul
c_func
(paren
id|value
comma
op_amp
id|value
comma
l_int|0
)paren
suffix:semicolon
id|opts-&gt;use_uid
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_star
id|value
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;BEFS: Invalid uid &quot;
l_string|&quot;option: %s&bslash;n&quot;
comma
id|value
)paren
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
)brace
)brace
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|this_char
comma
l_string|&quot;gid&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|value
op_logical_or
op_logical_neg
op_star
id|value
)paren
id|ret
op_assign
l_int|0
suffix:semicolon
r_else
(brace
id|opts-&gt;gid
op_assign
id|simple_strtoul
c_func
(paren
id|value
comma
op_amp
id|value
comma
l_int|0
)paren
suffix:semicolon
id|opts-&gt;use_gid
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_star
id|value
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;BEFS: Invalid gid option: &quot;
l_string|&quot;%s&bslash;n&quot;
comma
id|value
)paren
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
)brace
)brace
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|this_char
comma
l_string|&quot;iocharset&quot;
)paren
op_logical_and
id|value
)paren
(brace
r_char
op_star
id|p
op_assign
id|value
suffix:semicolon
r_int
id|len
suffix:semicolon
r_while
c_loop
(paren
op_star
id|value
op_logical_and
op_star
id|value
op_ne
l_char|&squot;,&squot;
)paren
id|value
op_increment
suffix:semicolon
id|len
op_assign
id|value
op_minus
id|p
suffix:semicolon
r_if
c_cond
(paren
id|len
)paren
(brace
r_char
op_star
id|buffer
op_assign
id|kmalloc
c_func
(paren
id|len
op_plus
l_int|1
comma
id|GFP_NOFS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buffer
)paren
(brace
id|opts-&gt;iocharset
op_assign
id|buffer
suffix:semicolon
id|memcpy
c_func
(paren
id|buffer
comma
id|p
comma
id|len
)paren
suffix:semicolon
id|buffer
(braket
id|len
)braket
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;BEFS: &quot;
l_string|&quot;cannot allocate memory&bslash;n&quot;
)paren
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
)brace
)brace
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|this_char
comma
l_string|&quot;debug&quot;
)paren
)paren
(brace
id|opts-&gt;debug
op_assign
l_int|1
suffix:semicolon
)brace
)brace
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* This function has the responsibiltiy of getting the&n; * filesystem ready for unmounting. &n; * Basicly, we free everything that we allocated in&n; * befs_read_inode&n; */
r_static
r_void
DECL|function|befs_put_super
id|befs_put_super
c_func
(paren
r_struct
id|super_block
op_star
id|sb
)paren
(brace
r_if
c_cond
(paren
id|BEFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|mount_opts.iocharset
)paren
(brace
id|kfree
c_func
(paren
id|BEFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|mount_opts.iocharset
)paren
suffix:semicolon
id|BEFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|mount_opts.iocharset
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|BEFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|nls
)paren
(brace
id|unload_nls
c_func
(paren
id|BEFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|nls
)paren
suffix:semicolon
id|BEFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|nls
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sb-&gt;s_fs_info
)paren
(brace
id|kfree
c_func
(paren
id|sb-&gt;s_fs_info
)paren
suffix:semicolon
id|sb-&gt;s_fs_info
op_assign
l_int|NULL
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
multiline_comment|/* Allocate private field of the superblock, fill it.&n; *&n; * Finish filling the public superblock fields&n; * Make the root directory&n; * Load a set of NLS translations if needed.&n; */
r_static
r_int
DECL|function|befs_fill_super
id|befs_fill_super
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_void
op_star
id|data
comma
r_int
id|silent
)paren
(brace
r_struct
id|buffer_head
op_star
id|bh
suffix:semicolon
id|befs_sb_info
op_star
id|befs_sb
suffix:semicolon
id|befs_super_block
op_star
id|disk_sb
suffix:semicolon
r_const
r_int
r_int
id|sb_block
op_assign
l_int|0
suffix:semicolon
r_const
id|off_t
id|x86_sb_off
op_assign
l_int|512
suffix:semicolon
id|sb-&gt;s_fs_info
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|befs_sb
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sb-&gt;s_fs_info
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;BeFS(%s): Unable to allocate memory for private &quot;
l_string|&quot;portion of superblock. Bailing.&bslash;n&quot;
comma
id|sb-&gt;s_id
)paren
suffix:semicolon
r_goto
id|unaquire_none
suffix:semicolon
)brace
id|befs_sb
op_assign
id|BEFS_SB
c_func
(paren
id|sb
)paren
suffix:semicolon
id|memset
c_func
(paren
id|befs_sb
comma
l_int|0
comma
r_sizeof
(paren
id|befs_sb_info
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|parse_options
c_func
(paren
(paren
r_char
op_star
)paren
id|data
comma
op_amp
id|befs_sb-&gt;mount_opts
)paren
)paren
(brace
id|befs_error
c_func
(paren
id|sb
comma
l_string|&quot;cannot parse mount options&quot;
)paren
suffix:semicolon
r_goto
id|unaquire_priv_sbp
suffix:semicolon
)brace
id|befs_debug
c_func
(paren
id|sb
comma
l_string|&quot;---&gt; befs_fill_super()&quot;
)paren
suffix:semicolon
macro_line|#ifndef CONFIG_BEFS_RW
r_if
c_cond
(paren
op_logical_neg
(paren
id|sb-&gt;s_flags
op_amp
id|MS_RDONLY
)paren
)paren
(brace
id|befs_warning
c_func
(paren
id|sb
comma
l_string|&quot;No write support. Marking filesystem read-only&quot;
)paren
suffix:semicolon
id|sb-&gt;s_flags
op_or_assign
id|MS_RDONLY
suffix:semicolon
)brace
macro_line|#endif&t;&t;&t;&t;/* CONFIG_BEFS_RW */
multiline_comment|/*&n;&t; * Set dummy blocksize to read super block.&n;&t; * Will be set to real fs blocksize later.&n;&t; *&n;&t; * Linux 2.4.10 and later refuse to read blocks smaller than&n;&t; * the hardsect size for the device. But we also need to read at &n;&t; * least 1k to get the second 512 bytes of the volume.&n;&t; * -WD 10-26-01&n;&t; */
id|sb_min_blocksize
c_func
(paren
id|sb
comma
l_int|1024
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|bh
op_assign
id|sb_bread
c_func
(paren
id|sb
comma
id|sb_block
)paren
)paren
)paren
(brace
id|befs_error
c_func
(paren
id|sb
comma
l_string|&quot;unable to read superblock&quot;
)paren
suffix:semicolon
r_goto
id|unaquire_priv_sbp
suffix:semicolon
)brace
multiline_comment|/* account for offset of super block on x86 */
id|disk_sb
op_assign
(paren
id|befs_super_block
op_star
)paren
id|bh-&gt;b_data
suffix:semicolon
r_if
c_cond
(paren
(paren
id|le32_to_cpu
c_func
(paren
id|disk_sb-&gt;magic1
)paren
op_eq
id|BEFS_SUPER_MAGIC1
)paren
op_logical_or
(paren
id|be32_to_cpu
c_func
(paren
id|disk_sb-&gt;magic1
)paren
op_eq
id|BEFS_SUPER_MAGIC1
)paren
)paren
(brace
id|befs_debug
c_func
(paren
id|sb
comma
l_string|&quot;Using PPC superblock location&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|befs_debug
c_func
(paren
id|sb
comma
l_string|&quot;Using x86 superblock location&quot;
)paren
suffix:semicolon
id|disk_sb
op_assign
(paren
id|befs_super_block
op_star
)paren
(paren
(paren
r_void
op_star
)paren
id|bh-&gt;b_data
op_plus
id|x86_sb_off
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|befs_load_sb
c_func
(paren
id|sb
comma
id|disk_sb
)paren
op_ne
id|BEFS_OK
)paren
r_goto
id|unaquire_bh
suffix:semicolon
id|befs_dump_super_block
c_func
(paren
id|sb
comma
id|disk_sb
)paren
suffix:semicolon
id|brelse
c_func
(paren
id|bh
)paren
suffix:semicolon
r_if
c_cond
(paren
id|befs_check_sb
c_func
(paren
id|sb
)paren
op_ne
id|BEFS_OK
)paren
r_goto
id|unaquire_priv_sbp
suffix:semicolon
multiline_comment|/*&n;&t; * set up enough so that it can read an inode&n;&t; * Fill in kernel superblock fields from private sb&n;&t; */
id|sb-&gt;s_magic
op_assign
id|BEFS_SUPER_MAGIC
suffix:semicolon
multiline_comment|/* Set real blocksize of fs */
id|sb_set_blocksize
c_func
(paren
id|sb
comma
(paren
id|ulong
)paren
id|befs_sb-&gt;block_size
)paren
suffix:semicolon
id|sb-&gt;s_op
op_assign
(paren
r_struct
id|super_operations
op_star
)paren
op_amp
id|befs_sops
suffix:semicolon
id|sb-&gt;s_root
op_assign
id|d_alloc_root
c_func
(paren
id|iget
c_func
(paren
id|sb
comma
id|iaddr2blockno
c_func
(paren
id|sb
comma
op_amp
(paren
id|befs_sb-&gt;root_dir
)paren
)paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sb-&gt;s_root
)paren
(brace
id|befs_error
c_func
(paren
id|sb
comma
l_string|&quot;get root inode failed&quot;
)paren
suffix:semicolon
r_goto
id|unaquire_priv_sbp
suffix:semicolon
)brace
multiline_comment|/* load nls library */
r_if
c_cond
(paren
id|befs_sb-&gt;mount_opts.iocharset
)paren
(brace
id|befs_debug
c_func
(paren
id|sb
comma
l_string|&quot;Loading nls: %s&quot;
comma
id|befs_sb-&gt;mount_opts.iocharset
)paren
suffix:semicolon
id|befs_sb-&gt;nls
op_assign
id|load_nls
c_func
(paren
id|befs_sb-&gt;mount_opts.iocharset
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|befs_sb-&gt;nls
)paren
(brace
id|befs_warning
c_func
(paren
id|sb
comma
l_string|&quot;Cannot load nls %s&quot;
l_string|&quot;loding default nls&quot;
comma
id|befs_sb-&gt;mount_opts.iocharset
)paren
suffix:semicolon
id|befs_sb-&gt;nls
op_assign
id|load_nls_default
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
multiline_comment|/*****************/
id|unaquire_bh
suffix:colon
id|brelse
c_func
(paren
id|bh
)paren
suffix:semicolon
id|unaquire_priv_sbp
suffix:colon
id|kfree
c_func
(paren
id|sb-&gt;s_fs_info
)paren
suffix:semicolon
id|unaquire_none
suffix:colon
id|sb-&gt;s_fs_info
op_assign
l_int|NULL
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_static
r_int
DECL|function|befs_remount
id|befs_remount
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_int
op_star
id|flags
comma
r_char
op_star
id|data
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
op_star
id|flags
op_amp
id|MS_RDONLY
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|befs_statfs
id|befs_statfs
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|kstatfs
op_star
id|buf
)paren
(brace
id|befs_debug
c_func
(paren
id|sb
comma
l_string|&quot;---&gt; befs_statfs()&quot;
)paren
suffix:semicolon
id|buf-&gt;f_type
op_assign
id|BEFS_SUPER_MAGIC
suffix:semicolon
id|buf-&gt;f_bsize
op_assign
id|sb-&gt;s_blocksize
suffix:semicolon
id|buf-&gt;f_blocks
op_assign
id|BEFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|num_blocks
suffix:semicolon
id|buf-&gt;f_bfree
op_assign
id|BEFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|num_blocks
op_minus
id|BEFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|used_blocks
suffix:semicolon
id|buf-&gt;f_bavail
op_assign
id|buf-&gt;f_bfree
suffix:semicolon
id|buf-&gt;f_files
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* UNKNOWN */
id|buf-&gt;f_ffree
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* UNKNOWN */
id|buf-&gt;f_namelen
op_assign
id|BEFS_NAME_LEN
suffix:semicolon
id|befs_debug
c_func
(paren
id|sb
comma
l_string|&quot;&lt;--- befs_statfs()&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_struct
id|super_block
op_star
DECL|function|befs_get_sb
id|befs_get_sb
c_func
(paren
r_struct
id|file_system_type
op_star
id|fs_type
comma
r_int
id|flags
comma
r_const
r_char
op_star
id|dev_name
comma
r_void
op_star
id|data
)paren
(brace
r_return
id|get_sb_bdev
c_func
(paren
id|fs_type
comma
id|flags
comma
id|dev_name
comma
id|data
comma
id|befs_fill_super
)paren
suffix:semicolon
)brace
DECL|variable|befs_fs_type
r_static
r_struct
id|file_system_type
id|befs_fs_type
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|name
op_assign
l_string|&quot;befs&quot;
comma
dot
id|get_sb
op_assign
id|befs_get_sb
comma
dot
id|kill_sb
op_assign
id|kill_block_super
comma
dot
id|fs_flags
op_assign
id|FS_REQUIRES_DEV
comma
)brace
suffix:semicolon
r_static
r_int
id|__init
DECL|function|init_befs_fs
id|init_befs_fs
c_func
(paren
r_void
)paren
(brace
r_int
id|err
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;BeFS version: %s&bslash;n&quot;
comma
id|BEFS_VERSION
)paren
suffix:semicolon
id|err
op_assign
id|befs_init_inodecache
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_return
id|err
suffix:semicolon
r_return
id|register_filesystem
c_func
(paren
op_amp
id|befs_fs_type
)paren
suffix:semicolon
)brace
r_static
r_void
id|__exit
DECL|function|exit_befs_fs
id|exit_befs_fs
c_func
(paren
r_void
)paren
(brace
id|befs_destroy_inodecache
c_func
(paren
)paren
suffix:semicolon
id|unregister_filesystem
c_func
(paren
op_amp
id|befs_fs_type
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;Macros that typecheck the init and exit functions,&n;ensures that they are called at init and cleanup,&n;and eliminates warnings about unused functions.&n;*/
id|module_init
c_func
(paren
id|init_befs_fs
)paren
id|module_exit
c_func
(paren
id|exit_befs_fs
)paren
eof
