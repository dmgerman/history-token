multiline_comment|/*&n; * Sysctl operations for Coda filesystem&n; * Original version: (C) 1996 P. Braam and M. Callahan&n; * Rewritten for Linux 2.1. (C) 1997 Carnegie Mellon University&n; * &n; * Carnegie Mellon encourages users to contribute improvements to&n; * the Coda project. Contact Peter Braam (coda@cs.cmu.edu).&n; * &n; * CODA operation statistics&n; * (c) March, 1998 Zhanyong Wan &lt;zhanyong.wan@yale.edu&gt;&n; *&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/time.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/sysctl.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/ctype.h&gt;
macro_line|#include &lt;linux/bitops.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/utsname.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/coda.h&gt;
macro_line|#include &lt;linux/coda_linux.h&gt;
macro_line|#include &lt;linux/coda_fs_i.h&gt;
macro_line|#include &lt;linux/coda_psdev.h&gt;
macro_line|#include &lt;linux/coda_cache.h&gt;
macro_line|#include &lt;linux/coda_proc.h&gt;
DECL|variable|fs_table_header
r_static
r_struct
id|ctl_table_header
op_star
id|fs_table_header
suffix:semicolon
DECL|macro|FS_CODA
mdefine_line|#define FS_CODA         1       /* Coda file system */
DECL|macro|CODA_TIMEOUT
mdefine_line|#define CODA_TIMEOUT    3       /* timeout on upcalls to become intrble */
DECL|macro|CODA_HARD
mdefine_line|#define CODA_HARD       5       /* mount type &quot;hard&quot; or &quot;soft&quot; */
DECL|macro|CODA_VFS
mdefine_line|#define CODA_VFS &t; 6       /* vfs statistics */
DECL|macro|CODA_CACHE_INV
mdefine_line|#define CODA_CACHE_INV &t; 9       /* cache invalidation statistics */
DECL|macro|CODA_FAKE_STATFS
mdefine_line|#define CODA_FAKE_STATFS 10&t; /* don&squot;t query venus for actual cache usage */
DECL|variable|coda_vfs_stat
r_struct
id|coda_vfs_stats
id|coda_vfs_stat
suffix:semicolon
DECL|variable|coda_cache_inv_stat
r_static
r_struct
id|coda_cache_inv_stats
id|coda_cache_inv_stat
suffix:semicolon
DECL|function|reset_coda_vfs_stats
r_static
r_void
id|reset_coda_vfs_stats
c_func
(paren
r_void
)paren
(brace
id|memset
c_func
(paren
op_amp
id|coda_vfs_stat
comma
l_int|0
comma
r_sizeof
(paren
id|coda_vfs_stat
)paren
)paren
suffix:semicolon
)brace
DECL|function|reset_coda_cache_inv_stats
r_static
r_void
id|reset_coda_cache_inv_stats
c_func
(paren
r_void
)paren
(brace
id|memset
c_func
(paren
op_amp
id|coda_cache_inv_stat
comma
l_int|0
comma
r_sizeof
(paren
id|coda_cache_inv_stat
)paren
)paren
suffix:semicolon
)brace
DECL|function|do_reset_coda_vfs_stats
r_static
r_int
id|do_reset_coda_vfs_stats
c_func
(paren
id|ctl_table
op_star
id|table
comma
r_int
id|write
comma
r_struct
id|file
op_star
id|filp
comma
r_void
id|__user
op_star
id|buffer
comma
r_int
op_star
id|lenp
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_if
c_cond
(paren
id|write
)paren
(brace
id|reset_coda_vfs_stats
c_func
(paren
)paren
suffix:semicolon
op_star
id|ppos
op_add_assign
op_star
id|lenp
suffix:semicolon
)brace
r_else
(brace
op_star
id|lenp
op_assign
l_int|0
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|do_reset_coda_cache_inv_stats
r_static
r_int
id|do_reset_coda_cache_inv_stats
c_func
(paren
id|ctl_table
op_star
id|table
comma
r_int
id|write
comma
r_struct
id|file
op_star
id|filp
comma
r_void
id|__user
op_star
id|buffer
comma
r_int
op_star
id|lenp
comma
id|loff_t
op_star
id|ppos
)paren
(brace
r_if
c_cond
(paren
id|write
)paren
(brace
id|reset_coda_cache_inv_stats
c_func
(paren
)paren
suffix:semicolon
op_star
id|ppos
op_add_assign
op_star
id|lenp
suffix:semicolon
)brace
r_else
(brace
op_star
id|lenp
op_assign
l_int|0
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|coda_vfs_stats_get_info
r_static
r_int
id|coda_vfs_stats_get_info
c_func
(paren
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|length
)paren
(brace
r_int
id|len
op_assign
l_int|0
suffix:semicolon
id|off_t
id|begin
suffix:semicolon
r_struct
id|coda_vfs_stats
op_star
id|ps
op_assign
op_amp
id|coda_vfs_stat
suffix:semicolon
multiline_comment|/* this works as long as we are below 1024 characters! */
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
comma
l_string|&quot;Coda VFS statistics&bslash;n&quot;
l_string|&quot;===================&bslash;n&bslash;n&quot;
l_string|&quot;File Operations:&bslash;n&quot;
l_string|&quot;&bslash;topen&bslash;t&bslash;t%9d&bslash;n&quot;
l_string|&quot;&bslash;tflush&bslash;t&bslash;t%9d&bslash;n&quot;
l_string|&quot;&bslash;trelease&bslash;t&bslash;t%9d&bslash;n&quot;
l_string|&quot;&bslash;tfsync&bslash;t&bslash;t%9d&bslash;n&bslash;n&quot;
l_string|&quot;Dir Operations:&bslash;n&quot;
l_string|&quot;&bslash;treaddir&bslash;t&bslash;t%9d&bslash;n&bslash;n&quot;
l_string|&quot;Inode Operations&bslash;n&quot;
l_string|&quot;&bslash;tcreate&bslash;t&bslash;t%9d&bslash;n&quot;
l_string|&quot;&bslash;tlookup&bslash;t&bslash;t%9d&bslash;n&quot;
l_string|&quot;&bslash;tlink&bslash;t&bslash;t%9d&bslash;n&quot;
l_string|&quot;&bslash;tunlink&bslash;t&bslash;t%9d&bslash;n&quot;
l_string|&quot;&bslash;tsymlink&bslash;t&bslash;t%9d&bslash;n&quot;
l_string|&quot;&bslash;tmkdir&bslash;t&bslash;t%9d&bslash;n&quot;
l_string|&quot;&bslash;trmdir&bslash;t&bslash;t%9d&bslash;n&quot;
l_string|&quot;&bslash;trename&bslash;t&bslash;t%9d&bslash;n&quot;
l_string|&quot;&bslash;tpermission&bslash;t%9d&bslash;n&quot;
comma
multiline_comment|/* file operations */
id|ps-&gt;open
comma
id|ps-&gt;flush
comma
id|ps-&gt;release
comma
id|ps-&gt;fsync
comma
multiline_comment|/* dir operations */
id|ps-&gt;readdir
comma
multiline_comment|/* inode operations */
id|ps-&gt;create
comma
id|ps-&gt;lookup
comma
id|ps-&gt;link
comma
id|ps-&gt;unlink
comma
id|ps-&gt;symlink
comma
id|ps-&gt;mkdir
comma
id|ps-&gt;rmdir
comma
id|ps-&gt;rename
comma
id|ps-&gt;permission
)paren
suffix:semicolon
id|begin
op_assign
id|offset
suffix:semicolon
op_star
id|start
op_assign
id|buffer
op_plus
id|begin
suffix:semicolon
id|len
op_sub_assign
id|begin
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|length
)paren
id|len
op_assign
id|length
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
l_int|0
)paren
id|len
op_assign
l_int|0
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
DECL|function|coda_cache_inv_stats_get_info
r_static
r_int
id|coda_cache_inv_stats_get_info
c_func
(paren
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|length
)paren
(brace
r_int
id|len
op_assign
l_int|0
suffix:semicolon
id|off_t
id|begin
suffix:semicolon
r_struct
id|coda_cache_inv_stats
op_star
id|ps
op_assign
op_amp
id|coda_cache_inv_stat
suffix:semicolon
multiline_comment|/* this works as long as we are below 1024 characters! */
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
comma
l_string|&quot;Coda cache invalidation statistics&bslash;n&quot;
l_string|&quot;==================================&bslash;n&bslash;n&quot;
l_string|&quot;flush&bslash;t&bslash;t%9d&bslash;n&quot;
l_string|&quot;purge user&bslash;t%9d&bslash;n&quot;
l_string|&quot;zap_dir&bslash;t&bslash;t%9d&bslash;n&quot;
l_string|&quot;zap_file&bslash;t%9d&bslash;n&quot;
l_string|&quot;zap_vnode&bslash;t%9d&bslash;n&quot;
l_string|&quot;purge_fid&bslash;t%9d&bslash;n&quot;
l_string|&quot;replace&bslash;t&bslash;t%9d&bslash;n&quot;
comma
id|ps-&gt;flush
comma
id|ps-&gt;purge_user
comma
id|ps-&gt;zap_dir
comma
id|ps-&gt;zap_file
comma
id|ps-&gt;zap_vnode
comma
id|ps-&gt;purge_fid
comma
id|ps-&gt;replace
)paren
suffix:semicolon
id|begin
op_assign
id|offset
suffix:semicolon
op_star
id|start
op_assign
id|buffer
op_plus
id|begin
suffix:semicolon
id|len
op_sub_assign
id|begin
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|length
)paren
id|len
op_assign
id|length
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
l_int|0
)paren
id|len
op_assign
l_int|0
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
DECL|variable|coda_table
r_static
id|ctl_table
id|coda_table
(braket
)braket
op_assign
(brace
(brace
id|CODA_TIMEOUT
comma
l_string|&quot;timeout&quot;
comma
op_amp
id|coda_timeout
comma
r_sizeof
(paren
r_int
)paren
comma
l_int|0644
comma
l_int|NULL
comma
op_amp
id|proc_dointvec
)brace
comma
(brace
id|CODA_HARD
comma
l_string|&quot;hard&quot;
comma
op_amp
id|coda_hard
comma
r_sizeof
(paren
r_int
)paren
comma
l_int|0644
comma
l_int|NULL
comma
op_amp
id|proc_dointvec
)brace
comma
(brace
id|CODA_VFS
comma
l_string|&quot;vfs_stats&quot;
comma
l_int|NULL
comma
l_int|0
comma
l_int|0644
comma
l_int|NULL
comma
op_amp
id|do_reset_coda_vfs_stats
)brace
comma
(brace
id|CODA_CACHE_INV
comma
l_string|&quot;cache_inv_stats&quot;
comma
l_int|NULL
comma
l_int|0
comma
l_int|0644
comma
l_int|NULL
comma
op_amp
id|do_reset_coda_cache_inv_stats
)brace
comma
(brace
id|CODA_FAKE_STATFS
comma
l_string|&quot;fake_statfs&quot;
comma
op_amp
id|coda_fake_statfs
comma
r_sizeof
(paren
r_int
)paren
comma
l_int|0600
comma
l_int|NULL
comma
op_amp
id|proc_dointvec
)brace
comma
(brace
l_int|0
)brace
)brace
suffix:semicolon
DECL|variable|fs_table
r_static
id|ctl_table
id|fs_table
(braket
)braket
op_assign
(brace
(brace
id|FS_CODA
comma
l_string|&quot;coda&quot;
comma
l_int|NULL
comma
l_int|0
comma
l_int|0555
comma
id|coda_table
)brace
comma
(brace
l_int|0
)brace
)brace
suffix:semicolon
macro_line|#ifdef CONFIG_PROC_FS
multiline_comment|/*&n; target directory structure:&n;   /proc/fs  (see linux/fs/proc/root.c)&n;   /proc/fs/coda&n;   /proc/fs/coda/{vfs_stats,&n;&n;*/
DECL|variable|proc_fs_coda
r_static
r_struct
id|proc_dir_entry
op_star
id|proc_fs_coda
suffix:semicolon
macro_line|#endif
DECL|macro|coda_proc_create
mdefine_line|#define coda_proc_create(name,get_info) &bslash;&n;&t;create_proc_info_entry(name, 0, proc_fs_coda, get_info)
DECL|function|coda_sysctl_init
r_void
id|coda_sysctl_init
c_func
(paren
r_void
)paren
(brace
id|reset_coda_vfs_stats
c_func
(paren
)paren
suffix:semicolon
id|reset_coda_cache_inv_stats
c_func
(paren
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_PROC_FS
id|proc_fs_coda
op_assign
id|proc_mkdir
c_func
(paren
l_string|&quot;coda&quot;
comma
id|proc_root_fs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|proc_fs_coda
)paren
(brace
id|proc_fs_coda-&gt;owner
op_assign
id|THIS_MODULE
suffix:semicolon
id|coda_proc_create
c_func
(paren
l_string|&quot;vfs_stats&quot;
comma
id|coda_vfs_stats_get_info
)paren
suffix:semicolon
id|coda_proc_create
c_func
(paren
l_string|&quot;cache_inv_stats&quot;
comma
id|coda_cache_inv_stats_get_info
)paren
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifdef CONFIG_SYSCTL
r_if
c_cond
(paren
op_logical_neg
id|fs_table_header
)paren
id|fs_table_header
op_assign
id|register_sysctl_table
c_func
(paren
id|fs_table
comma
l_int|0
)paren
suffix:semicolon
macro_line|#endif 
)brace
DECL|function|coda_sysctl_clean
r_void
id|coda_sysctl_clean
c_func
(paren
r_void
)paren
(brace
macro_line|#ifdef CONFIG_SYSCTL
r_if
c_cond
(paren
id|fs_table_header
)paren
(brace
id|unregister_sysctl_table
c_func
(paren
id|fs_table_header
)paren
suffix:semicolon
id|fs_table_header
op_assign
l_int|NULL
suffix:semicolon
)brace
macro_line|#endif
macro_line|#ifdef CONFIG_PROC_FS
id|remove_proc_entry
c_func
(paren
l_string|&quot;cache_inv_stats&quot;
comma
id|proc_fs_coda
)paren
suffix:semicolon
id|remove_proc_entry
c_func
(paren
l_string|&quot;vfs_stats&quot;
comma
id|proc_fs_coda
)paren
suffix:semicolon
id|remove_proc_entry
c_func
(paren
l_string|&quot;coda&quot;
comma
id|proc_root_fs
)paren
suffix:semicolon
macro_line|#endif 
)brace
eof
