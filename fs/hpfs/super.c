multiline_comment|/*&n; *  linux/fs/hpfs/super.c&n; *&n; *  Mikulas Patocka (mikulas@artax.karlin.mff.cuni.cz), 1998-1999&n; *&n; *  mounting, unmounting, error handling&n; */
macro_line|#include &quot;hpfs_fn.h&quot;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/parser.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/statfs.h&gt;
multiline_comment|/* Mark the filesystem dirty, so that chkdsk checks it when os/2 booted */
DECL|function|mark_dirty
r_static
r_void
id|mark_dirty
c_func
(paren
r_struct
id|super_block
op_star
id|s
)paren
(brace
r_if
c_cond
(paren
id|hpfs_sb
c_func
(paren
id|s
)paren
op_member_access_from_pointer
id|sb_chkdsk
op_logical_and
op_logical_neg
(paren
id|s-&gt;s_flags
op_amp
id|MS_RDONLY
)paren
)paren
(brace
r_struct
id|buffer_head
op_star
id|bh
suffix:semicolon
r_struct
id|hpfs_spare_block
op_star
id|sb
suffix:semicolon
r_if
c_cond
(paren
(paren
id|sb
op_assign
id|hpfs_map_sector
c_func
(paren
id|s
comma
l_int|17
comma
op_amp
id|bh
comma
l_int|0
)paren
)paren
)paren
(brace
id|sb-&gt;dirty
op_assign
l_int|1
suffix:semicolon
id|sb-&gt;old_wrote
op_assign
l_int|0
suffix:semicolon
id|mark_buffer_dirty
c_func
(paren
id|bh
)paren
suffix:semicolon
id|brelse
c_func
(paren
id|bh
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* Mark the filesystem clean (mark it dirty for chkdsk if chkdsk==2 or if there&n;   were errors) */
DECL|function|unmark_dirty
r_static
r_void
id|unmark_dirty
c_func
(paren
r_struct
id|super_block
op_star
id|s
)paren
(brace
r_struct
id|buffer_head
op_star
id|bh
suffix:semicolon
r_struct
id|hpfs_spare_block
op_star
id|sb
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;s_flags
op_amp
id|MS_RDONLY
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
(paren
id|sb
op_assign
id|hpfs_map_sector
c_func
(paren
id|s
comma
l_int|17
comma
op_amp
id|bh
comma
l_int|0
)paren
)paren
)paren
(brace
id|sb-&gt;dirty
op_assign
id|hpfs_sb
c_func
(paren
id|s
)paren
op_member_access_from_pointer
id|sb_chkdsk
OG
l_int|1
op_minus
id|hpfs_sb
c_func
(paren
id|s
)paren
op_member_access_from_pointer
id|sb_was_error
suffix:semicolon
id|sb-&gt;old_wrote
op_assign
id|hpfs_sb
c_func
(paren
id|s
)paren
op_member_access_from_pointer
id|sb_chkdsk
op_ge
l_int|2
op_logical_and
op_logical_neg
id|hpfs_sb
c_func
(paren
id|s
)paren
op_member_access_from_pointer
id|sb_was_error
suffix:semicolon
id|mark_buffer_dirty
c_func
(paren
id|bh
)paren
suffix:semicolon
id|brelse
c_func
(paren
id|bh
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* Filesystem error... */
DECL|macro|ERR_BUF_SIZE
mdefine_line|#define ERR_BUF_SIZE 1024
DECL|function|hpfs_error
r_void
id|hpfs_error
c_func
(paren
r_struct
id|super_block
op_star
id|s
comma
r_char
op_star
id|m
comma
dot
dot
dot
)paren
(brace
r_char
op_star
id|buf
suffix:semicolon
id|va_list
id|l
suffix:semicolon
id|va_start
c_func
(paren
id|l
comma
id|m
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|buf
op_assign
id|kmalloc
c_func
(paren
id|ERR_BUF_SIZE
comma
id|GFP_KERNEL
)paren
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;HPFS: No memory for error message &squot;%s&squot;&bslash;n&quot;
comma
id|m
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|vsprintf
c_func
(paren
id|buf
comma
id|m
comma
id|l
)paren
op_ge
id|ERR_BUF_SIZE
)paren
id|printk
c_func
(paren
l_string|&quot;HPFS: Grrrr... Kernel memory corrupted ... going on, but it&squot;ll crash very soon :-(&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;HPFS: filesystem error: &quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buf
)paren
id|printk
c_func
(paren
l_string|&quot;%s&quot;
comma
id|buf
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
l_string|&quot;%s&bslash;n&quot;
comma
id|m
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hpfs_sb
c_func
(paren
id|s
)paren
op_member_access_from_pointer
id|sb_was_error
)paren
(brace
r_if
c_cond
(paren
id|hpfs_sb
c_func
(paren
id|s
)paren
op_member_access_from_pointer
id|sb_err
op_eq
l_int|2
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;; crashing the system because you wanted it&bslash;n&quot;
)paren
suffix:semicolon
id|mark_dirty
c_func
(paren
id|s
)paren
suffix:semicolon
id|panic
c_func
(paren
l_string|&quot;HPFS panic&quot;
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|hpfs_sb
c_func
(paren
id|s
)paren
op_member_access_from_pointer
id|sb_err
op_eq
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|s-&gt;s_flags
op_amp
id|MS_RDONLY
)paren
id|printk
c_func
(paren
l_string|&quot;; already mounted read-only&bslash;n&quot;
)paren
suffix:semicolon
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;; remounting read-only&bslash;n&quot;
)paren
suffix:semicolon
id|mark_dirty
c_func
(paren
id|s
)paren
suffix:semicolon
id|s-&gt;s_flags
op_or_assign
id|MS_RDONLY
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|s-&gt;s_flags
op_amp
id|MS_RDONLY
)paren
id|printk
c_func
(paren
l_string|&quot;; going on - but anything won&squot;t be destroyed because it&squot;s read-only&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
l_string|&quot;; corrupted filesystem mounted read/write - your computer will explode within 20 seconds ... but you wanted it so!&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buf
)paren
id|kfree
c_func
(paren
id|buf
)paren
suffix:semicolon
id|hpfs_sb
c_func
(paren
id|s
)paren
op_member_access_from_pointer
id|sb_was_error
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* &n; * A little trick to detect cycles in many hpfs structures and don&squot;t let the&n; * kernel crash on corrupted filesystem. When first called, set c2 to 0.&n; *&n; * BTW. chkdsk doesn&squot;t detect cycles correctly. When I had 2 lost directories&n; * nested each in other, chkdsk locked up happilly.&n; */
DECL|function|hpfs_stop_cycles
r_int
id|hpfs_stop_cycles
c_func
(paren
r_struct
id|super_block
op_star
id|s
comma
r_int
id|key
comma
r_int
op_star
id|c1
comma
r_int
op_star
id|c2
comma
r_char
op_star
id|msg
)paren
(brace
r_if
c_cond
(paren
op_star
id|c2
op_logical_and
op_star
id|c1
op_eq
id|key
)paren
(brace
id|hpfs_error
c_func
(paren
id|s
comma
l_string|&quot;cycle detected on key %08x in %s&quot;
comma
id|key
comma
id|msg
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
(paren
op_star
id|c2
)paren
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
(paren
op_star
id|c2
op_minus
l_int|1
)paren
op_amp
op_star
id|c2
)paren
)paren
op_star
id|c1
op_assign
id|key
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|hpfs_put_super
r_static
r_void
id|hpfs_put_super
c_func
(paren
r_struct
id|super_block
op_star
id|s
)paren
(brace
r_struct
id|hpfs_sb_info
op_star
id|sbi
op_assign
id|hpfs_sb
c_func
(paren
id|s
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sbi-&gt;sb_cp_table
)paren
id|kfree
c_func
(paren
id|sbi-&gt;sb_cp_table
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sbi-&gt;sb_bmp_dir
)paren
id|kfree
c_func
(paren
id|sbi-&gt;sb_bmp_dir
)paren
suffix:semicolon
id|unmark_dirty
c_func
(paren
id|s
)paren
suffix:semicolon
id|s-&gt;s_fs_info
op_assign
l_int|NULL
suffix:semicolon
id|kfree
c_func
(paren
id|sbi
)paren
suffix:semicolon
)brace
DECL|function|hpfs_count_one_bitmap
r_int
id|hpfs_count_one_bitmap
c_func
(paren
r_struct
id|super_block
op_star
id|s
comma
id|secno
id|secno
)paren
(brace
r_struct
id|quad_buffer_head
id|qbh
suffix:semicolon
r_int
op_star
id|bits
suffix:semicolon
r_int
id|i
comma
id|count
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|bits
op_assign
id|hpfs_map_4sectors
c_func
(paren
id|s
comma
id|secno
comma
op_amp
id|qbh
comma
l_int|4
)paren
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|count
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|2048
op_div
r_sizeof
(paren
r_int
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_int
id|b
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bits
(braket
id|i
)braket
)paren
r_continue
suffix:semicolon
r_for
c_loop
(paren
id|b
op_assign
id|bits
(braket
id|i
)braket
suffix:semicolon
id|b
suffix:semicolon
id|b
op_rshift_assign
l_int|1
)paren
id|count
op_add_assign
id|b
op_amp
l_int|1
suffix:semicolon
)brace
id|hpfs_brelse4
c_func
(paren
op_amp
id|qbh
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
DECL|function|count_bitmaps
r_static
r_int
id|count_bitmaps
c_func
(paren
r_struct
id|super_block
op_star
id|s
)paren
(brace
r_int
id|n
comma
id|count
comma
id|n_bands
suffix:semicolon
id|n_bands
op_assign
(paren
id|hpfs_sb
c_func
(paren
id|s
)paren
op_member_access_from_pointer
id|sb_fs_size
op_plus
l_int|0x3fff
)paren
op_rshift
l_int|14
suffix:semicolon
id|count
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|n
op_assign
l_int|0
suffix:semicolon
id|n
OL
id|n_bands
suffix:semicolon
id|n
op_increment
)paren
id|count
op_add_assign
id|hpfs_count_one_bitmap
c_func
(paren
id|s
comma
id|hpfs_sb
c_func
(paren
id|s
)paren
op_member_access_from_pointer
id|sb_bmp_dir
(braket
id|n
)braket
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
DECL|function|hpfs_statfs
r_static
r_int
id|hpfs_statfs
c_func
(paren
r_struct
id|super_block
op_star
id|s
comma
r_struct
id|kstatfs
op_star
id|buf
)paren
(brace
r_struct
id|hpfs_sb_info
op_star
id|sbi
op_assign
id|hpfs_sb
c_func
(paren
id|s
)paren
suffix:semicolon
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*if (sbi-&gt;sb_n_free == -1) {*/
id|sbi-&gt;sb_n_free
op_assign
id|count_bitmaps
c_func
(paren
id|s
)paren
suffix:semicolon
id|sbi-&gt;sb_n_free_dnodes
op_assign
id|hpfs_count_one_bitmap
c_func
(paren
id|s
comma
id|sbi-&gt;sb_dmap
)paren
suffix:semicolon
multiline_comment|/*}*/
id|buf-&gt;f_type
op_assign
id|s-&gt;s_magic
suffix:semicolon
id|buf-&gt;f_bsize
op_assign
l_int|512
suffix:semicolon
id|buf-&gt;f_blocks
op_assign
id|sbi-&gt;sb_fs_size
suffix:semicolon
id|buf-&gt;f_bfree
op_assign
id|sbi-&gt;sb_n_free
suffix:semicolon
id|buf-&gt;f_bavail
op_assign
id|sbi-&gt;sb_n_free
suffix:semicolon
id|buf-&gt;f_files
op_assign
id|sbi-&gt;sb_dirband_size
op_div
l_int|4
suffix:semicolon
id|buf-&gt;f_ffree
op_assign
id|sbi-&gt;sb_n_free_dnodes
suffix:semicolon
id|buf-&gt;f_namelen
op_assign
l_int|254
suffix:semicolon
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|hpfs_inode_cachep
r_static
id|kmem_cache_t
op_star
id|hpfs_inode_cachep
suffix:semicolon
DECL|function|hpfs_alloc_inode
r_static
r_struct
id|inode
op_star
id|hpfs_alloc_inode
c_func
(paren
r_struct
id|super_block
op_star
id|sb
)paren
(brace
r_struct
id|hpfs_inode_info
op_star
id|ei
suffix:semicolon
id|ei
op_assign
(paren
r_struct
id|hpfs_inode_info
op_star
)paren
id|kmem_cache_alloc
c_func
(paren
id|hpfs_inode_cachep
comma
id|SLAB_NOFS
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ei
)paren
r_return
l_int|NULL
suffix:semicolon
id|ei-&gt;vfs_inode.i_version
op_assign
l_int|1
suffix:semicolon
r_return
op_amp
id|ei-&gt;vfs_inode
suffix:semicolon
)brace
DECL|function|hpfs_destroy_inode
r_static
r_void
id|hpfs_destroy_inode
c_func
(paren
r_struct
id|inode
op_star
id|inode
)paren
(brace
id|kmem_cache_free
c_func
(paren
id|hpfs_inode_cachep
comma
id|hpfs_i
c_func
(paren
id|inode
)paren
)paren
suffix:semicolon
)brace
DECL|function|init_once
r_static
r_void
id|init_once
c_func
(paren
r_void
op_star
id|foo
comma
id|kmem_cache_t
op_star
id|cachep
comma
r_int
r_int
id|flags
)paren
(brace
r_struct
id|hpfs_inode_info
op_star
id|ei
op_assign
(paren
r_struct
id|hpfs_inode_info
op_star
)paren
id|foo
suffix:semicolon
r_if
c_cond
(paren
(paren
id|flags
op_amp
(paren
id|SLAB_CTOR_VERIFY
op_or
id|SLAB_CTOR_CONSTRUCTOR
)paren
)paren
op_eq
id|SLAB_CTOR_CONSTRUCTOR
)paren
(brace
id|init_MUTEX
c_func
(paren
op_amp
id|ei-&gt;i_sem
)paren
suffix:semicolon
id|init_MUTEX
c_func
(paren
op_amp
id|ei-&gt;i_parent
)paren
suffix:semicolon
id|inode_init_once
c_func
(paren
op_amp
id|ei-&gt;vfs_inode
)paren
suffix:semicolon
)brace
)brace
DECL|function|init_inodecache
r_static
r_int
id|init_inodecache
c_func
(paren
r_void
)paren
(brace
id|hpfs_inode_cachep
op_assign
id|kmem_cache_create
c_func
(paren
l_string|&quot;hpfs_inode_cache&quot;
comma
r_sizeof
(paren
r_struct
id|hpfs_inode_info
)paren
comma
l_int|0
comma
id|SLAB_HWCACHE_ALIGN
op_or
id|SLAB_RECLAIM_ACCOUNT
comma
id|init_once
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|hpfs_inode_cachep
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|destroy_inodecache
r_static
r_void
id|destroy_inodecache
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|kmem_cache_destroy
c_func
(paren
id|hpfs_inode_cachep
)paren
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;hpfs_inode_cache: not all structures were freed&bslash;n&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * A tiny parser for option strings, stolen from dosfs.&n; * Stolen again from read-only hpfs.&n; * And updated for table-driven option parsing.&n; */
r_enum
(brace
DECL|enumerator|Opt_help
DECL|enumerator|Opt_uid
DECL|enumerator|Opt_gid
DECL|enumerator|Opt_umask
DECL|enumerator|Opt_case_lower
DECL|enumerator|Opt_case_asis
id|Opt_help
comma
id|Opt_uid
comma
id|Opt_gid
comma
id|Opt_umask
comma
id|Opt_case_lower
comma
id|Opt_case_asis
comma
DECL|enumerator|Opt_conv_binary
DECL|enumerator|Opt_conv_text
DECL|enumerator|Opt_conv_auto
id|Opt_conv_binary
comma
id|Opt_conv_text
comma
id|Opt_conv_auto
comma
DECL|enumerator|Opt_check_none
DECL|enumerator|Opt_check_normal
DECL|enumerator|Opt_check_strict
id|Opt_check_none
comma
id|Opt_check_normal
comma
id|Opt_check_strict
comma
DECL|enumerator|Opt_err_cont
DECL|enumerator|Opt_err_ro
DECL|enumerator|Opt_err_panic
id|Opt_err_cont
comma
id|Opt_err_ro
comma
id|Opt_err_panic
comma
DECL|enumerator|Opt_eas_no
DECL|enumerator|Opt_eas_ro
DECL|enumerator|Opt_eas_rw
id|Opt_eas_no
comma
id|Opt_eas_ro
comma
id|Opt_eas_rw
comma
DECL|enumerator|Opt_chkdsk_no
DECL|enumerator|Opt_chkdsk_errors
DECL|enumerator|Opt_chkdsk_always
id|Opt_chkdsk_no
comma
id|Opt_chkdsk_errors
comma
id|Opt_chkdsk_always
comma
DECL|enumerator|Opt_timeshift
DECL|enumerator|Opt_err
id|Opt_timeshift
comma
id|Opt_err
comma
)brace
suffix:semicolon
DECL|variable|tokens
r_static
id|match_table_t
id|tokens
op_assign
(brace
(brace
id|Opt_help
comma
l_string|&quot;help&quot;
)brace
comma
(brace
id|Opt_uid
comma
l_string|&quot;uid=%u&quot;
)brace
comma
(brace
id|Opt_gid
comma
l_string|&quot;gid=%u&quot;
)brace
comma
(brace
id|Opt_umask
comma
l_string|&quot;umask=%o&quot;
)brace
comma
(brace
id|Opt_case_lower
comma
l_string|&quot;case=lower&quot;
)brace
comma
(brace
id|Opt_case_asis
comma
l_string|&quot;case=asis&quot;
)brace
comma
(brace
id|Opt_conv_binary
comma
l_string|&quot;conv=binary&quot;
)brace
comma
(brace
id|Opt_conv_text
comma
l_string|&quot;conv=text&quot;
)brace
comma
(brace
id|Opt_conv_auto
comma
l_string|&quot;conv=auto&quot;
)brace
comma
(brace
id|Opt_check_none
comma
l_string|&quot;check=none&quot;
)brace
comma
(brace
id|Opt_check_normal
comma
l_string|&quot;check=normal&quot;
)brace
comma
(brace
id|Opt_check_strict
comma
l_string|&quot;check=strict&quot;
)brace
comma
(brace
id|Opt_err_cont
comma
l_string|&quot;errors=continue&quot;
)brace
comma
(brace
id|Opt_err_ro
comma
l_string|&quot;errors=remount-ro&quot;
)brace
comma
(brace
id|Opt_err_panic
comma
l_string|&quot;errors=panic&quot;
)brace
comma
(brace
id|Opt_eas_no
comma
l_string|&quot;eas=no&quot;
)brace
comma
(brace
id|Opt_eas_ro
comma
l_string|&quot;eas=ro&quot;
)brace
comma
(brace
id|Opt_eas_rw
comma
l_string|&quot;eas=rw&quot;
)brace
comma
(brace
id|Opt_chkdsk_no
comma
l_string|&quot;chkdsk=no&quot;
)brace
comma
(brace
id|Opt_chkdsk_errors
comma
l_string|&quot;chkdsk=errors&quot;
)brace
comma
(brace
id|Opt_chkdsk_always
comma
l_string|&quot;chkdsk=always&quot;
)brace
comma
(brace
id|Opt_timeshift
comma
l_string|&quot;timeshift=%d&quot;
)brace
comma
(brace
id|Opt_err
comma
l_int|NULL
)brace
comma
)brace
suffix:semicolon
DECL|function|parse_opts
r_int
id|parse_opts
c_func
(paren
r_char
op_star
id|opts
comma
id|uid_t
op_star
id|uid
comma
id|gid_t
op_star
id|gid
comma
id|umode_t
op_star
id|umask
comma
r_int
op_star
id|lowercase
comma
r_int
op_star
id|conv
comma
r_int
op_star
id|eas
comma
r_int
op_star
id|chk
comma
r_int
op_star
id|errs
comma
r_int
op_star
id|chkdsk
comma
r_int
op_star
id|timeshift
)paren
(brace
r_char
op_star
id|p
suffix:semicolon
r_int
id|option
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|opts
)paren
r_return
l_int|1
suffix:semicolon
multiline_comment|/*printk(&quot;Parsing opts: &squot;%s&squot;&bslash;n&quot;,opts);*/
r_while
c_loop
(paren
(paren
id|p
op_assign
id|strsep
c_func
(paren
op_amp
id|opts
comma
l_string|&quot;,&quot;
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|substring_t
id|args
(braket
id|MAX_OPT_ARGS
)braket
suffix:semicolon
r_int
id|token
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
op_star
id|p
)paren
r_continue
suffix:semicolon
id|token
op_assign
id|match_token
c_func
(paren
id|p
comma
id|tokens
comma
id|args
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|token
)paren
(brace
r_case
id|Opt_help
suffix:colon
r_return
l_int|2
suffix:semicolon
r_case
id|Opt_uid
suffix:colon
r_if
c_cond
(paren
id|match_int
c_func
(paren
id|args
comma
op_amp
id|option
)paren
)paren
r_return
l_int|0
suffix:semicolon
op_star
id|uid
op_assign
id|option
suffix:semicolon
r_break
suffix:semicolon
r_case
id|Opt_gid
suffix:colon
r_if
c_cond
(paren
id|match_int
c_func
(paren
id|args
comma
op_amp
id|option
)paren
)paren
r_return
l_int|0
suffix:semicolon
op_star
id|gid
op_assign
id|option
suffix:semicolon
r_break
suffix:semicolon
r_case
id|Opt_umask
suffix:colon
r_if
c_cond
(paren
id|match_octal
c_func
(paren
id|args
comma
op_amp
id|option
)paren
)paren
r_return
l_int|0
suffix:semicolon
op_star
id|umask
op_assign
id|option
suffix:semicolon
r_break
suffix:semicolon
r_case
id|Opt_case_lower
suffix:colon
op_star
id|lowercase
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|Opt_case_asis
suffix:colon
op_star
id|lowercase
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|Opt_conv_binary
suffix:colon
op_star
id|conv
op_assign
id|CONV_BINARY
suffix:semicolon
r_break
suffix:semicolon
r_case
id|Opt_conv_text
suffix:colon
op_star
id|conv
op_assign
id|CONV_TEXT
suffix:semicolon
r_break
suffix:semicolon
r_case
id|Opt_conv_auto
suffix:colon
op_star
id|conv
op_assign
id|CONV_AUTO
suffix:semicolon
r_break
suffix:semicolon
r_case
id|Opt_check_none
suffix:colon
op_star
id|chk
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|Opt_check_normal
suffix:colon
op_star
id|chk
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|Opt_check_strict
suffix:colon
op_star
id|chk
op_assign
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_case
id|Opt_err_cont
suffix:colon
op_star
id|errs
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|Opt_err_ro
suffix:colon
op_star
id|errs
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|Opt_err_panic
suffix:colon
op_star
id|errs
op_assign
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_case
id|Opt_eas_no
suffix:colon
op_star
id|eas
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|Opt_eas_ro
suffix:colon
op_star
id|eas
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|Opt_eas_rw
suffix:colon
op_star
id|eas
op_assign
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_case
id|Opt_chkdsk_no
suffix:colon
op_star
id|chkdsk
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|Opt_chkdsk_errors
suffix:colon
op_star
id|chkdsk
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
id|Opt_chkdsk_always
suffix:colon
op_star
id|chkdsk
op_assign
l_int|2
suffix:semicolon
r_break
suffix:semicolon
r_case
id|Opt_timeshift
suffix:colon
(brace
r_int
id|m
op_assign
l_int|1
suffix:semicolon
r_char
op_star
id|rhs
op_assign
id|args
(braket
l_int|0
)braket
dot
id|from
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rhs
op_logical_or
op_logical_neg
op_star
id|rhs
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_star
id|rhs
op_eq
l_char|&squot;-&squot;
)paren
id|m
op_assign
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_star
id|rhs
op_eq
l_char|&squot;+&squot;
op_logical_or
op_star
id|rhs
op_eq
l_char|&squot;-&squot;
)paren
id|rhs
op_increment
suffix:semicolon
op_star
id|timeshift
op_assign
id|simple_strtoul
c_func
(paren
id|rhs
comma
op_amp
id|rhs
comma
l_int|0
)paren
op_star
id|m
suffix:semicolon
r_if
c_cond
(paren
op_star
id|rhs
)paren
r_return
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
r_default
suffix:colon
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|hpfs_help
r_static
r_inline
r_void
id|hpfs_help
c_func
(paren
r_void
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&bslash;&n;HPFS filesystem options:&bslash;n&bslash;&n;      help              do not mount and display this text&bslash;n&bslash;&n;      uid=xxx           set uid of files that don&squot;t have uid specified in eas&bslash;n&bslash;&n;      gid=xxx           set gid of files that don&squot;t have gid specified in eas&bslash;n&bslash;&n;      umask=xxx         set mode of files that don&squot;t have mode specified in eas&bslash;n&bslash;&n;      case=lower        lowercase all files&bslash;n&bslash;&n;      case=asis         do not lowercase files (default)&bslash;n&bslash;&n;      conv=binary       do not convert CR/LF -&gt; LF (default)&bslash;n&bslash;&n;      conv=auto         convert only files with known text extensions&bslash;n&bslash;&n;      conv=text         convert all files&bslash;n&bslash;&n;      check=none        no fs checks - kernel may crash on corrupted filesystem&bslash;n&bslash;&n;      check=normal      do some checks - it should not crash (default)&bslash;n&bslash;&n;      check=strict      do extra time-consuming checks, used for debugging&bslash;n&bslash;&n;      errors=continue   continue on errors&bslash;n&bslash;&n;      errors=remount-ro remount read-only if errors found (default)&bslash;n&bslash;&n;      errors=panic      panic on errors&bslash;n&bslash;&n;      chkdsk=no         do not mark fs for chkdsking even if there were errors&bslash;n&bslash;&n;      chkdsk=errors     mark fs dirty if errors found (default)&bslash;n&bslash;&n;      chkdsk=always     always mark fs dirty - used for debugging&bslash;n&bslash;&n;      eas=no            ignore extended attributes&bslash;n&bslash;&n;      eas=ro            read but do not write extended attributes&bslash;n&bslash;&n;      eas=rw            r/w eas =&gt; enables chmod, chown, mknod, ln -s (default)&bslash;n&bslash;&n;      timeshift=nnn&t;add nnn seconds to file times&bslash;n&bslash;&n;&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|hpfs_remount_fs
r_static
r_int
id|hpfs_remount_fs
c_func
(paren
r_struct
id|super_block
op_star
id|s
comma
r_int
op_star
id|flags
comma
r_char
op_star
id|data
)paren
(brace
id|uid_t
id|uid
suffix:semicolon
id|gid_t
id|gid
suffix:semicolon
id|umode_t
id|umask
suffix:semicolon
r_int
id|lowercase
comma
id|conv
comma
id|eas
comma
id|chk
comma
id|errs
comma
id|chkdsk
comma
id|timeshift
suffix:semicolon
r_int
id|o
suffix:semicolon
r_struct
id|hpfs_sb_info
op_star
id|sbi
op_assign
id|hpfs_sb
c_func
(paren
id|s
)paren
suffix:semicolon
op_star
id|flags
op_or_assign
id|MS_NOATIME
suffix:semicolon
id|uid
op_assign
id|sbi-&gt;sb_uid
suffix:semicolon
id|gid
op_assign
id|sbi-&gt;sb_gid
suffix:semicolon
id|umask
op_assign
l_int|0777
op_amp
op_complement
id|sbi-&gt;sb_mode
suffix:semicolon
id|lowercase
op_assign
id|sbi-&gt;sb_lowercase
suffix:semicolon
id|conv
op_assign
id|sbi-&gt;sb_conv
suffix:semicolon
id|eas
op_assign
id|sbi-&gt;sb_eas
suffix:semicolon
id|chk
op_assign
id|sbi-&gt;sb_chk
suffix:semicolon
id|chkdsk
op_assign
id|sbi-&gt;sb_chkdsk
suffix:semicolon
id|errs
op_assign
id|sbi-&gt;sb_err
suffix:semicolon
id|timeshift
op_assign
id|sbi-&gt;sb_timeshift
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|o
op_assign
id|parse_opts
c_func
(paren
id|data
comma
op_amp
id|uid
comma
op_amp
id|gid
comma
op_amp
id|umask
comma
op_amp
id|lowercase
comma
op_amp
id|conv
comma
op_amp
id|eas
comma
op_amp
id|chk
comma
op_amp
id|errs
comma
op_amp
id|chkdsk
comma
op_amp
id|timeshift
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;HPFS: bad mount options.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|o
op_eq
l_int|2
)paren
(brace
id|hpfs_help
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|timeshift
op_ne
id|sbi-&gt;sb_timeshift
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;HPFS: timeshift can&squot;t be changed using remount.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|unmark_dirty
c_func
(paren
id|s
)paren
suffix:semicolon
id|sbi-&gt;sb_uid
op_assign
id|uid
suffix:semicolon
id|sbi-&gt;sb_gid
op_assign
id|gid
suffix:semicolon
id|sbi-&gt;sb_mode
op_assign
l_int|0777
op_amp
op_complement
id|umask
suffix:semicolon
id|sbi-&gt;sb_lowercase
op_assign
id|lowercase
suffix:semicolon
id|sbi-&gt;sb_conv
op_assign
id|conv
suffix:semicolon
id|sbi-&gt;sb_eas
op_assign
id|eas
suffix:semicolon
id|sbi-&gt;sb_chk
op_assign
id|chk
suffix:semicolon
id|sbi-&gt;sb_chkdsk
op_assign
id|chkdsk
suffix:semicolon
id|sbi-&gt;sb_err
op_assign
id|errs
suffix:semicolon
id|sbi-&gt;sb_timeshift
op_assign
id|timeshift
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
op_star
id|flags
op_amp
id|MS_RDONLY
)paren
)paren
id|mark_dirty
c_func
(paren
id|s
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Super operations */
DECL|variable|hpfs_sops
r_static
r_struct
id|super_operations
id|hpfs_sops
op_assign
(brace
dot
id|alloc_inode
op_assign
id|hpfs_alloc_inode
comma
dot
id|destroy_inode
op_assign
id|hpfs_destroy_inode
comma
dot
id|delete_inode
op_assign
id|hpfs_delete_inode
comma
dot
id|put_super
op_assign
id|hpfs_put_super
comma
dot
id|statfs
op_assign
id|hpfs_statfs
comma
dot
id|remount_fs
op_assign
id|hpfs_remount_fs
comma
)brace
suffix:semicolon
DECL|function|hpfs_fill_super
r_static
r_int
id|hpfs_fill_super
c_func
(paren
r_struct
id|super_block
op_star
id|s
comma
r_void
op_star
id|options
comma
r_int
id|silent
)paren
(brace
r_struct
id|buffer_head
op_star
id|bh0
comma
op_star
id|bh1
comma
op_star
id|bh2
suffix:semicolon
r_struct
id|hpfs_boot_block
op_star
id|bootblock
suffix:semicolon
r_struct
id|hpfs_super_block
op_star
id|superblock
suffix:semicolon
r_struct
id|hpfs_spare_block
op_star
id|spareblock
suffix:semicolon
r_struct
id|hpfs_sb_info
op_star
id|sbi
suffix:semicolon
r_struct
id|inode
op_star
id|root
suffix:semicolon
id|uid_t
id|uid
suffix:semicolon
id|gid_t
id|gid
suffix:semicolon
id|umode_t
id|umask
suffix:semicolon
r_int
id|lowercase
comma
id|conv
comma
id|eas
comma
id|chk
comma
id|errs
comma
id|chkdsk
comma
id|timeshift
suffix:semicolon
id|dnode_secno
id|root_dno
suffix:semicolon
r_struct
id|hpfs_dirent
op_star
id|de
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|quad_buffer_head
id|qbh
suffix:semicolon
r_int
id|o
suffix:semicolon
id|sbi
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|sbi
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sbi
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|s-&gt;s_fs_info
op_assign
id|sbi
suffix:semicolon
id|memset
c_func
(paren
id|sbi
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|sbi
)paren
)paren
suffix:semicolon
id|sbi-&gt;sb_bmp_dir
op_assign
l_int|NULL
suffix:semicolon
id|sbi-&gt;sb_cp_table
op_assign
l_int|NULL
suffix:semicolon
id|init_MUTEX
c_func
(paren
op_amp
id|sbi-&gt;hpfs_creation_de
)paren
suffix:semicolon
id|uid
op_assign
id|current-&gt;uid
suffix:semicolon
id|gid
op_assign
id|current-&gt;gid
suffix:semicolon
id|umask
op_assign
id|current-&gt;fs-&gt;umask
suffix:semicolon
id|lowercase
op_assign
l_int|0
suffix:semicolon
id|conv
op_assign
id|CONV_BINARY
suffix:semicolon
id|eas
op_assign
l_int|2
suffix:semicolon
id|chk
op_assign
l_int|1
suffix:semicolon
id|errs
op_assign
l_int|1
suffix:semicolon
id|chkdsk
op_assign
l_int|1
suffix:semicolon
id|timeshift
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|o
op_assign
id|parse_opts
c_func
(paren
id|options
comma
op_amp
id|uid
comma
op_amp
id|gid
comma
op_amp
id|umask
comma
op_amp
id|lowercase
comma
op_amp
id|conv
comma
op_amp
id|eas
comma
op_amp
id|chk
comma
op_amp
id|errs
comma
op_amp
id|chkdsk
comma
op_amp
id|timeshift
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;HPFS: bad mount options.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|bail0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|o
op_eq
l_int|2
)paren
(brace
id|hpfs_help
c_func
(paren
)paren
suffix:semicolon
r_goto
id|bail0
suffix:semicolon
)brace
multiline_comment|/*sbi-&gt;sb_mounting = 1;*/
id|sb_set_blocksize
c_func
(paren
id|s
comma
l_int|512
)paren
suffix:semicolon
id|sbi-&gt;sb_fs_size
op_assign
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|bootblock
op_assign
id|hpfs_map_sector
c_func
(paren
id|s
comma
l_int|0
comma
op_amp
id|bh0
comma
l_int|0
)paren
)paren
)paren
r_goto
id|bail1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|superblock
op_assign
id|hpfs_map_sector
c_func
(paren
id|s
comma
l_int|16
comma
op_amp
id|bh1
comma
l_int|1
)paren
)paren
)paren
r_goto
id|bail2
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|spareblock
op_assign
id|hpfs_map_sector
c_func
(paren
id|s
comma
l_int|17
comma
op_amp
id|bh2
comma
l_int|0
)paren
)paren
)paren
r_goto
id|bail3
suffix:semicolon
multiline_comment|/* Check magics */
r_if
c_cond
(paren
multiline_comment|/*bootblock-&gt;magic != BB_MAGIC&n;&t;    ||*/
id|superblock-&gt;magic
op_ne
id|SB_MAGIC
op_logical_or
id|spareblock-&gt;magic
op_ne
id|SP_MAGIC
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|silent
)paren
id|printk
c_func
(paren
l_string|&quot;HPFS: Bad magic ... probably not HPFS&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|bail4
suffix:semicolon
)brace
multiline_comment|/* Check version */
r_if
c_cond
(paren
op_logical_neg
(paren
id|s-&gt;s_flags
op_amp
id|MS_RDONLY
)paren
op_logical_and
id|superblock-&gt;funcversion
op_ne
l_int|2
op_logical_and
id|superblock-&gt;funcversion
op_ne
l_int|3
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;HPFS: Bad version %d,%d. Mount readonly to go around&bslash;n&quot;
comma
(paren
r_int
)paren
id|superblock-&gt;version
comma
(paren
r_int
)paren
id|superblock-&gt;funcversion
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;HPFS: please try recent version of HPFS driver at http://artax.karlin.mff.cuni.cz/~mikulas/vyplody/hpfs/index-e.cgi and if it still can&squot;t understand this format, contact author - mikulas@artax.karlin.mff.cuni.cz&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|bail4
suffix:semicolon
)brace
id|s-&gt;s_flags
op_or_assign
id|MS_NOATIME
suffix:semicolon
multiline_comment|/* Fill superblock stuff */
id|s-&gt;s_magic
op_assign
id|HPFS_SUPER_MAGIC
suffix:semicolon
id|s-&gt;s_op
op_assign
op_amp
id|hpfs_sops
suffix:semicolon
id|sbi-&gt;sb_root
op_assign
id|superblock-&gt;root
suffix:semicolon
id|sbi-&gt;sb_fs_size
op_assign
id|superblock-&gt;n_sectors
suffix:semicolon
id|sbi-&gt;sb_bitmaps
op_assign
id|superblock-&gt;bitmaps
suffix:semicolon
id|sbi-&gt;sb_dirband_start
op_assign
id|superblock-&gt;dir_band_start
suffix:semicolon
id|sbi-&gt;sb_dirband_size
op_assign
id|superblock-&gt;n_dir_band
suffix:semicolon
id|sbi-&gt;sb_dmap
op_assign
id|superblock-&gt;dir_band_bitmap
suffix:semicolon
id|sbi-&gt;sb_uid
op_assign
id|uid
suffix:semicolon
id|sbi-&gt;sb_gid
op_assign
id|gid
suffix:semicolon
id|sbi-&gt;sb_mode
op_assign
l_int|0777
op_amp
op_complement
id|umask
suffix:semicolon
id|sbi-&gt;sb_n_free
op_assign
op_minus
l_int|1
suffix:semicolon
id|sbi-&gt;sb_n_free_dnodes
op_assign
op_minus
l_int|1
suffix:semicolon
id|sbi-&gt;sb_lowercase
op_assign
id|lowercase
suffix:semicolon
id|sbi-&gt;sb_conv
op_assign
id|conv
suffix:semicolon
id|sbi-&gt;sb_eas
op_assign
id|eas
suffix:semicolon
id|sbi-&gt;sb_chk
op_assign
id|chk
suffix:semicolon
id|sbi-&gt;sb_chkdsk
op_assign
id|chkdsk
suffix:semicolon
id|sbi-&gt;sb_err
op_assign
id|errs
suffix:semicolon
id|sbi-&gt;sb_timeshift
op_assign
id|timeshift
suffix:semicolon
id|sbi-&gt;sb_was_error
op_assign
l_int|0
suffix:semicolon
id|sbi-&gt;sb_cp_table
op_assign
l_int|NULL
suffix:semicolon
id|sbi-&gt;sb_c_bitmap
op_assign
op_minus
l_int|1
suffix:semicolon
id|sbi-&gt;sb_max_fwd_alloc
op_assign
l_int|0xffffff
suffix:semicolon
multiline_comment|/* Load bitmap directory */
r_if
c_cond
(paren
op_logical_neg
(paren
id|sbi-&gt;sb_bmp_dir
op_assign
id|hpfs_load_bitmap_directory
c_func
(paren
id|s
comma
id|superblock-&gt;bitmaps
)paren
)paren
)paren
r_goto
id|bail4
suffix:semicolon
multiline_comment|/* Check for general fs errors*/
r_if
c_cond
(paren
id|spareblock-&gt;dirty
op_logical_and
op_logical_neg
id|spareblock-&gt;old_wrote
)paren
(brace
r_if
c_cond
(paren
id|errs
op_eq
l_int|2
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;HPFS: Improperly stopped, not mounted&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|bail4
suffix:semicolon
)brace
id|hpfs_error
c_func
(paren
id|s
comma
l_string|&quot;improperly stopped&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|s-&gt;s_flags
op_amp
id|MS_RDONLY
)paren
)paren
(brace
id|spareblock-&gt;dirty
op_assign
l_int|1
suffix:semicolon
id|spareblock-&gt;old_wrote
op_assign
l_int|0
suffix:semicolon
id|mark_buffer_dirty
c_func
(paren
id|bh2
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|spareblock-&gt;hotfixes_used
op_logical_or
id|spareblock-&gt;n_spares_used
)paren
(brace
r_if
c_cond
(paren
id|errs
op_ge
l_int|2
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;HPFS: Hotfixes not supported here, try chkdsk&bslash;n&quot;
)paren
suffix:semicolon
id|mark_dirty
c_func
(paren
id|s
)paren
suffix:semicolon
r_goto
id|bail4
suffix:semicolon
)brace
id|hpfs_error
c_func
(paren
id|s
comma
l_string|&quot;hotfixes not supported here, try chkdsk&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|errs
op_eq
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;HPFS: Proceeding, but your filesystem will be probably corrupted by this driver...&bslash;n&quot;
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
l_string|&quot;HPFS: This driver may read bad files or crash when operating on disk with hotfixes.&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|spareblock-&gt;n_dnode_spares
op_ne
id|spareblock-&gt;n_dnode_spares_free
)paren
(brace
r_if
c_cond
(paren
id|errs
op_ge
l_int|2
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;HPFS: Spare dnodes used, try chkdsk&bslash;n&quot;
)paren
suffix:semicolon
id|mark_dirty
c_func
(paren
id|s
)paren
suffix:semicolon
r_goto
id|bail4
suffix:semicolon
)brace
id|hpfs_error
c_func
(paren
id|s
comma
l_string|&quot;warning: spare dnodes used, try chkdsk&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|errs
op_eq
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;HPFS: Proceeding, but your filesystem could be corrupted if you delete files or directories&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|chk
)paren
(brace
r_int
id|a
suffix:semicolon
r_if
c_cond
(paren
id|superblock-&gt;dir_band_end
op_minus
id|superblock-&gt;dir_band_start
op_plus
l_int|1
op_ne
id|superblock-&gt;n_dir_band
op_logical_or
id|superblock-&gt;dir_band_end
template_param
l_int|0x4000
)paren
(brace
id|hpfs_error
c_func
(paren
id|s
comma
l_string|&quot;dir band size mismatch: dir_band_start==%08x, dir_band_end==%08x, n_dir_band==%08x&quot;
comma
id|superblock-&gt;dir_band_start
comma
id|superblock-&gt;dir_band_end
comma
id|superblock-&gt;n_dir_band
)paren
suffix:semicolon
r_goto
id|bail4
suffix:semicolon
)brace
id|a
op_assign
id|sbi-&gt;sb_dirband_size
suffix:semicolon
id|sbi-&gt;sb_dirband_size
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|hpfs_chk_sectors
c_func
(paren
id|s
comma
id|superblock-&gt;dir_band_start
comma
id|superblock-&gt;n_dir_band
comma
l_string|&quot;dir_band&quot;
)paren
op_logical_or
id|hpfs_chk_sectors
c_func
(paren
id|s
comma
id|superblock-&gt;dir_band_bitmap
comma
l_int|4
comma
l_string|&quot;dir_band_bitmap&quot;
)paren
op_logical_or
id|hpfs_chk_sectors
c_func
(paren
id|s
comma
id|superblock-&gt;bitmaps
comma
l_int|4
comma
l_string|&quot;bitmaps&quot;
)paren
)paren
(brace
id|mark_dirty
c_func
(paren
id|s
)paren
suffix:semicolon
r_goto
id|bail4
suffix:semicolon
)brace
id|sbi-&gt;sb_dirband_size
op_assign
id|a
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;HPFS: You really don&squot;t want any checks? You are crazy...&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Load code page table */
r_if
c_cond
(paren
id|spareblock-&gt;n_code_pages
)paren
r_if
c_cond
(paren
op_logical_neg
(paren
id|sbi-&gt;sb_cp_table
op_assign
id|hpfs_load_code_page
c_func
(paren
id|s
comma
id|spareblock-&gt;code_page_dir
)paren
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;HPFS: Warning: code page support is disabled&bslash;n&quot;
)paren
suffix:semicolon
id|brelse
c_func
(paren
id|bh2
)paren
suffix:semicolon
id|brelse
c_func
(paren
id|bh1
)paren
suffix:semicolon
id|brelse
c_func
(paren
id|bh0
)paren
suffix:semicolon
id|root
op_assign
id|iget_locked
c_func
(paren
id|s
comma
id|sbi-&gt;sb_root
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|root
)paren
r_goto
id|bail0
suffix:semicolon
id|hpfs_init_inode
c_func
(paren
id|root
)paren
suffix:semicolon
id|hpfs_read_inode
c_func
(paren
id|root
)paren
suffix:semicolon
id|unlock_new_inode
c_func
(paren
id|root
)paren
suffix:semicolon
id|s-&gt;s_root
op_assign
id|d_alloc_root
c_func
(paren
id|root
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|s-&gt;s_root
)paren
(brace
id|iput
c_func
(paren
id|root
)paren
suffix:semicolon
r_goto
id|bail0
suffix:semicolon
)brace
id|hpfs_set_dentry_operations
c_func
(paren
id|s-&gt;s_root
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * find the root directory&squot;s . pointer &amp; finish filling in the inode&n;&t; */
id|root_dno
op_assign
id|hpfs_fnode_dno
c_func
(paren
id|s
comma
id|sbi-&gt;sb_root
)paren
suffix:semicolon
r_if
c_cond
(paren
id|root_dno
)paren
id|de
op_assign
id|map_dirent
c_func
(paren
id|root
comma
id|root_dno
comma
l_string|&quot;&bslash;001&bslash;001&quot;
comma
l_int|2
comma
l_int|NULL
comma
op_amp
id|qbh
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|de
)paren
id|hpfs_error
c_func
(paren
id|s
comma
l_string|&quot;unable to find root dir&quot;
)paren
suffix:semicolon
r_else
(brace
id|root-&gt;i_atime.tv_sec
op_assign
id|local_to_gmt
c_func
(paren
id|s
comma
id|de-&gt;read_date
)paren
suffix:semicolon
id|root-&gt;i_atime.tv_nsec
op_assign
l_int|0
suffix:semicolon
id|root-&gt;i_mtime.tv_sec
op_assign
id|local_to_gmt
c_func
(paren
id|s
comma
id|de-&gt;write_date
)paren
suffix:semicolon
id|root-&gt;i_mtime.tv_nsec
op_assign
l_int|0
suffix:semicolon
id|root-&gt;i_ctime.tv_sec
op_assign
id|local_to_gmt
c_func
(paren
id|s
comma
id|de-&gt;creation_date
)paren
suffix:semicolon
id|root-&gt;i_ctime.tv_nsec
op_assign
l_int|0
suffix:semicolon
id|hpfs_i
c_func
(paren
id|root
)paren
op_member_access_from_pointer
id|i_ea_size
op_assign
id|de-&gt;ea_size
suffix:semicolon
id|hpfs_i
c_func
(paren
id|root
)paren
op_member_access_from_pointer
id|i_parent_dir
op_assign
id|root-&gt;i_ino
suffix:semicolon
r_if
c_cond
(paren
id|root-&gt;i_size
op_eq
op_minus
l_int|1
)paren
id|root-&gt;i_size
op_assign
l_int|2048
suffix:semicolon
r_if
c_cond
(paren
id|root-&gt;i_blocks
op_eq
op_minus
l_int|1
)paren
id|root-&gt;i_blocks
op_assign
l_int|5
suffix:semicolon
id|hpfs_brelse4
c_func
(paren
op_amp
id|qbh
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
id|bail4
suffix:colon
id|brelse
c_func
(paren
id|bh2
)paren
suffix:semicolon
id|bail3
suffix:colon
id|brelse
c_func
(paren
id|bh1
)paren
suffix:semicolon
id|bail2
suffix:colon
id|brelse
c_func
(paren
id|bh0
)paren
suffix:semicolon
id|bail1
suffix:colon
id|bail0
suffix:colon
r_if
c_cond
(paren
id|sbi-&gt;sb_bmp_dir
)paren
id|kfree
c_func
(paren
id|sbi-&gt;sb_bmp_dir
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sbi-&gt;sb_cp_table
)paren
id|kfree
c_func
(paren
id|sbi-&gt;sb_cp_table
)paren
suffix:semicolon
id|s-&gt;s_fs_info
op_assign
l_int|NULL
suffix:semicolon
id|kfree
c_func
(paren
id|sbi
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|hpfs_get_sb
r_static
r_struct
id|super_block
op_star
id|hpfs_get_sb
c_func
(paren
r_struct
id|file_system_type
op_star
id|fs_type
comma
r_int
id|flags
comma
r_const
r_char
op_star
id|dev_name
comma
r_void
op_star
id|data
)paren
(brace
r_return
id|get_sb_bdev
c_func
(paren
id|fs_type
comma
id|flags
comma
id|dev_name
comma
id|data
comma
id|hpfs_fill_super
)paren
suffix:semicolon
)brace
DECL|variable|hpfs_fs_type
r_static
r_struct
id|file_system_type
id|hpfs_fs_type
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|name
op_assign
l_string|&quot;hpfs&quot;
comma
dot
id|get_sb
op_assign
id|hpfs_get_sb
comma
dot
id|kill_sb
op_assign
id|kill_block_super
comma
dot
id|fs_flags
op_assign
id|FS_REQUIRES_DEV
comma
)brace
suffix:semicolon
DECL|function|init_hpfs_fs
r_static
r_int
id|__init
id|init_hpfs_fs
c_func
(paren
r_void
)paren
(brace
r_int
id|err
op_assign
id|init_inodecache
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|out1
suffix:semicolon
id|err
op_assign
id|register_filesystem
c_func
(paren
op_amp
id|hpfs_fs_type
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|out
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|out
suffix:colon
id|destroy_inodecache
c_func
(paren
)paren
suffix:semicolon
id|out1
suffix:colon
r_return
id|err
suffix:semicolon
)brace
DECL|function|exit_hpfs_fs
r_static
r_void
id|__exit
id|exit_hpfs_fs
c_func
(paren
r_void
)paren
(brace
id|unregister_filesystem
c_func
(paren
op_amp
id|hpfs_fs_type
)paren
suffix:semicolon
id|destroy_inodecache
c_func
(paren
)paren
suffix:semicolon
)brace
id|module_init
c_func
(paren
id|init_hpfs_fs
)paren
id|module_exit
c_func
(paren
id|exit_hpfs_fs
)paren
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
eof
