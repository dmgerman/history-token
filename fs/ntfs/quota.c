multiline_comment|/*&n; * quota.c - NTFS kernel quota ($Quota) handling.  Part of the Linux-NTFS&n; *&t;     project.&n; *&n; * Copyright (c) 2004 Anton Altaparmakov&n; *&n; * This program/include file is free software; you can redistribute it and/or&n; * modify it under the terms of the GNU General Public License as published&n; * by the Free Software Foundation; either version 2 of the License, or&n; * (at your option) any later version.&n; *&n; * This program/include file is distributed in the hope that it will be&n; * useful, but WITHOUT ANY WARRANTY; without even the implied warranty&n; * of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; * GNU General Public License for more details.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program (in the main directory of the Linux-NTFS&n; * distribution in the file COPYING); if not, write to the Free Software&n; * Foundation,Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA&n; */
macro_line|#ifdef NTFS_RW
macro_line|#include &quot;ntfs.h&quot;
macro_line|#include &quot;index.h&quot;
macro_line|#include &quot;quota.h&quot;
multiline_comment|/**&n; * ntfs_mark_quotas_out_of_date - mark the quotas out of date on an ntfs volume&n; * @vol:&t;ntfs volume on which to mark the quotas out of date&n; *&n; * Mark the quotas out of date on the ntfs volume @vol and return TRUE on&n; * success and FALSE on error.&n; */
DECL|function|ntfs_mark_quotas_out_of_date
id|BOOL
id|ntfs_mark_quotas_out_of_date
c_func
(paren
id|ntfs_volume
op_star
id|vol
)paren
(brace
id|ntfs_index_context
op_star
id|ictx
suffix:semicolon
id|QUOTA_CONTROL_ENTRY
op_star
id|qce
suffix:semicolon
r_const
id|le32
id|qid
op_assign
id|QUOTA_DEFAULTS_ID
suffix:semicolon
r_int
id|err
suffix:semicolon
id|ntfs_debug
c_func
(paren
l_string|&quot;Entering.&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|NVolQuotaOutOfDate
c_func
(paren
id|vol
)paren
)paren
r_goto
id|done
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|vol-&gt;quota_ino
op_logical_or
op_logical_neg
id|vol-&gt;quota_q_ino
)paren
(brace
id|ntfs_error
c_func
(paren
id|vol-&gt;sb
comma
l_string|&quot;Quota inodes are not open.&quot;
)paren
suffix:semicolon
r_return
id|FALSE
suffix:semicolon
)brace
id|down
c_func
(paren
op_amp
id|vol-&gt;quota_q_ino-&gt;i_sem
)paren
suffix:semicolon
id|ictx
op_assign
id|ntfs_index_ctx_get
c_func
(paren
id|NTFS_I
c_func
(paren
id|vol-&gt;quota_q_ino
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ictx
)paren
(brace
id|ntfs_error
c_func
(paren
id|vol-&gt;sb
comma
l_string|&quot;Failed to get index context.&quot;
)paren
suffix:semicolon
r_return
id|FALSE
suffix:semicolon
)brace
id|err
op_assign
id|ntfs_index_lookup
c_func
(paren
op_amp
id|qid
comma
r_sizeof
(paren
id|qid
)paren
comma
id|ictx
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
r_if
c_cond
(paren
id|err
op_eq
op_minus
id|ENOENT
)paren
id|ntfs_error
c_func
(paren
id|vol-&gt;sb
comma
l_string|&quot;Quota defaults entry is not &quot;
l_string|&quot;present.&quot;
)paren
suffix:semicolon
r_else
id|ntfs_error
c_func
(paren
id|vol-&gt;sb
comma
l_string|&quot;Lookup of quota defaults entry &quot;
l_string|&quot;failed.&quot;
)paren
suffix:semicolon
r_goto
id|err_out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ictx-&gt;data_len
OL
m_offsetof
(paren
id|QUOTA_CONTROL_ENTRY
comma
id|sid
)paren
)paren
(brace
id|ntfs_error
c_func
(paren
id|vol-&gt;sb
comma
l_string|&quot;Quota defaults entry size is invalid.  &quot;
l_string|&quot;Run chkdsk.&quot;
)paren
suffix:semicolon
r_goto
id|err_out
suffix:semicolon
)brace
id|qce
op_assign
(paren
id|QUOTA_CONTROL_ENTRY
op_star
)paren
id|ictx-&gt;data
suffix:semicolon
r_if
c_cond
(paren
id|le32_to_cpu
c_func
(paren
id|qce-&gt;version
)paren
op_ne
id|QUOTA_VERSION
)paren
(brace
id|ntfs_error
c_func
(paren
id|vol-&gt;sb
comma
l_string|&quot;Quota defaults entry version 0x%x is not &quot;
l_string|&quot;supported.&quot;
comma
id|le32_to_cpu
c_func
(paren
id|qce-&gt;version
)paren
)paren
suffix:semicolon
r_goto
id|err_out
suffix:semicolon
)brace
id|ntfs_debug
c_func
(paren
l_string|&quot;Quota defaults flags = 0x%x.&quot;
comma
id|le32_to_cpu
c_func
(paren
id|qce-&gt;flags
)paren
)paren
suffix:semicolon
multiline_comment|/* If quotas are already marked out of date, no need to do anything. */
r_if
c_cond
(paren
id|qce-&gt;flags
op_amp
id|QUOTA_FLAG_OUT_OF_DATE
)paren
r_goto
id|set_done
suffix:semicolon
multiline_comment|/*&n;&t; * If quota tracking is neither requested, nor enabled and there are no&n;&t; * pending deletes, no need to mark the quotas out of date.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|qce-&gt;flags
op_amp
(paren
id|QUOTA_FLAG_TRACKING_ENABLED
op_or
id|QUOTA_FLAG_TRACKING_REQUESTED
op_or
id|QUOTA_FLAG_PENDING_DELETES
)paren
)paren
)paren
r_goto
id|set_done
suffix:semicolon
multiline_comment|/*&n;&t; * Set the QUOTA_FLAG_OUT_OF_DATE bit thus marking quotas out of date.&n;&t; * This is verified on WinXP to be sufficient to cause windows to&n;&t; * rescan the volume on boot and update all quota entries.&n;&t; */
id|qce-&gt;flags
op_or_assign
id|QUOTA_FLAG_OUT_OF_DATE
suffix:semicolon
multiline_comment|/* Ensure the modified flags are written to disk. */
id|ntfs_index_entry_flush_dcache_page
c_func
(paren
id|ictx
)paren
suffix:semicolon
id|ntfs_index_entry_mark_dirty
c_func
(paren
id|ictx
)paren
suffix:semicolon
id|set_done
suffix:colon
id|ntfs_index_ctx_put
c_func
(paren
id|ictx
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|vol-&gt;quota_q_ino-&gt;i_sem
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * We set the flag so we do not try to mark the quotas out of date&n;&t; * again on remount.&n;&t; */
id|NVolSetQuotaOutOfDate
c_func
(paren
id|vol
)paren
suffix:semicolon
id|done
suffix:colon
id|ntfs_debug
c_func
(paren
l_string|&quot;Done.&quot;
)paren
suffix:semicolon
r_return
id|TRUE
suffix:semicolon
id|err_out
suffix:colon
id|ntfs_index_ctx_put
c_func
(paren
id|ictx
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|vol-&gt;quota_q_ino-&gt;i_sem
)paren
suffix:semicolon
r_return
id|FALSE
suffix:semicolon
)brace
macro_line|#endif /* NTFS_RW */
eof
