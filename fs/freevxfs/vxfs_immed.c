multiline_comment|/*&n; * Copyright (c) 2000-2001 Christoph Hellwig.&n; * All rights reserved.&n; *&n; * Redistribution and use in source and binary forms, with or without&n; * modification, are permitted provided that the following conditions&n; * are met:&n; * 1. Redistributions of source code must retain the above copyright&n; *    notice, this list of conditions, and the following disclaimer,&n; *    without modification.&n; * 2. The name of the author may not be used to endorse or promote products&n; *    derived from this software without specific prior written permission.&n; *&n; * Alternatively, this software may be distributed under the terms of the&n; * GNU General Public License (&quot;GPL&quot;).&n; *&n; * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS&squot;&squot; AND&n; * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE&n; * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE&n; * ARE DISCLAIMED. IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE FOR&n; * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL&n; * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS&n; * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)&n; * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT&n; * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY&n; * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF&n; * SUCH DAMAGE.&n; */
macro_line|#ident &quot;$Id: vxfs_immed.c,v 1.10 2001/04/25 18:11:23 hch Exp hch $&quot;
multiline_comment|/*&n; * Veritas filesystem driver - support for &squot;immed&squot; inodes.&n; */
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/pagemap.h&gt;
macro_line|#include &quot;vxfs.h&quot;
macro_line|#include &quot;vxfs_inode.h&quot;
r_static
r_int
id|vxfs_immed_readlink
c_func
(paren
r_struct
id|dentry
op_star
comma
r_char
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_int
id|vxfs_immed_follow_link
c_func
(paren
r_struct
id|dentry
op_star
comma
r_struct
id|nameidata
op_star
)paren
suffix:semicolon
r_static
r_int
id|vxfs_immed_readpage
c_func
(paren
r_struct
id|file
op_star
comma
r_struct
id|page
op_star
)paren
suffix:semicolon
multiline_comment|/*&n; * Inode operations for immed symlinks.&n; *&n; * Unliked all other operations we do not go through the pagecache,&n; * but do all work directly on the inode.&n; */
DECL|variable|vxfs_immed_symlink_iops
r_struct
id|inode_operations
id|vxfs_immed_symlink_iops
op_assign
(brace
dot
id|readlink
op_assign
id|vxfs_immed_readlink
comma
dot
id|follow_link
op_assign
id|vxfs_immed_follow_link
comma
)brace
suffix:semicolon
multiline_comment|/*&n; * Adress space operations for immed files and directories.&n; */
DECL|variable|vxfs_immed_aops
r_struct
id|address_space_operations
id|vxfs_immed_aops
op_assign
(brace
dot
id|readpage
op_assign
id|vxfs_immed_readpage
comma
)brace
suffix:semicolon
multiline_comment|/**&n; * vxfs_immed_readlink - read immed symlink&n; * @dp:&t;&t;dentry for the link&n; * @bp:&t;&t;output buffer&n; * @buflen:&t;length of @bp&n; *&n; * Description:&n; *   vxfs_immed_readlink calls vfs_readlink to read the link&n; *   described by @dp into userspace.&n; *&n; * Returns:&n; *   Number of bytes successfully copied to userspace.&n; */
r_static
r_int
DECL|function|vxfs_immed_readlink
id|vxfs_immed_readlink
c_func
(paren
r_struct
id|dentry
op_star
id|dp
comma
r_char
op_star
id|bp
comma
r_int
id|buflen
)paren
(brace
r_struct
id|vxfs_inode_info
op_star
id|vip
op_assign
id|VXFS_INO
c_func
(paren
id|dp-&gt;d_inode
)paren
suffix:semicolon
r_return
(paren
id|vfs_readlink
c_func
(paren
id|dp
comma
id|bp
comma
id|buflen
comma
id|vip-&gt;vii_immed.vi_immed
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * vxfs_immed_follow_link - follow immed symlink&n; * @dp:&t;&t;dentry for the link&n; * @np:&t;&t;pathname lookup data for the current path walk&n; *&n; * Description:&n; *   vxfs_immed_follow_link restarts the pathname lookup with&n; *   the data obtained from @dp.&n; *&n; * Returns:&n; *   Zero on success, else a negative error code.&n; */
r_static
r_int
DECL|function|vxfs_immed_follow_link
id|vxfs_immed_follow_link
c_func
(paren
r_struct
id|dentry
op_star
id|dp
comma
r_struct
id|nameidata
op_star
id|np
)paren
(brace
r_struct
id|vxfs_inode_info
op_star
id|vip
op_assign
id|VXFS_INO
c_func
(paren
id|dp-&gt;d_inode
)paren
suffix:semicolon
r_return
(paren
id|vfs_follow_link
c_func
(paren
id|np
comma
id|vip-&gt;vii_immed.vi_immed
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/**&n; * vxfs_immed_readpage - read part of an immed inode into pagecache&n; * @file:&t;file context (unused)&n; * @page:&t;page frame to fill in.&n; *&n; * Description:&n; *   vxfs_immed_readpage reads a part of the immed area of the&n; *   file that hosts @pp into the pagecache.&n; *&n; * Returns:&n; *   Zero on success, else a negative error code.&n; *&n; * Locking status:&n; *   @page is locked and will be unlocked.&n; */
r_static
r_int
DECL|function|vxfs_immed_readpage
id|vxfs_immed_readpage
c_func
(paren
r_struct
id|file
op_star
id|fp
comma
r_struct
id|page
op_star
id|pp
)paren
(brace
r_struct
id|vxfs_inode_info
op_star
id|vip
op_assign
id|VXFS_INO
c_func
(paren
id|pp-&gt;mapping-&gt;host
)paren
suffix:semicolon
id|u_int64_t
id|offset
op_assign
id|pp-&gt;index
op_lshift
id|PAGE_CACHE_SHIFT
suffix:semicolon
id|caddr_t
id|kaddr
suffix:semicolon
id|kaddr
op_assign
id|kmap
c_func
(paren
id|pp
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|kaddr
comma
id|vip-&gt;vii_immed.vi_immed
op_plus
id|offset
comma
id|PAGE_CACHE_SIZE
)paren
suffix:semicolon
id|kunmap
c_func
(paren
id|pp
)paren
suffix:semicolon
id|flush_dcache_page
c_func
(paren
id|pp
)paren
suffix:semicolon
id|SetPageUptodate
c_func
(paren
id|pp
)paren
suffix:semicolon
id|UnlockPage
c_func
(paren
id|pp
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
eof
