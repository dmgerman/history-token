macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/quota.h&gt;
macro_line|#include &lt;linux/dqblk_v1.h&gt;
macro_line|#include &lt;linux/quotaio_v1.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/byteorder.h&gt;
DECL|function|v1_disk2mem_dqblk
r_static
r_void
id|v1_disk2mem_dqblk
c_func
(paren
r_struct
id|mem_dqblk
op_star
id|m
comma
r_struct
id|v1_disk_dqblk
op_star
id|d
)paren
(brace
id|m-&gt;dqb_ihardlimit
op_assign
id|d-&gt;dqb_ihardlimit
suffix:semicolon
id|m-&gt;dqb_isoftlimit
op_assign
id|d-&gt;dqb_isoftlimit
suffix:semicolon
id|m-&gt;dqb_curinodes
op_assign
id|d-&gt;dqb_curinodes
suffix:semicolon
id|m-&gt;dqb_bhardlimit
op_assign
id|d-&gt;dqb_bhardlimit
suffix:semicolon
id|m-&gt;dqb_bsoftlimit
op_assign
id|d-&gt;dqb_bsoftlimit
suffix:semicolon
id|m-&gt;dqb_curspace
op_assign
id|d-&gt;dqb_curblocks
op_lshift
id|QUOTABLOCK_BITS
suffix:semicolon
id|m-&gt;dqb_itime
op_assign
id|d-&gt;dqb_itime
suffix:semicolon
id|m-&gt;dqb_btime
op_assign
id|d-&gt;dqb_btime
suffix:semicolon
)brace
DECL|function|v1_mem2disk_dqblk
r_static
r_void
id|v1_mem2disk_dqblk
c_func
(paren
r_struct
id|v1_disk_dqblk
op_star
id|d
comma
r_struct
id|mem_dqblk
op_star
id|m
)paren
(brace
id|d-&gt;dqb_ihardlimit
op_assign
id|m-&gt;dqb_ihardlimit
suffix:semicolon
id|d-&gt;dqb_isoftlimit
op_assign
id|m-&gt;dqb_isoftlimit
suffix:semicolon
id|d-&gt;dqb_curinodes
op_assign
id|m-&gt;dqb_curinodes
suffix:semicolon
id|d-&gt;dqb_bhardlimit
op_assign
id|m-&gt;dqb_bhardlimit
suffix:semicolon
id|d-&gt;dqb_bsoftlimit
op_assign
id|m-&gt;dqb_bsoftlimit
suffix:semicolon
id|d-&gt;dqb_curblocks
op_assign
id|toqb
c_func
(paren
id|m-&gt;dqb_curspace
)paren
suffix:semicolon
id|d-&gt;dqb_itime
op_assign
id|m-&gt;dqb_itime
suffix:semicolon
id|d-&gt;dqb_btime
op_assign
id|m-&gt;dqb_btime
suffix:semicolon
)brace
DECL|function|v1_read_dqblk
r_static
r_int
id|v1_read_dqblk
c_func
(paren
r_struct
id|dquot
op_star
id|dquot
)paren
(brace
r_int
id|type
op_assign
id|dquot-&gt;dq_type
suffix:semicolon
r_struct
id|file
op_star
id|filp
suffix:semicolon
id|mm_segment_t
id|fs
suffix:semicolon
id|loff_t
id|offset
suffix:semicolon
r_struct
id|v1_disk_dqblk
id|dqblk
suffix:semicolon
id|filp
op_assign
id|sb_dqopt
c_func
(paren
id|dquot-&gt;dq_sb
)paren
op_member_access_from_pointer
id|files
(braket
id|type
)braket
suffix:semicolon
r_if
c_cond
(paren
id|filp
op_eq
(paren
r_struct
id|file
op_star
)paren
l_int|NULL
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* Now we are sure filp is valid */
id|offset
op_assign
id|v1_dqoff
c_func
(paren
id|dquot-&gt;dq_id
)paren
suffix:semicolon
id|fs
op_assign
id|get_fs
c_func
(paren
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|KERNEL_DS
)paren
suffix:semicolon
id|filp-&gt;f_op
op_member_access_from_pointer
id|read
c_func
(paren
id|filp
comma
(paren
r_char
op_star
)paren
op_amp
id|dqblk
comma
r_sizeof
(paren
r_struct
id|v1_disk_dqblk
)paren
comma
op_amp
id|offset
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|fs
)paren
suffix:semicolon
id|v1_disk2mem_dqblk
c_func
(paren
op_amp
id|dquot-&gt;dq_dqb
comma
op_amp
id|dqblk
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dquot-&gt;dq_dqb.dqb_bhardlimit
op_eq
l_int|0
op_logical_and
id|dquot-&gt;dq_dqb.dqb_bsoftlimit
op_eq
l_int|0
op_logical_and
id|dquot-&gt;dq_dqb.dqb_ihardlimit
op_eq
l_int|0
op_logical_and
id|dquot-&gt;dq_dqb.dqb_isoftlimit
op_eq
l_int|0
)paren
id|dquot-&gt;dq_flags
op_or_assign
id|DQ_FAKE
suffix:semicolon
id|dqstats.reads
op_increment
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|v1_commit_dqblk
r_static
r_int
id|v1_commit_dqblk
c_func
(paren
r_struct
id|dquot
op_star
id|dquot
)paren
(brace
r_int
id|type
op_assign
id|dquot-&gt;dq_type
suffix:semicolon
r_struct
id|file
op_star
id|filp
suffix:semicolon
id|mm_segment_t
id|fs
suffix:semicolon
id|loff_t
id|offset
suffix:semicolon
id|ssize_t
id|ret
suffix:semicolon
r_struct
id|v1_disk_dqblk
id|dqblk
suffix:semicolon
id|filp
op_assign
id|sb_dqopt
c_func
(paren
id|dquot-&gt;dq_sb
)paren
op_member_access_from_pointer
id|files
(braket
id|type
)braket
suffix:semicolon
id|offset
op_assign
id|v1_dqoff
c_func
(paren
id|dquot-&gt;dq_id
)paren
suffix:semicolon
id|fs
op_assign
id|get_fs
c_func
(paren
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|KERNEL_DS
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Note: clear the DQ_MOD flag unconditionally,&n;&t; * so we don&squot;t loop forever on failure.&n;&t; */
id|v1_mem2disk_dqblk
c_func
(paren
op_amp
id|dqblk
comma
op_amp
id|dquot-&gt;dq_dqb
)paren
suffix:semicolon
id|dquot-&gt;dq_flags
op_and_assign
op_complement
id|DQ_MOD
suffix:semicolon
r_if
c_cond
(paren
id|dquot-&gt;dq_id
op_eq
l_int|0
)paren
(brace
id|dqblk.dqb_btime
op_assign
id|sb_dqopt
c_func
(paren
id|dquot-&gt;dq_sb
)paren
op_member_access_from_pointer
id|info
(braket
id|type
)braket
dot
id|dqi_bgrace
suffix:semicolon
id|dqblk.dqb_itime
op_assign
id|sb_dqopt
c_func
(paren
id|dquot-&gt;dq_sb
)paren
op_member_access_from_pointer
id|info
(braket
id|type
)braket
dot
id|dqi_igrace
suffix:semicolon
)brace
id|ret
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|filp
)paren
id|ret
op_assign
id|filp-&gt;f_op
op_member_access_from_pointer
id|write
c_func
(paren
id|filp
comma
(paren
r_char
op_star
)paren
op_amp
id|dqblk
comma
r_sizeof
(paren
r_struct
id|v1_disk_dqblk
)paren
comma
op_amp
id|offset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ne
r_sizeof
(paren
r_struct
id|v1_disk_dqblk
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;VFS: dquota write failed on dev %s&bslash;n&quot;
comma
id|dquot-&gt;dq_sb-&gt;s_id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ge
l_int|0
)paren
id|ret
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|ret
op_assign
l_int|0
suffix:semicolon
id|out
suffix:colon
id|set_fs
c_func
(paren
id|fs
)paren
suffix:semicolon
id|dqstats.writes
op_increment
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* Magics of new quota format */
DECL|macro|V2_INITQMAGICS
mdefine_line|#define V2_INITQMAGICS {&bslash;&n;&t;0xd9c01f11,     /* USRQUOTA */&bslash;&n;&t;0xd9c01927      /* GRPQUOTA */&bslash;&n;}
multiline_comment|/* Header of new quota format */
DECL|struct|v2_disk_dqheader
r_struct
id|v2_disk_dqheader
(brace
DECL|member|dqh_magic
id|__u32
id|dqh_magic
suffix:semicolon
multiline_comment|/* Magic number identifying file */
DECL|member|dqh_version
id|__u32
id|dqh_version
suffix:semicolon
multiline_comment|/* File version */
)brace
suffix:semicolon
DECL|function|v1_check_quota_file
r_static
r_int
id|v1_check_quota_file
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_int
id|type
)paren
(brace
r_struct
id|file
op_star
id|f
op_assign
id|sb_dqopt
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|files
(braket
id|type
)braket
suffix:semicolon
r_struct
id|inode
op_star
id|inode
op_assign
id|f-&gt;f_dentry-&gt;d_inode
suffix:semicolon
id|ulong
id|blocks
suffix:semicolon
r_int
id|off
suffix:semicolon
r_struct
id|v2_disk_dqheader
id|dqhead
suffix:semicolon
id|mm_segment_t
id|fs
suffix:semicolon
id|ssize_t
id|size
suffix:semicolon
id|loff_t
id|offset
op_assign
l_int|0
suffix:semicolon
r_static
r_const
id|uint
id|quota_magics
(braket
)braket
op_assign
id|V2_INITQMAGICS
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|inode-&gt;i_size
)paren
r_return
l_int|0
suffix:semicolon
id|blocks
op_assign
id|inode-&gt;i_size
op_rshift
id|BLOCK_SIZE_BITS
suffix:semicolon
id|off
op_assign
id|inode-&gt;i_size
op_amp
(paren
id|BLOCK_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|blocks
op_mod
r_sizeof
(paren
r_struct
id|v1_disk_dqblk
)paren
op_star
id|BLOCK_SIZE
op_plus
id|off
)paren
op_mod
r_sizeof
(paren
r_struct
id|v1_disk_dqblk
)paren
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Doublecheck whether we didn&squot;t get file with new format - with old quotactl() this could happen */
id|fs
op_assign
id|get_fs
c_func
(paren
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|KERNEL_DS
)paren
suffix:semicolon
id|size
op_assign
id|f-&gt;f_op
op_member_access_from_pointer
id|read
c_func
(paren
id|f
comma
(paren
r_char
op_star
)paren
op_amp
id|dqhead
comma
r_sizeof
(paren
r_struct
id|v2_disk_dqheader
)paren
comma
op_amp
id|offset
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|fs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|size
op_ne
r_sizeof
(paren
r_struct
id|v2_disk_dqheader
)paren
)paren
r_return
l_int|1
suffix:semicolon
multiline_comment|/* Probably not new format */
r_if
c_cond
(paren
id|le32_to_cpu
c_func
(paren
id|dqhead.dqh_magic
)paren
op_ne
id|quota_magics
(braket
id|type
)braket
)paren
r_return
l_int|1
suffix:semicolon
multiline_comment|/* Definitely not new format */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;VFS: %s: Refusing to turn on old quota format on given file. It probably contains newer quota format.&bslash;n&quot;
comma
id|sb-&gt;s_id
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* Seems like a new format file -&gt; refuse it */
)brace
DECL|function|v1_read_file_info
r_static
r_int
id|v1_read_file_info
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_int
id|type
)paren
(brace
r_struct
id|quota_info
op_star
id|dqopt
op_assign
id|sb_dqopt
c_func
(paren
id|sb
)paren
suffix:semicolon
id|mm_segment_t
id|fs
suffix:semicolon
id|loff_t
id|offset
suffix:semicolon
r_struct
id|file
op_star
id|filp
op_assign
id|dqopt-&gt;files
(braket
id|type
)braket
suffix:semicolon
r_struct
id|v1_disk_dqblk
id|dqblk
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|down
c_func
(paren
op_amp
id|dqopt-&gt;dqio_sem
)paren
suffix:semicolon
id|offset
op_assign
id|v1_dqoff
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|fs
op_assign
id|get_fs
c_func
(paren
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|KERNEL_DS
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|filp-&gt;f_op
op_member_access_from_pointer
id|read
c_func
(paren
id|filp
comma
(paren
r_char
op_star
)paren
op_amp
id|dqblk
comma
r_sizeof
(paren
r_struct
id|v1_disk_dqblk
)paren
comma
op_amp
id|offset
)paren
)paren
op_ne
r_sizeof
(paren
r_struct
id|v1_disk_dqblk
)paren
)paren
(brace
r_if
c_cond
(paren
id|ret
op_ge
l_int|0
)paren
id|ret
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|ret
op_assign
l_int|0
suffix:semicolon
id|dqopt-&gt;info
(braket
id|type
)braket
dot
id|dqi_igrace
op_assign
id|dqblk.dqb_itime
ques
c_cond
id|dqblk.dqb_itime
suffix:colon
id|MAX_IQ_TIME
suffix:semicolon
id|dqopt-&gt;info
(braket
id|type
)braket
dot
id|dqi_bgrace
op_assign
id|dqblk.dqb_btime
ques
c_cond
id|dqblk.dqb_btime
suffix:colon
id|MAX_DQ_TIME
suffix:semicolon
id|out
suffix:colon
id|up
c_func
(paren
op_amp
id|dqopt-&gt;dqio_sem
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|fs
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|v1_write_file_info
r_static
r_int
id|v1_write_file_info
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_int
id|type
)paren
(brace
r_struct
id|quota_info
op_star
id|dqopt
op_assign
id|sb_dqopt
c_func
(paren
id|sb
)paren
suffix:semicolon
id|mm_segment_t
id|fs
suffix:semicolon
r_struct
id|file
op_star
id|filp
op_assign
id|dqopt-&gt;files
(braket
id|type
)braket
suffix:semicolon
r_struct
id|v1_disk_dqblk
id|dqblk
suffix:semicolon
id|loff_t
id|offset
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|down
c_func
(paren
op_amp
id|dqopt-&gt;dqio_sem
)paren
suffix:semicolon
id|dqopt-&gt;info
(braket
id|type
)braket
dot
id|dqi_flags
op_and_assign
op_complement
id|DQF_INFO_DIRTY
suffix:semicolon
id|offset
op_assign
id|v1_dqoff
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|fs
op_assign
id|get_fs
c_func
(paren
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|KERNEL_DS
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|filp-&gt;f_op
op_member_access_from_pointer
id|read
c_func
(paren
id|filp
comma
(paren
r_char
op_star
)paren
op_amp
id|dqblk
comma
r_sizeof
(paren
r_struct
id|v1_disk_dqblk
)paren
comma
op_amp
id|offset
)paren
)paren
op_ne
r_sizeof
(paren
r_struct
id|v1_disk_dqblk
)paren
)paren
(brace
r_if
c_cond
(paren
id|ret
op_ge
l_int|0
)paren
id|ret
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|dqblk.dqb_itime
op_assign
id|dqopt-&gt;info
(braket
id|type
)braket
dot
id|dqi_igrace
suffix:semicolon
id|dqblk.dqb_btime
op_assign
id|dqopt-&gt;info
(braket
id|type
)braket
dot
id|dqi_bgrace
suffix:semicolon
id|offset
op_assign
id|v1_dqoff
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|ret
op_assign
id|filp-&gt;f_op
op_member_access_from_pointer
id|write
c_func
(paren
id|filp
comma
(paren
r_char
op_star
)paren
op_amp
id|dqblk
comma
r_sizeof
(paren
r_struct
id|v1_disk_dqblk
)paren
comma
op_amp
id|offset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
r_sizeof
(paren
r_struct
id|v1_disk_dqblk
)paren
)paren
id|ret
op_assign
l_int|0
suffix:semicolon
r_else
r_if
c_cond
(paren
id|ret
OG
l_int|0
)paren
id|ret
op_assign
op_minus
id|EIO
suffix:semicolon
id|out
suffix:colon
id|up
c_func
(paren
op_amp
id|dqopt-&gt;dqio_sem
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|fs
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|variable|v1_format_ops
r_static
r_struct
id|quota_format_ops
id|v1_format_ops
op_assign
(brace
id|check_quota_file
suffix:colon
id|v1_check_quota_file
comma
id|read_file_info
suffix:colon
id|v1_read_file_info
comma
id|write_file_info
suffix:colon
id|v1_write_file_info
comma
id|free_file_info
suffix:colon
l_int|NULL
comma
id|read_dqblk
suffix:colon
id|v1_read_dqblk
comma
id|commit_dqblk
suffix:colon
id|v1_commit_dqblk
comma
)brace
suffix:semicolon
DECL|variable|v1_quota_format
r_static
r_struct
id|quota_format_type
id|v1_quota_format
op_assign
(brace
id|qf_fmt_id
suffix:colon
id|QFMT_VFS_OLD
comma
id|qf_ops
suffix:colon
op_amp
id|v1_format_ops
comma
id|qf_owner
suffix:colon
id|THIS_MODULE
)brace
suffix:semicolon
DECL|function|init_v1_quota_format
r_static
r_int
id|__init
id|init_v1_quota_format
c_func
(paren
r_void
)paren
(brace
r_return
id|register_quota_format
c_func
(paren
op_amp
id|v1_quota_format
)paren
suffix:semicolon
)brace
DECL|function|exit_v1_quota_format
r_static
r_void
id|__exit
id|exit_v1_quota_format
c_func
(paren
r_void
)paren
(brace
id|unregister_quota_format
c_func
(paren
op_amp
id|v1_quota_format
)paren
suffix:semicolon
)brace
id|EXPORT_NO_SYMBOLS
suffix:semicolon
DECL|variable|init_v1_quota_format
id|module_init
c_func
(paren
id|init_v1_quota_format
)paren
suffix:semicolon
DECL|variable|exit_v1_quota_format
id|module_exit
c_func
(paren
id|exit_v1_quota_format
)paren
suffix:semicolon
eof
