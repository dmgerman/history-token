multiline_comment|/*&n; *  linux/fs/hfsplus/unicode.c&n; *&n; * Copyright (C) 2001&n; * Brad Boyer (flar@allandria.com)&n; * (C) 2003 Ardis Technologies &lt;roman@ardistech.com&gt;&n; *&n; * Handler routines for unicode strings&n; */
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/nls.h&gt;
macro_line|#include &quot;hfsplus_fs.h&quot;
macro_line|#include &quot;hfsplus_raw.h&quot;
multiline_comment|/* Fold the case of a unicode char, given the 16 bit value */
multiline_comment|/* Returns folded char, or 0 if ignorable */
DECL|function|case_fold
r_static
r_inline
id|u16
id|case_fold
c_func
(paren
id|u16
id|c
)paren
(brace
id|u16
id|tmp
suffix:semicolon
id|tmp
op_assign
id|hfsplus_case_fold_table
(braket
id|c
op_rshift
l_int|8
)braket
suffix:semicolon
r_if
c_cond
(paren
id|tmp
)paren
id|tmp
op_assign
id|hfsplus_case_fold_table
(braket
id|tmp
op_plus
(paren
id|c
op_amp
l_int|0xff
)paren
)braket
suffix:semicolon
r_else
id|tmp
op_assign
id|c
suffix:semicolon
r_return
id|tmp
suffix:semicolon
)brace
multiline_comment|/* Compare unicode strings, return values like normal strcmp */
DECL|function|hfsplus_unistrcmp
r_int
id|hfsplus_unistrcmp
c_func
(paren
r_const
r_struct
id|hfsplus_unistr
op_star
id|s1
comma
r_const
r_struct
id|hfsplus_unistr
op_star
id|s2
)paren
(brace
id|u16
id|len1
comma
id|len2
comma
id|c1
comma
id|c2
suffix:semicolon
r_const
id|hfsplus_unichr
op_star
id|p1
comma
op_star
id|p2
suffix:semicolon
id|len1
op_assign
id|be16_to_cpu
c_func
(paren
id|s1-&gt;length
)paren
suffix:semicolon
id|len2
op_assign
id|be16_to_cpu
c_func
(paren
id|s2-&gt;length
)paren
suffix:semicolon
id|p1
op_assign
id|s1-&gt;unicode
suffix:semicolon
id|p2
op_assign
id|s2-&gt;unicode
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|c1
op_assign
id|c2
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|len1
op_logical_and
op_logical_neg
id|c1
)paren
(brace
id|c1
op_assign
id|case_fold
c_func
(paren
id|be16_to_cpu
c_func
(paren
op_star
id|p1
)paren
)paren
suffix:semicolon
id|p1
op_increment
suffix:semicolon
id|len1
op_decrement
suffix:semicolon
)brace
r_while
c_loop
(paren
id|len2
op_logical_and
op_logical_neg
id|c2
)paren
(brace
id|c2
op_assign
id|case_fold
c_func
(paren
id|be16_to_cpu
c_func
(paren
op_star
id|p2
)paren
)paren
suffix:semicolon
id|p2
op_increment
suffix:semicolon
id|len2
op_decrement
suffix:semicolon
)brace
r_if
c_cond
(paren
id|c1
op_ne
id|c2
)paren
r_return
(paren
id|c1
OL
id|c2
)paren
ques
c_cond
op_minus
l_int|1
suffix:colon
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|c1
op_logical_and
op_logical_neg
id|c2
)paren
r_return
l_int|0
suffix:semicolon
)brace
)brace
DECL|macro|Hangul_SBase
mdefine_line|#define Hangul_SBase&t;0xac00
DECL|macro|Hangul_LBase
mdefine_line|#define Hangul_LBase&t;0x1100
DECL|macro|Hangul_VBase
mdefine_line|#define Hangul_VBase&t;0x1161
DECL|macro|Hangul_TBase
mdefine_line|#define Hangul_TBase&t;0x11a7
DECL|macro|Hangul_SCount
mdefine_line|#define Hangul_SCount&t;11172
DECL|macro|Hangul_LCount
mdefine_line|#define Hangul_LCount&t;19
DECL|macro|Hangul_VCount
mdefine_line|#define Hangul_VCount&t;21
DECL|macro|Hangul_TCount
mdefine_line|#define Hangul_TCount&t;28
DECL|macro|Hangul_NCount
mdefine_line|#define Hangul_NCount&t;(Hangul_VCount * Hangul_TCount)
DECL|function|hfsplus_compose_lookup
r_static
id|u16
op_star
id|hfsplus_compose_lookup
c_func
(paren
id|u16
op_star
id|p
comma
id|u16
id|cc
)paren
(brace
r_int
id|i
comma
id|s
comma
id|e
suffix:semicolon
id|s
op_assign
l_int|1
suffix:semicolon
id|e
op_assign
id|p
(braket
l_int|1
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|e
op_logical_or
id|cc
template_param
id|p
(braket
id|e
op_star
l_int|2
)braket
)paren
r_return
l_int|NULL
suffix:semicolon
r_do
(brace
id|i
op_assign
(paren
id|s
op_plus
id|e
)paren
op_div
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|cc
OG
id|p
(braket
id|i
op_star
l_int|2
)braket
)paren
id|s
op_assign
id|i
op_plus
l_int|1
suffix:semicolon
r_else
r_if
c_cond
(paren
id|cc
OL
id|p
(braket
id|i
op_star
l_int|2
)braket
)paren
id|e
op_assign
id|i
op_minus
l_int|1
suffix:semicolon
r_else
r_return
id|hfsplus_compose_table
op_plus
id|p
(braket
id|i
op_star
l_int|2
op_plus
l_int|1
)braket
suffix:semicolon
)brace
r_while
c_loop
(paren
id|s
op_le
id|e
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|hfsplus_uni2asc
r_int
id|hfsplus_uni2asc
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_const
r_struct
id|hfsplus_unistr
op_star
id|ustr
comma
r_char
op_star
id|astr
comma
r_int
op_star
id|len_p
)paren
(brace
r_const
id|hfsplus_unichr
op_star
id|ip
suffix:semicolon
r_struct
id|nls_table
op_star
id|nls
op_assign
id|HFSPLUS_SB
c_func
(paren
id|sb
)paren
dot
id|nls
suffix:semicolon
id|u8
op_star
id|op
suffix:semicolon
id|u16
id|cc
comma
id|c0
comma
id|c1
suffix:semicolon
id|u16
op_star
id|ce1
comma
op_star
id|ce2
suffix:semicolon
r_int
id|i
comma
id|len
comma
id|ustrlen
comma
id|res
comma
id|compose
suffix:semicolon
id|op
op_assign
id|astr
suffix:semicolon
id|ip
op_assign
id|ustr-&gt;unicode
suffix:semicolon
id|ustrlen
op_assign
id|be16_to_cpu
c_func
(paren
id|ustr-&gt;length
)paren
suffix:semicolon
id|len
op_assign
op_star
id|len_p
suffix:semicolon
id|ce1
op_assign
l_int|NULL
suffix:semicolon
id|compose
op_assign
op_logical_neg
(paren
id|HFSPLUS_SB
c_func
(paren
id|sb
)paren
dot
id|flags
op_amp
id|HFSPLUS_SB_NODECOMPOSE
)paren
suffix:semicolon
r_while
c_loop
(paren
id|ustrlen
OG
l_int|0
)paren
(brace
id|c0
op_assign
id|be16_to_cpu
c_func
(paren
op_star
id|ip
op_increment
)paren
suffix:semicolon
id|ustrlen
op_decrement
suffix:semicolon
multiline_comment|/* search for single decomposed char */
r_if
c_cond
(paren
id|likely
c_func
(paren
id|compose
)paren
)paren
id|ce1
op_assign
id|hfsplus_compose_lookup
c_func
(paren
id|hfsplus_compose_table
comma
id|c0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ce1
op_logical_and
(paren
id|cc
op_assign
id|ce1
(braket
l_int|0
)braket
)paren
)paren
(brace
multiline_comment|/* start of a possibly decomposed Hangul char */
r_if
c_cond
(paren
id|cc
op_ne
l_int|0xffff
)paren
r_goto
id|done
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ustrlen
)paren
r_goto
id|same
suffix:semicolon
id|c1
op_assign
id|be16_to_cpu
c_func
(paren
op_star
id|ip
)paren
op_minus
id|Hangul_VBase
suffix:semicolon
r_if
c_cond
(paren
id|c1
OL
id|Hangul_VCount
)paren
(brace
multiline_comment|/* compose the Hangul char */
id|cc
op_assign
(paren
id|c0
op_minus
id|Hangul_LBase
)paren
op_star
id|Hangul_VCount
suffix:semicolon
id|cc
op_assign
(paren
id|cc
op_plus
id|c1
)paren
op_star
id|Hangul_TCount
suffix:semicolon
id|cc
op_add_assign
id|Hangul_SBase
suffix:semicolon
id|ip
op_increment
suffix:semicolon
id|ustrlen
op_decrement
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ustrlen
)paren
r_goto
id|done
suffix:semicolon
id|c1
op_assign
id|be16_to_cpu
c_func
(paren
op_star
id|ip
)paren
op_minus
id|Hangul_TBase
suffix:semicolon
r_if
c_cond
(paren
id|c1
OG
l_int|0
op_logical_and
id|c1
OL
id|Hangul_TCount
)paren
(brace
id|cc
op_add_assign
id|c1
suffix:semicolon
id|ip
op_increment
suffix:semicolon
id|ustrlen
op_decrement
suffix:semicolon
)brace
r_goto
id|done
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
l_int|1
)paren
(brace
multiline_comment|/* main loop for common case of not composed chars */
r_if
c_cond
(paren
op_logical_neg
id|ustrlen
)paren
r_goto
id|same
suffix:semicolon
id|c1
op_assign
id|be16_to_cpu
c_func
(paren
op_star
id|ip
)paren
suffix:semicolon
r_if
c_cond
(paren
id|likely
c_func
(paren
id|compose
)paren
)paren
id|ce1
op_assign
id|hfsplus_compose_lookup
c_func
(paren
id|hfsplus_compose_table
comma
id|c1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ce1
)paren
r_break
suffix:semicolon
r_switch
c_cond
(paren
id|c0
)paren
(brace
r_case
l_int|0
suffix:colon
id|c0
op_assign
l_int|0x2400
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;/&squot;
suffix:colon
id|c0
op_assign
l_char|&squot;:&squot;
suffix:semicolon
r_break
suffix:semicolon
)brace
id|res
op_assign
id|nls
op_member_access_from_pointer
id|uni2char
c_func
(paren
id|c0
comma
id|op
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|res
op_eq
op_minus
id|ENAMETOOLONG
)paren
r_goto
id|out
suffix:semicolon
op_star
id|op
op_assign
l_char|&squot;?&squot;
suffix:semicolon
id|res
op_assign
l_int|1
suffix:semicolon
)brace
id|op
op_add_assign
id|res
suffix:semicolon
id|len
op_sub_assign
id|res
suffix:semicolon
id|c0
op_assign
id|c1
suffix:semicolon
id|ip
op_increment
suffix:semicolon
id|ustrlen
op_decrement
suffix:semicolon
)brace
id|ce2
op_assign
id|hfsplus_compose_lookup
c_func
(paren
id|ce1
comma
id|c0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ce2
)paren
(brace
id|i
op_assign
l_int|1
suffix:semicolon
r_while
c_loop
(paren
id|i
OL
id|ustrlen
)paren
(brace
id|ce1
op_assign
id|hfsplus_compose_lookup
c_func
(paren
id|ce2
comma
id|be16_to_cpu
c_func
(paren
id|ip
(braket
id|i
)braket
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ce1
)paren
r_break
suffix:semicolon
id|i
op_increment
suffix:semicolon
id|ce2
op_assign
id|ce1
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|cc
op_assign
id|ce2
(braket
l_int|0
)braket
)paren
)paren
(brace
id|ip
op_add_assign
id|i
suffix:semicolon
id|ustrlen
op_sub_assign
id|i
suffix:semicolon
r_goto
id|done
suffix:semicolon
)brace
)brace
id|same
suffix:colon
r_switch
c_cond
(paren
id|c0
)paren
(brace
r_case
l_int|0
suffix:colon
id|cc
op_assign
l_int|0x2400
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;/&squot;
suffix:colon
id|cc
op_assign
l_char|&squot;:&squot;
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|cc
op_assign
id|c0
suffix:semicolon
)brace
id|done
suffix:colon
id|res
op_assign
id|nls
op_member_access_from_pointer
id|uni2char
c_func
(paren
id|cc
comma
id|op
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|res
op_eq
op_minus
id|ENAMETOOLONG
)paren
r_goto
id|out
suffix:semicolon
op_star
id|op
op_assign
l_char|&squot;?&squot;
suffix:semicolon
id|res
op_assign
l_int|1
suffix:semicolon
)brace
id|op
op_add_assign
id|res
suffix:semicolon
id|len
op_sub_assign
id|res
suffix:semicolon
)brace
id|res
op_assign
l_int|0
suffix:semicolon
id|out
suffix:colon
op_star
id|len_p
op_assign
(paren
r_char
op_star
)paren
id|op
op_minus
id|astr
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
DECL|function|hfsplus_asc2uni
r_int
id|hfsplus_asc2uni
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|hfsplus_unistr
op_star
id|ustr
comma
r_const
r_char
op_star
id|astr
comma
r_int
id|len
)paren
(brace
r_struct
id|nls_table
op_star
id|nls
op_assign
id|HFSPLUS_SB
c_func
(paren
id|sb
)paren
dot
id|nls
suffix:semicolon
r_int
id|size
comma
id|off
comma
id|decompose
suffix:semicolon
m_wchar_t
id|c
suffix:semicolon
id|u16
id|outlen
op_assign
l_int|0
suffix:semicolon
id|decompose
op_assign
op_logical_neg
(paren
id|HFSPLUS_SB
c_func
(paren
id|sb
)paren
dot
id|flags
op_amp
id|HFSPLUS_SB_NODECOMPOSE
)paren
suffix:semicolon
r_while
c_loop
(paren
id|outlen
template_param
l_int|0
)paren
(brace
id|size
op_assign
id|nls
op_member_access_from_pointer
id|char2uni
c_func
(paren
id|astr
comma
id|len
comma
op_amp
id|c
)paren
suffix:semicolon
r_if
c_cond
(paren
id|size
op_le
l_int|0
)paren
(brace
id|c
op_assign
l_char|&squot;?&squot;
suffix:semicolon
id|size
op_assign
l_int|1
suffix:semicolon
)brace
id|astr
op_add_assign
id|size
suffix:semicolon
id|len
op_sub_assign
id|size
suffix:semicolon
r_switch
c_cond
(paren
id|c
)paren
(brace
r_case
l_int|0x2400
suffix:colon
id|c
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;:&squot;
suffix:colon
id|c
op_assign
l_char|&squot;/&squot;
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|c
op_ge
l_int|0xc0
op_logical_and
id|decompose
)paren
(brace
id|off
op_assign
id|hfsplus_decompose_table
(braket
(paren
id|c
op_rshift
l_int|12
)paren
op_amp
l_int|0xf
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|off
)paren
r_goto
id|done
suffix:semicolon
r_if
c_cond
(paren
id|off
op_eq
l_int|0xffff
)paren
(brace
r_goto
id|done
suffix:semicolon
)brace
id|off
op_assign
id|hfsplus_decompose_table
(braket
id|off
op_plus
(paren
(paren
id|c
op_rshift
l_int|8
)paren
op_amp
l_int|0xf
)paren
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|off
)paren
r_goto
id|done
suffix:semicolon
id|off
op_assign
id|hfsplus_decompose_table
(braket
id|off
op_plus
(paren
(paren
id|c
op_rshift
l_int|4
)paren
op_amp
l_int|0xf
)paren
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|off
)paren
r_goto
id|done
suffix:semicolon
id|off
op_assign
id|hfsplus_decompose_table
(braket
id|off
op_plus
(paren
id|c
op_amp
l_int|0xf
)paren
)braket
suffix:semicolon
id|size
op_assign
id|off
op_amp
l_int|3
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|size
)paren
r_goto
id|done
suffix:semicolon
id|off
op_div_assign
l_int|4
suffix:semicolon
r_if
c_cond
(paren
id|outlen
op_plus
id|size
OG
id|HFSPLUS_MAX_STRLEN
)paren
r_break
suffix:semicolon
r_do
(brace
id|ustr-&gt;unicode
(braket
id|outlen
op_increment
)braket
op_assign
id|cpu_to_be16
c_func
(paren
id|hfsplus_decompose_table
(braket
id|off
op_increment
)braket
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
op_decrement
id|size
OG
l_int|0
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|done
suffix:colon
id|ustr-&gt;unicode
(braket
id|outlen
op_increment
)braket
op_assign
id|cpu_to_be16
c_func
(paren
id|c
)paren
suffix:semicolon
)brace
id|ustr-&gt;length
op_assign
id|cpu_to_be16
c_func
(paren
id|outlen
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
l_int|0
)paren
r_return
op_minus
id|ENAMETOOLONG
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
eof
