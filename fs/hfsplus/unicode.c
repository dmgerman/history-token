multiline_comment|/*&n; *  linux/fs/hfsplus/unicode.c&n; *&n; * Copyright (C) 2001&n; * Brad Boyer (flar@allandria.com)&n; * (C) 2003 Ardis Technologies &lt;roman@ardistech.com&gt;&n; *&n; * Handler routines for unicode strings&n; */
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/nls.h&gt;
macro_line|#include &quot;hfsplus_fs.h&quot;
macro_line|#include &quot;hfsplus_raw.h&quot;
multiline_comment|/* Fold the case of a unicode char, given the 16 bit value */
multiline_comment|/* Returns folded char, or 0 if ignorable */
DECL|function|case_fold
r_static
r_inline
id|u16
id|case_fold
c_func
(paren
id|u16
id|c
)paren
(brace
id|u16
id|tmp
suffix:semicolon
id|tmp
op_assign
id|case_fold_table
(braket
(paren
id|c
op_rshift
l_int|8
)paren
)braket
suffix:semicolon
r_if
c_cond
(paren
id|tmp
)paren
id|tmp
op_assign
id|case_fold_table
(braket
id|tmp
op_plus
(paren
id|c
op_amp
l_int|0xFF
)paren
)braket
suffix:semicolon
r_else
id|tmp
op_assign
id|c
suffix:semicolon
r_return
id|tmp
suffix:semicolon
)brace
multiline_comment|/* Compare unicode strings, return values like normal strcmp */
DECL|function|hfsplus_unistrcmp
r_int
id|hfsplus_unistrcmp
c_func
(paren
r_const
r_struct
id|hfsplus_unistr
op_star
id|s1
comma
r_const
r_struct
id|hfsplus_unistr
op_star
id|s2
)paren
(brace
id|u16
id|len1
comma
id|len2
comma
id|c1
comma
id|c2
suffix:semicolon
r_const
id|hfsplus_unichr
op_star
id|p1
comma
op_star
id|p2
suffix:semicolon
id|len1
op_assign
id|be16_to_cpu
c_func
(paren
id|s1-&gt;length
)paren
suffix:semicolon
id|len2
op_assign
id|be16_to_cpu
c_func
(paren
id|s2-&gt;length
)paren
suffix:semicolon
id|p1
op_assign
id|s1-&gt;unicode
suffix:semicolon
id|p2
op_assign
id|s2-&gt;unicode
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|c1
op_assign
id|c2
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|len1
op_logical_and
op_logical_neg
id|c1
)paren
(brace
id|c1
op_assign
id|case_fold
c_func
(paren
id|be16_to_cpu
c_func
(paren
op_star
id|p1
)paren
)paren
suffix:semicolon
id|p1
op_increment
suffix:semicolon
id|len1
op_decrement
suffix:semicolon
)brace
r_while
c_loop
(paren
id|len2
op_logical_and
op_logical_neg
id|c2
)paren
(brace
id|c2
op_assign
id|case_fold
c_func
(paren
id|be16_to_cpu
c_func
(paren
op_star
id|p2
)paren
)paren
suffix:semicolon
id|p2
op_increment
suffix:semicolon
id|len2
op_decrement
suffix:semicolon
)brace
r_if
c_cond
(paren
id|c1
op_ne
id|c2
)paren
r_return
(paren
id|c1
OL
id|c2
)paren
ques
c_cond
op_minus
l_int|1
suffix:colon
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|c1
op_logical_and
op_logical_neg
id|c2
)paren
r_return
l_int|0
suffix:semicolon
)brace
)brace
DECL|function|hfsplus_uni2asc
r_int
id|hfsplus_uni2asc
c_func
(paren
r_const
r_struct
id|hfsplus_unistr
op_star
id|ustr
comma
r_char
op_star
id|astr
comma
r_int
op_star
id|len
)paren
(brace
r_const
id|hfsplus_unichr
op_star
id|ip
suffix:semicolon
id|u8
op_star
id|op
suffix:semicolon
id|u16
id|ustrlen
comma
id|cc
suffix:semicolon
r_int
id|size
comma
id|tmp
suffix:semicolon
id|op
op_assign
id|astr
suffix:semicolon
id|ip
op_assign
id|ustr-&gt;unicode
suffix:semicolon
id|ustrlen
op_assign
id|be16_to_cpu
c_func
(paren
id|ustr-&gt;length
)paren
suffix:semicolon
id|tmp
op_assign
op_star
id|len
suffix:semicolon
r_while
c_loop
(paren
id|ustrlen
OG
l_int|0
op_logical_and
id|tmp
OG
l_int|0
)paren
(brace
id|cc
op_assign
id|be16_to_cpu
c_func
(paren
op_star
id|ip
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|cc
)paren
(brace
r_case
l_int|0
suffix:colon
id|cc
op_assign
l_int|0x2400
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;/&squot;
suffix:colon
id|cc
op_assign
l_char|&squot;:&squot;
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cc
OG
l_int|0x7f
)paren
(brace
id|size
op_assign
id|utf8_wctomb
c_func
(paren
id|op
comma
id|cc
comma
id|tmp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|size
op_eq
op_minus
l_int|1
)paren
(brace
multiline_comment|/* ignore */
)brace
r_else
(brace
id|op
op_add_assign
id|size
suffix:semicolon
id|tmp
op_sub_assign
id|size
suffix:semicolon
)brace
)brace
r_else
(brace
op_star
id|op
op_increment
op_assign
(paren
id|u8
)paren
id|cc
suffix:semicolon
id|tmp
op_decrement
suffix:semicolon
)brace
id|ip
op_increment
suffix:semicolon
id|ustrlen
op_decrement
suffix:semicolon
)brace
op_star
id|len
op_assign
(paren
r_char
op_star
)paren
id|op
op_minus
id|astr
suffix:semicolon
r_if
c_cond
(paren
id|ustrlen
)paren
r_return
op_minus
id|ENAMETOOLONG
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|hfsplus_asc2uni
r_int
id|hfsplus_asc2uni
c_func
(paren
r_struct
id|hfsplus_unistr
op_star
id|ustr
comma
r_const
r_char
op_star
id|astr
comma
r_int
id|len
)paren
(brace
r_int
id|tmp
suffix:semicolon
m_wchar_t
id|c
suffix:semicolon
id|u16
id|outlen
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|outlen
op_le
id|HFSPLUS_MAX_STRLEN
op_logical_and
id|len
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
op_star
id|astr
op_amp
l_int|0x80
)paren
(brace
id|tmp
op_assign
id|utf8_mbtowc
c_func
(paren
op_amp
id|c
comma
id|astr
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmp
OL
l_int|0
)paren
(brace
id|astr
op_increment
suffix:semicolon
id|len
op_decrement
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_else
(brace
id|astr
op_add_assign
id|tmp
suffix:semicolon
id|len
op_sub_assign
id|tmp
suffix:semicolon
)brace
)brace
r_else
(brace
id|c
op_assign
op_star
id|astr
op_increment
suffix:semicolon
id|len
op_decrement
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|c
)paren
(brace
r_case
l_int|0x2400
suffix:colon
id|c
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
l_char|&squot;:&squot;
suffix:colon
id|c
op_assign
l_char|&squot;/&squot;
suffix:semicolon
r_break
suffix:semicolon
)brace
id|ustr-&gt;unicode
(braket
id|outlen
)braket
op_assign
id|cpu_to_be16
c_func
(paren
id|c
)paren
suffix:semicolon
id|outlen
op_increment
suffix:semicolon
)brace
id|ustr-&gt;length
op_assign
id|cpu_to_be16
c_func
(paren
id|outlen
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
l_int|0
)paren
r_return
op_minus
id|ENAMETOOLONG
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
eof
