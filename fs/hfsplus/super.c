multiline_comment|/*&n; *  linux/fs/hfsplus/super.c&n; *&n; * Copyright (C) 2001&n; * Brad Boyer (flar@allandria.com)&n; * (C) 2003 Ardis Technologies &lt;roman@ardistech.com&gt;&n; *&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/pagemap.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/vfs.h&gt;
r_static
r_struct
id|inode
op_star
id|hfsplus_alloc_inode
c_func
(paren
r_struct
id|super_block
op_star
id|sb
)paren
suffix:semicolon
r_static
r_void
id|hfsplus_destroy_inode
c_func
(paren
r_struct
id|inode
op_star
id|inode
)paren
suffix:semicolon
macro_line|#include &quot;hfsplus_fs.h&quot;
DECL|function|hfsplus_inode_check
r_void
id|hfsplus_inode_check
c_func
(paren
r_struct
id|super_block
op_star
id|sb
)paren
(brace
macro_line|#if 0
id|u32
id|cnt
op_assign
id|atomic_read
c_func
(paren
op_amp
id|HFSPLUS_SB
c_func
(paren
id|sb
)paren
dot
id|inode_cnt
)paren
suffix:semicolon
id|u32
id|last_cnt
op_assign
id|HFSPLUS_SB
c_func
(paren
id|sb
)paren
dot
id|last_inode_cnt
suffix:semicolon
r_if
c_cond
(paren
id|cnt
op_le
(paren
id|last_cnt
op_div
l_int|2
)paren
op_logical_or
id|cnt
op_ge
(paren
id|last_cnt
op_star
l_int|2
)paren
)paren
(brace
id|HFSPLUS_SB
c_func
(paren
id|sb
)paren
dot
id|last_inode_cnt
op_assign
id|cnt
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;inode_check: %u,%u,%u&bslash;n&quot;
comma
id|cnt
comma
id|last_cnt
comma
id|HFSPLUS_SB
c_func
(paren
id|sb
)paren
dot
id|cat_tree
ques
c_cond
id|HFSPLUS_SB
c_func
(paren
id|sb
)paren
dot
id|cat_tree-&gt;node_hash_cnt
suffix:colon
l_int|0
)paren
suffix:semicolon
)brace
macro_line|#endif
)brace
DECL|function|hfsplus_read_inode
r_static
r_void
id|hfsplus_read_inode
c_func
(paren
r_struct
id|inode
op_star
id|inode
)paren
(brace
r_struct
id|hfs_find_data
id|fd
suffix:semicolon
r_struct
id|hfsplus_vh
op_star
id|vhdr
suffix:semicolon
r_int
id|err
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|HFSPLUS_SB
c_func
(paren
id|inode-&gt;i_sb
)paren
dot
id|inode_cnt
)paren
suffix:semicolon
id|hfsplus_inode_check
c_func
(paren
id|inode-&gt;i_sb
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|HFSPLUS_I
c_func
(paren
id|inode
)paren
dot
id|open_dir_list
)paren
suffix:semicolon
id|init_MUTEX
c_func
(paren
op_amp
id|HFSPLUS_I
c_func
(paren
id|inode
)paren
dot
id|extents_lock
)paren
suffix:semicolon
id|HFSPLUS_I
c_func
(paren
id|inode
)paren
dot
id|flags
op_assign
l_int|0
suffix:semicolon
id|HFSPLUS_I
c_func
(paren
id|inode
)paren
dot
id|rsrc_inode
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|inode-&gt;i_ino
op_ge
id|HFSPLUS_FIRSTUSER_CNID
)paren
(brace
id|read_inode
suffix:colon
id|hfs_find_init
c_func
(paren
id|HFSPLUS_SB
c_func
(paren
id|inode-&gt;i_sb
)paren
dot
id|cat_tree
comma
op_amp
id|fd
)paren
suffix:semicolon
id|err
op_assign
id|hfsplus_find_cat
c_func
(paren
id|inode-&gt;i_sb
comma
id|inode-&gt;i_ino
comma
op_amp
id|fd
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|err
)paren
id|err
op_assign
id|hfsplus_cat_read_inode
c_func
(paren
id|inode
comma
op_amp
id|fd
)paren
suffix:semicolon
id|hfs_find_exit
c_func
(paren
op_amp
id|fd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|bad_inode
suffix:semicolon
r_return
suffix:semicolon
)brace
id|vhdr
op_assign
id|HFSPLUS_SB
c_func
(paren
id|inode-&gt;i_sb
)paren
dot
id|s_vhdr
suffix:semicolon
r_switch
c_cond
(paren
id|inode-&gt;i_ino
)paren
(brace
r_case
id|HFSPLUS_ROOT_CNID
suffix:colon
r_goto
id|read_inode
suffix:semicolon
r_case
id|HFSPLUS_EXT_CNID
suffix:colon
id|hfsplus_inode_read_fork
c_func
(paren
id|inode
comma
op_amp
id|vhdr-&gt;ext_file
)paren
suffix:semicolon
id|inode-&gt;i_mapping-&gt;a_ops
op_assign
op_amp
id|hfsplus_btree_aops
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HFSPLUS_CAT_CNID
suffix:colon
id|hfsplus_inode_read_fork
c_func
(paren
id|inode
comma
op_amp
id|vhdr-&gt;cat_file
)paren
suffix:semicolon
id|inode-&gt;i_mapping-&gt;a_ops
op_assign
op_amp
id|hfsplus_btree_aops
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HFSPLUS_ALLOC_CNID
suffix:colon
id|hfsplus_inode_read_fork
c_func
(paren
id|inode
comma
op_amp
id|vhdr-&gt;alloc_file
)paren
suffix:semicolon
id|inode-&gt;i_mapping-&gt;a_ops
op_assign
op_amp
id|hfsplus_aops
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HFSPLUS_START_CNID
suffix:colon
id|hfsplus_inode_read_fork
c_func
(paren
id|inode
comma
op_amp
id|vhdr-&gt;start_file
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HFSPLUS_ATTR_CNID
suffix:colon
id|hfsplus_inode_read_fork
c_func
(paren
id|inode
comma
op_amp
id|vhdr-&gt;attr_file
)paren
suffix:semicolon
id|inode-&gt;i_mapping-&gt;a_ops
op_assign
op_amp
id|hfsplus_btree_aops
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_goto
id|bad_inode
suffix:semicolon
)brace
r_return
suffix:semicolon
id|bad_inode
suffix:colon
id|make_bad_inode
c_func
(paren
id|inode
)paren
suffix:semicolon
)brace
DECL|function|hfsplus_write_inode
r_int
id|hfsplus_write_inode
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_int
id|unused
)paren
(brace
r_struct
id|hfsplus_vh
op_star
id|vhdr
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
id|dprint
c_func
(paren
id|DBG_INODE
comma
l_string|&quot;hfsplus_write_inode: %lu&bslash;n&quot;
comma
id|inode-&gt;i_ino
)paren
suffix:semicolon
id|hfsplus_ext_write_extent
c_func
(paren
id|inode
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inode-&gt;i_ino
op_ge
id|HFSPLUS_FIRSTUSER_CNID
)paren
(brace
r_return
id|hfsplus_cat_write_inode
c_func
(paren
id|inode
)paren
suffix:semicolon
)brace
id|vhdr
op_assign
id|HFSPLUS_SB
c_func
(paren
id|inode-&gt;i_sb
)paren
dot
id|s_vhdr
suffix:semicolon
r_switch
c_cond
(paren
id|inode-&gt;i_ino
)paren
(brace
r_case
id|HFSPLUS_ROOT_CNID
suffix:colon
id|ret
op_assign
id|hfsplus_cat_write_inode
c_func
(paren
id|inode
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HFSPLUS_EXT_CNID
suffix:colon
r_if
c_cond
(paren
id|vhdr-&gt;ext_file.total_size
op_ne
id|cpu_to_be64
c_func
(paren
id|inode-&gt;i_size
)paren
)paren
(brace
id|HFSPLUS_SB
c_func
(paren
id|inode-&gt;i_sb
)paren
dot
id|flags
op_or_assign
id|HFSPLUS_SB_WRITEBACKUP
suffix:semicolon
id|inode-&gt;i_sb-&gt;s_dirt
op_assign
l_int|1
suffix:semicolon
)brace
id|hfsplus_inode_write_fork
c_func
(paren
id|inode
comma
op_amp
id|vhdr-&gt;ext_file
)paren
suffix:semicolon
id|hfs_btree_write
c_func
(paren
id|HFSPLUS_SB
c_func
(paren
id|inode-&gt;i_sb
)paren
dot
id|ext_tree
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HFSPLUS_CAT_CNID
suffix:colon
r_if
c_cond
(paren
id|vhdr-&gt;cat_file.total_size
op_ne
id|cpu_to_be64
c_func
(paren
id|inode-&gt;i_size
)paren
)paren
(brace
id|HFSPLUS_SB
c_func
(paren
id|inode-&gt;i_sb
)paren
dot
id|flags
op_or_assign
id|HFSPLUS_SB_WRITEBACKUP
suffix:semicolon
id|inode-&gt;i_sb-&gt;s_dirt
op_assign
l_int|1
suffix:semicolon
)brace
id|hfsplus_inode_write_fork
c_func
(paren
id|inode
comma
op_amp
id|vhdr-&gt;cat_file
)paren
suffix:semicolon
id|hfs_btree_write
c_func
(paren
id|HFSPLUS_SB
c_func
(paren
id|inode-&gt;i_sb
)paren
dot
id|cat_tree
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HFSPLUS_ALLOC_CNID
suffix:colon
r_if
c_cond
(paren
id|vhdr-&gt;alloc_file.total_size
op_ne
id|cpu_to_be64
c_func
(paren
id|inode-&gt;i_size
)paren
)paren
(brace
id|HFSPLUS_SB
c_func
(paren
id|inode-&gt;i_sb
)paren
dot
id|flags
op_or_assign
id|HFSPLUS_SB_WRITEBACKUP
suffix:semicolon
id|inode-&gt;i_sb-&gt;s_dirt
op_assign
l_int|1
suffix:semicolon
)brace
id|hfsplus_inode_write_fork
c_func
(paren
id|inode
comma
op_amp
id|vhdr-&gt;alloc_file
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HFSPLUS_START_CNID
suffix:colon
r_if
c_cond
(paren
id|vhdr-&gt;start_file.total_size
op_ne
id|cpu_to_be64
c_func
(paren
id|inode-&gt;i_size
)paren
)paren
(brace
id|HFSPLUS_SB
c_func
(paren
id|inode-&gt;i_sb
)paren
dot
id|flags
op_or_assign
id|HFSPLUS_SB_WRITEBACKUP
suffix:semicolon
id|inode-&gt;i_sb-&gt;s_dirt
op_assign
l_int|1
suffix:semicolon
)brace
id|hfsplus_inode_write_fork
c_func
(paren
id|inode
comma
op_amp
id|vhdr-&gt;start_file
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|HFSPLUS_ATTR_CNID
suffix:colon
r_if
c_cond
(paren
id|vhdr-&gt;attr_file.total_size
op_ne
id|cpu_to_be64
c_func
(paren
id|inode-&gt;i_size
)paren
)paren
(brace
id|HFSPLUS_SB
c_func
(paren
id|inode-&gt;i_sb
)paren
dot
id|flags
op_or_assign
id|HFSPLUS_SB_WRITEBACKUP
suffix:semicolon
id|inode-&gt;i_sb-&gt;s_dirt
op_assign
l_int|1
suffix:semicolon
)brace
id|hfsplus_inode_write_fork
c_func
(paren
id|inode
comma
op_amp
id|vhdr-&gt;attr_file
)paren
suffix:semicolon
id|hfs_btree_write
c_func
(paren
id|HFSPLUS_SB
c_func
(paren
id|inode-&gt;i_sb
)paren
dot
id|attr_tree
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|function|hfsplus_clear_inode
r_static
r_void
id|hfsplus_clear_inode
c_func
(paren
r_struct
id|inode
op_star
id|inode
)paren
(brace
id|dprint
c_func
(paren
id|DBG_INODE
comma
l_string|&quot;hfsplus_clear_inode: %lu&bslash;n&quot;
comma
id|inode-&gt;i_ino
)paren
suffix:semicolon
id|atomic_dec
c_func
(paren
op_amp
id|HFSPLUS_SB
c_func
(paren
id|inode-&gt;i_sb
)paren
dot
id|inode_cnt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|HFSPLUS_IS_RSRC
c_func
(paren
id|inode
)paren
)paren
(brace
id|HFSPLUS_I
c_func
(paren
id|HFSPLUS_I
c_func
(paren
id|inode
)paren
dot
id|rsrc_inode
)paren
dot
id|rsrc_inode
op_assign
l_int|NULL
suffix:semicolon
id|iput
c_func
(paren
id|HFSPLUS_I
c_func
(paren
id|inode
)paren
dot
id|rsrc_inode
)paren
suffix:semicolon
)brace
id|hfsplus_inode_check
c_func
(paren
id|inode-&gt;i_sb
)paren
suffix:semicolon
)brace
DECL|function|hfsplus_write_super
r_static
r_void
id|hfsplus_write_super
c_func
(paren
r_struct
id|super_block
op_star
id|sb
)paren
(brace
r_struct
id|hfsplus_vh
op_star
id|vhdr
op_assign
id|HFSPLUS_SB
c_func
(paren
id|sb
)paren
dot
id|s_vhdr
suffix:semicolon
id|dprint
c_func
(paren
id|DBG_SUPER
comma
l_string|&quot;hfsplus_write_super&bslash;n&quot;
)paren
suffix:semicolon
id|sb-&gt;s_dirt
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|sb-&gt;s_flags
op_amp
id|MS_RDONLY
)paren
multiline_comment|/* warn? */
r_return
suffix:semicolon
id|vhdr-&gt;free_blocks
op_assign
id|cpu_to_be32
c_func
(paren
id|HFSPLUS_SB
c_func
(paren
id|sb
)paren
dot
id|free_blocks
)paren
suffix:semicolon
id|vhdr-&gt;next_alloc
op_assign
id|cpu_to_be32
c_func
(paren
id|HFSPLUS_SB
c_func
(paren
id|sb
)paren
dot
id|next_alloc
)paren
suffix:semicolon
id|vhdr-&gt;next_cnid
op_assign
id|cpu_to_be32
c_func
(paren
id|HFSPLUS_SB
c_func
(paren
id|sb
)paren
dot
id|next_cnid
)paren
suffix:semicolon
id|vhdr-&gt;folder_count
op_assign
id|cpu_to_be32
c_func
(paren
id|HFSPLUS_SB
c_func
(paren
id|sb
)paren
dot
id|folder_count
)paren
suffix:semicolon
id|vhdr-&gt;file_count
op_assign
id|cpu_to_be32
c_func
(paren
id|HFSPLUS_SB
c_func
(paren
id|sb
)paren
dot
id|file_count
)paren
suffix:semicolon
id|mark_buffer_dirty
c_func
(paren
id|HFSPLUS_SB
c_func
(paren
id|sb
)paren
dot
id|s_vhbh
)paren
suffix:semicolon
r_if
c_cond
(paren
id|HFSPLUS_SB
c_func
(paren
id|sb
)paren
dot
id|flags
op_amp
id|HFSPLUS_SB_WRITEBACKUP
)paren
(brace
r_if
c_cond
(paren
id|HFSPLUS_SB
c_func
(paren
id|sb
)paren
dot
id|sect_count
)paren
(brace
r_struct
id|buffer_head
op_star
id|bh
suffix:semicolon
id|u32
id|block
comma
id|offset
suffix:semicolon
id|block
op_assign
id|HFSPLUS_SB
c_func
(paren
id|sb
)paren
dot
id|blockoffset
suffix:semicolon
id|block
op_add_assign
(paren
id|HFSPLUS_SB
c_func
(paren
id|sb
)paren
dot
id|sect_count
op_minus
l_int|2
)paren
op_rshift
(paren
id|sb-&gt;s_blocksize_bits
op_minus
l_int|9
)paren
suffix:semicolon
id|offset
op_assign
(paren
(paren
id|HFSPLUS_SB
c_func
(paren
id|sb
)paren
dot
id|sect_count
op_minus
l_int|2
)paren
op_lshift
l_int|9
)paren
op_amp
(paren
id|sb-&gt;s_blocksize
op_minus
l_int|1
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;backup: %u,%u,%u,%u&bslash;n&quot;
comma
id|HFSPLUS_SB
c_func
(paren
id|sb
)paren
dot
id|blockoffset
comma
id|HFSPLUS_SB
c_func
(paren
id|sb
)paren
dot
id|sect_count
comma
id|block
comma
id|offset
)paren
suffix:semicolon
id|bh
op_assign
id|sb_bread
c_func
(paren
id|sb
comma
id|block
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bh
)paren
(brace
id|vhdr
op_assign
(paren
r_struct
id|hfsplus_vh
op_star
)paren
(paren
id|bh-&gt;b_data
op_plus
id|offset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|be16_to_cpu
c_func
(paren
id|vhdr-&gt;signature
)paren
op_eq
id|HFSPLUS_VOLHEAD_SIG
)paren
(brace
id|memcpy
c_func
(paren
id|vhdr
comma
id|HFSPLUS_SB
c_func
(paren
id|sb
)paren
dot
id|s_vhdr
comma
r_sizeof
(paren
op_star
id|vhdr
)paren
)paren
suffix:semicolon
id|mark_buffer_dirty
c_func
(paren
id|bh
)paren
suffix:semicolon
id|brelse
c_func
(paren
id|bh
)paren
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
l_string|&quot;backup not found!&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
id|HFSPLUS_SB
c_func
(paren
id|sb
)paren
dot
id|flags
op_and_assign
op_complement
id|HFSPLUS_SB_WRITEBACKUP
suffix:semicolon
)brace
)brace
DECL|function|hfsplus_put_super
r_static
r_void
id|hfsplus_put_super
c_func
(paren
r_struct
id|super_block
op_star
id|sb
)paren
(brace
id|dprint
c_func
(paren
id|DBG_SUPER
comma
l_string|&quot;hfsplus_put_super&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|sb-&gt;s_flags
op_amp
id|MS_RDONLY
)paren
)paren
(brace
r_struct
id|hfsplus_vh
op_star
id|vhdr
op_assign
id|HFSPLUS_SB
c_func
(paren
id|sb
)paren
dot
id|s_vhdr
suffix:semicolon
id|vhdr-&gt;modify_date
op_assign
id|hfsp_now2mt
c_func
(paren
)paren
suffix:semicolon
id|vhdr-&gt;attributes
op_or_assign
id|cpu_to_be32
c_func
(paren
id|HFSPLUS_VOL_UNMNT
)paren
suffix:semicolon
id|vhdr-&gt;attributes
op_and_assign
id|cpu_to_be32
c_func
(paren
op_complement
id|HFSPLUS_VOL_INCNSTNT
)paren
suffix:semicolon
id|mark_buffer_dirty
c_func
(paren
id|HFSPLUS_SB
c_func
(paren
id|sb
)paren
dot
id|s_vhbh
)paren
suffix:semicolon
id|ll_rw_block
c_func
(paren
id|WRITE
comma
l_int|1
comma
op_amp
id|HFSPLUS_SB
c_func
(paren
id|sb
)paren
dot
id|s_vhbh
)paren
suffix:semicolon
id|wait_on_buffer
c_func
(paren
id|HFSPLUS_SB
c_func
(paren
id|sb
)paren
dot
id|s_vhbh
)paren
suffix:semicolon
)brace
id|hfs_btree_close
c_func
(paren
id|HFSPLUS_SB
c_func
(paren
id|sb
)paren
dot
id|cat_tree
)paren
suffix:semicolon
id|hfs_btree_close
c_func
(paren
id|HFSPLUS_SB
c_func
(paren
id|sb
)paren
dot
id|ext_tree
)paren
suffix:semicolon
id|iput
c_func
(paren
id|HFSPLUS_SB
c_func
(paren
id|sb
)paren
dot
id|alloc_file
)paren
suffix:semicolon
id|iput
c_func
(paren
id|HFSPLUS_SB
c_func
(paren
id|sb
)paren
dot
id|hidden_dir
)paren
suffix:semicolon
id|brelse
c_func
(paren
id|HFSPLUS_SB
c_func
(paren
id|sb
)paren
dot
id|s_vhbh
)paren
suffix:semicolon
)brace
DECL|function|hfsplus_statfs
r_static
r_int
id|hfsplus_statfs
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|kstatfs
op_star
id|buf
)paren
(brace
id|buf-&gt;f_type
op_assign
id|HFSPLUS_SUPER_MAGIC
suffix:semicolon
id|buf-&gt;f_bsize
op_assign
id|sb-&gt;s_blocksize
suffix:semicolon
id|buf-&gt;f_blocks
op_assign
id|HFSPLUS_SB
c_func
(paren
id|sb
)paren
dot
id|total_blocks
op_lshift
id|HFSPLUS_SB
c_func
(paren
id|sb
)paren
dot
id|fs_shift
suffix:semicolon
id|buf-&gt;f_bfree
op_assign
id|HFSPLUS_SB
c_func
(paren
id|sb
)paren
dot
id|free_blocks
op_lshift
id|HFSPLUS_SB
c_func
(paren
id|sb
)paren
dot
id|fs_shift
suffix:semicolon
id|buf-&gt;f_bavail
op_assign
id|buf-&gt;f_bfree
suffix:semicolon
id|buf-&gt;f_files
op_assign
l_int|0xFFFFFFFF
suffix:semicolon
id|buf-&gt;f_ffree
op_assign
l_int|0xFFFFFFFF
op_minus
id|HFSPLUS_SB
c_func
(paren
id|sb
)paren
dot
id|next_cnid
suffix:semicolon
id|buf-&gt;f_namelen
op_assign
id|HFSPLUS_MAX_STRLEN
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|hfsplus_remount
r_int
id|hfsplus_remount
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_int
op_star
id|flags
comma
r_char
op_star
id|data
)paren
(brace
r_if
c_cond
(paren
(paren
op_star
id|flags
op_amp
id|MS_RDONLY
)paren
op_eq
(paren
id|sb-&gt;s_flags
op_amp
id|MS_RDONLY
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
op_star
id|flags
op_amp
id|MS_RDONLY
)paren
)paren
(brace
r_struct
id|hfsplus_vh
op_star
id|vhdr
op_assign
id|HFSPLUS_SB
c_func
(paren
id|sb
)paren
dot
id|s_vhdr
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|vhdr-&gt;attributes
op_amp
id|cpu_to_be32
c_func
(paren
id|HFSPLUS_VOL_UNMNT
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;HFS+-fs warning: Filesystem was not cleanly unmounted, &quot;
l_string|&quot;running fsck.hfsplus is recommended.  leaving read-only.&bslash;n&quot;
)paren
suffix:semicolon
id|sb-&gt;s_flags
op_or_assign
id|MS_RDONLY
suffix:semicolon
op_star
id|flags
op_or_assign
id|MS_RDONLY
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|vhdr-&gt;attributes
op_amp
id|cpu_to_be32
c_func
(paren
id|HFSPLUS_VOL_SOFTLOCK
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;HFS+-fs: Filesystem is marked locked, leaving read-only.&bslash;n&quot;
)paren
suffix:semicolon
id|sb-&gt;s_flags
op_or_assign
id|MS_RDONLY
suffix:semicolon
op_star
id|flags
op_or_assign
id|MS_RDONLY
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|hfsplus_sops
r_static
r_struct
id|super_operations
id|hfsplus_sops
op_assign
(brace
dot
id|alloc_inode
op_assign
id|hfsplus_alloc_inode
comma
dot
id|destroy_inode
op_assign
id|hfsplus_destroy_inode
comma
dot
id|read_inode
op_assign
id|hfsplus_read_inode
comma
dot
id|write_inode
op_assign
id|hfsplus_write_inode
comma
dot
id|clear_inode
op_assign
id|hfsplus_clear_inode
comma
dot
id|put_super
op_assign
id|hfsplus_put_super
comma
dot
id|write_super
op_assign
id|hfsplus_write_super
comma
dot
id|statfs
op_assign
id|hfsplus_statfs
comma
dot
id|remount_fs
op_assign
id|hfsplus_remount
comma
)brace
suffix:semicolon
DECL|function|hfsplus_fill_super
r_static
r_int
id|hfsplus_fill_super
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_void
op_star
id|data
comma
r_int
id|silent
)paren
(brace
r_struct
id|hfsplus_vh
op_star
id|vhdr
suffix:semicolon
r_struct
id|hfsplus_sb_info
op_star
id|sbi
suffix:semicolon
id|hfsplus_cat_entry
id|entry
suffix:semicolon
r_struct
id|hfs_find_data
id|fd
suffix:semicolon
r_struct
id|inode
op_star
id|root
suffix:semicolon
r_struct
id|qstr
id|str
suffix:semicolon
r_int
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
id|sbi
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|hfsplus_sb_info
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sbi
)paren
(brace
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|out2
suffix:semicolon
)brace
id|memset
c_func
(paren
id|sbi
comma
l_int|0
comma
r_sizeof
(paren
id|HFSPLUS_SB
c_func
(paren
id|sb
)paren
)paren
)paren
suffix:semicolon
id|sb-&gt;s_fs_info
op_assign
id|sbi
suffix:semicolon
id|INIT_HLIST_HEAD
c_func
(paren
op_amp
id|sbi-&gt;rsrc_inodes
)paren
suffix:semicolon
id|fill_defaults
c_func
(paren
id|sbi
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|parse_options
c_func
(paren
id|data
comma
id|sbi
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|silent
)paren
id|printk
c_func
(paren
l_string|&quot;HFS+-fs: unable to parse mount options&bslash;n&quot;
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|out2
suffix:semicolon
)brace
multiline_comment|/* Grab the volume header */
r_if
c_cond
(paren
id|hfsplus_read_wrapper
c_func
(paren
id|sb
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|silent
)paren
id|printk
c_func
(paren
l_string|&quot;HFS+-fs: unable to find HFS+ superblock&bslash;n&quot;
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|out2
suffix:semicolon
)brace
id|vhdr
op_assign
id|HFSPLUS_SB
c_func
(paren
id|sb
)paren
dot
id|s_vhdr
suffix:semicolon
multiline_comment|/* Copy parts of the volume header into the superblock */
id|sb-&gt;s_magic
op_assign
id|be16_to_cpu
c_func
(paren
id|vhdr-&gt;signature
)paren
suffix:semicolon
r_if
c_cond
(paren
id|be16_to_cpu
c_func
(paren
id|vhdr-&gt;version
)paren
op_ne
id|HFSPLUS_CURRENT_VERSION
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|silent
)paren
id|printk
c_func
(paren
l_string|&quot;HFS+-fs: wrong filesystem version&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|cleanup
suffix:semicolon
)brace
id|HFSPLUS_SB
c_func
(paren
id|sb
)paren
dot
id|total_blocks
op_assign
id|be32_to_cpu
c_func
(paren
id|vhdr-&gt;total_blocks
)paren
suffix:semicolon
id|HFSPLUS_SB
c_func
(paren
id|sb
)paren
dot
id|free_blocks
op_assign
id|be32_to_cpu
c_func
(paren
id|vhdr-&gt;free_blocks
)paren
suffix:semicolon
id|HFSPLUS_SB
c_func
(paren
id|sb
)paren
dot
id|next_alloc
op_assign
id|be32_to_cpu
c_func
(paren
id|vhdr-&gt;next_alloc
)paren
suffix:semicolon
id|HFSPLUS_SB
c_func
(paren
id|sb
)paren
dot
id|next_cnid
op_assign
id|be32_to_cpu
c_func
(paren
id|vhdr-&gt;next_cnid
)paren
suffix:semicolon
id|HFSPLUS_SB
c_func
(paren
id|sb
)paren
dot
id|file_count
op_assign
id|be32_to_cpu
c_func
(paren
id|vhdr-&gt;file_count
)paren
suffix:semicolon
id|HFSPLUS_SB
c_func
(paren
id|sb
)paren
dot
id|folder_count
op_assign
id|be32_to_cpu
c_func
(paren
id|vhdr-&gt;folder_count
)paren
suffix:semicolon
id|HFSPLUS_SB
c_func
(paren
id|sb
)paren
dot
id|data_clump_blocks
op_assign
id|be32_to_cpu
c_func
(paren
id|vhdr-&gt;data_clump_sz
)paren
op_rshift
id|HFSPLUS_SB
c_func
(paren
id|sb
)paren
dot
id|alloc_blksz_shift
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|HFSPLUS_SB
c_func
(paren
id|sb
)paren
dot
id|data_clump_blocks
)paren
id|HFSPLUS_SB
c_func
(paren
id|sb
)paren
dot
id|data_clump_blocks
op_assign
l_int|1
suffix:semicolon
id|HFSPLUS_SB
c_func
(paren
id|sb
)paren
dot
id|rsrc_clump_blocks
op_assign
id|be32_to_cpu
c_func
(paren
id|vhdr-&gt;rsrc_clump_sz
)paren
op_rshift
id|HFSPLUS_SB
c_func
(paren
id|sb
)paren
dot
id|alloc_blksz_shift
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|HFSPLUS_SB
c_func
(paren
id|sb
)paren
dot
id|rsrc_clump_blocks
)paren
id|HFSPLUS_SB
c_func
(paren
id|sb
)paren
dot
id|rsrc_clump_blocks
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Set up operations so we can load metadata */
id|sb-&gt;s_op
op_assign
op_amp
id|hfsplus_sops
suffix:semicolon
id|sb-&gt;s_maxbytes
op_assign
id|MAX_LFS_FILESIZE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|vhdr-&gt;attributes
op_amp
id|cpu_to_be32
c_func
(paren
id|HFSPLUS_VOL_UNMNT
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|silent
)paren
id|printk
c_func
(paren
l_string|&quot;HFS+-fs warning: Filesystem was not cleanly unmounted, &quot;
l_string|&quot;running fsck.hfsplus is recommended.  mounting read-only.&bslash;n&quot;
)paren
suffix:semicolon
id|sb-&gt;s_flags
op_or_assign
id|MS_RDONLY
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|vhdr-&gt;attributes
op_amp
id|cpu_to_be32
c_func
(paren
id|HFSPLUS_VOL_SOFTLOCK
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|silent
)paren
id|printk
c_func
(paren
l_string|&quot;HFS+-fs: Filesystem is marked locked, mounting read-only.&bslash;n&quot;
)paren
suffix:semicolon
id|sb-&gt;s_flags
op_or_assign
id|MS_RDONLY
suffix:semicolon
)brace
multiline_comment|/* Load metadata objects (B*Trees) */
id|HFSPLUS_SB
c_func
(paren
id|sb
)paren
dot
id|ext_tree
op_assign
id|hfs_btree_open
c_func
(paren
id|sb
comma
id|HFSPLUS_EXT_CNID
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|HFSPLUS_SB
c_func
(paren
id|sb
)paren
dot
id|ext_tree
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|silent
)paren
id|printk
c_func
(paren
l_string|&quot;HFS+-fs: failed to load extents file&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|cleanup
suffix:semicolon
)brace
id|HFSPLUS_SB
c_func
(paren
id|sb
)paren
dot
id|cat_tree
op_assign
id|hfs_btree_open
c_func
(paren
id|sb
comma
id|HFSPLUS_CAT_CNID
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|HFSPLUS_SB
c_func
(paren
id|sb
)paren
dot
id|cat_tree
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|silent
)paren
id|printk
c_func
(paren
l_string|&quot;HFS+-fs: failed to load catalog file&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|cleanup
suffix:semicolon
)brace
id|HFSPLUS_SB
c_func
(paren
id|sb
)paren
dot
id|alloc_file
op_assign
id|iget
c_func
(paren
id|sb
comma
id|HFSPLUS_ALLOC_CNID
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|HFSPLUS_SB
c_func
(paren
id|sb
)paren
dot
id|alloc_file
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|silent
)paren
id|printk
c_func
(paren
l_string|&quot;HFS+-fs: failed to load allocation file&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|cleanup
suffix:semicolon
)brace
multiline_comment|/* Load the root directory */
id|root
op_assign
id|iget
c_func
(paren
id|sb
comma
id|HFSPLUS_ROOT_CNID
)paren
suffix:semicolon
id|sb-&gt;s_root
op_assign
id|d_alloc_root
c_func
(paren
id|root
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sb-&gt;s_root
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|silent
)paren
id|printk
c_func
(paren
l_string|&quot;HFS+-fs: failed to load root directory&bslash;n&quot;
)paren
suffix:semicolon
id|iput
c_func
(paren
id|root
)paren
suffix:semicolon
r_goto
id|cleanup
suffix:semicolon
)brace
id|str.len
op_assign
r_sizeof
(paren
id|HFSP_HIDDENDIR_NAME
)paren
op_minus
l_int|1
suffix:semicolon
id|str.name
op_assign
id|HFSP_HIDDENDIR_NAME
suffix:semicolon
id|hfs_find_init
c_func
(paren
id|HFSPLUS_SB
c_func
(paren
id|sb
)paren
dot
id|cat_tree
comma
op_amp
id|fd
)paren
suffix:semicolon
id|hfsplus_cat_build_key
c_func
(paren
id|fd.search_key
comma
id|HFSPLUS_ROOT_CNID
comma
op_amp
id|str
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hfs_brec_read
c_func
(paren
op_amp
id|fd
comma
op_amp
id|entry
comma
r_sizeof
(paren
id|entry
)paren
)paren
)paren
(brace
id|hfs_find_exit
c_func
(paren
op_amp
id|fd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|entry.type
op_ne
id|cpu_to_be16
c_func
(paren
id|HFSPLUS_FOLDER
)paren
)paren
r_goto
id|cleanup
suffix:semicolon
id|HFSPLUS_SB
c_func
(paren
id|sb
)paren
dot
id|hidden_dir
op_assign
id|iget
c_func
(paren
id|sb
comma
id|be32_to_cpu
c_func
(paren
id|entry.folder.id
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|HFSPLUS_SB
c_func
(paren
id|sb
)paren
dot
id|hidden_dir
)paren
r_goto
id|cleanup
suffix:semicolon
)brace
r_else
id|hfs_find_exit
c_func
(paren
op_amp
id|fd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sb-&gt;s_flags
op_amp
id|MS_RDONLY
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* H+LX == hfsplusutils, H+Lx == this driver, H+lx is unused&n;&t; * all three are registered with Apple for our use&n;&t; */
id|vhdr-&gt;last_mount_vers
op_assign
id|cpu_to_be32
c_func
(paren
id|HFSP_MOUNT_VERSION
)paren
suffix:semicolon
id|vhdr-&gt;modify_date
op_assign
id|hfsp_now2mt
c_func
(paren
)paren
suffix:semicolon
id|vhdr-&gt;write_count
op_assign
id|cpu_to_be32
c_func
(paren
id|be32_to_cpu
c_func
(paren
id|vhdr-&gt;write_count
)paren
op_plus
l_int|1
)paren
suffix:semicolon
id|vhdr-&gt;attributes
op_and_assign
id|cpu_to_be32
c_func
(paren
op_complement
id|HFSPLUS_VOL_UNMNT
)paren
suffix:semicolon
id|vhdr-&gt;attributes
op_or_assign
id|cpu_to_be32
c_func
(paren
id|HFSPLUS_VOL_INCNSTNT
)paren
suffix:semicolon
id|mark_buffer_dirty
c_func
(paren
id|HFSPLUS_SB
c_func
(paren
id|sb
)paren
dot
id|s_vhbh
)paren
suffix:semicolon
id|ll_rw_block
c_func
(paren
id|WRITE
comma
l_int|1
comma
op_amp
id|HFSPLUS_SB
c_func
(paren
id|sb
)paren
dot
id|s_vhbh
)paren
suffix:semicolon
id|wait_on_buffer
c_func
(paren
id|HFSPLUS_SB
c_func
(paren
id|sb
)paren
dot
id|s_vhbh
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|HFSPLUS_SB
c_func
(paren
id|sb
)paren
dot
id|hidden_dir
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;HFS+: create hidden dir...&bslash;n&quot;
)paren
suffix:semicolon
id|HFSPLUS_SB
c_func
(paren
id|sb
)paren
dot
id|hidden_dir
op_assign
id|hfsplus_new_inode
c_func
(paren
id|sb
comma
id|S_IFDIR
)paren
suffix:semicolon
id|hfsplus_create_cat
c_func
(paren
id|HFSPLUS_SB
c_func
(paren
id|sb
)paren
dot
id|hidden_dir-&gt;i_ino
comma
id|sb-&gt;s_root-&gt;d_inode
comma
op_amp
id|str
comma
id|HFSPLUS_SB
c_func
(paren
id|sb
)paren
dot
id|hidden_dir
)paren
suffix:semicolon
id|mark_inode_dirty
c_func
(paren
id|HFSPLUS_SB
c_func
(paren
id|sb
)paren
dot
id|hidden_dir
)paren
suffix:semicolon
)brace
id|out
suffix:colon
r_return
l_int|0
suffix:semicolon
id|cleanup
suffix:colon
id|hfsplus_put_super
c_func
(paren
id|sb
)paren
suffix:semicolon
id|out2
suffix:colon
r_return
id|err
suffix:semicolon
)brace
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Brad Boyer&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Extended Macintosh Filesystem&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
DECL|variable|hfsplus_inode_cachep
r_static
id|kmem_cache_t
op_star
id|hfsplus_inode_cachep
suffix:semicolon
DECL|function|hfsplus_alloc_inode
r_static
r_struct
id|inode
op_star
id|hfsplus_alloc_inode
c_func
(paren
r_struct
id|super_block
op_star
id|sb
)paren
(brace
r_struct
id|hfsplus_inode_info
op_star
id|i
suffix:semicolon
id|i
op_assign
id|kmem_cache_alloc
c_func
(paren
id|hfsplus_inode_cachep
comma
id|SLAB_KERNEL
)paren
suffix:semicolon
r_return
id|i
ques
c_cond
op_amp
id|i-&gt;vfs_inode
suffix:colon
l_int|NULL
suffix:semicolon
)brace
DECL|function|hfsplus_destroy_inode
r_static
r_void
id|hfsplus_destroy_inode
c_func
(paren
r_struct
id|inode
op_star
id|inode
)paren
(brace
id|kmem_cache_free
c_func
(paren
id|hfsplus_inode_cachep
comma
op_amp
id|HFSPLUS_I
c_func
(paren
id|inode
)paren
)paren
suffix:semicolon
)brace
DECL|macro|HFSPLUS_INODE_SIZE
mdefine_line|#define HFSPLUS_INODE_SIZE&t;sizeof(struct hfsplus_inode_info)
DECL|function|hfsplus_get_sb
r_static
r_struct
id|super_block
op_star
id|hfsplus_get_sb
c_func
(paren
r_struct
id|file_system_type
op_star
id|fs_type
comma
r_int
id|flags
comma
r_const
r_char
op_star
id|dev_name
comma
r_void
op_star
id|data
)paren
(brace
r_return
id|get_sb_bdev
c_func
(paren
id|fs_type
comma
id|flags
comma
id|dev_name
comma
id|data
comma
id|hfsplus_fill_super
)paren
suffix:semicolon
)brace
DECL|variable|hfsplus_fs_type
r_static
r_struct
id|file_system_type
id|hfsplus_fs_type
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|name
op_assign
l_string|&quot;hfsplus&quot;
comma
dot
id|get_sb
op_assign
id|hfsplus_get_sb
comma
dot
id|kill_sb
op_assign
id|kill_block_super
comma
dot
id|fs_flags
op_assign
id|FS_REQUIRES_DEV
comma
)brace
suffix:semicolon
DECL|function|hfsplus_init_once
r_static
r_void
id|hfsplus_init_once
c_func
(paren
r_void
op_star
id|p
comma
id|kmem_cache_t
op_star
id|cachep
comma
r_int
r_int
id|flags
)paren
(brace
r_struct
id|hfsplus_inode_info
op_star
id|i
op_assign
id|p
suffix:semicolon
r_if
c_cond
(paren
(paren
id|flags
op_amp
(paren
id|SLAB_CTOR_VERIFY
op_or
id|SLAB_CTOR_CONSTRUCTOR
)paren
)paren
op_eq
id|SLAB_CTOR_CONSTRUCTOR
)paren
id|inode_init_once
c_func
(paren
op_amp
id|i-&gt;vfs_inode
)paren
suffix:semicolon
)brace
DECL|function|init_hfsplus_fs
r_static
r_int
id|__init
id|init_hfsplus_fs
c_func
(paren
r_void
)paren
(brace
r_int
id|err
suffix:semicolon
id|hfsplus_inode_cachep
op_assign
id|kmem_cache_create
c_func
(paren
l_string|&quot;hfsplus_icache&quot;
comma
id|HFSPLUS_INODE_SIZE
comma
l_int|0
comma
id|SLAB_HWCACHE_ALIGN
comma
id|hfsplus_init_once
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hfsplus_inode_cachep
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|err
op_assign
id|register_filesystem
c_func
(paren
op_amp
id|hfsplus_fs_type
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
id|kmem_cache_destroy
c_func
(paren
id|hfsplus_inode_cachep
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|exit_hfsplus_fs
r_static
r_void
id|__exit
id|exit_hfsplus_fs
c_func
(paren
r_void
)paren
(brace
id|unregister_filesystem
c_func
(paren
op_amp
id|hfsplus_fs_type
)paren
suffix:semicolon
r_if
c_cond
(paren
id|kmem_cache_destroy
c_func
(paren
id|hfsplus_inode_cachep
)paren
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;hfsplus_inode_cache: not all structures were freed&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|module_init
c_func
(paren
id|init_hfsplus_fs
)paren
id|module_exit
c_func
(paren
id|exit_hfsplus_fs
)paren
eof
