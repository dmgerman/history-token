multiline_comment|/*&n; *  linux/fs/hfsplus/options.c&n; *&n; * Copyright (C) 2001&n; * Brad Boyer (flar@allandria.com)&n; * (C) 2003 Ardis Technologies &lt;roman@ardistech.com&gt;&n; *&n; * Option parsing&n; */
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/parser.h&gt;
macro_line|#include &lt;linux/nls.h&gt;
macro_line|#include &quot;hfsplus_fs.h&quot;
r_enum
(brace
DECL|enumerator|opt_creator
DECL|enumerator|opt_type
id|opt_creator
comma
id|opt_type
comma
DECL|enumerator|opt_umask
DECL|enumerator|opt_uid
DECL|enumerator|opt_gid
id|opt_umask
comma
id|opt_uid
comma
id|opt_gid
comma
DECL|enumerator|opt_part
DECL|enumerator|opt_session
DECL|enumerator|opt_nls
id|opt_part
comma
id|opt_session
comma
id|opt_nls
comma
DECL|enumerator|opt_err
id|opt_err
)brace
suffix:semicolon
DECL|variable|tokens
r_static
id|match_table_t
id|tokens
op_assign
(brace
(brace
id|opt_creator
comma
l_string|&quot;creator=%s&quot;
)brace
comma
(brace
id|opt_type
comma
l_string|&quot;type=%s&quot;
)brace
comma
(brace
id|opt_umask
comma
l_string|&quot;umask=%o&quot;
)brace
comma
(brace
id|opt_uid
comma
l_string|&quot;uid=%u&quot;
)brace
comma
(brace
id|opt_gid
comma
l_string|&quot;gid=%u&quot;
)brace
comma
(brace
id|opt_part
comma
l_string|&quot;part=%u&quot;
)brace
comma
(brace
id|opt_session
comma
l_string|&quot;session=%u&quot;
)brace
comma
(brace
id|opt_nls
comma
l_string|&quot;nls=%s&quot;
)brace
comma
(brace
id|opt_err
comma
l_int|NULL
)brace
)brace
suffix:semicolon
multiline_comment|/* Initialize an options object to reasonable defaults */
DECL|function|fill_defaults
r_void
id|fill_defaults
c_func
(paren
r_struct
id|hfsplus_sb_info
op_star
id|opts
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|opts
)paren
r_return
suffix:semicolon
id|opts-&gt;creator
op_assign
id|HFSPLUS_DEF_CR_TYPE
suffix:semicolon
id|opts-&gt;type
op_assign
id|HFSPLUS_DEF_CR_TYPE
suffix:semicolon
id|opts-&gt;umask
op_assign
id|current-&gt;fs-&gt;umask
suffix:semicolon
id|opts-&gt;uid
op_assign
id|current-&gt;uid
suffix:semicolon
id|opts-&gt;gid
op_assign
id|current-&gt;gid
suffix:semicolon
id|opts-&gt;part
op_assign
op_minus
l_int|1
suffix:semicolon
id|opts-&gt;session
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* convert a &quot;four byte character&quot; to a 32 bit int with error checks */
DECL|function|match_fourchar
r_static
r_inline
r_int
id|match_fourchar
c_func
(paren
id|substring_t
op_star
id|arg
comma
id|u32
op_star
id|result
)paren
(brace
r_if
c_cond
(paren
id|arg-&gt;to
op_minus
id|arg-&gt;from
op_ne
l_int|4
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|memcpy
c_func
(paren
id|result
comma
id|arg-&gt;from
comma
l_int|4
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Parse options from mount. Returns 0 on failure */
multiline_comment|/* input is the options passed to mount() as a string */
DECL|function|parse_options
r_int
id|parse_options
c_func
(paren
r_char
op_star
id|input
comma
r_struct
id|hfsplus_sb_info
op_star
id|sbi
)paren
(brace
r_char
op_star
id|p
suffix:semicolon
id|substring_t
id|args
(braket
id|MAX_OPT_ARGS
)braket
suffix:semicolon
r_int
id|tmp
comma
id|token
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|input
)paren
r_goto
id|done
suffix:semicolon
r_while
c_loop
(paren
(paren
id|p
op_assign
id|strsep
c_func
(paren
op_amp
id|input
comma
l_string|&quot;,&quot;
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
op_star
id|p
)paren
r_continue
suffix:semicolon
id|token
op_assign
id|match_token
c_func
(paren
id|p
comma
id|tokens
comma
id|args
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|token
)paren
(brace
r_case
id|opt_creator
suffix:colon
r_if
c_cond
(paren
id|match_fourchar
c_func
(paren
op_amp
id|args
(braket
l_int|0
)braket
comma
op_amp
id|sbi-&gt;creator
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;HFS+-fs: creator requires a 4 character value&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|opt_type
suffix:colon
r_if
c_cond
(paren
id|match_fourchar
c_func
(paren
op_amp
id|args
(braket
l_int|0
)braket
comma
op_amp
id|sbi-&gt;type
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;HFS+-fs: type requires a 4 character value&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|opt_umask
suffix:colon
r_if
c_cond
(paren
id|match_octal
c_func
(paren
op_amp
id|args
(braket
l_int|0
)braket
comma
op_amp
id|tmp
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;HFS+-fs: umask requires a value&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|sbi-&gt;umask
op_assign
(paren
id|umode_t
)paren
id|tmp
suffix:semicolon
r_break
suffix:semicolon
r_case
id|opt_uid
suffix:colon
r_if
c_cond
(paren
id|match_int
c_func
(paren
op_amp
id|args
(braket
l_int|0
)braket
comma
op_amp
id|tmp
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;HFS+-fs: uid requires an argument&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|sbi-&gt;uid
op_assign
(paren
id|uid_t
)paren
id|tmp
suffix:semicolon
r_break
suffix:semicolon
r_case
id|opt_gid
suffix:colon
r_if
c_cond
(paren
id|match_int
c_func
(paren
op_amp
id|args
(braket
l_int|0
)braket
comma
op_amp
id|tmp
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;HFS+-fs: gid requires an argument&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|sbi-&gt;gid
op_assign
(paren
id|gid_t
)paren
id|tmp
suffix:semicolon
r_break
suffix:semicolon
r_case
id|opt_part
suffix:colon
r_if
c_cond
(paren
id|match_int
c_func
(paren
op_amp
id|args
(braket
l_int|0
)braket
comma
op_amp
id|sbi-&gt;part
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;HFS+-fs: part requires an argument&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|opt_session
suffix:colon
r_if
c_cond
(paren
id|match_int
c_func
(paren
op_amp
id|args
(braket
l_int|0
)braket
comma
op_amp
id|sbi-&gt;session
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;HFS+-fs: session requires an argument&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|opt_nls
suffix:colon
r_if
c_cond
(paren
id|sbi-&gt;nls
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;HFS+-fs: unable to change nls mapping&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|p
op_assign
id|match_strdup
c_func
(paren
op_amp
id|args
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|sbi-&gt;nls
op_assign
id|load_nls
c_func
(paren
id|p
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sbi-&gt;nls
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;HFS+-fs: unable to load nls mapping &bslash;&quot;%s&bslash;&quot;&bslash;n&quot;
comma
id|p
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|p
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|p
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
l_int|0
suffix:semicolon
)brace
)brace
id|done
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|sbi-&gt;nls
)paren
(brace
multiline_comment|/* try utf8 first, as this is the old default behaviour */
id|sbi-&gt;nls
op_assign
id|load_nls
c_func
(paren
l_string|&quot;utf8&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sbi-&gt;nls
)paren
id|sbi-&gt;nls
op_assign
id|load_nls_default
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sbi-&gt;nls
)paren
r_return
l_int|0
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
eof
