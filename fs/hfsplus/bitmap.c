multiline_comment|/*&n; *  linux/fs/hfsplus/bitmap.c&n; *&n; * Copyright (C) 2001&n; * Brad Boyer (flar@allandria.com)&n; * (C) 2003 Ardis Technologies &lt;roman@ardistech.com&gt;&n; *&n; * Handling of allocation file&n; */
macro_line|#include &lt;linux/pagemap.h&gt;
macro_line|#include &quot;hfsplus_fs.h&quot;
macro_line|#include &quot;hfsplus_raw.h&quot;
DECL|macro|PAGE_CACHE_BITS
mdefine_line|#define PAGE_CACHE_BITS&t;(PAGE_CACHE_SIZE * 8)
DECL|function|hfsplus_block_allocate
r_int
id|hfsplus_block_allocate
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
id|u32
id|size
comma
id|u32
id|offset
comma
id|u32
op_star
id|max
)paren
(brace
r_struct
id|page
op_star
id|page
suffix:semicolon
r_struct
id|address_space
op_star
id|mapping
suffix:semicolon
id|u32
op_star
id|pptr
comma
op_star
id|curr
comma
op_star
id|end
suffix:semicolon
id|u32
id|val
comma
id|mask
comma
id|start
comma
id|len
suffix:semicolon
r_int
id|i
suffix:semicolon
id|len
op_assign
op_star
id|max
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|len
)paren
r_return
id|size
suffix:semicolon
id|dprint
c_func
(paren
id|DBG_BITMAP
comma
l_string|&quot;block_allocate: %u,%u,%u&bslash;n&quot;
comma
id|size
comma
id|offset
comma
id|len
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|HFSPLUS_SB
c_func
(paren
id|sb
)paren
dot
id|alloc_file-&gt;i_sem
)paren
suffix:semicolon
id|mapping
op_assign
id|HFSPLUS_SB
c_func
(paren
id|sb
)paren
dot
id|alloc_file-&gt;i_mapping
suffix:semicolon
id|page
op_assign
id|read_cache_page
c_func
(paren
id|mapping
comma
id|offset
op_div
id|PAGE_CACHE_BITS
comma
(paren
id|filler_t
op_star
)paren
id|mapping-&gt;a_ops-&gt;readpage
comma
l_int|NULL
)paren
suffix:semicolon
id|pptr
op_assign
id|kmap
c_func
(paren
id|page
)paren
suffix:semicolon
id|curr
op_assign
id|pptr
op_plus
(paren
id|offset
op_amp
(paren
id|PAGE_CACHE_BITS
op_minus
l_int|1
)paren
)paren
op_div
l_int|32
suffix:semicolon
id|i
op_assign
id|offset
op_mod
l_int|32
suffix:semicolon
id|offset
op_and_assign
op_complement
(paren
id|PAGE_CACHE_BITS
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|size
op_xor
id|offset
)paren
op_div
id|PAGE_CACHE_BITS
)paren
id|end
op_assign
id|pptr
op_plus
id|PAGE_CACHE_BITS
op_div
l_int|32
suffix:semicolon
r_else
id|end
op_assign
id|pptr
op_plus
(paren
(paren
id|size
op_plus
l_int|31
)paren
op_amp
(paren
id|PAGE_CACHE_BITS
op_minus
l_int|1
)paren
)paren
op_div
l_int|32
suffix:semicolon
multiline_comment|/* scan the first partial u32 for zero bits */
id|val
op_assign
op_star
id|curr
suffix:semicolon
r_if
c_cond
(paren
op_complement
id|val
)paren
(brace
id|val
op_assign
id|be32_to_cpu
c_func
(paren
id|val
)paren
suffix:semicolon
id|mask
op_assign
(paren
l_int|1U
op_lshift
l_int|31
)paren
op_rshift
id|i
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|mask
op_rshift_assign
l_int|1
comma
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|val
op_amp
id|mask
)paren
)paren
r_goto
id|found
suffix:semicolon
)brace
)brace
id|curr
op_increment
suffix:semicolon
multiline_comment|/* scan complete u32s for the first zero bit */
r_while
c_loop
(paren
l_int|1
)paren
(brace
r_while
c_loop
(paren
id|curr
OL
id|end
)paren
(brace
id|val
op_assign
op_star
id|curr
suffix:semicolon
r_if
c_cond
(paren
op_complement
id|val
)paren
(brace
id|val
op_assign
id|be32_to_cpu
c_func
(paren
id|val
)paren
suffix:semicolon
id|mask
op_assign
l_int|1
op_lshift
l_int|31
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|mask
op_rshift_assign
l_int|1
comma
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|val
op_amp
id|mask
)paren
)paren
r_goto
id|found
suffix:semicolon
)brace
)brace
id|curr
op_increment
suffix:semicolon
)brace
id|kunmap
c_func
(paren
id|page
)paren
suffix:semicolon
id|offset
op_add_assign
id|PAGE_CACHE_BITS
suffix:semicolon
r_if
c_cond
(paren
id|offset
op_ge
id|size
)paren
r_break
suffix:semicolon
id|page
op_assign
id|read_cache_page
c_func
(paren
id|mapping
comma
id|offset
op_div
id|PAGE_CACHE_BITS
comma
(paren
id|filler_t
op_star
)paren
id|mapping-&gt;a_ops-&gt;readpage
comma
l_int|NULL
)paren
suffix:semicolon
id|curr
op_assign
id|pptr
op_assign
id|kmap
c_func
(paren
id|page
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|size
op_xor
id|offset
)paren
op_div
id|PAGE_CACHE_BITS
)paren
id|end
op_assign
id|pptr
op_plus
id|PAGE_CACHE_BITS
op_div
l_int|32
suffix:semicolon
r_else
id|end
op_assign
id|pptr
op_plus
(paren
(paren
id|size
op_plus
l_int|31
)paren
op_amp
(paren
id|PAGE_CACHE_BITS
op_minus
l_int|1
)paren
)paren
op_div
l_int|32
suffix:semicolon
)brace
id|dprint
c_func
(paren
id|DBG_BITMAP
comma
l_string|&quot;bitmap full&bslash;n&quot;
)paren
suffix:semicolon
id|start
op_assign
id|size
suffix:semicolon
r_goto
id|out
suffix:semicolon
id|found
suffix:colon
id|start
op_assign
id|offset
op_plus
(paren
id|curr
op_minus
id|pptr
)paren
op_star
l_int|32
op_plus
id|i
suffix:semicolon
r_if
c_cond
(paren
id|start
op_ge
id|size
)paren
(brace
id|dprint
c_func
(paren
id|DBG_BITMAP
comma
l_string|&quot;bitmap full&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* do any partial u32 at the start */
id|len
op_assign
id|min
c_func
(paren
id|size
op_minus
id|start
comma
id|len
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|val
op_or_assign
id|mask
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|i
op_ge
l_int|32
)paren
r_break
suffix:semicolon
id|mask
op_rshift_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
op_decrement
id|len
op_logical_or
id|val
op_amp
id|mask
)paren
r_goto
id|done
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
op_decrement
id|len
)paren
r_goto
id|done
suffix:semicolon
op_star
id|curr
op_increment
op_assign
id|cpu_to_be32
c_func
(paren
id|val
)paren
suffix:semicolon
multiline_comment|/* do full u32s */
r_while
c_loop
(paren
l_int|1
)paren
(brace
r_while
c_loop
(paren
id|curr
OL
id|end
)paren
(brace
id|val
op_assign
id|be32_to_cpu
c_func
(paren
op_star
id|curr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
l_int|32
)paren
r_goto
id|last
suffix:semicolon
r_if
c_cond
(paren
id|val
)paren
(brace
id|len
op_assign
l_int|32
suffix:semicolon
r_goto
id|last
suffix:semicolon
)brace
op_star
id|curr
op_increment
op_assign
l_int|0xffffffffU
suffix:semicolon
id|len
op_sub_assign
l_int|32
suffix:semicolon
)brace
id|set_page_dirty
c_func
(paren
id|page
)paren
suffix:semicolon
id|kunmap
c_func
(paren
id|page
)paren
suffix:semicolon
id|offset
op_add_assign
id|PAGE_CACHE_BITS
suffix:semicolon
id|page
op_assign
id|read_cache_page
c_func
(paren
id|mapping
comma
id|offset
op_div
id|PAGE_CACHE_BITS
comma
(paren
id|filler_t
op_star
)paren
id|mapping-&gt;a_ops-&gt;readpage
comma
l_int|NULL
)paren
suffix:semicolon
id|pptr
op_assign
id|kmap
c_func
(paren
id|page
)paren
suffix:semicolon
id|curr
op_assign
id|pptr
suffix:semicolon
id|end
op_assign
id|pptr
op_plus
id|PAGE_CACHE_BITS
op_div
l_int|32
suffix:semicolon
)brace
id|last
suffix:colon
multiline_comment|/* do any partial u32 at end */
id|mask
op_assign
l_int|1U
op_lshift
l_int|31
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|val
op_amp
id|mask
)paren
r_break
suffix:semicolon
id|val
op_or_assign
id|mask
suffix:semicolon
id|mask
op_rshift_assign
l_int|1
suffix:semicolon
)brace
id|done
suffix:colon
op_star
id|curr
op_assign
id|cpu_to_be32
c_func
(paren
id|val
)paren
suffix:semicolon
id|set_page_dirty
c_func
(paren
id|page
)paren
suffix:semicolon
id|kunmap
c_func
(paren
id|page
)paren
suffix:semicolon
op_star
id|max
op_assign
id|offset
op_plus
(paren
id|curr
op_minus
id|pptr
)paren
op_star
l_int|32
op_plus
id|i
op_minus
id|start
suffix:semicolon
id|HFSPLUS_SB
c_func
(paren
id|sb
)paren
dot
id|free_blocks
op_sub_assign
op_star
id|max
suffix:semicolon
id|sb-&gt;s_dirt
op_assign
l_int|1
suffix:semicolon
id|dprint
c_func
(paren
id|DBG_BITMAP
comma
l_string|&quot;-&gt; %u,%u&bslash;n&quot;
comma
id|start
comma
op_star
id|max
)paren
suffix:semicolon
id|out
suffix:colon
id|up
c_func
(paren
op_amp
id|HFSPLUS_SB
c_func
(paren
id|sb
)paren
dot
id|alloc_file-&gt;i_sem
)paren
suffix:semicolon
r_return
id|start
suffix:semicolon
)brace
DECL|function|hfsplus_block_free
r_int
id|hfsplus_block_free
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
id|u32
id|offset
comma
id|u32
id|count
)paren
(brace
r_struct
id|page
op_star
id|page
suffix:semicolon
r_struct
id|address_space
op_star
id|mapping
suffix:semicolon
id|u32
op_star
id|pptr
comma
op_star
id|curr
comma
op_star
id|end
suffix:semicolon
id|u32
id|mask
comma
id|len
comma
id|pnr
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* is there any actual work to be done? */
r_if
c_cond
(paren
op_logical_neg
id|count
)paren
r_return
l_int|0
suffix:semicolon
id|dprint
c_func
(paren
id|DBG_BITMAP
comma
l_string|&quot;block_free: %u,%u&bslash;n&quot;
comma
id|offset
comma
id|count
)paren
suffix:semicolon
multiline_comment|/* are all of the bits in range? */
r_if
c_cond
(paren
(paren
id|offset
op_plus
id|count
)paren
OG
id|HFSPLUS_SB
c_func
(paren
id|sb
)paren
dot
id|total_blocks
)paren
r_return
op_minus
l_int|2
suffix:semicolon
id|down
c_func
(paren
op_amp
id|HFSPLUS_SB
c_func
(paren
id|sb
)paren
dot
id|alloc_file-&gt;i_sem
)paren
suffix:semicolon
id|mapping
op_assign
id|HFSPLUS_SB
c_func
(paren
id|sb
)paren
dot
id|alloc_file-&gt;i_mapping
suffix:semicolon
id|pnr
op_assign
id|offset
op_div
id|PAGE_CACHE_BITS
suffix:semicolon
id|page
op_assign
id|read_cache_page
c_func
(paren
id|mapping
comma
id|pnr
comma
(paren
id|filler_t
op_star
)paren
id|mapping-&gt;a_ops-&gt;readpage
comma
l_int|NULL
)paren
suffix:semicolon
id|pptr
op_assign
id|kmap
c_func
(paren
id|page
)paren
suffix:semicolon
id|curr
op_assign
id|pptr
op_plus
(paren
id|offset
op_amp
(paren
id|PAGE_CACHE_BITS
op_minus
l_int|1
)paren
)paren
op_div
l_int|32
suffix:semicolon
id|end
op_assign
id|pptr
op_plus
id|PAGE_CACHE_BITS
op_div
l_int|32
suffix:semicolon
id|len
op_assign
id|count
suffix:semicolon
multiline_comment|/* do any partial u32 at the start */
id|i
op_assign
id|offset
op_mod
l_int|32
suffix:semicolon
r_if
c_cond
(paren
id|i
)paren
(brace
r_int
id|j
op_assign
l_int|32
op_minus
id|i
suffix:semicolon
id|mask
op_assign
l_int|0xffffffffU
op_lshift
id|j
suffix:semicolon
r_if
c_cond
(paren
id|j
OG
id|count
)paren
(brace
id|mask
op_or_assign
l_int|0xffffffffU
op_rshift
(paren
id|i
op_plus
id|count
)paren
suffix:semicolon
op_star
id|curr
op_increment
op_and_assign
id|cpu_to_be32
c_func
(paren
id|mask
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
op_star
id|curr
op_increment
op_and_assign
id|cpu_to_be32
c_func
(paren
id|mask
)paren
suffix:semicolon
id|count
op_sub_assign
id|j
suffix:semicolon
)brace
multiline_comment|/* do full u32s */
r_while
c_loop
(paren
l_int|1
)paren
(brace
r_while
c_loop
(paren
id|curr
OL
id|end
)paren
(brace
r_if
c_cond
(paren
id|count
OL
l_int|32
)paren
r_goto
id|done
suffix:semicolon
op_star
id|curr
op_increment
op_assign
l_int|0
suffix:semicolon
id|count
op_sub_assign
l_int|32
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|count
)paren
r_break
suffix:semicolon
id|set_page_dirty
c_func
(paren
id|page
)paren
suffix:semicolon
id|kunmap
c_func
(paren
id|page
)paren
suffix:semicolon
id|page
op_assign
id|read_cache_page
c_func
(paren
id|mapping
comma
op_increment
id|pnr
comma
(paren
id|filler_t
op_star
)paren
id|mapping-&gt;a_ops-&gt;readpage
comma
l_int|NULL
)paren
suffix:semicolon
id|pptr
op_assign
id|kmap
c_func
(paren
id|page
)paren
suffix:semicolon
id|curr
op_assign
id|pptr
suffix:semicolon
id|end
op_assign
id|pptr
op_plus
id|PAGE_CACHE_BITS
op_div
l_int|32
suffix:semicolon
)brace
id|done
suffix:colon
multiline_comment|/* do any partial u32 at end */
r_if
c_cond
(paren
id|count
)paren
(brace
id|mask
op_assign
l_int|0xffffffffU
op_rshift
id|count
suffix:semicolon
op_star
id|curr
op_and_assign
id|cpu_to_be32
c_func
(paren
id|mask
)paren
suffix:semicolon
)brace
id|out
suffix:colon
id|set_page_dirty
c_func
(paren
id|page
)paren
suffix:semicolon
id|kunmap
c_func
(paren
id|page
)paren
suffix:semicolon
id|HFSPLUS_SB
c_func
(paren
id|sb
)paren
dot
id|free_blocks
op_add_assign
id|len
suffix:semicolon
id|sb-&gt;s_dirt
op_assign
l_int|1
suffix:semicolon
id|up
c_func
(paren
op_amp
id|HFSPLUS_SB
c_func
(paren
id|sb
)paren
dot
id|alloc_file-&gt;i_sem
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
eof
