multiline_comment|/*&n; *  fs/partitions/sun.c&n; *&n; *  Code extracted from drivers/block/genhd.c&n; *&n; *  Copyright (C) 1991-1998  Linus Torvalds&n; *  Re-organised Feb 1998 Russell King&n; */
macro_line|#include &quot;check.h&quot;
macro_line|#include &quot;sun.h&quot;
DECL|function|sun_partition
r_int
id|sun_partition
c_func
(paren
r_struct
id|parsed_partitions
op_star
id|state
comma
r_struct
id|block_device
op_star
id|bdev
)paren
(brace
r_int
id|i
suffix:semicolon
id|__be16
id|csum
suffix:semicolon
r_int
id|slot
op_assign
l_int|1
suffix:semicolon
id|__be16
op_star
id|ush
suffix:semicolon
id|Sector
id|sect
suffix:semicolon
r_struct
id|sun_disklabel
(brace
r_int
r_char
id|info
(braket
l_int|128
)braket
suffix:semicolon
multiline_comment|/* Informative text string */
r_int
r_char
id|spare0
(braket
l_int|14
)braket
suffix:semicolon
r_struct
id|sun_info
(brace
r_int
r_char
id|spare1
suffix:semicolon
r_int
r_char
id|id
suffix:semicolon
r_int
r_char
id|spare2
suffix:semicolon
r_int
r_char
id|flags
suffix:semicolon
)brace
id|infos
(braket
l_int|8
)braket
suffix:semicolon
r_int
r_char
id|spare
(braket
l_int|246
)braket
suffix:semicolon
multiline_comment|/* Boot information etc. */
id|__be16
id|rspeed
suffix:semicolon
multiline_comment|/* Disk rotational speed */
id|__be16
id|pcylcount
suffix:semicolon
multiline_comment|/* Physical cylinder count */
id|__be16
id|sparecyl
suffix:semicolon
multiline_comment|/* extra sects per cylinder */
r_int
r_char
id|spare2
(braket
l_int|4
)braket
suffix:semicolon
multiline_comment|/* More magic... */
id|__be16
id|ilfact
suffix:semicolon
multiline_comment|/* Interleave factor */
id|__be16
id|ncyl
suffix:semicolon
multiline_comment|/* Data cylinder count */
id|__be16
id|nacyl
suffix:semicolon
multiline_comment|/* Alt. cylinder count */
id|__be16
id|ntrks
suffix:semicolon
multiline_comment|/* Tracks per cylinder */
id|__be16
id|nsect
suffix:semicolon
multiline_comment|/* Sectors per track */
r_int
r_char
id|spare3
(braket
l_int|4
)braket
suffix:semicolon
multiline_comment|/* Even more magic... */
r_struct
id|sun_partition
(brace
id|__be32
id|start_cylinder
suffix:semicolon
id|__be32
id|num_sectors
suffix:semicolon
)brace
id|partitions
(braket
l_int|8
)braket
suffix:semicolon
id|__be16
id|magic
suffix:semicolon
multiline_comment|/* Magic number */
id|__be16
id|csum
suffix:semicolon
multiline_comment|/* Label xor&squot;d checksum */
)brace
op_star
id|label
suffix:semicolon
r_struct
id|sun_partition
op_star
id|p
suffix:semicolon
r_int
r_int
id|spc
suffix:semicolon
r_char
id|b
(braket
id|BDEVNAME_SIZE
)braket
suffix:semicolon
id|label
op_assign
(paren
r_struct
id|sun_disklabel
op_star
)paren
id|read_dev_sector
c_func
(paren
id|bdev
comma
l_int|0
comma
op_amp
id|sect
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|label
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|p
op_assign
id|label-&gt;partitions
suffix:semicolon
r_if
c_cond
(paren
id|be16_to_cpu
c_func
(paren
id|label-&gt;magic
)paren
op_ne
id|SUN_LABEL_MAGIC
)paren
(brace
multiline_comment|/*&t;&t;printk(KERN_INFO &quot;Dev %s Sun disklabel: bad magic %04x&bslash;n&quot;,&n;&t;&t;       bdevname(bdev, b), be16_to_cpu(label-&gt;magic)); */
id|put_dev_sector
c_func
(paren
id|sect
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Look at the checksum */
id|ush
op_assign
(paren
(paren
id|__be16
op_star
)paren
(paren
id|label
op_plus
l_int|1
)paren
)paren
op_minus
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|csum
op_assign
l_int|0
suffix:semicolon
id|ush
op_ge
(paren
(paren
id|__be16
op_star
)paren
id|label
)paren
suffix:semicolon
)paren
id|csum
op_xor_assign
op_star
id|ush
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|csum
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Dev %s Sun disklabel: Csum bad, label corrupted&bslash;n&quot;
comma
id|bdevname
c_func
(paren
id|bdev
comma
id|b
)paren
)paren
suffix:semicolon
id|put_dev_sector
c_func
(paren
id|sect
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* All Sun disks have 8 partition entries */
id|spc
op_assign
id|be16_to_cpu
c_func
(paren
id|label-&gt;ntrks
)paren
op_star
id|be16_to_cpu
c_func
(paren
id|label-&gt;nsect
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|8
suffix:semicolon
id|i
op_increment
comma
id|p
op_increment
)paren
(brace
r_int
r_int
id|st_sector
suffix:semicolon
r_int
id|num_sectors
suffix:semicolon
id|st_sector
op_assign
id|be32_to_cpu
c_func
(paren
id|p-&gt;start_cylinder
)paren
op_star
id|spc
suffix:semicolon
id|num_sectors
op_assign
id|be32_to_cpu
c_func
(paren
id|p-&gt;num_sectors
)paren
suffix:semicolon
r_if
c_cond
(paren
id|num_sectors
)paren
(brace
id|put_partition
c_func
(paren
id|state
comma
id|slot
comma
id|st_sector
comma
id|num_sectors
)paren
suffix:semicolon
r_if
c_cond
(paren
id|label-&gt;infos
(braket
id|i
)braket
dot
id|id
op_eq
id|LINUX_RAID_PARTITION
)paren
id|state-&gt;parts
(braket
id|slot
)braket
dot
id|flags
op_assign
l_int|1
suffix:semicolon
)brace
id|slot
op_increment
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|put_dev_sector
c_func
(paren
id|sect
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
eof
