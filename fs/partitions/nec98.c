multiline_comment|/*&n; *  NEC PC-9800 series partition supports&n; *&n; *  Copyright (C) 1999&t;Kyoto University Microcomputer Club&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/genhd.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/hdreg.h&gt;
macro_line|#include &quot;check.h&quot;
macro_line|#include &quot;nec98.h&quot;
DECL|struct|nec98_partition
r_struct
id|nec98_partition
(brace
DECL|member|mid
id|__u8
id|mid
suffix:semicolon
multiline_comment|/* 0x80 - active */
DECL|member|sid
id|__u8
id|sid
suffix:semicolon
multiline_comment|/* 0x80 - bootable */
DECL|member|pad1
id|__u16
id|pad1
suffix:semicolon
multiline_comment|/* dummy for padding */
DECL|member|ipl_sector
id|__u8
id|ipl_sector
suffix:semicolon
multiline_comment|/* IPL sector&t;*/
DECL|member|ipl_head
id|__u8
id|ipl_head
suffix:semicolon
multiline_comment|/* IPL head&t;*/
DECL|member|ipl_cyl
id|__u16
id|ipl_cyl
suffix:semicolon
multiline_comment|/* IPL cylinder&t;*/
DECL|member|sector
id|__u8
id|sector
suffix:semicolon
multiline_comment|/* starting sector&t;*/
DECL|member|head
id|__u8
id|head
suffix:semicolon
multiline_comment|/* starting head&t;*/
DECL|member|cyl
id|__u16
id|cyl
suffix:semicolon
multiline_comment|/* starting cylinder&t;*/
DECL|member|end_sector
id|__u8
id|end_sector
suffix:semicolon
multiline_comment|/* end sector&t;*/
DECL|member|end_head
id|__u8
id|end_head
suffix:semicolon
multiline_comment|/* end head&t;*/
DECL|member|end_cyl
id|__u16
id|end_cyl
suffix:semicolon
multiline_comment|/* end cylinder&t;*/
DECL|member|name
r_int
r_char
id|name
(braket
l_int|16
)braket
suffix:semicolon
)brace
id|__attribute__
c_func
(paren
(paren
id|__packed__
)paren
)paren
suffix:semicolon
DECL|macro|NEC98_BSD_PARTITION_MID
mdefine_line|#define NEC98_BSD_PARTITION_MID 0x14
DECL|macro|NEC98_BSD_PARTITION_SID
mdefine_line|#define NEC98_BSD_PARTITION_SID 0x44
DECL|macro|MID_SID_16
mdefine_line|#define MID_SID_16(mid, sid)&t;(((mid) &amp; 0xFF) | (((sid) &amp; 0xFF) &lt;&lt; 8))
DECL|macro|NEC98_BSD_PARTITION_MID_SID
mdefine_line|#define NEC98_BSD_PARTITION_MID_SID&t;&bslash;&n;&t;MID_SID_16(NEC98_BSD_PARTITION_MID, NEC98_BSD_PARTITION_SID)
DECL|macro|NEC98_VALID_PTABLE_ENTRY
mdefine_line|#define NEC98_VALID_PTABLE_ENTRY(P) &bslash;&n;&t;(!(P)-&gt;pad1 &amp;&amp; (P)-&gt;cyl &lt;= (P)-&gt;end_cyl)
r_extern
r_int
id|pc98_bios_param
c_func
(paren
r_struct
id|block_device
op_star
id|bdev
comma
r_int
op_star
id|ip
)paren
suffix:semicolon
r_static
r_inline
r_int
DECL|function|is_valid_nec98_partition_table
id|is_valid_nec98_partition_table
c_func
(paren
r_const
r_struct
id|nec98_partition
op_star
id|ptable
comma
id|__u8
id|nsectors
comma
id|__u8
id|nheads
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
id|valid
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|16
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
op_star
(paren
id|__u16
op_star
)paren
op_amp
id|ptable
(braket
id|i
)braket
)paren
r_continue
suffix:semicolon
multiline_comment|/* empty slot */
r_if
c_cond
(paren
id|ptable
(braket
id|i
)braket
dot
id|pad1
multiline_comment|/* `pad1&squot; contains junk */
op_logical_or
id|ptable
(braket
id|i
)braket
dot
id|ipl_sector
op_ge
id|nsectors
op_logical_or
id|ptable
(braket
id|i
)braket
dot
id|sector
op_ge
id|nsectors
op_logical_or
id|ptable
(braket
id|i
)braket
dot
id|end_sector
op_ge
id|nsectors
op_logical_or
id|ptable
(braket
id|i
)braket
dot
id|ipl_head
op_ge
id|nheads
op_logical_or
id|ptable
(braket
id|i
)braket
dot
id|head
op_ge
id|nheads
op_logical_or
id|ptable
(braket
id|i
)braket
dot
id|end_head
op_ge
id|nheads
op_logical_or
id|ptable
(braket
id|i
)braket
dot
id|cyl
OG
id|ptable
(braket
id|i
)braket
dot
id|end_cyl
)paren
r_return
l_int|0
suffix:semicolon
id|valid
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* We have a valid partition.  */
)brace
multiline_comment|/* If no valid PC-9800-style partitions found,&n;&t;   the disk may have other type of partition table.  */
r_return
id|valid
suffix:semicolon
)brace
DECL|function|nec98_partition
r_int
id|nec98_partition
c_func
(paren
r_struct
id|parsed_partitions
op_star
id|state
comma
r_struct
id|block_device
op_star
id|bdev
)paren
(brace
r_int
r_int
id|nr
suffix:semicolon
r_struct
id|hd_geometry
id|geo
suffix:semicolon
id|Sector
id|sect
suffix:semicolon
r_const
r_struct
id|nec98_partition
op_star
id|part
suffix:semicolon
r_int
r_char
op_star
id|data
suffix:semicolon
r_int
id|sector_size
op_assign
id|bdev_hardsect_size
c_func
(paren
id|bdev
)paren
suffix:semicolon
r_int
id|major
op_assign
id|MAJOR
c_func
(paren
id|bdev-&gt;bd_dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ioctl_by_bdev
c_func
(paren
id|bdev
comma
id|HDIO_GETGEO
comma
(paren
r_int
r_int
)paren
op_amp
id|geo
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot; unsupported disk (major = %u)&bslash;n&quot;
comma
id|major
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#ifdef NEC98_PARTITION_DEBUG
id|printk
c_func
(paren
l_string|&quot;ioctl_by_bdev head=%d sect=%d&bslash;n&quot;
comma
id|geo.heads
comma
id|geo.sectors
)paren
suffix:semicolon
macro_line|#endif
id|data
op_assign
id|read_dev_sector
c_func
(paren
id|bdev
comma
l_int|0
comma
op_amp
id|sect
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|data
)paren
(brace
r_if
c_cond
(paren
id|warn_no_part
)paren
id|printk
c_func
(paren
l_string|&quot; unable to read partition table&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* magic(?) check */
r_if
c_cond
(paren
op_star
(paren
id|__u16
op_star
)paren
(paren
id|data
op_plus
id|sector_size
op_minus
l_int|2
)paren
op_ne
id|NEC98_PTABLE_MAGIC
)paren
(brace
id|put_dev_sector
c_func
(paren
id|sect
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|put_dev_sector
c_func
(paren
id|sect
)paren
suffix:semicolon
id|data
op_assign
id|read_dev_sector
c_func
(paren
id|bdev
comma
l_int|1
comma
op_amp
id|sect
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|data
)paren
(brace
r_if
c_cond
(paren
id|warn_no_part
)paren
id|printk
c_func
(paren
l_string|&quot; unable to read partition table&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|is_valid_nec98_partition_table
c_func
(paren
(paren
r_struct
id|nec98_partition
op_star
)paren
id|data
comma
id|geo.sectors
comma
id|geo.heads
)paren
)paren
(brace
macro_line|#ifdef NEC98_PARTITION_DEBUG
r_if
c_cond
(paren
id|warn_no_part
)paren
id|printk
c_func
(paren
l_string|&quot; partition table consistency check failed&quot;
l_string|&quot; (not PC-9800 disk?)&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
id|put_dev_sector
c_func
(paren
id|sect
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|part
op_assign
(paren
r_const
r_struct
id|nec98_partition
op_star
)paren
id|data
suffix:semicolon
r_for
c_loop
(paren
id|nr
op_assign
l_int|0
suffix:semicolon
id|nr
OL
l_int|16
suffix:semicolon
id|nr
op_increment
comma
id|part
op_increment
)paren
(brace
r_int
r_int
id|start_sect
comma
id|end_sect
suffix:semicolon
r_if
c_cond
(paren
id|part-&gt;mid
op_eq
l_int|0
op_logical_or
id|part-&gt;sid
op_eq
l_int|0
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|nr
)paren
id|printk
c_func
(paren
l_string|&quot;     &quot;
)paren
suffix:semicolon
(brace
multiline_comment|/* Print partition name. Fdisk98 might put NUL&n;&t;&t;&t;   characters in partition name... */
r_int
id|j
suffix:semicolon
r_int
r_char
op_star
id|p
suffix:semicolon
r_int
r_char
id|buf
(braket
r_sizeof
(paren
id|part-&gt;name
)paren
op_star
l_int|2
op_plus
l_int|1
)braket
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
id|buf
comma
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
r_sizeof
(paren
id|part-&gt;name
)paren
suffix:semicolon
id|j
op_increment
comma
id|p
op_increment
)paren
r_if
c_cond
(paren
(paren
op_star
id|p
op_assign
id|part-&gt;name
(braket
id|j
)braket
)paren
OL
l_char|&squot; &squot;
)paren
(brace
op_star
id|p
op_increment
op_assign
l_char|&squot;^&squot;
suffix:semicolon
op_star
id|p
op_assign
id|part-&gt;name
(braket
id|j
)braket
op_plus
l_char|&squot;@&squot;
suffix:semicolon
)brace
op_star
id|p
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot; &lt;%s&gt;&quot;
comma
id|buf
)paren
suffix:semicolon
)brace
id|start_sect
op_assign
(paren
id|part-&gt;cyl
op_star
id|geo.heads
op_plus
id|part-&gt;head
)paren
op_star
id|geo.sectors
op_plus
id|part-&gt;sector
suffix:semicolon
id|end_sect
op_assign
(paren
id|part-&gt;end_cyl
op_plus
l_int|1
)paren
op_star
id|geo.heads
op_star
id|geo.sectors
suffix:semicolon
r_if
c_cond
(paren
id|end_sect
op_le
id|start_sect
)paren
(brace
id|printk
c_func
(paren
l_string|&quot; (invalid partition info)&bslash;n&quot;
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|put_partition
c_func
(paren
id|state
comma
id|nr
op_plus
l_int|1
comma
id|start_sect
comma
id|end_sect
op_minus
id|start_sect
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_BSD_DISKLABEL
r_if
c_cond
(paren
(paren
op_star
(paren
id|__u16
op_star
)paren
op_amp
id|part-&gt;mid
op_amp
l_int|0x7F7F
)paren
op_eq
id|NEC98_BSD_PARTITION_MID_SID
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;!&quot;
)paren
suffix:semicolon
multiline_comment|/* NEC98_BSD_PARTITION_MID_SID is not valid SYSIND for&n;&t;&t;&t;   IBM PC&squot;s MS-DOS partition table, so we simply pass&n;&t;&t;&t;   it to bsd_disklabel_partition;&n;&t;&t;&t;   it will just print `&lt;bsd: ... &gt;&squot;. */
id|parse_bsd
c_func
(paren
id|state
comma
id|bdev
comma
id|start_sect
comma
id|end_sect
op_minus
id|start_sect
comma
id|nr
op_plus
l_int|1
comma
l_string|&quot;bsd98&quot;
comma
id|BSD_MAXPARTITIONS
)paren
suffix:semicolon
)brace
macro_line|#endif
(brace
multiline_comment|/* Pretty size printing. */
multiline_comment|/* XXX sector size? */
r_int
r_int
id|psize
op_assign
(paren
id|end_sect
op_minus
id|start_sect
)paren
op_div
l_int|2
suffix:semicolon
r_int
id|unit_char
op_assign
l_char|&squot;K&squot;
suffix:semicolon
r_if
c_cond
(paren
id|psize
OG
l_int|99999
)paren
(brace
id|psize
op_rshift_assign
l_int|10
suffix:semicolon
id|unit_char
op_assign
l_char|&squot;M&squot;
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot; %5d%cB (%5d-%5d)&bslash;n&quot;
comma
id|psize
comma
id|unit_char
comma
id|part-&gt;cyl
comma
id|part-&gt;end_cyl
)paren
suffix:semicolon
)brace
)brace
id|put_dev_sector
c_func
(paren
id|sect
)paren
suffix:semicolon
r_return
id|nr
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
)brace
"&f;"
multiline_comment|/*&n; * Local variables:&n; * c-basic-offset: 8&n; * End:&n; */
eof
