multiline_comment|/*&n; *  fs/partitions/mac.c&n; *&n; *  Code extracted from drivers/block/genhd.c&n; *  Copyright (C) 1991-1998  Linus Torvalds&n; *  Re-organised Feb 1998 Russell King&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/ctype.h&gt;
macro_line|#include &quot;check.h&quot;
macro_line|#include &quot;mac.h&quot;
macro_line|#ifdef CONFIG_PPC_PMAC
r_extern
r_void
id|note_bootable_part
c_func
(paren
id|dev_t
id|dev
comma
r_int
id|part
comma
r_int
id|goodness
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n; * Code to understand MacOS partition tables.&n; */
DECL|function|mac_fix_string
r_static
r_inline
r_void
id|mac_fix_string
c_func
(paren
r_char
op_star
id|stg
comma
r_int
id|len
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|len
op_minus
l_int|1
suffix:semicolon
id|i
op_ge
l_int|0
op_logical_and
id|stg
(braket
id|i
)braket
op_eq
l_char|&squot; &squot;
suffix:semicolon
id|i
op_decrement
)paren
id|stg
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|mac_partition
r_int
id|mac_partition
c_func
(paren
r_struct
id|parsed_partitions
op_star
id|state
comma
r_struct
id|block_device
op_star
id|bdev
)paren
(brace
r_int
id|slot
op_assign
l_int|1
suffix:semicolon
id|Sector
id|sect
suffix:semicolon
r_int
r_char
op_star
id|data
suffix:semicolon
r_int
id|blk
comma
id|blocks_in_map
suffix:semicolon
r_int
id|secsize
suffix:semicolon
macro_line|#ifdef CONFIG_PPC_PMAC
r_int
id|found_root
op_assign
l_int|0
suffix:semicolon
r_int
id|found_root_goodness
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
r_struct
id|mac_partition
op_star
id|part
suffix:semicolon
r_struct
id|mac_driver_desc
op_star
id|md
suffix:semicolon
multiline_comment|/* Get 0th block and look at the first partition map entry. */
id|md
op_assign
(paren
r_struct
id|mac_driver_desc
op_star
)paren
id|read_dev_sector
c_func
(paren
id|bdev
comma
l_int|0
comma
op_amp
id|sect
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|md
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|be16_to_cpu
c_func
(paren
id|md-&gt;signature
)paren
op_ne
id|MAC_DRIVER_MAGIC
)paren
(brace
id|put_dev_sector
c_func
(paren
id|sect
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|secsize
op_assign
id|be16_to_cpu
c_func
(paren
id|md-&gt;block_size
)paren
suffix:semicolon
id|put_dev_sector
c_func
(paren
id|sect
)paren
suffix:semicolon
id|data
op_assign
id|read_dev_sector
c_func
(paren
id|bdev
comma
id|secsize
op_div
l_int|512
comma
op_amp
id|sect
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|data
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|part
op_assign
(paren
r_struct
id|mac_partition
op_star
)paren
(paren
id|data
op_plus
id|secsize
op_mod
l_int|512
)paren
suffix:semicolon
r_if
c_cond
(paren
id|be16_to_cpu
c_func
(paren
id|part-&gt;signature
)paren
op_ne
id|MAC_PARTITION_MAGIC
)paren
(brace
id|put_dev_sector
c_func
(paren
id|sect
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
multiline_comment|/* not a MacOS disk */
)brace
id|printk
c_func
(paren
l_string|&quot; [mac]&quot;
)paren
suffix:semicolon
id|blocks_in_map
op_assign
id|be32_to_cpu
c_func
(paren
id|part-&gt;map_count
)paren
suffix:semicolon
r_for
c_loop
(paren
id|blk
op_assign
l_int|1
suffix:semicolon
id|blk
op_le
id|blocks_in_map
suffix:semicolon
op_increment
id|blk
)paren
(brace
r_int
id|pos
op_assign
id|blk
op_star
id|secsize
suffix:semicolon
id|put_dev_sector
c_func
(paren
id|sect
)paren
suffix:semicolon
id|data
op_assign
id|read_dev_sector
c_func
(paren
id|bdev
comma
id|pos
op_div
l_int|512
comma
op_amp
id|sect
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|data
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|part
op_assign
(paren
r_struct
id|mac_partition
op_star
)paren
(paren
id|data
op_plus
id|pos
op_mod
l_int|512
)paren
suffix:semicolon
r_if
c_cond
(paren
id|be16_to_cpu
c_func
(paren
id|part-&gt;signature
)paren
op_ne
id|MAC_PARTITION_MAGIC
)paren
r_break
suffix:semicolon
id|put_partition
c_func
(paren
id|state
comma
id|slot
comma
id|be32_to_cpu
c_func
(paren
id|part-&gt;start_block
)paren
op_star
(paren
id|secsize
op_div
l_int|512
)paren
comma
id|be32_to_cpu
c_func
(paren
id|part-&gt;block_count
)paren
op_star
(paren
id|secsize
op_div
l_int|512
)paren
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_PPC_PMAC
multiline_comment|/*&n;&t;&t; * If this is the first bootable partition, tell the&n;&t;&t; * setup code, in case it wants to make this the root.&n;&t;&t; */
r_if
c_cond
(paren
id|_machine
op_eq
id|_MACH_Pmac
)paren
(brace
r_int
id|goodness
op_assign
l_int|0
suffix:semicolon
id|mac_fix_string
c_func
(paren
id|part-&gt;processor
comma
l_int|16
)paren
suffix:semicolon
id|mac_fix_string
c_func
(paren
id|part-&gt;name
comma
l_int|32
)paren
suffix:semicolon
id|mac_fix_string
c_func
(paren
id|part-&gt;type
comma
l_int|32
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|be32_to_cpu
c_func
(paren
id|part-&gt;status
)paren
op_amp
id|MAC_STATUS_BOOTABLE
)paren
op_logical_and
id|strcasecmp
c_func
(paren
id|part-&gt;processor
comma
l_string|&quot;powerpc&quot;
)paren
op_eq
l_int|0
)paren
id|goodness
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|strcasecmp
c_func
(paren
id|part-&gt;type
comma
l_string|&quot;Apple_UNIX_SVR2&quot;
)paren
op_eq
l_int|0
op_logical_or
(paren
id|strnicmp
c_func
(paren
id|part-&gt;type
comma
l_string|&quot;Linux&quot;
comma
l_int|5
)paren
op_eq
l_int|0
op_logical_and
id|strcasecmp
c_func
(paren
id|part-&gt;type
comma
l_string|&quot;Linux_swap&quot;
)paren
op_ne
l_int|0
)paren
)paren
(brace
r_int
id|i
comma
id|l
suffix:semicolon
id|goodness
op_increment
suffix:semicolon
id|l
op_assign
id|strlen
c_func
(paren
id|part-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|part-&gt;name
comma
l_string|&quot;/&quot;
)paren
op_eq
l_int|0
)paren
id|goodness
op_increment
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
op_le
id|l
op_minus
l_int|4
suffix:semicolon
op_increment
id|i
)paren
(brace
r_if
c_cond
(paren
id|strnicmp
c_func
(paren
id|part-&gt;name
op_plus
id|i
comma
l_string|&quot;root&quot;
comma
l_int|4
)paren
op_eq
l_int|0
)paren
(brace
id|goodness
op_add_assign
l_int|2
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|strnicmp
c_func
(paren
id|part-&gt;name
comma
l_string|&quot;swap&quot;
comma
l_int|4
)paren
op_eq
l_int|0
)paren
id|goodness
op_decrement
suffix:semicolon
)brace
r_if
c_cond
(paren
id|goodness
OG
id|found_root_goodness
)paren
(brace
id|found_root
op_assign
id|blk
suffix:semicolon
id|found_root_goodness
op_assign
id|goodness
suffix:semicolon
)brace
)brace
macro_line|#endif /* CONFIG_PPC_PMAC */
op_increment
id|slot
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_PPC_PMAC
r_if
c_cond
(paren
id|found_root_goodness
)paren
id|note_bootable_part
c_func
(paren
id|bdev-&gt;bd_dev
comma
id|found_root
comma
id|found_root_goodness
)paren
suffix:semicolon
macro_line|#endif
id|put_dev_sector
c_func
(paren
id|sect
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
eof
