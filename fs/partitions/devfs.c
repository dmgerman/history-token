multiline_comment|/*&n; * This tries to keep block devices away from devfs as much as possible.&n; */
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/devfs_fs_kernel.h&gt;
macro_line|#include &lt;linux/vmalloc.h&gt;
macro_line|#include &lt;linux/genhd.h&gt;
macro_line|#include &lt;linux/bitops.h&gt;
macro_line|#include &lt;asm/semaphore.h&gt;
DECL|struct|unique_numspace
r_struct
id|unique_numspace
(brace
DECL|member|num_free
id|u32
id|num_free
suffix:semicolon
multiline_comment|/*  Num free in bits       */
DECL|member|length
id|u32
id|length
suffix:semicolon
multiline_comment|/*  Array length in bytes  */
DECL|member|bits
r_int
r_int
op_star
id|bits
suffix:semicolon
DECL|member|mutex
r_struct
id|semaphore
id|mutex
suffix:semicolon
)brace
suffix:semicolon
r_static
id|DECLARE_MUTEX
c_func
(paren
id|numspace_mutex
)paren
suffix:semicolon
DECL|function|expand_numspace
r_static
r_int
id|expand_numspace
c_func
(paren
r_struct
id|unique_numspace
op_star
id|s
)paren
(brace
id|u32
id|length
suffix:semicolon
r_void
op_star
id|bits
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;length
OL
l_int|16
)paren
id|length
op_assign
l_int|16
suffix:semicolon
r_else
id|length
op_assign
id|s-&gt;length
op_lshift
l_int|1
suffix:semicolon
id|bits
op_assign
id|vmalloc
c_func
(paren
id|length
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bits
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;bits
)paren
(brace
id|memcpy
c_func
(paren
id|bits
comma
id|s-&gt;bits
comma
id|s-&gt;length
)paren
suffix:semicolon
id|vfree
c_func
(paren
id|s-&gt;bits
)paren
suffix:semicolon
)brace
id|s-&gt;num_free
op_assign
(paren
id|length
op_minus
id|s-&gt;length
)paren
op_lshift
l_int|3
suffix:semicolon
id|s-&gt;bits
op_assign
id|bits
suffix:semicolon
id|memset
c_func
(paren
id|bits
op_plus
id|s-&gt;length
comma
l_int|0
comma
id|length
op_minus
id|s-&gt;length
)paren
suffix:semicolon
id|s-&gt;length
op_assign
id|length
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|alloc_unique_number
r_static
r_int
id|alloc_unique_number
c_func
(paren
r_struct
id|unique_numspace
op_star
id|s
)paren
(brace
r_int
id|rval
op_assign
l_int|0
suffix:semicolon
id|down
c_func
(paren
op_amp
id|numspace_mutex
)paren
suffix:semicolon
r_if
c_cond
(paren
id|s-&gt;num_free
OL
l_int|1
)paren
id|rval
op_assign
id|expand_numspace
c_func
(paren
id|s
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rval
)paren
(brace
id|rval
op_assign
id|find_first_zero_bit
c_func
(paren
id|s-&gt;bits
comma
id|s-&gt;length
op_lshift
l_int|3
)paren
suffix:semicolon
op_decrement
id|s-&gt;num_free
suffix:semicolon
id|__set_bit
c_func
(paren
id|rval
comma
id|s-&gt;bits
)paren
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|numspace_mutex
)paren
suffix:semicolon
r_return
id|rval
suffix:semicolon
)brace
DECL|function|dealloc_unique_number
r_static
r_void
id|dealloc_unique_number
c_func
(paren
r_struct
id|unique_numspace
op_star
id|s
comma
r_int
id|number
)paren
(brace
r_int
id|old_val
suffix:semicolon
r_if
c_cond
(paren
id|number
op_ge
l_int|0
)paren
(brace
id|down
c_func
(paren
op_amp
id|numspace_mutex
)paren
suffix:semicolon
id|old_val
op_assign
id|__test_and_clear_bit
c_func
(paren
id|number
comma
id|s-&gt;bits
)paren
suffix:semicolon
r_if
c_cond
(paren
id|old_val
)paren
op_increment
id|s-&gt;num_free
suffix:semicolon
id|up
c_func
(paren
op_amp
id|numspace_mutex
)paren
suffix:semicolon
)brace
)brace
DECL|variable|disc_numspace
r_static
r_struct
id|unique_numspace
id|disc_numspace
suffix:semicolon
DECL|variable|cdrom_numspace
r_static
r_struct
id|unique_numspace
id|cdrom_numspace
suffix:semicolon
DECL|function|devfs_add_partitioned
r_void
id|devfs_add_partitioned
c_func
(paren
r_struct
id|gendisk
op_star
id|disk
)paren
(brace
r_char
id|dirname
(braket
l_int|64
)braket
comma
id|symlink
(braket
l_int|16
)braket
suffix:semicolon
id|devfs_mk_dir
c_func
(paren
id|disk-&gt;devfs_name
)paren
suffix:semicolon
id|devfs_mk_bdev
c_func
(paren
id|MKDEV
c_func
(paren
id|disk-&gt;major
comma
id|disk-&gt;first_minor
)paren
comma
id|S_IFBLK
op_or
id|S_IRUSR
op_or
id|S_IWUSR
comma
l_string|&quot;%s/disc&quot;
comma
id|disk-&gt;devfs_name
)paren
suffix:semicolon
id|disk-&gt;number
op_assign
id|alloc_unique_number
c_func
(paren
op_amp
id|disc_numspace
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|symlink
comma
l_string|&quot;discs/disc%d&quot;
comma
id|disk-&gt;number
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|dirname
comma
l_string|&quot;../%s&quot;
comma
id|disk-&gt;devfs_name
)paren
suffix:semicolon
id|devfs_mk_symlink
c_func
(paren
id|symlink
comma
id|dirname
)paren
suffix:semicolon
)brace
DECL|function|devfs_add_disk
r_void
id|devfs_add_disk
c_func
(paren
r_struct
id|gendisk
op_star
id|disk
)paren
(brace
id|devfs_mk_bdev
c_func
(paren
id|MKDEV
c_func
(paren
id|disk-&gt;major
comma
id|disk-&gt;first_minor
)paren
comma
(paren
id|disk-&gt;flags
op_amp
id|GENHD_FL_CD
)paren
ques
c_cond
id|S_IFBLK
op_or
id|S_IRUGO
op_or
id|S_IWUGO
suffix:colon
id|S_IFBLK
op_or
id|S_IRUSR
op_or
id|S_IWUSR
comma
l_string|&quot;%s&quot;
comma
id|disk-&gt;devfs_name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|disk-&gt;flags
op_amp
id|GENHD_FL_CD
)paren
(brace
r_char
id|dirname
(braket
l_int|64
)braket
comma
id|symlink
(braket
l_int|16
)braket
suffix:semicolon
id|disk-&gt;number
op_assign
id|alloc_unique_number
c_func
(paren
op_amp
id|cdrom_numspace
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|symlink
comma
l_string|&quot;cdroms/cdrom%d&quot;
comma
id|disk-&gt;number
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|dirname
comma
l_string|&quot;../%s&quot;
comma
id|disk-&gt;devfs_name
)paren
suffix:semicolon
id|devfs_mk_symlink
c_func
(paren
id|symlink
comma
id|dirname
)paren
suffix:semicolon
)brace
)brace
DECL|function|devfs_remove_disk
r_void
id|devfs_remove_disk
c_func
(paren
r_struct
id|gendisk
op_star
id|disk
)paren
(brace
r_if
c_cond
(paren
id|disk-&gt;minors
op_ne
l_int|1
)paren
(brace
id|devfs_remove
c_func
(paren
l_string|&quot;discs/disc%d&quot;
comma
id|disk-&gt;number
)paren
suffix:semicolon
id|dealloc_unique_number
c_func
(paren
op_amp
id|disc_numspace
comma
id|disk-&gt;number
)paren
suffix:semicolon
id|devfs_remove
c_func
(paren
l_string|&quot;%s/disc&quot;
comma
id|disk-&gt;devfs_name
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|disk-&gt;flags
op_amp
id|GENHD_FL_CD
)paren
(brace
id|devfs_remove
c_func
(paren
l_string|&quot;cdroms/cdrom%d&quot;
comma
id|disk-&gt;number
)paren
suffix:semicolon
id|dealloc_unique_number
c_func
(paren
op_amp
id|cdrom_numspace
comma
id|disk-&gt;number
)paren
suffix:semicolon
)brace
id|devfs_remove
c_func
(paren
id|disk-&gt;devfs_name
)paren
suffix:semicolon
)brace
eof
