multiline_comment|/*&n; *  linux/fs/ext3/super.c&n; *&n; * Copyright (C) 1992, 1993, 1994, 1995&n; * Remy Card (card@masi.ibp.fr)&n; * Laboratoire MASI - Institut Blaise Pascal&n; * Universite Pierre et Marie Curie (Paris VI)&n; *&n; *  from&n; *&n; *  linux/fs/minix/inode.c&n; *&n; *  Copyright (C) 1991, 1992  Linus Torvalds&n; *&n; *  Big-endian to little-endian byte-swapping/bitmaps by&n; *        David S. Miller (davem@caip.rutgers.edu), 1995&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/time.h&gt;
macro_line|#include &lt;linux/jbd.h&gt;
macro_line|#include &lt;linux/ext3_fs.h&gt;
macro_line|#include &lt;linux/ext3_jbd.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/blkdev.h&gt;
macro_line|#include &lt;linux/parser.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/buffer_head.h&gt;
macro_line|#include &lt;linux/vfs.h&gt;
macro_line|#include &lt;linux/random.h&gt;
macro_line|#include &lt;linux/mount.h&gt;
macro_line|#include &lt;linux/namei.h&gt;
macro_line|#include &lt;linux/quotaops.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &quot;xattr.h&quot;
macro_line|#include &quot;acl.h&quot;
r_static
r_int
id|ext3_load_journal
c_func
(paren
r_struct
id|super_block
op_star
comma
r_struct
id|ext3_super_block
op_star
)paren
suffix:semicolon
r_static
r_int
id|ext3_create_journal
c_func
(paren
r_struct
id|super_block
op_star
comma
r_struct
id|ext3_super_block
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_void
id|ext3_commit_super
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|ext3_super_block
op_star
id|es
comma
r_int
id|sync
)paren
suffix:semicolon
r_static
r_void
id|ext3_mark_recovery_complete
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|ext3_super_block
op_star
id|es
)paren
suffix:semicolon
r_static
r_void
id|ext3_clear_journal_err
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|ext3_super_block
op_star
id|es
)paren
suffix:semicolon
r_static
r_int
id|ext3_sync_fs
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_int
id|wait
)paren
suffix:semicolon
multiline_comment|/* &n; * Wrappers for journal_start/end.&n; *&n; * The only special thing we need to do here is to make sure that all&n; * journal_end calls result in the superblock being marked dirty, so&n; * that sync() will call the filesystem&squot;s write_super callback if&n; * appropriate. &n; */
DECL|function|ext3_journal_start_sb
id|handle_t
op_star
id|ext3_journal_start_sb
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_int
id|nblocks
)paren
(brace
id|journal_t
op_star
id|journal
suffix:semicolon
r_if
c_cond
(paren
id|sb-&gt;s_flags
op_amp
id|MS_RDONLY
)paren
r_return
id|ERR_PTR
c_func
(paren
op_minus
id|EROFS
)paren
suffix:semicolon
multiline_comment|/* Special case here: if the journal has aborted behind our&n;&t; * backs (eg. EIO in the commit thread), then we still need to&n;&t; * take the FS itself readonly cleanly. */
id|journal
op_assign
id|EXT3_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|s_journal
suffix:semicolon
r_if
c_cond
(paren
id|is_journal_aborted
c_func
(paren
id|journal
)paren
)paren
(brace
id|ext3_abort
c_func
(paren
id|sb
comma
id|__FUNCTION__
comma
l_string|&quot;Detected aborted journal&quot;
)paren
suffix:semicolon
r_return
id|ERR_PTR
c_func
(paren
op_minus
id|EROFS
)paren
suffix:semicolon
)brace
r_return
id|journal_start
c_func
(paren
id|journal
comma
id|nblocks
)paren
suffix:semicolon
)brace
multiline_comment|/* &n; * The only special thing we need to do here is to make sure that all&n; * journal_stop calls result in the superblock being marked dirty, so&n; * that sync() will call the filesystem&squot;s write_super callback if&n; * appropriate. &n; */
DECL|function|__ext3_journal_stop
r_int
id|__ext3_journal_stop
c_func
(paren
r_const
r_char
op_star
id|where
comma
id|handle_t
op_star
id|handle
)paren
(brace
r_struct
id|super_block
op_star
id|sb
suffix:semicolon
r_int
id|err
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|sb
op_assign
id|handle-&gt;h_transaction-&gt;t_journal-&gt;j_private
suffix:semicolon
id|err
op_assign
id|handle-&gt;h_err
suffix:semicolon
id|rc
op_assign
id|journal_stop
c_func
(paren
id|handle
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|err
)paren
id|err
op_assign
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
id|__ext3_std_error
c_func
(paren
id|sb
comma
id|where
comma
id|err
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|ext3_journal_abort_handle
r_void
id|ext3_journal_abort_handle
c_func
(paren
r_const
r_char
op_star
id|caller
comma
r_const
r_char
op_star
id|err_fn
comma
r_struct
id|buffer_head
op_star
id|bh
comma
id|handle_t
op_star
id|handle
comma
r_int
id|err
)paren
(brace
r_char
id|nbuf
(braket
l_int|16
)braket
suffix:semicolon
r_const
r_char
op_star
id|errstr
op_assign
id|ext3_decode_error
c_func
(paren
l_int|NULL
comma
id|err
comma
id|nbuf
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: aborting transaction: %s in %s&quot;
comma
id|caller
comma
id|errstr
comma
id|err_fn
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bh
)paren
id|BUFFER_TRACE
c_func
(paren
id|bh
comma
l_string|&quot;abort&quot;
)paren
suffix:semicolon
id|journal_abort_handle
c_func
(paren
id|handle
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|handle-&gt;h_err
)paren
id|handle-&gt;h_err
op_assign
id|err
suffix:semicolon
)brace
multiline_comment|/* Deal with the reporting of failure conditions on a filesystem such as&n; * inconsistencies detected or read IO failures.&n; *&n; * On ext2, we can store the error state of the filesystem in the&n; * superblock.  That is not possible on ext3, because we may have other&n; * write ordering constraints on the superblock which prevent us from&n; * writing it out straight away; and given that the journal is about to&n; * be aborted, we can&squot;t rely on the current, or future, transactions to&n; * write out the superblock safely.&n; *&n; * We&squot;ll just use the journal_abort() error code to record an error in&n; * the journal instead.  On recovery, the journal will compain about&n; * that error until we&squot;ve noted it down and cleared it.&n; */
DECL|function|ext3_handle_error
r_static
r_void
id|ext3_handle_error
c_func
(paren
r_struct
id|super_block
op_star
id|sb
)paren
(brace
r_struct
id|ext3_super_block
op_star
id|es
op_assign
id|EXT3_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|s_es
suffix:semicolon
id|EXT3_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|s_mount_state
op_or_assign
id|EXT3_ERROR_FS
suffix:semicolon
id|es-&gt;s_state
op_or_assign
id|cpu_to_le16
c_func
(paren
id|EXT3_ERROR_FS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sb-&gt;s_flags
op_amp
id|MS_RDONLY
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|test_opt
(paren
id|sb
comma
id|ERRORS_PANIC
)paren
)paren
id|panic
(paren
l_string|&quot;EXT3-fs (device %s): panic forced after error&bslash;n&quot;
comma
id|sb-&gt;s_id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|test_opt
(paren
id|sb
comma
id|ERRORS_RO
)paren
)paren
(brace
id|printk
(paren
id|KERN_CRIT
l_string|&quot;Remounting filesystem read-only&bslash;n&quot;
)paren
suffix:semicolon
id|sb-&gt;s_flags
op_or_assign
id|MS_RDONLY
suffix:semicolon
)brace
r_else
(brace
id|journal_t
op_star
id|journal
op_assign
id|EXT3_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|s_journal
suffix:semicolon
id|EXT3_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|s_mount_opt
op_or_assign
id|EXT3_MOUNT_ABORT
suffix:semicolon
r_if
c_cond
(paren
id|journal
)paren
id|journal_abort
c_func
(paren
id|journal
comma
op_minus
id|EIO
)paren
suffix:semicolon
)brace
id|ext3_commit_super
c_func
(paren
id|sb
comma
id|es
comma
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|ext3_error
r_void
id|ext3_error
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_const
r_char
op_star
id|function
comma
r_const
r_char
op_star
id|fmt
comma
dot
dot
dot
)paren
(brace
id|va_list
id|args
suffix:semicolon
id|va_start
c_func
(paren
id|args
comma
id|fmt
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;EXT3-fs error (device %s): %s: &quot;
comma
id|sb-&gt;s_id
comma
id|function
)paren
suffix:semicolon
id|vprintk
c_func
(paren
id|fmt
comma
id|args
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|va_end
c_func
(paren
id|args
)paren
suffix:semicolon
id|ext3_handle_error
c_func
(paren
id|sb
)paren
suffix:semicolon
)brace
DECL|function|ext3_decode_error
r_const
r_char
op_star
id|ext3_decode_error
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_int
id|errno
comma
r_char
id|nbuf
(braket
l_int|16
)braket
)paren
(brace
r_char
op_star
id|errstr
op_assign
l_int|NULL
suffix:semicolon
r_switch
c_cond
(paren
id|errno
)paren
(brace
r_case
op_minus
id|EIO
suffix:colon
id|errstr
op_assign
l_string|&quot;IO failure&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
op_minus
id|ENOMEM
suffix:colon
id|errstr
op_assign
l_string|&quot;Out of memory&quot;
suffix:semicolon
r_break
suffix:semicolon
r_case
op_minus
id|EROFS
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|sb
op_logical_or
id|EXT3_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|s_journal-&gt;j_flags
op_amp
id|JFS_ABORT
)paren
id|errstr
op_assign
l_string|&quot;Journal has aborted&quot;
suffix:semicolon
r_else
id|errstr
op_assign
l_string|&quot;Readonly filesystem&quot;
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
multiline_comment|/* If the caller passed in an extra buffer for unknown&n;&t;&t; * errors, textualise them now.  Else we just return&n;&t;&t; * NULL. */
r_if
c_cond
(paren
id|nbuf
)paren
(brace
multiline_comment|/* Check for truncated error codes... */
r_if
c_cond
(paren
id|snprintf
c_func
(paren
id|nbuf
comma
l_int|16
comma
l_string|&quot;error %d&quot;
comma
op_minus
id|errno
)paren
op_ge
l_int|0
)paren
id|errstr
op_assign
id|nbuf
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_return
id|errstr
suffix:semicolon
)brace
multiline_comment|/* __ext3_std_error decodes expected errors from journaling functions&n; * automatically and invokes the appropriate error response.  */
DECL|function|__ext3_std_error
r_void
id|__ext3_std_error
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_const
r_char
op_star
id|function
comma
r_int
id|errno
)paren
(brace
r_char
id|nbuf
(braket
l_int|16
)braket
suffix:semicolon
r_const
r_char
op_star
id|errstr
op_assign
id|ext3_decode_error
c_func
(paren
id|sb
comma
id|errno
comma
id|nbuf
)paren
suffix:semicolon
id|printk
(paren
id|KERN_CRIT
l_string|&quot;EXT3-fs error (device %s) in %s: %s&bslash;n&quot;
comma
id|sb-&gt;s_id
comma
id|function
comma
id|errstr
)paren
suffix:semicolon
id|ext3_handle_error
c_func
(paren
id|sb
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * ext3_abort is a much stronger failure handler than ext3_error.  The&n; * abort function may be used to deal with unrecoverable failures such&n; * as journal IO errors or ENOMEM at a critical moment in log management.&n; *&n; * We unconditionally force the filesystem into an ABORT|READONLY state,&n; * unless the error response on the fs has been set to panic in which&n; * case we take the easy way out and panic immediately.&n; */
DECL|function|ext3_abort
r_void
id|ext3_abort
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_const
r_char
op_star
id|function
comma
r_const
r_char
op_star
id|fmt
comma
dot
dot
dot
)paren
(brace
id|va_list
id|args
suffix:semicolon
id|printk
(paren
id|KERN_CRIT
l_string|&quot;ext3_abort called.&bslash;n&quot;
)paren
suffix:semicolon
id|va_start
c_func
(paren
id|args
comma
id|fmt
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;EXT3-fs error (device %s): %s: &quot;
comma
id|sb-&gt;s_id
comma
id|function
)paren
suffix:semicolon
id|vprintk
c_func
(paren
id|fmt
comma
id|args
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|va_end
c_func
(paren
id|args
)paren
suffix:semicolon
r_if
c_cond
(paren
id|test_opt
c_func
(paren
id|sb
comma
id|ERRORS_PANIC
)paren
)paren
id|panic
c_func
(paren
l_string|&quot;EXT3-fs panic from previous error&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sb-&gt;s_flags
op_amp
id|MS_RDONLY
)paren
r_return
suffix:semicolon
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;Remounting filesystem read-only&bslash;n&quot;
)paren
suffix:semicolon
id|EXT3_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|s_mount_state
op_or_assign
id|EXT3_ERROR_FS
suffix:semicolon
id|sb-&gt;s_flags
op_or_assign
id|MS_RDONLY
suffix:semicolon
id|EXT3_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|s_mount_opt
op_or_assign
id|EXT3_MOUNT_ABORT
suffix:semicolon
id|journal_abort
c_func
(paren
id|EXT3_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|s_journal
comma
op_minus
id|EIO
)paren
suffix:semicolon
)brace
multiline_comment|/* Deal with the reporting of failure conditions while running, such as&n; * inconsistencies in operation or invalid system states.&n; *&n; * Use ext3_error() for cases of invalid filesystem states, as that will&n; * record an error on disk and force a filesystem check on the next boot.&n; */
DECL|function|ext3_panic
id|NORET_TYPE
r_void
id|ext3_panic
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_const
r_char
op_star
id|function
comma
r_const
r_char
op_star
id|fmt
comma
dot
dot
dot
)paren
(brace
id|va_list
id|args
suffix:semicolon
id|va_start
c_func
(paren
id|args
comma
id|fmt
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;EXT3-fs error (device %s): %s: &quot;
comma
id|sb-&gt;s_id
comma
id|function
)paren
suffix:semicolon
id|vprintk
c_func
(paren
id|fmt
comma
id|args
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|va_end
c_func
(paren
id|args
)paren
suffix:semicolon
multiline_comment|/* this is to prevent panic from syncing this filesystem */
multiline_comment|/* AKPM: is this sufficient? */
id|sb-&gt;s_flags
op_or_assign
id|MS_RDONLY
suffix:semicolon
id|panic
(paren
l_string|&quot;EXT3-fs panic forced&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|ext3_warning
r_void
id|ext3_warning
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_const
r_char
op_star
id|function
comma
r_const
r_char
op_star
id|fmt
comma
dot
dot
dot
)paren
(brace
id|va_list
id|args
suffix:semicolon
id|va_start
c_func
(paren
id|args
comma
id|fmt
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;EXT3-fs warning (device %s): %s: &quot;
comma
id|sb-&gt;s_id
comma
id|function
)paren
suffix:semicolon
id|vprintk
c_func
(paren
id|fmt
comma
id|args
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|va_end
c_func
(paren
id|args
)paren
suffix:semicolon
)brace
DECL|function|ext3_update_dynamic_rev
r_void
id|ext3_update_dynamic_rev
c_func
(paren
r_struct
id|super_block
op_star
id|sb
)paren
(brace
r_struct
id|ext3_super_block
op_star
id|es
op_assign
id|EXT3_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|s_es
suffix:semicolon
r_if
c_cond
(paren
id|le32_to_cpu
c_func
(paren
id|es-&gt;s_rev_level
)paren
OG
id|EXT3_GOOD_OLD_REV
)paren
r_return
suffix:semicolon
id|ext3_warning
c_func
(paren
id|sb
comma
id|__FUNCTION__
comma
l_string|&quot;updating to rev %d because of new feature flag, &quot;
l_string|&quot;running e2fsck is recommended&quot;
comma
id|EXT3_DYNAMIC_REV
)paren
suffix:semicolon
id|es-&gt;s_first_ino
op_assign
id|cpu_to_le32
c_func
(paren
id|EXT3_GOOD_OLD_FIRST_INO
)paren
suffix:semicolon
id|es-&gt;s_inode_size
op_assign
id|cpu_to_le16
c_func
(paren
id|EXT3_GOOD_OLD_INODE_SIZE
)paren
suffix:semicolon
id|es-&gt;s_rev_level
op_assign
id|cpu_to_le32
c_func
(paren
id|EXT3_DYNAMIC_REV
)paren
suffix:semicolon
multiline_comment|/* leave es-&gt;s_feature_*compat flags alone */
multiline_comment|/* es-&gt;s_uuid will be set by e2fsck if empty */
multiline_comment|/*&n;&t; * The rest of the superblock fields should be zero, and if not it&n;&t; * means they are likely already in use, so leave them alone.  We&n;&t; * can leave it up to e2fsck to clean up any inconsistencies there.&n;&t; */
)brace
multiline_comment|/*&n; * Open the external journal device&n; */
DECL|function|ext3_blkdev_get
r_static
r_struct
id|block_device
op_star
id|ext3_blkdev_get
c_func
(paren
id|dev_t
id|dev
)paren
(brace
r_struct
id|block_device
op_star
id|bdev
suffix:semicolon
r_char
id|b
(braket
id|BDEVNAME_SIZE
)braket
suffix:semicolon
id|bdev
op_assign
id|open_by_devnum
c_func
(paren
id|dev
comma
id|FMODE_READ
op_or
id|FMODE_WRITE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|bdev
)paren
)paren
r_goto
id|fail
suffix:semicolon
r_return
id|bdev
suffix:semicolon
id|fail
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;EXT3: failed to open journal device %s: %ld&bslash;n&quot;
comma
id|__bdevname
c_func
(paren
id|dev
comma
id|b
)paren
comma
id|PTR_ERR
c_func
(paren
id|bdev
)paren
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; * Release the journal device&n; */
DECL|function|ext3_blkdev_put
r_static
r_int
id|ext3_blkdev_put
c_func
(paren
r_struct
id|block_device
op_star
id|bdev
)paren
(brace
id|bd_release
c_func
(paren
id|bdev
)paren
suffix:semicolon
r_return
id|blkdev_put
c_func
(paren
id|bdev
)paren
suffix:semicolon
)brace
DECL|function|ext3_blkdev_remove
r_static
r_int
id|ext3_blkdev_remove
c_func
(paren
r_struct
id|ext3_sb_info
op_star
id|sbi
)paren
(brace
r_struct
id|block_device
op_star
id|bdev
suffix:semicolon
r_int
id|ret
op_assign
op_minus
id|ENODEV
suffix:semicolon
id|bdev
op_assign
id|sbi-&gt;journal_bdev
suffix:semicolon
r_if
c_cond
(paren
id|bdev
)paren
(brace
id|ret
op_assign
id|ext3_blkdev_put
c_func
(paren
id|bdev
)paren
suffix:semicolon
id|sbi-&gt;journal_bdev
op_assign
l_int|NULL
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
DECL|function|orphan_list_entry
r_static
r_inline
r_struct
id|inode
op_star
id|orphan_list_entry
c_func
(paren
r_struct
id|list_head
op_star
id|l
)paren
(brace
r_return
op_amp
id|list_entry
c_func
(paren
id|l
comma
r_struct
id|ext3_inode_info
comma
id|i_orphan
)paren
op_member_access_from_pointer
id|vfs_inode
suffix:semicolon
)brace
DECL|function|dump_orphan_list
r_static
r_void
id|dump_orphan_list
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|ext3_sb_info
op_star
id|sbi
)paren
(brace
r_struct
id|list_head
op_star
id|l
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;sb orphan head is %d&bslash;n&quot;
comma
id|le32_to_cpu
c_func
(paren
id|sbi-&gt;s_es-&gt;s_last_orphan
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;sb_info orphan list:&bslash;n&quot;
)paren
suffix:semicolon
id|list_for_each
c_func
(paren
id|l
comma
op_amp
id|sbi-&gt;s_orphan
)paren
(brace
r_struct
id|inode
op_star
id|inode
op_assign
id|orphan_list_entry
c_func
(paren
id|l
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;  &quot;
l_string|&quot;inode %s:%ld at %p: mode %o, nlink %d, next %d&bslash;n&quot;
comma
id|inode-&gt;i_sb-&gt;s_id
comma
id|inode-&gt;i_ino
comma
id|inode
comma
id|inode-&gt;i_mode
comma
id|inode-&gt;i_nlink
comma
id|NEXT_ORPHAN
c_func
(paren
id|inode
)paren
)paren
suffix:semicolon
)brace
)brace
DECL|function|ext3_put_super
r_void
id|ext3_put_super
(paren
r_struct
id|super_block
op_star
id|sb
)paren
(brace
r_struct
id|ext3_sb_info
op_star
id|sbi
op_assign
id|EXT3_SB
c_func
(paren
id|sb
)paren
suffix:semicolon
r_struct
id|ext3_super_block
op_star
id|es
op_assign
id|sbi-&gt;s_es
suffix:semicolon
r_int
id|i
suffix:semicolon
id|ext3_xattr_put_super
c_func
(paren
id|sb
)paren
suffix:semicolon
id|journal_destroy
c_func
(paren
id|sbi-&gt;s_journal
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|sb-&gt;s_flags
op_amp
id|MS_RDONLY
)paren
)paren
(brace
id|EXT3_CLEAR_INCOMPAT_FEATURE
c_func
(paren
id|sb
comma
id|EXT3_FEATURE_INCOMPAT_RECOVER
)paren
suffix:semicolon
id|es-&gt;s_state
op_assign
id|cpu_to_le16
c_func
(paren
id|sbi-&gt;s_mount_state
)paren
suffix:semicolon
id|BUFFER_TRACE
c_func
(paren
id|sbi-&gt;s_sbh
comma
l_string|&quot;marking dirty&quot;
)paren
suffix:semicolon
id|mark_buffer_dirty
c_func
(paren
id|sbi-&gt;s_sbh
)paren
suffix:semicolon
id|ext3_commit_super
c_func
(paren
id|sb
comma
id|es
comma
l_int|1
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|sbi-&gt;s_gdb_count
suffix:semicolon
id|i
op_increment
)paren
id|brelse
c_func
(paren
id|sbi-&gt;s_group_desc
(braket
id|i
)braket
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|sbi-&gt;s_group_desc
)paren
suffix:semicolon
id|percpu_counter_destroy
c_func
(paren
op_amp
id|sbi-&gt;s_freeblocks_counter
)paren
suffix:semicolon
id|percpu_counter_destroy
c_func
(paren
op_amp
id|sbi-&gt;s_freeinodes_counter
)paren
suffix:semicolon
id|percpu_counter_destroy
c_func
(paren
op_amp
id|sbi-&gt;s_dirs_counter
)paren
suffix:semicolon
id|brelse
c_func
(paren
id|sbi-&gt;s_sbh
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_QUOTA
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAXQUOTAS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|sbi-&gt;s_qf_names
(braket
id|i
)braket
)paren
id|kfree
c_func
(paren
id|sbi-&gt;s_qf_names
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* Debugging code just in case the in-memory inode orphan list&n;&t; * isn&squot;t empty.  The on-disk one can be non-empty if we&squot;ve&n;&t; * detected an error and taken the fs readonly, but the&n;&t; * in-memory list had better be clean by this point. */
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|sbi-&gt;s_orphan
)paren
)paren
id|dump_orphan_list
c_func
(paren
id|sb
comma
id|sbi
)paren
suffix:semicolon
id|J_ASSERT
c_func
(paren
id|list_empty
c_func
(paren
op_amp
id|sbi-&gt;s_orphan
)paren
)paren
suffix:semicolon
id|invalidate_bdev
c_func
(paren
id|sb-&gt;s_bdev
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sbi-&gt;journal_bdev
op_logical_and
id|sbi-&gt;journal_bdev
op_ne
id|sb-&gt;s_bdev
)paren
(brace
multiline_comment|/*&n;&t;&t; * Invalidate the journal device&squot;s buffers.  We don&squot;t want them&n;&t;&t; * floating about in memory - the physical journal device may&n;&t;&t; * hotswapped, and it breaks the `ro-after&squot; testing code.&n;&t;&t; */
id|sync_blockdev
c_func
(paren
id|sbi-&gt;journal_bdev
)paren
suffix:semicolon
id|invalidate_bdev
c_func
(paren
id|sbi-&gt;journal_bdev
comma
l_int|0
)paren
suffix:semicolon
id|ext3_blkdev_remove
c_func
(paren
id|sbi
)paren
suffix:semicolon
)brace
id|sb-&gt;s_fs_info
op_assign
l_int|NULL
suffix:semicolon
id|kfree
c_func
(paren
id|sbi
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|variable|ext3_inode_cachep
r_static
id|kmem_cache_t
op_star
id|ext3_inode_cachep
suffix:semicolon
multiline_comment|/*&n; * Called inside transaction, so use GFP_NOFS&n; */
DECL|function|ext3_alloc_inode
r_static
r_struct
id|inode
op_star
id|ext3_alloc_inode
c_func
(paren
r_struct
id|super_block
op_star
id|sb
)paren
(brace
r_struct
id|ext3_inode_info
op_star
id|ei
suffix:semicolon
id|ei
op_assign
id|kmem_cache_alloc
c_func
(paren
id|ext3_inode_cachep
comma
id|SLAB_NOFS
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ei
)paren
r_return
l_int|NULL
suffix:semicolon
macro_line|#ifdef CONFIG_EXT3_FS_POSIX_ACL
id|ei-&gt;i_acl
op_assign
id|EXT3_ACL_NOT_CACHED
suffix:semicolon
id|ei-&gt;i_default_acl
op_assign
id|EXT3_ACL_NOT_CACHED
suffix:semicolon
macro_line|#endif
id|ei-&gt;i_rsv_window.rsv_end
op_assign
id|EXT3_RESERVE_WINDOW_NOT_ALLOCATED
suffix:semicolon
id|ei-&gt;vfs_inode.i_version
op_assign
l_int|1
suffix:semicolon
r_return
op_amp
id|ei-&gt;vfs_inode
suffix:semicolon
)brace
DECL|function|ext3_destroy_inode
r_static
r_void
id|ext3_destroy_inode
c_func
(paren
r_struct
id|inode
op_star
id|inode
)paren
(brace
id|kmem_cache_free
c_func
(paren
id|ext3_inode_cachep
comma
id|EXT3_I
c_func
(paren
id|inode
)paren
)paren
suffix:semicolon
)brace
DECL|function|init_once
r_static
r_void
id|init_once
c_func
(paren
r_void
op_star
id|foo
comma
id|kmem_cache_t
op_star
id|cachep
comma
r_int
r_int
id|flags
)paren
(brace
r_struct
id|ext3_inode_info
op_star
id|ei
op_assign
(paren
r_struct
id|ext3_inode_info
op_star
)paren
id|foo
suffix:semicolon
r_if
c_cond
(paren
(paren
id|flags
op_amp
(paren
id|SLAB_CTOR_VERIFY
op_or
id|SLAB_CTOR_CONSTRUCTOR
)paren
)paren
op_eq
id|SLAB_CTOR_CONSTRUCTOR
)paren
(brace
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|ei-&gt;i_orphan
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_EXT3_FS_XATTR
id|init_rwsem
c_func
(paren
op_amp
id|ei-&gt;xattr_sem
)paren
suffix:semicolon
macro_line|#endif
id|init_MUTEX
c_func
(paren
op_amp
id|ei-&gt;truncate_sem
)paren
suffix:semicolon
id|inode_init_once
c_func
(paren
op_amp
id|ei-&gt;vfs_inode
)paren
suffix:semicolon
)brace
)brace
DECL|function|init_inodecache
r_static
r_int
id|init_inodecache
c_func
(paren
r_void
)paren
(brace
id|ext3_inode_cachep
op_assign
id|kmem_cache_create
c_func
(paren
l_string|&quot;ext3_inode_cache&quot;
comma
r_sizeof
(paren
r_struct
id|ext3_inode_info
)paren
comma
l_int|0
comma
id|SLAB_RECLAIM_ACCOUNT
comma
id|init_once
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ext3_inode_cachep
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|destroy_inodecache
r_static
r_void
id|destroy_inodecache
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|kmem_cache_destroy
c_func
(paren
id|ext3_inode_cachep
)paren
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;ext3_inode_cache: not all structures were freed&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|ext3_clear_inode
r_static
r_void
id|ext3_clear_inode
c_func
(paren
r_struct
id|inode
op_star
id|inode
)paren
(brace
macro_line|#ifdef CONFIG_EXT3_FS_POSIX_ACL
r_if
c_cond
(paren
id|EXT3_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|i_acl
op_logical_and
id|EXT3_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|i_acl
op_ne
id|EXT3_ACL_NOT_CACHED
)paren
(brace
id|posix_acl_release
c_func
(paren
id|EXT3_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|i_acl
)paren
suffix:semicolon
id|EXT3_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|i_acl
op_assign
id|EXT3_ACL_NOT_CACHED
suffix:semicolon
)brace
r_if
c_cond
(paren
id|EXT3_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|i_default_acl
op_logical_and
id|EXT3_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|i_default_acl
op_ne
id|EXT3_ACL_NOT_CACHED
)paren
(brace
id|posix_acl_release
c_func
(paren
id|EXT3_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|i_default_acl
)paren
suffix:semicolon
id|EXT3_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|i_default_acl
op_assign
id|EXT3_ACL_NOT_CACHED
suffix:semicolon
)brace
macro_line|#endif
id|ext3_discard_reservation
c_func
(paren
id|inode
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_QUOTA
DECL|macro|QTYPE2NAME
mdefine_line|#define QTYPE2NAME(t) ((t)==USRQUOTA?&quot;user&quot;:&quot;group&quot;)
DECL|macro|QTYPE2MOPT
mdefine_line|#define QTYPE2MOPT(on, t) ((t)==USRQUOTA?((on)##USRJQUOTA):((on)##GRPJQUOTA))
r_static
r_int
id|ext3_dquot_initialize
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_int
id|type
)paren
suffix:semicolon
r_static
r_int
id|ext3_dquot_drop
c_func
(paren
r_struct
id|inode
op_star
id|inode
)paren
suffix:semicolon
r_static
r_int
id|ext3_write_dquot
c_func
(paren
r_struct
id|dquot
op_star
id|dquot
)paren
suffix:semicolon
r_static
r_int
id|ext3_acquire_dquot
c_func
(paren
r_struct
id|dquot
op_star
id|dquot
)paren
suffix:semicolon
r_static
r_int
id|ext3_release_dquot
c_func
(paren
r_struct
id|dquot
op_star
id|dquot
)paren
suffix:semicolon
r_static
r_int
id|ext3_mark_dquot_dirty
c_func
(paren
r_struct
id|dquot
op_star
id|dquot
)paren
suffix:semicolon
r_static
r_int
id|ext3_write_info
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_int
id|type
)paren
suffix:semicolon
r_static
r_int
id|ext3_quota_on
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_int
id|type
comma
r_int
id|format_id
comma
r_char
op_star
id|path
)paren
suffix:semicolon
r_static
r_int
id|ext3_quota_on_mount
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_int
id|type
)paren
suffix:semicolon
r_static
r_int
id|ext3_quota_off_mount
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_int
id|type
)paren
suffix:semicolon
DECL|variable|ext3_quota_operations
r_static
r_struct
id|dquot_operations
id|ext3_quota_operations
op_assign
(brace
dot
id|initialize
op_assign
id|ext3_dquot_initialize
comma
dot
id|drop
op_assign
id|ext3_dquot_drop
comma
dot
id|alloc_space
op_assign
id|dquot_alloc_space
comma
dot
id|alloc_inode
op_assign
id|dquot_alloc_inode
comma
dot
id|free_space
op_assign
id|dquot_free_space
comma
dot
id|free_inode
op_assign
id|dquot_free_inode
comma
dot
id|transfer
op_assign
id|dquot_transfer
comma
dot
id|write_dquot
op_assign
id|ext3_write_dquot
comma
dot
id|acquire_dquot
op_assign
id|ext3_acquire_dquot
comma
dot
id|release_dquot
op_assign
id|ext3_release_dquot
comma
dot
id|mark_dirty
op_assign
id|ext3_mark_dquot_dirty
comma
dot
id|write_info
op_assign
id|ext3_write_info
)brace
suffix:semicolon
DECL|variable|ext3_qctl_operations
r_static
r_struct
id|quotactl_ops
id|ext3_qctl_operations
op_assign
(brace
dot
id|quota_on
op_assign
id|ext3_quota_on
comma
dot
id|quota_off
op_assign
id|vfs_quota_off
comma
dot
id|quota_sync
op_assign
id|vfs_quota_sync
comma
dot
id|get_info
op_assign
id|vfs_get_dqinfo
comma
dot
id|set_info
op_assign
id|vfs_set_dqinfo
comma
dot
id|get_dqblk
op_assign
id|vfs_get_dqblk
comma
dot
id|set_dqblk
op_assign
id|vfs_set_dqblk
)brace
suffix:semicolon
macro_line|#endif
DECL|variable|ext3_sops
r_static
r_struct
id|super_operations
id|ext3_sops
op_assign
(brace
dot
id|alloc_inode
op_assign
id|ext3_alloc_inode
comma
dot
id|destroy_inode
op_assign
id|ext3_destroy_inode
comma
dot
id|read_inode
op_assign
id|ext3_read_inode
comma
dot
id|write_inode
op_assign
id|ext3_write_inode
comma
dot
id|dirty_inode
op_assign
id|ext3_dirty_inode
comma
dot
id|delete_inode
op_assign
id|ext3_delete_inode
comma
dot
id|put_super
op_assign
id|ext3_put_super
comma
dot
id|write_super
op_assign
id|ext3_write_super
comma
dot
id|sync_fs
op_assign
id|ext3_sync_fs
comma
dot
id|write_super_lockfs
op_assign
id|ext3_write_super_lockfs
comma
dot
id|unlockfs
op_assign
id|ext3_unlockfs
comma
dot
id|statfs
op_assign
id|ext3_statfs
comma
dot
id|remount_fs
op_assign
id|ext3_remount
comma
dot
id|clear_inode
op_assign
id|ext3_clear_inode
comma
)brace
suffix:semicolon
r_struct
id|dentry
op_star
id|ext3_get_parent
c_func
(paren
r_struct
id|dentry
op_star
id|child
)paren
suffix:semicolon
DECL|variable|ext3_export_ops
r_static
r_struct
id|export_operations
id|ext3_export_ops
op_assign
(brace
dot
id|get_parent
op_assign
id|ext3_get_parent
comma
)brace
suffix:semicolon
r_enum
(brace
DECL|enumerator|Opt_bsd_df
DECL|enumerator|Opt_minix_df
DECL|enumerator|Opt_grpid
DECL|enumerator|Opt_nogrpid
id|Opt_bsd_df
comma
id|Opt_minix_df
comma
id|Opt_grpid
comma
id|Opt_nogrpid
comma
DECL|enumerator|Opt_resgid
DECL|enumerator|Opt_resuid
DECL|enumerator|Opt_sb
DECL|enumerator|Opt_err_cont
DECL|enumerator|Opt_err_panic
DECL|enumerator|Opt_err_ro
id|Opt_resgid
comma
id|Opt_resuid
comma
id|Opt_sb
comma
id|Opt_err_cont
comma
id|Opt_err_panic
comma
id|Opt_err_ro
comma
DECL|enumerator|Opt_nouid32
DECL|enumerator|Opt_check
DECL|enumerator|Opt_nocheck
DECL|enumerator|Opt_debug
DECL|enumerator|Opt_oldalloc
DECL|enumerator|Opt_orlov
id|Opt_nouid32
comma
id|Opt_check
comma
id|Opt_nocheck
comma
id|Opt_debug
comma
id|Opt_oldalloc
comma
id|Opt_orlov
comma
DECL|enumerator|Opt_user_xattr
DECL|enumerator|Opt_nouser_xattr
DECL|enumerator|Opt_acl
DECL|enumerator|Opt_noacl
id|Opt_user_xattr
comma
id|Opt_nouser_xattr
comma
id|Opt_acl
comma
id|Opt_noacl
comma
DECL|enumerator|Opt_reservation
DECL|enumerator|Opt_noreservation
DECL|enumerator|Opt_noload
id|Opt_reservation
comma
id|Opt_noreservation
comma
id|Opt_noload
comma
DECL|enumerator|Opt_commit
DECL|enumerator|Opt_journal_update
DECL|enumerator|Opt_journal_inum
id|Opt_commit
comma
id|Opt_journal_update
comma
id|Opt_journal_inum
comma
DECL|enumerator|Opt_abort
DECL|enumerator|Opt_data_journal
DECL|enumerator|Opt_data_ordered
DECL|enumerator|Opt_data_writeback
id|Opt_abort
comma
id|Opt_data_journal
comma
id|Opt_data_ordered
comma
id|Opt_data_writeback
comma
DECL|enumerator|Opt_usrjquota
DECL|enumerator|Opt_grpjquota
DECL|enumerator|Opt_offusrjquota
DECL|enumerator|Opt_offgrpjquota
id|Opt_usrjquota
comma
id|Opt_grpjquota
comma
id|Opt_offusrjquota
comma
id|Opt_offgrpjquota
comma
DECL|enumerator|Opt_jqfmt_vfsold
DECL|enumerator|Opt_jqfmt_vfsv0
id|Opt_jqfmt_vfsold
comma
id|Opt_jqfmt_vfsv0
comma
DECL|enumerator|Opt_ignore
DECL|enumerator|Opt_barrier
DECL|enumerator|Opt_err
DECL|enumerator|Opt_resize
id|Opt_ignore
comma
id|Opt_barrier
comma
id|Opt_err
comma
id|Opt_resize
comma
)brace
suffix:semicolon
DECL|variable|tokens
r_static
id|match_table_t
id|tokens
op_assign
(brace
(brace
id|Opt_bsd_df
comma
l_string|&quot;bsddf&quot;
)brace
comma
(brace
id|Opt_minix_df
comma
l_string|&quot;minixdf&quot;
)brace
comma
(brace
id|Opt_grpid
comma
l_string|&quot;grpid&quot;
)brace
comma
(brace
id|Opt_grpid
comma
l_string|&quot;bsdgroups&quot;
)brace
comma
(brace
id|Opt_nogrpid
comma
l_string|&quot;nogrpid&quot;
)brace
comma
(brace
id|Opt_nogrpid
comma
l_string|&quot;sysvgroups&quot;
)brace
comma
(brace
id|Opt_resgid
comma
l_string|&quot;resgid=%u&quot;
)brace
comma
(brace
id|Opt_resuid
comma
l_string|&quot;resuid=%u&quot;
)brace
comma
(brace
id|Opt_sb
comma
l_string|&quot;sb=%u&quot;
)brace
comma
(brace
id|Opt_err_cont
comma
l_string|&quot;errors=continue&quot;
)brace
comma
(brace
id|Opt_err_panic
comma
l_string|&quot;errors=panic&quot;
)brace
comma
(brace
id|Opt_err_ro
comma
l_string|&quot;errors=remount-ro&quot;
)brace
comma
(brace
id|Opt_nouid32
comma
l_string|&quot;nouid32&quot;
)brace
comma
(brace
id|Opt_nocheck
comma
l_string|&quot;nocheck&quot;
)brace
comma
(brace
id|Opt_nocheck
comma
l_string|&quot;check=none&quot;
)brace
comma
(brace
id|Opt_check
comma
l_string|&quot;check&quot;
)brace
comma
(brace
id|Opt_debug
comma
l_string|&quot;debug&quot;
)brace
comma
(brace
id|Opt_oldalloc
comma
l_string|&quot;oldalloc&quot;
)brace
comma
(brace
id|Opt_orlov
comma
l_string|&quot;orlov&quot;
)brace
comma
(brace
id|Opt_user_xattr
comma
l_string|&quot;user_xattr&quot;
)brace
comma
(brace
id|Opt_nouser_xattr
comma
l_string|&quot;nouser_xattr&quot;
)brace
comma
(brace
id|Opt_acl
comma
l_string|&quot;acl&quot;
)brace
comma
(brace
id|Opt_noacl
comma
l_string|&quot;noacl&quot;
)brace
comma
(brace
id|Opt_reservation
comma
l_string|&quot;reservation&quot;
)brace
comma
(brace
id|Opt_noreservation
comma
l_string|&quot;noreservation&quot;
)brace
comma
(brace
id|Opt_noload
comma
l_string|&quot;noload&quot;
)brace
comma
(brace
id|Opt_commit
comma
l_string|&quot;commit=%u&quot;
)brace
comma
(brace
id|Opt_journal_update
comma
l_string|&quot;journal=update&quot;
)brace
comma
(brace
id|Opt_journal_inum
comma
l_string|&quot;journal=%u&quot;
)brace
comma
(brace
id|Opt_abort
comma
l_string|&quot;abort&quot;
)brace
comma
(brace
id|Opt_data_journal
comma
l_string|&quot;data=journal&quot;
)brace
comma
(brace
id|Opt_data_ordered
comma
l_string|&quot;data=ordered&quot;
)brace
comma
(brace
id|Opt_data_writeback
comma
l_string|&quot;data=writeback&quot;
)brace
comma
(brace
id|Opt_offusrjquota
comma
l_string|&quot;usrjquota=&quot;
)brace
comma
(brace
id|Opt_usrjquota
comma
l_string|&quot;usrjquota=%s&quot;
)brace
comma
(brace
id|Opt_offgrpjquota
comma
l_string|&quot;grpjquota=&quot;
)brace
comma
(brace
id|Opt_grpjquota
comma
l_string|&quot;grpjquota=%s&quot;
)brace
comma
(brace
id|Opt_jqfmt_vfsold
comma
l_string|&quot;jqfmt=vfsold&quot;
)brace
comma
(brace
id|Opt_jqfmt_vfsv0
comma
l_string|&quot;jqfmt=vfsv0&quot;
)brace
comma
(brace
id|Opt_ignore
comma
l_string|&quot;grpquota&quot;
)brace
comma
(brace
id|Opt_ignore
comma
l_string|&quot;noquota&quot;
)brace
comma
(brace
id|Opt_ignore
comma
l_string|&quot;quota&quot;
)brace
comma
(brace
id|Opt_ignore
comma
l_string|&quot;usrquota&quot;
)brace
comma
(brace
id|Opt_barrier
comma
l_string|&quot;barrier=%u&quot;
)brace
comma
(brace
id|Opt_err
comma
l_int|NULL
)brace
comma
(brace
id|Opt_resize
comma
l_string|&quot;resize&quot;
)brace
comma
)brace
suffix:semicolon
DECL|function|get_sb_block
r_static
r_int
r_int
id|get_sb_block
c_func
(paren
r_void
op_star
op_star
id|data
)paren
(brace
r_int
r_int
id|sb_block
suffix:semicolon
r_char
op_star
id|options
op_assign
(paren
r_char
op_star
)paren
op_star
id|data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|options
op_logical_or
id|strncmp
c_func
(paren
id|options
comma
l_string|&quot;sb=&quot;
comma
l_int|3
)paren
op_ne
l_int|0
)paren
r_return
l_int|1
suffix:semicolon
multiline_comment|/* Default location */
id|options
op_add_assign
l_int|3
suffix:semicolon
id|sb_block
op_assign
id|simple_strtoul
c_func
(paren
id|options
comma
op_amp
id|options
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|options
op_logical_and
op_star
id|options
op_ne
l_char|&squot;,&squot;
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;EXT3-fs: Invalid sb specification: %s&bslash;n&quot;
comma
(paren
r_char
op_star
)paren
op_star
id|data
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_star
id|options
op_eq
l_char|&squot;,&squot;
)paren
id|options
op_increment
suffix:semicolon
op_star
id|data
op_assign
(paren
r_void
op_star
)paren
id|options
suffix:semicolon
r_return
id|sb_block
suffix:semicolon
)brace
DECL|function|parse_options
r_static
r_int
id|parse_options
(paren
r_char
op_star
id|options
comma
r_struct
id|super_block
op_star
id|sb
comma
r_int
r_int
op_star
id|inum
comma
r_int
r_int
op_star
id|n_blocks_count
comma
r_int
id|is_remount
)paren
(brace
r_struct
id|ext3_sb_info
op_star
id|sbi
op_assign
id|EXT3_SB
c_func
(paren
id|sb
)paren
suffix:semicolon
r_char
op_star
id|p
suffix:semicolon
id|substring_t
id|args
(braket
id|MAX_OPT_ARGS
)braket
suffix:semicolon
r_int
id|data_opt
op_assign
l_int|0
suffix:semicolon
r_int
id|option
suffix:semicolon
macro_line|#ifdef CONFIG_QUOTA
r_int
id|qtype
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|options
)paren
r_return
l_int|1
suffix:semicolon
r_while
c_loop
(paren
(paren
id|p
op_assign
id|strsep
(paren
op_amp
id|options
comma
l_string|&quot;,&quot;
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
r_int
id|token
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
op_star
id|p
)paren
r_continue
suffix:semicolon
id|token
op_assign
id|match_token
c_func
(paren
id|p
comma
id|tokens
comma
id|args
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|token
)paren
(brace
r_case
id|Opt_bsd_df
suffix:colon
id|clear_opt
(paren
id|sbi-&gt;s_mount_opt
comma
id|MINIX_DF
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|Opt_minix_df
suffix:colon
id|set_opt
(paren
id|sbi-&gt;s_mount_opt
comma
id|MINIX_DF
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|Opt_grpid
suffix:colon
id|set_opt
(paren
id|sbi-&gt;s_mount_opt
comma
id|GRPID
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|Opt_nogrpid
suffix:colon
id|clear_opt
(paren
id|sbi-&gt;s_mount_opt
comma
id|GRPID
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|Opt_resuid
suffix:colon
r_if
c_cond
(paren
id|match_int
c_func
(paren
op_amp
id|args
(braket
l_int|0
)braket
comma
op_amp
id|option
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|sbi-&gt;s_resuid
op_assign
id|option
suffix:semicolon
r_break
suffix:semicolon
r_case
id|Opt_resgid
suffix:colon
r_if
c_cond
(paren
id|match_int
c_func
(paren
op_amp
id|args
(braket
l_int|0
)braket
comma
op_amp
id|option
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|sbi-&gt;s_resgid
op_assign
id|option
suffix:semicolon
r_break
suffix:semicolon
r_case
id|Opt_sb
suffix:colon
multiline_comment|/* handled by get_sb_block() instead of here */
multiline_comment|/* *sb_block = match_int(&amp;args[0]); */
r_break
suffix:semicolon
r_case
id|Opt_err_panic
suffix:colon
id|clear_opt
(paren
id|sbi-&gt;s_mount_opt
comma
id|ERRORS_CONT
)paren
suffix:semicolon
id|clear_opt
(paren
id|sbi-&gt;s_mount_opt
comma
id|ERRORS_RO
)paren
suffix:semicolon
id|set_opt
(paren
id|sbi-&gt;s_mount_opt
comma
id|ERRORS_PANIC
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|Opt_err_ro
suffix:colon
id|clear_opt
(paren
id|sbi-&gt;s_mount_opt
comma
id|ERRORS_CONT
)paren
suffix:semicolon
id|clear_opt
(paren
id|sbi-&gt;s_mount_opt
comma
id|ERRORS_PANIC
)paren
suffix:semicolon
id|set_opt
(paren
id|sbi-&gt;s_mount_opt
comma
id|ERRORS_RO
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|Opt_err_cont
suffix:colon
id|clear_opt
(paren
id|sbi-&gt;s_mount_opt
comma
id|ERRORS_RO
)paren
suffix:semicolon
id|clear_opt
(paren
id|sbi-&gt;s_mount_opt
comma
id|ERRORS_PANIC
)paren
suffix:semicolon
id|set_opt
(paren
id|sbi-&gt;s_mount_opt
comma
id|ERRORS_CONT
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|Opt_nouid32
suffix:colon
id|set_opt
(paren
id|sbi-&gt;s_mount_opt
comma
id|NO_UID32
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|Opt_check
suffix:colon
macro_line|#ifdef CONFIG_EXT3_CHECK
id|set_opt
(paren
id|sbi-&gt;s_mount_opt
comma
id|CHECK
)paren
suffix:semicolon
macro_line|#else
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;EXT3 Check option not supported&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
r_case
id|Opt_nocheck
suffix:colon
id|clear_opt
(paren
id|sbi-&gt;s_mount_opt
comma
id|CHECK
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|Opt_debug
suffix:colon
id|set_opt
(paren
id|sbi-&gt;s_mount_opt
comma
id|DEBUG
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|Opt_oldalloc
suffix:colon
id|set_opt
(paren
id|sbi-&gt;s_mount_opt
comma
id|OLDALLOC
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|Opt_orlov
suffix:colon
id|clear_opt
(paren
id|sbi-&gt;s_mount_opt
comma
id|OLDALLOC
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#ifdef CONFIG_EXT3_FS_XATTR
r_case
id|Opt_user_xattr
suffix:colon
id|set_opt
(paren
id|sbi-&gt;s_mount_opt
comma
id|XATTR_USER
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|Opt_nouser_xattr
suffix:colon
id|clear_opt
(paren
id|sbi-&gt;s_mount_opt
comma
id|XATTR_USER
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#else
r_case
id|Opt_user_xattr
suffix:colon
r_case
id|Opt_nouser_xattr
suffix:colon
id|printk
c_func
(paren
l_string|&quot;EXT3 (no)user_xattr options not supported&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
macro_line|#ifdef CONFIG_EXT3_FS_POSIX_ACL
r_case
id|Opt_acl
suffix:colon
id|set_opt
c_func
(paren
id|sbi-&gt;s_mount_opt
comma
id|POSIX_ACL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|Opt_noacl
suffix:colon
id|clear_opt
c_func
(paren
id|sbi-&gt;s_mount_opt
comma
id|POSIX_ACL
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#else
r_case
id|Opt_acl
suffix:colon
r_case
id|Opt_noacl
suffix:colon
id|printk
c_func
(paren
l_string|&quot;EXT3 (no)acl options not supported&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_case
id|Opt_reservation
suffix:colon
id|set_opt
c_func
(paren
id|sbi-&gt;s_mount_opt
comma
id|RESERVATION
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|Opt_noreservation
suffix:colon
id|clear_opt
c_func
(paren
id|sbi-&gt;s_mount_opt
comma
id|RESERVATION
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|Opt_journal_update
suffix:colon
multiline_comment|/* @@@ FIXME */
multiline_comment|/* Eventually we will want to be able to create&n;&t;&t;&t;   a journal file here.  For now, only allow the&n;&t;&t;&t;   user to specify an existing inode to be the&n;&t;&t;&t;   journal file. */
r_if
c_cond
(paren
id|is_remount
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;EXT3-fs: cannot specify &quot;
l_string|&quot;journal on remount&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|set_opt
(paren
id|sbi-&gt;s_mount_opt
comma
id|UPDATE_JOURNAL
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|Opt_journal_inum
suffix:colon
r_if
c_cond
(paren
id|is_remount
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;EXT3-fs: cannot specify &quot;
l_string|&quot;journal on remount&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|match_int
c_func
(paren
op_amp
id|args
(braket
l_int|0
)braket
comma
op_amp
id|option
)paren
)paren
r_return
l_int|0
suffix:semicolon
op_star
id|inum
op_assign
id|option
suffix:semicolon
r_break
suffix:semicolon
r_case
id|Opt_noload
suffix:colon
id|set_opt
(paren
id|sbi-&gt;s_mount_opt
comma
id|NOLOAD
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|Opt_commit
suffix:colon
r_if
c_cond
(paren
id|match_int
c_func
(paren
op_amp
id|args
(braket
l_int|0
)braket
comma
op_amp
id|option
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|option
OL
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|option
op_eq
l_int|0
)paren
id|option
op_assign
id|JBD_DEFAULT_MAX_COMMIT_AGE
suffix:semicolon
id|sbi-&gt;s_commit_interval
op_assign
id|HZ
op_star
id|option
suffix:semicolon
r_break
suffix:semicolon
r_case
id|Opt_data_journal
suffix:colon
id|data_opt
op_assign
id|EXT3_MOUNT_JOURNAL_DATA
suffix:semicolon
r_goto
id|datacheck
suffix:semicolon
r_case
id|Opt_data_ordered
suffix:colon
id|data_opt
op_assign
id|EXT3_MOUNT_ORDERED_DATA
suffix:semicolon
r_goto
id|datacheck
suffix:semicolon
r_case
id|Opt_data_writeback
suffix:colon
id|data_opt
op_assign
id|EXT3_MOUNT_WRITEBACK_DATA
suffix:semicolon
id|datacheck
suffix:colon
r_if
c_cond
(paren
id|is_remount
)paren
(brace
r_if
c_cond
(paren
(paren
id|sbi-&gt;s_mount_opt
op_amp
id|EXT3_MOUNT_DATA_FLAGS
)paren
op_ne
id|data_opt
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;EXT3-fs: cannot change data &quot;
l_string|&quot;mode on remount&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_else
(brace
id|sbi-&gt;s_mount_opt
op_and_assign
op_complement
id|EXT3_MOUNT_DATA_FLAGS
suffix:semicolon
id|sbi-&gt;s_mount_opt
op_or_assign
id|data_opt
suffix:semicolon
)brace
r_break
suffix:semicolon
macro_line|#ifdef CONFIG_QUOTA
r_case
id|Opt_usrjquota
suffix:colon
id|qtype
op_assign
id|USRQUOTA
suffix:semicolon
r_goto
id|set_qf_name
suffix:semicolon
r_case
id|Opt_grpjquota
suffix:colon
id|qtype
op_assign
id|GRPQUOTA
suffix:semicolon
id|set_qf_name
suffix:colon
r_if
c_cond
(paren
id|sb_any_quota_enabled
c_func
(paren
id|sb
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;EXT3-fs: Cannot change journalled &quot;
l_string|&quot;quota options when quota turned on.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sbi-&gt;s_qf_names
(braket
id|qtype
)braket
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;EXT3-fs: %s quota file already &quot;
l_string|&quot;specified.&bslash;n&quot;
comma
id|QTYPE2NAME
c_func
(paren
id|qtype
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|sbi-&gt;s_qf_names
(braket
id|qtype
)braket
op_assign
id|match_strdup
c_func
(paren
op_amp
id|args
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sbi-&gt;s_qf_names
(braket
id|qtype
)braket
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;EXT3-fs: not enough memory for &quot;
l_string|&quot;storing quotafile name.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|strchr
c_func
(paren
id|sbi-&gt;s_qf_names
(braket
id|qtype
)braket
comma
l_char|&squot;/&squot;
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;EXT3-fs: quotafile must be on &quot;
l_string|&quot;filesystem root.&bslash;n&quot;
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|sbi-&gt;s_qf_names
(braket
id|qtype
)braket
)paren
suffix:semicolon
id|sbi-&gt;s_qf_names
(braket
id|qtype
)braket
op_assign
l_int|NULL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|Opt_offusrjquota
suffix:colon
id|qtype
op_assign
id|USRQUOTA
suffix:semicolon
r_goto
id|clear_qf_name
suffix:semicolon
r_case
id|Opt_offgrpjquota
suffix:colon
id|qtype
op_assign
id|GRPQUOTA
suffix:semicolon
id|clear_qf_name
suffix:colon
r_if
c_cond
(paren
id|sb_any_quota_enabled
c_func
(paren
id|sb
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;EXT3-fs: Cannot change &quot;
l_string|&quot;journalled quota options when &quot;
l_string|&quot;quota turned on.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sbi-&gt;s_qf_names
(braket
id|qtype
)braket
)paren
(brace
id|kfree
c_func
(paren
id|sbi-&gt;s_qf_names
(braket
id|qtype
)braket
)paren
suffix:semicolon
id|sbi-&gt;s_qf_names
(braket
id|qtype
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
r_break
suffix:semicolon
r_case
id|Opt_jqfmt_vfsold
suffix:colon
id|sbi-&gt;s_jquota_fmt
op_assign
id|QFMT_VFS_OLD
suffix:semicolon
r_break
suffix:semicolon
r_case
id|Opt_jqfmt_vfsv0
suffix:colon
id|sbi-&gt;s_jquota_fmt
op_assign
id|QFMT_VFS_V0
suffix:semicolon
r_break
suffix:semicolon
macro_line|#else
r_case
id|Opt_usrjquota
suffix:colon
r_case
id|Opt_grpjquota
suffix:colon
r_case
id|Opt_offusrjquota
suffix:colon
r_case
id|Opt_offgrpjquota
suffix:colon
r_case
id|Opt_jqfmt_vfsold
suffix:colon
r_case
id|Opt_jqfmt_vfsv0
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;EXT3-fs: journalled quota options not &quot;
l_string|&quot;supported.&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
macro_line|#endif
r_case
id|Opt_abort
suffix:colon
id|set_opt
c_func
(paren
id|sbi-&gt;s_mount_opt
comma
id|ABORT
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|Opt_barrier
suffix:colon
r_if
c_cond
(paren
id|match_int
c_func
(paren
op_amp
id|args
(braket
l_int|0
)braket
comma
op_amp
id|option
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|option
)paren
id|set_opt
c_func
(paren
id|sbi-&gt;s_mount_opt
comma
id|BARRIER
)paren
suffix:semicolon
r_else
id|clear_opt
c_func
(paren
id|sbi-&gt;s_mount_opt
comma
id|BARRIER
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|Opt_ignore
suffix:colon
r_break
suffix:semicolon
r_case
id|Opt_resize
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|n_blocks_count
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;EXT3-fs: resize option only available &quot;
l_string|&quot;for remount&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|match_int
c_func
(paren
op_amp
id|args
(braket
l_int|0
)braket
comma
op_amp
id|option
)paren
suffix:semicolon
op_star
id|n_blocks_count
op_assign
id|option
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
(paren
id|KERN_ERR
l_string|&quot;EXT3-fs: Unrecognized mount option &bslash;&quot;%s&bslash;&quot; &quot;
l_string|&quot;or missing value&bslash;n&quot;
comma
id|p
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
macro_line|#ifdef CONFIG_QUOTA
r_if
c_cond
(paren
op_logical_neg
id|sbi-&gt;s_jquota_fmt
op_logical_and
(paren
id|sbi-&gt;s_qf_names
(braket
id|USRQUOTA
)braket
op_logical_or
id|sbi-&gt;s_qf_names
(braket
id|GRPQUOTA
)braket
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;EXT3-fs: journalled quota format not specified.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
macro_line|#endif
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|ext3_setup_super
r_static
r_int
id|ext3_setup_super
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|ext3_super_block
op_star
id|es
comma
r_int
id|read_only
)paren
(brace
r_struct
id|ext3_sb_info
op_star
id|sbi
op_assign
id|EXT3_SB
c_func
(paren
id|sb
)paren
suffix:semicolon
r_int
id|res
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|le32_to_cpu
c_func
(paren
id|es-&gt;s_rev_level
)paren
OG
id|EXT3_MAX_SUPP_REV
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;EXT3-fs warning: revision level too high, &quot;
l_string|&quot;forcing read-only mode&bslash;n&quot;
)paren
suffix:semicolon
id|res
op_assign
id|MS_RDONLY
suffix:semicolon
)brace
r_if
c_cond
(paren
id|read_only
)paren
r_return
id|res
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|sbi-&gt;s_mount_state
op_amp
id|EXT3_VALID_FS
)paren
)paren
id|printk
(paren
id|KERN_WARNING
l_string|&quot;EXT3-fs warning: mounting unchecked fs, &quot;
l_string|&quot;running e2fsck is recommended&bslash;n&quot;
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|sbi-&gt;s_mount_state
op_amp
id|EXT3_ERROR_FS
)paren
)paren
id|printk
(paren
id|KERN_WARNING
l_string|&quot;EXT3-fs warning: mounting fs with errors, &quot;
l_string|&quot;running e2fsck is recommended&bslash;n&quot;
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|__s16
)paren
id|le16_to_cpu
c_func
(paren
id|es-&gt;s_max_mnt_count
)paren
op_ge
l_int|0
op_logical_and
id|le16_to_cpu
c_func
(paren
id|es-&gt;s_mnt_count
)paren
op_ge
(paren
r_int
r_int
)paren
(paren
id|__s16
)paren
id|le16_to_cpu
c_func
(paren
id|es-&gt;s_max_mnt_count
)paren
)paren
id|printk
(paren
id|KERN_WARNING
l_string|&quot;EXT3-fs warning: maximal mount count reached, &quot;
l_string|&quot;running e2fsck is recommended&bslash;n&quot;
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|le32_to_cpu
c_func
(paren
id|es-&gt;s_checkinterval
)paren
op_logical_and
(paren
id|le32_to_cpu
c_func
(paren
id|es-&gt;s_lastcheck
)paren
op_plus
id|le32_to_cpu
c_func
(paren
id|es-&gt;s_checkinterval
)paren
op_le
id|get_seconds
c_func
(paren
)paren
)paren
)paren
id|printk
(paren
id|KERN_WARNING
l_string|&quot;EXT3-fs warning: checktime reached, &quot;
l_string|&quot;running e2fsck is recommended&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#if 0
multiline_comment|/* @@@ We _will_ want to clear the valid bit if we find&n;                   inconsistencies, to force a fsck at reboot.  But for&n;                   a plain journaled filesystem we can keep it set as&n;                   valid forever! :) */
id|es-&gt;s_state
op_assign
id|cpu_to_le16
c_func
(paren
id|le16_to_cpu
c_func
(paren
id|es-&gt;s_state
)paren
op_amp
op_complement
id|EXT3_VALID_FS
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
(paren
id|__s16
)paren
id|le16_to_cpu
c_func
(paren
id|es-&gt;s_max_mnt_count
)paren
)paren
id|es-&gt;s_max_mnt_count
op_assign
id|cpu_to_le16
c_func
(paren
id|EXT3_DFL_MAX_MNT_COUNT
)paren
suffix:semicolon
id|es-&gt;s_mnt_count
op_assign
id|cpu_to_le16
c_func
(paren
id|le16_to_cpu
c_func
(paren
id|es-&gt;s_mnt_count
)paren
op_plus
l_int|1
)paren
suffix:semicolon
id|es-&gt;s_mtime
op_assign
id|cpu_to_le32
c_func
(paren
id|get_seconds
c_func
(paren
)paren
)paren
suffix:semicolon
id|ext3_update_dynamic_rev
c_func
(paren
id|sb
)paren
suffix:semicolon
id|EXT3_SET_INCOMPAT_FEATURE
c_func
(paren
id|sb
comma
id|EXT3_FEATURE_INCOMPAT_RECOVER
)paren
suffix:semicolon
id|ext3_commit_super
c_func
(paren
id|sb
comma
id|es
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|test_opt
c_func
(paren
id|sb
comma
id|DEBUG
)paren
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;[EXT3 FS bs=%lu, gc=%lu, &quot;
l_string|&quot;bpg=%lu, ipg=%lu, mo=%04lx]&bslash;n&quot;
comma
id|sb-&gt;s_blocksize
comma
id|sbi-&gt;s_groups_count
comma
id|EXT3_BLOCKS_PER_GROUP
c_func
(paren
id|sb
)paren
comma
id|EXT3_INODES_PER_GROUP
c_func
(paren
id|sb
)paren
comma
id|sbi-&gt;s_mount_opt
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;EXT3 FS on %s, &quot;
comma
id|sb-&gt;s_id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|EXT3_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|s_journal-&gt;j_inode
op_eq
l_int|NULL
)paren
(brace
r_char
id|b
(braket
id|BDEVNAME_SIZE
)braket
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;external journal on %s&bslash;n&quot;
comma
id|bdevname
c_func
(paren
id|EXT3_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|s_journal-&gt;j_dev
comma
id|b
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;internal journal&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_EXT3_CHECK
r_if
c_cond
(paren
id|test_opt
(paren
id|sb
comma
id|CHECK
)paren
)paren
(brace
id|ext3_check_blocks_bitmap
(paren
id|sb
)paren
suffix:semicolon
id|ext3_check_inodes_bitmap
(paren
id|sb
)paren
suffix:semicolon
)brace
macro_line|#endif
r_return
id|res
suffix:semicolon
)brace
multiline_comment|/* Called at mount-time, super-block is locked */
DECL|function|ext3_check_descriptors
r_static
r_int
id|ext3_check_descriptors
(paren
r_struct
id|super_block
op_star
id|sb
)paren
(brace
r_struct
id|ext3_sb_info
op_star
id|sbi
op_assign
id|EXT3_SB
c_func
(paren
id|sb
)paren
suffix:semicolon
r_int
r_int
id|block
op_assign
id|le32_to_cpu
c_func
(paren
id|sbi-&gt;s_es-&gt;s_first_data_block
)paren
suffix:semicolon
r_struct
id|ext3_group_desc
op_star
id|gdp
op_assign
l_int|NULL
suffix:semicolon
r_int
id|desc_block
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
id|ext3_debug
(paren
l_string|&quot;Checking group descriptors&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|sbi-&gt;s_groups_count
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
(paren
id|i
op_mod
id|EXT3_DESC_PER_BLOCK
c_func
(paren
id|sb
)paren
)paren
op_eq
l_int|0
)paren
id|gdp
op_assign
(paren
r_struct
id|ext3_group_desc
op_star
)paren
id|sbi-&gt;s_group_desc
(braket
id|desc_block
op_increment
)braket
op_member_access_from_pointer
id|b_data
suffix:semicolon
r_if
c_cond
(paren
id|le32_to_cpu
c_func
(paren
id|gdp-&gt;bg_block_bitmap
)paren
OL
id|block
op_logical_or
id|le32_to_cpu
c_func
(paren
id|gdp-&gt;bg_block_bitmap
)paren
op_ge
id|block
op_plus
id|EXT3_BLOCKS_PER_GROUP
c_func
(paren
id|sb
)paren
)paren
(brace
id|ext3_error
(paren
id|sb
comma
l_string|&quot;ext3_check_descriptors&quot;
comma
l_string|&quot;Block bitmap for group %d&quot;
l_string|&quot; not in group (block %lu)!&quot;
comma
id|i
comma
(paren
r_int
r_int
)paren
id|le32_to_cpu
c_func
(paren
id|gdp-&gt;bg_block_bitmap
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|le32_to_cpu
c_func
(paren
id|gdp-&gt;bg_inode_bitmap
)paren
OL
id|block
op_logical_or
id|le32_to_cpu
c_func
(paren
id|gdp-&gt;bg_inode_bitmap
)paren
op_ge
id|block
op_plus
id|EXT3_BLOCKS_PER_GROUP
c_func
(paren
id|sb
)paren
)paren
(brace
id|ext3_error
(paren
id|sb
comma
l_string|&quot;ext3_check_descriptors&quot;
comma
l_string|&quot;Inode bitmap for group %d&quot;
l_string|&quot; not in group (block %lu)!&quot;
comma
id|i
comma
(paren
r_int
r_int
)paren
id|le32_to_cpu
c_func
(paren
id|gdp-&gt;bg_inode_bitmap
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|le32_to_cpu
c_func
(paren
id|gdp-&gt;bg_inode_table
)paren
OL
id|block
op_logical_or
id|le32_to_cpu
c_func
(paren
id|gdp-&gt;bg_inode_table
)paren
op_plus
id|sbi-&gt;s_itb_per_group
op_ge
id|block
op_plus
id|EXT3_BLOCKS_PER_GROUP
c_func
(paren
id|sb
)paren
)paren
(brace
id|ext3_error
(paren
id|sb
comma
l_string|&quot;ext3_check_descriptors&quot;
comma
l_string|&quot;Inode table for group %d&quot;
l_string|&quot; not in group (block %lu)!&quot;
comma
id|i
comma
(paren
r_int
r_int
)paren
id|le32_to_cpu
c_func
(paren
id|gdp-&gt;bg_inode_table
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|block
op_add_assign
id|EXT3_BLOCKS_PER_GROUP
c_func
(paren
id|sb
)paren
suffix:semicolon
id|gdp
op_increment
suffix:semicolon
)brace
id|sbi-&gt;s_es-&gt;s_free_blocks_count
op_assign
id|cpu_to_le32
c_func
(paren
id|ext3_count_free_blocks
c_func
(paren
id|sb
)paren
)paren
suffix:semicolon
id|sbi-&gt;s_es-&gt;s_free_inodes_count
op_assign
id|cpu_to_le32
c_func
(paren
id|ext3_count_free_inodes
c_func
(paren
id|sb
)paren
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* ext3_orphan_cleanup() walks a singly-linked list of inodes (starting at&n; * the superblock) which were deleted from all directories, but held open by&n; * a process at the time of a crash.  We walk the list and try to delete these&n; * inodes at recovery time (only with a read-write filesystem).&n; *&n; * In order to keep the orphan inode chain consistent during traversal (in&n; * case of crash during recovery), we link each inode into the superblock&n; * orphan list_head and handle it the same way as an inode deletion during&n; * normal operation (which journals the operations for us).&n; *&n; * We only do an iget() and an iput() on each inode, which is very safe if we&n; * accidentally point at an in-use or already deleted inode.  The worst that&n; * can happen in this case is that we get a &quot;bit already cleared&quot; message from&n; * ext3_free_inode().  The only reason we would point at a wrong inode is if&n; * e2fsck was run on this filesystem, and it must have already done the orphan&n; * inode cleanup for us, so we can safely abort without any further action.&n; */
DECL|function|ext3_orphan_cleanup
r_static
r_void
id|ext3_orphan_cleanup
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|ext3_super_block
op_star
id|es
)paren
(brace
r_int
r_int
id|s_flags
op_assign
id|sb-&gt;s_flags
suffix:semicolon
r_int
id|nr_orphans
op_assign
l_int|0
comma
id|nr_truncates
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef CONFIG_QUOTA
r_int
id|i
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
op_logical_neg
id|es-&gt;s_last_orphan
)paren
(brace
id|jbd_debug
c_func
(paren
l_int|4
comma
l_string|&quot;no orphan inodes to clean up&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|EXT3_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|s_mount_state
op_amp
id|EXT3_ERROR_FS
)paren
(brace
r_if
c_cond
(paren
id|es-&gt;s_last_orphan
)paren
id|jbd_debug
c_func
(paren
l_int|1
comma
l_string|&quot;Errors on filesystem, &quot;
l_string|&quot;clearing orphan list.&bslash;n&quot;
)paren
suffix:semicolon
id|es-&gt;s_last_orphan
op_assign
l_int|0
suffix:semicolon
id|jbd_debug
c_func
(paren
l_int|1
comma
l_string|&quot;Skipping orphan recovery on fs with errors.&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|s_flags
op_amp
id|MS_RDONLY
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;EXT3-fs: %s: orphan cleanup on readonly fs&bslash;n&quot;
comma
id|sb-&gt;s_id
)paren
suffix:semicolon
id|sb-&gt;s_flags
op_and_assign
op_complement
id|MS_RDONLY
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_QUOTA
multiline_comment|/* Needed for iput() to work correctly and not trash data */
id|sb-&gt;s_flags
op_or_assign
id|MS_ACTIVE
suffix:semicolon
multiline_comment|/* Turn on quotas so that they are updated correctly */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAXQUOTAS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|EXT3_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|s_qf_names
(braket
id|i
)braket
)paren
(brace
r_int
id|ret
op_assign
id|ext3_quota_on_mount
c_func
(paren
id|sb
comma
id|i
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;EXT3-fs: Cannot turn on journalled &quot;
l_string|&quot;quota: error %d&bslash;n&quot;
comma
id|ret
)paren
suffix:semicolon
)brace
)brace
macro_line|#endif
r_while
c_loop
(paren
id|es-&gt;s_last_orphan
)paren
(brace
r_struct
id|inode
op_star
id|inode
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|inode
op_assign
id|ext3_orphan_get
c_func
(paren
id|sb
comma
id|le32_to_cpu
c_func
(paren
id|es-&gt;s_last_orphan
)paren
)paren
)paren
)paren
(brace
id|es-&gt;s_last_orphan
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
id|list_add
c_func
(paren
op_amp
id|EXT3_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|i_orphan
comma
op_amp
id|EXT3_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|s_orphan
)paren
suffix:semicolon
id|DQUOT_INIT
c_func
(paren
id|inode
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inode-&gt;i_nlink
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: truncating inode %ld to %Ld bytes&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|inode-&gt;i_ino
comma
id|inode-&gt;i_size
)paren
suffix:semicolon
id|jbd_debug
c_func
(paren
l_int|2
comma
l_string|&quot;truncating inode %ld to %Ld bytes&bslash;n&quot;
comma
id|inode-&gt;i_ino
comma
id|inode-&gt;i_size
)paren
suffix:semicolon
id|ext3_truncate
c_func
(paren
id|inode
)paren
suffix:semicolon
id|nr_truncates
op_increment
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;%s: deleting unreferenced inode %ld&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|inode-&gt;i_ino
)paren
suffix:semicolon
id|jbd_debug
c_func
(paren
l_int|2
comma
l_string|&quot;deleting unreferenced inode %ld&bslash;n&quot;
comma
id|inode-&gt;i_ino
)paren
suffix:semicolon
id|nr_orphans
op_increment
suffix:semicolon
)brace
id|iput
c_func
(paren
id|inode
)paren
suffix:semicolon
multiline_comment|/* The delete magic happens here! */
)brace
DECL|macro|PLURAL
mdefine_line|#define PLURAL(x) (x), ((x)==1) ? &quot;&quot; : &quot;s&quot;
r_if
c_cond
(paren
id|nr_orphans
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;EXT3-fs: %s: %d orphan inode%s deleted&bslash;n&quot;
comma
id|sb-&gt;s_id
comma
id|PLURAL
c_func
(paren
id|nr_orphans
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|nr_truncates
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;EXT3-fs: %s: %d truncate%s cleaned up&bslash;n&quot;
comma
id|sb-&gt;s_id
comma
id|PLURAL
c_func
(paren
id|nr_truncates
)paren
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_QUOTA
multiline_comment|/* Turn quotas off */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAXQUOTAS
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|sb_dqopt
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|files
(braket
id|i
)braket
)paren
id|ext3_quota_off_mount
c_func
(paren
id|sb
comma
id|i
)paren
suffix:semicolon
)brace
macro_line|#endif
id|sb-&gt;s_flags
op_assign
id|s_flags
suffix:semicolon
multiline_comment|/* Restore MS_RDONLY status */
)brace
DECL|macro|log2
mdefine_line|#define log2(n) ffz(~(n))
multiline_comment|/*&n; * Maximal file size.  There is a direct, and {,double-,triple-}indirect&n; * block limit, and also a limit of (2^32 - 1) 512-byte sectors in i_blocks.&n; * We need to be 1 filesystem block less than the 2^32 sector limit.&n; */
DECL|function|ext3_max_size
r_static
id|loff_t
id|ext3_max_size
c_func
(paren
r_int
id|bits
)paren
(brace
id|loff_t
id|res
op_assign
id|EXT3_NDIR_BLOCKS
suffix:semicolon
id|res
op_add_assign
l_int|1LL
op_lshift
(paren
id|bits
op_minus
l_int|2
)paren
suffix:semicolon
id|res
op_add_assign
l_int|1LL
op_lshift
(paren
l_int|2
op_star
(paren
id|bits
op_minus
l_int|2
)paren
)paren
suffix:semicolon
id|res
op_add_assign
l_int|1LL
op_lshift
(paren
l_int|3
op_star
(paren
id|bits
op_minus
l_int|2
)paren
)paren
suffix:semicolon
id|res
op_lshift_assign
id|bits
suffix:semicolon
r_if
c_cond
(paren
id|res
OG
(paren
l_int|512LL
op_lshift
l_int|32
)paren
op_minus
(paren
l_int|1
op_lshift
id|bits
)paren
)paren
id|res
op_assign
(paren
l_int|512LL
op_lshift
l_int|32
)paren
op_minus
(paren
l_int|1
op_lshift
id|bits
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
DECL|function|descriptor_loc
r_static
r_int
r_int
id|descriptor_loc
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_int
r_int
id|logic_sb_block
comma
r_int
id|nr
)paren
(brace
r_struct
id|ext3_sb_info
op_star
id|sbi
op_assign
id|EXT3_SB
c_func
(paren
id|sb
)paren
suffix:semicolon
r_int
r_int
id|bg
comma
id|first_data_block
comma
id|first_meta_bg
suffix:semicolon
r_int
id|has_super
op_assign
l_int|0
suffix:semicolon
id|first_data_block
op_assign
id|le32_to_cpu
c_func
(paren
id|sbi-&gt;s_es-&gt;s_first_data_block
)paren
suffix:semicolon
id|first_meta_bg
op_assign
id|le32_to_cpu
c_func
(paren
id|sbi-&gt;s_es-&gt;s_first_meta_bg
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|EXT3_HAS_INCOMPAT_FEATURE
c_func
(paren
id|sb
comma
id|EXT3_FEATURE_INCOMPAT_META_BG
)paren
op_logical_or
id|nr
OL
id|first_meta_bg
)paren
r_return
(paren
id|logic_sb_block
op_plus
id|nr
op_plus
l_int|1
)paren
suffix:semicolon
id|bg
op_assign
id|sbi-&gt;s_desc_per_block
op_star
id|nr
suffix:semicolon
r_if
c_cond
(paren
id|ext3_bg_has_super
c_func
(paren
id|sb
comma
id|bg
)paren
)paren
id|has_super
op_assign
l_int|1
suffix:semicolon
r_return
(paren
id|first_data_block
op_plus
id|has_super
op_plus
(paren
id|bg
op_star
id|sbi-&gt;s_blocks_per_group
)paren
)paren
suffix:semicolon
)brace
DECL|function|ext3_fill_super
r_static
r_int
id|ext3_fill_super
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_void
op_star
id|data
comma
r_int
id|silent
)paren
(brace
r_struct
id|buffer_head
op_star
id|bh
suffix:semicolon
r_struct
id|ext3_super_block
op_star
id|es
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|ext3_sb_info
op_star
id|sbi
suffix:semicolon
r_int
r_int
id|block
suffix:semicolon
r_int
r_int
id|sb_block
op_assign
id|get_sb_block
c_func
(paren
op_amp
id|data
)paren
suffix:semicolon
r_int
r_int
id|logic_sb_block
suffix:semicolon
r_int
r_int
id|offset
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|journal_inum
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|def_mount_opts
suffix:semicolon
r_struct
id|inode
op_star
id|root
suffix:semicolon
r_int
id|blocksize
suffix:semicolon
r_int
id|hblock
suffix:semicolon
r_int
id|db_count
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|needs_recovery
suffix:semicolon
id|__le32
id|features
suffix:semicolon
id|sbi
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|sbi
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sbi
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|sb-&gt;s_fs_info
op_assign
id|sbi
suffix:semicolon
id|memset
c_func
(paren
id|sbi
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|sbi
)paren
)paren
suffix:semicolon
id|sbi-&gt;s_mount_opt
op_assign
l_int|0
suffix:semicolon
id|sbi-&gt;s_resuid
op_assign
id|EXT3_DEF_RESUID
suffix:semicolon
id|sbi-&gt;s_resgid
op_assign
id|EXT3_DEF_RESGID
suffix:semicolon
id|blocksize
op_assign
id|sb_min_blocksize
c_func
(paren
id|sb
comma
id|EXT3_MIN_BLOCK_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|blocksize
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;EXT3-fs: unable to set blocksize&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out_fail
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * The ext3 superblock will not be buffer aligned for other than 1kB&n;&t; * block sizes.  We need to calculate the offset from buffer start.&n;&t; */
r_if
c_cond
(paren
id|blocksize
op_ne
id|EXT3_MIN_BLOCK_SIZE
)paren
(brace
id|logic_sb_block
op_assign
(paren
id|sb_block
op_star
id|EXT3_MIN_BLOCK_SIZE
)paren
op_div
id|blocksize
suffix:semicolon
id|offset
op_assign
(paren
id|sb_block
op_star
id|EXT3_MIN_BLOCK_SIZE
)paren
op_mod
id|blocksize
suffix:semicolon
)brace
r_else
(brace
id|logic_sb_block
op_assign
id|sb_block
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|bh
op_assign
id|sb_bread
c_func
(paren
id|sb
comma
id|logic_sb_block
)paren
)paren
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;EXT3-fs: unable to read superblock&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out_fail
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Note: s_es must be initialized as soon as possible because&n;&t; *       some ext3 macro-instructions depend on its value&n;&t; */
id|es
op_assign
(paren
r_struct
id|ext3_super_block
op_star
)paren
(paren
(paren
(paren
r_char
op_star
)paren
id|bh-&gt;b_data
)paren
op_plus
id|offset
)paren
suffix:semicolon
id|sbi-&gt;s_es
op_assign
id|es
suffix:semicolon
id|sb-&gt;s_magic
op_assign
id|le16_to_cpu
c_func
(paren
id|es-&gt;s_magic
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sb-&gt;s_magic
op_ne
id|EXT3_SUPER_MAGIC
)paren
r_goto
id|cantfind_ext3
suffix:semicolon
multiline_comment|/* Set defaults before we parse the mount options */
id|def_mount_opts
op_assign
id|le32_to_cpu
c_func
(paren
id|es-&gt;s_default_mount_opts
)paren
suffix:semicolon
r_if
c_cond
(paren
id|def_mount_opts
op_amp
id|EXT3_DEFM_DEBUG
)paren
id|set_opt
c_func
(paren
id|sbi-&gt;s_mount_opt
comma
id|DEBUG
)paren
suffix:semicolon
r_if
c_cond
(paren
id|def_mount_opts
op_amp
id|EXT3_DEFM_BSDGROUPS
)paren
id|set_opt
c_func
(paren
id|sbi-&gt;s_mount_opt
comma
id|GRPID
)paren
suffix:semicolon
r_if
c_cond
(paren
id|def_mount_opts
op_amp
id|EXT3_DEFM_UID16
)paren
id|set_opt
c_func
(paren
id|sbi-&gt;s_mount_opt
comma
id|NO_UID32
)paren
suffix:semicolon
r_if
c_cond
(paren
id|def_mount_opts
op_amp
id|EXT3_DEFM_XATTR_USER
)paren
id|set_opt
c_func
(paren
id|sbi-&gt;s_mount_opt
comma
id|XATTR_USER
)paren
suffix:semicolon
r_if
c_cond
(paren
id|def_mount_opts
op_amp
id|EXT3_DEFM_ACL
)paren
id|set_opt
c_func
(paren
id|sbi-&gt;s_mount_opt
comma
id|POSIX_ACL
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|def_mount_opts
op_amp
id|EXT3_DEFM_JMODE
)paren
op_eq
id|EXT3_DEFM_JMODE_DATA
)paren
id|sbi-&gt;s_mount_opt
op_or_assign
id|EXT3_MOUNT_JOURNAL_DATA
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|def_mount_opts
op_amp
id|EXT3_DEFM_JMODE
)paren
op_eq
id|EXT3_DEFM_JMODE_ORDERED
)paren
id|sbi-&gt;s_mount_opt
op_or_assign
id|EXT3_MOUNT_ORDERED_DATA
suffix:semicolon
r_else
r_if
c_cond
(paren
(paren
id|def_mount_opts
op_amp
id|EXT3_DEFM_JMODE
)paren
op_eq
id|EXT3_DEFM_JMODE_WBACK
)paren
id|sbi-&gt;s_mount_opt
op_or_assign
id|EXT3_MOUNT_WRITEBACK_DATA
suffix:semicolon
r_if
c_cond
(paren
id|le16_to_cpu
c_func
(paren
id|sbi-&gt;s_es-&gt;s_errors
)paren
op_eq
id|EXT3_ERRORS_PANIC
)paren
id|set_opt
c_func
(paren
id|sbi-&gt;s_mount_opt
comma
id|ERRORS_PANIC
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|le16_to_cpu
c_func
(paren
id|sbi-&gt;s_es-&gt;s_errors
)paren
op_eq
id|EXT3_ERRORS_RO
)paren
id|set_opt
c_func
(paren
id|sbi-&gt;s_mount_opt
comma
id|ERRORS_RO
)paren
suffix:semicolon
id|sbi-&gt;s_resuid
op_assign
id|le16_to_cpu
c_func
(paren
id|es-&gt;s_def_resuid
)paren
suffix:semicolon
id|sbi-&gt;s_resgid
op_assign
id|le16_to_cpu
c_func
(paren
id|es-&gt;s_def_resgid
)paren
suffix:semicolon
id|set_opt
c_func
(paren
id|sbi-&gt;s_mount_opt
comma
id|RESERVATION
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|parse_options
(paren
(paren
r_char
op_star
)paren
id|data
comma
id|sb
comma
op_amp
id|journal_inum
comma
l_int|NULL
comma
l_int|0
)paren
)paren
r_goto
id|failed_mount
suffix:semicolon
id|sb-&gt;s_flags
op_or_assign
id|MS_ONE_SECOND
suffix:semicolon
id|sb-&gt;s_flags
op_assign
(paren
id|sb-&gt;s_flags
op_amp
op_complement
id|MS_POSIXACL
)paren
op_or
(paren
(paren
id|sbi-&gt;s_mount_opt
op_amp
id|EXT3_MOUNT_POSIX_ACL
)paren
ques
c_cond
id|MS_POSIXACL
suffix:colon
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|le32_to_cpu
c_func
(paren
id|es-&gt;s_rev_level
)paren
op_eq
id|EXT3_GOOD_OLD_REV
op_logical_and
(paren
id|EXT3_HAS_COMPAT_FEATURE
c_func
(paren
id|sb
comma
op_complement
l_int|0U
)paren
op_logical_or
id|EXT3_HAS_RO_COMPAT_FEATURE
c_func
(paren
id|sb
comma
op_complement
l_int|0U
)paren
op_logical_or
id|EXT3_HAS_INCOMPAT_FEATURE
c_func
(paren
id|sb
comma
op_complement
l_int|0U
)paren
)paren
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;EXT3-fs warning: feature flags set on rev 0 fs, &quot;
l_string|&quot;running e2fsck is recommended&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Check feature flags regardless of the revision level, since we&n;&t; * previously didn&squot;t change the revision level when setting the flags,&n;&t; * so there is a chance incompat flags are set on a rev 0 filesystem.&n;&t; */
id|features
op_assign
id|EXT3_HAS_INCOMPAT_FEATURE
c_func
(paren
id|sb
comma
op_complement
id|EXT3_FEATURE_INCOMPAT_SUPP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|features
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;EXT3-fs: %s: couldn&squot;t mount because of &quot;
l_string|&quot;unsupported optional features (%x).&bslash;n&quot;
comma
id|sb-&gt;s_id
comma
id|le32_to_cpu
c_func
(paren
id|features
)paren
)paren
suffix:semicolon
r_goto
id|failed_mount
suffix:semicolon
)brace
id|features
op_assign
id|EXT3_HAS_RO_COMPAT_FEATURE
c_func
(paren
id|sb
comma
op_complement
id|EXT3_FEATURE_RO_COMPAT_SUPP
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|sb-&gt;s_flags
op_amp
id|MS_RDONLY
)paren
op_logical_and
id|features
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;EXT3-fs: %s: couldn&squot;t mount RDWR because of &quot;
l_string|&quot;unsupported optional features (%x).&bslash;n&quot;
comma
id|sb-&gt;s_id
comma
id|le32_to_cpu
c_func
(paren
id|features
)paren
)paren
suffix:semicolon
r_goto
id|failed_mount
suffix:semicolon
)brace
id|blocksize
op_assign
id|BLOCK_SIZE
op_lshift
id|le32_to_cpu
c_func
(paren
id|es-&gt;s_log_block_size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|blocksize
template_param
id|EXT3_MAX_BLOCK_SIZE
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;EXT3-fs: Unsupported filesystem blocksize %d on %s.&bslash;n&quot;
comma
id|blocksize
comma
id|sb-&gt;s_id
)paren
suffix:semicolon
r_goto
id|failed_mount
suffix:semicolon
)brace
id|hblock
op_assign
id|bdev_hardsect_size
c_func
(paren
id|sb-&gt;s_bdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sb-&gt;s_blocksize
op_ne
id|blocksize
)paren
(brace
multiline_comment|/*&n;&t;&t; * Make sure the blocksize for the filesystem is larger&n;&t;&t; * than the hardware sectorsize for the machine.&n;&t;&t; */
r_if
c_cond
(paren
id|blocksize
OL
id|hblock
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;EXT3-fs: blocksize %d too small for &quot;
l_string|&quot;device blocksize %d.&bslash;n&quot;
comma
id|blocksize
comma
id|hblock
)paren
suffix:semicolon
r_goto
id|failed_mount
suffix:semicolon
)brace
id|brelse
(paren
id|bh
)paren
suffix:semicolon
id|sb_set_blocksize
c_func
(paren
id|sb
comma
id|blocksize
)paren
suffix:semicolon
id|logic_sb_block
op_assign
(paren
id|sb_block
op_star
id|EXT3_MIN_BLOCK_SIZE
)paren
op_div
id|blocksize
suffix:semicolon
id|offset
op_assign
(paren
id|sb_block
op_star
id|EXT3_MIN_BLOCK_SIZE
)paren
op_mod
id|blocksize
suffix:semicolon
id|bh
op_assign
id|sb_bread
c_func
(paren
id|sb
comma
id|logic_sb_block
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bh
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;EXT3-fs: Can&squot;t read superblock on 2nd try.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|failed_mount
suffix:semicolon
)brace
id|es
op_assign
(paren
r_struct
id|ext3_super_block
op_star
)paren
(paren
(paren
(paren
r_char
op_star
)paren
id|bh-&gt;b_data
)paren
op_plus
id|offset
)paren
suffix:semicolon
id|sbi-&gt;s_es
op_assign
id|es
suffix:semicolon
r_if
c_cond
(paren
id|es-&gt;s_magic
op_ne
id|cpu_to_le16
c_func
(paren
id|EXT3_SUPER_MAGIC
)paren
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;EXT3-fs: Magic mismatch, very weird !&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|failed_mount
suffix:semicolon
)brace
)brace
id|sb-&gt;s_maxbytes
op_assign
id|ext3_max_size
c_func
(paren
id|sb-&gt;s_blocksize_bits
)paren
suffix:semicolon
r_if
c_cond
(paren
id|le32_to_cpu
c_func
(paren
id|es-&gt;s_rev_level
)paren
op_eq
id|EXT3_GOOD_OLD_REV
)paren
(brace
id|sbi-&gt;s_inode_size
op_assign
id|EXT3_GOOD_OLD_INODE_SIZE
suffix:semicolon
id|sbi-&gt;s_first_ino
op_assign
id|EXT3_GOOD_OLD_FIRST_INO
suffix:semicolon
)brace
r_else
(brace
id|sbi-&gt;s_inode_size
op_assign
id|le16_to_cpu
c_func
(paren
id|es-&gt;s_inode_size
)paren
suffix:semicolon
id|sbi-&gt;s_first_ino
op_assign
id|le32_to_cpu
c_func
(paren
id|es-&gt;s_first_ino
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|sbi-&gt;s_inode_size
OL
id|EXT3_GOOD_OLD_INODE_SIZE
)paren
op_logical_or
(paren
id|sbi-&gt;s_inode_size
op_amp
(paren
id|sbi-&gt;s_inode_size
op_minus
l_int|1
)paren
)paren
op_logical_or
(paren
id|sbi-&gt;s_inode_size
OG
id|blocksize
)paren
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;EXT3-fs: unsupported inode size: %d&bslash;n&quot;
comma
id|sbi-&gt;s_inode_size
)paren
suffix:semicolon
r_goto
id|failed_mount
suffix:semicolon
)brace
)brace
id|sbi-&gt;s_frag_size
op_assign
id|EXT3_MIN_FRAG_SIZE
op_lshift
id|le32_to_cpu
c_func
(paren
id|es-&gt;s_log_frag_size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|blocksize
op_ne
id|sbi-&gt;s_frag_size
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;EXT3-fs: fragsize %lu != blocksize %u (unsupported)&bslash;n&quot;
comma
id|sbi-&gt;s_frag_size
comma
id|blocksize
)paren
suffix:semicolon
r_goto
id|failed_mount
suffix:semicolon
)brace
id|sbi-&gt;s_frags_per_block
op_assign
l_int|1
suffix:semicolon
id|sbi-&gt;s_blocks_per_group
op_assign
id|le32_to_cpu
c_func
(paren
id|es-&gt;s_blocks_per_group
)paren
suffix:semicolon
id|sbi-&gt;s_frags_per_group
op_assign
id|le32_to_cpu
c_func
(paren
id|es-&gt;s_frags_per_group
)paren
suffix:semicolon
id|sbi-&gt;s_inodes_per_group
op_assign
id|le32_to_cpu
c_func
(paren
id|es-&gt;s_inodes_per_group
)paren
suffix:semicolon
r_if
c_cond
(paren
id|EXT3_INODE_SIZE
c_func
(paren
id|sb
)paren
op_eq
l_int|0
)paren
r_goto
id|cantfind_ext3
suffix:semicolon
id|sbi-&gt;s_inodes_per_block
op_assign
id|blocksize
op_div
id|EXT3_INODE_SIZE
c_func
(paren
id|sb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sbi-&gt;s_inodes_per_block
op_eq
l_int|0
)paren
r_goto
id|cantfind_ext3
suffix:semicolon
id|sbi-&gt;s_itb_per_group
op_assign
id|sbi-&gt;s_inodes_per_group
op_div
id|sbi-&gt;s_inodes_per_block
suffix:semicolon
id|sbi-&gt;s_desc_per_block
op_assign
id|blocksize
op_div
r_sizeof
(paren
r_struct
id|ext3_group_desc
)paren
suffix:semicolon
id|sbi-&gt;s_sbh
op_assign
id|bh
suffix:semicolon
id|sbi-&gt;s_mount_state
op_assign
id|le16_to_cpu
c_func
(paren
id|es-&gt;s_state
)paren
suffix:semicolon
id|sbi-&gt;s_addr_per_block_bits
op_assign
id|log2
c_func
(paren
id|EXT3_ADDR_PER_BLOCK
c_func
(paren
id|sb
)paren
)paren
suffix:semicolon
id|sbi-&gt;s_desc_per_block_bits
op_assign
id|log2
c_func
(paren
id|EXT3_DESC_PER_BLOCK
c_func
(paren
id|sb
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|4
suffix:semicolon
id|i
op_increment
)paren
id|sbi-&gt;s_hash_seed
(braket
id|i
)braket
op_assign
id|le32_to_cpu
c_func
(paren
id|es-&gt;s_hash_seed
(braket
id|i
)braket
)paren
suffix:semicolon
id|sbi-&gt;s_def_hash_version
op_assign
id|es-&gt;s_def_hash_version
suffix:semicolon
r_if
c_cond
(paren
id|sbi-&gt;s_blocks_per_group
OG
id|blocksize
op_star
l_int|8
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;EXT3-fs: #blocks per group too big: %lu&bslash;n&quot;
comma
id|sbi-&gt;s_blocks_per_group
)paren
suffix:semicolon
r_goto
id|failed_mount
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sbi-&gt;s_frags_per_group
OG
id|blocksize
op_star
l_int|8
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;EXT3-fs: #fragments per group too big: %lu&bslash;n&quot;
comma
id|sbi-&gt;s_frags_per_group
)paren
suffix:semicolon
r_goto
id|failed_mount
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sbi-&gt;s_inodes_per_group
OG
id|blocksize
op_star
l_int|8
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;EXT3-fs: #inodes per group too big: %lu&bslash;n&quot;
comma
id|sbi-&gt;s_inodes_per_group
)paren
suffix:semicolon
r_goto
id|failed_mount
suffix:semicolon
)brace
r_if
c_cond
(paren
id|EXT3_BLOCKS_PER_GROUP
c_func
(paren
id|sb
)paren
op_eq
l_int|0
)paren
r_goto
id|cantfind_ext3
suffix:semicolon
id|sbi-&gt;s_groups_count
op_assign
(paren
id|le32_to_cpu
c_func
(paren
id|es-&gt;s_blocks_count
)paren
op_minus
id|le32_to_cpu
c_func
(paren
id|es-&gt;s_first_data_block
)paren
op_plus
id|EXT3_BLOCKS_PER_GROUP
c_func
(paren
id|sb
)paren
op_minus
l_int|1
)paren
op_div
id|EXT3_BLOCKS_PER_GROUP
c_func
(paren
id|sb
)paren
suffix:semicolon
id|db_count
op_assign
(paren
id|sbi-&gt;s_groups_count
op_plus
id|EXT3_DESC_PER_BLOCK
c_func
(paren
id|sb
)paren
op_minus
l_int|1
)paren
op_div
id|EXT3_DESC_PER_BLOCK
c_func
(paren
id|sb
)paren
suffix:semicolon
id|sbi-&gt;s_group_desc
op_assign
id|kmalloc
c_func
(paren
id|db_count
op_star
r_sizeof
(paren
r_struct
id|buffer_head
op_star
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sbi-&gt;s_group_desc
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;EXT3-fs: not enough memory&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|failed_mount
suffix:semicolon
)brace
id|percpu_counter_init
c_func
(paren
op_amp
id|sbi-&gt;s_freeblocks_counter
)paren
suffix:semicolon
id|percpu_counter_init
c_func
(paren
op_amp
id|sbi-&gt;s_freeinodes_counter
)paren
suffix:semicolon
id|percpu_counter_init
c_func
(paren
op_amp
id|sbi-&gt;s_dirs_counter
)paren
suffix:semicolon
id|bgl_lock_init
c_func
(paren
op_amp
id|sbi-&gt;s_blockgroup_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|db_count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|block
op_assign
id|descriptor_loc
c_func
(paren
id|sb
comma
id|logic_sb_block
comma
id|i
)paren
suffix:semicolon
id|sbi-&gt;s_group_desc
(braket
id|i
)braket
op_assign
id|sb_bread
c_func
(paren
id|sb
comma
id|block
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sbi-&gt;s_group_desc
(braket
id|i
)braket
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;EXT3-fs: &quot;
l_string|&quot;can&squot;t read group descriptor %d&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
id|db_count
op_assign
id|i
suffix:semicolon
r_goto
id|failed_mount2
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|ext3_check_descriptors
(paren
id|sb
)paren
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;EXT3-fs: group descriptors corrupted !&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|failed_mount2
suffix:semicolon
)brace
id|sbi-&gt;s_gdb_count
op_assign
id|db_count
suffix:semicolon
id|get_random_bytes
c_func
(paren
op_amp
id|sbi-&gt;s_next_generation
comma
r_sizeof
(paren
id|u32
)paren
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|sbi-&gt;s_next_gen_lock
)paren
suffix:semicolon
multiline_comment|/* per fileystem reservation list head &amp; lock */
id|spin_lock_init
c_func
(paren
op_amp
id|sbi-&gt;s_rsv_window_lock
)paren
suffix:semicolon
id|sbi-&gt;s_rsv_window_root
op_assign
id|RB_ROOT
suffix:semicolon
multiline_comment|/* Add a single, static dummy reservation to the start of the&n;&t; * reservation window list --- it gives us a placeholder for&n;&t; * append-at-start-of-list which makes the allocation logic&n;&t; * _much_ simpler. */
id|sbi-&gt;s_rsv_window_head.rsv_start
op_assign
id|EXT3_RESERVE_WINDOW_NOT_ALLOCATED
suffix:semicolon
id|sbi-&gt;s_rsv_window_head.rsv_end
op_assign
id|EXT3_RESERVE_WINDOW_NOT_ALLOCATED
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|sbi-&gt;s_rsv_window_head.rsv_alloc_hit
comma
l_int|0
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|sbi-&gt;s_rsv_window_head.rsv_goal_size
comma
l_int|0
)paren
suffix:semicolon
id|ext3_rsv_window_add
c_func
(paren
id|sb
comma
op_amp
id|sbi-&gt;s_rsv_window_head
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * set up enough so that it can read an inode&n;&t; */
id|sb-&gt;s_op
op_assign
op_amp
id|ext3_sops
suffix:semicolon
id|sb-&gt;s_export_op
op_assign
op_amp
id|ext3_export_ops
suffix:semicolon
id|sb-&gt;s_xattr
op_assign
id|ext3_xattr_handlers
suffix:semicolon
macro_line|#ifdef CONFIG_QUOTA
id|sb-&gt;s_qcop
op_assign
op_amp
id|ext3_qctl_operations
suffix:semicolon
id|sb-&gt;dq_op
op_assign
op_amp
id|ext3_quota_operations
suffix:semicolon
macro_line|#endif
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|sbi-&gt;s_orphan
)paren
suffix:semicolon
multiline_comment|/* unlinked but open files */
id|sb-&gt;s_root
op_assign
l_int|NULL
suffix:semicolon
id|needs_recovery
op_assign
(paren
id|es-&gt;s_last_orphan
op_ne
l_int|0
op_logical_or
id|EXT3_HAS_INCOMPAT_FEATURE
c_func
(paren
id|sb
comma
id|EXT3_FEATURE_INCOMPAT_RECOVER
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * The first inode we look at is the journal inode.  Don&squot;t try&n;&t; * root first: it may be modified in the journal!&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|test_opt
c_func
(paren
id|sb
comma
id|NOLOAD
)paren
op_logical_and
id|EXT3_HAS_COMPAT_FEATURE
c_func
(paren
id|sb
comma
id|EXT3_FEATURE_COMPAT_HAS_JOURNAL
)paren
)paren
(brace
r_if
c_cond
(paren
id|ext3_load_journal
c_func
(paren
id|sb
comma
id|es
)paren
)paren
r_goto
id|failed_mount2
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|journal_inum
)paren
(brace
r_if
c_cond
(paren
id|ext3_create_journal
c_func
(paren
id|sb
comma
id|es
comma
id|journal_inum
)paren
)paren
r_goto
id|failed_mount2
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
op_logical_neg
id|silent
)paren
id|printk
(paren
id|KERN_ERR
l_string|&quot;ext3: No journal on filesystem on %s&bslash;n&quot;
comma
id|sb-&gt;s_id
)paren
suffix:semicolon
r_goto
id|failed_mount2
suffix:semicolon
)brace
multiline_comment|/* We have now updated the journal if required, so we can&n;&t; * validate the data journaling mode. */
r_switch
c_cond
(paren
id|test_opt
c_func
(paren
id|sb
comma
id|DATA_FLAGS
)paren
)paren
(brace
r_case
l_int|0
suffix:colon
multiline_comment|/* No mode set, assume a default based on the journal&n;                   capabilities: ORDERED_DATA if the journal can&n;                   cope, else JOURNAL_DATA */
r_if
c_cond
(paren
id|journal_check_available_features
(paren
id|sbi-&gt;s_journal
comma
l_int|0
comma
l_int|0
comma
id|JFS_FEATURE_INCOMPAT_REVOKE
)paren
)paren
id|set_opt
c_func
(paren
id|sbi-&gt;s_mount_opt
comma
id|ORDERED_DATA
)paren
suffix:semicolon
r_else
id|set_opt
c_func
(paren
id|sbi-&gt;s_mount_opt
comma
id|JOURNAL_DATA
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|EXT3_MOUNT_ORDERED_DATA
suffix:colon
r_case
id|EXT3_MOUNT_WRITEBACK_DATA
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|journal_check_available_features
(paren
id|sbi-&gt;s_journal
comma
l_int|0
comma
l_int|0
comma
id|JFS_FEATURE_INCOMPAT_REVOKE
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;EXT3-fs: Journal does not support &quot;
l_string|&quot;requested data journaling mode&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|failed_mount3
suffix:semicolon
)brace
r_default
suffix:colon
r_break
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * The journal_load will have done any necessary log recovery,&n;&t; * so we can safely mount the rest of the filesystem now.&n;&t; */
id|root
op_assign
id|iget
c_func
(paren
id|sb
comma
id|EXT3_ROOT_INO
)paren
suffix:semicolon
id|sb-&gt;s_root
op_assign
id|d_alloc_root
c_func
(paren
id|root
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sb-&gt;s_root
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;EXT3-fs: get root inode failed&bslash;n&quot;
)paren
suffix:semicolon
id|iput
c_func
(paren
id|root
)paren
suffix:semicolon
r_goto
id|failed_mount3
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|S_ISDIR
c_func
(paren
id|root-&gt;i_mode
)paren
op_logical_or
op_logical_neg
id|root-&gt;i_blocks
op_logical_or
op_logical_neg
id|root-&gt;i_size
)paren
(brace
id|dput
c_func
(paren
id|sb-&gt;s_root
)paren
suffix:semicolon
id|sb-&gt;s_root
op_assign
l_int|NULL
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;EXT3-fs: corrupt root inode, run e2fsck&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|failed_mount3
suffix:semicolon
)brace
id|ext3_setup_super
(paren
id|sb
comma
id|es
comma
id|sb-&gt;s_flags
op_amp
id|MS_RDONLY
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * akpm: core read_super() calls in here with the superblock locked.&n;&t; * That deadlocks, because orphan cleanup needs to lock the superblock&n;&t; * in numerous places.  Here we just pop the lock - it&squot;s relatively&n;&t; * harmless, because we are now ready to accept write_super() requests,&n;&t; * and aviro says that&squot;s the only reason for hanging onto the&n;&t; * superblock lock.&n;&t; */
id|EXT3_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|s_mount_state
op_or_assign
id|EXT3_ORPHAN_FS
suffix:semicolon
id|ext3_orphan_cleanup
c_func
(paren
id|sb
comma
id|es
)paren
suffix:semicolon
id|EXT3_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|s_mount_state
op_and_assign
op_complement
id|EXT3_ORPHAN_FS
suffix:semicolon
r_if
c_cond
(paren
id|needs_recovery
)paren
id|printk
(paren
id|KERN_INFO
l_string|&quot;EXT3-fs: recovery complete.&bslash;n&quot;
)paren
suffix:semicolon
id|ext3_mark_recovery_complete
c_func
(paren
id|sb
comma
id|es
)paren
suffix:semicolon
id|printk
(paren
id|KERN_INFO
l_string|&quot;EXT3-fs: mounted filesystem with %s data mode.&bslash;n&quot;
comma
id|test_opt
c_func
(paren
id|sb
comma
id|DATA_FLAGS
)paren
op_eq
id|EXT3_MOUNT_JOURNAL_DATA
ques
c_cond
l_string|&quot;journal&quot;
suffix:colon
id|test_opt
c_func
(paren
id|sb
comma
id|DATA_FLAGS
)paren
op_eq
id|EXT3_MOUNT_ORDERED_DATA
ques
c_cond
l_string|&quot;ordered&quot;
suffix:colon
l_string|&quot;writeback&quot;
)paren
suffix:semicolon
id|percpu_counter_mod
c_func
(paren
op_amp
id|sbi-&gt;s_freeblocks_counter
comma
id|ext3_count_free_blocks
c_func
(paren
id|sb
)paren
)paren
suffix:semicolon
id|percpu_counter_mod
c_func
(paren
op_amp
id|sbi-&gt;s_freeinodes_counter
comma
id|ext3_count_free_inodes
c_func
(paren
id|sb
)paren
)paren
suffix:semicolon
id|percpu_counter_mod
c_func
(paren
op_amp
id|sbi-&gt;s_dirs_counter
comma
id|ext3_count_dirs
c_func
(paren
id|sb
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|cantfind_ext3
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|silent
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;VFS: Can&squot;t find ext3 filesystem on dev %s.&bslash;n&quot;
comma
id|sb-&gt;s_id
)paren
suffix:semicolon
r_goto
id|failed_mount
suffix:semicolon
id|failed_mount3
suffix:colon
id|journal_destroy
c_func
(paren
id|sbi-&gt;s_journal
)paren
suffix:semicolon
id|failed_mount2
suffix:colon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|db_count
suffix:semicolon
id|i
op_increment
)paren
id|brelse
c_func
(paren
id|sbi-&gt;s_group_desc
(braket
id|i
)braket
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|sbi-&gt;s_group_desc
)paren
suffix:semicolon
id|failed_mount
suffix:colon
macro_line|#ifdef CONFIG_QUOTA
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAXQUOTAS
suffix:semicolon
id|i
op_increment
)paren
id|kfree
c_func
(paren
id|sbi-&gt;s_qf_names
(braket
id|i
)braket
)paren
suffix:semicolon
macro_line|#endif
id|ext3_blkdev_remove
c_func
(paren
id|sbi
)paren
suffix:semicolon
id|brelse
c_func
(paren
id|bh
)paren
suffix:semicolon
id|out_fail
suffix:colon
id|sb-&gt;s_fs_info
op_assign
l_int|NULL
suffix:semicolon
id|kfree
c_func
(paren
id|sbi
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/*&n; * Setup any per-fs journal parameters now.  We&squot;ll do this both on&n; * initial mount, once the journal has been initialised but before we&squot;ve&n; * done any recovery; and again on any subsequent remount. &n; */
DECL|function|ext3_init_journal_params
r_static
r_void
id|ext3_init_journal_params
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
id|journal_t
op_star
id|journal
)paren
(brace
r_struct
id|ext3_sb_info
op_star
id|sbi
op_assign
id|EXT3_SB
c_func
(paren
id|sb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sbi-&gt;s_commit_interval
)paren
id|journal-&gt;j_commit_interval
op_assign
id|sbi-&gt;s_commit_interval
suffix:semicolon
multiline_comment|/* We could also set up an ext3-specific default for the commit&n;&t; * interval here, but for now we&squot;ll just fall back to the jbd&n;&t; * default. */
id|spin_lock
c_func
(paren
op_amp
id|journal-&gt;j_state_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|test_opt
c_func
(paren
id|sb
comma
id|BARRIER
)paren
)paren
id|journal-&gt;j_flags
op_or_assign
id|JFS_BARRIER
suffix:semicolon
r_else
id|journal-&gt;j_flags
op_and_assign
op_complement
id|JFS_BARRIER
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|journal-&gt;j_state_lock
)paren
suffix:semicolon
)brace
DECL|function|ext3_get_journal
r_static
id|journal_t
op_star
id|ext3_get_journal
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_int
id|journal_inum
)paren
(brace
r_struct
id|inode
op_star
id|journal_inode
suffix:semicolon
id|journal_t
op_star
id|journal
suffix:semicolon
multiline_comment|/* First, test for the existence of a valid inode on disk.  Bad&n;&t; * things happen if we iget() an unused inode, as the subsequent&n;&t; * iput() will try to delete it. */
id|journal_inode
op_assign
id|iget
c_func
(paren
id|sb
comma
id|journal_inum
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|journal_inode
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;EXT3-fs: no journal found.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|journal_inode-&gt;i_nlink
)paren
(brace
id|make_bad_inode
c_func
(paren
id|journal_inode
)paren
suffix:semicolon
id|iput
c_func
(paren
id|journal_inode
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;EXT3-fs: journal inode is deleted.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|jbd_debug
c_func
(paren
l_int|2
comma
l_string|&quot;Journal inode found at %p: %Ld bytes&bslash;n&quot;
comma
id|journal_inode
comma
id|journal_inode-&gt;i_size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|is_bad_inode
c_func
(paren
id|journal_inode
)paren
op_logical_or
op_logical_neg
id|S_ISREG
c_func
(paren
id|journal_inode-&gt;i_mode
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;EXT3-fs: invalid journal inode.&bslash;n&quot;
)paren
suffix:semicolon
id|iput
c_func
(paren
id|journal_inode
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|journal
op_assign
id|journal_init_inode
c_func
(paren
id|journal_inode
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|journal
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;EXT3-fs: Could not load journal inode&bslash;n&quot;
)paren
suffix:semicolon
id|iput
c_func
(paren
id|journal_inode
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|journal-&gt;j_private
op_assign
id|sb
suffix:semicolon
id|ext3_init_journal_params
c_func
(paren
id|sb
comma
id|journal
)paren
suffix:semicolon
r_return
id|journal
suffix:semicolon
)brace
DECL|function|ext3_get_dev_journal
r_static
id|journal_t
op_star
id|ext3_get_dev_journal
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
id|dev_t
id|j_dev
)paren
(brace
r_struct
id|buffer_head
op_star
id|bh
suffix:semicolon
id|journal_t
op_star
id|journal
suffix:semicolon
r_int
id|start
suffix:semicolon
r_int
id|len
suffix:semicolon
r_int
id|hblock
comma
id|blocksize
suffix:semicolon
r_int
r_int
id|sb_block
suffix:semicolon
r_int
r_int
id|offset
suffix:semicolon
r_struct
id|ext3_super_block
op_star
id|es
suffix:semicolon
r_struct
id|block_device
op_star
id|bdev
suffix:semicolon
id|bdev
op_assign
id|ext3_blkdev_get
c_func
(paren
id|j_dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bdev
op_eq
l_int|NULL
)paren
r_return
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|bd_claim
c_func
(paren
id|bdev
comma
id|sb
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;EXT3: failed to claim external journal device.&bslash;n&quot;
)paren
suffix:semicolon
id|blkdev_put
c_func
(paren
id|bdev
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|blocksize
op_assign
id|sb-&gt;s_blocksize
suffix:semicolon
id|hblock
op_assign
id|bdev_hardsect_size
c_func
(paren
id|bdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|blocksize
OL
id|hblock
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;EXT3-fs: blocksize too small for journal device.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out_bdev
suffix:semicolon
)brace
id|sb_block
op_assign
id|EXT3_MIN_BLOCK_SIZE
op_div
id|blocksize
suffix:semicolon
id|offset
op_assign
id|EXT3_MIN_BLOCK_SIZE
op_mod
id|blocksize
suffix:semicolon
id|set_blocksize
c_func
(paren
id|bdev
comma
id|blocksize
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|bh
op_assign
id|__bread
c_func
(paren
id|bdev
comma
id|sb_block
comma
id|blocksize
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;EXT3-fs: couldn&squot;t read superblock of &quot;
l_string|&quot;external journal&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out_bdev
suffix:semicolon
)brace
id|es
op_assign
(paren
r_struct
id|ext3_super_block
op_star
)paren
(paren
(paren
(paren
r_char
op_star
)paren
id|bh-&gt;b_data
)paren
op_plus
id|offset
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|le16_to_cpu
c_func
(paren
id|es-&gt;s_magic
)paren
op_ne
id|EXT3_SUPER_MAGIC
)paren
op_logical_or
op_logical_neg
(paren
id|le32_to_cpu
c_func
(paren
id|es-&gt;s_feature_incompat
)paren
op_amp
id|EXT3_FEATURE_INCOMPAT_JOURNAL_DEV
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;EXT3-fs: external journal has &quot;
l_string|&quot;bad superblock&bslash;n&quot;
)paren
suffix:semicolon
id|brelse
c_func
(paren
id|bh
)paren
suffix:semicolon
r_goto
id|out_bdev
suffix:semicolon
)brace
r_if
c_cond
(paren
id|memcmp
c_func
(paren
id|EXT3_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|s_es-&gt;s_journal_uuid
comma
id|es-&gt;s_uuid
comma
l_int|16
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;EXT3-fs: journal UUID does not match&bslash;n&quot;
)paren
suffix:semicolon
id|brelse
c_func
(paren
id|bh
)paren
suffix:semicolon
r_goto
id|out_bdev
suffix:semicolon
)brace
id|len
op_assign
id|le32_to_cpu
c_func
(paren
id|es-&gt;s_blocks_count
)paren
suffix:semicolon
id|start
op_assign
id|sb_block
op_plus
l_int|1
suffix:semicolon
id|brelse
c_func
(paren
id|bh
)paren
suffix:semicolon
multiline_comment|/* we&squot;re done with the superblock */
id|journal
op_assign
id|journal_init_dev
c_func
(paren
id|bdev
comma
id|sb-&gt;s_bdev
comma
id|start
comma
id|len
comma
id|blocksize
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|journal
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;EXT3-fs: failed to create device journal&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out_bdev
suffix:semicolon
)brace
id|journal-&gt;j_private
op_assign
id|sb
suffix:semicolon
id|ll_rw_block
c_func
(paren
id|READ
comma
l_int|1
comma
op_amp
id|journal-&gt;j_sb_buffer
)paren
suffix:semicolon
id|wait_on_buffer
c_func
(paren
id|journal-&gt;j_sb_buffer
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|buffer_uptodate
c_func
(paren
id|journal-&gt;j_sb_buffer
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;EXT3-fs: I/O error on journal device&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out_journal
suffix:semicolon
)brace
r_if
c_cond
(paren
id|be32_to_cpu
c_func
(paren
id|journal-&gt;j_superblock-&gt;s_nr_users
)paren
op_ne
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;EXT3-fs: External journal has more than one &quot;
l_string|&quot;user (unsupported) - %d&bslash;n&quot;
comma
id|be32_to_cpu
c_func
(paren
id|journal-&gt;j_superblock-&gt;s_nr_users
)paren
)paren
suffix:semicolon
r_goto
id|out_journal
suffix:semicolon
)brace
id|EXT3_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|journal_bdev
op_assign
id|bdev
suffix:semicolon
id|ext3_init_journal_params
c_func
(paren
id|sb
comma
id|journal
)paren
suffix:semicolon
r_return
id|journal
suffix:semicolon
id|out_journal
suffix:colon
id|journal_destroy
c_func
(paren
id|journal
)paren
suffix:semicolon
id|out_bdev
suffix:colon
id|ext3_blkdev_put
c_func
(paren
id|bdev
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|ext3_load_journal
r_static
r_int
id|ext3_load_journal
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|ext3_super_block
op_star
id|es
)paren
(brace
id|journal_t
op_star
id|journal
suffix:semicolon
r_int
id|journal_inum
op_assign
id|le32_to_cpu
c_func
(paren
id|es-&gt;s_journal_inum
)paren
suffix:semicolon
id|dev_t
id|journal_dev
op_assign
id|new_decode_dev
c_func
(paren
id|le32_to_cpu
c_func
(paren
id|es-&gt;s_journal_dev
)paren
)paren
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
r_int
id|really_read_only
suffix:semicolon
id|really_read_only
op_assign
id|bdev_read_only
c_func
(paren
id|sb-&gt;s_bdev
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Are we loading a blank journal or performing recovery after a&n;&t; * crash?  For recovery, we need to check in advance whether we&n;&t; * can get read-write access to the device.&n;&t; */
r_if
c_cond
(paren
id|EXT3_HAS_INCOMPAT_FEATURE
c_func
(paren
id|sb
comma
id|EXT3_FEATURE_INCOMPAT_RECOVER
)paren
)paren
(brace
r_if
c_cond
(paren
id|sb-&gt;s_flags
op_amp
id|MS_RDONLY
)paren
(brace
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;EXT3-fs: INFO: recovery &quot;
l_string|&quot;required on readonly filesystem.&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|really_read_only
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;EXT3-fs: write access &quot;
l_string|&quot;unavailable, cannot proceed.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EROFS
suffix:semicolon
)brace
id|printk
(paren
id|KERN_INFO
l_string|&quot;EXT3-fs: write access will &quot;
l_string|&quot;be enabled during recovery.&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|journal_inum
op_logical_and
id|journal_dev
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;EXT3-fs: filesystem has both journal &quot;
l_string|&quot;and inode journals!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|journal_inum
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|journal
op_assign
id|ext3_get_journal
c_func
(paren
id|sb
comma
id|journal_inum
)paren
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|journal
op_assign
id|ext3_get_dev_journal
c_func
(paren
id|sb
comma
id|journal_dev
)paren
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|really_read_only
op_logical_and
id|test_opt
c_func
(paren
id|sb
comma
id|UPDATE_JOURNAL
)paren
)paren
(brace
id|err
op_assign
id|journal_update_format
c_func
(paren
id|journal
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;EXT3-fs: error updating journal.&bslash;n&quot;
)paren
suffix:semicolon
id|journal_destroy
c_func
(paren
id|journal
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|EXT3_HAS_INCOMPAT_FEATURE
c_func
(paren
id|sb
comma
id|EXT3_FEATURE_INCOMPAT_RECOVER
)paren
)paren
id|err
op_assign
id|journal_wipe
c_func
(paren
id|journal
comma
op_logical_neg
id|really_read_only
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|err
)paren
id|err
op_assign
id|journal_load
c_func
(paren
id|journal
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;EXT3-fs: error loading journal.&bslash;n&quot;
)paren
suffix:semicolon
id|journal_destroy
c_func
(paren
id|journal
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|EXT3_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|s_journal
op_assign
id|journal
suffix:semicolon
id|ext3_clear_journal_err
c_func
(paren
id|sb
comma
id|es
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ext3_create_journal
r_static
r_int
id|ext3_create_journal
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|ext3_super_block
op_star
id|es
comma
r_int
id|journal_inum
)paren
(brace
id|journal_t
op_star
id|journal
suffix:semicolon
r_if
c_cond
(paren
id|sb-&gt;s_flags
op_amp
id|MS_RDONLY
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;EXT3-fs: readonly filesystem when trying to &quot;
l_string|&quot;create journal.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EROFS
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|journal
op_assign
id|ext3_get_journal
c_func
(paren
id|sb
comma
id|journal_inum
)paren
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;EXT3-fs: creating new journal on inode %d&bslash;n&quot;
comma
id|journal_inum
)paren
suffix:semicolon
r_if
c_cond
(paren
id|journal_create
c_func
(paren
id|journal
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;EXT3-fs: error creating journal.&bslash;n&quot;
)paren
suffix:semicolon
id|journal_destroy
c_func
(paren
id|journal
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|EXT3_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|s_journal
op_assign
id|journal
suffix:semicolon
id|ext3_update_dynamic_rev
c_func
(paren
id|sb
)paren
suffix:semicolon
id|EXT3_SET_INCOMPAT_FEATURE
c_func
(paren
id|sb
comma
id|EXT3_FEATURE_INCOMPAT_RECOVER
)paren
suffix:semicolon
id|EXT3_SET_COMPAT_FEATURE
c_func
(paren
id|sb
comma
id|EXT3_FEATURE_COMPAT_HAS_JOURNAL
)paren
suffix:semicolon
id|es-&gt;s_journal_inum
op_assign
id|cpu_to_le32
c_func
(paren
id|journal_inum
)paren
suffix:semicolon
id|sb-&gt;s_dirt
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Make sure we flush the recovery flag to disk. */
id|ext3_commit_super
c_func
(paren
id|sb
comma
id|es
comma
l_int|1
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ext3_commit_super
r_static
r_void
id|ext3_commit_super
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|ext3_super_block
op_star
id|es
comma
r_int
id|sync
)paren
(brace
r_struct
id|buffer_head
op_star
id|sbh
op_assign
id|EXT3_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|s_sbh
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sbh
)paren
r_return
suffix:semicolon
id|es-&gt;s_wtime
op_assign
id|cpu_to_le32
c_func
(paren
id|get_seconds
c_func
(paren
)paren
)paren
suffix:semicolon
id|es-&gt;s_free_blocks_count
op_assign
id|cpu_to_le32
c_func
(paren
id|ext3_count_free_blocks
c_func
(paren
id|sb
)paren
)paren
suffix:semicolon
id|es-&gt;s_free_inodes_count
op_assign
id|cpu_to_le32
c_func
(paren
id|ext3_count_free_inodes
c_func
(paren
id|sb
)paren
)paren
suffix:semicolon
id|BUFFER_TRACE
c_func
(paren
id|sbh
comma
l_string|&quot;marking dirty&quot;
)paren
suffix:semicolon
id|mark_buffer_dirty
c_func
(paren
id|sbh
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sync
)paren
id|sync_dirty_buffer
c_func
(paren
id|sbh
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Have we just finished recovery?  If so, and if we are mounting (or&n; * remounting) the filesystem readonly, then we will end up with a&n; * consistent fs on disk.  Record that fact.&n; */
DECL|function|ext3_mark_recovery_complete
r_static
r_void
id|ext3_mark_recovery_complete
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|ext3_super_block
op_star
id|es
)paren
(brace
id|journal_t
op_star
id|journal
op_assign
id|EXT3_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|s_journal
suffix:semicolon
id|journal_lock_updates
c_func
(paren
id|journal
)paren
suffix:semicolon
id|journal_flush
c_func
(paren
id|journal
)paren
suffix:semicolon
r_if
c_cond
(paren
id|EXT3_HAS_INCOMPAT_FEATURE
c_func
(paren
id|sb
comma
id|EXT3_FEATURE_INCOMPAT_RECOVER
)paren
op_logical_and
id|sb-&gt;s_flags
op_amp
id|MS_RDONLY
)paren
(brace
id|EXT3_CLEAR_INCOMPAT_FEATURE
c_func
(paren
id|sb
comma
id|EXT3_FEATURE_INCOMPAT_RECOVER
)paren
suffix:semicolon
id|sb-&gt;s_dirt
op_assign
l_int|0
suffix:semicolon
id|ext3_commit_super
c_func
(paren
id|sb
comma
id|es
comma
l_int|1
)paren
suffix:semicolon
)brace
id|journal_unlock_updates
c_func
(paren
id|journal
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * If we are mounting (or read-write remounting) a filesystem whose journal&n; * has recorded an error from a previous lifetime, move that error to the&n; * main filesystem now.&n; */
DECL|function|ext3_clear_journal_err
r_static
r_void
id|ext3_clear_journal_err
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|ext3_super_block
op_star
id|es
)paren
(brace
id|journal_t
op_star
id|journal
suffix:semicolon
r_int
id|j_errno
suffix:semicolon
r_const
r_char
op_star
id|errstr
suffix:semicolon
id|journal
op_assign
id|EXT3_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|s_journal
suffix:semicolon
multiline_comment|/*&n;&t; * Now check for any error status which may have been recorded in the&n;&t; * journal by a prior ext3_error() or ext3_abort()&n;&t; */
id|j_errno
op_assign
id|journal_errno
c_func
(paren
id|journal
)paren
suffix:semicolon
r_if
c_cond
(paren
id|j_errno
)paren
(brace
r_char
id|nbuf
(braket
l_int|16
)braket
suffix:semicolon
id|errstr
op_assign
id|ext3_decode_error
c_func
(paren
id|sb
comma
id|j_errno
comma
id|nbuf
)paren
suffix:semicolon
id|ext3_warning
c_func
(paren
id|sb
comma
id|__FUNCTION__
comma
l_string|&quot;Filesystem error recorded &quot;
l_string|&quot;from previous mount: %s&quot;
comma
id|errstr
)paren
suffix:semicolon
id|ext3_warning
c_func
(paren
id|sb
comma
id|__FUNCTION__
comma
l_string|&quot;Marking fs in need of &quot;
l_string|&quot;filesystem check.&quot;
)paren
suffix:semicolon
id|EXT3_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|s_mount_state
op_or_assign
id|EXT3_ERROR_FS
suffix:semicolon
id|es-&gt;s_state
op_or_assign
id|cpu_to_le16
c_func
(paren
id|EXT3_ERROR_FS
)paren
suffix:semicolon
id|ext3_commit_super
(paren
id|sb
comma
id|es
comma
l_int|1
)paren
suffix:semicolon
id|journal_clear_err
c_func
(paren
id|journal
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Force the running and committing transactions to commit,&n; * and wait on the commit.&n; */
DECL|function|ext3_force_commit
r_int
id|ext3_force_commit
c_func
(paren
r_struct
id|super_block
op_star
id|sb
)paren
(brace
id|journal_t
op_star
id|journal
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
id|sb-&gt;s_flags
op_amp
id|MS_RDONLY
)paren
r_return
l_int|0
suffix:semicolon
id|journal
op_assign
id|EXT3_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|s_journal
suffix:semicolon
id|sb-&gt;s_dirt
op_assign
l_int|0
suffix:semicolon
id|ret
op_assign
id|ext3_journal_force_commit
c_func
(paren
id|journal
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n; * Ext3 always journals updates to the superblock itself, so we don&squot;t&n; * have to propagate any other updates to the superblock on disk at this&n; * point.  Just start an async writeback to get the buffers on their way&n; * to the disk.&n; *&n; * This implicitly triggers the writebehind on sync().&n; */
DECL|function|ext3_write_super
r_void
id|ext3_write_super
(paren
r_struct
id|super_block
op_star
id|sb
)paren
(brace
r_if
c_cond
(paren
id|down_trylock
c_func
(paren
op_amp
id|sb-&gt;s_lock
)paren
op_eq
l_int|0
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
id|sb-&gt;s_dirt
op_assign
l_int|0
suffix:semicolon
)brace
DECL|function|ext3_sync_fs
r_static
r_int
id|ext3_sync_fs
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_int
id|wait
)paren
(brace
id|tid_t
id|target
suffix:semicolon
id|sb-&gt;s_dirt
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|journal_start_commit
c_func
(paren
id|EXT3_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|s_journal
comma
op_amp
id|target
)paren
)paren
(brace
r_if
c_cond
(paren
id|wait
)paren
id|log_wait_commit
c_func
(paren
id|EXT3_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|s_journal
comma
id|target
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * LVM calls this function before a (read-only) snapshot is created.  This&n; * gives us a chance to flush the journal completely and mark the fs clean.&n; */
DECL|function|ext3_write_super_lockfs
r_void
id|ext3_write_super_lockfs
c_func
(paren
r_struct
id|super_block
op_star
id|sb
)paren
(brace
id|sb-&gt;s_dirt
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|sb-&gt;s_flags
op_amp
id|MS_RDONLY
)paren
)paren
(brace
id|journal_t
op_star
id|journal
op_assign
id|EXT3_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|s_journal
suffix:semicolon
multiline_comment|/* Now we set up the journal barrier. */
id|journal_lock_updates
c_func
(paren
id|journal
)paren
suffix:semicolon
id|journal_flush
c_func
(paren
id|journal
)paren
suffix:semicolon
multiline_comment|/* Journal blocked and flushed, clear needs_recovery flag. */
id|EXT3_CLEAR_INCOMPAT_FEATURE
c_func
(paren
id|sb
comma
id|EXT3_FEATURE_INCOMPAT_RECOVER
)paren
suffix:semicolon
id|ext3_commit_super
c_func
(paren
id|sb
comma
id|EXT3_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|s_es
comma
l_int|1
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Called by LVM after the snapshot is done.  We need to reset the RECOVER&n; * flag here, even though the filesystem is not technically dirty yet.&n; */
DECL|function|ext3_unlockfs
r_void
id|ext3_unlockfs
c_func
(paren
r_struct
id|super_block
op_star
id|sb
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|sb-&gt;s_flags
op_amp
id|MS_RDONLY
)paren
)paren
(brace
id|lock_super
c_func
(paren
id|sb
)paren
suffix:semicolon
multiline_comment|/* Reser the needs_recovery flag before the fs is unlocked. */
id|EXT3_SET_INCOMPAT_FEATURE
c_func
(paren
id|sb
comma
id|EXT3_FEATURE_INCOMPAT_RECOVER
)paren
suffix:semicolon
id|ext3_commit_super
c_func
(paren
id|sb
comma
id|EXT3_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|s_es
comma
l_int|1
)paren
suffix:semicolon
id|unlock_super
c_func
(paren
id|sb
)paren
suffix:semicolon
id|journal_unlock_updates
c_func
(paren
id|EXT3_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|s_journal
)paren
suffix:semicolon
)brace
)brace
DECL|function|ext3_remount
r_int
id|ext3_remount
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_int
op_star
id|flags
comma
r_char
op_star
id|data
)paren
(brace
r_struct
id|ext3_super_block
op_star
id|es
suffix:semicolon
r_struct
id|ext3_sb_info
op_star
id|sbi
op_assign
id|EXT3_SB
c_func
(paren
id|sb
)paren
suffix:semicolon
r_int
r_int
id|tmp
suffix:semicolon
r_int
r_int
id|n_blocks_count
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; * Allow the &quot;check&quot; option to be passed as a remount option.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|parse_options
c_func
(paren
id|data
comma
id|sb
comma
op_amp
id|tmp
comma
op_amp
id|n_blocks_count
comma
l_int|1
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|sbi-&gt;s_mount_opt
op_amp
id|EXT3_MOUNT_ABORT
)paren
id|ext3_abort
c_func
(paren
id|sb
comma
id|__FUNCTION__
comma
l_string|&quot;Abort forced by user&quot;
)paren
suffix:semicolon
id|sb-&gt;s_flags
op_assign
(paren
id|sb-&gt;s_flags
op_amp
op_complement
id|MS_POSIXACL
)paren
op_or
(paren
(paren
id|sbi-&gt;s_mount_opt
op_amp
id|EXT3_MOUNT_POSIX_ACL
)paren
ques
c_cond
id|MS_POSIXACL
suffix:colon
l_int|0
)paren
suffix:semicolon
id|es
op_assign
id|sbi-&gt;s_es
suffix:semicolon
id|ext3_init_journal_params
c_func
(paren
id|sb
comma
id|sbi-&gt;s_journal
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
op_star
id|flags
op_amp
id|MS_RDONLY
)paren
op_ne
(paren
id|sb-&gt;s_flags
op_amp
id|MS_RDONLY
)paren
op_logical_or
id|n_blocks_count
OG
id|le32_to_cpu
c_func
(paren
id|es-&gt;s_blocks_count
)paren
)paren
(brace
r_if
c_cond
(paren
id|sbi-&gt;s_mount_opt
op_amp
id|EXT3_MOUNT_ABORT
)paren
r_return
op_minus
id|EROFS
suffix:semicolon
r_if
c_cond
(paren
op_star
id|flags
op_amp
id|MS_RDONLY
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * First of all, the unconditional stuff we have to do&n;&t;&t;&t; * to disable replay of the journal when we next remount&n;&t;&t;&t; */
id|sb-&gt;s_flags
op_or_assign
id|MS_RDONLY
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * OK, test if we are remounting a valid rw partition&n;&t;&t;&t; * readonly, and if so set the rdonly flag and then&n;&t;&t;&t; * mark the partition as valid again.&n;&t;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|es-&gt;s_state
op_amp
id|cpu_to_le16
c_func
(paren
id|EXT3_VALID_FS
)paren
)paren
op_logical_and
(paren
id|sbi-&gt;s_mount_state
op_amp
id|EXT3_VALID_FS
)paren
)paren
id|es-&gt;s_state
op_assign
id|cpu_to_le16
c_func
(paren
id|sbi-&gt;s_mount_state
)paren
suffix:semicolon
id|ext3_mark_recovery_complete
c_func
(paren
id|sb
comma
id|es
)paren
suffix:semicolon
)brace
r_else
(brace
id|__le32
id|ret
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|EXT3_HAS_RO_COMPAT_FEATURE
c_func
(paren
id|sb
comma
op_complement
id|EXT3_FEATURE_RO_COMPAT_SUPP
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;EXT3-fs: %s: couldn&squot;t &quot;
l_string|&quot;remount RDWR because of unsupported &quot;
l_string|&quot;optional features (%x).&bslash;n&quot;
comma
id|sb-&gt;s_id
comma
id|le32_to_cpu
c_func
(paren
id|ret
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EROFS
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t;&t; * Mounting a RDONLY partition read-write, so reread&n;&t;&t;&t; * and store the current valid flag.  (It may have&n;&t;&t;&t; * been changed by e2fsck since we originally mounted&n;&t;&t;&t; * the partition.)&n;&t;&t;&t; */
id|ext3_clear_journal_err
c_func
(paren
id|sb
comma
id|es
)paren
suffix:semicolon
id|sbi-&gt;s_mount_state
op_assign
id|le16_to_cpu
c_func
(paren
id|es-&gt;s_state
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ret
op_assign
id|ext3_group_extend
c_func
(paren
id|sb
comma
id|es
comma
id|n_blocks_count
)paren
)paren
)paren
r_return
id|ret
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ext3_setup_super
(paren
id|sb
comma
id|es
comma
l_int|0
)paren
)paren
id|sb-&gt;s_flags
op_and_assign
op_complement
id|MS_RDONLY
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|ext3_statfs
r_int
id|ext3_statfs
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|kstatfs
op_star
id|buf
)paren
(brace
r_struct
id|ext3_super_block
op_star
id|es
op_assign
id|EXT3_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|s_es
suffix:semicolon
r_int
r_int
id|overhead
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
id|test_opt
(paren
id|sb
comma
id|MINIX_DF
)paren
)paren
id|overhead
op_assign
l_int|0
suffix:semicolon
r_else
(brace
r_int
r_int
id|ngroups
suffix:semicolon
id|ngroups
op_assign
id|EXT3_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|s_groups_count
suffix:semicolon
id|smp_rmb
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Compute the overhead (FS structures)&n;&t;&t; */
multiline_comment|/*&n;&t;&t; * All of the blocks before first_data_block are&n;&t;&t; * overhead&n;&t;&t; */
id|overhead
op_assign
id|le32_to_cpu
c_func
(paren
id|es-&gt;s_first_data_block
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Add the overhead attributed to the superblock and&n;&t;&t; * block group descriptors.  If the sparse superblocks&n;&t;&t; * feature is turned on, then not all groups have this.&n;&t;&t; */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ngroups
suffix:semicolon
id|i
op_increment
)paren
id|overhead
op_add_assign
id|ext3_bg_has_super
c_func
(paren
id|sb
comma
id|i
)paren
op_plus
id|ext3_bg_num_gdb
c_func
(paren
id|sb
comma
id|i
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Every block group has an inode bitmap, a block&n;&t;&t; * bitmap, and an inode table.&n;&t;&t; */
id|overhead
op_add_assign
(paren
id|ngroups
op_star
(paren
l_int|2
op_plus
id|EXT3_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|s_itb_per_group
)paren
)paren
suffix:semicolon
)brace
id|buf-&gt;f_type
op_assign
id|EXT3_SUPER_MAGIC
suffix:semicolon
id|buf-&gt;f_bsize
op_assign
id|sb-&gt;s_blocksize
suffix:semicolon
id|buf-&gt;f_blocks
op_assign
id|le32_to_cpu
c_func
(paren
id|es-&gt;s_blocks_count
)paren
op_minus
id|overhead
suffix:semicolon
id|buf-&gt;f_bfree
op_assign
id|ext3_count_free_blocks
(paren
id|sb
)paren
suffix:semicolon
id|buf-&gt;f_bavail
op_assign
id|buf-&gt;f_bfree
op_minus
id|le32_to_cpu
c_func
(paren
id|es-&gt;s_r_blocks_count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buf-&gt;f_bfree
OL
id|le32_to_cpu
c_func
(paren
id|es-&gt;s_r_blocks_count
)paren
)paren
id|buf-&gt;f_bavail
op_assign
l_int|0
suffix:semicolon
id|buf-&gt;f_files
op_assign
id|le32_to_cpu
c_func
(paren
id|es-&gt;s_inodes_count
)paren
suffix:semicolon
id|buf-&gt;f_ffree
op_assign
id|ext3_count_free_inodes
(paren
id|sb
)paren
suffix:semicolon
id|buf-&gt;f_namelen
op_assign
id|EXT3_NAME_LEN
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Helper function for writing quotas on sync - we need to start transaction before quota file&n; * is locked for write. Otherwise the are possible deadlocks:&n; * Process 1                         Process 2&n; * ext3_create()                     quota_sync()&n; *   journal_start()                   write_dquot()&n; *   DQUOT_INIT()                        down(dqio_sem)&n; *     down(dqio_sem)                    journal_start()&n; *&n; */
macro_line|#ifdef CONFIG_QUOTA
DECL|function|dquot_to_inode
r_static
r_inline
r_struct
id|inode
op_star
id|dquot_to_inode
c_func
(paren
r_struct
id|dquot
op_star
id|dquot
)paren
(brace
r_return
id|sb_dqopt
c_func
(paren
id|dquot-&gt;dq_sb
)paren
op_member_access_from_pointer
id|files
(braket
id|dquot-&gt;dq_type
)braket
op_member_access_from_pointer
id|f_dentry-&gt;d_inode
suffix:semicolon
)brace
DECL|function|ext3_dquot_initialize
r_static
r_int
id|ext3_dquot_initialize
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_int
id|type
)paren
(brace
id|handle_t
op_star
id|handle
suffix:semicolon
r_int
id|ret
comma
id|err
suffix:semicolon
multiline_comment|/* We may create quota structure so we need to reserve enough blocks */
id|handle
op_assign
id|ext3_journal_start
c_func
(paren
id|inode
comma
l_int|2
op_star
id|EXT3_QUOTA_INIT_BLOCKS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|handle
)paren
)paren
r_return
id|PTR_ERR
c_func
(paren
id|handle
)paren
suffix:semicolon
id|ret
op_assign
id|dquot_initialize
c_func
(paren
id|inode
comma
id|type
)paren
suffix:semicolon
id|err
op_assign
id|ext3_journal_stop
c_func
(paren
id|handle
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
id|ret
op_assign
id|err
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|ext3_dquot_drop
r_static
r_int
id|ext3_dquot_drop
c_func
(paren
r_struct
id|inode
op_star
id|inode
)paren
(brace
id|handle_t
op_star
id|handle
suffix:semicolon
r_int
id|ret
comma
id|err
suffix:semicolon
multiline_comment|/* We may delete quota structure so we need to reserve enough blocks */
id|handle
op_assign
id|ext3_journal_start
c_func
(paren
id|inode
comma
l_int|2
op_star
id|EXT3_QUOTA_INIT_BLOCKS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|handle
)paren
)paren
r_return
id|PTR_ERR
c_func
(paren
id|handle
)paren
suffix:semicolon
id|ret
op_assign
id|dquot_drop
c_func
(paren
id|inode
)paren
suffix:semicolon
id|err
op_assign
id|ext3_journal_stop
c_func
(paren
id|handle
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
id|ret
op_assign
id|err
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|ext3_write_dquot
r_static
r_int
id|ext3_write_dquot
c_func
(paren
r_struct
id|dquot
op_star
id|dquot
)paren
(brace
r_int
id|ret
comma
id|err
suffix:semicolon
id|handle_t
op_star
id|handle
suffix:semicolon
id|handle
op_assign
id|ext3_journal_start
c_func
(paren
id|dquot_to_inode
c_func
(paren
id|dquot
)paren
comma
id|EXT3_QUOTA_TRANS_BLOCKS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|handle
)paren
)paren
r_return
id|PTR_ERR
c_func
(paren
id|handle
)paren
suffix:semicolon
id|ret
op_assign
id|dquot_commit
c_func
(paren
id|dquot
)paren
suffix:semicolon
id|err
op_assign
id|ext3_journal_stop
c_func
(paren
id|handle
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
id|ret
op_assign
id|err
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|ext3_acquire_dquot
r_static
r_int
id|ext3_acquire_dquot
c_func
(paren
r_struct
id|dquot
op_star
id|dquot
)paren
(brace
r_int
id|ret
comma
id|err
suffix:semicolon
id|handle_t
op_star
id|handle
suffix:semicolon
id|handle
op_assign
id|ext3_journal_start
c_func
(paren
id|dquot_to_inode
c_func
(paren
id|dquot
)paren
comma
id|EXT3_QUOTA_INIT_BLOCKS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|handle
)paren
)paren
r_return
id|PTR_ERR
c_func
(paren
id|handle
)paren
suffix:semicolon
id|ret
op_assign
id|dquot_acquire
c_func
(paren
id|dquot
)paren
suffix:semicolon
id|err
op_assign
id|ext3_journal_stop
c_func
(paren
id|handle
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
id|ret
op_assign
id|err
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|ext3_release_dquot
r_static
r_int
id|ext3_release_dquot
c_func
(paren
r_struct
id|dquot
op_star
id|dquot
)paren
(brace
r_int
id|ret
comma
id|err
suffix:semicolon
id|handle_t
op_star
id|handle
suffix:semicolon
id|handle
op_assign
id|ext3_journal_start
c_func
(paren
id|dquot_to_inode
c_func
(paren
id|dquot
)paren
comma
id|EXT3_QUOTA_INIT_BLOCKS
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|handle
)paren
)paren
r_return
id|PTR_ERR
c_func
(paren
id|handle
)paren
suffix:semicolon
id|ret
op_assign
id|dquot_release
c_func
(paren
id|dquot
)paren
suffix:semicolon
id|err
op_assign
id|ext3_journal_stop
c_func
(paren
id|handle
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
id|ret
op_assign
id|err
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|ext3_mark_dquot_dirty
r_static
r_int
id|ext3_mark_dquot_dirty
c_func
(paren
r_struct
id|dquot
op_star
id|dquot
)paren
(brace
multiline_comment|/* Are we journalling quotas? */
r_if
c_cond
(paren
id|EXT3_SB
c_func
(paren
id|dquot-&gt;dq_sb
)paren
op_member_access_from_pointer
id|s_qf_names
(braket
id|USRQUOTA
)braket
op_logical_or
id|EXT3_SB
c_func
(paren
id|dquot-&gt;dq_sb
)paren
op_member_access_from_pointer
id|s_qf_names
(braket
id|GRPQUOTA
)braket
)paren
(brace
id|dquot_mark_dquot_dirty
c_func
(paren
id|dquot
)paren
suffix:semicolon
r_return
id|ext3_write_dquot
c_func
(paren
id|dquot
)paren
suffix:semicolon
)brace
r_else
(brace
r_return
id|dquot_mark_dquot_dirty
c_func
(paren
id|dquot
)paren
suffix:semicolon
)brace
)brace
DECL|function|ext3_write_info
r_static
r_int
id|ext3_write_info
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_int
id|type
)paren
(brace
r_int
id|ret
comma
id|err
suffix:semicolon
id|handle_t
op_star
id|handle
suffix:semicolon
multiline_comment|/* Data block + inode block */
id|handle
op_assign
id|ext3_journal_start
c_func
(paren
id|sb-&gt;s_root-&gt;d_inode
comma
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|handle
)paren
)paren
r_return
id|PTR_ERR
c_func
(paren
id|handle
)paren
suffix:semicolon
id|ret
op_assign
id|dquot_commit_info
c_func
(paren
id|sb
comma
id|type
)paren
suffix:semicolon
id|err
op_assign
id|ext3_journal_stop
c_func
(paren
id|handle
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
id|ret
op_assign
id|err
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n; * Turn on quotas during mount time - we need to find&n; * the quota file and such...&n; */
DECL|function|ext3_quota_on_mount
r_static
r_int
id|ext3_quota_on_mount
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_int
id|type
)paren
(brace
r_int
id|err
suffix:semicolon
r_struct
id|dentry
op_star
id|dentry
suffix:semicolon
r_struct
id|qstr
id|name
op_assign
(brace
dot
id|name
op_assign
id|EXT3_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|s_qf_names
(braket
id|type
)braket
comma
dot
id|hash
op_assign
l_int|0
comma
dot
id|len
op_assign
id|strlen
c_func
(paren
id|EXT3_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|s_qf_names
(braket
id|type
)braket
)paren
)brace
suffix:semicolon
id|dentry
op_assign
id|lookup_hash
c_func
(paren
op_amp
id|name
comma
id|sb-&gt;s_root
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|dentry
)paren
)paren
r_return
id|PTR_ERR
c_func
(paren
id|dentry
)paren
suffix:semicolon
id|err
op_assign
id|vfs_quota_on_mount
c_func
(paren
id|type
comma
id|EXT3_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|s_jquota_fmt
comma
id|dentry
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
id|dput
c_func
(paren
id|dentry
)paren
suffix:semicolon
multiline_comment|/* We keep the dentry reference if everything went ok - we drop it&n;&t; * on quota_off time */
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/* Turn quotas off during mount time */
DECL|function|ext3_quota_off_mount
r_static
r_int
id|ext3_quota_off_mount
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_int
id|type
)paren
(brace
r_int
id|err
suffix:semicolon
r_struct
id|dentry
op_star
id|dentry
suffix:semicolon
id|dentry
op_assign
id|sb_dqopt
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|files
(braket
id|type
)braket
op_member_access_from_pointer
id|f_dentry
suffix:semicolon
id|err
op_assign
id|vfs_quota_off_mount
c_func
(paren
id|sb
comma
id|type
)paren
suffix:semicolon
multiline_comment|/* We invalidate dentry - it has at least wrong hash... */
id|d_invalidate
c_func
(paren
id|dentry
)paren
suffix:semicolon
id|dput
c_func
(paren
id|dentry
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*&n; * Standard function to be called on quota_on&n; */
DECL|function|ext3_quota_on
r_static
r_int
id|ext3_quota_on
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_int
id|type
comma
r_int
id|format_id
comma
r_char
op_star
id|path
)paren
(brace
r_int
id|err
suffix:semicolon
r_struct
id|nameidata
id|nd
suffix:semicolon
multiline_comment|/* Not journalling quota? */
r_if
c_cond
(paren
op_logical_neg
id|EXT3_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|s_qf_names
(braket
id|USRQUOTA
)braket
op_logical_and
op_logical_neg
id|EXT3_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|s_qf_names
(braket
id|GRPQUOTA
)braket
)paren
r_return
id|vfs_quota_on
c_func
(paren
id|sb
comma
id|type
comma
id|format_id
comma
id|path
)paren
suffix:semicolon
id|err
op_assign
id|path_lookup
c_func
(paren
id|path
comma
id|LOOKUP_FOLLOW
comma
op_amp
id|nd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_return
id|err
suffix:semicolon
multiline_comment|/* Quotafile not on the same filesystem? */
r_if
c_cond
(paren
id|nd.mnt-&gt;mnt_sb
op_ne
id|sb
)paren
r_return
op_minus
id|EXDEV
suffix:semicolon
multiline_comment|/* Quotafile not of fs root? */
r_if
c_cond
(paren
id|nd.dentry-&gt;d_parent-&gt;d_inode
op_ne
id|sb-&gt;s_root-&gt;d_inode
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;EXT3-fs: Quota file not on filesystem root. &quot;
l_string|&quot;Journalled quota will not work.&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ext3_should_journal_data
c_func
(paren
id|nd.dentry-&gt;d_inode
)paren
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;EXT3-fs: Quota file does not have &quot;
l_string|&quot;data-journalling. Journalled quota will not work.&bslash;n&quot;
)paren
suffix:semicolon
id|path_release
c_func
(paren
op_amp
id|nd
)paren
suffix:semicolon
r_return
id|vfs_quota_on
c_func
(paren
id|sb
comma
id|type
comma
id|format_id
comma
id|path
)paren
suffix:semicolon
)brace
macro_line|#endif
DECL|function|ext3_get_sb
r_static
r_struct
id|super_block
op_star
id|ext3_get_sb
c_func
(paren
r_struct
id|file_system_type
op_star
id|fs_type
comma
r_int
id|flags
comma
r_const
r_char
op_star
id|dev_name
comma
r_void
op_star
id|data
)paren
(brace
r_return
id|get_sb_bdev
c_func
(paren
id|fs_type
comma
id|flags
comma
id|dev_name
comma
id|data
comma
id|ext3_fill_super
)paren
suffix:semicolon
)brace
DECL|variable|ext3_fs_type
r_static
r_struct
id|file_system_type
id|ext3_fs_type
op_assign
(brace
dot
id|owner
op_assign
id|THIS_MODULE
comma
dot
id|name
op_assign
l_string|&quot;ext3&quot;
comma
dot
id|get_sb
op_assign
id|ext3_get_sb
comma
dot
id|kill_sb
op_assign
id|kill_block_super
comma
dot
id|fs_flags
op_assign
id|FS_REQUIRES_DEV
comma
)brace
suffix:semicolon
DECL|function|init_ext3_fs
r_static
r_int
id|__init
id|init_ext3_fs
c_func
(paren
r_void
)paren
(brace
r_int
id|err
op_assign
id|init_ext3_xattr
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_return
id|err
suffix:semicolon
id|err
op_assign
id|init_inodecache
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|out1
suffix:semicolon
id|err
op_assign
id|register_filesystem
c_func
(paren
op_amp
id|ext3_fs_type
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|out
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|out
suffix:colon
id|destroy_inodecache
c_func
(paren
)paren
suffix:semicolon
id|out1
suffix:colon
id|exit_ext3_xattr
c_func
(paren
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|exit_ext3_fs
r_static
r_void
id|__exit
id|exit_ext3_fs
c_func
(paren
r_void
)paren
(brace
id|unregister_filesystem
c_func
(paren
op_amp
id|ext3_fs_type
)paren
suffix:semicolon
id|destroy_inodecache
c_func
(paren
)paren
suffix:semicolon
id|exit_ext3_xattr
c_func
(paren
)paren
suffix:semicolon
)brace
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Remy Card, Stephen Tweedie, Andrew Morton, Andreas Dilger, Theodore Ts&squot;o and others&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;Second Extended Filesystem with journaling extensions&quot;
)paren
suffix:semicolon
id|MODULE_LICENSE
c_func
(paren
l_string|&quot;GPL&quot;
)paren
suffix:semicolon
id|module_init
c_func
(paren
id|init_ext3_fs
)paren
id|module_exit
c_func
(paren
id|exit_ext3_fs
)paren
eof
