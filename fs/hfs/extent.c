multiline_comment|/*&n; *  linux/fs/hfs/extent.c&n; *&n; * Copyright (C) 1995-1997  Paul H. Hargrove&n; * (C) 2003 Ardis Technologies &lt;roman@ardistech.com&gt;&n; * This file may be distributed under the terms of the GNU General Public License.&n; *&n; * This file contains the functions related to the extents B-tree.&n; */
macro_line|#include &lt;linux/pagemap.h&gt;
macro_line|#include &quot;hfs_fs.h&quot;
macro_line|#include &quot;btree.h&quot;
multiline_comment|/*================ File-local functions ================*/
multiline_comment|/*&n; * build_key&n; */
DECL|function|hfs_ext_build_key
r_static
r_void
id|hfs_ext_build_key
c_func
(paren
id|hfs_btree_key
op_star
id|key
comma
id|u32
id|cnid
comma
id|u16
id|block
comma
id|u8
id|type
)paren
(brace
id|key-&gt;key_len
op_assign
l_int|7
suffix:semicolon
id|key-&gt;ext.FkType
op_assign
id|type
suffix:semicolon
id|key-&gt;ext.FNum
op_assign
id|cpu_to_be32
c_func
(paren
id|cnid
)paren
suffix:semicolon
id|key-&gt;ext.FABN
op_assign
id|cpu_to_be16
c_func
(paren
id|block
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * hfs_ext_compare()&n; *&n; * Description:&n; *   This is the comparison function used for the extents B-tree.  In&n; *   comparing extent B-tree entries, the file id is the most&n; *   significant field (compared as unsigned ints); the fork type is&n; *   the second most significant field (compared as unsigned chars);&n; *   and the allocation block number field is the least significant&n; *   (compared as unsigned ints).&n; * Input Variable(s):&n; *   struct hfs_ext_key *key1: pointer to the first key to compare&n; *   struct hfs_ext_key *key2: pointer to the second key to compare&n; * Output Variable(s):&n; *   NONE&n; * Returns:&n; *   int: negative if key1&lt;key2, positive if key1&gt;key2, and 0 if key1==key2&n; * Preconditions:&n; *   key1 and key2 point to &quot;valid&quot; (struct hfs_ext_key)s.&n; * Postconditions:&n; *   This function has no side-effects */
DECL|function|hfs_ext_keycmp
r_int
id|hfs_ext_keycmp
c_func
(paren
r_const
id|btree_key
op_star
id|key1
comma
r_const
id|btree_key
op_star
id|key2
)paren
(brace
r_int
r_int
id|tmp
suffix:semicolon
r_int
id|retval
suffix:semicolon
id|tmp
op_assign
id|be32_to_cpu
c_func
(paren
id|key1-&gt;ext.FNum
)paren
op_minus
id|be32_to_cpu
c_func
(paren
id|key2-&gt;ext.FNum
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmp
op_ne
l_int|0
)paren
(brace
id|retval
op_assign
(paren
r_int
)paren
id|tmp
suffix:semicolon
)brace
r_else
(brace
id|tmp
op_assign
(paren
r_int
r_char
)paren
id|key1-&gt;ext.FkType
op_minus
(paren
r_int
r_char
)paren
id|key2-&gt;ext.FkType
suffix:semicolon
r_if
c_cond
(paren
id|tmp
op_ne
l_int|0
)paren
(brace
id|retval
op_assign
(paren
r_int
)paren
id|tmp
suffix:semicolon
)brace
r_else
(brace
id|retval
op_assign
(paren
r_int
)paren
(paren
id|be16_to_cpu
c_func
(paren
id|key1-&gt;ext.FABN
)paren
op_minus
id|be16_to_cpu
c_func
(paren
id|key2-&gt;ext.FABN
)paren
)paren
suffix:semicolon
)brace
)brace
r_return
id|retval
suffix:semicolon
)brace
multiline_comment|/*&n; * hfs_ext_find_block&n; *&n; * Find a block within an extent record&n; */
DECL|function|hfs_ext_find_block
r_static
id|u16
id|hfs_ext_find_block
c_func
(paren
r_struct
id|hfs_extent
op_star
id|ext
comma
id|u16
id|off
)paren
(brace
r_int
id|i
suffix:semicolon
id|u16
id|count
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|3
suffix:semicolon
id|ext
op_increment
comma
id|i
op_increment
)paren
(brace
id|count
op_assign
id|be16_to_cpu
c_func
(paren
id|ext-&gt;count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|off
OL
id|count
)paren
r_return
id|be16_to_cpu
c_func
(paren
id|ext-&gt;block
)paren
op_plus
id|off
suffix:semicolon
id|off
op_sub_assign
id|count
suffix:semicolon
)brace
multiline_comment|/* panic? */
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|hfs_ext_block_count
r_static
r_int
id|hfs_ext_block_count
c_func
(paren
r_struct
id|hfs_extent
op_star
id|ext
)paren
(brace
r_int
id|i
suffix:semicolon
id|u16
id|count
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|3
suffix:semicolon
id|ext
op_increment
comma
id|i
op_increment
)paren
id|count
op_add_assign
id|be16_to_cpu
c_func
(paren
id|ext-&gt;count
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
DECL|function|hfs_ext_lastblock
r_static
id|u16
id|hfs_ext_lastblock
c_func
(paren
r_struct
id|hfs_extent
op_star
id|ext
)paren
(brace
r_int
id|i
suffix:semicolon
id|ext
op_add_assign
l_int|2
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|2
suffix:semicolon
id|ext
op_decrement
comma
id|i
op_increment
)paren
r_if
c_cond
(paren
id|ext-&gt;count
)paren
r_break
suffix:semicolon
r_return
id|be16_to_cpu
c_func
(paren
id|ext-&gt;block
)paren
op_plus
id|be16_to_cpu
c_func
(paren
id|ext-&gt;count
)paren
suffix:semicolon
)brace
DECL|function|__hfs_ext_write_extent
r_static
r_void
id|__hfs_ext_write_extent
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|hfs_find_data
op_star
id|fd
)paren
(brace
r_int
id|res
suffix:semicolon
id|hfs_ext_build_key
c_func
(paren
id|fd-&gt;search_key
comma
id|inode-&gt;i_ino
comma
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|cached_start
comma
id|HFS_IS_RSRC
c_func
(paren
id|inode
)paren
ques
c_cond
id|HFS_FK_RSRC
suffix:colon
id|HFS_FK_DATA
)paren
suffix:semicolon
id|res
op_assign
id|hfs_brec_find
c_func
(paren
id|fd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|flags
op_amp
id|HFS_FLG_EXT_NEW
)paren
(brace
r_if
c_cond
(paren
id|res
op_ne
op_minus
id|ENOENT
)paren
r_return
suffix:semicolon
id|hfs_brec_insert
c_func
(paren
id|fd
comma
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|cached_extents
comma
r_sizeof
(paren
id|hfs_extent_rec
)paren
)paren
suffix:semicolon
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|flags
op_and_assign
op_complement
(paren
id|HFS_FLG_EXT_DIRTY
op_or
id|HFS_FLG_EXT_NEW
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|res
)paren
r_return
suffix:semicolon
id|hfs_bnode_write
c_func
(paren
id|fd-&gt;bnode
comma
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|cached_extents
comma
id|fd-&gt;entryoffset
comma
id|fd-&gt;entrylength
)paren
suffix:semicolon
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|flags
op_and_assign
op_complement
id|HFS_FLG_EXT_DIRTY
suffix:semicolon
)brace
)brace
DECL|function|hfs_ext_write_extent
r_void
id|hfs_ext_write_extent
c_func
(paren
r_struct
id|inode
op_star
id|inode
)paren
(brace
r_struct
id|hfs_find_data
id|fd
suffix:semicolon
r_if
c_cond
(paren
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|flags
op_amp
id|HFS_FLG_EXT_DIRTY
)paren
(brace
id|hfs_find_init
c_func
(paren
id|HFS_SB
c_func
(paren
id|inode-&gt;i_sb
)paren
op_member_access_from_pointer
id|ext_tree
comma
op_amp
id|fd
)paren
suffix:semicolon
id|__hfs_ext_write_extent
c_func
(paren
id|inode
comma
op_amp
id|fd
)paren
suffix:semicolon
id|hfs_find_exit
c_func
(paren
op_amp
id|fd
)paren
suffix:semicolon
)brace
)brace
DECL|function|__hfs_ext_read_extent
r_static
r_inline
r_int
id|__hfs_ext_read_extent
c_func
(paren
r_struct
id|hfs_find_data
op_star
id|fd
comma
r_struct
id|hfs_extent
op_star
id|extent
comma
id|u32
id|cnid
comma
id|u32
id|block
comma
id|u8
id|type
)paren
(brace
r_int
id|res
suffix:semicolon
id|hfs_ext_build_key
c_func
(paren
id|fd-&gt;search_key
comma
id|cnid
comma
id|block
comma
id|type
)paren
suffix:semicolon
id|fd-&gt;key-&gt;ext.FNum
op_assign
l_int|0
suffix:semicolon
id|res
op_assign
id|hfs_brec_find
c_func
(paren
id|fd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
op_logical_and
id|res
op_ne
op_minus
id|ENOENT
)paren
r_return
id|res
suffix:semicolon
r_if
c_cond
(paren
id|fd-&gt;key-&gt;ext.FNum
op_ne
id|fd-&gt;search_key-&gt;ext.FNum
op_logical_or
id|fd-&gt;key-&gt;ext.FkType
op_ne
id|fd-&gt;search_key-&gt;ext.FkType
)paren
r_return
op_minus
id|ENOENT
suffix:semicolon
r_if
c_cond
(paren
id|fd-&gt;entrylength
op_ne
r_sizeof
(paren
id|hfs_extent_rec
)paren
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|hfs_bnode_read
c_func
(paren
id|fd-&gt;bnode
comma
id|extent
comma
id|fd-&gt;entryoffset
comma
r_sizeof
(paren
id|hfs_extent_rec
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|__hfs_ext_cache_extent
r_static
r_inline
r_int
id|__hfs_ext_cache_extent
c_func
(paren
r_struct
id|hfs_find_data
op_star
id|fd
comma
r_struct
id|inode
op_star
id|inode
comma
id|u32
id|block
)paren
(brace
r_int
id|res
suffix:semicolon
r_if
c_cond
(paren
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|flags
op_amp
id|HFS_FLG_EXT_DIRTY
)paren
id|__hfs_ext_write_extent
c_func
(paren
id|inode
comma
id|fd
)paren
suffix:semicolon
id|res
op_assign
id|__hfs_ext_read_extent
c_func
(paren
id|fd
comma
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|cached_extents
comma
id|inode-&gt;i_ino
comma
id|block
comma
id|HFS_IS_RSRC
c_func
(paren
id|inode
)paren
ques
c_cond
id|HFS_FK_RSRC
suffix:colon
id|HFS_FK_DATA
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|res
)paren
(brace
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|cached_start
op_assign
id|be16_to_cpu
c_func
(paren
id|fd-&gt;key-&gt;ext.FABN
)paren
suffix:semicolon
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|cached_blocks
op_assign
id|hfs_ext_block_count
c_func
(paren
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|cached_extents
)paren
suffix:semicolon
)brace
r_else
(brace
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|cached_start
op_assign
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|cached_blocks
op_assign
l_int|0
suffix:semicolon
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|flags
op_and_assign
op_complement
(paren
id|HFS_FLG_EXT_DIRTY
op_or
id|HFS_FLG_EXT_NEW
)paren
suffix:semicolon
)brace
r_return
id|res
suffix:semicolon
)brace
DECL|function|hfs_ext_read_extent
r_static
r_int
id|hfs_ext_read_extent
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
id|u16
id|block
)paren
(brace
r_struct
id|hfs_find_data
id|fd
suffix:semicolon
r_int
id|res
suffix:semicolon
r_if
c_cond
(paren
id|block
op_ge
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|cached_start
op_logical_and
id|block
OL
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|cached_start
op_plus
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|cached_blocks
)paren
r_return
l_int|0
suffix:semicolon
id|hfs_find_init
c_func
(paren
id|HFS_SB
c_func
(paren
id|inode-&gt;i_sb
)paren
op_member_access_from_pointer
id|ext_tree
comma
op_amp
id|fd
)paren
suffix:semicolon
id|res
op_assign
id|__hfs_ext_cache_extent
c_func
(paren
op_amp
id|fd
comma
id|inode
comma
id|block
)paren
suffix:semicolon
id|hfs_find_exit
c_func
(paren
op_amp
id|fd
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
DECL|function|hfs_dump_extent
r_static
r_void
id|hfs_dump_extent
c_func
(paren
r_struct
id|hfs_extent
op_star
id|extent
)paren
(brace
r_int
id|i
suffix:semicolon
id|dprint
c_func
(paren
id|DBG_EXTENT
comma
l_string|&quot;   &quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|3
suffix:semicolon
id|i
op_increment
)paren
id|dprint
c_func
(paren
id|DBG_EXTENT
comma
l_string|&quot; %u:%u&quot;
comma
id|be16_to_cpu
c_func
(paren
id|extent
(braket
id|i
)braket
dot
id|block
)paren
comma
id|be16_to_cpu
c_func
(paren
id|extent
(braket
id|i
)braket
dot
id|count
)paren
)paren
suffix:semicolon
id|dprint
c_func
(paren
id|DBG_EXTENT
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|hfs_add_extent
r_static
r_int
id|hfs_add_extent
c_func
(paren
r_struct
id|hfs_extent
op_star
id|extent
comma
id|u16
id|offset
comma
id|u16
id|alloc_block
comma
id|u16
id|block_count
)paren
(brace
id|u16
id|count
comma
id|start
suffix:semicolon
r_int
id|i
suffix:semicolon
id|hfs_dump_extent
c_func
(paren
id|extent
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|3
suffix:semicolon
id|extent
op_increment
comma
id|i
op_increment
)paren
(brace
id|count
op_assign
id|be16_to_cpu
c_func
(paren
id|extent-&gt;count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|offset
op_eq
id|count
)paren
(brace
id|start
op_assign
id|be16_to_cpu
c_func
(paren
id|extent-&gt;block
)paren
suffix:semicolon
r_if
c_cond
(paren
id|alloc_block
op_ne
id|start
op_plus
id|count
)paren
(brace
r_if
c_cond
(paren
op_increment
id|i
op_ge
l_int|3
)paren
r_return
op_minus
id|ENOSPC
suffix:semicolon
id|extent
op_increment
suffix:semicolon
id|extent-&gt;block
op_assign
id|cpu_to_be16
c_func
(paren
id|alloc_block
)paren
suffix:semicolon
)brace
r_else
id|block_count
op_add_assign
id|count
suffix:semicolon
id|extent-&gt;count
op_assign
id|cpu_to_be16
c_func
(paren
id|block_count
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|offset
OL
id|count
)paren
r_break
suffix:semicolon
id|offset
op_sub_assign
id|count
suffix:semicolon
)brace
multiline_comment|/* panic? */
r_return
op_minus
id|EIO
suffix:semicolon
)brace
DECL|function|hfs_free_extents
r_int
id|hfs_free_extents
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|hfs_extent
op_star
id|extent
comma
id|u16
id|offset
comma
id|u16
id|block_nr
)paren
(brace
id|u16
id|count
comma
id|start
suffix:semicolon
r_int
id|i
suffix:semicolon
id|hfs_dump_extent
c_func
(paren
id|extent
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|3
suffix:semicolon
id|extent
op_increment
comma
id|i
op_increment
)paren
(brace
id|count
op_assign
id|be16_to_cpu
c_func
(paren
id|extent-&gt;count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|offset
op_eq
id|count
)paren
r_goto
id|found
suffix:semicolon
r_else
r_if
c_cond
(paren
id|offset
OL
id|count
)paren
r_break
suffix:semicolon
id|offset
op_sub_assign
id|count
suffix:semicolon
)brace
multiline_comment|/* panic? */
r_return
op_minus
id|EIO
suffix:semicolon
id|found
suffix:colon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|start
op_assign
id|be16_to_cpu
c_func
(paren
id|extent-&gt;block
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
op_le
id|block_nr
)paren
(brace
id|hfs_clear_vbm_bits
c_func
(paren
id|sb
comma
id|start
comma
id|count
)paren
suffix:semicolon
id|extent-&gt;block
op_assign
l_int|0
suffix:semicolon
id|extent-&gt;count
op_assign
l_int|0
suffix:semicolon
id|block_nr
op_sub_assign
id|count
suffix:semicolon
)brace
r_else
(brace
id|count
op_sub_assign
id|block_nr
suffix:semicolon
id|hfs_clear_vbm_bits
c_func
(paren
id|sb
comma
id|start
op_plus
id|count
comma
id|block_nr
)paren
suffix:semicolon
id|extent-&gt;count
op_assign
id|cpu_to_be16
c_func
(paren
id|count
)paren
suffix:semicolon
id|block_nr
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|block_nr
op_logical_or
op_logical_neg
id|i
)paren
r_return
l_int|0
suffix:semicolon
id|i
op_decrement
suffix:semicolon
id|extent
op_decrement
suffix:semicolon
id|count
op_assign
id|be16_to_cpu
c_func
(paren
id|extent-&gt;count
)paren
suffix:semicolon
)brace
)brace
DECL|function|hfs_free_fork
r_int
id|hfs_free_fork
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|hfs_cat_file
op_star
id|file
comma
r_int
id|type
)paren
(brace
r_struct
id|hfs_find_data
id|fd
suffix:semicolon
id|u32
id|total_blocks
comma
id|blocks
comma
id|start
suffix:semicolon
id|u32
id|cnid
op_assign
id|be32_to_cpu
c_func
(paren
id|file-&gt;FlNum
)paren
suffix:semicolon
r_struct
id|hfs_extent
op_star
id|extent
suffix:semicolon
r_int
id|res
comma
id|i
suffix:semicolon
r_if
c_cond
(paren
id|type
op_eq
id|HFS_FK_DATA
)paren
(brace
id|total_blocks
op_assign
id|file-&gt;PyLen
suffix:semicolon
id|extent
op_assign
id|file-&gt;ExtRec
suffix:semicolon
)brace
r_else
(brace
id|total_blocks
op_assign
id|file-&gt;RPyLen
suffix:semicolon
id|extent
op_assign
id|file-&gt;RExtRec
suffix:semicolon
)brace
id|total_blocks
op_assign
id|be32_to_cpu
c_func
(paren
id|total_blocks
)paren
op_div
id|HFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|alloc_blksz
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|total_blocks
)paren
r_return
l_int|0
suffix:semicolon
id|blocks
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|3
suffix:semicolon
id|extent
op_increment
comma
id|i
op_increment
)paren
id|blocks
op_add_assign
id|be16_to_cpu
c_func
(paren
id|extent
(braket
id|i
)braket
dot
id|count
)paren
suffix:semicolon
id|res
op_assign
id|hfs_free_extents
c_func
(paren
id|sb
comma
id|extent
comma
id|blocks
comma
id|blocks
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
)paren
r_return
id|res
suffix:semicolon
r_if
c_cond
(paren
id|total_blocks
op_eq
id|blocks
)paren
r_return
l_int|0
suffix:semicolon
id|hfs_find_init
c_func
(paren
id|HFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|ext_tree
comma
op_amp
id|fd
)paren
suffix:semicolon
r_do
(brace
id|res
op_assign
id|__hfs_ext_read_extent
c_func
(paren
op_amp
id|fd
comma
id|extent
comma
id|cnid
comma
id|total_blocks
comma
id|type
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
)paren
r_break
suffix:semicolon
id|start
op_assign
id|be16_to_cpu
c_func
(paren
id|fd.key-&gt;ext.FABN
)paren
suffix:semicolon
id|hfs_free_extents
c_func
(paren
id|sb
comma
id|extent
comma
id|total_blocks
op_minus
id|start
comma
id|total_blocks
)paren
suffix:semicolon
id|hfs_brec_remove
c_func
(paren
op_amp
id|fd
)paren
suffix:semicolon
id|total_blocks
op_assign
id|start
suffix:semicolon
)brace
r_while
c_loop
(paren
id|total_blocks
OG
id|blocks
)paren
suffix:semicolon
id|hfs_find_exit
c_func
(paren
op_amp
id|fd
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
multiline_comment|/*&n; * hfs_get_block&n; */
DECL|function|hfs_get_block
r_int
id|hfs_get_block
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
id|sector_t
id|block
comma
r_struct
id|buffer_head
op_star
id|bh_result
comma
r_int
id|create
)paren
(brace
r_struct
id|super_block
op_star
id|sb
suffix:semicolon
id|u16
id|dblock
comma
id|ablock
suffix:semicolon
r_int
id|res
suffix:semicolon
id|sb
op_assign
id|inode-&gt;i_sb
suffix:semicolon
multiline_comment|/* Convert inode block to disk allocation block */
id|ablock
op_assign
(paren
id|u32
)paren
id|block
op_div
id|HFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|fs_div
suffix:semicolon
r_if
c_cond
(paren
id|block
op_ge
id|inode-&gt;i_blocks
)paren
(brace
r_if
c_cond
(paren
id|block
OG
id|inode-&gt;i_blocks
op_logical_or
op_logical_neg
id|create
)paren
r_return
op_minus
id|EIO
suffix:semicolon
r_if
c_cond
(paren
id|ablock
op_ge
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|alloc_blocks
)paren
(brace
id|res
op_assign
id|hfs_extend_file
c_func
(paren
id|inode
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
)paren
r_return
id|res
suffix:semicolon
)brace
)brace
r_else
id|create
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ablock
OL
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|first_blocks
)paren
(brace
id|dblock
op_assign
id|hfs_ext_find_block
c_func
(paren
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|first_extents
comma
id|ablock
)paren
suffix:semicolon
r_goto
id|done
suffix:semicolon
)brace
id|down
c_func
(paren
op_amp
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|extents_lock
)paren
suffix:semicolon
id|res
op_assign
id|hfs_ext_read_extent
c_func
(paren
id|inode
comma
id|ablock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|res
)paren
id|dblock
op_assign
id|hfs_ext_find_block
c_func
(paren
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|cached_extents
comma
id|ablock
op_minus
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|cached_start
)paren
suffix:semicolon
r_else
(brace
id|up
c_func
(paren
op_amp
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|extents_lock
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|extents_lock
)paren
suffix:semicolon
id|done
suffix:colon
id|map_bh
c_func
(paren
id|bh_result
comma
id|sb
comma
id|HFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|fs_start
op_plus
id|dblock
op_star
id|HFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|fs_div
op_plus
(paren
id|u32
)paren
id|block
op_mod
id|HFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|fs_div
)paren
suffix:semicolon
r_if
c_cond
(paren
id|create
)paren
(brace
id|set_buffer_new
c_func
(paren
id|bh_result
)paren
suffix:semicolon
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|phys_size
op_add_assign
id|sb-&gt;s_blocksize
suffix:semicolon
id|inode-&gt;i_blocks
op_increment
suffix:semicolon
id|mark_inode_dirty
c_func
(paren
id|inode
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|hfs_extend_file
r_int
id|hfs_extend_file
c_func
(paren
r_struct
id|inode
op_star
id|inode
)paren
(brace
r_struct
id|super_block
op_star
id|sb
op_assign
id|inode-&gt;i_sb
suffix:semicolon
id|u32
id|start
comma
id|len
comma
id|goal
suffix:semicolon
r_int
id|res
suffix:semicolon
id|down
c_func
(paren
op_amp
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|extents_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|alloc_blocks
op_eq
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|first_blocks
)paren
id|goal
op_assign
id|hfs_ext_lastblock
c_func
(paren
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|first_extents
)paren
suffix:semicolon
r_else
(brace
id|res
op_assign
id|hfs_ext_read_extent
c_func
(paren
id|inode
comma
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|alloc_blocks
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
)paren
r_goto
id|out
suffix:semicolon
id|goal
op_assign
id|hfs_ext_lastblock
c_func
(paren
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|cached_extents
)paren
suffix:semicolon
)brace
id|len
op_assign
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|clump_blocks
suffix:semicolon
id|start
op_assign
id|hfs_vbm_search_free
c_func
(paren
id|sb
comma
id|goal
comma
op_amp
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|len
)paren
(brace
id|res
op_assign
op_minus
id|ENOSPC
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|dprint
c_func
(paren
id|DBG_EXTENT
comma
l_string|&quot;extend %lu: %u,%u&bslash;n&quot;
comma
id|inode-&gt;i_ino
comma
id|start
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|alloc_blocks
op_eq
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|first_blocks
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|first_blocks
)paren
(brace
id|dprint
c_func
(paren
id|DBG_EXTENT
comma
l_string|&quot;first extents&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* no extents yet */
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|first_extents
(braket
l_int|0
)braket
dot
id|block
op_assign
id|cpu_to_be16
c_func
(paren
id|start
)paren
suffix:semicolon
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|first_extents
(braket
l_int|0
)braket
dot
id|count
op_assign
id|cpu_to_be16
c_func
(paren
id|len
)paren
suffix:semicolon
id|res
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* try to append to extents in inode */
id|res
op_assign
id|hfs_add_extent
c_func
(paren
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|first_extents
comma
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|alloc_blocks
comma
id|start
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
op_eq
op_minus
id|ENOSPC
)paren
r_goto
id|insert_extent
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|res
)paren
(brace
id|hfs_dump_extent
c_func
(paren
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|first_extents
)paren
suffix:semicolon
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|first_blocks
op_add_assign
id|len
suffix:semicolon
)brace
)brace
r_else
(brace
id|res
op_assign
id|hfs_add_extent
c_func
(paren
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|cached_extents
comma
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|alloc_blocks
op_minus
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|cached_start
comma
id|start
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|res
)paren
(brace
id|hfs_dump_extent
c_func
(paren
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|cached_extents
)paren
suffix:semicolon
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|flags
op_or_assign
id|HFS_FLG_EXT_DIRTY
suffix:semicolon
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|cached_blocks
op_add_assign
id|len
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|res
op_eq
op_minus
id|ENOSPC
)paren
r_goto
id|insert_extent
suffix:semicolon
)brace
id|out
suffix:colon
id|up
c_func
(paren
op_amp
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|extents_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|res
)paren
(brace
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|alloc_blocks
op_add_assign
id|len
suffix:semicolon
id|mark_inode_dirty
c_func
(paren
id|inode
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inode-&gt;i_ino
OL
id|HFS_FIRSTUSER_CNID
)paren
id|set_bit
c_func
(paren
id|HFS_FLG_ALT_MDB_DIRTY
comma
op_amp
id|HFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|flags
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|HFS_FLG_MDB_DIRTY
comma
op_amp
id|HFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|flags
)paren
suffix:semicolon
id|sb-&gt;s_dirt
op_assign
l_int|1
suffix:semicolon
)brace
r_return
id|res
suffix:semicolon
id|insert_extent
suffix:colon
id|dprint
c_func
(paren
id|DBG_EXTENT
comma
l_string|&quot;insert new extent&bslash;n&quot;
)paren
suffix:semicolon
id|hfs_ext_write_extent
c_func
(paren
id|inode
)paren
suffix:semicolon
id|memset
c_func
(paren
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|cached_extents
comma
l_int|0
comma
r_sizeof
(paren
id|hfs_extent_rec
)paren
)paren
suffix:semicolon
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|cached_extents
(braket
l_int|0
)braket
dot
id|block
op_assign
id|cpu_to_be16
c_func
(paren
id|start
)paren
suffix:semicolon
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|cached_extents
(braket
l_int|0
)braket
dot
id|count
op_assign
id|cpu_to_be16
c_func
(paren
id|len
)paren
suffix:semicolon
id|hfs_dump_extent
c_func
(paren
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|cached_extents
)paren
suffix:semicolon
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|flags
op_or_assign
id|HFS_FLG_EXT_DIRTY
op_or
id|HFS_FLG_EXT_NEW
suffix:semicolon
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|cached_start
op_assign
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|alloc_blocks
suffix:semicolon
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|cached_blocks
op_assign
id|len
suffix:semicolon
id|res
op_assign
l_int|0
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
DECL|function|hfs_file_truncate
r_void
id|hfs_file_truncate
c_func
(paren
r_struct
id|inode
op_star
id|inode
)paren
(brace
r_struct
id|super_block
op_star
id|sb
op_assign
id|inode-&gt;i_sb
suffix:semicolon
r_struct
id|hfs_find_data
id|fd
suffix:semicolon
id|u16
id|blk_cnt
comma
id|alloc_cnt
comma
id|start
suffix:semicolon
id|u32
id|size
suffix:semicolon
r_int
id|res
suffix:semicolon
id|dprint
c_func
(paren
id|DBG_INODE
comma
l_string|&quot;truncate: %lu, %Lu -&gt; %Lu&bslash;n&quot;
comma
id|inode-&gt;i_ino
comma
(paren
r_int
r_int
)paren
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|phys_size
comma
id|inode-&gt;i_size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inode-&gt;i_size
OG
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|phys_size
)paren
(brace
r_struct
id|address_space
op_star
id|mapping
op_assign
id|inode-&gt;i_mapping
suffix:semicolon
r_struct
id|page
op_star
id|page
suffix:semicolon
r_int
id|res
suffix:semicolon
id|size
op_assign
id|inode-&gt;i_size
op_minus
l_int|1
suffix:semicolon
id|page
op_assign
id|grab_cache_page
c_func
(paren
id|mapping
comma
id|size
op_rshift
id|PAGE_CACHE_SHIFT
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|page
)paren
r_return
suffix:semicolon
id|size
op_and_assign
id|PAGE_CACHE_SIZE
op_minus
l_int|1
suffix:semicolon
id|size
op_increment
suffix:semicolon
id|res
op_assign
id|mapping-&gt;a_ops
op_member_access_from_pointer
id|prepare_write
c_func
(paren
l_int|NULL
comma
id|page
comma
id|size
comma
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|res
)paren
id|res
op_assign
id|mapping-&gt;a_ops
op_member_access_from_pointer
id|commit_write
c_func
(paren
l_int|NULL
comma
id|page
comma
id|size
comma
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
)paren
id|inode-&gt;i_size
op_assign
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|phys_size
suffix:semicolon
id|unlock_page
c_func
(paren
id|page
)paren
suffix:semicolon
id|page_cache_release
c_func
(paren
id|page
)paren
suffix:semicolon
id|mark_inode_dirty
c_func
(paren
id|inode
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|size
op_assign
id|inode-&gt;i_size
op_plus
id|HFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|alloc_blksz
op_minus
l_int|1
suffix:semicolon
id|blk_cnt
op_assign
id|size
op_div
id|HFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|alloc_blksz
suffix:semicolon
id|alloc_cnt
op_assign
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|alloc_blocks
suffix:semicolon
r_if
c_cond
(paren
id|blk_cnt
op_eq
id|alloc_cnt
)paren
r_goto
id|out
suffix:semicolon
id|down
c_func
(paren
op_amp
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|extents_lock
)paren
suffix:semicolon
id|hfs_find_init
c_func
(paren
id|HFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|ext_tree
comma
op_amp
id|fd
)paren
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|alloc_cnt
op_eq
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|first_blocks
)paren
(brace
id|hfs_free_extents
c_func
(paren
id|sb
comma
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|first_extents
comma
id|alloc_cnt
comma
id|alloc_cnt
op_minus
id|blk_cnt
)paren
suffix:semicolon
id|hfs_dump_extent
c_func
(paren
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|first_extents
)paren
suffix:semicolon
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|first_blocks
op_assign
id|blk_cnt
suffix:semicolon
r_break
suffix:semicolon
)brace
id|res
op_assign
id|__hfs_ext_cache_extent
c_func
(paren
op_amp
id|fd
comma
id|inode
comma
id|alloc_cnt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
)paren
r_break
suffix:semicolon
id|start
op_assign
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|cached_start
suffix:semicolon
id|hfs_free_extents
c_func
(paren
id|sb
comma
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|cached_extents
comma
id|alloc_cnt
op_minus
id|start
comma
id|alloc_cnt
op_minus
id|blk_cnt
)paren
suffix:semicolon
id|hfs_dump_extent
c_func
(paren
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|cached_extents
)paren
suffix:semicolon
r_if
c_cond
(paren
id|blk_cnt
OG
id|start
)paren
(brace
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|flags
op_or_assign
id|HFS_FLG_EXT_DIRTY
suffix:semicolon
r_break
suffix:semicolon
)brace
id|alloc_cnt
op_assign
id|start
suffix:semicolon
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|cached_start
op_assign
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|cached_blocks
op_assign
l_int|0
suffix:semicolon
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|flags
op_and_assign
op_complement
(paren
id|HFS_FLG_EXT_DIRTY
op_or
id|HFS_FLG_EXT_NEW
)paren
suffix:semicolon
id|hfs_brec_remove
c_func
(paren
op_amp
id|fd
)paren
suffix:semicolon
)brace
id|hfs_find_exit
c_func
(paren
op_amp
id|fd
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|extents_lock
)paren
suffix:semicolon
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|alloc_blocks
op_assign
id|blk_cnt
suffix:semicolon
id|out
suffix:colon
id|HFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|phys_size
op_assign
id|inode-&gt;i_size
suffix:semicolon
id|mark_inode_dirty
c_func
(paren
id|inode
)paren
suffix:semicolon
id|inode-&gt;i_blocks
op_assign
(paren
id|inode-&gt;i_size
op_plus
id|sb-&gt;s_blocksize
op_minus
l_int|1
)paren
op_rshift
id|sb-&gt;s_blocksize_bits
suffix:semicolon
)brace
eof
