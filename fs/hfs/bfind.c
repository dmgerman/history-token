multiline_comment|/*&n; *  linux/fs/hfs/bfind.c&n; *&n; * Copyright (C) 2001&n; * Brad Boyer (flar@allandria.com)&n; * (C) 2003 Ardis Technologies &lt;roman@ardistech.com&gt;&n; *&n; * Search routines for btrees&n; */
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &quot;btree.h&quot;
DECL|function|hfs_find_init
r_int
id|hfs_find_init
c_func
(paren
r_struct
id|hfs_btree
op_star
id|tree
comma
r_struct
id|hfs_find_data
op_star
id|fd
)paren
(brace
r_void
op_star
id|ptr
suffix:semicolon
id|fd-&gt;tree
op_assign
id|tree
suffix:semicolon
id|fd-&gt;bnode
op_assign
l_int|NULL
suffix:semicolon
id|ptr
op_assign
id|kmalloc
c_func
(paren
id|tree-&gt;max_key_len
op_star
l_int|2
op_plus
l_int|4
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ptr
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|fd-&gt;search_key
op_assign
id|ptr
suffix:semicolon
id|fd-&gt;key
op_assign
id|ptr
op_plus
id|tree-&gt;max_key_len
op_plus
l_int|2
suffix:semicolon
id|dprint
c_func
(paren
id|DBG_BNODE_REFS
comma
l_string|&quot;find_init: %d (%p)&bslash;n&quot;
comma
id|tree-&gt;cnid
comma
id|__builtin_return_address
c_func
(paren
l_int|0
)paren
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|tree-&gt;tree_lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|hfs_find_exit
r_void
id|hfs_find_exit
c_func
(paren
r_struct
id|hfs_find_data
op_star
id|fd
)paren
(brace
id|hfs_bnode_put
c_func
(paren
id|fd-&gt;bnode
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|fd-&gt;search_key
)paren
suffix:semicolon
id|dprint
c_func
(paren
id|DBG_BNODE_REFS
comma
l_string|&quot;find_exit: %d (%p)&bslash;n&quot;
comma
id|fd-&gt;tree-&gt;cnid
comma
id|__builtin_return_address
c_func
(paren
l_int|0
)paren
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|fd-&gt;tree-&gt;tree_lock
)paren
suffix:semicolon
id|fd-&gt;tree
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* Find the record in bnode that best matches key (not greater than...)*/
DECL|function|__hfs_brec_find
r_int
id|__hfs_brec_find
c_func
(paren
r_struct
id|hfs_bnode
op_star
id|bnode
comma
r_struct
id|hfs_find_data
op_star
id|fd
)paren
(brace
r_int
id|cmpval
suffix:semicolon
id|u16
id|off
comma
id|len
comma
id|keylen
suffix:semicolon
r_int
id|rec
suffix:semicolon
r_int
id|b
comma
id|e
suffix:semicolon
r_int
id|res
suffix:semicolon
id|b
op_assign
l_int|0
suffix:semicolon
id|e
op_assign
id|bnode-&gt;num_recs
op_minus
l_int|1
suffix:semicolon
id|res
op_assign
op_minus
id|ENOENT
suffix:semicolon
r_do
(brace
id|rec
op_assign
(paren
id|e
op_plus
id|b
)paren
op_div
l_int|2
suffix:semicolon
id|len
op_assign
id|hfs_brec_lenoff
c_func
(paren
id|bnode
comma
id|rec
comma
op_amp
id|off
)paren
suffix:semicolon
id|keylen
op_assign
id|hfs_brec_keylen
c_func
(paren
id|bnode
comma
id|rec
)paren
suffix:semicolon
id|hfs_bnode_read
c_func
(paren
id|bnode
comma
id|fd-&gt;key
comma
id|off
comma
id|keylen
)paren
suffix:semicolon
id|cmpval
op_assign
id|bnode-&gt;tree
op_member_access_from_pointer
id|keycmp
c_func
(paren
id|fd-&gt;key
comma
id|fd-&gt;search_key
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cmpval
)paren
(brace
id|e
op_assign
id|rec
suffix:semicolon
id|res
op_assign
l_int|0
suffix:semicolon
r_goto
id|done
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cmpval
OL
l_int|0
)paren
id|b
op_assign
id|rec
op_plus
l_int|1
suffix:semicolon
r_else
id|e
op_assign
id|rec
op_minus
l_int|1
suffix:semicolon
)brace
r_while
c_loop
(paren
id|b
op_le
id|e
)paren
suffix:semicolon
singleline_comment|//printk(&quot;%d: %d,%d,%d&bslash;n&quot;, bnode-&gt;this, b, e, rec);
r_if
c_cond
(paren
id|rec
op_ne
id|e
op_logical_and
id|e
op_ge
l_int|0
)paren
(brace
id|len
op_assign
id|hfs_brec_lenoff
c_func
(paren
id|bnode
comma
id|e
comma
op_amp
id|off
)paren
suffix:semicolon
id|keylen
op_assign
id|hfs_brec_keylen
c_func
(paren
id|bnode
comma
id|e
)paren
suffix:semicolon
id|hfs_bnode_read
c_func
(paren
id|bnode
comma
id|fd-&gt;key
comma
id|off
comma
id|keylen
)paren
suffix:semicolon
)brace
id|done
suffix:colon
id|fd-&gt;record
op_assign
id|e
suffix:semicolon
id|fd-&gt;keyoffset
op_assign
id|off
suffix:semicolon
id|fd-&gt;keylength
op_assign
id|keylen
suffix:semicolon
id|fd-&gt;entryoffset
op_assign
id|off
op_plus
id|keylen
suffix:semicolon
id|fd-&gt;entrylength
op_assign
id|len
op_minus
id|keylen
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
multiline_comment|/* Traverse a B*Tree from the root to a leaf finding best fit to key */
multiline_comment|/* Return allocated copy of node found, set recnum to best record */
DECL|function|hfs_brec_find
r_int
id|hfs_brec_find
c_func
(paren
r_struct
id|hfs_find_data
op_star
id|fd
)paren
(brace
r_struct
id|hfs_btree
op_star
id|tree
suffix:semicolon
r_struct
id|hfs_bnode
op_star
id|bnode
suffix:semicolon
id|u32
id|nidx
comma
id|parent
suffix:semicolon
id|__be32
id|data
suffix:semicolon
r_int
id|height
comma
id|res
suffix:semicolon
id|tree
op_assign
id|fd-&gt;tree
suffix:semicolon
r_if
c_cond
(paren
id|fd-&gt;bnode
)paren
id|hfs_bnode_put
c_func
(paren
id|fd-&gt;bnode
)paren
suffix:semicolon
id|fd-&gt;bnode
op_assign
l_int|NULL
suffix:semicolon
id|nidx
op_assign
id|tree-&gt;root
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|nidx
)paren
r_return
op_minus
id|ENOENT
suffix:semicolon
id|height
op_assign
id|tree-&gt;depth
suffix:semicolon
id|res
op_assign
l_int|0
suffix:semicolon
id|parent
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|bnode
op_assign
id|hfs_bnode_find
c_func
(paren
id|tree
comma
id|nidx
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|bnode
)paren
)paren
(brace
id|res
op_assign
id|PTR_ERR
c_func
(paren
id|bnode
)paren
suffix:semicolon
id|bnode
op_assign
l_int|NULL
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bnode-&gt;height
op_ne
id|height
)paren
r_goto
id|invalid
suffix:semicolon
r_if
c_cond
(paren
id|bnode-&gt;type
op_ne
(paren
op_decrement
id|height
ques
c_cond
id|HFS_NODE_INDEX
suffix:colon
id|HFS_NODE_LEAF
)paren
)paren
r_goto
id|invalid
suffix:semicolon
id|bnode-&gt;parent
op_assign
id|parent
suffix:semicolon
id|res
op_assign
id|__hfs_brec_find
c_func
(paren
id|bnode
comma
id|fd
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|height
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|fd-&gt;record
OL
l_int|0
)paren
r_goto
id|release
suffix:semicolon
id|parent
op_assign
id|nidx
suffix:semicolon
id|hfs_bnode_read
c_func
(paren
id|bnode
comma
op_amp
id|data
comma
id|fd-&gt;entryoffset
comma
l_int|4
)paren
suffix:semicolon
id|nidx
op_assign
id|be32_to_cpu
c_func
(paren
id|data
)paren
suffix:semicolon
id|hfs_bnode_put
c_func
(paren
id|bnode
)paren
suffix:semicolon
)brace
id|fd-&gt;bnode
op_assign
id|bnode
suffix:semicolon
r_return
id|res
suffix:semicolon
id|invalid
suffix:colon
id|printk
c_func
(paren
l_string|&quot;HFS: inconsistency in B*Tree (%d,%d,%d,%u,%u)&bslash;n&quot;
comma
id|height
comma
id|bnode-&gt;height
comma
id|bnode-&gt;type
comma
id|nidx
comma
id|parent
)paren
suffix:semicolon
id|res
op_assign
op_minus
id|EIO
suffix:semicolon
id|release
suffix:colon
id|hfs_bnode_put
c_func
(paren
id|bnode
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
DECL|function|hfs_brec_read
r_int
id|hfs_brec_read
c_func
(paren
r_struct
id|hfs_find_data
op_star
id|fd
comma
r_void
op_star
id|rec
comma
r_int
id|rec_len
)paren
(brace
r_int
id|res
suffix:semicolon
id|res
op_assign
id|hfs_brec_find
c_func
(paren
id|fd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
)paren
r_return
id|res
suffix:semicolon
r_if
c_cond
(paren
id|fd-&gt;entrylength
OG
id|rec_len
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|hfs_bnode_read
c_func
(paren
id|fd-&gt;bnode
comma
id|rec
comma
id|fd-&gt;entryoffset
comma
id|fd-&gt;entrylength
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|hfs_brec_goto
r_int
id|hfs_brec_goto
c_func
(paren
r_struct
id|hfs_find_data
op_star
id|fd
comma
r_int
id|cnt
)paren
(brace
r_struct
id|hfs_btree
op_star
id|tree
suffix:semicolon
r_struct
id|hfs_bnode
op_star
id|bnode
suffix:semicolon
r_int
id|idx
comma
id|res
op_assign
l_int|0
suffix:semicolon
id|u16
id|off
comma
id|len
comma
id|keylen
suffix:semicolon
id|bnode
op_assign
id|fd-&gt;bnode
suffix:semicolon
id|tree
op_assign
id|bnode-&gt;tree
suffix:semicolon
r_if
c_cond
(paren
id|cnt
OL
l_int|0
)paren
(brace
id|cnt
op_assign
op_minus
id|cnt
suffix:semicolon
r_while
c_loop
(paren
id|cnt
OG
id|fd-&gt;record
)paren
(brace
id|cnt
op_sub_assign
id|fd-&gt;record
op_plus
l_int|1
suffix:semicolon
id|fd-&gt;record
op_assign
id|bnode-&gt;num_recs
op_minus
l_int|1
suffix:semicolon
id|idx
op_assign
id|bnode-&gt;prev
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|idx
)paren
(brace
id|res
op_assign
op_minus
id|ENOENT
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|hfs_bnode_put
c_func
(paren
id|bnode
)paren
suffix:semicolon
id|bnode
op_assign
id|hfs_bnode_find
c_func
(paren
id|tree
comma
id|idx
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|bnode
)paren
)paren
(brace
id|res
op_assign
id|PTR_ERR
c_func
(paren
id|bnode
)paren
suffix:semicolon
id|bnode
op_assign
l_int|NULL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
id|fd-&gt;record
op_sub_assign
id|cnt
suffix:semicolon
)brace
r_else
(brace
r_while
c_loop
(paren
id|cnt
op_ge
id|bnode-&gt;num_recs
op_minus
id|fd-&gt;record
)paren
(brace
id|cnt
op_sub_assign
id|bnode-&gt;num_recs
op_minus
id|fd-&gt;record
suffix:semicolon
id|fd-&gt;record
op_assign
l_int|0
suffix:semicolon
id|idx
op_assign
id|bnode-&gt;next
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|idx
)paren
(brace
id|res
op_assign
op_minus
id|ENOENT
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|hfs_bnode_put
c_func
(paren
id|bnode
)paren
suffix:semicolon
id|bnode
op_assign
id|hfs_bnode_find
c_func
(paren
id|tree
comma
id|idx
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|bnode
)paren
)paren
(brace
id|res
op_assign
id|PTR_ERR
c_func
(paren
id|bnode
)paren
suffix:semicolon
id|bnode
op_assign
l_int|NULL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
id|fd-&gt;record
op_add_assign
id|cnt
suffix:semicolon
)brace
id|len
op_assign
id|hfs_brec_lenoff
c_func
(paren
id|bnode
comma
id|fd-&gt;record
comma
op_amp
id|off
)paren
suffix:semicolon
id|keylen
op_assign
id|hfs_brec_keylen
c_func
(paren
id|bnode
comma
id|fd-&gt;record
)paren
suffix:semicolon
id|fd-&gt;keyoffset
op_assign
id|off
suffix:semicolon
id|fd-&gt;keylength
op_assign
id|keylen
suffix:semicolon
id|fd-&gt;entryoffset
op_assign
id|off
op_plus
id|keylen
suffix:semicolon
id|fd-&gt;entrylength
op_assign
id|len
op_minus
id|keylen
suffix:semicolon
id|hfs_bnode_read
c_func
(paren
id|bnode
comma
id|fd-&gt;key
comma
id|off
comma
id|keylen
)paren
suffix:semicolon
id|out
suffix:colon
id|fd-&gt;bnode
op_assign
id|bnode
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
eof
