multiline_comment|/*&n; *  linux/fs/hfs/mdb.c&n; *&n; * Copyright (C) 1995-1997  Paul H. Hargrove&n; * (C) 2003 Ardis Technologies &lt;roman@ardistech.com&gt;&n; * This file may be distributed under the terms of the GNU General Public License.&n; *&n; * This file contains functions for reading/writing the MDB.&n; */
macro_line|#include &lt;linux/cdrom.h&gt;
macro_line|#include &lt;linux/genhd.h&gt;
macro_line|#include &quot;hfs_fs.h&quot;
macro_line|#include &quot;btree.h&quot;
multiline_comment|/*================ File-local data types ================*/
multiline_comment|/*&n; * The HFS Master Directory Block (MDB).&n; *&n; * Also known as the Volume Information Block (VIB), this structure is&n; * the HFS equivalent of a superblock.&n; *&n; * Reference: _Inside Macintosh: Files_ pages 2-59 through 2-62&n; *&n; * modified for HFS Extended&n; */
DECL|function|hfs_get_last_session
r_static
r_int
id|hfs_get_last_session
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
id|sector_t
op_star
id|start
comma
id|sector_t
op_star
id|size
)paren
(brace
r_struct
id|cdrom_multisession
id|ms_info
suffix:semicolon
r_struct
id|cdrom_tocentry
id|te
suffix:semicolon
r_int
id|res
suffix:semicolon
multiline_comment|/* default values */
op_star
id|start
op_assign
l_int|0
suffix:semicolon
op_star
id|size
op_assign
id|sb-&gt;s_bdev-&gt;bd_inode-&gt;i_size
op_rshift
l_int|9
suffix:semicolon
r_if
c_cond
(paren
id|HFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|session
op_ge
l_int|0
)paren
(brace
id|te.cdte_track
op_assign
id|HFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|session
suffix:semicolon
id|te.cdte_format
op_assign
id|CDROM_LBA
suffix:semicolon
id|res
op_assign
id|ioctl_by_bdev
c_func
(paren
id|sb-&gt;s_bdev
comma
id|CDROMREADTOCENTRY
comma
(paren
r_int
r_int
)paren
op_amp
id|te
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|res
op_logical_and
(paren
id|te.cdte_ctrl
op_amp
id|CDROM_DATA_TRACK
)paren
op_eq
l_int|4
)paren
(brace
op_star
id|start
op_assign
(paren
id|sector_t
)paren
id|te.cdte_addr.lba
op_lshift
l_int|2
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;HFS: Invalid session number or type of track&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|ms_info.addr_format
op_assign
id|CDROM_LBA
suffix:semicolon
id|res
op_assign
id|ioctl_by_bdev
c_func
(paren
id|sb-&gt;s_bdev
comma
id|CDROMMULTISESSION
comma
(paren
r_int
r_int
)paren
op_amp
id|ms_info
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|res
op_logical_and
id|ms_info.xa_flag
)paren
op_star
id|start
op_assign
(paren
id|sector_t
)paren
id|ms_info.addr.lba
op_lshift
l_int|2
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * hfs_mdb_get()&n; *&n; * Build the in-core MDB for a filesystem, including&n; * the B-trees and the volume bitmap.&n; */
DECL|function|hfs_mdb_get
r_int
id|hfs_mdb_get
c_func
(paren
r_struct
id|super_block
op_star
id|sb
)paren
(brace
r_struct
id|buffer_head
op_star
id|bh
suffix:semicolon
r_struct
id|hfs_mdb
op_star
id|mdb
comma
op_star
id|mdb2
suffix:semicolon
r_int
r_int
id|block
suffix:semicolon
r_char
op_star
id|ptr
suffix:semicolon
r_int
id|off2
comma
id|len
comma
id|size
comma
id|sect
suffix:semicolon
id|sector_t
id|part_start
comma
id|part_size
suffix:semicolon
id|loff_t
id|off
suffix:semicolon
id|__be16
id|attrib
suffix:semicolon
multiline_comment|/* set the device driver to 512-byte blocks */
id|size
op_assign
id|sb_min_blocksize
c_func
(paren
id|sb
comma
id|HFS_SECTOR_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|size
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|hfs_get_last_session
c_func
(paren
id|sb
comma
op_amp
id|part_start
comma
op_amp
id|part_size
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
multiline_comment|/* See if this is an HFS filesystem */
id|bh
op_assign
id|sb_bread512
c_func
(paren
id|sb
comma
id|part_start
op_plus
id|HFS_MDB_BLK
comma
id|mdb
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bh
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|mdb-&gt;drSigWord
op_eq
id|cpu_to_be16
c_func
(paren
id|HFS_SUPER_MAGIC
)paren
)paren
r_break
suffix:semicolon
id|brelse
c_func
(paren
id|bh
)paren
suffix:semicolon
multiline_comment|/* check for a partition block&n;&t;&t; * (should do this only for cdrom/loop though)&n;&t;&t; */
r_if
c_cond
(paren
id|hfs_part_find
c_func
(paren
id|sb
comma
op_amp
id|part_start
comma
op_amp
id|part_size
)paren
)paren
r_goto
id|out
suffix:semicolon
)brace
id|HFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|alloc_blksz
op_assign
id|size
op_assign
id|be32_to_cpu
c_func
(paren
id|mdb-&gt;drAlBlkSiz
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|size
op_logical_or
(paren
id|size
op_amp
(paren
id|HFS_SECTOR_SIZE
op_minus
l_int|1
)paren
)paren
)paren
(brace
id|hfs_warn
c_func
(paren
l_string|&quot;hfs_fs: bad allocation block size %d&bslash;n&quot;
comma
id|size
)paren
suffix:semicolon
r_goto
id|out_bh
suffix:semicolon
)brace
id|size
op_assign
id|min
c_func
(paren
id|HFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|alloc_blksz
comma
(paren
id|u32
)paren
id|PAGE_SIZE
)paren
suffix:semicolon
multiline_comment|/* size must be a multiple of 512 */
r_while
c_loop
(paren
id|size
op_amp
(paren
id|size
op_minus
l_int|1
)paren
)paren
id|size
op_sub_assign
id|HFS_SECTOR_SIZE
suffix:semicolon
id|sect
op_assign
id|be16_to_cpu
c_func
(paren
id|mdb-&gt;drAlBlSt
)paren
op_plus
id|part_start
suffix:semicolon
multiline_comment|/* align block size to first sector */
r_while
c_loop
(paren
id|sect
op_amp
(paren
(paren
id|size
op_minus
l_int|1
)paren
op_rshift
id|HFS_SECTOR_SIZE_BITS
)paren
)paren
id|size
op_rshift_assign
l_int|1
suffix:semicolon
multiline_comment|/* align block size to weird alloc size */
r_while
c_loop
(paren
id|HFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|alloc_blksz
op_amp
(paren
id|size
op_minus
l_int|1
)paren
)paren
id|size
op_rshift_assign
l_int|1
suffix:semicolon
id|brelse
c_func
(paren
id|bh
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sb_set_blocksize
c_func
(paren
id|sb
comma
id|size
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;hfs_fs: unable to set blocksize to %u&bslash;n&quot;
comma
id|size
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|bh
op_assign
id|sb_bread512
c_func
(paren
id|sb
comma
id|part_start
op_plus
id|HFS_MDB_BLK
comma
id|mdb
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bh
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|mdb-&gt;drSigWord
op_ne
id|cpu_to_be16
c_func
(paren
id|HFS_SUPER_MAGIC
)paren
)paren
r_goto
id|out_bh
suffix:semicolon
id|HFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|mdb_bh
op_assign
id|bh
suffix:semicolon
id|HFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|mdb
op_assign
id|mdb
suffix:semicolon
multiline_comment|/* These parameters are read from the MDB, and never written */
id|HFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|part_start
op_assign
id|part_start
suffix:semicolon
id|HFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|fs_ablocks
op_assign
id|be16_to_cpu
c_func
(paren
id|mdb-&gt;drNmAlBlks
)paren
suffix:semicolon
id|HFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|fs_div
op_assign
id|HFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|alloc_blksz
op_rshift
id|sb-&gt;s_blocksize_bits
suffix:semicolon
id|HFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|clumpablks
op_assign
id|be32_to_cpu
c_func
(paren
id|mdb-&gt;drClpSiz
)paren
op_div
id|HFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|alloc_blksz
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|HFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|clumpablks
)paren
id|HFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|clumpablks
op_assign
l_int|1
suffix:semicolon
id|HFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|fs_start
op_assign
(paren
id|be16_to_cpu
c_func
(paren
id|mdb-&gt;drAlBlSt
)paren
op_plus
id|part_start
)paren
op_rshift
(paren
id|sb-&gt;s_blocksize_bits
op_minus
id|HFS_SECTOR_SIZE_BITS
)paren
suffix:semicolon
multiline_comment|/* These parameters are read from and written to the MDB */
id|HFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|free_ablocks
op_assign
id|be16_to_cpu
c_func
(paren
id|mdb-&gt;drFreeBks
)paren
suffix:semicolon
id|HFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|next_id
op_assign
id|be32_to_cpu
c_func
(paren
id|mdb-&gt;drNxtCNID
)paren
suffix:semicolon
id|HFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|root_files
op_assign
id|be16_to_cpu
c_func
(paren
id|mdb-&gt;drNmFls
)paren
suffix:semicolon
id|HFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|root_dirs
op_assign
id|be16_to_cpu
c_func
(paren
id|mdb-&gt;drNmRtDirs
)paren
suffix:semicolon
id|HFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|file_count
op_assign
id|be32_to_cpu
c_func
(paren
id|mdb-&gt;drFilCnt
)paren
suffix:semicolon
id|HFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|folder_count
op_assign
id|be32_to_cpu
c_func
(paren
id|mdb-&gt;drDirCnt
)paren
suffix:semicolon
multiline_comment|/* TRY to get the alternate (backup) MDB. */
id|sect
op_assign
id|part_start
op_plus
id|part_size
op_minus
l_int|2
suffix:semicolon
id|bh
op_assign
id|sb_bread512
c_func
(paren
id|sb
comma
id|sect
comma
id|mdb2
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bh
)paren
(brace
r_if
c_cond
(paren
id|mdb2-&gt;drSigWord
op_eq
id|cpu_to_be16
c_func
(paren
id|HFS_SUPER_MAGIC
)paren
)paren
(brace
id|HFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|alt_mdb_bh
op_assign
id|bh
suffix:semicolon
id|HFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|alt_mdb
op_assign
id|mdb2
suffix:semicolon
)brace
r_else
id|brelse
c_func
(paren
id|bh
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|HFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|alt_mdb
)paren
(brace
id|hfs_warn
c_func
(paren
l_string|&quot;hfs_fs: unable to locate alternate MDB&bslash;n&quot;
)paren
suffix:semicolon
id|hfs_warn
c_func
(paren
l_string|&quot;hfs_fs: continuing without an alternate MDB&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|HFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|bitmap
op_assign
(paren
id|__be32
op_star
)paren
id|__get_free_pages
c_func
(paren
id|GFP_KERNEL
comma
id|PAGE_SIZE
OL
l_int|8192
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|HFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|bitmap
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* read in the bitmap */
id|block
op_assign
id|be16_to_cpu
c_func
(paren
id|mdb-&gt;drVBMSt
)paren
op_plus
id|part_start
suffix:semicolon
id|off
op_assign
(paren
id|loff_t
)paren
id|block
op_lshift
id|HFS_SECTOR_SIZE_BITS
suffix:semicolon
id|size
op_assign
(paren
id|HFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|fs_ablocks
op_plus
l_int|8
)paren
op_div
l_int|8
suffix:semicolon
id|ptr
op_assign
(paren
id|u8
op_star
)paren
id|HFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|bitmap
suffix:semicolon
r_while
c_loop
(paren
id|size
)paren
(brace
id|bh
op_assign
id|sb_bread
c_func
(paren
id|sb
comma
id|off
op_rshift
id|sb-&gt;s_blocksize_bits
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bh
)paren
(brace
id|hfs_warn
c_func
(paren
l_string|&quot;hfs_fs: unable to read volume bitmap&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|off2
op_assign
id|off
op_amp
(paren
id|sb-&gt;s_blocksize
op_minus
l_int|1
)paren
suffix:semicolon
id|len
op_assign
id|min
c_func
(paren
(paren
r_int
)paren
id|sb-&gt;s_blocksize
op_minus
id|off2
comma
id|size
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|ptr
comma
id|bh-&gt;b_data
op_plus
id|off2
comma
id|len
)paren
suffix:semicolon
id|brelse
c_func
(paren
id|bh
)paren
suffix:semicolon
id|ptr
op_add_assign
id|len
suffix:semicolon
id|off
op_add_assign
id|len
suffix:semicolon
id|size
op_sub_assign
id|len
suffix:semicolon
)brace
id|HFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|ext_tree
op_assign
id|hfs_btree_open
c_func
(paren
id|sb
comma
id|HFS_EXT_CNID
comma
id|hfs_ext_keycmp
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|HFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|ext_tree
)paren
(brace
id|hfs_warn
c_func
(paren
l_string|&quot;hfs_fs: unable to open extent tree&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|HFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|cat_tree
op_assign
id|hfs_btree_open
c_func
(paren
id|sb
comma
id|HFS_CAT_CNID
comma
id|hfs_cat_keycmp
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|HFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|cat_tree
)paren
(brace
id|hfs_warn
c_func
(paren
l_string|&quot;hfs_fs: unable to open catalog tree&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|attrib
op_assign
id|mdb-&gt;drAtrb
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|attrib
op_amp
id|cpu_to_be16
c_func
(paren
id|HFS_SB_ATTRIB_UNMNT
)paren
)paren
)paren
(brace
id|hfs_warn
c_func
(paren
l_string|&quot;HFS-fs warning: Filesystem was not cleanly unmounted, &quot;
l_string|&quot;running fsck.hfs is recommended.  mounting read-only.&bslash;n&quot;
)paren
suffix:semicolon
id|sb-&gt;s_flags
op_or_assign
id|MS_RDONLY
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|attrib
op_amp
id|cpu_to_be16
c_func
(paren
id|HFS_SB_ATTRIB_SLOCK
)paren
)paren
)paren
(brace
id|hfs_warn
c_func
(paren
l_string|&quot;HFS-fs: Filesystem is marked locked, mounting read-only.&bslash;n&quot;
)paren
suffix:semicolon
id|sb-&gt;s_flags
op_or_assign
id|MS_RDONLY
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|sb-&gt;s_flags
op_amp
id|MS_RDONLY
)paren
)paren
(brace
multiline_comment|/* Mark the volume uncleanly unmounted in case we crash */
id|attrib
op_and_assign
id|cpu_to_be16
c_func
(paren
op_complement
id|HFS_SB_ATTRIB_UNMNT
)paren
suffix:semicolon
id|attrib
op_or_assign
id|cpu_to_be16
c_func
(paren
id|HFS_SB_ATTRIB_INCNSTNT
)paren
suffix:semicolon
id|mdb-&gt;drAtrb
op_assign
id|attrib
suffix:semicolon
id|mdb-&gt;drWrCnt
op_assign
id|cpu_to_be32
c_func
(paren
id|be32_to_cpu
c_func
(paren
id|mdb-&gt;drWrCnt
)paren
op_plus
l_int|1
)paren
suffix:semicolon
id|mdb-&gt;drLsMod
op_assign
id|hfs_mtime
c_func
(paren
)paren
suffix:semicolon
id|mark_buffer_dirty
c_func
(paren
id|HFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|mdb_bh
)paren
suffix:semicolon
id|hfs_buffer_sync
c_func
(paren
id|HFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|mdb_bh
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
id|out_bh
suffix:colon
id|brelse
c_func
(paren
id|bh
)paren
suffix:semicolon
id|out
suffix:colon
id|hfs_mdb_put
c_func
(paren
id|sb
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
multiline_comment|/*&n; * hfs_mdb_commit()&n; *&n; * Description:&n; *   This updates the MDB on disk (look also at hfs_write_super()).&n; *   It does not check, if the superblock has been modified, or&n; *   if the filesystem has been mounted read-only. It is mainly&n; *   called by hfs_write_super() and hfs_btree_extend().&n; * Input Variable(s):&n; *   struct hfs_mdb *mdb: Pointer to the hfs MDB&n; *   int backup;&n; * Output Variable(s):&n; *   NONE&n; * Returns:&n; *   void&n; * Preconditions:&n; *   &squot;mdb&squot; points to a &quot;valid&quot; (struct hfs_mdb).&n; * Postconditions:&n; *   The HFS MDB and on disk will be updated, by copying the possibly&n; *   modified fields from the in memory MDB (in native byte order) to&n; *   the disk block buffer.&n; *   If &squot;backup&squot; is non-zero then the alternate MDB is also written&n; *   and the function doesn&squot;t return until it is actually on disk.&n; */
DECL|function|hfs_mdb_commit
r_void
id|hfs_mdb_commit
c_func
(paren
r_struct
id|super_block
op_star
id|sb
)paren
(brace
r_struct
id|hfs_mdb
op_star
id|mdb
op_assign
id|HFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|mdb
suffix:semicolon
r_if
c_cond
(paren
id|test_and_clear_bit
c_func
(paren
id|HFS_FLG_MDB_DIRTY
comma
op_amp
id|HFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|flags
)paren
)paren
(brace
multiline_comment|/* These parameters may have been modified, so write them back */
id|mdb-&gt;drLsMod
op_assign
id|hfs_mtime
c_func
(paren
)paren
suffix:semicolon
id|mdb-&gt;drFreeBks
op_assign
id|cpu_to_be16
c_func
(paren
id|HFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|free_ablocks
)paren
suffix:semicolon
id|mdb-&gt;drNxtCNID
op_assign
id|cpu_to_be32
c_func
(paren
id|HFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|next_id
)paren
suffix:semicolon
id|mdb-&gt;drNmFls
op_assign
id|cpu_to_be16
c_func
(paren
id|HFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|root_files
)paren
suffix:semicolon
id|mdb-&gt;drNmRtDirs
op_assign
id|cpu_to_be16
c_func
(paren
id|HFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|root_dirs
)paren
suffix:semicolon
id|mdb-&gt;drFilCnt
op_assign
id|cpu_to_be32
c_func
(paren
id|HFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|file_count
)paren
suffix:semicolon
id|mdb-&gt;drDirCnt
op_assign
id|cpu_to_be32
c_func
(paren
id|HFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|folder_count
)paren
suffix:semicolon
multiline_comment|/* write MDB to disk */
id|mark_buffer_dirty
c_func
(paren
id|HFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|mdb_bh
)paren
suffix:semicolon
)brace
multiline_comment|/* write the backup MDB, not returning until it is written.&n;&t; * we only do this when either the catalog or extents overflow&n;&t; * files grow. */
r_if
c_cond
(paren
id|test_and_clear_bit
c_func
(paren
id|HFS_FLG_ALT_MDB_DIRTY
comma
op_amp
id|HFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|flags
)paren
op_logical_and
id|HFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|alt_mdb
)paren
(brace
id|hfs_inode_write_fork
c_func
(paren
id|HFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|ext_tree-&gt;inode
comma
id|mdb-&gt;drXTExtRec
comma
op_amp
id|mdb-&gt;drXTFlSize
comma
l_int|NULL
)paren
suffix:semicolon
id|hfs_inode_write_fork
c_func
(paren
id|HFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|cat_tree-&gt;inode
comma
id|mdb-&gt;drCTExtRec
comma
op_amp
id|mdb-&gt;drCTFlSize
comma
l_int|NULL
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|HFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|alt_mdb
comma
id|HFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|mdb
comma
id|HFS_SECTOR_SIZE
)paren
suffix:semicolon
id|HFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|alt_mdb-&gt;drAtrb
op_or_assign
id|cpu_to_be16
c_func
(paren
id|HFS_SB_ATTRIB_UNMNT
)paren
suffix:semicolon
id|HFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|alt_mdb-&gt;drAtrb
op_and_assign
id|cpu_to_be16
c_func
(paren
op_complement
id|HFS_SB_ATTRIB_INCNSTNT
)paren
suffix:semicolon
id|mark_buffer_dirty
c_func
(paren
id|HFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|alt_mdb_bh
)paren
suffix:semicolon
id|hfs_buffer_sync
c_func
(paren
id|HFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|alt_mdb_bh
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|test_and_clear_bit
c_func
(paren
id|HFS_FLG_BITMAP_DIRTY
comma
op_amp
id|HFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|flags
)paren
)paren
(brace
r_struct
id|buffer_head
op_star
id|bh
suffix:semicolon
id|sector_t
id|block
suffix:semicolon
r_char
op_star
id|ptr
suffix:semicolon
r_int
id|off
comma
id|size
comma
id|len
suffix:semicolon
id|block
op_assign
id|be16_to_cpu
c_func
(paren
id|HFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|mdb-&gt;drVBMSt
)paren
op_plus
id|HFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|part_start
suffix:semicolon
id|off
op_assign
(paren
id|block
op_lshift
id|HFS_SECTOR_SIZE_BITS
)paren
op_amp
(paren
id|sb-&gt;s_blocksize
op_minus
l_int|1
)paren
suffix:semicolon
id|block
op_rshift_assign
id|sb-&gt;s_blocksize_bits
op_minus
id|HFS_SECTOR_SIZE_BITS
suffix:semicolon
id|size
op_assign
(paren
id|HFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|fs_ablocks
op_plus
l_int|7
)paren
op_div
l_int|8
suffix:semicolon
id|ptr
op_assign
(paren
id|u8
op_star
)paren
id|HFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|bitmap
suffix:semicolon
r_while
c_loop
(paren
id|size
)paren
(brace
id|bh
op_assign
id|sb_bread
c_func
(paren
id|sb
comma
id|block
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bh
)paren
(brace
id|hfs_warn
c_func
(paren
l_string|&quot;hfs_fs: unable to read volume bitmap&bslash;n&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|len
op_assign
id|min
c_func
(paren
(paren
r_int
)paren
id|sb-&gt;s_blocksize
op_minus
id|off
comma
id|size
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|bh-&gt;b_data
op_plus
id|off
comma
id|ptr
comma
id|len
)paren
suffix:semicolon
id|mark_buffer_dirty
c_func
(paren
id|bh
)paren
suffix:semicolon
id|brelse
c_func
(paren
id|bh
)paren
suffix:semicolon
id|block
op_increment
suffix:semicolon
id|off
op_assign
l_int|0
suffix:semicolon
id|ptr
op_add_assign
id|len
suffix:semicolon
id|size
op_sub_assign
id|len
suffix:semicolon
)brace
)brace
)brace
DECL|function|hfs_mdb_close
r_void
id|hfs_mdb_close
c_func
(paren
r_struct
id|super_block
op_star
id|sb
)paren
(brace
multiline_comment|/* update volume attributes */
r_if
c_cond
(paren
id|sb-&gt;s_flags
op_amp
id|MS_RDONLY
)paren
r_return
suffix:semicolon
id|HFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|mdb-&gt;drAtrb
op_or_assign
id|cpu_to_be16
c_func
(paren
id|HFS_SB_ATTRIB_UNMNT
)paren
suffix:semicolon
id|HFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|mdb-&gt;drAtrb
op_and_assign
id|cpu_to_be16
c_func
(paren
op_complement
id|HFS_SB_ATTRIB_INCNSTNT
)paren
suffix:semicolon
id|mark_buffer_dirty
c_func
(paren
id|HFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|mdb_bh
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * hfs_mdb_put()&n; *&n; * Release the resources associated with the in-core MDB.  */
DECL|function|hfs_mdb_put
r_void
id|hfs_mdb_put
c_func
(paren
r_struct
id|super_block
op_star
id|sb
)paren
(brace
multiline_comment|/* free the B-trees */
id|hfs_btree_close
c_func
(paren
id|HFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|ext_tree
)paren
suffix:semicolon
id|hfs_btree_close
c_func
(paren
id|HFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|cat_tree
)paren
suffix:semicolon
multiline_comment|/* free the buffers holding the primary and alternate MDBs */
id|brelse
c_func
(paren
id|HFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|mdb_bh
)paren
suffix:semicolon
id|brelse
c_func
(paren
id|HFS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|alt_mdb_bh
)paren
suffix:semicolon
)brace
eof
