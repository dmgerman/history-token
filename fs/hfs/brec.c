multiline_comment|/*&n; *  linux/fs/hfs/brec.c&n; *&n; * Copyright (C) 2001&n; * Brad Boyer (flar@allandria.com)&n; * (C) 2003 Ardis Technologies &lt;roman@ardistech.com&gt;&n; *&n; * Handle individual btree records&n; */
macro_line|#include &quot;btree.h&quot;
r_static
r_struct
id|hfs_bnode
op_star
id|hfs_bnode_split
c_func
(paren
r_struct
id|hfs_find_data
op_star
id|fd
)paren
suffix:semicolon
r_static
r_int
id|hfs_brec_update_parent
c_func
(paren
r_struct
id|hfs_find_data
op_star
id|fd
)paren
suffix:semicolon
r_static
r_int
id|hfs_btree_inc_height
c_func
(paren
r_struct
id|hfs_btree
op_star
id|tree
)paren
suffix:semicolon
multiline_comment|/* Get the length and offset of the given record in the given node */
DECL|function|hfs_brec_lenoff
id|u16
id|hfs_brec_lenoff
c_func
(paren
r_struct
id|hfs_bnode
op_star
id|node
comma
id|u16
id|rec
comma
id|u16
op_star
id|off
)paren
(brace
id|__be16
id|retval
(braket
l_int|2
)braket
suffix:semicolon
id|u16
id|dataoff
suffix:semicolon
id|dataoff
op_assign
id|node-&gt;tree-&gt;node_size
op_minus
(paren
id|rec
op_plus
l_int|2
)paren
op_star
l_int|2
suffix:semicolon
id|hfs_bnode_read
c_func
(paren
id|node
comma
id|retval
comma
id|dataoff
comma
l_int|4
)paren
suffix:semicolon
op_star
id|off
op_assign
id|be16_to_cpu
c_func
(paren
id|retval
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_return
id|be16_to_cpu
c_func
(paren
id|retval
(braket
l_int|0
)braket
)paren
op_minus
op_star
id|off
suffix:semicolon
)brace
multiline_comment|/* Get the length of the key from a keyed record */
DECL|function|hfs_brec_keylen
id|u16
id|hfs_brec_keylen
c_func
(paren
r_struct
id|hfs_bnode
op_star
id|node
comma
id|u16
id|rec
)paren
(brace
id|u16
id|retval
comma
id|recoff
suffix:semicolon
r_if
c_cond
(paren
id|node-&gt;type
op_ne
id|HFS_NODE_INDEX
op_logical_and
id|node-&gt;type
op_ne
id|HFS_NODE_LEAF
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|node-&gt;type
op_eq
id|HFS_NODE_INDEX
)paren
op_logical_and
op_logical_neg
(paren
id|node-&gt;tree-&gt;attributes
op_amp
id|HFS_TREE_VARIDXKEYS
)paren
)paren
(brace
r_if
c_cond
(paren
id|node-&gt;tree-&gt;attributes
op_amp
id|HFS_TREE_BIGKEYS
)paren
id|retval
op_assign
id|node-&gt;tree-&gt;max_key_len
op_plus
l_int|2
suffix:semicolon
r_else
id|retval
op_assign
id|node-&gt;tree-&gt;max_key_len
op_plus
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|recoff
op_assign
id|hfs_bnode_read_u16
c_func
(paren
id|node
comma
id|node-&gt;tree-&gt;node_size
op_minus
(paren
id|rec
op_plus
l_int|1
)paren
op_star
l_int|2
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|recoff
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|node-&gt;tree-&gt;attributes
op_amp
id|HFS_TREE_BIGKEYS
)paren
id|retval
op_assign
id|hfs_bnode_read_u16
c_func
(paren
id|node
comma
id|recoff
)paren
op_plus
l_int|2
suffix:semicolon
r_else
id|retval
op_assign
(paren
id|hfs_bnode_read_u8
c_func
(paren
id|node
comma
id|recoff
)paren
op_or
l_int|1
)paren
op_plus
l_int|1
suffix:semicolon
)brace
r_return
id|retval
suffix:semicolon
)brace
DECL|function|hfs_brec_insert
r_int
id|hfs_brec_insert
c_func
(paren
r_struct
id|hfs_find_data
op_star
id|fd
comma
r_void
op_star
id|entry
comma
r_int
id|entry_len
)paren
(brace
r_struct
id|hfs_btree
op_star
id|tree
suffix:semicolon
r_struct
id|hfs_bnode
op_star
id|node
comma
op_star
id|new_node
suffix:semicolon
r_int
id|size
comma
id|key_len
comma
id|rec
suffix:semicolon
r_int
id|data_off
comma
id|end_off
suffix:semicolon
r_int
id|idx_rec_off
comma
id|data_rec_off
comma
id|end_rec_off
suffix:semicolon
id|__be32
id|cnid
suffix:semicolon
id|tree
op_assign
id|fd-&gt;tree
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fd-&gt;bnode
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|tree-&gt;root
)paren
id|hfs_btree_inc_height
c_func
(paren
id|tree
)paren
suffix:semicolon
id|fd-&gt;bnode
op_assign
id|hfs_bnode_find
c_func
(paren
id|tree
comma
id|tree-&gt;leaf_head
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|fd-&gt;bnode
)paren
)paren
r_return
id|PTR_ERR
c_func
(paren
id|fd-&gt;bnode
)paren
suffix:semicolon
id|fd-&gt;record
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
id|new_node
op_assign
l_int|NULL
suffix:semicolon
id|key_len
op_assign
(paren
id|fd-&gt;search_key-&gt;key_len
op_or
l_int|1
)paren
op_plus
l_int|1
suffix:semicolon
id|again
suffix:colon
multiline_comment|/* new record idx and complete record size */
id|rec
op_assign
id|fd-&gt;record
op_plus
l_int|1
suffix:semicolon
id|size
op_assign
id|key_len
op_plus
id|entry_len
suffix:semicolon
id|node
op_assign
id|fd-&gt;bnode
suffix:semicolon
id|hfs_bnode_dump
c_func
(paren
id|node
)paren
suffix:semicolon
multiline_comment|/* get last offset */
id|end_rec_off
op_assign
id|tree-&gt;node_size
op_minus
(paren
id|node-&gt;num_recs
op_plus
l_int|1
)paren
op_star
l_int|2
suffix:semicolon
id|end_off
op_assign
id|hfs_bnode_read_u16
c_func
(paren
id|node
comma
id|end_rec_off
)paren
suffix:semicolon
id|end_rec_off
op_sub_assign
l_int|2
suffix:semicolon
id|dprint
c_func
(paren
id|DBG_BNODE_MOD
comma
l_string|&quot;insert_rec: %d, %d, %d, %d&bslash;n&quot;
comma
id|rec
comma
id|size
comma
id|end_off
comma
id|end_rec_off
)paren
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
id|end_rec_off
op_minus
id|end_off
)paren
(brace
r_if
c_cond
(paren
id|new_node
)paren
id|panic
c_func
(paren
l_string|&quot;not enough room!&bslash;n&quot;
)paren
suffix:semicolon
id|new_node
op_assign
id|hfs_bnode_split
c_func
(paren
id|fd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|new_node
)paren
)paren
r_return
id|PTR_ERR
c_func
(paren
id|new_node
)paren
suffix:semicolon
r_goto
id|again
suffix:semicolon
)brace
r_if
c_cond
(paren
id|node-&gt;type
op_eq
id|HFS_NODE_LEAF
)paren
(brace
id|tree-&gt;leaf_count
op_increment
suffix:semicolon
id|mark_inode_dirty
c_func
(paren
id|tree-&gt;inode
)paren
suffix:semicolon
)brace
id|node-&gt;num_recs
op_increment
suffix:semicolon
multiline_comment|/* write new last offset */
id|hfs_bnode_write_u16
c_func
(paren
id|node
comma
m_offsetof
(paren
r_struct
id|hfs_bnode_desc
comma
id|num_recs
)paren
comma
id|node-&gt;num_recs
)paren
suffix:semicolon
id|hfs_bnode_write_u16
c_func
(paren
id|node
comma
id|end_rec_off
comma
id|end_off
op_plus
id|size
)paren
suffix:semicolon
id|data_off
op_assign
id|end_off
suffix:semicolon
id|data_rec_off
op_assign
id|end_rec_off
op_plus
l_int|2
suffix:semicolon
id|idx_rec_off
op_assign
id|tree-&gt;node_size
op_minus
(paren
id|rec
op_plus
l_int|1
)paren
op_star
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|idx_rec_off
op_eq
id|data_rec_off
)paren
r_goto
id|skip
suffix:semicolon
multiline_comment|/* move all following entries */
r_do
(brace
id|data_off
op_assign
id|hfs_bnode_read_u16
c_func
(paren
id|node
comma
id|data_rec_off
op_plus
l_int|2
)paren
suffix:semicolon
id|hfs_bnode_write_u16
c_func
(paren
id|node
comma
id|data_rec_off
comma
id|data_off
op_plus
id|size
)paren
suffix:semicolon
id|data_rec_off
op_add_assign
l_int|2
suffix:semicolon
)brace
r_while
c_loop
(paren
id|data_rec_off
OL
id|idx_rec_off
)paren
suffix:semicolon
multiline_comment|/* move data away */
id|hfs_bnode_move
c_func
(paren
id|node
comma
id|data_off
op_plus
id|size
comma
id|data_off
comma
id|end_off
op_minus
id|data_off
)paren
suffix:semicolon
id|skip
suffix:colon
id|hfs_bnode_write
c_func
(paren
id|node
comma
id|fd-&gt;search_key
comma
id|data_off
comma
id|key_len
)paren
suffix:semicolon
id|hfs_bnode_write
c_func
(paren
id|node
comma
id|entry
comma
id|data_off
op_plus
id|key_len
comma
id|entry_len
)paren
suffix:semicolon
id|hfs_bnode_dump
c_func
(paren
id|node
)paren
suffix:semicolon
r_if
c_cond
(paren
id|new_node
)paren
(brace
multiline_comment|/* update parent key if we inserted a key&n;&t;&t; * at the start of the first node&n;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
id|rec
op_logical_and
id|new_node
op_ne
id|node
)paren
id|hfs_brec_update_parent
c_func
(paren
id|fd
)paren
suffix:semicolon
id|hfs_bnode_put
c_func
(paren
id|fd-&gt;bnode
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|new_node-&gt;parent
)paren
(brace
id|hfs_btree_inc_height
c_func
(paren
id|tree
)paren
suffix:semicolon
id|new_node-&gt;parent
op_assign
id|tree-&gt;root
suffix:semicolon
)brace
id|fd-&gt;bnode
op_assign
id|hfs_bnode_find
c_func
(paren
id|tree
comma
id|new_node-&gt;parent
)paren
suffix:semicolon
multiline_comment|/* create index data entry */
id|cnid
op_assign
id|cpu_to_be32
c_func
(paren
id|new_node-&gt;this
)paren
suffix:semicolon
id|entry
op_assign
op_amp
id|cnid
suffix:semicolon
id|entry_len
op_assign
r_sizeof
(paren
id|cnid
)paren
suffix:semicolon
multiline_comment|/* get index key */
id|hfs_bnode_read_key
c_func
(paren
id|new_node
comma
id|fd-&gt;search_key
comma
l_int|14
)paren
suffix:semicolon
id|__hfs_brec_find
c_func
(paren
id|fd-&gt;bnode
comma
id|fd
)paren
suffix:semicolon
id|hfs_bnode_put
c_func
(paren
id|new_node
)paren
suffix:semicolon
id|new_node
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|tree-&gt;attributes
op_amp
id|HFS_TREE_VARIDXKEYS
)paren
id|key_len
op_assign
id|fd-&gt;search_key-&gt;key_len
op_plus
l_int|1
suffix:semicolon
r_else
(brace
id|fd-&gt;search_key-&gt;key_len
op_assign
id|tree-&gt;max_key_len
suffix:semicolon
id|key_len
op_assign
id|tree-&gt;max_key_len
op_plus
l_int|1
suffix:semicolon
)brace
r_goto
id|again
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|rec
)paren
id|hfs_brec_update_parent
c_func
(paren
id|fd
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|hfs_brec_remove
r_int
id|hfs_brec_remove
c_func
(paren
r_struct
id|hfs_find_data
op_star
id|fd
)paren
(brace
r_struct
id|hfs_btree
op_star
id|tree
suffix:semicolon
r_struct
id|hfs_bnode
op_star
id|node
comma
op_star
id|parent
suffix:semicolon
r_int
id|end_off
comma
id|rec_off
comma
id|data_off
comma
id|size
suffix:semicolon
id|tree
op_assign
id|fd-&gt;tree
suffix:semicolon
id|node
op_assign
id|fd-&gt;bnode
suffix:semicolon
id|again
suffix:colon
id|rec_off
op_assign
id|tree-&gt;node_size
op_minus
(paren
id|fd-&gt;record
op_plus
l_int|2
)paren
op_star
l_int|2
suffix:semicolon
id|end_off
op_assign
id|tree-&gt;node_size
op_minus
(paren
id|node-&gt;num_recs
op_plus
l_int|1
)paren
op_star
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|node-&gt;type
op_eq
id|HFS_NODE_LEAF
)paren
(brace
id|tree-&gt;leaf_count
op_decrement
suffix:semicolon
id|mark_inode_dirty
c_func
(paren
id|tree-&gt;inode
)paren
suffix:semicolon
)brace
id|hfs_bnode_dump
c_func
(paren
id|node
)paren
suffix:semicolon
id|dprint
c_func
(paren
id|DBG_BNODE_MOD
comma
l_string|&quot;remove_rec: %d, %d&bslash;n&quot;
comma
id|fd-&gt;record
comma
id|fd-&gt;keylength
op_plus
id|fd-&gt;entrylength
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
op_decrement
id|node-&gt;num_recs
)paren
(brace
id|hfs_bnode_unlink
c_func
(paren
id|node
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|node-&gt;parent
)paren
r_return
l_int|0
suffix:semicolon
id|parent
op_assign
id|hfs_bnode_find
c_func
(paren
id|tree
comma
id|node-&gt;parent
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|parent
)paren
)paren
r_return
id|PTR_ERR
c_func
(paren
id|parent
)paren
suffix:semicolon
id|hfs_bnode_put
c_func
(paren
id|node
)paren
suffix:semicolon
id|node
op_assign
id|fd-&gt;bnode
op_assign
id|parent
suffix:semicolon
id|__hfs_brec_find
c_func
(paren
id|node
comma
id|fd
)paren
suffix:semicolon
r_goto
id|again
suffix:semicolon
)brace
id|hfs_bnode_write_u16
c_func
(paren
id|node
comma
m_offsetof
(paren
r_struct
id|hfs_bnode_desc
comma
id|num_recs
)paren
comma
id|node-&gt;num_recs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rec_off
op_eq
id|end_off
)paren
r_goto
id|skip
suffix:semicolon
id|size
op_assign
id|fd-&gt;keylength
op_plus
id|fd-&gt;entrylength
suffix:semicolon
r_do
(brace
id|data_off
op_assign
id|hfs_bnode_read_u16
c_func
(paren
id|node
comma
id|rec_off
)paren
suffix:semicolon
id|hfs_bnode_write_u16
c_func
(paren
id|node
comma
id|rec_off
op_plus
l_int|2
comma
id|data_off
op_minus
id|size
)paren
suffix:semicolon
id|rec_off
op_sub_assign
l_int|2
suffix:semicolon
)brace
r_while
c_loop
(paren
id|rec_off
op_ge
id|end_off
)paren
suffix:semicolon
multiline_comment|/* fill hole */
id|hfs_bnode_move
c_func
(paren
id|node
comma
id|fd-&gt;keyoffset
comma
id|fd-&gt;keyoffset
op_plus
id|size
comma
id|data_off
op_minus
id|fd-&gt;keyoffset
op_minus
id|size
)paren
suffix:semicolon
id|skip
suffix:colon
id|hfs_bnode_dump
c_func
(paren
id|node
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fd-&gt;record
)paren
id|hfs_brec_update_parent
c_func
(paren
id|fd
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|hfs_bnode_split
r_static
r_struct
id|hfs_bnode
op_star
id|hfs_bnode_split
c_func
(paren
r_struct
id|hfs_find_data
op_star
id|fd
)paren
(brace
r_struct
id|hfs_btree
op_star
id|tree
suffix:semicolon
r_struct
id|hfs_bnode
op_star
id|node
comma
op_star
id|new_node
suffix:semicolon
r_struct
id|hfs_bnode_desc
id|node_desc
suffix:semicolon
r_int
id|num_recs
comma
id|new_rec_off
comma
id|new_off
comma
id|old_rec_off
suffix:semicolon
r_int
id|data_start
comma
id|data_end
comma
id|size
suffix:semicolon
id|tree
op_assign
id|fd-&gt;tree
suffix:semicolon
id|node
op_assign
id|fd-&gt;bnode
suffix:semicolon
id|new_node
op_assign
id|hfs_bmap_alloc
c_func
(paren
id|tree
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|new_node
)paren
)paren
r_return
id|new_node
suffix:semicolon
id|hfs_bnode_get
c_func
(paren
id|node
)paren
suffix:semicolon
id|dprint
c_func
(paren
id|DBG_BNODE_MOD
comma
l_string|&quot;split_nodes: %d - %d - %d&bslash;n&quot;
comma
id|node-&gt;this
comma
id|new_node-&gt;this
comma
id|node-&gt;next
)paren
suffix:semicolon
id|new_node-&gt;next
op_assign
id|node-&gt;next
suffix:semicolon
id|new_node-&gt;prev
op_assign
id|node-&gt;this
suffix:semicolon
id|new_node-&gt;parent
op_assign
id|node-&gt;parent
suffix:semicolon
id|new_node-&gt;type
op_assign
id|node-&gt;type
suffix:semicolon
id|new_node-&gt;height
op_assign
id|node-&gt;height
suffix:semicolon
id|size
op_assign
id|tree-&gt;node_size
op_div
l_int|2
op_minus
id|node-&gt;num_recs
op_star
l_int|2
op_minus
l_int|14
suffix:semicolon
id|old_rec_off
op_assign
id|tree-&gt;node_size
op_minus
l_int|4
suffix:semicolon
id|num_recs
op_assign
l_int|1
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|data_start
op_assign
id|hfs_bnode_read_u16
c_func
(paren
id|node
comma
id|old_rec_off
)paren
suffix:semicolon
r_if
c_cond
(paren
id|data_start
OG
id|size
)paren
r_break
suffix:semicolon
id|old_rec_off
op_sub_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
op_increment
id|num_recs
OL
id|node-&gt;num_recs
)paren
r_continue
suffix:semicolon
multiline_comment|/* panic? */
id|hfs_bnode_put
c_func
(paren
id|node
)paren
suffix:semicolon
id|hfs_bnode_put
c_func
(paren
id|new_node
)paren
suffix:semicolon
r_return
id|ERR_PTR
c_func
(paren
op_minus
id|ENOSPC
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fd-&gt;record
op_plus
l_int|1
OL
id|num_recs
)paren
(brace
multiline_comment|/* new record is in the lower half,&n;&t;&t; * so leave some more space there&n;&t;&t; */
id|old_rec_off
op_add_assign
l_int|2
suffix:semicolon
id|num_recs
op_decrement
suffix:semicolon
id|data_start
op_assign
id|hfs_bnode_read_u16
c_func
(paren
id|node
comma
id|old_rec_off
)paren
suffix:semicolon
)brace
r_else
(brace
id|hfs_bnode_put
c_func
(paren
id|node
)paren
suffix:semicolon
id|hfs_bnode_get
c_func
(paren
id|new_node
)paren
suffix:semicolon
id|fd-&gt;bnode
op_assign
id|new_node
suffix:semicolon
id|fd-&gt;record
op_sub_assign
id|num_recs
suffix:semicolon
id|fd-&gt;keyoffset
op_sub_assign
id|data_start
op_minus
l_int|14
suffix:semicolon
id|fd-&gt;entryoffset
op_sub_assign
id|data_start
op_minus
l_int|14
suffix:semicolon
)brace
id|new_node-&gt;num_recs
op_assign
id|node-&gt;num_recs
op_minus
id|num_recs
suffix:semicolon
id|node-&gt;num_recs
op_assign
id|num_recs
suffix:semicolon
id|new_rec_off
op_assign
id|tree-&gt;node_size
op_minus
l_int|2
suffix:semicolon
id|new_off
op_assign
l_int|14
suffix:semicolon
id|size
op_assign
id|data_start
op_minus
id|new_off
suffix:semicolon
id|num_recs
op_assign
id|new_node-&gt;num_recs
suffix:semicolon
id|data_end
op_assign
id|data_start
suffix:semicolon
r_while
c_loop
(paren
id|num_recs
)paren
(brace
id|hfs_bnode_write_u16
c_func
(paren
id|new_node
comma
id|new_rec_off
comma
id|new_off
)paren
suffix:semicolon
id|old_rec_off
op_sub_assign
l_int|2
suffix:semicolon
id|new_rec_off
op_sub_assign
l_int|2
suffix:semicolon
id|data_end
op_assign
id|hfs_bnode_read_u16
c_func
(paren
id|node
comma
id|old_rec_off
)paren
suffix:semicolon
id|new_off
op_assign
id|data_end
op_minus
id|size
suffix:semicolon
id|num_recs
op_decrement
suffix:semicolon
)brace
id|hfs_bnode_write_u16
c_func
(paren
id|new_node
comma
id|new_rec_off
comma
id|new_off
)paren
suffix:semicolon
id|hfs_bnode_copy
c_func
(paren
id|new_node
comma
l_int|14
comma
id|node
comma
id|data_start
comma
id|data_end
op_minus
id|data_start
)paren
suffix:semicolon
multiline_comment|/* update new bnode header */
id|node_desc.next
op_assign
id|cpu_to_be32
c_func
(paren
id|new_node-&gt;next
)paren
suffix:semicolon
id|node_desc.prev
op_assign
id|cpu_to_be32
c_func
(paren
id|new_node-&gt;prev
)paren
suffix:semicolon
id|node_desc.type
op_assign
id|new_node-&gt;type
suffix:semicolon
id|node_desc.height
op_assign
id|new_node-&gt;height
suffix:semicolon
id|node_desc.num_recs
op_assign
id|cpu_to_be16
c_func
(paren
id|new_node-&gt;num_recs
)paren
suffix:semicolon
id|node_desc.reserved
op_assign
l_int|0
suffix:semicolon
id|hfs_bnode_write
c_func
(paren
id|new_node
comma
op_amp
id|node_desc
comma
l_int|0
comma
r_sizeof
(paren
id|node_desc
)paren
)paren
suffix:semicolon
multiline_comment|/* update previous bnode header */
id|node-&gt;next
op_assign
id|new_node-&gt;this
suffix:semicolon
id|hfs_bnode_read
c_func
(paren
id|node
comma
op_amp
id|node_desc
comma
l_int|0
comma
r_sizeof
(paren
id|node_desc
)paren
)paren
suffix:semicolon
id|node_desc.next
op_assign
id|cpu_to_be32
c_func
(paren
id|node-&gt;next
)paren
suffix:semicolon
id|node_desc.num_recs
op_assign
id|cpu_to_be16
c_func
(paren
id|node-&gt;num_recs
)paren
suffix:semicolon
id|hfs_bnode_write
c_func
(paren
id|node
comma
op_amp
id|node_desc
comma
l_int|0
comma
r_sizeof
(paren
id|node_desc
)paren
)paren
suffix:semicolon
multiline_comment|/* update next bnode header */
r_if
c_cond
(paren
id|new_node-&gt;next
)paren
(brace
r_struct
id|hfs_bnode
op_star
id|next_node
op_assign
id|hfs_bnode_find
c_func
(paren
id|tree
comma
id|new_node-&gt;next
)paren
suffix:semicolon
id|next_node-&gt;prev
op_assign
id|new_node-&gt;this
suffix:semicolon
id|hfs_bnode_read
c_func
(paren
id|next_node
comma
op_amp
id|node_desc
comma
l_int|0
comma
r_sizeof
(paren
id|node_desc
)paren
)paren
suffix:semicolon
id|node_desc.prev
op_assign
id|cpu_to_be32
c_func
(paren
id|next_node-&gt;prev
)paren
suffix:semicolon
id|hfs_bnode_write
c_func
(paren
id|next_node
comma
op_amp
id|node_desc
comma
l_int|0
comma
r_sizeof
(paren
id|node_desc
)paren
)paren
suffix:semicolon
id|hfs_bnode_put
c_func
(paren
id|next_node
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|node-&gt;this
op_eq
id|tree-&gt;leaf_tail
)paren
(brace
multiline_comment|/* if there is no next node, this might be the new tail */
id|tree-&gt;leaf_tail
op_assign
id|new_node-&gt;this
suffix:semicolon
id|mark_inode_dirty
c_func
(paren
id|tree-&gt;inode
)paren
suffix:semicolon
)brace
id|hfs_bnode_dump
c_func
(paren
id|node
)paren
suffix:semicolon
id|hfs_bnode_dump
c_func
(paren
id|new_node
)paren
suffix:semicolon
id|hfs_bnode_put
c_func
(paren
id|node
)paren
suffix:semicolon
r_return
id|new_node
suffix:semicolon
)brace
DECL|function|hfs_brec_update_parent
r_static
r_int
id|hfs_brec_update_parent
c_func
(paren
r_struct
id|hfs_find_data
op_star
id|fd
)paren
(brace
r_struct
id|hfs_btree
op_star
id|tree
suffix:semicolon
r_struct
id|hfs_bnode
op_star
id|node
comma
op_star
id|new_node
comma
op_star
id|parent
suffix:semicolon
r_int
id|newkeylen
comma
id|diff
suffix:semicolon
r_int
id|rec
comma
id|rec_off
comma
id|end_rec_off
suffix:semicolon
r_int
id|start_off
comma
id|end_off
suffix:semicolon
id|tree
op_assign
id|fd-&gt;tree
suffix:semicolon
id|node
op_assign
id|fd-&gt;bnode
suffix:semicolon
id|new_node
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|node-&gt;parent
)paren
r_return
l_int|0
suffix:semicolon
id|again
suffix:colon
id|parent
op_assign
id|hfs_bnode_find
c_func
(paren
id|tree
comma
id|node-&gt;parent
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|parent
)paren
)paren
r_return
id|PTR_ERR
c_func
(paren
id|parent
)paren
suffix:semicolon
id|__hfs_brec_find
c_func
(paren
id|parent
comma
id|fd
)paren
suffix:semicolon
id|hfs_bnode_dump
c_func
(paren
id|parent
)paren
suffix:semicolon
id|rec
op_assign
id|fd-&gt;record
suffix:semicolon
multiline_comment|/* size difference between old and new key */
r_if
c_cond
(paren
id|tree-&gt;attributes
op_amp
id|HFS_TREE_VARIDXKEYS
)paren
id|newkeylen
op_assign
(paren
id|hfs_bnode_read_u8
c_func
(paren
id|node
comma
l_int|14
)paren
op_or
l_int|1
)paren
op_plus
l_int|1
suffix:semicolon
r_else
id|fd-&gt;keylength
op_assign
id|newkeylen
op_assign
id|tree-&gt;max_key_len
op_plus
l_int|1
suffix:semicolon
id|dprint
c_func
(paren
id|DBG_BNODE_MOD
comma
l_string|&quot;update_rec: %d, %d, %d&bslash;n&quot;
comma
id|rec
comma
id|fd-&gt;keylength
comma
id|newkeylen
)paren
suffix:semicolon
id|rec_off
op_assign
id|tree-&gt;node_size
op_minus
(paren
id|rec
op_plus
l_int|2
)paren
op_star
l_int|2
suffix:semicolon
id|end_rec_off
op_assign
id|tree-&gt;node_size
op_minus
(paren
id|parent-&gt;num_recs
op_plus
l_int|1
)paren
op_star
l_int|2
suffix:semicolon
id|diff
op_assign
id|newkeylen
op_minus
id|fd-&gt;keylength
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|diff
)paren
r_goto
id|skip
suffix:semicolon
r_if
c_cond
(paren
id|diff
OG
l_int|0
)paren
(brace
id|end_off
op_assign
id|hfs_bnode_read_u16
c_func
(paren
id|parent
comma
id|end_rec_off
)paren
suffix:semicolon
r_if
c_cond
(paren
id|end_rec_off
op_minus
id|end_off
OL
id|diff
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;splitting index node...&bslash;n&quot;
)paren
suffix:semicolon
id|fd-&gt;bnode
op_assign
id|parent
suffix:semicolon
id|new_node
op_assign
id|hfs_bnode_split
c_func
(paren
id|fd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|new_node
)paren
)paren
r_return
id|PTR_ERR
c_func
(paren
id|new_node
)paren
suffix:semicolon
id|parent
op_assign
id|fd-&gt;bnode
suffix:semicolon
id|rec
op_assign
id|fd-&gt;record
suffix:semicolon
id|rec_off
op_assign
id|tree-&gt;node_size
op_minus
(paren
id|rec
op_plus
l_int|2
)paren
op_star
l_int|2
suffix:semicolon
id|end_rec_off
op_assign
id|tree-&gt;node_size
op_minus
(paren
id|parent-&gt;num_recs
op_plus
l_int|1
)paren
op_star
l_int|2
suffix:semicolon
)brace
)brace
id|end_off
op_assign
id|start_off
op_assign
id|hfs_bnode_read_u16
c_func
(paren
id|parent
comma
id|rec_off
)paren
suffix:semicolon
id|hfs_bnode_write_u16
c_func
(paren
id|parent
comma
id|rec_off
comma
id|start_off
op_plus
id|diff
)paren
suffix:semicolon
id|start_off
op_sub_assign
l_int|4
suffix:semicolon
multiline_comment|/* move previous cnid too */
r_while
c_loop
(paren
id|rec_off
OG
id|end_rec_off
)paren
(brace
id|rec_off
op_sub_assign
l_int|2
suffix:semicolon
id|end_off
op_assign
id|hfs_bnode_read_u16
c_func
(paren
id|parent
comma
id|rec_off
)paren
suffix:semicolon
id|hfs_bnode_write_u16
c_func
(paren
id|parent
comma
id|rec_off
comma
id|end_off
op_plus
id|diff
)paren
suffix:semicolon
)brace
id|hfs_bnode_move
c_func
(paren
id|parent
comma
id|start_off
op_plus
id|diff
comma
id|start_off
comma
id|end_off
op_minus
id|start_off
)paren
suffix:semicolon
id|skip
suffix:colon
id|hfs_bnode_copy
c_func
(paren
id|parent
comma
id|fd-&gt;keyoffset
comma
id|node
comma
l_int|14
comma
id|newkeylen
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|tree-&gt;attributes
op_amp
id|HFS_TREE_VARIDXKEYS
)paren
)paren
id|hfs_bnode_write_u8
c_func
(paren
id|parent
comma
id|fd-&gt;keyoffset
comma
id|newkeylen
op_minus
l_int|1
)paren
suffix:semicolon
id|hfs_bnode_dump
c_func
(paren
id|parent
)paren
suffix:semicolon
id|hfs_bnode_put
c_func
(paren
id|node
)paren
suffix:semicolon
id|node
op_assign
id|parent
suffix:semicolon
r_if
c_cond
(paren
id|new_node
)paren
(brace
id|__be32
id|cnid
suffix:semicolon
id|fd-&gt;bnode
op_assign
id|hfs_bnode_find
c_func
(paren
id|tree
comma
id|new_node-&gt;parent
)paren
suffix:semicolon
multiline_comment|/* create index key and entry */
id|hfs_bnode_read_key
c_func
(paren
id|new_node
comma
id|fd-&gt;search_key
comma
l_int|14
)paren
suffix:semicolon
id|cnid
op_assign
id|cpu_to_be32
c_func
(paren
id|new_node-&gt;this
)paren
suffix:semicolon
id|__hfs_brec_find
c_func
(paren
id|fd-&gt;bnode
comma
id|fd
)paren
suffix:semicolon
id|hfs_brec_insert
c_func
(paren
id|fd
comma
op_amp
id|cnid
comma
r_sizeof
(paren
id|cnid
)paren
)paren
suffix:semicolon
id|hfs_bnode_put
c_func
(paren
id|fd-&gt;bnode
)paren
suffix:semicolon
id|hfs_bnode_put
c_func
(paren
id|new_node
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rec
)paren
(brace
r_if
c_cond
(paren
id|new_node
op_eq
id|node
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* restore search_key */
id|hfs_bnode_read_key
c_func
(paren
id|node
comma
id|fd-&gt;search_key
comma
l_int|14
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|rec
op_logical_and
id|node-&gt;parent
)paren
r_goto
id|again
suffix:semicolon
id|out
suffix:colon
id|fd-&gt;bnode
op_assign
id|node
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|hfs_btree_inc_height
r_static
r_int
id|hfs_btree_inc_height
c_func
(paren
r_struct
id|hfs_btree
op_star
id|tree
)paren
(brace
r_struct
id|hfs_bnode
op_star
id|node
comma
op_star
id|new_node
suffix:semicolon
r_struct
id|hfs_bnode_desc
id|node_desc
suffix:semicolon
r_int
id|key_size
comma
id|rec
suffix:semicolon
id|__be32
id|cnid
suffix:semicolon
id|node
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|tree-&gt;root
)paren
(brace
id|node
op_assign
id|hfs_bnode_find
c_func
(paren
id|tree
comma
id|tree-&gt;root
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|node
)paren
)paren
r_return
id|PTR_ERR
c_func
(paren
id|node
)paren
suffix:semicolon
)brace
id|new_node
op_assign
id|hfs_bmap_alloc
c_func
(paren
id|tree
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|new_node
)paren
)paren
(brace
id|hfs_bnode_put
c_func
(paren
id|node
)paren
suffix:semicolon
r_return
id|PTR_ERR
c_func
(paren
id|new_node
)paren
suffix:semicolon
)brace
id|tree-&gt;root
op_assign
id|new_node-&gt;this
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tree-&gt;depth
)paren
(brace
id|tree-&gt;leaf_head
op_assign
id|tree-&gt;leaf_tail
op_assign
id|new_node-&gt;this
suffix:semicolon
id|new_node-&gt;type
op_assign
id|HFS_NODE_LEAF
suffix:semicolon
id|new_node-&gt;num_recs
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|new_node-&gt;type
op_assign
id|HFS_NODE_INDEX
suffix:semicolon
id|new_node-&gt;num_recs
op_assign
l_int|1
suffix:semicolon
)brace
id|new_node-&gt;parent
op_assign
l_int|0
suffix:semicolon
id|new_node-&gt;next
op_assign
l_int|0
suffix:semicolon
id|new_node-&gt;prev
op_assign
l_int|0
suffix:semicolon
id|new_node-&gt;height
op_assign
op_increment
id|tree-&gt;depth
suffix:semicolon
id|node_desc.next
op_assign
id|cpu_to_be32
c_func
(paren
id|new_node-&gt;next
)paren
suffix:semicolon
id|node_desc.prev
op_assign
id|cpu_to_be32
c_func
(paren
id|new_node-&gt;prev
)paren
suffix:semicolon
id|node_desc.type
op_assign
id|new_node-&gt;type
suffix:semicolon
id|node_desc.height
op_assign
id|new_node-&gt;height
suffix:semicolon
id|node_desc.num_recs
op_assign
id|cpu_to_be16
c_func
(paren
id|new_node-&gt;num_recs
)paren
suffix:semicolon
id|node_desc.reserved
op_assign
l_int|0
suffix:semicolon
id|hfs_bnode_write
c_func
(paren
id|new_node
comma
op_amp
id|node_desc
comma
l_int|0
comma
r_sizeof
(paren
id|node_desc
)paren
)paren
suffix:semicolon
id|rec
op_assign
id|tree-&gt;node_size
op_minus
l_int|2
suffix:semicolon
id|hfs_bnode_write_u16
c_func
(paren
id|new_node
comma
id|rec
comma
l_int|14
)paren
suffix:semicolon
r_if
c_cond
(paren
id|node
)paren
(brace
multiline_comment|/* insert old root idx into new root */
id|node-&gt;parent
op_assign
id|tree-&gt;root
suffix:semicolon
r_if
c_cond
(paren
id|node-&gt;type
op_eq
id|HFS_NODE_LEAF
op_logical_or
id|tree-&gt;attributes
op_amp
id|HFS_TREE_VARIDXKEYS
)paren
id|key_size
op_assign
id|hfs_bnode_read_u8
c_func
(paren
id|node
comma
l_int|14
)paren
op_plus
l_int|1
suffix:semicolon
r_else
id|key_size
op_assign
id|tree-&gt;max_key_len
op_plus
l_int|1
suffix:semicolon
id|hfs_bnode_copy
c_func
(paren
id|new_node
comma
l_int|14
comma
id|node
comma
l_int|14
comma
id|key_size
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|tree-&gt;attributes
op_amp
id|HFS_TREE_VARIDXKEYS
)paren
)paren
(brace
id|key_size
op_assign
id|tree-&gt;max_key_len
op_plus
l_int|1
suffix:semicolon
id|hfs_bnode_write_u8
c_func
(paren
id|new_node
comma
l_int|14
comma
id|tree-&gt;max_key_len
)paren
suffix:semicolon
)brace
id|key_size
op_assign
(paren
id|key_size
op_plus
l_int|1
)paren
op_amp
op_minus
l_int|2
suffix:semicolon
id|cnid
op_assign
id|cpu_to_be32
c_func
(paren
id|node-&gt;this
)paren
suffix:semicolon
id|hfs_bnode_write
c_func
(paren
id|new_node
comma
op_amp
id|cnid
comma
l_int|14
op_plus
id|key_size
comma
l_int|4
)paren
suffix:semicolon
id|rec
op_sub_assign
l_int|2
suffix:semicolon
id|hfs_bnode_write_u16
c_func
(paren
id|new_node
comma
id|rec
comma
l_int|14
op_plus
id|key_size
op_plus
l_int|4
)paren
suffix:semicolon
id|hfs_bnode_put
c_func
(paren
id|node
)paren
suffix:semicolon
)brace
id|hfs_bnode_put
c_func
(paren
id|new_node
)paren
suffix:semicolon
id|mark_inode_dirty
c_func
(paren
id|tree-&gt;inode
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
eof
