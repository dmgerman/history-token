multiline_comment|/*&n; *  fs/nfs/nfs4proc.c&n; *&n; *  Client-side procedure declarations for NFSv4.&n; *&n; *  Copyright (c) 2002 The Regents of the University of Michigan.&n; *  All rights reserved.&n; *&n; *  Kendrick Smith &lt;kmsmith@umich.edu&gt;&n; *  Andy Adamson   &lt;andros@umich.edu&gt;&n; *&n; *  Redistribution and use in source and binary forms, with or without&n; *  modification, are permitted provided that the following conditions&n; *  are met:&n; *&n; *  1. Redistributions of source code must retain the above copyright&n; *     notice, this list of conditions and the following disclaimer.&n; *  2. Redistributions in binary form must reproduce the above copyright&n; *     notice, this list of conditions and the following disclaimer in the&n; *     documentation and/or other materials provided with the distribution.&n; *  3. Neither the name of the University nor the names of its&n; *     contributors may be used to endorse or promote products derived&n; *     from this software without specific prior written permission.&n; *&n; *  THIS SOFTWARE IS PROVIDED ``AS IS&squot;&squot; AND ANY EXPRESS OR IMPLIED&n; *  WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF&n; *  MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE&n; *  DISCLAIMED. IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE&n; *  FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR&n; *  CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF&n; *  SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR&n; *  BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF&n; *  LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING&n; *  NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS&n; *  SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.&n; */
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/utsname.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/sunrpc/clnt.h&gt;
macro_line|#include &lt;linux/nfs.h&gt;
macro_line|#include &lt;linux/nfs4.h&gt;
macro_line|#include &lt;linux/nfs_fs.h&gt;
macro_line|#include &lt;linux/nfs_page.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/namei.h&gt;
macro_line|#include &quot;delegation.h&quot;
DECL|macro|NFSDBG_FACILITY
mdefine_line|#define NFSDBG_FACILITY&t;&t;NFSDBG_PROC
DECL|macro|NFS4_POLL_RETRY_MIN
mdefine_line|#define NFS4_POLL_RETRY_MIN&t;(1*HZ)
DECL|macro|NFS4_POLL_RETRY_MAX
mdefine_line|#define NFS4_POLL_RETRY_MAX&t;(15*HZ)
r_static
r_int
id|nfs4_do_fsinfo
c_func
(paren
r_struct
id|nfs_server
op_star
comma
r_struct
id|nfs_fh
op_star
comma
r_struct
id|nfs_fsinfo
op_star
)paren
suffix:semicolon
r_static
r_int
id|nfs4_async_handle_error
c_func
(paren
r_struct
id|rpc_task
op_star
comma
r_struct
id|nfs_server
op_star
)paren
suffix:semicolon
r_static
r_int
id|_nfs4_proc_access
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|nfs_access_entry
op_star
id|entry
)paren
suffix:semicolon
r_static
r_int
id|nfs4_handle_exception
c_func
(paren
r_struct
id|nfs_server
op_star
id|server
comma
r_int
id|errorcode
comma
r_struct
id|nfs4_exception
op_star
id|exception
)paren
suffix:semicolon
r_extern
id|u32
op_star
id|nfs4_decode_dirent
c_func
(paren
id|u32
op_star
id|p
comma
r_struct
id|nfs_entry
op_star
id|entry
comma
r_int
id|plus
)paren
suffix:semicolon
r_extern
r_struct
id|rpc_procinfo
id|nfs4_procedures
(braket
)braket
suffix:semicolon
r_extern
id|nfs4_stateid
id|zero_stateid
suffix:semicolon
multiline_comment|/* Prevent leaks of NFSv4 errors into userland */
DECL|function|nfs4_map_errors
r_int
id|nfs4_map_errors
c_func
(paren
r_int
id|err
)paren
(brace
r_if
c_cond
(paren
id|err
OL
op_minus
l_int|1000
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;%s could not handle NFSv4 error %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
op_minus
id|err
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*&n; * This is our standard bitmap for GETATTR requests.&n; */
DECL|variable|nfs4_fattr_bitmap
r_const
id|u32
id|nfs4_fattr_bitmap
(braket
l_int|2
)braket
op_assign
(brace
id|FATTR4_WORD0_TYPE
op_or
id|FATTR4_WORD0_CHANGE
op_or
id|FATTR4_WORD0_SIZE
op_or
id|FATTR4_WORD0_FSID
op_or
id|FATTR4_WORD0_FILEID
comma
id|FATTR4_WORD1_MODE
op_or
id|FATTR4_WORD1_NUMLINKS
op_or
id|FATTR4_WORD1_OWNER
op_or
id|FATTR4_WORD1_OWNER_GROUP
op_or
id|FATTR4_WORD1_RAWDEV
op_or
id|FATTR4_WORD1_SPACE_USED
op_or
id|FATTR4_WORD1_TIME_ACCESS
op_or
id|FATTR4_WORD1_TIME_METADATA
op_or
id|FATTR4_WORD1_TIME_MODIFY
)brace
suffix:semicolon
DECL|variable|nfs4_statfs_bitmap
r_const
id|u32
id|nfs4_statfs_bitmap
(braket
l_int|2
)braket
op_assign
(brace
id|FATTR4_WORD0_FILES_AVAIL
op_or
id|FATTR4_WORD0_FILES_FREE
op_or
id|FATTR4_WORD0_FILES_TOTAL
comma
id|FATTR4_WORD1_SPACE_AVAIL
op_or
id|FATTR4_WORD1_SPACE_FREE
op_or
id|FATTR4_WORD1_SPACE_TOTAL
)brace
suffix:semicolon
DECL|variable|nfs4_pathconf_bitmap
id|u32
id|nfs4_pathconf_bitmap
(braket
l_int|2
)braket
op_assign
(brace
id|FATTR4_WORD0_MAXLINK
op_or
id|FATTR4_WORD0_MAXNAME
comma
l_int|0
)brace
suffix:semicolon
DECL|variable|nfs4_fsinfo_bitmap
r_const
id|u32
id|nfs4_fsinfo_bitmap
(braket
l_int|2
)braket
op_assign
(brace
id|FATTR4_WORD0_MAXFILESIZE
op_or
id|FATTR4_WORD0_MAXREAD
op_or
id|FATTR4_WORD0_MAXWRITE
op_or
id|FATTR4_WORD0_LEASE_TIME
comma
l_int|0
)brace
suffix:semicolon
DECL|function|nfs4_setup_readdir
r_static
r_void
id|nfs4_setup_readdir
c_func
(paren
id|u64
id|cookie
comma
id|u32
op_star
id|verifier
comma
r_struct
id|dentry
op_star
id|dentry
comma
r_struct
id|nfs4_readdir_arg
op_star
id|readdir
)paren
(brace
id|u32
op_star
id|start
comma
op_star
id|p
suffix:semicolon
id|BUG_ON
c_func
(paren
id|readdir-&gt;count
OL
l_int|80
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cookie
OG
l_int|2
)paren
(brace
id|readdir-&gt;cookie
op_assign
(paren
id|cookie
OG
l_int|2
)paren
ques
c_cond
id|cookie
suffix:colon
l_int|0
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|readdir-&gt;verifier
comma
id|verifier
comma
r_sizeof
(paren
id|readdir-&gt;verifier
)paren
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|readdir-&gt;cookie
op_assign
l_int|0
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|readdir-&gt;verifier
comma
l_int|0
comma
r_sizeof
(paren
id|readdir-&gt;verifier
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cookie
op_eq
l_int|2
)paren
r_return
suffix:semicolon
multiline_comment|/*&n;&t; * NFSv4 servers do not return entries for &squot;.&squot; and &squot;..&squot;&n;&t; * Therefore, we fake these entries here.  We let &squot;.&squot;&n;&t; * have cookie 0 and &squot;..&squot; have cookie 1.  Note that&n;&t; * when talking to the server, we always send cookie 0&n;&t; * instead of 1 or 2.&n;&t; */
id|start
op_assign
id|p
op_assign
(paren
id|u32
op_star
)paren
id|kmap_atomic
c_func
(paren
op_star
id|readdir-&gt;pages
comma
id|KM_USER0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cookie
op_eq
l_int|0
)paren
(brace
op_star
id|p
op_increment
op_assign
id|xdr_one
suffix:semicolon
multiline_comment|/* next */
op_star
id|p
op_increment
op_assign
id|xdr_zero
suffix:semicolon
multiline_comment|/* cookie, first word */
op_star
id|p
op_increment
op_assign
id|xdr_one
suffix:semicolon
multiline_comment|/* cookie, second word */
op_star
id|p
op_increment
op_assign
id|xdr_one
suffix:semicolon
multiline_comment|/* entry len */
id|memcpy
c_func
(paren
id|p
comma
l_string|&quot;.&bslash;0&bslash;0&bslash;0&quot;
comma
l_int|4
)paren
suffix:semicolon
multiline_comment|/* entry */
id|p
op_increment
suffix:semicolon
op_star
id|p
op_increment
op_assign
id|xdr_one
suffix:semicolon
multiline_comment|/* bitmap length */
op_star
id|p
op_increment
op_assign
id|htonl
c_func
(paren
id|FATTR4_WORD0_FILEID
)paren
suffix:semicolon
multiline_comment|/* bitmap */
op_star
id|p
op_increment
op_assign
id|htonl
c_func
(paren
l_int|8
)paren
suffix:semicolon
multiline_comment|/* attribute buffer length */
id|p
op_assign
id|xdr_encode_hyper
c_func
(paren
id|p
comma
id|dentry-&gt;d_inode-&gt;i_ino
)paren
suffix:semicolon
)brace
op_star
id|p
op_increment
op_assign
id|xdr_one
suffix:semicolon
multiline_comment|/* next */
op_star
id|p
op_increment
op_assign
id|xdr_zero
suffix:semicolon
multiline_comment|/* cookie, first word */
op_star
id|p
op_increment
op_assign
id|xdr_two
suffix:semicolon
multiline_comment|/* cookie, second word */
op_star
id|p
op_increment
op_assign
id|xdr_two
suffix:semicolon
multiline_comment|/* entry len */
id|memcpy
c_func
(paren
id|p
comma
l_string|&quot;..&bslash;0&bslash;0&quot;
comma
l_int|4
)paren
suffix:semicolon
multiline_comment|/* entry */
id|p
op_increment
suffix:semicolon
op_star
id|p
op_increment
op_assign
id|xdr_one
suffix:semicolon
multiline_comment|/* bitmap length */
op_star
id|p
op_increment
op_assign
id|htonl
c_func
(paren
id|FATTR4_WORD0_FILEID
)paren
suffix:semicolon
multiline_comment|/* bitmap */
op_star
id|p
op_increment
op_assign
id|htonl
c_func
(paren
l_int|8
)paren
suffix:semicolon
multiline_comment|/* attribute buffer length */
id|p
op_assign
id|xdr_encode_hyper
c_func
(paren
id|p
comma
id|dentry-&gt;d_parent-&gt;d_inode-&gt;i_ino
)paren
suffix:semicolon
id|readdir-&gt;pgbase
op_assign
(paren
r_char
op_star
)paren
id|p
op_minus
(paren
r_char
op_star
)paren
id|start
suffix:semicolon
id|readdir-&gt;count
op_sub_assign
id|readdir-&gt;pgbase
suffix:semicolon
id|kunmap_atomic
c_func
(paren
id|start
comma
id|KM_USER0
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|renew_lease
id|renew_lease
c_func
(paren
r_struct
id|nfs_server
op_star
id|server
comma
r_int
r_int
id|timestamp
)paren
(brace
r_struct
id|nfs4_client
op_star
id|clp
op_assign
id|server-&gt;nfs4_state
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|clp-&gt;cl_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|time_before
c_func
(paren
id|clp-&gt;cl_last_renewal
comma
id|timestamp
)paren
)paren
id|clp-&gt;cl_last_renewal
op_assign
id|timestamp
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|clp-&gt;cl_lock
)paren
suffix:semicolon
)brace
DECL|function|update_changeattr
r_static
r_void
id|update_changeattr
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|nfs4_change_info
op_star
id|cinfo
)paren
(brace
r_struct
id|nfs_inode
op_star
id|nfsi
op_assign
id|NFS_I
c_func
(paren
id|inode
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cinfo-&gt;before
op_eq
id|nfsi-&gt;change_attr
op_logical_and
id|cinfo-&gt;atomic
)paren
id|nfsi-&gt;change_attr
op_assign
id|cinfo-&gt;after
suffix:semicolon
)brace
multiline_comment|/*&n; * OPEN_RECLAIM:&n; * &t;reclaim state on the server after a reboot.&n; * &t;Assumes caller is holding the sp-&gt;so_sem&n; */
DECL|function|_nfs4_open_reclaim
r_static
r_int
id|_nfs4_open_reclaim
c_func
(paren
r_struct
id|nfs4_state_owner
op_star
id|sp
comma
r_struct
id|nfs4_state
op_star
id|state
)paren
(brace
r_struct
id|inode
op_star
id|inode
op_assign
id|state-&gt;inode
suffix:semicolon
r_struct
id|nfs_server
op_star
id|server
op_assign
id|NFS_SERVER
c_func
(paren
id|inode
)paren
suffix:semicolon
r_struct
id|nfs_delegation
op_star
id|delegation
op_assign
id|NFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|delegation
suffix:semicolon
r_struct
id|nfs_openargs
id|o_arg
op_assign
(brace
dot
id|fh
op_assign
id|NFS_FH
c_func
(paren
id|inode
)paren
comma
dot
id|seqid
op_assign
id|sp-&gt;so_seqid
comma
dot
id|id
op_assign
id|sp-&gt;so_id
comma
dot
id|open_flags
op_assign
id|state-&gt;state
comma
dot
id|clientid
op_assign
id|server-&gt;nfs4_state-&gt;cl_clientid
comma
dot
id|claim
op_assign
id|NFS4_OPEN_CLAIM_PREVIOUS
comma
dot
id|bitmask
op_assign
id|server-&gt;attr_bitmask
comma
)brace
suffix:semicolon
r_struct
id|nfs_openres
id|o_res
op_assign
(brace
dot
id|server
op_assign
id|server
comma
multiline_comment|/* Grrr */
)brace
suffix:semicolon
r_struct
id|rpc_message
id|msg
op_assign
(brace
dot
id|rpc_proc
op_assign
op_amp
id|nfs4_procedures
(braket
id|NFSPROC4_CLNT_OPEN_NOATTR
)braket
comma
dot
id|rpc_argp
op_assign
op_amp
id|o_arg
comma
dot
id|rpc_resp
op_assign
op_amp
id|o_res
comma
dot
id|rpc_cred
op_assign
id|sp-&gt;so_cred
comma
)brace
suffix:semicolon
r_int
id|status
suffix:semicolon
r_if
c_cond
(paren
id|delegation
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|delegation-&gt;flags
op_amp
id|NFS_DELEGATION_NEED_RECLAIM
)paren
)paren
(brace
id|memcpy
c_func
(paren
op_amp
id|state-&gt;stateid
comma
op_amp
id|delegation-&gt;stateid
comma
r_sizeof
(paren
id|state-&gt;stateid
)paren
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|NFS_DELEGATED_STATE
comma
op_amp
id|state-&gt;flags
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|o_arg.u.delegation_type
op_assign
id|delegation-&gt;type
suffix:semicolon
)brace
id|status
op_assign
id|rpc_call_sync
c_func
(paren
id|server-&gt;client
comma
op_amp
id|msg
comma
id|RPC_TASK_NOINTR
)paren
suffix:semicolon
id|nfs4_increment_seqid
c_func
(paren
id|status
comma
id|sp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_eq
l_int|0
)paren
(brace
id|memcpy
c_func
(paren
op_amp
id|state-&gt;stateid
comma
op_amp
id|o_res.stateid
comma
r_sizeof
(paren
id|state-&gt;stateid
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|o_res.delegation_type
op_ne
l_int|0
)paren
(brace
id|nfs_inode_reclaim_delegation
c_func
(paren
id|inode
comma
id|sp-&gt;so_cred
comma
op_amp
id|o_res
)paren
suffix:semicolon
multiline_comment|/* Did the server issue an immediate delegation recall? */
r_if
c_cond
(paren
id|o_res.do_recall
)paren
id|nfs_async_inode_return_delegation
c_func
(paren
id|inode
comma
op_amp
id|o_res.stateid
)paren
suffix:semicolon
)brace
)brace
id|clear_bit
c_func
(paren
id|NFS_DELEGATED_STATE
comma
op_amp
id|state-&gt;flags
)paren
suffix:semicolon
multiline_comment|/* Ensure we update the inode attributes */
id|NFS_CACHEINV
c_func
(paren
id|inode
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
DECL|function|nfs4_open_reclaim
r_int
id|nfs4_open_reclaim
c_func
(paren
r_struct
id|nfs4_state_owner
op_star
id|sp
comma
r_struct
id|nfs4_state
op_star
id|state
)paren
(brace
r_struct
id|nfs_server
op_star
id|server
op_assign
id|NFS_SERVER
c_func
(paren
id|state-&gt;inode
)paren
suffix:semicolon
r_struct
id|nfs4_exception
id|exception
op_assign
(brace
)brace
suffix:semicolon
r_int
id|err
suffix:semicolon
r_do
(brace
id|err
op_assign
id|_nfs4_open_reclaim
c_func
(paren
id|sp
comma
id|state
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|err
)paren
(brace
r_case
l_int|0
suffix:colon
r_case
op_minus
id|NFS4ERR_STALE_CLIENTID
suffix:colon
r_case
op_minus
id|NFS4ERR_STALE_STATEID
suffix:colon
r_case
op_minus
id|NFS4ERR_EXPIRED
suffix:colon
r_return
id|err
suffix:semicolon
)brace
id|err
op_assign
id|nfs4_handle_exception
c_func
(paren
id|server
comma
id|err
comma
op_amp
id|exception
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|exception.retry
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|_nfs4_open_delegation_recall
r_static
r_int
id|_nfs4_open_delegation_recall
c_func
(paren
r_struct
id|dentry
op_star
id|dentry
comma
r_struct
id|nfs4_state
op_star
id|state
)paren
(brace
r_struct
id|nfs4_state_owner
op_star
id|sp
op_assign
id|state-&gt;owner
suffix:semicolon
r_struct
id|inode
op_star
id|inode
op_assign
id|dentry-&gt;d_inode
suffix:semicolon
r_struct
id|nfs_server
op_star
id|server
op_assign
id|NFS_SERVER
c_func
(paren
id|inode
)paren
suffix:semicolon
r_struct
id|dentry
op_star
id|parent
op_assign
id|dget_parent
c_func
(paren
id|dentry
)paren
suffix:semicolon
r_struct
id|nfs_openargs
id|arg
op_assign
(brace
dot
id|fh
op_assign
id|NFS_FH
c_func
(paren
id|parent-&gt;d_inode
)paren
comma
dot
id|clientid
op_assign
id|server-&gt;nfs4_state-&gt;cl_clientid
comma
dot
id|name
op_assign
op_amp
id|dentry-&gt;d_name
comma
dot
id|id
op_assign
id|sp-&gt;so_id
comma
dot
id|server
op_assign
id|server
comma
dot
id|bitmask
op_assign
id|server-&gt;attr_bitmask
comma
dot
id|claim
op_assign
id|NFS4_OPEN_CLAIM_DELEGATE_CUR
comma
)brace
suffix:semicolon
r_struct
id|nfs_openres
id|res
op_assign
(brace
dot
id|server
op_assign
id|server
comma
)brace
suffix:semicolon
r_struct
id|rpc_message
id|msg
op_assign
(brace
dot
id|rpc_proc
op_assign
op_amp
id|nfs4_procedures
(braket
id|NFSPROC4_CLNT_OPEN_NOATTR
)braket
comma
dot
id|rpc_argp
op_assign
op_amp
id|arg
comma
dot
id|rpc_resp
op_assign
op_amp
id|res
comma
dot
id|rpc_cred
op_assign
id|sp-&gt;so_cred
comma
)brace
suffix:semicolon
r_int
id|status
op_assign
l_int|0
suffix:semicolon
id|down
c_func
(paren
op_amp
id|sp-&gt;so_sema
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|test_bit
c_func
(paren
id|NFS_DELEGATED_STATE
comma
op_amp
id|state-&gt;flags
)paren
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|state-&gt;state
op_eq
l_int|0
)paren
r_goto
id|out
suffix:semicolon
id|arg.seqid
op_assign
id|sp-&gt;so_seqid
suffix:semicolon
id|arg.open_flags
op_assign
id|state-&gt;state
suffix:semicolon
id|memcpy
c_func
(paren
id|arg.u.delegation.data
comma
id|state-&gt;stateid.data
comma
r_sizeof
(paren
id|arg.u.delegation.data
)paren
)paren
suffix:semicolon
id|status
op_assign
id|rpc_call_sync
c_func
(paren
id|server-&gt;client
comma
op_amp
id|msg
comma
id|RPC_TASK_NOINTR
)paren
suffix:semicolon
id|nfs4_increment_seqid
c_func
(paren
id|status
comma
id|sp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_ge
l_int|0
)paren
(brace
id|memcpy
c_func
(paren
id|state-&gt;stateid.data
comma
id|res.stateid.data
comma
r_sizeof
(paren
id|state-&gt;stateid.data
)paren
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|NFS_DELEGATED_STATE
comma
op_amp
id|state-&gt;flags
)paren
suffix:semicolon
)brace
id|out
suffix:colon
id|up
c_func
(paren
op_amp
id|sp-&gt;so_sema
)paren
suffix:semicolon
id|dput
c_func
(paren
id|parent
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
DECL|function|nfs4_open_delegation_recall
r_int
id|nfs4_open_delegation_recall
c_func
(paren
r_struct
id|dentry
op_star
id|dentry
comma
r_struct
id|nfs4_state
op_star
id|state
)paren
(brace
r_struct
id|nfs4_exception
id|exception
op_assign
(brace
)brace
suffix:semicolon
r_struct
id|nfs_server
op_star
id|server
op_assign
id|NFS_SERVER
c_func
(paren
id|dentry-&gt;d_inode
)paren
suffix:semicolon
r_int
id|err
suffix:semicolon
r_do
(brace
id|err
op_assign
id|_nfs4_open_delegation_recall
c_func
(paren
id|dentry
comma
id|state
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|err
)paren
(brace
r_case
l_int|0
suffix:colon
r_return
id|err
suffix:semicolon
r_case
op_minus
id|NFS4ERR_STALE_CLIENTID
suffix:colon
r_case
op_minus
id|NFS4ERR_STALE_STATEID
suffix:colon
r_case
op_minus
id|NFS4ERR_EXPIRED
suffix:colon
multiline_comment|/* Don&squot;t recall a delegation if it was lost */
id|nfs4_schedule_state_recovery
c_func
(paren
id|server-&gt;nfs4_state
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|err
op_assign
id|nfs4_handle_exception
c_func
(paren
id|server
comma
id|err
comma
op_amp
id|exception
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|exception.retry
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|_nfs4_proc_open_confirm
r_static
r_int
id|_nfs4_proc_open_confirm
c_func
(paren
r_struct
id|rpc_clnt
op_star
id|clnt
comma
r_const
r_struct
id|nfs_fh
op_star
id|fh
comma
r_struct
id|nfs4_state_owner
op_star
id|sp
comma
id|nfs4_stateid
op_star
id|stateid
)paren
(brace
r_struct
id|nfs_open_confirmargs
id|arg
op_assign
(brace
dot
id|fh
op_assign
id|fh
comma
dot
id|seqid
op_assign
id|sp-&gt;so_seqid
comma
dot
id|stateid
op_assign
op_star
id|stateid
comma
)brace
suffix:semicolon
r_struct
id|nfs_open_confirmres
id|res
suffix:semicolon
r_struct
id|rpc_message
id|msg
op_assign
(brace
dot
id|rpc_proc
op_assign
op_amp
id|nfs4_procedures
(braket
id|NFSPROC4_CLNT_OPEN_CONFIRM
)braket
comma
dot
id|rpc_argp
op_assign
op_amp
id|arg
comma
dot
id|rpc_resp
op_assign
op_amp
id|res
comma
dot
id|rpc_cred
op_assign
id|sp-&gt;so_cred
comma
)brace
suffix:semicolon
r_int
id|status
suffix:semicolon
id|status
op_assign
id|rpc_call_sync
c_func
(paren
id|clnt
comma
op_amp
id|msg
comma
id|RPC_TASK_NOINTR
)paren
suffix:semicolon
id|nfs4_increment_seqid
c_func
(paren
id|status
comma
id|sp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_ge
l_int|0
)paren
id|memcpy
c_func
(paren
id|stateid
comma
op_amp
id|res.stateid
comma
r_sizeof
(paren
op_star
id|stateid
)paren
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
DECL|function|_nfs4_do_access
r_static
r_int
id|_nfs4_do_access
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|rpc_cred
op_star
id|cred
comma
r_int
id|openflags
)paren
(brace
r_struct
id|nfs_access_entry
id|cache
suffix:semicolon
r_int
id|mask
op_assign
l_int|0
suffix:semicolon
r_int
id|status
suffix:semicolon
r_if
c_cond
(paren
id|openflags
op_amp
id|FMODE_READ
)paren
id|mask
op_or_assign
id|MAY_READ
suffix:semicolon
r_if
c_cond
(paren
id|openflags
op_amp
id|FMODE_WRITE
)paren
id|mask
op_or_assign
id|MAY_WRITE
suffix:semicolon
id|status
op_assign
id|nfs_access_get_cached
c_func
(paren
id|inode
comma
id|cred
comma
op_amp
id|cache
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_eq
l_int|0
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* Be clever: ask server to check for all possible rights */
id|cache.mask
op_assign
id|MAY_EXEC
op_or
id|MAY_WRITE
op_or
id|MAY_READ
suffix:semicolon
id|cache.cred
op_assign
id|cred
suffix:semicolon
id|cache.jiffies
op_assign
id|jiffies
suffix:semicolon
id|status
op_assign
id|_nfs4_proc_access
c_func
(paren
id|inode
comma
op_amp
id|cache
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_ne
l_int|0
)paren
r_return
id|status
suffix:semicolon
id|nfs_access_add_cache
c_func
(paren
id|inode
comma
op_amp
id|cache
)paren
suffix:semicolon
id|out
suffix:colon
r_if
c_cond
(paren
(paren
id|cache.mask
op_amp
id|mask
)paren
op_eq
id|mask
)paren
r_return
l_int|0
suffix:semicolon
r_return
op_minus
id|EACCES
suffix:semicolon
)brace
multiline_comment|/*&n; * Returns an nfs4_state + an extra reference to the inode&n; */
DECL|function|_nfs4_open_delegated
r_static
r_int
id|_nfs4_open_delegated
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_int
id|flags
comma
r_struct
id|rpc_cred
op_star
id|cred
comma
r_struct
id|nfs4_state
op_star
op_star
id|res
)paren
(brace
r_struct
id|nfs_delegation
op_star
id|delegation
suffix:semicolon
r_struct
id|nfs_server
op_star
id|server
op_assign
id|NFS_SERVER
c_func
(paren
id|inode
)paren
suffix:semicolon
r_struct
id|nfs4_client
op_star
id|clp
op_assign
id|server-&gt;nfs4_state
suffix:semicolon
r_struct
id|nfs_inode
op_star
id|nfsi
op_assign
id|NFS_I
c_func
(paren
id|inode
)paren
suffix:semicolon
r_struct
id|nfs4_state_owner
op_star
id|sp
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|nfs4_state
op_star
id|state
op_assign
l_int|NULL
suffix:semicolon
r_int
id|open_flags
op_assign
id|flags
op_amp
(paren
id|FMODE_READ
op_or
id|FMODE_WRITE
)paren
suffix:semicolon
r_int
id|err
suffix:semicolon
multiline_comment|/* Protect against reboot recovery - NOTE ORDER! */
id|down_read
c_func
(paren
op_amp
id|clp-&gt;cl_sem
)paren
suffix:semicolon
multiline_comment|/* Protect against delegation recall */
id|down_read
c_func
(paren
op_amp
id|nfsi-&gt;rwsem
)paren
suffix:semicolon
id|delegation
op_assign
id|NFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|delegation
suffix:semicolon
id|err
op_assign
op_minus
id|ENOENT
suffix:semicolon
r_if
c_cond
(paren
id|delegation
op_eq
l_int|NULL
op_logical_or
(paren
id|delegation-&gt;type
op_amp
id|open_flags
)paren
op_ne
id|open_flags
)paren
r_goto
id|out_err
suffix:semicolon
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|sp
op_assign
id|nfs4_get_state_owner
c_func
(paren
id|server
comma
id|cred
)paren
)paren
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;%s: nfs4_get_state_owner failed!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_goto
id|out_err
suffix:semicolon
)brace
id|down
c_func
(paren
op_amp
id|sp-&gt;so_sema
)paren
suffix:semicolon
id|state
op_assign
id|nfs4_get_open_state
c_func
(paren
id|inode
comma
id|sp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|state
op_eq
l_int|NULL
)paren
r_goto
id|out_err
suffix:semicolon
id|err
op_assign
op_minus
id|ENOENT
suffix:semicolon
r_if
c_cond
(paren
(paren
id|state-&gt;state
op_amp
id|open_flags
)paren
op_eq
id|open_flags
)paren
(brace
id|spin_lock
c_func
(paren
op_amp
id|inode-&gt;i_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|open_flags
op_amp
id|FMODE_READ
)paren
id|state-&gt;nreaders
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|open_flags
op_amp
id|FMODE_WRITE
)paren
id|state-&gt;nwriters
op_increment
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|inode-&gt;i_lock
)paren
suffix:semicolon
r_goto
id|out_ok
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|state-&gt;state
op_ne
l_int|0
)paren
r_goto
id|out_err
suffix:semicolon
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
id|err
op_assign
id|_nfs4_do_access
c_func
(paren
id|inode
comma
id|cred
comma
id|open_flags
)paren
suffix:semicolon
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_ne
l_int|0
)paren
r_goto
id|out_err
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|inode-&gt;i_lock
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|state-&gt;stateid.data
comma
id|delegation-&gt;stateid.data
comma
r_sizeof
(paren
id|state-&gt;stateid.data
)paren
)paren
suffix:semicolon
id|state-&gt;state
op_or_assign
id|open_flags
suffix:semicolon
r_if
c_cond
(paren
id|open_flags
op_amp
id|FMODE_READ
)paren
id|state-&gt;nreaders
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|open_flags
op_amp
id|FMODE_WRITE
)paren
id|state-&gt;nwriters
op_increment
suffix:semicolon
id|set_bit
c_func
(paren
id|NFS_DELEGATED_STATE
comma
op_amp
id|state-&gt;flags
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|inode-&gt;i_lock
)paren
suffix:semicolon
id|out_ok
suffix:colon
id|up
c_func
(paren
op_amp
id|sp-&gt;so_sema
)paren
suffix:semicolon
id|nfs4_put_state_owner
c_func
(paren
id|sp
)paren
suffix:semicolon
id|up_read
c_func
(paren
op_amp
id|nfsi-&gt;rwsem
)paren
suffix:semicolon
id|up_read
c_func
(paren
op_amp
id|clp-&gt;cl_sem
)paren
suffix:semicolon
id|igrab
c_func
(paren
id|inode
)paren
suffix:semicolon
op_star
id|res
op_assign
id|state
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|out_err
suffix:colon
r_if
c_cond
(paren
id|sp
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|state
op_ne
l_int|NULL
)paren
id|nfs4_put_open_state
c_func
(paren
id|state
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|sp-&gt;so_sema
)paren
suffix:semicolon
id|nfs4_put_state_owner
c_func
(paren
id|sp
)paren
suffix:semicolon
)brace
id|up_read
c_func
(paren
op_amp
id|nfsi-&gt;rwsem
)paren
suffix:semicolon
id|up_read
c_func
(paren
op_amp
id|clp-&gt;cl_sem
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|nfs4_open_delegated
r_static
r_struct
id|nfs4_state
op_star
id|nfs4_open_delegated
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_int
id|flags
comma
r_struct
id|rpc_cred
op_star
id|cred
)paren
(brace
r_struct
id|nfs4_exception
id|exception
op_assign
(brace
)brace
suffix:semicolon
r_struct
id|nfs4_state
op_star
id|res
suffix:semicolon
r_int
id|err
suffix:semicolon
r_do
(brace
id|err
op_assign
id|_nfs4_open_delegated
c_func
(paren
id|inode
comma
id|flags
comma
id|cred
comma
op_amp
id|res
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_eq
l_int|0
)paren
r_break
suffix:semicolon
id|res
op_assign
id|ERR_PTR
c_func
(paren
id|nfs4_handle_exception
c_func
(paren
id|NFS_SERVER
c_func
(paren
id|inode
)paren
comma
id|err
comma
op_amp
id|exception
)paren
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|exception.retry
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
multiline_comment|/*&n; * Returns an nfs4_state + an referenced inode&n; */
DECL|function|_nfs4_do_open
r_static
r_int
id|_nfs4_do_open
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|dentry
op_star
id|dentry
comma
r_int
id|flags
comma
r_struct
id|iattr
op_star
id|sattr
comma
r_struct
id|rpc_cred
op_star
id|cred
comma
r_struct
id|nfs4_state
op_star
op_star
id|res
)paren
(brace
r_struct
id|nfs4_state_owner
op_star
id|sp
suffix:semicolon
r_struct
id|nfs4_state
op_star
id|state
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|nfs_server
op_star
id|server
op_assign
id|NFS_SERVER
c_func
(paren
id|dir
)paren
suffix:semicolon
r_struct
id|nfs4_client
op_star
id|clp
op_assign
id|server-&gt;nfs4_state
suffix:semicolon
r_struct
id|inode
op_star
id|inode
op_assign
l_int|NULL
suffix:semicolon
r_int
id|status
suffix:semicolon
r_struct
id|nfs_fattr
id|f_attr
op_assign
(brace
dot
id|valid
op_assign
l_int|0
comma
)brace
suffix:semicolon
r_struct
id|nfs_openargs
id|o_arg
op_assign
(brace
dot
id|fh
op_assign
id|NFS_FH
c_func
(paren
id|dir
)paren
comma
dot
id|open_flags
op_assign
id|flags
comma
dot
id|name
op_assign
op_amp
id|dentry-&gt;d_name
comma
dot
id|server
op_assign
id|server
comma
dot
id|bitmask
op_assign
id|server-&gt;attr_bitmask
comma
dot
id|claim
op_assign
id|NFS4_OPEN_CLAIM_NULL
comma
)brace
suffix:semicolon
r_struct
id|nfs_openres
id|o_res
op_assign
(brace
dot
id|f_attr
op_assign
op_amp
id|f_attr
comma
dot
id|server
op_assign
id|server
comma
)brace
suffix:semicolon
r_struct
id|rpc_message
id|msg
op_assign
(brace
dot
id|rpc_proc
op_assign
op_amp
id|nfs4_procedures
(braket
id|NFSPROC4_CLNT_OPEN
)braket
comma
dot
id|rpc_argp
op_assign
op_amp
id|o_arg
comma
dot
id|rpc_resp
op_assign
op_amp
id|o_res
comma
dot
id|rpc_cred
op_assign
id|cred
comma
)brace
suffix:semicolon
multiline_comment|/* Protect against reboot recovery conflicts */
id|down_read
c_func
(paren
op_amp
id|clp-&gt;cl_sem
)paren
suffix:semicolon
id|status
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|sp
op_assign
id|nfs4_get_state_owner
c_func
(paren
id|server
comma
id|cred
)paren
)paren
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;nfs4_do_open: nfs4_get_state_owner failed!&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out_err
suffix:semicolon
)brace
r_if
c_cond
(paren
id|flags
op_amp
id|O_EXCL
)paren
(brace
id|u32
op_star
id|p
op_assign
(paren
id|u32
op_star
)paren
id|o_arg.u.verifier.data
suffix:semicolon
id|p
(braket
l_int|0
)braket
op_assign
id|jiffies
suffix:semicolon
id|p
(braket
l_int|1
)braket
op_assign
id|current-&gt;pid
suffix:semicolon
)brace
r_else
id|o_arg.u.attrs
op_assign
id|sattr
suffix:semicolon
multiline_comment|/* Serialization for the sequence id */
id|down
c_func
(paren
op_amp
id|sp-&gt;so_sema
)paren
suffix:semicolon
id|o_arg.seqid
op_assign
id|sp-&gt;so_seqid
suffix:semicolon
id|o_arg.id
op_assign
id|sp-&gt;so_id
suffix:semicolon
id|o_arg.clientid
op_assign
id|clp-&gt;cl_clientid
comma
id|status
op_assign
id|rpc_call_sync
c_func
(paren
id|server-&gt;client
comma
op_amp
id|msg
comma
id|RPC_TASK_NOINTR
)paren
suffix:semicolon
id|nfs4_increment_seqid
c_func
(paren
id|status
comma
id|sp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
r_goto
id|out_err
suffix:semicolon
id|update_changeattr
c_func
(paren
id|dir
comma
op_amp
id|o_res.cinfo
)paren
suffix:semicolon
r_if
c_cond
(paren
id|o_res.rflags
op_amp
id|NFS4_OPEN_RESULT_CONFIRM
)paren
(brace
id|status
op_assign
id|_nfs4_proc_open_confirm
c_func
(paren
id|server-&gt;client
comma
op_amp
id|o_res.fh
comma
id|sp
comma
op_amp
id|o_res.stateid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_ne
l_int|0
)paren
r_goto
id|out_err
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|f_attr.valid
op_amp
id|NFS_ATTR_FATTR
)paren
)paren
(brace
id|status
op_assign
id|server-&gt;rpc_ops
op_member_access_from_pointer
id|getattr
c_func
(paren
id|server
comma
op_amp
id|o_res.fh
comma
op_amp
id|f_attr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
OL
l_int|0
)paren
r_goto
id|out_err
suffix:semicolon
)brace
id|status
op_assign
op_minus
id|ENOMEM
suffix:semicolon
id|inode
op_assign
id|nfs_fhget
c_func
(paren
id|dir-&gt;i_sb
comma
op_amp
id|o_res.fh
comma
op_amp
id|f_attr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|inode
)paren
r_goto
id|out_err
suffix:semicolon
id|state
op_assign
id|nfs4_get_open_state
c_func
(paren
id|inode
comma
id|sp
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|state
)paren
r_goto
id|out_err
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|state-&gt;stateid
comma
op_amp
id|o_res.stateid
comma
r_sizeof
(paren
id|state-&gt;stateid
)paren
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|inode-&gt;i_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
id|FMODE_READ
)paren
id|state-&gt;nreaders
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
id|FMODE_WRITE
)paren
id|state-&gt;nwriters
op_increment
suffix:semicolon
id|state-&gt;state
op_or_assign
id|flags
op_amp
(paren
id|FMODE_READ
op_or
id|FMODE_WRITE
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|inode-&gt;i_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|o_res.delegation_type
op_ne
l_int|0
)paren
id|nfs_inode_set_delegation
c_func
(paren
id|inode
comma
id|cred
comma
op_amp
id|o_res
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|sp-&gt;so_sema
)paren
suffix:semicolon
id|nfs4_put_state_owner
c_func
(paren
id|sp
)paren
suffix:semicolon
id|up_read
c_func
(paren
op_amp
id|clp-&gt;cl_sem
)paren
suffix:semicolon
op_star
id|res
op_assign
id|state
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|out_err
suffix:colon
r_if
c_cond
(paren
id|sp
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|state
op_ne
l_int|NULL
)paren
id|nfs4_put_open_state
c_func
(paren
id|state
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|sp-&gt;so_sema
)paren
suffix:semicolon
id|nfs4_put_state_owner
c_func
(paren
id|sp
)paren
suffix:semicolon
)brace
multiline_comment|/* Note: clp-&gt;cl_sem must be released before nfs4_put_open_state()! */
id|up_read
c_func
(paren
op_amp
id|clp-&gt;cl_sem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inode
op_ne
l_int|NULL
)paren
id|iput
c_func
(paren
id|inode
)paren
suffix:semicolon
op_star
id|res
op_assign
l_int|NULL
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
DECL|function|nfs4_do_open
r_static
r_struct
id|nfs4_state
op_star
id|nfs4_do_open
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|dentry
op_star
id|dentry
comma
r_int
id|flags
comma
r_struct
id|iattr
op_star
id|sattr
comma
r_struct
id|rpc_cred
op_star
id|cred
)paren
(brace
r_struct
id|nfs4_exception
id|exception
op_assign
(brace
)brace
suffix:semicolon
r_struct
id|nfs4_state
op_star
id|res
suffix:semicolon
r_int
id|status
suffix:semicolon
r_do
(brace
id|status
op_assign
id|_nfs4_do_open
c_func
(paren
id|dir
comma
id|dentry
comma
id|flags
comma
id|sattr
comma
id|cred
comma
op_amp
id|res
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_eq
l_int|0
)paren
r_break
suffix:semicolon
multiline_comment|/* NOTE: BAD_SEQID means the server and client disagree about the&n;&t;&t; * book-keeping w.r.t. state-changing operations&n;&t;&t; * (OPEN/CLOSE/LOCK/LOCKU...)&n;&t;&t; * It is actually a sign of a bug on the client or on the server.&n;&t;&t; *&n;&t;&t; * If we receive a BAD_SEQID error in the particular case of&n;&t;&t; * doing an OPEN, we assume that nfs4_increment_seqid() will&n;&t;&t; * have unhashed the old state_owner for us, and that we can&n;&t;&t; * therefore safely retry using a new one. We should still warn&n;&t;&t; * the user though...&n;&t;&t; */
r_if
c_cond
(paren
id|status
op_eq
op_minus
id|NFS4ERR_BAD_SEQID
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;NFS: v4 server returned a bad sequence-id error!&bslash;n&quot;
)paren
suffix:semicolon
id|exception.retry
op_assign
l_int|1
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|res
op_assign
id|ERR_PTR
c_func
(paren
id|nfs4_handle_exception
c_func
(paren
id|NFS_SERVER
c_func
(paren
id|dir
)paren
comma
id|status
comma
op_amp
id|exception
)paren
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|exception.retry
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
DECL|function|_nfs4_do_setattr
r_static
r_int
id|_nfs4_do_setattr
c_func
(paren
r_struct
id|nfs_server
op_star
id|server
comma
r_struct
id|nfs_fattr
op_star
id|fattr
comma
r_struct
id|nfs_fh
op_star
id|fhandle
comma
r_struct
id|iattr
op_star
id|sattr
comma
r_struct
id|nfs4_state
op_star
id|state
)paren
(brace
r_struct
id|nfs_setattrargs
id|arg
op_assign
(brace
dot
id|fh
op_assign
id|fhandle
comma
dot
id|iap
op_assign
id|sattr
comma
dot
id|server
op_assign
id|server
comma
dot
id|bitmask
op_assign
id|server-&gt;attr_bitmask
comma
)brace
suffix:semicolon
r_struct
id|nfs_setattrres
id|res
op_assign
(brace
dot
id|fattr
op_assign
id|fattr
comma
dot
id|server
op_assign
id|server
comma
)brace
suffix:semicolon
r_struct
id|rpc_message
id|msg
op_assign
(brace
dot
id|rpc_proc
op_assign
op_amp
id|nfs4_procedures
(braket
id|NFSPROC4_CLNT_SETATTR
)braket
comma
dot
id|rpc_argp
op_assign
op_amp
id|arg
comma
dot
id|rpc_resp
op_assign
op_amp
id|res
comma
)brace
suffix:semicolon
id|fattr-&gt;valid
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|state
op_ne
l_int|NULL
)paren
id|msg.rpc_cred
op_assign
id|state-&gt;owner-&gt;so_cred
suffix:semicolon
r_if
c_cond
(paren
id|sattr-&gt;ia_valid
op_amp
id|ATTR_SIZE
)paren
id|nfs4_copy_stateid
c_func
(paren
op_amp
id|arg.stateid
comma
id|state
comma
l_int|NULL
)paren
suffix:semicolon
r_else
id|memcpy
c_func
(paren
op_amp
id|arg.stateid
comma
op_amp
id|zero_stateid
comma
r_sizeof
(paren
id|arg.stateid
)paren
)paren
suffix:semicolon
r_return
id|rpc_call_sync
c_func
(paren
id|server-&gt;client
comma
op_amp
id|msg
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|nfs4_do_setattr
r_static
r_int
id|nfs4_do_setattr
c_func
(paren
r_struct
id|nfs_server
op_star
id|server
comma
r_struct
id|nfs_fattr
op_star
id|fattr
comma
r_struct
id|nfs_fh
op_star
id|fhandle
comma
r_struct
id|iattr
op_star
id|sattr
comma
r_struct
id|nfs4_state
op_star
id|state
)paren
(brace
r_struct
id|nfs4_exception
id|exception
op_assign
(brace
)brace
suffix:semicolon
r_int
id|err
suffix:semicolon
r_do
(brace
id|err
op_assign
id|nfs4_handle_exception
c_func
(paren
id|server
comma
id|_nfs4_do_setattr
c_func
(paren
id|server
comma
id|fattr
comma
id|fhandle
comma
id|sattr
comma
id|state
)paren
comma
op_amp
id|exception
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|exception.retry
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|struct|nfs4_closedata
r_struct
id|nfs4_closedata
(brace
DECL|member|inode
r_struct
id|inode
op_star
id|inode
suffix:semicolon
DECL|member|state
r_struct
id|nfs4_state
op_star
id|state
suffix:semicolon
DECL|member|arg
r_struct
id|nfs_closeargs
id|arg
suffix:semicolon
DECL|member|res
r_struct
id|nfs_closeres
id|res
suffix:semicolon
)brace
suffix:semicolon
DECL|function|nfs4_close_done
r_static
r_void
id|nfs4_close_done
c_func
(paren
r_struct
id|rpc_task
op_star
id|task
)paren
(brace
r_struct
id|nfs4_closedata
op_star
id|calldata
op_assign
(paren
r_struct
id|nfs4_closedata
op_star
)paren
id|task-&gt;tk_calldata
suffix:semicolon
r_struct
id|nfs4_state
op_star
id|state
op_assign
id|calldata-&gt;state
suffix:semicolon
r_struct
id|nfs4_state_owner
op_star
id|sp
op_assign
id|state-&gt;owner
suffix:semicolon
r_struct
id|nfs_server
op_star
id|server
op_assign
id|NFS_SERVER
c_func
(paren
id|calldata-&gt;inode
)paren
suffix:semicolon
multiline_comment|/* hmm. we are done with the inode, and in the process of freeing&n;&t; * the state_owner. we keep this around to process errors&n;&t; */
id|nfs4_increment_seqid
c_func
(paren
id|task-&gt;tk_status
comma
id|sp
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|task-&gt;tk_status
)paren
(brace
r_case
l_int|0
suffix:colon
id|memcpy
c_func
(paren
op_amp
id|state-&gt;stateid
comma
op_amp
id|calldata-&gt;res.stateid
comma
r_sizeof
(paren
id|state-&gt;stateid
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
op_minus
id|NFS4ERR_STALE_STATEID
suffix:colon
r_case
op_minus
id|NFS4ERR_EXPIRED
suffix:colon
id|state-&gt;state
op_assign
id|calldata-&gt;arg.open_flags
suffix:semicolon
id|nfs4_schedule_state_recovery
c_func
(paren
id|server-&gt;nfs4_state
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
r_if
c_cond
(paren
id|nfs4_async_handle_error
c_func
(paren
id|task
comma
id|server
)paren
op_eq
op_minus
id|EAGAIN
)paren
(brace
id|rpc_restart_call
c_func
(paren
id|task
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
id|state-&gt;state
op_assign
id|calldata-&gt;arg.open_flags
suffix:semicolon
id|nfs4_put_open_state
c_func
(paren
id|state
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|sp-&gt;so_sema
)paren
suffix:semicolon
id|nfs4_put_state_owner
c_func
(paren
id|sp
)paren
suffix:semicolon
id|up_read
c_func
(paren
op_amp
id|server-&gt;nfs4_state-&gt;cl_sem
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|calldata
)paren
suffix:semicolon
)brace
DECL|function|nfs4_close_call
r_static
r_inline
r_int
id|nfs4_close_call
c_func
(paren
r_struct
id|rpc_clnt
op_star
id|clnt
comma
r_struct
id|nfs4_closedata
op_star
id|calldata
)paren
(brace
r_struct
id|rpc_message
id|msg
op_assign
(brace
dot
id|rpc_proc
op_assign
op_amp
id|nfs4_procedures
(braket
id|NFSPROC4_CLNT_CLOSE
)braket
comma
dot
id|rpc_argp
op_assign
op_amp
id|calldata-&gt;arg
comma
dot
id|rpc_resp
op_assign
op_amp
id|calldata-&gt;res
comma
dot
id|rpc_cred
op_assign
id|calldata-&gt;state-&gt;owner-&gt;so_cred
comma
)brace
suffix:semicolon
r_if
c_cond
(paren
id|calldata-&gt;arg.open_flags
op_ne
l_int|0
)paren
id|msg.rpc_proc
op_assign
op_amp
id|nfs4_procedures
(braket
id|NFSPROC4_CLNT_OPEN_DOWNGRADE
)braket
suffix:semicolon
r_return
id|rpc_call_async
c_func
(paren
id|clnt
comma
op_amp
id|msg
comma
l_int|0
comma
id|nfs4_close_done
comma
id|calldata
)paren
suffix:semicolon
)brace
multiline_comment|/* &n; * It is possible for data to be read/written from a mem-mapped file &n; * after the sys_close call (which hits the vfs layer as a flush).&n; * This means that we can&squot;t safely call nfsv4 close on a file until &n; * the inode is cleared. This in turn means that we are not good&n; * NFSv4 citizens - we do not indicate to the server to update the file&squot;s &n; * share state even when we are done with one of the three share &n; * stateid&squot;s in the inode.&n; *&n; * NOTE: Caller must be holding the sp-&gt;so_owner semaphore!&n; */
DECL|function|nfs4_do_close
r_int
id|nfs4_do_close
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|nfs4_state
op_star
id|state
comma
id|mode_t
id|mode
)paren
(brace
r_struct
id|nfs4_closedata
op_star
id|calldata
suffix:semicolon
r_int
id|status
suffix:semicolon
multiline_comment|/* Tell caller we&squot;re done */
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|NFS_DELEGATED_STATE
comma
op_amp
id|state-&gt;flags
)paren
)paren
(brace
id|state-&gt;state
op_assign
id|mode
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|calldata
op_assign
(paren
r_struct
id|nfs4_closedata
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|calldata
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|calldata
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|calldata-&gt;inode
op_assign
id|inode
suffix:semicolon
id|calldata-&gt;state
op_assign
id|state
suffix:semicolon
id|calldata-&gt;arg.fh
op_assign
id|NFS_FH
c_func
(paren
id|inode
)paren
suffix:semicolon
multiline_comment|/* Serialization for the sequence id */
id|calldata-&gt;arg.seqid
op_assign
id|state-&gt;owner-&gt;so_seqid
suffix:semicolon
id|calldata-&gt;arg.open_flags
op_assign
id|mode
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|calldata-&gt;arg.stateid
comma
op_amp
id|state-&gt;stateid
comma
r_sizeof
(paren
id|calldata-&gt;arg.stateid
)paren
)paren
suffix:semicolon
id|status
op_assign
id|nfs4_close_call
c_func
(paren
id|NFS_SERVER
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|client
comma
id|calldata
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Return -EINPROGRESS on success in order to indicate to the&n;&t; * caller that an asynchronous RPC call has been launched, and&n;&t; * that it will release the semaphores on completion.&n;&t; */
r_return
(paren
id|status
op_eq
l_int|0
)paren
ques
c_cond
op_minus
id|EINPROGRESS
suffix:colon
id|status
suffix:semicolon
)brace
r_struct
id|inode
op_star
DECL|function|nfs4_atomic_open
id|nfs4_atomic_open
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|dentry
op_star
id|dentry
comma
r_struct
id|nameidata
op_star
id|nd
)paren
(brace
r_struct
id|iattr
id|attr
suffix:semicolon
r_struct
id|rpc_cred
op_star
id|cred
suffix:semicolon
r_struct
id|nfs4_state
op_star
id|state
suffix:semicolon
r_if
c_cond
(paren
id|nd-&gt;flags
op_amp
id|LOOKUP_CREATE
)paren
(brace
id|attr.ia_mode
op_assign
id|nd-&gt;intent.open.create_mode
suffix:semicolon
id|attr.ia_valid
op_assign
id|ATTR_MODE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|IS_POSIXACL
c_func
(paren
id|dir
)paren
)paren
id|attr.ia_mode
op_and_assign
op_complement
id|current-&gt;fs-&gt;umask
suffix:semicolon
)brace
r_else
(brace
id|attr.ia_valid
op_assign
l_int|0
suffix:semicolon
id|BUG_ON
c_func
(paren
id|nd-&gt;intent.open.flags
op_amp
id|O_CREAT
)paren
suffix:semicolon
)brace
id|cred
op_assign
id|rpcauth_lookupcred
c_func
(paren
id|NFS_SERVER
c_func
(paren
id|dir
)paren
op_member_access_from_pointer
id|client-&gt;cl_auth
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|cred
)paren
)paren
r_return
(paren
r_struct
id|inode
op_star
)paren
id|cred
suffix:semicolon
id|state
op_assign
id|nfs4_do_open
c_func
(paren
id|dir
comma
id|dentry
comma
id|nd-&gt;intent.open.flags
comma
op_amp
id|attr
comma
id|cred
)paren
suffix:semicolon
id|put_rpccred
c_func
(paren
id|cred
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|state
)paren
)paren
r_return
(paren
r_struct
id|inode
op_star
)paren
id|state
suffix:semicolon
r_return
id|state-&gt;inode
suffix:semicolon
)brace
r_int
DECL|function|nfs4_open_revalidate
id|nfs4_open_revalidate
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|dentry
op_star
id|dentry
comma
r_int
id|openflags
)paren
(brace
r_struct
id|rpc_cred
op_star
id|cred
suffix:semicolon
r_struct
id|nfs4_state
op_star
id|state
suffix:semicolon
r_struct
id|inode
op_star
id|inode
suffix:semicolon
id|cred
op_assign
id|rpcauth_lookupcred
c_func
(paren
id|NFS_SERVER
c_func
(paren
id|dir
)paren
op_member_access_from_pointer
id|client-&gt;cl_auth
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|cred
)paren
)paren
r_return
id|PTR_ERR
c_func
(paren
id|cred
)paren
suffix:semicolon
id|state
op_assign
id|nfs4_open_delegated
c_func
(paren
id|dentry-&gt;d_inode
comma
id|openflags
comma
id|cred
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|state
)paren
)paren
id|state
op_assign
id|nfs4_do_open
c_func
(paren
id|dir
comma
id|dentry
comma
id|openflags
comma
l_int|NULL
comma
id|cred
)paren
suffix:semicolon
id|put_rpccred
c_func
(paren
id|cred
)paren
suffix:semicolon
r_if
c_cond
(paren
id|state
op_eq
id|ERR_PTR
c_func
(paren
op_minus
id|ENOENT
)paren
op_logical_and
id|dentry-&gt;d_inode
op_eq
l_int|0
)paren
r_return
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|state
)paren
)paren
r_return
l_int|0
suffix:semicolon
id|inode
op_assign
id|state-&gt;inode
suffix:semicolon
r_if
c_cond
(paren
id|inode
op_eq
id|dentry-&gt;d_inode
)paren
(brace
id|iput
c_func
(paren
id|inode
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|d_drop
c_func
(paren
id|dentry
)paren
suffix:semicolon
id|nfs4_close_state
c_func
(paren
id|state
comma
id|openflags
)paren
suffix:semicolon
id|iput
c_func
(paren
id|inode
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|_nfs4_server_capabilities
r_static
r_int
id|_nfs4_server_capabilities
c_func
(paren
r_struct
id|nfs_server
op_star
id|server
comma
r_struct
id|nfs_fh
op_star
id|fhandle
)paren
(brace
r_struct
id|nfs4_server_caps_res
id|res
op_assign
(brace
)brace
suffix:semicolon
r_struct
id|rpc_message
id|msg
op_assign
(brace
dot
id|rpc_proc
op_assign
op_amp
id|nfs4_procedures
(braket
id|NFSPROC4_CLNT_SERVER_CAPS
)braket
comma
dot
id|rpc_argp
op_assign
id|fhandle
comma
dot
id|rpc_resp
op_assign
op_amp
id|res
comma
)brace
suffix:semicolon
r_int
id|status
suffix:semicolon
id|status
op_assign
id|rpc_call_sync
c_func
(paren
id|server-&gt;client
comma
op_amp
id|msg
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_eq
l_int|0
)paren
(brace
id|memcpy
c_func
(paren
id|server-&gt;attr_bitmask
comma
id|res.attr_bitmask
comma
r_sizeof
(paren
id|server-&gt;attr_bitmask
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res.attr_bitmask
(braket
l_int|0
)braket
op_amp
id|FATTR4_WORD0_ACL
)paren
id|server-&gt;caps
op_or_assign
id|NFS_CAP_ACLS
suffix:semicolon
r_if
c_cond
(paren
id|res.has_links
op_ne
l_int|0
)paren
id|server-&gt;caps
op_or_assign
id|NFS_CAP_HARDLINKS
suffix:semicolon
r_if
c_cond
(paren
id|res.has_symlinks
op_ne
l_int|0
)paren
id|server-&gt;caps
op_or_assign
id|NFS_CAP_SYMLINKS
suffix:semicolon
id|server-&gt;acl_bitmask
op_assign
id|res.acl_bitmask
suffix:semicolon
)brace
r_return
id|status
suffix:semicolon
)brace
DECL|function|nfs4_server_capabilities
r_static
r_int
id|nfs4_server_capabilities
c_func
(paren
r_struct
id|nfs_server
op_star
id|server
comma
r_struct
id|nfs_fh
op_star
id|fhandle
)paren
(brace
r_struct
id|nfs4_exception
id|exception
op_assign
(brace
)brace
suffix:semicolon
r_int
id|err
suffix:semicolon
r_do
(brace
id|err
op_assign
id|nfs4_handle_exception
c_func
(paren
id|server
comma
id|_nfs4_server_capabilities
c_func
(paren
id|server
comma
id|fhandle
)paren
comma
op_amp
id|exception
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|exception.retry
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|_nfs4_lookup_root
r_static
r_int
id|_nfs4_lookup_root
c_func
(paren
r_struct
id|nfs_server
op_star
id|server
comma
r_struct
id|nfs_fh
op_star
id|fhandle
comma
r_struct
id|nfs_fsinfo
op_star
id|info
)paren
(brace
r_struct
id|nfs_fattr
op_star
id|fattr
op_assign
id|info-&gt;fattr
suffix:semicolon
r_struct
id|nfs4_lookup_root_arg
id|args
op_assign
(brace
dot
id|bitmask
op_assign
id|nfs4_fattr_bitmap
comma
)brace
suffix:semicolon
r_struct
id|nfs4_lookup_res
id|res
op_assign
(brace
dot
id|server
op_assign
id|server
comma
dot
id|fattr
op_assign
id|fattr
comma
dot
id|fh
op_assign
id|fhandle
comma
)brace
suffix:semicolon
r_struct
id|rpc_message
id|msg
op_assign
(brace
dot
id|rpc_proc
op_assign
op_amp
id|nfs4_procedures
(braket
id|NFSPROC4_CLNT_LOOKUP_ROOT
)braket
comma
dot
id|rpc_argp
op_assign
op_amp
id|args
comma
dot
id|rpc_resp
op_assign
op_amp
id|res
comma
)brace
suffix:semicolon
id|fattr-&gt;valid
op_assign
l_int|0
suffix:semicolon
r_return
id|rpc_call_sync
c_func
(paren
id|server-&gt;client
comma
op_amp
id|msg
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|nfs4_lookup_root
r_static
r_int
id|nfs4_lookup_root
c_func
(paren
r_struct
id|nfs_server
op_star
id|server
comma
r_struct
id|nfs_fh
op_star
id|fhandle
comma
r_struct
id|nfs_fsinfo
op_star
id|info
)paren
(brace
r_struct
id|nfs4_exception
id|exception
op_assign
(brace
)brace
suffix:semicolon
r_int
id|err
suffix:semicolon
r_do
(brace
id|err
op_assign
id|nfs4_handle_exception
c_func
(paren
id|server
comma
id|_nfs4_lookup_root
c_func
(paren
id|server
comma
id|fhandle
comma
id|info
)paren
comma
op_amp
id|exception
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|exception.retry
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|nfs4_proc_get_root
r_static
r_int
id|nfs4_proc_get_root
c_func
(paren
r_struct
id|nfs_server
op_star
id|server
comma
r_struct
id|nfs_fh
op_star
id|fhandle
comma
r_struct
id|nfs_fsinfo
op_star
id|info
)paren
(brace
r_struct
id|nfs_fattr
op_star
id|fattr
op_assign
id|info-&gt;fattr
suffix:semicolon
r_int
r_char
op_star
id|p
suffix:semicolon
r_struct
id|qstr
id|q
suffix:semicolon
r_struct
id|nfs4_lookup_arg
id|args
op_assign
(brace
dot
id|dir_fh
op_assign
id|fhandle
comma
dot
id|name
op_assign
op_amp
id|q
comma
dot
id|bitmask
op_assign
id|nfs4_fattr_bitmap
comma
)brace
suffix:semicolon
r_struct
id|nfs4_lookup_res
id|res
op_assign
(brace
dot
id|server
op_assign
id|server
comma
dot
id|fattr
op_assign
id|fattr
comma
dot
id|fh
op_assign
id|fhandle
comma
)brace
suffix:semicolon
r_struct
id|rpc_message
id|msg
op_assign
(brace
dot
id|rpc_proc
op_assign
op_amp
id|nfs4_procedures
(braket
id|NFSPROC4_CLNT_LOOKUP
)braket
comma
dot
id|rpc_argp
op_assign
op_amp
id|args
comma
dot
id|rpc_resp
op_assign
op_amp
id|res
comma
)brace
suffix:semicolon
r_int
id|status
suffix:semicolon
multiline_comment|/*&n;&t; * Now we do a separate LOOKUP for each component of the mount path.&n;&t; * The LOOKUPs are done separately so that we can conveniently&n;&t; * catch an ERR_WRONGSEC if it occurs along the way...&n;&t; */
id|status
op_assign
id|nfs4_lookup_root
c_func
(paren
id|server
comma
id|fhandle
comma
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
r_goto
id|out
suffix:semicolon
id|p
op_assign
id|server-&gt;mnt_path
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
r_struct
id|nfs4_exception
id|exception
op_assign
(brace
)brace
suffix:semicolon
r_while
c_loop
(paren
op_star
id|p
op_eq
l_char|&squot;/&squot;
)paren
id|p
op_increment
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
op_star
id|p
)paren
r_break
suffix:semicolon
id|q.name
op_assign
id|p
suffix:semicolon
r_while
c_loop
(paren
op_star
id|p
op_logical_and
(paren
op_star
id|p
op_ne
l_char|&squot;/&squot;
)paren
)paren
id|p
op_increment
suffix:semicolon
id|q.len
op_assign
id|p
op_minus
id|q.name
suffix:semicolon
r_do
(brace
id|fattr-&gt;valid
op_assign
l_int|0
suffix:semicolon
id|status
op_assign
id|nfs4_handle_exception
c_func
(paren
id|server
comma
id|rpc_call_sync
c_func
(paren
id|server-&gt;client
comma
op_amp
id|msg
comma
l_int|0
)paren
comma
op_amp
id|exception
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|exception.retry
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_eq
l_int|0
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|status
op_eq
op_minus
id|ENOENT
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;NFS: mount path %s does not exist!&bslash;n&quot;
comma
id|server-&gt;mnt_path
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;NFS: suggestion: try mounting &squot;/&squot; instead.&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_eq
l_int|0
)paren
id|status
op_assign
id|nfs4_server_capabilities
c_func
(paren
id|server
comma
id|fhandle
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_eq
l_int|0
)paren
id|status
op_assign
id|nfs4_do_fsinfo
c_func
(paren
id|server
comma
id|fhandle
comma
id|info
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|status
suffix:semicolon
)brace
DECL|function|_nfs4_proc_getattr
r_static
r_int
id|_nfs4_proc_getattr
c_func
(paren
r_struct
id|nfs_server
op_star
id|server
comma
r_struct
id|nfs_fh
op_star
id|fhandle
comma
r_struct
id|nfs_fattr
op_star
id|fattr
)paren
(brace
r_struct
id|nfs4_getattr_arg
id|args
op_assign
(brace
dot
id|fh
op_assign
id|fhandle
comma
dot
id|bitmask
op_assign
id|server-&gt;attr_bitmask
comma
)brace
suffix:semicolon
r_struct
id|nfs4_getattr_res
id|res
op_assign
(brace
dot
id|fattr
op_assign
id|fattr
comma
dot
id|server
op_assign
id|server
comma
)brace
suffix:semicolon
r_struct
id|rpc_message
id|msg
op_assign
(brace
dot
id|rpc_proc
op_assign
op_amp
id|nfs4_procedures
(braket
id|NFSPROC4_CLNT_GETATTR
)braket
comma
dot
id|rpc_argp
op_assign
op_amp
id|args
comma
dot
id|rpc_resp
op_assign
op_amp
id|res
comma
)brace
suffix:semicolon
id|fattr-&gt;valid
op_assign
l_int|0
suffix:semicolon
r_return
id|rpc_call_sync
c_func
(paren
id|server-&gt;client
comma
op_amp
id|msg
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|nfs4_proc_getattr
r_static
r_int
id|nfs4_proc_getattr
c_func
(paren
r_struct
id|nfs_server
op_star
id|server
comma
r_struct
id|nfs_fh
op_star
id|fhandle
comma
r_struct
id|nfs_fattr
op_star
id|fattr
)paren
(brace
r_struct
id|nfs4_exception
id|exception
op_assign
(brace
)brace
suffix:semicolon
r_int
id|err
suffix:semicolon
r_do
(brace
id|err
op_assign
id|nfs4_handle_exception
c_func
(paren
id|server
comma
id|_nfs4_proc_getattr
c_func
(paren
id|server
comma
id|fhandle
comma
id|fattr
)paren
comma
op_amp
id|exception
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|exception.retry
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/* &n; * The file is not closed if it is opened due to the a request to change&n; * the size of the file. The open call will not be needed once the&n; * VFS layer lookup-intents are implemented.&n; *&n; * Close is called when the inode is destroyed.&n; * If we haven&squot;t opened the file for O_WRONLY, we&n; * need to in the size_change case to obtain a stateid.&n; *&n; * Got race?&n; * Because OPEN is always done by name in nfsv4, it is&n; * possible that we opened a different file by the same&n; * name.  We can recognize this race condition, but we&n; * can&squot;t do anything about it besides returning an error.&n; *&n; * This will be fixed with VFS changes (lookup-intent).&n; */
r_static
r_int
DECL|function|nfs4_proc_setattr
id|nfs4_proc_setattr
c_func
(paren
r_struct
id|dentry
op_star
id|dentry
comma
r_struct
id|nfs_fattr
op_star
id|fattr
comma
r_struct
id|iattr
op_star
id|sattr
)paren
(brace
r_struct
id|inode
op_star
id|inode
op_assign
id|dentry-&gt;d_inode
suffix:semicolon
r_int
id|size_change
op_assign
id|sattr-&gt;ia_valid
op_amp
id|ATTR_SIZE
suffix:semicolon
r_struct
id|nfs4_state
op_star
id|state
op_assign
l_int|NULL
suffix:semicolon
r_int
id|need_iput
op_assign
l_int|0
suffix:semicolon
r_int
id|status
suffix:semicolon
id|fattr-&gt;valid
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|size_change
)paren
(brace
r_struct
id|rpc_cred
op_star
id|cred
op_assign
id|rpcauth_lookupcred
c_func
(paren
id|NFS_SERVER
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|client-&gt;cl_auth
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|cred
)paren
)paren
r_return
id|PTR_ERR
c_func
(paren
id|cred
)paren
suffix:semicolon
id|state
op_assign
id|nfs4_find_state
c_func
(paren
id|inode
comma
id|cred
comma
id|FMODE_WRITE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|state
op_eq
l_int|NULL
)paren
(brace
id|state
op_assign
id|nfs4_open_delegated
c_func
(paren
id|dentry-&gt;d_inode
comma
id|FMODE_WRITE
comma
id|cred
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|state
)paren
)paren
id|state
op_assign
id|nfs4_do_open
c_func
(paren
id|dentry-&gt;d_parent-&gt;d_inode
comma
id|dentry
comma
id|FMODE_WRITE
comma
l_int|NULL
comma
id|cred
)paren
suffix:semicolon
id|need_iput
op_assign
l_int|1
suffix:semicolon
)brace
id|put_rpccred
c_func
(paren
id|cred
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|state
)paren
)paren
r_return
id|PTR_ERR
c_func
(paren
id|state
)paren
suffix:semicolon
r_if
c_cond
(paren
id|state-&gt;inode
op_ne
id|inode
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;nfs: raced in setattr (%p != %p), returning -EIO&bslash;n&quot;
comma
id|inode
comma
id|state-&gt;inode
)paren
suffix:semicolon
id|status
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
id|status
op_assign
id|nfs4_do_setattr
c_func
(paren
id|NFS_SERVER
c_func
(paren
id|inode
)paren
comma
id|fattr
comma
id|NFS_FH
c_func
(paren
id|inode
)paren
comma
id|sattr
comma
id|state
)paren
suffix:semicolon
id|out
suffix:colon
r_if
c_cond
(paren
id|state
)paren
(brace
id|inode
op_assign
id|state-&gt;inode
suffix:semicolon
id|nfs4_close_state
c_func
(paren
id|state
comma
id|FMODE_WRITE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|need_iput
)paren
id|iput
c_func
(paren
id|inode
)paren
suffix:semicolon
)brace
r_return
id|status
suffix:semicolon
)brace
DECL|function|_nfs4_proc_lookup
r_static
r_int
id|_nfs4_proc_lookup
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|qstr
op_star
id|name
comma
r_struct
id|nfs_fh
op_star
id|fhandle
comma
r_struct
id|nfs_fattr
op_star
id|fattr
)paren
(brace
r_int
id|status
suffix:semicolon
r_struct
id|nfs_server
op_star
id|server
op_assign
id|NFS_SERVER
c_func
(paren
id|dir
)paren
suffix:semicolon
r_struct
id|nfs4_lookup_arg
id|args
op_assign
(brace
dot
id|bitmask
op_assign
id|server-&gt;attr_bitmask
comma
dot
id|dir_fh
op_assign
id|NFS_FH
c_func
(paren
id|dir
)paren
comma
dot
id|name
op_assign
id|name
comma
)brace
suffix:semicolon
r_struct
id|nfs4_lookup_res
id|res
op_assign
(brace
dot
id|server
op_assign
id|server
comma
dot
id|fattr
op_assign
id|fattr
comma
dot
id|fh
op_assign
id|fhandle
comma
)brace
suffix:semicolon
r_struct
id|rpc_message
id|msg
op_assign
(brace
dot
id|rpc_proc
op_assign
op_amp
id|nfs4_procedures
(braket
id|NFSPROC4_CLNT_LOOKUP
)braket
comma
dot
id|rpc_argp
op_assign
op_amp
id|args
comma
dot
id|rpc_resp
op_assign
op_amp
id|res
comma
)brace
suffix:semicolon
id|fattr-&gt;valid
op_assign
l_int|0
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;NFS call  lookup %s&bslash;n&quot;
comma
id|name-&gt;name
)paren
suffix:semicolon
id|status
op_assign
id|rpc_call_sync
c_func
(paren
id|NFS_CLIENT
c_func
(paren
id|dir
)paren
comma
op_amp
id|msg
comma
l_int|0
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;NFS reply lookup: %d&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
DECL|function|nfs4_proc_lookup
r_static
r_int
id|nfs4_proc_lookup
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|qstr
op_star
id|name
comma
r_struct
id|nfs_fh
op_star
id|fhandle
comma
r_struct
id|nfs_fattr
op_star
id|fattr
)paren
(brace
r_struct
id|nfs4_exception
id|exception
op_assign
(brace
)brace
suffix:semicolon
r_int
id|err
suffix:semicolon
r_do
(brace
id|err
op_assign
id|nfs4_handle_exception
c_func
(paren
id|NFS_SERVER
c_func
(paren
id|dir
)paren
comma
id|_nfs4_proc_lookup
c_func
(paren
id|dir
comma
id|name
comma
id|fhandle
comma
id|fattr
)paren
comma
op_amp
id|exception
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|exception.retry
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|_nfs4_proc_access
r_static
r_int
id|_nfs4_proc_access
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|nfs_access_entry
op_star
id|entry
)paren
(brace
r_struct
id|nfs4_accessargs
id|args
op_assign
(brace
dot
id|fh
op_assign
id|NFS_FH
c_func
(paren
id|inode
)paren
comma
)brace
suffix:semicolon
r_struct
id|nfs4_accessres
id|res
op_assign
(brace
l_int|0
)brace
suffix:semicolon
r_struct
id|rpc_message
id|msg
op_assign
(brace
dot
id|rpc_proc
op_assign
op_amp
id|nfs4_procedures
(braket
id|NFSPROC4_CLNT_ACCESS
)braket
comma
dot
id|rpc_argp
op_assign
op_amp
id|args
comma
dot
id|rpc_resp
op_assign
op_amp
id|res
comma
dot
id|rpc_cred
op_assign
id|entry-&gt;cred
comma
)brace
suffix:semicolon
r_int
id|mode
op_assign
id|entry-&gt;mask
suffix:semicolon
r_int
id|status
suffix:semicolon
multiline_comment|/*&n;&t; * Determine which access bits we want to ask for...&n;&t; */
r_if
c_cond
(paren
id|mode
op_amp
id|MAY_READ
)paren
id|args.access
op_or_assign
id|NFS4_ACCESS_READ
suffix:semicolon
r_if
c_cond
(paren
id|S_ISDIR
c_func
(paren
id|inode-&gt;i_mode
)paren
)paren
(brace
r_if
c_cond
(paren
id|mode
op_amp
id|MAY_WRITE
)paren
id|args.access
op_or_assign
id|NFS4_ACCESS_MODIFY
op_or
id|NFS4_ACCESS_EXTEND
op_or
id|NFS4_ACCESS_DELETE
suffix:semicolon
r_if
c_cond
(paren
id|mode
op_amp
id|MAY_EXEC
)paren
id|args.access
op_or_assign
id|NFS4_ACCESS_LOOKUP
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|mode
op_amp
id|MAY_WRITE
)paren
id|args.access
op_or_assign
id|NFS4_ACCESS_MODIFY
op_or
id|NFS4_ACCESS_EXTEND
suffix:semicolon
r_if
c_cond
(paren
id|mode
op_amp
id|MAY_EXEC
)paren
id|args.access
op_or_assign
id|NFS4_ACCESS_EXECUTE
suffix:semicolon
)brace
id|status
op_assign
id|rpc_call_sync
c_func
(paren
id|NFS_CLIENT
c_func
(paren
id|inode
)paren
comma
op_amp
id|msg
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|status
)paren
(brace
id|entry-&gt;mask
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|res.access
op_amp
id|NFS4_ACCESS_READ
)paren
id|entry-&gt;mask
op_or_assign
id|MAY_READ
suffix:semicolon
r_if
c_cond
(paren
id|res.access
op_amp
(paren
id|NFS4_ACCESS_MODIFY
op_or
id|NFS4_ACCESS_EXTEND
op_or
id|NFS4_ACCESS_DELETE
)paren
)paren
id|entry-&gt;mask
op_or_assign
id|MAY_WRITE
suffix:semicolon
r_if
c_cond
(paren
id|res.access
op_amp
(paren
id|NFS4_ACCESS_LOOKUP
op_or
id|NFS4_ACCESS_EXECUTE
)paren
)paren
id|entry-&gt;mask
op_or_assign
id|MAY_EXEC
suffix:semicolon
)brace
r_return
id|status
suffix:semicolon
)brace
DECL|function|nfs4_proc_access
r_static
r_int
id|nfs4_proc_access
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|nfs_access_entry
op_star
id|entry
)paren
(brace
r_struct
id|nfs4_exception
id|exception
op_assign
(brace
)brace
suffix:semicolon
r_int
id|err
suffix:semicolon
r_do
(brace
id|err
op_assign
id|nfs4_handle_exception
c_func
(paren
id|NFS_SERVER
c_func
(paren
id|inode
)paren
comma
id|_nfs4_proc_access
c_func
(paren
id|inode
comma
id|entry
)paren
comma
op_amp
id|exception
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|exception.retry
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*&n; * TODO: For the time being, we don&squot;t try to get any attributes&n; * along with any of the zero-copy operations READ, READDIR,&n; * READLINK, WRITE.&n; *&n; * In the case of the first three, we want to put the GETATTR&n; * after the read-type operation -- this is because it is hard&n; * to predict the length of a GETATTR response in v4, and thus&n; * align the READ data correctly.  This means that the GETATTR&n; * may end up partially falling into the page cache, and we should&n; * shift it into the &squot;tail&squot; of the xdr_buf before processing.&n; * To do this efficiently, we need to know the total length&n; * of data received, which doesn&squot;t seem to be available outside&n; * of the RPC layer.&n; *&n; * In the case of WRITE, we also want to put the GETATTR after&n; * the operation -- in this case because we want to make sure&n; * we get the post-operation mtime and size.  This means that&n; * we can&squot;t use xdr_encode_pages() as written: we need a variant&n; * of it which would leave room in the &squot;tail&squot; iovec.&n; *&n; * Both of these changes to the XDR layer would in fact be quite&n; * minor, but I decided to leave them for a subsequent patch.&n; */
DECL|function|_nfs4_proc_readlink
r_static
r_int
id|_nfs4_proc_readlink
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|page
op_star
id|page
comma
r_int
r_int
id|pgbase
comma
r_int
r_int
id|pglen
)paren
(brace
r_struct
id|nfs4_readlink
id|args
op_assign
(brace
dot
id|fh
op_assign
id|NFS_FH
c_func
(paren
id|inode
)paren
comma
dot
id|pgbase
op_assign
id|pgbase
comma
dot
id|pglen
op_assign
id|pglen
comma
dot
id|pages
op_assign
op_amp
id|page
comma
)brace
suffix:semicolon
r_struct
id|rpc_message
id|msg
op_assign
(brace
dot
id|rpc_proc
op_assign
op_amp
id|nfs4_procedures
(braket
id|NFSPROC4_CLNT_READLINK
)braket
comma
dot
id|rpc_argp
op_assign
op_amp
id|args
comma
dot
id|rpc_resp
op_assign
l_int|NULL
comma
)brace
suffix:semicolon
r_return
id|rpc_call_sync
c_func
(paren
id|NFS_CLIENT
c_func
(paren
id|inode
)paren
comma
op_amp
id|msg
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|nfs4_proc_readlink
r_static
r_int
id|nfs4_proc_readlink
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|page
op_star
id|page
comma
r_int
r_int
id|pgbase
comma
r_int
r_int
id|pglen
)paren
(brace
r_struct
id|nfs4_exception
id|exception
op_assign
(brace
)brace
suffix:semicolon
r_int
id|err
suffix:semicolon
r_do
(brace
id|err
op_assign
id|nfs4_handle_exception
c_func
(paren
id|NFS_SERVER
c_func
(paren
id|inode
)paren
comma
id|_nfs4_proc_readlink
c_func
(paren
id|inode
comma
id|page
comma
id|pgbase
comma
id|pglen
)paren
comma
op_amp
id|exception
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|exception.retry
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|_nfs4_proc_read
r_static
r_int
id|_nfs4_proc_read
c_func
(paren
r_struct
id|nfs_read_data
op_star
id|rdata
)paren
(brace
r_int
id|flags
op_assign
id|rdata-&gt;flags
suffix:semicolon
r_struct
id|inode
op_star
id|inode
op_assign
id|rdata-&gt;inode
suffix:semicolon
r_struct
id|nfs_fattr
op_star
id|fattr
op_assign
id|rdata-&gt;res.fattr
suffix:semicolon
r_struct
id|nfs_server
op_star
id|server
op_assign
id|NFS_SERVER
c_func
(paren
id|inode
)paren
suffix:semicolon
r_struct
id|rpc_message
id|msg
op_assign
(brace
dot
id|rpc_proc
op_assign
op_amp
id|nfs4_procedures
(braket
id|NFSPROC4_CLNT_READ
)braket
comma
dot
id|rpc_argp
op_assign
op_amp
id|rdata-&gt;args
comma
dot
id|rpc_resp
op_assign
op_amp
id|rdata-&gt;res
comma
dot
id|rpc_cred
op_assign
id|rdata-&gt;cred
comma
)brace
suffix:semicolon
r_int
r_int
id|timestamp
op_assign
id|jiffies
suffix:semicolon
r_int
id|status
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;NFS call  read %d @ %Ld&bslash;n&quot;
comma
id|rdata-&gt;args.count
comma
(paren
r_int
r_int
)paren
id|rdata-&gt;args.offset
)paren
suffix:semicolon
id|fattr-&gt;valid
op_assign
l_int|0
suffix:semicolon
id|status
op_assign
id|rpc_call_sync
c_func
(paren
id|server-&gt;client
comma
op_amp
id|msg
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|status
)paren
id|renew_lease
c_func
(paren
id|server
comma
id|timestamp
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;NFS reply read: %d&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
DECL|function|nfs4_proc_read
r_static
r_int
id|nfs4_proc_read
c_func
(paren
r_struct
id|nfs_read_data
op_star
id|rdata
)paren
(brace
r_struct
id|nfs4_exception
id|exception
op_assign
(brace
)brace
suffix:semicolon
r_int
id|err
suffix:semicolon
r_do
(brace
id|err
op_assign
id|nfs4_handle_exception
c_func
(paren
id|NFS_SERVER
c_func
(paren
id|rdata-&gt;inode
)paren
comma
id|_nfs4_proc_read
c_func
(paren
id|rdata
)paren
comma
op_amp
id|exception
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|exception.retry
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|_nfs4_proc_write
r_static
r_int
id|_nfs4_proc_write
c_func
(paren
r_struct
id|nfs_write_data
op_star
id|wdata
)paren
(brace
r_int
id|rpcflags
op_assign
id|wdata-&gt;flags
suffix:semicolon
r_struct
id|inode
op_star
id|inode
op_assign
id|wdata-&gt;inode
suffix:semicolon
r_struct
id|nfs_fattr
op_star
id|fattr
op_assign
id|wdata-&gt;res.fattr
suffix:semicolon
r_struct
id|nfs_server
op_star
id|server
op_assign
id|NFS_SERVER
c_func
(paren
id|inode
)paren
suffix:semicolon
r_struct
id|rpc_message
id|msg
op_assign
(brace
dot
id|rpc_proc
op_assign
op_amp
id|nfs4_procedures
(braket
id|NFSPROC4_CLNT_WRITE
)braket
comma
dot
id|rpc_argp
op_assign
op_amp
id|wdata-&gt;args
comma
dot
id|rpc_resp
op_assign
op_amp
id|wdata-&gt;res
comma
dot
id|rpc_cred
op_assign
id|wdata-&gt;cred
comma
)brace
suffix:semicolon
r_int
id|status
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;NFS call  write %d @ %Ld&bslash;n&quot;
comma
id|wdata-&gt;args.count
comma
(paren
r_int
r_int
)paren
id|wdata-&gt;args.offset
)paren
suffix:semicolon
id|fattr-&gt;valid
op_assign
l_int|0
suffix:semicolon
id|status
op_assign
id|rpc_call_sync
c_func
(paren
id|server-&gt;client
comma
op_amp
id|msg
comma
id|rpcflags
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;NFS reply write: %d&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
DECL|function|nfs4_proc_write
r_static
r_int
id|nfs4_proc_write
c_func
(paren
r_struct
id|nfs_write_data
op_star
id|wdata
)paren
(brace
r_struct
id|nfs4_exception
id|exception
op_assign
(brace
)brace
suffix:semicolon
r_int
id|err
suffix:semicolon
r_do
(brace
id|err
op_assign
id|nfs4_handle_exception
c_func
(paren
id|NFS_SERVER
c_func
(paren
id|wdata-&gt;inode
)paren
comma
id|_nfs4_proc_write
c_func
(paren
id|wdata
)paren
comma
op_amp
id|exception
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|exception.retry
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|_nfs4_proc_commit
r_static
r_int
id|_nfs4_proc_commit
c_func
(paren
r_struct
id|nfs_write_data
op_star
id|cdata
)paren
(brace
r_struct
id|inode
op_star
id|inode
op_assign
id|cdata-&gt;inode
suffix:semicolon
r_struct
id|nfs_fattr
op_star
id|fattr
op_assign
id|cdata-&gt;res.fattr
suffix:semicolon
r_struct
id|nfs_server
op_star
id|server
op_assign
id|NFS_SERVER
c_func
(paren
id|inode
)paren
suffix:semicolon
r_struct
id|rpc_message
id|msg
op_assign
(brace
dot
id|rpc_proc
op_assign
op_amp
id|nfs4_procedures
(braket
id|NFSPROC4_CLNT_COMMIT
)braket
comma
dot
id|rpc_argp
op_assign
op_amp
id|cdata-&gt;args
comma
dot
id|rpc_resp
op_assign
op_amp
id|cdata-&gt;res
comma
dot
id|rpc_cred
op_assign
id|cdata-&gt;cred
comma
)brace
suffix:semicolon
r_int
id|status
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;NFS call  commit %d @ %Ld&bslash;n&quot;
comma
id|cdata-&gt;args.count
comma
(paren
r_int
r_int
)paren
id|cdata-&gt;args.offset
)paren
suffix:semicolon
id|fattr-&gt;valid
op_assign
l_int|0
suffix:semicolon
id|status
op_assign
id|rpc_call_sync
c_func
(paren
id|server-&gt;client
comma
op_amp
id|msg
comma
l_int|0
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;NFS reply commit: %d&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
DECL|function|nfs4_proc_commit
r_static
r_int
id|nfs4_proc_commit
c_func
(paren
r_struct
id|nfs_write_data
op_star
id|cdata
)paren
(brace
r_struct
id|nfs4_exception
id|exception
op_assign
(brace
)brace
suffix:semicolon
r_int
id|err
suffix:semicolon
r_do
(brace
id|err
op_assign
id|nfs4_handle_exception
c_func
(paren
id|NFS_SERVER
c_func
(paren
id|cdata-&gt;inode
)paren
comma
id|_nfs4_proc_commit
c_func
(paren
id|cdata
)paren
comma
op_amp
id|exception
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|exception.retry
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*&n; * Got race?&n; * We will need to arrange for the VFS layer to provide an atomic open.&n; * Until then, this create/open method is prone to inefficiency and race&n; * conditions due to the lookup, create, and open VFS calls from sys_open()&n; * placed on the wire.&n; *&n; * Given the above sorry state of affairs, I&squot;m simply sending an OPEN.&n; * The file will be opened again in the subsequent VFS open call&n; * (nfs4_proc_file_open).&n; *&n; * The open for read will just hang around to be used by any process that&n; * opens the file O_RDONLY. This will all be resolved with the VFS changes.&n; */
r_static
r_struct
id|inode
op_star
DECL|function|nfs4_proc_create
id|nfs4_proc_create
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|dentry
op_star
id|dentry
comma
r_struct
id|iattr
op_star
id|sattr
comma
r_int
id|flags
)paren
(brace
r_struct
id|inode
op_star
id|inode
suffix:semicolon
r_struct
id|nfs4_state
op_star
id|state
suffix:semicolon
r_struct
id|rpc_cred
op_star
id|cred
suffix:semicolon
id|cred
op_assign
id|rpcauth_lookupcred
c_func
(paren
id|NFS_SERVER
c_func
(paren
id|dir
)paren
op_member_access_from_pointer
id|client-&gt;cl_auth
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|cred
)paren
)paren
r_return
(paren
r_struct
id|inode
op_star
)paren
id|cred
suffix:semicolon
id|state
op_assign
id|nfs4_do_open
c_func
(paren
id|dir
comma
id|dentry
comma
id|flags
comma
id|sattr
comma
id|cred
)paren
suffix:semicolon
id|put_rpccred
c_func
(paren
id|cred
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|state
)paren
)paren
(brace
id|inode
op_assign
(paren
r_struct
id|inode
op_star
)paren
id|state
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|inode
op_assign
id|state-&gt;inode
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
id|O_EXCL
)paren
(brace
r_struct
id|nfs_fattr
id|fattr
suffix:semicolon
r_int
id|status
suffix:semicolon
id|status
op_assign
id|nfs4_do_setattr
c_func
(paren
id|NFS_SERVER
c_func
(paren
id|dir
)paren
comma
op_amp
id|fattr
comma
id|NFS_FH
c_func
(paren
id|inode
)paren
comma
id|sattr
comma
id|state
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_eq
l_int|0
)paren
r_goto
id|out
suffix:semicolon
id|iput
c_func
(paren
id|inode
)paren
suffix:semicolon
id|inode
op_assign
id|ERR_PTR
c_func
(paren
id|status
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|flags
op_ne
l_int|0
)paren
r_goto
id|out
suffix:semicolon
id|nfs4_close_state
c_func
(paren
id|state
comma
id|flags
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|inode
suffix:semicolon
)brace
DECL|function|_nfs4_proc_remove
r_static
r_int
id|_nfs4_proc_remove
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|qstr
op_star
id|name
)paren
(brace
r_struct
id|nfs4_remove_arg
id|args
op_assign
(brace
dot
id|fh
op_assign
id|NFS_FH
c_func
(paren
id|dir
)paren
comma
dot
id|name
op_assign
id|name
comma
)brace
suffix:semicolon
r_struct
id|nfs4_change_info
id|res
suffix:semicolon
r_struct
id|rpc_message
id|msg
op_assign
(brace
dot
id|rpc_proc
op_assign
op_amp
id|nfs4_procedures
(braket
id|NFSPROC4_CLNT_REMOVE
)braket
comma
dot
id|rpc_argp
op_assign
op_amp
id|args
comma
dot
id|rpc_resp
op_assign
op_amp
id|res
comma
)brace
suffix:semicolon
r_int
id|status
suffix:semicolon
id|status
op_assign
id|rpc_call_sync
c_func
(paren
id|NFS_CLIENT
c_func
(paren
id|dir
)paren
comma
op_amp
id|msg
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_eq
l_int|0
)paren
id|update_changeattr
c_func
(paren
id|dir
comma
op_amp
id|res
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
DECL|function|nfs4_proc_remove
r_static
r_int
id|nfs4_proc_remove
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|qstr
op_star
id|name
)paren
(brace
r_struct
id|nfs4_exception
id|exception
op_assign
(brace
)brace
suffix:semicolon
r_int
id|err
suffix:semicolon
r_do
(brace
id|err
op_assign
id|nfs4_handle_exception
c_func
(paren
id|NFS_SERVER
c_func
(paren
id|dir
)paren
comma
id|_nfs4_proc_remove
c_func
(paren
id|dir
comma
id|name
)paren
comma
op_amp
id|exception
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|exception.retry
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|struct|unlink_desc
r_struct
id|unlink_desc
(brace
DECL|member|args
r_struct
id|nfs4_remove_arg
id|args
suffix:semicolon
DECL|member|res
r_struct
id|nfs4_change_info
id|res
suffix:semicolon
)brace
suffix:semicolon
DECL|function|nfs4_proc_unlink_setup
r_static
r_int
id|nfs4_proc_unlink_setup
c_func
(paren
r_struct
id|rpc_message
op_star
id|msg
comma
r_struct
id|dentry
op_star
id|dir
comma
r_struct
id|qstr
op_star
id|name
)paren
(brace
r_struct
id|unlink_desc
op_star
id|up
suffix:semicolon
id|up
op_assign
(paren
r_struct
id|unlink_desc
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|up
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|up
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|up-&gt;args.fh
op_assign
id|NFS_FH
c_func
(paren
id|dir-&gt;d_inode
)paren
suffix:semicolon
id|up-&gt;args.name
op_assign
id|name
suffix:semicolon
id|msg-&gt;rpc_proc
op_assign
op_amp
id|nfs4_procedures
(braket
id|NFSPROC4_CLNT_REMOVE
)braket
suffix:semicolon
id|msg-&gt;rpc_argp
op_assign
op_amp
id|up-&gt;args
suffix:semicolon
id|msg-&gt;rpc_resp
op_assign
op_amp
id|up-&gt;res
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|nfs4_proc_unlink_done
r_static
r_int
id|nfs4_proc_unlink_done
c_func
(paren
r_struct
id|dentry
op_star
id|dir
comma
r_struct
id|rpc_task
op_star
id|task
)paren
(brace
r_struct
id|rpc_message
op_star
id|msg
op_assign
op_amp
id|task-&gt;tk_msg
suffix:semicolon
r_struct
id|unlink_desc
op_star
id|up
suffix:semicolon
r_if
c_cond
(paren
id|msg-&gt;rpc_resp
op_ne
l_int|NULL
)paren
(brace
id|up
op_assign
id|container_of
c_func
(paren
id|msg-&gt;rpc_resp
comma
r_struct
id|unlink_desc
comma
id|res
)paren
suffix:semicolon
id|update_changeattr
c_func
(paren
id|dir-&gt;d_inode
comma
op_amp
id|up-&gt;res
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|up
)paren
suffix:semicolon
id|msg-&gt;rpc_resp
op_assign
l_int|NULL
suffix:semicolon
id|msg-&gt;rpc_argp
op_assign
l_int|NULL
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|_nfs4_proc_rename
r_static
r_int
id|_nfs4_proc_rename
c_func
(paren
r_struct
id|inode
op_star
id|old_dir
comma
r_struct
id|qstr
op_star
id|old_name
comma
r_struct
id|inode
op_star
id|new_dir
comma
r_struct
id|qstr
op_star
id|new_name
)paren
(brace
r_struct
id|nfs4_rename_arg
id|arg
op_assign
(brace
dot
id|old_dir
op_assign
id|NFS_FH
c_func
(paren
id|old_dir
)paren
comma
dot
id|new_dir
op_assign
id|NFS_FH
c_func
(paren
id|new_dir
)paren
comma
dot
id|old_name
op_assign
id|old_name
comma
dot
id|new_name
op_assign
id|new_name
comma
)brace
suffix:semicolon
r_struct
id|nfs4_rename_res
id|res
op_assign
(brace
)brace
suffix:semicolon
r_struct
id|rpc_message
id|msg
op_assign
(brace
dot
id|rpc_proc
op_assign
op_amp
id|nfs4_procedures
(braket
id|NFSPROC4_CLNT_RENAME
)braket
comma
dot
id|rpc_argp
op_assign
op_amp
id|arg
comma
dot
id|rpc_resp
op_assign
op_amp
id|res
comma
)brace
suffix:semicolon
r_int
id|status
suffix:semicolon
id|status
op_assign
id|rpc_call_sync
c_func
(paren
id|NFS_CLIENT
c_func
(paren
id|old_dir
)paren
comma
op_amp
id|msg
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|status
)paren
(brace
id|update_changeattr
c_func
(paren
id|old_dir
comma
op_amp
id|res.old_cinfo
)paren
suffix:semicolon
id|update_changeattr
c_func
(paren
id|new_dir
comma
op_amp
id|res.new_cinfo
)paren
suffix:semicolon
)brace
r_return
id|status
suffix:semicolon
)brace
DECL|function|nfs4_proc_rename
r_static
r_int
id|nfs4_proc_rename
c_func
(paren
r_struct
id|inode
op_star
id|old_dir
comma
r_struct
id|qstr
op_star
id|old_name
comma
r_struct
id|inode
op_star
id|new_dir
comma
r_struct
id|qstr
op_star
id|new_name
)paren
(brace
r_struct
id|nfs4_exception
id|exception
op_assign
(brace
)brace
suffix:semicolon
r_int
id|err
suffix:semicolon
r_do
(brace
id|err
op_assign
id|nfs4_handle_exception
c_func
(paren
id|NFS_SERVER
c_func
(paren
id|old_dir
)paren
comma
id|_nfs4_proc_rename
c_func
(paren
id|old_dir
comma
id|old_name
comma
id|new_dir
comma
id|new_name
)paren
comma
op_amp
id|exception
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|exception.retry
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|_nfs4_proc_link
r_static
r_int
id|_nfs4_proc_link
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|qstr
op_star
id|name
)paren
(brace
r_struct
id|nfs4_link_arg
id|arg
op_assign
(brace
dot
id|fh
op_assign
id|NFS_FH
c_func
(paren
id|inode
)paren
comma
dot
id|dir_fh
op_assign
id|NFS_FH
c_func
(paren
id|dir
)paren
comma
dot
id|name
op_assign
id|name
comma
)brace
suffix:semicolon
r_struct
id|nfs4_change_info
id|cinfo
op_assign
(brace
)brace
suffix:semicolon
r_struct
id|rpc_message
id|msg
op_assign
(brace
dot
id|rpc_proc
op_assign
op_amp
id|nfs4_procedures
(braket
id|NFSPROC4_CLNT_LINK
)braket
comma
dot
id|rpc_argp
op_assign
op_amp
id|arg
comma
dot
id|rpc_resp
op_assign
op_amp
id|cinfo
comma
)brace
suffix:semicolon
r_int
id|status
suffix:semicolon
id|status
op_assign
id|rpc_call_sync
c_func
(paren
id|NFS_CLIENT
c_func
(paren
id|inode
)paren
comma
op_amp
id|msg
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|status
)paren
id|update_changeattr
c_func
(paren
id|dir
comma
op_amp
id|cinfo
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
DECL|function|nfs4_proc_link
r_static
r_int
id|nfs4_proc_link
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|qstr
op_star
id|name
)paren
(brace
r_struct
id|nfs4_exception
id|exception
op_assign
(brace
)brace
suffix:semicolon
r_int
id|err
suffix:semicolon
r_do
(brace
id|err
op_assign
id|nfs4_handle_exception
c_func
(paren
id|NFS_SERVER
c_func
(paren
id|inode
)paren
comma
id|_nfs4_proc_link
c_func
(paren
id|inode
comma
id|dir
comma
id|name
)paren
comma
op_amp
id|exception
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|exception.retry
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|_nfs4_proc_symlink
r_static
r_int
id|_nfs4_proc_symlink
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|qstr
op_star
id|name
comma
r_struct
id|qstr
op_star
id|path
comma
r_struct
id|iattr
op_star
id|sattr
comma
r_struct
id|nfs_fh
op_star
id|fhandle
comma
r_struct
id|nfs_fattr
op_star
id|fattr
)paren
(brace
r_struct
id|nfs_server
op_star
id|server
op_assign
id|NFS_SERVER
c_func
(paren
id|dir
)paren
suffix:semicolon
r_struct
id|nfs4_create_arg
id|arg
op_assign
(brace
dot
id|dir_fh
op_assign
id|NFS_FH
c_func
(paren
id|dir
)paren
comma
dot
id|server
op_assign
id|server
comma
dot
id|name
op_assign
id|name
comma
dot
id|attrs
op_assign
id|sattr
comma
dot
id|ftype
op_assign
id|NF4LNK
comma
dot
id|bitmask
op_assign
id|server-&gt;attr_bitmask
comma
)brace
suffix:semicolon
r_struct
id|nfs4_create_res
id|res
op_assign
(brace
dot
id|server
op_assign
id|server
comma
dot
id|fh
op_assign
id|fhandle
comma
dot
id|fattr
op_assign
id|fattr
comma
)brace
suffix:semicolon
r_struct
id|rpc_message
id|msg
op_assign
(brace
dot
id|rpc_proc
op_assign
op_amp
id|nfs4_procedures
(braket
id|NFSPROC4_CLNT_SYMLINK
)braket
comma
dot
id|rpc_argp
op_assign
op_amp
id|arg
comma
dot
id|rpc_resp
op_assign
op_amp
id|res
comma
)brace
suffix:semicolon
r_int
id|status
suffix:semicolon
r_if
c_cond
(paren
id|path-&gt;len
OG
id|NFS4_MAXPATHLEN
)paren
r_return
op_minus
id|ENAMETOOLONG
suffix:semicolon
id|arg.u.symlink
op_assign
id|path
suffix:semicolon
id|fattr-&gt;valid
op_assign
l_int|0
suffix:semicolon
id|status
op_assign
id|rpc_call_sync
c_func
(paren
id|NFS_CLIENT
c_func
(paren
id|dir
)paren
comma
op_amp
id|msg
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|status
)paren
id|update_changeattr
c_func
(paren
id|dir
comma
op_amp
id|res.dir_cinfo
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
DECL|function|nfs4_proc_symlink
r_static
r_int
id|nfs4_proc_symlink
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|qstr
op_star
id|name
comma
r_struct
id|qstr
op_star
id|path
comma
r_struct
id|iattr
op_star
id|sattr
comma
r_struct
id|nfs_fh
op_star
id|fhandle
comma
r_struct
id|nfs_fattr
op_star
id|fattr
)paren
(brace
r_struct
id|nfs4_exception
id|exception
op_assign
(brace
)brace
suffix:semicolon
r_int
id|err
suffix:semicolon
r_do
(brace
id|err
op_assign
id|nfs4_handle_exception
c_func
(paren
id|NFS_SERVER
c_func
(paren
id|dir
)paren
comma
id|_nfs4_proc_symlink
c_func
(paren
id|dir
comma
id|name
comma
id|path
comma
id|sattr
comma
id|fhandle
comma
id|fattr
)paren
comma
op_amp
id|exception
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|exception.retry
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|_nfs4_proc_mkdir
r_static
r_int
id|_nfs4_proc_mkdir
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|qstr
op_star
id|name
comma
r_struct
id|iattr
op_star
id|sattr
comma
r_struct
id|nfs_fh
op_star
id|fhandle
comma
r_struct
id|nfs_fattr
op_star
id|fattr
)paren
(brace
r_struct
id|nfs_server
op_star
id|server
op_assign
id|NFS_SERVER
c_func
(paren
id|dir
)paren
suffix:semicolon
r_struct
id|nfs4_create_arg
id|arg
op_assign
(brace
dot
id|dir_fh
op_assign
id|NFS_FH
c_func
(paren
id|dir
)paren
comma
dot
id|server
op_assign
id|server
comma
dot
id|name
op_assign
id|name
comma
dot
id|attrs
op_assign
id|sattr
comma
dot
id|ftype
op_assign
id|NF4DIR
comma
dot
id|bitmask
op_assign
id|server-&gt;attr_bitmask
comma
)brace
suffix:semicolon
r_struct
id|nfs4_create_res
id|res
op_assign
(brace
dot
id|server
op_assign
id|server
comma
dot
id|fh
op_assign
id|fhandle
comma
dot
id|fattr
op_assign
id|fattr
comma
)brace
suffix:semicolon
r_struct
id|rpc_message
id|msg
op_assign
(brace
dot
id|rpc_proc
op_assign
op_amp
id|nfs4_procedures
(braket
id|NFSPROC4_CLNT_CREATE
)braket
comma
dot
id|rpc_argp
op_assign
op_amp
id|arg
comma
dot
id|rpc_resp
op_assign
op_amp
id|res
comma
)brace
suffix:semicolon
r_int
id|status
suffix:semicolon
id|fattr-&gt;valid
op_assign
l_int|0
suffix:semicolon
id|status
op_assign
id|rpc_call_sync
c_func
(paren
id|NFS_CLIENT
c_func
(paren
id|dir
)paren
comma
op_amp
id|msg
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|status
)paren
id|update_changeattr
c_func
(paren
id|dir
comma
op_amp
id|res.dir_cinfo
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
DECL|function|nfs4_proc_mkdir
r_static
r_int
id|nfs4_proc_mkdir
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|qstr
op_star
id|name
comma
r_struct
id|iattr
op_star
id|sattr
comma
r_struct
id|nfs_fh
op_star
id|fhandle
comma
r_struct
id|nfs_fattr
op_star
id|fattr
)paren
(brace
r_struct
id|nfs4_exception
id|exception
op_assign
(brace
)brace
suffix:semicolon
r_int
id|err
suffix:semicolon
r_do
(brace
id|err
op_assign
id|nfs4_handle_exception
c_func
(paren
id|NFS_SERVER
c_func
(paren
id|dir
)paren
comma
id|_nfs4_proc_mkdir
c_func
(paren
id|dir
comma
id|name
comma
id|sattr
comma
id|fhandle
comma
id|fattr
)paren
comma
op_amp
id|exception
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|exception.retry
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|_nfs4_proc_readdir
r_static
r_int
id|_nfs4_proc_readdir
c_func
(paren
r_struct
id|dentry
op_star
id|dentry
comma
r_struct
id|rpc_cred
op_star
id|cred
comma
id|u64
id|cookie
comma
r_struct
id|page
op_star
id|page
comma
r_int
r_int
id|count
comma
r_int
id|plus
)paren
(brace
r_struct
id|inode
op_star
id|dir
op_assign
id|dentry-&gt;d_inode
suffix:semicolon
r_struct
id|nfs4_readdir_arg
id|args
op_assign
(brace
dot
id|fh
op_assign
id|NFS_FH
c_func
(paren
id|dir
)paren
comma
dot
id|pages
op_assign
op_amp
id|page
comma
dot
id|pgbase
op_assign
l_int|0
comma
dot
id|count
op_assign
id|count
comma
)brace
suffix:semicolon
r_struct
id|nfs4_readdir_res
id|res
suffix:semicolon
r_struct
id|rpc_message
id|msg
op_assign
(brace
dot
id|rpc_proc
op_assign
op_amp
id|nfs4_procedures
(braket
id|NFSPROC4_CLNT_READDIR
)braket
comma
dot
id|rpc_argp
op_assign
op_amp
id|args
comma
dot
id|rpc_resp
op_assign
op_amp
id|res
comma
dot
id|rpc_cred
op_assign
id|cred
comma
)brace
suffix:semicolon
r_int
id|status
suffix:semicolon
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
id|nfs4_setup_readdir
c_func
(paren
id|cookie
comma
id|NFS_COOKIEVERF
c_func
(paren
id|dir
)paren
comma
id|dentry
comma
op_amp
id|args
)paren
suffix:semicolon
id|res.pgbase
op_assign
id|args.pgbase
suffix:semicolon
id|status
op_assign
id|rpc_call_sync
c_func
(paren
id|NFS_CLIENT
c_func
(paren
id|dir
)paren
comma
op_amp
id|msg
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_eq
l_int|0
)paren
id|memcpy
c_func
(paren
id|NFS_COOKIEVERF
c_func
(paren
id|dir
)paren
comma
id|res.verifier.data
comma
id|NFS4_VERIFIER_SIZE
)paren
suffix:semicolon
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
DECL|function|nfs4_proc_readdir
r_static
r_int
id|nfs4_proc_readdir
c_func
(paren
r_struct
id|dentry
op_star
id|dentry
comma
r_struct
id|rpc_cred
op_star
id|cred
comma
id|u64
id|cookie
comma
r_struct
id|page
op_star
id|page
comma
r_int
r_int
id|count
comma
r_int
id|plus
)paren
(brace
r_struct
id|nfs4_exception
id|exception
op_assign
(brace
)brace
suffix:semicolon
r_int
id|err
suffix:semicolon
r_do
(brace
id|err
op_assign
id|nfs4_handle_exception
c_func
(paren
id|NFS_SERVER
c_func
(paren
id|dentry-&gt;d_inode
)paren
comma
id|_nfs4_proc_readdir
c_func
(paren
id|dentry
comma
id|cred
comma
id|cookie
comma
id|page
comma
id|count
comma
id|plus
)paren
comma
op_amp
id|exception
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|exception.retry
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|_nfs4_proc_mknod
r_static
r_int
id|_nfs4_proc_mknod
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|qstr
op_star
id|name
comma
r_struct
id|iattr
op_star
id|sattr
comma
id|dev_t
id|rdev
comma
r_struct
id|nfs_fh
op_star
id|fh
comma
r_struct
id|nfs_fattr
op_star
id|fattr
)paren
(brace
r_struct
id|nfs_server
op_star
id|server
op_assign
id|NFS_SERVER
c_func
(paren
id|dir
)paren
suffix:semicolon
r_struct
id|nfs4_create_arg
id|arg
op_assign
(brace
dot
id|dir_fh
op_assign
id|NFS_FH
c_func
(paren
id|dir
)paren
comma
dot
id|server
op_assign
id|server
comma
dot
id|name
op_assign
id|name
comma
dot
id|attrs
op_assign
id|sattr
comma
dot
id|bitmask
op_assign
id|server-&gt;attr_bitmask
comma
)brace
suffix:semicolon
r_struct
id|nfs4_create_res
id|res
op_assign
(brace
dot
id|server
op_assign
id|server
comma
dot
id|fh
op_assign
id|fh
comma
dot
id|fattr
op_assign
id|fattr
comma
)brace
suffix:semicolon
r_struct
id|rpc_message
id|msg
op_assign
(brace
dot
id|rpc_proc
op_assign
op_amp
id|nfs4_procedures
(braket
id|NFSPROC4_CLNT_CREATE
)braket
comma
dot
id|rpc_argp
op_assign
op_amp
id|arg
comma
dot
id|rpc_resp
op_assign
op_amp
id|res
comma
)brace
suffix:semicolon
r_int
id|status
suffix:semicolon
r_int
id|mode
op_assign
id|sattr-&gt;ia_mode
suffix:semicolon
id|fattr-&gt;valid
op_assign
l_int|0
suffix:semicolon
id|BUG_ON
c_func
(paren
op_logical_neg
(paren
id|sattr-&gt;ia_valid
op_amp
id|ATTR_MODE
)paren
)paren
suffix:semicolon
id|BUG_ON
c_func
(paren
op_logical_neg
id|S_ISFIFO
c_func
(paren
id|mode
)paren
op_logical_and
op_logical_neg
id|S_ISBLK
c_func
(paren
id|mode
)paren
op_logical_and
op_logical_neg
id|S_ISCHR
c_func
(paren
id|mode
)paren
op_logical_and
op_logical_neg
id|S_ISSOCK
c_func
(paren
id|mode
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|S_ISFIFO
c_func
(paren
id|mode
)paren
)paren
id|arg.ftype
op_assign
id|NF4FIFO
suffix:semicolon
r_else
r_if
c_cond
(paren
id|S_ISBLK
c_func
(paren
id|mode
)paren
)paren
(brace
id|arg.ftype
op_assign
id|NF4BLK
suffix:semicolon
id|arg.u.device.specdata1
op_assign
id|MAJOR
c_func
(paren
id|rdev
)paren
suffix:semicolon
id|arg.u.device.specdata2
op_assign
id|MINOR
c_func
(paren
id|rdev
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|S_ISCHR
c_func
(paren
id|mode
)paren
)paren
(brace
id|arg.ftype
op_assign
id|NF4CHR
suffix:semicolon
id|arg.u.device.specdata1
op_assign
id|MAJOR
c_func
(paren
id|rdev
)paren
suffix:semicolon
id|arg.u.device.specdata2
op_assign
id|MINOR
c_func
(paren
id|rdev
)paren
suffix:semicolon
)brace
r_else
id|arg.ftype
op_assign
id|NF4SOCK
suffix:semicolon
id|status
op_assign
id|rpc_call_sync
c_func
(paren
id|NFS_CLIENT
c_func
(paren
id|dir
)paren
comma
op_amp
id|msg
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|status
)paren
id|update_changeattr
c_func
(paren
id|dir
comma
op_amp
id|res.dir_cinfo
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
DECL|function|nfs4_proc_mknod
r_static
r_int
id|nfs4_proc_mknod
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|qstr
op_star
id|name
comma
r_struct
id|iattr
op_star
id|sattr
comma
id|dev_t
id|rdev
comma
r_struct
id|nfs_fh
op_star
id|fh
comma
r_struct
id|nfs_fattr
op_star
id|fattr
)paren
(brace
r_struct
id|nfs4_exception
id|exception
op_assign
(brace
)brace
suffix:semicolon
r_int
id|err
suffix:semicolon
r_do
(brace
id|err
op_assign
id|nfs4_handle_exception
c_func
(paren
id|NFS_SERVER
c_func
(paren
id|dir
)paren
comma
id|_nfs4_proc_mknod
c_func
(paren
id|dir
comma
id|name
comma
id|sattr
comma
id|rdev
comma
id|fh
comma
id|fattr
)paren
comma
op_amp
id|exception
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|exception.retry
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|_nfs4_proc_statfs
r_static
r_int
id|_nfs4_proc_statfs
c_func
(paren
r_struct
id|nfs_server
op_star
id|server
comma
r_struct
id|nfs_fh
op_star
id|fhandle
comma
r_struct
id|nfs_fsstat
op_star
id|fsstat
)paren
(brace
r_struct
id|nfs4_statfs_arg
id|args
op_assign
(brace
dot
id|fh
op_assign
id|fhandle
comma
dot
id|bitmask
op_assign
id|server-&gt;attr_bitmask
comma
)brace
suffix:semicolon
r_struct
id|rpc_message
id|msg
op_assign
(brace
dot
id|rpc_proc
op_assign
op_amp
id|nfs4_procedures
(braket
id|NFSPROC4_CLNT_STATFS
)braket
comma
dot
id|rpc_argp
op_assign
op_amp
id|args
comma
dot
id|rpc_resp
op_assign
id|fsstat
comma
)brace
suffix:semicolon
id|fsstat-&gt;fattr-&gt;valid
op_assign
l_int|0
suffix:semicolon
r_return
id|rpc_call_sync
c_func
(paren
id|server-&gt;client
comma
op_amp
id|msg
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|nfs4_proc_statfs
r_static
r_int
id|nfs4_proc_statfs
c_func
(paren
r_struct
id|nfs_server
op_star
id|server
comma
r_struct
id|nfs_fh
op_star
id|fhandle
comma
r_struct
id|nfs_fsstat
op_star
id|fsstat
)paren
(brace
r_struct
id|nfs4_exception
id|exception
op_assign
(brace
)brace
suffix:semicolon
r_int
id|err
suffix:semicolon
r_do
(brace
id|err
op_assign
id|nfs4_handle_exception
c_func
(paren
id|server
comma
id|_nfs4_proc_statfs
c_func
(paren
id|server
comma
id|fhandle
comma
id|fsstat
)paren
comma
op_amp
id|exception
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|exception.retry
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|_nfs4_do_fsinfo
r_static
r_int
id|_nfs4_do_fsinfo
c_func
(paren
r_struct
id|nfs_server
op_star
id|server
comma
r_struct
id|nfs_fh
op_star
id|fhandle
comma
r_struct
id|nfs_fsinfo
op_star
id|fsinfo
)paren
(brace
r_struct
id|nfs4_fsinfo_arg
id|args
op_assign
(brace
dot
id|fh
op_assign
id|fhandle
comma
dot
id|bitmask
op_assign
id|server-&gt;attr_bitmask
comma
)brace
suffix:semicolon
r_struct
id|rpc_message
id|msg
op_assign
(brace
dot
id|rpc_proc
op_assign
op_amp
id|nfs4_procedures
(braket
id|NFSPROC4_CLNT_FSINFO
)braket
comma
dot
id|rpc_argp
op_assign
op_amp
id|args
comma
dot
id|rpc_resp
op_assign
id|fsinfo
comma
)brace
suffix:semicolon
r_return
id|rpc_call_sync
c_func
(paren
id|server-&gt;client
comma
op_amp
id|msg
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|nfs4_do_fsinfo
r_static
r_int
id|nfs4_do_fsinfo
c_func
(paren
r_struct
id|nfs_server
op_star
id|server
comma
r_struct
id|nfs_fh
op_star
id|fhandle
comma
r_struct
id|nfs_fsinfo
op_star
id|fsinfo
)paren
(brace
r_struct
id|nfs4_exception
id|exception
op_assign
(brace
)brace
suffix:semicolon
r_int
id|err
suffix:semicolon
r_do
(brace
id|err
op_assign
id|nfs4_handle_exception
c_func
(paren
id|server
comma
id|_nfs4_do_fsinfo
c_func
(paren
id|server
comma
id|fhandle
comma
id|fsinfo
)paren
comma
op_amp
id|exception
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|exception.retry
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|nfs4_proc_fsinfo
r_static
r_int
id|nfs4_proc_fsinfo
c_func
(paren
r_struct
id|nfs_server
op_star
id|server
comma
r_struct
id|nfs_fh
op_star
id|fhandle
comma
r_struct
id|nfs_fsinfo
op_star
id|fsinfo
)paren
(brace
id|fsinfo-&gt;fattr-&gt;valid
op_assign
l_int|0
suffix:semicolon
r_return
id|nfs4_do_fsinfo
c_func
(paren
id|server
comma
id|fhandle
comma
id|fsinfo
)paren
suffix:semicolon
)brace
DECL|function|_nfs4_proc_pathconf
r_static
r_int
id|_nfs4_proc_pathconf
c_func
(paren
r_struct
id|nfs_server
op_star
id|server
comma
r_struct
id|nfs_fh
op_star
id|fhandle
comma
r_struct
id|nfs_pathconf
op_star
id|pathconf
)paren
(brace
r_struct
id|nfs4_pathconf_arg
id|args
op_assign
(brace
dot
id|fh
op_assign
id|fhandle
comma
dot
id|bitmask
op_assign
id|server-&gt;attr_bitmask
comma
)brace
suffix:semicolon
r_struct
id|rpc_message
id|msg
op_assign
(brace
dot
id|rpc_proc
op_assign
op_amp
id|nfs4_procedures
(braket
id|NFSPROC4_CLNT_PATHCONF
)braket
comma
dot
id|rpc_argp
op_assign
op_amp
id|args
comma
dot
id|rpc_resp
op_assign
id|pathconf
comma
)brace
suffix:semicolon
multiline_comment|/* None of the pathconf attributes are mandatory to implement */
r_if
c_cond
(paren
(paren
id|args.bitmask
(braket
l_int|0
)braket
op_amp
id|nfs4_pathconf_bitmap
(braket
l_int|0
)braket
)paren
op_eq
l_int|0
)paren
(brace
id|memset
c_func
(paren
id|pathconf
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|pathconf
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|pathconf-&gt;fattr-&gt;valid
op_assign
l_int|0
suffix:semicolon
r_return
id|rpc_call_sync
c_func
(paren
id|server-&gt;client
comma
op_amp
id|msg
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|nfs4_proc_pathconf
r_static
r_int
id|nfs4_proc_pathconf
c_func
(paren
r_struct
id|nfs_server
op_star
id|server
comma
r_struct
id|nfs_fh
op_star
id|fhandle
comma
r_struct
id|nfs_pathconf
op_star
id|pathconf
)paren
(brace
r_struct
id|nfs4_exception
id|exception
op_assign
(brace
)brace
suffix:semicolon
r_int
id|err
suffix:semicolon
r_do
(brace
id|err
op_assign
id|nfs4_handle_exception
c_func
(paren
id|server
comma
id|_nfs4_proc_pathconf
c_func
(paren
id|server
comma
id|fhandle
comma
id|pathconf
)paren
comma
op_amp
id|exception
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|exception.retry
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
r_static
r_void
DECL|function|nfs4_read_done
id|nfs4_read_done
c_func
(paren
r_struct
id|rpc_task
op_star
id|task
)paren
(brace
r_struct
id|nfs_read_data
op_star
id|data
op_assign
(paren
r_struct
id|nfs_read_data
op_star
)paren
id|task-&gt;tk_calldata
suffix:semicolon
r_struct
id|inode
op_star
id|inode
op_assign
id|data-&gt;inode
suffix:semicolon
r_if
c_cond
(paren
id|nfs4_async_handle_error
c_func
(paren
id|task
comma
id|NFS_SERVER
c_func
(paren
id|inode
)paren
)paren
op_eq
op_minus
id|EAGAIN
)paren
(brace
id|rpc_restart_call
c_func
(paren
id|task
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|task-&gt;tk_status
OG
l_int|0
)paren
id|renew_lease
c_func
(paren
id|NFS_SERVER
c_func
(paren
id|inode
)paren
comma
id|data-&gt;timestamp
)paren
suffix:semicolon
multiline_comment|/* Call back common NFS readpage processing */
id|nfs_readpage_result
c_func
(paren
id|task
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|nfs4_proc_read_setup
id|nfs4_proc_read_setup
c_func
(paren
r_struct
id|nfs_read_data
op_star
id|data
)paren
(brace
r_struct
id|rpc_task
op_star
id|task
op_assign
op_amp
id|data-&gt;task
suffix:semicolon
r_struct
id|rpc_message
id|msg
op_assign
(brace
dot
id|rpc_proc
op_assign
op_amp
id|nfs4_procedures
(braket
id|NFSPROC4_CLNT_READ
)braket
comma
dot
id|rpc_argp
op_assign
op_amp
id|data-&gt;args
comma
dot
id|rpc_resp
op_assign
op_amp
id|data-&gt;res
comma
dot
id|rpc_cred
op_assign
id|data-&gt;cred
comma
)brace
suffix:semicolon
r_struct
id|inode
op_star
id|inode
op_assign
id|data-&gt;inode
suffix:semicolon
r_int
id|flags
suffix:semicolon
id|data-&gt;timestamp
op_assign
id|jiffies
suffix:semicolon
multiline_comment|/* N.B. Do we need to test? Never called for swapfile inode */
id|flags
op_assign
id|RPC_TASK_ASYNC
op_or
(paren
id|IS_SWAPFILE
c_func
(paren
id|inode
)paren
ques
c_cond
id|NFS_RPC_SWAPFLAGS
suffix:colon
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Finalize the task. */
id|rpc_init_task
c_func
(paren
id|task
comma
id|NFS_CLIENT
c_func
(paren
id|inode
)paren
comma
id|nfs4_read_done
comma
id|flags
)paren
suffix:semicolon
id|rpc_call_setup
c_func
(paren
id|task
comma
op_amp
id|msg
comma
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|nfs4_write_done
id|nfs4_write_done
c_func
(paren
r_struct
id|rpc_task
op_star
id|task
)paren
(brace
r_struct
id|nfs_write_data
op_star
id|data
op_assign
(paren
r_struct
id|nfs_write_data
op_star
)paren
id|task-&gt;tk_calldata
suffix:semicolon
r_struct
id|inode
op_star
id|inode
op_assign
id|data-&gt;inode
suffix:semicolon
r_if
c_cond
(paren
id|nfs4_async_handle_error
c_func
(paren
id|task
comma
id|NFS_SERVER
c_func
(paren
id|inode
)paren
)paren
op_eq
op_minus
id|EAGAIN
)paren
(brace
id|rpc_restart_call
c_func
(paren
id|task
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|task-&gt;tk_status
op_ge
l_int|0
)paren
id|renew_lease
c_func
(paren
id|NFS_SERVER
c_func
(paren
id|inode
)paren
comma
id|data-&gt;timestamp
)paren
suffix:semicolon
multiline_comment|/* Call back common NFS writeback processing */
id|nfs_writeback_done
c_func
(paren
id|task
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|nfs4_proc_write_setup
id|nfs4_proc_write_setup
c_func
(paren
r_struct
id|nfs_write_data
op_star
id|data
comma
r_int
id|how
)paren
(brace
r_struct
id|rpc_task
op_star
id|task
op_assign
op_amp
id|data-&gt;task
suffix:semicolon
r_struct
id|rpc_message
id|msg
op_assign
(brace
dot
id|rpc_proc
op_assign
op_amp
id|nfs4_procedures
(braket
id|NFSPROC4_CLNT_WRITE
)braket
comma
dot
id|rpc_argp
op_assign
op_amp
id|data-&gt;args
comma
dot
id|rpc_resp
op_assign
op_amp
id|data-&gt;res
comma
dot
id|rpc_cred
op_assign
id|data-&gt;cred
comma
)brace
suffix:semicolon
r_struct
id|inode
op_star
id|inode
op_assign
id|data-&gt;inode
suffix:semicolon
r_int
id|stable
suffix:semicolon
r_int
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|how
op_amp
id|FLUSH_STABLE
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|NFS_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|ncommit
)paren
id|stable
op_assign
id|NFS_FILE_SYNC
suffix:semicolon
r_else
id|stable
op_assign
id|NFS_DATA_SYNC
suffix:semicolon
)brace
r_else
id|stable
op_assign
id|NFS_UNSTABLE
suffix:semicolon
id|data-&gt;args.stable
op_assign
id|stable
suffix:semicolon
id|data-&gt;timestamp
op_assign
id|jiffies
suffix:semicolon
multiline_comment|/* Set the initial flags for the task.  */
id|flags
op_assign
(paren
id|how
op_amp
id|FLUSH_SYNC
)paren
ques
c_cond
l_int|0
suffix:colon
id|RPC_TASK_ASYNC
suffix:semicolon
multiline_comment|/* Finalize the task. */
id|rpc_init_task
c_func
(paren
id|task
comma
id|NFS_CLIENT
c_func
(paren
id|inode
)paren
comma
id|nfs4_write_done
comma
id|flags
)paren
suffix:semicolon
id|rpc_call_setup
c_func
(paren
id|task
comma
op_amp
id|msg
comma
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|nfs4_commit_done
id|nfs4_commit_done
c_func
(paren
r_struct
id|rpc_task
op_star
id|task
)paren
(brace
r_struct
id|nfs_write_data
op_star
id|data
op_assign
(paren
r_struct
id|nfs_write_data
op_star
)paren
id|task-&gt;tk_calldata
suffix:semicolon
r_struct
id|inode
op_star
id|inode
op_assign
id|data-&gt;inode
suffix:semicolon
r_if
c_cond
(paren
id|nfs4_async_handle_error
c_func
(paren
id|task
comma
id|NFS_SERVER
c_func
(paren
id|inode
)paren
)paren
op_eq
op_minus
id|EAGAIN
)paren
(brace
id|rpc_restart_call
c_func
(paren
id|task
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* Call back common NFS writeback processing */
id|nfs_commit_done
c_func
(paren
id|task
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|nfs4_proc_commit_setup
id|nfs4_proc_commit_setup
c_func
(paren
r_struct
id|nfs_write_data
op_star
id|data
comma
r_int
id|how
)paren
(brace
r_struct
id|rpc_task
op_star
id|task
op_assign
op_amp
id|data-&gt;task
suffix:semicolon
r_struct
id|rpc_message
id|msg
op_assign
(brace
dot
id|rpc_proc
op_assign
op_amp
id|nfs4_procedures
(braket
id|NFSPROC4_CLNT_COMMIT
)braket
comma
dot
id|rpc_argp
op_assign
op_amp
id|data-&gt;args
comma
dot
id|rpc_resp
op_assign
op_amp
id|data-&gt;res
comma
dot
id|rpc_cred
op_assign
id|data-&gt;cred
comma
)brace
suffix:semicolon
r_struct
id|inode
op_star
id|inode
op_assign
id|data-&gt;inode
suffix:semicolon
r_int
id|flags
suffix:semicolon
multiline_comment|/* Set the initial flags for the task.  */
id|flags
op_assign
(paren
id|how
op_amp
id|FLUSH_SYNC
)paren
ques
c_cond
l_int|0
suffix:colon
id|RPC_TASK_ASYNC
suffix:semicolon
multiline_comment|/* Finalize the task. */
id|rpc_init_task
c_func
(paren
id|task
comma
id|NFS_CLIENT
c_func
(paren
id|inode
)paren
comma
id|nfs4_commit_done
comma
id|flags
)paren
suffix:semicolon
id|rpc_call_setup
c_func
(paren
id|task
comma
op_amp
id|msg
comma
l_int|0
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * nfs4_proc_async_renew(): This is not one of the nfs_rpc_ops; it is a special&n; * standalone procedure for queueing an asynchronous RENEW.&n; */
r_static
r_void
DECL|function|renew_done
id|renew_done
c_func
(paren
r_struct
id|rpc_task
op_star
id|task
)paren
(brace
r_struct
id|nfs4_client
op_star
id|clp
op_assign
(paren
r_struct
id|nfs4_client
op_star
)paren
id|task-&gt;tk_msg.rpc_argp
suffix:semicolon
r_int
r_int
id|timestamp
op_assign
(paren
r_int
r_int
)paren
id|task-&gt;tk_calldata
suffix:semicolon
r_if
c_cond
(paren
id|task-&gt;tk_status
OL
l_int|0
)paren
(brace
r_switch
c_cond
(paren
id|task-&gt;tk_status
)paren
(brace
r_case
op_minus
id|NFS4ERR_STALE_CLIENTID
suffix:colon
r_case
op_minus
id|NFS4ERR_EXPIRED
suffix:colon
r_case
op_minus
id|NFS4ERR_CB_PATH_DOWN
suffix:colon
id|nfs4_schedule_state_recovery
c_func
(paren
id|clp
)paren
suffix:semicolon
)brace
r_return
suffix:semicolon
)brace
id|spin_lock
c_func
(paren
op_amp
id|clp-&gt;cl_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|time_before
c_func
(paren
id|clp-&gt;cl_last_renewal
comma
id|timestamp
)paren
)paren
id|clp-&gt;cl_last_renewal
op_assign
id|timestamp
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|clp-&gt;cl_lock
)paren
suffix:semicolon
)brace
r_int
DECL|function|nfs4_proc_async_renew
id|nfs4_proc_async_renew
c_func
(paren
r_struct
id|nfs4_client
op_star
id|clp
)paren
(brace
r_struct
id|rpc_message
id|msg
op_assign
(brace
dot
id|rpc_proc
op_assign
op_amp
id|nfs4_procedures
(braket
id|NFSPROC4_CLNT_RENEW
)braket
comma
dot
id|rpc_argp
op_assign
id|clp
comma
dot
id|rpc_cred
op_assign
id|clp-&gt;cl_cred
comma
)brace
suffix:semicolon
r_return
id|rpc_call_async
c_func
(paren
id|clp-&gt;cl_rpcclient
comma
op_amp
id|msg
comma
id|RPC_TASK_SOFT
comma
id|renew_done
comma
(paren
r_void
op_star
)paren
id|jiffies
)paren
suffix:semicolon
)brace
r_int
DECL|function|nfs4_proc_renew
id|nfs4_proc_renew
c_func
(paren
r_struct
id|nfs4_client
op_star
id|clp
)paren
(brace
r_struct
id|rpc_message
id|msg
op_assign
(brace
dot
id|rpc_proc
op_assign
op_amp
id|nfs4_procedures
(braket
id|NFSPROC4_CLNT_RENEW
)braket
comma
dot
id|rpc_argp
op_assign
id|clp
comma
dot
id|rpc_cred
op_assign
id|clp-&gt;cl_cred
comma
)brace
suffix:semicolon
r_int
r_int
id|now
op_assign
id|jiffies
suffix:semicolon
r_int
id|status
suffix:semicolon
id|status
op_assign
id|rpc_call_sync
c_func
(paren
id|clp-&gt;cl_rpcclient
comma
op_amp
id|msg
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
OL
l_int|0
)paren
r_return
id|status
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|clp-&gt;cl_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|time_before
c_func
(paren
id|clp-&gt;cl_last_renewal
comma
id|now
)paren
)paren
id|clp-&gt;cl_last_renewal
op_assign
id|now
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|clp-&gt;cl_lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * We will need to arrange for the VFS layer to provide an atomic open.&n; * Until then, this open method is prone to inefficiency and race conditions&n; * due to the lookup, potential create, and open VFS calls from sys_open()&n; * placed on the wire.&n; */
r_static
r_int
DECL|function|nfs4_proc_file_open
id|nfs4_proc_file_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_struct
id|dentry
op_star
id|dentry
op_assign
id|filp-&gt;f_dentry
suffix:semicolon
r_struct
id|nfs_open_context
op_star
id|ctx
suffix:semicolon
r_struct
id|nfs4_state
op_star
id|state
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|rpc_cred
op_star
id|cred
suffix:semicolon
r_int
id|status
op_assign
op_minus
id|ENOMEM
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;nfs4_proc_file_open: starting on (%.*s/%.*s)&bslash;n&quot;
comma
(paren
r_int
)paren
id|dentry-&gt;d_parent-&gt;d_name.len
comma
id|dentry-&gt;d_parent-&gt;d_name.name
comma
(paren
r_int
)paren
id|dentry-&gt;d_name.len
comma
id|dentry-&gt;d_name.name
)paren
suffix:semicolon
multiline_comment|/* Find our open stateid */
id|cred
op_assign
id|rpcauth_lookupcred
c_func
(paren
id|NFS_SERVER
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|client-&gt;cl_auth
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|cred
)paren
)paren
r_return
id|PTR_ERR
c_func
(paren
id|cred
)paren
suffix:semicolon
id|ctx
op_assign
id|alloc_nfs_open_context
c_func
(paren
id|dentry
comma
id|cred
)paren
suffix:semicolon
id|put_rpccred
c_func
(paren
id|cred
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|ctx
op_eq
l_int|NULL
)paren
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|status
op_assign
op_minus
id|EIO
suffix:semicolon
multiline_comment|/* ERACE actually */
id|state
op_assign
id|nfs4_find_state
c_func
(paren
id|inode
comma
id|cred
comma
id|filp-&gt;f_mode
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unlikely
c_func
(paren
id|state
op_eq
l_int|NULL
)paren
)paren
r_goto
id|no_state
suffix:semicolon
id|ctx-&gt;state
op_assign
id|state
suffix:semicolon
id|nfs4_close_state
c_func
(paren
id|state
comma
id|filp-&gt;f_mode
)paren
suffix:semicolon
id|ctx-&gt;mode
op_assign
id|filp-&gt;f_mode
suffix:semicolon
id|nfs_file_set_open_context
c_func
(paren
id|filp
comma
id|ctx
)paren
suffix:semicolon
id|put_nfs_open_context
c_func
(paren
id|ctx
)paren
suffix:semicolon
r_if
c_cond
(paren
id|filp-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
id|nfs_begin_data_update
c_func
(paren
id|inode
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|no_state
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;NFS: v4 raced in function %s&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
id|put_nfs_open_context
c_func
(paren
id|ctx
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
multiline_comment|/*&n; * Release our state&n; */
r_static
r_int
DECL|function|nfs4_proc_file_release
id|nfs4_proc_file_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_if
c_cond
(paren
id|filp-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
id|nfs_end_data_update
c_func
(paren
id|inode
)paren
suffix:semicolon
id|nfs_file_clear_open_context
c_func
(paren
id|filp
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|nfs4_async_handle_error
id|nfs4_async_handle_error
c_func
(paren
r_struct
id|rpc_task
op_star
id|task
comma
r_struct
id|nfs_server
op_star
id|server
)paren
(brace
r_struct
id|nfs4_client
op_star
id|clp
op_assign
id|server-&gt;nfs4_state
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|clp
op_logical_or
id|task-&gt;tk_status
op_ge
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|task-&gt;tk_status
)paren
(brace
r_case
op_minus
id|NFS4ERR_STALE_CLIENTID
suffix:colon
r_case
op_minus
id|NFS4ERR_STALE_STATEID
suffix:colon
r_case
op_minus
id|NFS4ERR_EXPIRED
suffix:colon
id|rpc_sleep_on
c_func
(paren
op_amp
id|clp-&gt;cl_rpcwaitq
comma
id|task
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
id|nfs4_schedule_state_recovery
c_func
(paren
id|clp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|NFS4CLNT_OK
comma
op_amp
id|clp-&gt;cl_state
)paren
)paren
id|rpc_wake_up_task
c_func
(paren
id|task
)paren
suffix:semicolon
id|task-&gt;tk_status
op_assign
l_int|0
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
r_case
op_minus
id|NFS4ERR_GRACE
suffix:colon
r_case
op_minus
id|NFS4ERR_DELAY
suffix:colon
id|rpc_delay
c_func
(paren
id|task
comma
id|NFS4_POLL_RETRY_MAX
)paren
suffix:semicolon
id|task-&gt;tk_status
op_assign
l_int|0
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
r_case
op_minus
id|NFS4ERR_OLD_STATEID
suffix:colon
id|task-&gt;tk_status
op_assign
l_int|0
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
id|task-&gt;tk_status
op_assign
id|nfs4_map_errors
c_func
(paren
id|task-&gt;tk_status
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|nfs4_wait_clnt_recover
r_static
r_int
id|nfs4_wait_clnt_recover
c_func
(paren
r_struct
id|rpc_clnt
op_star
id|clnt
comma
r_struct
id|nfs4_client
op_star
id|clp
)paren
(brace
id|DEFINE_WAIT
c_func
(paren
id|wait
)paren
suffix:semicolon
id|sigset_t
id|oldset
suffix:semicolon
r_int
id|interruptible
comma
id|res
op_assign
l_int|0
suffix:semicolon
id|might_sleep
c_func
(paren
)paren
suffix:semicolon
id|rpc_clnt_sigmask
c_func
(paren
id|clnt
comma
op_amp
id|oldset
)paren
suffix:semicolon
id|interruptible
op_assign
id|TASK_UNINTERRUPTIBLE
suffix:semicolon
r_if
c_cond
(paren
id|clnt-&gt;cl_intr
)paren
id|interruptible
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
id|prepare_to_wait
c_func
(paren
op_amp
id|clp-&gt;cl_waitq
comma
op_amp
id|wait
comma
id|interruptible
)paren
suffix:semicolon
id|nfs4_schedule_state_recovery
c_func
(paren
id|clp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|clnt-&gt;cl_intr
op_logical_and
id|signalled
c_func
(paren
)paren
)paren
id|res
op_assign
op_minus
id|ERESTARTSYS
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|test_bit
c_func
(paren
id|NFS4CLNT_OK
comma
op_amp
id|clp-&gt;cl_state
)paren
)paren
id|schedule
c_func
(paren
)paren
suffix:semicolon
id|finish_wait
c_func
(paren
op_amp
id|clp-&gt;cl_waitq
comma
op_amp
id|wait
)paren
suffix:semicolon
id|rpc_clnt_sigunmask
c_func
(paren
id|clnt
comma
op_amp
id|oldset
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
DECL|function|nfs4_delay
r_static
r_int
id|nfs4_delay
c_func
(paren
r_struct
id|rpc_clnt
op_star
id|clnt
comma
r_int
op_star
id|timeout
)paren
(brace
id|sigset_t
id|oldset
suffix:semicolon
r_int
id|res
op_assign
l_int|0
suffix:semicolon
id|might_sleep
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|timeout
op_le
l_int|0
)paren
op_star
id|timeout
op_assign
id|NFS4_POLL_RETRY_MIN
suffix:semicolon
r_if
c_cond
(paren
op_star
id|timeout
OG
id|NFS4_POLL_RETRY_MAX
)paren
op_star
id|timeout
op_assign
id|NFS4_POLL_RETRY_MAX
suffix:semicolon
id|rpc_clnt_sigmask
c_func
(paren
id|clnt
comma
op_amp
id|oldset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|clnt-&gt;cl_intr
)paren
(brace
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
op_star
id|timeout
)paren
suffix:semicolon
r_if
c_cond
(paren
id|signalled
c_func
(paren
)paren
)paren
id|res
op_assign
op_minus
id|ERESTARTSYS
suffix:semicolon
)brace
r_else
(brace
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
op_star
id|timeout
)paren
suffix:semicolon
)brace
id|rpc_clnt_sigunmask
c_func
(paren
id|clnt
comma
op_amp
id|oldset
)paren
suffix:semicolon
op_star
id|timeout
op_lshift_assign
l_int|1
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
multiline_comment|/* This is the error handling routine for processes that are allowed&n; * to sleep.&n; */
DECL|function|nfs4_handle_exception
r_int
id|nfs4_handle_exception
c_func
(paren
r_struct
id|nfs_server
op_star
id|server
comma
r_int
id|errorcode
comma
r_struct
id|nfs4_exception
op_star
id|exception
)paren
(brace
r_struct
id|nfs4_client
op_star
id|clp
op_assign
id|server-&gt;nfs4_state
suffix:semicolon
r_int
id|ret
op_assign
id|errorcode
suffix:semicolon
id|exception-&gt;retry
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|errorcode
)paren
(brace
r_case
l_int|0
suffix:colon
r_return
l_int|0
suffix:semicolon
r_case
op_minus
id|NFS4ERR_STALE_CLIENTID
suffix:colon
r_case
op_minus
id|NFS4ERR_STALE_STATEID
suffix:colon
r_case
op_minus
id|NFS4ERR_EXPIRED
suffix:colon
id|ret
op_assign
id|nfs4_wait_clnt_recover
c_func
(paren
id|server-&gt;client
comma
id|clp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
l_int|0
)paren
id|exception-&gt;retry
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
op_minus
id|NFS4ERR_GRACE
suffix:colon
r_case
op_minus
id|NFS4ERR_DELAY
suffix:colon
id|ret
op_assign
id|nfs4_delay
c_func
(paren
id|server-&gt;client
comma
op_amp
id|exception-&gt;timeout
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
l_int|0
)paren
id|exception-&gt;retry
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
r_case
op_minus
id|NFS4ERR_OLD_STATEID
suffix:colon
r_if
c_cond
(paren
id|ret
op_eq
l_int|0
)paren
id|exception-&gt;retry
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* We failed to handle the error */
r_return
id|nfs4_map_errors
c_func
(paren
id|ret
)paren
suffix:semicolon
)brace
DECL|function|nfs4_proc_setclientid
r_int
id|nfs4_proc_setclientid
c_func
(paren
r_struct
id|nfs4_client
op_star
id|clp
comma
id|u32
id|program
comma
r_int
r_int
id|port
)paren
(brace
id|nfs4_verifier
id|sc_verifier
suffix:semicolon
r_struct
id|nfs4_setclientid
id|setclientid
op_assign
(brace
dot
id|sc_verifier
op_assign
op_amp
id|sc_verifier
comma
dot
id|sc_prog
op_assign
id|program
comma
)brace
suffix:semicolon
r_struct
id|rpc_message
id|msg
op_assign
(brace
dot
id|rpc_proc
op_assign
op_amp
id|nfs4_procedures
(braket
id|NFSPROC4_CLNT_SETCLIENTID
)braket
comma
dot
id|rpc_argp
op_assign
op_amp
id|setclientid
comma
dot
id|rpc_resp
op_assign
id|clp
comma
dot
id|rpc_cred
op_assign
id|clp-&gt;cl_cred
comma
)brace
suffix:semicolon
id|u32
op_star
id|p
suffix:semicolon
r_int
id|loop
op_assign
l_int|0
suffix:semicolon
r_int
id|status
suffix:semicolon
id|p
op_assign
(paren
id|u32
op_star
)paren
id|sc_verifier.data
suffix:semicolon
op_star
id|p
op_increment
op_assign
id|htonl
c_func
(paren
(paren
id|u32
)paren
id|clp-&gt;cl_boot_time.tv_sec
)paren
suffix:semicolon
op_star
id|p
op_assign
id|htonl
c_func
(paren
(paren
id|u32
)paren
id|clp-&gt;cl_boot_time.tv_nsec
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|setclientid.sc_name_len
op_assign
id|scnprintf
c_func
(paren
id|setclientid.sc_name
comma
r_sizeof
(paren
id|setclientid.sc_name
)paren
comma
l_string|&quot;%s/%u.%u.%u.%u %s %u&quot;
comma
id|clp-&gt;cl_ipaddr
comma
id|NIPQUAD
c_func
(paren
id|clp-&gt;cl_addr.s_addr
)paren
comma
id|clp-&gt;cl_cred-&gt;cr_ops-&gt;cr_name
comma
id|clp-&gt;cl_id_uniquifier
)paren
suffix:semicolon
id|setclientid.sc_netid_len
op_assign
id|scnprintf
c_func
(paren
id|setclientid.sc_netid
comma
r_sizeof
(paren
id|setclientid.sc_netid
)paren
comma
l_string|&quot;tcp&quot;
)paren
suffix:semicolon
id|setclientid.sc_uaddr_len
op_assign
id|scnprintf
c_func
(paren
id|setclientid.sc_uaddr
comma
r_sizeof
(paren
id|setclientid.sc_uaddr
)paren
comma
l_string|&quot;%s.%d.%d&quot;
comma
id|clp-&gt;cl_ipaddr
comma
id|port
op_rshift
l_int|8
comma
id|port
op_amp
l_int|255
)paren
suffix:semicolon
id|status
op_assign
id|rpc_call_sync
c_func
(paren
id|clp-&gt;cl_rpcclient
comma
op_amp
id|msg
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_ne
op_minus
id|NFS4ERR_CLID_INUSE
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|signalled
c_func
(paren
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|loop
op_increment
op_amp
l_int|1
)paren
id|ssleep
c_func
(paren
id|clp-&gt;cl_lease_time
op_plus
l_int|1
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
op_increment
id|clp-&gt;cl_id_uniquifier
op_eq
l_int|0
)paren
r_break
suffix:semicolon
)brace
r_return
id|status
suffix:semicolon
)brace
r_int
DECL|function|nfs4_proc_setclientid_confirm
id|nfs4_proc_setclientid_confirm
c_func
(paren
r_struct
id|nfs4_client
op_star
id|clp
)paren
(brace
r_struct
id|nfs_fsinfo
id|fsinfo
suffix:semicolon
r_struct
id|rpc_message
id|msg
op_assign
(brace
dot
id|rpc_proc
op_assign
op_amp
id|nfs4_procedures
(braket
id|NFSPROC4_CLNT_SETCLIENTID_CONFIRM
)braket
comma
dot
id|rpc_argp
op_assign
id|clp
comma
dot
id|rpc_resp
op_assign
op_amp
id|fsinfo
comma
dot
id|rpc_cred
op_assign
id|clp-&gt;cl_cred
comma
)brace
suffix:semicolon
r_int
r_int
id|now
suffix:semicolon
r_int
id|status
suffix:semicolon
id|now
op_assign
id|jiffies
suffix:semicolon
id|status
op_assign
id|rpc_call_sync
c_func
(paren
id|clp-&gt;cl_rpcclient
comma
op_amp
id|msg
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_eq
l_int|0
)paren
(brace
id|spin_lock
c_func
(paren
op_amp
id|clp-&gt;cl_lock
)paren
suffix:semicolon
id|clp-&gt;cl_lease_time
op_assign
id|fsinfo.lease_time
op_star
id|HZ
suffix:semicolon
id|clp-&gt;cl_last_renewal
op_assign
id|now
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|clp-&gt;cl_lock
)paren
suffix:semicolon
)brace
r_return
id|status
suffix:semicolon
)brace
DECL|function|_nfs4_proc_delegreturn
r_static
r_int
id|_nfs4_proc_delegreturn
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|rpc_cred
op_star
id|cred
comma
r_const
id|nfs4_stateid
op_star
id|stateid
)paren
(brace
r_struct
id|nfs4_delegreturnargs
id|args
op_assign
(brace
dot
id|fhandle
op_assign
id|NFS_FH
c_func
(paren
id|inode
)paren
comma
dot
id|stateid
op_assign
id|stateid
comma
)brace
suffix:semicolon
r_struct
id|rpc_message
id|msg
op_assign
(brace
dot
id|rpc_proc
op_assign
op_amp
id|nfs4_procedures
(braket
id|NFSPROC4_CLNT_DELEGRETURN
)braket
comma
dot
id|rpc_argp
op_assign
op_amp
id|args
comma
dot
id|rpc_cred
op_assign
id|cred
comma
)brace
suffix:semicolon
r_return
id|rpc_call_sync
c_func
(paren
id|NFS_CLIENT
c_func
(paren
id|inode
)paren
comma
op_amp
id|msg
comma
l_int|0
)paren
suffix:semicolon
)brace
DECL|function|nfs4_proc_delegreturn
r_int
id|nfs4_proc_delegreturn
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|rpc_cred
op_star
id|cred
comma
r_const
id|nfs4_stateid
op_star
id|stateid
)paren
(brace
r_struct
id|nfs_server
op_star
id|server
op_assign
id|NFS_SERVER
c_func
(paren
id|inode
)paren
suffix:semicolon
r_struct
id|nfs4_exception
id|exception
op_assign
(brace
)brace
suffix:semicolon
r_int
id|err
suffix:semicolon
r_do
(brace
id|err
op_assign
id|_nfs4_proc_delegreturn
c_func
(paren
id|inode
comma
id|cred
comma
id|stateid
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|err
)paren
(brace
r_case
op_minus
id|NFS4ERR_STALE_STATEID
suffix:colon
r_case
op_minus
id|NFS4ERR_EXPIRED
suffix:colon
id|nfs4_schedule_state_recovery
c_func
(paren
id|server-&gt;nfs4_state
)paren
suffix:semicolon
r_case
l_int|0
suffix:colon
r_return
l_int|0
suffix:semicolon
)brace
id|err
op_assign
id|nfs4_handle_exception
c_func
(paren
id|server
comma
id|err
comma
op_amp
id|exception
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|exception.retry
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|macro|NFS4_LOCK_MINTIMEOUT
mdefine_line|#define NFS4_LOCK_MINTIMEOUT (1 * HZ)
DECL|macro|NFS4_LOCK_MAXTIMEOUT
mdefine_line|#define NFS4_LOCK_MAXTIMEOUT (30 * HZ)
multiline_comment|/* &n; * sleep, with exponential backoff, and retry the LOCK operation. &n; */
r_static
r_int
r_int
DECL|function|nfs4_set_lock_task_retry
id|nfs4_set_lock_task_retry
c_func
(paren
r_int
r_int
id|timeout
)paren
(brace
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|timeout
)paren
suffix:semicolon
id|timeout
op_lshift_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|timeout
OG
id|NFS4_LOCK_MAXTIMEOUT
)paren
r_return
id|NFS4_LOCK_MAXTIMEOUT
suffix:semicolon
r_return
id|timeout
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|nfs4_lck_type
id|nfs4_lck_type
c_func
(paren
r_int
id|cmd
comma
r_struct
id|file_lock
op_star
id|request
)paren
(brace
multiline_comment|/* set lock type */
r_switch
c_cond
(paren
id|request-&gt;fl_type
)paren
(brace
r_case
id|F_RDLCK
suffix:colon
r_return
id|IS_SETLKW
c_func
(paren
id|cmd
)paren
ques
c_cond
id|NFS4_READW_LT
suffix:colon
id|NFS4_READ_LT
suffix:semicolon
r_case
id|F_WRLCK
suffix:colon
r_return
id|IS_SETLKW
c_func
(paren
id|cmd
)paren
ques
c_cond
id|NFS4_WRITEW_LT
suffix:colon
id|NFS4_WRITE_LT
suffix:semicolon
r_case
id|F_UNLCK
suffix:colon
r_return
id|NFS4_WRITE_LT
suffix:semicolon
)brace
id|BUG
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_inline
r_uint64
DECL|function|nfs4_lck_length
id|nfs4_lck_length
c_func
(paren
r_struct
id|file_lock
op_star
id|request
)paren
(brace
r_if
c_cond
(paren
id|request-&gt;fl_end
op_eq
id|OFFSET_MAX
)paren
r_return
op_complement
(paren
r_uint64
)paren
l_int|0
suffix:semicolon
r_return
id|request-&gt;fl_end
op_minus
id|request-&gt;fl_start
op_plus
l_int|1
suffix:semicolon
)brace
DECL|function|_nfs4_proc_getlk
r_static
r_int
id|_nfs4_proc_getlk
c_func
(paren
r_struct
id|nfs4_state
op_star
id|state
comma
r_int
id|cmd
comma
r_struct
id|file_lock
op_star
id|request
)paren
(brace
r_struct
id|inode
op_star
id|inode
op_assign
id|state-&gt;inode
suffix:semicolon
r_struct
id|nfs_server
op_star
id|server
op_assign
id|NFS_SERVER
c_func
(paren
id|inode
)paren
suffix:semicolon
r_struct
id|nfs4_client
op_star
id|clp
op_assign
id|server-&gt;nfs4_state
suffix:semicolon
r_struct
id|nfs_lockargs
id|arg
op_assign
(brace
dot
id|fh
op_assign
id|NFS_FH
c_func
(paren
id|inode
)paren
comma
dot
id|type
op_assign
id|nfs4_lck_type
c_func
(paren
id|cmd
comma
id|request
)paren
comma
dot
id|offset
op_assign
id|request-&gt;fl_start
comma
dot
id|length
op_assign
id|nfs4_lck_length
c_func
(paren
id|request
)paren
comma
)brace
suffix:semicolon
r_struct
id|nfs_lockres
id|res
op_assign
(brace
dot
id|server
op_assign
id|server
comma
)brace
suffix:semicolon
r_struct
id|rpc_message
id|msg
op_assign
(brace
dot
id|rpc_proc
op_assign
op_amp
id|nfs4_procedures
(braket
id|NFSPROC4_CLNT_LOCKT
)braket
comma
dot
id|rpc_argp
op_assign
op_amp
id|arg
comma
dot
id|rpc_resp
op_assign
op_amp
id|res
comma
dot
id|rpc_cred
op_assign
id|state-&gt;owner-&gt;so_cred
comma
)brace
suffix:semicolon
r_struct
id|nfs_lowner
id|nlo
suffix:semicolon
r_struct
id|nfs4_lock_state
op_star
id|lsp
suffix:semicolon
r_int
id|status
suffix:semicolon
id|down_read
c_func
(paren
op_amp
id|clp-&gt;cl_sem
)paren
suffix:semicolon
id|nlo.clientid
op_assign
id|clp-&gt;cl_clientid
suffix:semicolon
id|down
c_func
(paren
op_amp
id|state-&gt;lock_sema
)paren
suffix:semicolon
id|lsp
op_assign
id|nfs4_find_lock_state
c_func
(paren
id|state
comma
id|request-&gt;fl_owner
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lsp
)paren
id|nlo.id
op_assign
id|lsp-&gt;ls_id
suffix:semicolon
r_else
(brace
id|spin_lock
c_func
(paren
op_amp
id|clp-&gt;cl_lock
)paren
suffix:semicolon
id|nlo.id
op_assign
id|nfs4_alloc_lockowner_id
c_func
(paren
id|clp
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|clp-&gt;cl_lock
)paren
suffix:semicolon
)brace
id|arg.u.lockt
op_assign
op_amp
id|nlo
suffix:semicolon
id|status
op_assign
id|rpc_call_sync
c_func
(paren
id|server-&gt;client
comma
op_amp
id|msg
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|status
)paren
(brace
id|request-&gt;fl_type
op_assign
id|F_UNLCK
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|status
op_eq
op_minus
id|NFS4ERR_DENIED
)paren
(brace
r_int64
id|len
comma
id|start
comma
id|end
suffix:semicolon
id|start
op_assign
id|res.u.denied.offset
suffix:semicolon
id|len
op_assign
id|res.u.denied.length
suffix:semicolon
id|end
op_assign
id|start
op_plus
id|len
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|end
OL
l_int|0
op_logical_or
id|len
op_eq
l_int|0
)paren
id|request-&gt;fl_end
op_assign
id|OFFSET_MAX
suffix:semicolon
r_else
id|request-&gt;fl_end
op_assign
(paren
id|loff_t
)paren
id|end
suffix:semicolon
id|request-&gt;fl_start
op_assign
(paren
id|loff_t
)paren
id|start
suffix:semicolon
id|request-&gt;fl_type
op_assign
id|F_WRLCK
suffix:semicolon
r_if
c_cond
(paren
id|res.u.denied.type
op_amp
l_int|1
)paren
id|request-&gt;fl_type
op_assign
id|F_RDLCK
suffix:semicolon
id|request-&gt;fl_pid
op_assign
l_int|0
suffix:semicolon
id|status
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|lsp
)paren
id|nfs4_put_lock_state
c_func
(paren
id|lsp
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|state-&gt;lock_sema
)paren
suffix:semicolon
id|up_read
c_func
(paren
op_amp
id|clp-&gt;cl_sem
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
DECL|function|nfs4_proc_getlk
r_static
r_int
id|nfs4_proc_getlk
c_func
(paren
r_struct
id|nfs4_state
op_star
id|state
comma
r_int
id|cmd
comma
r_struct
id|file_lock
op_star
id|request
)paren
(brace
r_struct
id|nfs4_exception
id|exception
op_assign
(brace
)brace
suffix:semicolon
r_int
id|err
suffix:semicolon
r_do
(brace
id|err
op_assign
id|nfs4_handle_exception
c_func
(paren
id|NFS_SERVER
c_func
(paren
id|state-&gt;inode
)paren
comma
id|_nfs4_proc_getlk
c_func
(paren
id|state
comma
id|cmd
comma
id|request
)paren
comma
op_amp
id|exception
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|exception.retry
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|do_vfs_lock
r_static
r_int
id|do_vfs_lock
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_struct
id|file_lock
op_star
id|fl
)paren
(brace
r_int
id|res
op_assign
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|fl-&gt;fl_flags
op_amp
(paren
id|FL_POSIX
op_or
id|FL_FLOCK
)paren
)paren
(brace
r_case
id|FL_POSIX
suffix:colon
id|res
op_assign
id|posix_lock_file_wait
c_func
(paren
id|file
comma
id|fl
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|FL_FLOCK
suffix:colon
id|res
op_assign
id|flock_lock_file_wait
c_func
(paren
id|file
comma
id|fl
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|BUG
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|res
OL
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: VFS is out of sync with lock manager!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
DECL|function|_nfs4_proc_unlck
r_static
r_int
id|_nfs4_proc_unlck
c_func
(paren
r_struct
id|nfs4_state
op_star
id|state
comma
r_int
id|cmd
comma
r_struct
id|file_lock
op_star
id|request
)paren
(brace
r_struct
id|inode
op_star
id|inode
op_assign
id|state-&gt;inode
suffix:semicolon
r_struct
id|nfs_server
op_star
id|server
op_assign
id|NFS_SERVER
c_func
(paren
id|inode
)paren
suffix:semicolon
r_struct
id|nfs4_client
op_star
id|clp
op_assign
id|server-&gt;nfs4_state
suffix:semicolon
r_struct
id|nfs_lockargs
id|arg
op_assign
(brace
dot
id|fh
op_assign
id|NFS_FH
c_func
(paren
id|inode
)paren
comma
dot
id|type
op_assign
id|nfs4_lck_type
c_func
(paren
id|cmd
comma
id|request
)paren
comma
dot
id|offset
op_assign
id|request-&gt;fl_start
comma
dot
id|length
op_assign
id|nfs4_lck_length
c_func
(paren
id|request
)paren
comma
)brace
suffix:semicolon
r_struct
id|nfs_lockres
id|res
op_assign
(brace
dot
id|server
op_assign
id|server
comma
)brace
suffix:semicolon
r_struct
id|rpc_message
id|msg
op_assign
(brace
dot
id|rpc_proc
op_assign
op_amp
id|nfs4_procedures
(braket
id|NFSPROC4_CLNT_LOCKU
)braket
comma
dot
id|rpc_argp
op_assign
op_amp
id|arg
comma
dot
id|rpc_resp
op_assign
op_amp
id|res
comma
dot
id|rpc_cred
op_assign
id|state-&gt;owner-&gt;so_cred
comma
)brace
suffix:semicolon
r_struct
id|nfs4_lock_state
op_star
id|lsp
suffix:semicolon
r_struct
id|nfs_locku_opargs
id|luargs
suffix:semicolon
r_int
id|status
op_assign
l_int|0
suffix:semicolon
id|down_read
c_func
(paren
op_amp
id|clp-&gt;cl_sem
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|state-&gt;lock_sema
)paren
suffix:semicolon
id|lsp
op_assign
id|nfs4_find_lock_state
c_func
(paren
id|state
comma
id|request-&gt;fl_owner
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|lsp
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* We might have lost the locks! */
r_if
c_cond
(paren
(paren
id|lsp-&gt;ls_flags
op_amp
id|NFS_LOCK_INITIALIZED
)paren
op_ne
l_int|0
)paren
(brace
id|luargs.seqid
op_assign
id|lsp-&gt;ls_seqid
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|luargs.stateid
comma
op_amp
id|lsp-&gt;ls_stateid
comma
r_sizeof
(paren
id|luargs.stateid
)paren
)paren
suffix:semicolon
id|arg.u.locku
op_assign
op_amp
id|luargs
suffix:semicolon
id|status
op_assign
id|rpc_call_sync
c_func
(paren
id|server-&gt;client
comma
op_amp
id|msg
comma
id|RPC_TASK_NOINTR
)paren
suffix:semicolon
id|nfs4_increment_lock_seqid
c_func
(paren
id|status
comma
id|lsp
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|status
op_eq
l_int|0
)paren
(brace
id|memcpy
c_func
(paren
op_amp
id|lsp-&gt;ls_stateid
comma
op_amp
id|res.u.stateid
comma
r_sizeof
(paren
id|lsp-&gt;ls_stateid
)paren
)paren
suffix:semicolon
id|nfs4_notify_unlck
c_func
(paren
id|state
comma
id|request
comma
id|lsp
)paren
suffix:semicolon
)brace
id|nfs4_put_lock_state
c_func
(paren
id|lsp
)paren
suffix:semicolon
id|out
suffix:colon
id|up
c_func
(paren
op_amp
id|state-&gt;lock_sema
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_eq
l_int|0
)paren
id|do_vfs_lock
c_func
(paren
id|request-&gt;fl_file
comma
id|request
)paren
suffix:semicolon
id|up_read
c_func
(paren
op_amp
id|clp-&gt;cl_sem
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
DECL|function|nfs4_proc_unlck
r_static
r_int
id|nfs4_proc_unlck
c_func
(paren
r_struct
id|nfs4_state
op_star
id|state
comma
r_int
id|cmd
comma
r_struct
id|file_lock
op_star
id|request
)paren
(brace
r_struct
id|nfs4_exception
id|exception
op_assign
(brace
)brace
suffix:semicolon
r_int
id|err
suffix:semicolon
r_do
(brace
id|err
op_assign
id|nfs4_handle_exception
c_func
(paren
id|NFS_SERVER
c_func
(paren
id|state-&gt;inode
)paren
comma
id|_nfs4_proc_unlck
c_func
(paren
id|state
comma
id|cmd
comma
id|request
)paren
comma
op_amp
id|exception
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|exception.retry
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|_nfs4_do_setlk
r_static
r_int
id|_nfs4_do_setlk
c_func
(paren
r_struct
id|nfs4_state
op_star
id|state
comma
r_int
id|cmd
comma
r_struct
id|file_lock
op_star
id|request
comma
r_int
id|reclaim
)paren
(brace
r_struct
id|inode
op_star
id|inode
op_assign
id|state-&gt;inode
suffix:semicolon
r_struct
id|nfs_server
op_star
id|server
op_assign
id|NFS_SERVER
c_func
(paren
id|inode
)paren
suffix:semicolon
r_struct
id|nfs4_lock_state
op_star
id|lsp
suffix:semicolon
r_struct
id|nfs_lockargs
id|arg
op_assign
(brace
dot
id|fh
op_assign
id|NFS_FH
c_func
(paren
id|inode
)paren
comma
dot
id|type
op_assign
id|nfs4_lck_type
c_func
(paren
id|cmd
comma
id|request
)paren
comma
dot
id|offset
op_assign
id|request-&gt;fl_start
comma
dot
id|length
op_assign
id|nfs4_lck_length
c_func
(paren
id|request
)paren
comma
)brace
suffix:semicolon
r_struct
id|nfs_lockres
id|res
op_assign
(brace
dot
id|server
op_assign
id|server
comma
)brace
suffix:semicolon
r_struct
id|rpc_message
id|msg
op_assign
(brace
dot
id|rpc_proc
op_assign
op_amp
id|nfs4_procedures
(braket
id|NFSPROC4_CLNT_LOCK
)braket
comma
dot
id|rpc_argp
op_assign
op_amp
id|arg
comma
dot
id|rpc_resp
op_assign
op_amp
id|res
comma
dot
id|rpc_cred
op_assign
id|state-&gt;owner-&gt;so_cred
comma
)brace
suffix:semicolon
r_struct
id|nfs_lock_opargs
id|largs
op_assign
(brace
dot
id|reclaim
op_assign
id|reclaim
comma
dot
id|new_lock_owner
op_assign
l_int|0
comma
)brace
suffix:semicolon
r_int
id|status
suffix:semicolon
id|lsp
op_assign
id|nfs4_get_lock_state
c_func
(paren
id|state
comma
id|request-&gt;fl_owner
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lsp
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|lsp-&gt;ls_flags
op_amp
id|NFS_LOCK_INITIALIZED
)paren
)paren
(brace
r_struct
id|nfs4_state_owner
op_star
id|owner
op_assign
id|state-&gt;owner
suffix:semicolon
r_struct
id|nfs_open_to_lock
id|otl
op_assign
(brace
dot
id|lock_owner
op_assign
(brace
dot
id|clientid
op_assign
id|server-&gt;nfs4_state-&gt;cl_clientid
comma
)brace
comma
)brace
suffix:semicolon
id|otl.lock_seqid
op_assign
id|lsp-&gt;ls_seqid
suffix:semicolon
id|otl.lock_owner.id
op_assign
id|lsp-&gt;ls_id
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|otl.open_stateid
comma
op_amp
id|state-&gt;stateid
comma
r_sizeof
(paren
id|otl.open_stateid
)paren
)paren
suffix:semicolon
id|largs.u.open_lock
op_assign
op_amp
id|otl
suffix:semicolon
id|largs.new_lock_owner
op_assign
l_int|1
suffix:semicolon
id|arg.u.lock
op_assign
op_amp
id|largs
suffix:semicolon
id|down
c_func
(paren
op_amp
id|owner-&gt;so_sema
)paren
suffix:semicolon
id|otl.open_seqid
op_assign
id|owner-&gt;so_seqid
suffix:semicolon
id|status
op_assign
id|rpc_call_sync
c_func
(paren
id|server-&gt;client
comma
op_amp
id|msg
comma
id|RPC_TASK_NOINTR
)paren
suffix:semicolon
multiline_comment|/* increment open_owner seqid on success, and &n;&t;&t;* seqid mutating errors */
id|nfs4_increment_seqid
c_func
(paren
id|status
comma
id|owner
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|owner-&gt;so_sema
)paren
suffix:semicolon
)brace
r_else
(brace
r_struct
id|nfs_exist_lock
id|el
op_assign
(brace
dot
id|seqid
op_assign
id|lsp-&gt;ls_seqid
comma
)brace
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|el.stateid
comma
op_amp
id|lsp-&gt;ls_stateid
comma
r_sizeof
(paren
id|el.stateid
)paren
)paren
suffix:semicolon
id|largs.u.exist_lock
op_assign
op_amp
id|el
suffix:semicolon
id|largs.new_lock_owner
op_assign
l_int|0
suffix:semicolon
id|arg.u.lock
op_assign
op_amp
id|largs
suffix:semicolon
id|status
op_assign
id|rpc_call_sync
c_func
(paren
id|server-&gt;client
comma
op_amp
id|msg
comma
id|RPC_TASK_NOINTR
)paren
suffix:semicolon
)brace
multiline_comment|/* increment seqid on success, and * seqid mutating errors*/
id|nfs4_increment_lock_seqid
c_func
(paren
id|status
comma
id|lsp
)paren
suffix:semicolon
multiline_comment|/* save the returned stateid. */
r_if
c_cond
(paren
id|status
op_eq
l_int|0
)paren
(brace
id|memcpy
c_func
(paren
op_amp
id|lsp-&gt;ls_stateid
comma
op_amp
id|res.u.stateid
comma
r_sizeof
(paren
id|nfs4_stateid
)paren
)paren
suffix:semicolon
id|lsp-&gt;ls_flags
op_or_assign
id|NFS_LOCK_INITIALIZED
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|reclaim
)paren
id|nfs4_notify_setlk
c_func
(paren
id|state
comma
id|request
comma
id|lsp
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|status
op_eq
op_minus
id|NFS4ERR_DENIED
)paren
id|status
op_assign
op_minus
id|EAGAIN
suffix:semicolon
id|nfs4_put_lock_state
c_func
(paren
id|lsp
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
DECL|function|nfs4_lock_reclaim
r_int
id|nfs4_lock_reclaim
c_func
(paren
r_struct
id|nfs4_state
op_star
id|state
comma
r_struct
id|file_lock
op_star
id|request
)paren
(brace
r_return
id|_nfs4_do_setlk
c_func
(paren
id|state
comma
id|F_SETLK
comma
id|request
comma
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|_nfs4_proc_setlk
r_static
r_int
id|_nfs4_proc_setlk
c_func
(paren
r_struct
id|nfs4_state
op_star
id|state
comma
r_int
id|cmd
comma
r_struct
id|file_lock
op_star
id|request
)paren
(brace
r_struct
id|nfs4_client
op_star
id|clp
op_assign
id|state-&gt;owner-&gt;so_client
suffix:semicolon
r_int
id|status
suffix:semicolon
id|down_read
c_func
(paren
op_amp
id|clp-&gt;cl_sem
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|state-&gt;lock_sema
)paren
suffix:semicolon
id|status
op_assign
id|_nfs4_do_setlk
c_func
(paren
id|state
comma
id|cmd
comma
id|request
comma
l_int|0
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|state-&gt;lock_sema
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_eq
l_int|0
)paren
(brace
multiline_comment|/* Note: we always want to sleep here! */
id|request-&gt;fl_flags
op_or_assign
id|FL_SLEEP
suffix:semicolon
r_if
c_cond
(paren
id|do_vfs_lock
c_func
(paren
id|request-&gt;fl_file
comma
id|request
)paren
OL
l_int|0
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;%s: VFS is out of sync with lock manager!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
)brace
id|up_read
c_func
(paren
op_amp
id|clp-&gt;cl_sem
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
DECL|function|nfs4_proc_setlk
r_static
r_int
id|nfs4_proc_setlk
c_func
(paren
r_struct
id|nfs4_state
op_star
id|state
comma
r_int
id|cmd
comma
r_struct
id|file_lock
op_star
id|request
)paren
(brace
r_struct
id|nfs4_exception
id|exception
op_assign
(brace
)brace
suffix:semicolon
r_int
id|err
suffix:semicolon
r_do
(brace
id|err
op_assign
id|nfs4_handle_exception
c_func
(paren
id|NFS_SERVER
c_func
(paren
id|state-&gt;inode
)paren
comma
id|_nfs4_proc_setlk
c_func
(paren
id|state
comma
id|cmd
comma
id|request
)paren
comma
op_amp
id|exception
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|exception.retry
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
r_static
r_int
DECL|function|nfs4_proc_lock
id|nfs4_proc_lock
c_func
(paren
r_struct
id|file
op_star
id|filp
comma
r_int
id|cmd
comma
r_struct
id|file_lock
op_star
id|request
)paren
(brace
r_struct
id|nfs_open_context
op_star
id|ctx
suffix:semicolon
r_struct
id|nfs4_state
op_star
id|state
suffix:semicolon
r_int
r_int
id|timeout
op_assign
id|NFS4_LOCK_MINTIMEOUT
suffix:semicolon
r_int
id|status
suffix:semicolon
multiline_comment|/* verify open state */
id|ctx
op_assign
(paren
r_struct
id|nfs_open_context
op_star
)paren
id|filp-&gt;private_data
suffix:semicolon
id|state
op_assign
id|ctx-&gt;state
suffix:semicolon
r_if
c_cond
(paren
id|request-&gt;fl_start
OL
l_int|0
op_logical_or
id|request-&gt;fl_end
OL
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|IS_GETLK
c_func
(paren
id|cmd
)paren
)paren
r_return
id|nfs4_proc_getlk
c_func
(paren
id|state
comma
id|F_GETLK
comma
id|request
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|IS_SETLK
c_func
(paren
id|cmd
)paren
op_logical_or
id|IS_SETLKW
c_func
(paren
id|cmd
)paren
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|request-&gt;fl_type
op_eq
id|F_UNLCK
)paren
r_return
id|nfs4_proc_unlck
c_func
(paren
id|state
comma
id|cmd
comma
id|request
)paren
suffix:semicolon
r_do
(brace
id|status
op_assign
id|nfs4_proc_setlk
c_func
(paren
id|state
comma
id|cmd
comma
id|request
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|status
op_ne
op_minus
id|EAGAIN
)paren
op_logical_or
id|IS_SETLK
c_func
(paren
id|cmd
)paren
)paren
r_break
suffix:semicolon
id|timeout
op_assign
id|nfs4_set_lock_task_retry
c_func
(paren
id|timeout
)paren
suffix:semicolon
id|status
op_assign
op_minus
id|ERESTARTSYS
suffix:semicolon
r_if
c_cond
(paren
id|signalled
c_func
(paren
)paren
)paren
r_break
suffix:semicolon
)brace
r_while
c_loop
(paren
id|status
OL
l_int|0
)paren
(brace
suffix:semicolon
)brace
r_return
id|status
suffix:semicolon
)brace
DECL|variable|nfs_v4_clientops
r_struct
id|nfs_rpc_ops
id|nfs_v4_clientops
op_assign
(brace
dot
id|version
op_assign
l_int|4
comma
multiline_comment|/* protocol version */
dot
id|dentry_ops
op_assign
op_amp
id|nfs4_dentry_operations
comma
dot
id|dir_inode_ops
op_assign
op_amp
id|nfs4_dir_inode_operations
comma
dot
id|getroot
op_assign
id|nfs4_proc_get_root
comma
dot
id|getattr
op_assign
id|nfs4_proc_getattr
comma
dot
id|setattr
op_assign
id|nfs4_proc_setattr
comma
dot
id|lookup
op_assign
id|nfs4_proc_lookup
comma
dot
id|access
op_assign
id|nfs4_proc_access
comma
dot
id|readlink
op_assign
id|nfs4_proc_readlink
comma
dot
id|read
op_assign
id|nfs4_proc_read
comma
dot
id|write
op_assign
id|nfs4_proc_write
comma
dot
id|commit
op_assign
id|nfs4_proc_commit
comma
dot
id|create
op_assign
id|nfs4_proc_create
comma
dot
id|remove
op_assign
id|nfs4_proc_remove
comma
dot
id|unlink_setup
op_assign
id|nfs4_proc_unlink_setup
comma
dot
id|unlink_done
op_assign
id|nfs4_proc_unlink_done
comma
dot
id|rename
op_assign
id|nfs4_proc_rename
comma
dot
id|link
op_assign
id|nfs4_proc_link
comma
dot
id|symlink
op_assign
id|nfs4_proc_symlink
comma
dot
id|mkdir
op_assign
id|nfs4_proc_mkdir
comma
dot
id|rmdir
op_assign
id|nfs4_proc_remove
comma
dot
id|readdir
op_assign
id|nfs4_proc_readdir
comma
dot
id|mknod
op_assign
id|nfs4_proc_mknod
comma
dot
id|statfs
op_assign
id|nfs4_proc_statfs
comma
dot
id|fsinfo
op_assign
id|nfs4_proc_fsinfo
comma
dot
id|pathconf
op_assign
id|nfs4_proc_pathconf
comma
dot
id|decode_dirent
op_assign
id|nfs4_decode_dirent
comma
dot
id|read_setup
op_assign
id|nfs4_proc_read_setup
comma
dot
id|write_setup
op_assign
id|nfs4_proc_write_setup
comma
dot
id|commit_setup
op_assign
id|nfs4_proc_commit_setup
comma
dot
id|file_open
op_assign
id|nfs4_proc_file_open
comma
dot
id|file_release
op_assign
id|nfs4_proc_file_release
comma
dot
id|lock
op_assign
id|nfs4_proc_lock
comma
)brace
suffix:semicolon
multiline_comment|/*&n; * Local variables:&n; *  c-basic-offset: 8&n; * End:&n; */
eof
