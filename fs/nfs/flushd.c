multiline_comment|/*&n; * linux/fs/nfs/flushd.c&n; *&n; * For each NFS mount, there is a separate cache object that contains&n; * a hash table of all clusters. With this cache, an async RPC task&n; * (`flushd&squot;) is associated, which wakes up occasionally to inspect&n; * its list of dirty buffers.&n; * (Note that RPC tasks aren&squot;t kernel threads. Take a look at the&n; * rpciod code to understand what they are).&n; *&n; * Inside the cache object, we also maintain a count of the current number&n; * of dirty pages, which may not exceed a certain threshold.&n; * (FIXME: This threshold should be configurable).&n; *&n; * The code is streamlined for what I think is the prevalent case for&n; * NFS traffic, which is sequential write access without concurrent&n; * access by different processes.&n; *&n; * Copyright (C) 1996, 1997, Olaf Kirch &lt;okir@monad.swb.de&gt;&n; *&n; * Rewritten 6/3/2000 by Trond Myklebust&n; * Copyright (C) 1999, 2000, Trond Myklebust &lt;trond.myklebust@fys.uio.no&gt;&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/pagemap.h&gt;
macro_line|#include &lt;linux/file.h&gt;
macro_line|#include &lt;linux/time.h&gt;
macro_line|#include &lt;linux/sunrpc/auth.h&gt;
macro_line|#include &lt;linux/sunrpc/clnt.h&gt;
macro_line|#include &lt;linux/sunrpc/sched.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/nfs.h&gt;
macro_line|#include &lt;linux/nfs_fs.h&gt;
macro_line|#include &lt;linux/nfs_page.h&gt;
macro_line|#include &lt;linux/nfs_fs_sb.h&gt;
macro_line|#include &lt;linux/nfs_flushd.h&gt;
multiline_comment|/*&n; * Various constants&n; */
DECL|macro|NFSDBG_FACILITY
mdefine_line|#define NFSDBG_FACILITY         NFSDBG_PAGECACHE
multiline_comment|/*&n; * This is the wait queue all cluster daemons sleep on&n; */
DECL|variable|flushd_queue
r_static
r_struct
id|rpc_wait_queue
id|flushd_queue
op_assign
id|RPC_INIT_WAITQ
c_func
(paren
l_string|&quot;nfs_flushd&quot;
)paren
suffix:semicolon
multiline_comment|/*&n; * Local function declarations.&n; */
r_static
r_void
id|nfs_flushd
c_func
(paren
r_struct
id|rpc_task
op_star
)paren
suffix:semicolon
r_static
r_void
id|nfs_flushd_exit
c_func
(paren
r_struct
id|rpc_task
op_star
)paren
suffix:semicolon
DECL|function|nfs_reqlist_init
r_int
id|nfs_reqlist_init
c_func
(paren
r_struct
id|nfs_server
op_star
id|server
)paren
(brace
r_struct
id|nfs_reqlist
op_star
id|cache
suffix:semicolon
r_struct
id|rpc_task
op_star
id|task
suffix:semicolon
r_int
id|status
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;NFS: writecache_init&bslash;n&quot;
)paren
suffix:semicolon
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
id|status
op_assign
op_minus
id|ENOMEM
suffix:semicolon
multiline_comment|/* Create the RPC task */
r_if
c_cond
(paren
op_logical_neg
(paren
id|task
op_assign
id|rpc_new_task
c_func
(paren
id|server-&gt;client
comma
l_int|NULL
comma
id|RPC_TASK_ASYNC
)paren
)paren
)paren
r_goto
id|out_unlock
suffix:semicolon
id|cache
op_assign
id|server-&gt;rw_requests
suffix:semicolon
id|status
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|cache-&gt;task
)paren
r_goto
id|out_unlock
suffix:semicolon
id|task-&gt;tk_calldata
op_assign
id|server
suffix:semicolon
id|cache-&gt;task
op_assign
id|task
suffix:semicolon
multiline_comment|/* Run the task */
id|cache-&gt;runat
op_assign
id|jiffies
suffix:semicolon
id|cache-&gt;auth
op_assign
id|server-&gt;client-&gt;cl_auth
suffix:semicolon
id|task-&gt;tk_action
op_assign
id|nfs_flushd
suffix:semicolon
id|task-&gt;tk_exit
op_assign
id|nfs_flushd_exit
suffix:semicolon
id|rpc_execute
c_func
(paren
id|task
)paren
suffix:semicolon
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|out_unlock
suffix:colon
r_if
c_cond
(paren
id|task
)paren
id|rpc_release_task
c_func
(paren
id|task
)paren
suffix:semicolon
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
DECL|function|nfs_reqlist_exit
r_void
id|nfs_reqlist_exit
c_func
(paren
r_struct
id|nfs_server
op_star
id|server
)paren
(brace
r_struct
id|nfs_reqlist
op_star
id|cache
suffix:semicolon
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
id|cache
op_assign
id|server-&gt;rw_requests
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cache
)paren
r_goto
id|out
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;NFS: reqlist_exit (ptr %p rpc %p)&bslash;n&quot;
comma
id|cache
comma
id|cache-&gt;task
)paren
suffix:semicolon
r_while
c_loop
(paren
id|cache-&gt;task
)paren
(brace
id|rpc_exit
c_func
(paren
id|cache-&gt;task
comma
l_int|0
)paren
suffix:semicolon
id|rpc_wake_up_task
c_func
(paren
id|cache-&gt;task
)paren
suffix:semicolon
id|interruptible_sleep_on_timeout
c_func
(paren
op_amp
id|cache-&gt;request_wait
comma
l_int|1
op_star
id|HZ
)paren
suffix:semicolon
)brace
id|out
suffix:colon
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|nfs_reqlist_alloc
r_int
id|nfs_reqlist_alloc
c_func
(paren
r_struct
id|nfs_server
op_star
id|server
)paren
(brace
r_struct
id|nfs_reqlist
op_star
id|cache
suffix:semicolon
r_if
c_cond
(paren
id|server-&gt;rw_requests
)paren
r_return
l_int|0
suffix:semicolon
id|cache
op_assign
(paren
r_struct
id|nfs_reqlist
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|cache
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cache
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|cache
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|cache
)paren
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|cache-&gt;nr_requests
comma
l_int|0
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|cache-&gt;request_wait
)paren
suffix:semicolon
id|server-&gt;rw_requests
op_assign
id|cache
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|nfs_reqlist_free
r_void
id|nfs_reqlist_free
c_func
(paren
r_struct
id|nfs_server
op_star
id|server
)paren
(brace
r_if
c_cond
(paren
id|server-&gt;rw_requests
)paren
(brace
id|kfree
c_func
(paren
id|server-&gt;rw_requests
)paren
suffix:semicolon
id|server-&gt;rw_requests
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
DECL|macro|NFS_FLUSHD_TIMEOUT
mdefine_line|#define NFS_FLUSHD_TIMEOUT&t;(30*HZ)
r_static
r_void
DECL|function|nfs_flushd
id|nfs_flushd
c_func
(paren
r_struct
id|rpc_task
op_star
id|task
)paren
(brace
r_struct
id|nfs_server
op_star
id|server
suffix:semicolon
r_struct
id|nfs_reqlist
op_star
id|cache
suffix:semicolon
id|LIST_HEAD
c_func
(paren
id|head
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;NFS: %4d flushd starting&bslash;n&quot;
comma
id|task-&gt;tk_pid
)paren
suffix:semicolon
id|server
op_assign
(paren
r_struct
id|nfs_server
op_star
)paren
id|task-&gt;tk_calldata
suffix:semicolon
id|cache
op_assign
id|server-&gt;rw_requests
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|spin_lock
c_func
(paren
op_amp
id|nfs_wreq_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|nfs_scan_lru_dirty_timeout
c_func
(paren
id|server
comma
op_amp
id|head
)paren
)paren
(brace
id|spin_unlock
c_func
(paren
op_amp
id|nfs_wreq_lock
)paren
suffix:semicolon
id|nfs_flush_list
c_func
(paren
op_amp
id|head
comma
id|server-&gt;wpages
comma
id|FLUSH_AGING
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|nfs_scan_lru_read_timeout
c_func
(paren
id|server
comma
op_amp
id|head
)paren
)paren
(brace
id|spin_unlock
c_func
(paren
op_amp
id|nfs_wreq_lock
)paren
suffix:semicolon
id|nfs_pagein_list
c_func
(paren
op_amp
id|head
comma
id|server-&gt;rpages
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_NFS_V3
r_if
c_cond
(paren
id|nfs_scan_lru_commit_timeout
c_func
(paren
id|server
comma
op_amp
id|head
)paren
)paren
(brace
id|spin_unlock
c_func
(paren
op_amp
id|nfs_wreq_lock
)paren
suffix:semicolon
id|nfs_commit_list
c_func
(paren
op_amp
id|head
comma
id|FLUSH_AGING
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
macro_line|#endif
id|spin_unlock
c_func
(paren
op_amp
id|nfs_wreq_lock
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|dprintk
c_func
(paren
l_string|&quot;NFS: %4d flushd back to sleep&bslash;n&quot;
comma
id|task-&gt;tk_pid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|task-&gt;tk_action
)paren
(brace
id|task-&gt;tk_timeout
op_assign
id|NFS_FLUSHD_TIMEOUT
suffix:semicolon
id|cache-&gt;runat
op_assign
id|jiffies
op_plus
id|task-&gt;tk_timeout
suffix:semicolon
id|rpc_sleep_on
c_func
(paren
op_amp
id|flushd_queue
comma
id|task
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
)brace
)brace
r_static
r_void
DECL|function|nfs_flushd_exit
id|nfs_flushd_exit
c_func
(paren
r_struct
id|rpc_task
op_star
id|task
)paren
(brace
r_struct
id|nfs_server
op_star
id|server
suffix:semicolon
r_struct
id|nfs_reqlist
op_star
id|cache
suffix:semicolon
id|server
op_assign
(paren
r_struct
id|nfs_server
op_star
)paren
id|task-&gt;tk_calldata
suffix:semicolon
id|cache
op_assign
id|server-&gt;rw_requests
suffix:semicolon
r_if
c_cond
(paren
id|cache-&gt;task
op_eq
id|task
)paren
id|cache-&gt;task
op_assign
l_int|NULL
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|cache-&gt;request_wait
)paren
suffix:semicolon
)brace
eof
