multiline_comment|/*&n; *  fs/nfs/nfs4state.c&n; *&n; *  Client-side XDR for NFSv4.&n; *&n; *  Copyright (c) 2002 The Regents of the University of Michigan.&n; *  All rights reserved.&n; *&n; *  Kendrick Smith &lt;kmsmith@umich.edu&gt;&n; *&n; *  Redistribution and use in source and binary forms, with or without&n; *  modification, are permitted provided that the following conditions&n; *  are met:&n; *&n; *  1. Redistributions of source code must retain the above copyright&n; *     notice, this list of conditions and the following disclaimer.&n; *  2. Redistributions in binary form must reproduce the above copyright&n; *     notice, this list of conditions and the following disclaimer in the&n; *     documentation and/or other materials provided with the distribution.&n; *  3. Neither the name of the University nor the names of its&n; *     contributors may be used to endorse or promote products derived&n; *     from this software without specific prior written permission.&n; *&n; *  THIS SOFTWARE IS PROVIDED ``AS IS&squot;&squot; AND ANY EXPRESS OR IMPLIED&n; *  WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF&n; *  MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE&n; *  DISCLAIMED. IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE&n; *  FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR&n; *  CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF&n; *  SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR&n; *  BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF&n; *  LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING&n; *  NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS&n; *  SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.&n; *&n; * Implementation of the NFSv4 state model.  For the time being,&n; * this is minimal, but will be made much more complex in a&n; * subsequent patch.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/nfs_fs.h&gt;
macro_line|#include &lt;linux/nfs_idmap.h&gt;
macro_line|#include &lt;linux/workqueue.h&gt;
macro_line|#include &lt;linux/bitops.h&gt;
macro_line|#include &quot;callback.h&quot;
macro_line|#include &quot;delegation.h&quot;
DECL|macro|OPENOWNER_POOL_SIZE
mdefine_line|#define OPENOWNER_POOL_SIZE&t;8
DECL|variable|state_spinlock
r_static
id|spinlock_t
id|state_spinlock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
DECL|variable|zero_stateid
id|nfs4_stateid
id|zero_stateid
suffix:semicolon
macro_line|#if 0
id|nfs4_stateid
id|one_stateid
op_assign
(brace
l_int|0xff
comma
l_int|0xff
comma
l_int|0xff
comma
l_int|0xff
comma
l_int|0xff
comma
l_int|0xff
comma
l_int|0xff
comma
l_int|0xff
comma
l_int|0xff
comma
l_int|0xff
comma
l_int|0xff
comma
l_int|0xff
comma
l_int|0xff
comma
l_int|0xff
comma
l_int|0xff
comma
l_int|0xff
)brace
suffix:semicolon
macro_line|#endif
r_static
id|LIST_HEAD
c_func
(paren
id|nfs4_clientid_list
)paren
suffix:semicolon
r_static
r_void
id|nfs4_recover_state
c_func
(paren
r_void
op_star
)paren
suffix:semicolon
r_extern
r_void
id|nfs4_renew_state
c_func
(paren
r_void
op_star
)paren
suffix:semicolon
r_void
DECL|function|init_nfsv4_state
id|init_nfsv4_state
c_func
(paren
r_struct
id|nfs_server
op_star
id|server
)paren
(brace
id|server-&gt;nfs4_state
op_assign
l_int|NULL
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|server-&gt;nfs4_siblings
)paren
suffix:semicolon
)brace
r_void
DECL|function|destroy_nfsv4_state
id|destroy_nfsv4_state
c_func
(paren
r_struct
id|nfs_server
op_star
id|server
)paren
(brace
r_if
c_cond
(paren
id|server-&gt;mnt_path
)paren
(brace
id|kfree
c_func
(paren
id|server-&gt;mnt_path
)paren
suffix:semicolon
id|server-&gt;mnt_path
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|server-&gt;nfs4_state
)paren
(brace
id|nfs4_put_client
c_func
(paren
id|server-&gt;nfs4_state
)paren
suffix:semicolon
id|server-&gt;nfs4_state
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * nfs4_get_client(): returns an empty client structure&n; * nfs4_put_client(): drops reference to client structure&n; *&n; * Since these are allocated/deallocated very rarely, we don&squot;t&n; * bother putting them in a slab cache...&n; */
r_static
r_struct
id|nfs4_client
op_star
DECL|function|nfs4_alloc_client
id|nfs4_alloc_client
c_func
(paren
r_struct
id|in_addr
op_star
id|addr
)paren
(brace
r_struct
id|nfs4_client
op_star
id|clp
suffix:semicolon
r_if
c_cond
(paren
id|nfs_callback_up
c_func
(paren
)paren
OL
l_int|0
)paren
r_return
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
(paren
id|clp
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|clp
)paren
comma
id|GFP_KERNEL
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|nfs_callback_down
c_func
(paren
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|memset
c_func
(paren
id|clp
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|clp
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|clp-&gt;cl_addr
comma
id|addr
comma
r_sizeof
(paren
id|clp-&gt;cl_addr
)paren
)paren
suffix:semicolon
id|init_rwsem
c_func
(paren
op_amp
id|clp-&gt;cl_sem
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|clp-&gt;cl_delegations
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|clp-&gt;cl_state_owners
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|clp-&gt;cl_unused
)paren
suffix:semicolon
id|spin_lock_init
c_func
(paren
op_amp
id|clp-&gt;cl_lock
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|clp-&gt;cl_count
comma
l_int|1
)paren
suffix:semicolon
id|INIT_WORK
c_func
(paren
op_amp
id|clp-&gt;cl_recoverd
comma
id|nfs4_recover_state
comma
id|clp
)paren
suffix:semicolon
id|INIT_WORK
c_func
(paren
op_amp
id|clp-&gt;cl_renewd
comma
id|nfs4_renew_state
comma
id|clp
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|clp-&gt;cl_superblocks
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|clp-&gt;cl_waitq
)paren
suffix:semicolon
id|rpc_init_wait_queue
c_func
(paren
op_amp
id|clp-&gt;cl_rpcwaitq
comma
l_string|&quot;NFS4 client&quot;
)paren
suffix:semicolon
id|clp-&gt;cl_state
op_assign
l_int|1
op_lshift
id|NFS4CLNT_OK
suffix:semicolon
r_return
id|clp
suffix:semicolon
)brace
r_static
r_void
DECL|function|nfs4_free_client
id|nfs4_free_client
c_func
(paren
r_struct
id|nfs4_client
op_star
id|clp
)paren
(brace
r_struct
id|nfs4_state_owner
op_star
id|sp
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|clp-&gt;cl_unused
)paren
)paren
(brace
id|sp
op_assign
id|list_entry
c_func
(paren
id|clp-&gt;cl_unused.next
comma
r_struct
id|nfs4_state_owner
comma
id|so_list
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|sp-&gt;so_list
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|sp
)paren
suffix:semicolon
)brace
id|BUG_ON
c_func
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|clp-&gt;cl_state_owners
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|clp-&gt;cl_cred
)paren
id|put_rpccred
c_func
(paren
id|clp-&gt;cl_cred
)paren
suffix:semicolon
id|nfs_idmap_delete
c_func
(paren
id|clp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|clp-&gt;cl_rpcclient
)paren
id|rpc_shutdown_client
c_func
(paren
id|clp-&gt;cl_rpcclient
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|clp
)paren
suffix:semicolon
id|nfs_callback_down
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|__nfs4_find_client
r_static
r_struct
id|nfs4_client
op_star
id|__nfs4_find_client
c_func
(paren
r_struct
id|in_addr
op_star
id|addr
)paren
(brace
r_struct
id|nfs4_client
op_star
id|clp
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|clp
comma
op_amp
id|nfs4_clientid_list
comma
id|cl_servers
)paren
(brace
r_if
c_cond
(paren
id|memcmp
c_func
(paren
op_amp
id|clp-&gt;cl_addr
comma
id|addr
comma
r_sizeof
(paren
id|clp-&gt;cl_addr
)paren
)paren
op_eq
l_int|0
)paren
(brace
id|atomic_inc
c_func
(paren
op_amp
id|clp-&gt;cl_count
)paren
suffix:semicolon
r_return
id|clp
suffix:semicolon
)brace
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|nfs4_find_client
r_struct
id|nfs4_client
op_star
id|nfs4_find_client
c_func
(paren
r_struct
id|in_addr
op_star
id|addr
)paren
(brace
r_struct
id|nfs4_client
op_star
id|clp
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|state_spinlock
)paren
suffix:semicolon
id|clp
op_assign
id|__nfs4_find_client
c_func
(paren
id|addr
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|state_spinlock
)paren
suffix:semicolon
r_return
id|clp
suffix:semicolon
)brace
r_struct
id|nfs4_client
op_star
DECL|function|nfs4_get_client
id|nfs4_get_client
c_func
(paren
r_struct
id|in_addr
op_star
id|addr
)paren
(brace
r_struct
id|nfs4_client
op_star
id|clp
comma
op_star
r_new
op_assign
l_int|NULL
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|state_spinlock
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|clp
op_assign
id|__nfs4_find_client
c_func
(paren
id|addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|clp
op_ne
l_int|NULL
)paren
r_break
suffix:semicolon
id|clp
op_assign
r_new
suffix:semicolon
r_if
c_cond
(paren
id|clp
op_ne
l_int|NULL
)paren
(brace
id|list_add
c_func
(paren
op_amp
id|clp-&gt;cl_servers
comma
op_amp
id|nfs4_clientid_list
)paren
suffix:semicolon
r_new
op_assign
l_int|NULL
suffix:semicolon
r_break
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|state_spinlock
)paren
suffix:semicolon
r_new
op_assign
id|nfs4_alloc_client
c_func
(paren
id|addr
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|state_spinlock
)paren
suffix:semicolon
r_if
c_cond
(paren
r_new
op_eq
l_int|NULL
)paren
r_break
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|state_spinlock
)paren
suffix:semicolon
r_if
c_cond
(paren
r_new
)paren
id|nfs4_free_client
c_func
(paren
r_new
)paren
suffix:semicolon
r_return
id|clp
suffix:semicolon
)brace
r_void
DECL|function|nfs4_put_client
id|nfs4_put_client
c_func
(paren
r_struct
id|nfs4_client
op_star
id|clp
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|atomic_dec_and_lock
c_func
(paren
op_amp
id|clp-&gt;cl_count
comma
op_amp
id|state_spinlock
)paren
)paren
r_return
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|clp-&gt;cl_servers
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|state_spinlock
)paren
suffix:semicolon
id|BUG_ON
c_func
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|clp-&gt;cl_superblocks
)paren
)paren
suffix:semicolon
id|wake_up_all
c_func
(paren
op_amp
id|clp-&gt;cl_waitq
)paren
suffix:semicolon
id|rpc_wake_up
c_func
(paren
op_amp
id|clp-&gt;cl_rpcwaitq
)paren
suffix:semicolon
id|nfs4_kill_renewd
c_func
(paren
id|clp
)paren
suffix:semicolon
id|nfs4_free_client
c_func
(paren
id|clp
)paren
suffix:semicolon
)brace
DECL|function|nfs4_init_client
r_int
id|nfs4_init_client
c_func
(paren
r_struct
id|nfs4_client
op_star
id|clp
)paren
(brace
r_int
id|status
op_assign
id|nfs4_proc_setclientid
c_func
(paren
id|clp
comma
id|NFS4_CALLBACK
comma
id|nfs_callback_tcpport
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_eq
l_int|0
)paren
id|status
op_assign
id|nfs4_proc_setclientid_confirm
c_func
(paren
id|clp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_eq
l_int|0
)paren
id|nfs4_schedule_state_renewal
c_func
(paren
id|clp
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
id|u32
DECL|function|nfs4_alloc_lockowner_id
id|nfs4_alloc_lockowner_id
c_func
(paren
r_struct
id|nfs4_client
op_star
id|clp
)paren
(brace
r_return
id|clp-&gt;cl_lockowner_id
op_increment
suffix:semicolon
)brace
r_static
r_struct
id|nfs4_state_owner
op_star
DECL|function|nfs4_client_grab_unused
id|nfs4_client_grab_unused
c_func
(paren
r_struct
id|nfs4_client
op_star
id|clp
comma
r_struct
id|rpc_cred
op_star
id|cred
)paren
(brace
r_struct
id|nfs4_state_owner
op_star
id|sp
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|clp-&gt;cl_unused
)paren
)paren
(brace
id|sp
op_assign
id|list_entry
c_func
(paren
id|clp-&gt;cl_unused.next
comma
r_struct
id|nfs4_state_owner
comma
id|so_list
)paren
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|sp-&gt;so_count
)paren
suffix:semicolon
id|sp-&gt;so_cred
op_assign
id|cred
suffix:semicolon
id|list_move
c_func
(paren
op_amp
id|sp-&gt;so_list
comma
op_amp
id|clp-&gt;cl_state_owners
)paren
suffix:semicolon
id|clp-&gt;cl_nunused
op_decrement
suffix:semicolon
)brace
r_return
id|sp
suffix:semicolon
)brace
r_static
r_struct
id|nfs4_state_owner
op_star
DECL|function|nfs4_find_state_owner
id|nfs4_find_state_owner
c_func
(paren
r_struct
id|nfs4_client
op_star
id|clp
comma
r_struct
id|rpc_cred
op_star
id|cred
)paren
(brace
r_struct
id|nfs4_state_owner
op_star
id|sp
comma
op_star
id|res
op_assign
l_int|NULL
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|sp
comma
op_amp
id|clp-&gt;cl_state_owners
comma
id|so_list
)paren
(brace
r_if
c_cond
(paren
id|sp-&gt;so_cred
op_ne
id|cred
)paren
r_continue
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|sp-&gt;so_count
)paren
suffix:semicolon
multiline_comment|/* Move to the head of the list */
id|list_move
c_func
(paren
op_amp
id|sp-&gt;so_list
comma
op_amp
id|clp-&gt;cl_state_owners
)paren
suffix:semicolon
id|res
op_assign
id|sp
suffix:semicolon
r_break
suffix:semicolon
)brace
r_return
id|res
suffix:semicolon
)brace
multiline_comment|/*&n; * nfs4_alloc_state_owner(): this is called on the OPEN or CREATE path to&n; * create a new state_owner.&n; *&n; */
r_static
r_struct
id|nfs4_state_owner
op_star
DECL|function|nfs4_alloc_state_owner
id|nfs4_alloc_state_owner
c_func
(paren
r_void
)paren
(brace
r_struct
id|nfs4_state_owner
op_star
id|sp
suffix:semicolon
id|sp
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|sp
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sp
)paren
r_return
l_int|NULL
suffix:semicolon
id|init_MUTEX
c_func
(paren
op_amp
id|sp-&gt;so_sema
)paren
suffix:semicolon
id|sp-&gt;so_seqid
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* arbitrary */
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|sp-&gt;so_states
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|sp-&gt;so_delegations
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|sp-&gt;so_count
comma
l_int|1
)paren
suffix:semicolon
r_return
id|sp
suffix:semicolon
)brace
r_static
r_void
DECL|function|nfs4_unhash_state_owner
id|nfs4_unhash_state_owner
c_func
(paren
r_struct
id|nfs4_state_owner
op_star
id|sp
)paren
(brace
r_struct
id|nfs4_client
op_star
id|clp
op_assign
id|sp-&gt;so_client
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|clp-&gt;cl_lock
)paren
suffix:semicolon
id|list_del_init
c_func
(paren
op_amp
id|sp-&gt;so_list
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|clp-&gt;cl_lock
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Note: must be called with clp-&gt;cl_sem held in order to prevent races&n; *       with reboot recovery!&n; */
DECL|function|nfs4_get_state_owner
r_struct
id|nfs4_state_owner
op_star
id|nfs4_get_state_owner
c_func
(paren
r_struct
id|nfs_server
op_star
id|server
comma
r_struct
id|rpc_cred
op_star
id|cred
)paren
(brace
r_struct
id|nfs4_client
op_star
id|clp
op_assign
id|server-&gt;nfs4_state
suffix:semicolon
r_struct
id|nfs4_state_owner
op_star
id|sp
comma
op_star
r_new
suffix:semicolon
id|get_rpccred
c_func
(paren
id|cred
)paren
suffix:semicolon
r_new
op_assign
id|nfs4_alloc_state_owner
c_func
(paren
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|clp-&gt;cl_lock
)paren
suffix:semicolon
id|sp
op_assign
id|nfs4_find_state_owner
c_func
(paren
id|clp
comma
id|cred
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sp
op_eq
l_int|NULL
)paren
id|sp
op_assign
id|nfs4_client_grab_unused
c_func
(paren
id|clp
comma
id|cred
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sp
op_eq
l_int|NULL
op_logical_and
r_new
op_ne
l_int|NULL
)paren
(brace
id|list_add
c_func
(paren
op_amp
r_new
op_member_access_from_pointer
id|so_list
comma
op_amp
id|clp-&gt;cl_state_owners
)paren
suffix:semicolon
r_new
op_member_access_from_pointer
id|so_client
op_assign
id|clp
suffix:semicolon
r_new
op_member_access_from_pointer
id|so_id
op_assign
id|nfs4_alloc_lockowner_id
c_func
(paren
id|clp
)paren
suffix:semicolon
r_new
op_member_access_from_pointer
id|so_cred
op_assign
id|cred
suffix:semicolon
id|sp
op_assign
r_new
suffix:semicolon
r_new
op_assign
l_int|NULL
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|clp-&gt;cl_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
r_new
)paren
id|kfree
c_func
(paren
r_new
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sp
op_ne
l_int|NULL
)paren
r_return
id|sp
suffix:semicolon
id|put_rpccred
c_func
(paren
id|cred
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; * Must be called with clp-&gt;cl_sem held in order to avoid races&n; * with state recovery...&n; */
DECL|function|nfs4_put_state_owner
r_void
id|nfs4_put_state_owner
c_func
(paren
r_struct
id|nfs4_state_owner
op_star
id|sp
)paren
(brace
r_struct
id|nfs4_client
op_star
id|clp
op_assign
id|sp-&gt;so_client
suffix:semicolon
r_struct
id|rpc_cred
op_star
id|cred
op_assign
id|sp-&gt;so_cred
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|atomic_dec_and_lock
c_func
(paren
op_amp
id|sp-&gt;so_count
comma
op_amp
id|clp-&gt;cl_lock
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|clp-&gt;cl_nunused
op_ge
id|OPENOWNER_POOL_SIZE
)paren
r_goto
id|out_free
suffix:semicolon
r_if
c_cond
(paren
id|list_empty
c_func
(paren
op_amp
id|sp-&gt;so_list
)paren
)paren
r_goto
id|out_free
suffix:semicolon
id|list_move
c_func
(paren
op_amp
id|sp-&gt;so_list
comma
op_amp
id|clp-&gt;cl_unused
)paren
suffix:semicolon
id|clp-&gt;cl_nunused
op_increment
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|clp-&gt;cl_lock
)paren
suffix:semicolon
id|put_rpccred
c_func
(paren
id|cred
)paren
suffix:semicolon
id|cred
op_assign
l_int|NULL
suffix:semicolon
r_return
suffix:semicolon
id|out_free
suffix:colon
id|list_del
c_func
(paren
op_amp
id|sp-&gt;so_list
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|clp-&gt;cl_lock
)paren
suffix:semicolon
id|put_rpccred
c_func
(paren
id|cred
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|sp
)paren
suffix:semicolon
)brace
r_static
r_struct
id|nfs4_state
op_star
DECL|function|nfs4_alloc_open_state
id|nfs4_alloc_open_state
c_func
(paren
r_void
)paren
(brace
r_struct
id|nfs4_state
op_star
id|state
suffix:semicolon
id|state
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|state
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|state
)paren
r_return
l_int|NULL
suffix:semicolon
id|state-&gt;state
op_assign
l_int|0
suffix:semicolon
id|state-&gt;nreaders
op_assign
l_int|0
suffix:semicolon
id|state-&gt;nwriters
op_assign
l_int|0
suffix:semicolon
id|state-&gt;flags
op_assign
l_int|0
suffix:semicolon
id|memset
c_func
(paren
id|state-&gt;stateid.data
comma
l_int|0
comma
r_sizeof
(paren
id|state-&gt;stateid.data
)paren
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|state-&gt;count
comma
l_int|1
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|state-&gt;lock_states
)paren
suffix:semicolon
id|init_MUTEX
c_func
(paren
op_amp
id|state-&gt;lock_sema
)paren
suffix:semicolon
id|rwlock_init
c_func
(paren
op_amp
id|state-&gt;state_lock
)paren
suffix:semicolon
r_return
id|state
suffix:semicolon
)brace
r_static
r_struct
id|nfs4_state
op_star
DECL|function|__nfs4_find_state
id|__nfs4_find_state
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|rpc_cred
op_star
id|cred
comma
id|mode_t
id|mode
)paren
(brace
r_struct
id|nfs_inode
op_star
id|nfsi
op_assign
id|NFS_I
c_func
(paren
id|inode
)paren
suffix:semicolon
r_struct
id|nfs4_state
op_star
id|state
suffix:semicolon
id|mode
op_and_assign
(paren
id|FMODE_READ
op_or
id|FMODE_WRITE
)paren
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|state
comma
op_amp
id|nfsi-&gt;open_states
comma
id|inode_states
)paren
(brace
r_if
c_cond
(paren
id|state-&gt;owner-&gt;so_cred
op_ne
id|cred
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
(paren
id|mode
op_amp
id|FMODE_READ
)paren
op_ne
l_int|0
op_logical_and
id|state-&gt;nreaders
op_eq
l_int|0
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
(paren
id|mode
op_amp
id|FMODE_WRITE
)paren
op_ne
l_int|0
op_logical_and
id|state-&gt;nwriters
op_eq
l_int|0
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
(paren
id|state-&gt;state
op_amp
id|mode
)paren
op_ne
id|mode
)paren
r_continue
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|state-&gt;count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mode
op_amp
id|FMODE_READ
)paren
id|state-&gt;nreaders
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|mode
op_amp
id|FMODE_WRITE
)paren
id|state-&gt;nwriters
op_increment
suffix:semicolon
r_return
id|state
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
r_static
r_struct
id|nfs4_state
op_star
DECL|function|__nfs4_find_state_byowner
id|__nfs4_find_state_byowner
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|nfs4_state_owner
op_star
id|owner
)paren
(brace
r_struct
id|nfs_inode
op_star
id|nfsi
op_assign
id|NFS_I
c_func
(paren
id|inode
)paren
suffix:semicolon
r_struct
id|nfs4_state
op_star
id|state
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|state
comma
op_amp
id|nfsi-&gt;open_states
comma
id|inode_states
)paren
(brace
multiline_comment|/* Is this in the process of being freed? */
r_if
c_cond
(paren
id|state-&gt;nreaders
op_eq
l_int|0
op_logical_and
id|state-&gt;nwriters
op_eq
l_int|0
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|state-&gt;owner
op_eq
id|owner
)paren
(brace
id|atomic_inc
c_func
(paren
op_amp
id|state-&gt;count
)paren
suffix:semicolon
r_return
id|state
suffix:semicolon
)brace
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
r_struct
id|nfs4_state
op_star
DECL|function|nfs4_find_state
id|nfs4_find_state
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|rpc_cred
op_star
id|cred
comma
id|mode_t
id|mode
)paren
(brace
r_struct
id|nfs4_state
op_star
id|state
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|inode-&gt;i_lock
)paren
suffix:semicolon
id|state
op_assign
id|__nfs4_find_state
c_func
(paren
id|inode
comma
id|cred
comma
id|mode
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|inode-&gt;i_lock
)paren
suffix:semicolon
r_return
id|state
suffix:semicolon
)brace
r_static
r_void
DECL|function|nfs4_free_open_state
id|nfs4_free_open_state
c_func
(paren
r_struct
id|nfs4_state
op_star
id|state
)paren
(brace
id|kfree
c_func
(paren
id|state
)paren
suffix:semicolon
)brace
r_struct
id|nfs4_state
op_star
DECL|function|nfs4_get_open_state
id|nfs4_get_open_state
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|nfs4_state_owner
op_star
id|owner
)paren
(brace
r_struct
id|nfs4_state
op_star
id|state
comma
op_star
r_new
suffix:semicolon
r_struct
id|nfs_inode
op_star
id|nfsi
op_assign
id|NFS_I
c_func
(paren
id|inode
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|inode-&gt;i_lock
)paren
suffix:semicolon
id|state
op_assign
id|__nfs4_find_state_byowner
c_func
(paren
id|inode
comma
id|owner
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|inode-&gt;i_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|state
)paren
r_goto
id|out
suffix:semicolon
r_new
op_assign
id|nfs4_alloc_open_state
c_func
(paren
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|inode-&gt;i_lock
)paren
suffix:semicolon
id|state
op_assign
id|__nfs4_find_state_byowner
c_func
(paren
id|inode
comma
id|owner
)paren
suffix:semicolon
r_if
c_cond
(paren
id|state
op_eq
l_int|NULL
op_logical_and
r_new
op_ne
l_int|NULL
)paren
(brace
id|state
op_assign
r_new
suffix:semicolon
multiline_comment|/* Caller *must* be holding owner-&gt;so_sem */
id|list_add
c_func
(paren
op_amp
id|state-&gt;open_states
comma
op_amp
id|owner-&gt;so_states
)paren
suffix:semicolon
id|state-&gt;owner
op_assign
id|owner
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|owner-&gt;so_count
)paren
suffix:semicolon
id|list_add
c_func
(paren
op_amp
id|state-&gt;inode_states
comma
op_amp
id|nfsi-&gt;open_states
)paren
suffix:semicolon
id|state-&gt;inode
op_assign
id|igrab
c_func
(paren
id|inode
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|inode-&gt;i_lock
)paren
suffix:semicolon
)brace
r_else
(brace
id|spin_unlock
c_func
(paren
op_amp
id|inode-&gt;i_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
r_new
)paren
id|nfs4_free_open_state
c_func
(paren
r_new
)paren
suffix:semicolon
)brace
id|out
suffix:colon
r_return
id|state
suffix:semicolon
)brace
multiline_comment|/*&n; * Beware! Caller must be holding exactly one&n; * reference to clp-&gt;cl_sem and owner-&gt;so_sema!&n; */
DECL|function|nfs4_put_open_state
r_void
id|nfs4_put_open_state
c_func
(paren
r_struct
id|nfs4_state
op_star
id|state
)paren
(brace
r_struct
id|inode
op_star
id|inode
op_assign
id|state-&gt;inode
suffix:semicolon
r_struct
id|nfs4_state_owner
op_star
id|owner
op_assign
id|state-&gt;owner
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|atomic_dec_and_lock
c_func
(paren
op_amp
id|state-&gt;count
comma
op_amp
id|inode-&gt;i_lock
)paren
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|state-&gt;inode_states
)paren
)paren
id|list_del
c_func
(paren
op_amp
id|state-&gt;inode_states
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|inode-&gt;i_lock
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|state-&gt;open_states
)paren
suffix:semicolon
id|iput
c_func
(paren
id|inode
)paren
suffix:semicolon
id|BUG_ON
(paren
id|state-&gt;state
op_ne
l_int|0
)paren
suffix:semicolon
id|nfs4_free_open_state
c_func
(paren
id|state
)paren
suffix:semicolon
id|nfs4_put_state_owner
c_func
(paren
id|owner
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Beware! Caller must be holding no references to clp-&gt;cl_sem!&n; * of owner-&gt;so_sema!&n; */
DECL|function|nfs4_close_state
r_void
id|nfs4_close_state
c_func
(paren
r_struct
id|nfs4_state
op_star
id|state
comma
id|mode_t
id|mode
)paren
(brace
r_struct
id|inode
op_star
id|inode
op_assign
id|state-&gt;inode
suffix:semicolon
r_struct
id|nfs4_state_owner
op_star
id|owner
op_assign
id|state-&gt;owner
suffix:semicolon
r_struct
id|nfs4_client
op_star
id|clp
op_assign
id|owner-&gt;so_client
suffix:semicolon
r_int
id|newstate
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|owner-&gt;so_count
)paren
suffix:semicolon
id|down_read
c_func
(paren
op_amp
id|clp-&gt;cl_sem
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|owner-&gt;so_sema
)paren
suffix:semicolon
multiline_comment|/* Protect against nfs4_find_state() */
id|spin_lock
c_func
(paren
op_amp
id|inode-&gt;i_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mode
op_amp
id|FMODE_READ
)paren
id|state-&gt;nreaders
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|mode
op_amp
id|FMODE_WRITE
)paren
id|state-&gt;nwriters
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|state-&gt;nwriters
op_eq
l_int|0
op_logical_and
id|state-&gt;nreaders
op_eq
l_int|0
)paren
id|list_del_init
c_func
(paren
op_amp
id|state-&gt;inode_states
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|inode-&gt;i_lock
)paren
suffix:semicolon
id|newstate
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|state-&gt;state
op_ne
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|state-&gt;nreaders
)paren
id|newstate
op_or_assign
id|FMODE_READ
suffix:semicolon
r_if
c_cond
(paren
id|state-&gt;nwriters
)paren
id|newstate
op_or_assign
id|FMODE_WRITE
suffix:semicolon
r_if
c_cond
(paren
id|state-&gt;state
op_eq
id|newstate
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|nfs4_do_close
c_func
(paren
id|inode
comma
id|state
comma
id|newstate
)paren
op_eq
op_minus
id|EINPROGRESS
)paren
r_return
suffix:semicolon
)brace
id|out
suffix:colon
id|nfs4_put_open_state
c_func
(paren
id|state
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|owner-&gt;so_sema
)paren
suffix:semicolon
id|nfs4_put_state_owner
c_func
(paren
id|owner
)paren
suffix:semicolon
id|up_read
c_func
(paren
op_amp
id|clp-&gt;cl_sem
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Search the state-&gt;lock_states for an existing lock_owner&n; * that is compatible with current-&gt;files&n; */
r_static
r_struct
id|nfs4_lock_state
op_star
DECL|function|__nfs4_find_lock_state
id|__nfs4_find_lock_state
c_func
(paren
r_struct
id|nfs4_state
op_star
id|state
comma
id|fl_owner_t
id|fl_owner
)paren
(brace
r_struct
id|nfs4_lock_state
op_star
id|pos
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|pos
comma
op_amp
id|state-&gt;lock_states
comma
id|ls_locks
)paren
(brace
r_if
c_cond
(paren
id|pos-&gt;ls_owner
op_ne
id|fl_owner
)paren
r_continue
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|pos-&gt;ls_count
)paren
suffix:semicolon
r_return
id|pos
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
r_struct
id|nfs4_lock_state
op_star
DECL|function|nfs4_find_lock_state
id|nfs4_find_lock_state
c_func
(paren
r_struct
id|nfs4_state
op_star
id|state
comma
id|fl_owner_t
id|fl_owner
)paren
(brace
r_struct
id|nfs4_lock_state
op_star
id|lsp
suffix:semicolon
id|read_lock
c_func
(paren
op_amp
id|state-&gt;state_lock
)paren
suffix:semicolon
id|lsp
op_assign
id|__nfs4_find_lock_state
c_func
(paren
id|state
comma
id|fl_owner
)paren
suffix:semicolon
id|read_unlock
c_func
(paren
op_amp
id|state-&gt;state_lock
)paren
suffix:semicolon
r_return
id|lsp
suffix:semicolon
)brace
multiline_comment|/*&n; * Return a compatible lock_state. If no initialized lock_state structure&n; * exists, return an uninitialized one.&n; *&n; * The caller must be holding state-&gt;lock_sema&n; */
DECL|function|nfs4_alloc_lock_state
r_static
r_struct
id|nfs4_lock_state
op_star
id|nfs4_alloc_lock_state
c_func
(paren
r_struct
id|nfs4_state
op_star
id|state
comma
id|fl_owner_t
id|fl_owner
)paren
(brace
r_struct
id|nfs4_lock_state
op_star
id|lsp
suffix:semicolon
r_struct
id|nfs4_client
op_star
id|clp
op_assign
id|state-&gt;owner-&gt;so_client
suffix:semicolon
id|lsp
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|lsp
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lsp
op_eq
l_int|NULL
)paren
r_return
l_int|NULL
suffix:semicolon
id|lsp-&gt;ls_flags
op_assign
l_int|0
suffix:semicolon
id|lsp-&gt;ls_seqid
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* arbitrary */
id|lsp-&gt;ls_id
op_assign
op_minus
l_int|1
suffix:semicolon
id|memset
c_func
(paren
id|lsp-&gt;ls_stateid.data
comma
l_int|0
comma
r_sizeof
(paren
id|lsp-&gt;ls_stateid.data
)paren
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|lsp-&gt;ls_count
comma
l_int|1
)paren
suffix:semicolon
id|lsp-&gt;ls_owner
op_assign
id|fl_owner
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|lsp-&gt;ls_locks
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|clp-&gt;cl_lock
)paren
suffix:semicolon
id|lsp-&gt;ls_id
op_assign
id|nfs4_alloc_lockowner_id
c_func
(paren
id|clp
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|clp-&gt;cl_lock
)paren
suffix:semicolon
r_return
id|lsp
suffix:semicolon
)brace
multiline_comment|/*&n; * Return a compatible lock_state. If no initialized lock_state structure&n; * exists, return an uninitialized one.&n; *&n; * The caller must be holding state-&gt;lock_sema and clp-&gt;cl_sem&n; */
DECL|function|nfs4_get_lock_state
r_struct
id|nfs4_lock_state
op_star
id|nfs4_get_lock_state
c_func
(paren
r_struct
id|nfs4_state
op_star
id|state
comma
id|fl_owner_t
id|owner
)paren
(brace
r_struct
id|nfs4_lock_state
op_star
id|lsp
suffix:semicolon
id|lsp
op_assign
id|nfs4_find_lock_state
c_func
(paren
id|state
comma
id|owner
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lsp
op_eq
l_int|NULL
)paren
id|lsp
op_assign
id|nfs4_alloc_lock_state
c_func
(paren
id|state
comma
id|owner
)paren
suffix:semicolon
r_return
id|lsp
suffix:semicolon
)brace
multiline_comment|/*&n; * Byte-range lock aware utility to initialize the stateid of read/write&n; * requests.&n; */
r_void
DECL|function|nfs4_copy_stateid
id|nfs4_copy_stateid
c_func
(paren
id|nfs4_stateid
op_star
id|dst
comma
r_struct
id|nfs4_state
op_star
id|state
comma
id|fl_owner_t
id|fl_owner
)paren
(brace
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|LK_STATE_IN_USE
comma
op_amp
id|state-&gt;flags
)paren
)paren
(brace
r_struct
id|nfs4_lock_state
op_star
id|lsp
suffix:semicolon
id|lsp
op_assign
id|nfs4_find_lock_state
c_func
(paren
id|state
comma
id|fl_owner
)paren
suffix:semicolon
r_if
c_cond
(paren
id|lsp
)paren
(brace
id|memcpy
c_func
(paren
id|dst
comma
op_amp
id|lsp-&gt;ls_stateid
comma
r_sizeof
(paren
op_star
id|dst
)paren
)paren
suffix:semicolon
id|nfs4_put_lock_state
c_func
(paren
id|lsp
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
id|memcpy
c_func
(paren
id|dst
comma
op_amp
id|state-&gt;stateid
comma
r_sizeof
(paren
op_star
id|dst
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;* Called with state-&gt;lock_sema and clp-&gt;cl_sem held.&n;*/
DECL|function|nfs4_increment_lock_seqid
r_void
id|nfs4_increment_lock_seqid
c_func
(paren
r_int
id|status
comma
r_struct
id|nfs4_lock_state
op_star
id|lsp
)paren
(brace
r_if
c_cond
(paren
id|status
op_eq
id|NFS_OK
op_logical_or
id|seqid_mutating_err
c_func
(paren
op_minus
id|status
)paren
)paren
id|lsp-&gt;ls_seqid
op_increment
suffix:semicolon
)brace
multiline_comment|/* &n;* Check to see if the request lock (type FL_UNLK) effects the fl lock.&n;*&n;* fl and request must have the same posix owner&n;*&n;* return: &n;* 0 -&gt; fl not effected by request&n;* 1 -&gt; fl consumed by request&n;*/
r_static
r_int
DECL|function|nfs4_check_unlock
id|nfs4_check_unlock
c_func
(paren
r_struct
id|file_lock
op_star
id|fl
comma
r_struct
id|file_lock
op_star
id|request
)paren
(brace
r_if
c_cond
(paren
id|fl-&gt;fl_start
op_ge
id|request-&gt;fl_start
op_logical_and
id|fl-&gt;fl_end
op_le
id|request-&gt;fl_end
)paren
r_return
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Post an initialized lock_state on the state-&gt;lock_states list.&n; */
DECL|function|nfs4_notify_setlk
r_void
id|nfs4_notify_setlk
c_func
(paren
r_struct
id|nfs4_state
op_star
id|state
comma
r_struct
id|file_lock
op_star
id|request
comma
r_struct
id|nfs4_lock_state
op_star
id|lsp
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|lsp-&gt;ls_locks
)paren
)paren
r_return
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|lsp-&gt;ls_count
)paren
suffix:semicolon
id|write_lock
c_func
(paren
op_amp
id|state-&gt;state_lock
)paren
suffix:semicolon
id|list_add
c_func
(paren
op_amp
id|lsp-&gt;ls_locks
comma
op_amp
id|state-&gt;lock_states
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|LK_STATE_IN_USE
comma
op_amp
id|state-&gt;flags
)paren
suffix:semicolon
id|write_unlock
c_func
(paren
op_amp
id|state-&gt;state_lock
)paren
suffix:semicolon
)brace
multiline_comment|/* &n; * to decide to &squot;reap&squot; lock state:&n; * 1) search i_flock for file_locks with fl.lock_state = to ls.&n; * 2) determine if unlock will consume found lock. &n; * &t;if so, reap&n; *&n; * &t;else, don&squot;t reap.&n; *&n; */
r_void
DECL|function|nfs4_notify_unlck
id|nfs4_notify_unlck
c_func
(paren
r_struct
id|nfs4_state
op_star
id|state
comma
r_struct
id|file_lock
op_star
id|request
comma
r_struct
id|nfs4_lock_state
op_star
id|lsp
)paren
(brace
r_struct
id|inode
op_star
id|inode
op_assign
id|state-&gt;inode
suffix:semicolon
r_struct
id|file_lock
op_star
id|fl
suffix:semicolon
r_for
c_loop
(paren
id|fl
op_assign
id|inode-&gt;i_flock
suffix:semicolon
id|fl
op_ne
l_int|NULL
suffix:semicolon
id|fl
op_assign
id|fl-&gt;fl_next
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|fl-&gt;fl_flags
op_amp
id|FL_POSIX
)paren
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|fl-&gt;fl_owner
op_ne
id|lsp-&gt;ls_owner
)paren
r_continue
suffix:semicolon
multiline_comment|/* Exit if we find at least one lock which is not consumed */
r_if
c_cond
(paren
id|nfs4_check_unlock
c_func
(paren
id|fl
comma
id|request
)paren
op_eq
l_int|0
)paren
r_return
suffix:semicolon
)brace
id|write_lock
c_func
(paren
op_amp
id|state-&gt;state_lock
)paren
suffix:semicolon
id|list_del_init
c_func
(paren
op_amp
id|lsp-&gt;ls_locks
)paren
suffix:semicolon
r_if
c_cond
(paren
id|list_empty
c_func
(paren
op_amp
id|state-&gt;lock_states
)paren
)paren
id|clear_bit
c_func
(paren
id|LK_STATE_IN_USE
comma
op_amp
id|state-&gt;flags
)paren
suffix:semicolon
id|write_unlock
c_func
(paren
op_amp
id|state-&gt;state_lock
)paren
suffix:semicolon
id|nfs4_put_lock_state
c_func
(paren
id|lsp
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Release reference to lock_state, and free it if we see that&n; * it is no longer in use&n; */
r_void
DECL|function|nfs4_put_lock_state
id|nfs4_put_lock_state
c_func
(paren
r_struct
id|nfs4_lock_state
op_star
id|lsp
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|atomic_dec_and_test
c_func
(paren
op_amp
id|lsp-&gt;ls_count
)paren
)paren
r_return
suffix:semicolon
id|BUG_ON
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|lsp-&gt;ls_locks
)paren
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|lsp
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;* Called with sp-&gt;so_sema and clp-&gt;cl_sem held.&n;*&n;* Increment the seqid if the OPEN/OPEN_DOWNGRADE/CLOSE succeeded, or&n;* failed with a seqid incrementing error -&n;* see comments nfs_fs.h:seqid_mutating_error()&n;*/
DECL|function|nfs4_increment_seqid
r_void
id|nfs4_increment_seqid
c_func
(paren
r_int
id|status
comma
r_struct
id|nfs4_state_owner
op_star
id|sp
)paren
(brace
r_if
c_cond
(paren
id|status
op_eq
id|NFS_OK
op_logical_or
id|seqid_mutating_err
c_func
(paren
op_minus
id|status
)paren
)paren
id|sp-&gt;so_seqid
op_increment
suffix:semicolon
multiline_comment|/* If the server returns BAD_SEQID, unhash state_owner here */
r_if
c_cond
(paren
id|status
op_eq
op_minus
id|NFS4ERR_BAD_SEQID
)paren
id|nfs4_unhash_state_owner
c_func
(paren
id|sp
)paren
suffix:semicolon
)brace
r_static
r_int
id|reclaimer
c_func
(paren
r_void
op_star
)paren
suffix:semicolon
DECL|struct|reclaimer_args
r_struct
id|reclaimer_args
(brace
DECL|member|clp
r_struct
id|nfs4_client
op_star
id|clp
suffix:semicolon
DECL|member|complete
r_struct
id|completion
id|complete
suffix:semicolon
)brace
suffix:semicolon
multiline_comment|/*&n; * State recovery routine&n; */
r_void
DECL|function|nfs4_recover_state
id|nfs4_recover_state
c_func
(paren
r_void
op_star
id|data
)paren
(brace
r_struct
id|nfs4_client
op_star
id|clp
op_assign
(paren
r_struct
id|nfs4_client
op_star
)paren
id|data
suffix:semicolon
r_struct
id|reclaimer_args
id|args
op_assign
(brace
dot
id|clp
op_assign
id|clp
comma
)brace
suffix:semicolon
id|might_sleep
c_func
(paren
)paren
suffix:semicolon
id|init_completion
c_func
(paren
op_amp
id|args.complete
)paren
suffix:semicolon
r_if
c_cond
(paren
id|kernel_thread
c_func
(paren
id|reclaimer
comma
op_amp
id|args
comma
id|CLONE_KERNEL
)paren
OL
l_int|0
)paren
r_goto
id|out_failed_clear
suffix:semicolon
id|wait_for_completion
c_func
(paren
op_amp
id|args.complete
)paren
suffix:semicolon
r_return
suffix:semicolon
id|out_failed_clear
suffix:colon
id|set_bit
c_func
(paren
id|NFS4CLNT_OK
comma
op_amp
id|clp-&gt;cl_state
)paren
suffix:semicolon
id|wake_up_all
c_func
(paren
op_amp
id|clp-&gt;cl_waitq
)paren
suffix:semicolon
id|rpc_wake_up
c_func
(paren
op_amp
id|clp-&gt;cl_rpcwaitq
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Schedule a state recovery attempt&n; */
r_void
DECL|function|nfs4_schedule_state_recovery
id|nfs4_schedule_state_recovery
c_func
(paren
r_struct
id|nfs4_client
op_star
id|clp
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|clp
)paren
r_return
suffix:semicolon
r_if
c_cond
(paren
id|test_and_clear_bit
c_func
(paren
id|NFS4CLNT_OK
comma
op_amp
id|clp-&gt;cl_state
)paren
)paren
id|schedule_work
c_func
(paren
op_amp
id|clp-&gt;cl_recoverd
)paren
suffix:semicolon
)brace
DECL|function|nfs4_reclaim_locks
r_static
r_int
id|nfs4_reclaim_locks
c_func
(paren
r_struct
id|nfs4_state
op_star
id|state
)paren
(brace
r_struct
id|inode
op_star
id|inode
op_assign
id|state-&gt;inode
suffix:semicolon
r_struct
id|file_lock
op_star
id|fl
suffix:semicolon
r_int
id|status
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|fl
op_assign
id|inode-&gt;i_flock
suffix:semicolon
id|fl
op_ne
l_int|0
suffix:semicolon
id|fl
op_assign
id|fl-&gt;fl_next
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|fl-&gt;fl_flags
op_amp
id|FL_POSIX
)paren
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
r_struct
id|nfs_open_context
op_star
)paren
id|fl-&gt;fl_file-&gt;private_data
)paren
op_member_access_from_pointer
id|state
op_ne
id|state
)paren
r_continue
suffix:semicolon
id|status
op_assign
id|nfs4_lock_reclaim
c_func
(paren
id|state
comma
id|fl
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_ge
l_int|0
)paren
r_continue
suffix:semicolon
r_switch
c_cond
(paren
id|status
)paren
(brace
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: unhandled error %d. Zeroing state&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|status
)paren
suffix:semicolon
r_case
op_minus
id|NFS4ERR_EXPIRED
suffix:colon
r_case
op_minus
id|NFS4ERR_NO_GRACE
suffix:colon
r_case
op_minus
id|NFS4ERR_RECLAIM_BAD
suffix:colon
r_case
op_minus
id|NFS4ERR_RECLAIM_CONFLICT
suffix:colon
multiline_comment|/* kill_proc(fl-&gt;fl_owner, SIGLOST, 1); */
r_break
suffix:semicolon
r_case
op_minus
id|NFS4ERR_STALE_CLIENTID
suffix:colon
r_goto
id|out_err
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
id|out_err
suffix:colon
r_return
id|status
suffix:semicolon
)brace
DECL|function|nfs4_reclaim_open_state
r_static
r_int
id|nfs4_reclaim_open_state
c_func
(paren
r_struct
id|nfs4_state_owner
op_star
id|sp
)paren
(brace
r_struct
id|nfs4_state
op_star
id|state
suffix:semicolon
r_struct
id|nfs4_lock_state
op_star
id|lock
suffix:semicolon
r_int
id|status
op_assign
l_int|0
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|state
comma
op_amp
id|sp-&gt;so_states
comma
id|open_states
)paren
(brace
r_if
c_cond
(paren
id|state-&gt;state
op_eq
l_int|0
)paren
r_continue
suffix:semicolon
id|status
op_assign
id|nfs4_open_reclaim
c_func
(paren
id|sp
comma
id|state
)paren
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|lock
comma
op_amp
id|state-&gt;lock_states
comma
id|ls_locks
)paren
id|lock-&gt;ls_flags
op_and_assign
op_complement
id|NFS_LOCK_INITIALIZED
suffix:semicolon
r_if
c_cond
(paren
id|status
op_ge
l_int|0
)paren
(brace
id|status
op_assign
id|nfs4_reclaim_locks
c_func
(paren
id|state
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
OL
l_int|0
)paren
r_goto
id|out_err
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|lock
comma
op_amp
id|state-&gt;lock_states
comma
id|ls_locks
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|lock-&gt;ls_flags
op_amp
id|NFS_LOCK_INITIALIZED
)paren
)paren
id|printk
c_func
(paren
l_string|&quot;%s: Lock reclaim failed!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
)brace
r_continue
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|status
)paren
(brace
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;%s: unhandled error %d. Zeroing state&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|status
)paren
suffix:semicolon
r_case
op_minus
id|NFS4ERR_EXPIRED
suffix:colon
r_case
op_minus
id|NFS4ERR_NO_GRACE
suffix:colon
r_case
op_minus
id|NFS4ERR_RECLAIM_BAD
suffix:colon
r_case
op_minus
id|NFS4ERR_RECLAIM_CONFLICT
suffix:colon
multiline_comment|/*&n;&t;&t;&t;&t; * Open state on this file cannot be recovered&n;&t;&t;&t;&t; * All we can do is revert to using the zero stateid.&n;&t;&t;&t;&t; */
id|memset
c_func
(paren
id|state-&gt;stateid.data
comma
l_int|0
comma
r_sizeof
(paren
id|state-&gt;stateid.data
)paren
)paren
suffix:semicolon
multiline_comment|/* Mark the file as being &squot;closed&squot; */
id|state-&gt;state
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
op_minus
id|NFS4ERR_STALE_CLIENTID
suffix:colon
r_goto
id|out_err
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
id|out_err
suffix:colon
r_return
id|status
suffix:semicolon
)brace
DECL|function|reclaimer
r_static
r_int
id|reclaimer
c_func
(paren
r_void
op_star
id|ptr
)paren
(brace
r_struct
id|reclaimer_args
op_star
id|args
op_assign
(paren
r_struct
id|reclaimer_args
op_star
)paren
id|ptr
suffix:semicolon
r_struct
id|nfs4_client
op_star
id|clp
op_assign
id|args-&gt;clp
suffix:semicolon
r_struct
id|nfs4_state_owner
op_star
id|sp
suffix:semicolon
r_int
id|status
op_assign
l_int|0
suffix:semicolon
id|daemonize
c_func
(paren
l_string|&quot;%u.%u.%u.%u-reclaim&quot;
comma
id|NIPQUAD
c_func
(paren
id|clp-&gt;cl_addr
)paren
)paren
suffix:semicolon
id|allow_signal
c_func
(paren
id|SIGKILL
)paren
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|clp-&gt;cl_count
)paren
suffix:semicolon
id|complete
c_func
(paren
op_amp
id|args-&gt;complete
)paren
suffix:semicolon
multiline_comment|/* Ensure exclusive access to NFSv4 state */
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
id|down_write
c_func
(paren
op_amp
id|clp-&gt;cl_sem
)paren
suffix:semicolon
multiline_comment|/* Are there any NFS mounts out there? */
r_if
c_cond
(paren
id|list_empty
c_func
(paren
op_amp
id|clp-&gt;cl_superblocks
)paren
)paren
r_goto
id|out
suffix:semicolon
id|restart_loop
suffix:colon
id|status
op_assign
id|nfs4_proc_renew
c_func
(paren
id|clp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_eq
l_int|0
op_logical_or
id|status
op_eq
op_minus
id|NFS4ERR_CB_PATH_DOWN
)paren
r_goto
id|out
suffix:semicolon
id|status
op_assign
id|nfs4_init_client
c_func
(paren
id|clp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
r_goto
id|out_error
suffix:semicolon
multiline_comment|/* Mark all delagations for reclaim */
id|nfs_delegation_mark_reclaim
c_func
(paren
id|clp
)paren
suffix:semicolon
multiline_comment|/* Note: list is protected by exclusive lock on cl-&gt;cl_sem */
id|list_for_each_entry
c_func
(paren
id|sp
comma
op_amp
id|clp-&gt;cl_state_owners
comma
id|so_list
)paren
(brace
id|status
op_assign
id|nfs4_reclaim_open_state
c_func
(paren
id|sp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|status
op_eq
op_minus
id|NFS4ERR_STALE_CLIENTID
)paren
r_goto
id|restart_loop
suffix:semicolon
r_goto
id|out_error
suffix:semicolon
)brace
)brace
id|nfs_delegation_reap_unclaimed
c_func
(paren
id|clp
)paren
suffix:semicolon
id|out
suffix:colon
id|set_bit
c_func
(paren
id|NFS4CLNT_OK
comma
op_amp
id|clp-&gt;cl_state
)paren
suffix:semicolon
id|up_write
c_func
(paren
op_amp
id|clp-&gt;cl_sem
)paren
suffix:semicolon
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
id|wake_up_all
c_func
(paren
op_amp
id|clp-&gt;cl_waitq
)paren
suffix:semicolon
id|rpc_wake_up
c_func
(paren
op_amp
id|clp-&gt;cl_rpcwaitq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
op_eq
op_minus
id|NFS4ERR_CB_PATH_DOWN
)paren
id|nfs_handle_cb_pathdown
c_func
(paren
id|clp
)paren
suffix:semicolon
id|nfs4_put_client
c_func
(paren
id|clp
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|out_error
suffix:colon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Error: state recovery failed on NFSv4 server %u.%u.%u.%u with error %d&bslash;n&quot;
comma
id|NIPQUAD
c_func
(paren
id|clp-&gt;cl_addr.s_addr
)paren
comma
op_minus
id|status
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/*&n; * Local variables:&n; *  c-basic-offset: 8&n; * End:&n; */
eof
