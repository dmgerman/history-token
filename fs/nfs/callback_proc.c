multiline_comment|/*&n; * linux/fs/nfs/callback_proc.c&n; *&n; * Copyright (C) 2004 Trond Myklebust&n; *&n; * NFSv4 callback procedures&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/nfs4.h&gt;
macro_line|#include &lt;linux/nfs_fs.h&gt;
macro_line|#include &quot;callback.h&quot;
macro_line|#include &quot;delegation.h&quot;
DECL|macro|NFSDBG_FACILITY
mdefine_line|#define NFSDBG_FACILITY NFSDBG_CALLBACK
DECL|function|nfs4_callback_getattr
r_int
id|nfs4_callback_getattr
c_func
(paren
r_struct
id|cb_getattrargs
op_star
id|args
comma
r_struct
id|cb_getattrres
op_star
id|res
)paren
(brace
r_struct
id|nfs4_client
op_star
id|clp
suffix:semicolon
r_struct
id|nfs_delegation
op_star
id|delegation
suffix:semicolon
r_struct
id|nfs_inode
op_star
id|nfsi
suffix:semicolon
r_struct
id|inode
op_star
id|inode
suffix:semicolon
id|res-&gt;bitmap
(braket
l_int|0
)braket
op_assign
id|res-&gt;bitmap
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|res-&gt;status
op_assign
id|htonl
c_func
(paren
id|NFS4ERR_BADHANDLE
)paren
suffix:semicolon
id|clp
op_assign
id|nfs4_find_client
c_func
(paren
op_amp
id|args-&gt;addr-&gt;sin_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|clp
op_eq
l_int|NULL
)paren
r_goto
id|out
suffix:semicolon
id|inode
op_assign
id|nfs_delegation_find_inode
c_func
(paren
id|clp
comma
op_amp
id|args-&gt;fh
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inode
op_eq
l_int|NULL
)paren
r_goto
id|out_putclient
suffix:semicolon
id|nfsi
op_assign
id|NFS_I
c_func
(paren
id|inode
)paren
suffix:semicolon
id|down_read
c_func
(paren
op_amp
id|nfsi-&gt;rwsem
)paren
suffix:semicolon
id|delegation
op_assign
id|nfsi-&gt;delegation
suffix:semicolon
r_if
c_cond
(paren
id|delegation
op_eq
l_int|NULL
op_logical_or
(paren
id|delegation-&gt;type
op_amp
id|FMODE_WRITE
)paren
op_eq
l_int|0
)paren
r_goto
id|out_iput
suffix:semicolon
id|res-&gt;size
op_assign
id|i_size_read
c_func
(paren
id|inode
)paren
suffix:semicolon
id|res-&gt;change_attr
op_assign
id|NFS_CHANGE_ATTR
c_func
(paren
id|inode
)paren
suffix:semicolon
id|res-&gt;ctime
op_assign
id|inode-&gt;i_ctime
suffix:semicolon
id|res-&gt;mtime
op_assign
id|inode-&gt;i_mtime
suffix:semicolon
id|res-&gt;bitmap
(braket
l_int|0
)braket
op_assign
(paren
id|FATTR4_WORD0_CHANGE
op_or
id|FATTR4_WORD0_SIZE
)paren
op_amp
id|args-&gt;bitmap
(braket
l_int|0
)braket
suffix:semicolon
id|res-&gt;bitmap
(braket
l_int|1
)braket
op_assign
(paren
id|FATTR4_WORD1_TIME_METADATA
op_or
id|FATTR4_WORD1_TIME_MODIFY
)paren
op_amp
id|args-&gt;bitmap
(braket
l_int|1
)braket
suffix:semicolon
id|res-&gt;status
op_assign
l_int|0
suffix:semicolon
id|out_iput
suffix:colon
id|up_read
c_func
(paren
op_amp
id|nfsi-&gt;rwsem
)paren
suffix:semicolon
id|iput
c_func
(paren
id|inode
)paren
suffix:semicolon
id|out_putclient
suffix:colon
id|nfs4_put_client
c_func
(paren
id|clp
)paren
suffix:semicolon
id|out
suffix:colon
id|dprintk
c_func
(paren
l_string|&quot;%s: exit with status = %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|ntohl
c_func
(paren
id|res-&gt;status
)paren
)paren
suffix:semicolon
r_return
id|res-&gt;status
suffix:semicolon
)brace
DECL|function|nfs4_callback_recall
r_int
id|nfs4_callback_recall
c_func
(paren
r_struct
id|cb_recallargs
op_star
id|args
comma
r_void
op_star
id|dummy
)paren
(brace
r_struct
id|nfs4_client
op_star
id|clp
suffix:semicolon
r_struct
id|inode
op_star
id|inode
suffix:semicolon
r_int
id|res
suffix:semicolon
id|res
op_assign
id|htonl
c_func
(paren
id|NFS4ERR_BADHANDLE
)paren
suffix:semicolon
id|clp
op_assign
id|nfs4_find_client
c_func
(paren
op_amp
id|args-&gt;addr-&gt;sin_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|clp
op_eq
l_int|NULL
)paren
r_goto
id|out
suffix:semicolon
id|inode
op_assign
id|nfs_delegation_find_inode
c_func
(paren
id|clp
comma
op_amp
id|args-&gt;fh
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inode
op_eq
l_int|NULL
)paren
r_goto
id|out_putclient
suffix:semicolon
multiline_comment|/* Set up a helper thread to actually return the delegation */
r_switch
c_cond
(paren
id|nfs_async_inode_return_delegation
c_func
(paren
id|inode
comma
op_amp
id|args-&gt;stateid
)paren
)paren
(brace
r_case
l_int|0
suffix:colon
id|res
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
op_minus
id|ENOENT
suffix:colon
id|res
op_assign
id|htonl
c_func
(paren
id|NFS4ERR_BAD_STATEID
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|res
op_assign
id|htonl
c_func
(paren
id|NFS4ERR_RESOURCE
)paren
suffix:semicolon
)brace
id|iput
c_func
(paren
id|inode
)paren
suffix:semicolon
id|out_putclient
suffix:colon
id|nfs4_put_client
c_func
(paren
id|clp
)paren
suffix:semicolon
id|out
suffix:colon
id|dprintk
c_func
(paren
l_string|&quot;%s: exit with status = %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|ntohl
c_func
(paren
id|res
)paren
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
eof
