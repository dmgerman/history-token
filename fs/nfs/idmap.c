multiline_comment|/*&n; * fs/nfs/idmap.c&n; *&n; *  UID and GID to name mapping for clients.&n; *&n; *  Copyright (c) 2002 The Regents of the University of Michigan.&n; *  All rights reserved.&n; *&n; *  Marius Aamodt Eriksen &lt;marius@umich.edu&gt;&n; *&n; *  Redistribution and use in source and binary forms, with or without&n; *  modification, are permitted provided that the following conditions&n; *  are met:&n; *&n; *  1. Redistributions of source code must retain the above copyright&n; *     notice, this list of conditions and the following disclaimer.&n; *  2. Redistributions in binary form must reproduce the above copyright&n; *     notice, this list of conditions and the following disclaimer in the&n; *     documentation and/or other materials provided with the distribution.&n; *  3. Neither the name of the University nor the names of its&n; *     contributors may be used to endorse or promote products derived&n; *     from this software without specific prior written permission.&n; *&n; *  THIS SOFTWARE IS PROVIDED ``AS IS&squot;&squot; AND ANY EXPRESS OR IMPLIED&n; *  WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF&n; *  MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE&n; *  DISCLAIMED. IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE&n; *  FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR&n; *  CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF&n; *  SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR&n; *  BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF&n; *  LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING&n; *  NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS&n; *  SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/socket.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/sunrpc/clnt.h&gt;
macro_line|#include &lt;linux/workqueue.h&gt;
macro_line|#include &lt;linux/sunrpc/rpc_pipe_fs.h&gt;
macro_line|#include &lt;linux/nfs_fs_sb.h&gt;
macro_line|#include &lt;linux/nfs_fs.h&gt;
macro_line|#include &lt;linux/nfs_idmap.h&gt;
DECL|macro|IDMAP_HASH_SZ
mdefine_line|#define IDMAP_HASH_SZ          128
DECL|macro|IDMAP_HASH_TYPE_NAME
mdefine_line|#define IDMAP_HASH_TYPE_NAME   0x01
DECL|macro|IDMAP_HASH_TYPE_ID
mdefine_line|#define IDMAP_HASH_TYPE_ID     0x02
DECL|macro|IDMAP_HASH_TYPE_INSERT
mdefine_line|#define IDMAP_HASH_TYPE_INSERT 0x04
DECL|struct|idmap_hashent
r_struct
id|idmap_hashent
(brace
DECL|member|ih_id
id|uid_t
id|ih_id
suffix:semicolon
DECL|member|ih_name
r_char
id|ih_name
(braket
id|IDMAP_NAMESZ
)braket
suffix:semicolon
DECL|member|ih_namelen
id|u_int32_t
id|ih_namelen
suffix:semicolon
)brace
suffix:semicolon
DECL|struct|idmap
r_struct
id|idmap
(brace
DECL|member|idmap_path
r_char
id|idmap_path
(braket
l_int|48
)braket
suffix:semicolon
DECL|member|idmap_dentry
r_struct
id|dentry
op_star
id|idmap_dentry
suffix:semicolon
DECL|member|idmap_wq
id|wait_queue_head_t
id|idmap_wq
suffix:semicolon
DECL|member|idmap_im
r_struct
id|idmap_msg
id|idmap_im
suffix:semicolon
DECL|member|idmap_server
r_struct
id|nfs_server
op_star
id|idmap_server
suffix:semicolon
DECL|member|idmap_lock
r_struct
id|semaphore
id|idmap_lock
suffix:semicolon
DECL|member|idmap_im_lock
r_struct
id|semaphore
id|idmap_im_lock
suffix:semicolon
DECL|member|idmap_hash_lock
r_struct
id|semaphore
id|idmap_hash_lock
suffix:semicolon
DECL|member|idmap_id_hash
r_struct
id|idmap_hashent
id|idmap_id_hash
(braket
id|IDMAP_HASH_SZ
)braket
suffix:semicolon
DECL|member|idmap_name_hash
r_struct
id|idmap_hashent
id|idmap_name_hash
(braket
id|IDMAP_HASH_SZ
)braket
suffix:semicolon
)brace
suffix:semicolon
r_static
id|ssize_t
id|idmap_pipe_upcall
c_func
(paren
r_struct
id|file
op_star
comma
r_struct
id|rpc_pipe_msg
op_star
comma
r_char
op_star
comma
r_int
)paren
suffix:semicolon
r_static
id|ssize_t
id|idmap_pipe_downcall
c_func
(paren
r_struct
id|file
op_star
comma
r_const
r_char
op_star
comma
r_int
)paren
suffix:semicolon
r_void
id|idmap_pipe_destroy_msg
c_func
(paren
r_struct
id|rpc_pipe_msg
op_star
)paren
suffix:semicolon
r_static
r_int
id|validate_ascii
c_func
(paren
r_char
op_star
comma
id|u_int32_t
)paren
suffix:semicolon
r_static
id|u_int32_t
id|fnvhash32
c_func
(paren
r_void
op_star
comma
id|u_int32_t
)paren
suffix:semicolon
r_static
r_int
id|idmap_cache_lookup
c_func
(paren
r_struct
id|idmap
op_star
comma
r_int
comma
r_char
op_star
comma
id|u_int32_t
op_star
comma
id|uid_t
op_star
)paren
suffix:semicolon
DECL|variable|idmap_upcall_ops
r_static
r_struct
id|rpc_pipe_ops
id|idmap_upcall_ops
op_assign
(brace
dot
id|upcall
op_assign
id|idmap_pipe_upcall
comma
dot
id|downcall
op_assign
id|idmap_pipe_downcall
comma
dot
id|destroy_msg
op_assign
id|idmap_pipe_destroy_msg
comma
)brace
suffix:semicolon
r_void
op_star
DECL|function|nfs_idmap_new
id|nfs_idmap_new
c_func
(paren
r_struct
id|nfs_server
op_star
id|server
)paren
(brace
r_struct
id|idmap
op_star
id|idmap
suffix:semicolon
r_if
c_cond
(paren
(paren
id|idmap
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|idmap
)paren
comma
id|GFP_KERNEL
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
(paren
l_int|NULL
)paren
suffix:semicolon
id|memset
c_func
(paren
id|idmap
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|idmap
)paren
)paren
suffix:semicolon
id|idmap-&gt;idmap_server
op_assign
id|server
suffix:semicolon
id|snprintf
c_func
(paren
id|idmap-&gt;idmap_path
comma
r_sizeof
(paren
id|idmap-&gt;idmap_path
)paren
comma
l_string|&quot;%s/idmap&quot;
comma
id|idmap-&gt;idmap_server-&gt;client-&gt;cl_pathname
)paren
suffix:semicolon
id|idmap-&gt;idmap_dentry
op_assign
id|rpc_mkpipe
c_func
(paren
id|idmap-&gt;idmap_path
comma
id|idmap-&gt;idmap_server
comma
op_amp
id|idmap_upcall_ops
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|idmap-&gt;idmap_dentry
)paren
)paren
r_goto
id|err_free
suffix:semicolon
id|init_MUTEX
c_func
(paren
op_amp
id|idmap-&gt;idmap_lock
)paren
suffix:semicolon
id|init_MUTEX
c_func
(paren
op_amp
id|idmap-&gt;idmap_im_lock
)paren
suffix:semicolon
id|init_MUTEX
c_func
(paren
op_amp
id|idmap-&gt;idmap_hash_lock
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|idmap-&gt;idmap_wq
)paren
suffix:semicolon
r_return
(paren
id|idmap
)paren
suffix:semicolon
id|err_free
suffix:colon
id|kfree
c_func
(paren
id|idmap
)paren
suffix:semicolon
r_return
(paren
l_int|NULL
)paren
suffix:semicolon
)brace
r_void
DECL|function|nfs_idmap_delete
id|nfs_idmap_delete
c_func
(paren
r_struct
id|nfs_server
op_star
id|server
)paren
(brace
r_struct
id|idmap
op_star
id|idmap
op_assign
id|server-&gt;idmap
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|idmap
)paren
r_return
suffix:semicolon
id|rpc_unlink
c_func
(paren
id|idmap-&gt;idmap_path
)paren
suffix:semicolon
id|server-&gt;idmap
op_assign
l_int|NULL
suffix:semicolon
id|kfree
c_func
(paren
id|idmap
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Name -&gt; ID&n; */
r_int
DECL|function|nfs_idmap_id
id|nfs_idmap_id
c_func
(paren
r_struct
id|nfs_server
op_star
id|server
comma
id|u_int8_t
id|type
comma
r_char
op_star
id|name
comma
id|u_int
id|namelen
comma
id|uid_t
op_star
id|id
)paren
(brace
r_struct
id|rpc_pipe_msg
id|msg
suffix:semicolon
r_struct
id|idmap
op_star
id|idmap
op_assign
id|server-&gt;idmap
suffix:semicolon
r_struct
id|idmap_msg
op_star
id|im
suffix:semicolon
id|DECLARE_WAITQUEUE
c_func
(paren
id|wq
comma
id|current
)paren
suffix:semicolon
r_int
id|ret
op_assign
op_minus
l_int|1
comma
id|hashtype
op_assign
id|IDMAP_HASH_TYPE_NAME
comma
id|xnamelen
op_assign
id|namelen
suffix:semicolon
r_if
c_cond
(paren
id|idmap
op_eq
l_int|NULL
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
id|im
op_assign
op_amp
id|idmap-&gt;idmap_im
suffix:semicolon
r_if
c_cond
(paren
id|namelen
OG
id|IDMAP_NAMESZ
op_logical_or
id|namelen
op_eq
l_int|0
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|idmap-&gt;idmap_lock
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|idmap-&gt;idmap_im_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|name
(braket
id|xnamelen
op_minus
l_int|1
)braket
op_eq
l_char|&squot;&bslash;0&squot;
)paren
id|xnamelen
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|idmap_cache_lookup
c_func
(paren
id|idmap
comma
id|hashtype
comma
id|name
comma
op_amp
id|xnamelen
comma
id|id
)paren
op_eq
l_int|0
)paren
(brace
id|ret
op_assign
l_int|0
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|memset
c_func
(paren
id|im
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|im
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|im-&gt;im_name
comma
id|name
comma
id|namelen
)paren
suffix:semicolon
multiline_comment|/* Make sure the string is NULL terminated */
r_if
c_cond
(paren
id|namelen
op_ne
id|xnamelen
)paren
(brace
multiline_comment|/* We cannot fit a NULL character */
r_if
c_cond
(paren
id|namelen
op_eq
id|IDMAP_NAMESZ
)paren
(brace
id|ret
op_assign
op_minus
l_int|1
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|im-&gt;im_name
(braket
id|namelen
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
)brace
id|im-&gt;im_type
op_assign
id|type
suffix:semicolon
id|im-&gt;im_conv
op_assign
id|IDMAP_CONV_NAMETOID
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|msg
comma
l_int|0
comma
r_sizeof
(paren
id|msg
)paren
)paren
suffix:semicolon
id|msg.data
op_assign
id|im
suffix:semicolon
id|msg.len
op_assign
r_sizeof
(paren
op_star
id|im
)paren
suffix:semicolon
id|add_wait_queue
c_func
(paren
op_amp
id|idmap-&gt;idmap_wq
comma
op_amp
id|wq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rpc_queue_upcall
c_func
(paren
id|idmap-&gt;idmap_dentry-&gt;d_inode
comma
op_amp
id|msg
)paren
OL
l_int|0
)paren
(brace
id|remove_wait_queue
c_func
(paren
op_amp
id|idmap-&gt;idmap_wq
comma
op_amp
id|wq
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|idmap-&gt;idmap_im_lock
)paren
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
id|current-&gt;state
op_assign
id|TASK_RUNNING
suffix:semicolon
id|remove_wait_queue
c_func
(paren
op_amp
id|idmap-&gt;idmap_wq
comma
op_amp
id|wq
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|idmap-&gt;idmap_im_lock
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * XXX Race condition here, with testing for status.  Go ahead&n;&t; * and and do the cace lookup anyway.&n;&t; */
r_if
c_cond
(paren
id|im-&gt;im_status
op_amp
id|IDMAP_STATUS_SUCCESS
)paren
(brace
id|ret
op_assign
l_int|0
suffix:semicolon
op_star
id|id
op_assign
id|im-&gt;im_id
suffix:semicolon
id|hashtype
op_or_assign
id|IDMAP_HASH_TYPE_INSERT
suffix:semicolon
id|ret
op_assign
id|idmap_cache_lookup
c_func
(paren
id|idmap
comma
id|hashtype
comma
id|name
comma
op_amp
id|xnamelen
comma
id|id
)paren
suffix:semicolon
)brace
id|out
suffix:colon
id|memset
c_func
(paren
id|im
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|im
)paren
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|idmap-&gt;idmap_im_lock
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|idmap-&gt;idmap_lock
)paren
suffix:semicolon
r_return
(paren
id|ret
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * ID -&gt; Name&n; */
r_int
DECL|function|nfs_idmap_name
id|nfs_idmap_name
c_func
(paren
r_struct
id|nfs_server
op_star
id|server
comma
id|u_int8_t
id|type
comma
id|uid_t
id|id
comma
r_char
op_star
id|name
comma
id|u_int
op_star
id|namelen
)paren
(brace
r_struct
id|rpc_pipe_msg
id|msg
suffix:semicolon
r_struct
id|idmap
op_star
id|idmap
op_assign
id|server-&gt;idmap
suffix:semicolon
r_struct
id|idmap_msg
op_star
id|im
suffix:semicolon
id|DECLARE_WAITQUEUE
c_func
(paren
id|wq
comma
id|current
)paren
suffix:semicolon
r_int
id|ret
op_assign
op_minus
l_int|1
comma
id|hashtype
op_assign
id|IDMAP_HASH_TYPE_ID
suffix:semicolon
id|u_int
id|len
suffix:semicolon
r_if
c_cond
(paren
id|idmap
op_eq
l_int|NULL
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
id|im
op_assign
op_amp
id|idmap-&gt;idmap_im
suffix:semicolon
r_if
c_cond
(paren
op_star
id|namelen
OL
id|IDMAP_NAMESZ
op_logical_or
op_star
id|namelen
op_eq
l_int|0
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|idmap-&gt;idmap_lock
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|idmap-&gt;idmap_im_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|idmap_cache_lookup
c_func
(paren
id|idmap
comma
id|hashtype
comma
id|name
comma
id|namelen
comma
op_amp
id|id
)paren
op_eq
l_int|0
)paren
(brace
id|ret
op_assign
l_int|0
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|memset
c_func
(paren
id|im
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|im
)paren
)paren
suffix:semicolon
id|im-&gt;im_type
op_assign
id|type
suffix:semicolon
id|im-&gt;im_conv
op_assign
id|IDMAP_CONV_IDTONAME
suffix:semicolon
id|im-&gt;im_id
op_assign
id|id
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|msg
comma
l_int|0
comma
r_sizeof
(paren
id|msg
)paren
)paren
suffix:semicolon
id|msg.data
op_assign
id|im
suffix:semicolon
id|msg.len
op_assign
r_sizeof
(paren
op_star
id|im
)paren
suffix:semicolon
id|add_wait_queue
c_func
(paren
op_amp
id|idmap-&gt;idmap_wq
comma
op_amp
id|wq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rpc_queue_upcall
c_func
(paren
id|idmap-&gt;idmap_dentry-&gt;d_inode
comma
op_amp
id|msg
)paren
OL
l_int|0
)paren
(brace
id|remove_wait_queue
c_func
(paren
op_amp
id|idmap-&gt;idmap_wq
comma
op_amp
id|wq
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * XXX add timeouts here&n;&t; */
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|idmap-&gt;idmap_im_lock
)paren
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
id|current-&gt;state
op_assign
id|TASK_RUNNING
suffix:semicolon
id|remove_wait_queue
c_func
(paren
op_amp
id|idmap-&gt;idmap_wq
comma
op_amp
id|wq
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|idmap-&gt;idmap_im_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|im-&gt;im_status
op_amp
id|IDMAP_STATUS_SUCCESS
)paren
(brace
r_if
c_cond
(paren
(paren
id|len
op_assign
id|validate_ascii
c_func
(paren
id|im-&gt;im_name
comma
id|IDMAP_NAMESZ
)paren
)paren
op_eq
op_minus
l_int|1
)paren
r_goto
id|out
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
id|memcpy
c_func
(paren
id|name
comma
id|im-&gt;im_name
comma
id|len
)paren
suffix:semicolon
op_star
id|namelen
op_assign
id|len
suffix:semicolon
id|hashtype
op_or_assign
id|IDMAP_HASH_TYPE_INSERT
suffix:semicolon
id|ret
op_assign
id|idmap_cache_lookup
c_func
(paren
id|idmap
comma
id|hashtype
comma
id|name
comma
id|namelen
comma
op_amp
id|id
)paren
suffix:semicolon
)brace
id|out
suffix:colon
id|memset
c_func
(paren
id|im
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|im
)paren
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|idmap-&gt;idmap_im_lock
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|idmap-&gt;idmap_lock
)paren
suffix:semicolon
r_return
(paren
id|ret
)paren
suffix:semicolon
)brace
r_static
id|ssize_t
DECL|function|idmap_pipe_upcall
id|idmap_pipe_upcall
c_func
(paren
r_struct
id|file
op_star
id|filp
comma
r_struct
id|rpc_pipe_msg
op_star
id|msg
comma
r_char
op_star
id|dst
comma
r_int
id|buflen
)paren
(brace
r_char
op_star
id|data
op_assign
(paren
r_char
op_star
)paren
id|msg-&gt;data
op_plus
id|msg-&gt;copied
suffix:semicolon
id|ssize_t
id|mlen
op_assign
id|msg-&gt;len
op_minus
id|msg-&gt;copied
suffix:semicolon
id|ssize_t
id|left
suffix:semicolon
r_if
c_cond
(paren
id|mlen
OG
id|buflen
)paren
id|mlen
op_assign
id|buflen
suffix:semicolon
id|left
op_assign
id|copy_to_user
c_func
(paren
id|dst
comma
id|data
comma
id|mlen
)paren
suffix:semicolon
r_if
c_cond
(paren
id|left
OL
l_int|0
)paren
(brace
id|msg-&gt;errno
op_assign
id|left
suffix:semicolon
r_return
id|left
suffix:semicolon
)brace
id|mlen
op_sub_assign
id|left
suffix:semicolon
id|msg-&gt;copied
op_add_assign
id|mlen
suffix:semicolon
id|msg-&gt;errno
op_assign
l_int|0
suffix:semicolon
r_return
id|mlen
suffix:semicolon
)brace
r_static
id|ssize_t
DECL|function|idmap_pipe_downcall
id|idmap_pipe_downcall
c_func
(paren
r_struct
id|file
op_star
id|filp
comma
r_const
r_char
op_star
id|src
comma
r_int
id|mlen
)paren
(brace
r_struct
id|rpc_inode
op_star
id|rpci
op_assign
id|RPC_I
c_func
(paren
id|filp-&gt;f_dentry-&gt;d_inode
)paren
suffix:semicolon
r_struct
id|nfs_server
op_star
id|server
op_assign
id|rpci
op_member_access_from_pointer
r_private
suffix:semicolon
r_struct
id|idmap
op_star
id|idmap
op_assign
id|server-&gt;idmap
suffix:semicolon
r_struct
id|idmap_msg
id|im_in
comma
op_star
id|im
op_assign
op_amp
id|idmap-&gt;idmap_im
suffix:semicolon
r_int
id|match
op_assign
l_int|0
comma
id|hashtype
comma
id|badmsg
op_assign
l_int|0
comma
id|namelen_in
comma
id|namelen
suffix:semicolon
r_if
c_cond
(paren
id|mlen
op_ne
r_sizeof
(paren
id|im_in
)paren
)paren
r_return
(paren
op_minus
id|ENOSPC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
op_amp
id|im_in
comma
id|src
comma
id|mlen
)paren
op_ne
l_int|0
)paren
r_return
(paren
op_minus
id|EFAULT
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|idmap-&gt;idmap_im_lock
)paren
suffix:semicolon
id|namelen_in
op_assign
id|validate_ascii
c_func
(paren
id|im_in.im_name
comma
id|IDMAP_NAMESZ
)paren
suffix:semicolon
id|namelen
op_assign
id|validate_ascii
c_func
(paren
id|im-&gt;im_name
comma
id|IDMAP_NAMESZ
)paren
suffix:semicolon
id|badmsg
op_assign
op_logical_neg
(paren
id|im_in.im_status
op_amp
id|IDMAP_STATUS_SUCCESS
)paren
op_logical_or
id|namelen_in
op_le
l_int|0
suffix:semicolon
r_switch
c_cond
(paren
id|im_in.im_conv
)paren
(brace
r_case
id|IDMAP_CONV_IDTONAME
suffix:colon
id|match
op_assign
id|im-&gt;im_id
op_eq
id|im_in.im_id
suffix:semicolon
r_break
suffix:semicolon
r_case
id|IDMAP_CONV_NAMETOID
suffix:colon
id|match
op_assign
id|namelen
op_eq
id|namelen_in
op_logical_and
id|memcmp
c_func
(paren
id|im-&gt;im_name
comma
id|im_in.im_name
comma
id|namelen
)paren
op_eq
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|badmsg
op_assign
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
id|match
op_assign
id|match
op_logical_and
id|im-&gt;im_type
op_eq
id|im_in.im_type
suffix:semicolon
r_if
c_cond
(paren
id|match
)paren
(brace
id|memcpy
c_func
(paren
id|im
comma
op_amp
id|im_in
comma
r_sizeof
(paren
op_star
id|im
)paren
)paren
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|idmap-&gt;idmap_wq
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|badmsg
)paren
(brace
id|hashtype
op_assign
id|im_in.im_conv
op_eq
id|IDMAP_CONV_IDTONAME
ques
c_cond
id|IDMAP_HASH_TYPE_ID
suffix:colon
id|IDMAP_HASH_TYPE_NAME
suffix:semicolon
id|hashtype
op_or_assign
id|IDMAP_HASH_TYPE_INSERT
suffix:semicolon
id|idmap_cache_lookup
c_func
(paren
id|idmap
comma
id|hashtype
comma
id|im_in.im_name
comma
op_amp
id|namelen_in
comma
op_amp
id|im_in.im_id
)paren
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|idmap-&gt;idmap_im_lock
)paren
suffix:semicolon
r_return
(paren
id|mlen
)paren
suffix:semicolon
)brace
r_void
DECL|function|idmap_pipe_destroy_msg
id|idmap_pipe_destroy_msg
c_func
(paren
r_struct
id|rpc_pipe_msg
op_star
id|msg
)paren
(brace
r_struct
id|idmap_msg
op_star
id|im
op_assign
id|msg-&gt;data
suffix:semicolon
r_struct
id|idmap
op_star
id|idmap
op_assign
id|container_of
c_func
(paren
id|im
comma
r_struct
id|idmap
comma
id|idmap_im
)paren
suffix:semicolon
r_if
c_cond
(paren
id|msg-&gt;errno
op_ge
l_int|0
)paren
r_return
suffix:semicolon
id|down
c_func
(paren
op_amp
id|idmap-&gt;idmap_im_lock
)paren
suffix:semicolon
id|im-&gt;im_status
op_assign
id|IDMAP_STATUS_LOOKUPFAIL
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|idmap-&gt;idmap_wq
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|idmap-&gt;idmap_im_lock
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|validate_ascii
id|validate_ascii
c_func
(paren
r_char
op_star
id|string
comma
id|u_int32_t
id|len
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|string
(braket
id|i
)braket
op_eq
l_char|&squot;&bslash;0&squot;
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|string
(braket
id|i
)braket
op_amp
l_int|0x80
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|string
(braket
id|i
)braket
op_ne
l_char|&squot;&bslash;0&squot;
)paren
r_return
(paren
op_minus
l_int|1
)paren
suffix:semicolon
r_return
(paren
id|i
)paren
suffix:semicolon
)brace
multiline_comment|/* &n; * Fowler/Noll/Vo hash&n; *    http://www.isthe.com/chongo/tech/comp/fnv/&n; */
DECL|macro|FNV_P_32
mdefine_line|#define FNV_P_32 ((u_int32_t)0x01000193) /* 16777619 */
DECL|macro|FNV_1_32
mdefine_line|#define FNV_1_32 ((u_int32_t)0x811c9dc5) /* 2166136261 */
r_static
id|u_int32_t
DECL|function|fnvhash32
id|fnvhash32
c_func
(paren
r_void
op_star
id|buf
comma
id|u_int32_t
id|buflen
)paren
(brace
id|u_char
op_star
id|p
comma
op_star
id|end
op_assign
(paren
id|u_char
op_star
)paren
id|buf
op_plus
id|buflen
suffix:semicolon
id|u_int32_t
id|hash
op_assign
id|FNV_1_32
suffix:semicolon
r_for
c_loop
(paren
id|p
op_assign
id|buf
suffix:semicolon
id|p
OL
id|end
suffix:semicolon
id|p
op_increment
)paren
(brace
id|hash
op_mul_assign
id|FNV_P_32
suffix:semicolon
id|hash
op_xor_assign
(paren
id|u_int32_t
)paren
op_star
id|p
suffix:semicolon
)brace
r_return
(paren
id|hash
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * -&gt;ih_namelen == 0 indicates negative entry&n; */
r_static
r_int
DECL|function|idmap_cache_lookup
id|idmap_cache_lookup
c_func
(paren
r_struct
id|idmap
op_star
id|idmap
comma
r_int
id|type
comma
r_char
op_star
id|name
comma
id|u_int32_t
op_star
id|namelen
comma
id|uid_t
op_star
id|id
)paren
(brace
id|u_int32_t
id|hash
suffix:semicolon
r_struct
id|idmap_hashent
op_star
id|he
op_assign
l_int|NULL
suffix:semicolon
r_int
id|insert
op_assign
id|type
op_amp
id|IDMAP_HASH_TYPE_INSERT
suffix:semicolon
r_int
id|ret
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/*&n;&t; * XXX technically, this is not needed, since we will always&n;&t; * hold idmap_im_lock when altering the hash tables.  but&n;&t; * semantically that just hurts.&n;&t; *&n;&t; * XXX cache negative responses&n;&t; */
id|down
c_func
(paren
op_amp
id|idmap-&gt;idmap_hash_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|namelen
OG
id|IDMAP_NAMESZ
op_logical_or
op_star
id|namelen
op_eq
l_int|0
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|type
op_amp
id|IDMAP_HASH_TYPE_NAME
)paren
(brace
id|hash
op_assign
id|fnvhash32
c_func
(paren
id|name
comma
op_star
id|namelen
)paren
op_mod
id|IDMAP_HASH_SZ
suffix:semicolon
id|he
op_assign
op_amp
id|idmap-&gt;idmap_name_hash
(braket
id|hash
)braket
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Testing he-&gt;ih_namelen == *namelen implicitly tests&n;&t;&t; * namelen != 0, and thus a non-negative entry.&n;&t;&t; */
r_if
c_cond
(paren
op_logical_neg
id|insert
op_logical_and
id|he-&gt;ih_namelen
op_eq
op_star
id|namelen
op_logical_and
id|memcmp
c_func
(paren
id|he-&gt;ih_name
comma
id|name
comma
op_star
id|namelen
)paren
op_eq
l_int|0
)paren
(brace
op_star
id|id
op_assign
id|he-&gt;ih_id
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|type
op_amp
id|IDMAP_HASH_TYPE_ID
)paren
(brace
id|hash
op_assign
id|fnvhash32
c_func
(paren
id|id
comma
r_sizeof
(paren
op_star
id|id
)paren
)paren
op_mod
id|IDMAP_HASH_SZ
suffix:semicolon
id|he
op_assign
op_amp
id|idmap-&gt;idmap_id_hash
(braket
id|hash
)braket
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|insert
op_logical_and
op_star
id|id
op_eq
id|he-&gt;ih_id
op_logical_and
id|he-&gt;ih_namelen
op_ne
l_int|0
op_logical_and
op_star
id|namelen
op_ge
id|he-&gt;ih_namelen
)paren
(brace
id|memcpy
c_func
(paren
id|name
comma
id|he-&gt;ih_name
comma
id|he-&gt;ih_namelen
)paren
suffix:semicolon
op_star
id|namelen
op_assign
id|he-&gt;ih_namelen
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|insert
op_logical_and
id|he
op_ne
l_int|NULL
)paren
(brace
id|he-&gt;ih_id
op_assign
op_star
id|id
suffix:semicolon
id|memcpy
c_func
(paren
id|he-&gt;ih_name
comma
id|name
comma
op_star
id|namelen
)paren
suffix:semicolon
id|he-&gt;ih_namelen
op_assign
op_star
id|namelen
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
)brace
id|out
suffix:colon
id|up
c_func
(paren
op_amp
id|idmap-&gt;idmap_hash_lock
)paren
suffix:semicolon
r_return
(paren
id|ret
)paren
suffix:semicolon
)brace
eof
