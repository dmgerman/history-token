multiline_comment|/*&n; *&n; *   Copyright (c) International Business Machines  Corp., 2000&n; *&n; *   This program is free software;  you can redistribute it and/or modify&n; *   it under the terms of the GNU General Public License as published by&n; *   the Free Software Foundation; either version 2 of the License, or &n; *   (at your option) any later version.&n; * &n; *   This program is distributed in the hope that it will be useful,&n; *   but WITHOUT ANY WARRANTY;  without even the implied warranty of&n; *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See&n; *   the GNU General Public License for more details.&n; *&n; *   You should have received a copy of the GNU General Public License&n; *   along with this program;  if not, write to the Free Software &n; *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA&n; *&n; * Module: jfs/jfs_metapage.c&n; *&n; */
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &quot;jfs_incore.h&quot;
macro_line|#include &quot;jfs_filsys.h&quot;
macro_line|#include &quot;jfs_metapage.h&quot;
macro_line|#include &quot;jfs_txnmgr.h&quot;
macro_line|#include &quot;jfs_debug.h&quot;
r_extern
r_struct
id|task_struct
op_star
id|jfsCommitTask
suffix:semicolon
DECL|variable|metapages
r_static
r_int
r_int
id|metapages
op_assign
l_int|1024
suffix:semicolon
multiline_comment|/* ??? Need a better number */
DECL|variable|free_metapages
r_static
r_int
r_int
id|free_metapages
suffix:semicolon
DECL|variable|metapage_buf
r_static
id|metapage_t
op_star
id|metapage_buf
suffix:semicolon
DECL|variable|meta_order
r_static
r_int
r_int
id|meta_order
suffix:semicolon
DECL|variable|meta_free_list
r_static
id|metapage_t
op_star
id|meta_free_list
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|meta_lock
r_static
id|spinlock_t
id|meta_lock
op_assign
id|SPIN_LOCK_UNLOCKED
suffix:semicolon
DECL|variable|meta_wait
r_static
id|wait_queue_head_t
id|meta_wait
suffix:semicolon
macro_line|#ifdef CONFIG_JFS_STATISTICS
r_struct
(brace
DECL|member|pagealloc
id|uint
id|pagealloc
suffix:semicolon
multiline_comment|/* # of page allocations */
DECL|member|pagefree
id|uint
id|pagefree
suffix:semicolon
multiline_comment|/* # of page frees */
DECL|member|lockwait
id|uint
id|lockwait
suffix:semicolon
multiline_comment|/* # of sleeping lock_metapage() calls */
DECL|member|allocwait
id|uint
id|allocwait
suffix:semicolon
multiline_comment|/* # of sleeping alloc_metapage() calls */
DECL|variable|mpStat
)brace
id|mpStat
suffix:semicolon
macro_line|#endif
DECL|macro|HASH_BITS
mdefine_line|#define HASH_BITS 10&t;&t;/* This makes hash_table 1 4K page */
DECL|macro|HASH_SIZE
mdefine_line|#define HASH_SIZE (1 &lt;&lt; HASH_BITS)
DECL|variable|hash_table
r_static
id|metapage_t
op_star
op_star
id|hash_table
op_assign
l_int|NULL
suffix:semicolon
DECL|variable|hash_order
r_static
r_int
r_int
id|hash_order
suffix:semicolon
DECL|function|metapage_locked
r_static
r_inline
r_int
id|metapage_locked
c_func
(paren
r_struct
id|metapage
op_star
id|mp
)paren
(brace
r_return
id|test_bit
c_func
(paren
id|META_locked
comma
op_amp
id|mp-&gt;flag
)paren
suffix:semicolon
)brace
DECL|function|trylock_metapage
r_static
r_inline
r_int
id|trylock_metapage
c_func
(paren
r_struct
id|metapage
op_star
id|mp
)paren
(brace
r_return
id|test_and_set_bit
c_func
(paren
id|META_locked
comma
op_amp
id|mp-&gt;flag
)paren
suffix:semicolon
)brace
DECL|function|unlock_metapage
r_static
r_inline
r_void
id|unlock_metapage
c_func
(paren
r_struct
id|metapage
op_star
id|mp
)paren
(brace
id|clear_bit
c_func
(paren
id|META_locked
comma
op_amp
id|mp-&gt;flag
)paren
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|mp-&gt;wait
)paren
suffix:semicolon
)brace
DECL|function|__lock_metapage
r_static
r_void
id|__lock_metapage
c_func
(paren
r_struct
id|metapage
op_star
id|mp
)paren
(brace
id|DECLARE_WAITQUEUE
c_func
(paren
id|wait
comma
id|current
)paren
suffix:semicolon
id|INCREMENT
c_func
(paren
id|mpStat.lockwait
)paren
suffix:semicolon
id|add_wait_queue_exclusive
c_func
(paren
op_amp
id|mp-&gt;wait
comma
op_amp
id|wait
)paren
suffix:semicolon
r_do
(brace
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|metapage_locked
c_func
(paren
id|mp
)paren
)paren
(brace
id|spin_unlock
c_func
(paren
op_amp
id|meta_lock
)paren
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|meta_lock
)paren
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
id|trylock_metapage
c_func
(paren
id|mp
)paren
)paren
suffix:semicolon
id|__set_current_state
c_func
(paren
id|TASK_RUNNING
)paren
suffix:semicolon
id|remove_wait_queue
c_func
(paren
op_amp
id|mp-&gt;wait
comma
op_amp
id|wait
)paren
suffix:semicolon
)brace
multiline_comment|/* needs meta_lock */
DECL|function|lock_metapage
r_static
r_inline
r_void
id|lock_metapage
c_func
(paren
r_struct
id|metapage
op_star
id|mp
)paren
(brace
r_if
c_cond
(paren
id|trylock_metapage
c_func
(paren
id|mp
)paren
)paren
id|__lock_metapage
c_func
(paren
id|mp
)paren
suffix:semicolon
)brace
multiline_comment|/* We&squot;re currently re-evaluating the method we use to write metadata&n; * pages.  Currently, we have to make sure there no dirty buffer_heads&n; * hanging around after we free the metadata page, since the same&n; * physical disk blocks may be used in a different address space and we&n; * can&squot;t write old data over the good data.&n; *&n; * The best way to do this now is with block_invalidate_page.  However,&n; * this is only available in the newer kernels and is not exported&n; * to modules.  block_flushpage is the next best, but it too is not exported&n; * to modules.&n; *&n; * In a module, about the best we have is generic_buffer_fdatasync.  This&n; * synchronously writes any dirty buffers.  This is not optimal, but it will&n; * keep old dirty buffers from overwriting newer data.&n; */
DECL|function|invalidate_page
r_static
r_inline
r_void
id|invalidate_page
c_func
(paren
id|metapage_t
op_star
id|mp
)paren
(brace
macro_line|#ifdef MODULE
id|generic_buffer_fdatasync
c_func
(paren
id|mp-&gt;mapping-&gt;host
comma
id|mp-&gt;index
comma
id|mp-&gt;index
op_plus
l_int|1
)paren
suffix:semicolon
macro_line|#else
id|lock_page
c_func
(paren
id|mp-&gt;page
)paren
suffix:semicolon
id|block_flushpage
c_func
(paren
id|mp-&gt;page
comma
l_int|0
)paren
suffix:semicolon
id|UnlockPage
c_func
(paren
id|mp-&gt;page
)paren
suffix:semicolon
macro_line|#endif
)brace
DECL|function|metapage_init
r_int
id|__init
id|metapage_init
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|metapage_t
op_star
id|last
op_assign
l_int|NULL
suffix:semicolon
id|metapage_t
op_star
id|mp
suffix:semicolon
multiline_comment|/*&n;&t; * Initialize wait queue&n;&t; */
id|init_waitqueue_head
c_func
(paren
op_amp
id|meta_wait
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Allocate the metapage structures&n;&t; */
r_for
c_loop
(paren
id|meta_order
op_assign
l_int|0
suffix:semicolon
(paren
(paren
id|PAGE_SIZE
op_lshift
id|meta_order
)paren
op_div
r_sizeof
(paren
id|metapage_t
)paren
)paren
OL
id|metapages
suffix:semicolon
id|meta_order
op_increment
)paren
suffix:semicolon
id|metapages
op_assign
(paren
id|PAGE_SIZE
op_lshift
id|meta_order
)paren
op_div
r_sizeof
(paren
id|metapage_t
)paren
suffix:semicolon
id|jFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;metapage_init: metapage size = %Zd, metapages = %d&bslash;n&quot;
comma
r_sizeof
(paren
id|metapage_t
)paren
comma
id|metapages
)paren
)paren
suffix:semicolon
id|metapage_buf
op_assign
(paren
id|metapage_t
op_star
)paren
id|__get_free_pages
c_func
(paren
id|GFP_KERNEL
comma
id|meta_order
)paren
suffix:semicolon
m_assert
(paren
id|metapage_buf
)paren
suffix:semicolon
id|memset
c_func
(paren
id|metapage_buf
comma
l_int|0
comma
id|PAGE_SIZE
op_lshift
id|meta_order
)paren
suffix:semicolon
id|mp
op_assign
id|metapage_buf
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|metapages
suffix:semicolon
id|i
op_increment
comma
id|mp
op_increment
)paren
(brace
id|mp-&gt;flag
op_assign
l_int|0
suffix:semicolon
id|set_bit
c_func
(paren
id|META_free
comma
op_amp
id|mp-&gt;flag
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|mp-&gt;wait
)paren
suffix:semicolon
id|mp-&gt;hash_next
op_assign
id|last
suffix:semicolon
id|last
op_assign
id|mp
suffix:semicolon
)brace
id|meta_free_list
op_assign
id|last
suffix:semicolon
id|free_metapages
op_assign
id|metapages
suffix:semicolon
multiline_comment|/*&n;&t; * Now the hash list&n;&t; */
r_for
c_loop
(paren
id|hash_order
op_assign
l_int|0
suffix:semicolon
(paren
(paren
id|PAGE_SIZE
op_lshift
id|hash_order
)paren
op_div
r_sizeof
(paren
r_void
op_star
)paren
)paren
OL
id|HASH_SIZE
suffix:semicolon
id|hash_order
op_increment
)paren
suffix:semicolon
id|hash_table
op_assign
(paren
id|metapage_t
op_star
op_star
)paren
id|__get_free_pages
c_func
(paren
id|GFP_KERNEL
comma
id|hash_order
)paren
suffix:semicolon
m_assert
(paren
id|hash_table
)paren
suffix:semicolon
id|memset
c_func
(paren
id|hash_table
comma
l_int|0
comma
id|PAGE_SIZE
op_lshift
id|hash_order
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|metapage_exit
r_void
id|metapage_exit
c_func
(paren
r_void
)paren
(brace
id|free_pages
c_func
(paren
(paren
r_int
r_int
)paren
id|metapage_buf
comma
id|meta_order
)paren
suffix:semicolon
id|free_pages
c_func
(paren
(paren
r_int
r_int
)paren
id|hash_table
comma
id|hash_order
)paren
suffix:semicolon
id|metapage_buf
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* This is a signal to the jfsIOwait thread */
)brace
multiline_comment|/*&n; * Get metapage structure from freelist&n; * &n; * Caller holds meta_lock&n; */
DECL|function|alloc_metapage
r_static
id|metapage_t
op_star
id|alloc_metapage
c_func
(paren
r_int
op_star
id|dropped_lock
)paren
(brace
id|metapage_t
op_star
r_new
suffix:semicolon
op_star
id|dropped_lock
op_assign
id|FALSE
suffix:semicolon
multiline_comment|/*&n;&t; * Reserve two metapages for the lazy commit thread.  Otherwise&n;&t; * we may deadlock with holders of metapages waiting for tlocks&n;&t; * that lazy thread should be freeing.&n;&t; */
r_if
c_cond
(paren
(paren
id|free_metapages
OL
l_int|3
)paren
op_logical_and
(paren
id|current
op_ne
id|jfsCommitTask
)paren
)paren
(brace
id|INCREMENT
c_func
(paren
id|mpStat.allocwait
)paren
suffix:semicolon
op_star
id|dropped_lock
op_assign
id|TRUE
suffix:semicolon
id|__SLEEP_COND
c_func
(paren
id|meta_wait
comma
(paren
id|free_metapages
OG
l_int|2
)paren
comma
id|spin_lock
c_func
(paren
op_amp
id|meta_lock
)paren
comma
id|spin_unlock
c_func
(paren
op_amp
id|meta_lock
)paren
)paren
suffix:semicolon
)brace
m_assert
(paren
id|meta_free_list
)paren
suffix:semicolon
r_new
op_assign
id|meta_free_list
suffix:semicolon
id|meta_free_list
op_assign
r_new
op_member_access_from_pointer
id|hash_next
suffix:semicolon
id|free_metapages
op_decrement
suffix:semicolon
r_return
r_new
suffix:semicolon
)brace
multiline_comment|/*&n; * Put metapage on freelist (holding meta_lock)&n; */
DECL|function|__free_metapage
r_static
r_inline
r_void
id|__free_metapage
c_func
(paren
id|metapage_t
op_star
id|mp
)paren
(brace
id|mp-&gt;flag
op_assign
l_int|0
suffix:semicolon
id|set_bit
c_func
(paren
id|META_free
comma
op_amp
id|mp-&gt;flag
)paren
suffix:semicolon
id|mp-&gt;hash_next
op_assign
id|meta_free_list
suffix:semicolon
id|meta_free_list
op_assign
id|mp
suffix:semicolon
id|free_metapages
op_increment
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|meta_wait
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Put metapage on freelist (not holding meta_lock)&n; */
DECL|function|free_metapage
r_static
r_inline
r_void
id|free_metapage
c_func
(paren
id|metapage_t
op_star
id|mp
)paren
(brace
id|spin_lock
c_func
(paren
op_amp
id|meta_lock
)paren
suffix:semicolon
id|__free_metapage
c_func
(paren
id|mp
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|meta_lock
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Basically same hash as in pagemap.h, but using our hash table&n; */
DECL|function|meta_hash
r_static
id|metapage_t
op_star
op_star
id|meta_hash
c_func
(paren
r_struct
id|address_space
op_star
id|mapping
comma
r_int
r_int
id|index
)paren
(brace
DECL|macro|i
mdefine_line|#define i (((unsigned long)mapping)/ &bslash;&n;&t;   (sizeof(struct inode) &amp; ~(sizeof(struct inode) -1 )))
DECL|macro|s
mdefine_line|#define s(x) ((x) + ((x) &gt;&gt; HASH_BITS))
r_return
id|hash_table
op_plus
(paren
id|s
c_func
(paren
id|i
op_plus
id|index
)paren
op_amp
(paren
id|HASH_SIZE
op_minus
l_int|1
)paren
)paren
suffix:semicolon
DECL|macro|i
macro_line|#undef i
DECL|macro|s
macro_line|#undef s
)brace
DECL|function|search_hash
r_static
id|metapage_t
op_star
id|search_hash
c_func
(paren
id|metapage_t
op_star
op_star
id|hash_ptr
comma
r_struct
id|address_space
op_star
id|mapping
comma
r_int
r_int
id|index
)paren
(brace
id|metapage_t
op_star
id|ptr
suffix:semicolon
r_for
c_loop
(paren
id|ptr
op_assign
op_star
id|hash_ptr
suffix:semicolon
id|ptr
suffix:semicolon
id|ptr
op_assign
id|ptr-&gt;hash_next
)paren
(brace
r_if
c_cond
(paren
(paren
id|ptr-&gt;mapping
op_eq
id|mapping
)paren
op_logical_and
(paren
id|ptr-&gt;index
op_eq
id|index
)paren
)paren
r_return
id|ptr
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|add_to_hash
r_static
r_void
id|add_to_hash
c_func
(paren
id|metapage_t
op_star
id|mp
comma
id|metapage_t
op_star
op_star
id|hash_ptr
)paren
(brace
r_if
c_cond
(paren
op_star
id|hash_ptr
)paren
(paren
op_star
id|hash_ptr
)paren
op_member_access_from_pointer
id|hash_prev
op_assign
id|mp
suffix:semicolon
id|mp-&gt;hash_prev
op_assign
l_int|NULL
suffix:semicolon
id|mp-&gt;hash_next
op_assign
op_star
id|hash_ptr
suffix:semicolon
op_star
id|hash_ptr
op_assign
id|mp
suffix:semicolon
id|list_add
c_func
(paren
op_amp
id|mp-&gt;inode_list
comma
op_amp
id|JFS_IP
c_func
(paren
id|mp-&gt;mapping-&gt;host
)paren
op_member_access_from_pointer
id|mp_list
)paren
suffix:semicolon
)brace
DECL|function|remove_from_hash
r_static
r_void
id|remove_from_hash
c_func
(paren
id|metapage_t
op_star
id|mp
comma
id|metapage_t
op_star
op_star
id|hash_ptr
)paren
(brace
id|list_del
c_func
(paren
op_amp
id|mp-&gt;inode_list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mp-&gt;hash_prev
)paren
id|mp-&gt;hash_prev-&gt;hash_next
op_assign
id|mp-&gt;hash_next
suffix:semicolon
r_else
(brace
m_assert
(paren
op_star
id|hash_ptr
op_eq
id|mp
)paren
suffix:semicolon
op_star
id|hash_ptr
op_assign
id|mp-&gt;hash_next
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mp-&gt;hash_next
)paren
id|mp-&gt;hash_next-&gt;hash_prev
op_assign
id|mp-&gt;hash_prev
suffix:semicolon
)brace
multiline_comment|/*&n; * Direct address space operations&n; */
DECL|function|direct_get_block
r_static
r_int
id|direct_get_block
c_func
(paren
r_struct
id|inode
op_star
id|ip
comma
id|sector_t
id|lblock
comma
r_struct
id|buffer_head
op_star
id|bh_result
comma
r_int
id|create
)paren
(brace
r_if
c_cond
(paren
id|create
)paren
id|bh_result-&gt;b_state
op_or_assign
(paren
l_int|1UL
op_lshift
id|BH_New
)paren
suffix:semicolon
id|map_bh
c_func
(paren
id|bh_result
comma
id|ip-&gt;i_sb
comma
id|lblock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|direct_writepage
r_static
r_int
id|direct_writepage
c_func
(paren
r_struct
id|page
op_star
id|page
)paren
(brace
r_return
id|block_write_full_page
c_func
(paren
id|page
comma
id|direct_get_block
)paren
suffix:semicolon
)brace
DECL|function|direct_readpage
r_static
r_int
id|direct_readpage
c_func
(paren
r_struct
id|file
op_star
id|fp
comma
r_struct
id|page
op_star
id|page
)paren
(brace
r_return
id|block_read_full_page
c_func
(paren
id|page
comma
id|direct_get_block
)paren
suffix:semicolon
)brace
DECL|function|direct_prepare_write
r_static
r_int
id|direct_prepare_write
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_struct
id|page
op_star
id|page
comma
r_int
id|from
comma
r_int
id|to
)paren
(brace
r_return
id|block_prepare_write
c_func
(paren
id|page
comma
id|from
comma
id|to
comma
id|direct_get_block
)paren
suffix:semicolon
)brace
DECL|function|direct_bmap
r_static
r_int
id|direct_bmap
c_func
(paren
r_struct
id|address_space
op_star
id|mapping
comma
r_int
id|block
)paren
(brace
r_return
id|generic_block_bmap
c_func
(paren
id|mapping
comma
id|block
comma
id|direct_get_block
)paren
suffix:semicolon
)brace
DECL|variable|direct_aops
r_struct
id|address_space_operations
id|direct_aops
op_assign
(brace
id|readpage
suffix:colon
id|direct_readpage
comma
id|writepage
suffix:colon
id|direct_writepage
comma
id|sync_page
suffix:colon
id|block_sync_page
comma
id|prepare_write
suffix:colon
id|direct_prepare_write
comma
id|commit_write
suffix:colon
id|generic_commit_write
comma
id|bmap
suffix:colon
id|direct_bmap
comma
)brace
suffix:semicolon
DECL|function|__get_metapage
id|metapage_t
op_star
id|__get_metapage
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_int
r_int
id|lblock
comma
r_int
r_int
id|size
comma
r_int
id|absolute
comma
r_int
r_int
r_new
)paren
(brace
r_int
id|dropped_lock
suffix:semicolon
id|metapage_t
op_star
op_star
id|hash_ptr
suffix:semicolon
r_int
id|l2BlocksPerPage
suffix:semicolon
r_int
id|l2bsize
suffix:semicolon
r_struct
id|address_space
op_star
id|mapping
suffix:semicolon
id|metapage_t
op_star
id|mp
suffix:semicolon
r_int
r_int
id|page_index
suffix:semicolon
r_int
r_int
id|page_offset
suffix:semicolon
id|jFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;__get_metapage: inode = 0x%p, lblock = 0x%lx&bslash;n&quot;
comma
id|inode
comma
id|lblock
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|absolute
)paren
id|mapping
op_assign
id|JFS_SBI
c_func
(paren
id|inode-&gt;i_sb
)paren
op_member_access_from_pointer
id|direct_mapping
suffix:semicolon
r_else
id|mapping
op_assign
id|inode-&gt;i_mapping
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|meta_lock
)paren
suffix:semicolon
id|hash_ptr
op_assign
id|meta_hash
c_func
(paren
id|mapping
comma
id|lblock
)paren
suffix:semicolon
id|mp
op_assign
id|search_hash
c_func
(paren
id|hash_ptr
comma
id|mapping
comma
id|lblock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mp
)paren
(brace
id|page_found
suffix:colon
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|META_discard
comma
op_amp
id|mp-&gt;flag
)paren
)paren
(brace
m_assert
(paren
r_new
)paren
suffix:semicolon
multiline_comment|/* It&squot;s okay to reuse a discarded&n;&t;&t;&t;&t;&t; * if we expect it to be empty&n;&t;&t;&t;&t;&t; */
id|clear_bit
c_func
(paren
id|META_discard
comma
op_amp
id|mp-&gt;flag
)paren
suffix:semicolon
)brace
id|mp-&gt;count
op_increment
suffix:semicolon
id|jFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;__get_metapage: found 0x%p, in hash&bslash;n&quot;
comma
id|mp
)paren
)paren
suffix:semicolon
m_assert
(paren
id|mp-&gt;logical_size
op_eq
id|size
)paren
suffix:semicolon
id|lock_metapage
c_func
(paren
id|mp
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|meta_lock
)paren
suffix:semicolon
)brace
r_else
(brace
id|l2bsize
op_assign
id|inode-&gt;i_sb-&gt;s_blocksize_bits
suffix:semicolon
id|l2BlocksPerPage
op_assign
id|PAGE_CACHE_SHIFT
op_minus
id|l2bsize
suffix:semicolon
id|page_index
op_assign
id|lblock
op_rshift
id|l2BlocksPerPage
suffix:semicolon
id|page_offset
op_assign
(paren
id|lblock
op_minus
(paren
id|page_index
op_lshift
id|l2BlocksPerPage
)paren
)paren
op_lshift
id|l2bsize
suffix:semicolon
r_if
c_cond
(paren
(paren
id|page_offset
op_plus
id|size
)paren
OG
id|PAGE_SIZE
)paren
(brace
id|spin_unlock
c_func
(paren
op_amp
id|meta_lock
)paren
suffix:semicolon
id|jERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;MetaData crosses page boundary!!&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|mp
op_assign
id|alloc_metapage
c_func
(paren
op_amp
id|dropped_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dropped_lock
)paren
(brace
multiline_comment|/* alloc_metapage blocked, we need to search the hash&n;&t;&t;&t; * again.  (The goto is ugly, maybe we&squot;ll clean this&n;&t;&t;&t; * up in the future.)&n;&t;&t;&t; */
id|metapage_t
op_star
id|mp2
suffix:semicolon
id|mp2
op_assign
id|search_hash
c_func
(paren
id|hash_ptr
comma
id|mapping
comma
id|lblock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mp2
)paren
(brace
id|__free_metapage
c_func
(paren
id|mp
)paren
suffix:semicolon
id|mp
op_assign
id|mp2
suffix:semicolon
r_goto
id|page_found
suffix:semicolon
)brace
)brace
id|mp-&gt;flag
op_assign
l_int|0
suffix:semicolon
id|lock_metapage
c_func
(paren
id|mp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|absolute
)paren
id|set_bit
c_func
(paren
id|META_absolute
comma
op_amp
id|mp-&gt;flag
)paren
suffix:semicolon
id|mp-&gt;xflag
op_assign
id|COMMIT_PAGE
suffix:semicolon
id|mp-&gt;count
op_assign
l_int|1
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|mp-&gt;nohomeok
comma
l_int|0
)paren
suffix:semicolon
id|mp-&gt;mapping
op_assign
id|mapping
suffix:semicolon
id|mp-&gt;index
op_assign
id|lblock
suffix:semicolon
id|mp-&gt;page
op_assign
l_int|0
suffix:semicolon
id|mp-&gt;logical_size
op_assign
id|size
suffix:semicolon
id|add_to_hash
c_func
(paren
id|mp
comma
id|hash_ptr
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|meta_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
r_new
)paren
(brace
id|jFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;__get_metapage: Calling grab_cache_page&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|mp-&gt;page
op_assign
id|grab_cache_page
c_func
(paren
id|mapping
comma
id|page_index
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|mp-&gt;page
)paren
(brace
id|jERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;grab_cache_page failed!&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|meta_lock
)paren
suffix:semicolon
id|remove_from_hash
c_func
(paren
id|mp
comma
id|hash_ptr
)paren
suffix:semicolon
id|__free_metapage
c_func
(paren
id|mp
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|meta_lock
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_else
id|INCREMENT
c_func
(paren
id|mpStat.pagealloc
)paren
suffix:semicolon
)brace
r_else
(brace
id|jFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;__get_metapage: Calling read_cache_page&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|mp-&gt;page
op_assign
id|read_cache_page
c_func
(paren
id|mapping
comma
id|lblock
comma
(paren
id|filler_t
op_star
)paren
id|mapping-&gt;a_ops
op_member_access_from_pointer
id|readpage
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|mp-&gt;page
)paren
)paren
(brace
id|jERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;read_cache_page failed!&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|meta_lock
)paren
suffix:semicolon
id|remove_from_hash
c_func
(paren
id|mp
comma
id|hash_ptr
)paren
suffix:semicolon
id|__free_metapage
c_func
(paren
id|mp
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|meta_lock
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_else
id|INCREMENT
c_func
(paren
id|mpStat.pagealloc
)paren
suffix:semicolon
id|lock_page
c_func
(paren
id|mp-&gt;page
)paren
suffix:semicolon
)brace
id|mp-&gt;data
op_assign
(paren
r_void
op_star
)paren
(paren
id|kmap
c_func
(paren
id|mp-&gt;page
)paren
op_plus
id|page_offset
)paren
suffix:semicolon
)brace
id|jFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;__get_metapage: returning = 0x%p&bslash;n&quot;
comma
id|mp
)paren
)paren
suffix:semicolon
r_return
id|mp
suffix:semicolon
)brace
DECL|function|hold_metapage
r_void
id|hold_metapage
c_func
(paren
id|metapage_t
op_star
id|mp
comma
r_int
id|force
)paren
(brace
id|spin_lock
c_func
(paren
op_amp
id|meta_lock
)paren
suffix:semicolon
id|mp-&gt;count
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|force
)paren
(brace
id|ASSERT
(paren
op_logical_neg
(paren
id|test_bit
c_func
(paren
id|META_forced
comma
op_amp
id|mp-&gt;flag
)paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|trylock_metapage
c_func
(paren
id|mp
)paren
)paren
id|set_bit
c_func
(paren
id|META_forced
comma
op_amp
id|mp-&gt;flag
)paren
suffix:semicolon
)brace
r_else
id|lock_metapage
c_func
(paren
id|mp
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|meta_lock
)paren
suffix:semicolon
)brace
DECL|function|__write_metapage
r_static
r_void
id|__write_metapage
c_func
(paren
id|metapage_t
op_star
id|mp
)paren
(brace
r_struct
id|inode
op_star
id|ip
op_assign
(paren
r_struct
id|inode
op_star
)paren
id|mp-&gt;mapping-&gt;host
suffix:semicolon
r_int
r_int
id|page_index
suffix:semicolon
r_int
r_int
id|page_offset
suffix:semicolon
r_int
id|rc
suffix:semicolon
r_int
id|l2bsize
op_assign
id|ip-&gt;i_sb-&gt;s_blocksize_bits
suffix:semicolon
r_int
id|l2BlocksPerPage
op_assign
id|PAGE_CACHE_SHIFT
op_minus
id|l2bsize
suffix:semicolon
id|jFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;__write_metapage: mp = 0x%p&bslash;n&quot;
comma
id|mp
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|META_discard
comma
op_amp
id|mp-&gt;flag
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t; * This metadata is no longer valid&n;&t;&t; */
id|clear_bit
c_func
(paren
id|META_dirty
comma
op_amp
id|mp-&gt;flag
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|page_index
op_assign
id|mp-&gt;page-&gt;index
suffix:semicolon
id|page_offset
op_assign
(paren
id|mp-&gt;index
op_minus
(paren
id|page_index
op_lshift
id|l2BlocksPerPage
)paren
)paren
op_lshift
id|l2bsize
suffix:semicolon
id|rc
op_assign
id|mp-&gt;mapping-&gt;a_ops
op_member_access_from_pointer
id|prepare_write
c_func
(paren
l_int|NULL
comma
id|mp-&gt;page
comma
id|page_offset
comma
id|page_offset
op_plus
id|mp-&gt;logical_size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|jERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;prepare_write return %d!&bslash;n&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
id|ClearPageUptodate
c_func
(paren
id|mp-&gt;page
)paren
suffix:semicolon
id|kunmap
c_func
(paren
id|mp-&gt;page
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|META_dirty
comma
op_amp
id|mp-&gt;flag
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|rc
op_assign
id|mp-&gt;mapping-&gt;a_ops
op_member_access_from_pointer
id|commit_write
c_func
(paren
l_int|NULL
comma
id|mp-&gt;page
comma
id|page_offset
comma
id|page_offset
op_plus
id|mp-&gt;logical_size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|jERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;commit_write returned %d&bslash;n&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
)brace
id|clear_bit
c_func
(paren
id|META_dirty
comma
op_amp
id|mp-&gt;flag
)paren
suffix:semicolon
id|jFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;__write_metapage done&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
DECL|function|release_metapage
r_void
id|release_metapage
c_func
(paren
id|metapage_t
op_star
id|mp
)paren
(brace
id|log_t
op_star
id|log
suffix:semicolon
r_struct
id|inode
op_star
id|ip
suffix:semicolon
id|jFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;release_metapage: mp = 0x%p, flag = 0x%lx&bslash;n&quot;
comma
id|mp
comma
id|mp-&gt;flag
)paren
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|meta_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|META_forced
comma
op_amp
id|mp-&gt;flag
)paren
)paren
(brace
id|clear_bit
c_func
(paren
id|META_forced
comma
op_amp
id|mp-&gt;flag
)paren
suffix:semicolon
id|mp-&gt;count
op_decrement
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|meta_lock
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|ip
op_assign
(paren
r_struct
id|inode
op_star
)paren
id|mp-&gt;mapping-&gt;host
suffix:semicolon
m_assert
(paren
id|mp-&gt;count
)paren
suffix:semicolon
r_if
c_cond
(paren
op_decrement
id|mp-&gt;count
op_logical_or
id|atomic_read
c_func
(paren
op_amp
id|mp-&gt;nohomeok
)paren
)paren
(brace
id|unlock_metapage
c_func
(paren
id|mp
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|meta_lock
)paren
suffix:semicolon
)brace
r_else
(brace
id|remove_from_hash
c_func
(paren
id|mp
comma
id|meta_hash
c_func
(paren
id|mp-&gt;mapping
comma
id|mp-&gt;index
)paren
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|meta_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mp-&gt;page
)paren
(brace
id|kunmap
c_func
(paren
id|mp-&gt;page
)paren
suffix:semicolon
id|mp-&gt;data
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|META_dirty
comma
op_amp
id|mp-&gt;flag
)paren
)paren
id|__write_metapage
c_func
(paren
id|mp
)paren
suffix:semicolon
id|UnlockPage
c_func
(paren
id|mp-&gt;page
)paren
suffix:semicolon
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|META_sync
comma
op_amp
id|mp-&gt;flag
)paren
)paren
(brace
id|sync_metapage
c_func
(paren
id|mp
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|META_sync
comma
op_amp
id|mp-&gt;flag
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|META_discard
comma
op_amp
id|mp-&gt;flag
)paren
)paren
id|invalidate_page
c_func
(paren
id|mp
)paren
suffix:semicolon
id|page_cache_release
c_func
(paren
id|mp-&gt;page
)paren
suffix:semicolon
id|INCREMENT
c_func
(paren
id|mpStat.pagefree
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|mp-&gt;lsn
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * Remove metapage from logsynclist.&n;&t;&t;&t; */
id|log
op_assign
id|mp-&gt;log
suffix:semicolon
id|LOGSYNC_LOCK
c_func
(paren
id|log
)paren
suffix:semicolon
id|mp-&gt;log
op_assign
l_int|0
suffix:semicolon
id|mp-&gt;lsn
op_assign
l_int|0
suffix:semicolon
id|mp-&gt;clsn
op_assign
l_int|0
suffix:semicolon
id|log-&gt;count
op_decrement
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|mp-&gt;synclist
)paren
suffix:semicolon
id|LOGSYNC_UNLOCK
c_func
(paren
id|log
)paren
suffix:semicolon
)brace
id|free_metapage
c_func
(paren
id|mp
)paren
suffix:semicolon
)brace
id|jFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;release_metapage: done&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
DECL|function|invalidate_metapages
r_void
id|invalidate_metapages
c_func
(paren
r_struct
id|inode
op_star
id|ip
comma
r_int
r_int
id|addr
comma
r_int
r_int
id|len
)paren
(brace
id|metapage_t
op_star
op_star
id|hash_ptr
suffix:semicolon
r_int
r_int
id|lblock
suffix:semicolon
r_int
id|l2BlocksPerPage
op_assign
id|PAGE_CACHE_SHIFT
op_minus
id|ip-&gt;i_sb-&gt;s_blocksize_bits
suffix:semicolon
r_struct
id|address_space
op_star
id|mapping
op_assign
id|ip-&gt;i_mapping
suffix:semicolon
id|metapage_t
op_star
id|mp
suffix:semicolon
macro_line|#ifndef MODULE
r_struct
id|page
op_star
id|page
suffix:semicolon
macro_line|#endif
multiline_comment|/*&n;&t; * First, mark metapages to discard.  They will eventually be&n;&t; * released, but should not be written.&n;&t; */
r_for
c_loop
(paren
id|lblock
op_assign
id|addr
suffix:semicolon
id|lblock
OL
id|addr
op_plus
id|len
suffix:semicolon
id|lblock
op_add_assign
l_int|1
op_lshift
id|l2BlocksPerPage
)paren
(brace
id|hash_ptr
op_assign
id|meta_hash
c_func
(paren
id|mapping
comma
id|lblock
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|meta_lock
)paren
suffix:semicolon
id|mp
op_assign
id|search_hash
c_func
(paren
id|hash_ptr
comma
id|mapping
comma
id|lblock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mp
)paren
(brace
id|set_bit
c_func
(paren
id|META_discard
comma
op_amp
id|mp-&gt;flag
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|meta_lock
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t;&t; * If in the metapage cache, we&squot;ve got the page locked&n;&t;&t;&t; */
macro_line|#ifdef MODULE
id|UnlockPage
c_func
(paren
id|mp-&gt;page
)paren
suffix:semicolon
id|generic_buffer_fdatasync
c_func
(paren
id|mp-&gt;mapping-&gt;host
comma
id|mp-&gt;index
comma
id|mp-&gt;index
op_plus
l_int|1
)paren
suffix:semicolon
id|lock_page
c_func
(paren
id|mp-&gt;page
)paren
suffix:semicolon
macro_line|#else
id|block_flushpage
c_func
(paren
id|mp-&gt;page
comma
l_int|0
)paren
suffix:semicolon
macro_line|#endif
)brace
r_else
(brace
id|spin_unlock
c_func
(paren
op_amp
id|meta_lock
)paren
suffix:semicolon
macro_line|#ifdef MODULE
id|generic_buffer_fdatasync
c_func
(paren
id|ip
comma
id|lblock
op_lshift
id|l2BlocksPerPage
comma
(paren
id|lblock
op_plus
l_int|1
)paren
op_lshift
id|l2BlocksPerPage
)paren
suffix:semicolon
macro_line|#else
id|page
op_assign
id|find_lock_page
c_func
(paren
id|mapping
comma
id|lblock
op_rshift
id|l2BlocksPerPage
)paren
suffix:semicolon
r_if
c_cond
(paren
id|page
)paren
(brace
id|block_flushpage
c_func
(paren
id|page
comma
l_int|0
)paren
suffix:semicolon
id|UnlockPage
c_func
(paren
id|page
)paren
suffix:semicolon
)brace
macro_line|#endif
)brace
)brace
)brace
DECL|function|invalidate_inode_metapages
r_void
id|invalidate_inode_metapages
c_func
(paren
r_struct
id|inode
op_star
id|inode
)paren
(brace
r_struct
id|list_head
op_star
id|ptr
suffix:semicolon
id|metapage_t
op_star
id|mp
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|meta_lock
)paren
suffix:semicolon
id|list_for_each
c_func
(paren
id|ptr
comma
op_amp
id|JFS_IP
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|mp_list
)paren
(brace
id|mp
op_assign
id|list_entry
c_func
(paren
id|ptr
comma
id|metapage_t
comma
id|inode_list
)paren
suffix:semicolon
id|clear_bit
c_func
(paren
id|META_dirty
comma
op_amp
id|mp-&gt;flag
)paren
suffix:semicolon
id|set_bit
c_func
(paren
id|META_discard
comma
op_amp
id|mp-&gt;flag
)paren
suffix:semicolon
id|kunmap
c_func
(paren
id|mp-&gt;page
)paren
suffix:semicolon
id|UnlockPage
c_func
(paren
id|mp-&gt;page
)paren
suffix:semicolon
id|page_cache_release
c_func
(paren
id|mp-&gt;page
)paren
suffix:semicolon
id|INCREMENT
c_func
(paren
id|mpStat.pagefree
)paren
suffix:semicolon
id|mp-&gt;data
op_assign
l_int|0
suffix:semicolon
id|mp-&gt;page
op_assign
l_int|0
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|meta_lock
)paren
suffix:semicolon
id|truncate_inode_pages
c_func
(paren
id|inode-&gt;i_mapping
comma
l_int|0
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_JFS_STATISTICS
DECL|function|jfs_mpstat_read
r_int
id|jfs_mpstat_read
c_func
(paren
r_char
op_star
id|buffer
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|offset
comma
r_int
id|length
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
r_int
id|len
op_assign
l_int|0
suffix:semicolon
id|off_t
id|begin
suffix:semicolon
id|len
op_add_assign
id|sprintf
c_func
(paren
id|buffer
comma
l_string|&quot;JFS Metapage statistics&bslash;n&quot;
l_string|&quot;=======================&bslash;n&quot;
l_string|&quot;metapages in use = %d&bslash;n&quot;
l_string|&quot;page allocations = %d&bslash;n&quot;
l_string|&quot;page frees = %d&bslash;n&quot;
l_string|&quot;lock waits = %d&bslash;n&quot;
l_string|&quot;allocation waits = %d&bslash;n&quot;
comma
id|metapages
op_minus
id|free_metapages
comma
id|mpStat.pagealloc
comma
id|mpStat.pagefree
comma
id|mpStat.lockwait
comma
id|mpStat.allocwait
)paren
suffix:semicolon
id|begin
op_assign
id|offset
suffix:semicolon
op_star
id|start
op_assign
id|buffer
op_plus
id|begin
suffix:semicolon
id|len
op_sub_assign
id|begin
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|length
)paren
id|len
op_assign
id|length
suffix:semicolon
r_else
op_star
id|eof
op_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
l_int|0
)paren
id|len
op_assign
l_int|0
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
macro_line|#endif
eof
