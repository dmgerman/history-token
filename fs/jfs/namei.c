multiline_comment|/*&n; *   Copyright (c) International Business Machines Corp., 2000-2002&n; *&n; *   This program is free software;  you can redistribute it and/or modify&n; *   it under the terms of the GNU General Public License as published by&n; *   the Free Software Foundation; either version 2 of the License, or &n; *   (at your option) any later version.&n; * &n; *   This program is distributed in the hope that it will be useful,&n; *   but WITHOUT ANY WARRANTY;  without even the implied warranty of&n; *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See&n; *   the GNU General Public License for more details.&n; *&n; *   You should have received a copy of the GNU General Public License&n; *   along with this program;  if not, write to the Free Software &n; *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA&n; */
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/locks.h&gt;
macro_line|#include &quot;jfs_incore.h&quot;
macro_line|#include &quot;jfs_inode.h&quot;
macro_line|#include &quot;jfs_dinode.h&quot;
macro_line|#include &quot;jfs_dmap.h&quot;
macro_line|#include &quot;jfs_unicode.h&quot;
macro_line|#include &quot;jfs_metapage.h&quot;
macro_line|#include &quot;jfs_debug.h&quot;
r_extern
r_struct
id|inode_operations
id|jfs_file_inode_operations
suffix:semicolon
r_extern
r_struct
id|inode_operations
id|jfs_symlink_inode_operations
suffix:semicolon
r_extern
r_struct
id|file_operations
id|jfs_file_operations
suffix:semicolon
r_extern
r_struct
id|address_space_operations
id|jfs_aops
suffix:semicolon
r_extern
r_int
id|jfs_fsync
c_func
(paren
r_struct
id|file
op_star
comma
r_struct
id|dentry
op_star
comma
r_int
)paren
suffix:semicolon
r_extern
r_void
id|jfs_truncate_nolock
c_func
(paren
r_struct
id|inode
op_star
comma
id|loff_t
)paren
suffix:semicolon
multiline_comment|/*&n; * forward references&n; */
DECL|variable|jfs_dir_inode_operations
r_struct
id|inode_operations
id|jfs_dir_inode_operations
suffix:semicolon
DECL|variable|jfs_dir_operations
r_struct
id|file_operations
id|jfs_dir_operations
suffix:semicolon
id|s64
id|commitZeroLink
c_func
(paren
id|tid_t
comma
r_struct
id|inode
op_star
)paren
suffix:semicolon
multiline_comment|/*&n; * NAME:&t;jfs_create(dip, dentry, mode)&n; *&n; * FUNCTION:&t;create a regular file in the parent directory &lt;dip&gt;&n; *&t;&t;with name = &lt;from dentry&gt; and mode = &lt;mode&gt;&n; *&n; * PARAMETER:&t;dip &t;- parent directory vnode&n; *&t;&t;dentry&t;- dentry of new file&n; *&t;&t;mode&t;- create mode (rwxrwxrwx).&n; *&n; * RETURN:&t;Errors from subroutines&n; *&n; */
DECL|function|jfs_create
r_int
id|jfs_create
c_func
(paren
r_struct
id|inode
op_star
id|dip
comma
r_struct
id|dentry
op_star
id|dentry
comma
r_int
id|mode
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|tid_t
id|tid
suffix:semicolon
multiline_comment|/* transaction id */
r_struct
id|inode
op_star
id|ip
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* child directory inode */
id|ino_t
id|ino
suffix:semicolon
id|component_t
id|dname
suffix:semicolon
multiline_comment|/* child directory name */
id|btstack_t
id|btstack
suffix:semicolon
r_struct
id|inode
op_star
id|iplist
(braket
l_int|2
)braket
suffix:semicolon
id|tblock_t
op_star
id|tblk
suffix:semicolon
id|jFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;jfs_create: dip:0x%p name:%s&bslash;n&quot;
comma
id|dip
comma
id|dentry-&gt;d_name.name
)paren
)paren
suffix:semicolon
id|IWRITE_LOCK
c_func
(paren
id|dip
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * search parent directory for entry/freespace&n;&t; * (dtSearch() returns parent directory page pinned)&n;&t; */
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|get_UCSname
c_func
(paren
op_amp
id|dname
comma
id|dentry
comma
id|JFS_SBI
c_func
(paren
id|dip-&gt;i_sb
)paren
op_member_access_from_pointer
id|nls_tab
)paren
)paren
)paren
r_goto
id|out1
suffix:semicolon
multiline_comment|/*&n;&t; * Either iAlloc() or txBegin() may block.  Deadlock can occur if we&n;&t; * block there while holding dtree page, so we allocate the inode &amp;&n;&t; * begin the transaction before we search the directory.&n;&t; */
id|ip
op_assign
id|ialloc
c_func
(paren
id|dip
comma
id|mode
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ip
op_eq
l_int|NULL
)paren
(brace
id|rc
op_assign
id|ENOSPC
suffix:semicolon
r_goto
id|out2
suffix:semicolon
)brace
id|tid
op_assign
id|txBegin
c_func
(paren
id|dip-&gt;i_sb
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|dtSearch
c_func
(paren
id|dip
comma
op_amp
id|dname
comma
op_amp
id|ino
comma
op_amp
id|btstack
comma
id|JFS_CREATE
)paren
)paren
)paren
(brace
id|jERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;jfs_create: dtSearch returned %d&bslash;n&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
id|ip-&gt;i_nlink
op_assign
l_int|0
suffix:semicolon
id|iput
c_func
(paren
id|ip
)paren
suffix:semicolon
id|txEnd
c_func
(paren
id|tid
)paren
suffix:semicolon
r_goto
id|out2
suffix:semicolon
)brace
id|tblk
op_assign
id|tid_to_tblock
c_func
(paren
id|tid
)paren
suffix:semicolon
id|tblk-&gt;xflag
op_or_assign
id|COMMIT_CREATE
suffix:semicolon
id|tblk-&gt;ip
op_assign
id|ip
suffix:semicolon
id|iplist
(braket
l_int|0
)braket
op_assign
id|dip
suffix:semicolon
id|iplist
(braket
l_int|1
)braket
op_assign
id|ip
suffix:semicolon
multiline_comment|/*&n;&t; * initialize the child XAD tree root in-line in inode&n;&t; */
id|xtInitRoot
c_func
(paren
id|tid
comma
id|ip
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * create entry in parent directory for child directory&n;&t; * (dtInsert() releases parent directory page)&n;&t; */
id|ino
op_assign
id|ip-&gt;i_ino
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|dtInsert
c_func
(paren
id|tid
comma
id|dip
comma
op_amp
id|dname
comma
op_amp
id|ino
comma
op_amp
id|btstack
)paren
)paren
)paren
(brace
id|jERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;jfs_create: dtInsert returned %d&bslash;n&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
multiline_comment|/* discard new inode */
id|ip-&gt;i_nlink
op_assign
l_int|0
suffix:semicolon
id|iput
c_func
(paren
id|ip
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
id|EIO
)paren
id|txAbort
c_func
(paren
id|tid
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Marks Filesystem dirty */
r_else
id|txAbort
c_func
(paren
id|tid
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Filesystem full */
id|txEnd
c_func
(paren
id|tid
)paren
suffix:semicolon
r_goto
id|out2
suffix:semicolon
)brace
id|ip-&gt;i_op
op_assign
op_amp
id|jfs_file_inode_operations
suffix:semicolon
id|ip-&gt;i_fop
op_assign
op_amp
id|jfs_file_operations
suffix:semicolon
id|ip-&gt;i_mapping-&gt;a_ops
op_assign
op_amp
id|jfs_aops
suffix:semicolon
id|insert_inode_hash
c_func
(paren
id|ip
)paren
suffix:semicolon
id|mark_inode_dirty
c_func
(paren
id|ip
)paren
suffix:semicolon
id|d_instantiate
c_func
(paren
id|dentry
comma
id|ip
)paren
suffix:semicolon
id|dip-&gt;i_version
op_assign
op_increment
id|event
suffix:semicolon
id|dip-&gt;i_ctime
op_assign
id|dip-&gt;i_mtime
op_assign
id|CURRENT_TIME
suffix:semicolon
id|mark_inode_dirty
c_func
(paren
id|dip
)paren
suffix:semicolon
id|rc
op_assign
id|txCommit
c_func
(paren
id|tid
comma
l_int|2
comma
op_amp
id|iplist
(braket
l_int|0
)braket
comma
l_int|0
)paren
suffix:semicolon
id|txEnd
c_func
(paren
id|tid
)paren
suffix:semicolon
id|out2
suffix:colon
id|free_UCSname
c_func
(paren
op_amp
id|dname
)paren
suffix:semicolon
id|out1
suffix:colon
id|IWRITE_UNLOCK
c_func
(paren
id|dip
)paren
suffix:semicolon
id|jFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;jfs_create: rc:%d&bslash;n&quot;
comma
op_minus
id|rc
)paren
)paren
suffix:semicolon
r_return
op_minus
id|rc
suffix:semicolon
)brace
multiline_comment|/*&n; * NAME:&t;jfs_mkdir(dip, dentry, mode)&n; *&n; * FUNCTION:&t;create a child directory in the parent directory &lt;dip&gt;&n; *&t;&t;with name = &lt;from dentry&gt; and mode = &lt;mode&gt;&n; *&n; * PARAMETER:&t;dip &t;- parent directory vnode&n; *&t;&t;dentry&t;- dentry of child directory&n; *&t;&t;mode&t;- create mode (rwxrwxrwx).&n; *&n; * RETURN:&t;Errors from subroutines&n; *&n; * note:&n; * EACCESS: user needs search+write permission on the parent directory&n; */
DECL|function|jfs_mkdir
r_int
id|jfs_mkdir
c_func
(paren
r_struct
id|inode
op_star
id|dip
comma
r_struct
id|dentry
op_star
id|dentry
comma
r_int
id|mode
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|tid_t
id|tid
suffix:semicolon
multiline_comment|/* transaction id */
r_struct
id|inode
op_star
id|ip
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* child directory inode */
id|ino_t
id|ino
suffix:semicolon
id|component_t
id|dname
suffix:semicolon
multiline_comment|/* child directory name */
id|btstack_t
id|btstack
suffix:semicolon
r_struct
id|inode
op_star
id|iplist
(braket
l_int|2
)braket
suffix:semicolon
id|tblock_t
op_star
id|tblk
suffix:semicolon
id|jFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;jfs_mkdir: dip:0x%p name:%s&bslash;n&quot;
comma
id|dip
comma
id|dentry-&gt;d_name.name
)paren
)paren
suffix:semicolon
id|IWRITE_LOCK
c_func
(paren
id|dip
)paren
suffix:semicolon
multiline_comment|/* link count overflow on parent directory ? */
r_if
c_cond
(paren
id|dip-&gt;i_nlink
op_eq
id|JFS_LINK_MAX
)paren
(brace
id|rc
op_assign
id|EMLINK
suffix:semicolon
r_goto
id|out1
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * search parent directory for entry/freespace&n;&t; * (dtSearch() returns parent directory page pinned)&n;&t; */
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|get_UCSname
c_func
(paren
op_amp
id|dname
comma
id|dentry
comma
id|JFS_SBI
c_func
(paren
id|dip-&gt;i_sb
)paren
op_member_access_from_pointer
id|nls_tab
)paren
)paren
)paren
r_goto
id|out1
suffix:semicolon
multiline_comment|/*&n;&t; * Either iAlloc() or txBegin() may block.  Deadlock can occur if we&n;&t; * block there while holding dtree page, so we allocate the inode &amp;&n;&t; * begin the transaction before we search the directory.&n;&t; */
id|ip
op_assign
id|ialloc
c_func
(paren
id|dip
comma
id|S_IFDIR
op_or
id|mode
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ip
op_eq
l_int|NULL
)paren
(brace
id|rc
op_assign
id|ENOSPC
suffix:semicolon
r_goto
id|out2
suffix:semicolon
)brace
id|tid
op_assign
id|txBegin
c_func
(paren
id|dip-&gt;i_sb
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|dtSearch
c_func
(paren
id|dip
comma
op_amp
id|dname
comma
op_amp
id|ino
comma
op_amp
id|btstack
comma
id|JFS_CREATE
)paren
)paren
)paren
(brace
id|jERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;jfs_mkdir: dtSearch returned %d&bslash;n&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
id|ip-&gt;i_nlink
op_assign
l_int|0
suffix:semicolon
id|iput
c_func
(paren
id|ip
)paren
suffix:semicolon
id|txEnd
c_func
(paren
id|tid
)paren
suffix:semicolon
r_goto
id|out2
suffix:semicolon
)brace
id|tblk
op_assign
id|tid_to_tblock
c_func
(paren
id|tid
)paren
suffix:semicolon
id|tblk-&gt;xflag
op_or_assign
id|COMMIT_CREATE
suffix:semicolon
id|tblk-&gt;ip
op_assign
id|ip
suffix:semicolon
id|iplist
(braket
l_int|0
)braket
op_assign
id|dip
suffix:semicolon
id|iplist
(braket
l_int|1
)braket
op_assign
id|ip
suffix:semicolon
multiline_comment|/*&n;&t; * initialize the child directory in-line in inode&n;&t; */
id|dtInitRoot
c_func
(paren
id|tid
comma
id|ip
comma
id|dip-&gt;i_ino
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * create entry in parent directory for child directory&n;&t; * (dtInsert() releases parent directory page)&n;&t; */
id|ino
op_assign
id|ip-&gt;i_ino
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|dtInsert
c_func
(paren
id|tid
comma
id|dip
comma
op_amp
id|dname
comma
op_amp
id|ino
comma
op_amp
id|btstack
)paren
)paren
)paren
(brace
id|jERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;jfs_mkdir: dtInsert returned %d&bslash;n&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
multiline_comment|/* discard new directory inode */
id|ip-&gt;i_nlink
op_assign
l_int|0
suffix:semicolon
id|iput
c_func
(paren
id|ip
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
id|EIO
)paren
id|txAbort
c_func
(paren
id|tid
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Marks Filesystem dirty */
r_else
id|txAbort
c_func
(paren
id|tid
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* Filesystem full */
id|txEnd
c_func
(paren
id|tid
)paren
suffix:semicolon
r_goto
id|out2
suffix:semicolon
)brace
id|ip-&gt;i_nlink
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* for &squot;.&squot; */
id|ip-&gt;i_op
op_assign
op_amp
id|jfs_dir_inode_operations
suffix:semicolon
id|ip-&gt;i_fop
op_assign
op_amp
id|jfs_dir_operations
suffix:semicolon
id|ip-&gt;i_mapping-&gt;a_ops
op_assign
op_amp
id|jfs_aops
suffix:semicolon
id|ip-&gt;i_mapping-&gt;gfp_mask
op_assign
id|GFP_NOFS
suffix:semicolon
id|insert_inode_hash
c_func
(paren
id|ip
)paren
suffix:semicolon
id|mark_inode_dirty
c_func
(paren
id|ip
)paren
suffix:semicolon
id|d_instantiate
c_func
(paren
id|dentry
comma
id|ip
)paren
suffix:semicolon
multiline_comment|/* update parent directory inode */
id|dip-&gt;i_nlink
op_increment
suffix:semicolon
multiline_comment|/* for &squot;..&squot; from child directory */
id|dip-&gt;i_version
op_assign
op_increment
id|event
suffix:semicolon
id|dip-&gt;i_ctime
op_assign
id|dip-&gt;i_mtime
op_assign
id|CURRENT_TIME
suffix:semicolon
id|mark_inode_dirty
c_func
(paren
id|dip
)paren
suffix:semicolon
id|rc
op_assign
id|txCommit
c_func
(paren
id|tid
comma
l_int|2
comma
op_amp
id|iplist
(braket
l_int|0
)braket
comma
l_int|0
)paren
suffix:semicolon
id|txEnd
c_func
(paren
id|tid
)paren
suffix:semicolon
id|out2
suffix:colon
id|free_UCSname
c_func
(paren
op_amp
id|dname
)paren
suffix:semicolon
id|out1
suffix:colon
id|IWRITE_UNLOCK
c_func
(paren
id|dip
)paren
suffix:semicolon
id|jFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;jfs_mkdir: rc:%d&bslash;n&quot;
comma
op_minus
id|rc
)paren
)paren
suffix:semicolon
r_return
op_minus
id|rc
suffix:semicolon
)brace
multiline_comment|/*&n; * NAME:&t;jfs_rmdir(dip, dentry)&n; *&n; * FUNCTION:&t;remove a link to child directory&n; *&n; * PARAMETER:&t;dip &t;- parent inode&n; *&t;&t;dentry&t;- child directory dentry&n; *&n; * RETURN:&t;EINVAL&t;- if name is . or ..&n; *&t;&t;EINVAL  - if . or .. exist but are invalid.&n; *&t;&t;errors from subroutines&n; *&n; * note:&n; * if other threads have the directory open when the last link &n; * is removed, the &quot;.&quot; and &quot;..&quot; entries, if present, are removed before &n; * rmdir() returns and no new entries may be created in the directory, &n; * but the directory is not removed until the last reference to &n; * the directory is released (cf.unlink() of regular file).&n; */
DECL|function|jfs_rmdir
r_int
id|jfs_rmdir
c_func
(paren
r_struct
id|inode
op_star
id|dip
comma
r_struct
id|dentry
op_star
id|dentry
)paren
(brace
r_int
id|rc
suffix:semicolon
id|tid_t
id|tid
suffix:semicolon
multiline_comment|/* transaction id */
r_struct
id|inode
op_star
id|ip
op_assign
id|dentry-&gt;d_inode
suffix:semicolon
id|ino_t
id|ino
suffix:semicolon
id|component_t
id|dname
suffix:semicolon
r_struct
id|inode
op_star
id|iplist
(braket
l_int|2
)braket
suffix:semicolon
id|tblock_t
op_star
id|tblk
suffix:semicolon
id|jFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;jfs_rmdir: dip:0x%p name:%s&bslash;n&quot;
comma
id|dip
comma
id|dentry-&gt;d_name.name
)paren
)paren
suffix:semicolon
id|IWRITE_LOCK_LIST
c_func
(paren
l_int|2
comma
id|dip
comma
id|ip
)paren
suffix:semicolon
multiline_comment|/* directory must be empty to be removed */
r_if
c_cond
(paren
op_logical_neg
id|dtEmpty
c_func
(paren
id|ip
)paren
)paren
(brace
id|IWRITE_UNLOCK
c_func
(paren
id|ip
)paren
suffix:semicolon
id|IWRITE_UNLOCK
c_func
(paren
id|dip
)paren
suffix:semicolon
id|rc
op_assign
id|ENOTEMPTY
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|get_UCSname
c_func
(paren
op_amp
id|dname
comma
id|dentry
comma
id|JFS_SBI
c_func
(paren
id|dip-&gt;i_sb
)paren
op_member_access_from_pointer
id|nls_tab
)paren
)paren
)paren
(brace
id|IWRITE_UNLOCK
c_func
(paren
id|ip
)paren
suffix:semicolon
id|IWRITE_UNLOCK
c_func
(paren
id|dip
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|tid
op_assign
id|txBegin
c_func
(paren
id|dip-&gt;i_sb
comma
l_int|0
)paren
suffix:semicolon
id|iplist
(braket
l_int|0
)braket
op_assign
id|dip
suffix:semicolon
id|iplist
(braket
l_int|1
)braket
op_assign
id|ip
suffix:semicolon
id|tblk
op_assign
id|tid_to_tblock
c_func
(paren
id|tid
)paren
suffix:semicolon
id|tblk-&gt;xflag
op_or_assign
id|COMMIT_DELETE
suffix:semicolon
id|tblk-&gt;ip
op_assign
id|ip
suffix:semicolon
multiline_comment|/*&n;&t; * delete the entry of target directory from parent directory&n;&t; */
id|ino
op_assign
id|ip-&gt;i_ino
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|dtDelete
c_func
(paren
id|tid
comma
id|dip
comma
op_amp
id|dname
comma
op_amp
id|ino
comma
id|JFS_REMOVE
)paren
)paren
)paren
(brace
id|jERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;jfs_rmdir: dtDelete returned %d&bslash;n&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
id|EIO
)paren
id|txAbort
c_func
(paren
id|tid
comma
l_int|1
)paren
suffix:semicolon
id|txEnd
c_func
(paren
id|tid
)paren
suffix:semicolon
id|IWRITE_UNLOCK
c_func
(paren
id|ip
)paren
suffix:semicolon
id|IWRITE_UNLOCK
c_func
(paren
id|dip
)paren
suffix:semicolon
r_goto
id|out2
suffix:semicolon
)brace
multiline_comment|/* update parent directory&squot;s link count corresponding&n;&t; * to &quot;..&quot; entry of the target directory deleted&n;&t; */
id|dip-&gt;i_nlink
op_decrement
suffix:semicolon
id|dip-&gt;i_ctime
op_assign
id|dip-&gt;i_mtime
op_assign
id|CURRENT_TIME
suffix:semicolon
id|dip-&gt;i_version
op_assign
op_increment
id|event
suffix:semicolon
id|mark_inode_dirty
c_func
(paren
id|dip
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * OS/2 could have created EA and/or ACL&n;&t; */
multiline_comment|/* free EA from both persistent and working map */
r_if
c_cond
(paren
id|JFS_IP
c_func
(paren
id|ip
)paren
op_member_access_from_pointer
id|ea.flag
op_amp
id|DXD_EXTENT
)paren
(brace
multiline_comment|/* free EA pages */
id|txEA
c_func
(paren
id|tid
comma
id|ip
comma
op_amp
id|JFS_IP
c_func
(paren
id|ip
)paren
op_member_access_from_pointer
id|ea
comma
l_int|NULL
)paren
suffix:semicolon
)brace
id|JFS_IP
c_func
(paren
id|ip
)paren
op_member_access_from_pointer
id|ea.flag
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* free ACL from both persistent and working map */
r_if
c_cond
(paren
id|JFS_IP
c_func
(paren
id|ip
)paren
op_member_access_from_pointer
id|acl.flag
op_amp
id|DXD_EXTENT
)paren
(brace
multiline_comment|/* free ACL pages */
id|txEA
c_func
(paren
id|tid
comma
id|ip
comma
op_amp
id|JFS_IP
c_func
(paren
id|ip
)paren
op_member_access_from_pointer
id|acl
comma
l_int|NULL
)paren
suffix:semicolon
)brace
id|JFS_IP
c_func
(paren
id|ip
)paren
op_member_access_from_pointer
id|acl.flag
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* mark the target directory as deleted */
id|ip-&gt;i_nlink
op_assign
l_int|0
suffix:semicolon
id|mark_inode_dirty
c_func
(paren
id|ip
)paren
suffix:semicolon
id|rc
op_assign
id|txCommit
c_func
(paren
id|tid
comma
l_int|2
comma
op_amp
id|iplist
(braket
l_int|0
)braket
comma
l_int|0
)paren
suffix:semicolon
id|txEnd
c_func
(paren
id|tid
)paren
suffix:semicolon
id|IWRITE_UNLOCK
c_func
(paren
id|ip
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Truncating the directory index table is not guaranteed.  It&n;&t; * may need to be done iteratively&n;&t; */
r_if
c_cond
(paren
id|test_cflag
c_func
(paren
id|COMMIT_Stale
comma
id|dip
)paren
)paren
(brace
r_if
c_cond
(paren
id|dip-&gt;i_size
OG
l_int|1
)paren
id|jfs_truncate_nolock
c_func
(paren
id|dip
comma
l_int|0
)paren
suffix:semicolon
id|clear_cflag
c_func
(paren
id|COMMIT_Stale
comma
id|dip
)paren
suffix:semicolon
)brace
id|IWRITE_UNLOCK
c_func
(paren
id|dip
)paren
suffix:semicolon
id|d_delete
c_func
(paren
id|dentry
)paren
suffix:semicolon
id|out2
suffix:colon
id|free_UCSname
c_func
(paren
op_amp
id|dname
)paren
suffix:semicolon
id|out
suffix:colon
id|jFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;jfs_rmdir: rc:%d&bslash;n&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
r_return
op_minus
id|rc
suffix:semicolon
)brace
multiline_comment|/*&n; * NAME:&t;jfs_unlink(dip, dentry)&n; *&n; * FUNCTION:&t;remove a link to object &lt;vp&gt; named by &lt;name&gt; &n; *&t;&t;from parent directory &lt;dvp&gt;&n; *&n; * PARAMETER:&t;dip &t;- inode of parent directory&n; *&t;&t;dentry &t;- dentry of object to be removed&n; *&n; * RETURN:&t;errors from subroutines&n; *&n; * note:&n; * temporary file: if one or more processes have the file open&n; * when the last link is removed, the link will be removed before&n; * unlink() returns, but the removal of the file contents will be&n; * postponed until all references to the files are closed.&n; *&n; * JFS does NOT support unlink() on directories.&n; *&n; */
DECL|function|jfs_unlink
r_int
id|jfs_unlink
c_func
(paren
r_struct
id|inode
op_star
id|dip
comma
r_struct
id|dentry
op_star
id|dentry
)paren
(brace
r_int
id|rc
suffix:semicolon
id|tid_t
id|tid
suffix:semicolon
multiline_comment|/* transaction id */
r_struct
id|inode
op_star
id|ip
op_assign
id|dentry-&gt;d_inode
suffix:semicolon
id|ino_t
id|ino
suffix:semicolon
id|component_t
id|dname
suffix:semicolon
multiline_comment|/* object name */
r_struct
id|inode
op_star
id|iplist
(braket
l_int|2
)braket
suffix:semicolon
id|tblock_t
op_star
id|tblk
suffix:semicolon
id|s64
id|new_size
op_assign
l_int|0
suffix:semicolon
r_int
id|commit_flag
suffix:semicolon
id|jFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;jfs_unlink: dip:0x%p name:%s&bslash;n&quot;
comma
id|dip
comma
id|dentry-&gt;d_name.name
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|get_UCSname
c_func
(paren
op_amp
id|dname
comma
id|dentry
comma
id|JFS_SBI
c_func
(paren
id|dip-&gt;i_sb
)paren
op_member_access_from_pointer
id|nls_tab
)paren
)paren
)paren
r_goto
id|out
suffix:semicolon
id|IWRITE_LOCK_LIST
c_func
(paren
l_int|2
comma
id|ip
comma
id|dip
)paren
suffix:semicolon
id|tid
op_assign
id|txBegin
c_func
(paren
id|dip-&gt;i_sb
comma
l_int|0
)paren
suffix:semicolon
id|iplist
(braket
l_int|0
)braket
op_assign
id|dip
suffix:semicolon
id|iplist
(braket
l_int|1
)braket
op_assign
id|ip
suffix:semicolon
multiline_comment|/*&n;&t; * delete the entry of target file from parent directory&n;&t; */
id|ino
op_assign
id|ip-&gt;i_ino
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|dtDelete
c_func
(paren
id|tid
comma
id|dip
comma
op_amp
id|dname
comma
op_amp
id|ino
comma
id|JFS_REMOVE
)paren
)paren
)paren
(brace
id|jERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;jfs_unlink: dtDelete returned %d&bslash;n&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
id|EIO
)paren
id|txAbort
c_func
(paren
id|tid
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Marks FS Dirty */
id|txEnd
c_func
(paren
id|tid
)paren
suffix:semicolon
id|IWRITE_UNLOCK
c_func
(paren
id|ip
)paren
suffix:semicolon
id|IWRITE_UNLOCK
c_func
(paren
id|dip
)paren
suffix:semicolon
r_goto
id|out1
suffix:semicolon
)brace
id|ASSERT
c_func
(paren
id|ip-&gt;i_nlink
)paren
suffix:semicolon
id|ip-&gt;i_ctime
op_assign
id|dip-&gt;i_ctime
op_assign
id|dip-&gt;i_mtime
op_assign
id|CURRENT_TIME
suffix:semicolon
id|dip-&gt;i_version
op_assign
op_increment
id|event
suffix:semicolon
id|mark_inode_dirty
c_func
(paren
id|dip
)paren
suffix:semicolon
multiline_comment|/* update target&squot;s inode */
id|ip-&gt;i_nlink
op_decrement
suffix:semicolon
id|mark_inode_dirty
c_func
(paren
id|ip
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *      commit zero link count object&n;&t; */
r_if
c_cond
(paren
id|ip-&gt;i_nlink
op_eq
l_int|0
)paren
(brace
m_assert
(paren
op_logical_neg
id|test_cflag
c_func
(paren
id|COMMIT_Nolink
comma
id|ip
)paren
)paren
suffix:semicolon
multiline_comment|/* free block resources */
r_if
c_cond
(paren
(paren
id|new_size
op_assign
id|commitZeroLink
c_func
(paren
id|tid
comma
id|ip
)paren
)paren
OL
l_int|0
)paren
(brace
id|txAbort
c_func
(paren
id|tid
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Marks FS Dirty */
id|txEnd
c_func
(paren
id|tid
)paren
suffix:semicolon
id|IWRITE_UNLOCK
c_func
(paren
id|ip
)paren
suffix:semicolon
id|IWRITE_UNLOCK
c_func
(paren
id|dip
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|new_size
suffix:semicolon
multiline_comment|/* We return -rc */
r_goto
id|out1
suffix:semicolon
)brace
id|tblk
op_assign
id|tid_to_tblock
c_func
(paren
id|tid
)paren
suffix:semicolon
id|tblk-&gt;xflag
op_or_assign
id|COMMIT_DELETE
suffix:semicolon
id|tblk-&gt;ip
op_assign
id|ip
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Incomplete truncate of file data can&n;&t; * result in timing problems unless we synchronously commit the&n;&t; * transaction.&n;&t; */
r_if
c_cond
(paren
id|new_size
)paren
id|commit_flag
op_assign
id|COMMIT_SYNC
suffix:semicolon
r_else
id|commit_flag
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; * If xtTruncate was incomplete, commit synchronously to avoid&n;&t; * timing complications&n;&t; */
id|rc
op_assign
id|txCommit
c_func
(paren
id|tid
comma
l_int|2
comma
op_amp
id|iplist
(braket
l_int|0
)braket
comma
id|commit_flag
)paren
suffix:semicolon
id|txEnd
c_func
(paren
id|tid
)paren
suffix:semicolon
r_while
c_loop
(paren
id|new_size
op_logical_and
(paren
id|rc
op_eq
l_int|0
)paren
)paren
(brace
id|tid
op_assign
id|txBegin
c_func
(paren
id|dip-&gt;i_sb
comma
l_int|0
)paren
suffix:semicolon
id|new_size
op_assign
id|xtTruncate_pmap
c_func
(paren
id|tid
comma
id|ip
comma
id|new_size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|new_size
OL
l_int|0
)paren
(brace
id|txAbort
c_func
(paren
id|tid
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Marks FS Dirty */
id|rc
op_assign
op_minus
id|new_size
suffix:semicolon
multiline_comment|/* We return -rc */
)brace
r_else
id|rc
op_assign
id|txCommit
c_func
(paren
id|tid
comma
l_int|2
comma
op_amp
id|iplist
(braket
l_int|0
)braket
comma
id|COMMIT_SYNC
)paren
suffix:semicolon
id|txEnd
c_func
(paren
id|tid
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|test_cflag
c_func
(paren
id|COMMIT_Holdlock
comma
id|ip
)paren
)paren
id|IWRITE_UNLOCK
c_func
(paren
id|ip
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Truncating the directory index table is not guaranteed.  It&n;&t; * may need to be done iteratively&n;&t; */
r_if
c_cond
(paren
id|test_cflag
c_func
(paren
id|COMMIT_Stale
comma
id|dip
)paren
)paren
(brace
r_if
c_cond
(paren
id|dip-&gt;i_size
OG
l_int|1
)paren
id|jfs_truncate_nolock
c_func
(paren
id|dip
comma
l_int|0
)paren
suffix:semicolon
id|clear_cflag
c_func
(paren
id|COMMIT_Stale
comma
id|dip
)paren
suffix:semicolon
)brace
id|IWRITE_UNLOCK
c_func
(paren
id|dip
)paren
suffix:semicolon
id|d_delete
c_func
(paren
id|dentry
)paren
suffix:semicolon
id|out1
suffix:colon
id|free_UCSname
c_func
(paren
op_amp
id|dname
)paren
suffix:semicolon
id|out
suffix:colon
id|jFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;jfs_unlink: rc:%d&bslash;n&quot;
comma
op_minus
id|rc
)paren
)paren
suffix:semicolon
r_return
op_minus
id|rc
suffix:semicolon
)brace
multiline_comment|/*&n; * NAME:&t;commitZeroLink()&n; *&n; * FUNCTION:    for non-directory, called by jfs_remove(),&n; *&t;&t;truncate a regular file, directory or symbolic&n; *&t;&t;link to zero length. return 0 if type is not &n; *&t;&t;one of these.&n; *&n; *&t;&t;if the file is currently associated with a VM segment&n; *&t;&t;only permanent disk and inode map resources are freed,&n; *&t;&t;and neither the inode nor indirect blocks are modified&n; *&t;&t;so that the resources can be later freed in the work&n; *&t;&t;map by ctrunc1.&n; *&t;&t;if there is no VM segment on entry, the resources are&n; *&t;&t;freed in both work and permanent map.&n; *&t;&t;(? for temporary file - memory object is cached even &n; *&t;&t;after no reference:&n; *&t;&t;reference count &gt; 0 -   )&n; *&n; * PARAMETERS:&t;cd&t;- pointer to commit data structure.&n; *&t;&t;&t;  current inode is the one to truncate.&n; *&n; * RETURN :&t;Errors from subroutines&n; */
DECL|function|commitZeroLink
id|s64
id|commitZeroLink
c_func
(paren
id|tid_t
id|tid
comma
r_struct
id|inode
op_star
id|ip
)paren
(brace
r_int
id|filetype
suffix:semicolon
id|tblock_t
op_star
id|tblk
suffix:semicolon
id|jFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;commitZeroLink: tid = %d, ip = 0x%p&bslash;n&quot;
comma
id|tid
comma
id|ip
)paren
)paren
suffix:semicolon
id|filetype
op_assign
id|ip-&gt;i_mode
op_amp
id|S_IFMT
suffix:semicolon
r_switch
c_cond
(paren
id|filetype
)paren
(brace
r_case
id|S_IFREG
suffix:colon
r_break
suffix:semicolon
r_case
id|S_IFLNK
suffix:colon
multiline_comment|/* fast symbolic link */
r_if
c_cond
(paren
id|ip-&gt;i_size
op_le
l_int|256
)paren
(brace
id|ip-&gt;i_size
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_break
suffix:semicolon
r_default
suffix:colon
m_assert
(paren
id|filetype
op_ne
id|S_IFDIR
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|set_cflag
c_func
(paren
id|COMMIT_Freewmap
comma
id|ip
)paren
suffix:semicolon
multiline_comment|/* mark transaction of block map update type */
id|tblk
op_assign
id|tid_to_tblock
c_func
(paren
id|tid
)paren
suffix:semicolon
id|tblk-&gt;xflag
op_or_assign
id|COMMIT_PMAP
suffix:semicolon
multiline_comment|/*&n;&t; * free EA&n;&t; */
r_if
c_cond
(paren
id|JFS_IP
c_func
(paren
id|ip
)paren
op_member_access_from_pointer
id|ea.flag
op_amp
id|DXD_EXTENT
)paren
multiline_comment|/* acquire maplock on EA to be freed from block map */
id|txEA
c_func
(paren
id|tid
comma
id|ip
comma
op_amp
id|JFS_IP
c_func
(paren
id|ip
)paren
op_member_access_from_pointer
id|ea
comma
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * free ACL&n;&t; */
r_if
c_cond
(paren
id|JFS_IP
c_func
(paren
id|ip
)paren
op_member_access_from_pointer
id|acl.flag
op_amp
id|DXD_EXTENT
)paren
multiline_comment|/* acquire maplock on EA to be freed from block map */
id|txEA
c_func
(paren
id|tid
comma
id|ip
comma
op_amp
id|JFS_IP
c_func
(paren
id|ip
)paren
op_member_access_from_pointer
id|acl
comma
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * free xtree/data (truncate to zero length):&n;&t; * free xtree/data pages from cache if COMMIT_PWMAP, &n;&t; * free xtree/data blocks from persistent block map, and&n;&t; * free xtree/data blocks from working block map if COMMIT_PWMAP;&n;&t; */
r_if
c_cond
(paren
id|ip-&gt;i_size
)paren
r_return
id|xtTruncate_pmap
c_func
(paren
id|tid
comma
id|ip
comma
l_int|0
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * NAME:&t;freeZeroLink()&n; *&n; * FUNCTION:    for non-directory, called by iClose(),&n; *&t;&t;free resources of a file from cache and WORKING map &n; *&t;&t;for a file previously committed with zero link count&n; *&t;&t;while associated with a pager object,&n; *&n; * PARAMETER:&t;ip&t;- pointer to inode of file.&n; *&n; * RETURN:&t;0 -ok&n; */
DECL|function|freeZeroLink
r_int
id|freeZeroLink
c_func
(paren
r_struct
id|inode
op_star
id|ip
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|type
suffix:semicolon
id|jFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;freeZeroLink: ip = 0x%p&bslash;n&quot;
comma
id|ip
)paren
)paren
suffix:semicolon
multiline_comment|/* return if not reg or symbolic link or if size is&n;&t; * already ok.&n;&t; */
id|type
op_assign
id|ip-&gt;i_mode
op_amp
id|S_IFMT
suffix:semicolon
r_switch
c_cond
(paren
id|type
)paren
(brace
r_case
id|S_IFREG
suffix:colon
r_break
suffix:semicolon
r_case
id|S_IFLNK
suffix:colon
multiline_comment|/* if its contained in inode nothing to do */
r_if
c_cond
(paren
id|ip-&gt;i_size
op_le
l_int|256
)paren
r_return
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * free EA&n;&t; */
r_if
c_cond
(paren
id|JFS_IP
c_func
(paren
id|ip
)paren
op_member_access_from_pointer
id|ea.flag
op_amp
id|DXD_EXTENT
)paren
(brace
id|s64
id|xaddr
suffix:semicolon
r_int
id|xlen
suffix:semicolon
id|maplock_t
id|maplock
suffix:semicolon
multiline_comment|/* maplock for COMMIT_WMAP */
id|pxdlock_t
op_star
id|pxdlock
suffix:semicolon
multiline_comment|/* maplock for COMMIT_WMAP */
multiline_comment|/* free EA pages from cache */
id|xaddr
op_assign
id|addressDXD
c_func
(paren
op_amp
id|JFS_IP
c_func
(paren
id|ip
)paren
op_member_access_from_pointer
id|ea
)paren
suffix:semicolon
id|xlen
op_assign
id|lengthDXD
c_func
(paren
op_amp
id|JFS_IP
c_func
(paren
id|ip
)paren
op_member_access_from_pointer
id|ea
)paren
suffix:semicolon
macro_line|#ifdef _STILL_TO_PORT
id|bmExtentInvalidate
c_func
(paren
id|ip
comma
id|xaddr
comma
id|xlen
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* free EA extent from working block map */
id|maplock.index
op_assign
l_int|1
suffix:semicolon
id|pxdlock
op_assign
(paren
id|pxdlock_t
op_star
)paren
op_amp
id|maplock
suffix:semicolon
id|pxdlock-&gt;flag
op_assign
id|mlckFREEPXD
suffix:semicolon
id|PXDaddress
c_func
(paren
op_amp
id|pxdlock-&gt;pxd
comma
id|xaddr
)paren
suffix:semicolon
id|PXDlength
c_func
(paren
op_amp
id|pxdlock-&gt;pxd
comma
id|xlen
)paren
suffix:semicolon
id|txFreeMap
c_func
(paren
id|ip
comma
id|pxdlock
comma
l_int|0
comma
id|COMMIT_WMAP
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * free ACL&n;&t; */
r_if
c_cond
(paren
id|JFS_IP
c_func
(paren
id|ip
)paren
op_member_access_from_pointer
id|acl.flag
op_amp
id|DXD_EXTENT
)paren
(brace
id|s64
id|xaddr
suffix:semicolon
r_int
id|xlen
suffix:semicolon
id|maplock_t
id|maplock
suffix:semicolon
multiline_comment|/* maplock for COMMIT_WMAP */
id|pxdlock_t
op_star
id|pxdlock
suffix:semicolon
multiline_comment|/* maplock for COMMIT_WMAP */
multiline_comment|/* free ACL pages from cache */
id|xaddr
op_assign
id|addressDXD
c_func
(paren
op_amp
id|JFS_IP
c_func
(paren
id|ip
)paren
op_member_access_from_pointer
id|acl
)paren
suffix:semicolon
id|xlen
op_assign
id|lengthDXD
c_func
(paren
op_amp
id|JFS_IP
c_func
(paren
id|ip
)paren
op_member_access_from_pointer
id|acl
)paren
suffix:semicolon
macro_line|#ifdef _STILL_TO_PORT
id|bmExtentInvalidate
c_func
(paren
id|ip
comma
id|xaddr
comma
id|xlen
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* free ACL extent from working block map */
id|maplock.index
op_assign
l_int|1
suffix:semicolon
id|pxdlock
op_assign
(paren
id|pxdlock_t
op_star
)paren
op_amp
id|maplock
suffix:semicolon
id|pxdlock-&gt;flag
op_assign
id|mlckFREEPXD
suffix:semicolon
id|PXDaddress
c_func
(paren
op_amp
id|pxdlock-&gt;pxd
comma
id|xaddr
)paren
suffix:semicolon
id|PXDlength
c_func
(paren
op_amp
id|pxdlock-&gt;pxd
comma
id|xlen
)paren
suffix:semicolon
id|txFreeMap
c_func
(paren
id|ip
comma
id|pxdlock
comma
l_int|0
comma
id|COMMIT_WMAP
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * free xtree/data (truncate to zero length):&n;&t; * free xtree/data pages from cache, and&n;&t; * free xtree/data blocks from working block map;&n;&t; */
r_if
c_cond
(paren
id|ip-&gt;i_size
)paren
id|rc
op_assign
id|xtTruncate
c_func
(paren
l_int|0
comma
id|ip
comma
l_int|0
comma
id|COMMIT_WMAP
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/*&n; * NAME:&t;jfs_link(vp, dvp, name, crp)&n; *&n; * FUNCTION:&t;create a link to &lt;vp&gt; by the name = &lt;name&gt;&n; *&t;&t;in the parent directory &lt;dvp&gt;&n; *&n; * PARAMETER:&t;vp &t;- target object&n; *&t;&t;dvp&t;- parent directory of new link&n; *&t;&t;name&t;- name of new link to target object&n; *&t;&t;crp&t;- credential&n; *&n; * RETURN:&t;Errors from subroutines&n; *&n; * note:&n; * JFS does NOT support link() on directories (to prevent circular&n; * path in the directory hierarchy);&n; * EPERM: the target object is a directory, and either the caller&n; * does not have appropriate privileges or the implementation prohibits&n; * using link() on directories [XPG4.2].&n; *&n; * JFS does NOT support links between file systems:&n; * EXDEV: target object and new link are on different file systems and&n; * implementation does not support links between file systems [XPG4.2].&n; */
DECL|function|jfs_link
r_int
id|jfs_link
c_func
(paren
r_struct
id|dentry
op_star
id|old_dentry
comma
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|dentry
op_star
id|dentry
)paren
(brace
r_int
id|rc
suffix:semicolon
id|tid_t
id|tid
suffix:semicolon
r_struct
id|inode
op_star
id|ip
op_assign
id|old_dentry-&gt;d_inode
suffix:semicolon
id|ino_t
id|ino
suffix:semicolon
id|component_t
id|dname
suffix:semicolon
id|btstack_t
id|btstack
suffix:semicolon
r_struct
id|inode
op_star
id|iplist
(braket
l_int|2
)braket
suffix:semicolon
id|jFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;jfs_link: %s %s&bslash;n&quot;
comma
id|old_dentry-&gt;d_name.name
comma
id|dentry-&gt;d_name.name
)paren
)paren
suffix:semicolon
id|IWRITE_LOCK_LIST
c_func
(paren
l_int|2
comma
id|dir
comma
id|ip
)paren
suffix:semicolon
id|tid
op_assign
id|txBegin
c_func
(paren
id|ip-&gt;i_sb
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ip-&gt;i_nlink
op_eq
id|JFS_LINK_MAX
)paren
(brace
id|rc
op_assign
id|EMLINK
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * scan parent directory for entry/freespace&n;&t; */
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|get_UCSname
c_func
(paren
op_amp
id|dname
comma
id|dentry
comma
id|JFS_SBI
c_func
(paren
id|ip-&gt;i_sb
)paren
op_member_access_from_pointer
id|nls_tab
)paren
)paren
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|dtSearch
c_func
(paren
id|dir
comma
op_amp
id|dname
comma
op_amp
id|ino
comma
op_amp
id|btstack
comma
id|JFS_CREATE
)paren
)paren
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/*&n;&t; * create entry for new link in parent directory&n;&t; */
id|ino
op_assign
id|ip-&gt;i_ino
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|dtInsert
c_func
(paren
id|tid
comma
id|dir
comma
op_amp
id|dname
comma
op_amp
id|ino
comma
op_amp
id|btstack
)paren
)paren
)paren
r_goto
id|out
suffix:semicolon
id|dir-&gt;i_version
op_assign
op_increment
id|event
suffix:semicolon
multiline_comment|/* update object inode */
id|ip-&gt;i_nlink
op_increment
suffix:semicolon
multiline_comment|/* for new link */
id|ip-&gt;i_ctime
op_assign
id|CURRENT_TIME
suffix:semicolon
id|mark_inode_dirty
c_func
(paren
id|dir
)paren
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|ip-&gt;i_count
)paren
suffix:semicolon
id|d_instantiate
c_func
(paren
id|dentry
comma
id|ip
)paren
suffix:semicolon
id|iplist
(braket
l_int|0
)braket
op_assign
id|ip
suffix:semicolon
id|iplist
(braket
l_int|1
)braket
op_assign
id|dir
suffix:semicolon
id|rc
op_assign
id|txCommit
c_func
(paren
id|tid
comma
l_int|2
comma
op_amp
id|iplist
(braket
l_int|0
)braket
comma
l_int|0
)paren
suffix:semicolon
id|out
suffix:colon
id|IWRITE_UNLOCK
c_func
(paren
id|dir
)paren
suffix:semicolon
id|IWRITE_UNLOCK
c_func
(paren
id|ip
)paren
suffix:semicolon
id|txEnd
c_func
(paren
id|tid
)paren
suffix:semicolon
id|jFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;jfs_link: rc:%d&bslash;n&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
r_return
op_minus
id|rc
suffix:semicolon
)brace
multiline_comment|/*&n; * NAME:&t;jfs_symlink(dip, dentry, name)&n; *&n; * FUNCTION:&t;creates a symbolic link to &lt;symlink&gt; by name &lt;name&gt;&n; *&t;&t;        in directory &lt;dip&gt;&n; *&n; * PARAMETER:&t;dip&t;    - parent directory vnode&n; *&t;&t;        dentry &t;- dentry of symbolic link&n; *&t;&t;        name    - the path name of the existing object &n; *&t;&t;&t;              that will be the source of the link&n; *&n; * RETURN:&t;errors from subroutines&n; *&n; * note:&n; * ENAMETOOLONG: pathname resolution of a symbolic link produced&n; * an intermediate result whose length exceeds PATH_MAX [XPG4.2]&n;*/
DECL|function|jfs_symlink
r_int
id|jfs_symlink
c_func
(paren
r_struct
id|inode
op_star
id|dip
comma
r_struct
id|dentry
op_star
id|dentry
comma
r_const
r_char
op_star
id|name
)paren
(brace
r_int
id|rc
suffix:semicolon
id|tid_t
id|tid
suffix:semicolon
id|ino_t
id|ino
op_assign
l_int|0
suffix:semicolon
id|component_t
id|dname
suffix:semicolon
r_int
id|ssize
suffix:semicolon
multiline_comment|/* source pathname size */
id|btstack_t
id|btstack
suffix:semicolon
r_struct
id|inode
op_star
id|ip
op_assign
id|dentry-&gt;d_inode
suffix:semicolon
id|unchar
op_star
id|i_fastsymlink
suffix:semicolon
id|s64
id|xlen
op_assign
l_int|0
suffix:semicolon
r_int
id|bmask
op_assign
l_int|0
comma
id|xsize
suffix:semicolon
id|s64
id|xaddr
suffix:semicolon
id|metapage_t
op_star
id|mp
suffix:semicolon
r_struct
id|super_block
op_star
id|sb
suffix:semicolon
id|tblock_t
op_star
id|tblk
suffix:semicolon
r_struct
id|inode
op_star
id|iplist
(braket
l_int|2
)braket
suffix:semicolon
id|jFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;jfs_symlink: dip:0x%p name:%s&bslash;n&quot;
comma
id|dip
comma
id|name
)paren
)paren
suffix:semicolon
id|IWRITE_LOCK
c_func
(paren
id|dip
)paren
suffix:semicolon
id|ssize
op_assign
id|strlen
c_func
(paren
id|name
)paren
op_plus
l_int|1
suffix:semicolon
id|tid
op_assign
id|txBegin
c_func
(paren
id|dip-&gt;i_sb
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * search parent directory for entry/freespace&n;&t; * (dtSearch() returns parent directory page pinned)&n;&t; */
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|get_UCSname
c_func
(paren
op_amp
id|dname
comma
id|dentry
comma
id|JFS_SBI
c_func
(paren
id|dip-&gt;i_sb
)paren
op_member_access_from_pointer
id|nls_tab
)paren
)paren
)paren
r_goto
id|out1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|dtSearch
c_func
(paren
id|dip
comma
op_amp
id|dname
comma
op_amp
id|ino
comma
op_amp
id|btstack
comma
id|JFS_CREATE
)paren
)paren
)paren
r_goto
id|out2
suffix:semicolon
multiline_comment|/*&n;&t; * allocate on-disk/in-memory inode for symbolic link:&n;&t; * (iAlloc() returns new, locked inode)&n;&t; */
id|ip
op_assign
id|ialloc
c_func
(paren
id|dip
comma
id|S_IFLNK
op_or
l_int|0777
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ip
op_eq
l_int|NULL
)paren
(brace
id|BT_PUTSEARCH
c_func
(paren
op_amp
id|btstack
)paren
suffix:semicolon
id|rc
op_assign
id|ENOSPC
suffix:semicolon
r_goto
id|out2
suffix:semicolon
)brace
id|tblk
op_assign
id|tid_to_tblock
c_func
(paren
id|tid
)paren
suffix:semicolon
id|tblk-&gt;xflag
op_or_assign
id|COMMIT_CREATE
suffix:semicolon
id|tblk-&gt;ip
op_assign
id|ip
suffix:semicolon
multiline_comment|/*&n;&t; * create entry for symbolic link in parent directory&n;&t; */
id|ino
op_assign
id|ip-&gt;i_ino
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|dtInsert
c_func
(paren
id|tid
comma
id|dip
comma
op_amp
id|dname
comma
op_amp
id|ino
comma
op_amp
id|btstack
)paren
)paren
)paren
(brace
id|jERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;jfs_symlink: dtInsert returned %d&bslash;n&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
multiline_comment|/* discard ne inode */
id|ip-&gt;i_nlink
op_assign
l_int|0
suffix:semicolon
id|iput
c_func
(paren
id|ip
)paren
suffix:semicolon
r_goto
id|out2
suffix:semicolon
)brace
multiline_comment|/* fix symlink access permission&n;&t; * (dir_create() ANDs in the u.u_cmask, &n;&t; * but symlinks really need to be 777 access)&n;&t; */
id|ip-&gt;i_mode
op_or_assign
l_int|0777
suffix:semicolon
multiline_comment|/*&n;&t;   *       write symbolic link target path name&n;&t; */
id|xtInitRoot
c_func
(paren
id|tid
comma
id|ip
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * write source path name inline in on-disk inode (fast symbolic link)&n;&t; */
r_if
c_cond
(paren
id|ssize
op_le
id|IDATASIZE
)paren
(brace
id|ip-&gt;i_op
op_assign
op_amp
id|jfs_symlink_inode_operations
suffix:semicolon
id|i_fastsymlink
op_assign
id|JFS_IP
c_func
(paren
id|ip
)paren
op_member_access_from_pointer
id|i_inline
suffix:semicolon
id|memcpy
c_func
(paren
id|i_fastsymlink
comma
id|name
comma
id|ssize
)paren
suffix:semicolon
id|ip-&gt;i_size
op_assign
id|ssize
op_minus
l_int|1
suffix:semicolon
id|jFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;jfs_symlink: fast symlink added  ssize:%d name:%s &bslash;n&quot;
comma
id|ssize
comma
id|name
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * write source path name in a single extent&n;&t; */
r_else
(brace
id|jFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;jfs_symlink: allocate extent ip:0x%p&bslash;n&quot;
comma
id|ip
)paren
)paren
suffix:semicolon
id|ip-&gt;i_op
op_assign
op_amp
id|page_symlink_inode_operations
suffix:semicolon
id|ip-&gt;i_mapping-&gt;a_ops
op_assign
op_amp
id|jfs_aops
suffix:semicolon
multiline_comment|/*&n;&t;&t; * even though the data of symlink object (source &n;&t;&t; * path name) is treated as non-journaled user data,&n;&t;&t; * it is read/written thru buffer cache for performance.&n;&t;&t; */
id|sb
op_assign
id|ip-&gt;i_sb
suffix:semicolon
id|bmask
op_assign
id|JFS_SBI
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|bsize
op_minus
l_int|1
suffix:semicolon
id|xsize
op_assign
(paren
id|ssize
op_plus
id|bmask
)paren
op_amp
op_complement
id|bmask
suffix:semicolon
id|xaddr
op_assign
l_int|0
suffix:semicolon
id|xlen
op_assign
id|xsize
op_rshift
id|JFS_SBI
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|l2bsize
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|xtInsert
c_func
(paren
id|tid
comma
id|ip
comma
l_int|0
comma
l_int|0
comma
id|xlen
comma
op_amp
id|xaddr
comma
l_int|0
)paren
)paren
op_eq
l_int|0
)paren
(brace
id|ip-&gt;i_size
op_assign
id|ssize
op_minus
l_int|1
suffix:semicolon
r_while
c_loop
(paren
id|ssize
)paren
(brace
r_int
id|copy_size
op_assign
id|min
c_func
(paren
id|ssize
comma
id|PSIZE
)paren
suffix:semicolon
id|mp
op_assign
id|get_metapage
c_func
(paren
id|ip
comma
id|xaddr
comma
id|PSIZE
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mp
op_eq
l_int|NULL
)paren
(brace
id|dtDelete
c_func
(paren
id|tid
comma
id|dip
comma
op_amp
id|dname
comma
op_amp
id|ino
comma
id|JFS_REMOVE
)paren
suffix:semicolon
id|ip-&gt;i_nlink
op_assign
l_int|0
suffix:semicolon
id|iput
c_func
(paren
id|ip
)paren
suffix:semicolon
id|rc
op_assign
id|EIO
suffix:semicolon
r_goto
id|out2
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|mp-&gt;data
comma
id|name
comma
id|copy_size
)paren
suffix:semicolon
id|flush_metapage
c_func
(paren
id|mp
)paren
suffix:semicolon
macro_line|#if 0
id|mark_buffer_uptodate
c_func
(paren
id|bp
comma
l_int|1
)paren
suffix:semicolon
id|mark_buffer_dirty
c_func
(paren
id|bp
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_SYNC
c_func
(paren
id|dip
)paren
)paren
(brace
id|ll_rw_block
c_func
(paren
id|WRITE
comma
l_int|1
comma
op_amp
id|bp
)paren
suffix:semicolon
id|wait_on_buffer
c_func
(paren
id|bp
)paren
suffix:semicolon
)brace
id|brelse
c_func
(paren
id|bp
)paren
suffix:semicolon
macro_line|#endif&t;&t;&t;&t;/* 0 */
id|ssize
op_sub_assign
id|copy_size
suffix:semicolon
id|xaddr
op_add_assign
id|JFS_SBI
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|nbperpage
suffix:semicolon
)brace
id|ip-&gt;i_blocks
op_assign
id|LBLK2PBLK
c_func
(paren
id|sb
comma
id|xlen
)paren
suffix:semicolon
)brace
r_else
(brace
id|dtDelete
c_func
(paren
id|tid
comma
id|dip
comma
op_amp
id|dname
comma
op_amp
id|ino
comma
id|JFS_REMOVE
)paren
suffix:semicolon
id|ip-&gt;i_nlink
op_assign
l_int|0
suffix:semicolon
id|iput
c_func
(paren
id|ip
)paren
suffix:semicolon
id|rc
op_assign
id|ENOSPC
suffix:semicolon
r_goto
id|out2
suffix:semicolon
)brace
)brace
id|dip-&gt;i_version
op_assign
op_increment
id|event
suffix:semicolon
id|insert_inode_hash
c_func
(paren
id|ip
)paren
suffix:semicolon
id|mark_inode_dirty
c_func
(paren
id|ip
)paren
suffix:semicolon
id|d_instantiate
c_func
(paren
id|dentry
comma
id|ip
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * commit update of parent directory and link object&n;&t; *&n;&t; * if extent allocation failed (ENOSPC),&n;&t; * the parent inode is committed regardless to avoid&n;&t; * backing out parent directory update (by dtInsert())&n;&t; * and subsequent dtDelete() which is harmless wrt &n;&t; * integrity concern.  &n;&t; * the symlink inode will be freed by iput() at exit&n;&t; * as it has a zero link count (by dtDelete()) and &n;&t; * no permanant resources. &n;&t; */
id|iplist
(braket
l_int|0
)braket
op_assign
id|dip
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
)paren
(brace
id|iplist
(braket
l_int|1
)braket
op_assign
id|ip
suffix:semicolon
id|rc
op_assign
id|txCommit
c_func
(paren
id|tid
comma
l_int|2
comma
op_amp
id|iplist
(braket
l_int|0
)braket
comma
l_int|0
)paren
suffix:semicolon
)brace
r_else
id|rc
op_assign
id|txCommit
c_func
(paren
id|tid
comma
l_int|1
comma
op_amp
id|iplist
(braket
l_int|0
)braket
comma
l_int|0
)paren
suffix:semicolon
id|out2
suffix:colon
id|free_UCSname
c_func
(paren
op_amp
id|dname
)paren
suffix:semicolon
id|out1
suffix:colon
id|IWRITE_UNLOCK
c_func
(paren
id|dip
)paren
suffix:semicolon
id|txEnd
c_func
(paren
id|tid
)paren
suffix:semicolon
id|jFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;jfs_symlink: rc:%d&bslash;n&quot;
comma
op_minus
id|rc
)paren
)paren
suffix:semicolon
r_return
op_minus
id|rc
suffix:semicolon
)brace
multiline_comment|/*&n; * NAME:        jfs_rename&n; *&n; * FUNCTION:    rename a file or directory&n; */
DECL|function|jfs_rename
r_int
id|jfs_rename
c_func
(paren
r_struct
id|inode
op_star
id|old_dir
comma
r_struct
id|dentry
op_star
id|old_dentry
comma
r_struct
id|inode
op_star
id|new_dir
comma
r_struct
id|dentry
op_star
id|new_dentry
)paren
(brace
id|btstack_t
id|btstack
suffix:semicolon
id|ino_t
id|ino
suffix:semicolon
id|component_t
id|new_dname
suffix:semicolon
r_struct
id|inode
op_star
id|new_ip
suffix:semicolon
id|component_t
id|old_dname
suffix:semicolon
r_struct
id|inode
op_star
id|old_ip
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|tid_t
id|tid
suffix:semicolon
id|tlock_t
op_star
id|tlck
suffix:semicolon
id|dtlock_t
op_star
id|dtlck
suffix:semicolon
id|lv_t
op_star
id|lv
suffix:semicolon
r_int
id|ipcount
suffix:semicolon
r_struct
id|inode
op_star
id|iplist
(braket
l_int|4
)braket
suffix:semicolon
id|tblock_t
op_star
id|tblk
suffix:semicolon
id|s64
id|new_size
op_assign
l_int|0
suffix:semicolon
r_int
id|commit_flag
suffix:semicolon
id|jFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;jfs_rename: %s %s&bslash;n&quot;
comma
id|old_dentry-&gt;d_name.name
comma
id|new_dentry-&gt;d_name.name
)paren
)paren
suffix:semicolon
id|old_ip
op_assign
id|old_dentry-&gt;d_inode
suffix:semicolon
id|new_ip
op_assign
id|new_dentry-&gt;d_inode
suffix:semicolon
r_if
c_cond
(paren
id|old_dir
op_eq
id|new_dir
)paren
(brace
r_if
c_cond
(paren
id|new_ip
)paren
id|IWRITE_LOCK_LIST
c_func
(paren
l_int|3
comma
id|old_dir
comma
id|old_ip
comma
id|new_ip
)paren
suffix:semicolon
r_else
id|IWRITE_LOCK_LIST
c_func
(paren
l_int|2
comma
id|old_dir
comma
id|old_ip
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|new_ip
)paren
id|IWRITE_LOCK_LIST
c_func
(paren
l_int|4
comma
id|old_dir
comma
id|new_dir
comma
id|old_ip
comma
id|new_ip
)paren
suffix:semicolon
r_else
id|IWRITE_LOCK_LIST
c_func
(paren
l_int|3
comma
id|old_dir
comma
id|new_dir
comma
id|old_ip
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|get_UCSname
c_func
(paren
op_amp
id|old_dname
comma
id|old_dentry
comma
id|JFS_SBI
c_func
(paren
id|old_dir-&gt;i_sb
)paren
op_member_access_from_pointer
id|nls_tab
)paren
)paren
)paren
r_goto
id|out1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|get_UCSname
c_func
(paren
op_amp
id|new_dname
comma
id|new_dentry
comma
id|JFS_SBI
c_func
(paren
id|old_dir-&gt;i_sb
)paren
op_member_access_from_pointer
id|nls_tab
)paren
)paren
)paren
r_goto
id|out2
suffix:semicolon
multiline_comment|/*&n;&t; * Make sure source inode number is what we think it is&n;&t; */
id|rc
op_assign
id|dtSearch
c_func
(paren
id|old_dir
comma
op_amp
id|old_dname
comma
op_amp
id|ino
comma
op_amp
id|btstack
comma
id|JFS_LOOKUP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_logical_or
(paren
id|ino
op_ne
id|old_ip-&gt;i_ino
)paren
)paren
(brace
id|rc
op_assign
id|ENOENT
suffix:semicolon
r_goto
id|out3
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Make sure dest inode number (if any) is what we think it is&n;&t; */
id|rc
op_assign
id|dtSearch
c_func
(paren
id|new_dir
comma
op_amp
id|new_dname
comma
op_amp
id|ino
comma
op_amp
id|btstack
comma
id|JFS_LOOKUP
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
(paren
id|new_ip
op_eq
l_int|0
)paren
op_logical_or
(paren
id|ino
op_ne
id|new_ip-&gt;i_ino
)paren
)paren
(brace
id|rc
op_assign
id|ESTALE
suffix:semicolon
r_goto
id|out3
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|rc
op_ne
id|ENOENT
)paren
r_goto
id|out3
suffix:semicolon
r_else
r_if
c_cond
(paren
id|new_ip
)paren
(brace
multiline_comment|/* no entry exists, but one was expected */
id|rc
op_assign
id|ESTALE
suffix:semicolon
r_goto
id|out3
suffix:semicolon
)brace
r_if
c_cond
(paren
id|S_ISDIR
c_func
(paren
id|old_ip-&gt;i_mode
)paren
)paren
(brace
r_if
c_cond
(paren
id|new_ip
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|dtEmpty
c_func
(paren
id|new_ip
)paren
)paren
(brace
id|rc
op_assign
id|ENOTEMPTY
suffix:semicolon
r_goto
id|out3
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
(paren
id|new_dir
op_ne
id|old_dir
)paren
op_logical_and
(paren
id|new_dir-&gt;i_nlink
op_eq
id|JFS_LINK_MAX
)paren
)paren
(brace
id|rc
op_assign
id|EMLINK
suffix:semicolon
r_goto
id|out3
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t; * The real work starts here&n;&t; */
id|tid
op_assign
id|txBegin
c_func
(paren
id|new_dir-&gt;i_sb
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|new_ip
)paren
(brace
multiline_comment|/*&n;&t;&t; * Change existing directory entry to new inode number&n;&t;&t; */
id|ino
op_assign
id|new_ip-&gt;i_ino
suffix:semicolon
id|rc
op_assign
id|dtModify
c_func
(paren
id|tid
comma
id|new_dir
comma
op_amp
id|new_dname
comma
op_amp
id|ino
comma
id|old_ip-&gt;i_ino
comma
id|JFS_RENAME
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_goto
id|out4
suffix:semicolon
id|new_ip-&gt;i_nlink
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|S_ISDIR
c_func
(paren
id|new_ip-&gt;i_mode
)paren
)paren
(brace
id|new_ip-&gt;i_nlink
op_decrement
suffix:semicolon
m_assert
(paren
id|new_ip-&gt;i_nlink
op_eq
l_int|0
)paren
suffix:semicolon
id|tblk
op_assign
id|tid_to_tblock
c_func
(paren
id|tid
)paren
suffix:semicolon
id|tblk-&gt;xflag
op_or_assign
id|COMMIT_DELETE
suffix:semicolon
id|tblk-&gt;ip
op_assign
id|new_ip
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|new_ip-&gt;i_nlink
op_eq
l_int|0
)paren
(brace
m_assert
(paren
op_logical_neg
id|test_cflag
c_func
(paren
id|COMMIT_Nolink
comma
id|new_ip
)paren
)paren
suffix:semicolon
multiline_comment|/* free block resources */
r_if
c_cond
(paren
(paren
id|new_size
op_assign
id|commitZeroLink
c_func
(paren
id|tid
comma
id|new_ip
)paren
)paren
OL
l_int|0
)paren
(brace
id|txAbort
c_func
(paren
id|tid
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Marks FS Dirty */
id|rc
op_assign
op_minus
id|new_size
suffix:semicolon
multiline_comment|/* We return -rc */
r_goto
id|out4
suffix:semicolon
)brace
id|tblk
op_assign
id|tid_to_tblock
c_func
(paren
id|tid
)paren
suffix:semicolon
id|tblk-&gt;xflag
op_or_assign
id|COMMIT_DELETE
suffix:semicolon
id|tblk-&gt;ip
op_assign
id|new_ip
suffix:semicolon
)brace
r_else
(brace
id|new_ip-&gt;i_ctime
op_assign
id|CURRENT_TIME
suffix:semicolon
id|mark_inode_dirty
c_func
(paren
id|new_ip
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t; * Add new directory entry&n;&t;&t; */
id|rc
op_assign
id|dtSearch
c_func
(paren
id|new_dir
comma
op_amp
id|new_dname
comma
op_amp
id|ino
comma
op_amp
id|btstack
comma
id|JFS_CREATE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|jERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;jfs_rename didn&squot;t expect dtSearch to fail w/rc = %d&bslash;n&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
r_goto
id|out4
suffix:semicolon
)brace
id|ino
op_assign
id|old_ip-&gt;i_ino
suffix:semicolon
id|rc
op_assign
id|dtInsert
c_func
(paren
id|tid
comma
id|new_dir
comma
op_amp
id|new_dname
comma
op_amp
id|ino
comma
op_amp
id|btstack
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|jERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;jfs_rename: dtInsert failed w/rc = %d&bslash;n&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
r_goto
id|out4
suffix:semicolon
)brace
r_if
c_cond
(paren
id|S_ISDIR
c_func
(paren
id|old_ip-&gt;i_mode
)paren
)paren
id|new_dir-&gt;i_nlink
op_increment
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Remove old directory entry&n;&t; */
id|ino
op_assign
id|old_ip-&gt;i_ino
suffix:semicolon
id|rc
op_assign
id|dtDelete
c_func
(paren
id|tid
comma
id|old_dir
comma
op_amp
id|old_dname
comma
op_amp
id|ino
comma
id|JFS_REMOVE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|jERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;jfs_rename did not expect dtDelete to return rc = %d&bslash;n&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
id|txAbort
c_func
(paren
id|tid
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Marks Filesystem dirty */
r_goto
id|out4
suffix:semicolon
)brace
r_if
c_cond
(paren
id|S_ISDIR
c_func
(paren
id|old_ip-&gt;i_mode
)paren
)paren
(brace
id|old_dir-&gt;i_nlink
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|old_dir
op_ne
id|new_dir
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * Change inode number of parent for moved directory&n;&t;&t;&t; */
id|JFS_IP
c_func
(paren
id|old_ip
)paren
op_member_access_from_pointer
id|i_dtroot.header.idotdot
op_assign
id|cpu_to_le32
c_func
(paren
id|new_dir-&gt;i_ino
)paren
suffix:semicolon
multiline_comment|/* Linelock header of dtree */
id|tlck
op_assign
id|txLock
c_func
(paren
id|tid
comma
id|old_ip
comma
(paren
id|metapage_t
op_star
)paren
op_amp
id|JFS_IP
c_func
(paren
id|old_ip
)paren
op_member_access_from_pointer
id|bxflag
comma
id|tlckDTREE
op_or
id|tlckBTROOT
)paren
suffix:semicolon
id|dtlck
op_assign
(paren
id|dtlock_t
op_star
)paren
op_amp
id|tlck-&gt;lock
suffix:semicolon
id|ASSERT
c_func
(paren
id|dtlck-&gt;index
op_eq
l_int|0
)paren
suffix:semicolon
id|lv
op_assign
(paren
id|lv_t
op_star
)paren
op_amp
id|dtlck-&gt;lv
(braket
l_int|0
)braket
suffix:semicolon
id|lv-&gt;offset
op_assign
l_int|0
suffix:semicolon
id|lv-&gt;length
op_assign
l_int|1
suffix:semicolon
id|dtlck-&gt;index
op_increment
suffix:semicolon
)brace
)brace
multiline_comment|/*&n;&t; * Update ctime on changed/moved inodes &amp; mark dirty&n;&t; */
id|old_ip-&gt;i_ctime
op_assign
id|CURRENT_TIME
suffix:semicolon
id|mark_inode_dirty
c_func
(paren
id|old_ip
)paren
suffix:semicolon
id|new_dir-&gt;i_version
op_assign
op_increment
id|event
suffix:semicolon
id|new_dir-&gt;i_ctime
op_assign
id|CURRENT_TIME
suffix:semicolon
id|mark_inode_dirty
c_func
(paren
id|new_dir
)paren
suffix:semicolon
multiline_comment|/* Build list of inodes modified by this transaction */
id|ipcount
op_assign
l_int|0
suffix:semicolon
id|iplist
(braket
id|ipcount
op_increment
)braket
op_assign
id|old_ip
suffix:semicolon
r_if
c_cond
(paren
id|new_ip
)paren
id|iplist
(braket
id|ipcount
op_increment
)braket
op_assign
id|new_ip
suffix:semicolon
id|iplist
(braket
id|ipcount
op_increment
)braket
op_assign
id|old_dir
suffix:semicolon
r_if
c_cond
(paren
id|old_dir
op_ne
id|new_dir
)paren
(brace
id|iplist
(braket
id|ipcount
op_increment
)braket
op_assign
id|new_dir
suffix:semicolon
id|old_dir-&gt;i_version
op_assign
op_increment
id|event
suffix:semicolon
id|old_dir-&gt;i_ctime
op_assign
id|CURRENT_TIME
suffix:semicolon
id|mark_inode_dirty
c_func
(paren
id|old_dir
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Incomplete truncate of file data can&n;&t; * result in timing problems unless we synchronously commit the&n;&t; * transaction.&n;&t; */
r_if
c_cond
(paren
id|new_size
)paren
id|commit_flag
op_assign
id|COMMIT_SYNC
suffix:semicolon
r_else
id|commit_flag
op_assign
l_int|0
suffix:semicolon
id|rc
op_assign
id|txCommit
c_func
(paren
id|tid
comma
id|ipcount
comma
id|iplist
comma
id|commit_flag
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Don&squot;t unlock new_ip if COMMIT_HOLDLOCK is set&n;&t; */
r_if
c_cond
(paren
id|new_ip
op_logical_and
id|test_cflag
c_func
(paren
id|COMMIT_Holdlock
comma
id|new_ip
)paren
)paren
id|new_ip
op_assign
l_int|0
suffix:semicolon
id|out4
suffix:colon
id|txEnd
c_func
(paren
id|tid
)paren
suffix:semicolon
r_while
c_loop
(paren
id|new_size
op_logical_and
(paren
id|rc
op_eq
l_int|0
)paren
)paren
(brace
id|tid
op_assign
id|txBegin
c_func
(paren
id|new_ip-&gt;i_sb
comma
l_int|0
)paren
suffix:semicolon
id|new_size
op_assign
id|xtTruncate_pmap
c_func
(paren
id|tid
comma
id|new_ip
comma
id|new_size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|new_size
OL
l_int|0
)paren
(brace
id|txAbort
c_func
(paren
id|tid
comma
l_int|1
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|new_size
suffix:semicolon
multiline_comment|/* We return -rc */
)brace
r_else
id|rc
op_assign
id|txCommit
c_func
(paren
id|tid
comma
l_int|1
comma
op_amp
id|new_ip
comma
id|COMMIT_SYNC
)paren
suffix:semicolon
id|txEnd
c_func
(paren
id|tid
)paren
suffix:semicolon
)brace
id|out3
suffix:colon
id|free_UCSname
c_func
(paren
op_amp
id|new_dname
)paren
suffix:semicolon
id|out2
suffix:colon
id|free_UCSname
c_func
(paren
op_amp
id|old_dname
)paren
suffix:semicolon
id|out1
suffix:colon
id|IWRITE_UNLOCK
c_func
(paren
id|old_ip
)paren
suffix:semicolon
r_if
c_cond
(paren
id|old_dir
op_ne
id|new_dir
)paren
id|IWRITE_UNLOCK
c_func
(paren
id|new_dir
)paren
suffix:semicolon
r_if
c_cond
(paren
id|new_ip
)paren
id|IWRITE_UNLOCK
c_func
(paren
id|new_ip
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Truncating the directory index table is not guaranteed.  It&n;&t; * may need to be done iteratively&n;&t; */
r_if
c_cond
(paren
id|test_cflag
c_func
(paren
id|COMMIT_Stale
comma
id|old_dir
)paren
)paren
(brace
r_if
c_cond
(paren
id|old_dir-&gt;i_size
OG
l_int|1
)paren
id|jfs_truncate_nolock
c_func
(paren
id|old_dir
comma
l_int|0
)paren
suffix:semicolon
id|clear_cflag
c_func
(paren
id|COMMIT_Stale
comma
id|old_dir
)paren
suffix:semicolon
)brace
id|IWRITE_UNLOCK
c_func
(paren
id|old_dir
)paren
suffix:semicolon
id|jFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;jfs_rename: returning %d&bslash;n&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
r_return
op_minus
id|rc
suffix:semicolon
)brace
multiline_comment|/*&n; * NAME:        jfs_mknod&n; *&n; * FUNCTION:    Create a special file (device)&n; */
DECL|function|jfs_mknod
r_int
id|jfs_mknod
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|dentry
op_star
id|dentry
comma
r_int
id|mode
comma
r_int
id|rdev
)paren
(brace
id|btstack_t
id|btstack
suffix:semicolon
id|component_t
id|dname
suffix:semicolon
id|ino_t
id|ino
suffix:semicolon
r_struct
id|inode
op_star
id|ip
suffix:semicolon
r_struct
id|inode
op_star
id|iplist
(braket
l_int|2
)braket
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|tid_t
id|tid
suffix:semicolon
id|tblock_t
op_star
id|tblk
suffix:semicolon
id|jFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;jfs_mknod: %s&bslash;n&quot;
comma
id|dentry-&gt;d_name.name
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|get_UCSname
c_func
(paren
op_amp
id|dname
comma
id|dentry
comma
id|JFS_SBI
c_func
(paren
id|dir-&gt;i_sb
)paren
op_member_access_from_pointer
id|nls_tab
)paren
)paren
)paren
r_goto
id|out
suffix:semicolon
id|IWRITE_LOCK
c_func
(paren
id|dir
)paren
suffix:semicolon
id|ip
op_assign
id|ialloc
c_func
(paren
id|dir
comma
id|mode
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ip
op_eq
l_int|NULL
)paren
(brace
id|rc
op_assign
id|ENOSPC
suffix:semicolon
r_goto
id|out1
suffix:semicolon
)brace
id|tid
op_assign
id|txBegin
c_func
(paren
id|dir-&gt;i_sb
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|dtSearch
c_func
(paren
id|dir
comma
op_amp
id|dname
comma
op_amp
id|ino
comma
op_amp
id|btstack
comma
id|JFS_CREATE
)paren
)paren
)paren
(brace
id|ip-&gt;i_nlink
op_assign
l_int|0
suffix:semicolon
id|iput
c_func
(paren
id|ip
)paren
suffix:semicolon
id|txEnd
c_func
(paren
id|tid
)paren
suffix:semicolon
r_goto
id|out1
suffix:semicolon
)brace
id|tblk
op_assign
id|tid_to_tblock
c_func
(paren
id|tid
)paren
suffix:semicolon
id|tblk-&gt;xflag
op_or_assign
id|COMMIT_CREATE
suffix:semicolon
id|tblk-&gt;ip
op_assign
id|ip
suffix:semicolon
id|ino
op_assign
id|ip-&gt;i_ino
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|dtInsert
c_func
(paren
id|tid
comma
id|dir
comma
op_amp
id|dname
comma
op_amp
id|ino
comma
op_amp
id|btstack
)paren
)paren
)paren
(brace
id|ip-&gt;i_nlink
op_assign
l_int|0
suffix:semicolon
id|iput
c_func
(paren
id|ip
)paren
suffix:semicolon
id|txEnd
c_func
(paren
id|tid
)paren
suffix:semicolon
r_goto
id|out1
suffix:semicolon
)brace
id|init_special_inode
c_func
(paren
id|ip
comma
id|ip-&gt;i_mode
comma
id|rdev
)paren
suffix:semicolon
id|insert_inode_hash
c_func
(paren
id|ip
)paren
suffix:semicolon
id|mark_inode_dirty
c_func
(paren
id|ip
)paren
suffix:semicolon
id|d_instantiate
c_func
(paren
id|dentry
comma
id|ip
)paren
suffix:semicolon
id|dir-&gt;i_version
op_assign
op_increment
id|event
suffix:semicolon
id|dir-&gt;i_ctime
op_assign
id|dir-&gt;i_mtime
op_assign
id|CURRENT_TIME
suffix:semicolon
id|mark_inode_dirty
c_func
(paren
id|dir
)paren
suffix:semicolon
id|iplist
(braket
l_int|0
)braket
op_assign
id|dir
suffix:semicolon
id|iplist
(braket
l_int|1
)braket
op_assign
id|ip
suffix:semicolon
id|rc
op_assign
id|txCommit
c_func
(paren
id|tid
comma
l_int|2
comma
id|iplist
comma
l_int|0
)paren
suffix:semicolon
id|txEnd
c_func
(paren
id|tid
)paren
suffix:semicolon
id|out1
suffix:colon
id|IWRITE_UNLOCK
c_func
(paren
id|dir
)paren
suffix:semicolon
id|free_UCSname
c_func
(paren
op_amp
id|dname
)paren
suffix:semicolon
id|out
suffix:colon
id|jFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;jfs_mknod: returning %d&bslash;n&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
r_return
op_minus
id|rc
suffix:semicolon
)brace
DECL|function|jfs_lookup
r_static
r_struct
id|dentry
op_star
id|jfs_lookup
c_func
(paren
r_struct
id|inode
op_star
id|dip
comma
r_struct
id|dentry
op_star
id|dentry
)paren
(brace
id|btstack_t
id|btstack
suffix:semicolon
id|ino_t
id|inum
suffix:semicolon
r_struct
id|inode
op_star
id|ip
suffix:semicolon
id|component_t
id|key
suffix:semicolon
r_const
r_char
op_star
id|name
op_assign
id|dentry-&gt;d_name.name
suffix:semicolon
r_int
id|len
op_assign
id|dentry-&gt;d_name.len
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|jFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;jfs_lookup: name = %s&bslash;n&quot;
comma
id|name
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|name
(braket
l_int|0
)braket
op_eq
l_char|&squot;.&squot;
)paren
op_logical_and
(paren
id|len
op_eq
l_int|1
)paren
)paren
id|inum
op_assign
id|dip-&gt;i_ino
suffix:semicolon
r_else
r_if
c_cond
(paren
id|strcmp
c_func
(paren
id|name
comma
l_string|&quot;..&quot;
)paren
op_eq
l_int|0
)paren
id|inum
op_assign
id|PARENT
c_func
(paren
id|dip
)paren
suffix:semicolon
r_else
(brace
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|get_UCSname
c_func
(paren
op_amp
id|key
comma
id|dentry
comma
id|JFS_SBI
c_func
(paren
id|dip-&gt;i_sb
)paren
op_member_access_from_pointer
id|nls_tab
)paren
)paren
)paren
r_return
id|ERR_PTR
c_func
(paren
op_minus
id|rc
)paren
suffix:semicolon
id|IREAD_LOCK
c_func
(paren
id|dip
)paren
suffix:semicolon
id|rc
op_assign
id|dtSearch
c_func
(paren
id|dip
comma
op_amp
id|key
comma
op_amp
id|inum
comma
op_amp
id|btstack
comma
id|JFS_LOOKUP
)paren
suffix:semicolon
id|IREAD_UNLOCK
c_func
(paren
id|dip
)paren
suffix:semicolon
id|free_UCSname
c_func
(paren
op_amp
id|key
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
id|ENOENT
)paren
(brace
id|d_add
c_func
(paren
id|dentry
comma
l_int|NULL
)paren
suffix:semicolon
r_return
id|ERR_PTR
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|rc
)paren
(brace
id|jERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;jfs_lookup: dtSearch returned %d&bslash;n&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
r_return
id|ERR_PTR
c_func
(paren
op_minus
id|rc
)paren
suffix:semicolon
)brace
)brace
id|ip
op_assign
id|iget
c_func
(paren
id|dip-&gt;i_sb
comma
id|inum
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ip
op_eq
l_int|NULL
)paren
(brace
id|jERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;jfs_lookup: iget failed on inum %d&bslash;n&quot;
comma
(paren
id|uint
)paren
id|inum
)paren
)paren
suffix:semicolon
r_return
id|ERR_PTR
c_func
(paren
op_minus
id|EACCES
)paren
suffix:semicolon
)brace
id|d_add
c_func
(paren
id|dentry
comma
id|ip
)paren
suffix:semicolon
r_return
id|ERR_PTR
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
DECL|variable|jfs_dir_inode_operations
r_struct
id|inode_operations
id|jfs_dir_inode_operations
op_assign
(brace
id|create
suffix:colon
id|jfs_create
comma
id|lookup
suffix:colon
id|jfs_lookup
comma
id|link
suffix:colon
id|jfs_link
comma
id|unlink
suffix:colon
id|jfs_unlink
comma
id|symlink
suffix:colon
id|jfs_symlink
comma
id|mkdir
suffix:colon
id|jfs_mkdir
comma
id|rmdir
suffix:colon
id|jfs_rmdir
comma
id|mknod
suffix:colon
id|jfs_mknod
comma
id|rename
suffix:colon
id|jfs_rename
comma
)brace
suffix:semicolon
DECL|variable|jfs_dir_operations
r_struct
id|file_operations
id|jfs_dir_operations
op_assign
(brace
id|read
suffix:colon
id|generic_read_dir
comma
id|readdir
suffix:colon
id|jfs_readdir
comma
id|fsync
suffix:colon
id|jfs_fsync
comma
)brace
suffix:semicolon
eof
