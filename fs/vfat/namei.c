multiline_comment|/*&n; *  linux/fs/vfat/namei.c&n; *&n; *  Written 1992,1993 by Werner Almesberger&n; *&n; *  Windows95/Windows NT compatible extended MSDOS filesystem&n; *    by Gordon Chaffee Copyright (C) 1995.  Send bug reports for the&n; *    VFAT filesystem to &lt;chaffee@cs.berkeley.edu&gt;.  Specify&n; *    what file operation caused you trouble and if you can duplicate&n; *    the problem, send a script that demonstrates it.&n; *&n; *  Short name translation 1999, 2001 by Wolfram Pienkoss &lt;wp@bszh.de&gt;&n; *&n; *  Support Multibyte character and cleanup by&n; *  &t;&t;&t;&t;OGAWA Hirofumi &lt;hirofumi@mail.parknet.co.jp&gt;&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/msdos_fs.h&gt;
macro_line|#include &lt;linux/ctype.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
DECL|macro|DEBUG_LEVEL
mdefine_line|#define DEBUG_LEVEL 0
macro_line|#if (DEBUG_LEVEL &gt;= 1)
DECL|macro|PRINTK1
macro_line|#  define PRINTK1(x) printk x
macro_line|#else
DECL|macro|PRINTK1
macro_line|#  define PRINTK1(x)
macro_line|#endif
macro_line|#if (DEBUG_LEVEL &gt;= 2)
DECL|macro|PRINTK2
macro_line|#  define PRINTK2(x) printk x
macro_line|#else
DECL|macro|PRINTK2
macro_line|#  define PRINTK2(x)
macro_line|#endif
macro_line|#if (DEBUG_LEVEL &gt;= 3)
DECL|macro|PRINTK3
macro_line|#  define PRINTK3(x) printk x
macro_line|#else
DECL|macro|PRINTK3
macro_line|#  define PRINTK3(x)
macro_line|#endif
r_static
r_int
id|vfat_hashi
c_func
(paren
r_struct
id|dentry
op_star
id|parent
comma
r_struct
id|qstr
op_star
id|qstr
)paren
suffix:semicolon
r_static
r_int
id|vfat_hash
c_func
(paren
r_struct
id|dentry
op_star
id|parent
comma
r_struct
id|qstr
op_star
id|qstr
)paren
suffix:semicolon
r_static
r_int
id|vfat_cmpi
c_func
(paren
r_struct
id|dentry
op_star
id|dentry
comma
r_struct
id|qstr
op_star
id|a
comma
r_struct
id|qstr
op_star
id|b
)paren
suffix:semicolon
r_static
r_int
id|vfat_cmp
c_func
(paren
r_struct
id|dentry
op_star
id|dentry
comma
r_struct
id|qstr
op_star
id|a
comma
r_struct
id|qstr
op_star
id|b
)paren
suffix:semicolon
r_static
r_int
id|vfat_revalidate
c_func
(paren
r_struct
id|dentry
op_star
id|dentry
comma
r_int
)paren
suffix:semicolon
DECL|variable|vfat_dentry_ops
r_static
r_struct
id|dentry_operations
id|vfat_dentry_ops
(braket
l_int|4
)braket
op_assign
(brace
(brace
id|d_hash
suffix:colon
id|vfat_hashi
comma
id|d_compare
suffix:colon
id|vfat_cmpi
comma
)brace
comma
(brace
id|d_revalidate
suffix:colon
id|vfat_revalidate
comma
id|d_hash
suffix:colon
id|vfat_hashi
comma
id|d_compare
suffix:colon
id|vfat_cmpi
comma
)brace
comma
(brace
id|d_hash
suffix:colon
id|vfat_hash
comma
id|d_compare
suffix:colon
id|vfat_cmp
comma
)brace
comma
(brace
id|d_revalidate
suffix:colon
id|vfat_revalidate
comma
id|d_hash
suffix:colon
id|vfat_hash
comma
id|d_compare
suffix:colon
id|vfat_cmp
comma
)brace
)brace
suffix:semicolon
DECL|function|vfat_revalidate
r_static
r_int
id|vfat_revalidate
c_func
(paren
r_struct
id|dentry
op_star
id|dentry
comma
r_int
id|flags
)paren
(brace
id|PRINTK1
c_func
(paren
(paren
l_string|&quot;vfat_revalidate: %s&bslash;n&quot;
comma
id|dentry-&gt;d_name.name
)paren
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|dcache_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dentry-&gt;d_time
op_eq
id|dentry-&gt;d_parent-&gt;d_inode-&gt;i_version
)paren
(brace
id|spin_unlock
c_func
(paren
op_amp
id|dcache_lock
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|dcache_lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|simple_getbool
r_static
r_int
id|simple_getbool
c_func
(paren
r_char
op_star
id|s
comma
r_int
op_star
id|setval
)paren
(brace
r_if
c_cond
(paren
id|s
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|s
comma
l_string|&quot;1&quot;
)paren
op_logical_or
op_logical_neg
id|strcmp
c_func
(paren
id|s
comma
l_string|&quot;yes&quot;
)paren
op_logical_or
op_logical_neg
id|strcmp
c_func
(paren
id|s
comma
l_string|&quot;true&quot;
)paren
)paren
(brace
op_star
id|setval
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|s
comma
l_string|&quot;0&quot;
)paren
op_logical_or
op_logical_neg
id|strcmp
c_func
(paren
id|s
comma
l_string|&quot;no&quot;
)paren
op_logical_or
op_logical_neg
id|strcmp
c_func
(paren
id|s
comma
l_string|&quot;false&quot;
)paren
)paren
(brace
op_star
id|setval
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_else
(brace
op_star
id|setval
op_assign
l_int|1
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|parse_options
r_static
r_int
id|parse_options
c_func
(paren
r_char
op_star
id|options
comma
r_struct
id|fat_mount_options
op_star
id|opts
)paren
(brace
r_char
op_star
id|this_char
comma
op_star
id|value
comma
id|save
comma
op_star
id|savep
suffix:semicolon
r_int
id|ret
comma
id|val
suffix:semicolon
id|opts-&gt;unicode_xlate
op_assign
id|opts-&gt;posixfs
op_assign
l_int|0
suffix:semicolon
id|opts-&gt;numtail
op_assign
l_int|1
suffix:semicolon
id|opts-&gt;utf8
op_assign
l_int|0
suffix:semicolon
id|opts-&gt;shortname
op_assign
id|VFAT_SFN_DISPLAY_LOWER
op_or
id|VFAT_SFN_CREATE_WIN95
suffix:semicolon
multiline_comment|/* for backward compatible */
r_if
c_cond
(paren
id|opts-&gt;nocase
)paren
(brace
id|opts-&gt;nocase
op_assign
l_int|0
suffix:semicolon
id|opts-&gt;shortname
op_assign
id|VFAT_SFN_DISPLAY_WIN95
op_or
id|VFAT_SFN_CREATE_WIN95
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|options
)paren
r_return
l_int|1
suffix:semicolon
id|save
op_assign
l_int|0
suffix:semicolon
id|savep
op_assign
l_int|NULL
suffix:semicolon
id|ret
op_assign
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|this_char
op_assign
id|strtok
c_func
(paren
id|options
comma
l_string|&quot;,&quot;
)paren
suffix:semicolon
id|this_char
suffix:semicolon
id|this_char
op_assign
id|strtok
c_func
(paren
l_int|NULL
comma
l_string|&quot;,&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|value
op_assign
id|strchr
c_func
(paren
id|this_char
comma
l_char|&squot;=&squot;
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|save
op_assign
op_star
id|value
suffix:semicolon
id|savep
op_assign
id|value
suffix:semicolon
op_star
id|value
op_increment
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|this_char
comma
l_string|&quot;utf8&quot;
)paren
)paren
(brace
id|ret
op_assign
id|simple_getbool
c_func
(paren
id|value
comma
op_amp
id|val
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
id|opts-&gt;utf8
op_assign
id|val
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|this_char
comma
l_string|&quot;uni_xlate&quot;
)paren
)paren
(brace
id|ret
op_assign
id|simple_getbool
c_func
(paren
id|value
comma
op_amp
id|val
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
id|opts-&gt;unicode_xlate
op_assign
id|val
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|this_char
comma
l_string|&quot;posix&quot;
)paren
)paren
(brace
id|ret
op_assign
id|simple_getbool
c_func
(paren
id|value
comma
op_amp
id|val
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
id|opts-&gt;posixfs
op_assign
id|val
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|this_char
comma
l_string|&quot;nonumtail&quot;
)paren
)paren
(brace
id|ret
op_assign
id|simple_getbool
c_func
(paren
id|value
comma
op_amp
id|val
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|opts-&gt;numtail
op_assign
op_logical_neg
id|val
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|this_char
comma
l_string|&quot;shortname&quot;
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|value
comma
l_string|&quot;lower&quot;
)paren
)paren
id|opts-&gt;shortname
op_assign
id|VFAT_SFN_DISPLAY_LOWER
op_or
id|VFAT_SFN_CREATE_WIN95
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|value
comma
l_string|&quot;win95&quot;
)paren
)paren
id|opts-&gt;shortname
op_assign
id|VFAT_SFN_DISPLAY_WIN95
op_or
id|VFAT_SFN_CREATE_WIN95
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|value
comma
l_string|&quot;winnt&quot;
)paren
)paren
id|opts-&gt;shortname
op_assign
id|VFAT_SFN_DISPLAY_WINNT
op_or
id|VFAT_SFN_CREATE_WINNT
suffix:semicolon
r_else
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|value
comma
l_string|&quot;mixed&quot;
)paren
)paren
id|opts-&gt;shortname
op_assign
id|VFAT_SFN_DISPLAY_WINNT
op_or
id|VFAT_SFN_CREATE_WIN95
suffix:semicolon
r_else
id|ret
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|this_char
op_ne
id|options
)paren
op_star
(paren
id|this_char
op_minus
l_int|1
)paren
op_assign
l_char|&squot;,&squot;
suffix:semicolon
r_if
c_cond
(paren
id|value
)paren
(brace
op_star
id|savep
op_assign
id|save
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ret
op_eq
l_int|0
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|opts-&gt;unicode_xlate
)paren
(brace
id|opts-&gt;utf8
op_assign
l_int|0
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
r_static
r_inline
r_int
r_char
DECL|function|vfat_tolower
id|vfat_tolower
c_func
(paren
r_struct
id|nls_table
op_star
id|t
comma
r_int
r_char
id|c
)paren
(brace
r_int
r_char
id|nc
op_assign
id|t-&gt;charset2lower
(braket
id|c
)braket
suffix:semicolon
r_return
id|nc
ques
c_cond
id|nc
suffix:colon
id|c
suffix:semicolon
)brace
r_static
r_inline
r_int
r_char
DECL|function|vfat_toupper
id|vfat_toupper
c_func
(paren
r_struct
id|nls_table
op_star
id|t
comma
r_int
r_char
id|c
)paren
(brace
r_int
r_char
id|nc
op_assign
id|t-&gt;charset2upper
(braket
id|c
)braket
suffix:semicolon
r_return
id|nc
ques
c_cond
id|nc
suffix:colon
id|c
suffix:semicolon
)brace
r_static
r_int
DECL|function|vfat_strnicmp
id|vfat_strnicmp
c_func
(paren
r_struct
id|nls_table
op_star
id|t
comma
r_const
r_int
r_char
op_star
id|s1
comma
r_const
r_int
r_char
op_star
id|s2
comma
r_int
id|len
)paren
(brace
r_while
c_loop
(paren
id|len
op_decrement
)paren
r_if
c_cond
(paren
id|vfat_tolower
c_func
(paren
id|t
comma
op_star
id|s1
op_increment
)paren
op_ne
id|vfat_tolower
c_func
(paren
id|t
comma
op_star
id|s2
op_increment
)paren
)paren
r_return
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Compute the hash for the vfat name corresponding to the dentry.&n; * Note: if the name is invalid, we leave the hash code unchanged so&n; * that the existing dentry can be used. The vfat fs routines will&n; * return ENOENT or EINVAL as appropriate.&n; */
DECL|function|vfat_hash
r_static
r_int
id|vfat_hash
c_func
(paren
r_struct
id|dentry
op_star
id|dentry
comma
r_struct
id|qstr
op_star
id|qstr
)paren
(brace
r_const
r_char
op_star
id|name
suffix:semicolon
r_int
id|len
suffix:semicolon
id|len
op_assign
id|qstr-&gt;len
suffix:semicolon
id|name
op_assign
id|qstr-&gt;name
suffix:semicolon
r_while
c_loop
(paren
id|len
op_logical_and
id|name
(braket
id|len
op_minus
l_int|1
)braket
op_eq
l_char|&squot;.&squot;
)paren
id|len
op_decrement
suffix:semicolon
id|qstr-&gt;hash
op_assign
id|full_name_hash
c_func
(paren
id|name
comma
id|len
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Compute the hash for the vfat name corresponding to the dentry.&n; * Note: if the name is invalid, we leave the hash code unchanged so&n; * that the existing dentry can be used. The vfat fs routines will&n; * return ENOENT or EINVAL as appropriate.&n; */
DECL|function|vfat_hashi
r_static
r_int
id|vfat_hashi
c_func
(paren
r_struct
id|dentry
op_star
id|dentry
comma
r_struct
id|qstr
op_star
id|qstr
)paren
(brace
r_struct
id|nls_table
op_star
id|t
op_assign
id|MSDOS_SB
c_func
(paren
id|dentry-&gt;d_inode-&gt;i_sb
)paren
op_member_access_from_pointer
id|nls_io
suffix:semicolon
r_const
r_char
op_star
id|name
suffix:semicolon
r_int
id|len
suffix:semicolon
r_int
r_int
id|hash
suffix:semicolon
id|len
op_assign
id|qstr-&gt;len
suffix:semicolon
id|name
op_assign
id|qstr-&gt;name
suffix:semicolon
r_while
c_loop
(paren
id|len
op_logical_and
id|name
(braket
id|len
op_minus
l_int|1
)braket
op_eq
l_char|&squot;.&squot;
)paren
id|len
op_decrement
suffix:semicolon
id|hash
op_assign
id|init_name_hash
c_func
(paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|len
op_decrement
)paren
id|hash
op_assign
id|partial_name_hash
c_func
(paren
id|vfat_tolower
c_func
(paren
id|t
comma
op_star
id|name
op_increment
)paren
comma
id|hash
)paren
suffix:semicolon
id|qstr-&gt;hash
op_assign
id|end_name_hash
c_func
(paren
id|hash
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Case insensitive compare of two vfat names.&n; */
DECL|function|vfat_cmpi
r_static
r_int
id|vfat_cmpi
c_func
(paren
r_struct
id|dentry
op_star
id|dentry
comma
r_struct
id|qstr
op_star
id|a
comma
r_struct
id|qstr
op_star
id|b
)paren
(brace
r_struct
id|nls_table
op_star
id|t
op_assign
id|MSDOS_SB
c_func
(paren
id|dentry-&gt;d_inode-&gt;i_sb
)paren
op_member_access_from_pointer
id|nls_io
suffix:semicolon
r_int
id|alen
comma
id|blen
suffix:semicolon
multiline_comment|/* A filename cannot end in &squot;.&squot; or we treat it like it has none */
id|alen
op_assign
id|a-&gt;len
suffix:semicolon
id|blen
op_assign
id|b-&gt;len
suffix:semicolon
r_while
c_loop
(paren
id|alen
op_logical_and
id|a-&gt;name
(braket
id|alen
op_minus
l_int|1
)braket
op_eq
l_char|&squot;.&squot;
)paren
id|alen
op_decrement
suffix:semicolon
r_while
c_loop
(paren
id|blen
op_logical_and
id|b-&gt;name
(braket
id|blen
op_minus
l_int|1
)braket
op_eq
l_char|&squot;.&squot;
)paren
id|blen
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|alen
op_eq
id|blen
)paren
(brace
r_if
c_cond
(paren
id|vfat_strnicmp
c_func
(paren
id|t
comma
id|a-&gt;name
comma
id|b-&gt;name
comma
id|alen
)paren
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/*&n; * Case sensitive compare of two vfat names.&n; */
DECL|function|vfat_cmp
r_static
r_int
id|vfat_cmp
c_func
(paren
r_struct
id|dentry
op_star
id|dentry
comma
r_struct
id|qstr
op_star
id|a
comma
r_struct
id|qstr
op_star
id|b
)paren
(brace
r_int
id|alen
comma
id|blen
suffix:semicolon
multiline_comment|/* A filename cannot end in &squot;.&squot; or we treat it like it has none */
id|alen
op_assign
id|a-&gt;len
suffix:semicolon
id|blen
op_assign
id|b-&gt;len
suffix:semicolon
r_while
c_loop
(paren
id|alen
op_logical_and
id|a-&gt;name
(braket
id|alen
op_minus
l_int|1
)braket
op_eq
l_char|&squot;.&squot;
)paren
id|alen
op_decrement
suffix:semicolon
r_while
c_loop
(paren
id|blen
op_logical_and
id|b-&gt;name
(braket
id|blen
op_minus
l_int|1
)braket
op_eq
l_char|&squot;.&squot;
)paren
id|blen
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|alen
op_eq
id|blen
)paren
(brace
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|a-&gt;name
comma
id|b-&gt;name
comma
id|alen
)paren
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
)brace
r_return
l_int|1
suffix:semicolon
)brace
macro_line|#ifdef DEBUG
DECL|function|dump_fat
r_static
r_void
id|dump_fat
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_int
id|start
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;[&quot;
)paren
suffix:semicolon
r_while
c_loop
(paren
id|start
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%d &quot;
comma
id|start
)paren
suffix:semicolon
id|start
op_assign
id|fat_access
c_func
(paren
id|sb
comma
id|start
comma
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|start
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;ERROR&quot;
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|start
op_eq
op_minus
l_int|1
)paren
r_break
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;]&bslash;n&quot;
)paren
suffix:semicolon
)brace
DECL|function|dump_de
r_static
r_void
id|dump_de
c_func
(paren
r_struct
id|msdos_dir_entry
op_star
id|de
)paren
(brace
r_int
id|i
suffix:semicolon
r_int
r_char
op_star
id|p
op_assign
(paren
r_int
r_char
op_star
)paren
id|de
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;[&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|32
suffix:semicolon
id|i
op_increment
comma
id|p
op_increment
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;%02x &quot;
comma
op_star
id|p
)paren
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;]&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* MS-DOS &quot;device special files&quot; */
DECL|variable|reserved3_names
r_static
r_const
r_char
op_star
id|reserved3_names
(braket
)braket
op_assign
(brace
l_string|&quot;con     &quot;
comma
l_string|&quot;prn     &quot;
comma
l_string|&quot;nul     &quot;
comma
l_string|&quot;aux     &quot;
comma
l_int|NULL
)brace
suffix:semicolon
DECL|variable|reserved4_names
r_static
r_const
r_char
op_star
id|reserved4_names
(braket
)braket
op_assign
(brace
l_string|&quot;com1    &quot;
comma
l_string|&quot;com2    &quot;
comma
l_string|&quot;com3    &quot;
comma
l_string|&quot;com4    &quot;
comma
l_string|&quot;com5    &quot;
comma
l_string|&quot;com6    &quot;
comma
l_string|&quot;com7    &quot;
comma
l_string|&quot;com8    &quot;
comma
l_string|&quot;com9    &quot;
comma
l_string|&quot;lpt1    &quot;
comma
l_string|&quot;lpt2    &quot;
comma
l_string|&quot;lpt3    &quot;
comma
l_string|&quot;lpt4    &quot;
comma
l_string|&quot;lpt5    &quot;
comma
l_string|&quot;lpt6    &quot;
comma
l_string|&quot;lpt7    &quot;
comma
l_string|&quot;lpt8    &quot;
comma
l_string|&quot;lpt9    &quot;
comma
l_int|NULL
)brace
suffix:semicolon
multiline_comment|/* Characters that are undesirable in an MS-DOS file name */
DECL|variable|bad_chars
r_static
m_wchar_t
id|bad_chars
(braket
)braket
op_assign
(brace
multiline_comment|/*  `*&squot;     `?&squot;     `&lt;&squot;    `&gt;&squot;      `|&squot;     `&quot;&squot;     `:&squot;     `/&squot; */
l_int|0x002A
comma
l_int|0x003F
comma
l_int|0x003C
comma
l_int|0x003E
comma
l_int|0x007C
comma
l_int|0x0022
comma
l_int|0x003A
comma
l_int|0x002F
comma
multiline_comment|/*  `&bslash;&squot; */
l_int|0x005C
comma
l_int|0
comma
)brace
suffix:semicolon
DECL|macro|IS_BADCHAR
mdefine_line|#define IS_BADCHAR(uni)&t;(vfat_unistrchr(bad_chars, (uni)) != NULL)
DECL|variable|replace_chars
r_static
m_wchar_t
id|replace_chars
(braket
)braket
op_assign
(brace
multiline_comment|/*  `[&squot;     `]&squot;    `;&squot;     `,&squot;     `+&squot;      `=&squot; */
l_int|0x005B
comma
l_int|0x005D
comma
l_int|0x003B
comma
l_int|0x002C
comma
l_int|0x002B
comma
l_int|0x003D
comma
l_int|0
comma
)brace
suffix:semicolon
DECL|macro|IS_REPLACECHAR
mdefine_line|#define IS_REPLACECHAR(uni)&t;(vfat_unistrchr(replace_chars, (uni)) != NULL)
DECL|variable|skip_chars
r_static
m_wchar_t
id|skip_chars
(braket
)braket
op_assign
(brace
multiline_comment|/*  `.&squot;     ` &squot; */
l_int|0x002E
comma
l_int|0x0020
comma
l_int|0
comma
)brace
suffix:semicolon
DECL|macro|IS_SKIPCHAR
mdefine_line|#define IS_SKIPCHAR(uni) &bslash;&n;&t;((wchar_t)(uni) == skip_chars[0] || (wchar_t)(uni) == skip_chars[1])
DECL|function|vfat_unistrchr
r_static
r_inline
m_wchar_t
op_star
id|vfat_unistrchr
c_func
(paren
r_const
m_wchar_t
op_star
id|s
comma
r_const
m_wchar_t
id|c
)paren
(brace
r_for
c_loop
(paren
suffix:semicolon
op_star
id|s
op_ne
id|c
suffix:semicolon
op_increment
id|s
)paren
r_if
c_cond
(paren
op_star
id|s
op_eq
l_int|0
)paren
r_return
l_int|NULL
suffix:semicolon
r_return
(paren
m_wchar_t
op_star
)paren
id|s
suffix:semicolon
)brace
DECL|function|vfat_is_used_badchars
r_static
r_inline
r_int
id|vfat_is_used_badchars
c_func
(paren
r_const
m_wchar_t
op_star
id|s
comma
r_int
id|len
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
id|s
(braket
id|i
)braket
OL
l_int|0x0020
op_logical_or
id|IS_BADCHAR
c_func
(paren
id|s
(braket
id|i
)braket
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Checks the validity of a long MS-DOS filename */
multiline_comment|/* Returns negative number on error, 0 for a normal&n; * return, and 1 for . or .. */
DECL|function|vfat_valid_longname
r_static
r_int
id|vfat_valid_longname
c_func
(paren
r_const
r_char
op_star
id|name
comma
r_int
id|len
comma
r_int
id|xlate
)paren
(brace
r_const
r_char
op_star
op_star
id|reserved
comma
op_star
id|walk
suffix:semicolon
r_int
id|baselen
suffix:semicolon
r_if
c_cond
(paren
id|len
op_logical_and
id|name
(braket
id|len
op_minus
l_int|1
)braket
op_eq
l_char|&squot; &squot;
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|len
op_ge
l_int|256
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
l_int|3
)paren
r_return
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|walk
op_assign
id|name
suffix:semicolon
op_star
id|walk
op_ne
l_int|0
op_logical_and
op_star
id|walk
op_ne
l_char|&squot;.&squot;
suffix:semicolon
id|walk
op_increment
)paren
suffix:semicolon
id|baselen
op_assign
id|walk
op_minus
id|name
suffix:semicolon
r_if
c_cond
(paren
id|baselen
op_eq
l_int|3
)paren
(brace
r_for
c_loop
(paren
id|reserved
op_assign
id|reserved3_names
suffix:semicolon
op_star
id|reserved
suffix:semicolon
id|reserved
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|strnicmp
c_func
(paren
id|name
comma
op_star
id|reserved
comma
id|baselen
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|baselen
op_eq
l_int|4
)paren
(brace
r_for
c_loop
(paren
id|reserved
op_assign
id|reserved4_names
suffix:semicolon
op_star
id|reserved
suffix:semicolon
id|reserved
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|strnicmp
c_func
(paren
id|name
comma
op_star
id|reserved
comma
id|baselen
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|vfat_find_form
r_static
r_int
id|vfat_find_form
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_char
op_star
id|name
)paren
(brace
r_struct
id|msdos_dir_entry
op_star
id|de
suffix:semicolon
r_struct
id|buffer_head
op_star
id|bh
op_assign
l_int|NULL
suffix:semicolon
r_int
id|ino
comma
id|res
suffix:semicolon
id|res
op_assign
id|fat_scan
c_func
(paren
id|dir
comma
id|name
comma
op_amp
id|bh
comma
op_amp
id|de
comma
op_amp
id|ino
)paren
suffix:semicolon
id|fat_brelse
c_func
(paren
id|dir-&gt;i_sb
comma
id|bh
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
OL
l_int|0
)paren
r_return
op_minus
id|ENOENT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* &n; * 1) Valid characters for the 8.3 format alias are any combination of&n; * letters, uppercase alphabets, digits, any of the&n; * following special characters:&n; *     $ % &squot; ` - @ { } ~ ! # ( ) &amp; _ ^&n; * In this case Longfilename is not stored in disk.&n; *&n; * WinNT&squot;s Extension:&n; * File name and extension name is contain uppercase/lowercase&n; * only. And it is expressed by CASE_LOWER_BASE and CASE_LOWER_EXT.&n; *     &n; * 2) File name is 8.3 format, but it contain the uppercase and&n; * lowercase char, muliti bytes char, etc. In this case numtail is not&n; * added, but Longfilename is stored.&n; * &n; * 3) When the one except for the above, or the following special&n; * character are contained:&n; *        .   [ ] ; , + =&n; * numtail is added, and Longfilename must be stored in disk .&n; */
DECL|struct|shortname_info
r_struct
id|shortname_info
(brace
DECL|member|lower
r_int
r_char
id|lower
suffix:colon
l_int|1
comma
DECL|member|upper
id|upper
suffix:colon
l_int|1
comma
DECL|member|valid
id|valid
suffix:colon
l_int|1
suffix:semicolon
)brace
suffix:semicolon
DECL|macro|INIT_SHORTNAME_INFO
mdefine_line|#define INIT_SHORTNAME_INFO(x)&t;do {&t;&t;&bslash;&n;&t;(x)-&gt;lower = 1;&t;&t;&t;&t;&bslash;&n;&t;(x)-&gt;upper = 1;&t;&t;&t;&t;&bslash;&n;&t;(x)-&gt;valid = 1;&t;&t;&t;&t;&bslash;&n;} while (0)
r_static
r_inline
r_int
r_char
DECL|function|shortname_info_to_lcase
id|shortname_info_to_lcase
c_func
(paren
r_struct
id|shortname_info
op_star
id|base
comma
r_struct
id|shortname_info
op_star
id|ext
)paren
(brace
r_int
r_char
id|lcase
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|base-&gt;valid
op_logical_and
id|ext-&gt;valid
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|base-&gt;upper
op_logical_and
id|base-&gt;lower
op_logical_and
(paren
id|ext-&gt;lower
op_logical_or
id|ext-&gt;upper
)paren
)paren
id|lcase
op_or_assign
id|CASE_LOWER_BASE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ext-&gt;upper
op_logical_and
id|ext-&gt;lower
op_logical_and
(paren
id|base-&gt;lower
op_logical_or
id|base-&gt;upper
)paren
)paren
id|lcase
op_or_assign
id|CASE_LOWER_EXT
suffix:semicolon
)brace
r_return
id|lcase
suffix:semicolon
)brace
DECL|function|to_shortname_char
r_static
r_inline
r_int
id|to_shortname_char
c_func
(paren
r_struct
id|nls_table
op_star
id|nls
comma
r_char
op_star
id|buf
comma
r_int
id|buf_size
comma
m_wchar_t
op_star
id|src
comma
r_struct
id|shortname_info
op_star
id|info
)paren
(brace
r_int
id|len
suffix:semicolon
r_if
c_cond
(paren
id|IS_SKIPCHAR
c_func
(paren
op_star
id|src
)paren
)paren
(brace
id|info-&gt;valid
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|IS_REPLACECHAR
c_func
(paren
op_star
id|src
)paren
)paren
(brace
id|info-&gt;valid
op_assign
l_int|0
suffix:semicolon
id|buf
(braket
l_int|0
)braket
op_assign
l_char|&squot;_&squot;
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|len
op_assign
id|nls
op_member_access_from_pointer
id|uni2char
c_func
(paren
op_star
id|src
comma
id|buf
comma
id|buf_size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
op_le
l_int|0
)paren
(brace
id|info-&gt;valid
op_assign
l_int|0
suffix:semicolon
id|buf
(braket
l_int|0
)braket
op_assign
l_char|&squot;_&squot;
suffix:semicolon
id|len
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|len
op_eq
l_int|1
)paren
(brace
r_int
r_char
id|prev
op_assign
id|buf
(braket
l_int|0
)braket
suffix:semicolon
r_if
c_cond
(paren
id|buf
(braket
l_int|0
)braket
op_ge
l_int|0x7F
)paren
(brace
id|info-&gt;lower
op_assign
l_int|0
suffix:semicolon
id|info-&gt;upper
op_assign
l_int|0
suffix:semicolon
)brace
id|buf
(braket
l_int|0
)braket
op_assign
id|vfat_toupper
c_func
(paren
id|nls
comma
id|buf
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|isalpha
c_func
(paren
id|buf
(braket
l_int|0
)braket
)paren
)paren
(brace
r_if
c_cond
(paren
id|buf
(braket
l_int|0
)braket
op_eq
id|prev
)paren
id|info-&gt;lower
op_assign
l_int|0
suffix:semicolon
r_else
id|info-&gt;upper
op_assign
l_int|0
suffix:semicolon
)brace
)brace
r_else
(brace
id|info-&gt;lower
op_assign
l_int|0
suffix:semicolon
id|info-&gt;upper
op_assign
l_int|0
suffix:semicolon
)brace
r_return
id|len
suffix:semicolon
)brace
multiline_comment|/*&n; * Given a valid longname, create a unique shortname.  Make sure the&n; * shortname does not exist&n; * Returns negative number on error, 0 for a normal&n; * return, and 1 for valid shortname&n; */
DECL|function|vfat_create_shortname
r_static
r_int
id|vfat_create_shortname
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|nls_table
op_star
id|nls
comma
m_wchar_t
op_star
id|uname
comma
r_int
id|ulen
comma
r_char
op_star
id|name_res
comma
r_int
r_char
op_star
id|lcase
)paren
(brace
m_wchar_t
op_star
id|ip
comma
op_star
id|ext_start
comma
op_star
id|end
comma
op_star
id|name_start
suffix:semicolon
r_int
r_char
id|base
(braket
l_int|9
)braket
comma
id|ext
(braket
l_int|4
)braket
comma
id|buf
(braket
l_int|8
)braket
comma
op_star
id|p
suffix:semicolon
r_int
r_char
id|charbuf
(braket
id|NLS_MAX_CHARSET_SIZE
)braket
suffix:semicolon
r_int
id|chl
comma
id|chi
suffix:semicolon
r_int
id|sz
op_assign
l_int|0
comma
id|extlen
comma
id|baselen
comma
id|i
comma
id|numtail_baselen
comma
id|numtail2_baselen
suffix:semicolon
r_int
id|is_shortname
suffix:semicolon
r_struct
id|shortname_info
id|base_info
comma
id|ext_info
suffix:semicolon
r_int
r_int
id|opt_shortname
op_assign
id|MSDOS_SB
c_func
(paren
id|dir-&gt;i_sb
)paren
op_member_access_from_pointer
id|options.shortname
suffix:semicolon
id|is_shortname
op_assign
l_int|1
suffix:semicolon
id|INIT_SHORTNAME_INFO
c_func
(paren
op_amp
id|base_info
)paren
suffix:semicolon
id|INIT_SHORTNAME_INFO
c_func
(paren
op_amp
id|ext_info
)paren
suffix:semicolon
multiline_comment|/* Now, we need to create a shortname from the long name */
id|ext_start
op_assign
id|end
op_assign
op_amp
id|uname
(braket
id|ulen
)braket
suffix:semicolon
r_while
c_loop
(paren
op_decrement
id|ext_start
op_ge
id|uname
)paren
(brace
r_if
c_cond
(paren
op_star
id|ext_start
op_eq
l_int|0x002E
)paren
(brace
multiline_comment|/* is `.&squot; */
r_if
c_cond
(paren
id|ext_start
op_eq
id|end
op_minus
l_int|1
)paren
(brace
id|sz
op_assign
id|ulen
suffix:semicolon
id|ext_start
op_assign
l_int|NULL
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|ext_start
op_eq
id|uname
op_minus
l_int|1
)paren
(brace
id|sz
op_assign
id|ulen
suffix:semicolon
id|ext_start
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ext_start
)paren
(brace
multiline_comment|/*&n;&t;&t; * Names which start with a dot could be just&n;&t;&t; * an extension eg. &quot;...test&quot;.  In this case Win95&n;&t;&t; * uses the extension as the name and sets no extension.&n;&t;&t; */
id|name_start
op_assign
op_amp
id|uname
(braket
l_int|0
)braket
suffix:semicolon
r_while
c_loop
(paren
id|name_start
OL
id|ext_start
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|IS_SKIPCHAR
c_func
(paren
op_star
id|name_start
)paren
)paren
r_break
suffix:semicolon
id|name_start
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|name_start
op_ne
id|ext_start
)paren
(brace
id|sz
op_assign
id|ext_start
op_minus
id|uname
suffix:semicolon
id|ext_start
op_increment
suffix:semicolon
)brace
r_else
(brace
id|sz
op_assign
id|ulen
suffix:semicolon
id|ext_start
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
id|numtail_baselen
op_assign
l_int|6
suffix:semicolon
id|numtail2_baselen
op_assign
l_int|2
suffix:semicolon
r_for
c_loop
(paren
id|baselen
op_assign
id|i
op_assign
l_int|0
comma
id|p
op_assign
id|base
comma
id|ip
op_assign
id|uname
suffix:semicolon
id|i
OL
id|sz
suffix:semicolon
id|i
op_increment
comma
id|ip
op_increment
)paren
(brace
id|chl
op_assign
id|to_shortname_char
c_func
(paren
id|nls
comma
id|charbuf
comma
r_sizeof
(paren
id|charbuf
)paren
comma
id|ip
comma
op_amp
id|base_info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chl
op_eq
l_int|0
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|baselen
template_param
l_int|2
)paren
id|numtail2_baselen
op_assign
id|baselen
suffix:semicolon
r_if
c_cond
(paren
id|baselen
template_param
l_int|6
)paren
id|numtail_baselen
op_assign
id|baselen
suffix:semicolon
r_for
c_loop
(paren
id|chi
op_assign
l_int|0
suffix:semicolon
id|chi
OL
id|chl
suffix:semicolon
id|chi
op_increment
)paren
(brace
op_star
id|p
op_increment
op_assign
id|charbuf
(braket
id|chi
)braket
suffix:semicolon
id|baselen
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|baselen
op_ge
l_int|8
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|baselen
op_ge
l_int|8
)paren
(brace
r_if
c_cond
(paren
(paren
id|chi
OL
id|chl
op_minus
l_int|1
)paren
op_logical_or
(paren
id|ip
op_plus
l_int|1
)paren
op_minus
id|uname
OL
id|sz
)paren
id|is_shortname
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|baselen
op_eq
l_int|0
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|extlen
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|ext_start
)paren
(brace
r_for
c_loop
(paren
id|p
op_assign
id|ext
comma
id|ip
op_assign
id|ext_start
suffix:semicolon
id|extlen
OL
l_int|3
op_logical_and
id|ip
OL
id|end
suffix:semicolon
id|ip
op_increment
)paren
(brace
id|chl
op_assign
id|to_shortname_char
c_func
(paren
id|nls
comma
id|charbuf
comma
r_sizeof
(paren
id|charbuf
)paren
comma
id|ip
comma
op_amp
id|ext_info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|chl
op_eq
l_int|0
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
(paren
id|extlen
op_plus
id|chl
)paren
OG
l_int|3
)paren
(brace
id|is_shortname
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
r_for
c_loop
(paren
id|chi
op_assign
l_int|0
suffix:semicolon
id|chi
OL
id|chl
suffix:semicolon
id|chi
op_increment
)paren
(brace
op_star
id|p
op_increment
op_assign
id|charbuf
(braket
id|chi
)braket
suffix:semicolon
id|extlen
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|extlen
op_ge
l_int|3
)paren
(brace
r_if
c_cond
(paren
id|ip
op_plus
l_int|1
op_ne
id|end
)paren
id|is_shortname
op_assign
l_int|0
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
id|ext
(braket
id|extlen
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|base
(braket
id|baselen
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
multiline_comment|/* Yes, it can happen. &quot;.&bslash;xe5&quot; would do it. */
r_if
c_cond
(paren
id|base
(braket
l_int|0
)braket
op_eq
id|DELETED_FLAG
)paren
id|base
(braket
l_int|0
)braket
op_assign
l_int|0x05
suffix:semicolon
multiline_comment|/* OK, at this point we know that base is not longer than 8 symbols,&n;&t; * ext is not longer than 3, base is nonempty, both don&squot;t contain&n;&t; * any bad symbols (lowercase transformed to uppercase).&n;&t; */
id|memset
c_func
(paren
id|name_res
comma
l_char|&squot; &squot;
comma
id|MSDOS_NAME
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|name_res
comma
id|base
comma
id|baselen
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|name_res
op_plus
l_int|8
comma
id|ext
comma
id|extlen
)paren
suffix:semicolon
op_star
id|lcase
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|is_shortname
op_logical_and
id|base_info.valid
op_logical_and
id|ext_info.valid
)paren
(brace
r_if
c_cond
(paren
id|vfat_find_form
c_func
(paren
id|dir
comma
id|name_res
)paren
op_eq
l_int|0
)paren
r_return
op_minus
id|EEXIST
suffix:semicolon
r_if
c_cond
(paren
id|opt_shortname
op_amp
id|VFAT_SFN_CREATE_WIN95
)paren
(brace
r_return
(paren
id|base_info.upper
op_logical_and
id|ext_info.upper
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|opt_shortname
op_amp
id|VFAT_SFN_CREATE_WINNT
)paren
(brace
r_if
c_cond
(paren
(paren
id|base_info.upper
op_logical_or
id|base_info.lower
)paren
op_logical_and
(paren
id|ext_info.upper
op_logical_or
id|ext_info.lower
)paren
)paren
(brace
op_star
id|lcase
op_assign
id|shortname_info_to_lcase
c_func
(paren
op_amp
id|base_info
comma
op_amp
id|ext_info
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|BUG
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|MSDOS_SB
c_func
(paren
id|dir-&gt;i_sb
)paren
op_member_access_from_pointer
id|options.numtail
op_eq
l_int|0
)paren
r_if
c_cond
(paren
id|vfat_find_form
c_func
(paren
id|dir
comma
id|name_res
)paren
OL
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t; * Try to find a unique extension.  This used to&n;&t; * iterate through all possibilities sequentially,&n;&t; * but that gave extremely bad performance.  Windows&n;&t; * only tries a few cases before using random&n;&t; * values for part of the base.&n;&t; */
r_if
c_cond
(paren
id|baselen
OG
l_int|6
)paren
(brace
id|baselen
op_assign
id|numtail_baselen
suffix:semicolon
id|name_res
(braket
l_int|7
)braket
op_assign
l_char|&squot; &squot;
suffix:semicolon
)brace
id|name_res
(braket
id|baselen
)braket
op_assign
l_char|&squot;~&squot;
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|1
suffix:semicolon
id|i
OL
l_int|10
suffix:semicolon
id|i
op_increment
)paren
(brace
id|name_res
(braket
id|baselen
op_plus
l_int|1
)braket
op_assign
id|i
op_plus
l_char|&squot;0&squot;
suffix:semicolon
r_if
c_cond
(paren
id|vfat_find_form
c_func
(paren
id|dir
comma
id|name_res
)paren
OL
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
)brace
id|i
op_assign
id|jiffies
op_amp
l_int|0xffff
suffix:semicolon
id|sz
op_assign
(paren
id|jiffies
op_rshift
l_int|16
)paren
op_amp
l_int|0x7
suffix:semicolon
r_if
c_cond
(paren
id|baselen
OG
l_int|2
)paren
(brace
id|baselen
op_assign
id|numtail2_baselen
suffix:semicolon
id|name_res
(braket
l_int|7
)braket
op_assign
l_char|&squot; &squot;
suffix:semicolon
)brace
id|name_res
(braket
id|baselen
op_plus
l_int|4
)braket
op_assign
l_char|&squot;~&squot;
suffix:semicolon
id|name_res
(braket
id|baselen
op_plus
l_int|5
)braket
op_assign
l_char|&squot;1&squot;
op_plus
id|sz
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|sprintf
c_func
(paren
id|buf
comma
l_string|&quot;%04X&quot;
comma
id|i
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|name_res
(braket
id|baselen
)braket
comma
id|buf
comma
l_int|4
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vfat_find_form
c_func
(paren
id|dir
comma
id|name_res
)paren
OL
l_int|0
)paren
r_break
suffix:semicolon
id|i
op_sub_assign
l_int|11
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Translate a string, including coded sequences into Unicode */
r_static
r_int
DECL|function|xlate_to_uni
id|xlate_to_uni
c_func
(paren
r_const
r_char
op_star
id|name
comma
r_int
id|len
comma
r_char
op_star
id|outname
comma
r_int
op_star
id|longlen
comma
r_int
op_star
id|outlen
comma
r_int
id|escape
comma
r_int
id|utf8
comma
r_struct
id|nls_table
op_star
id|nls
)paren
(brace
r_const
r_int
r_char
op_star
id|ip
suffix:semicolon
r_int
r_char
id|nc
suffix:semicolon
r_char
op_star
id|op
suffix:semicolon
r_int
r_int
id|ec
suffix:semicolon
r_int
id|i
comma
id|k
comma
id|fill
suffix:semicolon
r_int
id|charlen
suffix:semicolon
r_if
c_cond
(paren
id|utf8
)paren
(brace
op_star
id|outlen
op_assign
id|utf8_mbstowcs
c_func
(paren
(paren
id|__u16
op_star
)paren
id|outname
comma
id|name
comma
id|PAGE_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|name
(braket
id|len
op_minus
l_int|1
)braket
op_eq
l_char|&squot;.&squot;
)paren
op_star
id|outlen
op_sub_assign
l_int|2
suffix:semicolon
id|op
op_assign
op_amp
id|outname
(braket
op_star
id|outlen
op_star
r_sizeof
(paren
id|__u16
)paren
)braket
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|name
(braket
id|len
op_minus
l_int|1
)braket
op_eq
l_char|&squot;.&squot;
)paren
id|len
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|nls
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|ip
op_assign
id|name
comma
id|op
op_assign
id|outname
comma
op_star
id|outlen
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
op_logical_and
op_star
id|outlen
op_le
l_int|260
suffix:semicolon
op_star
id|outlen
op_add_assign
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|escape
op_logical_and
(paren
op_star
id|ip
op_eq
l_char|&squot;:&squot;
)paren
)paren
(brace
r_if
c_cond
(paren
id|i
OG
id|len
op_minus
l_int|5
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|ec
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|k
op_assign
l_int|1
suffix:semicolon
id|k
OL
l_int|5
suffix:semicolon
id|k
op_increment
)paren
(brace
id|nc
op_assign
id|ip
(braket
id|k
)braket
suffix:semicolon
id|ec
op_lshift_assign
l_int|4
suffix:semicolon
r_if
c_cond
(paren
id|nc
op_ge
l_char|&squot;0&squot;
op_logical_and
id|nc
op_le
l_char|&squot;9&squot;
)paren
(brace
id|ec
op_or_assign
id|nc
op_minus
l_char|&squot;0&squot;
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|nc
op_ge
l_char|&squot;a&squot;
op_logical_and
id|nc
op_le
l_char|&squot;f&squot;
)paren
(brace
id|ec
op_or_assign
id|nc
op_minus
(paren
l_char|&squot;a&squot;
op_minus
l_int|10
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|nc
op_ge
l_char|&squot;A&squot;
op_logical_and
id|nc
op_le
l_char|&squot;F&squot;
)paren
(brace
id|ec
op_or_assign
id|nc
op_minus
(paren
l_char|&squot;A&squot;
op_minus
l_int|10
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
op_star
id|op
op_increment
op_assign
id|ec
op_amp
l_int|0xFF
suffix:semicolon
op_star
id|op
op_increment
op_assign
id|ec
op_rshift
l_int|8
suffix:semicolon
id|ip
op_add_assign
l_int|5
suffix:semicolon
id|i
op_add_assign
l_int|5
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
(paren
id|charlen
op_assign
id|nls
op_member_access_from_pointer
id|char2uni
c_func
(paren
id|ip
comma
id|len
op_minus
id|i
comma
(paren
m_wchar_t
op_star
)paren
id|op
)paren
)paren
OL
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|ip
op_add_assign
id|charlen
suffix:semicolon
id|i
op_add_assign
id|charlen
suffix:semicolon
id|op
op_add_assign
l_int|2
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|ip
op_assign
id|name
comma
id|op
op_assign
id|outname
comma
op_star
id|outlen
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|len
op_logical_and
op_star
id|outlen
op_le
l_int|260
suffix:semicolon
id|i
op_increment
comma
op_star
id|outlen
op_add_assign
l_int|1
)paren
(brace
op_star
id|op
op_increment
op_assign
op_star
id|ip
op_increment
suffix:semicolon
op_star
id|op
op_increment
op_assign
l_int|0
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
op_star
id|outlen
OG
l_int|260
)paren
r_return
op_minus
id|ENAMETOOLONG
suffix:semicolon
op_star
id|longlen
op_assign
op_star
id|outlen
suffix:semicolon
r_if
c_cond
(paren
op_star
id|outlen
op_mod
l_int|13
)paren
(brace
op_star
id|op
op_increment
op_assign
l_int|0
suffix:semicolon
op_star
id|op
op_increment
op_assign
l_int|0
suffix:semicolon
op_star
id|outlen
op_add_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_star
id|outlen
op_mod
l_int|13
)paren
(brace
id|fill
op_assign
l_int|13
op_minus
(paren
op_star
id|outlen
op_mod
l_int|13
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|fill
suffix:semicolon
id|i
op_increment
)paren
(brace
op_star
id|op
op_increment
op_assign
l_int|0xff
suffix:semicolon
op_star
id|op
op_increment
op_assign
l_int|0xff
suffix:semicolon
)brace
op_star
id|outlen
op_add_assign
id|fill
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|vfat_fill_slots
id|vfat_fill_slots
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|msdos_dir_slot
op_star
id|ds
comma
r_const
r_char
op_star
id|name
comma
r_int
id|len
comma
r_int
op_star
id|slots
comma
r_int
id|is_dir
comma
r_int
id|uni_xlate
)paren
(brace
r_struct
id|nls_table
op_star
id|nls_io
comma
op_star
id|nls_disk
suffix:semicolon
m_wchar_t
op_star
id|uname
suffix:semicolon
r_struct
id|msdos_dir_slot
op_star
id|ps
suffix:semicolon
r_struct
id|msdos_dir_entry
op_star
id|de
suffix:semicolon
r_int
r_int
id|page
suffix:semicolon
r_int
r_char
id|cksum
comma
id|lcase
suffix:semicolon
r_char
op_star
id|uniname
comma
id|msdos_name
(braket
id|MSDOS_NAME
)braket
suffix:semicolon
r_int
id|res
comma
id|utf8
comma
id|slot
comma
id|ulen
comma
id|unilen
comma
id|i
suffix:semicolon
id|loff_t
id|offset
suffix:semicolon
op_star
id|slots
op_assign
l_int|0
suffix:semicolon
id|utf8
op_assign
id|MSDOS_SB
c_func
(paren
id|dir-&gt;i_sb
)paren
op_member_access_from_pointer
id|options.utf8
suffix:semicolon
id|nls_io
op_assign
id|MSDOS_SB
c_func
(paren
id|dir-&gt;i_sb
)paren
op_member_access_from_pointer
id|nls_io
suffix:semicolon
id|nls_disk
op_assign
id|MSDOS_SB
c_func
(paren
id|dir-&gt;i_sb
)paren
op_member_access_from_pointer
id|nls_disk
suffix:semicolon
r_if
c_cond
(paren
id|name
(braket
id|len
op_minus
l_int|1
)braket
op_eq
l_char|&squot;.&squot;
)paren
id|len
op_decrement
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|page
op_assign
id|__get_free_page
c_func
(paren
id|GFP_KERNEL
)paren
)paren
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|uniname
op_assign
(paren
r_char
op_star
)paren
id|page
suffix:semicolon
id|res
op_assign
id|xlate_to_uni
c_func
(paren
id|name
comma
id|len
comma
id|uniname
comma
op_amp
id|ulen
comma
op_amp
id|unilen
comma
id|uni_xlate
comma
id|utf8
comma
id|nls_io
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
OL
l_int|0
)paren
r_goto
id|out_free
suffix:semicolon
id|uname
op_assign
(paren
m_wchar_t
op_star
)paren
id|page
suffix:semicolon
id|res
op_assign
id|vfat_is_used_badchars
c_func
(paren
id|uname
comma
id|ulen
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
OL
l_int|0
)paren
r_goto
id|out_free
suffix:semicolon
id|res
op_assign
id|vfat_create_shortname
c_func
(paren
id|dir
comma
id|nls_disk
comma
id|uname
comma
id|ulen
comma
id|msdos_name
comma
op_amp
id|lcase
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
OL
l_int|0
)paren
r_goto
id|out_free
suffix:semicolon
r_else
r_if
c_cond
(paren
id|res
op_eq
l_int|1
)paren
(brace
id|de
op_assign
(paren
r_struct
id|msdos_dir_entry
op_star
)paren
id|ds
suffix:semicolon
id|res
op_assign
l_int|0
suffix:semicolon
r_goto
id|shortname
suffix:semicolon
)brace
multiline_comment|/* build the entry of long file name */
op_star
id|slots
op_assign
id|unilen
op_div
l_int|13
suffix:semicolon
r_for
c_loop
(paren
id|cksum
op_assign
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|11
suffix:semicolon
id|i
op_increment
)paren
(brace
id|cksum
op_assign
(paren
(paren
(paren
id|cksum
op_amp
l_int|1
)paren
op_lshift
l_int|7
)paren
op_or
(paren
(paren
id|cksum
op_amp
l_int|0xfe
)paren
op_rshift
l_int|1
)paren
)paren
op_plus
id|msdos_name
(braket
id|i
)braket
suffix:semicolon
)brace
id|PRINTK3
c_func
(paren
(paren
l_string|&quot;vfat_fill_slots 3: slots=%d&bslash;n&quot;
comma
op_star
id|slots
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|ps
op_assign
id|ds
comma
id|slot
op_assign
op_star
id|slots
suffix:semicolon
id|slot
OG
l_int|0
suffix:semicolon
id|slot
op_decrement
comma
id|ps
op_increment
)paren
(brace
id|ps-&gt;id
op_assign
id|slot
suffix:semicolon
id|ps-&gt;attr
op_assign
id|ATTR_EXT
suffix:semicolon
id|ps-&gt;reserved
op_assign
l_int|0
suffix:semicolon
id|ps-&gt;alias_checksum
op_assign
id|cksum
suffix:semicolon
id|ps-&gt;start
op_assign
l_int|0
suffix:semicolon
id|offset
op_assign
(paren
id|slot
op_minus
l_int|1
)paren
op_star
l_int|13
suffix:semicolon
id|fatwchar_to16
c_func
(paren
id|ps-&gt;name0_4
comma
id|uname
op_plus
id|offset
comma
l_int|5
)paren
suffix:semicolon
id|fatwchar_to16
c_func
(paren
id|ps-&gt;name5_10
comma
id|uname
op_plus
id|offset
op_plus
l_int|5
comma
l_int|6
)paren
suffix:semicolon
id|fatwchar_to16
c_func
(paren
id|ps-&gt;name11_12
comma
id|uname
op_plus
id|offset
op_plus
l_int|11
comma
l_int|2
)paren
suffix:semicolon
)brace
id|ds
(braket
l_int|0
)braket
dot
id|id
op_or_assign
l_int|0x40
suffix:semicolon
id|de
op_assign
(paren
r_struct
id|msdos_dir_entry
op_star
)paren
id|ps
suffix:semicolon
id|shortname
suffix:colon
id|PRINTK3
c_func
(paren
(paren
l_string|&quot;vfat_fill_slots 9&bslash;n&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* build the entry of 8.3 alias name */
(paren
op_star
id|slots
)paren
op_increment
suffix:semicolon
id|strncpy
c_func
(paren
id|de-&gt;name
comma
id|msdos_name
comma
id|MSDOS_NAME
)paren
suffix:semicolon
id|de-&gt;attr
op_assign
id|is_dir
ques
c_cond
id|ATTR_DIR
suffix:colon
id|ATTR_ARCH
suffix:semicolon
id|de-&gt;lcase
op_assign
id|lcase
suffix:semicolon
id|de-&gt;adate
op_assign
id|de-&gt;cdate
op_assign
id|de-&gt;date
op_assign
l_int|0
suffix:semicolon
id|de-&gt;ctime_ms
op_assign
id|de-&gt;ctime
op_assign
id|de-&gt;time
op_assign
l_int|0
suffix:semicolon
id|de-&gt;start
op_assign
l_int|0
suffix:semicolon
id|de-&gt;starthi
op_assign
l_int|0
suffix:semicolon
id|de-&gt;size
op_assign
l_int|0
suffix:semicolon
id|out_free
suffix:colon
id|free_page
c_func
(paren
id|page
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
multiline_comment|/* We can&squot;t get &quot;.&quot; or &quot;..&quot; here - VFS takes care of those cases */
DECL|function|vfat_build_slots
r_static
r_int
id|vfat_build_slots
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_const
r_char
op_star
id|name
comma
r_int
id|len
comma
r_struct
id|msdos_dir_slot
op_star
id|ds
comma
r_int
op_star
id|slots
comma
r_int
id|is_dir
)paren
(brace
r_int
id|res
comma
id|xlate
suffix:semicolon
id|xlate
op_assign
id|MSDOS_SB
c_func
(paren
id|dir-&gt;i_sb
)paren
op_member_access_from_pointer
id|options.unicode_xlate
suffix:semicolon
id|res
op_assign
id|vfat_valid_longname
c_func
(paren
id|name
comma
id|len
comma
id|xlate
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
OL
l_int|0
)paren
r_return
id|res
suffix:semicolon
r_return
id|vfat_fill_slots
c_func
(paren
id|dir
comma
id|ds
comma
id|name
comma
id|len
comma
id|slots
comma
id|is_dir
comma
id|xlate
)paren
suffix:semicolon
)brace
DECL|function|vfat_add_entry
r_static
r_int
id|vfat_add_entry
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|qstr
op_star
id|qname
comma
r_int
id|is_dir
comma
r_struct
id|vfat_slot_info
op_star
id|sinfo_out
comma
r_struct
id|buffer_head
op_star
op_star
id|bh
comma
r_struct
id|msdos_dir_entry
op_star
op_star
id|de
)paren
(brace
r_struct
id|super_block
op_star
id|sb
op_assign
id|dir-&gt;i_sb
suffix:semicolon
r_struct
id|msdos_dir_slot
op_star
id|dir_slots
suffix:semicolon
id|loff_t
id|offset
suffix:semicolon
r_int
id|slots
comma
id|slot
suffix:semicolon
r_int
id|res
comma
id|len
suffix:semicolon
r_struct
id|msdos_dir_entry
op_star
id|dummy_de
suffix:semicolon
r_struct
id|buffer_head
op_star
id|dummy_bh
suffix:semicolon
r_int
id|dummy_ino
suffix:semicolon
id|loff_t
id|dummy
suffix:semicolon
id|dir_slots
op_assign
(paren
r_struct
id|msdos_dir_slot
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|msdos_dir_slot
)paren
op_star
id|MSDOS_SLOTS
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dir_slots
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|len
op_assign
id|qname-&gt;len
suffix:semicolon
r_while
c_loop
(paren
id|len
op_logical_and
id|qname-&gt;name
(braket
id|len
op_minus
l_int|1
)braket
op_eq
l_char|&squot;.&squot;
)paren
id|len
op_decrement
suffix:semicolon
id|res
op_assign
id|fat_search_long
c_func
(paren
id|dir
comma
id|qname-&gt;name
comma
id|len
comma
(paren
id|MSDOS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|options.name_check
op_ne
l_char|&squot;s&squot;
)paren
op_logical_or
op_logical_neg
id|MSDOS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|options.posixfs
comma
op_amp
id|dummy
comma
op_amp
id|dummy
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
OG
l_int|0
)paren
multiline_comment|/* found */
id|res
op_assign
op_minus
id|EEXIST
suffix:semicolon
r_if
c_cond
(paren
id|res
)paren
r_goto
id|cleanup
suffix:semicolon
id|res
op_assign
id|vfat_build_slots
c_func
(paren
id|dir
comma
id|qname-&gt;name
comma
id|len
comma
id|dir_slots
comma
op_amp
id|slots
comma
id|is_dir
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
OL
l_int|0
)paren
r_goto
id|cleanup
suffix:semicolon
multiline_comment|/* build the empty directory entry of number of slots */
id|offset
op_assign
id|fat_add_entries
c_func
(paren
id|dir
comma
id|slots
comma
op_amp
id|dummy_bh
comma
op_amp
id|dummy_de
comma
op_amp
id|dummy_ino
)paren
suffix:semicolon
r_if
c_cond
(paren
id|offset
OL
l_int|0
)paren
(brace
id|res
op_assign
id|offset
suffix:semicolon
r_goto
id|cleanup
suffix:semicolon
)brace
id|fat_brelse
c_func
(paren
id|sb
comma
id|dummy_bh
)paren
suffix:semicolon
multiline_comment|/* Now create the new entry */
op_star
id|bh
op_assign
l_int|NULL
suffix:semicolon
r_for
c_loop
(paren
id|slot
op_assign
l_int|0
suffix:semicolon
id|slot
OL
id|slots
suffix:semicolon
id|slot
op_increment
)paren
(brace
r_if
c_cond
(paren
id|fat_get_entry
c_func
(paren
id|dir
comma
op_amp
id|offset
comma
id|bh
comma
id|de
comma
op_amp
id|sinfo_out-&gt;ino
)paren
OL
l_int|0
)paren
(brace
id|res
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|cleanup
suffix:semicolon
)brace
id|memcpy
c_func
(paren
op_star
id|de
comma
id|dir_slots
op_plus
id|slot
comma
r_sizeof
(paren
r_struct
id|msdos_dir_slot
)paren
)paren
suffix:semicolon
id|fat_mark_buffer_dirty
c_func
(paren
id|sb
comma
op_star
id|bh
)paren
suffix:semicolon
)brace
id|res
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* update timestamp */
id|dir-&gt;i_ctime
op_assign
id|dir-&gt;i_mtime
op_assign
id|dir-&gt;i_atime
op_assign
id|CURRENT_TIME
suffix:semicolon
id|mark_inode_dirty
c_func
(paren
id|dir
)paren
suffix:semicolon
id|fat_date_unix2dos
c_func
(paren
id|dir-&gt;i_mtime
comma
op_amp
(paren
op_star
id|de
)paren
op_member_access_from_pointer
id|time
comma
op_amp
(paren
op_star
id|de
)paren
op_member_access_from_pointer
id|date
)paren
suffix:semicolon
(paren
op_star
id|de
)paren
op_member_access_from_pointer
id|ctime
op_assign
(paren
op_star
id|de
)paren
op_member_access_from_pointer
id|time
suffix:semicolon
(paren
op_star
id|de
)paren
op_member_access_from_pointer
id|adate
op_assign
(paren
op_star
id|de
)paren
op_member_access_from_pointer
id|cdate
op_assign
(paren
op_star
id|de
)paren
op_member_access_from_pointer
id|date
suffix:semicolon
id|fat_mark_buffer_dirty
c_func
(paren
id|sb
comma
op_star
id|bh
)paren
suffix:semicolon
multiline_comment|/* slots can&squot;t be less than 1 */
id|sinfo_out-&gt;long_slots
op_assign
id|slots
op_minus
l_int|1
suffix:semicolon
id|sinfo_out-&gt;longname_offset
op_assign
id|offset
op_minus
r_sizeof
(paren
r_struct
id|msdos_dir_slot
)paren
op_star
id|slots
suffix:semicolon
id|cleanup
suffix:colon
id|kfree
c_func
(paren
id|dir_slots
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
DECL|function|vfat_find
r_static
r_int
id|vfat_find
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|qstr
op_star
id|qname
comma
r_struct
id|vfat_slot_info
op_star
id|sinfo
comma
r_struct
id|buffer_head
op_star
op_star
id|last_bh
comma
r_struct
id|msdos_dir_entry
op_star
op_star
id|last_de
)paren
(brace
r_struct
id|super_block
op_star
id|sb
op_assign
id|dir-&gt;i_sb
suffix:semicolon
id|loff_t
id|offset
suffix:semicolon
r_int
id|res
comma
id|len
suffix:semicolon
id|len
op_assign
id|qname-&gt;len
suffix:semicolon
r_while
c_loop
(paren
id|len
op_logical_and
id|qname-&gt;name
(braket
id|len
op_minus
l_int|1
)braket
op_eq
l_char|&squot;.&squot;
)paren
id|len
op_decrement
suffix:semicolon
id|res
op_assign
id|fat_search_long
c_func
(paren
id|dir
comma
id|qname-&gt;name
comma
id|len
comma
(paren
id|MSDOS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|options.name_check
op_ne
l_char|&squot;s&squot;
)paren
comma
op_amp
id|offset
comma
op_amp
id|sinfo-&gt;longname_offset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
OG
l_int|0
)paren
(brace
id|sinfo-&gt;long_slots
op_assign
id|res
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|fat_get_entry
c_func
(paren
id|dir
comma
op_amp
id|offset
comma
id|last_bh
comma
id|last_de
comma
op_amp
id|sinfo-&gt;ino
)paren
op_ge
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
id|res
op_assign
op_minus
id|EIO
suffix:semicolon
)brace
r_return
id|res
ques
c_cond
id|res
suffix:colon
op_minus
id|ENOENT
suffix:semicolon
)brace
DECL|function|vfat_lookup
r_struct
id|dentry
op_star
id|vfat_lookup
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|dentry
op_star
id|dentry
)paren
(brace
r_int
id|res
suffix:semicolon
r_struct
id|vfat_slot_info
id|sinfo
suffix:semicolon
r_struct
id|inode
op_star
id|inode
suffix:semicolon
r_struct
id|dentry
op_star
id|alias
suffix:semicolon
r_struct
id|buffer_head
op_star
id|bh
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|msdos_dir_entry
op_star
id|de
suffix:semicolon
r_int
id|table
suffix:semicolon
id|PRINTK2
c_func
(paren
(paren
l_string|&quot;vfat_lookup: name=%s, len=%d&bslash;n&quot;
comma
id|dentry-&gt;d_name.name
comma
id|dentry-&gt;d_name.len
)paren
)paren
suffix:semicolon
id|table
op_assign
(paren
id|MSDOS_SB
c_func
(paren
id|dir-&gt;i_sb
)paren
op_member_access_from_pointer
id|options.name_check
op_eq
l_char|&squot;s&squot;
)paren
ques
c_cond
l_int|2
suffix:colon
l_int|0
suffix:semicolon
id|dentry-&gt;d_op
op_assign
op_amp
id|vfat_dentry_ops
(braket
id|table
)braket
suffix:semicolon
id|inode
op_assign
l_int|NULL
suffix:semicolon
id|res
op_assign
id|vfat_find
c_func
(paren
id|dir
comma
op_amp
id|dentry-&gt;d_name
comma
op_amp
id|sinfo
comma
op_amp
id|bh
comma
op_amp
id|de
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
OL
l_int|0
)paren
(brace
id|table
op_increment
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
id|inode
op_assign
id|fat_build_inode
c_func
(paren
id|dir-&gt;i_sb
comma
id|de
comma
id|sinfo.ino
comma
op_amp
id|res
)paren
suffix:semicolon
id|fat_brelse
c_func
(paren
id|dir-&gt;i_sb
comma
id|bh
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
)paren
r_return
id|ERR_PTR
c_func
(paren
id|res
)paren
suffix:semicolon
id|alias
op_assign
id|d_find_alias
c_func
(paren
id|inode
)paren
suffix:semicolon
r_if
c_cond
(paren
id|alias
)paren
(brace
r_if
c_cond
(paren
id|d_invalidate
c_func
(paren
id|alias
)paren
op_eq
l_int|0
)paren
id|dput
c_func
(paren
id|alias
)paren
suffix:semicolon
r_else
(brace
id|iput
c_func
(paren
id|inode
)paren
suffix:semicolon
r_return
id|alias
suffix:semicolon
)brace
)brace
id|error
suffix:colon
id|dentry-&gt;d_op
op_assign
op_amp
id|vfat_dentry_ops
(braket
id|table
)braket
suffix:semicolon
id|dentry-&gt;d_time
op_assign
id|dentry-&gt;d_parent-&gt;d_inode-&gt;i_version
suffix:semicolon
id|d_add
c_func
(paren
id|dentry
comma
id|inode
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|vfat_create
r_int
id|vfat_create
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|dentry
op_star
id|dentry
comma
r_int
id|mode
)paren
(brace
r_struct
id|super_block
op_star
id|sb
op_assign
id|dir-&gt;i_sb
suffix:semicolon
r_struct
id|inode
op_star
id|inode
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|buffer_head
op_star
id|bh
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|msdos_dir_entry
op_star
id|de
suffix:semicolon
r_struct
id|vfat_slot_info
id|sinfo
suffix:semicolon
r_int
id|res
suffix:semicolon
id|res
op_assign
id|vfat_add_entry
c_func
(paren
id|dir
comma
op_amp
id|dentry-&gt;d_name
comma
l_int|0
comma
op_amp
id|sinfo
comma
op_amp
id|bh
comma
op_amp
id|de
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
OL
l_int|0
)paren
r_return
id|res
suffix:semicolon
id|inode
op_assign
id|fat_build_inode
c_func
(paren
id|sb
comma
id|de
comma
id|sinfo.ino
comma
op_amp
id|res
)paren
suffix:semicolon
id|fat_brelse
c_func
(paren
id|sb
comma
id|bh
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|inode
)paren
r_return
id|res
suffix:semicolon
id|inode-&gt;i_mtime
op_assign
id|inode-&gt;i_atime
op_assign
id|inode-&gt;i_ctime
op_assign
id|CURRENT_TIME
suffix:semicolon
id|mark_inode_dirty
c_func
(paren
id|inode
)paren
suffix:semicolon
id|inode-&gt;i_version
op_increment
suffix:semicolon
id|dir-&gt;i_version
op_increment
suffix:semicolon
id|dentry-&gt;d_time
op_assign
id|dentry-&gt;d_parent-&gt;d_inode-&gt;i_version
suffix:semicolon
id|d_instantiate
c_func
(paren
id|dentry
comma
id|inode
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|vfat_remove_entry
r_static
r_void
id|vfat_remove_entry
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|vfat_slot_info
op_star
id|sinfo
comma
r_struct
id|buffer_head
op_star
id|bh
comma
r_struct
id|msdos_dir_entry
op_star
id|de
)paren
(brace
r_struct
id|super_block
op_star
id|sb
op_assign
id|dir-&gt;i_sb
suffix:semicolon
id|loff_t
id|offset
suffix:semicolon
r_int
id|i
comma
id|ino
suffix:semicolon
multiline_comment|/* remove the shortname */
id|dir-&gt;i_mtime
op_assign
id|CURRENT_TIME
suffix:semicolon
id|dir-&gt;i_atime
op_assign
id|CURRENT_TIME
suffix:semicolon
id|dir-&gt;i_version
op_increment
suffix:semicolon
id|mark_inode_dirty
c_func
(paren
id|dir
)paren
suffix:semicolon
id|de-&gt;name
(braket
l_int|0
)braket
op_assign
id|DELETED_FLAG
suffix:semicolon
id|fat_mark_buffer_dirty
c_func
(paren
id|sb
comma
id|bh
)paren
suffix:semicolon
multiline_comment|/* remove the longname */
id|offset
op_assign
id|sinfo-&gt;longname_offset
suffix:semicolon
id|de
op_assign
l_int|NULL
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|sinfo-&gt;long_slots
suffix:semicolon
id|i
OG
l_int|0
suffix:semicolon
op_decrement
id|i
)paren
(brace
r_if
c_cond
(paren
id|fat_get_entry
c_func
(paren
id|dir
comma
op_amp
id|offset
comma
op_amp
id|bh
comma
op_amp
id|de
comma
op_amp
id|ino
)paren
OL
l_int|0
)paren
r_continue
suffix:semicolon
id|de-&gt;name
(braket
l_int|0
)braket
op_assign
id|DELETED_FLAG
suffix:semicolon
id|de-&gt;attr
op_assign
l_int|0
suffix:semicolon
id|fat_mark_buffer_dirty
c_func
(paren
id|sb
comma
id|bh
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|bh
)paren
id|fat_brelse
c_func
(paren
id|sb
comma
id|bh
)paren
suffix:semicolon
)brace
DECL|function|vfat_rmdir
r_int
id|vfat_rmdir
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|dentry
op_star
id|dentry
)paren
(brace
r_int
id|res
suffix:semicolon
r_struct
id|vfat_slot_info
id|sinfo
suffix:semicolon
r_struct
id|buffer_head
op_star
id|bh
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|msdos_dir_entry
op_star
id|de
suffix:semicolon
id|res
op_assign
id|fat_dir_empty
c_func
(paren
id|dentry-&gt;d_inode
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
)paren
r_return
id|res
suffix:semicolon
id|res
op_assign
id|vfat_find
c_func
(paren
id|dir
comma
op_amp
id|dentry-&gt;d_name
comma
op_amp
id|sinfo
comma
op_amp
id|bh
comma
op_amp
id|de
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
OL
l_int|0
)paren
r_return
id|res
suffix:semicolon
id|dentry-&gt;d_inode-&gt;i_nlink
op_assign
l_int|0
suffix:semicolon
id|dentry-&gt;d_inode-&gt;i_mtime
op_assign
id|CURRENT_TIME
suffix:semicolon
id|dentry-&gt;d_inode-&gt;i_atime
op_assign
id|CURRENT_TIME
suffix:semicolon
id|fat_detach
c_func
(paren
id|dentry-&gt;d_inode
)paren
suffix:semicolon
id|mark_inode_dirty
c_func
(paren
id|dentry-&gt;d_inode
)paren
suffix:semicolon
multiline_comment|/* releases bh */
id|vfat_remove_entry
c_func
(paren
id|dir
comma
op_amp
id|sinfo
comma
id|bh
comma
id|de
)paren
suffix:semicolon
id|dir-&gt;i_nlink
op_decrement
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|vfat_unlink
r_int
id|vfat_unlink
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|dentry
op_star
id|dentry
)paren
(brace
r_int
id|res
suffix:semicolon
r_struct
id|vfat_slot_info
id|sinfo
suffix:semicolon
r_struct
id|buffer_head
op_star
id|bh
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|msdos_dir_entry
op_star
id|de
suffix:semicolon
id|PRINTK1
c_func
(paren
(paren
l_string|&quot;vfat_unlink: %s&bslash;n&quot;
comma
id|dentry-&gt;d_name.name
)paren
)paren
suffix:semicolon
id|res
op_assign
id|vfat_find
c_func
(paren
id|dir
comma
op_amp
id|dentry-&gt;d_name
comma
op_amp
id|sinfo
comma
op_amp
id|bh
comma
op_amp
id|de
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
OL
l_int|0
)paren
r_return
id|res
suffix:semicolon
id|dentry-&gt;d_inode-&gt;i_nlink
op_assign
l_int|0
suffix:semicolon
id|dentry-&gt;d_inode-&gt;i_mtime
op_assign
id|CURRENT_TIME
suffix:semicolon
id|dentry-&gt;d_inode-&gt;i_atime
op_assign
id|CURRENT_TIME
suffix:semicolon
id|fat_detach
c_func
(paren
id|dentry-&gt;d_inode
)paren
suffix:semicolon
id|mark_inode_dirty
c_func
(paren
id|dentry-&gt;d_inode
)paren
suffix:semicolon
multiline_comment|/* releases bh */
id|vfat_remove_entry
c_func
(paren
id|dir
comma
op_amp
id|sinfo
comma
id|bh
comma
id|de
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
DECL|function|vfat_mkdir
r_int
id|vfat_mkdir
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|dentry
op_star
id|dentry
comma
r_int
id|mode
)paren
(brace
r_struct
id|super_block
op_star
id|sb
op_assign
id|dir-&gt;i_sb
suffix:semicolon
r_struct
id|inode
op_star
id|inode
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|vfat_slot_info
id|sinfo
suffix:semicolon
r_struct
id|buffer_head
op_star
id|bh
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|msdos_dir_entry
op_star
id|de
suffix:semicolon
r_int
id|res
suffix:semicolon
id|res
op_assign
id|vfat_add_entry
c_func
(paren
id|dir
comma
op_amp
id|dentry-&gt;d_name
comma
l_int|1
comma
op_amp
id|sinfo
comma
op_amp
id|bh
comma
op_amp
id|de
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
OL
l_int|0
)paren
r_return
id|res
suffix:semicolon
id|inode
op_assign
id|fat_build_inode
c_func
(paren
id|sb
comma
id|de
comma
id|sinfo.ino
comma
op_amp
id|res
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|inode
)paren
r_goto
id|out
suffix:semicolon
id|inode-&gt;i_mtime
op_assign
id|inode-&gt;i_atime
op_assign
id|inode-&gt;i_ctime
op_assign
id|CURRENT_TIME
suffix:semicolon
id|mark_inode_dirty
c_func
(paren
id|inode
)paren
suffix:semicolon
id|inode-&gt;i_version
op_increment
suffix:semicolon
id|dir-&gt;i_version
op_increment
suffix:semicolon
id|dir-&gt;i_nlink
op_increment
suffix:semicolon
id|inode-&gt;i_nlink
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* no need to mark them dirty */
id|res
op_assign
id|fat_new_dir
c_func
(paren
id|inode
comma
id|dir
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
OL
l_int|0
)paren
r_goto
id|mkdir_failed
suffix:semicolon
id|dentry-&gt;d_time
op_assign
id|dentry-&gt;d_parent-&gt;d_inode-&gt;i_version
suffix:semicolon
id|d_instantiate
c_func
(paren
id|dentry
comma
id|inode
)paren
suffix:semicolon
id|out
suffix:colon
id|fat_brelse
c_func
(paren
id|sb
comma
id|bh
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
id|mkdir_failed
suffix:colon
id|inode-&gt;i_nlink
op_assign
l_int|0
suffix:semicolon
id|inode-&gt;i_mtime
op_assign
id|CURRENT_TIME
suffix:semicolon
id|inode-&gt;i_atime
op_assign
id|CURRENT_TIME
suffix:semicolon
id|fat_detach
c_func
(paren
id|inode
)paren
suffix:semicolon
id|mark_inode_dirty
c_func
(paren
id|inode
)paren
suffix:semicolon
multiline_comment|/* releases bh */
id|vfat_remove_entry
c_func
(paren
id|dir
comma
op_amp
id|sinfo
comma
id|bh
comma
id|de
)paren
suffix:semicolon
id|iput
c_func
(paren
id|inode
)paren
suffix:semicolon
id|dir-&gt;i_nlink
op_decrement
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
DECL|function|vfat_rename
r_int
id|vfat_rename
c_func
(paren
r_struct
id|inode
op_star
id|old_dir
comma
r_struct
id|dentry
op_star
id|old_dentry
comma
r_struct
id|inode
op_star
id|new_dir
comma
r_struct
id|dentry
op_star
id|new_dentry
)paren
(brace
r_struct
id|super_block
op_star
id|sb
op_assign
id|old_dir-&gt;i_sb
suffix:semicolon
r_struct
id|buffer_head
op_star
id|old_bh
comma
op_star
id|new_bh
comma
op_star
id|dotdot_bh
suffix:semicolon
r_struct
id|msdos_dir_entry
op_star
id|old_de
comma
op_star
id|new_de
comma
op_star
id|dotdot_de
suffix:semicolon
r_int
id|dotdot_ino
suffix:semicolon
r_struct
id|inode
op_star
id|old_inode
comma
op_star
id|new_inode
suffix:semicolon
r_int
id|res
comma
id|is_dir
suffix:semicolon
r_struct
id|vfat_slot_info
id|old_sinfo
comma
id|sinfo
suffix:semicolon
id|old_bh
op_assign
id|new_bh
op_assign
id|dotdot_bh
op_assign
l_int|NULL
suffix:semicolon
id|old_inode
op_assign
id|old_dentry-&gt;d_inode
suffix:semicolon
id|new_inode
op_assign
id|new_dentry-&gt;d_inode
suffix:semicolon
id|res
op_assign
id|vfat_find
c_func
(paren
id|old_dir
comma
op_amp
id|old_dentry-&gt;d_name
comma
op_amp
id|old_sinfo
comma
op_amp
id|old_bh
comma
op_amp
id|old_de
)paren
suffix:semicolon
id|PRINTK3
c_func
(paren
(paren
l_string|&quot;vfat_rename 2&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
OL
l_int|0
)paren
r_goto
id|rename_done
suffix:semicolon
id|is_dir
op_assign
id|S_ISDIR
c_func
(paren
id|old_inode-&gt;i_mode
)paren
suffix:semicolon
r_if
c_cond
(paren
id|is_dir
op_logical_and
(paren
id|res
op_assign
id|fat_scan
c_func
(paren
id|old_inode
comma
id|MSDOS_DOTDOT
comma
op_amp
id|dotdot_bh
comma
op_amp
id|dotdot_de
comma
op_amp
id|dotdot_ino
)paren
)paren
OL
l_int|0
)paren
r_goto
id|rename_done
suffix:semicolon
r_if
c_cond
(paren
id|new_dentry-&gt;d_inode
)paren
(brace
id|res
op_assign
id|vfat_find
c_func
(paren
id|new_dir
comma
op_amp
id|new_dentry-&gt;d_name
comma
op_amp
id|sinfo
comma
op_amp
id|new_bh
comma
op_amp
id|new_de
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
OL
l_int|0
op_logical_or
id|MSDOS_I
c_func
(paren
id|new_inode
)paren
op_member_access_from_pointer
id|i_location
op_ne
id|sinfo.ino
)paren
(brace
multiline_comment|/* WTF??? Cry and fail. */
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;vfat_rename: fs corrupted&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|rename_done
suffix:semicolon
)brace
r_if
c_cond
(paren
id|is_dir
)paren
(brace
id|res
op_assign
id|fat_dir_empty
c_func
(paren
id|new_inode
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
)paren
r_goto
id|rename_done
suffix:semicolon
)brace
id|fat_detach
c_func
(paren
id|new_inode
)paren
suffix:semicolon
)brace
r_else
(brace
id|res
op_assign
id|vfat_add_entry
c_func
(paren
id|new_dir
comma
op_amp
id|new_dentry-&gt;d_name
comma
id|is_dir
comma
op_amp
id|sinfo
comma
op_amp
id|new_bh
comma
op_amp
id|new_de
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
OL
l_int|0
)paren
r_goto
id|rename_done
suffix:semicolon
)brace
id|new_dir-&gt;i_version
op_increment
suffix:semicolon
multiline_comment|/* releases old_bh */
id|vfat_remove_entry
c_func
(paren
id|old_dir
comma
op_amp
id|old_sinfo
comma
id|old_bh
comma
id|old_de
)paren
suffix:semicolon
id|old_bh
op_assign
l_int|NULL
suffix:semicolon
id|fat_detach
c_func
(paren
id|old_inode
)paren
suffix:semicolon
id|fat_attach
c_func
(paren
id|old_inode
comma
id|sinfo.ino
)paren
suffix:semicolon
id|mark_inode_dirty
c_func
(paren
id|old_inode
)paren
suffix:semicolon
id|old_dir-&gt;i_version
op_increment
suffix:semicolon
id|old_dir-&gt;i_ctime
op_assign
id|old_dir-&gt;i_mtime
op_assign
id|CURRENT_TIME
suffix:semicolon
id|mark_inode_dirty
c_func
(paren
id|old_dir
)paren
suffix:semicolon
r_if
c_cond
(paren
id|new_inode
)paren
(brace
id|new_inode-&gt;i_nlink
op_decrement
suffix:semicolon
id|new_inode-&gt;i_ctime
op_assign
id|CURRENT_TIME
suffix:semicolon
)brace
r_if
c_cond
(paren
id|is_dir
)paren
(brace
r_int
id|start
op_assign
id|MSDOS_I
c_func
(paren
id|new_dir
)paren
op_member_access_from_pointer
id|i_logstart
suffix:semicolon
id|dotdot_de-&gt;start
op_assign
id|CT_LE_W
c_func
(paren
id|start
)paren
suffix:semicolon
id|dotdot_de-&gt;starthi
op_assign
id|CT_LE_W
c_func
(paren
id|start
op_rshift
l_int|16
)paren
suffix:semicolon
id|fat_mark_buffer_dirty
c_func
(paren
id|sb
comma
id|dotdot_bh
)paren
suffix:semicolon
id|old_dir-&gt;i_nlink
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|new_inode
)paren
(brace
id|new_inode-&gt;i_nlink
op_decrement
suffix:semicolon
)brace
r_else
(brace
id|new_dir-&gt;i_nlink
op_increment
suffix:semicolon
id|mark_inode_dirty
c_func
(paren
id|new_dir
)paren
suffix:semicolon
)brace
)brace
id|rename_done
suffix:colon
id|fat_brelse
c_func
(paren
id|sb
comma
id|dotdot_bh
)paren
suffix:semicolon
id|fat_brelse
c_func
(paren
id|sb
comma
id|old_bh
)paren
suffix:semicolon
id|fat_brelse
c_func
(paren
id|sb
comma
id|new_bh
)paren
suffix:semicolon
r_return
id|res
suffix:semicolon
)brace
multiline_comment|/* Public inode operations for the VFAT fs */
DECL|variable|vfat_dir_inode_operations
r_struct
id|inode_operations
id|vfat_dir_inode_operations
op_assign
(brace
id|create
suffix:colon
id|vfat_create
comma
id|lookup
suffix:colon
id|vfat_lookup
comma
id|unlink
suffix:colon
id|vfat_unlink
comma
id|mkdir
suffix:colon
id|vfat_mkdir
comma
id|rmdir
suffix:colon
id|vfat_rmdir
comma
id|rename
suffix:colon
id|vfat_rename
comma
id|setattr
suffix:colon
id|fat_notify_change
comma
)brace
suffix:semicolon
DECL|function|vfat_read_super
r_struct
id|super_block
op_star
id|vfat_read_super
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_void
op_star
id|data
comma
r_int
id|silent
)paren
(brace
r_struct
id|super_block
op_star
id|res
suffix:semicolon
id|MSDOS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|options.isvfat
op_assign
l_int|1
suffix:semicolon
id|res
op_assign
id|fat_read_super
c_func
(paren
id|sb
comma
id|data
comma
id|silent
comma
op_amp
id|vfat_dir_inode_operations
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|res
)paren
)paren
r_return
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|res
op_eq
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|silent
)paren
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;VFS: Can&squot;t find a valid&quot;
l_string|&quot; VFAT filesystem on dev %s.&bslash;n&quot;
comma
id|sb-&gt;s_id
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|parse_options
c_func
(paren
(paren
r_char
op_star
)paren
id|data
comma
op_amp
(paren
id|MSDOS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|options
)paren
)paren
)paren
(brace
id|MSDOS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|options.dotsOK
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|MSDOS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|options.posixfs
)paren
(brace
id|MSDOS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|options.name_check
op_assign
l_char|&squot;s&squot;
suffix:semicolon
)brace
r_if
c_cond
(paren
id|MSDOS_SB
c_func
(paren
id|sb
)paren
op_member_access_from_pointer
id|options.name_check
op_ne
l_char|&squot;s&squot;
)paren
(brace
id|sb-&gt;s_root-&gt;d_op
op_assign
op_amp
id|vfat_dentry_ops
(braket
l_int|0
)braket
suffix:semicolon
)brace
r_else
(brace
id|sb-&gt;s_root-&gt;d_op
op_assign
op_amp
id|vfat_dentry_ops
(braket
l_int|2
)braket
suffix:semicolon
)brace
)brace
r_return
id|res
suffix:semicolon
)brace
eof
