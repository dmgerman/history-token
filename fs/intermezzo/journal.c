multiline_comment|/*&n; * Intermezzo. (C) 1998 Peter J. Braam&n; *&n; * Support for journalling extended attributes&n; * (C) 2001 Shirish H. Phatak, Tacit Networks, Inc.&n; */
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/vmalloc.h&gt;
macro_line|#include &lt;linux/time.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/intermezzo_fs.h&gt;
macro_line|#include &lt;linux/intermezzo_upcall.h&gt;
macro_line|#include &lt;linux/intermezzo_psdev.h&gt;
macro_line|#include &lt;linux/intermezzo_kml.h&gt;
r_static
r_int
id|presto_log
c_func
(paren
r_struct
id|presto_file_set
op_star
id|fset
comma
r_struct
id|rec_info
op_star
id|rec
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|size
comma
r_const
r_char
op_star
id|string1
comma
r_int
id|len1
comma
r_const
r_char
op_star
id|string2
comma
r_int
id|len2
comma
r_const
r_char
op_star
id|string3
comma
r_int
id|len3
)paren
suffix:semicolon
multiline_comment|/*&n; *  reserve record space and/or atomically request state of the log&n; *  rec will hold the location reserved record upon return&n; *  this reservation will be placed in the queue&n; */
DECL|function|presto_reserve_record
r_static
r_void
id|presto_reserve_record
c_func
(paren
r_struct
id|presto_file_set
op_star
id|fset
comma
r_struct
id|presto_log_fd
op_star
id|fd
comma
r_struct
id|rec_info
op_star
id|rec
comma
r_struct
id|presto_reservation_data
op_star
id|rd
)paren
(brace
r_int
id|chunked_record
op_assign
l_int|0
suffix:semicolon
id|ENTRY
suffix:semicolon
id|write_lock
c_func
(paren
op_amp
id|fd-&gt;fd_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rec-&gt;is_kml
)paren
(brace
r_int
id|chunk
op_assign
l_int|1
op_lshift
id|fset-&gt;fset_chunkbits
suffix:semicolon
r_int
id|chunk_mask
op_assign
op_complement
(paren
id|chunk
op_minus
l_int|1
)paren
suffix:semicolon
id|loff_t
id|boundary
suffix:semicolon
id|boundary
op_assign
(paren
id|fd-&gt;fd_offset
op_plus
id|chunk
op_minus
l_int|1
)paren
op_amp
id|chunk_mask
suffix:semicolon
r_if
c_cond
(paren
id|fd-&gt;fd_offset
op_plus
id|rec-&gt;size
op_ge
id|boundary
)paren
(brace
id|chunked_record
op_assign
l_int|1
suffix:semicolon
id|fd-&gt;fd_offset
op_assign
id|boundary
suffix:semicolon
)brace
)brace
id|fd-&gt;fd_recno
op_increment
suffix:semicolon
multiline_comment|/* this move the fd_offset back after truncation */
r_if
c_cond
(paren
id|list_empty
c_func
(paren
op_amp
id|fd-&gt;fd_reservations
)paren
op_logical_and
op_logical_neg
id|chunked_record
)paren
(brace
id|fd-&gt;fd_offset
op_assign
id|fd-&gt;fd_file-&gt;f_dentry-&gt;d_inode-&gt;i_size
suffix:semicolon
)brace
id|rec-&gt;offset
op_assign
id|fd-&gt;fd_offset
suffix:semicolon
id|rec-&gt;recno
op_assign
id|fd-&gt;fd_recno
suffix:semicolon
id|fd-&gt;fd_offset
op_add_assign
id|rec-&gt;size
suffix:semicolon
multiline_comment|/* add the reservation data to the end of the list */
id|list_add
c_func
(paren
op_amp
id|rd-&gt;ri_list
comma
id|fd-&gt;fd_reservations.prev
)paren
suffix:semicolon
id|rd-&gt;ri_offset
op_assign
id|rec-&gt;offset
suffix:semicolon
id|rd-&gt;ri_size
op_assign
id|rec-&gt;size
suffix:semicolon
id|rd-&gt;ri_recno
op_assign
id|rec-&gt;recno
suffix:semicolon
id|write_unlock
c_func
(paren
op_amp
id|fd-&gt;fd_lock
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
)brace
DECL|function|presto_release_record
r_static
r_inline
r_void
id|presto_release_record
c_func
(paren
r_struct
id|presto_log_fd
op_star
id|fd
comma
r_struct
id|presto_reservation_data
op_star
id|rd
)paren
(brace
id|write_lock
c_func
(paren
op_amp
id|fd-&gt;fd_lock
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|rd-&gt;ri_list
)paren
suffix:semicolon
id|write_unlock
c_func
(paren
op_amp
id|fd-&gt;fd_lock
)paren
suffix:semicolon
)brace
DECL|function|presto_do_truncate
r_static
r_int
id|presto_do_truncate
c_func
(paren
r_struct
id|presto_file_set
op_star
id|fset
comma
r_struct
id|dentry
op_star
id|dentry
comma
id|loff_t
id|length
comma
id|loff_t
id|size_check
)paren
(brace
r_struct
id|inode
op_star
id|inode
op_assign
id|dentry-&gt;d_inode
suffix:semicolon
r_struct
id|inode_operations
op_star
id|op
suffix:semicolon
r_int
id|error
suffix:semicolon
r_struct
id|iattr
id|newattrs
suffix:semicolon
id|ENTRY
suffix:semicolon
multiline_comment|/* Not pretty: &quot;inode-&gt;i_size&quot; shouldn&squot;t really be &quot;loff_t&quot;. */
r_if
c_cond
(paren
(paren
id|off_t
)paren
id|length
OL
l_int|0
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|fs_down
c_func
(paren
op_amp
id|inode-&gt;i_sem
)paren
suffix:semicolon
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|size_check
op_ne
id|inode-&gt;i_size
)paren
(brace
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
id|fs_up
c_func
(paren
op_amp
id|inode-&gt;i_sem
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
op_minus
id|EALREADY
suffix:semicolon
)brace
id|newattrs.ia_size
op_assign
id|length
suffix:semicolon
id|newattrs.ia_valid
op_assign
id|ATTR_SIZE
op_or
id|ATTR_CTIME
suffix:semicolon
id|op
op_assign
id|filter_c2cfiops
c_func
(paren
id|fset-&gt;fset_cache-&gt;cache_filter
)paren
suffix:semicolon
r_if
c_cond
(paren
id|op
op_ne
l_int|NULL
op_logical_and
id|op-&gt;setattr
op_ne
l_int|NULL
)paren
id|error
op_assign
id|op
op_member_access_from_pointer
id|setattr
c_func
(paren
id|dentry
comma
op_amp
id|newattrs
)paren
suffix:semicolon
r_else
(brace
id|inode_setattr
c_func
(paren
id|dentry-&gt;d_inode
comma
op_amp
id|newattrs
)paren
suffix:semicolon
multiline_comment|/* Some filesystems, e.g. ext2 and older versions of ext3&n;                   legitimately do not have a &lt;fs&gt;_setattr method. -SHP&n;                */
multiline_comment|/*&n;                printk (&quot;Warning:: int presto_do_truncate(xxx), op-&gt;setattr == NULL&quot;);&n;&t;&t;error = -EOPNOTSUPP; &n;&t;&t;*/
id|error
op_assign
l_int|0
suffix:semicolon
)brace
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
id|fs_up
c_func
(paren
op_amp
id|inode-&gt;i_sem
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|function|presto_trans_start
r_void
op_star
id|presto_trans_start
c_func
(paren
r_struct
id|presto_file_set
op_star
id|fset
comma
r_struct
id|inode
op_star
id|inode
comma
r_int
id|op
)paren
(brace
id|ENTRY
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fset-&gt;fset_cache-&gt;cache_filter-&gt;o_trops
)paren
r_return
l_int|NULL
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|fset-&gt;fset_cache-&gt;cache_filter-&gt;o_trops-&gt;tr_start
(paren
id|fset
comma
id|inode
comma
id|op
)paren
suffix:semicolon
)brace
DECL|function|presto_trans_commit
r_void
id|presto_trans_commit
c_func
(paren
r_struct
id|presto_file_set
op_star
id|fset
comma
r_void
op_star
id|handle
)paren
(brace
id|ENTRY
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fset-&gt;fset_cache-&gt;cache_filter-&gt;o_trops
)paren
r_return
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|fset-&gt;fset_cache-&gt;cache_filter-&gt;o_trops
op_member_access_from_pointer
id|tr_commit
c_func
(paren
id|fset
comma
id|handle
)paren
suffix:semicolon
)brace
DECL|function|presto_no_journal
r_inline
r_int
id|presto_no_journal
c_func
(paren
r_struct
id|presto_file_set
op_star
id|fset
)paren
(brace
r_int
id|minor
op_assign
id|fset-&gt;fset_cache-&gt;cache_psdev-&gt;uc_minor
suffix:semicolon
r_return
id|upc_comms
(braket
id|minor
)braket
dot
id|uc_no_journal
suffix:semicolon
)brace
DECL|macro|size_round
mdefine_line|#define size_round(x)  (((x)+3) &amp; ~0x3)
DECL|macro|BUFF_FREE
mdefine_line|#define BUFF_FREE(buf) PRESTO_FREE(buf, PAGE_SIZE)
DECL|macro|BUFF_ALLOC
mdefine_line|#define BUFF_ALLOC(newbuf, oldbuf)                      &bslash;&n;        PRESTO_ALLOC(newbuf, char *, PAGE_SIZE);        &bslash;&n;        if ( !newbuf ) {                                &bslash;&n;                if (oldbuf)                             &bslash;&n;                        BUFF_FREE(oldbuf);              &bslash;&n;                return -ENOMEM;                         &bslash;&n;        }
multiline_comment|/*&n; * &quot;buflen&quot; should be PAGE_SIZE or more.&n; * Give relative path wrt to a fsetroot&n; */
DECL|function|presto_path
r_char
op_star
id|presto_path
c_func
(paren
r_struct
id|dentry
op_star
id|dentry
comma
r_struct
id|dentry
op_star
id|root
comma
r_char
op_star
id|buffer
comma
r_int
id|buflen
)paren
(brace
r_char
op_star
id|end
op_assign
id|buffer
op_plus
id|buflen
suffix:semicolon
r_char
op_star
id|retval
suffix:semicolon
op_star
op_decrement
id|end
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|buflen
op_decrement
suffix:semicolon
r_if
c_cond
(paren
id|dentry-&gt;d_parent
op_ne
id|dentry
op_logical_and
id|list_empty
c_func
(paren
op_amp
id|dentry-&gt;d_hash
)paren
)paren
(brace
id|buflen
op_sub_assign
l_int|10
suffix:semicolon
id|end
op_sub_assign
l_int|10
suffix:semicolon
id|memcpy
c_func
(paren
id|end
comma
l_string|&quot; (deleted)&quot;
comma
l_int|10
)paren
suffix:semicolon
)brace
multiline_comment|/* Get &squot;/&squot; right */
id|retval
op_assign
id|end
op_minus
l_int|1
suffix:semicolon
op_star
id|retval
op_assign
l_char|&squot;/&squot;
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
r_struct
id|dentry
op_star
id|parent
suffix:semicolon
r_int
id|namelen
suffix:semicolon
r_if
c_cond
(paren
id|dentry
op_eq
id|root
)paren
r_break
suffix:semicolon
id|parent
op_assign
id|dentry-&gt;d_parent
suffix:semicolon
r_if
c_cond
(paren
id|dentry
op_eq
id|parent
)paren
r_break
suffix:semicolon
id|namelen
op_assign
id|dentry-&gt;d_name.len
suffix:semicolon
id|buflen
op_sub_assign
id|namelen
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|buflen
OL
l_int|0
)paren
r_break
suffix:semicolon
id|end
op_sub_assign
id|namelen
suffix:semicolon
id|memcpy
c_func
(paren
id|end
comma
id|dentry-&gt;d_name.name
comma
id|namelen
)paren
suffix:semicolon
op_star
op_decrement
id|end
op_assign
l_char|&squot;/&squot;
suffix:semicolon
id|retval
op_assign
id|end
suffix:semicolon
id|dentry
op_assign
id|parent
suffix:semicolon
)brace
r_return
id|retval
suffix:semicolon
)brace
DECL|function|logit
r_static
r_inline
r_char
op_star
id|logit
c_func
(paren
r_char
op_star
id|buf
comma
r_const
r_void
op_star
id|value
comma
r_int
id|size
)paren
(brace
r_char
op_star
id|ptr
op_assign
(paren
r_char
op_star
)paren
id|value
suffix:semicolon
id|memcpy
c_func
(paren
id|buf
comma
id|ptr
comma
id|size
)paren
suffix:semicolon
id|buf
op_add_assign
id|size
suffix:semicolon
r_return
id|buf
suffix:semicolon
)brace
r_static
r_inline
r_char
op_star
DECL|function|journal_log_prefix_with_groups_and_ids
id|journal_log_prefix_with_groups_and_ids
c_func
(paren
r_char
op_star
id|buf
comma
r_int
id|opcode
comma
r_struct
id|rec_info
op_star
id|rec
comma
id|__u32
id|ngroups
comma
id|gid_t
op_star
id|groups
comma
id|__u32
id|fsuid
comma
id|__u32
id|fsgid
)paren
(brace
r_struct
id|big_journal_prefix
id|p
suffix:semicolon
r_int
id|i
suffix:semicolon
id|p.len
op_assign
id|cpu_to_le32
c_func
(paren
id|rec-&gt;size
)paren
suffix:semicolon
id|p.version
op_assign
id|PRESTO_KML_MAJOR_VERSION
op_or
id|PRESTO_KML_MINOR_VERSION
suffix:semicolon
id|p.pid
op_assign
id|cpu_to_le32
c_func
(paren
id|current-&gt;pid
)paren
suffix:semicolon
id|p.uid
op_assign
id|cpu_to_le32
c_func
(paren
id|current-&gt;uid
)paren
suffix:semicolon
id|p.fsuid
op_assign
id|cpu_to_le32
c_func
(paren
id|fsuid
)paren
suffix:semicolon
id|p.fsgid
op_assign
id|cpu_to_le32
c_func
(paren
id|fsgid
)paren
suffix:semicolon
id|p.ngroups
op_assign
id|cpu_to_le32
c_func
(paren
id|ngroups
)paren
suffix:semicolon
id|p.opcode
op_assign
id|cpu_to_le32
c_func
(paren
id|opcode
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ngroups
suffix:semicolon
id|i
op_increment
)paren
id|p.groups
(braket
id|i
)braket
op_assign
id|cpu_to_le32
c_func
(paren
(paren
id|__u32
)paren
id|groups
(braket
id|i
)braket
)paren
suffix:semicolon
id|buf
op_assign
id|logit
c_func
(paren
id|buf
comma
op_amp
id|p
comma
r_sizeof
(paren
r_struct
id|journal_prefix
)paren
op_plus
r_sizeof
(paren
id|__u32
)paren
op_star
id|ngroups
)paren
suffix:semicolon
r_return
id|buf
suffix:semicolon
)brace
r_static
r_inline
r_char
op_star
DECL|function|journal_log_prefix
id|journal_log_prefix
c_func
(paren
r_char
op_star
id|buf
comma
r_int
id|opcode
comma
r_struct
id|rec_info
op_star
id|rec
)paren
(brace
id|__u32
id|groups
(braket
id|NGROUPS_MAX
)braket
suffix:semicolon
r_int
id|i
suffix:semicolon
multiline_comment|/* convert 16 bit gid&squot;s to 32 bit gid&squot;s */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|current-&gt;ngroups
suffix:semicolon
id|i
op_increment
)paren
id|groups
(braket
id|i
)braket
op_assign
(paren
id|__u32
)paren
id|current-&gt;groups
(braket
id|i
)braket
suffix:semicolon
r_return
id|journal_log_prefix_with_groups_and_ids
c_func
(paren
id|buf
comma
id|opcode
comma
id|rec
comma
(paren
id|__u32
)paren
id|current-&gt;ngroups
comma
id|groups
comma
(paren
id|__u32
)paren
id|current-&gt;fsuid
comma
(paren
id|__u32
)paren
id|current-&gt;fsgid
)paren
suffix:semicolon
)brace
r_static
r_inline
r_char
op_star
DECL|function|journal_log_prefix_with_groups
id|journal_log_prefix_with_groups
c_func
(paren
r_char
op_star
id|buf
comma
r_int
id|opcode
comma
r_struct
id|rec_info
op_star
id|rec
comma
id|__u32
id|ngroups
comma
id|gid_t
op_star
id|groups
)paren
(brace
r_return
id|journal_log_prefix_with_groups_and_ids
c_func
(paren
id|buf
comma
id|opcode
comma
id|rec
comma
id|ngroups
comma
id|groups
comma
(paren
id|__u32
)paren
id|current-&gt;fsuid
comma
(paren
id|__u32
)paren
id|current-&gt;fsgid
)paren
suffix:semicolon
)brace
DECL|function|log_version
r_static
r_inline
r_char
op_star
id|log_version
c_func
(paren
r_char
op_star
id|buf
comma
r_struct
id|dentry
op_star
id|dentry
)paren
(brace
r_struct
id|presto_version
id|version
suffix:semicolon
id|presto_getversion
c_func
(paren
op_amp
id|version
comma
id|dentry-&gt;d_inode
)paren
suffix:semicolon
r_return
id|logit
c_func
(paren
id|buf
comma
op_amp
id|version
comma
r_sizeof
(paren
id|version
)paren
)paren
suffix:semicolon
)brace
DECL|function|journal_log_suffix
r_static
r_inline
r_char
op_star
id|journal_log_suffix
c_func
(paren
r_char
op_star
id|buf
comma
r_char
op_star
id|log
comma
r_struct
id|presto_file_set
op_star
id|fset
comma
r_struct
id|dentry
op_star
id|dentry
comma
r_struct
id|rec_info
op_star
id|rec
)paren
(brace
r_struct
id|journal_suffix
id|s
suffix:semicolon
r_struct
id|journal_prefix
op_star
id|p
op_assign
(paren
r_struct
id|journal_prefix
op_star
)paren
id|log
suffix:semicolon
macro_line|#if 0
multiline_comment|/* XXX needs to be done after reservation, &n;&t;   disable ths until version 1.2 */
r_if
c_cond
(paren
id|dentry
)paren
(brace
id|s.prevrec
op_assign
id|cpu_to_le32
c_func
(paren
id|rec-&gt;offset
op_minus
id|presto_d2d
c_func
(paren
id|dentry
)paren
op_member_access_from_pointer
id|dd_kml_offset
)paren
suffix:semicolon
id|presto_d2d
c_func
(paren
id|dentry
)paren
op_member_access_from_pointer
id|dd_kml_offset
op_assign
id|rec-&gt;offset
suffix:semicolon
)brace
r_else
(brace
id|s.prevrec
op_assign
op_minus
l_int|1
suffix:semicolon
)brace
macro_line|#endif
id|s.prevrec
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* record number needs to be filled in after reservation &n;           s.recno = cpu_to_le32(rec-&gt;recno); */
id|s.time
op_assign
id|cpu_to_le32
c_func
(paren
id|CURRENT_TIME
)paren
suffix:semicolon
id|s.len
op_assign
id|cpu_to_le32
c_func
(paren
id|p-&gt;len
)paren
suffix:semicolon
r_return
id|logit
c_func
(paren
id|buf
comma
op_amp
id|s
comma
r_sizeof
(paren
id|s
)paren
)paren
suffix:semicolon
)brace
DECL|function|presto_close_journal_file
r_int
id|presto_close_journal_file
c_func
(paren
r_struct
id|presto_file_set
op_star
id|fset
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|rc2
op_assign
l_int|0
suffix:semicolon
r_int
id|rc3
op_assign
l_int|0
suffix:semicolon
id|ENTRY
suffix:semicolon
r_if
c_cond
(paren
id|fset-&gt;fset_kml.fd_file
)paren
(brace
id|rc
op_assign
id|filp_close
c_func
(paren
id|fset-&gt;fset_kml.fd_file
comma
l_int|0
)paren
suffix:semicolon
id|fset-&gt;fset_kml.fd_file
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;hehehehe no filp&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rc
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;presto: close files: kml filp won&squot;t close %d&bslash;n&quot;
comma
id|rc
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fset-&gt;fset_last_rcvd
)paren
(brace
id|rc2
op_assign
id|filp_close
c_func
(paren
id|fset-&gt;fset_last_rcvd
comma
l_int|0
)paren
suffix:semicolon
id|fset-&gt;fset_last_rcvd
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;hehehehe no filp&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rc2
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|rc
)paren
id|rc
op_assign
id|rc2
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;presto: close files: last_rcvd filp won&squot;t close %d&bslash;n&quot;
comma
id|rc2
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fset-&gt;fset_lml.fd_file
)paren
(brace
id|rc3
op_assign
id|filp_close
c_func
(paren
id|fset-&gt;fset_lml.fd_file
comma
l_int|0
)paren
suffix:semicolon
id|fset-&gt;fset_lml.fd_file
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;hehehehe no filp&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rc3
)paren
(brace
r_if
c_cond
(paren
(paren
op_logical_neg
id|rc
)paren
op_logical_and
(paren
op_logical_neg
id|rc2
)paren
)paren
id|rc
op_assign
id|rc3
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;presto: close files: lml filp won&squot;t close %d&bslash;n&quot;
comma
id|rc3
)paren
suffix:semicolon
)brace
r_return
id|rc
suffix:semicolon
)brace
DECL|function|presto_fwrite
r_int
id|presto_fwrite
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|str
comma
r_int
id|len
comma
id|loff_t
op_star
id|off
)paren
(brace
r_int
id|rc
suffix:semicolon
id|mm_segment_t
id|old_fs
suffix:semicolon
id|ENTRY
suffix:semicolon
id|rc
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|off
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|file
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|file-&gt;f_op
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|file-&gt;f_op-&gt;write
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|old_fs
op_assign
id|get_fs
c_func
(paren
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|get_ds
c_func
(paren
)paren
)paren
suffix:semicolon
id|rc
op_assign
id|file-&gt;f_op
op_member_access_from_pointer
id|write
c_func
(paren
id|file
comma
id|str
comma
id|len
comma
id|off
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ne
id|len
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;presto_fwrite: wrote %d bytes instead of &quot;
l_string|&quot;%d at %ld&bslash;n&quot;
comma
id|rc
comma
id|len
comma
(paren
r_int
)paren
op_star
id|off
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
)brace
id|set_fs
c_func
(paren
id|old_fs
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|presto_fread
r_int
id|presto_fread
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_char
op_star
id|str
comma
r_int
id|len
comma
id|loff_t
op_star
id|off
)paren
(brace
r_int
id|rc
suffix:semicolon
id|mm_segment_t
id|old_fs
suffix:semicolon
id|ENTRY
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
l_int|512
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;presto_fread: read at %Ld for %d bytes, ino %ld&bslash;n&quot;
comma
op_star
id|off
comma
id|len
comma
id|file-&gt;f_dentry-&gt;d_inode-&gt;i_ino
)paren
suffix:semicolon
)brace
id|rc
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|off
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|file
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|file-&gt;f_op
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|file-&gt;f_op-&gt;read
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|old_fs
op_assign
id|get_fs
c_func
(paren
)paren
suffix:semicolon
id|set_fs
c_func
(paren
id|get_ds
c_func
(paren
)paren
)paren
suffix:semicolon
id|rc
op_assign
id|file-&gt;f_op
op_member_access_from_pointer
id|read
c_func
(paren
id|file
comma
id|str
comma
id|len
comma
id|off
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ne
id|len
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;presto_fread: read %d bytes instead of &quot;
l_string|&quot;%d at %ld&bslash;n&quot;
comma
id|rc
comma
id|len
comma
(paren
r_int
)paren
op_star
id|off
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
)brace
id|set_fs
c_func
(paren
id|old_fs
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|presto_kml_dispatch
r_static
r_int
id|presto_kml_dispatch
c_func
(paren
r_struct
id|presto_file_set
op_star
id|fset
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|kml_recno
suffix:semicolon
r_struct
id|presto_log_fd
op_star
id|fd
op_assign
op_amp
id|fset-&gt;fset_kml
suffix:semicolon
id|loff_t
id|offset
suffix:semicolon
id|ENTRY
suffix:semicolon
id|write_lock
c_func
(paren
op_amp
id|fd-&gt;fd_lock
)paren
suffix:semicolon
multiline_comment|/* Determine the largest valid offset, i.e. up until the first&n;         * reservation held on the file. */
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|fd-&gt;fd_reservations
)paren
)paren
(brace
r_struct
id|presto_reservation_data
op_star
id|rd
suffix:semicolon
id|rd
op_assign
id|list_entry
c_func
(paren
id|fd-&gt;fd_reservations.next
comma
r_struct
id|presto_reservation_data
comma
id|ri_list
)paren
suffix:semicolon
id|offset
op_assign
id|rd-&gt;ri_offset
suffix:semicolon
id|kml_recno
op_assign
id|rd-&gt;ri_recno
suffix:semicolon
)brace
r_else
(brace
id|offset
op_assign
id|fd-&gt;fd_file-&gt;f_dentry-&gt;d_inode-&gt;i_size
suffix:semicolon
id|kml_recno
op_assign
id|fset-&gt;fset_kml.fd_recno
suffix:semicolon
)brace
r_if
c_cond
(paren
id|kml_recno
OL
id|fset-&gt;fset_lento_recno
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;presto_kml_dispatch: smoke is coming&bslash;n&quot;
)paren
suffix:semicolon
id|write_unlock
c_func
(paren
op_amp
id|fd-&gt;fd_lock
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|kml_recno
op_eq
id|fset-&gt;fset_lento_recno
)paren
(brace
id|write_unlock
c_func
(paren
op_amp
id|fd-&gt;fd_lock
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|CDEBUG
c_func
(paren
id|D_PIOCTL
comma
l_string|&quot;fset: %s&bslash;n&quot;
comma
id|fset-&gt;fset_name
)paren
suffix:semicolon
id|rc
op_assign
id|lento_kml
c_func
(paren
id|fset-&gt;fset_cache-&gt;cache_psdev-&gt;uc_minor
comma
id|fset-&gt;fset_lento_off
comma
id|fset-&gt;fset_lento_recno
comma
id|offset
comma
id|kml_recno
comma
id|strlen
c_func
(paren
id|fset-&gt;fset_name
)paren
comma
id|fset-&gt;fset_name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|write_unlock
c_func
(paren
op_amp
id|fd-&gt;fd_lock
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|fset-&gt;fset_lento_off
op_assign
id|offset
suffix:semicolon
id|fset-&gt;fset_lento_recno
op_assign
id|kml_recno
suffix:semicolon
id|write_unlock
c_func
(paren
op_amp
id|fd-&gt;fd_lock
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* structure of an extended log record:&n;&n;   buf-prefix  buf-body [string1 [string2 [string3]]] buf-suffix&n;&n;   note: moves offset forward&n;*/
DECL|function|presto_write_record
r_static
r_inline
r_int
id|presto_write_record
c_func
(paren
r_struct
id|file
op_star
id|f
comma
id|loff_t
op_star
id|off
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|size
comma
r_const
r_char
op_star
id|string1
comma
r_int
id|len1
comma
r_const
r_char
op_star
id|string2
comma
r_int
id|len2
comma
r_const
r_char
op_star
id|string3
comma
r_int
id|len3
)paren
(brace
r_int
id|prefix_size
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|prefix_size
op_assign
id|size
op_minus
r_sizeof
(paren
r_struct
id|journal_suffix
)paren
suffix:semicolon
id|rc
op_assign
id|presto_fwrite
c_func
(paren
id|f
comma
id|buf
comma
id|prefix_size
comma
id|off
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ne
id|prefix_size
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Write error!&bslash;n&quot;
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_if
c_cond
(paren
id|string1
op_logical_and
id|len1
)paren
(brace
id|rc
op_assign
id|presto_fwrite
c_func
(paren
id|f
comma
id|string1
comma
id|len1
comma
id|off
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ne
id|len1
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Write error!&bslash;n&quot;
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|string2
op_logical_and
id|len2
)paren
(brace
id|rc
op_assign
id|presto_fwrite
c_func
(paren
id|f
comma
id|string2
comma
id|len2
comma
id|off
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ne
id|len2
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Write error!&bslash;n&quot;
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|string3
op_logical_and
id|len3
)paren
(brace
id|rc
op_assign
id|presto_fwrite
c_func
(paren
id|f
comma
id|string3
comma
id|len3
comma
id|off
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ne
id|len3
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Write error!&bslash;n&quot;
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
)brace
id|rc
op_assign
id|presto_fwrite
c_func
(paren
id|f
comma
id|buf
op_plus
id|prefix_size
comma
r_sizeof
(paren
r_struct
id|journal_suffix
)paren
comma
id|off
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ne
r_sizeof
(paren
r_struct
id|journal_suffix
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Write error!&bslash;n&quot;
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * rec-&gt;size must be valid prior to calling this function.&n; */
DECL|function|presto_log
r_static
r_int
id|presto_log
c_func
(paren
r_struct
id|presto_file_set
op_star
id|fset
comma
r_struct
id|rec_info
op_star
id|rec
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|size
comma
r_const
r_char
op_star
id|string1
comma
r_int
id|len1
comma
r_const
r_char
op_star
id|string2
comma
r_int
id|len2
comma
r_const
r_char
op_star
id|string3
comma
r_int
id|len3
)paren
(brace
r_int
id|rc
suffix:semicolon
r_struct
id|presto_reservation_data
id|rd
suffix:semicolon
id|loff_t
id|offset
suffix:semicolon
r_struct
id|presto_log_fd
op_star
id|fd
suffix:semicolon
r_struct
id|journal_suffix
op_star
id|s
suffix:semicolon
r_int
id|prefix_size
suffix:semicolon
id|ENTRY
suffix:semicolon
multiline_comment|/* buf is NULL when no_journal is in effect */
r_if
c_cond
(paren
op_logical_neg
id|buf
)paren
(brace
id|EXIT
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rec-&gt;is_kml
)paren
(brace
id|fd
op_assign
op_amp
id|fset-&gt;fset_kml
suffix:semicolon
)brace
r_else
(brace
id|fd
op_assign
op_amp
id|fset-&gt;fset_lml
suffix:semicolon
)brace
id|presto_reserve_record
c_func
(paren
id|fset
comma
id|fd
comma
id|rec
comma
op_amp
id|rd
)paren
suffix:semicolon
id|offset
op_assign
id|rec-&gt;offset
suffix:semicolon
multiline_comment|/* now we know the record number */
id|prefix_size
op_assign
id|size
op_minus
r_sizeof
(paren
r_struct
id|journal_suffix
)paren
suffix:semicolon
id|s
op_assign
(paren
r_struct
id|journal_suffix
op_star
)paren
(paren
id|buf
op_plus
id|prefix_size
)paren
suffix:semicolon
id|s-&gt;recno
op_assign
id|cpu_to_le32
c_func
(paren
id|rec-&gt;recno
)paren
suffix:semicolon
id|rc
op_assign
id|presto_write_record
c_func
(paren
id|fd-&gt;fd_file
comma
op_amp
id|offset
comma
id|buf
comma
id|size
comma
id|string1
comma
id|len1
comma
id|string2
comma
id|len2
comma
id|string3
comma
id|len3
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;presto: error writing record to %s&bslash;n&quot;
comma
id|rec-&gt;is_kml
ques
c_cond
l_string|&quot;KML&quot;
suffix:colon
l_string|&quot;LML&quot;
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|presto_release_record
c_func
(paren
id|fd
comma
op_amp
id|rd
)paren
suffix:semicolon
id|rc
op_assign
id|presto_kml_dispatch
c_func
(paren
id|fset
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/* read from the record at tail */
DECL|function|presto_last_record
r_static
r_int
id|presto_last_record
c_func
(paren
r_struct
id|presto_log_fd
op_star
id|fd
comma
id|loff_t
op_star
id|size
comma
id|loff_t
op_star
id|tail_offset
comma
id|__u32
op_star
id|recno
comma
id|loff_t
id|tail
)paren
(brace
r_struct
id|journal_suffix
id|suffix
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|loff_t
id|zeroes
suffix:semicolon
op_star
id|recno
op_assign
l_int|0
suffix:semicolon
op_star
id|tail_offset
op_assign
l_int|0
suffix:semicolon
op_star
id|size
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|tail
OL
r_sizeof
(paren
r_struct
id|journal_prefix
)paren
op_plus
r_sizeof
(paren
id|suffix
)paren
)paren
(brace
id|EXIT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|zeroes
op_assign
id|tail
op_minus
r_sizeof
(paren
r_int
)paren
suffix:semicolon
r_while
c_loop
(paren
id|zeroes
op_ge
l_int|0
)paren
(brace
r_int
id|data
suffix:semicolon
id|rc
op_assign
id|presto_fread
c_func
(paren
id|fd-&gt;fd_file
comma
(paren
r_char
op_star
)paren
op_amp
id|data
comma
r_sizeof
(paren
id|data
)paren
comma
op_amp
id|zeroes
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ne
r_sizeof
(paren
id|data
)paren
)paren
(brace
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_if
c_cond
(paren
id|data
)paren
r_break
suffix:semicolon
id|zeroes
op_sub_assign
l_int|2
op_star
r_sizeof
(paren
id|data
)paren
suffix:semicolon
)brace
multiline_comment|/* zeroes at the begining of file. this is needed to prevent&n;&t;   presto_fread errors  -SHP&n;&t;*/
r_if
c_cond
(paren
id|zeroes
op_le
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
id|zeroes
op_sub_assign
r_sizeof
(paren
id|suffix
)paren
suffix:semicolon
id|rc
op_assign
id|presto_fread
c_func
(paren
id|fd-&gt;fd_file
comma
(paren
r_char
op_star
)paren
op_amp
id|suffix
comma
r_sizeof
(paren
id|suffix
)paren
comma
op_amp
id|zeroes
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ne
r_sizeof
(paren
id|suffix
)paren
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_if
c_cond
(paren
id|suffix.len
OG
l_int|500
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;PRESTO: Warning long record tail at %ld, rec tail_offset at %ld (size %d)&bslash;n&quot;
comma
(paren
r_int
)paren
id|zeroes
comma
(paren
r_int
)paren
op_star
id|tail_offset
comma
id|suffix.len
)paren
suffix:semicolon
)brace
op_star
id|recno
op_assign
id|suffix.recno
suffix:semicolon
op_star
id|size
op_assign
id|suffix.len
suffix:semicolon
op_star
id|tail_offset
op_assign
id|zeroes
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|presto_kml_last_recno
r_static
r_int
id|presto_kml_last_recno
c_func
(paren
r_struct
id|presto_file_set
op_star
id|fset
)paren
(brace
r_int
id|rc
suffix:semicolon
id|loff_t
id|size
suffix:semicolon
id|loff_t
id|tail_offset
suffix:semicolon
r_int
id|recno
suffix:semicolon
id|loff_t
id|tail
op_assign
id|fset-&gt;fset_kml.fd_file-&gt;f_dentry-&gt;d_inode-&gt;i_size
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|presto_last_record
c_func
(paren
op_amp
id|fset-&gt;fset_kml
comma
op_amp
id|size
comma
op_amp
id|tail_offset
comma
op_amp
id|recno
comma
id|tail
)paren
)paren
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|fset-&gt;fset_kml.fd_offset
op_assign
id|tail_offset
suffix:semicolon
id|fset-&gt;fset_kml.fd_recno
op_assign
id|recno
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_JOURNAL
comma
l_string|&quot;setting fset_kml-&gt;fd_recno to %d, offset  %Ld&bslash;n&quot;
comma
id|recno
comma
id|tail_offset
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|presto_log_open
r_static
r_struct
id|file
op_star
id|presto_log_open
c_func
(paren
r_struct
id|presto_file_set
op_star
id|fset
comma
r_char
op_star
id|name
comma
r_int
id|flags
)paren
(brace
r_struct
id|presto_cache
op_star
id|cache
op_assign
id|fset-&gt;fset_cache
suffix:semicolon
r_struct
id|file
op_star
id|f
suffix:semicolon
r_int
id|error
suffix:semicolon
r_int
id|mtpt_len
comma
id|path_len
suffix:semicolon
r_char
op_star
id|path
suffix:semicolon
id|ENTRY
suffix:semicolon
id|mtpt_len
op_assign
id|strlen
c_func
(paren
id|cache-&gt;cache_mtpt
)paren
suffix:semicolon
id|path_len
op_assign
id|mtpt_len
op_plus
id|strlen
c_func
(paren
l_string|&quot;/.intermezzo/&quot;
)paren
op_plus
id|strlen
c_func
(paren
id|fset-&gt;fset_name
)paren
op_plus
id|strlen
c_func
(paren
id|name
)paren
suffix:semicolon
id|error
op_assign
op_minus
id|ENOMEM
suffix:semicolon
id|PRESTO_ALLOC
c_func
(paren
id|path
comma
r_char
op_star
comma
id|path_len
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|path
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|ERR_PTR
c_func
(paren
op_minus
id|ENOMEM
)paren
suffix:semicolon
)brace
id|sprintf
c_func
(paren
id|path
comma
l_string|&quot;%s/.intermezzo/%s/%s&quot;
comma
id|cache-&gt;cache_mtpt
comma
id|fset-&gt;fset_name
comma
id|name
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_INODE
comma
l_string|&quot;opening file %s&bslash;n&quot;
comma
id|path
)paren
suffix:semicolon
id|f
op_assign
id|filp_open
c_func
(paren
id|path
comma
id|flags
comma
l_int|0
)paren
suffix:semicolon
id|error
op_assign
id|PTR_ERR
c_func
(paren
id|f
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|f
)paren
)paren
(brace
id|CDEBUG
c_func
(paren
id|D_INODE
comma
l_string|&quot;Error %d&bslash;n&quot;
comma
id|error
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_goto
id|out_free
suffix:semicolon
)brace
id|error
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|cache
op_ne
id|presto_get_cache
c_func
(paren
id|f-&gt;f_dentry-&gt;d_inode
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;PRESTO: %s cache does not match fset cache!&bslash;n&quot;
comma
id|name
)paren
suffix:semicolon
id|fset-&gt;fset_kml.fd_file
op_assign
l_int|NULL
suffix:semicolon
id|filp_close
c_func
(paren
id|f
comma
l_int|NULL
)paren
suffix:semicolon
r_goto
id|out_free
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cache-&gt;cache_filter
op_logical_and
id|cache-&gt;cache_filter-&gt;o_trops
op_logical_and
id|cache-&gt;cache_filter-&gt;o_trops-&gt;tr_journal_data
)paren
(brace
id|CDEBUG
c_func
(paren
id|D_INODE
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|cache-&gt;cache_filter-&gt;o_trops-&gt;tr_journal_data
(paren
id|f-&gt;f_dentry-&gt;d_inode
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;WARNING: InterMezzo no file data logging!&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|out_free
suffix:colon
id|PRESTO_FREE
c_func
(paren
id|path
comma
id|path_len
op_plus
l_int|1
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|f
suffix:semicolon
)brace
DECL|function|presto_init_kml_file
r_int
id|presto_init_kml_file
c_func
(paren
r_struct
id|presto_file_set
op_star
id|fset
)paren
(brace
r_int
id|error
op_assign
l_int|0
suffix:semicolon
r_struct
id|file
op_star
id|f
suffix:semicolon
id|ENTRY
suffix:semicolon
r_if
c_cond
(paren
id|fset-&gt;fset_kml.fd_file
)paren
(brace
id|CDEBUG
c_func
(paren
id|D_INODE
comma
l_string|&quot;fset already has KML open&bslash;n&quot;
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|fset-&gt;fset_kml.fd_lock
op_assign
id|RW_LOCK_UNLOCKED
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|fset-&gt;fset_kml.fd_reservations
)paren
suffix:semicolon
id|f
op_assign
id|presto_log_open
c_func
(paren
id|fset
comma
l_string|&quot;kml&quot;
comma
id|O_RDWR
op_or
id|O_CREAT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|f
)paren
)paren
(brace
id|error
op_assign
id|PTR_ERR
c_func
(paren
id|f
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|fset-&gt;fset_kml.fd_file
op_assign
id|f
suffix:semicolon
id|error
op_assign
id|presto_kml_last_recno
c_func
(paren
id|fset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
id|fset-&gt;fset_kml.fd_file
op_assign
l_int|NULL
suffix:semicolon
id|filp_close
c_func
(paren
id|f
comma
l_int|NULL
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;presto: IO error in KML of fset %s&bslash;n&quot;
comma
id|fset-&gt;fset_name
)paren
suffix:semicolon
)brace
id|fset-&gt;fset_lento_off
op_assign
id|fset-&gt;fset_kml.fd_offset
suffix:semicolon
id|fset-&gt;fset_lento_recno
op_assign
id|fset-&gt;fset_kml.fd_recno
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|function|presto_init_last_rcvd_file
r_int
id|presto_init_last_rcvd_file
c_func
(paren
r_struct
id|presto_file_set
op_star
id|fset
)paren
(brace
r_int
id|error
op_assign
l_int|0
suffix:semicolon
r_struct
id|file
op_star
id|f
suffix:semicolon
id|ENTRY
suffix:semicolon
r_if
c_cond
(paren
id|fset-&gt;fset_last_rcvd
)paren
(brace
id|CDEBUG
c_func
(paren
id|D_INODE
comma
l_string|&quot;fset already has last_rcvd open&bslash;n&quot;
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|f
op_assign
id|presto_log_open
c_func
(paren
id|fset
comma
l_string|&quot;last_rcvd&quot;
comma
id|O_RDWR
op_or
id|O_CREAT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|f
)paren
)paren
(brace
id|error
op_assign
id|PTR_ERR
c_func
(paren
id|f
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|fset-&gt;fset_last_rcvd
op_assign
id|f
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|function|presto_init_lml_file
r_int
id|presto_init_lml_file
c_func
(paren
r_struct
id|presto_file_set
op_star
id|fset
)paren
(brace
r_int
id|error
op_assign
l_int|0
suffix:semicolon
r_struct
id|file
op_star
id|f
suffix:semicolon
id|ENTRY
suffix:semicolon
r_if
c_cond
(paren
id|fset-&gt;fset_lml.fd_file
)paren
(brace
id|CDEBUG
c_func
(paren
id|D_INODE
comma
l_string|&quot;fset already has lml open&bslash;n&quot;
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|fset-&gt;fset_lml.fd_lock
op_assign
id|RW_LOCK_UNLOCKED
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|fset-&gt;fset_lml.fd_reservations
)paren
suffix:semicolon
id|f
op_assign
id|presto_log_open
c_func
(paren
id|fset
comma
l_string|&quot;lml&quot;
comma
id|O_RDWR
op_or
id|O_CREAT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|f
)paren
)paren
(brace
id|error
op_assign
id|PTR_ERR
c_func
(paren
id|f
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|fset-&gt;fset_lml.fd_file
op_assign
id|f
suffix:semicolon
id|fset-&gt;fset_lml.fd_offset
op_assign
id|fset-&gt;fset_lml.fd_file-&gt;f_dentry-&gt;d_inode-&gt;i_size
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
multiline_comment|/* Write the last_rcvd values to the last)_rcvd file */
DECL|function|presto_write_last_rcvd
r_int
id|presto_write_last_rcvd
c_func
(paren
r_struct
id|rec_info
op_star
id|recinfo
comma
r_struct
id|presto_file_set
op_star
id|fset
comma
r_struct
id|lento_vfs_context
op_star
id|info
)paren
(brace
r_int
id|ret
suffix:semicolon
id|loff_t
id|off
op_assign
id|info-&gt;slot_offset
suffix:semicolon
r_struct
(brace
id|__u32
id|remote_recno
suffix:semicolon
id|__u64
id|remote_offset
suffix:semicolon
id|__u32
id|local_recno
suffix:semicolon
id|__u64
id|local_offset
suffix:semicolon
)brace
id|rcvd_rec
suffix:semicolon
id|rcvd_rec.remote_recno
op_assign
id|cpu_to_le32
c_func
(paren
id|info-&gt;recno
)paren
suffix:semicolon
id|rcvd_rec.remote_offset
op_assign
id|cpu_to_le64
c_func
(paren
id|info-&gt;kml_offset
)paren
suffix:semicolon
id|rcvd_rec.local_recno
op_assign
id|cpu_to_le32
c_func
(paren
id|recinfo-&gt;recno
)paren
suffix:semicolon
id|rcvd_rec.local_offset
op_assign
id|cpu_to_le64
c_func
(paren
id|recinfo-&gt;offset
op_plus
id|recinfo-&gt;size
)paren
suffix:semicolon
id|ret
op_assign
id|presto_fwrite
c_func
(paren
id|fset-&gt;fset_last_rcvd
comma
(paren
r_char
op_star
)paren
(paren
op_amp
id|rcvd_rec
)paren
comma
r_sizeof
(paren
id|rcvd_rec
)paren
comma
op_amp
id|off
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
r_sizeof
(paren
id|rcvd_rec
)paren
)paren
id|ret
op_assign
l_int|0
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* LML records here */
multiline_comment|/* this writes the LML records for close, in conjunction with the KML  */
DECL|function|presto_write_lml_close
r_int
id|presto_write_lml_close
c_func
(paren
r_struct
id|rec_info
op_star
id|rec
comma
r_struct
id|presto_file_set
op_star
id|fset
comma
r_struct
id|file
op_star
id|file
comma
id|__u64
id|remote_ino
comma
id|__u32
id|remote_generation
comma
id|__u32
id|remote_version
comma
r_struct
id|presto_version
op_star
id|new_file_ver
)paren
(brace
r_int
id|opcode
op_assign
id|PRESTO_OP_CLOSE
suffix:semicolon
r_char
op_star
id|buffer
suffix:semicolon
r_struct
id|dentry
op_star
id|dentry
op_assign
id|file-&gt;f_dentry
suffix:semicolon
id|__u64
id|ino
suffix:semicolon
id|__u32
id|pathlen
suffix:semicolon
r_char
op_star
id|path
suffix:semicolon
id|__u32
id|generation
suffix:semicolon
r_int
id|size
suffix:semicolon
r_char
op_star
id|logrecord
suffix:semicolon
r_char
id|record
(braket
l_int|292
)braket
suffix:semicolon
r_struct
id|dentry
op_star
id|root
suffix:semicolon
r_int
id|error
suffix:semicolon
id|ENTRY
suffix:semicolon
r_if
c_cond
(paren
id|presto_no_journal
c_func
(paren
id|fset
)paren
)paren
(brace
id|EXIT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|root
op_assign
id|fset-&gt;fset_mtpt
suffix:semicolon
id|BUFF_ALLOC
c_func
(paren
id|buffer
comma
l_int|NULL
)paren
suffix:semicolon
id|path
op_assign
id|presto_path
c_func
(paren
id|dentry
comma
id|root
comma
id|buffer
comma
id|PAGE_SIZE
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_INODE
comma
l_string|&quot;Path: %s&bslash;n&quot;
comma
id|path
)paren
suffix:semicolon
id|pathlen
op_assign
id|cpu_to_le32
c_func
(paren
id|MYPATHLEN
c_func
(paren
id|buffer
comma
id|path
)paren
)paren
suffix:semicolon
id|ino
op_assign
id|cpu_to_le64
c_func
(paren
id|dentry-&gt;d_inode-&gt;i_ino
)paren
suffix:semicolon
id|generation
op_assign
id|cpu_to_le32
c_func
(paren
id|dentry-&gt;d_inode-&gt;i_generation
)paren
suffix:semicolon
id|size
op_assign
r_sizeof
(paren
id|__u32
)paren
op_star
id|current-&gt;ngroups
op_plus
r_sizeof
(paren
r_struct
id|journal_prefix
)paren
op_plus
r_sizeof
(paren
op_star
id|new_file_ver
)paren
op_plus
r_sizeof
(paren
id|ino
)paren
op_plus
r_sizeof
(paren
id|generation
)paren
op_plus
r_sizeof
(paren
id|pathlen
)paren
op_plus
r_sizeof
(paren
id|remote_ino
)paren
op_plus
r_sizeof
(paren
id|remote_generation
)paren
op_plus
r_sizeof
(paren
id|remote_version
)paren
op_plus
r_sizeof
(paren
id|rec-&gt;offset
)paren
op_plus
r_sizeof
(paren
r_struct
id|journal_suffix
)paren
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
r_sizeof
(paren
id|record
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;PRESTO: BUFFER OVERFLOW in %s!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
)brace
id|rec-&gt;is_kml
op_assign
l_int|0
suffix:semicolon
id|rec-&gt;size
op_assign
id|size
op_plus
id|size_round
c_func
(paren
id|le32_to_cpu
c_func
(paren
id|pathlen
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|journal_log_prefix
c_func
(paren
id|record
comma
id|opcode
comma
id|rec
)paren
suffix:semicolon
id|logrecord
op_assign
id|logit
c_func
(paren
id|logrecord
comma
id|new_file_ver
comma
r_sizeof
(paren
op_star
id|new_file_ver
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|logit
c_func
(paren
id|logrecord
comma
op_amp
id|ino
comma
r_sizeof
(paren
id|ino
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|logit
c_func
(paren
id|logrecord
comma
op_amp
id|generation
comma
r_sizeof
(paren
id|generation
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|logit
c_func
(paren
id|logrecord
comma
op_amp
id|pathlen
comma
r_sizeof
(paren
id|pathlen
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|logit
c_func
(paren
id|logrecord
comma
op_amp
id|remote_ino
comma
r_sizeof
(paren
id|remote_ino
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|logit
c_func
(paren
id|logrecord
comma
op_amp
id|remote_generation
comma
r_sizeof
(paren
id|remote_generation
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|logit
c_func
(paren
id|logrecord
comma
op_amp
id|remote_version
comma
r_sizeof
(paren
id|remote_version
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|logit
c_func
(paren
id|logrecord
comma
op_amp
id|rec-&gt;offset
comma
r_sizeof
(paren
id|rec-&gt;offset
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|journal_log_suffix
c_func
(paren
id|logrecord
comma
id|record
comma
id|fset
comma
id|dentry
comma
id|rec
)paren
suffix:semicolon
id|error
op_assign
id|presto_log
c_func
(paren
id|fset
comma
id|rec
comma
id|record
comma
id|size
comma
id|path
comma
id|size_round
c_func
(paren
id|le32_to_cpu
c_func
(paren
id|pathlen
)paren
)paren
comma
l_int|NULL
comma
l_int|0
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
id|BUFF_FREE
c_func
(paren
id|buffer
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|function|presto_journal_write
r_int
id|presto_journal_write
c_func
(paren
r_struct
id|rec_info
op_star
id|rec
comma
r_struct
id|presto_file_set
op_star
id|fset
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|presto_version
id|file_version
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|ENTRY
suffix:semicolon
id|presto_getversion
c_func
(paren
op_amp
id|file_version
comma
id|file-&gt;f_dentry-&gt;d_inode
)paren
suffix:semicolon
multiline_comment|/* append this record */
id|rc
op_assign
id|presto_write_lml_close
(paren
id|rec
comma
id|fset
comma
id|file
comma
l_int|0
comma
multiline_comment|/* remote_ino */
l_int|0
comma
multiline_comment|/* remote_generation */
l_int|0
comma
multiline_comment|/* remote_version */
op_amp
id|file_version
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/* &n; * Check if the given record is at the end of the file. If it is, truncate&n; * the lml to the record&squot;s offset, removing it. Repeat on prior record,&n; * until we reach an active record or a reserved record (as defined by the&n; * reservations list).&n; */
DECL|function|presto_truncate_lml_tail
r_static
r_int
id|presto_truncate_lml_tail
c_func
(paren
r_struct
id|presto_file_set
op_star
id|fset
)paren
(brace
id|loff_t
id|lml_tail
suffix:semicolon
id|loff_t
id|lml_last_rec
suffix:semicolon
id|loff_t
id|lml_last_recsize
suffix:semicolon
id|loff_t
id|local_offset
suffix:semicolon
r_int
id|recno
suffix:semicolon
r_struct
id|journal_prefix
id|prefix
suffix:semicolon
r_struct
id|inode
op_star
id|inode
op_assign
id|fset-&gt;fset_lml.fd_file-&gt;f_dentry-&gt;d_inode
suffix:semicolon
r_void
op_star
id|handle
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|ENTRY
suffix:semicolon
multiline_comment|/* If someone else is already truncating the LML, return. */
id|write_lock
c_func
(paren
op_amp
id|fset-&gt;fset_lml.fd_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fset-&gt;fset_lml.fd_truncating
op_eq
l_int|1
)paren
(brace
id|write_unlock
c_func
(paren
op_amp
id|fset-&gt;fset_lml.fd_lock
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* someone is about to write to the end of the LML */
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|fset-&gt;fset_lml.fd_reservations
)paren
)paren
(brace
id|write_unlock
c_func
(paren
op_amp
id|fset-&gt;fset_lml.fd_lock
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|lml_tail
op_assign
id|fset-&gt;fset_lml.fd_file-&gt;f_dentry-&gt;d_inode-&gt;i_size
suffix:semicolon
multiline_comment|/* Nothing to truncate?*/
r_if
c_cond
(paren
id|lml_tail
op_eq
l_int|0
)paren
(brace
id|write_unlock
c_func
(paren
op_amp
id|fset-&gt;fset_lml.fd_lock
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|fset-&gt;fset_lml.fd_truncating
op_assign
l_int|1
suffix:semicolon
id|write_unlock
c_func
(paren
op_amp
id|fset-&gt;fset_lml.fd_lock
)paren
suffix:semicolon
id|presto_last_record
c_func
(paren
op_amp
id|fset-&gt;fset_lml
comma
op_amp
id|lml_last_recsize
comma
op_amp
id|lml_last_rec
comma
op_amp
id|recno
comma
id|lml_tail
)paren
suffix:semicolon
multiline_comment|/* Do we have a record to check? If not we have zeroes at the&n;          beginning of the file. -SHP&n;       */
r_if
c_cond
(paren
id|lml_last_recsize
op_ne
l_int|0
)paren
(brace
id|local_offset
op_assign
id|lml_last_rec
op_minus
id|lml_last_recsize
suffix:semicolon
id|rc
op_assign
id|presto_fread
c_func
(paren
id|fset-&gt;fset_lml.fd_file
comma
(paren
r_char
op_star
)paren
op_amp
id|prefix
comma
r_sizeof
(paren
id|prefix
)paren
comma
op_amp
id|local_offset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ne
r_sizeof
(paren
id|prefix
)paren
)paren
(brace
id|EXIT
suffix:semicolon
r_goto
id|tr_out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|prefix.opcode
op_ne
id|PRESTO_OP_NOOP
)paren
(brace
id|EXIT
suffix:semicolon
id|rc
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* We may have zeroes at the end of the file, should&n;&t;&t;&t;   we clear them out? -SHP&n;                        */
r_goto
id|tr_out
suffix:semicolon
)brace
)brace
r_else
id|lml_last_rec
op_assign
l_int|0
suffix:semicolon
id|handle
op_assign
id|presto_trans_start
c_func
(paren
id|fset
comma
id|inode
comma
id|PRESTO_OP_TRUNC
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|handle
)paren
(brace
id|EXIT
suffix:semicolon
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|tr_out
suffix:semicolon
)brace
id|rc
op_assign
id|presto_do_truncate
c_func
(paren
id|fset
comma
id|fset-&gt;fset_lml.fd_file-&gt;f_dentry
comma
id|lml_last_rec
op_minus
id|lml_last_recsize
comma
id|lml_tail
)paren
suffix:semicolon
id|presto_trans_commit
c_func
(paren
id|fset
comma
id|handle
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
)paren
(brace
id|rc
op_assign
l_int|1
suffix:semicolon
)brace
id|EXIT
suffix:semicolon
id|tr_out
suffix:colon
id|CDEBUG
c_func
(paren
id|D_JOURNAL
comma
l_string|&quot;rc = %d&bslash;n&quot;
comma
id|rc
)paren
suffix:semicolon
id|write_lock
c_func
(paren
op_amp
id|fset-&gt;fset_lml.fd_lock
)paren
suffix:semicolon
id|fset-&gt;fset_lml.fd_truncating
op_assign
l_int|0
suffix:semicolon
id|write_unlock
c_func
(paren
op_amp
id|fset-&gt;fset_lml.fd_lock
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|presto_truncate_lml
r_int
id|presto_truncate_lml
c_func
(paren
r_struct
id|presto_file_set
op_star
id|fset
)paren
(brace
r_int
id|rc
suffix:semicolon
id|ENTRY
suffix:semicolon
r_while
c_loop
(paren
(paren
id|rc
op_assign
id|presto_truncate_lml_tail
c_func
(paren
id|fset
)paren
)paren
OG
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
op_logical_and
id|rc
op_ne
op_minus
id|EALREADY
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;truncate_lml error %d&bslash;n&quot;
comma
id|rc
)paren
suffix:semicolon
)brace
id|EXIT
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|presto_clear_lml_close
r_int
id|presto_clear_lml_close
c_func
(paren
r_struct
id|presto_file_set
op_star
id|fset
comma
id|loff_t
id|lml_offset
)paren
(brace
r_int
id|rc
suffix:semicolon
r_struct
id|journal_prefix
id|record
suffix:semicolon
id|loff_t
id|offset
op_assign
id|lml_offset
suffix:semicolon
id|ENTRY
suffix:semicolon
r_if
c_cond
(paren
id|presto_no_journal
c_func
(paren
id|fset
)paren
)paren
(brace
id|EXIT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|CDEBUG
c_func
(paren
id|D_JOURNAL
comma
l_string|&quot;reading prefix: off %ld, size %Zd&bslash;n&quot;
comma
(paren
r_int
)paren
id|lml_offset
comma
r_sizeof
(paren
id|record
)paren
)paren
suffix:semicolon
id|rc
op_assign
id|presto_fread
c_func
(paren
id|fset-&gt;fset_lml.fd_file
comma
(paren
r_char
op_star
)paren
op_amp
id|record
comma
r_sizeof
(paren
id|record
)paren
comma
op_amp
id|offset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ne
r_sizeof
(paren
id|record
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;presto: clear_lml io error %d&bslash;n&quot;
comma
id|rc
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
multiline_comment|/* overwrite the prefix */
id|CDEBUG
c_func
(paren
id|D_JOURNAL
comma
l_string|&quot;overwriting prefix: off %ld&bslash;n&quot;
comma
(paren
r_int
)paren
id|lml_offset
)paren
suffix:semicolon
id|record.opcode
op_assign
id|PRESTO_OP_NOOP
suffix:semicolon
id|offset
op_assign
id|lml_offset
suffix:semicolon
multiline_comment|/* note: this does just a single transaction in the cache */
id|rc
op_assign
id|presto_fwrite
c_func
(paren
id|fset-&gt;fset_lml.fd_file
comma
(paren
r_char
op_star
)paren
(paren
op_amp
id|record
)paren
comma
r_sizeof
(paren
id|record
)paren
comma
op_amp
id|offset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ne
r_sizeof
(paren
id|record
)paren
)paren
(brace
id|EXIT
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|EXIT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* now a journal function for every operation */
DECL|function|presto_journal_setattr
r_int
id|presto_journal_setattr
c_func
(paren
r_struct
id|rec_info
op_star
id|rec
comma
r_struct
id|presto_file_set
op_star
id|fset
comma
r_struct
id|dentry
op_star
id|dentry
comma
r_struct
id|presto_version
op_star
id|old_ver
comma
r_struct
id|iattr
op_star
id|iattr
)paren
(brace
r_int
id|opcode
op_assign
id|PRESTO_OP_SETATTR
suffix:semicolon
r_char
op_star
id|buffer
suffix:semicolon
r_char
op_star
id|path
suffix:semicolon
id|__u32
id|pathlen
suffix:semicolon
r_int
id|size
suffix:semicolon
r_char
op_star
id|logrecord
suffix:semicolon
r_char
id|record
(braket
l_int|292
)braket
suffix:semicolon
r_struct
id|dentry
op_star
id|root
suffix:semicolon
id|__u32
id|uid
comma
id|gid
comma
id|mode
comma
id|valid
comma
id|flags
suffix:semicolon
id|__u64
id|fsize
comma
id|mtime
comma
id|ctime
suffix:semicolon
r_int
id|error
suffix:semicolon
id|ENTRY
suffix:semicolon
r_if
c_cond
(paren
id|presto_no_journal
c_func
(paren
id|fset
)paren
)paren
(brace
id|EXIT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|dentry-&gt;d_inode
op_logical_or
(paren
id|dentry-&gt;d_inode-&gt;i_nlink
op_eq
l_int|0
)paren
)paren
(brace
id|EXIT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|root
op_assign
id|fset-&gt;fset_mtpt
suffix:semicolon
id|BUFF_ALLOC
c_func
(paren
id|buffer
comma
l_int|NULL
)paren
suffix:semicolon
id|path
op_assign
id|presto_path
c_func
(paren
id|dentry
comma
id|root
comma
id|buffer
comma
id|PAGE_SIZE
)paren
suffix:semicolon
id|pathlen
op_assign
id|cpu_to_le32
c_func
(paren
id|MYPATHLEN
c_func
(paren
id|buffer
comma
id|path
)paren
)paren
suffix:semicolon
id|size
op_assign
r_sizeof
(paren
id|__u32
)paren
op_star
id|current-&gt;ngroups
op_plus
r_sizeof
(paren
r_struct
id|journal_prefix
)paren
op_plus
r_sizeof
(paren
op_star
id|old_ver
)paren
op_plus
r_sizeof
(paren
id|valid
)paren
op_plus
r_sizeof
(paren
id|mode
)paren
op_plus
r_sizeof
(paren
id|uid
)paren
op_plus
r_sizeof
(paren
id|gid
)paren
op_plus
r_sizeof
(paren
id|fsize
)paren
op_plus
r_sizeof
(paren
id|mtime
)paren
op_plus
r_sizeof
(paren
id|ctime
)paren
op_plus
r_sizeof
(paren
id|flags
)paren
op_plus
r_sizeof
(paren
id|pathlen
)paren
op_plus
r_sizeof
(paren
r_struct
id|journal_suffix
)paren
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
r_sizeof
(paren
id|record
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;PRESTO: BUFFER OVERFLOW in %s!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
)brace
multiline_comment|/* Only journal one kind of mtime, and not atime at all.  Also don&squot;t&n;         * journal bogus data in iattr, to make the journal more compressible.&n;         */
r_if
c_cond
(paren
id|iattr-&gt;ia_valid
op_amp
id|ATTR_MTIME_SET
)paren
id|iattr-&gt;ia_valid
op_assign
id|iattr-&gt;ia_valid
op_or
id|ATTR_MTIME
suffix:semicolon
id|valid
op_assign
id|cpu_to_le32
c_func
(paren
id|iattr-&gt;ia_valid
op_amp
op_complement
(paren
id|ATTR_ATIME
op_or
id|ATTR_MTIME_SET
op_or
id|ATTR_ATIME_SET
)paren
)paren
suffix:semicolon
id|mode
op_assign
id|iattr-&gt;ia_valid
op_amp
id|ATTR_MODE
ques
c_cond
id|cpu_to_le32
c_func
(paren
id|iattr-&gt;ia_mode
)paren
suffix:colon
l_int|0
suffix:semicolon
id|uid
op_assign
id|iattr-&gt;ia_valid
op_amp
id|ATTR_UID
ques
c_cond
id|cpu_to_le32
c_func
(paren
id|iattr-&gt;ia_uid
)paren
suffix:colon
l_int|0
suffix:semicolon
id|gid
op_assign
id|iattr-&gt;ia_valid
op_amp
id|ATTR_GID
ques
c_cond
id|cpu_to_le32
c_func
(paren
id|iattr-&gt;ia_gid
)paren
suffix:colon
l_int|0
suffix:semicolon
id|fsize
op_assign
id|iattr-&gt;ia_valid
op_amp
id|ATTR_SIZE
ques
c_cond
id|cpu_to_le64
c_func
(paren
id|iattr-&gt;ia_size
)paren
suffix:colon
l_int|0
suffix:semicolon
id|mtime
op_assign
id|iattr-&gt;ia_valid
op_amp
id|ATTR_MTIME
ques
c_cond
id|cpu_to_le64
c_func
(paren
id|iattr-&gt;ia_mtime
)paren
suffix:colon
l_int|0
suffix:semicolon
id|ctime
op_assign
id|iattr-&gt;ia_valid
op_amp
id|ATTR_CTIME
ques
c_cond
id|cpu_to_le64
c_func
(paren
id|iattr-&gt;ia_ctime
)paren
suffix:colon
l_int|0
suffix:semicolon
id|flags
op_assign
id|iattr-&gt;ia_valid
op_amp
id|ATTR_ATTR_FLAG
ques
c_cond
id|cpu_to_le32
c_func
(paren
id|iattr-&gt;ia_attr_flags
)paren
suffix:colon
l_int|0
suffix:semicolon
id|rec-&gt;is_kml
op_assign
l_int|1
suffix:semicolon
id|rec-&gt;size
op_assign
id|size
op_plus
id|size_round
c_func
(paren
id|le32_to_cpu
c_func
(paren
id|pathlen
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|journal_log_prefix
c_func
(paren
id|record
comma
id|opcode
comma
id|rec
)paren
suffix:semicolon
id|logrecord
op_assign
id|logit
c_func
(paren
id|logrecord
comma
id|old_ver
comma
r_sizeof
(paren
op_star
id|old_ver
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|logit
c_func
(paren
id|logrecord
comma
op_amp
id|valid
comma
r_sizeof
(paren
id|valid
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|logit
c_func
(paren
id|logrecord
comma
op_amp
id|mode
comma
r_sizeof
(paren
id|mode
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|logit
c_func
(paren
id|logrecord
comma
op_amp
id|uid
comma
r_sizeof
(paren
id|uid
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|logit
c_func
(paren
id|logrecord
comma
op_amp
id|gid
comma
r_sizeof
(paren
id|gid
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|logit
c_func
(paren
id|logrecord
comma
op_amp
id|fsize
comma
r_sizeof
(paren
id|fsize
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|logit
c_func
(paren
id|logrecord
comma
op_amp
id|mtime
comma
r_sizeof
(paren
id|mtime
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|logit
c_func
(paren
id|logrecord
comma
op_amp
id|ctime
comma
r_sizeof
(paren
id|ctime
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|logit
c_func
(paren
id|logrecord
comma
op_amp
id|flags
comma
r_sizeof
(paren
id|flags
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|logit
c_func
(paren
id|logrecord
comma
op_amp
id|pathlen
comma
r_sizeof
(paren
id|pathlen
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|journal_log_suffix
c_func
(paren
id|logrecord
comma
id|record
comma
id|fset
comma
id|dentry
comma
id|rec
)paren
suffix:semicolon
id|error
op_assign
id|presto_log
c_func
(paren
id|fset
comma
id|rec
comma
id|record
comma
id|size
comma
id|path
comma
id|size_round
c_func
(paren
id|le32_to_cpu
c_func
(paren
id|pathlen
)paren
)paren
comma
l_int|NULL
comma
l_int|0
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
id|BUFF_FREE
c_func
(paren
id|buffer
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|function|presto_journal_create
r_int
id|presto_journal_create
c_func
(paren
r_struct
id|rec_info
op_star
id|rec
comma
r_struct
id|presto_file_set
op_star
id|fset
comma
r_struct
id|dentry
op_star
id|dentry
comma
r_struct
id|presto_version
op_star
id|tgt_dir_ver
comma
r_struct
id|presto_version
op_star
id|new_file_ver
comma
r_int
id|mode
)paren
(brace
r_int
id|opcode
op_assign
id|PRESTO_OP_CREATE
suffix:semicolon
r_char
op_star
id|buffer
suffix:semicolon
r_char
op_star
id|path
suffix:semicolon
id|__u32
id|pathlen
suffix:semicolon
r_int
id|size
suffix:semicolon
r_char
op_star
id|logrecord
suffix:semicolon
r_char
id|record
(braket
l_int|292
)braket
suffix:semicolon
r_struct
id|dentry
op_star
id|root
suffix:semicolon
id|__u32
id|uid
comma
id|gid
comma
id|lmode
suffix:semicolon
r_int
id|error
suffix:semicolon
id|ENTRY
suffix:semicolon
r_if
c_cond
(paren
id|presto_no_journal
c_func
(paren
id|fset
)paren
)paren
(brace
id|EXIT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|root
op_assign
id|fset-&gt;fset_mtpt
suffix:semicolon
id|uid
op_assign
id|cpu_to_le32
c_func
(paren
id|dentry-&gt;d_inode-&gt;i_uid
)paren
suffix:semicolon
id|gid
op_assign
id|cpu_to_le32
c_func
(paren
id|dentry-&gt;d_inode-&gt;i_gid
)paren
suffix:semicolon
id|lmode
op_assign
id|cpu_to_le32
c_func
(paren
id|mode
)paren
suffix:semicolon
id|BUFF_ALLOC
c_func
(paren
id|buffer
comma
l_int|NULL
)paren
suffix:semicolon
id|path
op_assign
id|presto_path
c_func
(paren
id|dentry
comma
id|root
comma
id|buffer
comma
id|PAGE_SIZE
)paren
suffix:semicolon
id|pathlen
op_assign
id|cpu_to_le32
c_func
(paren
id|MYPATHLEN
c_func
(paren
id|buffer
comma
id|path
)paren
)paren
suffix:semicolon
id|size
op_assign
r_sizeof
(paren
id|__u32
)paren
op_star
id|current-&gt;ngroups
op_plus
r_sizeof
(paren
r_struct
id|journal_prefix
)paren
op_plus
l_int|3
op_star
r_sizeof
(paren
op_star
id|tgt_dir_ver
)paren
op_plus
r_sizeof
(paren
id|lmode
)paren
op_plus
r_sizeof
(paren
id|uid
)paren
op_plus
r_sizeof
(paren
id|gid
)paren
op_plus
r_sizeof
(paren
id|pathlen
)paren
op_plus
r_sizeof
(paren
r_struct
id|journal_suffix
)paren
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
r_sizeof
(paren
id|record
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;PRESTO: BUFFER OVERFLOW in %s!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
)brace
id|rec-&gt;is_kml
op_assign
l_int|1
suffix:semicolon
id|rec-&gt;size
op_assign
id|size
op_plus
id|size_round
c_func
(paren
id|le32_to_cpu
c_func
(paren
id|pathlen
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|journal_log_prefix
c_func
(paren
id|record
comma
id|opcode
comma
id|rec
)paren
suffix:semicolon
id|logrecord
op_assign
id|logit
c_func
(paren
id|logrecord
comma
id|tgt_dir_ver
comma
r_sizeof
(paren
op_star
id|tgt_dir_ver
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|log_version
c_func
(paren
id|logrecord
comma
id|dentry-&gt;d_parent
)paren
suffix:semicolon
id|logrecord
op_assign
id|logit
c_func
(paren
id|logrecord
comma
id|new_file_ver
comma
r_sizeof
(paren
op_star
id|new_file_ver
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|logit
c_func
(paren
id|logrecord
comma
op_amp
id|lmode
comma
r_sizeof
(paren
id|lmode
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|logit
c_func
(paren
id|logrecord
comma
op_amp
id|uid
comma
r_sizeof
(paren
id|uid
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|logit
c_func
(paren
id|logrecord
comma
op_amp
id|gid
comma
r_sizeof
(paren
id|gid
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|logit
c_func
(paren
id|logrecord
comma
op_amp
id|pathlen
comma
r_sizeof
(paren
id|pathlen
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|journal_log_suffix
c_func
(paren
id|logrecord
comma
id|record
comma
id|fset
comma
id|dentry
comma
id|rec
)paren
suffix:semicolon
id|error
op_assign
id|presto_log
c_func
(paren
id|fset
comma
id|rec
comma
id|record
comma
id|size
comma
id|path
comma
id|size_round
c_func
(paren
id|le32_to_cpu
c_func
(paren
id|pathlen
)paren
)paren
comma
l_int|NULL
comma
l_int|0
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
id|BUFF_FREE
c_func
(paren
id|buffer
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|function|presto_journal_symlink
r_int
id|presto_journal_symlink
c_func
(paren
r_struct
id|rec_info
op_star
id|rec
comma
r_struct
id|presto_file_set
op_star
id|fset
comma
r_struct
id|dentry
op_star
id|dentry
comma
r_const
r_char
op_star
id|target
comma
r_struct
id|presto_version
op_star
id|tgt_dir_ver
comma
r_struct
id|presto_version
op_star
id|new_link_ver
)paren
(brace
r_int
id|opcode
op_assign
id|PRESTO_OP_SYMLINK
suffix:semicolon
r_char
op_star
id|buffer
suffix:semicolon
r_char
op_star
id|path
suffix:semicolon
id|__u32
id|pathlen
suffix:semicolon
r_int
id|size
suffix:semicolon
r_char
op_star
id|logrecord
suffix:semicolon
r_char
id|record
(braket
l_int|292
)braket
suffix:semicolon
id|__u32
id|targetlen
op_assign
id|cpu_to_le32
c_func
(paren
id|strlen
c_func
(paren
id|target
)paren
)paren
suffix:semicolon
r_struct
id|dentry
op_star
id|root
suffix:semicolon
id|__u32
id|uid
comma
id|gid
suffix:semicolon
r_int
id|error
suffix:semicolon
id|ENTRY
suffix:semicolon
r_if
c_cond
(paren
id|presto_no_journal
c_func
(paren
id|fset
)paren
)paren
(brace
id|EXIT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|root
op_assign
id|fset-&gt;fset_mtpt
suffix:semicolon
id|uid
op_assign
id|cpu_to_le32
c_func
(paren
id|dentry-&gt;d_inode-&gt;i_uid
)paren
suffix:semicolon
id|gid
op_assign
id|cpu_to_le32
c_func
(paren
id|dentry-&gt;d_inode-&gt;i_gid
)paren
suffix:semicolon
id|BUFF_ALLOC
c_func
(paren
id|buffer
comma
l_int|NULL
)paren
suffix:semicolon
id|path
op_assign
id|presto_path
c_func
(paren
id|dentry
comma
id|root
comma
id|buffer
comma
id|PAGE_SIZE
)paren
suffix:semicolon
id|pathlen
op_assign
id|cpu_to_le32
c_func
(paren
id|MYPATHLEN
c_func
(paren
id|buffer
comma
id|path
)paren
)paren
suffix:semicolon
id|size
op_assign
r_sizeof
(paren
id|__u32
)paren
op_star
id|current-&gt;ngroups
op_plus
r_sizeof
(paren
r_struct
id|journal_prefix
)paren
op_plus
l_int|3
op_star
r_sizeof
(paren
op_star
id|tgt_dir_ver
)paren
op_plus
r_sizeof
(paren
id|uid
)paren
op_plus
r_sizeof
(paren
id|gid
)paren
op_plus
r_sizeof
(paren
id|pathlen
)paren
op_plus
r_sizeof
(paren
id|targetlen
)paren
op_plus
r_sizeof
(paren
r_struct
id|journal_suffix
)paren
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
r_sizeof
(paren
id|record
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;PRESTO: BUFFER OVERFLOW in %s!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
)brace
id|rec-&gt;is_kml
op_assign
l_int|1
suffix:semicolon
id|rec-&gt;size
op_assign
id|size
op_plus
id|size_round
c_func
(paren
id|le32_to_cpu
c_func
(paren
id|pathlen
)paren
)paren
op_plus
id|size_round
c_func
(paren
id|le32_to_cpu
c_func
(paren
id|targetlen
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|journal_log_prefix
c_func
(paren
id|record
comma
id|opcode
comma
id|rec
)paren
suffix:semicolon
id|logrecord
op_assign
id|logit
c_func
(paren
id|logrecord
comma
id|tgt_dir_ver
comma
r_sizeof
(paren
op_star
id|tgt_dir_ver
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|log_version
c_func
(paren
id|logrecord
comma
id|dentry-&gt;d_parent
)paren
suffix:semicolon
id|logrecord
op_assign
id|logit
c_func
(paren
id|logrecord
comma
id|new_link_ver
comma
r_sizeof
(paren
op_star
id|new_link_ver
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|logit
c_func
(paren
id|logrecord
comma
op_amp
id|uid
comma
r_sizeof
(paren
id|uid
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|logit
c_func
(paren
id|logrecord
comma
op_amp
id|gid
comma
r_sizeof
(paren
id|gid
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|logit
c_func
(paren
id|logrecord
comma
op_amp
id|pathlen
comma
r_sizeof
(paren
id|pathlen
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|logit
c_func
(paren
id|logrecord
comma
op_amp
id|targetlen
comma
r_sizeof
(paren
id|targetlen
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|journal_log_suffix
c_func
(paren
id|logrecord
comma
id|record
comma
id|fset
comma
id|dentry
comma
id|rec
)paren
suffix:semicolon
id|error
op_assign
id|presto_log
c_func
(paren
id|fset
comma
id|rec
comma
id|record
comma
id|size
comma
id|path
comma
id|size_round
c_func
(paren
id|le32_to_cpu
c_func
(paren
id|pathlen
)paren
)paren
comma
id|target
comma
id|size_round
c_func
(paren
id|le32_to_cpu
c_func
(paren
id|targetlen
)paren
)paren
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
id|BUFF_FREE
c_func
(paren
id|buffer
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|function|presto_journal_mkdir
r_int
id|presto_journal_mkdir
c_func
(paren
r_struct
id|rec_info
op_star
id|rec
comma
r_struct
id|presto_file_set
op_star
id|fset
comma
r_struct
id|dentry
op_star
id|dentry
comma
r_struct
id|presto_version
op_star
id|tgt_dir_ver
comma
r_struct
id|presto_version
op_star
id|new_dir_ver
comma
r_int
id|mode
)paren
(brace
r_int
id|opcode
op_assign
id|PRESTO_OP_MKDIR
suffix:semicolon
r_char
op_star
id|buffer
suffix:semicolon
r_char
op_star
id|path
suffix:semicolon
id|__u32
id|pathlen
suffix:semicolon
r_int
id|size
suffix:semicolon
r_char
op_star
id|logrecord
suffix:semicolon
r_char
id|record
(braket
l_int|292
)braket
suffix:semicolon
r_struct
id|dentry
op_star
id|root
suffix:semicolon
id|__u32
id|uid
comma
id|gid
comma
id|lmode
suffix:semicolon
r_int
id|error
suffix:semicolon
id|ENTRY
suffix:semicolon
r_if
c_cond
(paren
id|presto_no_journal
c_func
(paren
id|fset
)paren
)paren
(brace
id|EXIT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|root
op_assign
id|fset-&gt;fset_mtpt
suffix:semicolon
id|uid
op_assign
id|cpu_to_le32
c_func
(paren
id|dentry-&gt;d_inode-&gt;i_uid
)paren
suffix:semicolon
id|gid
op_assign
id|cpu_to_le32
c_func
(paren
id|dentry-&gt;d_inode-&gt;i_gid
)paren
suffix:semicolon
id|lmode
op_assign
id|cpu_to_le32
c_func
(paren
id|mode
)paren
suffix:semicolon
id|BUFF_ALLOC
c_func
(paren
id|buffer
comma
l_int|NULL
)paren
suffix:semicolon
id|path
op_assign
id|presto_path
c_func
(paren
id|dentry
comma
id|root
comma
id|buffer
comma
id|PAGE_SIZE
)paren
suffix:semicolon
id|pathlen
op_assign
id|cpu_to_le32
c_func
(paren
id|MYPATHLEN
c_func
(paren
id|buffer
comma
id|path
)paren
)paren
suffix:semicolon
id|size
op_assign
r_sizeof
(paren
id|__u32
)paren
op_star
id|current-&gt;ngroups
op_plus
r_sizeof
(paren
r_struct
id|journal_prefix
)paren
op_plus
l_int|3
op_star
r_sizeof
(paren
op_star
id|tgt_dir_ver
)paren
op_plus
r_sizeof
(paren
id|lmode
)paren
op_plus
r_sizeof
(paren
id|uid
)paren
op_plus
r_sizeof
(paren
id|gid
)paren
op_plus
r_sizeof
(paren
id|pathlen
)paren
op_plus
r_sizeof
(paren
r_struct
id|journal_suffix
)paren
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
r_sizeof
(paren
id|record
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;PRESTO: BUFFER OVERFLOW in %s!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
)brace
id|rec-&gt;is_kml
op_assign
l_int|1
suffix:semicolon
id|rec-&gt;size
op_assign
id|size
op_plus
id|size_round
c_func
(paren
id|le32_to_cpu
c_func
(paren
id|pathlen
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|journal_log_prefix
c_func
(paren
id|record
comma
id|opcode
comma
id|rec
)paren
suffix:semicolon
id|logrecord
op_assign
id|logit
c_func
(paren
id|logrecord
comma
id|tgt_dir_ver
comma
r_sizeof
(paren
op_star
id|tgt_dir_ver
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|log_version
c_func
(paren
id|logrecord
comma
id|dentry-&gt;d_parent
)paren
suffix:semicolon
id|logrecord
op_assign
id|logit
c_func
(paren
id|logrecord
comma
id|new_dir_ver
comma
r_sizeof
(paren
op_star
id|new_dir_ver
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|logit
c_func
(paren
id|logrecord
comma
op_amp
id|lmode
comma
r_sizeof
(paren
id|lmode
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|logit
c_func
(paren
id|logrecord
comma
op_amp
id|uid
comma
r_sizeof
(paren
id|uid
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|logit
c_func
(paren
id|logrecord
comma
op_amp
id|gid
comma
r_sizeof
(paren
id|gid
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|logit
c_func
(paren
id|logrecord
comma
op_amp
id|pathlen
comma
r_sizeof
(paren
id|pathlen
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|journal_log_suffix
c_func
(paren
id|logrecord
comma
id|record
comma
id|fset
comma
id|dentry
comma
id|rec
)paren
suffix:semicolon
id|error
op_assign
id|presto_log
c_func
(paren
id|fset
comma
id|rec
comma
id|record
comma
id|size
comma
id|path
comma
id|size_round
c_func
(paren
id|le32_to_cpu
c_func
(paren
id|pathlen
)paren
)paren
comma
l_int|NULL
comma
l_int|0
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
id|BUFF_FREE
c_func
(paren
id|buffer
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
r_int
DECL|function|presto_journal_rmdir
id|presto_journal_rmdir
c_func
(paren
r_struct
id|rec_info
op_star
id|rec
comma
r_struct
id|presto_file_set
op_star
id|fset
comma
r_struct
id|dentry
op_star
id|dir
comma
r_struct
id|presto_version
op_star
id|tgt_dir_ver
comma
r_struct
id|presto_version
op_star
id|old_dir_ver
comma
r_int
id|len
comma
r_const
r_char
op_star
id|name
)paren
(brace
r_int
id|opcode
op_assign
id|PRESTO_OP_RMDIR
suffix:semicolon
r_char
op_star
id|buffer
suffix:semicolon
r_char
op_star
id|path
suffix:semicolon
id|__u32
id|pathlen
comma
id|llen
suffix:semicolon
r_int
id|size
suffix:semicolon
r_char
op_star
id|logrecord
suffix:semicolon
r_char
id|record
(braket
l_int|292
)braket
suffix:semicolon
r_struct
id|dentry
op_star
id|root
suffix:semicolon
r_int
id|error
suffix:semicolon
id|ENTRY
suffix:semicolon
r_if
c_cond
(paren
id|presto_no_journal
c_func
(paren
id|fset
)paren
)paren
(brace
id|EXIT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|root
op_assign
id|fset-&gt;fset_mtpt
suffix:semicolon
id|llen
op_assign
id|cpu_to_le32
c_func
(paren
id|len
)paren
suffix:semicolon
id|BUFF_ALLOC
c_func
(paren
id|buffer
comma
l_int|NULL
)paren
suffix:semicolon
id|path
op_assign
id|presto_path
c_func
(paren
id|dir
comma
id|root
comma
id|buffer
comma
id|PAGE_SIZE
)paren
suffix:semicolon
id|pathlen
op_assign
id|cpu_to_le32
c_func
(paren
id|MYPATHLEN
c_func
(paren
id|buffer
comma
id|path
)paren
)paren
suffix:semicolon
id|size
op_assign
r_sizeof
(paren
id|__u32
)paren
op_star
id|current-&gt;ngroups
op_plus
r_sizeof
(paren
r_struct
id|journal_prefix
)paren
op_plus
l_int|3
op_star
r_sizeof
(paren
op_star
id|tgt_dir_ver
)paren
op_plus
r_sizeof
(paren
id|pathlen
)paren
op_plus
r_sizeof
(paren
id|llen
)paren
op_plus
r_sizeof
(paren
r_struct
id|journal_suffix
)paren
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
r_sizeof
(paren
id|record
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;PRESTO: BUFFER OVERFLOW in %s!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
)brace
id|CDEBUG
c_func
(paren
id|D_JOURNAL
comma
l_string|&quot;path: %s (%d), name: %s (%d), size %d&bslash;n&quot;
comma
id|path
comma
id|pathlen
comma
id|name
comma
id|len
comma
id|size
)paren
suffix:semicolon
id|rec-&gt;is_kml
op_assign
l_int|1
suffix:semicolon
id|rec-&gt;size
op_assign
id|size
op_plus
id|size_round
c_func
(paren
id|le32_to_cpu
c_func
(paren
id|pathlen
)paren
)paren
op_plus
id|size_round
c_func
(paren
id|len
)paren
suffix:semicolon
id|logrecord
op_assign
id|journal_log_prefix
c_func
(paren
id|record
comma
id|opcode
comma
id|rec
)paren
suffix:semicolon
id|logrecord
op_assign
id|logit
c_func
(paren
id|logrecord
comma
id|tgt_dir_ver
comma
r_sizeof
(paren
op_star
id|tgt_dir_ver
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|log_version
c_func
(paren
id|logrecord
comma
id|dir
)paren
suffix:semicolon
id|logrecord
op_assign
id|logit
c_func
(paren
id|logrecord
comma
id|old_dir_ver
comma
r_sizeof
(paren
op_star
id|old_dir_ver
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|logit
c_func
(paren
id|logrecord
comma
op_amp
id|pathlen
comma
r_sizeof
(paren
id|pathlen
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|logit
c_func
(paren
id|logrecord
comma
op_amp
id|llen
comma
r_sizeof
(paren
id|llen
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|journal_log_suffix
c_func
(paren
id|logrecord
comma
id|record
comma
id|fset
comma
id|dir
comma
id|rec
)paren
suffix:semicolon
id|error
op_assign
id|presto_log
c_func
(paren
id|fset
comma
id|rec
comma
id|record
comma
id|size
comma
id|path
comma
id|size_round
c_func
(paren
id|le32_to_cpu
c_func
(paren
id|pathlen
)paren
)paren
comma
id|name
comma
id|size_round
c_func
(paren
id|len
)paren
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
id|BUFF_FREE
c_func
(paren
id|buffer
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
r_int
DECL|function|presto_journal_mknod
id|presto_journal_mknod
c_func
(paren
r_struct
id|rec_info
op_star
id|rec
comma
r_struct
id|presto_file_set
op_star
id|fset
comma
r_struct
id|dentry
op_star
id|dentry
comma
r_struct
id|presto_version
op_star
id|tgt_dir_ver
comma
r_struct
id|presto_version
op_star
id|new_node_ver
comma
r_int
id|mode
comma
r_int
id|dmajor
comma
r_int
id|dminor
)paren
(brace
r_int
id|opcode
op_assign
id|PRESTO_OP_MKNOD
suffix:semicolon
r_char
op_star
id|buffer
suffix:semicolon
r_char
op_star
id|path
suffix:semicolon
id|__u32
id|pathlen
suffix:semicolon
r_int
id|size
suffix:semicolon
r_char
op_star
id|logrecord
suffix:semicolon
r_char
id|record
(braket
l_int|292
)braket
suffix:semicolon
r_struct
id|dentry
op_star
id|root
suffix:semicolon
id|__u32
id|uid
comma
id|gid
comma
id|lmode
comma
id|lmajor
comma
id|lminor
suffix:semicolon
r_int
id|error
suffix:semicolon
id|ENTRY
suffix:semicolon
r_if
c_cond
(paren
id|presto_no_journal
c_func
(paren
id|fset
)paren
)paren
(brace
id|EXIT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|root
op_assign
id|fset-&gt;fset_mtpt
suffix:semicolon
id|uid
op_assign
id|cpu_to_le32
c_func
(paren
id|dentry-&gt;d_inode-&gt;i_uid
)paren
suffix:semicolon
id|gid
op_assign
id|cpu_to_le32
c_func
(paren
id|dentry-&gt;d_inode-&gt;i_gid
)paren
suffix:semicolon
id|lmode
op_assign
id|cpu_to_le32
c_func
(paren
id|mode
)paren
suffix:semicolon
id|lmajor
op_assign
id|cpu_to_le32
c_func
(paren
id|dmajor
)paren
suffix:semicolon
id|lminor
op_assign
id|cpu_to_le32
c_func
(paren
id|dminor
)paren
suffix:semicolon
id|BUFF_ALLOC
c_func
(paren
id|buffer
comma
l_int|NULL
)paren
suffix:semicolon
id|path
op_assign
id|presto_path
c_func
(paren
id|dentry
comma
id|root
comma
id|buffer
comma
id|PAGE_SIZE
)paren
suffix:semicolon
id|pathlen
op_assign
id|cpu_to_le32
c_func
(paren
id|MYPATHLEN
c_func
(paren
id|buffer
comma
id|path
)paren
)paren
suffix:semicolon
id|size
op_assign
r_sizeof
(paren
id|__u32
)paren
op_star
id|current-&gt;ngroups
op_plus
r_sizeof
(paren
r_struct
id|journal_prefix
)paren
op_plus
l_int|3
op_star
r_sizeof
(paren
op_star
id|tgt_dir_ver
)paren
op_plus
r_sizeof
(paren
id|lmode
)paren
op_plus
r_sizeof
(paren
id|uid
)paren
op_plus
r_sizeof
(paren
id|gid
)paren
op_plus
r_sizeof
(paren
id|lmajor
)paren
op_plus
r_sizeof
(paren
id|lminor
)paren
op_plus
r_sizeof
(paren
id|pathlen
)paren
op_plus
r_sizeof
(paren
r_struct
id|journal_suffix
)paren
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
r_sizeof
(paren
id|record
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;PRESTO: BUFFER OVERFLOW in %s!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
)brace
id|rec-&gt;is_kml
op_assign
l_int|1
suffix:semicolon
id|rec-&gt;size
op_assign
id|size
op_plus
id|size_round
c_func
(paren
id|le32_to_cpu
c_func
(paren
id|pathlen
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|journal_log_prefix
c_func
(paren
id|record
comma
id|opcode
comma
id|rec
)paren
suffix:semicolon
id|logrecord
op_assign
id|logit
c_func
(paren
id|logrecord
comma
id|tgt_dir_ver
comma
r_sizeof
(paren
op_star
id|tgt_dir_ver
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|log_version
c_func
(paren
id|logrecord
comma
id|dentry-&gt;d_parent
)paren
suffix:semicolon
id|logrecord
op_assign
id|logit
c_func
(paren
id|logrecord
comma
id|new_node_ver
comma
r_sizeof
(paren
op_star
id|new_node_ver
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|logit
c_func
(paren
id|logrecord
comma
op_amp
id|lmode
comma
r_sizeof
(paren
id|lmode
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|logit
c_func
(paren
id|logrecord
comma
op_amp
id|uid
comma
r_sizeof
(paren
id|uid
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|logit
c_func
(paren
id|logrecord
comma
op_amp
id|gid
comma
r_sizeof
(paren
id|gid
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|logit
c_func
(paren
id|logrecord
comma
op_amp
id|lmajor
comma
r_sizeof
(paren
id|lmajor
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|logit
c_func
(paren
id|logrecord
comma
op_amp
id|lminor
comma
r_sizeof
(paren
id|lminor
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|logit
c_func
(paren
id|logrecord
comma
op_amp
id|pathlen
comma
r_sizeof
(paren
id|pathlen
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|journal_log_suffix
c_func
(paren
id|logrecord
comma
id|record
comma
id|fset
comma
id|dentry
comma
id|rec
)paren
suffix:semicolon
id|error
op_assign
id|presto_log
c_func
(paren
id|fset
comma
id|rec
comma
id|record
comma
id|size
comma
id|path
comma
id|size_round
c_func
(paren
id|le32_to_cpu
c_func
(paren
id|pathlen
)paren
)paren
comma
l_int|NULL
comma
l_int|0
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
id|BUFF_FREE
c_func
(paren
id|buffer
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
r_int
DECL|function|presto_journal_link
id|presto_journal_link
c_func
(paren
r_struct
id|rec_info
op_star
id|rec
comma
r_struct
id|presto_file_set
op_star
id|fset
comma
r_struct
id|dentry
op_star
id|src
comma
r_struct
id|dentry
op_star
id|tgt
comma
r_struct
id|presto_version
op_star
id|tgt_dir_ver
comma
r_struct
id|presto_version
op_star
id|new_link_ver
)paren
(brace
r_int
id|opcode
op_assign
id|PRESTO_OP_LINK
suffix:semicolon
r_char
op_star
id|buffer
comma
op_star
id|srcbuffer
suffix:semicolon
r_char
op_star
id|path
comma
op_star
id|srcpath
suffix:semicolon
id|__u32
id|pathlen
comma
id|srcpathlen
suffix:semicolon
r_int
id|size
suffix:semicolon
r_char
op_star
id|logrecord
suffix:semicolon
r_char
id|record
(braket
l_int|292
)braket
suffix:semicolon
r_struct
id|dentry
op_star
id|root
suffix:semicolon
r_int
id|error
suffix:semicolon
id|ENTRY
suffix:semicolon
r_if
c_cond
(paren
id|presto_no_journal
c_func
(paren
id|fset
)paren
)paren
(brace
id|EXIT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|root
op_assign
id|fset-&gt;fset_mtpt
suffix:semicolon
id|BUFF_ALLOC
c_func
(paren
id|srcbuffer
comma
l_int|NULL
)paren
suffix:semicolon
id|srcpath
op_assign
id|presto_path
c_func
(paren
id|src
comma
id|root
comma
id|srcbuffer
comma
id|PAGE_SIZE
)paren
suffix:semicolon
id|srcpathlen
op_assign
id|cpu_to_le32
c_func
(paren
id|MYPATHLEN
c_func
(paren
id|srcbuffer
comma
id|srcpath
)paren
)paren
suffix:semicolon
id|BUFF_ALLOC
c_func
(paren
id|buffer
comma
id|srcbuffer
)paren
suffix:semicolon
id|path
op_assign
id|presto_path
c_func
(paren
id|tgt
comma
id|root
comma
id|buffer
comma
id|PAGE_SIZE
)paren
suffix:semicolon
id|pathlen
op_assign
id|cpu_to_le32
c_func
(paren
id|MYPATHLEN
c_func
(paren
id|buffer
comma
id|path
)paren
)paren
suffix:semicolon
id|size
op_assign
r_sizeof
(paren
id|__u32
)paren
op_star
id|current-&gt;ngroups
op_plus
r_sizeof
(paren
r_struct
id|journal_prefix
)paren
op_plus
l_int|3
op_star
r_sizeof
(paren
op_star
id|tgt_dir_ver
)paren
op_plus
r_sizeof
(paren
id|srcpathlen
)paren
op_plus
r_sizeof
(paren
id|pathlen
)paren
op_plus
r_sizeof
(paren
r_struct
id|journal_suffix
)paren
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
r_sizeof
(paren
id|record
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;PRESTO: BUFFER OVERFLOW in %s!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
)brace
id|rec-&gt;is_kml
op_assign
l_int|1
suffix:semicolon
id|rec-&gt;size
op_assign
id|size
op_plus
id|size_round
c_func
(paren
id|le32_to_cpu
c_func
(paren
id|pathlen
)paren
)paren
op_plus
id|size_round
c_func
(paren
id|le32_to_cpu
c_func
(paren
id|srcpathlen
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|journal_log_prefix
c_func
(paren
id|record
comma
id|opcode
comma
id|rec
)paren
suffix:semicolon
id|logrecord
op_assign
id|logit
c_func
(paren
id|logrecord
comma
id|tgt_dir_ver
comma
r_sizeof
(paren
op_star
id|tgt_dir_ver
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|log_version
c_func
(paren
id|logrecord
comma
id|tgt-&gt;d_parent
)paren
suffix:semicolon
id|logrecord
op_assign
id|logit
c_func
(paren
id|logrecord
comma
id|new_link_ver
comma
r_sizeof
(paren
op_star
id|new_link_ver
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|logit
c_func
(paren
id|logrecord
comma
op_amp
id|srcpathlen
comma
r_sizeof
(paren
id|srcpathlen
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|logit
c_func
(paren
id|logrecord
comma
op_amp
id|pathlen
comma
r_sizeof
(paren
id|pathlen
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|journal_log_suffix
c_func
(paren
id|logrecord
comma
id|record
comma
id|fset
comma
id|tgt
comma
id|rec
)paren
suffix:semicolon
id|error
op_assign
id|presto_log
c_func
(paren
id|fset
comma
id|rec
comma
id|record
comma
id|size
comma
id|srcpath
comma
id|size_round
c_func
(paren
id|le32_to_cpu
c_func
(paren
id|srcpathlen
)paren
)paren
comma
id|path
comma
id|size_round
c_func
(paren
id|le32_to_cpu
c_func
(paren
id|pathlen
)paren
)paren
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
id|BUFF_FREE
c_func
(paren
id|srcbuffer
)paren
suffix:semicolon
id|BUFF_FREE
c_func
(paren
id|buffer
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|function|presto_journal_rename
r_int
id|presto_journal_rename
c_func
(paren
r_struct
id|rec_info
op_star
id|rec
comma
r_struct
id|presto_file_set
op_star
id|fset
comma
r_struct
id|dentry
op_star
id|src
comma
r_struct
id|dentry
op_star
id|tgt
comma
r_struct
id|presto_version
op_star
id|src_dir_ver
comma
r_struct
id|presto_version
op_star
id|tgt_dir_ver
)paren
(brace
r_int
id|opcode
op_assign
id|PRESTO_OP_RENAME
suffix:semicolon
r_char
op_star
id|buffer
comma
op_star
id|srcbuffer
suffix:semicolon
r_char
op_star
id|path
comma
op_star
id|srcpath
suffix:semicolon
id|__u32
id|pathlen
comma
id|srcpathlen
suffix:semicolon
r_int
id|size
suffix:semicolon
r_char
op_star
id|logrecord
suffix:semicolon
r_char
id|record
(braket
l_int|292
)braket
suffix:semicolon
r_struct
id|dentry
op_star
id|root
suffix:semicolon
r_int
id|error
suffix:semicolon
id|ENTRY
suffix:semicolon
r_if
c_cond
(paren
id|presto_no_journal
c_func
(paren
id|fset
)paren
)paren
(brace
id|EXIT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|root
op_assign
id|fset-&gt;fset_mtpt
suffix:semicolon
id|BUFF_ALLOC
c_func
(paren
id|srcbuffer
comma
l_int|NULL
)paren
suffix:semicolon
id|srcpath
op_assign
id|presto_path
c_func
(paren
id|src
comma
id|root
comma
id|srcbuffer
comma
id|PAGE_SIZE
)paren
suffix:semicolon
id|srcpathlen
op_assign
id|cpu_to_le32
c_func
(paren
id|MYPATHLEN
c_func
(paren
id|srcbuffer
comma
id|srcpath
)paren
)paren
suffix:semicolon
id|BUFF_ALLOC
c_func
(paren
id|buffer
comma
id|srcbuffer
)paren
suffix:semicolon
id|path
op_assign
id|presto_path
c_func
(paren
id|tgt
comma
id|root
comma
id|buffer
comma
id|PAGE_SIZE
)paren
suffix:semicolon
id|pathlen
op_assign
id|cpu_to_le32
c_func
(paren
id|MYPATHLEN
c_func
(paren
id|buffer
comma
id|path
)paren
)paren
suffix:semicolon
id|size
op_assign
r_sizeof
(paren
id|__u32
)paren
op_star
id|current-&gt;ngroups
op_plus
r_sizeof
(paren
r_struct
id|journal_prefix
)paren
op_plus
l_int|4
op_star
r_sizeof
(paren
op_star
id|src_dir_ver
)paren
op_plus
r_sizeof
(paren
id|srcpathlen
)paren
op_plus
r_sizeof
(paren
id|pathlen
)paren
op_plus
r_sizeof
(paren
r_struct
id|journal_suffix
)paren
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
r_sizeof
(paren
id|record
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;PRESTO: BUFFER OVERFLOW in %s!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
)brace
id|rec-&gt;is_kml
op_assign
l_int|1
suffix:semicolon
id|rec-&gt;size
op_assign
id|size
op_plus
id|size_round
c_func
(paren
id|le32_to_cpu
c_func
(paren
id|pathlen
)paren
)paren
op_plus
id|size_round
c_func
(paren
id|le32_to_cpu
c_func
(paren
id|srcpathlen
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|journal_log_prefix
c_func
(paren
id|record
comma
id|opcode
comma
id|rec
)paren
suffix:semicolon
id|logrecord
op_assign
id|logit
c_func
(paren
id|logrecord
comma
id|src_dir_ver
comma
r_sizeof
(paren
op_star
id|src_dir_ver
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|log_version
c_func
(paren
id|logrecord
comma
id|src-&gt;d_parent
)paren
suffix:semicolon
id|logrecord
op_assign
id|logit
c_func
(paren
id|logrecord
comma
id|tgt_dir_ver
comma
r_sizeof
(paren
op_star
id|tgt_dir_ver
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|log_version
c_func
(paren
id|logrecord
comma
id|tgt-&gt;d_parent
)paren
suffix:semicolon
id|logrecord
op_assign
id|logit
c_func
(paren
id|logrecord
comma
op_amp
id|srcpathlen
comma
r_sizeof
(paren
id|srcpathlen
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|logit
c_func
(paren
id|logrecord
comma
op_amp
id|pathlen
comma
r_sizeof
(paren
id|pathlen
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|journal_log_suffix
c_func
(paren
id|logrecord
comma
id|record
comma
id|fset
comma
id|tgt
comma
id|rec
)paren
suffix:semicolon
id|error
op_assign
id|presto_log
c_func
(paren
id|fset
comma
id|rec
comma
id|record
comma
id|size
comma
id|srcpath
comma
id|size_round
c_func
(paren
id|le32_to_cpu
c_func
(paren
id|srcpathlen
)paren
)paren
comma
id|path
comma
id|size_round
c_func
(paren
id|le32_to_cpu
c_func
(paren
id|pathlen
)paren
)paren
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
id|BUFF_FREE
c_func
(paren
id|buffer
)paren
suffix:semicolon
id|BUFF_FREE
c_func
(paren
id|srcbuffer
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|function|presto_journal_unlink
r_int
id|presto_journal_unlink
c_func
(paren
r_struct
id|rec_info
op_star
id|rec
comma
r_struct
id|presto_file_set
op_star
id|fset
comma
r_struct
id|dentry
op_star
id|dir
comma
r_struct
id|presto_version
op_star
id|tgt_dir_ver
comma
r_struct
id|presto_version
op_star
id|old_file_ver
comma
r_int
id|len
comma
r_const
r_char
op_star
id|name
)paren
(brace
r_int
id|opcode
op_assign
id|PRESTO_OP_UNLINK
suffix:semicolon
r_char
op_star
id|buffer
suffix:semicolon
r_char
op_star
id|path
suffix:semicolon
id|__u32
id|pathlen
comma
id|llen
suffix:semicolon
r_int
id|size
suffix:semicolon
r_char
op_star
id|logrecord
suffix:semicolon
r_char
id|record
(braket
l_int|292
)braket
suffix:semicolon
r_struct
id|dentry
op_star
id|root
suffix:semicolon
r_int
id|error
suffix:semicolon
id|ENTRY
suffix:semicolon
r_if
c_cond
(paren
id|presto_no_journal
c_func
(paren
id|fset
)paren
)paren
(brace
id|EXIT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|root
op_assign
id|fset-&gt;fset_mtpt
suffix:semicolon
id|llen
op_assign
id|cpu_to_le32
c_func
(paren
id|len
)paren
suffix:semicolon
id|BUFF_ALLOC
c_func
(paren
id|buffer
comma
l_int|NULL
)paren
suffix:semicolon
id|path
op_assign
id|presto_path
c_func
(paren
id|dir
comma
id|root
comma
id|buffer
comma
id|PAGE_SIZE
)paren
suffix:semicolon
id|pathlen
op_assign
id|cpu_to_le32
c_func
(paren
id|MYPATHLEN
c_func
(paren
id|buffer
comma
id|path
)paren
)paren
suffix:semicolon
id|size
op_assign
r_sizeof
(paren
id|__u32
)paren
op_star
id|current-&gt;ngroups
op_plus
r_sizeof
(paren
r_struct
id|journal_prefix
)paren
op_plus
l_int|3
op_star
r_sizeof
(paren
op_star
id|tgt_dir_ver
)paren
op_plus
r_sizeof
(paren
id|pathlen
)paren
op_plus
r_sizeof
(paren
id|llen
)paren
op_plus
r_sizeof
(paren
r_struct
id|journal_suffix
)paren
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
r_sizeof
(paren
id|record
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;PRESTO: BUFFER OVERFLOW in %s!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
)brace
id|rec-&gt;is_kml
op_assign
l_int|1
suffix:semicolon
id|rec-&gt;size
op_assign
id|size
op_plus
id|size_round
c_func
(paren
id|le32_to_cpu
c_func
(paren
id|pathlen
)paren
)paren
op_plus
id|size_round
c_func
(paren
id|len
)paren
suffix:semicolon
id|logrecord
op_assign
id|journal_log_prefix
c_func
(paren
id|record
comma
id|opcode
comma
id|rec
)paren
suffix:semicolon
id|logrecord
op_assign
id|logit
c_func
(paren
id|logrecord
comma
id|tgt_dir_ver
comma
r_sizeof
(paren
op_star
id|tgt_dir_ver
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|log_version
c_func
(paren
id|logrecord
comma
id|dir
)paren
suffix:semicolon
id|logrecord
op_assign
id|logit
c_func
(paren
id|logrecord
comma
id|old_file_ver
comma
r_sizeof
(paren
op_star
id|old_file_ver
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|logit
c_func
(paren
id|logrecord
comma
op_amp
id|pathlen
comma
r_sizeof
(paren
id|pathlen
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|logit
c_func
(paren
id|logrecord
comma
op_amp
id|llen
comma
r_sizeof
(paren
id|llen
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|journal_log_suffix
c_func
(paren
id|logrecord
comma
id|record
comma
id|fset
comma
id|dir
comma
id|rec
)paren
suffix:semicolon
id|error
op_assign
id|presto_log
c_func
(paren
id|fset
comma
id|rec
comma
id|record
comma
id|size
comma
id|path
comma
id|size_round
c_func
(paren
id|le32_to_cpu
c_func
(paren
id|pathlen
)paren
)paren
comma
id|name
comma
id|size_round
c_func
(paren
id|len
)paren
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
id|BUFF_FREE
c_func
(paren
id|buffer
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
r_int
DECL|function|presto_journal_close
id|presto_journal_close
c_func
(paren
r_struct
id|rec_info
op_star
id|rec
comma
r_struct
id|presto_file_set
op_star
id|fset
comma
r_struct
id|file
op_star
id|file
comma
r_struct
id|dentry
op_star
id|dentry
comma
r_struct
id|presto_version
op_star
id|new_file_ver
)paren
(brace
r_int
id|opcode
op_assign
id|PRESTO_OP_CLOSE
suffix:semicolon
r_struct
id|presto_file_data
op_star
id|fd
suffix:semicolon
r_char
op_star
id|buffer
suffix:semicolon
r_char
op_star
id|path
suffix:semicolon
id|__u64
id|ino
suffix:semicolon
id|__u32
id|pathlen
suffix:semicolon
id|__u32
id|generation
suffix:semicolon
r_int
id|size
suffix:semicolon
r_char
op_star
id|logrecord
suffix:semicolon
r_char
id|record
(braket
l_int|292
)braket
suffix:semicolon
r_struct
id|dentry
op_star
id|root
suffix:semicolon
r_int
id|error
suffix:semicolon
id|__u32
id|open_fsuid
suffix:semicolon
id|__u32
id|open_fsgid
suffix:semicolon
id|__u32
id|open_ngroups
suffix:semicolon
id|__u32
id|open_groups
(braket
id|NGROUPS_MAX
)braket
suffix:semicolon
id|__u32
id|open_mode
suffix:semicolon
id|__u32
id|open_uid
suffix:semicolon
id|__u32
id|open_gid
suffix:semicolon
r_int
id|i
suffix:semicolon
id|ENTRY
suffix:semicolon
r_if
c_cond
(paren
id|presto_no_journal
c_func
(paren
id|fset
)paren
)paren
(brace
id|EXIT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|dentry-&gt;d_inode
op_logical_or
(paren
id|dentry-&gt;d_inode-&gt;i_nlink
op_eq
l_int|0
)paren
)paren
(brace
id|EXIT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|root
op_assign
id|fset-&gt;fset_mtpt
suffix:semicolon
id|fd
op_assign
(paren
r_struct
id|presto_file_data
op_star
)paren
id|file-&gt;private_data
suffix:semicolon
r_if
c_cond
(paren
id|fd
)paren
(brace
id|open_ngroups
op_assign
id|fd-&gt;fd_ngroups
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|fd-&gt;fd_ngroups
suffix:semicolon
id|i
op_increment
)paren
id|open_groups
(braket
id|i
)braket
op_assign
(paren
id|__u32
)paren
id|fd-&gt;fd_groups
(braket
id|i
)braket
suffix:semicolon
id|open_mode
op_assign
id|fd-&gt;fd_mode
suffix:semicolon
id|open_uid
op_assign
id|fd-&gt;fd_uid
suffix:semicolon
id|open_gid
op_assign
id|fd-&gt;fd_gid
suffix:semicolon
id|open_fsuid
op_assign
id|fd-&gt;fd_fsuid
suffix:semicolon
id|open_fsgid
op_assign
id|fd-&gt;fd_fsgid
suffix:semicolon
)brace
r_else
(brace
id|open_ngroups
op_assign
id|current-&gt;ngroups
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|current-&gt;ngroups
suffix:semicolon
id|i
op_increment
)paren
id|open_groups
(braket
id|i
)braket
op_assign
(paren
id|__u32
)paren
id|current-&gt;groups
(braket
id|i
)braket
suffix:semicolon
id|open_mode
op_assign
id|dentry-&gt;d_inode-&gt;i_mode
suffix:semicolon
id|open_uid
op_assign
id|dentry-&gt;d_inode-&gt;i_uid
suffix:semicolon
id|open_gid
op_assign
id|dentry-&gt;d_inode-&gt;i_gid
suffix:semicolon
id|open_fsuid
op_assign
id|current-&gt;fsuid
suffix:semicolon
id|open_fsgid
op_assign
id|current-&gt;fsgid
suffix:semicolon
)brace
id|BUFF_ALLOC
c_func
(paren
id|buffer
comma
l_int|NULL
)paren
suffix:semicolon
id|path
op_assign
id|presto_path
c_func
(paren
id|dentry
comma
id|root
comma
id|buffer
comma
id|PAGE_SIZE
)paren
suffix:semicolon
id|pathlen
op_assign
id|cpu_to_le32
c_func
(paren
id|MYPATHLEN
c_func
(paren
id|buffer
comma
id|path
)paren
)paren
suffix:semicolon
id|ino
op_assign
id|cpu_to_le64
c_func
(paren
id|dentry-&gt;d_inode-&gt;i_ino
)paren
suffix:semicolon
id|generation
op_assign
id|cpu_to_le32
c_func
(paren
id|dentry-&gt;d_inode-&gt;i_generation
)paren
suffix:semicolon
id|size
op_assign
r_sizeof
(paren
id|__u32
)paren
op_star
id|open_ngroups
op_plus
r_sizeof
(paren
id|open_mode
)paren
op_plus
r_sizeof
(paren
id|open_uid
)paren
op_plus
r_sizeof
(paren
id|open_gid
)paren
op_plus
r_sizeof
(paren
r_struct
id|journal_prefix
)paren
op_plus
r_sizeof
(paren
op_star
id|new_file_ver
)paren
op_plus
r_sizeof
(paren
id|ino
)paren
op_plus
r_sizeof
(paren
id|generation
)paren
op_plus
r_sizeof
(paren
id|pathlen
)paren
op_plus
r_sizeof
(paren
r_struct
id|journal_suffix
)paren
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
r_sizeof
(paren
id|record
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;PRESTO: BUFFER OVERFLOW in %s!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
)brace
id|rec-&gt;is_kml
op_assign
l_int|1
suffix:semicolon
id|rec-&gt;size
op_assign
id|size
op_plus
id|size_round
c_func
(paren
id|le32_to_cpu
c_func
(paren
id|pathlen
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|journal_log_prefix_with_groups_and_ids
c_func
(paren
id|record
comma
id|opcode
comma
id|rec
comma
id|open_ngroups
comma
id|open_groups
comma
id|open_fsuid
comma
id|open_fsgid
)paren
suffix:semicolon
id|logrecord
op_assign
id|logit
c_func
(paren
id|logrecord
comma
op_amp
id|open_mode
comma
r_sizeof
(paren
id|open_mode
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|logit
c_func
(paren
id|logrecord
comma
op_amp
id|open_uid
comma
r_sizeof
(paren
id|open_uid
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|logit
c_func
(paren
id|logrecord
comma
op_amp
id|open_gid
comma
r_sizeof
(paren
id|open_gid
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|logit
c_func
(paren
id|logrecord
comma
id|new_file_ver
comma
r_sizeof
(paren
op_star
id|new_file_ver
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|logit
c_func
(paren
id|logrecord
comma
op_amp
id|ino
comma
r_sizeof
(paren
id|ino
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|logit
c_func
(paren
id|logrecord
comma
op_amp
id|generation
comma
r_sizeof
(paren
id|generation
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|logit
c_func
(paren
id|logrecord
comma
op_amp
id|pathlen
comma
r_sizeof
(paren
id|pathlen
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|journal_log_suffix
c_func
(paren
id|logrecord
comma
id|record
comma
id|fset
comma
id|dentry
comma
id|rec
)paren
suffix:semicolon
id|error
op_assign
id|presto_log
c_func
(paren
id|fset
comma
id|rec
comma
id|record
comma
id|size
comma
id|path
comma
id|size_round
c_func
(paren
id|le32_to_cpu
c_func
(paren
id|pathlen
)paren
)paren
comma
l_int|NULL
comma
l_int|0
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
id|BUFF_FREE
c_func
(paren
id|buffer
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|function|presto_rewrite_close
r_int
id|presto_rewrite_close
c_func
(paren
r_struct
id|rec_info
op_star
id|rec
comma
r_struct
id|presto_file_set
op_star
id|fset
comma
r_char
op_star
id|path
comma
id|__u32
id|pathlen
comma
r_int
id|ngroups
comma
id|__u32
op_star
id|groups
comma
id|__u64
id|ino
comma
id|__u32
id|generation
comma
r_struct
id|presto_version
op_star
id|new_file_ver
)paren
(brace
r_int
id|opcode
op_assign
id|PRESTO_OP_CLOSE
suffix:semicolon
r_int
id|size
suffix:semicolon
r_char
op_star
id|logrecord
suffix:semicolon
r_char
id|record
(braket
l_int|292
)braket
suffix:semicolon
r_struct
id|dentry
op_star
id|root
suffix:semicolon
r_int
id|error
suffix:semicolon
id|ENTRY
suffix:semicolon
r_if
c_cond
(paren
id|presto_no_journal
c_func
(paren
id|fset
)paren
)paren
(brace
id|EXIT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|root
op_assign
id|fset-&gt;fset_mtpt
suffix:semicolon
id|size
op_assign
r_sizeof
(paren
id|__u32
)paren
op_star
id|ngroups
op_plus
r_sizeof
(paren
r_struct
id|journal_prefix
)paren
op_plus
r_sizeof
(paren
op_star
id|new_file_ver
)paren
op_plus
r_sizeof
(paren
id|ino
)paren
op_plus
r_sizeof
(paren
id|generation
)paren
op_plus
r_sizeof
(paren
id|le32_to_cpu
c_func
(paren
id|pathlen
)paren
)paren
op_plus
r_sizeof
(paren
r_struct
id|journal_suffix
)paren
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
r_sizeof
(paren
id|record
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;PRESTO: BUFFER OVERFLOW in %s!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
)brace
id|rec-&gt;is_kml
op_assign
l_int|1
suffix:semicolon
id|rec-&gt;size
op_assign
id|size
op_plus
id|size_round
c_func
(paren
id|le32_to_cpu
c_func
(paren
id|pathlen
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|journal_log_prefix_with_groups
c_func
(paren
id|record
comma
id|opcode
comma
id|rec
comma
id|ngroups
comma
id|groups
)paren
suffix:semicolon
id|logrecord
op_assign
id|logit
c_func
(paren
id|logrecord
comma
id|new_file_ver
comma
r_sizeof
(paren
op_star
id|new_file_ver
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|logit
c_func
(paren
id|logrecord
comma
op_amp
id|ino
comma
r_sizeof
(paren
id|ino
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|logit
c_func
(paren
id|logrecord
comma
op_amp
id|generation
comma
r_sizeof
(paren
id|generation
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|logit
c_func
(paren
id|logrecord
comma
op_amp
id|pathlen
comma
r_sizeof
(paren
id|pathlen
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|journal_log_suffix
c_func
(paren
id|logrecord
comma
id|record
comma
id|fset
comma
l_int|NULL
comma
id|rec
)paren
suffix:semicolon
id|error
op_assign
id|presto_log
c_func
(paren
id|fset
comma
id|rec
comma
id|record
comma
id|size
comma
id|path
comma
id|size_round
c_func
(paren
id|le32_to_cpu
c_func
(paren
id|pathlen
)paren
)paren
comma
l_int|NULL
comma
l_int|0
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
multiline_comment|/* write closes for the local close records in the LML */
DECL|function|presto_complete_lml
r_int
id|presto_complete_lml
c_func
(paren
r_struct
id|presto_file_set
op_star
id|fset
)paren
(brace
id|__u32
id|groups
(braket
id|NGROUPS_MAX
)braket
suffix:semicolon
id|loff_t
id|lml_offset
suffix:semicolon
id|loff_t
id|read_offset
suffix:semicolon
r_char
op_star
id|buffer
suffix:semicolon
r_void
op_star
id|handle
suffix:semicolon
r_struct
id|rec_info
id|rec
suffix:semicolon
r_struct
id|close_rec
(brace
r_struct
id|presto_version
id|new_file_ver
suffix:semicolon
id|__u64
id|ino
suffix:semicolon
id|__u32
id|generation
suffix:semicolon
id|__u32
id|pathlen
suffix:semicolon
id|__u64
id|remote_ino
suffix:semicolon
id|__u32
id|remote_generation
suffix:semicolon
id|__u32
id|remote_version
suffix:semicolon
id|__u64
id|lml_offset
suffix:semicolon
)brace
id|close_rec
suffix:semicolon
r_struct
id|file
op_star
id|file
op_assign
id|fset-&gt;fset_lml.fd_file
suffix:semicolon
r_struct
id|journal_prefix
id|prefix
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|ENTRY
suffix:semicolon
id|lml_offset
op_assign
l_int|0
suffix:semicolon
id|again
suffix:colon
r_if
c_cond
(paren
id|lml_offset
op_ge
id|file-&gt;f_dentry-&gt;d_inode-&gt;i_size
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|read_offset
op_assign
id|lml_offset
suffix:semicolon
id|rc
op_assign
id|presto_fread
c_func
(paren
id|file
comma
(paren
r_char
op_star
)paren
op_amp
id|prefix
comma
r_sizeof
(paren
id|prefix
)paren
comma
op_amp
id|read_offset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ne
r_sizeof
(paren
id|prefix
)paren
)paren
(brace
id|EXIT
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;presto_complete_lml: ioerror - 1, tell Peter&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_if
c_cond
(paren
id|prefix.opcode
op_eq
id|PRESTO_OP_NOOP
)paren
(brace
id|lml_offset
op_add_assign
id|prefix.len
suffix:semicolon
r_goto
id|again
suffix:semicolon
)brace
id|rc
op_assign
id|presto_fread
c_func
(paren
id|file
comma
(paren
r_char
op_star
)paren
id|groups
comma
id|prefix.ngroups
op_star
r_sizeof
(paren
id|__u32
)paren
comma
op_amp
id|read_offset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ne
id|prefix.ngroups
op_star
r_sizeof
(paren
id|__u32
)paren
)paren
(brace
id|EXIT
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;presto_complete_lml: ioerror - 2, tell Peter&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|rc
op_assign
id|presto_fread
c_func
(paren
id|file
comma
(paren
r_char
op_star
)paren
op_amp
id|close_rec
comma
r_sizeof
(paren
id|close_rec
)paren
comma
op_amp
id|read_offset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ne
r_sizeof
(paren
id|close_rec
)paren
)paren
(brace
id|EXIT
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;presto_complete_lml: ioerror - 3, tell Peter&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
multiline_comment|/* is this a backfetch or a close record? */
r_if
c_cond
(paren
id|le64_to_cpu
c_func
(paren
id|close_rec.remote_ino
)paren
op_ne
l_int|0
)paren
(brace
id|lml_offset
op_add_assign
id|prefix.len
suffix:semicolon
r_goto
id|again
suffix:semicolon
)brace
id|BUFF_ALLOC
c_func
(paren
id|buffer
comma
l_int|NULL
)paren
suffix:semicolon
id|rc
op_assign
id|presto_fread
c_func
(paren
id|file
comma
(paren
r_char
op_star
)paren
id|buffer
comma
id|le32_to_cpu
c_func
(paren
id|close_rec.pathlen
)paren
comma
op_amp
id|read_offset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ne
id|le32_to_cpu
c_func
(paren
id|close_rec.pathlen
)paren
)paren
(brace
id|EXIT
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;presto_complete_lml: ioerror - 4, tell Peter&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|handle
op_assign
id|presto_trans_start
c_func
(paren
id|fset
comma
id|file-&gt;f_dentry-&gt;d_inode
comma
id|PRESTO_OP_RELEASE
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|handle
)paren
(brace
id|EXIT
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|rc
op_assign
id|presto_clear_lml_close
c_func
(paren
id|fset
comma
id|lml_offset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;error during clearing: %d&bslash;n&quot;
comma
id|rc
)paren
suffix:semicolon
id|presto_trans_commit
c_func
(paren
id|fset
comma
id|handle
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|rc
op_assign
id|presto_rewrite_close
c_func
(paren
op_amp
id|rec
comma
id|fset
comma
id|buffer
comma
id|close_rec.pathlen
comma
id|prefix.ngroups
comma
id|groups
comma
id|close_rec.ino
comma
id|close_rec.generation
comma
op_amp
id|close_rec.new_file_ver
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;error during rewrite close: %d&bslash;n&quot;
comma
id|rc
)paren
suffix:semicolon
id|presto_trans_commit
c_func
(paren
id|fset
comma
id|handle
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|presto_trans_commit
c_func
(paren
id|fset
comma
id|handle
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;error during truncation: %d&bslash;n&quot;
comma
id|rc
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|lml_offset
op_add_assign
id|prefix.len
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_JOURNAL
comma
l_string|&quot;next LML record at: %ld&bslash;n&quot;
comma
(paren
r_int
)paren
id|lml_offset
)paren
suffix:semicolon
r_goto
id|again
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_FS_EXT_ATTR
multiline_comment|/* Journal an ea operation. A NULL buffer implies the attribute is &n; * getting deleted. In this case we simply change the opcode, but nothing&n; * else is affected.&n; */
DECL|function|presto_journal_set_ext_attr
r_int
id|presto_journal_set_ext_attr
(paren
r_struct
id|rec_info
op_star
id|rec
comma
r_struct
id|presto_file_set
op_star
id|fset
comma
r_struct
id|dentry
op_star
id|dentry
comma
r_struct
id|presto_version
op_star
id|ver
comma
r_const
r_char
op_star
id|name
comma
r_const
r_char
op_star
id|buffer
comma
r_int
id|buffer_len
comma
r_int
id|flags
)paren
(brace
r_int
id|opcode
op_assign
(paren
id|buffer
op_eq
l_int|NULL
)paren
ques
c_cond
id|PRESTO_OP_DELEXTATTR
suffix:colon
id|PRESTO_OP_SETEXTATTR
suffix:semicolon
r_char
op_star
id|temp
suffix:semicolon
r_char
op_star
id|path
suffix:semicolon
id|__u32
id|pathlen
suffix:semicolon
r_int
id|size
suffix:semicolon
r_char
op_star
id|logrecord
suffix:semicolon
r_char
id|record
(braket
l_int|292
)braket
suffix:semicolon
r_struct
id|dentry
op_star
id|root
suffix:semicolon
r_int
id|error
suffix:semicolon
id|__u32
id|namelen
op_assign
id|cpu_to_le32
c_func
(paren
id|strnlen
c_func
(paren
id|name
comma
id|PRESTO_EXT_ATTR_NAME_MAX
)paren
)paren
suffix:semicolon
id|__u32
id|buflen
op_assign
(paren
id|buffer
op_ne
l_int|NULL
)paren
ques
c_cond
id|cpu_to_le32
c_func
(paren
id|buffer_len
)paren
suffix:colon
id|cpu_to_le32
c_func
(paren
l_int|0
)paren
suffix:semicolon
id|__u32
id|mode
suffix:semicolon
id|ENTRY
suffix:semicolon
r_if
c_cond
(paren
id|presto_no_journal
c_func
(paren
id|fset
)paren
)paren
(brace
id|EXIT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|dentry-&gt;d_inode
op_logical_or
(paren
id|dentry-&gt;d_inode-&gt;i_nlink
op_eq
l_int|0
)paren
)paren
(brace
id|EXIT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|root
op_assign
id|fset-&gt;fset_mtpt
suffix:semicolon
id|BUFF_ALLOC
c_func
(paren
id|temp
comma
l_int|NULL
)paren
suffix:semicolon
id|path
op_assign
id|presto_path
c_func
(paren
id|dentry
comma
id|root
comma
id|temp
comma
id|PAGE_SIZE
)paren
suffix:semicolon
id|pathlen
op_assign
id|cpu_to_le32
c_func
(paren
id|MYPATHLEN
c_func
(paren
id|temp
comma
id|path
)paren
)paren
suffix:semicolon
id|flags
op_assign
id|cpu_to_le32
c_func
(paren
id|flags
)paren
suffix:semicolon
multiline_comment|/* Ugly, but needed. posix ACLs change the mode without using&n;         * setattr, we need to record these changes. The EA code per se&n;         * is not really affected.&n;         */
id|mode
op_assign
id|cpu_to_le32
c_func
(paren
id|dentry-&gt;d_inode-&gt;i_mode
)paren
suffix:semicolon
id|size
op_assign
r_sizeof
(paren
id|__u32
)paren
op_star
id|current-&gt;ngroups
op_plus
r_sizeof
(paren
r_struct
id|journal_prefix
)paren
op_plus
l_int|2
op_star
r_sizeof
(paren
r_struct
id|presto_version
)paren
op_plus
r_sizeof
(paren
id|flags
)paren
op_plus
r_sizeof
(paren
id|mode
)paren
op_plus
r_sizeof
(paren
id|namelen
)paren
op_plus
r_sizeof
(paren
id|buflen
)paren
op_plus
r_sizeof
(paren
id|pathlen
)paren
op_plus
r_sizeof
(paren
r_struct
id|journal_suffix
)paren
suffix:semicolon
r_if
c_cond
(paren
id|size
OG
r_sizeof
(paren
id|record
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;PRESTO: BUFFER OVERFLOW in %s!&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
)brace
id|rec-&gt;is_kml
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* Make space for a path, a attr name and value*/
multiline_comment|/* We use the buflen instead of buffer_len to make sure that we &n;         * journal the right length. This may be a little paranoid, but&n;         * with 64 bits round the corner, I would rather be safe than sorry!&n;         * Also this handles deletes with non-zero buffer_lengths correctly.&n;         * SHP&n;         */
id|rec-&gt;size
op_assign
id|size
op_plus
id|size_round
c_func
(paren
id|le32_to_cpu
c_func
(paren
id|pathlen
)paren
)paren
op_plus
id|size_round
c_func
(paren
id|le32_to_cpu
c_func
(paren
id|namelen
)paren
)paren
op_plus
id|size_round
c_func
(paren
id|le32_to_cpu
c_func
(paren
id|buflen
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|journal_log_prefix
c_func
(paren
id|record
comma
id|opcode
comma
id|rec
)paren
suffix:semicolon
id|logrecord
op_assign
id|logit
c_func
(paren
id|logrecord
comma
id|ver
comma
r_sizeof
(paren
op_star
id|ver
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|log_version
c_func
(paren
id|logrecord
comma
id|dentry
)paren
suffix:semicolon
id|logrecord
op_assign
id|logit
c_func
(paren
id|logrecord
comma
op_amp
id|flags
comma
r_sizeof
(paren
id|flags
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|logit
c_func
(paren
id|logrecord
comma
op_amp
id|mode
comma
r_sizeof
(paren
id|flags
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|logit
c_func
(paren
id|logrecord
comma
op_amp
id|pathlen
comma
r_sizeof
(paren
id|pathlen
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|logit
c_func
(paren
id|logrecord
comma
op_amp
id|namelen
comma
r_sizeof
(paren
id|namelen
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|logit
c_func
(paren
id|logrecord
comma
op_amp
id|buflen
comma
r_sizeof
(paren
id|buflen
)paren
)paren
suffix:semicolon
id|logrecord
op_assign
id|journal_log_suffix
c_func
(paren
id|logrecord
comma
id|record
comma
id|fset
comma
id|dentry
comma
id|rec
)paren
suffix:semicolon
id|error
op_assign
id|presto_log
c_func
(paren
id|fset
comma
id|rec
comma
id|record
comma
id|size
comma
id|path
comma
id|size_round
c_func
(paren
id|le32_to_cpu
c_func
(paren
id|pathlen
)paren
)paren
comma
id|name
comma
id|size_round
c_func
(paren
id|le32_to_cpu
c_func
(paren
id|namelen
)paren
)paren
comma
id|buffer
comma
id|size_round
c_func
(paren
id|le32_to_cpu
c_func
(paren
id|buflen
)paren
)paren
)paren
suffix:semicolon
id|BUFF_FREE
c_func
(paren
id|temp
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
macro_line|#endif
eof
