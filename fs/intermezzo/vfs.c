multiline_comment|/*&n; * vfs.c&n; *&n; * This file implements kernel downcalls from lento.&n; *&n; * Author: Rob Simmonds &lt;simmonds@stelias.com&gt;&n; *         Andreas Dilger &lt;adilger@stelias.com&gt;&n; * Copyright (C) 2000 Stelias Computing Inc&n; * Copyright (C) 2000 Red Hat Inc.&n; *&n; * Extended attribute support&n; * Copyright (C) 2001 Shirish H. Phatak, Tacit Networks, Inc.&n; *&n; * This code is based on code from namei.c in the linux file system;&n; * see copyright notice below.&n; */
multiline_comment|/** namei.c copyright **/
multiline_comment|/*&n; *  linux/fs/namei.c&n; *&n; *  Copyright (C) 1991, 1992  Linus Torvalds&n; */
multiline_comment|/*&n; * Some corrections by tytso.&n; */
multiline_comment|/* [Feb 1997 T. Schoebel-Theuer] Complete rewrite of the pathname&n; * lookup logic.&n; */
multiline_comment|/** end of namei.c copyright **/
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/quotaops.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/unaligned.h&gt;
macro_line|#include &lt;asm/semaphore.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;linux/file.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/blk.h&gt;
macro_line|#include &lt;linux/intermezzo_fs.h&gt;
macro_line|#include &lt;linux/intermezzo_upcall.h&gt;
macro_line|#include &lt;linux/intermezzo_psdev.h&gt;
macro_line|#include &lt;linux/intermezzo_kml.h&gt;
macro_line|#ifdef CONFIG_FS_EXT_ATTR
macro_line|#include &lt;linux/ext_attr.h&gt;
macro_line|#ifdef CONFIG_FS_POSIX_ACL
macro_line|#include &lt;linux/posix_acl.h&gt;
macro_line|#endif
macro_line|#endif
r_extern
r_struct
id|inode_operations
id|presto_sym_iops
suffix:semicolon
multiline_comment|/*&n; * It&squot;s inline, so penalty for filesystems that don&squot;t use sticky bit is&n; * minimal.&n; */
DECL|function|check_sticky
r_static
r_inline
r_int
id|check_sticky
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|inode
op_star
id|inode
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|dir-&gt;i_mode
op_amp
id|S_ISVTX
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|inode-&gt;i_uid
op_eq
id|current-&gt;fsuid
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|dir-&gt;i_uid
op_eq
id|current-&gt;fsuid
)paren
r_return
l_int|0
suffix:semicolon
r_return
op_logical_neg
id|capable
c_func
(paren
id|CAP_FOWNER
)paren
suffix:semicolon
)brace
multiline_comment|/* from linux/fs/namei.c */
DECL|function|may_delete
r_static
r_inline
r_int
id|may_delete
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|dentry
op_star
id|victim
comma
r_int
id|isdir
)paren
(brace
r_int
id|error
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|victim-&gt;d_inode
op_logical_or
id|victim-&gt;d_parent-&gt;d_inode
op_ne
id|dir
)paren
r_return
op_minus
id|ENOENT
suffix:semicolon
id|error
op_assign
id|permission
c_func
(paren
id|dir
comma
id|MAY_WRITE
op_or
id|MAY_EXEC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_return
id|error
suffix:semicolon
r_if
c_cond
(paren
id|IS_APPEND
c_func
(paren
id|dir
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
r_if
c_cond
(paren
id|check_sticky
c_func
(paren
id|dir
comma
id|victim-&gt;d_inode
)paren
op_logical_or
id|IS_APPEND
c_func
(paren
id|victim-&gt;d_inode
)paren
op_logical_or
id|IS_IMMUTABLE
c_func
(paren
id|victim-&gt;d_inode
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
r_if
c_cond
(paren
id|isdir
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|S_ISDIR
c_func
(paren
id|victim-&gt;d_inode-&gt;i_mode
)paren
)paren
r_return
op_minus
id|ENOTDIR
suffix:semicolon
r_if
c_cond
(paren
id|IS_ROOT
c_func
(paren
id|victim
)paren
)paren
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|S_ISDIR
c_func
(paren
id|victim-&gt;d_inode-&gt;i_mode
)paren
)paren
r_return
op_minus
id|EISDIR
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* from linux/fs/namei.c */
DECL|function|may_create
r_static
r_inline
r_int
id|may_create
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|dentry
op_star
id|child
)paren
(brace
r_if
c_cond
(paren
id|child-&gt;d_inode
)paren
r_return
op_minus
id|EEXIST
suffix:semicolon
r_if
c_cond
(paren
id|IS_DEADDIR
c_func
(paren
id|dir
)paren
)paren
r_return
op_minus
id|ENOENT
suffix:semicolon
r_return
id|permission
c_func
(paren
id|dir
comma
id|MAY_WRITE
op_or
id|MAY_EXEC
)paren
suffix:semicolon
)brace
macro_line|#ifdef PRESTO_DEBUG
multiline_comment|/* The loop_discard_io() function is available via a kernel patch to the&n; * loop block device.  It &quot;works&quot; by accepting writes, but throwing them&n; * away, rather than trying to write them to disk.  The old method worked&n; * by setting the underlying device read-only, but that has the problem&n; * that dirty buffers are kept in memory, and ext3 didn&squot;t like that at all.&n; */
macro_line|#ifdef CONFIG_LOOP_DISCARD
DECL|macro|BLKDEV_FAIL
mdefine_line|#define BLKDEV_FAIL(dev,fail) loop_discard_io(dev,fail)
macro_line|#else
DECL|macro|BLKDEV_FAIL
mdefine_line|#define BLKDEV_FAIL(dev,fail) set_device_ro(dev, 1)
macro_line|#endif
multiline_comment|/* If a breakpoint has been set via /proc/sys/intermezzo/intermezzoX/errorval,&n; * that is the same as &quot;value&quot;, the underlying device will &quot;fail&quot; now.&n; */
DECL|function|presto_debug_fail_blkdev
r_inline
r_void
id|presto_debug_fail_blkdev
c_func
(paren
r_struct
id|presto_file_set
op_star
id|fset
comma
r_int
r_int
id|value
)paren
(brace
r_int
id|minor
op_assign
id|presto_f2m
c_func
(paren
id|fset
)paren
suffix:semicolon
r_int
id|errorval
op_assign
id|upc_comms
(braket
id|minor
)braket
dot
id|uc_errorval
suffix:semicolon
id|kdev_t
id|dev
op_assign
id|fset-&gt;fset_mtpt-&gt;d_inode-&gt;i_dev
suffix:semicolon
r_if
c_cond
(paren
id|errorval
op_logical_and
id|errorval
op_eq
(paren
r_int
)paren
id|value
op_logical_and
op_logical_neg
id|is_read_only
c_func
(paren
id|dev
)paren
)paren
(brace
id|CDEBUG
c_func
(paren
id|D_SUPER
comma
l_string|&quot;setting device %s read only&bslash;n&quot;
comma
id|kdevname
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
id|BLKDEV_FAIL
c_func
(paren
id|dev
comma
l_int|1
)paren
suffix:semicolon
id|upc_comms
(braket
id|minor
)braket
dot
id|uc_errorval
op_assign
op_minus
id|kdev_val
c_func
(paren
id|dev
)paren
suffix:semicolon
)brace
)brace
macro_line|#else
DECL|macro|presto_debug_fail_blkdev
mdefine_line|#define presto_debug_fail_blkdev(dev,value) do {} while (0)
macro_line|#endif
DECL|function|presto_do_kml
r_static
r_inline
r_int
id|presto_do_kml
c_func
(paren
r_struct
id|lento_vfs_context
op_star
id|info
comma
r_struct
id|inode
op_star
id|inode
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|info-&gt;flags
op_amp
id|LENTO_FL_KML
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|inode-&gt;i_gid
op_eq
id|presto_excluded_gid
)paren
r_return
l_int|0
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|presto_do_expect
r_static
r_inline
r_int
id|presto_do_expect
c_func
(paren
r_struct
id|lento_vfs_context
op_star
id|info
comma
r_struct
id|inode
op_star
id|inode
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|info-&gt;flags
op_amp
id|LENTO_FL_EXPECT
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|inode-&gt;i_gid
op_eq
id|presto_excluded_gid
)paren
r_return
l_int|0
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
multiline_comment|/* XXX fixme: this should not fail, all these dentries are in memory&n;   when _we_ call this */
DECL|function|presto_settime
r_int
id|presto_settime
c_func
(paren
r_struct
id|presto_file_set
op_star
id|fset
comma
r_struct
id|dentry
op_star
id|dentry
comma
r_struct
id|lento_vfs_context
op_star
id|ctx
comma
r_int
id|valid
)paren
(brace
r_int
id|error
suffix:semicolon
r_struct
id|inode
op_star
id|inode
op_assign
id|dentry-&gt;d_inode
suffix:semicolon
r_struct
id|inode_operations
op_star
id|iops
suffix:semicolon
r_struct
id|iattr
id|iattr
suffix:semicolon
id|ENTRY
suffix:semicolon
r_if
c_cond
(paren
id|ctx-&gt;flags
op_amp
id|LENTO_FL_IGNORE_TIME
)paren
(brace
id|EXIT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|iattr.ia_ctime
op_assign
id|ctx-&gt;updated_time
suffix:semicolon
id|iattr.ia_mtime
op_assign
id|ctx-&gt;updated_time
suffix:semicolon
id|iattr.ia_valid
op_assign
id|valid
suffix:semicolon
id|error
op_assign
op_minus
id|EROFS
suffix:semicolon
r_if
c_cond
(paren
id|IS_RDONLY
c_func
(paren
id|inode
)paren
)paren
(brace
id|EXIT
suffix:semicolon
r_return
op_minus
id|EROFS
suffix:semicolon
)brace
r_if
c_cond
(paren
id|IS_IMMUTABLE
c_func
(paren
id|inode
)paren
op_logical_or
id|IS_APPEND
c_func
(paren
id|inode
)paren
)paren
(brace
id|EXIT
suffix:semicolon
r_return
op_minus
id|EPERM
suffix:semicolon
)brace
id|error
op_assign
op_minus
id|EPERM
suffix:semicolon
id|iops
op_assign
id|filter_c2cdiops
c_func
(paren
id|fset-&gt;fset_cache-&gt;cache_filter
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|iops
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
r_if
c_cond
(paren
id|iops-&gt;setattr
op_ne
l_int|NULL
)paren
id|error
op_assign
id|iops
op_member_access_from_pointer
id|setattr
c_func
(paren
id|dentry
comma
op_amp
id|iattr
)paren
suffix:semicolon
r_else
(brace
id|error
op_assign
l_int|0
suffix:semicolon
id|inode_setattr
c_func
(paren
id|dentry-&gt;d_inode
comma
op_amp
id|iattr
)paren
suffix:semicolon
)brace
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|function|presto_do_setattr
r_int
id|presto_do_setattr
c_func
(paren
r_struct
id|presto_file_set
op_star
id|fset
comma
r_struct
id|dentry
op_star
id|dentry
comma
r_struct
id|iattr
op_star
id|iattr
comma
r_struct
id|lento_vfs_context
op_star
id|info
)paren
(brace
r_struct
id|rec_info
id|rec
suffix:semicolon
r_struct
id|inode
op_star
id|inode
op_assign
id|dentry-&gt;d_inode
suffix:semicolon
r_struct
id|inode_operations
op_star
id|iops
suffix:semicolon
r_int
id|error
suffix:semicolon
r_struct
id|presto_version
id|old_ver
comma
id|new_ver
suffix:semicolon
r_void
op_star
id|handle
suffix:semicolon
id|off_t
id|old_size
op_assign
id|inode-&gt;i_size
suffix:semicolon
id|ENTRY
suffix:semicolon
id|error
op_assign
op_minus
id|EROFS
suffix:semicolon
r_if
c_cond
(paren
id|IS_RDONLY
c_func
(paren
id|inode
)paren
)paren
(brace
id|EXIT
suffix:semicolon
r_return
op_minus
id|EROFS
suffix:semicolon
)brace
r_if
c_cond
(paren
id|IS_IMMUTABLE
c_func
(paren
id|inode
)paren
op_logical_or
id|IS_APPEND
c_func
(paren
id|inode
)paren
)paren
(brace
id|EXIT
suffix:semicolon
r_return
op_minus
id|EPERM
suffix:semicolon
)brace
id|presto_getversion
c_func
(paren
op_amp
id|old_ver
comma
id|dentry-&gt;d_inode
)paren
suffix:semicolon
id|error
op_assign
op_minus
id|EPERM
suffix:semicolon
id|iops
op_assign
id|filter_c2cdiops
c_func
(paren
id|fset-&gt;fset_cache-&gt;cache_filter
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|iops
op_logical_and
op_logical_neg
id|iops-&gt;setattr
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|error
op_assign
id|presto_reserve_space
c_func
(paren
id|fset-&gt;fset_cache
comma
l_int|2
op_star
id|PRESTO_REQHIGH
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
r_if
c_cond
(paren
id|iattr-&gt;ia_valid
op_amp
id|ATTR_SIZE
)paren
(brace
id|handle
op_assign
id|presto_trans_start
c_func
(paren
id|fset
comma
id|dentry-&gt;d_inode
comma
id|PRESTO_OP_TRUNC
)paren
suffix:semicolon
)brace
r_else
(brace
id|handle
op_assign
id|presto_trans_start
c_func
(paren
id|fset
comma
id|dentry-&gt;d_inode
comma
id|PRESTO_OP_SETATTR
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|handle
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;presto_do_setattr: no space for transaction&bslash;n&quot;
)paren
suffix:semicolon
id|presto_release_space
c_func
(paren
id|fset-&gt;fset_cache
comma
l_int|2
op_star
id|PRESTO_REQHIGH
)paren
suffix:semicolon
r_return
op_minus
id|ENOSPC
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dentry-&gt;d_inode
op_logical_and
id|iops-&gt;setattr
)paren
(brace
id|error
op_assign
id|iops
op_member_access_from_pointer
id|setattr
c_func
(paren
id|dentry
comma
id|iattr
)paren
suffix:semicolon
)brace
r_else
(brace
id|error
op_assign
id|inode_change_ok
c_func
(paren
id|dentry-&gt;d_inode
comma
id|iattr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|error
)paren
id|inode_setattr
c_func
(paren
id|inode
comma
id|iattr
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|error
op_logical_and
(paren
id|iattr-&gt;ia_valid
op_amp
id|ATTR_SIZE
)paren
)paren
id|vmtruncate
c_func
(paren
id|inode
comma
id|iattr-&gt;ia_size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
id|presto_debug_fail_blkdev
c_func
(paren
id|fset
comma
id|PRESTO_OP_SETATTR
op_or
l_int|0x10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|presto_do_kml
c_func
(paren
id|info
comma
id|dentry-&gt;d_inode
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|iattr-&gt;ia_valid
op_amp
id|ATTR_SIZE
)paren
op_logical_and
(paren
id|old_size
op_ne
id|inode-&gt;i_size
)paren
)paren
(brace
r_struct
id|file
id|file
suffix:semicolon
multiline_comment|/* Journal a close whenever we see a potential truncate&n;                 &t;* At the receiving end, lento should explicitly remove&n;                 &t;* ATTR_SIZE from the list of valid attributes */
id|presto_getversion
c_func
(paren
op_amp
id|new_ver
comma
id|inode
)paren
suffix:semicolon
id|file.private_data
op_assign
l_int|NULL
suffix:semicolon
id|file.f_dentry
op_assign
id|dentry
suffix:semicolon
id|error
op_assign
id|presto_journal_close
c_func
(paren
op_amp
id|rec
comma
id|fset
comma
op_amp
id|file
comma
id|dentry
comma
op_amp
id|new_ver
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|error
)paren
id|error
op_assign
id|presto_journal_setattr
c_func
(paren
op_amp
id|rec
comma
id|fset
comma
id|dentry
comma
op_amp
id|old_ver
comma
id|iattr
)paren
suffix:semicolon
)brace
id|presto_debug_fail_blkdev
c_func
(paren
id|fset
comma
id|PRESTO_OP_SETATTR
op_or
l_int|0x20
)paren
suffix:semicolon
r_if
c_cond
(paren
id|presto_do_expect
c_func
(paren
id|info
comma
id|dentry-&gt;d_inode
)paren
)paren
id|error
op_assign
id|presto_write_last_rcvd
c_func
(paren
op_amp
id|rec
comma
id|fset
comma
id|info
)paren
suffix:semicolon
id|presto_debug_fail_blkdev
c_func
(paren
id|fset
comma
id|PRESTO_OP_SETATTR
op_or
l_int|0x30
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
m_exit
suffix:colon
id|presto_release_space
c_func
(paren
id|fset-&gt;fset_cache
comma
l_int|2
op_star
id|PRESTO_REQHIGH
)paren
suffix:semicolon
id|presto_trans_commit
c_func
(paren
id|fset
comma
id|handle
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|function|lento_setattr
r_int
id|lento_setattr
c_func
(paren
r_const
r_char
op_star
id|name
comma
r_struct
id|iattr
op_star
id|iattr
comma
r_struct
id|lento_vfs_context
op_star
id|info
)paren
(brace
r_struct
id|nameidata
id|nd
suffix:semicolon
r_struct
id|dentry
op_star
id|dentry
suffix:semicolon
r_struct
id|presto_file_set
op_star
id|fset
suffix:semicolon
r_int
id|error
suffix:semicolon
macro_line|#ifdef  CONFIG_FS_POSIX_ACL
r_int
(paren
op_star
id|set_posix_acl
)paren
(paren
r_struct
id|inode
op_star
comma
r_int
id|type
comma
id|posix_acl_t
op_star
)paren
op_assign
l_int|NULL
suffix:semicolon
macro_line|#endif
id|ENTRY
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_PIOCTL
comma
l_string|&quot;name %s, valid %#x, mode %#o, uid %d, gid %d, size %Ld&bslash;n&quot;
comma
id|name
comma
id|iattr-&gt;ia_valid
comma
id|iattr-&gt;ia_mode
comma
id|iattr-&gt;ia_uid
comma
id|iattr-&gt;ia_gid
comma
id|iattr-&gt;ia_size
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_PIOCTL
comma
l_string|&quot;atime %#lx, mtime %#lx, ctime %#lx, attr_flags %#x&bslash;n&quot;
comma
id|iattr-&gt;ia_atime
comma
id|iattr-&gt;ia_mtime
comma
id|iattr-&gt;ia_ctime
comma
id|iattr-&gt;ia_attr_flags
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_PIOCTL
comma
l_string|&quot;offset %d, recno %d, flags %#x&bslash;n&quot;
comma
id|info-&gt;slot_offset
comma
id|info-&gt;recno
comma
id|info-&gt;flags
)paren
suffix:semicolon
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
id|error
op_assign
id|presto_walk
c_func
(paren
id|name
comma
op_amp
id|nd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
id|dentry
op_assign
id|nd.dentry
suffix:semicolon
id|fset
op_assign
id|presto_fset
c_func
(paren
id|dentry
)paren
suffix:semicolon
id|error
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fset
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;No fileset!&bslash;n&quot;
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_goto
id|exit_lock
suffix:semicolon
)brace
multiline_comment|/* NOTE: this prevents us from changing the filetype on setattr,&n;         *       as we normally only want to change permission bits.&n;         *       If this is not correct, then we need to fix the perl code&n;         *       to always send the file type OR&squot;ed with the permission.&n;         */
r_if
c_cond
(paren
id|iattr-&gt;ia_valid
op_amp
id|ATTR_MODE
)paren
(brace
r_int
id|set_mode
op_assign
id|iattr-&gt;ia_mode
suffix:semicolon
id|iattr-&gt;ia_mode
op_assign
(paren
id|iattr-&gt;ia_mode
op_amp
id|S_IALLUGO
)paren
op_or
(paren
id|dentry-&gt;d_inode-&gt;i_mode
op_amp
op_complement
id|S_IALLUGO
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_PIOCTL
comma
l_string|&quot;chmod: orig %#o, set %#o, result %#o&bslash;n&quot;
comma
id|dentry-&gt;d_inode-&gt;i_mode
comma
id|set_mode
comma
id|iattr-&gt;ia_mode
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_FS_POSIX_ACL
multiline_comment|/* ACl code interacts badly with setattr &n;                 * since it tries to modify the ACL using &n;                 * set_ext_attr which recurses back into presto.  &n;                 * This only happens if ATTR_MODE is set.&n;                 * Here we are doing a &quot;forced&quot; mode set &n;                 * (initiated by lento), so we disable the &n;                 * set_posix_acl operation which &n;                 * prevents such recursion.  -SHP&n;                 *&n;                 * This will probably still be required when native&n;                 * acl journalling is in place.&n;                 */
id|set_posix_acl
op_assign
id|dentry-&gt;d_inode-&gt;i_op-&gt;set_posix_acl
suffix:semicolon
id|dentry-&gt;d_inode-&gt;i_op-&gt;set_posix_acl
op_assign
l_int|NULL
suffix:semicolon
macro_line|#endif
)brace
id|error
op_assign
id|presto_do_setattr
c_func
(paren
id|fset
comma
id|dentry
comma
id|iattr
comma
id|info
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_FS_POSIX_ACL
multiline_comment|/* restore the inode_operations if we changed them*/
r_if
c_cond
(paren
id|iattr-&gt;ia_valid
op_amp
id|ATTR_MODE
)paren
id|dentry-&gt;d_inode-&gt;i_op-&gt;set_posix_acl
op_assign
id|set_posix_acl
suffix:semicolon
macro_line|#endif
id|EXIT
suffix:semicolon
id|exit_lock
suffix:colon
id|path_release
c_func
(paren
op_amp
id|nd
)paren
suffix:semicolon
m_exit
suffix:colon
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|function|presto_do_create
r_int
id|presto_do_create
c_func
(paren
r_struct
id|presto_file_set
op_star
id|fset
comma
r_struct
id|dentry
op_star
id|dir
comma
r_struct
id|dentry
op_star
id|dentry
comma
r_int
id|mode
comma
r_struct
id|lento_vfs_context
op_star
id|info
)paren
(brace
r_struct
id|rec_info
id|rec
suffix:semicolon
r_int
id|error
suffix:semicolon
r_struct
id|presto_version
id|tgt_dir_ver
comma
id|new_file_ver
suffix:semicolon
r_struct
id|inode_operations
op_star
id|iops
suffix:semicolon
r_void
op_star
id|handle
suffix:semicolon
id|ENTRY
suffix:semicolon
id|mode
op_and_assign
id|S_IALLUGO
suffix:semicolon
id|mode
op_or_assign
id|S_IFREG
suffix:semicolon
id|down
c_func
(paren
op_amp
id|dir-&gt;d_inode-&gt;i_zombie
)paren
suffix:semicolon
id|error
op_assign
id|presto_reserve_space
c_func
(paren
id|fset-&gt;fset_cache
comma
id|PRESTO_REQHIGH
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
id|up
c_func
(paren
op_amp
id|dir-&gt;d_inode-&gt;i_zombie
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|error
op_assign
id|may_create
c_func
(paren
id|dir-&gt;d_inode
comma
id|dentry
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_goto
id|exit_pre_lock
suffix:semicolon
)brace
id|error
op_assign
op_minus
id|EPERM
suffix:semicolon
id|iops
op_assign
id|filter_c2cdiops
c_func
(paren
id|fset-&gt;fset_cache-&gt;cache_filter
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|iops-&gt;create
)paren
(brace
id|EXIT
suffix:semicolon
r_goto
id|exit_pre_lock
suffix:semicolon
)brace
id|presto_getversion
c_func
(paren
op_amp
id|tgt_dir_ver
comma
id|dir-&gt;d_inode
)paren
suffix:semicolon
id|handle
op_assign
id|presto_trans_start
c_func
(paren
id|fset
comma
id|dir-&gt;d_inode
comma
id|PRESTO_OP_CREATE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|handle
)paren
)paren
(brace
id|EXIT
suffix:semicolon
id|presto_release_space
c_func
(paren
id|fset-&gt;fset_cache
comma
id|PRESTO_REQHIGH
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;presto_do_create: no space for transaction&bslash;n&quot;
)paren
suffix:semicolon
id|error
op_assign
op_minus
id|ENOSPC
suffix:semicolon
r_goto
id|exit_pre_lock
suffix:semicolon
)brace
id|DQUOT_INIT
c_func
(paren
id|dir-&gt;d_inode
)paren
suffix:semicolon
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
id|error
op_assign
id|iops
op_member_access_from_pointer
id|create
c_func
(paren
id|dir-&gt;d_inode
comma
id|dentry
comma
id|mode
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_goto
id|exit_lock
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dentry-&gt;d_inode
op_logical_and
id|dentry-&gt;d_inode-&gt;i_gid
op_ne
id|presto_excluded_gid
)paren
(brace
r_struct
id|presto_cache
op_star
id|cache
op_assign
id|fset-&gt;fset_cache
suffix:semicolon
multiline_comment|/* was this already done? */
id|presto_set_ops
c_func
(paren
id|dentry-&gt;d_inode
comma
id|cache-&gt;cache_filter
)paren
suffix:semicolon
id|filter_setup_dentry_ops
c_func
(paren
id|cache-&gt;cache_filter
comma
id|dentry-&gt;d_op
comma
op_amp
id|presto_dentry_ops
)paren
suffix:semicolon
id|dentry-&gt;d_op
op_assign
id|filter_c2udops
c_func
(paren
id|cache-&gt;cache_filter
)paren
suffix:semicolon
multiline_comment|/* if Lento creates this file, we won&squot;t have data */
r_if
c_cond
(paren
id|ISLENTO
c_func
(paren
id|presto_c2m
c_func
(paren
id|cache
)paren
)paren
)paren
(brace
id|presto_set
c_func
(paren
id|dentry
comma
id|PRESTO_ATTR
)paren
suffix:semicolon
)brace
r_else
(brace
id|presto_set
c_func
(paren
id|dentry
comma
id|PRESTO_ATTR
op_or
id|PRESTO_DATA
)paren
suffix:semicolon
)brace
)brace
id|error
op_assign
id|presto_settime
c_func
(paren
id|fset
comma
id|dir
comma
id|info
comma
id|ATTR_CTIME
op_or
id|ATTR_MTIME
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_goto
id|exit_lock
suffix:semicolon
)brace
id|error
op_assign
id|presto_settime
c_func
(paren
id|fset
comma
id|dentry
comma
id|info
comma
id|ATTR_CTIME
op_or
id|ATTR_MTIME
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_goto
id|exit_lock
suffix:semicolon
)brace
id|presto_debug_fail_blkdev
c_func
(paren
id|fset
comma
id|PRESTO_OP_CREATE
op_or
l_int|0x10
)paren
suffix:semicolon
id|presto_getversion
c_func
(paren
op_amp
id|new_file_ver
comma
id|dentry-&gt;d_inode
)paren
suffix:semicolon
r_if
c_cond
(paren
id|presto_do_kml
c_func
(paren
id|info
comma
id|dentry-&gt;d_inode
)paren
)paren
id|error
op_assign
id|presto_journal_create
c_func
(paren
op_amp
id|rec
comma
id|fset
comma
id|dentry
comma
op_amp
id|tgt_dir_ver
comma
op_amp
id|new_file_ver
comma
id|dentry-&gt;d_inode-&gt;i_mode
)paren
suffix:semicolon
id|presto_debug_fail_blkdev
c_func
(paren
id|fset
comma
id|PRESTO_OP_CREATE
op_or
l_int|0x20
)paren
suffix:semicolon
r_if
c_cond
(paren
id|presto_do_expect
c_func
(paren
id|info
comma
id|dentry-&gt;d_inode
)paren
)paren
id|error
op_assign
id|presto_write_last_rcvd
c_func
(paren
op_amp
id|rec
comma
id|fset
comma
id|info
)paren
suffix:semicolon
id|presto_debug_fail_blkdev
c_func
(paren
id|fset
comma
id|PRESTO_OP_CREATE
op_or
l_int|0x30
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
id|exit_lock
suffix:colon
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
id|presto_trans_commit
c_func
(paren
id|fset
comma
id|handle
)paren
suffix:semicolon
id|exit_pre_lock
suffix:colon
id|presto_release_space
c_func
(paren
id|fset-&gt;fset_cache
comma
id|PRESTO_REQHIGH
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|dir-&gt;d_inode-&gt;i_zombie
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
multiline_comment|/* from namei.c */
DECL|function|lookup_create
r_static
r_struct
id|dentry
op_star
id|lookup_create
c_func
(paren
r_struct
id|nameidata
op_star
id|nd
comma
r_int
id|is_dir
)paren
(brace
r_struct
id|dentry
op_star
id|dentry
suffix:semicolon
id|down
c_func
(paren
op_amp
id|nd-&gt;dentry-&gt;d_inode-&gt;i_sem
)paren
suffix:semicolon
id|dentry
op_assign
id|ERR_PTR
c_func
(paren
op_minus
id|EEXIST
)paren
suffix:semicolon
r_if
c_cond
(paren
id|nd-&gt;last_type
op_ne
id|LAST_NORM
)paren
r_goto
id|fail
suffix:semicolon
id|dentry
op_assign
id|lookup_hash
c_func
(paren
op_amp
id|nd-&gt;last
comma
id|nd-&gt;dentry
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|dentry
)paren
)paren
r_goto
id|fail
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|is_dir
op_logical_and
id|nd-&gt;last.name
(braket
id|nd-&gt;last.len
)braket
op_logical_and
op_logical_neg
id|dentry-&gt;d_inode
)paren
r_goto
id|enoent
suffix:semicolon
r_return
id|dentry
suffix:semicolon
id|enoent
suffix:colon
id|dput
c_func
(paren
id|dentry
)paren
suffix:semicolon
id|dentry
op_assign
id|ERR_PTR
c_func
(paren
op_minus
id|ENOENT
)paren
suffix:semicolon
id|fail
suffix:colon
r_return
id|dentry
suffix:semicolon
)brace
DECL|function|lento_create
r_int
id|lento_create
c_func
(paren
r_const
r_char
op_star
id|name
comma
r_int
id|mode
comma
r_struct
id|lento_vfs_context
op_star
id|info
)paren
(brace
r_int
id|error
suffix:semicolon
r_struct
id|nameidata
id|nd
suffix:semicolon
r_char
op_star
id|pathname
suffix:semicolon
r_struct
id|dentry
op_star
id|dentry
suffix:semicolon
r_struct
id|presto_file_set
op_star
id|fset
suffix:semicolon
id|ENTRY
suffix:semicolon
id|pathname
op_assign
id|getname
c_func
(paren
id|name
)paren
suffix:semicolon
id|error
op_assign
id|PTR_ERR
c_func
(paren
id|pathname
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|pathname
)paren
)paren
(brace
id|EXIT
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
multiline_comment|/* this looks up the parent */
singleline_comment|//        if (path_init(pathname, LOOKUP_FOLLOW | LOOKUP_POSITIVE, &amp;nd))
r_if
c_cond
(paren
id|path_init
c_func
(paren
id|pathname
comma
id|LOOKUP_PARENT
comma
op_amp
id|nd
)paren
)paren
id|error
op_assign
id|path_walk
c_func
(paren
id|pathname
comma
op_amp
id|nd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
id|dentry
op_assign
id|lookup_create
c_func
(paren
op_amp
id|nd
comma
l_int|0
)paren
suffix:semicolon
id|error
op_assign
id|PTR_ERR
c_func
(paren
id|dentry
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|dentry
)paren
)paren
(brace
id|EXIT
suffix:semicolon
r_goto
id|exit_lock
suffix:semicolon
)brace
id|fset
op_assign
id|presto_fset
c_func
(paren
id|dentry
)paren
suffix:semicolon
id|error
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fset
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;No fileset!&bslash;n&quot;
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_goto
id|exit_lock
suffix:semicolon
)brace
id|error
op_assign
id|presto_do_create
c_func
(paren
id|fset
comma
id|dentry-&gt;d_parent
comma
id|dentry
comma
(paren
id|mode
op_amp
id|S_IALLUGO
)paren
op_or
id|S_IFREG
comma
id|info
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
id|exit_lock
suffix:colon
id|path_release
(paren
op_amp
id|nd
)paren
suffix:semicolon
id|dput
c_func
(paren
id|dentry
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|dentry-&gt;d_parent-&gt;d_inode-&gt;i_sem
)paren
suffix:semicolon
id|putname
c_func
(paren
id|pathname
)paren
suffix:semicolon
m_exit
suffix:colon
r_return
id|error
suffix:semicolon
)brace
DECL|function|presto_do_link
r_int
id|presto_do_link
c_func
(paren
r_struct
id|presto_file_set
op_star
id|fset
comma
r_struct
id|dentry
op_star
id|old_dentry
comma
r_struct
id|dentry
op_star
id|dir
comma
r_struct
id|dentry
op_star
id|new_dentry
comma
r_struct
id|lento_vfs_context
op_star
id|info
)paren
(brace
r_struct
id|rec_info
id|rec
suffix:semicolon
r_struct
id|inode
op_star
id|inode
suffix:semicolon
r_int
id|error
suffix:semicolon
r_struct
id|inode_operations
op_star
id|iops
suffix:semicolon
r_struct
id|presto_version
id|tgt_dir_ver
suffix:semicolon
r_struct
id|presto_version
id|new_link_ver
suffix:semicolon
r_void
op_star
id|handle
suffix:semicolon
id|down
c_func
(paren
op_amp
id|dir-&gt;d_inode-&gt;i_zombie
)paren
suffix:semicolon
id|error
op_assign
id|presto_reserve_space
c_func
(paren
id|fset-&gt;fset_cache
comma
id|PRESTO_REQHIGH
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
id|up
c_func
(paren
op_amp
id|dir-&gt;d_inode-&gt;i_zombie
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|error
op_assign
op_minus
id|ENOENT
suffix:semicolon
id|inode
op_assign
id|old_dentry-&gt;d_inode
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|inode
)paren
r_goto
id|exit_lock
suffix:semicolon
id|error
op_assign
id|may_create
c_func
(paren
id|dir-&gt;d_inode
comma
id|new_dentry
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_goto
id|exit_lock
suffix:semicolon
id|error
op_assign
op_minus
id|EXDEV
suffix:semicolon
r_if
c_cond
(paren
id|dir-&gt;d_inode-&gt;i_sb
op_ne
id|inode-&gt;i_sb
)paren
r_goto
id|exit_lock
suffix:semicolon
multiline_comment|/*&n;         * A link to an append-only or immutable file cannot be created.&n;         */
id|error
op_assign
op_minus
id|EPERM
suffix:semicolon
r_if
c_cond
(paren
id|IS_APPEND
c_func
(paren
id|inode
)paren
op_logical_or
id|IS_IMMUTABLE
c_func
(paren
id|inode
)paren
)paren
(brace
id|EXIT
suffix:semicolon
r_goto
id|exit_lock
suffix:semicolon
)brace
id|iops
op_assign
id|filter_c2cdiops
c_func
(paren
id|fset-&gt;fset_cache-&gt;cache_filter
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|iops-&gt;link
)paren
(brace
id|EXIT
suffix:semicolon
r_goto
id|exit_lock
suffix:semicolon
)brace
id|presto_getversion
c_func
(paren
op_amp
id|tgt_dir_ver
comma
id|dir-&gt;d_inode
)paren
suffix:semicolon
id|handle
op_assign
id|presto_trans_start
c_func
(paren
id|fset
comma
id|dir-&gt;d_inode
comma
id|PRESTO_OP_LINK
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|handle
)paren
)paren
(brace
id|presto_release_space
c_func
(paren
id|fset-&gt;fset_cache
comma
id|PRESTO_REQHIGH
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;presto_do_link: no space for transaction&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOSPC
suffix:semicolon
)brace
id|DQUOT_INIT
c_func
(paren
id|dir-&gt;d_inode
)paren
suffix:semicolon
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
id|error
op_assign
id|iops
op_member_access_from_pointer
id|link
c_func
(paren
id|old_dentry
comma
id|dir-&gt;d_inode
comma
id|new_dentry
)paren
suffix:semicolon
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_goto
id|exit_lock
suffix:semicolon
)brace
id|error
op_assign
id|presto_settime
c_func
(paren
id|fset
comma
id|dir
comma
id|info
comma
id|ATTR_CTIME
op_or
id|ATTR_MTIME
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_goto
id|exit_lock
suffix:semicolon
)brace
id|error
op_assign
id|presto_settime
c_func
(paren
id|fset
comma
id|new_dentry
comma
id|info
comma
id|ATTR_CTIME
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_goto
id|exit_lock
suffix:semicolon
)brace
id|presto_debug_fail_blkdev
c_func
(paren
id|fset
comma
id|PRESTO_OP_LINK
op_or
l_int|0x10
)paren
suffix:semicolon
id|presto_getversion
c_func
(paren
op_amp
id|new_link_ver
comma
id|new_dentry-&gt;d_inode
)paren
suffix:semicolon
r_if
c_cond
(paren
id|presto_do_kml
c_func
(paren
id|info
comma
id|old_dentry-&gt;d_inode
)paren
)paren
id|error
op_assign
id|presto_journal_link
c_func
(paren
op_amp
id|rec
comma
id|fset
comma
id|old_dentry
comma
id|new_dentry
comma
op_amp
id|tgt_dir_ver
comma
op_amp
id|new_link_ver
)paren
suffix:semicolon
id|presto_debug_fail_blkdev
c_func
(paren
id|fset
comma
id|PRESTO_OP_LINK
op_or
l_int|0x20
)paren
suffix:semicolon
r_if
c_cond
(paren
id|presto_do_expect
c_func
(paren
id|info
comma
id|old_dentry-&gt;d_inode
)paren
)paren
id|error
op_assign
id|presto_write_last_rcvd
c_func
(paren
op_amp
id|rec
comma
id|fset
comma
id|info
)paren
suffix:semicolon
id|presto_debug_fail_blkdev
c_func
(paren
id|fset
comma
id|PRESTO_OP_LINK
op_or
l_int|0x30
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
id|presto_trans_commit
c_func
(paren
id|fset
comma
id|handle
)paren
suffix:semicolon
id|exit_lock
suffix:colon
id|presto_release_space
c_func
(paren
id|fset-&gt;fset_cache
comma
id|PRESTO_REQHIGH
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|dir-&gt;d_inode-&gt;i_zombie
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|function|lento_link
r_int
id|lento_link
c_func
(paren
r_const
r_char
op_star
id|oldname
comma
r_const
r_char
op_star
id|newname
comma
r_struct
id|lento_vfs_context
op_star
id|info
)paren
(brace
r_int
id|error
suffix:semicolon
r_char
op_star
id|from
suffix:semicolon
r_char
op_star
id|to
suffix:semicolon
r_struct
id|presto_file_set
op_star
id|fset
suffix:semicolon
id|from
op_assign
id|getname
c_func
(paren
id|oldname
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|from
)paren
)paren
(brace
r_return
id|PTR_ERR
c_func
(paren
id|from
)paren
suffix:semicolon
)brace
id|to
op_assign
id|getname
c_func
(paren
id|newname
)paren
suffix:semicolon
id|error
op_assign
id|PTR_ERR
c_func
(paren
id|to
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|IS_ERR
c_func
(paren
id|to
)paren
)paren
(brace
r_struct
id|dentry
op_star
id|new_dentry
suffix:semicolon
r_struct
id|nameidata
id|nd
comma
id|old_nd
suffix:semicolon
id|error
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|path_init
c_func
(paren
id|from
comma
id|LOOKUP_POSITIVE
comma
op_amp
id|old_nd
)paren
)paren
id|error
op_assign
id|path_walk
c_func
(paren
id|from
comma
op_amp
id|old_nd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_goto
m_exit
suffix:semicolon
r_if
c_cond
(paren
id|path_init
c_func
(paren
id|to
comma
id|LOOKUP_PARENT
comma
op_amp
id|nd
)paren
)paren
id|error
op_assign
id|path_walk
c_func
(paren
id|to
comma
op_amp
id|nd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_goto
id|out
suffix:semicolon
id|error
op_assign
op_minus
id|EXDEV
suffix:semicolon
r_if
c_cond
(paren
id|old_nd.mnt
op_ne
id|nd.mnt
)paren
r_goto
id|out
suffix:semicolon
id|new_dentry
op_assign
id|lookup_create
c_func
(paren
op_amp
id|nd
comma
l_int|0
)paren
suffix:semicolon
id|error
op_assign
id|PTR_ERR
c_func
(paren
id|new_dentry
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|IS_ERR
c_func
(paren
id|new_dentry
)paren
)paren
(brace
id|fset
op_assign
id|presto_fset
c_func
(paren
id|new_dentry
)paren
suffix:semicolon
id|error
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fset
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;No fileset!&bslash;n&quot;
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_goto
id|out2
suffix:semicolon
)brace
id|error
op_assign
id|presto_do_link
c_func
(paren
id|fset
comma
id|old_nd.dentry
comma
id|nd.dentry
comma
id|new_dentry
comma
id|info
)paren
suffix:semicolon
id|dput
c_func
(paren
id|new_dentry
)paren
suffix:semicolon
)brace
id|out2
suffix:colon
id|up
c_func
(paren
op_amp
id|nd.dentry-&gt;d_inode-&gt;i_sem
)paren
suffix:semicolon
id|path_release
c_func
(paren
op_amp
id|nd
)paren
suffix:semicolon
id|out
suffix:colon
id|path_release
c_func
(paren
op_amp
id|old_nd
)paren
suffix:semicolon
m_exit
suffix:colon
id|putname
c_func
(paren
id|to
)paren
suffix:semicolon
)brace
id|putname
c_func
(paren
id|from
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|function|presto_do_unlink
r_int
id|presto_do_unlink
c_func
(paren
r_struct
id|presto_file_set
op_star
id|fset
comma
r_struct
id|dentry
op_star
id|dir
comma
r_struct
id|dentry
op_star
id|dentry
comma
r_struct
id|lento_vfs_context
op_star
id|info
)paren
(brace
r_struct
id|rec_info
id|rec
suffix:semicolon
r_int
id|error
suffix:semicolon
r_struct
id|inode_operations
op_star
id|iops
suffix:semicolon
r_struct
id|presto_version
id|tgt_dir_ver
comma
id|old_file_ver
suffix:semicolon
r_void
op_star
id|handle
suffix:semicolon
r_int
id|do_kml
op_assign
l_int|0
comma
id|do_expect
op_assign
l_int|0
suffix:semicolon
r_int
id|linkno
op_assign
l_int|0
suffix:semicolon
id|ENTRY
suffix:semicolon
id|down
c_func
(paren
op_amp
id|dir-&gt;d_inode-&gt;i_zombie
)paren
suffix:semicolon
id|error
op_assign
id|may_delete
c_func
(paren
id|dir-&gt;d_inode
comma
id|dentry
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
id|up
c_func
(paren
op_amp
id|dir-&gt;d_inode-&gt;i_zombie
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|error
op_assign
op_minus
id|EPERM
suffix:semicolon
id|iops
op_assign
id|filter_c2cdiops
c_func
(paren
id|fset-&gt;fset_cache-&gt;cache_filter
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|iops-&gt;unlink
)paren
(brace
id|EXIT
suffix:semicolon
id|up
c_func
(paren
op_amp
id|dir-&gt;d_inode-&gt;i_zombie
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|error
op_assign
id|presto_reserve_space
c_func
(paren
id|fset-&gt;fset_cache
comma
id|PRESTO_REQLOW
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
id|up
c_func
(paren
op_amp
id|dir-&gt;d_inode-&gt;i_zombie
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|presto_getversion
c_func
(paren
op_amp
id|tgt_dir_ver
comma
id|dir-&gt;d_inode
)paren
suffix:semicolon
id|presto_getversion
c_func
(paren
op_amp
id|old_file_ver
comma
id|dentry-&gt;d_inode
)paren
suffix:semicolon
id|handle
op_assign
id|presto_trans_start
c_func
(paren
id|fset
comma
id|dir-&gt;d_inode
comma
id|PRESTO_OP_UNLINK
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|handle
)paren
)paren
(brace
id|presto_release_space
c_func
(paren
id|fset-&gt;fset_cache
comma
id|PRESTO_REQLOW
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;ERROR: presto_do_unlink: no space for transaction. Tell Peter.&bslash;n&quot;
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|dir-&gt;d_inode-&gt;i_zombie
)paren
suffix:semicolon
r_return
op_minus
id|ENOSPC
suffix:semicolon
)brace
id|DQUOT_INIT
c_func
(paren
id|dir-&gt;d_inode
)paren
suffix:semicolon
r_if
c_cond
(paren
id|d_mountpoint
c_func
(paren
id|dentry
)paren
)paren
id|error
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_else
(brace
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
id|linkno
op_assign
id|dentry-&gt;d_inode-&gt;i_nlink
suffix:semicolon
r_if
c_cond
(paren
id|linkno
OG
l_int|1
)paren
(brace
id|dget
c_func
(paren
id|dentry
)paren
suffix:semicolon
)brace
id|do_kml
op_assign
id|presto_do_kml
c_func
(paren
id|info
comma
id|dir-&gt;d_inode
)paren
suffix:semicolon
id|do_expect
op_assign
id|presto_do_expect
c_func
(paren
id|info
comma
id|dir-&gt;d_inode
)paren
suffix:semicolon
id|error
op_assign
id|iops
op_member_access_from_pointer
id|unlink
c_func
(paren
id|dir-&gt;d_inode
comma
id|dentry
)paren
suffix:semicolon
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|error
)paren
id|d_delete
c_func
(paren
id|dentry
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|linkno
OG
l_int|1
)paren
(brace
id|error
op_assign
id|presto_settime
c_func
(paren
id|fset
comma
id|dentry
comma
id|info
comma
id|ATTR_CTIME
)paren
suffix:semicolon
id|dput
c_func
(paren
id|dentry
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
)brace
id|error
op_assign
id|presto_settime
c_func
(paren
id|fset
comma
id|dir
comma
id|info
comma
id|ATTR_CTIME
op_or
id|ATTR_MTIME
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|dir-&gt;d_inode-&gt;i_zombie
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
id|presto_debug_fail_blkdev
c_func
(paren
id|fset
comma
id|PRESTO_OP_UNLINK
op_or
l_int|0x10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|do_kml
)paren
(brace
id|error
op_assign
id|presto_journal_unlink
c_func
(paren
op_amp
id|rec
comma
id|fset
comma
id|dir
comma
op_amp
id|tgt_dir_ver
comma
op_amp
id|old_file_ver
comma
id|dentry-&gt;d_name.len
comma
id|dentry-&gt;d_name.name
)paren
suffix:semicolon
)brace
id|presto_debug_fail_blkdev
c_func
(paren
id|fset
comma
id|PRESTO_OP_UNLINK
op_or
l_int|0x20
)paren
suffix:semicolon
r_if
c_cond
(paren
id|do_expect
)paren
(brace
id|error
op_assign
id|presto_write_last_rcvd
c_func
(paren
op_amp
id|rec
comma
id|fset
comma
id|info
)paren
suffix:semicolon
)brace
id|presto_debug_fail_blkdev
c_func
(paren
id|fset
comma
id|PRESTO_OP_UNLINK
op_or
l_int|0x30
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
m_exit
suffix:colon
id|presto_release_space
c_func
(paren
id|fset-&gt;fset_cache
comma
id|PRESTO_REQLOW
)paren
suffix:semicolon
id|presto_trans_commit
c_func
(paren
id|fset
comma
id|handle
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|function|lento_unlink
r_int
id|lento_unlink
c_func
(paren
r_const
r_char
op_star
id|pathname
comma
r_struct
id|lento_vfs_context
op_star
id|info
)paren
(brace
r_int
id|error
op_assign
l_int|0
suffix:semicolon
r_char
op_star
id|name
suffix:semicolon
r_struct
id|dentry
op_star
id|dentry
suffix:semicolon
r_struct
id|nameidata
id|nd
suffix:semicolon
r_struct
id|presto_file_set
op_star
id|fset
suffix:semicolon
id|ENTRY
suffix:semicolon
id|name
op_assign
id|getname
c_func
(paren
id|pathname
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|name
)paren
)paren
(brace
r_return
id|PTR_ERR
c_func
(paren
id|name
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|path_init
c_func
(paren
id|name
comma
id|LOOKUP_PARENT
comma
op_amp
id|nd
)paren
)paren
id|error
op_assign
id|path_walk
c_func
(paren
id|name
comma
op_amp
id|nd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_goto
m_exit
suffix:semicolon
id|error
op_assign
op_minus
id|EISDIR
suffix:semicolon
r_if
c_cond
(paren
id|nd.last_type
op_ne
id|LAST_NORM
)paren
r_goto
id|exit1
suffix:semicolon
id|down
c_func
(paren
op_amp
id|nd.dentry-&gt;d_inode-&gt;i_sem
)paren
suffix:semicolon
id|dentry
op_assign
id|lookup_hash
c_func
(paren
op_amp
id|nd.last
comma
id|nd.dentry
)paren
suffix:semicolon
id|error
op_assign
id|PTR_ERR
c_func
(paren
id|dentry
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|IS_ERR
c_func
(paren
id|dentry
)paren
)paren
(brace
id|fset
op_assign
id|presto_fset
c_func
(paren
id|dentry
)paren
suffix:semicolon
id|error
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fset
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;No fileset!&bslash;n&quot;
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_goto
id|exit2
suffix:semicolon
)brace
multiline_comment|/* Why not before? Because we want correct error value */
r_if
c_cond
(paren
id|nd.last.name
(braket
id|nd.last.len
)braket
)paren
r_goto
id|slashes
suffix:semicolon
id|error
op_assign
id|presto_do_unlink
c_func
(paren
id|fset
comma
id|nd.dentry
comma
id|dentry
comma
id|info
)paren
suffix:semicolon
id|exit2
suffix:colon
id|EXIT
suffix:semicolon
id|dput
c_func
(paren
id|dentry
)paren
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|nd.dentry-&gt;d_inode-&gt;i_sem
)paren
suffix:semicolon
id|exit1
suffix:colon
id|path_release
c_func
(paren
op_amp
id|nd
)paren
suffix:semicolon
m_exit
suffix:colon
id|putname
c_func
(paren
id|name
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
id|slashes
suffix:colon
id|error
op_assign
op_logical_neg
id|dentry-&gt;d_inode
ques
c_cond
op_minus
id|ENOENT
suffix:colon
id|S_ISDIR
c_func
(paren
id|dentry-&gt;d_inode-&gt;i_mode
)paren
ques
c_cond
op_minus
id|EISDIR
suffix:colon
op_minus
id|ENOTDIR
suffix:semicolon
r_goto
id|exit2
suffix:semicolon
)brace
DECL|function|presto_do_symlink
r_int
id|presto_do_symlink
c_func
(paren
r_struct
id|presto_file_set
op_star
id|fset
comma
r_struct
id|dentry
op_star
id|dir
comma
r_struct
id|dentry
op_star
id|dentry
comma
r_const
r_char
op_star
id|oldname
comma
r_struct
id|lento_vfs_context
op_star
id|info
)paren
(brace
r_struct
id|rec_info
id|rec
suffix:semicolon
r_int
id|error
suffix:semicolon
r_struct
id|presto_version
id|tgt_dir_ver
comma
id|new_link_ver
suffix:semicolon
r_struct
id|inode_operations
op_star
id|iops
suffix:semicolon
r_void
op_star
id|handle
suffix:semicolon
id|ENTRY
suffix:semicolon
id|down
c_func
(paren
op_amp
id|dir-&gt;d_inode-&gt;i_zombie
)paren
suffix:semicolon
multiline_comment|/* record + max path len + space to free */
id|error
op_assign
id|presto_reserve_space
c_func
(paren
id|fset-&gt;fset_cache
comma
id|PRESTO_REQHIGH
op_plus
l_int|4096
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
id|up
c_func
(paren
op_amp
id|dir-&gt;d_inode-&gt;i_zombie
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|error
op_assign
id|may_create
c_func
(paren
id|dir-&gt;d_inode
comma
id|dentry
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_goto
id|exit_lock
suffix:semicolon
)brace
id|error
op_assign
op_minus
id|EPERM
suffix:semicolon
id|iops
op_assign
id|filter_c2cdiops
c_func
(paren
id|fset-&gt;fset_cache-&gt;cache_filter
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|iops-&gt;symlink
)paren
(brace
id|EXIT
suffix:semicolon
r_goto
id|exit_lock
suffix:semicolon
)brace
id|presto_getversion
c_func
(paren
op_amp
id|tgt_dir_ver
comma
id|dir-&gt;d_inode
)paren
suffix:semicolon
id|handle
op_assign
id|presto_trans_start
c_func
(paren
id|fset
comma
id|dir-&gt;d_inode
comma
id|PRESTO_OP_SYMLINK
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|handle
)paren
)paren
(brace
id|presto_release_space
c_func
(paren
id|fset-&gt;fset_cache
comma
id|PRESTO_REQHIGH
op_plus
l_int|4096
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;ERROR: presto_do_symlink: no space for transaction. Tell Peter.&bslash;n&quot;
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
op_minus
id|ENOSPC
suffix:semicolon
)brace
id|DQUOT_INIT
c_func
(paren
id|dir-&gt;d_inode
)paren
suffix:semicolon
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
id|error
op_assign
id|iops
op_member_access_from_pointer
id|symlink
c_func
(paren
id|dir-&gt;d_inode
comma
id|dentry
comma
id|oldname
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dentry-&gt;d_inode
op_logical_and
id|dentry-&gt;d_inode-&gt;i_gid
op_ne
id|presto_excluded_gid
)paren
(brace
r_struct
id|presto_cache
op_star
id|cache
op_assign
id|fset-&gt;fset_cache
suffix:semicolon
id|presto_set_ops
c_func
(paren
id|dentry-&gt;d_inode
comma
id|cache-&gt;cache_filter
)paren
suffix:semicolon
id|filter_setup_dentry_ops
c_func
(paren
id|cache-&gt;cache_filter
comma
id|dentry-&gt;d_op
comma
op_amp
id|presto_dentry_ops
)paren
suffix:semicolon
id|dentry-&gt;d_op
op_assign
id|filter_c2udops
c_func
(paren
id|cache-&gt;cache_filter
)paren
suffix:semicolon
multiline_comment|/* XXX ? Cache state ? if Lento creates a symlink */
r_if
c_cond
(paren
id|ISLENTO
c_func
(paren
id|presto_c2m
c_func
(paren
id|cache
)paren
)paren
)paren
(brace
id|presto_set
c_func
(paren
id|dentry
comma
id|PRESTO_ATTR
)paren
suffix:semicolon
)brace
r_else
(brace
id|presto_set
c_func
(paren
id|dentry
comma
id|PRESTO_ATTR
op_or
id|PRESTO_DATA
)paren
suffix:semicolon
)brace
)brace
id|error
op_assign
id|presto_settime
c_func
(paren
id|fset
comma
id|dir
comma
id|info
comma
id|ATTR_CTIME
op_or
id|ATTR_MTIME
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
id|error
op_assign
id|presto_settime
c_func
(paren
id|fset
comma
id|dentry
comma
id|info
comma
id|ATTR_CTIME
op_or
id|ATTR_MTIME
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
id|presto_debug_fail_blkdev
c_func
(paren
id|fset
comma
id|PRESTO_OP_SYMLINK
op_or
l_int|0x10
)paren
suffix:semicolon
id|presto_getversion
c_func
(paren
op_amp
id|new_link_ver
comma
id|dentry-&gt;d_inode
)paren
suffix:semicolon
r_if
c_cond
(paren
id|presto_do_kml
c_func
(paren
id|info
comma
id|dentry-&gt;d_inode
)paren
)paren
id|error
op_assign
id|presto_journal_symlink
c_func
(paren
op_amp
id|rec
comma
id|fset
comma
id|dentry
comma
id|oldname
comma
op_amp
id|tgt_dir_ver
comma
op_amp
id|new_link_ver
)paren
suffix:semicolon
id|presto_debug_fail_blkdev
c_func
(paren
id|fset
comma
id|PRESTO_OP_SYMLINK
op_or
l_int|0x20
)paren
suffix:semicolon
r_if
c_cond
(paren
id|presto_do_expect
c_func
(paren
id|info
comma
id|dentry-&gt;d_inode
)paren
)paren
id|error
op_assign
id|presto_write_last_rcvd
c_func
(paren
op_amp
id|rec
comma
id|fset
comma
id|info
)paren
suffix:semicolon
id|presto_debug_fail_blkdev
c_func
(paren
id|fset
comma
id|PRESTO_OP_SYMLINK
op_or
l_int|0x30
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
m_exit
suffix:colon
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
id|presto_trans_commit
c_func
(paren
id|fset
comma
id|handle
)paren
suffix:semicolon
id|exit_lock
suffix:colon
id|presto_release_space
c_func
(paren
id|fset-&gt;fset_cache
comma
id|PRESTO_REQHIGH
op_plus
l_int|4096
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|dir-&gt;d_inode-&gt;i_zombie
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|function|lento_symlink
r_int
id|lento_symlink
c_func
(paren
r_const
r_char
op_star
id|oldname
comma
r_const
r_char
op_star
id|newname
comma
r_struct
id|lento_vfs_context
op_star
id|info
)paren
(brace
r_int
id|error
suffix:semicolon
r_char
op_star
id|from
suffix:semicolon
r_char
op_star
id|to
suffix:semicolon
r_struct
id|dentry
op_star
id|dentry
suffix:semicolon
r_struct
id|presto_file_set
op_star
id|fset
suffix:semicolon
r_struct
id|nameidata
id|nd
suffix:semicolon
id|ENTRY
suffix:semicolon
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
id|from
op_assign
id|getname
c_func
(paren
id|oldname
)paren
suffix:semicolon
id|error
op_assign
id|PTR_ERR
c_func
(paren
id|from
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|from
)paren
)paren
(brace
id|EXIT
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
id|to
op_assign
id|getname
c_func
(paren
id|newname
)paren
suffix:semicolon
id|error
op_assign
id|PTR_ERR
c_func
(paren
id|to
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|to
)paren
)paren
(brace
id|EXIT
suffix:semicolon
r_goto
id|exit_from
suffix:semicolon
)brace
r_if
c_cond
(paren
id|path_init
c_func
(paren
id|to
comma
id|LOOKUP_PARENT
comma
op_amp
id|nd
)paren
)paren
id|error
op_assign
id|path_walk
c_func
(paren
id|to
comma
op_amp
id|nd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_goto
id|exit_to
suffix:semicolon
)brace
id|dentry
op_assign
id|lookup_create
c_func
(paren
op_amp
id|nd
comma
l_int|0
)paren
suffix:semicolon
id|error
op_assign
id|PTR_ERR
c_func
(paren
id|dentry
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|dentry
)paren
)paren
(brace
id|path_release
c_func
(paren
op_amp
id|nd
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_goto
id|exit_to
suffix:semicolon
)brace
id|fset
op_assign
id|presto_fset
c_func
(paren
id|dentry
)paren
suffix:semicolon
id|error
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fset
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;No fileset!&bslash;n&quot;
)paren
suffix:semicolon
id|path_release
c_func
(paren
op_amp
id|nd
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_goto
id|exit_lock
suffix:semicolon
)brace
id|error
op_assign
id|presto_do_symlink
c_func
(paren
id|fset
comma
id|nd.dentry
comma
id|dentry
comma
id|oldname
comma
id|info
)paren
suffix:semicolon
id|path_release
c_func
(paren
op_amp
id|nd
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
id|exit_lock
suffix:colon
id|up
c_func
(paren
op_amp
id|nd.dentry-&gt;d_inode-&gt;i_sem
)paren
suffix:semicolon
id|dput
c_func
(paren
id|dentry
)paren
suffix:semicolon
id|exit_to
suffix:colon
id|putname
c_func
(paren
id|to
)paren
suffix:semicolon
id|exit_from
suffix:colon
id|putname
c_func
(paren
id|from
)paren
suffix:semicolon
m_exit
suffix:colon
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|function|presto_do_mkdir
r_int
id|presto_do_mkdir
c_func
(paren
r_struct
id|presto_file_set
op_star
id|fset
comma
r_struct
id|dentry
op_star
id|dir
comma
r_struct
id|dentry
op_star
id|dentry
comma
r_int
id|mode
comma
r_struct
id|lento_vfs_context
op_star
id|info
)paren
(brace
r_struct
id|rec_info
id|rec
suffix:semicolon
r_int
id|error
suffix:semicolon
r_struct
id|presto_version
id|tgt_dir_ver
comma
id|new_dir_ver
suffix:semicolon
r_void
op_star
id|handle
suffix:semicolon
id|ENTRY
suffix:semicolon
id|down
c_func
(paren
op_amp
id|dir-&gt;d_inode-&gt;i_zombie
)paren
suffix:semicolon
multiline_comment|/* one journal record + directory block + room for removals*/
id|error
op_assign
id|presto_reserve_space
c_func
(paren
id|fset-&gt;fset_cache
comma
id|PRESTO_REQHIGH
op_plus
l_int|4096
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
id|up
c_func
(paren
op_amp
id|dir-&gt;d_inode-&gt;i_zombie
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|error
op_assign
id|may_create
c_func
(paren
id|dir-&gt;d_inode
comma
id|dentry
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_goto
id|exit_lock
suffix:semicolon
)brace
id|error
op_assign
op_minus
id|EPERM
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|filter_c2cdiops
c_func
(paren
id|fset-&gt;fset_cache-&gt;cache_filter
)paren
op_member_access_from_pointer
id|mkdir
)paren
(brace
id|EXIT
suffix:semicolon
r_goto
id|exit_lock
suffix:semicolon
)brace
id|error
op_assign
op_minus
id|ENOSPC
suffix:semicolon
id|presto_getversion
c_func
(paren
op_amp
id|tgt_dir_ver
comma
id|dir-&gt;d_inode
)paren
suffix:semicolon
id|handle
op_assign
id|presto_trans_start
c_func
(paren
id|fset
comma
id|dir-&gt;d_inode
comma
id|PRESTO_OP_MKDIR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|handle
)paren
)paren
(brace
id|presto_release_space
c_func
(paren
id|fset-&gt;fset_cache
comma
id|PRESTO_REQHIGH
op_plus
l_int|4096
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;presto_do_mkdir: no space for transaction&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|exit_lock
suffix:semicolon
)brace
id|DQUOT_INIT
c_func
(paren
id|dir-&gt;d_inode
)paren
suffix:semicolon
id|mode
op_and_assign
(paren
id|S_IRWXUGO
op_or
id|S_ISVTX
)paren
suffix:semicolon
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
id|error
op_assign
id|filter_c2cdiops
c_func
(paren
id|fset-&gt;fset_cache-&gt;cache_filter
)paren
op_member_access_from_pointer
id|mkdir
c_func
(paren
id|dir-&gt;d_inode
comma
id|dentry
comma
id|mode
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dentry-&gt;d_inode
op_logical_and
op_logical_neg
id|error
op_logical_and
id|dentry-&gt;d_inode-&gt;i_gid
op_ne
id|presto_excluded_gid
)paren
(brace
r_struct
id|presto_cache
op_star
id|cache
op_assign
id|fset-&gt;fset_cache
suffix:semicolon
id|presto_set_ops
c_func
(paren
id|dentry-&gt;d_inode
comma
id|cache-&gt;cache_filter
)paren
suffix:semicolon
id|filter_setup_dentry_ops
c_func
(paren
id|cache-&gt;cache_filter
comma
id|dentry-&gt;d_op
comma
op_amp
id|presto_dentry_ops
)paren
suffix:semicolon
id|dentry-&gt;d_op
op_assign
id|filter_c2udops
c_func
(paren
id|cache-&gt;cache_filter
)paren
suffix:semicolon
multiline_comment|/* if Lento does this, we won&squot;t have data */
r_if
c_cond
(paren
id|ISLENTO
c_func
(paren
id|presto_c2m
c_func
(paren
id|cache
)paren
)paren
)paren
(brace
id|presto_set
c_func
(paren
id|dentry
comma
id|PRESTO_ATTR
)paren
suffix:semicolon
)brace
r_else
(brace
id|presto_set
c_func
(paren
id|dentry
comma
id|PRESTO_ATTR
op_or
id|PRESTO_DATA
)paren
suffix:semicolon
)brace
)brace
id|error
op_assign
id|presto_settime
c_func
(paren
id|fset
comma
id|dir
comma
id|info
comma
id|ATTR_CTIME
op_or
id|ATTR_MTIME
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
id|error
op_assign
id|presto_settime
c_func
(paren
id|fset
comma
id|dentry
comma
id|info
comma
id|ATTR_CTIME
op_or
id|ATTR_MTIME
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
id|presto_debug_fail_blkdev
c_func
(paren
id|fset
comma
id|PRESTO_OP_MKDIR
op_or
l_int|0x10
)paren
suffix:semicolon
id|presto_getversion
c_func
(paren
op_amp
id|new_dir_ver
comma
id|dentry-&gt;d_inode
)paren
suffix:semicolon
r_if
c_cond
(paren
id|presto_do_kml
c_func
(paren
id|info
comma
id|dentry-&gt;d_inode
)paren
)paren
id|error
op_assign
id|presto_journal_mkdir
c_func
(paren
op_amp
id|rec
comma
id|fset
comma
id|dentry
comma
op_amp
id|tgt_dir_ver
comma
op_amp
id|new_dir_ver
comma
id|dentry-&gt;d_inode-&gt;i_mode
)paren
suffix:semicolon
id|presto_debug_fail_blkdev
c_func
(paren
id|fset
comma
id|PRESTO_OP_MKDIR
op_or
l_int|0x20
)paren
suffix:semicolon
r_if
c_cond
(paren
id|presto_do_expect
c_func
(paren
id|info
comma
id|dentry-&gt;d_inode
)paren
)paren
id|error
op_assign
id|presto_write_last_rcvd
c_func
(paren
op_amp
id|rec
comma
id|fset
comma
id|info
)paren
suffix:semicolon
id|presto_debug_fail_blkdev
c_func
(paren
id|fset
comma
id|PRESTO_OP_MKDIR
op_or
l_int|0x30
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
m_exit
suffix:colon
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
id|presto_trans_commit
c_func
(paren
id|fset
comma
id|handle
)paren
suffix:semicolon
id|exit_lock
suffix:colon
id|presto_release_space
c_func
(paren
id|fset-&gt;fset_cache
comma
id|PRESTO_REQHIGH
op_plus
l_int|4096
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|dir-&gt;d_inode-&gt;i_zombie
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
multiline_comment|/*&n; * Look out: this function may change a normal dentry&n; * into a directory dentry (different size)..&n; */
DECL|function|lento_mkdir
r_int
id|lento_mkdir
c_func
(paren
r_const
r_char
op_star
id|name
comma
r_int
id|mode
comma
r_struct
id|lento_vfs_context
op_star
id|info
)paren
(brace
r_int
id|error
suffix:semicolon
r_char
op_star
id|pathname
suffix:semicolon
r_struct
id|dentry
op_star
id|dentry
suffix:semicolon
r_struct
id|presto_file_set
op_star
id|fset
suffix:semicolon
r_struct
id|nameidata
id|nd
suffix:semicolon
id|ENTRY
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_PIOCTL
comma
l_string|&quot;name: %s, mode %o, offset %d, recno %d, flags %x&bslash;n&quot;
comma
id|name
comma
id|mode
comma
id|info-&gt;slot_offset
comma
id|info-&gt;recno
comma
id|info-&gt;flags
)paren
suffix:semicolon
id|pathname
op_assign
id|getname
c_func
(paren
id|name
)paren
suffix:semicolon
id|error
op_assign
id|PTR_ERR
c_func
(paren
id|pathname
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|pathname
)paren
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
r_if
c_cond
(paren
id|path_init
c_func
(paren
id|pathname
comma
id|LOOKUP_PARENT
comma
op_amp
id|nd
)paren
)paren
id|error
op_assign
id|path_walk
c_func
(paren
id|pathname
comma
op_amp
id|nd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_goto
id|out_name
suffix:semicolon
id|dentry
op_assign
id|lookup_create
c_func
(paren
op_amp
id|nd
comma
l_int|1
)paren
suffix:semicolon
id|error
op_assign
id|PTR_ERR
c_func
(paren
id|dentry
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|IS_ERR
c_func
(paren
id|dentry
)paren
)paren
(brace
id|fset
op_assign
id|presto_fset
c_func
(paren
id|dentry
)paren
suffix:semicolon
id|error
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fset
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;No fileset!&bslash;n&quot;
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_goto
id|out_dput
suffix:semicolon
)brace
id|error
op_assign
id|presto_do_mkdir
c_func
(paren
id|fset
comma
id|nd.dentry
comma
id|dentry
comma
id|mode
op_amp
id|S_IALLUGO
comma
id|info
)paren
suffix:semicolon
id|out_dput
suffix:colon
id|dput
c_func
(paren
id|dentry
)paren
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|nd.dentry-&gt;d_inode-&gt;i_sem
)paren
suffix:semicolon
id|path_release
c_func
(paren
op_amp
id|nd
)paren
suffix:semicolon
id|out_name
suffix:colon
id|EXIT
suffix:semicolon
id|putname
c_func
(paren
id|pathname
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_PIOCTL
comma
l_string|&quot;error: %d&bslash;n&quot;
comma
id|error
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|function|d_unhash
r_static
r_void
id|d_unhash
c_func
(paren
r_struct
id|dentry
op_star
id|dentry
)paren
(brace
id|dget
c_func
(paren
id|dentry
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|dentry-&gt;d_count
)paren
)paren
(brace
r_default
suffix:colon
id|shrink_dcache_parent
c_func
(paren
id|dentry
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|dentry-&gt;d_count
)paren
op_ne
l_int|2
)paren
r_break
suffix:semicolon
r_case
l_int|2
suffix:colon
id|d_drop
c_func
(paren
id|dentry
)paren
suffix:semicolon
)brace
)brace
DECL|function|presto_do_rmdir
r_int
id|presto_do_rmdir
c_func
(paren
r_struct
id|presto_file_set
op_star
id|fset
comma
r_struct
id|dentry
op_star
id|dir
comma
r_struct
id|dentry
op_star
id|dentry
comma
r_struct
id|lento_vfs_context
op_star
id|info
)paren
(brace
r_struct
id|rec_info
id|rec
suffix:semicolon
r_int
id|error
suffix:semicolon
r_struct
id|presto_version
id|tgt_dir_ver
comma
id|old_dir_ver
suffix:semicolon
r_struct
id|inode_operations
op_star
id|iops
suffix:semicolon
r_void
op_star
id|handle
suffix:semicolon
r_int
id|do_kml
comma
id|do_expect
suffix:semicolon
r_int
id|size
suffix:semicolon
id|ENTRY
suffix:semicolon
id|error
op_assign
id|may_delete
c_func
(paren
id|dir-&gt;d_inode
comma
id|dentry
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_return
id|error
suffix:semicolon
id|error
op_assign
op_minus
id|EPERM
suffix:semicolon
id|iops
op_assign
id|filter_c2cdiops
c_func
(paren
id|fset-&gt;fset_cache-&gt;cache_filter
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|iops-&gt;rmdir
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|size
op_assign
id|PRESTO_REQHIGH
op_minus
id|dentry-&gt;d_inode-&gt;i_size
suffix:semicolon
id|error
op_assign
id|presto_reserve_space
c_func
(paren
id|fset-&gt;fset_cache
comma
id|size
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|presto_getversion
c_func
(paren
op_amp
id|tgt_dir_ver
comma
id|dir-&gt;d_inode
)paren
suffix:semicolon
id|presto_getversion
c_func
(paren
op_amp
id|old_dir_ver
comma
id|dentry-&gt;d_inode
)paren
suffix:semicolon
id|handle
op_assign
id|presto_trans_start
c_func
(paren
id|fset
comma
id|dir-&gt;d_inode
comma
id|PRESTO_OP_RMDIR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|handle
)paren
)paren
(brace
id|presto_release_space
c_func
(paren
id|fset-&gt;fset_cache
comma
id|size
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;ERROR: presto_do_rmdir: no space for transaction. Tell Peter.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOSPC
suffix:semicolon
)brace
id|DQUOT_INIT
c_func
(paren
id|dir-&gt;d_inode
)paren
suffix:semicolon
id|do_kml
op_assign
id|presto_do_kml
c_func
(paren
id|info
comma
id|dir-&gt;d_inode
)paren
suffix:semicolon
id|do_expect
op_assign
id|presto_do_expect
c_func
(paren
id|info
comma
id|dir-&gt;d_inode
)paren
suffix:semicolon
id|double_down
c_func
(paren
op_amp
id|dir-&gt;d_inode-&gt;i_zombie
comma
op_amp
id|dentry-&gt;d_inode-&gt;i_zombie
)paren
suffix:semicolon
id|d_unhash
c_func
(paren
id|dentry
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_DEADDIR
c_func
(paren
id|dir-&gt;d_inode
)paren
)paren
id|error
op_assign
op_minus
id|ENOENT
suffix:semicolon
r_else
r_if
c_cond
(paren
id|d_mountpoint
c_func
(paren
id|dentry
)paren
)paren
id|error
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_else
(brace
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
id|error
op_assign
id|iops
op_member_access_from_pointer
id|rmdir
c_func
(paren
id|dir-&gt;d_inode
comma
id|dentry
)paren
suffix:semicolon
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|error
)paren
(brace
id|dentry-&gt;d_inode-&gt;i_flags
op_or_assign
id|S_DEAD
suffix:semicolon
id|error
op_assign
id|presto_settime
c_func
(paren
id|fset
comma
id|dir
comma
id|info
comma
id|ATTR_CTIME
op_or
id|ATTR_MTIME
)paren
suffix:semicolon
)brace
)brace
id|double_up
c_func
(paren
op_amp
id|dir-&gt;d_inode-&gt;i_zombie
comma
op_amp
id|dentry-&gt;d_inode-&gt;i_zombie
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|error
)paren
id|d_delete
c_func
(paren
id|dentry
)paren
suffix:semicolon
id|dput
c_func
(paren
id|dentry
)paren
suffix:semicolon
id|presto_debug_fail_blkdev
c_func
(paren
id|fset
comma
id|PRESTO_OP_RMDIR
op_or
l_int|0x10
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|error
op_logical_and
id|do_kml
)paren
id|error
op_assign
id|presto_journal_rmdir
c_func
(paren
op_amp
id|rec
comma
id|fset
comma
id|dir
comma
op_amp
id|tgt_dir_ver
comma
op_amp
id|old_dir_ver
comma
id|dentry-&gt;d_name.len
comma
id|dentry-&gt;d_name.name
)paren
suffix:semicolon
id|presto_debug_fail_blkdev
c_func
(paren
id|fset
comma
id|PRESTO_OP_RMDIR
op_or
l_int|0x20
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|error
op_logical_and
id|do_expect
)paren
id|error
op_assign
id|presto_write_last_rcvd
c_func
(paren
op_amp
id|rec
comma
id|fset
comma
id|info
)paren
suffix:semicolon
id|presto_debug_fail_blkdev
c_func
(paren
id|fset
comma
id|PRESTO_OP_RMDIR
op_or
l_int|0x30
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
id|presto_trans_commit
c_func
(paren
id|fset
comma
id|handle
)paren
suffix:semicolon
id|presto_release_space
c_func
(paren
id|fset-&gt;fset_cache
comma
id|size
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|function|lento_rmdir
r_int
id|lento_rmdir
c_func
(paren
r_const
r_char
op_star
id|pathname
comma
r_struct
id|lento_vfs_context
op_star
id|info
)paren
(brace
r_int
id|error
op_assign
l_int|0
suffix:semicolon
r_char
op_star
id|name
suffix:semicolon
r_struct
id|dentry
op_star
id|dentry
suffix:semicolon
r_struct
id|presto_file_set
op_star
id|fset
suffix:semicolon
r_struct
id|nameidata
id|nd
suffix:semicolon
id|ENTRY
suffix:semicolon
id|name
op_assign
id|getname
c_func
(paren
id|pathname
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|name
)paren
)paren
(brace
r_return
id|PTR_ERR
c_func
(paren
id|name
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|path_init
c_func
(paren
id|name
comma
id|LOOKUP_PARENT
comma
op_amp
id|nd
)paren
)paren
id|error
op_assign
id|path_walk
c_func
(paren
id|name
comma
op_amp
id|nd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_goto
m_exit
suffix:semicolon
r_switch
c_cond
(paren
id|nd.last_type
)paren
(brace
r_case
id|LAST_DOTDOT
suffix:colon
id|error
op_assign
op_minus
id|ENOTEMPTY
suffix:semicolon
r_goto
id|exit1
suffix:semicolon
r_case
id|LAST_ROOT
suffix:colon
r_case
id|LAST_DOT
suffix:colon
id|error
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_goto
id|exit1
suffix:semicolon
)brace
id|down
c_func
(paren
op_amp
id|nd.dentry-&gt;d_inode-&gt;i_sem
)paren
suffix:semicolon
id|dentry
op_assign
id|lookup_hash
c_func
(paren
op_amp
id|nd.last
comma
id|nd.dentry
)paren
suffix:semicolon
id|error
op_assign
id|PTR_ERR
c_func
(paren
id|dentry
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|IS_ERR
c_func
(paren
id|dentry
)paren
)paren
(brace
id|fset
op_assign
id|presto_fset
c_func
(paren
id|dentry
)paren
suffix:semicolon
id|error
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fset
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;No fileset!&bslash;n&quot;
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_goto
id|exit_put
suffix:semicolon
)brace
id|error
op_assign
id|presto_do_rmdir
c_func
(paren
id|fset
comma
id|nd.dentry
comma
id|dentry
comma
id|info
)paren
suffix:semicolon
id|exit_put
suffix:colon
id|dput
c_func
(paren
id|dentry
)paren
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|nd.dentry-&gt;d_inode-&gt;i_sem
)paren
suffix:semicolon
id|exit1
suffix:colon
id|EXIT
suffix:semicolon
id|path_release
c_func
(paren
op_amp
id|nd
)paren
suffix:semicolon
m_exit
suffix:colon
id|EXIT
suffix:semicolon
id|putname
c_func
(paren
id|name
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|function|presto_do_mknod
r_int
id|presto_do_mknod
c_func
(paren
r_struct
id|presto_file_set
op_star
id|fset
comma
r_struct
id|dentry
op_star
id|dir
comma
r_struct
id|dentry
op_star
id|dentry
comma
r_int
id|mode
comma
id|dev_t
id|dev
comma
r_struct
id|lento_vfs_context
op_star
id|info
)paren
(brace
r_struct
id|rec_info
id|rec
suffix:semicolon
r_int
id|error
op_assign
op_minus
id|EPERM
suffix:semicolon
r_struct
id|presto_version
id|tgt_dir_ver
comma
id|new_node_ver
suffix:semicolon
r_struct
id|inode_operations
op_star
id|iops
suffix:semicolon
r_void
op_star
id|handle
suffix:semicolon
id|ENTRY
suffix:semicolon
id|down
c_func
(paren
op_amp
id|dir-&gt;d_inode-&gt;i_zombie
)paren
suffix:semicolon
multiline_comment|/* one KML entry */
id|error
op_assign
id|presto_reserve_space
c_func
(paren
id|fset-&gt;fset_cache
comma
id|PRESTO_REQHIGH
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
id|up
c_func
(paren
op_amp
id|dir-&gt;d_inode-&gt;i_zombie
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|S_ISCHR
c_func
(paren
id|mode
)paren
op_logical_or
id|S_ISBLK
c_func
(paren
id|mode
)paren
)paren
op_logical_and
op_logical_neg
id|capable
c_func
(paren
id|CAP_MKNOD
)paren
)paren
(brace
id|EXIT
suffix:semicolon
r_goto
id|exit_lock
suffix:semicolon
)brace
id|error
op_assign
id|may_create
c_func
(paren
id|dir-&gt;d_inode
comma
id|dentry
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_goto
id|exit_lock
suffix:semicolon
)brace
id|error
op_assign
op_minus
id|EPERM
suffix:semicolon
id|iops
op_assign
id|filter_c2cdiops
c_func
(paren
id|fset-&gt;fset_cache-&gt;cache_filter
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|iops-&gt;mknod
)paren
(brace
id|EXIT
suffix:semicolon
r_goto
id|exit_lock
suffix:semicolon
)brace
id|DQUOT_INIT
c_func
(paren
id|dir-&gt;d_inode
)paren
suffix:semicolon
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
id|error
op_assign
op_minus
id|ENOSPC
suffix:semicolon
id|presto_getversion
c_func
(paren
op_amp
id|tgt_dir_ver
comma
id|dir-&gt;d_inode
)paren
suffix:semicolon
id|handle
op_assign
id|presto_trans_start
c_func
(paren
id|fset
comma
id|dir-&gt;d_inode
comma
id|PRESTO_OP_MKNOD
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|handle
)paren
)paren
(brace
id|presto_release_space
c_func
(paren
id|fset-&gt;fset_cache
comma
id|PRESTO_REQHIGH
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;presto_do_mknod: no space for transaction&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|exit_lock2
suffix:semicolon
)brace
id|error
op_assign
id|iops
op_member_access_from_pointer
id|mknod
c_func
(paren
id|dir-&gt;d_inode
comma
id|dentry
comma
id|mode
comma
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dentry-&gt;d_inode
op_logical_and
id|dentry-&gt;d_inode-&gt;i_gid
op_ne
id|presto_excluded_gid
)paren
(brace
r_struct
id|presto_cache
op_star
id|cache
op_assign
id|fset-&gt;fset_cache
suffix:semicolon
id|presto_set_ops
c_func
(paren
id|dentry-&gt;d_inode
comma
id|cache-&gt;cache_filter
)paren
suffix:semicolon
id|filter_setup_dentry_ops
c_func
(paren
id|cache-&gt;cache_filter
comma
id|dentry-&gt;d_op
comma
op_amp
id|presto_dentry_ops
)paren
suffix:semicolon
id|dentry-&gt;d_op
op_assign
id|filter_c2udops
c_func
(paren
id|cache-&gt;cache_filter
)paren
suffix:semicolon
multiline_comment|/* if Lento does this, we won&squot;t have data */
r_if
c_cond
(paren
id|ISLENTO
c_func
(paren
id|presto_c2m
c_func
(paren
id|cache
)paren
)paren
)paren
(brace
id|presto_set
c_func
(paren
id|dentry
comma
id|PRESTO_ATTR
)paren
suffix:semicolon
)brace
r_else
(brace
id|presto_set
c_func
(paren
id|dentry
comma
id|PRESTO_ATTR
op_or
id|PRESTO_DATA
)paren
suffix:semicolon
)brace
)brace
id|error
op_assign
id|presto_settime
c_func
(paren
id|fset
comma
id|dir
comma
id|info
comma
id|ATTR_MTIME
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
)brace
id|error
op_assign
id|presto_settime
c_func
(paren
id|fset
comma
id|dentry
comma
id|info
comma
id|ATTR_CTIME
op_or
id|ATTR_MTIME
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
)brace
id|presto_debug_fail_blkdev
c_func
(paren
id|fset
comma
id|PRESTO_OP_MKNOD
op_or
l_int|0x10
)paren
suffix:semicolon
id|presto_getversion
c_func
(paren
op_amp
id|new_node_ver
comma
id|dentry-&gt;d_inode
)paren
suffix:semicolon
r_if
c_cond
(paren
id|presto_do_kml
c_func
(paren
id|info
comma
id|dentry-&gt;d_inode
)paren
)paren
id|error
op_assign
id|presto_journal_mknod
c_func
(paren
op_amp
id|rec
comma
id|fset
comma
id|dentry
comma
op_amp
id|tgt_dir_ver
comma
op_amp
id|new_node_ver
comma
id|dentry-&gt;d_inode-&gt;i_mode
comma
id|MAJOR
c_func
(paren
id|dev
)paren
comma
id|MINOR
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
id|presto_debug_fail_blkdev
c_func
(paren
id|fset
comma
id|PRESTO_OP_MKNOD
op_or
l_int|0x20
)paren
suffix:semicolon
r_if
c_cond
(paren
id|presto_do_expect
c_func
(paren
id|info
comma
id|dentry-&gt;d_inode
)paren
)paren
id|error
op_assign
id|presto_write_last_rcvd
c_func
(paren
op_amp
id|rec
comma
id|fset
comma
id|info
)paren
suffix:semicolon
id|presto_debug_fail_blkdev
c_func
(paren
id|fset
comma
id|PRESTO_OP_MKNOD
op_or
l_int|0x30
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
id|presto_trans_commit
c_func
(paren
id|fset
comma
id|handle
)paren
suffix:semicolon
id|exit_lock2
suffix:colon
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
id|exit_lock
suffix:colon
id|presto_release_space
c_func
(paren
id|fset-&gt;fset_cache
comma
id|PRESTO_REQHIGH
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|dir-&gt;d_inode-&gt;i_zombie
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|function|lento_mknod
r_int
id|lento_mknod
c_func
(paren
r_const
r_char
op_star
id|filename
comma
r_int
id|mode
comma
id|dev_t
id|dev
comma
r_struct
id|lento_vfs_context
op_star
id|info
)paren
(brace
r_int
id|error
op_assign
l_int|0
suffix:semicolon
r_char
op_star
id|tmp
suffix:semicolon
r_struct
id|dentry
op_star
id|dentry
suffix:semicolon
r_struct
id|nameidata
id|nd
suffix:semicolon
r_struct
id|presto_file_set
op_star
id|fset
suffix:semicolon
id|ENTRY
suffix:semicolon
r_if
c_cond
(paren
id|S_ISDIR
c_func
(paren
id|mode
)paren
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
id|tmp
op_assign
id|getname
c_func
(paren
id|filename
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|tmp
)paren
)paren
r_return
id|PTR_ERR
c_func
(paren
id|tmp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|path_init
c_func
(paren
id|tmp
comma
id|LOOKUP_PARENT
comma
op_amp
id|nd
)paren
)paren
id|error
op_assign
id|path_walk
c_func
(paren
id|tmp
comma
op_amp
id|nd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_goto
id|out
suffix:semicolon
id|dentry
op_assign
id|lookup_create
c_func
(paren
op_amp
id|nd
comma
l_int|0
)paren
suffix:semicolon
id|error
op_assign
id|PTR_ERR
c_func
(paren
id|dentry
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|IS_ERR
c_func
(paren
id|dentry
)paren
)paren
(brace
id|fset
op_assign
id|presto_fset
c_func
(paren
id|dentry
)paren
suffix:semicolon
id|error
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fset
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;No fileset!&bslash;n&quot;
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_goto
id|exit_put
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|mode
op_amp
id|S_IFMT
)paren
(brace
r_case
l_int|0
suffix:colon
r_case
id|S_IFREG
suffix:colon
id|error
op_assign
op_minus
id|EOPNOTSUPP
suffix:semicolon
r_break
suffix:semicolon
r_case
id|S_IFCHR
suffix:colon
r_case
id|S_IFBLK
suffix:colon
r_case
id|S_IFIFO
suffix:colon
r_case
id|S_IFSOCK
suffix:colon
id|error
op_assign
id|presto_do_mknod
c_func
(paren
id|fset
comma
id|nd.dentry
comma
id|dentry
comma
id|mode
comma
id|dev
comma
id|info
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|S_IFDIR
suffix:colon
id|error
op_assign
op_minus
id|EPERM
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|error
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
id|exit_put
suffix:colon
id|dput
c_func
(paren
id|dentry
)paren
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|nd.dentry-&gt;d_inode-&gt;i_sem
)paren
suffix:semicolon
id|path_release
c_func
(paren
op_amp
id|nd
)paren
suffix:semicolon
id|out
suffix:colon
id|putname
c_func
(paren
id|tmp
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|function|do_rename
r_static
r_int
id|do_rename
c_func
(paren
r_struct
id|presto_file_set
op_star
id|fset
comma
r_struct
id|dentry
op_star
id|old_parent
comma
r_struct
id|dentry
op_star
id|old_dentry
comma
r_struct
id|dentry
op_star
id|new_parent
comma
r_struct
id|dentry
op_star
id|new_dentry
comma
r_struct
id|lento_vfs_context
op_star
id|info
)paren
(brace
r_struct
id|rec_info
id|rec
suffix:semicolon
r_int
id|error
suffix:semicolon
r_struct
id|inode_operations
op_star
id|iops
suffix:semicolon
r_struct
id|presto_version
id|src_dir_ver
comma
id|tgt_dir_ver
suffix:semicolon
r_void
op_star
id|handle
suffix:semicolon
r_int
id|new_inode_unlink
op_assign
l_int|0
suffix:semicolon
r_struct
id|inode
op_star
id|old_dir
op_assign
id|old_parent-&gt;d_inode
suffix:semicolon
r_struct
id|inode
op_star
id|new_dir
op_assign
id|new_parent-&gt;d_inode
suffix:semicolon
id|ENTRY
suffix:semicolon
id|presto_getversion
c_func
(paren
op_amp
id|src_dir_ver
comma
id|old_dir
)paren
suffix:semicolon
id|presto_getversion
c_func
(paren
op_amp
id|tgt_dir_ver
comma
id|new_dir
)paren
suffix:semicolon
id|error
op_assign
op_minus
id|EPERM
suffix:semicolon
id|iops
op_assign
id|filter_c2cdiops
c_func
(paren
id|fset-&gt;fset_cache-&gt;cache_filter
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|iops
op_logical_or
op_logical_neg
id|iops-&gt;rename
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|error
op_assign
id|presto_reserve_space
c_func
(paren
id|fset-&gt;fset_cache
comma
id|PRESTO_REQHIGH
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|handle
op_assign
id|presto_trans_start
c_func
(paren
id|fset
comma
id|old_dir
comma
id|PRESTO_OP_RENAME
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|handle
)paren
)paren
(brace
id|presto_release_space
c_func
(paren
id|fset-&gt;fset_cache
comma
id|PRESTO_REQHIGH
)paren
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;presto_do_rename: no space for transaction&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOSPC
suffix:semicolon
)brace
r_if
c_cond
(paren
id|new_dentry-&gt;d_inode
op_logical_and
id|new_dentry-&gt;d_inode-&gt;i_nlink
OG
l_int|1
)paren
(brace
id|dget
c_func
(paren
id|new_dentry
)paren
suffix:semicolon
id|new_inode_unlink
op_assign
l_int|1
suffix:semicolon
)brace
id|error
op_assign
id|iops
op_member_access_from_pointer
id|rename
c_func
(paren
id|old_dir
comma
id|old_dentry
comma
id|new_dir
comma
id|new_dentry
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
r_if
c_cond
(paren
id|new_inode_unlink
)paren
(brace
id|error
op_assign
id|presto_settime
c_func
(paren
id|fset
comma
id|old_dentry
comma
id|info
comma
id|ATTR_CTIME
)paren
suffix:semicolon
id|dput
c_func
(paren
id|old_dentry
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
)brace
id|error
op_assign
id|presto_settime
c_func
(paren
id|fset
comma
id|old_parent
comma
id|info
comma
id|ATTR_CTIME
op_or
id|ATTR_MTIME
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
id|error
op_assign
id|presto_settime
c_func
(paren
id|fset
comma
id|new_parent
comma
id|info
comma
id|ATTR_CTIME
op_or
id|ATTR_MTIME
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
multiline_comment|/* XXX make a distinction between cross file set&n;         * and intra file set renames here&n;         */
id|presto_debug_fail_blkdev
c_func
(paren
id|fset
comma
id|PRESTO_OP_RENAME
op_or
l_int|0x10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|presto_do_kml
c_func
(paren
id|info
comma
id|old_dir
)paren
)paren
id|error
op_assign
id|presto_journal_rename
c_func
(paren
op_amp
id|rec
comma
id|fset
comma
id|old_dentry
comma
id|new_dentry
comma
op_amp
id|src_dir_ver
comma
op_amp
id|tgt_dir_ver
)paren
suffix:semicolon
id|presto_debug_fail_blkdev
c_func
(paren
id|fset
comma
id|PRESTO_OP_RENAME
op_or
l_int|0x20
)paren
suffix:semicolon
r_if
c_cond
(paren
id|presto_do_expect
c_func
(paren
id|info
comma
id|new_dir
)paren
)paren
id|error
op_assign
id|presto_write_last_rcvd
c_func
(paren
op_amp
id|rec
comma
id|fset
comma
id|info
)paren
suffix:semicolon
id|presto_debug_fail_blkdev
c_func
(paren
id|fset
comma
id|PRESTO_OP_RENAME
op_or
l_int|0x30
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
m_exit
suffix:colon
id|presto_trans_commit
c_func
(paren
id|fset
comma
id|handle
)paren
suffix:semicolon
id|presto_release_space
c_func
(paren
id|fset-&gt;fset_cache
comma
id|PRESTO_REQHIGH
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
r_static
DECL|function|presto_rename_dir
r_int
id|presto_rename_dir
c_func
(paren
r_struct
id|presto_file_set
op_star
id|fset
comma
r_struct
id|dentry
op_star
id|old_parent
comma
r_struct
id|dentry
op_star
id|old_dentry
comma
r_struct
id|dentry
op_star
id|new_parent
comma
r_struct
id|dentry
op_star
id|new_dentry
comma
r_struct
id|lento_vfs_context
op_star
id|info
)paren
(brace
r_int
id|error
suffix:semicolon
r_struct
id|inode
op_star
id|target
suffix:semicolon
r_struct
id|inode
op_star
id|old_dir
op_assign
id|old_parent-&gt;d_inode
suffix:semicolon
r_struct
id|inode
op_star
id|new_dir
op_assign
id|new_parent-&gt;d_inode
suffix:semicolon
r_if
c_cond
(paren
id|old_dentry-&gt;d_inode
op_eq
id|new_dentry-&gt;d_inode
)paren
r_return
l_int|0
suffix:semicolon
id|error
op_assign
id|may_delete
c_func
(paren
id|old_dir
comma
id|old_dentry
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_return
id|error
suffix:semicolon
r_if
c_cond
(paren
id|new_dir-&gt;i_sb
op_ne
id|old_dir-&gt;i_sb
)paren
r_return
op_minus
id|EXDEV
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|new_dentry-&gt;d_inode
)paren
id|error
op_assign
id|may_create
c_func
(paren
id|new_dir
comma
id|new_dentry
)paren
suffix:semicolon
r_else
id|error
op_assign
id|may_delete
c_func
(paren
id|new_dir
comma
id|new_dentry
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_return
id|error
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|old_dir-&gt;i_op
op_logical_or
op_logical_neg
id|old_dir-&gt;i_op-&gt;rename
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
multiline_comment|/*&n;         * If we are going to change the parent - check write permissions,&n;         * we&squot;ll need to flip &squot;..&squot;.&n;         */
r_if
c_cond
(paren
id|new_dir
op_ne
id|old_dir
)paren
(brace
id|error
op_assign
id|permission
c_func
(paren
id|old_dentry-&gt;d_inode
comma
id|MAY_WRITE
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|error
)paren
r_return
id|error
suffix:semicolon
id|DQUOT_INIT
c_func
(paren
id|old_dir
)paren
suffix:semicolon
id|DQUOT_INIT
c_func
(paren
id|new_dir
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|old_dir-&gt;i_sb-&gt;s_vfs_rename_sem
)paren
suffix:semicolon
id|error
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|is_subdir
c_func
(paren
id|new_dentry
comma
id|old_dentry
)paren
)paren
r_goto
id|out_unlock
suffix:semicolon
id|target
op_assign
id|new_dentry-&gt;d_inode
suffix:semicolon
r_if
c_cond
(paren
id|target
)paren
(brace
multiline_comment|/* Hastur! Hastur! Hastur! */
id|triple_down
c_func
(paren
op_amp
id|old_dir-&gt;i_zombie
comma
op_amp
id|new_dir-&gt;i_zombie
comma
op_amp
id|target-&gt;i_zombie
)paren
suffix:semicolon
id|d_unhash
c_func
(paren
id|new_dentry
)paren
suffix:semicolon
)brace
r_else
id|double_down
c_func
(paren
op_amp
id|old_dir-&gt;i_zombie
comma
op_amp
id|new_dir-&gt;i_zombie
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_DEADDIR
c_func
(paren
id|old_dir
)paren
op_logical_or
id|IS_DEADDIR
c_func
(paren
id|new_dir
)paren
)paren
id|error
op_assign
op_minus
id|ENOENT
suffix:semicolon
r_else
r_if
c_cond
(paren
id|d_mountpoint
c_func
(paren
id|old_dentry
)paren
op_logical_or
id|d_mountpoint
c_func
(paren
id|new_dentry
)paren
)paren
id|error
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_else
id|error
op_assign
id|do_rename
c_func
(paren
id|fset
comma
id|old_parent
comma
id|old_dentry
comma
id|new_parent
comma
id|new_dentry
comma
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|target
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|error
)paren
id|target-&gt;i_flags
op_or_assign
id|S_DEAD
suffix:semicolon
id|triple_up
c_func
(paren
op_amp
id|old_dir-&gt;i_zombie
comma
op_amp
id|new_dir-&gt;i_zombie
comma
op_amp
id|target-&gt;i_zombie
)paren
suffix:semicolon
r_if
c_cond
(paren
id|d_unhashed
c_func
(paren
id|new_dentry
)paren
)paren
id|d_rehash
c_func
(paren
id|new_dentry
)paren
suffix:semicolon
id|dput
c_func
(paren
id|new_dentry
)paren
suffix:semicolon
)brace
r_else
id|double_up
c_func
(paren
op_amp
id|old_dir-&gt;i_zombie
comma
op_amp
id|new_dir-&gt;i_zombie
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|error
)paren
id|d_move
c_func
(paren
id|old_dentry
comma
id|new_dentry
)paren
suffix:semicolon
id|out_unlock
suffix:colon
id|up
c_func
(paren
op_amp
id|old_dir-&gt;i_sb-&gt;s_vfs_rename_sem
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
r_static
DECL|function|presto_rename_other
r_int
id|presto_rename_other
c_func
(paren
r_struct
id|presto_file_set
op_star
id|fset
comma
r_struct
id|dentry
op_star
id|old_parent
comma
r_struct
id|dentry
op_star
id|old_dentry
comma
r_struct
id|dentry
op_star
id|new_parent
comma
r_struct
id|dentry
op_star
id|new_dentry
comma
r_struct
id|lento_vfs_context
op_star
id|info
)paren
(brace
r_struct
id|inode
op_star
id|old_dir
op_assign
id|old_parent-&gt;d_inode
suffix:semicolon
r_struct
id|inode
op_star
id|new_dir
op_assign
id|new_parent-&gt;d_inode
suffix:semicolon
r_int
id|error
suffix:semicolon
r_if
c_cond
(paren
id|old_dentry-&gt;d_inode
op_eq
id|new_dentry-&gt;d_inode
)paren
r_return
l_int|0
suffix:semicolon
id|error
op_assign
id|may_delete
c_func
(paren
id|old_dir
comma
id|old_dentry
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_return
id|error
suffix:semicolon
r_if
c_cond
(paren
id|new_dir-&gt;i_sb
op_ne
id|old_dir-&gt;i_sb
)paren
r_return
op_minus
id|EXDEV
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|new_dentry-&gt;d_inode
)paren
id|error
op_assign
id|may_create
c_func
(paren
id|new_dir
comma
id|new_dentry
)paren
suffix:semicolon
r_else
id|error
op_assign
id|may_delete
c_func
(paren
id|new_dir
comma
id|new_dentry
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_return
id|error
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|old_dir-&gt;i_op
op_logical_or
op_logical_neg
id|old_dir-&gt;i_op-&gt;rename
)paren
r_return
op_minus
id|EPERM
suffix:semicolon
id|DQUOT_INIT
c_func
(paren
id|old_dir
)paren
suffix:semicolon
id|DQUOT_INIT
c_func
(paren
id|new_dir
)paren
suffix:semicolon
id|double_down
c_func
(paren
op_amp
id|old_dir-&gt;i_zombie
comma
op_amp
id|new_dir-&gt;i_zombie
)paren
suffix:semicolon
r_if
c_cond
(paren
id|d_mountpoint
c_func
(paren
id|old_dentry
)paren
op_logical_or
id|d_mountpoint
c_func
(paren
id|new_dentry
)paren
)paren
id|error
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_else
id|error
op_assign
id|do_rename
c_func
(paren
id|fset
comma
id|old_parent
comma
id|old_dentry
comma
id|new_parent
comma
id|new_dentry
comma
id|info
)paren
suffix:semicolon
id|double_up
c_func
(paren
op_amp
id|old_dir-&gt;i_zombie
comma
op_amp
id|new_dir-&gt;i_zombie
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_return
id|error
suffix:semicolon
multiline_comment|/* The following d_move() should become unconditional */
r_if
c_cond
(paren
op_logical_neg
(paren
id|old_dir-&gt;i_sb-&gt;s_type-&gt;fs_flags
op_amp
id|FS_ODD_RENAME
)paren
)paren
(brace
id|d_move
c_func
(paren
id|old_dentry
comma
id|new_dentry
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|presto_do_rename
r_int
id|presto_do_rename
c_func
(paren
r_struct
id|presto_file_set
op_star
id|fset
comma
r_struct
id|dentry
op_star
id|old_parent
comma
r_struct
id|dentry
op_star
id|old_dentry
comma
r_struct
id|dentry
op_star
id|new_parent
comma
r_struct
id|dentry
op_star
id|new_dentry
comma
r_struct
id|lento_vfs_context
op_star
id|info
)paren
(brace
r_if
c_cond
(paren
id|S_ISDIR
c_func
(paren
id|old_dentry-&gt;d_inode-&gt;i_mode
)paren
)paren
r_return
id|presto_rename_dir
c_func
(paren
id|fset
comma
id|old_parent
comma
id|old_dentry
comma
id|new_parent
comma
id|new_dentry
comma
id|info
)paren
suffix:semicolon
r_else
r_return
id|presto_rename_other
c_func
(paren
id|fset
comma
id|old_parent
comma
id|old_dentry
comma
id|new_parent
comma
id|new_dentry
comma
id|info
)paren
suffix:semicolon
)brace
DECL|function|lento_do_rename
r_int
id|lento_do_rename
c_func
(paren
r_const
r_char
op_star
id|oldname
comma
r_const
r_char
op_star
id|newname
comma
r_struct
id|lento_vfs_context
op_star
id|info
)paren
(brace
r_int
id|error
op_assign
l_int|0
suffix:semicolon
r_struct
id|dentry
op_star
id|old_dir
comma
op_star
id|new_dir
suffix:semicolon
r_struct
id|dentry
op_star
id|old_dentry
comma
op_star
id|new_dentry
suffix:semicolon
r_struct
id|nameidata
id|oldnd
comma
id|newnd
suffix:semicolon
r_struct
id|presto_file_set
op_star
id|fset
suffix:semicolon
id|ENTRY
suffix:semicolon
r_if
c_cond
(paren
id|path_init
c_func
(paren
id|oldname
comma
id|LOOKUP_PARENT
comma
op_amp
id|oldnd
)paren
)paren
id|error
op_assign
id|path_walk
c_func
(paren
id|oldname
comma
op_amp
id|oldnd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_goto
m_exit
suffix:semicolon
r_if
c_cond
(paren
id|path_init
c_func
(paren
id|newname
comma
id|LOOKUP_PARENT
comma
op_amp
id|newnd
)paren
)paren
id|error
op_assign
id|path_walk
c_func
(paren
id|newname
comma
op_amp
id|newnd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_goto
id|exit1
suffix:semicolon
id|error
op_assign
op_minus
id|EXDEV
suffix:semicolon
r_if
c_cond
(paren
id|oldnd.mnt
op_ne
id|newnd.mnt
)paren
r_goto
id|exit2
suffix:semicolon
id|old_dir
op_assign
id|oldnd.dentry
suffix:semicolon
id|error
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_if
c_cond
(paren
id|oldnd.last_type
op_ne
id|LAST_NORM
)paren
r_goto
id|exit2
suffix:semicolon
id|new_dir
op_assign
id|newnd.dentry
suffix:semicolon
r_if
c_cond
(paren
id|newnd.last_type
op_ne
id|LAST_NORM
)paren
r_goto
id|exit2
suffix:semicolon
id|double_lock
c_func
(paren
id|new_dir
comma
id|old_dir
)paren
suffix:semicolon
id|old_dentry
op_assign
id|lookup_hash
c_func
(paren
op_amp
id|oldnd.last
comma
id|old_dir
)paren
suffix:semicolon
id|error
op_assign
id|PTR_ERR
c_func
(paren
id|old_dentry
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|old_dentry
)paren
)paren
r_goto
id|exit3
suffix:semicolon
multiline_comment|/* source must exist */
id|error
op_assign
op_minus
id|ENOENT
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|old_dentry-&gt;d_inode
)paren
r_goto
id|exit4
suffix:semicolon
id|fset
op_assign
id|presto_fset
c_func
(paren
id|old_dentry
)paren
suffix:semicolon
id|error
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fset
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;No fileset!&bslash;n&quot;
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_goto
id|exit4
suffix:semicolon
)brace
multiline_comment|/* unless the source is a directory trailing slashes give -ENOTDIR */
r_if
c_cond
(paren
op_logical_neg
id|S_ISDIR
c_func
(paren
id|old_dentry-&gt;d_inode-&gt;i_mode
)paren
)paren
(brace
id|error
op_assign
op_minus
id|ENOTDIR
suffix:semicolon
r_if
c_cond
(paren
id|oldnd.last.name
(braket
id|oldnd.last.len
)braket
)paren
r_goto
id|exit4
suffix:semicolon
r_if
c_cond
(paren
id|newnd.last.name
(braket
id|newnd.last.len
)braket
)paren
r_goto
id|exit4
suffix:semicolon
)brace
id|new_dentry
op_assign
id|lookup_hash
c_func
(paren
op_amp
id|newnd.last
comma
id|new_dir
)paren
suffix:semicolon
id|error
op_assign
id|PTR_ERR
c_func
(paren
id|new_dentry
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|new_dentry
)paren
)paren
r_goto
id|exit4
suffix:semicolon
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
id|error
op_assign
id|presto_do_rename
c_func
(paren
id|fset
comma
id|old_dir
comma
id|old_dentry
comma
id|new_dir
comma
id|new_dentry
comma
id|info
)paren
suffix:semicolon
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
id|dput
c_func
(paren
id|new_dentry
)paren
suffix:semicolon
id|exit4
suffix:colon
id|dput
c_func
(paren
id|old_dentry
)paren
suffix:semicolon
id|exit3
suffix:colon
id|double_up
c_func
(paren
op_amp
id|new_dir-&gt;d_inode-&gt;i_sem
comma
op_amp
id|old_dir-&gt;d_inode-&gt;i_sem
)paren
suffix:semicolon
id|exit2
suffix:colon
id|path_release
c_func
(paren
op_amp
id|newnd
)paren
suffix:semicolon
id|exit1
suffix:colon
id|path_release
c_func
(paren
op_amp
id|oldnd
)paren
suffix:semicolon
m_exit
suffix:colon
r_return
id|error
suffix:semicolon
)brace
DECL|function|lento_rename
r_int
id|lento_rename
c_func
(paren
r_const
r_char
op_star
id|oldname
comma
r_const
r_char
op_star
id|newname
comma
r_struct
id|lento_vfs_context
op_star
id|info
)paren
(brace
r_int
id|error
suffix:semicolon
r_char
op_star
id|from
suffix:semicolon
r_char
op_star
id|to
suffix:semicolon
id|from
op_assign
id|getname
c_func
(paren
id|oldname
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|from
)paren
)paren
(brace
r_return
id|PTR_ERR
c_func
(paren
id|from
)paren
suffix:semicolon
)brace
id|to
op_assign
id|getname
c_func
(paren
id|newname
)paren
suffix:semicolon
id|error
op_assign
id|PTR_ERR
c_func
(paren
id|to
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|IS_ERR
c_func
(paren
id|to
)paren
)paren
(brace
id|error
op_assign
id|lento_do_rename
c_func
(paren
id|from
comma
id|to
comma
id|info
)paren
suffix:semicolon
id|putname
c_func
(paren
id|to
)paren
suffix:semicolon
)brace
id|putname
c_func
(paren
id|from
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|function|presto_iopen
r_struct
id|dentry
op_star
id|presto_iopen
c_func
(paren
r_struct
id|dentry
op_star
id|dentry
comma
id|ino_t
id|ino
comma
r_int
r_int
id|generation
)paren
(brace
r_struct
id|presto_file_set
op_star
id|fset
suffix:semicolon
r_char
id|name
(braket
l_int|48
)braket
suffix:semicolon
r_int
id|error
suffix:semicolon
id|ENTRY
suffix:semicolon
multiline_comment|/* see if we already have the dentry we want */
r_if
c_cond
(paren
id|dentry-&gt;d_inode
op_logical_and
id|dentry-&gt;d_inode-&gt;i_ino
op_eq
id|ino
op_logical_and
id|dentry-&gt;d_inode-&gt;i_generation
op_eq
id|generation
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|dentry
suffix:semicolon
)brace
multiline_comment|/* Make sure we have a cache beneath us.  We should always find at&n;         * least one dentry inside the cache (if it exists), otherwise not&n;         * even the cache root exists, or we passed in a bad name.&n;         */
id|fset
op_assign
id|presto_fset
c_func
(paren
id|dentry
)paren
suffix:semicolon
id|error
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fset
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;No fileset for %*s!&bslash;n&quot;
comma
id|dentry-&gt;d_name.len
comma
id|dentry-&gt;d_name.name
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
id|dput
c_func
(paren
id|dentry
)paren
suffix:semicolon
r_return
id|ERR_PTR
c_func
(paren
id|error
)paren
suffix:semicolon
)brace
id|dput
c_func
(paren
id|dentry
)paren
suffix:semicolon
id|sprintf
c_func
(paren
id|name
comma
l_string|&quot;%s%#lx%c%#x&quot;
comma
id|PRESTO_ILOOKUP_MAGIC
comma
id|ino
comma
id|PRESTO_ILOOKUP_SEP
comma
id|generation
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_PIOCTL
comma
l_string|&quot;opening %ld by number (as %s)&bslash;n&quot;
comma
id|ino
comma
id|name
)paren
suffix:semicolon
r_return
id|lookup_one_len
c_func
(paren
id|name
comma
id|fset-&gt;fset_mtpt
comma
id|strlen
c_func
(paren
id|name
)paren
)paren
suffix:semicolon
)brace
DECL|function|presto_filp_dopen
r_static
r_struct
id|file
op_star
id|presto_filp_dopen
c_func
(paren
r_struct
id|dentry
op_star
id|dentry
comma
r_int
id|flags
)paren
(brace
r_struct
id|file
op_star
id|f
suffix:semicolon
r_struct
id|inode
op_star
id|inode
suffix:semicolon
r_int
id|flag
comma
id|error
suffix:semicolon
id|ENTRY
suffix:semicolon
id|error
op_assign
op_minus
id|ENFILE
suffix:semicolon
id|f
op_assign
id|get_empty_filp
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|f
)paren
(brace
id|CDEBUG
c_func
(paren
id|D_PIOCTL
comma
l_string|&quot;error getting file pointer&bslash;n&quot;
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|f-&gt;f_flags
op_assign
id|flag
op_assign
id|flags
suffix:semicolon
id|f-&gt;f_mode
op_assign
(paren
id|flag
op_plus
l_int|1
)paren
op_amp
id|O_ACCMODE
suffix:semicolon
id|inode
op_assign
id|dentry-&gt;d_inode
suffix:semicolon
r_if
c_cond
(paren
id|f-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
(brace
id|error
op_assign
id|get_write_access
c_func
(paren
id|inode
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|CDEBUG
c_func
(paren
id|D_PIOCTL
comma
l_string|&quot;error getting write access&bslash;n&quot;
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_goto
id|cleanup_file
suffix:semicolon
)brace
)brace
id|f-&gt;f_dentry
op_assign
id|dentry
suffix:semicolon
id|f-&gt;f_pos
op_assign
l_int|0
suffix:semicolon
id|f-&gt;f_reada
op_assign
l_int|0
suffix:semicolon
id|f-&gt;f_op
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|inode-&gt;i_op
)paren
multiline_comment|/* XXX should we set to presto ops, or leave at cache ops? */
id|f-&gt;f_op
op_assign
id|inode-&gt;i_fop
suffix:semicolon
r_if
c_cond
(paren
id|f-&gt;f_op
op_logical_and
id|f-&gt;f_op-&gt;open
)paren
(brace
id|error
op_assign
id|f-&gt;f_op
op_member_access_from_pointer
id|open
c_func
(paren
id|inode
comma
id|f
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|CDEBUG
c_func
(paren
id|D_PIOCTL
comma
l_string|&quot;error calling cache &squot;open&squot;&bslash;n&quot;
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_goto
id|cleanup_all
suffix:semicolon
)brace
)brace
id|f-&gt;f_flags
op_and_assign
op_complement
(paren
id|O_CREAT
op_or
id|O_EXCL
op_or
id|O_NOCTTY
op_or
id|O_TRUNC
)paren
suffix:semicolon
r_return
id|f
suffix:semicolon
id|cleanup_all
suffix:colon
r_if
c_cond
(paren
id|f-&gt;f_mode
op_amp
id|FMODE_WRITE
)paren
id|put_write_access
c_func
(paren
id|inode
)paren
suffix:semicolon
id|cleanup_file
suffix:colon
id|put_filp
c_func
(paren
id|f
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|ERR_PTR
c_func
(paren
id|error
)paren
suffix:semicolon
)brace
multiline_comment|/* Open an inode by number.  We pass in the cache root name (or a subdirectory&n; * from the cache that is guaranteed to exist) to be able to access the cache.&n; */
DECL|function|lento_iopen
r_int
id|lento_iopen
c_func
(paren
r_const
r_char
op_star
id|name
comma
id|ino_t
id|ino
comma
r_int
r_int
id|generation
comma
r_int
id|flags
)paren
(brace
r_char
op_star
id|tmp
suffix:semicolon
r_struct
id|dentry
op_star
id|dentry
suffix:semicolon
r_struct
id|nameidata
id|nd
suffix:semicolon
r_int
id|fd
suffix:semicolon
r_int
id|error
suffix:semicolon
id|ENTRY
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_PIOCTL
comma
l_string|&quot;open %s:inode %#lx (%ld), generation %x (%d), flags %d &bslash;n&quot;
comma
id|name
comma
id|ino
comma
id|ino
comma
id|generation
comma
id|generation
comma
id|flags
)paren
suffix:semicolon
multiline_comment|/* We don&squot;t allow creation of files by number only, as it would&n;         * lead to a dangling files not in any directory.  We could also&n;         * just turn off the flag and ignore it.&n;         */
r_if
c_cond
(paren
id|flags
op_amp
id|O_CREAT
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
id|__FUNCTION__
l_string|&quot;: create file by inode number (%ld) not allowed&bslash;n&quot;
comma
id|ino
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
op_minus
id|EACCES
suffix:semicolon
)brace
id|tmp
op_assign
id|getname
c_func
(paren
id|name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|tmp
)paren
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|PTR_ERR
c_func
(paren
id|tmp
)paren
suffix:semicolon
)brace
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
id|again
suffix:colon
multiline_comment|/* look the named file or a parent directory so we can get the cache */
id|error
op_assign
id|presto_walk
c_func
(paren
id|tmp
comma
op_amp
id|nd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
op_logical_and
id|error
op_ne
op_minus
id|ENOENT
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
r_if
c_cond
(paren
id|error
op_eq
op_minus
id|ENOENT
)paren
id|dentry
op_assign
l_int|NULL
suffix:semicolon
r_else
id|dentry
op_assign
id|nd.dentry
suffix:semicolon
multiline_comment|/* we didn&squot;t find the named file, so see if a parent exists */
r_if
c_cond
(paren
op_logical_neg
id|dentry
)paren
(brace
r_char
op_star
id|slash
suffix:semicolon
id|slash
op_assign
id|strrchr
c_func
(paren
id|tmp
comma
l_char|&squot;/&squot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|slash
op_logical_and
id|slash
op_ne
id|tmp
)paren
(brace
op_star
id|slash
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|path_release
c_func
(paren
op_amp
id|nd
)paren
suffix:semicolon
r_goto
id|again
suffix:semicolon
)brace
multiline_comment|/* we should never get here... */
id|CDEBUG
c_func
(paren
id|D_PIOCTL
comma
l_string|&quot;no more path components to try!&bslash;n&quot;
)paren
suffix:semicolon
id|fd
op_assign
op_minus
id|ENOENT
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
id|CDEBUG
c_func
(paren
id|D_PIOCTL
comma
l_string|&quot;returned dentry %p&bslash;n&quot;
comma
id|dentry
)paren
suffix:semicolon
id|dentry
op_assign
id|presto_iopen
c_func
(paren
id|dentry
comma
id|ino
comma
id|generation
)paren
suffix:semicolon
id|fd
op_assign
id|PTR_ERR
c_func
(paren
id|dentry
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|dentry
)paren
)paren
(brace
id|EXIT
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
multiline_comment|/* XXX start of code that might be replaced by something like:&n;         * if (flags &amp; (O_WRONLY | O_RDWR)) {&n;         *      error = get_write_access(dentry-&gt;d_inode);&n;         *      if (error) {&n;         *              EXIT;&n;         *              goto cleanup_dput;&n;         *      }&n;         * }&n;         * fd = open_dentry(dentry, flags);&n;         *&n;         * including the presto_filp_dopen() function (check dget counts!)&n;         */
id|fd
op_assign
id|get_unused_fd
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fd
OL
l_int|0
)paren
(brace
id|EXIT
suffix:semicolon
r_goto
id|cleanup_dput
suffix:semicolon
)brace
(brace
r_int
id|error
suffix:semicolon
r_struct
id|file
op_star
id|f
op_assign
id|presto_filp_dopen
c_func
(paren
id|dentry
comma
id|flags
)paren
suffix:semicolon
id|error
op_assign
id|PTR_ERR
c_func
(paren
id|f
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|f
)paren
)paren
(brace
id|put_unused_fd
c_func
(paren
id|fd
)paren
suffix:semicolon
id|fd
op_assign
id|error
suffix:semicolon
id|EXIT
suffix:semicolon
r_goto
id|cleanup_dput
suffix:semicolon
)brace
id|fd_install
c_func
(paren
id|fd
comma
id|f
)paren
suffix:semicolon
)brace
multiline_comment|/* end of code that might be replaced by open_dentry */
id|EXIT
suffix:semicolon
m_exit
suffix:colon
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
id|path_release
c_func
(paren
op_amp
id|nd
)paren
suffix:semicolon
id|putname
c_func
(paren
id|tmp
)paren
suffix:semicolon
r_return
id|fd
suffix:semicolon
id|cleanup_dput
suffix:colon
id|putname
c_func
(paren
op_amp
id|nd
)paren
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
DECL|function|lento_close
r_int
id|lento_close
c_func
(paren
r_int
r_int
id|fd
comma
r_struct
id|lento_vfs_context
op_star
id|info
)paren
(brace
r_struct
id|rec_info
id|rec
suffix:semicolon
r_int
id|error
suffix:semicolon
r_struct
id|file
op_star
id|filp
suffix:semicolon
r_struct
id|dentry
op_star
id|dentry
suffix:semicolon
r_int
id|do_kml
comma
id|do_expect
suffix:semicolon
id|ENTRY
suffix:semicolon
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
id|error
op_assign
op_minus
id|EBADF
suffix:semicolon
id|filp
op_assign
id|fcheck
c_func
(paren
id|fd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|filp
)paren
(brace
r_struct
id|files_struct
op_star
id|files
op_assign
id|current-&gt;files
suffix:semicolon
id|dentry
op_assign
id|filp-&gt;f_dentry
suffix:semicolon
id|dget
c_func
(paren
id|dentry
)paren
suffix:semicolon
id|do_kml
op_assign
id|presto_do_kml
c_func
(paren
id|info
comma
id|dentry-&gt;d_inode
)paren
suffix:semicolon
id|do_expect
op_assign
id|presto_do_expect
c_func
(paren
id|info
comma
id|dentry-&gt;d_inode
)paren
suffix:semicolon
id|files-&gt;fd
(braket
id|fd
)braket
op_assign
l_int|NULL
suffix:semicolon
id|put_unused_fd
c_func
(paren
id|fd
)paren
suffix:semicolon
id|FD_CLR
c_func
(paren
id|fd
comma
id|files-&gt;close_on_exec
)paren
suffix:semicolon
id|error
op_assign
id|filp_close
c_func
(paren
id|filp
comma
id|files
)paren
suffix:semicolon
)brace
r_else
(brace
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
r_if
c_cond
(paren
id|do_kml
)paren
(brace
r_struct
id|presto_file_set
op_star
id|fset
suffix:semicolon
r_struct
id|presto_version
id|new_file_ver
suffix:semicolon
id|fset
op_assign
id|presto_fset
c_func
(paren
id|dentry
)paren
suffix:semicolon
id|error
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fset
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;No fileset for %*s!&bslash;n&quot;
comma
id|dentry-&gt;d_name.len
comma
id|dentry-&gt;d_name.name
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
id|presto_getversion
c_func
(paren
op_amp
id|new_file_ver
comma
id|dentry-&gt;d_inode
)paren
suffix:semicolon
id|error
op_assign
id|presto_journal_close
c_func
(paren
op_amp
id|rec
comma
id|fset
comma
id|filp
comma
id|dentry
comma
op_amp
id|new_file_ver
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;presto: close error %d!&bslash;n&quot;
comma
id|error
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
r_if
c_cond
(paren
id|do_expect
)paren
id|error
op_assign
id|presto_write_last_rcvd
c_func
(paren
op_amp
id|rec
comma
id|fset
comma
id|info
)paren
suffix:semicolon
)brace
id|EXIT
suffix:semicolon
m_exit
suffix:colon
id|dput
c_func
(paren
id|dentry
)paren
suffix:semicolon
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_FS_EXT_ATTR
macro_line|#ifdef CONFIG_FS_POSIX_ACL
multiline_comment|/* Posix ACL code changes i_mode without using a notify_change (or&n; * a mark_inode_dirty!). We need to duplicate this at the reintegrator&n; * which is done by this function. This function also takes care of &n; * resetting the cached posix acls in this inode. If we don&squot;t reset these&n; * VFS continues using the old acl information, which by now may be out of&n; * date.&n; */
DECL|function|presto_setmode
r_int
id|presto_setmode
c_func
(paren
r_struct
id|presto_file_set
op_star
id|fset
comma
r_struct
id|dentry
op_star
id|dentry
comma
id|mode_t
id|mode
)paren
(brace
r_struct
id|inode
op_star
id|inode
op_assign
id|dentry-&gt;d_inode
suffix:semicolon
id|ENTRY
suffix:semicolon
multiline_comment|/* The extended attributes for this inode were modified. &n;         * At this point we can not be sure if any of the ACL &n;         * information for this inode was updated. So we will &n;         * force VFS to reread the acls. Note that we do this &n;         * only when called from the SETEXTATTR ioctl, which is why we&n;         * do this while setting the mode of the file. Also note&n;         * that mark_inode_dirty is not be needed for i_*acl only&n;         * to force i_mode info to disk, and should be removed once&n;         * we use notify_change to update the mode.&n;         * XXX: is mode setting really needed? Just setting acl&squot;s should&n;         * be enough! VFS should change the i_mode as needed? SHP&n;         */
r_if
c_cond
(paren
id|inode-&gt;i_acl
op_logical_and
id|inode-&gt;i_acl
op_ne
id|POSIX_ACL_NOT_CACHED
)paren
id|posix_acl_release
c_func
(paren
id|inode-&gt;i_acl
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inode-&gt;i_default_acl
op_logical_and
id|inode-&gt;i_default_acl
op_ne
id|POSIX_ACL_NOT_CACHED
)paren
id|posix_acl_release
c_func
(paren
id|inode-&gt;i_default_acl
)paren
suffix:semicolon
id|inode-&gt;i_acl
op_assign
id|POSIX_ACL_NOT_CACHED
suffix:semicolon
id|inode-&gt;i_default_acl
op_assign
id|POSIX_ACL_NOT_CACHED
suffix:semicolon
id|inode-&gt;i_mode
op_assign
id|mode
suffix:semicolon
multiline_comment|/* inode should already be dirty...but just in case */
id|mark_inode_dirty
c_func
(paren
id|inode
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
macro_line|#if 0
multiline_comment|/* XXX: The following code is the preferred way to set mode, &n;         * however, I need to carefully go through possible recursion&n;         * paths back into presto. See comments in presto_do_setattr.&n;         */
(brace
r_int
id|error
op_assign
l_int|0
suffix:semicolon
r_struct
id|super_operations
op_star
id|sops
suffix:semicolon
r_struct
id|iattr
id|iattr
suffix:semicolon
id|iattr.ia_mode
op_assign
id|mode
suffix:semicolon
id|iattr.ia_valid
op_assign
id|ATTR_MODE
op_or
id|ATTR_FORCE
suffix:semicolon
id|error
op_assign
op_minus
id|EPERM
suffix:semicolon
id|sops
op_assign
id|filter_c2csops
c_func
(paren
id|fset-&gt;fset_cache-&gt;cache_filter
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sops
op_logical_and
op_logical_neg
id|sops-&gt;notify_change
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|error
op_assign
id|sops
op_member_access_from_pointer
id|notify_change
c_func
(paren
id|dentry
comma
op_amp
id|iattr
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
macro_line|#endif
)brace
macro_line|#endif
multiline_comment|/* setextattr Interface to cache filesystem */
DECL|function|presto_do_set_ext_attr
r_int
id|presto_do_set_ext_attr
c_func
(paren
r_struct
id|presto_file_set
op_star
id|fset
comma
r_struct
id|dentry
op_star
id|dentry
comma
r_const
r_char
op_star
id|name
comma
r_void
op_star
id|buffer
comma
r_int
id|buffer_len
comma
r_int
id|flags
comma
id|mode_t
op_star
id|mode
comma
r_struct
id|lento_vfs_context
op_star
id|info
)paren
(brace
r_struct
id|rec_info
id|rec
suffix:semicolon
r_struct
id|inode
op_star
id|inode
op_assign
id|dentry-&gt;d_inode
suffix:semicolon
r_struct
id|inode_operations
op_star
id|iops
suffix:semicolon
r_int
id|error
suffix:semicolon
r_struct
id|presto_version
id|ver
suffix:semicolon
r_void
op_star
id|handle
suffix:semicolon
r_char
id|temp
(braket
id|PRESTO_EXT_ATTR_NAME_MAX
op_plus
l_int|1
)braket
suffix:semicolon
id|ENTRY
suffix:semicolon
id|error
op_assign
op_minus
id|EROFS
suffix:semicolon
r_if
c_cond
(paren
id|IS_RDONLY
c_func
(paren
id|inode
)paren
)paren
(brace
id|EXIT
suffix:semicolon
r_return
op_minus
id|EROFS
suffix:semicolon
)brace
r_if
c_cond
(paren
id|IS_IMMUTABLE
c_func
(paren
id|inode
)paren
op_logical_or
id|IS_APPEND
c_func
(paren
id|inode
)paren
)paren
(brace
id|EXIT
suffix:semicolon
r_return
op_minus
id|EPERM
suffix:semicolon
)brace
id|presto_getversion
c_func
(paren
op_amp
id|ver
comma
id|inode
)paren
suffix:semicolon
id|error
op_assign
op_minus
id|EPERM
suffix:semicolon
multiline_comment|/* We need to invoke different filters based on whether&n;         * this dentry is a regular file, directory or symlink.&n;         */
r_switch
c_cond
(paren
id|inode-&gt;i_mode
op_amp
id|S_IFMT
)paren
(brace
r_case
id|S_IFLNK
suffix:colon
multiline_comment|/* symlink */
id|iops
op_assign
id|filter_c2csiops
c_func
(paren
id|fset-&gt;fset_cache-&gt;cache_filter
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|S_IFDIR
suffix:colon
multiline_comment|/* directory */
id|iops
op_assign
id|filter_c2cdiops
c_func
(paren
id|fset-&gt;fset_cache-&gt;cache_filter
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|S_IFREG
suffix:colon
r_default
suffix:colon
multiline_comment|/* everything else including regular files */
id|iops
op_assign
id|filter_c2cfiops
c_func
(paren
id|fset-&gt;fset_cache-&gt;cache_filter
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|iops
op_logical_and
op_logical_neg
id|iops-&gt;set_ext_attr
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|error
op_assign
id|presto_reserve_space
c_func
(paren
id|fset-&gt;fset_cache
comma
id|PRESTO_REQHIGH
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|handle
op_assign
id|presto_trans_start
c_func
(paren
id|fset
comma
id|dentry-&gt;d_inode
comma
id|PRESTO_OP_SETEXTATTR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|handle
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;presto_do_set_ext_attr: no space for transaction&bslash;n&quot;
)paren
suffix:semicolon
id|presto_release_space
c_func
(paren
id|fset-&gt;fset_cache
comma
id|PRESTO_REQHIGH
)paren
suffix:semicolon
r_return
op_minus
id|ENOSPC
suffix:semicolon
)brace
multiline_comment|/* We first &quot;truncate&quot; name to the maximum allowable in presto */
multiline_comment|/* This simulates the strncpy_from_use code in fs/ext_attr.c */
id|strncpy
c_func
(paren
id|temp
comma
id|name
comma
r_sizeof
(paren
id|temp
)paren
)paren
suffix:semicolon
multiline_comment|/* Pass down to cache*/
id|error
op_assign
id|iops
op_member_access_from_pointer
id|set_ext_attr
c_func
(paren
id|inode
comma
id|temp
comma
id|buffer
comma
id|buffer_len
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_FS_POSIX_ACL
multiline_comment|/* Reset mode if specified*/
multiline_comment|/* XXX: when we do native acl support, move this code out! */
r_if
c_cond
(paren
id|mode
op_ne
l_int|NULL
)paren
(brace
id|error
op_assign
id|presto_setmode
c_func
(paren
id|fset
comma
id|dentry
comma
op_star
id|mode
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
)brace
macro_line|#endif
multiline_comment|/* Reset ctime. Only inode change time (ctime) is affected */
id|error
op_assign
id|presto_settime
c_func
(paren
id|fset
comma
id|dentry
comma
id|info
comma
id|ATTR_CTIME
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
r_if
c_cond
(paren
id|flags
op_amp
id|EXT_ATTR_FLAG_USER
)paren
(brace
id|printk
c_func
(paren
l_string|&quot; USER flag passed to presto_do_set_ext_attr!&bslash;n&quot;
)paren
suffix:semicolon
op_star
(paren
r_int
op_star
)paren
l_int|0
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* We are here, so set_ext_attr succeeded. We no longer need to keep&n;         * track of EXT_ATTR_FLAG_{EXISTS,CREATE}, instead, we will force&n;         * the attribute value during log replay. -SHP&n;         */
id|flags
op_and_assign
op_complement
(paren
id|EXT_ATTR_FLAG_EXISTS
op_or
id|EXT_ATTR_FLAG_CREATE
)paren
suffix:semicolon
id|presto_debug_fail_blkdev
c_func
(paren
id|fset
comma
id|PRESTO_OP_SETEXTATTR
op_or
l_int|0x10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|presto_do_kml
c_func
(paren
id|info
comma
id|dentry-&gt;d_inode
)paren
)paren
id|error
op_assign
id|presto_journal_set_ext_attr
(paren
op_amp
id|rec
comma
id|fset
comma
id|dentry
comma
op_amp
id|ver
comma
id|name
comma
id|buffer
comma
id|buffer_len
comma
id|flags
)paren
suffix:semicolon
id|presto_debug_fail_blkdev
c_func
(paren
id|fset
comma
id|PRESTO_OP_SETEXTATTR
op_or
l_int|0x20
)paren
suffix:semicolon
r_if
c_cond
(paren
id|presto_do_expect
c_func
(paren
id|info
comma
id|dentry-&gt;d_inode
)paren
)paren
id|error
op_assign
id|presto_write_last_rcvd
c_func
(paren
op_amp
id|rec
comma
id|fset
comma
id|info
)paren
suffix:semicolon
id|presto_debug_fail_blkdev
c_func
(paren
id|fset
comma
id|PRESTO_OP_SETEXTATTR
op_or
l_int|0x30
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
m_exit
suffix:colon
id|presto_release_space
c_func
(paren
id|fset-&gt;fset_cache
comma
id|PRESTO_REQHIGH
)paren
suffix:semicolon
id|presto_trans_commit
c_func
(paren
id|fset
comma
id|handle
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
macro_line|#endif
eof
