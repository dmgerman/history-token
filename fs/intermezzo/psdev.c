multiline_comment|/*&n; *              An implementation of a loadable kernel mode driver providing&n; *              multiple kernel/user space bidirectional communications links.&n; *&n; *              Author:         Alan Cox &lt;alan@cymru.net&gt;&n; *&n; *              This program is free software; you can redistribute it and/or&n; *              modify it under the terms of the GNU General Public License&n; *              as published by the Free Software Foundation; either version&n; *              2 of the License, or (at your option) any later version.&n; *&n; *              Adapted to become the Linux 2.0 Coda pseudo device&n; *              Peter  Braam  &lt;braam@maths.ox.ac.uk&gt;&n; *              Michael Callahan &lt;mjc@emmy.smith.edu&gt;&n; *&n; *              Changes for Linux 2.1&n; *              Copyright (c) 1997 Carnegie-Mellon University&n; *&n; *              Redone again for InterMezzo&n; *              Copyright (c) 1998 Peter J. Braam&n; *              Copyright (c) 2000 Mountain View Data, Inc.&n; *              Copyright (c) 2000 Tacitus Systems, Inc.&n; *              Copyright (c) 2001 Cluster File Systems, Inc.&n; *&n; *&t;&t;Extended attribute support&n; *&t;&t;Copyright (c) 2001 Shirish. H. Phatak&n; *&t;&t;Copyright (c) 2001 Tacit Networks, Inc.&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/major.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/lp.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;asm/ioctls.h&gt;
macro_line|#include &lt;linux/ioport.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/delay.h&gt;
macro_line|#include &lt;linux/skbuff.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/vmalloc.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/tty.h&gt;
macro_line|#include &lt;linux/poll.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/list.h&gt;
macro_line|#include &lt;asm/io.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/poll.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/ioctls.h&gt;
macro_line|#include &lt;linux/intermezzo_fs.h&gt;
macro_line|#include &lt;linux/intermezzo_upcall.h&gt;
macro_line|#include &lt;linux/intermezzo_psdev.h&gt;
macro_line|#include &lt;linux/intermezzo_kml.h&gt;
macro_line|#ifdef PRESTO_DEVEL
DECL|variable|presto_print_entry
r_int
id|presto_print_entry
op_assign
l_int|1
suffix:semicolon
DECL|variable|presto_debug
r_int
id|presto_debug
op_assign
l_int|4095
suffix:semicolon
macro_line|#else
DECL|variable|presto_print_entry
r_int
id|presto_print_entry
op_assign
l_int|0
suffix:semicolon
DECL|variable|presto_debug
r_int
id|presto_debug
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
multiline_comment|/* Like inode.c (presto_sym_iops), the initializer is just to prevent&n;   upc_comms from appearing as a COMMON symbol (and therefore&n;   interfering with other modules that use the same variable name. */
DECL|variable|upc_comms
r_struct
id|upc_comm
id|upc_comms
(braket
id|MAX_PRESTODEV
)braket
op_assign
(brace
(brace
l_int|0
)brace
)brace
suffix:semicolon
multiline_comment|/*&n; * Device operations: map file to upcall structure&n; */
DECL|function|presto_psdev_f2u
r_static
r_inline
r_struct
id|upc_comm
op_star
id|presto_psdev_f2u
c_func
(paren
r_struct
id|file
op_star
id|file
)paren
(brace
r_int
id|minor
suffix:semicolon
r_if
c_cond
(paren
id|major
c_func
(paren
id|file-&gt;f_dentry-&gt;d_inode-&gt;i_rdev
)paren
op_ne
id|PRESTO_PSDEV_MAJOR
)paren
(brace
id|EXIT
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|minor
op_assign
id|minor
c_func
(paren
id|file-&gt;f_dentry-&gt;d_inode-&gt;i_rdev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|minor
OL
l_int|0
op_logical_or
id|minor
op_ge
id|MAX_PRESTODEV
)paren
(brace
id|EXIT
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_return
op_amp
(paren
id|upc_comms
(braket
id|minor
)braket
)paren
suffix:semicolon
)brace
DECL|function|presto_lento_up
r_inline
r_int
id|presto_lento_up
c_func
(paren
r_int
id|minor
)paren
(brace
r_return
id|upc_comms
(braket
id|minor
)braket
dot
id|uc_pid
suffix:semicolon
)brace
DECL|function|presto_psdev_poll
r_static
r_int
r_int
id|presto_psdev_poll
c_func
(paren
r_struct
id|file
op_star
id|file
comma
id|poll_table
op_star
id|wait
)paren
(brace
r_struct
id|upc_comm
op_star
id|upccom
suffix:semicolon
r_int
r_int
id|mask
op_assign
id|POLLOUT
op_or
id|POLLWRNORM
suffix:semicolon
multiline_comment|/* ENTRY; this will flood you */
r_if
c_cond
(paren
op_logical_neg
(paren
id|upccom
op_assign
id|presto_psdev_f2u
c_func
(paren
id|file
)paren
)paren
)paren
(brace
id|kdev_t
id|dev
op_assign
id|file-&gt;f_dentry-&gt;d_inode-&gt;i_rdev
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;InterMezzo: %s, bad device %s&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|kdevname
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
)brace
id|poll_wait
c_func
(paren
id|file
comma
op_amp
(paren
id|upccom-&gt;uc_waitq
)paren
comma
id|wait
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|upccom-&gt;uc_pending
)paren
)paren
(brace
id|CDEBUG
c_func
(paren
id|D_PSDEV
comma
l_string|&quot;Non-empty pending list.&bslash;n&quot;
)paren
suffix:semicolon
id|mask
op_or_assign
id|POLLIN
op_or
id|POLLRDNORM
suffix:semicolon
)brace
multiline_comment|/* EXIT; will flood you */
r_return
id|mask
suffix:semicolon
)brace
multiline_comment|/*&n; *      Receive a message written by Lento to the psdev&n; */
DECL|function|presto_psdev_write
r_static
id|ssize_t
id|presto_psdev_write
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|off
)paren
(brace
r_struct
id|upc_comm
op_star
id|upccom
suffix:semicolon
r_struct
id|upc_req
op_star
id|req
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|upc_req
op_star
id|tmp
suffix:semicolon
r_struct
id|list_head
op_star
id|lh
suffix:semicolon
r_struct
id|lento_down_hdr
id|hdr
suffix:semicolon
r_int
id|error
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|upccom
op_assign
id|presto_psdev_f2u
c_func
(paren
id|file
)paren
)paren
)paren
(brace
id|kdev_t
id|dev
op_assign
id|file-&gt;f_dentry-&gt;d_inode-&gt;i_rdev
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;InterMezzo: %s, bad device %s&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|kdevname
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Peek at the opcode, uniquefier */
r_if
c_cond
(paren
id|count
OL
r_sizeof
(paren
id|hdr
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;presto_psdev_write: Lento didn&squot;t write full hdr.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|error
op_assign
id|copy_from_user
c_func
(paren
op_amp
id|hdr
comma
id|buf
comma
r_sizeof
(paren
id|hdr
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_return
id|error
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_PSDEV
comma
l_string|&quot;(process,opc,uniq)=(%d,%d,%d)&bslash;n&quot;
comma
id|current-&gt;pid
comma
id|hdr.opcode
comma
id|hdr.unique
)paren
suffix:semicolon
multiline_comment|/* Look for the message on the processing queue. */
id|lh
op_assign
op_amp
id|upccom-&gt;uc_processing
suffix:semicolon
r_while
c_loop
(paren
(paren
id|lh
op_assign
id|lh-&gt;next
)paren
op_ne
op_amp
id|upccom-&gt;uc_processing
)paren
(brace
id|tmp
op_assign
id|list_entry
c_func
(paren
id|lh
comma
r_struct
id|upc_req
comma
id|rq_chain
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmp-&gt;rq_unique
op_eq
id|hdr.unique
)paren
(brace
id|req
op_assign
id|tmp
suffix:semicolon
multiline_comment|/* unlink here: keeps search length minimal */
id|list_del
c_func
(paren
op_amp
id|req-&gt;rq_chain
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|req-&gt;rq_chain
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_PSDEV
comma
l_string|&quot;Eureka opc %d uniq %d!&bslash;n&quot;
comma
id|hdr.opcode
comma
id|hdr.unique
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|req
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;psdev_write: msg (%d, %d) not found&bslash;n&quot;
comma
id|hdr.opcode
comma
id|hdr.unique
)paren
suffix:semicolon
r_return
op_minus
id|ESRCH
suffix:semicolon
)brace
multiline_comment|/* move data into response buffer. */
r_if
c_cond
(paren
id|req-&gt;rq_bufsize
OL
id|count
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;psdev_write: too much cnt: %d, cnt: %Zd, &quot;
l_string|&quot;opc: %d, uniq: %d.&bslash;n&quot;
comma
id|req-&gt;rq_bufsize
comma
id|count
comma
id|hdr.opcode
comma
id|hdr.unique
)paren
suffix:semicolon
id|count
op_assign
id|req-&gt;rq_bufsize
suffix:semicolon
multiline_comment|/* don&squot;t have more space! */
)brace
id|error
op_assign
id|copy_from_user
c_func
(paren
id|req-&gt;rq_data
comma
id|buf
comma
id|count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_return
id|error
suffix:semicolon
multiline_comment|/* adjust outsize: good upcalls can be aware of this */
id|req-&gt;rq_rep_size
op_assign
id|count
suffix:semicolon
id|req-&gt;rq_flags
op_or_assign
id|REQ_WRITE
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|req-&gt;rq_sleep
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
multiline_comment|/*&n; *      Read a message from the kernel to Lento&n; */
DECL|function|presto_psdev_read
r_static
id|ssize_t
id|presto_psdev_read
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_char
op_star
id|buf
comma
r_int
id|count
comma
id|loff_t
op_star
id|off
)paren
(brace
r_struct
id|upc_comm
op_star
id|upccom
suffix:semicolon
r_struct
id|upc_req
op_star
id|req
suffix:semicolon
r_int
id|result
op_assign
id|count
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|upccom
op_assign
id|presto_psdev_f2u
c_func
(paren
id|file
)paren
)paren
)paren
(brace
id|kdev_t
id|dev
op_assign
id|file-&gt;f_dentry-&gt;d_inode-&gt;i_rdev
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;InterMezzo: %s, bad device %s&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|kdevname
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
)brace
id|CDEBUG
c_func
(paren
id|D_PSDEV
comma
l_string|&quot;count %Zd&bslash;n&quot;
comma
id|count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|list_empty
c_func
(paren
op_amp
(paren
id|upccom-&gt;uc_pending
)paren
)paren
)paren
(brace
id|CDEBUG
c_func
(paren
id|D_UPCALL
comma
l_string|&quot;Empty pending list in read, not good&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|req
op_assign
id|list_entry
c_func
(paren
(paren
id|upccom-&gt;uc_pending.next
)paren
comma
r_struct
id|upc_req
comma
id|rq_chain
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
(paren
id|req-&gt;rq_chain
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|req-&gt;rq_flags
op_amp
id|REQ_ASYNC
)paren
)paren
(brace
id|list_add
c_func
(paren
op_amp
(paren
id|req-&gt;rq_chain
)paren
comma
id|upccom-&gt;uc_processing.prev
)paren
suffix:semicolon
)brace
id|req-&gt;rq_flags
op_or_assign
id|REQ_READ
suffix:semicolon
multiline_comment|/* Move the input args into userspace */
r_if
c_cond
(paren
id|req-&gt;rq_bufsize
op_le
id|count
)paren
(brace
id|result
op_assign
id|req-&gt;rq_bufsize
suffix:semicolon
)brace
r_if
c_cond
(paren
id|count
OL
id|req-&gt;rq_bufsize
)paren
(brace
id|printk
(paren
l_string|&quot;psdev_read: buffer too small, read %Zd of %d bytes&bslash;n&quot;
comma
id|count
comma
id|req-&gt;rq_bufsize
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_to_user
c_func
(paren
id|buf
comma
id|req-&gt;rq_data
comma
id|result
)paren
)paren
(brace
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
multiline_comment|/* If request was asynchronous don&squot;t enqueue, but free */
r_if
c_cond
(paren
id|req-&gt;rq_flags
op_amp
id|REQ_ASYNC
)paren
(brace
id|CDEBUG
c_func
(paren
id|D_PSDEV
comma
l_string|&quot;psdev_read: async msg (%d, %d), result %d&bslash;n&quot;
comma
id|req-&gt;rq_opcode
comma
id|req-&gt;rq_unique
comma
id|result
)paren
suffix:semicolon
id|PRESTO_FREE
c_func
(paren
id|req-&gt;rq_data
comma
id|req-&gt;rq_bufsize
)paren
suffix:semicolon
id|PRESTO_FREE
c_func
(paren
id|req
comma
r_sizeof
(paren
op_star
id|req
)paren
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
r_return
id|result
suffix:semicolon
)brace
DECL|function|presto_psdev_ioctl
r_static
r_int
id|presto_psdev_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_struct
id|upc_comm
op_star
id|upccom
suffix:semicolon
multiline_comment|/* XXX is this rdev or dev? */
id|kdev_t
id|dev
op_assign
id|inode-&gt;i_rdev
suffix:semicolon
id|ENTRY
suffix:semicolon
id|upccom
op_assign
id|presto_psdev_f2u
c_func
(paren
id|file
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|upccom
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;InterMezzo: %s, bad device %s&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|kdevname
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|TCGETS
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
r_case
id|PRESTO_GETMOUNT
suffix:colon
(brace
multiline_comment|/* return all the mounts for this device.  */
r_int
id|minor
op_assign
l_int|0
suffix:semicolon
r_int
id|len
comma
id|outlen
suffix:semicolon
r_struct
id|readmount
id|readmount
suffix:semicolon
r_struct
id|readmount
op_star
id|user_readmount
op_assign
(paren
r_struct
id|readmount
op_star
)paren
id|arg
suffix:semicolon
r_char
op_star
id|tmp
suffix:semicolon
r_int
id|error
suffix:semicolon
id|error
op_assign
id|copy_from_user
c_func
(paren
op_amp
id|readmount
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|readmount
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;psdev: can&squot;t copy %Zd bytes from %p to %p&bslash;n&quot;
comma
r_sizeof
(paren
id|readmount
)paren
comma
(paren
r_struct
id|readmount
op_star
)paren
id|arg
comma
op_amp
id|readmount
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|len
op_assign
id|readmount.io_len
suffix:semicolon
id|minor
op_assign
id|minor
c_func
(paren
id|dev
)paren
suffix:semicolon
id|PRESTO_ALLOC
c_func
(paren
id|tmp
comma
r_char
op_star
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tmp
)paren
(brace
id|EXIT
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|outlen
op_assign
id|presto_sprint_mounts
c_func
(paren
id|tmp
comma
id|len
comma
id|minor
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_PSDEV
comma
l_string|&quot;presto_sprint_mounts returns %d bytes&bslash;n&quot;
comma
id|outlen
)paren
suffix:semicolon
multiline_comment|/* as this came out on 1/3/2000, it could NEVER work.&n;                 * So fix it ... RGM&n;                 * I mean, let&squot;s let the compiler do a little work ...&n;                 * gcc suggested the extra ()&n;                 */
id|error
op_assign
id|copy_to_user
c_func
(paren
id|readmount.io_string
comma
id|tmp
comma
id|outlen
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|CDEBUG
c_func
(paren
id|D_PSDEV
comma
l_string|&quot;Copy_to_user string 0x%p failed&bslash;n&quot;
comma
id|readmount.io_string
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
op_logical_neg
id|error
)paren
op_logical_and
(paren
id|error
op_assign
id|copy_to_user
c_func
(paren
op_amp
(paren
id|user_readmount-&gt;io_len
)paren
comma
op_amp
id|outlen
comma
r_sizeof
(paren
r_int
)paren
)paren
)paren
)paren
(brace
id|CDEBUG
c_func
(paren
id|D_PSDEV
comma
l_string|&quot;Copy_to_user len @0x%p failed&bslash;n&quot;
comma
op_amp
(paren
id|user_readmount-&gt;io_len
)paren
)paren
suffix:semicolon
)brace
id|PRESTO_FREE
c_func
(paren
id|tmp
comma
id|len
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
r_case
id|PRESTO_SETPID
suffix:colon
(brace
multiline_comment|/*&n;                 * This ioctl is performed by each Lento that starts up&n;                 * and wants to do further communication with presto.&n;                 */
id|CDEBUG
c_func
(paren
id|D_PSDEV
comma
l_string|&quot;Setting current pid to %d&bslash;n&quot;
comma
id|current-&gt;pid
)paren
suffix:semicolon
id|upccom-&gt;uc_pid
op_assign
id|current-&gt;pid
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|upccom-&gt;uc_processing
)paren
)paren
(brace
r_struct
id|list_head
op_star
id|lh
suffix:semicolon
r_struct
id|upc_req
op_star
id|req
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;WARNING: setpid &amp; processing not empty!&bslash;n&quot;
)paren
suffix:semicolon
id|lh
op_assign
op_amp
id|upccom-&gt;uc_processing
suffix:semicolon
r_while
c_loop
(paren
(paren
id|lh
op_assign
id|lh-&gt;next
)paren
op_ne
op_amp
id|upccom-&gt;uc_processing
)paren
(brace
id|req
op_assign
id|list_entry
c_func
(paren
id|lh
comma
r_struct
id|upc_req
comma
id|rq_chain
)paren
suffix:semicolon
multiline_comment|/* freeing of req and data is done by the sleeper */
id|wake_up
c_func
(paren
op_amp
id|req-&gt;rq_sleep
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|upccom-&gt;uc_processing
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;BAD: FAILDED TO CLEAN PROCESSING LIST!&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|EXIT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|PRESTO_CLEAR_FSETROOT
suffix:colon
(brace
multiline_comment|/*&n;                 * Close KML files.&n;                 */
r_int
id|error
suffix:semicolon
r_int
id|saved_pid
op_assign
id|upccom-&gt;uc_pid
suffix:semicolon
r_char
op_star
id|path
suffix:semicolon
r_struct
(brace
r_char
op_star
id|path
suffix:semicolon
r_int
id|path_len
suffix:semicolon
)brace
id|input
suffix:semicolon
id|error
op_assign
id|copy_from_user
c_func
(paren
op_amp
id|input
comma
(paren
r_char
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|input
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|PRESTO_ALLOC
c_func
(paren
id|path
comma
r_char
op_star
comma
id|input.path_len
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|path
)paren
(brace
id|EXIT
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|error
op_assign
id|copy_from_user
c_func
(paren
id|path
comma
id|input.path
comma
id|input.path_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|PRESTO_FREE
c_func
(paren
id|path
comma
id|input.path_len
op_plus
l_int|1
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|path
(braket
id|input.path_len
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_PSDEV
comma
l_string|&quot;clear_fsetroot: path %s&bslash;n&quot;
comma
id|path
)paren
suffix:semicolon
id|upccom-&gt;uc_pid
op_assign
id|current-&gt;pid
suffix:semicolon
id|error
op_assign
id|presto_clear_fsetroot
c_func
(paren
id|path
)paren
suffix:semicolon
id|upccom-&gt;uc_pid
op_assign
id|saved_pid
suffix:semicolon
id|PRESTO_FREE
c_func
(paren
id|path
comma
id|input.path_len
op_plus
l_int|1
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
r_case
id|PRESTO_CLEAR_ALL_FSETROOTS
suffix:colon
(brace
multiline_comment|/*&n;                 * Close KML files.&n;                 */
r_int
id|error
suffix:semicolon
r_int
id|saved_pid
op_assign
id|upccom-&gt;uc_pid
suffix:semicolon
r_char
op_star
id|path
suffix:semicolon
r_struct
(brace
r_char
op_star
id|path
suffix:semicolon
r_int
id|path_len
suffix:semicolon
)brace
id|input
suffix:semicolon
id|error
op_assign
id|copy_from_user
c_func
(paren
op_amp
id|input
comma
(paren
r_char
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|input
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|PRESTO_ALLOC
c_func
(paren
id|path
comma
r_char
op_star
comma
id|input.path_len
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|path
)paren
(brace
id|EXIT
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|error
op_assign
id|copy_from_user
c_func
(paren
id|path
comma
id|input.path
comma
id|input.path_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|PRESTO_FREE
c_func
(paren
id|path
comma
id|input.path_len
op_plus
l_int|1
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|path
(braket
id|input.path_len
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_PSDEV
comma
l_string|&quot;clear_all_fsetroot: path %s&bslash;n&quot;
comma
id|path
)paren
suffix:semicolon
id|upccom-&gt;uc_pid
op_assign
id|current-&gt;pid
suffix:semicolon
id|error
op_assign
id|presto_clear_all_fsetroots
c_func
(paren
id|path
)paren
suffix:semicolon
id|upccom-&gt;uc_pid
op_assign
id|saved_pid
suffix:semicolon
id|PRESTO_FREE
c_func
(paren
id|path
comma
id|input.path_len
op_plus
l_int|1
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
r_case
id|PRESTO_GET_KMLSIZE
suffix:colon
(brace
r_int
id|error
suffix:semicolon
r_int
id|saved_pid
op_assign
id|upccom-&gt;uc_pid
suffix:semicolon
r_char
op_star
id|path
suffix:semicolon
r_int
id|size
op_assign
l_int|0
suffix:semicolon
r_struct
(brace
id|__u64
id|size
suffix:semicolon
r_char
op_star
id|path
suffix:semicolon
r_int
id|path_len
suffix:semicolon
)brace
id|input
suffix:semicolon
id|error
op_assign
id|copy_from_user
c_func
(paren
op_amp
id|input
comma
(paren
r_char
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|input
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|PRESTO_ALLOC
c_func
(paren
id|path
comma
r_char
op_star
comma
id|input.path_len
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|path
)paren
(brace
id|EXIT
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|error
op_assign
id|copy_from_user
c_func
(paren
id|path
comma
id|input.path
comma
id|input.path_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|PRESTO_FREE
c_func
(paren
id|path
comma
id|input.path_len
op_plus
l_int|1
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|path
(braket
id|input.path_len
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_PSDEV
comma
l_string|&quot;get_kmlsize: len %d path %s&bslash;n&quot;
comma
id|input.path_len
comma
id|path
)paren
suffix:semicolon
id|upccom-&gt;uc_pid
op_assign
id|current-&gt;pid
suffix:semicolon
id|error
op_assign
id|presto_get_kmlsize
c_func
(paren
id|path
comma
op_amp
id|size
)paren
suffix:semicolon
id|PRESTO_FREE
c_func
(paren
id|path
comma
id|input.path_len
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|input.size
op_assign
id|size
suffix:semicolon
id|upccom-&gt;uc_pid
op_assign
id|saved_pid
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_PSDEV
comma
l_string|&quot;get_kmlsize: size = %Zd&bslash;n&quot;
comma
id|size
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|copy_to_user
c_func
(paren
(paren
r_char
op_star
)paren
id|arg
comma
op_amp
id|input
comma
r_sizeof
(paren
id|input
)paren
)paren
suffix:semicolon
)brace
r_case
id|PRESTO_GET_RECNO
suffix:colon
(brace
r_int
id|error
suffix:semicolon
r_int
id|saved_pid
op_assign
id|upccom-&gt;uc_pid
suffix:semicolon
r_char
op_star
id|path
suffix:semicolon
id|off_t
id|recno
op_assign
l_int|0
suffix:semicolon
r_struct
(brace
id|__u64
id|recno
suffix:semicolon
r_char
op_star
id|path
suffix:semicolon
r_int
id|path_len
suffix:semicolon
)brace
id|input
suffix:semicolon
id|error
op_assign
id|copy_from_user
c_func
(paren
op_amp
id|input
comma
(paren
r_char
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|input
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|PRESTO_ALLOC
c_func
(paren
id|path
comma
r_char
op_star
comma
id|input.path_len
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|path
)paren
(brace
id|EXIT
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|error
op_assign
id|copy_from_user
c_func
(paren
id|path
comma
id|input.path
comma
id|input.path_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|PRESTO_FREE
c_func
(paren
id|path
comma
id|input.path_len
op_plus
l_int|1
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|path
(braket
id|input.path_len
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_PSDEV
comma
l_string|&quot;get_recno: len %d path %s&bslash;n&quot;
comma
id|input.path_len
comma
id|path
)paren
suffix:semicolon
id|upccom-&gt;uc_pid
op_assign
id|current-&gt;pid
suffix:semicolon
id|error
op_assign
id|presto_get_lastrecno
c_func
(paren
id|path
comma
op_amp
id|recno
)paren
suffix:semicolon
id|PRESTO_FREE
c_func
(paren
id|path
comma
id|input.path_len
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|input.recno
op_assign
id|recno
suffix:semicolon
id|upccom-&gt;uc_pid
op_assign
id|saved_pid
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_PSDEV
comma
l_string|&quot;get_recno: recno = %d&bslash;n&quot;
comma
(paren
r_int
)paren
id|recno
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|copy_to_user
c_func
(paren
(paren
r_char
op_star
)paren
id|arg
comma
op_amp
id|input
comma
r_sizeof
(paren
id|input
)paren
)paren
suffix:semicolon
)brace
r_case
id|PRESTO_SET_FSETROOT
suffix:colon
(brace
multiline_comment|/*&n;                 * Save information about the cache, and initialize &quot;special&quot;&n;                 * cache files (KML, etc).&n;                 */
r_int
id|error
suffix:semicolon
r_int
id|saved_pid
op_assign
id|upccom-&gt;uc_pid
suffix:semicolon
r_char
op_star
id|fsetname
suffix:semicolon
r_char
op_star
id|path
suffix:semicolon
r_struct
(brace
r_char
op_star
id|path
suffix:semicolon
r_int
id|path_len
suffix:semicolon
r_char
op_star
id|name
suffix:semicolon
r_int
id|name_len
suffix:semicolon
r_int
id|id
suffix:semicolon
r_int
id|flags
suffix:semicolon
)brace
id|input
suffix:semicolon
id|error
op_assign
id|copy_from_user
c_func
(paren
op_amp
id|input
comma
(paren
r_char
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|input
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|PRESTO_ALLOC
c_func
(paren
id|path
comma
r_char
op_star
comma
id|input.path_len
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|path
)paren
(brace
id|EXIT
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|error
op_assign
id|copy_from_user
c_func
(paren
id|path
comma
id|input.path
comma
id|input.path_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_goto
id|exit_free_path
suffix:semicolon
)brace
id|path
(braket
id|input.path_len
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|PRESTO_ALLOC
c_func
(paren
id|fsetname
comma
r_char
op_star
comma
id|input.name_len
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fsetname
)paren
(brace
id|error
op_assign
op_minus
id|ENOMEM
suffix:semicolon
id|EXIT
suffix:semicolon
r_goto
id|exit_free_path
suffix:semicolon
)brace
id|error
op_assign
id|copy_from_user
c_func
(paren
id|fsetname
comma
id|input.name
comma
id|input.name_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_goto
id|exit_free_fsetname
suffix:semicolon
)brace
id|fsetname
(braket
id|input.name_len
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_PSDEV
comma
l_string|&quot;set_fsetroot: path %s name %s, id %d, flags %x&bslash;n&quot;
comma
id|path
comma
id|fsetname
comma
id|input.id
comma
id|input.flags
)paren
suffix:semicolon
id|upccom-&gt;uc_pid
op_assign
id|current-&gt;pid
suffix:semicolon
id|error
op_assign
id|presto_set_fsetroot
c_func
(paren
id|path
comma
id|fsetname
comma
id|input.id
comma
id|input.flags
)paren
suffix:semicolon
id|upccom-&gt;uc_pid
op_assign
id|saved_pid
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_goto
id|exit_free_fsetname
suffix:semicolon
)brace
multiline_comment|/* fsetname is kept in the fset, so don&squot;t free it now */
id|PRESTO_FREE
c_func
(paren
id|path
comma
id|input.path_len
op_plus
l_int|1
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|exit_free_fsetname
suffix:colon
id|PRESTO_FREE
c_func
(paren
id|fsetname
comma
id|input.name_len
op_plus
l_int|1
)paren
suffix:semicolon
id|exit_free_path
suffix:colon
id|PRESTO_FREE
c_func
(paren
id|path
comma
id|input.path_len
op_plus
l_int|1
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
r_case
id|PRESTO_CLOSE_JOURNALF
suffix:colon
(brace
r_int
id|saved_pid
op_assign
id|upccom-&gt;uc_pid
suffix:semicolon
r_int
id|error
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_SUPER
comma
l_string|&quot;HELLO&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* pretend we are lento: we should lock something */
id|upccom-&gt;uc_pid
op_assign
id|current-&gt;pid
suffix:semicolon
id|error
op_assign
id|presto_close_journal_file
c_func
(paren
l_int|NULL
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_PSDEV
comma
l_string|&quot;error is %d&bslash;n&quot;
comma
id|error
)paren
suffix:semicolon
id|upccom-&gt;uc_pid
op_assign
id|saved_pid
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
r_case
id|PRESTO_GETOPT
suffix:colon
r_case
id|PRESTO_SETOPT
suffix:colon
(brace
multiline_comment|/* return all the mounts for this device.  */
r_int
id|dosetopt
c_func
(paren
r_int
comma
r_struct
id|psdev_opt
op_star
)paren
suffix:semicolon
r_int
id|dogetopt
c_func
(paren
r_int
comma
r_struct
id|psdev_opt
op_star
)paren
suffix:semicolon
r_int
id|minor
op_assign
l_int|0
suffix:semicolon
r_struct
id|psdev_opt
id|kopt
suffix:semicolon
r_struct
id|psdev_opt
op_star
id|user_opt
op_assign
(paren
r_struct
id|psdev_opt
op_star
)paren
id|arg
suffix:semicolon
r_int
id|error
suffix:semicolon
id|error
op_assign
id|copy_from_user
c_func
(paren
op_amp
id|kopt
comma
(paren
r_void
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|kopt
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;psdev: can&squot;t copyin %Zd bytes from %p to %p&bslash;n&quot;
comma
r_sizeof
(paren
id|kopt
)paren
comma
(paren
r_struct
id|kopt
op_star
)paren
id|arg
comma
op_amp
id|kopt
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|minor
op_assign
id|minor
c_func
(paren
id|dev
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cmd
op_eq
id|PRESTO_SETOPT
)paren
id|error
op_assign
id|dosetopt
c_func
(paren
id|minor
comma
op_amp
id|kopt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|CDEBUG
c_func
(paren
id|D_PSDEV
comma
l_string|&quot;dosetopt failed minor %d, opt %d, val %d&bslash;n&quot;
comma
id|minor
comma
id|kopt.optname
comma
id|kopt.optval
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|error
op_assign
id|dogetopt
c_func
(paren
id|minor
comma
op_amp
id|kopt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|CDEBUG
c_func
(paren
id|D_PSDEV
comma
l_string|&quot;dogetopt failed minor %d, opt %d, val %d&bslash;n&quot;
comma
id|minor
comma
id|kopt.optname
comma
id|kopt.optval
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|error
op_assign
id|copy_to_user
c_func
(paren
id|user_opt
comma
op_amp
id|kopt
comma
r_sizeof
(paren
id|kopt
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|CDEBUG
c_func
(paren
id|D_PSDEV
comma
l_string|&quot;Copy_to_user opt 0x%p failed&bslash;n&quot;
comma
id|user_opt
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|CDEBUG
c_func
(paren
id|D_PSDEV
comma
l_string|&quot;dosetopt minor %d, opt %d, val %d return %d&bslash;n&quot;
comma
id|minor
comma
id|kopt.optname
comma
id|kopt.optval
comma
id|error
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|PRESTO_VFS_SETATTR
suffix:colon
(brace
r_int
id|error
suffix:semicolon
r_struct
id|lento_input_attr
id|input
suffix:semicolon
r_struct
id|iattr
id|iattr
suffix:semicolon
id|error
op_assign
id|copy_from_user
c_func
(paren
op_amp
id|input
comma
(paren
r_char
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|input
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|iattr.ia_valid
op_assign
id|input.valid
suffix:semicolon
id|iattr.ia_mode
op_assign
(paren
id|umode_t
)paren
id|input.mode
suffix:semicolon
id|iattr.ia_uid
op_assign
(paren
id|uid_t
)paren
id|input.uid
suffix:semicolon
id|iattr.ia_gid
op_assign
(paren
id|gid_t
)paren
id|input.gid
suffix:semicolon
id|iattr.ia_size
op_assign
(paren
id|off_t
)paren
id|input.size
suffix:semicolon
id|iattr.ia_atime
op_assign
(paren
id|time_t
)paren
id|input.atime
suffix:semicolon
id|iattr.ia_mtime
op_assign
(paren
id|time_t
)paren
id|input.mtime
suffix:semicolon
id|iattr.ia_ctime
op_assign
(paren
id|time_t
)paren
id|input.ctime
suffix:semicolon
id|iattr.ia_attr_flags
op_assign
id|input.attr_flags
suffix:semicolon
id|error
op_assign
id|lento_setattr
c_func
(paren
id|input.name
comma
op_amp
id|iattr
comma
op_amp
id|input.info
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
r_case
id|PRESTO_VFS_CREATE
suffix:colon
(brace
r_int
id|error
suffix:semicolon
r_struct
id|lento_input_mode
id|input
suffix:semicolon
id|error
op_assign
id|copy_from_user
c_func
(paren
op_amp
id|input
comma
(paren
r_char
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|input
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|error
op_assign
id|lento_create
c_func
(paren
id|input.name
comma
id|input.mode
comma
op_amp
id|input.info
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
r_case
id|PRESTO_VFS_LINK
suffix:colon
(brace
r_int
id|error
suffix:semicolon
r_struct
id|lento_input_old_new
id|input
suffix:semicolon
id|error
op_assign
id|copy_from_user
c_func
(paren
op_amp
id|input
comma
(paren
r_char
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|input
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|error
op_assign
id|lento_link
c_func
(paren
id|input.oldname
comma
id|input.newname
comma
op_amp
id|input.info
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
r_case
id|PRESTO_VFS_UNLINK
suffix:colon
(brace
r_int
id|error
suffix:semicolon
r_struct
id|lento_input
id|input
suffix:semicolon
id|error
op_assign
id|copy_from_user
c_func
(paren
op_amp
id|input
comma
(paren
r_char
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|input
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|error
op_assign
id|lento_unlink
c_func
(paren
id|input.name
comma
op_amp
id|input.info
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
r_case
id|PRESTO_VFS_SYMLINK
suffix:colon
(brace
r_int
id|error
suffix:semicolon
r_struct
id|lento_input_old_new
id|input
suffix:semicolon
id|error
op_assign
id|copy_from_user
c_func
(paren
op_amp
id|input
comma
(paren
r_char
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|input
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|error
op_assign
id|lento_symlink
c_func
(paren
id|input.oldname
comma
id|input.newname
comma
op_amp
id|input.info
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
r_case
id|PRESTO_VFS_MKDIR
suffix:colon
(brace
r_int
id|error
suffix:semicolon
r_struct
id|lento_input_mode
id|input
suffix:semicolon
id|error
op_assign
id|copy_from_user
c_func
(paren
op_amp
id|input
comma
(paren
r_char
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|input
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|error
op_assign
id|lento_mkdir
c_func
(paren
id|input.name
comma
id|input.mode
comma
op_amp
id|input.info
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
r_case
id|PRESTO_VFS_RMDIR
suffix:colon
(brace
r_int
id|error
suffix:semicolon
r_struct
id|lento_input
id|input
suffix:semicolon
id|error
op_assign
id|copy_from_user
c_func
(paren
op_amp
id|input
comma
(paren
r_char
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|input
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|error
op_assign
id|lento_rmdir
c_func
(paren
id|input.name
comma
op_amp
id|input.info
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
r_case
id|PRESTO_VFS_MKNOD
suffix:colon
(brace
r_int
id|error
suffix:semicolon
r_struct
id|lento_input_dev
id|input
suffix:semicolon
id|error
op_assign
id|copy_from_user
c_func
(paren
op_amp
id|input
comma
(paren
r_char
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|input
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|error
op_assign
id|lento_mknod
c_func
(paren
id|input.name
comma
id|input.mode
comma
id|MKDEV
c_func
(paren
id|input.major
comma
id|input.minor
)paren
comma
op_amp
id|input.info
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
r_case
id|PRESTO_VFS_RENAME
suffix:colon
(brace
r_int
id|error
suffix:semicolon
r_struct
id|lento_input_old_new
id|input
suffix:semicolon
id|error
op_assign
id|copy_from_user
c_func
(paren
op_amp
id|input
comma
(paren
r_char
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|input
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|error
op_assign
id|lento_rename
c_func
(paren
id|input.oldname
comma
id|input.newname
comma
op_amp
id|input.info
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_FS_EXT_ATTR
multiline_comment|/* IOCTL to create/modify an extended attribute */
r_case
id|PRESTO_VFS_SETEXTATTR
suffix:colon
(brace
r_int
id|error
suffix:semicolon
r_struct
id|lento_input_ext_attr
id|input
suffix:semicolon
r_char
op_star
id|name
suffix:semicolon
r_char
op_star
id|buffer
suffix:semicolon
id|error
op_assign
id|copy_from_user
c_func
(paren
op_amp
id|input
comma
(paren
r_char
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|input
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
multiline_comment|/* Now setup the input parameters */
id|PRESTO_ALLOC
c_func
(paren
id|name
comma
r_char
op_star
comma
id|input.name_len
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* We need null terminated strings for attr names */
id|name
(braket
id|input.name_len
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|error
op_assign
id|copy_from_user
c_func
(paren
id|name
comma
id|input.name
comma
id|input.name_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
id|PRESTO_FREE
c_func
(paren
id|name
comma
id|input.name_len
op_plus
l_int|1
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|PRESTO_ALLOC
c_func
(paren
id|buffer
comma
r_char
op_star
comma
id|input.buffer_len
op_plus
l_int|1
)paren
suffix:semicolon
id|error
op_assign
id|copy_from_user
c_func
(paren
id|buffer
comma
id|input.buffer
comma
id|input.buffer_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
id|PRESTO_FREE
c_func
(paren
id|name
comma
id|input.name_len
op_plus
l_int|1
)paren
suffix:semicolon
id|PRESTO_FREE
c_func
(paren
id|buffer
comma
id|input.buffer_len
op_plus
l_int|1
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
multiline_comment|/* Make null terminated for easy printing */
id|buffer
(braket
id|input.buffer_len
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_PSDEV
comma
l_string|&quot; setextattr params: name %s, valuelen %d,&quot;
l_string|&quot; value %s, attr flags %x, mode %o, slot offset %d,&quot;
l_string|&quot; recno %d, kml offset %lu, flags %x, time %d&bslash;n&quot;
comma
id|name
comma
id|input.buffer_len
comma
id|buffer
comma
id|input.flags
comma
id|input.mode
comma
id|input.info.slot_offset
comma
id|input.info.recno
comma
(paren
r_int
r_int
)paren
id|input.info.kml_offset
comma
id|input.info.flags
comma
id|input.info.updated_time
)paren
suffix:semicolon
id|error
op_assign
id|lento_set_ext_attr
(paren
id|input.path
comma
id|name
comma
id|buffer
comma
id|input.buffer_len
comma
id|input.flags
comma
id|input.mode
comma
op_amp
id|input.info
)paren
suffix:semicolon
id|PRESTO_FREE
c_func
(paren
id|name
comma
id|input.name_len
op_plus
l_int|1
)paren
suffix:semicolon
id|PRESTO_FREE
c_func
(paren
id|buffer
comma
id|input.buffer_len
op_plus
l_int|1
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
multiline_comment|/* IOCTL to delete an extended attribute */
r_case
id|PRESTO_VFS_DELEXTATTR
suffix:colon
(brace
r_int
id|error
suffix:semicolon
r_struct
id|lento_input_ext_attr
id|input
suffix:semicolon
r_char
op_star
id|name
suffix:semicolon
id|error
op_assign
id|copy_from_user
c_func
(paren
op_amp
id|input
comma
(paren
r_char
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|input
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
multiline_comment|/* Now setup the input parameters */
id|PRESTO_ALLOC
c_func
(paren
id|name
comma
r_char
op_star
comma
id|input.name_len
op_plus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* We need null terminated strings for attr names */
id|name
(braket
id|input.name_len
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|error
op_assign
id|copy_from_user
c_func
(paren
id|name
comma
id|input.name
comma
id|input.name_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
id|PRESTO_FREE
c_func
(paren
id|name
comma
id|input.name_len
op_plus
l_int|1
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|CDEBUG
c_func
(paren
id|D_PSDEV
comma
l_string|&quot; delextattr params: name %s,&quot;
l_string|&quot; attr flags %x, mode %o, slot offset %d, recno %d,&quot;
l_string|&quot; kml offset %lu, flags %x, time %d&bslash;n&quot;
comma
id|name
comma
id|input.flags
comma
id|input.mode
comma
id|input.info.slot_offset
comma
id|input.info.recno
comma
(paren
r_int
r_int
)paren
id|input.info.kml_offset
comma
id|input.info.flags
comma
id|input.info.updated_time
)paren
suffix:semicolon
id|error
op_assign
id|lento_set_ext_attr
(paren
id|input.path
comma
id|name
comma
l_int|NULL
comma
l_int|0
comma
id|input.flags
comma
id|input.mode
comma
op_amp
id|input.info
)paren
suffix:semicolon
id|PRESTO_FREE
c_func
(paren
id|name
comma
id|input.name_len
op_plus
l_int|1
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
macro_line|#endif
r_case
id|PRESTO_VFS_IOPEN
suffix:colon
(brace
r_struct
id|lento_input_iopen
id|input
suffix:semicolon
r_int
id|error
suffix:semicolon
id|error
op_assign
id|copy_from_user
c_func
(paren
op_amp
id|input
comma
(paren
r_char
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|input
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|input.fd
op_assign
id|lento_iopen
c_func
(paren
id|input.name
comma
(paren
id|ino_t
)paren
id|input.ino
comma
id|input.generation
comma
id|input.flags
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_PIOCTL
comma
l_string|&quot;lento_iopen file descriptor: %d&bslash;n&quot;
comma
id|input.fd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|input.fd
OL
l_int|0
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|input.fd
suffix:semicolon
)brace
id|EXIT
suffix:semicolon
r_return
id|copy_to_user
c_func
(paren
(paren
r_char
op_star
)paren
id|arg
comma
op_amp
id|input
comma
r_sizeof
(paren
id|input
)paren
)paren
suffix:semicolon
)brace
r_case
id|PRESTO_VFS_CLOSE
suffix:colon
(brace
r_int
id|error
suffix:semicolon
r_struct
id|lento_input_close
id|input
suffix:semicolon
id|error
op_assign
id|copy_from_user
c_func
(paren
op_amp
id|input
comma
(paren
r_char
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|input
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|CDEBUG
c_func
(paren
id|D_PIOCTL
comma
l_string|&quot;lento_close file descriptor: %d&bslash;n&quot;
comma
id|input.fd
)paren
suffix:semicolon
id|error
op_assign
id|lento_close
c_func
(paren
id|input.fd
comma
op_amp
id|input.info
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
r_case
id|PRESTO_BACKFETCH_LML
suffix:colon
(brace
r_char
op_star
id|user_path
suffix:semicolon
r_int
id|error
suffix:semicolon
r_struct
id|lml_arg
(brace
r_char
op_star
id|path
suffix:semicolon
id|__u32
id|path_len
suffix:semicolon
id|__u64
id|remote_ino
suffix:semicolon
id|__u32
id|remote_generation
suffix:semicolon
id|__u32
id|remote_version
suffix:semicolon
r_struct
id|presto_version
id|remote_file_version
suffix:semicolon
)brace
id|input
suffix:semicolon
id|error
op_assign
id|copy_from_user
c_func
(paren
op_amp
id|input
comma
(paren
r_char
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|input
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|user_path
op_assign
id|input.path
suffix:semicolon
id|PRESTO_ALLOC
c_func
(paren
id|input.path
comma
r_char
op_star
comma
id|input.path_len
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|input.path
)paren
(brace
id|EXIT
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|error
op_assign
id|copy_from_user
c_func
(paren
id|input.path
comma
id|user_path
comma
id|input.path_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
id|PRESTO_FREE
c_func
(paren
id|input.path
comma
id|input.path_len
op_plus
l_int|1
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|input.path
(braket
id|input.path_len
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_DOWNCALL
comma
l_string|&quot;lml name: %s&bslash;n&quot;
comma
id|input.path
)paren
suffix:semicolon
r_return
id|lento_write_lml
c_func
(paren
id|input.path
comma
id|input.remote_ino
comma
id|input.remote_generation
comma
id|input.remote_version
comma
op_amp
id|input.remote_file_version
)paren
suffix:semicolon
)brace
r_case
id|PRESTO_CANCEL_LML
suffix:colon
(brace
r_char
op_star
id|user_path
suffix:semicolon
r_int
id|error
suffix:semicolon
r_struct
id|lml_arg
(brace
r_char
op_star
id|path
suffix:semicolon
id|__u64
id|lml_offset
suffix:semicolon
id|__u32
id|path_len
suffix:semicolon
id|__u64
id|remote_ino
suffix:semicolon
id|__u32
id|remote_generation
suffix:semicolon
id|__u32
id|remote_version
suffix:semicolon
r_struct
id|lento_vfs_context
id|info
suffix:semicolon
)brace
id|input
suffix:semicolon
id|error
op_assign
id|copy_from_user
c_func
(paren
op_amp
id|input
comma
(paren
r_char
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|input
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|user_path
op_assign
id|input.path
suffix:semicolon
id|PRESTO_ALLOC
c_func
(paren
id|input.path
comma
r_char
op_star
comma
id|input.path_len
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|input.path
)paren
(brace
id|EXIT
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|error
op_assign
id|copy_from_user
c_func
(paren
id|input.path
comma
id|user_path
comma
id|input.path_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
id|PRESTO_FREE
c_func
(paren
id|input.path
comma
id|input.path_len
op_plus
l_int|1
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|input.path
(braket
id|input.path_len
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_DOWNCALL
comma
l_string|&quot;lml name: %s&bslash;n&quot;
comma
id|input.path
)paren
suffix:semicolon
r_return
id|lento_cancel_lml
c_func
(paren
id|input.path
comma
id|input.lml_offset
comma
id|input.remote_ino
comma
id|input.remote_generation
comma
id|input.remote_version
comma
op_amp
id|input.info
)paren
suffix:semicolon
)brace
r_case
id|PRESTO_COMPLETE_CLOSES
suffix:colon
(brace
r_char
op_star
id|user_path
suffix:semicolon
r_int
id|error
suffix:semicolon
r_struct
id|lml_arg
(brace
r_char
op_star
id|path
suffix:semicolon
id|__u32
id|path_len
suffix:semicolon
)brace
id|input
suffix:semicolon
id|error
op_assign
id|copy_from_user
c_func
(paren
op_amp
id|input
comma
(paren
r_char
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|input
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|user_path
op_assign
id|input.path
suffix:semicolon
id|PRESTO_ALLOC
c_func
(paren
id|input.path
comma
r_char
op_star
comma
id|input.path_len
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|input.path
)paren
(brace
id|EXIT
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|error
op_assign
id|copy_from_user
c_func
(paren
id|input.path
comma
id|user_path
comma
id|input.path_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
id|PRESTO_FREE
c_func
(paren
id|input.path
comma
id|input.path_len
op_plus
l_int|1
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|input.path
(braket
id|input.path_len
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_DOWNCALL
comma
l_string|&quot;lml name: %s&bslash;n&quot;
comma
id|input.path
)paren
suffix:semicolon
id|error
op_assign
id|lento_complete_closes
c_func
(paren
id|input.path
)paren
suffix:semicolon
id|PRESTO_FREE
c_func
(paren
id|input.path
comma
id|input.path_len
op_plus
l_int|1
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
r_case
id|PRESTO_RESET_FSET
suffix:colon
(brace
r_char
op_star
id|user_path
suffix:semicolon
r_int
id|error
suffix:semicolon
r_struct
id|lml_arg
(brace
r_char
op_star
id|path
suffix:semicolon
id|__u32
id|path_len
suffix:semicolon
id|__u64
id|offset
suffix:semicolon
id|__u32
id|recno
suffix:semicolon
)brace
id|input
suffix:semicolon
id|error
op_assign
id|copy_from_user
c_func
(paren
op_amp
id|input
comma
(paren
r_char
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|input
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|user_path
op_assign
id|input.path
suffix:semicolon
id|PRESTO_ALLOC
c_func
(paren
id|input.path
comma
r_char
op_star
comma
id|input.path_len
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|input.path
)paren
(brace
id|EXIT
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|error
op_assign
id|copy_from_user
c_func
(paren
id|input.path
comma
id|user_path
comma
id|input.path_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
id|PRESTO_FREE
c_func
(paren
id|input.path
comma
id|input.path_len
op_plus
l_int|1
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|input.path
(braket
id|input.path_len
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_DOWNCALL
comma
l_string|&quot;lml name: %s&bslash;n&quot;
comma
id|input.path
)paren
suffix:semicolon
r_return
id|lento_reset_fset
c_func
(paren
id|input.path
comma
id|input.offset
comma
id|input.recno
)paren
suffix:semicolon
)brace
r_case
id|PRESTO_MARK
suffix:colon
(brace
r_char
op_star
id|user_path
suffix:semicolon
r_int
id|res
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* resulting flags - returned to user */
r_int
id|error
suffix:semicolon
r_struct
(brace
r_int
id|mark_what
suffix:semicolon
r_int
id|and_flag
suffix:semicolon
r_int
id|or_flag
suffix:semicolon
r_int
id|path_len
suffix:semicolon
r_char
op_star
id|path
suffix:semicolon
)brace
id|input
suffix:semicolon
id|error
op_assign
id|copy_from_user
c_func
(paren
op_amp
id|input
comma
(paren
r_char
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|input
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|user_path
op_assign
id|input.path
suffix:semicolon
id|PRESTO_ALLOC
c_func
(paren
id|input.path
comma
r_char
op_star
comma
id|input.path_len
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|input.path
)paren
(brace
id|EXIT
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|error
op_assign
id|copy_from_user
c_func
(paren
id|input.path
comma
id|user_path
comma
id|input.path_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
id|PRESTO_FREE
c_func
(paren
id|input.path
comma
id|input.path_len
op_plus
l_int|1
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|input.path
(braket
id|input.path_len
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_DOWNCALL
comma
l_string|&quot;mark name: %s, and: %x, or: %x, what %d&bslash;n&quot;
comma
id|input.path
comma
id|input.and_flag
comma
id|input.or_flag
comma
id|input.mark_what
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|input.mark_what
)paren
(brace
r_case
id|MARK_DENTRY
suffix:colon
id|error
op_assign
id|presto_mark_dentry
c_func
(paren
id|input.path
comma
id|input.and_flag
comma
id|input.or_flag
comma
op_amp
id|res
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MARK_FSET
suffix:colon
id|error
op_assign
id|presto_mark_fset
c_func
(paren
id|input.path
comma
id|input.and_flag
comma
id|input.or_flag
comma
op_amp
id|res
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MARK_CACHE
suffix:colon
id|error
op_assign
id|presto_mark_cache
c_func
(paren
id|input.path
comma
id|input.and_flag
comma
id|input.or_flag
comma
op_amp
id|res
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MARK_GETFL
suffix:colon
(brace
r_int
id|fflags
comma
id|cflags
suffix:semicolon
id|input.and_flag
op_assign
l_int|0xffffffff
suffix:semicolon
id|input.or_flag
op_assign
l_int|0
suffix:semicolon
id|error
op_assign
id|presto_mark_dentry
c_func
(paren
id|input.path
comma
id|input.and_flag
comma
id|input.or_flag
comma
op_amp
id|res
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_break
suffix:semicolon
id|error
op_assign
id|presto_mark_fset
c_func
(paren
id|input.path
comma
id|input.and_flag
comma
id|input.or_flag
comma
op_amp
id|fflags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_break
suffix:semicolon
id|error
op_assign
id|presto_mark_cache
c_func
(paren
id|input.path
comma
id|input.and_flag
comma
id|input.or_flag
comma
op_amp
id|cflags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_break
suffix:semicolon
id|input.and_flag
op_assign
id|fflags
suffix:semicolon
id|input.or_flag
op_assign
id|cflags
suffix:semicolon
r_break
suffix:semicolon
)brace
r_default
suffix:colon
id|error
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
id|PRESTO_FREE
c_func
(paren
id|input.path
comma
id|input.path_len
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
op_eq
op_minus
id|EBUSY
)paren
(brace
id|input.and_flag
op_assign
id|error
suffix:semicolon
id|error
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
multiline_comment|/* return the correct cookie to wait for */
id|input.mark_what
op_assign
id|res
suffix:semicolon
r_return
id|copy_to_user
c_func
(paren
(paren
r_char
op_star
)paren
id|arg
comma
op_amp
id|input
comma
r_sizeof
(paren
id|input
)paren
)paren
suffix:semicolon
)brace
macro_line|#ifdef  CONFIG_KREINT
r_case
id|PRESTO_REINT_BEGIN
suffix:colon
r_return
id|begin_kml_reint
(paren
id|file
comma
id|arg
)paren
suffix:semicolon
r_case
id|PRESTO_DO_REINT
suffix:colon
r_return
id|do_kml_reint
(paren
id|file
comma
id|arg
)paren
suffix:semicolon
r_case
id|PRESTO_REINT_END
suffix:colon
r_return
id|end_kml_reint
(paren
id|file
comma
id|arg
)paren
suffix:semicolon
macro_line|#endif
r_case
id|PRESTO_RELEASE_PERMIT
suffix:colon
(brace
r_int
id|error
suffix:semicolon
r_char
op_star
id|user_path
suffix:semicolon
r_struct
(brace
r_int
id|cookie
suffix:semicolon
r_int
id|path_len
suffix:semicolon
r_char
op_star
id|path
suffix:semicolon
)brace
id|permit
suffix:semicolon
id|error
op_assign
id|copy_from_user
c_func
(paren
op_amp
id|permit
comma
(paren
r_char
op_star
)paren
id|arg
comma
r_sizeof
(paren
id|permit
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|user_path
op_assign
id|permit.path
suffix:semicolon
id|PRESTO_ALLOC
c_func
(paren
id|permit.path
comma
r_char
op_star
comma
id|permit.path_len
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|permit.path
)paren
(brace
id|EXIT
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|error
op_assign
id|copy_from_user
c_func
(paren
id|permit.path
comma
id|user_path
comma
id|permit.path_len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
id|PRESTO_FREE
c_func
(paren
id|permit.path
comma
id|permit.path_len
op_plus
l_int|1
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|permit.path
(braket
id|permit.path_len
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_DOWNCALL
comma
l_string|&quot;release permit: %s, in cookie=%d&bslash;n&quot;
comma
id|permit.path
comma
id|permit.cookie
)paren
suffix:semicolon
id|error
op_assign
id|presto_permit_downcall
c_func
(paren
id|permit.path
comma
op_amp
id|permit.cookie
)paren
suffix:semicolon
id|PRESTO_FREE
c_func
(paren
id|permit.path
comma
id|permit.path_len
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
multiline_comment|/* return the correct cookie to wait for */
r_return
id|copy_to_user
c_func
(paren
(paren
r_char
op_star
)paren
id|arg
comma
op_amp
id|permit
comma
r_sizeof
(paren
id|permit
)paren
)paren
suffix:semicolon
)brace
r_default
suffix:colon
id|CDEBUG
c_func
(paren
id|D_PSDEV
comma
l_string|&quot;bad ioctl 0x%x, &bslash;n&quot;
comma
id|cmd
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_PSDEV
comma
l_string|&quot;valid are 0x%Zx - 0x%Zx, 0x%Zx - 0x%Zx &bslash;n&quot;
comma
id|PRESTO_GETMOUNT
comma
id|PRESTO_GET_KMLSIZE
comma
id|PRESTO_VFS_SETATTR
comma
id|PRESTO_VFS_IOPEN
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
DECL|function|presto_psdev_open
r_static
r_int
id|presto_psdev_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|upc_comm
op_star
id|upccom
suffix:semicolon
id|ENTRY
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|upccom
op_assign
id|presto_psdev_f2u
c_func
(paren
id|file
)paren
)paren
)paren
(brace
id|kdev_t
id|dev
op_assign
id|file-&gt;f_dentry-&gt;d_inode-&gt;i_rdev
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;InterMezzo: %s, bad device %s&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|kdevname
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|MOD_INC_USE_COUNT
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_PSDEV
comma
l_string|&quot;Psdev_open: uc_pid: %d, caller: %d, flags: %d&bslash;n&quot;
comma
id|upccom-&gt;uc_pid
comma
id|current-&gt;pid
comma
id|file-&gt;f_flags
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|presto_psdev_release
r_static
r_int
id|presto_psdev_release
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_struct
id|upc_comm
op_star
id|upccom
suffix:semicolon
r_struct
id|upc_req
op_star
id|req
suffix:semicolon
r_struct
id|list_head
op_star
id|lh
suffix:semicolon
id|ENTRY
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|upccom
op_assign
id|presto_psdev_f2u
c_func
(paren
id|file
)paren
)paren
)paren
(brace
id|kdev_t
id|dev
op_assign
id|file-&gt;f_dentry-&gt;d_inode-&gt;i_rdev
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;InterMezzo: %s, bad device %s&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|kdevname
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|upccom-&gt;uc_pid
op_ne
id|current-&gt;pid
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;psdev_release: Not lento.&bslash;n&quot;
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|MOD_DEC_USE_COUNT
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_PSDEV
comma
l_string|&quot;Lento: pid %d&bslash;n&quot;
comma
id|current-&gt;pid
)paren
suffix:semicolon
id|upccom-&gt;uc_pid
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* Wake up clients so they can return. */
id|CDEBUG
c_func
(paren
id|D_PSDEV
comma
l_string|&quot;Wake up clients sleeping for pending.&bslash;n&quot;
)paren
suffix:semicolon
id|lh
op_assign
op_amp
id|upccom-&gt;uc_pending
suffix:semicolon
r_while
c_loop
(paren
(paren
id|lh
op_assign
id|lh-&gt;next
)paren
op_ne
op_amp
id|upccom-&gt;uc_pending
)paren
(brace
id|req
op_assign
id|list_entry
c_func
(paren
id|lh
comma
r_struct
id|upc_req
comma
id|rq_chain
)paren
suffix:semicolon
multiline_comment|/* Async requests stay around for a new lento */
r_if
c_cond
(paren
id|req-&gt;rq_flags
op_amp
id|REQ_ASYNC
)paren
(brace
r_continue
suffix:semicolon
)brace
multiline_comment|/* the sleeper will free the req and data */
id|req-&gt;rq_flags
op_or_assign
id|REQ_DEAD
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|req-&gt;rq_sleep
)paren
suffix:semicolon
)brace
id|CDEBUG
c_func
(paren
id|D_PSDEV
comma
l_string|&quot;Wake up clients sleeping for processing&bslash;n&quot;
)paren
suffix:semicolon
id|lh
op_assign
op_amp
id|upccom-&gt;uc_processing
suffix:semicolon
r_while
c_loop
(paren
(paren
id|lh
op_assign
id|lh-&gt;next
)paren
op_ne
op_amp
id|upccom-&gt;uc_processing
)paren
(brace
id|req
op_assign
id|list_entry
c_func
(paren
id|lh
comma
r_struct
id|upc_req
comma
id|rq_chain
)paren
suffix:semicolon
multiline_comment|/* freeing of req and data is done by the sleeper */
id|req-&gt;rq_flags
op_or_assign
id|REQ_DEAD
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|req-&gt;rq_sleep
)paren
suffix:semicolon
)brace
id|CDEBUG
c_func
(paren
id|D_PSDEV
comma
l_string|&quot;Done.&bslash;n&quot;
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|presto_psdev_fops
r_static
r_struct
id|file_operations
id|presto_psdev_fops
op_assign
(brace
id|read
suffix:colon
id|presto_psdev_read
comma
id|write
suffix:colon
id|presto_psdev_write
comma
id|poll
suffix:colon
id|presto_psdev_poll
comma
id|ioctl
suffix:colon
id|presto_psdev_ioctl
comma
id|open
suffix:colon
id|presto_psdev_open
comma
id|release
suffix:colon
id|presto_psdev_release
)brace
suffix:semicolon
DECL|function|presto_psdev_init
r_int
id|presto_psdev_init
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
macro_line|#ifdef PRESTO_DEVEL
r_if
c_cond
(paren
id|register_chrdev
c_func
(paren
id|PRESTO_PSDEV_MAJOR
comma
l_string|&quot;intermezzo_psdev_devel&quot;
comma
op_amp
id|presto_psdev_fops
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;presto_psdev: unable to get major %d&bslash;n&quot;
comma
id|PRESTO_PSDEV_MAJOR
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
macro_line|#else
r_if
c_cond
(paren
id|register_chrdev
c_func
(paren
id|PRESTO_PSDEV_MAJOR
comma
l_string|&quot;intermezzo_psdev&quot;
comma
op_amp
id|presto_psdev_fops
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;presto_psdev: unable to get major %d&bslash;n&quot;
comma
id|PRESTO_PSDEV_MAJOR
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
macro_line|#endif
id|memset
c_func
(paren
op_amp
id|upc_comms
comma
l_int|0
comma
r_sizeof
(paren
id|upc_comms
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_PRESTODEV
suffix:semicolon
id|i
op_increment
)paren
(brace
r_char
op_star
id|name
suffix:semicolon
r_struct
id|upc_comm
op_star
id|psdev
op_assign
op_amp
id|upc_comms
(braket
id|i
)braket
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|psdev-&gt;uc_pending
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|psdev-&gt;uc_processing
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|psdev-&gt;uc_cache_list
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|psdev-&gt;uc_waitq
)paren
suffix:semicolon
id|psdev-&gt;uc_hard
op_assign
l_int|0
suffix:semicolon
id|psdev-&gt;uc_no_filter
op_assign
l_int|0
suffix:semicolon
id|psdev-&gt;uc_no_journal
op_assign
l_int|0
suffix:semicolon
id|psdev-&gt;uc_no_upcall
op_assign
l_int|0
suffix:semicolon
id|psdev-&gt;uc_timeout
op_assign
l_int|30
suffix:semicolon
id|psdev-&gt;uc_errorval
op_assign
l_int|0
suffix:semicolon
id|psdev-&gt;uc_minor
op_assign
id|i
suffix:semicolon
id|PRESTO_ALLOC
c_func
(paren
id|name
comma
r_char
op_star
comma
id|strlen
c_func
(paren
id|PRESTO_PSDEV_NAME
l_string|&quot;256&quot;
)paren
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|name
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Unable to allocate memory for device name&bslash;n&quot;
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|sprintf
c_func
(paren
id|name
comma
id|PRESTO_PSDEV_NAME
l_string|&quot;%d&quot;
comma
id|i
)paren
suffix:semicolon
id|psdev-&gt;uc_devname
op_assign
id|name
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|presto_psdev_cleanup
r_void
id|presto_psdev_cleanup
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|MAX_PRESTODEV
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|upc_comm
op_star
id|psdev
op_assign
op_amp
id|upc_comms
(braket
id|i
)braket
suffix:semicolon
r_struct
id|list_head
op_star
id|lh
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|psdev-&gt;uc_pending
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Weird, tell Peter: module cleanup and pending list not empty dev %d&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|psdev-&gt;uc_processing
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Weird, tell Peter: module cleanup and processing list not empty dev %d&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|psdev-&gt;uc_cache_list
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Weird, tell Peter: module cleanup and cache listnot empty dev %d&bslash;n&quot;
comma
id|i
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|psdev-&gt;uc_devname
)paren
(brace
id|PRESTO_FREE
c_func
(paren
id|psdev-&gt;uc_devname
comma
id|strlen
c_func
(paren
id|PRESTO_PSDEV_NAME
l_string|&quot;256&quot;
)paren
op_plus
l_int|1
)paren
suffix:semicolon
)brace
id|lh
op_assign
id|psdev-&gt;uc_pending.next
suffix:semicolon
r_while
c_loop
(paren
id|lh
op_ne
op_amp
id|psdev-&gt;uc_pending
)paren
(brace
r_struct
id|upc_req
op_star
id|req
suffix:semicolon
id|req
op_assign
id|list_entry
c_func
(paren
id|lh
comma
r_struct
id|upc_req
comma
id|rq_chain
)paren
suffix:semicolon
id|lh
op_assign
id|lh-&gt;next
suffix:semicolon
r_if
c_cond
(paren
id|req-&gt;rq_flags
op_amp
id|REQ_ASYNC
)paren
(brace
id|list_del
c_func
(paren
op_amp
(paren
id|req-&gt;rq_chain
)paren
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_UPCALL
comma
l_string|&quot;free pending upcall type %d&bslash;n&quot;
comma
id|req-&gt;rq_opcode
)paren
suffix:semicolon
id|PRESTO_FREE
c_func
(paren
id|req-&gt;rq_data
comma
id|req-&gt;rq_bufsize
)paren
suffix:semicolon
id|PRESTO_FREE
c_func
(paren
id|req
comma
r_sizeof
(paren
r_struct
id|upc_req
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|req-&gt;rq_flags
op_or_assign
id|REQ_DEAD
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|req-&gt;rq_sleep
)paren
suffix:semicolon
)brace
)brace
id|lh
op_assign
op_amp
id|psdev-&gt;uc_processing
suffix:semicolon
r_while
c_loop
(paren
(paren
id|lh
op_assign
id|lh-&gt;next
)paren
op_ne
op_amp
id|psdev-&gt;uc_processing
)paren
(brace
r_struct
id|upc_req
op_star
id|req
suffix:semicolon
id|req
op_assign
id|list_entry
c_func
(paren
id|lh
comma
r_struct
id|upc_req
comma
id|rq_chain
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
(paren
id|req-&gt;rq_chain
)paren
)paren
suffix:semicolon
id|req-&gt;rq_flags
op_or_assign
id|REQ_DEAD
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|req-&gt;rq_sleep
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/*&n; * lento_upcall and lento_downcall routines&n; */
DECL|function|lento_waitfor_upcall
r_static
r_inline
r_int
r_int
id|lento_waitfor_upcall
c_func
(paren
r_struct
id|upc_req
op_star
id|req
comma
r_int
id|minor
)paren
(brace
id|DECLARE_WAITQUEUE
c_func
(paren
id|wait
comma
id|current
)paren
suffix:semicolon
r_int
r_int
id|posttime
suffix:semicolon
id|req-&gt;rq_posttime
op_assign
id|posttime
op_assign
id|jiffies
suffix:semicolon
id|add_wait_queue
c_func
(paren
op_amp
id|req-&gt;rq_sleep
comma
op_amp
id|wait
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
r_if
c_cond
(paren
id|upc_comms
(braket
id|minor
)braket
dot
id|uc_hard
op_eq
l_int|0
)paren
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
r_else
id|current-&gt;state
op_assign
id|TASK_UNINTERRUPTIBLE
suffix:semicolon
multiline_comment|/* got a reply */
r_if
c_cond
(paren
id|req-&gt;rq_flags
op_amp
(paren
id|REQ_WRITE
op_or
id|REQ_DEAD
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|upc_comms
(braket
id|minor
)braket
dot
id|uc_hard
op_logical_and
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
multiline_comment|/* if this process really wants to die, let it go */
r_if
c_cond
(paren
id|sigismember
c_func
(paren
op_amp
(paren
id|current-&gt;pending.signal
)paren
comma
id|SIGKILL
)paren
op_logical_or
id|sigismember
c_func
(paren
op_amp
(paren
id|current-&gt;pending.signal
)paren
comma
id|SIGINT
)paren
)paren
r_break
suffix:semicolon
multiline_comment|/* signal is present: after timeout always return&n;                           really smart idea, probably useless ... */
r_if
c_cond
(paren
id|jiffies
OG
id|req-&gt;rq_posttime
op_plus
id|upc_comms
(braket
id|minor
)braket
dot
id|uc_timeout
op_star
id|HZ
)paren
r_break
suffix:semicolon
)brace
id|schedule
c_func
(paren
)paren
suffix:semicolon
)brace
id|list_del
c_func
(paren
op_amp
id|req-&gt;rq_chain
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|req-&gt;rq_chain
)paren
suffix:semicolon
id|remove_wait_queue
c_func
(paren
op_amp
id|req-&gt;rq_sleep
comma
op_amp
id|wait
)paren
suffix:semicolon
id|current-&gt;state
op_assign
id|TASK_RUNNING
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_SPECIAL
comma
l_string|&quot;posttime: %ld, returned: %ld&bslash;n&quot;
comma
id|posttime
comma
id|jiffies
op_minus
id|posttime
)paren
suffix:semicolon
r_return
(paren
id|jiffies
op_minus
id|posttime
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * lento_upcall will return an error in the case of&n; * failed communication with Lento _or_ will peek at Lento&n; * reply and return Lento&squot;s error.&n; *&n; * As lento has 2 types of errors, normal errors (positive) and internal&n; * errors (negative), normal errors are negated, while internal errors&n; * are all mapped to -EINTR, while showing a nice warning message. (jh)&n; *&n; * lento_upcall will always free buffer, either directly, when an upcall&n; * is read (in presto_psdev_read), when the filesystem is unmounted, or&n; * when the module is unloaded.&n; */
DECL|function|lento_upcall
r_int
id|lento_upcall
c_func
(paren
r_int
id|minor
comma
r_int
id|bufsize
comma
r_int
op_star
id|rep_size
comma
r_union
id|up_args
op_star
id|buffer
comma
r_int
id|async
comma
r_struct
id|upc_req
op_star
id|rq
)paren
(brace
r_int
r_int
id|runtime
suffix:semicolon
r_struct
id|upc_comm
op_star
id|upc_commp
suffix:semicolon
r_union
id|down_args
op_star
id|out
suffix:semicolon
r_struct
id|upc_req
op_star
id|req
suffix:semicolon
r_int
id|error
op_assign
l_int|0
suffix:semicolon
id|ENTRY
suffix:semicolon
id|upc_commp
op_assign
op_amp
(paren
id|upc_comms
(braket
id|minor
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|upc_commp-&gt;uc_no_upcall
)paren
(brace
id|EXIT
suffix:semicolon
r_goto
id|exit_buf
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|upc_commp-&gt;uc_pid
op_logical_and
op_logical_neg
id|async
)paren
(brace
id|EXIT
suffix:semicolon
id|error
op_assign
op_minus
id|ENXIO
suffix:semicolon
r_goto
id|exit_buf
suffix:semicolon
)brace
multiline_comment|/* Format the request message. */
id|CDEBUG
c_func
(paren
id|D_UPCALL
comma
l_string|&quot;buffer at %p, size %d&bslash;n&quot;
comma
id|buffer
comma
id|bufsize
)paren
suffix:semicolon
id|PRESTO_ALLOC
c_func
(paren
id|req
comma
r_struct
id|upc_req
op_star
comma
r_sizeof
(paren
r_struct
id|upc_req
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|req
)paren
(brace
id|EXIT
suffix:semicolon
id|error
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|exit_buf
suffix:semicolon
)brace
id|req-&gt;rq_data
op_assign
(paren
r_void
op_star
)paren
id|buffer
suffix:semicolon
id|req-&gt;rq_flags
op_assign
l_int|0
suffix:semicolon
id|req-&gt;rq_bufsize
op_assign
id|bufsize
suffix:semicolon
id|req-&gt;rq_rep_size
op_assign
l_int|0
suffix:semicolon
id|req-&gt;rq_opcode
op_assign
(paren
(paren
r_union
id|up_args
op_star
)paren
id|buffer
)paren
op_member_access_from_pointer
id|uh.opcode
suffix:semicolon
id|req-&gt;rq_unique
op_assign
op_increment
id|upc_commp-&gt;uc_seq
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|req-&gt;rq_sleep
)paren
suffix:semicolon
multiline_comment|/* Fill in the common input args. */
(paren
(paren
r_union
id|up_args
op_star
)paren
id|buffer
)paren
op_member_access_from_pointer
id|uh.unique
op_assign
id|req-&gt;rq_unique
suffix:semicolon
multiline_comment|/* Append msg to pending queue and poke Lento. */
id|list_add
c_func
(paren
op_amp
id|req-&gt;rq_chain
comma
id|upc_commp-&gt;uc_pending.prev
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_UPCALL
comma
l_string|&quot;Proc %d waking Lento %d for(opc,uniq) =(%d,%d) msg at %p.&bslash;n&quot;
comma
id|current-&gt;pid
comma
id|upc_commp-&gt;uc_pid
comma
id|req-&gt;rq_opcode
comma
id|req-&gt;rq_unique
comma
id|req
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|upc_commp-&gt;uc_waitq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|async
)paren
(brace
id|req-&gt;rq_flags
op_assign
id|REQ_ASYNC
suffix:semicolon
r_if
c_cond
(paren
id|rq
op_ne
l_int|NULL
)paren
(brace
op_star
id|rq
op_assign
op_star
id|req
suffix:semicolon
multiline_comment|/* struct copying */
)brace
multiline_comment|/* req, rq_data are freed in presto_psdev_read for async */
id|EXIT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* We can be interrupted while we wait for Lento to process&n;         * our request.  If the interrupt occurs before Lento has read&n;         * the request, we dequeue and return. If it occurs after the&n;         * read but before the reply, we dequeue, send a signal&n;         * message, and return. If it occurs after the reply we ignore&n;         * it. In no case do we want to restart the syscall.  If it&n;         * was interrupted by a lento shutdown (psdev_close), return&n;         * ENODEV.  */
multiline_comment|/* Go to sleep.  Wake up on signals only after the timeout. */
id|runtime
op_assign
id|lento_waitfor_upcall
c_func
(paren
id|req
comma
id|minor
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_TIMING
comma
l_string|&quot;opc: %d time: %ld uniq: %d size: %d&bslash;n&quot;
comma
id|req-&gt;rq_opcode
comma
id|jiffies
op_minus
id|req-&gt;rq_posttime
comma
id|req-&gt;rq_unique
comma
id|req-&gt;rq_rep_size
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_UPCALL
comma
l_string|&quot;..process %d woken up by Lento for req at 0x%p, data at %p&bslash;n&quot;
comma
id|current-&gt;pid
comma
id|req
comma
id|req-&gt;rq_data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|upc_commp-&gt;uc_pid
)paren
(brace
multiline_comment|/* i.e. Lento is still alive */
multiline_comment|/* Op went through, interrupt or not we go on */
r_if
c_cond
(paren
id|req-&gt;rq_flags
op_amp
id|REQ_WRITE
)paren
(brace
id|out
op_assign
(paren
r_union
id|down_args
op_star
)paren
id|req-&gt;rq_data
suffix:semicolon
multiline_comment|/* here we map positive Lento errors to kernel errors */
r_if
c_cond
(paren
id|out-&gt;dh.result
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Tell Peter: Lento returns negative error %d, for oc %d!&bslash;n&quot;
comma
id|out-&gt;dh.result
comma
id|out-&gt;dh.opcode
)paren
suffix:semicolon
id|out-&gt;dh.result
op_assign
id|EINVAL
suffix:semicolon
)brace
id|error
op_assign
op_minus
id|out-&gt;dh.result
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_UPCALL
comma
l_string|&quot;upcall: (u,o,r) (%d, %d, %d) out at %p&bslash;n&quot;
comma
id|out-&gt;dh.unique
comma
id|out-&gt;dh.opcode
comma
id|out-&gt;dh.result
comma
id|out
)paren
suffix:semicolon
op_star
id|rep_size
op_assign
id|req-&gt;rq_rep_size
suffix:semicolon
id|EXIT
suffix:semicolon
r_goto
id|exit_req
suffix:semicolon
)brace
multiline_comment|/* Interrupted before lento read it. */
r_if
c_cond
(paren
op_logical_neg
(paren
id|req-&gt;rq_flags
op_amp
id|REQ_READ
)paren
op_logical_and
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
id|CDEBUG
c_func
(paren
id|D_UPCALL
comma
l_string|&quot;Interrupt before read: (op,un)=(%d,%d), flags %x&bslash;n&quot;
comma
id|req-&gt;rq_opcode
comma
id|req-&gt;rq_unique
comma
id|req-&gt;rq_flags
)paren
suffix:semicolon
multiline_comment|/* perhaps the best way to convince the app to give up? */
id|error
op_assign
op_minus
id|EINTR
suffix:semicolon
id|EXIT
suffix:semicolon
r_goto
id|exit_req
suffix:semicolon
)brace
multiline_comment|/* interrupted after Lento did its read, send signal */
r_if
c_cond
(paren
(paren
id|req-&gt;rq_flags
op_amp
id|REQ_READ
)paren
op_logical_and
id|signal_pending
c_func
(paren
id|current
)paren
)paren
(brace
r_union
id|up_args
op_star
id|sigargs
suffix:semicolon
r_struct
id|upc_req
op_star
id|sigreq
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_UPCALL
comma
l_string|&quot;Sending for: op = %d.%d, flags = %x&bslash;n&quot;
comma
id|req-&gt;rq_opcode
comma
id|req-&gt;rq_unique
comma
id|req-&gt;rq_flags
)paren
suffix:semicolon
id|error
op_assign
op_minus
id|EINTR
suffix:semicolon
multiline_comment|/* req, rq_data are freed in presto_psdev_read for async */
id|PRESTO_ALLOC
c_func
(paren
id|sigreq
comma
r_struct
id|upc_req
op_star
comma
r_sizeof
(paren
r_struct
id|upc_req
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sigreq
)paren
(brace
id|error
op_assign
op_minus
id|ENOMEM
suffix:semicolon
id|EXIT
suffix:semicolon
r_goto
id|exit_req
suffix:semicolon
)brace
id|PRESTO_ALLOC
c_func
(paren
(paren
id|sigreq-&gt;rq_data
)paren
comma
r_char
op_star
comma
r_sizeof
(paren
r_struct
id|lento_up_hdr
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|sigreq-&gt;rq_data
)paren
)paren
(brace
id|PRESTO_FREE
c_func
(paren
id|sigreq
comma
r_sizeof
(paren
r_struct
id|upc_req
)paren
)paren
suffix:semicolon
id|error
op_assign
op_minus
id|ENOMEM
suffix:semicolon
id|EXIT
suffix:semicolon
r_goto
id|exit_req
suffix:semicolon
)brace
id|sigargs
op_assign
(paren
r_union
id|up_args
op_star
)paren
id|sigreq-&gt;rq_data
suffix:semicolon
id|sigargs-&gt;uh.opcode
op_assign
id|LENTO_SIGNAL
suffix:semicolon
id|sigargs-&gt;uh.unique
op_assign
id|req-&gt;rq_unique
suffix:semicolon
id|sigreq-&gt;rq_flags
op_assign
id|REQ_ASYNC
suffix:semicolon
id|sigreq-&gt;rq_opcode
op_assign
id|sigargs-&gt;uh.opcode
suffix:semicolon
id|sigreq-&gt;rq_unique
op_assign
id|sigargs-&gt;uh.unique
suffix:semicolon
id|sigreq-&gt;rq_bufsize
op_assign
r_sizeof
(paren
r_struct
id|lento_up_hdr
)paren
suffix:semicolon
id|sigreq-&gt;rq_rep_size
op_assign
l_int|0
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_UPCALL
comma
l_string|&quot;presto_upcall: enqueing signal msg (%d, %d)&bslash;n&quot;
comma
id|sigreq-&gt;rq_opcode
comma
id|sigreq-&gt;rq_unique
)paren
suffix:semicolon
multiline_comment|/* insert at head of queue! */
id|list_add
c_func
(paren
op_amp
id|sigreq-&gt;rq_chain
comma
op_amp
id|upc_commp-&gt;uc_pending
)paren
suffix:semicolon
id|wake_up_interruptible
c_func
(paren
op_amp
id|upc_commp-&gt;uc_waitq
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;Lento: Strange interruption - tell Peter.&bslash;n&quot;
)paren
suffix:semicolon
id|error
op_assign
op_minus
id|EINTR
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* If lento died i.e. !UC_OPEN(upc_commp) */
id|printk
c_func
(paren
l_string|&quot;presto_upcall: Lento dead on (op,un) (%d.%d) flags %d&bslash;n&quot;
comma
id|req-&gt;rq_opcode
comma
id|req-&gt;rq_unique
comma
id|req-&gt;rq_flags
)paren
suffix:semicolon
id|error
op_assign
op_minus
id|ENODEV
suffix:semicolon
)brace
id|exit_req
suffix:colon
id|PRESTO_FREE
c_func
(paren
id|req
comma
r_sizeof
(paren
r_struct
id|upc_req
)paren
)paren
suffix:semicolon
id|exit_buf
suffix:colon
id|PRESTO_FREE
c_func
(paren
id|buffer
comma
id|bufsize
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
eof
