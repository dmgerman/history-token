multiline_comment|/* &n; * Extended attribute handling for presto.&n; *&n; * Copyright (C) 2001. All rights reserved.&n; * Shirish H. Phatak&n; * Tacit Networks, Inc.&n; *&n; */
DECL|macro|__NO_VERSION__
mdefine_line|#define __NO_VERSION__
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/locks.h&gt;
macro_line|#include &lt;linux/unistd.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/locks.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/vmalloc.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/intermezzo_fs.h&gt;
macro_line|#include &lt;linux/intermezzo_upcall.h&gt;
macro_line|#include &lt;linux/intermezzo_psdev.h&gt;
macro_line|#include &lt;linux/intermezzo_kml.h&gt;
macro_line|#ifdef CONFIG_FS_EXT_ATTR
macro_line|#include &lt;linux/ext_attr.h&gt;
r_extern
r_inline
r_void
id|presto_debug_fail_blkdev
c_func
(paren
r_struct
id|presto_file_set
op_star
id|fset
comma
r_int
r_int
id|value
)paren
suffix:semicolon
r_extern
r_int
id|presto_prep
c_func
(paren
r_struct
id|dentry
op_star
comma
r_struct
id|presto_cache
op_star
op_star
comma
r_struct
id|presto_file_set
op_star
op_star
)paren
suffix:semicolon
multiline_comment|/* VFS interface */
multiline_comment|/* XXX! Fixme test for user defined attributes */
DECL|function|presto_set_ext_attr
r_int
id|presto_set_ext_attr
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_const
r_char
op_star
id|name
comma
r_void
op_star
id|buffer
comma
r_int
id|buffer_len
comma
r_int
id|flags
)paren
(brace
r_int
id|error
suffix:semicolon
r_struct
id|presto_cache
op_star
id|cache
suffix:semicolon
r_struct
id|presto_file_set
op_star
id|fset
suffix:semicolon
r_struct
id|lento_vfs_context
id|info
suffix:semicolon
r_struct
id|dentry
op_star
id|dentry
suffix:semicolon
r_int
id|minor
op_assign
id|presto_i2m
c_func
(paren
id|inode
)paren
suffix:semicolon
r_char
op_star
id|buf
op_assign
l_int|NULL
suffix:semicolon
id|ENTRY
suffix:semicolon
r_if
c_cond
(paren
id|minor
OL
l_int|0
)paren
(brace
id|EXIT
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ISLENTO
c_func
(paren
id|minor
)paren
)paren
(brace
id|EXIT
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* BAD...vfs should really pass down the dentry to use, especially&n;         * since every other operation in iops does. But for now&n;         * we do a reverse mapping from inode to the first dentry &n;         */
r_if
c_cond
(paren
id|list_empty
c_func
(paren
op_amp
id|inode-&gt;i_dentry
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;No alias for inode %d&bslash;n&quot;
comma
(paren
r_int
)paren
id|inode-&gt;i_ino
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|dentry
op_assign
id|list_entry
c_func
(paren
id|inode-&gt;i_dentry.next
comma
r_struct
id|dentry
comma
id|d_alias
)paren
suffix:semicolon
id|error
op_assign
id|presto_prep
c_func
(paren
id|dentry
comma
op_amp
id|cache
comma
op_amp
id|fset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|buffer
op_ne
l_int|NULL
)paren
op_logical_and
(paren
id|buffer_len
op_ne
l_int|0
)paren
)paren
(brace
multiline_comment|/* If buffer is a user space pointer copy it to kernel space&n;            * and reset the flag. We do this since the journal functions need&n;            * access to the contents of the buffer, and the file system&n;            * does not care. When we actually invoke the function, we remove&n;            * the EXT_ATTR_FLAG_USER flag.&n;            *&n;            * XXX:Check if the &quot;fs does not care&quot; assertion is always true -SHP&n;            * (works for ext3)&n;            */
r_if
c_cond
(paren
id|flags
op_amp
id|EXT_ATTR_FLAG_USER
)paren
(brace
id|PRESTO_ALLOC
c_func
(paren
id|buf
comma
r_char
op_star
comma
id|buffer_len
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|buf
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;InterMezzo: out of memory!!!&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|buf
comma
id|buffer
comma
id|buffer_len
)paren
)paren
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
r_else
id|buf
op_assign
id|buffer
suffix:semicolon
)brace
r_else
id|buf
op_assign
id|buffer
suffix:semicolon
r_if
c_cond
(paren
id|presto_get_permit
c_func
(paren
id|inode
)paren
OL
l_int|0
)paren
(brace
id|EXIT
suffix:semicolon
r_if
c_cond
(paren
id|buffer_len
op_logical_and
(paren
id|flags
op_amp
id|EXT_ATTR_FLAG_USER
)paren
)paren
id|PRESTO_FREE
c_func
(paren
id|buf
comma
id|buffer_len
)paren
suffix:semicolon
r_return
op_minus
id|EROFS
suffix:semicolon
)brace
multiline_comment|/* Simulate presto_setup_info */
id|memset
c_func
(paren
op_amp
id|info
comma
l_int|0
comma
r_sizeof
(paren
id|info
)paren
)paren
suffix:semicolon
multiline_comment|/* For now redundant..but we keep it around just in case */
id|info.flags
op_assign
id|LENTO_FL_IGNORE_TIME
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ISLENTO
c_func
(paren
id|cache-&gt;cache_psdev-&gt;uc_minor
)paren
)paren
id|info.flags
op_or_assign
id|LENTO_FL_KML
suffix:semicolon
multiline_comment|/* We pass in the kernel space pointer and reset the &n;         * EXT_ATTR_FLAG_USER flag.&n;         * See comments above. &n;         */
multiline_comment|/* Note that mode is already set by VFS so we send in a NULL */
id|error
op_assign
id|presto_do_set_ext_attr
c_func
(paren
id|fset
comma
id|dentry
comma
id|name
comma
id|buf
comma
id|buffer_len
comma
id|flags
op_amp
op_complement
id|EXT_ATTR_FLAG_USER
comma
l_int|NULL
comma
op_amp
id|info
)paren
suffix:semicolon
id|presto_put_permit
c_func
(paren
id|inode
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buffer_len
op_logical_and
(paren
id|flags
op_amp
id|EXT_ATTR_FLAG_USER
)paren
)paren
id|PRESTO_FREE
c_func
(paren
id|buf
comma
id|buffer_len
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
multiline_comment|/* Lento Interface */
multiline_comment|/* XXX: ignore flags? We should be forcing these operations through? -SHP*/
DECL|function|lento_set_ext_attr
r_int
id|lento_set_ext_attr
c_func
(paren
r_const
r_char
op_star
id|path
comma
r_const
r_char
op_star
id|name
comma
r_void
op_star
id|buffer
comma
r_int
id|buffer_len
comma
r_int
id|flags
comma
id|mode_t
id|mode
comma
r_struct
id|lento_vfs_context
op_star
id|info
)paren
(brace
r_int
id|error
suffix:semicolon
r_char
op_star
id|pathname
suffix:semicolon
r_struct
id|nameidata
id|nd
suffix:semicolon
r_struct
id|dentry
op_star
id|dentry
suffix:semicolon
r_struct
id|presto_file_set
op_star
id|fset
suffix:semicolon
id|ENTRY
suffix:semicolon
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
id|pathname
op_assign
id|getname
c_func
(paren
id|path
)paren
suffix:semicolon
id|error
op_assign
id|PTR_ERR
c_func
(paren
id|pathname
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|pathname
)paren
)paren
(brace
id|EXIT
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
multiline_comment|/* Note that ext_attrs apply to both files and directories..*/
id|error
op_assign
id|presto_walk
c_func
(paren
id|pathname
comma
op_amp
id|nd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_goto
m_exit
suffix:semicolon
id|dentry
op_assign
id|nd.dentry
suffix:semicolon
id|fset
op_assign
id|presto_fset
c_func
(paren
id|dentry
)paren
suffix:semicolon
id|error
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fset
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;No fileset!&bslash;n&quot;
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_goto
id|exit_dentry
suffix:semicolon
)brace
r_if
c_cond
(paren
id|buffer
op_eq
l_int|NULL
)paren
id|buffer_len
op_assign
l_int|0
suffix:semicolon
id|error
op_assign
id|presto_do_set_ext_attr
c_func
(paren
id|fset
comma
id|dentry
comma
id|name
comma
id|buffer
comma
id|buffer_len
comma
id|flags
comma
op_amp
id|mode
comma
id|info
)paren
suffix:semicolon
id|exit_dentry
suffix:colon
id|path_release
c_func
(paren
op_amp
id|nd
)paren
suffix:semicolon
id|exit_path
suffix:colon
id|putname
c_func
(paren
id|pathname
)paren
suffix:semicolon
m_exit
suffix:colon
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
macro_line|#endif /*CONFIG_FS_EXT_ATTR*/
eof
