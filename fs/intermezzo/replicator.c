multiline_comment|/* -*- mode: c; c-basic-offset: 8; indent-tabs-mode: nil; -*-&n; * vim:expandtab:shiftwidth=8:tabstop=8:&n; *&n; * Copyright (C) 2001 Cluster File Systems, Inc. &lt;braam@clusterfs.com&gt;&n; * Copyright (C) 2001 Tacit Networks, Inc. &lt;phil@off.net&gt;&n; *&n; *   This file is part of InterMezzo, http://www.inter-mezzo.org.&n; *&n; *   InterMezzo is free software; you can redistribute it and/or&n; *   modify it under the terms of version 2 of the GNU General Public&n; *   License as published by the Free Software Foundation.&n; *&n; *   InterMezzo is distributed in the hope that it will be useful,&n; *   but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *   GNU General Public License for more details.&n; *&n; *   You should have received a copy of the GNU General Public License&n; *   along with InterMezzo; if not, write to the Free Software&n; *   Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; * Manage RCVD records for clients in the kernel&n; *&n; */
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/fsfilter.h&gt;
macro_line|#include &quot;intermezzo_fs.h&quot;
multiline_comment|/*&n; * this file contains a hash table of replicators/clients for a&n; * fileset. It allows fast lookup and update of reintegration status&n; */
DECL|struct|izo_offset_rec
r_struct
id|izo_offset_rec
(brace
DECL|member|or_list
r_struct
id|list_head
id|or_list
suffix:semicolon
DECL|member|or_uuid
r_char
id|or_uuid
(braket
l_int|16
)braket
suffix:semicolon
DECL|member|or_offset
id|loff_t
id|or_offset
suffix:semicolon
)brace
suffix:semicolon
DECL|macro|RCACHE_BITS
mdefine_line|#define RCACHE_BITS 8
DECL|macro|RCACHE_SIZE
mdefine_line|#define RCACHE_SIZE (1 &lt;&lt; RCACHE_BITS)
DECL|macro|RCACHE_MASK
mdefine_line|#define RCACHE_MASK (RCACHE_SIZE - 1)
r_static
r_struct
id|list_head
op_star
DECL|function|izo_rep_cache
id|izo_rep_cache
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|list_head
op_star
id|cache
suffix:semicolon
id|PRESTO_ALLOC
c_func
(paren
id|cache
comma
r_sizeof
(paren
r_struct
id|list_head
)paren
op_star
id|RCACHE_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cache
op_eq
l_int|NULL
)paren
(brace
id|CERROR
c_func
(paren
l_string|&quot;intermezzo-fatal: no memory for replicator cache&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|memset
c_func
(paren
id|cache
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|list_head
)paren
op_star
id|RCACHE_SIZE
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RCACHE_SIZE
suffix:semicolon
id|i
op_increment
)paren
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|cache
(braket
id|i
)braket
)paren
suffix:semicolon
r_return
id|cache
suffix:semicolon
)brace
r_static
r_struct
id|list_head
op_star
DECL|function|izo_rep_hash
id|izo_rep_hash
c_func
(paren
r_struct
id|list_head
op_star
id|cache
comma
r_char
op_star
id|uuid
)paren
(brace
r_return
op_amp
id|cache
(braket
(paren
id|RCACHE_MASK
op_amp
id|uuid
(braket
l_int|1
)braket
)paren
)braket
suffix:semicolon
)brace
r_static
r_void
DECL|function|izo_rep_cache_clean
id|izo_rep_cache_clean
c_func
(paren
r_struct
id|presto_file_set
op_star
id|fset
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|list_head
op_star
id|bucket
suffix:semicolon
r_struct
id|list_head
op_star
id|tmp
suffix:semicolon
r_if
c_cond
(paren
id|fset-&gt;fset_clients
op_eq
l_int|NULL
)paren
r_return
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|RCACHE_SIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
id|tmp
op_assign
id|bucket
op_assign
op_amp
id|fset-&gt;fset_clients
(braket
id|i
)braket
suffix:semicolon
id|tmp
op_assign
id|tmp-&gt;next
suffix:semicolon
r_while
c_loop
(paren
id|tmp
op_ne
id|bucket
)paren
(brace
r_struct
id|izo_offset_rec
op_star
id|offrec
suffix:semicolon
id|tmp
op_assign
id|tmp-&gt;next
suffix:semicolon
id|list_del
c_func
(paren
id|tmp
)paren
suffix:semicolon
id|offrec
op_assign
id|list_entry
c_func
(paren
id|tmp
comma
r_struct
id|izo_offset_rec
comma
id|or_list
)paren
suffix:semicolon
id|PRESTO_FREE
c_func
(paren
id|offrec
comma
r_sizeof
(paren
r_struct
id|izo_offset_rec
)paren
)paren
suffix:semicolon
)brace
)brace
)brace
r_struct
id|izo_offset_rec
op_star
DECL|function|izo_rep_cache_find
id|izo_rep_cache_find
c_func
(paren
r_struct
id|presto_file_set
op_star
id|fset
comma
r_char
op_star
id|uuid
)paren
(brace
r_struct
id|list_head
op_star
id|buck
op_assign
id|izo_rep_hash
c_func
(paren
id|fset-&gt;fset_clients
comma
id|uuid
)paren
suffix:semicolon
r_struct
id|list_head
op_star
id|tmp
op_assign
id|buck
suffix:semicolon
r_struct
id|izo_offset_rec
op_star
id|rec
op_assign
l_int|NULL
suffix:semicolon
r_while
c_loop
(paren
(paren
id|tmp
op_assign
id|tmp-&gt;next
)paren
op_ne
id|buck
)paren
(brace
id|rec
op_assign
id|list_entry
c_func
(paren
id|tmp
comma
r_struct
id|izo_offset_rec
comma
id|or_list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|memcmp
c_func
(paren
id|rec-&gt;or_uuid
comma
id|uuid
comma
r_sizeof
(paren
id|rec-&gt;or_uuid
)paren
)paren
op_eq
l_int|0
)paren
r_return
id|rec
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
r_static
r_int
DECL|function|izo_rep_cache_add
id|izo_rep_cache_add
c_func
(paren
r_struct
id|presto_file_set
op_star
id|fset
comma
r_struct
id|izo_rcvd_rec
op_star
id|rec
comma
id|loff_t
id|offset
)paren
(brace
r_struct
id|izo_offset_rec
op_star
id|offrec
suffix:semicolon
r_if
c_cond
(paren
id|izo_rep_cache_find
c_func
(paren
id|fset
comma
id|rec-&gt;lr_uuid
)paren
)paren
(brace
id|CERROR
c_func
(paren
l_string|&quot;izo: duplicate client entry %s off %Ld&bslash;n&quot;
comma
id|fset-&gt;fset_name
comma
id|offset
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|PRESTO_ALLOC
c_func
(paren
id|offrec
comma
r_sizeof
(paren
op_star
id|offrec
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|offrec
op_eq
l_int|NULL
)paren
(brace
id|CERROR
c_func
(paren
l_string|&quot;izo: cannot allocate offrec&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|offrec-&gt;or_uuid
comma
id|rec-&gt;lr_uuid
comma
r_sizeof
(paren
id|rec-&gt;lr_uuid
)paren
)paren
suffix:semicolon
id|offrec-&gt;or_offset
op_assign
id|offset
suffix:semicolon
id|list_add
c_func
(paren
op_amp
id|offrec-&gt;or_list
comma
id|izo_rep_hash
c_func
(paren
id|fset-&gt;fset_clients
comma
id|rec-&gt;lr_uuid
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|izo_rep_cache_init
id|izo_rep_cache_init
c_func
(paren
r_struct
id|presto_file_set
op_star
id|fset
)paren
(brace
r_struct
id|izo_rcvd_rec
id|rec
suffix:semicolon
id|loff_t
id|offset
op_assign
l_int|0
comma
id|last_offset
op_assign
l_int|0
suffix:semicolon
id|fset-&gt;fset_clients
op_assign
id|izo_rep_cache
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fset-&gt;fset_clients
op_eq
l_int|NULL
)paren
(brace
id|CERROR
c_func
(paren
l_string|&quot;Error initializing client cache&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_while
c_loop
(paren
id|presto_fread
c_func
(paren
id|fset-&gt;fset_rcvd.fd_file
comma
(paren
r_char
op_star
)paren
op_amp
id|rec
comma
r_sizeof
(paren
id|rec
)paren
comma
op_amp
id|offset
)paren
op_eq
r_sizeof
(paren
id|rec
)paren
)paren
(brace
r_int
id|rc
suffix:semicolon
r_if
c_cond
(paren
(paren
id|rc
op_assign
id|izo_rep_cache_add
c_func
(paren
id|fset
comma
op_amp
id|rec
comma
id|last_offset
)paren
)paren
OL
l_int|0
)paren
(brace
id|izo_rep_cache_clean
c_func
(paren
id|fset
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|last_offset
op_assign
id|offset
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Return local last_rcvd record for the client. Update or create &n; * if necessary.&n; *&n; * XXX: After this call, any -EINVAL from izo_rcvd_get is a real error.&n; */
r_int
DECL|function|izo_repstatus
id|izo_repstatus
c_func
(paren
r_struct
id|presto_file_set
op_star
id|fset
comma
id|__u64
id|client_kmlsize
comma
r_struct
id|izo_rcvd_rec
op_star
id|lr_client
comma
r_struct
id|izo_rcvd_rec
op_star
id|lr_server
)paren
(brace
r_int
id|rc
suffix:semicolon
id|rc
op_assign
id|izo_rcvd_get
c_func
(paren
id|lr_server
comma
id|fset
comma
id|lr_client-&gt;lr_uuid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
op_logical_and
id|rc
op_ne
op_minus
id|EINVAL
)paren
(brace
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/* client is new or has been reset. */
r_if
c_cond
(paren
id|rc
OL
l_int|0
op_logical_or
(paren
id|client_kmlsize
op_eq
l_int|0
op_logical_and
id|lr_client-&gt;lr_remote_offset
op_eq
l_int|0
)paren
)paren
(brace
id|memset
c_func
(paren
id|lr_server
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|lr_server
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|lr_server-&gt;lr_uuid
comma
id|lr_client-&gt;lr_uuid
comma
r_sizeof
(paren
id|lr_server-&gt;lr_uuid
)paren
)paren
suffix:semicolon
id|rc
op_assign
id|izo_rcvd_write
c_func
(paren
id|fset
comma
id|lr_server
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/* update intersync */
id|rc
op_assign
id|izo_upc_repstatus
c_func
(paren
id|presto_f2m
c_func
(paren
id|fset
)paren
comma
id|fset-&gt;fset_name
comma
id|lr_server
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|loff_t
DECL|function|izo_rcvd_get
id|izo_rcvd_get
c_func
(paren
r_struct
id|izo_rcvd_rec
op_star
id|rec
comma
r_struct
id|presto_file_set
op_star
id|fset
comma
r_char
op_star
id|uuid
)paren
(brace
r_struct
id|izo_offset_rec
op_star
id|offrec
suffix:semicolon
r_struct
id|izo_rcvd_rec
id|tmprec
suffix:semicolon
id|loff_t
id|offset
suffix:semicolon
id|offrec
op_assign
id|izo_rep_cache_find
c_func
(paren
id|fset
comma
id|uuid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|offrec
op_eq
l_int|NULL
)paren
(brace
id|CDEBUG
c_func
(paren
id|D_SPECIAL
comma
l_string|&quot;izo_get_rcvd: uuid not in hash.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|offset
op_assign
id|offrec-&gt;or_offset
suffix:semicolon
r_if
c_cond
(paren
id|rec
op_eq
l_int|NULL
)paren
r_return
id|offset
suffix:semicolon
r_if
c_cond
(paren
id|presto_fread
c_func
(paren
id|fset-&gt;fset_rcvd.fd_file
comma
(paren
r_char
op_star
)paren
op_amp
id|tmprec
comma
r_sizeof
(paren
id|tmprec
)paren
comma
op_amp
id|offset
)paren
op_ne
r_sizeof
(paren
id|tmprec
)paren
)paren
(brace
id|CERROR
c_func
(paren
l_string|&quot;izo_get_rcvd: Unable to read from last_rcvd file offset &quot;
l_string|&quot;%Lu&bslash;n&quot;
comma
id|offset
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|rec-&gt;lr_uuid
comma
id|tmprec.lr_uuid
comma
r_sizeof
(paren
id|tmprec.lr_uuid
)paren
)paren
suffix:semicolon
id|rec-&gt;lr_remote_recno
op_assign
id|le64_to_cpu
c_func
(paren
id|tmprec.lr_remote_recno
)paren
suffix:semicolon
id|rec-&gt;lr_remote_offset
op_assign
id|le64_to_cpu
c_func
(paren
id|tmprec.lr_remote_offset
)paren
suffix:semicolon
id|rec-&gt;lr_local_recno
op_assign
id|le64_to_cpu
c_func
(paren
id|tmprec.lr_local_recno
)paren
suffix:semicolon
id|rec-&gt;lr_local_offset
op_assign
id|le64_to_cpu
c_func
(paren
id|tmprec.lr_local_offset
)paren
suffix:semicolon
id|rec-&gt;lr_last_ctime
op_assign
id|le64_to_cpu
c_func
(paren
id|tmprec.lr_last_ctime
)paren
suffix:semicolon
r_return
id|offrec-&gt;or_offset
suffix:semicolon
)brace
multiline_comment|/* Try to lookup the UUID in the hash.  Insert it if it isn&squot;t found.  Write the&n; * data to the file.&n; *&n; * Returns the offset of the beginning of the record in the last_rcvd file. */
id|loff_t
DECL|function|izo_rcvd_write
id|izo_rcvd_write
c_func
(paren
r_struct
id|presto_file_set
op_star
id|fset
comma
r_struct
id|izo_rcvd_rec
op_star
id|rec
)paren
(brace
r_struct
id|izo_offset_rec
op_star
id|offrec
suffix:semicolon
id|loff_t
id|offset
comma
id|rc
suffix:semicolon
id|ENTRY
suffix:semicolon
id|offrec
op_assign
id|izo_rep_cache_find
c_func
(paren
id|fset
comma
id|rec-&gt;lr_uuid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|offrec
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* I don&squot;t think it should be possible for an entry to be not in&n;                 * the hash table without also having an invalid offset, but we&n;                 * handle it gracefully regardless. */
id|write_lock
c_func
(paren
op_amp
id|fset-&gt;fset_rcvd.fd_lock
)paren
suffix:semicolon
id|offset
op_assign
id|fset-&gt;fset_rcvd.fd_offset
suffix:semicolon
id|fset-&gt;fset_rcvd.fd_offset
op_add_assign
r_sizeof
(paren
op_star
id|rec
)paren
suffix:semicolon
id|write_unlock
c_func
(paren
op_amp
id|fset-&gt;fset_rcvd.fd_lock
)paren
suffix:semicolon
id|rc
op_assign
id|izo_rep_cache_add
c_func
(paren
id|fset
comma
id|rec
comma
id|offset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
)brace
r_else
id|offset
op_assign
id|offrec-&gt;or_offset
suffix:semicolon
id|rc
op_assign
id|presto_fwrite
c_func
(paren
id|fset-&gt;fset_rcvd.fd_file
comma
(paren
r_char
op_star
)paren
id|rec
comma
r_sizeof
(paren
op_star
id|rec
)paren
comma
op_amp
id|offset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
r_sizeof
(paren
op_star
id|rec
)paren
)paren
multiline_comment|/* presto_fwrite() advances &squot;offset&squot; */
id|rc
op_assign
id|offset
op_minus
r_sizeof
(paren
op_star
id|rec
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|loff_t
DECL|function|izo_rcvd_upd_remote
id|izo_rcvd_upd_remote
c_func
(paren
r_struct
id|presto_file_set
op_star
id|fset
comma
r_char
op_star
id|uuid
comma
id|__u64
id|remote_recno
comma
id|__u64
id|remote_offset
)paren
(brace
r_struct
id|izo_rcvd_rec
id|rec
suffix:semicolon
id|loff_t
id|rc
suffix:semicolon
id|ENTRY
suffix:semicolon
id|rc
op_assign
id|izo_rcvd_get
c_func
(paren
op_amp
id|rec
comma
id|fset
comma
id|uuid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_return
id|rc
suffix:semicolon
id|rec.lr_remote_recno
op_assign
id|remote_recno
suffix:semicolon
id|rec.lr_remote_offset
op_assign
id|remote_offset
suffix:semicolon
id|rc
op_assign
id|izo_rcvd_write
c_func
(paren
id|fset
comma
op_amp
id|rec
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
r_return
id|rc
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
eof
