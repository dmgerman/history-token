multiline_comment|/*&n; *&n; *&n; *  Copyright (C) 2000 Stelias Computing, Inc.&n; *  Copyright (C) 2000 Red Hat, Inc.&n; *  Copyright (C) 2000 Tacitus Systems&n; *  Copyright (C) 2000 Peter J. Braam&n; *&n; */
macro_line|#include &lt;stdarg.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/ext2_fs.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/vmalloc.h&gt;
macro_line|#include &lt;linux/time.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/locks.h&gt;
macro_line|#include &lt;linux/blkdev.h&gt;
macro_line|#include &lt;linux/init.h&gt;
DECL|macro|__NO_VERSION__
mdefine_line|#define __NO_VERSION__
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/intermezzo_fs.h&gt;
macro_line|#include &lt;linux/intermezzo_upcall.h&gt;
macro_line|#include &lt;linux/intermezzo_psdev.h&gt;
DECL|function|presto_relock_sem
r_static
r_inline
r_void
id|presto_relock_sem
c_func
(paren
r_struct
id|inode
op_star
id|dir
)paren
(brace
multiline_comment|/* the lock from sys_mkdir / lookup_create */
id|down
c_func
(paren
op_amp
id|dir-&gt;i_sem
)paren
suffix:semicolon
multiline_comment|/* the rest is done by the do_{create,mkdir, ...} */
)brace
DECL|function|presto_relock_other
r_static
r_inline
r_void
id|presto_relock_other
c_func
(paren
r_struct
id|inode
op_star
id|dir
)paren
(brace
multiline_comment|/* vfs_mkdir locks */
id|down
c_func
(paren
op_amp
id|dir-&gt;i_zombie
)paren
suffix:semicolon
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|presto_fulllock
r_static
r_inline
r_void
id|presto_fulllock
c_func
(paren
r_struct
id|inode
op_star
id|dir
)paren
(brace
multiline_comment|/* the lock from sys_mkdir / lookup_create */
id|down
c_func
(paren
op_amp
id|dir-&gt;i_sem
)paren
suffix:semicolon
multiline_comment|/* vfs_mkdir locks */
id|down
c_func
(paren
op_amp
id|dir-&gt;i_zombie
)paren
suffix:semicolon
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|presto_unlock
r_static
r_inline
r_void
id|presto_unlock
c_func
(paren
r_struct
id|inode
op_star
id|dir
)paren
(brace
multiline_comment|/* vfs_mkdir locks */
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|dir-&gt;i_zombie
)paren
suffix:semicolon
multiline_comment|/* the lock from sys_mkdir / lookup_create */
id|up
c_func
(paren
op_amp
id|dir-&gt;i_sem
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * these are initialized in super.c&n; */
r_extern
r_int
id|presto_permission
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_int
id|mask
)paren
suffix:semicolon
DECL|variable|presto_ilookup_uid
r_int
id|presto_ilookup_uid
op_assign
l_int|0
suffix:semicolon
r_extern
r_int
id|presto_prep
c_func
(paren
r_struct
id|dentry
op_star
comma
r_struct
id|presto_cache
op_star
op_star
comma
r_struct
id|presto_file_set
op_star
op_star
)paren
suffix:semicolon
DECL|function|dentry2id
r_static
r_int
id|dentry2id
c_func
(paren
r_struct
id|dentry
op_star
id|dentry
comma
id|ino_t
op_star
id|id
comma
r_int
r_int
op_star
id|generation
)paren
(brace
r_char
op_star
id|tmpname
suffix:semicolon
r_char
op_star
id|next
suffix:semicolon
r_int
id|error
op_assign
l_int|0
suffix:semicolon
id|ENTRY
suffix:semicolon
r_if
c_cond
(paren
id|dentry-&gt;d_name.len
OG
id|EXT2_NAME_LEN
)paren
(brace
id|EXIT
suffix:semicolon
r_return
op_minus
id|ENAMETOOLONG
suffix:semicolon
)brace
multiline_comment|/* prefix is 7 characters: &squot;...ino:&squot; */
r_if
c_cond
(paren
id|dentry-&gt;d_name.len
OL
l_int|7
op_logical_or
id|memcmp
c_func
(paren
id|dentry-&gt;d_name.name
comma
id|PRESTO_ILOOKUP_MAGIC
comma
l_int|7
)paren
op_ne
l_int|0
)paren
(brace
id|EXIT
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|PRESTO_ALLOC
c_func
(paren
id|tmpname
comma
r_char
op_star
comma
id|dentry-&gt;d_name.len
op_minus
l_int|7
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tmpname
)paren
(brace
id|EXIT
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|tmpname
comma
id|dentry-&gt;d_name.name
op_plus
l_int|7
comma
id|dentry-&gt;d_name.len
op_minus
l_int|7
)paren
suffix:semicolon
op_star
(paren
id|tmpname
op_plus
id|dentry-&gt;d_name.len
)paren
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
multiline_comment|/* name is of the form &lt;inode number&gt;:&lt;generation&gt; */
op_star
id|id
op_assign
id|simple_strtoul
c_func
(paren
id|tmpname
comma
op_amp
id|next
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|next
op_eq
id|PRESTO_ILOOKUP_SEP
)paren
(brace
op_star
id|generation
op_assign
id|simple_strtoul
c_func
(paren
id|next
op_plus
l_int|1
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_INODE
comma
l_string|&quot;INO to find = %s&bslash;n&quot;
comma
id|tmpname
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_INODE
comma
l_string|&quot;Id = %lx (%lu), generation %x (%d)&bslash;n&quot;
comma
op_star
id|id
comma
op_star
id|id
comma
op_star
id|generation
comma
op_star
id|generation
)paren
suffix:semicolon
)brace
r_else
id|error
op_assign
l_int|1
suffix:semicolon
id|PRESTO_FREE
c_func
(paren
id|tmpname
comma
id|dentry-&gt;d_name.len
op_minus
l_int|7
op_plus
l_int|1
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|function|presto_opendir_upcall
r_static
r_int
id|presto_opendir_upcall
c_func
(paren
r_int
id|minor
comma
r_struct
id|dentry
op_star
id|de
comma
r_struct
id|dentry
op_star
id|root
comma
r_int
id|async
)paren
(brace
r_int
id|rc
suffix:semicolon
r_char
op_star
id|path
comma
op_star
id|buffer
suffix:semicolon
r_int
id|pathlen
suffix:semicolon
id|PRESTO_ALLOC
c_func
(paren
id|buffer
comma
r_char
op_star
comma
id|PAGE_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|buffer
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;PRESTO: out of memory!&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|ENOMEM
suffix:semicolon
)brace
id|path
op_assign
id|presto_path
c_func
(paren
id|de
comma
id|root
comma
id|buffer
comma
id|PAGE_SIZE
)paren
suffix:semicolon
id|pathlen
op_assign
id|MYPATHLEN
c_func
(paren
id|buffer
comma
id|path
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_INODE
comma
l_string|&quot;path: %*s, len %d&bslash;n&quot;
comma
id|pathlen
comma
id|path
comma
id|pathlen
)paren
suffix:semicolon
id|rc
op_assign
id|lento_opendir
c_func
(paren
id|minor
comma
id|pathlen
comma
id|path
comma
id|async
)paren
suffix:semicolon
id|PRESTO_FREE
c_func
(paren
id|buffer
comma
id|PAGE_SIZE
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|presto_can_ilookup
r_inline
r_int
id|presto_can_ilookup
c_func
(paren
r_void
)paren
(brace
r_return
(paren
id|current-&gt;euid
op_eq
id|presto_ilookup_uid
op_logical_or
id|capable
c_func
(paren
id|CAP_DAC_READ_SEARCH
)paren
)paren
suffix:semicolon
)brace
DECL|function|presto_ilookup
r_struct
id|dentry
op_star
id|presto_ilookup
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|dentry
op_star
id|dentry
comma
id|ino_t
id|ino
comma
r_int
r_int
id|generation
)paren
(brace
r_struct
id|inode
op_star
id|inode
suffix:semicolon
r_int
id|error
suffix:semicolon
id|ENTRY
suffix:semicolon
multiline_comment|/* if we can&squot;t ilookup, forbid anything with this name to&n;         * avoid any security issues/name clashes.&n;         */
r_if
c_cond
(paren
op_logical_neg
id|presto_can_ilookup
c_func
(paren
)paren
)paren
(brace
id|CDEBUG
c_func
(paren
id|D_CACHE
comma
l_string|&quot;ilookup denied: euid %u, ilookup_uid %u&bslash;n&quot;
comma
id|current-&gt;euid
comma
id|presto_ilookup_uid
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|ERR_PTR
c_func
(paren
op_minus
id|EPERM
)paren
suffix:semicolon
)brace
id|inode
op_assign
id|iget
c_func
(paren
id|dir-&gt;i_sb
comma
id|ino
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|inode
op_logical_or
id|is_bad_inode
c_func
(paren
id|inode
)paren
)paren
(brace
id|CDEBUG
c_func
(paren
id|D_PIOCTL
comma
l_string|&quot;fatal: invalid inode %ld (%s).&bslash;n&quot;
comma
id|ino
comma
id|inode
ques
c_cond
id|inode-&gt;i_nlink
ques
c_cond
l_string|&quot;bad inode&quot;
suffix:colon
l_string|&quot;no links&quot;
suffix:colon
l_string|&quot;NULL&quot;
)paren
suffix:semicolon
id|error
op_assign
op_minus
id|ENOENT
suffix:semicolon
id|EXIT
suffix:semicolon
r_goto
id|cleanup_iput
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|inode-&gt;i_nlink
op_eq
l_int|0
)paren
(brace
multiline_comment|/* This is quite evil, but we have little choice.  If we were&n;                 * to iput() again with i_nlink == 0, delete_inode would get&n;                 * called again, which ext3 really Does Not Like. */
id|atomic_dec
c_func
(paren
op_amp
id|inode-&gt;i_count
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|ERR_PTR
c_func
(paren
op_minus
id|ENOENT
)paren
suffix:semicolon
)brace
multiline_comment|/* We need to make sure we have the right inode (by checking the&n;         * generation) so we don&squot;t write into the wrong file (old inode was&n;         * deleted and then a new one was created with the same number).&n;         */
r_if
c_cond
(paren
id|inode-&gt;i_generation
op_ne
id|generation
)paren
(brace
id|CDEBUG
c_func
(paren
id|D_PIOCTL
comma
l_string|&quot;fatal: bad generation %u (want %u)&bslash;n&quot;
comma
id|inode-&gt;i_generation
comma
id|generation
)paren
suffix:semicolon
id|error
op_assign
op_minus
id|ENOENT
suffix:semicolon
id|EXIT
suffix:semicolon
r_goto
id|cleanup_iput
suffix:semicolon
)brace
id|d_instantiate
c_func
(paren
id|dentry
comma
id|inode
)paren
suffix:semicolon
id|dentry-&gt;d_flags
op_or_assign
id|DCACHE_NFSD_DISCONNECTED
suffix:semicolon
multiline_comment|/* NFS hack */
id|EXIT
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
id|cleanup_iput
suffix:colon
r_if
c_cond
(paren
id|inode
)paren
id|iput
c_func
(paren
id|inode
)paren
suffix:semicolon
r_return
id|ERR_PTR
c_func
(paren
id|error
)paren
suffix:semicolon
)brace
DECL|function|presto_lookup
r_struct
id|dentry
op_star
id|presto_lookup
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|dentry
op_star
id|dentry
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_struct
id|dentry
op_star
id|de
suffix:semicolon
r_struct
id|presto_cache
op_star
id|cache
suffix:semicolon
r_struct
id|presto_file_set
op_star
id|fset
suffix:semicolon
r_int
id|error
suffix:semicolon
r_int
id|minor
suffix:semicolon
id|ino_t
id|ino
suffix:semicolon
r_int
r_int
id|generation
suffix:semicolon
id|ENTRY
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_CACHE
comma
l_string|&quot;calling presto_prep on dentry %p&bslash;n&quot;
comma
id|dentry
)paren
suffix:semicolon
id|error
op_assign
id|presto_prep
c_func
(paren
id|dentry-&gt;d_parent
comma
op_amp
id|cache
comma
op_amp
id|fset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|ERR_PTR
c_func
(paren
id|error
)paren
suffix:semicolon
)brace
id|minor
op_assign
id|presto_c2m
c_func
(paren
id|cache
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_CACHE
comma
l_string|&quot;dir ino: %ld, name: %*s&bslash;n&quot;
comma
id|dir-&gt;i_ino
comma
id|dentry-&gt;d_name.len
comma
id|dentry-&gt;d_name.name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ISLENTO
c_func
(paren
id|minor
)paren
)paren
id|CDEBUG
c_func
(paren
id|D_CACHE
comma
l_string|&quot;We are lento&bslash;n&quot;
)paren
suffix:semicolon
id|rc
op_assign
id|dentry2id
c_func
(paren
id|dentry
comma
op_amp
id|ino
comma
op_amp
id|generation
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_CACHE
comma
l_string|&quot;dentry2id returned %d&bslash;n&quot;
comma
id|rc
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
(brace
id|EXIT
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
)paren
(brace
id|de
op_assign
id|presto_ilookup
c_func
(paren
id|dir
comma
id|dentry
comma
id|ino
comma
id|generation
)paren
suffix:semicolon
)brace
r_else
(brace
r_struct
id|inode_operations
op_star
id|iops
op_assign
id|filter_c2cdiops
c_func
(paren
id|cache-&gt;cache_filter
)paren
suffix:semicolon
id|rc
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* recursively do a cache lookup in dir */
r_if
c_cond
(paren
id|iops
op_logical_and
id|iops-&gt;lookup
)paren
id|de
op_assign
id|iops
op_member_access_from_pointer
id|lookup
c_func
(paren
id|dir
comma
id|dentry
)paren
suffix:semicolon
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;filesystem has no lookup&bslash;n&quot;
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
)brace
multiline_comment|/* XXX this needs some work to handle returning de if we get it */
id|filter_setup_dentry_ops
c_func
(paren
id|cache-&gt;cache_filter
comma
id|dentry-&gt;d_op
comma
op_amp
id|presto_dentry_ops
)paren
suffix:semicolon
id|dentry-&gt;d_op
op_assign
id|filter_c2udops
c_func
(paren
id|cache-&gt;cache_filter
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|de
)paren
)paren
(brace
id|rc
op_assign
id|PTR_ERR
c_func
(paren
id|de
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_CACHE
comma
l_string|&quot;dentry lookup error %d&bslash;n&quot;
comma
id|rc
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_goto
m_exit
suffix:semicolon
)brace
id|presto_set_dd
c_func
(paren
id|dentry
)paren
suffix:semicolon
multiline_comment|/* some file systems set the methods in lookup, not in&n;           read_inode, as a result we should set the methods here &n;           as well as in read_inode &n;        */
r_if
c_cond
(paren
id|dentry-&gt;d_inode
)paren
(brace
id|presto_set_ops
c_func
(paren
id|dentry-&gt;d_inode
comma
id|cache-&gt;cache_filter
)paren
suffix:semicolon
)brace
id|EXIT
suffix:semicolon
m_exit
suffix:colon
r_return
id|ERR_PTR
c_func
(paren
id|rc
)paren
suffix:semicolon
)brace
DECL|function|presto_setattr
r_int
id|presto_setattr
c_func
(paren
r_struct
id|dentry
op_star
id|de
comma
r_struct
id|iattr
op_star
id|iattr
)paren
(brace
r_int
id|error
suffix:semicolon
r_struct
id|presto_cache
op_star
id|cache
suffix:semicolon
r_struct
id|presto_file_set
op_star
id|fset
suffix:semicolon
r_struct
id|lento_vfs_context
id|info
op_assign
(brace
l_int|0
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
id|ENTRY
suffix:semicolon
id|error
op_assign
id|presto_prep
c_func
(paren
id|de
comma
op_amp
id|cache
comma
op_amp
id|fset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|iattr-&gt;ia_valid
)paren
id|CDEBUG
c_func
(paren
id|D_INODE
comma
l_string|&quot;presto_setattr: iattr is not valid&bslash;n&quot;
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_INODE
comma
l_string|&quot;valid %#x, mode %#o, uid %u, gid %u, size %Lu, &quot;
l_string|&quot;atime %lu mtime %lu ctime %lu flags %d&bslash;n&quot;
comma
id|iattr-&gt;ia_valid
comma
id|iattr-&gt;ia_mode
comma
id|iattr-&gt;ia_uid
comma
id|iattr-&gt;ia_gid
comma
id|iattr-&gt;ia_size
comma
id|iattr-&gt;ia_atime
comma
id|iattr-&gt;ia_mtime
comma
id|iattr-&gt;ia_ctime
comma
id|iattr-&gt;ia_attr_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|presto_get_permit
c_func
(paren
id|de-&gt;d_inode
)paren
OL
l_int|0
)paren
(brace
id|EXIT
suffix:semicolon
id|error
op_assign
op_minus
id|EROFS
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|ISLENTO
c_func
(paren
id|presto_c2m
c_func
(paren
id|cache
)paren
)paren
)paren
id|info.flags
op_assign
id|LENTO_FL_KML
suffix:semicolon
id|info.flags
op_or_assign
id|LENTO_FL_IGNORE_TIME
suffix:semicolon
id|error
op_assign
id|presto_do_setattr
c_func
(paren
id|fset
comma
id|de
comma
id|iattr
comma
op_amp
id|info
)paren
suffix:semicolon
id|presto_put_permit
c_func
(paren
id|de-&gt;d_inode
)paren
suffix:semicolon
id|out
suffix:colon
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
multiline_comment|/*&n; *  Now the meat: the fs operations that require journaling&n; *&n; *&n; *  XXX: some of these need modifications for hierarchical filesets&n; */
DECL|function|presto_prep
r_int
id|presto_prep
c_func
(paren
r_struct
id|dentry
op_star
id|dentry
comma
r_struct
id|presto_cache
op_star
op_star
id|cache
comma
r_struct
id|presto_file_set
op_star
op_star
id|fset
)paren
(brace
op_star
id|fset
op_assign
id|presto_fset
c_func
(paren
id|dentry
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
op_star
id|fset
)paren
(brace
id|CDEBUG
c_func
(paren
id|D_INODE
comma
l_string|&quot;No file set for dentry at %p&bslash;n&quot;
comma
id|dentry
)paren
suffix:semicolon
r_return
op_minus
id|EROFS
suffix:semicolon
)brace
op_star
id|cache
op_assign
(paren
op_star
id|fset
)paren
op_member_access_from_pointer
id|fset_cache
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
op_star
id|cache
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;PRESTO: BAD, BAD: cannot find cache&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EBADF
suffix:semicolon
)brace
id|CDEBUG
c_func
(paren
id|D_PIOCTL
comma
l_string|&quot;---&gt; cache flags %x, fset flags %x&bslash;n&quot;
comma
(paren
op_star
id|cache
)paren
op_member_access_from_pointer
id|cache_flags
comma
(paren
op_star
id|fset
)paren
op_member_access_from_pointer
id|fset_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|presto_is_read_only
c_func
(paren
op_star
id|fset
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;PRESTO: cannot modify read-only fileset, minor %d.&bslash;n&quot;
comma
id|presto_c2m
c_func
(paren
op_star
id|cache
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EROFS
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|presto_create
r_static
r_int
id|presto_create
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|dentry
op_star
id|dentry
comma
r_int
id|mode
)paren
(brace
r_int
id|error
suffix:semicolon
r_struct
id|presto_cache
op_star
id|cache
suffix:semicolon
r_struct
id|dentry
op_star
id|parent
op_assign
id|dentry-&gt;d_parent
suffix:semicolon
r_struct
id|lento_vfs_context
id|info
suffix:semicolon
r_struct
id|presto_file_set
op_star
id|fset
suffix:semicolon
id|ENTRY
suffix:semicolon
id|error
op_assign
id|presto_prep
c_func
(paren
id|dentry-&gt;d_parent
comma
op_amp
id|cache
comma
op_amp
id|fset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|presto_unlock
c_func
(paren
id|dir
)paren
suffix:semicolon
multiline_comment|/* Does blocking and non-blocking behavious need to be &n;           checked for.  Without blocking (return 1), the permit&n;           was acquired without reintegration&n;        */
r_if
c_cond
(paren
id|presto_get_permit
c_func
(paren
id|dir
)paren
OL
l_int|0
)paren
(brace
id|EXIT
suffix:semicolon
id|presto_fulllock
c_func
(paren
id|dir
)paren
suffix:semicolon
r_return
op_minus
id|EROFS
suffix:semicolon
)brace
id|presto_relock_sem
c_func
(paren
id|dir
)paren
suffix:semicolon
id|parent
op_assign
id|dentry-&gt;d_parent
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|info
comma
l_int|0
comma
r_sizeof
(paren
id|info
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ISLENTO
c_func
(paren
id|presto_c2m
c_func
(paren
id|cache
)paren
)paren
)paren
id|info.flags
op_assign
id|LENTO_FL_KML
suffix:semicolon
id|info.flags
op_or_assign
id|LENTO_FL_IGNORE_TIME
suffix:semicolon
id|error
op_assign
id|presto_do_create
c_func
(paren
id|fset
comma
id|parent
comma
id|dentry
comma
id|mode
comma
op_amp
id|info
)paren
suffix:semicolon
id|presto_relock_other
c_func
(paren
id|dir
)paren
suffix:semicolon
id|presto_put_permit
c_func
(paren
id|dir
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|function|presto_link
r_static
r_int
id|presto_link
c_func
(paren
r_struct
id|dentry
op_star
id|old_dentry
comma
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|dentry
op_star
id|new_dentry
)paren
(brace
r_int
id|error
suffix:semicolon
r_struct
id|presto_cache
op_star
id|cache
comma
op_star
id|new_cache
suffix:semicolon
r_struct
id|presto_file_set
op_star
id|fset
comma
op_star
id|new_fset
suffix:semicolon
r_struct
id|dentry
op_star
id|parent
op_assign
id|new_dentry-&gt;d_parent
suffix:semicolon
r_struct
id|lento_vfs_context
id|info
suffix:semicolon
id|ENTRY
suffix:semicolon
id|error
op_assign
id|presto_prep
c_func
(paren
id|old_dentry
comma
op_amp
id|cache
comma
op_amp
id|fset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|error
op_assign
id|presto_prep
c_func
(paren
id|new_dentry-&gt;d_parent
comma
op_amp
id|new_cache
comma
op_amp
id|new_fset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fset
op_ne
id|new_fset
)paren
(brace
id|EXIT
suffix:semicolon
r_return
op_minus
id|EXDEV
suffix:semicolon
)brace
id|presto_unlock
c_func
(paren
id|dir
)paren
suffix:semicolon
r_if
c_cond
(paren
id|presto_get_permit
c_func
(paren
id|old_dentry-&gt;d_inode
)paren
OL
l_int|0
)paren
(brace
id|EXIT
suffix:semicolon
id|presto_fulllock
c_func
(paren
id|dir
)paren
suffix:semicolon
r_return
op_minus
id|EROFS
suffix:semicolon
)brace
r_if
c_cond
(paren
id|presto_get_permit
c_func
(paren
id|dir
)paren
OL
l_int|0
)paren
(brace
id|EXIT
suffix:semicolon
id|presto_fulllock
c_func
(paren
id|dir
)paren
suffix:semicolon
r_return
op_minus
id|EROFS
suffix:semicolon
)brace
id|presto_relock_sem
c_func
(paren
id|dir
)paren
suffix:semicolon
id|parent
op_assign
id|new_dentry-&gt;d_parent
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|info
comma
l_int|0
comma
r_sizeof
(paren
id|info
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ISLENTO
c_func
(paren
id|presto_c2m
c_func
(paren
id|cache
)paren
)paren
)paren
id|info.flags
op_assign
id|LENTO_FL_KML
suffix:semicolon
id|info.flags
op_or_assign
id|LENTO_FL_IGNORE_TIME
suffix:semicolon
id|error
op_assign
id|presto_do_link
c_func
(paren
id|fset
comma
id|old_dentry
comma
id|parent
comma
id|new_dentry
comma
op_amp
id|info
)paren
suffix:semicolon
id|presto_relock_other
c_func
(paren
id|dir
)paren
suffix:semicolon
id|presto_put_permit
c_func
(paren
id|dir
)paren
suffix:semicolon
id|presto_put_permit
c_func
(paren
id|old_dentry-&gt;d_inode
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|function|presto_mkdir
r_static
r_int
id|presto_mkdir
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|dentry
op_star
id|dentry
comma
r_int
id|mode
)paren
(brace
r_int
id|error
suffix:semicolon
r_struct
id|presto_file_set
op_star
id|fset
suffix:semicolon
r_struct
id|presto_cache
op_star
id|cache
suffix:semicolon
r_struct
id|dentry
op_star
id|parent
op_assign
id|dentry-&gt;d_parent
suffix:semicolon
r_struct
id|lento_vfs_context
id|info
suffix:semicolon
id|ENTRY
suffix:semicolon
id|error
op_assign
id|presto_prep
c_func
(paren
id|dentry-&gt;d_parent
comma
op_amp
id|cache
comma
op_amp
id|fset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|presto_unlock
c_func
(paren
id|dir
)paren
suffix:semicolon
r_if
c_cond
(paren
id|presto_get_permit
c_func
(paren
id|dir
)paren
OL
l_int|0
)paren
(brace
id|EXIT
suffix:semicolon
id|presto_fulllock
c_func
(paren
id|dir
)paren
suffix:semicolon
r_return
op_minus
id|EROFS
suffix:semicolon
)brace
id|memset
c_func
(paren
op_amp
id|info
comma
l_int|0
comma
r_sizeof
(paren
id|info
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ISLENTO
c_func
(paren
id|presto_c2m
c_func
(paren
id|cache
)paren
)paren
)paren
id|info.flags
op_assign
id|LENTO_FL_KML
suffix:semicolon
id|info.flags
op_or_assign
id|LENTO_FL_IGNORE_TIME
suffix:semicolon
id|presto_relock_sem
c_func
(paren
id|dir
)paren
suffix:semicolon
id|parent
op_assign
id|dentry-&gt;d_parent
suffix:semicolon
id|error
op_assign
id|presto_do_mkdir
c_func
(paren
id|fset
comma
id|parent
comma
id|dentry
comma
id|mode
comma
op_amp
id|info
)paren
suffix:semicolon
id|presto_relock_other
c_func
(paren
id|dir
)paren
suffix:semicolon
id|presto_put_permit
c_func
(paren
id|dir
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|function|presto_symlink
r_static
r_int
id|presto_symlink
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|dentry
op_star
id|dentry
comma
r_const
r_char
op_star
id|name
)paren
(brace
r_int
id|error
suffix:semicolon
r_struct
id|presto_cache
op_star
id|cache
suffix:semicolon
r_struct
id|presto_file_set
op_star
id|fset
suffix:semicolon
r_struct
id|dentry
op_star
id|parent
op_assign
id|dentry-&gt;d_parent
suffix:semicolon
r_struct
id|lento_vfs_context
id|info
suffix:semicolon
id|ENTRY
suffix:semicolon
id|error
op_assign
id|presto_prep
c_func
(paren
id|dentry-&gt;d_parent
comma
op_amp
id|cache
comma
op_amp
id|fset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|presto_unlock
c_func
(paren
id|dir
)paren
suffix:semicolon
r_if
c_cond
(paren
id|presto_get_permit
c_func
(paren
id|dir
)paren
OL
l_int|0
)paren
(brace
id|EXIT
suffix:semicolon
id|presto_fulllock
c_func
(paren
id|dir
)paren
suffix:semicolon
r_return
op_minus
id|EROFS
suffix:semicolon
)brace
id|presto_relock_sem
c_func
(paren
id|dir
)paren
suffix:semicolon
id|parent
op_assign
id|dentry-&gt;d_parent
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|info
comma
l_int|0
comma
r_sizeof
(paren
id|info
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ISLENTO
c_func
(paren
id|presto_c2m
c_func
(paren
id|cache
)paren
)paren
)paren
id|info.flags
op_assign
id|LENTO_FL_KML
suffix:semicolon
id|info.flags
op_or_assign
id|LENTO_FL_IGNORE_TIME
suffix:semicolon
id|error
op_assign
id|presto_do_symlink
c_func
(paren
id|fset
comma
id|parent
comma
id|dentry
comma
id|name
comma
op_amp
id|info
)paren
suffix:semicolon
id|presto_relock_other
c_func
(paren
id|dir
)paren
suffix:semicolon
id|presto_put_permit
c_func
(paren
id|dir
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|function|presto_unlink
r_int
id|presto_unlink
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|dentry
op_star
id|dentry
)paren
(brace
r_int
id|error
suffix:semicolon
r_struct
id|presto_cache
op_star
id|cache
suffix:semicolon
r_struct
id|presto_file_set
op_star
id|fset
suffix:semicolon
r_struct
id|dentry
op_star
id|parent
op_assign
id|dentry-&gt;d_parent
suffix:semicolon
r_struct
id|lento_vfs_context
id|info
suffix:semicolon
id|ENTRY
suffix:semicolon
id|error
op_assign
id|presto_prep
c_func
(paren
id|dentry-&gt;d_parent
comma
op_amp
id|cache
comma
op_amp
id|fset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|presto_unlock
c_func
(paren
id|dir
)paren
suffix:semicolon
r_if
c_cond
(paren
id|presto_get_permit
c_func
(paren
id|dir
)paren
OL
l_int|0
)paren
(brace
id|EXIT
suffix:semicolon
id|presto_fulllock
c_func
(paren
id|dir
)paren
suffix:semicolon
r_return
op_minus
id|EROFS
suffix:semicolon
)brace
id|presto_relock_sem
c_func
(paren
id|dir
)paren
suffix:semicolon
id|parent
op_assign
id|dentry-&gt;d_parent
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|info
comma
l_int|0
comma
r_sizeof
(paren
id|info
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ISLENTO
c_func
(paren
id|presto_c2m
c_func
(paren
id|cache
)paren
)paren
)paren
id|info.flags
op_assign
id|LENTO_FL_KML
suffix:semicolon
id|info.flags
op_or_assign
id|LENTO_FL_IGNORE_TIME
suffix:semicolon
id|error
op_assign
id|presto_do_unlink
c_func
(paren
id|fset
comma
id|parent
comma
id|dentry
comma
op_amp
id|info
)paren
suffix:semicolon
id|presto_relock_other
c_func
(paren
id|dir
)paren
suffix:semicolon
id|presto_put_permit
c_func
(paren
id|dir
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|function|presto_rmdir
r_static
r_int
id|presto_rmdir
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|dentry
op_star
id|dentry
)paren
(brace
r_int
id|error
suffix:semicolon
r_struct
id|presto_cache
op_star
id|cache
suffix:semicolon
r_struct
id|presto_file_set
op_star
id|fset
suffix:semicolon
r_struct
id|dentry
op_star
id|parent
op_assign
id|dentry-&gt;d_parent
suffix:semicolon
r_struct
id|lento_vfs_context
id|info
suffix:semicolon
id|ENTRY
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_FILE
comma
l_string|&quot;prepping presto&bslash;n&quot;
)paren
suffix:semicolon
id|error
op_assign
id|presto_prep
c_func
(paren
id|dentry-&gt;d_parent
comma
op_amp
id|cache
comma
op_amp
id|fset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|CDEBUG
c_func
(paren
id|D_FILE
comma
l_string|&quot;unlocking&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* We need to dget() before the dput in double_unlock, to ensure we&n;         * still have dentry references.  double_lock doesn&squot;t do dget for us.&n;         */
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|d_unhashed
c_func
(paren
id|dentry
)paren
)paren
id|d_rehash
c_func
(paren
id|dentry
)paren
suffix:semicolon
id|double_up
c_func
(paren
op_amp
id|dir-&gt;i_zombie
comma
op_amp
id|dentry-&gt;d_inode-&gt;i_zombie
)paren
suffix:semicolon
id|double_up
c_func
(paren
op_amp
id|dir-&gt;i_sem
comma
op_amp
id|dentry-&gt;d_inode-&gt;i_sem
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_FILE
comma
l_string|&quot;getting permit&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|presto_get_permit
c_func
(paren
id|parent-&gt;d_inode
)paren
OL
l_int|0
)paren
(brace
id|EXIT
suffix:semicolon
id|double_down
c_func
(paren
op_amp
id|dir-&gt;i_sem
comma
op_amp
id|dentry-&gt;d_inode-&gt;i_sem
)paren
suffix:semicolon
id|double_down
c_func
(paren
op_amp
id|dir-&gt;i_zombie
comma
op_amp
id|dentry-&gt;d_inode-&gt;i_zombie
)paren
suffix:semicolon
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
r_return
op_minus
id|EROFS
suffix:semicolon
)brace
id|CDEBUG
c_func
(paren
id|D_FILE
comma
l_string|&quot;locking&bslash;n&quot;
)paren
suffix:semicolon
id|double_down
c_func
(paren
op_amp
id|dir-&gt;i_sem
comma
op_amp
id|dentry-&gt;d_inode-&gt;i_sem
)paren
suffix:semicolon
id|parent
op_assign
id|dentry-&gt;d_parent
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|info
comma
l_int|0
comma
r_sizeof
(paren
id|info
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ISLENTO
c_func
(paren
id|presto_c2m
c_func
(paren
id|cache
)paren
)paren
)paren
id|info.flags
op_assign
id|LENTO_FL_KML
suffix:semicolon
id|info.flags
op_or_assign
id|LENTO_FL_IGNORE_TIME
suffix:semicolon
id|error
op_assign
id|presto_do_rmdir
c_func
(paren
id|fset
comma
id|parent
comma
id|dentry
comma
op_amp
id|info
)paren
suffix:semicolon
id|presto_put_permit
c_func
(paren
id|parent-&gt;d_inode
)paren
suffix:semicolon
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|function|presto_mknod
r_static
r_int
id|presto_mknod
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|dentry
op_star
id|dentry
comma
r_int
id|mode
comma
r_int
id|rdev
)paren
(brace
r_int
id|error
suffix:semicolon
r_struct
id|presto_cache
op_star
id|cache
suffix:semicolon
r_struct
id|presto_file_set
op_star
id|fset
suffix:semicolon
r_struct
id|dentry
op_star
id|parent
op_assign
id|dentry-&gt;d_parent
suffix:semicolon
r_struct
id|lento_vfs_context
id|info
suffix:semicolon
id|ENTRY
suffix:semicolon
id|error
op_assign
id|presto_prep
c_func
(paren
id|dentry-&gt;d_parent
comma
op_amp
id|cache
comma
op_amp
id|fset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|presto_unlock
c_func
(paren
id|dir
)paren
suffix:semicolon
r_if
c_cond
(paren
id|presto_get_permit
c_func
(paren
id|dir
)paren
OL
l_int|0
)paren
(brace
id|EXIT
suffix:semicolon
id|presto_fulllock
c_func
(paren
id|dir
)paren
suffix:semicolon
r_return
op_minus
id|EROFS
suffix:semicolon
)brace
id|presto_relock_sem
c_func
(paren
id|dir
)paren
suffix:semicolon
id|parent
op_assign
id|dentry-&gt;d_parent
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|info
comma
l_int|0
comma
r_sizeof
(paren
id|info
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ISLENTO
c_func
(paren
id|presto_c2m
c_func
(paren
id|cache
)paren
)paren
)paren
id|info.flags
op_assign
id|LENTO_FL_KML
suffix:semicolon
id|info.flags
op_or_assign
id|LENTO_FL_IGNORE_TIME
suffix:semicolon
id|error
op_assign
id|presto_do_mknod
c_func
(paren
id|fset
comma
id|parent
comma
id|dentry
comma
id|mode
comma
id|rdev
comma
op_amp
id|info
)paren
suffix:semicolon
id|presto_relock_other
c_func
(paren
id|dir
)paren
suffix:semicolon
id|presto_put_permit
c_func
(paren
id|dir
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|function|presto_triple_unlock
r_inline
r_void
id|presto_triple_unlock
c_func
(paren
r_struct
id|inode
op_star
id|old_dir
comma
r_struct
id|inode
op_star
id|new_dir
comma
r_struct
id|dentry
op_star
id|old_dentry
comma
r_struct
id|dentry
op_star
id|new_dentry
comma
r_int
id|triple
)paren
(brace
multiline_comment|/* rename_dir case */
r_if
c_cond
(paren
id|S_ISDIR
c_func
(paren
id|old_dentry-&gt;d_inode-&gt;i_mode
)paren
)paren
(brace
r_if
c_cond
(paren
id|triple
)paren
(brace
id|triple_up
c_func
(paren
op_amp
id|old_dir-&gt;i_zombie
comma
op_amp
id|new_dir-&gt;i_zombie
comma
op_amp
id|new_dentry-&gt;d_inode-&gt;i_zombie
)paren
suffix:semicolon
)brace
r_else
(brace
id|double_up
c_func
(paren
op_amp
id|old_dir-&gt;i_zombie
comma
op_amp
id|new_dir-&gt;i_zombie
)paren
suffix:semicolon
)brace
id|up
c_func
(paren
op_amp
id|old_dir-&gt;i_sb-&gt;s_vfs_rename_sem
)paren
suffix:semicolon
)brace
r_else
multiline_comment|/* this case is rename_other */
id|double_up
c_func
(paren
op_amp
id|old_dir-&gt;i_zombie
comma
op_amp
id|new_dir-&gt;i_zombie
)paren
suffix:semicolon
multiline_comment|/* done by do_rename */
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
id|double_up
c_func
(paren
op_amp
id|old_dir-&gt;i_sem
comma
op_amp
id|new_dir-&gt;i_sem
)paren
suffix:semicolon
)brace
DECL|function|presto_triple_fulllock
r_inline
r_void
id|presto_triple_fulllock
c_func
(paren
r_struct
id|inode
op_star
id|old_dir
comma
r_struct
id|inode
op_star
id|new_dir
comma
r_struct
id|dentry
op_star
id|old_dentry
comma
r_struct
id|dentry
op_star
id|new_dentry
comma
r_int
id|triple
)paren
(brace
multiline_comment|/* done by do_rename */
id|double_down
c_func
(paren
op_amp
id|old_dir-&gt;i_sem
comma
op_amp
id|new_dir-&gt;i_sem
)paren
suffix:semicolon
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* rename_dir case */
r_if
c_cond
(paren
id|S_ISDIR
c_func
(paren
id|old_dentry-&gt;d_inode-&gt;i_mode
)paren
)paren
(brace
id|down
c_func
(paren
op_amp
id|old_dir-&gt;i_sb-&gt;s_vfs_rename_sem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|triple
)paren
(brace
id|triple_down
c_func
(paren
op_amp
id|old_dir-&gt;i_zombie
comma
op_amp
id|new_dir-&gt;i_zombie
comma
op_amp
id|new_dentry-&gt;d_inode-&gt;i_zombie
)paren
suffix:semicolon
)brace
r_else
(brace
id|double_down
c_func
(paren
op_amp
id|old_dir-&gt;i_zombie
comma
op_amp
id|new_dir-&gt;i_zombie
)paren
suffix:semicolon
)brace
)brace
r_else
multiline_comment|/* this case is rename_other */
id|double_down
c_func
(paren
op_amp
id|old_dir-&gt;i_zombie
comma
op_amp
id|new_dir-&gt;i_zombie
)paren
suffix:semicolon
)brace
DECL|function|presto_triple_relock_sem
r_inline
r_void
id|presto_triple_relock_sem
c_func
(paren
r_struct
id|inode
op_star
id|old_dir
comma
r_struct
id|inode
op_star
id|new_dir
comma
r_struct
id|dentry
op_star
id|old_dentry
comma
r_struct
id|dentry
op_star
id|new_dentry
comma
r_int
id|triple
)paren
(brace
multiline_comment|/* done by do_rename */
id|double_down
c_func
(paren
op_amp
id|old_dir-&gt;i_sem
comma
op_amp
id|new_dir-&gt;i_sem
)paren
suffix:semicolon
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|presto_triple_relock_other
r_inline
r_void
id|presto_triple_relock_other
c_func
(paren
r_struct
id|inode
op_star
id|old_dir
comma
r_struct
id|inode
op_star
id|new_dir
comma
r_struct
id|dentry
op_star
id|old_dentry
comma
r_struct
id|dentry
op_star
id|new_dentry
comma
r_int
id|triple
)paren
(brace
multiline_comment|/* rename_dir case */
r_if
c_cond
(paren
id|S_ISDIR
c_func
(paren
id|old_dentry-&gt;d_inode-&gt;i_mode
)paren
)paren
(brace
id|down
c_func
(paren
op_amp
id|old_dir-&gt;i_sb-&gt;s_vfs_rename_sem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|triple
)paren
(brace
id|triple_down
c_func
(paren
op_amp
id|old_dir-&gt;i_zombie
comma
op_amp
id|new_dir-&gt;i_zombie
comma
op_amp
id|new_dentry-&gt;d_inode-&gt;i_zombie
)paren
suffix:semicolon
)brace
r_else
(brace
id|double_down
c_func
(paren
op_amp
id|old_dir-&gt;i_zombie
comma
op_amp
id|new_dir-&gt;i_zombie
)paren
suffix:semicolon
)brace
)brace
r_else
multiline_comment|/* this case is rename_other */
id|double_down
c_func
(paren
op_amp
id|old_dir-&gt;i_zombie
comma
op_amp
id|new_dir-&gt;i_zombie
)paren
suffix:semicolon
)brace
singleline_comment|// XXX this can be optimized: renamtes across filesets only require 
singleline_comment|//     multiple KML records, but can locally be executed normally. 
DECL|function|presto_rename
r_int
id|presto_rename
c_func
(paren
r_struct
id|inode
op_star
id|old_dir
comma
r_struct
id|dentry
op_star
id|old_dentry
comma
r_struct
id|inode
op_star
id|new_dir
comma
r_struct
id|dentry
op_star
id|new_dentry
)paren
(brace
r_int
id|error
suffix:semicolon
r_struct
id|presto_cache
op_star
id|cache
comma
op_star
id|new_cache
suffix:semicolon
r_struct
id|presto_file_set
op_star
id|fset
comma
op_star
id|new_fset
suffix:semicolon
r_struct
id|lento_vfs_context
id|info
suffix:semicolon
r_struct
id|dentry
op_star
id|old_parent
op_assign
id|old_dentry-&gt;d_parent
suffix:semicolon
r_struct
id|dentry
op_star
id|new_parent
op_assign
id|new_dentry-&gt;d_parent
suffix:semicolon
r_int
id|triple
suffix:semicolon
id|ENTRY
suffix:semicolon
id|error
op_assign
id|presto_prep
c_func
(paren
id|old_dentry
comma
op_amp
id|cache
comma
op_amp
id|fset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|error
op_assign
id|presto_prep
c_func
(paren
id|new_parent
comma
op_amp
id|new_cache
comma
op_amp
id|new_fset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fset
op_ne
id|new_fset
)paren
(brace
id|EXIT
suffix:semicolon
r_return
op_minus
id|EXDEV
suffix:semicolon
)brace
multiline_comment|/* We need to do dget before the dput in double_unlock, to ensure we&n;         * still have dentry references.  double_lock doesn&squot;t do dget for us.&n;         */
id|triple
op_assign
(paren
id|S_ISDIR
c_func
(paren
id|old_dentry-&gt;d_inode-&gt;i_mode
)paren
op_logical_and
id|new_dentry-&gt;d_inode
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|presto_triple_unlock
c_func
(paren
id|old_dir
comma
id|new_dir
comma
id|old_dentry
comma
id|new_dentry
comma
id|triple
)paren
suffix:semicolon
r_if
c_cond
(paren
id|presto_get_permit
c_func
(paren
id|old_dir
)paren
OL
l_int|0
)paren
(brace
id|EXIT
suffix:semicolon
id|presto_triple_fulllock
c_func
(paren
id|old_dir
comma
id|new_dir
comma
id|old_dentry
comma
id|new_dentry
comma
id|triple
)paren
suffix:semicolon
r_return
op_minus
id|EROFS
suffix:semicolon
)brace
r_if
c_cond
(paren
id|presto_get_permit
c_func
(paren
id|new_dir
)paren
OL
l_int|0
)paren
(brace
id|EXIT
suffix:semicolon
id|presto_triple_fulllock
c_func
(paren
id|old_dir
comma
id|new_dir
comma
id|old_dentry
comma
id|new_dentry
comma
id|triple
)paren
suffix:semicolon
r_return
op_minus
id|EROFS
suffix:semicolon
)brace
id|presto_triple_relock_sem
c_func
(paren
id|old_dir
comma
id|new_dir
comma
id|old_dentry
comma
id|new_dentry
comma
id|triple
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|info
comma
l_int|0
comma
r_sizeof
(paren
id|info
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ISLENTO
c_func
(paren
id|presto_c2m
c_func
(paren
id|cache
)paren
)paren
)paren
id|info.flags
op_assign
id|LENTO_FL_KML
suffix:semicolon
id|info.flags
op_or_assign
id|LENTO_FL_IGNORE_TIME
suffix:semicolon
id|error
op_assign
id|presto_do_rename
c_func
(paren
id|fset
comma
id|old_parent
comma
id|old_dentry
comma
id|new_parent
comma
id|new_dentry
comma
op_amp
id|info
)paren
suffix:semicolon
id|presto_triple_relock_other
c_func
(paren
id|old_dir
comma
id|new_dir
comma
id|old_dentry
comma
id|new_dentry
comma
id|triple
)paren
suffix:semicolon
id|presto_put_permit
c_func
(paren
id|new_dir
)paren
suffix:semicolon
id|presto_put_permit
c_func
(paren
id|old_dir
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
multiline_comment|/* basically this allows the ilookup processes access to all files for&n; * reading, while not making ilookup totally insecure.  This could all&n; * go away if we could set the CAP_DAC_READ_SEARCH capability for the client.&n; */
multiline_comment|/* If posix acls are available, the underlying cache fs will export the&n; * appropriate permission function. Thus we do not worry here about ACLs&n; * or EAs. -SHP&n; */
DECL|function|presto_permission
r_int
id|presto_permission
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_int
id|mask
)paren
(brace
r_int
r_int
id|mode
op_assign
id|inode-&gt;i_mode
suffix:semicolon
r_struct
id|presto_cache
op_star
id|cache
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|ENTRY
suffix:semicolon
r_if
c_cond
(paren
id|presto_can_ilookup
c_func
(paren
)paren
op_logical_and
op_logical_neg
(paren
id|mask
op_amp
id|S_IWOTH
)paren
)paren
(brace
id|CDEBUG
c_func
(paren
id|D_CACHE
comma
l_string|&quot;ilookup on %ld OK&bslash;n&quot;
comma
id|inode-&gt;i_ino
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|cache
op_assign
id|presto_get_cache
c_func
(paren
id|inode
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cache
)paren
(brace
multiline_comment|/* we only override the file/dir permission operations */
r_struct
id|inode_operations
op_star
id|fiops
op_assign
id|filter_c2cfiops
c_func
(paren
id|cache-&gt;cache_filter
)paren
suffix:semicolon
r_struct
id|inode_operations
op_star
id|diops
op_assign
id|filter_c2cdiops
c_func
(paren
id|cache-&gt;cache_filter
)paren
suffix:semicolon
r_if
c_cond
(paren
id|S_ISREG
c_func
(paren
id|mode
)paren
op_logical_and
id|fiops
op_logical_and
id|fiops-&gt;permission
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|fiops
op_member_access_from_pointer
id|permission
c_func
(paren
id|inode
comma
id|mask
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|S_ISDIR
c_func
(paren
id|mode
)paren
op_logical_and
id|diops
op_logical_and
id|diops-&gt;permission
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|diops
op_member_access_from_pointer
id|permission
c_func
(paren
id|inode
comma
id|mask
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* The cache filesystem doesn&squot;t have its own permission function,&n;         * but we don&squot;t want to duplicate the VFS code here.  In order&n;         * to avoid looping from permission calling this function again,&n;         * we temporarily override the permission operation while we call&n;         * the VFS permission function.&n;         */
id|inode-&gt;i_op-&gt;permission
op_assign
l_int|NULL
suffix:semicolon
id|rc
op_assign
id|permission
c_func
(paren
id|inode
comma
id|mask
)paren
suffix:semicolon
id|inode-&gt;i_op-&gt;permission
op_assign
op_amp
id|presto_permission
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|presto_dir_open
r_static
r_int
id|presto_dir_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_struct
id|dentry
op_star
id|de
op_assign
id|file-&gt;f_dentry
suffix:semicolon
r_struct
id|file_operations
op_star
id|fops
suffix:semicolon
r_struct
id|presto_cache
op_star
id|cache
suffix:semicolon
r_struct
id|presto_file_set
op_star
id|fset
suffix:semicolon
r_int
id|minor
suffix:semicolon
r_int
id|error
suffix:semicolon
id|ENTRY
suffix:semicolon
id|error
op_assign
id|presto_prep
c_func
(paren
id|file-&gt;f_dentry
comma
op_amp
id|cache
comma
op_amp
id|fset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
id|make_bad_inode
c_func
(paren
id|inode
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|minor
op_assign
id|presto_c2m
c_func
(paren
id|cache
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_CACHE
comma
l_string|&quot;minor %d, DATA_OK: %d, ino: %ld&bslash;n&quot;
comma
id|minor
comma
id|presto_chk
c_func
(paren
id|de
comma
id|PRESTO_DATA
)paren
comma
id|inode-&gt;i_ino
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ISLENTO
c_func
(paren
id|minor
)paren
)paren
r_goto
id|cache
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|presto_chk
c_func
(paren
id|de
comma
id|PRESTO_DATA
)paren
)paren
(brace
id|CDEBUG
c_func
(paren
id|D_CACHE
comma
l_string|&quot;doing lento_opendir&bslash;n&quot;
)paren
suffix:semicolon
id|rc
op_assign
id|presto_opendir_upcall
c_func
(paren
id|minor
comma
id|file-&gt;f_dentry
comma
id|fset-&gt;fset_mtpt
comma
id|SYNCHRONOUS
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rc
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;presto_dir_open: DATA_OK: %d, ino: %ld, error %d&bslash;n&quot;
comma
id|presto_chk
c_func
(paren
id|de
comma
id|PRESTO_DATA
)paren
comma
id|inode-&gt;i_ino
comma
id|rc
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|cache
suffix:colon
id|fops
op_assign
id|filter_c2cdfops
c_func
(paren
id|cache-&gt;cache_filter
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fops-&gt;open
)paren
(brace
id|rc
op_assign
id|fops
op_member_access_from_pointer
id|open
c_func
(paren
id|inode
comma
id|file
)paren
suffix:semicolon
)brace
id|presto_set
c_func
(paren
id|de
comma
id|PRESTO_DATA
op_or
id|PRESTO_ATTR
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_CACHE
comma
l_string|&quot;returns %d, data %d, attr %d&bslash;n&quot;
comma
id|rc
comma
id|presto_chk
c_func
(paren
id|de
comma
id|PRESTO_DATA
)paren
comma
id|presto_chk
c_func
(paren
id|de
comma
id|PRESTO_ATTR
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|presto_dir_fops
r_struct
id|file_operations
id|presto_dir_fops
op_assign
(brace
id|open
suffix:colon
id|presto_dir_open
)brace
suffix:semicolon
DECL|variable|presto_dir_iops
r_struct
id|inode_operations
id|presto_dir_iops
op_assign
(brace
id|create
suffix:colon
id|presto_create
comma
id|lookup
suffix:colon
id|presto_lookup
comma
id|link
suffix:colon
id|presto_link
comma
id|unlink
suffix:colon
id|presto_unlink
comma
id|symlink
suffix:colon
id|presto_symlink
comma
id|mkdir
suffix:colon
id|presto_mkdir
comma
id|rmdir
suffix:colon
id|presto_rmdir
comma
id|mknod
suffix:colon
id|presto_mknod
comma
id|rename
suffix:colon
id|presto_rename
comma
id|permission
suffix:colon
id|presto_permission
comma
id|setattr
suffix:colon
id|presto_setattr
comma
macro_line|#ifdef CONFIG_FS_EXT_ATTR
id|set_ext_attr
suffix:colon
id|presto_set_ext_attr
comma
macro_line|#endif
)brace
suffix:semicolon
eof
