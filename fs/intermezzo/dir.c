multiline_comment|/* -*- mode: c; c-basic-offset: 8; indent-tabs-mode: nil; -*-&n; * vim:expandtab:shiftwidth=8:tabstop=8:&n; *&n; *  Copyright (C) 2000 Stelias Computing, Inc.&n; *  Copyright (C) 2000 Red Hat, Inc.&n; *  Copyright (C) 2000 Tacitus Systems&n; *  Copyright (C) 2000 Peter J. Braam&n; *&n; *   This file is part of InterMezzo, http://www.inter-mezzo.org.&n; *&n; *   InterMezzo is free software; you can redistribute it and/or&n; *   modify it under the terms of version 2 of the GNU General Public&n; *   License as published by the Free Software Foundation.&n; *&n; *   InterMezzo is distributed in the hope that it will be useful,&n; *   but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *   GNU General Public License for more details.&n; *&n; *   You should have received a copy of the GNU General Public License&n; *   along with InterMezzo; if not, write to the Free Software&n; *   Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; */
macro_line|#include &lt;stdarg.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/ioctls.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/namei.h&gt;
macro_line|#include &lt;linux/ext2_fs.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/vmalloc.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/blkdev.h&gt;
macro_line|#include &lt;linux/init.h&gt;
DECL|macro|__NO_VERSION__
mdefine_line|#define __NO_VERSION__
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &quot;intermezzo_fs.h&quot;
macro_line|#include &quot;intermezzo_psdev.h&quot;
DECL|function|presto_relock_sem
r_static
r_inline
r_void
id|presto_relock_sem
c_func
(paren
r_struct
id|inode
op_star
id|dir
)paren
(brace
multiline_comment|/* the lock from sys_mkdir / lookup_create */
id|down
c_func
(paren
op_amp
id|dir-&gt;i_sem
)paren
suffix:semicolon
multiline_comment|/* the rest is done by the do_{create,mkdir, ...} */
)brace
DECL|function|presto_relock_other
r_static
r_inline
r_void
id|presto_relock_other
c_func
(paren
r_struct
id|inode
op_star
id|dir
)paren
(brace
multiline_comment|/* vfs_mkdir locks */
singleline_comment|//        down(&amp;dir-&gt;i_zombie);
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|presto_fulllock
r_static
r_inline
r_void
id|presto_fulllock
c_func
(paren
r_struct
id|inode
op_star
id|dir
)paren
(brace
multiline_comment|/* the lock from sys_mkdir / lookup_create */
id|down
c_func
(paren
op_amp
id|dir-&gt;i_sem
)paren
suffix:semicolon
multiline_comment|/* vfs_mkdir locks */
singleline_comment|//        down(&amp;dir-&gt;i_zombie);
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|presto_unlock
r_static
r_inline
r_void
id|presto_unlock
c_func
(paren
r_struct
id|inode
op_star
id|dir
)paren
(brace
multiline_comment|/* vfs_mkdir locks */
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
singleline_comment|//        up(&amp;dir-&gt;i_zombie);
multiline_comment|/* the lock from sys_mkdir / lookup_create */
id|up
c_func
(paren
op_amp
id|dir-&gt;i_sem
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * these are initialized in super.c&n; */
r_extern
r_int
id|presto_permission
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_int
id|mask
)paren
suffix:semicolon
DECL|variable|izo_authorized_uid
r_static
r_int
id|izo_authorized_uid
op_assign
l_int|0
suffix:semicolon
DECL|function|izo_dentry_is_ilookup
r_int
id|izo_dentry_is_ilookup
c_func
(paren
r_struct
id|dentry
op_star
id|dentry
comma
id|ino_t
op_star
id|id
comma
r_int
r_int
op_star
id|generation
)paren
(brace
r_char
id|tmpname
(braket
l_int|64
)braket
suffix:semicolon
r_char
op_star
id|next
suffix:semicolon
id|ENTRY
suffix:semicolon
multiline_comment|/* prefix is 7 characters: &squot;...ino:&squot; */
r_if
c_cond
(paren
id|dentry-&gt;d_name.len
template_param
l_int|64
op_logical_or
id|memcmp
c_func
(paren
id|dentry-&gt;d_name.name
comma
id|PRESTO_ILOOKUP_MAGIC
comma
l_int|7
)paren
op_ne
l_int|0
)paren
(brace
id|EXIT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|tmpname
comma
id|dentry-&gt;d_name.name
op_plus
l_int|7
comma
id|dentry-&gt;d_name.len
op_minus
l_int|7
)paren
suffix:semicolon
op_star
(paren
id|tmpname
op_plus
id|dentry-&gt;d_name.len
op_minus
l_int|7
)paren
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
multiline_comment|/* name is of the form ...ino:&lt;inode number&gt;:&lt;generation&gt; */
op_star
id|id
op_assign
id|simple_strtoul
c_func
(paren
id|tmpname
comma
op_amp
id|next
comma
l_int|16
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|next
op_eq
id|PRESTO_ILOOKUP_SEP
)paren
(brace
op_star
id|generation
op_assign
id|simple_strtoul
c_func
(paren
id|next
op_plus
l_int|1
comma
l_int|0
comma
l_int|16
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_INODE
comma
l_string|&quot;ino string: %s, Id = %lx (%lu), &quot;
l_string|&quot;generation %x (%d)&bslash;n&quot;
comma
id|tmpname
comma
op_star
id|id
comma
op_star
id|id
comma
op_star
id|generation
comma
op_star
id|generation
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|EXIT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
)brace
DECL|function|presto_tmpfs_ilookup
r_struct
id|dentry
op_star
id|presto_tmpfs_ilookup
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|dentry
op_star
id|dentry
comma
id|ino_t
id|ino
comma
r_int
r_int
id|generation
)paren
(brace
r_return
id|dentry
suffix:semicolon
)brace
DECL|function|presto_can_ilookup
r_inline
r_int
id|presto_can_ilookup
c_func
(paren
r_void
)paren
(brace
r_return
(paren
id|current-&gt;euid
op_eq
id|izo_authorized_uid
op_logical_or
id|capable
c_func
(paren
id|CAP_DAC_READ_SEARCH
)paren
)paren
suffix:semicolon
)brace
DECL|function|presto_iget_ilookup
r_struct
id|dentry
op_star
id|presto_iget_ilookup
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|dentry
op_star
id|dentry
comma
id|ino_t
id|ino
comma
r_int
r_int
id|generation
)paren
(brace
r_struct
id|inode
op_star
id|inode
suffix:semicolon
r_int
id|error
suffix:semicolon
id|ENTRY
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|presto_can_ilookup
c_func
(paren
)paren
)paren
(brace
id|CERROR
c_func
(paren
l_string|&quot;ilookup denied: euid %u, authorized_uid %u&bslash;n&quot;
comma
id|current-&gt;euid
comma
id|izo_authorized_uid
)paren
suffix:semicolon
r_return
id|ERR_PTR
c_func
(paren
op_minus
id|EPERM
)paren
suffix:semicolon
)brace
id|error
op_assign
op_minus
id|ENOENT
suffix:semicolon
id|inode
op_assign
id|iget
c_func
(paren
id|dir-&gt;i_sb
comma
id|ino
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|inode
)paren
(brace
id|CERROR
c_func
(paren
l_string|&quot;fatal: NULL inode ino %lu&bslash;n&quot;
comma
id|ino
)paren
suffix:semicolon
r_goto
id|cleanup_iput
suffix:semicolon
)brace
r_if
c_cond
(paren
id|is_bad_inode
c_func
(paren
id|inode
)paren
op_logical_or
id|inode-&gt;i_nlink
op_eq
l_int|0
)paren
(brace
id|CERROR
c_func
(paren
l_string|&quot;fatal: bad inode ino %lu, links %d&bslash;n&quot;
comma
id|ino
comma
id|inode-&gt;i_nlink
)paren
suffix:semicolon
r_goto
id|cleanup_iput
suffix:semicolon
)brace
r_if
c_cond
(paren
id|inode-&gt;i_generation
op_ne
id|generation
)paren
(brace
id|CERROR
c_func
(paren
l_string|&quot;fatal: bad generation %u (want %u)&bslash;n&quot;
comma
id|inode-&gt;i_generation
comma
id|generation
)paren
suffix:semicolon
r_goto
id|cleanup_iput
suffix:semicolon
)brace
id|d_instantiate
c_func
(paren
id|dentry
comma
id|inode
)paren
suffix:semicolon
id|dentry-&gt;d_flags
op_or_assign
id|DCACHE_DISCONNECTED
suffix:semicolon
multiline_comment|/* NFS hack */
id|EXIT
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
id|cleanup_iput
suffix:colon
r_if
c_cond
(paren
id|inode
)paren
id|iput
c_func
(paren
id|inode
)paren
suffix:semicolon
r_return
id|ERR_PTR
c_func
(paren
id|error
)paren
suffix:semicolon
)brace
DECL|function|presto_add_ilookup_dentry
r_struct
id|dentry
op_star
id|presto_add_ilookup_dentry
c_func
(paren
r_struct
id|dentry
op_star
id|parent
comma
r_struct
id|dentry
op_star
id|real
)paren
(brace
r_struct
id|inode
op_star
id|inode
op_assign
id|real-&gt;d_inode
suffix:semicolon
r_struct
id|dentry
op_star
id|de
suffix:semicolon
r_char
id|buf
(braket
l_int|32
)braket
suffix:semicolon
r_char
op_star
id|ptr
op_assign
id|buf
suffix:semicolon
r_struct
id|dentry
op_star
id|inodir
suffix:semicolon
r_struct
id|presto_dentry_data
op_star
id|dd
suffix:semicolon
id|inodir
op_assign
id|lookup_one_len
c_func
(paren
l_string|&quot;..iopen..&quot;
comma
id|parent
comma
id|strlen
c_func
(paren
l_string|&quot;..iopen..&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|inodir
op_logical_or
id|IS_ERR
c_func
(paren
id|inodir
)paren
op_logical_or
op_logical_neg
id|inodir-&gt;d_inode
)paren
(brace
id|CERROR
c_func
(paren
l_string|&quot;%s: bad ..iopen.. lookup&bslash;n&quot;
comma
id|__FUNCTION__
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|inodir-&gt;d_inode-&gt;i_op
op_assign
op_amp
id|presto_dir_iops
suffix:semicolon
id|snprintf
c_func
(paren
id|ptr
comma
l_int|32
comma
l_string|&quot;...ino:%lx:%x&quot;
comma
id|inode-&gt;i_ino
comma
id|inode-&gt;i_generation
)paren
suffix:semicolon
id|de
op_assign
id|lookup_one_len
c_func
(paren
id|ptr
comma
id|inodir
comma
id|strlen
c_func
(paren
id|ptr
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|de
op_logical_or
id|IS_ERR
c_func
(paren
id|de
)paren
)paren
(brace
id|CERROR
c_func
(paren
l_string|&quot;%s: bad ...ino lookup %ld&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|PTR_ERR
c_func
(paren
id|de
)paren
)paren
suffix:semicolon
id|dput
c_func
(paren
id|inodir
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|dd
op_assign
id|presto_d2d
c_func
(paren
id|real
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dd
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* already exists */
r_if
c_cond
(paren
id|de-&gt;d_inode
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
macro_line|#if 0 
r_if
c_cond
(paren
id|de-&gt;d_inode
op_ne
id|inode
)paren
(brace
id|CERROR
c_func
(paren
l_string|&quot;XX de-&gt;d_inode %ld, inode %ld&bslash;n&quot;
comma
id|de-&gt;d_inode-&gt;i_ino
comma
id|inode-&gt;i_ino
)paren
suffix:semicolon
id|BUG
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dd-&gt;dd_inodentry
)paren
(brace
id|CERROR
c_func
(paren
l_string|&quot;inodentry exists %ld &bslash;n&quot;
comma
id|inode-&gt;i_ino
)paren
suffix:semicolon
id|BUG
c_func
(paren
)paren
suffix:semicolon
)brace
id|dput
c_func
(paren
id|inodir
)paren
suffix:semicolon
r_return
id|de
suffix:semicolon
)brace
macro_line|#endif 
r_if
c_cond
(paren
id|presto_d2d
c_func
(paren
id|de
)paren
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|inode-&gt;i_count
)paren
suffix:semicolon
id|de-&gt;d_op
op_assign
op_amp
id|presto_dentry_ops
suffix:semicolon
id|d_add
c_func
(paren
id|de
comma
id|inode
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|de-&gt;d_op
)paren
id|CERROR
c_func
(paren
l_string|&quot;DD: no ops dentry %p, dd %p&bslash;n&quot;
comma
id|de
comma
id|dd
)paren
suffix:semicolon
id|dd-&gt;dd_inodentry
op_assign
id|de
suffix:semicolon
id|dd-&gt;dd_count
op_increment
suffix:semicolon
id|de-&gt;d_fsdata
op_assign
id|dd
suffix:semicolon
id|dput
c_func
(paren
id|inodir
)paren
suffix:semicolon
r_return
id|de
suffix:semicolon
)brace
DECL|function|presto_lookup
r_struct
id|dentry
op_star
id|presto_lookup
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|dentry
op_star
id|dentry
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_struct
id|dentry
op_star
id|de
suffix:semicolon
r_struct
id|presto_cache
op_star
id|cache
suffix:semicolon
r_int
id|minor
suffix:semicolon
id|ino_t
id|ino
suffix:semicolon
r_int
r_int
id|generation
suffix:semicolon
r_struct
id|inode_operations
op_star
id|iops
suffix:semicolon
r_int
id|is_ilookup
op_assign
l_int|0
suffix:semicolon
id|ENTRY
suffix:semicolon
id|cache
op_assign
id|presto_get_cache
c_func
(paren
id|dir
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cache
op_eq
l_int|NULL
)paren
(brace
id|CERROR
c_func
(paren
l_string|&quot;InterMezzo BUG: no cache in presto_lookup &quot;
l_string|&quot;(dir ino: %ld)!&bslash;n&quot;
comma
id|dir-&gt;i_ino
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|minor
op_assign
id|presto_c2m
c_func
(paren
id|cache
)paren
suffix:semicolon
id|iops
op_assign
id|filter_c2cdiops
c_func
(paren
id|cache-&gt;cache_filter
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|iops
op_logical_or
op_logical_neg
id|iops-&gt;lookup
)paren
(brace
id|CERROR
c_func
(paren
l_string|&quot;InterMezzo BUG: filesystem has no lookup&bslash;n&quot;
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|CDEBUG
c_func
(paren
id|D_CACHE
comma
l_string|&quot;dentry %p, dir ino: %ld, name: %*s, islento: %d&bslash;n&quot;
comma
id|dentry
comma
id|dir-&gt;i_ino
comma
id|dentry-&gt;d_name.len
comma
id|dentry-&gt;d_name.name
comma
id|ISLENTO
c_func
(paren
id|minor
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dentry-&gt;d_fsdata
)paren
id|CERROR
c_func
(paren
l_string|&quot;DD -- BAD dentry %p has data&bslash;n&quot;
comma
id|dentry
)paren
suffix:semicolon
id|dentry-&gt;d_fsdata
op_assign
l_int|NULL
suffix:semicolon
macro_line|#if 0
r_if
c_cond
(paren
id|ext2_check_for_iopen
c_func
(paren
id|dir
comma
id|dentry
)paren
)paren
id|de
op_assign
l_int|NULL
suffix:semicolon
r_else
(brace
macro_line|#endif
r_if
c_cond
(paren
id|izo_dentry_is_ilookup
c_func
(paren
id|dentry
comma
op_amp
id|ino
comma
op_amp
id|generation
)paren
)paren
(brace
id|de
op_assign
id|cache-&gt;cache_filter-&gt;o_trops-&gt;tr_ilookup
(paren
id|dir
comma
id|dentry
comma
id|ino
comma
id|generation
)paren
suffix:semicolon
id|is_ilookup
op_assign
l_int|1
suffix:semicolon
)brace
r_else
id|de
op_assign
id|iops
op_member_access_from_pointer
id|lookup
c_func
(paren
id|dir
comma
id|dentry
)paren
suffix:semicolon
macro_line|#if 0
)brace
macro_line|#endif
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|de
)paren
)paren
(brace
id|CERROR
c_func
(paren
l_string|&quot;dentry lookup error %ld&bslash;n&quot;
comma
id|PTR_ERR
c_func
(paren
id|de
)paren
)paren
suffix:semicolon
r_return
id|de
suffix:semicolon
)brace
multiline_comment|/* some file systems have no read_inode: set methods here */
r_if
c_cond
(paren
id|dentry-&gt;d_inode
)paren
id|presto_set_ops
c_func
(paren
id|dentry-&gt;d_inode
comma
id|cache-&gt;cache_filter
)paren
suffix:semicolon
id|filter_setup_dentry_ops
c_func
(paren
id|cache-&gt;cache_filter
comma
id|dentry-&gt;d_op
comma
op_amp
id|presto_dentry_ops
)paren
suffix:semicolon
id|dentry-&gt;d_op
op_assign
id|filter_c2udops
c_func
(paren
id|cache-&gt;cache_filter
)paren
suffix:semicolon
multiline_comment|/* In lookup we will tolerate EROFS return codes from presto_set_dd&n;         * to placate NFS. EROFS indicates that a fileset was not found but&n;         * we should still be able to continue through a lookup.&n;         * Anything else is a hard error and must be returned to VFS. */
r_if
c_cond
(paren
op_logical_neg
id|is_ilookup
)paren
id|rc
op_assign
id|presto_set_dd
c_func
(paren
id|dentry
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_logical_and
id|rc
op_ne
op_minus
id|EROFS
)paren
(brace
id|CERROR
c_func
(paren
l_string|&quot;presto_set_dd failed (dir %ld, name %*s): %d&bslash;n&quot;
comma
id|dir-&gt;i_ino
comma
id|dentry-&gt;d_name.len
comma
id|dentry-&gt;d_name.name
comma
id|rc
)paren
suffix:semicolon
r_return
id|ERR_PTR
c_func
(paren
id|rc
)paren
suffix:semicolon
)brace
id|EXIT
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|presto_check_set_fsdata
r_static
r_inline
r_int
id|presto_check_set_fsdata
(paren
r_struct
id|dentry
op_star
id|de
)paren
(brace
r_if
c_cond
(paren
id|presto_d2d
c_func
(paren
id|de
)paren
op_eq
l_int|NULL
)paren
(brace
macro_line|#ifdef PRESTO_NO_NFS
id|CERROR
c_func
(paren
l_string|&quot;dentry without fsdata: %p: %*s&bslash;n&quot;
comma
id|de
comma
id|de-&gt;d_name.len
comma
id|de-&gt;d_name.name
)paren
suffix:semicolon
id|BUG
c_func
(paren
)paren
suffix:semicolon
macro_line|#endif
r_return
id|presto_set_dd
(paren
id|de
)paren
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|presto_setattr
r_int
id|presto_setattr
c_func
(paren
r_struct
id|dentry
op_star
id|de
comma
r_struct
id|iattr
op_star
id|iattr
)paren
(brace
r_int
id|error
suffix:semicolon
r_struct
id|presto_cache
op_star
id|cache
suffix:semicolon
r_struct
id|presto_file_set
op_star
id|fset
suffix:semicolon
r_struct
id|lento_vfs_context
id|info
op_assign
(brace
l_int|0
comma
(brace
l_int|0
)brace
comma
l_int|0
)brace
suffix:semicolon
id|ENTRY
suffix:semicolon
id|error
op_assign
id|presto_prep
c_func
(paren
id|de
comma
op_amp
id|cache
comma
op_amp
id|fset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|iattr-&gt;ia_valid
)paren
id|CDEBUG
c_func
(paren
id|D_INODE
comma
l_string|&quot;presto_setattr: iattr is not valid&bslash;n&quot;
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_INODE
comma
l_string|&quot;valid %#x, mode %#o, uid %u, gid %u, size %Lu, &quot;
l_string|&quot;atime %lu mtime %lu ctime %lu flags %d&bslash;n&quot;
comma
id|iattr-&gt;ia_valid
comma
id|iattr-&gt;ia_mode
comma
id|iattr-&gt;ia_uid
comma
id|iattr-&gt;ia_gid
comma
id|iattr-&gt;ia_size
comma
id|iattr-&gt;ia_atime.tv_sec
comma
id|iattr-&gt;ia_mtime.tv_sec
comma
id|iattr-&gt;ia_ctime.tv_sec
comma
id|iattr-&gt;ia_attr_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|presto_get_permit
c_func
(paren
id|de-&gt;d_inode
)paren
OL
l_int|0
)paren
(brace
id|EXIT
suffix:semicolon
r_return
op_minus
id|EROFS
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|ISLENTO
c_func
(paren
id|presto_c2m
c_func
(paren
id|cache
)paren
)paren
)paren
id|info.flags
op_assign
id|LENTO_FL_KML
suffix:semicolon
id|info.flags
op_or_assign
id|LENTO_FL_IGNORE_TIME
suffix:semicolon
id|error
op_assign
id|presto_do_setattr
c_func
(paren
id|fset
comma
id|de
comma
id|iattr
comma
op_amp
id|info
)paren
suffix:semicolon
id|presto_put_permit
c_func
(paren
id|de-&gt;d_inode
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
multiline_comment|/*&n; *  Now the meat: the fs operations that require journaling&n; *&n; *&n; *  XXX: some of these need modifications for hierarchical filesets&n; */
DECL|function|presto_prep
r_int
id|presto_prep
c_func
(paren
r_struct
id|dentry
op_star
id|dentry
comma
r_struct
id|presto_cache
op_star
op_star
id|cache
comma
r_struct
id|presto_file_set
op_star
op_star
id|fset
)paren
(brace
r_int
id|rc
suffix:semicolon
multiline_comment|/* NFS might pass us dentries which have not gone through lookup.&n;         * Test and set d_fsdata for such dentries&n;         */
id|rc
op_assign
id|presto_check_set_fsdata
(paren
id|dentry
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
op_star
id|fset
op_assign
id|presto_fset
c_func
(paren
id|dentry
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|fset
op_eq
l_int|NULL
)paren
(brace
id|CERROR
c_func
(paren
l_string|&quot;No file set for dentry at %p: %*s&bslash;n&quot;
comma
id|dentry
comma
id|dentry-&gt;d_name.len
comma
id|dentry-&gt;d_name.name
)paren
suffix:semicolon
r_return
op_minus
id|EROFS
suffix:semicolon
)brace
op_star
id|cache
op_assign
(paren
op_star
id|fset
)paren
op_member_access_from_pointer
id|fset_cache
suffix:semicolon
r_if
c_cond
(paren
op_star
id|cache
op_eq
l_int|NULL
)paren
(brace
id|CERROR
c_func
(paren
l_string|&quot;PRESTO: BAD, BAD: cannot find cache&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EBADF
suffix:semicolon
)brace
id|CDEBUG
c_func
(paren
id|D_PIOCTL
comma
l_string|&quot;---&gt; cache flags %x, fset flags %x&bslash;n&quot;
comma
(paren
op_star
id|cache
)paren
op_member_access_from_pointer
id|cache_flags
comma
(paren
op_star
id|fset
)paren
op_member_access_from_pointer
id|fset_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|presto_is_read_only
c_func
(paren
op_star
id|fset
)paren
)paren
(brace
id|CERROR
c_func
(paren
l_string|&quot;PRESTO: cannot modify read-only fileset, minor %d.&bslash;n&quot;
comma
id|presto_c2m
c_func
(paren
op_star
id|cache
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EROFS
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|presto_create
r_static
r_int
id|presto_create
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|dentry
op_star
id|dentry
comma
r_int
id|mode
)paren
(brace
r_int
id|error
suffix:semicolon
r_struct
id|presto_cache
op_star
id|cache
suffix:semicolon
r_struct
id|dentry
op_star
id|parent
op_assign
id|dentry-&gt;d_parent
suffix:semicolon
r_struct
id|lento_vfs_context
id|info
suffix:semicolon
r_struct
id|presto_file_set
op_star
id|fset
suffix:semicolon
id|ENTRY
suffix:semicolon
id|error
op_assign
id|presto_check_set_fsdata
c_func
(paren
id|dentry
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|error
op_assign
id|presto_prep
c_func
(paren
id|dentry-&gt;d_parent
comma
op_amp
id|cache
comma
op_amp
id|fset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|presto_unlock
c_func
(paren
id|dir
)paren
suffix:semicolon
multiline_comment|/* Does blocking and non-blocking behavious need to be &n;           checked for.  Without blocking (return 1), the permit&n;           was acquired without reintegration&n;        */
r_if
c_cond
(paren
id|presto_get_permit
c_func
(paren
id|dir
)paren
OL
l_int|0
)paren
(brace
id|EXIT
suffix:semicolon
id|presto_fulllock
c_func
(paren
id|dir
)paren
suffix:semicolon
r_return
op_minus
id|EROFS
suffix:semicolon
)brace
id|presto_relock_sem
c_func
(paren
id|dir
)paren
suffix:semicolon
id|parent
op_assign
id|dentry-&gt;d_parent
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|info
comma
l_int|0
comma
r_sizeof
(paren
id|info
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ISLENTO
c_func
(paren
id|presto_c2m
c_func
(paren
id|cache
)paren
)paren
)paren
id|info.flags
op_assign
id|LENTO_FL_KML
suffix:semicolon
id|info.flags
op_or_assign
id|LENTO_FL_IGNORE_TIME
suffix:semicolon
id|error
op_assign
id|presto_do_create
c_func
(paren
id|fset
comma
id|parent
comma
id|dentry
comma
id|mode
comma
op_amp
id|info
)paren
suffix:semicolon
id|presto_relock_other
c_func
(paren
id|dir
)paren
suffix:semicolon
id|presto_put_permit
c_func
(paren
id|dir
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|function|presto_link
r_static
r_int
id|presto_link
c_func
(paren
r_struct
id|dentry
op_star
id|old_dentry
comma
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|dentry
op_star
id|new_dentry
)paren
(brace
r_int
id|error
suffix:semicolon
r_struct
id|presto_cache
op_star
id|cache
comma
op_star
id|new_cache
suffix:semicolon
r_struct
id|presto_file_set
op_star
id|fset
comma
op_star
id|new_fset
suffix:semicolon
r_struct
id|dentry
op_star
id|parent
op_assign
id|new_dentry-&gt;d_parent
suffix:semicolon
r_struct
id|lento_vfs_context
id|info
suffix:semicolon
id|ENTRY
suffix:semicolon
id|error
op_assign
id|presto_prep
c_func
(paren
id|old_dentry
comma
op_amp
id|cache
comma
op_amp
id|fset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|error
op_assign
id|presto_check_set_fsdata
c_func
(paren
id|new_dentry
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|error
op_assign
id|presto_prep
c_func
(paren
id|new_dentry-&gt;d_parent
comma
op_amp
id|new_cache
comma
op_amp
id|new_fset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fset
op_ne
id|new_fset
)paren
(brace
id|EXIT
suffix:semicolon
r_return
op_minus
id|EXDEV
suffix:semicolon
)brace
id|presto_unlock
c_func
(paren
id|dir
)paren
suffix:semicolon
r_if
c_cond
(paren
id|presto_get_permit
c_func
(paren
id|old_dentry-&gt;d_inode
)paren
OL
l_int|0
)paren
(brace
id|EXIT
suffix:semicolon
id|presto_fulllock
c_func
(paren
id|dir
)paren
suffix:semicolon
r_return
op_minus
id|EROFS
suffix:semicolon
)brace
r_if
c_cond
(paren
id|presto_get_permit
c_func
(paren
id|dir
)paren
OL
l_int|0
)paren
(brace
id|EXIT
suffix:semicolon
id|presto_fulllock
c_func
(paren
id|dir
)paren
suffix:semicolon
r_return
op_minus
id|EROFS
suffix:semicolon
)brace
id|presto_relock_sem
c_func
(paren
id|dir
)paren
suffix:semicolon
id|parent
op_assign
id|new_dentry-&gt;d_parent
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|info
comma
l_int|0
comma
r_sizeof
(paren
id|info
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ISLENTO
c_func
(paren
id|presto_c2m
c_func
(paren
id|cache
)paren
)paren
)paren
id|info.flags
op_assign
id|LENTO_FL_KML
suffix:semicolon
id|info.flags
op_or_assign
id|LENTO_FL_IGNORE_TIME
suffix:semicolon
id|error
op_assign
id|presto_do_link
c_func
(paren
id|fset
comma
id|old_dentry
comma
id|parent
comma
id|new_dentry
comma
op_amp
id|info
)paren
suffix:semicolon
macro_line|#if 0
multiline_comment|/* XXX for links this is not right */
r_if
c_cond
(paren
id|cache-&gt;cache_filter-&gt;o_trops-&gt;tr_add_ilookup
)paren
(brace
r_struct
id|dentry
op_star
id|d
suffix:semicolon
id|d
op_assign
id|cache-&gt;cache_filter-&gt;o_trops-&gt;tr_add_ilookup
(paren
id|dir-&gt;i_sb-&gt;s_root
comma
id|new_dentry
comma
l_int|1
)paren
suffix:semicolon
)brace
macro_line|#endif 
id|presto_relock_other
c_func
(paren
id|dir
)paren
suffix:semicolon
id|presto_put_permit
c_func
(paren
id|dir
)paren
suffix:semicolon
id|presto_put_permit
c_func
(paren
id|old_dentry-&gt;d_inode
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|function|presto_mkdir
r_static
r_int
id|presto_mkdir
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|dentry
op_star
id|dentry
comma
r_int
id|mode
)paren
(brace
r_int
id|error
suffix:semicolon
r_struct
id|presto_file_set
op_star
id|fset
suffix:semicolon
r_struct
id|presto_cache
op_star
id|cache
suffix:semicolon
r_struct
id|dentry
op_star
id|parent
op_assign
id|dentry-&gt;d_parent
suffix:semicolon
r_struct
id|lento_vfs_context
id|info
suffix:semicolon
id|ENTRY
suffix:semicolon
id|error
op_assign
id|presto_check_set_fsdata
c_func
(paren
id|dentry
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|error
op_assign
id|presto_prep
c_func
(paren
id|dentry-&gt;d_parent
comma
op_amp
id|cache
comma
op_amp
id|fset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|presto_unlock
c_func
(paren
id|dir
)paren
suffix:semicolon
r_if
c_cond
(paren
id|presto_get_permit
c_func
(paren
id|dir
)paren
OL
l_int|0
)paren
(brace
id|EXIT
suffix:semicolon
id|presto_fulllock
c_func
(paren
id|dir
)paren
suffix:semicolon
r_return
op_minus
id|EROFS
suffix:semicolon
)brace
id|memset
c_func
(paren
op_amp
id|info
comma
l_int|0
comma
r_sizeof
(paren
id|info
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ISLENTO
c_func
(paren
id|presto_c2m
c_func
(paren
id|cache
)paren
)paren
)paren
id|info.flags
op_assign
id|LENTO_FL_KML
suffix:semicolon
id|info.flags
op_or_assign
id|LENTO_FL_IGNORE_TIME
suffix:semicolon
id|presto_relock_sem
c_func
(paren
id|dir
)paren
suffix:semicolon
id|parent
op_assign
id|dentry-&gt;d_parent
suffix:semicolon
id|error
op_assign
id|presto_do_mkdir
c_func
(paren
id|fset
comma
id|parent
comma
id|dentry
comma
id|mode
comma
op_amp
id|info
)paren
suffix:semicolon
id|presto_relock_other
c_func
(paren
id|dir
)paren
suffix:semicolon
id|presto_put_permit
c_func
(paren
id|dir
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|function|presto_symlink
r_static
r_int
id|presto_symlink
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|dentry
op_star
id|dentry
comma
r_const
r_char
op_star
id|name
)paren
(brace
r_int
id|error
suffix:semicolon
r_struct
id|presto_cache
op_star
id|cache
suffix:semicolon
r_struct
id|presto_file_set
op_star
id|fset
suffix:semicolon
r_struct
id|dentry
op_star
id|parent
op_assign
id|dentry-&gt;d_parent
suffix:semicolon
r_struct
id|lento_vfs_context
id|info
suffix:semicolon
id|ENTRY
suffix:semicolon
id|error
op_assign
id|presto_check_set_fsdata
c_func
(paren
id|dentry
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|error
op_assign
id|presto_prep
c_func
(paren
id|dentry-&gt;d_parent
comma
op_amp
id|cache
comma
op_amp
id|fset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|presto_unlock
c_func
(paren
id|dir
)paren
suffix:semicolon
r_if
c_cond
(paren
id|presto_get_permit
c_func
(paren
id|dir
)paren
OL
l_int|0
)paren
(brace
id|EXIT
suffix:semicolon
id|presto_fulllock
c_func
(paren
id|dir
)paren
suffix:semicolon
r_return
op_minus
id|EROFS
suffix:semicolon
)brace
id|presto_relock_sem
c_func
(paren
id|dir
)paren
suffix:semicolon
id|parent
op_assign
id|dentry-&gt;d_parent
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|info
comma
l_int|0
comma
r_sizeof
(paren
id|info
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ISLENTO
c_func
(paren
id|presto_c2m
c_func
(paren
id|cache
)paren
)paren
)paren
id|info.flags
op_assign
id|LENTO_FL_KML
suffix:semicolon
id|info.flags
op_or_assign
id|LENTO_FL_IGNORE_TIME
suffix:semicolon
id|error
op_assign
id|presto_do_symlink
c_func
(paren
id|fset
comma
id|parent
comma
id|dentry
comma
id|name
comma
op_amp
id|info
)paren
suffix:semicolon
id|presto_relock_other
c_func
(paren
id|dir
)paren
suffix:semicolon
id|presto_put_permit
c_func
(paren
id|dir
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|function|presto_unlink
r_int
id|presto_unlink
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|dentry
op_star
id|dentry
)paren
(brace
r_int
id|error
suffix:semicolon
r_struct
id|presto_cache
op_star
id|cache
suffix:semicolon
r_struct
id|presto_file_set
op_star
id|fset
suffix:semicolon
r_struct
id|dentry
op_star
id|parent
op_assign
id|dentry-&gt;d_parent
suffix:semicolon
r_struct
id|lento_vfs_context
id|info
suffix:semicolon
id|ENTRY
suffix:semicolon
id|error
op_assign
id|presto_check_set_fsdata
c_func
(paren
id|dentry
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|error
op_assign
id|presto_prep
c_func
(paren
id|dentry-&gt;d_parent
comma
op_amp
id|cache
comma
op_amp
id|fset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|presto_unlock
c_func
(paren
id|dir
)paren
suffix:semicolon
r_if
c_cond
(paren
id|presto_get_permit
c_func
(paren
id|dir
)paren
OL
l_int|0
)paren
(brace
id|EXIT
suffix:semicolon
id|presto_fulllock
c_func
(paren
id|dir
)paren
suffix:semicolon
r_return
op_minus
id|EROFS
suffix:semicolon
)brace
id|presto_relock_sem
c_func
(paren
id|dir
)paren
suffix:semicolon
id|parent
op_assign
id|dentry-&gt;d_parent
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|info
comma
l_int|0
comma
r_sizeof
(paren
id|info
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ISLENTO
c_func
(paren
id|presto_c2m
c_func
(paren
id|cache
)paren
)paren
)paren
id|info.flags
op_assign
id|LENTO_FL_KML
suffix:semicolon
id|info.flags
op_or_assign
id|LENTO_FL_IGNORE_TIME
suffix:semicolon
id|error
op_assign
id|presto_do_unlink
c_func
(paren
id|fset
comma
id|parent
comma
id|dentry
comma
op_amp
id|info
)paren
suffix:semicolon
id|presto_relock_other
c_func
(paren
id|dir
)paren
suffix:semicolon
id|presto_put_permit
c_func
(paren
id|dir
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|function|presto_rmdir
r_static
r_int
id|presto_rmdir
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|dentry
op_star
id|dentry
)paren
(brace
r_int
id|error
suffix:semicolon
r_struct
id|presto_cache
op_star
id|cache
suffix:semicolon
r_struct
id|presto_file_set
op_star
id|fset
suffix:semicolon
r_struct
id|dentry
op_star
id|parent
op_assign
id|dentry-&gt;d_parent
suffix:semicolon
r_struct
id|lento_vfs_context
id|info
suffix:semicolon
id|ENTRY
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_FILE
comma
l_string|&quot;prepping presto&bslash;n&quot;
)paren
suffix:semicolon
id|error
op_assign
id|presto_check_set_fsdata
c_func
(paren
id|dentry
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|error
op_assign
id|presto_prep
c_func
(paren
id|dentry-&gt;d_parent
comma
op_amp
id|cache
comma
op_amp
id|fset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|CDEBUG
c_func
(paren
id|D_FILE
comma
l_string|&quot;unlocking&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* We need to dget() before the dput in double_unlock, to ensure we&n;         * still have dentry references.  double_lock doesn&squot;t do dget for us.&n;         */
r_if
c_cond
(paren
id|d_unhashed
c_func
(paren
id|dentry
)paren
)paren
id|d_rehash
c_func
(paren
id|dentry
)paren
suffix:semicolon
singleline_comment|//        double_up(&amp;dir-&gt;i_zombie, &amp;dentry-&gt;d_inode-&gt;i_zombie);
id|up
c_func
(paren
op_amp
id|dentry-&gt;d_inode-&gt;i_sem
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|dir-&gt;i_sem
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_FILE
comma
l_string|&quot;getting permit&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|presto_get_permit
c_func
(paren
id|parent-&gt;d_inode
)paren
OL
l_int|0
)paren
(brace
id|EXIT
suffix:semicolon
id|down
c_func
(paren
op_amp
id|dir-&gt;i_sem
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|dentry-&gt;d_inode-&gt;i_sem
)paren
suffix:semicolon
singleline_comment|//                double_down(&amp;dir-&gt;i_sem, &amp;dentry-&gt;d_inode-&gt;i_sem);
singleline_comment|//                double_down(&amp;dir-&gt;i_zombie, &amp;dentry-&gt;d_inode-&gt;i_zombie);
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
r_return
op_minus
id|EROFS
suffix:semicolon
)brace
id|CDEBUG
c_func
(paren
id|D_FILE
comma
l_string|&quot;locking&bslash;n&quot;
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|dir-&gt;i_sem
)paren
suffix:semicolon
id|down
c_func
(paren
op_amp
id|dentry-&gt;d_inode-&gt;i_sem
)paren
suffix:semicolon
id|parent
op_assign
id|dentry-&gt;d_parent
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|info
comma
l_int|0
comma
r_sizeof
(paren
id|info
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ISLENTO
c_func
(paren
id|presto_c2m
c_func
(paren
id|cache
)paren
)paren
)paren
id|info.flags
op_assign
id|LENTO_FL_KML
suffix:semicolon
id|info.flags
op_or_assign
id|LENTO_FL_IGNORE_TIME
suffix:semicolon
id|error
op_assign
id|presto_do_rmdir
c_func
(paren
id|fset
comma
id|parent
comma
id|dentry
comma
op_amp
id|info
)paren
suffix:semicolon
id|presto_put_permit
c_func
(paren
id|parent-&gt;d_inode
)paren
suffix:semicolon
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|function|presto_mknod
r_static
r_int
id|presto_mknod
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|dentry
op_star
id|dentry
comma
r_int
id|mode
comma
id|dev_t
id|rdev
)paren
(brace
r_int
id|error
suffix:semicolon
r_struct
id|presto_cache
op_star
id|cache
suffix:semicolon
r_struct
id|presto_file_set
op_star
id|fset
suffix:semicolon
r_struct
id|dentry
op_star
id|parent
op_assign
id|dentry-&gt;d_parent
suffix:semicolon
r_struct
id|lento_vfs_context
id|info
suffix:semicolon
id|ENTRY
suffix:semicolon
id|error
op_assign
id|presto_check_set_fsdata
c_func
(paren
id|dentry
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|error
op_assign
id|presto_prep
c_func
(paren
id|dentry-&gt;d_parent
comma
op_amp
id|cache
comma
op_amp
id|fset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|presto_unlock
c_func
(paren
id|dir
)paren
suffix:semicolon
r_if
c_cond
(paren
id|presto_get_permit
c_func
(paren
id|dir
)paren
OL
l_int|0
)paren
(brace
id|EXIT
suffix:semicolon
id|presto_fulllock
c_func
(paren
id|dir
)paren
suffix:semicolon
r_return
op_minus
id|EROFS
suffix:semicolon
)brace
id|presto_relock_sem
c_func
(paren
id|dir
)paren
suffix:semicolon
id|parent
op_assign
id|dentry-&gt;d_parent
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|info
comma
l_int|0
comma
r_sizeof
(paren
id|info
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ISLENTO
c_func
(paren
id|presto_c2m
c_func
(paren
id|cache
)paren
)paren
)paren
id|info.flags
op_assign
id|LENTO_FL_KML
suffix:semicolon
id|info.flags
op_or_assign
id|LENTO_FL_IGNORE_TIME
suffix:semicolon
id|error
op_assign
id|presto_do_mknod
c_func
(paren
id|fset
comma
id|parent
comma
id|dentry
comma
id|mode
comma
id|rdev
comma
op_amp
id|info
)paren
suffix:semicolon
id|presto_relock_other
c_func
(paren
id|dir
)paren
suffix:semicolon
id|presto_put_permit
c_func
(paren
id|dir
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
singleline_comment|// XXX this can be optimized: renamtes across filesets only require 
singleline_comment|//     multiple KML records, but can locally be executed normally. 
DECL|function|presto_rename
r_int
id|presto_rename
c_func
(paren
r_struct
id|inode
op_star
id|old_dir
comma
r_struct
id|dentry
op_star
id|old_dentry
comma
r_struct
id|inode
op_star
id|new_dir
comma
r_struct
id|dentry
op_star
id|new_dentry
)paren
(brace
r_int
id|error
suffix:semicolon
r_struct
id|presto_cache
op_star
id|cache
comma
op_star
id|new_cache
suffix:semicolon
r_struct
id|presto_file_set
op_star
id|fset
comma
op_star
id|new_fset
suffix:semicolon
r_struct
id|lento_vfs_context
id|info
suffix:semicolon
r_struct
id|dentry
op_star
id|old_parent
op_assign
id|old_dentry-&gt;d_parent
suffix:semicolon
r_struct
id|dentry
op_star
id|new_parent
op_assign
id|new_dentry-&gt;d_parent
suffix:semicolon
r_int
id|triple
suffix:semicolon
id|ENTRY
suffix:semicolon
id|error
op_assign
id|presto_prep
c_func
(paren
id|old_dentry
comma
op_amp
id|cache
comma
op_amp
id|fset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|error
op_assign
id|presto_prep
c_func
(paren
id|new_parent
comma
op_amp
id|new_cache
comma
op_amp
id|new_fset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fset
op_ne
id|new_fset
)paren
(brace
id|EXIT
suffix:semicolon
r_return
op_minus
id|EXDEV
suffix:semicolon
)brace
multiline_comment|/* We need to do dget before the dput in double_unlock, to ensure we&n;         * still have dentry references.  double_lock doesn&squot;t do dget for us.&n;         */
id|triple
op_assign
(paren
id|S_ISDIR
c_func
(paren
id|old_dentry-&gt;d_inode-&gt;i_mode
)paren
op_logical_and
id|new_dentry-&gt;d_inode
)paren
ques
c_cond
l_int|1
suffix:colon
l_int|0
suffix:semicolon
id|unlock_rename
c_func
(paren
id|new_dentry-&gt;d_parent
comma
id|old_dentry-&gt;d_parent
)paren
suffix:semicolon
r_if
c_cond
(paren
id|presto_get_permit
c_func
(paren
id|old_dir
)paren
OL
l_int|0
)paren
(brace
id|EXIT
suffix:semicolon
r_return
op_minus
id|EROFS
suffix:semicolon
)brace
r_if
c_cond
(paren
id|presto_get_permit
c_func
(paren
id|new_dir
)paren
OL
l_int|0
)paren
(brace
id|EXIT
suffix:semicolon
r_return
op_minus
id|EROFS
suffix:semicolon
)brace
id|lock_rename
c_func
(paren
id|new_dentry-&gt;d_parent
comma
id|old_dentry-&gt;d_parent
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|info
comma
l_int|0
comma
r_sizeof
(paren
id|info
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ISLENTO
c_func
(paren
id|presto_c2m
c_func
(paren
id|cache
)paren
)paren
)paren
id|info.flags
op_assign
id|LENTO_FL_KML
suffix:semicolon
id|info.flags
op_or_assign
id|LENTO_FL_IGNORE_TIME
suffix:semicolon
id|error
op_assign
id|do_rename
c_func
(paren
id|fset
comma
id|old_parent
comma
id|old_dentry
comma
id|new_parent
comma
id|new_dentry
comma
op_amp
id|info
)paren
suffix:semicolon
id|presto_put_permit
c_func
(paren
id|new_dir
)paren
suffix:semicolon
id|presto_put_permit
c_func
(paren
id|old_dir
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
multiline_comment|/* basically this allows the ilookup processes access to all files for&n; * reading, while not making ilookup totally insecure.  This could all&n; * go away if we could set the CAP_DAC_READ_SEARCH capability for the client.&n; */
multiline_comment|/* If posix acls are available, the underlying cache fs will export the&n; * appropriate permission function. Thus we do not worry here about ACLs&n; * or EAs. -SHP&n; */
DECL|function|presto_permission
r_int
id|presto_permission
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_int
id|mask
)paren
(brace
r_int
r_int
id|mode
op_assign
id|inode-&gt;i_mode
suffix:semicolon
r_struct
id|presto_cache
op_star
id|cache
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|ENTRY
suffix:semicolon
r_if
c_cond
(paren
id|presto_can_ilookup
c_func
(paren
)paren
op_logical_and
op_logical_neg
(paren
id|mask
op_amp
id|S_IWOTH
)paren
)paren
(brace
id|CDEBUG
c_func
(paren
id|D_CACHE
comma
l_string|&quot;ilookup on %ld OK&bslash;n&quot;
comma
id|inode-&gt;i_ino
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|cache
op_assign
id|presto_get_cache
c_func
(paren
id|inode
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cache
)paren
(brace
multiline_comment|/* we only override the file/dir permission operations */
r_struct
id|inode_operations
op_star
id|fiops
op_assign
id|filter_c2cfiops
c_func
(paren
id|cache-&gt;cache_filter
)paren
suffix:semicolon
r_struct
id|inode_operations
op_star
id|diops
op_assign
id|filter_c2cdiops
c_func
(paren
id|cache-&gt;cache_filter
)paren
suffix:semicolon
r_if
c_cond
(paren
id|S_ISREG
c_func
(paren
id|mode
)paren
op_logical_and
id|fiops
op_logical_and
id|fiops-&gt;permission
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|fiops
op_member_access_from_pointer
id|permission
c_func
(paren
id|inode
comma
id|mask
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|S_ISDIR
c_func
(paren
id|mode
)paren
op_logical_and
id|diops
op_logical_and
id|diops-&gt;permission
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|diops
op_member_access_from_pointer
id|permission
c_func
(paren
id|inode
comma
id|mask
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* The cache filesystem doesn&squot;t have its own permission function,&n;         * but we don&squot;t want to duplicate the VFS code here.  In order&n;         * to avoid looping from permission calling this function again,&n;         * we temporarily override the permission operation while we call&n;         * the VFS permission function.&n;         */
id|inode-&gt;i_op-&gt;permission
op_assign
l_int|NULL
suffix:semicolon
id|rc
op_assign
id|permission
c_func
(paren
id|inode
comma
id|mask
)paren
suffix:semicolon
id|inode-&gt;i_op-&gt;permission
op_assign
op_amp
id|presto_permission
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|presto_ioctl
r_int
id|presto_ioctl
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|cmd
comma
r_int
r_int
id|arg
)paren
(brace
r_char
id|buf
(braket
l_int|1024
)braket
suffix:semicolon
r_struct
id|izo_ioctl_data
op_star
id|data
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|presto_dentry_data
op_star
id|dd
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|ENTRY
suffix:semicolon
multiline_comment|/* Try the filesystem&squot;s ioctl first, and return if it succeeded. */
id|dd
op_assign
id|presto_d2d
c_func
(paren
id|file-&gt;f_dentry
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dd
op_logical_and
id|dd-&gt;dd_fset
)paren
(brace
r_int
(paren
op_star
id|cache_ioctl
)paren
(paren
r_struct
id|inode
op_star
comma
r_struct
id|file
op_star
comma
r_int
r_int
comma
r_int
r_int
)paren
op_assign
id|filter_c2cdfops
c_func
(paren
id|dd-&gt;dd_fset-&gt;fset_cache-&gt;cache_filter
)paren
op_member_access_from_pointer
id|ioctl
suffix:semicolon
id|rc
op_assign
op_minus
id|ENOTTY
suffix:semicolon
r_if
c_cond
(paren
id|cache_ioctl
)paren
id|rc
op_assign
id|cache_ioctl
c_func
(paren
id|inode
comma
id|file
comma
id|cmd
comma
id|arg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ne
op_minus
id|ENOTTY
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|current-&gt;euid
op_ne
l_int|0
op_logical_and
id|current-&gt;euid
op_ne
id|izo_authorized_uid
)paren
(brace
id|EXIT
suffix:semicolon
r_return
op_minus
id|EPERM
suffix:semicolon
)brace
id|memset
c_func
(paren
id|buf
comma
l_int|0
comma
r_sizeof
(paren
id|buf
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|izo_ioctl_getdata
c_func
(paren
id|buf
comma
id|buf
op_plus
l_int|1024
comma
(paren
r_void
op_star
)paren
id|arg
)paren
)paren
(brace
id|CERROR
c_func
(paren
l_string|&quot;intermezzo ioctl: data error&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|data
op_assign
(paren
r_struct
id|izo_ioctl_data
op_star
)paren
id|buf
suffix:semicolon
r_switch
c_cond
(paren
id|cmd
)paren
(brace
r_case
id|IZO_IOC_REINTKML
suffix:colon
(brace
r_int
id|rc
suffix:semicolon
r_int
id|cperr
suffix:semicolon
id|rc
op_assign
id|kml_reint_rec
c_func
(paren
id|file
comma
id|data
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
id|cperr
op_assign
id|copy_to_user
c_func
(paren
(paren
r_char
op_star
)paren
id|arg
comma
id|data
comma
r_sizeof
(paren
op_star
id|data
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cperr
)paren
(brace
id|CERROR
c_func
(paren
l_string|&quot;WARNING: cperr %d&bslash;n&quot;
comma
id|cperr
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|EFAULT
suffix:semicolon
)brace
r_return
id|rc
suffix:semicolon
)brace
r_case
id|IZO_IOC_GET_RCVD
suffix:colon
(brace
r_struct
id|izo_rcvd_rec
id|rec
suffix:semicolon
r_struct
id|presto_file_set
op_star
id|fset
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|fset
op_assign
id|presto_fset
c_func
(paren
id|file-&gt;f_dentry
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fset
op_eq
l_int|NULL
)paren
(brace
id|EXIT
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|rc
op_assign
id|izo_rcvd_get
c_func
(paren
op_amp
id|rec
comma
id|fset
comma
id|data-&gt;ioc_uuid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|EXIT
suffix:semicolon
r_return
id|copy_to_user
c_func
(paren
(paren
r_char
op_star
)paren
id|arg
comma
op_amp
id|rec
comma
r_sizeof
(paren
id|rec
)paren
)paren
ques
c_cond
op_minus
id|EFAULT
suffix:colon
l_int|0
suffix:semicolon
)brace
r_case
id|IZO_IOC_REPSTATUS
suffix:colon
(brace
id|__u64
id|client_kmlsize
suffix:semicolon
r_struct
id|izo_rcvd_rec
op_star
id|lr_client
suffix:semicolon
r_struct
id|izo_rcvd_rec
id|rec
suffix:semicolon
r_struct
id|presto_file_set
op_star
id|fset
suffix:semicolon
r_int
id|minor
suffix:semicolon
r_int
id|rc
suffix:semicolon
id|fset
op_assign
id|presto_fset
c_func
(paren
id|file-&gt;f_dentry
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fset
op_eq
l_int|NULL
)paren
(brace
id|EXIT
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|minor
op_assign
id|presto_f2m
c_func
(paren
id|fset
)paren
suffix:semicolon
id|client_kmlsize
op_assign
id|data-&gt;ioc_kmlsize
suffix:semicolon
id|lr_client
op_assign
(paren
r_struct
id|izo_rcvd_rec
op_star
)paren
id|data-&gt;ioc_pbuf1
suffix:semicolon
id|rc
op_assign
id|izo_repstatus
c_func
(paren
id|fset
comma
id|client_kmlsize
comma
id|lr_client
comma
op_amp
id|rec
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|EXIT
suffix:semicolon
r_return
id|copy_to_user
c_func
(paren
(paren
r_char
op_star
)paren
id|arg
comma
op_amp
id|rec
comma
r_sizeof
(paren
id|rec
)paren
)paren
ques
c_cond
op_minus
id|EFAULT
suffix:colon
l_int|0
suffix:semicolon
)brace
r_case
id|IZO_IOC_GET_CHANNEL
suffix:colon
(brace
r_struct
id|presto_file_set
op_star
id|fset
suffix:semicolon
id|fset
op_assign
id|presto_fset
c_func
(paren
id|file-&gt;f_dentry
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fset
op_eq
l_int|NULL
)paren
(brace
id|EXIT
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|data-&gt;ioc_dev
op_assign
id|fset-&gt;fset_cache-&gt;cache_psdev-&gt;uc_minor
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_PSDEV
comma
l_string|&quot;CHANNEL %d&bslash;n&quot;
comma
id|data-&gt;ioc_dev
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|copy_to_user
c_func
(paren
(paren
r_char
op_star
)paren
id|arg
comma
id|data
comma
r_sizeof
(paren
op_star
id|data
)paren
)paren
ques
c_cond
op_minus
id|EFAULT
suffix:colon
l_int|0
suffix:semicolon
)brace
r_case
id|IZO_IOC_SET_IOCTL_UID
suffix:colon
id|izo_authorized_uid
op_assign
id|data-&gt;ioc_uid
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
r_case
id|IZO_IOC_SET_PID
suffix:colon
id|rc
op_assign
id|izo_psdev_setpid
c_func
(paren
id|data-&gt;ioc_dev
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|rc
suffix:semicolon
r_case
id|IZO_IOC_SET_CHANNEL
suffix:colon
id|rc
op_assign
id|izo_psdev_setchannel
c_func
(paren
id|file
comma
id|data-&gt;ioc_dev
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|rc
suffix:semicolon
r_case
id|IZO_IOC_GET_KML_SIZE
suffix:colon
(brace
r_struct
id|presto_file_set
op_star
id|fset
suffix:semicolon
id|__u64
id|kmlsize
suffix:semicolon
id|fset
op_assign
id|presto_fset
c_func
(paren
id|file-&gt;f_dentry
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fset
op_eq
l_int|NULL
)paren
(brace
id|EXIT
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|kmlsize
op_assign
id|presto_kml_offset
c_func
(paren
id|fset
)paren
op_plus
id|fset-&gt;fset_kml_logical_off
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|copy_to_user
c_func
(paren
(paren
r_char
op_star
)paren
id|arg
comma
op_amp
id|kmlsize
comma
r_sizeof
(paren
id|kmlsize
)paren
)paren
ques
op_minus
id|EFAULT
suffix:colon
l_int|0
suffix:semicolon
)brace
r_case
id|IZO_IOC_PURGE_FILE_DATA
suffix:colon
(brace
r_struct
id|presto_file_set
op_star
id|fset
suffix:semicolon
id|fset
op_assign
id|presto_fset
c_func
(paren
id|file-&gt;f_dentry
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fset
op_eq
l_int|NULL
)paren
(brace
id|EXIT
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|rc
op_assign
id|izo_purge_file
c_func
(paren
id|fset
comma
id|data-&gt;ioc_inlbuf1
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_case
id|IZO_IOC_GET_FILEID
suffix:colon
(brace
id|rc
op_assign
id|izo_get_fileid
c_func
(paren
id|file
comma
id|data
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
r_return
id|copy_to_user
c_func
(paren
(paren
r_char
op_star
)paren
id|arg
comma
id|data
comma
r_sizeof
(paren
op_star
id|data
)paren
)paren
ques
c_cond
op_minus
id|EFAULT
suffix:colon
l_int|0
suffix:semicolon
)brace
r_case
id|IZO_IOC_SET_FILEID
suffix:colon
(brace
id|rc
op_assign
id|izo_set_fileid
c_func
(paren
id|file
comma
id|data
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
r_return
id|copy_to_user
c_func
(paren
(paren
r_char
op_star
)paren
id|arg
comma
id|data
comma
r_sizeof
(paren
op_star
id|data
)paren
)paren
ques
c_cond
op_minus
id|EFAULT
suffix:colon
l_int|0
suffix:semicolon
)brace
r_case
id|IZO_IOC_ADJUST_LML
suffix:colon
(brace
r_struct
id|lento_vfs_context
op_star
id|info
suffix:semicolon
id|info
op_assign
(paren
r_struct
id|lento_vfs_context
op_star
)paren
id|data-&gt;ioc_inlbuf1
suffix:semicolon
id|rc
op_assign
id|presto_adjust_lml
c_func
(paren
id|file
comma
id|info
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_case
id|IZO_IOC_CONNECT
suffix:colon
(brace
r_struct
id|presto_file_set
op_star
id|fset
suffix:semicolon
r_int
id|minor
suffix:semicolon
id|fset
op_assign
id|presto_fset
c_func
(paren
id|file-&gt;f_dentry
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fset
op_eq
l_int|NULL
)paren
(brace
id|EXIT
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|minor
op_assign
id|presto_f2m
c_func
(paren
id|fset
)paren
suffix:semicolon
id|rc
op_assign
id|izo_upc_connect
c_func
(paren
id|minor
comma
id|data-&gt;ioc_ino
comma
id|data-&gt;ioc_generation
comma
id|data-&gt;ioc_uuid
comma
id|data-&gt;ioc_flags
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_case
id|IZO_IOC_GO_FETCH_KML
suffix:colon
(brace
r_struct
id|presto_file_set
op_star
id|fset
suffix:semicolon
r_int
id|minor
suffix:semicolon
id|fset
op_assign
id|presto_fset
c_func
(paren
id|file-&gt;f_dentry
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fset
op_eq
l_int|NULL
)paren
(brace
id|EXIT
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|minor
op_assign
id|presto_f2m
c_func
(paren
id|fset
)paren
suffix:semicolon
id|rc
op_assign
id|izo_upc_go_fetch_kml
c_func
(paren
id|minor
comma
id|fset-&gt;fset_name
comma
id|data-&gt;ioc_uuid
comma
id|data-&gt;ioc_kmlsize
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_case
id|IZO_IOC_REVOKE_PERMIT
suffix:colon
r_if
c_cond
(paren
id|data-&gt;ioc_flags
)paren
id|rc
op_assign
id|izo_revoke_permit
c_func
(paren
id|file-&gt;f_dentry
comma
id|data-&gt;ioc_uuid
)paren
suffix:semicolon
r_else
id|rc
op_assign
id|izo_revoke_permit
c_func
(paren
id|file-&gt;f_dentry
comma
l_int|NULL
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|rc
suffix:semicolon
r_case
id|IZO_IOC_CLEAR_FSET
suffix:colon
id|rc
op_assign
id|izo_clear_fsetroot
c_func
(paren
id|file-&gt;f_dentry
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|rc
suffix:semicolon
r_case
id|IZO_IOC_CLEAR_ALL_FSETS
suffix:colon
(brace
r_struct
id|presto_file_set
op_star
id|fset
suffix:semicolon
id|fset
op_assign
id|presto_fset
c_func
(paren
id|file-&gt;f_dentry
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fset
op_eq
l_int|NULL
)paren
(brace
id|EXIT
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|rc
op_assign
id|izo_clear_all_fsetroots
c_func
(paren
id|fset-&gt;fset_cache
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_case
id|IZO_IOC_SET_FSET
suffix:colon
multiline_comment|/*&n;                 * Mark this dentry as being a fileset root.&n;                 */
id|rc
op_assign
id|presto_set_fsetroot_from_ioc
c_func
(paren
id|file-&gt;f_dentry
comma
id|data-&gt;ioc_inlbuf1
comma
id|data-&gt;ioc_flags
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|rc
suffix:semicolon
r_case
id|IZO_IOC_MARK
suffix:colon
(brace
r_int
id|res
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* resulting flags - returned to user */
r_int
id|error
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_DOWNCALL
comma
l_string|&quot;mark inode: %ld, and: %x, or: %x, what %d&bslash;n&quot;
comma
id|file-&gt;f_dentry-&gt;d_inode-&gt;i_ino
comma
id|data-&gt;ioc_and_flag
comma
id|data-&gt;ioc_or_flag
comma
id|data-&gt;ioc_mark_what
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|data-&gt;ioc_mark_what
)paren
(brace
r_case
id|MARK_DENTRY
suffix:colon
id|error
op_assign
id|izo_mark_dentry
c_func
(paren
id|file-&gt;f_dentry
comma
id|data-&gt;ioc_and_flag
comma
id|data-&gt;ioc_or_flag
comma
op_amp
id|res
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MARK_FSET
suffix:colon
id|error
op_assign
id|izo_mark_fset
c_func
(paren
id|file-&gt;f_dentry
comma
id|data-&gt;ioc_and_flag
comma
id|data-&gt;ioc_or_flag
comma
op_amp
id|res
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MARK_CACHE
suffix:colon
id|error
op_assign
id|izo_mark_cache
c_func
(paren
id|file-&gt;f_dentry
comma
id|data-&gt;ioc_and_flag
comma
id|data-&gt;ioc_or_flag
comma
op_amp
id|res
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|MARK_GETFL
suffix:colon
(brace
r_int
id|fflags
comma
id|cflags
suffix:semicolon
id|data-&gt;ioc_and_flag
op_assign
l_int|0xffffffff
suffix:semicolon
id|data-&gt;ioc_or_flag
op_assign
l_int|0
suffix:semicolon
id|error
op_assign
id|izo_mark_dentry
c_func
(paren
id|file-&gt;f_dentry
comma
id|data-&gt;ioc_and_flag
comma
id|data-&gt;ioc_or_flag
comma
op_amp
id|res
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_break
suffix:semicolon
id|error
op_assign
id|izo_mark_fset
c_func
(paren
id|file-&gt;f_dentry
comma
id|data-&gt;ioc_and_flag
comma
id|data-&gt;ioc_or_flag
comma
op_amp
id|fflags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_break
suffix:semicolon
id|error
op_assign
id|izo_mark_cache
c_func
(paren
id|file-&gt;f_dentry
comma
id|data-&gt;ioc_and_flag
comma
id|data-&gt;ioc_or_flag
comma
op_amp
id|cflags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_break
suffix:semicolon
id|data-&gt;ioc_and_flag
op_assign
id|fflags
suffix:semicolon
id|data-&gt;ioc_or_flag
op_assign
id|cflags
suffix:semicolon
r_break
suffix:semicolon
)brace
r_default
suffix:colon
id|error
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|data-&gt;ioc_mark_what
op_assign
id|res
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_DOWNCALL
comma
l_string|&quot;mark inode: %ld, and: %x, or: %x, what %x&bslash;n&quot;
comma
id|file-&gt;f_dentry-&gt;d_inode-&gt;i_ino
comma
id|data-&gt;ioc_and_flag
comma
id|data-&gt;ioc_or_flag
comma
id|data-&gt;ioc_mark_what
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|copy_to_user
c_func
(paren
(paren
r_char
op_star
)paren
id|arg
comma
id|data
comma
r_sizeof
(paren
op_star
id|data
)paren
)paren
ques
c_cond
op_minus
id|EFAULT
suffix:colon
l_int|0
suffix:semicolon
)brace
macro_line|#if 0
r_case
id|IZO_IOC_CLIENT_MAKE_BRANCH
suffix:colon
(brace
r_struct
id|presto_file_set
op_star
id|fset
suffix:semicolon
r_int
id|minor
suffix:semicolon
id|fset
op_assign
id|presto_fset
c_func
(paren
id|file-&gt;f_dentry
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fset
op_eq
l_int|NULL
)paren
(brace
id|EXIT
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|minor
op_assign
id|presto_f2m
c_func
(paren
id|fset
)paren
suffix:semicolon
id|rc
op_assign
id|izo_upc_client_make_branch
c_func
(paren
id|minor
comma
id|fset-&gt;fset_name
comma
id|data-&gt;ioc_inlbuf1
comma
id|data-&gt;ioc_inlbuf2
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
macro_line|#endif
r_case
id|IZO_IOC_SERVER_MAKE_BRANCH
suffix:colon
(brace
r_struct
id|presto_file_set
op_star
id|fset
suffix:semicolon
r_int
id|minor
suffix:semicolon
id|fset
op_assign
id|presto_fset
c_func
(paren
id|file-&gt;f_dentry
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fset
op_eq
l_int|NULL
)paren
(brace
id|EXIT
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|minor
op_assign
id|presto_f2m
c_func
(paren
id|fset
)paren
suffix:semicolon
id|izo_upc_server_make_branch
c_func
(paren
id|minor
comma
id|data-&gt;ioc_inlbuf1
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_case
id|IZO_IOC_SET_KMLSIZE
suffix:colon
(brace
r_struct
id|presto_file_set
op_star
id|fset
suffix:semicolon
r_int
id|minor
suffix:semicolon
r_struct
id|izo_rcvd_rec
id|rec
suffix:semicolon
id|fset
op_assign
id|presto_fset
c_func
(paren
id|file-&gt;f_dentry
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fset
op_eq
l_int|NULL
)paren
(brace
id|EXIT
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|minor
op_assign
id|presto_f2m
c_func
(paren
id|fset
)paren
suffix:semicolon
id|rc
op_assign
id|izo_upc_set_kmlsize
c_func
(paren
id|minor
comma
id|fset-&gt;fset_name
comma
id|data-&gt;ioc_uuid
comma
id|data-&gt;ioc_kmlsize
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ne
l_int|0
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|rc
op_assign
id|izo_rcvd_get
c_func
(paren
op_amp
id|rec
comma
id|fset
comma
id|data-&gt;ioc_uuid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
op_minus
id|EINVAL
)paren
(brace
multiline_comment|/* We don&squot;t know anything about this uuid yet; no&n;                         * worries. */
id|memset
c_func
(paren
op_amp
id|rec
comma
l_int|0
comma
r_sizeof
(paren
id|rec
)paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|rc
op_le
l_int|0
)paren
(brace
id|CERROR
c_func
(paren
l_string|&quot;InterMezzo: error reading last_rcvd: %d&bslash;n&quot;
comma
id|rc
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|rec.lr_remote_offset
op_assign
id|data-&gt;ioc_kmlsize
suffix:semicolon
id|rc
op_assign
id|izo_rcvd_write
c_func
(paren
id|fset
comma
op_amp
id|rec
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_le
l_int|0
)paren
(brace
id|CERROR
c_func
(paren
l_string|&quot;InterMezzo: error writing last_rcvd: %d&bslash;n&quot;
comma
id|rc
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|EXIT
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_case
id|IZO_IOC_BRANCH_UNDO
suffix:colon
(brace
r_struct
id|presto_file_set
op_star
id|fset
suffix:semicolon
r_int
id|minor
suffix:semicolon
id|fset
op_assign
id|presto_fset
c_func
(paren
id|file-&gt;f_dentry
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fset
op_eq
l_int|NULL
)paren
(brace
id|EXIT
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|minor
op_assign
id|presto_f2m
c_func
(paren
id|fset
)paren
suffix:semicolon
id|rc
op_assign
id|izo_upc_branch_undo
c_func
(paren
id|minor
comma
id|fset-&gt;fset_name
comma
id|data-&gt;ioc_inlbuf1
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_case
id|IZO_IOC_BRANCH_REDO
suffix:colon
(brace
r_struct
id|presto_file_set
op_star
id|fset
suffix:semicolon
r_int
id|minor
suffix:semicolon
id|fset
op_assign
id|presto_fset
c_func
(paren
id|file-&gt;f_dentry
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fset
op_eq
l_int|NULL
)paren
(brace
id|EXIT
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|minor
op_assign
id|presto_f2m
c_func
(paren
id|fset
)paren
suffix:semicolon
id|rc
op_assign
id|izo_upc_branch_redo
c_func
(paren
id|minor
comma
id|fset-&gt;fset_name
comma
id|data-&gt;ioc_inlbuf1
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_case
id|TCGETS
suffix:colon
id|EXIT
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
r_default
suffix:colon
id|EXIT
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|EXIT
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|presto_dir_fops
r_struct
id|file_operations
id|presto_dir_fops
op_assign
(brace
dot
id|ioctl
op_assign
id|presto_ioctl
)brace
suffix:semicolon
DECL|variable|presto_dir_iops
r_struct
id|inode_operations
id|presto_dir_iops
op_assign
(brace
dot
id|create
op_assign
id|presto_create
comma
dot
id|lookup
op_assign
id|presto_lookup
comma
dot
id|link
op_assign
id|presto_link
comma
dot
id|unlink
op_assign
id|presto_unlink
comma
dot
id|symlink
op_assign
id|presto_symlink
comma
dot
id|mkdir
op_assign
id|presto_mkdir
comma
dot
id|rmdir
op_assign
id|presto_rmdir
comma
dot
id|mknod
op_assign
id|presto_mknod
comma
dot
id|rename
op_assign
id|presto_rename
comma
dot
id|permission
op_assign
id|presto_permission
comma
dot
id|setattr
op_assign
id|presto_setattr
comma
macro_line|#ifdef CONFIG_FS_EXT_ATTR
dot
id|set_ext_attr
op_assign
id|presto_set_ext_attr
comma
macro_line|#endif
)brace
suffix:semicolon
eof
