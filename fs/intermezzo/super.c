multiline_comment|/*&n; *  presto&squot;s super.c&n; *&n; *  Copyright (C) 1998 Peter J. Braam&n; *  Copyright (C) 2000 Stelias Computing, Inc.&n; *  Copyright (C) 2000 Red Hat, Inc.&n; *&n; *&n; */
macro_line|#include &lt;stdarg.h&gt;
macro_line|#include &lt;asm/bitops.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/system.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/ext2_fs.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/vmalloc.h&gt;
macro_line|#include &lt;linux/time.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/locks.h&gt;
macro_line|#include &lt;linux/blkdev.h&gt;
macro_line|#include &lt;linux/init.h&gt;
DECL|macro|__NO_VERSION__
mdefine_line|#define __NO_VERSION__
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/intermezzo_fs.h&gt;
macro_line|#include &lt;linux/intermezzo_upcall.h&gt;
macro_line|#include &lt;linux/intermezzo_psdev.h&gt;
macro_line|#ifdef PRESTO_DEBUG
DECL|variable|presto_vmemory
r_int
id|presto_vmemory
op_assign
l_int|0
suffix:semicolon
DECL|variable|presto_kmemory
r_int
id|presto_kmemory
op_assign
l_int|0
suffix:semicolon
macro_line|#endif
r_extern
r_struct
id|presto_cache
op_star
id|presto_init_cache
c_func
(paren
r_void
)paren
suffix:semicolon
r_extern
r_inline
r_void
id|presto_cache_add
c_func
(paren
r_struct
id|presto_cache
op_star
id|cache
comma
id|kdev_t
id|dev
)paren
suffix:semicolon
r_extern
r_inline
r_void
id|presto_init_cache_hash
c_func
(paren
r_void
)paren
suffix:semicolon
r_int
id|presto_remount
c_func
(paren
r_struct
id|super_block
op_star
comma
r_int
op_star
comma
r_char
op_star
)paren
suffix:semicolon
r_extern
id|ssize_t
id|presto_file_write
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buf
comma
r_int
id|size
comma
id|loff_t
op_star
id|off
)paren
suffix:semicolon
multiline_comment|/*&n; *  Reading the super block.&n; *&n; *&n; *&n; */
multiline_comment|/* returns an allocated string, copied out from data if opt is found */
DECL|function|read_opt
r_static
r_char
op_star
id|read_opt
c_func
(paren
r_const
r_char
op_star
id|opt
comma
r_char
op_star
id|data
)paren
(brace
r_char
op_star
id|value
suffix:semicolon
r_char
op_star
id|retval
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_SUPER
comma
l_string|&quot;option: %s, data %s&bslash;n&quot;
comma
id|opt
comma
id|data
)paren
suffix:semicolon
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|opt
comma
id|data
comma
id|strlen
c_func
(paren
id|opt
)paren
)paren
)paren
r_return
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
(paren
id|value
op_assign
id|strchr
c_func
(paren
id|data
comma
l_char|&squot;=&squot;
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
l_int|NULL
suffix:semicolon
id|value
op_increment
suffix:semicolon
id|PRESTO_ALLOC
c_func
(paren
id|retval
comma
r_char
op_star
comma
id|strlen
c_func
(paren
id|value
)paren
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|retval
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;InterMezzo: Out of memory!&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
id|strcpy
c_func
(paren
id|retval
comma
id|value
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_SUPER
comma
l_string|&quot;Assigned option: %s, value %s&bslash;n&quot;
comma
id|opt
comma
id|retval
)paren
suffix:semicolon
r_return
id|retval
suffix:semicolon
)brace
DECL|function|store_opt
r_static
r_void
id|store_opt
c_func
(paren
r_char
op_star
op_star
id|dst
comma
r_char
op_star
id|opt
comma
r_char
op_star
id|defval
)paren
(brace
r_if
c_cond
(paren
id|dst
)paren
(brace
r_if
c_cond
(paren
op_star
id|dst
)paren
(brace
id|PRESTO_FREE
c_func
(paren
op_star
id|dst
comma
id|strlen
c_func
(paren
op_star
id|dst
)paren
op_plus
l_int|1
)paren
suffix:semicolon
)brace
op_star
id|dst
op_assign
id|opt
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
l_string|&quot;presto: store_opt, error dst == NULL&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|opt
op_logical_and
id|defval
)paren
(brace
r_char
op_star
id|def_alloced
suffix:semicolon
id|PRESTO_ALLOC
c_func
(paren
id|def_alloced
comma
r_char
op_star
comma
id|strlen
c_func
(paren
id|defval
)paren
op_plus
l_int|1
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|def_alloced
comma
id|defval
)paren
suffix:semicolon
op_star
id|dst
op_assign
id|def_alloced
suffix:semicolon
)brace
)brace
multiline_comment|/* Find the options for InterMezzo in &quot;options&quot;, saving them into the&n; * passed pointers.  If the pointer is null, the option is discarded.&n; * Copy out all non-InterMezzo options into cache_data (to be passed&n; * to the read_super operation of the cache).  The return value will&n; * be a pointer to the end of the cache_data.&n; */
DECL|function|presto_options
r_static
r_char
op_star
id|presto_options
c_func
(paren
r_char
op_star
id|options
comma
r_char
op_star
id|cache_data
comma
r_char
op_star
op_star
id|cache_type
comma
r_char
op_star
op_star
id|fileset
comma
r_char
op_star
op_star
id|prestodev
comma
r_char
op_star
op_star
id|mtpt
)paren
(brace
r_char
op_star
id|this_char
suffix:semicolon
r_char
op_star
id|cache_data_end
op_assign
id|cache_data
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|options
op_logical_or
op_logical_neg
id|cache_data
)paren
r_return
id|cache_data_end
suffix:semicolon
multiline_comment|/* set the defaults */
id|store_opt
c_func
(paren
id|cache_type
comma
l_int|NULL
comma
l_string|&quot;ext3&quot;
)paren
suffix:semicolon
id|store_opt
c_func
(paren
id|prestodev
comma
l_int|NULL
comma
id|PRESTO_PSDEV_NAME
l_string|&quot;0&quot;
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_SUPER
comma
l_string|&quot;parsing options&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|this_char
op_assign
id|strtok
(paren
id|options
comma
l_string|&quot;,&quot;
)paren
suffix:semicolon
id|this_char
op_ne
l_int|NULL
suffix:semicolon
id|this_char
op_assign
id|strtok
(paren
l_int|NULL
comma
l_string|&quot;,&quot;
)paren
)paren
(brace
r_char
op_star
id|opt
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_SUPER
comma
l_string|&quot;this_char %s&bslash;n&quot;
comma
id|this_char
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|opt
op_assign
id|read_opt
c_func
(paren
l_string|&quot;fileset&quot;
comma
id|this_char
)paren
)paren
)paren
(brace
id|store_opt
c_func
(paren
id|fileset
comma
id|opt
comma
l_int|NULL
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|opt
op_assign
id|read_opt
c_func
(paren
l_string|&quot;cache_type&quot;
comma
id|this_char
)paren
)paren
)paren
(brace
id|store_opt
c_func
(paren
id|cache_type
comma
id|opt
comma
l_string|&quot;ext3&quot;
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|opt
op_assign
id|read_opt
c_func
(paren
l_string|&quot;mtpt&quot;
comma
id|this_char
)paren
)paren
)paren
(brace
id|store_opt
c_func
(paren
id|mtpt
comma
id|opt
comma
l_int|NULL
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|opt
op_assign
id|read_opt
c_func
(paren
l_string|&quot;prestodev&quot;
comma
id|this_char
)paren
)paren
)paren
(brace
id|store_opt
c_func
(paren
id|prestodev
comma
id|opt
comma
id|PRESTO_PSDEV_NAME
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|cache_data_end
op_add_assign
id|sprintf
c_func
(paren
id|cache_data_end
comma
l_string|&quot;%s%s&quot;
comma
id|cache_data_end
op_ne
id|cache_data
ques
c_cond
l_string|&quot;,&quot;
suffix:colon
l_string|&quot;&quot;
comma
id|this_char
)paren
suffix:semicolon
)brace
r_return
id|cache_data_end
suffix:semicolon
)brace
multiline_comment|/*&n;    map a /dev/intermezzoX path to a minor:&n;    used to validate mount options passed to InterMezzo&n; */
DECL|function|presto_get_minor
r_static
r_int
id|presto_get_minor
c_func
(paren
r_char
op_star
id|dev_path
comma
r_int
op_star
id|minor
)paren
(brace
r_struct
id|nameidata
id|nd
suffix:semicolon
r_struct
id|dentry
op_star
id|dentry
suffix:semicolon
id|kdev_t
id|devno
op_assign
id|NODEV
suffix:semicolon
r_int
id|error
suffix:semicolon
id|ENTRY
suffix:semicolon
multiline_comment|/* Special case for root filesystem - use minor 0 always. */
r_if
c_cond
(paren
id|current-&gt;pid
op_eq
l_int|1
)paren
(brace
op_star
id|minor
op_assign
l_int|0
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|error
op_assign
id|presto_walk
c_func
(paren
id|dev_path
comma
op_amp
id|nd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
id|dentry
op_assign
id|nd.dentry
suffix:semicolon
id|error
op_assign
op_minus
id|ENODEV
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dentry-&gt;d_inode
)paren
(brace
id|EXIT
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|S_ISCHR
c_func
(paren
id|dentry-&gt;d_inode-&gt;i_mode
)paren
)paren
(brace
id|EXIT
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|devno
op_assign
id|dentry-&gt;d_inode-&gt;i_rdev
suffix:semicolon
r_if
c_cond
(paren
id|major
c_func
(paren
id|devno
)paren
op_ne
id|PRESTO_PSDEV_MAJOR
)paren
(brace
id|EXIT
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|minor
c_func
(paren
id|devno
)paren
op_ge
id|MAX_PRESTODEV
)paren
(brace
id|EXIT
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|EXIT
suffix:semicolon
id|out
suffix:colon
op_star
id|minor
op_assign
id|minor
c_func
(paren
id|devno
)paren
suffix:semicolon
id|path_release
c_func
(paren
op_amp
id|nd
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* We always need to remove the presto options before passing to bottom FS */
DECL|function|presto_read_super
r_struct
id|super_block
op_star
id|presto_read_super
c_func
(paren
r_struct
id|super_block
op_star
id|presto_sb
comma
r_void
op_star
id|data
comma
r_int
id|silent
)paren
(brace
r_struct
id|super_block
op_star
id|mysb
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|file_system_type
op_star
id|fstype
suffix:semicolon
r_struct
id|presto_cache
op_star
id|cache
op_assign
l_int|NULL
suffix:semicolon
r_char
op_star
id|cache_data
op_assign
l_int|NULL
suffix:semicolon
r_char
op_star
id|cache_data_end
suffix:semicolon
r_char
op_star
id|cache_type
op_assign
l_int|NULL
suffix:semicolon
r_char
op_star
id|fileset
op_assign
l_int|NULL
suffix:semicolon
r_char
op_star
id|presto_mtpt
op_assign
l_int|NULL
suffix:semicolon
r_char
op_star
id|prestodev
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|filter_fs
op_star
id|ops
suffix:semicolon
r_int
id|minor
suffix:semicolon
r_struct
id|upc_comm
op_star
id|psdev
suffix:semicolon
id|ENTRY
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_MALLOC
comma
l_string|&quot;before parsing: kmem %ld, vmem %ld&bslash;n&quot;
comma
id|presto_kmemory
comma
id|presto_vmemory
)paren
suffix:semicolon
multiline_comment|/* reserve space for the cache&squot;s data */
id|PRESTO_ALLOC
c_func
(paren
id|cache_data
comma
r_void
op_star
comma
id|PAGE_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cache_data
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;presto_read_super: Cannot allocate data page.&bslash;n&quot;
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_goto
id|out_err
suffix:semicolon
)brace
id|CDEBUG
c_func
(paren
id|D_SUPER
comma
l_string|&quot;mount opts: %s&bslash;n&quot;
comma
id|data
ques
c_cond
(paren
r_char
op_star
)paren
id|data
suffix:colon
l_string|&quot;(none)&quot;
)paren
suffix:semicolon
multiline_comment|/* read and validate options */
id|cache_data_end
op_assign
id|presto_options
c_func
(paren
id|data
comma
id|cache_data
comma
op_amp
id|cache_type
comma
op_amp
id|fileset
comma
op_amp
id|prestodev
comma
op_amp
id|presto_mtpt
)paren
suffix:semicolon
multiline_comment|/* was there anything for the cache filesystem in the data? */
r_if
c_cond
(paren
id|cache_data_end
op_eq
id|cache_data
)paren
(brace
id|PRESTO_FREE
c_func
(paren
id|cache_data
comma
id|PAGE_SIZE
)paren
suffix:semicolon
id|cache_data
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
(brace
id|CDEBUG
c_func
(paren
id|D_SUPER
comma
l_string|&quot;cache_data at %p is: %s&bslash;n&quot;
comma
id|cache_data
comma
id|cache_data
)paren
suffix:semicolon
)brace
multiline_comment|/* prepare the communication channel */
r_if
c_cond
(paren
id|presto_get_minor
c_func
(paren
id|prestodev
comma
op_amp
id|minor
)paren
)paren
(brace
multiline_comment|/* if (!silent) */
id|printk
c_func
(paren
l_string|&quot;InterMezzo: %s not a valid presto dev&bslash;n&quot;
comma
id|prestodev
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_goto
id|out_err
suffix:semicolon
)brace
id|psdev
op_assign
op_amp
id|upc_comms
(braket
id|minor
)braket
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_SUPER
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|psdev-&gt;uc_no_filter
op_assign
l_int|1
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_SUPER
comma
l_string|&quot;presto minor is %d&bslash;n&quot;
comma
id|minor
)paren
suffix:semicolon
multiline_comment|/* set up the cache */
id|cache
op_assign
id|presto_init_cache
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cache
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;presto_read_super: failure allocating cache.&bslash;n&quot;
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_goto
id|out_err
suffix:semicolon
)brace
multiline_comment|/* no options were passed: likely we are &quot;/&quot; readonly */
r_if
c_cond
(paren
op_logical_neg
id|presto_mtpt
op_logical_or
op_logical_neg
id|fileset
)paren
(brace
id|cache-&gt;cache_flags
op_or_assign
id|CACHE_LENTO_RO
op_or
id|CACHE_CLIENT_RO
suffix:semicolon
)brace
id|cache-&gt;cache_psdev
op_assign
id|psdev
suffix:semicolon
multiline_comment|/* no options were passed: likely we are &quot;/&quot; readonly */
multiline_comment|/* before the journaling infrastructure can work, these&n;           need to be set; that happens in presto_remount */
r_if
c_cond
(paren
op_logical_neg
id|presto_mtpt
op_logical_or
op_logical_neg
id|fileset
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|presto_mtpt
)paren
id|printk
c_func
(paren
l_string|&quot;No mountpoint marking cache RO&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fileset
)paren
id|printk
c_func
(paren
l_string|&quot;No fileset marking cache RO&bslash;n&quot;
)paren
suffix:semicolon
id|cache-&gt;cache_flags
op_or_assign
id|CACHE_LENTO_RO
op_or
id|CACHE_CLIENT_RO
suffix:semicolon
)brace
id|cache-&gt;cache_mtpt
op_assign
id|presto_mtpt
suffix:semicolon
id|cache-&gt;cache_root_fileset
op_assign
id|fileset
suffix:semicolon
id|cache-&gt;cache_type
op_assign
id|cache_type
suffix:semicolon
id|printk
c_func
(paren
l_string|&quot;Presto: type=%s, vol=%s, dev=%s (minor %d), mtpt %s, flags %x&bslash;n&quot;
comma
id|cache_type
comma
id|fileset
ques
c_cond
id|fileset
suffix:colon
l_string|&quot;NULL&quot;
comma
id|prestodev
comma
id|minor
comma
id|presto_mtpt
ques
c_cond
id|presto_mtpt
suffix:colon
l_string|&quot;NULL&quot;
comma
id|cache-&gt;cache_flags
)paren
suffix:semicolon
id|MOD_INC_USE_COUNT
suffix:semicolon
id|fstype
op_assign
id|get_fs_type
c_func
(paren
id|cache_type
)paren
suffix:semicolon
id|cache-&gt;cache_filter
op_assign
id|filter_get_filter_fs
c_func
(paren
(paren
r_const
r_char
op_star
)paren
id|cache_type
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fstype
op_logical_or
op_logical_neg
id|cache-&gt;cache_filter
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Presto: unrecognized fs type or cache type&bslash;n&quot;
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
id|EXIT
suffix:semicolon
r_goto
id|out_err
suffix:semicolon
)brace
id|mysb
op_assign
id|fstype
op_member_access_from_pointer
id|read_super
c_func
(paren
id|presto_sb
comma
id|cache_data
comma
id|silent
)paren
suffix:semicolon
multiline_comment|/* this might have been freed above */
r_if
c_cond
(paren
id|cache_data
)paren
(brace
id|PRESTO_FREE
c_func
(paren
id|cache_data
comma
id|PAGE_SIZE
)paren
suffix:semicolon
id|cache_data
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|mysb
)paren
(brace
multiline_comment|/* if (!silent) */
id|printk
c_func
(paren
l_string|&quot;InterMezzo: cache mount failure.&bslash;n&quot;
)paren
suffix:semicolon
id|MOD_DEC_USE_COUNT
suffix:semicolon
id|EXIT
suffix:semicolon
r_goto
id|out_err
suffix:semicolon
)brace
id|cache-&gt;cache_sb
op_assign
id|mysb
suffix:semicolon
id|ops
op_assign
id|filter_get_filter_fs
c_func
(paren
id|cache_type
)paren
suffix:semicolon
id|filter_setup_journal_ops
c_func
(paren
id|cache-&gt;cache_filter
comma
id|cache-&gt;cache_type
)paren
suffix:semicolon
multiline_comment|/* we now know the dev of the cache: hash the cache */
id|presto_cache_add
c_func
(paren
id|cache
comma
id|mysb-&gt;s_dev
)paren
suffix:semicolon
multiline_comment|/* make sure we have our own super operations: mysb&n;           still contains the cache operations */
id|filter_setup_super_ops
c_func
(paren
id|cache-&gt;cache_filter
comma
id|mysb-&gt;s_op
comma
op_amp
id|presto_super_ops
)paren
suffix:semicolon
id|mysb-&gt;s_op
op_assign
id|filter_c2usops
c_func
(paren
id|cache-&gt;cache_filter
)paren
suffix:semicolon
multiline_comment|/* now get our own directory operations */
r_if
c_cond
(paren
id|mysb-&gt;s_root
op_logical_and
id|mysb-&gt;s_root-&gt;d_inode
)paren
(brace
id|CDEBUG
c_func
(paren
id|D_SUPER
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
id|filter_setup_dir_ops
c_func
(paren
id|cache-&gt;cache_filter
comma
id|mysb-&gt;s_root-&gt;d_inode
comma
op_amp
id|presto_dir_iops
comma
op_amp
id|presto_dir_fops
)paren
suffix:semicolon
id|mysb-&gt;s_root-&gt;d_inode-&gt;i_op
op_assign
id|filter_c2udiops
c_func
(paren
id|cache-&gt;cache_filter
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_SUPER
comma
l_string|&quot;lookup at %p&bslash;n&quot;
comma
id|mysb-&gt;s_root-&gt;d_inode-&gt;i_op-&gt;lookup
)paren
suffix:semicolon
id|filter_setup_dentry_ops
c_func
(paren
id|cache-&gt;cache_filter
comma
id|mysb-&gt;s_root-&gt;d_op
comma
op_amp
id|presto_dentry_ops
)paren
suffix:semicolon
id|presto_sb-&gt;s_root-&gt;d_op
op_assign
id|filter_c2udops
c_func
(paren
id|cache-&gt;cache_filter
)paren
suffix:semicolon
id|cache-&gt;cache_mtde
op_assign
id|mysb-&gt;s_root
suffix:semicolon
id|presto_set_dd
c_func
(paren
id|mysb-&gt;s_root
)paren
suffix:semicolon
)brace
id|CDEBUG
c_func
(paren
id|D_MALLOC
comma
l_string|&quot;after mounting: kmem %ld, vmem %ld&bslash;n&quot;
comma
id|presto_kmemory
comma
id|presto_vmemory
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|mysb
suffix:semicolon
id|out_err
suffix:colon
id|CDEBUG
c_func
(paren
id|D_SUPER
comma
l_string|&quot;out_err called&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cache
)paren
id|PRESTO_FREE
c_func
(paren
id|cache
comma
r_sizeof
(paren
r_struct
id|presto_cache
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cache_data
)paren
id|PRESTO_FREE
c_func
(paren
id|cache_data
comma
id|PAGE_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fileset
)paren
id|PRESTO_FREE
c_func
(paren
id|fileset
comma
id|strlen
c_func
(paren
id|fileset
)paren
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|presto_mtpt
)paren
id|PRESTO_FREE
c_func
(paren
id|presto_mtpt
comma
id|strlen
c_func
(paren
id|presto_mtpt
)paren
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|prestodev
)paren
id|PRESTO_FREE
c_func
(paren
id|prestodev
comma
id|strlen
c_func
(paren
id|prestodev
)paren
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cache_type
)paren
id|PRESTO_FREE
c_func
(paren
id|cache_type
comma
id|strlen
c_func
(paren
id|cache_type
)paren
op_plus
l_int|1
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_MALLOC
comma
l_string|&quot;mount error exit: kmem %ld, vmem %ld&bslash;n&quot;
comma
id|presto_kmemory
comma
id|presto_vmemory
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
DECL|function|presto_remount
r_int
id|presto_remount
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_int
op_star
id|flags
comma
r_char
op_star
id|data
)paren
(brace
r_char
op_star
id|cache_data
op_assign
l_int|NULL
suffix:semicolon
r_char
op_star
id|cache_data_end
suffix:semicolon
r_char
op_star
op_star
id|type
suffix:semicolon
r_char
op_star
op_star
id|fileset
suffix:semicolon
r_char
op_star
op_star
id|mtpt
suffix:semicolon
r_char
op_star
op_star
id|prestodev
suffix:semicolon
r_struct
id|super_operations
op_star
id|sops
suffix:semicolon
r_struct
id|presto_cache
op_star
id|cache
op_assign
l_int|NULL
suffix:semicolon
r_int
id|err
op_assign
l_int|0
suffix:semicolon
id|ENTRY
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_MALLOC
comma
l_string|&quot;before remount: kmem %ld, vmem %ld&bslash;n&quot;
comma
id|presto_kmemory
comma
id|presto_vmemory
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_SUPER
comma
l_string|&quot;remount opts: %s&bslash;n&quot;
comma
id|data
ques
c_cond
(paren
r_char
op_star
)paren
id|data
suffix:colon
l_string|&quot;(none)&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|data
)paren
(brace
multiline_comment|/* reserve space for the cache&squot;s data */
id|PRESTO_ALLOC
c_func
(paren
id|cache_data
comma
r_void
op_star
comma
id|PAGE_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cache_data
)paren
(brace
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
id|EXIT
suffix:semicolon
r_goto
id|out_err
suffix:semicolon
)brace
)brace
id|cache
op_assign
id|presto_find_cache
c_func
(paren
id|sb-&gt;s_dev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cache
)paren
(brace
id|printk
c_func
(paren
id|__FUNCTION__
l_string|&quot;: cannot find cache on remount&bslash;n&quot;
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|ENODEV
suffix:semicolon
id|EXIT
suffix:semicolon
r_goto
id|out_err
suffix:semicolon
)brace
multiline_comment|/* If an option has not yet been set, we allow it to be set on&n;         * remount.  If an option already has a value, we pass NULL for&n;         * the option pointer, which means that the InterMezzo option&n;         * will be parsed but discarded.&n;         */
id|type
op_assign
id|cache-&gt;cache_type
ques
c_cond
l_int|NULL
suffix:colon
op_amp
id|cache-&gt;cache_type
suffix:semicolon
id|fileset
op_assign
id|cache-&gt;cache_root_fileset
ques
c_cond
l_int|NULL
suffix:colon
op_amp
id|cache-&gt;cache_root_fileset
suffix:semicolon
id|prestodev
op_assign
id|cache-&gt;cache_psdev
ques
c_cond
l_int|NULL
suffix:colon
op_amp
id|cache-&gt;cache_psdev-&gt;uc_devname
suffix:semicolon
id|mtpt
op_assign
id|cache-&gt;cache_mtpt
ques
c_cond
l_int|NULL
suffix:colon
op_amp
id|cache-&gt;cache_mtpt
suffix:semicolon
id|cache_data_end
op_assign
id|presto_options
c_func
(paren
id|data
comma
id|cache_data
comma
id|type
comma
id|fileset
comma
id|prestodev
comma
id|mtpt
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cache_data
)paren
(brace
r_if
c_cond
(paren
id|cache_data_end
op_eq
id|cache_data
)paren
(brace
id|PRESTO_FREE
c_func
(paren
id|cache_data
comma
id|PAGE_SIZE
)paren
suffix:semicolon
id|cache_data
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
(brace
id|CDEBUG
c_func
(paren
id|D_SUPER
comma
l_string|&quot;cache_data at %p is: %s&bslash;n&quot;
comma
id|cache_data
comma
id|cache_data
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|cache-&gt;cache_root_fileset
op_logical_and
id|cache-&gt;cache_mtpt
)paren
(brace
id|cache-&gt;cache_flags
op_and_assign
op_complement
(paren
id|CACHE_LENTO_RO
op_or
id|CACHE_CLIENT_RO
)paren
suffix:semicolon
)brace
id|sops
op_assign
id|filter_c2csops
c_func
(paren
id|cache-&gt;cache_filter
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sops-&gt;remount_fs
)paren
(brace
id|err
op_assign
id|sops
op_member_access_from_pointer
id|remount_fs
c_func
(paren
id|sb
comma
id|flags
comma
id|cache_data
)paren
suffix:semicolon
)brace
id|CDEBUG
c_func
(paren
id|D_MALLOC
comma
l_string|&quot;after remount: kmem %ld, vmem %ld&bslash;n&quot;
comma
id|presto_kmemory
comma
id|presto_vmemory
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
id|out_err
suffix:colon
r_if
c_cond
(paren
id|cache_data
)paren
id|PRESTO_FREE
c_func
(paren
id|cache_data
comma
id|PAGE_SIZE
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|variable|presto_fs_type
r_struct
id|file_system_type
id|presto_fs_type
op_assign
(brace
macro_line|#ifdef PRESTO_DEVEL
l_string|&quot;izofs&quot;
comma
macro_line|#else 
l_string|&quot;intermezzo&quot;
comma
macro_line|#endif
id|FS_REQUIRES_DEV
comma
multiline_comment|/* can use Ibaskets when ext2 does */
id|presto_read_super
comma
l_int|NULL
)brace
suffix:semicolon
DECL|function|init_intermezzo_fs
r_int
multiline_comment|/* __init */
id|init_intermezzo_fs
c_func
(paren
r_void
)paren
(brace
r_int
id|status
suffix:semicolon
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;InterMezzo Kernel/Lento communications, &quot;
l_string|&quot;v1.04, braam@inter-mezzo.org&bslash;n&quot;
)paren
suffix:semicolon
id|status
op_assign
id|presto_psdev_init
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Problem (%d) in init_intermezzo_psdev&bslash;n&quot;
comma
id|status
)paren
suffix:semicolon
r_return
id|status
suffix:semicolon
)brace
id|status
op_assign
id|init_intermezzo_sysctl
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;presto: failed in init_intermezzo_sysctl!&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|presto_init_cache_hash
c_func
(paren
)paren
suffix:semicolon
id|presto_init_ddata_cache
c_func
(paren
)paren
suffix:semicolon
id|status
op_assign
id|register_filesystem
c_func
(paren
op_amp
id|presto_fs_type
)paren
suffix:semicolon
r_if
c_cond
(paren
id|status
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;presto: failed in register_filesystem!&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_return
id|status
suffix:semicolon
)brace
macro_line|#ifdef MODULE
id|MODULE_AUTHOR
c_func
(paren
l_string|&quot;Peter J. Braam &lt;braam@inter-mezzo.org&gt;&quot;
)paren
suffix:semicolon
id|MODULE_DESCRIPTION
c_func
(paren
l_string|&quot;InterMezzo Kernel/Lento communications, v1.0.5.1&quot;
)paren
suffix:semicolon
DECL|function|init_module
r_int
id|init_module
c_func
(paren
r_void
)paren
(brace
r_return
id|init_intermezzo_fs
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|cleanup_module
r_void
id|cleanup_module
c_func
(paren
r_void
)paren
(brace
r_int
id|err
suffix:semicolon
id|ENTRY
suffix:semicolon
r_if
c_cond
(paren
(paren
id|err
op_assign
id|unregister_filesystem
c_func
(paren
op_amp
id|presto_fs_type
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;presto: failed to unregister filesystem&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|presto_psdev_cleanup
c_func
(paren
)paren
suffix:semicolon
id|cleanup_intermezzo_sysctl
c_func
(paren
)paren
suffix:semicolon
id|presto_cleanup_ddata_cache
c_func
(paren
)paren
suffix:semicolon
macro_line|#ifdef PRESTO_DEVEL
id|unregister_chrdev
c_func
(paren
id|PRESTO_PSDEV_MAJOR
comma
l_string|&quot;intermezzo_psdev_devel&quot;
)paren
suffix:semicolon
macro_line|#else 
id|unregister_chrdev
c_func
(paren
id|PRESTO_PSDEV_MAJOR
comma
l_string|&quot;intermezzo_psdev&quot;
)paren
suffix:semicolon
macro_line|#endif
id|CDEBUG
c_func
(paren
id|D_MALLOC
comma
l_string|&quot;after cleanup: kmem %ld, vmem %ld&bslash;n&quot;
comma
id|presto_kmemory
comma
id|presto_vmemory
)paren
suffix:semicolon
)brace
macro_line|#endif
eof
