multiline_comment|/* -*- mode: c; c-basic-offset: 8; indent-tabs-mode: nil; -*-&n; * vim:expandtab:shiftwidth=8:tabstop=8:&n; *&n; *  Copyright (C) 2001 Cluster File Systems, Inc. &lt;braam@clusterfs.com&gt;&n; *&n; *   This file is part of InterMezzo, http://www.inter-mezzo.org.&n; *&n; *   InterMezzo is free software; you can redistribute it and/or&n; *   modify it under the terms of version 2 of the GNU General Public&n; *   License as published by the Free Software Foundation.&n; *&n; *   InterMezzo is distributed in the hope that it will be useful,&n; *   but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the&n; *   GNU General Public License for more details.&n; *&n; *   You should have received a copy of the GNU General Public License&n; *   along with InterMezzo; if not, write to the Free Software&n; *   Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; * Reintegration of KML records&n; *&n; */
DECL|macro|__NO_VERSION__
mdefine_line|#define __NO_VERSION__
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/major.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/vmalloc.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/pgtable.h&gt;
macro_line|#include &lt;asm/mmu_context.h&gt;
macro_line|#include &quot;intermezzo_fs.h&quot;
macro_line|#include &quot;intermezzo_psdev.h&quot;
DECL|function|kmlreint_pre_secure
r_static
r_void
id|kmlreint_pre_secure
c_func
(paren
r_struct
id|kml_rec
op_star
id|rec
comma
r_struct
id|file
op_star
id|dir
comma
r_struct
id|run_ctxt
op_star
id|saved
)paren
(brace
r_struct
id|run_ctxt
id|ctxt
suffix:semicolon
r_struct
id|presto_dentry_data
op_star
id|dd
op_assign
id|presto_d2d
c_func
(paren
id|dir-&gt;f_dentry
)paren
suffix:semicolon
r_int
id|i
suffix:semicolon
id|ctxt.fsuid
op_assign
id|rec-&gt;prefix.hdr-&gt;fsuid
suffix:semicolon
id|ctxt.fsgid
op_assign
id|rec-&gt;prefix.hdr-&gt;fsgid
suffix:semicolon
id|ctxt.fs
op_assign
id|KERNEL_DS
suffix:semicolon
id|ctxt.pwd
op_assign
id|dd-&gt;dd_fset-&gt;fset_dentry
suffix:semicolon
id|ctxt.pwdmnt
op_assign
id|dd-&gt;dd_fset-&gt;fset_mnt
suffix:semicolon
id|ctxt.root
op_assign
id|ctxt.pwd
suffix:semicolon
id|ctxt.rootmnt
op_assign
id|ctxt.pwdmnt
suffix:semicolon
r_if
c_cond
(paren
id|rec-&gt;prefix.hdr-&gt;ngroups
OG
l_int|0
)paren
(brace
id|ctxt.ngroups
op_assign
id|rec-&gt;prefix.hdr-&gt;ngroups
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ctxt.ngroups
suffix:semicolon
id|i
op_increment
)paren
id|ctxt.groups
(braket
id|i
)braket
op_assign
id|rec-&gt;prefix.groups
(braket
id|i
)braket
suffix:semicolon
)brace
r_else
id|ctxt.ngroups
op_assign
l_int|0
suffix:semicolon
id|push_ctxt
c_func
(paren
id|saved
comma
op_amp
id|ctxt
)paren
suffix:semicolon
)brace
multiline_comment|/* Append two strings in a less-retarded fashion. */
DECL|function|path_join
r_static
r_char
op_star
id|path_join
c_func
(paren
r_char
op_star
id|p1
comma
r_int
id|p1len
comma
r_char
op_star
id|p2
comma
r_int
id|p2len
)paren
(brace
r_int
id|size
op_assign
id|p1len
op_plus
id|p2len
op_plus
l_int|2
suffix:semicolon
multiline_comment|/* possibly one extra /, one NULL */
r_char
op_star
id|path
suffix:semicolon
id|path
op_assign
id|kmalloc
c_func
(paren
id|size
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|path
op_eq
l_int|NULL
)paren
r_return
l_int|NULL
suffix:semicolon
id|memcpy
c_func
(paren
id|path
comma
id|p1
comma
id|p1len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|path
(braket
id|p1len
op_minus
l_int|1
)braket
op_ne
l_char|&squot;/&squot;
)paren
(brace
id|path
(braket
id|p1len
)braket
op_assign
l_char|&squot;/&squot;
suffix:semicolon
id|p1len
op_increment
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|path
op_plus
id|p1len
comma
id|p2
comma
id|p2len
)paren
suffix:semicolon
id|path
(braket
id|p1len
op_plus
id|p2len
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_return
id|path
suffix:semicolon
)brace
DECL|function|kml_recno_equal
r_static
r_inline
r_int
id|kml_recno_equal
c_func
(paren
r_struct
id|kml_rec
op_star
id|rec
comma
r_struct
id|presto_file_set
op_star
id|fset
)paren
(brace
r_return
(paren
id|rec-&gt;suffix-&gt;recno
op_eq
id|fset-&gt;fset_lento_recno
op_plus
l_int|1
)paren
suffix:semicolon
)brace
DECL|function|version_equal
r_static
r_inline
r_int
id|version_equal
c_func
(paren
r_struct
id|presto_version
op_star
id|a
comma
r_struct
id|inode
op_star
id|inode
)paren
(brace
r_if
c_cond
(paren
id|a
op_eq
l_int|NULL
)paren
r_return
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|inode
op_eq
l_int|NULL
)paren
(brace
id|CERROR
c_func
(paren
l_string|&quot;InterMezzo: NULL inode in version_equal()&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|inode-&gt;i_mtime.tv_sec
op_eq
id|a-&gt;pv_mtime_sec
op_logical_and
id|inode-&gt;i_mtime.tv_nsec
op_eq
id|a-&gt;pv_mtime_nsec
op_logical_and
(paren
id|S_ISDIR
c_func
(paren
id|inode-&gt;i_mode
)paren
op_logical_or
id|inode-&gt;i_size
op_eq
id|a-&gt;pv_size
)paren
)paren
r_return
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|reint_close
r_static
r_int
id|reint_close
c_func
(paren
r_struct
id|kml_rec
op_star
id|rec
comma
r_struct
id|file
op_star
id|file
comma
r_struct
id|lento_vfs_context
op_star
id|given_info
)paren
(brace
r_struct
id|run_ctxt
id|saved_ctxt
suffix:semicolon
r_int
id|error
suffix:semicolon
r_struct
id|presto_file_set
op_star
id|fset
suffix:semicolon
r_struct
id|lento_vfs_context
id|info
suffix:semicolon
id|ENTRY
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|info
comma
id|given_info
comma
r_sizeof
(paren
op_star
id|given_info
)paren
)paren
suffix:semicolon
id|CDEBUG
(paren
id|D_KML
comma
l_string|&quot;=====REINT_CLOSE::%s&bslash;n&quot;
comma
id|rec-&gt;path
)paren
suffix:semicolon
id|fset
op_assign
id|presto_fset
c_func
(paren
id|file-&gt;f_dentry
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fset-&gt;fset_flags
op_amp
id|FSET_DATA_ON_DEMAND
)paren
(brace
r_struct
id|iattr
id|iattr
suffix:semicolon
id|iattr.ia_valid
op_assign
id|ATTR_CTIME
op_or
id|ATTR_MTIME
op_or
id|ATTR_SIZE
suffix:semicolon
id|iattr.ia_mtime.tv_sec
op_assign
(paren
id|time_t
)paren
id|rec-&gt;new_objectv-&gt;pv_mtime_sec
suffix:semicolon
id|iattr.ia_mtime.tv_nsec
op_assign
(paren
id|time_t
)paren
id|rec-&gt;new_objectv-&gt;pv_mtime_nsec
suffix:semicolon
id|iattr.ia_ctime.tv_sec
op_assign
(paren
id|time_t
)paren
id|rec-&gt;new_objectv-&gt;pv_ctime_sec
suffix:semicolon
id|iattr.ia_ctime.tv_nsec
op_assign
(paren
id|time_t
)paren
id|rec-&gt;new_objectv-&gt;pv_ctime_nsec
suffix:semicolon
id|iattr.ia_size
op_assign
(paren
id|time_t
)paren
id|rec-&gt;new_objectv-&gt;pv_size
suffix:semicolon
multiline_comment|/* no kml record, but update last rcvd */
multiline_comment|/* save fileid in dentry for later backfetch */
id|info.flags
op_or_assign
id|LENTO_FL_EXPECT
op_or
id|LENTO_FL_SET_DDFILEID
suffix:semicolon
id|info.remote_ino
op_assign
id|rec-&gt;ino
suffix:semicolon
id|info.remote_generation
op_assign
id|rec-&gt;generation
suffix:semicolon
id|info.flags
op_and_assign
op_complement
id|LENTO_FL_KML
suffix:semicolon
id|kmlreint_pre_secure
c_func
(paren
id|rec
comma
id|file
comma
op_amp
id|saved_ctxt
)paren
suffix:semicolon
id|error
op_assign
id|lento_setattr
c_func
(paren
id|rec-&gt;path
comma
op_amp
id|iattr
comma
op_amp
id|info
)paren
suffix:semicolon
id|pop_ctxt
c_func
(paren
op_amp
id|saved_ctxt
)paren
suffix:semicolon
id|presto_d2d
c_func
(paren
id|file-&gt;f_dentry
)paren
op_member_access_from_pointer
id|dd_flags
op_and_assign
op_complement
id|PRESTO_DATA
suffix:semicolon
)brace
r_else
(brace
r_int
id|minor
op_assign
id|presto_f2m
c_func
(paren
id|fset
)paren
suffix:semicolon
id|info.updated_time.tv_sec
op_assign
id|rec-&gt;new_objectv-&gt;pv_mtime_sec
suffix:semicolon
id|info.updated_time.tv_nsec
op_assign
id|rec-&gt;new_objectv-&gt;pv_mtime_nsec
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|info.remote_version
comma
id|rec-&gt;old_objectv
comma
r_sizeof
(paren
op_star
id|rec-&gt;old_objectv
)paren
)paren
suffix:semicolon
id|info.remote_ino
op_assign
id|rec-&gt;ino
suffix:semicolon
id|info.remote_generation
op_assign
id|rec-&gt;generation
suffix:semicolon
id|error
op_assign
id|izo_upc_backfetch
c_func
(paren
id|minor
comma
id|rec-&gt;path
comma
id|fset-&gt;fset_name
comma
op_amp
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|CERROR
c_func
(paren
l_string|&quot;backfetch error %d&bslash;n&quot;
comma
id|error
)paren
suffix:semicolon
multiline_comment|/* if file doesn&squot;t exist anymore,  then ignore the CLOSE&n;                         * and just update the last_rcvd.&n;                         */
r_if
c_cond
(paren
id|error
op_eq
id|ENOENT
)paren
(brace
id|CDEBUG
c_func
(paren
id|D_KML
comma
l_string|&quot;manually updating remote offset uuid %s&quot;
l_string|&quot;recno %d offset %Lu&bslash;n&quot;
comma
id|info.uuid
comma
id|info.recno
comma
id|info.kml_offset
)paren
suffix:semicolon
id|error
op_assign
id|izo_rcvd_upd_remote
c_func
(paren
id|fset
comma
id|info.uuid
comma
id|info.recno
comma
id|info.kml_offset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|CERROR
c_func
(paren
l_string|&quot;izo_rcvd_upd_remote error %d&bslash;n&quot;
comma
id|error
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* propagate error to avoid further reint */
)brace
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|function|reint_create
r_static
r_int
id|reint_create
c_func
(paren
r_struct
id|kml_rec
op_star
id|rec
comma
r_struct
id|file
op_star
id|dir
comma
r_struct
id|lento_vfs_context
op_star
id|info
)paren
(brace
r_struct
id|run_ctxt
id|saved_ctxt
suffix:semicolon
r_int
id|error
suffix:semicolon
id|ENTRY
suffix:semicolon
id|CDEBUG
(paren
id|D_KML
comma
l_string|&quot;=====REINT_CREATE::%s&bslash;n&quot;
comma
id|rec-&gt;path
)paren
suffix:semicolon
id|info-&gt;updated_time.tv_sec
op_assign
id|rec-&gt;new_objectv-&gt;pv_ctime_sec
suffix:semicolon
id|info-&gt;updated_time.tv_nsec
op_assign
id|rec-&gt;new_objectv-&gt;pv_ctime_nsec
suffix:semicolon
id|kmlreint_pre_secure
c_func
(paren
id|rec
comma
id|dir
comma
op_amp
id|saved_ctxt
)paren
suffix:semicolon
id|error
op_assign
id|lento_create
c_func
(paren
id|rec-&gt;path
comma
id|rec-&gt;mode
comma
id|info
)paren
suffix:semicolon
id|pop_ctxt
c_func
(paren
op_amp
id|saved_ctxt
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|function|reint_link
r_static
r_int
id|reint_link
c_func
(paren
r_struct
id|kml_rec
op_star
id|rec
comma
r_struct
id|file
op_star
id|dir
comma
r_struct
id|lento_vfs_context
op_star
id|info
)paren
(brace
r_struct
id|run_ctxt
id|saved_ctxt
suffix:semicolon
r_int
id|error
suffix:semicolon
id|ENTRY
suffix:semicolon
id|CDEBUG
(paren
id|D_KML
comma
l_string|&quot;=====REINT_LINK::%s -&gt; %s&bslash;n&quot;
comma
id|rec-&gt;path
comma
id|rec-&gt;target
)paren
suffix:semicolon
id|info-&gt;updated_time.tv_sec
op_assign
id|rec-&gt;new_objectv-&gt;pv_mtime_sec
suffix:semicolon
id|info-&gt;updated_time.tv_nsec
op_assign
id|rec-&gt;new_objectv-&gt;pv_mtime_nsec
suffix:semicolon
id|kmlreint_pre_secure
c_func
(paren
id|rec
comma
id|dir
comma
op_amp
id|saved_ctxt
)paren
suffix:semicolon
id|error
op_assign
id|lento_link
c_func
(paren
id|rec-&gt;path
comma
id|rec-&gt;target
comma
id|info
)paren
suffix:semicolon
id|pop_ctxt
c_func
(paren
op_amp
id|saved_ctxt
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|function|reint_mkdir
r_static
r_int
id|reint_mkdir
c_func
(paren
r_struct
id|kml_rec
op_star
id|rec
comma
r_struct
id|file
op_star
id|dir
comma
r_struct
id|lento_vfs_context
op_star
id|info
)paren
(brace
r_struct
id|run_ctxt
id|saved_ctxt
suffix:semicolon
r_int
id|error
suffix:semicolon
id|ENTRY
suffix:semicolon
id|CDEBUG
(paren
id|D_KML
comma
l_string|&quot;=====REINT_MKDIR::%s&bslash;n&quot;
comma
id|rec-&gt;path
)paren
suffix:semicolon
id|info-&gt;updated_time.tv_sec
op_assign
id|rec-&gt;new_objectv-&gt;pv_ctime_sec
suffix:semicolon
id|info-&gt;updated_time.tv_nsec
op_assign
id|rec-&gt;new_objectv-&gt;pv_ctime_nsec
suffix:semicolon
id|kmlreint_pre_secure
c_func
(paren
id|rec
comma
id|dir
comma
op_amp
id|saved_ctxt
)paren
suffix:semicolon
id|error
op_assign
id|lento_mkdir
c_func
(paren
id|rec-&gt;path
comma
id|rec-&gt;mode
comma
id|info
)paren
suffix:semicolon
id|pop_ctxt
c_func
(paren
op_amp
id|saved_ctxt
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|function|reint_mknod
r_static
r_int
id|reint_mknod
c_func
(paren
r_struct
id|kml_rec
op_star
id|rec
comma
r_struct
id|file
op_star
id|dir
comma
r_struct
id|lento_vfs_context
op_star
id|info
)paren
(brace
r_struct
id|run_ctxt
id|saved_ctxt
suffix:semicolon
r_int
id|error
comma
id|dev
suffix:semicolon
id|ENTRY
suffix:semicolon
id|CDEBUG
(paren
id|D_KML
comma
l_string|&quot;=====REINT_MKNOD::%s&bslash;n&quot;
comma
id|rec-&gt;path
)paren
suffix:semicolon
id|info-&gt;updated_time.tv_sec
op_assign
id|rec-&gt;new_objectv-&gt;pv_ctime_sec
suffix:semicolon
id|info-&gt;updated_time.tv_nsec
op_assign
id|rec-&gt;new_objectv-&gt;pv_ctime_nsec
suffix:semicolon
id|kmlreint_pre_secure
c_func
(paren
id|rec
comma
id|dir
comma
op_amp
id|saved_ctxt
)paren
suffix:semicolon
id|dev
op_assign
id|rec-&gt;rdev
ques
c_cond
suffix:colon
id|MKDEV
c_func
(paren
id|rec-&gt;major
comma
id|rec-&gt;minor
)paren
suffix:semicolon
id|error
op_assign
id|lento_mknod
c_func
(paren
id|rec-&gt;path
comma
id|rec-&gt;mode
comma
id|dev
comma
id|info
)paren
suffix:semicolon
id|pop_ctxt
c_func
(paren
op_amp
id|saved_ctxt
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|function|reint_noop
r_static
r_int
id|reint_noop
c_func
(paren
r_struct
id|kml_rec
op_star
id|rec
comma
r_struct
id|file
op_star
id|dir
comma
r_struct
id|lento_vfs_context
op_star
id|info
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|reint_rename
r_static
r_int
id|reint_rename
c_func
(paren
r_struct
id|kml_rec
op_star
id|rec
comma
r_struct
id|file
op_star
id|dir
comma
r_struct
id|lento_vfs_context
op_star
id|info
)paren
(brace
r_struct
id|run_ctxt
id|saved_ctxt
suffix:semicolon
r_int
id|error
suffix:semicolon
id|ENTRY
suffix:semicolon
id|CDEBUG
(paren
id|D_KML
comma
l_string|&quot;=====REINT_RENAME::%s -&gt; %s&bslash;n&quot;
comma
id|rec-&gt;path
comma
id|rec-&gt;target
)paren
suffix:semicolon
id|info-&gt;updated_time.tv_sec
op_assign
id|rec-&gt;new_objectv-&gt;pv_mtime_sec
suffix:semicolon
id|info-&gt;updated_time.tv_nsec
op_assign
id|rec-&gt;new_objectv-&gt;pv_mtime_nsec
suffix:semicolon
id|kmlreint_pre_secure
c_func
(paren
id|rec
comma
id|dir
comma
op_amp
id|saved_ctxt
)paren
suffix:semicolon
id|error
op_assign
id|lento_rename
c_func
(paren
id|rec-&gt;path
comma
id|rec-&gt;target
comma
id|info
)paren
suffix:semicolon
id|pop_ctxt
c_func
(paren
op_amp
id|saved_ctxt
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|function|reint_rmdir
r_static
r_int
id|reint_rmdir
c_func
(paren
r_struct
id|kml_rec
op_star
id|rec
comma
r_struct
id|file
op_star
id|dir
comma
r_struct
id|lento_vfs_context
op_star
id|info
)paren
(brace
r_struct
id|run_ctxt
id|saved_ctxt
suffix:semicolon
r_int
id|error
suffix:semicolon
r_char
op_star
id|path
suffix:semicolon
id|ENTRY
suffix:semicolon
id|path
op_assign
id|path_join
c_func
(paren
id|rec-&gt;path
comma
id|rec-&gt;pathlen
op_minus
l_int|1
comma
id|rec-&gt;target
comma
id|rec-&gt;targetlen
)paren
suffix:semicolon
r_if
c_cond
(paren
id|path
op_eq
l_int|NULL
)paren
(brace
id|EXIT
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|CDEBUG
(paren
id|D_KML
comma
l_string|&quot;=====REINT_RMDIR::%s&bslash;n&quot;
comma
id|path
)paren
suffix:semicolon
id|info-&gt;updated_time.tv_sec
op_assign
id|rec-&gt;new_parentv-&gt;pv_mtime_sec
suffix:semicolon
id|info-&gt;updated_time.tv_nsec
op_assign
id|rec-&gt;new_parentv-&gt;pv_mtime_nsec
suffix:semicolon
id|kmlreint_pre_secure
c_func
(paren
id|rec
comma
id|dir
comma
op_amp
id|saved_ctxt
)paren
suffix:semicolon
id|error
op_assign
id|lento_rmdir
c_func
(paren
id|path
comma
id|info
)paren
suffix:semicolon
id|pop_ctxt
c_func
(paren
op_amp
id|saved_ctxt
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|path
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|function|reint_setattr
r_static
r_int
id|reint_setattr
c_func
(paren
r_struct
id|kml_rec
op_star
id|rec
comma
r_struct
id|file
op_star
id|dir
comma
r_struct
id|lento_vfs_context
op_star
id|info
)paren
(brace
r_struct
id|run_ctxt
id|saved_ctxt
suffix:semicolon
r_struct
id|iattr
id|iattr
suffix:semicolon
r_int
id|error
suffix:semicolon
id|ENTRY
suffix:semicolon
id|iattr.ia_valid
op_assign
id|rec-&gt;valid
suffix:semicolon
id|iattr.ia_mode
op_assign
(paren
id|umode_t
)paren
id|rec-&gt;mode
suffix:semicolon
id|iattr.ia_uid
op_assign
(paren
id|uid_t
)paren
id|rec-&gt;uid
suffix:semicolon
id|iattr.ia_gid
op_assign
(paren
id|gid_t
)paren
id|rec-&gt;gid
suffix:semicolon
id|iattr.ia_size
op_assign
(paren
id|off_t
)paren
id|rec-&gt;size
suffix:semicolon
id|iattr.ia_ctime.tv_sec
op_assign
id|rec-&gt;ctime_sec
suffix:semicolon
id|iattr.ia_ctime.tv_nsec
op_assign
id|rec-&gt;ctime_nsec
suffix:semicolon
id|iattr.ia_mtime.tv_sec
op_assign
id|rec-&gt;mtime_sec
suffix:semicolon
id|iattr.ia_mtime.tv_nsec
op_assign
id|rec-&gt;mtime_nsec
suffix:semicolon
id|iattr.ia_atime
op_assign
id|iattr.ia_mtime
suffix:semicolon
multiline_comment|/* We don&squot;t track atimes. */
id|iattr.ia_attr_flags
op_assign
id|rec-&gt;flags
suffix:semicolon
id|CDEBUG
(paren
id|D_KML
comma
l_string|&quot;=====REINT_SETATTR::%s (%d)&bslash;n&quot;
comma
id|rec-&gt;path
comma
id|rec-&gt;valid
)paren
suffix:semicolon
id|kmlreint_pre_secure
c_func
(paren
id|rec
comma
id|dir
comma
op_amp
id|saved_ctxt
)paren
suffix:semicolon
id|error
op_assign
id|lento_setattr
c_func
(paren
id|rec-&gt;path
comma
op_amp
id|iattr
comma
id|info
)paren
suffix:semicolon
id|pop_ctxt
c_func
(paren
op_amp
id|saved_ctxt
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|function|reint_symlink
r_static
r_int
id|reint_symlink
c_func
(paren
r_struct
id|kml_rec
op_star
id|rec
comma
r_struct
id|file
op_star
id|dir
comma
r_struct
id|lento_vfs_context
op_star
id|info
)paren
(brace
r_struct
id|run_ctxt
id|saved_ctxt
suffix:semicolon
r_int
id|error
suffix:semicolon
id|ENTRY
suffix:semicolon
id|CDEBUG
(paren
id|D_KML
comma
l_string|&quot;=====REINT_SYMLINK::%s -&gt; %s&bslash;n&quot;
comma
id|rec-&gt;path
comma
id|rec-&gt;target
)paren
suffix:semicolon
id|info-&gt;updated_time.tv_sec
op_assign
id|rec-&gt;new_objectv-&gt;pv_ctime_sec
suffix:semicolon
id|info-&gt;updated_time.tv_nsec
op_assign
id|rec-&gt;new_objectv-&gt;pv_ctime_nsec
suffix:semicolon
id|kmlreint_pre_secure
c_func
(paren
id|rec
comma
id|dir
comma
op_amp
id|saved_ctxt
)paren
suffix:semicolon
id|error
op_assign
id|lento_symlink
c_func
(paren
id|rec-&gt;target
comma
id|rec-&gt;path
comma
id|info
)paren
suffix:semicolon
id|pop_ctxt
c_func
(paren
op_amp
id|saved_ctxt
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|function|reint_unlink
r_static
r_int
id|reint_unlink
c_func
(paren
r_struct
id|kml_rec
op_star
id|rec
comma
r_struct
id|file
op_star
id|dir
comma
r_struct
id|lento_vfs_context
op_star
id|info
)paren
(brace
r_struct
id|run_ctxt
id|saved_ctxt
suffix:semicolon
r_int
id|error
suffix:semicolon
r_char
op_star
id|path
suffix:semicolon
id|ENTRY
suffix:semicolon
id|path
op_assign
id|path_join
c_func
(paren
id|rec-&gt;path
comma
id|rec-&gt;pathlen
op_minus
l_int|1
comma
id|rec-&gt;target
comma
id|rec-&gt;targetlen
)paren
suffix:semicolon
r_if
c_cond
(paren
id|path
op_eq
l_int|NULL
)paren
(brace
id|EXIT
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|CDEBUG
(paren
id|D_KML
comma
l_string|&quot;=====REINT_UNLINK::%s&bslash;n&quot;
comma
id|path
)paren
suffix:semicolon
id|info-&gt;updated_time.tv_sec
op_assign
id|rec-&gt;new_parentv-&gt;pv_mtime_sec
suffix:semicolon
id|info-&gt;updated_time.tv_nsec
op_assign
id|rec-&gt;new_parentv-&gt;pv_mtime_nsec
suffix:semicolon
id|kmlreint_pre_secure
c_func
(paren
id|rec
comma
id|dir
comma
op_amp
id|saved_ctxt
)paren
suffix:semicolon
id|error
op_assign
id|lento_unlink
c_func
(paren
id|path
comma
id|info
)paren
suffix:semicolon
id|pop_ctxt
c_func
(paren
op_amp
id|saved_ctxt
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|path
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|function|branch_reint_rename
r_static
r_int
id|branch_reint_rename
c_func
(paren
r_struct
id|presto_file_set
op_star
id|fset
comma
r_struct
id|kml_rec
op_star
id|rec
comma
r_struct
id|file
op_star
id|dir
comma
r_struct
id|lento_vfs_context
op_star
id|info
comma
r_char
op_star
id|kml_data
comma
id|__u64
id|kml_size
)paren
(brace
r_int
id|error
suffix:semicolon
id|ENTRY
suffix:semicolon
id|error
op_assign
id|reint_rename
c_func
(paren
id|rec
comma
id|dir
comma
id|info
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
op_eq
op_minus
id|ENOENT
)paren
(brace
multiline_comment|/* normal reint failed because path was not found */
r_struct
id|rec_info
id|rec
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_KML
comma
l_string|&quot;saving branch rename kml&bslash;n&quot;
)paren
suffix:semicolon
id|rec.is_kml
op_assign
l_int|1
suffix:semicolon
id|rec.size
op_assign
id|kml_size
suffix:semicolon
id|error
op_assign
id|presto_log
c_func
(paren
id|fset
comma
op_amp
id|rec
comma
id|kml_data
comma
id|kml_size
comma
l_int|NULL
comma
l_int|0
comma
l_int|NULL
comma
l_int|0
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
op_eq
l_int|0
)paren
id|error
op_assign
id|presto_write_last_rcvd
c_func
(paren
op_amp
id|rec
comma
id|fset
comma
id|info
)paren
suffix:semicolon
)brace
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|function|branch_reinter
r_int
id|branch_reinter
c_func
(paren
r_struct
id|presto_file_set
op_star
id|fset
comma
r_struct
id|kml_rec
op_star
id|rec
comma
r_struct
id|file
op_star
id|dir
comma
r_struct
id|lento_vfs_context
op_star
id|info
comma
r_char
op_star
id|kml_data
comma
id|__u64
id|kml_size
)paren
(brace
r_int
id|error
op_assign
l_int|0
suffix:semicolon
r_int
id|op
op_assign
id|rec-&gt;prefix.hdr-&gt;opcode
suffix:semicolon
r_if
c_cond
(paren
id|op
op_eq
id|KML_OPCODE_CLOSE
)paren
(brace
multiline_comment|/* regular close and backfetch */
id|error
op_assign
id|reint_close
c_func
(paren
id|rec
comma
id|dir
comma
id|info
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|op
op_eq
id|KML_OPCODE_RENAME
)paren
(brace
multiline_comment|/* rename only if name already exists  */
id|error
op_assign
id|branch_reint_rename
c_func
(paren
id|fset
comma
id|rec
comma
id|dir
comma
id|info
comma
id|kml_data
comma
id|kml_size
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* just rewrite kml into branch/kml and update last_rcvd */
r_struct
id|rec_info
id|rec
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_KML
comma
l_string|&quot;Saving branch kml&bslash;n&quot;
)paren
suffix:semicolon
id|rec.is_kml
op_assign
l_int|1
suffix:semicolon
id|rec.size
op_assign
id|kml_size
suffix:semicolon
id|error
op_assign
id|presto_log
c_func
(paren
id|fset
comma
op_amp
id|rec
comma
id|kml_data
comma
id|kml_size
comma
l_int|NULL
comma
l_int|0
comma
l_int|NULL
comma
l_int|0
comma
l_int|NULL
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
op_eq
l_int|0
)paren
id|error
op_assign
id|presto_write_last_rcvd
c_func
(paren
op_amp
id|rec
comma
id|fset
comma
id|info
)paren
suffix:semicolon
)brace
r_return
id|error
suffix:semicolon
)brace
DECL|typedef|reinter_t
r_typedef
r_int
(paren
op_star
id|reinter_t
)paren
(paren
r_struct
id|kml_rec
op_star
id|rec
comma
r_struct
id|file
op_star
id|basedir
comma
r_struct
id|lento_vfs_context
op_star
id|info
)paren
suffix:semicolon
DECL|variable|presto_reinters
r_static
id|reinter_t
id|presto_reinters
(braket
id|KML_OPCODE_NUM
)braket
op_assign
(brace
(braket
id|KML_OPCODE_CLOSE
)braket
op_assign
id|reint_close
comma
(braket
id|KML_OPCODE_CREATE
)braket
op_assign
id|reint_create
comma
(braket
id|KML_OPCODE_LINK
)braket
op_assign
id|reint_link
comma
(braket
id|KML_OPCODE_MKDIR
)braket
op_assign
id|reint_mkdir
comma
(braket
id|KML_OPCODE_MKNOD
)braket
op_assign
id|reint_mknod
comma
(braket
id|KML_OPCODE_NOOP
)braket
op_assign
id|reint_noop
comma
(braket
id|KML_OPCODE_RENAME
)braket
op_assign
id|reint_rename
comma
(braket
id|KML_OPCODE_RMDIR
)braket
op_assign
id|reint_rmdir
comma
(braket
id|KML_OPCODE_SETATTR
)braket
op_assign
id|reint_setattr
comma
(braket
id|KML_OPCODE_SYMLINK
)braket
op_assign
id|reint_symlink
comma
(braket
id|KML_OPCODE_UNLINK
)braket
op_assign
id|reint_unlink
comma
)brace
suffix:semicolon
DECL|function|get_reinter
r_static
r_inline
id|reinter_t
id|get_reinter
c_func
(paren
r_int
id|op
)paren
(brace
r_if
c_cond
(paren
id|op
OL
l_int|0
op_logical_or
id|op
op_ge
r_sizeof
(paren
id|presto_reinters
)paren
op_div
r_sizeof
(paren
id|reinter_t
)paren
)paren
r_return
l_int|NULL
suffix:semicolon
r_else
r_return
id|presto_reinters
(braket
id|op
)braket
suffix:semicolon
)brace
DECL|function|kml_reint_rec
r_int
id|kml_reint_rec
c_func
(paren
r_struct
id|file
op_star
id|dir
comma
r_struct
id|izo_ioctl_data
op_star
id|data
)paren
(brace
r_char
op_star
id|ptr
suffix:semicolon
r_char
op_star
id|end
suffix:semicolon
r_struct
id|kml_rec
id|rec
suffix:semicolon
r_int
id|error
op_assign
l_int|0
suffix:semicolon
r_struct
id|lento_vfs_context
id|info
suffix:semicolon
r_struct
id|presto_cache
op_star
id|cache
suffix:semicolon
r_struct
id|presto_file_set
op_star
id|fset
suffix:semicolon
r_struct
id|presto_dentry_data
op_star
id|dd
op_assign
id|presto_d2d
c_func
(paren
id|dir-&gt;f_dentry
)paren
suffix:semicolon
r_int
id|op
suffix:semicolon
id|reinter_t
id|reinter
suffix:semicolon
r_struct
id|izo_rcvd_rec
id|lr_rec
suffix:semicolon
r_int
id|off
suffix:semicolon
id|ENTRY
suffix:semicolon
id|error
op_assign
id|presto_prep
c_func
(paren
id|dir-&gt;f_dentry
comma
op_amp
id|cache
comma
op_amp
id|fset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|CERROR
c_func
(paren
l_string|&quot;intermezzo: Reintegration on invalid file&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|dd
op_logical_or
op_logical_neg
id|dd-&gt;dd_fset
op_logical_or
id|dd-&gt;dd_fset-&gt;fset_dentry
op_ne
id|dir-&gt;f_dentry
)paren
(brace
id|CERROR
c_func
(paren
l_string|&quot;intermezzo: reintegration on non-fset root (ino %ld)&bslash;n&quot;
comma
id|dir-&gt;f_dentry-&gt;d_inode-&gt;i_ino
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|data-&gt;ioc_plen1
OG
l_int|64
op_star
l_int|1024
)paren
(brace
id|EXIT
suffix:semicolon
r_return
op_minus
id|ENOSPC
suffix:semicolon
)brace
id|ptr
op_assign
id|fset-&gt;fset_reint_buf
suffix:semicolon
id|end
op_assign
id|ptr
op_plus
id|data-&gt;ioc_plen1
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|ptr
comma
id|data-&gt;ioc_pbuf1
comma
id|data-&gt;ioc_plen1
)paren
)paren
(brace
id|EXIT
suffix:semicolon
id|error
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|error
op_assign
id|kml_unpack
c_func
(paren
op_amp
id|rec
comma
op_amp
id|ptr
comma
id|end
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
id|error
op_assign
op_minus
id|EFAULT
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|off
op_assign
id|izo_rcvd_get
c_func
(paren
op_amp
id|lr_rec
comma
id|fset
comma
id|data-&gt;ioc_uuid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|off
OL
l_int|0
)paren
(brace
id|CERROR
c_func
(paren
l_string|&quot;No last_rcvd record, setting to 0&bslash;n&quot;
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|lr_rec
comma
l_int|0
comma
r_sizeof
(paren
id|lr_rec
)paren
)paren
suffix:semicolon
)brace
id|data-&gt;ioc_kmlsize
op_assign
id|ptr
op_minus
id|fset-&gt;fset_reint_buf
suffix:semicolon
r_if
c_cond
(paren
id|rec.suffix-&gt;recno
op_ne
id|lr_rec.lr_remote_recno
op_plus
l_int|1
)paren
(brace
id|CERROR
c_func
(paren
l_string|&quot;KML record number %Lu expected, not %d&bslash;n&quot;
comma
id|lr_rec.lr_remote_recno
op_plus
l_int|1
comma
id|rec.suffix-&gt;recno
)paren
suffix:semicolon
macro_line|#if 0
r_if
c_cond
(paren
op_logical_neg
id|version_check
c_func
(paren
op_amp
id|rec
comma
id|dd-&gt;dd_fset
comma
op_amp
id|info
)paren
)paren
(brace
multiline_comment|/* FIXME: do an upcall to resolve conflicts */
id|CERROR
c_func
(paren
l_string|&quot;intermezzo: would be a conflict!&bslash;n&quot;
)paren
suffix:semicolon
id|error
op_assign
op_minus
id|EINVAL
suffix:semicolon
id|EXIT
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
macro_line|#endif
)brace
id|op
op_assign
id|rec.prefix.hdr-&gt;opcode
suffix:semicolon
id|reinter
op_assign
id|get_reinter
c_func
(paren
id|op
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|reinter
)paren
(brace
id|CERROR
c_func
(paren
l_string|&quot;%s: Unrecognized KML opcode %d&bslash;n&quot;
comma
id|__FUNCTION__
comma
id|op
)paren
suffix:semicolon
id|error
op_assign
op_minus
id|EINVAL
suffix:semicolon
id|EXIT
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|info.kml_offset
op_assign
id|data-&gt;ioc_offset
op_plus
id|data-&gt;ioc_kmlsize
suffix:semicolon
id|info.recno
op_assign
id|rec.suffix-&gt;recno
suffix:semicolon
id|info.flags
op_assign
id|LENTO_FL_EXPECT
suffix:semicolon
r_if
c_cond
(paren
id|data-&gt;ioc_flags
)paren
id|info.flags
op_or_assign
id|LENTO_FL_KML
suffix:semicolon
id|memcpy
c_func
(paren
id|info.uuid
comma
id|data-&gt;ioc_uuid
comma
r_sizeof
(paren
id|info.uuid
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fset-&gt;fset_flags
op_amp
id|FSET_IS_BRANCH
op_logical_and
id|data-&gt;ioc_flags
)paren
id|error
op_assign
id|branch_reinter
c_func
(paren
id|fset
comma
op_amp
id|rec
comma
id|dir
comma
op_amp
id|info
comma
id|fset-&gt;fset_reint_buf
comma
id|data-&gt;ioc_kmlsize
)paren
suffix:semicolon
r_else
id|error
op_assign
id|reinter
c_func
(paren
op_amp
id|rec
comma
id|dir
comma
op_amp
id|info
)paren
suffix:semicolon
id|out
suffix:colon
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
DECL|function|izo_get_fileid
r_int
id|izo_get_fileid
c_func
(paren
r_struct
id|file
op_star
id|dir
comma
r_struct
id|izo_ioctl_data
op_star
id|data
)paren
(brace
r_char
op_star
id|buf
op_assign
l_int|NULL
suffix:semicolon
r_char
op_star
id|ptr
suffix:semicolon
r_char
op_star
id|end
suffix:semicolon
r_struct
id|kml_rec
id|rec
suffix:semicolon
r_struct
id|file
op_star
id|file
suffix:semicolon
r_struct
id|presto_cache
op_star
id|cache
suffix:semicolon
r_struct
id|presto_file_set
op_star
id|fset
suffix:semicolon
r_struct
id|presto_dentry_data
op_star
id|dd
op_assign
id|presto_d2d
c_func
(paren
id|dir-&gt;f_dentry
)paren
suffix:semicolon
r_struct
id|run_ctxt
id|saved_ctxt
suffix:semicolon
r_int
id|error
suffix:semicolon
id|ENTRY
suffix:semicolon
id|error
op_assign
id|presto_prep
c_func
(paren
id|dir-&gt;f_dentry
comma
op_amp
id|cache
comma
op_amp
id|fset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|CERROR
c_func
(paren
l_string|&quot;intermezzo: Reintegration on invalid file&bslash;n&quot;
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|dd
op_logical_or
op_logical_neg
id|dd-&gt;dd_fset
op_logical_or
id|dd-&gt;dd_fset-&gt;fset_dentry
op_ne
id|dir-&gt;f_dentry
)paren
(brace
id|CERROR
c_func
(paren
l_string|&quot;intermezzo: reintegration on non-fset root (ino %ld)&bslash;n&quot;
comma
id|dir-&gt;f_dentry-&gt;d_inode-&gt;i_ino
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|PRESTO_ALLOC
c_func
(paren
id|buf
comma
id|data-&gt;ioc_plen1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|buf
)paren
(brace
id|EXIT
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|ptr
op_assign
id|buf
suffix:semicolon
id|end
op_assign
id|buf
op_plus
id|data-&gt;ioc_plen1
suffix:semicolon
r_if
c_cond
(paren
id|copy_from_user
c_func
(paren
id|buf
comma
id|data-&gt;ioc_pbuf1
comma
id|data-&gt;ioc_plen1
)paren
)paren
(brace
id|EXIT
suffix:semicolon
id|PRESTO_FREE
c_func
(paren
id|buf
comma
id|data-&gt;ioc_plen1
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|error
op_assign
id|kml_unpack
c_func
(paren
op_amp
id|rec
comma
op_amp
id|ptr
comma
id|end
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
(brace
id|EXIT
suffix:semicolon
id|PRESTO_FREE
c_func
(paren
id|buf
comma
id|data-&gt;ioc_plen1
)paren
suffix:semicolon
r_return
op_minus
id|EFAULT
suffix:semicolon
)brace
id|kmlreint_pre_secure
c_func
(paren
op_amp
id|rec
comma
id|dir
comma
op_amp
id|saved_ctxt
)paren
suffix:semicolon
id|file
op_assign
id|filp_open
c_func
(paren
id|rec.path
comma
id|O_RDONLY
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|file
op_logical_or
id|IS_ERR
c_func
(paren
id|file
)paren
)paren
(brace
id|error
op_assign
id|PTR_ERR
c_func
(paren
id|file
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|data-&gt;ioc_ino
op_assign
id|file-&gt;f_dentry-&gt;d_inode-&gt;i_ino
suffix:semicolon
id|data-&gt;ioc_generation
op_assign
id|file-&gt;f_dentry-&gt;d_inode-&gt;i_generation
suffix:semicolon
id|filp_close
c_func
(paren
id|file
comma
l_int|0
)paren
suffix:semicolon
id|CDEBUG
c_func
(paren
id|D_FILE
comma
l_string|&quot;%s ino %Lx, gen %Lx&bslash;n&quot;
comma
id|rec.path
comma
id|data-&gt;ioc_ino
comma
id|data-&gt;ioc_generation
)paren
suffix:semicolon
id|out
suffix:colon
r_if
c_cond
(paren
id|buf
)paren
id|PRESTO_FREE
c_func
(paren
id|buf
comma
id|data-&gt;ioc_plen1
)paren
suffix:semicolon
id|pop_ctxt
c_func
(paren
op_amp
id|saved_ctxt
)paren
suffix:semicolon
id|EXIT
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
eof
