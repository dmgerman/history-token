multiline_comment|/*&n; * Copyright (c) 2002 Red Hat, Inc. All rights reserved.&n; *&n; * This software may be freely redistributed under the terms of the&n; * GNU General Public License.&n; *&n; * You should have received a copy of the GNU General Public License&n; * along with this program; if not, write to the Free Software&n; * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.&n; *&n; * Authors: David Woodhouse &lt;dwmw2@cambridge.redhat.com&gt;&n; *          David Howells &lt;dhowells@redhat.com&gt;&n; *&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &quot;server.h&quot;
macro_line|#include &quot;vnode.h&quot;
macro_line|#include &quot;internal.h&quot;
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * allow the fileserver to request callback state (re-)initialisation&n; */
DECL|function|SRXAFSCM_InitCallBackState
r_int
id|SRXAFSCM_InitCallBackState
c_func
(paren
id|afs_server_t
op_star
id|server
)paren
(brace
r_struct
id|list_head
id|callbacks
suffix:semicolon
id|_enter
c_func
(paren
l_string|&quot;%p&quot;
comma
id|server
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|callbacks
)paren
suffix:semicolon
multiline_comment|/* transfer the callback list from the server to a temp holding area */
id|spin_lock
c_func
(paren
op_amp
id|server-&gt;cb_lock
)paren
suffix:semicolon
id|list_add
c_func
(paren
op_amp
id|callbacks
comma
op_amp
id|server-&gt;cb_promises
)paren
suffix:semicolon
id|list_del_init
c_func
(paren
op_amp
id|server-&gt;cb_promises
)paren
suffix:semicolon
multiline_comment|/* munch our way through the list, grabbing the inode, dropping all the locks and regetting&n;&t; * them in the right order&n;&t; */
r_while
c_loop
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|callbacks
)paren
)paren
(brace
r_struct
id|inode
op_star
id|inode
suffix:semicolon
id|afs_vnode_t
op_star
id|vnode
suffix:semicolon
id|vnode
op_assign
id|list_entry
c_func
(paren
id|callbacks.next
comma
id|afs_vnode_t
comma
id|cb_link
)paren
suffix:semicolon
id|list_del_init
c_func
(paren
op_amp
id|vnode-&gt;cb_link
)paren
suffix:semicolon
multiline_comment|/* try and grab the inode - may fail */
id|inode
op_assign
id|igrab
c_func
(paren
id|AFS_VNODE_TO_I
c_func
(paren
id|vnode
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inode
)paren
(brace
r_int
id|release
op_assign
l_int|0
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|server-&gt;cb_lock
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|vnode-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vnode-&gt;cb_server
op_eq
id|server
)paren
(brace
id|vnode-&gt;cb_server
op_assign
l_int|NULL
suffix:semicolon
id|afs_kafstimod_del_timer
c_func
(paren
op_amp
id|vnode-&gt;cb_timeout
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|afs_cb_hash_lock
)paren
suffix:semicolon
id|list_del_init
c_func
(paren
op_amp
id|vnode-&gt;cb_hash_link
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|afs_cb_hash_lock
)paren
suffix:semicolon
id|release
op_assign
l_int|1
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|vnode-&gt;lock
)paren
suffix:semicolon
id|iput
c_func
(paren
id|inode
)paren
suffix:semicolon
r_if
c_cond
(paren
id|release
)paren
id|afs_put_server
c_func
(paren
id|server
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|server-&gt;cb_lock
)paren
suffix:semicolon
)brace
)brace
id|spin_unlock
c_func
(paren
op_amp
id|server-&gt;cb_lock
)paren
suffix:semicolon
id|_leave
c_func
(paren
l_string|&quot; = 0&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* end SRXAFSCM_InitCallBackState() */
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * allow the fileserver to break callback promises&n; */
DECL|function|SRXAFSCM_CallBack
r_int
id|SRXAFSCM_CallBack
c_func
(paren
id|afs_server_t
op_star
id|server
comma
r_int
id|count
comma
id|afs_callback_t
id|callbacks
(braket
)braket
)paren
(brace
r_struct
id|list_head
op_star
id|_p
suffix:semicolon
id|_enter
c_func
(paren
l_string|&quot;%p,%u,&quot;
comma
id|server
comma
id|count
)paren
suffix:semicolon
r_for
c_loop
(paren
suffix:semicolon
id|count
OG
l_int|0
suffix:semicolon
id|callbacks
op_increment
comma
id|count
op_decrement
)paren
(brace
r_struct
id|inode
op_star
id|inode
op_assign
l_int|NULL
suffix:semicolon
id|afs_vnode_t
op_star
id|vnode
op_assign
l_int|NULL
suffix:semicolon
r_int
id|valid
op_assign
l_int|0
suffix:semicolon
id|_debug
c_func
(paren
l_string|&quot;- Fid { vl=%08x n=%u u=%u }  CB { v=%u x=%u t=%u }&quot;
comma
id|callbacks-&gt;fid.vid
comma
id|callbacks-&gt;fid.vnode
comma
id|callbacks-&gt;fid.unique
comma
id|callbacks-&gt;version
comma
id|callbacks-&gt;expiry
comma
id|callbacks-&gt;type
)paren
suffix:semicolon
multiline_comment|/* find the inode for this fid */
id|spin_lock
c_func
(paren
op_amp
id|afs_cb_hash_lock
)paren
suffix:semicolon
id|list_for_each
c_func
(paren
id|_p
comma
op_amp
id|afs_cb_hash
c_func
(paren
id|server
comma
op_amp
id|callbacks-&gt;fid
)paren
)paren
(brace
id|vnode
op_assign
id|list_entry
c_func
(paren
id|_p
comma
id|afs_vnode_t
comma
id|cb_hash_link
)paren
suffix:semicolon
r_if
c_cond
(paren
id|memcmp
c_func
(paren
op_amp
id|vnode-&gt;fid
comma
op_amp
id|callbacks-&gt;fid
comma
r_sizeof
(paren
id|afs_fid_t
)paren
)paren
op_ne
l_int|0
)paren
r_continue
suffix:semicolon
multiline_comment|/* right vnode, but is it same server? */
r_if
c_cond
(paren
id|vnode-&gt;cb_server
op_ne
id|server
)paren
r_break
suffix:semicolon
multiline_comment|/* no */
multiline_comment|/* try and nail the inode down */
id|inode
op_assign
id|igrab
c_func
(paren
id|AFS_VNODE_TO_I
c_func
(paren
id|vnode
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|afs_cb_hash_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inode
)paren
(brace
multiline_comment|/* we&squot;ve found the record for this vnode */
id|spin_lock
c_func
(paren
op_amp
id|vnode-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vnode-&gt;cb_server
op_eq
id|server
)paren
(brace
multiline_comment|/* the callback _is_ on the calling server */
id|vnode-&gt;cb_server
op_assign
l_int|NULL
suffix:semicolon
id|valid
op_assign
l_int|1
suffix:semicolon
id|afs_kafstimod_del_timer
c_func
(paren
op_amp
id|vnode-&gt;cb_timeout
)paren
suffix:semicolon
id|vnode-&gt;flags
op_or_assign
id|AFS_VNODE_CHANGED
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|server-&gt;cb_lock
)paren
suffix:semicolon
id|list_del_init
c_func
(paren
op_amp
id|vnode-&gt;cb_link
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|server-&gt;cb_lock
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|afs_cb_hash_lock
)paren
suffix:semicolon
id|list_del_init
c_func
(paren
op_amp
id|vnode-&gt;cb_hash_link
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|afs_cb_hash_lock
)paren
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|vnode-&gt;lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|valid
)paren
(brace
id|invalidate_remote_inode
c_func
(paren
id|inode
)paren
suffix:semicolon
id|afs_put_server
c_func
(paren
id|server
)paren
suffix:semicolon
)brace
id|iput
c_func
(paren
id|inode
)paren
suffix:semicolon
)brace
)brace
id|_leave
c_func
(paren
l_string|&quot; = 0&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* end SRXAFSCM_CallBack() */
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * allow the fileserver to see if the cache manager is still alive&n; */
DECL|function|SRXAFSCM_Probe
r_int
id|SRXAFSCM_Probe
c_func
(paren
id|afs_server_t
op_star
id|server
)paren
(brace
id|_debug
c_func
(paren
l_string|&quot;SRXAFSCM_Probe(%p)&bslash;n&quot;
comma
id|server
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* end SRXAFSCM_Probe() */
eof
