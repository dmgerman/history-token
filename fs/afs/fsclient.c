multiline_comment|/* fsclient.c: AFS File Server client stubs&n; *&n; * Copyright (C) 2002 Red Hat, Inc. All Rights Reserved.&n; * Written by David Howells (dhowells@redhat.com)&n; *&n; * This program is free software; you can redistribute it and/or&n; * modify it under the terms of the GNU General Public License&n; * as published by the Free Software Foundation; either version&n; * 2 of the License, or (at your option) any later version.&n; */
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;rxrpc/rxrpc.h&gt;
macro_line|#include &lt;rxrpc/transport.h&gt;
macro_line|#include &lt;rxrpc/connection.h&gt;
macro_line|#include &lt;rxrpc/call.h&gt;
macro_line|#include &quot;fsclient.h&quot;
macro_line|#include &quot;cmservice.h&quot;
macro_line|#include &quot;vnode.h&quot;
macro_line|#include &quot;server.h&quot;
macro_line|#include &quot;errors.h&quot;
macro_line|#include &quot;internal.h&quot;
DECL|macro|FSFETCHSTATUS
mdefine_line|#define FSFETCHSTATUS&t;&t;132&t;/* AFS Fetch file status */
DECL|macro|FSFETCHDATA
mdefine_line|#define FSFETCHDATA&t;&t;130&t;/* AFS Fetch file data */
DECL|macro|FSGIVEUPCALLBACKS
mdefine_line|#define FSGIVEUPCALLBACKS&t;147&t;/* AFS Discard callback promises */
DECL|macro|FSGETVOLUMEINFO
mdefine_line|#define FSGETVOLUMEINFO&t;&t;148&t;/* AFS Get root volume information */
DECL|macro|FSGETROOTVOLUME
mdefine_line|#define FSGETROOTVOLUME&t;&t;151&t;/* AFS Get root volume name */
DECL|macro|FSLOOKUP
mdefine_line|#define FSLOOKUP&t;&t;161&t;/* AFS lookup file in directory */
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * map afs abort codes to/from Linux error codes&n; * - called with call-&gt;lock held&n; */
DECL|function|afs_rxfs_aemap
r_static
r_void
id|afs_rxfs_aemap
c_func
(paren
r_struct
id|rxrpc_call
op_star
id|call
)paren
(brace
r_switch
c_cond
(paren
id|call-&gt;app_err_state
)paren
(brace
r_case
id|RXRPC_ESTATE_LOCAL_ABORT
suffix:colon
id|call-&gt;app_abort_code
op_assign
op_minus
id|call-&gt;app_errno
suffix:semicolon
r_break
suffix:semicolon
r_case
id|RXRPC_ESTATE_PEER_ABORT
suffix:colon
id|call-&gt;app_errno
op_assign
id|afs_abort_to_error
c_func
(paren
id|call-&gt;app_abort_code
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
)brace
multiline_comment|/* end afs_rxfs_aemap() */
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * get the root volume name from a fileserver&n; * - this operation doesn&squot;t seem to work correctly in OpenAFS server 1.2.2&n; */
macro_line|#if 0
r_int
id|afs_rxfs_get_root_volume
c_func
(paren
r_struct
id|afs_server
op_star
id|server
comma
r_char
op_star
id|buf
comma
r_int
op_star
id|buflen
)paren
(brace
r_struct
id|rxrpc_connection
op_star
id|conn
suffix:semicolon
r_struct
id|rxrpc_call
op_star
id|call
suffix:semicolon
r_struct
id|kvec
id|piov
(braket
l_int|2
)braket
suffix:semicolon
r_int
id|sent
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|u32
id|param
(braket
l_int|1
)braket
suffix:semicolon
id|DECLARE_WAITQUEUE
c_func
(paren
id|myself
comma
id|current
)paren
suffix:semicolon
id|kenter
c_func
(paren
l_string|&quot;%p,%p,%u&quot;
comma
id|server
comma
id|buf
comma
op_star
id|buflen
)paren
suffix:semicolon
multiline_comment|/* get hold of the fileserver connection */
id|ret
op_assign
id|afs_server_get_fsconn
c_func
(paren
id|server
comma
op_amp
id|conn
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* create a call through that connection */
id|ret
op_assign
id|rxrpc_create_call
c_func
(paren
id|conn
comma
l_int|NULL
comma
l_int|NULL
comma
id|afs_rxfs_aemap
comma
op_amp
id|call
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;kAFS: Unable to create call: %d&bslash;n&quot;
comma
id|ret
)paren
suffix:semicolon
r_goto
id|out_put_conn
suffix:semicolon
)brace
id|call-&gt;app_opcode
op_assign
id|FSGETROOTVOLUME
suffix:semicolon
multiline_comment|/* we want to get event notifications from the call */
id|add_wait_queue
c_func
(paren
op_amp
id|call-&gt;waitq
comma
op_amp
id|myself
)paren
suffix:semicolon
multiline_comment|/* marshall the parameters */
id|param
(braket
l_int|0
)braket
op_assign
id|htonl
c_func
(paren
id|FSGETROOTVOLUME
)paren
suffix:semicolon
id|piov
(braket
l_int|0
)braket
dot
id|iov_len
op_assign
r_sizeof
(paren
id|param
)paren
suffix:semicolon
id|piov
(braket
l_int|0
)braket
dot
id|iov_base
op_assign
id|param
suffix:semicolon
multiline_comment|/* send the parameters to the server */
id|ret
op_assign
id|rxrpc_call_write_data
c_func
(paren
id|call
comma
l_int|1
comma
id|piov
comma
id|RXRPC_LAST_PACKET
comma
id|GFP_NOFS
comma
l_int|0
comma
op_amp
id|sent
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
r_goto
m_abort
suffix:semicolon
multiline_comment|/* wait for the reply to completely arrive */
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|call-&gt;app_call_state
op_ne
id|RXRPC_CSTATE_CLNT_RCV_REPLY
op_logical_or
id|signal_pending
c_func
(paren
id|current
)paren
)paren
r_break
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
)brace
id|set_current_state
c_func
(paren
id|TASK_RUNNING
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|EINTR
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
r_goto
m_abort
suffix:semicolon
r_switch
c_cond
(paren
id|call-&gt;app_call_state
)paren
(brace
r_case
id|RXRPC_CSTATE_ERROR
suffix:colon
id|ret
op_assign
id|call-&gt;app_errno
suffix:semicolon
id|kdebug
c_func
(paren
l_string|&quot;Got Error: %d&quot;
comma
id|ret
)paren
suffix:semicolon
r_goto
id|out_unwait
suffix:semicolon
r_case
id|RXRPC_CSTATE_CLNT_GOT_REPLY
suffix:colon
multiline_comment|/* read the reply */
id|kdebug
c_func
(paren
l_string|&quot;Got Reply: qty=%d&quot;
comma
id|call-&gt;app_ready_qty
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|EBADMSG
suffix:semicolon
r_if
c_cond
(paren
id|call-&gt;app_ready_qty
op_le
l_int|4
)paren
r_goto
m_abort
suffix:semicolon
id|ret
op_assign
id|rxrpc_call_read_data
c_func
(paren
id|call
comma
l_int|NULL
comma
id|call-&gt;app_ready_qty
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
r_goto
m_abort
suffix:semicolon
macro_line|#if 0
multiline_comment|/* unmarshall the reply */
id|bp
op_assign
id|buffer
suffix:semicolon
r_for
c_loop
(paren
id|loop
op_assign
l_int|0
suffix:semicolon
id|loop
OL
l_int|65
suffix:semicolon
id|loop
op_increment
)paren
id|entry-&gt;name
(braket
id|loop
)braket
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
id|entry-&gt;name
(braket
l_int|64
)braket
op_assign
l_int|0
suffix:semicolon
id|entry-&gt;type
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
id|entry-&gt;num_servers
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
r_for
c_loop
(paren
id|loop
op_assign
l_int|0
suffix:semicolon
id|loop
OL
l_int|8
suffix:semicolon
id|loop
op_increment
)paren
id|entry-&gt;servers
(braket
id|loop
)braket
dot
id|addr.s_addr
op_assign
op_star
id|bp
op_increment
suffix:semicolon
r_for
c_loop
(paren
id|loop
op_assign
l_int|0
suffix:semicolon
id|loop
OL
l_int|8
suffix:semicolon
id|loop
op_increment
)paren
id|entry-&gt;servers
(braket
id|loop
)braket
dot
id|partition
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
r_for
c_loop
(paren
id|loop
op_assign
l_int|0
suffix:semicolon
id|loop
OL
l_int|8
suffix:semicolon
id|loop
op_increment
)paren
id|entry-&gt;servers
(braket
id|loop
)braket
dot
id|flags
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
r_for
c_loop
(paren
id|loop
op_assign
l_int|0
suffix:semicolon
id|loop
OL
l_int|3
suffix:semicolon
id|loop
op_increment
)paren
id|entry-&gt;volume_ids
(braket
id|loop
)braket
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
id|entry-&gt;clone_id
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
id|entry-&gt;flags
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
)paren
suffix:semicolon
macro_line|#endif
multiline_comment|/* success */
id|ret
op_assign
l_int|0
suffix:semicolon
r_goto
id|out_unwait
suffix:semicolon
r_default
suffix:colon
id|BUG
c_func
(paren
)paren
suffix:semicolon
)brace
m_abort
suffix:colon
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|rxrpc_call_abort
c_func
(paren
id|call
comma
id|ret
)paren
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
id|out_unwait
suffix:colon
id|set_current_state
c_func
(paren
id|TASK_RUNNING
)paren
suffix:semicolon
id|remove_wait_queue
c_func
(paren
op_amp
id|call-&gt;waitq
comma
op_amp
id|myself
)paren
suffix:semicolon
id|rxrpc_put_call
c_func
(paren
id|call
)paren
suffix:semicolon
id|out_put_conn
suffix:colon
id|afs_server_release_fsconn
c_func
(paren
id|server
comma
id|conn
)paren
suffix:semicolon
id|out
suffix:colon
id|kleave
c_func
(paren
l_string|&quot;&quot;
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* end afs_rxfs_get_root_volume() */
macro_line|#endif
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * get information about a volume&n; */
macro_line|#if 0
r_int
id|afs_rxfs_get_volume_info
c_func
(paren
r_struct
id|afs_server
op_star
id|server
comma
r_const
r_char
op_star
id|name
comma
r_struct
id|afs_volume_info
op_star
id|vinfo
)paren
(brace
r_struct
id|rxrpc_connection
op_star
id|conn
suffix:semicolon
r_struct
id|rxrpc_call
op_star
id|call
suffix:semicolon
r_struct
id|kvec
id|piov
(braket
l_int|3
)braket
suffix:semicolon
r_int
id|sent
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|u32
id|param
(braket
l_int|2
)braket
comma
op_star
id|bp
comma
id|zero
suffix:semicolon
id|DECLARE_WAITQUEUE
c_func
(paren
id|myself
comma
id|current
)paren
suffix:semicolon
id|_enter
c_func
(paren
l_string|&quot;%p,%s,%p&quot;
comma
id|server
comma
id|name
comma
id|vinfo
)paren
suffix:semicolon
multiline_comment|/* get hold of the fileserver connection */
id|ret
op_assign
id|afs_server_get_fsconn
c_func
(paren
id|server
comma
op_amp
id|conn
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* create a call through that connection */
id|ret
op_assign
id|rxrpc_create_call
c_func
(paren
id|conn
comma
l_int|NULL
comma
l_int|NULL
comma
id|afs_rxfs_aemap
comma
op_amp
id|call
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;kAFS: Unable to create call: %d&bslash;n&quot;
comma
id|ret
)paren
suffix:semicolon
r_goto
id|out_put_conn
suffix:semicolon
)brace
id|call-&gt;app_opcode
op_assign
id|FSGETVOLUMEINFO
suffix:semicolon
multiline_comment|/* we want to get event notifications from the call */
id|add_wait_queue
c_func
(paren
op_amp
id|call-&gt;waitq
comma
op_amp
id|myself
)paren
suffix:semicolon
multiline_comment|/* marshall the parameters */
id|piov
(braket
l_int|1
)braket
dot
id|iov_len
op_assign
id|strlen
c_func
(paren
id|name
)paren
suffix:semicolon
id|piov
(braket
l_int|1
)braket
dot
id|iov_base
op_assign
(paren
r_char
op_star
)paren
id|name
suffix:semicolon
id|zero
op_assign
l_int|0
suffix:semicolon
id|piov
(braket
l_int|2
)braket
dot
id|iov_len
op_assign
(paren
l_int|4
op_minus
(paren
id|piov
(braket
l_int|1
)braket
dot
id|iov_len
op_amp
l_int|3
)paren
)paren
op_amp
l_int|3
suffix:semicolon
id|piov
(braket
l_int|2
)braket
dot
id|iov_base
op_assign
op_amp
id|zero
suffix:semicolon
id|param
(braket
l_int|0
)braket
op_assign
id|htonl
c_func
(paren
id|FSGETVOLUMEINFO
)paren
suffix:semicolon
id|param
(braket
l_int|1
)braket
op_assign
id|htonl
c_func
(paren
id|piov
(braket
l_int|1
)braket
dot
id|iov_len
)paren
suffix:semicolon
id|piov
(braket
l_int|0
)braket
dot
id|iov_len
op_assign
r_sizeof
(paren
id|param
)paren
suffix:semicolon
id|piov
(braket
l_int|0
)braket
dot
id|iov_base
op_assign
id|param
suffix:semicolon
multiline_comment|/* send the parameters to the server */
id|ret
op_assign
id|rxrpc_call_write_data
c_func
(paren
id|call
comma
l_int|3
comma
id|piov
comma
id|RXRPC_LAST_PACKET
comma
id|GFP_NOFS
comma
l_int|0
comma
op_amp
id|sent
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
r_goto
m_abort
suffix:semicolon
multiline_comment|/* wait for the reply to completely arrive */
id|bp
op_assign
id|rxrpc_call_alloc_scratch
c_func
(paren
id|call
comma
l_int|64
)paren
suffix:semicolon
id|ret
op_assign
id|rxrpc_call_read_data
c_func
(paren
id|call
comma
id|bp
comma
l_int|64
comma
id|RXRPC_CALL_READ_BLOCK
op_or
id|RXRPC_CALL_READ_ALL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|ret
op_eq
op_minus
id|ECONNABORTED
)paren
(brace
id|ret
op_assign
id|call-&gt;app_errno
suffix:semicolon
r_goto
id|out_unwait
suffix:semicolon
)brace
r_goto
m_abort
suffix:semicolon
)brace
multiline_comment|/* unmarshall the reply */
id|vinfo-&gt;vid
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
id|vinfo-&gt;type
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
id|vinfo-&gt;type_vids
(braket
l_int|0
)braket
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
id|vinfo-&gt;type_vids
(braket
l_int|1
)braket
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
id|vinfo-&gt;type_vids
(braket
l_int|2
)braket
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
id|vinfo-&gt;type_vids
(braket
l_int|3
)braket
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
id|vinfo-&gt;type_vids
(braket
l_int|4
)braket
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
id|vinfo-&gt;nservers
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
id|vinfo-&gt;servers
(braket
l_int|0
)braket
dot
id|addr.s_addr
op_assign
op_star
id|bp
op_increment
suffix:semicolon
id|vinfo-&gt;servers
(braket
l_int|1
)braket
dot
id|addr.s_addr
op_assign
op_star
id|bp
op_increment
suffix:semicolon
id|vinfo-&gt;servers
(braket
l_int|2
)braket
dot
id|addr.s_addr
op_assign
op_star
id|bp
op_increment
suffix:semicolon
id|vinfo-&gt;servers
(braket
l_int|3
)braket
dot
id|addr.s_addr
op_assign
op_star
id|bp
op_increment
suffix:semicolon
id|vinfo-&gt;servers
(braket
l_int|4
)braket
dot
id|addr.s_addr
op_assign
op_star
id|bp
op_increment
suffix:semicolon
id|vinfo-&gt;servers
(braket
l_int|5
)braket
dot
id|addr.s_addr
op_assign
op_star
id|bp
op_increment
suffix:semicolon
id|vinfo-&gt;servers
(braket
l_int|6
)braket
dot
id|addr.s_addr
op_assign
op_star
id|bp
op_increment
suffix:semicolon
id|vinfo-&gt;servers
(braket
l_int|7
)braket
dot
id|addr.s_addr
op_assign
op_star
id|bp
op_increment
suffix:semicolon
id|ret
op_assign
op_minus
id|EBADMSG
suffix:semicolon
r_if
c_cond
(paren
id|vinfo-&gt;nservers
OG
l_int|8
)paren
r_goto
m_abort
suffix:semicolon
multiline_comment|/* success */
id|ret
op_assign
l_int|0
suffix:semicolon
id|out_unwait
suffix:colon
id|set_current_state
c_func
(paren
id|TASK_RUNNING
)paren
suffix:semicolon
id|remove_wait_queue
c_func
(paren
op_amp
id|call-&gt;waitq
comma
op_amp
id|myself
)paren
suffix:semicolon
id|rxrpc_put_call
c_func
(paren
id|call
)paren
suffix:semicolon
id|out_put_conn
suffix:colon
id|afs_server_release_fsconn
c_func
(paren
id|server
comma
id|conn
)paren
suffix:semicolon
id|out
suffix:colon
id|_leave
c_func
(paren
l_string|&quot;&quot;
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
m_abort
suffix:colon
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|rxrpc_call_abort
c_func
(paren
id|call
comma
id|ret
)paren
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
r_goto
id|out_unwait
suffix:semicolon
)brace
multiline_comment|/* end afs_rxfs_get_volume_info() */
macro_line|#endif
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * fetch the status information for a file&n; */
DECL|function|afs_rxfs_fetch_file_status
r_int
id|afs_rxfs_fetch_file_status
c_func
(paren
r_struct
id|afs_server
op_star
id|server
comma
r_struct
id|afs_vnode
op_star
id|vnode
comma
r_struct
id|afs_volsync
op_star
id|volsync
)paren
(brace
r_struct
id|afs_server_callslot
id|callslot
suffix:semicolon
r_struct
id|rxrpc_call
op_star
id|call
suffix:semicolon
r_struct
id|kvec
id|piov
(braket
l_int|1
)braket
suffix:semicolon
r_int
id|sent
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|__be32
op_star
id|bp
suffix:semicolon
id|DECLARE_WAITQUEUE
c_func
(paren
id|myself
comma
id|current
)paren
suffix:semicolon
id|_enter
c_func
(paren
l_string|&quot;%p,{%u,%u,%u}&quot;
comma
id|server
comma
id|vnode-&gt;fid.vid
comma
id|vnode-&gt;fid.vnode
comma
id|vnode-&gt;fid.unique
)paren
suffix:semicolon
multiline_comment|/* get hold of the fileserver connection */
id|ret
op_assign
id|afs_server_request_callslot
c_func
(paren
id|server
comma
op_amp
id|callslot
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* create a call through that connection */
id|ret
op_assign
id|rxrpc_create_call
c_func
(paren
id|callslot.conn
comma
l_int|NULL
comma
l_int|NULL
comma
id|afs_rxfs_aemap
comma
op_amp
id|call
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;kAFS: Unable to create call: %d&bslash;n&quot;
comma
id|ret
)paren
suffix:semicolon
r_goto
id|out_put_conn
suffix:semicolon
)brace
id|call-&gt;app_opcode
op_assign
id|FSFETCHSTATUS
suffix:semicolon
multiline_comment|/* we want to get event notifications from the call */
id|add_wait_queue
c_func
(paren
op_amp
id|call-&gt;waitq
comma
op_amp
id|myself
)paren
suffix:semicolon
multiline_comment|/* marshall the parameters */
id|bp
op_assign
id|rxrpc_call_alloc_scratch
c_func
(paren
id|call
comma
l_int|16
)paren
suffix:semicolon
id|bp
(braket
l_int|0
)braket
op_assign
id|htonl
c_func
(paren
id|FSFETCHSTATUS
)paren
suffix:semicolon
id|bp
(braket
l_int|1
)braket
op_assign
id|htonl
c_func
(paren
id|vnode-&gt;fid.vid
)paren
suffix:semicolon
id|bp
(braket
l_int|2
)braket
op_assign
id|htonl
c_func
(paren
id|vnode-&gt;fid.vnode
)paren
suffix:semicolon
id|bp
(braket
l_int|3
)braket
op_assign
id|htonl
c_func
(paren
id|vnode-&gt;fid.unique
)paren
suffix:semicolon
id|piov
(braket
l_int|0
)braket
dot
id|iov_len
op_assign
l_int|16
suffix:semicolon
id|piov
(braket
l_int|0
)braket
dot
id|iov_base
op_assign
id|bp
suffix:semicolon
multiline_comment|/* send the parameters to the server */
id|ret
op_assign
id|rxrpc_call_write_data
c_func
(paren
id|call
comma
l_int|1
comma
id|piov
comma
id|RXRPC_LAST_PACKET
comma
id|GFP_NOFS
comma
l_int|0
comma
op_amp
id|sent
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
r_goto
m_abort
suffix:semicolon
multiline_comment|/* wait for the reply to completely arrive */
id|bp
op_assign
id|rxrpc_call_alloc_scratch
c_func
(paren
id|call
comma
l_int|120
)paren
suffix:semicolon
id|ret
op_assign
id|rxrpc_call_read_data
c_func
(paren
id|call
comma
id|bp
comma
l_int|120
comma
id|RXRPC_CALL_READ_BLOCK
op_or
id|RXRPC_CALL_READ_ALL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|ret
op_eq
op_minus
id|ECONNABORTED
)paren
(brace
id|ret
op_assign
id|call-&gt;app_errno
suffix:semicolon
r_goto
id|out_unwait
suffix:semicolon
)brace
r_goto
m_abort
suffix:semicolon
)brace
multiline_comment|/* unmarshall the reply */
id|vnode-&gt;status.if_version
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
id|vnode-&gt;status.type
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
id|vnode-&gt;status.nlink
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
id|vnode-&gt;status.size
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
id|vnode-&gt;status.version
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
id|vnode-&gt;status.author
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
id|vnode-&gt;status.owner
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
id|vnode-&gt;status.caller_access
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
id|vnode-&gt;status.anon_access
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
id|vnode-&gt;status.mode
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
id|vnode-&gt;status.parent.vid
op_assign
id|vnode-&gt;fid.vid
suffix:semicolon
id|vnode-&gt;status.parent.vnode
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
id|vnode-&gt;status.parent.unique
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
id|bp
op_increment
suffix:semicolon
multiline_comment|/* seg size */
id|vnode-&gt;status.mtime_client
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
id|vnode-&gt;status.mtime_server
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
id|bp
op_increment
suffix:semicolon
multiline_comment|/* group */
id|bp
op_increment
suffix:semicolon
multiline_comment|/* sync counter */
id|vnode-&gt;status.version
op_or_assign
(paren
(paren
r_int
r_int
r_int
)paren
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
)paren
op_lshift
l_int|32
suffix:semicolon
id|bp
op_increment
suffix:semicolon
multiline_comment|/* spare2 */
id|bp
op_increment
suffix:semicolon
multiline_comment|/* spare3 */
id|bp
op_increment
suffix:semicolon
multiline_comment|/* spare4 */
id|vnode-&gt;cb_version
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
id|vnode-&gt;cb_expiry
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
id|vnode-&gt;cb_type
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
r_if
c_cond
(paren
id|volsync
)paren
(brace
id|volsync-&gt;creation
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
id|bp
op_increment
suffix:semicolon
multiline_comment|/* spare2 */
id|bp
op_increment
suffix:semicolon
multiline_comment|/* spare3 */
id|bp
op_increment
suffix:semicolon
multiline_comment|/* spare4 */
id|bp
op_increment
suffix:semicolon
multiline_comment|/* spare5 */
id|bp
op_increment
suffix:semicolon
multiline_comment|/* spare6 */
)brace
multiline_comment|/* success */
id|ret
op_assign
l_int|0
suffix:semicolon
id|out_unwait
suffix:colon
id|set_current_state
c_func
(paren
id|TASK_RUNNING
)paren
suffix:semicolon
id|remove_wait_queue
c_func
(paren
op_amp
id|call-&gt;waitq
comma
op_amp
id|myself
)paren
suffix:semicolon
id|rxrpc_put_call
c_func
(paren
id|call
)paren
suffix:semicolon
id|out_put_conn
suffix:colon
id|afs_server_release_callslot
c_func
(paren
id|server
comma
op_amp
id|callslot
)paren
suffix:semicolon
id|out
suffix:colon
id|_leave
c_func
(paren
l_string|&quot;&quot;
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
m_abort
suffix:colon
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|rxrpc_call_abort
c_func
(paren
id|call
comma
id|ret
)paren
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
r_goto
id|out_unwait
suffix:semicolon
)brace
multiline_comment|/* end afs_rxfs_fetch_file_status() */
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * fetch the contents of a file or directory&n; */
DECL|function|afs_rxfs_fetch_file_data
r_int
id|afs_rxfs_fetch_file_data
c_func
(paren
r_struct
id|afs_server
op_star
id|server
comma
r_struct
id|afs_vnode
op_star
id|vnode
comma
r_struct
id|afs_rxfs_fetch_descriptor
op_star
id|desc
comma
r_struct
id|afs_volsync
op_star
id|volsync
)paren
(brace
r_struct
id|afs_server_callslot
id|callslot
suffix:semicolon
r_struct
id|rxrpc_call
op_star
id|call
suffix:semicolon
r_struct
id|kvec
id|piov
(braket
l_int|1
)braket
suffix:semicolon
r_int
id|sent
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|__be32
op_star
id|bp
suffix:semicolon
id|DECLARE_WAITQUEUE
c_func
(paren
id|myself
comma
id|current
)paren
suffix:semicolon
id|_enter
c_func
(paren
l_string|&quot;%p,{fid={%u,%u,%u},sz=%Zu,of=%lu}&quot;
comma
id|server
comma
id|desc-&gt;fid.vid
comma
id|desc-&gt;fid.vnode
comma
id|desc-&gt;fid.unique
comma
id|desc-&gt;size
comma
id|desc-&gt;offset
)paren
suffix:semicolon
multiline_comment|/* get hold of the fileserver connection */
id|ret
op_assign
id|afs_server_request_callslot
c_func
(paren
id|server
comma
op_amp
id|callslot
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* create a call through that connection */
id|ret
op_assign
id|rxrpc_create_call
c_func
(paren
id|callslot.conn
comma
l_int|NULL
comma
l_int|NULL
comma
id|afs_rxfs_aemap
comma
op_amp
id|call
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;kAFS: Unable to create call: %d&bslash;n&quot;
comma
id|ret
)paren
suffix:semicolon
r_goto
id|out_put_conn
suffix:semicolon
)brace
id|call-&gt;app_opcode
op_assign
id|FSFETCHDATA
suffix:semicolon
multiline_comment|/* we want to get event notifications from the call */
id|add_wait_queue
c_func
(paren
op_amp
id|call-&gt;waitq
comma
op_amp
id|myself
)paren
suffix:semicolon
multiline_comment|/* marshall the parameters */
id|bp
op_assign
id|rxrpc_call_alloc_scratch
c_func
(paren
id|call
comma
l_int|24
)paren
suffix:semicolon
id|bp
(braket
l_int|0
)braket
op_assign
id|htonl
c_func
(paren
id|FSFETCHDATA
)paren
suffix:semicolon
id|bp
(braket
l_int|1
)braket
op_assign
id|htonl
c_func
(paren
id|desc-&gt;fid.vid
)paren
suffix:semicolon
id|bp
(braket
l_int|2
)braket
op_assign
id|htonl
c_func
(paren
id|desc-&gt;fid.vnode
)paren
suffix:semicolon
id|bp
(braket
l_int|3
)braket
op_assign
id|htonl
c_func
(paren
id|desc-&gt;fid.unique
)paren
suffix:semicolon
id|bp
(braket
l_int|4
)braket
op_assign
id|htonl
c_func
(paren
id|desc-&gt;offset
)paren
suffix:semicolon
id|bp
(braket
l_int|5
)braket
op_assign
id|htonl
c_func
(paren
id|desc-&gt;size
)paren
suffix:semicolon
id|piov
(braket
l_int|0
)braket
dot
id|iov_len
op_assign
l_int|24
suffix:semicolon
id|piov
(braket
l_int|0
)braket
dot
id|iov_base
op_assign
id|bp
suffix:semicolon
multiline_comment|/* send the parameters to the server */
id|ret
op_assign
id|rxrpc_call_write_data
c_func
(paren
id|call
comma
l_int|1
comma
id|piov
comma
id|RXRPC_LAST_PACKET
comma
id|GFP_NOFS
comma
l_int|0
comma
op_amp
id|sent
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
r_goto
m_abort
suffix:semicolon
multiline_comment|/* wait for the data count to arrive */
id|ret
op_assign
id|rxrpc_call_read_data
c_func
(paren
id|call
comma
id|bp
comma
l_int|4
comma
id|RXRPC_CALL_READ_BLOCK
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
r_goto
id|read_failed
suffix:semicolon
id|desc-&gt;actual
op_assign
id|ntohl
c_func
(paren
id|bp
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|desc-&gt;actual
op_ne
id|desc-&gt;size
)paren
(brace
id|ret
op_assign
op_minus
id|EBADMSG
suffix:semicolon
r_goto
m_abort
suffix:semicolon
)brace
multiline_comment|/* call the app to read the actual data */
id|rxrpc_call_reset_scratch
c_func
(paren
id|call
)paren
suffix:semicolon
id|ret
op_assign
id|rxrpc_call_read_data
c_func
(paren
id|call
comma
id|desc-&gt;buffer
comma
id|desc-&gt;actual
comma
id|RXRPC_CALL_READ_BLOCK
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
r_goto
id|read_failed
suffix:semicolon
multiline_comment|/* wait for the rest of the reply to completely arrive */
id|rxrpc_call_reset_scratch
c_func
(paren
id|call
)paren
suffix:semicolon
id|bp
op_assign
id|rxrpc_call_alloc_scratch
c_func
(paren
id|call
comma
l_int|120
)paren
suffix:semicolon
id|ret
op_assign
id|rxrpc_call_read_data
c_func
(paren
id|call
comma
id|bp
comma
l_int|120
comma
id|RXRPC_CALL_READ_BLOCK
op_or
id|RXRPC_CALL_READ_ALL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
r_goto
id|read_failed
suffix:semicolon
multiline_comment|/* unmarshall the reply */
id|vnode-&gt;status.if_version
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
id|vnode-&gt;status.type
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
id|vnode-&gt;status.nlink
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
id|vnode-&gt;status.size
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
id|vnode-&gt;status.version
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
id|vnode-&gt;status.author
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
id|vnode-&gt;status.owner
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
id|vnode-&gt;status.caller_access
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
id|vnode-&gt;status.anon_access
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
id|vnode-&gt;status.mode
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
id|vnode-&gt;status.parent.vid
op_assign
id|desc-&gt;fid.vid
suffix:semicolon
id|vnode-&gt;status.parent.vnode
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
id|vnode-&gt;status.parent.unique
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
id|bp
op_increment
suffix:semicolon
multiline_comment|/* seg size */
id|vnode-&gt;status.mtime_client
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
id|vnode-&gt;status.mtime_server
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
id|bp
op_increment
suffix:semicolon
multiline_comment|/* group */
id|bp
op_increment
suffix:semicolon
multiline_comment|/* sync counter */
id|vnode-&gt;status.version
op_or_assign
(paren
(paren
r_int
r_int
r_int
)paren
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
)paren
op_lshift
l_int|32
suffix:semicolon
id|bp
op_increment
suffix:semicolon
multiline_comment|/* spare2 */
id|bp
op_increment
suffix:semicolon
multiline_comment|/* spare3 */
id|bp
op_increment
suffix:semicolon
multiline_comment|/* spare4 */
id|vnode-&gt;cb_version
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
id|vnode-&gt;cb_expiry
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
id|vnode-&gt;cb_type
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
r_if
c_cond
(paren
id|volsync
)paren
(brace
id|volsync-&gt;creation
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
id|bp
op_increment
suffix:semicolon
multiline_comment|/* spare2 */
id|bp
op_increment
suffix:semicolon
multiline_comment|/* spare3 */
id|bp
op_increment
suffix:semicolon
multiline_comment|/* spare4 */
id|bp
op_increment
suffix:semicolon
multiline_comment|/* spare5 */
id|bp
op_increment
suffix:semicolon
multiline_comment|/* spare6 */
)brace
multiline_comment|/* success */
id|ret
op_assign
l_int|0
suffix:semicolon
id|out_unwait
suffix:colon
id|set_current_state
c_func
(paren
id|TASK_RUNNING
)paren
suffix:semicolon
id|remove_wait_queue
c_func
(paren
op_amp
id|call-&gt;waitq
comma
op_amp
id|myself
)paren
suffix:semicolon
id|rxrpc_put_call
c_func
(paren
id|call
)paren
suffix:semicolon
id|out_put_conn
suffix:colon
id|afs_server_release_callslot
c_func
(paren
id|server
comma
op_amp
id|callslot
)paren
suffix:semicolon
id|out
suffix:colon
id|_leave
c_func
(paren
l_string|&quot; = %d&quot;
comma
id|ret
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
id|read_failed
suffix:colon
r_if
c_cond
(paren
id|ret
op_eq
op_minus
id|ECONNABORTED
)paren
(brace
id|ret
op_assign
id|call-&gt;app_errno
suffix:semicolon
r_goto
id|out_unwait
suffix:semicolon
)brace
m_abort
suffix:colon
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|rxrpc_call_abort
c_func
(paren
id|call
comma
id|ret
)paren
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
r_goto
id|out_unwait
suffix:semicolon
)brace
multiline_comment|/* end afs_rxfs_fetch_file_data() */
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * ask the AFS fileserver to discard a callback request on a file&n; */
DECL|function|afs_rxfs_give_up_callback
r_int
id|afs_rxfs_give_up_callback
c_func
(paren
r_struct
id|afs_server
op_star
id|server
comma
r_struct
id|afs_vnode
op_star
id|vnode
)paren
(brace
r_struct
id|afs_server_callslot
id|callslot
suffix:semicolon
r_struct
id|rxrpc_call
op_star
id|call
suffix:semicolon
r_struct
id|kvec
id|piov
(braket
l_int|1
)braket
suffix:semicolon
r_int
id|sent
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|__be32
op_star
id|bp
suffix:semicolon
id|DECLARE_WAITQUEUE
c_func
(paren
id|myself
comma
id|current
)paren
suffix:semicolon
id|_enter
c_func
(paren
l_string|&quot;%p,{%u,%u,%u}&quot;
comma
id|server
comma
id|vnode-&gt;fid.vid
comma
id|vnode-&gt;fid.vnode
comma
id|vnode-&gt;fid.unique
)paren
suffix:semicolon
multiline_comment|/* get hold of the fileserver connection */
id|ret
op_assign
id|afs_server_request_callslot
c_func
(paren
id|server
comma
op_amp
id|callslot
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* create a call through that connection */
id|ret
op_assign
id|rxrpc_create_call
c_func
(paren
id|callslot.conn
comma
l_int|NULL
comma
l_int|NULL
comma
id|afs_rxfs_aemap
comma
op_amp
id|call
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;kAFS: Unable to create call: %d&bslash;n&quot;
comma
id|ret
)paren
suffix:semicolon
r_goto
id|out_put_conn
suffix:semicolon
)brace
id|call-&gt;app_opcode
op_assign
id|FSGIVEUPCALLBACKS
suffix:semicolon
multiline_comment|/* we want to get event notifications from the call */
id|add_wait_queue
c_func
(paren
op_amp
id|call-&gt;waitq
comma
op_amp
id|myself
)paren
suffix:semicolon
multiline_comment|/* marshall the parameters */
id|bp
op_assign
id|rxrpc_call_alloc_scratch
c_func
(paren
id|call
comma
(paren
l_int|1
op_plus
l_int|4
op_plus
l_int|4
)paren
op_star
l_int|4
)paren
suffix:semicolon
id|piov
(braket
l_int|0
)braket
dot
id|iov_len
op_assign
(paren
l_int|1
op_plus
l_int|4
op_plus
l_int|4
)paren
op_star
l_int|4
suffix:semicolon
id|piov
(braket
l_int|0
)braket
dot
id|iov_base
op_assign
id|bp
suffix:semicolon
op_star
id|bp
op_increment
op_assign
id|htonl
c_func
(paren
id|FSGIVEUPCALLBACKS
)paren
suffix:semicolon
op_star
id|bp
op_increment
op_assign
id|htonl
c_func
(paren
l_int|1
)paren
suffix:semicolon
op_star
id|bp
op_increment
op_assign
id|htonl
c_func
(paren
id|vnode-&gt;fid.vid
)paren
suffix:semicolon
op_star
id|bp
op_increment
op_assign
id|htonl
c_func
(paren
id|vnode-&gt;fid.vnode
)paren
suffix:semicolon
op_star
id|bp
op_increment
op_assign
id|htonl
c_func
(paren
id|vnode-&gt;fid.unique
)paren
suffix:semicolon
op_star
id|bp
op_increment
op_assign
id|htonl
c_func
(paren
l_int|1
)paren
suffix:semicolon
op_star
id|bp
op_increment
op_assign
id|htonl
c_func
(paren
id|vnode-&gt;cb_version
)paren
suffix:semicolon
op_star
id|bp
op_increment
op_assign
id|htonl
c_func
(paren
id|vnode-&gt;cb_expiry
)paren
suffix:semicolon
op_star
id|bp
op_increment
op_assign
id|htonl
c_func
(paren
id|vnode-&gt;cb_type
)paren
suffix:semicolon
multiline_comment|/* send the parameters to the server */
id|ret
op_assign
id|rxrpc_call_write_data
c_func
(paren
id|call
comma
l_int|1
comma
id|piov
comma
id|RXRPC_LAST_PACKET
comma
id|GFP_NOFS
comma
l_int|0
comma
op_amp
id|sent
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
r_goto
m_abort
suffix:semicolon
multiline_comment|/* wait for the reply to completely arrive */
r_for
c_loop
(paren
suffix:semicolon
suffix:semicolon
)paren
(brace
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|call-&gt;app_call_state
op_ne
id|RXRPC_CSTATE_CLNT_RCV_REPLY
op_logical_or
id|signal_pending
c_func
(paren
id|current
)paren
)paren
r_break
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
)brace
id|set_current_state
c_func
(paren
id|TASK_RUNNING
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|EINTR
suffix:semicolon
r_if
c_cond
(paren
id|signal_pending
c_func
(paren
id|current
)paren
)paren
r_goto
m_abort
suffix:semicolon
r_switch
c_cond
(paren
id|call-&gt;app_call_state
)paren
(brace
r_case
id|RXRPC_CSTATE_ERROR
suffix:colon
id|ret
op_assign
id|call-&gt;app_errno
suffix:semicolon
r_goto
id|out_unwait
suffix:semicolon
r_case
id|RXRPC_CSTATE_CLNT_GOT_REPLY
suffix:colon
id|ret
op_assign
l_int|0
suffix:semicolon
r_goto
id|out_unwait
suffix:semicolon
r_default
suffix:colon
id|BUG
c_func
(paren
)paren
suffix:semicolon
)brace
id|out_unwait
suffix:colon
id|set_current_state
c_func
(paren
id|TASK_RUNNING
)paren
suffix:semicolon
id|remove_wait_queue
c_func
(paren
op_amp
id|call-&gt;waitq
comma
op_amp
id|myself
)paren
suffix:semicolon
id|rxrpc_put_call
c_func
(paren
id|call
)paren
suffix:semicolon
id|out_put_conn
suffix:colon
id|afs_server_release_callslot
c_func
(paren
id|server
comma
op_amp
id|callslot
)paren
suffix:semicolon
id|out
suffix:colon
id|_leave
c_func
(paren
l_string|&quot;&quot;
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
m_abort
suffix:colon
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|rxrpc_call_abort
c_func
(paren
id|call
comma
id|ret
)paren
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
r_goto
id|out_unwait
suffix:semicolon
)brace
multiline_comment|/* end afs_rxfs_give_up_callback() */
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * look a filename up in a directory&n; * - this operation doesn&squot;t seem to work correctly in OpenAFS server 1.2.2&n; */
macro_line|#if 0
r_int
id|afs_rxfs_lookup
c_func
(paren
r_struct
id|afs_server
op_star
id|server
comma
r_struct
id|afs_vnode
op_star
id|dir
comma
r_const
r_char
op_star
id|filename
comma
r_struct
id|afs_vnode
op_star
id|vnode
comma
r_struct
id|afs_volsync
op_star
id|volsync
)paren
(brace
r_struct
id|rxrpc_connection
op_star
id|conn
suffix:semicolon
r_struct
id|rxrpc_call
op_star
id|call
suffix:semicolon
r_struct
id|kvec
id|piov
(braket
l_int|3
)braket
suffix:semicolon
r_int
id|sent
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|u32
op_star
id|bp
comma
id|zero
suffix:semicolon
id|DECLARE_WAITQUEUE
c_func
(paren
id|myself
comma
id|current
)paren
suffix:semicolon
id|kenter
c_func
(paren
l_string|&quot;%p,{%u,%u,%u},%s&quot;
comma
id|server
comma
id|fid-&gt;vid
comma
id|fid-&gt;vnode
comma
id|fid-&gt;unique
comma
id|filename
)paren
suffix:semicolon
multiline_comment|/* get hold of the fileserver connection */
id|ret
op_assign
id|afs_server_get_fsconn
c_func
(paren
id|server
comma
op_amp
id|conn
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* create a call through that connection */
id|ret
op_assign
id|rxrpc_create_call
c_func
(paren
id|conn
comma
l_int|NULL
comma
l_int|NULL
comma
id|afs_rxfs_aemap
comma
op_amp
id|call
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;kAFS: Unable to create call: %d&bslash;n&quot;
comma
id|ret
)paren
suffix:semicolon
r_goto
id|out_put_conn
suffix:semicolon
)brace
id|call-&gt;app_opcode
op_assign
id|FSLOOKUP
suffix:semicolon
multiline_comment|/* we want to get event notifications from the call */
id|add_wait_queue
c_func
(paren
op_amp
id|call-&gt;waitq
comma
op_amp
id|myself
)paren
suffix:semicolon
multiline_comment|/* marshall the parameters */
id|bp
op_assign
id|rxrpc_call_alloc_scratch
c_func
(paren
id|call
comma
l_int|20
)paren
suffix:semicolon
id|zero
op_assign
l_int|0
suffix:semicolon
id|piov
(braket
l_int|0
)braket
dot
id|iov_len
op_assign
l_int|20
suffix:semicolon
id|piov
(braket
l_int|0
)braket
dot
id|iov_base
op_assign
id|bp
suffix:semicolon
id|piov
(braket
l_int|1
)braket
dot
id|iov_len
op_assign
id|strlen
c_func
(paren
id|filename
)paren
suffix:semicolon
id|piov
(braket
l_int|1
)braket
dot
id|iov_base
op_assign
(paren
r_char
op_star
)paren
id|filename
suffix:semicolon
id|piov
(braket
l_int|2
)braket
dot
id|iov_len
op_assign
(paren
l_int|4
op_minus
(paren
id|piov
(braket
l_int|1
)braket
dot
id|iov_len
op_amp
l_int|3
)paren
)paren
op_amp
l_int|3
suffix:semicolon
id|piov
(braket
l_int|2
)braket
dot
id|iov_base
op_assign
op_amp
id|zero
suffix:semicolon
op_star
id|bp
op_increment
op_assign
id|htonl
c_func
(paren
id|FSLOOKUP
)paren
suffix:semicolon
op_star
id|bp
op_increment
op_assign
id|htonl
c_func
(paren
id|dirfid-&gt;vid
)paren
suffix:semicolon
op_star
id|bp
op_increment
op_assign
id|htonl
c_func
(paren
id|dirfid-&gt;vnode
)paren
suffix:semicolon
op_star
id|bp
op_increment
op_assign
id|htonl
c_func
(paren
id|dirfid-&gt;unique
)paren
suffix:semicolon
op_star
id|bp
op_increment
op_assign
id|htonl
c_func
(paren
id|piov
(braket
l_int|1
)braket
dot
id|iov_len
)paren
suffix:semicolon
multiline_comment|/* send the parameters to the server */
id|ret
op_assign
id|rxrpc_call_write_data
c_func
(paren
id|call
comma
l_int|3
comma
id|piov
comma
id|RXRPC_LAST_PACKET
comma
id|GFP_NOFS
comma
l_int|0
comma
op_amp
id|sent
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
r_goto
m_abort
suffix:semicolon
multiline_comment|/* wait for the reply to completely arrive */
id|bp
op_assign
id|rxrpc_call_alloc_scratch
c_func
(paren
id|call
comma
l_int|220
)paren
suffix:semicolon
id|ret
op_assign
id|rxrpc_call_read_data
c_func
(paren
id|call
comma
id|bp
comma
l_int|220
comma
id|RXRPC_CALL_READ_BLOCK
op_or
id|RXRPC_CALL_READ_ALL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|ret
op_eq
op_minus
id|ECONNABORTED
)paren
(brace
id|ret
op_assign
id|call-&gt;app_errno
suffix:semicolon
r_goto
id|out_unwait
suffix:semicolon
)brace
r_goto
m_abort
suffix:semicolon
)brace
multiline_comment|/* unmarshall the reply */
id|fid-&gt;vid
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
id|fid-&gt;vnode
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
id|fid-&gt;unique
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
id|vnode-&gt;status.if_version
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
id|vnode-&gt;status.type
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
id|vnode-&gt;status.nlink
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
id|vnode-&gt;status.size
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
id|vnode-&gt;status.version
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
id|vnode-&gt;status.author
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
id|vnode-&gt;status.owner
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
id|vnode-&gt;status.caller_access
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
id|vnode-&gt;status.anon_access
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
id|vnode-&gt;status.mode
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
id|vnode-&gt;status.parent.vid
op_assign
id|dirfid-&gt;vid
suffix:semicolon
id|vnode-&gt;status.parent.vnode
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
id|vnode-&gt;status.parent.unique
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
id|bp
op_increment
suffix:semicolon
multiline_comment|/* seg size */
id|vnode-&gt;status.mtime_client
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
id|vnode-&gt;status.mtime_server
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
id|bp
op_increment
suffix:semicolon
multiline_comment|/* group */
id|bp
op_increment
suffix:semicolon
multiline_comment|/* sync counter */
id|vnode-&gt;status.version
op_or_assign
(paren
(paren
r_int
r_int
r_int
)paren
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
)paren
op_lshift
l_int|32
suffix:semicolon
id|bp
op_increment
suffix:semicolon
multiline_comment|/* spare2 */
id|bp
op_increment
suffix:semicolon
multiline_comment|/* spare3 */
id|bp
op_increment
suffix:semicolon
multiline_comment|/* spare4 */
id|dir-&gt;status.if_version
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
id|dir-&gt;status.type
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
id|dir-&gt;status.nlink
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
id|dir-&gt;status.size
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
id|dir-&gt;status.version
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
id|dir-&gt;status.author
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
id|dir-&gt;status.owner
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
id|dir-&gt;status.caller_access
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
id|dir-&gt;status.anon_access
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
id|dir-&gt;status.mode
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
id|dir-&gt;status.parent.vid
op_assign
id|dirfid-&gt;vid
suffix:semicolon
id|dir-&gt;status.parent.vnode
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
id|dir-&gt;status.parent.unique
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
id|bp
op_increment
suffix:semicolon
multiline_comment|/* seg size */
id|dir-&gt;status.mtime_client
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
id|dir-&gt;status.mtime_server
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
id|bp
op_increment
suffix:semicolon
multiline_comment|/* group */
id|bp
op_increment
suffix:semicolon
multiline_comment|/* sync counter */
id|dir-&gt;status.version
op_or_assign
(paren
(paren
r_int
r_int
r_int
)paren
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
)paren
op_lshift
l_int|32
suffix:semicolon
id|bp
op_increment
suffix:semicolon
multiline_comment|/* spare2 */
id|bp
op_increment
suffix:semicolon
multiline_comment|/* spare3 */
id|bp
op_increment
suffix:semicolon
multiline_comment|/* spare4 */
id|callback-&gt;fid
op_assign
op_star
id|fid
suffix:semicolon
id|callback-&gt;version
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
id|callback-&gt;expiry
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
id|callback-&gt;type
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
r_if
c_cond
(paren
id|volsync
)paren
(brace
id|volsync-&gt;creation
op_assign
id|ntohl
c_func
(paren
op_star
id|bp
op_increment
)paren
suffix:semicolon
id|bp
op_increment
suffix:semicolon
multiline_comment|/* spare2 */
id|bp
op_increment
suffix:semicolon
multiline_comment|/* spare3 */
id|bp
op_increment
suffix:semicolon
multiline_comment|/* spare4 */
id|bp
op_increment
suffix:semicolon
multiline_comment|/* spare5 */
id|bp
op_increment
suffix:semicolon
multiline_comment|/* spare6 */
)brace
multiline_comment|/* success */
id|ret
op_assign
l_int|0
suffix:semicolon
id|out_unwait
suffix:colon
id|set_current_state
c_func
(paren
id|TASK_RUNNING
)paren
suffix:semicolon
id|remove_wait_queue
c_func
(paren
op_amp
id|call-&gt;waitq
comma
op_amp
id|myself
)paren
suffix:semicolon
id|rxrpc_put_call
c_func
(paren
id|call
)paren
suffix:semicolon
id|out_put_conn
suffix:colon
id|afs_server_release_fsconn
c_func
(paren
id|server
comma
id|conn
)paren
suffix:semicolon
id|out
suffix:colon
id|kleave
c_func
(paren
l_string|&quot;&quot;
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
m_abort
suffix:colon
id|set_current_state
c_func
(paren
id|TASK_UNINTERRUPTIBLE
)paren
suffix:semicolon
id|rxrpc_call_abort
c_func
(paren
id|call
comma
id|ret
)paren
suffix:semicolon
id|schedule
c_func
(paren
)paren
suffix:semicolon
r_goto
id|out_unwait
suffix:semicolon
)brace
multiline_comment|/* end afs_rxfs_lookup() */
macro_line|#endif
eof
