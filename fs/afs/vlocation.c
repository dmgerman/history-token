multiline_comment|/* vlocation.c: volume location management&n; *&n; * Copyright (C) 2002 Red Hat, Inc. All Rights Reserved.&n; * Written by David Howells (dhowells@redhat.com)&n; *&n; * This program is free software; you can redistribute it and/or&n; * modify it under the terms of the GNU General Public License&n; * as published by the Free Software Foundation; either version&n; * 2 of the License, or (at your option) any later version.&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/pagemap.h&gt;
macro_line|#include &quot;volume.h&quot;
macro_line|#include &quot;cell.h&quot;
macro_line|#include &quot;cmservice.h&quot;
macro_line|#include &quot;fsclient.h&quot;
macro_line|#include &quot;vlclient.h&quot;
macro_line|#include &quot;kafstimod.h&quot;
macro_line|#include &lt;rxrpc/connection.h&gt;
macro_line|#include &quot;internal.h&quot;
DECL|macro|AFS_VLDB_TIMEOUT
mdefine_line|#define AFS_VLDB_TIMEOUT HZ*1000
r_static
r_void
id|afs_vlocation_update_timer
c_func
(paren
r_struct
id|afs_timer
op_star
id|timer
)paren
suffix:semicolon
r_static
r_void
id|afs_vlocation_update_attend
c_func
(paren
r_struct
id|afs_async_op
op_star
id|op
)paren
suffix:semicolon
r_static
r_void
id|afs_vlocation_update_discard
c_func
(paren
r_struct
id|afs_async_op
op_star
id|op
)paren
suffix:semicolon
r_static
r_void
id|__afs_put_vlocation
c_func
(paren
r_struct
id|afs_vlocation
op_star
id|vlocation
)paren
suffix:semicolon
DECL|function|__afs_vlocation_timeout
r_static
r_void
id|__afs_vlocation_timeout
c_func
(paren
r_struct
id|afs_timer
op_star
id|timer
)paren
(brace
r_struct
id|afs_vlocation
op_star
id|vlocation
op_assign
id|list_entry
c_func
(paren
id|timer
comma
r_struct
id|afs_vlocation
comma
id|timeout
)paren
suffix:semicolon
id|_debug
c_func
(paren
l_string|&quot;VL TIMEOUT [%s{u=%d}]&quot;
comma
id|vlocation-&gt;vldb.name
comma
id|atomic_read
c_func
(paren
op_amp
id|vlocation-&gt;usage
)paren
)paren
suffix:semicolon
id|afs_vlocation_do_timeout
c_func
(paren
id|vlocation
)paren
suffix:semicolon
)brace
DECL|variable|afs_vlocation_timer_ops
r_static
r_const
r_struct
id|afs_timer_ops
id|afs_vlocation_timer_ops
op_assign
(brace
dot
id|timed_out
op_assign
id|__afs_vlocation_timeout
comma
)brace
suffix:semicolon
DECL|variable|afs_vlocation_update_timer_ops
r_static
r_const
r_struct
id|afs_timer_ops
id|afs_vlocation_update_timer_ops
op_assign
(brace
dot
id|timed_out
op_assign
id|afs_vlocation_update_timer
comma
)brace
suffix:semicolon
DECL|variable|afs_vlocation_update_op_ops
r_static
r_const
r_struct
id|afs_async_op_ops
id|afs_vlocation_update_op_ops
op_assign
(brace
dot
id|attend
op_assign
id|afs_vlocation_update_attend
comma
dot
id|discard
op_assign
id|afs_vlocation_update_discard
comma
)brace
suffix:semicolon
r_static
id|LIST_HEAD
c_func
(paren
id|afs_vlocation_update_pendq
)paren
suffix:semicolon
multiline_comment|/* queue of VLs awaiting update */
DECL|variable|afs_vlocation_update
r_static
r_struct
id|afs_vlocation
op_star
id|afs_vlocation_update
suffix:semicolon
multiline_comment|/* VL currently being updated */
r_static
id|DEFINE_SPINLOCK
c_func
(paren
id|afs_vlocation_update_lock
)paren
suffix:semicolon
multiline_comment|/* lock guarding update queue */
macro_line|#ifdef AFS_CACHING_SUPPORT
r_static
id|cachefs_match_val_t
id|afs_vlocation_cache_match
c_func
(paren
r_void
op_star
id|target
comma
r_const
r_void
op_star
id|entry
)paren
suffix:semicolon
r_static
r_void
id|afs_vlocation_cache_update
c_func
(paren
r_void
op_star
id|source
comma
r_void
op_star
id|entry
)paren
suffix:semicolon
DECL|variable|afs_vlocation_cache_index_def
r_struct
id|cachefs_index_def
id|afs_vlocation_cache_index_def
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;vldb&quot;
comma
dot
id|data_size
op_assign
r_sizeof
(paren
r_struct
id|afs_cache_vlocation
)paren
comma
dot
id|keys
(braket
l_int|0
)braket
op_assign
(brace
id|CACHEFS_INDEX_KEYS_ASCIIZ
comma
l_int|64
)brace
comma
dot
id|match
op_assign
id|afs_vlocation_cache_match
comma
dot
id|update
op_assign
id|afs_vlocation_cache_update
comma
)brace
suffix:semicolon
macro_line|#endif
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * iterate through the VL servers in a cell until one of them admits knowing&n; * about the volume in question&n; * - caller must have cell-&gt;vl_sem write-locked&n; */
DECL|function|afs_vlocation_access_vl_by_name
r_static
r_int
id|afs_vlocation_access_vl_by_name
c_func
(paren
r_struct
id|afs_vlocation
op_star
id|vlocation
comma
r_const
r_char
op_star
id|name
comma
r_int
id|namesz
comma
r_struct
id|afs_cache_vlocation
op_star
id|vldb
)paren
(brace
r_struct
id|afs_server
op_star
id|server
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|afs_cell
op_star
id|cell
op_assign
id|vlocation-&gt;cell
suffix:semicolon
r_int
id|count
comma
id|ret
suffix:semicolon
id|_enter
c_func
(paren
l_string|&quot;%s,%*.*s,%u&quot;
comma
id|cell-&gt;name
comma
id|namesz
comma
id|namesz
comma
id|name
comma
id|namesz
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|ENOMEDIUM
suffix:semicolon
r_for
c_loop
(paren
id|count
op_assign
id|cell-&gt;vl_naddrs
suffix:semicolon
id|count
OG
l_int|0
suffix:semicolon
id|count
op_decrement
)paren
(brace
id|_debug
c_func
(paren
l_string|&quot;CellServ[%hu]: %08x&quot;
comma
id|cell-&gt;vl_curr_svix
comma
id|cell-&gt;vl_addrs
(braket
id|cell-&gt;vl_curr_svix
)braket
dot
id|s_addr
)paren
suffix:semicolon
multiline_comment|/* try and create a server */
id|ret
op_assign
id|afs_server_lookup
c_func
(paren
id|cell
comma
op_amp
id|cell-&gt;vl_addrs
(braket
id|cell-&gt;vl_curr_svix
)braket
comma
op_amp
id|server
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|ret
)paren
(brace
r_case
l_int|0
suffix:colon
r_break
suffix:semicolon
r_case
op_minus
id|ENOMEM
suffix:colon
r_case
op_minus
id|ENONET
suffix:colon
r_goto
id|out
suffix:semicolon
r_default
suffix:colon
r_goto
id|rotate
suffix:semicolon
)brace
multiline_comment|/* attempt to access the VL server */
id|ret
op_assign
id|afs_rxvl_get_entry_by_name
c_func
(paren
id|server
comma
id|name
comma
id|namesz
comma
id|vldb
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|ret
)paren
(brace
r_case
l_int|0
suffix:colon
id|afs_put_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
r_case
op_minus
id|ENOMEM
suffix:colon
r_case
op_minus
id|ENONET
suffix:colon
r_case
op_minus
id|ENETUNREACH
suffix:colon
r_case
op_minus
id|EHOSTUNREACH
suffix:colon
r_case
op_minus
id|ECONNREFUSED
suffix:colon
id|down_write
c_func
(paren
op_amp
id|server-&gt;sem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|server-&gt;vlserver
)paren
(brace
id|rxrpc_put_connection
c_func
(paren
id|server-&gt;vlserver
)paren
suffix:semicolon
id|server-&gt;vlserver
op_assign
l_int|NULL
suffix:semicolon
)brace
id|up_write
c_func
(paren
op_amp
id|server-&gt;sem
)paren
suffix:semicolon
id|afs_put_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
op_minus
id|ENOMEM
op_logical_or
id|ret
op_eq
op_minus
id|ENONET
)paren
r_goto
id|out
suffix:semicolon
r_goto
id|rotate
suffix:semicolon
r_case
op_minus
id|ENOMEDIUM
suffix:colon
id|afs_put_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
r_default
suffix:colon
id|afs_put_server
c_func
(paren
id|server
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|ENOMEDIUM
suffix:semicolon
r_goto
id|rotate
suffix:semicolon
)brace
multiline_comment|/* rotate the server records upon lookup failure */
id|rotate
suffix:colon
id|cell-&gt;vl_curr_svix
op_increment
suffix:semicolon
id|cell-&gt;vl_curr_svix
op_mod_assign
id|cell-&gt;vl_naddrs
suffix:semicolon
)brace
id|out
suffix:colon
id|_leave
c_func
(paren
l_string|&quot; = %d&quot;
comma
id|ret
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* end afs_vlocation_access_vl_by_name() */
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * iterate through the VL servers in a cell until one of them admits knowing&n; * about the volume in question&n; * - caller must have cell-&gt;vl_sem write-locked&n; */
DECL|function|afs_vlocation_access_vl_by_id
r_static
r_int
id|afs_vlocation_access_vl_by_id
c_func
(paren
r_struct
id|afs_vlocation
op_star
id|vlocation
comma
id|afs_volid_t
id|volid
comma
id|afs_voltype_t
id|voltype
comma
r_struct
id|afs_cache_vlocation
op_star
id|vldb
)paren
(brace
r_struct
id|afs_server
op_star
id|server
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|afs_cell
op_star
id|cell
op_assign
id|vlocation-&gt;cell
suffix:semicolon
r_int
id|count
comma
id|ret
suffix:semicolon
id|_enter
c_func
(paren
l_string|&quot;%s,%x,%d,&quot;
comma
id|cell-&gt;name
comma
id|volid
comma
id|voltype
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|ENOMEDIUM
suffix:semicolon
r_for
c_loop
(paren
id|count
op_assign
id|cell-&gt;vl_naddrs
suffix:semicolon
id|count
OG
l_int|0
suffix:semicolon
id|count
op_decrement
)paren
(brace
id|_debug
c_func
(paren
l_string|&quot;CellServ[%hu]: %08x&quot;
comma
id|cell-&gt;vl_curr_svix
comma
id|cell-&gt;vl_addrs
(braket
id|cell-&gt;vl_curr_svix
)braket
dot
id|s_addr
)paren
suffix:semicolon
multiline_comment|/* try and create a server */
id|ret
op_assign
id|afs_server_lookup
c_func
(paren
id|cell
comma
op_amp
id|cell-&gt;vl_addrs
(braket
id|cell-&gt;vl_curr_svix
)braket
comma
op_amp
id|server
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|ret
)paren
(brace
r_case
l_int|0
suffix:colon
r_break
suffix:semicolon
r_case
op_minus
id|ENOMEM
suffix:colon
r_case
op_minus
id|ENONET
suffix:colon
r_goto
id|out
suffix:semicolon
r_default
suffix:colon
r_goto
id|rotate
suffix:semicolon
)brace
multiline_comment|/* attempt to access the VL server */
id|ret
op_assign
id|afs_rxvl_get_entry_by_id
c_func
(paren
id|server
comma
id|volid
comma
id|voltype
comma
id|vldb
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|ret
)paren
(brace
r_case
l_int|0
suffix:colon
id|afs_put_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
r_case
op_minus
id|ENOMEM
suffix:colon
r_case
op_minus
id|ENONET
suffix:colon
r_case
op_minus
id|ENETUNREACH
suffix:colon
r_case
op_minus
id|EHOSTUNREACH
suffix:colon
r_case
op_minus
id|ECONNREFUSED
suffix:colon
id|down_write
c_func
(paren
op_amp
id|server-&gt;sem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|server-&gt;vlserver
)paren
(brace
id|rxrpc_put_connection
c_func
(paren
id|server-&gt;vlserver
)paren
suffix:semicolon
id|server-&gt;vlserver
op_assign
l_int|NULL
suffix:semicolon
)brace
id|up_write
c_func
(paren
op_amp
id|server-&gt;sem
)paren
suffix:semicolon
id|afs_put_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
op_minus
id|ENOMEM
op_logical_or
id|ret
op_eq
op_minus
id|ENONET
)paren
r_goto
id|out
suffix:semicolon
r_goto
id|rotate
suffix:semicolon
r_case
op_minus
id|ENOMEDIUM
suffix:colon
id|afs_put_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
r_default
suffix:colon
id|afs_put_server
c_func
(paren
id|server
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|ENOMEDIUM
suffix:semicolon
r_goto
id|rotate
suffix:semicolon
)brace
multiline_comment|/* rotate the server records upon lookup failure */
id|rotate
suffix:colon
id|cell-&gt;vl_curr_svix
op_increment
suffix:semicolon
id|cell-&gt;vl_curr_svix
op_mod_assign
id|cell-&gt;vl_naddrs
suffix:semicolon
)brace
id|out
suffix:colon
id|_leave
c_func
(paren
l_string|&quot; = %d&quot;
comma
id|ret
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* end afs_vlocation_access_vl_by_id() */
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * lookup volume location&n; * - caller must have cell-&gt;vol_sem write-locked&n; * - iterate through the VL servers in a cell until one of them admits knowing&n; *   about the volume in question&n; * - lookup in the local cache if not able to find on the VL server&n; * - insert/update in the local cache if did get a VL response&n; */
DECL|function|afs_vlocation_lookup
r_int
id|afs_vlocation_lookup
c_func
(paren
r_struct
id|afs_cell
op_star
id|cell
comma
r_const
r_char
op_star
id|name
comma
r_int
id|namesz
comma
r_struct
id|afs_vlocation
op_star
op_star
id|_vlocation
)paren
(brace
r_struct
id|afs_cache_vlocation
id|vldb
suffix:semicolon
r_struct
id|afs_vlocation
op_star
id|vlocation
suffix:semicolon
id|afs_voltype_t
id|voltype
suffix:semicolon
id|afs_volid_t
id|vid
suffix:semicolon
r_int
id|active
op_assign
l_int|0
comma
id|ret
suffix:semicolon
id|_enter
c_func
(paren
l_string|&quot;{%s},%*.*s,%u,&quot;
comma
id|cell-&gt;name
comma
id|namesz
comma
id|namesz
comma
id|name
comma
id|namesz
)paren
suffix:semicolon
r_if
c_cond
(paren
id|namesz
OG
r_sizeof
(paren
id|vlocation-&gt;vldb.name
)paren
)paren
(brace
id|_leave
c_func
(paren
l_string|&quot; = -ENAMETOOLONG&quot;
)paren
suffix:semicolon
r_return
op_minus
id|ENAMETOOLONG
suffix:semicolon
)brace
multiline_comment|/* search the cell&squot;s active list first */
id|list_for_each_entry
c_func
(paren
id|vlocation
comma
op_amp
id|cell-&gt;vl_list
comma
id|link
)paren
(brace
r_if
c_cond
(paren
id|namesz
OL
r_sizeof
(paren
id|vlocation-&gt;vldb.name
)paren
op_logical_and
id|vlocation-&gt;vldb.name
(braket
id|namesz
)braket
op_ne
l_char|&squot;&bslash;0&squot;
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|memcmp
c_func
(paren
id|vlocation-&gt;vldb.name
comma
id|name
comma
id|namesz
)paren
op_eq
l_int|0
)paren
r_goto
id|found_in_memory
suffix:semicolon
)brace
multiline_comment|/* search the cell&squot;s graveyard list second */
id|spin_lock
c_func
(paren
op_amp
id|cell-&gt;vl_gylock
)paren
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|vlocation
comma
op_amp
id|cell-&gt;vl_graveyard
comma
id|link
)paren
(brace
r_if
c_cond
(paren
id|namesz
OL
r_sizeof
(paren
id|vlocation-&gt;vldb.name
)paren
op_logical_and
id|vlocation-&gt;vldb.name
(braket
id|namesz
)braket
op_ne
l_char|&squot;&bslash;0&squot;
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|memcmp
c_func
(paren
id|vlocation-&gt;vldb.name
comma
id|name
comma
id|namesz
)paren
op_eq
l_int|0
)paren
r_goto
id|found_in_graveyard
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|cell-&gt;vl_gylock
)paren
suffix:semicolon
multiline_comment|/* not in the cell&squot;s in-memory lists - create a new record */
id|vlocation
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|afs_vlocation
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|vlocation
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|memset
c_func
(paren
id|vlocation
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|afs_vlocation
)paren
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|vlocation-&gt;usage
comma
l_int|1
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|vlocation-&gt;link
)paren
suffix:semicolon
id|rwlock_init
c_func
(paren
op_amp
id|vlocation-&gt;lock
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|vlocation-&gt;vldb.name
comma
id|name
comma
id|namesz
)paren
suffix:semicolon
id|afs_timer_init
c_func
(paren
op_amp
id|vlocation-&gt;timeout
comma
op_amp
id|afs_vlocation_timer_ops
)paren
suffix:semicolon
id|afs_timer_init
c_func
(paren
op_amp
id|vlocation-&gt;upd_timer
comma
op_amp
id|afs_vlocation_update_timer_ops
)paren
suffix:semicolon
id|afs_async_op_init
c_func
(paren
op_amp
id|vlocation-&gt;upd_op
comma
op_amp
id|afs_vlocation_update_op_ops
)paren
suffix:semicolon
id|afs_get_cell
c_func
(paren
id|cell
)paren
suffix:semicolon
id|vlocation-&gt;cell
op_assign
id|cell
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|vlocation-&gt;link
comma
op_amp
id|cell-&gt;vl_list
)paren
suffix:semicolon
macro_line|#ifdef AFS_CACHING_SUPPORT
multiline_comment|/* we want to store it in the cache, plus it might already be&n;&t; * encached */
id|cachefs_acquire_cookie
c_func
(paren
id|cell-&gt;cache
comma
op_amp
id|afs_volume_cache_index_def
comma
id|vlocation
comma
op_amp
id|vlocation-&gt;cache
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vlocation-&gt;valid
)paren
r_goto
id|found_in_cache
suffix:semicolon
macro_line|#endif
multiline_comment|/* try to look up an unknown volume in the cell VL databases by name */
id|ret
op_assign
id|afs_vlocation_access_vl_by_name
c_func
(paren
id|vlocation
comma
id|name
comma
id|namesz
comma
op_amp
id|vldb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;kAFS: failed to locate &squot;%*.*s&squot; in cell &squot;%s&squot;&bslash;n&quot;
comma
id|namesz
comma
id|namesz
comma
id|name
comma
id|cell-&gt;name
)paren
suffix:semicolon
r_goto
id|error
suffix:semicolon
)brace
r_goto
id|found_on_vlserver
suffix:semicolon
id|found_in_graveyard
suffix:colon
multiline_comment|/* found in the graveyard - resurrect */
id|_debug
c_func
(paren
l_string|&quot;found in graveyard&quot;
)paren
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|vlocation-&gt;usage
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|vlocation-&gt;link
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|vlocation-&gt;link
comma
op_amp
id|cell-&gt;vl_list
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|cell-&gt;vl_gylock
)paren
suffix:semicolon
id|afs_kafstimod_del_timer
c_func
(paren
op_amp
id|vlocation-&gt;timeout
)paren
suffix:semicolon
r_goto
id|active
suffix:semicolon
id|found_in_memory
suffix:colon
multiline_comment|/* found in memory - check to see if it&squot;s active */
id|_debug
c_func
(paren
l_string|&quot;found in memory&quot;
)paren
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|vlocation-&gt;usage
)paren
suffix:semicolon
id|active
suffix:colon
id|active
op_assign
l_int|1
suffix:semicolon
macro_line|#ifdef AFS_CACHING_SUPPORT
id|found_in_cache
suffix:colon
macro_line|#endif
multiline_comment|/* try to look up a cached volume in the cell VL databases by ID */
id|_debug
c_func
(paren
l_string|&quot;found in cache&quot;
)paren
suffix:semicolon
id|_debug
c_func
(paren
l_string|&quot;Locally Cached: %s %02x { %08x(%x) %08x(%x) %08x(%x) }&quot;
comma
id|vlocation-&gt;vldb.name
comma
id|vlocation-&gt;vldb.vidmask
comma
id|ntohl
c_func
(paren
id|vlocation-&gt;vldb.servers
(braket
l_int|0
)braket
dot
id|s_addr
)paren
comma
id|vlocation-&gt;vldb.srvtmask
(braket
l_int|0
)braket
comma
id|ntohl
c_func
(paren
id|vlocation-&gt;vldb.servers
(braket
l_int|1
)braket
dot
id|s_addr
)paren
comma
id|vlocation-&gt;vldb.srvtmask
(braket
l_int|1
)braket
comma
id|ntohl
c_func
(paren
id|vlocation-&gt;vldb.servers
(braket
l_int|2
)braket
dot
id|s_addr
)paren
comma
id|vlocation-&gt;vldb.srvtmask
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|_debug
c_func
(paren
l_string|&quot;Vids: %08x %08x %08x&quot;
comma
id|vlocation-&gt;vldb.vid
(braket
l_int|0
)braket
comma
id|vlocation-&gt;vldb.vid
(braket
l_int|1
)braket
comma
id|vlocation-&gt;vldb.vid
(braket
l_int|2
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vlocation-&gt;vldb.vidmask
op_amp
id|AFS_VOL_VTM_RW
)paren
(brace
id|vid
op_assign
id|vlocation-&gt;vldb.vid
(braket
l_int|0
)braket
suffix:semicolon
id|voltype
op_assign
id|AFSVL_RWVOL
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|vlocation-&gt;vldb.vidmask
op_amp
id|AFS_VOL_VTM_RO
)paren
(brace
id|vid
op_assign
id|vlocation-&gt;vldb.vid
(braket
l_int|1
)braket
suffix:semicolon
id|voltype
op_assign
id|AFSVL_ROVOL
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|vlocation-&gt;vldb.vidmask
op_amp
id|AFS_VOL_VTM_BAK
)paren
(brace
id|vid
op_assign
id|vlocation-&gt;vldb.vid
(braket
l_int|2
)braket
suffix:semicolon
id|voltype
op_assign
id|AFSVL_BACKVOL
suffix:semicolon
)brace
r_else
(brace
id|BUG
c_func
(paren
)paren
suffix:semicolon
id|vid
op_assign
l_int|0
suffix:semicolon
id|voltype
op_assign
l_int|0
suffix:semicolon
)brace
id|ret
op_assign
id|afs_vlocation_access_vl_by_id
c_func
(paren
id|vlocation
comma
id|vid
comma
id|voltype
comma
op_amp
id|vldb
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|ret
)paren
(brace
multiline_comment|/* net error */
r_default
suffix:colon
id|printk
c_func
(paren
l_string|&quot;kAFS: failed to volume &squot;%*.*s&squot; (%x) up in &squot;%s&squot;: %d&bslash;n&quot;
comma
id|namesz
comma
id|namesz
comma
id|name
comma
id|vid
comma
id|cell-&gt;name
comma
id|ret
)paren
suffix:semicolon
r_goto
id|error
suffix:semicolon
multiline_comment|/* pulled from local cache into memory */
r_case
l_int|0
suffix:colon
r_goto
id|found_on_vlserver
suffix:semicolon
multiline_comment|/* uh oh... looks like the volume got deleted */
r_case
op_minus
id|ENOMEDIUM
suffix:colon
id|printk
c_func
(paren
l_string|&quot;kAFS: volume &squot;%*.*s&squot; (%x) does not exist &squot;%s&squot;&bslash;n&quot;
comma
id|namesz
comma
id|namesz
comma
id|name
comma
id|vid
comma
id|cell-&gt;name
)paren
suffix:semicolon
multiline_comment|/* TODO: make existing record unavailable */
r_goto
id|error
suffix:semicolon
)brace
id|found_on_vlserver
suffix:colon
id|_debug
c_func
(paren
l_string|&quot;Done VL Lookup: %*.*s %02x { %08x(%x) %08x(%x) %08x(%x) }&quot;
comma
id|namesz
comma
id|namesz
comma
id|name
comma
id|vldb.vidmask
comma
id|ntohl
c_func
(paren
id|vldb.servers
(braket
l_int|0
)braket
dot
id|s_addr
)paren
comma
id|vldb.srvtmask
(braket
l_int|0
)braket
comma
id|ntohl
c_func
(paren
id|vldb.servers
(braket
l_int|1
)braket
dot
id|s_addr
)paren
comma
id|vldb.srvtmask
(braket
l_int|1
)braket
comma
id|ntohl
c_func
(paren
id|vldb.servers
(braket
l_int|2
)braket
dot
id|s_addr
)paren
comma
id|vldb.srvtmask
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|_debug
c_func
(paren
l_string|&quot;Vids: %08x %08x %08x&quot;
comma
id|vldb.vid
(braket
l_int|0
)braket
comma
id|vldb.vid
(braket
l_int|1
)braket
comma
id|vldb.vid
(braket
l_int|2
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|namesz
OL
r_sizeof
(paren
id|vlocation-&gt;vldb.name
)paren
op_logical_and
id|vlocation-&gt;vldb.name
(braket
id|namesz
)braket
op_ne
l_char|&squot;&bslash;0&squot;
)paren
op_logical_or
id|memcmp
c_func
(paren
id|vldb.name
comma
id|name
comma
id|namesz
)paren
op_ne
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;kAFS: name of volume &squot;%*.*s&squot; changed to &squot;%s&squot; on server&bslash;n&quot;
comma
id|namesz
comma
id|namesz
comma
id|name
comma
id|vldb.name
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|vlocation-&gt;vldb
comma
op_amp
id|vldb
comma
r_sizeof
(paren
id|vlocation-&gt;vldb
)paren
)paren
suffix:semicolon
id|afs_kafstimod_add_timer
c_func
(paren
op_amp
id|vlocation-&gt;upd_timer
comma
l_int|10
op_star
id|HZ
)paren
suffix:semicolon
macro_line|#ifdef AFS_CACHING_SUPPORT
multiline_comment|/* update volume entry in local cache */
id|cachefs_update_cookie
c_func
(paren
id|vlocation-&gt;cache
)paren
suffix:semicolon
macro_line|#endif
op_star
id|_vlocation
op_assign
id|vlocation
suffix:semicolon
id|_leave
c_func
(paren
l_string|&quot; = 0 (%p)&quot;
comma
id|vlocation
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|error
suffix:colon
r_if
c_cond
(paren
id|vlocation
)paren
(brace
r_if
c_cond
(paren
id|active
)paren
(brace
id|__afs_put_vlocation
c_func
(paren
id|vlocation
)paren
suffix:semicolon
)brace
r_else
(brace
id|list_del
c_func
(paren
op_amp
id|vlocation-&gt;link
)paren
suffix:semicolon
macro_line|#ifdef AFS_CACHING_SUPPORT
id|cachefs_relinquish_cookie
c_func
(paren
id|vlocation-&gt;cache
comma
l_int|0
)paren
suffix:semicolon
macro_line|#endif
id|afs_put_cell
c_func
(paren
id|vlocation-&gt;cell
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|vlocation
)paren
suffix:semicolon
)brace
)brace
id|_leave
c_func
(paren
l_string|&quot; = %d&quot;
comma
id|ret
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* end afs_vlocation_lookup() */
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * finish using a volume location record&n; * - caller must have cell-&gt;vol_sem write-locked&n; */
DECL|function|__afs_put_vlocation
r_static
r_void
id|__afs_put_vlocation
c_func
(paren
r_struct
id|afs_vlocation
op_star
id|vlocation
)paren
(brace
r_struct
id|afs_cell
op_star
id|cell
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|vlocation
)paren
r_return
suffix:semicolon
id|_enter
c_func
(paren
l_string|&quot;%s&quot;
comma
id|vlocation-&gt;vldb.name
)paren
suffix:semicolon
id|cell
op_assign
id|vlocation-&gt;cell
suffix:semicolon
multiline_comment|/* sanity check */
id|BUG_ON
c_func
(paren
id|atomic_read
c_func
(paren
op_amp
id|vlocation-&gt;usage
)paren
op_le
l_int|0
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|cell-&gt;vl_gylock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|likely
c_func
(paren
op_logical_neg
id|atomic_dec_and_test
c_func
(paren
op_amp
id|vlocation-&gt;usage
)paren
)paren
)paren
(brace
id|spin_unlock
c_func
(paren
op_amp
id|cell-&gt;vl_gylock
)paren
suffix:semicolon
id|_leave
c_func
(paren
l_string|&quot;&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* move to graveyard queue */
id|list_del
c_func
(paren
op_amp
id|vlocation-&gt;link
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|vlocation-&gt;link
comma
op_amp
id|cell-&gt;vl_graveyard
)paren
suffix:semicolon
multiline_comment|/* remove from pending timeout queue (refcounted if actually being&n;&t; * updated) */
id|list_del_init
c_func
(paren
op_amp
id|vlocation-&gt;upd_op.link
)paren
suffix:semicolon
multiline_comment|/* time out in 10 secs */
id|afs_kafstimod_del_timer
c_func
(paren
op_amp
id|vlocation-&gt;upd_timer
)paren
suffix:semicolon
id|afs_kafstimod_add_timer
c_func
(paren
op_amp
id|vlocation-&gt;timeout
comma
l_int|10
op_star
id|HZ
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|cell-&gt;vl_gylock
)paren
suffix:semicolon
id|_leave
c_func
(paren
l_string|&quot; [killed]&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* end __afs_put_vlocation() */
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * finish using a volume location record&n; */
DECL|function|afs_put_vlocation
r_void
id|afs_put_vlocation
c_func
(paren
r_struct
id|afs_vlocation
op_star
id|vlocation
)paren
(brace
r_if
c_cond
(paren
id|vlocation
)paren
(brace
r_struct
id|afs_cell
op_star
id|cell
op_assign
id|vlocation-&gt;cell
suffix:semicolon
id|down_write
c_func
(paren
op_amp
id|cell-&gt;vl_sem
)paren
suffix:semicolon
id|__afs_put_vlocation
c_func
(paren
id|vlocation
)paren
suffix:semicolon
id|up_write
c_func
(paren
op_amp
id|cell-&gt;vl_sem
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* end afs_put_vlocation() */
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * timeout vlocation record&n; * - removes from the cell&squot;s graveyard if the usage count is zero&n; */
DECL|function|afs_vlocation_do_timeout
r_void
id|afs_vlocation_do_timeout
c_func
(paren
r_struct
id|afs_vlocation
op_star
id|vlocation
)paren
(brace
r_struct
id|afs_cell
op_star
id|cell
suffix:semicolon
id|_enter
c_func
(paren
l_string|&quot;%s&quot;
comma
id|vlocation-&gt;vldb.name
)paren
suffix:semicolon
id|cell
op_assign
id|vlocation-&gt;cell
suffix:semicolon
id|BUG_ON
c_func
(paren
id|atomic_read
c_func
(paren
op_amp
id|vlocation-&gt;usage
)paren
OL
l_int|0
)paren
suffix:semicolon
multiline_comment|/* remove from graveyard if still dead */
id|spin_lock
c_func
(paren
op_amp
id|cell-&gt;vl_gylock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|vlocation-&gt;usage
)paren
op_eq
l_int|0
)paren
id|list_del_init
c_func
(paren
op_amp
id|vlocation-&gt;link
)paren
suffix:semicolon
r_else
id|vlocation
op_assign
l_int|NULL
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|cell-&gt;vl_gylock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|vlocation
)paren
(brace
id|_leave
c_func
(paren
l_string|&quot;&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
multiline_comment|/* resurrected */
)brace
multiline_comment|/* we can now destroy it properly */
macro_line|#ifdef AFS_CACHING_SUPPORT
id|cachefs_relinquish_cookie
c_func
(paren
id|vlocation-&gt;cache
comma
l_int|0
)paren
suffix:semicolon
macro_line|#endif
id|afs_put_cell
c_func
(paren
id|cell
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|vlocation
)paren
suffix:semicolon
id|_leave
c_func
(paren
l_string|&quot; [destroyed]&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* end afs_vlocation_do_timeout() */
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * send an update operation to the currently selected server&n; */
DECL|function|afs_vlocation_update_begin
r_static
r_int
id|afs_vlocation_update_begin
c_func
(paren
r_struct
id|afs_vlocation
op_star
id|vlocation
)paren
(brace
id|afs_voltype_t
id|voltype
suffix:semicolon
id|afs_volid_t
id|vid
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|_enter
c_func
(paren
l_string|&quot;%s{ufs=%u ucs=%u}&quot;
comma
id|vlocation-&gt;vldb.name
comma
id|vlocation-&gt;upd_first_svix
comma
id|vlocation-&gt;upd_curr_svix
)paren
suffix:semicolon
multiline_comment|/* try to look up a cached volume in the cell VL databases by ID */
r_if
c_cond
(paren
id|vlocation-&gt;vldb.vidmask
op_amp
id|AFS_VOL_VTM_RW
)paren
(brace
id|vid
op_assign
id|vlocation-&gt;vldb.vid
(braket
l_int|0
)braket
suffix:semicolon
id|voltype
op_assign
id|AFSVL_RWVOL
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|vlocation-&gt;vldb.vidmask
op_amp
id|AFS_VOL_VTM_RO
)paren
(brace
id|vid
op_assign
id|vlocation-&gt;vldb.vid
(braket
l_int|1
)braket
suffix:semicolon
id|voltype
op_assign
id|AFSVL_ROVOL
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|vlocation-&gt;vldb.vidmask
op_amp
id|AFS_VOL_VTM_BAK
)paren
(brace
id|vid
op_assign
id|vlocation-&gt;vldb.vid
(braket
l_int|2
)braket
suffix:semicolon
id|voltype
op_assign
id|AFSVL_BACKVOL
suffix:semicolon
)brace
r_else
(brace
id|BUG
c_func
(paren
)paren
suffix:semicolon
id|vid
op_assign
l_int|0
suffix:semicolon
id|voltype
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* contact the chosen server */
id|ret
op_assign
id|afs_server_lookup
c_func
(paren
id|vlocation-&gt;cell
comma
op_amp
id|vlocation-&gt;cell-&gt;vl_addrs
(braket
id|vlocation-&gt;upd_curr_svix
)braket
comma
op_amp
id|vlocation-&gt;upd_op.server
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|ret
)paren
(brace
r_case
l_int|0
suffix:colon
r_break
suffix:semicolon
r_case
op_minus
id|ENOMEM
suffix:colon
r_case
op_minus
id|ENONET
suffix:colon
r_default
suffix:colon
id|_leave
c_func
(paren
l_string|&quot; = %d&quot;
comma
id|ret
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* initiate the update operation */
id|ret
op_assign
id|afs_rxvl_get_entry_by_id_async
c_func
(paren
op_amp
id|vlocation-&gt;upd_op
comma
id|vid
comma
id|voltype
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
id|_leave
c_func
(paren
l_string|&quot; = %d&quot;
comma
id|ret
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
id|_leave
c_func
(paren
l_string|&quot; = %d&quot;
comma
id|ret
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/* end afs_vlocation_update_begin() */
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * abandon updating a VL record&n; * - does not restart the update timer&n; */
DECL|function|afs_vlocation_update_abandon
r_static
r_void
id|afs_vlocation_update_abandon
c_func
(paren
r_struct
id|afs_vlocation
op_star
id|vlocation
comma
id|afs_vlocation_upd_t
id|state
comma
r_int
id|ret
)paren
(brace
id|_enter
c_func
(paren
l_string|&quot;%s,%u&quot;
comma
id|vlocation-&gt;vldb.name
comma
id|state
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;kAFS: Abandoning VL update &squot;%s&squot;: %d&bslash;n&quot;
comma
id|vlocation-&gt;vldb.name
comma
id|ret
)paren
suffix:semicolon
multiline_comment|/* discard the server record */
id|afs_put_server
c_func
(paren
id|vlocation-&gt;upd_op.server
)paren
suffix:semicolon
id|vlocation-&gt;upd_op.server
op_assign
l_int|NULL
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|afs_vlocation_update_lock
)paren
suffix:semicolon
id|afs_vlocation_update
op_assign
l_int|NULL
suffix:semicolon
id|vlocation-&gt;upd_state
op_assign
id|state
suffix:semicolon
multiline_comment|/* TODO: start updating next VL record on pending list */
id|spin_unlock
c_func
(paren
op_amp
id|afs_vlocation_update_lock
)paren
suffix:semicolon
id|_leave
c_func
(paren
l_string|&quot;&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* end afs_vlocation_update_abandon() */
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * handle periodic update timeouts and busy retry timeouts&n; * - called from kafstimod&n; */
DECL|function|afs_vlocation_update_timer
r_static
r_void
id|afs_vlocation_update_timer
c_func
(paren
r_struct
id|afs_timer
op_star
id|timer
)paren
(brace
r_struct
id|afs_vlocation
op_star
id|vlocation
op_assign
id|list_entry
c_func
(paren
id|timer
comma
r_struct
id|afs_vlocation
comma
id|upd_timer
)paren
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|_enter
c_func
(paren
l_string|&quot;%s&quot;
comma
id|vlocation-&gt;vldb.name
)paren
suffix:semicolon
multiline_comment|/* only update if not in the graveyard (defend against putting too) */
id|spin_lock
c_func
(paren
op_amp
id|vlocation-&gt;cell-&gt;vl_gylock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|atomic_read
c_func
(paren
op_amp
id|vlocation-&gt;usage
)paren
)paren
r_goto
id|out_unlock1
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|afs_vlocation_update_lock
)paren
suffix:semicolon
multiline_comment|/* if we were woken up due to EBUSY sleep then restart immediately if&n;&t; * possible or else jump to front of pending queue */
r_if
c_cond
(paren
id|vlocation-&gt;upd_state
op_eq
id|AFS_VLUPD_BUSYSLEEP
)paren
(brace
r_if
c_cond
(paren
id|afs_vlocation_update
)paren
(brace
id|list_add
c_func
(paren
op_amp
id|vlocation-&gt;upd_op.link
comma
op_amp
id|afs_vlocation_update_pendq
)paren
suffix:semicolon
)brace
r_else
(brace
id|afs_get_vlocation
c_func
(paren
id|vlocation
)paren
suffix:semicolon
id|afs_vlocation_update
op_assign
id|vlocation
suffix:semicolon
id|vlocation-&gt;upd_state
op_assign
id|AFS_VLUPD_INPROGRESS
suffix:semicolon
)brace
r_goto
id|out_unlock2
suffix:semicolon
)brace
multiline_comment|/* put on pending queue if there&squot;s already another update in progress */
r_if
c_cond
(paren
id|afs_vlocation_update
)paren
(brace
id|vlocation-&gt;upd_state
op_assign
id|AFS_VLUPD_PENDING
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|vlocation-&gt;upd_op.link
comma
op_amp
id|afs_vlocation_update_pendq
)paren
suffix:semicolon
r_goto
id|out_unlock2
suffix:semicolon
)brace
multiline_comment|/* hold a ref on it while actually updating */
id|afs_get_vlocation
c_func
(paren
id|vlocation
)paren
suffix:semicolon
id|afs_vlocation_update
op_assign
id|vlocation
suffix:semicolon
id|vlocation-&gt;upd_state
op_assign
id|AFS_VLUPD_INPROGRESS
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|afs_vlocation_update_lock
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|vlocation-&gt;cell-&gt;vl_gylock
)paren
suffix:semicolon
multiline_comment|/* okay... we can start the update */
id|_debug
c_func
(paren
l_string|&quot;BEGIN VL UPDATE [%s]&quot;
comma
id|vlocation-&gt;vldb.name
)paren
suffix:semicolon
id|vlocation-&gt;upd_first_svix
op_assign
id|vlocation-&gt;cell-&gt;vl_curr_svix
suffix:semicolon
id|vlocation-&gt;upd_curr_svix
op_assign
id|vlocation-&gt;upd_first_svix
suffix:semicolon
id|vlocation-&gt;upd_rej_cnt
op_assign
l_int|0
suffix:semicolon
id|vlocation-&gt;upd_busy_cnt
op_assign
l_int|0
suffix:semicolon
id|ret
op_assign
id|afs_vlocation_update_begin
c_func
(paren
id|vlocation
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
id|afs_vlocation_update_abandon
c_func
(paren
id|vlocation
comma
id|AFS_VLUPD_SLEEP
comma
id|ret
)paren
suffix:semicolon
id|afs_kafstimod_add_timer
c_func
(paren
op_amp
id|vlocation-&gt;upd_timer
comma
id|AFS_VLDB_TIMEOUT
)paren
suffix:semicolon
id|afs_put_vlocation
c_func
(paren
id|vlocation
)paren
suffix:semicolon
)brace
id|_leave
c_func
(paren
l_string|&quot;&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
id|out_unlock2
suffix:colon
id|spin_unlock
c_func
(paren
op_amp
id|afs_vlocation_update_lock
)paren
suffix:semicolon
id|out_unlock1
suffix:colon
id|spin_unlock
c_func
(paren
op_amp
id|vlocation-&gt;cell-&gt;vl_gylock
)paren
suffix:semicolon
id|_leave
c_func
(paren
l_string|&quot;&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* end afs_vlocation_update_timer() */
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * attend to an update operation upon which an event happened&n; * - called in kafsasyncd context&n; */
DECL|function|afs_vlocation_update_attend
r_static
r_void
id|afs_vlocation_update_attend
c_func
(paren
r_struct
id|afs_async_op
op_star
id|op
)paren
(brace
r_struct
id|afs_cache_vlocation
id|vldb
suffix:semicolon
r_struct
id|afs_vlocation
op_star
id|vlocation
op_assign
id|list_entry
c_func
(paren
id|op
comma
r_struct
id|afs_vlocation
comma
id|upd_op
)paren
suffix:semicolon
r_int
id|tmp
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|_enter
c_func
(paren
l_string|&quot;%s&quot;
comma
id|vlocation-&gt;vldb.name
)paren
suffix:semicolon
id|ret
op_assign
id|afs_rxvl_get_entry_by_id_async2
c_func
(paren
id|op
comma
op_amp
id|vldb
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|ret
)paren
(brace
r_case
op_minus
id|EAGAIN
suffix:colon
id|_leave
c_func
(paren
l_string|&quot; [unfinished]&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
l_int|0
suffix:colon
id|_debug
c_func
(paren
l_string|&quot;END VL UPDATE: %d&bslash;n&quot;
comma
id|ret
)paren
suffix:semicolon
id|vlocation-&gt;valid
op_assign
l_int|1
suffix:semicolon
id|_debug
c_func
(paren
l_string|&quot;Done VL Lookup: %02x { %08x(%x) %08x(%x) %08x(%x) }&quot;
comma
id|vldb.vidmask
comma
id|ntohl
c_func
(paren
id|vldb.servers
(braket
l_int|0
)braket
dot
id|s_addr
)paren
comma
id|vldb.srvtmask
(braket
l_int|0
)braket
comma
id|ntohl
c_func
(paren
id|vldb.servers
(braket
l_int|1
)braket
dot
id|s_addr
)paren
comma
id|vldb.srvtmask
(braket
l_int|1
)braket
comma
id|ntohl
c_func
(paren
id|vldb.servers
(braket
l_int|2
)braket
dot
id|s_addr
)paren
comma
id|vldb.srvtmask
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|_debug
c_func
(paren
l_string|&quot;Vids: %08x %08x %08x&quot;
comma
id|vldb.vid
(braket
l_int|0
)braket
comma
id|vldb.vid
(braket
l_int|1
)braket
comma
id|vldb.vid
(braket
l_int|2
)braket
)paren
suffix:semicolon
id|afs_vlocation_update_abandon
c_func
(paren
id|vlocation
comma
id|AFS_VLUPD_SLEEP
comma
l_int|0
)paren
suffix:semicolon
id|down_write
c_func
(paren
op_amp
id|vlocation-&gt;cell-&gt;vl_sem
)paren
suffix:semicolon
multiline_comment|/* actually update the cache */
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|vldb.name
comma
id|vlocation-&gt;vldb.name
comma
r_sizeof
(paren
id|vlocation-&gt;vldb.name
)paren
)paren
op_ne
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;kAFS: name of volume &squot;%s&squot;&quot;
l_string|&quot; changed to &squot;%s&squot; on server&bslash;n&quot;
comma
id|vlocation-&gt;vldb.name
comma
id|vldb.name
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|vlocation-&gt;vldb
comma
op_amp
id|vldb
comma
r_sizeof
(paren
id|vlocation-&gt;vldb
)paren
)paren
suffix:semicolon
macro_line|#if 0
multiline_comment|/* TODO update volume entry in local cache */
macro_line|#endif
id|up_write
c_func
(paren
op_amp
id|vlocation-&gt;cell-&gt;vl_sem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
id|printk
c_func
(paren
l_string|&quot;kAFS: failed to update local cache: %d&bslash;n&quot;
comma
id|ret
)paren
suffix:semicolon
id|afs_kafstimod_add_timer
c_func
(paren
op_amp
id|vlocation-&gt;upd_timer
comma
id|AFS_VLDB_TIMEOUT
)paren
suffix:semicolon
id|afs_put_vlocation
c_func
(paren
id|vlocation
)paren
suffix:semicolon
id|_leave
c_func
(paren
l_string|&quot; [found]&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
op_minus
id|ENOMEDIUM
suffix:colon
id|vlocation-&gt;upd_rej_cnt
op_increment
suffix:semicolon
r_goto
id|try_next
suffix:semicolon
multiline_comment|/* the server is locked - retry in a very short while */
r_case
op_minus
id|EBUSY
suffix:colon
id|vlocation-&gt;upd_busy_cnt
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|vlocation-&gt;upd_busy_cnt
OG
l_int|3
)paren
r_goto
id|try_next
suffix:semicolon
multiline_comment|/* too many retries */
id|afs_vlocation_update_abandon
c_func
(paren
id|vlocation
comma
id|AFS_VLUPD_BUSYSLEEP
comma
l_int|0
)paren
suffix:semicolon
id|afs_kafstimod_add_timer
c_func
(paren
op_amp
id|vlocation-&gt;upd_timer
comma
id|HZ
op_div
l_int|2
)paren
suffix:semicolon
id|afs_put_vlocation
c_func
(paren
id|vlocation
)paren
suffix:semicolon
id|_leave
c_func
(paren
l_string|&quot; [busy]&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
r_case
op_minus
id|ENETUNREACH
suffix:colon
r_case
op_minus
id|EHOSTUNREACH
suffix:colon
r_case
op_minus
id|ECONNREFUSED
suffix:colon
r_case
op_minus
id|EREMOTEIO
suffix:colon
multiline_comment|/* record bad vlserver info in the cell too&n;&t;&t; * - TODO: use down_write_trylock() if available&n;&t;&t; */
r_if
c_cond
(paren
id|vlocation-&gt;upd_curr_svix
op_eq
id|vlocation-&gt;cell-&gt;vl_curr_svix
)paren
id|vlocation-&gt;cell-&gt;vl_curr_svix
op_assign
id|vlocation-&gt;cell-&gt;vl_curr_svix
op_mod
id|vlocation-&gt;cell-&gt;vl_naddrs
suffix:semicolon
r_case
op_minus
id|EBADRQC
suffix:colon
r_case
op_minus
id|EINVAL
suffix:colon
r_case
op_minus
id|EACCES
suffix:colon
r_case
op_minus
id|EBADMSG
suffix:colon
r_goto
id|try_next
suffix:semicolon
r_default
suffix:colon
r_goto
id|abandon
suffix:semicolon
)brace
multiline_comment|/* try contacting the next server */
id|try_next
suffix:colon
id|vlocation-&gt;upd_busy_cnt
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* discard the server record */
id|afs_put_server
c_func
(paren
id|vlocation-&gt;upd_op.server
)paren
suffix:semicolon
id|vlocation-&gt;upd_op.server
op_assign
l_int|NULL
suffix:semicolon
id|tmp
op_assign
id|vlocation-&gt;cell-&gt;vl_naddrs
suffix:semicolon
r_if
c_cond
(paren
id|tmp
op_eq
l_int|0
)paren
r_goto
id|abandon
suffix:semicolon
id|vlocation-&gt;upd_curr_svix
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|vlocation-&gt;upd_curr_svix
op_ge
id|tmp
)paren
id|vlocation-&gt;upd_curr_svix
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|vlocation-&gt;upd_first_svix
op_ge
id|tmp
)paren
id|vlocation-&gt;upd_first_svix
op_assign
id|tmp
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* move to the next server */
r_if
c_cond
(paren
id|vlocation-&gt;upd_curr_svix
op_ne
id|vlocation-&gt;upd_first_svix
)paren
(brace
id|afs_vlocation_update_begin
c_func
(paren
id|vlocation
)paren
suffix:semicolon
id|_leave
c_func
(paren
l_string|&quot; [next]&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* run out of servers to try - was the volume rejected? */
r_if
c_cond
(paren
id|vlocation-&gt;upd_rej_cnt
OG
l_int|0
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;kAFS: Active volume no longer valid &squot;%s&squot;&bslash;n&quot;
comma
id|vlocation-&gt;vldb.name
)paren
suffix:semicolon
id|vlocation-&gt;valid
op_assign
l_int|0
suffix:semicolon
id|afs_vlocation_update_abandon
c_func
(paren
id|vlocation
comma
id|AFS_VLUPD_SLEEP
comma
l_int|0
)paren
suffix:semicolon
id|afs_kafstimod_add_timer
c_func
(paren
op_amp
id|vlocation-&gt;upd_timer
comma
id|AFS_VLDB_TIMEOUT
)paren
suffix:semicolon
id|afs_put_vlocation
c_func
(paren
id|vlocation
)paren
suffix:semicolon
id|_leave
c_func
(paren
l_string|&quot; [invalidated]&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
multiline_comment|/* abandon the update */
id|abandon
suffix:colon
id|afs_vlocation_update_abandon
c_func
(paren
id|vlocation
comma
id|AFS_VLUPD_SLEEP
comma
id|ret
)paren
suffix:semicolon
id|afs_kafstimod_add_timer
c_func
(paren
op_amp
id|vlocation-&gt;upd_timer
comma
id|HZ
op_star
l_int|10
)paren
suffix:semicolon
id|afs_put_vlocation
c_func
(paren
id|vlocation
)paren
suffix:semicolon
id|_leave
c_func
(paren
l_string|&quot; [abandoned]&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* end afs_vlocation_update_attend() */
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * deal with an update operation being discarded&n; * - called in kafsasyncd context when it&squot;s dying due to rmmod&n; * - the call has already been aborted and put()&squot;d&n; */
DECL|function|afs_vlocation_update_discard
r_static
r_void
id|afs_vlocation_update_discard
c_func
(paren
r_struct
id|afs_async_op
op_star
id|op
)paren
(brace
r_struct
id|afs_vlocation
op_star
id|vlocation
op_assign
id|list_entry
c_func
(paren
id|op
comma
r_struct
id|afs_vlocation
comma
id|upd_op
)paren
suffix:semicolon
id|_enter
c_func
(paren
l_string|&quot;%s&quot;
comma
id|vlocation-&gt;vldb.name
)paren
suffix:semicolon
id|afs_put_server
c_func
(paren
id|op-&gt;server
)paren
suffix:semicolon
id|op-&gt;server
op_assign
l_int|NULL
suffix:semicolon
id|afs_put_vlocation
c_func
(paren
id|vlocation
)paren
suffix:semicolon
id|_leave
c_func
(paren
l_string|&quot;&quot;
)paren
suffix:semicolon
)brace
multiline_comment|/* end afs_vlocation_update_discard() */
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * match a VLDB record stored in the cache&n; * - may also load target from entry&n; */
macro_line|#ifdef AFS_CACHING_SUPPORT
DECL|function|afs_vlocation_cache_match
r_static
id|cachefs_match_val_t
id|afs_vlocation_cache_match
c_func
(paren
r_void
op_star
id|target
comma
r_const
r_void
op_star
id|entry
)paren
(brace
r_const
r_struct
id|afs_cache_vlocation
op_star
id|vldb
op_assign
id|entry
suffix:semicolon
r_struct
id|afs_vlocation
op_star
id|vlocation
op_assign
id|target
suffix:semicolon
id|_enter
c_func
(paren
l_string|&quot;{%s},{%s}&quot;
comma
id|vlocation-&gt;vldb.name
comma
id|vldb-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|vlocation-&gt;vldb.name
comma
id|vldb-&gt;name
comma
r_sizeof
(paren
id|vldb-&gt;name
)paren
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|vlocation-&gt;valid
op_logical_or
id|vlocation-&gt;vldb.rtime
op_eq
id|vldb-&gt;rtime
)paren
(brace
id|vlocation-&gt;vldb
op_assign
op_star
id|vldb
suffix:semicolon
id|vlocation-&gt;valid
op_assign
l_int|1
suffix:semicolon
id|_leave
c_func
(paren
l_string|&quot; = SUCCESS [c-&gt;m]&quot;
)paren
suffix:semicolon
r_return
id|CACHEFS_MATCH_SUCCESS
suffix:semicolon
)brace
multiline_comment|/* need to update cache if cached info differs */
r_else
r_if
c_cond
(paren
id|memcmp
c_func
(paren
op_amp
id|vlocation-&gt;vldb
comma
id|vldb
comma
r_sizeof
(paren
op_star
id|vldb
)paren
)paren
op_ne
l_int|0
)paren
(brace
multiline_comment|/* delete if VIDs for this name differ */
r_if
c_cond
(paren
id|memcmp
c_func
(paren
op_amp
id|vlocation-&gt;vldb.vid
comma
op_amp
id|vldb-&gt;vid
comma
r_sizeof
(paren
id|vldb-&gt;vid
)paren
)paren
op_ne
l_int|0
)paren
(brace
id|_leave
c_func
(paren
l_string|&quot; = DELETE&quot;
)paren
suffix:semicolon
r_return
id|CACHEFS_MATCH_SUCCESS_DELETE
suffix:semicolon
)brace
id|_leave
c_func
(paren
l_string|&quot; = UPDATE&quot;
)paren
suffix:semicolon
r_return
id|CACHEFS_MATCH_SUCCESS_UPDATE
suffix:semicolon
)brace
r_else
(brace
id|_leave
c_func
(paren
l_string|&quot; = SUCCESS&quot;
)paren
suffix:semicolon
r_return
id|CACHEFS_MATCH_SUCCESS
suffix:semicolon
)brace
)brace
id|_leave
c_func
(paren
l_string|&quot; = FAILED&quot;
)paren
suffix:semicolon
r_return
id|CACHEFS_MATCH_FAILED
suffix:semicolon
)brace
multiline_comment|/* end afs_vlocation_cache_match() */
macro_line|#endif
multiline_comment|/*****************************************************************************/
multiline_comment|/*&n; * update a VLDB record stored in the cache&n; */
macro_line|#ifdef AFS_CACHING_SUPPORT
DECL|function|afs_vlocation_cache_update
r_static
r_void
id|afs_vlocation_cache_update
c_func
(paren
r_void
op_star
id|source
comma
r_void
op_star
id|entry
)paren
(brace
r_struct
id|afs_cache_vlocation
op_star
id|vldb
op_assign
id|entry
suffix:semicolon
r_struct
id|afs_vlocation
op_star
id|vlocation
op_assign
id|source
suffix:semicolon
id|_enter
c_func
(paren
l_string|&quot;&quot;
)paren
suffix:semicolon
op_star
id|vldb
op_assign
id|vlocation-&gt;vldb
suffix:semicolon
)brace
multiline_comment|/* end afs_vlocation_cache_update() */
macro_line|#endif
eof
