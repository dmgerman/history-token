multiline_comment|/*&n; * JFFS2 -- Journalling Flash File System, Version 2.&n; *&n; * Copyright (C) 2001, 2002 Red Hat, Inc.&n; *&n; * Created by David Woodhouse &lt;dwmw2@cambridge.redhat.com&gt;&n; *&n; * For licensing information, see the file &squot;LICENCE&squot; in this directory.&n; *&n; * $Id: compr_zlib.c,v 1.15 2002/03/04 09:35:48 dwmw2 Exp $&n; *&n; */
macro_line|#ifndef __KERNEL__
macro_line|#error &quot;The userspace support got too messy and was removed. Update your mkfs.jffs2&quot;
macro_line|#endif
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/mtd/compatmac.h&gt; /* for min() */
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/jffs2.h&gt;
macro_line|#include &lt;linux/zlib.h&gt;
macro_line|#include &quot;nodelist.h&quot;
multiline_comment|/* Plan: call deflate() with avail_in == *sourcelen, &n;&t;&t;avail_out = *dstlen - 12 and flush == Z_FINISH. &n;&t;&t;If it doesn&squot;t manage to finish,&t;call it again with&n;&t;&t;avail_in == 0 and avail_out set to the remaining 12&n;&t;&t;bytes for it to clean up. &n;&t;   Q: Is 12 bytes sufficient?&n;&t;*/
DECL|macro|STREAM_END_SPACE
mdefine_line|#define STREAM_END_SPACE 12
r_static
id|DECLARE_MUTEX
c_func
(paren
id|deflate_sem
)paren
suffix:semicolon
r_static
id|DECLARE_MUTEX
c_func
(paren
id|inflate_sem
)paren
suffix:semicolon
DECL|variable|deflate_workspace
r_static
r_void
op_star
id|deflate_workspace
suffix:semicolon
DECL|variable|inflate_workspace
r_static
r_void
op_star
id|inflate_workspace
suffix:semicolon
DECL|function|jffs2_zlib_init
r_int
id|__init
id|jffs2_zlib_init
c_func
(paren
r_void
)paren
(brace
id|deflate_workspace
op_assign
id|vmalloc
c_func
(paren
id|zlib_deflate_workspacesize
c_func
(paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|deflate_workspace
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Failed to allocate %d bytes for deflate workspace&bslash;n&quot;
comma
id|zlib_deflate_workspacesize
c_func
(paren
)paren
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|D1
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Allocated %d bytes for deflate workspace&bslash;n&quot;
comma
id|zlib_deflate_workspacesize
c_func
(paren
)paren
)paren
)paren
suffix:semicolon
id|inflate_workspace
op_assign
id|vmalloc
c_func
(paren
id|zlib_inflate_workspacesize
c_func
(paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|inflate_workspace
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;Failed to allocate %d bytes for inflate workspace&bslash;n&quot;
comma
id|zlib_inflate_workspacesize
c_func
(paren
)paren
)paren
suffix:semicolon
id|vfree
c_func
(paren
id|deflate_workspace
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|D1
c_func
(paren
id|printk
c_func
(paren
l_string|&quot;Allocated %d bytes for inflate workspace&bslash;n&quot;
comma
id|zlib_inflate_workspacesize
c_func
(paren
)paren
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|jffs2_zlib_exit
r_void
id|__exit
id|jffs2_zlib_exit
c_func
(paren
r_void
)paren
(brace
id|vfree
c_func
(paren
id|deflate_workspace
)paren
suffix:semicolon
id|vfree
c_func
(paren
id|inflate_workspace
)paren
suffix:semicolon
)brace
DECL|function|jffs2_zlib_compress
r_int
id|jffs2_zlib_compress
c_func
(paren
r_int
r_char
op_star
id|data_in
comma
r_int
r_char
op_star
id|cpage_out
comma
r_uint32
op_star
id|sourcelen
comma
r_uint32
op_star
id|dstlen
)paren
(brace
id|z_stream
id|strm
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
op_star
id|dstlen
op_le
id|STREAM_END_SPACE
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|down
c_func
(paren
op_amp
id|deflate_sem
)paren
suffix:semicolon
id|strm.workspace
op_assign
id|deflate_workspace
suffix:semicolon
r_if
c_cond
(paren
id|Z_OK
op_ne
id|zlib_deflateInit
c_func
(paren
op_amp
id|strm
comma
l_int|3
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;deflateInit failed&bslash;n&quot;
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|deflate_sem
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|strm.next_in
op_assign
id|data_in
suffix:semicolon
id|strm.total_in
op_assign
l_int|0
suffix:semicolon
id|strm.next_out
op_assign
id|cpage_out
suffix:semicolon
id|strm.total_out
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|strm.total_out
OL
op_star
id|dstlen
op_minus
id|STREAM_END_SPACE
op_logical_and
id|strm.total_in
OL
op_star
id|sourcelen
)paren
(brace
id|strm.avail_out
op_assign
op_star
id|dstlen
op_minus
(paren
id|strm.total_out
op_plus
id|STREAM_END_SPACE
)paren
suffix:semicolon
id|strm.avail_in
op_assign
id|min
c_func
(paren
(paren
r_int
)paren
(paren
op_star
id|sourcelen
op_minus
id|strm.total_in
)paren
comma
id|strm.avail_out
)paren
suffix:semicolon
id|D1
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;calling deflate with avail_in %d, avail_out %d&bslash;n&quot;
comma
id|strm.avail_in
comma
id|strm.avail_out
)paren
)paren
suffix:semicolon
id|ret
op_assign
id|zlib_deflate
c_func
(paren
op_amp
id|strm
comma
id|Z_PARTIAL_FLUSH
)paren
suffix:semicolon
id|D1
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;deflate returned with avail_in %d, avail_out %d, total_in %ld, total_out %ld&bslash;n&quot;
comma
id|strm.avail_in
comma
id|strm.avail_out
comma
id|strm.total_in
comma
id|strm.total_out
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ne
id|Z_OK
)paren
(brace
id|D1
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;deflate in loop returned %d&bslash;n&quot;
comma
id|ret
)paren
)paren
suffix:semicolon
id|zlib_deflateEnd
c_func
(paren
op_amp
id|strm
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|deflate_sem
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
)brace
id|strm.avail_out
op_add_assign
id|STREAM_END_SPACE
suffix:semicolon
id|strm.avail_in
op_assign
l_int|0
suffix:semicolon
id|ret
op_assign
id|zlib_deflate
c_func
(paren
op_amp
id|strm
comma
id|Z_FINISH
)paren
suffix:semicolon
id|zlib_deflateEnd
c_func
(paren
op_amp
id|strm
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|deflate_sem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_ne
id|Z_STREAM_END
)paren
(brace
id|D1
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;final deflate returned %d&bslash;n&quot;
comma
id|ret
)paren
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
id|D1
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;zlib compressed %ld bytes into %ld&bslash;n&quot;
comma
id|strm.total_in
comma
id|strm.total_out
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|strm.total_out
op_ge
id|strm.total_in
)paren
r_return
op_minus
l_int|1
suffix:semicolon
op_star
id|dstlen
op_assign
id|strm.total_out
suffix:semicolon
op_star
id|sourcelen
op_assign
id|strm.total_in
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|jffs2_zlib_decompress
r_void
id|jffs2_zlib_decompress
c_func
(paren
r_int
r_char
op_star
id|data_in
comma
r_int
r_char
op_star
id|cpage_out
comma
r_uint32
id|srclen
comma
r_uint32
id|destlen
)paren
(brace
id|z_stream
id|strm
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|down
c_func
(paren
op_amp
id|inflate_sem
)paren
suffix:semicolon
id|strm.workspace
op_assign
id|inflate_workspace
suffix:semicolon
r_if
c_cond
(paren
id|Z_OK
op_ne
id|zlib_inflateInit
c_func
(paren
op_amp
id|strm
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;inflateInit failed&bslash;n&quot;
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|inflate_sem
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|strm.next_in
op_assign
id|data_in
suffix:semicolon
id|strm.avail_in
op_assign
id|srclen
suffix:semicolon
id|strm.total_in
op_assign
l_int|0
suffix:semicolon
id|strm.next_out
op_assign
id|cpage_out
suffix:semicolon
id|strm.avail_out
op_assign
id|destlen
suffix:semicolon
id|strm.total_out
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
(paren
id|ret
op_assign
id|zlib_inflate
c_func
(paren
op_amp
id|strm
comma
id|Z_FINISH
)paren
)paren
op_eq
id|Z_OK
)paren
(brace
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ret
op_ne
id|Z_STREAM_END
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;inflate returned %d&bslash;n&quot;
comma
id|ret
)paren
suffix:semicolon
)brace
id|zlib_inflateEnd
c_func
(paren
op_amp
id|strm
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|inflate_sem
)paren
suffix:semicolon
)brace
eof
