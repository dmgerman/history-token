multiline_comment|/*&n; * JFFS2 -- Journalling Flash File System, Version 2.&n; *&n; * Copyright (C) 2004 Ferenc Havasi &lt;havasi@inf.u-szeged.hu&gt;,&n; *                    University of Szeged, Hungary&n; *&n; * For licensing information, see the file &squot;LICENCE&squot; in this directory.&n; *&n; * $Id: proc.c,v 1.3 2004/06/24 09:51:38 havasi Exp $&n; *&n; * Files in /proc/fs/jffs2 directory:&n; *   compr_list&n; *         read:  shows the list of the loaded compressors &n; *                (name, priority, enadbled/disabled)&n; *         write: compressors can be enabled/disabled and&n; *                the priority of them can be changed,&n; *                required formats:&n; *                    enable COMPRESSOR_NAME&n; *                    disble COMPRESSOR_NAME&n; *                    priority NEW_PRIORITY COMPRESSOR_NAME&n; *   compr_mode&n; *         read:  shows the name of the actual compression mode&n; *         write: sets the actual comperession mode&n; *   compr_stat&n; *         read:  shows compression statistics&n; */
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/jffs.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/proc_fs.h&gt;
macro_line|#include &quot;compr.h&quot;
r_extern
r_struct
id|proc_dir_entry
op_star
id|jffs_proc_root
suffix:semicolon
multiline_comment|/* Structure for top-level entry in &squot;/proc/fs&squot; directory */
DECL|variable|jffs2_proc_root
r_static
r_struct
id|proc_dir_entry
op_star
id|jffs2_proc_root
suffix:semicolon
multiline_comment|/* Structure for files in /proc/fs/jffs2 directory */
DECL|variable|jffs2_proc_compr_stat
r_static
r_struct
id|proc_dir_entry
op_star
id|jffs2_proc_compr_stat
suffix:semicolon
DECL|variable|jffs2_proc_compr_mode
r_static
r_struct
id|proc_dir_entry
op_star
id|jffs2_proc_compr_mode
suffix:semicolon
multiline_comment|/* Read the JFFS2 &squot;compr_stat&squot; file */
DECL|function|jffs2_proc_stat_read
r_static
r_int
id|jffs2_proc_stat_read
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
r_int
id|len
op_assign
l_int|0
comma
id|i
suffix:semicolon
r_char
op_star
id|stat
op_assign
id|jffs2_stats
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|strlen
c_func
(paren
id|stat
)paren
OL
id|off
)paren
(brace
op_star
id|eof
op_assign
l_int|1
suffix:semicolon
id|kfree
c_func
(paren
id|stat
)paren
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
id|off
suffix:semicolon
(paren
(paren
id|stat
(braket
id|i
)braket
op_ne
l_int|0
)paren
op_logical_and
(paren
id|len
OL
id|count
)paren
)paren
suffix:semicolon
id|i
op_increment
comma
id|len
op_increment
)paren
(brace
id|page
(braket
id|len
)braket
op_assign
id|stat
(braket
id|i
)braket
suffix:semicolon
)brace
r_if
c_cond
(paren
id|off
op_plus
id|len
op_ge
id|strlen
c_func
(paren
id|stat
)paren
)paren
op_star
id|eof
op_assign
l_int|1
suffix:semicolon
r_else
op_star
id|eof
op_assign
l_int|0
suffix:semicolon
id|kfree
c_func
(paren
id|stat
)paren
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
multiline_comment|/* Read the JFFS2 &squot;compr_mode&squot; file */
DECL|function|jffs2_proc_mode_read
r_static
r_int
id|jffs2_proc_mode_read
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
r_int
id|len
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|strlen
c_func
(paren
id|jffs2_get_compression_mode_name
c_func
(paren
)paren
)paren
op_plus
l_int|1
OG
id|count
)paren
(brace
multiline_comment|/* it should not happen */
op_star
id|eof
op_assign
l_int|1
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
comma
l_string|&quot;%s&bslash;n&quot;
comma
id|jffs2_get_compression_mode_name
c_func
(paren
)paren
)paren
suffix:semicolon
op_star
id|eof
op_assign
l_int|1
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
multiline_comment|/* Write the JFFS2 &squot;compr_mode&squot; file&n; *   sets the actual compression mode&n; */
DECL|function|jffs2_proc_mode_write
r_static
r_int
id|jffs2_proc_mode_write
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buffer
comma
r_int
r_int
id|count
comma
r_void
op_star
id|data
)paren
(brace
r_char
op_star
id|compr_name
suffix:semicolon
multiline_comment|/* collect the name of the compression mode and set it */
id|compr_name
op_assign
id|kmalloc
c_func
(paren
id|count
op_plus
l_int|1
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|sscanf
c_func
(paren
id|buffer
comma
l_string|&quot;%s&quot;
comma
id|compr_name
)paren
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|jffs2_set_compression_mode_name
c_func
(paren
id|compr_name
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;JFFS2: error switching compression mode. Invalid parameter (%s)?&bslash;n&quot;
comma
id|compr_name
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;JFFS2: error: parameter missing&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|compr_name
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
multiline_comment|/* Read the JFFS2 &squot;compr_list&squot; file */
DECL|function|jffs2_proc_list_read
r_static
r_int
id|jffs2_proc_list_read
(paren
r_char
op_star
id|page
comma
r_char
op_star
op_star
id|start
comma
id|off_t
id|off
comma
r_int
id|count
comma
r_int
op_star
id|eof
comma
r_void
op_star
id|data
)paren
(brace
r_int
id|len
op_assign
l_int|0
suffix:semicolon
r_char
op_star
id|list
op_assign
id|jffs2_list_compressors
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|strlen
c_func
(paren
id|list
)paren
op_plus
l_int|1
OG
id|count
)paren
(brace
multiline_comment|/* it should not happen */
op_star
id|eof
op_assign
l_int|1
suffix:semicolon
id|kfree
c_func
(paren
id|list
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
comma
l_string|&quot;%s&quot;
comma
id|list
)paren
suffix:semicolon
op_star
id|eof
op_assign
l_int|1
suffix:semicolon
id|kfree
c_func
(paren
id|list
)paren
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
multiline_comment|/* Write the JFFS2 &squot;compr_list&squot; file &n; *   enable/disable a compressor or set the priority of it&n; */
DECL|function|jffs2_proc_list_write
r_static
r_int
id|jffs2_proc_list_write
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_const
r_char
op_star
id|buffer
comma
r_int
r_int
id|count
comma
r_void
op_star
id|data
)paren
(brace
r_int
id|prior
suffix:semicolon
r_char
op_star
id|compr_name
comma
op_star
id|compr_cmd
suffix:semicolon
id|compr_name
op_assign
id|kmalloc
c_func
(paren
id|count
op_plus
l_int|1
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|compr_cmd
op_assign
id|kmalloc
c_func
(paren
id|count
op_plus
l_int|1
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|compr_name
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;JFFS2: unable to allocate memory&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|list_write_end
suffix:semicolon
)brace
id|compr_name
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|sscanf
c_func
(paren
id|buffer
comma
l_string|&quot;priority %d %s&quot;
comma
op_amp
id|prior
comma
id|compr_name
)paren
OG
l_int|1
)paren
(brace
id|jffs2_set_compressor_priority
c_func
(paren
id|compr_name
comma
id|prior
)paren
suffix:semicolon
r_goto
id|list_write_end
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sscanf
c_func
(paren
id|buffer
comma
l_string|&quot;enable %s&quot;
comma
id|compr_name
)paren
OG
l_int|0
)paren
(brace
id|jffs2_enable_compressor_name
c_func
(paren
id|compr_name
)paren
suffix:semicolon
r_goto
id|list_write_end
suffix:semicolon
)brace
r_if
c_cond
(paren
id|sscanf
c_func
(paren
id|buffer
comma
l_string|&quot;disable %s&quot;
comma
id|compr_name
)paren
OG
l_int|0
)paren
(brace
id|jffs2_disable_compressor_name
c_func
(paren
id|compr_name
)paren
suffix:semicolon
r_goto
id|list_write_end
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;JFFS2: usage of /proc/fs/jffs2/compr_list:&bslash;n&quot;
l_string|&quot;  echo &bslash;&quot;enable COMPRESSOR_NAME&bslash;&quot;  &gt;/proc/fs/jffs2/compr_list&bslash;n&quot;
l_string|&quot;  echo &bslash;&quot;disable COMPRESSOR_NAME&bslash;&quot; &gt;/proc/fs/jffs2/compr_list&bslash;n&quot;
l_string|&quot;  echo &bslash;&quot;priority NEW_PRIORITY COMPRESSOR_NAME&bslash;&quot; &gt;/proc/fs/jffs2/compr_list&bslash;n&quot;
)paren
suffix:semicolon
id|list_write_end
suffix:colon
id|kfree
c_func
(paren
id|compr_cmd
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|compr_name
)paren
suffix:semicolon
r_return
id|count
suffix:semicolon
)brace
multiline_comment|/* Register a JFFS2 proc directory */
DECL|function|jffs2_proc_init
r_int
id|jffs2_proc_init
c_func
(paren
r_void
)paren
(brace
id|jffs2_proc_root
op_assign
id|proc_mkdir
c_func
(paren
l_string|&quot;jffs2&quot;
comma
id|proc_root_fs
)paren
suffix:semicolon
multiline_comment|/* create entry for &squot;compr_stat&squot; file */
r_if
c_cond
(paren
(paren
id|jffs2_proc_compr_stat
op_assign
id|create_proc_entry
(paren
l_string|&quot;compr_stat&quot;
comma
l_int|0
comma
id|jffs2_proc_root
)paren
)paren
)paren
(brace
id|jffs2_proc_compr_stat-&gt;read_proc
op_assign
id|jffs2_proc_stat_read
suffix:semicolon
)brace
r_else
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/* create entry for &squot;compr_mode&squot; file */
r_if
c_cond
(paren
(paren
id|jffs2_proc_compr_mode
op_assign
id|create_proc_entry
(paren
l_string|&quot;compr_mode&quot;
comma
l_int|0
comma
id|jffs2_proc_root
)paren
)paren
)paren
(brace
id|jffs2_proc_compr_mode-&gt;read_proc
op_assign
id|jffs2_proc_mode_read
suffix:semicolon
id|jffs2_proc_compr_mode-&gt;write_proc
op_assign
id|jffs2_proc_mode_write
suffix:semicolon
)brace
r_else
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/* create entry for &squot;compr_list&squot; file */
r_if
c_cond
(paren
(paren
id|jffs2_proc_compr_mode
op_assign
id|create_proc_entry
(paren
l_string|&quot;compr_list&quot;
comma
l_int|0
comma
id|jffs2_proc_root
)paren
)paren
)paren
(brace
id|jffs2_proc_compr_mode-&gt;read_proc
op_assign
id|jffs2_proc_list_read
suffix:semicolon
id|jffs2_proc_compr_mode-&gt;write_proc
op_assign
id|jffs2_proc_list_write
suffix:semicolon
)brace
r_else
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Unregister a JFFS2 proc directory */
DECL|function|jffs2_proc_exit
r_int
id|jffs2_proc_exit
c_func
(paren
r_void
)paren
(brace
macro_line|#if LINUX_VERSION_CODE &lt; 0x020300
id|remove_proc_entry
(paren
l_string|&quot;compr_stat&quot;
comma
op_amp
id|jffs2_proc_root
)paren
suffix:semicolon
id|remove_proc_entry
(paren
l_string|&quot;compr_mode&quot;
comma
op_amp
id|jffs2_proc_root
)paren
suffix:semicolon
id|remove_proc_entry
(paren
l_string|&quot;compr_list&quot;
comma
op_amp
id|jffs2_proc_root
)paren
suffix:semicolon
id|remove_proc_entry
(paren
l_string|&quot;jffs2&quot;
comma
op_amp
id|proc_root_fs
)paren
suffix:semicolon
macro_line|#else
id|remove_proc_entry
(paren
l_string|&quot;compr_stat&quot;
comma
id|jffs2_proc_root
)paren
suffix:semicolon
id|remove_proc_entry
(paren
l_string|&quot;compr_mode&quot;
comma
id|jffs2_proc_root
)paren
suffix:semicolon
id|remove_proc_entry
(paren
l_string|&quot;compr_list&quot;
comma
id|jffs2_proc_root
)paren
suffix:semicolon
id|remove_proc_entry
(paren
l_string|&quot;jffs2&quot;
comma
id|proc_root_fs
)paren
suffix:semicolon
macro_line|#endif
r_return
l_int|0
suffix:semicolon
)brace
eof
