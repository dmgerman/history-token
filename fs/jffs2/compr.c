multiline_comment|/*&n; * JFFS2 -- Journalling Flash File System, Version 2.&n; *&n; * Copyright (C) 2001 Red Hat, Inc.&n; *&n; * Created by Arjan van de Ven &lt;arjanv@redhat.com&gt;&n; *&n; * The original JFFS, from which the design for JFFS2 was derived,&n; * was designed and implemented by Axis Communications AB.&n; *&n; * The contents of this file are subject to the Red Hat eCos Public&n; * License Version 1.1 (the &quot;Licence&quot;); you may not use this file&n; * except in compliance with the Licence.  You may obtain a copy of&n; * the Licence at http://www.redhat.com/&n; *&n; * Software distributed under the Licence is distributed on an &quot;AS IS&quot;&n; * basis, WITHOUT WARRANTY OF ANY KIND, either express or implied.&n; * See the Licence for the specific language governing rights and&n; * limitations under the Licence.&n; *&n; * The Original Code is JFFS2 - Journalling Flash File System, version 2&n; *&n; * Alternatively, the contents of this file may be used under the&n; * terms of the GNU General Public License version 2 (the &quot;GPL&quot;), in&n; * which case the provisions of the GPL are applicable instead of the&n; * above.  If you wish to allow the use of your version of this file&n; * only under the terms of the GPL and not to allow others to use your&n; * version of this file under the RHEPL, indicate your decision by&n; * deleting the provisions above and replace them with the notice and&n; * other provisions required by the GPL.  If you do not delete the&n; * provisions above, a recipient may use your version of this file&n; * under either the RHEPL or the GPL.&n; *&n; * $Id: compr.c,v 1.17 2001/09/23 09:56:46 dwmw2 Exp $&n; *&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/jffs2.h&gt;
r_int
id|zlib_compress
c_func
(paren
r_int
r_char
op_star
id|data_in
comma
r_int
r_char
op_star
id|cpage_out
comma
id|__u32
op_star
id|sourcelen
comma
id|__u32
op_star
id|dstlen
)paren
suffix:semicolon
r_void
id|zlib_decompress
c_func
(paren
r_int
r_char
op_star
id|data_in
comma
r_int
r_char
op_star
id|cpage_out
comma
id|__u32
id|srclen
comma
id|__u32
id|destlen
)paren
suffix:semicolon
r_int
id|rtime_compress
c_func
(paren
r_int
r_char
op_star
id|data_in
comma
r_int
r_char
op_star
id|cpage_out
comma
id|__u32
op_star
id|sourcelen
comma
id|__u32
op_star
id|dstlen
)paren
suffix:semicolon
r_void
id|rtime_decompress
c_func
(paren
r_int
r_char
op_star
id|data_in
comma
r_int
r_char
op_star
id|cpage_out
comma
id|__u32
id|srclen
comma
id|__u32
id|destlen
)paren
suffix:semicolon
r_int
id|rubinmips_compress
c_func
(paren
r_int
r_char
op_star
id|data_in
comma
r_int
r_char
op_star
id|cpage_out
comma
id|__u32
op_star
id|sourcelen
comma
id|__u32
op_star
id|dstlen
)paren
suffix:semicolon
r_void
id|rubinmips_decompress
c_func
(paren
r_int
r_char
op_star
id|data_in
comma
r_int
r_char
op_star
id|cpage_out
comma
id|__u32
id|srclen
comma
id|__u32
id|destlen
)paren
suffix:semicolon
r_int
id|dynrubin_compress
c_func
(paren
r_int
r_char
op_star
id|data_in
comma
r_int
r_char
op_star
id|cpage_out
comma
id|__u32
op_star
id|sourcelen
comma
id|__u32
op_star
id|dstlen
)paren
suffix:semicolon
r_void
id|dynrubin_decompress
c_func
(paren
r_int
r_char
op_star
id|data_in
comma
r_int
r_char
op_star
id|cpage_out
comma
id|__u32
id|srclen
comma
id|__u32
id|destlen
)paren
suffix:semicolon
multiline_comment|/* jffs2_compress:&n; * @data: Pointer to uncompressed data&n; * @cdata: Pointer to buffer for compressed data&n; * @datalen: On entry, holds the amount of data available for compression.&n; *&t;On exit, expected to hold the amount of data actually compressed.&n; * @cdatalen: On entry, holds the amount of space available for compressed&n; *&t;data. On exit, expected to hold the actual size of the compressed&n; *&t;data.&n; *&n; * Returns: Byte to be stored with data indicating compression type used.&n; * Zero is used to show that the data could not be compressed - the &n; * compressed version was actually larger than the original.&n; *&n; * If the cdata buffer isn&squot;t large enough to hold all the uncompressed data,&n; * jffs2_compress should compress as much as will fit, and should set &n; * *datalen accordingly to show the amount of data which were compressed.&n; */
DECL|function|jffs2_compress
r_int
r_char
id|jffs2_compress
c_func
(paren
r_int
r_char
op_star
id|data_in
comma
r_int
r_char
op_star
id|cpage_out
comma
id|__u32
op_star
id|datalen
comma
id|__u32
op_star
id|cdatalen
)paren
(brace
r_int
id|ret
suffix:semicolon
id|ret
op_assign
id|zlib_compress
c_func
(paren
id|data_in
comma
id|cpage_out
comma
id|datalen
comma
id|cdatalen
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
(brace
r_return
id|JFFS2_COMPR_ZLIB
suffix:semicolon
)brace
macro_line|#if 0 /* Disabled 23/9/1. With zlib it hardly ever gets a look in */
id|ret
op_assign
id|dynrubin_compress
c_func
(paren
id|data_in
comma
id|cpage_out
comma
id|datalen
comma
id|cdatalen
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
(brace
r_return
id|JFFS2_COMPR_DYNRUBIN
suffix:semicolon
)brace
macro_line|#endif
macro_line|#if 0 /* Disabled 26/2/1. Obsoleted by dynrubin */
id|ret
op_assign
id|rubinmips_compress
c_func
(paren
id|data_in
comma
id|cpage_out
comma
id|datalen
comma
id|cdatalen
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
(brace
r_return
id|JFFS2_COMPR_RUBINMIPS
suffix:semicolon
)brace
macro_line|#endif
multiline_comment|/* rtime does manage to recompress already-compressed data */
id|ret
op_assign
id|rtime_compress
c_func
(paren
id|data_in
comma
id|cpage_out
comma
id|datalen
comma
id|cdatalen
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
(brace
r_return
id|JFFS2_COMPR_RTIME
suffix:semicolon
)brace
macro_line|#if 0
multiline_comment|/* We don&squot;t need to copy. Let the caller special-case the COMPR_NONE case. */
multiline_comment|/* If we get here, no compression is going to work */
multiline_comment|/* But we might want to use the fragmentation part -- Arjan */
id|memcpy
c_func
(paren
id|cpage_out
comma
id|data_in
comma
id|min
c_func
(paren
op_star
id|datalen
comma
op_star
id|cdatalen
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|datalen
OG
op_star
id|cdatalen
)paren
op_star
id|datalen
op_assign
op_star
id|cdatalen
suffix:semicolon
macro_line|#endif&t;&t;
r_return
id|JFFS2_COMPR_NONE
suffix:semicolon
multiline_comment|/* We failed to compress */
)brace
DECL|function|jffs2_decompress
r_int
id|jffs2_decompress
c_func
(paren
r_int
r_char
id|comprtype
comma
r_int
r_char
op_star
id|cdata_in
comma
r_int
r_char
op_star
id|data_out
comma
id|__u32
id|cdatalen
comma
id|__u32
id|datalen
)paren
(brace
r_switch
c_cond
(paren
id|comprtype
)paren
(brace
r_case
id|JFFS2_COMPR_NONE
suffix:colon
multiline_comment|/* This should be special-cased elsewhere, but we might as well deal with it */
id|memcpy
c_func
(paren
id|data_out
comma
id|cdata_in
comma
id|datalen
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|JFFS2_COMPR_ZERO
suffix:colon
id|memset
c_func
(paren
id|data_out
comma
l_int|0
comma
id|datalen
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|JFFS2_COMPR_ZLIB
suffix:colon
id|zlib_decompress
c_func
(paren
id|cdata_in
comma
id|data_out
comma
id|cdatalen
comma
id|datalen
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|JFFS2_COMPR_RTIME
suffix:colon
id|rtime_decompress
c_func
(paren
id|cdata_in
comma
id|data_out
comma
id|cdatalen
comma
id|datalen
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|JFFS2_COMPR_RUBINMIPS
suffix:colon
macro_line|#if 0 /* Disabled 23/9/1 */
id|rubinmips_decompress
c_func
(paren
id|cdata_in
comma
id|data_out
comma
id|cdatalen
comma
id|datalen
)paren
suffix:semicolon
macro_line|#else
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;JFFS2: Rubinmips compression encountered but support not compiled in!&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
r_case
id|JFFS2_COMPR_DYNRUBIN
suffix:colon
macro_line|#if 1 /* Phase this one out */
id|dynrubin_decompress
c_func
(paren
id|cdata_in
comma
id|data_out
comma
id|cdatalen
comma
id|datalen
)paren
suffix:semicolon
macro_line|#else
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;JFFS2: Dynrubin compression encountered but support not compiled in!&bslash;n&quot;
)paren
suffix:semicolon
macro_line|#endif
r_break
suffix:semicolon
r_default
suffix:colon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;Unknown JFFS2 compression type 0x%02x&bslash;n&quot;
comma
id|comprtype
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
eof
