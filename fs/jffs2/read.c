multiline_comment|/*&n; * JFFS2 -- Journalling Flash File System, Version 2.&n; *&n; * Copyright (C) 2001 Red Hat, Inc.&n; *&n; * Created by David Woodhouse &lt;dwmw2@cambridge.redhat.com&gt;&n; *&n; * The original JFFS, from which the design for JFFS2 was derived,&n; * was designed and implemented by Axis Communications AB.&n; *&n; * The contents of this file are subject to the Red Hat eCos Public&n; * License Version 1.1 (the &quot;Licence&quot;); you may not use this file&n; * except in compliance with the Licence.  You may obtain a copy of&n; * the Licence at http://www.redhat.com/&n; *&n; * Software distributed under the Licence is distributed on an &quot;AS IS&quot;&n; * basis, WITHOUT WARRANTY OF ANY KIND, either express or implied.&n; * See the Licence for the specific language governing rights and&n; * limitations under the Licence.&n; *&n; * The Original Code is JFFS2 - Journalling Flash File System, version 2&n; *&n; * Alternatively, the contents of this file may be used under the&n; * terms of the GNU General Public License version 2 (the &quot;GPL&quot;), in&n; * which case the provisions of the GPL are applicable instead of the&n; * above.  If you wish to allow the use of your version of this file&n; * only under the terms of the GPL and not to allow others to use your&n; * version of this file under the RHEPL, indicate your decision by&n; * deleting the provisions above and replace them with the notice and&n; * other provisions required by the GPL.  If you do not delete the&n; * provisions above, a recipient may use your version of this file&n; * under either the RHEPL or the GPL.&n; *&n; * $Id: read.c,v 1.13.2.1 2002/02/01 23:32:33 dwmw2 Exp $&n; *&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/crc32.h&gt;
macro_line|#include &lt;linux/jffs2.h&gt;
macro_line|#include &lt;linux/mtd/mtd.h&gt;
macro_line|#include &quot;nodelist.h&quot;
DECL|function|jffs2_read_dnode
r_int
id|jffs2_read_dnode
c_func
(paren
r_struct
id|jffs2_sb_info
op_star
id|c
comma
r_struct
id|jffs2_full_dnode
op_star
id|fd
comma
r_int
r_char
op_star
id|buf
comma
r_int
id|ofs
comma
r_int
id|len
)paren
(brace
r_struct
id|jffs2_raw_inode
op_star
id|ri
suffix:semicolon
r_int
id|readlen
suffix:semicolon
id|__u32
id|crc
suffix:semicolon
r_int
r_char
op_star
id|decomprbuf
op_assign
l_int|NULL
suffix:semicolon
r_int
r_char
op_star
id|readbuf
op_assign
l_int|NULL
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
id|ri
op_assign
id|jffs2_alloc_raw_inode
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ri
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|ret
op_assign
id|c-&gt;mtd
op_member_access_from_pointer
id|read
c_func
(paren
id|c-&gt;mtd
comma
id|fd-&gt;raw-&gt;flash_offset
op_amp
op_complement
l_int|3
comma
r_sizeof
(paren
op_star
id|ri
)paren
comma
op_amp
id|readlen
comma
(paren
r_char
op_star
)paren
id|ri
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|jffs2_free_raw_inode
c_func
(paren
id|ri
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Error reading node from 0x%08x: %d&bslash;n&quot;
comma
id|fd-&gt;raw-&gt;flash_offset
op_amp
op_complement
l_int|3
comma
id|ret
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
r_if
c_cond
(paren
id|readlen
op_ne
r_sizeof
(paren
op_star
id|ri
)paren
)paren
(brace
id|jffs2_free_raw_inode
c_func
(paren
id|ri
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Short read from 0x%08x: wanted 0x%x bytes, got 0x%x&bslash;n&quot;
comma
id|fd-&gt;raw-&gt;flash_offset
op_amp
op_complement
l_int|3
comma
r_sizeof
(paren
op_star
id|ri
)paren
comma
id|readlen
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|crc
op_assign
id|crc32
c_func
(paren
l_int|0
comma
id|ri
comma
r_sizeof
(paren
op_star
id|ri
)paren
op_minus
l_int|8
)paren
suffix:semicolon
id|D1
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Node read from %08x: node_crc %08x, calculated CRC %08x. dsize %x, csize %x, offset %x, buf %p&bslash;n&quot;
comma
id|fd-&gt;raw-&gt;flash_offset
op_amp
op_complement
l_int|3
comma
id|ri-&gt;node_crc
comma
id|crc
comma
id|ri-&gt;dsize
comma
id|ri-&gt;csize
comma
id|ri-&gt;offset
comma
id|buf
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|crc
op_ne
id|ri-&gt;node_crc
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Node CRC %08x != calculated CRC %08x for node at %08x&bslash;n&quot;
comma
id|ri-&gt;node_crc
comma
id|crc
comma
id|fd-&gt;raw-&gt;flash_offset
op_amp
op_complement
l_int|3
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|out_ri
suffix:semicolon
)brace
multiline_comment|/* There was a bug where we wrote hole nodes out with csize/dsize&n;&t;   swapped. Deal with it */
r_if
c_cond
(paren
id|ri-&gt;compr
op_eq
id|JFFS2_COMPR_ZERO
op_logical_and
op_logical_neg
id|ri-&gt;dsize
op_logical_and
id|ri-&gt;csize
)paren
(brace
id|ri-&gt;dsize
op_assign
id|ri-&gt;csize
suffix:semicolon
id|ri-&gt;csize
op_assign
l_int|0
suffix:semicolon
)brace
id|D1
c_func
(paren
r_if
(paren
id|ofs
op_plus
id|len
OG
id|ri-&gt;dsize
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;jffs2_read_dnode() asked for %d bytes at %d from %d-byte node&bslash;n&quot;
comma
id|len
comma
id|ofs
comma
id|ri-&gt;dsize
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|out_ri
suffix:semicolon
)brace
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ri-&gt;compr
op_eq
id|JFFS2_COMPR_ZERO
)paren
(brace
id|memset
c_func
(paren
id|buf
comma
l_int|0
comma
id|len
)paren
suffix:semicolon
r_goto
id|out_ri
suffix:semicolon
)brace
multiline_comment|/* Cases:&n;&t;   Reading whole node and it&squot;s uncompressed - read directly to buffer provided, check CRC.&n;&t;   Reading whole node and it&squot;s compressed - read into comprbuf, check CRC and decompress to buffer provided &n;&t;   Reading partial node and it&squot;s uncompressed - read into readbuf, check CRC, and copy &n;&t;   Reading partial node and it&squot;s compressed - read into readbuf, check checksum, decompress to decomprbuf and copy&n;&t;*/
r_if
c_cond
(paren
id|ri-&gt;compr
op_eq
id|JFFS2_COMPR_NONE
op_logical_and
id|len
op_eq
id|ri-&gt;dsize
)paren
(brace
id|readbuf
op_assign
id|buf
suffix:semicolon
)brace
r_else
(brace
id|readbuf
op_assign
id|kmalloc
c_func
(paren
id|ri-&gt;csize
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|readbuf
)paren
(brace
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|out_ri
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|ri-&gt;compr
op_ne
id|JFFS2_COMPR_NONE
)paren
(brace
r_if
c_cond
(paren
id|len
OL
id|ri-&gt;dsize
)paren
(brace
id|decomprbuf
op_assign
id|kmalloc
c_func
(paren
id|ri-&gt;dsize
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|decomprbuf
)paren
(brace
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|out_readbuf
suffix:semicolon
)brace
)brace
r_else
(brace
id|decomprbuf
op_assign
id|buf
suffix:semicolon
)brace
)brace
r_else
(brace
id|decomprbuf
op_assign
id|readbuf
suffix:semicolon
)brace
id|D2
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Read %d bytes to %p&bslash;n&quot;
comma
id|ri-&gt;csize
comma
id|readbuf
)paren
)paren
suffix:semicolon
id|ret
op_assign
id|c-&gt;mtd
op_member_access_from_pointer
id|read
c_func
(paren
id|c-&gt;mtd
comma
(paren
id|fd-&gt;raw-&gt;flash_offset
op_amp
op_complement
l_int|3
)paren
op_plus
r_sizeof
(paren
op_star
id|ri
)paren
comma
id|ri-&gt;csize
comma
op_amp
id|readlen
comma
id|readbuf
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ret
op_logical_and
id|readlen
op_ne
id|ri-&gt;csize
)paren
id|ret
op_assign
op_minus
id|EIO
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_goto
id|out_decomprbuf
suffix:semicolon
id|crc
op_assign
id|crc32
c_func
(paren
l_int|0
comma
id|readbuf
comma
id|ri-&gt;csize
)paren
suffix:semicolon
r_if
c_cond
(paren
id|crc
op_ne
id|ri-&gt;data_crc
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Data CRC %08x != calculated CRC %08x for node at %08x&bslash;n&quot;
comma
id|ri-&gt;data_crc
comma
id|crc
comma
id|fd-&gt;raw-&gt;flash_offset
op_amp
op_complement
l_int|3
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|out_decomprbuf
suffix:semicolon
)brace
id|D2
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Data CRC matches calculated CRC %08x&bslash;n&quot;
comma
id|crc
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ri-&gt;compr
op_ne
id|JFFS2_COMPR_NONE
)paren
(brace
id|D2
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Decompress %d bytes from %p to %d bytes at %p&bslash;n&quot;
comma
id|ri-&gt;csize
comma
id|readbuf
comma
id|ri-&gt;dsize
comma
id|decomprbuf
)paren
)paren
suffix:semicolon
id|ret
op_assign
id|jffs2_decompress
c_func
(paren
id|ri-&gt;compr
comma
id|readbuf
comma
id|decomprbuf
comma
id|ri-&gt;csize
comma
id|ri-&gt;dsize
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Error: jffs2_decompress returned %d&bslash;n&quot;
comma
id|ret
)paren
suffix:semicolon
r_goto
id|out_decomprbuf
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|len
OL
id|ri-&gt;dsize
)paren
(brace
id|memcpy
c_func
(paren
id|buf
comma
id|decomprbuf
op_plus
id|ofs
comma
id|len
)paren
suffix:semicolon
)brace
id|out_decomprbuf
suffix:colon
r_if
c_cond
(paren
id|decomprbuf
op_ne
id|buf
op_logical_and
id|decomprbuf
op_ne
id|readbuf
)paren
(brace
id|kfree
c_func
(paren
id|decomprbuf
)paren
suffix:semicolon
)brace
id|out_readbuf
suffix:colon
r_if
c_cond
(paren
id|readbuf
op_ne
id|buf
)paren
(brace
id|kfree
c_func
(paren
id|readbuf
)paren
suffix:semicolon
)brace
id|out_ri
suffix:colon
id|jffs2_free_raw_inode
c_func
(paren
id|ri
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
eof
