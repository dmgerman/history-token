multiline_comment|/*&n; * JFFS2 -- Journalling Flash File System, Version 2.&n; *&n; * Copyright (C) 2001 Red Hat, Inc.&n; *&n; * Created by David Woodhouse &lt;dwmw2@cambridge.redhat.com&gt;&n; *&n; * The original JFFS, from which the design for JFFS2 was derived,&n; * was designed and implemented by Axis Communications AB.&n; *&n; * The contents of this file are subject to the Red Hat eCos Public&n; * License Version 1.1 (the &quot;Licence&quot;); you may not use this file&n; * except in compliance with the Licence.  You may obtain a copy of&n; * the Licence at http://www.redhat.com/&n; *&n; * Software distributed under the Licence is distributed on an &quot;AS IS&quot;&n; * basis, WITHOUT WARRANTY OF ANY KIND, either express or implied.&n; * See the Licence for the specific language governing rights and&n; * limitations under the Licence.&n; *&n; * The Original Code is JFFS2 - Journalling Flash File System, version 2&n; *&n; * Alternatively, the contents of this file may be used under the&n; * terms of the GNU General Public License version 2 (the &quot;GPL&quot;), in&n; * which case the provisions of the GPL are applicable instead of the&n; * above.  If you wish to allow the use of your version of this file&n; * only under the terms of the GPL and not to allow others to use your&n; * version of this file under the RHEPL, indicate your decision by&n; * deleting the provisions above and replace them with the notice and&n; * other provisions required by the GPL.  If you do not delete the&n; * provisions above, a recipient may use your version of this file&n; * under either the RHEPL or the GPL.&n; *&n; * $Id: erase.c,v 1.19 2001/03/25 22:36:12 dwmw2 Exp $&n; *&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/mtd/mtd.h&gt;
macro_line|#include &lt;linux/jffs2.h&gt;
macro_line|#include &lt;linux/interrupt.h&gt;
macro_line|#include &quot;nodelist.h&quot;
macro_line|#include &quot;crc32.h&quot;
DECL|struct|erase_priv_struct
r_struct
id|erase_priv_struct
(brace
DECL|member|jeb
r_struct
id|jffs2_eraseblock
op_star
id|jeb
suffix:semicolon
DECL|member|c
r_struct
id|jffs2_sb_info
op_star
id|c
suffix:semicolon
)brace
suffix:semicolon
r_static
r_void
id|jffs2_erase_callback
c_func
(paren
r_struct
id|erase_info
op_star
)paren
suffix:semicolon
r_static
r_void
id|jffs2_free_all_node_refs
c_func
(paren
r_struct
id|jffs2_sb_info
op_star
id|c
comma
r_struct
id|jffs2_eraseblock
op_star
id|jeb
)paren
suffix:semicolon
DECL|function|jffs2_erase_block
r_void
id|jffs2_erase_block
c_func
(paren
r_struct
id|jffs2_sb_info
op_star
id|c
comma
r_struct
id|jffs2_eraseblock
op_star
id|jeb
)paren
(brace
r_struct
id|erase_info
op_star
id|instr
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|instr
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|erase_info
)paren
op_plus
r_sizeof
(paren
r_struct
id|erase_priv_struct
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|instr
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;kmalloc for struct erase_info in jffs2_erase_block failed. Refiling block for later&bslash;n&quot;
)paren
suffix:semicolon
id|spin_lock_bh
c_func
(paren
op_amp
id|c-&gt;erase_completion_lock
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|jeb-&gt;list
)paren
suffix:semicolon
id|list_add
c_func
(paren
op_amp
id|jeb-&gt;list
comma
op_amp
id|c-&gt;erase_pending_list
)paren
suffix:semicolon
id|c-&gt;erasing_size
op_sub_assign
id|c-&gt;sector_size
suffix:semicolon
id|spin_unlock_bh
c_func
(paren
op_amp
id|c-&gt;erase_completion_lock
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|memset
c_func
(paren
id|instr
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|instr
)paren
)paren
suffix:semicolon
id|instr-&gt;mtd
op_assign
id|c-&gt;mtd
suffix:semicolon
id|instr-&gt;addr
op_assign
id|jeb-&gt;offset
suffix:semicolon
id|instr-&gt;len
op_assign
id|c-&gt;sector_size
suffix:semicolon
id|instr-&gt;callback
op_assign
id|jffs2_erase_callback
suffix:semicolon
id|instr-&gt;priv
op_assign
(paren
r_int
r_int
)paren
(paren
op_amp
id|instr
(braket
l_int|1
)braket
)paren
suffix:semicolon
(paren
(paren
r_struct
id|erase_priv_struct
op_star
)paren
id|instr-&gt;priv
)paren
op_member_access_from_pointer
id|jeb
op_assign
id|jeb
suffix:semicolon
(paren
(paren
r_struct
id|erase_priv_struct
op_star
)paren
id|instr-&gt;priv
)paren
op_member_access_from_pointer
id|c
op_assign
id|c
suffix:semicolon
id|ret
op_assign
id|c-&gt;mtd
op_member_access_from_pointer
id|erase
c_func
(paren
id|c-&gt;mtd
comma
id|instr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
(brace
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ret
op_eq
op_minus
id|ENOMEM
op_logical_or
id|ret
op_eq
op_minus
id|EAGAIN
)paren
(brace
multiline_comment|/* Erase failed immediately. Refile it on the list */
id|D1
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Erase at 0x%08x failed: %d. Refiling on erase_pending_list&bslash;n&quot;
comma
id|jeb-&gt;offset
comma
id|ret
)paren
)paren
suffix:semicolon
id|spin_lock_bh
c_func
(paren
op_amp
id|c-&gt;erase_completion_lock
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|jeb-&gt;list
)paren
suffix:semicolon
id|list_add
c_func
(paren
op_amp
id|jeb-&gt;list
comma
op_amp
id|c-&gt;erase_pending_list
)paren
suffix:semicolon
id|c-&gt;erasing_size
op_sub_assign
id|c-&gt;sector_size
suffix:semicolon
id|spin_unlock_bh
c_func
(paren
op_amp
id|c-&gt;erase_completion_lock
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|instr
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Erase at 0x%08x failed immediately: %d&bslash;n&quot;
comma
id|jeb-&gt;offset
comma
id|ret
)paren
suffix:semicolon
id|spin_lock_bh
c_func
(paren
op_amp
id|c-&gt;erase_completion_lock
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|jeb-&gt;list
)paren
suffix:semicolon
id|list_add
c_func
(paren
op_amp
id|jeb-&gt;list
comma
op_amp
id|c-&gt;bad_list
)paren
suffix:semicolon
id|c-&gt;nr_erasing_blocks
op_decrement
suffix:semicolon
id|c-&gt;bad_size
op_add_assign
id|c-&gt;sector_size
suffix:semicolon
id|c-&gt;erasing_size
op_sub_assign
id|c-&gt;sector_size
suffix:semicolon
id|spin_unlock_bh
c_func
(paren
op_amp
id|c-&gt;erase_completion_lock
)paren
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|c-&gt;erase_wait
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|instr
)paren
suffix:semicolon
)brace
DECL|function|jffs2_erase_pending_blocks
r_void
id|jffs2_erase_pending_blocks
c_func
(paren
r_struct
id|jffs2_sb_info
op_star
id|c
)paren
(brace
r_struct
id|jffs2_eraseblock
op_star
id|jeb
suffix:semicolon
id|spin_lock_bh
c_func
(paren
op_amp
id|c-&gt;erase_completion_lock
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|c-&gt;erase_pending_list
)paren
)paren
(brace
id|jeb
op_assign
id|list_entry
c_func
(paren
id|c-&gt;erase_pending_list.next
comma
r_struct
id|jffs2_eraseblock
comma
id|list
)paren
suffix:semicolon
id|D1
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Starting erase of pending block 0x%08x&bslash;n&quot;
comma
id|jeb-&gt;offset
)paren
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|jeb-&gt;list
)paren
suffix:semicolon
id|c-&gt;erasing_size
op_add_assign
id|c-&gt;sector_size
suffix:semicolon
id|c-&gt;free_size
op_sub_assign
id|jeb-&gt;free_size
suffix:semicolon
id|c-&gt;used_size
op_sub_assign
id|jeb-&gt;used_size
suffix:semicolon
id|c-&gt;dirty_size
op_sub_assign
id|jeb-&gt;dirty_size
suffix:semicolon
id|jeb-&gt;used_size
op_assign
id|jeb-&gt;dirty_size
op_assign
id|jeb-&gt;free_size
op_assign
l_int|0
suffix:semicolon
id|jffs2_free_all_node_refs
c_func
(paren
id|c
comma
id|jeb
)paren
suffix:semicolon
id|list_add
c_func
(paren
op_amp
id|jeb-&gt;list
comma
op_amp
id|c-&gt;erasing_list
)paren
suffix:semicolon
id|spin_unlock_bh
c_func
(paren
op_amp
id|c-&gt;erase_completion_lock
)paren
suffix:semicolon
id|jffs2_erase_block
c_func
(paren
id|c
comma
id|jeb
)paren
suffix:semicolon
multiline_comment|/* Be nice */
r_if
c_cond
(paren
id|current-&gt;need_resched
)paren
id|schedule
c_func
(paren
)paren
suffix:semicolon
id|spin_lock_bh
c_func
(paren
op_amp
id|c-&gt;erase_completion_lock
)paren
suffix:semicolon
)brace
id|spin_unlock_bh
c_func
(paren
op_amp
id|c-&gt;erase_completion_lock
)paren
suffix:semicolon
id|D1
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;jffs2_erase_pending_blocks completed&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
DECL|function|jffs2_erase_callback
r_static
r_void
id|jffs2_erase_callback
c_func
(paren
r_struct
id|erase_info
op_star
id|instr
)paren
(brace
r_struct
id|erase_priv_struct
op_star
id|priv
op_assign
(paren
r_void
op_star
)paren
id|instr-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|instr-&gt;state
op_ne
id|MTD_ERASE_DONE
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Erase at 0x%08x finished, but state != MTD_ERASE_DONE. State is 0x%x instead.&bslash;n&quot;
comma
id|instr-&gt;addr
comma
id|instr-&gt;state
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|priv-&gt;c-&gt;erase_completion_lock
)paren
suffix:semicolon
id|priv-&gt;c-&gt;erasing_size
op_sub_assign
id|priv-&gt;c-&gt;sector_size
suffix:semicolon
id|priv-&gt;c-&gt;bad_size
op_add_assign
id|priv-&gt;c-&gt;sector_size
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|priv-&gt;jeb-&gt;list
)paren
suffix:semicolon
id|list_add
c_func
(paren
op_amp
id|priv-&gt;jeb-&gt;list
comma
op_amp
id|priv-&gt;c-&gt;bad_list
)paren
suffix:semicolon
id|priv-&gt;c-&gt;nr_erasing_blocks
op_decrement
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|priv-&gt;c-&gt;erase_completion_lock
)paren
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|priv-&gt;c-&gt;erase_wait
)paren
suffix:semicolon
)brace
r_else
(brace
id|D1
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Erase completed successfully at 0x%08lx&bslash;n&quot;
comma
id|instr-&gt;addr
)paren
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|priv-&gt;c-&gt;erase_completion_lock
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|priv-&gt;jeb-&gt;list
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|priv-&gt;jeb-&gt;list
comma
op_amp
id|priv-&gt;c-&gt;erase_complete_list
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|priv-&gt;c-&gt;erase_completion_lock
)paren
suffix:semicolon
)brace
multiline_comment|/* Make sure someone picks up the block off the erase_complete list */
id|OFNI_BS_2SFFJ
c_func
(paren
id|priv-&gt;c
)paren
op_member_access_from_pointer
id|s_dirt
op_assign
l_int|1
suffix:semicolon
id|kfree
c_func
(paren
id|instr
)paren
suffix:semicolon
)brace
multiline_comment|/* Hmmm. Maybe we should accept the extra space it takes and make&n;   this a standard doubly-linked list? */
DECL|function|jffs2_remove_node_ref_from_ino_list
r_static
r_inline
r_void
id|jffs2_remove_node_ref_from_ino_list
c_func
(paren
r_struct
id|jffs2_sb_info
op_star
id|sbinfo
comma
r_struct
id|jffs2_raw_node_ref
op_star
id|ref
)paren
(brace
r_struct
id|jffs2_inode_cache
op_star
id|ic
suffix:semicolon
r_struct
id|jffs2_raw_node_ref
op_star
op_star
id|prev
comma
op_star
id|this
suffix:semicolon
id|D2
c_func
(paren
r_int
id|c
op_assign
l_int|0
)paren
suffix:semicolon
id|this
op_assign
id|ref
suffix:semicolon
r_while
c_loop
(paren
id|this-&gt;next_in_ino
)paren
(brace
id|this
op_assign
id|this-&gt;next_in_ino
suffix:semicolon
)brace
id|ic
op_assign
(paren
r_struct
id|jffs2_inode_cache
op_star
)paren
id|this
suffix:semicolon
id|D1
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Removing node at phys 0x%08x from ino #%u&bslash;n&quot;
comma
id|ref-&gt;flash_offset
op_amp
op_complement
l_int|3
comma
id|ic-&gt;ino
)paren
)paren
suffix:semicolon
id|prev
op_assign
op_amp
id|ic-&gt;nodes
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
op_star
id|prev
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Eep. ic-&gt;nodes == NULL.&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_while
c_loop
(paren
op_star
id|prev
op_ne
id|ref
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
op_star
id|prev
)paren
op_member_access_from_pointer
id|next_in_ino
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Eep. node at phys 0x%08x, mem %p. next_in_ino is NULL.&bslash;n&quot;
comma
(paren
op_star
id|prev
)paren
op_member_access_from_pointer
id|flash_offset
op_amp
op_complement
l_int|3
comma
op_star
id|prev
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|prev
op_assign
op_amp
(paren
op_star
id|prev
)paren
op_member_access_from_pointer
id|next_in_ino
suffix:semicolon
)brace
op_star
id|prev
op_assign
id|ref-&gt;next_in_ino
suffix:semicolon
id|this
op_assign
id|ic-&gt;nodes
suffix:semicolon
id|D2
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;After remove_node_ref_from_ino_list: &bslash;n&quot;
id|KERN_DEBUG
)paren
suffix:semicolon
r_while
(paren
id|this
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;0x%08x(%d)-&gt;&quot;
comma
id|this-&gt;flash_offset
op_amp
op_complement
l_int|3
comma
id|this-&gt;flash_offset
op_amp
l_int|3
)paren
suffix:semicolon
r_if
(paren
op_increment
id|c
op_eq
l_int|5
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
id|KERN_DEBUG
)paren
suffix:semicolon
id|c
op_assign
l_int|0
suffix:semicolon
)brace
id|this
op_assign
id|this-&gt;next_in_ino
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ic-&gt;nodes
op_eq
(paren
r_void
op_star
)paren
id|ic
)paren
(brace
id|D1
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;inocache for ino #%u is all gone now. Freeing&bslash;n&quot;
comma
id|ic-&gt;ino
)paren
)paren
suffix:semicolon
id|jffs2_del_ino_cache
c_func
(paren
id|sbinfo
comma
id|ic
)paren
suffix:semicolon
id|jffs2_free_inode_cache
c_func
(paren
id|ic
)paren
suffix:semicolon
)brace
)brace
DECL|function|jffs2_free_all_node_refs
r_static
r_void
id|jffs2_free_all_node_refs
c_func
(paren
r_struct
id|jffs2_sb_info
op_star
id|c
comma
r_struct
id|jffs2_eraseblock
op_star
id|jeb
)paren
(brace
r_struct
id|jffs2_raw_node_ref
op_star
id|ref
suffix:semicolon
id|D1
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Freeing all node refs for eraseblock offset 0x%08x&bslash;n&quot;
comma
id|jeb-&gt;offset
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|jeb-&gt;first_node
)paren
(brace
id|ref
op_assign
id|jeb-&gt;first_node
suffix:semicolon
id|jeb-&gt;first_node
op_assign
id|ref-&gt;next_phys
suffix:semicolon
multiline_comment|/* Remove from the inode-list */
r_if
c_cond
(paren
id|ref-&gt;next_in_ino
)paren
id|jffs2_remove_node_ref_from_ino_list
c_func
(paren
id|c
comma
id|ref
)paren
suffix:semicolon
multiline_comment|/* else it was a non-inode node so don&squot;t bother */
id|jffs2_free_raw_node_ref
c_func
(paren
id|ref
)paren
suffix:semicolon
)brace
id|jeb-&gt;last_node
op_assign
l_int|NULL
suffix:semicolon
)brace
DECL|function|jffs2_erase_pending_trigger
r_void
id|jffs2_erase_pending_trigger
c_func
(paren
r_struct
id|jffs2_sb_info
op_star
id|c
)paren
(brace
id|OFNI_BS_2SFFJ
c_func
(paren
id|c
)paren
op_member_access_from_pointer
id|s_dirt
op_assign
l_int|1
suffix:semicolon
)brace
DECL|function|jffs2_mark_erased_blocks
r_void
id|jffs2_mark_erased_blocks
c_func
(paren
r_struct
id|jffs2_sb_info
op_star
id|c
)paren
(brace
r_static
r_struct
id|jffs2_unknown_node
id|marker
op_assign
(brace
id|JFFS2_MAGIC_BITMASK
comma
id|JFFS2_NODETYPE_CLEANMARKER
comma
r_sizeof
(paren
r_struct
id|jffs2_unknown_node
)paren
)brace
suffix:semicolon
r_struct
id|jffs2_eraseblock
op_star
id|jeb
suffix:semicolon
r_struct
id|jffs2_raw_node_ref
op_star
id|marker_ref
suffix:semicolon
r_int
r_char
op_star
id|ebuf
suffix:semicolon
id|ssize_t
id|retlen
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|marker.hdr_crc
op_assign
id|crc32
c_func
(paren
l_int|0
comma
op_amp
id|marker
comma
r_sizeof
(paren
r_struct
id|jffs2_unknown_node
)paren
op_minus
l_int|4
)paren
suffix:semicolon
id|spin_lock_bh
c_func
(paren
op_amp
id|c-&gt;erase_completion_lock
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|c-&gt;erase_complete_list
)paren
)paren
(brace
id|jeb
op_assign
id|list_entry
c_func
(paren
id|c-&gt;erase_complete_list.next
comma
r_struct
id|jffs2_eraseblock
comma
id|list
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|jeb-&gt;list
)paren
suffix:semicolon
id|spin_unlock_bh
c_func
(paren
op_amp
id|c-&gt;erase_completion_lock
)paren
suffix:semicolon
id|marker_ref
op_assign
id|jffs2_alloc_raw_node_ref
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|marker_ref
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Failed to allocate raw node ref for clean marker&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Come back later */
id|jffs2_erase_pending_trigger
c_func
(paren
id|c
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|ebuf
op_assign
id|kmalloc
c_func
(paren
id|PAGE_SIZE
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ebuf
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Failed to allocate page buffer for verifying erase at 0x%08x. Assuming it worked&bslash;n&quot;
comma
id|jeb-&gt;offset
)paren
suffix:semicolon
)brace
r_else
(brace
id|__u32
id|ofs
op_assign
id|jeb-&gt;offset
suffix:semicolon
id|D1
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Verifying erase at 0x%08x&bslash;n&quot;
comma
id|jeb-&gt;offset
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|ofs
OL
id|jeb-&gt;offset
op_plus
id|c-&gt;sector_size
)paren
(brace
id|__u32
id|readlen
op_assign
id|min
c_func
(paren
id|PAGE_SIZE
comma
id|jeb-&gt;offset
op_plus
id|c-&gt;sector_size
op_minus
id|ofs
)paren
suffix:semicolon
r_int
id|i
suffix:semicolon
id|ret
op_assign
id|c-&gt;mtd
op_member_access_from_pointer
id|read
c_func
(paren
id|c-&gt;mtd
comma
id|ofs
comma
id|readlen
comma
op_amp
id|retlen
comma
id|ebuf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Read of newly-erased block at 0x%08x failed: %d. Putting on bad_list&bslash;n&quot;
comma
id|ofs
comma
id|ret
)paren
suffix:semicolon
r_goto
id|bad
suffix:semicolon
)brace
r_if
c_cond
(paren
id|retlen
op_ne
id|readlen
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Short read from newly-erased block at 0x%08x. Wanted %d, got %d&bslash;n&quot;
comma
id|ofs
comma
id|readlen
comma
id|retlen
)paren
suffix:semicolon
r_goto
id|bad
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|readlen
suffix:semicolon
id|i
op_add_assign
r_sizeof
(paren
r_int
r_int
)paren
)paren
(brace
multiline_comment|/* It&squot;s OK. We know it&squot;s properly aligned */
r_int
r_int
id|datum
op_assign
op_star
(paren
r_int
r_int
op_star
)paren
(paren
op_amp
id|ebuf
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|datum
op_plus
l_int|1
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Newly-erased block contained word 0x%lx at offset 0x%08x&bslash;n&quot;
comma
id|datum
comma
id|ofs
op_plus
id|i
)paren
suffix:semicolon
id|bad
suffix:colon
id|jffs2_free_raw_node_ref
c_func
(paren
id|marker_ref
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|ebuf
)paren
suffix:semicolon
id|bad2
suffix:colon
id|spin_lock_bh
c_func
(paren
op_amp
id|c-&gt;erase_completion_lock
)paren
suffix:semicolon
id|c-&gt;erasing_size
op_sub_assign
id|c-&gt;sector_size
suffix:semicolon
id|c-&gt;bad_size
op_add_assign
id|c-&gt;sector_size
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|jeb-&gt;list
comma
op_amp
id|c-&gt;bad_list
)paren
suffix:semicolon
id|c-&gt;nr_erasing_blocks
op_decrement
suffix:semicolon
id|spin_unlock_bh
c_func
(paren
op_amp
id|c-&gt;erase_completion_lock
)paren
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|c-&gt;erase_wait
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
id|ofs
op_add_assign
id|readlen
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|ebuf
)paren
suffix:semicolon
)brace
multiline_comment|/* Write the erase complete marker */
id|D1
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Writing erased marker to block at 0x%08x&bslash;n&quot;
comma
id|jeb-&gt;offset
)paren
)paren
suffix:semicolon
id|ret
op_assign
id|c-&gt;mtd
op_member_access_from_pointer
id|write
c_func
(paren
id|c-&gt;mtd
comma
id|jeb-&gt;offset
comma
r_sizeof
(paren
id|marker
)paren
comma
op_amp
id|retlen
comma
(paren
r_char
op_star
)paren
op_amp
id|marker
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Write clean marker to block at 0x%08x failed: %d&bslash;n&quot;
comma
id|jeb-&gt;offset
comma
id|ret
)paren
suffix:semicolon
r_goto
id|bad2
suffix:semicolon
)brace
r_if
c_cond
(paren
id|retlen
op_ne
r_sizeof
(paren
id|marker
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Short write to newly-erased block at 0x%08x: Wanted %d, got %d&bslash;n&quot;
comma
id|jeb-&gt;offset
comma
r_sizeof
(paren
id|marker
)paren
comma
id|retlen
)paren
suffix:semicolon
r_goto
id|bad2
suffix:semicolon
)brace
id|marker_ref-&gt;next_in_ino
op_assign
l_int|NULL
suffix:semicolon
id|marker_ref-&gt;next_phys
op_assign
l_int|NULL
suffix:semicolon
id|marker_ref-&gt;flash_offset
op_assign
id|jeb-&gt;offset
suffix:semicolon
id|marker_ref-&gt;totlen
op_assign
id|PAD
c_func
(paren
r_sizeof
(paren
id|marker
)paren
)paren
suffix:semicolon
id|jeb-&gt;first_node
op_assign
id|jeb-&gt;last_node
op_assign
id|marker_ref
suffix:semicolon
id|jeb-&gt;free_size
op_assign
id|c-&gt;sector_size
op_minus
id|marker_ref-&gt;totlen
suffix:semicolon
id|jeb-&gt;used_size
op_assign
id|marker_ref-&gt;totlen
suffix:semicolon
id|jeb-&gt;dirty_size
op_assign
l_int|0
suffix:semicolon
id|spin_lock_bh
c_func
(paren
op_amp
id|c-&gt;erase_completion_lock
)paren
suffix:semicolon
id|c-&gt;erasing_size
op_sub_assign
id|c-&gt;sector_size
suffix:semicolon
id|c-&gt;free_size
op_add_assign
id|jeb-&gt;free_size
suffix:semicolon
id|c-&gt;used_size
op_add_assign
id|jeb-&gt;used_size
suffix:semicolon
id|ACCT_SANITY_CHECK
c_func
(paren
id|c
comma
id|jeb
)paren
suffix:semicolon
id|ACCT_PARANOIA_CHECK
c_func
(paren
id|jeb
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|jeb-&gt;list
comma
op_amp
id|c-&gt;free_list
)paren
suffix:semicolon
id|c-&gt;nr_erasing_blocks
op_decrement
suffix:semicolon
id|c-&gt;nr_free_blocks
op_increment
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|c-&gt;erase_wait
)paren
suffix:semicolon
)brace
id|spin_unlock_bh
c_func
(paren
op_amp
id|c-&gt;erase_completion_lock
)paren
suffix:semicolon
)brace
eof
