multiline_comment|/*&n; * JFFS2 -- Journalling Flash File System, Version 2.&n; *&n; * Copyright (C) 2001-2003 Red Hat, Inc.&n; *&n; * Created by David Woodhouse &lt;dwmw2@redhat.com&gt;&n; *&n; * For licensing information, see the file &squot;LICENCE&squot; in this directory.&n; *&n; * $Id: erase.c,v 1.61 2004/10/20 23:59:49 dwmw2 Exp $&n; *&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/mtd/mtd.h&gt;
macro_line|#include &lt;linux/compiler.h&gt;
macro_line|#include &lt;linux/crc32.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/pagemap.h&gt;
macro_line|#include &quot;nodelist.h&quot;
DECL|struct|erase_priv_struct
r_struct
id|erase_priv_struct
(brace
DECL|member|jeb
r_struct
id|jffs2_eraseblock
op_star
id|jeb
suffix:semicolon
DECL|member|c
r_struct
id|jffs2_sb_info
op_star
id|c
suffix:semicolon
)brace
suffix:semicolon
macro_line|#ifndef __ECOS
r_static
r_void
id|jffs2_erase_callback
c_func
(paren
r_struct
id|erase_info
op_star
)paren
suffix:semicolon
macro_line|#endif
r_static
r_void
id|jffs2_erase_failed
c_func
(paren
r_struct
id|jffs2_sb_info
op_star
id|c
comma
r_struct
id|jffs2_eraseblock
op_star
id|jeb
comma
r_uint32
id|bad_offset
)paren
suffix:semicolon
r_static
r_void
id|jffs2_erase_succeeded
c_func
(paren
r_struct
id|jffs2_sb_info
op_star
id|c
comma
r_struct
id|jffs2_eraseblock
op_star
id|jeb
)paren
suffix:semicolon
r_static
r_void
id|jffs2_free_all_node_refs
c_func
(paren
r_struct
id|jffs2_sb_info
op_star
id|c
comma
r_struct
id|jffs2_eraseblock
op_star
id|jeb
)paren
suffix:semicolon
r_static
r_void
id|jffs2_mark_erased_block
c_func
(paren
r_struct
id|jffs2_sb_info
op_star
id|c
comma
r_struct
id|jffs2_eraseblock
op_star
id|jeb
)paren
suffix:semicolon
DECL|function|jffs2_erase_block
r_void
id|jffs2_erase_block
c_func
(paren
r_struct
id|jffs2_sb_info
op_star
id|c
comma
r_struct
id|jffs2_eraseblock
op_star
id|jeb
)paren
(brace
r_int
id|ret
suffix:semicolon
r_uint32
id|bad_offset
suffix:semicolon
macro_line|#ifdef __ECOS
id|ret
op_assign
id|jffs2_flash_erase
c_func
(paren
id|c
comma
id|jeb
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
(brace
id|jffs2_erase_succeeded
c_func
(paren
id|c
comma
id|jeb
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
macro_line|#else /* Linux */
r_struct
id|erase_info
op_star
id|instr
suffix:semicolon
id|instr
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|erase_info
)paren
op_plus
r_sizeof
(paren
r_struct
id|erase_priv_struct
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|instr
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;kmalloc for struct erase_info in jffs2_erase_block failed. Refiling block for later&bslash;n&quot;
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|c-&gt;erase_completion_lock
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|jeb-&gt;list
)paren
suffix:semicolon
id|list_add
c_func
(paren
op_amp
id|jeb-&gt;list
comma
op_amp
id|c-&gt;erase_pending_list
)paren
suffix:semicolon
id|c-&gt;erasing_size
op_sub_assign
id|c-&gt;sector_size
suffix:semicolon
id|c-&gt;dirty_size
op_add_assign
id|c-&gt;sector_size
suffix:semicolon
id|jeb-&gt;dirty_size
op_assign
id|c-&gt;sector_size
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|c-&gt;erase_completion_lock
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|memset
c_func
(paren
id|instr
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|instr
)paren
)paren
suffix:semicolon
id|instr-&gt;mtd
op_assign
id|c-&gt;mtd
suffix:semicolon
id|instr-&gt;addr
op_assign
id|jeb-&gt;offset
suffix:semicolon
id|instr-&gt;len
op_assign
id|c-&gt;sector_size
suffix:semicolon
id|instr-&gt;callback
op_assign
id|jffs2_erase_callback
suffix:semicolon
id|instr-&gt;priv
op_assign
(paren
r_int
r_int
)paren
(paren
op_amp
id|instr
(braket
l_int|1
)braket
)paren
suffix:semicolon
id|instr-&gt;fail_addr
op_assign
l_int|0xffffffff
suffix:semicolon
(paren
(paren
r_struct
id|erase_priv_struct
op_star
)paren
id|instr-&gt;priv
)paren
op_member_access_from_pointer
id|jeb
op_assign
id|jeb
suffix:semicolon
(paren
(paren
r_struct
id|erase_priv_struct
op_star
)paren
id|instr-&gt;priv
)paren
op_member_access_from_pointer
id|c
op_assign
id|c
suffix:semicolon
id|ret
op_assign
id|c-&gt;mtd
op_member_access_from_pointer
id|erase
c_func
(paren
id|c-&gt;mtd
comma
id|instr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
r_return
suffix:semicolon
id|bad_offset
op_assign
id|instr-&gt;fail_addr
suffix:semicolon
id|kfree
c_func
(paren
id|instr
)paren
suffix:semicolon
macro_line|#endif /* __ECOS */
r_if
c_cond
(paren
id|ret
op_eq
op_minus
id|ENOMEM
op_logical_or
id|ret
op_eq
op_minus
id|EAGAIN
)paren
(brace
multiline_comment|/* Erase failed immediately. Refile it on the list */
id|D1
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Erase at 0x%08x failed: %d. Refiling on erase_pending_list&bslash;n&quot;
comma
id|jeb-&gt;offset
comma
id|ret
)paren
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|c-&gt;erase_completion_lock
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|jeb-&gt;list
)paren
suffix:semicolon
id|list_add
c_func
(paren
op_amp
id|jeb-&gt;list
comma
op_amp
id|c-&gt;erase_pending_list
)paren
suffix:semicolon
id|c-&gt;erasing_size
op_sub_assign
id|c-&gt;sector_size
suffix:semicolon
id|c-&gt;dirty_size
op_add_assign
id|c-&gt;sector_size
suffix:semicolon
id|jeb-&gt;dirty_size
op_assign
id|c-&gt;sector_size
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|c-&gt;erase_completion_lock
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ret
op_eq
op_minus
id|EROFS
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Erase at 0x%08x failed immediately: -EROFS. Is the sector locked?&bslash;n&quot;
comma
id|jeb-&gt;offset
)paren
suffix:semicolon
r_else
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Erase at 0x%08x failed immediately: errno %d&bslash;n&quot;
comma
id|jeb-&gt;offset
comma
id|ret
)paren
suffix:semicolon
id|jffs2_erase_failed
c_func
(paren
id|c
comma
id|jeb
comma
id|bad_offset
)paren
suffix:semicolon
)brace
DECL|function|jffs2_erase_pending_blocks
r_void
id|jffs2_erase_pending_blocks
c_func
(paren
r_struct
id|jffs2_sb_info
op_star
id|c
comma
r_int
id|count
)paren
(brace
r_struct
id|jffs2_eraseblock
op_star
id|jeb
suffix:semicolon
id|down
c_func
(paren
op_amp
id|c-&gt;erase_free_sem
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|c-&gt;erase_completion_lock
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|c-&gt;erase_complete_list
)paren
op_logical_or
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|c-&gt;erase_pending_list
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|c-&gt;erase_complete_list
)paren
)paren
(brace
id|jeb
op_assign
id|list_entry
c_func
(paren
id|c-&gt;erase_complete_list.next
comma
r_struct
id|jffs2_eraseblock
comma
id|list
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|jeb-&gt;list
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|c-&gt;erase_completion_lock
)paren
suffix:semicolon
id|jffs2_mark_erased_block
c_func
(paren
id|c
comma
id|jeb
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
op_decrement
id|count
)paren
(brace
id|D1
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Count reached. jffs2_erase_pending_blocks leaving&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_goto
id|done
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|c-&gt;erase_pending_list
)paren
)paren
(brace
id|jeb
op_assign
id|list_entry
c_func
(paren
id|c-&gt;erase_pending_list.next
comma
r_struct
id|jffs2_eraseblock
comma
id|list
)paren
suffix:semicolon
id|D1
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Starting erase of pending block 0x%08x&bslash;n&quot;
comma
id|jeb-&gt;offset
)paren
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|jeb-&gt;list
)paren
suffix:semicolon
id|c-&gt;erasing_size
op_add_assign
id|c-&gt;sector_size
suffix:semicolon
id|c-&gt;wasted_size
op_sub_assign
id|jeb-&gt;wasted_size
suffix:semicolon
id|c-&gt;free_size
op_sub_assign
id|jeb-&gt;free_size
suffix:semicolon
id|c-&gt;used_size
op_sub_assign
id|jeb-&gt;used_size
suffix:semicolon
id|c-&gt;dirty_size
op_sub_assign
id|jeb-&gt;dirty_size
suffix:semicolon
id|jeb-&gt;wasted_size
op_assign
id|jeb-&gt;used_size
op_assign
id|jeb-&gt;dirty_size
op_assign
id|jeb-&gt;free_size
op_assign
l_int|0
suffix:semicolon
id|jffs2_free_all_node_refs
c_func
(paren
id|c
comma
id|jeb
)paren
suffix:semicolon
id|list_add
c_func
(paren
op_amp
id|jeb-&gt;list
comma
op_amp
id|c-&gt;erasing_list
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|c-&gt;erase_completion_lock
)paren
suffix:semicolon
id|jffs2_erase_block
c_func
(paren
id|c
comma
id|jeb
)paren
suffix:semicolon
)brace
r_else
(brace
id|BUG
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* Be nice */
id|cond_resched
c_func
(paren
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|c-&gt;erase_completion_lock
)paren
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|c-&gt;erase_completion_lock
)paren
suffix:semicolon
id|done
suffix:colon
id|D1
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;jffs2_erase_pending_blocks completed&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|c-&gt;erase_free_sem
)paren
suffix:semicolon
)brace
DECL|function|jffs2_erase_succeeded
r_static
r_void
id|jffs2_erase_succeeded
c_func
(paren
r_struct
id|jffs2_sb_info
op_star
id|c
comma
r_struct
id|jffs2_eraseblock
op_star
id|jeb
)paren
(brace
id|D1
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Erase completed successfully at 0x%08x&bslash;n&quot;
comma
id|jeb-&gt;offset
)paren
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|c-&gt;erase_completion_lock
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|jeb-&gt;list
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|jeb-&gt;list
comma
op_amp
id|c-&gt;erase_complete_list
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|c-&gt;erase_completion_lock
)paren
suffix:semicolon
multiline_comment|/* Ensure that kupdated calls us again to mark them clean */
id|jffs2_erase_pending_trigger
c_func
(paren
id|c
)paren
suffix:semicolon
)brace
DECL|function|jffs2_erase_failed
r_static
r_void
id|jffs2_erase_failed
c_func
(paren
r_struct
id|jffs2_sb_info
op_star
id|c
comma
r_struct
id|jffs2_eraseblock
op_star
id|jeb
comma
r_uint32
id|bad_offset
)paren
(brace
multiline_comment|/* For NAND, if the failure did not occur at the device level for a&n;&t;   specific physical page, don&squot;t bother updating the bad block table. */
r_if
c_cond
(paren
id|jffs2_cleanmarker_oob
c_func
(paren
id|c
)paren
op_logical_and
(paren
id|bad_offset
op_ne
l_int|0xffffffff
)paren
)paren
(brace
multiline_comment|/* We had a device-level failure to erase.  Let&squot;s see if we&squot;ve&n;&t;&t;   failed too many times. */
r_if
c_cond
(paren
op_logical_neg
id|jffs2_write_nand_badblock
c_func
(paren
id|c
comma
id|jeb
comma
id|bad_offset
)paren
)paren
(brace
multiline_comment|/* We&squot;d like to give this block another try. */
id|spin_lock
c_func
(paren
op_amp
id|c-&gt;erase_completion_lock
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|jeb-&gt;list
)paren
suffix:semicolon
id|list_add
c_func
(paren
op_amp
id|jeb-&gt;list
comma
op_amp
id|c-&gt;erase_pending_list
)paren
suffix:semicolon
id|c-&gt;erasing_size
op_sub_assign
id|c-&gt;sector_size
suffix:semicolon
id|c-&gt;dirty_size
op_add_assign
id|c-&gt;sector_size
suffix:semicolon
id|jeb-&gt;dirty_size
op_assign
id|c-&gt;sector_size
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|c-&gt;erase_completion_lock
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
id|spin_lock
c_func
(paren
op_amp
id|c-&gt;erase_completion_lock
)paren
suffix:semicolon
id|c-&gt;erasing_size
op_sub_assign
id|c-&gt;sector_size
suffix:semicolon
id|c-&gt;bad_size
op_add_assign
id|c-&gt;sector_size
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|jeb-&gt;list
)paren
suffix:semicolon
id|list_add
c_func
(paren
op_amp
id|jeb-&gt;list
comma
op_amp
id|c-&gt;bad_list
)paren
suffix:semicolon
id|c-&gt;nr_erasing_blocks
op_decrement
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|c-&gt;erase_completion_lock
)paren
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|c-&gt;erase_wait
)paren
suffix:semicolon
)brace
macro_line|#ifndef __ECOS
DECL|function|jffs2_erase_callback
r_static
r_void
id|jffs2_erase_callback
c_func
(paren
r_struct
id|erase_info
op_star
id|instr
)paren
(brace
r_struct
id|erase_priv_struct
op_star
id|priv
op_assign
(paren
r_void
op_star
)paren
id|instr-&gt;priv
suffix:semicolon
r_if
c_cond
(paren
id|instr-&gt;state
op_ne
id|MTD_ERASE_DONE
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Erase at 0x%08x finished, but state != MTD_ERASE_DONE. State is 0x%x instead.&bslash;n&quot;
comma
id|instr-&gt;addr
comma
id|instr-&gt;state
)paren
suffix:semicolon
id|jffs2_erase_failed
c_func
(paren
id|priv-&gt;c
comma
id|priv-&gt;jeb
comma
id|instr-&gt;fail_addr
)paren
suffix:semicolon
)brace
r_else
(brace
id|jffs2_erase_succeeded
c_func
(paren
id|priv-&gt;c
comma
id|priv-&gt;jeb
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|instr
)paren
suffix:semicolon
)brace
macro_line|#endif /* !__ECOS */
multiline_comment|/* Hmmm. Maybe we should accept the extra space it takes and make&n;   this a standard doubly-linked list? */
DECL|function|jffs2_remove_node_refs_from_ino_list
r_static
r_inline
r_void
id|jffs2_remove_node_refs_from_ino_list
c_func
(paren
r_struct
id|jffs2_sb_info
op_star
id|c
comma
r_struct
id|jffs2_raw_node_ref
op_star
id|ref
comma
r_struct
id|jffs2_eraseblock
op_star
id|jeb
)paren
(brace
r_struct
id|jffs2_inode_cache
op_star
id|ic
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|jffs2_raw_node_ref
op_star
op_star
id|prev
suffix:semicolon
id|prev
op_assign
op_amp
id|ref-&gt;next_in_ino
suffix:semicolon
multiline_comment|/* Walk the inode&squot;s list once, removing any nodes from this eraseblock */
r_while
c_loop
(paren
l_int|1
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
op_star
id|prev
)paren
op_member_access_from_pointer
id|next_in_ino
)paren
(brace
multiline_comment|/* We&squot;re looking at the jffs2_inode_cache, which is &n;&t;&t;&t;   at the end of the linked list. Stash it and continue&n;&t;&t;&t;   from the beginning of the list */
id|ic
op_assign
(paren
r_struct
id|jffs2_inode_cache
op_star
)paren
(paren
op_star
id|prev
)paren
suffix:semicolon
id|prev
op_assign
op_amp
id|ic-&gt;nodes
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
(paren
op_star
id|prev
)paren
op_member_access_from_pointer
id|flash_offset
op_amp
op_complement
(paren
id|c-&gt;sector_size
op_minus
l_int|1
)paren
)paren
op_eq
id|jeb-&gt;offset
)paren
(brace
multiline_comment|/* It&squot;s in the block we&squot;re erasing */
r_struct
id|jffs2_raw_node_ref
op_star
id|this
suffix:semicolon
id|this
op_assign
op_star
id|prev
suffix:semicolon
op_star
id|prev
op_assign
id|this-&gt;next_in_ino
suffix:semicolon
id|this-&gt;next_in_ino
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|this
op_eq
id|ref
)paren
r_break
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/* Not to be deleted. Skip */
id|prev
op_assign
op_amp
(paren
(paren
op_star
id|prev
)paren
op_member_access_from_pointer
id|next_in_ino
)paren
suffix:semicolon
)brace
multiline_comment|/* PARANOIA */
r_if
c_cond
(paren
op_logical_neg
id|ic
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;inode_cache not found in remove_node_refs()!!&bslash;n&quot;
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|D1
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Removed nodes in range 0x%08x-0x%08x from ino #%u&bslash;n&quot;
comma
id|jeb-&gt;offset
comma
id|jeb-&gt;offset
op_plus
id|c-&gt;sector_size
comma
id|ic-&gt;ino
)paren
)paren
suffix:semicolon
id|D2
c_func
(paren
(brace
r_int
id|i
op_assign
l_int|0
suffix:semicolon
r_struct
id|jffs2_raw_node_ref
op_star
id|this
suffix:semicolon
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;After remove_node_refs_from_ino_list: &bslash;n&quot;
id|KERN_DEBUG
)paren
suffix:semicolon
id|this
op_assign
id|ic-&gt;nodes
suffix:semicolon
r_while
(paren
id|this
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;0x%08x(%d)-&gt;&quot;
comma
id|ref_offset
c_func
(paren
id|this
)paren
comma
id|ref_flags
c_func
(paren
id|this
)paren
)paren
suffix:semicolon
r_if
(paren
op_increment
id|i
op_eq
l_int|5
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
id|KERN_DEBUG
)paren
suffix:semicolon
id|i
op_assign
l_int|0
suffix:semicolon
)brace
id|this
op_assign
id|this-&gt;next_in_ino
suffix:semicolon
)brace
id|printk
c_func
(paren
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
)brace
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ic-&gt;nodes
op_eq
(paren
r_void
op_star
)paren
id|ic
)paren
(brace
id|D1
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;inocache for ino #%u is all gone now. Freeing&bslash;n&quot;
comma
id|ic-&gt;ino
)paren
)paren
suffix:semicolon
id|jffs2_del_ino_cache
c_func
(paren
id|c
comma
id|ic
)paren
suffix:semicolon
id|jffs2_free_inode_cache
c_func
(paren
id|ic
)paren
suffix:semicolon
)brace
)brace
DECL|function|jffs2_free_all_node_refs
r_static
r_void
id|jffs2_free_all_node_refs
c_func
(paren
r_struct
id|jffs2_sb_info
op_star
id|c
comma
r_struct
id|jffs2_eraseblock
op_star
id|jeb
)paren
(brace
r_struct
id|jffs2_raw_node_ref
op_star
id|ref
suffix:semicolon
id|D1
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Freeing all node refs for eraseblock offset 0x%08x&bslash;n&quot;
comma
id|jeb-&gt;offset
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|jeb-&gt;first_node
)paren
(brace
id|ref
op_assign
id|jeb-&gt;first_node
suffix:semicolon
id|jeb-&gt;first_node
op_assign
id|ref-&gt;next_phys
suffix:semicolon
multiline_comment|/* Remove from the inode-list */
r_if
c_cond
(paren
id|ref-&gt;next_in_ino
)paren
id|jffs2_remove_node_refs_from_ino_list
c_func
(paren
id|c
comma
id|ref
comma
id|jeb
)paren
suffix:semicolon
multiline_comment|/* else it was a non-inode node or already removed, so don&squot;t bother */
id|jffs2_free_raw_node_ref
c_func
(paren
id|ref
)paren
suffix:semicolon
)brace
id|jeb-&gt;last_node
op_assign
l_int|NULL
suffix:semicolon
)brace
DECL|function|jffs2_mark_erased_block
r_static
r_void
id|jffs2_mark_erased_block
c_func
(paren
r_struct
id|jffs2_sb_info
op_star
id|c
comma
r_struct
id|jffs2_eraseblock
op_star
id|jeb
)paren
(brace
r_struct
id|jffs2_raw_node_ref
op_star
id|marker_ref
op_assign
l_int|NULL
suffix:semicolon
r_int
r_char
op_star
id|ebuf
suffix:semicolon
r_int
id|retlen
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_uint32
id|bad_offset
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|jffs2_cleanmarker_oob
c_func
(paren
id|c
)paren
)paren
(brace
id|marker_ref
op_assign
id|jffs2_alloc_raw_node_ref
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|marker_ref
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Failed to allocate raw node ref for clean marker&bslash;n&quot;
)paren
suffix:semicolon
multiline_comment|/* Stick it back on the list from whence it came and come back later */
id|jffs2_erase_pending_trigger
c_func
(paren
id|c
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|c-&gt;erase_completion_lock
)paren
suffix:semicolon
id|list_add
c_func
(paren
op_amp
id|jeb-&gt;list
comma
op_amp
id|c-&gt;erase_complete_list
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|c-&gt;erase_completion_lock
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
id|ebuf
op_assign
id|kmalloc
c_func
(paren
id|PAGE_SIZE
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ebuf
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Failed to allocate page buffer for verifying erase at 0x%08x. Assuming it worked&bslash;n&quot;
comma
id|jeb-&gt;offset
)paren
suffix:semicolon
)brace
r_else
(brace
r_uint32
id|ofs
op_assign
id|jeb-&gt;offset
suffix:semicolon
id|D1
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Verifying erase at 0x%08x&bslash;n&quot;
comma
id|jeb-&gt;offset
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|ofs
OL
id|jeb-&gt;offset
op_plus
id|c-&gt;sector_size
)paren
(brace
r_uint32
id|readlen
op_assign
id|min
c_func
(paren
(paren
r_uint32
)paren
id|PAGE_SIZE
comma
id|jeb-&gt;offset
op_plus
id|c-&gt;sector_size
op_minus
id|ofs
)paren
suffix:semicolon
r_int
id|i
suffix:semicolon
id|bad_offset
op_assign
id|ofs
suffix:semicolon
id|ret
op_assign
id|jffs2_flash_read
c_func
(paren
id|c
comma
id|ofs
comma
id|readlen
comma
op_amp
id|retlen
comma
id|ebuf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Read of newly-erased block at 0x%08x failed: %d. Putting on bad_list&bslash;n&quot;
comma
id|ofs
comma
id|ret
)paren
suffix:semicolon
r_goto
id|bad
suffix:semicolon
)brace
r_if
c_cond
(paren
id|retlen
op_ne
id|readlen
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Short read from newly-erased block at 0x%08x. Wanted %d, got %zd&bslash;n&quot;
comma
id|ofs
comma
id|readlen
comma
id|retlen
)paren
suffix:semicolon
r_goto
id|bad
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|readlen
suffix:semicolon
id|i
op_add_assign
r_sizeof
(paren
r_int
r_int
)paren
)paren
(brace
multiline_comment|/* It&squot;s OK. We know it&squot;s properly aligned */
r_int
r_int
id|datum
op_assign
op_star
(paren
r_int
r_int
op_star
)paren
(paren
op_amp
id|ebuf
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|datum
op_plus
l_int|1
)paren
(brace
id|bad_offset
op_add_assign
id|i
suffix:semicolon
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Newly-erased block contained word 0x%lx at offset 0x%08x&bslash;n&quot;
comma
id|datum
comma
id|bad_offset
)paren
suffix:semicolon
id|bad
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|jffs2_cleanmarker_oob
c_func
(paren
id|c
)paren
)paren
id|jffs2_free_raw_node_ref
c_func
(paren
id|marker_ref
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|ebuf
)paren
suffix:semicolon
id|bad2
suffix:colon
id|spin_lock
c_func
(paren
op_amp
id|c-&gt;erase_completion_lock
)paren
suffix:semicolon
multiline_comment|/* Stick it on a list (any list) so&n;&t;&t;&t;&t;&t;   erase_failed can take it right off&n;&t;&t;&t;&t;&t;   again.  Silly, but shouldn&squot;t happen&n;&t;&t;&t;&t;&t;   often. */
id|list_add
c_func
(paren
op_amp
id|jeb-&gt;list
comma
op_amp
id|c-&gt;erasing_list
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|c-&gt;erase_completion_lock
)paren
suffix:semicolon
id|jffs2_erase_failed
c_func
(paren
id|c
comma
id|jeb
comma
id|bad_offset
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
)brace
id|ofs
op_add_assign
id|readlen
suffix:semicolon
id|cond_resched
c_func
(paren
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|ebuf
)paren
suffix:semicolon
)brace
id|bad_offset
op_assign
id|jeb-&gt;offset
suffix:semicolon
multiline_comment|/* Write the erase complete marker */
id|D1
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Writing erased marker to block at 0x%08x&bslash;n&quot;
comma
id|jeb-&gt;offset
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|jffs2_cleanmarker_oob
c_func
(paren
id|c
)paren
)paren
(brace
r_if
c_cond
(paren
id|jffs2_write_nand_cleanmarker
c_func
(paren
id|c
comma
id|jeb
)paren
)paren
r_goto
id|bad2
suffix:semicolon
id|jeb-&gt;first_node
op_assign
id|jeb-&gt;last_node
op_assign
l_int|NULL
suffix:semicolon
id|jeb-&gt;free_size
op_assign
id|c-&gt;sector_size
suffix:semicolon
id|jeb-&gt;used_size
op_assign
l_int|0
suffix:semicolon
id|jeb-&gt;dirty_size
op_assign
l_int|0
suffix:semicolon
id|jeb-&gt;wasted_size
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
r_struct
id|jffs2_unknown_node
id|marker
op_assign
(brace
dot
id|magic
op_assign
id|cpu_to_je16
c_func
(paren
id|JFFS2_MAGIC_BITMASK
)paren
comma
dot
id|nodetype
op_assign
id|cpu_to_je16
c_func
(paren
id|JFFS2_NODETYPE_CLEANMARKER
)paren
comma
dot
id|totlen
op_assign
id|cpu_to_je32
c_func
(paren
id|c-&gt;cleanmarker_size
)paren
)brace
suffix:semicolon
id|marker.hdr_crc
op_assign
id|cpu_to_je32
c_func
(paren
id|crc32
c_func
(paren
l_int|0
comma
op_amp
id|marker
comma
r_sizeof
(paren
r_struct
id|jffs2_unknown_node
)paren
op_minus
l_int|4
)paren
)paren
suffix:semicolon
multiline_comment|/* We only write the header; the rest was noise or padding anyway */
id|ret
op_assign
id|jffs2_flash_write
c_func
(paren
id|c
comma
id|jeb-&gt;offset
comma
r_sizeof
(paren
id|marker
)paren
comma
op_amp
id|retlen
comma
(paren
r_char
op_star
)paren
op_amp
id|marker
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Write clean marker to block at 0x%08x failed: %d&bslash;n&quot;
comma
id|jeb-&gt;offset
comma
id|ret
)paren
suffix:semicolon
r_goto
id|bad2
suffix:semicolon
)brace
r_if
c_cond
(paren
id|retlen
op_ne
r_sizeof
(paren
id|marker
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Short write to newly-erased block at 0x%08x: Wanted %zd, got %zd&bslash;n&quot;
comma
id|jeb-&gt;offset
comma
r_sizeof
(paren
id|marker
)paren
comma
id|retlen
)paren
suffix:semicolon
r_goto
id|bad2
suffix:semicolon
)brace
id|marker_ref-&gt;next_in_ino
op_assign
l_int|NULL
suffix:semicolon
id|marker_ref-&gt;next_phys
op_assign
l_int|NULL
suffix:semicolon
id|marker_ref-&gt;flash_offset
op_assign
id|jeb-&gt;offset
op_or
id|REF_NORMAL
suffix:semicolon
id|marker_ref-&gt;__totlen
op_assign
id|c-&gt;cleanmarker_size
suffix:semicolon
id|jeb-&gt;first_node
op_assign
id|jeb-&gt;last_node
op_assign
id|marker_ref
suffix:semicolon
id|jeb-&gt;free_size
op_assign
id|c-&gt;sector_size
op_minus
id|c-&gt;cleanmarker_size
suffix:semicolon
id|jeb-&gt;used_size
op_assign
id|c-&gt;cleanmarker_size
suffix:semicolon
id|jeb-&gt;dirty_size
op_assign
l_int|0
suffix:semicolon
id|jeb-&gt;wasted_size
op_assign
l_int|0
suffix:semicolon
)brace
id|spin_lock
c_func
(paren
op_amp
id|c-&gt;erase_completion_lock
)paren
suffix:semicolon
id|c-&gt;erasing_size
op_sub_assign
id|c-&gt;sector_size
suffix:semicolon
id|c-&gt;free_size
op_add_assign
id|jeb-&gt;free_size
suffix:semicolon
id|c-&gt;used_size
op_add_assign
id|jeb-&gt;used_size
suffix:semicolon
id|ACCT_SANITY_CHECK
c_func
(paren
id|c
comma
id|jeb
)paren
suffix:semicolon
id|D1
c_func
(paren
id|ACCT_PARANOIA_CHECK
c_func
(paren
id|jeb
)paren
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|jeb-&gt;list
comma
op_amp
id|c-&gt;free_list
)paren
suffix:semicolon
id|c-&gt;nr_erasing_blocks
op_decrement
suffix:semicolon
id|c-&gt;nr_free_blocks
op_increment
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|c-&gt;erase_completion_lock
)paren
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|c-&gt;erase_wait
)paren
suffix:semicolon
)brace
eof
