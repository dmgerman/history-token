multiline_comment|/*&n; * JFFS2 -- Journalling Flash File System, Version 2.&n; *&n; * Copyright (C) 2001-2003 Red Hat, Inc.&n; *&n; * Created by David Woodhouse &lt;dwmw2@redhat.com&gt;&n; *&n; * For licensing information, see the file &squot;LICENCE&squot; in this directory.&n; *&n; * $Id: nodelist.c,v 1.86 2003/10/31 15:37:51 dwmw2 Exp $&n; *&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/mtd/mtd.h&gt;
macro_line|#include &lt;linux/rbtree.h&gt;
macro_line|#include &lt;linux/crc32.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/pagemap.h&gt;
macro_line|#include &quot;nodelist.h&quot;
DECL|function|jffs2_add_fd_to_list
r_void
id|jffs2_add_fd_to_list
c_func
(paren
r_struct
id|jffs2_sb_info
op_star
id|c
comma
r_struct
id|jffs2_full_dirent
op_star
r_new
comma
r_struct
id|jffs2_full_dirent
op_star
op_star
id|list
)paren
(brace
r_struct
id|jffs2_full_dirent
op_star
op_star
id|prev
op_assign
id|list
suffix:semicolon
id|D1
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;jffs2_add_fd_to_list( %p, %p (-&gt;%p))&bslash;n&quot;
comma
r_new
comma
id|list
comma
op_star
id|list
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
op_star
id|prev
)paren
op_logical_and
(paren
op_star
id|prev
)paren
op_member_access_from_pointer
id|nhash
op_le
r_new
op_member_access_from_pointer
id|nhash
)paren
(brace
r_if
c_cond
(paren
(paren
op_star
id|prev
)paren
op_member_access_from_pointer
id|nhash
op_eq
r_new
op_member_access_from_pointer
id|nhash
op_logical_and
op_logical_neg
id|strcmp
c_func
(paren
(paren
op_star
id|prev
)paren
op_member_access_from_pointer
id|name
comma
r_new
op_member_access_from_pointer
id|name
)paren
)paren
(brace
multiline_comment|/* Duplicate. Free one */
r_if
c_cond
(paren
r_new
op_member_access_from_pointer
id|version
OL
(paren
op_star
id|prev
)paren
op_member_access_from_pointer
id|version
)paren
(brace
id|D1
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Eep! Marking new dirent node obsolete&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|D1
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;New dirent is &bslash;&quot;%s&bslash;&quot;-&gt;ino #%u. Old is &bslash;&quot;%s&bslash;&quot;-&gt;ino #%u&bslash;n&quot;
comma
r_new
op_member_access_from_pointer
id|name
comma
r_new
op_member_access_from_pointer
id|ino
comma
(paren
op_star
id|prev
)paren
op_member_access_from_pointer
id|name
comma
(paren
op_star
id|prev
)paren
op_member_access_from_pointer
id|ino
)paren
)paren
suffix:semicolon
id|jffs2_mark_node_obsolete
c_func
(paren
id|c
comma
r_new
op_member_access_from_pointer
id|raw
)paren
suffix:semicolon
id|jffs2_free_full_dirent
c_func
(paren
r_new
)paren
suffix:semicolon
)brace
r_else
(brace
id|D1
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Marking old dirent node (ino #%u) obsolete&bslash;n&quot;
comma
(paren
op_star
id|prev
)paren
op_member_access_from_pointer
id|ino
)paren
)paren
suffix:semicolon
r_new
op_member_access_from_pointer
id|next
op_assign
(paren
op_star
id|prev
)paren
op_member_access_from_pointer
id|next
suffix:semicolon
id|jffs2_mark_node_obsolete
c_func
(paren
id|c
comma
(paren
(paren
op_star
id|prev
)paren
op_member_access_from_pointer
id|raw
)paren
)paren
suffix:semicolon
id|jffs2_free_full_dirent
c_func
(paren
op_star
id|prev
)paren
suffix:semicolon
op_star
id|prev
op_assign
r_new
suffix:semicolon
)brace
r_goto
id|out
suffix:semicolon
)brace
id|prev
op_assign
op_amp
(paren
(paren
op_star
id|prev
)paren
op_member_access_from_pointer
id|next
)paren
suffix:semicolon
)brace
r_new
op_member_access_from_pointer
id|next
op_assign
op_star
id|prev
suffix:semicolon
op_star
id|prev
op_assign
r_new
suffix:semicolon
id|out
suffix:colon
id|D2
c_func
(paren
r_while
(paren
op_star
id|list
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Dirent &bslash;&quot;%s&bslash;&quot; (hash 0x%08x, ino #%u&bslash;n&quot;
comma
(paren
op_star
id|list
)paren
op_member_access_from_pointer
id|name
comma
(paren
op_star
id|list
)paren
op_member_access_from_pointer
id|nhash
comma
(paren
op_star
id|list
)paren
op_member_access_from_pointer
id|ino
)paren
suffix:semicolon
id|list
op_assign
op_amp
(paren
op_star
id|list
)paren
op_member_access_from_pointer
id|next
suffix:semicolon
)brace
)paren
suffix:semicolon
)brace
multiline_comment|/* Put a new tmp_dnode_info into the list, keeping the list in &n;   order of increasing version&n;*/
DECL|function|jffs2_add_tn_to_list
r_static
r_void
id|jffs2_add_tn_to_list
c_func
(paren
r_struct
id|jffs2_tmp_dnode_info
op_star
id|tn
comma
r_struct
id|jffs2_tmp_dnode_info
op_star
op_star
id|list
)paren
(brace
r_struct
id|jffs2_tmp_dnode_info
op_star
op_star
id|prev
op_assign
id|list
suffix:semicolon
r_while
c_loop
(paren
(paren
op_star
id|prev
)paren
op_logical_and
(paren
op_star
id|prev
)paren
op_member_access_from_pointer
id|version
OL
id|tn-&gt;version
)paren
(brace
id|prev
op_assign
op_amp
(paren
(paren
op_star
id|prev
)paren
op_member_access_from_pointer
id|next
)paren
suffix:semicolon
)brace
id|tn-&gt;next
op_assign
(paren
op_star
id|prev
)paren
suffix:semicolon
op_star
id|prev
op_assign
id|tn
suffix:semicolon
)brace
DECL|function|jffs2_free_tmp_dnode_info_list
r_static
r_void
id|jffs2_free_tmp_dnode_info_list
c_func
(paren
r_struct
id|jffs2_tmp_dnode_info
op_star
id|tn
)paren
(brace
r_struct
id|jffs2_tmp_dnode_info
op_star
id|next
suffix:semicolon
r_while
c_loop
(paren
id|tn
)paren
(brace
id|next
op_assign
id|tn
suffix:semicolon
id|tn
op_assign
id|tn-&gt;next
suffix:semicolon
id|jffs2_free_full_dnode
c_func
(paren
id|next-&gt;fn
)paren
suffix:semicolon
id|jffs2_free_tmp_dnode_info
c_func
(paren
id|next
)paren
suffix:semicolon
)brace
)brace
DECL|function|jffs2_free_full_dirent_list
r_static
r_void
id|jffs2_free_full_dirent_list
c_func
(paren
r_struct
id|jffs2_full_dirent
op_star
id|fd
)paren
(brace
r_struct
id|jffs2_full_dirent
op_star
id|next
suffix:semicolon
r_while
c_loop
(paren
id|fd
)paren
(brace
id|next
op_assign
id|fd-&gt;next
suffix:semicolon
id|jffs2_free_full_dirent
c_func
(paren
id|fd
)paren
suffix:semicolon
id|fd
op_assign
id|next
suffix:semicolon
)brace
)brace
multiline_comment|/* Get tmp_dnode_info and full_dirent for all non-obsolete nodes associated&n;   with this ino, returning the former in order of version */
DECL|function|jffs2_get_inode_nodes
r_int
id|jffs2_get_inode_nodes
c_func
(paren
r_struct
id|jffs2_sb_info
op_star
id|c
comma
id|ino_t
id|ino
comma
r_struct
id|jffs2_inode_info
op_star
id|f
comma
r_struct
id|jffs2_tmp_dnode_info
op_star
op_star
id|tnp
comma
r_struct
id|jffs2_full_dirent
op_star
op_star
id|fdp
comma
r_uint32
op_star
id|highest_version
comma
r_uint32
op_star
id|latest_mctime
comma
r_uint32
op_star
id|mctime_ver
)paren
(brace
r_struct
id|jffs2_raw_node_ref
op_star
id|ref
op_assign
id|f-&gt;inocache-&gt;nodes
suffix:semicolon
r_struct
id|jffs2_tmp_dnode_info
op_star
id|tn
comma
op_star
id|ret_tn
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|jffs2_full_dirent
op_star
id|fd
comma
op_star
id|ret_fd
op_assign
l_int|NULL
suffix:semicolon
r_union
id|jffs2_node_union
id|node
suffix:semicolon
r_int
id|retlen
suffix:semicolon
r_int
id|err
suffix:semicolon
op_star
id|mctime_ver
op_assign
l_int|0
suffix:semicolon
id|D1
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;jffs2_get_inode_nodes(): ino #%lu&bslash;n&quot;
comma
id|ino
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|f-&gt;inocache-&gt;nodes
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Eep. no nodes for ino #%lu&bslash;n&quot;
comma
(paren
r_int
r_int
)paren
id|ino
)paren
suffix:semicolon
)brace
id|spin_lock
c_func
(paren
op_amp
id|c-&gt;erase_completion_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|ref
op_assign
id|f-&gt;inocache-&gt;nodes
suffix:semicolon
id|ref
op_logical_and
id|ref-&gt;next_in_ino
suffix:semicolon
id|ref
op_assign
id|ref-&gt;next_in_ino
)paren
(brace
multiline_comment|/* Work out whether it&squot;s a data node or a dirent node */
r_if
c_cond
(paren
id|ref_obsolete
c_func
(paren
id|ref
)paren
)paren
(brace
multiline_comment|/* FIXME: On NAND flash we may need to read these */
id|D1
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;node at 0x%08x is obsoleted. Ignoring.&bslash;n&quot;
comma
id|ref_offset
c_func
(paren
id|ref
)paren
)paren
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/* We can hold a pointer to a non-obsolete node without the spinlock,&n;&t;&t;   but _obsolete_ nodes may disappear at any time, if the block&n;&t;&t;   they&squot;re in gets erased */
id|spin_unlock
c_func
(paren
op_amp
id|c-&gt;erase_completion_lock
)paren
suffix:semicolon
id|cond_resched
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* FIXME: point() */
id|err
op_assign
id|jffs2_flash_read
c_func
(paren
id|c
comma
(paren
id|ref_offset
c_func
(paren
id|ref
)paren
)paren
comma
id|min_t
c_func
(paren
r_uint32
comma
id|ref_totlen
c_func
(paren
id|c
comma
l_int|NULL
comma
id|ref
)paren
comma
r_sizeof
(paren
id|node
)paren
)paren
comma
op_amp
id|retlen
comma
(paren
r_void
op_star
)paren
op_amp
id|node
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;error %d reading node at 0x%08x in get_inode_nodes()&bslash;n&quot;
comma
id|err
comma
id|ref_offset
c_func
(paren
id|ref
)paren
)paren
suffix:semicolon
r_goto
id|free_out
suffix:semicolon
)brace
multiline_comment|/* Check we&squot;ve managed to read at least the common node header */
r_if
c_cond
(paren
id|retlen
OL
id|min_t
c_func
(paren
r_uint32
comma
id|ref_totlen
c_func
(paren
id|c
comma
l_int|NULL
comma
id|ref
)paren
comma
r_sizeof
(paren
id|node.u
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;short read in get_inode_nodes()&bslash;n&quot;
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|free_out
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|je16_to_cpu
c_func
(paren
id|node.u.nodetype
)paren
)paren
(brace
r_case
id|JFFS2_NODETYPE_DIRENT
suffix:colon
id|D1
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Node at %08x (%d) is a dirent node&bslash;n&quot;
comma
id|ref_offset
c_func
(paren
id|ref
)paren
comma
id|ref_flags
c_func
(paren
id|ref
)paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ref_flags
c_func
(paren
id|ref
)paren
op_eq
id|REF_UNCHECKED
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;BUG: Dirent node at 0x%08x never got checked? How?&bslash;n&quot;
comma
id|ref_offset
c_func
(paren
id|ref
)paren
)paren
suffix:semicolon
id|BUG
c_func
(paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|retlen
OL
r_sizeof
(paren
id|node.d
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;short read in get_inode_nodes()&bslash;n&quot;
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|free_out
suffix:semicolon
)brace
multiline_comment|/* sanity check */
r_if
c_cond
(paren
id|PAD
c_func
(paren
(paren
id|node.d.nsize
op_plus
r_sizeof
(paren
id|node.d
)paren
)paren
)paren
op_ne
id|PAD
c_func
(paren
id|je32_to_cpu
(paren
id|node.d.totlen
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;jffs2_get_inode_nodes(): Illegal nsize in node at 0x%08x: nsize 0x%02x, totlen %04x&bslash;n&quot;
comma
id|ref_offset
c_func
(paren
id|ref
)paren
comma
id|node.d.nsize
comma
id|je32_to_cpu
c_func
(paren
id|node.d.totlen
)paren
)paren
suffix:semicolon
id|jffs2_mark_node_obsolete
c_func
(paren
id|c
comma
id|ref
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|c-&gt;erase_completion_lock
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|je32_to_cpu
c_func
(paren
id|node.d.version
)paren
OG
op_star
id|highest_version
)paren
op_star
id|highest_version
op_assign
id|je32_to_cpu
c_func
(paren
id|node.d.version
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ref_obsolete
c_func
(paren
id|ref
)paren
)paren
(brace
multiline_comment|/* Obsoleted. This cannot happen, surely? dwmw2 20020308 */
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Dirent node at 0x%08x became obsolete while we weren&squot;t looking&bslash;n&quot;
comma
id|ref_offset
c_func
(paren
id|ref
)paren
)paren
suffix:semicolon
id|BUG
c_func
(paren
)paren
suffix:semicolon
)brace
id|fd
op_assign
id|jffs2_alloc_full_dirent
c_func
(paren
id|node.d.nsize
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fd
)paren
(brace
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|free_out
suffix:semicolon
)brace
id|memset
c_func
(paren
id|fd
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|jffs2_full_dirent
)paren
op_plus
id|node.d.nsize
op_plus
l_int|1
)paren
suffix:semicolon
id|fd-&gt;raw
op_assign
id|ref
suffix:semicolon
id|fd-&gt;version
op_assign
id|je32_to_cpu
c_func
(paren
id|node.d.version
)paren
suffix:semicolon
id|fd-&gt;ino
op_assign
id|je32_to_cpu
c_func
(paren
id|node.d.ino
)paren
suffix:semicolon
id|fd-&gt;type
op_assign
id|node.d.type
suffix:semicolon
multiline_comment|/* Pick out the mctime of the latest dirent */
r_if
c_cond
(paren
id|fd-&gt;version
OG
op_star
id|mctime_ver
)paren
(brace
op_star
id|mctime_ver
op_assign
id|fd-&gt;version
suffix:semicolon
op_star
id|latest_mctime
op_assign
id|je32_to_cpu
c_func
(paren
id|node.d.mctime
)paren
suffix:semicolon
)brace
multiline_comment|/* memcpy as much of the name as possible from the raw&n;&t;&t;&t;   dirent we&squot;ve already read from the flash&n;&t;&t;&t;*/
r_if
c_cond
(paren
id|retlen
OG
r_sizeof
(paren
r_struct
id|jffs2_raw_dirent
)paren
)paren
id|memcpy
c_func
(paren
op_amp
id|fd-&gt;name
(braket
l_int|0
)braket
comma
op_amp
id|node.d.name
(braket
l_int|0
)braket
comma
id|min_t
c_func
(paren
r_uint32
comma
id|node.d.nsize
comma
(paren
id|retlen
op_minus
r_sizeof
(paren
r_struct
id|jffs2_raw_dirent
)paren
)paren
)paren
)paren
suffix:semicolon
multiline_comment|/* Do we need to copy any more of the name directly&n;&t;&t;&t;   from the flash?&n;&t;&t;&t;*/
r_if
c_cond
(paren
id|node.d.nsize
op_plus
r_sizeof
(paren
r_struct
id|jffs2_raw_dirent
)paren
OG
id|retlen
)paren
(brace
multiline_comment|/* FIXME: point() */
r_int
id|already
op_assign
id|retlen
op_minus
r_sizeof
(paren
r_struct
id|jffs2_raw_dirent
)paren
suffix:semicolon
id|err
op_assign
id|jffs2_flash_read
c_func
(paren
id|c
comma
(paren
id|ref_offset
c_func
(paren
id|ref
)paren
)paren
op_plus
id|retlen
comma
id|node.d.nsize
op_minus
id|already
comma
op_amp
id|retlen
comma
op_amp
id|fd-&gt;name
(braket
id|already
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|err
op_logical_and
id|retlen
op_ne
id|node.d.nsize
op_minus
id|already
)paren
id|err
op_assign
op_minus
id|EIO
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Read remainder of name in jffs2_get_inode_nodes(): error %d&bslash;n&quot;
comma
id|err
)paren
suffix:semicolon
id|jffs2_free_full_dirent
c_func
(paren
id|fd
)paren
suffix:semicolon
r_goto
id|free_out
suffix:semicolon
)brace
)brace
id|fd-&gt;nhash
op_assign
id|full_name_hash
c_func
(paren
id|fd-&gt;name
comma
id|node.d.nsize
)paren
suffix:semicolon
id|fd-&gt;next
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Wheee. We now have a complete jffs2_full_dirent structure, with&n;&t;&t;&t;&t;   the name in it and everything. Link it into the list &n;&t;&t;&t;&t;*/
id|D1
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Adding fd &bslash;&quot;%s&bslash;&quot;, ino #%u&bslash;n&quot;
comma
id|fd-&gt;name
comma
id|fd-&gt;ino
)paren
)paren
suffix:semicolon
id|jffs2_add_fd_to_list
c_func
(paren
id|c
comma
id|fd
comma
op_amp
id|ret_fd
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|JFFS2_NODETYPE_INODE
suffix:colon
id|D1
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Node at %08x (%d) is a data node&bslash;n&quot;
comma
id|ref_offset
c_func
(paren
id|ref
)paren
comma
id|ref_flags
c_func
(paren
id|ref
)paren
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retlen
OL
r_sizeof
(paren
id|node.i
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;read too short for dnode&bslash;n&quot;
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|free_out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|je32_to_cpu
c_func
(paren
id|node.i.version
)paren
OG
op_star
id|highest_version
)paren
op_star
id|highest_version
op_assign
id|je32_to_cpu
c_func
(paren
id|node.i.version
)paren
suffix:semicolon
id|D1
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;version %d, highest_version now %d&bslash;n&quot;
comma
id|je32_to_cpu
c_func
(paren
id|node.i.version
)paren
comma
op_star
id|highest_version
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ref_obsolete
c_func
(paren
id|ref
)paren
)paren
(brace
multiline_comment|/* Obsoleted. This cannot happen, surely? dwmw2 20020308 */
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Inode node at 0x%08x became obsolete while we weren&squot;t looking&bslash;n&quot;
comma
id|ref_offset
c_func
(paren
id|ref
)paren
)paren
suffix:semicolon
id|BUG
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/* If we&squot;ve never checked the CRCs on this node, check them now. */
r_if
c_cond
(paren
id|ref_flags
c_func
(paren
id|ref
)paren
op_eq
id|REF_UNCHECKED
)paren
(brace
r_uint32
id|crc
comma
id|len
suffix:semicolon
r_struct
id|jffs2_eraseblock
op_star
id|jeb
suffix:semicolon
id|crc
op_assign
id|crc32
c_func
(paren
l_int|0
comma
op_amp
id|node
comma
r_sizeof
(paren
id|node.i
)paren
op_minus
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|crc
op_ne
id|je32_to_cpu
c_func
(paren
id|node.i.node_crc
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;jffs2_get_inode_nodes(): CRC failed on node at 0x%08x: Read 0x%08x, calculated 0x%08x&bslash;n&quot;
comma
id|ref_offset
c_func
(paren
id|ref
)paren
comma
id|je32_to_cpu
c_func
(paren
id|node.i.node_crc
)paren
comma
id|crc
)paren
suffix:semicolon
id|jffs2_mark_node_obsolete
c_func
(paren
id|c
comma
id|ref
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|c-&gt;erase_completion_lock
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
multiline_comment|/* sanity checks */
r_if
c_cond
(paren
id|je32_to_cpu
c_func
(paren
id|node.i.offset
)paren
OG
id|je32_to_cpu
c_func
(paren
id|node.i.isize
)paren
op_logical_or
id|PAD
c_func
(paren
id|je32_to_cpu
c_func
(paren
id|node.i.csize
)paren
op_plus
r_sizeof
(paren
id|node.i
)paren
)paren
op_ne
id|PAD
c_func
(paren
id|je32_to_cpu
c_func
(paren
id|node.i.totlen
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;jffs2_get_inode_nodes(): Inode corrupted at 0x%08x, totlen %d, #ino  %d, version %d, isize %d, csize %d, dsize %d &bslash;n&quot;
comma
id|ref_offset
c_func
(paren
id|ref
)paren
comma
id|je32_to_cpu
c_func
(paren
id|node.i.totlen
)paren
comma
id|je32_to_cpu
c_func
(paren
id|node.i.ino
)paren
comma
id|je32_to_cpu
c_func
(paren
id|node.i.version
)paren
comma
id|je32_to_cpu
c_func
(paren
id|node.i.isize
)paren
comma
id|je32_to_cpu
c_func
(paren
id|node.i.csize
)paren
comma
id|je32_to_cpu
c_func
(paren
id|node.i.dsize
)paren
)paren
suffix:semicolon
id|jffs2_mark_node_obsolete
c_func
(paren
id|c
comma
id|ref
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|c-&gt;erase_completion_lock
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|node.i.compr
op_ne
id|JFFS2_COMPR_ZERO
op_logical_and
id|je32_to_cpu
c_func
(paren
id|node.i.csize
)paren
)paren
(brace
r_int
r_char
op_star
id|buf
op_assign
l_int|NULL
suffix:semicolon
r_uint32
id|pointed
op_assign
l_int|0
suffix:semicolon
macro_line|#ifndef __ECOS
r_if
c_cond
(paren
id|c-&gt;mtd-&gt;point
)paren
(brace
id|err
op_assign
id|c-&gt;mtd-&gt;point
(paren
id|c-&gt;mtd
comma
id|ref_offset
c_func
(paren
id|ref
)paren
op_plus
r_sizeof
(paren
id|node.i
)paren
comma
id|je32_to_cpu
c_func
(paren
id|node.i.csize
)paren
comma
op_amp
id|retlen
comma
op_amp
id|buf
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|err
op_logical_and
id|retlen
OL
id|je32_to_cpu
c_func
(paren
id|node.i.csize
)paren
)paren
(brace
id|D1
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;MTD point returned len too short: 0x%zx&bslash;n&quot;
comma
id|retlen
)paren
)paren
suffix:semicolon
id|c-&gt;mtd
op_member_access_from_pointer
id|unpoint
c_func
(paren
id|c-&gt;mtd
comma
id|buf
comma
id|ref_offset
c_func
(paren
id|ref
)paren
op_plus
r_sizeof
(paren
id|node.i
)paren
comma
id|je32_to_cpu
c_func
(paren
id|node.i.csize
)paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|err
)paren
(brace
id|D1
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;MTD point failed %d&bslash;n&quot;
comma
id|err
)paren
)paren
suffix:semicolon
)brace
r_else
id|pointed
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* succefully pointed to device */
)brace
macro_line|#endif&t;&t;&t;&t;&t;
r_if
c_cond
(paren
op_logical_neg
id|pointed
)paren
(brace
id|buf
op_assign
id|kmalloc
c_func
(paren
id|je32_to_cpu
c_func
(paren
id|node.i.csize
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|buf
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|err
op_assign
id|jffs2_flash_read
c_func
(paren
id|c
comma
id|ref_offset
c_func
(paren
id|ref
)paren
op_plus
r_sizeof
(paren
id|node.i
)paren
comma
id|je32_to_cpu
c_func
(paren
id|node.i.csize
)paren
comma
op_amp
id|retlen
comma
id|buf
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|err
op_logical_and
id|retlen
op_ne
id|je32_to_cpu
c_func
(paren
id|node.i.csize
)paren
)paren
id|err
op_assign
op_minus
id|EIO
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|kfree
c_func
(paren
id|buf
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
)brace
id|crc
op_assign
id|crc32
c_func
(paren
l_int|0
comma
id|buf
comma
id|je32_to_cpu
c_func
(paren
id|node.i.csize
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|pointed
)paren
(brace
id|kfree
c_func
(paren
id|buf
)paren
suffix:semicolon
)brace
macro_line|#ifndef __ECOS
r_else
id|c-&gt;mtd
op_member_access_from_pointer
id|unpoint
c_func
(paren
id|c-&gt;mtd
comma
id|buf
comma
id|ref_offset
c_func
(paren
id|ref
)paren
op_plus
r_sizeof
(paren
id|node.i
)paren
comma
id|je32_to_cpu
c_func
(paren
id|node.i.csize
)paren
)paren
suffix:semicolon
macro_line|#endif
r_if
c_cond
(paren
id|crc
op_ne
id|je32_to_cpu
c_func
(paren
id|node.i.data_crc
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;jffs2_get_inode_nodes(): Data CRC failed on node at 0x%08x: Read 0x%08x, calculated 0x%08x&bslash;n&quot;
comma
id|ref_offset
c_func
(paren
id|ref
)paren
comma
id|je32_to_cpu
c_func
(paren
id|node.i.data_crc
)paren
comma
id|crc
)paren
suffix:semicolon
id|jffs2_mark_node_obsolete
c_func
(paren
id|c
comma
id|ref
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|c-&gt;erase_completion_lock
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
)brace
multiline_comment|/* Mark the node as having been checked and fix the accounting accordingly */
id|spin_lock
c_func
(paren
op_amp
id|c-&gt;erase_completion_lock
)paren
suffix:semicolon
id|jeb
op_assign
op_amp
id|c-&gt;blocks
(braket
id|ref-&gt;flash_offset
op_div
id|c-&gt;sector_size
)braket
suffix:semicolon
id|len
op_assign
id|ref_totlen
c_func
(paren
id|c
comma
id|jeb
comma
id|ref
)paren
suffix:semicolon
id|jeb-&gt;used_size
op_add_assign
id|len
suffix:semicolon
id|jeb-&gt;unchecked_size
op_sub_assign
id|len
suffix:semicolon
id|c-&gt;used_size
op_add_assign
id|len
suffix:semicolon
id|c-&gt;unchecked_size
op_sub_assign
id|len
suffix:semicolon
multiline_comment|/* If node covers at least a whole page, or if it starts at the &n;&t;&t;&t;&t;   beginning of a page and runs to the end of the file, or if &n;&t;&t;&t;&t;   it&squot;s a hole node, mark it REF_PRISTINE, else REF_NORMAL. &n;&n;&t;&t;&t;&t;   If it&squot;s actually overlapped, it&squot;ll get made NORMAL (or OBSOLETE) &n;&t;&t;&t;&t;   when the overlapping node(s) get added to the tree anyway. &n;&t;&t;&t;&t;*/
r_if
c_cond
(paren
(paren
id|je32_to_cpu
c_func
(paren
id|node.i.dsize
)paren
op_ge
id|PAGE_CACHE_SIZE
)paren
op_logical_or
(paren
(paren
(paren
id|je32_to_cpu
c_func
(paren
id|node.i.offset
)paren
op_amp
(paren
id|PAGE_CACHE_SIZE
op_minus
l_int|1
)paren
)paren
op_eq
l_int|0
)paren
op_logical_and
(paren
id|je32_to_cpu
c_func
(paren
id|node.i.dsize
)paren
op_plus
id|je32_to_cpu
c_func
(paren
id|node.i.offset
)paren
op_eq
id|je32_to_cpu
c_func
(paren
id|node.i.isize
)paren
)paren
)paren
)paren
(brace
id|D1
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Marking node at 0x%08x REF_PRISTINE&bslash;n&quot;
comma
id|ref_offset
c_func
(paren
id|ref
)paren
)paren
)paren
suffix:semicolon
id|ref-&gt;flash_offset
op_assign
id|ref_offset
c_func
(paren
id|ref
)paren
op_or
id|REF_PRISTINE
suffix:semicolon
)brace
r_else
(brace
id|D1
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Marking node at 0x%08x REF_NORMAL&bslash;n&quot;
comma
id|ref_offset
c_func
(paren
id|ref
)paren
)paren
)paren
suffix:semicolon
id|ref-&gt;flash_offset
op_assign
id|ref_offset
c_func
(paren
id|ref
)paren
op_or
id|REF_NORMAL
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|c-&gt;erase_completion_lock
)paren
suffix:semicolon
)brace
id|tn
op_assign
id|jffs2_alloc_tmp_dnode_info
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tn
)paren
(brace
id|D1
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;alloc tn failed&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|free_out
suffix:semicolon
)brace
id|tn-&gt;fn
op_assign
id|jffs2_alloc_full_dnode
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tn-&gt;fn
)paren
(brace
id|D1
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;alloc fn failed&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
id|jffs2_free_tmp_dnode_info
c_func
(paren
id|tn
)paren
suffix:semicolon
r_goto
id|free_out
suffix:semicolon
)brace
id|tn-&gt;version
op_assign
id|je32_to_cpu
c_func
(paren
id|node.i.version
)paren
suffix:semicolon
id|tn-&gt;fn-&gt;ofs
op_assign
id|je32_to_cpu
c_func
(paren
id|node.i.offset
)paren
suffix:semicolon
multiline_comment|/* There was a bug where we wrote hole nodes out with&n;&t;&t;&t;   csize/dsize swapped. Deal with it */
r_if
c_cond
(paren
id|node.i.compr
op_eq
id|JFFS2_COMPR_ZERO
op_logical_and
op_logical_neg
id|je32_to_cpu
c_func
(paren
id|node.i.dsize
)paren
op_logical_and
id|je32_to_cpu
c_func
(paren
id|node.i.csize
)paren
)paren
id|tn-&gt;fn-&gt;size
op_assign
id|je32_to_cpu
c_func
(paren
id|node.i.csize
)paren
suffix:semicolon
r_else
singleline_comment|// normal case...
id|tn-&gt;fn-&gt;size
op_assign
id|je32_to_cpu
c_func
(paren
id|node.i.dsize
)paren
suffix:semicolon
id|tn-&gt;fn-&gt;raw
op_assign
id|ref
suffix:semicolon
id|D1
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;dnode @%08x: ver %u, offset %04x, dsize %04x&bslash;n&quot;
comma
id|ref_offset
c_func
(paren
id|ref
)paren
comma
id|je32_to_cpu
c_func
(paren
id|node.i.version
)paren
comma
id|je32_to_cpu
c_func
(paren
id|node.i.offset
)paren
comma
id|je32_to_cpu
c_func
(paren
id|node.i.dsize
)paren
)paren
)paren
suffix:semicolon
id|jffs2_add_tn_to_list
c_func
(paren
id|tn
comma
op_amp
id|ret_tn
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
r_if
c_cond
(paren
id|ref_flags
c_func
(paren
id|ref
)paren
op_eq
id|REF_UNCHECKED
)paren
(brace
r_struct
id|jffs2_eraseblock
op_star
id|jeb
suffix:semicolon
r_uint32
id|len
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Eep. Unknown node type %04x at %08x was marked REF_UNCHECKED&bslash;n&quot;
comma
id|je16_to_cpu
c_func
(paren
id|node.u.nodetype
)paren
comma
id|ref_offset
c_func
(paren
id|ref
)paren
)paren
suffix:semicolon
multiline_comment|/* Mark the node as having been checked and fix the accounting accordingly */
id|spin_lock
c_func
(paren
op_amp
id|c-&gt;erase_completion_lock
)paren
suffix:semicolon
id|jeb
op_assign
op_amp
id|c-&gt;blocks
(braket
id|ref-&gt;flash_offset
op_div
id|c-&gt;sector_size
)braket
suffix:semicolon
id|len
op_assign
id|ref_totlen
c_func
(paren
id|c
comma
id|jeb
comma
id|ref
)paren
suffix:semicolon
id|jeb-&gt;used_size
op_add_assign
id|len
suffix:semicolon
id|jeb-&gt;unchecked_size
op_sub_assign
id|len
suffix:semicolon
id|c-&gt;used_size
op_add_assign
id|len
suffix:semicolon
id|c-&gt;unchecked_size
op_sub_assign
id|len
suffix:semicolon
id|mark_ref_normal
c_func
(paren
id|ref
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|c-&gt;erase_completion_lock
)paren
suffix:semicolon
)brace
id|node.u.nodetype
op_assign
id|cpu_to_je16
c_func
(paren
id|JFFS2_NODE_ACCURATE
op_or
id|je16_to_cpu
c_func
(paren
id|node.u.nodetype
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|crc32
c_func
(paren
l_int|0
comma
op_amp
id|node
comma
r_sizeof
(paren
r_struct
id|jffs2_unknown_node
)paren
op_minus
l_int|4
)paren
op_ne
id|je32_to_cpu
c_func
(paren
id|node.u.hdr_crc
)paren
)paren
(brace
multiline_comment|/* Hmmm. This should have been caught at scan time. */
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Node header CRC failed at %08x. But it must have been OK earlier.&bslash;n&quot;
comma
id|ref_offset
c_func
(paren
id|ref
)paren
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;Node was: { %04x, %04x, %08x, %08x }&bslash;n&quot;
comma
id|je16_to_cpu
c_func
(paren
id|node.u.magic
)paren
comma
id|je16_to_cpu
c_func
(paren
id|node.u.nodetype
)paren
comma
id|je32_to_cpu
c_func
(paren
id|node.u.totlen
)paren
comma
id|je32_to_cpu
c_func
(paren
id|node.u.hdr_crc
)paren
)paren
suffix:semicolon
id|jffs2_mark_node_obsolete
c_func
(paren
id|c
comma
id|ref
)paren
suffix:semicolon
)brace
r_else
r_switch
c_cond
(paren
id|je16_to_cpu
c_func
(paren
id|node.u.nodetype
)paren
op_amp
id|JFFS2_COMPAT_MASK
)paren
(brace
r_case
id|JFFS2_FEATURE_INCOMPAT
suffix:colon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;Unknown INCOMPAT nodetype %04X at %08x&bslash;n&quot;
comma
id|je16_to_cpu
c_func
(paren
id|node.u.nodetype
)paren
comma
id|ref_offset
c_func
(paren
id|ref
)paren
)paren
suffix:semicolon
multiline_comment|/* EEP */
id|BUG
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|JFFS2_FEATURE_ROCOMPAT
suffix:colon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;Unknown ROCOMPAT nodetype %04X at %08x&bslash;n&quot;
comma
id|je16_to_cpu
c_func
(paren
id|node.u.nodetype
)paren
comma
id|ref_offset
c_func
(paren
id|ref
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|c-&gt;flags
op_amp
id|JFFS2_SB_FLAG_RO
)paren
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|JFFS2_FEATURE_RWCOMPAT_COPY
suffix:colon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;Unknown RWCOMPAT_COPY nodetype %04X at %08x&bslash;n&quot;
comma
id|je16_to_cpu
c_func
(paren
id|node.u.nodetype
)paren
comma
id|ref_offset
c_func
(paren
id|ref
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|JFFS2_FEATURE_RWCOMPAT_DELETE
suffix:colon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;Unknown RWCOMPAT_DELETE nodetype %04X at %08x&bslash;n&quot;
comma
id|je16_to_cpu
c_func
(paren
id|node.u.nodetype
)paren
comma
id|ref_offset
c_func
(paren
id|ref
)paren
)paren
suffix:semicolon
id|jffs2_mark_node_obsolete
c_func
(paren
id|c
comma
id|ref
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|spin_lock
c_func
(paren
op_amp
id|c-&gt;erase_completion_lock
)paren
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|c-&gt;erase_completion_lock
)paren
suffix:semicolon
op_star
id|tnp
op_assign
id|ret_tn
suffix:semicolon
op_star
id|fdp
op_assign
id|ret_fd
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|free_out
suffix:colon
id|jffs2_free_tmp_dnode_info_list
c_func
(paren
id|ret_tn
)paren
suffix:semicolon
id|jffs2_free_full_dirent_list
c_func
(paren
id|ret_fd
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|jffs2_set_inocache_state
r_void
id|jffs2_set_inocache_state
c_func
(paren
r_struct
id|jffs2_sb_info
op_star
id|c
comma
r_struct
id|jffs2_inode_cache
op_star
id|ic
comma
r_int
id|state
)paren
(brace
id|spin_lock
c_func
(paren
op_amp
id|c-&gt;inocache_lock
)paren
suffix:semicolon
id|ic-&gt;state
op_assign
id|state
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|c-&gt;inocache_wq
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|c-&gt;inocache_lock
)paren
suffix:semicolon
)brace
multiline_comment|/* During mount, this needs no locking. During normal operation, its&n;   callers want to do other stuff while still holding the inocache_lock.&n;   Rather than introducing special case get_ino_cache functions or &n;   callbacks, we just let the caller do the locking itself. */
DECL|function|jffs2_get_ino_cache
r_struct
id|jffs2_inode_cache
op_star
id|jffs2_get_ino_cache
c_func
(paren
r_struct
id|jffs2_sb_info
op_star
id|c
comma
r_uint32
id|ino
)paren
(brace
r_struct
id|jffs2_inode_cache
op_star
id|ret
suffix:semicolon
id|D2
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;jffs2_get_ino_cache(): ino %u&bslash;n&quot;
comma
id|ino
)paren
)paren
suffix:semicolon
id|ret
op_assign
id|c-&gt;inocache_list
(braket
id|ino
op_mod
id|INOCACHE_HASHSIZE
)braket
suffix:semicolon
r_while
c_loop
(paren
id|ret
op_logical_and
id|ret-&gt;ino
OL
id|ino
)paren
(brace
id|ret
op_assign
id|ret-&gt;next
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ret
op_logical_and
id|ret-&gt;ino
op_ne
id|ino
)paren
id|ret
op_assign
l_int|NULL
suffix:semicolon
id|D2
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;jffs2_get_ino_cache found %p for ino %u&bslash;n&quot;
comma
id|ret
comma
id|ino
)paren
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|jffs2_add_ino_cache
r_void
id|jffs2_add_ino_cache
(paren
r_struct
id|jffs2_sb_info
op_star
id|c
comma
r_struct
id|jffs2_inode_cache
op_star
r_new
)paren
(brace
r_struct
id|jffs2_inode_cache
op_star
op_star
id|prev
suffix:semicolon
id|D2
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;jffs2_add_ino_cache: Add %p (ino #%u)&bslash;n&quot;
comma
r_new
comma
r_new
op_member_access_from_pointer
id|ino
)paren
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|c-&gt;inocache_lock
)paren
suffix:semicolon
id|prev
op_assign
op_amp
id|c-&gt;inocache_list
(braket
r_new
op_member_access_from_pointer
id|ino
op_mod
id|INOCACHE_HASHSIZE
)braket
suffix:semicolon
r_while
c_loop
(paren
(paren
op_star
id|prev
)paren
op_logical_and
(paren
op_star
id|prev
)paren
op_member_access_from_pointer
id|ino
OL
r_new
op_member_access_from_pointer
id|ino
)paren
(brace
id|prev
op_assign
op_amp
(paren
op_star
id|prev
)paren
op_member_access_from_pointer
id|next
suffix:semicolon
)brace
r_new
op_member_access_from_pointer
id|next
op_assign
op_star
id|prev
suffix:semicolon
op_star
id|prev
op_assign
r_new
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|c-&gt;inocache_lock
)paren
suffix:semicolon
)brace
DECL|function|jffs2_del_ino_cache
r_void
id|jffs2_del_ino_cache
c_func
(paren
r_struct
id|jffs2_sb_info
op_star
id|c
comma
r_struct
id|jffs2_inode_cache
op_star
id|old
)paren
(brace
r_struct
id|jffs2_inode_cache
op_star
op_star
id|prev
suffix:semicolon
id|D2
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;jffs2_del_ino_cache: Del %p (ino #%u)&bslash;n&quot;
comma
id|old
comma
id|old-&gt;ino
)paren
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|c-&gt;inocache_lock
)paren
suffix:semicolon
id|prev
op_assign
op_amp
id|c-&gt;inocache_list
(braket
id|old-&gt;ino
op_mod
id|INOCACHE_HASHSIZE
)braket
suffix:semicolon
r_while
c_loop
(paren
(paren
op_star
id|prev
)paren
op_logical_and
(paren
op_star
id|prev
)paren
op_member_access_from_pointer
id|ino
OL
id|old-&gt;ino
)paren
(brace
id|prev
op_assign
op_amp
(paren
op_star
id|prev
)paren
op_member_access_from_pointer
id|next
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
op_star
id|prev
)paren
op_eq
id|old
)paren
(brace
op_star
id|prev
op_assign
id|old-&gt;next
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|c-&gt;inocache_lock
)paren
suffix:semicolon
)brace
DECL|function|jffs2_free_ino_caches
r_void
id|jffs2_free_ino_caches
c_func
(paren
r_struct
id|jffs2_sb_info
op_star
id|c
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|jffs2_inode_cache
op_star
id|this
comma
op_star
id|next
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|INOCACHE_HASHSIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
id|this
op_assign
id|c-&gt;inocache_list
(braket
id|i
)braket
suffix:semicolon
r_while
c_loop
(paren
id|this
)paren
(brace
id|next
op_assign
id|this-&gt;next
suffix:semicolon
id|D2
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;jffs2_free_ino_caches: Freeing ino #%u at %p&bslash;n&quot;
comma
id|this-&gt;ino
comma
id|this
)paren
)paren
suffix:semicolon
id|jffs2_free_inode_cache
c_func
(paren
id|this
)paren
suffix:semicolon
id|this
op_assign
id|next
suffix:semicolon
)brace
id|c-&gt;inocache_list
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
DECL|function|jffs2_free_raw_node_refs
r_void
id|jffs2_free_raw_node_refs
c_func
(paren
r_struct
id|jffs2_sb_info
op_star
id|c
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|jffs2_raw_node_ref
op_star
id|this
comma
op_star
id|next
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|c-&gt;nr_blocks
suffix:semicolon
id|i
op_increment
)paren
(brace
id|this
op_assign
id|c-&gt;blocks
(braket
id|i
)braket
dot
id|first_node
suffix:semicolon
r_while
c_loop
(paren
id|this
)paren
(brace
id|next
op_assign
id|this-&gt;next_phys
suffix:semicolon
id|jffs2_free_raw_node_ref
c_func
(paren
id|this
)paren
suffix:semicolon
id|this
op_assign
id|next
suffix:semicolon
)brace
id|c-&gt;blocks
(braket
id|i
)braket
dot
id|first_node
op_assign
id|c-&gt;blocks
(braket
id|i
)braket
dot
id|last_node
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
DECL|function|jffs2_lookup_node_frag
r_struct
id|jffs2_node_frag
op_star
id|jffs2_lookup_node_frag
c_func
(paren
r_struct
id|rb_root
op_star
id|fragtree
comma
r_uint32
id|offset
)paren
(brace
multiline_comment|/* The common case in lookup is that there will be a node &n;&t;   which precisely matches. So we go looking for that first */
r_struct
id|rb_node
op_star
id|next
suffix:semicolon
r_struct
id|jffs2_node_frag
op_star
id|prev
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|jffs2_node_frag
op_star
id|frag
op_assign
l_int|NULL
suffix:semicolon
id|D2
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;jffs2_lookup_node_frag(%p, %d)&bslash;n&quot;
comma
id|fragtree
comma
id|offset
)paren
)paren
suffix:semicolon
id|next
op_assign
id|fragtree-&gt;rb_node
suffix:semicolon
r_while
c_loop
(paren
id|next
)paren
(brace
id|frag
op_assign
id|rb_entry
c_func
(paren
id|next
comma
r_struct
id|jffs2_node_frag
comma
id|rb
)paren
suffix:semicolon
id|D2
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Considering frag %d-%d (%p). left %p, right %p&bslash;n&quot;
comma
id|frag-&gt;ofs
comma
id|frag-&gt;ofs
op_plus
id|frag-&gt;size
comma
id|frag
comma
id|frag-&gt;rb.rb_left
comma
id|frag-&gt;rb.rb_right
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|frag-&gt;ofs
op_plus
id|frag-&gt;size
op_le
id|offset
)paren
(brace
id|D2
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Going right from frag %d-%d, before the region we care about&bslash;n&quot;
comma
id|frag-&gt;ofs
comma
id|frag-&gt;ofs
op_plus
id|frag-&gt;size
)paren
)paren
suffix:semicolon
multiline_comment|/* Remember the closest smaller match on the way down */
r_if
c_cond
(paren
op_logical_neg
id|prev
op_logical_or
id|frag-&gt;ofs
OG
id|prev-&gt;ofs
)paren
id|prev
op_assign
id|frag
suffix:semicolon
id|next
op_assign
id|frag-&gt;rb.rb_right
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|frag-&gt;ofs
OG
id|offset
)paren
(brace
id|D2
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Going left from frag %d-%d, after the region we care about&bslash;n&quot;
comma
id|frag-&gt;ofs
comma
id|frag-&gt;ofs
op_plus
id|frag-&gt;size
)paren
)paren
suffix:semicolon
id|next
op_assign
id|frag-&gt;rb.rb_left
suffix:semicolon
)brace
r_else
(brace
id|D2
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Returning frag %d,%d, matched&bslash;n&quot;
comma
id|frag-&gt;ofs
comma
id|frag-&gt;ofs
op_plus
id|frag-&gt;size
)paren
)paren
suffix:semicolon
r_return
id|frag
suffix:semicolon
)brace
)brace
multiline_comment|/* Exact match not found. Go back up looking at each parent,&n;&t;   and return the closest smaller one */
r_if
c_cond
(paren
id|prev
)paren
id|D2
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;No match. Returning frag %d,%d, closest previous&bslash;n&quot;
comma
id|prev-&gt;ofs
comma
id|prev-&gt;ofs
op_plus
id|prev-&gt;size
)paren
)paren
suffix:semicolon
r_else
id|D2
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Returning NULL, empty fragtree&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
id|prev
suffix:semicolon
)brace
multiline_comment|/* Pass &squot;c&squot; argument to indicate that nodes should be marked obsolete as&n;   they&squot;re killed. */
DECL|function|jffs2_kill_fragtree
r_void
id|jffs2_kill_fragtree
c_func
(paren
r_struct
id|rb_root
op_star
id|root
comma
r_struct
id|jffs2_sb_info
op_star
id|c
)paren
(brace
r_struct
id|jffs2_node_frag
op_star
id|frag
suffix:semicolon
r_struct
id|jffs2_node_frag
op_star
id|parent
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|root-&gt;rb_node
)paren
r_return
suffix:semicolon
id|frag
op_assign
(paren
id|rb_entry
c_func
(paren
id|root-&gt;rb_node
comma
r_struct
id|jffs2_node_frag
comma
id|rb
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|frag
)paren
(brace
r_if
c_cond
(paren
id|frag-&gt;rb.rb_left
)paren
(brace
id|D2
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Going left from frag (%p) %d-%d&bslash;n&quot;
comma
id|frag
comma
id|frag-&gt;ofs
comma
id|frag-&gt;ofs
op_plus
id|frag-&gt;size
)paren
)paren
suffix:semicolon
id|frag
op_assign
id|frag_left
c_func
(paren
id|frag
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|frag-&gt;rb.rb_right
)paren
(brace
id|D2
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Going right from frag (%p) %d-%d&bslash;n&quot;
comma
id|frag
comma
id|frag-&gt;ofs
comma
id|frag-&gt;ofs
op_plus
id|frag-&gt;size
)paren
)paren
suffix:semicolon
id|frag
op_assign
id|frag_right
c_func
(paren
id|frag
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|D2
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;jffs2_kill_fragtree: frag at 0x%x-0x%x: node %p, frags %d--&bslash;n&quot;
comma
id|frag-&gt;ofs
comma
id|frag-&gt;ofs
op_plus
id|frag-&gt;size
comma
id|frag-&gt;node
comma
id|frag-&gt;node
ques
c_cond
id|frag-&gt;node-&gt;frags
suffix:colon
l_int|0
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|frag-&gt;node
op_logical_and
op_logical_neg
(paren
op_decrement
id|frag-&gt;node-&gt;frags
)paren
)paren
(brace
multiline_comment|/* Not a hole, and it&squot;s the final remaining frag &n;&t;&t;&t;   of this node. Free the node */
r_if
c_cond
(paren
id|c
)paren
id|jffs2_mark_node_obsolete
c_func
(paren
id|c
comma
id|frag-&gt;node-&gt;raw
)paren
suffix:semicolon
id|jffs2_free_full_dnode
c_func
(paren
id|frag-&gt;node
)paren
suffix:semicolon
)brace
id|parent
op_assign
id|frag_parent
c_func
(paren
id|frag
)paren
suffix:semicolon
r_if
c_cond
(paren
id|parent
)paren
(brace
r_if
c_cond
(paren
id|frag_left
c_func
(paren
id|parent
)paren
op_eq
id|frag
)paren
id|parent-&gt;rb.rb_left
op_assign
l_int|NULL
suffix:semicolon
r_else
id|parent-&gt;rb.rb_right
op_assign
l_int|NULL
suffix:semicolon
)brace
id|jffs2_free_node_frag
c_func
(paren
id|frag
)paren
suffix:semicolon
id|frag
op_assign
id|parent
suffix:semicolon
id|cond_resched
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
DECL|function|jffs2_fragtree_insert
r_void
id|jffs2_fragtree_insert
c_func
(paren
r_struct
id|jffs2_node_frag
op_star
id|newfrag
comma
r_struct
id|jffs2_node_frag
op_star
id|base
)paren
(brace
r_struct
id|rb_node
op_star
id|parent
op_assign
op_amp
id|base-&gt;rb
suffix:semicolon
r_struct
id|rb_node
op_star
op_star
id|link
op_assign
op_amp
id|parent
suffix:semicolon
id|D2
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;jffs2_fragtree_insert(%p; %d-%d, %p)&bslash;n&quot;
comma
id|newfrag
comma
id|newfrag-&gt;ofs
comma
id|newfrag-&gt;ofs
op_plus
id|newfrag-&gt;size
comma
id|base
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
op_star
id|link
)paren
(brace
id|parent
op_assign
op_star
id|link
suffix:semicolon
id|base
op_assign
id|rb_entry
c_func
(paren
id|parent
comma
r_struct
id|jffs2_node_frag
comma
id|rb
)paren
suffix:semicolon
id|D2
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;fragtree_insert considering frag at 0x%x&bslash;n&quot;
comma
id|base-&gt;ofs
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|newfrag-&gt;ofs
OG
id|base-&gt;ofs
)paren
id|link
op_assign
op_amp
id|base-&gt;rb.rb_right
suffix:semicolon
r_else
r_if
c_cond
(paren
id|newfrag-&gt;ofs
OL
id|base-&gt;ofs
)paren
id|link
op_assign
op_amp
id|base-&gt;rb.rb_left
suffix:semicolon
r_else
(brace
id|printk
c_func
(paren
id|KERN_CRIT
l_string|&quot;Duplicate frag at %08x (%p,%p)&bslash;n&quot;
comma
id|newfrag-&gt;ofs
comma
id|newfrag
comma
id|base
)paren
suffix:semicolon
id|BUG
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
id|rb_link_node
c_func
(paren
op_amp
id|newfrag-&gt;rb
comma
op_amp
id|base-&gt;rb
comma
id|link
)paren
suffix:semicolon
)brace
eof
