multiline_comment|/*&n; * JFFS2 -- Journalling Flash File System, Version 2.&n; *&n; * Copyright (C) 2001, 2002 Red Hat, Inc.&n; *&n; * Created by David Woodhouse &lt;dwmw2@cambridge.redhat.com&gt;&n; *&n; * The original JFFS, from which the design for JFFS2 was derived,&n; * was designed and implemented by Axis Communications AB.&n; *&n; * The contents of this file are subject to the Red Hat eCos Public&n; * License Version 1.1 (the &quot;Licence&quot;); you may not use this file&n; * except in compliance with the Licence.  You may obtain a copy of&n; * the Licence at http://www.redhat.com/&n; *&n; * Software distributed under the Licence is distributed on an &quot;AS IS&quot;&n; * basis, WITHOUT WARRANTY OF ANY KIND, either express or implied.&n; * See the Licence for the specific language governing rights and&n; * limitations under the Licence.&n; *&n; * The Original Code is JFFS2 - Journalling Flash File System, version 2&n; *&n; * Alternatively, the contents of this file may be used under the&n; * terms of the GNU General Public License version 2 (the &quot;GPL&quot;), in&n; * which case the provisions of the GPL are applicable instead of the&n; * above.  If you wish to allow the use of your version of this file&n; * only under the terms of the GPL and not to allow others to use your&n; * version of this file under the RHEPL, indicate your decision by&n; * deleting the provisions above and replace them with the notice and&n; * other provisions required by the GPL.  If you do not delete the&n; * provisions above, a recipient may use your version of this file&n; * under either the RHEPL or the GPL.&n; *&n; * $Id: nodelist.c,v 1.30.2.3 2002/02/23 14:04:44 dwmw2 Exp $&n; *&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/jffs2.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/mtd/mtd.h&gt;
macro_line|#include &quot;nodelist.h&quot;
DECL|function|jffs2_add_fd_to_list
r_void
id|jffs2_add_fd_to_list
c_func
(paren
r_struct
id|jffs2_sb_info
op_star
id|c
comma
r_struct
id|jffs2_full_dirent
op_star
r_new
comma
r_struct
id|jffs2_full_dirent
op_star
op_star
id|list
)paren
(brace
r_struct
id|jffs2_full_dirent
op_star
op_star
id|prev
op_assign
id|list
suffix:semicolon
id|D1
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;jffs2_add_fd_to_list( %p, %p (-&gt;%p))&bslash;n&quot;
comma
r_new
comma
id|list
comma
op_star
id|list
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
op_star
id|prev
)paren
op_logical_and
(paren
op_star
id|prev
)paren
op_member_access_from_pointer
id|nhash
op_le
r_new
op_member_access_from_pointer
id|nhash
)paren
(brace
r_if
c_cond
(paren
(paren
op_star
id|prev
)paren
op_member_access_from_pointer
id|nhash
op_eq
r_new
op_member_access_from_pointer
id|nhash
op_logical_and
op_logical_neg
id|strcmp
c_func
(paren
(paren
op_star
id|prev
)paren
op_member_access_from_pointer
id|name
comma
r_new
op_member_access_from_pointer
id|name
)paren
)paren
(brace
multiline_comment|/* Duplicate. Free one */
r_if
c_cond
(paren
r_new
op_member_access_from_pointer
id|version
OL
(paren
op_star
id|prev
)paren
op_member_access_from_pointer
id|version
)paren
(brace
id|D1
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Eep! Marking new dirent node obsolete&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|D1
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;New dirent is &bslash;&quot;%s&bslash;&quot;-&gt;ino #%u. Old is &bslash;&quot;%s&bslash;&quot;-&gt;ino #%u&bslash;n&quot;
comma
r_new
op_member_access_from_pointer
id|name
comma
r_new
op_member_access_from_pointer
id|ino
comma
(paren
op_star
id|prev
)paren
op_member_access_from_pointer
id|name
comma
(paren
op_star
id|prev
)paren
op_member_access_from_pointer
id|ino
)paren
)paren
suffix:semicolon
id|jffs2_mark_node_obsolete
c_func
(paren
id|c
comma
r_new
op_member_access_from_pointer
id|raw
)paren
suffix:semicolon
id|jffs2_free_full_dirent
c_func
(paren
r_new
)paren
suffix:semicolon
)brace
r_else
(brace
id|D1
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Marking old dirent node (ino #%u) obsolete&bslash;n&quot;
comma
(paren
op_star
id|prev
)paren
op_member_access_from_pointer
id|ino
)paren
)paren
suffix:semicolon
r_new
op_member_access_from_pointer
id|next
op_assign
(paren
op_star
id|prev
)paren
op_member_access_from_pointer
id|next
suffix:semicolon
id|jffs2_mark_node_obsolete
c_func
(paren
id|c
comma
(paren
(paren
op_star
id|prev
)paren
op_member_access_from_pointer
id|raw
)paren
)paren
suffix:semicolon
id|jffs2_free_full_dirent
c_func
(paren
op_star
id|prev
)paren
suffix:semicolon
op_star
id|prev
op_assign
r_new
suffix:semicolon
)brace
r_goto
id|out
suffix:semicolon
)brace
id|prev
op_assign
op_amp
(paren
(paren
op_star
id|prev
)paren
op_member_access_from_pointer
id|next
)paren
suffix:semicolon
)brace
r_new
op_member_access_from_pointer
id|next
op_assign
op_star
id|prev
suffix:semicolon
op_star
id|prev
op_assign
r_new
suffix:semicolon
id|out
suffix:colon
id|D1
c_func
(paren
r_while
(paren
op_star
id|list
)paren
(brace
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Dirent &bslash;&quot;%s&bslash;&quot; (hash 0x%08x, ino #%u&bslash;n&quot;
comma
(paren
op_star
id|list
)paren
op_member_access_from_pointer
id|name
comma
(paren
op_star
id|list
)paren
op_member_access_from_pointer
id|nhash
comma
(paren
op_star
id|list
)paren
op_member_access_from_pointer
id|ino
)paren
suffix:semicolon
id|list
op_assign
op_amp
(paren
op_star
id|list
)paren
op_member_access_from_pointer
id|next
suffix:semicolon
)brace
)paren
suffix:semicolon
)brace
multiline_comment|/* Put a new tmp_dnode_info into the list, keeping the list in &n;   order of increasing version&n;*/
DECL|function|jffs2_add_tn_to_list
r_void
id|jffs2_add_tn_to_list
c_func
(paren
r_struct
id|jffs2_tmp_dnode_info
op_star
id|tn
comma
r_struct
id|jffs2_tmp_dnode_info
op_star
op_star
id|list
)paren
(brace
r_struct
id|jffs2_tmp_dnode_info
op_star
op_star
id|prev
op_assign
id|list
suffix:semicolon
r_while
c_loop
(paren
(paren
op_star
id|prev
)paren
op_logical_and
(paren
op_star
id|prev
)paren
op_member_access_from_pointer
id|version
OL
id|tn-&gt;version
)paren
(brace
id|prev
op_assign
op_amp
(paren
(paren
op_star
id|prev
)paren
op_member_access_from_pointer
id|next
)paren
suffix:semicolon
)brace
id|tn-&gt;next
op_assign
(paren
op_star
id|prev
)paren
suffix:semicolon
op_star
id|prev
op_assign
id|tn
suffix:semicolon
)brace
multiline_comment|/* Get tmp_dnode_info and full_dirent for all non-obsolete nodes associated&n;   with this ino, returning the former in order of version */
DECL|function|jffs2_get_inode_nodes
r_int
id|jffs2_get_inode_nodes
c_func
(paren
r_struct
id|jffs2_sb_info
op_star
id|c
comma
id|ino_t
id|ino
comma
r_struct
id|jffs2_inode_info
op_star
id|f
comma
r_struct
id|jffs2_tmp_dnode_info
op_star
op_star
id|tnp
comma
r_struct
id|jffs2_full_dirent
op_star
op_star
id|fdp
comma
id|__u32
op_star
id|highest_version
comma
id|__u32
op_star
id|latest_mctime
comma
id|__u32
op_star
id|mctime_ver
)paren
(brace
r_struct
id|jffs2_raw_node_ref
op_star
id|ref
op_assign
id|f-&gt;inocache-&gt;nodes
suffix:semicolon
r_struct
id|jffs2_tmp_dnode_info
op_star
id|tn
comma
op_star
id|ret_tn
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|jffs2_full_dirent
op_star
id|fd
comma
op_star
id|ret_fd
op_assign
l_int|NULL
suffix:semicolon
r_union
id|jffs2_node_union
id|node
suffix:semicolon
r_int
id|retlen
suffix:semicolon
r_int
id|err
suffix:semicolon
op_star
id|mctime_ver
op_assign
l_int|0
suffix:semicolon
id|D1
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;jffs2_get_inode_nodes(): ino #%lu&bslash;n&quot;
comma
id|ino
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|f-&gt;inocache-&gt;nodes
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Eep. no nodes for ino #%lu&bslash;n&quot;
comma
id|ino
)paren
suffix:semicolon
)brace
r_for
c_loop
(paren
id|ref
op_assign
id|f-&gt;inocache-&gt;nodes
suffix:semicolon
id|ref
op_logical_and
id|ref-&gt;next_in_ino
suffix:semicolon
id|ref
op_assign
id|ref-&gt;next_in_ino
)paren
(brace
multiline_comment|/* Work out whether it&squot;s a data node or a dirent node */
r_if
c_cond
(paren
id|ref-&gt;flash_offset
op_amp
l_int|1
)paren
(brace
multiline_comment|/* FIXME: On NAND flash we may need to read these */
id|D1
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;node at 0x%08x is obsoleted. Ignoring.&bslash;n&quot;
comma
id|ref-&gt;flash_offset
op_amp
op_complement
l_int|3
)paren
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|err
op_assign
id|c-&gt;mtd
op_member_access_from_pointer
id|read
c_func
(paren
id|c-&gt;mtd
comma
(paren
id|ref-&gt;flash_offset
op_amp
op_complement
l_int|3
)paren
comma
id|min
c_func
(paren
id|ref-&gt;totlen
comma
r_sizeof
(paren
id|node
)paren
)paren
comma
op_amp
id|retlen
comma
(paren
r_void
op_star
)paren
op_amp
id|node
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;error %d reading node at 0x%08x in get_inode_nodes()&bslash;n&quot;
comma
id|err
comma
(paren
id|ref-&gt;flash_offset
)paren
op_amp
op_complement
l_int|3
)paren
suffix:semicolon
r_goto
id|free_out
suffix:semicolon
)brace
multiline_comment|/* Check we&squot;ve managed to read at least the common node header */
r_if
c_cond
(paren
id|retlen
OL
id|min
c_func
(paren
id|ref-&gt;totlen
comma
r_sizeof
(paren
id|node.u
)paren
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;short read in get_inode_nodes()&bslash;n&quot;
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|free_out
suffix:semicolon
)brace
r_switch
c_cond
(paren
id|node.u.nodetype
)paren
(brace
r_case
id|JFFS2_NODETYPE_DIRENT
suffix:colon
id|D1
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Node at %08x is a dirent node&bslash;n&quot;
comma
id|ref-&gt;flash_offset
op_amp
op_complement
l_int|3
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retlen
OL
r_sizeof
(paren
id|node.d
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;short read in get_inode_nodes()&bslash;n&quot;
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|free_out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|node.d.version
OG
op_star
id|highest_version
)paren
op_star
id|highest_version
op_assign
id|node.d.version
suffix:semicolon
r_if
c_cond
(paren
id|ref-&gt;flash_offset
op_amp
l_int|1
)paren
(brace
multiline_comment|/* Obsoleted */
r_continue
suffix:semicolon
)brace
id|fd
op_assign
id|jffs2_alloc_full_dirent
c_func
(paren
id|node.d.nsize
op_plus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fd
)paren
(brace
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|free_out
suffix:semicolon
)brace
id|memset
c_func
(paren
id|fd
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|jffs2_full_dirent
)paren
op_plus
id|node.d.nsize
op_plus
l_int|1
)paren
suffix:semicolon
id|fd-&gt;raw
op_assign
id|ref
suffix:semicolon
id|fd-&gt;version
op_assign
id|node.d.version
suffix:semicolon
id|fd-&gt;ino
op_assign
id|node.d.ino
suffix:semicolon
id|fd-&gt;type
op_assign
id|node.d.type
suffix:semicolon
multiline_comment|/* Pick out the mctime of the latest dirent */
r_if
c_cond
(paren
id|fd-&gt;version
OG
op_star
id|mctime_ver
)paren
(brace
op_star
id|mctime_ver
op_assign
id|fd-&gt;version
suffix:semicolon
op_star
id|latest_mctime
op_assign
id|node.d.mctime
suffix:semicolon
)brace
multiline_comment|/* memcpy as much of the name as possible from the raw&n;&t;&t;&t;   dirent we&squot;ve already read from the flash&n;&t;&t;&t;*/
r_if
c_cond
(paren
id|retlen
OG
r_sizeof
(paren
r_struct
id|jffs2_raw_dirent
)paren
)paren
id|memcpy
c_func
(paren
op_amp
id|fd-&gt;name
(braket
l_int|0
)braket
comma
op_amp
id|node.d.name
(braket
l_int|0
)braket
comma
id|min
c_func
(paren
(paren
id|__u32
)paren
id|node.d.nsize
comma
(paren
id|retlen
op_minus
r_sizeof
(paren
r_struct
id|jffs2_raw_dirent
)paren
)paren
)paren
)paren
suffix:semicolon
multiline_comment|/* Do we need to copy any more of the name directly&n;&t;&t;&t;   from the flash?&n;&t;&t;&t;*/
r_if
c_cond
(paren
id|node.d.nsize
op_plus
r_sizeof
(paren
r_struct
id|jffs2_raw_dirent
)paren
OG
id|retlen
)paren
(brace
r_int
id|already
op_assign
id|retlen
op_minus
r_sizeof
(paren
r_struct
id|jffs2_raw_dirent
)paren
suffix:semicolon
id|err
op_assign
id|c-&gt;mtd
op_member_access_from_pointer
id|read
c_func
(paren
id|c-&gt;mtd
comma
(paren
id|ref-&gt;flash_offset
op_amp
op_complement
l_int|3
)paren
op_plus
id|retlen
comma
id|node.d.nsize
op_minus
id|already
comma
op_amp
id|retlen
comma
op_amp
id|fd-&gt;name
(braket
id|already
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|err
op_logical_and
id|retlen
op_ne
id|node.d.nsize
op_minus
id|already
)paren
id|err
op_assign
op_minus
id|EIO
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;Read remainder of name in jffs2_get_inode_nodes(): error %d&bslash;n&quot;
comma
id|err
)paren
suffix:semicolon
id|jffs2_free_full_dirent
c_func
(paren
id|fd
)paren
suffix:semicolon
r_goto
id|free_out
suffix:semicolon
)brace
)brace
id|fd-&gt;nhash
op_assign
id|full_name_hash
c_func
(paren
id|fd-&gt;name
comma
id|node.d.nsize
)paren
suffix:semicolon
id|fd-&gt;next
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* Wheee. We now have a complete jffs2_full_dirent structure, with&n;&t;&t;&t;&t;   the name in it and everything. Link it into the list &n;&t;&t;&t;&t;*/
id|D1
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Adding fd &bslash;&quot;%s&bslash;&quot;, ino #%u&bslash;n&quot;
comma
id|fd-&gt;name
comma
id|fd-&gt;ino
)paren
)paren
suffix:semicolon
id|jffs2_add_fd_to_list
c_func
(paren
id|c
comma
id|fd
comma
op_amp
id|ret_fd
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|JFFS2_NODETYPE_INODE
suffix:colon
id|D1
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Node at %08x is a data node&bslash;n&quot;
comma
id|ref-&gt;flash_offset
op_amp
op_complement
l_int|3
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|retlen
OL
r_sizeof
(paren
id|node.i
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;read too short for dnode&bslash;n&quot;
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EIO
suffix:semicolon
r_goto
id|free_out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|node.d.version
OG
op_star
id|highest_version
)paren
op_star
id|highest_version
op_assign
id|node.i.version
suffix:semicolon
id|D1
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;version %d, highest_version now %d&bslash;n&quot;
comma
id|node.d.version
comma
op_star
id|highest_version
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ref-&gt;flash_offset
op_amp
l_int|1
)paren
(brace
id|D1
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;obsoleted&bslash;n&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* Obsoleted */
r_continue
suffix:semicolon
)brace
id|tn
op_assign
id|jffs2_alloc_tmp_dnode_info
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tn
)paren
(brace
id|D1
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;alloc tn failed&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|free_out
suffix:semicolon
)brace
id|tn-&gt;fn
op_assign
id|jffs2_alloc_full_dnode
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tn-&gt;fn
)paren
(brace
id|D1
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;alloc fn failed&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
id|jffs2_free_tmp_dnode_info
c_func
(paren
id|tn
)paren
suffix:semicolon
r_goto
id|free_out
suffix:semicolon
)brace
id|tn-&gt;version
op_assign
id|node.i.version
suffix:semicolon
id|tn-&gt;fn-&gt;ofs
op_assign
id|node.i.offset
suffix:semicolon
multiline_comment|/* There was a bug where we wrote hole nodes out with&n;&t;&t;&t;   csize/dsize swapped. Deal with it */
r_if
c_cond
(paren
id|node.i.compr
op_eq
id|JFFS2_COMPR_ZERO
op_logical_and
op_logical_neg
id|node.i.dsize
op_logical_and
id|node.i.csize
)paren
id|tn-&gt;fn-&gt;size
op_assign
id|node.i.csize
suffix:semicolon
r_else
singleline_comment|// normal case...
id|tn-&gt;fn-&gt;size
op_assign
id|node.i.dsize
suffix:semicolon
id|tn-&gt;fn-&gt;raw
op_assign
id|ref
suffix:semicolon
id|D1
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;dnode @%08x: ver %u, offset %04x, dsize %04x&bslash;n&quot;
comma
id|ref-&gt;flash_offset
op_amp
op_complement
l_int|3
comma
id|node.i.version
comma
id|node.i.offset
comma
id|node.i.dsize
)paren
)paren
suffix:semicolon
id|jffs2_add_tn_to_list
c_func
(paren
id|tn
comma
op_amp
id|ret_tn
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
(brace
)brace
r_switch
c_cond
(paren
id|node.u.nodetype
op_amp
id|JFFS2_COMPAT_MASK
)paren
(brace
r_case
id|JFFS2_FEATURE_INCOMPAT
suffix:colon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;Unknown INCOMPAT nodetype %04X at %08X&bslash;n&quot;
comma
id|node.u.nodetype
comma
id|ref-&gt;flash_offset
op_amp
op_complement
l_int|3
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|JFFS2_FEATURE_ROCOMPAT
suffix:colon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;Unknown ROCOMPAT nodetype %04X at %08X&bslash;n&quot;
comma
id|node.u.nodetype
comma
id|ref-&gt;flash_offset
op_amp
op_complement
l_int|3
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|JFFS2_FEATURE_RWCOMPAT_COPY
suffix:colon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;Unknown RWCOMPAT_COPY nodetype %04X at %08X&bslash;n&quot;
comma
id|node.u.nodetype
comma
id|ref-&gt;flash_offset
op_amp
op_complement
l_int|3
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|JFFS2_FEATURE_RWCOMPAT_DELETE
suffix:colon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;Unknown RWCOMPAT_DELETE nodetype %04X at %08X&bslash;n&quot;
comma
id|node.u.nodetype
comma
id|ref-&gt;flash_offset
op_amp
op_complement
l_int|3
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
)brace
op_star
id|tnp
op_assign
id|ret_tn
suffix:semicolon
op_star
id|fdp
op_assign
id|ret_fd
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|free_out
suffix:colon
id|jffs2_free_tmp_dnode_info_list
c_func
(paren
id|ret_tn
)paren
suffix:semicolon
id|jffs2_free_full_dirent_list
c_func
(paren
id|ret_fd
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|jffs2_get_ino_cache
r_struct
id|jffs2_inode_cache
op_star
id|jffs2_get_ino_cache
c_func
(paren
r_struct
id|jffs2_sb_info
op_star
id|c
comma
r_int
id|ino
)paren
(brace
r_struct
id|jffs2_inode_cache
op_star
id|ret
suffix:semicolon
id|D2
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;jffs2_get_ino_cache(): ino %u&bslash;n&quot;
comma
id|ino
)paren
)paren
suffix:semicolon
id|spin_lock
(paren
op_amp
id|c-&gt;inocache_lock
)paren
suffix:semicolon
id|ret
op_assign
id|c-&gt;inocache_list
(braket
id|ino
op_mod
id|INOCACHE_HASHSIZE
)braket
suffix:semicolon
r_while
c_loop
(paren
id|ret
op_logical_and
id|ret-&gt;ino
OL
id|ino
)paren
(brace
id|ret
op_assign
id|ret-&gt;next
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|c-&gt;inocache_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_logical_and
id|ret-&gt;ino
op_ne
id|ino
)paren
id|ret
op_assign
l_int|NULL
suffix:semicolon
id|D2
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;jffs2_get_ino_cache found %p for ino %u&bslash;n&quot;
comma
id|ret
comma
id|ino
)paren
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|jffs2_add_ino_cache
r_void
id|jffs2_add_ino_cache
(paren
r_struct
id|jffs2_sb_info
op_star
id|c
comma
r_struct
id|jffs2_inode_cache
op_star
r_new
)paren
(brace
r_struct
id|jffs2_inode_cache
op_star
op_star
id|prev
suffix:semicolon
id|D2
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;jffs2_add_ino_cache: Add %p (ino #%u)&bslash;n&quot;
comma
r_new
comma
r_new
op_member_access_from_pointer
id|ino
)paren
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|c-&gt;inocache_lock
)paren
suffix:semicolon
id|prev
op_assign
op_amp
id|c-&gt;inocache_list
(braket
r_new
op_member_access_from_pointer
id|ino
op_mod
id|INOCACHE_HASHSIZE
)braket
suffix:semicolon
r_while
c_loop
(paren
(paren
op_star
id|prev
)paren
op_logical_and
(paren
op_star
id|prev
)paren
op_member_access_from_pointer
id|ino
OL
r_new
op_member_access_from_pointer
id|ino
)paren
(brace
id|prev
op_assign
op_amp
(paren
op_star
id|prev
)paren
op_member_access_from_pointer
id|next
suffix:semicolon
)brace
r_new
op_member_access_from_pointer
id|next
op_assign
op_star
id|prev
suffix:semicolon
op_star
id|prev
op_assign
r_new
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|c-&gt;inocache_lock
)paren
suffix:semicolon
)brace
DECL|function|jffs2_del_ino_cache
r_void
id|jffs2_del_ino_cache
c_func
(paren
r_struct
id|jffs2_sb_info
op_star
id|c
comma
r_struct
id|jffs2_inode_cache
op_star
id|old
)paren
(brace
r_struct
id|jffs2_inode_cache
op_star
op_star
id|prev
suffix:semicolon
id|D2
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;jffs2_del_ino_cache: Del %p (ino #%u)&bslash;n&quot;
comma
id|old
comma
id|old-&gt;ino
)paren
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|c-&gt;inocache_lock
)paren
suffix:semicolon
id|prev
op_assign
op_amp
id|c-&gt;inocache_list
(braket
id|old-&gt;ino
op_mod
id|INOCACHE_HASHSIZE
)braket
suffix:semicolon
r_while
c_loop
(paren
(paren
op_star
id|prev
)paren
op_logical_and
(paren
op_star
id|prev
)paren
op_member_access_from_pointer
id|ino
OL
id|old-&gt;ino
)paren
(brace
id|prev
op_assign
op_amp
(paren
op_star
id|prev
)paren
op_member_access_from_pointer
id|next
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
op_star
id|prev
)paren
op_eq
id|old
)paren
(brace
op_star
id|prev
op_assign
id|old-&gt;next
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|c-&gt;inocache_lock
)paren
suffix:semicolon
)brace
DECL|function|jffs2_free_ino_caches
r_void
id|jffs2_free_ino_caches
c_func
(paren
r_struct
id|jffs2_sb_info
op_star
id|c
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|jffs2_inode_cache
op_star
id|this
comma
op_star
id|next
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|INOCACHE_HASHSIZE
suffix:semicolon
id|i
op_increment
)paren
(brace
id|this
op_assign
id|c-&gt;inocache_list
(braket
id|i
)braket
suffix:semicolon
r_while
c_loop
(paren
id|this
)paren
(brace
id|next
op_assign
id|this-&gt;next
suffix:semicolon
id|D2
c_func
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;jffs2_free_ino_caches: Freeing ino #%u at %p&bslash;n&quot;
comma
id|this-&gt;ino
comma
id|this
)paren
)paren
suffix:semicolon
id|jffs2_free_inode_cache
c_func
(paren
id|this
)paren
suffix:semicolon
id|this
op_assign
id|next
suffix:semicolon
)brace
id|c-&gt;inocache_list
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
DECL|function|jffs2_free_raw_node_refs
r_void
id|jffs2_free_raw_node_refs
c_func
(paren
r_struct
id|jffs2_sb_info
op_star
id|c
)paren
(brace
r_int
id|i
suffix:semicolon
r_struct
id|jffs2_raw_node_ref
op_star
id|this
comma
op_star
id|next
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|c-&gt;nr_blocks
suffix:semicolon
id|i
op_increment
)paren
(brace
id|this
op_assign
id|c-&gt;blocks
(braket
id|i
)braket
dot
id|first_node
suffix:semicolon
r_while
c_loop
(paren
id|this
)paren
(brace
id|next
op_assign
id|this-&gt;next_phys
suffix:semicolon
id|jffs2_free_raw_node_ref
c_func
(paren
id|this
)paren
suffix:semicolon
id|this
op_assign
id|next
suffix:semicolon
)brace
id|c-&gt;blocks
(braket
id|i
)braket
dot
id|first_node
op_assign
id|c-&gt;blocks
(braket
id|i
)braket
dot
id|last_node
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
eof
