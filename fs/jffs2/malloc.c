multiline_comment|/*&n; * JFFS2 -- Journalling Flash File System, Version 2.&n; *&n; * Copyright (C) 2001-2003 Red Hat, Inc.&n; *&n; * Created by David Woodhouse &lt;dwmw2@redhat.com&gt;&n; *&n; * For licensing information, see the file &squot;LICENCE&squot; in this directory.&n; *&n; * $Id: malloc.c,v 1.25 2003/10/04 08:33:06 dwmw2 Exp $&n; *&n; */
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/jffs2.h&gt;
macro_line|#include &quot;nodelist.h&quot;
macro_line|#if 0
mdefine_line|#define JFFS2_SLAB_POISON SLAB_POISON
macro_line|#else
DECL|macro|JFFS2_SLAB_POISON
mdefine_line|#define JFFS2_SLAB_POISON 0
macro_line|#endif
singleline_comment|// replace this by #define D3 (x) x for cache debugging
DECL|macro|D3
mdefine_line|#define D3(x)
multiline_comment|/* These are initialised to NULL in the kernel startup code.&n;   If you&squot;re porting to other operating systems, beware */
DECL|variable|full_dnode_slab
r_static
id|kmem_cache_t
op_star
id|full_dnode_slab
suffix:semicolon
DECL|variable|raw_dirent_slab
r_static
id|kmem_cache_t
op_star
id|raw_dirent_slab
suffix:semicolon
DECL|variable|raw_inode_slab
r_static
id|kmem_cache_t
op_star
id|raw_inode_slab
suffix:semicolon
DECL|variable|tmp_dnode_info_slab
r_static
id|kmem_cache_t
op_star
id|tmp_dnode_info_slab
suffix:semicolon
DECL|variable|raw_node_ref_slab
r_static
id|kmem_cache_t
op_star
id|raw_node_ref_slab
suffix:semicolon
DECL|variable|node_frag_slab
r_static
id|kmem_cache_t
op_star
id|node_frag_slab
suffix:semicolon
DECL|variable|inode_cache_slab
r_static
id|kmem_cache_t
op_star
id|inode_cache_slab
suffix:semicolon
DECL|function|jffs2_create_slab_caches
r_int
id|__init
id|jffs2_create_slab_caches
c_func
(paren
r_void
)paren
(brace
id|full_dnode_slab
op_assign
id|kmem_cache_create
c_func
(paren
l_string|&quot;jffs2_full_dnode&quot;
comma
r_sizeof
(paren
r_struct
id|jffs2_full_dnode
)paren
comma
l_int|0
comma
id|JFFS2_SLAB_POISON
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|full_dnode_slab
)paren
r_goto
id|err
suffix:semicolon
id|raw_dirent_slab
op_assign
id|kmem_cache_create
c_func
(paren
l_string|&quot;jffs2_raw_dirent&quot;
comma
r_sizeof
(paren
r_struct
id|jffs2_raw_dirent
)paren
comma
l_int|0
comma
id|JFFS2_SLAB_POISON
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|raw_dirent_slab
)paren
r_goto
id|err
suffix:semicolon
id|raw_inode_slab
op_assign
id|kmem_cache_create
c_func
(paren
l_string|&quot;jffs2_raw_inode&quot;
comma
r_sizeof
(paren
r_struct
id|jffs2_raw_inode
)paren
comma
l_int|0
comma
id|JFFS2_SLAB_POISON
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|raw_inode_slab
)paren
r_goto
id|err
suffix:semicolon
id|tmp_dnode_info_slab
op_assign
id|kmem_cache_create
c_func
(paren
l_string|&quot;jffs2_tmp_dnode&quot;
comma
r_sizeof
(paren
r_struct
id|jffs2_tmp_dnode_info
)paren
comma
l_int|0
comma
id|JFFS2_SLAB_POISON
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|tmp_dnode_info_slab
)paren
r_goto
id|err
suffix:semicolon
id|raw_node_ref_slab
op_assign
id|kmem_cache_create
c_func
(paren
l_string|&quot;jffs2_raw_node_ref&quot;
comma
r_sizeof
(paren
r_struct
id|jffs2_raw_node_ref
)paren
comma
l_int|0
comma
id|JFFS2_SLAB_POISON
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|raw_node_ref_slab
)paren
r_goto
id|err
suffix:semicolon
id|node_frag_slab
op_assign
id|kmem_cache_create
c_func
(paren
l_string|&quot;jffs2_node_frag&quot;
comma
r_sizeof
(paren
r_struct
id|jffs2_node_frag
)paren
comma
l_int|0
comma
id|JFFS2_SLAB_POISON
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|node_frag_slab
)paren
r_goto
id|err
suffix:semicolon
id|inode_cache_slab
op_assign
id|kmem_cache_create
c_func
(paren
l_string|&quot;jffs2_inode_cache&quot;
comma
r_sizeof
(paren
r_struct
id|jffs2_inode_cache
)paren
comma
l_int|0
comma
id|JFFS2_SLAB_POISON
comma
l_int|NULL
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inode_cache_slab
)paren
r_return
l_int|0
suffix:semicolon
id|err
suffix:colon
id|jffs2_destroy_slab_caches
c_func
(paren
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
DECL|function|jffs2_destroy_slab_caches
r_void
id|jffs2_destroy_slab_caches
c_func
(paren
r_void
)paren
(brace
r_if
c_cond
(paren
id|full_dnode_slab
)paren
(brace
id|kmem_cache_destroy
c_func
(paren
id|full_dnode_slab
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|raw_dirent_slab
)paren
(brace
id|kmem_cache_destroy
c_func
(paren
id|raw_dirent_slab
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|raw_inode_slab
)paren
(brace
id|kmem_cache_destroy
c_func
(paren
id|raw_inode_slab
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tmp_dnode_info_slab
)paren
(brace
id|kmem_cache_destroy
c_func
(paren
id|tmp_dnode_info_slab
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|raw_node_ref_slab
)paren
(brace
id|kmem_cache_destroy
c_func
(paren
id|raw_node_ref_slab
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|node_frag_slab
)paren
(brace
id|kmem_cache_destroy
c_func
(paren
id|node_frag_slab
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|inode_cache_slab
)paren
(brace
id|kmem_cache_destroy
c_func
(paren
id|inode_cache_slab
)paren
suffix:semicolon
)brace
)brace
DECL|function|jffs2_alloc_full_dirent
r_struct
id|jffs2_full_dirent
op_star
id|jffs2_alloc_full_dirent
c_func
(paren
r_int
id|namesize
)paren
(brace
r_return
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|jffs2_full_dirent
)paren
op_plus
id|namesize
comma
id|GFP_KERNEL
)paren
suffix:semicolon
)brace
DECL|function|jffs2_free_full_dirent
r_void
id|jffs2_free_full_dirent
c_func
(paren
r_struct
id|jffs2_full_dirent
op_star
id|x
)paren
(brace
id|kfree
c_func
(paren
id|x
)paren
suffix:semicolon
)brace
DECL|function|jffs2_alloc_full_dnode
r_struct
id|jffs2_full_dnode
op_star
id|jffs2_alloc_full_dnode
c_func
(paren
r_void
)paren
(brace
r_struct
id|jffs2_full_dnode
op_star
id|ret
op_assign
id|kmem_cache_alloc
c_func
(paren
id|full_dnode_slab
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|D3
(paren
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;alloc_full_dnode at %p&bslash;n&quot;
comma
id|ret
)paren
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|jffs2_free_full_dnode
r_void
id|jffs2_free_full_dnode
c_func
(paren
r_struct
id|jffs2_full_dnode
op_star
id|x
)paren
(brace
id|D3
(paren
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;free full_dnode at %p&bslash;n&quot;
comma
id|x
)paren
)paren
suffix:semicolon
id|kmem_cache_free
c_func
(paren
id|full_dnode_slab
comma
id|x
)paren
suffix:semicolon
)brace
DECL|function|jffs2_alloc_raw_dirent
r_struct
id|jffs2_raw_dirent
op_star
id|jffs2_alloc_raw_dirent
c_func
(paren
r_void
)paren
(brace
r_struct
id|jffs2_raw_dirent
op_star
id|ret
op_assign
id|kmem_cache_alloc
c_func
(paren
id|raw_dirent_slab
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|D3
(paren
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;alloc_raw_dirent&bslash;n&quot;
comma
id|ret
)paren
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|jffs2_free_raw_dirent
r_void
id|jffs2_free_raw_dirent
c_func
(paren
r_struct
id|jffs2_raw_dirent
op_star
id|x
)paren
(brace
id|D3
(paren
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;free_raw_dirent at %p&bslash;n&quot;
comma
id|x
)paren
)paren
suffix:semicolon
id|kmem_cache_free
c_func
(paren
id|raw_dirent_slab
comma
id|x
)paren
suffix:semicolon
)brace
DECL|function|jffs2_alloc_raw_inode
r_struct
id|jffs2_raw_inode
op_star
id|jffs2_alloc_raw_inode
c_func
(paren
r_void
)paren
(brace
r_struct
id|jffs2_raw_inode
op_star
id|ret
op_assign
id|kmem_cache_alloc
c_func
(paren
id|raw_inode_slab
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|D3
(paren
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;alloc_raw_inode at %p&bslash;n&quot;
comma
id|ret
)paren
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|jffs2_free_raw_inode
r_void
id|jffs2_free_raw_inode
c_func
(paren
r_struct
id|jffs2_raw_inode
op_star
id|x
)paren
(brace
id|D3
(paren
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;free_raw_inode at %p&bslash;n&quot;
comma
id|x
)paren
)paren
suffix:semicolon
id|kmem_cache_free
c_func
(paren
id|raw_inode_slab
comma
id|x
)paren
suffix:semicolon
)brace
DECL|function|jffs2_alloc_tmp_dnode_info
r_struct
id|jffs2_tmp_dnode_info
op_star
id|jffs2_alloc_tmp_dnode_info
c_func
(paren
r_void
)paren
(brace
r_struct
id|jffs2_tmp_dnode_info
op_star
id|ret
op_assign
id|kmem_cache_alloc
c_func
(paren
id|tmp_dnode_info_slab
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|D3
(paren
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;alloc_tmp_dnode_info at %p&bslash;n&quot;
comma
id|ret
)paren
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|jffs2_free_tmp_dnode_info
r_void
id|jffs2_free_tmp_dnode_info
c_func
(paren
r_struct
id|jffs2_tmp_dnode_info
op_star
id|x
)paren
(brace
id|D3
(paren
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;free_tmp_dnode_info at %p&bslash;n&quot;
comma
id|x
)paren
)paren
suffix:semicolon
id|kmem_cache_free
c_func
(paren
id|tmp_dnode_info_slab
comma
id|x
)paren
suffix:semicolon
)brace
DECL|function|jffs2_alloc_raw_node_ref
r_struct
id|jffs2_raw_node_ref
op_star
id|jffs2_alloc_raw_node_ref
c_func
(paren
r_void
)paren
(brace
r_struct
id|jffs2_raw_node_ref
op_star
id|ret
op_assign
id|kmem_cache_alloc
c_func
(paren
id|raw_node_ref_slab
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|D3
(paren
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;alloc_raw_node_ref at %p&bslash;n&quot;
comma
id|ret
)paren
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|jffs2_free_raw_node_ref
r_void
id|jffs2_free_raw_node_ref
c_func
(paren
r_struct
id|jffs2_raw_node_ref
op_star
id|x
)paren
(brace
id|D3
(paren
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;free_raw_node_ref at %p&bslash;n&quot;
comma
id|x
)paren
)paren
suffix:semicolon
id|kmem_cache_free
c_func
(paren
id|raw_node_ref_slab
comma
id|x
)paren
suffix:semicolon
)brace
DECL|function|jffs2_alloc_node_frag
r_struct
id|jffs2_node_frag
op_star
id|jffs2_alloc_node_frag
c_func
(paren
r_void
)paren
(brace
r_struct
id|jffs2_node_frag
op_star
id|ret
op_assign
id|kmem_cache_alloc
c_func
(paren
id|node_frag_slab
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|D3
(paren
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;alloc_node_frag at %p&bslash;n&quot;
comma
id|ret
)paren
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|jffs2_free_node_frag
r_void
id|jffs2_free_node_frag
c_func
(paren
r_struct
id|jffs2_node_frag
op_star
id|x
)paren
(brace
id|D3
(paren
id|printk
(paren
id|KERN_DEBUG
l_string|&quot;free_node_frag at %p&bslash;n&quot;
comma
id|x
)paren
)paren
suffix:semicolon
id|kmem_cache_free
c_func
(paren
id|node_frag_slab
comma
id|x
)paren
suffix:semicolon
)brace
DECL|function|jffs2_alloc_inode_cache
r_struct
id|jffs2_inode_cache
op_star
id|jffs2_alloc_inode_cache
c_func
(paren
r_void
)paren
(brace
r_struct
id|jffs2_inode_cache
op_star
id|ret
op_assign
id|kmem_cache_alloc
c_func
(paren
id|inode_cache_slab
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|D3
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Allocated inocache at %p&bslash;n&quot;
comma
id|ret
)paren
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|jffs2_free_inode_cache
r_void
id|jffs2_free_inode_cache
c_func
(paren
r_struct
id|jffs2_inode_cache
op_star
id|x
)paren
(brace
id|D3
(paren
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;Freeing inocache at %p&bslash;n&quot;
comma
id|x
)paren
)paren
suffix:semicolon
id|kmem_cache_free
c_func
(paren
id|inode_cache_slab
comma
id|x
)paren
suffix:semicolon
)brace
eof
