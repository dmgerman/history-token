multiline_comment|/*&n; *   fs/cifs/cifssmb.c&n; *&n; *   Copyright (C) International Business Machines  Corp., 2002,2003&n; *   Author(s): Steve French (sfrench@us.ibm.com)&n; *&n; *   Contains the routines for constructing the SMB PDUs themselves&n; *&n; *   This library is free software; you can redistribute it and/or modify&n; *   it under the terms of the GNU Lesser General Public License as published&n; *   by the Free Software Foundation; either version 2.1 of the License, or&n; *   (at your option) any later version.&n; *&n; *   This library is distributed in the hope that it will be useful,&n; *   but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See&n; *   the GNU Lesser General Public License for more details.&n; *&n; *   You should have received a copy of the GNU Lesser General Public License&n; *   along with this library; if not, write to the Free Software&n; *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA&n; */
multiline_comment|/* SMB/CIFS PDU handling routines here - except for leftovers in connect.c   */
multiline_comment|/* These are mostly routines that operate on a pathname, or on a tree id     */
multiline_comment|/* (mounted volume), but there are eight handle based routines which must be */
multiline_comment|/* treated slightly different for reconnection purposes since we never want  */
multiline_comment|/* to reuse a stale file handle and the caller knows the file handle */
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/vfs.h&gt;
macro_line|#include &lt;linux/posix_acl_xattr.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &quot;cifspdu.h&quot;
macro_line|#include &quot;cifsglob.h&quot;
macro_line|#include &quot;cifsproto.h&quot;
macro_line|#include &quot;cifs_unicode.h&quot;
macro_line|#include &quot;cifs_debug.h&quot;
macro_line|#ifdef CONFIG_CIFS_POSIX
r_static
r_struct
(brace
DECL|member|index
r_int
id|index
suffix:semicolon
DECL|member|name
r_char
op_star
id|name
suffix:semicolon
DECL|variable|protocols
)brace
id|protocols
(braket
)braket
op_assign
(brace
(brace
id|CIFS_PROT
comma
l_string|&quot;&bslash;2NT LM 0.12&quot;
)brace
comma
(brace
id|CIFS_PROT
comma
l_string|&quot;&bslash;2POSIX 2&quot;
)brace
comma
(brace
id|BAD_PROT
comma
l_string|&quot;&bslash;2&quot;
)brace
)brace
suffix:semicolon
macro_line|#else
r_static
r_struct
(brace
DECL|member|index
r_int
id|index
suffix:semicolon
DECL|member|name
r_char
op_star
id|name
suffix:semicolon
DECL|variable|protocols
)brace
id|protocols
(braket
)braket
op_assign
(brace
(brace
id|CIFS_PROT
comma
l_string|&quot;&bslash;2NT LM 0.12&quot;
)brace
comma
(brace
id|BAD_PROT
comma
l_string|&quot;&bslash;2&quot;
)brace
)brace
suffix:semicolon
macro_line|#endif
multiline_comment|/* Mark as invalid, all open files on tree connections since they&n;   were closed when session to server was lost */
DECL|function|mark_open_files_invalid
r_static
r_void
id|mark_open_files_invalid
c_func
(paren
r_struct
id|cifsTconInfo
op_star
id|pTcon
)paren
(brace
r_struct
id|cifsFileInfo
op_star
id|open_file
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|list_head
op_star
id|tmp
suffix:semicolon
r_struct
id|list_head
op_star
id|tmp1
suffix:semicolon
multiline_comment|/* list all files open on tree connection and mark them invalid */
id|write_lock
c_func
(paren
op_amp
id|GlobalSMBSeslock
)paren
suffix:semicolon
id|list_for_each_safe
c_func
(paren
id|tmp
comma
id|tmp1
comma
op_amp
id|pTcon-&gt;openFileList
)paren
(brace
id|open_file
op_assign
id|list_entry
c_func
(paren
id|tmp
comma
r_struct
id|cifsFileInfo
comma
id|tlist
)paren
suffix:semicolon
r_if
c_cond
(paren
id|open_file
)paren
(brace
id|open_file-&gt;invalidHandle
op_assign
id|TRUE
suffix:semicolon
)brace
)brace
id|write_unlock
c_func
(paren
op_amp
id|GlobalSMBSeslock
)paren
suffix:semicolon
multiline_comment|/* BB Add call to invalidate_inodes(sb) for all superblocks mounted to this tcon */
)brace
r_static
r_int
DECL|function|small_smb_init
id|small_smb_init
c_func
(paren
r_int
id|smb_command
comma
r_int
id|wct
comma
r_struct
id|cifsTconInfo
op_star
id|tcon
comma
r_void
op_star
op_star
id|request_buf
multiline_comment|/* returned */
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* SMBs NegProt, SessSetup, uLogoff do not have tcon yet so&n;&t;   check for tcp and smb session status done differently&n;&t;   for those three - in the calling routine */
r_if
c_cond
(paren
id|tcon
)paren
(brace
r_if
c_cond
(paren
(paren
id|tcon-&gt;ses
)paren
op_logical_and
(paren
id|tcon-&gt;ses-&gt;server
)paren
)paren
(brace
r_struct
id|nls_table
op_star
id|nls_codepage
suffix:semicolon
multiline_comment|/* Give Demultiplex thread up to 10 seconds to &n;&t;&t;&t;&t;&t;reconnect, should be greater than cifs socket&n;&t;&t;&t;&t;&t;timeout which is 7 seconds */
r_while
c_loop
(paren
id|tcon-&gt;ses-&gt;server-&gt;tcpStatus
op_eq
id|CifsNeedReconnect
)paren
(brace
id|wait_event_interruptible_timeout
c_func
(paren
id|tcon-&gt;ses-&gt;server-&gt;response_q
comma
(paren
id|tcon-&gt;ses-&gt;server-&gt;tcpStatus
op_eq
id|CifsGood
)paren
comma
l_int|10
op_star
id|HZ
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tcon-&gt;ses-&gt;server-&gt;tcpStatus
op_eq
id|CifsNeedReconnect
)paren
(brace
multiline_comment|/* on &quot;soft&quot; mounts we wait once */
r_if
c_cond
(paren
(paren
id|tcon-&gt;retry
op_eq
id|FALSE
)paren
op_logical_or
(paren
id|tcon-&gt;ses-&gt;status
op_eq
id|CifsExiting
)paren
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;gave up waiting on reconnect in smb_init&quot;
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EHOSTDOWN
suffix:semicolon
)brace
multiline_comment|/* else &quot;hard&quot; mount - keep retrying until &n;&t;&t;&t;&t;&t;process is killed or server comes back up */
)brace
r_else
multiline_comment|/* TCP session is reestablished now */
r_break
suffix:semicolon
)brace
id|nls_codepage
op_assign
id|load_nls_default
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* need to prevent multiple threads trying to&n;&t;&t;simultaneously reconnect the same SMB session */
id|down
c_func
(paren
op_amp
id|tcon-&gt;ses-&gt;sesSem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tcon-&gt;ses-&gt;status
op_eq
id|CifsNeedReconnect
)paren
(brace
id|rc
op_assign
id|cifs_setup_session
c_func
(paren
l_int|0
comma
id|tcon-&gt;ses
comma
id|nls_codepage
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|rc
op_logical_and
(paren
id|tcon-&gt;tidStatus
op_eq
id|CifsNeedReconnect
)paren
)paren
(brace
id|mark_open_files_invalid
c_func
(paren
id|tcon
)paren
suffix:semicolon
id|rc
op_assign
id|CIFSTCon
c_func
(paren
l_int|0
comma
id|tcon-&gt;ses
comma
id|tcon-&gt;treeName
comma
id|tcon
comma
id|nls_codepage
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|tcon-&gt;ses-&gt;sesSem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
)paren
(brace
id|atomic_inc
c_func
(paren
op_amp
id|tconInfoReconnectCount
)paren
suffix:semicolon
)brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;reconnect tcon rc = %d&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
multiline_comment|/* Removed call to reopen open files here - &n;&t;&t;&t;&t;&t;it is safer (and faster) to reopen files&n;&t;&t;&t;&t;&t;one at a time as needed in read and write */
multiline_comment|/* Check if handle based operation so we &n;&t;&t;&t;&t;&t;know whether we can continue or not without&n;&t;&t;&t;&t;&t;returning to caller to reset file handle */
r_switch
c_cond
(paren
id|smb_command
)paren
(brace
r_case
id|SMB_COM_READ_ANDX
suffix:colon
r_case
id|SMB_COM_WRITE_ANDX
suffix:colon
r_case
id|SMB_COM_CLOSE
suffix:colon
r_case
id|SMB_COM_FIND_CLOSE2
suffix:colon
r_case
id|SMB_COM_LOCKING_ANDX
suffix:colon
(brace
id|unload_nls
c_func
(paren
id|nls_codepage
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
id|up
c_func
(paren
op_amp
id|tcon-&gt;ses-&gt;sesSem
)paren
suffix:semicolon
)brace
id|unload_nls
c_func
(paren
id|nls_codepage
)paren
suffix:semicolon
)brace
r_else
(brace
r_return
op_minus
id|EIO
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|rc
)paren
(brace
r_return
id|rc
suffix:semicolon
)brace
op_star
id|request_buf
op_assign
id|cifs_small_buf_get
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|request_buf
op_eq
l_int|0
)paren
(brace
multiline_comment|/* BB should we add a retry in here if not a writepage? */
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|header_assemble
c_func
(paren
(paren
r_struct
id|smb_hdr
op_star
)paren
op_star
id|request_buf
comma
id|smb_command
comma
id|tcon
comma
id|wct
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_CIFS_STATS
r_if
c_cond
(paren
id|tcon
op_ne
l_int|NULL
)paren
(brace
id|atomic_inc
c_func
(paren
op_amp
id|tcon-&gt;num_smbs_sent
)paren
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_CIFS_STATS */
r_return
id|rc
suffix:semicolon
)brace
r_static
r_int
DECL|function|smb_init
id|smb_init
c_func
(paren
r_int
id|smb_command
comma
r_int
id|wct
comma
r_struct
id|cifsTconInfo
op_star
id|tcon
comma
r_void
op_star
op_star
id|request_buf
multiline_comment|/* returned */
comma
r_void
op_star
op_star
id|response_buf
multiline_comment|/* returned */
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* SMBs NegProt, SessSetup, uLogoff do not have tcon yet so&n;&t;   check for tcp and smb session status done differently&n;&t;   for those three - in the calling routine */
r_if
c_cond
(paren
id|tcon
)paren
(brace
r_if
c_cond
(paren
(paren
id|tcon-&gt;ses
)paren
op_logical_and
(paren
id|tcon-&gt;ses-&gt;server
)paren
)paren
(brace
r_struct
id|nls_table
op_star
id|nls_codepage
suffix:semicolon
multiline_comment|/* Give Demultiplex thread up to 10 seconds to &n;&t;&t;&t;&t;&t;reconnect, should be greater than cifs socket&n;&t;&t;&t;&t;&t;timeout which is 7 seconds */
r_while
c_loop
(paren
id|tcon-&gt;ses-&gt;server-&gt;tcpStatus
op_eq
id|CifsNeedReconnect
)paren
(brace
id|wait_event_interruptible_timeout
c_func
(paren
id|tcon-&gt;ses-&gt;server-&gt;response_q
comma
(paren
id|tcon-&gt;ses-&gt;server-&gt;tcpStatus
op_eq
id|CifsGood
)paren
comma
l_int|10
op_star
id|HZ
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tcon-&gt;ses-&gt;server-&gt;tcpStatus
op_eq
id|CifsNeedReconnect
)paren
(brace
multiline_comment|/* on &quot;soft&quot; mounts we wait once */
r_if
c_cond
(paren
(paren
id|tcon-&gt;retry
op_eq
id|FALSE
)paren
op_logical_or
(paren
id|tcon-&gt;ses-&gt;status
op_eq
id|CifsExiting
)paren
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;gave up waiting on reconnect in smb_init&quot;
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EHOSTDOWN
suffix:semicolon
)brace
multiline_comment|/* else &quot;hard&quot; mount - keep retrying until &n;&t;&t;&t;&t;&t;process is killed or server comes back up */
)brace
r_else
multiline_comment|/* TCP session is reestablished now */
r_break
suffix:semicolon
)brace
id|nls_codepage
op_assign
id|load_nls_default
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* need to prevent multiple threads trying to&n;&t;&t;simultaneously reconnect the same SMB session */
id|down
c_func
(paren
op_amp
id|tcon-&gt;ses-&gt;sesSem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tcon-&gt;ses-&gt;status
op_eq
id|CifsNeedReconnect
)paren
(brace
id|rc
op_assign
id|cifs_setup_session
c_func
(paren
l_int|0
comma
id|tcon-&gt;ses
comma
id|nls_codepage
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|rc
op_logical_and
(paren
id|tcon-&gt;tidStatus
op_eq
id|CifsNeedReconnect
)paren
)paren
(brace
id|mark_open_files_invalid
c_func
(paren
id|tcon
)paren
suffix:semicolon
id|rc
op_assign
id|CIFSTCon
c_func
(paren
l_int|0
comma
id|tcon-&gt;ses
comma
id|tcon-&gt;treeName
comma
id|tcon
comma
id|nls_codepage
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|tcon-&gt;ses-&gt;sesSem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
)paren
(brace
id|atomic_inc
c_func
(paren
op_amp
id|tconInfoReconnectCount
)paren
suffix:semicolon
)brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;reconnect tcon rc = %d&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
multiline_comment|/* Removed call to reopen open files here - &n;&t;&t;&t;&t;&t;it is safer (and faster) to reopen files&n;&t;&t;&t;&t;&t;one at a time as needed in read and write */
multiline_comment|/* Check if handle based operation so we &n;&t;&t;&t;&t;&t;know whether we can continue or not without&n;&t;&t;&t;&t;&t;returning to caller to reset file handle */
r_switch
c_cond
(paren
id|smb_command
)paren
(brace
r_case
id|SMB_COM_READ_ANDX
suffix:colon
r_case
id|SMB_COM_WRITE_ANDX
suffix:colon
r_case
id|SMB_COM_CLOSE
suffix:colon
r_case
id|SMB_COM_FIND_CLOSE2
suffix:colon
r_case
id|SMB_COM_LOCKING_ANDX
suffix:colon
(brace
id|unload_nls
c_func
(paren
id|nls_codepage
)paren
suffix:semicolon
r_return
op_minus
id|EAGAIN
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
id|up
c_func
(paren
op_amp
id|tcon-&gt;ses-&gt;sesSem
)paren
suffix:semicolon
)brace
id|unload_nls
c_func
(paren
id|nls_codepage
)paren
suffix:semicolon
)brace
r_else
(brace
r_return
op_minus
id|EIO
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|rc
)paren
(brace
r_return
id|rc
suffix:semicolon
)brace
op_star
id|request_buf
op_assign
id|cifs_buf_get
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|request_buf
op_eq
l_int|0
)paren
(brace
multiline_comment|/* BB should we add a retry in here if not a writepage? */
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/* Although the original thought was we needed the response buf for  */
multiline_comment|/* potential retries of smb operations it turns out we can determine */
multiline_comment|/* from the mid flags when the request buffer can be resent without  */
multiline_comment|/* having to use a second distinct buffer for the response */
op_star
id|response_buf
op_assign
op_star
id|request_buf
suffix:semicolon
id|header_assemble
c_func
(paren
(paren
r_struct
id|smb_hdr
op_star
)paren
op_star
id|request_buf
comma
id|smb_command
comma
id|tcon
comma
id|wct
multiline_comment|/*wct */
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_CIFS_STATS
r_if
c_cond
(paren
id|tcon
op_ne
l_int|NULL
)paren
(brace
id|atomic_inc
c_func
(paren
op_amp
id|tcon-&gt;num_smbs_sent
)paren
suffix:semicolon
)brace
macro_line|#endif /* CONFIG_CIFS_STATS */
r_return
id|rc
suffix:semicolon
)brace
DECL|function|validate_t2
r_static
r_int
id|validate_t2
c_func
(paren
r_struct
id|smb_t2_rsp
op_star
id|pSMB
)paren
(brace
r_int
id|rc
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_int
id|total_size
suffix:semicolon
r_char
op_star
id|pBCC
suffix:semicolon
multiline_comment|/* check for plausible wct, bcc and t2 data and parm sizes */
multiline_comment|/* check for parm and data offset going beyond end of smb */
r_if
c_cond
(paren
id|pSMB-&gt;hdr.WordCount
op_ge
l_int|10
)paren
(brace
r_if
c_cond
(paren
(paren
id|le16_to_cpu
c_func
(paren
id|pSMB-&gt;t2_rsp.ParameterOffset
)paren
op_le
l_int|1024
)paren
op_logical_and
(paren
id|le16_to_cpu
c_func
(paren
id|pSMB-&gt;t2_rsp.DataOffset
)paren
op_le
l_int|1024
)paren
)paren
(brace
multiline_comment|/* check that bcc is at least as big as parms + data */
multiline_comment|/* check that bcc is less than negotiated smb buffer */
id|total_size
op_assign
id|le16_to_cpu
c_func
(paren
id|pSMB-&gt;t2_rsp.ParameterCount
)paren
suffix:semicolon
r_if
c_cond
(paren
id|total_size
OL
l_int|512
)paren
(brace
id|total_size
op_add_assign
id|le16_to_cpu
c_func
(paren
id|pSMB-&gt;t2_rsp.DataCount
)paren
suffix:semicolon
multiline_comment|/* BCC le converted in SendReceive */
id|pBCC
op_assign
(paren
id|pSMB-&gt;hdr.WordCount
op_star
l_int|2
)paren
op_plus
r_sizeof
(paren
r_struct
id|smb_hdr
)paren
op_plus
(paren
r_char
op_star
)paren
id|pSMB
suffix:semicolon
r_if
c_cond
(paren
(paren
id|total_size
op_le
(paren
op_star
(paren
id|u16
op_star
)paren
id|pBCC
)paren
)paren
op_logical_and
(paren
id|total_size
OL
id|CIFS_MAX_MSGSIZE
op_plus
id|MAX_CIFS_HDR_SIZE
)paren
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
)brace
)brace
)brace
id|cifs_dump_mem
c_func
(paren
l_string|&quot;Invalid transact2 SMB: &quot;
comma
(paren
r_char
op_star
)paren
id|pSMB
comma
r_sizeof
(paren
r_struct
id|smb_t2_rsp
)paren
op_plus
l_int|16
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_int
DECL|function|CIFSSMBNegotiate
id|CIFSSMBNegotiate
c_func
(paren
r_int
r_int
id|xid
comma
r_struct
id|cifsSesInfo
op_star
id|ses
)paren
(brace
id|NEGOTIATE_REQ
op_star
id|pSMB
suffix:semicolon
id|NEGOTIATE_RSP
op_star
id|pSMBr
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|bytes_returned
suffix:semicolon
r_struct
id|TCP_Server_Info
op_star
id|server
suffix:semicolon
id|u16
id|count
suffix:semicolon
r_if
c_cond
(paren
id|ses-&gt;server
)paren
(brace
id|server
op_assign
id|ses-&gt;server
suffix:semicolon
)brace
r_else
(brace
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|rc
op_assign
id|smb_init
c_func
(paren
id|SMB_COM_NEGOTIATE
comma
l_int|0
comma
l_int|NULL
multiline_comment|/* no tcon yet */
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMB
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMBr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
id|pSMB-&gt;hdr.Flags2
op_or_assign
id|SMBFLG2_UNICODE
suffix:semicolon
r_if
c_cond
(paren
id|extended_security
)paren
id|pSMB-&gt;hdr.Flags2
op_or_assign
id|SMBFLG2_EXT_SEC
suffix:semicolon
id|count
op_assign
id|strlen
c_func
(paren
id|protocols
(braket
l_int|0
)braket
dot
id|name
)paren
op_plus
l_int|1
suffix:semicolon
id|strncpy
c_func
(paren
id|pSMB-&gt;DialectsArray
comma
id|protocols
(braket
l_int|0
)braket
dot
id|name
comma
l_int|30
)paren
suffix:semicolon
multiline_comment|/* null guaranteed to be at end of source and target buffers anyway */
id|pSMB-&gt;hdr.smb_buf_length
op_add_assign
id|count
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
id|cpu_to_le16
c_func
(paren
id|count
)paren
suffix:semicolon
id|rc
op_assign
id|SendReceive
c_func
(paren
id|xid
comma
id|ses
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMB
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMBr
comma
op_amp
id|bytes_returned
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
)paren
(brace
id|server-&gt;secMode
op_assign
id|pSMBr-&gt;SecurityMode
suffix:semicolon
id|server-&gt;secType
op_assign
id|NTLM
suffix:semicolon
multiline_comment|/* BB override default for NTLMv2 or krb*/
multiline_comment|/* one byte - no need to convert this or EncryptionKeyLen from le,*/
id|server-&gt;maxReq
op_assign
id|le16_to_cpu
c_func
(paren
id|pSMBr-&gt;MaxMpxCount
)paren
suffix:semicolon
multiline_comment|/* probably no need to store and check maxvcs */
id|server-&gt;maxBuf
op_assign
id|min
c_func
(paren
id|le32_to_cpu
c_func
(paren
id|pSMBr-&gt;MaxBufferSize
)paren
comma
(paren
id|__u32
)paren
id|CIFS_MAX_MSGSIZE
op_plus
id|MAX_CIFS_HDR_SIZE
)paren
suffix:semicolon
id|server-&gt;maxRw
op_assign
id|le32_to_cpu
c_func
(paren
id|pSMBr-&gt;MaxRawSize
)paren
suffix:semicolon
id|cFYI
c_func
(paren
l_int|0
comma
(paren
l_string|&quot;Max buf = %d &quot;
comma
id|ses-&gt;server-&gt;maxBuf
)paren
)paren
suffix:semicolon
id|GETU32
c_func
(paren
id|ses-&gt;server-&gt;sessid
)paren
op_assign
id|le32_to_cpu
c_func
(paren
id|pSMBr-&gt;SessionKey
)paren
suffix:semicolon
id|server-&gt;capabilities
op_assign
id|le32_to_cpu
c_func
(paren
id|pSMBr-&gt;Capabilities
)paren
suffix:semicolon
id|server-&gt;timeZone
op_assign
id|le16_to_cpu
c_func
(paren
id|pSMBr-&gt;ServerTimeZone
)paren
suffix:semicolon
multiline_comment|/* BB with UTC do we ever need to be using srvr timezone? */
r_if
c_cond
(paren
id|pSMBr-&gt;EncryptionKeyLength
op_eq
id|CIFS_CRYPTO_KEY_SIZE
)paren
(brace
id|memcpy
c_func
(paren
id|server-&gt;cryptKey
comma
id|pSMBr-&gt;u.EncryptionKey
comma
id|CIFS_CRYPTO_KEY_SIZE
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|pSMBr-&gt;hdr.Flags2
op_amp
id|SMBFLG2_EXT_SEC
)paren
op_logical_and
(paren
id|pSMBr-&gt;EncryptionKeyLength
op_eq
l_int|0
)paren
)paren
(brace
multiline_comment|/* decode security blob */
)brace
r_else
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
multiline_comment|/* BB might be helpful to save off the domain of server here */
r_if
c_cond
(paren
(paren
id|pSMBr-&gt;hdr.Flags2
op_amp
id|SMBFLG2_EXT_SEC
)paren
op_logical_and
(paren
id|server-&gt;capabilities
op_amp
id|CAP_EXTENDED_SECURITY
)paren
)paren
(brace
id|count
op_assign
id|pSMBr-&gt;ByteCount
suffix:semicolon
r_if
c_cond
(paren
id|count
OL
l_int|16
)paren
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
r_else
r_if
c_cond
(paren
id|count
op_eq
l_int|16
)paren
(brace
id|server-&gt;secType
op_assign
id|RawNTLMSSP
suffix:semicolon
r_if
c_cond
(paren
id|server-&gt;socketUseCount.counter
OG
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|memcmp
(paren
id|server-&gt;server_GUID
comma
id|pSMBr-&gt;u.extended_response
dot
id|GUID
comma
l_int|16
)paren
op_ne
l_int|0
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;UID of server does not match previous connection to same ip address&quot;
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|server
op_member_access_from_pointer
id|server_GUID
comma
id|pSMBr-&gt;u
dot
id|extended_response
dot
id|GUID
comma
l_int|16
)paren
suffix:semicolon
)brace
)brace
r_else
id|memcpy
c_func
(paren
id|server-&gt;server_GUID
comma
id|pSMBr-&gt;u.extended_response
dot
id|GUID
comma
l_int|16
)paren
suffix:semicolon
)brace
r_else
(brace
id|rc
op_assign
id|decode_negTokenInit
c_func
(paren
id|pSMBr-&gt;u
dot
id|extended_response
dot
id|SecurityBlob
comma
id|count
op_minus
l_int|16
comma
op_amp
id|server-&gt;secType
)paren
suffix:semicolon
)brace
)brace
r_else
id|server-&gt;capabilities
op_and_assign
op_complement
id|CAP_EXTENDED_SECURITY
suffix:semicolon
r_if
c_cond
(paren
id|sign_CIFS_PDUs
op_eq
id|FALSE
)paren
(brace
r_if
c_cond
(paren
id|server-&gt;secMode
op_amp
id|SECMODE_SIGN_REQUIRED
)paren
(brace
id|cERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Server requires /proc/fs/cifs/PacketSigningEnabled&quot;
)paren
)paren
suffix:semicolon
)brace
id|server-&gt;secMode
op_and_assign
op_complement
(paren
id|SECMODE_SIGN_ENABLED
op_or
id|SECMODE_SIGN_REQUIRED
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|sign_CIFS_PDUs
op_eq
l_int|1
)paren
(brace
r_if
c_cond
(paren
(paren
id|server-&gt;secMode
op_amp
id|SECMODE_SIGN_REQUIRED
)paren
op_eq
l_int|0
)paren
(brace
id|server-&gt;secMode
op_and_assign
op_complement
(paren
id|SECMODE_SIGN_ENABLED
op_or
id|SECMODE_SIGN_REQUIRED
)paren
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|pSMB
)paren
id|cifs_buf_release
c_func
(paren
id|pSMB
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_int
DECL|function|CIFSSMBTDis
id|CIFSSMBTDis
c_func
(paren
r_const
r_int
id|xid
comma
r_struct
id|cifsTconInfo
op_star
id|tcon
)paren
(brace
r_struct
id|smb_hdr
op_star
id|smb_buffer
suffix:semicolon
r_struct
id|smb_hdr
op_star
id|smb_buffer_response
suffix:semicolon
multiline_comment|/* BB removeme BB */
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|length
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;In tree disconnect&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *  If last user of the connection and&n;&t; *  connection alive - disconnect it&n;&t; *  If this is the last connection on the server session disconnect it&n;&t; *  (and inside session disconnect we should check if tcp socket needs &n;&t; *  to be freed and kernel thread woken up).&n;&t; */
r_if
c_cond
(paren
id|tcon
)paren
id|down
c_func
(paren
op_amp
id|tcon-&gt;tconSem
)paren
suffix:semicolon
r_else
r_return
op_minus
id|EIO
suffix:semicolon
id|atomic_dec
c_func
(paren
op_amp
id|tcon-&gt;useCount
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|tcon-&gt;useCount
)paren
OG
l_int|0
)paren
(brace
id|up
c_func
(paren
op_amp
id|tcon-&gt;tconSem
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
multiline_comment|/* No need to return error on this operation if tid invalidated and &n;&t;closed on server already e.g. due to tcp session crashing */
r_if
c_cond
(paren
id|tcon-&gt;tidStatus
op_eq
id|CifsNeedReconnect
)paren
(brace
id|up
c_func
(paren
op_amp
id|tcon-&gt;tconSem
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|tcon-&gt;ses
op_eq
l_int|0
)paren
op_logical_or
(paren
id|tcon-&gt;ses-&gt;server
op_eq
l_int|0
)paren
)paren
(brace
id|up
c_func
(paren
op_amp
id|tcon-&gt;tconSem
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|rc
op_assign
id|small_smb_init
c_func
(paren
id|SMB_COM_TREE_DISCONNECT
comma
l_int|0
comma
id|tcon
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|smb_buffer
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|up
c_func
(paren
op_amp
id|tcon-&gt;tconSem
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_else
(brace
id|smb_buffer_response
op_assign
id|smb_buffer
suffix:semicolon
multiline_comment|/* BB removeme BB */
)brace
id|rc
op_assign
id|SendReceive
c_func
(paren
id|xid
comma
id|tcon-&gt;ses
comma
id|smb_buffer
comma
id|smb_buffer_response
comma
op_amp
id|length
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot; Tree disconnect failed %d&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|smb_buffer
)paren
id|cifs_small_buf_release
c_func
(paren
id|smb_buffer
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|tcon-&gt;tconSem
)paren
suffix:semicolon
multiline_comment|/* No need to return error on this operation if tid invalidated and &n;&t;closed on server already e.g. due to tcp session crashing */
r_if
c_cond
(paren
id|rc
op_eq
op_minus
id|EAGAIN
)paren
id|rc
op_assign
l_int|0
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_int
DECL|function|CIFSSMBLogoff
id|CIFSSMBLogoff
c_func
(paren
r_const
r_int
id|xid
comma
r_struct
id|cifsSesInfo
op_star
id|ses
)paren
(brace
r_struct
id|smb_hdr
op_star
id|smb_buffer_response
suffix:semicolon
id|LOGOFF_ANDX_REQ
op_star
id|pSMB
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|length
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;In SMBLogoff for session disconnect&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ses
)paren
id|down
c_func
(paren
op_amp
id|ses-&gt;sesSem
)paren
suffix:semicolon
r_else
r_return
op_minus
id|EIO
suffix:semicolon
id|atomic_dec
c_func
(paren
op_amp
id|ses-&gt;inUse
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|ses-&gt;inUse
)paren
OG
l_int|0
)paren
(brace
id|up
c_func
(paren
op_amp
id|ses-&gt;sesSem
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
id|rc
op_assign
id|small_smb_init
c_func
(paren
id|SMB_COM_LOGOFF_ANDX
comma
l_int|2
comma
l_int|NULL
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMB
)paren
suffix:semicolon
id|smb_buffer_response
op_assign
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMB
suffix:semicolon
multiline_comment|/* BB removeme BB */
r_if
c_cond
(paren
id|ses-&gt;server
)paren
(brace
r_if
c_cond
(paren
id|ses-&gt;server-&gt;secMode
op_amp
(paren
id|SECMODE_SIGN_REQUIRED
op_or
id|SECMODE_SIGN_ENABLED
)paren
)paren
(brace
id|pSMB-&gt;hdr.Flags2
op_or_assign
id|SMBFLG2_SECURITY_SIGNATURE
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|rc
)paren
(brace
id|up
c_func
(paren
op_amp
id|ses-&gt;sesSem
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|pSMB-&gt;hdr.Uid
op_assign
id|ses-&gt;Suid
suffix:semicolon
id|pSMB-&gt;AndXCommand
op_assign
l_int|0xFF
suffix:semicolon
id|rc
op_assign
id|SendReceive
c_func
(paren
id|xid
comma
id|ses
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMB
comma
id|smb_buffer_response
comma
op_amp
id|length
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ses-&gt;server
)paren
(brace
id|atomic_dec
c_func
(paren
op_amp
id|ses-&gt;server-&gt;socketUseCount
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|ses-&gt;server-&gt;socketUseCount
)paren
op_eq
l_int|0
)paren
(brace
id|spin_lock
c_func
(paren
op_amp
id|GlobalMid_Lock
)paren
suffix:semicolon
id|ses-&gt;server-&gt;tcpStatus
op_assign
id|CifsExiting
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|GlobalMid_Lock
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|ESHUTDOWN
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|pSMB
)paren
id|cifs_small_buf_release
c_func
(paren
id|pSMB
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|ses-&gt;sesSem
)paren
suffix:semicolon
multiline_comment|/* if session dead then we do not need to do ulogoff,&n;&t;&t;since server closed smb session, no sense reporting &n;&t;&t;error */
r_if
c_cond
(paren
id|rc
op_eq
op_minus
id|EAGAIN
)paren
id|rc
op_assign
l_int|0
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_int
DECL|function|CIFSSMBDelFile
id|CIFSSMBDelFile
c_func
(paren
r_const
r_int
id|xid
comma
r_struct
id|cifsTconInfo
op_star
id|tcon
comma
r_const
r_char
op_star
id|fileName
comma
r_const
r_struct
id|nls_table
op_star
id|nls_codepage
)paren
(brace
id|DELETE_FILE_REQ
op_star
id|pSMB
op_assign
l_int|NULL
suffix:semicolon
id|DELETE_FILE_RSP
op_star
id|pSMBr
op_assign
l_int|NULL
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|bytes_returned
suffix:semicolon
r_int
id|name_len
suffix:semicolon
id|DelFileRetry
suffix:colon
id|rc
op_assign
id|smb_init
c_func
(paren
id|SMB_COM_DELETE
comma
l_int|1
comma
id|tcon
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMB
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMBr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|pSMB-&gt;hdr.Flags2
op_amp
id|SMBFLG2_UNICODE
)paren
(brace
id|name_len
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|pSMB-&gt;fileName
comma
id|fileName
comma
l_int|530
multiline_comment|/* find define for this maxpathcomponent */
comma
id|nls_codepage
)paren
suffix:semicolon
id|name_len
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|name_len
op_mul_assign
l_int|2
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* BB improve the check for buffer overruns BB */
id|name_len
op_assign
id|strnlen
c_func
(paren
id|fileName
comma
l_int|530
)paren
suffix:semicolon
id|name_len
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|strncpy
c_func
(paren
id|pSMB-&gt;fileName
comma
id|fileName
comma
id|name_len
)paren
suffix:semicolon
)brace
id|pSMB-&gt;SearchAttributes
op_assign
id|cpu_to_le16
c_func
(paren
id|ATTR_READONLY
op_or
id|ATTR_HIDDEN
op_or
id|ATTR_SYSTEM
)paren
suffix:semicolon
id|pSMB-&gt;BufferFormat
op_assign
l_int|0x04
suffix:semicolon
id|pSMB-&gt;hdr.smb_buf_length
op_add_assign
id|name_len
op_plus
l_int|1
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
id|cpu_to_le16
c_func
(paren
id|name_len
op_plus
l_int|1
)paren
suffix:semicolon
id|rc
op_assign
id|SendReceive
c_func
(paren
id|xid
comma
id|tcon-&gt;ses
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMB
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMBr
comma
op_amp
id|bytes_returned
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Error in RMFile = %d&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_CIFS_STATS
r_else
(brace
id|atomic_inc
c_func
(paren
op_amp
id|tcon-&gt;num_deletes
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|pSMB
)paren
id|cifs_buf_release
c_func
(paren
id|pSMB
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
op_minus
id|EAGAIN
)paren
r_goto
id|DelFileRetry
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_int
DECL|function|CIFSSMBRmDir
id|CIFSSMBRmDir
c_func
(paren
r_const
r_int
id|xid
comma
r_struct
id|cifsTconInfo
op_star
id|tcon
comma
r_const
r_char
op_star
id|dirName
comma
r_const
r_struct
id|nls_table
op_star
id|nls_codepage
)paren
(brace
id|DELETE_DIRECTORY_REQ
op_star
id|pSMB
op_assign
l_int|NULL
suffix:semicolon
id|DELETE_DIRECTORY_RSP
op_star
id|pSMBr
op_assign
l_int|NULL
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|bytes_returned
suffix:semicolon
r_int
id|name_len
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;In CIFSSMBRmDir&quot;
)paren
)paren
suffix:semicolon
id|RmDirRetry
suffix:colon
id|rc
op_assign
id|smb_init
c_func
(paren
id|SMB_COM_DELETE_DIRECTORY
comma
l_int|0
comma
id|tcon
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMB
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMBr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|pSMB-&gt;hdr.Flags2
op_amp
id|SMBFLG2_UNICODE
)paren
(brace
id|name_len
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|pSMB-&gt;DirName
comma
id|dirName
comma
l_int|530
multiline_comment|/* find define for this maxpathcomponent */
comma
id|nls_codepage
)paren
suffix:semicolon
id|name_len
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|name_len
op_mul_assign
l_int|2
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* BB improve the check for buffer overruns BB */
id|name_len
op_assign
id|strnlen
c_func
(paren
id|dirName
comma
l_int|530
)paren
suffix:semicolon
id|name_len
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|strncpy
c_func
(paren
id|pSMB-&gt;DirName
comma
id|dirName
comma
id|name_len
)paren
suffix:semicolon
)brace
id|pSMB-&gt;BufferFormat
op_assign
l_int|0x04
suffix:semicolon
id|pSMB-&gt;hdr.smb_buf_length
op_add_assign
id|name_len
op_plus
l_int|1
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
id|cpu_to_le16
c_func
(paren
id|name_len
op_plus
l_int|1
)paren
suffix:semicolon
id|rc
op_assign
id|SendReceive
c_func
(paren
id|xid
comma
id|tcon-&gt;ses
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMB
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMBr
comma
op_amp
id|bytes_returned
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Error in RMDir = %d&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_CIFS_STATS
r_else
(brace
id|atomic_inc
c_func
(paren
op_amp
id|tcon-&gt;num_rmdirs
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|pSMB
)paren
id|cifs_buf_release
c_func
(paren
id|pSMB
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
op_minus
id|EAGAIN
)paren
r_goto
id|RmDirRetry
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_int
DECL|function|CIFSSMBMkDir
id|CIFSSMBMkDir
c_func
(paren
r_const
r_int
id|xid
comma
r_struct
id|cifsTconInfo
op_star
id|tcon
comma
r_const
r_char
op_star
id|name
comma
r_const
r_struct
id|nls_table
op_star
id|nls_codepage
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|CREATE_DIRECTORY_REQ
op_star
id|pSMB
op_assign
l_int|NULL
suffix:semicolon
id|CREATE_DIRECTORY_RSP
op_star
id|pSMBr
op_assign
l_int|NULL
suffix:semicolon
r_int
id|bytes_returned
suffix:semicolon
r_int
id|name_len
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;In CIFSSMBMkDir&quot;
)paren
)paren
suffix:semicolon
id|MkDirRetry
suffix:colon
id|rc
op_assign
id|smb_init
c_func
(paren
id|SMB_COM_CREATE_DIRECTORY
comma
l_int|0
comma
id|tcon
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMB
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMBr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|pSMB-&gt;hdr.Flags2
op_amp
id|SMBFLG2_UNICODE
)paren
(brace
id|name_len
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|pSMB-&gt;DirName
comma
id|name
comma
l_int|530
multiline_comment|/* find define for this maxpathcomponent */
comma
id|nls_codepage
)paren
suffix:semicolon
id|name_len
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|name_len
op_mul_assign
l_int|2
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* BB improve the check for buffer overruns BB */
id|name_len
op_assign
id|strnlen
c_func
(paren
id|name
comma
l_int|530
)paren
suffix:semicolon
id|name_len
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|strncpy
c_func
(paren
id|pSMB-&gt;DirName
comma
id|name
comma
id|name_len
)paren
suffix:semicolon
)brace
id|pSMB-&gt;BufferFormat
op_assign
l_int|0x04
suffix:semicolon
id|pSMB-&gt;hdr.smb_buf_length
op_add_assign
id|name_len
op_plus
l_int|1
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
id|cpu_to_le16
c_func
(paren
id|name_len
op_plus
l_int|1
)paren
suffix:semicolon
id|rc
op_assign
id|SendReceive
c_func
(paren
id|xid
comma
id|tcon-&gt;ses
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMB
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMBr
comma
op_amp
id|bytes_returned
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Error in Mkdir = %d&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_CIFS_STATS
r_else
(brace
id|atomic_inc
c_func
(paren
op_amp
id|tcon-&gt;num_mkdirs
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|pSMB
)paren
id|cifs_buf_release
c_func
(paren
id|pSMB
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
op_minus
id|EAGAIN
)paren
r_goto
id|MkDirRetry
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_int
DECL|function|CIFSSMBOpen
id|CIFSSMBOpen
c_func
(paren
r_const
r_int
id|xid
comma
r_struct
id|cifsTconInfo
op_star
id|tcon
comma
r_const
r_char
op_star
id|fileName
comma
r_const
r_int
id|openDisposition
comma
r_const
r_int
id|access_flags
comma
r_const
r_int
id|create_options
comma
id|__u16
op_star
id|netfid
comma
r_int
op_star
id|pOplock
comma
id|FILE_ALL_INFO
op_star
id|pfile_info
comma
r_const
r_struct
id|nls_table
op_star
id|nls_codepage
)paren
(brace
r_int
id|rc
op_assign
op_minus
id|EACCES
suffix:semicolon
id|OPEN_REQ
op_star
id|pSMB
op_assign
l_int|NULL
suffix:semicolon
id|OPEN_RSP
op_star
id|pSMBr
op_assign
l_int|NULL
suffix:semicolon
r_int
id|bytes_returned
suffix:semicolon
r_int
id|name_len
suffix:semicolon
id|__u16
id|count
suffix:semicolon
id|openRetry
suffix:colon
id|rc
op_assign
id|smb_init
c_func
(paren
id|SMB_COM_NT_CREATE_ANDX
comma
l_int|24
comma
id|tcon
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMB
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMBr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
id|pSMB-&gt;AndXCommand
op_assign
l_int|0xFF
suffix:semicolon
multiline_comment|/* none */
r_if
c_cond
(paren
id|pSMB-&gt;hdr.Flags2
op_amp
id|SMBFLG2_UNICODE
)paren
(brace
id|count
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* account for one byte pad to word boundary */
id|name_len
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
(paren
id|pSMB-&gt;fileName
op_plus
l_int|1
)paren
comma
id|fileName
comma
l_int|530
multiline_comment|/* find define for this maxpathcomponent */
comma
id|nls_codepage
)paren
suffix:semicolon
id|name_len
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|name_len
op_mul_assign
l_int|2
suffix:semicolon
id|pSMB-&gt;NameLength
op_assign
id|cpu_to_le16
c_func
(paren
id|name_len
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* BB improve the check for buffer overruns BB */
id|count
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* no pad */
id|name_len
op_assign
id|strnlen
c_func
(paren
id|fileName
comma
l_int|530
)paren
suffix:semicolon
id|name_len
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|pSMB-&gt;NameLength
op_assign
id|cpu_to_le16
c_func
(paren
id|name_len
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|pSMB-&gt;fileName
comma
id|fileName
comma
id|name_len
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_star
id|pOplock
op_amp
id|REQ_OPLOCK
)paren
id|pSMB-&gt;OpenFlags
op_assign
id|cpu_to_le32
c_func
(paren
id|REQ_OPLOCK
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
op_star
id|pOplock
op_amp
id|REQ_BATCHOPLOCK
)paren
(brace
id|pSMB-&gt;OpenFlags
op_assign
id|cpu_to_le32
c_func
(paren
id|REQ_BATCHOPLOCK
)paren
suffix:semicolon
)brace
id|pSMB-&gt;DesiredAccess
op_assign
id|cpu_to_le32
c_func
(paren
id|access_flags
)paren
suffix:semicolon
id|pSMB-&gt;AllocationSize
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;FileAttributes
op_assign
id|cpu_to_le32
c_func
(paren
id|ATTR_NORMAL
)paren
suffix:semicolon
multiline_comment|/* XP does not handle ATTR_POSIX_SEMANTICS */
multiline_comment|/* but it helps speed up case sensitive checks for other&n;&t;servers such as Samba */
r_if
c_cond
(paren
id|tcon-&gt;ses-&gt;capabilities
op_amp
id|CAP_UNIX
)paren
id|pSMB-&gt;FileAttributes
op_or_assign
id|cpu_to_le32
c_func
(paren
id|ATTR_POSIX_SEMANTICS
)paren
suffix:semicolon
multiline_comment|/* if ((omode &amp; S_IWUGO) == 0)&n;&t;&t;pSMB-&gt;FileAttributes |= cpu_to_le32(ATTR_READONLY);*/
multiline_comment|/*  Above line causes problems due to vfs splitting create into two&n;&t;&t;pieces - need to set mode after file created not while it is&n;&t;&t;being created */
id|pSMB-&gt;ShareAccess
op_assign
id|cpu_to_le32
c_func
(paren
id|FILE_SHARE_ALL
)paren
suffix:semicolon
id|pSMB-&gt;CreateDisposition
op_assign
id|cpu_to_le32
c_func
(paren
id|openDisposition
)paren
suffix:semicolon
id|pSMB-&gt;CreateOptions
op_assign
id|cpu_to_le32
c_func
(paren
id|create_options
)paren
suffix:semicolon
id|pSMB-&gt;ImpersonationLevel
op_assign
id|cpu_to_le32
c_func
(paren
id|SECURITY_IMPERSONATION
)paren
suffix:semicolon
multiline_comment|/* BB ??*/
id|pSMB-&gt;SecurityFlags
op_assign
id|SECURITY_CONTEXT_TRACKING
op_or
id|SECURITY_EFFECTIVE_ONLY
suffix:semicolon
id|count
op_add_assign
id|name_len
suffix:semicolon
id|pSMB-&gt;hdr.smb_buf_length
op_add_assign
id|count
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
id|cpu_to_le16
c_func
(paren
id|count
)paren
suffix:semicolon
multiline_comment|/* long_op set to 1 to allow for oplock break timeouts */
id|rc
op_assign
id|SendReceive
c_func
(paren
id|xid
comma
id|tcon-&gt;ses
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMB
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMBr
comma
op_amp
id|bytes_returned
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Error in Open = %d&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
op_star
id|pOplock
op_assign
id|pSMBr-&gt;OplockLevel
suffix:semicolon
multiline_comment|/* one byte no need to le_to_cpu */
op_star
id|netfid
op_assign
id|pSMBr-&gt;Fid
suffix:semicolon
multiline_comment|/* cifs fid stays in le */
multiline_comment|/* Let caller know file was created so we can set the mode. */
multiline_comment|/* Do we care about the CreateAction in any other cases? */
r_if
c_cond
(paren
id|cpu_to_le32
c_func
(paren
id|FILE_CREATE
)paren
op_eq
id|pSMBr-&gt;CreateAction
)paren
(brace
op_star
id|pOplock
op_or_assign
id|CIFS_CREATE_ACTION
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pfile_info
)paren
(brace
id|memcpy
c_func
(paren
(paren
r_char
op_star
)paren
id|pfile_info
comma
(paren
r_char
op_star
)paren
op_amp
id|pSMBr-&gt;CreationTime
comma
l_int|36
multiline_comment|/* CreationTime to Attributes */
)paren
suffix:semicolon
multiline_comment|/* the file_info buf is endian converted by caller */
id|pfile_info-&gt;AllocationSize
op_assign
id|pSMBr-&gt;AllocationSize
suffix:semicolon
id|pfile_info-&gt;EndOfFile
op_assign
id|pSMBr-&gt;EndOfFile
suffix:semicolon
id|pfile_info-&gt;NumberOfLinks
op_assign
id|cpu_to_le32
c_func
(paren
l_int|1
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_CIFS_STATS
id|atomic_inc
c_func
(paren
op_amp
id|tcon-&gt;num_opens
)paren
suffix:semicolon
macro_line|#endif
)brace
r_if
c_cond
(paren
id|pSMB
)paren
id|cifs_buf_release
c_func
(paren
id|pSMB
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
op_minus
id|EAGAIN
)paren
r_goto
id|openRetry
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/* If no buffer passed in, then caller wants to do the copy&n;&t;as in the case of readpages so the SMB buffer must be&n;&t;freed by the caller */
r_int
DECL|function|CIFSSMBRead
id|CIFSSMBRead
c_func
(paren
r_const
r_int
id|xid
comma
r_struct
id|cifsTconInfo
op_star
id|tcon
comma
r_const
r_int
id|netfid
comma
r_const
r_int
r_int
id|count
comma
r_const
id|__u64
id|lseek
comma
r_int
r_int
op_star
id|nbytes
comma
r_char
op_star
op_star
id|buf
)paren
(brace
r_int
id|rc
op_assign
op_minus
id|EACCES
suffix:semicolon
id|READ_REQ
op_star
id|pSMB
op_assign
l_int|NULL
suffix:semicolon
id|READ_RSP
op_star
id|pSMBr
op_assign
l_int|NULL
suffix:semicolon
r_char
op_star
id|pReadData
op_assign
l_int|NULL
suffix:semicolon
r_int
id|bytes_returned
suffix:semicolon
op_star
id|nbytes
op_assign
l_int|0
suffix:semicolon
id|rc
op_assign
id|smb_init
c_func
(paren
id|SMB_COM_READ_ANDX
comma
l_int|12
comma
id|tcon
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMB
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMBr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
multiline_comment|/* tcon and ses pointer are checked in smb_init */
r_if
c_cond
(paren
id|tcon-&gt;ses-&gt;server
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ECONNABORTED
suffix:semicolon
id|pSMB-&gt;AndXCommand
op_assign
l_int|0xFF
suffix:semicolon
multiline_comment|/* none */
id|pSMB-&gt;Fid
op_assign
id|netfid
suffix:semicolon
id|pSMB-&gt;OffsetLow
op_assign
id|cpu_to_le32
c_func
(paren
id|lseek
op_amp
l_int|0xFFFFFFFF
)paren
suffix:semicolon
id|pSMB-&gt;OffsetHigh
op_assign
id|cpu_to_le32
c_func
(paren
id|lseek
op_rshift
l_int|32
)paren
suffix:semicolon
id|pSMB-&gt;Remaining
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;MaxCount
op_assign
id|cpu_to_le16
c_func
(paren
id|count
)paren
suffix:semicolon
id|pSMB-&gt;MaxCountHigh
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* no need to do le conversion since it is 0 */
id|rc
op_assign
id|SendReceive
c_func
(paren
id|xid
comma
id|tcon-&gt;ses
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMB
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMBr
comma
op_amp
id|bytes_returned
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|cERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Send error in read = %d&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|__u16
id|data_length
op_assign
id|le16_to_cpu
c_func
(paren
id|pSMBr-&gt;DataLength
)paren
suffix:semicolon
op_star
id|nbytes
op_assign
id|data_length
suffix:semicolon
multiline_comment|/*check that DataLength would not go beyond end of SMB */
r_if
c_cond
(paren
(paren
id|data_length
OG
id|CIFS_MAX_MSGSIZE
)paren
op_logical_or
(paren
id|data_length
OG
id|count
)paren
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;bad length %d for count %d&quot;
comma
id|data_length
comma
id|count
)paren
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
op_star
id|nbytes
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|pReadData
op_assign
(paren
r_char
op_star
)paren
(paren
op_amp
id|pSMBr-&gt;hdr.Protocol
)paren
op_plus
id|le16_to_cpu
c_func
(paren
id|pSMBr-&gt;DataOffset
)paren
suffix:semicolon
multiline_comment|/*&t;&t;&t;if(rc = copy_to_user(buf, pReadData, data_length)) {&n;&t;&t;&t;&t;cERROR(1,(&quot;Faulting on read rc = %d&quot;,rc));&n;&t;&t;&t;&t;rc = -EFAULT;&n;&t;&t;&t;}*/
multiline_comment|/* can not use copy_to_user when using page cache*/
r_if
c_cond
(paren
op_star
id|buf
)paren
(brace
id|memcpy
c_func
(paren
op_star
id|buf
comma
id|pReadData
comma
id|data_length
)paren
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|pSMB
)paren
(brace
r_if
c_cond
(paren
op_star
id|buf
)paren
(brace
id|cifs_buf_release
c_func
(paren
id|pSMB
)paren
suffix:semicolon
)brace
r_else
op_star
id|buf
op_assign
(paren
r_char
op_star
)paren
id|pSMB
suffix:semicolon
)brace
multiline_comment|/* Note: On -EAGAIN error only caller can retry on handle based calls &n;&t;&t;since file handle passed in no longer valid */
r_return
id|rc
suffix:semicolon
)brace
r_int
DECL|function|CIFSSMBWrite
id|CIFSSMBWrite
c_func
(paren
r_const
r_int
id|xid
comma
r_struct
id|cifsTconInfo
op_star
id|tcon
comma
r_const
r_int
id|netfid
comma
r_const
r_int
r_int
id|count
comma
r_const
id|__u64
id|offset
comma
r_int
r_int
op_star
id|nbytes
comma
r_const
r_char
op_star
id|buf
comma
r_const
r_char
id|__user
op_star
id|ubuf
comma
r_const
r_int
id|long_op
)paren
(brace
r_int
id|rc
op_assign
op_minus
id|EACCES
suffix:semicolon
id|WRITE_REQ
op_star
id|pSMB
op_assign
l_int|NULL
suffix:semicolon
id|WRITE_RSP
op_star
id|pSMBr
op_assign
l_int|NULL
suffix:semicolon
r_int
id|bytes_returned
suffix:semicolon
r_int
id|bytes_sent
suffix:semicolon
id|__u16
id|byte_count
suffix:semicolon
id|rc
op_assign
id|smb_init
c_func
(paren
id|SMB_COM_WRITE_ANDX
comma
l_int|14
comma
id|tcon
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMB
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMBr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
multiline_comment|/* tcon and ses pointer are checked in smb_init */
r_if
c_cond
(paren
id|tcon-&gt;ses-&gt;server
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ECONNABORTED
suffix:semicolon
id|pSMB-&gt;AndXCommand
op_assign
l_int|0xFF
suffix:semicolon
multiline_comment|/* none */
id|pSMB-&gt;Fid
op_assign
id|netfid
suffix:semicolon
id|pSMB-&gt;OffsetLow
op_assign
id|cpu_to_le32
c_func
(paren
id|offset
op_amp
l_int|0xFFFFFFFF
)paren
suffix:semicolon
id|pSMB-&gt;OffsetHigh
op_assign
id|cpu_to_le32
c_func
(paren
id|offset
op_rshift
l_int|32
)paren
suffix:semicolon
id|pSMB-&gt;Reserved
op_assign
l_int|0xFFFFFFFF
suffix:semicolon
id|pSMB-&gt;WriteMode
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Remaining
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* BB can relax this if buffer is big enough in some cases - ie we can &n;&t;send more  if LARGE_WRITE_X capability returned by the server and if&n;&t;our buffer is big enough or if we convert to iovecs on socket writes&n;&t;and eliminate the copy to the CIFS buffer */
id|bytes_sent
op_assign
(paren
id|tcon-&gt;ses-&gt;server-&gt;maxBuf
op_minus
id|MAX_CIFS_HDR_SIZE
)paren
op_amp
op_complement
l_int|0xFF
suffix:semicolon
r_if
c_cond
(paren
id|bytes_sent
OG
id|count
)paren
id|bytes_sent
op_assign
id|count
suffix:semicolon
id|pSMB-&gt;DataLengthHigh
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;DataOffset
op_assign
id|cpu_to_le16
c_func
(paren
m_offsetof
(paren
r_struct
id|smb_com_write_req
comma
id|Data
)paren
op_minus
l_int|4
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buf
)paren
(brace
id|memcpy
c_func
(paren
id|pSMB-&gt;Data
comma
id|buf
comma
id|bytes_sent
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ubuf
)paren
(brace
id|copy_from_user
c_func
(paren
id|pSMB-&gt;Data
comma
id|ubuf
comma
id|bytes_sent
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* No buffer */
r_if
c_cond
(paren
id|pSMB
)paren
(brace
id|cifs_buf_release
c_func
(paren
id|pSMB
)paren
suffix:semicolon
)brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|byte_count
op_assign
id|bytes_sent
op_plus
l_int|1
multiline_comment|/* pad */
suffix:semicolon
id|pSMB-&gt;DataLengthLow
op_assign
id|cpu_to_le16
c_func
(paren
id|bytes_sent
)paren
suffix:semicolon
id|pSMB-&gt;DataLengthHigh
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;hdr.smb_buf_length
op_add_assign
id|byte_count
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
id|cpu_to_le16
c_func
(paren
id|byte_count
)paren
suffix:semicolon
id|rc
op_assign
id|SendReceive
c_func
(paren
id|xid
comma
id|tcon-&gt;ses
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMB
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMBr
comma
op_amp
id|bytes_returned
comma
id|long_op
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Send error in write = %d&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
op_star
id|nbytes
op_assign
l_int|0
suffix:semicolon
)brace
r_else
op_star
id|nbytes
op_assign
id|le16_to_cpu
c_func
(paren
id|pSMBr-&gt;Count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pSMB
)paren
id|cifs_buf_release
c_func
(paren
id|pSMB
)paren
suffix:semicolon
multiline_comment|/* Note: On -EAGAIN error only caller can retry on handle based calls &n;&t;&t;since file handle passed in no longer valid */
r_return
id|rc
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_CIFS_EXPERIMENTAL
DECL|function|CIFSSMBWrite2
r_int
id|CIFSSMBWrite2
c_func
(paren
r_const
r_int
id|xid
comma
r_struct
id|cifsTconInfo
op_star
id|tcon
comma
r_const
r_int
id|netfid
comma
r_const
r_int
r_int
id|count
comma
r_const
id|__u64
id|offset
comma
r_int
r_int
op_star
id|nbytes
comma
r_const
r_char
id|__user
op_star
id|buf
comma
r_const
r_int
id|long_op
)paren
(brace
r_int
id|rc
op_assign
op_minus
id|EACCES
suffix:semicolon
id|WRITE_REQ
op_star
id|pSMB
op_assign
l_int|NULL
suffix:semicolon
id|WRITE_RSP
op_star
id|pSMBr
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/*int bytes_returned;*/
r_int
id|bytes_sent
suffix:semicolon
id|__u16
id|byte_count
suffix:semicolon
id|rc
op_assign
id|small_smb_init
c_func
(paren
id|SMB_COM_WRITE_ANDX
comma
l_int|14
comma
id|tcon
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMB
)paren
suffix:semicolon
id|pSMBr
op_assign
(paren
id|WRITE_RSP
op_star
)paren
id|pSMB
suffix:semicolon
multiline_comment|/* BB removeme BB */
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
multiline_comment|/* tcon and ses pointer are checked in smb_init */
r_if
c_cond
(paren
id|tcon-&gt;ses-&gt;server
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ECONNABORTED
suffix:semicolon
id|pSMB-&gt;AndXCommand
op_assign
l_int|0xFF
suffix:semicolon
multiline_comment|/* none */
id|pSMB-&gt;Fid
op_assign
id|netfid
suffix:semicolon
id|pSMB-&gt;OffsetLow
op_assign
id|cpu_to_le32
c_func
(paren
id|offset
op_amp
l_int|0xFFFFFFFF
)paren
suffix:semicolon
id|pSMB-&gt;OffsetHigh
op_assign
id|cpu_to_le32
c_func
(paren
id|offset
op_rshift
l_int|32
)paren
suffix:semicolon
id|pSMB-&gt;Reserved
op_assign
l_int|0xFFFFFFFF
suffix:semicolon
id|pSMB-&gt;WriteMode
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Remaining
op_assign
l_int|0
suffix:semicolon
id|bytes_sent
op_assign
(paren
id|tcon-&gt;ses-&gt;server-&gt;maxBuf
op_minus
id|MAX_CIFS_HDR_SIZE
)paren
op_amp
op_complement
l_int|0xFF
suffix:semicolon
r_if
c_cond
(paren
id|bytes_sent
OG
id|count
)paren
id|bytes_sent
op_assign
id|count
suffix:semicolon
id|pSMB-&gt;DataLengthHigh
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;DataOffset
op_assign
id|cpu_to_le16
c_func
(paren
m_offsetof
(paren
r_struct
id|smb_com_write_req
comma
id|Data
)paren
op_minus
l_int|4
)paren
suffix:semicolon
id|byte_count
op_assign
id|bytes_sent
op_plus
l_int|1
multiline_comment|/* pad */
suffix:semicolon
id|pSMB-&gt;DataLengthLow
op_assign
id|cpu_to_le16
c_func
(paren
id|bytes_sent
)paren
suffix:semicolon
id|pSMB-&gt;DataLengthHigh
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;hdr.smb_buf_length
op_add_assign
id|byte_count
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
id|cpu_to_le16
c_func
(paren
id|byte_count
)paren
suffix:semicolon
multiline_comment|/*&t;rc = SendReceive2(xid, tcon-&gt;ses, (struct smb_hdr *) pSMB,&n;&t;&t;&t; (struct smb_hdr *) pSMBr, buf, buflen, &amp;bytes_returned, long_op); */
multiline_comment|/* BB fixme BB */
r_if
c_cond
(paren
id|rc
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Send error in write2 (large write) = %d&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
op_star
id|nbytes
op_assign
l_int|0
suffix:semicolon
)brace
r_else
op_star
id|nbytes
op_assign
id|le16_to_cpu
c_func
(paren
id|pSMBr-&gt;Count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pSMB
)paren
id|cifs_small_buf_release
c_func
(paren
id|pSMB
)paren
suffix:semicolon
multiline_comment|/* Note: On -EAGAIN error only caller can retry on handle based calls &n;&t;&t;since file handle passed in no longer valid */
r_return
id|rc
suffix:semicolon
)brace
macro_line|#endif /* CIFS_EXPERIMENTAL */
r_int
DECL|function|CIFSSMBLock
id|CIFSSMBLock
c_func
(paren
r_const
r_int
id|xid
comma
r_struct
id|cifsTconInfo
op_star
id|tcon
comma
r_const
id|__u16
id|smb_file_id
comma
r_const
id|__u64
id|len
comma
r_const
id|__u64
id|offset
comma
r_const
id|__u32
id|numUnlock
comma
r_const
id|__u32
id|numLock
comma
r_const
id|__u8
id|lockType
comma
r_const
r_int
id|waitFlag
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|LOCK_REQ
op_star
id|pSMB
op_assign
l_int|NULL
suffix:semicolon
id|LOCK_RSP
op_star
id|pSMBr
op_assign
l_int|NULL
suffix:semicolon
r_int
id|bytes_returned
suffix:semicolon
r_int
id|timeout
op_assign
l_int|0
suffix:semicolon
id|__u16
id|count
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;In CIFSSMBLock - timeout %d numLock %d&quot;
comma
id|waitFlag
comma
id|numLock
)paren
)paren
suffix:semicolon
id|rc
op_assign
id|smb_init
c_func
(paren
id|SMB_COM_LOCKING_ANDX
comma
l_int|8
comma
id|tcon
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMB
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMBr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|lockType
op_eq
id|LOCKING_ANDX_OPLOCK_RELEASE
)paren
(brace
id|timeout
op_assign
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* no response expected */
id|pSMB-&gt;Timeout
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|waitFlag
op_eq
id|TRUE
)paren
(brace
id|timeout
op_assign
l_int|3
suffix:semicolon
multiline_comment|/* blocking operation, no timeout */
id|pSMB-&gt;Timeout
op_assign
id|cpu_to_le32
c_func
(paren
op_minus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* blocking - do not time out */
)brace
r_else
(brace
id|pSMB-&gt;Timeout
op_assign
l_int|0
suffix:semicolon
)brace
id|pSMB-&gt;NumberOfLocks
op_assign
id|cpu_to_le16
c_func
(paren
id|numLock
)paren
suffix:semicolon
id|pSMB-&gt;NumberOfUnlocks
op_assign
id|cpu_to_le16
c_func
(paren
id|numUnlock
)paren
suffix:semicolon
id|pSMB-&gt;LockType
op_assign
id|lockType
suffix:semicolon
id|pSMB-&gt;AndXCommand
op_assign
l_int|0xFF
suffix:semicolon
multiline_comment|/* none */
id|pSMB-&gt;Fid
op_assign
id|smb_file_id
suffix:semicolon
multiline_comment|/* netfid stays le */
r_if
c_cond
(paren
(paren
id|numLock
op_ne
l_int|0
)paren
op_logical_or
(paren
id|numUnlock
op_ne
l_int|0
)paren
)paren
(brace
id|pSMB-&gt;Locks
(braket
l_int|0
)braket
dot
id|Pid
op_assign
id|cpu_to_le16
c_func
(paren
id|current-&gt;tgid
)paren
suffix:semicolon
multiline_comment|/* BB where to store pid high? */
id|pSMB-&gt;Locks
(braket
l_int|0
)braket
dot
id|LengthLow
op_assign
id|cpu_to_le32
c_func
(paren
(paren
id|u32
)paren
id|len
)paren
suffix:semicolon
id|pSMB-&gt;Locks
(braket
l_int|0
)braket
dot
id|LengthHigh
op_assign
id|cpu_to_le32
c_func
(paren
(paren
id|u32
)paren
(paren
id|len
op_rshift
l_int|32
)paren
)paren
suffix:semicolon
id|pSMB-&gt;Locks
(braket
l_int|0
)braket
dot
id|OffsetLow
op_assign
id|cpu_to_le32
c_func
(paren
(paren
id|u32
)paren
id|offset
)paren
suffix:semicolon
id|pSMB-&gt;Locks
(braket
l_int|0
)braket
dot
id|OffsetHigh
op_assign
id|cpu_to_le32
c_func
(paren
(paren
id|u32
)paren
(paren
id|offset
op_rshift
l_int|32
)paren
)paren
suffix:semicolon
id|count
op_assign
r_sizeof
(paren
id|LOCKING_ANDX_RANGE
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* oplock break */
id|count
op_assign
l_int|0
suffix:semicolon
)brace
id|pSMB-&gt;hdr.smb_buf_length
op_add_assign
id|count
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
id|cpu_to_le16
c_func
(paren
id|count
)paren
suffix:semicolon
id|rc
op_assign
id|SendReceive
c_func
(paren
id|xid
comma
id|tcon-&gt;ses
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMB
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMBr
comma
op_amp
id|bytes_returned
comma
id|timeout
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Send error in Lock = %d&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pSMB
)paren
id|cifs_buf_release
c_func
(paren
id|pSMB
)paren
suffix:semicolon
multiline_comment|/* Note: On -EAGAIN error only caller can retry on handle based calls &n;&t;since file handle passed in no longer valid */
r_return
id|rc
suffix:semicolon
)brace
r_int
DECL|function|CIFSSMBClose
id|CIFSSMBClose
c_func
(paren
r_const
r_int
id|xid
comma
r_struct
id|cifsTconInfo
op_star
id|tcon
comma
r_int
id|smb_file_id
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|CLOSE_REQ
op_star
id|pSMB
op_assign
l_int|NULL
suffix:semicolon
id|CLOSE_RSP
op_star
id|pSMBr
op_assign
l_int|NULL
suffix:semicolon
r_int
id|bytes_returned
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;In CIFSSMBClose&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* do not retry on dead session on close */
id|rc
op_assign
id|small_smb_init
c_func
(paren
id|SMB_COM_CLOSE
comma
l_int|3
comma
id|tcon
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMB
)paren
suffix:semicolon
id|pSMBr
op_assign
(paren
id|CLOSE_RSP
op_star
)paren
id|pSMB
suffix:semicolon
multiline_comment|/* BB removeme BB */
r_if
c_cond
(paren
id|rc
op_eq
op_minus
id|EAGAIN
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
id|pSMB-&gt;FileID
op_assign
(paren
id|__u16
)paren
id|smb_file_id
suffix:semicolon
id|pSMB-&gt;LastWriteTime
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
l_int|0
suffix:semicolon
id|rc
op_assign
id|SendReceive
c_func
(paren
id|xid
comma
id|tcon-&gt;ses
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMB
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMBr
comma
op_amp
id|bytes_returned
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
r_if
c_cond
(paren
id|rc
op_ne
op_minus
id|EINTR
)paren
(brace
multiline_comment|/* EINTR is expected when user ctl-c to kill app */
id|cERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Send error in Close = %d&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|pSMB
)paren
id|cifs_small_buf_release
c_func
(paren
id|pSMB
)paren
suffix:semicolon
multiline_comment|/* Since session is dead, file will be closed on server already */
r_if
c_cond
(paren
id|rc
op_eq
op_minus
id|EAGAIN
)paren
(brace
id|rc
op_assign
l_int|0
suffix:semicolon
)brace
r_return
id|rc
suffix:semicolon
)brace
r_int
DECL|function|CIFSSMBRename
id|CIFSSMBRename
c_func
(paren
r_const
r_int
id|xid
comma
r_struct
id|cifsTconInfo
op_star
id|tcon
comma
r_const
r_char
op_star
id|fromName
comma
r_const
r_char
op_star
id|toName
comma
r_const
r_struct
id|nls_table
op_star
id|nls_codepage
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|RENAME_REQ
op_star
id|pSMB
op_assign
l_int|NULL
suffix:semicolon
id|RENAME_RSP
op_star
id|pSMBr
op_assign
l_int|NULL
suffix:semicolon
r_int
id|bytes_returned
suffix:semicolon
r_int
id|name_len
comma
id|name_len2
suffix:semicolon
id|__u16
id|count
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;In CIFSSMBRename&quot;
)paren
)paren
suffix:semicolon
id|renameRetry
suffix:colon
id|rc
op_assign
id|smb_init
c_func
(paren
id|SMB_COM_RENAME
comma
l_int|1
comma
id|tcon
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMB
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMBr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
id|pSMB-&gt;BufferFormat
op_assign
l_int|0x04
suffix:semicolon
id|pSMB-&gt;SearchAttributes
op_assign
id|cpu_to_le16
c_func
(paren
id|ATTR_READONLY
op_or
id|ATTR_HIDDEN
op_or
id|ATTR_SYSTEM
op_or
id|ATTR_DIRECTORY
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pSMB-&gt;hdr.Flags2
op_amp
id|SMBFLG2_UNICODE
)paren
(brace
id|name_len
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|pSMB-&gt;OldFileName
comma
id|fromName
comma
l_int|530
multiline_comment|/* find define for this maxpathcomponent */
comma
id|nls_codepage
)paren
suffix:semicolon
id|name_len
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|name_len
op_mul_assign
l_int|2
suffix:semicolon
id|pSMB-&gt;OldFileName
(braket
id|name_len
)braket
op_assign
l_int|0x04
suffix:semicolon
multiline_comment|/* pad */
multiline_comment|/* protocol requires ASCII signature byte on Unicode string */
id|pSMB-&gt;OldFileName
(braket
id|name_len
op_plus
l_int|1
)braket
op_assign
l_int|0x00
suffix:semicolon
id|name_len2
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
op_amp
id|pSMB
op_member_access_from_pointer
id|OldFileName
(braket
id|name_len
op_plus
l_int|2
)braket
comma
id|toName
comma
l_int|530
comma
id|nls_codepage
)paren
suffix:semicolon
id|name_len2
op_add_assign
l_int|1
multiline_comment|/* trailing null */
op_plus
l_int|1
multiline_comment|/* Signature word */
suffix:semicolon
id|name_len2
op_mul_assign
l_int|2
suffix:semicolon
multiline_comment|/* convert to bytes */
)brace
r_else
(brace
multiline_comment|/* BB improve the check for buffer overruns BB */
id|name_len
op_assign
id|strnlen
c_func
(paren
id|fromName
comma
l_int|530
)paren
suffix:semicolon
id|name_len
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|strncpy
c_func
(paren
id|pSMB-&gt;OldFileName
comma
id|fromName
comma
id|name_len
)paren
suffix:semicolon
id|name_len2
op_assign
id|strnlen
c_func
(paren
id|toName
comma
l_int|530
)paren
suffix:semicolon
id|name_len2
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|pSMB-&gt;OldFileName
(braket
id|name_len
)braket
op_assign
l_int|0x04
suffix:semicolon
multiline_comment|/* 2nd buffer format */
id|strncpy
c_func
(paren
op_amp
id|pSMB-&gt;OldFileName
(braket
id|name_len
op_plus
l_int|1
)braket
comma
id|toName
comma
id|name_len2
)paren
suffix:semicolon
id|name_len2
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|name_len2
op_increment
suffix:semicolon
multiline_comment|/* signature byte */
)brace
id|count
op_assign
l_int|1
multiline_comment|/* 1st signature byte */
op_plus
id|name_len
op_plus
id|name_len2
suffix:semicolon
id|pSMB-&gt;hdr.smb_buf_length
op_add_assign
id|count
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
id|cpu_to_le16
c_func
(paren
id|count
)paren
suffix:semicolon
id|rc
op_assign
id|SendReceive
c_func
(paren
id|xid
comma
id|tcon-&gt;ses
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMB
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMBr
comma
op_amp
id|bytes_returned
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Send error in rename = %d&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_CIFS_STATS
r_else
(brace
id|atomic_inc
c_func
(paren
op_amp
id|tcon-&gt;num_renames
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|pSMB
)paren
id|cifs_buf_release
c_func
(paren
id|pSMB
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
op_minus
id|EAGAIN
)paren
r_goto
id|renameRetry
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|CIFSSMBRenameOpenFile
r_int
id|CIFSSMBRenameOpenFile
c_func
(paren
r_const
r_int
id|xid
comma
r_struct
id|cifsTconInfo
op_star
id|pTcon
comma
r_int
id|netfid
comma
r_char
op_star
id|target_name
comma
r_const
r_struct
id|nls_table
op_star
id|nls_codepage
)paren
(brace
r_struct
id|smb_com_transaction2_sfi_req
op_star
id|pSMB
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|smb_com_transaction2_sfi_rsp
op_star
id|pSMBr
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|set_file_rename
op_star
id|rename_info
suffix:semicolon
r_char
op_star
id|data_offset
suffix:semicolon
r_char
id|dummy_string
(braket
l_int|30
)braket
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|bytes_returned
op_assign
l_int|0
suffix:semicolon
r_int
id|len_of_str
suffix:semicolon
id|__u16
id|params
comma
id|param_offset
comma
id|offset
comma
id|count
comma
id|byte_count
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Rename to File by handle&quot;
)paren
)paren
suffix:semicolon
id|rc
op_assign
id|smb_init
c_func
(paren
id|SMB_COM_TRANSACTION2
comma
l_int|15
comma
id|pTcon
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMB
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMBr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
id|params
op_assign
l_int|6
suffix:semicolon
id|pSMB-&gt;MaxSetupCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Flags
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Timeout
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved2
op_assign
l_int|0
suffix:semicolon
id|param_offset
op_assign
m_offsetof
(paren
r_struct
id|smb_com_transaction2_sfi_req
comma
id|Fid
)paren
op_minus
l_int|4
suffix:semicolon
id|offset
op_assign
id|param_offset
op_plus
id|params
suffix:semicolon
id|data_offset
op_assign
(paren
r_char
op_star
)paren
(paren
op_amp
id|pSMB-&gt;hdr.Protocol
)paren
op_plus
id|offset
suffix:semicolon
id|rename_info
op_assign
(paren
r_struct
id|set_file_rename
op_star
)paren
id|data_offset
suffix:semicolon
id|pSMB-&gt;MaxParameterCount
op_assign
id|cpu_to_le16
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|pSMB-&gt;MaxDataCount
op_assign
id|cpu_to_le16
c_func
(paren
l_int|1000
)paren
suffix:semicolon
multiline_comment|/* BB find max SMB PDU from sess */
id|pSMB-&gt;SetupCount
op_assign
l_int|1
suffix:semicolon
id|pSMB-&gt;Reserved3
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;SubCommand
op_assign
id|cpu_to_le16
c_func
(paren
id|TRANS2_SET_FILE_INFORMATION
)paren
suffix:semicolon
id|byte_count
op_assign
l_int|3
multiline_comment|/* pad */
op_plus
id|params
suffix:semicolon
id|pSMB-&gt;ParameterCount
op_assign
id|cpu_to_le16
c_func
(paren
id|params
)paren
suffix:semicolon
id|pSMB-&gt;TotalParameterCount
op_assign
id|pSMB-&gt;ParameterCount
suffix:semicolon
id|pSMB-&gt;ParameterOffset
op_assign
id|cpu_to_le16
c_func
(paren
id|param_offset
)paren
suffix:semicolon
id|pSMB-&gt;DataOffset
op_assign
id|cpu_to_le16
c_func
(paren
id|offset
)paren
suffix:semicolon
multiline_comment|/* construct random name &quot;.cifs_tmp&lt;inodenum&gt;&lt;mid&gt;&quot; */
id|rename_info-&gt;overwrite
op_assign
id|cpu_to_le32
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|rename_info-&gt;root_fid
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* unicode only call */
r_if
c_cond
(paren
id|target_name
op_eq
l_int|NULL
)paren
(brace
id|sprintf
c_func
(paren
id|dummy_string
comma
l_string|&quot;cifs%x&quot;
comma
id|pSMB-&gt;hdr.Mid
)paren
suffix:semicolon
id|len_of_str
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|rename_info-&gt;target_name
comma
id|dummy_string
comma
l_int|24
comma
id|nls_codepage
)paren
suffix:semicolon
)brace
r_else
(brace
id|len_of_str
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|rename_info-&gt;target_name
comma
id|target_name
comma
l_int|530
comma
id|nls_codepage
)paren
suffix:semicolon
)brace
id|rename_info-&gt;target_name_len
op_assign
id|cpu_to_le32
c_func
(paren
l_int|2
op_star
id|len_of_str
)paren
suffix:semicolon
id|count
op_assign
l_int|12
multiline_comment|/* sizeof(struct set_file_rename) */
op_plus
(paren
l_int|2
op_star
id|len_of_str
)paren
op_plus
l_int|2
suffix:semicolon
id|byte_count
op_add_assign
id|count
suffix:semicolon
id|pSMB-&gt;DataCount
op_assign
id|cpu_to_le16
c_func
(paren
id|count
)paren
suffix:semicolon
id|pSMB-&gt;TotalDataCount
op_assign
id|pSMB-&gt;DataCount
suffix:semicolon
id|pSMB-&gt;Fid
op_assign
id|netfid
suffix:semicolon
id|pSMB-&gt;InformationLevel
op_assign
id|cpu_to_le16
c_func
(paren
id|SMB_SET_FILE_RENAME_INFORMATION
)paren
suffix:semicolon
id|pSMB-&gt;Reserved4
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;hdr.smb_buf_length
op_add_assign
id|byte_count
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
id|cpu_to_le16
c_func
(paren
id|byte_count
)paren
suffix:semicolon
id|rc
op_assign
id|SendReceive
c_func
(paren
id|xid
comma
id|pTcon-&gt;ses
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMB
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMBr
comma
op_amp
id|bytes_returned
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Send error in Rename (by file handle) = %d&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_CIFS_STATS
r_else
(brace
id|atomic_inc
c_func
(paren
op_amp
id|pTcon-&gt;num_t2renames
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|pSMB
)paren
id|cifs_buf_release
c_func
(paren
id|pSMB
)paren
suffix:semicolon
multiline_comment|/* Note: On -EAGAIN error only caller can retry on handle based calls&n;&t;&t;since file handle passed in no longer valid */
r_return
id|rc
suffix:semicolon
)brace
r_int
DECL|function|CIFSSMBCopy
id|CIFSSMBCopy
c_func
(paren
r_const
r_int
id|xid
comma
r_struct
id|cifsTconInfo
op_star
id|tcon
comma
r_const
r_char
op_star
id|fromName
comma
r_const
id|__u16
id|target_tid
comma
r_const
r_char
op_star
id|toName
comma
r_const
r_int
id|flags
comma
r_const
r_struct
id|nls_table
op_star
id|nls_codepage
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|COPY_REQ
op_star
id|pSMB
op_assign
l_int|NULL
suffix:semicolon
id|COPY_RSP
op_star
id|pSMBr
op_assign
l_int|NULL
suffix:semicolon
r_int
id|bytes_returned
suffix:semicolon
r_int
id|name_len
comma
id|name_len2
suffix:semicolon
id|__u16
id|count
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;In CIFSSMBCopy&quot;
)paren
)paren
suffix:semicolon
id|copyRetry
suffix:colon
id|rc
op_assign
id|smb_init
c_func
(paren
id|SMB_COM_COPY
comma
l_int|1
comma
id|tcon
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMB
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMBr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
id|pSMB-&gt;BufferFormat
op_assign
l_int|0x04
suffix:semicolon
id|pSMB-&gt;Tid2
op_assign
id|target_tid
suffix:semicolon
id|pSMB-&gt;Flags
op_assign
id|cpu_to_le16
c_func
(paren
id|flags
op_amp
id|COPY_TREE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pSMB-&gt;hdr.Flags2
op_amp
id|SMBFLG2_UNICODE
)paren
(brace
id|name_len
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|pSMB-&gt;OldFileName
comma
id|fromName
comma
l_int|530
multiline_comment|/* find define for this maxpathcomponent */
comma
id|nls_codepage
)paren
suffix:semicolon
id|name_len
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|name_len
op_mul_assign
l_int|2
suffix:semicolon
id|pSMB-&gt;OldFileName
(braket
id|name_len
)braket
op_assign
l_int|0x04
suffix:semicolon
multiline_comment|/* pad */
multiline_comment|/* protocol requires ASCII signature byte on Unicode string */
id|pSMB-&gt;OldFileName
(braket
id|name_len
op_plus
l_int|1
)braket
op_assign
l_int|0x00
suffix:semicolon
id|name_len2
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
op_amp
id|pSMB
op_member_access_from_pointer
id|OldFileName
(braket
id|name_len
op_plus
l_int|2
)braket
comma
id|toName
comma
l_int|530
comma
id|nls_codepage
)paren
suffix:semicolon
id|name_len2
op_add_assign
l_int|1
multiline_comment|/* trailing null */
op_plus
l_int|1
multiline_comment|/* Signature word */
suffix:semicolon
id|name_len2
op_mul_assign
l_int|2
suffix:semicolon
multiline_comment|/* convert to bytes */
)brace
r_else
(brace
multiline_comment|/* BB improve the check for buffer overruns BB */
id|name_len
op_assign
id|strnlen
c_func
(paren
id|fromName
comma
l_int|530
)paren
suffix:semicolon
id|name_len
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|strncpy
c_func
(paren
id|pSMB-&gt;OldFileName
comma
id|fromName
comma
id|name_len
)paren
suffix:semicolon
id|name_len2
op_assign
id|strnlen
c_func
(paren
id|toName
comma
l_int|530
)paren
suffix:semicolon
id|name_len2
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|pSMB-&gt;OldFileName
(braket
id|name_len
)braket
op_assign
l_int|0x04
suffix:semicolon
multiline_comment|/* 2nd buffer format */
id|strncpy
c_func
(paren
op_amp
id|pSMB-&gt;OldFileName
(braket
id|name_len
op_plus
l_int|1
)braket
comma
id|toName
comma
id|name_len2
)paren
suffix:semicolon
id|name_len2
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|name_len2
op_increment
suffix:semicolon
multiline_comment|/* signature byte */
)brace
id|count
op_assign
l_int|1
multiline_comment|/* 1st signature byte */
op_plus
id|name_len
op_plus
id|name_len2
suffix:semicolon
id|pSMB-&gt;hdr.smb_buf_length
op_add_assign
id|count
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
id|cpu_to_le16
c_func
(paren
id|count
)paren
suffix:semicolon
id|rc
op_assign
id|SendReceive
c_func
(paren
id|xid
comma
id|tcon-&gt;ses
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMB
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMBr
comma
op_amp
id|bytes_returned
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Send error in copy = %d with %d files copied&quot;
comma
id|rc
comma
id|le16_to_cpu
c_func
(paren
id|pSMBr-&gt;CopyCount
)paren
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pSMB
)paren
id|cifs_buf_release
c_func
(paren
id|pSMB
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
op_minus
id|EAGAIN
)paren
r_goto
id|copyRetry
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_int
DECL|function|CIFSUnixCreateSymLink
id|CIFSUnixCreateSymLink
c_func
(paren
r_const
r_int
id|xid
comma
r_struct
id|cifsTconInfo
op_star
id|tcon
comma
r_const
r_char
op_star
id|fromName
comma
r_const
r_char
op_star
id|toName
comma
r_const
r_struct
id|nls_table
op_star
id|nls_codepage
)paren
(brace
id|TRANSACTION2_SPI_REQ
op_star
id|pSMB
op_assign
l_int|NULL
suffix:semicolon
id|TRANSACTION2_SPI_RSP
op_star
id|pSMBr
op_assign
l_int|NULL
suffix:semicolon
r_char
op_star
id|data_offset
suffix:semicolon
r_int
id|name_len
suffix:semicolon
r_int
id|name_len_target
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|bytes_returned
op_assign
l_int|0
suffix:semicolon
id|__u16
id|params
comma
id|param_offset
comma
id|offset
comma
id|byte_count
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;In Symlink Unix style&quot;
)paren
)paren
suffix:semicolon
id|createSymLinkRetry
suffix:colon
id|rc
op_assign
id|smb_init
c_func
(paren
id|SMB_COM_TRANSACTION2
comma
l_int|15
comma
id|tcon
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMB
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMBr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|pSMB-&gt;hdr.Flags2
op_amp
id|SMBFLG2_UNICODE
)paren
(brace
id|name_len
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|pSMB-&gt;FileName
comma
id|fromName
comma
l_int|530
multiline_comment|/* find define for this maxpathcomponent */
comma
id|nls_codepage
)paren
suffix:semicolon
id|name_len
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|name_len
op_mul_assign
l_int|2
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* BB improve the check for buffer overruns BB */
id|name_len
op_assign
id|strnlen
c_func
(paren
id|fromName
comma
l_int|530
)paren
suffix:semicolon
id|name_len
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|strncpy
c_func
(paren
id|pSMB-&gt;FileName
comma
id|fromName
comma
id|name_len
)paren
suffix:semicolon
)brace
id|params
op_assign
l_int|6
op_plus
id|name_len
suffix:semicolon
id|pSMB-&gt;MaxSetupCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Flags
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Timeout
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved2
op_assign
l_int|0
suffix:semicolon
id|param_offset
op_assign
m_offsetof
(paren
r_struct
id|smb_com_transaction2_spi_req
comma
id|InformationLevel
)paren
op_minus
l_int|4
suffix:semicolon
id|offset
op_assign
id|param_offset
op_plus
id|params
suffix:semicolon
id|data_offset
op_assign
(paren
r_char
op_star
)paren
(paren
op_amp
id|pSMB-&gt;hdr.Protocol
)paren
op_plus
id|offset
suffix:semicolon
r_if
c_cond
(paren
id|pSMB-&gt;hdr.Flags2
op_amp
id|SMBFLG2_UNICODE
)paren
(brace
id|name_len_target
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|data_offset
comma
id|toName
comma
l_int|530
multiline_comment|/* find define for this maxpathcomponent */
comma
id|nls_codepage
)paren
suffix:semicolon
id|name_len_target
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|name_len_target
op_mul_assign
l_int|2
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* BB improve the check for buffer overruns BB */
id|name_len_target
op_assign
id|strnlen
c_func
(paren
id|toName
comma
l_int|530
)paren
suffix:semicolon
id|name_len_target
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|strncpy
c_func
(paren
id|data_offset
comma
id|toName
comma
id|name_len_target
)paren
suffix:semicolon
)brace
id|pSMB-&gt;MaxParameterCount
op_assign
id|cpu_to_le16
c_func
(paren
l_int|2
)paren
suffix:semicolon
multiline_comment|/* BB find exact max on data count below from sess */
id|pSMB-&gt;MaxDataCount
op_assign
id|cpu_to_le16
c_func
(paren
l_int|1000
)paren
suffix:semicolon
id|pSMB-&gt;SetupCount
op_assign
l_int|1
suffix:semicolon
id|pSMB-&gt;Reserved3
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;SubCommand
op_assign
id|cpu_to_le16
c_func
(paren
id|TRANS2_SET_PATH_INFORMATION
)paren
suffix:semicolon
id|byte_count
op_assign
l_int|3
multiline_comment|/* pad */
op_plus
id|params
op_plus
id|name_len_target
suffix:semicolon
id|pSMB-&gt;DataCount
op_assign
id|cpu_to_le16
c_func
(paren
id|name_len_target
)paren
suffix:semicolon
id|pSMB-&gt;ParameterCount
op_assign
id|cpu_to_le16
c_func
(paren
id|params
)paren
suffix:semicolon
id|pSMB-&gt;TotalDataCount
op_assign
id|pSMB-&gt;DataCount
suffix:semicolon
id|pSMB-&gt;TotalParameterCount
op_assign
id|pSMB-&gt;ParameterCount
suffix:semicolon
id|pSMB-&gt;ParameterOffset
op_assign
id|cpu_to_le16
c_func
(paren
id|param_offset
)paren
suffix:semicolon
id|pSMB-&gt;DataOffset
op_assign
id|cpu_to_le16
c_func
(paren
id|offset
)paren
suffix:semicolon
id|pSMB-&gt;InformationLevel
op_assign
id|cpu_to_le16
c_func
(paren
id|SMB_SET_FILE_UNIX_LINK
)paren
suffix:semicolon
id|pSMB-&gt;Reserved4
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;hdr.smb_buf_length
op_add_assign
id|byte_count
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
id|cpu_to_le16
c_func
(paren
id|byte_count
)paren
suffix:semicolon
id|rc
op_assign
id|SendReceive
c_func
(paren
id|xid
comma
id|tcon-&gt;ses
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMB
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMBr
comma
op_amp
id|bytes_returned
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Send error in SetPathInfo (create symlink) = %d&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pSMB
)paren
id|cifs_buf_release
c_func
(paren
id|pSMB
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
op_minus
id|EAGAIN
)paren
r_goto
id|createSymLinkRetry
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_int
DECL|function|CIFSUnixCreateHardLink
id|CIFSUnixCreateHardLink
c_func
(paren
r_const
r_int
id|xid
comma
r_struct
id|cifsTconInfo
op_star
id|tcon
comma
r_const
r_char
op_star
id|fromName
comma
r_const
r_char
op_star
id|toName
comma
r_const
r_struct
id|nls_table
op_star
id|nls_codepage
)paren
(brace
id|TRANSACTION2_SPI_REQ
op_star
id|pSMB
op_assign
l_int|NULL
suffix:semicolon
id|TRANSACTION2_SPI_RSP
op_star
id|pSMBr
op_assign
l_int|NULL
suffix:semicolon
r_char
op_star
id|data_offset
suffix:semicolon
r_int
id|name_len
suffix:semicolon
r_int
id|name_len_target
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|bytes_returned
op_assign
l_int|0
suffix:semicolon
id|__u16
id|params
comma
id|param_offset
comma
id|offset
comma
id|byte_count
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;In Create Hard link Unix style&quot;
)paren
)paren
suffix:semicolon
id|createHardLinkRetry
suffix:colon
id|rc
op_assign
id|smb_init
c_func
(paren
id|SMB_COM_TRANSACTION2
comma
l_int|15
comma
id|tcon
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMB
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMBr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|pSMB-&gt;hdr.Flags2
op_amp
id|SMBFLG2_UNICODE
)paren
(brace
id|name_len
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|pSMB-&gt;FileName
comma
id|toName
comma
l_int|530
multiline_comment|/* find define for this maxpathcomponent */
comma
id|nls_codepage
)paren
suffix:semicolon
id|name_len
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|name_len
op_mul_assign
l_int|2
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* BB improve the check for buffer overruns BB */
id|name_len
op_assign
id|strnlen
c_func
(paren
id|toName
comma
l_int|530
)paren
suffix:semicolon
id|name_len
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|strncpy
c_func
(paren
id|pSMB-&gt;FileName
comma
id|toName
comma
id|name_len
)paren
suffix:semicolon
)brace
id|params
op_assign
l_int|6
op_plus
id|name_len
suffix:semicolon
id|pSMB-&gt;MaxSetupCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Flags
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Timeout
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved2
op_assign
l_int|0
suffix:semicolon
id|param_offset
op_assign
m_offsetof
(paren
r_struct
id|smb_com_transaction2_spi_req
comma
id|InformationLevel
)paren
op_minus
l_int|4
suffix:semicolon
id|offset
op_assign
id|param_offset
op_plus
id|params
suffix:semicolon
id|data_offset
op_assign
(paren
r_char
op_star
)paren
(paren
op_amp
id|pSMB-&gt;hdr.Protocol
)paren
op_plus
id|offset
suffix:semicolon
r_if
c_cond
(paren
id|pSMB-&gt;hdr.Flags2
op_amp
id|SMBFLG2_UNICODE
)paren
(brace
id|name_len_target
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|data_offset
comma
id|fromName
comma
l_int|530
multiline_comment|/* find define for this maxpathcomponent */
comma
id|nls_codepage
)paren
suffix:semicolon
id|name_len_target
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|name_len_target
op_mul_assign
l_int|2
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* BB improve the check for buffer overruns BB */
id|name_len_target
op_assign
id|strnlen
c_func
(paren
id|fromName
comma
l_int|530
)paren
suffix:semicolon
id|name_len_target
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|strncpy
c_func
(paren
id|data_offset
comma
id|fromName
comma
id|name_len_target
)paren
suffix:semicolon
)brace
id|pSMB-&gt;MaxParameterCount
op_assign
id|cpu_to_le16
c_func
(paren
l_int|2
)paren
suffix:semicolon
multiline_comment|/* BB find exact max on data count below from sess*/
id|pSMB-&gt;MaxDataCount
op_assign
id|cpu_to_le16
c_func
(paren
l_int|1000
)paren
suffix:semicolon
id|pSMB-&gt;SetupCount
op_assign
l_int|1
suffix:semicolon
id|pSMB-&gt;Reserved3
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;SubCommand
op_assign
id|cpu_to_le16
c_func
(paren
id|TRANS2_SET_PATH_INFORMATION
)paren
suffix:semicolon
id|byte_count
op_assign
l_int|3
multiline_comment|/* pad */
op_plus
id|params
op_plus
id|name_len_target
suffix:semicolon
id|pSMB-&gt;ParameterCount
op_assign
id|cpu_to_le16
c_func
(paren
id|params
)paren
suffix:semicolon
id|pSMB-&gt;TotalParameterCount
op_assign
id|pSMB-&gt;ParameterCount
suffix:semicolon
id|pSMB-&gt;DataCount
op_assign
id|cpu_to_le16
c_func
(paren
id|name_len_target
)paren
suffix:semicolon
id|pSMB-&gt;TotalDataCount
op_assign
id|pSMB-&gt;DataCount
suffix:semicolon
id|pSMB-&gt;ParameterOffset
op_assign
id|cpu_to_le16
c_func
(paren
id|param_offset
)paren
suffix:semicolon
id|pSMB-&gt;DataOffset
op_assign
id|cpu_to_le16
c_func
(paren
id|offset
)paren
suffix:semicolon
id|pSMB-&gt;InformationLevel
op_assign
id|cpu_to_le16
c_func
(paren
id|SMB_SET_FILE_UNIX_HLINK
)paren
suffix:semicolon
id|pSMB-&gt;Reserved4
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;hdr.smb_buf_length
op_add_assign
id|byte_count
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
id|cpu_to_le16
c_func
(paren
id|byte_count
)paren
suffix:semicolon
id|rc
op_assign
id|SendReceive
c_func
(paren
id|xid
comma
id|tcon-&gt;ses
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMB
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMBr
comma
op_amp
id|bytes_returned
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Send error in SetPathInfo (hard link) = %d&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pSMB
)paren
id|cifs_buf_release
c_func
(paren
id|pSMB
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
op_minus
id|EAGAIN
)paren
r_goto
id|createHardLinkRetry
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_int
DECL|function|CIFSCreateHardLink
id|CIFSCreateHardLink
c_func
(paren
r_const
r_int
id|xid
comma
r_struct
id|cifsTconInfo
op_star
id|tcon
comma
r_const
r_char
op_star
id|fromName
comma
r_const
r_char
op_star
id|toName
comma
r_const
r_struct
id|nls_table
op_star
id|nls_codepage
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|NT_RENAME_REQ
op_star
id|pSMB
op_assign
l_int|NULL
suffix:semicolon
id|RENAME_RSP
op_star
id|pSMBr
op_assign
l_int|NULL
suffix:semicolon
r_int
id|bytes_returned
suffix:semicolon
r_int
id|name_len
comma
id|name_len2
suffix:semicolon
id|__u16
id|count
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;In CIFSCreateHardLink&quot;
)paren
)paren
suffix:semicolon
id|winCreateHardLinkRetry
suffix:colon
id|rc
op_assign
id|smb_init
c_func
(paren
id|SMB_COM_NT_RENAME
comma
l_int|4
comma
id|tcon
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMB
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMBr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
id|pSMB-&gt;SearchAttributes
op_assign
id|cpu_to_le16
c_func
(paren
id|ATTR_READONLY
op_or
id|ATTR_HIDDEN
op_or
id|ATTR_SYSTEM
op_or
id|ATTR_DIRECTORY
)paren
suffix:semicolon
id|pSMB-&gt;Flags
op_assign
id|cpu_to_le16
c_func
(paren
id|CREATE_HARD_LINK
)paren
suffix:semicolon
id|pSMB-&gt;ClusterCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;BufferFormat
op_assign
l_int|0x04
suffix:semicolon
r_if
c_cond
(paren
id|pSMB-&gt;hdr.Flags2
op_amp
id|SMBFLG2_UNICODE
)paren
(brace
id|name_len
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|pSMB-&gt;OldFileName
comma
id|fromName
comma
l_int|530
multiline_comment|/* find define for this maxpathcomponent */
comma
id|nls_codepage
)paren
suffix:semicolon
id|name_len
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|name_len
op_mul_assign
l_int|2
suffix:semicolon
id|pSMB-&gt;OldFileName
(braket
id|name_len
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* pad */
id|pSMB-&gt;OldFileName
(braket
id|name_len
op_plus
l_int|1
)braket
op_assign
l_int|0x04
suffix:semicolon
id|name_len2
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
op_amp
id|pSMB
op_member_access_from_pointer
id|OldFileName
(braket
id|name_len
op_plus
l_int|2
)braket
comma
id|toName
comma
l_int|530
comma
id|nls_codepage
)paren
suffix:semicolon
id|name_len2
op_add_assign
l_int|1
multiline_comment|/* trailing null */
op_plus
l_int|1
multiline_comment|/* Signature word */
suffix:semicolon
id|name_len2
op_mul_assign
l_int|2
suffix:semicolon
multiline_comment|/* convert to bytes */
)brace
r_else
(brace
multiline_comment|/* BB improve the check for buffer overruns BB */
id|name_len
op_assign
id|strnlen
c_func
(paren
id|fromName
comma
l_int|530
)paren
suffix:semicolon
id|name_len
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|strncpy
c_func
(paren
id|pSMB-&gt;OldFileName
comma
id|fromName
comma
id|name_len
)paren
suffix:semicolon
id|name_len2
op_assign
id|strnlen
c_func
(paren
id|toName
comma
l_int|530
)paren
suffix:semicolon
id|name_len2
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|pSMB-&gt;OldFileName
(braket
id|name_len
)braket
op_assign
l_int|0x04
suffix:semicolon
multiline_comment|/* 2nd buffer format */
id|strncpy
c_func
(paren
op_amp
id|pSMB-&gt;OldFileName
(braket
id|name_len
op_plus
l_int|1
)braket
comma
id|toName
comma
id|name_len2
)paren
suffix:semicolon
id|name_len2
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|name_len2
op_increment
suffix:semicolon
multiline_comment|/* signature byte */
)brace
id|count
op_assign
l_int|1
multiline_comment|/* string type byte */
op_plus
id|name_len
op_plus
id|name_len2
suffix:semicolon
id|pSMB-&gt;hdr.smb_buf_length
op_add_assign
id|count
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
id|cpu_to_le16
c_func
(paren
id|count
)paren
suffix:semicolon
id|rc
op_assign
id|SendReceive
c_func
(paren
id|xid
comma
id|tcon-&gt;ses
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMB
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMBr
comma
op_amp
id|bytes_returned
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Send error in hard link (NT rename) = %d&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pSMB
)paren
id|cifs_buf_release
c_func
(paren
id|pSMB
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
op_minus
id|EAGAIN
)paren
r_goto
id|winCreateHardLinkRetry
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_int
DECL|function|CIFSSMBUnixQuerySymLink
id|CIFSSMBUnixQuerySymLink
c_func
(paren
r_const
r_int
id|xid
comma
r_struct
id|cifsTconInfo
op_star
id|tcon
comma
r_const
r_int
r_char
op_star
id|searchName
comma
r_char
op_star
id|symlinkinfo
comma
r_const
r_int
id|buflen
comma
r_const
r_struct
id|nls_table
op_star
id|nls_codepage
)paren
(brace
multiline_comment|/* SMB_QUERY_FILE_UNIX_LINK */
id|TRANSACTION2_QPI_REQ
op_star
id|pSMB
op_assign
l_int|NULL
suffix:semicolon
id|TRANSACTION2_QPI_RSP
op_star
id|pSMBr
op_assign
l_int|NULL
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|bytes_returned
suffix:semicolon
r_int
id|name_len
suffix:semicolon
id|__u16
id|params
comma
id|byte_count
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;In QPathSymLinkInfo (Unix) for path %s&quot;
comma
id|searchName
)paren
)paren
suffix:semicolon
id|querySymLinkRetry
suffix:colon
id|rc
op_assign
id|smb_init
c_func
(paren
id|SMB_COM_TRANSACTION2
comma
l_int|15
comma
id|tcon
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMB
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMBr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|pSMB-&gt;hdr.Flags2
op_amp
id|SMBFLG2_UNICODE
)paren
(brace
id|name_len
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|pSMB-&gt;FileName
comma
id|searchName
comma
l_int|530
multiline_comment|/* find define for this maxpathcomponent */
comma
id|nls_codepage
)paren
suffix:semicolon
id|name_len
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|name_len
op_mul_assign
l_int|2
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* BB improve the check for buffer overruns BB */
id|name_len
op_assign
id|strnlen
c_func
(paren
id|searchName
comma
l_int|530
)paren
suffix:semicolon
id|name_len
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|strncpy
c_func
(paren
id|pSMB-&gt;FileName
comma
id|searchName
comma
id|name_len
)paren
suffix:semicolon
)brace
id|params
op_assign
l_int|2
multiline_comment|/* level */
op_plus
l_int|4
multiline_comment|/* rsrvd */
op_plus
id|name_len
multiline_comment|/* incl null */
suffix:semicolon
id|pSMB-&gt;TotalDataCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;MaxParameterCount
op_assign
id|cpu_to_le16
c_func
(paren
l_int|2
)paren
suffix:semicolon
multiline_comment|/* BB find exact max data count below from sess structure BB */
id|pSMB-&gt;MaxDataCount
op_assign
id|cpu_to_le16
c_func
(paren
l_int|4000
)paren
suffix:semicolon
id|pSMB-&gt;MaxSetupCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Flags
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Timeout
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved2
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;ParameterOffset
op_assign
id|cpu_to_le16
c_func
(paren
m_offsetof
(paren
r_struct
id|smb_com_transaction2_qpi_req
comma
id|InformationLevel
)paren
op_minus
l_int|4
)paren
suffix:semicolon
id|pSMB-&gt;DataCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;DataOffset
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;SetupCount
op_assign
l_int|1
suffix:semicolon
id|pSMB-&gt;Reserved3
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;SubCommand
op_assign
id|cpu_to_le16
c_func
(paren
id|TRANS2_QUERY_PATH_INFORMATION
)paren
suffix:semicolon
id|byte_count
op_assign
id|params
op_plus
l_int|1
multiline_comment|/* pad */
suffix:semicolon
id|pSMB-&gt;TotalParameterCount
op_assign
id|cpu_to_le16
c_func
(paren
id|params
)paren
suffix:semicolon
id|pSMB-&gt;ParameterCount
op_assign
id|pSMB-&gt;TotalParameterCount
suffix:semicolon
id|pSMB-&gt;InformationLevel
op_assign
id|cpu_to_le16
c_func
(paren
id|SMB_QUERY_FILE_UNIX_LINK
)paren
suffix:semicolon
id|pSMB-&gt;Reserved4
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;hdr.smb_buf_length
op_add_assign
id|byte_count
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
id|cpu_to_le16
c_func
(paren
id|byte_count
)paren
suffix:semicolon
id|rc
op_assign
id|SendReceive
c_func
(paren
id|xid
comma
id|tcon-&gt;ses
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMB
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMBr
comma
op_amp
id|bytes_returned
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Send error in QuerySymLinkInfo = %d&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* decode response */
id|rc
op_assign
id|validate_t2
c_func
(paren
(paren
r_struct
id|smb_t2_rsp
op_star
)paren
id|pSMBr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_logical_or
(paren
id|pSMBr-&gt;ByteCount
OL
l_int|2
)paren
)paren
multiline_comment|/* BB also check enough total bytes returned */
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
multiline_comment|/* bad smb */
r_else
(brace
id|__u16
id|data_offset
op_assign
id|le16_to_cpu
c_func
(paren
id|pSMBr-&gt;t2.DataOffset
)paren
suffix:semicolon
id|__u16
id|count
op_assign
id|le16_to_cpu
c_func
(paren
id|pSMBr-&gt;t2.DataCount
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pSMBr-&gt;hdr.Flags2
op_amp
id|SMBFLG2_UNICODE
)paren
(brace
id|name_len
op_assign
id|UniStrnlen
c_func
(paren
(paren
m_wchar_t
op_star
)paren
(paren
(paren
r_char
op_star
)paren
op_amp
id|pSMBr-&gt;hdr.Protocol
op_plus
id|data_offset
)paren
comma
id|min_t
c_func
(paren
r_const
r_int
comma
id|buflen
comma
id|count
)paren
op_div
l_int|2
)paren
suffix:semicolon
id|cifs_strfromUCS_le
c_func
(paren
id|symlinkinfo
comma
(paren
m_wchar_t
op_star
)paren
(paren
(paren
r_char
op_star
)paren
op_amp
id|pSMBr-&gt;hdr.Protocol
op_plus
id|data_offset
)paren
comma
id|name_len
comma
id|nls_codepage
)paren
suffix:semicolon
)brace
r_else
(brace
id|strncpy
c_func
(paren
id|symlinkinfo
comma
(paren
r_char
op_star
)paren
op_amp
id|pSMBr-&gt;hdr.Protocol
op_plus
id|data_offset
comma
id|min_t
c_func
(paren
r_const
r_int
comma
id|buflen
comma
id|count
)paren
)paren
suffix:semicolon
)brace
id|symlinkinfo
(braket
id|buflen
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* just in case so calling code does not go off the end of buffer */
)brace
)brace
r_if
c_cond
(paren
id|pSMB
)paren
id|cifs_buf_release
c_func
(paren
id|pSMB
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
op_minus
id|EAGAIN
)paren
r_goto
id|querySymLinkRetry
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_int
DECL|function|CIFSSMBQueryReparseLinkInfo
id|CIFSSMBQueryReparseLinkInfo
c_func
(paren
r_const
r_int
id|xid
comma
r_struct
id|cifsTconInfo
op_star
id|tcon
comma
r_const
r_int
r_char
op_star
id|searchName
comma
r_char
op_star
id|symlinkinfo
comma
r_const
r_int
id|buflen
comma
id|__u16
id|fid
comma
r_const
r_struct
id|nls_table
op_star
id|nls_codepage
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|bytes_returned
suffix:semicolon
r_int
id|name_len
suffix:semicolon
r_struct
id|smb_com_transaction_ioctl_req
op_star
id|pSMB
suffix:semicolon
r_struct
id|smb_com_transaction_ioctl_rsp
op_star
id|pSMBr
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;In Windows reparse style QueryLink for path %s&quot;
comma
id|searchName
)paren
)paren
suffix:semicolon
id|rc
op_assign
id|smb_init
c_func
(paren
id|SMB_COM_NT_TRANSACT
comma
l_int|23
comma
id|tcon
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMB
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMBr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
id|pSMB-&gt;TotalParameterCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;TotalDataCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;MaxParameterCount
op_assign
id|cpu_to_le32
c_func
(paren
l_int|2
)paren
suffix:semicolon
multiline_comment|/* BB find exact data count max from sess structure BB */
id|pSMB-&gt;MaxDataCount
op_assign
id|cpu_to_le32
c_func
(paren
l_int|4000
)paren
suffix:semicolon
id|pSMB-&gt;MaxSetupCount
op_assign
l_int|4
suffix:semicolon
id|pSMB-&gt;Reserved
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;ParameterOffset
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;DataCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;DataOffset
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;SetupCount
op_assign
l_int|4
suffix:semicolon
id|pSMB-&gt;SubCommand
op_assign
id|cpu_to_le16
c_func
(paren
id|NT_TRANSACT_IOCTL
)paren
suffix:semicolon
id|pSMB-&gt;ParameterCount
op_assign
id|pSMB-&gt;TotalParameterCount
suffix:semicolon
id|pSMB-&gt;FunctionCode
op_assign
id|cpu_to_le32
c_func
(paren
id|FSCTL_GET_REPARSE_POINT
)paren
suffix:semicolon
id|pSMB-&gt;IsFsctl
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* FSCTL */
id|pSMB-&gt;IsRootFlag
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Fid
op_assign
id|fid
suffix:semicolon
multiline_comment|/* file handle always le */
id|pSMB-&gt;ByteCount
op_assign
l_int|0
suffix:semicolon
id|rc
op_assign
id|SendReceive
c_func
(paren
id|xid
comma
id|tcon-&gt;ses
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMB
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMBr
comma
op_amp
id|bytes_returned
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Send error in QueryReparseLinkInfo = %d&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* decode response */
id|__u32
id|data_offset
op_assign
id|le32_to_cpu
c_func
(paren
id|pSMBr-&gt;DataOffset
)paren
suffix:semicolon
id|__u32
id|data_count
op_assign
id|le32_to_cpu
c_func
(paren
id|pSMBr-&gt;DataCount
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pSMBr-&gt;ByteCount
OL
l_int|2
)paren
op_logical_or
(paren
id|data_offset
OG
l_int|512
)paren
)paren
multiline_comment|/* BB also check enough total bytes returned */
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
multiline_comment|/* bad smb */
r_else
(brace
r_if
c_cond
(paren
id|data_count
op_logical_and
(paren
id|data_count
OL
l_int|2048
)paren
)paren
(brace
multiline_comment|/* could also validate reparse tag &amp;&amp; better check name length */
r_struct
id|reparse_data
op_star
id|reparse_buf
op_assign
(paren
r_struct
id|reparse_data
op_star
)paren
(paren
(paren
r_char
op_star
)paren
op_amp
id|pSMBr-&gt;hdr.Protocol
op_plus
id|data_offset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pSMBr-&gt;hdr.Flags2
op_amp
id|SMBFLG2_UNICODE
)paren
(brace
id|name_len
op_assign
id|UniStrnlen
c_func
(paren
(paren
m_wchar_t
op_star
)paren
(paren
id|reparse_buf-&gt;LinkNamesBuf
op_plus
id|reparse_buf-&gt;TargetNameOffset
)paren
comma
id|min
c_func
(paren
id|buflen
op_div
l_int|2
comma
id|reparse_buf-&gt;TargetNameLen
op_div
l_int|2
)paren
)paren
suffix:semicolon
id|cifs_strfromUCS_le
c_func
(paren
id|symlinkinfo
comma
(paren
m_wchar_t
op_star
)paren
(paren
id|reparse_buf-&gt;LinkNamesBuf
op_plus
id|reparse_buf-&gt;TargetNameOffset
)paren
comma
id|name_len
comma
id|nls_codepage
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* ASCII names */
id|strncpy
c_func
(paren
id|symlinkinfo
comma
id|reparse_buf-&gt;LinkNamesBuf
op_plus
id|reparse_buf-&gt;TargetNameOffset
comma
id|min_t
c_func
(paren
r_const
r_int
comma
id|buflen
comma
id|reparse_buf-&gt;TargetNameLen
)paren
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Invalid return data count on get reparse info ioctl&quot;
)paren
)paren
suffix:semicolon
)brace
id|symlinkinfo
(braket
id|buflen
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* just in case so the caller&n;&t;&t;&t;&t;&t;does not go off the end of the buffer */
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;readlink result - %s &quot;
comma
id|symlinkinfo
)paren
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|pSMB
)paren
id|cifs_buf_release
c_func
(paren
id|pSMB
)paren
suffix:semicolon
multiline_comment|/* Note: On -EAGAIN error only caller can retry on handle based calls&n;&t;&t;since file handle passed in no longer valid */
r_return
id|rc
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_CIFS_POSIX
multiline_comment|/*Convert an Access Control Entry from wire format to local POSIX xattr format*/
DECL|function|cifs_convert_ace
r_static
r_void
id|cifs_convert_ace
c_func
(paren
id|posix_acl_xattr_entry
op_star
id|ace
comma
r_struct
id|cifs_posix_ace
op_star
id|cifs_ace
)paren
(brace
multiline_comment|/* u8 cifs fields do not need le conversion */
id|ace-&gt;e_perm
op_assign
(paren
id|__u16
)paren
id|cifs_ace-&gt;cifs_e_perm
suffix:semicolon
id|ace-&gt;e_tag
op_assign
(paren
id|__u16
)paren
id|cifs_ace-&gt;cifs_e_tag
suffix:semicolon
id|ace-&gt;e_id
op_assign
(paren
id|__u32
)paren
id|le64_to_cpu
c_func
(paren
id|cifs_ace-&gt;cifs_uid
)paren
suffix:semicolon
multiline_comment|/* cFYI(1,(&quot;perm %d tag %d id %d&quot;,ace-&gt;e_perm,ace-&gt;e_tag,ace-&gt;e_id)); */
r_return
suffix:semicolon
)brace
multiline_comment|/* Convert ACL from CIFS POSIX wire format to local Linux POSIX ACL xattr */
DECL|function|cifs_copy_posix_acl
r_static
r_int
id|cifs_copy_posix_acl
c_func
(paren
r_char
op_star
id|trgt
comma
r_char
op_star
id|src
comma
r_const
r_int
id|buflen
comma
r_const
r_int
id|acl_type
comma
r_const
r_int
id|size_of_data_area
)paren
(brace
r_int
id|size
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
id|__u16
id|count
suffix:semicolon
r_struct
id|cifs_posix_ace
op_star
id|pACE
suffix:semicolon
r_struct
id|cifs_posix_acl
op_star
id|cifs_acl
op_assign
(paren
r_struct
id|cifs_posix_acl
op_star
)paren
id|src
suffix:semicolon
id|posix_acl_xattr_header
op_star
id|local_acl
op_assign
(paren
id|posix_acl_xattr_header
op_star
)paren
id|trgt
suffix:semicolon
r_if
c_cond
(paren
id|le16_to_cpu
c_func
(paren
id|cifs_acl-&gt;version
)paren
op_ne
id|CIFS_ACL_VERSION
)paren
r_return
op_minus
id|EOPNOTSUPP
suffix:semicolon
r_if
c_cond
(paren
id|acl_type
op_amp
id|ACL_TYPE_ACCESS
)paren
(brace
id|count
op_assign
id|le16_to_cpu
c_func
(paren
id|cifs_acl-&gt;access_entry_count
)paren
suffix:semicolon
id|pACE
op_assign
op_amp
id|cifs_acl-&gt;ace_array
(braket
l_int|0
)braket
suffix:semicolon
id|size
op_assign
r_sizeof
(paren
r_struct
id|cifs_posix_acl
)paren
suffix:semicolon
id|size
op_add_assign
r_sizeof
(paren
r_struct
id|cifs_posix_ace
)paren
op_star
id|count
suffix:semicolon
multiline_comment|/* check if we would go beyond end of SMB */
r_if
c_cond
(paren
id|size_of_data_area
OL
id|size
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;bad CIFS POSIX ACL size %d vs. %d&quot;
comma
id|size_of_data_area
comma
id|size
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|acl_type
op_amp
id|ACL_TYPE_DEFAULT
)paren
(brace
id|count
op_assign
id|le16_to_cpu
c_func
(paren
id|cifs_acl-&gt;access_entry_count
)paren
suffix:semicolon
id|size
op_assign
r_sizeof
(paren
r_struct
id|cifs_posix_acl
)paren
suffix:semicolon
id|size
op_add_assign
r_sizeof
(paren
r_struct
id|cifs_posix_ace
)paren
op_star
id|count
suffix:semicolon
multiline_comment|/* skip past access ACEs to get to default ACEs */
id|pACE
op_assign
op_amp
id|cifs_acl-&gt;ace_array
(braket
id|count
)braket
suffix:semicolon
id|count
op_assign
id|le16_to_cpu
c_func
(paren
id|cifs_acl-&gt;default_entry_count
)paren
suffix:semicolon
id|size
op_add_assign
r_sizeof
(paren
r_struct
id|cifs_posix_ace
)paren
op_star
id|count
suffix:semicolon
multiline_comment|/* check if we would go beyond end of SMB */
r_if
c_cond
(paren
id|size_of_data_area
OL
id|size
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* illegal type */
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|size
op_assign
id|posix_acl_xattr_size
c_func
(paren
id|count
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|buflen
op_eq
l_int|0
)paren
op_logical_or
(paren
id|local_acl
op_eq
l_int|NULL
)paren
)paren
(brace
multiline_comment|/* used to query ACL EA size */
)brace
r_else
r_if
c_cond
(paren
id|size
OG
id|buflen
)paren
(brace
r_return
op_minus
id|ERANGE
suffix:semicolon
)brace
r_else
multiline_comment|/* buffer big enough */
(brace
id|local_acl-&gt;a_version
op_assign
id|POSIX_ACL_XATTR_VERSION
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|cifs_convert_ace
c_func
(paren
op_amp
id|local_acl-&gt;a_entries
(braket
id|i
)braket
comma
id|pACE
)paren
suffix:semicolon
id|pACE
op_increment
suffix:semicolon
)brace
)brace
r_return
id|size
suffix:semicolon
)brace
DECL|function|convert_ace_to_cifs_ace
id|__u16
id|convert_ace_to_cifs_ace
c_func
(paren
r_struct
id|cifs_posix_ace
op_star
id|cifs_ace
comma
r_const
id|posix_acl_xattr_entry
op_star
id|local_ace
)paren
(brace
id|__u16
id|rc
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* 0 = ACL converted ok */
id|cifs_ace-&gt;cifs_e_perm
op_assign
(paren
id|__u8
)paren
id|cpu_to_le16
c_func
(paren
id|local_ace-&gt;e_perm
)paren
suffix:semicolon
id|cifs_ace-&gt;cifs_e_tag
op_assign
(paren
id|__u8
)paren
id|cpu_to_le16
c_func
(paren
id|local_ace-&gt;e_tag
)paren
suffix:semicolon
multiline_comment|/* BB is there a better way to handle the large uid? */
r_if
c_cond
(paren
id|local_ace-&gt;e_id
op_eq
op_minus
l_int|1
)paren
(brace
multiline_comment|/* Probably no need to le convert -1 on any arch but can not hurt */
id|cifs_ace-&gt;cifs_uid
op_assign
id|cpu_to_le64
c_func
(paren
op_minus
l_int|1
)paren
suffix:semicolon
)brace
r_else
id|cifs_ace-&gt;cifs_uid
op_assign
(paren
id|__u64
)paren
id|cpu_to_le32
c_func
(paren
id|local_ace-&gt;e_id
)paren
suffix:semicolon
multiline_comment|/*cFYI(1,(&quot;perm %d tag %d id %d&quot;,ace-&gt;e_perm,ace-&gt;e_tag,ace-&gt;e_id));*/
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/* Convert ACL from local Linux POSIX xattr to CIFS POSIX ACL wire format */
DECL|function|ACL_to_cifs_posix
id|__u16
id|ACL_to_cifs_posix
c_func
(paren
r_char
op_star
id|parm_data
comma
r_const
r_char
op_star
id|pACL
comma
r_const
r_int
id|buflen
comma
r_const
r_int
id|acl_type
)paren
(brace
id|__u16
id|rc
op_assign
l_int|0
suffix:semicolon
r_struct
id|cifs_posix_acl
op_star
id|cifs_acl
op_assign
(paren
r_struct
id|cifs_posix_acl
op_star
)paren
id|parm_data
suffix:semicolon
id|posix_acl_xattr_header
op_star
id|local_acl
op_assign
(paren
id|posix_acl_xattr_header
op_star
)paren
id|pACL
suffix:semicolon
r_int
id|count
suffix:semicolon
r_int
id|i
suffix:semicolon
r_if
c_cond
(paren
(paren
id|buflen
op_eq
l_int|0
)paren
op_logical_or
(paren
id|pACL
op_eq
l_int|NULL
)paren
op_logical_or
(paren
id|cifs_acl
op_eq
l_int|NULL
)paren
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
id|count
op_assign
id|posix_acl_xattr_count
c_func
(paren
(paren
r_int
)paren
id|buflen
)paren
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;setting acl with %d entries from buf of length %d and version of %d&quot;
comma
id|count
comma
id|buflen
comma
id|local_acl-&gt;a_version
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|local_acl-&gt;a_version
op_ne
l_int|2
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;unknown POSIX ACL version %d&quot;
comma
id|local_acl-&gt;a_version
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|cifs_acl-&gt;version
op_assign
id|cpu_to_le16
c_func
(paren
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|acl_type
op_eq
id|ACL_TYPE_ACCESS
)paren
(brace
id|cifs_acl-&gt;access_entry_count
op_assign
id|count
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|acl_type
op_eq
id|ACL_TYPE_DEFAULT
)paren
(brace
id|cifs_acl-&gt;default_entry_count
op_assign
id|count
suffix:semicolon
)brace
r_else
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;unknown ACL type %d&quot;
comma
id|acl_type
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|rc
op_assign
id|convert_ace_to_cifs_ace
c_func
(paren
op_amp
id|cifs_acl-&gt;ace_array
(braket
id|i
)braket
comma
op_amp
id|local_acl-&gt;a_entries
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ne
l_int|0
)paren
(brace
multiline_comment|/* ACE not converted */
r_break
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
)paren
(brace
id|rc
op_assign
(paren
id|__u16
)paren
(paren
id|count
op_star
r_sizeof
(paren
r_struct
id|cifs_posix_ace
)paren
)paren
suffix:semicolon
id|rc
op_add_assign
r_sizeof
(paren
r_struct
id|cifs_posix_acl
)paren
suffix:semicolon
multiline_comment|/* BB add check to make sure ACL does not overflow SMB */
)brace
r_return
id|rc
suffix:semicolon
)brace
r_int
DECL|function|CIFSSMBGetPosixACL
id|CIFSSMBGetPosixACL
c_func
(paren
r_const
r_int
id|xid
comma
r_struct
id|cifsTconInfo
op_star
id|tcon
comma
r_const
r_int
r_char
op_star
id|searchName
comma
r_char
op_star
id|acl_inf
comma
r_const
r_int
id|buflen
comma
r_const
r_int
id|acl_type
comma
r_const
r_struct
id|nls_table
op_star
id|nls_codepage
)paren
(brace
multiline_comment|/* SMB_QUERY_POSIX_ACL */
id|TRANSACTION2_QPI_REQ
op_star
id|pSMB
op_assign
l_int|NULL
suffix:semicolon
id|TRANSACTION2_QPI_RSP
op_star
id|pSMBr
op_assign
l_int|NULL
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|bytes_returned
suffix:semicolon
r_int
id|name_len
suffix:semicolon
id|__u16
id|params
comma
id|byte_count
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;In GetPosixACL (Unix) for path %s&quot;
comma
id|searchName
)paren
)paren
suffix:semicolon
id|queryAclRetry
suffix:colon
id|rc
op_assign
id|smb_init
c_func
(paren
id|SMB_COM_TRANSACTION2
comma
l_int|15
comma
id|tcon
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMB
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMBr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|pSMB-&gt;hdr.Flags2
op_amp
id|SMBFLG2_UNICODE
)paren
(brace
id|name_len
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|pSMB-&gt;FileName
comma
id|searchName
comma
l_int|530
multiline_comment|/* BB fixme find define for this maxpathcomponent */
comma
id|nls_codepage
)paren
suffix:semicolon
id|name_len
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|name_len
op_mul_assign
l_int|2
suffix:semicolon
id|pSMB-&gt;FileName
(braket
id|name_len
)braket
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;FileName
(braket
id|name_len
op_plus
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* BB improve the check for buffer overruns BB */
id|name_len
op_assign
id|strnlen
c_func
(paren
id|searchName
comma
l_int|530
multiline_comment|/* BB fixme */
)paren
suffix:semicolon
id|name_len
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|strncpy
c_func
(paren
id|pSMB-&gt;FileName
comma
id|searchName
comma
id|name_len
)paren
suffix:semicolon
)brace
id|params
op_assign
l_int|2
multiline_comment|/* level */
op_plus
l_int|4
multiline_comment|/* rsrvd */
op_plus
id|name_len
multiline_comment|/* incl null */
suffix:semicolon
id|pSMB-&gt;TotalDataCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;MaxParameterCount
op_assign
id|cpu_to_le16
c_func
(paren
l_int|2
)paren
suffix:semicolon
multiline_comment|/* BB find exact max data count below from sess structure BB */
id|pSMB-&gt;MaxDataCount
op_assign
id|cpu_to_le16
c_func
(paren
l_int|4000
)paren
suffix:semicolon
id|pSMB-&gt;MaxSetupCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Flags
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Timeout
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved2
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;ParameterOffset
op_assign
id|cpu_to_le16
c_func
(paren
m_offsetof
(paren
r_struct
id|smb_com_transaction2_qpi_req
comma
id|InformationLevel
)paren
op_minus
l_int|4
)paren
suffix:semicolon
id|pSMB-&gt;DataCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;DataOffset
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;SetupCount
op_assign
l_int|1
suffix:semicolon
id|pSMB-&gt;Reserved3
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;SubCommand
op_assign
id|cpu_to_le16
c_func
(paren
id|TRANS2_QUERY_PATH_INFORMATION
)paren
suffix:semicolon
id|byte_count
op_assign
id|params
op_plus
l_int|1
multiline_comment|/* pad */
suffix:semicolon
id|pSMB-&gt;TotalParameterCount
op_assign
id|cpu_to_le16
c_func
(paren
id|params
)paren
suffix:semicolon
id|pSMB-&gt;ParameterCount
op_assign
id|pSMB-&gt;TotalParameterCount
suffix:semicolon
id|pSMB-&gt;InformationLevel
op_assign
id|cpu_to_le16
c_func
(paren
id|SMB_QUERY_POSIX_ACL
)paren
suffix:semicolon
id|pSMB-&gt;Reserved4
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;hdr.smb_buf_length
op_add_assign
id|byte_count
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
id|cpu_to_le16
c_func
(paren
id|byte_count
)paren
suffix:semicolon
id|rc
op_assign
id|SendReceive
c_func
(paren
id|xid
comma
id|tcon-&gt;ses
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMB
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMBr
comma
op_amp
id|bytes_returned
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Send error in Query POSIX ACL = %d&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* decode response */
id|rc
op_assign
id|validate_t2
c_func
(paren
(paren
r_struct
id|smb_t2_rsp
op_star
)paren
id|pSMBr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_logical_or
(paren
id|pSMBr-&gt;ByteCount
OL
l_int|2
)paren
)paren
multiline_comment|/* BB also check enough total bytes returned */
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
multiline_comment|/* bad smb */
r_else
(brace
id|__u16
id|data_offset
op_assign
id|le16_to_cpu
c_func
(paren
id|pSMBr-&gt;t2.DataOffset
)paren
suffix:semicolon
id|__u16
id|count
op_assign
id|le16_to_cpu
c_func
(paren
id|pSMBr-&gt;t2.DataCount
)paren
suffix:semicolon
id|rc
op_assign
id|cifs_copy_posix_acl
c_func
(paren
id|acl_inf
comma
(paren
r_char
op_star
)paren
op_amp
id|pSMBr-&gt;hdr.Protocol
op_plus
id|data_offset
comma
id|buflen
comma
id|acl_type
comma
id|count
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|pSMB
)paren
id|cifs_buf_release
c_func
(paren
id|pSMB
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
op_minus
id|EAGAIN
)paren
r_goto
id|queryAclRetry
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_int
DECL|function|CIFSSMBSetPosixACL
id|CIFSSMBSetPosixACL
c_func
(paren
r_const
r_int
id|xid
comma
r_struct
id|cifsTconInfo
op_star
id|tcon
comma
r_const
r_int
r_char
op_star
id|fileName
comma
r_const
r_char
op_star
id|local_acl
comma
r_const
r_int
id|buflen
comma
r_const
r_int
id|acl_type
comma
r_const
r_struct
id|nls_table
op_star
id|nls_codepage
)paren
(brace
r_struct
id|smb_com_transaction2_spi_req
op_star
id|pSMB
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|smb_com_transaction2_spi_rsp
op_star
id|pSMBr
op_assign
l_int|NULL
suffix:semicolon
r_char
op_star
id|parm_data
suffix:semicolon
r_int
id|name_len
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|bytes_returned
op_assign
l_int|0
suffix:semicolon
id|__u16
id|params
comma
id|byte_count
comma
id|data_count
comma
id|param_offset
comma
id|offset
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;In SetPosixACL (Unix) for path %s&quot;
comma
id|fileName
)paren
)paren
suffix:semicolon
id|setAclRetry
suffix:colon
id|rc
op_assign
id|smb_init
c_func
(paren
id|SMB_COM_TRANSACTION2
comma
l_int|15
comma
id|tcon
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMB
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMBr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|pSMB-&gt;hdr.Flags2
op_amp
id|SMBFLG2_UNICODE
)paren
(brace
id|name_len
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|pSMB-&gt;FileName
comma
id|fileName
comma
l_int|530
multiline_comment|/* BB fixme find define for this maxpathcomponent */
comma
id|nls_codepage
)paren
suffix:semicolon
id|name_len
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|name_len
op_mul_assign
l_int|2
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* BB improve the check for buffer overruns BB */
id|name_len
op_assign
id|strnlen
c_func
(paren
id|fileName
comma
l_int|530
)paren
suffix:semicolon
id|name_len
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|strncpy
c_func
(paren
id|pSMB-&gt;FileName
comma
id|fileName
comma
id|name_len
)paren
suffix:semicolon
)brace
id|params
op_assign
l_int|6
op_plus
id|name_len
suffix:semicolon
id|pSMB-&gt;MaxParameterCount
op_assign
id|cpu_to_le16
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|pSMB-&gt;MaxDataCount
op_assign
id|cpu_to_le16
c_func
(paren
l_int|1000
)paren
suffix:semicolon
multiline_comment|/* BB find max SMB size from sess */
id|pSMB-&gt;MaxSetupCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Flags
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Timeout
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved2
op_assign
l_int|0
suffix:semicolon
id|param_offset
op_assign
m_offsetof
(paren
r_struct
id|smb_com_transaction2_spi_req
comma
id|InformationLevel
)paren
op_minus
l_int|4
suffix:semicolon
id|offset
op_assign
id|param_offset
op_plus
id|params
suffix:semicolon
id|parm_data
op_assign
(paren
(paren
r_char
op_star
)paren
op_amp
id|pSMB-&gt;hdr.Protocol
)paren
op_plus
id|offset
suffix:semicolon
id|pSMB-&gt;ParameterOffset
op_assign
id|cpu_to_le16
c_func
(paren
id|param_offset
)paren
suffix:semicolon
multiline_comment|/* convert to on the wire format for POSIX ACL */
id|data_count
op_assign
id|ACL_to_cifs_posix
c_func
(paren
id|parm_data
comma
id|local_acl
comma
id|buflen
comma
id|acl_type
)paren
suffix:semicolon
r_if
c_cond
(paren
id|data_count
op_eq
l_int|0
)paren
(brace
id|rc
op_assign
op_minus
id|EOPNOTSUPP
suffix:semicolon
r_goto
id|setACLerrorExit
suffix:semicolon
)brace
id|pSMB-&gt;DataOffset
op_assign
id|cpu_to_le16
c_func
(paren
id|offset
)paren
suffix:semicolon
id|pSMB-&gt;SetupCount
op_assign
l_int|1
suffix:semicolon
id|pSMB-&gt;Reserved3
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;SubCommand
op_assign
id|cpu_to_le16
c_func
(paren
id|TRANS2_SET_PATH_INFORMATION
)paren
suffix:semicolon
id|pSMB-&gt;InformationLevel
op_assign
id|cpu_to_le16
c_func
(paren
id|SMB_SET_POSIX_ACL
)paren
suffix:semicolon
id|byte_count
op_assign
l_int|3
multiline_comment|/* pad */
op_plus
id|params
op_plus
id|data_count
suffix:semicolon
id|pSMB-&gt;DataCount
op_assign
id|cpu_to_le16
c_func
(paren
id|data_count
)paren
suffix:semicolon
id|pSMB-&gt;TotalDataCount
op_assign
id|pSMB-&gt;DataCount
suffix:semicolon
id|pSMB-&gt;ParameterCount
op_assign
id|cpu_to_le16
c_func
(paren
id|params
)paren
suffix:semicolon
id|pSMB-&gt;TotalParameterCount
op_assign
id|pSMB-&gt;ParameterCount
suffix:semicolon
id|pSMB-&gt;Reserved4
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;hdr.smb_buf_length
op_add_assign
id|byte_count
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
id|cpu_to_le16
c_func
(paren
id|byte_count
)paren
suffix:semicolon
id|rc
op_assign
id|SendReceive
c_func
(paren
id|xid
comma
id|tcon-&gt;ses
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMB
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMBr
comma
op_amp
id|bytes_returned
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Set POSIX ACL returned %d&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
)brace
id|setACLerrorExit
suffix:colon
r_if
c_cond
(paren
id|pSMB
)paren
id|cifs_buf_release
c_func
(paren
id|pSMB
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
op_minus
id|EAGAIN
)paren
r_goto
id|setAclRetry
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
macro_line|#endif
r_int
DECL|function|CIFSSMBQPathInfo
id|CIFSSMBQPathInfo
c_func
(paren
r_const
r_int
id|xid
comma
r_struct
id|cifsTconInfo
op_star
id|tcon
comma
r_const
r_int
r_char
op_star
id|searchName
comma
id|FILE_ALL_INFO
op_star
id|pFindData
comma
r_const
r_struct
id|nls_table
op_star
id|nls_codepage
)paren
(brace
multiline_comment|/* level 263 SMB_QUERY_FILE_ALL_INFO */
id|TRANSACTION2_QPI_REQ
op_star
id|pSMB
op_assign
l_int|NULL
suffix:semicolon
id|TRANSACTION2_QPI_RSP
op_star
id|pSMBr
op_assign
l_int|NULL
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|bytes_returned
suffix:semicolon
r_int
id|name_len
suffix:semicolon
id|__u16
id|params
comma
id|byte_count
suffix:semicolon
multiline_comment|/* cFYI(1, (&quot;In QPathInfo path %s&quot;, searchName)); */
multiline_comment|/* BB fixme BB */
id|QPathInfoRetry
suffix:colon
id|rc
op_assign
id|smb_init
c_func
(paren
id|SMB_COM_TRANSACTION2
comma
l_int|15
comma
id|tcon
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMB
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMBr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|pSMB-&gt;hdr.Flags2
op_amp
id|SMBFLG2_UNICODE
)paren
(brace
id|name_len
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|pSMB-&gt;FileName
comma
id|searchName
comma
l_int|530
multiline_comment|/* find define for this maxpathcomponent */
comma
id|nls_codepage
)paren
suffix:semicolon
id|name_len
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|name_len
op_mul_assign
l_int|2
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* BB improve the check for buffer overruns BB */
id|name_len
op_assign
id|strnlen
c_func
(paren
id|searchName
comma
l_int|530
)paren
suffix:semicolon
id|name_len
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|strncpy
c_func
(paren
id|pSMB-&gt;FileName
comma
id|searchName
comma
id|name_len
)paren
suffix:semicolon
)brace
id|params
op_assign
l_int|2
multiline_comment|/* level */
op_plus
l_int|4
multiline_comment|/* reserved */
op_plus
id|name_len
multiline_comment|/* includes NUL */
suffix:semicolon
id|pSMB-&gt;TotalDataCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;MaxParameterCount
op_assign
id|cpu_to_le16
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|pSMB-&gt;MaxDataCount
op_assign
id|cpu_to_le16
c_func
(paren
l_int|4000
)paren
suffix:semicolon
multiline_comment|/* BB find exact max SMB PDU from sess structure BB */
id|pSMB-&gt;MaxSetupCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Flags
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Timeout
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved2
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;ParameterOffset
op_assign
id|cpu_to_le16
c_func
(paren
m_offsetof
(paren
r_struct
id|smb_com_transaction2_qpi_req
comma
id|InformationLevel
)paren
op_minus
l_int|4
)paren
suffix:semicolon
id|pSMB-&gt;DataCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;DataOffset
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;SetupCount
op_assign
l_int|1
suffix:semicolon
id|pSMB-&gt;Reserved3
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;SubCommand
op_assign
id|cpu_to_le16
c_func
(paren
id|TRANS2_QUERY_PATH_INFORMATION
)paren
suffix:semicolon
id|byte_count
op_assign
id|params
op_plus
l_int|1
multiline_comment|/* pad */
suffix:semicolon
id|pSMB-&gt;TotalParameterCount
op_assign
id|cpu_to_le16
c_func
(paren
id|params
)paren
suffix:semicolon
id|pSMB-&gt;ParameterCount
op_assign
id|pSMB-&gt;TotalParameterCount
suffix:semicolon
id|pSMB-&gt;InformationLevel
op_assign
id|cpu_to_le16
c_func
(paren
id|SMB_QUERY_FILE_ALL_INFO
)paren
suffix:semicolon
id|pSMB-&gt;Reserved4
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;hdr.smb_buf_length
op_add_assign
id|byte_count
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
id|cpu_to_le16
c_func
(paren
id|byte_count
)paren
suffix:semicolon
id|rc
op_assign
id|SendReceive
c_func
(paren
id|xid
comma
id|tcon-&gt;ses
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMB
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMBr
comma
op_amp
id|bytes_returned
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Send error in QPathInfo = %d&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* decode response */
id|rc
op_assign
id|validate_t2
c_func
(paren
(paren
r_struct
id|smb_t2_rsp
op_star
)paren
id|pSMBr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_logical_or
(paren
id|pSMBr-&gt;ByteCount
OL
l_int|40
)paren
)paren
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
multiline_comment|/* bad smb */
r_else
r_if
c_cond
(paren
id|pFindData
)paren
(brace
id|__u16
id|data_offset
op_assign
id|le16_to_cpu
c_func
(paren
id|pSMBr-&gt;t2.DataOffset
)paren
suffix:semicolon
id|memcpy
c_func
(paren
(paren
r_char
op_star
)paren
id|pFindData
comma
(paren
r_char
op_star
)paren
op_amp
id|pSMBr-&gt;hdr.Protocol
op_plus
id|data_offset
comma
r_sizeof
(paren
id|FILE_ALL_INFO
)paren
)paren
suffix:semicolon
)brace
r_else
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pSMB
)paren
id|cifs_buf_release
c_func
(paren
id|pSMB
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
op_minus
id|EAGAIN
)paren
r_goto
id|QPathInfoRetry
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_int
DECL|function|CIFSSMBUnixQPathInfo
id|CIFSSMBUnixQPathInfo
c_func
(paren
r_const
r_int
id|xid
comma
r_struct
id|cifsTconInfo
op_star
id|tcon
comma
r_const
r_int
r_char
op_star
id|searchName
comma
id|FILE_UNIX_BASIC_INFO
op_star
id|pFindData
comma
r_const
r_struct
id|nls_table
op_star
id|nls_codepage
)paren
(brace
multiline_comment|/* SMB_QUERY_FILE_UNIX_BASIC */
id|TRANSACTION2_QPI_REQ
op_star
id|pSMB
op_assign
l_int|NULL
suffix:semicolon
id|TRANSACTION2_QPI_RSP
op_star
id|pSMBr
op_assign
l_int|NULL
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|bytes_returned
op_assign
l_int|0
suffix:semicolon
r_int
id|name_len
suffix:semicolon
id|__u16
id|params
comma
id|byte_count
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;In QPathInfo (Unix) the path %s&quot;
comma
id|searchName
)paren
)paren
suffix:semicolon
id|UnixQPathInfoRetry
suffix:colon
id|rc
op_assign
id|smb_init
c_func
(paren
id|SMB_COM_TRANSACTION2
comma
l_int|15
comma
id|tcon
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMB
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMBr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|pSMB-&gt;hdr.Flags2
op_amp
id|SMBFLG2_UNICODE
)paren
(brace
id|name_len
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|pSMB-&gt;FileName
comma
id|searchName
comma
l_int|530
multiline_comment|/* find define for this maxpathcomponent */
comma
id|nls_codepage
)paren
suffix:semicolon
id|name_len
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|name_len
op_mul_assign
l_int|2
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* BB improve the check for buffer overruns BB */
id|name_len
op_assign
id|strnlen
c_func
(paren
id|searchName
comma
l_int|530
)paren
suffix:semicolon
id|name_len
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|strncpy
c_func
(paren
id|pSMB-&gt;FileName
comma
id|searchName
comma
id|name_len
)paren
suffix:semicolon
)brace
id|params
op_assign
l_int|2
multiline_comment|/* level */
op_plus
l_int|4
multiline_comment|/* reserved */
op_plus
id|name_len
multiline_comment|/* includes NUL */
suffix:semicolon
id|pSMB-&gt;TotalDataCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;MaxParameterCount
op_assign
id|cpu_to_le16
c_func
(paren
l_int|2
)paren
suffix:semicolon
multiline_comment|/* BB find exact max SMB PDU from sess structure BB */
id|pSMB-&gt;MaxDataCount
op_assign
id|cpu_to_le16
c_func
(paren
l_int|4000
)paren
suffix:semicolon
id|pSMB-&gt;MaxSetupCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Flags
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Timeout
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved2
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;ParameterOffset
op_assign
id|cpu_to_le16
c_func
(paren
m_offsetof
(paren
r_struct
id|smb_com_transaction2_qpi_req
comma
id|InformationLevel
)paren
op_minus
l_int|4
)paren
suffix:semicolon
id|pSMB-&gt;DataCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;DataOffset
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;SetupCount
op_assign
l_int|1
suffix:semicolon
id|pSMB-&gt;Reserved3
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;SubCommand
op_assign
id|cpu_to_le16
c_func
(paren
id|TRANS2_QUERY_PATH_INFORMATION
)paren
suffix:semicolon
id|byte_count
op_assign
id|params
op_plus
l_int|1
multiline_comment|/* pad */
suffix:semicolon
id|pSMB-&gt;TotalParameterCount
op_assign
id|cpu_to_le16
c_func
(paren
id|params
)paren
suffix:semicolon
id|pSMB-&gt;ParameterCount
op_assign
id|pSMB-&gt;TotalParameterCount
suffix:semicolon
id|pSMB-&gt;InformationLevel
op_assign
id|cpu_to_le16
c_func
(paren
id|SMB_QUERY_FILE_UNIX_BASIC
)paren
suffix:semicolon
id|pSMB-&gt;Reserved4
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;hdr.smb_buf_length
op_add_assign
id|byte_count
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
id|cpu_to_le16
c_func
(paren
id|byte_count
)paren
suffix:semicolon
id|rc
op_assign
id|SendReceive
c_func
(paren
id|xid
comma
id|tcon-&gt;ses
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMB
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMBr
comma
op_amp
id|bytes_returned
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Send error in QPathInfo = %d&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* decode response */
id|rc
op_assign
id|validate_t2
c_func
(paren
(paren
r_struct
id|smb_t2_rsp
op_star
)paren
id|pSMBr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_logical_or
(paren
id|pSMBr-&gt;ByteCount
OL
r_sizeof
(paren
id|FILE_UNIX_BASIC_INFO
)paren
)paren
)paren
(brace
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
multiline_comment|/* bad smb */
)brace
r_else
(brace
id|__u16
id|data_offset
op_assign
id|le16_to_cpu
c_func
(paren
id|pSMBr-&gt;t2.DataOffset
)paren
suffix:semicolon
id|memcpy
c_func
(paren
(paren
r_char
op_star
)paren
id|pFindData
comma
(paren
r_char
op_star
)paren
op_amp
id|pSMBr-&gt;hdr.Protocol
op_plus
id|data_offset
comma
r_sizeof
(paren
id|FILE_UNIX_BASIC_INFO
)paren
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|pSMB
)paren
id|cifs_buf_release
c_func
(paren
id|pSMB
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
op_minus
id|EAGAIN
)paren
r_goto
id|UnixQPathInfoRetry
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_CIFS_EXPERIMENTAL  /* function unused at present */
r_int
DECL|function|CIFSFindSingle
id|CIFSFindSingle
c_func
(paren
r_const
r_int
id|xid
comma
r_struct
id|cifsTconInfo
op_star
id|tcon
comma
r_const
r_char
op_star
id|searchName
comma
id|FILE_ALL_INFO
op_star
id|findData
comma
r_const
r_struct
id|nls_table
op_star
id|nls_codepage
)paren
(brace
multiline_comment|/* level 257 SMB_ */
id|TRANSACTION2_FFIRST_REQ
op_star
id|pSMB
op_assign
l_int|NULL
suffix:semicolon
id|TRANSACTION2_FFIRST_RSP
op_star
id|pSMBr
op_assign
l_int|NULL
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|bytes_returned
suffix:semicolon
r_int
id|name_len
suffix:semicolon
id|__u16
id|params
comma
id|byte_count
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;In FindUnique&quot;
)paren
)paren
suffix:semicolon
id|findUniqueRetry
suffix:colon
id|rc
op_assign
id|smb_init
c_func
(paren
id|SMB_COM_TRANSACTION2
comma
l_int|15
comma
id|tcon
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMB
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMBr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|pSMB-&gt;hdr.Flags2
op_amp
id|SMBFLG2_UNICODE
)paren
(brace
id|name_len
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|pSMB-&gt;FileName
comma
id|searchName
comma
l_int|530
multiline_comment|/* find define for this maxpathcomponent */
comma
id|nls_codepage
)paren
suffix:semicolon
id|name_len
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|name_len
op_mul_assign
l_int|2
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* BB improve the check for buffer overruns BB */
id|name_len
op_assign
id|strnlen
c_func
(paren
id|searchName
comma
l_int|530
)paren
suffix:semicolon
id|name_len
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|strncpy
c_func
(paren
id|pSMB-&gt;FileName
comma
id|searchName
comma
id|name_len
)paren
suffix:semicolon
)brace
id|params
op_assign
l_int|12
op_plus
id|name_len
multiline_comment|/* includes null */
suffix:semicolon
id|pSMB-&gt;TotalDataCount
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* no EAs */
id|pSMB-&gt;MaxParameterCount
op_assign
id|cpu_to_le16
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|pSMB-&gt;MaxDataCount
op_assign
id|cpu_to_le16
c_func
(paren
l_int|4000
)paren
suffix:semicolon
multiline_comment|/* BB find exact max SMB PDU from sess structure BB */
id|pSMB-&gt;MaxSetupCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Flags
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Timeout
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved2
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;ParameterOffset
op_assign
id|cpu_to_le16
c_func
(paren
m_offsetof
(paren
r_struct
id|smb_com_transaction2_ffirst_req
comma
id|InformationLevel
)paren
op_minus
l_int|4
)paren
suffix:semicolon
id|pSMB-&gt;DataCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;DataOffset
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;SetupCount
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* one byte, no need to le convert */
id|pSMB-&gt;Reserved3
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;SubCommand
op_assign
id|cpu_to_le16
c_func
(paren
id|TRANS2_FIND_FIRST
)paren
suffix:semicolon
id|byte_count
op_assign
id|params
op_plus
l_int|1
multiline_comment|/* pad */
suffix:semicolon
id|pSMB-&gt;TotalParameterCount
op_assign
id|cpu_to_le16
c_func
(paren
id|params
)paren
suffix:semicolon
id|pSMB-&gt;ParameterCount
op_assign
id|pSMB-&gt;TotalParameterCount
suffix:semicolon
id|pSMB-&gt;SearchAttributes
op_assign
id|cpu_to_le16
c_func
(paren
id|ATTR_READONLY
op_or
id|ATTR_HIDDEN
op_or
id|ATTR_SYSTEM
op_or
id|ATTR_DIRECTORY
)paren
suffix:semicolon
id|pSMB-&gt;SearchCount
op_assign
id|cpu_to_le16
c_func
(paren
l_int|16
)paren
suffix:semicolon
multiline_comment|/* BB increase */
id|pSMB-&gt;SearchFlags
op_assign
id|cpu_to_le16
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|pSMB-&gt;InformationLevel
op_assign
id|cpu_to_le16
c_func
(paren
id|SMB_FIND_FILE_DIRECTORY_INFO
)paren
suffix:semicolon
id|pSMB-&gt;SearchStorageType
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* BB what should we set this to? BB */
id|pSMB-&gt;hdr.smb_buf_length
op_add_assign
id|byte_count
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
id|cpu_to_le16
c_func
(paren
id|byte_count
)paren
suffix:semicolon
id|rc
op_assign
id|SendReceive
c_func
(paren
id|xid
comma
id|tcon-&gt;ses
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMB
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMBr
comma
op_amp
id|bytes_returned
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Send error in FindFileDirInfo = %d&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* decode response */
multiline_comment|/* BB fill in */
)brace
r_if
c_cond
(paren
id|pSMB
)paren
id|cifs_buf_release
c_func
(paren
id|pSMB
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
op_minus
id|EAGAIN
)paren
r_goto
id|findUniqueRetry
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
macro_line|#endif /* CIFS_EXPERIMENTAL */
r_int
DECL|function|CIFSFindFirst
id|CIFSFindFirst
c_func
(paren
r_const
r_int
id|xid
comma
r_struct
id|cifsTconInfo
op_star
id|tcon
comma
r_const
r_char
op_star
id|searchName
comma
id|FILE_DIRECTORY_INFO
op_star
id|findData
comma
id|T2_FFIRST_RSP_PARMS
op_star
id|findParms
comma
r_const
r_struct
id|nls_table
op_star
id|nls_codepage
comma
r_int
op_star
id|pUnicodeFlag
comma
r_int
op_star
id|pUnixFlag
)paren
(brace
multiline_comment|/* level 257 SMB_ */
id|TRANSACTION2_FFIRST_REQ
op_star
id|pSMB
op_assign
l_int|NULL
suffix:semicolon
id|TRANSACTION2_FFIRST_RSP
op_star
id|pSMBr
op_assign
l_int|NULL
suffix:semicolon
r_char
op_star
id|response_data
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|bytes_returned
suffix:semicolon
r_int
id|name_len
suffix:semicolon
id|__u16
id|params
comma
id|byte_count
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;In FindFirst&quot;
)paren
)paren
suffix:semicolon
id|findFirstRetry
suffix:colon
id|rc
op_assign
id|smb_init
c_func
(paren
id|SMB_COM_TRANSACTION2
comma
l_int|15
comma
id|tcon
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMB
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMBr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|pSMB-&gt;hdr.Flags2
op_amp
id|SMBFLG2_UNICODE
)paren
(brace
id|name_len
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|pSMB-&gt;FileName
comma
id|searchName
comma
l_int|530
multiline_comment|/* find define for this maxpathcomponent */
comma
id|nls_codepage
)paren
suffix:semicolon
id|name_len
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|name_len
op_mul_assign
l_int|2
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* BB improve the check for buffer overruns BB */
id|name_len
op_assign
id|strnlen
c_func
(paren
id|searchName
comma
l_int|530
)paren
suffix:semicolon
id|name_len
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|strncpy
c_func
(paren
id|pSMB-&gt;FileName
comma
id|searchName
comma
id|name_len
)paren
suffix:semicolon
)brace
id|params
op_assign
l_int|12
op_plus
id|name_len
multiline_comment|/* includes null */
suffix:semicolon
id|pSMB-&gt;TotalDataCount
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* no EAs */
id|pSMB-&gt;MaxParameterCount
op_assign
id|cpu_to_le16
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|pSMB-&gt;MaxDataCount
op_assign
id|cpu_to_le16
c_func
(paren
(paren
id|tcon-&gt;ses-&gt;server-&gt;maxBuf
op_minus
id|MAX_CIFS_HDR_SIZE
)paren
op_amp
l_int|0xFFFFFF00
)paren
suffix:semicolon
id|pSMB-&gt;MaxSetupCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Flags
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Timeout
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved2
op_assign
l_int|0
suffix:semicolon
id|byte_count
op_assign
id|params
op_plus
l_int|1
multiline_comment|/* pad */
suffix:semicolon
id|pSMB-&gt;TotalParameterCount
op_assign
id|cpu_to_le16
c_func
(paren
id|params
)paren
suffix:semicolon
id|pSMB-&gt;ParameterCount
op_assign
id|pSMB-&gt;TotalParameterCount
suffix:semicolon
id|pSMB-&gt;ParameterOffset
op_assign
id|cpu_to_le16
c_func
(paren
m_offsetof
(paren
r_struct
id|smb_com_transaction2_ffirst_req
comma
id|SearchAttributes
)paren
op_minus
l_int|4
)paren
suffix:semicolon
id|pSMB-&gt;DataCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;DataOffset
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;SetupCount
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* one byte no need to make endian neutral */
id|pSMB-&gt;Reserved3
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;SubCommand
op_assign
id|cpu_to_le16
c_func
(paren
id|TRANS2_FIND_FIRST
)paren
suffix:semicolon
id|pSMB-&gt;SearchAttributes
op_assign
id|cpu_to_le16
c_func
(paren
id|ATTR_READONLY
op_or
id|ATTR_HIDDEN
op_or
id|ATTR_SYSTEM
op_or
id|ATTR_DIRECTORY
)paren
suffix:semicolon
id|pSMB-&gt;SearchCount
op_assign
id|cpu_to_le16
c_func
(paren
id|CIFS_MAX_MSGSIZE
op_div
r_sizeof
(paren
id|FILE_DIRECTORY_INFO
)paren
)paren
suffix:semicolon
multiline_comment|/* should this be shrunk even more ? */
id|pSMB-&gt;SearchFlags
op_assign
id|cpu_to_le16
c_func
(paren
id|CIFS_SEARCH_CLOSE_AT_END
op_or
id|CIFS_SEARCH_RETURN_RESUME
)paren
suffix:semicolon
multiline_comment|/* test for Unix extensions */
r_if
c_cond
(paren
id|tcon-&gt;ses-&gt;capabilities
op_amp
id|CAP_UNIX
)paren
(brace
id|pSMB-&gt;InformationLevel
op_assign
id|cpu_to_le16
c_func
(paren
id|SMB_FIND_FILE_UNIX
)paren
suffix:semicolon
op_star
id|pUnixFlag
op_assign
id|TRUE
suffix:semicolon
)brace
r_else
(brace
id|pSMB-&gt;InformationLevel
op_assign
id|cpu_to_le16
c_func
(paren
id|SMB_FIND_FILE_DIRECTORY_INFO
)paren
suffix:semicolon
op_star
id|pUnixFlag
op_assign
id|FALSE
suffix:semicolon
)brace
id|pSMB-&gt;SearchStorageType
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* BB what should we set this to? It is not clear if it matters BB */
id|pSMB-&gt;hdr.smb_buf_length
op_add_assign
id|byte_count
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
id|cpu_to_le16
c_func
(paren
id|byte_count
)paren
suffix:semicolon
id|rc
op_assign
id|SendReceive
c_func
(paren
id|xid
comma
id|tcon-&gt;ses
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMB
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMBr
comma
op_amp
id|bytes_returned
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
multiline_comment|/* BB add logic to retry regular search if Unix search rejected unexpectedly by server */
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Error in FindFirst = %d&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|rc
op_assign
id|validate_t2
c_func
(paren
(paren
r_struct
id|smb_t2_rsp
op_star
)paren
id|pSMBr
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rc
)paren
(brace
multiline_comment|/* decode response */
multiline_comment|/* BB add safety checks for these memcpys */
r_if
c_cond
(paren
id|pSMBr-&gt;hdr.Flags2
op_amp
id|SMBFLG2_UNICODE
)paren
op_star
id|pUnicodeFlag
op_assign
id|TRUE
suffix:semicolon
r_else
op_star
id|pUnicodeFlag
op_assign
id|FALSE
suffix:semicolon
id|memcpy
c_func
(paren
id|findParms
comma
(paren
r_char
op_star
)paren
op_amp
id|pSMBr-&gt;hdr.Protocol
op_plus
id|le16_to_cpu
c_func
(paren
id|pSMBr-&gt;t2.ParameterOffset
)paren
comma
r_sizeof
(paren
id|T2_FFIRST_RSP_PARMS
)paren
)paren
suffix:semicolon
id|response_data
op_assign
(paren
r_char
op_star
)paren
op_amp
id|pSMBr-&gt;hdr.Protocol
op_plus
id|le16_to_cpu
c_func
(paren
id|pSMBr-&gt;t2.DataOffset
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|findData
comma
id|response_data
comma
id|le16_to_cpu
c_func
(paren
id|pSMBr-&gt;t2.DataCount
)paren
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|pSMB
)paren
id|cifs_buf_release
c_func
(paren
id|pSMB
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
op_minus
id|EAGAIN
)paren
r_goto
id|findFirstRetry
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/* xid, tcon, searchName and codepage are input parms, rest are returned */
r_int
DECL|function|CIFSFindFirst2
id|CIFSFindFirst2
c_func
(paren
r_const
r_int
id|xid
comma
r_struct
id|cifsTconInfo
op_star
id|tcon
comma
r_const
r_char
op_star
id|searchName
comma
r_const
r_struct
id|nls_table
op_star
id|nls_codepage
comma
id|__u16
op_star
id|pnetfid
comma
r_struct
id|cifs_search_info
op_star
id|psrch_inf
)paren
(brace
multiline_comment|/* level 257 SMB_ */
id|TRANSACTION2_FFIRST_REQ
op_star
id|pSMB
op_assign
l_int|NULL
suffix:semicolon
id|TRANSACTION2_FFIRST_RSP
op_star
id|pSMBr
op_assign
l_int|NULL
suffix:semicolon
id|T2_FFIRST_RSP_PARMS
op_star
id|parms
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|bytes_returned
op_assign
l_int|0
suffix:semicolon
r_int
id|name_len
suffix:semicolon
id|__u16
id|params
comma
id|byte_count
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;In FindFirst2&quot;
)paren
)paren
suffix:semicolon
id|findFirst2Retry
suffix:colon
id|rc
op_assign
id|smb_init
c_func
(paren
id|SMB_COM_TRANSACTION2
comma
l_int|15
comma
id|tcon
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMB
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMBr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|pSMB-&gt;hdr.Flags2
op_amp
id|SMBFLG2_UNICODE
)paren
(brace
id|name_len
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|pSMB-&gt;FileName
comma
id|searchName
comma
id|PATH_MAX
comma
id|nls_codepage
)paren
suffix:semicolon
id|name_len
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|name_len
op_mul_assign
l_int|2
suffix:semicolon
id|pSMB-&gt;FileName
(braket
id|name_len
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* null terminate just in case */
id|pSMB-&gt;FileName
(braket
id|name_len
op_plus
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* BB add check for overrun of SMB buf BB */
id|name_len
op_assign
id|strnlen
c_func
(paren
id|searchName
comma
id|PATH_MAX
)paren
suffix:semicolon
id|name_len
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
multiline_comment|/* BB fix here and in unicode clause above ie&n;&t;&t;if(name_len &gt; buffersize-header)&n;&t;&t;&t;free buffer exit; BB */
id|strncpy
c_func
(paren
id|pSMB-&gt;FileName
comma
id|searchName
comma
id|name_len
)paren
suffix:semicolon
id|pSMB-&gt;FileName
(braket
id|name_len
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* just in case */
)brace
id|params
op_assign
l_int|12
op_plus
id|name_len
multiline_comment|/* includes null */
suffix:semicolon
id|pSMB-&gt;TotalDataCount
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* no EAs */
id|pSMB-&gt;MaxParameterCount
op_assign
id|cpu_to_le16
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|pSMB-&gt;MaxDataCount
op_assign
id|cpu_to_le16
c_func
(paren
(paren
id|tcon-&gt;ses-&gt;server-&gt;maxBuf
op_minus
id|MAX_CIFS_HDR_SIZE
)paren
op_amp
l_int|0xFFFFFF00
)paren
suffix:semicolon
id|pSMB-&gt;MaxSetupCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Flags
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Timeout
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved2
op_assign
l_int|0
suffix:semicolon
id|byte_count
op_assign
id|params
op_plus
l_int|1
multiline_comment|/* pad */
suffix:semicolon
id|pSMB-&gt;TotalParameterCount
op_assign
id|cpu_to_le16
c_func
(paren
id|params
)paren
suffix:semicolon
id|pSMB-&gt;ParameterCount
op_assign
id|pSMB-&gt;TotalParameterCount
suffix:semicolon
id|pSMB-&gt;ParameterOffset
op_assign
id|cpu_to_le16
c_func
(paren
m_offsetof
(paren
r_struct
id|smb_com_transaction2_ffirst_req
comma
id|SearchAttributes
)paren
op_minus
l_int|4
)paren
suffix:semicolon
id|pSMB-&gt;DataCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;DataOffset
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;SetupCount
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* one byte, no need to make endian neutral */
id|pSMB-&gt;Reserved3
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;SubCommand
op_assign
id|cpu_to_le16
c_func
(paren
id|TRANS2_FIND_FIRST
)paren
suffix:semicolon
id|pSMB-&gt;SearchAttributes
op_assign
id|cpu_to_le16
c_func
(paren
id|ATTR_READONLY
op_or
id|ATTR_HIDDEN
op_or
id|ATTR_SYSTEM
op_or
id|ATTR_DIRECTORY
)paren
suffix:semicolon
id|pSMB-&gt;SearchCount
op_assign
id|cpu_to_le16
c_func
(paren
id|CIFS_MAX_MSGSIZE
op_div
r_sizeof
(paren
id|FILE_UNIX_INFO
)paren
)paren
suffix:semicolon
id|pSMB-&gt;SearchFlags
op_assign
id|cpu_to_le16
c_func
(paren
id|CIFS_SEARCH_CLOSE_AT_END
op_or
id|CIFS_SEARCH_RETURN_RESUME
)paren
suffix:semicolon
id|pSMB-&gt;InformationLevel
op_assign
id|cpu_to_le16
c_func
(paren
id|psrch_inf-&gt;info_level
)paren
suffix:semicolon
multiline_comment|/* BB what should we set StorageType to? Does it matter? BB */
id|pSMB-&gt;SearchStorageType
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;hdr.smb_buf_length
op_add_assign
id|byte_count
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
id|cpu_to_le16
c_func
(paren
id|byte_count
)paren
suffix:semicolon
id|rc
op_assign
id|SendReceive
c_func
(paren
id|xid
comma
id|tcon-&gt;ses
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMB
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMBr
comma
op_amp
id|bytes_returned
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
multiline_comment|/* BB add logic to retry regular search if Unix search rejected unexpectedly by server */
multiline_comment|/* BB Add code to handle unsupported level rc */
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Error in FindFirst = %d&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pSMB
)paren
id|cifs_buf_release
c_func
(paren
id|pSMB
)paren
suffix:semicolon
multiline_comment|/* BB eventually could optimize out free and realloc of buf */
multiline_comment|/*    for this case */
r_if
c_cond
(paren
id|rc
op_eq
op_minus
id|EAGAIN
)paren
r_goto
id|findFirst2Retry
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* decode response */
multiline_comment|/* BB remember to free buffer if error BB */
id|rc
op_assign
id|validate_t2
c_func
(paren
(paren
r_struct
id|smb_t2_rsp
op_star
)paren
id|pSMBr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|pSMBr-&gt;hdr.Flags2
op_amp
id|SMBFLG2_UNICODE
)paren
id|psrch_inf-&gt;unicode
op_assign
id|TRUE
suffix:semicolon
r_else
id|psrch_inf-&gt;unicode
op_assign
id|FALSE
suffix:semicolon
id|psrch_inf-&gt;ntwrk_buf_start
op_assign
(paren
r_char
op_star
)paren
id|pSMBr
suffix:semicolon
id|psrch_inf-&gt;srch_entries_start
op_assign
(paren
r_char
op_star
)paren
op_amp
id|pSMBr-&gt;hdr.Protocol
op_plus
id|le16_to_cpu
c_func
(paren
id|pSMBr-&gt;t2.DataOffset
)paren
suffix:semicolon
id|parms
op_assign
(paren
id|T2_FFIRST_RSP_PARMS
op_star
)paren
(paren
(paren
r_char
op_star
)paren
op_amp
id|pSMBr-&gt;hdr.Protocol
op_plus
id|le16_to_cpu
c_func
(paren
id|pSMBr-&gt;t2.ParameterOffset
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|parms-&gt;EndofSearch
)paren
(brace
id|psrch_inf-&gt;endOfSearch
op_assign
id|TRUE
suffix:semicolon
)brace
r_else
id|psrch_inf-&gt;endOfSearch
op_assign
id|FALSE
suffix:semicolon
id|psrch_inf-&gt;entries_in_buffer
op_assign
id|le16_to_cpu
c_func
(paren
id|parms-&gt;SearchCount
)paren
suffix:semicolon
id|psrch_inf-&gt;index_of_last_entry
op_assign
id|psrch_inf-&gt;entries_in_buffer
suffix:semicolon
multiline_comment|/*cFYI(1,(&quot;entries in buf %d index_of_last %d&quot;,psrch_inf-&gt;entries_in_buffer,psrch_inf-&gt;index_of_last_entry));  */
op_star
id|pnetfid
op_assign
id|parms-&gt;SearchHandle
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|pSMB
)paren
(brace
id|cifs_buf_release
c_func
(paren
id|pSMB
)paren
suffix:semicolon
)brace
)brace
)brace
r_return
id|rc
suffix:semicolon
)brace
DECL|function|CIFSFindNext2
r_int
id|CIFSFindNext2
c_func
(paren
r_const
r_int
id|xid
comma
r_struct
id|cifsTconInfo
op_star
id|tcon
comma
id|__u16
id|searchHandle
comma
r_struct
id|cifs_search_info
op_star
id|psrch_inf
)paren
(brace
id|TRANSACTION2_FNEXT_REQ
op_star
id|pSMB
op_assign
l_int|NULL
suffix:semicolon
id|TRANSACTION2_FNEXT_RSP
op_star
id|pSMBr
op_assign
l_int|NULL
suffix:semicolon
id|T2_FNEXT_RSP_PARMS
op_star
id|parms
suffix:semicolon
r_char
op_star
id|response_data
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|bytes_returned
comma
id|name_len
suffix:semicolon
id|__u16
id|params
comma
id|byte_count
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;In FindNext2&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|psrch_inf-&gt;endOfSearch
op_eq
id|TRUE
)paren
(brace
r_return
op_minus
id|ENOENT
suffix:semicolon
)brace
id|rc
op_assign
id|smb_init
c_func
(paren
id|SMB_COM_TRANSACTION2
comma
l_int|15
comma
id|tcon
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMB
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMBr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
id|params
op_assign
l_int|14
suffix:semicolon
multiline_comment|/* includes 2 bytes of null string, converted to LE below */
id|byte_count
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;TotalDataCount
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* no EAs */
id|pSMB-&gt;MaxParameterCount
op_assign
id|cpu_to_le16
c_func
(paren
l_int|8
)paren
suffix:semicolon
id|pSMB-&gt;MaxDataCount
op_assign
id|cpu_to_le16
c_func
(paren
(paren
id|tcon-&gt;ses-&gt;server-&gt;maxBuf
op_minus
id|MAX_CIFS_HDR_SIZE
)paren
op_amp
l_int|0xFFFFFF00
)paren
suffix:semicolon
id|pSMB-&gt;MaxSetupCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Flags
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Timeout
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved2
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;ParameterOffset
op_assign
id|cpu_to_le16
c_func
(paren
m_offsetof
(paren
r_struct
id|smb_com_transaction2_fnext_req
comma
id|SearchHandle
)paren
op_minus
l_int|4
)paren
suffix:semicolon
id|pSMB-&gt;DataCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;DataOffset
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;SetupCount
op_assign
l_int|1
suffix:semicolon
id|pSMB-&gt;Reserved3
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;SubCommand
op_assign
id|cpu_to_le16
c_func
(paren
id|TRANS2_FIND_NEXT
)paren
suffix:semicolon
id|pSMB-&gt;SearchHandle
op_assign
id|searchHandle
suffix:semicolon
multiline_comment|/* always kept as le */
id|pSMB-&gt;SearchCount
op_assign
id|cpu_to_le16
c_func
(paren
id|CIFS_MAX_MSGSIZE
op_div
r_sizeof
(paren
id|FILE_UNIX_INFO
)paren
)paren
suffix:semicolon
multiline_comment|/* test for Unix extensions */
multiline_comment|/*&t;if (tcon-&gt;ses-&gt;capabilities &amp; CAP_UNIX) {&n;&t;&t;pSMB-&gt;InformationLevel = cpu_to_le16(SMB_FIND_FILE_UNIX);&n;&t;&t;psrch_inf-&gt;info_level = SMB_FIND_FILE_UNIX;&n;&t;} else {&n;&t;&t;pSMB-&gt;InformationLevel =&n;&t;&t;   cpu_to_le16(SMB_FIND_FILE_DIRECTORY_INFO);&n;&t;&t;psrch_inf-&gt;info_level = SMB_FIND_FILE_DIRECTORY_INFO;&n;&t;} */
id|pSMB-&gt;InformationLevel
op_assign
id|cpu_to_le16
c_func
(paren
id|psrch_inf-&gt;info_level
)paren
suffix:semicolon
id|pSMB-&gt;ResumeKey
op_assign
id|psrch_inf-&gt;resume_key
suffix:semicolon
id|pSMB-&gt;SearchFlags
op_assign
id|cpu_to_le16
c_func
(paren
id|CIFS_SEARCH_CLOSE_AT_END
op_or
id|CIFS_SEARCH_RETURN_RESUME
)paren
suffix:semicolon
id|name_len
op_assign
id|psrch_inf-&gt;resume_name_len
suffix:semicolon
id|params
op_add_assign
id|name_len
suffix:semicolon
r_if
c_cond
(paren
id|name_len
OL
id|PATH_MAX
)paren
(brace
id|memcpy
c_func
(paren
id|pSMB-&gt;ResumeFileName
comma
id|psrch_inf-&gt;presume_name
comma
id|name_len
)paren
suffix:semicolon
id|byte_count
op_add_assign
id|name_len
suffix:semicolon
)brace
r_else
(brace
id|rc
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|FNext2_err_exit
suffix:semicolon
)brace
id|byte_count
op_assign
id|params
op_plus
l_int|1
multiline_comment|/* pad */
suffix:semicolon
id|pSMB-&gt;TotalParameterCount
op_assign
id|cpu_to_le16
c_func
(paren
id|params
)paren
suffix:semicolon
id|pSMB-&gt;ParameterCount
op_assign
id|pSMB-&gt;TotalParameterCount
suffix:semicolon
id|pSMB-&gt;hdr.smb_buf_length
op_add_assign
id|byte_count
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
id|cpu_to_le16
c_func
(paren
id|byte_count
)paren
suffix:semicolon
id|rc
op_assign
id|SendReceive
c_func
(paren
id|xid
comma
id|tcon-&gt;ses
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMB
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMBr
comma
op_amp
id|bytes_returned
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
r_if
c_cond
(paren
id|rc
op_eq
op_minus
id|EBADF
)paren
(brace
id|psrch_inf-&gt;endOfSearch
op_assign
id|TRUE
suffix:semicolon
id|rc
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* search probably was closed at end of search above */
)brace
r_else
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;FindNext returned = %d&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* decode response */
id|rc
op_assign
id|validate_t2
c_func
(paren
(paren
r_struct
id|smb_t2_rsp
op_star
)paren
id|pSMBr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
)paren
(brace
multiline_comment|/* BB fixme add lock for file (srch_info) struct here */
r_if
c_cond
(paren
id|pSMBr-&gt;hdr.Flags2
op_amp
id|SMBFLG2_UNICODE
)paren
id|psrch_inf-&gt;unicode
op_assign
id|TRUE
suffix:semicolon
r_else
id|psrch_inf-&gt;unicode
op_assign
id|FALSE
suffix:semicolon
id|response_data
op_assign
(paren
r_char
op_star
)paren
op_amp
id|pSMBr-&gt;hdr.Protocol
op_plus
id|le16_to_cpu
c_func
(paren
id|pSMBr-&gt;t2.ParameterOffset
)paren
suffix:semicolon
id|parms
op_assign
(paren
id|T2_FNEXT_RSP_PARMS
op_star
)paren
id|response_data
suffix:semicolon
id|response_data
op_assign
(paren
r_char
op_star
)paren
op_amp
id|pSMBr-&gt;hdr.Protocol
op_plus
id|le16_to_cpu
c_func
(paren
id|pSMBr-&gt;t2.DataOffset
)paren
suffix:semicolon
id|cifs_buf_release
c_func
(paren
id|psrch_inf-&gt;ntwrk_buf_start
)paren
suffix:semicolon
id|psrch_inf-&gt;srch_entries_start
op_assign
id|response_data
suffix:semicolon
id|psrch_inf-&gt;ntwrk_buf_start
op_assign
(paren
r_char
op_star
)paren
id|pSMB
suffix:semicolon
r_if
c_cond
(paren
id|parms-&gt;EndofSearch
)paren
(brace
id|psrch_inf-&gt;endOfSearch
op_assign
id|TRUE
suffix:semicolon
)brace
r_else
id|psrch_inf-&gt;endOfSearch
op_assign
id|FALSE
suffix:semicolon
id|psrch_inf-&gt;entries_in_buffer
op_assign
id|le16_to_cpu
c_func
(paren
id|parms-&gt;SearchCount
)paren
suffix:semicolon
id|psrch_inf-&gt;index_of_last_entry
op_add_assign
id|psrch_inf-&gt;entries_in_buffer
suffix:semicolon
multiline_comment|/*  cFYI(1,(&quot;fnxt2 entries in buf %d index_of_last %d&quot;,psrch_inf-&gt;entries_in_buffer,psrch_inf-&gt;index_of_last_entry)); */
multiline_comment|/* BB fixme add unlock here */
)brace
)brace
multiline_comment|/* BB On error, should we leave previous search buf (and count and&n;&t;last entry fields) intact or free the previous one? */
multiline_comment|/* Note: On -EAGAIN error only caller can retry on handle based calls&n;&t;since file handle passed in no longer valid */
id|FNext2_err_exit
suffix:colon
r_if
c_cond
(paren
(paren
id|rc
op_ne
l_int|0
)paren
op_logical_and
id|pSMB
)paren
id|cifs_buf_release
c_func
(paren
id|pSMB
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_int
DECL|function|CIFSFindNext
id|CIFSFindNext
c_func
(paren
r_const
r_int
id|xid
comma
r_struct
id|cifsTconInfo
op_star
id|tcon
comma
id|FILE_DIRECTORY_INFO
op_star
id|findData
comma
id|T2_FNEXT_RSP_PARMS
op_star
id|findParms
comma
r_const
id|__u16
id|searchHandle
comma
r_char
op_star
id|resume_file_name
comma
r_int
id|name_len
comma
id|__u32
id|resume_key
comma
r_int
op_star
id|pUnicodeFlag
comma
r_int
op_star
id|pUnixFlag
)paren
(brace
multiline_comment|/* level 257 SMB_ */
id|TRANSACTION2_FNEXT_REQ
op_star
id|pSMB
op_assign
l_int|NULL
suffix:semicolon
id|TRANSACTION2_FNEXT_RSP
op_star
id|pSMBr
op_assign
l_int|NULL
suffix:semicolon
r_char
op_star
id|response_data
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|bytes_returned
suffix:semicolon
id|__u16
id|params
comma
id|byte_count
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;In FindNext&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|resume_file_name
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|rc
op_assign
id|smb_init
c_func
(paren
id|SMB_COM_TRANSACTION2
comma
l_int|15
comma
id|tcon
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMB
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMBr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
id|params
op_assign
l_int|14
suffix:semicolon
multiline_comment|/* includes 2 bytes of null string, converted to LE below */
id|byte_count
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;TotalDataCount
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* no EAs */
id|pSMB-&gt;MaxParameterCount
op_assign
id|cpu_to_le16
c_func
(paren
l_int|8
)paren
suffix:semicolon
id|pSMB-&gt;MaxDataCount
op_assign
id|cpu_to_le16
c_func
(paren
(paren
id|tcon-&gt;ses-&gt;server-&gt;maxBuf
op_minus
id|MAX_CIFS_HDR_SIZE
)paren
op_amp
l_int|0xFFFFFF00
)paren
suffix:semicolon
id|pSMB-&gt;MaxSetupCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Flags
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Timeout
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved2
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;ParameterOffset
op_assign
id|cpu_to_le16
c_func
(paren
m_offsetof
(paren
r_struct
id|smb_com_transaction2_fnext_req
comma
id|SearchHandle
)paren
op_minus
l_int|4
)paren
suffix:semicolon
id|pSMB-&gt;DataCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;DataOffset
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;SetupCount
op_assign
l_int|1
suffix:semicolon
id|pSMB-&gt;Reserved3
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;SubCommand
op_assign
id|cpu_to_le16
c_func
(paren
id|TRANS2_FIND_NEXT
)paren
suffix:semicolon
id|pSMB-&gt;SearchHandle
op_assign
id|searchHandle
suffix:semicolon
multiline_comment|/* always kept as le */
id|findParms-&gt;SearchCount
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* set to zero in case of error */
id|pSMB-&gt;SearchCount
op_assign
id|cpu_to_le16
c_func
(paren
id|CIFS_MAX_MSGSIZE
op_div
r_sizeof
(paren
id|FILE_UNIX_INFO
)paren
)paren
suffix:semicolon
multiline_comment|/* test for Unix extensions */
r_if
c_cond
(paren
id|tcon-&gt;ses-&gt;capabilities
op_amp
id|CAP_UNIX
)paren
(brace
id|pSMB-&gt;InformationLevel
op_assign
id|cpu_to_le16
c_func
(paren
id|SMB_FIND_FILE_UNIX
)paren
suffix:semicolon
op_star
id|pUnixFlag
op_assign
id|TRUE
suffix:semicolon
)brace
r_else
(brace
id|pSMB-&gt;InformationLevel
op_assign
id|cpu_to_le16
c_func
(paren
id|SMB_FIND_FILE_DIRECTORY_INFO
)paren
suffix:semicolon
op_star
id|pUnixFlag
op_assign
id|FALSE
suffix:semicolon
)brace
id|pSMB-&gt;ResumeKey
op_assign
id|resume_key
suffix:semicolon
id|pSMB-&gt;SearchFlags
op_assign
id|cpu_to_le16
c_func
(paren
id|CIFS_SEARCH_CLOSE_AT_END
op_or
id|CIFS_SEARCH_RETURN_RESUME
)paren
suffix:semicolon
multiline_comment|/* BB add check to make sure we do not cross end of smb */
r_if
c_cond
(paren
id|name_len
OL
id|PATH_MAX
)paren
(brace
id|memcpy
c_func
(paren
id|pSMB-&gt;ResumeFileName
comma
id|resume_file_name
comma
id|name_len
)paren
suffix:semicolon
id|byte_count
op_add_assign
id|name_len
suffix:semicolon
)brace
id|params
op_add_assign
id|name_len
suffix:semicolon
id|byte_count
op_assign
id|params
op_plus
l_int|1
multiline_comment|/* pad */
suffix:semicolon
id|pSMB-&gt;TotalParameterCount
op_assign
id|cpu_to_le16
c_func
(paren
id|params
)paren
suffix:semicolon
id|pSMB-&gt;ParameterCount
op_assign
id|pSMB-&gt;TotalParameterCount
suffix:semicolon
multiline_comment|/* BB improve error handling here */
id|pSMB-&gt;hdr.smb_buf_length
op_add_assign
id|byte_count
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
id|cpu_to_le16
c_func
(paren
id|byte_count
)paren
suffix:semicolon
id|rc
op_assign
id|SendReceive
c_func
(paren
id|xid
comma
id|tcon-&gt;ses
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMB
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMBr
comma
op_amp
id|bytes_returned
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
r_if
c_cond
(paren
id|rc
op_eq
op_minus
id|EBADF
)paren
id|rc
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* search probably was closed at end of search above */
r_else
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;FindNext returned = %d&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* decode response */
id|rc
op_assign
id|validate_t2
c_func
(paren
(paren
r_struct
id|smb_t2_rsp
op_star
)paren
id|pSMBr
)paren
suffix:semicolon
multiline_comment|/* BB add safety checks for these memcpys */
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|pSMBr-&gt;hdr.Flags2
op_amp
id|SMBFLG2_UNICODE
)paren
op_star
id|pUnicodeFlag
op_assign
id|TRUE
suffix:semicolon
r_else
op_star
id|pUnicodeFlag
op_assign
id|FALSE
suffix:semicolon
id|memcpy
c_func
(paren
id|findParms
comma
(paren
r_char
op_star
)paren
op_amp
id|pSMBr-&gt;hdr.Protocol
op_plus
id|le16_to_cpu
c_func
(paren
id|pSMBr-&gt;t2.ParameterOffset
)paren
comma
r_sizeof
(paren
id|T2_FNEXT_RSP_PARMS
)paren
)paren
suffix:semicolon
id|response_data
op_assign
(paren
r_char
op_star
)paren
op_amp
id|pSMBr-&gt;hdr.Protocol
op_plus
id|le16_to_cpu
c_func
(paren
id|pSMBr-&gt;t2.DataOffset
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|findData
comma
id|response_data
comma
id|le16_to_cpu
c_func
(paren
id|pSMBr-&gt;t2.DataCount
)paren
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|pSMB
)paren
id|cifs_buf_release
c_func
(paren
id|pSMB
)paren
suffix:semicolon
multiline_comment|/* Note: On -EAGAIN error only caller can retry on handle based calls&n;&t;&t;since file handle passed in no longer valid */
r_return
id|rc
suffix:semicolon
)brace
r_int
DECL|function|CIFSFindClose
id|CIFSFindClose
c_func
(paren
r_const
r_int
id|xid
comma
r_struct
id|cifsTconInfo
op_star
id|tcon
comma
r_const
id|__u16
id|searchHandle
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|FINDCLOSE_REQ
op_star
id|pSMB
op_assign
l_int|NULL
suffix:semicolon
id|CLOSE_RSP
op_star
id|pSMBr
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* BB removeme BB */
r_int
id|bytes_returned
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;In CIFSSMBFindClose&quot;
)paren
)paren
suffix:semicolon
id|rc
op_assign
id|small_smb_init
c_func
(paren
id|SMB_COM_FIND_CLOSE2
comma
l_int|1
comma
id|tcon
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMB
)paren
suffix:semicolon
id|pSMBr
op_assign
(paren
id|CLOSE_RSP
op_star
)paren
id|pSMB
suffix:semicolon
multiline_comment|/* BB removeme BB */
multiline_comment|/* no sense returning error if session restarted&n;&t;&t;file handle has been closed */
r_if
c_cond
(paren
id|rc
op_eq
op_minus
id|EAGAIN
)paren
(brace
r_return
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
id|pSMB-&gt;FileID
op_assign
id|searchHandle
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
l_int|0
suffix:semicolon
id|rc
op_assign
id|SendReceive
c_func
(paren
id|xid
comma
id|tcon-&gt;ses
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMB
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMBr
comma
op_amp
id|bytes_returned
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|cERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Send error in FindClose = %d&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pSMB
)paren
id|cifs_small_buf_release
c_func
(paren
id|pSMB
)paren
suffix:semicolon
multiline_comment|/* Since session is dead, search handle closed on server already */
r_if
c_cond
(paren
id|rc
op_eq
op_minus
id|EAGAIN
)paren
id|rc
op_assign
l_int|0
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_CIFS_EXPERIMENTAL
r_int
DECL|function|CIFSGetSrvInodeNumber
id|CIFSGetSrvInodeNumber
c_func
(paren
r_const
r_int
id|xid
comma
r_struct
id|cifsTconInfo
op_star
id|tcon
comma
r_const
r_int
r_char
op_star
id|searchName
comma
id|__u64
op_star
id|inode_number
comma
r_const
r_struct
id|nls_table
op_star
id|nls_codepage
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|TRANSACTION2_QPI_REQ
op_star
id|pSMB
op_assign
l_int|NULL
suffix:semicolon
id|TRANSACTION2_QPI_RSP
op_star
id|pSMBr
op_assign
l_int|NULL
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;In GetSrvInodeNumber for %s&quot;
comma
id|searchName
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tcon
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;In QPathInfo path %s&quot;
comma
id|searchName
)paren
)paren
suffix:semicolon
id|GetInodeNumberRetry
suffix:colon
id|rc
op_assign
id|smb_init
c_func
(paren
id|SMB_COM_TRANSACTION2
comma
l_int|15
comma
id|tcon
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMB
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMBr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
multiline_comment|/* BB add missing code here */
r_if
c_cond
(paren
id|pSMB
)paren
id|cifs_buf_release
c_func
(paren
id|pSMB
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
op_minus
id|EAGAIN
)paren
r_goto
id|GetInodeNumberRetry
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
macro_line|#endif /* CIFS_EXPERIMENTAL */
r_int
DECL|function|CIFSGetDFSRefer
id|CIFSGetDFSRefer
c_func
(paren
r_const
r_int
id|xid
comma
r_struct
id|cifsSesInfo
op_star
id|ses
comma
r_const
r_int
r_char
op_star
id|searchName
comma
r_int
r_char
op_star
op_star
id|targetUNCs
comma
r_int
r_int
op_star
id|number_of_UNC_in_array
comma
r_const
r_struct
id|nls_table
op_star
id|nls_codepage
)paren
(brace
multiline_comment|/* TRANS2_GET_DFS_REFERRAL */
id|TRANSACTION2_GET_DFS_REFER_REQ
op_star
id|pSMB
op_assign
l_int|NULL
suffix:semicolon
id|TRANSACTION2_GET_DFS_REFER_RSP
op_star
id|pSMBr
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|dfs_referral_level_3
op_star
id|referrals
op_assign
l_int|NULL
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|bytes_returned
suffix:semicolon
r_int
id|name_len
suffix:semicolon
r_int
r_int
id|i
suffix:semicolon
r_char
op_star
id|temp
suffix:semicolon
id|__u16
id|params
comma
id|byte_count
suffix:semicolon
op_star
id|number_of_UNC_in_array
op_assign
l_int|0
suffix:semicolon
op_star
id|targetUNCs
op_assign
l_int|NULL
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;In GetDFSRefer the path %s&quot;
comma
id|searchName
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ses
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|getDFSRetry
suffix:colon
id|rc
op_assign
id|smb_init
c_func
(paren
id|SMB_COM_TRANSACTION2
comma
l_int|15
comma
l_int|NULL
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMB
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMBr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
id|pSMB-&gt;hdr.Tid
op_assign
id|ses-&gt;ipc_tid
suffix:semicolon
id|pSMB-&gt;hdr.Uid
op_assign
id|ses-&gt;Suid
suffix:semicolon
r_if
c_cond
(paren
id|ses-&gt;capabilities
op_amp
id|CAP_STATUS32
)paren
(brace
id|pSMB-&gt;hdr.Flags2
op_or_assign
id|SMBFLG2_ERR_STATUS
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ses-&gt;capabilities
op_amp
id|CAP_DFS
)paren
(brace
id|pSMB-&gt;hdr.Flags2
op_or_assign
id|SMBFLG2_DFS
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ses-&gt;capabilities
op_amp
id|CAP_UNICODE
)paren
(brace
id|pSMB-&gt;hdr.Flags2
op_or_assign
id|SMBFLG2_UNICODE
suffix:semicolon
id|name_len
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|pSMB-&gt;RequestFileName
comma
id|searchName
comma
l_int|530
multiline_comment|/* find define for this maxpathcomponent */
comma
id|nls_codepage
)paren
suffix:semicolon
id|name_len
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|name_len
op_mul_assign
l_int|2
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* BB improve the check for buffer overruns BB */
id|name_len
op_assign
id|strnlen
c_func
(paren
id|searchName
comma
l_int|530
)paren
suffix:semicolon
id|name_len
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|strncpy
c_func
(paren
id|pSMB-&gt;RequestFileName
comma
id|searchName
comma
id|name_len
)paren
suffix:semicolon
)brace
id|params
op_assign
l_int|2
multiline_comment|/* level */
op_plus
id|name_len
multiline_comment|/*includes null */
suffix:semicolon
id|pSMB-&gt;TotalDataCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;DataCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;DataOffset
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;MaxParameterCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;MaxDataCount
op_assign
id|cpu_to_le16
c_func
(paren
l_int|4000
)paren
suffix:semicolon
multiline_comment|/* BB find exact max SMB PDU from sess structure BB */
id|pSMB-&gt;MaxSetupCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Flags
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Timeout
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved2
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;ParameterOffset
op_assign
id|cpu_to_le16
c_func
(paren
m_offsetof
(paren
r_struct
id|smb_com_transaction2_get_dfs_refer_req
comma
id|MaxReferralLevel
)paren
op_minus
l_int|4
)paren
suffix:semicolon
id|pSMB-&gt;SetupCount
op_assign
l_int|1
suffix:semicolon
id|pSMB-&gt;Reserved3
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;SubCommand
op_assign
id|cpu_to_le16
c_func
(paren
id|TRANS2_GET_DFS_REFERRAL
)paren
suffix:semicolon
id|byte_count
op_assign
id|params
op_plus
l_int|3
multiline_comment|/* pad */
suffix:semicolon
id|pSMB-&gt;ParameterCount
op_assign
id|cpu_to_le16
c_func
(paren
id|params
)paren
suffix:semicolon
id|pSMB-&gt;TotalParameterCount
op_assign
id|pSMB-&gt;ParameterCount
suffix:semicolon
id|pSMB-&gt;MaxReferralLevel
op_assign
id|cpu_to_le16
c_func
(paren
l_int|3
)paren
suffix:semicolon
id|pSMB-&gt;hdr.smb_buf_length
op_add_assign
id|byte_count
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
id|cpu_to_le16
c_func
(paren
id|byte_count
)paren
suffix:semicolon
id|rc
op_assign
id|SendReceive
c_func
(paren
id|xid
comma
id|ses
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMB
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMBr
comma
op_amp
id|bytes_returned
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Send error in GetDFSRefer = %d&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* decode response */
multiline_comment|/* BB Add logic to parse referrals here */
id|rc
op_assign
id|validate_t2
c_func
(paren
(paren
r_struct
id|smb_t2_rsp
op_star
)paren
id|pSMBr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_logical_or
(paren
id|pSMBr-&gt;ByteCount
OL
l_int|17
)paren
)paren
multiline_comment|/* BB also check enough total bytes returned */
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
multiline_comment|/* bad smb */
r_else
(brace
id|__u16
id|data_offset
op_assign
id|le16_to_cpu
c_func
(paren
id|pSMBr-&gt;t2.DataOffset
)paren
suffix:semicolon
id|__u16
id|data_count
op_assign
id|le16_to_cpu
c_func
(paren
id|pSMBr-&gt;t2.DataCount
)paren
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Decoding GetDFSRefer response.  BCC: %d  Offset %d&quot;
comma
id|pSMBr-&gt;ByteCount
comma
id|data_offset
)paren
)paren
suffix:semicolon
id|referrals
op_assign
(paren
r_struct
id|dfs_referral_level_3
op_star
)paren
(paren
l_int|8
multiline_comment|/* sizeof start of data block */
op_plus
id|data_offset
op_plus
(paren
r_char
op_star
)paren
op_amp
id|pSMBr-&gt;hdr.Protocol
)paren
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;num_referrals: %d dfs flags: 0x%x ... &bslash;nfor referral one refer size: 0x%x srv type: 0x%x refer flags: 0x%x ttl: 0x%x&quot;
comma
id|le16_to_cpu
c_func
(paren
id|pSMBr-&gt;NumberOfReferrals
)paren
comma
id|le16_to_cpu
c_func
(paren
id|pSMBr-&gt;DFSFlags
)paren
comma
id|le16_to_cpu
c_func
(paren
id|referrals-&gt;ReferralSize
)paren
comma
id|le16_to_cpu
c_func
(paren
id|referrals-&gt;ServerType
)paren
comma
id|le16_to_cpu
c_func
(paren
id|referrals-&gt;ReferralFlags
)paren
comma
id|le16_to_cpu
c_func
(paren
id|referrals-&gt;TimeToLive
)paren
)paren
)paren
suffix:semicolon
multiline_comment|/* BB This field is actually two bytes in from start of&n;&t;&t;&t;   data block so we could do safety check that DataBlock&n;&t;&t;&t;   begins at address of pSMBr-&gt;NumberOfReferrals */
op_star
id|number_of_UNC_in_array
op_assign
id|le16_to_cpu
c_func
(paren
id|pSMBr-&gt;NumberOfReferrals
)paren
suffix:semicolon
multiline_comment|/* BB Fix below so can return more than one referral */
r_if
c_cond
(paren
op_star
id|number_of_UNC_in_array
OG
l_int|1
)paren
(brace
op_star
id|number_of_UNC_in_array
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* get the length of the strings describing refs */
id|name_len
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
op_star
id|number_of_UNC_in_array
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* make sure that DfsPathOffset not past end */
id|__u16
id|offset
op_assign
id|le16_to_cpu
c_func
(paren
id|referrals-&gt;DfsPathOffset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|offset
OG
id|data_count
)paren
(brace
multiline_comment|/* if invalid referral, stop here and do &n;&t;&t;&t;&t;&t;not try to copy any more */
op_star
id|number_of_UNC_in_array
op_assign
id|i
suffix:semicolon
r_break
suffix:semicolon
)brace
id|temp
op_assign
(paren
(paren
r_char
op_star
)paren
id|referrals
)paren
op_plus
id|offset
suffix:semicolon
r_if
c_cond
(paren
id|pSMBr-&gt;hdr.Flags2
op_amp
id|SMBFLG2_UNICODE
)paren
(brace
id|name_len
op_add_assign
id|UniStrnlen
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|temp
comma
id|data_count
)paren
suffix:semicolon
)brace
r_else
(brace
id|name_len
op_add_assign
id|strnlen
c_func
(paren
id|temp
comma
id|data_count
)paren
suffix:semicolon
)brace
id|referrals
op_increment
suffix:semicolon
multiline_comment|/* BB add check that referral pointer does not fall off end PDU */
)brace
multiline_comment|/* BB add check for name_len bigger than bcc */
op_star
id|targetUNCs
op_assign
id|kmalloc
c_func
(paren
id|name_len
op_plus
l_int|1
op_plus
(paren
op_star
id|number_of_UNC_in_array
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|targetUNCs
op_eq
l_int|NULL
)paren
(brace
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|GetDFSRefExit
suffix:semicolon
)brace
multiline_comment|/* copy the ref strings */
id|referrals
op_assign
(paren
r_struct
id|dfs_referral_level_3
op_star
)paren
(paren
l_int|8
multiline_comment|/* sizeof data hdr */
op_plus
id|data_offset
op_plus
(paren
r_char
op_star
)paren
op_amp
id|pSMBr-&gt;hdr.Protocol
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
op_star
id|number_of_UNC_in_array
suffix:semicolon
id|i
op_increment
)paren
(brace
id|temp
op_assign
(paren
(paren
r_char
op_star
)paren
id|referrals
)paren
op_plus
id|le16_to_cpu
c_func
(paren
id|referrals-&gt;DfsPathOffset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pSMBr-&gt;hdr.Flags2
op_amp
id|SMBFLG2_UNICODE
)paren
(brace
id|cifs_strfromUCS_le
c_func
(paren
op_star
id|targetUNCs
comma
(paren
m_wchar_t
op_star
)paren
id|temp
comma
id|name_len
comma
id|nls_codepage
)paren
suffix:semicolon
)brace
r_else
(brace
id|strncpy
c_func
(paren
op_star
id|targetUNCs
comma
id|temp
comma
id|name_len
)paren
suffix:semicolon
)brace
multiline_comment|/*  BB update target_uncs pointers */
id|referrals
op_increment
suffix:semicolon
)brace
id|temp
op_assign
op_star
id|targetUNCs
suffix:semicolon
id|temp
(braket
id|name_len
)braket
op_assign
l_int|0
suffix:semicolon
)brace
)brace
id|GetDFSRefExit
suffix:colon
r_if
c_cond
(paren
id|pSMB
)paren
id|cifs_buf_release
c_func
(paren
id|pSMB
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
op_minus
id|EAGAIN
)paren
r_goto
id|getDFSRetry
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_int
DECL|function|CIFSSMBQFSInfo
id|CIFSSMBQFSInfo
c_func
(paren
r_const
r_int
id|xid
comma
r_struct
id|cifsTconInfo
op_star
id|tcon
comma
r_struct
id|kstatfs
op_star
id|FSData
comma
r_const
r_struct
id|nls_table
op_star
id|nls_codepage
)paren
(brace
multiline_comment|/* level 0x103 SMB_QUERY_FILE_SYSTEM_INFO */
id|TRANSACTION2_QFSI_REQ
op_star
id|pSMB
op_assign
l_int|NULL
suffix:semicolon
id|TRANSACTION2_QFSI_RSP
op_star
id|pSMBr
op_assign
l_int|NULL
suffix:semicolon
id|FILE_SYSTEM_INFO
op_star
id|response_data
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|bytes_returned
op_assign
l_int|0
suffix:semicolon
id|__u16
id|params
comma
id|byte_count
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;In QFSInfo&quot;
)paren
)paren
suffix:semicolon
id|QFSInfoRetry
suffix:colon
id|rc
op_assign
id|smb_init
c_func
(paren
id|SMB_COM_TRANSACTION2
comma
l_int|15
comma
id|tcon
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMB
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMBr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
id|params
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* level */
id|pSMB-&gt;TotalDataCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;MaxParameterCount
op_assign
id|cpu_to_le16
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|pSMB-&gt;MaxDataCount
op_assign
id|cpu_to_le16
c_func
(paren
l_int|1000
)paren
suffix:semicolon
multiline_comment|/* BB find exact max SMB PDU from sess structure BB */
id|pSMB-&gt;MaxSetupCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Flags
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Timeout
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved2
op_assign
l_int|0
suffix:semicolon
id|byte_count
op_assign
id|params
op_plus
l_int|1
multiline_comment|/* pad */
suffix:semicolon
id|pSMB-&gt;TotalParameterCount
op_assign
id|cpu_to_le16
c_func
(paren
id|params
)paren
suffix:semicolon
id|pSMB-&gt;ParameterCount
op_assign
id|pSMB-&gt;TotalParameterCount
suffix:semicolon
id|pSMB-&gt;ParameterOffset
op_assign
id|cpu_to_le16
c_func
(paren
m_offsetof
(paren
r_struct
id|smb_com_transaction2_qfsi_req
comma
id|InformationLevel
)paren
op_minus
l_int|4
)paren
suffix:semicolon
id|pSMB-&gt;DataCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;DataOffset
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;SetupCount
op_assign
l_int|1
suffix:semicolon
id|pSMB-&gt;Reserved3
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;SubCommand
op_assign
id|cpu_to_le16
c_func
(paren
id|TRANS2_QUERY_FS_INFORMATION
)paren
suffix:semicolon
id|pSMB-&gt;InformationLevel
op_assign
id|cpu_to_le16
c_func
(paren
id|SMB_QUERY_FS_SIZE_INFO
)paren
suffix:semicolon
id|pSMB-&gt;hdr.smb_buf_length
op_add_assign
id|byte_count
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
id|cpu_to_le16
c_func
(paren
id|byte_count
)paren
suffix:semicolon
id|rc
op_assign
id|SendReceive
c_func
(paren
id|xid
comma
id|tcon-&gt;ses
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMB
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMBr
comma
op_amp
id|bytes_returned
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|cERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Send error in QFSInfo = %d&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* decode response */
id|rc
op_assign
id|validate_t2
c_func
(paren
(paren
r_struct
id|smb_t2_rsp
op_star
)paren
id|pSMBr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_logical_or
(paren
id|pSMBr-&gt;ByteCount
OL
l_int|24
)paren
)paren
multiline_comment|/* BB alsO CHEck enough total bytes returned */
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
multiline_comment|/* bad smb */
r_else
(brace
id|__u16
id|data_offset
op_assign
id|le16_to_cpu
c_func
(paren
id|pSMBr-&gt;t2.DataOffset
)paren
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Decoding qfsinfo response.  BCC: %d  Offset %d&quot;
comma
id|pSMBr-&gt;ByteCount
comma
id|data_offset
)paren
)paren
suffix:semicolon
id|response_data
op_assign
(paren
id|FILE_SYSTEM_INFO
op_star
)paren
(paren
(paren
(paren
r_char
op_star
)paren
op_amp
id|pSMBr-&gt;hdr.Protocol
)paren
op_plus
id|data_offset
)paren
suffix:semicolon
id|FSData-&gt;f_bsize
op_assign
id|le32_to_cpu
c_func
(paren
id|response_data-&gt;BytesPerSector
)paren
op_star
id|le32_to_cpu
c_func
(paren
id|response_data
op_member_access_from_pointer
id|SectorsPerAllocationUnit
)paren
suffix:semicolon
id|FSData-&gt;f_blocks
op_assign
id|le64_to_cpu
c_func
(paren
id|response_data-&gt;TotalAllocationUnits
)paren
suffix:semicolon
id|FSData-&gt;f_bfree
op_assign
id|FSData-&gt;f_bavail
op_assign
id|le64_to_cpu
c_func
(paren
id|response_data-&gt;FreeAllocationUnits
)paren
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Blocks: %lld  Free: %lld Block size %ld&quot;
comma
(paren
r_int
r_int
r_int
)paren
id|FSData-&gt;f_blocks
comma
(paren
r_int
r_int
r_int
)paren
id|FSData-&gt;f_bfree
comma
id|FSData-&gt;f_bsize
)paren
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|pSMB
)paren
id|cifs_buf_release
c_func
(paren
id|pSMB
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
op_minus
id|EAGAIN
)paren
r_goto
id|QFSInfoRetry
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_int
DECL|function|CIFSSMBQFSAttributeInfo
id|CIFSSMBQFSAttributeInfo
c_func
(paren
r_const
r_int
id|xid
comma
r_struct
id|cifsTconInfo
op_star
id|tcon
comma
r_const
r_struct
id|nls_table
op_star
id|nls_codepage
)paren
(brace
multiline_comment|/* level 0x105  SMB_QUERY_FILE_SYSTEM_INFO */
id|TRANSACTION2_QFSI_REQ
op_star
id|pSMB
op_assign
l_int|NULL
suffix:semicolon
id|TRANSACTION2_QFSI_RSP
op_star
id|pSMBr
op_assign
l_int|NULL
suffix:semicolon
id|FILE_SYSTEM_ATTRIBUTE_INFO
op_star
id|response_data
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|bytes_returned
op_assign
l_int|0
suffix:semicolon
id|__u16
id|params
comma
id|byte_count
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;In QFSAttributeInfo&quot;
)paren
)paren
suffix:semicolon
id|QFSAttributeRetry
suffix:colon
id|rc
op_assign
id|smb_init
c_func
(paren
id|SMB_COM_TRANSACTION2
comma
l_int|15
comma
id|tcon
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMB
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMBr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
id|params
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* level */
id|pSMB-&gt;TotalDataCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;MaxParameterCount
op_assign
id|cpu_to_le16
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|pSMB-&gt;MaxDataCount
op_assign
id|cpu_to_le16
c_func
(paren
l_int|1000
)paren
suffix:semicolon
multiline_comment|/* BB find exact max SMB PDU from sess structure BB */
id|pSMB-&gt;MaxSetupCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Flags
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Timeout
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved2
op_assign
l_int|0
suffix:semicolon
id|byte_count
op_assign
id|params
op_plus
l_int|1
multiline_comment|/* pad */
suffix:semicolon
id|pSMB-&gt;TotalParameterCount
op_assign
id|cpu_to_le16
c_func
(paren
id|params
)paren
suffix:semicolon
id|pSMB-&gt;ParameterCount
op_assign
id|pSMB-&gt;TotalParameterCount
suffix:semicolon
id|pSMB-&gt;ParameterOffset
op_assign
id|cpu_to_le16
c_func
(paren
m_offsetof
(paren
r_struct
id|smb_com_transaction2_qfsi_req
comma
id|InformationLevel
)paren
op_minus
l_int|4
)paren
suffix:semicolon
id|pSMB-&gt;DataCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;DataOffset
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;SetupCount
op_assign
l_int|1
suffix:semicolon
id|pSMB-&gt;Reserved3
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;SubCommand
op_assign
id|cpu_to_le16
c_func
(paren
id|TRANS2_QUERY_FS_INFORMATION
)paren
suffix:semicolon
id|pSMB-&gt;InformationLevel
op_assign
id|cpu_to_le16
c_func
(paren
id|SMB_QUERY_FS_ATTRIBUTE_INFO
)paren
suffix:semicolon
id|pSMB-&gt;hdr.smb_buf_length
op_add_assign
id|byte_count
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
id|cpu_to_le16
c_func
(paren
id|byte_count
)paren
suffix:semicolon
id|rc
op_assign
id|SendReceive
c_func
(paren
id|xid
comma
id|tcon-&gt;ses
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMB
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMBr
comma
op_amp
id|bytes_returned
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|cERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Send error in QFSAttributeInfo = %d&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* decode response */
id|rc
op_assign
id|validate_t2
c_func
(paren
(paren
r_struct
id|smb_t2_rsp
op_star
)paren
id|pSMBr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_logical_or
(paren
id|pSMBr-&gt;ByteCount
OL
l_int|13
)paren
)paren
(brace
multiline_comment|/* BB also check enough bytes returned */
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
multiline_comment|/* bad smb */
)brace
r_else
(brace
id|__u16
id|data_offset
op_assign
id|le16_to_cpu
c_func
(paren
id|pSMBr-&gt;t2.DataOffset
)paren
suffix:semicolon
id|response_data
op_assign
(paren
id|FILE_SYSTEM_ATTRIBUTE_INFO
op_star
)paren
(paren
(paren
(paren
r_char
op_star
)paren
op_amp
id|pSMBr-&gt;hdr.Protocol
)paren
op_plus
id|data_offset
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|tcon-&gt;fsAttrInfo
comma
id|response_data
comma
r_sizeof
(paren
id|FILE_SYSTEM_ATTRIBUTE_INFO
)paren
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|pSMB
)paren
id|cifs_buf_release
c_func
(paren
id|pSMB
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
op_minus
id|EAGAIN
)paren
r_goto
id|QFSAttributeRetry
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_int
DECL|function|CIFSSMBQFSDeviceInfo
id|CIFSSMBQFSDeviceInfo
c_func
(paren
r_const
r_int
id|xid
comma
r_struct
id|cifsTconInfo
op_star
id|tcon
comma
r_const
r_struct
id|nls_table
op_star
id|nls_codepage
)paren
(brace
multiline_comment|/* level 0x104 SMB_QUERY_FILE_SYSTEM_INFO */
id|TRANSACTION2_QFSI_REQ
op_star
id|pSMB
op_assign
l_int|NULL
suffix:semicolon
id|TRANSACTION2_QFSI_RSP
op_star
id|pSMBr
op_assign
l_int|NULL
suffix:semicolon
id|FILE_SYSTEM_DEVICE_INFO
op_star
id|response_data
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|bytes_returned
op_assign
l_int|0
suffix:semicolon
id|__u16
id|params
comma
id|byte_count
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;In QFSDeviceInfo&quot;
)paren
)paren
suffix:semicolon
id|QFSDeviceRetry
suffix:colon
id|rc
op_assign
id|smb_init
c_func
(paren
id|SMB_COM_TRANSACTION2
comma
l_int|15
comma
id|tcon
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMB
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMBr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
id|params
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* level */
id|pSMB-&gt;TotalDataCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;MaxParameterCount
op_assign
id|cpu_to_le16
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|pSMB-&gt;MaxDataCount
op_assign
id|cpu_to_le16
c_func
(paren
l_int|1000
)paren
suffix:semicolon
multiline_comment|/* BB find exact max SMB PDU from sess structure BB */
id|pSMB-&gt;MaxSetupCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Flags
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Timeout
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved2
op_assign
l_int|0
suffix:semicolon
id|byte_count
op_assign
id|params
op_plus
l_int|1
multiline_comment|/* pad */
suffix:semicolon
id|pSMB-&gt;TotalParameterCount
op_assign
id|cpu_to_le16
c_func
(paren
id|params
)paren
suffix:semicolon
id|pSMB-&gt;ParameterCount
op_assign
id|pSMB-&gt;TotalParameterCount
suffix:semicolon
id|pSMB-&gt;ParameterOffset
op_assign
id|cpu_to_le16
c_func
(paren
m_offsetof
(paren
r_struct
id|smb_com_transaction2_qfsi_req
comma
id|InformationLevel
)paren
op_minus
l_int|4
)paren
suffix:semicolon
id|pSMB-&gt;DataCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;DataOffset
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;SetupCount
op_assign
l_int|1
suffix:semicolon
id|pSMB-&gt;Reserved3
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;SubCommand
op_assign
id|cpu_to_le16
c_func
(paren
id|TRANS2_QUERY_FS_INFORMATION
)paren
suffix:semicolon
id|pSMB-&gt;InformationLevel
op_assign
id|cpu_to_le16
c_func
(paren
id|SMB_QUERY_FS_DEVICE_INFO
)paren
suffix:semicolon
id|pSMB-&gt;hdr.smb_buf_length
op_add_assign
id|byte_count
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
id|cpu_to_le16
c_func
(paren
id|byte_count
)paren
suffix:semicolon
id|rc
op_assign
id|SendReceive
c_func
(paren
id|xid
comma
id|tcon-&gt;ses
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMB
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMBr
comma
op_amp
id|bytes_returned
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Send error in QFSDeviceInfo = %d&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* decode response */
id|rc
op_assign
id|validate_t2
c_func
(paren
(paren
r_struct
id|smb_t2_rsp
op_star
)paren
id|pSMBr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_logical_or
(paren
id|pSMBr-&gt;ByteCount
OL
r_sizeof
(paren
id|FILE_SYSTEM_DEVICE_INFO
)paren
)paren
)paren
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
multiline_comment|/* bad smb */
r_else
(brace
id|__u16
id|data_offset
op_assign
id|le16_to_cpu
c_func
(paren
id|pSMBr-&gt;t2.DataOffset
)paren
suffix:semicolon
id|response_data
op_assign
(paren
id|FILE_SYSTEM_DEVICE_INFO
op_star
)paren
(paren
(paren
(paren
r_char
op_star
)paren
op_amp
id|pSMBr-&gt;hdr.Protocol
)paren
op_plus
id|data_offset
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|tcon-&gt;fsDevInfo
comma
id|response_data
comma
r_sizeof
(paren
id|FILE_SYSTEM_DEVICE_INFO
)paren
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|pSMB
)paren
id|cifs_buf_release
c_func
(paren
id|pSMB
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
op_minus
id|EAGAIN
)paren
r_goto
id|QFSDeviceRetry
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_int
DECL|function|CIFSSMBQFSUnixInfo
id|CIFSSMBQFSUnixInfo
c_func
(paren
r_const
r_int
id|xid
comma
r_struct
id|cifsTconInfo
op_star
id|tcon
comma
r_const
r_struct
id|nls_table
op_star
id|nls_codepage
)paren
(brace
multiline_comment|/* level 0x200  SMB_QUERY_CIFS_UNIX_INFO */
id|TRANSACTION2_QFSI_REQ
op_star
id|pSMB
op_assign
l_int|NULL
suffix:semicolon
id|TRANSACTION2_QFSI_RSP
op_star
id|pSMBr
op_assign
l_int|NULL
suffix:semicolon
id|FILE_SYSTEM_UNIX_INFO
op_star
id|response_data
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|bytes_returned
op_assign
l_int|0
suffix:semicolon
id|__u16
id|params
comma
id|byte_count
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;In QFSUnixInfo&quot;
)paren
)paren
suffix:semicolon
id|QFSUnixRetry
suffix:colon
id|rc
op_assign
id|smb_init
c_func
(paren
id|SMB_COM_TRANSACTION2
comma
l_int|15
comma
id|tcon
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMB
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMBr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
id|params
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* level */
id|pSMB-&gt;TotalDataCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;DataCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;DataOffset
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;MaxParameterCount
op_assign
id|cpu_to_le16
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|pSMB-&gt;MaxDataCount
op_assign
id|cpu_to_le16
c_func
(paren
l_int|100
)paren
suffix:semicolon
multiline_comment|/* BB find exact max SMB PDU from sess structure BB */
id|pSMB-&gt;MaxSetupCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Flags
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Timeout
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved2
op_assign
l_int|0
suffix:semicolon
id|byte_count
op_assign
id|params
op_plus
l_int|1
multiline_comment|/* pad */
suffix:semicolon
id|pSMB-&gt;ParameterCount
op_assign
id|cpu_to_le16
c_func
(paren
id|params
)paren
suffix:semicolon
id|pSMB-&gt;TotalParameterCount
op_assign
id|pSMB-&gt;ParameterCount
suffix:semicolon
id|pSMB-&gt;ParameterOffset
op_assign
id|cpu_to_le16
c_func
(paren
m_offsetof
(paren
r_struct
id|smb_com_transaction2_qfsi_req
comma
id|InformationLevel
)paren
op_minus
l_int|4
)paren
suffix:semicolon
id|pSMB-&gt;SetupCount
op_assign
l_int|1
suffix:semicolon
id|pSMB-&gt;Reserved3
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;SubCommand
op_assign
id|cpu_to_le16
c_func
(paren
id|TRANS2_QUERY_FS_INFORMATION
)paren
suffix:semicolon
id|pSMB-&gt;InformationLevel
op_assign
id|cpu_to_le16
c_func
(paren
id|SMB_QUERY_CIFS_UNIX_INFO
)paren
suffix:semicolon
id|pSMB-&gt;hdr.smb_buf_length
op_add_assign
id|byte_count
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
id|cpu_to_le16
c_func
(paren
id|byte_count
)paren
suffix:semicolon
id|rc
op_assign
id|SendReceive
c_func
(paren
id|xid
comma
id|tcon-&gt;ses
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMB
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMBr
comma
op_amp
id|bytes_returned
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|cERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Send error in QFSUnixInfo = %d&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* decode response */
id|rc
op_assign
id|validate_t2
c_func
(paren
(paren
r_struct
id|smb_t2_rsp
op_star
)paren
id|pSMBr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_logical_or
(paren
id|pSMBr-&gt;ByteCount
OL
l_int|13
)paren
)paren
(brace
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
multiline_comment|/* bad smb */
)brace
r_else
(brace
id|__u16
id|data_offset
op_assign
id|le16_to_cpu
c_func
(paren
id|pSMBr-&gt;t2.DataOffset
)paren
suffix:semicolon
id|response_data
op_assign
(paren
id|FILE_SYSTEM_UNIX_INFO
op_star
)paren
(paren
(paren
(paren
r_char
op_star
)paren
op_amp
id|pSMBr-&gt;hdr.Protocol
)paren
op_plus
id|data_offset
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|tcon-&gt;fsUnixInfo
comma
id|response_data
comma
r_sizeof
(paren
id|FILE_SYSTEM_UNIX_INFO
)paren
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|pSMB
)paren
id|cifs_buf_release
c_func
(paren
id|pSMB
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
op_minus
id|EAGAIN
)paren
r_goto
id|QFSUnixRetry
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/* We can not use write of zero bytes trick to &n;   set file size due to need for large file support.  Also note that &n;   this SetPathInfo is preferred to SetFileInfo based method in next &n;   routine which is only needed to work around a sharing violation bug&n;   in Samba which this routine can run into */
r_int
DECL|function|CIFSSMBSetEOF
id|CIFSSMBSetEOF
c_func
(paren
r_const
r_int
id|xid
comma
r_struct
id|cifsTconInfo
op_star
id|tcon
comma
r_const
r_char
op_star
id|fileName
comma
id|__u64
id|size
comma
r_int
id|SetAllocation
comma
r_const
r_struct
id|nls_table
op_star
id|nls_codepage
)paren
(brace
r_struct
id|smb_com_transaction2_spi_req
op_star
id|pSMB
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|smb_com_transaction2_spi_rsp
op_star
id|pSMBr
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|file_end_of_file_info
op_star
id|parm_data
suffix:semicolon
r_int
id|name_len
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|bytes_returned
op_assign
l_int|0
suffix:semicolon
id|__u16
id|params
comma
id|byte_count
comma
id|data_count
comma
id|param_offset
comma
id|offset
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;In SetEOF&quot;
)paren
)paren
suffix:semicolon
id|SetEOFRetry
suffix:colon
id|rc
op_assign
id|smb_init
c_func
(paren
id|SMB_COM_TRANSACTION2
comma
l_int|15
comma
id|tcon
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMB
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMBr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|pSMB-&gt;hdr.Flags2
op_amp
id|SMBFLG2_UNICODE
)paren
(brace
id|name_len
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|pSMB-&gt;FileName
comma
id|fileName
comma
l_int|530
multiline_comment|/* find define for this maxpathcomponent */
comma
id|nls_codepage
)paren
suffix:semicolon
id|name_len
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|name_len
op_mul_assign
l_int|2
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* BB improve the check for buffer overruns BB */
id|name_len
op_assign
id|strnlen
c_func
(paren
id|fileName
comma
l_int|530
)paren
suffix:semicolon
id|name_len
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|strncpy
c_func
(paren
id|pSMB-&gt;FileName
comma
id|fileName
comma
id|name_len
)paren
suffix:semicolon
)brace
id|params
op_assign
l_int|6
op_plus
id|name_len
suffix:semicolon
id|data_count
op_assign
r_sizeof
(paren
r_struct
id|file_end_of_file_info
)paren
suffix:semicolon
id|pSMB-&gt;MaxParameterCount
op_assign
id|cpu_to_le16
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|pSMB-&gt;MaxDataCount
op_assign
id|cpu_to_le16
c_func
(paren
l_int|1000
)paren
suffix:semicolon
multiline_comment|/* BB find max SMB size from sess */
id|pSMB-&gt;MaxSetupCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Flags
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Timeout
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved2
op_assign
l_int|0
suffix:semicolon
id|param_offset
op_assign
m_offsetof
(paren
r_struct
id|smb_com_transaction2_spi_req
comma
id|InformationLevel
)paren
op_minus
l_int|4
suffix:semicolon
id|offset
op_assign
id|param_offset
op_plus
id|params
suffix:semicolon
r_if
c_cond
(paren
id|SetAllocation
)paren
(brace
r_if
c_cond
(paren
id|tcon-&gt;ses-&gt;capabilities
op_amp
id|CAP_INFOLEVEL_PASSTHRU
)paren
id|pSMB-&gt;InformationLevel
op_assign
id|cpu_to_le16
c_func
(paren
id|SMB_SET_FILE_ALLOCATION_INFO2
)paren
suffix:semicolon
r_else
id|pSMB-&gt;InformationLevel
op_assign
id|cpu_to_le16
c_func
(paren
id|SMB_SET_FILE_ALLOCATION_INFO
)paren
suffix:semicolon
)brace
r_else
multiline_comment|/* Set File Size */
(brace
r_if
c_cond
(paren
id|tcon-&gt;ses-&gt;capabilities
op_amp
id|CAP_INFOLEVEL_PASSTHRU
)paren
id|pSMB-&gt;InformationLevel
op_assign
id|cpu_to_le16
c_func
(paren
id|SMB_SET_FILE_END_OF_FILE_INFO2
)paren
suffix:semicolon
r_else
id|pSMB-&gt;InformationLevel
op_assign
id|cpu_to_le16
c_func
(paren
id|SMB_SET_FILE_END_OF_FILE_INFO
)paren
suffix:semicolon
)brace
id|parm_data
op_assign
(paren
r_struct
id|file_end_of_file_info
op_star
)paren
(paren
(paren
(paren
r_char
op_star
)paren
op_amp
id|pSMB-&gt;hdr.Protocol
)paren
op_plus
id|offset
)paren
suffix:semicolon
id|pSMB-&gt;ParameterOffset
op_assign
id|cpu_to_le16
c_func
(paren
id|param_offset
)paren
suffix:semicolon
id|pSMB-&gt;DataOffset
op_assign
id|cpu_to_le16
c_func
(paren
id|offset
)paren
suffix:semicolon
id|pSMB-&gt;SetupCount
op_assign
l_int|1
suffix:semicolon
id|pSMB-&gt;Reserved3
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;SubCommand
op_assign
id|cpu_to_le16
c_func
(paren
id|TRANS2_SET_PATH_INFORMATION
)paren
suffix:semicolon
id|byte_count
op_assign
l_int|3
multiline_comment|/* pad */
op_plus
id|params
op_plus
id|data_count
suffix:semicolon
id|pSMB-&gt;DataCount
op_assign
id|cpu_to_le16
c_func
(paren
id|data_count
)paren
suffix:semicolon
id|pSMB-&gt;TotalDataCount
op_assign
id|pSMB-&gt;DataCount
suffix:semicolon
id|pSMB-&gt;ParameterCount
op_assign
id|cpu_to_le16
c_func
(paren
id|params
)paren
suffix:semicolon
id|pSMB-&gt;TotalParameterCount
op_assign
id|pSMB-&gt;ParameterCount
suffix:semicolon
id|pSMB-&gt;Reserved4
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;hdr.smb_buf_length
op_add_assign
id|byte_count
suffix:semicolon
id|parm_data-&gt;FileSize
op_assign
id|cpu_to_le64
c_func
(paren
id|size
)paren
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
id|cpu_to_le16
c_func
(paren
id|byte_count
)paren
suffix:semicolon
id|rc
op_assign
id|SendReceive
c_func
(paren
id|xid
comma
id|tcon-&gt;ses
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMB
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMBr
comma
op_amp
id|bytes_returned
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;SetPathInfo (file size) returned %d&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pSMB
)paren
id|cifs_buf_release
c_func
(paren
id|pSMB
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
op_minus
id|EAGAIN
)paren
r_goto
id|SetEOFRetry
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_int
DECL|function|CIFSSMBSetFileSize
id|CIFSSMBSetFileSize
c_func
(paren
r_const
r_int
id|xid
comma
r_struct
id|cifsTconInfo
op_star
id|tcon
comma
id|__u64
id|size
comma
id|__u16
id|fid
comma
id|__u32
id|pid_of_opener
comma
r_int
id|SetAllocation
)paren
(brace
r_struct
id|smb_com_transaction2_sfi_req
op_star
id|pSMB
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|smb_com_transaction2_sfi_rsp
op_star
id|pSMBr
op_assign
l_int|NULL
suffix:semicolon
r_char
op_star
id|data_offset
suffix:semicolon
r_struct
id|file_end_of_file_info
op_star
id|parm_data
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|bytes_returned
op_assign
l_int|0
suffix:semicolon
id|__u16
id|params
comma
id|param_offset
comma
id|offset
comma
id|byte_count
comma
id|count
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;SetFileSize (via SetFileInfo) %lld&quot;
comma
(paren
r_int
r_int
)paren
id|size
)paren
)paren
suffix:semicolon
id|rc
op_assign
id|smb_init
c_func
(paren
id|SMB_COM_TRANSACTION2
comma
l_int|15
comma
id|tcon
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMB
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMBr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
id|pSMB-&gt;hdr.Pid
op_assign
id|cpu_to_le16
c_func
(paren
(paren
id|__u16
)paren
id|pid_of_opener
)paren
suffix:semicolon
id|pSMB-&gt;hdr.PidHigh
op_assign
id|cpu_to_le16
c_func
(paren
(paren
id|__u16
)paren
(paren
id|pid_of_opener
op_rshift
l_int|16
)paren
)paren
suffix:semicolon
id|params
op_assign
l_int|6
suffix:semicolon
id|pSMB-&gt;MaxSetupCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Flags
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Timeout
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved2
op_assign
l_int|0
suffix:semicolon
id|param_offset
op_assign
m_offsetof
(paren
r_struct
id|smb_com_transaction2_sfi_req
comma
id|Fid
)paren
op_minus
l_int|4
suffix:semicolon
id|offset
op_assign
id|param_offset
op_plus
id|params
suffix:semicolon
id|data_offset
op_assign
(paren
r_char
op_star
)paren
(paren
op_amp
id|pSMB-&gt;hdr.Protocol
)paren
op_plus
id|offset
suffix:semicolon
id|count
op_assign
r_sizeof
(paren
r_struct
id|file_end_of_file_info
)paren
suffix:semicolon
id|pSMB-&gt;MaxParameterCount
op_assign
id|cpu_to_le16
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|pSMB-&gt;MaxDataCount
op_assign
id|cpu_to_le16
c_func
(paren
l_int|1000
)paren
suffix:semicolon
multiline_comment|/* BB find max SMB PDU from sess */
id|pSMB-&gt;SetupCount
op_assign
l_int|1
suffix:semicolon
id|pSMB-&gt;Reserved3
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;SubCommand
op_assign
id|cpu_to_le16
c_func
(paren
id|TRANS2_SET_FILE_INFORMATION
)paren
suffix:semicolon
id|byte_count
op_assign
l_int|3
multiline_comment|/* pad */
op_plus
id|params
op_plus
id|count
suffix:semicolon
id|pSMB-&gt;DataCount
op_assign
id|cpu_to_le16
c_func
(paren
id|count
)paren
suffix:semicolon
id|pSMB-&gt;ParameterCount
op_assign
id|cpu_to_le16
c_func
(paren
id|params
)paren
suffix:semicolon
id|pSMB-&gt;TotalDataCount
op_assign
id|pSMB-&gt;DataCount
suffix:semicolon
id|pSMB-&gt;TotalParameterCount
op_assign
id|pSMB-&gt;ParameterCount
suffix:semicolon
id|pSMB-&gt;ParameterOffset
op_assign
id|cpu_to_le16
c_func
(paren
id|param_offset
)paren
suffix:semicolon
id|parm_data
op_assign
(paren
r_struct
id|file_end_of_file_info
op_star
)paren
(paren
(paren
(paren
r_char
op_star
)paren
op_amp
id|pSMB-&gt;hdr.Protocol
)paren
op_plus
id|offset
)paren
suffix:semicolon
id|pSMB-&gt;DataOffset
op_assign
id|cpu_to_le16
c_func
(paren
id|offset
)paren
suffix:semicolon
id|parm_data-&gt;FileSize
op_assign
id|cpu_to_le64
c_func
(paren
id|size
)paren
suffix:semicolon
id|pSMB-&gt;Fid
op_assign
id|fid
suffix:semicolon
r_if
c_cond
(paren
id|SetAllocation
)paren
(brace
r_if
c_cond
(paren
id|tcon-&gt;ses-&gt;capabilities
op_amp
id|CAP_INFOLEVEL_PASSTHRU
)paren
id|pSMB-&gt;InformationLevel
op_assign
id|cpu_to_le16
c_func
(paren
id|SMB_SET_FILE_ALLOCATION_INFO2
)paren
suffix:semicolon
r_else
id|pSMB-&gt;InformationLevel
op_assign
id|cpu_to_le16
c_func
(paren
id|SMB_SET_FILE_ALLOCATION_INFO
)paren
suffix:semicolon
)brace
r_else
multiline_comment|/* Set File Size */
(brace
r_if
c_cond
(paren
id|tcon-&gt;ses-&gt;capabilities
op_amp
id|CAP_INFOLEVEL_PASSTHRU
)paren
id|pSMB-&gt;InformationLevel
op_assign
id|cpu_to_le16
c_func
(paren
id|SMB_SET_FILE_END_OF_FILE_INFO2
)paren
suffix:semicolon
r_else
id|pSMB-&gt;InformationLevel
op_assign
id|cpu_to_le16
c_func
(paren
id|SMB_SET_FILE_END_OF_FILE_INFO
)paren
suffix:semicolon
)brace
id|pSMB-&gt;Reserved4
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;hdr.smb_buf_length
op_add_assign
id|byte_count
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
id|cpu_to_le16
c_func
(paren
id|byte_count
)paren
suffix:semicolon
id|rc
op_assign
id|SendReceive
c_func
(paren
id|xid
comma
id|tcon-&gt;ses
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMB
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMBr
comma
op_amp
id|bytes_returned
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Send error in SetFileInfo (SetFileSize) = %d&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pSMB
)paren
id|cifs_buf_release
c_func
(paren
id|pSMB
)paren
suffix:semicolon
multiline_comment|/* Note: On -EAGAIN error only caller can retry on handle based calls &n;&t;&t;since file handle passed in no longer valid */
r_return
id|rc
suffix:semicolon
)brace
r_int
DECL|function|CIFSSMBSetTimes
id|CIFSSMBSetTimes
c_func
(paren
r_const
r_int
id|xid
comma
r_struct
id|cifsTconInfo
op_star
id|tcon
comma
r_const
r_char
op_star
id|fileName
comma
r_const
id|FILE_BASIC_INFO
op_star
id|data
comma
r_const
r_struct
id|nls_table
op_star
id|nls_codepage
)paren
(brace
id|TRANSACTION2_SPI_REQ
op_star
id|pSMB
op_assign
l_int|NULL
suffix:semicolon
id|TRANSACTION2_SPI_RSP
op_star
id|pSMBr
op_assign
l_int|NULL
suffix:semicolon
r_int
id|name_len
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|bytes_returned
op_assign
l_int|0
suffix:semicolon
r_char
op_star
id|data_offset
suffix:semicolon
id|__u16
id|params
comma
id|param_offset
comma
id|offset
comma
id|byte_count
comma
id|count
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;In SetTimes&quot;
)paren
)paren
suffix:semicolon
id|SetTimesRetry
suffix:colon
id|rc
op_assign
id|smb_init
c_func
(paren
id|SMB_COM_TRANSACTION2
comma
l_int|15
comma
id|tcon
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMB
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMBr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|pSMB-&gt;hdr.Flags2
op_amp
id|SMBFLG2_UNICODE
)paren
(brace
id|name_len
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|pSMB-&gt;FileName
comma
id|fileName
comma
l_int|530
multiline_comment|/* find define for this maxpathcomponent */
comma
id|nls_codepage
)paren
suffix:semicolon
id|name_len
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|name_len
op_mul_assign
l_int|2
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* BB improve the check for buffer overruns BB */
id|name_len
op_assign
id|strnlen
c_func
(paren
id|fileName
comma
l_int|530
)paren
suffix:semicolon
id|name_len
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|strncpy
c_func
(paren
id|pSMB-&gt;FileName
comma
id|fileName
comma
id|name_len
)paren
suffix:semicolon
)brace
id|params
op_assign
l_int|6
op_plus
id|name_len
suffix:semicolon
id|count
op_assign
r_sizeof
(paren
id|FILE_BASIC_INFO
)paren
suffix:semicolon
id|pSMB-&gt;MaxParameterCount
op_assign
id|cpu_to_le16
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|pSMB-&gt;MaxDataCount
op_assign
id|cpu_to_le16
c_func
(paren
l_int|1000
)paren
suffix:semicolon
multiline_comment|/* BB find exact max SMB PDU from sess structure BB */
id|pSMB-&gt;MaxSetupCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Flags
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Timeout
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved2
op_assign
l_int|0
suffix:semicolon
id|param_offset
op_assign
m_offsetof
(paren
r_struct
id|smb_com_transaction2_spi_req
comma
id|InformationLevel
)paren
op_minus
l_int|4
suffix:semicolon
id|offset
op_assign
id|param_offset
op_plus
id|params
suffix:semicolon
id|data_offset
op_assign
(paren
r_char
op_star
)paren
(paren
op_amp
id|pSMB-&gt;hdr.Protocol
)paren
op_plus
id|offset
suffix:semicolon
id|pSMB-&gt;ParameterOffset
op_assign
id|cpu_to_le16
c_func
(paren
id|param_offset
)paren
suffix:semicolon
id|pSMB-&gt;DataOffset
op_assign
id|cpu_to_le16
c_func
(paren
id|offset
)paren
suffix:semicolon
id|pSMB-&gt;SetupCount
op_assign
l_int|1
suffix:semicolon
id|pSMB-&gt;Reserved3
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;SubCommand
op_assign
id|cpu_to_le16
c_func
(paren
id|TRANS2_SET_PATH_INFORMATION
)paren
suffix:semicolon
id|byte_count
op_assign
l_int|3
multiline_comment|/* pad */
op_plus
id|params
op_plus
id|count
suffix:semicolon
id|pSMB-&gt;DataCount
op_assign
id|cpu_to_le16
c_func
(paren
id|count
)paren
suffix:semicolon
id|pSMB-&gt;ParameterCount
op_assign
id|cpu_to_le16
c_func
(paren
id|params
)paren
suffix:semicolon
id|pSMB-&gt;TotalDataCount
op_assign
id|pSMB-&gt;DataCount
suffix:semicolon
id|pSMB-&gt;TotalParameterCount
op_assign
id|pSMB-&gt;ParameterCount
suffix:semicolon
r_if
c_cond
(paren
id|tcon-&gt;ses-&gt;capabilities
op_amp
id|CAP_INFOLEVEL_PASSTHRU
)paren
id|pSMB-&gt;InformationLevel
op_assign
id|cpu_to_le16
c_func
(paren
id|SMB_SET_FILE_BASIC_INFO2
)paren
suffix:semicolon
r_else
id|pSMB-&gt;InformationLevel
op_assign
id|cpu_to_le16
c_func
(paren
id|SMB_SET_FILE_BASIC_INFO
)paren
suffix:semicolon
id|pSMB-&gt;Reserved4
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;hdr.smb_buf_length
op_add_assign
id|byte_count
suffix:semicolon
id|memcpy
c_func
(paren
id|data_offset
comma
id|data
comma
r_sizeof
(paren
id|FILE_BASIC_INFO
)paren
)paren
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
id|cpu_to_le16
c_func
(paren
id|byte_count
)paren
suffix:semicolon
id|rc
op_assign
id|SendReceive
c_func
(paren
id|xid
comma
id|tcon-&gt;ses
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMB
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMBr
comma
op_amp
id|bytes_returned
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;SetPathInfo (times) returned %d&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pSMB
)paren
id|cifs_buf_release
c_func
(paren
id|pSMB
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
op_minus
id|EAGAIN
)paren
r_goto
id|SetTimesRetry
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_int
DECL|function|CIFSSMBSetTimesLegacy
id|CIFSSMBSetTimesLegacy
c_func
(paren
r_int
id|xid
comma
r_struct
id|cifsTconInfo
op_star
id|tcon
comma
r_char
op_star
id|fileName
comma
id|FILE_INFO_STANDARD
op_star
id|data
comma
r_const
r_struct
id|nls_table
op_star
id|nls_codepage
)paren
(brace
id|TRANSACTION2_SPI_REQ
op_star
id|pSMB
op_assign
l_int|NULL
suffix:semicolon
id|TRANSACTION2_SPI_RSP
op_star
id|pSMBr
op_assign
l_int|NULL
suffix:semicolon
r_int
id|name_len
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|bytes_returned
op_assign
l_int|0
suffix:semicolon
r_char
op_star
id|data_offset
suffix:semicolon
id|__u16
id|params
comma
id|param_offset
comma
id|count
comma
id|offset
comma
id|byte_count
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;In SetTimesLegacy&quot;
)paren
)paren
suffix:semicolon
id|SetTimesRetryLegacy
suffix:colon
id|rc
op_assign
id|smb_init
c_func
(paren
id|SMB_COM_TRANSACTION2
comma
l_int|15
comma
id|tcon
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMB
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMBr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|pSMB-&gt;hdr.Flags2
op_amp
id|SMBFLG2_UNICODE
)paren
(brace
id|name_len
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|pSMB-&gt;FileName
comma
id|fileName
comma
l_int|530
multiline_comment|/* find define for this maxpathcomponent */
comma
id|nls_codepage
)paren
suffix:semicolon
id|name_len
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|name_len
op_mul_assign
l_int|2
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* BB improve the check for buffer overruns BB */
id|name_len
op_assign
id|strnlen
c_func
(paren
id|fileName
comma
l_int|530
)paren
suffix:semicolon
id|name_len
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|strncpy
c_func
(paren
id|pSMB-&gt;FileName
comma
id|fileName
comma
id|name_len
)paren
suffix:semicolon
)brace
multiline_comment|/* BB fixme - we have to map to FILE_STANDARD_INFO (level 1 info&n;&t;in parent function, from the better and ususal FILE_BASIC_INFO */
id|params
op_assign
l_int|6
op_plus
id|name_len
suffix:semicolon
id|count
op_assign
r_sizeof
(paren
id|FILE_INFO_STANDARD
)paren
suffix:semicolon
id|pSMB-&gt;MaxParameterCount
op_assign
id|cpu_to_le16
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|pSMB-&gt;MaxDataCount
op_assign
id|cpu_to_le16
c_func
(paren
l_int|1000
)paren
suffix:semicolon
multiline_comment|/* BB find exact max SMB PDU from sess structure BB */
id|pSMB-&gt;MaxSetupCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Flags
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Timeout
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved2
op_assign
l_int|0
suffix:semicolon
id|param_offset
op_assign
m_offsetof
(paren
r_struct
id|smb_com_transaction2_spi_req
comma
id|InformationLevel
)paren
op_minus
l_int|4
suffix:semicolon
id|offset
op_assign
id|param_offset
op_plus
id|params
suffix:semicolon
id|data_offset
op_assign
(paren
r_char
op_star
)paren
(paren
op_amp
id|pSMB-&gt;hdr.Protocol
)paren
op_plus
id|offset
suffix:semicolon
id|pSMB-&gt;ParameterOffset
op_assign
id|cpu_to_le16
c_func
(paren
id|param_offset
)paren
suffix:semicolon
id|pSMB-&gt;DataOffset
op_assign
id|cpu_to_le16
c_func
(paren
id|offset
)paren
suffix:semicolon
id|pSMB-&gt;SetupCount
op_assign
l_int|1
suffix:semicolon
id|pSMB-&gt;Reserved3
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;SubCommand
op_assign
id|cpu_to_le16
c_func
(paren
id|TRANS2_SET_PATH_INFORMATION
)paren
suffix:semicolon
id|byte_count
op_assign
l_int|3
multiline_comment|/* pad */
op_plus
id|params
op_plus
id|count
suffix:semicolon
id|pSMB-&gt;DataCount
op_assign
id|cpu_to_le16
c_func
(paren
id|count
)paren
suffix:semicolon
id|pSMB-&gt;ParameterCount
op_assign
id|cpu_to_le16
c_func
(paren
id|params
)paren
suffix:semicolon
id|pSMB-&gt;TotalDataCount
op_assign
id|pSMB-&gt;DataCount
suffix:semicolon
id|pSMB-&gt;TotalParameterCount
op_assign
id|pSMB-&gt;ParameterCount
suffix:semicolon
multiline_comment|/* I doubt that passthrough levels apply to this old&n;&t;preNT info level */
multiline_comment|/*&t;if (tcon-&gt;ses-&gt;capabilities &amp; CAP_INFOLEVEL_PASSTHRU)&n;&t;&t;pSMB-&gt;InformationLevel = cpu_to_le16(SMB_SET_FILE_BASIC_INFO2);&n;&t;else*/
id|pSMB-&gt;InformationLevel
op_assign
id|cpu_to_le16
c_func
(paren
id|SMB_INFO_STANDARD
)paren
suffix:semicolon
id|pSMB-&gt;Reserved4
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;hdr.smb_buf_length
op_add_assign
id|byte_count
suffix:semicolon
id|memcpy
c_func
(paren
id|data_offset
comma
id|data
comma
r_sizeof
(paren
id|FILE_INFO_STANDARD
)paren
)paren
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
id|cpu_to_le16
c_func
(paren
id|byte_count
)paren
suffix:semicolon
id|rc
op_assign
id|SendReceive
c_func
(paren
id|xid
comma
id|tcon-&gt;ses
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMB
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMBr
comma
op_amp
id|bytes_returned
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;SetPathInfo (times legacy) returned %d&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pSMB
)paren
id|cifs_buf_release
c_func
(paren
id|pSMB
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
op_minus
id|EAGAIN
)paren
r_goto
id|SetTimesRetryLegacy
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_int
DECL|function|CIFSSMBUnixSetPerms
id|CIFSSMBUnixSetPerms
c_func
(paren
r_const
r_int
id|xid
comma
r_struct
id|cifsTconInfo
op_star
id|tcon
comma
r_char
op_star
id|fileName
comma
id|__u64
id|mode
comma
id|__u64
id|uid
comma
id|__u64
id|gid
comma
id|dev_t
id|device
comma
r_const
r_struct
id|nls_table
op_star
id|nls_codepage
)paren
(brace
id|TRANSACTION2_SPI_REQ
op_star
id|pSMB
op_assign
l_int|NULL
suffix:semicolon
id|TRANSACTION2_SPI_RSP
op_star
id|pSMBr
op_assign
l_int|NULL
suffix:semicolon
r_int
id|name_len
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|bytes_returned
op_assign
l_int|0
suffix:semicolon
id|FILE_UNIX_BASIC_INFO
op_star
id|data_offset
suffix:semicolon
id|__u16
id|params
comma
id|param_offset
comma
id|offset
comma
id|count
comma
id|byte_count
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;In SetUID/GID/Mode&quot;
)paren
)paren
suffix:semicolon
id|setPermsRetry
suffix:colon
id|rc
op_assign
id|smb_init
c_func
(paren
id|SMB_COM_TRANSACTION2
comma
l_int|15
comma
id|tcon
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMB
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMBr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|pSMB-&gt;hdr.Flags2
op_amp
id|SMBFLG2_UNICODE
)paren
(brace
id|name_len
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|pSMB-&gt;FileName
comma
id|fileName
comma
l_int|530
multiline_comment|/* find define for this maxpathcomponent */
comma
id|nls_codepage
)paren
suffix:semicolon
id|name_len
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|name_len
op_mul_assign
l_int|2
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* BB improve the check for buffer overruns BB */
id|name_len
op_assign
id|strnlen
c_func
(paren
id|fileName
comma
l_int|530
)paren
suffix:semicolon
id|name_len
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|strncpy
c_func
(paren
id|pSMB-&gt;FileName
comma
id|fileName
comma
id|name_len
)paren
suffix:semicolon
)brace
id|params
op_assign
l_int|6
op_plus
id|name_len
suffix:semicolon
id|count
op_assign
r_sizeof
(paren
id|FILE_UNIX_BASIC_INFO
)paren
suffix:semicolon
id|pSMB-&gt;MaxParameterCount
op_assign
id|cpu_to_le16
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|pSMB-&gt;MaxDataCount
op_assign
id|cpu_to_le16
c_func
(paren
l_int|1000
)paren
suffix:semicolon
multiline_comment|/* BB find exact max SMB PDU from sess structure BB */
id|pSMB-&gt;MaxSetupCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Flags
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Timeout
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved2
op_assign
l_int|0
suffix:semicolon
id|param_offset
op_assign
m_offsetof
(paren
r_struct
id|smb_com_transaction2_spi_req
comma
id|InformationLevel
)paren
op_minus
l_int|4
suffix:semicolon
id|offset
op_assign
id|param_offset
op_plus
id|params
suffix:semicolon
id|data_offset
op_assign
(paren
id|FILE_UNIX_BASIC_INFO
op_star
)paren
(paren
(paren
r_char
op_star
)paren
op_amp
id|pSMB-&gt;hdr.Protocol
op_plus
id|offset
)paren
suffix:semicolon
id|memset
c_func
(paren
id|data_offset
comma
l_int|0
comma
id|count
)paren
suffix:semicolon
id|pSMB-&gt;DataOffset
op_assign
id|cpu_to_le16
c_func
(paren
id|offset
)paren
suffix:semicolon
id|pSMB-&gt;ParameterOffset
op_assign
id|cpu_to_le16
c_func
(paren
id|param_offset
)paren
suffix:semicolon
id|pSMB-&gt;SetupCount
op_assign
l_int|1
suffix:semicolon
id|pSMB-&gt;Reserved3
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;SubCommand
op_assign
id|cpu_to_le16
c_func
(paren
id|TRANS2_SET_PATH_INFORMATION
)paren
suffix:semicolon
id|byte_count
op_assign
l_int|3
multiline_comment|/* pad */
op_plus
id|params
op_plus
id|count
suffix:semicolon
id|pSMB-&gt;ParameterCount
op_assign
id|cpu_to_le16
c_func
(paren
id|params
)paren
suffix:semicolon
id|pSMB-&gt;DataCount
op_assign
id|cpu_to_le16
c_func
(paren
id|count
)paren
suffix:semicolon
id|pSMB-&gt;TotalParameterCount
op_assign
id|pSMB-&gt;ParameterCount
suffix:semicolon
id|pSMB-&gt;TotalDataCount
op_assign
id|pSMB-&gt;DataCount
suffix:semicolon
id|pSMB-&gt;InformationLevel
op_assign
id|cpu_to_le16
c_func
(paren
id|SMB_SET_FILE_UNIX_BASIC
)paren
suffix:semicolon
id|pSMB-&gt;Reserved4
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;hdr.smb_buf_length
op_add_assign
id|byte_count
suffix:semicolon
id|data_offset-&gt;Uid
op_assign
id|cpu_to_le64
c_func
(paren
id|uid
)paren
suffix:semicolon
id|data_offset-&gt;Gid
op_assign
id|cpu_to_le64
c_func
(paren
id|gid
)paren
suffix:semicolon
multiline_comment|/* better to leave device as zero when it is  */
id|data_offset-&gt;DevMajor
op_assign
id|cpu_to_le64
c_func
(paren
id|MAJOR
c_func
(paren
id|device
)paren
)paren
suffix:semicolon
id|data_offset-&gt;DevMinor
op_assign
id|cpu_to_le64
c_func
(paren
id|MINOR
c_func
(paren
id|device
)paren
)paren
suffix:semicolon
id|data_offset-&gt;Permissions
op_assign
id|cpu_to_le64
c_func
(paren
id|mode
)paren
suffix:semicolon
r_if
c_cond
(paren
id|S_ISREG
c_func
(paren
id|mode
)paren
)paren
(brace
id|data_offset-&gt;Type
op_assign
id|cpu_to_le32
c_func
(paren
id|UNIX_FILE
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|S_ISDIR
c_func
(paren
id|mode
)paren
)paren
(brace
id|data_offset-&gt;Type
op_assign
id|cpu_to_le32
c_func
(paren
id|UNIX_DIR
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|S_ISLNK
c_func
(paren
id|mode
)paren
)paren
(brace
id|data_offset-&gt;Type
op_assign
id|cpu_to_le32
c_func
(paren
id|UNIX_SYMLINK
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|S_ISCHR
c_func
(paren
id|mode
)paren
)paren
(brace
id|data_offset-&gt;Type
op_assign
id|cpu_to_le32
c_func
(paren
id|UNIX_CHARDEV
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|S_ISBLK
c_func
(paren
id|mode
)paren
)paren
(brace
id|data_offset-&gt;Type
op_assign
id|cpu_to_le32
c_func
(paren
id|UNIX_BLOCKDEV
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|S_ISFIFO
c_func
(paren
id|mode
)paren
)paren
(brace
id|data_offset-&gt;Type
op_assign
id|cpu_to_le32
c_func
(paren
id|UNIX_FIFO
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|S_ISSOCK
c_func
(paren
id|mode
)paren
)paren
(brace
id|data_offset-&gt;Type
op_assign
id|cpu_to_le32
c_func
(paren
id|UNIX_SOCKET
)paren
suffix:semicolon
)brace
id|pSMB-&gt;ByteCount
op_assign
id|cpu_to_le16
c_func
(paren
id|byte_count
)paren
suffix:semicolon
id|rc
op_assign
id|SendReceive
c_func
(paren
id|xid
comma
id|tcon-&gt;ses
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMB
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMBr
comma
op_amp
id|bytes_returned
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;SetPathInfo (perms) returned %d&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pSMB
)paren
id|cifs_buf_release
c_func
(paren
id|pSMB
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
op_minus
id|EAGAIN
)paren
r_goto
id|setPermsRetry
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|CIFSSMBNotify
r_int
id|CIFSSMBNotify
c_func
(paren
r_const
r_int
id|xid
comma
r_struct
id|cifsTconInfo
op_star
id|tcon
comma
r_const
r_int
id|notify_subdirs
comma
r_const
id|__u16
id|netfid
comma
id|__u32
id|filter
comma
r_const
r_struct
id|nls_table
op_star
id|nls_codepage
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_struct
id|smb_com_transaction_change_notify_req
op_star
id|pSMB
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|smb_com_transaction_change_notify_rsp
op_star
id|pSMBr
op_assign
l_int|NULL
suffix:semicolon
r_int
id|bytes_returned
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;In CIFSSMBNotify for file handle %d&quot;
comma
(paren
r_int
)paren
id|netfid
)paren
)paren
suffix:semicolon
id|rc
op_assign
id|smb_init
c_func
(paren
id|SMB_COM_NT_TRANSACT
comma
l_int|23
comma
id|tcon
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMB
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMBr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
id|pSMB-&gt;TotalParameterCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;TotalDataCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;MaxParameterCount
op_assign
id|cpu_to_le32
c_func
(paren
l_int|2
)paren
suffix:semicolon
multiline_comment|/* BB find exact data count max from sess structure BB */
id|pSMB-&gt;MaxDataCount
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* same in little endian or be */
id|pSMB-&gt;MaxSetupCount
op_assign
l_int|4
suffix:semicolon
id|pSMB-&gt;Reserved
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;ParameterOffset
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;DataCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;DataOffset
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;SetupCount
op_assign
l_int|4
suffix:semicolon
multiline_comment|/* single byte does not need le conversion */
id|pSMB-&gt;SubCommand
op_assign
id|cpu_to_le16
c_func
(paren
id|NT_TRANSACT_NOTIFY_CHANGE
)paren
suffix:semicolon
id|pSMB-&gt;ParameterCount
op_assign
id|pSMB-&gt;TotalParameterCount
suffix:semicolon
r_if
c_cond
(paren
id|notify_subdirs
)paren
(brace
id|pSMB-&gt;WatchTree
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* one byte - no le conversion needed */
id|pSMB-&gt;Reserved2
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;CompletionFilter
op_assign
id|cpu_to_le32
c_func
(paren
id|filter
)paren
suffix:semicolon
id|pSMB-&gt;Fid
op_assign
id|netfid
suffix:semicolon
multiline_comment|/* file handle always le */
id|pSMB-&gt;ByteCount
op_assign
l_int|0
suffix:semicolon
id|rc
op_assign
id|SendReceive
c_func
(paren
id|xid
comma
id|tcon-&gt;ses
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMB
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMBr
comma
op_amp
id|bytes_returned
comma
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Error in Notify = %d&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pSMB
)paren
id|cifs_buf_release
c_func
(paren
id|pSMB
)paren
suffix:semicolon
multiline_comment|/*&t;&t;if (rc == -EAGAIN)&n;&t;&t;&t;goto NotifyRetry; */
r_return
id|rc
suffix:semicolon
)brace
macro_line|#ifdef CONFIG_CIFS_XATTR
id|ssize_t
DECL|function|CIFSSMBQAllEAs
id|CIFSSMBQAllEAs
c_func
(paren
r_const
r_int
id|xid
comma
r_struct
id|cifsTconInfo
op_star
id|tcon
comma
r_const
r_int
r_char
op_star
id|searchName
comma
r_char
op_star
id|EAData
comma
r_int
id|buf_size
comma
r_const
r_struct
id|nls_table
op_star
id|nls_codepage
)paren
(brace
multiline_comment|/* BB assumes one setup word */
id|TRANSACTION2_QPI_REQ
op_star
id|pSMB
op_assign
l_int|NULL
suffix:semicolon
id|TRANSACTION2_QPI_RSP
op_star
id|pSMBr
op_assign
l_int|NULL
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|bytes_returned
suffix:semicolon
r_int
id|name_len
suffix:semicolon
r_struct
id|fea
op_star
id|temp_fea
suffix:semicolon
r_char
op_star
id|temp_ptr
suffix:semicolon
id|__u16
id|params
comma
id|byte_count
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;In Query All EAs path %s&quot;
comma
id|searchName
)paren
)paren
suffix:semicolon
id|QAllEAsRetry
suffix:colon
id|rc
op_assign
id|smb_init
c_func
(paren
id|SMB_COM_TRANSACTION2
comma
l_int|15
comma
id|tcon
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMB
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMBr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|pSMB-&gt;hdr.Flags2
op_amp
id|SMBFLG2_UNICODE
)paren
(brace
id|name_len
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|pSMB-&gt;FileName
comma
id|searchName
comma
l_int|530
multiline_comment|/* find define for this maxpathcomponent */
comma
id|nls_codepage
)paren
suffix:semicolon
id|name_len
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|name_len
op_mul_assign
l_int|2
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* BB improve the check for buffer overruns BB */
id|name_len
op_assign
id|strnlen
c_func
(paren
id|searchName
comma
l_int|530
)paren
suffix:semicolon
id|name_len
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|strncpy
c_func
(paren
id|pSMB-&gt;FileName
comma
id|searchName
comma
id|name_len
)paren
suffix:semicolon
)brace
id|params
op_assign
l_int|2
multiline_comment|/* level */
op_plus
l_int|4
multiline_comment|/* reserved */
op_plus
id|name_len
multiline_comment|/* includes NUL */
suffix:semicolon
id|pSMB-&gt;TotalDataCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;MaxParameterCount
op_assign
id|cpu_to_le16
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|pSMB-&gt;MaxDataCount
op_assign
id|cpu_to_le16
c_func
(paren
l_int|4000
)paren
suffix:semicolon
multiline_comment|/* BB find exact max SMB PDU from sess structure BB */
id|pSMB-&gt;MaxSetupCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Flags
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Timeout
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved2
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;ParameterOffset
op_assign
id|cpu_to_le16
c_func
(paren
m_offsetof
(paren
r_struct
id|smb_com_transaction2_qpi_req
comma
id|InformationLevel
)paren
op_minus
l_int|4
)paren
suffix:semicolon
id|pSMB-&gt;DataCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;DataOffset
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;SetupCount
op_assign
l_int|1
suffix:semicolon
id|pSMB-&gt;Reserved3
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;SubCommand
op_assign
id|cpu_to_le16
c_func
(paren
id|TRANS2_QUERY_PATH_INFORMATION
)paren
suffix:semicolon
id|byte_count
op_assign
id|params
op_plus
l_int|1
multiline_comment|/* pad */
suffix:semicolon
id|pSMB-&gt;TotalParameterCount
op_assign
id|cpu_to_le16
c_func
(paren
id|params
)paren
suffix:semicolon
id|pSMB-&gt;ParameterCount
op_assign
id|pSMB-&gt;TotalParameterCount
suffix:semicolon
id|pSMB-&gt;InformationLevel
op_assign
id|cpu_to_le16
c_func
(paren
id|SMB_INFO_QUERY_ALL_EAS
)paren
suffix:semicolon
id|pSMB-&gt;Reserved4
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;hdr.smb_buf_length
op_add_assign
id|byte_count
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
id|cpu_to_le16
c_func
(paren
id|byte_count
)paren
suffix:semicolon
id|rc
op_assign
id|SendReceive
c_func
(paren
id|xid
comma
id|tcon-&gt;ses
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMB
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMBr
comma
op_amp
id|bytes_returned
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Send error in QueryAllEAs = %d&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* decode response */
id|rc
op_assign
id|validate_t2
c_func
(paren
(paren
r_struct
id|smb_t2_rsp
op_star
)paren
id|pSMBr
)paren
suffix:semicolon
multiline_comment|/* BB also check enough total bytes returned */
multiline_comment|/* BB we need to improve the validity checking&n;&t;&t;of these trans2 responses */
r_if
c_cond
(paren
id|rc
op_logical_or
(paren
id|pSMBr-&gt;ByteCount
OL
l_int|4
)paren
)paren
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
multiline_comment|/* bad smb */
multiline_comment|/* else if (pFindData){&n;&t;&t;&t;memcpy((char *) pFindData,&n;&t;&t;&t;       (char *) &amp;pSMBr-&gt;hdr.Protocol +&n;&t;&t;&t;       data_offset, kl);&n;&t;&t;}*/
r_else
(brace
multiline_comment|/* check that length of list is not more than bcc */
multiline_comment|/* check that each entry does not go beyond length&n;&t;&t;&t;   of list */
multiline_comment|/* check that each element of each entry does not&n;&t;&t;&t;   go beyond end of list */
id|__u16
id|data_offset
op_assign
id|le16_to_cpu
c_func
(paren
id|pSMBr-&gt;t2.DataOffset
)paren
suffix:semicolon
r_struct
id|fealist
op_star
id|ea_response_data
suffix:semicolon
id|rc
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* validate_trans2_offsets() */
multiline_comment|/* BB to check if(start of smb + data_offset &gt; &amp;bcc+ bcc)*/
id|ea_response_data
op_assign
(paren
r_struct
id|fealist
op_star
)paren
(paren
(paren
(paren
r_char
op_star
)paren
op_amp
id|pSMBr-&gt;hdr.Protocol
)paren
op_plus
id|data_offset
)paren
suffix:semicolon
id|name_len
op_assign
id|le32_to_cpu
c_func
(paren
id|ea_response_data-&gt;list_len
)paren
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;ea length %d&quot;
comma
id|name_len
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|name_len
op_le
l_int|8
)paren
(brace
multiline_comment|/* returned EA size zeroed at top of function */
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;empty EA list returned from server&quot;
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* account for ea list len */
id|name_len
op_sub_assign
l_int|4
suffix:semicolon
id|temp_fea
op_assign
id|ea_response_data-&gt;list
suffix:semicolon
id|temp_ptr
op_assign
(paren
r_char
op_star
)paren
id|temp_fea
suffix:semicolon
r_while
c_loop
(paren
id|name_len
OG
l_int|0
)paren
(brace
id|__u16
id|value_len
suffix:semicolon
id|name_len
op_sub_assign
l_int|4
suffix:semicolon
id|temp_ptr
op_add_assign
l_int|4
suffix:semicolon
id|rc
op_add_assign
id|temp_fea-&gt;name_len
suffix:semicolon
multiline_comment|/* account for prefix user. and trailing null */
id|rc
op_assign
id|rc
op_plus
l_int|5
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
(paren
r_int
)paren
id|buf_size
)paren
(brace
id|memcpy
c_func
(paren
id|EAData
comma
l_string|&quot;user.&quot;
comma
l_int|5
)paren
suffix:semicolon
id|EAData
op_add_assign
l_int|5
suffix:semicolon
id|memcpy
c_func
(paren
id|EAData
comma
id|temp_ptr
comma
id|temp_fea-&gt;name_len
)paren
suffix:semicolon
id|EAData
op_add_assign
id|temp_fea-&gt;name_len
suffix:semicolon
multiline_comment|/* null terminate name */
op_star
id|EAData
op_assign
l_int|0
suffix:semicolon
id|EAData
op_assign
id|EAData
op_plus
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|buf_size
op_eq
l_int|0
)paren
(brace
multiline_comment|/* skip copy - calc size only */
)brace
r_else
(brace
multiline_comment|/* stop before overrun buffer */
id|rc
op_assign
op_minus
id|ERANGE
suffix:semicolon
r_break
suffix:semicolon
)brace
id|name_len
op_sub_assign
id|temp_fea-&gt;name_len
suffix:semicolon
id|temp_ptr
op_add_assign
id|temp_fea-&gt;name_len
suffix:semicolon
multiline_comment|/* account for trailing null */
id|name_len
op_decrement
suffix:semicolon
id|temp_ptr
op_increment
suffix:semicolon
id|value_len
op_assign
id|le16_to_cpu
c_func
(paren
id|temp_fea-&gt;value_len
)paren
suffix:semicolon
id|name_len
op_sub_assign
id|value_len
suffix:semicolon
id|temp_ptr
op_add_assign
id|value_len
suffix:semicolon
multiline_comment|/* BB check that temp_ptr is still within smb BB*/
multiline_comment|/* no trailing null to account for in value len */
multiline_comment|/* go on to next EA */
id|temp_fea
op_assign
(paren
r_struct
id|fea
op_star
)paren
id|temp_ptr
suffix:semicolon
)brace
)brace
)brace
)brace
r_if
c_cond
(paren
id|pSMB
)paren
id|cifs_buf_release
c_func
(paren
id|pSMB
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
op_minus
id|EAGAIN
)paren
r_goto
id|QAllEAsRetry
suffix:semicolon
r_return
(paren
id|ssize_t
)paren
id|rc
suffix:semicolon
)brace
DECL|function|CIFSSMBQueryEA
id|ssize_t
id|CIFSSMBQueryEA
c_func
(paren
r_const
r_int
id|xid
comma
r_struct
id|cifsTconInfo
op_star
id|tcon
comma
r_const
r_int
r_char
op_star
id|searchName
comma
r_const
r_int
r_char
op_star
id|ea_name
comma
r_int
r_char
op_star
id|ea_value
comma
r_int
id|buf_size
comma
r_const
r_struct
id|nls_table
op_star
id|nls_codepage
)paren
(brace
id|TRANSACTION2_QPI_REQ
op_star
id|pSMB
op_assign
l_int|NULL
suffix:semicolon
id|TRANSACTION2_QPI_RSP
op_star
id|pSMBr
op_assign
l_int|NULL
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|bytes_returned
suffix:semicolon
r_int
id|name_len
suffix:semicolon
r_struct
id|fea
op_star
id|temp_fea
suffix:semicolon
r_char
op_star
id|temp_ptr
suffix:semicolon
id|__u16
id|params
comma
id|byte_count
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;In Query EA path %s&quot;
comma
id|searchName
)paren
)paren
suffix:semicolon
id|QEARetry
suffix:colon
id|rc
op_assign
id|smb_init
c_func
(paren
id|SMB_COM_TRANSACTION2
comma
l_int|15
comma
id|tcon
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMB
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMBr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|pSMB-&gt;hdr.Flags2
op_amp
id|SMBFLG2_UNICODE
)paren
(brace
id|name_len
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|pSMB-&gt;FileName
comma
id|searchName
comma
l_int|530
multiline_comment|/* find define for this maxpathcomponent */
comma
id|nls_codepage
)paren
suffix:semicolon
id|name_len
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|name_len
op_mul_assign
l_int|2
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* BB improve the check for buffer overruns BB */
id|name_len
op_assign
id|strnlen
c_func
(paren
id|searchName
comma
l_int|530
)paren
suffix:semicolon
id|name_len
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|strncpy
c_func
(paren
id|pSMB-&gt;FileName
comma
id|searchName
comma
id|name_len
)paren
suffix:semicolon
)brace
id|params
op_assign
l_int|2
multiline_comment|/* level */
op_plus
l_int|4
multiline_comment|/* reserved */
op_plus
id|name_len
multiline_comment|/* includes NUL */
suffix:semicolon
id|pSMB-&gt;TotalDataCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;MaxParameterCount
op_assign
id|cpu_to_le16
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|pSMB-&gt;MaxDataCount
op_assign
id|cpu_to_le16
c_func
(paren
l_int|4000
)paren
suffix:semicolon
multiline_comment|/* BB find exact max SMB PDU from sess structure BB */
id|pSMB-&gt;MaxSetupCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Flags
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Timeout
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved2
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;ParameterOffset
op_assign
id|cpu_to_le16
c_func
(paren
m_offsetof
(paren
r_struct
id|smb_com_transaction2_qpi_req
comma
id|InformationLevel
)paren
op_minus
l_int|4
)paren
suffix:semicolon
id|pSMB-&gt;DataCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;DataOffset
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;SetupCount
op_assign
l_int|1
suffix:semicolon
id|pSMB-&gt;Reserved3
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;SubCommand
op_assign
id|cpu_to_le16
c_func
(paren
id|TRANS2_QUERY_PATH_INFORMATION
)paren
suffix:semicolon
id|byte_count
op_assign
id|params
op_plus
l_int|1
multiline_comment|/* pad */
suffix:semicolon
id|pSMB-&gt;TotalParameterCount
op_assign
id|cpu_to_le16
c_func
(paren
id|params
)paren
suffix:semicolon
id|pSMB-&gt;ParameterCount
op_assign
id|pSMB-&gt;TotalParameterCount
suffix:semicolon
id|pSMB-&gt;InformationLevel
op_assign
id|cpu_to_le16
c_func
(paren
id|SMB_INFO_QUERY_ALL_EAS
)paren
suffix:semicolon
id|pSMB-&gt;Reserved4
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;hdr.smb_buf_length
op_add_assign
id|byte_count
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
id|cpu_to_le16
c_func
(paren
id|byte_count
)paren
suffix:semicolon
id|rc
op_assign
id|SendReceive
c_func
(paren
id|xid
comma
id|tcon-&gt;ses
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMB
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMBr
comma
op_amp
id|bytes_returned
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Send error in Query EA = %d&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* decode response */
id|rc
op_assign
id|validate_t2
c_func
(paren
(paren
r_struct
id|smb_t2_rsp
op_star
)paren
id|pSMBr
)paren
suffix:semicolon
multiline_comment|/* BB also check enough total bytes returned */
multiline_comment|/* BB we need to improve the validity checking&n;&t;&t;of these trans2 responses */
r_if
c_cond
(paren
id|rc
op_logical_or
(paren
id|pSMBr-&gt;ByteCount
OL
l_int|4
)paren
)paren
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
multiline_comment|/* bad smb */
multiline_comment|/* else if (pFindData){&n;&t;&t;&t;memcpy((char *) pFindData,&n;&t;&t;&t;       (char *) &amp;pSMBr-&gt;hdr.Protocol +&n;&t;&t;&t;       data_offset, kl);&n;&t;&t;}*/
r_else
(brace
multiline_comment|/* check that length of list is not more than bcc */
multiline_comment|/* check that each entry does not go beyond length&n;&t;&t;&t;   of list */
multiline_comment|/* check that each element of each entry does not&n;&t;&t;&t;   go beyond end of list */
id|__u16
id|data_offset
op_assign
id|le16_to_cpu
c_func
(paren
id|pSMBr-&gt;t2.DataOffset
)paren
suffix:semicolon
r_struct
id|fealist
op_star
id|ea_response_data
suffix:semicolon
id|rc
op_assign
op_minus
id|ENODATA
suffix:semicolon
multiline_comment|/* validate_trans2_offsets() */
multiline_comment|/* BB to check if(start of smb + data_offset &gt; &amp;bcc+ bcc)*/
id|ea_response_data
op_assign
(paren
r_struct
id|fealist
op_star
)paren
(paren
(paren
(paren
r_char
op_star
)paren
op_amp
id|pSMBr-&gt;hdr.Protocol
)paren
op_plus
id|data_offset
)paren
suffix:semicolon
id|name_len
op_assign
id|le32_to_cpu
c_func
(paren
id|ea_response_data-&gt;list_len
)paren
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;ea length %d&quot;
comma
id|name_len
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|name_len
op_le
l_int|8
)paren
(brace
multiline_comment|/* returned EA size zeroed at top of function */
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;empty EA list returned from server&quot;
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* account for ea list len */
id|name_len
op_sub_assign
l_int|4
suffix:semicolon
id|temp_fea
op_assign
id|ea_response_data-&gt;list
suffix:semicolon
id|temp_ptr
op_assign
(paren
r_char
op_star
)paren
id|temp_fea
suffix:semicolon
multiline_comment|/* loop through checking if we have a matching&n;&t;&t;&t;&t;name and then return the associated value */
r_while
c_loop
(paren
id|name_len
OG
l_int|0
)paren
(brace
id|__u16
id|value_len
suffix:semicolon
id|name_len
op_sub_assign
l_int|4
suffix:semicolon
id|temp_ptr
op_add_assign
l_int|4
suffix:semicolon
id|value_len
op_assign
id|le16_to_cpu
c_func
(paren
id|temp_fea-&gt;value_len
)paren
suffix:semicolon
multiline_comment|/* BB validate that value_len falls within SMB, &n;&t;&t;&t;&t;even though maximum for name_len is 255 */
r_if
c_cond
(paren
id|memcmp
c_func
(paren
id|temp_fea-&gt;name
comma
id|ea_name
comma
id|temp_fea-&gt;name_len
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* found a match */
id|rc
op_assign
id|value_len
suffix:semicolon
multiline_comment|/* account for prefix user. and trailing null */
r_if
c_cond
(paren
id|rc
op_le
(paren
r_int
)paren
id|buf_size
)paren
(brace
id|memcpy
c_func
(paren
id|ea_value
comma
id|temp_fea-&gt;name
op_plus
id|temp_fea-&gt;name_len
op_plus
l_int|1
comma
id|rc
)paren
suffix:semicolon
multiline_comment|/* ea values, unlike ea names,&n;&t;&t;&t;&t;&t;&t;&t;are not null terminated */
)brace
r_else
r_if
c_cond
(paren
id|buf_size
op_eq
l_int|0
)paren
(brace
multiline_comment|/* skip copy - calc size only */
)brace
r_else
(brace
multiline_comment|/* stop before overrun buffer */
id|rc
op_assign
op_minus
id|ERANGE
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
id|name_len
op_sub_assign
id|temp_fea-&gt;name_len
suffix:semicolon
id|temp_ptr
op_add_assign
id|temp_fea-&gt;name_len
suffix:semicolon
multiline_comment|/* account for trailing null */
id|name_len
op_decrement
suffix:semicolon
id|temp_ptr
op_increment
suffix:semicolon
id|name_len
op_sub_assign
id|value_len
suffix:semicolon
id|temp_ptr
op_add_assign
id|value_len
suffix:semicolon
multiline_comment|/* no trailing null to account for in value len */
multiline_comment|/* go on to next EA */
id|temp_fea
op_assign
(paren
r_struct
id|fea
op_star
)paren
id|temp_ptr
suffix:semicolon
)brace
)brace
)brace
)brace
r_if
c_cond
(paren
id|pSMB
)paren
id|cifs_buf_release
c_func
(paren
id|pSMB
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
op_minus
id|EAGAIN
)paren
r_goto
id|QEARetry
suffix:semicolon
r_return
(paren
id|ssize_t
)paren
id|rc
suffix:semicolon
)brace
r_int
DECL|function|CIFSSMBSetEA
id|CIFSSMBSetEA
c_func
(paren
r_const
r_int
id|xid
comma
r_struct
id|cifsTconInfo
op_star
id|tcon
comma
r_const
r_char
op_star
id|fileName
comma
r_const
r_char
op_star
id|ea_name
comma
r_const
r_void
op_star
id|ea_value
comma
r_const
id|__u16
id|ea_value_len
comma
r_const
r_struct
id|nls_table
op_star
id|nls_codepage
)paren
(brace
r_struct
id|smb_com_transaction2_spi_req
op_star
id|pSMB
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|smb_com_transaction2_spi_rsp
op_star
id|pSMBr
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|fealist
op_star
id|parm_data
suffix:semicolon
r_int
id|name_len
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|bytes_returned
op_assign
l_int|0
suffix:semicolon
id|__u16
id|params
comma
id|param_offset
comma
id|byte_count
comma
id|offset
comma
id|count
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;In SetEA&quot;
)paren
)paren
suffix:semicolon
id|SetEARetry
suffix:colon
id|rc
op_assign
id|smb_init
c_func
(paren
id|SMB_COM_TRANSACTION2
comma
l_int|15
comma
id|tcon
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMB
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMBr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|pSMB-&gt;hdr.Flags2
op_amp
id|SMBFLG2_UNICODE
)paren
(brace
id|name_len
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|pSMB-&gt;FileName
comma
id|fileName
comma
l_int|530
multiline_comment|/* find define for this maxpathcomponent */
comma
id|nls_codepage
)paren
suffix:semicolon
id|name_len
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|name_len
op_mul_assign
l_int|2
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* BB improve the check for buffer overruns BB */
id|name_len
op_assign
id|strnlen
c_func
(paren
id|fileName
comma
l_int|530
)paren
suffix:semicolon
id|name_len
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|strncpy
c_func
(paren
id|pSMB-&gt;FileName
comma
id|fileName
comma
id|name_len
)paren
suffix:semicolon
)brace
id|params
op_assign
l_int|6
op_plus
id|name_len
suffix:semicolon
multiline_comment|/* done calculating parms using name_len of file name,&n;&t;now use name_len to calculate length of ea name&n;&t;we are going to create in the inode xattrs */
r_if
c_cond
(paren
id|ea_name
op_eq
l_int|NULL
)paren
(brace
id|name_len
op_assign
l_int|0
suffix:semicolon
)brace
r_else
id|name_len
op_assign
id|strnlen
c_func
(paren
id|ea_name
comma
l_int|255
)paren
suffix:semicolon
id|count
op_assign
r_sizeof
(paren
op_star
id|parm_data
)paren
op_plus
id|ea_value_len
op_plus
id|name_len
op_plus
l_int|1
suffix:semicolon
id|pSMB-&gt;MaxParameterCount
op_assign
id|cpu_to_le16
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|pSMB-&gt;MaxDataCount
op_assign
id|cpu_to_le16
c_func
(paren
l_int|1000
)paren
suffix:semicolon
multiline_comment|/* BB find max SMB size from sess */
id|pSMB-&gt;MaxSetupCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Flags
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Timeout
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved2
op_assign
l_int|0
suffix:semicolon
id|param_offset
op_assign
m_offsetof
(paren
r_struct
id|smb_com_transaction2_spi_req
comma
id|InformationLevel
)paren
op_minus
l_int|4
suffix:semicolon
id|offset
op_assign
id|param_offset
op_plus
id|params
suffix:semicolon
id|pSMB-&gt;InformationLevel
op_assign
id|cpu_to_le16
c_func
(paren
id|SMB_SET_FILE_EA
)paren
suffix:semicolon
id|parm_data
op_assign
(paren
r_struct
id|fealist
op_star
)paren
(paren
(paren
(paren
r_char
op_star
)paren
op_amp
id|pSMB-&gt;hdr.Protocol
)paren
op_plus
id|offset
)paren
suffix:semicolon
id|pSMB-&gt;ParameterOffset
op_assign
id|cpu_to_le16
c_func
(paren
id|param_offset
)paren
suffix:semicolon
id|pSMB-&gt;DataOffset
op_assign
id|cpu_to_le16
c_func
(paren
id|offset
)paren
suffix:semicolon
id|pSMB-&gt;SetupCount
op_assign
l_int|1
suffix:semicolon
id|pSMB-&gt;Reserved3
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;SubCommand
op_assign
id|cpu_to_le16
c_func
(paren
id|TRANS2_SET_PATH_INFORMATION
)paren
suffix:semicolon
id|byte_count
op_assign
l_int|3
multiline_comment|/* pad */
op_plus
id|params
op_plus
id|count
suffix:semicolon
id|pSMB-&gt;DataCount
op_assign
id|cpu_to_le16
c_func
(paren
id|count
)paren
suffix:semicolon
id|parm_data-&gt;list_len
op_assign
id|cpu_to_le32
c_func
(paren
id|count
)paren
suffix:semicolon
id|parm_data-&gt;list
(braket
l_int|0
)braket
dot
id|EA_flags
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* we checked above that name len is less than 255 */
id|parm_data-&gt;list
(braket
l_int|0
)braket
dot
id|name_len
op_assign
(paren
id|__u8
)paren
id|name_len
suffix:semicolon
suffix:semicolon
multiline_comment|/* EA names are always ASCII */
id|strncpy
c_func
(paren
id|parm_data-&gt;list
(braket
l_int|0
)braket
dot
id|name
comma
id|ea_name
comma
id|name_len
)paren
suffix:semicolon
id|parm_data-&gt;list
(braket
l_int|0
)braket
dot
id|name
(braket
id|name_len
)braket
op_assign
l_int|0
suffix:semicolon
id|parm_data-&gt;list
(braket
l_int|0
)braket
dot
id|value_len
op_assign
id|cpu_to_le16
c_func
(paren
id|ea_value_len
)paren
suffix:semicolon
multiline_comment|/* caller ensures that ea_value_len is less than 64K but&n;&t;we need to ensure that it fits within the smb */
multiline_comment|/*BB add length check that it would fit in negotiated SMB buffer size BB */
multiline_comment|/* if(ea_value_len &gt; buffer_size - 512 (enough for header)) */
r_if
c_cond
(paren
id|ea_value_len
)paren
(brace
id|memcpy
c_func
(paren
id|parm_data-&gt;list
(braket
l_int|0
)braket
dot
id|name
op_plus
id|name_len
op_plus
l_int|1
comma
id|ea_value
comma
id|ea_value_len
)paren
suffix:semicolon
)brace
id|pSMB-&gt;TotalDataCount
op_assign
id|pSMB-&gt;DataCount
suffix:semicolon
id|pSMB-&gt;ParameterCount
op_assign
id|cpu_to_le16
c_func
(paren
id|params
)paren
suffix:semicolon
id|pSMB-&gt;TotalParameterCount
op_assign
id|pSMB-&gt;ParameterCount
suffix:semicolon
id|pSMB-&gt;Reserved4
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;hdr.smb_buf_length
op_add_assign
id|byte_count
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
id|cpu_to_le16
c_func
(paren
id|byte_count
)paren
suffix:semicolon
id|rc
op_assign
id|SendReceive
c_func
(paren
id|xid
comma
id|tcon-&gt;ses
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMB
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMBr
comma
op_amp
id|bytes_returned
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;SetPathInfo (EA) returned %d&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pSMB
)paren
id|cifs_buf_release
c_func
(paren
id|pSMB
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
op_minus
id|EAGAIN
)paren
r_goto
id|SetEARetry
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
macro_line|#endif
eof
