multiline_comment|/*&n; *   fs/cifs/cifssmb.c&n; *&n; *   Copyright (c) International Business Machines  Corp., 2002&n; *   Author(s): Steve French (sfrench@us.ibm.com)&n; *&n; *   Contains the routines for constructing the SMB PDUs themselves&n; *&n; *   This library is free software; you can redistribute it and/or modify&n; *   it under the terms of the GNU Lesser General Public License as published&n; *   by the Free Software Foundation; either version 2.1 of the License, or&n; *   (at your option) any later version.&n; *&n; *   This library is distributed in the hope that it will be useful,&n; *   but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See&n; *   the GNU Lesser General Public License for more details.&n; *&n; *   You should have received a copy of the GNU Lesser General Public License&n; *   along with this library; if not, write to the Free Software&n; *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA&n; */
multiline_comment|/* SMB/CIFS PDU handling routines here - except for leftovers in connect.c */
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/vfs.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &quot;cifspdu.h&quot;
macro_line|#include &quot;cifsglob.h&quot;
macro_line|#include &quot;cifsproto.h&quot;
macro_line|#include &quot;cifs_unicode.h&quot;
macro_line|#include &quot;cifs_debug.h&quot;
r_static
r_struct
(brace
DECL|member|index
r_int
id|index
suffix:semicolon
DECL|member|name
r_char
op_star
id|name
suffix:semicolon
DECL|variable|protocols
)brace
id|protocols
(braket
)braket
op_assign
(brace
(brace
id|CIFS_PROT
comma
l_string|&quot;&bslash;2NT LM 0.12&quot;
)brace
comma
(brace
id|BAD_PROT
comma
l_string|&quot;&bslash;2&quot;
)brace
)brace
suffix:semicolon
r_int
DECL|function|smb_init
id|smb_init
c_func
(paren
r_int
id|smb_command
comma
r_int
id|wct
comma
r_struct
id|cifsTconInfo
op_star
id|tcon
comma
r_void
op_star
op_star
id|request_buf
multiline_comment|/* returned */
comma
r_void
op_star
op_star
id|response_buf
multiline_comment|/* returned */
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|tcon
op_logical_and
(paren
id|tcon-&gt;tidStatus
op_eq
id|CifsNeedReconnect
)paren
)paren
(brace
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
r_if
c_cond
(paren
id|tcon-&gt;ses
)paren
(brace
r_struct
id|nls_table
op_star
id|nls_codepage
op_assign
id|load_nls_default
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tcon-&gt;ses-&gt;status
op_eq
id|CifsNeedReconnect
)paren
(brace
id|rc
op_assign
id|setup_session
c_func
(paren
l_int|0
comma
id|tcon-&gt;ses
comma
id|nls_codepage
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|rc
)paren
(brace
id|rc
op_assign
id|CIFSTCon
c_func
(paren
l_int|0
comma
id|tcon-&gt;ses
comma
id|tcon-&gt;treeName
comma
id|tcon
comma
id|nls_codepage
)paren
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;reconnect tcon rc = %d&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rc
)paren
(brace
id|reopen_files
c_func
(paren
id|tcon
comma
id|nls_codepage
)paren
suffix:semicolon
)brace
)brace
)brace
)brace
r_if
c_cond
(paren
id|rc
)paren
(brace
r_return
id|rc
suffix:semicolon
)brace
op_star
id|request_buf
op_assign
id|buf_get
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|request_buf
op_eq
l_int|0
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/* Although the original thought was we needed the response buf for  */
multiline_comment|/* potential retries of smb operations it turns out we can determine */
multiline_comment|/* from the mid flags when the request buffer can be resent without  */
multiline_comment|/* having to use a second distinct buffer for the response */
op_star
id|response_buf
op_assign
op_star
id|request_buf
suffix:semicolon
id|header_assemble
c_func
(paren
(paren
r_struct
id|smb_hdr
op_star
)paren
op_star
id|request_buf
comma
id|smb_command
comma
id|tcon
comma
id|wct
multiline_comment|/*wct */
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_int
DECL|function|CIFSSMBNegotiate
id|CIFSSMBNegotiate
c_func
(paren
r_int
r_int
id|xid
comma
r_struct
id|cifsSesInfo
op_star
id|ses
)paren
(brace
id|NEGOTIATE_REQ
op_star
id|pSMB
suffix:semicolon
id|NEGOTIATE_RSP
op_star
id|pSMBr
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|bytes_returned
suffix:semicolon
r_struct
id|TCP_Server_Info
op_star
id|server
suffix:semicolon
r_if
c_cond
(paren
id|ses-&gt;server
)paren
(brace
id|server
op_assign
id|ses-&gt;server
suffix:semicolon
)brace
r_else
(brace
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|rc
op_assign
id|smb_init
c_func
(paren
id|SMB_COM_NEGOTIATE
comma
l_int|0
comma
l_int|0
multiline_comment|/* no tcon yet */
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMB
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMBr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
id|pSMB-&gt;hdr.Flags2
op_or_assign
id|SMBFLG2_UNICODE
suffix:semicolon
r_if
c_cond
(paren
id|extended_security
)paren
id|pSMB-&gt;hdr.Flags2
op_or_assign
id|SMBFLG2_EXT_SEC
suffix:semicolon
r_if
c_cond
(paren
id|sign_CIFS_PDUs
)paren
(brace
id|pSMB-&gt;hdr.Flags2
op_or_assign
id|SMBFLG2_SECURITY_SIGNATURE
suffix:semicolon
)brace
id|pSMB-&gt;ByteCount
op_assign
id|strlen
c_func
(paren
id|protocols
(braket
l_int|0
)braket
dot
id|name
)paren
op_plus
l_int|1
suffix:semicolon
id|strncpy
c_func
(paren
id|pSMB-&gt;DialectsArray
comma
id|protocols
(braket
l_int|0
)braket
dot
id|name
comma
l_int|30
)paren
suffix:semicolon
multiline_comment|/* null guaranteed to be at end of source and target buffers anyway */
id|pSMB-&gt;hdr.smb_buf_length
op_add_assign
id|pSMB-&gt;ByteCount
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
id|cpu_to_le16
c_func
(paren
id|pSMB-&gt;ByteCount
)paren
suffix:semicolon
id|rc
op_assign
id|SendReceive
c_func
(paren
id|xid
comma
id|ses
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMB
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMBr
comma
op_amp
id|bytes_returned
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
)paren
(brace
id|server-&gt;secMode
op_assign
id|pSMBr-&gt;SecurityMode
suffix:semicolon
id|server-&gt;secType
op_assign
id|NTLM
suffix:semicolon
multiline_comment|/* BB override default for NTLMv2 or krb*/
multiline_comment|/* one byte - no need to convert this or EncryptionKeyLen from le,*/
id|server-&gt;maxReq
op_assign
id|le16_to_cpu
c_func
(paren
id|pSMBr-&gt;MaxMpxCount
)paren
suffix:semicolon
multiline_comment|/* probably no need to store and check maxvcs */
id|server-&gt;maxBuf
op_assign
id|min
c_func
(paren
id|le32_to_cpu
c_func
(paren
id|pSMBr-&gt;MaxBufferSize
)paren
comma
(paren
id|__u32
)paren
id|CIFS_MAX_MSGSIZE
op_plus
id|MAX_CIFS_HDR_SIZE
)paren
suffix:semicolon
id|server-&gt;maxRw
op_assign
id|le32_to_cpu
c_func
(paren
id|pSMBr-&gt;MaxRawSize
)paren
suffix:semicolon
id|cFYI
c_func
(paren
l_int|0
comma
(paren
l_string|&quot;Max buf = %d &quot;
comma
id|ses-&gt;server-&gt;maxBuf
)paren
)paren
suffix:semicolon
id|GETU32
c_func
(paren
id|ses-&gt;server-&gt;sessid
)paren
op_assign
id|le32_to_cpu
c_func
(paren
id|pSMBr-&gt;SessionKey
)paren
suffix:semicolon
id|server-&gt;capabilities
op_assign
id|le32_to_cpu
c_func
(paren
id|pSMBr-&gt;Capabilities
)paren
suffix:semicolon
id|server-&gt;timeZone
op_assign
id|le16_to_cpu
c_func
(paren
id|pSMBr-&gt;ServerTimeZone
)paren
suffix:semicolon
multiline_comment|/* BB with UTC do we ever need to be using srvr timezone? */
r_if
c_cond
(paren
id|pSMBr-&gt;EncryptionKeyLength
op_eq
id|CIFS_CRYPTO_KEY_SIZE
)paren
(brace
id|memcpy
c_func
(paren
id|server-&gt;cryptKey
comma
id|pSMBr-&gt;u.EncryptionKey
comma
id|CIFS_CRYPTO_KEY_SIZE
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|pSMBr-&gt;hdr.Flags2
op_amp
id|SMBFLG2_EXT_SEC
)paren
op_logical_and
(paren
id|pSMBr-&gt;EncryptionKeyLength
op_eq
l_int|0
)paren
)paren
(brace
multiline_comment|/* decode security blob */
)brace
r_else
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
multiline_comment|/* BB might be helpful to save off the domain of server here */
r_if
c_cond
(paren
id|pSMBr-&gt;hdr.Flags2
op_amp
id|SMBFLG2_EXT_SEC
)paren
(brace
r_if
c_cond
(paren
id|pSMBr-&gt;ByteCount
OL
l_int|16
)paren
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
r_else
r_if
c_cond
(paren
id|pSMBr-&gt;ByteCount
op_eq
l_int|16
)paren
(brace
id|server-&gt;secType
op_assign
id|RawNTLMSSP
suffix:semicolon
r_if
c_cond
(paren
id|server-&gt;socketUseCount.counter
OG
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|memcmp
(paren
id|server-&gt;server_GUID
comma
id|pSMBr-&gt;u.extended_response
dot
id|GUID
comma
l_int|16
)paren
op_ne
l_int|0
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;UID of server does not match previous connection to same ip address&quot;
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|server
op_member_access_from_pointer
id|server_GUID
comma
id|pSMBr-&gt;u
dot
id|extended_response
dot
id|GUID
comma
l_int|16
)paren
suffix:semicolon
)brace
)brace
r_else
id|memcpy
c_func
(paren
id|server-&gt;server_GUID
comma
id|pSMBr-&gt;u.extended_response
dot
id|GUID
comma
l_int|16
)paren
suffix:semicolon
)brace
r_else
(brace
id|rc
op_assign
id|decode_negTokenInit
c_func
(paren
id|pSMBr-&gt;u
dot
id|extended_response
dot
id|SecurityBlob
comma
id|pSMBr-&gt;ByteCount
op_minus
l_int|16
comma
op_amp
id|server-&gt;secType
)paren
suffix:semicolon
)brace
)brace
r_else
id|server-&gt;capabilities
op_and_assign
op_complement
id|CAP_EXTENDED_SECURITY
suffix:semicolon
r_if
c_cond
(paren
id|sign_CIFS_PDUs
op_eq
id|FALSE
)paren
(brace
r_if
c_cond
(paren
id|server-&gt;secMode
op_amp
id|SECMODE_SIGN_REQUIRED
)paren
(brace
id|cERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Server requires /proc/fs/cifs/PacketSigningEnabled&quot;
)paren
)paren
suffix:semicolon
)brace
id|server-&gt;secMode
op_and_assign
op_complement
(paren
id|SECMODE_SIGN_ENABLED
op_or
id|SECMODE_SIGN_REQUIRED
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|pSMB
)paren
id|buf_release
c_func
(paren
id|pSMB
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_int
DECL|function|CIFSSMBTDis
id|CIFSSMBTDis
c_func
(paren
r_const
r_int
id|xid
comma
r_struct
id|cifsTconInfo
op_star
id|tcon
)paren
(brace
r_struct
id|smb_hdr
op_star
id|smb_buffer
suffix:semicolon
r_struct
id|smb_hdr
op_star
id|smb_buffer_response
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|length
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;In tree disconnect&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; *  If last user of the connection and&n;&t; *  connection alive - disconnect it&n;&t; *  If this is the last connection on the server session disconnect it&n;&t; *  (and inside session disconnect we should check if tcp socket needs &n;&t; *  to be freed and kernel thread woken up).&n;&t; */
r_if
c_cond
(paren
id|tcon
)paren
id|down
c_func
(paren
op_amp
id|tcon-&gt;tconSem
)paren
suffix:semicolon
r_else
r_return
op_minus
id|EIO
suffix:semicolon
id|atomic_dec
c_func
(paren
op_amp
id|tcon-&gt;useCount
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|tcon-&gt;useCount
)paren
OG
l_int|0
)paren
(brace
id|up
c_func
(paren
op_amp
id|tcon-&gt;tconSem
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
multiline_comment|/* BB remove (from server) list of shares - but with smp safety  BB */
multiline_comment|/* BB is ses active - do we need to check here - but how? BB */
r_if
c_cond
(paren
(paren
id|tcon-&gt;ses
op_eq
l_int|0
)paren
op_logical_or
(paren
id|tcon-&gt;ses-&gt;server
op_eq
l_int|0
)paren
)paren
(brace
id|up
c_func
(paren
op_amp
id|tcon-&gt;tconSem
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|rc
op_assign
id|smb_init
c_func
(paren
id|SMB_COM_TREE_DISCONNECT
comma
l_int|0
comma
id|tcon
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|smb_buffer
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|smb_buffer_response
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|up
c_func
(paren
op_amp
id|tcon-&gt;tconSem
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|rc
op_assign
id|SendReceive
c_func
(paren
id|xid
comma
id|tcon-&gt;ses
comma
id|smb_buffer
comma
id|smb_buffer_response
comma
op_amp
id|length
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot; Tree disconnect failed %d&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|smb_buffer
)paren
id|buf_release
c_func
(paren
id|smb_buffer
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|tcon-&gt;tconSem
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_int
DECL|function|CIFSSMBLogoff
id|CIFSSMBLogoff
c_func
(paren
r_const
r_int
id|xid
comma
r_struct
id|cifsSesInfo
op_star
id|ses
)paren
(brace
r_struct
id|smb_hdr
op_star
id|smb_buffer_response
suffix:semicolon
id|LOGOFF_ANDX_REQ
op_star
id|pSMB
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|length
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;In SMBLogoff for session disconnect&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ses
)paren
id|down
c_func
(paren
op_amp
id|ses-&gt;sesSem
)paren
suffix:semicolon
multiline_comment|/* check this sem more places */
r_else
r_return
op_minus
id|EIO
suffix:semicolon
id|atomic_dec
c_func
(paren
op_amp
id|ses-&gt;inUse
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|ses-&gt;inUse
)paren
OG
l_int|0
)paren
(brace
id|up
c_func
(paren
op_amp
id|ses-&gt;sesSem
)paren
suffix:semicolon
r_return
op_minus
id|EBUSY
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ses-&gt;server-&gt;secMode
op_amp
(paren
id|SECMODE_SIGN_REQUIRED
op_or
id|SECMODE_SIGN_ENABLED
)paren
)paren
(brace
id|pSMB-&gt;hdr.Flags2
op_or_assign
id|SMBFLG2_SECURITY_SIGNATURE
suffix:semicolon
)brace
id|rc
op_assign
id|smb_init
c_func
(paren
id|SMB_COM_LOGOFF_ANDX
comma
l_int|2
comma
l_int|0
multiline_comment|/* no tcon anymore */
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMB
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|smb_buffer_response
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|up
c_func
(paren
op_amp
id|ses-&gt;sesSem
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|pSMB-&gt;hdr.Uid
op_assign
id|ses-&gt;Suid
suffix:semicolon
id|pSMB-&gt;AndXCommand
op_assign
l_int|0xFF
suffix:semicolon
id|rc
op_assign
id|SendReceive
c_func
(paren
id|xid
comma
id|ses
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMB
comma
id|smb_buffer_response
comma
op_amp
id|length
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ses-&gt;server
)paren
(brace
id|atomic_dec
c_func
(paren
op_amp
id|ses-&gt;server-&gt;socketUseCount
)paren
suffix:semicolon
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|ses-&gt;server-&gt;socketUseCount
)paren
op_eq
l_int|0
)paren
id|ses-&gt;server-&gt;tcpStatus
op_assign
id|CifsExiting
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pSMB
)paren
id|buf_release
c_func
(paren
id|pSMB
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|ses-&gt;sesSem
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_int
DECL|function|CIFSSMBDelFile
id|CIFSSMBDelFile
c_func
(paren
r_const
r_int
id|xid
comma
r_struct
id|cifsTconInfo
op_star
id|tcon
comma
r_const
r_char
op_star
id|fileName
comma
r_const
r_struct
id|nls_table
op_star
id|nls_codepage
)paren
(brace
id|DELETE_FILE_REQ
op_star
id|pSMB
op_assign
l_int|NULL
suffix:semicolon
id|DELETE_FILE_RSP
op_star
id|pSMBr
op_assign
l_int|NULL
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|bytes_returned
suffix:semicolon
r_int
id|name_len
suffix:semicolon
id|rc
op_assign
id|smb_init
c_func
(paren
id|SMB_COM_DELETE
comma
l_int|1
comma
id|tcon
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMB
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMBr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|pSMB-&gt;hdr.Flags2
op_amp
id|SMBFLG2_UNICODE
)paren
(brace
id|name_len
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|pSMB-&gt;fileName
comma
id|fileName
comma
l_int|530
multiline_comment|/* find define for this maxpathcomponent */
comma
id|nls_codepage
)paren
suffix:semicolon
id|name_len
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|name_len
op_mul_assign
l_int|2
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* BB improve the check for buffer overruns BB */
id|name_len
op_assign
id|strnlen
c_func
(paren
id|fileName
comma
l_int|530
)paren
suffix:semicolon
id|name_len
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|strncpy
c_func
(paren
id|pSMB-&gt;fileName
comma
id|fileName
comma
id|name_len
)paren
suffix:semicolon
)brace
id|pSMB-&gt;SearchAttributes
op_assign
id|cpu_to_le16
c_func
(paren
id|ATTR_READONLY
op_or
id|ATTR_HIDDEN
op_or
id|ATTR_SYSTEM
)paren
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
id|name_len
op_plus
l_int|1
suffix:semicolon
id|pSMB-&gt;BufferFormat
op_assign
l_int|0x04
suffix:semicolon
id|pSMB-&gt;hdr.smb_buf_length
op_add_assign
id|pSMB-&gt;ByteCount
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
id|cpu_to_le16
c_func
(paren
id|pSMB-&gt;ByteCount
)paren
suffix:semicolon
id|rc
op_assign
id|SendReceive
c_func
(paren
id|xid
comma
id|tcon-&gt;ses
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMB
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMBr
comma
op_amp
id|bytes_returned
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Error in RMFile = %d&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pSMB
)paren
id|buf_release
c_func
(paren
id|pSMB
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_int
DECL|function|CIFSSMBRmDir
id|CIFSSMBRmDir
c_func
(paren
r_const
r_int
id|xid
comma
r_struct
id|cifsTconInfo
op_star
id|tcon
comma
r_const
r_char
op_star
id|dirName
comma
r_const
r_struct
id|nls_table
op_star
id|nls_codepage
)paren
(brace
id|DELETE_DIRECTORY_REQ
op_star
id|pSMB
op_assign
l_int|NULL
suffix:semicolon
id|DELETE_DIRECTORY_RSP
op_star
id|pSMBr
op_assign
l_int|NULL
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|bytes_returned
suffix:semicolon
r_int
id|name_len
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;In CIFSSMBRmDir&quot;
)paren
)paren
suffix:semicolon
id|rc
op_assign
id|smb_init
c_func
(paren
id|SMB_COM_DELETE_DIRECTORY
comma
l_int|0
comma
id|tcon
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMB
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMBr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|pSMB-&gt;hdr.Flags2
op_amp
id|SMBFLG2_UNICODE
)paren
(brace
id|name_len
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|pSMB-&gt;DirName
comma
id|dirName
comma
l_int|530
multiline_comment|/* find define for this maxpathcomponent */
comma
id|nls_codepage
)paren
suffix:semicolon
id|name_len
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|name_len
op_mul_assign
l_int|2
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* BB improve the check for buffer overruns BB */
id|name_len
op_assign
id|strnlen
c_func
(paren
id|dirName
comma
l_int|530
)paren
suffix:semicolon
id|name_len
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|strncpy
c_func
(paren
id|pSMB-&gt;DirName
comma
id|dirName
comma
id|name_len
)paren
suffix:semicolon
)brace
id|pSMB-&gt;ByteCount
op_assign
id|name_len
op_plus
l_int|1
suffix:semicolon
id|pSMB-&gt;BufferFormat
op_assign
l_int|0x04
suffix:semicolon
id|pSMB-&gt;hdr.smb_buf_length
op_add_assign
id|pSMB-&gt;ByteCount
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
id|cpu_to_le16
c_func
(paren
id|pSMB-&gt;ByteCount
)paren
suffix:semicolon
id|rc
op_assign
id|SendReceive
c_func
(paren
id|xid
comma
id|tcon-&gt;ses
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMB
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMBr
comma
op_amp
id|bytes_returned
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Error in RMDir = %d&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pSMB
)paren
id|buf_release
c_func
(paren
id|pSMB
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_int
DECL|function|CIFSSMBMkDir
id|CIFSSMBMkDir
c_func
(paren
r_const
r_int
id|xid
comma
r_struct
id|cifsTconInfo
op_star
id|tcon
comma
r_const
r_char
op_star
id|name
comma
r_const
r_struct
id|nls_table
op_star
id|nls_codepage
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|CREATE_DIRECTORY_REQ
op_star
id|pSMB
op_assign
l_int|NULL
suffix:semicolon
id|CREATE_DIRECTORY_RSP
op_star
id|pSMBr
op_assign
l_int|NULL
suffix:semicolon
r_int
id|bytes_returned
suffix:semicolon
r_int
id|name_len
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;In CIFSSMBMkDir&quot;
)paren
)paren
suffix:semicolon
id|rc
op_assign
id|smb_init
c_func
(paren
id|SMB_COM_CREATE_DIRECTORY
comma
l_int|0
comma
id|tcon
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMB
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMBr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|pSMB-&gt;hdr.Flags2
op_amp
id|SMBFLG2_UNICODE
)paren
(brace
id|name_len
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|pSMB-&gt;DirName
comma
id|name
comma
l_int|530
multiline_comment|/* find define for this maxpathcomponent */
comma
id|nls_codepage
)paren
suffix:semicolon
id|name_len
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|name_len
op_mul_assign
l_int|2
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* BB improve the check for buffer overruns BB */
id|name_len
op_assign
id|strnlen
c_func
(paren
id|name
comma
l_int|530
)paren
suffix:semicolon
id|name_len
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|strncpy
c_func
(paren
id|pSMB-&gt;DirName
comma
id|name
comma
id|name_len
)paren
suffix:semicolon
)brace
id|pSMB-&gt;ByteCount
op_assign
id|name_len
op_plus
l_int|1
multiline_comment|/* for buf format */
suffix:semicolon
id|pSMB-&gt;BufferFormat
op_assign
l_int|0x04
suffix:semicolon
id|pSMB-&gt;hdr.smb_buf_length
op_add_assign
id|pSMB-&gt;ByteCount
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
id|cpu_to_le16
c_func
(paren
id|pSMB-&gt;ByteCount
)paren
suffix:semicolon
id|rc
op_assign
id|SendReceive
c_func
(paren
id|xid
comma
id|tcon-&gt;ses
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMB
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMBr
comma
op_amp
id|bytes_returned
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Error in Mkdir = %d&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pSMB
)paren
id|buf_release
c_func
(paren
id|pSMB
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_int
DECL|function|CIFSSMBOpen
id|CIFSSMBOpen
c_func
(paren
r_const
r_int
id|xid
comma
r_struct
id|cifsTconInfo
op_star
id|tcon
comma
r_const
r_char
op_star
id|fileName
comma
r_const
r_int
id|openDisposition
comma
r_const
r_int
id|access_flags
comma
r_const
r_int
id|create_options
comma
id|__u16
op_star
id|netfid
comma
r_int
op_star
id|pOplock
comma
r_const
r_struct
id|nls_table
op_star
id|nls_codepage
)paren
(brace
r_int
id|rc
op_assign
op_minus
id|EACCES
suffix:semicolon
id|OPEN_REQ
op_star
id|pSMB
op_assign
l_int|NULL
suffix:semicolon
id|OPEN_RSP
op_star
id|pSMBr
op_assign
l_int|NULL
suffix:semicolon
r_int
id|bytes_returned
suffix:semicolon
r_int
id|name_len
suffix:semicolon
id|rc
op_assign
id|smb_init
c_func
(paren
id|SMB_COM_NT_CREATE_ANDX
comma
l_int|24
comma
id|tcon
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMB
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMBr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
id|pSMB-&gt;AndXCommand
op_assign
l_int|0xFF
suffix:semicolon
multiline_comment|/* none */
r_if
c_cond
(paren
id|pSMB-&gt;hdr.Flags2
op_amp
id|SMBFLG2_UNICODE
)paren
(brace
id|pSMB-&gt;ByteCount
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* account for one byte pad to word boundary */
id|name_len
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
(paren
id|pSMB-&gt;fileName
op_plus
l_int|1
)paren
comma
id|fileName
comma
l_int|530
multiline_comment|/* find define for this maxpathcomponent */
comma
id|nls_codepage
)paren
suffix:semicolon
id|name_len
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|name_len
op_mul_assign
l_int|2
suffix:semicolon
id|pSMB-&gt;NameLength
op_assign
id|cpu_to_le16
c_func
(paren
id|name_len
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* BB improve the check for buffer overruns BB */
id|pSMB-&gt;ByteCount
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* no pad */
id|name_len
op_assign
id|strnlen
c_func
(paren
id|fileName
comma
l_int|530
)paren
suffix:semicolon
id|name_len
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|pSMB-&gt;NameLength
op_assign
id|cpu_to_le16
c_func
(paren
id|name_len
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|pSMB-&gt;fileName
comma
id|fileName
comma
id|name_len
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_star
id|pOplock
op_amp
id|REQ_OPLOCK
)paren
id|pSMB-&gt;OpenFlags
op_assign
id|cpu_to_le32
c_func
(paren
id|REQ_OPLOCK
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
op_star
id|pOplock
op_amp
id|REQ_BATCHOPLOCK
)paren
(brace
id|pSMB-&gt;OpenFlags
op_assign
id|cpu_to_le32
c_func
(paren
id|REQ_BATCHOPLOCK
)paren
suffix:semicolon
)brace
id|pSMB-&gt;DesiredAccess
op_assign
id|cpu_to_le32
c_func
(paren
id|access_flags
)paren
suffix:semicolon
id|pSMB-&gt;AllocationSize
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;FileAttributes
op_assign
id|ATTR_NORMAL
suffix:semicolon
multiline_comment|/* XP does not handle ATTR_POSIX_SEMANTICS */
multiline_comment|/*if ((omode &amp; S_IWUGO) == 0)&n;&t;&t;pSMB-&gt;FileAttributes |= ATTR_READONLY;*/
multiline_comment|/*  Above line causes problems due to vfs splitting create into two&n;&t;&t;pieces - need to set mode after file created not while it is&n;&t;&t;being created */
id|pSMB-&gt;FileAttributes
op_assign
id|cpu_to_le32
c_func
(paren
id|pSMB-&gt;FileAttributes
)paren
suffix:semicolon
id|pSMB-&gt;ShareAccess
op_assign
id|cpu_to_le32
c_func
(paren
id|FILE_SHARE_ALL
)paren
suffix:semicolon
id|pSMB-&gt;CreateDisposition
op_assign
id|cpu_to_le32
c_func
(paren
id|openDisposition
)paren
suffix:semicolon
id|pSMB-&gt;CreateOptions
op_assign
id|cpu_to_le32
c_func
(paren
id|create_options
)paren
suffix:semicolon
id|pSMB-&gt;ImpersonationLevel
op_assign
id|cpu_to_le32
c_func
(paren
id|SECURITY_IMPERSONATION
)paren
suffix:semicolon
multiline_comment|/* BB ??*/
id|pSMB-&gt;SecurityFlags
op_assign
id|cpu_to_le32
c_func
(paren
id|SECURITY_CONTEXT_TRACKING
op_or
id|SECURITY_EFFECTIVE_ONLY
)paren
suffix:semicolon
id|pSMB-&gt;ByteCount
op_add_assign
id|name_len
suffix:semicolon
id|pSMB-&gt;hdr.smb_buf_length
op_add_assign
id|pSMB-&gt;ByteCount
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
id|cpu_to_le16
c_func
(paren
id|pSMB-&gt;ByteCount
)paren
suffix:semicolon
id|rc
op_assign
id|SendReceive
c_func
(paren
id|xid
comma
id|tcon-&gt;ses
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMB
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMBr
comma
op_amp
id|bytes_returned
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Error in Open = %d&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
op_star
id|pOplock
op_assign
id|pSMBr-&gt;OplockLevel
suffix:semicolon
multiline_comment|/* one byte no need to le_to_cpu */
op_star
id|netfid
op_assign
id|pSMBr-&gt;Fid
suffix:semicolon
multiline_comment|/* cifs fid stays in le */
multiline_comment|/* Do we care about the CreateAction in any cases? */
multiline_comment|/* BB add code to update inode file sizes from create response */
)brace
r_if
c_cond
(paren
id|pSMB
)paren
id|buf_release
c_func
(paren
id|pSMB
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/* If no buffer passed in, then caller wants to do the copy&n;&t;as in the case of readpages so the SMB buffer must be&n;&t;freed by the caller */
r_int
DECL|function|CIFSSMBRead
id|CIFSSMBRead
c_func
(paren
r_const
r_int
id|xid
comma
r_struct
id|cifsTconInfo
op_star
id|tcon
comma
r_const
r_int
id|netfid
comma
r_const
r_int
r_int
id|count
comma
r_const
id|__u64
id|lseek
comma
r_int
r_int
op_star
id|nbytes
comma
r_char
op_star
op_star
id|buf
)paren
(brace
r_int
id|rc
op_assign
op_minus
id|EACCES
suffix:semicolon
id|READ_REQ
op_star
id|pSMB
op_assign
l_int|NULL
suffix:semicolon
id|READ_RSP
op_star
id|pSMBr
op_assign
l_int|NULL
suffix:semicolon
r_char
op_star
id|pReadData
op_assign
l_int|NULL
suffix:semicolon
r_int
id|bytes_returned
suffix:semicolon
op_star
id|nbytes
op_assign
l_int|0
suffix:semicolon
id|rc
op_assign
id|smb_init
c_func
(paren
id|SMB_COM_READ_ANDX
comma
l_int|12
comma
id|tcon
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMB
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMBr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
id|pSMB-&gt;AndXCommand
op_assign
l_int|0xFF
suffix:semicolon
multiline_comment|/* none */
id|pSMB-&gt;Fid
op_assign
id|netfid
suffix:semicolon
id|pSMB-&gt;OffsetLow
op_assign
id|cpu_to_le32
c_func
(paren
id|lseek
op_amp
l_int|0xFFFFFFFF
)paren
suffix:semicolon
id|pSMB-&gt;OffsetHigh
op_assign
id|cpu_to_le32
c_func
(paren
id|lseek
op_rshift
l_int|32
)paren
suffix:semicolon
id|pSMB-&gt;Remaining
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;MaxCount
op_assign
id|cpu_to_le16
c_func
(paren
id|count
)paren
suffix:semicolon
id|pSMB-&gt;MaxCountHigh
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* no need to do le conversion since it is 0 */
id|rc
op_assign
id|SendReceive
c_func
(paren
id|xid
comma
id|tcon-&gt;ses
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMB
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMBr
comma
op_amp
id|bytes_returned
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|cERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Send error in read = %d&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|pSMBr-&gt;DataLength
op_assign
id|le16_to_cpu
c_func
(paren
id|pSMBr-&gt;DataLength
)paren
suffix:semicolon
op_star
id|nbytes
op_assign
id|pSMBr-&gt;DataLength
suffix:semicolon
multiline_comment|/*check that DataLength would not go beyond end of SMB */
r_if
c_cond
(paren
(paren
id|pSMBr-&gt;DataLength
OG
id|CIFS_MAX_MSGSIZE
)paren
op_logical_or
(paren
id|pSMBr-&gt;DataLength
OG
id|count
)paren
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;bad length %d for count %d&quot;
comma
id|pSMBr-&gt;DataLength
comma
id|count
)paren
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
op_star
id|nbytes
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|pReadData
op_assign
(paren
r_char
op_star
)paren
(paren
op_amp
id|pSMBr-&gt;hdr.Protocol
)paren
op_plus
id|le16_to_cpu
c_func
(paren
id|pSMBr-&gt;DataOffset
)paren
suffix:semicolon
multiline_comment|/*&t;&t;&t;if(rc = copy_to_user(buf, pReadData, pSMBr-&gt;DataLength)) {&n;&t;&t;&t;&t;cERROR(1,(&quot;Faulting on read rc = %d&quot;,rc));&n;&t;&t;&t;&t;rc = -EFAULT;&n;&t;&t;&t;}*/
multiline_comment|/* can not use copy_to_user when using page cache*/
r_if
c_cond
(paren
op_star
id|buf
)paren
(brace
id|memcpy
c_func
(paren
op_star
id|buf
comma
id|pReadData
comma
id|pSMBr-&gt;DataLength
)paren
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|pSMB
)paren
(brace
r_if
c_cond
(paren
op_star
id|buf
)paren
(brace
id|buf_release
c_func
(paren
id|pSMB
)paren
suffix:semicolon
)brace
r_else
op_star
id|buf
op_assign
(paren
r_char
op_star
)paren
id|pSMB
suffix:semicolon
)brace
r_return
id|rc
suffix:semicolon
)brace
r_int
DECL|function|CIFSSMBWrite
id|CIFSSMBWrite
c_func
(paren
r_const
r_int
id|xid
comma
r_struct
id|cifsTconInfo
op_star
id|tcon
comma
r_const
r_int
id|netfid
comma
r_const
r_int
r_int
id|count
comma
r_const
id|__u64
id|offset
comma
r_int
r_int
op_star
id|nbytes
comma
r_const
r_char
op_star
id|buf
comma
r_const
r_int
id|long_op
)paren
(brace
r_int
id|rc
op_assign
op_minus
id|EACCES
suffix:semicolon
id|WRITE_REQ
op_star
id|pSMB
op_assign
l_int|NULL
suffix:semicolon
id|WRITE_RSP
op_star
id|pSMBr
op_assign
l_int|NULL
suffix:semicolon
r_int
id|bytes_returned
suffix:semicolon
id|rc
op_assign
id|smb_init
c_func
(paren
id|SMB_COM_WRITE_ANDX
comma
l_int|14
comma
id|tcon
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMB
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMBr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
id|pSMB-&gt;AndXCommand
op_assign
l_int|0xFF
suffix:semicolon
multiline_comment|/* none */
id|pSMB-&gt;Fid
op_assign
id|netfid
suffix:semicolon
id|pSMB-&gt;OffsetLow
op_assign
id|cpu_to_le32
c_func
(paren
id|offset
op_amp
l_int|0xFFFFFFFF
)paren
suffix:semicolon
id|pSMB-&gt;OffsetHigh
op_assign
id|cpu_to_le32
c_func
(paren
id|offset
op_rshift
l_int|32
)paren
suffix:semicolon
id|pSMB-&gt;Remaining
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|count
OG
(paren
(paren
id|tcon-&gt;ses-&gt;server-&gt;maxBuf
op_minus
id|MAX_CIFS_HDR_SIZE
)paren
op_amp
l_int|0xFFFFFF00
)paren
)paren
id|pSMB-&gt;DataLengthLow
op_assign
(paren
id|tcon-&gt;ses-&gt;server-&gt;maxBuf
op_minus
id|MAX_CIFS_HDR_SIZE
)paren
op_amp
l_int|0xFFFFFF00
suffix:semicolon
r_else
id|pSMB-&gt;DataLengthLow
op_assign
id|count
suffix:semicolon
id|pSMB-&gt;DataLengthHigh
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;DataOffset
op_assign
id|cpu_to_le16
c_func
(paren
m_offsetof
(paren
r_struct
id|smb_com_write_req
comma
id|Data
)paren
op_minus
l_int|4
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|pSMB-&gt;Data
comma
id|buf
comma
id|pSMB-&gt;DataLengthLow
)paren
suffix:semicolon
id|pSMB-&gt;ByteCount
op_add_assign
id|pSMB-&gt;DataLengthLow
op_plus
l_int|1
multiline_comment|/* pad */
suffix:semicolon
id|pSMB-&gt;DataLengthLow
op_assign
id|cpu_to_le16
c_func
(paren
id|pSMB-&gt;DataLengthLow
)paren
suffix:semicolon
id|pSMB-&gt;hdr.smb_buf_length
op_add_assign
id|pSMB-&gt;ByteCount
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
id|cpu_to_le16
c_func
(paren
id|pSMB-&gt;ByteCount
)paren
suffix:semicolon
id|rc
op_assign
id|SendReceive
c_func
(paren
id|xid
comma
id|tcon-&gt;ses
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMB
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMBr
comma
op_amp
id|bytes_returned
comma
id|long_op
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|cERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Send error in write = %d&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
op_star
id|nbytes
op_assign
l_int|0
suffix:semicolon
)brace
r_else
op_star
id|nbytes
op_assign
id|le16_to_cpu
c_func
(paren
id|pSMBr-&gt;Count
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pSMB
)paren
id|buf_release
c_func
(paren
id|pSMB
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_int
DECL|function|CIFSSMBLock
id|CIFSSMBLock
c_func
(paren
r_const
r_int
id|xid
comma
r_struct
id|cifsTconInfo
op_star
id|tcon
comma
r_const
id|__u16
id|smb_file_id
comma
r_const
id|__u64
id|len
comma
r_const
id|__u64
id|offset
comma
r_const
id|__u32
id|numUnlock
comma
r_const
id|__u32
id|numLock
comma
r_const
id|__u8
id|lockType
comma
r_const
r_int
id|waitFlag
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|LOCK_REQ
op_star
id|pSMB
op_assign
l_int|NULL
suffix:semicolon
id|LOCK_RSP
op_star
id|pSMBr
op_assign
l_int|NULL
suffix:semicolon
r_int
id|bytes_returned
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;In CIFSSMBLock&quot;
)paren
)paren
suffix:semicolon
id|rc
op_assign
id|smb_init
c_func
(paren
id|SMB_COM_LOCKING_ANDX
comma
l_int|8
comma
id|tcon
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMB
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMBr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
id|pSMB-&gt;NumberOfLocks
op_assign
id|cpu_to_le32
c_func
(paren
id|numLock
)paren
suffix:semicolon
id|pSMB-&gt;NumberOfUnlocks
op_assign
id|cpu_to_le32
c_func
(paren
id|numUnlock
)paren
suffix:semicolon
id|pSMB-&gt;LockType
op_assign
id|lockType
suffix:semicolon
id|pSMB-&gt;AndXCommand
op_assign
l_int|0xFF
suffix:semicolon
multiline_comment|/* none */
id|pSMB-&gt;Fid
op_assign
id|smb_file_id
suffix:semicolon
multiline_comment|/* netfid stays le */
id|pSMB-&gt;Locks
(braket
l_int|0
)braket
dot
id|Pid
op_assign
id|cpu_to_le16
c_func
(paren
id|current-&gt;pid
)paren
suffix:semicolon
id|pSMB-&gt;Locks
(braket
l_int|0
)braket
dot
id|Length
op_assign
id|cpu_to_le64
c_func
(paren
id|len
)paren
suffix:semicolon
id|pSMB-&gt;Locks
(braket
l_int|0
)braket
dot
id|Offset
op_assign
id|cpu_to_le64
c_func
(paren
id|offset
)paren
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
r_sizeof
(paren
id|LOCKING_ANDX_RANGE
)paren
suffix:semicolon
id|pSMB-&gt;hdr.smb_buf_length
op_add_assign
id|pSMB-&gt;ByteCount
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
id|cpu_to_le16
c_func
(paren
id|pSMB-&gt;ByteCount
)paren
suffix:semicolon
id|rc
op_assign
id|SendReceive
c_func
(paren
id|xid
comma
id|tcon-&gt;ses
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMB
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMBr
comma
op_amp
id|bytes_returned
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|cERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Send error in Lock = %d&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pSMB
)paren
id|buf_release
c_func
(paren
id|pSMB
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_int
DECL|function|CIFSSMBClose
id|CIFSSMBClose
c_func
(paren
r_const
r_int
id|xid
comma
r_struct
id|cifsTconInfo
op_star
id|tcon
comma
r_int
id|smb_file_id
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|CLOSE_REQ
op_star
id|pSMB
op_assign
l_int|NULL
suffix:semicolon
id|CLOSE_RSP
op_star
id|pSMBr
op_assign
l_int|NULL
suffix:semicolon
r_int
id|bytes_returned
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;In CIFSSMBClose&quot;
)paren
)paren
suffix:semicolon
id|rc
op_assign
id|smb_init
c_func
(paren
id|SMB_COM_CLOSE
comma
l_int|3
comma
id|tcon
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMB
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMBr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
id|pSMB-&gt;FileID
op_assign
(paren
id|__u16
)paren
id|smb_file_id
suffix:semicolon
id|pSMB-&gt;LastWriteTime
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
l_int|0
suffix:semicolon
id|rc
op_assign
id|SendReceive
c_func
(paren
id|xid
comma
id|tcon-&gt;ses
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMB
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMBr
comma
op_amp
id|bytes_returned
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|cERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Send error in Close = %d&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pSMB
)paren
id|buf_release
c_func
(paren
id|pSMB
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_int
DECL|function|CIFSSMBRename
id|CIFSSMBRename
c_func
(paren
r_const
r_int
id|xid
comma
r_struct
id|cifsTconInfo
op_star
id|tcon
comma
r_const
r_char
op_star
id|fromName
comma
r_const
r_char
op_star
id|toName
comma
r_const
r_struct
id|nls_table
op_star
id|nls_codepage
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|RENAME_REQ
op_star
id|pSMB
op_assign
l_int|NULL
suffix:semicolon
id|RENAME_RSP
op_star
id|pSMBr
op_assign
l_int|NULL
suffix:semicolon
r_int
id|bytes_returned
suffix:semicolon
r_int
id|name_len
comma
id|name_len2
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;In CIFSSMBRename&quot;
)paren
)paren
suffix:semicolon
id|rc
op_assign
id|smb_init
c_func
(paren
id|SMB_COM_RENAME
comma
l_int|1
comma
id|tcon
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMB
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMBr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
id|pSMB-&gt;BufferFormat
op_assign
l_int|0x04
suffix:semicolon
id|pSMB-&gt;SearchAttributes
op_assign
id|cpu_to_le16
c_func
(paren
id|ATTR_READONLY
op_or
id|ATTR_HIDDEN
op_or
id|ATTR_SYSTEM
op_or
id|ATTR_DIRECTORY
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pSMB-&gt;hdr.Flags2
op_amp
id|SMBFLG2_UNICODE
)paren
(brace
id|name_len
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|pSMB-&gt;OldFileName
comma
id|fromName
comma
l_int|530
multiline_comment|/* find define for this maxpathcomponent */
comma
id|nls_codepage
)paren
suffix:semicolon
id|name_len
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|name_len
op_mul_assign
l_int|2
suffix:semicolon
id|pSMB-&gt;OldFileName
(braket
id|name_len
)braket
op_assign
l_int|0x04
suffix:semicolon
multiline_comment|/* pad */
multiline_comment|/* protocol requires ASCII signature byte on Unicode string */
id|pSMB-&gt;OldFileName
(braket
id|name_len
op_plus
l_int|1
)braket
op_assign
l_int|0x00
suffix:semicolon
id|name_len2
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
op_amp
id|pSMB
op_member_access_from_pointer
id|OldFileName
(braket
id|name_len
op_plus
l_int|2
)braket
comma
id|toName
comma
l_int|530
comma
id|nls_codepage
)paren
suffix:semicolon
id|name_len2
op_add_assign
l_int|1
multiline_comment|/* trailing null */
op_plus
l_int|1
multiline_comment|/* Signature word */
suffix:semicolon
id|name_len2
op_mul_assign
l_int|2
suffix:semicolon
multiline_comment|/* convert to bytes */
)brace
r_else
(brace
multiline_comment|/* BB improve the check for buffer overruns BB */
id|name_len
op_assign
id|strnlen
c_func
(paren
id|fromName
comma
l_int|530
)paren
suffix:semicolon
id|name_len
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|strncpy
c_func
(paren
id|pSMB-&gt;OldFileName
comma
id|fromName
comma
id|name_len
)paren
suffix:semicolon
id|name_len2
op_assign
id|strnlen
c_func
(paren
id|toName
comma
l_int|530
)paren
suffix:semicolon
id|name_len2
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|pSMB-&gt;OldFileName
(braket
id|name_len
)braket
op_assign
l_int|0x04
suffix:semicolon
multiline_comment|/* 2nd buffer format */
id|strncpy
c_func
(paren
op_amp
id|pSMB-&gt;OldFileName
(braket
id|name_len
op_plus
l_int|1
)braket
comma
id|toName
comma
id|name_len2
)paren
suffix:semicolon
id|name_len2
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|name_len2
op_increment
suffix:semicolon
multiline_comment|/* signature byte */
)brace
id|pSMB-&gt;ByteCount
op_assign
l_int|1
multiline_comment|/* 1st signature byte */
op_plus
id|name_len
op_plus
id|name_len2
suffix:semicolon
multiline_comment|/* we could also set search attributes but not needed */
id|pSMB-&gt;hdr.smb_buf_length
op_add_assign
id|pSMB-&gt;ByteCount
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
id|cpu_to_le16
c_func
(paren
id|pSMB-&gt;ByteCount
)paren
suffix:semicolon
id|rc
op_assign
id|SendReceive
c_func
(paren
id|xid
comma
id|tcon-&gt;ses
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMB
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMBr
comma
op_amp
id|bytes_returned
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Send error in RMDir = %d&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pSMB
)paren
id|buf_release
c_func
(paren
id|pSMB
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_int
DECL|function|CIFSUnixCreateSymLink
id|CIFSUnixCreateSymLink
c_func
(paren
r_const
r_int
id|xid
comma
r_struct
id|cifsTconInfo
op_star
id|tcon
comma
r_const
r_char
op_star
id|fromName
comma
r_const
r_char
op_star
id|toName
comma
r_const
r_struct
id|nls_table
op_star
id|nls_codepage
)paren
(brace
id|TRANSACTION2_SPI_REQ
op_star
id|pSMB
op_assign
l_int|NULL
suffix:semicolon
id|TRANSACTION2_SPI_RSP
op_star
id|pSMBr
op_assign
l_int|NULL
suffix:semicolon
r_char
op_star
id|data_offset
suffix:semicolon
r_int
id|name_len
suffix:semicolon
r_int
id|name_len_target
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|bytes_returned
op_assign
l_int|0
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;In Symlink Unix style&quot;
)paren
)paren
suffix:semicolon
id|rc
op_assign
id|smb_init
c_func
(paren
id|SMB_COM_TRANSACTION2
comma
l_int|15
comma
id|tcon
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMB
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMBr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|pSMB-&gt;hdr.Flags2
op_amp
id|SMBFLG2_UNICODE
)paren
(brace
id|name_len
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|pSMB-&gt;FileName
comma
id|fromName
comma
l_int|530
multiline_comment|/* find define for this maxpathcomponent */
comma
id|nls_codepage
)paren
suffix:semicolon
id|name_len
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|name_len
op_mul_assign
l_int|2
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* BB improve the check for buffer overruns BB */
id|name_len
op_assign
id|strnlen
c_func
(paren
id|fromName
comma
l_int|530
)paren
suffix:semicolon
id|name_len
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|strncpy
c_func
(paren
id|pSMB-&gt;FileName
comma
id|fromName
comma
id|name_len
)paren
suffix:semicolon
)brace
id|pSMB-&gt;ParameterCount
op_assign
l_int|6
op_plus
id|name_len
suffix:semicolon
id|pSMB-&gt;MaxSetupCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Flags
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Timeout
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved2
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;ParameterOffset
op_assign
m_offsetof
(paren
r_struct
id|smb_com_transaction2_spi_req
comma
id|InformationLevel
)paren
op_minus
l_int|4
suffix:semicolon
id|pSMB-&gt;DataOffset
op_assign
id|pSMB-&gt;ParameterOffset
op_plus
id|pSMB-&gt;ParameterCount
suffix:semicolon
id|data_offset
op_assign
(paren
r_char
op_star
)paren
(paren
op_amp
id|pSMB-&gt;hdr.Protocol
)paren
op_plus
id|pSMB-&gt;DataOffset
suffix:semicolon
r_if
c_cond
(paren
id|pSMB-&gt;hdr.Flags2
op_amp
id|SMBFLG2_UNICODE
)paren
(brace
id|name_len_target
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|data_offset
comma
id|toName
comma
l_int|530
multiline_comment|/* find define for this maxpathcomponent */
comma
id|nls_codepage
)paren
suffix:semicolon
id|name_len_target
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|name_len_target
op_mul_assign
l_int|2
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* BB improve the check for buffer overruns BB */
id|name_len_target
op_assign
id|strnlen
c_func
(paren
id|toName
comma
l_int|530
)paren
suffix:semicolon
id|name_len_target
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|strncpy
c_func
(paren
id|data_offset
comma
id|toName
comma
id|name_len_target
)paren
suffix:semicolon
)brace
id|pSMB-&gt;DataCount
op_assign
id|name_len_target
suffix:semicolon
id|pSMB-&gt;MaxParameterCount
op_assign
id|cpu_to_le16
c_func
(paren
l_int|2
)paren
suffix:semicolon
multiline_comment|/* BB find exact max on data count below from sess */
id|pSMB-&gt;MaxDataCount
op_assign
id|cpu_to_le16
c_func
(paren
l_int|1000
)paren
suffix:semicolon
id|pSMB-&gt;SetupCount
op_assign
l_int|1
suffix:semicolon
id|pSMB-&gt;Reserved3
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;SubCommand
op_assign
id|cpu_to_le16
c_func
(paren
id|TRANS2_SET_PATH_INFORMATION
)paren
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
l_int|3
multiline_comment|/* pad */
op_plus
id|pSMB-&gt;ParameterCount
op_plus
id|pSMB-&gt;DataCount
suffix:semicolon
id|pSMB-&gt;DataCount
op_assign
id|cpu_to_le16
c_func
(paren
id|pSMB-&gt;DataCount
)paren
suffix:semicolon
id|pSMB-&gt;ParameterCount
op_assign
id|cpu_to_le16
c_func
(paren
id|pSMB-&gt;ParameterCount
)paren
suffix:semicolon
id|pSMB-&gt;TotalDataCount
op_assign
id|pSMB-&gt;DataCount
suffix:semicolon
id|pSMB-&gt;TotalParameterCount
op_assign
id|pSMB-&gt;ParameterCount
suffix:semicolon
id|pSMB-&gt;ParameterOffset
op_assign
id|cpu_to_le16
c_func
(paren
id|pSMB-&gt;ParameterOffset
)paren
suffix:semicolon
id|pSMB-&gt;DataOffset
op_assign
id|cpu_to_le16
c_func
(paren
id|pSMB-&gt;DataOffset
)paren
suffix:semicolon
id|pSMB-&gt;InformationLevel
op_assign
id|cpu_to_le16
c_func
(paren
id|SMB_SET_FILE_UNIX_LINK
)paren
suffix:semicolon
id|pSMB-&gt;Reserved4
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;hdr.smb_buf_length
op_add_assign
id|pSMB-&gt;ByteCount
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
id|cpu_to_le16
c_func
(paren
id|pSMB-&gt;ByteCount
)paren
suffix:semicolon
id|rc
op_assign
id|SendReceive
c_func
(paren
id|xid
comma
id|tcon-&gt;ses
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMB
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMBr
comma
op_amp
id|bytes_returned
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Send error in SetPathInfo (create symlink) = %d&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pSMB
)paren
id|buf_release
c_func
(paren
id|pSMB
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_int
DECL|function|CIFSUnixCreateHardLink
id|CIFSUnixCreateHardLink
c_func
(paren
r_const
r_int
id|xid
comma
r_struct
id|cifsTconInfo
op_star
id|tcon
comma
r_const
r_char
op_star
id|fromName
comma
r_const
r_char
op_star
id|toName
comma
r_const
r_struct
id|nls_table
op_star
id|nls_codepage
)paren
(brace
id|TRANSACTION2_SPI_REQ
op_star
id|pSMB
op_assign
l_int|NULL
suffix:semicolon
id|TRANSACTION2_SPI_RSP
op_star
id|pSMBr
op_assign
l_int|NULL
suffix:semicolon
r_char
op_star
id|data_offset
suffix:semicolon
r_int
id|name_len
suffix:semicolon
r_int
id|name_len_target
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|bytes_returned
op_assign
l_int|0
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;In Create Hard link Unix style&quot;
)paren
)paren
suffix:semicolon
id|rc
op_assign
id|smb_init
c_func
(paren
id|SMB_COM_TRANSACTION2
comma
l_int|15
comma
id|tcon
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMB
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMBr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|pSMB-&gt;hdr.Flags2
op_amp
id|SMBFLG2_UNICODE
)paren
(brace
id|name_len
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|pSMB-&gt;FileName
comma
id|toName
comma
l_int|530
multiline_comment|/* find define for this maxpathcomponent */
comma
id|nls_codepage
)paren
suffix:semicolon
id|name_len
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|name_len
op_mul_assign
l_int|2
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* BB improve the check for buffer overruns BB */
id|name_len
op_assign
id|strnlen
c_func
(paren
id|toName
comma
l_int|530
)paren
suffix:semicolon
id|name_len
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|strncpy
c_func
(paren
id|pSMB-&gt;FileName
comma
id|toName
comma
id|name_len
)paren
suffix:semicolon
)brace
id|pSMB-&gt;ParameterCount
op_assign
l_int|6
op_plus
id|name_len
suffix:semicolon
id|pSMB-&gt;MaxSetupCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Flags
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Timeout
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved2
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;ParameterOffset
op_assign
m_offsetof
(paren
r_struct
id|smb_com_transaction2_spi_req
comma
id|InformationLevel
)paren
op_minus
l_int|4
suffix:semicolon
id|pSMB-&gt;DataOffset
op_assign
id|pSMB-&gt;ParameterOffset
op_plus
id|pSMB-&gt;ParameterCount
suffix:semicolon
id|data_offset
op_assign
(paren
r_char
op_star
)paren
(paren
op_amp
id|pSMB-&gt;hdr.Protocol
)paren
op_plus
id|pSMB-&gt;DataOffset
suffix:semicolon
r_if
c_cond
(paren
id|pSMB-&gt;hdr.Flags2
op_amp
id|SMBFLG2_UNICODE
)paren
(brace
id|name_len_target
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|data_offset
comma
id|fromName
comma
l_int|530
multiline_comment|/* find define for this maxpathcomponent */
comma
id|nls_codepage
)paren
suffix:semicolon
id|name_len_target
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|name_len_target
op_mul_assign
l_int|2
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* BB improve the check for buffer overruns BB */
id|name_len_target
op_assign
id|strnlen
c_func
(paren
id|fromName
comma
l_int|530
)paren
suffix:semicolon
id|name_len_target
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|strncpy
c_func
(paren
id|data_offset
comma
id|fromName
comma
id|name_len_target
)paren
suffix:semicolon
)brace
id|pSMB-&gt;DataCount
op_assign
id|name_len_target
suffix:semicolon
id|pSMB-&gt;MaxParameterCount
op_assign
id|cpu_to_le16
c_func
(paren
l_int|2
)paren
suffix:semicolon
multiline_comment|/* BB find exact max on data count below from sess*/
id|pSMB-&gt;MaxDataCount
op_assign
id|cpu_to_le16
c_func
(paren
l_int|1000
)paren
suffix:semicolon
id|pSMB-&gt;SetupCount
op_assign
l_int|1
suffix:semicolon
id|pSMB-&gt;Reserved3
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;SubCommand
op_assign
id|cpu_to_le16
c_func
(paren
id|TRANS2_SET_PATH_INFORMATION
)paren
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
l_int|3
multiline_comment|/* pad */
op_plus
id|pSMB-&gt;ParameterCount
op_plus
id|pSMB-&gt;DataCount
suffix:semicolon
id|pSMB-&gt;ParameterCount
op_assign
id|cpu_to_le16
c_func
(paren
id|pSMB-&gt;ParameterCount
)paren
suffix:semicolon
id|pSMB-&gt;TotalParameterCount
op_assign
id|pSMB-&gt;ParameterCount
suffix:semicolon
id|pSMB-&gt;DataCount
op_assign
id|cpu_to_le16
c_func
(paren
id|pSMB-&gt;DataCount
)paren
suffix:semicolon
id|pSMB-&gt;TotalDataCount
op_assign
id|pSMB-&gt;DataCount
suffix:semicolon
id|pSMB-&gt;ParameterOffset
op_assign
id|cpu_to_le16
c_func
(paren
id|pSMB-&gt;ParameterOffset
)paren
suffix:semicolon
id|pSMB-&gt;DataOffset
op_assign
id|cpu_to_le16
c_func
(paren
id|pSMB-&gt;DataOffset
)paren
suffix:semicolon
id|pSMB-&gt;InformationLevel
op_assign
id|cpu_to_le16
c_func
(paren
id|SMB_SET_FILE_UNIX_HLINK
)paren
suffix:semicolon
id|pSMB-&gt;Reserved4
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;hdr.smb_buf_length
op_add_assign
id|pSMB-&gt;ByteCount
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
id|cpu_to_le16
c_func
(paren
id|pSMB-&gt;ByteCount
)paren
suffix:semicolon
id|rc
op_assign
id|SendReceive
c_func
(paren
id|xid
comma
id|tcon-&gt;ses
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMB
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMBr
comma
op_amp
id|bytes_returned
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Send error in SetPathInfo (hard link) = %d&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pSMB
)paren
id|buf_release
c_func
(paren
id|pSMB
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_int
DECL|function|CIFSCreateHardLink
id|CIFSCreateHardLink
c_func
(paren
r_const
r_int
id|xid
comma
r_struct
id|cifsTconInfo
op_star
id|tcon
comma
r_const
r_char
op_star
id|fromName
comma
r_const
r_char
op_star
id|toName
comma
r_const
r_struct
id|nls_table
op_star
id|nls_codepage
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|NT_RENAME_REQ
op_star
id|pSMB
op_assign
l_int|NULL
suffix:semicolon
id|RENAME_RSP
op_star
id|pSMBr
op_assign
l_int|NULL
suffix:semicolon
r_int
id|bytes_returned
suffix:semicolon
r_int
id|name_len
comma
id|name_len2
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;In CIFSCreateHardLink&quot;
)paren
)paren
suffix:semicolon
id|rc
op_assign
id|smb_init
c_func
(paren
id|SMB_COM_NT_RENAME
comma
l_int|4
comma
id|tcon
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMB
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMBr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
id|pSMB-&gt;SearchAttributes
op_assign
id|cpu_to_le16
c_func
(paren
id|ATTR_READONLY
op_or
id|ATTR_HIDDEN
op_or
id|ATTR_SYSTEM
op_or
id|ATTR_DIRECTORY
)paren
suffix:semicolon
id|pSMB-&gt;Flags
op_assign
id|cpu_to_le16
c_func
(paren
id|CREATE_HARD_LINK
)paren
suffix:semicolon
id|pSMB-&gt;ClusterCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;BufferFormat
op_assign
l_int|0x04
suffix:semicolon
r_if
c_cond
(paren
id|pSMB-&gt;hdr.Flags2
op_amp
id|SMBFLG2_UNICODE
)paren
(brace
id|name_len
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|pSMB-&gt;OldFileName
comma
id|fromName
comma
l_int|530
multiline_comment|/* find define for this maxpathcomponent */
comma
id|nls_codepage
)paren
suffix:semicolon
id|name_len
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|name_len
op_mul_assign
l_int|2
suffix:semicolon
id|pSMB-&gt;OldFileName
(braket
id|name_len
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* pad */
id|pSMB-&gt;OldFileName
(braket
id|name_len
op_plus
l_int|1
)braket
op_assign
l_int|0x04
suffix:semicolon
id|name_len2
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
op_amp
id|pSMB
op_member_access_from_pointer
id|OldFileName
(braket
id|name_len
op_plus
l_int|2
)braket
comma
id|toName
comma
l_int|530
comma
id|nls_codepage
)paren
suffix:semicolon
id|name_len2
op_add_assign
l_int|1
multiline_comment|/* trailing null */
op_plus
l_int|1
multiline_comment|/* Signature word */
suffix:semicolon
id|name_len2
op_mul_assign
l_int|2
suffix:semicolon
multiline_comment|/* convert to bytes */
)brace
r_else
(brace
multiline_comment|/* BB improve the check for buffer overruns BB */
id|name_len
op_assign
id|strnlen
c_func
(paren
id|fromName
comma
l_int|530
)paren
suffix:semicolon
id|name_len
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|strncpy
c_func
(paren
id|pSMB-&gt;OldFileName
comma
id|fromName
comma
id|name_len
)paren
suffix:semicolon
id|name_len2
op_assign
id|strnlen
c_func
(paren
id|toName
comma
l_int|530
)paren
suffix:semicolon
id|name_len2
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|pSMB-&gt;OldFileName
(braket
id|name_len
)braket
op_assign
l_int|0x04
suffix:semicolon
multiline_comment|/* 2nd buffer format */
id|strncpy
c_func
(paren
op_amp
id|pSMB-&gt;OldFileName
(braket
id|name_len
op_plus
l_int|1
)braket
comma
id|toName
comma
id|name_len2
)paren
suffix:semicolon
id|name_len2
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|name_len2
op_increment
suffix:semicolon
multiline_comment|/* signature byte */
)brace
id|pSMB-&gt;ByteCount
op_assign
l_int|1
multiline_comment|/* string type byte */
op_plus
id|name_len
op_plus
id|name_len2
suffix:semicolon
id|pSMB-&gt;hdr.smb_buf_length
op_add_assign
id|pSMB-&gt;ByteCount
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
id|cpu_to_le16
c_func
(paren
id|pSMB-&gt;ByteCount
)paren
suffix:semicolon
id|rc
op_assign
id|SendReceive
c_func
(paren
id|xid
comma
id|tcon-&gt;ses
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMB
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMBr
comma
op_amp
id|bytes_returned
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Send error in hard link (NT rename) = %d&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pSMB
)paren
id|buf_release
c_func
(paren
id|pSMB
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_int
DECL|function|CIFSSMBUnixQuerySymLink
id|CIFSSMBUnixQuerySymLink
c_func
(paren
r_const
r_int
id|xid
comma
r_struct
id|cifsTconInfo
op_star
id|tcon
comma
r_const
r_int
r_char
op_star
id|searchName
comma
r_char
op_star
id|symlinkinfo
comma
r_const
r_int
id|buflen
comma
r_const
r_struct
id|nls_table
op_star
id|nls_codepage
)paren
(brace
multiline_comment|/* SMB_QUERY_FILE_UNIX_LINK */
id|TRANSACTION2_QPI_REQ
op_star
id|pSMB
op_assign
l_int|NULL
suffix:semicolon
id|TRANSACTION2_QPI_RSP
op_star
id|pSMBr
op_assign
l_int|NULL
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|bytes_returned
suffix:semicolon
r_int
id|name_len
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;In QPathSymLinkInfo (Unix) for path %s&quot;
comma
id|searchName
)paren
)paren
suffix:semicolon
id|rc
op_assign
id|smb_init
c_func
(paren
id|SMB_COM_TRANSACTION2
comma
l_int|15
comma
id|tcon
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMB
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMBr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|pSMB-&gt;hdr.Flags2
op_amp
id|SMBFLG2_UNICODE
)paren
(brace
id|name_len
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|pSMB-&gt;FileName
comma
id|searchName
comma
l_int|530
multiline_comment|/* find define for this maxpathcomponent */
comma
id|nls_codepage
)paren
suffix:semicolon
id|name_len
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|name_len
op_mul_assign
l_int|2
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* BB improve the check for buffer overruns BB */
id|name_len
op_assign
id|strnlen
c_func
(paren
id|searchName
comma
l_int|530
)paren
suffix:semicolon
id|name_len
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|strncpy
c_func
(paren
id|pSMB-&gt;FileName
comma
id|searchName
comma
id|name_len
)paren
suffix:semicolon
)brace
id|pSMB-&gt;TotalParameterCount
op_assign
l_int|2
multiline_comment|/* level */
op_plus
l_int|4
multiline_comment|/* rsrvd */
op_plus
id|name_len
multiline_comment|/* incl null */
suffix:semicolon
id|pSMB-&gt;TotalDataCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;MaxParameterCount
op_assign
id|cpu_to_le16
c_func
(paren
l_int|2
)paren
suffix:semicolon
multiline_comment|/* BB find exact max data count below from sess structure BB */
id|pSMB-&gt;MaxDataCount
op_assign
id|cpu_to_le16
c_func
(paren
l_int|4000
)paren
suffix:semicolon
id|pSMB-&gt;MaxSetupCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Flags
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Timeout
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved2
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;ParameterOffset
op_assign
id|cpu_to_le16
c_func
(paren
m_offsetof
(paren
r_struct
id|smb_com_transaction2_qpi_req
comma
id|InformationLevel
)paren
op_minus
l_int|4
)paren
suffix:semicolon
id|pSMB-&gt;DataCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;DataOffset
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;SetupCount
op_assign
l_int|1
suffix:semicolon
id|pSMB-&gt;Reserved3
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;SubCommand
op_assign
id|cpu_to_le16
c_func
(paren
id|TRANS2_QUERY_PATH_INFORMATION
)paren
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
id|pSMB-&gt;TotalParameterCount
op_plus
l_int|1
multiline_comment|/* pad */
suffix:semicolon
id|pSMB-&gt;TotalParameterCount
op_assign
id|cpu_to_le16
c_func
(paren
id|pSMB-&gt;TotalParameterCount
)paren
suffix:semicolon
id|pSMB-&gt;ParameterCount
op_assign
id|pSMB-&gt;TotalParameterCount
suffix:semicolon
id|pSMB-&gt;InformationLevel
op_assign
id|cpu_to_le16
c_func
(paren
id|SMB_QUERY_FILE_UNIX_LINK
)paren
suffix:semicolon
id|pSMB-&gt;Reserved4
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;hdr.smb_buf_length
op_add_assign
id|pSMB-&gt;ByteCount
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
id|cpu_to_le16
c_func
(paren
id|pSMB-&gt;ByteCount
)paren
suffix:semicolon
id|rc
op_assign
id|SendReceive
c_func
(paren
id|xid
comma
id|tcon-&gt;ses
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMB
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMBr
comma
op_amp
id|bytes_returned
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Send error in QuerySymLinkInfo = %d&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* decode response */
id|pSMBr-&gt;DataOffset
op_assign
id|le16_to_cpu
c_func
(paren
id|pSMBr-&gt;DataOffset
)paren
suffix:semicolon
id|pSMBr-&gt;DataCount
op_assign
id|le16_to_cpu
c_func
(paren
id|pSMBr-&gt;DataCount
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pSMBr-&gt;ByteCount
OL
l_int|2
)paren
op_logical_or
(paren
id|pSMBr-&gt;DataOffset
OG
l_int|512
)paren
)paren
multiline_comment|/* BB also check enough total bytes returned */
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
multiline_comment|/* bad smb */
r_else
(brace
r_if
c_cond
(paren
id|pSMBr-&gt;hdr.Flags2
op_amp
id|SMBFLG2_UNICODE
)paren
(brace
id|name_len
op_assign
id|UniStrnlen
c_func
(paren
(paren
m_wchar_t
op_star
)paren
(paren
(paren
r_char
op_star
)paren
op_amp
id|pSMBr-&gt;hdr.Protocol
op_plus
id|pSMBr-&gt;DataOffset
)paren
comma
id|min_t
c_func
(paren
r_const
r_int
comma
id|buflen
comma
id|pSMBr-&gt;DataCount
)paren
op_div
l_int|2
)paren
suffix:semicolon
id|cifs_strfromUCS_le
c_func
(paren
id|symlinkinfo
comma
(paren
m_wchar_t
op_star
)paren
(paren
(paren
r_char
op_star
)paren
op_amp
id|pSMBr-&gt;hdr.Protocol
op_plus
id|pSMBr-&gt;DataOffset
)paren
comma
id|name_len
comma
id|nls_codepage
)paren
suffix:semicolon
)brace
r_else
(brace
id|strncpy
c_func
(paren
id|symlinkinfo
comma
(paren
r_char
op_star
)paren
op_amp
id|pSMBr-&gt;hdr.Protocol
op_plus
id|pSMBr-&gt;DataOffset
comma
id|min_t
c_func
(paren
r_const
r_int
comma
id|buflen
comma
id|pSMBr-&gt;DataCount
)paren
)paren
suffix:semicolon
)brace
id|symlinkinfo
(braket
id|buflen
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* just in case so calling code does not go off the end of buffer */
)brace
)brace
r_if
c_cond
(paren
id|pSMB
)paren
id|buf_release
c_func
(paren
id|pSMB
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_int
DECL|function|CIFSSMBQueryReparseLinkInfo
id|CIFSSMBQueryReparseLinkInfo
c_func
(paren
r_const
r_int
id|xid
comma
r_struct
id|cifsTconInfo
op_star
id|tcon
comma
r_const
r_int
r_char
op_star
id|searchName
comma
r_char
op_star
id|symlinkinfo
comma
r_const
r_int
id|buflen
comma
id|__u16
id|fid
comma
r_const
r_struct
id|nls_table
op_star
id|nls_codepage
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|bytes_returned
suffix:semicolon
r_int
id|name_len
suffix:semicolon
r_struct
id|smb_com_transaction_ioctl_req
op_star
id|pSMB
suffix:semicolon
r_struct
id|smb_com_transaction_ioctl_rsp
op_star
id|pSMBr
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;In Windows reparse style QueryLink for path %s&quot;
comma
id|searchName
)paren
)paren
suffix:semicolon
id|rc
op_assign
id|smb_init
c_func
(paren
id|SMB_COM_NT_TRANSACT
comma
l_int|23
comma
id|tcon
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMB
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMBr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
id|pSMB-&gt;TotalParameterCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;TotalDataCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;MaxParameterCount
op_assign
id|cpu_to_le16
c_func
(paren
l_int|2
)paren
suffix:semicolon
multiline_comment|/* BB find exact data count max from sess structure BB */
id|pSMB-&gt;MaxDataCount
op_assign
id|cpu_to_le16
c_func
(paren
l_int|4000
)paren
suffix:semicolon
id|pSMB-&gt;MaxSetupCount
op_assign
l_int|4
suffix:semicolon
id|pSMB-&gt;Reserved
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;ParameterOffset
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;DataCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;DataOffset
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;SetupCount
op_assign
l_int|4
suffix:semicolon
id|pSMB-&gt;SubCommand
op_assign
id|cpu_to_le16
c_func
(paren
id|NT_TRANSACT_IOCTL
)paren
suffix:semicolon
id|pSMB-&gt;ParameterCount
op_assign
id|pSMB-&gt;TotalParameterCount
suffix:semicolon
id|pSMB-&gt;FunctionCode
op_assign
id|cpu_to_le32
c_func
(paren
id|FSCTL_GET_REPARSE_POINT
)paren
suffix:semicolon
id|pSMB-&gt;IsFsctl
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* FSCTL */
id|pSMB-&gt;IsRootFlag
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Fid
op_assign
id|fid
suffix:semicolon
multiline_comment|/* file handle always le */
id|pSMB-&gt;ByteCount
op_assign
l_int|0
suffix:semicolon
id|rc
op_assign
id|SendReceive
c_func
(paren
id|xid
comma
id|tcon-&gt;ses
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMB
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMBr
comma
op_amp
id|bytes_returned
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Send error in QueryReparseLinkInfo = %d&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* decode response */
id|pSMBr-&gt;DataOffset
op_assign
id|le16_to_cpu
c_func
(paren
id|pSMBr-&gt;DataOffset
)paren
suffix:semicolon
id|pSMBr-&gt;DataCount
op_assign
id|le16_to_cpu
c_func
(paren
id|pSMBr-&gt;DataCount
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pSMBr-&gt;ByteCount
OL
l_int|2
)paren
op_logical_or
(paren
id|pSMBr-&gt;DataOffset
OG
l_int|512
)paren
)paren
multiline_comment|/* BB also check enough total bytes returned */
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
multiline_comment|/* bad smb */
r_else
(brace
r_if
c_cond
(paren
id|pSMBr-&gt;DataCount
op_logical_and
(paren
id|pSMBr-&gt;DataCount
OL
l_int|2048
)paren
)paren
(brace
multiline_comment|/* could also validate reparse tag &amp;&amp; better check name length */
r_struct
id|reparse_data
op_star
id|reparse_buf
op_assign
(paren
r_struct
id|reparse_data
op_star
)paren
(paren
(paren
r_char
op_star
)paren
op_amp
id|pSMBr-&gt;hdr.Protocol
op_plus
id|pSMBr-&gt;DataOffset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pSMBr-&gt;hdr.Flags2
op_amp
id|SMBFLG2_UNICODE
)paren
(brace
id|name_len
op_assign
id|UniStrnlen
c_func
(paren
(paren
m_wchar_t
op_star
)paren
(paren
id|reparse_buf-&gt;LinkNamesBuf
op_plus
id|reparse_buf-&gt;TargetNameOffset
)paren
comma
id|min
c_func
(paren
id|buflen
op_div
l_int|2
comma
id|reparse_buf-&gt;TargetNameLen
op_div
l_int|2
)paren
)paren
suffix:semicolon
id|cifs_strfromUCS_le
c_func
(paren
id|symlinkinfo
comma
(paren
m_wchar_t
op_star
)paren
(paren
id|reparse_buf-&gt;LinkNamesBuf
op_plus
id|reparse_buf-&gt;TargetNameOffset
)paren
comma
id|name_len
comma
id|nls_codepage
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* ASCII names */
id|strncpy
c_func
(paren
id|symlinkinfo
comma
id|reparse_buf-&gt;LinkNamesBuf
op_plus
id|reparse_buf-&gt;TargetNameOffset
comma
id|min_t
c_func
(paren
r_const
r_int
comma
id|buflen
comma
id|reparse_buf-&gt;TargetNameLen
)paren
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Invalid return data count on get reparse info ioctl&quot;
)paren
)paren
suffix:semicolon
)brace
id|symlinkinfo
(braket
id|buflen
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* just in case so the caller&n;&t;&t;&t;&t;&t;does not go off the end of the buffer */
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;readlink result - %s &quot;
comma
id|symlinkinfo
)paren
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|pSMB
)paren
id|buf_release
c_func
(paren
id|pSMB
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_int
DECL|function|CIFSSMBQPathInfo
id|CIFSSMBQPathInfo
c_func
(paren
r_const
r_int
id|xid
comma
r_struct
id|cifsTconInfo
op_star
id|tcon
comma
r_const
r_int
r_char
op_star
id|searchName
comma
id|FILE_ALL_INFO
op_star
id|pFindData
comma
r_const
r_struct
id|nls_table
op_star
id|nls_codepage
)paren
(brace
multiline_comment|/* level 263 SMB_QUERY_FILE_ALL_INFO */
id|TRANSACTION2_QPI_REQ
op_star
id|pSMB
op_assign
l_int|NULL
suffix:semicolon
id|TRANSACTION2_QPI_RSP
op_star
id|pSMBr
op_assign
l_int|NULL
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|bytes_returned
suffix:semicolon
r_int
id|name_len
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;In QPathInfo path %s&quot;
comma
id|searchName
)paren
)paren
suffix:semicolon
id|rc
op_assign
id|smb_init
c_func
(paren
id|SMB_COM_TRANSACTION2
comma
l_int|15
comma
id|tcon
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMB
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMBr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|pSMB-&gt;hdr.Flags2
op_amp
id|SMBFLG2_UNICODE
)paren
(brace
id|name_len
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|pSMB-&gt;FileName
comma
id|searchName
comma
l_int|530
multiline_comment|/* find define for this maxpathcomponent */
comma
id|nls_codepage
)paren
suffix:semicolon
id|name_len
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|name_len
op_mul_assign
l_int|2
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* BB improve the check for buffer overruns BB */
id|name_len
op_assign
id|strnlen
c_func
(paren
id|searchName
comma
l_int|530
)paren
suffix:semicolon
id|name_len
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|strncpy
c_func
(paren
id|pSMB-&gt;FileName
comma
id|searchName
comma
id|name_len
)paren
suffix:semicolon
)brace
id|pSMB-&gt;TotalParameterCount
op_assign
l_int|2
multiline_comment|/* level */
op_plus
l_int|4
multiline_comment|/* reserved */
op_plus
id|name_len
multiline_comment|/* includes null */
suffix:semicolon
id|pSMB-&gt;TotalDataCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;MaxParameterCount
op_assign
id|cpu_to_le16
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|pSMB-&gt;MaxDataCount
op_assign
id|cpu_to_le16
c_func
(paren
l_int|4000
)paren
suffix:semicolon
multiline_comment|/* BB find exact max SMB PDU from sess structure BB */
id|pSMB-&gt;MaxSetupCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Flags
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Timeout
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved2
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;ParameterOffset
op_assign
id|cpu_to_le16
c_func
(paren
m_offsetof
(paren
r_struct
id|smb_com_transaction2_qpi_req
comma
id|InformationLevel
)paren
op_minus
l_int|4
)paren
suffix:semicolon
id|pSMB-&gt;DataCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;DataOffset
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;SetupCount
op_assign
l_int|1
suffix:semicolon
id|pSMB-&gt;Reserved3
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;SubCommand
op_assign
id|cpu_to_le16
c_func
(paren
id|TRANS2_QUERY_PATH_INFORMATION
)paren
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
id|pSMB-&gt;TotalParameterCount
op_plus
l_int|1
multiline_comment|/* pad */
suffix:semicolon
id|pSMB-&gt;TotalParameterCount
op_assign
id|cpu_to_le16
c_func
(paren
id|pSMB-&gt;TotalParameterCount
)paren
suffix:semicolon
id|pSMB-&gt;ParameterCount
op_assign
id|pSMB-&gt;TotalParameterCount
suffix:semicolon
id|pSMB-&gt;InformationLevel
op_assign
id|cpu_to_le16
c_func
(paren
id|SMB_QUERY_FILE_ALL_INFO
)paren
suffix:semicolon
id|pSMB-&gt;Reserved4
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;hdr.smb_buf_length
op_add_assign
id|pSMB-&gt;ByteCount
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
id|cpu_to_le16
c_func
(paren
id|pSMB-&gt;ByteCount
)paren
suffix:semicolon
id|rc
op_assign
id|SendReceive
c_func
(paren
id|xid
comma
id|tcon-&gt;ses
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMB
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMBr
comma
op_amp
id|bytes_returned
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Send error in QPathInfo = %d&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* decode response */
id|pSMBr-&gt;DataOffset
op_assign
id|le16_to_cpu
c_func
(paren
id|pSMBr-&gt;DataOffset
)paren
suffix:semicolon
multiline_comment|/* BB also check enough total bytes returned */
r_if
c_cond
(paren
(paren
id|pSMBr-&gt;ByteCount
OL
l_int|40
)paren
op_logical_or
(paren
id|pSMBr-&gt;DataOffset
OG
l_int|512
)paren
)paren
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
multiline_comment|/* bad smb */
r_else
(brace
id|memcpy
c_func
(paren
(paren
r_char
op_star
)paren
id|pFindData
comma
(paren
r_char
op_star
)paren
op_amp
id|pSMBr-&gt;hdr.Protocol
op_plus
id|pSMBr-&gt;DataOffset
comma
r_sizeof
(paren
id|FILE_ALL_INFO
)paren
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|pSMB
)paren
id|buf_release
c_func
(paren
id|pSMB
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_int
DECL|function|CIFSSMBUnixQPathInfo
id|CIFSSMBUnixQPathInfo
c_func
(paren
r_const
r_int
id|xid
comma
r_struct
id|cifsTconInfo
op_star
id|tcon
comma
r_const
r_int
r_char
op_star
id|searchName
comma
id|FILE_UNIX_BASIC_INFO
op_star
id|pFindData
comma
r_const
r_struct
id|nls_table
op_star
id|nls_codepage
)paren
(brace
multiline_comment|/* SMB_QUERY_FILE_UNIX_BASIC */
id|TRANSACTION2_QPI_REQ
op_star
id|pSMB
op_assign
l_int|NULL
suffix:semicolon
id|TRANSACTION2_QPI_RSP
op_star
id|pSMBr
op_assign
l_int|NULL
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|bytes_returned
suffix:semicolon
r_int
id|name_len
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;In QPathInfo (Unix) the path %s&quot;
comma
id|searchName
)paren
)paren
suffix:semicolon
id|rc
op_assign
id|smb_init
c_func
(paren
id|SMB_COM_TRANSACTION2
comma
l_int|15
comma
id|tcon
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMB
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMBr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|pSMB-&gt;hdr.Flags2
op_amp
id|SMBFLG2_UNICODE
)paren
(brace
id|name_len
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|pSMB-&gt;FileName
comma
id|searchName
comma
l_int|530
multiline_comment|/* find define for this maxpathcomponent */
comma
id|nls_codepage
)paren
suffix:semicolon
id|name_len
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|name_len
op_mul_assign
l_int|2
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* BB improve the check for buffer overruns BB */
id|name_len
op_assign
id|strnlen
c_func
(paren
id|searchName
comma
l_int|530
)paren
suffix:semicolon
id|name_len
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|strncpy
c_func
(paren
id|pSMB-&gt;FileName
comma
id|searchName
comma
id|name_len
)paren
suffix:semicolon
)brace
id|pSMB-&gt;TotalParameterCount
op_assign
l_int|2
multiline_comment|/* level */
op_plus
l_int|4
multiline_comment|/* reserved */
op_plus
id|name_len
multiline_comment|/* includes null */
suffix:semicolon
id|pSMB-&gt;TotalDataCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;MaxParameterCount
op_assign
id|cpu_to_le16
c_func
(paren
l_int|2
)paren
suffix:semicolon
multiline_comment|/* BB find exact max SMB PDU from sess structure BB */
id|pSMB-&gt;MaxDataCount
op_assign
id|cpu_to_le16
c_func
(paren
l_int|4000
)paren
suffix:semicolon
id|pSMB-&gt;MaxSetupCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Flags
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Timeout
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved2
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;ParameterOffset
op_assign
id|cpu_to_le16
c_func
(paren
m_offsetof
(paren
r_struct
id|smb_com_transaction2_qpi_req
comma
id|InformationLevel
)paren
op_minus
l_int|4
)paren
suffix:semicolon
id|pSMB-&gt;DataCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;DataOffset
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;SetupCount
op_assign
l_int|1
suffix:semicolon
id|pSMB-&gt;Reserved3
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;SubCommand
op_assign
id|cpu_to_le16
c_func
(paren
id|TRANS2_QUERY_PATH_INFORMATION
)paren
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
id|pSMB-&gt;TotalParameterCount
op_plus
l_int|1
multiline_comment|/* pad */
suffix:semicolon
id|pSMB-&gt;TotalParameterCount
op_assign
id|cpu_to_le16
c_func
(paren
id|pSMB-&gt;TotalParameterCount
)paren
suffix:semicolon
id|pSMB-&gt;ParameterCount
op_assign
id|pSMB-&gt;TotalParameterCount
suffix:semicolon
id|pSMB-&gt;InformationLevel
op_assign
id|cpu_to_le16
c_func
(paren
id|SMB_QUERY_FILE_UNIX_BASIC
)paren
suffix:semicolon
id|pSMB-&gt;Reserved4
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;hdr.smb_buf_length
op_add_assign
id|pSMB-&gt;ByteCount
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
id|cpu_to_le16
c_func
(paren
id|pSMB-&gt;ByteCount
)paren
suffix:semicolon
id|rc
op_assign
id|SendReceive
c_func
(paren
id|xid
comma
id|tcon-&gt;ses
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMB
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMBr
comma
op_amp
id|bytes_returned
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Send error in QPathInfo = %d&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* decode response */
id|pSMBr-&gt;DataOffset
op_assign
id|le16_to_cpu
c_func
(paren
id|pSMBr-&gt;DataOffset
)paren
suffix:semicolon
multiline_comment|/* BB also check if enough total bytes returned */
r_if
c_cond
(paren
(paren
id|pSMBr-&gt;ByteCount
OL
l_int|40
)paren
op_logical_or
(paren
id|pSMBr-&gt;DataOffset
OG
l_int|512
)paren
)paren
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
multiline_comment|/* bad smb */
r_else
(brace
id|memcpy
c_func
(paren
(paren
r_char
op_star
)paren
id|pFindData
comma
(paren
r_char
op_star
)paren
op_amp
id|pSMBr-&gt;hdr.Protocol
op_plus
id|pSMBr-&gt;DataOffset
comma
r_sizeof
(paren
id|FILE_UNIX_BASIC_INFO
)paren
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|pSMB
)paren
id|buf_release
c_func
(paren
id|pSMB
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_int
DECL|function|CIFSFindSingle
id|CIFSFindSingle
c_func
(paren
r_const
r_int
id|xid
comma
r_struct
id|cifsTconInfo
op_star
id|tcon
comma
r_const
r_char
op_star
id|searchName
comma
id|FILE_ALL_INFO
op_star
id|findData
comma
r_const
r_struct
id|nls_table
op_star
id|nls_codepage
)paren
(brace
multiline_comment|/* level 257 SMB_ */
id|TRANSACTION2_FFIRST_REQ
op_star
id|pSMB
op_assign
l_int|NULL
suffix:semicolon
id|TRANSACTION2_FFIRST_RSP
op_star
id|pSMBr
op_assign
l_int|NULL
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|bytes_returned
suffix:semicolon
r_int
id|name_len
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;In FindUnique&quot;
)paren
)paren
suffix:semicolon
id|rc
op_assign
id|smb_init
c_func
(paren
id|SMB_COM_TRANSACTION2
comma
l_int|15
comma
id|tcon
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMB
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMBr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|pSMB-&gt;hdr.Flags2
op_amp
id|SMBFLG2_UNICODE
)paren
(brace
id|name_len
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|pSMB-&gt;FileName
comma
id|searchName
comma
l_int|530
multiline_comment|/* find define for this maxpathcomponent */
comma
id|nls_codepage
)paren
suffix:semicolon
id|name_len
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|name_len
op_mul_assign
l_int|2
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* BB improve the check for buffer overruns BB */
id|name_len
op_assign
id|strnlen
c_func
(paren
id|searchName
comma
l_int|530
)paren
suffix:semicolon
id|name_len
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|strncpy
c_func
(paren
id|pSMB-&gt;FileName
comma
id|searchName
comma
id|name_len
)paren
suffix:semicolon
)brace
id|pSMB-&gt;TotalParameterCount
op_assign
l_int|12
op_plus
id|name_len
multiline_comment|/* includes null */
suffix:semicolon
id|pSMB-&gt;TotalDataCount
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* no EAs */
id|pSMB-&gt;MaxParameterCount
op_assign
id|cpu_to_le16
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|pSMB-&gt;MaxDataCount
op_assign
id|cpu_to_le16
c_func
(paren
l_int|4000
)paren
suffix:semicolon
multiline_comment|/* BB find exact max SMB PDU from sess structure BB */
id|pSMB-&gt;MaxSetupCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Flags
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Timeout
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved2
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;ParameterOffset
op_assign
id|cpu_to_le16
c_func
(paren
m_offsetof
(paren
r_struct
id|smb_com_transaction2_ffirst_req
comma
id|InformationLevel
)paren
op_minus
l_int|4
)paren
suffix:semicolon
id|pSMB-&gt;DataCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;DataOffset
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;SetupCount
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* one byte, no need to le convert */
id|pSMB-&gt;Reserved3
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;SubCommand
op_assign
id|cpu_to_le16
c_func
(paren
id|TRANS2_FIND_FIRST
)paren
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
id|pSMB-&gt;TotalParameterCount
op_plus
l_int|1
multiline_comment|/* pad */
suffix:semicolon
id|pSMB-&gt;TotalParameterCount
op_assign
id|cpu_to_le16
c_func
(paren
id|pSMB-&gt;TotalDataCount
)paren
suffix:semicolon
id|pSMB-&gt;ParameterCount
op_assign
id|pSMB-&gt;TotalParameterCount
suffix:semicolon
id|pSMB-&gt;SearchAttributes
op_assign
id|cpu_to_le16
c_func
(paren
id|ATTR_READONLY
op_or
id|ATTR_HIDDEN
op_or
id|ATTR_SYSTEM
op_or
id|ATTR_DIRECTORY
)paren
suffix:semicolon
id|pSMB-&gt;SearchCount
op_assign
id|cpu_to_le16
c_func
(paren
l_int|16
)paren
suffix:semicolon
multiline_comment|/* BB increase */
id|pSMB-&gt;SearchFlags
op_assign
id|cpu_to_le16
c_func
(paren
l_int|1
)paren
suffix:semicolon
id|pSMB-&gt;InformationLevel
op_assign
id|cpu_to_le16
c_func
(paren
id|SMB_FIND_FILE_DIRECTORY_INFO
)paren
suffix:semicolon
id|pSMB-&gt;SearchStorageType
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* BB what should we set this to? BB */
id|pSMB-&gt;hdr.smb_buf_length
op_add_assign
id|pSMB-&gt;ByteCount
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
id|cpu_to_le16
c_func
(paren
id|pSMB-&gt;ByteCount
)paren
suffix:semicolon
id|rc
op_assign
id|SendReceive
c_func
(paren
id|xid
comma
id|tcon-&gt;ses
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMB
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMBr
comma
op_amp
id|bytes_returned
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Send error in FindFileDirInfo = %d&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* decode response */
multiline_comment|/* BB fill in */
)brace
r_if
c_cond
(paren
id|pSMB
)paren
id|buf_release
c_func
(paren
id|pSMB
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_int
DECL|function|CIFSFindFirst
id|CIFSFindFirst
c_func
(paren
r_const
r_int
id|xid
comma
r_struct
id|cifsTconInfo
op_star
id|tcon
comma
r_const
r_char
op_star
id|searchName
comma
id|FILE_DIRECTORY_INFO
op_star
id|findData
comma
id|T2_FFIRST_RSP_PARMS
op_star
id|findParms
comma
r_const
r_struct
id|nls_table
op_star
id|nls_codepage
comma
r_int
op_star
id|pUnicodeFlag
comma
r_int
op_star
id|pUnixFlag
)paren
(brace
multiline_comment|/* level 257 SMB_ */
id|TRANSACTION2_FFIRST_REQ
op_star
id|pSMB
op_assign
l_int|NULL
suffix:semicolon
id|TRANSACTION2_FFIRST_RSP
op_star
id|pSMBr
op_assign
l_int|NULL
suffix:semicolon
r_char
op_star
id|response_data
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|bytes_returned
suffix:semicolon
r_int
id|name_len
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;In FindFirst&quot;
)paren
)paren
suffix:semicolon
id|rc
op_assign
id|smb_init
c_func
(paren
id|SMB_COM_TRANSACTION2
comma
l_int|15
comma
id|tcon
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMB
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMBr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|pSMB-&gt;hdr.Flags2
op_amp
id|SMBFLG2_UNICODE
)paren
(brace
id|name_len
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|pSMB-&gt;FileName
comma
id|searchName
comma
l_int|530
multiline_comment|/* find define for this maxpathcomponent */
comma
id|nls_codepage
)paren
suffix:semicolon
id|name_len
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|name_len
op_mul_assign
l_int|2
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* BB improve the check for buffer overruns BB */
id|name_len
op_assign
id|strnlen
c_func
(paren
id|searchName
comma
l_int|530
)paren
suffix:semicolon
id|name_len
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|strncpy
c_func
(paren
id|pSMB-&gt;FileName
comma
id|searchName
comma
id|name_len
)paren
suffix:semicolon
)brace
id|pSMB-&gt;TotalParameterCount
op_assign
l_int|12
op_plus
id|name_len
multiline_comment|/* includes null */
suffix:semicolon
id|pSMB-&gt;TotalDataCount
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* no EAs */
id|pSMB-&gt;MaxParameterCount
op_assign
id|cpu_to_le16
c_func
(paren
l_int|10
)paren
suffix:semicolon
id|pSMB-&gt;MaxDataCount
op_assign
id|cpu_to_le16
c_func
(paren
(paren
id|tcon-&gt;ses-&gt;server-&gt;maxBuf
op_minus
id|MAX_CIFS_HDR_SIZE
)paren
op_amp
l_int|0xFFFFFF00
)paren
suffix:semicolon
id|pSMB-&gt;MaxSetupCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Flags
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Timeout
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved2
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
id|pSMB-&gt;TotalParameterCount
op_plus
l_int|1
multiline_comment|/* pad */
suffix:semicolon
id|pSMB-&gt;TotalParameterCount
op_assign
id|cpu_to_le16
c_func
(paren
id|pSMB-&gt;TotalParameterCount
)paren
suffix:semicolon
id|pSMB-&gt;ParameterCount
op_assign
id|pSMB-&gt;TotalParameterCount
suffix:semicolon
id|pSMB-&gt;ParameterOffset
op_assign
id|cpu_to_le16
c_func
(paren
m_offsetof
(paren
r_struct
id|smb_com_transaction2_ffirst_req
comma
id|SearchAttributes
)paren
op_minus
l_int|4
)paren
suffix:semicolon
id|pSMB-&gt;DataCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;DataOffset
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;SetupCount
op_assign
l_int|1
suffix:semicolon
multiline_comment|/* one byte no need to make endian neutral */
id|pSMB-&gt;Reserved3
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;SubCommand
op_assign
id|cpu_to_le16
c_func
(paren
id|TRANS2_FIND_FIRST
)paren
suffix:semicolon
id|pSMB-&gt;SearchAttributes
op_assign
id|cpu_to_le16
c_func
(paren
id|ATTR_READONLY
op_or
id|ATTR_HIDDEN
op_or
id|ATTR_SYSTEM
op_or
id|ATTR_DIRECTORY
)paren
suffix:semicolon
id|pSMB-&gt;SearchCount
op_assign
id|cpu_to_le16
c_func
(paren
id|CIFS_MAX_MSGSIZE
op_div
r_sizeof
(paren
id|FILE_DIRECTORY_INFO
)paren
)paren
suffix:semicolon
multiline_comment|/* should this be shrunk even more ? */
id|pSMB-&gt;SearchFlags
op_assign
id|cpu_to_le16
c_func
(paren
id|CIFS_SEARCH_CLOSE_AT_END
op_or
id|CIFS_SEARCH_RETURN_RESUME
)paren
suffix:semicolon
multiline_comment|/* test for Unix extensions */
r_if
c_cond
(paren
id|tcon-&gt;ses-&gt;capabilities
op_amp
id|CAP_UNIX
)paren
(brace
id|pSMB-&gt;InformationLevel
op_assign
id|cpu_to_le16
c_func
(paren
id|SMB_FIND_FILE_UNIX
)paren
suffix:semicolon
op_star
id|pUnixFlag
op_assign
id|TRUE
suffix:semicolon
)brace
r_else
(brace
id|pSMB-&gt;InformationLevel
op_assign
id|cpu_to_le16
c_func
(paren
id|SMB_FIND_FILE_DIRECTORY_INFO
)paren
suffix:semicolon
op_star
id|pUnixFlag
op_assign
id|FALSE
suffix:semicolon
)brace
id|pSMB-&gt;SearchStorageType
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* BB what should we set this to? It is not clear if it matters BB */
id|pSMB-&gt;hdr.smb_buf_length
op_add_assign
id|pSMB-&gt;ByteCount
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
id|cpu_to_le16
c_func
(paren
id|pSMB-&gt;ByteCount
)paren
suffix:semicolon
id|rc
op_assign
id|SendReceive
c_func
(paren
id|xid
comma
id|tcon-&gt;ses
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMB
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMBr
comma
op_amp
id|bytes_returned
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
multiline_comment|/* BB add logic to retry regular search if Unix search rejected unexpectedly by server */
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Error in FindFirst = %d&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* decode response */
multiline_comment|/* BB add safety checks for these memcpys */
r_if
c_cond
(paren
id|pSMBr-&gt;hdr.Flags2
op_amp
id|SMBFLG2_UNICODE
)paren
op_star
id|pUnicodeFlag
op_assign
id|TRUE
suffix:semicolon
r_else
op_star
id|pUnicodeFlag
op_assign
id|FALSE
suffix:semicolon
id|memcpy
c_func
(paren
id|findParms
comma
(paren
r_char
op_star
)paren
op_amp
id|pSMBr-&gt;hdr.Protocol
op_plus
id|le16_to_cpu
c_func
(paren
id|pSMBr-&gt;ParameterOffset
)paren
comma
r_sizeof
(paren
id|T2_FFIRST_RSP_PARMS
)paren
)paren
suffix:semicolon
multiline_comment|/* search handle can stay LE and EAoffset not needed so not converted */
id|findParms-&gt;EndofSearch
op_assign
id|le16_to_cpu
c_func
(paren
id|findParms-&gt;EndofSearch
)paren
suffix:semicolon
id|findParms-&gt;LastNameOffset
op_assign
id|le16_to_cpu
c_func
(paren
id|findParms-&gt;LastNameOffset
)paren
suffix:semicolon
id|findParms-&gt;SearchCount
op_assign
id|le16_to_cpu
c_func
(paren
id|findParms-&gt;SearchCount
)paren
suffix:semicolon
id|response_data
op_assign
(paren
r_char
op_star
)paren
op_amp
id|pSMBr-&gt;hdr.Protocol
op_plus
id|le16_to_cpu
c_func
(paren
id|pSMBr-&gt;DataOffset
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|findData
comma
id|response_data
comma
id|le16_to_cpu
c_func
(paren
id|pSMBr-&gt;DataCount
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pSMB
)paren
id|buf_release
c_func
(paren
id|pSMB
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_int
DECL|function|CIFSFindNext
id|CIFSFindNext
c_func
(paren
r_const
r_int
id|xid
comma
r_struct
id|cifsTconInfo
op_star
id|tcon
comma
id|FILE_DIRECTORY_INFO
op_star
id|findData
comma
id|T2_FNEXT_RSP_PARMS
op_star
id|findParms
comma
r_const
id|__u16
id|searchHandle
comma
r_char
op_star
id|resume_file_name
comma
r_int
id|name_len
comma
id|__u32
id|resume_key
comma
r_int
op_star
id|pUnicodeFlag
comma
r_int
op_star
id|pUnixFlag
)paren
(brace
multiline_comment|/* level 257 SMB_ */
id|TRANSACTION2_FNEXT_REQ
op_star
id|pSMB
op_assign
l_int|NULL
suffix:semicolon
id|TRANSACTION2_FNEXT_RSP
op_star
id|pSMBr
op_assign
l_int|NULL
suffix:semicolon
r_char
op_star
id|response_data
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|bytes_returned
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;In FindNext&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|resume_file_name
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|EIO
suffix:semicolon
)brace
id|rc
op_assign
id|smb_init
c_func
(paren
id|SMB_COM_TRANSACTION2
comma
l_int|15
comma
id|tcon
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMB
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMBr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
id|pSMB-&gt;TotalParameterCount
op_assign
l_int|14
suffix:semicolon
multiline_comment|/* includes 2 bytes of null string, converted to LE below */
id|pSMB-&gt;TotalDataCount
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* no EAs */
id|pSMB-&gt;MaxParameterCount
op_assign
id|cpu_to_le16
c_func
(paren
l_int|8
)paren
suffix:semicolon
id|pSMB-&gt;MaxDataCount
op_assign
id|cpu_to_le16
c_func
(paren
(paren
id|tcon-&gt;ses-&gt;server-&gt;maxBuf
op_minus
id|MAX_CIFS_HDR_SIZE
)paren
op_amp
l_int|0xFFFFFF00
)paren
suffix:semicolon
id|pSMB-&gt;MaxSetupCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Flags
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Timeout
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved2
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;ParameterOffset
op_assign
id|cpu_to_le16
c_func
(paren
m_offsetof
(paren
r_struct
id|smb_com_transaction2_fnext_req
comma
id|SearchHandle
)paren
op_minus
l_int|4
)paren
suffix:semicolon
id|pSMB-&gt;DataCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;DataOffset
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;SetupCount
op_assign
l_int|1
suffix:semicolon
id|pSMB-&gt;Reserved3
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;SubCommand
op_assign
id|cpu_to_le16
c_func
(paren
id|TRANS2_FIND_NEXT
)paren
suffix:semicolon
id|pSMB-&gt;SearchHandle
op_assign
id|searchHandle
suffix:semicolon
multiline_comment|/* always kept as le */
id|findParms-&gt;SearchCount
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* set to zero in case of error */
id|pSMB-&gt;SearchCount
op_assign
id|cpu_to_le16
c_func
(paren
id|CIFS_MAX_MSGSIZE
op_div
r_sizeof
(paren
id|FILE_DIRECTORY_INFO
)paren
)paren
suffix:semicolon
multiline_comment|/* test for Unix extensions */
r_if
c_cond
(paren
id|tcon-&gt;ses-&gt;capabilities
op_amp
id|CAP_UNIX
)paren
(brace
id|pSMB-&gt;InformationLevel
op_assign
id|cpu_to_le16
c_func
(paren
id|SMB_FIND_FILE_UNIX
)paren
suffix:semicolon
op_star
id|pUnixFlag
op_assign
id|TRUE
suffix:semicolon
)brace
r_else
(brace
id|pSMB-&gt;InformationLevel
op_assign
id|cpu_to_le16
c_func
(paren
id|SMB_FIND_FILE_DIRECTORY_INFO
)paren
suffix:semicolon
op_star
id|pUnixFlag
op_assign
id|FALSE
suffix:semicolon
)brace
id|pSMB-&gt;ResumeKey
op_assign
id|resume_key
suffix:semicolon
id|pSMB-&gt;SearchFlags
op_assign
id|cpu_to_le16
c_func
(paren
id|CIFS_SEARCH_CLOSE_AT_END
op_or
id|CIFS_SEARCH_RETURN_RESUME
)paren
suffix:semicolon
multiline_comment|/* BB add check to make sure we do not cross end of smb */
r_if
c_cond
(paren
id|name_len
OL
id|CIFS_MAX_MSGSIZE
)paren
(brace
id|memcpy
c_func
(paren
id|pSMB-&gt;ResumeFileName
comma
id|resume_file_name
comma
id|name_len
)paren
suffix:semicolon
id|pSMB-&gt;ByteCount
op_add_assign
id|name_len
suffix:semicolon
)brace
id|pSMB-&gt;TotalParameterCount
op_add_assign
id|name_len
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
id|pSMB-&gt;TotalParameterCount
op_plus
l_int|1
multiline_comment|/* pad */
suffix:semicolon
id|pSMB-&gt;TotalParameterCount
op_assign
id|cpu_to_le16
c_func
(paren
id|pSMB-&gt;TotalParameterCount
)paren
suffix:semicolon
id|pSMB-&gt;ParameterCount
op_assign
id|pSMB-&gt;TotalParameterCount
suffix:semicolon
multiline_comment|/* BB improve error handling here */
id|pSMB-&gt;hdr.smb_buf_length
op_add_assign
id|pSMB-&gt;ByteCount
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
id|cpu_to_le16
c_func
(paren
id|pSMB-&gt;ByteCount
)paren
suffix:semicolon
id|rc
op_assign
id|SendReceive
c_func
(paren
id|xid
comma
id|tcon-&gt;ses
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMB
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMBr
comma
op_amp
id|bytes_returned
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
r_if
c_cond
(paren
id|rc
op_eq
op_minus
id|EBADF
)paren
id|rc
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* search probably was closed at end of search above */
r_else
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;FindNext returned = %d&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* decode response */
multiline_comment|/* BB add safety checks for these memcpys */
r_if
c_cond
(paren
id|pSMBr-&gt;hdr.Flags2
op_amp
id|SMBFLG2_UNICODE
)paren
op_star
id|pUnicodeFlag
op_assign
id|TRUE
suffix:semicolon
r_else
op_star
id|pUnicodeFlag
op_assign
id|FALSE
suffix:semicolon
id|memcpy
c_func
(paren
id|findParms
comma
(paren
r_char
op_star
)paren
op_amp
id|pSMBr-&gt;hdr.Protocol
op_plus
id|le16_to_cpu
c_func
(paren
id|pSMBr-&gt;ParameterOffset
)paren
comma
r_sizeof
(paren
id|T2_FNEXT_RSP_PARMS
)paren
)paren
suffix:semicolon
id|findParms-&gt;EndofSearch
op_assign
id|le16_to_cpu
c_func
(paren
id|findParms-&gt;EndofSearch
)paren
suffix:semicolon
id|findParms-&gt;LastNameOffset
op_assign
id|le16_to_cpu
c_func
(paren
id|findParms-&gt;LastNameOffset
)paren
suffix:semicolon
id|findParms-&gt;SearchCount
op_assign
id|le16_to_cpu
c_func
(paren
id|findParms-&gt;SearchCount
)paren
suffix:semicolon
id|response_data
op_assign
(paren
r_char
op_star
)paren
op_amp
id|pSMBr-&gt;hdr.Protocol
op_plus
id|le16_to_cpu
c_func
(paren
id|pSMBr-&gt;DataOffset
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|findData
comma
id|response_data
comma
id|le16_to_cpu
c_func
(paren
id|pSMBr-&gt;DataCount
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pSMB
)paren
id|buf_release
c_func
(paren
id|pSMB
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_int
DECL|function|CIFSFindClose
id|CIFSFindClose
c_func
(paren
r_const
r_int
id|xid
comma
r_struct
id|cifsTconInfo
op_star
id|tcon
comma
r_const
id|__u16
id|searchHandle
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|FINDCLOSE_REQ
op_star
id|pSMB
op_assign
l_int|NULL
suffix:semicolon
id|CLOSE_RSP
op_star
id|pSMBr
op_assign
l_int|NULL
suffix:semicolon
r_int
id|bytes_returned
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;In CIFSSMBFindClose&quot;
)paren
)paren
suffix:semicolon
id|rc
op_assign
id|smb_init
c_func
(paren
id|SMB_COM_FIND_CLOSE2
comma
l_int|1
comma
id|tcon
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMB
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMBr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
id|pSMB-&gt;FileID
op_assign
id|searchHandle
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
l_int|0
suffix:semicolon
id|rc
op_assign
id|SendReceive
c_func
(paren
id|xid
comma
id|tcon-&gt;ses
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMB
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMBr
comma
op_amp
id|bytes_returned
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|cERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Send error in FindClose = %d&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pSMB
)paren
id|buf_release
c_func
(paren
id|pSMB
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_int
DECL|function|CIFSGetDFSRefer
id|CIFSGetDFSRefer
c_func
(paren
r_const
r_int
id|xid
comma
r_struct
id|cifsSesInfo
op_star
id|ses
comma
r_const
r_int
r_char
op_star
id|searchName
comma
r_int
r_char
op_star
op_star
id|targetUNCs
comma
r_int
op_star
id|number_of_UNC_in_array
comma
r_const
r_struct
id|nls_table
op_star
id|nls_codepage
)paren
(brace
multiline_comment|/* TRANS2_GET_DFS_REFERRAL */
id|TRANSACTION2_GET_DFS_REFER_REQ
op_star
id|pSMB
op_assign
l_int|NULL
suffix:semicolon
id|TRANSACTION2_GET_DFS_REFER_RSP
op_star
id|pSMBr
op_assign
l_int|NULL
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|bytes_returned
suffix:semicolon
r_int
id|name_len
suffix:semicolon
op_star
id|number_of_UNC_in_array
op_assign
l_int|0
suffix:semicolon
op_star
id|targetUNCs
op_assign
l_int|NULL
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;In GetDFSRefer the path %s&quot;
comma
id|searchName
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ses
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENODEV
suffix:semicolon
id|rc
op_assign
id|smb_init
c_func
(paren
id|SMB_COM_TRANSACTION2
comma
l_int|15
comma
l_int|0
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMB
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMBr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
id|pSMB-&gt;hdr.Tid
op_assign
id|ses-&gt;ipc_tid
suffix:semicolon
id|pSMB-&gt;hdr.Uid
op_assign
id|ses-&gt;Suid
suffix:semicolon
r_if
c_cond
(paren
id|ses-&gt;capabilities
op_amp
id|CAP_STATUS32
)paren
(brace
id|pSMB-&gt;hdr.Flags2
op_or_assign
id|SMBFLG2_ERR_STATUS
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ses-&gt;capabilities
op_amp
id|CAP_DFS
)paren
(brace
id|pSMB-&gt;hdr.Flags2
op_or_assign
id|SMBFLG2_DFS
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ses-&gt;server-&gt;secMode
op_amp
(paren
id|SECMODE_SIGN_REQUIRED
op_or
id|SECMODE_SIGN_ENABLED
)paren
)paren
(brace
id|pSMB-&gt;hdr.Flags2
op_or_assign
id|SMBFLG2_SECURITY_SIGNATURE
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ses-&gt;capabilities
op_amp
id|CAP_UNICODE
)paren
(brace
id|pSMB-&gt;hdr.Flags2
op_or_assign
id|SMBFLG2_UNICODE
suffix:semicolon
id|name_len
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|pSMB-&gt;RequestFileName
comma
id|searchName
comma
l_int|530
multiline_comment|/* find define for this maxpathcomponent */
comma
id|nls_codepage
)paren
suffix:semicolon
id|name_len
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|name_len
op_mul_assign
l_int|2
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* BB improve the check for buffer overruns BB */
id|name_len
op_assign
id|strnlen
c_func
(paren
id|searchName
comma
l_int|530
)paren
suffix:semicolon
id|name_len
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|strncpy
c_func
(paren
id|pSMB-&gt;RequestFileName
comma
id|searchName
comma
id|name_len
)paren
suffix:semicolon
)brace
id|pSMB-&gt;ParameterCount
op_assign
l_int|2
multiline_comment|/* level */
op_plus
id|name_len
multiline_comment|/*includes null */
suffix:semicolon
id|pSMB-&gt;TotalDataCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;DataCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;DataOffset
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;MaxParameterCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;MaxDataCount
op_assign
id|cpu_to_le16
c_func
(paren
l_int|4000
)paren
suffix:semicolon
multiline_comment|/* BB find exact max SMB PDU from sess structure BB */
id|pSMB-&gt;MaxSetupCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Flags
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Timeout
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved2
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;ParameterOffset
op_assign
id|cpu_to_le16
c_func
(paren
m_offsetof
(paren
r_struct
id|smb_com_transaction2_get_dfs_refer_req
comma
id|MaxReferralLevel
)paren
op_minus
l_int|4
)paren
suffix:semicolon
id|pSMB-&gt;SetupCount
op_assign
l_int|1
suffix:semicolon
id|pSMB-&gt;Reserved3
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;SubCommand
op_assign
id|cpu_to_le16
c_func
(paren
id|TRANS2_GET_DFS_REFERRAL
)paren
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
id|pSMB-&gt;ParameterCount
op_plus
l_int|3
multiline_comment|/* pad */
suffix:semicolon
id|pSMB-&gt;ParameterCount
op_assign
id|cpu_to_le16
c_func
(paren
id|pSMB-&gt;ParameterCount
)paren
suffix:semicolon
id|pSMB-&gt;TotalParameterCount
op_assign
id|pSMB-&gt;ParameterCount
suffix:semicolon
id|pSMB-&gt;MaxReferralLevel
op_assign
id|cpu_to_le16
c_func
(paren
l_int|3
)paren
suffix:semicolon
id|pSMB-&gt;hdr.smb_buf_length
op_add_assign
id|pSMB-&gt;ByteCount
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
id|cpu_to_le16
c_func
(paren
id|pSMB-&gt;ByteCount
)paren
suffix:semicolon
id|rc
op_assign
id|SendReceive
c_func
(paren
id|xid
comma
id|ses
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMB
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMBr
comma
op_amp
id|bytes_returned
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Send error in GetDFSRefer = %d&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* decode response */
multiline_comment|/* BB Add logic to parse referrals here */
)brace
r_if
c_cond
(paren
id|pSMB
)paren
id|buf_release
c_func
(paren
id|pSMB
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_int
DECL|function|CIFSSMBQFSInfo
id|CIFSSMBQFSInfo
c_func
(paren
r_const
r_int
id|xid
comma
r_struct
id|cifsTconInfo
op_star
id|tcon
comma
r_struct
id|statfs
op_star
id|FSData
comma
r_const
r_struct
id|nls_table
op_star
id|nls_codepage
)paren
(brace
multiline_comment|/* level 0x103 SMB_QUERY_FILE_SYSTEM_INFO */
id|TRANSACTION2_QFSI_REQ
op_star
id|pSMB
op_assign
l_int|NULL
suffix:semicolon
id|TRANSACTION2_QFSI_RSP
op_star
id|pSMBr
op_assign
l_int|NULL
suffix:semicolon
id|FILE_SYSTEM_INFO
op_star
id|response_data
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|bytes_returned
op_assign
l_int|0
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;In QFSInfo&quot;
)paren
)paren
suffix:semicolon
id|rc
op_assign
id|smb_init
c_func
(paren
id|SMB_COM_TRANSACTION2
comma
l_int|15
comma
id|tcon
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMB
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMBr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
id|pSMB-&gt;TotalParameterCount
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* level */
id|pSMB-&gt;TotalDataCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;MaxParameterCount
op_assign
id|cpu_to_le16
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|pSMB-&gt;MaxDataCount
op_assign
id|cpu_to_le16
c_func
(paren
l_int|1000
)paren
suffix:semicolon
multiline_comment|/* BB find exact max SMB PDU from sess structure BB */
id|pSMB-&gt;MaxSetupCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Flags
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Timeout
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved2
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
id|pSMB-&gt;TotalParameterCount
op_plus
l_int|1
multiline_comment|/* pad */
suffix:semicolon
id|pSMB-&gt;TotalParameterCount
op_assign
id|cpu_to_le16
c_func
(paren
id|pSMB-&gt;TotalParameterCount
)paren
suffix:semicolon
id|pSMB-&gt;ParameterCount
op_assign
id|pSMB-&gt;TotalParameterCount
suffix:semicolon
id|pSMB-&gt;ParameterOffset
op_assign
id|cpu_to_le16
c_func
(paren
m_offsetof
(paren
r_struct
id|smb_com_transaction2_qfsi_req
comma
id|InformationLevel
)paren
op_minus
l_int|4
)paren
suffix:semicolon
id|pSMB-&gt;DataCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;DataOffset
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;SetupCount
op_assign
l_int|1
suffix:semicolon
id|pSMB-&gt;Reserved3
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;SubCommand
op_assign
id|cpu_to_le16
c_func
(paren
id|TRANS2_QUERY_FS_INFORMATION
)paren
suffix:semicolon
id|pSMB-&gt;InformationLevel
op_assign
id|cpu_to_le16
c_func
(paren
id|SMB_QUERY_FS_SIZE_INFO
)paren
suffix:semicolon
id|pSMB-&gt;hdr.smb_buf_length
op_add_assign
id|pSMB-&gt;ByteCount
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
id|cpu_to_le16
c_func
(paren
id|pSMB-&gt;ByteCount
)paren
suffix:semicolon
id|rc
op_assign
id|SendReceive
c_func
(paren
id|xid
comma
id|tcon-&gt;ses
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMB
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMBr
comma
op_amp
id|bytes_returned
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|cERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Send error in QFSInfo = %d&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* decode response */
id|pSMBr-&gt;DataOffset
op_assign
id|le16_to_cpu
c_func
(paren
id|pSMBr-&gt;DataOffset
)paren
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Decoding qfsinfo response.  BCC: %d  Offset %d&quot;
comma
id|pSMBr-&gt;ByteCount
comma
id|pSMBr-&gt;DataOffset
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pSMBr-&gt;ByteCount
OL
l_int|24
)paren
op_logical_or
(paren
id|pSMBr-&gt;DataOffset
OG
l_int|512
)paren
)paren
multiline_comment|/* BB also check enough total bytes returned */
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
multiline_comment|/* bad smb */
r_else
(brace
id|response_data
op_assign
(paren
id|FILE_SYSTEM_INFO
op_star
)paren
(paren
(paren
(paren
r_char
op_star
)paren
op_amp
id|pSMBr-&gt;hdr.Protocol
)paren
op_plus
id|pSMBr-&gt;DataOffset
)paren
suffix:semicolon
id|FSData-&gt;f_bsize
op_assign
id|le32_to_cpu
c_func
(paren
id|response_data-&gt;BytesPerSector
)paren
op_star
id|le32_to_cpu
c_func
(paren
id|response_data
op_member_access_from_pointer
id|SectorsPerAllocationUnit
)paren
suffix:semicolon
id|FSData-&gt;f_blocks
op_assign
id|le64_to_cpu
c_func
(paren
id|response_data-&gt;TotalAllocationUnits
)paren
suffix:semicolon
id|FSData-&gt;f_bfree
op_assign
id|FSData-&gt;f_bavail
op_assign
id|le64_to_cpu
c_func
(paren
id|response_data-&gt;FreeAllocationUnits
)paren
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Blocks: %ld  Free: %ld Block size %ld&quot;
comma
id|FSData-&gt;f_blocks
comma
id|FSData-&gt;f_bfree
comma
id|FSData-&gt;f_bsize
)paren
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|pSMB
)paren
id|buf_release
c_func
(paren
id|pSMB
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_int
DECL|function|CIFSSMBQFSAttributeInfo
id|CIFSSMBQFSAttributeInfo
c_func
(paren
r_int
id|xid
comma
r_struct
id|cifsTconInfo
op_star
id|tcon
comma
r_const
r_struct
id|nls_table
op_star
id|nls_codepage
)paren
(brace
multiline_comment|/* level 0x105  SMB_QUERY_FILE_SYSTEM_INFO */
id|TRANSACTION2_QFSI_REQ
op_star
id|pSMB
op_assign
l_int|NULL
suffix:semicolon
id|TRANSACTION2_QFSI_RSP
op_star
id|pSMBr
op_assign
l_int|NULL
suffix:semicolon
id|FILE_SYSTEM_ATTRIBUTE_INFO
op_star
id|response_data
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|bytes_returned
op_assign
l_int|0
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;In QFSAttributeInfo&quot;
)paren
)paren
suffix:semicolon
id|rc
op_assign
id|smb_init
c_func
(paren
id|SMB_COM_TRANSACTION2
comma
l_int|15
comma
id|tcon
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMB
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMBr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
id|pSMB-&gt;TotalParameterCount
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* level */
id|pSMB-&gt;TotalDataCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;MaxParameterCount
op_assign
id|cpu_to_le16
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|pSMB-&gt;MaxDataCount
op_assign
id|cpu_to_le16
c_func
(paren
l_int|1000
)paren
suffix:semicolon
multiline_comment|/* BB find exact max SMB PDU from sess structure BB */
id|pSMB-&gt;MaxSetupCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Flags
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Timeout
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved2
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
id|pSMB-&gt;TotalParameterCount
op_plus
l_int|1
multiline_comment|/* pad */
suffix:semicolon
id|pSMB-&gt;TotalParameterCount
op_assign
id|cpu_to_le16
c_func
(paren
id|pSMB-&gt;TotalParameterCount
)paren
suffix:semicolon
id|pSMB-&gt;ParameterCount
op_assign
id|pSMB-&gt;TotalParameterCount
suffix:semicolon
id|pSMB-&gt;ParameterOffset
op_assign
id|cpu_to_le16
c_func
(paren
m_offsetof
(paren
r_struct
id|smb_com_transaction2_qfsi_req
comma
id|InformationLevel
)paren
op_minus
l_int|4
)paren
suffix:semicolon
id|pSMB-&gt;DataCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;DataOffset
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;SetupCount
op_assign
l_int|1
suffix:semicolon
id|pSMB-&gt;Reserved3
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;SubCommand
op_assign
id|cpu_to_le16
c_func
(paren
id|TRANS2_QUERY_FS_INFORMATION
)paren
suffix:semicolon
id|pSMB-&gt;InformationLevel
op_assign
id|cpu_to_le16
c_func
(paren
id|SMB_QUERY_FS_ATTRIBUTE_INFO
)paren
suffix:semicolon
id|pSMB-&gt;hdr.smb_buf_length
op_add_assign
id|pSMB-&gt;ByteCount
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
id|cpu_to_le16
c_func
(paren
id|pSMB-&gt;ByteCount
)paren
suffix:semicolon
id|rc
op_assign
id|SendReceive
c_func
(paren
id|xid
comma
id|tcon-&gt;ses
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMB
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMBr
comma
op_amp
id|bytes_returned
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|cERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Send error in QFSAttributeInfo = %d&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* decode response */
id|pSMBr-&gt;DataOffset
op_assign
id|le16_to_cpu
c_func
(paren
id|pSMBr-&gt;DataOffset
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pSMBr-&gt;ByteCount
OL
l_int|13
)paren
op_logical_or
(paren
id|pSMBr-&gt;DataOffset
OG
l_int|512
)paren
)paren
(brace
multiline_comment|/* BB also check enough bytes returned */
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
multiline_comment|/* bad smb */
)brace
r_else
(brace
id|response_data
op_assign
(paren
id|FILE_SYSTEM_ATTRIBUTE_INFO
op_star
)paren
(paren
(paren
(paren
r_char
op_star
)paren
op_amp
id|pSMBr-&gt;hdr.Protocol
)paren
op_plus
id|pSMBr-&gt;DataOffset
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|tcon-&gt;fsAttrInfo
comma
id|response_data
comma
r_sizeof
(paren
id|FILE_SYSTEM_ATTRIBUTE_INFO
)paren
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|pSMB
)paren
id|buf_release
c_func
(paren
id|pSMB
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_int
DECL|function|CIFSSMBQFSDeviceInfo
id|CIFSSMBQFSDeviceInfo
c_func
(paren
r_int
id|xid
comma
r_struct
id|cifsTconInfo
op_star
id|tcon
comma
r_const
r_struct
id|nls_table
op_star
id|nls_codepage
)paren
(brace
multiline_comment|/* level 0x104 SMB_QUERY_FILE_SYSTEM_INFO */
id|TRANSACTION2_QFSI_REQ
op_star
id|pSMB
op_assign
l_int|NULL
suffix:semicolon
id|TRANSACTION2_QFSI_RSP
op_star
id|pSMBr
op_assign
l_int|NULL
suffix:semicolon
id|FILE_SYSTEM_DEVICE_INFO
op_star
id|response_data
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|bytes_returned
op_assign
l_int|0
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;In QFSDeviceInfo&quot;
)paren
)paren
suffix:semicolon
id|rc
op_assign
id|smb_init
c_func
(paren
id|SMB_COM_TRANSACTION2
comma
l_int|15
comma
id|tcon
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMB
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMBr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
id|pSMB-&gt;TotalParameterCount
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* level */
id|pSMB-&gt;TotalDataCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;MaxParameterCount
op_assign
id|cpu_to_le16
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|pSMB-&gt;MaxDataCount
op_assign
id|cpu_to_le16
c_func
(paren
l_int|1000
)paren
suffix:semicolon
multiline_comment|/* BB find exact max SMB PDU from sess structure BB */
id|pSMB-&gt;MaxSetupCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Flags
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Timeout
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved2
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
id|pSMB-&gt;TotalParameterCount
op_plus
l_int|1
multiline_comment|/* pad */
suffix:semicolon
id|pSMB-&gt;TotalParameterCount
op_assign
id|cpu_to_le16
c_func
(paren
id|pSMB-&gt;TotalParameterCount
)paren
suffix:semicolon
id|pSMB-&gt;ParameterCount
op_assign
id|pSMB-&gt;TotalParameterCount
suffix:semicolon
id|pSMB-&gt;ParameterOffset
op_assign
id|cpu_to_le16
c_func
(paren
m_offsetof
(paren
r_struct
id|smb_com_transaction2_qfsi_req
comma
id|InformationLevel
)paren
op_minus
l_int|4
)paren
suffix:semicolon
id|pSMB-&gt;DataCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;DataOffset
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;SetupCount
op_assign
l_int|1
suffix:semicolon
id|pSMB-&gt;Reserved3
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;SubCommand
op_assign
id|cpu_to_le16
c_func
(paren
id|TRANS2_QUERY_FS_INFORMATION
)paren
suffix:semicolon
id|pSMB-&gt;InformationLevel
op_assign
id|cpu_to_le16
c_func
(paren
id|SMB_QUERY_FS_DEVICE_INFO
)paren
suffix:semicolon
id|pSMB-&gt;hdr.smb_buf_length
op_add_assign
id|pSMB-&gt;ByteCount
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
id|cpu_to_le16
c_func
(paren
id|pSMB-&gt;ByteCount
)paren
suffix:semicolon
id|rc
op_assign
id|SendReceive
c_func
(paren
id|xid
comma
id|tcon-&gt;ses
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMB
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMBr
comma
op_amp
id|bytes_returned
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|cERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Send error in QFSDeviceInfo = %d&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* decode response */
id|pSMBr-&gt;DataOffset
op_assign
id|le16_to_cpu
c_func
(paren
id|pSMBr-&gt;DataOffset
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pSMBr-&gt;ByteCount
OL
r_sizeof
(paren
id|FILE_SYSTEM_DEVICE_INFO
)paren
)paren
op_logical_or
(paren
id|pSMBr-&gt;DataOffset
OG
l_int|512
)paren
)paren
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
multiline_comment|/* bad smb */
r_else
(brace
id|response_data
op_assign
(paren
id|FILE_SYSTEM_DEVICE_INFO
op_star
)paren
(paren
(paren
(paren
r_char
op_star
)paren
op_amp
id|pSMBr-&gt;hdr.Protocol
)paren
op_plus
id|pSMBr-&gt;DataOffset
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|tcon-&gt;fsDevInfo
comma
id|response_data
comma
r_sizeof
(paren
id|FILE_SYSTEM_DEVICE_INFO
)paren
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|pSMB
)paren
id|buf_release
c_func
(paren
id|pSMB
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_int
DECL|function|CIFSSMBQFSUnixInfo
id|CIFSSMBQFSUnixInfo
c_func
(paren
r_int
id|xid
comma
r_struct
id|cifsTconInfo
op_star
id|tcon
comma
r_const
r_struct
id|nls_table
op_star
id|nls_codepage
)paren
(brace
multiline_comment|/* level 0x200  SMB_QUERY_CIFS_UNIX_INFO */
id|TRANSACTION2_QFSI_REQ
op_star
id|pSMB
op_assign
l_int|NULL
suffix:semicolon
id|TRANSACTION2_QFSI_RSP
op_star
id|pSMBr
op_assign
l_int|NULL
suffix:semicolon
id|FILE_SYSTEM_UNIX_INFO
op_star
id|response_data
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|bytes_returned
op_assign
l_int|0
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;In QFSUnixInfo&quot;
)paren
)paren
suffix:semicolon
id|rc
op_assign
id|smb_init
c_func
(paren
id|SMB_COM_TRANSACTION2
comma
l_int|15
comma
id|tcon
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMB
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMBr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
id|pSMB-&gt;ParameterCount
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* level */
id|pSMB-&gt;TotalDataCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;DataCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;DataOffset
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;MaxParameterCount
op_assign
id|cpu_to_le16
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|pSMB-&gt;MaxDataCount
op_assign
id|cpu_to_le16
c_func
(paren
l_int|100
)paren
suffix:semicolon
multiline_comment|/* BB find exact max SMB PDU from sess structure BB */
id|pSMB-&gt;MaxSetupCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Flags
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Timeout
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved2
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
id|pSMB-&gt;ParameterCount
op_plus
l_int|1
multiline_comment|/* pad */
suffix:semicolon
id|pSMB-&gt;ParameterCount
op_assign
id|cpu_to_le16
c_func
(paren
id|pSMB-&gt;ParameterCount
)paren
suffix:semicolon
id|pSMB-&gt;TotalParameterCount
op_assign
id|pSMB-&gt;ParameterCount
suffix:semicolon
id|pSMB-&gt;ParameterOffset
op_assign
id|cpu_to_le16
c_func
(paren
m_offsetof
(paren
r_struct
id|smb_com_transaction2_qfsi_req
comma
id|InformationLevel
)paren
op_minus
l_int|4
)paren
suffix:semicolon
id|pSMB-&gt;SetupCount
op_assign
l_int|1
suffix:semicolon
id|pSMB-&gt;Reserved3
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;SubCommand
op_assign
id|cpu_to_le16
c_func
(paren
id|TRANS2_QUERY_FS_INFORMATION
)paren
suffix:semicolon
id|pSMB-&gt;InformationLevel
op_assign
id|cpu_to_le16
c_func
(paren
id|SMB_QUERY_CIFS_UNIX_INFO
)paren
suffix:semicolon
id|pSMB-&gt;hdr.smb_buf_length
op_add_assign
id|pSMB-&gt;ByteCount
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
id|cpu_to_le16
c_func
(paren
id|pSMB-&gt;ByteCount
)paren
suffix:semicolon
id|rc
op_assign
id|SendReceive
c_func
(paren
id|xid
comma
id|tcon-&gt;ses
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMB
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMBr
comma
op_amp
id|bytes_returned
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|cERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Send error in QFSUnixInfo = %d&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* decode response */
id|pSMBr-&gt;DataOffset
op_assign
id|cpu_to_le16
c_func
(paren
id|pSMBr-&gt;DataOffset
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pSMBr-&gt;ByteCount
OL
l_int|13
)paren
op_logical_or
(paren
id|pSMBr-&gt;DataOffset
OG
l_int|512
)paren
)paren
(brace
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
multiline_comment|/* bad smb */
)brace
r_else
(brace
id|response_data
op_assign
(paren
id|FILE_SYSTEM_UNIX_INFO
op_star
)paren
(paren
(paren
(paren
r_char
op_star
)paren
op_amp
id|pSMBr-&gt;hdr.Protocol
)paren
op_plus
id|pSMBr-&gt;DataOffset
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|tcon-&gt;fsUnixInfo
comma
id|response_data
comma
r_sizeof
(paren
id|FILE_SYSTEM_UNIX_INFO
)paren
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|pSMB
)paren
id|buf_release
c_func
(paren
id|pSMB
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/* We can not use write of zero bytes trick to &n;   set file size due to need for large file support.  Also note that &n;   this SetPathInfo is preferred to SetFileInfo based method in next &n;   routine which is only needed to work around a sharing violation bug&n;   in Samba which this routine can run into */
r_int
DECL|function|CIFSSMBSetEOF
id|CIFSSMBSetEOF
c_func
(paren
r_int
id|xid
comma
r_struct
id|cifsTconInfo
op_star
id|tcon
comma
r_char
op_star
id|fileName
comma
id|__u64
id|size
comma
r_int
id|SetAllocation
comma
r_const
r_struct
id|nls_table
op_star
id|nls_codepage
)paren
(brace
r_struct
id|smb_com_transaction2_spi_req
op_star
id|pSMB
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|smb_com_transaction2_spi_rsp
op_star
id|pSMBr
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|file_end_of_file_info
op_star
id|parm_data
suffix:semicolon
r_int
id|name_len
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|bytes_returned
op_assign
l_int|0
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;In SetEOF&quot;
)paren
)paren
suffix:semicolon
id|rc
op_assign
id|smb_init
c_func
(paren
id|SMB_COM_TRANSACTION2
comma
l_int|15
comma
id|tcon
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMB
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMBr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|pSMB-&gt;hdr.Flags2
op_amp
id|SMBFLG2_UNICODE
)paren
(brace
id|name_len
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|pSMB-&gt;FileName
comma
id|fileName
comma
l_int|530
multiline_comment|/* find define for this maxpathcomponent */
comma
id|nls_codepage
)paren
suffix:semicolon
id|name_len
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|name_len
op_mul_assign
l_int|2
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* BB improve the check for buffer overruns BB */
id|name_len
op_assign
id|strnlen
c_func
(paren
id|fileName
comma
l_int|530
)paren
suffix:semicolon
id|name_len
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|strncpy
c_func
(paren
id|pSMB-&gt;FileName
comma
id|fileName
comma
id|name_len
)paren
suffix:semicolon
)brace
id|pSMB-&gt;ParameterCount
op_assign
l_int|6
op_plus
id|name_len
suffix:semicolon
id|pSMB-&gt;DataCount
op_assign
r_sizeof
(paren
r_struct
id|file_end_of_file_info
)paren
suffix:semicolon
id|pSMB-&gt;MaxParameterCount
op_assign
id|cpu_to_le16
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|pSMB-&gt;MaxDataCount
op_assign
id|cpu_to_le16
c_func
(paren
l_int|1000
)paren
suffix:semicolon
multiline_comment|/* BB find max SMB size from sess */
id|pSMB-&gt;MaxSetupCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Flags
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Timeout
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved2
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;ParameterOffset
op_assign
m_offsetof
(paren
r_struct
id|smb_com_transaction2_spi_req
comma
id|InformationLevel
)paren
op_minus
l_int|4
suffix:semicolon
id|pSMB-&gt;DataOffset
op_assign
id|pSMB-&gt;ParameterOffset
op_plus
id|pSMB-&gt;ParameterCount
suffix:semicolon
r_if
c_cond
(paren
id|SetAllocation
)paren
(brace
r_if
c_cond
(paren
id|tcon-&gt;ses-&gt;capabilities
op_amp
id|CAP_INFOLEVEL_PASSTHRU
)paren
id|pSMB-&gt;InformationLevel
op_assign
id|cpu_to_le16
c_func
(paren
id|SMB_SET_FILE_ALLOCATION_INFO2
)paren
suffix:semicolon
r_else
id|pSMB-&gt;InformationLevel
op_assign
id|cpu_to_le16
c_func
(paren
id|SMB_SET_FILE_ALLOCATION_INFO
)paren
suffix:semicolon
)brace
r_else
multiline_comment|/* Set File Size */
(brace
r_if
c_cond
(paren
id|tcon-&gt;ses-&gt;capabilities
op_amp
id|CAP_INFOLEVEL_PASSTHRU
)paren
id|pSMB-&gt;InformationLevel
op_assign
id|cpu_to_le16
c_func
(paren
id|SMB_SET_FILE_END_OF_FILE_INFO2
)paren
suffix:semicolon
r_else
id|pSMB-&gt;InformationLevel
op_assign
id|cpu_to_le16
c_func
(paren
id|SMB_SET_FILE_END_OF_FILE_INFO
)paren
suffix:semicolon
)brace
id|parm_data
op_assign
(paren
r_struct
id|file_end_of_file_info
op_star
)paren
(paren
(paren
(paren
r_char
op_star
)paren
op_amp
id|pSMB-&gt;hdr.Protocol
)paren
op_plus
id|pSMB-&gt;DataOffset
)paren
suffix:semicolon
id|pSMB-&gt;ParameterOffset
op_assign
id|cpu_to_le16
c_func
(paren
id|pSMB-&gt;ParameterOffset
)paren
suffix:semicolon
id|pSMB-&gt;DataOffset
op_assign
id|cpu_to_le16
c_func
(paren
id|pSMB-&gt;DataOffset
)paren
suffix:semicolon
id|pSMB-&gt;SetupCount
op_assign
l_int|1
suffix:semicolon
id|pSMB-&gt;Reserved3
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;SubCommand
op_assign
id|cpu_to_le16
c_func
(paren
id|TRANS2_SET_PATH_INFORMATION
)paren
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
l_int|3
multiline_comment|/* pad */
op_plus
id|pSMB-&gt;ParameterCount
op_plus
id|pSMB-&gt;DataCount
suffix:semicolon
id|pSMB-&gt;DataCount
op_assign
id|cpu_to_le16
c_func
(paren
id|pSMB-&gt;DataCount
)paren
suffix:semicolon
id|pSMB-&gt;TotalDataCount
op_assign
id|pSMB-&gt;DataCount
suffix:semicolon
id|pSMB-&gt;ParameterCount
op_assign
id|cpu_to_le16
c_func
(paren
id|pSMB-&gt;ParameterCount
)paren
suffix:semicolon
id|pSMB-&gt;TotalParameterCount
op_assign
id|pSMB-&gt;ParameterCount
suffix:semicolon
id|pSMB-&gt;Reserved4
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;hdr.smb_buf_length
op_add_assign
id|pSMB-&gt;ByteCount
suffix:semicolon
id|parm_data-&gt;FileSize
op_assign
id|cpu_to_le64
c_func
(paren
id|size
)paren
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
id|cpu_to_le16
c_func
(paren
id|pSMB-&gt;ByteCount
)paren
suffix:semicolon
id|rc
op_assign
id|SendReceive
c_func
(paren
id|xid
comma
id|tcon-&gt;ses
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMB
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMBr
comma
op_amp
id|bytes_returned
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;SetPathInfo (file size) returned %d&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pSMB
)paren
id|buf_release
c_func
(paren
id|pSMB
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_int
DECL|function|CIFSSMBSetFileSize
id|CIFSSMBSetFileSize
c_func
(paren
r_const
r_int
id|xid
comma
r_struct
id|cifsTconInfo
op_star
id|tcon
comma
id|__u64
id|size
comma
id|__u16
id|fid
comma
id|__u32
id|pid_of_opener
comma
r_int
id|SetAllocation
)paren
(brace
r_struct
id|smb_com_transaction2_sfi_req
op_star
id|pSMB
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|smb_com_transaction2_sfi_rsp
op_star
id|pSMBr
op_assign
l_int|NULL
suffix:semicolon
r_char
op_star
id|data_offset
suffix:semicolon
r_struct
id|file_end_of_file_info
op_star
id|parm_data
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|bytes_returned
op_assign
l_int|0
suffix:semicolon
id|__u32
id|tmp
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;SetFileSize (via SetFileInfo)&quot;
)paren
)paren
suffix:semicolon
id|rc
op_assign
id|smb_init
c_func
(paren
id|SMB_COM_TRANSACTION2
comma
l_int|15
comma
id|tcon
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMB
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMBr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
id|tmp
op_assign
id|cpu_to_le32
c_func
(paren
id|pid_of_opener
)paren
suffix:semicolon
multiline_comment|/* override pid of current process&n;                                         so network fid will be valid */
id|pSMB-&gt;hdr.Pid
op_assign
id|tmp
op_amp
l_int|0xFFFF
suffix:semicolon
id|tmp
op_rshift_assign
l_int|16
suffix:semicolon
id|pSMB-&gt;hdr.PidHigh
op_assign
id|tmp
op_amp
l_int|0xFFFF
suffix:semicolon
id|pSMB-&gt;ParameterCount
op_assign
l_int|6
suffix:semicolon
id|pSMB-&gt;MaxSetupCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Flags
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Timeout
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved2
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;ParameterOffset
op_assign
m_offsetof
(paren
r_struct
id|smb_com_transaction2_sfi_req
comma
id|Fid
)paren
op_minus
l_int|4
suffix:semicolon
id|pSMB-&gt;DataOffset
op_assign
id|pSMB-&gt;ParameterOffset
op_plus
id|pSMB-&gt;ParameterCount
suffix:semicolon
id|data_offset
op_assign
(paren
r_char
op_star
)paren
(paren
op_amp
id|pSMB-&gt;hdr.Protocol
)paren
op_plus
id|pSMB-&gt;DataOffset
suffix:semicolon
id|pSMB-&gt;DataCount
op_assign
r_sizeof
(paren
r_struct
id|file_end_of_file_info
)paren
suffix:semicolon
id|pSMB-&gt;MaxParameterCount
op_assign
id|cpu_to_le16
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|pSMB-&gt;MaxDataCount
op_assign
id|cpu_to_le16
c_func
(paren
l_int|1000
)paren
suffix:semicolon
multiline_comment|/* BB find max SMB PDU from sess */
id|pSMB-&gt;SetupCount
op_assign
l_int|1
suffix:semicolon
id|pSMB-&gt;Reserved3
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;SubCommand
op_assign
id|cpu_to_le16
c_func
(paren
id|TRANS2_SET_FILE_INFORMATION
)paren
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
l_int|3
multiline_comment|/* pad */
op_plus
id|pSMB-&gt;ParameterCount
op_plus
id|pSMB-&gt;DataCount
suffix:semicolon
id|pSMB-&gt;DataCount
op_assign
id|cpu_to_le16
c_func
(paren
id|pSMB-&gt;DataCount
)paren
suffix:semicolon
id|pSMB-&gt;ParameterCount
op_assign
id|cpu_to_le16
c_func
(paren
id|pSMB-&gt;ParameterCount
)paren
suffix:semicolon
id|pSMB-&gt;TotalDataCount
op_assign
id|pSMB-&gt;DataCount
suffix:semicolon
id|pSMB-&gt;TotalParameterCount
op_assign
id|pSMB-&gt;ParameterCount
suffix:semicolon
id|pSMB-&gt;ParameterOffset
op_assign
id|cpu_to_le16
c_func
(paren
id|pSMB-&gt;ParameterOffset
)paren
suffix:semicolon
id|pSMB-&gt;DataOffset
op_assign
id|cpu_to_le16
c_func
(paren
id|pSMB-&gt;DataOffset
)paren
suffix:semicolon
id|parm_data
op_assign
(paren
r_struct
id|file_end_of_file_info
op_star
)paren
(paren
(paren
(paren
r_char
op_star
)paren
op_amp
id|pSMB-&gt;hdr.Protocol
)paren
op_plus
id|pSMB-&gt;DataOffset
)paren
suffix:semicolon
id|parm_data-&gt;FileSize
op_assign
id|size
suffix:semicolon
id|pSMB-&gt;Fid
op_assign
id|fid
suffix:semicolon
r_if
c_cond
(paren
id|SetAllocation
)paren
(brace
r_if
c_cond
(paren
id|tcon-&gt;ses-&gt;capabilities
op_amp
id|CAP_INFOLEVEL_PASSTHRU
)paren
id|pSMB-&gt;InformationLevel
op_assign
id|cpu_to_le16
c_func
(paren
id|SMB_SET_FILE_ALLOCATION_INFO2
)paren
suffix:semicolon
r_else
id|pSMB-&gt;InformationLevel
op_assign
id|cpu_to_le16
c_func
(paren
id|SMB_SET_FILE_ALLOCATION_INFO
)paren
suffix:semicolon
)brace
r_else
multiline_comment|/* Set File Size */
(brace
r_if
c_cond
(paren
id|tcon-&gt;ses-&gt;capabilities
op_amp
id|CAP_INFOLEVEL_PASSTHRU
)paren
id|pSMB-&gt;InformationLevel
op_assign
id|cpu_to_le16
c_func
(paren
id|SMB_SET_FILE_END_OF_FILE_INFO2
)paren
suffix:semicolon
r_else
id|pSMB-&gt;InformationLevel
op_assign
id|cpu_to_le16
c_func
(paren
id|SMB_SET_FILE_END_OF_FILE_INFO
)paren
suffix:semicolon
)brace
id|pSMB-&gt;Reserved4
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;hdr.smb_buf_length
op_add_assign
id|pSMB-&gt;ByteCount
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
id|cpu_to_le16
c_func
(paren
id|pSMB-&gt;ByteCount
)paren
suffix:semicolon
id|rc
op_assign
id|SendReceive
c_func
(paren
id|xid
comma
id|tcon-&gt;ses
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMB
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMBr
comma
op_amp
id|bytes_returned
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Send error in SetFileInfo (SetFileSize) = %d&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pSMB
)paren
id|buf_release
c_func
(paren
id|pSMB
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_int
DECL|function|CIFSSMBSetTimes
id|CIFSSMBSetTimes
c_func
(paren
r_int
id|xid
comma
r_struct
id|cifsTconInfo
op_star
id|tcon
comma
r_char
op_star
id|fileName
comma
id|FILE_BASIC_INFO
op_star
id|data
comma
r_const
r_struct
id|nls_table
op_star
id|nls_codepage
)paren
(brace
id|TRANSACTION2_SPI_REQ
op_star
id|pSMB
op_assign
l_int|NULL
suffix:semicolon
id|TRANSACTION2_SPI_RSP
op_star
id|pSMBr
op_assign
l_int|NULL
suffix:semicolon
r_int
id|name_len
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|bytes_returned
op_assign
l_int|0
suffix:semicolon
r_char
op_star
id|data_offset
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;In SetTimes&quot;
)paren
)paren
suffix:semicolon
id|rc
op_assign
id|smb_init
c_func
(paren
id|SMB_COM_TRANSACTION2
comma
l_int|15
comma
id|tcon
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMB
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMBr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|pSMB-&gt;hdr.Flags2
op_amp
id|SMBFLG2_UNICODE
)paren
(brace
id|name_len
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|pSMB-&gt;FileName
comma
id|fileName
comma
l_int|530
multiline_comment|/* find define for this maxpathcomponent */
comma
id|nls_codepage
)paren
suffix:semicolon
id|name_len
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|name_len
op_mul_assign
l_int|2
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* BB improve the check for buffer overruns BB */
id|name_len
op_assign
id|strnlen
c_func
(paren
id|fileName
comma
l_int|530
)paren
suffix:semicolon
id|name_len
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|strncpy
c_func
(paren
id|pSMB-&gt;FileName
comma
id|fileName
comma
id|name_len
)paren
suffix:semicolon
)brace
id|pSMB-&gt;ParameterCount
op_assign
l_int|6
op_plus
id|name_len
suffix:semicolon
id|pSMB-&gt;DataCount
op_assign
r_sizeof
(paren
id|FILE_BASIC_INFO
)paren
suffix:semicolon
id|pSMB-&gt;MaxParameterCount
op_assign
id|cpu_to_le16
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|pSMB-&gt;MaxDataCount
op_assign
id|cpu_to_le16
c_func
(paren
l_int|1000
)paren
suffix:semicolon
multiline_comment|/* BB find exact max SMB PDU from sess structure BB */
id|pSMB-&gt;MaxSetupCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Flags
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Timeout
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved2
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;ParameterOffset
op_assign
m_offsetof
(paren
r_struct
id|smb_com_transaction2_spi_req
comma
id|InformationLevel
)paren
op_minus
l_int|4
suffix:semicolon
id|pSMB-&gt;DataOffset
op_assign
id|pSMB-&gt;ParameterOffset
op_plus
id|pSMB-&gt;ParameterCount
suffix:semicolon
id|data_offset
op_assign
(paren
r_char
op_star
)paren
(paren
op_amp
id|pSMB-&gt;hdr.Protocol
)paren
op_plus
id|pSMB-&gt;DataOffset
suffix:semicolon
id|pSMB-&gt;ParameterOffset
op_assign
id|cpu_to_le16
c_func
(paren
id|pSMB-&gt;ParameterOffset
)paren
suffix:semicolon
id|pSMB-&gt;DataOffset
op_assign
id|cpu_to_le16
c_func
(paren
id|pSMB-&gt;DataOffset
)paren
suffix:semicolon
id|pSMB-&gt;SetupCount
op_assign
l_int|1
suffix:semicolon
id|pSMB-&gt;Reserved3
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;SubCommand
op_assign
id|cpu_to_le16
c_func
(paren
id|TRANS2_SET_PATH_INFORMATION
)paren
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
l_int|3
multiline_comment|/* pad */
op_plus
id|pSMB-&gt;ParameterCount
op_plus
id|pSMB-&gt;DataCount
suffix:semicolon
id|pSMB-&gt;DataCount
op_assign
id|cpu_to_le16
c_func
(paren
id|pSMB-&gt;DataCount
)paren
suffix:semicolon
id|pSMB-&gt;ParameterCount
op_assign
id|cpu_to_le16
c_func
(paren
id|pSMB-&gt;ParameterCount
)paren
suffix:semicolon
id|pSMB-&gt;TotalDataCount
op_assign
id|pSMB-&gt;DataCount
suffix:semicolon
id|pSMB-&gt;TotalParameterCount
op_assign
id|pSMB-&gt;ParameterCount
suffix:semicolon
r_if
c_cond
(paren
id|tcon-&gt;ses-&gt;capabilities
op_amp
id|CAP_INFOLEVEL_PASSTHRU
)paren
id|pSMB-&gt;InformationLevel
op_assign
id|cpu_to_le16
c_func
(paren
id|SMB_SET_FILE_BASIC_INFO2
)paren
suffix:semicolon
r_else
id|pSMB-&gt;InformationLevel
op_assign
id|cpu_to_le16
c_func
(paren
id|SMB_SET_FILE_BASIC_INFO
)paren
suffix:semicolon
id|pSMB-&gt;Reserved4
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;hdr.smb_buf_length
op_add_assign
id|pSMB-&gt;ByteCount
suffix:semicolon
id|memcpy
c_func
(paren
id|data_offset
comma
id|data
comma
r_sizeof
(paren
id|FILE_BASIC_INFO
)paren
)paren
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
id|cpu_to_le16
c_func
(paren
id|pSMB-&gt;ByteCount
)paren
suffix:semicolon
id|rc
op_assign
id|SendReceive
c_func
(paren
id|xid
comma
id|tcon-&gt;ses
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMB
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMBr
comma
op_amp
id|bytes_returned
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;SetPathInfo (times) returned %d&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pSMB
)paren
id|buf_release
c_func
(paren
id|pSMB
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_int
DECL|function|CIFSSMBUnixSetPerms
id|CIFSSMBUnixSetPerms
c_func
(paren
r_const
r_int
id|xid
comma
r_struct
id|cifsTconInfo
op_star
id|tcon
comma
r_char
op_star
id|fileName
comma
id|__u64
id|mode
comma
id|__u64
id|uid
comma
id|__u64
id|gid
comma
r_const
r_struct
id|nls_table
op_star
id|nls_codepage
)paren
(brace
id|TRANSACTION2_SPI_REQ
op_star
id|pSMB
op_assign
l_int|NULL
suffix:semicolon
id|TRANSACTION2_SPI_RSP
op_star
id|pSMBr
op_assign
l_int|NULL
suffix:semicolon
r_int
id|name_len
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|bytes_returned
op_assign
l_int|0
suffix:semicolon
id|FILE_UNIX_BASIC_INFO
op_star
id|data_offset
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;In SetUID/GID/Mode&quot;
)paren
)paren
suffix:semicolon
id|rc
op_assign
id|smb_init
c_func
(paren
id|SMB_COM_TRANSACTION2
comma
l_int|15
comma
id|tcon
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMB
comma
(paren
r_void
op_star
op_star
)paren
op_amp
id|pSMBr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
r_return
id|rc
suffix:semicolon
r_if
c_cond
(paren
id|pSMB-&gt;hdr.Flags2
op_amp
id|SMBFLG2_UNICODE
)paren
(brace
id|name_len
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|pSMB-&gt;FileName
comma
id|fileName
comma
l_int|530
multiline_comment|/* find define for this maxpathcomponent */
comma
id|nls_codepage
)paren
suffix:semicolon
id|name_len
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|name_len
op_mul_assign
l_int|2
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* BB improve the check for buffer overruns BB */
id|name_len
op_assign
id|strnlen
c_func
(paren
id|fileName
comma
l_int|530
)paren
suffix:semicolon
id|name_len
op_increment
suffix:semicolon
multiline_comment|/* trailing null */
id|strncpy
c_func
(paren
id|pSMB-&gt;FileName
comma
id|fileName
comma
id|name_len
)paren
suffix:semicolon
)brace
id|pSMB-&gt;ParameterCount
op_assign
l_int|6
op_plus
id|name_len
suffix:semicolon
id|pSMB-&gt;DataCount
op_assign
r_sizeof
(paren
id|FILE_UNIX_BASIC_INFO
)paren
suffix:semicolon
id|pSMB-&gt;MaxParameterCount
op_assign
id|cpu_to_le16
c_func
(paren
l_int|2
)paren
suffix:semicolon
id|pSMB-&gt;MaxDataCount
op_assign
id|cpu_to_le16
c_func
(paren
l_int|1000
)paren
suffix:semicolon
multiline_comment|/* BB find exact max SMB PDU from sess structure BB */
id|pSMB-&gt;MaxSetupCount
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Flags
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Timeout
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;Reserved2
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;ParameterOffset
op_assign
m_offsetof
(paren
r_struct
id|smb_com_transaction2_spi_req
comma
id|InformationLevel
)paren
op_minus
l_int|4
suffix:semicolon
id|pSMB-&gt;DataOffset
op_assign
id|pSMB-&gt;ParameterOffset
op_plus
id|pSMB-&gt;ParameterCount
suffix:semicolon
id|data_offset
op_assign
(paren
id|FILE_UNIX_BASIC_INFO
op_star
)paren
(paren
(paren
r_char
op_star
)paren
op_amp
id|pSMB-&gt;hdr.Protocol
op_plus
id|pSMB-&gt;DataOffset
)paren
suffix:semicolon
id|pSMB-&gt;DataOffset
op_assign
id|cpu_to_le16
c_func
(paren
id|pSMB-&gt;DataOffset
)paren
suffix:semicolon
id|pSMB-&gt;ParameterOffset
op_assign
id|cpu_to_le16
c_func
(paren
id|pSMB-&gt;ParameterOffset
)paren
suffix:semicolon
id|pSMB-&gt;SetupCount
op_assign
l_int|1
suffix:semicolon
id|pSMB-&gt;Reserved3
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;SubCommand
op_assign
id|cpu_to_le16
c_func
(paren
id|TRANS2_SET_PATH_INFORMATION
)paren
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
l_int|3
multiline_comment|/* pad */
op_plus
id|pSMB-&gt;ParameterCount
op_plus
id|pSMB-&gt;DataCount
suffix:semicolon
id|pSMB-&gt;ParameterCount
op_assign
id|cpu_to_le16
c_func
(paren
id|pSMB-&gt;ParameterCount
)paren
suffix:semicolon
id|pSMB-&gt;DataCount
op_assign
id|cpu_to_le16
c_func
(paren
id|pSMB-&gt;DataCount
)paren
suffix:semicolon
id|pSMB-&gt;TotalParameterCount
op_assign
id|pSMB-&gt;ParameterCount
suffix:semicolon
id|pSMB-&gt;TotalDataCount
op_assign
id|pSMB-&gt;DataCount
suffix:semicolon
id|pSMB-&gt;InformationLevel
op_assign
id|cpu_to_le16
c_func
(paren
id|SMB_SET_FILE_UNIX_BASIC
)paren
suffix:semicolon
id|pSMB-&gt;Reserved4
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;hdr.smb_buf_length
op_add_assign
id|pSMB-&gt;ByteCount
suffix:semicolon
id|data_offset-&gt;Uid
op_assign
id|cpu_to_le64
c_func
(paren
id|uid
)paren
suffix:semicolon
id|data_offset-&gt;Gid
op_assign
id|cpu_to_le64
c_func
(paren
id|gid
)paren
suffix:semicolon
id|data_offset-&gt;Permissions
op_assign
id|cpu_to_le64
c_func
(paren
id|mode
)paren
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
id|cpu_to_le16
c_func
(paren
id|pSMB-&gt;ByteCount
)paren
suffix:semicolon
id|rc
op_assign
id|SendReceive
c_func
(paren
id|xid
comma
id|tcon-&gt;ses
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMB
comma
(paren
r_struct
id|smb_hdr
op_star
)paren
id|pSMBr
comma
op_amp
id|bytes_returned
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;SetPathInfo (perms) returned %d&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pSMB
)paren
id|buf_release
c_func
(paren
id|pSMB
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
eof
