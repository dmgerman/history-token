multiline_comment|/*&n; *   fs/cifs/inode.c&n; *&n; *   Copyright (c) International Business Machines  Corp., 2002&n; *   Author(s): Steve French (sfrench@us.ibm.com)&n; *&n; *   This library is free software; you can redistribute it and/or modify&n; *   it under the terms of the GNU Lesser General Public License as published&n; *   by the Free Software Foundation; either version 2.1 of the License, or&n; *   (at your option) any later version.&n; *&n; *   This library is distributed in the hope that it will be useful,&n; *   but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See&n; *   the GNU Lesser General Public License for more details.&n; *&n; *   You should have received a copy of the GNU Lesser General Public License&n; *   along with this library; if not, write to the Free Software&n; *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA&n; */
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/buffer_head.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/pagemap.h&gt;
macro_line|#include &lt;asm/div64.h&gt;
macro_line|#include &quot;cifsfs.h&quot;
macro_line|#include &quot;cifspdu.h&quot;
macro_line|#include &quot;cifsglob.h&quot;
macro_line|#include &quot;cifsproto.h&quot;
macro_line|#include &quot;cifs_debug.h&quot;
macro_line|#include &quot;cifs_fs_sb.h&quot;
r_int
DECL|function|cifs_get_inode_info_unix
id|cifs_get_inode_info_unix
c_func
(paren
r_struct
id|inode
op_star
op_star
id|pinode
comma
r_const
r_int
r_char
op_star
id|search_path
comma
r_struct
id|super_block
op_star
id|sb
)paren
(brace
r_int
id|xid
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|FILE_UNIX_BASIC_INFO
id|findData
suffix:semicolon
r_struct
id|cifsTconInfo
op_star
id|pTcon
suffix:semicolon
r_struct
id|inode
op_star
id|inode
suffix:semicolon
r_struct
id|cifs_sb_info
op_star
id|cifs_sb
op_assign
id|CIFS_SB
c_func
(paren
id|sb
)paren
suffix:semicolon
r_char
op_star
id|tmp_path
suffix:semicolon
id|xid
op_assign
id|GetXid
c_func
(paren
)paren
suffix:semicolon
id|pTcon
op_assign
id|cifs_sb-&gt;tcon
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot; Getting info on %s &quot;
comma
id|search_path
)paren
)paren
suffix:semicolon
multiline_comment|/* we could have done a find first instead but this returns more info */
id|rc
op_assign
id|CIFSSMBUnixQPathInfo
c_func
(paren
id|xid
comma
id|pTcon
comma
id|search_path
comma
op_amp
id|findData
comma
id|cifs_sb-&gt;local_nls
)paren
suffix:semicolon
multiline_comment|/* dump_mem(&quot;&bslash;nUnixQPathInfo return data&quot;, &amp;findData, sizeof(findData)); */
r_if
c_cond
(paren
id|rc
)paren
(brace
r_if
c_cond
(paren
id|rc
op_eq
op_minus
id|EREMOTE
)paren
(brace
id|tmp_path
op_assign
id|kmalloc
c_func
(paren
id|strnlen
(paren
id|pTcon-&gt;treeName
comma
id|MAX_TREE_SIZE
op_plus
l_int|1
)paren
op_plus
id|strnlen
c_func
(paren
id|search_path
comma
id|MAX_PATHCONF
)paren
op_plus
l_int|1
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmp_path
op_eq
l_int|NULL
)paren
(brace
id|FreeXid
c_func
(paren
id|xid
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/* have to skip first of the double backslash of UNC name */
id|strncpy
c_func
(paren
id|tmp_path
comma
id|pTcon-&gt;treeName
comma
id|MAX_TREE_SIZE
)paren
suffix:semicolon
id|strncat
c_func
(paren
id|tmp_path
comma
id|search_path
comma
id|MAX_PATHCONF
)paren
suffix:semicolon
id|rc
op_assign
id|connect_to_dfs_path
c_func
(paren
id|xid
comma
id|pTcon-&gt;ses
comma
multiline_comment|/* treename + */
id|tmp_path
comma
id|cifs_sb-&gt;local_nls
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|tmp_path
)paren
suffix:semicolon
multiline_comment|/* BB fix up inode etc. */
)brace
r_else
r_if
c_cond
(paren
id|rc
)paren
(brace
id|FreeXid
c_func
(paren
id|xid
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
)brace
r_else
(brace
r_struct
id|cifsInodeInfo
op_star
id|cifsInfo
suffix:semicolon
multiline_comment|/* get new inode */
r_if
c_cond
(paren
op_star
id|pinode
op_eq
l_int|NULL
)paren
(brace
op_star
id|pinode
op_assign
id|new_inode
c_func
(paren
id|sb
)paren
suffix:semicolon
)brace
id|inode
op_assign
op_star
id|pinode
suffix:semicolon
id|cifsInfo
op_assign
id|CIFS_I
c_func
(paren
id|inode
)paren
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot; Old time %ld &quot;
comma
id|cifsInfo-&gt;time
)paren
)paren
suffix:semicolon
id|cifsInfo-&gt;time
op_assign
id|jiffies
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot; New time %ld &quot;
comma
id|cifsInfo-&gt;time
)paren
)paren
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|cifsInfo-&gt;inUse
)paren
suffix:semicolon
multiline_comment|/* inc on every refresh of inode */
id|inode-&gt;i_atime
op_assign
id|cifs_NTtimeToUnix
c_func
(paren
id|le64_to_cpu
c_func
(paren
id|findData.LastAccessTime
)paren
)paren
suffix:semicolon
id|inode-&gt;i_mtime
op_assign
id|cifs_NTtimeToUnix
c_func
(paren
id|le64_to_cpu
(paren
id|findData.LastModificationTime
)paren
)paren
suffix:semicolon
id|inode-&gt;i_ctime
op_assign
id|cifs_NTtimeToUnix
c_func
(paren
id|le64_to_cpu
c_func
(paren
id|findData.LastStatusChange
)paren
)paren
suffix:semicolon
id|inode-&gt;i_mode
op_assign
id|le64_to_cpu
c_func
(paren
id|findData.Permissions
)paren
suffix:semicolon
id|findData.Type
op_assign
id|le32_to_cpu
c_func
(paren
id|findData.Type
)paren
suffix:semicolon
r_if
c_cond
(paren
id|findData.Type
op_eq
id|UNIX_FILE
)paren
(brace
id|inode-&gt;i_mode
op_or_assign
id|S_IFREG
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|findData.Type
op_eq
id|UNIX_SYMLINK
)paren
(brace
id|inode-&gt;i_mode
op_or_assign
id|S_IFLNK
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|findData.Type
op_eq
id|UNIX_DIR
)paren
(brace
id|inode-&gt;i_mode
op_or_assign
id|S_IFDIR
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|findData.Type
op_eq
id|UNIX_CHARDEV
)paren
(brace
id|inode-&gt;i_mode
op_or_assign
id|S_IFCHR
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|findData.Type
op_eq
id|UNIX_BLOCKDEV
)paren
(brace
id|inode-&gt;i_mode
op_or_assign
id|S_IFBLK
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|findData.Type
op_eq
id|UNIX_FIFO
)paren
(brace
id|inode-&gt;i_mode
op_or_assign
id|S_IFIFO
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|findData.Type
op_eq
id|UNIX_SOCKET
)paren
(brace
id|inode-&gt;i_mode
op_or_assign
id|S_IFSOCK
suffix:semicolon
)brace
id|inode-&gt;i_uid
op_assign
id|le64_to_cpu
c_func
(paren
id|findData.Uid
)paren
suffix:semicolon
id|inode-&gt;i_gid
op_assign
id|le64_to_cpu
c_func
(paren
id|findData.Gid
)paren
suffix:semicolon
id|inode-&gt;i_nlink
op_assign
id|le64_to_cpu
c_func
(paren
id|findData.Nlinks
)paren
suffix:semicolon
id|findData.NumOfBytes
op_assign
id|le64_to_cpu
c_func
(paren
id|findData.NumOfBytes
)paren
suffix:semicolon
id|findData.EndOfFile
op_assign
id|le64_to_cpu
c_func
(paren
id|findData.EndOfFile
)paren
suffix:semicolon
id|inode-&gt;i_size
op_assign
id|findData.EndOfFile
suffix:semicolon
id|inode-&gt;i_blksize
op_assign
(paren
id|pTcon-&gt;ses-&gt;server-&gt;maxBuf
op_minus
id|MAX_CIFS_HDR_SIZE
)paren
op_amp
l_int|0xFFFFFE00
suffix:semicolon
id|inode-&gt;i_blocks
op_assign
id|do_div
c_func
(paren
id|findData.NumOfBytes
comma
id|inode-&gt;i_blksize
)paren
suffix:semicolon
r_if
c_cond
(paren
id|findData.NumOfBytes
OL
id|findData.EndOfFile
)paren
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Server inconsistency Error: it says allocation size less than end of file &quot;
)paren
)paren
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Size %ld and blocks %ld &quot;
comma
(paren
r_int
r_int
)paren
id|inode-&gt;i_size
comma
id|inode-&gt;i_blocks
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|S_ISREG
c_func
(paren
id|inode-&gt;i_mode
)paren
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot; File inode &quot;
)paren
)paren
suffix:semicolon
id|inode-&gt;i_op
op_assign
op_amp
id|cifs_file_inode_ops
suffix:semicolon
id|inode-&gt;i_fop
op_assign
op_amp
id|cifs_file_ops
suffix:semicolon
id|inode-&gt;i_data.a_ops
op_assign
op_amp
id|cifs_addr_ops
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|S_ISDIR
c_func
(paren
id|inode-&gt;i_mode
)paren
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot; Directory inode&quot;
)paren
)paren
suffix:semicolon
id|inode-&gt;i_op
op_assign
op_amp
id|cifs_dir_inode_ops
suffix:semicolon
id|inode-&gt;i_fop
op_assign
op_amp
id|cifs_dir_ops
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|S_ISLNK
c_func
(paren
id|inode-&gt;i_mode
)paren
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot; Symbolic Link inode &quot;
)paren
)paren
suffix:semicolon
id|inode-&gt;i_op
op_assign
op_amp
id|cifs_symlink_inode_ops
suffix:semicolon
multiline_comment|/* tmp_inode-&gt;i_fop = */
multiline_comment|/* do not need to set to anything */
)brace
r_else
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot; Init special inode &quot;
)paren
)paren
suffix:semicolon
id|init_special_inode
c_func
(paren
id|inode
comma
id|inode-&gt;i_mode
comma
id|kdev_t_to_nr
c_func
(paren
id|inode-&gt;i_rdev
)paren
)paren
suffix:semicolon
)brace
)brace
id|FreeXid
c_func
(paren
id|xid
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_int
DECL|function|cifs_get_inode_info
id|cifs_get_inode_info
c_func
(paren
r_struct
id|inode
op_star
op_star
id|pinode
comma
r_const
r_int
r_char
op_star
id|search_path
comma
r_struct
id|super_block
op_star
id|sb
)paren
(brace
r_int
id|xid
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|FILE_ALL_INFO
id|findData
suffix:semicolon
r_struct
id|cifsTconInfo
op_star
id|pTcon
suffix:semicolon
r_struct
id|inode
op_star
id|inode
suffix:semicolon
r_struct
id|cifs_sb_info
op_star
id|cifs_sb
op_assign
id|CIFS_SB
c_func
(paren
id|sb
)paren
suffix:semicolon
r_char
op_star
id|tmp_path
suffix:semicolon
id|xid
op_assign
id|GetXid
c_func
(paren
)paren
suffix:semicolon
id|pTcon
op_assign
id|cifs_sb-&gt;tcon
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot; Getting info on %s &quot;
comma
id|search_path
)paren
)paren
suffix:semicolon
multiline_comment|/* we could have done a find first instead but this returns more info */
id|rc
op_assign
id|CIFSSMBQPathInfo
c_func
(paren
id|xid
comma
id|pTcon
comma
id|search_path
comma
op_amp
id|findData
comma
id|cifs_sb-&gt;local_nls
)paren
suffix:semicolon
multiline_comment|/* dump_mem(&quot;&bslash;nQPathInfo return data&quot;,&amp;findData, sizeof(findData)); */
r_if
c_cond
(paren
id|rc
)paren
(brace
r_if
c_cond
(paren
id|rc
op_eq
op_minus
id|EREMOTE
)paren
(brace
id|tmp_path
op_assign
id|kmalloc
c_func
(paren
id|strnlen
(paren
id|pTcon-&gt;treeName
comma
id|MAX_TREE_SIZE
op_plus
l_int|1
)paren
op_plus
id|strnlen
c_func
(paren
id|search_path
comma
id|MAX_PATHCONF
)paren
op_plus
l_int|1
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmp_path
op_eq
l_int|NULL
)paren
(brace
id|FreeXid
c_func
(paren
id|xid
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|strncpy
c_func
(paren
id|tmp_path
comma
id|pTcon-&gt;treeName
comma
id|MAX_TREE_SIZE
)paren
suffix:semicolon
id|strncat
c_func
(paren
id|tmp_path
comma
id|search_path
comma
id|MAX_PATHCONF
)paren
suffix:semicolon
id|rc
op_assign
id|connect_to_dfs_path
c_func
(paren
id|xid
comma
id|pTcon-&gt;ses
comma
multiline_comment|/* treename + */
id|tmp_path
comma
id|cifs_sb-&gt;local_nls
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|tmp_path
)paren
suffix:semicolon
multiline_comment|/* BB fix up inode etc. */
)brace
r_else
r_if
c_cond
(paren
id|rc
)paren
(brace
id|FreeXid
c_func
(paren
id|xid
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
)brace
r_else
(brace
r_struct
id|cifsInodeInfo
op_star
id|cifsInfo
suffix:semicolon
multiline_comment|/* get new inode */
r_if
c_cond
(paren
op_star
id|pinode
op_eq
l_int|NULL
)paren
(brace
op_star
id|pinode
op_assign
id|new_inode
c_func
(paren
id|sb
)paren
suffix:semicolon
)brace
id|inode
op_assign
op_star
id|pinode
suffix:semicolon
id|cifsInfo
op_assign
id|CIFS_I
c_func
(paren
id|inode
)paren
suffix:semicolon
id|findData.Attributes
op_assign
id|le32_to_cpu
c_func
(paren
id|findData.Attributes
)paren
suffix:semicolon
id|cifsInfo-&gt;cifsAttrs
op_assign
id|findData.Attributes
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot; Old time %ld &quot;
comma
id|cifsInfo-&gt;time
)paren
)paren
suffix:semicolon
id|cifsInfo-&gt;time
op_assign
id|jiffies
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot; New time %ld &quot;
comma
id|cifsInfo-&gt;time
)paren
)paren
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|cifsInfo-&gt;inUse
)paren
suffix:semicolon
multiline_comment|/* inc on every refresh of inode */
id|inode-&gt;i_blksize
op_assign
(paren
id|pTcon-&gt;ses-&gt;server-&gt;maxBuf
op_minus
id|MAX_CIFS_HDR_SIZE
)paren
op_amp
l_int|0xFFFFFE00
suffix:semicolon
multiline_comment|/* Linux can not store file creation time unfortunately so we ignore it */
id|inode-&gt;i_atime
op_assign
id|cifs_NTtimeToUnix
c_func
(paren
id|le64_to_cpu
c_func
(paren
id|findData.LastAccessTime
)paren
)paren
suffix:semicolon
id|inode-&gt;i_mtime
op_assign
id|cifs_NTtimeToUnix
c_func
(paren
id|le64_to_cpu
c_func
(paren
id|findData.LastWriteTime
)paren
)paren
suffix:semicolon
id|inode-&gt;i_ctime
op_assign
id|cifs_NTtimeToUnix
c_func
(paren
id|le64_to_cpu
c_func
(paren
id|findData.ChangeTime
)paren
)paren
suffix:semicolon
id|cFYI
c_func
(paren
l_int|0
comma
(paren
l_string|&quot; Attributes came in as 0x%x &quot;
comma
id|findData.Attributes
)paren
)paren
suffix:semicolon
multiline_comment|/* set default mode. will override for dirs below */
id|inode-&gt;i_mode
op_assign
id|cifs_sb-&gt;mnt_file_mode
suffix:semicolon
r_if
c_cond
(paren
id|findData.Attributes
op_amp
id|ATTR_REPARSE
)paren
(brace
multiline_comment|/* Can IFLNK be set as it basically is on windows with IFREG or IFDIR? */
id|inode-&gt;i_mode
op_or_assign
id|S_IFLNK
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|findData.Attributes
op_amp
id|ATTR_DIRECTORY
)paren
(brace
multiline_comment|/* override default perms since we do not do byte range locking on dirs */
id|inode-&gt;i_mode
op_assign
id|cifs_sb-&gt;mnt_dir_mode
suffix:semicolon
id|inode-&gt;i_mode
op_or_assign
id|S_IFDIR
suffix:semicolon
)brace
r_else
(brace
id|inode-&gt;i_mode
op_or_assign
id|S_IFREG
suffix:semicolon
multiline_comment|/* treat the dos attribute of read-only as read-only mode e.g. 555 */
r_if
c_cond
(paren
id|cifsInfo-&gt;cifsAttrs
op_amp
id|ATTR_READONLY
)paren
(brace
id|inode-&gt;i_mode
op_and_assign
op_complement
(paren
id|S_IWUGO
)paren
suffix:semicolon
)brace
multiline_comment|/* BB add code here - validate if device or weird share or device type? */
)brace
id|inode-&gt;i_size
op_assign
id|le64_to_cpu
c_func
(paren
id|findData.EndOfFile
)paren
suffix:semicolon
id|findData.AllocationSize
op_assign
id|le64_to_cpu
c_func
(paren
id|findData.AllocationSize
)paren
suffix:semicolon
id|inode-&gt;i_blocks
op_assign
id|do_div
c_func
(paren
id|findData.AllocationSize
comma
id|inode-&gt;i_blksize
)paren
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot; Size %ld and blocks %ld &quot;
comma
(paren
r_int
r_int
)paren
id|inode-&gt;i_size
comma
id|inode-&gt;i_blocks
)paren
)paren
suffix:semicolon
id|inode-&gt;i_nlink
op_assign
id|le32_to_cpu
c_func
(paren
id|findData.NumberOfLinks
)paren
suffix:semicolon
multiline_comment|/* BB fill in uid and gid here? with help from winbind? &n;&t;&t;&t;or retrieve from NTFS stream extended attribute */
id|inode-&gt;i_uid
op_assign
id|cifs_sb-&gt;mnt_uid
suffix:semicolon
id|inode-&gt;i_gid
op_assign
id|cifs_sb-&gt;mnt_gid
suffix:semicolon
r_if
c_cond
(paren
id|S_ISREG
c_func
(paren
id|inode-&gt;i_mode
)paren
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot; File inode &quot;
)paren
)paren
suffix:semicolon
id|inode-&gt;i_op
op_assign
op_amp
id|cifs_file_inode_ops
suffix:semicolon
id|inode-&gt;i_fop
op_assign
op_amp
id|cifs_file_ops
suffix:semicolon
id|inode-&gt;i_data.a_ops
op_assign
op_amp
id|cifs_addr_ops
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|S_ISDIR
c_func
(paren
id|inode-&gt;i_mode
)paren
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot; Directory inode &quot;
)paren
)paren
suffix:semicolon
id|inode-&gt;i_op
op_assign
op_amp
id|cifs_dir_inode_ops
suffix:semicolon
id|inode-&gt;i_fop
op_assign
op_amp
id|cifs_dir_ops
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|S_ISLNK
c_func
(paren
id|inode-&gt;i_mode
)paren
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot; Symbolic Link inode &quot;
)paren
)paren
suffix:semicolon
id|inode-&gt;i_op
op_assign
op_amp
id|cifs_symlink_inode_ops
suffix:semicolon
)brace
r_else
(brace
id|init_special_inode
c_func
(paren
id|inode
comma
id|inode-&gt;i_mode
comma
id|kdev_t_to_nr
c_func
(paren
id|inode-&gt;i_rdev
)paren
)paren
suffix:semicolon
)brace
)brace
id|FreeXid
c_func
(paren
id|xid
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_void
DECL|function|cifs_read_inode
id|cifs_read_inode
c_func
(paren
r_struct
id|inode
op_star
id|inode
)paren
(brace
multiline_comment|/* gets root inode */
r_struct
id|cifs_sb_info
op_star
id|cifs_sb
suffix:semicolon
id|cifs_sb
op_assign
id|CIFS_SB
c_func
(paren
id|inode-&gt;i_sb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cifs_sb-&gt;tcon-&gt;ses-&gt;capabilities
op_amp
id|CAP_UNIX
)paren
id|cifs_get_inode_info_unix
c_func
(paren
op_amp
id|inode
comma
l_string|&quot;&quot;
comma
id|inode-&gt;i_sb
)paren
suffix:semicolon
r_else
id|cifs_get_inode_info
c_func
(paren
op_amp
id|inode
comma
l_string|&quot;&quot;
comma
id|inode-&gt;i_sb
)paren
suffix:semicolon
)brace
r_int
DECL|function|cifs_unlink
id|cifs_unlink
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|dentry
op_star
id|direntry
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|xid
suffix:semicolon
r_struct
id|cifs_sb_info
op_star
id|cifs_sb
suffix:semicolon
r_struct
id|cifsTconInfo
op_star
id|pTcon
suffix:semicolon
r_char
op_star
id|full_path
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|cifsInodeInfo
op_star
id|cifsInode
suffix:semicolon
id|FILE_BASIC_INFO
op_star
id|pinfo_buf
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot; cifs_unlink, inode = 0x%p with &quot;
comma
id|inode
)paren
)paren
suffix:semicolon
id|xid
op_assign
id|GetXid
c_func
(paren
)paren
suffix:semicolon
id|cifs_sb
op_assign
id|CIFS_SB
c_func
(paren
id|inode-&gt;i_sb
)paren
suffix:semicolon
id|pTcon
op_assign
id|cifs_sb-&gt;tcon
suffix:semicolon
id|full_path
op_assign
id|build_path_from_dentry
c_func
(paren
id|direntry
)paren
suffix:semicolon
id|rc
op_assign
id|CIFSSMBDelFile
c_func
(paren
id|xid
comma
id|pTcon
comma
id|full_path
comma
id|cifs_sb-&gt;local_nls
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rc
)paren
(brace
id|direntry-&gt;d_inode-&gt;i_nlink
op_decrement
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|rc
op_eq
op_minus
id|ETXTBSY
)paren
(brace
r_int
id|oplock
op_assign
id|FALSE
suffix:semicolon
id|__u16
id|netfid
suffix:semicolon
id|rc
op_assign
id|CIFSSMBOpen
c_func
(paren
id|xid
comma
id|pTcon
comma
id|full_path
comma
id|FILE_OPEN
comma
id|DELETE
comma
id|CREATE_NOT_DIR
op_or
id|CREATE_DELETE_ON_CLOSE
comma
op_amp
id|netfid
comma
op_amp
id|oplock
comma
id|cifs_sb-&gt;local_nls
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
)paren
(brace
id|CIFSSMBClose
c_func
(paren
id|xid
comma
id|pTcon
comma
id|netfid
)paren
suffix:semicolon
multiline_comment|/* BB In the future chain close with the NTCreateX to narrow window */
id|direntry-&gt;d_inode-&gt;i_nlink
op_decrement
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|rc
op_eq
op_minus
id|EACCES
)paren
(brace
multiline_comment|/* try only if r/o attribute set in local lookup data? */
id|pinfo_buf
op_assign
(paren
id|FILE_BASIC_INFO
op_star
)paren
id|kmalloc
c_func
(paren
r_sizeof
(paren
id|FILE_BASIC_INFO
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pinfo_buf
)paren
(brace
id|memset
c_func
(paren
id|pinfo_buf
comma
l_int|0
comma
r_sizeof
(paren
id|FILE_BASIC_INFO
)paren
)paren
suffix:semicolon
multiline_comment|/* ATTRS set to normal clears r/o bit */
id|pinfo_buf-&gt;Attributes
op_assign
id|cpu_to_le32
c_func
(paren
id|ATTR_NORMAL
)paren
suffix:semicolon
id|rc
op_assign
id|CIFSSMBSetTimes
c_func
(paren
id|xid
comma
id|pTcon
comma
id|full_path
comma
id|pinfo_buf
comma
id|cifs_sb-&gt;local_nls
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|pinfo_buf
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
)paren
(brace
id|rc
op_assign
id|CIFSSMBDelFile
c_func
(paren
id|xid
comma
id|pTcon
comma
id|full_path
comma
id|cifs_sb-&gt;local_nls
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rc
)paren
id|direntry-&gt;d_inode-&gt;i_nlink
op_decrement
suffix:semicolon
)brace
)brace
id|cifsInode
op_assign
id|CIFS_I
c_func
(paren
id|direntry-&gt;d_inode
)paren
suffix:semicolon
id|cifsInode-&gt;time
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* will force revalidate to get info when needed */
id|direntry-&gt;d_inode-&gt;i_ctime
op_assign
id|inode-&gt;i_ctime
op_assign
id|inode-&gt;i_mtime
op_assign
id|CURRENT_TIME
suffix:semicolon
id|cifsInode
op_assign
id|CIFS_I
c_func
(paren
id|inode
)paren
suffix:semicolon
id|cifsInode-&gt;time
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* force revalidate of dir as well */
r_if
c_cond
(paren
id|full_path
)paren
id|kfree
c_func
(paren
id|full_path
)paren
suffix:semicolon
id|FreeXid
c_func
(paren
id|xid
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_int
DECL|function|cifs_mkdir
id|cifs_mkdir
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|dentry
op_star
id|direntry
comma
r_int
id|mode
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|xid
suffix:semicolon
r_struct
id|cifs_sb_info
op_star
id|cifs_sb
suffix:semicolon
r_struct
id|cifsTconInfo
op_star
id|pTcon
suffix:semicolon
r_char
op_star
id|full_path
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|inode
op_star
id|newinode
op_assign
l_int|NULL
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;In cifs_mkdir, mode = 0x%x inode = 0x%p &quot;
comma
id|mode
comma
id|inode
)paren
)paren
suffix:semicolon
id|xid
op_assign
id|GetXid
c_func
(paren
)paren
suffix:semicolon
id|cifs_sb
op_assign
id|CIFS_SB
c_func
(paren
id|inode-&gt;i_sb
)paren
suffix:semicolon
id|pTcon
op_assign
id|cifs_sb-&gt;tcon
suffix:semicolon
id|full_path
op_assign
id|build_path_from_dentry
c_func
(paren
id|direntry
)paren
suffix:semicolon
multiline_comment|/* BB add setting the equivalent of mode via CreateX w/ACLs */
id|rc
op_assign
id|CIFSSMBMkDir
c_func
(paren
id|xid
comma
id|pTcon
comma
id|full_path
comma
id|cifs_sb-&gt;local_nls
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;cifs_mkdir returned 0x%x &quot;
comma
id|rc
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|inode-&gt;i_nlink
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|pTcon-&gt;ses-&gt;capabilities
op_amp
id|CAP_UNIX
)paren
id|rc
op_assign
id|cifs_get_inode_info_unix
c_func
(paren
op_amp
id|newinode
comma
id|full_path
comma
id|inode-&gt;i_sb
)paren
suffix:semicolon
r_else
id|rc
op_assign
id|cifs_get_inode_info
c_func
(paren
op_amp
id|newinode
comma
id|full_path
comma
id|inode-&gt;i_sb
)paren
suffix:semicolon
id|direntry-&gt;d_op
op_assign
op_amp
id|cifs_dentry_ops
suffix:semicolon
id|d_instantiate
c_func
(paren
id|direntry
comma
id|newinode
)paren
suffix:semicolon
id|direntry-&gt;d_inode-&gt;i_nlink
op_assign
l_int|2
suffix:semicolon
r_if
c_cond
(paren
id|cifs_sb-&gt;tcon-&gt;ses-&gt;capabilities
op_amp
id|CAP_UNIX
)paren
id|CIFSSMBUnixSetPerms
c_func
(paren
id|xid
comma
id|pTcon
comma
id|full_path
comma
id|mode
comma
(paren
id|__u64
)paren
op_minus
l_int|1
comma
(paren
id|__u64
)paren
op_minus
l_int|1
comma
l_int|0
multiline_comment|/* dev_t */
comma
id|cifs_sb-&gt;local_nls
)paren
suffix:semicolon
r_else
(brace
multiline_comment|/* BB to be implemented via Windows secrty descriptors*/
multiline_comment|/* eg CIFSSMBWinSetPerms(xid,pTcon,full_path,mode,-1,-1,local_nls);*/
)brace
)brace
r_if
c_cond
(paren
id|full_path
)paren
id|kfree
c_func
(paren
id|full_path
)paren
suffix:semicolon
id|FreeXid
c_func
(paren
id|xid
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_int
DECL|function|cifs_rmdir
id|cifs_rmdir
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|dentry
op_star
id|direntry
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|xid
suffix:semicolon
r_struct
id|cifs_sb_info
op_star
id|cifs_sb
suffix:semicolon
r_struct
id|cifsTconInfo
op_star
id|pTcon
suffix:semicolon
r_char
op_star
id|full_path
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|cifsInodeInfo
op_star
id|cifsInode
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot; cifs_rmdir, inode = 0x%p with &quot;
comma
id|inode
)paren
)paren
suffix:semicolon
id|xid
op_assign
id|GetXid
c_func
(paren
)paren
suffix:semicolon
id|cifs_sb
op_assign
id|CIFS_SB
c_func
(paren
id|inode-&gt;i_sb
)paren
suffix:semicolon
id|pTcon
op_assign
id|cifs_sb-&gt;tcon
suffix:semicolon
id|full_path
op_assign
id|build_path_from_dentry
c_func
(paren
id|direntry
)paren
suffix:semicolon
id|rc
op_assign
id|CIFSSMBRmDir
c_func
(paren
id|xid
comma
id|pTcon
comma
id|full_path
comma
id|cifs_sb-&gt;local_nls
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rc
)paren
(brace
id|inode-&gt;i_nlink
op_decrement
suffix:semicolon
id|direntry-&gt;d_inode-&gt;i_size
op_assign
l_int|0
suffix:semicolon
id|direntry-&gt;d_inode-&gt;i_nlink
op_assign
l_int|0
suffix:semicolon
)brace
id|cifsInode
op_assign
id|CIFS_I
c_func
(paren
id|direntry-&gt;d_inode
)paren
suffix:semicolon
id|cifsInode-&gt;time
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* force revalidate to go get info when needed */
id|direntry-&gt;d_inode-&gt;i_ctime
op_assign
id|inode-&gt;i_ctime
op_assign
id|inode-&gt;i_mtime
op_assign
id|CURRENT_TIME
suffix:semicolon
r_if
c_cond
(paren
id|full_path
)paren
id|kfree
c_func
(paren
id|full_path
)paren
suffix:semicolon
id|FreeXid
c_func
(paren
id|xid
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_int
DECL|function|cifs_rename
id|cifs_rename
c_func
(paren
r_struct
id|inode
op_star
id|source_inode
comma
r_struct
id|dentry
op_star
id|source_direntry
comma
r_struct
id|inode
op_star
id|target_inode
comma
r_struct
id|dentry
op_star
id|target_direntry
)paren
(brace
r_char
op_star
id|fromName
suffix:semicolon
r_char
op_star
id|toName
suffix:semicolon
r_struct
id|cifs_sb_info
op_star
id|cifs_sb_source
suffix:semicolon
r_struct
id|cifs_sb_info
op_star
id|cifs_sb_target
suffix:semicolon
r_struct
id|cifsTconInfo
op_star
id|pTcon
suffix:semicolon
r_int
id|xid
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|xid
op_assign
id|GetXid
c_func
(paren
)paren
suffix:semicolon
id|cifs_sb_target
op_assign
id|CIFS_SB
c_func
(paren
id|target_inode-&gt;i_sb
)paren
suffix:semicolon
id|cifs_sb_source
op_assign
id|CIFS_SB
c_func
(paren
id|source_inode-&gt;i_sb
)paren
suffix:semicolon
id|pTcon
op_assign
id|cifs_sb_source-&gt;tcon
suffix:semicolon
r_if
c_cond
(paren
id|pTcon
op_ne
id|cifs_sb_target-&gt;tcon
)paren
(brace
id|FreeXid
c_func
(paren
id|xid
)paren
suffix:semicolon
r_return
op_minus
id|EXDEV
suffix:semicolon
multiline_comment|/* BB actually could be allowed if same server, but&n;                     different share. Might eventually add support for this */
)brace
id|fromName
op_assign
id|build_path_from_dentry
c_func
(paren
id|source_direntry
)paren
suffix:semicolon
id|toName
op_assign
id|build_path_from_dentry
c_func
(paren
id|target_direntry
)paren
suffix:semicolon
id|rc
op_assign
id|CIFSSMBRename
c_func
(paren
id|xid
comma
id|pTcon
comma
id|fromName
comma
id|toName
comma
id|cifs_sb_source-&gt;local_nls
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
op_minus
id|EEXIST
)paren
(brace
id|cifs_unlink
c_func
(paren
id|target_inode
comma
id|target_direntry
)paren
suffix:semicolon
id|rc
op_assign
id|CIFSSMBRename
c_func
(paren
id|xid
comma
id|pTcon
comma
id|fromName
comma
id|toName
comma
id|cifs_sb_source-&gt;local_nls
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fromName
)paren
id|kfree
c_func
(paren
id|fromName
)paren
suffix:semicolon
r_if
c_cond
(paren
id|toName
)paren
id|kfree
c_func
(paren
id|toName
)paren
suffix:semicolon
id|FreeXid
c_func
(paren
id|xid
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_int
DECL|function|cifs_revalidate
id|cifs_revalidate
c_func
(paren
r_struct
id|dentry
op_star
id|direntry
)paren
(brace
r_int
id|xid
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_char
op_star
id|full_path
suffix:semicolon
r_struct
id|cifs_sb_info
op_star
id|cifs_sb
suffix:semicolon
r_struct
id|cifsInodeInfo
op_star
id|cifsInode
suffix:semicolon
id|xid
op_assign
id|GetXid
c_func
(paren
)paren
suffix:semicolon
id|cifs_sb
op_assign
id|CIFS_SB
c_func
(paren
id|direntry-&gt;d_sb
)paren
suffix:semicolon
id|full_path
op_assign
id|build_path_from_dentry
c_func
(paren
id|direntry
)paren
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Revalidate full path: %s for inode 0x%p with count %d dentry: 0x%p d_time %ld at time %ld &quot;
comma
id|full_path
comma
id|direntry-&gt;d_inode
comma
id|direntry-&gt;d_inode-&gt;i_count.counter
comma
id|direntry
comma
id|direntry-&gt;d_time
comma
id|jiffies
)paren
)paren
suffix:semicolon
id|cifsInode
op_assign
id|CIFS_I
c_func
(paren
id|direntry-&gt;d_inode
)paren
suffix:semicolon
multiline_comment|/* BB add check - do not need to revalidate oplocked files */
r_if
c_cond
(paren
id|time_before
c_func
(paren
id|jiffies
comma
id|cifsInode-&gt;time
op_plus
id|HZ
)paren
)paren
(brace
r_if
c_cond
(paren
(paren
id|S_ISREG
c_func
(paren
id|direntry-&gt;d_inode-&gt;i_mode
)paren
op_eq
l_int|0
)paren
op_logical_or
(paren
id|direntry-&gt;d_inode-&gt;i_nlink
op_eq
l_int|1
)paren
op_logical_or
(paren
id|lookupCacheEnabled
op_eq
l_int|0
)paren
)paren
(brace
r_if
c_cond
(paren
id|full_path
)paren
id|kfree
c_func
(paren
id|full_path
)paren
suffix:semicolon
id|FreeXid
c_func
(paren
id|xid
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_else
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Have to revalidate file due to hardlinks&quot;
)paren
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|cifs_sb-&gt;tcon-&gt;ses-&gt;capabilities
op_amp
id|CAP_UNIX
)paren
id|cifs_get_inode_info_unix
c_func
(paren
op_amp
id|direntry-&gt;d_inode
comma
id|full_path
comma
id|direntry-&gt;d_sb
)paren
suffix:semicolon
r_else
id|cifs_get_inode_info
c_func
(paren
op_amp
id|direntry-&gt;d_inode
comma
id|full_path
comma
id|direntry-&gt;d_sb
)paren
suffix:semicolon
multiline_comment|/* BB if not oplocked, invalidate inode pages if mtime has changed */
r_if
c_cond
(paren
id|full_path
)paren
id|kfree
c_func
(paren
id|full_path
)paren
suffix:semicolon
id|FreeXid
c_func
(paren
id|xid
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
DECL|function|cifs_getattr
r_int
id|cifs_getattr
c_func
(paren
r_struct
id|vfsmount
op_star
id|mnt
comma
r_struct
id|dentry
op_star
id|dentry
comma
r_struct
id|kstat
op_star
id|stat
)paren
(brace
r_int
id|err
op_assign
id|cifs_revalidate
c_func
(paren
id|dentry
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|err
)paren
id|generic_fillattr
c_func
(paren
id|dentry-&gt;d_inode
comma
id|stat
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
r_void
DECL|function|cifs_truncate_file
id|cifs_truncate_file
c_func
(paren
r_struct
id|inode
op_star
id|inode
)paren
(brace
multiline_comment|/* BB remove - may not need this function after all BB */
r_int
id|xid
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_struct
id|cifsFileInfo
op_star
id|open_file
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|cifs_sb_info
op_star
id|cifs_sb
suffix:semicolon
r_struct
id|cifsTconInfo
op_star
id|pTcon
suffix:semicolon
r_struct
id|cifsInodeInfo
op_star
id|cifsInode
suffix:semicolon
r_struct
id|dentry
op_star
id|dirent
suffix:semicolon
r_char
op_star
id|full_path
op_assign
l_int|NULL
suffix:semicolon
id|xid
op_assign
id|GetXid
c_func
(paren
)paren
suffix:semicolon
id|cifs_sb
op_assign
id|CIFS_SB
c_func
(paren
id|inode-&gt;i_sb
)paren
suffix:semicolon
id|pTcon
op_assign
id|cifs_sb-&gt;tcon
suffix:semicolon
r_if
c_cond
(paren
id|list_empty
c_func
(paren
op_amp
id|inode-&gt;i_dentry
)paren
)paren
(brace
id|cERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Can not get pathname from empty dentry in inode 0x%p &quot;
comma
id|inode
)paren
)paren
suffix:semicolon
id|FreeXid
c_func
(paren
id|xid
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
id|dirent
op_assign
id|list_entry
c_func
(paren
id|inode-&gt;i_dentry.next
comma
r_struct
id|dentry
comma
id|d_alias
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dirent
)paren
(brace
id|full_path
op_assign
id|build_path_from_dentry
c_func
(paren
id|dirent
)paren
suffix:semicolon
id|rc
op_assign
id|CIFSSMBSetEOF
c_func
(paren
id|xid
comma
id|pTcon
comma
id|full_path
comma
id|inode-&gt;i_size
comma
id|FALSE
comma
id|cifs_sb-&gt;local_nls
)paren
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot; SetEOF (truncate) rc = %d&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
op_minus
id|ETXTBSY
)paren
(brace
id|cifsInode
op_assign
id|CIFS_I
c_func
(paren
id|inode
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
(paren
id|cifsInode-&gt;openFileList
)paren
)paren
)paren
(brace
id|open_file
op_assign
id|list_entry
c_func
(paren
id|cifsInode-&gt;openFileList.next
comma
r_struct
id|cifsFileInfo
comma
id|flist
)paren
suffix:semicolon
multiline_comment|/* We could check if file is open for writing first */
id|rc
op_assign
id|CIFSSMBSetFileSize
c_func
(paren
id|xid
comma
id|pTcon
comma
id|inode-&gt;i_size
comma
id|open_file-&gt;netfid
comma
id|open_file-&gt;pid
comma
id|FALSE
)paren
suffix:semicolon
)brace
r_else
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot; No open files to get file handle from&quot;
)paren
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|rc
)paren
id|CIFSSMBSetEOF
c_func
(paren
id|xid
comma
id|pTcon
comma
id|full_path
comma
id|inode-&gt;i_size
comma
id|TRUE
comma
id|cifs_sb-&gt;local_nls
)paren
suffix:semicolon
multiline_comment|/* allocation size setting seems optional so ignore return code */
)brace
r_if
c_cond
(paren
id|full_path
)paren
id|kfree
c_func
(paren
id|full_path
)paren
suffix:semicolon
id|FreeXid
c_func
(paren
id|xid
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
DECL|function|cifs_trunc_page
r_static
r_int
id|cifs_trunc_page
c_func
(paren
r_struct
id|address_space
op_star
id|mapping
comma
id|loff_t
id|from
)paren
(brace
id|pgoff_t
id|index
op_assign
id|from
op_rshift
id|PAGE_CACHE_SHIFT
suffix:semicolon
r_int
id|offset
op_assign
id|from
op_amp
(paren
id|PAGE_CACHE_SIZE
op_minus
l_int|1
)paren
suffix:semicolon
r_struct
id|page
op_star
id|page
suffix:semicolon
r_char
op_star
id|kaddr
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|page
op_assign
id|grab_cache_page
c_func
(paren
id|mapping
comma
id|index
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|page
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|kaddr
op_assign
id|kmap_atomic
c_func
(paren
id|page
comma
id|KM_USER0
)paren
suffix:semicolon
id|memset
c_func
(paren
id|kaddr
op_plus
id|offset
comma
l_int|0
comma
id|PAGE_CACHE_SIZE
op_minus
id|offset
)paren
suffix:semicolon
id|flush_dcache_page
c_func
(paren
id|page
)paren
suffix:semicolon
id|kunmap_atomic
c_func
(paren
id|kaddr
comma
id|KM_USER0
)paren
suffix:semicolon
id|set_page_dirty
c_func
(paren
id|page
)paren
suffix:semicolon
id|unlock_page
c_func
(paren
id|page
)paren
suffix:semicolon
id|page_cache_release
c_func
(paren
id|page
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_int
DECL|function|cifs_setattr
id|cifs_setattr
c_func
(paren
r_struct
id|dentry
op_star
id|direntry
comma
r_struct
id|iattr
op_star
id|attrs
)paren
(brace
r_int
id|xid
suffix:semicolon
r_struct
id|cifs_sb_info
op_star
id|cifs_sb
suffix:semicolon
r_struct
id|cifsTconInfo
op_star
id|pTcon
suffix:semicolon
r_char
op_star
id|full_path
op_assign
l_int|NULL
suffix:semicolon
r_int
id|rc
op_assign
op_minus
id|EACCES
suffix:semicolon
r_struct
id|cifsFileInfo
op_star
id|open_file
op_assign
l_int|NULL
suffix:semicolon
id|FILE_BASIC_INFO
id|time_buf
suffix:semicolon
r_int
id|set_time
op_assign
id|FALSE
suffix:semicolon
id|__u64
id|mode
op_assign
l_int|0xFFFFFFFFFFFFFFFFULL
suffix:semicolon
id|__u64
id|uid
op_assign
l_int|0xFFFFFFFFFFFFFFFFULL
suffix:semicolon
id|__u64
id|gid
op_assign
l_int|0xFFFFFFFFFFFFFFFFULL
suffix:semicolon
r_struct
id|cifsInodeInfo
op_star
id|cifsInode
suffix:semicolon
id|xid
op_assign
id|GetXid
c_func
(paren
)paren
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot; In cifs_setattr, name = %s attrs-&gt;iavalid 0x%x &quot;
comma
id|direntry-&gt;d_name.name
comma
id|attrs-&gt;ia_valid
)paren
)paren
suffix:semicolon
id|cifs_sb
op_assign
id|CIFS_SB
c_func
(paren
id|direntry-&gt;d_inode-&gt;i_sb
)paren
suffix:semicolon
id|pTcon
op_assign
id|cifs_sb-&gt;tcon
suffix:semicolon
id|full_path
op_assign
id|build_path_from_dentry
c_func
(paren
id|direntry
)paren
suffix:semicolon
id|cifsInode
op_assign
id|CIFS_I
c_func
(paren
id|direntry-&gt;d_inode
)paren
suffix:semicolon
multiline_comment|/* BB check if we need to refresh inode from server now ? BB */
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot; Changing attributes 0x%x&quot;
comma
id|attrs-&gt;ia_valid
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|attrs-&gt;ia_valid
op_amp
id|ATTR_SIZE
)paren
(brace
id|rc
op_assign
id|CIFSSMBSetEOF
c_func
(paren
id|xid
comma
id|pTcon
comma
id|full_path
comma
id|attrs-&gt;ia_size
comma
id|FALSE
comma
id|cifs_sb-&gt;local_nls
)paren
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot; SetEOF (setattrs) rc = %d&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
op_minus
id|ETXTBSY
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
(paren
id|cifsInode-&gt;openFileList
)paren
)paren
)paren
(brace
id|open_file
op_assign
id|list_entry
c_func
(paren
id|cifsInode-&gt;openFileList.next
comma
r_struct
id|cifsFileInfo
comma
id|flist
)paren
suffix:semicolon
multiline_comment|/* We could check if file is open for writing first */
id|rc
op_assign
id|CIFSSMBSetFileSize
c_func
(paren
id|xid
comma
id|pTcon
comma
id|attrs-&gt;ia_size
comma
id|open_file-&gt;netfid
comma
id|open_file-&gt;pid
comma
id|FALSE
)paren
suffix:semicolon
)brace
r_else
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot; No open files to get file handle from&quot;
)paren
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*  For Allocation Size - do not need to call the following&n;            it did not hurt if it fails but why bother */
multiline_comment|/*&t;CIFSSMBSetEOF(xid, pTcon, full_path, attrs-&gt;ia_size, TRUE, cifs_sb-&gt;local_nls);*/
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
)paren
(brace
id|rc
op_assign
id|vmtruncate
c_func
(paren
id|direntry-&gt;d_inode
comma
id|attrs-&gt;ia_size
)paren
suffix:semicolon
id|cifs_trunc_page
c_func
(paren
id|direntry-&gt;d_inode-&gt;i_mapping
comma
id|direntry-&gt;d_inode-&gt;i_size
)paren
suffix:semicolon
multiline_comment|/*          cFYI(1,(&quot;truncate_page to 0x%lx &bslash;n&quot;,direntry-&gt;d_inode-&gt;i_size)); */
)brace
)brace
r_if
c_cond
(paren
id|attrs-&gt;ia_valid
op_amp
id|ATTR_UID
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot; CIFS - UID changed to %d&quot;
comma
id|attrs-&gt;ia_uid
)paren
)paren
suffix:semicolon
id|uid
op_assign
id|attrs-&gt;ia_uid
suffix:semicolon
multiline_comment|/*        entry-&gt;uid = cpu_to_le16(attr-&gt;ia_uid); */
)brace
r_if
c_cond
(paren
id|attrs-&gt;ia_valid
op_amp
id|ATTR_GID
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot; CIFS - GID changed to %d&quot;
comma
id|attrs-&gt;ia_gid
)paren
)paren
suffix:semicolon
id|gid
op_assign
id|attrs-&gt;ia_gid
suffix:semicolon
multiline_comment|/*      entry-&gt;gid = cpu_to_le16(attr-&gt;ia_gid); */
)brace
id|time_buf.Attributes
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|attrs-&gt;ia_valid
op_amp
id|ATTR_MODE
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot; CIFS - Mode changed to 0x%x&quot;
comma
id|attrs-&gt;ia_mode
)paren
)paren
suffix:semicolon
id|mode
op_assign
id|attrs-&gt;ia_mode
suffix:semicolon
multiline_comment|/* entry-&gt;mode = cpu_to_le16(attr-&gt;ia_mode); */
)brace
r_if
c_cond
(paren
(paren
id|cifs_sb-&gt;tcon-&gt;ses-&gt;capabilities
op_amp
id|CAP_UNIX
)paren
op_logical_and
(paren
id|attrs-&gt;ia_valid
op_amp
(paren
id|ATTR_MODE
op_or
id|ATTR_GID
op_or
id|ATTR_UID
)paren
)paren
)paren
id|rc
op_assign
id|CIFSSMBUnixSetPerms
c_func
(paren
id|xid
comma
id|pTcon
comma
id|full_path
comma
id|mode
comma
id|uid
comma
id|gid
comma
l_int|0
multiline_comment|/* dev_t */
comma
id|cifs_sb-&gt;local_nls
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|attrs-&gt;ia_valid
op_amp
id|ATTR_MODE
)paren
(brace
r_if
c_cond
(paren
(paren
id|mode
op_amp
id|S_IWUGO
)paren
op_eq
l_int|0
)paren
multiline_comment|/* not writeable */
(brace
r_if
c_cond
(paren
(paren
id|cifsInode-&gt;cifsAttrs
op_amp
id|ATTR_READONLY
)paren
op_eq
l_int|0
)paren
(brace
id|time_buf.Attributes
op_assign
id|cpu_to_le32
c_func
(paren
id|cifsInode-&gt;cifsAttrs
op_or
id|ATTR_READONLY
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
(paren
id|mode
op_amp
id|S_IWUGO
)paren
op_eq
id|S_IWUGO
)paren
(brace
r_if
c_cond
(paren
id|cifsInode-&gt;cifsAttrs
op_amp
id|ATTR_READONLY
)paren
(brace
id|time_buf.Attributes
op_assign
id|cpu_to_le32
c_func
(paren
id|cifsInode-&gt;cifsAttrs
op_amp
(paren
op_complement
id|ATTR_READONLY
)paren
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* BB to be implemented - via Windows security descriptors or streams */
multiline_comment|/* CIFSSMBWinSetPerms(xid,pTcon,full_path,mode,uid,gid,cifs_sb-&gt;local_nls);*/
)brace
r_if
c_cond
(paren
id|attrs-&gt;ia_valid
op_amp
id|ATTR_ATIME
)paren
(brace
id|set_time
op_assign
id|TRUE
suffix:semicolon
id|time_buf.LastAccessTime
op_assign
id|cpu_to_le64
c_func
(paren
id|cifs_UnixTimeToNT
c_func
(paren
id|attrs-&gt;ia_atime
)paren
)paren
suffix:semicolon
)brace
r_else
id|time_buf.LastAccessTime
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|attrs-&gt;ia_valid
op_amp
id|ATTR_MTIME
)paren
(brace
id|set_time
op_assign
id|TRUE
suffix:semicolon
id|time_buf.LastWriteTime
op_assign
id|cpu_to_le64
c_func
(paren
id|cifs_UnixTimeToNT
c_func
(paren
id|attrs-&gt;ia_mtime
)paren
)paren
suffix:semicolon
)brace
r_else
id|time_buf.LastWriteTime
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|attrs-&gt;ia_valid
op_amp
id|ATTR_CTIME
)paren
(brace
id|set_time
op_assign
id|TRUE
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot; CIFS - CTIME changed &quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* BB probably do not need */
id|time_buf.ChangeTime
op_assign
id|cpu_to_le64
c_func
(paren
id|cifs_UnixTimeToNT
c_func
(paren
id|attrs-&gt;ia_ctime
)paren
)paren
suffix:semicolon
)brace
r_else
id|time_buf.ChangeTime
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|set_time
op_or
id|time_buf.Attributes
)paren
(brace
multiline_comment|/* BB what if setting one attribute fails  &n;&t;&t;&t;(such as size) but time setting works */
id|time_buf.CreationTime
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* do not change */
id|rc
op_assign
id|CIFSSMBSetTimes
c_func
(paren
id|xid
comma
id|pTcon
comma
id|full_path
comma
op_amp
id|time_buf
comma
id|cifs_sb-&gt;local_nls
)paren
suffix:semicolon
)brace
multiline_comment|/* do not  need local check to inode_check_ok since the server does that */
id|inode_setattr
c_func
(paren
id|direntry-&gt;d_inode
comma
id|attrs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|full_path
)paren
id|kfree
c_func
(paren
id|full_path
)paren
suffix:semicolon
id|FreeXid
c_func
(paren
id|xid
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_void
DECL|function|cifs_delete_inode
id|cifs_delete_inode
c_func
(paren
r_struct
id|inode
op_star
id|inode
)paren
(brace
multiline_comment|/* Note: called without the big kernel filelock - remember spinlocks! */
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;In cifs_delete_inode, inode = 0x%p &quot;
comma
id|inode
)paren
)paren
suffix:semicolon
multiline_comment|/* may have to add back in when safe distributed caching of&n;             directories via e.g. FindNotify added */
)brace
eof
