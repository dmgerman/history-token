multiline_comment|/*&n; *   fs/cifs/connect.c&n; *&n; *   Copyright (C) International Business Machines  Corp., 2002,2004&n; *   Author(s): Steve French (sfrench@us.ibm.com)&n; *&n; *   This library is free software; you can redistribute it and/or modify&n; *   it under the terms of the GNU Lesser General Public License as published&n; *   by the Free Software Foundation; either version 2.1 of the License, or&n; *   (at your option) any later version.&n; *&n; *   This library is distributed in the hope that it will be useful,&n; *   but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See&n; *   the GNU Lesser General Public License for more details.&n; *&n; *   You should have received a copy of the GNU Lesser General Public License&n; *   along with this library; if not, write to the Free Software&n; *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA &n; */
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/net.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/list.h&gt;
macro_line|#include &lt;linux/wait.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/ipv6.h&gt;
macro_line|#include &lt;linux/pagemap.h&gt;
macro_line|#include &lt;linux/ctype.h&gt;
macro_line|#include &lt;linux/utsname.h&gt;
macro_line|#include &lt;linux/mempool.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/processor.h&gt;
macro_line|#include &quot;cifspdu.h&quot;
macro_line|#include &quot;cifsglob.h&quot;
macro_line|#include &quot;cifsproto.h&quot;
macro_line|#include &quot;cifs_unicode.h&quot;
macro_line|#include &quot;cifs_debug.h&quot;
macro_line|#include &quot;cifs_fs_sb.h&quot;
macro_line|#include &quot;ntlmssp.h&quot;
macro_line|#include &quot;nterr.h&quot;
macro_line|#include &quot;rfc1002pdu.h&quot;
DECL|macro|CIFS_PORT
mdefine_line|#define CIFS_PORT 445
DECL|macro|RFC1001_PORT
mdefine_line|#define RFC1001_PORT 139
r_extern
r_void
id|SMBencrypt
c_func
(paren
r_int
r_char
op_star
id|passwd
comma
r_int
r_char
op_star
id|c8
comma
r_int
r_char
op_star
id|p24
)paren
suffix:semicolon
r_extern
r_void
id|SMBNTencrypt
c_func
(paren
r_int
r_char
op_star
id|passwd
comma
r_int
r_char
op_star
id|c8
comma
r_int
r_char
op_star
id|p24
)paren
suffix:semicolon
r_extern
r_int
id|cifs_inet_pton
c_func
(paren
r_int
comma
r_const
r_char
op_star
comma
r_void
op_star
id|dst
)paren
suffix:semicolon
r_extern
id|mempool_t
op_star
id|cifs_req_poolp
suffix:semicolon
DECL|struct|smb_vol
r_struct
id|smb_vol
(brace
DECL|member|username
r_char
op_star
id|username
suffix:semicolon
DECL|member|password
r_char
op_star
id|password
suffix:semicolon
DECL|member|domainname
r_char
op_star
id|domainname
suffix:semicolon
DECL|member|UNC
r_char
op_star
id|UNC
suffix:semicolon
DECL|member|UNCip
r_char
op_star
id|UNCip
suffix:semicolon
DECL|member|iocharset
r_char
op_star
id|iocharset
suffix:semicolon
multiline_comment|/* local code page for mapping to and from Unicode */
DECL|member|source_rfc1001_name
r_char
id|source_rfc1001_name
(braket
l_int|16
)braket
suffix:semicolon
multiline_comment|/* netbios name of client */
DECL|member|linux_uid
id|uid_t
id|linux_uid
suffix:semicolon
DECL|member|linux_gid
id|gid_t
id|linux_gid
suffix:semicolon
DECL|member|file_mode
id|mode_t
id|file_mode
suffix:semicolon
DECL|member|dir_mode
id|mode_t
id|dir_mode
suffix:semicolon
DECL|member|rw
r_int
id|rw
suffix:colon
l_int|1
suffix:semicolon
DECL|member|retry
r_int
id|retry
suffix:colon
l_int|1
suffix:semicolon
DECL|member|intr
r_int
id|intr
suffix:colon
l_int|1
suffix:semicolon
DECL|member|setuids
r_int
id|setuids
suffix:colon
l_int|1
suffix:semicolon
DECL|member|noperm
r_int
id|noperm
suffix:colon
l_int|1
suffix:semicolon
DECL|member|no_psx_acl
r_int
id|no_psx_acl
suffix:colon
l_int|1
suffix:semicolon
multiline_comment|/* set if posix acl support should be disabled */
DECL|member|server_ino
r_int
id|server_ino
suffix:colon
l_int|1
suffix:semicolon
multiline_comment|/* use inode numbers from server ie UniqueId */
DECL|member|direct_io
r_int
id|direct_io
suffix:colon
l_int|1
suffix:semicolon
DECL|member|rsize
r_int
r_int
id|rsize
suffix:semicolon
DECL|member|wsize
r_int
r_int
id|wsize
suffix:semicolon
DECL|member|sockopt
r_int
r_int
id|sockopt
suffix:semicolon
DECL|member|port
r_int
r_int
r_int
id|port
suffix:semicolon
)brace
suffix:semicolon
r_static
r_int
id|ipv4_connect
c_func
(paren
r_struct
id|sockaddr_in
op_star
id|psin_server
comma
r_struct
id|socket
op_star
op_star
id|csocket
comma
r_char
op_star
id|netb_name
)paren
suffix:semicolon
r_static
r_int
id|ipv6_connect
c_func
(paren
r_struct
id|sockaddr_in6
op_star
id|psin_server
comma
r_struct
id|socket
op_star
op_star
id|csocket
)paren
suffix:semicolon
multiline_comment|/* &n;&t; * cifs tcp session reconnection&n;&t; * &n;&t; * mark tcp session as reconnecting so temporarily locked&n;&t; * mark all smb sessions as reconnecting for tcp session&n;&t; * reconnect tcp session&n;&t; * wake up waiters on reconnection? - (not needed currently)&n;&t; */
r_int
DECL|function|cifs_reconnect
id|cifs_reconnect
c_func
(paren
r_struct
id|TCP_Server_Info
op_star
id|server
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_struct
id|list_head
op_star
id|tmp
suffix:semicolon
r_struct
id|cifsSesInfo
op_star
id|ses
suffix:semicolon
r_struct
id|cifsTconInfo
op_star
id|tcon
suffix:semicolon
r_struct
id|mid_q_entry
op_star
id|mid_entry
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|GlobalMid_Lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|server-&gt;tcpStatus
op_eq
id|CifsExiting
)paren
(brace
multiline_comment|/* the demux thread will exit normally &n;&t;&t;next time through the loop */
id|spin_unlock
c_func
(paren
op_amp
id|GlobalMid_Lock
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_else
id|server-&gt;tcpStatus
op_assign
id|CifsNeedReconnect
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|GlobalMid_Lock
)paren
suffix:semicolon
id|server-&gt;maxBuf
op_assign
l_int|0
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Reconnecting tcp session &quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* before reconnecting the tcp session, mark the smb session (uid)&n;&t;&t;and the tid bad so they are not used until reconnected */
id|read_lock
c_func
(paren
op_amp
id|GlobalSMBSeslock
)paren
suffix:semicolon
id|list_for_each
c_func
(paren
id|tmp
comma
op_amp
id|GlobalSMBSessionList
)paren
(brace
id|ses
op_assign
id|list_entry
c_func
(paren
id|tmp
comma
r_struct
id|cifsSesInfo
comma
id|cifsSessionList
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ses-&gt;server
)paren
(brace
r_if
c_cond
(paren
id|ses-&gt;server
op_eq
id|server
)paren
(brace
id|ses-&gt;status
op_assign
id|CifsNeedReconnect
suffix:semicolon
id|ses-&gt;ipc_tid
op_assign
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/* else tcp and smb sessions need reconnection */
)brace
id|list_for_each
c_func
(paren
id|tmp
comma
op_amp
id|GlobalTreeConnectionList
)paren
(brace
id|tcon
op_assign
id|list_entry
c_func
(paren
id|tmp
comma
r_struct
id|cifsTconInfo
comma
id|cifsConnectionList
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|tcon
)paren
op_logical_and
(paren
id|tcon-&gt;ses
)paren
op_logical_and
(paren
id|tcon-&gt;ses-&gt;server
op_eq
id|server
)paren
)paren
(brace
id|tcon-&gt;tidStatus
op_assign
id|CifsNeedReconnect
suffix:semicolon
)brace
)brace
id|read_unlock
c_func
(paren
op_amp
id|GlobalSMBSeslock
)paren
suffix:semicolon
multiline_comment|/* do not want to be sending data on a socket we are freeing */
id|down
c_func
(paren
op_amp
id|server-&gt;tcpSem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|server-&gt;ssocket
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;State: 0x%x Flags: 0x%lx&quot;
comma
id|server-&gt;ssocket-&gt;state
comma
id|server-&gt;ssocket-&gt;flags
)paren
)paren
suffix:semicolon
id|server-&gt;ssocket-&gt;ops
op_member_access_from_pointer
id|shutdown
c_func
(paren
id|server-&gt;ssocket
comma
id|SEND_SHUTDOWN
)paren
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Post shutdown state: 0x%x Flags: 0x%lx&quot;
comma
id|server-&gt;ssocket-&gt;state
comma
id|server-&gt;ssocket-&gt;flags
)paren
)paren
suffix:semicolon
id|sock_release
c_func
(paren
id|server-&gt;ssocket
)paren
suffix:semicolon
id|server-&gt;ssocket
op_assign
l_int|NULL
suffix:semicolon
)brace
id|spin_lock
c_func
(paren
op_amp
id|GlobalMid_Lock
)paren
suffix:semicolon
id|list_for_each
c_func
(paren
id|tmp
comma
op_amp
id|server-&gt;pending_mid_q
)paren
(brace
id|mid_entry
op_assign
id|list_entry
c_func
(paren
id|tmp
comma
r_struct
id|mid_q_entry
comma
id|qhead
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mid_entry
)paren
(brace
r_if
c_cond
(paren
id|mid_entry-&gt;midState
op_eq
id|MID_REQUEST_SUBMITTED
)paren
(brace
multiline_comment|/* Mark other intransit requests as needing retry so &n;&t;&t;&t;&t;  we do not immediately mark the session bad again &n;&t;&t;&t;&t;  (ie after we reconnect below) as they timeout too */
id|mid_entry-&gt;midState
op_assign
id|MID_RETRY_NEEDED
suffix:semicolon
)brace
)brace
)brace
id|spin_unlock
c_func
(paren
op_amp
id|GlobalMid_Lock
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|server-&gt;tcpSem
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|server-&gt;tcpStatus
op_ne
id|CifsExiting
)paren
op_logical_and
(paren
id|server-&gt;tcpStatus
op_ne
id|CifsGood
)paren
)paren
(brace
r_if
c_cond
(paren
id|server-&gt;protocolType
op_eq
id|IPV6
)paren
(brace
id|rc
op_assign
id|ipv6_connect
c_func
(paren
op_amp
id|server-&gt;addr.sockAddr6
comma
op_amp
id|server-&gt;ssocket
)paren
suffix:semicolon
)brace
r_else
(brace
id|rc
op_assign
id|ipv4_connect
c_func
(paren
op_amp
id|server-&gt;addr.sockAddr
comma
op_amp
id|server-&gt;ssocket
comma
id|server-&gt;workstation_RFC1001_name
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rc
)paren
(brace
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
l_int|3
op_star
id|HZ
)paren
suffix:semicolon
)brace
r_else
(brace
id|atomic_inc
c_func
(paren
op_amp
id|tcpSesReconnectCount
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|GlobalMid_Lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|server-&gt;tcpStatus
op_ne
id|CifsExiting
)paren
(brace
id|server-&gt;tcpStatus
op_assign
id|CifsGood
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|GlobalMid_Lock
)paren
suffix:semicolon
multiline_comment|/*&t;&t;atomic_set(&amp;server-&gt;inFlight,0);*/
id|wake_up
c_func
(paren
op_amp
id|server-&gt;response_q
)paren
suffix:semicolon
)brace
)brace
r_return
id|rc
suffix:semicolon
)brace
r_static
r_int
DECL|function|cifs_demultiplex_thread
id|cifs_demultiplex_thread
c_func
(paren
r_struct
id|TCP_Server_Info
op_star
id|server
)paren
(brace
r_int
id|length
suffix:semicolon
r_int
r_int
id|pdu_length
comma
id|total_read
suffix:semicolon
r_struct
id|smb_hdr
op_star
id|smb_buffer
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|msghdr
id|smb_msg
suffix:semicolon
r_struct
id|kvec
id|iov
suffix:semicolon
r_struct
id|socket
op_star
id|csocket
op_assign
id|server-&gt;ssocket
suffix:semicolon
r_struct
id|list_head
op_star
id|tmp
suffix:semicolon
r_struct
id|cifsSesInfo
op_star
id|ses
suffix:semicolon
r_struct
id|task_struct
op_star
id|task_to_wake
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|mid_q_entry
op_star
id|mid_entry
suffix:semicolon
r_char
op_star
id|temp
suffix:semicolon
id|daemonize
c_func
(paren
l_string|&quot;cifsd&quot;
)paren
suffix:semicolon
id|allow_signal
c_func
(paren
id|SIGKILL
)paren
suffix:semicolon
id|current-&gt;flags
op_or_assign
id|PF_MEMALLOC
suffix:semicolon
id|server-&gt;tsk
op_assign
id|current
suffix:semicolon
multiline_comment|/* save process info to wake at shutdown */
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Demultiplex PID: %d&quot;
comma
id|current-&gt;pid
)paren
)paren
suffix:semicolon
id|write_lock
c_func
(paren
op_amp
id|GlobalSMBSeslock
)paren
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|tcpSesAllocCount
)paren
suffix:semicolon
id|length
op_assign
id|tcpSesAllocCount.counter
suffix:semicolon
id|write_unlock
c_func
(paren
op_amp
id|GlobalSMBSeslock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|length
OG
l_int|1
)paren
(brace
id|mempool_resize
c_func
(paren
id|cifs_req_poolp
comma
id|length
op_plus
id|CIFS_MIN_RCV_POOL
comma
id|GFP_KERNEL
)paren
suffix:semicolon
)brace
r_while
c_loop
(paren
id|server-&gt;tcpStatus
op_ne
id|CifsExiting
)paren
(brace
r_if
c_cond
(paren
id|smb_buffer
op_eq
l_int|NULL
)paren
id|smb_buffer
op_assign
id|cifs_buf_get
c_func
(paren
)paren
suffix:semicolon
r_else
id|memset
c_func
(paren
id|smb_buffer
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|smb_hdr
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|smb_buffer
op_eq
l_int|NULL
)paren
(brace
id|cERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Can not get memory for SMB response&quot;
)paren
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|HZ
op_star
l_int|3
)paren
suffix:semicolon
multiline_comment|/* give system time to free memory */
r_continue
suffix:semicolon
)brace
id|iov.iov_base
op_assign
id|smb_buffer
suffix:semicolon
id|iov.iov_len
op_assign
r_sizeof
(paren
r_struct
id|smb_hdr
)paren
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* 1 byte less above since wct is not always returned in error cases */
id|smb_msg.msg_control
op_assign
l_int|NULL
suffix:semicolon
id|smb_msg.msg_controllen
op_assign
l_int|0
suffix:semicolon
id|length
op_assign
id|kernel_recvmsg
c_func
(paren
id|csocket
comma
op_amp
id|smb_msg
comma
op_amp
id|iov
comma
l_int|1
comma
r_sizeof
(paren
r_struct
id|smb_hdr
)paren
op_minus
l_int|1
multiline_comment|/* RFC1001 header and SMB header */
comma
id|MSG_PEEK
multiline_comment|/* flags see socket.h */
)paren
suffix:semicolon
r_if
c_cond
(paren
id|server-&gt;tcpStatus
op_eq
id|CifsExiting
)paren
(brace
r_break
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|server-&gt;tcpStatus
op_eq
id|CifsNeedReconnect
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Reconnecting after server stopped responding&quot;
)paren
)paren
suffix:semicolon
id|cifs_reconnect
c_func
(paren
id|server
)paren
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;call to reconnect done&quot;
)paren
)paren
suffix:semicolon
id|csocket
op_assign
id|server-&gt;ssocket
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|length
op_eq
op_minus
id|ERESTARTSYS
)paren
op_logical_or
(paren
id|length
op_eq
op_minus
id|EAGAIN
)paren
)paren
(brace
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* minimum sleep to prevent looping&n;&t;&t;&t;&t;allowing socket to clear and app threads to set&n;&t;&t;&t;&t;tcpStatus CifsNeedReconnect if server hung */
r_continue
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|length
op_le
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|server-&gt;tcpStatus
op_eq
id|CifsNew
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;tcp session abended prematurely (after SMBnegprot)&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* some servers kill tcp session rather than returning&n;&t;&t;&t;&t;&t;smb negprot error in which case reconnecting here is&n;&t;&t;&t;&t;&t;not going to help - return error to mount */
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|length
op_eq
op_minus
id|EINTR
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;cifsd thread killed&quot;
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Reconnecting after unexpected peek error %d&quot;
comma
id|length
)paren
)paren
suffix:semicolon
id|cifs_reconnect
c_func
(paren
id|server
)paren
suffix:semicolon
id|csocket
op_assign
id|server-&gt;ssocket
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|server-&gt;response_q
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|pdu_length
op_assign
l_int|4
op_plus
id|ntohl
c_func
(paren
id|smb_buffer-&gt;smb_buf_length
)paren
suffix:semicolon
multiline_comment|/* Ony read pdu_length after below checks for too short (due&n;&t;&t;   to e.g. int overflow) and too long ie beyond end of buf */
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Peek length rcvd: 0x%x beginning 0x%x)&quot;
comma
id|length
comma
id|pdu_length
)paren
)paren
suffix:semicolon
id|temp
op_assign
(paren
r_char
op_star
)paren
id|smb_buffer
suffix:semicolon
r_if
c_cond
(paren
id|length
OG
l_int|3
)paren
(brace
r_if
c_cond
(paren
id|temp
(braket
l_int|0
)braket
op_eq
(paren
r_char
)paren
id|RFC1002_SESSION_KEEP_ALIVE
)paren
(brace
id|iov.iov_base
op_assign
id|smb_buffer
suffix:semicolon
id|iov.iov_len
op_assign
l_int|4
suffix:semicolon
id|length
op_assign
id|kernel_recvmsg
c_func
(paren
id|csocket
comma
op_amp
id|smb_msg
comma
op_amp
id|iov
comma
l_int|1
comma
l_int|4
comma
l_int|0
)paren
suffix:semicolon
id|cFYI
c_func
(paren
l_int|0
comma
(paren
l_string|&quot;Received 4 byte keep alive packet&quot;
)paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|temp
(braket
l_int|0
)braket
op_eq
(paren
r_char
)paren
id|RFC1002_POSITIVE_SESSION_RESPONSE
)paren
(brace
id|iov.iov_base
op_assign
id|smb_buffer
suffix:semicolon
id|iov.iov_len
op_assign
l_int|4
suffix:semicolon
id|length
op_assign
id|kernel_recvmsg
c_func
(paren
id|csocket
comma
op_amp
id|smb_msg
comma
op_amp
id|iov
comma
l_int|1
comma
l_int|4
comma
l_int|0
)paren
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Good RFC 1002 session rsp&quot;
)paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|temp
(braket
l_int|0
)braket
op_eq
(paren
r_char
)paren
id|RFC1002_NEGATIVE_SESSION_RESPONSE
)paren
op_logical_and
(paren
id|length
op_eq
l_int|5
)paren
)paren
(brace
multiline_comment|/* we get this from Windows 98 instead of error on SMB negprot response */
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Negative RFC 1002 Session Response Error 0x%x)&quot;
comma
id|temp
(braket
l_int|4
)braket
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|server-&gt;tcpStatus
op_eq
id|CifsNew
)paren
(brace
multiline_comment|/* if nack on negprot (rather than &n;&t;&t;&t;&t;&t;ret of smb negprot error) reconnecting&n;&t;&t;&t;&t;&t;not going to help, ret error to mount */
r_break
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* give server a second to&n;&t;&t;&t;&t;&t;clean up before reconnect attempt */
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|HZ
)paren
suffix:semicolon
multiline_comment|/* always try 445 first on reconnect&n;&t;&t;&t;&t;&t;since we get NACK on some if we ever&n;&t;&t;&t;&t;&t;connected to port 139 (the NACK is &n;&t;&t;&t;&t;&t;since we do not begin with RFC1001&n;&t;&t;&t;&t;&t;session initialize frame) */
id|server-&gt;addr.sockAddr.sin_port
op_assign
id|htons
c_func
(paren
id|CIFS_PORT
)paren
suffix:semicolon
id|cifs_reconnect
c_func
(paren
id|server
)paren
suffix:semicolon
id|csocket
op_assign
id|server-&gt;ssocket
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|server-&gt;response_q
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|temp
(braket
l_int|0
)braket
op_ne
(paren
r_char
)paren
l_int|0
)paren
(brace
id|cERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Unknown RFC 1002 frame&quot;
)paren
)paren
suffix:semicolon
id|cifs_dump_mem
c_func
(paren
l_string|&quot; Received Data: &quot;
comma
id|temp
comma
id|length
)paren
suffix:semicolon
id|cifs_reconnect
c_func
(paren
id|server
)paren
suffix:semicolon
id|csocket
op_assign
id|server-&gt;ssocket
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
(paren
id|length
op_ne
r_sizeof
(paren
r_struct
id|smb_hdr
)paren
op_minus
l_int|1
)paren
op_logical_or
(paren
id|pdu_length
OG
id|CIFS_MAX_MSGSIZE
op_plus
id|MAX_CIFS_HDR_SIZE
)paren
op_logical_or
(paren
id|pdu_length
OL
r_sizeof
(paren
r_struct
id|smb_hdr
)paren
op_minus
l_int|1
)paren
op_logical_or
(paren
id|checkSMBhdr
(paren
id|smb_buffer
comma
id|smb_buffer-&gt;Mid
)paren
)paren
)paren
(brace
id|cERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Invalid size or format for SMB found with length %d and pdu_length %d&quot;
comma
id|length
comma
id|pdu_length
)paren
)paren
suffix:semicolon
id|cifs_dump_mem
c_func
(paren
l_string|&quot;Received Data is: &quot;
comma
id|temp
comma
r_sizeof
(paren
r_struct
id|smb_hdr
)paren
)paren
suffix:semicolon
multiline_comment|/* could we fix this network corruption by finding next &n;&t;&t;&t;&t;&t;&t;smb header (instead of killing the session) and&n;&t;&t;&t;&t;&t;&t;restart reading from next valid SMB found? */
id|cifs_reconnect
c_func
(paren
id|server
)paren
suffix:semicolon
id|csocket
op_assign
id|server-&gt;ssocket
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* length ok */
id|length
op_assign
l_int|0
suffix:semicolon
id|iov.iov_base
op_assign
id|smb_buffer
suffix:semicolon
id|iov.iov_len
op_assign
id|pdu_length
suffix:semicolon
r_for
c_loop
(paren
id|total_read
op_assign
l_int|0
suffix:semicolon
id|total_read
OL
id|pdu_length
suffix:semicolon
id|total_read
op_add_assign
id|length
)paren
(brace
id|length
op_assign
id|kernel_recvmsg
c_func
(paren
id|csocket
comma
op_amp
id|smb_msg
comma
op_amp
id|iov
comma
l_int|1
comma
id|pdu_length
op_minus
id|total_read
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|length
op_eq
l_int|0
)paren
(brace
id|cERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Zero length receive when expecting %d &quot;
comma
id|pdu_length
op_minus
id|total_read
)paren
)paren
suffix:semicolon
id|cifs_reconnect
c_func
(paren
id|server
)paren
suffix:semicolon
id|csocket
op_assign
id|server-&gt;ssocket
suffix:semicolon
r_continue
suffix:semicolon
)brace
)brace
)brace
id|dump_smb
c_func
(paren
id|smb_buffer
comma
id|length
)paren
suffix:semicolon
r_if
c_cond
(paren
id|checkSMB
(paren
id|smb_buffer
comma
id|smb_buffer-&gt;Mid
comma
id|total_read
)paren
)paren
(brace
id|cERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Bad SMB Received &quot;
)paren
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|task_to_wake
op_assign
l_int|NULL
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|GlobalMid_Lock
)paren
suffix:semicolon
id|list_for_each
c_func
(paren
id|tmp
comma
op_amp
id|server-&gt;pending_mid_q
)paren
(brace
id|mid_entry
op_assign
id|list_entry
c_func
(paren
id|tmp
comma
r_struct
id|mid_q_entry
comma
id|qhead
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|mid_entry-&gt;mid
op_eq
id|smb_buffer-&gt;Mid
)paren
op_logical_and
(paren
id|mid_entry-&gt;midState
op_eq
id|MID_REQUEST_SUBMITTED
)paren
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot; Mid 0x%x matched - waking up &quot;
comma
id|mid_entry-&gt;mid
)paren
)paren
suffix:semicolon
id|task_to_wake
op_assign
id|mid_entry-&gt;tsk
suffix:semicolon
id|mid_entry-&gt;resp_buf
op_assign
id|smb_buffer
suffix:semicolon
id|mid_entry-&gt;midState
op_assign
id|MID_RESPONSE_RECEIVED
suffix:semicolon
)brace
)brace
id|spin_unlock
c_func
(paren
op_amp
id|GlobalMid_Lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|task_to_wake
)paren
(brace
id|smb_buffer
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* will be freed by users thread after he is done */
id|wake_up_process
c_func
(paren
id|task_to_wake
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|is_valid_oplock_break
c_func
(paren
id|smb_buffer
)paren
op_eq
id|FALSE
)paren
(brace
id|cERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;No task to wake, unknown frame rcvd!&quot;
)paren
)paren
suffix:semicolon
id|cifs_dump_mem
c_func
(paren
l_string|&quot;Received Data is: &quot;
comma
id|temp
comma
r_sizeof
(paren
r_struct
id|smb_hdr
)paren
)paren
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
id|cFYI
c_func
(paren
l_int|0
comma
(paren
l_string|&quot;Frame less than four bytes received  %d bytes long.&quot;
comma
id|length
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|length
OG
l_int|0
)paren
(brace
id|length
op_assign
id|kernel_recvmsg
c_func
(paren
id|csocket
comma
op_amp
id|smb_msg
comma
op_amp
id|iov
comma
l_int|1
comma
id|length
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* throw away junk frame */
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot; with junk  0x%x in it &quot;
comma
op_star
(paren
id|__u32
op_star
)paren
id|smb_buffer
)paren
)paren
suffix:semicolon
)brace
)brace
)brace
id|spin_lock
c_func
(paren
op_amp
id|GlobalMid_Lock
)paren
suffix:semicolon
id|server-&gt;tcpStatus
op_assign
id|CifsExiting
suffix:semicolon
id|server-&gt;tsk
op_assign
l_int|NULL
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|server-&gt;inFlight
comma
l_int|0
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|GlobalMid_Lock
)paren
suffix:semicolon
multiline_comment|/* Although there should not be any requests blocked on &n;&t;this queue it can not hurt to be paranoid and try to wake up requests&n;&t;that may haven been blocked when more than 50 at time were on the wire &n;&t;to the same server - they now will see the session is in exit state&n;&t;and get out of SendReceive.  */
id|wake_up_all
c_func
(paren
op_amp
id|server-&gt;request_q
)paren
suffix:semicolon
multiline_comment|/* give those requests time to exit */
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|HZ
op_div
l_int|8
)paren
suffix:semicolon
r_if
c_cond
(paren
id|server-&gt;ssocket
)paren
(brace
id|sock_release
c_func
(paren
id|csocket
)paren
suffix:semicolon
id|server-&gt;ssocket
op_assign
l_int|NULL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|smb_buffer
)paren
multiline_comment|/* buffer usually freed in free_mid - need to free it on error or exit */
id|cifs_buf_release
c_func
(paren
id|smb_buffer
)paren
suffix:semicolon
id|read_lock
c_func
(paren
op_amp
id|GlobalSMBSeslock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|list_empty
c_func
(paren
op_amp
id|server-&gt;pending_mid_q
)paren
)paren
(brace
multiline_comment|/* loop through server session structures attached to this and mark them dead */
id|list_for_each
c_func
(paren
id|tmp
comma
op_amp
id|GlobalSMBSessionList
)paren
(brace
id|ses
op_assign
id|list_entry
c_func
(paren
id|tmp
comma
r_struct
id|cifsSesInfo
comma
id|cifsSessionList
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ses-&gt;server
op_eq
id|server
)paren
(brace
id|ses-&gt;status
op_assign
id|CifsExiting
suffix:semicolon
id|ses-&gt;server
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
id|read_unlock
c_func
(paren
op_amp
id|GlobalSMBSeslock
)paren
suffix:semicolon
)brace
r_else
(brace
id|spin_lock
c_func
(paren
op_amp
id|GlobalMid_Lock
)paren
suffix:semicolon
id|list_for_each
c_func
(paren
id|tmp
comma
op_amp
id|server-&gt;pending_mid_q
)paren
(brace
id|mid_entry
op_assign
id|list_entry
c_func
(paren
id|tmp
comma
r_struct
id|mid_q_entry
comma
id|qhead
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mid_entry-&gt;midState
op_eq
id|MID_REQUEST_SUBMITTED
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot; Clearing Mid 0x%x - waking up &quot;
comma
id|mid_entry-&gt;mid
)paren
)paren
suffix:semicolon
id|task_to_wake
op_assign
id|mid_entry-&gt;tsk
suffix:semicolon
r_if
c_cond
(paren
id|task_to_wake
)paren
(brace
id|wake_up_process
c_func
(paren
id|task_to_wake
)paren
suffix:semicolon
)brace
)brace
)brace
id|spin_unlock
c_func
(paren
op_amp
id|GlobalMid_Lock
)paren
suffix:semicolon
id|read_unlock
c_func
(paren
op_amp
id|GlobalSMBSeslock
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
multiline_comment|/* 1/8th of sec is more than enough time for them to exit */
id|schedule_timeout
c_func
(paren
id|HZ
op_div
l_int|8
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|list_empty
c_func
(paren
op_amp
id|server-&gt;pending_mid_q
)paren
)paren
(brace
multiline_comment|/* mpx threads have not exited yet give them &n;&t;&t;at least the smb send timeout time for long ops */
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Wait for exit from demultiplex thread&quot;
)paren
)paren
suffix:semicolon
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
l_int|46
op_star
id|HZ
)paren
suffix:semicolon
multiline_comment|/* if threads still have not exited they are probably never&n;&t;&t;coming home not much else we can do but free the memory */
)brace
id|kfree
c_func
(paren
id|server
)paren
suffix:semicolon
id|write_lock
c_func
(paren
op_amp
id|GlobalSMBSeslock
)paren
suffix:semicolon
id|atomic_dec
c_func
(paren
op_amp
id|tcpSesAllocCount
)paren
suffix:semicolon
id|length
op_assign
id|tcpSesAllocCount.counter
suffix:semicolon
id|write_unlock
c_func
(paren
op_amp
id|GlobalSMBSeslock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|length
OG
l_int|0
)paren
(brace
id|mempool_resize
c_func
(paren
id|cifs_req_poolp
comma
id|length
op_plus
id|CIFS_MIN_RCV_POOL
comma
id|GFP_KERNEL
)paren
suffix:semicolon
)brace
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|HZ
op_div
l_int|4
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_void
op_star
DECL|function|cifs_kcalloc
id|cifs_kcalloc
c_func
(paren
r_int
id|size
comma
r_int
id|type
)paren
(brace
r_void
op_star
id|addr
suffix:semicolon
id|addr
op_assign
id|kmalloc
c_func
(paren
id|size
comma
id|type
)paren
suffix:semicolon
r_if
c_cond
(paren
id|addr
)paren
id|memset
c_func
(paren
id|addr
comma
l_int|0
comma
id|size
)paren
suffix:semicolon
r_return
id|addr
suffix:semicolon
)brace
r_static
r_int
DECL|function|cifs_parse_mount_options
id|cifs_parse_mount_options
c_func
(paren
r_char
op_star
id|options
comma
r_const
r_char
op_star
id|devname
comma
r_struct
id|smb_vol
op_star
id|vol
)paren
(brace
r_char
op_star
id|value
suffix:semicolon
r_char
op_star
id|data
suffix:semicolon
r_int
r_int
id|temp_len
comma
id|i
comma
id|j
suffix:semicolon
r_char
id|separator
(braket
l_int|2
)braket
suffix:semicolon
id|separator
(braket
l_int|0
)braket
op_assign
l_char|&squot;,&squot;
suffix:semicolon
id|separator
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|memset
c_func
(paren
id|vol-&gt;source_rfc1001_name
comma
l_int|0x20
comma
l_int|15
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|strnlen
c_func
(paren
id|system_utsname.nodename
comma
l_int|15
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* does not have to be a perfect mapping since the field is&n;&t;&t;informational, only used for servers that do not support&n;&t;&t;port 445 and it can be overridden at mount time */
id|vol-&gt;source_rfc1001_name
(braket
id|i
)braket
op_assign
id|toupper
c_func
(paren
id|system_utsname.nodename
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|vol-&gt;source_rfc1001_name
(braket
l_int|15
)braket
op_assign
l_int|0
suffix:semicolon
id|vol-&gt;linux_uid
op_assign
id|current-&gt;uid
suffix:semicolon
multiline_comment|/* current-&gt;euid instead? */
id|vol-&gt;linux_gid
op_assign
id|current-&gt;gid
suffix:semicolon
id|vol-&gt;dir_mode
op_assign
id|S_IRWXUGO
suffix:semicolon
multiline_comment|/* 2767 perms indicate mandatory locking support */
id|vol-&gt;file_mode
op_assign
id|S_IALLUGO
op_amp
op_complement
(paren
id|S_ISUID
op_or
id|S_IXGRP
)paren
suffix:semicolon
multiline_comment|/* vol-&gt;retry default is 0 (i.e. &quot;soft&quot; limited retry not hard retry) */
id|vol-&gt;rw
op_assign
id|TRUE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|options
)paren
r_return
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|options
comma
l_string|&quot;sep=&quot;
comma
l_int|4
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|options
(braket
l_int|4
)braket
op_ne
l_int|0
)paren
(brace
id|separator
(braket
l_int|0
)braket
op_assign
id|options
(braket
l_int|4
)braket
suffix:semicolon
id|options
op_add_assign
l_int|5
suffix:semicolon
)brace
r_else
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Null separator not allowed&quot;
)paren
)paren
suffix:semicolon
)brace
)brace
r_while
c_loop
(paren
(paren
id|data
op_assign
id|strsep
c_func
(paren
op_amp
id|options
comma
id|separator
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
op_star
id|data
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
(paren
id|value
op_assign
id|strchr
c_func
(paren
id|data
comma
l_char|&squot;=&squot;
)paren
)paren
op_ne
l_int|NULL
)paren
op_star
id|value
op_increment
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_if
c_cond
(paren
id|strnicmp
c_func
(paren
id|data
comma
l_string|&quot;user&quot;
comma
l_int|4
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|value
op_logical_or
op_logical_neg
op_star
id|value
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;CIFS: invalid or missing username&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
multiline_comment|/* needs_arg; */
)brace
r_if
c_cond
(paren
id|strnlen
c_func
(paren
id|value
comma
l_int|200
)paren
OL
l_int|200
)paren
(brace
id|vol-&gt;username
op_assign
id|value
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;CIFS: username too long&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|strnicmp
c_func
(paren
id|data
comma
l_string|&quot;pass&quot;
comma
l_int|4
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|value
op_logical_or
op_logical_neg
op_star
id|value
)paren
(brace
id|vol-&gt;password
op_assign
l_int|NULL
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|temp_len
op_assign
id|strlen
c_func
(paren
id|value
)paren
suffix:semicolon
multiline_comment|/* removed password length check, NTLM passwords&n;&t;&t;&t;&t;can be arbitrarily long */
multiline_comment|/* if comma in password, the string will be &n;&t;&t;&t;prematurely null terminated.  Commas in password are&n;&t;&t;&t;specified across the cifs mount interface by a double&n;&t;&t;&t;comma ie ,, and a comma used as in other cases ie &squot;,&squot;&n;&t;&t;&t;as a parameter delimiter/separator is single and due&n;&t;&t;&t;to the strsep above is temporarily zeroed. */
multiline_comment|/* NB: password legally can have multiple commas and&n;&t;&t;&t;the only illegal character in a password is null */
r_if
c_cond
(paren
(paren
id|value
(braket
id|temp_len
)braket
op_eq
l_int|0
)paren
op_logical_and
(paren
id|value
(braket
id|temp_len
op_plus
l_int|1
)braket
op_eq
id|separator
(braket
l_int|0
)braket
)paren
)paren
(brace
multiline_comment|/* reinsert comma */
id|value
(braket
id|temp_len
)braket
op_assign
id|separator
(braket
l_int|0
)braket
suffix:semicolon
id|temp_len
op_add_assign
l_int|2
suffix:semicolon
multiline_comment|/* move after the second comma */
r_while
c_loop
(paren
id|value
(braket
id|temp_len
)braket
op_ne
l_int|0
)paren
(brace
r_if
c_cond
(paren
(paren
id|value
(braket
id|temp_len
)braket
op_eq
id|separator
(braket
l_int|0
)braket
)paren
op_logical_and
(paren
id|value
(braket
id|temp_len
op_plus
l_int|1
)braket
op_ne
id|separator
(braket
l_int|0
)braket
)paren
)paren
(brace
multiline_comment|/* single comma indicating start of next parm */
r_break
suffix:semicolon
)brace
id|temp_len
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|value
(braket
id|temp_len
)braket
op_eq
l_int|0
)paren
(brace
id|options
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
(brace
id|value
(braket
id|temp_len
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* move options to point to start of next parm */
id|options
op_assign
id|value
op_plus
id|temp_len
op_plus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* go from value to (value + temp_len) condensing double commas to singles */
id|vol-&gt;password
op_assign
id|cifs_kcalloc
c_func
(paren
id|temp_len
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|j
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|temp_len
suffix:semicolon
id|i
op_increment
comma
id|j
op_increment
)paren
(brace
id|vol-&gt;password
(braket
id|j
)braket
op_assign
id|value
(braket
id|i
)braket
suffix:semicolon
r_if
c_cond
(paren
id|value
(braket
id|i
)braket
op_eq
id|separator
(braket
l_int|0
)braket
op_logical_and
id|value
(braket
id|i
op_plus
l_int|1
)braket
op_eq
id|separator
(braket
l_int|0
)braket
)paren
(brace
multiline_comment|/* skip second comma */
id|i
op_increment
suffix:semicolon
)brace
)brace
multiline_comment|/* value[temp_len] is zeroed above so&n;&t;&t;&t;&t;&t; vol-&gt;password[temp_len] guaranteed to be null */
)brace
r_else
(brace
id|vol-&gt;password
op_assign
id|cifs_kcalloc
c_func
(paren
id|temp_len
op_plus
l_int|1
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|vol-&gt;password
comma
id|value
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|strnicmp
c_func
(paren
id|data
comma
l_string|&quot;ip&quot;
comma
l_int|2
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|value
op_logical_or
op_logical_neg
op_star
id|value
)paren
(brace
id|vol-&gt;UNCip
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strnlen
c_func
(paren
id|value
comma
l_int|35
)paren
OL
l_int|35
)paren
(brace
id|vol-&gt;UNCip
op_assign
id|value
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;CIFS: ip address too long&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
(paren
id|strnicmp
c_func
(paren
id|data
comma
l_string|&quot;unc&quot;
comma
l_int|3
)paren
op_eq
l_int|0
)paren
op_logical_or
(paren
id|strnicmp
c_func
(paren
id|data
comma
l_string|&quot;target&quot;
comma
l_int|6
)paren
op_eq
l_int|0
)paren
op_logical_or
(paren
id|strnicmp
c_func
(paren
id|data
comma
l_string|&quot;path&quot;
comma
l_int|4
)paren
op_eq
l_int|0
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|value
op_logical_or
op_logical_neg
op_star
id|value
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;CIFS: invalid path to network resource&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
multiline_comment|/* needs_arg; */
)brace
r_if
c_cond
(paren
(paren
id|temp_len
op_assign
id|strnlen
c_func
(paren
id|value
comma
l_int|300
)paren
)paren
OL
l_int|300
)paren
(brace
id|vol-&gt;UNC
op_assign
id|kmalloc
c_func
(paren
id|temp_len
op_plus
l_int|1
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vol-&gt;UNC
op_eq
l_int|NULL
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
id|strcpy
c_func
(paren
id|vol-&gt;UNC
comma
id|value
)paren
suffix:semicolon
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|vol-&gt;UNC
comma
l_string|&quot;//&quot;
comma
l_int|2
)paren
op_eq
l_int|0
)paren
(brace
id|vol-&gt;UNC
(braket
l_int|0
)braket
op_assign
l_char|&squot;&bslash;&bslash;&squot;
suffix:semicolon
id|vol-&gt;UNC
(braket
l_int|1
)braket
op_assign
l_char|&squot;&bslash;&bslash;&squot;
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|vol-&gt;UNC
comma
l_string|&quot;&bslash;&bslash;&bslash;&bslash;&quot;
comma
l_int|2
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;CIFS: UNC Path does not begin with // or &bslash;&bslash;&bslash;&bslash; &bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;CIFS: UNC name too long&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
(paren
id|strnicmp
c_func
(paren
id|data
comma
l_string|&quot;domain&quot;
comma
l_int|3
)paren
op_eq
l_int|0
)paren
op_logical_or
(paren
id|strnicmp
c_func
(paren
id|data
comma
l_string|&quot;workgroup&quot;
comma
l_int|5
)paren
op_eq
l_int|0
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|value
op_logical_or
op_logical_neg
op_star
id|value
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;CIFS: invalid domain name&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
multiline_comment|/* needs_arg; */
)brace
multiline_comment|/* BB are there cases in which a comma can be valid in&n;&t;&t;&t;a domain name and need special handling? */
r_if
c_cond
(paren
id|strnlen
c_func
(paren
id|value
comma
l_int|65
)paren
OL
l_int|65
)paren
(brace
id|vol-&gt;domainname
op_assign
id|value
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Domain name set&quot;
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;CIFS: domain name too long&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|strnicmp
c_func
(paren
id|data
comma
l_string|&quot;iocharset&quot;
comma
l_int|9
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|value
op_logical_or
op_logical_neg
op_star
id|value
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;CIFS: invalid iocharset specified&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
multiline_comment|/* needs_arg; */
)brace
r_if
c_cond
(paren
id|strnlen
c_func
(paren
id|value
comma
l_int|65
)paren
OL
l_int|65
)paren
(brace
r_if
c_cond
(paren
id|strnicmp
c_func
(paren
id|value
comma
l_string|&quot;default&quot;
comma
l_int|7
)paren
)paren
(brace
id|vol-&gt;iocharset
op_assign
id|value
suffix:semicolon
)brace
multiline_comment|/* if iocharset not set load_nls_default used by caller */
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;iocharset set to %s&quot;
comma
id|value
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;CIFS: iocharset name too long.&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|strnicmp
c_func
(paren
id|data
comma
l_string|&quot;uid&quot;
comma
l_int|3
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|value
op_logical_and
op_star
id|value
)paren
(brace
id|vol-&gt;linux_uid
op_assign
id|simple_strtoul
c_func
(paren
id|value
comma
op_amp
id|value
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|strnicmp
c_func
(paren
id|data
comma
l_string|&quot;gid&quot;
comma
l_int|3
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|value
op_logical_and
op_star
id|value
)paren
(brace
id|vol-&gt;linux_gid
op_assign
id|simple_strtoul
c_func
(paren
id|value
comma
op_amp
id|value
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|strnicmp
c_func
(paren
id|data
comma
l_string|&quot;file_mode&quot;
comma
l_int|4
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|value
op_logical_and
op_star
id|value
)paren
(brace
id|vol-&gt;file_mode
op_assign
id|simple_strtoul
c_func
(paren
id|value
comma
op_amp
id|value
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|strnicmp
c_func
(paren
id|data
comma
l_string|&quot;dir_mode&quot;
comma
l_int|4
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|value
op_logical_and
op_star
id|value
)paren
(brace
id|vol-&gt;dir_mode
op_assign
id|simple_strtoul
c_func
(paren
id|value
comma
op_amp
id|value
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|strnicmp
c_func
(paren
id|data
comma
l_string|&quot;dirmode&quot;
comma
l_int|4
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|value
op_logical_and
op_star
id|value
)paren
(brace
id|vol-&gt;dir_mode
op_assign
id|simple_strtoul
c_func
(paren
id|value
comma
op_amp
id|value
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|strnicmp
c_func
(paren
id|data
comma
l_string|&quot;port&quot;
comma
l_int|4
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|value
op_logical_and
op_star
id|value
)paren
(brace
id|vol-&gt;port
op_assign
id|simple_strtoul
c_func
(paren
id|value
comma
op_amp
id|value
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|strnicmp
c_func
(paren
id|data
comma
l_string|&quot;rsize&quot;
comma
l_int|5
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|value
op_logical_and
op_star
id|value
)paren
(brace
id|vol-&gt;rsize
op_assign
id|simple_strtoul
c_func
(paren
id|value
comma
op_amp
id|value
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|strnicmp
c_func
(paren
id|data
comma
l_string|&quot;wsize&quot;
comma
l_int|5
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|value
op_logical_and
op_star
id|value
)paren
(brace
id|vol-&gt;wsize
op_assign
id|simple_strtoul
c_func
(paren
id|value
comma
op_amp
id|value
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|strnicmp
c_func
(paren
id|data
comma
l_string|&quot;sockopt&quot;
comma
l_int|5
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|value
op_logical_and
op_star
id|value
)paren
(brace
id|vol-&gt;sockopt
op_assign
id|simple_strtoul
c_func
(paren
id|value
comma
op_amp
id|value
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|strnicmp
c_func
(paren
id|data
comma
l_string|&quot;netbiosname&quot;
comma
l_int|4
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|value
op_logical_or
op_logical_neg
op_star
id|value
op_logical_or
(paren
op_star
id|value
op_eq
l_char|&squot; &squot;
)paren
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;invalid (empty) netbiosname specified&quot;
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|memset
c_func
(paren
id|vol-&gt;source_rfc1001_name
comma
l_int|0x20
comma
l_int|15
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
l_int|15
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* BB are there cases in which a comma can be &n;&t;&t;&t;&t;valid in this workstation netbios name (and need&n;&t;&t;&t;&t;special handling)? */
multiline_comment|/* We do not uppercase netbiosname for user */
r_if
c_cond
(paren
id|value
(braket
id|i
)braket
op_eq
l_int|0
)paren
r_break
suffix:semicolon
r_else
id|vol-&gt;source_rfc1001_name
(braket
id|i
)braket
op_assign
id|value
(braket
id|i
)braket
suffix:semicolon
)brace
multiline_comment|/* The string has 16th byte zero still from&n;&t;&t;&t;&t;set at top of the function  */
r_if
c_cond
(paren
(paren
id|i
op_eq
l_int|15
)paren
op_logical_and
(paren
id|value
(braket
id|i
)braket
op_ne
l_int|0
)paren
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;CIFS: netbiosname longer than 15 and was truncated.&bslash;n&quot;
)paren
suffix:semicolon
)brace
)brace
)brace
r_else
r_if
c_cond
(paren
id|strnicmp
c_func
(paren
id|data
comma
l_string|&quot;credentials&quot;
comma
l_int|4
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* ignore */
)brace
r_else
r_if
c_cond
(paren
id|strnicmp
c_func
(paren
id|data
comma
l_string|&quot;version&quot;
comma
l_int|3
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* ignore */
)brace
r_else
r_if
c_cond
(paren
id|strnicmp
c_func
(paren
id|data
comma
l_string|&quot;guest&quot;
comma
l_int|5
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* ignore */
)brace
r_else
r_if
c_cond
(paren
id|strnicmp
c_func
(paren
id|data
comma
l_string|&quot;rw&quot;
comma
l_int|2
)paren
op_eq
l_int|0
)paren
(brace
id|vol-&gt;rw
op_assign
id|TRUE
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|strnicmp
c_func
(paren
id|data
comma
l_string|&quot;suid&quot;
comma
l_int|4
)paren
op_eq
l_int|0
)paren
op_logical_or
(paren
id|strnicmp
c_func
(paren
id|data
comma
l_string|&quot;nosuid&quot;
comma
l_int|6
)paren
op_eq
l_int|0
)paren
op_logical_or
(paren
id|strnicmp
c_func
(paren
id|data
comma
l_string|&quot;exec&quot;
comma
l_int|4
)paren
op_eq
l_int|0
)paren
op_logical_or
(paren
id|strnicmp
c_func
(paren
id|data
comma
l_string|&quot;noexec&quot;
comma
l_int|6
)paren
op_eq
l_int|0
)paren
op_logical_or
(paren
id|strnicmp
c_func
(paren
id|data
comma
l_string|&quot;nodev&quot;
comma
l_int|5
)paren
op_eq
l_int|0
)paren
op_logical_or
(paren
id|strnicmp
c_func
(paren
id|data
comma
l_string|&quot;noauto&quot;
comma
l_int|6
)paren
op_eq
l_int|0
)paren
op_logical_or
(paren
id|strnicmp
c_func
(paren
id|data
comma
l_string|&quot;dev&quot;
comma
l_int|3
)paren
op_eq
l_int|0
)paren
)paren
(brace
multiline_comment|/*  The mount tool or mount.cifs helper (if present)&n;&t;&t;&t;&t;uses these opts to set flags, and the flags are read&n;&t;&t;&t;&t;by the kernel vfs layer before we get here (ie&n;&t;&t;&t;&t;before read super) so there is no point trying to&n;&t;&t;&t;&t;parse these options again and set anything and it&n;&t;&t;&t;&t;is ok to just ignore them */
r_continue
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strnicmp
c_func
(paren
id|data
comma
l_string|&quot;ro&quot;
comma
l_int|2
)paren
op_eq
l_int|0
)paren
(brace
id|vol-&gt;rw
op_assign
id|FALSE
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strnicmp
c_func
(paren
id|data
comma
l_string|&quot;hard&quot;
comma
l_int|4
)paren
op_eq
l_int|0
)paren
(brace
id|vol-&gt;retry
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strnicmp
c_func
(paren
id|data
comma
l_string|&quot;soft&quot;
comma
l_int|4
)paren
op_eq
l_int|0
)paren
(brace
id|vol-&gt;retry
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strnicmp
c_func
(paren
id|data
comma
l_string|&quot;perm&quot;
comma
l_int|4
)paren
op_eq
l_int|0
)paren
(brace
id|vol-&gt;noperm
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strnicmp
c_func
(paren
id|data
comma
l_string|&quot;noperm&quot;
comma
l_int|6
)paren
op_eq
l_int|0
)paren
(brace
id|vol-&gt;noperm
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strnicmp
c_func
(paren
id|data
comma
l_string|&quot;setuids&quot;
comma
l_int|7
)paren
op_eq
l_int|0
)paren
(brace
id|vol-&gt;setuids
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strnicmp
c_func
(paren
id|data
comma
l_string|&quot;nosetuids&quot;
comma
l_int|9
)paren
op_eq
l_int|0
)paren
(brace
id|vol-&gt;setuids
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strnicmp
c_func
(paren
id|data
comma
l_string|&quot;nohard&quot;
comma
l_int|6
)paren
op_eq
l_int|0
)paren
(brace
id|vol-&gt;retry
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strnicmp
c_func
(paren
id|data
comma
l_string|&quot;nosoft&quot;
comma
l_int|6
)paren
op_eq
l_int|0
)paren
(brace
id|vol-&gt;retry
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strnicmp
c_func
(paren
id|data
comma
l_string|&quot;nointr&quot;
comma
l_int|6
)paren
op_eq
l_int|0
)paren
(brace
id|vol-&gt;intr
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strnicmp
c_func
(paren
id|data
comma
l_string|&quot;intr&quot;
comma
l_int|4
)paren
op_eq
l_int|0
)paren
(brace
id|vol-&gt;intr
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strnicmp
c_func
(paren
id|data
comma
l_string|&quot;serverino&quot;
comma
l_int|7
)paren
op_eq
l_int|0
)paren
(brace
id|vol-&gt;server_ino
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strnicmp
c_func
(paren
id|data
comma
l_string|&quot;noserverino&quot;
comma
l_int|9
)paren
op_eq
l_int|0
)paren
(brace
id|vol-&gt;server_ino
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strnicmp
c_func
(paren
id|data
comma
l_string|&quot;acl&quot;
comma
l_int|3
)paren
op_eq
l_int|0
)paren
(brace
id|vol-&gt;no_psx_acl
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strnicmp
c_func
(paren
id|data
comma
l_string|&quot;noacl&quot;
comma
l_int|5
)paren
op_eq
l_int|0
)paren
(brace
id|vol-&gt;no_psx_acl
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strnicmp
c_func
(paren
id|data
comma
l_string|&quot;direct&quot;
comma
l_int|6
)paren
op_eq
l_int|0
)paren
(brace
id|vol-&gt;direct_io
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strnicmp
c_func
(paren
id|data
comma
l_string|&quot;forcedirectio&quot;
comma
l_int|13
)paren
op_eq
l_int|0
)paren
(brace
id|vol-&gt;direct_io
op_assign
l_int|1
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strnicmp
c_func
(paren
id|data
comma
l_string|&quot;noac&quot;
comma
l_int|4
)paren
op_eq
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;CIFS: Mount option noac not supported. Instead set /proc/fs/cifs/LookupCacheEnabled to 0&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;CIFS: Unknown mount option %s&bslash;n&quot;
comma
id|data
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|vol-&gt;UNC
op_eq
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|devname
op_eq
l_int|NULL
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;CIFS: Missing UNC name for mount target&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|temp_len
op_assign
id|strnlen
c_func
(paren
id|devname
comma
l_int|300
)paren
)paren
OL
l_int|300
)paren
(brace
id|vol-&gt;UNC
op_assign
id|kmalloc
c_func
(paren
id|temp_len
op_plus
l_int|1
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|vol-&gt;UNC
op_eq
l_int|NULL
)paren
(brace
r_return
l_int|1
suffix:semicolon
)brace
id|strcpy
c_func
(paren
id|vol-&gt;UNC
comma
id|devname
)paren
suffix:semicolon
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|vol-&gt;UNC
comma
l_string|&quot;//&quot;
comma
l_int|2
)paren
op_eq
l_int|0
)paren
(brace
id|vol-&gt;UNC
(braket
l_int|0
)braket
op_assign
l_char|&squot;&bslash;&bslash;&squot;
suffix:semicolon
id|vol-&gt;UNC
(braket
l_int|1
)braket
op_assign
l_char|&squot;&bslash;&bslash;&squot;
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|vol-&gt;UNC
comma
l_string|&quot;&bslash;&bslash;&bslash;&bslash;&quot;
comma
l_int|2
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;CIFS: UNC Path does not begin with // or &bslash;&bslash;&bslash;&bslash; &bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;CIFS: UNC name too long&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|vol-&gt;UNCip
op_eq
l_int|0
)paren
(brace
id|vol-&gt;UNCip
op_assign
op_amp
id|vol-&gt;UNC
(braket
l_int|2
)braket
suffix:semicolon
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_struct
id|cifsSesInfo
op_star
DECL|function|cifs_find_tcp_session
id|cifs_find_tcp_session
c_func
(paren
r_struct
id|in_addr
op_star
id|target_ip_addr
comma
r_struct
id|in6_addr
op_star
id|target_ip6_addr
comma
r_char
op_star
id|userName
comma
r_struct
id|TCP_Server_Info
op_star
op_star
id|psrvTcp
)paren
(brace
r_struct
id|list_head
op_star
id|tmp
suffix:semicolon
r_struct
id|cifsSesInfo
op_star
id|ses
suffix:semicolon
op_star
id|psrvTcp
op_assign
l_int|NULL
suffix:semicolon
id|read_lock
c_func
(paren
op_amp
id|GlobalSMBSeslock
)paren
suffix:semicolon
id|list_for_each
c_func
(paren
id|tmp
comma
op_amp
id|GlobalSMBSessionList
)paren
(brace
id|ses
op_assign
id|list_entry
c_func
(paren
id|tmp
comma
r_struct
id|cifsSesInfo
comma
id|cifsSessionList
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ses-&gt;server
)paren
(brace
r_if
c_cond
(paren
(paren
id|target_ip_addr
op_logical_and
(paren
id|ses-&gt;server-&gt;addr.sockAddr.sin_addr.s_addr
op_eq
id|target_ip_addr-&gt;s_addr
)paren
)paren
op_logical_or
(paren
id|target_ip6_addr
op_logical_and
id|memcmp
c_func
(paren
op_amp
id|ses-&gt;server-&gt;addr.sockAddr6.sin6_addr
comma
id|target_ip6_addr
comma
r_sizeof
(paren
op_star
id|target_ip6_addr
)paren
)paren
)paren
)paren
(brace
multiline_comment|/* BB lock server and tcp session and increment use count here?? */
op_star
id|psrvTcp
op_assign
id|ses-&gt;server
suffix:semicolon
multiline_comment|/* found a match on the TCP session */
multiline_comment|/* BB check if reconnection needed */
r_if
c_cond
(paren
id|strncmp
(paren
id|ses-&gt;userName
comma
id|userName
comma
id|MAX_USERNAME_SIZE
)paren
op_eq
l_int|0
)paren
(brace
id|read_unlock
c_func
(paren
op_amp
id|GlobalSMBSeslock
)paren
suffix:semicolon
r_return
id|ses
suffix:semicolon
multiline_comment|/* found exact match on both tcp and SMB sessions */
)brace
)brace
)brace
multiline_comment|/* else tcp and smb sessions need reconnection */
)brace
id|read_unlock
c_func
(paren
op_amp
id|GlobalSMBSeslock
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_static
r_struct
id|cifsTconInfo
op_star
DECL|function|find_unc
id|find_unc
c_func
(paren
id|__be32
id|new_target_ip_addr
comma
r_char
op_star
id|uncName
comma
r_char
op_star
id|userName
)paren
(brace
r_struct
id|list_head
op_star
id|tmp
suffix:semicolon
r_struct
id|cifsTconInfo
op_star
id|tcon
suffix:semicolon
id|read_lock
c_func
(paren
op_amp
id|GlobalSMBSeslock
)paren
suffix:semicolon
id|list_for_each
c_func
(paren
id|tmp
comma
op_amp
id|GlobalTreeConnectionList
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Next tcon - &quot;
)paren
)paren
suffix:semicolon
id|tcon
op_assign
id|list_entry
c_func
(paren
id|tmp
comma
r_struct
id|cifsTconInfo
comma
id|cifsConnectionList
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tcon-&gt;ses
)paren
(brace
r_if
c_cond
(paren
id|tcon-&gt;ses-&gt;server
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot; old ip addr: %x == new ip %x ?&quot;
comma
id|tcon-&gt;ses-&gt;server-&gt;addr.sockAddr.sin_addr
dot
id|s_addr
comma
id|new_target_ip_addr
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tcon-&gt;ses-&gt;server-&gt;addr.sockAddr.sin_addr
dot
id|s_addr
op_eq
id|new_target_ip_addr
)paren
(brace
multiline_comment|/* BB lock tcon and server and tcp session and increment use count here? */
multiline_comment|/* found a match on the TCP session */
multiline_comment|/* BB check if reconnection needed */
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Matched ip, old UNC: %s == new: %s ?&quot;
comma
id|tcon-&gt;treeName
comma
id|uncName
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|strncmp
(paren
id|tcon-&gt;treeName
comma
id|uncName
comma
id|MAX_TREE_SIZE
)paren
op_eq
l_int|0
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Matched UNC, old user: %s == new: %s ?&quot;
comma
id|tcon-&gt;treeName
comma
id|uncName
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|strncmp
(paren
id|tcon-&gt;ses-&gt;userName
comma
id|userName
comma
id|MAX_USERNAME_SIZE
)paren
op_eq
l_int|0
)paren
(brace
id|read_unlock
c_func
(paren
op_amp
id|GlobalSMBSeslock
)paren
suffix:semicolon
r_return
id|tcon
suffix:semicolon
multiline_comment|/* also matched user (smb session)*/
)brace
)brace
)brace
)brace
)brace
)brace
id|read_unlock
c_func
(paren
op_amp
id|GlobalSMBSeslock
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_int
DECL|function|connect_to_dfs_path
id|connect_to_dfs_path
c_func
(paren
r_int
id|xid
comma
r_struct
id|cifsSesInfo
op_star
id|pSesInfo
comma
r_const
r_char
op_star
id|old_path
comma
r_const
r_struct
id|nls_table
op_star
id|nls_codepage
)paren
(brace
r_int
r_char
op_star
id|referrals
op_assign
l_int|NULL
suffix:semicolon
r_int
r_int
id|num_referrals
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|rc
op_assign
id|get_dfs_path
c_func
(paren
id|xid
comma
id|pSesInfo
comma
id|old_path
comma
id|nls_codepage
comma
op_amp
id|num_referrals
comma
op_amp
id|referrals
)paren
suffix:semicolon
multiline_comment|/* BB Add in code to: if valid refrl, if not ip address contact&n;&t;&t;the helper that resolves tcp names, mount to it, try to &n;&t;&t;tcon to it unmount it if fail */
r_if
c_cond
(paren
id|referrals
)paren
(brace
id|kfree
c_func
(paren
id|referrals
)paren
suffix:semicolon
)brace
r_return
id|rc
suffix:semicolon
)brace
r_int
DECL|function|get_dfs_path
id|get_dfs_path
c_func
(paren
r_int
id|xid
comma
r_struct
id|cifsSesInfo
op_star
id|pSesInfo
comma
r_const
r_char
op_star
id|old_path
comma
r_const
r_struct
id|nls_table
op_star
id|nls_codepage
comma
r_int
r_int
op_star
id|pnum_referrals
comma
r_int
r_char
op_star
op_star
id|preferrals
)paren
(brace
r_char
op_star
id|temp_unc
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
op_star
id|pnum_referrals
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|pSesInfo-&gt;ipc_tid
op_eq
l_int|0
)paren
(brace
id|temp_unc
op_assign
id|kmalloc
c_func
(paren
l_int|2
multiline_comment|/* for slashes */
op_plus
id|strnlen
c_func
(paren
id|pSesInfo-&gt;serverName
comma
id|SERVER_NAME_LEN_WITH_NULL
op_star
l_int|2
)paren
op_plus
l_int|1
op_plus
l_int|4
multiline_comment|/* slash IPC$ */
op_plus
l_int|2
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|temp_unc
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|temp_unc
(braket
l_int|0
)braket
op_assign
l_char|&squot;&bslash;&bslash;&squot;
suffix:semicolon
id|temp_unc
(braket
l_int|1
)braket
op_assign
l_char|&squot;&bslash;&bslash;&squot;
suffix:semicolon
id|strcpy
c_func
(paren
id|temp_unc
op_plus
l_int|2
comma
id|pSesInfo-&gt;serverName
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|temp_unc
op_plus
l_int|2
op_plus
id|strlen
c_func
(paren
id|pSesInfo-&gt;serverName
)paren
comma
l_string|&quot;&bslash;&bslash;IPC$&quot;
)paren
suffix:semicolon
id|rc
op_assign
id|CIFSTCon
c_func
(paren
id|xid
comma
id|pSesInfo
comma
id|temp_unc
comma
l_int|NULL
comma
id|nls_codepage
)paren
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;CIFS Tcon rc = %d ipc_tid = %d&quot;
comma
id|rc
comma
id|pSesInfo-&gt;ipc_tid
)paren
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|temp_unc
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
)paren
id|rc
op_assign
id|CIFSGetDFSRefer
c_func
(paren
id|xid
comma
id|pSesInfo
comma
id|old_path
comma
id|preferrals
comma
id|pnum_referrals
comma
id|nls_codepage
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/* See RFC1001 section 14 on representation of Netbios names */
DECL|function|rfc1002mangle
r_static
r_void
id|rfc1002mangle
c_func
(paren
r_char
op_star
id|target
comma
r_char
op_star
id|source
comma
r_int
r_int
id|length
)paren
(brace
r_int
r_int
id|i
comma
id|j
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|j
op_assign
l_int|0
suffix:semicolon
id|i
OL
(paren
id|length
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* mask a nibble at a time and encode */
id|target
(braket
id|j
)braket
op_assign
l_char|&squot;A&squot;
op_plus
(paren
l_int|0x0F
op_amp
(paren
id|source
(braket
id|i
)braket
op_rshift
l_int|4
)paren
)paren
suffix:semicolon
id|target
(braket
id|j
op_plus
l_int|1
)braket
op_assign
l_char|&squot;A&squot;
op_plus
(paren
l_int|0x0F
op_amp
id|source
(braket
id|i
)braket
)paren
suffix:semicolon
id|j
op_add_assign
l_int|2
suffix:semicolon
)brace
)brace
r_static
r_int
DECL|function|ipv4_connect
id|ipv4_connect
c_func
(paren
r_struct
id|sockaddr_in
op_star
id|psin_server
comma
r_struct
id|socket
op_star
op_star
id|csocket
comma
r_char
op_star
id|netbios_name
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|connected
op_assign
l_int|0
suffix:semicolon
id|__be16
id|orig_port
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_star
id|csocket
op_eq
l_int|NULL
)paren
(brace
id|rc
op_assign
id|sock_create_kern
c_func
(paren
id|PF_INET
comma
id|SOCK_STREAM
comma
id|IPPROTO_TCP
comma
id|csocket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
(brace
id|cERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Error %d creating socket&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
op_star
id|csocket
op_assign
l_int|NULL
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* BB other socket options to set KEEPALIVE, NODELAY? */
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Socket created&quot;
)paren
)paren
suffix:semicolon
(paren
op_star
id|csocket
)paren
op_member_access_from_pointer
id|sk-&gt;sk_allocation
op_assign
id|GFP_NOFS
suffix:semicolon
)brace
)brace
id|psin_server-&gt;sin_family
op_assign
id|AF_INET
suffix:semicolon
r_if
c_cond
(paren
id|psin_server-&gt;sin_port
)paren
(brace
multiline_comment|/* user overrode default port */
id|rc
op_assign
(paren
op_star
id|csocket
)paren
op_member_access_from_pointer
id|ops
op_member_access_from_pointer
id|connect
c_func
(paren
op_star
id|csocket
comma
(paren
r_struct
id|sockaddr
op_star
)paren
id|psin_server
comma
r_sizeof
(paren
r_struct
id|sockaddr_in
)paren
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ge
l_int|0
)paren
id|connected
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|connected
)paren
(brace
multiline_comment|/* save original port so we can retry user specified port  &n;&t;&t;&t;later if fall back ports fail this time  */
id|orig_port
op_assign
id|psin_server-&gt;sin_port
suffix:semicolon
multiline_comment|/* do not retry on the same port we just failed on */
r_if
c_cond
(paren
id|psin_server-&gt;sin_port
op_ne
id|htons
c_func
(paren
id|CIFS_PORT
)paren
)paren
(brace
id|psin_server-&gt;sin_port
op_assign
id|htons
c_func
(paren
id|CIFS_PORT
)paren
suffix:semicolon
id|rc
op_assign
(paren
op_star
id|csocket
)paren
op_member_access_from_pointer
id|ops
op_member_access_from_pointer
id|connect
c_func
(paren
op_star
id|csocket
comma
(paren
r_struct
id|sockaddr
op_star
)paren
id|psin_server
comma
r_sizeof
(paren
r_struct
id|sockaddr_in
)paren
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ge
l_int|0
)paren
id|connected
op_assign
l_int|1
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|connected
)paren
(brace
id|psin_server-&gt;sin_port
op_assign
id|htons
c_func
(paren
id|RFC1001_PORT
)paren
suffix:semicolon
id|rc
op_assign
(paren
op_star
id|csocket
)paren
op_member_access_from_pointer
id|ops
op_member_access_from_pointer
id|connect
c_func
(paren
op_star
id|csocket
comma
(paren
r_struct
id|sockaddr
op_star
)paren
id|psin_server
comma
r_sizeof
(paren
r_struct
id|sockaddr_in
)paren
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ge
l_int|0
)paren
id|connected
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* give up here - unless we want to retry on different&n;&t;&t;protocol families some day */
r_if
c_cond
(paren
op_logical_neg
id|connected
)paren
(brace
r_if
c_cond
(paren
id|orig_port
)paren
(brace
id|psin_server-&gt;sin_port
op_assign
id|orig_port
suffix:semicolon
)brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Error %d connecting to server via ipv4&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
id|sock_release
c_func
(paren
op_star
id|csocket
)paren
suffix:semicolon
op_star
id|csocket
op_assign
l_int|NULL
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/* Eventually check for other socket options to change from &n;&t;&t;the default. sock_setsockopt not used because it expects &n;&t;&t;user space buffer */
(paren
op_star
id|csocket
)paren
op_member_access_from_pointer
id|sk-&gt;sk_rcvtimeo
op_assign
l_int|7
op_star
id|HZ
suffix:semicolon
multiline_comment|/* send RFC1001 sessinit */
r_if
c_cond
(paren
id|psin_server-&gt;sin_port
op_eq
id|htons
c_func
(paren
id|RFC1001_PORT
)paren
)paren
(brace
multiline_comment|/* some servers require RFC1001 sessinit before sending&n;&t;&t;negprot - BB check reconnection in case where second &n;&t;&t;sessinit is sent but no second negprot */
r_struct
id|rfc1002_session_packet
op_star
id|ses_init_buf
suffix:semicolon
r_struct
id|smb_hdr
op_star
id|smb_buf
suffix:semicolon
id|ses_init_buf
op_assign
id|cifs_kcalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|rfc1002_session_packet
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ses_init_buf
)paren
(brace
id|ses_init_buf-&gt;trailer.session_req.called_len
op_assign
l_int|32
suffix:semicolon
id|rfc1002mangle
c_func
(paren
id|ses_init_buf-&gt;trailer.session_req.called_name
comma
id|DEFAULT_CIFS_CALLED_NAME
comma
l_int|16
)paren
suffix:semicolon
id|ses_init_buf-&gt;trailer.session_req.calling_len
op_assign
l_int|32
suffix:semicolon
multiline_comment|/* calling name ends in null (byte 16) from old smb&n;&t;&t;&t;convention. */
r_if
c_cond
(paren
id|netbios_name
op_logical_and
(paren
id|netbios_name
(braket
l_int|0
)braket
op_ne
l_int|0
)paren
)paren
(brace
id|rfc1002mangle
c_func
(paren
id|ses_init_buf-&gt;trailer.session_req.calling_name
comma
id|netbios_name
comma
l_int|16
)paren
suffix:semicolon
)brace
r_else
(brace
id|rfc1002mangle
c_func
(paren
id|ses_init_buf-&gt;trailer.session_req.calling_name
comma
l_string|&quot;LINUX_CIFS_CLNT&quot;
comma
l_int|16
)paren
suffix:semicolon
)brace
id|ses_init_buf-&gt;trailer.session_req.scope1
op_assign
l_int|0
suffix:semicolon
id|ses_init_buf-&gt;trailer.session_req.scope2
op_assign
l_int|0
suffix:semicolon
id|smb_buf
op_assign
(paren
r_struct
id|smb_hdr
op_star
)paren
id|ses_init_buf
suffix:semicolon
multiline_comment|/* sizeof RFC1002_SESSION_REQUEST with no scope */
id|smb_buf-&gt;smb_buf_length
op_assign
l_int|0x81000044
suffix:semicolon
id|rc
op_assign
id|smb_send
c_func
(paren
op_star
id|csocket
comma
id|smb_buf
comma
l_int|0x44
comma
(paren
r_struct
id|sockaddr
op_star
)paren
id|psin_server
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|ses_init_buf
)paren
suffix:semicolon
)brace
multiline_comment|/* else the negprot may still work without this &n;&t;&t;even though malloc failed */
)brace
r_return
id|rc
suffix:semicolon
)brace
r_static
r_int
DECL|function|ipv6_connect
id|ipv6_connect
c_func
(paren
r_struct
id|sockaddr_in6
op_star
id|psin_server
comma
r_struct
id|socket
op_star
op_star
id|csocket
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|connected
op_assign
l_int|0
suffix:semicolon
id|__be16
id|orig_port
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_star
id|csocket
op_eq
l_int|NULL
)paren
(brace
id|rc
op_assign
id|sock_create_kern
c_func
(paren
id|PF_INET6
comma
id|SOCK_STREAM
comma
id|IPPROTO_TCP
comma
id|csocket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
(brace
id|cERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Error %d creating ipv6 socket&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
op_star
id|csocket
op_assign
l_int|NULL
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* BB other socket options to set KEEPALIVE, NODELAY? */
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;ipv6 Socket created&quot;
)paren
)paren
suffix:semicolon
(paren
op_star
id|csocket
)paren
op_member_access_from_pointer
id|sk-&gt;sk_allocation
op_assign
id|GFP_NOFS
suffix:semicolon
)brace
)brace
id|psin_server-&gt;sin6_family
op_assign
id|AF_INET6
suffix:semicolon
r_if
c_cond
(paren
id|psin_server-&gt;sin6_port
)paren
(brace
multiline_comment|/* user overrode default port */
id|rc
op_assign
(paren
op_star
id|csocket
)paren
op_member_access_from_pointer
id|ops
op_member_access_from_pointer
id|connect
c_func
(paren
op_star
id|csocket
comma
(paren
r_struct
id|sockaddr
op_star
)paren
id|psin_server
comma
r_sizeof
(paren
r_struct
id|sockaddr_in6
)paren
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ge
l_int|0
)paren
id|connected
op_assign
l_int|1
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|connected
)paren
(brace
multiline_comment|/* save original port so we can retry user specified port  &n;&t;&t;&t;later if fall back ports fail this time  */
id|orig_port
op_assign
id|psin_server-&gt;sin6_port
suffix:semicolon
multiline_comment|/* do not retry on the same port we just failed on */
r_if
c_cond
(paren
id|psin_server-&gt;sin6_port
op_ne
id|htons
c_func
(paren
id|CIFS_PORT
)paren
)paren
(brace
id|psin_server-&gt;sin6_port
op_assign
id|htons
c_func
(paren
id|CIFS_PORT
)paren
suffix:semicolon
id|rc
op_assign
(paren
op_star
id|csocket
)paren
op_member_access_from_pointer
id|ops
op_member_access_from_pointer
id|connect
c_func
(paren
op_star
id|csocket
comma
(paren
r_struct
id|sockaddr
op_star
)paren
id|psin_server
comma
r_sizeof
(paren
r_struct
id|sockaddr_in6
)paren
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ge
l_int|0
)paren
id|connected
op_assign
l_int|1
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|connected
)paren
(brace
id|psin_server-&gt;sin6_port
op_assign
id|htons
c_func
(paren
id|RFC1001_PORT
)paren
suffix:semicolon
id|rc
op_assign
(paren
op_star
id|csocket
)paren
op_member_access_from_pointer
id|ops
op_member_access_from_pointer
id|connect
c_func
(paren
op_star
id|csocket
comma
(paren
r_struct
id|sockaddr
op_star
)paren
id|psin_server
comma
r_sizeof
(paren
r_struct
id|sockaddr_in6
)paren
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_ge
l_int|0
)paren
id|connected
op_assign
l_int|1
suffix:semicolon
)brace
multiline_comment|/* give up here - unless we want to retry on different&n;&t;&t;protocol families some day */
r_if
c_cond
(paren
op_logical_neg
id|connected
)paren
(brace
r_if
c_cond
(paren
id|orig_port
)paren
(brace
id|psin_server-&gt;sin6_port
op_assign
id|orig_port
suffix:semicolon
)brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Error %d connecting to server via ipv6&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
id|sock_release
c_func
(paren
op_star
id|csocket
)paren
suffix:semicolon
op_star
id|csocket
op_assign
l_int|NULL
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
multiline_comment|/* Eventually check for other socket options to change from &n;&t;&t;the default. sock_setsockopt not used because it expects &n;&t;&t;user space buffer */
(paren
op_star
id|csocket
)paren
op_member_access_from_pointer
id|sk-&gt;sk_rcvtimeo
op_assign
l_int|7
op_star
id|HZ
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_int
DECL|function|cifs_mount
id|cifs_mount
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|cifs_sb_info
op_star
id|cifs_sb
comma
r_char
op_star
id|mount_data
comma
r_const
r_char
op_star
id|devname
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|xid
suffix:semicolon
r_int
id|address_type
op_assign
id|AF_INET
suffix:semicolon
r_struct
id|socket
op_star
id|csocket
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|sockaddr_in
id|sin_server
suffix:semicolon
r_struct
id|sockaddr_in6
id|sin_server6
suffix:semicolon
r_struct
id|smb_vol
id|volume_info
suffix:semicolon
r_struct
id|cifsSesInfo
op_star
id|pSesInfo
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|cifsSesInfo
op_star
id|existingCifsSes
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|cifsTconInfo
op_star
id|tcon
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|TCP_Server_Info
op_star
id|srvTcp
op_assign
l_int|NULL
suffix:semicolon
id|xid
op_assign
id|GetXid
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* cFYI(1, (&quot;Entering cifs_mount. Xid: %d with: %s&quot;, xid, mount_data)); */
id|memset
c_func
(paren
op_amp
id|volume_info
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|smb_vol
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cifs_parse_mount_options
c_func
(paren
id|mount_data
comma
id|devname
comma
op_amp
id|volume_info
)paren
)paren
(brace
r_if
c_cond
(paren
id|volume_info.UNC
)paren
(brace
id|kfree
c_func
(paren
id|volume_info.UNC
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|volume_info.password
)paren
(brace
id|kfree
c_func
(paren
id|volume_info.password
)paren
suffix:semicolon
)brace
id|FreeXid
c_func
(paren
id|xid
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|volume_info.username
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Username: %s &quot;
comma
id|volume_info.username
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|cifserror
c_func
(paren
l_string|&quot;No username specified &quot;
)paren
suffix:semicolon
multiline_comment|/* In userspace mount helper we can get user name from alternate&n;           locations such as env variables and files on disk */
r_if
c_cond
(paren
id|volume_info.UNC
)paren
(brace
id|kfree
c_func
(paren
id|volume_info.UNC
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|volume_info.password
)paren
(brace
id|kfree
c_func
(paren
id|volume_info.password
)paren
suffix:semicolon
)brace
id|FreeXid
c_func
(paren
id|xid
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|volume_info.UNCip
op_logical_and
id|volume_info.UNC
)paren
(brace
id|rc
op_assign
id|cifs_inet_pton
c_func
(paren
id|AF_INET
comma
id|volume_info.UNCip
comma
op_amp
id|sin_server.sin_addr.s_addr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_le
l_int|0
)paren
(brace
multiline_comment|/* not ipv4 address, try ipv6 */
id|rc
op_assign
id|cifs_inet_pton
c_func
(paren
id|AF_INET6
comma
id|volume_info.UNCip
comma
op_amp
id|sin_server6.sin6_addr.in6_u
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OG
l_int|0
)paren
(brace
id|address_type
op_assign
id|AF_INET6
suffix:semicolon
)brace
)brace
r_else
(brace
id|address_type
op_assign
id|AF_INET
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rc
op_le
l_int|0
)paren
(brace
multiline_comment|/* we failed translating address */
r_if
c_cond
(paren
id|volume_info.UNC
)paren
(brace
id|kfree
c_func
(paren
id|volume_info.UNC
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|volume_info.password
)paren
(brace
id|kfree
c_func
(paren
id|volume_info.password
)paren
suffix:semicolon
)brace
id|FreeXid
c_func
(paren
id|xid
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;UNC: %s ip: %s&quot;
comma
id|volume_info.UNC
comma
id|volume_info.UNCip
)paren
)paren
suffix:semicolon
multiline_comment|/* success */
id|rc
op_assign
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|volume_info.UNCip
)paren
(brace
multiline_comment|/* BB using ip addr as server name connect to the DFS root below */
id|cERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Connecting to DFS root not implemented yet&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|volume_info.UNC
)paren
(brace
id|kfree
c_func
(paren
id|volume_info.UNC
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|volume_info.password
)paren
(brace
id|kfree
c_func
(paren
id|volume_info.password
)paren
suffix:semicolon
)brace
id|FreeXid
c_func
(paren
id|xid
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_else
multiline_comment|/* which servers DFS root would we conect to */
(brace
id|cERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;CIFS mount error: No UNC path (e.g. -o unc=//192.168.1.100/public) specified  &quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|volume_info.UNC
)paren
(brace
id|kfree
c_func
(paren
id|volume_info.UNC
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|volume_info.password
)paren
(brace
id|kfree
c_func
(paren
id|volume_info.password
)paren
suffix:semicolon
)brace
id|FreeXid
c_func
(paren
id|xid
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* this is needed for ASCII cp to Unicode converts */
r_if
c_cond
(paren
id|volume_info.iocharset
op_eq
l_int|NULL
)paren
(brace
id|cifs_sb-&gt;local_nls
op_assign
id|load_nls_default
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* load_nls_default can not return null */
)brace
r_else
(brace
id|cifs_sb-&gt;local_nls
op_assign
id|load_nls
c_func
(paren
id|volume_info.iocharset
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cifs_sb-&gt;local_nls
op_eq
l_int|NULL
)paren
(brace
id|cERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;CIFS mount error: iocharset %s not found&quot;
comma
id|volume_info.iocharset
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|volume_info.UNC
)paren
(brace
id|kfree
c_func
(paren
id|volume_info.UNC
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|volume_info.password
)paren
(brace
id|kfree
c_func
(paren
id|volume_info.password
)paren
suffix:semicolon
)brace
id|FreeXid
c_func
(paren
id|xid
)paren
suffix:semicolon
r_return
op_minus
id|ELIBACC
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|address_type
op_eq
id|AF_INET
)paren
(brace
id|existingCifsSes
op_assign
id|cifs_find_tcp_session
c_func
(paren
op_amp
id|sin_server.sin_addr
comma
l_int|NULL
multiline_comment|/* no ipv6 addr */
comma
id|volume_info.username
comma
op_amp
id|srvTcp
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|address_type
op_eq
id|AF_INET6
)paren
(brace
id|existingCifsSes
op_assign
id|cifs_find_tcp_session
c_func
(paren
l_int|NULL
multiline_comment|/* no ipv4 addr */
comma
op_amp
id|sin_server6.sin6_addr
comma
id|volume_info.username
comma
op_amp
id|srvTcp
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|volume_info.UNC
)paren
(brace
id|kfree
c_func
(paren
id|volume_info.UNC
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|volume_info.password
)paren
(brace
id|kfree
c_func
(paren
id|volume_info.password
)paren
suffix:semicolon
)brace
id|FreeXid
c_func
(paren
id|xid
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|srvTcp
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Existing tcp session with server found &quot;
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* create socket */
r_if
c_cond
(paren
id|volume_info.port
)paren
(brace
id|sin_server.sin_port
op_assign
id|htons
c_func
(paren
id|volume_info.port
)paren
suffix:semicolon
)brace
r_else
id|sin_server.sin_port
op_assign
l_int|0
suffix:semicolon
id|rc
op_assign
id|ipv4_connect
c_func
(paren
op_amp
id|sin_server
comma
op_amp
id|csocket
comma
id|volume_info.source_rfc1001_name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
(brace
id|cERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Error connecting to IPv4 socket. Aborting operation&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|csocket
op_ne
l_int|NULL
)paren
(brace
id|sock_release
c_func
(paren
id|csocket
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|volume_info.UNC
)paren
(brace
id|kfree
c_func
(paren
id|volume_info.UNC
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|volume_info.password
)paren
(brace
id|kfree
c_func
(paren
id|volume_info.password
)paren
suffix:semicolon
)brace
id|FreeXid
c_func
(paren
id|xid
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|srvTcp
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|TCP_Server_Info
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|srvTcp
op_eq
l_int|NULL
)paren
(brace
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
id|sock_release
c_func
(paren
id|csocket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|volume_info.UNC
)paren
(brace
id|kfree
c_func
(paren
id|volume_info.UNC
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|volume_info.password
)paren
(brace
id|kfree
c_func
(paren
id|volume_info.password
)paren
suffix:semicolon
)brace
id|FreeXid
c_func
(paren
id|xid
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_else
(brace
id|memset
c_func
(paren
id|srvTcp
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|TCP_Server_Info
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|srvTcp-&gt;addr.sockAddr
comma
op_amp
id|sin_server
comma
r_sizeof
(paren
r_struct
id|sockaddr_in
)paren
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|srvTcp-&gt;inFlight
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* BB Add code for ipv6 case too */
id|srvTcp-&gt;ssocket
op_assign
id|csocket
suffix:semicolon
id|srvTcp-&gt;protocolType
op_assign
id|IPV4
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|srvTcp-&gt;response_q
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|srvTcp-&gt;request_q
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|srvTcp-&gt;pending_mid_q
)paren
suffix:semicolon
multiline_comment|/* at this point we are the only ones with the pointer&n;&t;&t;&t;to the struct since the kernel thread not created yet&n;&t;&t;&t;so no need to spinlock this init of tcpStatus */
id|srvTcp-&gt;tcpStatus
op_assign
id|CifsNew
suffix:semicolon
id|init_MUTEX
c_func
(paren
op_amp
id|srvTcp-&gt;tcpSem
)paren
suffix:semicolon
id|rc
op_assign
(paren
r_int
)paren
id|kernel_thread
c_func
(paren
(paren
r_void
op_star
)paren
(paren
r_void
op_star
)paren
id|cifs_demultiplex_thread
comma
id|srvTcp
comma
id|CLONE_FS
op_or
id|CLONE_FILES
op_or
id|CLONE_VM
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
(brace
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
id|sock_release
c_func
(paren
id|csocket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|volume_info.UNC
)paren
(brace
id|kfree
c_func
(paren
id|volume_info.UNC
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|volume_info.password
)paren
(brace
id|kfree
c_func
(paren
id|volume_info.password
)paren
suffix:semicolon
)brace
id|FreeXid
c_func
(paren
id|xid
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_else
id|rc
op_assign
l_int|0
suffix:semicolon
id|memcpy
c_func
(paren
id|srvTcp-&gt;workstation_RFC1001_name
comma
id|volume_info.source_rfc1001_name
comma
l_int|16
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|existingCifsSes
)paren
(brace
id|pSesInfo
op_assign
id|existingCifsSes
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Existing smb sess found &quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|volume_info.password
)paren
(brace
id|kfree
c_func
(paren
id|volume_info.password
)paren
suffix:semicolon
)brace
multiline_comment|/* volume_info.UNC freed at end of function */
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|rc
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Existing smb sess not found &quot;
)paren
)paren
suffix:semicolon
id|pSesInfo
op_assign
id|sesInfoAlloc
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pSesInfo
op_eq
l_int|NULL
)paren
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_else
(brace
id|pSesInfo-&gt;server
op_assign
id|srvTcp
suffix:semicolon
id|sprintf
c_func
(paren
id|pSesInfo-&gt;serverName
comma
l_string|&quot;%u.%u.%u.%u&quot;
comma
id|NIPQUAD
c_func
(paren
id|sin_server.sin_addr.s_addr
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|rc
)paren
(brace
multiline_comment|/* volume_info.password freed at unmount */
r_if
c_cond
(paren
id|volume_info.password
)paren
id|pSesInfo-&gt;password
op_assign
id|volume_info.password
suffix:semicolon
r_if
c_cond
(paren
id|volume_info.username
)paren
id|strncpy
c_func
(paren
id|pSesInfo-&gt;userName
comma
id|volume_info.username
comma
id|MAX_USERNAME_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|volume_info.domainname
)paren
id|strncpy
c_func
(paren
id|pSesInfo-&gt;domainName
comma
id|volume_info.domainname
comma
id|MAX_USERNAME_SIZE
)paren
suffix:semicolon
id|pSesInfo-&gt;linux_uid
op_assign
id|volume_info.linux_uid
suffix:semicolon
id|down
c_func
(paren
op_amp
id|pSesInfo-&gt;sesSem
)paren
suffix:semicolon
id|rc
op_assign
id|cifs_setup_session
c_func
(paren
id|xid
comma
id|pSesInfo
comma
id|cifs_sb-&gt;local_nls
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|pSesInfo-&gt;sesSem
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rc
)paren
(brace
id|atomic_inc
c_func
(paren
op_amp
id|srvTcp-&gt;socketUseCount
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|volume_info.password
)paren
(brace
id|kfree
c_func
(paren
id|volume_info.password
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* search for existing tcon to this server share */
r_if
c_cond
(paren
op_logical_neg
id|rc
)paren
(brace
r_if
c_cond
(paren
(paren
id|volume_info.rsize
)paren
op_logical_and
(paren
id|volume_info.rsize
op_plus
id|MAX_CIFS_HDR_SIZE
OL
id|srvTcp-&gt;maxBuf
)paren
)paren
(brace
id|cifs_sb-&gt;rsize
op_assign
id|volume_info.rsize
suffix:semicolon
)brace
r_else
id|cifs_sb-&gt;rsize
op_assign
id|srvTcp-&gt;maxBuf
op_minus
id|MAX_CIFS_HDR_SIZE
suffix:semicolon
multiline_comment|/* default */
r_if
c_cond
(paren
(paren
id|volume_info.wsize
)paren
op_logical_and
(paren
id|volume_info.wsize
op_plus
id|MAX_CIFS_HDR_SIZE
OL
id|srvTcp-&gt;maxBuf
)paren
)paren
(brace
id|cifs_sb-&gt;wsize
op_assign
id|volume_info.wsize
suffix:semicolon
)brace
r_else
id|cifs_sb-&gt;wsize
op_assign
id|srvTcp-&gt;maxBuf
op_minus
id|MAX_CIFS_HDR_SIZE
suffix:semicolon
multiline_comment|/* default */
r_if
c_cond
(paren
id|cifs_sb-&gt;rsize
OL
id|PAGE_CACHE_SIZE
)paren
(brace
id|cifs_sb-&gt;rsize
op_assign
id|PAGE_CACHE_SIZE
suffix:semicolon
id|cERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Attempt to set readsize for mount to less than one page (4096)&quot;
)paren
)paren
suffix:semicolon
)brace
id|cifs_sb-&gt;mnt_uid
op_assign
id|volume_info.linux_uid
suffix:semicolon
id|cifs_sb-&gt;mnt_gid
op_assign
id|volume_info.linux_gid
suffix:semicolon
id|cifs_sb-&gt;mnt_file_mode
op_assign
id|volume_info.file_mode
suffix:semicolon
id|cifs_sb-&gt;mnt_dir_mode
op_assign
id|volume_info.dir_mode
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;file mode: 0x%x  dir mode: 0x%x&quot;
comma
id|cifs_sb-&gt;mnt_file_mode
comma
id|cifs_sb-&gt;mnt_dir_mode
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|volume_info.noperm
)paren
(brace
id|cifs_sb-&gt;mnt_cifs_flags
op_or_assign
id|CIFS_MOUNT_NO_PERM
suffix:semicolon
)brace
r_if
c_cond
(paren
id|volume_info.setuids
)paren
(brace
id|cifs_sb-&gt;mnt_cifs_flags
op_or_assign
id|CIFS_MOUNT_SET_UID
suffix:semicolon
)brace
r_if
c_cond
(paren
id|volume_info.server_ino
)paren
(brace
id|cifs_sb-&gt;mnt_cifs_flags
op_or_assign
id|CIFS_MOUNT_SERVER_INUM
suffix:semicolon
)brace
r_if
c_cond
(paren
id|volume_info.direct_io
)paren
(brace
id|cERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;mounting share using direct i/o&quot;
)paren
)paren
suffix:semicolon
id|cifs_sb-&gt;mnt_cifs_flags
op_or_assign
id|CIFS_MOUNT_DIRECT_IO
suffix:semicolon
)brace
id|tcon
op_assign
id|find_unc
c_func
(paren
id|sin_server.sin_addr.s_addr
comma
id|volume_info.UNC
comma
id|volume_info.username
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tcon
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Found match on UNC path &quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* we can have only one retry value for a connection&n;&t;&t;&t;   to a share so for resources mounted more than once&n;&t;&t;&t;   to the same server share the last value passed in &n;&t;&t;&t;   for the retry flag is used */
id|tcon-&gt;retry
op_assign
id|volume_info.retry
suffix:semicolon
)brace
r_else
(brace
id|tcon
op_assign
id|tconInfoAlloc
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tcon
op_eq
l_int|NULL
)paren
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_else
(brace
multiline_comment|/* check for null share name ie connect to dfs root */
multiline_comment|/* BB check if this works for exactly length three strings */
r_if
c_cond
(paren
(paren
id|strchr
c_func
(paren
id|volume_info.UNC
op_plus
l_int|3
comma
l_char|&squot;&bslash;&bslash;&squot;
)paren
op_eq
l_int|NULL
)paren
op_logical_and
(paren
id|strchr
c_func
(paren
id|volume_info.UNC
op_plus
l_int|3
comma
l_char|&squot;/&squot;
)paren
op_eq
l_int|NULL
)paren
)paren
(brace
id|rc
op_assign
id|connect_to_dfs_path
c_func
(paren
id|xid
comma
id|pSesInfo
comma
l_string|&quot;&quot;
comma
id|cifs_sb
op_member_access_from_pointer
id|local_nls
)paren
suffix:semicolon
r_if
c_cond
(paren
id|volume_info.UNC
)paren
(brace
id|kfree
c_func
(paren
id|volume_info.UNC
)paren
suffix:semicolon
)brace
id|FreeXid
c_func
(paren
id|xid
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_else
(brace
id|rc
op_assign
id|CIFSTCon
c_func
(paren
id|xid
comma
id|pSesInfo
comma
id|volume_info.UNC
comma
id|tcon
comma
id|cifs_sb-&gt;local_nls
)paren
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;CIFS Tcon rc = %d&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|rc
)paren
(brace
id|atomic_inc
c_func
(paren
op_amp
id|pSesInfo-&gt;inUse
)paren
suffix:semicolon
id|tcon-&gt;retry
op_assign
id|volume_info.retry
suffix:semicolon
)brace
)brace
)brace
)brace
r_if
c_cond
(paren
id|pSesInfo
)paren
(brace
r_if
c_cond
(paren
id|pSesInfo-&gt;capabilities
op_amp
id|CAP_LARGE_FILES
)paren
(brace
id|sb-&gt;s_maxbytes
op_assign
(paren
id|u64
)paren
l_int|1
op_lshift
l_int|63
suffix:semicolon
)brace
r_else
id|sb-&gt;s_maxbytes
op_assign
(paren
id|u64
)paren
l_int|1
op_lshift
l_int|31
suffix:semicolon
multiline_comment|/* 2 GB */
)brace
multiline_comment|/* on error free sesinfo and tcon struct if needed */
r_if
c_cond
(paren
id|rc
)paren
(brace
multiline_comment|/* if session setup failed, use count is zero but&n;&t;&t;we still need to free cifsd thread */
r_if
c_cond
(paren
id|atomic_read
c_func
(paren
op_amp
id|srvTcp-&gt;socketUseCount
)paren
op_eq
l_int|0
)paren
(brace
id|spin_lock
c_func
(paren
op_amp
id|GlobalMid_Lock
)paren
suffix:semicolon
id|srvTcp-&gt;tcpStatus
op_assign
id|CifsExiting
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|GlobalMid_Lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|srvTcp-&gt;tsk
)paren
(brace
id|send_sig
c_func
(paren
id|SIGKILL
comma
id|srvTcp-&gt;tsk
comma
l_int|1
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/* If find_unc succeeded then rc == 0 so we can not end */
r_if
c_cond
(paren
id|tcon
)paren
multiline_comment|/* up accidently freeing someone elses tcon struct */
id|tconInfoFree
c_func
(paren
id|tcon
)paren
suffix:semicolon
r_if
c_cond
(paren
id|existingCifsSes
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|pSesInfo
)paren
(brace
r_if
c_cond
(paren
(paren
id|pSesInfo-&gt;server
)paren
op_logical_and
(paren
id|pSesInfo-&gt;status
op_eq
id|CifsGood
)paren
)paren
(brace
r_int
id|temp_rc
suffix:semicolon
id|temp_rc
op_assign
id|CIFSSMBLogoff
c_func
(paren
id|xid
comma
id|pSesInfo
)paren
suffix:semicolon
multiline_comment|/* if the socketUseCount is now zero */
r_if
c_cond
(paren
(paren
id|temp_rc
op_eq
op_minus
id|ESHUTDOWN
)paren
op_logical_and
(paren
id|pSesInfo-&gt;server-&gt;tsk
)paren
)paren
(brace
id|send_sig
c_func
(paren
id|SIGKILL
comma
id|pSesInfo-&gt;server-&gt;tsk
comma
l_int|1
)paren
suffix:semicolon
)brace
)brace
r_else
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;No session or bad tcon&quot;
)paren
)paren
suffix:semicolon
id|sesInfoFree
c_func
(paren
id|pSesInfo
)paren
suffix:semicolon
multiline_comment|/* pSesInfo = NULL; */
)brace
)brace
)brace
r_else
(brace
id|atomic_inc
c_func
(paren
op_amp
id|tcon-&gt;useCount
)paren
suffix:semicolon
id|cifs_sb-&gt;tcon
op_assign
id|tcon
suffix:semicolon
id|tcon-&gt;ses
op_assign
id|pSesInfo
suffix:semicolon
multiline_comment|/* do not care if following two calls succeed - informational only */
id|CIFSSMBQFSDeviceInfo
c_func
(paren
id|xid
comma
id|tcon
comma
id|cifs_sb-&gt;local_nls
)paren
suffix:semicolon
id|CIFSSMBQFSAttributeInfo
c_func
(paren
id|xid
comma
id|tcon
comma
id|cifs_sb-&gt;local_nls
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tcon-&gt;ses-&gt;capabilities
op_amp
id|CAP_UNIX
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|CIFSSMBQFSUnixInfo
c_func
(paren
id|xid
comma
id|tcon
comma
id|cifs_sb-&gt;local_nls
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|volume_info.no_psx_acl
)paren
(brace
r_if
c_cond
(paren
id|CIFS_UNIX_POSIX_ACL_CAP
op_amp
id|le64_to_cpu
c_func
(paren
id|tcon-&gt;fsUnixInfo.Capability
)paren
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;server negotiated posix acl support&quot;
)paren
)paren
suffix:semicolon
)brace
id|sb-&gt;s_flags
op_or_assign
id|MS_POSIXACL
suffix:semicolon
)brace
)brace
)brace
)brace
multiline_comment|/* volume_info.password is freed above when existing session found&n;&t;(in which case it is not needed anymore) but when new sesion is created&n;&t;the password ptr is put in the new session structure (in which case the&n;&t;password will be freed at unmount time) */
r_if
c_cond
(paren
id|volume_info.UNC
)paren
(brace
id|kfree
c_func
(paren
id|volume_info.UNC
)paren
suffix:semicolon
)brace
id|FreeXid
c_func
(paren
id|xid
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_static
r_int
DECL|function|CIFSSessSetup
id|CIFSSessSetup
c_func
(paren
r_int
r_int
id|xid
comma
r_struct
id|cifsSesInfo
op_star
id|ses
comma
r_char
id|session_key
(braket
id|CIFS_SESSION_KEY_SIZE
)braket
comma
r_const
r_struct
id|nls_table
op_star
id|nls_codepage
)paren
(brace
r_struct
id|smb_hdr
op_star
id|smb_buffer
suffix:semicolon
r_struct
id|smb_hdr
op_star
id|smb_buffer_response
suffix:semicolon
id|SESSION_SETUP_ANDX
op_star
id|pSMB
suffix:semicolon
id|SESSION_SETUP_ANDX
op_star
id|pSMBr
suffix:semicolon
r_char
op_star
id|bcc_ptr
suffix:semicolon
r_char
op_star
id|user
suffix:semicolon
r_char
op_star
id|domain
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|remaining_words
op_assign
l_int|0
suffix:semicolon
r_int
id|bytes_returned
op_assign
l_int|0
suffix:semicolon
r_int
id|len
suffix:semicolon
id|__u32
id|capabilities
suffix:semicolon
id|__u16
id|count
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;In sesssetup &quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ses
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|user
op_assign
id|ses-&gt;userName
suffix:semicolon
id|domain
op_assign
id|ses-&gt;domainName
suffix:semicolon
id|smb_buffer
op_assign
id|cifs_buf_get
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|smb_buffer
op_eq
l_int|0
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|smb_buffer_response
op_assign
id|smb_buffer
suffix:semicolon
id|pSMBr
op_assign
id|pSMB
op_assign
(paren
id|SESSION_SETUP_ANDX
op_star
)paren
id|smb_buffer
suffix:semicolon
multiline_comment|/* send SMBsessionSetup here */
id|header_assemble
c_func
(paren
id|smb_buffer
comma
id|SMB_COM_SESSION_SETUP_ANDX
comma
l_int|NULL
multiline_comment|/* no tCon exists yet */
comma
l_int|13
multiline_comment|/* wct */
)paren
suffix:semicolon
id|pSMB-&gt;req_no_secext.AndXCommand
op_assign
l_int|0xFF
suffix:semicolon
id|pSMB-&gt;req_no_secext.MaxBufferSize
op_assign
id|cpu_to_le16
c_func
(paren
id|ses-&gt;server-&gt;maxBuf
)paren
suffix:semicolon
id|pSMB-&gt;req_no_secext.MaxMpxCount
op_assign
id|cpu_to_le16
c_func
(paren
id|ses-&gt;server-&gt;maxReq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ses-&gt;server-&gt;secMode
op_amp
(paren
id|SECMODE_SIGN_REQUIRED
op_or
id|SECMODE_SIGN_ENABLED
)paren
)paren
(brace
id|smb_buffer-&gt;Flags2
op_or_assign
id|SMBFLG2_SECURITY_SIGNATURE
suffix:semicolon
)brace
id|capabilities
op_assign
id|CAP_LARGE_FILES
op_or
id|CAP_NT_SMBS
op_or
id|CAP_LEVEL_II_OPLOCKS
suffix:semicolon
r_if
c_cond
(paren
id|ses-&gt;capabilities
op_amp
id|CAP_UNICODE
)paren
(brace
id|smb_buffer-&gt;Flags2
op_or_assign
id|SMBFLG2_UNICODE
suffix:semicolon
id|capabilities
op_or_assign
id|CAP_UNICODE
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ses-&gt;capabilities
op_amp
id|CAP_STATUS32
)paren
(brace
id|smb_buffer-&gt;Flags2
op_or_assign
id|SMBFLG2_ERR_STATUS
suffix:semicolon
id|capabilities
op_or_assign
id|CAP_STATUS32
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ses-&gt;capabilities
op_amp
id|CAP_DFS
)paren
(brace
id|smb_buffer-&gt;Flags2
op_or_assign
id|SMBFLG2_DFS
suffix:semicolon
id|capabilities
op_or_assign
id|CAP_DFS
suffix:semicolon
)brace
id|pSMB-&gt;req_no_secext.Capabilities
op_assign
id|cpu_to_le32
c_func
(paren
id|capabilities
)paren
suffix:semicolon
id|pSMB-&gt;req_no_secext.CaseInsensitivePasswordLength
op_assign
id|cpu_to_le16
c_func
(paren
id|CIFS_SESSION_KEY_SIZE
)paren
suffix:semicolon
id|pSMB-&gt;req_no_secext.CaseSensitivePasswordLength
op_assign
id|cpu_to_le16
c_func
(paren
id|CIFS_SESSION_KEY_SIZE
)paren
suffix:semicolon
id|bcc_ptr
op_assign
id|pByteArea
c_func
(paren
id|smb_buffer
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|bcc_ptr
comma
(paren
r_char
op_star
)paren
id|session_key
comma
id|CIFS_SESSION_KEY_SIZE
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
id|CIFS_SESSION_KEY_SIZE
suffix:semicolon
id|memcpy
c_func
(paren
id|bcc_ptr
comma
(paren
r_char
op_star
)paren
id|session_key
comma
id|CIFS_SESSION_KEY_SIZE
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
id|CIFS_SESSION_KEY_SIZE
suffix:semicolon
r_if
c_cond
(paren
id|ses-&gt;capabilities
op_amp
id|CAP_UNICODE
)paren
(brace
r_if
c_cond
(paren
(paren
r_int
)paren
id|bcc_ptr
op_mod
l_int|2
)paren
(brace
multiline_comment|/* must be word aligned for Unicode */
op_star
id|bcc_ptr
op_assign
l_int|0
suffix:semicolon
id|bcc_ptr
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|user
op_eq
l_int|NULL
)paren
(brace
id|bytes_returned
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* skill null user */
r_else
id|bytes_returned
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
id|user
comma
l_int|100
comma
id|nls_codepage
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
op_star
id|bytes_returned
suffix:semicolon
multiline_comment|/* convert num 16 bit words to bytes */
id|bcc_ptr
op_add_assign
l_int|2
suffix:semicolon
multiline_comment|/* trailing null */
r_if
c_cond
(paren
id|domain
op_eq
l_int|NULL
)paren
id|bytes_returned
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
l_string|&quot;CIFS_LINUX_DOM&quot;
comma
l_int|32
comma
id|nls_codepage
)paren
suffix:semicolon
r_else
id|bytes_returned
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
id|domain
comma
l_int|64
comma
id|nls_codepage
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
op_star
id|bytes_returned
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
suffix:semicolon
id|bytes_returned
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
l_string|&quot;Linux version &quot;
comma
l_int|32
comma
id|nls_codepage
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
op_star
id|bytes_returned
suffix:semicolon
id|bytes_returned
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
id|UTS_RELEASE
comma
l_int|32
comma
id|nls_codepage
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
op_star
id|bytes_returned
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
suffix:semicolon
id|bytes_returned
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
id|CIFS_NETWORK_OPSYS
comma
l_int|64
comma
id|nls_codepage
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
op_star
id|bytes_returned
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|user
op_ne
l_int|NULL
)paren
(brace
id|strncpy
c_func
(paren
id|bcc_ptr
comma
id|user
comma
l_int|200
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
id|strnlen
c_func
(paren
id|user
comma
l_int|200
)paren
suffix:semicolon
)brace
op_star
id|bcc_ptr
op_assign
l_int|0
suffix:semicolon
id|bcc_ptr
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|domain
op_eq
l_int|NULL
)paren
(brace
id|strcpy
c_func
(paren
id|bcc_ptr
comma
l_string|&quot;CIFS_LINUX_DOM&quot;
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
id|strlen
c_func
(paren
l_string|&quot;CIFS_LINUX_DOM&quot;
)paren
op_plus
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|strncpy
c_func
(paren
id|bcc_ptr
comma
id|domain
comma
l_int|64
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
id|strnlen
c_func
(paren
id|domain
comma
l_int|64
)paren
suffix:semicolon
op_star
id|bcc_ptr
op_assign
l_int|0
suffix:semicolon
id|bcc_ptr
op_increment
suffix:semicolon
)brace
id|strcpy
c_func
(paren
id|bcc_ptr
comma
l_string|&quot;Linux version &quot;
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
id|strlen
c_func
(paren
l_string|&quot;Linux version &quot;
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|bcc_ptr
comma
id|UTS_RELEASE
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
id|strlen
c_func
(paren
id|UTS_RELEASE
)paren
op_plus
l_int|1
suffix:semicolon
id|strcpy
c_func
(paren
id|bcc_ptr
comma
id|CIFS_NETWORK_OPSYS
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
id|strlen
c_func
(paren
id|CIFS_NETWORK_OPSYS
)paren
op_plus
l_int|1
suffix:semicolon
)brace
id|count
op_assign
(paren
r_int
)paren
id|bcc_ptr
op_minus
(paren
r_int
)paren
id|pByteArea
c_func
(paren
id|smb_buffer
)paren
suffix:semicolon
id|smb_buffer-&gt;smb_buf_length
op_add_assign
id|count
suffix:semicolon
id|pSMB-&gt;req_no_secext.ByteCount
op_assign
id|cpu_to_le16
c_func
(paren
id|count
)paren
suffix:semicolon
id|rc
op_assign
id|SendReceive
c_func
(paren
id|xid
comma
id|ses
comma
id|smb_buffer
comma
id|smb_buffer_response
comma
op_amp
id|bytes_returned
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
multiline_comment|/* rc = map_smb_to_linux_error(smb_buffer_response); now done in SendReceive */
)brace
r_else
r_if
c_cond
(paren
(paren
id|smb_buffer_response-&gt;WordCount
op_eq
l_int|3
)paren
op_logical_or
(paren
id|smb_buffer_response-&gt;WordCount
op_eq
l_int|4
)paren
)paren
(brace
id|__u16
id|action
op_assign
id|le16_to_cpu
c_func
(paren
id|pSMBr-&gt;resp.Action
)paren
suffix:semicolon
id|__u16
id|blob_len
op_assign
id|le16_to_cpu
c_func
(paren
id|pSMBr-&gt;resp.SecurityBlobLength
)paren
suffix:semicolon
r_if
c_cond
(paren
id|action
op_amp
id|GUEST_LOGIN
)paren
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot; Guest login&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* do we want to mark SesInfo struct ? */
id|ses-&gt;Suid
op_assign
id|smb_buffer_response-&gt;Uid
suffix:semicolon
multiline_comment|/* UID left in wire format (le) */
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;UID = %d &quot;
comma
id|ses-&gt;Suid
)paren
)paren
suffix:semicolon
multiline_comment|/* response can have either 3 or 4 word count - Samba sends 3 */
id|bcc_ptr
op_assign
id|pByteArea
c_func
(paren
id|smb_buffer_response
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pSMBr-&gt;resp.hdr.WordCount
op_eq
l_int|3
)paren
op_logical_or
(paren
(paren
id|pSMBr-&gt;resp.hdr.WordCount
op_eq
l_int|4
)paren
op_logical_and
(paren
id|blob_len
OL
id|pSMBr-&gt;resp.ByteCount
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|pSMBr-&gt;resp.hdr.WordCount
op_eq
l_int|4
)paren
id|bcc_ptr
op_add_assign
id|blob_len
suffix:semicolon
r_if
c_cond
(paren
id|smb_buffer-&gt;Flags2
op_amp
id|SMBFLG2_UNICODE
)paren
(brace
r_if
c_cond
(paren
(paren
r_int
)paren
(paren
id|bcc_ptr
)paren
op_mod
l_int|2
)paren
(brace
id|remaining_words
op_assign
(paren
id|BCC
c_func
(paren
id|smb_buffer_response
)paren
op_minus
l_int|1
)paren
op_div
l_int|2
suffix:semicolon
id|bcc_ptr
op_increment
suffix:semicolon
multiline_comment|/* Unicode strings must be word aligned */
)brace
r_else
(brace
id|remaining_words
op_assign
id|BCC
c_func
(paren
id|smb_buffer_response
)paren
op_div
l_int|2
suffix:semicolon
)brace
id|len
op_assign
id|UniStrnlen
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
id|remaining_words
op_minus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* We look for obvious messed up bcc or strings in response so we do not go off&n;   the end since (at least) WIN2K and Windows XP have a major bug in not null&n;   terminating last Unicode string in response  */
id|ses-&gt;serverOS
op_assign
id|cifs_kcalloc
c_func
(paren
l_int|2
op_star
(paren
id|len
op_plus
l_int|1
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|cifs_strfromUCS_le
c_func
(paren
id|ses-&gt;serverOS
comma
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
id|len
comma
id|nls_codepage
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
op_star
(paren
id|len
op_plus
l_int|1
)paren
suffix:semicolon
id|remaining_words
op_sub_assign
id|len
op_plus
l_int|1
suffix:semicolon
id|ses-&gt;serverOS
(braket
l_int|2
op_star
id|len
)braket
op_assign
l_int|0
suffix:semicolon
id|ses-&gt;serverOS
(braket
l_int|1
op_plus
(paren
l_int|2
op_star
id|len
)paren
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|remaining_words
OG
l_int|0
)paren
(brace
id|len
op_assign
id|UniStrnlen
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
id|remaining_words
op_minus
l_int|1
)paren
suffix:semicolon
id|ses-&gt;serverNOS
op_assign
id|cifs_kcalloc
c_func
(paren
l_int|2
op_star
(paren
id|len
op_plus
l_int|1
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|cifs_strfromUCS_le
c_func
(paren
id|ses-&gt;serverNOS
comma
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
id|len
comma
id|nls_codepage
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
op_star
(paren
id|len
op_plus
l_int|1
)paren
suffix:semicolon
id|ses-&gt;serverNOS
(braket
l_int|2
op_star
id|len
)braket
op_assign
l_int|0
suffix:semicolon
id|ses-&gt;serverNOS
(braket
l_int|1
op_plus
(paren
l_int|2
op_star
id|len
)paren
)braket
op_assign
l_int|0
suffix:semicolon
id|remaining_words
op_sub_assign
id|len
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|remaining_words
OG
l_int|0
)paren
(brace
id|len
op_assign
id|UniStrnlen
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
id|remaining_words
)paren
suffix:semicolon
multiline_comment|/* last string is not always null terminated (for e.g. for Windows XP &amp; 2000) */
id|ses-&gt;serverDomain
op_assign
id|cifs_kcalloc
c_func
(paren
l_int|2
op_star
(paren
id|len
op_plus
l_int|1
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|cifs_strfromUCS_le
c_func
(paren
id|ses-&gt;serverDomain
comma
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
id|len
comma
id|nls_codepage
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
op_star
(paren
id|len
op_plus
l_int|1
)paren
suffix:semicolon
id|ses-&gt;serverDomain
(braket
l_int|2
op_star
id|len
)braket
op_assign
l_int|0
suffix:semicolon
id|ses-&gt;serverDomain
(braket
l_int|1
op_plus
(paren
l_int|2
op_star
id|len
)paren
)braket
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* else no more room so create dummy domain string */
r_else
id|ses-&gt;serverDomain
op_assign
id|cifs_kcalloc
c_func
(paren
l_int|2
comma
id|GFP_KERNEL
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* no room so create dummy domain and NOS string */
id|ses-&gt;serverDomain
op_assign
id|cifs_kcalloc
c_func
(paren
l_int|2
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|ses-&gt;serverNOS
op_assign
id|cifs_kcalloc
c_func
(paren
l_int|2
comma
id|GFP_KERNEL
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* ASCII */
id|len
op_assign
id|strnlen
c_func
(paren
id|bcc_ptr
comma
l_int|1024
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
r_int
)paren
id|bcc_ptr
op_plus
id|len
)paren
op_minus
(paren
r_int
)paren
id|pByteArea
c_func
(paren
id|smb_buffer_response
)paren
op_le
id|BCC
c_func
(paren
id|smb_buffer_response
)paren
)paren
(brace
id|ses-&gt;serverOS
op_assign
id|cifs_kcalloc
c_func
(paren
id|len
op_plus
l_int|1
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|ses-&gt;serverOS
comma
id|bcc_ptr
comma
id|len
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
id|len
suffix:semicolon
id|bcc_ptr
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* null terminate the string */
id|bcc_ptr
op_increment
suffix:semicolon
id|len
op_assign
id|strnlen
c_func
(paren
id|bcc_ptr
comma
l_int|1024
)paren
suffix:semicolon
id|ses-&gt;serverNOS
op_assign
id|cifs_kcalloc
c_func
(paren
id|len
op_plus
l_int|1
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|ses-&gt;serverNOS
comma
id|bcc_ptr
comma
id|len
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
id|len
suffix:semicolon
id|bcc_ptr
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|bcc_ptr
op_increment
suffix:semicolon
id|len
op_assign
id|strnlen
c_func
(paren
id|bcc_ptr
comma
l_int|1024
)paren
suffix:semicolon
id|ses-&gt;serverDomain
op_assign
id|cifs_kcalloc
c_func
(paren
id|len
op_plus
l_int|1
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|ses-&gt;serverDomain
comma
id|bcc_ptr
comma
id|len
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
id|len
suffix:semicolon
id|bcc_ptr
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|bcc_ptr
op_increment
suffix:semicolon
)brace
r_else
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Variable field of length %d extends beyond end of smb &quot;
comma
id|len
)paren
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|cERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot; Security Blob Length extends beyond end of SMB&quot;
)paren
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|cERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot; Invalid Word count %d: &quot;
comma
id|smb_buffer_response-&gt;WordCount
)paren
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
)brace
r_if
c_cond
(paren
id|smb_buffer
)paren
id|cifs_buf_release
c_func
(paren
id|smb_buffer
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_static
r_int
DECL|function|CIFSSpnegoSessSetup
id|CIFSSpnegoSessSetup
c_func
(paren
r_int
r_int
id|xid
comma
r_struct
id|cifsSesInfo
op_star
id|ses
comma
r_char
op_star
id|SecurityBlob
comma
r_int
id|SecurityBlobLength
comma
r_const
r_struct
id|nls_table
op_star
id|nls_codepage
)paren
(brace
r_struct
id|smb_hdr
op_star
id|smb_buffer
suffix:semicolon
r_struct
id|smb_hdr
op_star
id|smb_buffer_response
suffix:semicolon
id|SESSION_SETUP_ANDX
op_star
id|pSMB
suffix:semicolon
id|SESSION_SETUP_ANDX
op_star
id|pSMBr
suffix:semicolon
r_char
op_star
id|bcc_ptr
suffix:semicolon
r_char
op_star
id|user
suffix:semicolon
r_char
op_star
id|domain
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|remaining_words
op_assign
l_int|0
suffix:semicolon
r_int
id|bytes_returned
op_assign
l_int|0
suffix:semicolon
r_int
id|len
suffix:semicolon
id|__u32
id|capabilities
suffix:semicolon
id|__u16
id|count
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;In spnego sesssetup &quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ses
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|user
op_assign
id|ses-&gt;userName
suffix:semicolon
id|domain
op_assign
id|ses-&gt;domainName
suffix:semicolon
id|smb_buffer
op_assign
id|cifs_buf_get
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|smb_buffer
op_eq
l_int|0
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|smb_buffer_response
op_assign
id|smb_buffer
suffix:semicolon
id|pSMBr
op_assign
id|pSMB
op_assign
(paren
id|SESSION_SETUP_ANDX
op_star
)paren
id|smb_buffer
suffix:semicolon
multiline_comment|/* send SMBsessionSetup here */
id|header_assemble
c_func
(paren
id|smb_buffer
comma
id|SMB_COM_SESSION_SETUP_ANDX
comma
l_int|NULL
multiline_comment|/* no tCon exists yet */
comma
l_int|12
multiline_comment|/* wct */
)paren
suffix:semicolon
id|pSMB-&gt;req.hdr.Flags2
op_or_assign
id|SMBFLG2_EXT_SEC
suffix:semicolon
id|pSMB-&gt;req.AndXCommand
op_assign
l_int|0xFF
suffix:semicolon
id|pSMB-&gt;req.MaxBufferSize
op_assign
id|cpu_to_le16
c_func
(paren
id|ses-&gt;server-&gt;maxBuf
)paren
suffix:semicolon
id|pSMB-&gt;req.MaxMpxCount
op_assign
id|cpu_to_le16
c_func
(paren
id|ses-&gt;server-&gt;maxReq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ses-&gt;server-&gt;secMode
op_amp
(paren
id|SECMODE_SIGN_REQUIRED
op_or
id|SECMODE_SIGN_ENABLED
)paren
)paren
(brace
id|smb_buffer-&gt;Flags2
op_or_assign
id|SMBFLG2_SECURITY_SIGNATURE
suffix:semicolon
)brace
id|capabilities
op_assign
id|CAP_LARGE_FILES
op_or
id|CAP_NT_SMBS
op_or
id|CAP_LEVEL_II_OPLOCKS
op_or
id|CAP_EXTENDED_SECURITY
suffix:semicolon
r_if
c_cond
(paren
id|ses-&gt;capabilities
op_amp
id|CAP_UNICODE
)paren
(brace
id|smb_buffer-&gt;Flags2
op_or_assign
id|SMBFLG2_UNICODE
suffix:semicolon
id|capabilities
op_or_assign
id|CAP_UNICODE
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ses-&gt;capabilities
op_amp
id|CAP_STATUS32
)paren
(brace
id|smb_buffer-&gt;Flags2
op_or_assign
id|SMBFLG2_ERR_STATUS
suffix:semicolon
id|capabilities
op_or_assign
id|CAP_STATUS32
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ses-&gt;capabilities
op_amp
id|CAP_DFS
)paren
(brace
id|smb_buffer-&gt;Flags2
op_or_assign
id|SMBFLG2_DFS
suffix:semicolon
id|capabilities
op_or_assign
id|CAP_DFS
suffix:semicolon
)brace
id|pSMB-&gt;req.Capabilities
op_assign
id|cpu_to_le32
c_func
(paren
id|capabilities
)paren
suffix:semicolon
id|pSMB-&gt;req.SecurityBlobLength
op_assign
id|cpu_to_le16
c_func
(paren
id|SecurityBlobLength
)paren
suffix:semicolon
id|bcc_ptr
op_assign
id|pByteArea
c_func
(paren
id|smb_buffer
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|bcc_ptr
comma
id|SecurityBlob
comma
id|SecurityBlobLength
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
id|SecurityBlobLength
suffix:semicolon
r_if
c_cond
(paren
id|ses-&gt;capabilities
op_amp
id|CAP_UNICODE
)paren
(brace
r_if
c_cond
(paren
(paren
r_int
)paren
id|bcc_ptr
op_mod
l_int|2
)paren
(brace
multiline_comment|/* must be word aligned for Unicode strings */
op_star
id|bcc_ptr
op_assign
l_int|0
suffix:semicolon
id|bcc_ptr
op_increment
suffix:semicolon
)brace
id|bytes_returned
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
id|user
comma
l_int|100
comma
id|nls_codepage
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
op_star
id|bytes_returned
suffix:semicolon
multiline_comment|/* convert num of 16 bit words to bytes */
id|bcc_ptr
op_add_assign
l_int|2
suffix:semicolon
multiline_comment|/* trailing null */
r_if
c_cond
(paren
id|domain
op_eq
l_int|NULL
)paren
id|bytes_returned
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
l_string|&quot;CIFS_LINUX_DOM&quot;
comma
l_int|32
comma
id|nls_codepage
)paren
suffix:semicolon
r_else
id|bytes_returned
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
id|domain
comma
l_int|64
comma
id|nls_codepage
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
op_star
id|bytes_returned
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
suffix:semicolon
id|bytes_returned
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
l_string|&quot;Linux version &quot;
comma
l_int|32
comma
id|nls_codepage
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
op_star
id|bytes_returned
suffix:semicolon
id|bytes_returned
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
id|UTS_RELEASE
comma
l_int|32
comma
id|nls_codepage
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
op_star
id|bytes_returned
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
suffix:semicolon
id|bytes_returned
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
id|CIFS_NETWORK_OPSYS
comma
l_int|64
comma
id|nls_codepage
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
op_star
id|bytes_returned
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
suffix:semicolon
)brace
r_else
(brace
id|strncpy
c_func
(paren
id|bcc_ptr
comma
id|user
comma
l_int|200
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
id|strnlen
c_func
(paren
id|user
comma
l_int|200
)paren
suffix:semicolon
op_star
id|bcc_ptr
op_assign
l_int|0
suffix:semicolon
id|bcc_ptr
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|domain
op_eq
l_int|NULL
)paren
(brace
id|strcpy
c_func
(paren
id|bcc_ptr
comma
l_string|&quot;CIFS_LINUX_DOM&quot;
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
id|strlen
c_func
(paren
l_string|&quot;CIFS_LINUX_DOM&quot;
)paren
op_plus
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|strncpy
c_func
(paren
id|bcc_ptr
comma
id|domain
comma
l_int|64
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
id|strnlen
c_func
(paren
id|domain
comma
l_int|64
)paren
suffix:semicolon
op_star
id|bcc_ptr
op_assign
l_int|0
suffix:semicolon
id|bcc_ptr
op_increment
suffix:semicolon
)brace
id|strcpy
c_func
(paren
id|bcc_ptr
comma
l_string|&quot;Linux version &quot;
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
id|strlen
c_func
(paren
l_string|&quot;Linux version &quot;
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|bcc_ptr
comma
id|UTS_RELEASE
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
id|strlen
c_func
(paren
id|UTS_RELEASE
)paren
op_plus
l_int|1
suffix:semicolon
id|strcpy
c_func
(paren
id|bcc_ptr
comma
id|CIFS_NETWORK_OPSYS
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
id|strlen
c_func
(paren
id|CIFS_NETWORK_OPSYS
)paren
op_plus
l_int|1
suffix:semicolon
)brace
id|count
op_assign
(paren
r_int
)paren
id|bcc_ptr
op_minus
(paren
r_int
)paren
id|pByteArea
c_func
(paren
id|smb_buffer
)paren
suffix:semicolon
id|smb_buffer-&gt;smb_buf_length
op_add_assign
id|count
suffix:semicolon
id|pSMB-&gt;req.ByteCount
op_assign
id|cpu_to_le16
c_func
(paren
id|count
)paren
suffix:semicolon
id|rc
op_assign
id|SendReceive
c_func
(paren
id|xid
comma
id|ses
comma
id|smb_buffer
comma
id|smb_buffer_response
comma
op_amp
id|bytes_returned
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
multiline_comment|/*    rc = map_smb_to_linux_error(smb_buffer_response);  */
multiline_comment|/* done in SendReceive now */
)brace
r_else
r_if
c_cond
(paren
(paren
id|smb_buffer_response-&gt;WordCount
op_eq
l_int|3
)paren
op_logical_or
(paren
id|smb_buffer_response-&gt;WordCount
op_eq
l_int|4
)paren
)paren
(brace
id|__u16
id|action
op_assign
id|le16_to_cpu
c_func
(paren
id|pSMBr-&gt;resp.Action
)paren
suffix:semicolon
id|__u16
id|blob_len
op_assign
id|le16_to_cpu
c_func
(paren
id|pSMBr-&gt;resp.SecurityBlobLength
)paren
suffix:semicolon
r_if
c_cond
(paren
id|action
op_amp
id|GUEST_LOGIN
)paren
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot; Guest login&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* BB do we want to set anything in SesInfo struct ? */
r_if
c_cond
(paren
id|ses
)paren
(brace
id|ses-&gt;Suid
op_assign
id|smb_buffer_response-&gt;Uid
suffix:semicolon
multiline_comment|/* UID left in wire format (le) */
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;UID = %d &quot;
comma
id|ses-&gt;Suid
)paren
)paren
suffix:semicolon
id|bcc_ptr
op_assign
id|pByteArea
c_func
(paren
id|smb_buffer_response
)paren
suffix:semicolon
multiline_comment|/* response can have either 3 or 4 word count - Samba sends 3 */
multiline_comment|/* BB Fix below to make endian neutral !! */
r_if
c_cond
(paren
(paren
id|pSMBr-&gt;resp.hdr.WordCount
op_eq
l_int|3
)paren
op_logical_or
(paren
(paren
id|pSMBr-&gt;resp.hdr.WordCount
op_eq
l_int|4
)paren
op_logical_and
(paren
id|blob_len
OL
id|pSMBr-&gt;resp.ByteCount
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|pSMBr-&gt;resp.hdr.WordCount
op_eq
l_int|4
)paren
(brace
id|bcc_ptr
op_add_assign
id|blob_len
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Security Blob Length %d &quot;
comma
id|blob_len
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|smb_buffer-&gt;Flags2
op_amp
id|SMBFLG2_UNICODE
)paren
(brace
r_if
c_cond
(paren
(paren
r_int
)paren
(paren
id|bcc_ptr
)paren
op_mod
l_int|2
)paren
(brace
id|remaining_words
op_assign
(paren
id|BCC
c_func
(paren
id|smb_buffer_response
)paren
op_minus
l_int|1
)paren
op_div
l_int|2
suffix:semicolon
id|bcc_ptr
op_increment
suffix:semicolon
multiline_comment|/* Unicode strings must be word aligned */
)brace
r_else
(brace
id|remaining_words
op_assign
id|BCC
(paren
id|smb_buffer_response
)paren
op_div
l_int|2
suffix:semicolon
)brace
id|len
op_assign
id|UniStrnlen
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
id|remaining_words
op_minus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* We look for obvious messed up bcc or strings in response so we do not go off&n;   the end since (at least) WIN2K and Windows XP have a major bug in not null&n;   terminating last Unicode string in response  */
id|ses-&gt;serverOS
op_assign
id|cifs_kcalloc
c_func
(paren
l_int|2
op_star
(paren
id|len
op_plus
l_int|1
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|cifs_strfromUCS_le
c_func
(paren
id|ses-&gt;serverOS
comma
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
id|len
comma
id|nls_codepage
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
op_star
(paren
id|len
op_plus
l_int|1
)paren
suffix:semicolon
id|remaining_words
op_sub_assign
id|len
op_plus
l_int|1
suffix:semicolon
id|ses-&gt;serverOS
(braket
l_int|2
op_star
id|len
)braket
op_assign
l_int|0
suffix:semicolon
id|ses-&gt;serverOS
(braket
l_int|1
op_plus
(paren
l_int|2
op_star
id|len
)paren
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|remaining_words
OG
l_int|0
)paren
(brace
id|len
op_assign
id|UniStrnlen
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
id|remaining_words
op_minus
l_int|1
)paren
suffix:semicolon
id|ses-&gt;serverNOS
op_assign
id|cifs_kcalloc
c_func
(paren
l_int|2
op_star
(paren
id|len
op_plus
l_int|1
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|cifs_strfromUCS_le
c_func
(paren
id|ses-&gt;serverNOS
comma
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
id|len
comma
id|nls_codepage
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
op_star
(paren
id|len
op_plus
l_int|1
)paren
suffix:semicolon
id|ses-&gt;serverNOS
(braket
l_int|2
op_star
id|len
)braket
op_assign
l_int|0
suffix:semicolon
id|ses-&gt;serverNOS
(braket
l_int|1
op_plus
(paren
l_int|2
op_star
id|len
)paren
)braket
op_assign
l_int|0
suffix:semicolon
id|remaining_words
op_sub_assign
id|len
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|remaining_words
OG
l_int|0
)paren
(brace
id|len
op_assign
id|UniStrnlen
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
id|remaining_words
)paren
suffix:semicolon
multiline_comment|/* last string is not always null terminated (for e.g. for Windows XP &amp; 2000) */
id|ses-&gt;serverDomain
op_assign
id|cifs_kcalloc
c_func
(paren
l_int|2
op_star
(paren
id|len
op_plus
l_int|1
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|cifs_strfromUCS_le
c_func
(paren
id|ses-&gt;serverDomain
comma
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
id|len
comma
id|nls_codepage
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
op_star
(paren
id|len
op_plus
l_int|1
)paren
suffix:semicolon
id|ses-&gt;serverDomain
(braket
l_int|2
op_star
id|len
)braket
op_assign
l_int|0
suffix:semicolon
id|ses-&gt;serverDomain
(braket
l_int|1
op_plus
(paren
l_int|2
op_star
id|len
)paren
)braket
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* else no more room so create dummy domain string */
r_else
id|ses-&gt;serverDomain
op_assign
id|cifs_kcalloc
c_func
(paren
l_int|2
comma
id|GFP_KERNEL
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* no room so create dummy domain and NOS string */
id|ses-&gt;serverDomain
op_assign
id|cifs_kcalloc
c_func
(paren
l_int|2
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|ses-&gt;serverNOS
op_assign
id|cifs_kcalloc
c_func
(paren
l_int|2
comma
id|GFP_KERNEL
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* ASCII */
id|len
op_assign
id|strnlen
c_func
(paren
id|bcc_ptr
comma
l_int|1024
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
r_int
)paren
id|bcc_ptr
op_plus
id|len
)paren
op_minus
(paren
r_int
)paren
id|pByteArea
c_func
(paren
id|smb_buffer_response
)paren
op_le
id|BCC
c_func
(paren
id|smb_buffer_response
)paren
)paren
(brace
id|ses-&gt;serverOS
op_assign
id|cifs_kcalloc
c_func
(paren
id|len
op_plus
l_int|1
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|ses-&gt;serverOS
comma
id|bcc_ptr
comma
id|len
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
id|len
suffix:semicolon
id|bcc_ptr
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* null terminate the string */
id|bcc_ptr
op_increment
suffix:semicolon
id|len
op_assign
id|strnlen
c_func
(paren
id|bcc_ptr
comma
l_int|1024
)paren
suffix:semicolon
id|ses-&gt;serverNOS
op_assign
id|cifs_kcalloc
c_func
(paren
id|len
op_plus
l_int|1
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|ses-&gt;serverNOS
comma
id|bcc_ptr
comma
id|len
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
id|len
suffix:semicolon
id|bcc_ptr
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|bcc_ptr
op_increment
suffix:semicolon
id|len
op_assign
id|strnlen
c_func
(paren
id|bcc_ptr
comma
l_int|1024
)paren
suffix:semicolon
id|ses-&gt;serverDomain
op_assign
id|cifs_kcalloc
c_func
(paren
id|len
op_plus
l_int|1
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|ses-&gt;serverDomain
comma
id|bcc_ptr
comma
id|len
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
id|len
suffix:semicolon
id|bcc_ptr
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|bcc_ptr
op_increment
suffix:semicolon
)brace
r_else
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Variable field of length %d extends beyond end of smb &quot;
comma
id|len
)paren
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|cERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot; Security Blob Length extends beyond end of SMB&quot;
)paren
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|cERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;No session structure passed in.&quot;
)paren
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|cERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot; Invalid Word count %d: &quot;
comma
id|smb_buffer_response-&gt;WordCount
)paren
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
)brace
r_if
c_cond
(paren
id|smb_buffer
)paren
id|cifs_buf_release
c_func
(paren
id|smb_buffer
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_static
r_int
DECL|function|CIFSNTLMSSPNegotiateSessSetup
id|CIFSNTLMSSPNegotiateSessSetup
c_func
(paren
r_int
r_int
id|xid
comma
r_struct
id|cifsSesInfo
op_star
id|ses
comma
r_int
op_star
id|pNTLMv2_flag
comma
r_const
r_struct
id|nls_table
op_star
id|nls_codepage
)paren
(brace
r_struct
id|smb_hdr
op_star
id|smb_buffer
suffix:semicolon
r_struct
id|smb_hdr
op_star
id|smb_buffer_response
suffix:semicolon
id|SESSION_SETUP_ANDX
op_star
id|pSMB
suffix:semicolon
id|SESSION_SETUP_ANDX
op_star
id|pSMBr
suffix:semicolon
r_char
op_star
id|bcc_ptr
suffix:semicolon
r_char
op_star
id|domain
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|remaining_words
op_assign
l_int|0
suffix:semicolon
r_int
id|bytes_returned
op_assign
l_int|0
suffix:semicolon
r_int
id|len
suffix:semicolon
r_int
id|SecurityBlobLength
op_assign
r_sizeof
(paren
id|NEGOTIATE_MESSAGE
)paren
suffix:semicolon
id|PNEGOTIATE_MESSAGE
id|SecurityBlob
suffix:semicolon
id|PCHALLENGE_MESSAGE
id|SecurityBlob2
suffix:semicolon
id|__u32
id|negotiate_flags
comma
id|capabilities
suffix:semicolon
id|__u16
id|count
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;In NTLMSSP sesssetup (negotiate) &quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ses
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|domain
op_assign
id|ses-&gt;domainName
suffix:semicolon
op_star
id|pNTLMv2_flag
op_assign
id|FALSE
suffix:semicolon
id|smb_buffer
op_assign
id|cifs_buf_get
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|smb_buffer
op_eq
l_int|0
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|smb_buffer_response
op_assign
id|smb_buffer
suffix:semicolon
id|pSMB
op_assign
(paren
id|SESSION_SETUP_ANDX
op_star
)paren
id|smb_buffer
suffix:semicolon
id|pSMBr
op_assign
(paren
id|SESSION_SETUP_ANDX
op_star
)paren
id|smb_buffer_response
suffix:semicolon
multiline_comment|/* send SMBsessionSetup here */
id|header_assemble
c_func
(paren
id|smb_buffer
comma
id|SMB_COM_SESSION_SETUP_ANDX
comma
l_int|NULL
multiline_comment|/* no tCon exists yet */
comma
l_int|12
multiline_comment|/* wct */
)paren
suffix:semicolon
id|pSMB-&gt;req.hdr.Flags2
op_or_assign
id|SMBFLG2_EXT_SEC
suffix:semicolon
id|pSMB-&gt;req.hdr.Flags
op_or_assign
(paren
id|SMBFLG_CASELESS
op_or
id|SMBFLG_CANONICAL_PATH_FORMAT
)paren
suffix:semicolon
id|pSMB-&gt;req.AndXCommand
op_assign
l_int|0xFF
suffix:semicolon
id|pSMB-&gt;req.MaxBufferSize
op_assign
id|cpu_to_le16
c_func
(paren
id|ses-&gt;server-&gt;maxBuf
)paren
suffix:semicolon
id|pSMB-&gt;req.MaxMpxCount
op_assign
id|cpu_to_le16
c_func
(paren
id|ses-&gt;server-&gt;maxReq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ses-&gt;server-&gt;secMode
op_amp
(paren
id|SECMODE_SIGN_REQUIRED
op_or
id|SECMODE_SIGN_ENABLED
)paren
)paren
(brace
id|smb_buffer-&gt;Flags2
op_or_assign
id|SMBFLG2_SECURITY_SIGNATURE
suffix:semicolon
)brace
id|capabilities
op_assign
id|CAP_LARGE_FILES
op_or
id|CAP_NT_SMBS
op_or
id|CAP_LEVEL_II_OPLOCKS
op_or
id|CAP_EXTENDED_SECURITY
suffix:semicolon
r_if
c_cond
(paren
id|ses-&gt;capabilities
op_amp
id|CAP_UNICODE
)paren
(brace
id|smb_buffer-&gt;Flags2
op_or_assign
id|SMBFLG2_UNICODE
suffix:semicolon
id|capabilities
op_or_assign
id|CAP_UNICODE
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ses-&gt;capabilities
op_amp
id|CAP_STATUS32
)paren
(brace
id|smb_buffer-&gt;Flags2
op_or_assign
id|SMBFLG2_ERR_STATUS
suffix:semicolon
id|capabilities
op_or_assign
id|CAP_STATUS32
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ses-&gt;capabilities
op_amp
id|CAP_DFS
)paren
(brace
id|smb_buffer-&gt;Flags2
op_or_assign
id|SMBFLG2_DFS
suffix:semicolon
id|capabilities
op_or_assign
id|CAP_DFS
suffix:semicolon
)brace
id|pSMB-&gt;req.Capabilities
op_assign
id|cpu_to_le32
c_func
(paren
id|capabilities
)paren
suffix:semicolon
id|bcc_ptr
op_assign
(paren
r_char
op_star
)paren
op_amp
id|pSMB-&gt;req.SecurityBlob
suffix:semicolon
id|SecurityBlob
op_assign
(paren
id|PNEGOTIATE_MESSAGE
)paren
id|bcc_ptr
suffix:semicolon
id|strncpy
c_func
(paren
id|SecurityBlob-&gt;Signature
comma
id|NTLMSSP_SIGNATURE
comma
l_int|8
)paren
suffix:semicolon
id|SecurityBlob-&gt;MessageType
op_assign
id|NtLmNegotiate
suffix:semicolon
id|negotiate_flags
op_assign
id|NTLMSSP_NEGOTIATE_UNICODE
op_or
id|NTLMSSP_NEGOTIATE_OEM
op_or
id|NTLMSSP_REQUEST_TARGET
op_or
id|NTLMSSP_NEGOTIATE_NTLM
op_or
l_int|0x80000000
op_or
multiline_comment|/* NTLMSSP_NEGOTIATE_ALWAYS_SIGN | */
id|NTLMSSP_NEGOTIATE_128
suffix:semicolon
r_if
c_cond
(paren
id|sign_CIFS_PDUs
)paren
(brace
id|negotiate_flags
op_or_assign
id|NTLMSSP_NEGOTIATE_SIGN
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ntlmv2_support
)paren
(brace
id|negotiate_flags
op_or_assign
id|NTLMSSP_NEGOTIATE_NTLMV2
suffix:semicolon
)brace
multiline_comment|/* setup pointers to domain name and workstation name */
id|bcc_ptr
op_add_assign
id|SecurityBlobLength
suffix:semicolon
id|SecurityBlob-&gt;WorkstationName.Buffer
op_assign
l_int|0
suffix:semicolon
id|SecurityBlob-&gt;WorkstationName.Length
op_assign
l_int|0
suffix:semicolon
id|SecurityBlob-&gt;WorkstationName.MaximumLength
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|domain
op_eq
l_int|NULL
)paren
(brace
id|SecurityBlob-&gt;DomainName.Buffer
op_assign
l_int|0
suffix:semicolon
id|SecurityBlob-&gt;DomainName.Length
op_assign
l_int|0
suffix:semicolon
id|SecurityBlob-&gt;DomainName.MaximumLength
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|__u16
id|len
suffix:semicolon
id|negotiate_flags
op_or_assign
id|NTLMSSP_NEGOTIATE_DOMAIN_SUPPLIED
suffix:semicolon
id|strncpy
c_func
(paren
id|bcc_ptr
comma
id|domain
comma
l_int|63
)paren
suffix:semicolon
id|len
op_assign
id|strnlen
c_func
(paren
id|domain
comma
l_int|64
)paren
suffix:semicolon
id|SecurityBlob-&gt;DomainName.MaximumLength
op_assign
id|cpu_to_le16
c_func
(paren
id|len
)paren
suffix:semicolon
id|SecurityBlob-&gt;DomainName.Buffer
op_assign
id|cpu_to_le32
c_func
(paren
(paren
r_int
)paren
op_amp
id|SecurityBlob
op_member_access_from_pointer
id|DomainString
op_minus
(paren
r_int
)paren
op_amp
id|SecurityBlob-&gt;Signature
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
id|len
suffix:semicolon
id|SecurityBlobLength
op_add_assign
id|len
suffix:semicolon
id|SecurityBlob-&gt;DomainName.Length
op_assign
id|cpu_to_le16
c_func
(paren
id|len
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ses-&gt;capabilities
op_amp
id|CAP_UNICODE
)paren
(brace
r_if
c_cond
(paren
(paren
r_int
)paren
id|bcc_ptr
op_mod
l_int|2
)paren
(brace
op_star
id|bcc_ptr
op_assign
l_int|0
suffix:semicolon
id|bcc_ptr
op_increment
suffix:semicolon
)brace
id|bytes_returned
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
l_string|&quot;Linux version &quot;
comma
l_int|32
comma
id|nls_codepage
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
op_star
id|bytes_returned
suffix:semicolon
id|bytes_returned
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
id|UTS_RELEASE
comma
l_int|32
comma
id|nls_codepage
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
op_star
id|bytes_returned
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
suffix:semicolon
multiline_comment|/* null terminate Linux version */
id|bytes_returned
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
id|CIFS_NETWORK_OPSYS
comma
l_int|64
comma
id|nls_codepage
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
op_star
id|bytes_returned
suffix:semicolon
op_star
(paren
id|bcc_ptr
op_plus
l_int|1
)paren
op_assign
l_int|0
suffix:semicolon
op_star
(paren
id|bcc_ptr
op_plus
l_int|2
)paren
op_assign
l_int|0
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
suffix:semicolon
multiline_comment|/* null terminate network opsys string */
op_star
(paren
id|bcc_ptr
op_plus
l_int|1
)paren
op_assign
l_int|0
suffix:semicolon
op_star
(paren
id|bcc_ptr
op_plus
l_int|2
)paren
op_assign
l_int|0
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
suffix:semicolon
multiline_comment|/* null domain */
)brace
r_else
(brace
multiline_comment|/* ASCII */
id|strcpy
c_func
(paren
id|bcc_ptr
comma
l_string|&quot;Linux version &quot;
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
id|strlen
c_func
(paren
l_string|&quot;Linux version &quot;
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|bcc_ptr
comma
id|UTS_RELEASE
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
id|strlen
c_func
(paren
id|UTS_RELEASE
)paren
op_plus
l_int|1
suffix:semicolon
id|strcpy
c_func
(paren
id|bcc_ptr
comma
id|CIFS_NETWORK_OPSYS
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
id|strlen
c_func
(paren
id|CIFS_NETWORK_OPSYS
)paren
op_plus
l_int|1
suffix:semicolon
id|bcc_ptr
op_increment
suffix:semicolon
multiline_comment|/* empty domain field */
op_star
id|bcc_ptr
op_assign
l_int|0
suffix:semicolon
)brace
id|SecurityBlob-&gt;NegotiateFlags
op_assign
id|cpu_to_le32
c_func
(paren
id|negotiate_flags
)paren
suffix:semicolon
id|pSMB-&gt;req.SecurityBlobLength
op_assign
id|cpu_to_le16
c_func
(paren
id|SecurityBlobLength
)paren
suffix:semicolon
id|count
op_assign
(paren
r_int
)paren
id|bcc_ptr
op_minus
(paren
r_int
)paren
id|pByteArea
c_func
(paren
id|smb_buffer
)paren
suffix:semicolon
id|smb_buffer-&gt;smb_buf_length
op_add_assign
id|count
suffix:semicolon
id|pSMB-&gt;req.ByteCount
op_assign
id|cpu_to_le16
c_func
(paren
id|count
)paren
suffix:semicolon
id|rc
op_assign
id|SendReceive
c_func
(paren
id|xid
comma
id|ses
comma
id|smb_buffer
comma
id|smb_buffer_response
comma
op_amp
id|bytes_returned
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|smb_buffer_response-&gt;Status.CifsError
op_eq
id|cpu_to_le32
c_func
(paren
id|NT_STATUS_MORE_PROCESSING_REQUIRED
)paren
)paren
id|rc
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
multiline_comment|/*    rc = map_smb_to_linux_error(smb_buffer_response);  */
multiline_comment|/* done in SendReceive now */
)brace
r_else
r_if
c_cond
(paren
(paren
id|smb_buffer_response-&gt;WordCount
op_eq
l_int|3
)paren
op_logical_or
(paren
id|smb_buffer_response-&gt;WordCount
op_eq
l_int|4
)paren
)paren
(brace
id|__u16
id|action
op_assign
id|le16_to_cpu
c_func
(paren
id|pSMBr-&gt;resp.Action
)paren
suffix:semicolon
id|__u16
id|blob_len
op_assign
id|le16_to_cpu
c_func
(paren
id|pSMBr-&gt;resp.SecurityBlobLength
)paren
suffix:semicolon
r_if
c_cond
(paren
id|action
op_amp
id|GUEST_LOGIN
)paren
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot; Guest login&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* Do we want to set anything in SesInfo struct when guest login? */
id|bcc_ptr
op_assign
id|pByteArea
c_func
(paren
id|smb_buffer_response
)paren
suffix:semicolon
multiline_comment|/* response can have either 3 or 4 word count - Samba sends 3 */
id|SecurityBlob2
op_assign
(paren
id|PCHALLENGE_MESSAGE
)paren
id|bcc_ptr
suffix:semicolon
r_if
c_cond
(paren
id|SecurityBlob2-&gt;MessageType
op_ne
id|NtLmChallenge
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Unexpected NTLMSSP message type received %d&quot;
comma
id|SecurityBlob2-&gt;MessageType
)paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ses
)paren
(brace
id|ses-&gt;Suid
op_assign
id|smb_buffer_response-&gt;Uid
suffix:semicolon
multiline_comment|/* UID left in le format */
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;UID = %d &quot;
comma
id|ses-&gt;Suid
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pSMBr-&gt;resp.hdr.WordCount
op_eq
l_int|3
)paren
op_logical_or
(paren
(paren
id|pSMBr-&gt;resp.hdr.WordCount
op_eq
l_int|4
)paren
op_logical_and
(paren
id|blob_len
OL
id|pSMBr-&gt;resp.ByteCount
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|pSMBr-&gt;resp.hdr.WordCount
op_eq
l_int|4
)paren
(brace
id|bcc_ptr
op_add_assign
id|blob_len
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Security Blob Length %d &quot;
comma
id|blob_len
)paren
)paren
suffix:semicolon
)brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;NTLMSSP Challenge rcvd &quot;
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|ses-&gt;server-&gt;cryptKey
comma
id|SecurityBlob2-&gt;Challenge
comma
id|CIFS_CRYPTO_KEY_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SecurityBlob2-&gt;NegotiateFlags
op_amp
id|cpu_to_le32
c_func
(paren
id|NTLMSSP_NEGOTIATE_NTLMV2
)paren
)paren
(brace
op_star
id|pNTLMv2_flag
op_assign
id|TRUE
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|SecurityBlob2-&gt;NegotiateFlags
op_amp
id|cpu_to_le32
c_func
(paren
id|NTLMSSP_NEGOTIATE_ALWAYS_SIGN
)paren
)paren
op_logical_or
(paren
id|sign_CIFS_PDUs
OG
l_int|1
)paren
)paren
(brace
id|ses-&gt;server-&gt;secMode
op_or_assign
id|SECMODE_SIGN_REQUIRED
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|SecurityBlob2-&gt;NegotiateFlags
op_amp
id|cpu_to_le32
c_func
(paren
id|NTLMSSP_NEGOTIATE_SIGN
)paren
)paren
op_logical_and
(paren
id|sign_CIFS_PDUs
)paren
)paren
id|ses-&gt;server-&gt;secMode
op_or_assign
id|SECMODE_SIGN_ENABLED
suffix:semicolon
r_if
c_cond
(paren
id|smb_buffer-&gt;Flags2
op_amp
id|SMBFLG2_UNICODE
)paren
(brace
r_if
c_cond
(paren
(paren
r_int
)paren
(paren
id|bcc_ptr
)paren
op_mod
l_int|2
)paren
(brace
id|remaining_words
op_assign
(paren
id|BCC
c_func
(paren
id|smb_buffer_response
)paren
op_minus
l_int|1
)paren
op_div
l_int|2
suffix:semicolon
id|bcc_ptr
op_increment
suffix:semicolon
multiline_comment|/* Unicode strings must be word aligned */
)brace
r_else
(brace
id|remaining_words
op_assign
id|BCC
(paren
id|smb_buffer_response
)paren
op_div
l_int|2
suffix:semicolon
)brace
id|len
op_assign
id|UniStrnlen
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
id|remaining_words
op_minus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* We look for obvious messed up bcc or strings in response so we do not go off&n;   the end since (at least) WIN2K and Windows XP have a major bug in not null&n;   terminating last Unicode string in response  */
id|ses-&gt;serverOS
op_assign
id|cifs_kcalloc
c_func
(paren
l_int|2
op_star
(paren
id|len
op_plus
l_int|1
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|cifs_strfromUCS_le
c_func
(paren
id|ses-&gt;serverOS
comma
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
id|len
comma
id|nls_codepage
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
op_star
(paren
id|len
op_plus
l_int|1
)paren
suffix:semicolon
id|remaining_words
op_sub_assign
id|len
op_plus
l_int|1
suffix:semicolon
id|ses-&gt;serverOS
(braket
l_int|2
op_star
id|len
)braket
op_assign
l_int|0
suffix:semicolon
id|ses-&gt;serverOS
(braket
l_int|1
op_plus
(paren
l_int|2
op_star
id|len
)paren
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|remaining_words
OG
l_int|0
)paren
(brace
id|len
op_assign
id|UniStrnlen
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
id|remaining_words
op_minus
l_int|1
)paren
suffix:semicolon
id|ses-&gt;serverNOS
op_assign
id|cifs_kcalloc
c_func
(paren
l_int|2
op_star
(paren
id|len
op_plus
l_int|1
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|cifs_strfromUCS_le
c_func
(paren
id|ses
op_member_access_from_pointer
id|serverNOS
comma
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
id|len
comma
id|nls_codepage
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
op_star
(paren
id|len
op_plus
l_int|1
)paren
suffix:semicolon
id|ses-&gt;serverNOS
(braket
l_int|2
op_star
id|len
)braket
op_assign
l_int|0
suffix:semicolon
id|ses-&gt;serverNOS
(braket
l_int|1
op_plus
(paren
l_int|2
op_star
id|len
)paren
)braket
op_assign
l_int|0
suffix:semicolon
id|remaining_words
op_sub_assign
id|len
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|remaining_words
OG
l_int|0
)paren
(brace
id|len
op_assign
id|UniStrnlen
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
id|remaining_words
)paren
suffix:semicolon
multiline_comment|/* last string is not always null terminated (for e.g. for Windows XP &amp; 2000) */
id|ses-&gt;serverDomain
op_assign
id|cifs_kcalloc
c_func
(paren
l_int|2
op_star
(paren
id|len
op_plus
l_int|1
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|cifs_strfromUCS_le
(paren
id|ses
op_member_access_from_pointer
id|serverDomain
comma
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
id|len
comma
id|nls_codepage
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
op_star
(paren
id|len
op_plus
l_int|1
)paren
suffix:semicolon
id|ses
op_member_access_from_pointer
id|serverDomain
(braket
l_int|2
op_star
id|len
)braket
op_assign
l_int|0
suffix:semicolon
id|ses
op_member_access_from_pointer
id|serverDomain
(braket
l_int|1
op_plus
(paren
l_int|2
op_star
id|len
)paren
)braket
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* else no more room so create dummy domain string */
r_else
id|ses-&gt;serverDomain
op_assign
id|cifs_kcalloc
c_func
(paren
l_int|2
comma
id|GFP_KERNEL
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* no room so create dummy domain and NOS string */
id|ses-&gt;serverDomain
op_assign
id|cifs_kcalloc
c_func
(paren
l_int|2
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|ses-&gt;serverNOS
op_assign
id|cifs_kcalloc
c_func
(paren
l_int|2
comma
id|GFP_KERNEL
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* ASCII */
id|len
op_assign
id|strnlen
c_func
(paren
id|bcc_ptr
comma
l_int|1024
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
r_int
)paren
id|bcc_ptr
op_plus
id|len
)paren
op_minus
(paren
r_int
)paren
id|pByteArea
c_func
(paren
id|smb_buffer_response
)paren
op_le
id|BCC
c_func
(paren
id|smb_buffer_response
)paren
)paren
(brace
id|ses-&gt;serverOS
op_assign
id|cifs_kcalloc
c_func
(paren
id|len
op_plus
l_int|1
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|ses-&gt;serverOS
comma
id|bcc_ptr
comma
id|len
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
id|len
suffix:semicolon
id|bcc_ptr
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* null terminate string */
id|bcc_ptr
op_increment
suffix:semicolon
id|len
op_assign
id|strnlen
c_func
(paren
id|bcc_ptr
comma
l_int|1024
)paren
suffix:semicolon
id|ses-&gt;serverNOS
op_assign
id|cifs_kcalloc
c_func
(paren
id|len
op_plus
l_int|1
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|ses-&gt;serverNOS
comma
id|bcc_ptr
comma
id|len
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
id|len
suffix:semicolon
id|bcc_ptr
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|bcc_ptr
op_increment
suffix:semicolon
id|len
op_assign
id|strnlen
c_func
(paren
id|bcc_ptr
comma
l_int|1024
)paren
suffix:semicolon
id|ses-&gt;serverDomain
op_assign
id|cifs_kcalloc
c_func
(paren
id|len
op_plus
l_int|1
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|ses-&gt;serverDomain
comma
id|bcc_ptr
comma
id|len
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
id|len
suffix:semicolon
id|bcc_ptr
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|bcc_ptr
op_increment
suffix:semicolon
)brace
r_else
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Variable field of length %d extends beyond end of smb &quot;
comma
id|len
)paren
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|cERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot; Security Blob Length extends beyond end of SMB&quot;
)paren
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|cERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;No session structure passed in.&quot;
)paren
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|cERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot; Invalid Word count %d: &quot;
comma
id|smb_buffer_response-&gt;WordCount
)paren
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
)brace
r_if
c_cond
(paren
id|smb_buffer
)paren
id|cifs_buf_release
c_func
(paren
id|smb_buffer
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_static
r_int
DECL|function|CIFSNTLMSSPAuthSessSetup
id|CIFSNTLMSSPAuthSessSetup
c_func
(paren
r_int
r_int
id|xid
comma
r_struct
id|cifsSesInfo
op_star
id|ses
comma
r_char
op_star
id|ntlm_session_key
comma
r_int
id|ntlmv2_flag
comma
r_const
r_struct
id|nls_table
op_star
id|nls_codepage
)paren
(brace
r_struct
id|smb_hdr
op_star
id|smb_buffer
suffix:semicolon
r_struct
id|smb_hdr
op_star
id|smb_buffer_response
suffix:semicolon
id|SESSION_SETUP_ANDX
op_star
id|pSMB
suffix:semicolon
id|SESSION_SETUP_ANDX
op_star
id|pSMBr
suffix:semicolon
r_char
op_star
id|bcc_ptr
suffix:semicolon
r_char
op_star
id|user
suffix:semicolon
r_char
op_star
id|domain
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|remaining_words
op_assign
l_int|0
suffix:semicolon
r_int
id|bytes_returned
op_assign
l_int|0
suffix:semicolon
r_int
id|len
suffix:semicolon
r_int
id|SecurityBlobLength
op_assign
r_sizeof
(paren
id|AUTHENTICATE_MESSAGE
)paren
suffix:semicolon
id|PAUTHENTICATE_MESSAGE
id|SecurityBlob
suffix:semicolon
id|__u32
id|negotiate_flags
comma
id|capabilities
suffix:semicolon
id|__u16
id|count
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;In NTLMSSPSessSetup (Authenticate)&quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ses
op_eq
l_int|NULL
)paren
(brace
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
id|user
op_assign
id|ses-&gt;userName
suffix:semicolon
id|domain
op_assign
id|ses-&gt;domainName
suffix:semicolon
id|smb_buffer
op_assign
id|cifs_buf_get
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|smb_buffer
op_eq
l_int|0
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|smb_buffer_response
op_assign
id|smb_buffer
suffix:semicolon
id|pSMB
op_assign
(paren
id|SESSION_SETUP_ANDX
op_star
)paren
id|smb_buffer
suffix:semicolon
id|pSMBr
op_assign
(paren
id|SESSION_SETUP_ANDX
op_star
)paren
id|smb_buffer_response
suffix:semicolon
multiline_comment|/* send SMBsessionSetup here */
id|header_assemble
c_func
(paren
id|smb_buffer
comma
id|SMB_COM_SESSION_SETUP_ANDX
comma
l_int|NULL
multiline_comment|/* no tCon exists yet */
comma
l_int|12
multiline_comment|/* wct */
)paren
suffix:semicolon
id|pSMB-&gt;req.hdr.Flags
op_or_assign
(paren
id|SMBFLG_CASELESS
op_or
id|SMBFLG_CANONICAL_PATH_FORMAT
)paren
suffix:semicolon
id|pSMB-&gt;req.hdr.Flags2
op_or_assign
id|SMBFLG2_EXT_SEC
suffix:semicolon
id|pSMB-&gt;req.AndXCommand
op_assign
l_int|0xFF
suffix:semicolon
id|pSMB-&gt;req.MaxBufferSize
op_assign
id|cpu_to_le16
c_func
(paren
id|ses-&gt;server-&gt;maxBuf
)paren
suffix:semicolon
id|pSMB-&gt;req.MaxMpxCount
op_assign
id|cpu_to_le16
c_func
(paren
id|ses-&gt;server-&gt;maxReq
)paren
suffix:semicolon
id|pSMB-&gt;req.hdr.Uid
op_assign
id|ses-&gt;Suid
suffix:semicolon
r_if
c_cond
(paren
id|ses-&gt;server-&gt;secMode
op_amp
(paren
id|SECMODE_SIGN_REQUIRED
op_or
id|SECMODE_SIGN_ENABLED
)paren
)paren
(brace
id|smb_buffer-&gt;Flags2
op_or_assign
id|SMBFLG2_SECURITY_SIGNATURE
suffix:semicolon
)brace
id|capabilities
op_assign
id|CAP_LARGE_FILES
op_or
id|CAP_NT_SMBS
op_or
id|CAP_LEVEL_II_OPLOCKS
op_or
id|CAP_EXTENDED_SECURITY
suffix:semicolon
r_if
c_cond
(paren
id|ses-&gt;capabilities
op_amp
id|CAP_UNICODE
)paren
(brace
id|smb_buffer-&gt;Flags2
op_or_assign
id|SMBFLG2_UNICODE
suffix:semicolon
id|capabilities
op_or_assign
id|CAP_UNICODE
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ses-&gt;capabilities
op_amp
id|CAP_STATUS32
)paren
(brace
id|smb_buffer-&gt;Flags2
op_or_assign
id|SMBFLG2_ERR_STATUS
suffix:semicolon
id|capabilities
op_or_assign
id|CAP_STATUS32
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ses-&gt;capabilities
op_amp
id|CAP_DFS
)paren
(brace
id|smb_buffer-&gt;Flags2
op_or_assign
id|SMBFLG2_DFS
suffix:semicolon
id|capabilities
op_or_assign
id|CAP_DFS
suffix:semicolon
)brace
id|pSMB-&gt;req.Capabilities
op_assign
id|cpu_to_le32
c_func
(paren
id|capabilities
)paren
suffix:semicolon
id|bcc_ptr
op_assign
(paren
r_char
op_star
)paren
op_amp
id|pSMB-&gt;req.SecurityBlob
suffix:semicolon
id|SecurityBlob
op_assign
(paren
id|PAUTHENTICATE_MESSAGE
)paren
id|bcc_ptr
suffix:semicolon
id|strncpy
c_func
(paren
id|SecurityBlob-&gt;Signature
comma
id|NTLMSSP_SIGNATURE
comma
l_int|8
)paren
suffix:semicolon
id|SecurityBlob-&gt;MessageType
op_assign
id|NtLmAuthenticate
suffix:semicolon
id|bcc_ptr
op_add_assign
id|SecurityBlobLength
suffix:semicolon
id|negotiate_flags
op_assign
id|NTLMSSP_NEGOTIATE_UNICODE
op_or
id|NTLMSSP_REQUEST_TARGET
op_or
id|NTLMSSP_NEGOTIATE_NTLM
op_or
id|NTLMSSP_NEGOTIATE_TARGET_INFO
op_or
l_int|0x80000000
op_or
id|NTLMSSP_NEGOTIATE_128
suffix:semicolon
r_if
c_cond
(paren
id|sign_CIFS_PDUs
)paren
(brace
id|negotiate_flags
op_or_assign
multiline_comment|/* NTLMSSP_NEGOTIATE_ALWAYS_SIGN |*/
id|NTLMSSP_NEGOTIATE_SIGN
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ntlmv2_flag
)paren
(brace
id|negotiate_flags
op_or_assign
id|NTLMSSP_NEGOTIATE_NTLMV2
suffix:semicolon
)brace
multiline_comment|/* setup pointers to domain name and workstation name */
id|SecurityBlob-&gt;WorkstationName.Buffer
op_assign
l_int|0
suffix:semicolon
id|SecurityBlob-&gt;WorkstationName.Length
op_assign
l_int|0
suffix:semicolon
id|SecurityBlob-&gt;WorkstationName.MaximumLength
op_assign
l_int|0
suffix:semicolon
id|SecurityBlob-&gt;SessionKey.Length
op_assign
l_int|0
suffix:semicolon
id|SecurityBlob-&gt;SessionKey.MaximumLength
op_assign
l_int|0
suffix:semicolon
id|SecurityBlob-&gt;SessionKey.Buffer
op_assign
l_int|0
suffix:semicolon
id|SecurityBlob-&gt;LmChallengeResponse.Length
op_assign
l_int|0
suffix:semicolon
id|SecurityBlob-&gt;LmChallengeResponse.MaximumLength
op_assign
l_int|0
suffix:semicolon
id|SecurityBlob-&gt;LmChallengeResponse.Buffer
op_assign
l_int|0
suffix:semicolon
id|SecurityBlob-&gt;NtChallengeResponse.Length
op_assign
id|cpu_to_le16
c_func
(paren
id|CIFS_SESSION_KEY_SIZE
)paren
suffix:semicolon
id|SecurityBlob-&gt;NtChallengeResponse.MaximumLength
op_assign
id|cpu_to_le16
c_func
(paren
id|CIFS_SESSION_KEY_SIZE
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|bcc_ptr
comma
id|ntlm_session_key
comma
id|CIFS_SESSION_KEY_SIZE
)paren
suffix:semicolon
id|SecurityBlob-&gt;NtChallengeResponse.Buffer
op_assign
id|cpu_to_le32
c_func
(paren
id|SecurityBlobLength
)paren
suffix:semicolon
id|SecurityBlobLength
op_add_assign
id|CIFS_SESSION_KEY_SIZE
suffix:semicolon
id|bcc_ptr
op_add_assign
id|CIFS_SESSION_KEY_SIZE
suffix:semicolon
r_if
c_cond
(paren
id|ses-&gt;capabilities
op_amp
id|CAP_UNICODE
)paren
(brace
r_if
c_cond
(paren
id|domain
op_eq
l_int|NULL
)paren
(brace
id|SecurityBlob-&gt;DomainName.Buffer
op_assign
l_int|0
suffix:semicolon
id|SecurityBlob-&gt;DomainName.Length
op_assign
l_int|0
suffix:semicolon
id|SecurityBlob-&gt;DomainName.MaximumLength
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|__u16
id|len
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
id|domain
comma
l_int|64
comma
id|nls_codepage
)paren
suffix:semicolon
id|len
op_mul_assign
l_int|2
suffix:semicolon
id|SecurityBlob-&gt;DomainName.MaximumLength
op_assign
id|cpu_to_le16
c_func
(paren
id|len
)paren
suffix:semicolon
id|SecurityBlob-&gt;DomainName.Buffer
op_assign
id|cpu_to_le32
c_func
(paren
id|SecurityBlobLength
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
id|len
suffix:semicolon
id|SecurityBlobLength
op_add_assign
id|len
suffix:semicolon
id|SecurityBlob-&gt;DomainName.Length
op_assign
id|cpu_to_le16
c_func
(paren
id|len
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|user
op_eq
l_int|NULL
)paren
(brace
id|SecurityBlob-&gt;UserName.Buffer
op_assign
l_int|0
suffix:semicolon
id|SecurityBlob-&gt;UserName.Length
op_assign
l_int|0
suffix:semicolon
id|SecurityBlob-&gt;UserName.MaximumLength
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|__u16
id|len
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
id|user
comma
l_int|64
comma
id|nls_codepage
)paren
suffix:semicolon
id|len
op_mul_assign
l_int|2
suffix:semicolon
id|SecurityBlob-&gt;UserName.MaximumLength
op_assign
id|cpu_to_le16
c_func
(paren
id|len
)paren
suffix:semicolon
id|SecurityBlob-&gt;UserName.Buffer
op_assign
id|cpu_to_le32
c_func
(paren
id|SecurityBlobLength
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
id|len
suffix:semicolon
id|SecurityBlobLength
op_add_assign
id|len
suffix:semicolon
id|SecurityBlob-&gt;UserName.Length
op_assign
id|cpu_to_le16
c_func
(paren
id|len
)paren
suffix:semicolon
)brace
multiline_comment|/* SecurityBlob-&gt;WorkstationName.Length = cifs_strtoUCS((wchar_t *) bcc_ptr, &quot;AMACHINE&quot;,64, nls_codepage);&n;&t;&t;   SecurityBlob-&gt;WorkstationName.Length *= 2;&n;&t;&t;   SecurityBlob-&gt;WorkstationName.MaximumLength = cpu_to_le16(SecurityBlob-&gt;WorkstationName.Length);&n;&t;&t;   SecurityBlob-&gt;WorkstationName.Buffer = cpu_to_le32(SecurityBlobLength);&n;&t;&t;   bcc_ptr += SecurityBlob-&gt;WorkstationName.Length;&n;&t;&t;   SecurityBlobLength += SecurityBlob-&gt;WorkstationName.Length;&n;&t;&t;   SecurityBlob-&gt;WorkstationName.Length = cpu_to_le16(SecurityBlob-&gt;WorkstationName.Length);  */
r_if
c_cond
(paren
(paren
r_int
)paren
id|bcc_ptr
op_mod
l_int|2
)paren
(brace
op_star
id|bcc_ptr
op_assign
l_int|0
suffix:semicolon
id|bcc_ptr
op_increment
suffix:semicolon
)brace
id|bytes_returned
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
l_string|&quot;Linux version &quot;
comma
l_int|32
comma
id|nls_codepage
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
op_star
id|bytes_returned
suffix:semicolon
id|bytes_returned
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
id|UTS_RELEASE
comma
l_int|32
comma
id|nls_codepage
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
op_star
id|bytes_returned
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
suffix:semicolon
multiline_comment|/* null term version string */
id|bytes_returned
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
id|CIFS_NETWORK_OPSYS
comma
l_int|64
comma
id|nls_codepage
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
op_star
id|bytes_returned
suffix:semicolon
op_star
(paren
id|bcc_ptr
op_plus
l_int|1
)paren
op_assign
l_int|0
suffix:semicolon
op_star
(paren
id|bcc_ptr
op_plus
l_int|2
)paren
op_assign
l_int|0
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
suffix:semicolon
multiline_comment|/* null terminate network opsys string */
op_star
(paren
id|bcc_ptr
op_plus
l_int|1
)paren
op_assign
l_int|0
suffix:semicolon
op_star
(paren
id|bcc_ptr
op_plus
l_int|2
)paren
op_assign
l_int|0
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
suffix:semicolon
multiline_comment|/* null domain */
)brace
r_else
(brace
multiline_comment|/* ASCII */
r_if
c_cond
(paren
id|domain
op_eq
l_int|NULL
)paren
(brace
id|SecurityBlob-&gt;DomainName.Buffer
op_assign
l_int|0
suffix:semicolon
id|SecurityBlob-&gt;DomainName.Length
op_assign
l_int|0
suffix:semicolon
id|SecurityBlob-&gt;DomainName.MaximumLength
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|__u16
id|len
suffix:semicolon
id|negotiate_flags
op_or_assign
id|NTLMSSP_NEGOTIATE_DOMAIN_SUPPLIED
suffix:semicolon
id|strncpy
c_func
(paren
id|bcc_ptr
comma
id|domain
comma
l_int|63
)paren
suffix:semicolon
id|len
op_assign
id|strnlen
c_func
(paren
id|domain
comma
l_int|64
)paren
suffix:semicolon
id|SecurityBlob-&gt;DomainName.MaximumLength
op_assign
id|cpu_to_le16
c_func
(paren
id|len
)paren
suffix:semicolon
id|SecurityBlob-&gt;DomainName.Buffer
op_assign
id|cpu_to_le32
c_func
(paren
id|SecurityBlobLength
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
id|len
suffix:semicolon
id|SecurityBlobLength
op_add_assign
id|len
suffix:semicolon
id|SecurityBlob-&gt;DomainName.Length
op_assign
id|cpu_to_le16
c_func
(paren
id|len
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|user
op_eq
l_int|NULL
)paren
(brace
id|SecurityBlob-&gt;UserName.Buffer
op_assign
l_int|0
suffix:semicolon
id|SecurityBlob-&gt;UserName.Length
op_assign
l_int|0
suffix:semicolon
id|SecurityBlob-&gt;UserName.MaximumLength
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|__u16
id|len
suffix:semicolon
id|strncpy
c_func
(paren
id|bcc_ptr
comma
id|user
comma
l_int|63
)paren
suffix:semicolon
id|len
op_assign
id|strnlen
c_func
(paren
id|user
comma
l_int|64
)paren
suffix:semicolon
id|SecurityBlob-&gt;UserName.MaximumLength
op_assign
id|cpu_to_le16
c_func
(paren
id|len
)paren
suffix:semicolon
id|SecurityBlob-&gt;UserName.Buffer
op_assign
id|cpu_to_le32
c_func
(paren
id|SecurityBlobLength
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
id|len
suffix:semicolon
id|SecurityBlobLength
op_add_assign
id|len
suffix:semicolon
id|SecurityBlob-&gt;UserName.Length
op_assign
id|cpu_to_le16
c_func
(paren
id|len
)paren
suffix:semicolon
)brace
multiline_comment|/* BB fill in our workstation name if known BB */
id|strcpy
c_func
(paren
id|bcc_ptr
comma
l_string|&quot;Linux version &quot;
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
id|strlen
c_func
(paren
l_string|&quot;Linux version &quot;
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|bcc_ptr
comma
id|UTS_RELEASE
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
id|strlen
c_func
(paren
id|UTS_RELEASE
)paren
op_plus
l_int|1
suffix:semicolon
id|strcpy
c_func
(paren
id|bcc_ptr
comma
id|CIFS_NETWORK_OPSYS
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
id|strlen
c_func
(paren
id|CIFS_NETWORK_OPSYS
)paren
op_plus
l_int|1
suffix:semicolon
id|bcc_ptr
op_increment
suffix:semicolon
multiline_comment|/* null domain */
op_star
id|bcc_ptr
op_assign
l_int|0
suffix:semicolon
)brace
id|SecurityBlob-&gt;NegotiateFlags
op_assign
id|cpu_to_le32
c_func
(paren
id|negotiate_flags
)paren
suffix:semicolon
id|pSMB-&gt;req.SecurityBlobLength
op_assign
id|cpu_to_le16
c_func
(paren
id|SecurityBlobLength
)paren
suffix:semicolon
id|count
op_assign
(paren
r_int
)paren
id|bcc_ptr
op_minus
(paren
r_int
)paren
id|pByteArea
c_func
(paren
id|smb_buffer
)paren
suffix:semicolon
id|smb_buffer-&gt;smb_buf_length
op_add_assign
id|count
suffix:semicolon
id|pSMB-&gt;req.ByteCount
op_assign
id|cpu_to_le16
c_func
(paren
id|count
)paren
suffix:semicolon
id|rc
op_assign
id|SendReceive
c_func
(paren
id|xid
comma
id|ses
comma
id|smb_buffer
comma
id|smb_buffer_response
comma
op_amp
id|bytes_returned
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
multiline_comment|/*    rc = map_smb_to_linux_error(smb_buffer_response);  */
multiline_comment|/* done in SendReceive now */
)brace
r_else
r_if
c_cond
(paren
(paren
id|smb_buffer_response-&gt;WordCount
op_eq
l_int|3
)paren
op_logical_or
(paren
id|smb_buffer_response-&gt;WordCount
op_eq
l_int|4
)paren
)paren
(brace
id|__u16
id|action
op_assign
id|le16_to_cpu
c_func
(paren
id|pSMBr-&gt;resp.Action
)paren
suffix:semicolon
id|__u16
id|blob_len
op_assign
id|le16_to_cpu
c_func
(paren
id|pSMBr-&gt;resp.SecurityBlobLength
)paren
suffix:semicolon
r_if
c_cond
(paren
id|action
op_amp
id|GUEST_LOGIN
)paren
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot; Guest login&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* BB do we want to set anything in SesInfo struct ? */
multiline_comment|/*        if(SecurityBlob2-&gt;MessageType != NtLm??){                               &n;                 cFYI(&quot;Unexpected message type on auth response is %d &quot;)); &n;        } */
r_if
c_cond
(paren
id|ses
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Does UID on challenge %d match auth response UID %d &quot;
comma
id|ses-&gt;Suid
comma
id|smb_buffer_response-&gt;Uid
)paren
)paren
suffix:semicolon
id|ses-&gt;Suid
op_assign
id|smb_buffer_response-&gt;Uid
suffix:semicolon
multiline_comment|/* UID left in wire format */
id|bcc_ptr
op_assign
id|pByteArea
c_func
(paren
id|smb_buffer_response
)paren
suffix:semicolon
multiline_comment|/* response can have either 3 or 4 word count - Samba sends 3 */
r_if
c_cond
(paren
(paren
id|pSMBr-&gt;resp.hdr.WordCount
op_eq
l_int|3
)paren
op_logical_or
(paren
(paren
id|pSMBr-&gt;resp.hdr.WordCount
op_eq
l_int|4
)paren
op_logical_and
(paren
id|blob_len
OL
id|pSMBr-&gt;resp.ByteCount
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|pSMBr-&gt;resp.hdr.WordCount
op_eq
l_int|4
)paren
(brace
id|bcc_ptr
op_add_assign
id|blob_len
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Security Blob Length %d &quot;
comma
id|blob_len
)paren
)paren
suffix:semicolon
)brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;NTLMSSP response to Authenticate &quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|smb_buffer-&gt;Flags2
op_amp
id|SMBFLG2_UNICODE
)paren
(brace
r_if
c_cond
(paren
(paren
r_int
)paren
(paren
id|bcc_ptr
)paren
op_mod
l_int|2
)paren
(brace
id|remaining_words
op_assign
(paren
id|BCC
c_func
(paren
id|smb_buffer_response
)paren
op_minus
l_int|1
)paren
op_div
l_int|2
suffix:semicolon
id|bcc_ptr
op_increment
suffix:semicolon
multiline_comment|/* Unicode strings must be word aligned */
)brace
r_else
(brace
id|remaining_words
op_assign
id|BCC
c_func
(paren
id|smb_buffer_response
)paren
op_div
l_int|2
suffix:semicolon
)brace
id|len
op_assign
id|UniStrnlen
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
id|remaining_words
op_minus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* We look for obvious messed up bcc or strings in response so we do not go off&n;  the end since (at least) WIN2K and Windows XP have a major bug in not null&n;  terminating last Unicode string in response  */
id|ses-&gt;serverOS
op_assign
id|cifs_kcalloc
c_func
(paren
l_int|2
op_star
(paren
id|len
op_plus
l_int|1
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|cifs_strfromUCS_le
c_func
(paren
id|ses-&gt;serverOS
comma
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
id|len
comma
id|nls_codepage
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
op_star
(paren
id|len
op_plus
l_int|1
)paren
suffix:semicolon
id|remaining_words
op_sub_assign
id|len
op_plus
l_int|1
suffix:semicolon
id|ses-&gt;serverOS
(braket
l_int|2
op_star
id|len
)braket
op_assign
l_int|0
suffix:semicolon
id|ses-&gt;serverOS
(braket
l_int|1
op_plus
(paren
l_int|2
op_star
id|len
)paren
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|remaining_words
OG
l_int|0
)paren
(brace
id|len
op_assign
id|UniStrnlen
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
id|remaining_words
op_minus
l_int|1
)paren
suffix:semicolon
id|ses-&gt;serverNOS
op_assign
id|cifs_kcalloc
c_func
(paren
l_int|2
op_star
(paren
id|len
op_plus
l_int|1
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|cifs_strfromUCS_le
c_func
(paren
id|ses
op_member_access_from_pointer
id|serverNOS
comma
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
id|len
comma
id|nls_codepage
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
op_star
(paren
id|len
op_plus
l_int|1
)paren
suffix:semicolon
id|ses-&gt;serverNOS
(braket
l_int|2
op_star
id|len
)braket
op_assign
l_int|0
suffix:semicolon
id|ses-&gt;serverNOS
(braket
l_int|1
op_plus
(paren
l_int|2
op_star
id|len
)paren
)braket
op_assign
l_int|0
suffix:semicolon
id|remaining_words
op_sub_assign
id|len
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|remaining_words
OG
l_int|0
)paren
(brace
id|len
op_assign
id|UniStrnlen
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
id|remaining_words
)paren
suffix:semicolon
multiline_comment|/* last string not always null terminated (e.g. for Windows XP &amp; 2000) */
id|ses-&gt;serverDomain
op_assign
id|cifs_kcalloc
c_func
(paren
l_int|2
op_star
(paren
id|len
op_plus
l_int|1
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|cifs_strfromUCS_le
(paren
id|ses
op_member_access_from_pointer
id|serverDomain
comma
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
id|len
comma
id|nls_codepage
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
op_star
(paren
id|len
op_plus
l_int|1
)paren
suffix:semicolon
id|ses
op_member_access_from_pointer
id|serverDomain
(braket
l_int|2
op_star
id|len
)braket
op_assign
l_int|0
suffix:semicolon
id|ses
op_member_access_from_pointer
id|serverDomain
(braket
l_int|1
op_plus
(paren
l_int|2
op_star
id|len
)paren
)braket
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* else no more room so create dummy domain string */
r_else
id|ses-&gt;serverDomain
op_assign
id|cifs_kcalloc
c_func
(paren
l_int|2
comma
id|GFP_KERNEL
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* no room so create dummy domain and NOS string */
id|ses-&gt;serverDomain
op_assign
id|cifs_kcalloc
c_func
(paren
l_int|2
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|ses-&gt;serverNOS
op_assign
id|cifs_kcalloc
c_func
(paren
l_int|2
comma
id|GFP_KERNEL
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* ASCII */
id|len
op_assign
id|strnlen
c_func
(paren
id|bcc_ptr
comma
l_int|1024
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
r_int
)paren
id|bcc_ptr
op_plus
id|len
)paren
op_minus
(paren
r_int
)paren
id|pByteArea
c_func
(paren
id|smb_buffer_response
)paren
op_le
id|BCC
c_func
(paren
id|smb_buffer_response
)paren
)paren
(brace
id|ses-&gt;serverOS
op_assign
id|cifs_kcalloc
c_func
(paren
id|len
op_plus
l_int|1
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|ses-&gt;serverOS
comma
id|bcc_ptr
comma
id|len
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
id|len
suffix:semicolon
id|bcc_ptr
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* null terminate the string */
id|bcc_ptr
op_increment
suffix:semicolon
id|len
op_assign
id|strnlen
c_func
(paren
id|bcc_ptr
comma
l_int|1024
)paren
suffix:semicolon
id|ses-&gt;serverNOS
op_assign
id|cifs_kcalloc
c_func
(paren
id|len
op_plus
l_int|1
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|ses-&gt;serverNOS
comma
id|bcc_ptr
comma
id|len
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
id|len
suffix:semicolon
id|bcc_ptr
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|bcc_ptr
op_increment
suffix:semicolon
id|len
op_assign
id|strnlen
c_func
(paren
id|bcc_ptr
comma
l_int|1024
)paren
suffix:semicolon
id|ses-&gt;serverDomain
op_assign
id|cifs_kcalloc
c_func
(paren
id|len
op_plus
l_int|1
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|ses-&gt;serverDomain
comma
id|bcc_ptr
comma
id|len
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
id|len
suffix:semicolon
id|bcc_ptr
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|bcc_ptr
op_increment
suffix:semicolon
)brace
r_else
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Variable field of length %d extends beyond end of smb &quot;
comma
id|len
)paren
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|cERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot; Security Blob Length extends beyond end of SMB&quot;
)paren
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|cERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;No session structure passed in.&quot;
)paren
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|cERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot; Invalid Word count %d: &quot;
comma
id|smb_buffer_response-&gt;WordCount
)paren
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
)brace
r_if
c_cond
(paren
id|smb_buffer
)paren
id|cifs_buf_release
c_func
(paren
id|smb_buffer
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_int
DECL|function|CIFSTCon
id|CIFSTCon
c_func
(paren
r_int
r_int
id|xid
comma
r_struct
id|cifsSesInfo
op_star
id|ses
comma
r_const
r_char
op_star
id|tree
comma
r_struct
id|cifsTconInfo
op_star
id|tcon
comma
r_const
r_struct
id|nls_table
op_star
id|nls_codepage
)paren
(brace
r_struct
id|smb_hdr
op_star
id|smb_buffer
suffix:semicolon
r_struct
id|smb_hdr
op_star
id|smb_buffer_response
suffix:semicolon
id|TCONX_REQ
op_star
id|pSMB
suffix:semicolon
id|TCONX_RSP
op_star
id|pSMBr
suffix:semicolon
r_int
r_char
op_star
id|bcc_ptr
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|length
suffix:semicolon
id|__u16
id|count
suffix:semicolon
r_if
c_cond
(paren
id|ses
op_eq
l_int|NULL
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|smb_buffer
op_assign
id|cifs_buf_get
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|smb_buffer
op_eq
l_int|0
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|smb_buffer_response
op_assign
id|smb_buffer
suffix:semicolon
id|header_assemble
c_func
(paren
id|smb_buffer
comma
id|SMB_COM_TREE_CONNECT_ANDX
comma
l_int|NULL
multiline_comment|/*no tid */
comma
l_int|4
multiline_comment|/*wct */
)paren
suffix:semicolon
id|smb_buffer-&gt;Uid
op_assign
id|ses-&gt;Suid
suffix:semicolon
id|pSMB
op_assign
(paren
id|TCONX_REQ
op_star
)paren
id|smb_buffer
suffix:semicolon
id|pSMBr
op_assign
(paren
id|TCONX_RSP
op_star
)paren
id|smb_buffer_response
suffix:semicolon
id|pSMB-&gt;AndXCommand
op_assign
l_int|0xFF
suffix:semicolon
id|pSMB-&gt;Flags
op_assign
id|cpu_to_le16
c_func
(paren
id|TCON_EXTENDED_SECINFO
)paren
suffix:semicolon
id|pSMB-&gt;PasswordLength
op_assign
id|cpu_to_le16
c_func
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* minimum */
id|bcc_ptr
op_assign
op_amp
id|pSMB-&gt;Password
(braket
l_int|0
)braket
suffix:semicolon
id|bcc_ptr
op_increment
suffix:semicolon
multiline_comment|/* skip password */
r_if
c_cond
(paren
id|ses-&gt;server-&gt;secMode
op_amp
(paren
id|SECMODE_SIGN_REQUIRED
op_or
id|SECMODE_SIGN_ENABLED
)paren
)paren
(brace
id|smb_buffer-&gt;Flags2
op_or_assign
id|SMBFLG2_SECURITY_SIGNATURE
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ses-&gt;capabilities
op_amp
id|CAP_STATUS32
)paren
(brace
id|smb_buffer-&gt;Flags2
op_or_assign
id|SMBFLG2_ERR_STATUS
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ses-&gt;capabilities
op_amp
id|CAP_DFS
)paren
(brace
id|smb_buffer-&gt;Flags2
op_or_assign
id|SMBFLG2_DFS
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ses-&gt;capabilities
op_amp
id|CAP_UNICODE
)paren
(brace
id|smb_buffer-&gt;Flags2
op_or_assign
id|SMBFLG2_UNICODE
suffix:semicolon
id|length
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
id|tree
comma
l_int|100
comma
id|nls_codepage
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
op_star
id|length
suffix:semicolon
multiline_comment|/* convert num of 16 bit words to bytes */
id|bcc_ptr
op_add_assign
l_int|2
suffix:semicolon
multiline_comment|/* skip trailing null */
)brace
r_else
(brace
multiline_comment|/* ASCII */
id|strcpy
c_func
(paren
id|bcc_ptr
comma
id|tree
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
id|strlen
c_func
(paren
id|tree
)paren
op_plus
l_int|1
suffix:semicolon
)brace
id|strcpy
c_func
(paren
id|bcc_ptr
comma
l_string|&quot;?????&quot;
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
id|strlen
c_func
(paren
l_string|&quot;?????&quot;
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|1
suffix:semicolon
id|count
op_assign
id|bcc_ptr
op_minus
op_amp
id|pSMB-&gt;Password
(braket
l_int|0
)braket
suffix:semicolon
id|pSMB-&gt;hdr.smb_buf_length
op_add_assign
id|count
suffix:semicolon
id|pSMB-&gt;ByteCount
op_assign
id|cpu_to_le16
c_func
(paren
id|count
)paren
suffix:semicolon
id|rc
op_assign
id|SendReceive
c_func
(paren
id|xid
comma
id|ses
comma
id|smb_buffer
comma
id|smb_buffer_response
comma
op_amp
id|length
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* if (rc) rc = map_smb_to_linux_error(smb_buffer_response); */
multiline_comment|/* above now done in SendReceive */
r_if
c_cond
(paren
(paren
id|rc
op_eq
l_int|0
)paren
op_logical_and
(paren
id|tcon
op_ne
l_int|NULL
)paren
)paren
(brace
id|tcon-&gt;tidStatus
op_assign
id|CifsGood
suffix:semicolon
id|tcon-&gt;tid
op_assign
id|smb_buffer_response-&gt;Tid
suffix:semicolon
id|bcc_ptr
op_assign
id|pByteArea
c_func
(paren
id|smb_buffer_response
)paren
suffix:semicolon
id|length
op_assign
id|strnlen
c_func
(paren
id|bcc_ptr
comma
id|BCC
c_func
(paren
id|smb_buffer_response
)paren
op_minus
l_int|2
)paren
suffix:semicolon
multiline_comment|/* skip service field (NB: this field is always ASCII) */
id|bcc_ptr
op_add_assign
id|length
op_plus
l_int|1
suffix:semicolon
id|strncpy
c_func
(paren
id|tcon-&gt;treeName
comma
id|tree
comma
id|MAX_TREE_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|smb_buffer-&gt;Flags2
op_amp
id|SMBFLG2_UNICODE
)paren
(brace
id|length
op_assign
id|UniStrnlen
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
l_int|512
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|bcc_ptr
op_plus
(paren
l_int|2
op_star
id|length
)paren
)paren
op_minus
id|pByteArea
c_func
(paren
id|smb_buffer_response
)paren
op_le
id|BCC
c_func
(paren
id|smb_buffer_response
)paren
)paren
(brace
r_if
c_cond
(paren
id|tcon-&gt;nativeFileSystem
)paren
(brace
id|kfree
c_func
(paren
id|tcon-&gt;nativeFileSystem
)paren
suffix:semicolon
)brace
id|tcon-&gt;nativeFileSystem
op_assign
id|cifs_kcalloc
c_func
(paren
id|length
op_plus
l_int|2
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|cifs_strfromUCS_le
c_func
(paren
id|tcon-&gt;nativeFileSystem
comma
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
id|length
comma
id|nls_codepage
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
op_star
id|length
suffix:semicolon
id|bcc_ptr
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* null terminate the string */
id|bcc_ptr
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
suffix:semicolon
)brace
multiline_comment|/* else do not bother copying these informational fields */
)brace
r_else
(brace
id|length
op_assign
id|strnlen
c_func
(paren
id|bcc_ptr
comma
l_int|1024
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|bcc_ptr
op_plus
id|length
)paren
op_minus
id|pByteArea
c_func
(paren
id|smb_buffer_response
)paren
op_le
id|BCC
c_func
(paren
id|smb_buffer_response
)paren
)paren
(brace
r_if
c_cond
(paren
id|tcon-&gt;nativeFileSystem
)paren
(brace
id|kfree
c_func
(paren
id|tcon-&gt;nativeFileSystem
)paren
suffix:semicolon
)brace
id|tcon-&gt;nativeFileSystem
op_assign
id|cifs_kcalloc
c_func
(paren
id|length
op_plus
l_int|1
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|tcon-&gt;nativeFileSystem
comma
id|bcc_ptr
comma
id|length
)paren
suffix:semicolon
)brace
multiline_comment|/* else do not bother copying these informational fields */
)brace
id|tcon-&gt;Flags
op_assign
id|le16_to_cpu
c_func
(paren
id|pSMBr-&gt;OptionalSupport
)paren
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Tcon flags: 0x%x &quot;
comma
id|tcon-&gt;Flags
)paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|rc
op_eq
l_int|0
)paren
op_logical_and
id|tcon
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* all we need to save for IPC$ connection */
id|ses-&gt;ipc_tid
op_assign
id|smb_buffer_response-&gt;Tid
suffix:semicolon
)brace
r_if
c_cond
(paren
id|smb_buffer
)paren
id|cifs_buf_release
c_func
(paren
id|smb_buffer
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_int
DECL|function|cifs_umount
id|cifs_umount
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|cifs_sb_info
op_star
id|cifs_sb
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|xid
suffix:semicolon
r_struct
id|cifsSesInfo
op_star
id|ses
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|task_struct
op_star
id|cifsd_task
suffix:semicolon
id|xid
op_assign
id|GetXid
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cifs_sb-&gt;tcon
)paren
(brace
id|ses
op_assign
id|cifs_sb-&gt;tcon-&gt;ses
suffix:semicolon
multiline_comment|/* save ptr to ses before delete tcon!*/
id|rc
op_assign
id|CIFSSMBTDis
c_func
(paren
id|xid
comma
id|cifs_sb-&gt;tcon
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
op_minus
id|EBUSY
)paren
(brace
id|FreeXid
c_func
(paren
id|xid
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|tconInfoFree
c_func
(paren
id|cifs_sb-&gt;tcon
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ses
)paren
op_logical_and
(paren
id|ses-&gt;server
)paren
)paren
(brace
multiline_comment|/* save off task so we do not refer to ses later */
id|cifsd_task
op_assign
id|ses-&gt;server-&gt;tsk
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;About to do SMBLogoff &quot;
)paren
)paren
suffix:semicolon
id|rc
op_assign
id|CIFSSMBLogoff
c_func
(paren
id|xid
comma
id|ses
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
op_minus
id|EBUSY
)paren
(brace
id|FreeXid
c_func
(paren
id|xid
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|rc
op_eq
op_minus
id|ESHUTDOWN
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Waking up socket by sending it signal&quot;
)paren
)paren
suffix:semicolon
id|send_sig
c_func
(paren
id|SIGKILL
comma
id|cifsd_task
comma
l_int|1
)paren
suffix:semicolon
id|rc
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* else - we have an smb session&n;&t;&t;&t;&t;left on this socket do not kill cifsd */
)brace
r_else
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;No session or bad tcon&quot;
)paren
)paren
suffix:semicolon
)brace
id|cifs_sb-&gt;tcon
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|ses
)paren
(brace
id|set_current_state
c_func
(paren
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|HZ
op_div
l_int|2
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ses
)paren
id|sesInfoFree
c_func
(paren
id|ses
)paren
suffix:semicolon
id|FreeXid
c_func
(paren
id|xid
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
multiline_comment|/* BB check if we should always return zero here */
)brace
DECL|function|cifs_setup_session
r_int
id|cifs_setup_session
c_func
(paren
r_int
r_int
id|xid
comma
r_struct
id|cifsSesInfo
op_star
id|pSesInfo
comma
r_struct
id|nls_table
op_star
id|nls_info
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_char
id|ntlm_session_key
(braket
id|CIFS_SESSION_KEY_SIZE
)braket
suffix:semicolon
r_int
id|ntlmv2_flag
op_assign
id|FALSE
suffix:semicolon
multiline_comment|/* what if server changes its buffer size after dropping the session? */
r_if
c_cond
(paren
id|pSesInfo-&gt;server-&gt;maxBuf
op_eq
l_int|0
)paren
multiline_comment|/* no need to send on reconnect */
(brace
id|rc
op_assign
id|CIFSSMBNegotiate
c_func
(paren
id|xid
comma
id|pSesInfo
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
op_minus
id|EAGAIN
)paren
multiline_comment|/* retry only once on 1st time connection */
(brace
id|rc
op_assign
id|CIFSSMBNegotiate
c_func
(paren
id|xid
comma
id|pSesInfo
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
op_minus
id|EAGAIN
)paren
(brace
id|rc
op_assign
op_minus
id|EHOSTDOWN
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
)paren
(brace
id|spin_lock
c_func
(paren
op_amp
id|GlobalMid_Lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pSesInfo-&gt;server-&gt;tcpStatus
op_ne
id|CifsExiting
)paren
(brace
id|pSesInfo-&gt;server-&gt;tcpStatus
op_assign
id|CifsGood
suffix:semicolon
)brace
r_else
id|rc
op_assign
op_minus
id|EHOSTDOWN
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|GlobalMid_Lock
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
op_logical_neg
id|rc
)paren
(brace
id|pSesInfo-&gt;capabilities
op_assign
id|pSesInfo-&gt;server-&gt;capabilities
suffix:semicolon
r_if
c_cond
(paren
id|linuxExtEnabled
op_eq
l_int|0
)paren
(brace
id|pSesInfo-&gt;capabilities
op_and_assign
(paren
op_complement
id|CAP_UNIX
)paren
suffix:semicolon
)brace
id|pSesInfo-&gt;sequence_number
op_assign
l_int|0
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Security Mode: 0x%x Capabilities: 0x%x Time Zone: %d&quot;
comma
id|pSesInfo-&gt;server-&gt;secMode
comma
id|pSesInfo-&gt;server-&gt;capabilities
comma
id|pSesInfo-&gt;server-&gt;timeZone
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|extended_security
op_logical_and
(paren
id|pSesInfo-&gt;capabilities
op_amp
id|CAP_EXTENDED_SECURITY
)paren
op_logical_and
(paren
id|pSesInfo-&gt;server-&gt;secType
op_eq
id|NTLMSSP
)paren
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;New style sesssetup &quot;
)paren
)paren
suffix:semicolon
id|rc
op_assign
id|CIFSSpnegoSessSetup
c_func
(paren
id|xid
comma
id|pSesInfo
comma
l_int|NULL
multiline_comment|/* security blob */
comma
l_int|0
multiline_comment|/* blob length */
comma
id|nls_info
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|extended_security
op_logical_and
(paren
id|pSesInfo-&gt;capabilities
op_amp
id|CAP_EXTENDED_SECURITY
)paren
op_logical_and
(paren
id|pSesInfo-&gt;server-&gt;secType
op_eq
id|RawNTLMSSP
)paren
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;NTLMSSP sesssetup &quot;
)paren
)paren
suffix:semicolon
id|rc
op_assign
id|CIFSNTLMSSPNegotiateSessSetup
c_func
(paren
id|xid
comma
id|pSesInfo
comma
op_amp
id|ntlmv2_flag
comma
id|nls_info
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rc
)paren
(brace
r_if
c_cond
(paren
id|ntlmv2_flag
)paren
(brace
r_char
op_star
id|v2_response
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Can use more secure NTLM version 2 password hash&quot;
)paren
)paren
suffix:semicolon
id|CalcNTLMv2_partial_mac_key
c_func
(paren
id|pSesInfo
comma
id|nls_info
)paren
suffix:semicolon
id|v2_response
op_assign
id|kmalloc
c_func
(paren
l_int|16
op_plus
l_int|64
multiline_comment|/* blob */
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|v2_response
)paren
(brace
id|CalcNTLMv2_response
c_func
(paren
id|pSesInfo
comma
id|v2_response
)paren
suffix:semicolon
multiline_comment|/*&t;&t;&t;&t;&t;&t;cifs_calculate_ntlmv2_mac_key(pSesInfo-&gt;mac_signing_key, response, ntlm_session_key, */
id|kfree
c_func
(paren
id|v2_response
)paren
suffix:semicolon
multiline_comment|/* BB Put dummy sig in SessSetup PDU? */
)brace
r_else
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_else
(brace
id|SMBNTencrypt
c_func
(paren
id|pSesInfo-&gt;password
comma
id|pSesInfo-&gt;server-&gt;cryptKey
comma
id|ntlm_session_key
)paren
suffix:semicolon
id|cifs_calculate_mac_key
c_func
(paren
id|pSesInfo-&gt;mac_signing_key
comma
id|ntlm_session_key
comma
id|pSesInfo-&gt;password
)paren
suffix:semicolon
)brace
multiline_comment|/* for better security the weaker lanman hash not sent&n;&t;&t;&t;   in AuthSessSetup so we no longer calculate it */
id|rc
op_assign
id|CIFSNTLMSSPAuthSessSetup
c_func
(paren
id|xid
comma
id|pSesInfo
comma
id|ntlm_session_key
comma
id|ntlmv2_flag
comma
id|nls_info
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* old style NTLM 0.12 session setup */
id|SMBNTencrypt
c_func
(paren
id|pSesInfo-&gt;password
comma
id|pSesInfo-&gt;server-&gt;cryptKey
comma
id|ntlm_session_key
)paren
suffix:semicolon
id|cifs_calculate_mac_key
c_func
(paren
id|pSesInfo-&gt;mac_signing_key
comma
id|ntlm_session_key
comma
id|pSesInfo-&gt;password
)paren
suffix:semicolon
id|rc
op_assign
id|CIFSSessSetup
c_func
(paren
id|xid
comma
id|pSesInfo
comma
id|ntlm_session_key
comma
id|nls_info
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rc
)paren
(brace
id|cERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Send error in SessSetup = %d&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;CIFS Session Established successfully&quot;
)paren
)paren
suffix:semicolon
id|pSesInfo-&gt;status
op_assign
id|CifsGood
suffix:semicolon
)brace
)brace
r_return
id|rc
suffix:semicolon
)brace
eof
