multiline_comment|/*&n; *   fs/cifs/connect.c&n; *&n; *   Copyright (c) International Business Machines  Corp., 2002&n; *   Author(s): Steve French (sfrench@us.ibm.com)&n; *&n; *   This library is free software; you can redistribute it and/or modify&n; *   it under the terms of the GNU Lesser General Public License as published&n; *   by the Free Software Foundation; either version 2.1 of the License, or&n; *   (at your option) any later version.&n; *&n; *   This library is distributed in the hope that it will be useful,&n; *   but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See&n; *   the GNU Lesser General Public License for more details.&n; *&n; *   You should have received a copy of the GNU Lesser General Public License&n; *   along with this library; if not, write to the Free Software&n; *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA &n; */
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/net.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/list.h&gt;
macro_line|#include &lt;linux/wait.h&gt;
macro_line|#include &lt;linux/version.h&gt;
macro_line|#include &lt;linux/ipv6.h&gt;
macro_line|#include &lt;asm/uaccess.h&gt;
macro_line|#include &lt;asm/processor.h&gt;
macro_line|#include &quot;cifspdu.h&quot;
macro_line|#include &quot;cifsglob.h&quot;
macro_line|#include &quot;cifsproto.h&quot;
macro_line|#include &quot;cifs_unicode.h&quot;
macro_line|#include &quot;cifs_debug.h&quot;
macro_line|#include &quot;cifs_fs_sb.h&quot;
macro_line|#include &quot;ntlmssp.h&quot;
macro_line|#include &quot;nterr.h&quot;
DECL|macro|CIFS_PORT
mdefine_line|#define CIFS_PORT 445
DECL|macro|RFC1001_PORT
mdefine_line|#define RFC1001_PORT 139
r_extern
r_void
id|SMBencrypt
c_func
(paren
r_int
r_char
op_star
id|passwd
comma
r_int
r_char
op_star
id|c8
comma
r_int
r_char
op_star
id|p24
)paren
suffix:semicolon
r_extern
r_void
id|SMBNTencrypt
c_func
(paren
r_int
r_char
op_star
id|passwd
comma
r_int
r_char
op_star
id|c8
comma
r_int
r_char
op_star
id|p24
)paren
suffix:semicolon
r_extern
r_int
id|inet_addr
c_func
(paren
r_char
op_star
)paren
suffix:semicolon
DECL|struct|smb_vol
r_struct
id|smb_vol
(brace
DECL|member|username
r_char
op_star
id|username
suffix:semicolon
DECL|member|password
r_char
op_star
id|password
suffix:semicolon
DECL|member|domainname
r_char
op_star
id|domainname
suffix:semicolon
DECL|member|UNC
r_char
op_star
id|UNC
suffix:semicolon
DECL|member|UNCip
r_char
op_star
id|UNCip
suffix:semicolon
DECL|member|linux_uid
id|uid_t
id|linux_uid
suffix:semicolon
DECL|member|linux_gid
id|uid_t
id|linux_gid
suffix:semicolon
DECL|member|file_mode
id|mode_t
id|file_mode
suffix:semicolon
DECL|member|dir_mode
id|mode_t
id|dir_mode
suffix:semicolon
DECL|member|rw
r_int
id|rw
suffix:semicolon
)brace
suffix:semicolon
r_int
id|ipv4_connect
c_func
(paren
r_struct
id|sockaddr_in
op_star
id|psin_server
comma
r_struct
id|socket
op_star
op_star
id|csocket
)paren
suffix:semicolon
r_int
DECL|function|cifs_reconnect
id|cifs_reconnect
c_func
(paren
r_struct
id|TCP_Server_Info
op_star
id|server
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;&bslash;nReconnecting tcp session &quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* lock tcp session */
multiline_comment|/* mark all smb sessions as reconnecting which use this tcp session */
multiline_comment|/* reconnect tcp session */
multiline_comment|/* wake up waiters on reconnection */
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;&bslash;nState: 0x%x Flags: 0x%lx&quot;
comma
id|server-&gt;ssocket-&gt;state
comma
id|server-&gt;ssocket-&gt;flags
)paren
)paren
suffix:semicolon
id|ipv4_connect
c_func
(paren
op_amp
id|server-&gt;sockAddr
comma
op_amp
id|server-&gt;ssocket
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_int
DECL|function|cifs_demultiplex_thread
id|cifs_demultiplex_thread
c_func
(paren
r_struct
id|TCP_Server_Info
op_star
id|server
)paren
(brace
r_int
id|length
comma
id|total_read
suffix:semicolon
r_int
r_int
id|pdu_length
suffix:semicolon
r_struct
id|smb_hdr
op_star
id|smb_buffer
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|msghdr
id|smb_msg
suffix:semicolon
id|mm_segment_t
id|temp_fs
suffix:semicolon
r_struct
id|iovec
id|iov
suffix:semicolon
r_struct
id|socket
op_star
id|csocket
op_assign
id|server-&gt;ssocket
suffix:semicolon
r_struct
id|list_head
op_star
id|tmp
suffix:semicolon
r_struct
id|cifsSesInfo
op_star
id|ses
suffix:semicolon
r_struct
id|task_struct
op_star
id|task_to_wake
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|mid_q_entry
op_star
id|mid_entry
suffix:semicolon
r_char
op_star
id|temp
suffix:semicolon
id|daemonize
c_func
(paren
)paren
suffix:semicolon
id|server-&gt;tsk
op_assign
id|current
suffix:semicolon
multiline_comment|/* save process info to wake at shutdown */
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;&bslash;nDemultiplex PID: %d&quot;
comma
id|current-&gt;pid
)paren
)paren
suffix:semicolon
id|temp_fs
op_assign
id|get_fs
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* we must turn off socket api parm checking */
id|set_fs
c_func
(paren
id|get_ds
c_func
(paren
)paren
)paren
suffix:semicolon
r_while
c_loop
(paren
id|server-&gt;tcpStatus
op_ne
id|CifsExiting
)paren
(brace
r_if
c_cond
(paren
id|smb_buffer
op_eq
l_int|NULL
)paren
id|smb_buffer
op_assign
id|buf_get
c_func
(paren
)paren
suffix:semicolon
r_else
id|memset
c_func
(paren
id|smb_buffer
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|smb_hdr
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|smb_buffer
op_eq
l_int|NULL
)paren
(brace
id|cERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;&bslash;n Error - can not get mem for SMB response buffer &quot;
)paren
)paren
suffix:semicolon
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|iov.iov_base
op_assign
id|smb_buffer
suffix:semicolon
id|iov.iov_len
op_assign
r_sizeof
(paren
r_struct
id|smb_hdr
)paren
op_minus
l_int|1
suffix:semicolon
multiline_comment|/* 1 byte less above since wct is not always returned in error cases */
id|smb_msg.msg_iov
op_assign
op_amp
id|iov
suffix:semicolon
id|smb_msg.msg_iovlen
op_assign
l_int|1
suffix:semicolon
id|smb_msg.msg_control
op_assign
l_int|NULL
suffix:semicolon
id|smb_msg.msg_controllen
op_assign
l_int|0
suffix:semicolon
id|length
op_assign
id|sock_recvmsg
c_func
(paren
id|csocket
comma
op_amp
id|smb_msg
comma
r_sizeof
(paren
r_struct
id|smb_hdr
)paren
op_minus
l_int|1
multiline_comment|/* RFC1001 header and SMB header */
comma
id|MSG_PEEK
multiline_comment|/* flags see socket.h */
)paren
suffix:semicolon
r_if
c_cond
(paren
id|length
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|length
op_eq
op_minus
id|ECONNRESET
)paren
(brace
id|cERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;&bslash;nConnection reset by peer &quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* BB fix call below */
multiline_comment|/* cifs_reconnect(server);       */
)brace
r_else
(brace
multiline_comment|/* find define for the -512 returned at unmount time */
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;&bslash;nReceived error on sock_recvmsg( peek) with length = %d&bslash;n&quot;
comma
id|length
)paren
)paren
suffix:semicolon
)brace
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|length
op_eq
l_int|0
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;&bslash;nZero length peek received - dead session?? &quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* schedule_timeout(HZ/4); &n;&t;&t;&t;   continue; */
r_break
suffix:semicolon
)brace
id|pdu_length
op_assign
l_int|4
op_plus
id|ntohl
c_func
(paren
id|smb_buffer-&gt;smb_buf_length
)paren
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;&bslash;nPeek length rcvd: %d with smb length: %d&quot;
comma
id|length
comma
id|pdu_length
)paren
)paren
suffix:semicolon
multiline_comment|/* BB */
id|temp
op_assign
(paren
r_char
op_star
)paren
id|smb_buffer
suffix:semicolon
r_if
c_cond
(paren
id|length
OG
l_int|3
)paren
(brace
r_if
c_cond
(paren
id|temp
(braket
l_int|0
)braket
op_eq
(paren
r_char
)paren
l_int|0x85
)paren
(brace
id|iov.iov_base
op_assign
id|smb_buffer
suffix:semicolon
id|iov.iov_len
op_assign
l_int|4
suffix:semicolon
id|length
op_assign
id|sock_recvmsg
c_func
(paren
id|csocket
comma
op_amp
id|smb_msg
comma
l_int|4
comma
l_int|0
)paren
suffix:semicolon
id|cFYI
c_func
(paren
l_int|0
comma
(paren
l_string|&quot;&bslash;nReceived 4 byte keep alive packet &quot;
)paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|temp
(braket
l_int|0
)braket
op_eq
(paren
r_char
)paren
l_int|0x83
)paren
op_logical_and
(paren
id|length
op_eq
l_int|5
)paren
)paren
(brace
multiline_comment|/* we get this from Windows 98 instead of error on SMB negprot response */
id|cERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;&bslash;nNegative RFC 1002 Session response. Error = 0x%x&quot;
comma
id|temp
(braket
l_int|4
)braket
)paren
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|temp
(braket
l_int|0
)braket
op_ne
(paren
r_char
)paren
l_int|0
)paren
(brace
id|cERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;&bslash;nUnknown RFC 1001 frame received not 0x00 nor 0x85&quot;
)paren
)paren
suffix:semicolon
id|cifs_dump_mem
c_func
(paren
l_string|&quot; Received Data is: &quot;
comma
id|temp
comma
id|length
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
(paren
id|length
op_ne
r_sizeof
(paren
r_struct
id|smb_hdr
)paren
op_minus
l_int|1
)paren
op_logical_or
(paren
id|pdu_length
OG
id|CIFS_MAX_MSGSIZE
op_plus
id|MAX_CIFS_HDR_SIZE
)paren
op_logical_or
(paren
id|pdu_length
OL
r_sizeof
(paren
r_struct
id|smb_hdr
)paren
op_minus
l_int|1
)paren
op_logical_or
(paren
id|checkSMBhdr
(paren
id|smb_buffer
comma
id|smb_buffer-&gt;Mid
)paren
)paren
)paren
(brace
id|cERROR
c_func
(paren
l_int|1
comma
(paren
id|KERN_ERR
l_string|&quot;&bslash;nInvalid size or format for SMB found with length %d and pdu_lenght %d&bslash;n&quot;
comma
id|length
comma
id|pdu_length
)paren
)paren
suffix:semicolon
multiline_comment|/* BB fix by finding next smb signature - and reading off data until next smb ? BB */
multiline_comment|/* BB add reconnect here */
r_break
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* length ok */
id|length
op_assign
l_int|0
suffix:semicolon
id|iov.iov_base
op_assign
id|smb_buffer
suffix:semicolon
id|iov.iov_len
op_assign
id|pdu_length
suffix:semicolon
r_for
c_loop
(paren
id|total_read
op_assign
l_int|0
suffix:semicolon
id|total_read
OL
id|pdu_length
suffix:semicolon
id|total_read
op_add_assign
id|length
)paren
(brace
multiline_comment|/* Should improve check for buffer overflow with bad pdu_length */
multiline_comment|/*  iov.iov_base = smb_buffer+total_read;&n;&t;&t;&t;&t;&t;&t;   iov.iov_len =  pdu_length-total_read; */
id|length
op_assign
id|sock_recvmsg
c_func
(paren
id|csocket
comma
op_amp
id|smb_msg
comma
id|pdu_length
op_minus
id|total_read
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* cERROR(1,(&quot;&bslash;nFor iovlen %d Length received: %d with total read %d&quot;,&n;&t;&t;&t;&t;&t;&t;   iov.iov_len, length,total_read));       */
r_if
c_cond
(paren
id|length
op_eq
l_int|0
)paren
(brace
id|cERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;&bslash;nZero length receive when expecting %d &quot;
comma
id|pdu_length
op_minus
id|total_read
)paren
)paren
suffix:semicolon
multiline_comment|/* BB add reconnect here */
r_break
suffix:semicolon
)brace
)brace
)brace
id|dump_smb
c_func
(paren
id|smb_buffer
comma
id|length
)paren
suffix:semicolon
r_if
c_cond
(paren
id|checkSMB
(paren
id|smb_buffer
comma
id|smb_buffer-&gt;Mid
comma
id|total_read
)paren
)paren
(brace
id|cERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;&bslash;n Bad SMB Received &quot;
)paren
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
id|task_to_wake
op_assign
l_int|NULL
suffix:semicolon
id|read_lock
c_func
(paren
op_amp
id|GlobalMid_Lock
)paren
suffix:semicolon
id|list_for_each
c_func
(paren
id|tmp
comma
op_amp
id|server-&gt;pending_mid_q
)paren
(brace
id|mid_entry
op_assign
id|list_entry
c_func
(paren
id|tmp
comma
r_struct
id|mid_q_entry
comma
id|qhead
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mid_entry-&gt;mid
op_eq
id|smb_buffer-&gt;Mid
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot; Mid 0x%x matched - waking up&bslash;n &quot;
comma
id|mid_entry-&gt;mid
)paren
)paren
suffix:semicolon
id|task_to_wake
op_assign
id|mid_entry-&gt;tsk
suffix:semicolon
id|mid_entry-&gt;resp_buf
op_assign
id|smb_buffer
suffix:semicolon
id|mid_entry-&gt;midState
op_assign
id|MID_RESPONSE_RECEIVED
suffix:semicolon
)brace
)brace
id|read_unlock
c_func
(paren
op_amp
id|GlobalMid_Lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|task_to_wake
)paren
(brace
id|smb_buffer
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* will be freed by users thread after he is done */
id|wake_up_process
c_func
(paren
id|task_to_wake
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|is_valid_oplock_break
c_func
(paren
id|smb_buffer
)paren
op_eq
id|FALSE
)paren
(brace
id|cERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;&bslash;n No task to wake, unknown frame rcvd!&bslash;n&quot;
)paren
)paren
suffix:semicolon
)brace
)brace
)brace
r_else
(brace
id|cFYI
c_func
(paren
l_int|0
comma
(paren
l_string|&quot;&bslash;nFrame less than four bytes received  %d bytes long.&quot;
comma
id|length
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|length
OG
l_int|0
)paren
(brace
id|length
op_assign
id|sock_recvmsg
c_func
(paren
id|csocket
comma
op_amp
id|smb_msg
comma
id|length
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* throw away junk frame */
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot; with junk  0x%x in it&bslash;n&quot;
comma
op_star
(paren
id|__u32
op_star
)paren
id|smb_buffer
)paren
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* BB add code to lock SMB sessions while releasing */
r_if
c_cond
(paren
id|server-&gt;ssocket
)paren
(brace
id|sock_release
c_func
(paren
id|csocket
)paren
suffix:semicolon
id|server-&gt;ssocket
op_assign
l_int|NULL
suffix:semicolon
)brace
id|set_fs
c_func
(paren
id|temp_fs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|smb_buffer
)paren
multiline_comment|/* buffer usually freed in free_mid - need to free it on error or exit */
id|buf_release
c_func
(paren
id|smb_buffer
)paren
suffix:semicolon
id|read_lock
c_func
(paren
op_amp
id|GlobalSMBSeslock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|list_empty
c_func
(paren
op_amp
id|server-&gt;pending_mid_q
)paren
)paren
(brace
multiline_comment|/* loop through server session structures attached to this and mark them dead */
id|list_for_each
c_func
(paren
id|tmp
comma
op_amp
id|GlobalSMBSessionList
)paren
(brace
id|ses
op_assign
id|list_entry
c_func
(paren
id|tmp
comma
r_struct
id|cifsSesInfo
comma
id|cifsSessionList
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ses-&gt;server
op_eq
id|server
)paren
(brace
id|ses-&gt;status
op_assign
id|CifsExiting
suffix:semicolon
id|ses-&gt;server
op_assign
l_int|NULL
suffix:semicolon
)brace
)brace
id|kfree
c_func
(paren
id|server
)paren
suffix:semicolon
)brace
r_else
multiline_comment|/* BB need to more gracefully handle the rare negative session &n;&t;&t;&t;   response case because response will be still outstanding */
id|cERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;&bslash;nThere are still active MIDs in queue and we are exiting but we can not delete mid_q_entries or TCP_Server_Info structure due to pending requests MEMORY LEAK!!&bslash;n &quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* BB wake up waitors, and/or wait and/or free stale mids and try again? BB */
multiline_comment|/* BB Need to fix bug in error path above - perhaps wait until smb requests&n;   time out and then free the tcp per server struct BB */
id|read_unlock
c_func
(paren
op_amp
id|GlobalSMBSeslock
)paren
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;&bslash;nAbout to exit from demultiplex thread&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_int
DECL|function|parse_mount_options
id|parse_mount_options
c_func
(paren
r_char
op_star
id|options
comma
r_char
op_star
id|devname
comma
r_struct
id|smb_vol
op_star
id|vol
)paren
(brace
r_char
op_star
id|value
suffix:semicolon
r_char
op_star
id|data
suffix:semicolon
id|vol-&gt;username
op_assign
l_int|NULL
suffix:semicolon
id|vol-&gt;password
op_assign
l_int|NULL
suffix:semicolon
id|vol-&gt;domainname
op_assign
l_int|NULL
suffix:semicolon
id|vol-&gt;UNC
op_assign
l_int|NULL
suffix:semicolon
id|vol-&gt;UNCip
op_assign
l_int|NULL
suffix:semicolon
id|vol-&gt;linux_uid
op_assign
id|current-&gt;uid
suffix:semicolon
multiline_comment|/* current-&gt;euid instead? */
id|vol-&gt;linux_gid
op_assign
id|current-&gt;gid
suffix:semicolon
id|vol-&gt;rw
op_assign
id|TRUE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|options
)paren
r_return
l_int|1
suffix:semicolon
r_while
c_loop
(paren
(paren
id|data
op_assign
id|strsep
c_func
(paren
op_amp
id|options
comma
l_string|&quot;,&quot;
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
op_star
id|data
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
(paren
id|value
op_assign
id|strchr
c_func
(paren
id|data
comma
l_char|&squot;=&squot;
)paren
)paren
op_ne
l_int|NULL
)paren
op_star
id|value
op_increment
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_if
c_cond
(paren
id|strnicmp
c_func
(paren
id|data
comma
l_string|&quot;user&quot;
comma
l_int|4
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|value
op_logical_or
op_logical_neg
op_star
id|value
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;CIFS: invalid or missing username&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
multiline_comment|/* needs_arg; */
)brace
r_if
c_cond
(paren
id|strnlen
c_func
(paren
id|value
comma
l_int|200
)paren
OL
l_int|200
)paren
(brace
id|vol-&gt;username
op_assign
id|value
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;CIFS: username too long&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|strnicmp
c_func
(paren
id|data
comma
l_string|&quot;pass&quot;
comma
l_int|4
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|value
op_logical_or
op_logical_neg
op_star
id|value
)paren
(brace
id|vol-&gt;password
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strnlen
c_func
(paren
id|value
comma
l_int|17
)paren
OL
l_int|17
)paren
(brace
id|vol-&gt;password
op_assign
id|value
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;CIFS: password too long&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
(paren
id|strnicmp
c_func
(paren
id|data
comma
l_string|&quot;unc&quot;
comma
l_int|3
)paren
op_eq
l_int|0
)paren
op_logical_or
(paren
id|strnicmp
c_func
(paren
id|data
comma
l_string|&quot;target&quot;
comma
l_int|6
)paren
op_eq
l_int|0
)paren
op_logical_or
(paren
id|strnicmp
c_func
(paren
id|data
comma
l_string|&quot;path&quot;
comma
l_int|4
)paren
op_eq
l_int|0
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|value
op_logical_or
op_logical_neg
op_star
id|value
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;CIFS: invalid path to network resource&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
multiline_comment|/* needs_arg; */
)brace
r_if
c_cond
(paren
id|strnlen
c_func
(paren
id|value
comma
l_int|300
)paren
OL
l_int|300
)paren
(brace
id|vol-&gt;UNC
op_assign
id|value
suffix:semicolon
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|vol-&gt;UNC
comma
l_string|&quot;//&quot;
comma
l_int|2
)paren
op_eq
l_int|0
)paren
(brace
id|vol-&gt;UNC
(braket
l_int|0
)braket
op_assign
l_char|&squot;&bslash;&bslash;&squot;
suffix:semicolon
id|vol-&gt;UNC
(braket
l_int|1
)braket
op_assign
l_char|&squot;&bslash;&bslash;&squot;
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|vol-&gt;UNC
comma
l_string|&quot;&bslash;&bslash;&bslash;&bslash;&quot;
comma
l_int|2
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;CIFS: UNC Path does not begin with // or &bslash;&bslash;&bslash;&bslash;&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|vol-&gt;UNCip
op_assign
op_amp
id|vol-&gt;UNC
(braket
l_int|2
)braket
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;CIFS: UNC name too long&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
(paren
id|strnicmp
c_func
(paren
id|data
comma
l_string|&quot;domain&quot;
comma
l_int|3
)paren
op_eq
l_int|0
)paren
op_logical_or
(paren
id|strnicmp
c_func
(paren
id|data
comma
l_string|&quot;workgroup&quot;
comma
l_int|5
)paren
op_eq
l_int|0
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|value
op_logical_or
op_logical_neg
op_star
id|value
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;CIFS: invalid domain name&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
multiline_comment|/* needs_arg; */
)brace
r_if
c_cond
(paren
id|strnlen
c_func
(paren
id|value
comma
l_int|65
)paren
OL
l_int|65
)paren
(brace
id|vol-&gt;domainname
op_assign
id|value
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;&bslash;nDomain name set&quot;
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;CIFS: domain name too long&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|strnicmp
c_func
(paren
id|data
comma
l_string|&quot;uid&quot;
comma
l_int|3
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|value
op_logical_and
op_star
id|value
)paren
(brace
id|vol-&gt;linux_uid
op_assign
id|simple_strtoul
c_func
(paren
id|value
comma
op_amp
id|value
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|strnicmp
c_func
(paren
id|data
comma
l_string|&quot;gid&quot;
comma
l_int|3
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|value
op_logical_and
op_star
id|value
)paren
(brace
id|vol-&gt;linux_gid
op_assign
id|simple_strtoul
c_func
(paren
id|value
comma
op_amp
id|value
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|strnicmp
c_func
(paren
id|data
comma
l_string|&quot;file_mode&quot;
comma
l_int|4
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|value
op_logical_and
op_star
id|value
)paren
(brace
id|vol-&gt;file_mode
op_assign
id|simple_strtoul
c_func
(paren
id|value
comma
op_amp
id|value
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|strnicmp
c_func
(paren
id|data
comma
l_string|&quot;dir_mode&quot;
comma
l_int|3
)paren
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|value
op_logical_and
op_star
id|value
)paren
(brace
id|vol-&gt;dir_mode
op_assign
id|simple_strtoul
c_func
(paren
id|value
comma
op_amp
id|value
comma
l_int|0
)paren
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|strnicmp
c_func
(paren
id|data
comma
l_string|&quot;version&quot;
comma
l_int|3
)paren
op_eq
l_int|0
)paren
(brace
multiline_comment|/* ignore */
)brace
r_else
r_if
c_cond
(paren
id|strnicmp
c_func
(paren
id|data
comma
l_string|&quot;rw&quot;
comma
l_int|2
)paren
op_eq
l_int|0
)paren
(brace
id|vol-&gt;rw
op_assign
id|TRUE
suffix:semicolon
)brace
r_else
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;CIFS: Unrecognized mount option %s = %s&quot;
comma
id|data
comma
id|value
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|vol-&gt;UNC
op_eq
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|strnlen
c_func
(paren
id|devname
comma
l_int|300
)paren
OL
l_int|300
)paren
(brace
id|vol-&gt;UNC
op_assign
id|devname
suffix:semicolon
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|vol-&gt;UNC
comma
l_string|&quot;//&quot;
comma
l_int|2
)paren
op_eq
l_int|0
)paren
(brace
id|vol-&gt;UNC
(braket
l_int|0
)braket
op_assign
l_char|&squot;&bslash;&bslash;&squot;
suffix:semicolon
id|vol-&gt;UNC
(braket
l_int|1
)braket
op_assign
l_char|&squot;&bslash;&bslash;&squot;
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|strncmp
c_func
(paren
id|vol-&gt;UNC
comma
l_string|&quot;&bslash;&bslash;&bslash;&bslash;&quot;
comma
l_int|2
)paren
op_ne
l_int|0
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;CIFS: UNC Path does not begin with // or &bslash;&bslash;&bslash;&bslash;&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
id|vol-&gt;UNCip
op_assign
op_amp
id|vol-&gt;UNC
(braket
l_int|2
)braket
suffix:semicolon
)brace
r_else
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;CIFS: UNC name too long&quot;
)paren
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
)brace
r_return
l_int|0
suffix:semicolon
)brace
r_struct
id|cifsSesInfo
op_star
DECL|function|find_tcp_session
id|find_tcp_session
c_func
(paren
id|__u32
id|new_target_ip_addr
comma
r_char
op_star
id|userName
comma
r_struct
id|TCP_Server_Info
op_star
op_star
id|psrvTcp
)paren
(brace
r_struct
id|list_head
op_star
id|tmp
suffix:semicolon
r_struct
id|cifsSesInfo
op_star
id|ses
suffix:semicolon
op_star
id|psrvTcp
op_assign
l_int|NULL
suffix:semicolon
id|read_lock
c_func
(paren
op_amp
id|GlobalSMBSeslock
)paren
suffix:semicolon
id|list_for_each
c_func
(paren
id|tmp
comma
op_amp
id|GlobalSMBSessionList
)paren
(brace
id|ses
op_assign
id|list_entry
c_func
(paren
id|tmp
comma
r_struct
id|cifsSesInfo
comma
id|cifsSessionList
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ses-&gt;server
)paren
(brace
r_if
c_cond
(paren
id|ses-&gt;server-&gt;sockAddr.sin_addr.s_addr
op_eq
id|new_target_ip_addr
)paren
(brace
multiline_comment|/* BB lock server and tcp session and increment use count here?? */
op_star
id|psrvTcp
op_assign
id|ses-&gt;server
suffix:semicolon
multiline_comment|/* found a match on the TCP session */
multiline_comment|/* BB check if reconnection needed */
r_if
c_cond
(paren
id|strncmp
(paren
id|ses-&gt;userName
comma
id|userName
comma
id|MAX_USERNAME_SIZE
)paren
op_eq
l_int|0
)paren
(brace
id|read_unlock
c_func
(paren
op_amp
id|GlobalSMBSeslock
)paren
suffix:semicolon
r_return
id|ses
suffix:semicolon
multiline_comment|/* found exact match on both tcp and SMB sessions */
)brace
)brace
)brace
multiline_comment|/* else tcp and smb sessions need reconnection */
)brace
id|read_unlock
c_func
(paren
op_amp
id|GlobalSMBSeslock
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_struct
id|cifsTconInfo
op_star
DECL|function|find_unc
id|find_unc
c_func
(paren
id|__u32
id|new_target_ip_addr
comma
r_char
op_star
id|uncName
comma
r_char
op_star
id|userName
)paren
(brace
r_struct
id|list_head
op_star
id|tmp
suffix:semicolon
r_struct
id|cifsTconInfo
op_star
id|tcon
suffix:semicolon
id|read_lock
c_func
(paren
op_amp
id|GlobalSMBSeslock
)paren
suffix:semicolon
id|list_for_each
c_func
(paren
id|tmp
comma
op_amp
id|GlobalTreeConnectionList
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;&bslash;nNext tcon - &quot;
)paren
)paren
suffix:semicolon
id|tcon
op_assign
id|list_entry
c_func
(paren
id|tmp
comma
r_struct
id|cifsTconInfo
comma
id|cifsConnectionList
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tcon-&gt;ses
)paren
(brace
r_if
c_cond
(paren
id|tcon-&gt;ses-&gt;server
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot; old ip addr: %x == new ip %x ?&quot;
comma
id|tcon-&gt;ses-&gt;server-&gt;sockAddr.sin_addr
dot
id|s_addr
comma
id|new_target_ip_addr
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tcon-&gt;ses-&gt;server-&gt;sockAddr.sin_addr
dot
id|s_addr
op_eq
id|new_target_ip_addr
)paren
(brace
multiline_comment|/* BB lock tcon and server and tcp session and increment use count here? */
multiline_comment|/* found a match on the TCP session */
multiline_comment|/* BB check if reconnection needed */
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;&bslash;nMatched ip, old UNC: %s == new: %s ?&quot;
comma
id|tcon-&gt;treeName
comma
id|uncName
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|strncmp
(paren
id|tcon-&gt;treeName
comma
id|uncName
comma
id|MAX_TREE_SIZE
)paren
op_eq
l_int|0
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;&bslash;nMatched UNC, old user: %s == new: %s ?&quot;
comma
id|tcon-&gt;treeName
comma
id|uncName
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|strncmp
(paren
id|tcon-&gt;ses-&gt;userName
comma
id|userName
comma
id|MAX_USERNAME_SIZE
)paren
op_eq
l_int|0
)paren
(brace
id|read_unlock
c_func
(paren
op_amp
id|GlobalSMBSeslock
)paren
suffix:semicolon
r_return
id|tcon
suffix:semicolon
multiline_comment|/* also matched user (smb session)*/
)brace
)brace
)brace
)brace
)brace
)brace
id|read_unlock
c_func
(paren
op_amp
id|GlobalSMBSeslock
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
r_int
DECL|function|connect_to_dfs_path
id|connect_to_dfs_path
c_func
(paren
r_int
id|xid
comma
r_struct
id|cifsSesInfo
op_star
id|pSesInfo
comma
r_const
r_char
op_star
id|old_path
comma
r_const
r_struct
id|nls_table
op_star
id|nls_codepage
)paren
(brace
r_char
op_star
id|temp_unc
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|num_referrals
op_assign
l_int|0
suffix:semicolon
r_int
r_char
op_star
id|referrals
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|pSesInfo-&gt;ipc_tid
op_eq
l_int|0
)paren
(brace
id|temp_unc
op_assign
id|kmalloc
c_func
(paren
l_int|2
op_plus
id|strnlen
c_func
(paren
id|pSesInfo-&gt;serverName
comma
id|SERVER_NAME_LEN_WITH_NULL
op_star
l_int|2
)paren
op_plus
l_int|1
op_plus
l_int|4
multiline_comment|/* IPC$ */
op_plus
l_int|1
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|temp_unc
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|temp_unc
(braket
l_int|0
)braket
op_assign
l_char|&squot;&bslash;&bslash;&squot;
suffix:semicolon
id|temp_unc
(braket
l_int|1
)braket
op_assign
l_char|&squot;&bslash;&bslash;&squot;
suffix:semicolon
id|strncpy
c_func
(paren
id|temp_unc
op_plus
l_int|2
comma
id|pSesInfo-&gt;serverName
comma
id|SERVER_NAME_LEN_WITH_NULL
op_star
l_int|2
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|temp_unc
op_plus
l_int|2
op_plus
id|strnlen
c_func
(paren
id|pSesInfo-&gt;serverName
comma
id|SERVER_NAME_LEN_WITH_NULL
op_star
l_int|2
)paren
comma
l_string|&quot;&bslash;&bslash;IPC$&quot;
comma
l_int|6
)paren
suffix:semicolon
id|rc
op_assign
id|CIFSTCon
c_func
(paren
id|xid
comma
id|pSesInfo
comma
id|temp_unc
comma
l_int|NULL
comma
id|nls_codepage
)paren
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;&bslash;nCIFS Tcon rc = %d ipc_tid = %d&bslash;n&quot;
comma
id|rc
comma
id|pSesInfo-&gt;ipc_tid
)paren
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|temp_unc
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rc
op_eq
l_int|0
)paren
id|rc
op_assign
id|CIFSGetDFSRefer
c_func
(paren
id|xid
comma
id|pSesInfo
comma
id|old_path
comma
op_amp
id|referrals
comma
op_amp
id|num_referrals
comma
id|nls_codepage
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
multiline_comment|/* BB remove and add return rc; */
)brace
r_int
DECL|function|ipv4_connect
id|ipv4_connect
c_func
(paren
r_struct
id|sockaddr_in
op_star
id|psin_server
comma
r_struct
id|socket
op_star
op_star
id|csocket
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|rc
op_assign
id|sock_create
c_func
(paren
id|PF_INET
comma
id|SOCK_STREAM
comma
id|IPPROTO_TCP
comma
id|csocket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
(brace
id|cERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Error creating socket. Aborting operation&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|psin_server-&gt;sin_family
op_assign
id|AF_INET
suffix:semicolon
id|psin_server-&gt;sin_port
op_assign
id|htons
c_func
(paren
id|CIFS_PORT
)paren
suffix:semicolon
id|rc
op_assign
(paren
op_star
id|csocket
)paren
op_member_access_from_pointer
id|ops
op_member_access_from_pointer
id|connect
c_func
(paren
op_star
id|csocket
comma
(paren
r_struct
id|sockaddr
op_star
)paren
id|psin_server
comma
r_sizeof
(paren
r_struct
id|sockaddr_in
)paren
comma
l_int|0
multiline_comment|/* Is there a way to fix a polling timeout -&n;         and find out what more of the flags really mean? */
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
(brace
id|psin_server-&gt;sin_port
op_assign
id|htons
c_func
(paren
id|RFC1001_PORT
)paren
suffix:semicolon
id|rc
op_assign
(paren
op_star
id|csocket
)paren
op_member_access_from_pointer
id|ops
op_member_access_from_pointer
id|connect
c_func
(paren
op_star
id|csocket
comma
(paren
r_struct
id|sockaddr
op_star
)paren
id|psin_server
comma
r_sizeof
(paren
r_struct
id|sockaddr_in
)paren
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Error connecting to socket. %d&bslash;n&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
id|sock_release
c_func
(paren
op_star
id|csocket
)paren
suffix:semicolon
op_star
id|csocket
op_assign
l_int|NULL
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
)brace
r_return
id|rc
suffix:semicolon
)brace
r_int
DECL|function|ipv6_connect
id|ipv6_connect
c_func
(paren
r_struct
id|sockaddr_in6
op_star
id|psin_server
comma
r_struct
id|socket
op_star
op_star
id|csocket
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
id|rc
op_assign
id|sock_create
c_func
(paren
id|PF_INET6
comma
id|SOCK_STREAM
comma
id|IPPROTO_TCP
multiline_comment|/* IPPROTO_IPV6 ? */
comma
id|csocket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
(brace
id|cERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Error creating socket. Aborting operation&bslash;n&quot;
)paren
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|psin_server-&gt;sin6_family
op_assign
id|AF_INET6
suffix:semicolon
id|psin_server-&gt;sin6_port
op_assign
id|htons
c_func
(paren
id|CIFS_PORT
)paren
suffix:semicolon
id|rc
op_assign
(paren
op_star
id|csocket
)paren
op_member_access_from_pointer
id|ops
op_member_access_from_pointer
id|connect
c_func
(paren
op_star
id|csocket
comma
(paren
r_struct
id|sockaddr
op_star
)paren
id|psin_server
comma
r_sizeof
(paren
r_struct
id|sockaddr_in6
)paren
comma
l_int|0
multiline_comment|/* BB fix the timeout to be shorter - and check flags */
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
(brace
id|psin_server-&gt;sin6_port
op_assign
id|htons
c_func
(paren
id|RFC1001_PORT
)paren
suffix:semicolon
id|rc
op_assign
(paren
op_star
id|csocket
)paren
op_member_access_from_pointer
id|ops
op_member_access_from_pointer
id|connect
c_func
(paren
op_star
id|csocket
comma
(paren
r_struct
id|sockaddr
op_star
)paren
id|psin_server
comma
r_sizeof
(paren
r_struct
id|sockaddr_in6
)paren
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Error connecting to socket (via ipv6). %d&bslash;n&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
id|sock_release
c_func
(paren
op_star
id|csocket
)paren
suffix:semicolon
op_star
id|csocket
op_assign
l_int|NULL
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
)brace
r_return
id|rc
suffix:semicolon
)brace
r_int
DECL|function|cifs_mount
id|cifs_mount
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|cifs_sb_info
op_star
id|cifs_sb
comma
r_char
op_star
id|mount_data
comma
r_char
op_star
id|devname
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|xid
suffix:semicolon
r_int
id|ntlmv2_flag
op_assign
id|FALSE
suffix:semicolon
r_struct
id|socket
op_star
id|csocket
suffix:semicolon
r_struct
id|sockaddr_in
id|sin_server
suffix:semicolon
multiline_comment|/*&t;struct sockaddr_in6 sin_server6; */
r_struct
id|smb_vol
id|volume_info
suffix:semicolon
r_struct
id|cifsSesInfo
op_star
id|pSesInfo
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|cifsSesInfo
op_star
id|existingCifsSes
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|cifsTconInfo
op_star
id|tcon
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|TCP_Server_Info
op_star
id|srvTcp
op_assign
l_int|NULL
suffix:semicolon
r_char
id|cryptKey
(braket
id|CIFS_CRYPTO_KEY_SIZE
)braket
suffix:semicolon
r_char
id|session_key
(braket
id|CIFS_SESSION_KEY_SIZE
)braket
suffix:semicolon
r_char
id|ntlm_session_key
(braket
id|CIFS_SESSION_KEY_SIZE
)braket
suffix:semicolon
r_char
id|password_with_pad
(braket
id|CIFS_ENCPWD_SIZE
)braket
suffix:semicolon
id|xid
op_assign
id|GetXid
c_func
(paren
)paren
suffix:semicolon
id|cFYI
c_func
(paren
l_int|0
comma
(paren
l_string|&quot;&bslash;nEntering cifs_mount. Xid: %d with: %s&bslash;n&quot;
comma
id|xid
comma
id|mount_data
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|parse_mount_options
c_func
(paren
id|mount_data
comma
id|devname
comma
op_amp
id|volume_info
)paren
)paren
(brace
id|FreeXid
c_func
(paren
id|xid
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
id|volume_info.username
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;&bslash;nUsername: %s &quot;
comma
id|volume_info.username
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|cERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;&bslash;nNo username specified &quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* Could add ways to allow getting user name from alternate locations */
)brace
r_if
c_cond
(paren
id|volume_info.UNC
)paren
(brace
id|sin_server.sin_addr.s_addr
op_assign
id|inet_addr
c_func
(paren
id|volume_info.UNCip
)paren
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;&bslash;nUNC: %s  &quot;
comma
id|volume_info.UNC
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* BB we could connect to the DFS root? but which server do we ask? */
id|cERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;&bslash;nCIFS mount error: No UNC path (e.g. -o unc=//192.168.1.100/public) specified  &quot;
)paren
)paren
suffix:semicolon
id|FreeXid
c_func
(paren
id|xid
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* BB add support to use the multiuser_mount flag BB */
id|existingCifsSes
op_assign
id|find_tcp_session
c_func
(paren
id|sin_server.sin_addr.s_addr
comma
id|volume_info.username
comma
op_amp
id|srvTcp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|srvTcp
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;&bslash;nExisting tcp session with server found &quot;
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* create socket */
id|rc
op_assign
id|ipv4_connect
c_func
(paren
op_amp
id|sin_server
comma
op_amp
id|csocket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
OL
l_int|0
)paren
(brace
id|cERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Error connecting to IPv4 socket. Aborting operation&bslash;n&quot;
)paren
)paren
suffix:semicolon
id|FreeXid
c_func
(paren
id|xid
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
id|srvTcp
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|TCP_Server_Info
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|srvTcp
op_eq
l_int|NULL
)paren
(brace
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
id|sock_release
c_func
(paren
id|csocket
)paren
suffix:semicolon
id|FreeXid
c_func
(paren
id|xid
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_else
(brace
id|memset
c_func
(paren
id|srvTcp
comma
l_int|0
comma
r_sizeof
(paren
r_struct
id|TCP_Server_Info
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
op_amp
id|srvTcp-&gt;sockAddr
comma
op_amp
id|sin_server
comma
r_sizeof
(paren
r_struct
id|sockaddr_in
)paren
)paren
suffix:semicolon
multiline_comment|/* BB Add code for ipv6 case too */
id|srvTcp-&gt;ssocket
op_assign
id|csocket
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|srvTcp-&gt;response_q
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|srvTcp-&gt;pending_mid_q
)paren
suffix:semicolon
id|kernel_thread
c_func
(paren
(paren
r_void
op_star
)paren
(paren
r_void
op_star
)paren
id|cifs_demultiplex_thread
comma
id|srvTcp
comma
id|CLONE_FS
op_or
id|CLONE_FILES
op_or
id|CLONE_VM
)paren
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|existingCifsSes
)paren
(brace
id|pSesInfo
op_assign
id|existingCifsSes
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;&bslash;nExisting smb sess found &quot;
)paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
op_logical_neg
id|rc
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;&bslash;nExisting smb sess not found &quot;
)paren
)paren
suffix:semicolon
id|pSesInfo
op_assign
id|sesInfoAlloc
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pSesInfo
op_eq
l_int|NULL
)paren
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_else
(brace
id|pSesInfo-&gt;server
op_assign
id|srvTcp
suffix:semicolon
id|pSesInfo-&gt;status
op_assign
id|CifsGood
suffix:semicolon
id|sprintf
c_func
(paren
id|pSesInfo-&gt;serverName
comma
l_string|&quot;%u.%u.%u.%u&quot;
comma
id|NIPQUAD
c_func
(paren
id|sin_server.sin_addr.s_addr
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* send negotiate protocol smb */
r_if
c_cond
(paren
op_logical_neg
id|rc
)paren
id|rc
op_assign
id|CIFSSMBNegotiate
c_func
(paren
id|xid
comma
id|pSesInfo
comma
id|cryptKey
)paren
suffix:semicolon
id|cFYI
c_func
(paren
l_int|0
comma
(paren
l_string|&quot;&bslash;nNegotiate rc = %d &quot;
comma
id|rc
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rc
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;&bslash;nSecurity Mode: %x&quot;
comma
id|pSesInfo-&gt;secMode
)paren
)paren
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot; Server Capabilities: %x&quot;
comma
id|pSesInfo-&gt;capabilities
)paren
)paren
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot; Time Zone: 0x%x %d&bslash;n&quot;
comma
id|pSesInfo-&gt;timeZone
comma
id|pSesInfo-&gt;timeZone
)paren
)paren
suffix:semicolon
id|memset
c_func
(paren
id|password_with_pad
comma
l_int|0
comma
id|CIFS_ENCPWD_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|volume_info.password
)paren
id|strcpy
c_func
(paren
id|password_with_pad
comma
id|volume_info.password
)paren
suffix:semicolon
r_if
c_cond
(paren
id|extended_security
op_logical_and
(paren
id|pSesInfo-&gt;capabilities
op_amp
id|CAP_EXTENDED_SECURITY
)paren
op_logical_and
(paren
id|pSesInfo-&gt;secType
op_eq
id|NTLMSSP
)paren
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;&bslash;nNew style sesssetup &quot;
)paren
)paren
suffix:semicolon
id|rc
op_assign
id|CIFSSpnegoSessSetup
c_func
(paren
id|xid
comma
id|pSesInfo
comma
id|volume_info
dot
id|username
comma
id|volume_info
dot
id|domainname
comma
l_int|NULL
multiline_comment|/* security blob */
comma
l_int|0
multiline_comment|/* blob length */
comma
id|cifs_sb-&gt;local_nls
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|extended_security
op_logical_and
(paren
id|pSesInfo
op_member_access_from_pointer
id|capabilities
op_amp
id|CAP_EXTENDED_SECURITY
)paren
op_logical_and
(paren
id|pSesInfo-&gt;secType
op_eq
id|RawNTLMSSP
)paren
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;&bslash;nNTLMSSP sesssetup &quot;
)paren
)paren
suffix:semicolon
id|rc
op_assign
id|CIFSNTLMSSPNegotiateSessSetup
c_func
(paren
id|xid
comma
id|pSesInfo
comma
id|cryptKey
comma
id|volume_info.domainname
comma
op_amp
id|ntlmv2_flag
comma
id|cifs_sb-&gt;local_nls
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|rc
)paren
(brace
r_if
c_cond
(paren
id|ntlmv2_flag
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;&bslash;nAble to use the more secure NTLM version 2 password hash&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* SMBNTv2encrypt( ...);  */
multiline_comment|/* BB fix this up - &n;&t;&t;&t;&t;   and note that Samba client equivalent looks wrong */
)brace
r_else
id|SMBNTencrypt
c_func
(paren
id|password_with_pad
comma
id|cryptKey
comma
id|ntlm_session_key
)paren
suffix:semicolon
multiline_comment|/* for better security the weaker lanman hash not sent &n;                       in AuthSessSetup so why bother calculating it */
multiline_comment|/* toUpper(cifs_sb-&gt;local_nls,&n;&t;&t;&t;&t;&t;&t;password_with_pad);&n;&t;&t;&t;&t;&t;SMBencrypt(password_with_pad,&n;&t;&t;&t;&t;&t;&t;   cryptKey, session_key); */
id|rc
op_assign
id|CIFSNTLMSSPAuthSessSetup
c_func
(paren
id|xid
comma
id|pSesInfo
comma
id|volume_info
dot
id|username
comma
id|volume_info.domainname
comma
id|ntlm_session_key
comma
id|session_key
comma
id|ntlmv2_flag
comma
id|cifs_sb-&gt;local_nls
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* old style NTLM 0.12 session setup */
id|SMBNTencrypt
c_func
(paren
id|password_with_pad
comma
id|cryptKey
comma
id|ntlm_session_key
)paren
suffix:semicolon
multiline_comment|/* Removed following few lines to not send old style password &n;                  hash ever - for better security */
multiline_comment|/* toUpper(cifs_sb-&gt;local_nls, password_with_pad);&n;&t;&t;&t;&t;   SMBencrypt(password_with_pad, cryptKey,session_key); */
id|rc
op_assign
id|CIFSSessSetup
c_func
(paren
id|xid
comma
id|pSesInfo
comma
id|volume_info.username
comma
id|volume_info
dot
id|domainname
comma
id|session_key
comma
id|ntlm_session_key
comma
id|cifs_sb-&gt;local_nls
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|rc
)paren
(brace
id|cERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;&bslash;nSend error in SessSetup = %d&bslash;n&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;CIFS Session Established successfully &quot;
)paren
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|pSesInfo-&gt;userName
comma
id|volume_info.username
comma
id|MAX_USERNAME_SIZE
)paren
suffix:semicolon
id|atomic_inc
c_func
(paren
op_amp
id|srvTcp-&gt;socketUseCount
)paren
suffix:semicolon
)brace
)brace
)brace
multiline_comment|/* search for existing tcon to this server share */
r_if
c_cond
(paren
op_logical_neg
id|rc
)paren
(brace
id|tcon
op_assign
id|find_unc
c_func
(paren
id|sin_server.sin_addr.s_addr
comma
id|volume_info.UNC
comma
id|volume_info.username
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tcon
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;&bslash;nFound match on UNC path &quot;
)paren
)paren
suffix:semicolon
)brace
r_else
(brace
id|tcon
op_assign
id|tconInfoAlloc
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tcon
op_eq
l_int|NULL
)paren
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_else
(brace
multiline_comment|/* check for null share name ie connect to dfs root */
multiline_comment|/* BB check if this works for exactly length three strings */
r_if
c_cond
(paren
(paren
id|strchr
c_func
(paren
id|volume_info.UNC
op_plus
l_int|3
comma
l_char|&squot;&bslash;&bslash;&squot;
)paren
op_eq
l_int|NULL
)paren
op_logical_and
(paren
id|strchr
c_func
(paren
id|volume_info.UNC
op_plus
l_int|3
comma
l_char|&squot;/&squot;
)paren
op_eq
l_int|NULL
)paren
)paren
(brace
id|rc
op_assign
id|connect_to_dfs_path
c_func
(paren
id|xid
comma
id|pSesInfo
comma
l_string|&quot;&quot;
comma
id|cifs_sb
op_member_access_from_pointer
id|local_nls
)paren
suffix:semicolon
id|FreeXid
c_func
(paren
id|xid
)paren
suffix:semicolon
r_return
op_minus
id|ENODEV
suffix:semicolon
)brace
r_else
(brace
id|rc
op_assign
id|CIFSTCon
c_func
(paren
id|xid
comma
id|pSesInfo
comma
id|volume_info.UNC
comma
id|tcon
comma
id|cifs_sb-&gt;local_nls
)paren
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;&bslash;nCIFS Tcon rc = %d&bslash;n&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|rc
)paren
id|atomic_inc
c_func
(paren
op_amp
id|pSesInfo-&gt;inUse
)paren
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|pSesInfo-&gt;capabilities
op_amp
id|CAP_LARGE_FILES
)paren
(brace
id|cFYI
c_func
(paren
l_int|0
comma
(paren
l_string|&quot;&bslash;nLarge files supported &quot;
)paren
)paren
suffix:semicolon
id|sb-&gt;s_maxbytes
op_assign
(paren
id|u64
)paren
l_int|1
op_lshift
l_int|63
suffix:semicolon
)brace
r_else
id|sb-&gt;s_maxbytes
op_assign
(paren
id|u64
)paren
l_int|1
op_lshift
l_int|31
suffix:semicolon
multiline_comment|/* 2 GB */
multiline_comment|/* on error free sesinfo and tcon struct if needed */
r_if
c_cond
(paren
id|rc
)paren
(brace
multiline_comment|/* If find_unc succeeded then rc == 0 so we can not end */
r_if
c_cond
(paren
id|tcon
)paren
multiline_comment|/* up here accidently freeing someone elses tcon struct */
id|tconInfoFree
c_func
(paren
id|tcon
)paren
suffix:semicolon
r_if
c_cond
(paren
id|existingCifsSes
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|pSesInfo
)paren
(brace
r_if
c_cond
(paren
id|pSesInfo-&gt;server
)paren
(brace
id|cFYI
c_func
(paren
l_int|0
comma
(paren
l_string|&quot;&bslash;nAbout to check if we need to do SMBLogoff &quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pSesInfo-&gt;Suid
)paren
id|CIFSSMBLogoff
c_func
(paren
id|xid
comma
id|pSesInfo
)paren
suffix:semicolon
id|wake_up_process
c_func
(paren
id|pSesInfo-&gt;server-&gt;tsk
)paren
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|HZ
op_div
l_int|4
)paren
suffix:semicolon
multiline_comment|/* give captive thread time to exit */
)brace
r_else
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;&bslash;nNo session or bad tcon&quot;
)paren
)paren
suffix:semicolon
id|sesInfoFree
c_func
(paren
id|pSesInfo
)paren
suffix:semicolon
multiline_comment|/* pSesInfo = NULL; */
)brace
)brace
)brace
r_else
(brace
id|atomic_inc
c_func
(paren
op_amp
id|tcon-&gt;useCount
)paren
suffix:semicolon
id|cifs_sb-&gt;tcon
op_assign
id|tcon
suffix:semicolon
id|tcon-&gt;ses
op_assign
id|pSesInfo
suffix:semicolon
multiline_comment|/* do not care if following two calls succeed - informational only */
id|CIFSSMBQFSDeviceInfo
c_func
(paren
id|xid
comma
id|tcon
comma
id|cifs_sb-&gt;local_nls
)paren
suffix:semicolon
id|CIFSSMBQFSAttributeInfo
c_func
(paren
id|xid
comma
id|tcon
comma
id|cifs_sb-&gt;local_nls
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tcon-&gt;ses-&gt;capabilities
op_amp
id|CAP_UNIX
)paren
id|CIFSSMBQFSUnixInfo
c_func
(paren
id|xid
comma
id|tcon
comma
id|cifs_sb-&gt;local_nls
)paren
suffix:semicolon
)brace
id|FreeXid
c_func
(paren
id|xid
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_int
DECL|function|CIFSSessSetup
id|CIFSSessSetup
c_func
(paren
r_int
r_int
id|xid
comma
r_struct
id|cifsSesInfo
op_star
id|ses
comma
r_char
op_star
id|user
comma
r_char
op_star
id|domain
comma
r_char
id|session_key
(braket
id|CIFS_SESSION_KEY_SIZE
)braket
comma
r_char
id|session_key2
(braket
id|CIFS_SESSION_KEY_SIZE
)braket
comma
r_const
r_struct
id|nls_table
op_star
id|nls_codepage
)paren
(brace
r_struct
id|smb_hdr
op_star
id|smb_buffer
suffix:semicolon
r_struct
id|smb_hdr
op_star
id|smb_buffer_response
suffix:semicolon
id|SESSION_SETUP_ANDX
op_star
id|pSMB
suffix:semicolon
id|SESSION_SETUP_ANDX
op_star
id|pSMBr
suffix:semicolon
r_char
op_star
id|bcc_ptr
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|remaining_words
op_assign
l_int|0
suffix:semicolon
r_int
id|bytes_returned
op_assign
l_int|0
suffix:semicolon
r_int
id|len
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;&bslash;nIn sesssetup &quot;
)paren
)paren
suffix:semicolon
id|smb_buffer
op_assign
id|buf_get
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|smb_buffer
op_eq
l_int|0
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|smb_buffer_response
op_assign
id|smb_buffer
suffix:semicolon
id|pSMBr
op_assign
id|pSMB
op_assign
(paren
id|SESSION_SETUP_ANDX
op_star
)paren
id|smb_buffer
suffix:semicolon
multiline_comment|/* send SMBsessionSetup here */
id|header_assemble
c_func
(paren
id|smb_buffer
comma
id|SMB_COM_SESSION_SETUP_ANDX
comma
l_int|0
multiline_comment|/* no tCon exists yet */
comma
l_int|13
multiline_comment|/* wct */
)paren
suffix:semicolon
id|pSMB-&gt;req_no_secext.AndXCommand
op_assign
l_int|0xFF
suffix:semicolon
id|pSMB-&gt;req_no_secext.MaxBufferSize
op_assign
id|cpu_to_le16
c_func
(paren
id|ses-&gt;maxBuf
)paren
suffix:semicolon
id|pSMB-&gt;req_no_secext.MaxMpxCount
op_assign
id|cpu_to_le16
c_func
(paren
id|ses-&gt;maxReq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ses-&gt;secMode
op_amp
(paren
id|SECMODE_SIGN_REQUIRED
op_or
id|SECMODE_SIGN_ENABLED
)paren
)paren
(brace
id|smb_buffer-&gt;Flags2
op_or_assign
id|SMBFLG2_SECURITY_SIGNATURE
suffix:semicolon
)brace
id|pSMB-&gt;req_no_secext.Capabilities
op_assign
id|CAP_LARGE_FILES
op_or
id|CAP_NT_SMBS
op_or
id|CAP_LEVEL_II_OPLOCKS
suffix:semicolon
r_if
c_cond
(paren
id|ses-&gt;capabilities
op_amp
id|CAP_UNICODE
)paren
(brace
id|smb_buffer-&gt;Flags2
op_or_assign
id|SMBFLG2_UNICODE
suffix:semicolon
id|pSMB-&gt;req_no_secext.Capabilities
op_or_assign
id|CAP_UNICODE
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ses-&gt;capabilities
op_amp
id|CAP_STATUS32
)paren
(brace
id|smb_buffer-&gt;Flags2
op_or_assign
id|SMBFLG2_ERR_STATUS
suffix:semicolon
id|pSMB-&gt;req_no_secext.Capabilities
op_or_assign
id|CAP_STATUS32
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ses-&gt;capabilities
op_amp
id|CAP_DFS
)paren
(brace
id|smb_buffer-&gt;Flags2
op_or_assign
id|SMBFLG2_DFS
suffix:semicolon
id|pSMB-&gt;req_no_secext.Capabilities
op_or_assign
id|CAP_DFS
suffix:semicolon
)brace
id|pSMB-&gt;req_no_secext.Capabilities
op_assign
id|cpu_to_le32
c_func
(paren
id|pSMB-&gt;req_no_secext.Capabilities
)paren
suffix:semicolon
multiline_comment|/* pSMB-&gt;req_no_secext.CaseInsensitivePasswordLength =&n;&t;   CIFS_SESSION_KEY_SIZE; */
id|pSMB-&gt;req_no_secext.CaseInsensitivePasswordLength
op_assign
l_int|0
suffix:semicolon
id|pSMB-&gt;req_no_secext.CaseSensitivePasswordLength
op_assign
id|cpu_to_le16
c_func
(paren
id|CIFS_SESSION_KEY_SIZE
)paren
suffix:semicolon
id|bcc_ptr
op_assign
id|pByteArea
c_func
(paren
id|smb_buffer
)paren
suffix:semicolon
multiline_comment|/* memcpy(bcc_ptr, (char *) session_key, CIFS_SESSION_KEY_SIZE);&n;&t;   bcc_ptr += CIFS_SESSION_KEY_SIZE; */
id|memcpy
c_func
(paren
id|bcc_ptr
comma
(paren
r_char
op_star
)paren
id|session_key2
comma
id|CIFS_SESSION_KEY_SIZE
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
id|CIFS_SESSION_KEY_SIZE
suffix:semicolon
r_if
c_cond
(paren
id|ses-&gt;capabilities
op_amp
id|CAP_UNICODE
)paren
(brace
r_if
c_cond
(paren
(paren
r_int
)paren
id|bcc_ptr
op_mod
l_int|2
)paren
(brace
multiline_comment|/* must be word aligned for Unicode */
op_star
id|bcc_ptr
op_assign
l_int|0
suffix:semicolon
id|bcc_ptr
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|user
op_eq
l_int|NULL
)paren
(brace
id|bytes_returned
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* skill null user */
r_else
id|bytes_returned
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
id|user
comma
l_int|100
comma
id|nls_codepage
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
op_star
id|bytes_returned
suffix:semicolon
multiline_comment|/* convert num 16 bit words to bytes */
id|bcc_ptr
op_add_assign
l_int|2
suffix:semicolon
multiline_comment|/* trailing null */
r_if
c_cond
(paren
id|domain
op_eq
l_int|NULL
)paren
id|bytes_returned
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
l_string|&quot;CIFS_LINUX_DOM&quot;
comma
l_int|32
comma
id|nls_codepage
)paren
suffix:semicolon
r_else
id|bytes_returned
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
id|domain
comma
l_int|64
comma
id|nls_codepage
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
op_star
id|bytes_returned
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
suffix:semicolon
id|bytes_returned
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
l_string|&quot;Linux version &quot;
comma
l_int|32
comma
id|nls_codepage
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
op_star
id|bytes_returned
suffix:semicolon
id|bytes_returned
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
id|UTS_RELEASE
comma
l_int|32
comma
id|nls_codepage
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
op_star
id|bytes_returned
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
suffix:semicolon
id|bytes_returned
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
id|CIFS_NETWORK_OPSYS
comma
l_int|64
comma
id|nls_codepage
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
op_star
id|bytes_returned
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|user
op_ne
l_int|NULL
)paren
(brace
id|strncpy
c_func
(paren
id|bcc_ptr
comma
id|user
comma
l_int|200
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
id|strnlen
c_func
(paren
id|user
comma
l_int|200
)paren
suffix:semicolon
)brace
op_star
id|bcc_ptr
op_assign
l_int|0
suffix:semicolon
id|bcc_ptr
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|domain
op_eq
l_int|NULL
)paren
(brace
id|strcpy
c_func
(paren
id|bcc_ptr
comma
l_string|&quot;CIFS_LINUX_DOM&quot;
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
id|strlen
c_func
(paren
l_string|&quot;CIFS_LINUX_DOM&quot;
)paren
op_plus
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|strncpy
c_func
(paren
id|bcc_ptr
comma
id|domain
comma
l_int|64
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
id|strnlen
c_func
(paren
id|domain
comma
l_int|64
)paren
suffix:semicolon
op_star
id|bcc_ptr
op_assign
l_int|0
suffix:semicolon
id|bcc_ptr
op_increment
suffix:semicolon
)brace
id|strcpy
c_func
(paren
id|bcc_ptr
comma
l_string|&quot;Linux version &quot;
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
id|strlen
c_func
(paren
l_string|&quot;Linux version &quot;
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|bcc_ptr
comma
id|UTS_RELEASE
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
id|strlen
c_func
(paren
id|UTS_RELEASE
)paren
op_plus
l_int|1
suffix:semicolon
id|strcpy
c_func
(paren
id|bcc_ptr
comma
id|CIFS_NETWORK_OPSYS
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
id|strlen
c_func
(paren
id|CIFS_NETWORK_OPSYS
)paren
op_plus
l_int|1
suffix:semicolon
)brace
id|BCC
c_func
(paren
id|smb_buffer
)paren
op_assign
(paren
r_int
)paren
id|bcc_ptr
op_minus
(paren
r_int
)paren
id|pByteArea
c_func
(paren
id|smb_buffer
)paren
suffix:semicolon
id|smb_buffer-&gt;smb_buf_length
op_add_assign
id|BCC
c_func
(paren
id|smb_buffer
)paren
suffix:semicolon
id|BCC
c_func
(paren
id|smb_buffer
)paren
op_assign
id|cpu_to_le16
c_func
(paren
id|BCC
c_func
(paren
id|smb_buffer
)paren
)paren
suffix:semicolon
id|rc
op_assign
id|SendReceive
c_func
(paren
id|xid
comma
id|ses
comma
id|smb_buffer
comma
id|smb_buffer_response
comma
op_amp
id|bytes_returned
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
multiline_comment|/* rc = map_smb_to_linux_error(smb_buffer_response); now done in SendReceive */
)brace
r_else
r_if
c_cond
(paren
(paren
id|smb_buffer_response-&gt;WordCount
op_eq
l_int|3
)paren
op_logical_or
(paren
id|smb_buffer_response-&gt;WordCount
op_eq
l_int|4
)paren
)paren
(brace
id|pSMBr-&gt;resp.Action
op_assign
id|le16_to_cpu
c_func
(paren
id|pSMBr-&gt;resp.Action
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pSMBr-&gt;resp.Action
op_amp
id|GUEST_LOGIN
)paren
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot; Guest login&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* do we want to mark SesInfo struct ? */
r_if
c_cond
(paren
id|ses
)paren
(brace
id|ses-&gt;Suid
op_assign
id|smb_buffer_response-&gt;Uid
suffix:semicolon
multiline_comment|/* UID left in wire format (le) */
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;UID = %d &quot;
comma
id|ses-&gt;Suid
)paren
)paren
suffix:semicolon
multiline_comment|/* response can have either 3 or 4 word count - Samba sends 3 */
id|bcc_ptr
op_assign
id|pByteArea
c_func
(paren
id|smb_buffer_response
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pSMBr-&gt;resp.hdr.WordCount
op_eq
l_int|3
)paren
op_logical_or
(paren
(paren
id|pSMBr-&gt;resp.hdr.WordCount
op_eq
l_int|4
)paren
op_logical_and
(paren
id|pSMBr-&gt;resp.SecurityBlobLength
OL
id|pSMBr-&gt;resp.ByteCount
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|pSMBr-&gt;resp.hdr.WordCount
op_eq
l_int|4
)paren
id|bcc_ptr
op_add_assign
id|pSMBr-&gt;resp.SecurityBlobLength
suffix:semicolon
r_if
c_cond
(paren
id|smb_buffer-&gt;Flags2
op_and_assign
id|SMBFLG2_UNICODE
)paren
(brace
r_if
c_cond
(paren
(paren
r_int
)paren
(paren
id|bcc_ptr
)paren
op_mod
l_int|2
)paren
(brace
id|remaining_words
op_assign
(paren
id|BCC
c_func
(paren
id|smb_buffer_response
)paren
op_minus
l_int|1
)paren
op_div
l_int|2
suffix:semicolon
id|bcc_ptr
op_increment
suffix:semicolon
multiline_comment|/* Unicode strings must be word aligned */
)brace
r_else
(brace
id|remaining_words
op_assign
id|BCC
(paren
id|smb_buffer_response
)paren
op_div
l_int|2
suffix:semicolon
)brace
id|len
op_assign
id|UniStrnlen
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
id|remaining_words
op_minus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* We look for obvious messed up bcc or strings in response so we do not go off&n;   the end since (at least) WIN2K and Windows XP have a major bug in not null&n;   terminating last Unicode string in response  */
id|ses-&gt;serverOS
op_assign
id|kcalloc
c_func
(paren
l_int|2
op_star
(paren
id|len
op_plus
l_int|1
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|cifs_strfromUCS_le
c_func
(paren
id|ses-&gt;serverOS
comma
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
id|len
comma
id|nls_codepage
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
op_star
(paren
id|len
op_plus
l_int|1
)paren
suffix:semicolon
id|remaining_words
op_sub_assign
id|len
op_plus
l_int|1
suffix:semicolon
id|ses-&gt;serverOS
(braket
l_int|2
op_star
id|len
)braket
op_assign
l_int|0
suffix:semicolon
id|ses-&gt;serverOS
(braket
l_int|1
op_plus
(paren
l_int|2
op_star
id|len
)paren
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|remaining_words
OG
l_int|0
)paren
(brace
id|len
op_assign
id|UniStrnlen
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
id|remaining_words
op_minus
l_int|1
)paren
suffix:semicolon
id|ses-&gt;serverNOS
op_assign
id|kcalloc
c_func
(paren
l_int|2
op_star
(paren
id|len
op_plus
l_int|1
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|cifs_strfromUCS_le
c_func
(paren
id|ses-&gt;serverNOS
comma
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
id|len
comma
id|nls_codepage
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
op_star
(paren
id|len
op_plus
l_int|1
)paren
suffix:semicolon
id|ses-&gt;serverNOS
(braket
l_int|2
op_star
id|len
)braket
op_assign
l_int|0
suffix:semicolon
id|ses-&gt;serverNOS
(braket
l_int|1
op_plus
(paren
l_int|2
op_star
id|len
)paren
)braket
op_assign
l_int|0
suffix:semicolon
id|remaining_words
op_sub_assign
id|len
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|remaining_words
OG
l_int|0
)paren
(brace
id|len
op_assign
id|UniStrnlen
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
id|remaining_words
)paren
suffix:semicolon
multiline_comment|/* last string is not always null terminated (for e.g. for Windows XP &amp; 2000) */
id|ses-&gt;serverDomain
op_assign
id|kcalloc
c_func
(paren
l_int|2
op_star
(paren
id|len
op_plus
l_int|1
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|cifs_strfromUCS_le
c_func
(paren
id|ses-&gt;serverDomain
comma
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
id|len
comma
id|nls_codepage
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
op_star
(paren
id|len
op_plus
l_int|1
)paren
suffix:semicolon
id|ses-&gt;serverDomain
(braket
l_int|2
op_star
id|len
)braket
op_assign
l_int|0
suffix:semicolon
id|ses-&gt;serverDomain
(braket
l_int|1
op_plus
(paren
l_int|2
op_star
id|len
)paren
)braket
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* else no more room so create dummy domain string */
r_else
id|ses-&gt;serverDomain
op_assign
id|kcalloc
c_func
(paren
l_int|2
comma
id|GFP_KERNEL
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* no room so create dummy domain and NOS string */
id|ses-&gt;serverDomain
op_assign
id|kcalloc
c_func
(paren
l_int|2
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|ses-&gt;serverNOS
op_assign
id|kcalloc
c_func
(paren
l_int|2
comma
id|GFP_KERNEL
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* ASCII */
id|len
op_assign
id|strnlen
c_func
(paren
id|bcc_ptr
comma
l_int|1024
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
r_int
)paren
id|bcc_ptr
op_plus
id|len
)paren
op_minus
(paren
r_int
)paren
id|pByteArea
c_func
(paren
id|smb_buffer_response
)paren
op_le
id|BCC
c_func
(paren
id|smb_buffer_response
)paren
)paren
(brace
id|ses-&gt;serverOS
op_assign
id|kcalloc
c_func
(paren
id|len
op_plus
l_int|1
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|ses-&gt;serverOS
comma
id|bcc_ptr
comma
id|len
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
id|len
suffix:semicolon
id|bcc_ptr
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* null terminate the string */
id|bcc_ptr
op_increment
suffix:semicolon
id|len
op_assign
id|strnlen
c_func
(paren
id|bcc_ptr
comma
l_int|1024
)paren
suffix:semicolon
id|ses-&gt;serverNOS
op_assign
id|kcalloc
c_func
(paren
id|len
op_plus
l_int|1
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|ses-&gt;serverNOS
comma
id|bcc_ptr
comma
id|len
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
id|len
suffix:semicolon
id|bcc_ptr
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|bcc_ptr
op_increment
suffix:semicolon
id|len
op_assign
id|strnlen
c_func
(paren
id|bcc_ptr
comma
l_int|1024
)paren
suffix:semicolon
id|ses-&gt;serverDomain
op_assign
id|kcalloc
c_func
(paren
id|len
op_plus
l_int|1
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|ses-&gt;serverDomain
comma
id|bcc_ptr
comma
id|len
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
id|len
suffix:semicolon
id|bcc_ptr
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|bcc_ptr
op_increment
suffix:semicolon
)brace
r_else
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Variable field of length %d extends beyond end of smb &quot;
comma
id|len
)paren
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|cERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot; Security Blob Length extends beyond end of SMB&quot;
)paren
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|cERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;No session structure passed in.&quot;
)paren
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|cERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot; Invalid Word count %d: &quot;
comma
id|smb_buffer_response-&gt;WordCount
)paren
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
)brace
r_if
c_cond
(paren
id|smb_buffer
)paren
id|buf_release
c_func
(paren
id|smb_buffer
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_int
DECL|function|CIFSSpnegoSessSetup
id|CIFSSpnegoSessSetup
c_func
(paren
r_int
r_int
id|xid
comma
r_struct
id|cifsSesInfo
op_star
id|ses
comma
r_char
op_star
id|user
comma
r_char
op_star
id|domain
comma
r_char
op_star
id|SecurityBlob
comma
r_int
id|SecurityBlobLength
comma
r_const
r_struct
id|nls_table
op_star
id|nls_codepage
)paren
(brace
r_struct
id|smb_hdr
op_star
id|smb_buffer
suffix:semicolon
r_struct
id|smb_hdr
op_star
id|smb_buffer_response
suffix:semicolon
id|SESSION_SETUP_ANDX
op_star
id|pSMB
suffix:semicolon
id|SESSION_SETUP_ANDX
op_star
id|pSMBr
suffix:semicolon
r_char
op_star
id|bcc_ptr
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|remaining_words
op_assign
l_int|0
suffix:semicolon
r_int
id|bytes_returned
op_assign
l_int|0
suffix:semicolon
r_int
id|len
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;&bslash;nIn v2 sesssetup &quot;
)paren
)paren
suffix:semicolon
id|smb_buffer
op_assign
id|buf_get
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|smb_buffer
op_eq
l_int|0
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|smb_buffer_response
op_assign
id|smb_buffer
suffix:semicolon
id|pSMBr
op_assign
id|pSMB
op_assign
(paren
id|SESSION_SETUP_ANDX
op_star
)paren
id|smb_buffer
suffix:semicolon
multiline_comment|/* send SMBsessionSetup here */
id|header_assemble
c_func
(paren
id|smb_buffer
comma
id|SMB_COM_SESSION_SETUP_ANDX
comma
l_int|0
multiline_comment|/* no tCon exists yet */
comma
l_int|12
multiline_comment|/* wct */
)paren
suffix:semicolon
id|pSMB-&gt;req.hdr.Flags2
op_or_assign
id|SMBFLG2_EXT_SEC
suffix:semicolon
id|pSMB-&gt;req.AndXCommand
op_assign
l_int|0xFF
suffix:semicolon
id|pSMB-&gt;req.MaxBufferSize
op_assign
id|cpu_to_le16
c_func
(paren
id|ses-&gt;maxBuf
)paren
suffix:semicolon
id|pSMB-&gt;req.MaxMpxCount
op_assign
id|cpu_to_le16
c_func
(paren
id|ses-&gt;maxReq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ses-&gt;secMode
op_amp
(paren
id|SECMODE_SIGN_REQUIRED
op_or
id|SECMODE_SIGN_ENABLED
)paren
)paren
(brace
id|smb_buffer-&gt;Flags2
op_or_assign
id|SMBFLG2_SECURITY_SIGNATURE
suffix:semicolon
)brace
id|pSMB-&gt;req.Capabilities
op_assign
id|CAP_LARGE_FILES
op_or
id|CAP_NT_SMBS
op_or
id|CAP_LEVEL_II_OPLOCKS
op_or
id|CAP_EXTENDED_SECURITY
suffix:semicolon
r_if
c_cond
(paren
id|ses-&gt;capabilities
op_amp
id|CAP_UNICODE
)paren
(brace
id|smb_buffer-&gt;Flags2
op_or_assign
id|SMBFLG2_UNICODE
suffix:semicolon
id|pSMB-&gt;req.Capabilities
op_or_assign
id|CAP_UNICODE
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ses-&gt;capabilities
op_amp
id|CAP_STATUS32
)paren
(brace
id|smb_buffer-&gt;Flags2
op_or_assign
id|SMBFLG2_ERR_STATUS
suffix:semicolon
id|pSMB-&gt;req.Capabilities
op_or_assign
id|CAP_STATUS32
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ses-&gt;capabilities
op_amp
id|CAP_DFS
)paren
(brace
id|smb_buffer-&gt;Flags2
op_or_assign
id|SMBFLG2_DFS
suffix:semicolon
id|pSMB-&gt;req.Capabilities
op_or_assign
id|CAP_DFS
suffix:semicolon
)brace
id|pSMB-&gt;req.Capabilities
op_assign
id|cpu_to_le32
c_func
(paren
id|pSMB-&gt;req.Capabilities
)paren
suffix:semicolon
id|pSMB-&gt;req.SecurityBlobLength
op_assign
id|cpu_to_le16
c_func
(paren
id|SecurityBlobLength
)paren
suffix:semicolon
id|bcc_ptr
op_assign
id|pByteArea
c_func
(paren
id|smb_buffer
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|bcc_ptr
comma
id|SecurityBlob
comma
id|SecurityBlobLength
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
id|SecurityBlobLength
suffix:semicolon
r_if
c_cond
(paren
id|ses-&gt;capabilities
op_amp
id|CAP_UNICODE
)paren
(brace
r_if
c_cond
(paren
(paren
r_int
)paren
id|bcc_ptr
op_mod
l_int|2
)paren
(brace
multiline_comment|/* must be word aligned for Unicode strings */
op_star
id|bcc_ptr
op_assign
l_int|0
suffix:semicolon
id|bcc_ptr
op_increment
suffix:semicolon
)brace
id|bytes_returned
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
id|user
comma
l_int|100
comma
id|nls_codepage
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
op_star
id|bytes_returned
suffix:semicolon
multiline_comment|/* convert num of 16 bit words to bytes */
id|bcc_ptr
op_add_assign
l_int|2
suffix:semicolon
multiline_comment|/* trailing null */
r_if
c_cond
(paren
id|domain
op_eq
l_int|NULL
)paren
id|bytes_returned
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
l_string|&quot;CIFS_LINUX_DOM&quot;
comma
l_int|32
comma
id|nls_codepage
)paren
suffix:semicolon
r_else
id|bytes_returned
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
id|domain
comma
l_int|64
comma
id|nls_codepage
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
op_star
id|bytes_returned
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
suffix:semicolon
id|bytes_returned
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
l_string|&quot;Linux version &quot;
comma
l_int|32
comma
id|nls_codepage
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
op_star
id|bytes_returned
suffix:semicolon
id|bytes_returned
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
id|UTS_RELEASE
comma
l_int|32
comma
id|nls_codepage
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
op_star
id|bytes_returned
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
suffix:semicolon
id|bytes_returned
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
id|CIFS_NETWORK_OPSYS
comma
l_int|64
comma
id|nls_codepage
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
op_star
id|bytes_returned
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
suffix:semicolon
)brace
r_else
(brace
id|strncpy
c_func
(paren
id|bcc_ptr
comma
id|user
comma
l_int|200
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
id|strnlen
c_func
(paren
id|user
comma
l_int|200
)paren
suffix:semicolon
op_star
id|bcc_ptr
op_assign
l_int|0
suffix:semicolon
id|bcc_ptr
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|domain
op_eq
l_int|NULL
)paren
(brace
id|strcpy
c_func
(paren
id|bcc_ptr
comma
l_string|&quot;CIFS_LINUX_DOM&quot;
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
id|strlen
c_func
(paren
l_string|&quot;CIFS_LINUX_DOM&quot;
)paren
op_plus
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|strncpy
c_func
(paren
id|bcc_ptr
comma
id|domain
comma
l_int|64
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
id|strnlen
c_func
(paren
id|domain
comma
l_int|64
)paren
suffix:semicolon
op_star
id|bcc_ptr
op_assign
l_int|0
suffix:semicolon
id|bcc_ptr
op_increment
suffix:semicolon
)brace
id|strcpy
c_func
(paren
id|bcc_ptr
comma
l_string|&quot;Linux version &quot;
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
id|strlen
c_func
(paren
l_string|&quot;Linux version &quot;
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|bcc_ptr
comma
id|UTS_RELEASE
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
id|strlen
c_func
(paren
id|UTS_RELEASE
)paren
op_plus
l_int|1
suffix:semicolon
id|strcpy
c_func
(paren
id|bcc_ptr
comma
id|CIFS_NETWORK_OPSYS
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
id|strlen
c_func
(paren
id|CIFS_NETWORK_OPSYS
)paren
op_plus
l_int|1
suffix:semicolon
)brace
id|BCC
c_func
(paren
id|smb_buffer
)paren
op_assign
(paren
r_int
)paren
id|bcc_ptr
op_minus
(paren
r_int
)paren
id|pByteArea
c_func
(paren
id|smb_buffer
)paren
suffix:semicolon
id|smb_buffer-&gt;smb_buf_length
op_add_assign
id|BCC
c_func
(paren
id|smb_buffer
)paren
suffix:semicolon
id|BCC
c_func
(paren
id|smb_buffer
)paren
op_assign
id|cpu_to_le16
c_func
(paren
id|BCC
c_func
(paren
id|smb_buffer
)paren
)paren
suffix:semicolon
id|rc
op_assign
id|SendReceive
c_func
(paren
id|xid
comma
id|ses
comma
id|smb_buffer
comma
id|smb_buffer_response
comma
op_amp
id|bytes_returned
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
multiline_comment|/*    rc = map_smb_to_linux_error(smb_buffer_response);  */
multiline_comment|/* done in SendReceive now */
)brace
r_else
r_if
c_cond
(paren
(paren
id|smb_buffer_response-&gt;WordCount
op_eq
l_int|3
)paren
op_logical_or
(paren
id|smb_buffer_response-&gt;WordCount
op_eq
l_int|4
)paren
)paren
(brace
id|pSMBr-&gt;resp.Action
op_assign
id|le16_to_cpu
c_func
(paren
id|pSMBr-&gt;resp.Action
)paren
suffix:semicolon
id|pSMBr-&gt;resp.SecurityBlobLength
op_assign
id|le16_to_cpu
c_func
(paren
id|pSMBr-&gt;resp.SecurityBlobLength
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pSMBr-&gt;resp.Action
op_amp
id|GUEST_LOGIN
)paren
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot; Guest login&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* BB do we want to set anything in SesInfo struct ? */
r_if
c_cond
(paren
id|ses
)paren
(brace
id|ses-&gt;Suid
op_assign
id|smb_buffer_response-&gt;Uid
suffix:semicolon
multiline_comment|/* UID left in wire format (le) */
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;UID = %d &quot;
comma
id|ses-&gt;Suid
)paren
)paren
suffix:semicolon
id|bcc_ptr
op_assign
id|pByteArea
c_func
(paren
id|smb_buffer_response
)paren
suffix:semicolon
multiline_comment|/* response can have either 3 or 4 word count - Samba sends 3 */
multiline_comment|/* BB Fix below to make endian neutral !! */
r_if
c_cond
(paren
(paren
id|pSMBr-&gt;resp.hdr.WordCount
op_eq
l_int|3
)paren
op_logical_or
(paren
(paren
id|pSMBr-&gt;resp.hdr.WordCount
op_eq
l_int|4
)paren
op_logical_and
(paren
id|pSMBr-&gt;resp.SecurityBlobLength
OL
id|pSMBr-&gt;resp.ByteCount
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|pSMBr-&gt;resp.hdr.WordCount
op_eq
l_int|4
)paren
(brace
id|bcc_ptr
op_add_assign
id|pSMBr-&gt;resp.SecurityBlobLength
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;&bslash;nSecurity Blob Length %d &quot;
comma
id|pSMBr-&gt;resp.SecurityBlobLength
)paren
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|smb_buffer-&gt;Flags2
op_and_assign
id|SMBFLG2_UNICODE
)paren
(brace
r_if
c_cond
(paren
(paren
r_int
)paren
(paren
id|bcc_ptr
)paren
op_mod
l_int|2
)paren
(brace
id|remaining_words
op_assign
(paren
id|BCC
c_func
(paren
id|smb_buffer_response
)paren
op_minus
l_int|1
)paren
op_div
l_int|2
suffix:semicolon
id|bcc_ptr
op_increment
suffix:semicolon
multiline_comment|/* Unicode strings must be word aligned */
)brace
r_else
(brace
id|remaining_words
op_assign
id|BCC
(paren
id|smb_buffer_response
)paren
op_div
l_int|2
suffix:semicolon
)brace
id|len
op_assign
id|UniStrnlen
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
id|remaining_words
op_minus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* We look for obvious messed up bcc or strings in response so we do not go off&n;   the end since (at least) WIN2K and Windows XP have a major bug in not null&n;   terminating last Unicode string in response  */
id|ses-&gt;serverOS
op_assign
id|kcalloc
c_func
(paren
l_int|2
op_star
(paren
id|len
op_plus
l_int|1
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|cifs_strfromUCS_le
c_func
(paren
id|ses-&gt;serverOS
comma
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
id|len
comma
id|nls_codepage
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
op_star
(paren
id|len
op_plus
l_int|1
)paren
suffix:semicolon
id|remaining_words
op_sub_assign
id|len
op_plus
l_int|1
suffix:semicolon
id|ses-&gt;serverOS
(braket
l_int|2
op_star
id|len
)braket
op_assign
l_int|0
suffix:semicolon
id|ses-&gt;serverOS
(braket
l_int|1
op_plus
(paren
l_int|2
op_star
id|len
)paren
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|remaining_words
OG
l_int|0
)paren
(brace
id|len
op_assign
id|UniStrnlen
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
id|remaining_words
op_minus
l_int|1
)paren
suffix:semicolon
id|ses-&gt;serverNOS
op_assign
id|kcalloc
c_func
(paren
l_int|2
op_star
(paren
id|len
op_plus
l_int|1
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|cifs_strfromUCS_le
c_func
(paren
id|ses-&gt;serverNOS
comma
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
id|len
comma
id|nls_codepage
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
op_star
(paren
id|len
op_plus
l_int|1
)paren
suffix:semicolon
id|ses-&gt;serverNOS
(braket
l_int|2
op_star
id|len
)braket
op_assign
l_int|0
suffix:semicolon
id|ses-&gt;serverNOS
(braket
l_int|1
op_plus
(paren
l_int|2
op_star
id|len
)paren
)braket
op_assign
l_int|0
suffix:semicolon
id|remaining_words
op_sub_assign
id|len
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|remaining_words
OG
l_int|0
)paren
(brace
id|len
op_assign
id|UniStrnlen
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
id|remaining_words
)paren
suffix:semicolon
multiline_comment|/* last string is not always null terminated (for e.g. for Windows XP &amp; 2000) */
id|ses-&gt;serverDomain
op_assign
id|kcalloc
c_func
(paren
l_int|2
op_star
(paren
id|len
op_plus
l_int|1
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|cifs_strfromUCS_le
c_func
(paren
id|ses-&gt;serverDomain
comma
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
id|len
comma
id|nls_codepage
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
op_star
(paren
id|len
op_plus
l_int|1
)paren
suffix:semicolon
id|ses-&gt;serverDomain
(braket
l_int|2
op_star
id|len
)braket
op_assign
l_int|0
suffix:semicolon
id|ses-&gt;serverDomain
(braket
l_int|1
op_plus
(paren
l_int|2
op_star
id|len
)paren
)braket
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* else no more room so create dummy domain string */
r_else
id|ses-&gt;serverDomain
op_assign
id|kcalloc
c_func
(paren
l_int|2
comma
id|GFP_KERNEL
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* no room so create dummy domain and NOS string */
id|ses-&gt;serverDomain
op_assign
id|kcalloc
c_func
(paren
l_int|2
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|ses-&gt;serverNOS
op_assign
id|kcalloc
c_func
(paren
l_int|2
comma
id|GFP_KERNEL
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* ASCII */
id|len
op_assign
id|strnlen
c_func
(paren
id|bcc_ptr
comma
l_int|1024
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
r_int
)paren
id|bcc_ptr
op_plus
id|len
)paren
op_minus
(paren
r_int
)paren
id|pByteArea
c_func
(paren
id|smb_buffer_response
)paren
op_le
id|BCC
c_func
(paren
id|smb_buffer_response
)paren
)paren
(brace
id|ses-&gt;serverOS
op_assign
id|kcalloc
c_func
(paren
id|len
op_plus
l_int|1
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|ses-&gt;serverOS
comma
id|bcc_ptr
comma
id|len
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
id|len
suffix:semicolon
id|bcc_ptr
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* null terminate the string */
id|bcc_ptr
op_increment
suffix:semicolon
id|len
op_assign
id|strnlen
c_func
(paren
id|bcc_ptr
comma
l_int|1024
)paren
suffix:semicolon
id|ses-&gt;serverNOS
op_assign
id|kcalloc
c_func
(paren
id|len
op_plus
l_int|1
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|ses-&gt;serverNOS
comma
id|bcc_ptr
comma
id|len
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
id|len
suffix:semicolon
id|bcc_ptr
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|bcc_ptr
op_increment
suffix:semicolon
id|len
op_assign
id|strnlen
c_func
(paren
id|bcc_ptr
comma
l_int|1024
)paren
suffix:semicolon
id|ses-&gt;serverDomain
op_assign
id|kcalloc
c_func
(paren
id|len
op_plus
l_int|1
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|ses-&gt;serverDomain
comma
id|bcc_ptr
comma
id|len
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
id|len
suffix:semicolon
id|bcc_ptr
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|bcc_ptr
op_increment
suffix:semicolon
)brace
r_else
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Variable field of length %d extends beyond end of smb &quot;
comma
id|len
)paren
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|cERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot; Security Blob Length extends beyond end of SMB&quot;
)paren
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|cERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;No session structure passed in.&quot;
)paren
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|cERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot; Invalid Word count %d: &quot;
comma
id|smb_buffer_response-&gt;WordCount
)paren
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
)brace
r_if
c_cond
(paren
id|smb_buffer
)paren
id|buf_release
c_func
(paren
id|smb_buffer
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_int
DECL|function|CIFSNTLMSSPNegotiateSessSetup
id|CIFSNTLMSSPNegotiateSessSetup
c_func
(paren
r_int
r_int
id|xid
comma
r_struct
id|cifsSesInfo
op_star
id|ses
comma
r_char
op_star
id|challenge_from_server
comma
r_char
op_star
id|domain
comma
r_int
op_star
id|pNTLMv2_flag
comma
r_const
r_struct
id|nls_table
op_star
id|nls_codepage
)paren
(brace
r_struct
id|smb_hdr
op_star
id|smb_buffer
suffix:semicolon
r_struct
id|smb_hdr
op_star
id|smb_buffer_response
suffix:semicolon
id|SESSION_SETUP_ANDX
op_star
id|pSMB
suffix:semicolon
id|SESSION_SETUP_ANDX
op_star
id|pSMBr
suffix:semicolon
r_char
op_star
id|bcc_ptr
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|remaining_words
op_assign
l_int|0
suffix:semicolon
r_int
id|bytes_returned
op_assign
l_int|0
suffix:semicolon
r_int
id|len
suffix:semicolon
r_int
id|SecurityBlobLength
op_assign
r_sizeof
(paren
id|NEGOTIATE_MESSAGE
)paren
suffix:semicolon
id|PNEGOTIATE_MESSAGE
id|SecurityBlob
suffix:semicolon
id|PCHALLENGE_MESSAGE
id|SecurityBlob2
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;&bslash;nIn NTLMSSP sesssetup (negotiate) &quot;
)paren
)paren
suffix:semicolon
op_star
id|pNTLMv2_flag
op_assign
id|FALSE
suffix:semicolon
id|smb_buffer
op_assign
id|buf_get
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|smb_buffer
op_eq
l_int|0
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|smb_buffer_response
op_assign
id|smb_buffer
suffix:semicolon
id|pSMB
op_assign
(paren
id|SESSION_SETUP_ANDX
op_star
)paren
id|smb_buffer
suffix:semicolon
id|pSMBr
op_assign
(paren
id|SESSION_SETUP_ANDX
op_star
)paren
id|smb_buffer_response
suffix:semicolon
multiline_comment|/* send SMBsessionSetup here */
id|header_assemble
c_func
(paren
id|smb_buffer
comma
id|SMB_COM_SESSION_SETUP_ANDX
comma
l_int|0
multiline_comment|/* no tCon exists yet */
comma
l_int|12
multiline_comment|/* wct */
)paren
suffix:semicolon
id|pSMB-&gt;req.hdr.Flags2
op_or_assign
id|SMBFLG2_EXT_SEC
suffix:semicolon
id|pSMB-&gt;req.hdr.Flags
op_or_assign
(paren
id|SMBFLG_CASELESS
op_or
id|SMBFLG_CANONICAL_PATH_FORMAT
)paren
suffix:semicolon
id|pSMB-&gt;req.AndXCommand
op_assign
l_int|0xFF
suffix:semicolon
id|pSMB-&gt;req.MaxBufferSize
op_assign
id|cpu_to_le16
c_func
(paren
id|ses-&gt;maxBuf
)paren
suffix:semicolon
id|pSMB-&gt;req.MaxMpxCount
op_assign
id|cpu_to_le16
c_func
(paren
id|ses-&gt;maxReq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ses-&gt;secMode
op_amp
(paren
id|SECMODE_SIGN_REQUIRED
op_or
id|SECMODE_SIGN_ENABLED
)paren
)paren
(brace
id|smb_buffer-&gt;Flags2
op_or_assign
id|SMBFLG2_SECURITY_SIGNATURE
suffix:semicolon
)brace
id|pSMB-&gt;req.Capabilities
op_assign
id|CAP_LARGE_FILES
op_or
id|CAP_NT_SMBS
op_or
id|CAP_LEVEL_II_OPLOCKS
op_or
id|CAP_EXTENDED_SECURITY
suffix:semicolon
r_if
c_cond
(paren
id|ses-&gt;capabilities
op_amp
id|CAP_UNICODE
)paren
(brace
id|smb_buffer-&gt;Flags2
op_or_assign
id|SMBFLG2_UNICODE
suffix:semicolon
id|pSMB-&gt;req.Capabilities
op_or_assign
id|CAP_UNICODE
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ses-&gt;capabilities
op_amp
id|CAP_STATUS32
)paren
(brace
id|smb_buffer-&gt;Flags2
op_or_assign
id|SMBFLG2_ERR_STATUS
suffix:semicolon
id|pSMB-&gt;req.Capabilities
op_or_assign
id|CAP_STATUS32
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ses-&gt;capabilities
op_amp
id|CAP_DFS
)paren
(brace
id|smb_buffer-&gt;Flags2
op_or_assign
id|SMBFLG2_DFS
suffix:semicolon
id|pSMB-&gt;req.Capabilities
op_or_assign
id|CAP_DFS
suffix:semicolon
)brace
id|pSMB-&gt;req.Capabilities
op_assign
id|cpu_to_le32
c_func
(paren
id|pSMB-&gt;req.Capabilities
)paren
suffix:semicolon
id|bcc_ptr
op_assign
(paren
r_char
op_star
)paren
op_amp
id|pSMB-&gt;req.SecurityBlob
suffix:semicolon
id|SecurityBlob
op_assign
(paren
id|PNEGOTIATE_MESSAGE
)paren
id|bcc_ptr
suffix:semicolon
id|strncpy
c_func
(paren
id|SecurityBlob-&gt;Signature
comma
id|NTLMSSP_SIGNATURE
comma
l_int|8
)paren
suffix:semicolon
id|SecurityBlob-&gt;MessageType
op_assign
id|NtLmNegotiate
suffix:semicolon
id|SecurityBlob-&gt;NegotiateFlags
op_assign
id|NTLMSSP_NEGOTIATE_UNICODE
op_or
id|NTLMSSP_NEGOTIATE_OEM
op_or
id|NTLMSSP_REQUEST_TARGET
op_or
id|NTLMSSP_NEGOTIATE_NTLM
op_or
l_int|0x80000000
op_or
id|NTLMSSP_NEGOTIATE_ALWAYS_SIGN
op_or
id|NTLMSSP_NEGOTIATE_128
suffix:semicolon
r_if
c_cond
(paren
id|ntlmv2_support
)paren
(brace
id|SecurityBlob-&gt;NegotiateFlags
op_or_assign
id|NTLMSSP_NEGOTIATE_NTLMV2
suffix:semicolon
)brace
multiline_comment|/* setup pointers to domain name and workstation name */
id|bcc_ptr
op_add_assign
id|SecurityBlobLength
suffix:semicolon
id|SecurityBlob-&gt;WorkstationName.Buffer
op_assign
l_int|0
suffix:semicolon
id|SecurityBlob-&gt;WorkstationName.Length
op_assign
l_int|0
suffix:semicolon
id|SecurityBlob-&gt;WorkstationName.MaximumLength
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|domain
op_eq
l_int|NULL
)paren
(brace
id|SecurityBlob-&gt;DomainName.Buffer
op_assign
l_int|0
suffix:semicolon
id|SecurityBlob-&gt;DomainName.Length
op_assign
l_int|0
suffix:semicolon
id|SecurityBlob-&gt;DomainName.MaximumLength
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|SecurityBlob-&gt;NegotiateFlags
op_or_assign
id|NTLMSSP_NEGOTIATE_DOMAIN_SUPPLIED
suffix:semicolon
id|strncpy
c_func
(paren
id|bcc_ptr
comma
id|domain
comma
l_int|63
)paren
suffix:semicolon
id|SecurityBlob-&gt;DomainName.Length
op_assign
id|strnlen
c_func
(paren
id|domain
comma
l_int|64
)paren
suffix:semicolon
id|SecurityBlob-&gt;DomainName.MaximumLength
op_assign
id|cpu_to_le16
c_func
(paren
id|SecurityBlob-&gt;DomainName.Length
)paren
suffix:semicolon
id|SecurityBlob-&gt;DomainName.Buffer
op_assign
id|cpu_to_le32
c_func
(paren
(paren
r_int
)paren
op_amp
id|SecurityBlob
op_member_access_from_pointer
id|DomainString
op_minus
(paren
r_int
)paren
op_amp
id|SecurityBlob-&gt;Signature
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
id|SecurityBlob-&gt;DomainName.Length
suffix:semicolon
id|SecurityBlobLength
op_add_assign
id|SecurityBlob-&gt;DomainName.Length
suffix:semicolon
id|SecurityBlob-&gt;DomainName.Length
op_assign
id|cpu_to_le16
c_func
(paren
id|SecurityBlob-&gt;DomainName.Length
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ses-&gt;capabilities
op_amp
id|CAP_UNICODE
)paren
(brace
r_if
c_cond
(paren
(paren
r_int
)paren
id|bcc_ptr
op_mod
l_int|2
)paren
(brace
op_star
id|bcc_ptr
op_assign
l_int|0
suffix:semicolon
id|bcc_ptr
op_increment
suffix:semicolon
)brace
id|bytes_returned
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
l_string|&quot;Linux version &quot;
comma
l_int|32
comma
id|nls_codepage
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
op_star
id|bytes_returned
suffix:semicolon
id|bytes_returned
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
id|UTS_RELEASE
comma
l_int|32
comma
id|nls_codepage
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
op_star
id|bytes_returned
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
suffix:semicolon
multiline_comment|/* null terminate Linux version */
id|bytes_returned
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
id|CIFS_NETWORK_OPSYS
comma
l_int|64
comma
id|nls_codepage
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
op_star
id|bytes_returned
suffix:semicolon
op_star
(paren
id|bcc_ptr
op_plus
l_int|1
)paren
op_assign
l_int|0
suffix:semicolon
op_star
(paren
id|bcc_ptr
op_plus
l_int|2
)paren
op_assign
l_int|0
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
suffix:semicolon
multiline_comment|/* null terminate network opsys string */
op_star
(paren
id|bcc_ptr
op_plus
l_int|1
)paren
op_assign
l_int|0
suffix:semicolon
op_star
(paren
id|bcc_ptr
op_plus
l_int|2
)paren
op_assign
l_int|0
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
suffix:semicolon
multiline_comment|/* null domain */
)brace
r_else
(brace
multiline_comment|/* ASCII */
id|strcpy
c_func
(paren
id|bcc_ptr
comma
l_string|&quot;Linux version &quot;
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
id|strlen
c_func
(paren
l_string|&quot;Linux version &quot;
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|bcc_ptr
comma
id|UTS_RELEASE
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
id|strlen
c_func
(paren
id|UTS_RELEASE
)paren
op_plus
l_int|1
suffix:semicolon
id|strcpy
c_func
(paren
id|bcc_ptr
comma
id|CIFS_NETWORK_OPSYS
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
id|strlen
c_func
(paren
id|CIFS_NETWORK_OPSYS
)paren
op_plus
l_int|1
suffix:semicolon
id|bcc_ptr
op_increment
suffix:semicolon
multiline_comment|/* empty domain field */
op_star
id|bcc_ptr
op_assign
l_int|0
suffix:semicolon
)brace
id|SecurityBlob-&gt;NegotiateFlags
op_assign
id|cpu_to_le32
c_func
(paren
id|SecurityBlob-&gt;NegotiateFlags
)paren
suffix:semicolon
id|pSMB-&gt;req.SecurityBlobLength
op_assign
id|cpu_to_le16
c_func
(paren
id|SecurityBlobLength
)paren
suffix:semicolon
id|BCC
c_func
(paren
id|smb_buffer
)paren
op_assign
(paren
r_int
)paren
id|bcc_ptr
op_minus
(paren
r_int
)paren
id|pByteArea
c_func
(paren
id|smb_buffer
)paren
suffix:semicolon
id|smb_buffer-&gt;smb_buf_length
op_add_assign
id|BCC
c_func
(paren
id|smb_buffer
)paren
suffix:semicolon
id|BCC
c_func
(paren
id|smb_buffer
)paren
op_assign
id|cpu_to_le16
c_func
(paren
id|BCC
c_func
(paren
id|smb_buffer
)paren
)paren
suffix:semicolon
id|rc
op_assign
id|SendReceive
c_func
(paren
id|xid
comma
id|ses
comma
id|smb_buffer
comma
id|smb_buffer_response
comma
op_amp
id|bytes_returned
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|smb_buffer_response-&gt;Status.CifsError
op_eq
(paren
id|NT_STATUS_MORE_PROCESSING_REQUIRED
)paren
)paren
id|rc
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
multiline_comment|/*    rc = map_smb_to_linux_error(smb_buffer_response);  */
multiline_comment|/* done in SendReceive now */
)brace
r_else
r_if
c_cond
(paren
(paren
id|smb_buffer_response-&gt;WordCount
op_eq
l_int|3
)paren
op_logical_or
(paren
id|smb_buffer_response-&gt;WordCount
op_eq
l_int|4
)paren
)paren
(brace
id|pSMBr-&gt;resp.Action
op_assign
id|le16_to_cpu
c_func
(paren
id|pSMBr-&gt;resp.Action
)paren
suffix:semicolon
id|pSMBr-&gt;resp.SecurityBlobLength
op_assign
id|le16_to_cpu
c_func
(paren
id|pSMBr-&gt;resp.SecurityBlobLength
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pSMBr-&gt;resp.Action
op_amp
id|GUEST_LOGIN
)paren
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot; Guest login&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* Do we want to set anything in SesInfo struct when guest login? */
id|bcc_ptr
op_assign
id|pByteArea
c_func
(paren
id|smb_buffer_response
)paren
suffix:semicolon
multiline_comment|/* response can have either 3 or 4 word count - Samba sends 3 */
id|SecurityBlob2
op_assign
(paren
id|PCHALLENGE_MESSAGE
)paren
id|bcc_ptr
suffix:semicolon
r_if
c_cond
(paren
id|SecurityBlob2-&gt;MessageType
op_ne
id|NtLmChallenge
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;&bslash;nUnexpected NTLMSSP message type received %d&quot;
comma
id|SecurityBlob2-&gt;MessageType
)paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|ses
)paren
(brace
id|ses-&gt;Suid
op_assign
id|smb_buffer_response-&gt;Uid
suffix:semicolon
multiline_comment|/* UID left in le format */
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;UID = %d &quot;
comma
id|ses-&gt;Suid
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pSMBr-&gt;resp.hdr.WordCount
op_eq
l_int|3
)paren
op_logical_or
(paren
(paren
id|pSMBr-&gt;resp.hdr.WordCount
op_eq
l_int|4
)paren
op_logical_and
(paren
id|pSMBr-&gt;resp.SecurityBlobLength
OL
id|pSMBr-&gt;resp.ByteCount
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|pSMBr-&gt;resp.hdr.WordCount
op_eq
l_int|4
)paren
(brace
id|bcc_ptr
op_add_assign
id|pSMBr-&gt;resp.SecurityBlobLength
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;&bslash;nSecurity Blob Length %d &quot;
comma
id|pSMBr-&gt;resp.SecurityBlobLength
)paren
)paren
suffix:semicolon
)brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;&bslash;nNTLMSSP Challenge rcvd &quot;
)paren
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|challenge_from_server
comma
id|SecurityBlob2-&gt;Challenge
comma
id|CIFS_CRYPTO_KEY_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|SecurityBlob2-&gt;NegotiateFlags
op_amp
id|NTLMSSP_NEGOTIATE_NTLMV2
)paren
(brace
op_star
id|pNTLMv2_flag
op_assign
id|TRUE
suffix:semicolon
)brace
r_if
c_cond
(paren
id|smb_buffer-&gt;Flags2
op_and_assign
id|SMBFLG2_UNICODE
)paren
(brace
r_if
c_cond
(paren
(paren
r_int
)paren
(paren
id|bcc_ptr
)paren
op_mod
l_int|2
)paren
(brace
id|remaining_words
op_assign
(paren
id|BCC
c_func
(paren
id|smb_buffer_response
)paren
op_minus
l_int|1
)paren
op_div
l_int|2
suffix:semicolon
id|bcc_ptr
op_increment
suffix:semicolon
multiline_comment|/* Unicode strings must be word aligned */
)brace
r_else
(brace
id|remaining_words
op_assign
id|BCC
(paren
id|smb_buffer_response
)paren
op_div
l_int|2
suffix:semicolon
)brace
id|len
op_assign
id|UniStrnlen
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
id|remaining_words
op_minus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* We look for obvious messed up bcc or strings in response so we do not go off&n;   the end since (at least) WIN2K and Windows XP have a major bug in not null&n;   terminating last Unicode string in response  */
id|ses-&gt;serverOS
op_assign
id|kcalloc
c_func
(paren
l_int|2
op_star
(paren
id|len
op_plus
l_int|1
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|cifs_strfromUCS_le
c_func
(paren
id|ses-&gt;serverOS
comma
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
id|len
comma
id|nls_codepage
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
op_star
(paren
id|len
op_plus
l_int|1
)paren
suffix:semicolon
id|remaining_words
op_sub_assign
id|len
op_plus
l_int|1
suffix:semicolon
id|ses-&gt;serverOS
(braket
l_int|2
op_star
id|len
)braket
op_assign
l_int|0
suffix:semicolon
id|ses-&gt;serverOS
(braket
l_int|1
op_plus
(paren
l_int|2
op_star
id|len
)paren
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|remaining_words
OG
l_int|0
)paren
(brace
id|len
op_assign
id|UniStrnlen
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
id|remaining_words
op_minus
l_int|1
)paren
suffix:semicolon
id|ses-&gt;serverNOS
op_assign
id|kcalloc
c_func
(paren
l_int|2
op_star
(paren
id|len
op_plus
l_int|1
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|cifs_strfromUCS_le
c_func
(paren
id|ses
op_member_access_from_pointer
id|serverNOS
comma
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
id|len
comma
id|nls_codepage
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
op_star
(paren
id|len
op_plus
l_int|1
)paren
suffix:semicolon
id|ses-&gt;serverNOS
(braket
l_int|2
op_star
id|len
)braket
op_assign
l_int|0
suffix:semicolon
id|ses-&gt;serverNOS
(braket
l_int|1
op_plus
(paren
l_int|2
op_star
id|len
)paren
)braket
op_assign
l_int|0
suffix:semicolon
id|remaining_words
op_sub_assign
id|len
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|remaining_words
OG
l_int|0
)paren
(brace
id|len
op_assign
id|UniStrnlen
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
id|remaining_words
)paren
suffix:semicolon
multiline_comment|/* last string is not always null terminated (for e.g. for Windows XP &amp; 2000) */
id|ses-&gt;serverDomain
op_assign
id|kcalloc
c_func
(paren
l_int|2
op_star
(paren
id|len
op_plus
l_int|1
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|cifs_strfromUCS_le
(paren
id|ses
op_member_access_from_pointer
id|serverDomain
comma
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
id|len
comma
id|nls_codepage
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
op_star
(paren
id|len
op_plus
l_int|1
)paren
suffix:semicolon
id|ses
op_member_access_from_pointer
id|serverDomain
(braket
l_int|2
op_star
id|len
)braket
op_assign
l_int|0
suffix:semicolon
id|ses
op_member_access_from_pointer
id|serverDomain
(braket
l_int|1
op_plus
(paren
l_int|2
op_star
id|len
)paren
)braket
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* else no more room so create dummy domain string */
r_else
id|ses-&gt;serverDomain
op_assign
id|kcalloc
c_func
(paren
l_int|2
comma
id|GFP_KERNEL
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* no room so create dummy domain and NOS string */
id|ses-&gt;serverDomain
op_assign
id|kcalloc
c_func
(paren
l_int|2
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|ses-&gt;serverNOS
op_assign
id|kcalloc
c_func
(paren
l_int|2
comma
id|GFP_KERNEL
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* ASCII */
id|len
op_assign
id|strnlen
c_func
(paren
id|bcc_ptr
comma
l_int|1024
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
r_int
)paren
id|bcc_ptr
op_plus
id|len
)paren
op_minus
(paren
r_int
)paren
id|pByteArea
c_func
(paren
id|smb_buffer_response
)paren
op_le
id|BCC
c_func
(paren
id|smb_buffer_response
)paren
)paren
(brace
id|ses-&gt;serverOS
op_assign
id|kcalloc
c_func
(paren
id|len
op_plus
l_int|1
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|ses-&gt;serverOS
comma
id|bcc_ptr
comma
id|len
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
id|len
suffix:semicolon
id|bcc_ptr
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* null terminate string */
id|bcc_ptr
op_increment
suffix:semicolon
id|len
op_assign
id|strnlen
c_func
(paren
id|bcc_ptr
comma
l_int|1024
)paren
suffix:semicolon
id|ses-&gt;serverNOS
op_assign
id|kcalloc
c_func
(paren
id|len
op_plus
l_int|1
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|ses-&gt;serverNOS
comma
id|bcc_ptr
comma
id|len
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
id|len
suffix:semicolon
id|bcc_ptr
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|bcc_ptr
op_increment
suffix:semicolon
id|len
op_assign
id|strnlen
c_func
(paren
id|bcc_ptr
comma
l_int|1024
)paren
suffix:semicolon
id|ses-&gt;serverDomain
op_assign
id|kcalloc
c_func
(paren
id|len
op_plus
l_int|1
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|ses-&gt;serverDomain
comma
id|bcc_ptr
comma
id|len
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
id|len
suffix:semicolon
id|bcc_ptr
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|bcc_ptr
op_increment
suffix:semicolon
)brace
r_else
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Variable field of length %d extends beyond end of smb &quot;
comma
id|len
)paren
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|cERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot; Security Blob Length extends beyond end of SMB&quot;
)paren
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|cERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;No session structure passed in.&quot;
)paren
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|cERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot; Invalid Word count %d: &quot;
comma
id|smb_buffer_response-&gt;WordCount
)paren
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
)brace
r_if
c_cond
(paren
id|smb_buffer
)paren
id|buf_release
c_func
(paren
id|smb_buffer
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_int
DECL|function|CIFSNTLMSSPAuthSessSetup
id|CIFSNTLMSSPAuthSessSetup
c_func
(paren
r_int
r_int
id|xid
comma
r_struct
id|cifsSesInfo
op_star
id|ses
comma
r_char
op_star
id|user
comma
r_char
op_star
id|domain
comma
r_char
op_star
id|ntlm_session_key
comma
r_char
op_star
id|lanman_session_key
comma
r_int
id|ntlmv2_flag
comma
r_const
r_struct
id|nls_table
op_star
id|nls_codepage
)paren
(brace
r_struct
id|smb_hdr
op_star
id|smb_buffer
suffix:semicolon
r_struct
id|smb_hdr
op_star
id|smb_buffer_response
suffix:semicolon
id|SESSION_SETUP_ANDX
op_star
id|pSMB
suffix:semicolon
id|SESSION_SETUP_ANDX
op_star
id|pSMBr
suffix:semicolon
r_char
op_star
id|bcc_ptr
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|remaining_words
op_assign
l_int|0
suffix:semicolon
r_int
id|bytes_returned
op_assign
l_int|0
suffix:semicolon
r_int
id|len
suffix:semicolon
r_int
id|SecurityBlobLength
op_assign
r_sizeof
(paren
id|AUTHENTICATE_MESSAGE
)paren
suffix:semicolon
id|PAUTHENTICATE_MESSAGE
id|SecurityBlob
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;&bslash;nIn NTLMSSPSessSetup (Authenticate)&quot;
)paren
)paren
suffix:semicolon
id|smb_buffer
op_assign
id|buf_get
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|smb_buffer
op_eq
l_int|0
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|smb_buffer_response
op_assign
id|smb_buffer
suffix:semicolon
id|pSMB
op_assign
(paren
id|SESSION_SETUP_ANDX
op_star
)paren
id|smb_buffer
suffix:semicolon
id|pSMBr
op_assign
(paren
id|SESSION_SETUP_ANDX
op_star
)paren
id|smb_buffer_response
suffix:semicolon
multiline_comment|/* send SMBsessionSetup here */
id|header_assemble
c_func
(paren
id|smb_buffer
comma
id|SMB_COM_SESSION_SETUP_ANDX
comma
l_int|0
multiline_comment|/* no tCon exists yet */
comma
l_int|12
multiline_comment|/* wct */
)paren
suffix:semicolon
id|pSMB-&gt;req.hdr.Flags
op_or_assign
(paren
id|SMBFLG_CASELESS
op_or
id|SMBFLG_CANONICAL_PATH_FORMAT
)paren
suffix:semicolon
id|pSMB-&gt;req.hdr.Flags2
op_or_assign
id|SMBFLG2_EXT_SEC
suffix:semicolon
id|pSMB-&gt;req.AndXCommand
op_assign
l_int|0xFF
suffix:semicolon
id|pSMB-&gt;req.MaxBufferSize
op_assign
id|cpu_to_le16
c_func
(paren
id|ses-&gt;maxBuf
)paren
suffix:semicolon
id|pSMB-&gt;req.MaxMpxCount
op_assign
id|cpu_to_le16
c_func
(paren
id|ses-&gt;maxReq
)paren
suffix:semicolon
id|pSMB-&gt;req.hdr.Uid
op_assign
id|ses-&gt;Suid
suffix:semicolon
r_if
c_cond
(paren
id|ses-&gt;secMode
op_amp
(paren
id|SECMODE_SIGN_REQUIRED
op_or
id|SECMODE_SIGN_ENABLED
)paren
)paren
(brace
id|smb_buffer-&gt;Flags2
op_or_assign
id|SMBFLG2_SECURITY_SIGNATURE
suffix:semicolon
)brace
id|pSMB-&gt;req.Capabilities
op_assign
id|CAP_LARGE_FILES
op_or
id|CAP_NT_SMBS
op_or
id|CAP_LEVEL_II_OPLOCKS
op_or
id|CAP_EXTENDED_SECURITY
suffix:semicolon
r_if
c_cond
(paren
id|ses-&gt;capabilities
op_amp
id|CAP_UNICODE
)paren
(brace
id|smb_buffer-&gt;Flags2
op_or_assign
id|SMBFLG2_UNICODE
suffix:semicolon
id|pSMB-&gt;req.Capabilities
op_or_assign
id|CAP_UNICODE
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ses-&gt;capabilities
op_amp
id|CAP_STATUS32
)paren
(brace
id|smb_buffer-&gt;Flags2
op_or_assign
id|SMBFLG2_ERR_STATUS
suffix:semicolon
id|pSMB-&gt;req.Capabilities
op_or_assign
id|CAP_STATUS32
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ses-&gt;capabilities
op_amp
id|CAP_DFS
)paren
(brace
id|smb_buffer-&gt;Flags2
op_or_assign
id|SMBFLG2_DFS
suffix:semicolon
id|pSMB-&gt;req.Capabilities
op_or_assign
id|CAP_DFS
suffix:semicolon
)brace
id|pSMB-&gt;req.Capabilities
op_assign
id|cpu_to_le32
c_func
(paren
id|pSMB-&gt;req.Capabilities
)paren
suffix:semicolon
id|bcc_ptr
op_assign
(paren
r_char
op_star
)paren
op_amp
id|pSMB-&gt;req.SecurityBlob
suffix:semicolon
id|SecurityBlob
op_assign
(paren
id|PAUTHENTICATE_MESSAGE
)paren
id|bcc_ptr
suffix:semicolon
id|strncpy
c_func
(paren
id|SecurityBlob-&gt;Signature
comma
id|NTLMSSP_SIGNATURE
comma
l_int|8
)paren
suffix:semicolon
id|SecurityBlob-&gt;MessageType
op_assign
id|NtLmAuthenticate
suffix:semicolon
id|bcc_ptr
op_add_assign
id|SecurityBlobLength
suffix:semicolon
id|SecurityBlob-&gt;NegotiateFlags
op_assign
id|NTLMSSP_NEGOTIATE_UNICODE
op_or
id|NTLMSSP_REQUEST_TARGET
op_or
id|NTLMSSP_NEGOTIATE_NTLM
op_or
id|NTLMSSP_NEGOTIATE_TARGET_INFO
op_or
l_int|0x80000000
op_or
id|NTLMSSP_NEGOTIATE_ALWAYS_SIGN
op_or
id|NTLMSSP_NEGOTIATE_128
suffix:semicolon
r_if
c_cond
(paren
id|ntlmv2_flag
)paren
(brace
id|SecurityBlob-&gt;NegotiateFlags
op_or_assign
id|NTLMSSP_NEGOTIATE_NTLMV2
suffix:semicolon
)brace
multiline_comment|/* setup pointers to domain name and workstation name */
id|SecurityBlob-&gt;WorkstationName.Buffer
op_assign
l_int|0
suffix:semicolon
id|SecurityBlob-&gt;WorkstationName.Length
op_assign
l_int|0
suffix:semicolon
id|SecurityBlob-&gt;WorkstationName.MaximumLength
op_assign
l_int|0
suffix:semicolon
id|SecurityBlob-&gt;SessionKey.Length
op_assign
l_int|0
suffix:semicolon
id|SecurityBlob-&gt;SessionKey.MaximumLength
op_assign
l_int|0
suffix:semicolon
id|SecurityBlob-&gt;SessionKey.Buffer
op_assign
l_int|0
suffix:semicolon
id|SecurityBlob-&gt;LmChallengeResponse.Length
op_assign
l_int|0
suffix:semicolon
id|SecurityBlob-&gt;LmChallengeResponse.MaximumLength
op_assign
l_int|0
suffix:semicolon
id|SecurityBlob-&gt;LmChallengeResponse.Buffer
op_assign
l_int|0
suffix:semicolon
id|SecurityBlob-&gt;NtChallengeResponse.Length
op_assign
id|cpu_to_le16
c_func
(paren
id|CIFS_SESSION_KEY_SIZE
)paren
suffix:semicolon
id|SecurityBlob-&gt;NtChallengeResponse.MaximumLength
op_assign
id|cpu_to_le16
c_func
(paren
id|CIFS_SESSION_KEY_SIZE
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|bcc_ptr
comma
id|ntlm_session_key
comma
id|CIFS_SESSION_KEY_SIZE
)paren
suffix:semicolon
id|SecurityBlob-&gt;NtChallengeResponse.Buffer
op_assign
id|cpu_to_le32
c_func
(paren
id|SecurityBlobLength
)paren
suffix:semicolon
id|SecurityBlobLength
op_add_assign
id|CIFS_SESSION_KEY_SIZE
suffix:semicolon
id|bcc_ptr
op_add_assign
id|CIFS_SESSION_KEY_SIZE
suffix:semicolon
r_if
c_cond
(paren
id|ses-&gt;capabilities
op_amp
id|CAP_UNICODE
)paren
(brace
r_if
c_cond
(paren
id|domain
op_eq
l_int|NULL
)paren
(brace
id|SecurityBlob-&gt;DomainName.Buffer
op_assign
l_int|0
suffix:semicolon
id|SecurityBlob-&gt;DomainName.Length
op_assign
l_int|0
suffix:semicolon
id|SecurityBlob-&gt;DomainName.MaximumLength
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|SecurityBlob-&gt;DomainName.Length
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
id|domain
comma
l_int|64
comma
id|nls_codepage
)paren
suffix:semicolon
id|SecurityBlob-&gt;DomainName.Length
op_mul_assign
l_int|2
suffix:semicolon
id|SecurityBlob-&gt;DomainName.MaximumLength
op_assign
id|cpu_to_le16
c_func
(paren
id|SecurityBlob-&gt;DomainName.Length
)paren
suffix:semicolon
id|SecurityBlob-&gt;DomainName.Buffer
op_assign
id|cpu_to_le32
c_func
(paren
id|SecurityBlobLength
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
id|SecurityBlob-&gt;DomainName.Length
suffix:semicolon
id|SecurityBlobLength
op_add_assign
id|SecurityBlob-&gt;DomainName.Length
suffix:semicolon
id|SecurityBlob-&gt;DomainName.Length
op_assign
id|cpu_to_le16
c_func
(paren
id|SecurityBlob-&gt;DomainName.Length
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|user
op_eq
l_int|NULL
)paren
(brace
id|SecurityBlob-&gt;UserName.Buffer
op_assign
l_int|0
suffix:semicolon
id|SecurityBlob-&gt;UserName.Length
op_assign
l_int|0
suffix:semicolon
id|SecurityBlob-&gt;UserName.MaximumLength
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|SecurityBlob-&gt;UserName.Length
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
id|user
comma
l_int|64
comma
id|nls_codepage
)paren
suffix:semicolon
id|SecurityBlob-&gt;UserName.Length
op_mul_assign
l_int|2
suffix:semicolon
id|SecurityBlob-&gt;UserName.MaximumLength
op_assign
id|cpu_to_le16
c_func
(paren
id|SecurityBlob-&gt;UserName.Length
)paren
suffix:semicolon
id|SecurityBlob-&gt;UserName.Buffer
op_assign
id|cpu_to_le32
c_func
(paren
id|SecurityBlobLength
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
id|SecurityBlob-&gt;UserName.Length
suffix:semicolon
id|SecurityBlobLength
op_add_assign
id|SecurityBlob-&gt;UserName.Length
suffix:semicolon
id|SecurityBlob-&gt;UserName.Length
op_assign
id|cpu_to_le16
c_func
(paren
id|SecurityBlob-&gt;UserName.Length
)paren
suffix:semicolon
)brace
multiline_comment|/* SecurityBlob-&gt;WorkstationName.Length = cifs_strtoUCS((wchar_t *) bcc_ptr, &quot;AMACHINE&quot;,64, nls_codepage);&n;&t;&t;   SecurityBlob-&gt;WorkstationName.Length *= 2;&n;&t;&t;   SecurityBlob-&gt;WorkstationName.MaximumLength = cpu_to_le16(SecurityBlob-&gt;WorkstationName.Length);&n;&t;&t;   SecurityBlob-&gt;WorkstationName.Buffer = cpu_to_le32(SecurityBlobLength);&n;&t;&t;   bcc_ptr += SecurityBlob-&gt;WorkstationName.Length;&n;&t;&t;   SecurityBlobLength += SecurityBlob-&gt;WorkstationName.Length;&n;&t;&t;   SecurityBlob-&gt;WorkstationName.Length = cpu_to_le16(SecurityBlob-&gt;WorkstationName.Length);  */
r_if
c_cond
(paren
(paren
r_int
)paren
id|bcc_ptr
op_mod
l_int|2
)paren
(brace
op_star
id|bcc_ptr
op_assign
l_int|0
suffix:semicolon
id|bcc_ptr
op_increment
suffix:semicolon
)brace
id|bytes_returned
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
l_string|&quot;Linux version &quot;
comma
l_int|32
comma
id|nls_codepage
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
op_star
id|bytes_returned
suffix:semicolon
id|bytes_returned
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
id|UTS_RELEASE
comma
l_int|32
comma
id|nls_codepage
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
op_star
id|bytes_returned
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
suffix:semicolon
multiline_comment|/* null term version string */
id|bytes_returned
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
id|CIFS_NETWORK_OPSYS
comma
l_int|64
comma
id|nls_codepage
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
op_star
id|bytes_returned
suffix:semicolon
op_star
(paren
id|bcc_ptr
op_plus
l_int|1
)paren
op_assign
l_int|0
suffix:semicolon
op_star
(paren
id|bcc_ptr
op_plus
l_int|2
)paren
op_assign
l_int|0
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
suffix:semicolon
multiline_comment|/* null terminate network opsys string */
op_star
(paren
id|bcc_ptr
op_plus
l_int|1
)paren
op_assign
l_int|0
suffix:semicolon
op_star
(paren
id|bcc_ptr
op_plus
l_int|2
)paren
op_assign
l_int|0
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
suffix:semicolon
multiline_comment|/* null domain */
)brace
r_else
(brace
multiline_comment|/* ASCII */
r_if
c_cond
(paren
id|domain
op_eq
l_int|NULL
)paren
(brace
id|SecurityBlob-&gt;DomainName.Buffer
op_assign
l_int|0
suffix:semicolon
id|SecurityBlob-&gt;DomainName.Length
op_assign
l_int|0
suffix:semicolon
id|SecurityBlob-&gt;DomainName.MaximumLength
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|SecurityBlob-&gt;NegotiateFlags
op_or_assign
id|NTLMSSP_NEGOTIATE_DOMAIN_SUPPLIED
suffix:semicolon
id|strncpy
c_func
(paren
id|bcc_ptr
comma
id|domain
comma
l_int|63
)paren
suffix:semicolon
id|SecurityBlob-&gt;DomainName.Length
op_assign
id|strnlen
c_func
(paren
id|domain
comma
l_int|64
)paren
suffix:semicolon
id|SecurityBlob-&gt;DomainName.MaximumLength
op_assign
id|cpu_to_le16
c_func
(paren
id|SecurityBlob-&gt;DomainName.Length
)paren
suffix:semicolon
id|SecurityBlob-&gt;DomainName.Buffer
op_assign
id|cpu_to_le32
c_func
(paren
id|SecurityBlobLength
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
id|SecurityBlob-&gt;DomainName.Length
suffix:semicolon
id|SecurityBlobLength
op_add_assign
id|SecurityBlob-&gt;DomainName.Length
suffix:semicolon
id|SecurityBlob-&gt;DomainName.Length
op_assign
id|cpu_to_le16
c_func
(paren
id|SecurityBlob-&gt;DomainName.Length
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|user
op_eq
l_int|NULL
)paren
(brace
id|SecurityBlob-&gt;UserName.Buffer
op_assign
l_int|0
suffix:semicolon
id|SecurityBlob-&gt;UserName.Length
op_assign
l_int|0
suffix:semicolon
id|SecurityBlob-&gt;UserName.MaximumLength
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
id|strncpy
c_func
(paren
id|bcc_ptr
comma
id|user
comma
l_int|63
)paren
suffix:semicolon
id|SecurityBlob-&gt;UserName.Length
op_assign
id|strnlen
c_func
(paren
id|user
comma
l_int|64
)paren
suffix:semicolon
id|SecurityBlob-&gt;UserName.MaximumLength
op_assign
id|cpu_to_le16
c_func
(paren
id|SecurityBlob-&gt;UserName.Length
)paren
suffix:semicolon
id|SecurityBlob-&gt;UserName.Buffer
op_assign
id|cpu_to_le32
c_func
(paren
id|SecurityBlobLength
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
id|SecurityBlob-&gt;UserName.Length
suffix:semicolon
id|SecurityBlobLength
op_add_assign
id|SecurityBlob-&gt;UserName.Length
suffix:semicolon
id|SecurityBlob-&gt;UserName.Length
op_assign
id|cpu_to_le16
c_func
(paren
id|SecurityBlob-&gt;UserName.Length
)paren
suffix:semicolon
)brace
multiline_comment|/* BB fill in our workstation name if known BB */
id|strcpy
c_func
(paren
id|bcc_ptr
comma
l_string|&quot;Linux version &quot;
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
id|strlen
c_func
(paren
l_string|&quot;Linux version &quot;
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|bcc_ptr
comma
id|UTS_RELEASE
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
id|strlen
c_func
(paren
id|UTS_RELEASE
)paren
op_plus
l_int|1
suffix:semicolon
id|strcpy
c_func
(paren
id|bcc_ptr
comma
id|CIFS_NETWORK_OPSYS
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
id|strlen
c_func
(paren
id|CIFS_NETWORK_OPSYS
)paren
op_plus
l_int|1
suffix:semicolon
id|bcc_ptr
op_increment
suffix:semicolon
multiline_comment|/* null domain */
op_star
id|bcc_ptr
op_assign
l_int|0
suffix:semicolon
)brace
id|SecurityBlob-&gt;NegotiateFlags
op_assign
id|cpu_to_le32
c_func
(paren
id|SecurityBlob-&gt;NegotiateFlags
)paren
suffix:semicolon
id|pSMB-&gt;req.SecurityBlobLength
op_assign
id|cpu_to_le16
c_func
(paren
id|SecurityBlobLength
)paren
suffix:semicolon
id|BCC
c_func
(paren
id|smb_buffer
)paren
op_assign
(paren
r_int
)paren
id|bcc_ptr
op_minus
(paren
r_int
)paren
id|pByteArea
c_func
(paren
id|smb_buffer
)paren
suffix:semicolon
id|smb_buffer-&gt;smb_buf_length
op_add_assign
id|BCC
c_func
(paren
id|smb_buffer
)paren
suffix:semicolon
id|BCC
c_func
(paren
id|smb_buffer
)paren
op_assign
id|cpu_to_le16
c_func
(paren
id|BCC
c_func
(paren
id|smb_buffer
)paren
)paren
suffix:semicolon
id|rc
op_assign
id|SendReceive
c_func
(paren
id|xid
comma
id|ses
comma
id|smb_buffer
comma
id|smb_buffer_response
comma
op_amp
id|bytes_returned
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
)paren
(brace
multiline_comment|/*    rc = map_smb_to_linux_error(smb_buffer_response);  */
multiline_comment|/* done in SendReceive now */
)brace
r_else
r_if
c_cond
(paren
(paren
id|smb_buffer_response-&gt;WordCount
op_eq
l_int|3
)paren
op_logical_or
(paren
id|smb_buffer_response-&gt;WordCount
op_eq
l_int|4
)paren
)paren
(brace
id|pSMBr-&gt;resp.Action
op_assign
id|le16_to_cpu
c_func
(paren
id|pSMBr-&gt;resp.Action
)paren
suffix:semicolon
id|pSMBr-&gt;resp.SecurityBlobLength
op_assign
id|le16_to_cpu
c_func
(paren
id|pSMBr-&gt;resp.SecurityBlobLength
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pSMBr-&gt;resp.Action
op_amp
id|GUEST_LOGIN
)paren
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot; Guest login&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* BB do we want to set anything in SesInfo struct ? */
multiline_comment|/*        if(SecurityBlob2-&gt;MessageType != NtLm??){                               &n;                 cFYI(&quot;&bslash;nUnexpected message type on auth response is %d &quot;)); &n;        } */
r_if
c_cond
(paren
id|ses
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Does UID on challenge %d match auth response UID %d &quot;
comma
id|ses-&gt;Suid
comma
id|smb_buffer_response-&gt;Uid
)paren
)paren
suffix:semicolon
id|ses-&gt;Suid
op_assign
id|smb_buffer_response-&gt;Uid
suffix:semicolon
multiline_comment|/* UID left in wire format */
id|bcc_ptr
op_assign
id|pByteArea
c_func
(paren
id|smb_buffer_response
)paren
suffix:semicolon
multiline_comment|/* response can have either 3 or 4 word count - Samba sends 3 */
r_if
c_cond
(paren
(paren
id|pSMBr-&gt;resp.hdr.WordCount
op_eq
l_int|3
)paren
op_logical_or
(paren
(paren
id|pSMBr-&gt;resp.hdr.WordCount
op_eq
l_int|4
)paren
op_logical_and
(paren
id|pSMBr-&gt;resp.SecurityBlobLength
OL
id|pSMBr-&gt;resp.ByteCount
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|pSMBr-&gt;resp.hdr.WordCount
op_eq
l_int|4
)paren
(brace
id|bcc_ptr
op_add_assign
id|pSMBr-&gt;resp.SecurityBlobLength
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;&bslash;nSecurity Blob Length %d &quot;
comma
id|pSMBr-&gt;resp.SecurityBlobLength
)paren
)paren
suffix:semicolon
)brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;&bslash;nNTLMSSP response to Authenticate &quot;
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|smb_buffer-&gt;Flags2
op_and_assign
id|SMBFLG2_UNICODE
)paren
(brace
r_if
c_cond
(paren
(paren
r_int
)paren
(paren
id|bcc_ptr
)paren
op_mod
l_int|2
)paren
(brace
id|remaining_words
op_assign
(paren
id|BCC
c_func
(paren
id|smb_buffer_response
)paren
op_minus
l_int|1
)paren
op_div
l_int|2
suffix:semicolon
id|bcc_ptr
op_increment
suffix:semicolon
multiline_comment|/* Unicode strings must be word aligned */
)brace
r_else
(brace
id|remaining_words
op_assign
id|BCC
c_func
(paren
id|smb_buffer_response
)paren
op_div
l_int|2
suffix:semicolon
)brace
id|len
op_assign
id|UniStrnlen
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
id|remaining_words
op_minus
l_int|1
)paren
suffix:semicolon
multiline_comment|/* We look for obvious messed up bcc or strings in response so we do not go off&n;  the end since (at least) WIN2K and Windows XP have a major bug in not null&n;  terminating last Unicode string in response  */
id|ses-&gt;serverOS
op_assign
id|kcalloc
c_func
(paren
l_int|2
op_star
(paren
id|len
op_plus
l_int|1
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|cifs_strfromUCS_le
c_func
(paren
id|ses-&gt;serverOS
comma
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
id|len
comma
id|nls_codepage
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
op_star
(paren
id|len
op_plus
l_int|1
)paren
suffix:semicolon
id|remaining_words
op_sub_assign
id|len
op_plus
l_int|1
suffix:semicolon
id|ses-&gt;serverOS
(braket
l_int|2
op_star
id|len
)braket
op_assign
l_int|0
suffix:semicolon
id|ses-&gt;serverOS
(braket
l_int|1
op_plus
(paren
l_int|2
op_star
id|len
)paren
)braket
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|remaining_words
OG
l_int|0
)paren
(brace
id|len
op_assign
id|UniStrnlen
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
id|remaining_words
op_minus
l_int|1
)paren
suffix:semicolon
id|ses-&gt;serverNOS
op_assign
id|kcalloc
c_func
(paren
l_int|2
op_star
(paren
id|len
op_plus
l_int|1
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|cifs_strfromUCS_le
c_func
(paren
id|ses
op_member_access_from_pointer
id|serverNOS
comma
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
id|len
comma
id|nls_codepage
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
op_star
(paren
id|len
op_plus
l_int|1
)paren
suffix:semicolon
id|ses-&gt;serverNOS
(braket
l_int|2
op_star
id|len
)braket
op_assign
l_int|0
suffix:semicolon
id|ses-&gt;serverNOS
(braket
l_int|1
op_plus
(paren
l_int|2
op_star
id|len
)paren
)braket
op_assign
l_int|0
suffix:semicolon
id|remaining_words
op_sub_assign
id|len
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|remaining_words
OG
l_int|0
)paren
(brace
id|len
op_assign
id|UniStrnlen
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
id|remaining_words
)paren
suffix:semicolon
multiline_comment|/* last string not always null terminated (e.g. for Windows XP &amp; 2000) */
id|ses-&gt;serverDomain
op_assign
id|kcalloc
c_func
(paren
l_int|2
op_star
(paren
id|len
op_plus
l_int|1
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|cifs_strfromUCS_le
(paren
id|ses
op_member_access_from_pointer
id|serverDomain
comma
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
id|len
comma
id|nls_codepage
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
op_star
(paren
id|len
op_plus
l_int|1
)paren
suffix:semicolon
id|ses
op_member_access_from_pointer
id|serverDomain
(braket
l_int|2
op_star
id|len
)braket
op_assign
l_int|0
suffix:semicolon
id|ses
op_member_access_from_pointer
id|serverDomain
(braket
l_int|1
op_plus
(paren
l_int|2
op_star
id|len
)paren
)braket
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/* else no more room so create dummy domain string */
r_else
id|ses-&gt;serverDomain
op_assign
id|kcalloc
c_func
(paren
l_int|2
comma
id|GFP_KERNEL
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/* no room so create dummy domain and NOS string */
id|ses-&gt;serverDomain
op_assign
id|kcalloc
c_func
(paren
l_int|2
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|ses-&gt;serverNOS
op_assign
id|kcalloc
c_func
(paren
l_int|2
comma
id|GFP_KERNEL
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
multiline_comment|/* ASCII */
id|len
op_assign
id|strnlen
c_func
(paren
id|bcc_ptr
comma
l_int|1024
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
r_int
)paren
id|bcc_ptr
op_plus
id|len
)paren
op_minus
(paren
r_int
)paren
id|pByteArea
c_func
(paren
id|smb_buffer_response
)paren
op_le
id|BCC
c_func
(paren
id|smb_buffer_response
)paren
)paren
(brace
id|ses-&gt;serverOS
op_assign
id|kcalloc
c_func
(paren
id|len
op_plus
l_int|1
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|ses-&gt;serverOS
comma
id|bcc_ptr
comma
id|len
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
id|len
suffix:semicolon
id|bcc_ptr
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* null terminate the string */
id|bcc_ptr
op_increment
suffix:semicolon
id|len
op_assign
id|strnlen
c_func
(paren
id|bcc_ptr
comma
l_int|1024
)paren
suffix:semicolon
id|ses-&gt;serverNOS
op_assign
id|kcalloc
c_func
(paren
id|len
op_plus
l_int|1
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|ses-&gt;serverNOS
comma
id|bcc_ptr
comma
id|len
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
id|len
suffix:semicolon
id|bcc_ptr
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|bcc_ptr
op_increment
suffix:semicolon
id|len
op_assign
id|strnlen
c_func
(paren
id|bcc_ptr
comma
l_int|1024
)paren
suffix:semicolon
id|ses-&gt;serverDomain
op_assign
id|kcalloc
c_func
(paren
id|len
op_plus
l_int|1
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|ses-&gt;serverDomain
comma
id|bcc_ptr
comma
id|len
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
id|len
suffix:semicolon
id|bcc_ptr
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
id|bcc_ptr
op_increment
suffix:semicolon
)brace
r_else
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Variable field of length %d extends beyond end of smb &quot;
comma
id|len
)paren
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|cERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot; Security Blob Length extends beyond end of SMB&quot;
)paren
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|cERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;No session structure passed in.&quot;
)paren
)paren
suffix:semicolon
)brace
)brace
r_else
(brace
id|cERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot; Invalid Word count %d: &quot;
comma
id|smb_buffer_response-&gt;WordCount
)paren
)paren
suffix:semicolon
id|rc
op_assign
op_minus
id|EIO
suffix:semicolon
)brace
r_if
c_cond
(paren
id|smb_buffer
)paren
id|buf_release
c_func
(paren
id|smb_buffer
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_int
DECL|function|CIFSTCon
id|CIFSTCon
c_func
(paren
r_int
r_int
id|xid
comma
r_struct
id|cifsSesInfo
op_star
id|ses
comma
r_const
r_char
op_star
id|tree
comma
r_struct
id|cifsTconInfo
op_star
id|tcon
comma
r_const
r_struct
id|nls_table
op_star
id|nls_codepage
)paren
(brace
r_struct
id|smb_hdr
op_star
id|smb_buffer
suffix:semicolon
r_struct
id|smb_hdr
op_star
id|smb_buffer_response
suffix:semicolon
id|TCONX_REQ
op_star
id|pSMB
suffix:semicolon
id|TCONX_RSP
op_star
id|pSMBr
suffix:semicolon
r_char
op_star
id|bcc_ptr
suffix:semicolon
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|length
suffix:semicolon
r_if
c_cond
(paren
id|ses
op_eq
l_int|NULL
)paren
r_return
op_minus
id|EIO
suffix:semicolon
id|smb_buffer
op_assign
id|buf_get
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|smb_buffer
op_eq
l_int|0
)paren
(brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|smb_buffer_response
op_assign
id|smb_buffer
suffix:semicolon
id|header_assemble
c_func
(paren
id|smb_buffer
comma
id|SMB_COM_TREE_CONNECT_ANDX
comma
l_int|0
multiline_comment|/*no tid */
comma
l_int|4
multiline_comment|/*wct */
)paren
suffix:semicolon
id|smb_buffer-&gt;Uid
op_assign
id|ses-&gt;Suid
suffix:semicolon
id|pSMB
op_assign
(paren
id|TCONX_REQ
op_star
)paren
id|smb_buffer
suffix:semicolon
id|pSMBr
op_assign
(paren
id|TCONX_RSP
op_star
)paren
id|smb_buffer_response
suffix:semicolon
id|pSMB-&gt;AndXCommand
op_assign
l_int|0xFF
suffix:semicolon
id|pSMB-&gt;Flags
op_assign
id|cpu_to_le16
c_func
(paren
id|TCON_EXTENDED_SECINFO
)paren
suffix:semicolon
id|pSMB-&gt;PasswordLength
op_assign
id|cpu_to_le16
c_func
(paren
l_int|1
)paren
suffix:semicolon
multiline_comment|/* minimum */
id|bcc_ptr
op_assign
op_amp
(paren
id|pSMB-&gt;Password
(braket
l_int|0
)braket
)paren
suffix:semicolon
id|bcc_ptr
op_increment
suffix:semicolon
multiline_comment|/* skip password */
r_if
c_cond
(paren
id|ses-&gt;secMode
op_amp
(paren
id|SECMODE_SIGN_REQUIRED
op_or
id|SECMODE_SIGN_ENABLED
)paren
)paren
(brace
id|smb_buffer-&gt;Flags2
op_or_assign
id|SMBFLG2_SECURITY_SIGNATURE
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ses-&gt;capabilities
op_amp
id|CAP_STATUS32
)paren
(brace
id|smb_buffer-&gt;Flags2
op_or_assign
id|SMBFLG2_ERR_STATUS
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ses-&gt;capabilities
op_amp
id|CAP_DFS
)paren
(brace
id|smb_buffer-&gt;Flags2
op_or_assign
id|SMBFLG2_DFS
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ses-&gt;capabilities
op_amp
id|CAP_UNICODE
)paren
(brace
id|smb_buffer-&gt;Flags2
op_or_assign
id|SMBFLG2_UNICODE
suffix:semicolon
id|length
op_assign
id|cifs_strtoUCS
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
id|tree
comma
l_int|100
comma
id|nls_codepage
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
op_star
id|length
suffix:semicolon
multiline_comment|/* convert num of 16 bit words to bytes */
id|bcc_ptr
op_add_assign
l_int|2
suffix:semicolon
multiline_comment|/* skip trailing null */
)brace
r_else
(brace
multiline_comment|/* ASCII */
id|strcpy
c_func
(paren
id|bcc_ptr
comma
id|tree
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
id|strlen
c_func
(paren
id|tree
)paren
op_plus
l_int|1
suffix:semicolon
)brace
id|strcpy
c_func
(paren
id|bcc_ptr
comma
l_string|&quot;?????&quot;
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
id|strlen
c_func
(paren
l_string|&quot;?????&quot;
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|1
suffix:semicolon
id|BCC
c_func
(paren
id|smb_buffer
)paren
op_assign
(paren
r_int
)paren
id|bcc_ptr
op_minus
(paren
r_int
)paren
id|pByteArea
c_func
(paren
id|smb_buffer
)paren
suffix:semicolon
id|smb_buffer-&gt;smb_buf_length
op_add_assign
id|BCC
c_func
(paren
id|smb_buffer
)paren
suffix:semicolon
id|BCC
c_func
(paren
id|smb_buffer
)paren
op_assign
id|cpu_to_le16
c_func
(paren
id|BCC
c_func
(paren
id|smb_buffer
)paren
)paren
suffix:semicolon
id|rc
op_assign
id|SendReceive
c_func
(paren
id|xid
comma
id|ses
comma
id|smb_buffer
comma
id|smb_buffer_response
comma
op_amp
id|length
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* if (rc) rc = map_smb_to_linux_error(smb_buffer_response); */
multiline_comment|/* above now done in SendReceive */
r_if
c_cond
(paren
(paren
id|rc
op_eq
l_int|0
)paren
op_logical_and
(paren
id|tcon
op_ne
l_int|NULL
)paren
)paren
(brace
id|tcon-&gt;tid
op_assign
id|smb_buffer_response-&gt;Tid
suffix:semicolon
id|bcc_ptr
op_assign
id|pByteArea
c_func
(paren
id|smb_buffer_response
)paren
suffix:semicolon
id|length
op_assign
id|strnlen
c_func
(paren
id|bcc_ptr
comma
id|BCC
c_func
(paren
id|smb_buffer_response
)paren
op_minus
l_int|2
)paren
suffix:semicolon
multiline_comment|/* skip service field (NB: this field is always ASCII) */
id|bcc_ptr
op_add_assign
id|length
op_plus
l_int|1
suffix:semicolon
id|strncpy
c_func
(paren
id|tcon-&gt;treeName
comma
id|tree
comma
id|MAX_TREE_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|smb_buffer-&gt;Flags2
op_and_assign
id|SMBFLG2_UNICODE
)paren
(brace
id|length
op_assign
id|UniStrnlen
c_func
(paren
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
l_int|512
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
r_int
)paren
id|bcc_ptr
op_plus
(paren
l_int|2
op_star
id|length
)paren
)paren
op_minus
(paren
r_int
)paren
id|pByteArea
c_func
(paren
id|smb_buffer_response
)paren
op_le
id|BCC
c_func
(paren
id|smb_buffer_response
)paren
)paren
(brace
id|tcon-&gt;nativeFileSystem
op_assign
id|kcalloc
c_func
(paren
id|length
op_plus
l_int|2
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|cifs_strfromUCS_le
c_func
(paren
id|tcon-&gt;nativeFileSystem
comma
(paren
m_wchar_t
op_star
)paren
id|bcc_ptr
comma
id|length
comma
id|nls_codepage
)paren
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
op_star
id|length
suffix:semicolon
id|bcc_ptr
(braket
l_int|0
)braket
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* null terminate the string */
id|bcc_ptr
(braket
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|bcc_ptr
op_add_assign
l_int|2
suffix:semicolon
)brace
multiline_comment|/* else do not bother copying these informational fields */
)brace
r_else
(brace
id|length
op_assign
id|strnlen
c_func
(paren
id|bcc_ptr
comma
l_int|1024
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
(paren
r_int
)paren
id|bcc_ptr
op_plus
id|length
)paren
op_minus
(paren
r_int
)paren
id|pByteArea
c_func
(paren
id|smb_buffer_response
)paren
op_le
id|BCC
c_func
(paren
id|smb_buffer_response
)paren
)paren
(brace
id|tcon-&gt;nativeFileSystem
op_assign
id|kcalloc
c_func
(paren
id|length
op_plus
l_int|1
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|strncpy
c_func
(paren
id|tcon-&gt;nativeFileSystem
comma
id|bcc_ptr
comma
id|length
)paren
suffix:semicolon
)brace
multiline_comment|/* else do not bother copying these informational fields */
)brace
id|tcon-&gt;Flags
op_assign
id|le16_to_cpu
c_func
(paren
id|pSMBr-&gt;OptionalSupport
)paren
suffix:semicolon
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;&bslash;nTcon flags: 0x%x &quot;
comma
id|tcon-&gt;Flags
)paren
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|rc
op_eq
l_int|0
)paren
op_logical_and
id|tcon
op_eq
l_int|NULL
)paren
(brace
multiline_comment|/* all we need to save for IPC$ connection */
id|ses-&gt;ipc_tid
op_assign
id|smb_buffer_response-&gt;Tid
suffix:semicolon
)brace
r_if
c_cond
(paren
id|smb_buffer
)paren
id|buf_release
c_func
(paren
id|smb_buffer
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
r_int
DECL|function|cifs_umount
id|cifs_umount
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|cifs_sb_info
op_star
id|cifs_sb
)paren
(brace
r_int
id|rc
op_assign
l_int|0
suffix:semicolon
r_int
id|xid
suffix:semicolon
r_struct
id|cifsSesInfo
op_star
id|ses
op_assign
l_int|NULL
suffix:semicolon
id|xid
op_assign
id|GetXid
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cifs_sb-&gt;tcon
)paren
(brace
id|ses
op_assign
id|cifs_sb-&gt;tcon-&gt;ses
suffix:semicolon
multiline_comment|/* save ptr to ses before delete tcon!*/
id|rc
op_assign
id|CIFSSMBTDis
c_func
(paren
id|xid
comma
id|cifs_sb-&gt;tcon
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
op_minus
id|EBUSY
)paren
(brace
id|FreeXid
c_func
(paren
id|xid
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|tconInfoFree
c_func
(paren
id|cifs_sb-&gt;tcon
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ses
)paren
op_logical_and
(paren
id|ses-&gt;server
)paren
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;&bslash;nAbout to do SMBLogoff &quot;
)paren
)paren
suffix:semicolon
id|rc
op_assign
id|CIFSSMBLogoff
c_func
(paren
id|xid
comma
id|ses
)paren
suffix:semicolon
r_if
c_cond
(paren
id|rc
op_eq
op_minus
id|EBUSY
)paren
(brace
multiline_comment|/* BB this looks wrong - why is this here? */
id|FreeXid
c_func
(paren
id|xid
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|schedule_timeout
c_func
(paren
id|HZ
op_div
l_int|4
)paren
suffix:semicolon
multiline_comment|/* give captive thread time to exit */
r_if
c_cond
(paren
(paren
id|ses-&gt;server
)paren
op_logical_and
(paren
id|ses-&gt;server-&gt;ssocket
)paren
)paren
(brace
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;&bslash;nWaking up socket by sending it signal &quot;
)paren
)paren
suffix:semicolon
id|send_sig
c_func
(paren
id|SIGINT
comma
id|ses-&gt;server-&gt;tsk
comma
l_int|1
)paren
suffix:semicolon
)brace
)brace
r_else
id|cFYI
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;&bslash;nNo session or bad tcon&quot;
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* BB future check active count of tcon and then free if needed BB */
id|cifs_sb-&gt;tcon
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|ses
)paren
(brace
id|schedule_timeout
c_func
(paren
id|HZ
op_div
l_int|2
)paren
suffix:semicolon
multiline_comment|/* if ((ses-&gt;server) &amp;&amp; (ses-&gt;server-&gt;ssocket)) {&n;               cFYI(1,(&quot;&bslash;nReleasing socket &quot;));        &n;               sock_release(ses-&gt;server-&gt;ssocket); &n;               kfree(ses-&gt;server); &n;          } */
)brace
r_if
c_cond
(paren
id|ses
)paren
id|sesInfoFree
c_func
(paren
id|ses
)paren
suffix:semicolon
id|FreeXid
c_func
(paren
id|xid
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
multiline_comment|/* BB check if we should always return zero here */
)brace
eof
