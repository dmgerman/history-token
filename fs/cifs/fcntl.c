multiline_comment|/*&n; *   fs/cifs/fcntl.c&n; *&n; *   vfs operations that deal with the file control API&n; * &n; *   Copyright (C) International Business Machines  Corp., 2003,2004&n; *   Author(s): Steve French (sfrench@us.ibm.com)&n; *&n; *   This library is free software; you can redistribute it and/or modify&n; *   it under the terms of the GNU Lesser General Public License as published&n; *   by the Free Software Foundation; either version 2.1 of the License, or&n; *   (at your option) any later version.&n; *&n; *   This library is distributed in the hope that it will be useful,&n; *   but WITHOUT ANY WARRANTY; without even the implied warranty of&n; *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See&n; *   the GNU Lesser General Public License for more details.&n; *&n; *   You should have received a copy of the GNU Lesser General Public License&n; *   along with this library; if not, write to the Free Software&n; *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA&n; */
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &quot;cifsglob.h&quot;
macro_line|#include &quot;cifsproto.h&quot;
macro_line|#include &quot;cifs_unicode.h&quot;
macro_line|#include &quot;cifs_debug.h&quot;
macro_line|#include &quot;cifsfs.h&quot;
DECL|function|convert_to_cifs_notify_flags
r_static
id|__u32
id|convert_to_cifs_notify_flags
c_func
(paren
r_int
r_int
id|fcntl_notify_flags
)paren
(brace
id|__u32
id|cifs_ntfy_flags
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* No way on Linux VFS to ask to monitor xattr&n;&t;changes (and no stream support either */
r_if
c_cond
(paren
id|fcntl_notify_flags
op_amp
id|DN_ACCESS
)paren
(brace
id|cifs_ntfy_flags
op_or_assign
id|FILE_NOTIFY_CHANGE_LAST_ACCESS
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fcntl_notify_flags
op_amp
id|DN_MODIFY
)paren
(brace
multiline_comment|/* What does this mean on directories? */
id|cifs_ntfy_flags
op_or_assign
id|FILE_NOTIFY_CHANGE_LAST_WRITE
op_or
id|FILE_NOTIFY_CHANGE_SIZE
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fcntl_notify_flags
op_amp
id|DN_CREATE
)paren
(brace
id|cifs_ntfy_flags
op_or_assign
id|FILE_NOTIFY_CHANGE_CREATION
op_or
id|FILE_NOTIFY_CHANGE_LAST_WRITE
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fcntl_notify_flags
op_amp
id|DN_DELETE
)paren
(brace
id|cifs_ntfy_flags
op_or_assign
id|FILE_NOTIFY_CHANGE_LAST_WRITE
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fcntl_notify_flags
op_amp
id|DN_RENAME
)paren
(brace
multiline_comment|/* BB review this - checking various server behaviors */
id|cifs_ntfy_flags
op_or_assign
id|FILE_NOTIFY_CHANGE_DIR_NAME
op_or
id|FILE_NOTIFY_CHANGE_FILE_NAME
suffix:semicolon
)brace
r_if
c_cond
(paren
id|fcntl_notify_flags
op_amp
id|DN_ATTRIB
)paren
(brace
id|cifs_ntfy_flags
op_or_assign
id|FILE_NOTIFY_CHANGE_SECURITY
op_or
id|FILE_NOTIFY_CHANGE_ATTRIBUTES
suffix:semicolon
)brace
multiline_comment|/*&t;if(fcntl_notify_flags &amp; DN_MULTISHOT) {&n;&t;&t;cifs_ntfy_flags |= ;&n;&t;} */
multiline_comment|/* BB fixme - not sure how to handle this with CIFS yet */
r_return
id|cifs_ntfy_flags
suffix:semicolon
)brace
DECL|function|cifs_dir_notify
r_int
id|cifs_dir_notify
c_func
(paren
r_struct
id|file
op_star
id|file
comma
r_int
r_int
id|arg
)paren
(brace
r_int
id|xid
suffix:semicolon
r_int
id|rc
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_int
id|oplock
op_assign
id|FALSE
suffix:semicolon
r_struct
id|cifs_sb_info
op_star
id|cifs_sb
suffix:semicolon
r_struct
id|cifsTconInfo
op_star
id|pTcon
suffix:semicolon
r_char
op_star
id|full_path
op_assign
l_int|NULL
suffix:semicolon
id|__u32
id|filter
op_assign
id|FILE_NOTIFY_CHANGE_NAME
op_or
id|FILE_NOTIFY_CHANGE_ATTRIBUTES
suffix:semicolon
id|__u16
id|netfid
suffix:semicolon
id|xid
op_assign
id|GetXid
c_func
(paren
)paren
suffix:semicolon
id|cifs_sb
op_assign
id|CIFS_SB
c_func
(paren
id|file-&gt;f_dentry-&gt;d_sb
)paren
suffix:semicolon
id|pTcon
op_assign
id|cifs_sb-&gt;tcon
suffix:semicolon
id|down
c_func
(paren
op_amp
id|file-&gt;f_dentry-&gt;d_sb-&gt;s_vfs_rename_sem
)paren
suffix:semicolon
id|full_path
op_assign
id|build_path_from_dentry
c_func
(paren
id|file-&gt;f_dentry
)paren
suffix:semicolon
id|up
c_func
(paren
op_amp
id|file-&gt;f_dentry-&gt;d_sb-&gt;s_vfs_rename_sem
)paren
suffix:semicolon
r_if
c_cond
(paren
id|full_path
op_eq
l_int|NULL
)paren
(brace
id|rc
op_assign
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_else
(brace
id|cERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;cifs dir notify on file %s with arg 0x%lx&quot;
comma
id|full_path
comma
id|arg
)paren
)paren
suffix:semicolon
multiline_comment|/* BB removeme BB */
id|rc
op_assign
id|CIFSSMBOpen
c_func
(paren
id|xid
comma
id|pTcon
comma
id|full_path
comma
id|FILE_OPEN
comma
id|GENERIC_READ
op_or
id|SYNCHRONIZE
comma
l_int|0
multiline_comment|/* create options */
comma
op_amp
id|netfid
comma
op_amp
id|oplock
comma
l_int|NULL
comma
id|cifs_sb-&gt;local_nls
)paren
suffix:semicolon
multiline_comment|/* BB fixme - add this handle to a notify handle list */
r_if
c_cond
(paren
id|rc
)paren
(brace
id|cERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;Could not open directory for notify&quot;
)paren
)paren
suffix:semicolon
multiline_comment|/* BB remove BB */
)brace
r_else
(brace
id|filter
op_assign
id|convert_to_cifs_notify_flags
c_func
(paren
id|arg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|filter
op_ne
l_int|0
)paren
(brace
id|rc
op_assign
id|CIFSSMBNotify
c_func
(paren
id|xid
comma
id|pTcon
comma
l_int|0
multiline_comment|/* no subdirs */
comma
id|netfid
comma
id|filter
comma
id|cifs_sb-&gt;local_nls
)paren
suffix:semicolon
)brace
r_else
(brace
id|rc
op_assign
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* BB add code to close file eventually (at unmount&n;&t;&t;&t;it would close automatically but may be a way&n;&t;&t;&t;to do it easily when inode freed or when&n;&t;&t;&t;notify info is cleared/changed */
id|cERROR
c_func
(paren
l_int|1
comma
(paren
l_string|&quot;notify rc %d&quot;
comma
id|rc
)paren
)paren
suffix:semicolon
)brace
)brace
id|FreeXid
c_func
(paren
id|xid
)paren
suffix:semicolon
r_return
id|rc
suffix:semicolon
)brace
eof
