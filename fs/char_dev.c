multiline_comment|/*&n; *  linux/fs/char_dev.c&n; *&n; *  Copyright (C) 1991, 1992  Linus Torvalds&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/major.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/devfs_fs_kernel.h&gt;
macro_line|#ifdef CONFIG_KMOD
macro_line|#include &lt;linux/kmod.h&gt;
macro_line|#endif
DECL|macro|MAX_PROBE_HASH
mdefine_line|#define MAX_PROBE_HASH 255&t;/* random */
DECL|variable|chrdevs_lock
r_static
id|rwlock_t
id|chrdevs_lock
op_assign
id|RW_LOCK_UNLOCKED
suffix:semicolon
DECL|struct|char_device_struct
r_static
r_struct
id|char_device_struct
(brace
DECL|member|next
r_struct
id|char_device_struct
op_star
id|next
suffix:semicolon
DECL|member|major
r_int
r_int
id|major
suffix:semicolon
DECL|member|baseminor
r_int
r_int
id|baseminor
suffix:semicolon
DECL|member|minorct
r_int
id|minorct
suffix:semicolon
DECL|member|name
r_const
r_char
op_star
id|name
suffix:semicolon
DECL|member|fops
r_struct
id|file_operations
op_star
id|fops
suffix:semicolon
DECL|variable|chrdevs
)brace
op_star
id|chrdevs
(braket
id|MAX_PROBE_HASH
)braket
suffix:semicolon
multiline_comment|/* index in the above */
DECL|function|major_to_index
r_static
r_inline
r_int
id|major_to_index
c_func
(paren
r_int
id|major
)paren
(brace
r_return
id|major
op_mod
id|MAX_PROBE_HASH
suffix:semicolon
)brace
multiline_comment|/* get char device names in somewhat random order */
DECL|function|get_chrdev_list
r_int
id|get_chrdev_list
c_func
(paren
r_char
op_star
id|page
)paren
(brace
r_struct
id|char_device_struct
op_star
id|cd
suffix:semicolon
r_int
id|i
comma
id|len
suffix:semicolon
id|len
op_assign
id|sprintf
c_func
(paren
id|page
comma
l_string|&quot;Character devices:&bslash;n&quot;
)paren
suffix:semicolon
id|read_lock
c_func
(paren
op_amp
id|chrdevs_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ARRAY_SIZE
c_func
(paren
id|chrdevs
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_for
c_loop
(paren
id|cd
op_assign
id|chrdevs
(braket
id|i
)braket
suffix:semicolon
id|cd
suffix:semicolon
id|cd
op_assign
id|cd-&gt;next
)paren
id|len
op_add_assign
id|sprintf
c_func
(paren
id|page
op_plus
id|len
comma
l_string|&quot;%3d %s&bslash;n&quot;
comma
id|cd-&gt;major
comma
id|cd-&gt;name
)paren
suffix:semicolon
)brace
id|read_unlock
c_func
(paren
op_amp
id|chrdevs_lock
)paren
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
multiline_comment|/*&n; * Return the function table of a device, if present.&n; * Increment the reference count of module in question.&n; */
r_static
r_struct
id|file_operations
op_star
DECL|function|lookup_chrfops
id|lookup_chrfops
c_func
(paren
r_int
r_int
id|major
comma
r_int
r_int
id|minor
)paren
(brace
r_struct
id|char_device_struct
op_star
id|cd
suffix:semicolon
r_struct
id|file_operations
op_star
id|ret
op_assign
l_int|NULL
suffix:semicolon
r_int
id|i
suffix:semicolon
id|i
op_assign
id|major_to_index
c_func
(paren
id|major
)paren
suffix:semicolon
id|read_lock
c_func
(paren
op_amp
id|chrdevs_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|cd
op_assign
id|chrdevs
(braket
id|i
)braket
suffix:semicolon
id|cd
suffix:semicolon
id|cd
op_assign
id|cd-&gt;next
)paren
(brace
r_if
c_cond
(paren
id|major
op_eq
id|cd-&gt;major
op_logical_and
id|minor
op_minus
id|cd-&gt;baseminor
OL
id|cd-&gt;minorct
)paren
(brace
id|ret
op_assign
id|fops_get
c_func
(paren
id|cd-&gt;fops
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|read_unlock
c_func
(paren
op_amp
id|chrdevs_lock
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n; * Return the function table of a device, if present.&n; * Load the driver if needed.&n; * Increment the reference count of module in question.&n; */
r_static
r_struct
id|file_operations
op_star
DECL|function|get_chrfops
id|get_chrfops
c_func
(paren
r_int
r_int
id|major
comma
r_int
r_int
id|minor
)paren
(brace
r_struct
id|file_operations
op_star
id|ret
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|major
)paren
r_return
l_int|NULL
suffix:semicolon
id|ret
op_assign
id|lookup_chrfops
c_func
(paren
id|major
comma
id|minor
)paren
suffix:semicolon
macro_line|#ifdef CONFIG_KMOD
r_if
c_cond
(paren
op_logical_neg
id|ret
)paren
(brace
id|request_module
c_func
(paren
l_string|&quot;char-major-%d&quot;
comma
id|major
)paren
suffix:semicolon
id|read_lock
c_func
(paren
op_amp
id|chrdevs_lock
)paren
suffix:semicolon
id|ret
op_assign
id|lookup_chrfops
c_func
(paren
id|major
comma
id|minor
)paren
suffix:semicolon
id|read_unlock
c_func
(paren
op_amp
id|chrdevs_lock
)paren
suffix:semicolon
)brace
macro_line|#endif
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n; * Register a single major with a specified minor range.&n; *&n; * If major == 0 this functions will dynamically allocate a major and return&n; * its number.&n; *&n; * If major &gt; 0 this function will attempt to reserve the passed range of&n; * minors and will return zero on success.&n; *&n; * Returns a -ve errno on failure.&n; */
DECL|function|register_chrdev_region
r_int
id|register_chrdev_region
c_func
(paren
r_int
r_int
id|major
comma
r_int
r_int
id|baseminor
comma
r_int
id|minorct
comma
r_const
r_char
op_star
id|name
comma
r_struct
id|file_operations
op_star
id|fops
)paren
(brace
r_struct
id|char_device_struct
op_star
id|cd
comma
op_star
op_star
id|cp
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
id|cd
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|char_device_struct
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cd
op_eq
l_int|NULL
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|write_lock_irq
c_func
(paren
op_amp
id|chrdevs_lock
)paren
suffix:semicolon
multiline_comment|/* temporary */
r_if
c_cond
(paren
id|major
op_eq
l_int|0
)paren
(brace
r_for
c_loop
(paren
id|i
op_assign
id|ARRAY_SIZE
c_func
(paren
id|chrdevs
)paren
op_minus
l_int|1
suffix:semicolon
id|i
OG
l_int|0
suffix:semicolon
id|i
op_decrement
)paren
(brace
r_if
c_cond
(paren
id|chrdevs
(braket
id|i
)braket
op_eq
l_int|NULL
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|i
op_eq
l_int|0
)paren
(brace
id|ret
op_assign
op_minus
id|EBUSY
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|major
op_assign
id|i
suffix:semicolon
id|ret
op_assign
id|major
suffix:semicolon
)brace
id|cd-&gt;major
op_assign
id|major
suffix:semicolon
id|cd-&gt;baseminor
op_assign
id|baseminor
suffix:semicolon
id|cd-&gt;minorct
op_assign
id|minorct
suffix:semicolon
id|cd-&gt;name
op_assign
id|name
suffix:semicolon
id|cd-&gt;fops
op_assign
id|fops
suffix:semicolon
id|i
op_assign
id|major_to_index
c_func
(paren
id|major
)paren
suffix:semicolon
r_for
c_loop
(paren
id|cp
op_assign
op_amp
id|chrdevs
(braket
id|i
)braket
suffix:semicolon
op_star
id|cp
suffix:semicolon
id|cp
op_assign
op_amp
(paren
op_star
id|cp
)paren
op_member_access_from_pointer
id|next
)paren
r_if
c_cond
(paren
(paren
op_star
id|cp
)paren
op_member_access_from_pointer
id|major
OG
id|major
op_logical_or
(paren
(paren
op_star
id|cp
)paren
op_member_access_from_pointer
id|major
op_eq
id|major
op_logical_and
(paren
op_star
id|cp
)paren
op_member_access_from_pointer
id|baseminor
op_ge
id|baseminor
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
op_star
id|cp
op_logical_and
(paren
op_star
id|cp
)paren
op_member_access_from_pointer
id|major
op_eq
id|major
op_logical_and
(paren
op_star
id|cp
)paren
op_member_access_from_pointer
id|baseminor
OL
id|baseminor
op_plus
id|minorct
)paren
(brace
id|ret
op_assign
op_minus
id|EBUSY
suffix:semicolon
)brace
r_else
(brace
id|cd-&gt;next
op_assign
op_star
id|cp
suffix:semicolon
op_star
id|cp
op_assign
id|cd
suffix:semicolon
)brace
id|out
suffix:colon
id|write_unlock_irq
c_func
(paren
op_amp
id|chrdevs_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
OL
l_int|0
)paren
id|kfree
c_func
(paren
id|cd
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|register_chrdev
r_int
id|register_chrdev
c_func
(paren
r_int
r_int
id|major
comma
r_const
r_char
op_star
id|name
comma
r_struct
id|file_operations
op_star
id|fops
)paren
(brace
r_return
id|register_chrdev_region
c_func
(paren
id|major
comma
l_int|0
comma
l_int|256
comma
id|name
comma
id|fops
)paren
suffix:semicolon
)brace
multiline_comment|/* todo: make void - error printk here */
DECL|function|unregister_chrdev_region
r_int
id|unregister_chrdev_region
c_func
(paren
r_int
r_int
id|major
comma
r_int
r_int
id|baseminor
comma
r_int
id|minorct
comma
r_const
r_char
op_star
id|name
)paren
(brace
r_struct
id|char_device_struct
op_star
id|cd
comma
op_star
op_star
id|cp
suffix:semicolon
r_int
id|ret
op_assign
l_int|0
suffix:semicolon
r_int
id|i
suffix:semicolon
id|i
op_assign
id|major_to_index
c_func
(paren
id|major
)paren
suffix:semicolon
id|write_lock_irq
c_func
(paren
op_amp
id|chrdevs_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|cp
op_assign
op_amp
id|chrdevs
(braket
id|i
)braket
suffix:semicolon
op_star
id|cp
suffix:semicolon
id|cp
op_assign
op_amp
(paren
op_star
id|cp
)paren
op_member_access_from_pointer
id|next
)paren
r_if
c_cond
(paren
(paren
op_star
id|cp
)paren
op_member_access_from_pointer
id|major
op_eq
id|major
op_logical_and
(paren
op_star
id|cp
)paren
op_member_access_from_pointer
id|baseminor
op_eq
id|baseminor
op_logical_and
(paren
op_star
id|cp
)paren
op_member_access_from_pointer
id|minorct
op_eq
id|minorct
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
op_star
id|cp
op_logical_or
id|strcmp
c_func
(paren
(paren
op_star
id|cp
)paren
op_member_access_from_pointer
id|name
comma
id|name
)paren
)paren
id|ret
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_else
(brace
id|cd
op_assign
op_star
id|cp
suffix:semicolon
op_star
id|cp
op_assign
id|cd-&gt;next
suffix:semicolon
id|kfree
c_func
(paren
id|cd
)paren
suffix:semicolon
)brace
id|write_unlock_irq
c_func
(paren
op_amp
id|chrdevs_lock
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
DECL|function|unregister_chrdev
r_int
id|unregister_chrdev
c_func
(paren
r_int
r_int
id|major
comma
r_const
r_char
op_star
id|name
)paren
(brace
r_return
id|unregister_chrdev_region
c_func
(paren
id|major
comma
l_int|0
comma
l_int|256
comma
id|name
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Called every time a character special file is opened&n; */
DECL|function|chrdev_open
r_int
id|chrdev_open
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|file
op_star
id|filp
)paren
(brace
r_int
id|ret
op_assign
op_minus
id|ENODEV
suffix:semicolon
id|filp-&gt;f_op
op_assign
id|get_chrfops
c_func
(paren
id|major
c_func
(paren
id|inode-&gt;i_rdev
)paren
comma
id|minor
c_func
(paren
id|inode-&gt;i_rdev
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|filp-&gt;f_op
)paren
(brace
id|ret
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|filp-&gt;f_op-&gt;open
op_ne
l_int|NULL
)paren
(brace
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
id|ret
op_assign
id|filp-&gt;f_op
op_member_access_from_pointer
id|open
c_func
(paren
id|inode
comma
id|filp
)paren
suffix:semicolon
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
)brace
)brace
r_return
id|ret
suffix:semicolon
)brace
multiline_comment|/*&n; * Dummy default file-operations: the only thing this does&n; * is contain the open that then fills in the correct operations&n; * depending on the special file...&n; */
DECL|variable|def_chr_fops
r_struct
id|file_operations
id|def_chr_fops
op_assign
(brace
dot
id|open
op_assign
id|chrdev_open
comma
)brace
suffix:semicolon
DECL|function|cdevname
r_const
r_char
op_star
id|cdevname
c_func
(paren
id|kdev_t
id|dev
)paren
(brace
r_static
r_char
id|buffer
(braket
l_int|40
)braket
suffix:semicolon
r_const
r_char
op_star
id|name
op_assign
l_string|&quot;unknown-char&quot;
suffix:semicolon
r_int
r_int
id|major
op_assign
id|major
c_func
(paren
id|dev
)paren
suffix:semicolon
r_int
r_int
id|minor
op_assign
id|minor
c_func
(paren
id|dev
)paren
suffix:semicolon
r_int
id|i
op_assign
id|major_to_index
c_func
(paren
id|major
)paren
suffix:semicolon
r_struct
id|char_device_struct
op_star
id|cd
suffix:semicolon
id|read_lock
c_func
(paren
op_amp
id|chrdevs_lock
)paren
suffix:semicolon
r_for
c_loop
(paren
id|cd
op_assign
id|chrdevs
(braket
id|i
)braket
suffix:semicolon
id|cd
suffix:semicolon
id|cd
op_assign
id|cd-&gt;next
)paren
r_if
c_cond
(paren
id|cd-&gt;major
op_eq
id|major
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|cd
)paren
id|name
op_assign
id|cd-&gt;name
suffix:semicolon
id|sprintf
c_func
(paren
id|buffer
comma
l_string|&quot;%s(%d,%d)&quot;
comma
id|name
comma
id|major
comma
id|minor
)paren
suffix:semicolon
id|read_unlock
c_func
(paren
op_amp
id|chrdevs_lock
)paren
suffix:semicolon
r_return
id|buffer
suffix:semicolon
)brace
eof
