multiline_comment|/*&n; *  cache.c&n; *&n; * Copyright (C) 1997 by Bill Hawes&n; *&n; * Routines to support directory cacheing using the page cache.&n; * This cache code is almost directly taken from ncpfs.&n; *&n; * Please add a note about your changes to smbfs in the ChangeLog file.&n; */
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/kernel.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/dirent.h&gt;
macro_line|#include &lt;linux/smb_fs.h&gt;
macro_line|#include &lt;linux/pagemap.h&gt;
macro_line|#include &lt;asm/page.h&gt;
macro_line|#include &quot;smb_debug.h&quot;
multiline_comment|/*&n; * Force the next attempt to use the cache to be a timeout.&n; * If we can&squot;t find the page that&squot;s fine, it will cause a refresh.&n; */
r_void
DECL|function|smb_invalid_dir_cache
id|smb_invalid_dir_cache
c_func
(paren
r_struct
id|inode
op_star
id|dir
)paren
(brace
r_struct
id|smb_sb_info
op_star
id|server
op_assign
id|server_from_inode
c_func
(paren
id|dir
)paren
suffix:semicolon
r_union
id|smb_dir_cache
op_star
id|cache
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|page
op_star
id|page
op_assign
l_int|NULL
suffix:semicolon
id|page
op_assign
id|grab_cache_page
c_func
(paren
op_amp
id|dir-&gt;i_data
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|page
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|Page_Uptodate
c_func
(paren
id|page
)paren
)paren
r_goto
id|out_unlock
suffix:semicolon
id|cache
op_assign
id|kmap
c_func
(paren
id|page
)paren
suffix:semicolon
id|cache-&gt;head.time
op_assign
id|jiffies
op_minus
id|SMB_MAX_AGE
c_func
(paren
id|server
)paren
suffix:semicolon
id|kunmap
c_func
(paren
id|page
)paren
suffix:semicolon
id|SetPageUptodate
c_func
(paren
id|page
)paren
suffix:semicolon
id|out_unlock
suffix:colon
id|UnlockPage
c_func
(paren
id|page
)paren
suffix:semicolon
id|page_cache_release
c_func
(paren
id|page
)paren
suffix:semicolon
id|out
suffix:colon
)brace
multiline_comment|/*&n; * Mark all dentries for &squot;parent&squot; as invalid, forcing them to be re-read&n; */
r_void
DECL|function|smb_invalidate_dircache_entries
id|smb_invalidate_dircache_entries
c_func
(paren
r_struct
id|dentry
op_star
id|parent
)paren
(brace
r_struct
id|smb_sb_info
op_star
id|server
op_assign
id|server_from_dentry
c_func
(paren
id|parent
)paren
suffix:semicolon
r_struct
id|list_head
op_star
id|next
suffix:semicolon
r_struct
id|dentry
op_star
id|dentry
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|dcache_lock
)paren
suffix:semicolon
id|next
op_assign
id|parent-&gt;d_subdirs.next
suffix:semicolon
r_while
c_loop
(paren
id|next
op_ne
op_amp
id|parent-&gt;d_subdirs
)paren
(brace
id|dentry
op_assign
id|list_entry
c_func
(paren
id|next
comma
r_struct
id|dentry
comma
id|d_child
)paren
suffix:semicolon
id|dentry-&gt;d_fsdata
op_assign
l_int|NULL
suffix:semicolon
id|smb_age_dentry
c_func
(paren
id|server
comma
id|dentry
)paren
suffix:semicolon
id|next
op_assign
id|next-&gt;next
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|dcache_lock
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|smb_d_validate
id|smb_d_validate
c_func
(paren
r_struct
id|dentry
op_star
id|dentry
)paren
(brace
r_int
r_int
id|dent_addr
op_assign
(paren
r_int
r_int
)paren
id|dentry
suffix:semicolon
r_int
r_int
id|min_addr
op_assign
id|PAGE_OFFSET
suffix:semicolon
r_int
r_int
id|align_mask
op_assign
l_int|0x0F
suffix:semicolon
r_int
r_int
id|len
suffix:semicolon
r_int
id|valid
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|dent_addr
OL
id|min_addr
)paren
r_goto
id|bad_addr
suffix:semicolon
r_if
c_cond
(paren
id|dent_addr
OG
(paren
r_int
r_int
)paren
id|high_memory
op_minus
r_sizeof
(paren
r_struct
id|dentry
)paren
)paren
r_goto
id|bad_addr
suffix:semicolon
r_if
c_cond
(paren
(paren
id|dent_addr
op_amp
op_complement
id|align_mask
)paren
op_ne
id|dent_addr
)paren
r_goto
id|bad_align
suffix:semicolon
r_if
c_cond
(paren
(paren
op_logical_neg
id|kern_addr_valid
c_func
(paren
id|dent_addr
)paren
)paren
op_logical_or
(paren
op_logical_neg
id|kern_addr_valid
c_func
(paren
id|dent_addr
op_minus
l_int|1
op_plus
r_sizeof
(paren
r_struct
id|dentry
)paren
)paren
)paren
)paren
r_goto
id|bad_addr
suffix:semicolon
multiline_comment|/*&n;&t; * Looks safe enough to dereference ...&n;&t; */
id|len
op_assign
id|dentry-&gt;d_name.len
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
id|SMB_MAXPATHLEN
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/*&n;&t; * Note: d_validate doesn&squot;t dereference the parent pointer ...&n;&t; * just combines it with the name hash to find the hash chain.&n;&t; */
id|valid
op_assign
id|d_validate
c_func
(paren
id|dentry
comma
id|dentry-&gt;d_parent
comma
id|dentry-&gt;d_name.hash
comma
id|len
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|valid
suffix:semicolon
id|bad_addr
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;smb_d_validate: invalid address %lx&bslash;n&quot;
comma
id|dent_addr
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
id|bad_align
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;smb_d_validate: unaligned address %lx&bslash;n&quot;
comma
id|dent_addr
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/*&n; * dget, but require that fpos and parent matches what the dentry contains.&n; * dentry is not known to be a valid pointer at entry.&n; */
r_struct
id|dentry
op_star
DECL|function|smb_dget_fpos
id|smb_dget_fpos
c_func
(paren
r_struct
id|dentry
op_star
id|dentry
comma
r_struct
id|dentry
op_star
id|parent
comma
r_int
r_int
id|fpos
)paren
(brace
r_struct
id|dentry
op_star
id|dent
op_assign
id|dentry
suffix:semicolon
r_struct
id|list_head
op_star
id|next
suffix:semicolon
r_if
c_cond
(paren
id|smb_d_validate
c_func
(paren
id|dent
)paren
)paren
(brace
r_if
c_cond
(paren
id|dent-&gt;d_parent
op_eq
id|parent
op_logical_and
(paren
r_int
r_int
)paren
id|dent-&gt;d_fsdata
op_eq
id|fpos
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|dent-&gt;d_inode
)paren
(brace
id|dput
c_func
(paren
id|dent
)paren
suffix:semicolon
id|dent
op_assign
l_int|NULL
suffix:semicolon
)brace
r_return
id|dent
suffix:semicolon
)brace
id|dput
c_func
(paren
id|dent
)paren
suffix:semicolon
)brace
multiline_comment|/* If a pointer is invalid, we search the dentry. */
id|spin_lock
c_func
(paren
op_amp
id|dcache_lock
)paren
suffix:semicolon
id|next
op_assign
id|parent-&gt;d_subdirs.next
suffix:semicolon
r_while
c_loop
(paren
id|next
op_ne
op_amp
id|parent-&gt;d_subdirs
)paren
(brace
id|dent
op_assign
id|list_entry
c_func
(paren
id|next
comma
r_struct
id|dentry
comma
id|d_child
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
r_int
r_int
)paren
id|dent-&gt;d_fsdata
op_eq
id|fpos
)paren
(brace
r_if
c_cond
(paren
id|dent-&gt;d_inode
)paren
id|dget_locked
c_func
(paren
id|dent
)paren
suffix:semicolon
r_else
id|dent
op_assign
l_int|NULL
suffix:semicolon
r_goto
id|out_unlock
suffix:semicolon
)brace
id|next
op_assign
id|next-&gt;next
suffix:semicolon
)brace
id|dent
op_assign
l_int|NULL
suffix:semicolon
id|out_unlock
suffix:colon
id|spin_unlock
c_func
(paren
op_amp
id|dcache_lock
)paren
suffix:semicolon
r_return
id|dent
suffix:semicolon
)brace
multiline_comment|/*&n; * Create dentry/inode for this file and add it to the dircache.&n; */
r_int
DECL|function|smb_fill_cache
id|smb_fill_cache
c_func
(paren
r_struct
id|file
op_star
id|filp
comma
r_void
op_star
id|dirent
comma
id|filldir_t
id|filldir
comma
r_struct
id|smb_cache_control
op_star
id|ctrl
comma
r_struct
id|qstr
op_star
id|qname
comma
r_struct
id|smb_fattr
op_star
id|entry
)paren
(brace
r_struct
id|dentry
op_star
id|newdent
comma
op_star
id|dentry
op_assign
id|filp-&gt;f_dentry
suffix:semicolon
r_struct
id|inode
op_star
id|newino
comma
op_star
id|inode
op_assign
id|dentry-&gt;d_inode
suffix:semicolon
r_struct
id|smb_cache_control
id|ctl
op_assign
op_star
id|ctrl
suffix:semicolon
r_int
id|valid
op_assign
l_int|0
suffix:semicolon
r_int
id|hashed
op_assign
l_int|0
suffix:semicolon
id|ino_t
id|ino
op_assign
l_int|0
suffix:semicolon
id|qname-&gt;hash
op_assign
id|full_name_hash
c_func
(paren
id|qname-&gt;name
comma
id|qname-&gt;len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dentry-&gt;d_op
op_logical_and
id|dentry-&gt;d_op-&gt;d_hash
)paren
r_if
c_cond
(paren
id|dentry-&gt;d_op
op_member_access_from_pointer
id|d_hash
c_func
(paren
id|dentry
comma
id|qname
)paren
op_ne
l_int|0
)paren
r_goto
id|end_advance
suffix:semicolon
id|newdent
op_assign
id|d_lookup
c_func
(paren
id|dentry
comma
id|qname
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|newdent
)paren
(brace
id|newdent
op_assign
id|d_alloc
c_func
(paren
id|dentry
comma
id|qname
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|newdent
)paren
r_goto
id|end_advance
suffix:semicolon
)brace
r_else
(brace
id|hashed
op_assign
l_int|1
suffix:semicolon
id|memcpy
c_func
(paren
(paren
r_char
op_star
)paren
id|newdent-&gt;d_name.name
comma
id|qname-&gt;name
comma
id|newdent-&gt;d_name.len
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|newdent-&gt;d_inode
)paren
(brace
id|smb_renew_times
c_func
(paren
id|newdent
)paren
suffix:semicolon
id|entry-&gt;f_ino
op_assign
id|iunique
c_func
(paren
id|inode-&gt;i_sb
comma
l_int|2
)paren
suffix:semicolon
id|newino
op_assign
id|smb_iget
c_func
(paren
id|inode-&gt;i_sb
comma
id|entry
)paren
suffix:semicolon
r_if
c_cond
(paren
id|newino
)paren
(brace
id|smb_new_dentry
c_func
(paren
id|newdent
)paren
suffix:semicolon
id|d_instantiate
c_func
(paren
id|newdent
comma
id|newino
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|hashed
)paren
id|d_rehash
c_func
(paren
id|newdent
)paren
suffix:semicolon
)brace
)brace
r_else
id|smb_set_inode_attr
c_func
(paren
id|newdent-&gt;d_inode
comma
id|entry
)paren
suffix:semicolon
r_if
c_cond
(paren
id|newdent-&gt;d_inode
)paren
(brace
id|ino
op_assign
id|newdent-&gt;d_inode-&gt;i_ino
suffix:semicolon
id|newdent-&gt;d_fsdata
op_assign
(paren
r_void
op_star
)paren
id|ctl.fpos
suffix:semicolon
id|smb_new_dentry
c_func
(paren
id|newdent
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ctl.idx
op_ge
id|SMB_DIRCACHE_SIZE
)paren
(brace
r_if
c_cond
(paren
id|ctl.page
)paren
(brace
id|kunmap
c_func
(paren
id|ctl.page
)paren
suffix:semicolon
id|SetPageUptodate
c_func
(paren
id|ctl.page
)paren
suffix:semicolon
id|UnlockPage
c_func
(paren
id|ctl.page
)paren
suffix:semicolon
id|page_cache_release
c_func
(paren
id|ctl.page
)paren
suffix:semicolon
)brace
id|ctl.cache
op_assign
l_int|NULL
suffix:semicolon
id|ctl.idx
op_sub_assign
id|SMB_DIRCACHE_SIZE
suffix:semicolon
id|ctl.ofs
op_add_assign
l_int|1
suffix:semicolon
id|ctl.page
op_assign
id|grab_cache_page
c_func
(paren
op_amp
id|inode-&gt;i_data
comma
id|ctl.ofs
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ctl.page
)paren
id|ctl.cache
op_assign
id|kmap
c_func
(paren
id|ctl.page
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ctl.cache
)paren
(brace
id|ctl.cache-&gt;dentry
(braket
id|ctl.idx
)braket
op_assign
id|newdent
suffix:semicolon
id|valid
op_assign
l_int|1
suffix:semicolon
)brace
id|dput
c_func
(paren
id|newdent
)paren
suffix:semicolon
id|end_advance
suffix:colon
r_if
c_cond
(paren
op_logical_neg
id|valid
)paren
id|ctl.valid
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ctl.filled
op_logical_and
(paren
id|ctl.fpos
op_eq
id|filp-&gt;f_pos
)paren
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|ino
)paren
id|ino
op_assign
id|find_inode_number
c_func
(paren
id|dentry
comma
id|qname
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ino
)paren
id|ino
op_assign
id|iunique
c_func
(paren
id|inode-&gt;i_sb
comma
l_int|2
)paren
suffix:semicolon
id|ctl.filled
op_assign
id|filldir
c_func
(paren
id|dirent
comma
id|qname-&gt;name
comma
id|qname-&gt;len
comma
id|filp-&gt;f_pos
comma
id|ino
comma
id|DT_UNKNOWN
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ctl.filled
)paren
id|filp-&gt;f_pos
op_add_assign
l_int|1
suffix:semicolon
)brace
id|ctl.fpos
op_add_assign
l_int|1
suffix:semicolon
id|ctl.idx
op_add_assign
l_int|1
suffix:semicolon
op_star
id|ctrl
op_assign
id|ctl
suffix:semicolon
r_return
(paren
id|ctl.valid
op_logical_or
op_logical_neg
id|ctl.filled
)paren
suffix:semicolon
)brace
eof
