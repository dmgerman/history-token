multiline_comment|/*&n; *  proc.c&n; *&n; *  Copyright (C) 1995, 1996 by Paal-Kr. Engstad and Volker Lendecke&n; *  Copyright (C) 1997 by Volker Lendecke&n; *&n; *  Please add a note about your changes to smbfs in the ChangeLog file.&n; */
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/file.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/fcntl.h&gt;
macro_line|#include &lt;linux/dcache.h&gt;
macro_line|#include &lt;linux/dirent.h&gt;
macro_line|#include &lt;linux/nls.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/net.h&gt;
macro_line|#include &lt;linux/vfs.h&gt;
macro_line|#include &lt;linux/smb_fs.h&gt;
macro_line|#include &lt;linux/smbno.h&gt;
macro_line|#include &lt;linux/smb_mount.h&gt;
macro_line|#include &lt;net/sock.h&gt;
macro_line|#include &lt;asm/string.h&gt;
macro_line|#include &lt;asm/div64.h&gt;
macro_line|#include &quot;smb_debug.h&quot;
macro_line|#include &quot;proto.h&quot;
macro_line|#include &quot;request.h&quot;
multiline_comment|/* Features. Undefine if they cause problems, this should perhaps be a&n;   config option. */
DECL|macro|SMBFS_POSIX_UNLINK
mdefine_line|#define SMBFS_POSIX_UNLINK 1
multiline_comment|/* Allow smb_retry to be interrupted. */
DECL|macro|SMB_RETRY_INTR
mdefine_line|#define SMB_RETRY_INTR
DECL|macro|SMB_VWV
mdefine_line|#define SMB_VWV(packet)  ((packet) + SMB_HEADER_LEN)
DECL|macro|SMB_CMD
mdefine_line|#define SMB_CMD(packet)  (*(packet+8))
DECL|macro|SMB_WCT
mdefine_line|#define SMB_WCT(packet)  (*(packet+SMB_HEADER_LEN - 1))
DECL|macro|SMB_DIRINFO_SIZE
mdefine_line|#define SMB_DIRINFO_SIZE 43
DECL|macro|SMB_STATUS_SIZE
mdefine_line|#define SMB_STATUS_SIZE  21
DECL|macro|SMB_ST_BLKSIZE
mdefine_line|#define SMB_ST_BLKSIZE&t;(PAGE_SIZE)
DECL|macro|SMB_ST_BLKSHIFT
mdefine_line|#define SMB_ST_BLKSHIFT&t;(PAGE_SHIFT)
DECL|variable|smb_ops_core
r_static
r_struct
id|smb_ops
id|smb_ops_core
suffix:semicolon
DECL|variable|smb_ops_os2
r_static
r_struct
id|smb_ops
id|smb_ops_os2
suffix:semicolon
DECL|variable|smb_ops_win95
r_static
r_struct
id|smb_ops
id|smb_ops_win95
suffix:semicolon
DECL|variable|smb_ops_winNT
r_static
r_struct
id|smb_ops
id|smb_ops_winNT
suffix:semicolon
DECL|variable|smb_ops_unix
r_static
r_struct
id|smb_ops
id|smb_ops_unix
suffix:semicolon
r_static
r_void
id|smb_init_dirent
c_func
(paren
r_struct
id|smb_sb_info
op_star
id|server
comma
r_struct
id|smb_fattr
op_star
id|fattr
)paren
suffix:semicolon
r_static
r_void
id|smb_finish_dirent
c_func
(paren
r_struct
id|smb_sb_info
op_star
id|server
comma
r_struct
id|smb_fattr
op_star
id|fattr
)paren
suffix:semicolon
r_static
r_int
id|smb_proc_getattr_core
c_func
(paren
r_struct
id|smb_sb_info
op_star
id|server
comma
r_struct
id|dentry
op_star
id|dir
comma
r_struct
id|smb_fattr
op_star
id|fattr
)paren
suffix:semicolon
r_static
r_int
id|smb_proc_getattr_ff
c_func
(paren
r_struct
id|smb_sb_info
op_star
id|server
comma
r_struct
id|dentry
op_star
id|dentry
comma
r_struct
id|smb_fattr
op_star
id|fattr
)paren
suffix:semicolon
r_static
r_int
id|smb_proc_setattr_core
c_func
(paren
r_struct
id|smb_sb_info
op_star
id|server
comma
r_struct
id|dentry
op_star
id|dentry
comma
id|u16
id|attr
)paren
suffix:semicolon
r_static
r_int
id|smb_proc_setattr_ext
c_func
(paren
r_struct
id|smb_sb_info
op_star
id|server
comma
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|smb_fattr
op_star
id|fattr
)paren
suffix:semicolon
r_int
id|smb_proc_query_cifsunix
c_func
(paren
r_struct
id|smb_sb_info
op_star
id|server
)paren
suffix:semicolon
r_static
r_void
id|install_ops
c_func
(paren
r_struct
id|smb_ops
op_star
id|dst
comma
r_struct
id|smb_ops
op_star
id|src
)paren
suffix:semicolon
r_static
r_void
DECL|function|str_upper
id|str_upper
c_func
(paren
r_char
op_star
id|name
comma
r_int
id|len
)paren
(brace
r_while
c_loop
(paren
id|len
op_decrement
)paren
(brace
r_if
c_cond
(paren
op_star
id|name
op_ge
l_char|&squot;a&squot;
op_logical_and
op_star
id|name
op_le
l_char|&squot;z&squot;
)paren
op_star
id|name
op_sub_assign
(paren
l_char|&squot;a&squot;
op_minus
l_char|&squot;A&squot;
)paren
suffix:semicolon
id|name
op_increment
suffix:semicolon
)brace
)brace
macro_line|#if 0
r_static
r_void
id|str_lower
c_func
(paren
r_char
op_star
id|name
comma
r_int
id|len
)paren
(brace
r_while
c_loop
(paren
id|len
op_decrement
)paren
(brace
r_if
c_cond
(paren
op_star
id|name
op_ge
l_char|&squot;A&squot;
op_logical_and
op_star
id|name
op_le
l_char|&squot;Z&squot;
)paren
op_star
id|name
op_add_assign
(paren
l_char|&squot;a&squot;
op_minus
l_char|&squot;A&squot;
)paren
suffix:semicolon
id|name
op_increment
suffix:semicolon
)brace
)brace
macro_line|#endif
multiline_comment|/* reverse a string inline. This is used by the dircache walking routines */
DECL|function|reverse_string
r_static
r_void
id|reverse_string
c_func
(paren
r_char
op_star
id|buf
comma
r_int
id|len
)paren
(brace
r_char
id|c
suffix:semicolon
r_char
op_star
id|end
op_assign
id|buf
op_plus
id|len
op_minus
l_int|1
suffix:semicolon
r_while
c_loop
(paren
id|buf
OL
id|end
)paren
(brace
id|c
op_assign
op_star
id|buf
suffix:semicolon
op_star
(paren
id|buf
op_increment
)paren
op_assign
op_star
id|end
suffix:semicolon
op_star
(paren
id|end
op_decrement
)paren
op_assign
id|c
suffix:semicolon
)brace
)brace
multiline_comment|/* no conversion, just a wrapper for memcpy. */
DECL|function|convert_memcpy
r_static
r_int
id|convert_memcpy
c_func
(paren
r_int
r_char
op_star
id|output
comma
r_int
id|olen
comma
r_const
r_int
r_char
op_star
id|input
comma
r_int
id|ilen
comma
r_struct
id|nls_table
op_star
id|nls_from
comma
r_struct
id|nls_table
op_star
id|nls_to
)paren
(brace
r_if
c_cond
(paren
id|olen
OL
id|ilen
)paren
r_return
op_minus
id|ENAMETOOLONG
suffix:semicolon
id|memcpy
c_func
(paren
id|output
comma
id|input
comma
id|ilen
)paren
suffix:semicolon
r_return
id|ilen
suffix:semicolon
)brace
DECL|function|write_char
r_static
r_inline
r_int
id|write_char
c_func
(paren
r_int
r_char
id|ch
comma
r_char
op_star
id|output
comma
r_int
id|olen
)paren
(brace
r_if
c_cond
(paren
id|olen
OL
l_int|4
)paren
r_return
op_minus
id|ENAMETOOLONG
suffix:semicolon
id|sprintf
c_func
(paren
id|output
comma
l_string|&quot;:x%02x&quot;
comma
id|ch
)paren
suffix:semicolon
r_return
l_int|4
suffix:semicolon
)brace
DECL|function|write_unichar
r_static
r_inline
r_int
id|write_unichar
c_func
(paren
m_wchar_t
id|ch
comma
r_char
op_star
id|output
comma
r_int
id|olen
)paren
(brace
r_if
c_cond
(paren
id|olen
OL
l_int|5
)paren
r_return
op_minus
id|ENAMETOOLONG
suffix:semicolon
id|sprintf
c_func
(paren
id|output
comma
l_string|&quot;:%04x&quot;
comma
id|ch
)paren
suffix:semicolon
r_return
l_int|5
suffix:semicolon
)brace
multiline_comment|/* convert from one &quot;codepage&quot; to another (possibly being utf8). */
DECL|function|convert_cp
r_static
r_int
id|convert_cp
c_func
(paren
r_int
r_char
op_star
id|output
comma
r_int
id|olen
comma
r_const
r_int
r_char
op_star
id|input
comma
r_int
id|ilen
comma
r_struct
id|nls_table
op_star
id|nls_from
comma
r_struct
id|nls_table
op_star
id|nls_to
)paren
(brace
r_int
id|len
op_assign
l_int|0
suffix:semicolon
r_int
id|n
suffix:semicolon
m_wchar_t
id|ch
suffix:semicolon
r_while
c_loop
(paren
id|ilen
OG
l_int|0
)paren
(brace
multiline_comment|/* convert by changing to unicode and back to the new cp */
id|n
op_assign
id|nls_from
op_member_access_from_pointer
id|char2uni
c_func
(paren
id|input
comma
id|ilen
comma
op_amp
id|ch
)paren
suffix:semicolon
r_if
c_cond
(paren
id|n
op_eq
op_minus
id|EINVAL
)paren
(brace
id|ilen
op_decrement
suffix:semicolon
id|n
op_assign
id|write_char
c_func
(paren
op_star
id|input
op_increment
comma
id|output
comma
id|olen
)paren
suffix:semicolon
r_if
c_cond
(paren
id|n
OL
l_int|0
)paren
r_goto
id|fail
suffix:semicolon
id|output
op_add_assign
id|n
suffix:semicolon
id|olen
op_sub_assign
id|n
suffix:semicolon
id|len
op_add_assign
id|n
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|n
OL
l_int|0
)paren
r_goto
id|fail
suffix:semicolon
id|input
op_add_assign
id|n
suffix:semicolon
id|ilen
op_sub_assign
id|n
suffix:semicolon
id|n
op_assign
id|nls_to
op_member_access_from_pointer
id|uni2char
c_func
(paren
id|ch
comma
id|output
comma
id|olen
)paren
suffix:semicolon
r_if
c_cond
(paren
id|n
op_eq
op_minus
id|EINVAL
)paren
id|n
op_assign
id|write_unichar
c_func
(paren
id|ch
comma
id|output
comma
id|olen
)paren
suffix:semicolon
r_if
c_cond
(paren
id|n
OL
l_int|0
)paren
r_goto
id|fail
suffix:semicolon
id|output
op_add_assign
id|n
suffix:semicolon
id|olen
op_sub_assign
id|n
suffix:semicolon
id|len
op_add_assign
id|n
suffix:semicolon
)brace
r_return
id|len
suffix:semicolon
id|fail
suffix:colon
r_return
id|n
suffix:semicolon
)brace
multiline_comment|/* ----------------------------------------------------------- */
multiline_comment|/*&n; * nls_unicode&n; *&n; * This encodes/decodes little endian unicode format&n; */
DECL|function|uni2char
r_static
r_int
id|uni2char
c_func
(paren
m_wchar_t
id|uni
comma
r_int
r_char
op_star
id|out
comma
r_int
id|boundlen
)paren
(brace
r_if
c_cond
(paren
id|boundlen
OL
l_int|2
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
op_star
id|out
op_increment
op_assign
id|uni
op_amp
l_int|0xff
suffix:semicolon
op_star
id|out
op_increment
op_assign
id|uni
op_rshift
l_int|8
suffix:semicolon
r_return
l_int|2
suffix:semicolon
)brace
DECL|function|char2uni
r_static
r_int
id|char2uni
c_func
(paren
r_const
r_int
r_char
op_star
id|rawstring
comma
r_int
id|boundlen
comma
m_wchar_t
op_star
id|uni
)paren
(brace
r_if
c_cond
(paren
id|boundlen
OL
l_int|2
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
op_star
id|uni
op_assign
(paren
id|rawstring
(braket
l_int|1
)braket
op_lshift
l_int|8
)paren
op_or
id|rawstring
(braket
l_int|0
)braket
suffix:semicolon
r_return
l_int|2
suffix:semicolon
)brace
DECL|variable|unicode_table
r_static
r_struct
id|nls_table
id|unicode_table
op_assign
(brace
l_string|&quot;unicode&quot;
comma
id|uni2char
comma
id|char2uni
comma
l_int|NULL
comma
multiline_comment|/* not used by smbfs */
l_int|NULL
comma
l_int|NULL
comma
multiline_comment|/* not a module */
)brace
suffix:semicolon
multiline_comment|/* ----------------------------------------------------------- */
DECL|function|setcodepage
r_static
r_int
id|setcodepage
c_func
(paren
r_struct
id|nls_table
op_star
op_star
id|p
comma
r_char
op_star
id|name
)paren
(brace
r_struct
id|nls_table
op_star
id|nls
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|name
op_logical_or
op_logical_neg
op_star
id|name
)paren
(brace
id|nls
op_assign
l_int|NULL
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
(paren
id|nls
op_assign
id|load_nls
c_func
(paren
id|name
)paren
)paren
op_eq
l_int|NULL
)paren
(brace
id|printk
(paren
id|KERN_ERR
l_string|&quot;smbfs: failed to load nls &squot;%s&squot;&bslash;n&quot;
comma
id|name
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* if already set, unload the previous one. */
r_if
c_cond
(paren
op_star
id|p
op_logical_and
op_star
id|p
op_ne
op_amp
id|unicode_table
)paren
id|unload_nls
c_func
(paren
op_star
id|p
)paren
suffix:semicolon
op_star
id|p
op_assign
id|nls
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* Handles all changes to codepage settings. */
DECL|function|smb_setcodepage
r_int
id|smb_setcodepage
c_func
(paren
r_struct
id|smb_sb_info
op_star
id|server
comma
r_struct
id|smb_nls_codepage
op_star
id|cp
)paren
(brace
r_int
id|n
op_assign
l_int|0
suffix:semicolon
id|smb_lock_server
c_func
(paren
id|server
)paren
suffix:semicolon
multiline_comment|/* Don&squot;t load any nls_* at all, if no remote is requested */
r_if
c_cond
(paren
op_logical_neg
op_star
id|cp-&gt;remote_name
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* local */
id|n
op_assign
id|setcodepage
c_func
(paren
op_amp
id|server-&gt;local_nls
comma
id|cp-&gt;local_name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|n
op_ne
l_int|0
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* remote */
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|cp-&gt;remote_name
comma
l_string|&quot;unicode&quot;
)paren
)paren
(brace
id|server-&gt;remote_nls
op_assign
op_amp
id|unicode_table
suffix:semicolon
)brace
r_else
(brace
id|n
op_assign
id|setcodepage
c_func
(paren
op_amp
id|server-&gt;remote_nls
comma
id|cp-&gt;remote_name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|n
op_ne
l_int|0
)paren
id|setcodepage
c_func
(paren
op_amp
id|server-&gt;local_nls
comma
l_int|NULL
)paren
suffix:semicolon
)brace
id|out
suffix:colon
r_if
c_cond
(paren
id|server-&gt;local_nls
op_ne
l_int|NULL
op_logical_and
id|server-&gt;remote_nls
op_ne
l_int|NULL
)paren
id|server-&gt;ops-&gt;convert
op_assign
id|convert_cp
suffix:semicolon
r_else
id|server-&gt;ops-&gt;convert
op_assign
id|convert_memcpy
suffix:semicolon
id|smb_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|n
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*                                                                           */
multiline_comment|/*  Encoding/Decoding section                                                */
multiline_comment|/*                                                                           */
multiline_comment|/*****************************************************************************/
r_static
id|__u8
op_star
DECL|function|smb_encode_smb_length
id|smb_encode_smb_length
c_func
(paren
id|__u8
op_star
id|p
comma
id|__u32
id|len
)paren
(brace
op_star
id|p
op_assign
l_int|0
suffix:semicolon
op_star
(paren
id|p
op_plus
l_int|1
)paren
op_assign
l_int|0
suffix:semicolon
op_star
(paren
id|p
op_plus
l_int|2
)paren
op_assign
(paren
id|len
op_amp
l_int|0xFF00
)paren
op_rshift
l_int|8
suffix:semicolon
op_star
(paren
id|p
op_plus
l_int|3
)paren
op_assign
(paren
id|len
op_amp
l_int|0xFF
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
l_int|0xFFFF
)paren
(brace
op_star
(paren
id|p
op_plus
l_int|1
)paren
op_assign
l_int|1
suffix:semicolon
)brace
r_return
id|p
op_plus
l_int|4
suffix:semicolon
)brace
multiline_comment|/*&n; * smb_build_path: build the path to entry and name storing it in buf.&n; * The path returned will have the trailing &squot;&bslash;0&squot;.&n; */
DECL|function|smb_build_path
r_static
r_int
id|smb_build_path
c_func
(paren
r_struct
id|smb_sb_info
op_star
id|server
comma
r_int
r_char
op_star
id|buf
comma
r_int
id|maxlen
comma
r_struct
id|dentry
op_star
id|entry
comma
r_struct
id|qstr
op_star
id|name
)paren
(brace
r_int
r_char
op_star
id|path
op_assign
id|buf
suffix:semicolon
r_int
id|len
suffix:semicolon
r_int
id|unicode
op_assign
(paren
id|server-&gt;mnt-&gt;flags
op_amp
id|SMB_MOUNT_UNICODE
)paren
op_ne
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|maxlen
OL
(paren
l_int|2
op_lshift
id|unicode
)paren
)paren
r_return
op_minus
id|ENAMETOOLONG
suffix:semicolon
r_if
c_cond
(paren
id|maxlen
OG
id|SMB_MAXPATHLEN
op_plus
l_int|1
)paren
id|maxlen
op_assign
id|SMB_MAXPATHLEN
op_plus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|entry
op_eq
l_int|NULL
)paren
r_goto
id|test_name_and_out
suffix:semicolon
multiline_comment|/*&n;&t; * If IS_ROOT, we have to do no walking at all.&n;&t; */
r_if
c_cond
(paren
id|IS_ROOT
c_func
(paren
id|entry
)paren
op_logical_and
op_logical_neg
id|name
)paren
(brace
op_star
id|path
op_increment
op_assign
l_char|&squot;&bslash;&bslash;&squot;
suffix:semicolon
r_if
c_cond
(paren
id|unicode
)paren
op_star
id|path
op_increment
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
op_star
id|path
op_increment
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_if
c_cond
(paren
id|unicode
)paren
op_star
id|path
op_increment
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_return
id|path
op_minus
id|buf
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Build the path string walking the tree backward from end to ROOT&n;&t; * and store it in reversed order [see reverse_string()]&n;&t; */
id|dget
c_func
(paren
id|entry
)paren
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|entry-&gt;d_lock
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|IS_ROOT
c_func
(paren
id|entry
)paren
)paren
(brace
r_struct
id|dentry
op_star
id|parent
suffix:semicolon
r_if
c_cond
(paren
id|maxlen
OL
(paren
l_int|3
op_lshift
id|unicode
)paren
)paren
(brace
id|spin_unlock
c_func
(paren
op_amp
id|entry-&gt;d_lock
)paren
suffix:semicolon
id|dput
c_func
(paren
id|entry
)paren
suffix:semicolon
r_return
op_minus
id|ENAMETOOLONG
suffix:semicolon
)brace
id|len
op_assign
id|server-&gt;ops
op_member_access_from_pointer
id|convert
c_func
(paren
id|path
comma
id|maxlen
op_minus
l_int|2
comma
id|entry-&gt;d_name.name
comma
id|entry-&gt;d_name.len
comma
id|server-&gt;local_nls
comma
id|server-&gt;remote_nls
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
l_int|0
)paren
(brace
id|spin_unlock
c_func
(paren
op_amp
id|entry-&gt;d_lock
)paren
suffix:semicolon
id|dput
c_func
(paren
id|entry
)paren
suffix:semicolon
r_return
id|len
suffix:semicolon
)brace
id|reverse_string
c_func
(paren
id|path
comma
id|len
)paren
suffix:semicolon
id|path
op_add_assign
id|len
suffix:semicolon
r_if
c_cond
(paren
id|unicode
)paren
(brace
multiline_comment|/* Note: reverse order */
op_star
id|path
op_increment
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|maxlen
op_decrement
suffix:semicolon
)brace
op_star
id|path
op_increment
op_assign
l_char|&squot;&bslash;&bslash;&squot;
suffix:semicolon
id|maxlen
op_sub_assign
id|len
op_plus
l_int|1
suffix:semicolon
id|parent
op_assign
id|entry-&gt;d_parent
suffix:semicolon
id|dget
c_func
(paren
id|parent
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|entry-&gt;d_lock
)paren
suffix:semicolon
id|dput
c_func
(paren
id|entry
)paren
suffix:semicolon
id|entry
op_assign
id|parent
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|entry-&gt;d_lock
)paren
suffix:semicolon
)brace
id|spin_unlock
c_func
(paren
op_amp
id|entry-&gt;d_lock
)paren
suffix:semicolon
id|dput
c_func
(paren
id|entry
)paren
suffix:semicolon
id|reverse_string
c_func
(paren
id|buf
comma
id|path
op_minus
id|buf
)paren
suffix:semicolon
multiline_comment|/* maxlen has space for at least one char */
id|test_name_and_out
suffix:colon
r_if
c_cond
(paren
id|name
)paren
(brace
r_if
c_cond
(paren
id|maxlen
OL
(paren
l_int|3
op_lshift
id|unicode
)paren
)paren
r_return
op_minus
id|ENAMETOOLONG
suffix:semicolon
op_star
id|path
op_increment
op_assign
l_char|&squot;&bslash;&bslash;&squot;
suffix:semicolon
r_if
c_cond
(paren
id|unicode
)paren
(brace
op_star
id|path
op_increment
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|maxlen
op_decrement
suffix:semicolon
)brace
id|len
op_assign
id|server-&gt;ops
op_member_access_from_pointer
id|convert
c_func
(paren
id|path
comma
id|maxlen
op_minus
l_int|2
comma
id|name-&gt;name
comma
id|name-&gt;len
comma
id|server-&gt;local_nls
comma
id|server-&gt;remote_nls
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OL
l_int|0
)paren
r_return
id|len
suffix:semicolon
id|path
op_add_assign
id|len
suffix:semicolon
id|maxlen
op_sub_assign
id|len
op_plus
l_int|1
suffix:semicolon
)brace
multiline_comment|/* maxlen has space for at least one char */
op_star
id|path
op_increment
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_if
c_cond
(paren
id|unicode
)paren
op_star
id|path
op_increment
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
r_return
id|path
op_minus
id|buf
suffix:semicolon
)brace
DECL|function|smb_encode_path
r_static
r_int
id|smb_encode_path
c_func
(paren
r_struct
id|smb_sb_info
op_star
id|server
comma
r_char
op_star
id|buf
comma
r_int
id|maxlen
comma
r_struct
id|dentry
op_star
id|dir
comma
r_struct
id|qstr
op_star
id|name
)paren
(brace
r_int
id|result
suffix:semicolon
id|result
op_assign
id|smb_build_path
c_func
(paren
id|server
comma
id|buf
comma
id|maxlen
comma
id|dir
comma
id|name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|server-&gt;opt.protocol
op_le
id|SMB_PROTOCOL_COREPLUS
)paren
id|str_upper
c_func
(paren
id|buf
comma
id|result
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/* encode_path for non-trans2 request SMBs */
DECL|function|smb_simple_encode_path
r_static
r_int
id|smb_simple_encode_path
c_func
(paren
r_struct
id|smb_request
op_star
id|req
comma
r_char
op_star
op_star
id|p
comma
r_struct
id|dentry
op_star
id|entry
comma
r_struct
id|qstr
op_star
id|name
)paren
(brace
r_struct
id|smb_sb_info
op_star
id|server
op_assign
id|req-&gt;rq_server
suffix:semicolon
r_char
op_star
id|s
op_assign
op_star
id|p
suffix:semicolon
r_int
id|res
suffix:semicolon
r_int
id|maxlen
op_assign
(paren
(paren
r_char
op_star
)paren
id|req-&gt;rq_buffer
op_plus
id|req-&gt;rq_bufsize
)paren
op_minus
id|s
suffix:semicolon
r_int
id|unicode
op_assign
(paren
id|server-&gt;mnt-&gt;flags
op_amp
id|SMB_MOUNT_UNICODE
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|maxlen
)paren
r_return
op_minus
id|ENAMETOOLONG
suffix:semicolon
op_star
id|s
op_increment
op_assign
l_int|4
suffix:semicolon
multiline_comment|/* ASCII data format */
multiline_comment|/*&n;&t; * SMB Unicode strings must be 16bit aligned relative the start of the&n;&t; * packet. If they are not they must be padded with 0.&n;&t; */
r_if
c_cond
(paren
id|unicode
)paren
(brace
r_int
id|align
op_assign
id|s
op_minus
(paren
r_char
op_star
)paren
id|req-&gt;rq_buffer
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|align
op_amp
l_int|1
)paren
)paren
(brace
op_star
id|s
op_increment
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|maxlen
op_decrement
suffix:semicolon
)brace
)brace
id|res
op_assign
id|smb_encode_path
c_func
(paren
id|server
comma
id|s
comma
id|maxlen
op_minus
l_int|1
comma
id|entry
comma
id|name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
OL
l_int|0
)paren
r_return
id|res
suffix:semicolon
op_star
id|p
op_assign
id|s
op_plus
id|res
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/* The following are taken directly from msdos-fs */
multiline_comment|/* Linear day numbers of the respective 1sts in non-leap years. */
DECL|variable|day_n
r_static
r_int
id|day_n
(braket
)braket
op_assign
(brace
l_int|0
comma
l_int|31
comma
l_int|59
comma
l_int|90
comma
l_int|120
comma
l_int|151
comma
l_int|181
comma
l_int|212
comma
l_int|243
comma
l_int|273
comma
l_int|304
comma
l_int|334
comma
l_int|0
comma
l_int|0
comma
l_int|0
comma
l_int|0
)brace
suffix:semicolon
multiline_comment|/* JanFebMarApr May Jun Jul Aug Sep Oct Nov Dec */
r_static
id|time_t
DECL|function|utc2local
id|utc2local
c_func
(paren
r_struct
id|smb_sb_info
op_star
id|server
comma
id|time_t
id|time
)paren
(brace
r_return
id|time
op_minus
id|server-&gt;opt.serverzone
op_star
l_int|60
suffix:semicolon
)brace
r_static
id|time_t
DECL|function|local2utc
id|local2utc
c_func
(paren
r_struct
id|smb_sb_info
op_star
id|server
comma
id|time_t
id|time
)paren
(brace
r_return
id|time
op_plus
id|server-&gt;opt.serverzone
op_star
l_int|60
suffix:semicolon
)brace
multiline_comment|/* Convert a MS-DOS time/date pair to a UNIX date (seconds since 1 1 70). */
r_static
id|time_t
DECL|function|date_dos2unix
id|date_dos2unix
c_func
(paren
r_struct
id|smb_sb_info
op_star
id|server
comma
id|__u16
id|date
comma
id|__u16
id|time
)paren
(brace
r_int
id|month
comma
id|year
suffix:semicolon
id|time_t
id|secs
suffix:semicolon
multiline_comment|/* first subtract and mask after that... Otherwise, if&n;&t;   date == 0, bad things happen */
id|month
op_assign
(paren
(paren
id|date
op_rshift
l_int|5
)paren
op_minus
l_int|1
)paren
op_amp
l_int|15
suffix:semicolon
id|year
op_assign
id|date
op_rshift
l_int|9
suffix:semicolon
id|secs
op_assign
(paren
id|time
op_amp
l_int|31
)paren
op_star
l_int|2
op_plus
l_int|60
op_star
(paren
(paren
id|time
op_rshift
l_int|5
)paren
op_amp
l_int|63
)paren
op_plus
(paren
id|time
op_rshift
l_int|11
)paren
op_star
l_int|3600
op_plus
l_int|86400
op_star
(paren
(paren
id|date
op_amp
l_int|31
)paren
op_minus
l_int|1
op_plus
id|day_n
(braket
id|month
)braket
op_plus
(paren
id|year
op_div
l_int|4
)paren
op_plus
id|year
op_star
l_int|365
op_minus
(paren
(paren
id|year
op_amp
l_int|3
)paren
op_eq
l_int|0
op_logical_and
id|month
OL
l_int|2
ques
c_cond
l_int|1
suffix:colon
l_int|0
)paren
op_plus
l_int|3653
)paren
suffix:semicolon
multiline_comment|/* days since 1.1.70 plus 80&squot;s leap day */
r_return
id|local2utc
c_func
(paren
id|server
comma
id|secs
)paren
suffix:semicolon
)brace
multiline_comment|/* Convert linear UNIX date to a MS-DOS time/date pair. */
r_static
r_void
DECL|function|date_unix2dos
id|date_unix2dos
c_func
(paren
r_struct
id|smb_sb_info
op_star
id|server
comma
r_int
id|unix_date
comma
id|__u16
op_star
id|date
comma
id|__u16
op_star
id|time
)paren
(brace
r_int
id|day
comma
id|year
comma
id|nl_day
comma
id|month
suffix:semicolon
id|unix_date
op_assign
id|utc2local
c_func
(paren
id|server
comma
id|unix_date
)paren
suffix:semicolon
r_if
c_cond
(paren
id|unix_date
OL
l_int|315532800
)paren
id|unix_date
op_assign
l_int|315532800
suffix:semicolon
op_star
id|time
op_assign
(paren
id|unix_date
op_mod
l_int|60
)paren
op_div
l_int|2
op_plus
(paren
(paren
(paren
id|unix_date
op_div
l_int|60
)paren
op_mod
l_int|60
)paren
op_lshift
l_int|5
)paren
op_plus
(paren
(paren
(paren
id|unix_date
op_div
l_int|3600
)paren
op_mod
l_int|24
)paren
op_lshift
l_int|11
)paren
suffix:semicolon
id|day
op_assign
id|unix_date
op_div
l_int|86400
op_minus
l_int|3652
suffix:semicolon
id|year
op_assign
id|day
op_div
l_int|365
suffix:semicolon
r_if
c_cond
(paren
(paren
id|year
op_plus
l_int|3
)paren
op_div
l_int|4
op_plus
l_int|365
op_star
id|year
OG
id|day
)paren
id|year
op_decrement
suffix:semicolon
id|day
op_sub_assign
(paren
id|year
op_plus
l_int|3
)paren
op_div
l_int|4
op_plus
l_int|365
op_star
id|year
suffix:semicolon
r_if
c_cond
(paren
id|day
op_eq
l_int|59
op_logical_and
op_logical_neg
(paren
id|year
op_amp
l_int|3
)paren
)paren
(brace
id|nl_day
op_assign
id|day
suffix:semicolon
id|month
op_assign
l_int|2
suffix:semicolon
)brace
r_else
(brace
id|nl_day
op_assign
(paren
id|year
op_amp
l_int|3
)paren
op_logical_or
id|day
op_le
l_int|59
ques
c_cond
id|day
suffix:colon
id|day
op_minus
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|month
op_assign
l_int|0
suffix:semicolon
id|month
OL
l_int|12
suffix:semicolon
id|month
op_increment
)paren
r_if
c_cond
(paren
id|day_n
(braket
id|month
)braket
OG
id|nl_day
)paren
r_break
suffix:semicolon
)brace
op_star
id|date
op_assign
id|nl_day
op_minus
id|day_n
(braket
id|month
op_minus
l_int|1
)braket
op_plus
l_int|1
op_plus
(paren
id|month
op_lshift
l_int|5
)paren
op_plus
(paren
id|year
op_lshift
l_int|9
)paren
suffix:semicolon
)brace
multiline_comment|/* The following are taken from fs/ntfs/util.c */
DECL|macro|NTFS_TIME_OFFSET
mdefine_line|#define NTFS_TIME_OFFSET ((u64)(369*365 + 89) * 24 * 3600 * 10000000)
multiline_comment|/*&n; * Convert the NT UTC (based 1601-01-01, in hundred nanosecond units)&n; * into Unix UTC (based 1970-01-01, in seconds).&n; */
r_static
r_struct
id|timespec
DECL|function|smb_ntutc2unixutc
id|smb_ntutc2unixutc
c_func
(paren
id|u64
id|ntutc
)paren
(brace
r_struct
id|timespec
id|ts
suffix:semicolon
multiline_comment|/* FIXME: what about the timezone difference? */
multiline_comment|/* Subtract the NTFS time offset, then convert to 1s intervals. */
id|u64
id|t
op_assign
id|ntutc
op_minus
id|NTFS_TIME_OFFSET
suffix:semicolon
id|ts.tv_nsec
op_assign
id|do_div
c_func
(paren
id|t
comma
l_int|10000000
)paren
op_star
l_int|100
suffix:semicolon
id|ts.tv_sec
op_assign
id|t
suffix:semicolon
r_return
id|ts
suffix:semicolon
)brace
multiline_comment|/* Convert the Unix UTC into NT time */
r_static
id|u64
DECL|function|smb_unixutc2ntutc
id|smb_unixutc2ntutc
c_func
(paren
r_struct
id|timespec
id|ts
)paren
(brace
multiline_comment|/* Note: timezone conversion is probably wrong. */
multiline_comment|/* return ((u64)utc2local(server, t)) * 10000000 + NTFS_TIME_OFFSET; */
r_return
(paren
(paren
id|u64
)paren
id|ts.tv_sec
)paren
op_star
l_int|10000000
op_plus
id|ts.tv_nsec
op_div
l_int|100
op_plus
id|NTFS_TIME_OFFSET
suffix:semicolon
)brace
DECL|macro|MAX_FILE_MODE
mdefine_line|#define MAX_FILE_MODE&t;6
DECL|variable|file_mode
r_static
id|mode_t
id|file_mode
(braket
)braket
op_assign
(brace
id|S_IFREG
comma
id|S_IFDIR
comma
id|S_IFLNK
comma
id|S_IFCHR
comma
id|S_IFBLK
comma
id|S_IFIFO
comma
id|S_IFSOCK
)brace
suffix:semicolon
DECL|function|smb_filetype_to_mode
r_static
r_int
id|smb_filetype_to_mode
c_func
(paren
id|u32
id|filetype
)paren
(brace
r_if
c_cond
(paren
id|filetype
OG
id|MAX_FILE_MODE
)paren
(brace
id|PARANOIA
c_func
(paren
l_string|&quot;Filetype out of range: %d&bslash;n&quot;
comma
id|filetype
)paren
suffix:semicolon
r_return
id|S_IFREG
suffix:semicolon
)brace
r_return
id|file_mode
(braket
id|filetype
)braket
suffix:semicolon
)brace
DECL|function|smb_filetype_from_mode
r_static
id|u32
id|smb_filetype_from_mode
c_func
(paren
r_int
id|mode
)paren
(brace
r_if
c_cond
(paren
id|mode
op_amp
id|S_IFREG
)paren
r_return
id|UNIX_TYPE_FILE
suffix:semicolon
r_if
c_cond
(paren
id|mode
op_amp
id|S_IFDIR
)paren
r_return
id|UNIX_TYPE_DIR
suffix:semicolon
r_if
c_cond
(paren
id|mode
op_amp
id|S_IFLNK
)paren
r_return
id|UNIX_TYPE_SYMLINK
suffix:semicolon
r_if
c_cond
(paren
id|mode
op_amp
id|S_IFCHR
)paren
r_return
id|UNIX_TYPE_CHARDEV
suffix:semicolon
r_if
c_cond
(paren
id|mode
op_amp
id|S_IFBLK
)paren
r_return
id|UNIX_TYPE_BLKDEV
suffix:semicolon
r_if
c_cond
(paren
id|mode
op_amp
id|S_IFIFO
)paren
r_return
id|UNIX_TYPE_FIFO
suffix:semicolon
r_if
c_cond
(paren
id|mode
op_amp
id|S_IFSOCK
)paren
r_return
id|UNIX_TYPE_SOCKET
suffix:semicolon
r_return
id|UNIX_TYPE_UNKNOWN
suffix:semicolon
)brace
multiline_comment|/*****************************************************************************/
multiline_comment|/*                                                                           */
multiline_comment|/*  Support section.                                                         */
multiline_comment|/*                                                                           */
multiline_comment|/*****************************************************************************/
id|__u32
DECL|function|smb_len
id|smb_len
c_func
(paren
id|__u8
op_star
id|p
)paren
(brace
r_return
(paren
(paren
op_star
(paren
id|p
op_plus
l_int|1
)paren
op_amp
l_int|0x1
)paren
op_lshift
l_int|16L
)paren
op_or
(paren
op_star
(paren
id|p
op_plus
l_int|2
)paren
op_lshift
l_int|8L
)paren
op_or
op_star
(paren
id|p
op_plus
l_int|3
)paren
suffix:semicolon
)brace
r_static
id|__u16
DECL|function|smb_bcc
id|smb_bcc
c_func
(paren
id|__u8
op_star
id|packet
)paren
(brace
r_int
id|pos
op_assign
id|SMB_HEADER_LEN
op_plus
id|SMB_WCT
c_func
(paren
id|packet
)paren
op_star
r_sizeof
(paren
id|__u16
)paren
suffix:semicolon
r_return
id|WVAL
c_func
(paren
id|packet
comma
id|pos
)paren
suffix:semicolon
)brace
multiline_comment|/* smb_valid_packet: We check if packet fulfills the basic&n;   requirements of a smb packet */
r_static
r_int
DECL|function|smb_valid_packet
id|smb_valid_packet
c_func
(paren
id|__u8
op_star
id|packet
)paren
(brace
r_return
(paren
id|packet
(braket
l_int|4
)braket
op_eq
l_int|0xff
op_logical_and
id|packet
(braket
l_int|5
)braket
op_eq
l_char|&squot;S&squot;
op_logical_and
id|packet
(braket
l_int|6
)braket
op_eq
l_char|&squot;M&squot;
op_logical_and
id|packet
(braket
l_int|7
)braket
op_eq
l_char|&squot;B&squot;
op_logical_and
(paren
id|smb_len
c_func
(paren
id|packet
)paren
op_plus
l_int|4
op_eq
id|SMB_HEADER_LEN
op_plus
id|SMB_WCT
c_func
(paren
id|packet
)paren
op_star
l_int|2
op_plus
id|smb_bcc
c_func
(paren
id|packet
)paren
)paren
)paren
suffix:semicolon
)brace
multiline_comment|/* smb_verify: We check if we got the answer we expected, and if we&n;   got enough data. If bcc == -1, we don&squot;t care. */
r_static
r_int
DECL|function|smb_verify
id|smb_verify
c_func
(paren
id|__u8
op_star
id|packet
comma
r_int
id|command
comma
r_int
id|wct
comma
r_int
id|bcc
)paren
(brace
r_if
c_cond
(paren
id|SMB_CMD
c_func
(paren
id|packet
)paren
op_ne
id|command
)paren
r_goto
id|bad_command
suffix:semicolon
r_if
c_cond
(paren
id|SMB_WCT
c_func
(paren
id|packet
)paren
OL
id|wct
)paren
r_goto
id|bad_wct
suffix:semicolon
r_if
c_cond
(paren
id|bcc
op_ne
op_minus
l_int|1
op_logical_and
id|smb_bcc
c_func
(paren
id|packet
)paren
OL
id|bcc
)paren
r_goto
id|bad_bcc
suffix:semicolon
r_return
l_int|0
suffix:semicolon
id|bad_command
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;smb_verify: command=%x, SMB_CMD=%x??&bslash;n&quot;
comma
id|command
comma
id|SMB_CMD
c_func
(paren
id|packet
)paren
)paren
suffix:semicolon
r_goto
id|fail
suffix:semicolon
id|bad_wct
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;smb_verify: command=%x, wct=%d, SMB_WCT=%d??&bslash;n&quot;
comma
id|command
comma
id|wct
comma
id|SMB_WCT
c_func
(paren
id|packet
)paren
)paren
suffix:semicolon
r_goto
id|fail
suffix:semicolon
id|bad_bcc
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;smb_verify: command=%x, bcc=%d, SMB_BCC=%d??&bslash;n&quot;
comma
id|command
comma
id|bcc
comma
id|smb_bcc
c_func
(paren
id|packet
)paren
)paren
suffix:semicolon
id|fail
suffix:colon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
multiline_comment|/*&n; * Returns the maximum read or write size for the &quot;payload&quot;. Making all of the&n; * packet fit within the negotiated max_xmit size.&n; *&n; * N.B. Since this value is usually computed before locking the server,&n; * the server&squot;s packet size must never be decreased!&n; */
r_static
r_inline
r_int
DECL|function|smb_get_xmitsize
id|smb_get_xmitsize
c_func
(paren
r_struct
id|smb_sb_info
op_star
id|server
comma
r_int
id|overhead
)paren
(brace
r_return
id|server-&gt;opt.max_xmit
op_minus
id|overhead
suffix:semicolon
)brace
multiline_comment|/*&n; * Calculate the maximum read size&n; */
r_int
DECL|function|smb_get_rsize
id|smb_get_rsize
c_func
(paren
r_struct
id|smb_sb_info
op_star
id|server
)paren
(brace
multiline_comment|/* readX has 12 parameters, read has 5 */
r_int
id|overhead
op_assign
id|SMB_HEADER_LEN
op_plus
l_int|12
op_star
r_sizeof
(paren
id|__u16
)paren
op_plus
l_int|2
op_plus
l_int|1
op_plus
l_int|2
suffix:semicolon
r_int
id|size
op_assign
id|smb_get_xmitsize
c_func
(paren
id|server
comma
id|overhead
)paren
suffix:semicolon
id|VERBOSE
c_func
(paren
l_string|&quot;xmit=%d, size=%d&bslash;n&quot;
comma
id|server-&gt;opt.max_xmit
comma
id|size
)paren
suffix:semicolon
r_return
id|size
suffix:semicolon
)brace
multiline_comment|/*&n; * Calculate the maximum write size&n; */
r_int
DECL|function|smb_get_wsize
id|smb_get_wsize
c_func
(paren
r_struct
id|smb_sb_info
op_star
id|server
)paren
(brace
multiline_comment|/* writeX has 14 parameters, write has 5 */
r_int
id|overhead
op_assign
id|SMB_HEADER_LEN
op_plus
l_int|14
op_star
r_sizeof
(paren
id|__u16
)paren
op_plus
l_int|2
op_plus
l_int|1
op_plus
l_int|2
suffix:semicolon
r_int
id|size
op_assign
id|smb_get_xmitsize
c_func
(paren
id|server
comma
id|overhead
)paren
suffix:semicolon
id|VERBOSE
c_func
(paren
l_string|&quot;xmit=%d, size=%d&bslash;n&quot;
comma
id|server-&gt;opt.max_xmit
comma
id|size
)paren
suffix:semicolon
r_return
id|size
suffix:semicolon
)brace
multiline_comment|/*&n; * Convert SMB error codes to -E... errno values.&n; */
r_int
DECL|function|smb_errno
id|smb_errno
c_func
(paren
r_struct
id|smb_request
op_star
id|req
)paren
(brace
r_int
id|errcls
op_assign
id|req-&gt;rq_rcls
suffix:semicolon
r_int
id|error
op_assign
id|req-&gt;rq_err
suffix:semicolon
r_char
op_star
r_class
op_assign
l_string|&quot;Unknown&quot;
suffix:semicolon
id|VERBOSE
c_func
(paren
l_string|&quot;errcls %d  code %d  from command 0x%x&bslash;n&quot;
comma
id|errcls
comma
id|error
comma
id|SMB_CMD
c_func
(paren
id|req-&gt;rq_header
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|errcls
op_eq
id|ERRDOS
)paren
(brace
r_switch
c_cond
(paren
id|error
)paren
(brace
r_case
id|ERRbadfunc
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
r_case
id|ERRbadfile
suffix:colon
r_case
id|ERRbadpath
suffix:colon
r_return
op_minus
id|ENOENT
suffix:semicolon
r_case
id|ERRnofids
suffix:colon
r_return
op_minus
id|EMFILE
suffix:semicolon
r_case
id|ERRnoaccess
suffix:colon
r_return
op_minus
id|EACCES
suffix:semicolon
r_case
id|ERRbadfid
suffix:colon
r_return
op_minus
id|EBADF
suffix:semicolon
r_case
id|ERRbadmcb
suffix:colon
r_return
op_minus
id|EREMOTEIO
suffix:semicolon
r_case
id|ERRnomem
suffix:colon
r_return
op_minus
id|ENOMEM
suffix:semicolon
r_case
id|ERRbadmem
suffix:colon
r_return
op_minus
id|EFAULT
suffix:semicolon
r_case
id|ERRbadenv
suffix:colon
r_case
id|ERRbadformat
suffix:colon
r_return
op_minus
id|EREMOTEIO
suffix:semicolon
r_case
id|ERRbadaccess
suffix:colon
r_return
op_minus
id|EACCES
suffix:semicolon
r_case
id|ERRbaddata
suffix:colon
r_return
op_minus
id|E2BIG
suffix:semicolon
r_case
id|ERRbaddrive
suffix:colon
r_return
op_minus
id|ENXIO
suffix:semicolon
r_case
id|ERRremcd
suffix:colon
r_return
op_minus
id|EREMOTEIO
suffix:semicolon
r_case
id|ERRdiffdevice
suffix:colon
r_return
op_minus
id|EXDEV
suffix:semicolon
r_case
id|ERRnofiles
suffix:colon
r_return
op_minus
id|ENOENT
suffix:semicolon
r_case
id|ERRbadshare
suffix:colon
r_return
op_minus
id|ETXTBSY
suffix:semicolon
r_case
id|ERRlock
suffix:colon
r_return
op_minus
id|EDEADLK
suffix:semicolon
r_case
id|ERRfilexists
suffix:colon
r_return
op_minus
id|EEXIST
suffix:semicolon
r_case
id|ERROR_INVALID_PARAMETER
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
r_case
id|ERROR_DISK_FULL
suffix:colon
r_return
op_minus
id|ENOSPC
suffix:semicolon
r_case
id|ERROR_INVALID_NAME
suffix:colon
r_return
op_minus
id|ENOENT
suffix:semicolon
r_case
id|ERROR_DIR_NOT_EMPTY
suffix:colon
r_return
op_minus
id|ENOTEMPTY
suffix:semicolon
r_case
id|ERROR_NOT_LOCKED
suffix:colon
r_return
op_minus
id|ENOLCK
suffix:semicolon
r_case
id|ERROR_ALREADY_EXISTS
suffix:colon
r_return
op_minus
id|EEXIST
suffix:semicolon
r_default
suffix:colon
r_class
op_assign
l_string|&quot;ERRDOS&quot;
suffix:semicolon
r_goto
id|err_unknown
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|errcls
op_eq
id|ERRSRV
)paren
(brace
r_switch
c_cond
(paren
id|error
)paren
(brace
multiline_comment|/* N.B. This is wrong ... EIO ? */
r_case
id|ERRerror
suffix:colon
r_return
op_minus
id|ENFILE
suffix:semicolon
r_case
id|ERRbadpw
suffix:colon
r_return
op_minus
id|EINVAL
suffix:semicolon
r_case
id|ERRbadtype
suffix:colon
r_case
id|ERRtimeout
suffix:colon
r_return
op_minus
id|EIO
suffix:semicolon
r_case
id|ERRaccess
suffix:colon
r_return
op_minus
id|EACCES
suffix:semicolon
multiline_comment|/*&n;&t;&t; * This is a fatal error, as it means the &quot;tree ID&quot;&n;&t;&t; * for this connection is no longer valid. We map&n;&t;&t; * to a special error code and get a new connection.&n;&t;&t; */
r_case
id|ERRinvnid
suffix:colon
r_return
op_minus
id|EBADSLT
suffix:semicolon
r_default
suffix:colon
r_class
op_assign
l_string|&quot;ERRSRV&quot;
suffix:semicolon
r_goto
id|err_unknown
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|errcls
op_eq
id|ERRHRD
)paren
(brace
r_switch
c_cond
(paren
id|error
)paren
(brace
r_case
id|ERRnowrite
suffix:colon
r_return
op_minus
id|EROFS
suffix:semicolon
r_case
id|ERRbadunit
suffix:colon
r_return
op_minus
id|ENODEV
suffix:semicolon
r_case
id|ERRnotready
suffix:colon
r_return
op_minus
id|EUCLEAN
suffix:semicolon
r_case
id|ERRbadcmd
suffix:colon
r_case
id|ERRdata
suffix:colon
r_return
op_minus
id|EIO
suffix:semicolon
r_case
id|ERRbadreq
suffix:colon
r_return
op_minus
id|ERANGE
suffix:semicolon
r_case
id|ERRbadshare
suffix:colon
r_return
op_minus
id|ETXTBSY
suffix:semicolon
r_case
id|ERRlock
suffix:colon
r_return
op_minus
id|EDEADLK
suffix:semicolon
r_case
id|ERRdiskfull
suffix:colon
r_return
op_minus
id|ENOSPC
suffix:semicolon
r_default
suffix:colon
r_class
op_assign
l_string|&quot;ERRHRD&quot;
suffix:semicolon
r_goto
id|err_unknown
suffix:semicolon
)brace
)brace
r_else
r_if
c_cond
(paren
id|errcls
op_eq
id|ERRCMD
)paren
(brace
r_class
op_assign
l_string|&quot;ERRCMD&quot;
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|errcls
op_eq
id|SUCCESS
)paren
(brace
r_return
l_int|0
suffix:semicolon
multiline_comment|/* This is the only valid 0 return */
)brace
id|err_unknown
suffix:colon
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;smb_errno: class %s, code %d from command 0x%x&bslash;n&quot;
comma
r_class
comma
id|error
comma
id|SMB_CMD
c_func
(paren
id|req-&gt;rq_header
)paren
)paren
suffix:semicolon
r_return
op_minus
id|EIO
suffix:semicolon
)brace
multiline_comment|/* smb_request_ok: We expect the server to be locked. Then we do the&n;   request and check the answer completely. When smb_request_ok&n;   returns 0, you can be quite sure that everything went well. When&n;   the answer is &lt;=0, the returned number is a valid unix errno. */
r_static
r_int
DECL|function|smb_request_ok
id|smb_request_ok
c_func
(paren
r_struct
id|smb_request
op_star
id|req
comma
r_int
id|command
comma
r_int
id|wct
comma
r_int
id|bcc
)paren
(brace
r_int
id|result
suffix:semicolon
id|req-&gt;rq_resp_wct
op_assign
id|wct
suffix:semicolon
id|req-&gt;rq_resp_bcc
op_assign
id|bcc
suffix:semicolon
id|result
op_assign
id|smb_add_request
c_func
(paren
id|req
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_ne
l_int|0
)paren
(brace
id|DEBUG1
c_func
(paren
l_string|&quot;smb_request failed&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|smb_valid_packet
c_func
(paren
id|req-&gt;rq_header
)paren
op_ne
l_int|0
)paren
(brace
id|PARANOIA
c_func
(paren
l_string|&quot;invalid packet!&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|result
op_assign
id|smb_verify
c_func
(paren
id|req-&gt;rq_header
comma
id|command
comma
id|wct
comma
id|bcc
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/*&n; * This implements the NEWCONN ioctl. It installs the server pid,&n; * sets server-&gt;state to CONN_VALID, and wakes up the waiting process.&n; */
r_int
DECL|function|smb_newconn
id|smb_newconn
c_func
(paren
r_struct
id|smb_sb_info
op_star
id|server
comma
r_struct
id|smb_conn_opt
op_star
id|opt
)paren
(brace
r_struct
id|file
op_star
id|filp
suffix:semicolon
r_struct
id|sock
op_star
id|sk
suffix:semicolon
r_int
id|error
suffix:semicolon
id|VERBOSE
c_func
(paren
l_string|&quot;fd=%d, pid=%d&bslash;n&quot;
comma
id|opt-&gt;fd
comma
id|current-&gt;pid
)paren
suffix:semicolon
id|smb_lock_server
c_func
(paren
id|server
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Make sure we don&squot;t already have a valid connection ...&n;&t; */
id|error
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|server-&gt;state
op_eq
id|CONN_VALID
)paren
r_goto
id|out
suffix:semicolon
id|error
op_assign
op_minus
id|EACCES
suffix:semicolon
r_if
c_cond
(paren
id|current-&gt;uid
op_ne
id|server-&gt;mnt-&gt;mounted_uid
op_logical_and
op_logical_neg
id|capable
c_func
(paren
id|CAP_SYS_ADMIN
)paren
)paren
r_goto
id|out
suffix:semicolon
id|error
op_assign
op_minus
id|EBADF
suffix:semicolon
id|filp
op_assign
id|fget
c_func
(paren
id|opt-&gt;fd
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|filp
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|smb_valid_socket
c_func
(paren
id|filp-&gt;f_dentry-&gt;d_inode
)paren
)paren
r_goto
id|out_putf
suffix:semicolon
id|server-&gt;sock_file
op_assign
id|filp
suffix:semicolon
id|server-&gt;conn_pid
op_assign
id|current-&gt;pid
suffix:semicolon
id|server-&gt;opt
op_assign
op_star
id|opt
suffix:semicolon
id|server-&gt;generation
op_add_assign
l_int|1
suffix:semicolon
id|server-&gt;state
op_assign
id|CONN_VALID
suffix:semicolon
id|error
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|server-&gt;conn_error
)paren
(brace
multiline_comment|/*&n;&t;&t; * conn_error is the returncode we originally decided to&n;&t;&t; * drop the old connection on. This message should be positive&n;&t;&t; * and not make people ask questions on why smbfs is printing&n;&t;&t; * error messages ...&n;&t;&t; */
id|printk
c_func
(paren
id|KERN_INFO
l_string|&quot;SMB connection re-established (%d)&bslash;n&quot;
comma
id|server-&gt;conn_error
)paren
suffix:semicolon
id|server-&gt;conn_error
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Store the server in sock user_data (Only used by sunrpc)&n;&t; */
id|sk
op_assign
id|SOCKET_I
c_func
(paren
id|filp-&gt;f_dentry-&gt;d_inode
)paren
op_member_access_from_pointer
id|sk
suffix:semicolon
id|sk-&gt;user_data
op_assign
id|server
suffix:semicolon
multiline_comment|/* chain into the data_ready callback */
id|server-&gt;data_ready
op_assign
id|xchg
c_func
(paren
op_amp
id|sk-&gt;data_ready
comma
id|smb_data_ready
)paren
suffix:semicolon
multiline_comment|/* check if we have an old smbmount that uses seconds for the &n;&t;   serverzone */
r_if
c_cond
(paren
id|server-&gt;opt.serverzone
OG
l_int|12
op_star
l_int|60
op_logical_or
id|server-&gt;opt.serverzone
OL
op_minus
l_int|12
op_star
l_int|60
)paren
id|server-&gt;opt.serverzone
op_div_assign
l_int|60
suffix:semicolon
multiline_comment|/* now that we have an established connection we can detect the server&n;&t;   type and enable bug workarounds */
r_if
c_cond
(paren
id|server-&gt;opt.protocol
OL
id|SMB_PROTOCOL_LANMAN2
)paren
id|install_ops
c_func
(paren
id|server-&gt;ops
comma
op_amp
id|smb_ops_core
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|server-&gt;opt.protocol
op_eq
id|SMB_PROTOCOL_LANMAN2
)paren
id|install_ops
c_func
(paren
id|server-&gt;ops
comma
op_amp
id|smb_ops_os2
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|server-&gt;opt.protocol
op_eq
id|SMB_PROTOCOL_NT1
op_logical_and
(paren
id|server-&gt;opt.max_xmit
OL
l_int|0x1000
)paren
op_logical_and
op_logical_neg
(paren
id|server-&gt;opt.capabilities
op_amp
id|SMB_CAP_NT_SMBS
)paren
)paren
(brace
multiline_comment|/* FIXME: can we kill the WIN95 flag now? */
id|server-&gt;mnt-&gt;flags
op_or_assign
id|SMB_MOUNT_WIN95
suffix:semicolon
id|VERBOSE
c_func
(paren
l_string|&quot;detected WIN95 server&bslash;n&quot;
)paren
suffix:semicolon
id|install_ops
c_func
(paren
id|server-&gt;ops
comma
op_amp
id|smb_ops_win95
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t; * Samba has max_xmit 65535&n;&t;&t; * NT4spX has max_xmit 4536 (or something like that)&n;&t;&t; * win2k has ...&n;&t;&t; */
id|VERBOSE
c_func
(paren
l_string|&quot;detected NT1 (Samba, NT4/5) server&bslash;n&quot;
)paren
suffix:semicolon
id|install_ops
c_func
(paren
id|server-&gt;ops
comma
op_amp
id|smb_ops_winNT
)paren
suffix:semicolon
)brace
multiline_comment|/* FIXME: the win9x code wants to modify these ... (seek/trunc bug) */
r_if
c_cond
(paren
id|server-&gt;mnt-&gt;flags
op_amp
id|SMB_MOUNT_OLDATTR
)paren
(brace
id|server-&gt;ops-&gt;getattr
op_assign
id|smb_proc_getattr_core
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|server-&gt;mnt-&gt;flags
op_amp
id|SMB_MOUNT_DIRATTR
)paren
(brace
id|server-&gt;ops-&gt;getattr
op_assign
id|smb_proc_getattr_ff
suffix:semicolon
)brace
multiline_comment|/* Decode server capabilities */
r_if
c_cond
(paren
id|server-&gt;opt.capabilities
op_amp
id|SMB_CAP_LARGE_FILES
)paren
(brace
multiline_comment|/* Should be ok to set this now, as no one can access the&n;&t;&t;   mount until the connection has been established. */
id|SB_of
c_func
(paren
id|server
)paren
op_member_access_from_pointer
id|s_maxbytes
op_assign
op_complement
l_int|0ULL
op_rshift
l_int|1
suffix:semicolon
id|VERBOSE
c_func
(paren
l_string|&quot;LFS enabled&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|server-&gt;opt.capabilities
op_amp
id|SMB_CAP_UNICODE
)paren
(brace
id|server-&gt;mnt-&gt;flags
op_or_assign
id|SMB_MOUNT_UNICODE
suffix:semicolon
id|VERBOSE
c_func
(paren
l_string|&quot;Unicode enabled&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_else
(brace
id|server-&gt;mnt-&gt;flags
op_and_assign
op_complement
id|SMB_MOUNT_UNICODE
suffix:semicolon
)brace
macro_line|#if 0
multiline_comment|/* flags we may test for other patches ... */
r_if
c_cond
(paren
id|server-&gt;opt.capabilities
op_amp
id|SMB_CAP_LARGE_READX
)paren
(brace
id|VERBOSE
c_func
(paren
l_string|&quot;Large reads enabled&bslash;n&quot;
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|server-&gt;opt.capabilities
op_amp
id|SMB_CAP_LARGE_WRITEX
)paren
(brace
id|VERBOSE
c_func
(paren
l_string|&quot;Large writes enabled&bslash;n&quot;
)paren
suffix:semicolon
)brace
macro_line|#endif
r_if
c_cond
(paren
id|server-&gt;opt.capabilities
op_amp
id|SMB_CAP_UNIX
)paren
(brace
r_struct
id|inode
op_star
id|inode
suffix:semicolon
id|VERBOSE
c_func
(paren
l_string|&quot;Using UNIX CIFS extensions&bslash;n&quot;
)paren
suffix:semicolon
id|install_ops
c_func
(paren
id|server-&gt;ops
comma
op_amp
id|smb_ops_unix
)paren
suffix:semicolon
id|inode
op_assign
id|SB_of
c_func
(paren
id|server
)paren
op_member_access_from_pointer
id|s_root-&gt;d_inode
suffix:semicolon
r_if
c_cond
(paren
id|inode
)paren
id|inode-&gt;i_op
op_assign
op_amp
id|smb_dir_inode_operations_unix
suffix:semicolon
)brace
id|VERBOSE
c_func
(paren
l_string|&quot;protocol=%d, max_xmit=%d, pid=%d capabilities=0x%x&bslash;n&quot;
comma
id|server-&gt;opt.protocol
comma
id|server-&gt;opt.max_xmit
comma
id|server-&gt;conn_pid
comma
id|server-&gt;opt.capabilities
)paren
suffix:semicolon
multiline_comment|/* FIXME: this really should be done by smbmount. */
r_if
c_cond
(paren
id|server-&gt;opt.max_xmit
OG
id|SMB_MAX_PACKET_SIZE
)paren
(brace
id|server-&gt;opt.max_xmit
op_assign
id|SMB_MAX_PACKET_SIZE
suffix:semicolon
)brace
id|smb_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
id|smbiod_wake_up
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|server-&gt;opt.capabilities
op_amp
id|SMB_CAP_UNIX
)paren
id|smb_proc_query_cifsunix
c_func
(paren
id|server
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
id|out
suffix:colon
id|smb_unlock_server
c_func
(paren
id|server
)paren
suffix:semicolon
id|smbiod_wake_up
c_func
(paren
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
id|out_putf
suffix:colon
id|fput
c_func
(paren
id|filp
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* smb_setup_header: We completely set up the packet. You only have to&n;   insert the command-specific fields */
id|__u8
op_star
DECL|function|smb_setup_header
id|smb_setup_header
c_func
(paren
r_struct
id|smb_request
op_star
id|req
comma
id|__u8
id|command
comma
id|__u16
id|wct
comma
id|__u16
id|bcc
)paren
(brace
id|__u32
id|xmit_len
op_assign
id|SMB_HEADER_LEN
op_plus
id|wct
op_star
r_sizeof
(paren
id|__u16
)paren
op_plus
id|bcc
op_plus
l_int|2
suffix:semicolon
id|__u8
op_star
id|p
op_assign
id|req-&gt;rq_header
suffix:semicolon
r_struct
id|smb_sb_info
op_star
id|server
op_assign
id|req-&gt;rq_server
suffix:semicolon
id|p
op_assign
id|smb_encode_smb_length
c_func
(paren
id|p
comma
id|xmit_len
op_minus
l_int|4
)paren
suffix:semicolon
op_star
id|p
op_increment
op_assign
l_int|0xff
suffix:semicolon
op_star
id|p
op_increment
op_assign
l_char|&squot;S&squot;
suffix:semicolon
op_star
id|p
op_increment
op_assign
l_char|&squot;M&squot;
suffix:semicolon
op_star
id|p
op_increment
op_assign
l_char|&squot;B&squot;
suffix:semicolon
op_star
id|p
op_increment
op_assign
id|command
suffix:semicolon
id|memset
c_func
(paren
id|p
comma
l_char|&squot;&bslash;0&squot;
comma
l_int|19
)paren
suffix:semicolon
id|p
op_add_assign
l_int|19
suffix:semicolon
id|p
op_add_assign
l_int|8
suffix:semicolon
multiline_comment|/* FIXME: the request will fail if the &squot;tid&squot; is changed. This&n;&t;   should perhaps be set just before transmitting ... */
id|WSET
c_func
(paren
id|req-&gt;rq_header
comma
id|smb_tid
comma
id|server-&gt;opt.tid
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|req-&gt;rq_header
comma
id|smb_pid
comma
l_int|1
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|req-&gt;rq_header
comma
id|smb_uid
comma
id|server-&gt;opt.server_uid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|server-&gt;opt.protocol
OG
id|SMB_PROTOCOL_CORE
)paren
(brace
r_int
id|flags
op_assign
id|SMB_FLAGS_CASELESS_PATHNAMES
suffix:semicolon
r_int
id|flags2
op_assign
id|SMB_FLAGS2_LONG_PATH_COMPONENTS
op_or
id|SMB_FLAGS2_EXTENDED_ATTRIBUTES
suffix:semicolon
multiline_comment|/* EA? not really ... */
op_star
(paren
id|req-&gt;rq_header
op_plus
id|smb_flg
)paren
op_assign
id|flags
suffix:semicolon
r_if
c_cond
(paren
id|server-&gt;mnt-&gt;flags
op_amp
id|SMB_MOUNT_UNICODE
)paren
id|flags2
op_or_assign
id|SMB_FLAGS2_UNICODE_STRINGS
suffix:semicolon
id|WSET
c_func
(paren
id|req-&gt;rq_header
comma
id|smb_flg2
comma
id|flags2
)paren
suffix:semicolon
)brace
op_star
id|p
op_increment
op_assign
id|wct
suffix:semicolon
multiline_comment|/* wct */
id|p
op_add_assign
l_int|2
op_star
id|wct
suffix:semicolon
id|WSET
c_func
(paren
id|p
comma
l_int|0
comma
id|bcc
)paren
suffix:semicolon
multiline_comment|/* Include the header in the data to send */
id|req-&gt;rq_iovlen
op_assign
l_int|1
suffix:semicolon
id|req-&gt;rq_iov
(braket
l_int|0
)braket
dot
id|iov_base
op_assign
id|req-&gt;rq_header
suffix:semicolon
id|req-&gt;rq_iov
(braket
l_int|0
)braket
dot
id|iov_len
op_assign
id|xmit_len
op_minus
id|bcc
suffix:semicolon
r_return
id|req-&gt;rq_buffer
suffix:semicolon
)brace
r_static
r_void
DECL|function|smb_setup_bcc
id|smb_setup_bcc
c_func
(paren
r_struct
id|smb_request
op_star
id|req
comma
id|__u8
op_star
id|p
)paren
(brace
id|u16
id|bcc
op_assign
id|p
op_minus
id|req-&gt;rq_buffer
suffix:semicolon
id|u8
op_star
id|pbcc
op_assign
id|req-&gt;rq_header
op_plus
id|SMB_HEADER_LEN
op_plus
l_int|2
op_star
id|SMB_WCT
c_func
(paren
id|req-&gt;rq_header
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|pbcc
comma
l_int|0
comma
id|bcc
)paren
suffix:semicolon
id|smb_encode_smb_length
c_func
(paren
id|req-&gt;rq_header
comma
id|SMB_HEADER_LEN
op_plus
l_int|2
op_star
id|SMB_WCT
c_func
(paren
id|req-&gt;rq_header
)paren
op_minus
l_int|2
op_plus
id|bcc
)paren
suffix:semicolon
multiline_comment|/* Include the &quot;bytes&quot; in the data to send */
id|req-&gt;rq_iovlen
op_assign
l_int|2
suffix:semicolon
id|req-&gt;rq_iov
(braket
l_int|1
)braket
dot
id|iov_base
op_assign
id|req-&gt;rq_buffer
suffix:semicolon
id|req-&gt;rq_iov
(braket
l_int|1
)braket
dot
id|iov_len
op_assign
id|bcc
suffix:semicolon
)brace
r_static
r_int
DECL|function|smb_proc_seek
id|smb_proc_seek
c_func
(paren
r_struct
id|smb_sb_info
op_star
id|server
comma
id|__u16
id|fileid
comma
id|__u16
id|mode
comma
id|off_t
id|offset
)paren
(brace
r_int
id|result
suffix:semicolon
r_struct
id|smb_request
op_star
id|req
suffix:semicolon
id|result
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|req
op_assign
id|smb_alloc_request
c_func
(paren
id|server
comma
l_int|0
)paren
)paren
)paren
r_goto
id|out
suffix:semicolon
id|smb_setup_header
c_func
(paren
id|req
comma
id|SMBlseek
comma
l_int|4
comma
l_int|0
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|req-&gt;rq_header
comma
id|smb_vwv0
comma
id|fileid
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|req-&gt;rq_header
comma
id|smb_vwv1
comma
id|mode
)paren
suffix:semicolon
id|DSET
c_func
(paren
id|req-&gt;rq_header
comma
id|smb_vwv2
comma
id|offset
)paren
suffix:semicolon
id|req-&gt;rq_flags
op_or_assign
id|SMB_REQ_NORETRY
suffix:semicolon
id|result
op_assign
id|smb_request_ok
c_func
(paren
id|req
comma
id|SMBlseek
comma
l_int|2
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
(brace
id|result
op_assign
l_int|0
suffix:semicolon
r_goto
id|out_free
suffix:semicolon
)brace
id|result
op_assign
id|DVAL
c_func
(paren
id|req-&gt;rq_header
comma
id|smb_vwv0
)paren
suffix:semicolon
id|out_free
suffix:colon
id|smb_rput
c_func
(paren
id|req
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|result
suffix:semicolon
)brace
r_static
r_int
DECL|function|smb_proc_open
id|smb_proc_open
c_func
(paren
r_struct
id|smb_sb_info
op_star
id|server
comma
r_struct
id|dentry
op_star
id|dentry
comma
r_int
id|wish
)paren
(brace
r_struct
id|inode
op_star
id|ino
op_assign
id|dentry-&gt;d_inode
suffix:semicolon
r_struct
id|smb_inode_info
op_star
id|ei
op_assign
id|SMB_I
c_func
(paren
id|ino
)paren
suffix:semicolon
r_int
id|mode
comma
id|read_write
op_assign
l_int|0x42
comma
id|read_only
op_assign
l_int|0x40
suffix:semicolon
r_int
id|res
suffix:semicolon
r_char
op_star
id|p
suffix:semicolon
r_struct
id|smb_request
op_star
id|req
suffix:semicolon
multiline_comment|/*&n;&t; * Attempt to open r/w, unless there are no write privileges.&n;&t; */
id|mode
op_assign
id|read_write
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|ino-&gt;i_mode
op_amp
(paren
id|S_IWUSR
op_or
id|S_IWGRP
op_or
id|S_IWOTH
)paren
)paren
)paren
id|mode
op_assign
id|read_only
suffix:semicolon
macro_line|#if 0
multiline_comment|/* FIXME: why is this code not in? below we fix it so that a caller&n;&t;   wanting RO doesn&squot;t get RW. smb_revalidate_inode does some &n;&t;   optimization based on access mode. tail -f needs it to be correct.&n;&n;&t;   We must open rw since we don&squot;t do the open if called a second time&n;&t;   with different &squot;wish&squot;. Is that not supported by smb servers? */
r_if
c_cond
(paren
op_logical_neg
(paren
id|wish
op_amp
(paren
id|O_WRONLY
op_or
id|O_RDWR
)paren
)paren
)paren
id|mode
op_assign
id|read_only
suffix:semicolon
macro_line|#endif
id|res
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|req
op_assign
id|smb_alloc_request
c_func
(paren
id|server
comma
id|PAGE_SIZE
)paren
)paren
)paren
r_goto
id|out
suffix:semicolon
id|retry
suffix:colon
id|p
op_assign
id|smb_setup_header
c_func
(paren
id|req
comma
id|SMBopen
comma
l_int|2
comma
l_int|0
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|req-&gt;rq_header
comma
id|smb_vwv0
comma
id|mode
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|req-&gt;rq_header
comma
id|smb_vwv1
comma
id|aSYSTEM
op_or
id|aHIDDEN
op_or
id|aDIR
)paren
suffix:semicolon
id|res
op_assign
id|smb_simple_encode_path
c_func
(paren
id|req
comma
op_amp
id|p
comma
id|dentry
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
OL
l_int|0
)paren
r_goto
id|out_free
suffix:semicolon
id|smb_setup_bcc
c_func
(paren
id|req
comma
id|p
)paren
suffix:semicolon
id|res
op_assign
id|smb_request_ok
c_func
(paren
id|req
comma
id|SMBopen
comma
l_int|7
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|res
op_ne
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|mode
op_eq
id|read_write
op_logical_and
(paren
id|res
op_eq
op_minus
id|EACCES
op_logical_or
id|res
op_eq
op_minus
id|ETXTBSY
op_logical_or
id|res
op_eq
op_minus
id|EROFS
)paren
)paren
(brace
id|VERBOSE
c_func
(paren
l_string|&quot;%s/%s R/W failed, error=%d, retrying R/O&bslash;n&quot;
comma
id|DENTRY_PATH
c_func
(paren
id|dentry
)paren
comma
id|res
)paren
suffix:semicolon
id|mode
op_assign
id|read_only
suffix:semicolon
id|req-&gt;rq_flags
op_assign
l_int|0
suffix:semicolon
r_goto
id|retry
suffix:semicolon
)brace
r_goto
id|out_free
suffix:semicolon
)brace
multiline_comment|/* We should now have data in vwv[0..6]. */
id|ei-&gt;fileid
op_assign
id|WVAL
c_func
(paren
id|req-&gt;rq_header
comma
id|smb_vwv0
)paren
suffix:semicolon
id|ei-&gt;attr
op_assign
id|WVAL
c_func
(paren
id|req-&gt;rq_header
comma
id|smb_vwv1
)paren
suffix:semicolon
multiline_comment|/* smb_vwv2 has mtime */
multiline_comment|/* smb_vwv4 has size  */
id|ei-&gt;access
op_assign
(paren
id|WVAL
c_func
(paren
id|req-&gt;rq_header
comma
id|smb_vwv6
)paren
op_amp
id|SMB_ACCMASK
)paren
suffix:semicolon
id|ei-&gt;open
op_assign
id|server-&gt;generation
suffix:semicolon
id|out_free
suffix:colon
id|smb_rput
c_func
(paren
id|req
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|res
suffix:semicolon
)brace
multiline_comment|/*&n; * Make sure the file is open, and check that the access&n; * is compatible with the desired access.&n; */
r_int
DECL|function|smb_open
id|smb_open
c_func
(paren
r_struct
id|dentry
op_star
id|dentry
comma
r_int
id|wish
)paren
(brace
r_struct
id|inode
op_star
id|inode
op_assign
id|dentry-&gt;d_inode
suffix:semicolon
r_int
id|result
suffix:semicolon
id|__u16
id|access
suffix:semicolon
id|result
op_assign
op_minus
id|ENOENT
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|inode
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;smb_open: no inode for dentry %s/%s&bslash;n&quot;
comma
id|DENTRY_PATH
c_func
(paren
id|dentry
)paren
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|smb_is_open
c_func
(paren
id|inode
)paren
)paren
(brace
r_struct
id|smb_sb_info
op_star
id|server
op_assign
id|server_from_inode
c_func
(paren
id|inode
)paren
suffix:semicolon
id|result
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|smb_is_open
c_func
(paren
id|inode
)paren
)paren
id|result
op_assign
id|smb_proc_open
c_func
(paren
id|server
comma
id|dentry
comma
id|wish
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
)paren
(brace
id|PARANOIA
c_func
(paren
l_string|&quot;%s/%s open failed, result=%d&bslash;n&quot;
comma
id|DENTRY_PATH
c_func
(paren
id|dentry
)paren
comma
id|result
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * A successful open means the path is still valid ...&n;&t;&t; */
id|smb_renew_times
c_func
(paren
id|dentry
)paren
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Check whether the access is compatible with the desired mode.&n;&t; */
id|result
op_assign
l_int|0
suffix:semicolon
id|access
op_assign
id|SMB_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|access
suffix:semicolon
r_if
c_cond
(paren
id|access
op_ne
id|wish
op_logical_and
id|access
op_ne
id|SMB_O_RDWR
)paren
(brace
id|PARANOIA
c_func
(paren
l_string|&quot;%s/%s access denied, access=%x, wish=%x&bslash;n&quot;
comma
id|DENTRY_PATH
c_func
(paren
id|dentry
)paren
comma
id|access
comma
id|wish
)paren
suffix:semicolon
id|result
op_assign
op_minus
id|EACCES
suffix:semicolon
)brace
id|out
suffix:colon
r_return
id|result
suffix:semicolon
)brace
r_static
r_int
DECL|function|smb_proc_close
id|smb_proc_close
c_func
(paren
r_struct
id|smb_sb_info
op_star
id|server
comma
id|__u16
id|fileid
comma
id|__u32
id|mtime
)paren
(brace
r_struct
id|smb_request
op_star
id|req
suffix:semicolon
r_int
id|result
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|req
op_assign
id|smb_alloc_request
c_func
(paren
id|server
comma
l_int|0
)paren
)paren
)paren
r_goto
id|out
suffix:semicolon
id|smb_setup_header
c_func
(paren
id|req
comma
id|SMBclose
comma
l_int|3
comma
l_int|0
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|req-&gt;rq_header
comma
id|smb_vwv0
comma
id|fileid
)paren
suffix:semicolon
id|DSET
c_func
(paren
id|req-&gt;rq_header
comma
id|smb_vwv1
comma
id|utc2local
c_func
(paren
id|server
comma
id|mtime
)paren
)paren
suffix:semicolon
id|req-&gt;rq_flags
op_or_assign
id|SMB_REQ_NORETRY
suffix:semicolon
id|result
op_assign
id|smb_request_ok
c_func
(paren
id|req
comma
id|SMBclose
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|smb_rput
c_func
(paren
id|req
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/*&n; * Win NT 4.0 has an apparent bug in that it fails to update the&n; * modify time when writing to a file. As a workaround, we update&n; * both modify and access time locally, and post the times to the&n; * server when closing the file.&n; */
r_static
r_int
DECL|function|smb_proc_close_inode
id|smb_proc_close_inode
c_func
(paren
r_struct
id|smb_sb_info
op_star
id|server
comma
r_struct
id|inode
op_star
id|ino
)paren
(brace
r_struct
id|smb_inode_info
op_star
id|ei
op_assign
id|SMB_I
c_func
(paren
id|ino
)paren
suffix:semicolon
r_int
id|result
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|smb_is_open
c_func
(paren
id|ino
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t; * We clear the open flag in advance, in case another&n; &t;&t; * process observes the value while we block below.&n;&t;&t; */
id|ei-&gt;open
op_assign
l_int|0
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Kludge alert: SMB timestamps are accurate only to&n;&t;&t; * two seconds ... round the times to avoid needless&n;&t;&t; * cache invalidations!&n;&t;&t; */
r_if
c_cond
(paren
id|ino-&gt;i_mtime.tv_sec
op_amp
l_int|1
)paren
(brace
id|ino-&gt;i_mtime.tv_sec
op_decrement
suffix:semicolon
id|ino-&gt;i_mtime.tv_nsec
op_assign
l_int|0
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ino-&gt;i_atime.tv_sec
op_amp
l_int|1
)paren
(brace
id|ino-&gt;i_atime.tv_sec
op_decrement
suffix:semicolon
id|ino-&gt;i_atime.tv_nsec
op_assign
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t; * If the file is open with write permissions,&n;&t;&t; * update the time stamps to sync mtime and atime.&n;&t;&t; */
r_if
c_cond
(paren
(paren
id|server-&gt;opt.capabilities
op_amp
id|SMB_CAP_UNIX
)paren
op_eq
l_int|0
op_logical_and
(paren
id|server-&gt;opt.protocol
op_ge
id|SMB_PROTOCOL_LANMAN2
)paren
op_logical_and
op_logical_neg
(paren
id|ei-&gt;access
op_eq
id|SMB_O_RDONLY
)paren
)paren
(brace
r_struct
id|smb_fattr
id|fattr
suffix:semicolon
id|smb_get_inode_attr
c_func
(paren
id|ino
comma
op_amp
id|fattr
)paren
suffix:semicolon
id|smb_proc_setattr_ext
c_func
(paren
id|server
comma
id|ino
comma
op_amp
id|fattr
)paren
suffix:semicolon
)brace
id|result
op_assign
id|smb_proc_close
c_func
(paren
id|server
comma
id|ei-&gt;fileid
comma
id|ino-&gt;i_mtime.tv_sec
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * Force a revalidation after closing ... some servers&n;&t;&t; * don&squot;t post the size until the file has been closed.&n;&t;&t; */
r_if
c_cond
(paren
id|server-&gt;opt.protocol
OL
id|SMB_PROTOCOL_NT1
)paren
id|ei-&gt;oldmtime
op_assign
l_int|0
suffix:semicolon
id|ei-&gt;closed
op_assign
id|jiffies
suffix:semicolon
)brace
r_return
id|result
suffix:semicolon
)brace
r_int
DECL|function|smb_close
id|smb_close
c_func
(paren
r_struct
id|inode
op_star
id|ino
)paren
(brace
r_int
id|result
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|smb_is_open
c_func
(paren
id|ino
)paren
)paren
(brace
r_struct
id|smb_sb_info
op_star
id|server
op_assign
id|server_from_inode
c_func
(paren
id|ino
)paren
suffix:semicolon
id|result
op_assign
id|smb_proc_close_inode
c_func
(paren
id|server
comma
id|ino
)paren
suffix:semicolon
)brace
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/*&n; * This is used to close a file following a failed instantiate.&n; * Since we don&squot;t have an inode, we can&squot;t use any of the above.&n; */
r_int
DECL|function|smb_close_fileid
id|smb_close_fileid
c_func
(paren
r_struct
id|dentry
op_star
id|dentry
comma
id|__u16
id|fileid
)paren
(brace
r_struct
id|smb_sb_info
op_star
id|server
op_assign
id|server_from_dentry
c_func
(paren
id|dentry
)paren
suffix:semicolon
r_int
id|result
suffix:semicolon
id|result
op_assign
id|smb_proc_close
c_func
(paren
id|server
comma
id|fileid
comma
id|get_seconds
c_func
(paren
)paren
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/* In smb_proc_read and smb_proc_write we do not retry, because the&n;   file-id would not be valid after a reconnection. */
r_static
r_void
DECL|function|smb_proc_read_data
id|smb_proc_read_data
c_func
(paren
r_struct
id|smb_request
op_star
id|req
)paren
(brace
id|req-&gt;rq_iov
(braket
l_int|0
)braket
dot
id|iov_base
op_assign
id|req-&gt;rq_buffer
suffix:semicolon
id|req-&gt;rq_iov
(braket
l_int|0
)braket
dot
id|iov_len
op_assign
l_int|3
suffix:semicolon
id|req-&gt;rq_iov
(braket
l_int|1
)braket
dot
id|iov_base
op_assign
id|req-&gt;rq_page
suffix:semicolon
id|req-&gt;rq_iov
(braket
l_int|1
)braket
dot
id|iov_len
op_assign
id|req-&gt;rq_rsize
suffix:semicolon
id|req-&gt;rq_iovlen
op_assign
l_int|2
suffix:semicolon
id|req-&gt;rq_rlen
op_assign
id|smb_len
c_func
(paren
id|req-&gt;rq_header
)paren
op_plus
l_int|4
op_minus
id|req-&gt;rq_bytes_recvd
suffix:semicolon
)brace
r_static
r_int
DECL|function|smb_proc_read
id|smb_proc_read
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
id|loff_t
id|offset
comma
r_int
id|count
comma
r_char
op_star
id|data
)paren
(brace
r_struct
id|smb_sb_info
op_star
id|server
op_assign
id|server_from_inode
c_func
(paren
id|inode
)paren
suffix:semicolon
id|__u16
id|returned_count
comma
id|data_len
suffix:semicolon
r_int
r_char
op_star
id|buf
suffix:semicolon
r_int
id|result
suffix:semicolon
r_struct
id|smb_request
op_star
id|req
suffix:semicolon
id|u8
id|rbuf
(braket
l_int|4
)braket
suffix:semicolon
id|result
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|req
op_assign
id|smb_alloc_request
c_func
(paren
id|server
comma
l_int|0
)paren
)paren
)paren
r_goto
id|out
suffix:semicolon
id|smb_setup_header
c_func
(paren
id|req
comma
id|SMBread
comma
l_int|5
comma
l_int|0
)paren
suffix:semicolon
id|buf
op_assign
id|req-&gt;rq_header
suffix:semicolon
id|WSET
c_func
(paren
id|buf
comma
id|smb_vwv0
comma
id|SMB_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|fileid
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|buf
comma
id|smb_vwv1
comma
id|count
)paren
suffix:semicolon
id|DSET
c_func
(paren
id|buf
comma
id|smb_vwv2
comma
id|offset
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|buf
comma
id|smb_vwv4
comma
l_int|0
)paren
suffix:semicolon
id|req-&gt;rq_page
op_assign
id|data
suffix:semicolon
id|req-&gt;rq_rsize
op_assign
id|count
suffix:semicolon
id|req-&gt;rq_callback
op_assign
id|smb_proc_read_data
suffix:semicolon
id|req-&gt;rq_buffer
op_assign
id|rbuf
suffix:semicolon
id|req-&gt;rq_flags
op_or_assign
id|SMB_REQ_NORETRY
op_or
id|SMB_REQ_STATIC
suffix:semicolon
id|result
op_assign
id|smb_request_ok
c_func
(paren
id|req
comma
id|SMBread
comma
l_int|5
comma
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
r_goto
id|out_free
suffix:semicolon
id|returned_count
op_assign
id|WVAL
c_func
(paren
id|req-&gt;rq_header
comma
id|smb_vwv0
)paren
suffix:semicolon
id|data_len
op_assign
id|WVAL
c_func
(paren
id|rbuf
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|returned_count
op_ne
id|data_len
)paren
(brace
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;smb_proc_read: returned != data_len&bslash;n&quot;
)paren
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;smb_proc_read: ret_c=%d, data_len=%d&bslash;n&quot;
comma
id|returned_count
comma
id|data_len
)paren
suffix:semicolon
)brace
id|result
op_assign
id|data_len
suffix:semicolon
id|out_free
suffix:colon
id|smb_rput
c_func
(paren
id|req
)paren
suffix:semicolon
id|out
suffix:colon
id|VERBOSE
c_func
(paren
l_string|&quot;ino=%ld, fileid=%d, count=%d, result=%d&bslash;n&quot;
comma
id|inode-&gt;i_ino
comma
id|SMB_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|fileid
comma
id|count
comma
id|result
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
r_static
r_int
DECL|function|smb_proc_write
id|smb_proc_write
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
id|loff_t
id|offset
comma
r_int
id|count
comma
r_const
r_char
op_star
id|data
)paren
(brace
r_struct
id|smb_sb_info
op_star
id|server
op_assign
id|server_from_inode
c_func
(paren
id|inode
)paren
suffix:semicolon
r_int
id|result
suffix:semicolon
id|u16
id|fileid
op_assign
id|SMB_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|fileid
suffix:semicolon
id|u8
id|buf
(braket
l_int|4
)braket
suffix:semicolon
r_struct
id|smb_request
op_star
id|req
suffix:semicolon
id|result
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|req
op_assign
id|smb_alloc_request
c_func
(paren
id|server
comma
l_int|0
)paren
)paren
)paren
r_goto
id|out
suffix:semicolon
id|VERBOSE
c_func
(paren
l_string|&quot;ino=%ld, fileid=%d, count=%d@%Ld&bslash;n&quot;
comma
id|inode-&gt;i_ino
comma
id|fileid
comma
id|count
comma
id|offset
)paren
suffix:semicolon
id|smb_setup_header
c_func
(paren
id|req
comma
id|SMBwrite
comma
l_int|5
comma
id|count
op_plus
l_int|3
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|req-&gt;rq_header
comma
id|smb_vwv0
comma
id|fileid
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|req-&gt;rq_header
comma
id|smb_vwv1
comma
id|count
)paren
suffix:semicolon
id|DSET
c_func
(paren
id|req-&gt;rq_header
comma
id|smb_vwv2
comma
id|offset
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|req-&gt;rq_header
comma
id|smb_vwv4
comma
l_int|0
)paren
suffix:semicolon
id|buf
(braket
l_int|0
)braket
op_assign
l_int|1
suffix:semicolon
id|WSET
c_func
(paren
id|buf
comma
l_int|1
comma
id|count
)paren
suffix:semicolon
multiline_comment|/* yes, again ... */
id|req-&gt;rq_iov
(braket
l_int|1
)braket
dot
id|iov_base
op_assign
id|buf
suffix:semicolon
id|req-&gt;rq_iov
(braket
l_int|1
)braket
dot
id|iov_len
op_assign
l_int|3
suffix:semicolon
id|req-&gt;rq_iov
(braket
l_int|2
)braket
dot
id|iov_base
op_assign
(paren
r_char
op_star
)paren
id|data
suffix:semicolon
id|req-&gt;rq_iov
(braket
l_int|2
)braket
dot
id|iov_len
op_assign
id|count
suffix:semicolon
id|req-&gt;rq_iovlen
op_assign
l_int|3
suffix:semicolon
id|req-&gt;rq_flags
op_or_assign
id|SMB_REQ_NORETRY
suffix:semicolon
id|result
op_assign
id|smb_request_ok
c_func
(paren
id|req
comma
id|SMBwrite
comma
l_int|1
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_ge
l_int|0
)paren
id|result
op_assign
id|WVAL
c_func
(paren
id|req-&gt;rq_header
comma
id|smb_vwv0
)paren
suffix:semicolon
id|smb_rput
c_func
(paren
id|req
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/*&n; * In smb_proc_readX and smb_proc_writeX we do not retry, because the&n; * file-id would not be valid after a reconnection.&n; */
DECL|macro|SMB_READX_MAX_PAD
mdefine_line|#define SMB_READX_MAX_PAD      64
r_static
r_void
DECL|function|smb_proc_readX_data
id|smb_proc_readX_data
c_func
(paren
r_struct
id|smb_request
op_star
id|req
)paren
(brace
multiline_comment|/* header length, excluding the netbios length (-4) */
r_int
id|hdrlen
op_assign
id|SMB_HEADER_LEN
op_plus
id|req-&gt;rq_resp_wct
op_star
l_int|2
op_minus
l_int|2
suffix:semicolon
r_int
id|data_off
op_assign
id|WVAL
c_func
(paren
id|req-&gt;rq_header
comma
id|smb_vwv6
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Some genius made the padding to the data bytes arbitrary.&n;&t; * So we must first calculate the amount of padding used by the server.&n;&t; */
id|data_off
op_sub_assign
id|hdrlen
suffix:semicolon
r_if
c_cond
(paren
id|data_off
OG
id|SMB_READX_MAX_PAD
)paren
(brace
id|PARANOIA
c_func
(paren
l_string|&quot;offset is larger than max pad!&bslash;n&quot;
)paren
suffix:semicolon
id|PARANOIA
c_func
(paren
l_string|&quot;%d &gt; %d&bslash;n&quot;
comma
id|data_off
comma
id|SMB_READX_MAX_PAD
)paren
suffix:semicolon
id|req-&gt;rq_rlen
op_assign
id|req-&gt;rq_bufsize
op_plus
l_int|1
suffix:semicolon
r_return
suffix:semicolon
)brace
id|req-&gt;rq_iov
(braket
l_int|0
)braket
dot
id|iov_base
op_assign
id|req-&gt;rq_buffer
suffix:semicolon
id|req-&gt;rq_iov
(braket
l_int|0
)braket
dot
id|iov_len
op_assign
id|data_off
suffix:semicolon
id|req-&gt;rq_iov
(braket
l_int|1
)braket
dot
id|iov_base
op_assign
id|req-&gt;rq_page
suffix:semicolon
id|req-&gt;rq_iov
(braket
l_int|1
)braket
dot
id|iov_len
op_assign
id|req-&gt;rq_rsize
suffix:semicolon
id|req-&gt;rq_iovlen
op_assign
l_int|2
suffix:semicolon
id|req-&gt;rq_rlen
op_assign
id|smb_len
c_func
(paren
id|req-&gt;rq_header
)paren
op_plus
l_int|4
op_minus
id|req-&gt;rq_bytes_recvd
suffix:semicolon
)brace
r_static
r_int
DECL|function|smb_proc_readX
id|smb_proc_readX
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
id|loff_t
id|offset
comma
r_int
id|count
comma
r_char
op_star
id|data
)paren
(brace
r_struct
id|smb_sb_info
op_star
id|server
op_assign
id|server_from_inode
c_func
(paren
id|inode
)paren
suffix:semicolon
r_int
r_char
op_star
id|buf
suffix:semicolon
r_int
id|result
suffix:semicolon
r_struct
id|smb_request
op_star
id|req
suffix:semicolon
r_static
r_char
id|pad
(braket
id|SMB_READX_MAX_PAD
)braket
suffix:semicolon
id|result
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|req
op_assign
id|smb_alloc_request
c_func
(paren
id|server
comma
l_int|0
)paren
)paren
)paren
r_goto
id|out
suffix:semicolon
id|smb_setup_header
c_func
(paren
id|req
comma
id|SMBreadX
comma
l_int|12
comma
l_int|0
)paren
suffix:semicolon
id|buf
op_assign
id|req-&gt;rq_header
suffix:semicolon
id|WSET
c_func
(paren
id|buf
comma
id|smb_vwv0
comma
l_int|0x00ff
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|buf
comma
id|smb_vwv1
comma
l_int|0
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|buf
comma
id|smb_vwv2
comma
id|SMB_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|fileid
)paren
suffix:semicolon
id|DSET
c_func
(paren
id|buf
comma
id|smb_vwv3
comma
(paren
id|u32
)paren
id|offset
)paren
suffix:semicolon
multiline_comment|/* low 32 bits */
id|WSET
c_func
(paren
id|buf
comma
id|smb_vwv5
comma
id|count
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|buf
comma
id|smb_vwv6
comma
l_int|0
)paren
suffix:semicolon
id|DSET
c_func
(paren
id|buf
comma
id|smb_vwv7
comma
l_int|0
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|buf
comma
id|smb_vwv9
comma
l_int|0
)paren
suffix:semicolon
id|DSET
c_func
(paren
id|buf
comma
id|smb_vwv10
comma
(paren
id|u32
)paren
(paren
id|offset
op_rshift
l_int|32
)paren
)paren
suffix:semicolon
multiline_comment|/* high 32 bits */
id|WSET
c_func
(paren
id|buf
comma
id|smb_vwv11
comma
l_int|0
)paren
suffix:semicolon
id|req-&gt;rq_page
op_assign
id|data
suffix:semicolon
id|req-&gt;rq_rsize
op_assign
id|count
suffix:semicolon
id|req-&gt;rq_callback
op_assign
id|smb_proc_readX_data
suffix:semicolon
id|req-&gt;rq_buffer
op_assign
id|pad
suffix:semicolon
id|req-&gt;rq_bufsize
op_assign
id|SMB_READX_MAX_PAD
suffix:semicolon
id|req-&gt;rq_flags
op_or_assign
id|SMB_REQ_STATIC
op_or
id|SMB_REQ_NORETRY
suffix:semicolon
id|result
op_assign
id|smb_request_ok
c_func
(paren
id|req
comma
id|SMBreadX
comma
l_int|12
comma
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
r_goto
id|out_free
suffix:semicolon
id|result
op_assign
id|WVAL
c_func
(paren
id|req-&gt;rq_header
comma
id|smb_vwv5
)paren
suffix:semicolon
id|out_free
suffix:colon
id|smb_rput
c_func
(paren
id|req
)paren
suffix:semicolon
id|out
suffix:colon
id|VERBOSE
c_func
(paren
l_string|&quot;ino=%ld, fileid=%d, count=%d, result=%d&bslash;n&quot;
comma
id|inode-&gt;i_ino
comma
id|SMB_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|fileid
comma
id|count
comma
id|result
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
r_static
r_int
DECL|function|smb_proc_writeX
id|smb_proc_writeX
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
id|loff_t
id|offset
comma
r_int
id|count
comma
r_const
r_char
op_star
id|data
)paren
(brace
r_struct
id|smb_sb_info
op_star
id|server
op_assign
id|server_from_inode
c_func
(paren
id|inode
)paren
suffix:semicolon
r_int
id|result
suffix:semicolon
id|u8
op_star
id|p
suffix:semicolon
r_static
id|u8
id|pad
(braket
l_int|4
)braket
suffix:semicolon
r_struct
id|smb_request
op_star
id|req
suffix:semicolon
id|result
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|req
op_assign
id|smb_alloc_request
c_func
(paren
id|server
comma
l_int|0
)paren
)paren
)paren
r_goto
id|out
suffix:semicolon
id|VERBOSE
c_func
(paren
l_string|&quot;ino=%ld, fileid=%d, count=%d@%Ld&bslash;n&quot;
comma
id|inode-&gt;i_ino
comma
id|SMB_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|fileid
comma
id|count
comma
id|offset
)paren
suffix:semicolon
id|p
op_assign
id|smb_setup_header
c_func
(paren
id|req
comma
id|SMBwriteX
comma
l_int|14
comma
id|count
op_plus
l_int|1
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|req-&gt;rq_header
comma
id|smb_vwv0
comma
l_int|0x00ff
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|req-&gt;rq_header
comma
id|smb_vwv1
comma
l_int|0
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|req-&gt;rq_header
comma
id|smb_vwv2
comma
id|SMB_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|fileid
)paren
suffix:semicolon
id|DSET
c_func
(paren
id|req-&gt;rq_header
comma
id|smb_vwv3
comma
(paren
id|u32
)paren
id|offset
)paren
suffix:semicolon
multiline_comment|/* low 32 bits */
id|DSET
c_func
(paren
id|req-&gt;rq_header
comma
id|smb_vwv5
comma
l_int|0
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|req-&gt;rq_header
comma
id|smb_vwv7
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* write mode */
id|WSET
c_func
(paren
id|req-&gt;rq_header
comma
id|smb_vwv8
comma
l_int|0
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|req-&gt;rq_header
comma
id|smb_vwv9
comma
l_int|0
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|req-&gt;rq_header
comma
id|smb_vwv10
comma
id|count
)paren
suffix:semicolon
multiline_comment|/* data length */
id|WSET
c_func
(paren
id|req-&gt;rq_header
comma
id|smb_vwv11
comma
id|smb_vwv12
op_plus
l_int|2
op_plus
l_int|1
)paren
suffix:semicolon
id|DSET
c_func
(paren
id|req-&gt;rq_header
comma
id|smb_vwv12
comma
(paren
id|u32
)paren
(paren
id|offset
op_rshift
l_int|32
)paren
)paren
suffix:semicolon
id|req-&gt;rq_iov
(braket
l_int|1
)braket
dot
id|iov_base
op_assign
id|pad
suffix:semicolon
id|req-&gt;rq_iov
(braket
l_int|1
)braket
dot
id|iov_len
op_assign
l_int|1
suffix:semicolon
id|req-&gt;rq_iov
(braket
l_int|2
)braket
dot
id|iov_base
op_assign
(paren
r_char
op_star
)paren
id|data
suffix:semicolon
id|req-&gt;rq_iov
(braket
l_int|2
)braket
dot
id|iov_len
op_assign
id|count
suffix:semicolon
id|req-&gt;rq_iovlen
op_assign
l_int|3
suffix:semicolon
id|req-&gt;rq_flags
op_or_assign
id|SMB_REQ_NORETRY
suffix:semicolon
id|result
op_assign
id|smb_request_ok
c_func
(paren
id|req
comma
id|SMBwriteX
comma
l_int|6
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_ge
l_int|0
)paren
id|result
op_assign
id|WVAL
c_func
(paren
id|req-&gt;rq_header
comma
id|smb_vwv2
)paren
suffix:semicolon
id|smb_rput
c_func
(paren
id|req
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|result
suffix:semicolon
)brace
r_int
DECL|function|smb_proc_create
id|smb_proc_create
c_func
(paren
r_struct
id|dentry
op_star
id|dentry
comma
id|__u16
id|attr
comma
id|time_t
id|ctime
comma
id|__u16
op_star
id|fileid
)paren
(brace
r_struct
id|smb_sb_info
op_star
id|server
op_assign
id|server_from_dentry
c_func
(paren
id|dentry
)paren
suffix:semicolon
r_char
op_star
id|p
suffix:semicolon
r_int
id|result
suffix:semicolon
r_struct
id|smb_request
op_star
id|req
suffix:semicolon
id|result
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|req
op_assign
id|smb_alloc_request
c_func
(paren
id|server
comma
id|PAGE_SIZE
)paren
)paren
)paren
r_goto
id|out
suffix:semicolon
id|p
op_assign
id|smb_setup_header
c_func
(paren
id|req
comma
id|SMBcreate
comma
l_int|3
comma
l_int|0
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|req-&gt;rq_header
comma
id|smb_vwv0
comma
id|attr
)paren
suffix:semicolon
id|DSET
c_func
(paren
id|req-&gt;rq_header
comma
id|smb_vwv1
comma
id|utc2local
c_func
(paren
id|server
comma
id|ctime
)paren
)paren
suffix:semicolon
id|result
op_assign
id|smb_simple_encode_path
c_func
(paren
id|req
comma
op_amp
id|p
comma
id|dentry
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
r_goto
id|out_free
suffix:semicolon
id|smb_setup_bcc
c_func
(paren
id|req
comma
id|p
)paren
suffix:semicolon
id|result
op_assign
id|smb_request_ok
c_func
(paren
id|req
comma
id|SMBcreate
comma
l_int|1
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
r_goto
id|out_free
suffix:semicolon
op_star
id|fileid
op_assign
id|WVAL
c_func
(paren
id|req-&gt;rq_header
comma
id|smb_vwv0
)paren
suffix:semicolon
id|result
op_assign
l_int|0
suffix:semicolon
id|out_free
suffix:colon
id|smb_rput
c_func
(paren
id|req
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|result
suffix:semicolon
)brace
r_int
DECL|function|smb_proc_mv
id|smb_proc_mv
c_func
(paren
r_struct
id|dentry
op_star
id|old_dentry
comma
r_struct
id|dentry
op_star
id|new_dentry
)paren
(brace
r_struct
id|smb_sb_info
op_star
id|server
op_assign
id|server_from_dentry
c_func
(paren
id|old_dentry
)paren
suffix:semicolon
r_char
op_star
id|p
suffix:semicolon
r_int
id|result
suffix:semicolon
r_struct
id|smb_request
op_star
id|req
suffix:semicolon
id|result
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|req
op_assign
id|smb_alloc_request
c_func
(paren
id|server
comma
id|PAGE_SIZE
)paren
)paren
)paren
r_goto
id|out
suffix:semicolon
id|p
op_assign
id|smb_setup_header
c_func
(paren
id|req
comma
id|SMBmv
comma
l_int|1
comma
l_int|0
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|req-&gt;rq_header
comma
id|smb_vwv0
comma
id|aSYSTEM
op_or
id|aHIDDEN
op_or
id|aDIR
)paren
suffix:semicolon
id|result
op_assign
id|smb_simple_encode_path
c_func
(paren
id|req
comma
op_amp
id|p
comma
id|old_dentry
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
r_goto
id|out_free
suffix:semicolon
id|result
op_assign
id|smb_simple_encode_path
c_func
(paren
id|req
comma
op_amp
id|p
comma
id|new_dentry
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
r_goto
id|out_free
suffix:semicolon
id|smb_setup_bcc
c_func
(paren
id|req
comma
id|p
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_assign
id|smb_request_ok
c_func
(paren
id|req
comma
id|SMBmv
comma
l_int|0
comma
l_int|0
)paren
)paren
OL
l_int|0
)paren
r_goto
id|out_free
suffix:semicolon
id|result
op_assign
l_int|0
suffix:semicolon
id|out_free
suffix:colon
id|smb_rput
c_func
(paren
id|req
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/*&n; * Code common to mkdir and rmdir.&n; */
r_static
r_int
DECL|function|smb_proc_generic_command
id|smb_proc_generic_command
c_func
(paren
r_struct
id|dentry
op_star
id|dentry
comma
id|__u8
id|command
)paren
(brace
r_struct
id|smb_sb_info
op_star
id|server
op_assign
id|server_from_dentry
c_func
(paren
id|dentry
)paren
suffix:semicolon
r_char
op_star
id|p
suffix:semicolon
r_int
id|result
suffix:semicolon
r_struct
id|smb_request
op_star
id|req
suffix:semicolon
id|result
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|req
op_assign
id|smb_alloc_request
c_func
(paren
id|server
comma
id|PAGE_SIZE
)paren
)paren
)paren
r_goto
id|out
suffix:semicolon
id|p
op_assign
id|smb_setup_header
c_func
(paren
id|req
comma
id|command
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|result
op_assign
id|smb_simple_encode_path
c_func
(paren
id|req
comma
op_amp
id|p
comma
id|dentry
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
r_goto
id|out_free
suffix:semicolon
id|smb_setup_bcc
c_func
(paren
id|req
comma
id|p
)paren
suffix:semicolon
id|result
op_assign
id|smb_request_ok
c_func
(paren
id|req
comma
id|command
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
r_goto
id|out_free
suffix:semicolon
id|result
op_assign
l_int|0
suffix:semicolon
id|out_free
suffix:colon
id|smb_rput
c_func
(paren
id|req
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|result
suffix:semicolon
)brace
r_int
DECL|function|smb_proc_mkdir
id|smb_proc_mkdir
c_func
(paren
r_struct
id|dentry
op_star
id|dentry
)paren
(brace
r_return
id|smb_proc_generic_command
c_func
(paren
id|dentry
comma
id|SMBmkdir
)paren
suffix:semicolon
)brace
r_int
DECL|function|smb_proc_rmdir
id|smb_proc_rmdir
c_func
(paren
r_struct
id|dentry
op_star
id|dentry
)paren
(brace
r_return
id|smb_proc_generic_command
c_func
(paren
id|dentry
comma
id|SMBrmdir
)paren
suffix:semicolon
)brace
macro_line|#if SMBFS_POSIX_UNLINK
multiline_comment|/*&n; * Removes readonly attribute from a file. Used by unlink to give posix&n; * semantics.&n; */
r_static
r_int
DECL|function|smb_set_rw
id|smb_set_rw
c_func
(paren
r_struct
id|dentry
op_star
id|dentry
comma
r_struct
id|smb_sb_info
op_star
id|server
)paren
(brace
r_int
id|result
suffix:semicolon
r_struct
id|smb_fattr
id|fattr
suffix:semicolon
multiline_comment|/* FIXME: cifsUE should allow removing a readonly file. */
multiline_comment|/* first get current attribute */
id|smb_init_dirent
c_func
(paren
id|server
comma
op_amp
id|fattr
)paren
suffix:semicolon
id|result
op_assign
id|server-&gt;ops
op_member_access_from_pointer
id|getattr
c_func
(paren
id|server
comma
id|dentry
comma
op_amp
id|fattr
)paren
suffix:semicolon
id|smb_finish_dirent
c_func
(paren
id|server
comma
op_amp
id|fattr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
r_return
id|result
suffix:semicolon
multiline_comment|/* if RONLY attribute is set, remove it */
r_if
c_cond
(paren
id|fattr.attr
op_amp
id|aRONLY
)paren
(brace
multiline_comment|/* read only attribute is set */
id|fattr.attr
op_and_assign
op_complement
id|aRONLY
suffix:semicolon
id|result
op_assign
id|smb_proc_setattr_core
c_func
(paren
id|server
comma
id|dentry
comma
id|fattr.attr
)paren
suffix:semicolon
)brace
r_return
id|result
suffix:semicolon
)brace
macro_line|#endif
r_int
DECL|function|smb_proc_unlink
id|smb_proc_unlink
c_func
(paren
r_struct
id|dentry
op_star
id|dentry
)paren
(brace
r_struct
id|smb_sb_info
op_star
id|server
op_assign
id|server_from_dentry
c_func
(paren
id|dentry
)paren
suffix:semicolon
r_int
id|flag
op_assign
l_int|0
suffix:semicolon
r_char
op_star
id|p
suffix:semicolon
r_int
id|result
suffix:semicolon
r_struct
id|smb_request
op_star
id|req
suffix:semicolon
id|result
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|req
op_assign
id|smb_alloc_request
c_func
(paren
id|server
comma
id|PAGE_SIZE
)paren
)paren
)paren
r_goto
id|out
suffix:semicolon
id|retry
suffix:colon
id|p
op_assign
id|smb_setup_header
c_func
(paren
id|req
comma
id|SMBunlink
comma
l_int|1
comma
l_int|0
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|req-&gt;rq_header
comma
id|smb_vwv0
comma
id|aSYSTEM
op_or
id|aHIDDEN
)paren
suffix:semicolon
id|result
op_assign
id|smb_simple_encode_path
c_func
(paren
id|req
comma
op_amp
id|p
comma
id|dentry
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
r_goto
id|out_free
suffix:semicolon
id|smb_setup_bcc
c_func
(paren
id|req
comma
id|p
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_assign
id|smb_request_ok
c_func
(paren
id|req
comma
id|SMBunlink
comma
l_int|0
comma
l_int|0
)paren
)paren
OL
l_int|0
)paren
(brace
macro_line|#if SMBFS_POSIX_UNLINK
r_if
c_cond
(paren
id|result
op_eq
op_minus
id|EACCES
op_logical_and
op_logical_neg
id|flag
)paren
(brace
multiline_comment|/* Posix semantics is for the read-only state&n;&t;&t;&t;   of a file to be ignored in unlink(). In the&n;&t;&t;&t;   SMB world a unlink() is refused on a&n;&t;&t;&t;   read-only file. To make things easier for&n;&t;&t;&t;   unix users we try to override the files&n;&t;&t;&t;   permission if the unlink fails with the&n;&t;&t;&t;   right error.&n;&t;&t;&t;   This introduces a race condition that could&n;&t;&t;&t;   lead to a file being written by someone who&n;&t;&t;&t;   shouldn&squot;t have access, but as far as I can&n;&t;&t;&t;   tell that is unavoidable */
multiline_comment|/* remove RONLY attribute and try again */
id|result
op_assign
id|smb_set_rw
c_func
(paren
id|dentry
comma
id|server
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
op_eq
l_int|0
)paren
(brace
id|flag
op_assign
l_int|1
suffix:semicolon
id|req-&gt;rq_flags
op_assign
l_int|0
suffix:semicolon
r_goto
id|retry
suffix:semicolon
)brace
)brace
macro_line|#endif
r_goto
id|out_free
suffix:semicolon
)brace
id|result
op_assign
l_int|0
suffix:semicolon
id|out_free
suffix:colon
id|smb_rput
c_func
(paren
id|req
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|result
suffix:semicolon
)brace
r_int
DECL|function|smb_proc_flush
id|smb_proc_flush
c_func
(paren
r_struct
id|smb_sb_info
op_star
id|server
comma
id|__u16
id|fileid
)paren
(brace
r_int
id|result
suffix:semicolon
r_struct
id|smb_request
op_star
id|req
suffix:semicolon
id|result
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|req
op_assign
id|smb_alloc_request
c_func
(paren
id|server
comma
l_int|0
)paren
)paren
)paren
r_goto
id|out
suffix:semicolon
id|smb_setup_header
c_func
(paren
id|req
comma
id|SMBflush
comma
l_int|1
comma
l_int|0
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|req-&gt;rq_header
comma
id|smb_vwv0
comma
id|fileid
)paren
suffix:semicolon
id|req-&gt;rq_flags
op_or_assign
id|SMB_REQ_NORETRY
suffix:semicolon
id|result
op_assign
id|smb_request_ok
c_func
(paren
id|req
comma
id|SMBflush
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|smb_rput
c_func
(paren
id|req
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|result
suffix:semicolon
)brace
r_static
r_int
DECL|function|smb_proc_trunc32
id|smb_proc_trunc32
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
id|loff_t
id|length
)paren
(brace
multiline_comment|/*&n;&t; * Writing 0bytes is old-SMB magic for truncating files.&n;&t; * MAX_NON_LFS should prevent this from being called with a too&n;&t; * large offset.&n;&t; */
r_return
id|smb_proc_write
c_func
(paren
id|inode
comma
id|length
comma
l_int|0
comma
l_int|NULL
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|smb_proc_trunc64
id|smb_proc_trunc64
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
id|loff_t
id|length
)paren
(brace
r_struct
id|smb_sb_info
op_star
id|server
op_assign
id|server_from_inode
c_func
(paren
id|inode
)paren
suffix:semicolon
r_int
id|result
suffix:semicolon
r_char
op_star
id|param
suffix:semicolon
r_char
op_star
id|data
suffix:semicolon
r_struct
id|smb_request
op_star
id|req
suffix:semicolon
id|result
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|req
op_assign
id|smb_alloc_request
c_func
(paren
id|server
comma
l_int|14
)paren
)paren
)paren
r_goto
id|out
suffix:semicolon
id|param
op_assign
id|req-&gt;rq_buffer
suffix:semicolon
id|data
op_assign
id|req-&gt;rq_buffer
op_plus
l_int|6
suffix:semicolon
multiline_comment|/* FIXME: must we also set allocation size? winNT seems to do that */
id|WSET
c_func
(paren
id|param
comma
l_int|0
comma
id|SMB_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|fileid
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|param
comma
l_int|2
comma
id|SMB_SET_FILE_END_OF_FILE_INFO
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|param
comma
l_int|4
comma
l_int|0
)paren
suffix:semicolon
id|LSET
c_func
(paren
id|data
comma
l_int|0
comma
id|length
)paren
suffix:semicolon
id|req-&gt;rq_trans2_command
op_assign
id|TRANSACT2_SETFILEINFO
suffix:semicolon
id|req-&gt;rq_ldata
op_assign
l_int|8
suffix:semicolon
id|req-&gt;rq_data
op_assign
id|data
suffix:semicolon
id|req-&gt;rq_lparm
op_assign
l_int|6
suffix:semicolon
id|req-&gt;rq_parm
op_assign
id|param
suffix:semicolon
id|req-&gt;rq_flags
op_or_assign
id|SMB_REQ_NORETRY
suffix:semicolon
id|result
op_assign
id|smb_add_request
c_func
(paren
id|req
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
r_goto
id|out_free
suffix:semicolon
id|result
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|req-&gt;rq_rcls
op_ne
l_int|0
)paren
id|result
op_assign
id|smb_errno
c_func
(paren
id|req
)paren
suffix:semicolon
id|out_free
suffix:colon
id|smb_rput
c_func
(paren
id|req
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|result
suffix:semicolon
)brace
r_static
r_int
DECL|function|smb_proc_trunc95
id|smb_proc_trunc95
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
id|loff_t
id|length
)paren
(brace
r_struct
id|smb_sb_info
op_star
id|server
op_assign
id|server_from_inode
c_func
(paren
id|inode
)paren
suffix:semicolon
r_int
id|result
op_assign
id|smb_proc_trunc32
c_func
(paren
id|inode
comma
id|length
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * win9x doesn&squot;t appear to update the size immediately.&n;&t; * It will return the old file size after the truncate,&n;&t; * confusing smbfs. So we force an update.&n;&t; *&n;&t; * FIXME: is this still necessary?&n;&t; */
id|smb_proc_flush
c_func
(paren
id|server
comma
id|SMB_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|fileid
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
r_static
r_void
DECL|function|smb_init_dirent
id|smb_init_dirent
c_func
(paren
r_struct
id|smb_sb_info
op_star
id|server
comma
r_struct
id|smb_fattr
op_star
id|fattr
)paren
(brace
id|memset
c_func
(paren
id|fattr
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|fattr
)paren
)paren
suffix:semicolon
id|fattr-&gt;f_nlink
op_assign
l_int|1
suffix:semicolon
id|fattr-&gt;f_uid
op_assign
id|server-&gt;mnt-&gt;uid
suffix:semicolon
id|fattr-&gt;f_gid
op_assign
id|server-&gt;mnt-&gt;gid
suffix:semicolon
id|fattr-&gt;f_blksize
op_assign
id|SMB_ST_BLKSIZE
suffix:semicolon
id|fattr-&gt;f_unix
op_assign
l_int|0
suffix:semicolon
)brace
r_static
r_void
DECL|function|smb_finish_dirent
id|smb_finish_dirent
c_func
(paren
r_struct
id|smb_sb_info
op_star
id|server
comma
r_struct
id|smb_fattr
op_star
id|fattr
)paren
(brace
r_if
c_cond
(paren
id|fattr-&gt;f_unix
)paren
r_return
suffix:semicolon
id|fattr-&gt;f_mode
op_assign
id|server-&gt;mnt-&gt;file_mode
suffix:semicolon
r_if
c_cond
(paren
id|fattr-&gt;attr
op_amp
id|aDIR
)paren
(brace
id|fattr-&gt;f_mode
op_assign
id|server-&gt;mnt-&gt;dir_mode
suffix:semicolon
id|fattr-&gt;f_size
op_assign
id|SMB_ST_BLKSIZE
suffix:semicolon
)brace
multiline_comment|/* Check the read-only flag */
r_if
c_cond
(paren
id|fattr-&gt;attr
op_amp
id|aRONLY
)paren
id|fattr-&gt;f_mode
op_and_assign
op_complement
(paren
id|S_IWUSR
op_or
id|S_IWGRP
op_or
id|S_IWOTH
)paren
suffix:semicolon
multiline_comment|/* How many 512 byte blocks do we need for this file? */
id|fattr-&gt;f_blocks
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|fattr-&gt;f_size
op_ne
l_int|0
)paren
id|fattr-&gt;f_blocks
op_assign
l_int|1
op_plus
(paren
(paren
id|fattr-&gt;f_size
op_minus
l_int|1
)paren
op_rshift
l_int|9
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_void
DECL|function|smb_init_root_dirent
id|smb_init_root_dirent
c_func
(paren
r_struct
id|smb_sb_info
op_star
id|server
comma
r_struct
id|smb_fattr
op_star
id|fattr
)paren
(brace
id|smb_init_dirent
c_func
(paren
id|server
comma
id|fattr
)paren
suffix:semicolon
id|fattr-&gt;attr
op_assign
id|aDIR
suffix:semicolon
id|fattr-&gt;f_ino
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* traditional root inode number */
id|fattr-&gt;f_mtime
op_assign
id|CURRENT_TIME
suffix:semicolon
id|smb_finish_dirent
c_func
(paren
id|server
comma
id|fattr
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Decode a dirent for old protocols&n; *&n; * qname is filled with the decoded, and possibly translated, name.&n; * fattr receives decoded attributes&n; *&n; * Bugs Noted:&n; * (1) Pathworks servers may pad the name with extra spaces.&n; */
r_static
r_char
op_star
DECL|function|smb_decode_short_dirent
id|smb_decode_short_dirent
c_func
(paren
r_struct
id|smb_sb_info
op_star
id|server
comma
r_char
op_star
id|p
comma
r_struct
id|qstr
op_star
id|qname
comma
r_struct
id|smb_fattr
op_star
id|fattr
comma
r_int
r_char
op_star
id|name_buf
)paren
(brace
r_int
id|len
suffix:semicolon
multiline_comment|/*&n;&t; * SMB doesn&squot;t have a concept of inode numbers ...&n;&t; */
id|smb_init_dirent
c_func
(paren
id|server
comma
id|fattr
)paren
suffix:semicolon
id|fattr-&gt;f_ino
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* FIXME: do we need this? */
id|p
op_add_assign
id|SMB_STATUS_SIZE
suffix:semicolon
multiline_comment|/* reserved (search_status) */
id|fattr-&gt;attr
op_assign
op_star
id|p
suffix:semicolon
id|fattr-&gt;f_mtime.tv_sec
op_assign
id|date_dos2unix
c_func
(paren
id|server
comma
id|WVAL
c_func
(paren
id|p
comma
l_int|3
)paren
comma
id|WVAL
c_func
(paren
id|p
comma
l_int|1
)paren
)paren
suffix:semicolon
id|fattr-&gt;f_mtime.tv_nsec
op_assign
l_int|0
suffix:semicolon
id|fattr-&gt;f_size
op_assign
id|DVAL
c_func
(paren
id|p
comma
l_int|5
)paren
suffix:semicolon
id|fattr-&gt;f_ctime
op_assign
id|fattr-&gt;f_mtime
suffix:semicolon
id|fattr-&gt;f_atime
op_assign
id|fattr-&gt;f_mtime
suffix:semicolon
id|qname-&gt;name
op_assign
id|p
op_plus
l_int|9
suffix:semicolon
id|len
op_assign
id|strnlen
c_func
(paren
id|qname-&gt;name
comma
l_int|12
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * Trim trailing blanks for Pathworks servers&n;&t; */
r_while
c_loop
(paren
id|len
OG
l_int|2
op_logical_and
id|qname-&gt;name
(braket
id|len
op_minus
l_int|1
)braket
op_eq
l_char|&squot; &squot;
)paren
id|len
op_decrement
suffix:semicolon
id|smb_finish_dirent
c_func
(paren
id|server
comma
id|fattr
)paren
suffix:semicolon
macro_line|#if 0
multiline_comment|/* FIXME: These only work for ascii chars, and recent smbmount doesn&squot;t&n;&t;   allow the flag to be set anyway. It kills const. Remove? */
r_switch
c_cond
(paren
id|server-&gt;opt.case_handling
)paren
(brace
r_case
id|SMB_CASE_UPPER
suffix:colon
id|str_upper
c_func
(paren
id|entry-&gt;name
comma
id|len
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SMB_CASE_LOWER
suffix:colon
id|str_lower
c_func
(paren
id|entry-&gt;name
comma
id|len
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
macro_line|#endif
id|qname-&gt;len
op_assign
l_int|0
suffix:semicolon
id|len
op_assign
id|server-&gt;ops
op_member_access_from_pointer
id|convert
c_func
(paren
id|name_buf
comma
id|SMB_MAXNAMELEN
comma
id|qname-&gt;name
comma
id|len
comma
id|server-&gt;remote_nls
comma
id|server-&gt;local_nls
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
l_int|0
)paren
(brace
id|qname-&gt;len
op_assign
id|len
suffix:semicolon
id|qname-&gt;name
op_assign
id|name_buf
suffix:semicolon
id|DEBUG1
c_func
(paren
l_string|&quot;len=%d, name=%.*s&bslash;n&quot;
comma
id|qname-&gt;len
comma
id|qname-&gt;len
comma
id|qname-&gt;name
)paren
suffix:semicolon
)brace
r_return
id|p
op_plus
l_int|22
suffix:semicolon
)brace
multiline_comment|/*&n; * This routine is used to read in directory entries from the network.&n; * Note that it is for short directory name seeks, i.e.: protocol &lt;&n; * SMB_PROTOCOL_LANMAN2&n; */
r_static
r_int
DECL|function|smb_proc_readdir_short
id|smb_proc_readdir_short
c_func
(paren
r_struct
id|file
op_star
id|filp
comma
r_void
op_star
id|dirent
comma
id|filldir_t
id|filldir
comma
r_struct
id|smb_cache_control
op_star
id|ctl
)paren
(brace
r_struct
id|dentry
op_star
id|dir
op_assign
id|filp-&gt;f_dentry
suffix:semicolon
r_struct
id|smb_sb_info
op_star
id|server
op_assign
id|server_from_dentry
c_func
(paren
id|dir
)paren
suffix:semicolon
r_struct
id|qstr
id|qname
suffix:semicolon
r_struct
id|smb_fattr
id|fattr
suffix:semicolon
r_char
op_star
id|p
suffix:semicolon
r_int
id|result
suffix:semicolon
r_int
id|i
comma
id|first
comma
id|entries_seen
comma
id|entries
suffix:semicolon
r_int
id|entries_asked
op_assign
(paren
id|server-&gt;opt.max_xmit
op_minus
l_int|100
)paren
op_div
id|SMB_DIRINFO_SIZE
suffix:semicolon
id|__u16
id|bcc
suffix:semicolon
id|__u16
id|count
suffix:semicolon
r_char
id|status
(braket
id|SMB_STATUS_SIZE
)braket
suffix:semicolon
r_static
r_struct
id|qstr
id|mask
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;*.*&quot;
comma
dot
id|len
op_assign
l_int|3
comma
)brace
suffix:semicolon
r_int
r_char
op_star
id|last_status
suffix:semicolon
r_struct
id|smb_request
op_star
id|req
suffix:semicolon
r_int
r_char
op_star
id|name_buf
suffix:semicolon
id|VERBOSE
c_func
(paren
l_string|&quot;%s/%s&bslash;n&quot;
comma
id|DENTRY_PATH
c_func
(paren
id|dir
)paren
)paren
suffix:semicolon
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
id|result
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|name_buf
op_assign
id|kmalloc
c_func
(paren
id|SMB_MAXNAMELEN
comma
id|GFP_KERNEL
)paren
)paren
)paren
r_goto
id|out
suffix:semicolon
id|first
op_assign
l_int|1
suffix:semicolon
id|entries
op_assign
l_int|0
suffix:semicolon
id|entries_seen
op_assign
l_int|2
suffix:semicolon
multiline_comment|/* implicit . and .. */
id|result
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|req
op_assign
id|smb_alloc_request
c_func
(paren
id|server
comma
id|server-&gt;opt.max_xmit
)paren
)paren
)paren
r_goto
id|out_name
suffix:semicolon
r_while
c_loop
(paren
l_int|1
)paren
(brace
id|p
op_assign
id|smb_setup_header
c_func
(paren
id|req
comma
id|SMBsearch
comma
l_int|2
comma
l_int|0
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|req-&gt;rq_header
comma
id|smb_vwv0
comma
id|entries_asked
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|req-&gt;rq_header
comma
id|smb_vwv1
comma
id|aDIR
)paren
suffix:semicolon
r_if
c_cond
(paren
id|first
op_eq
l_int|1
)paren
(brace
id|result
op_assign
id|smb_simple_encode_path
c_func
(paren
id|req
comma
op_amp
id|p
comma
id|dir
comma
op_amp
id|mask
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
r_goto
id|out_free
suffix:semicolon
r_if
c_cond
(paren
id|p
op_plus
l_int|3
OG
(paren
r_char
op_star
)paren
id|req-&gt;rq_buffer
op_plus
id|req-&gt;rq_bufsize
)paren
(brace
id|result
op_assign
op_minus
id|ENAMETOOLONG
suffix:semicolon
r_goto
id|out_free
suffix:semicolon
)brace
op_star
id|p
op_increment
op_assign
l_int|5
suffix:semicolon
id|WSET
c_func
(paren
id|p
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|p
op_add_assign
l_int|2
suffix:semicolon
id|first
op_assign
l_int|0
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|p
op_plus
l_int|5
op_plus
id|SMB_STATUS_SIZE
OG
(paren
r_char
op_star
)paren
id|req-&gt;rq_buffer
op_plus
id|req-&gt;rq_bufsize
)paren
(brace
id|result
op_assign
op_minus
id|ENAMETOOLONG
suffix:semicolon
r_goto
id|out_free
suffix:semicolon
)brace
op_star
id|p
op_increment
op_assign
l_int|4
suffix:semicolon
op_star
id|p
op_increment
op_assign
l_int|0
suffix:semicolon
op_star
id|p
op_increment
op_assign
l_int|5
suffix:semicolon
id|WSET
c_func
(paren
id|p
comma
l_int|0
comma
id|SMB_STATUS_SIZE
)paren
suffix:semicolon
id|p
op_add_assign
l_int|2
suffix:semicolon
id|memcpy
c_func
(paren
id|p
comma
id|status
comma
id|SMB_STATUS_SIZE
)paren
suffix:semicolon
id|p
op_add_assign
id|SMB_STATUS_SIZE
suffix:semicolon
)brace
id|smb_setup_bcc
c_func
(paren
id|req
comma
id|p
)paren
suffix:semicolon
id|result
op_assign
id|smb_request_ok
c_func
(paren
id|req
comma
id|SMBsearch
comma
l_int|1
comma
op_minus
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
(brace
r_if
c_cond
(paren
(paren
id|req-&gt;rq_rcls
op_eq
id|ERRDOS
)paren
op_logical_and
(paren
id|req-&gt;rq_err
op_eq
id|ERRnofiles
)paren
)paren
r_break
suffix:semicolon
r_goto
id|out_free
suffix:semicolon
)brace
id|count
op_assign
id|WVAL
c_func
(paren
id|req-&gt;rq_header
comma
id|smb_vwv0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|count
op_le
l_int|0
)paren
r_break
suffix:semicolon
id|result
op_assign
op_minus
id|EIO
suffix:semicolon
id|bcc
op_assign
id|smb_bcc
c_func
(paren
id|req-&gt;rq_header
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bcc
op_ne
id|count
op_star
id|SMB_DIRINFO_SIZE
op_plus
l_int|3
)paren
r_goto
id|out_free
suffix:semicolon
id|p
op_assign
id|req-&gt;rq_buffer
op_plus
l_int|3
suffix:semicolon
multiline_comment|/* Make sure the response fits in the buffer. Fixed sized &n;&t;&t;   entries means we don&squot;t have to check in the decode loop. */
id|last_status
op_assign
id|req-&gt;rq_buffer
op_plus
l_int|3
op_plus
(paren
id|count
op_minus
l_int|1
)paren
op_star
id|SMB_DIRINFO_SIZE
suffix:semicolon
r_if
c_cond
(paren
id|last_status
op_plus
id|SMB_DIRINFO_SIZE
op_ge
id|req-&gt;rq_buffer
op_plus
id|req-&gt;rq_bufsize
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;smb_proc_readdir_short: &quot;
l_string|&quot;last dir entry outside buffer! &quot;
l_string|&quot;%d@%p  %d@%p&bslash;n&quot;
comma
id|SMB_DIRINFO_SIZE
comma
id|last_status
comma
id|req-&gt;rq_bufsize
comma
id|req-&gt;rq_buffer
)paren
suffix:semicolon
r_goto
id|out_free
suffix:semicolon
)brace
multiline_comment|/* Read the last entry into the status field. */
id|memcpy
c_func
(paren
id|status
comma
id|last_status
comma
id|SMB_STATUS_SIZE
)paren
suffix:semicolon
multiline_comment|/* Now we are ready to parse smb directory entries. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
suffix:semicolon
id|i
op_increment
)paren
(brace
id|p
op_assign
id|smb_decode_short_dirent
c_func
(paren
id|server
comma
id|p
comma
op_amp
id|qname
comma
op_amp
id|fattr
comma
id|name_buf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|qname.len
op_eq
l_int|0
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|entries_seen
op_eq
l_int|2
op_logical_and
id|qname.name
(braket
l_int|0
)braket
op_eq
l_char|&squot;.&squot;
)paren
(brace
r_if
c_cond
(paren
id|qname.len
op_eq
l_int|1
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|qname.name
(braket
l_int|1
)braket
op_eq
l_char|&squot;.&squot;
op_logical_and
id|qname.len
op_eq
l_int|2
)paren
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|smb_fill_cache
c_func
(paren
id|filp
comma
id|dirent
comma
id|filldir
comma
id|ctl
comma
op_amp
id|qname
comma
op_amp
id|fattr
)paren
)paren
suffix:semicolon
multiline_comment|/* stop reading? */
id|entries_seen
op_increment
suffix:semicolon
)brace
)brace
id|result
op_assign
id|entries
suffix:semicolon
id|out_free
suffix:colon
id|smb_rput
c_func
(paren
id|req
)paren
suffix:semicolon
id|out_name
suffix:colon
id|kfree
c_func
(paren
id|name_buf
)paren
suffix:semicolon
id|out
suffix:colon
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
DECL|function|smb_decode_unix_basic
r_void
id|smb_decode_unix_basic
c_func
(paren
r_struct
id|smb_fattr
op_star
id|fattr
comma
r_char
op_star
id|p
)paren
(brace
multiline_comment|/* FIXME: verify nls support. all is sent as utf8? */
id|__u64
id|devmajor
comma
id|devminor
suffix:semicolon
id|fattr-&gt;f_unix
op_assign
l_int|1
suffix:semicolon
id|fattr-&gt;f_mode
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* FIXME: use the uniqueID from the remote instead? */
multiline_comment|/* 0 L file size in bytes */
multiline_comment|/* 8 L file size on disk in bytes (block count) */
multiline_comment|/* 40 L uid */
multiline_comment|/* 48 L gid */
multiline_comment|/* 56 W file type */
multiline_comment|/* 60 L devmajor */
multiline_comment|/* 68 L devminor */
multiline_comment|/* 76 L unique ID (inode) */
multiline_comment|/* 84 L permissions */
multiline_comment|/* 92 L link count */
id|fattr-&gt;f_size
op_assign
id|LVAL
c_func
(paren
id|p
comma
l_int|0
)paren
suffix:semicolon
id|fattr-&gt;f_blocks
op_assign
id|LVAL
c_func
(paren
id|p
comma
l_int|8
)paren
suffix:semicolon
id|fattr-&gt;f_ctime
op_assign
id|smb_ntutc2unixutc
c_func
(paren
id|LVAL
c_func
(paren
id|p
comma
l_int|16
)paren
)paren
suffix:semicolon
id|fattr-&gt;f_atime
op_assign
id|smb_ntutc2unixutc
c_func
(paren
id|LVAL
c_func
(paren
id|p
comma
l_int|24
)paren
)paren
suffix:semicolon
id|fattr-&gt;f_mtime
op_assign
id|smb_ntutc2unixutc
c_func
(paren
id|LVAL
c_func
(paren
id|p
comma
l_int|32
)paren
)paren
suffix:semicolon
id|fattr-&gt;f_uid
op_assign
id|LVAL
c_func
(paren
id|p
comma
l_int|40
)paren
suffix:semicolon
id|fattr-&gt;f_gid
op_assign
id|LVAL
c_func
(paren
id|p
comma
l_int|48
)paren
suffix:semicolon
id|fattr-&gt;f_mode
op_or_assign
id|smb_filetype_to_mode
c_func
(paren
id|WVAL
c_func
(paren
id|p
comma
l_int|56
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|S_ISBLK
c_func
(paren
id|fattr-&gt;f_mode
)paren
op_logical_or
id|S_ISCHR
c_func
(paren
id|fattr-&gt;f_mode
)paren
)paren
(brace
id|devmajor
op_assign
id|LVAL
c_func
(paren
id|p
comma
l_int|60
)paren
suffix:semicolon
id|devminor
op_assign
id|LVAL
c_func
(paren
id|p
comma
l_int|68
)paren
suffix:semicolon
id|fattr-&gt;f_rdev
op_assign
(paren
(paren
id|devmajor
op_amp
l_int|0xFF
)paren
op_lshift
l_int|8
)paren
op_or
(paren
id|devminor
op_amp
l_int|0xFF
)paren
suffix:semicolon
)brace
id|fattr-&gt;f_mode
op_or_assign
id|LVAL
c_func
(paren
id|p
comma
l_int|84
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Interpret a long filename structure using the specified info level:&n; *   level 1 for anything below NT1 protocol&n; *   level 260 for NT1 protocol&n; *&n; * qname is filled with the decoded, and possibly translated, name&n; * fattr receives decoded attributes.&n; *&n; * Bugs Noted:&n; * (1) Win NT 4.0 appends a null byte to names and counts it in the length!&n; */
r_static
r_char
op_star
DECL|function|smb_decode_long_dirent
id|smb_decode_long_dirent
c_func
(paren
r_struct
id|smb_sb_info
op_star
id|server
comma
r_char
op_star
id|p
comma
r_int
id|level
comma
r_struct
id|qstr
op_star
id|qname
comma
r_struct
id|smb_fattr
op_star
id|fattr
comma
r_int
r_char
op_star
id|name_buf
)paren
(brace
r_char
op_star
id|result
suffix:semicolon
r_int
r_int
id|len
op_assign
l_int|0
suffix:semicolon
r_int
id|n
suffix:semicolon
id|__u16
id|date
comma
id|time
suffix:semicolon
r_int
id|unicode
op_assign
(paren
id|server-&gt;mnt-&gt;flags
op_amp
id|SMB_MOUNT_UNICODE
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * SMB doesn&squot;t have a concept of inode numbers ...&n;&t; */
id|smb_init_dirent
c_func
(paren
id|server
comma
id|fattr
)paren
suffix:semicolon
id|fattr-&gt;f_ino
op_assign
l_int|0
suffix:semicolon
multiline_comment|/* FIXME: do we need this? */
r_switch
c_cond
(paren
id|level
)paren
(brace
r_case
l_int|1
suffix:colon
id|len
op_assign
op_star
(paren
(paren
r_int
r_char
op_star
)paren
id|p
op_plus
l_int|22
)paren
suffix:semicolon
id|qname-&gt;name
op_assign
id|p
op_plus
l_int|23
suffix:semicolon
id|result
op_assign
id|p
op_plus
l_int|24
op_plus
id|len
suffix:semicolon
id|date
op_assign
id|WVAL
c_func
(paren
id|p
comma
l_int|0
)paren
suffix:semicolon
id|time
op_assign
id|WVAL
c_func
(paren
id|p
comma
l_int|2
)paren
suffix:semicolon
id|fattr-&gt;f_ctime.tv_sec
op_assign
id|date_dos2unix
c_func
(paren
id|server
comma
id|date
comma
id|time
)paren
suffix:semicolon
id|fattr-&gt;f_ctime.tv_nsec
op_assign
l_int|0
suffix:semicolon
id|date
op_assign
id|WVAL
c_func
(paren
id|p
comma
l_int|4
)paren
suffix:semicolon
id|time
op_assign
id|WVAL
c_func
(paren
id|p
comma
l_int|6
)paren
suffix:semicolon
id|fattr-&gt;f_atime.tv_sec
op_assign
id|date_dos2unix
c_func
(paren
id|server
comma
id|date
comma
id|time
)paren
suffix:semicolon
id|fattr-&gt;f_atime.tv_nsec
op_assign
l_int|0
suffix:semicolon
id|date
op_assign
id|WVAL
c_func
(paren
id|p
comma
l_int|8
)paren
suffix:semicolon
id|time
op_assign
id|WVAL
c_func
(paren
id|p
comma
l_int|10
)paren
suffix:semicolon
id|fattr-&gt;f_mtime.tv_sec
op_assign
id|date_dos2unix
c_func
(paren
id|server
comma
id|date
comma
id|time
)paren
suffix:semicolon
id|fattr-&gt;f_mtime.tv_nsec
op_assign
l_int|0
suffix:semicolon
id|fattr-&gt;f_size
op_assign
id|DVAL
c_func
(paren
id|p
comma
l_int|12
)paren
suffix:semicolon
multiline_comment|/* ULONG allocation size */
id|fattr-&gt;attr
op_assign
id|WVAL
c_func
(paren
id|p
comma
l_int|20
)paren
suffix:semicolon
id|VERBOSE
c_func
(paren
l_string|&quot;info 1 at %p, len=%d, name=%.*s&bslash;n&quot;
comma
id|p
comma
id|len
comma
id|len
comma
id|qname-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|260
suffix:colon
id|result
op_assign
id|p
op_plus
id|WVAL
c_func
(paren
id|p
comma
l_int|0
)paren
suffix:semicolon
id|len
op_assign
id|DVAL
c_func
(paren
id|p
comma
l_int|60
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
OG
l_int|255
)paren
id|len
op_assign
l_int|255
suffix:semicolon
multiline_comment|/* NT4 null terminates, unless we are using unicode ... */
id|qname-&gt;name
op_assign
id|p
op_plus
l_int|94
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|unicode
op_logical_and
id|len
op_logical_and
id|qname-&gt;name
(braket
id|len
op_minus
l_int|1
)braket
op_eq
l_char|&squot;&bslash;0&squot;
)paren
id|len
op_decrement
suffix:semicolon
id|fattr-&gt;f_ctime
op_assign
id|smb_ntutc2unixutc
c_func
(paren
id|LVAL
c_func
(paren
id|p
comma
l_int|8
)paren
)paren
suffix:semicolon
id|fattr-&gt;f_atime
op_assign
id|smb_ntutc2unixutc
c_func
(paren
id|LVAL
c_func
(paren
id|p
comma
l_int|16
)paren
)paren
suffix:semicolon
id|fattr-&gt;f_mtime
op_assign
id|smb_ntutc2unixutc
c_func
(paren
id|LVAL
c_func
(paren
id|p
comma
l_int|24
)paren
)paren
suffix:semicolon
multiline_comment|/* change time (32) */
id|fattr-&gt;f_size
op_assign
id|LVAL
c_func
(paren
id|p
comma
l_int|40
)paren
suffix:semicolon
multiline_comment|/* alloc size (48) */
id|fattr-&gt;attr
op_assign
id|DVAL
c_func
(paren
id|p
comma
l_int|56
)paren
suffix:semicolon
id|VERBOSE
c_func
(paren
l_string|&quot;info 260 at %p, len=%d, name=%.*s&bslash;n&quot;
comma
id|p
comma
id|len
comma
id|len
comma
id|qname-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SMB_FIND_FILE_UNIX
suffix:colon
id|result
op_assign
id|p
op_plus
id|WVAL
c_func
(paren
id|p
comma
l_int|0
)paren
suffix:semicolon
id|qname-&gt;name
op_assign
id|p
op_plus
l_int|108
suffix:semicolon
id|len
op_assign
id|strlen
c_func
(paren
id|qname-&gt;name
)paren
suffix:semicolon
multiline_comment|/* FIXME: should we check the length?? */
id|p
op_add_assign
l_int|8
suffix:semicolon
id|smb_decode_unix_basic
c_func
(paren
id|fattr
comma
id|p
)paren
suffix:semicolon
id|VERBOSE
c_func
(paren
l_string|&quot;info SMB_FIND_FILE_UNIX at %p, len=%d, name=%.*s&bslash;n&quot;
comma
id|p
comma
id|len
comma
id|len
comma
id|qname-&gt;name
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|PARANOIA
c_func
(paren
l_string|&quot;Unknown info level %d&bslash;n&quot;
comma
id|level
)paren
suffix:semicolon
id|result
op_assign
id|p
op_plus
id|WVAL
c_func
(paren
id|p
comma
l_int|0
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|smb_finish_dirent
c_func
(paren
id|server
comma
id|fattr
)paren
suffix:semicolon
macro_line|#if 0
multiline_comment|/* FIXME: These only work for ascii chars, and recent smbmount doesn&squot;t&n;&t;   allow the flag to be set anyway. Remove? */
r_switch
c_cond
(paren
id|server-&gt;opt.case_handling
)paren
(brace
r_case
id|SMB_CASE_UPPER
suffix:colon
id|str_upper
c_func
(paren
id|qname-&gt;name
comma
id|len
)paren
suffix:semicolon
r_break
suffix:semicolon
r_case
id|SMB_CASE_LOWER
suffix:colon
id|str_lower
c_func
(paren
id|qname-&gt;name
comma
id|len
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
r_break
suffix:semicolon
)brace
macro_line|#endif
id|qname-&gt;len
op_assign
l_int|0
suffix:semicolon
id|n
op_assign
id|server-&gt;ops
op_member_access_from_pointer
id|convert
c_func
(paren
id|name_buf
comma
id|SMB_MAXNAMELEN
comma
id|qname-&gt;name
comma
id|len
comma
id|server-&gt;remote_nls
comma
id|server-&gt;local_nls
)paren
suffix:semicolon
r_if
c_cond
(paren
id|n
OG
l_int|0
)paren
(brace
id|qname-&gt;len
op_assign
id|n
suffix:semicolon
id|qname-&gt;name
op_assign
id|name_buf
suffix:semicolon
)brace
id|out
suffix:colon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/* findfirst/findnext flags */
DECL|macro|SMB_CLOSE_AFTER_FIRST
mdefine_line|#define SMB_CLOSE_AFTER_FIRST (1&lt;&lt;0)
DECL|macro|SMB_CLOSE_IF_END
mdefine_line|#define SMB_CLOSE_IF_END (1&lt;&lt;1)
DECL|macro|SMB_REQUIRE_RESUME_KEY
mdefine_line|#define SMB_REQUIRE_RESUME_KEY (1&lt;&lt;2)
DECL|macro|SMB_CONTINUE_BIT
mdefine_line|#define SMB_CONTINUE_BIT (1&lt;&lt;3)
multiline_comment|/*&n; * Note: samba-2.0.7 (at least) has a very similar routine, cli_list, in&n; * source/libsmb/clilist.c. When looking for smb bugs in the readdir code,&n; * go there for advise.&n; *&n; * Bugs Noted:&n; * (1) When using Info Level 1 Win NT 4.0 truncates directory listings &n; * for certain patterns of names and/or lengths. The breakage pattern&n; * is completely reproducible and can be toggled by the creation of a&n; * single file. (E.g. echo hi &gt;foo breaks, rm -f foo works.)&n; */
r_static
r_int
DECL|function|smb_proc_readdir_long
id|smb_proc_readdir_long
c_func
(paren
r_struct
id|file
op_star
id|filp
comma
r_void
op_star
id|dirent
comma
id|filldir_t
id|filldir
comma
r_struct
id|smb_cache_control
op_star
id|ctl
)paren
(brace
r_struct
id|dentry
op_star
id|dir
op_assign
id|filp-&gt;f_dentry
suffix:semicolon
r_struct
id|smb_sb_info
op_star
id|server
op_assign
id|server_from_dentry
c_func
(paren
id|dir
)paren
suffix:semicolon
r_struct
id|qstr
id|qname
suffix:semicolon
r_struct
id|smb_fattr
id|fattr
suffix:semicolon
r_int
r_char
op_star
id|p
comma
op_star
id|lastname
suffix:semicolon
r_char
op_star
id|mask
comma
op_star
id|param
suffix:semicolon
id|__u16
id|command
suffix:semicolon
r_int
id|first
comma
id|entries_seen
suffix:semicolon
multiline_comment|/* Both NT and OS/2 accept info level 1 (but see note below). */
r_int
id|info_level
op_assign
l_int|260
suffix:semicolon
r_const
r_int
id|max_matches
op_assign
l_int|512
suffix:semicolon
r_int
r_int
id|ff_searchcount
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|ff_eos
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|ff_lastname
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|ff_dir_handle
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|loop_count
op_assign
l_int|0
suffix:semicolon
r_int
r_int
id|mask_len
comma
id|i
suffix:semicolon
r_int
id|result
suffix:semicolon
r_struct
id|smb_request
op_star
id|req
suffix:semicolon
r_int
r_char
op_star
id|name_buf
suffix:semicolon
r_static
r_struct
id|qstr
id|star
op_assign
(brace
dot
id|name
op_assign
l_string|&quot;*&quot;
comma
dot
id|len
op_assign
l_int|1
comma
)brace
suffix:semicolon
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/*&n;&t; * We always prefer unix style. Use info level 1 for older&n;&t; * servers that don&squot;t do 260.&n;&t; */
r_if
c_cond
(paren
id|server-&gt;opt.capabilities
op_amp
id|SMB_CAP_UNIX
)paren
id|info_level
op_assign
id|SMB_FIND_FILE_UNIX
suffix:semicolon
r_else
r_if
c_cond
(paren
id|server-&gt;opt.protocol
OL
id|SMB_PROTOCOL_NT1
)paren
id|info_level
op_assign
l_int|1
suffix:semicolon
id|result
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|name_buf
op_assign
id|kmalloc
c_func
(paren
id|SMB_MAXNAMELEN
op_plus
l_int|2
comma
id|GFP_KERNEL
)paren
)paren
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|req
op_assign
id|smb_alloc_request
c_func
(paren
id|server
comma
id|server-&gt;opt.max_xmit
)paren
)paren
)paren
r_goto
id|out_name
suffix:semicolon
id|param
op_assign
id|req-&gt;rq_buffer
suffix:semicolon
multiline_comment|/*&n;&t; * Encode the initial path&n;&t; */
id|mask
op_assign
id|param
op_plus
l_int|12
suffix:semicolon
id|mask_len
op_assign
id|smb_encode_path
c_func
(paren
id|server
comma
id|mask
comma
id|SMB_MAXPATHLEN
op_plus
l_int|1
comma
id|dir
comma
op_amp
id|star
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mask_len
OL
l_int|0
)paren
(brace
id|result
op_assign
id|mask_len
suffix:semicolon
r_goto
id|out_free
suffix:semicolon
)brace
id|mask_len
op_decrement
suffix:semicolon
multiline_comment|/* mask_len is strlen, not #bytes */
id|first
op_assign
l_int|1
suffix:semicolon
id|VERBOSE
c_func
(paren
l_string|&quot;starting mask_len=%d, mask=%s&bslash;n&quot;
comma
id|mask_len
comma
id|mask
)paren
suffix:semicolon
id|result
op_assign
l_int|0
suffix:semicolon
id|entries_seen
op_assign
l_int|2
suffix:semicolon
id|ff_eos
op_assign
l_int|0
suffix:semicolon
r_while
c_loop
(paren
id|ff_eos
op_eq
l_int|0
)paren
(brace
id|loop_count
op_add_assign
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|loop_count
OG
l_int|10
)paren
(brace
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;smb_proc_readdir_long: &quot;
l_string|&quot;Looping in FIND_NEXT??&bslash;n&quot;
)paren
suffix:semicolon
id|result
op_assign
op_minus
id|EIO
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|first
op_ne
l_int|0
)paren
(brace
id|command
op_assign
id|TRANSACT2_FINDFIRST
suffix:semicolon
id|WSET
c_func
(paren
id|param
comma
l_int|0
comma
id|aSYSTEM
op_or
id|aHIDDEN
op_or
id|aDIR
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|param
comma
l_int|2
comma
id|max_matches
)paren
suffix:semicolon
multiline_comment|/* max count */
id|WSET
c_func
(paren
id|param
comma
l_int|4
comma
id|SMB_CLOSE_IF_END
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|param
comma
l_int|6
comma
id|info_level
)paren
suffix:semicolon
id|DSET
c_func
(paren
id|param
comma
l_int|8
comma
l_int|0
)paren
suffix:semicolon
)brace
r_else
(brace
id|command
op_assign
id|TRANSACT2_FINDNEXT
suffix:semicolon
id|VERBOSE
c_func
(paren
l_string|&quot;handle=0x%X, lastname=%d, mask=%.*s&bslash;n&quot;
comma
id|ff_dir_handle
comma
id|ff_lastname
comma
id|mask_len
comma
id|mask
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|param
comma
l_int|0
comma
id|ff_dir_handle
)paren
suffix:semicolon
multiline_comment|/* search handle */
id|WSET
c_func
(paren
id|param
comma
l_int|2
comma
id|max_matches
)paren
suffix:semicolon
multiline_comment|/* max count */
id|WSET
c_func
(paren
id|param
comma
l_int|4
comma
id|info_level
)paren
suffix:semicolon
id|DSET
c_func
(paren
id|param
comma
l_int|6
comma
l_int|0
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|param
comma
l_int|10
comma
id|SMB_CONTINUE_BIT
op_or
id|SMB_CLOSE_IF_END
)paren
suffix:semicolon
)brace
id|req-&gt;rq_trans2_command
op_assign
id|command
suffix:semicolon
id|req-&gt;rq_ldata
op_assign
l_int|0
suffix:semicolon
id|req-&gt;rq_data
op_assign
l_int|NULL
suffix:semicolon
id|req-&gt;rq_lparm
op_assign
l_int|12
op_plus
id|mask_len
op_plus
l_int|1
suffix:semicolon
id|req-&gt;rq_parm
op_assign
id|param
suffix:semicolon
id|req-&gt;rq_flags
op_assign
l_int|0
suffix:semicolon
id|result
op_assign
id|smb_add_request
c_func
(paren
id|req
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
(brace
id|PARANOIA
c_func
(paren
l_string|&quot;error=%d, breaking&bslash;n&quot;
comma
id|result
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|req-&gt;rq_rcls
op_eq
id|ERRSRV
op_logical_and
id|req-&gt;rq_err
op_eq
id|ERRerror
)paren
(brace
multiline_comment|/* a damn Win95 bug - sometimes it clags if you &n;&t;&t;&t;   ask it too fast */
id|current-&gt;state
op_assign
id|TASK_INTERRUPTIBLE
suffix:semicolon
id|schedule_timeout
c_func
(paren
id|HZ
op_div
l_int|5
)paren
suffix:semicolon
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
id|req-&gt;rq_rcls
op_ne
l_int|0
)paren
(brace
id|result
op_assign
id|smb_errno
c_func
(paren
id|req
)paren
suffix:semicolon
id|PARANOIA
c_func
(paren
l_string|&quot;name=%s, result=%d, rcls=%d, err=%d&bslash;n&quot;
comma
id|mask
comma
id|result
comma
id|server-&gt;rcls
comma
id|server-&gt;err
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/* parse out some important return info */
r_if
c_cond
(paren
id|first
op_ne
l_int|0
)paren
(brace
id|ff_dir_handle
op_assign
id|WVAL
c_func
(paren
id|req-&gt;rq_parm
comma
l_int|0
)paren
suffix:semicolon
id|ff_searchcount
op_assign
id|WVAL
c_func
(paren
id|req-&gt;rq_parm
comma
l_int|2
)paren
suffix:semicolon
id|ff_eos
op_assign
id|WVAL
c_func
(paren
id|req-&gt;rq_parm
comma
l_int|4
)paren
suffix:semicolon
id|ff_lastname
op_assign
id|WVAL
c_func
(paren
id|req-&gt;rq_parm
comma
l_int|8
)paren
suffix:semicolon
)brace
r_else
(brace
id|ff_searchcount
op_assign
id|WVAL
c_func
(paren
id|req-&gt;rq_parm
comma
l_int|0
)paren
suffix:semicolon
id|ff_eos
op_assign
id|WVAL
c_func
(paren
id|req-&gt;rq_parm
comma
l_int|2
)paren
suffix:semicolon
id|ff_lastname
op_assign
id|WVAL
c_func
(paren
id|req-&gt;rq_parm
comma
l_int|6
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ff_searchcount
op_eq
l_int|0
)paren
r_break
suffix:semicolon
multiline_comment|/* Now we are ready to parse smb directory entries. */
multiline_comment|/* point to the data bytes */
id|p
op_assign
id|req-&gt;rq_data
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ff_searchcount
suffix:semicolon
id|i
op_increment
)paren
(brace
multiline_comment|/* make sure we stay within the buffer */
r_if
c_cond
(paren
id|p
op_ge
id|req-&gt;rq_data
op_plus
id|req-&gt;rq_ldata
)paren
(brace
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;smb_proc_readdir_long: &quot;
l_string|&quot;dirent pointer outside buffer! &quot;
l_string|&quot;%p  %d@%p&bslash;n&quot;
comma
id|p
comma
id|req-&gt;rq_ldata
comma
id|req-&gt;rq_data
)paren
suffix:semicolon
id|result
op_assign
op_minus
id|EIO
suffix:semicolon
multiline_comment|/* always a comm. error? */
r_goto
id|out_free
suffix:semicolon
)brace
id|p
op_assign
id|smb_decode_long_dirent
c_func
(paren
id|server
comma
id|p
comma
id|info_level
comma
op_amp
id|qname
comma
op_amp
id|fattr
comma
id|name_buf
)paren
suffix:semicolon
multiline_comment|/* ignore . and .. from the server */
r_if
c_cond
(paren
id|entries_seen
op_eq
l_int|2
op_logical_and
id|qname.name
(braket
l_int|0
)braket
op_eq
l_char|&squot;.&squot;
)paren
(brace
r_if
c_cond
(paren
id|qname.len
op_eq
l_int|1
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
id|qname.name
(braket
l_int|1
)braket
op_eq
l_char|&squot;.&squot;
op_logical_and
id|qname.len
op_eq
l_int|2
)paren
r_continue
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|smb_fill_cache
c_func
(paren
id|filp
comma
id|dirent
comma
id|filldir
comma
id|ctl
comma
op_amp
id|qname
comma
op_amp
id|fattr
)paren
)paren
suffix:semicolon
multiline_comment|/* stop reading? */
id|entries_seen
op_increment
suffix:semicolon
)brace
id|VERBOSE
c_func
(paren
l_string|&quot;received %d entries, eos=%d&bslash;n&quot;
comma
id|ff_searchcount
comma
id|ff_eos
)paren
suffix:semicolon
multiline_comment|/*&n;&t;&t; * We might need the lastname for continuations.&n;&t;&t; *&n;&t;&t; * Note that some servers (win95?) point to the filename and&n;&t;&t; * others (NT4, Samba using NT1) to the dir entry. We assume&n;&t;&t; * here that those who do not point to a filename do not need&n;&t;&t; * this info to continue the listing.&n;&t;&t; *&n;&t;&t; * OS/2 needs this and talks infolevel 1.&n;&t;&t; * NetApps want lastname with infolevel 260.&n;&t;&t; * win2k want lastname with infolevel 260, and points to&n;&t;&t; *       the record not to the name.&n;&t;&t; * Samba+CifsUnixExt doesn&squot;t need lastname.&n;&t;&t; *&n;&t;&t; * Both are happy if we return the data they point to. So we do.&n;&t;&t; * (FIXME: above is not true with win2k)&n;&t;&t; */
id|mask_len
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|info_level
op_ne
id|SMB_FIND_FILE_UNIX
op_logical_and
id|ff_lastname
OG
l_int|0
op_logical_and
id|ff_lastname
OL
id|req-&gt;rq_ldata
)paren
(brace
id|lastname
op_assign
id|req-&gt;rq_data
op_plus
id|ff_lastname
suffix:semicolon
r_switch
c_cond
(paren
id|info_level
)paren
(brace
r_case
l_int|260
suffix:colon
id|mask_len
op_assign
id|req-&gt;rq_ldata
op_minus
id|ff_lastname
suffix:semicolon
r_break
suffix:semicolon
r_case
l_int|1
suffix:colon
multiline_comment|/* lastname points to a length byte */
id|mask_len
op_assign
op_star
id|lastname
op_increment
suffix:semicolon
r_if
c_cond
(paren
id|ff_lastname
op_plus
l_int|1
op_plus
id|mask_len
OG
id|req-&gt;rq_ldata
)paren
id|mask_len
op_assign
id|req-&gt;rq_ldata
op_minus
id|ff_lastname
op_minus
l_int|1
suffix:semicolon
r_break
suffix:semicolon
)brace
multiline_comment|/*&n;&t;&t;&t; * Update the mask string for the next message.&n;&t;&t;&t; */
r_if
c_cond
(paren
id|mask_len
OL
l_int|0
)paren
id|mask_len
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|mask_len
OG
l_int|255
)paren
id|mask_len
op_assign
l_int|255
suffix:semicolon
r_if
c_cond
(paren
id|mask_len
)paren
id|strncpy
c_func
(paren
id|mask
comma
id|lastname
comma
id|mask_len
)paren
suffix:semicolon
)brace
id|mask_len
op_assign
id|strnlen
c_func
(paren
id|mask
comma
id|mask_len
)paren
suffix:semicolon
id|VERBOSE
c_func
(paren
l_string|&quot;new mask, len=%d@%d of %d, mask=%.*s&bslash;n&quot;
comma
id|mask_len
comma
id|ff_lastname
comma
id|req-&gt;rq_ldata
comma
id|mask_len
comma
id|mask
)paren
suffix:semicolon
id|first
op_assign
l_int|0
suffix:semicolon
id|loop_count
op_assign
l_int|0
suffix:semicolon
)brace
id|out_free
suffix:colon
id|smb_rput
c_func
(paren
id|req
)paren
suffix:semicolon
id|out_name
suffix:colon
id|kfree
c_func
(paren
id|name_buf
)paren
suffix:semicolon
id|out
suffix:colon
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/*&n; * This version uses the trans2 TRANSACT2_FINDFIRST message &n; * to get the attribute data.&n; *&n; * Bugs Noted:&n; */
r_static
r_int
DECL|function|smb_proc_getattr_ff
id|smb_proc_getattr_ff
c_func
(paren
r_struct
id|smb_sb_info
op_star
id|server
comma
r_struct
id|dentry
op_star
id|dentry
comma
r_struct
id|smb_fattr
op_star
id|fattr
)paren
(brace
r_char
op_star
id|param
comma
op_star
id|mask
suffix:semicolon
id|__u16
id|date
comma
id|time
suffix:semicolon
r_int
id|mask_len
comma
id|result
suffix:semicolon
r_struct
id|smb_request
op_star
id|req
suffix:semicolon
id|result
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|req
op_assign
id|smb_alloc_request
c_func
(paren
id|server
comma
id|PAGE_SIZE
)paren
)paren
)paren
r_goto
id|out
suffix:semicolon
id|param
op_assign
id|req-&gt;rq_buffer
suffix:semicolon
id|mask
op_assign
id|param
op_plus
l_int|12
suffix:semicolon
id|mask_len
op_assign
id|smb_encode_path
c_func
(paren
id|server
comma
id|mask
comma
id|SMB_MAXPATHLEN
op_plus
l_int|1
comma
id|dentry
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|mask_len
OL
l_int|0
)paren
(brace
id|result
op_assign
id|mask_len
suffix:semicolon
r_goto
id|out_free
suffix:semicolon
)brace
id|VERBOSE
c_func
(paren
l_string|&quot;name=%s, len=%d&bslash;n&quot;
comma
id|mask
comma
id|mask_len
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|param
comma
l_int|0
comma
id|aSYSTEM
op_or
id|aHIDDEN
op_or
id|aDIR
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|param
comma
l_int|2
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* max count */
id|WSET
c_func
(paren
id|param
comma
l_int|4
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* close after this call */
id|WSET
c_func
(paren
id|param
comma
l_int|6
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* info_level */
id|DSET
c_func
(paren
id|param
comma
l_int|8
comma
l_int|0
)paren
suffix:semicolon
id|req-&gt;rq_trans2_command
op_assign
id|TRANSACT2_FINDFIRST
suffix:semicolon
id|req-&gt;rq_ldata
op_assign
l_int|0
suffix:semicolon
id|req-&gt;rq_data
op_assign
l_int|NULL
suffix:semicolon
id|req-&gt;rq_lparm
op_assign
l_int|12
op_plus
id|mask_len
suffix:semicolon
id|req-&gt;rq_parm
op_assign
id|param
suffix:semicolon
id|req-&gt;rq_flags
op_assign
l_int|0
suffix:semicolon
id|result
op_assign
id|smb_add_request
c_func
(paren
id|req
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
r_goto
id|out_free
suffix:semicolon
r_if
c_cond
(paren
id|server-&gt;rcls
op_ne
l_int|0
)paren
(brace
id|result
op_assign
id|smb_errno
c_func
(paren
id|req
)paren
suffix:semicolon
macro_line|#ifdef SMBFS_PARANOIA
r_if
c_cond
(paren
id|result
op_ne
op_minus
id|ENOENT
)paren
id|PARANOIA
c_func
(paren
l_string|&quot;error for %s, rcls=%d, err=%d&bslash;n&quot;
comma
id|mask
comma
id|req-&gt;rq_rcls
comma
id|req-&gt;rq_err
)paren
suffix:semicolon
macro_line|#endif
r_goto
id|out_free
suffix:semicolon
)brace
multiline_comment|/* Make sure we got enough data ... */
id|result
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|req-&gt;rq_ldata
OL
l_int|22
op_logical_or
id|WVAL
c_func
(paren
id|req-&gt;rq_parm
comma
l_int|2
)paren
op_ne
l_int|1
)paren
(brace
id|PARANOIA
c_func
(paren
l_string|&quot;bad result for %s, len=%d, count=%d&bslash;n&quot;
comma
id|mask
comma
id|req-&gt;rq_ldata
comma
id|WVAL
c_func
(paren
id|req-&gt;rq_parm
comma
l_int|2
)paren
)paren
suffix:semicolon
r_goto
id|out_free
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * Decode the response into the fattr ...&n;&t; */
id|date
op_assign
id|WVAL
c_func
(paren
id|req-&gt;rq_data
comma
l_int|0
)paren
suffix:semicolon
id|time
op_assign
id|WVAL
c_func
(paren
id|req-&gt;rq_data
comma
l_int|2
)paren
suffix:semicolon
id|fattr-&gt;f_ctime.tv_sec
op_assign
id|date_dos2unix
c_func
(paren
id|server
comma
id|date
comma
id|time
)paren
suffix:semicolon
id|fattr-&gt;f_ctime.tv_nsec
op_assign
l_int|0
suffix:semicolon
id|date
op_assign
id|WVAL
c_func
(paren
id|req-&gt;rq_data
comma
l_int|4
)paren
suffix:semicolon
id|time
op_assign
id|WVAL
c_func
(paren
id|req-&gt;rq_data
comma
l_int|6
)paren
suffix:semicolon
id|fattr-&gt;f_atime.tv_sec
op_assign
id|date_dos2unix
c_func
(paren
id|server
comma
id|date
comma
id|time
)paren
suffix:semicolon
id|fattr-&gt;f_atime.tv_nsec
op_assign
l_int|0
suffix:semicolon
id|date
op_assign
id|WVAL
c_func
(paren
id|req-&gt;rq_data
comma
l_int|8
)paren
suffix:semicolon
id|time
op_assign
id|WVAL
c_func
(paren
id|req-&gt;rq_data
comma
l_int|10
)paren
suffix:semicolon
id|fattr-&gt;f_mtime.tv_sec
op_assign
id|date_dos2unix
c_func
(paren
id|server
comma
id|date
comma
id|time
)paren
suffix:semicolon
id|fattr-&gt;f_mtime.tv_nsec
op_assign
l_int|0
suffix:semicolon
id|VERBOSE
c_func
(paren
l_string|&quot;name=%s, date=%x, time=%x, mtime=%ld&bslash;n&quot;
comma
id|mask
comma
id|date
comma
id|time
comma
id|fattr-&gt;f_mtime
)paren
suffix:semicolon
id|fattr-&gt;f_size
op_assign
id|DVAL
c_func
(paren
id|req-&gt;rq_data
comma
l_int|12
)paren
suffix:semicolon
multiline_comment|/* ULONG allocation size */
id|fattr-&gt;attr
op_assign
id|WVAL
c_func
(paren
id|req-&gt;rq_data
comma
l_int|20
)paren
suffix:semicolon
id|result
op_assign
l_int|0
suffix:semicolon
id|out_free
suffix:colon
id|smb_rput
c_func
(paren
id|req
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|result
suffix:semicolon
)brace
r_static
r_int
DECL|function|smb_proc_getattr_core
id|smb_proc_getattr_core
c_func
(paren
r_struct
id|smb_sb_info
op_star
id|server
comma
r_struct
id|dentry
op_star
id|dir
comma
r_struct
id|smb_fattr
op_star
id|fattr
)paren
(brace
r_int
id|result
suffix:semicolon
r_char
op_star
id|p
suffix:semicolon
r_struct
id|smb_request
op_star
id|req
suffix:semicolon
id|result
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|req
op_assign
id|smb_alloc_request
c_func
(paren
id|server
comma
id|PAGE_SIZE
)paren
)paren
)paren
r_goto
id|out
suffix:semicolon
id|p
op_assign
id|smb_setup_header
c_func
(paren
id|req
comma
id|SMBgetatr
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
id|result
op_assign
id|smb_simple_encode_path
c_func
(paren
id|req
comma
op_amp
id|p
comma
id|dir
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
r_goto
id|out_free
suffix:semicolon
id|smb_setup_bcc
c_func
(paren
id|req
comma
id|p
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_assign
id|smb_request_ok
c_func
(paren
id|req
comma
id|SMBgetatr
comma
l_int|10
comma
l_int|0
)paren
)paren
OL
l_int|0
)paren
r_goto
id|out_free
suffix:semicolon
id|fattr-&gt;attr
op_assign
id|WVAL
c_func
(paren
id|req-&gt;rq_header
comma
id|smb_vwv0
)paren
suffix:semicolon
id|fattr-&gt;f_mtime.tv_sec
op_assign
id|local2utc
c_func
(paren
id|server
comma
id|DVAL
c_func
(paren
id|req-&gt;rq_header
comma
id|smb_vwv1
)paren
)paren
suffix:semicolon
id|fattr-&gt;f_mtime.tv_nsec
op_assign
l_int|0
suffix:semicolon
id|fattr-&gt;f_size
op_assign
id|DVAL
c_func
(paren
id|req-&gt;rq_header
comma
id|smb_vwv3
)paren
suffix:semicolon
id|fattr-&gt;f_ctime
op_assign
id|fattr-&gt;f_mtime
suffix:semicolon
id|fattr-&gt;f_atime
op_assign
id|fattr-&gt;f_mtime
suffix:semicolon
macro_line|#ifdef SMBFS_DEBUG_TIMESTAMP
id|printk
c_func
(paren
l_string|&quot;getattr_core: %s/%s, mtime=%ld&bslash;n&quot;
comma
id|DENTRY_PATH
c_func
(paren
id|dir
)paren
comma
id|fattr-&gt;f_mtime
)paren
suffix:semicolon
macro_line|#endif
id|result
op_assign
l_int|0
suffix:semicolon
id|out_free
suffix:colon
id|smb_rput
c_func
(paren
id|req
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/*&n; * Bugs Noted:&n; * (1) Win 95 swaps the date and time fields in the standard info level.&n; */
r_static
r_int
DECL|function|smb_proc_getattr_trans2
id|smb_proc_getattr_trans2
c_func
(paren
r_struct
id|smb_sb_info
op_star
id|server
comma
r_struct
id|dentry
op_star
id|dir
comma
r_struct
id|smb_request
op_star
id|req
comma
r_int
id|infolevel
)paren
(brace
r_char
op_star
id|p
comma
op_star
id|param
suffix:semicolon
r_int
id|result
suffix:semicolon
id|param
op_assign
id|req-&gt;rq_buffer
suffix:semicolon
id|WSET
c_func
(paren
id|param
comma
l_int|0
comma
id|infolevel
)paren
suffix:semicolon
id|DSET
c_func
(paren
id|param
comma
l_int|2
comma
l_int|0
)paren
suffix:semicolon
id|result
op_assign
id|smb_encode_path
c_func
(paren
id|server
comma
id|param
op_plus
l_int|6
comma
id|SMB_MAXPATHLEN
op_plus
l_int|1
comma
id|dir
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
r_goto
id|out
suffix:semicolon
id|p
op_assign
id|param
op_plus
l_int|6
op_plus
id|result
suffix:semicolon
id|req-&gt;rq_trans2_command
op_assign
id|TRANSACT2_QPATHINFO
suffix:semicolon
id|req-&gt;rq_ldata
op_assign
l_int|0
suffix:semicolon
id|req-&gt;rq_data
op_assign
l_int|NULL
suffix:semicolon
id|req-&gt;rq_lparm
op_assign
id|p
op_minus
id|param
suffix:semicolon
id|req-&gt;rq_parm
op_assign
id|param
suffix:semicolon
id|req-&gt;rq_flags
op_assign
l_int|0
suffix:semicolon
id|result
op_assign
id|smb_add_request
c_func
(paren
id|req
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|server-&gt;rcls
op_ne
l_int|0
)paren
(brace
id|VERBOSE
c_func
(paren
l_string|&quot;for %s: result=%d, rcls=%d, err=%d&bslash;n&quot;
comma
op_amp
id|param
(braket
l_int|6
)braket
comma
id|result
comma
id|req-&gt;rq_rcls
comma
id|req-&gt;rq_err
)paren
suffix:semicolon
id|result
op_assign
id|smb_errno
c_func
(paren
id|req
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|result
op_assign
op_minus
id|ENOENT
suffix:semicolon
r_if
c_cond
(paren
id|req-&gt;rq_ldata
OL
l_int|22
)paren
(brace
id|PARANOIA
c_func
(paren
l_string|&quot;not enough data for %s, len=%d&bslash;n&quot;
comma
op_amp
id|param
(braket
l_int|6
)braket
comma
id|req-&gt;rq_ldata
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|result
op_assign
l_int|0
suffix:semicolon
id|out
suffix:colon
r_return
id|result
suffix:semicolon
)brace
r_static
r_int
DECL|function|smb_proc_getattr_trans2_std
id|smb_proc_getattr_trans2_std
c_func
(paren
r_struct
id|smb_sb_info
op_star
id|server
comma
r_struct
id|dentry
op_star
id|dir
comma
r_struct
id|smb_fattr
op_star
id|attr
)paren
(brace
id|u16
id|date
comma
id|time
suffix:semicolon
r_int
id|off_date
op_assign
l_int|0
comma
id|off_time
op_assign
l_int|2
suffix:semicolon
r_int
id|result
suffix:semicolon
r_struct
id|smb_request
op_star
id|req
suffix:semicolon
id|result
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|req
op_assign
id|smb_alloc_request
c_func
(paren
id|server
comma
id|PAGE_SIZE
)paren
)paren
)paren
r_goto
id|out
suffix:semicolon
id|result
op_assign
id|smb_proc_getattr_trans2
c_func
(paren
id|server
comma
id|dir
comma
id|req
comma
id|SMB_INFO_STANDARD
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
r_goto
id|out_free
suffix:semicolon
multiline_comment|/*&n;&t; * Kludge alert: Win 95 swaps the date and time field,&n;&t; * contrary to the CIFS docs and Win NT practice.&n;&t; */
r_if
c_cond
(paren
id|server-&gt;mnt-&gt;flags
op_amp
id|SMB_MOUNT_WIN95
)paren
(brace
id|off_date
op_assign
l_int|2
suffix:semicolon
id|off_time
op_assign
l_int|0
suffix:semicolon
)brace
id|date
op_assign
id|WVAL
c_func
(paren
id|req-&gt;rq_data
comma
id|off_date
)paren
suffix:semicolon
id|time
op_assign
id|WVAL
c_func
(paren
id|req-&gt;rq_data
comma
id|off_time
)paren
suffix:semicolon
id|attr-&gt;f_ctime.tv_sec
op_assign
id|date_dos2unix
c_func
(paren
id|server
comma
id|date
comma
id|time
)paren
suffix:semicolon
id|attr-&gt;f_ctime.tv_nsec
op_assign
l_int|0
suffix:semicolon
id|date
op_assign
id|WVAL
c_func
(paren
id|req-&gt;rq_data
comma
l_int|4
op_plus
id|off_date
)paren
suffix:semicolon
id|time
op_assign
id|WVAL
c_func
(paren
id|req-&gt;rq_data
comma
l_int|4
op_plus
id|off_time
)paren
suffix:semicolon
id|attr-&gt;f_atime.tv_sec
op_assign
id|date_dos2unix
c_func
(paren
id|server
comma
id|date
comma
id|time
)paren
suffix:semicolon
id|attr-&gt;f_atime.tv_nsec
op_assign
l_int|0
suffix:semicolon
id|date
op_assign
id|WVAL
c_func
(paren
id|req-&gt;rq_data
comma
l_int|8
op_plus
id|off_date
)paren
suffix:semicolon
id|time
op_assign
id|WVAL
c_func
(paren
id|req-&gt;rq_data
comma
l_int|8
op_plus
id|off_time
)paren
suffix:semicolon
id|attr-&gt;f_mtime.tv_sec
op_assign
id|date_dos2unix
c_func
(paren
id|server
comma
id|date
comma
id|time
)paren
suffix:semicolon
id|attr-&gt;f_mtime.tv_nsec
op_assign
l_int|0
suffix:semicolon
macro_line|#ifdef SMBFS_DEBUG_TIMESTAMP
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;getattr_trans2: %s/%s, date=%x, time=%x, mtime=%ld&bslash;n&quot;
comma
id|DENTRY_PATH
c_func
(paren
id|dir
)paren
comma
id|date
comma
id|time
comma
id|attr-&gt;f_mtime
)paren
suffix:semicolon
macro_line|#endif
id|attr-&gt;f_size
op_assign
id|DVAL
c_func
(paren
id|req-&gt;rq_data
comma
l_int|12
)paren
suffix:semicolon
id|attr-&gt;attr
op_assign
id|WVAL
c_func
(paren
id|req-&gt;rq_data
comma
l_int|20
)paren
suffix:semicolon
id|out_free
suffix:colon
id|smb_rput
c_func
(paren
id|req
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|result
suffix:semicolon
)brace
r_static
r_int
DECL|function|smb_proc_getattr_trans2_all
id|smb_proc_getattr_trans2_all
c_func
(paren
r_struct
id|smb_sb_info
op_star
id|server
comma
r_struct
id|dentry
op_star
id|dir
comma
r_struct
id|smb_fattr
op_star
id|attr
)paren
(brace
r_struct
id|smb_request
op_star
id|req
suffix:semicolon
r_int
id|result
suffix:semicolon
id|result
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|req
op_assign
id|smb_alloc_request
c_func
(paren
id|server
comma
id|PAGE_SIZE
)paren
)paren
)paren
r_goto
id|out
suffix:semicolon
id|result
op_assign
id|smb_proc_getattr_trans2
c_func
(paren
id|server
comma
id|dir
comma
id|req
comma
id|SMB_QUERY_FILE_ALL_INFO
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
r_goto
id|out_free
suffix:semicolon
id|attr-&gt;f_ctime
op_assign
id|smb_ntutc2unixutc
c_func
(paren
id|LVAL
c_func
(paren
id|req-&gt;rq_data
comma
l_int|0
)paren
)paren
suffix:semicolon
id|attr-&gt;f_atime
op_assign
id|smb_ntutc2unixutc
c_func
(paren
id|LVAL
c_func
(paren
id|req-&gt;rq_data
comma
l_int|8
)paren
)paren
suffix:semicolon
id|attr-&gt;f_mtime
op_assign
id|smb_ntutc2unixutc
c_func
(paren
id|LVAL
c_func
(paren
id|req-&gt;rq_data
comma
l_int|16
)paren
)paren
suffix:semicolon
multiline_comment|/* change (24) */
id|attr-&gt;attr
op_assign
id|WVAL
c_func
(paren
id|req-&gt;rq_data
comma
l_int|32
)paren
suffix:semicolon
multiline_comment|/* pad? (34) */
multiline_comment|/* allocated size (40) */
id|attr-&gt;f_size
op_assign
id|LVAL
c_func
(paren
id|req-&gt;rq_data
comma
l_int|48
)paren
suffix:semicolon
id|out_free
suffix:colon
id|smb_rput
c_func
(paren
id|req
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|result
suffix:semicolon
)brace
r_static
r_int
DECL|function|smb_proc_getattr_unix
id|smb_proc_getattr_unix
c_func
(paren
r_struct
id|smb_sb_info
op_star
id|server
comma
r_struct
id|dentry
op_star
id|dir
comma
r_struct
id|smb_fattr
op_star
id|attr
)paren
(brace
r_struct
id|smb_request
op_star
id|req
suffix:semicolon
r_int
id|result
suffix:semicolon
id|result
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|req
op_assign
id|smb_alloc_request
c_func
(paren
id|server
comma
id|PAGE_SIZE
)paren
)paren
)paren
r_goto
id|out
suffix:semicolon
id|result
op_assign
id|smb_proc_getattr_trans2
c_func
(paren
id|server
comma
id|dir
comma
id|req
comma
id|SMB_QUERY_FILE_UNIX_BASIC
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
r_goto
id|out_free
suffix:semicolon
id|smb_decode_unix_basic
c_func
(paren
id|attr
comma
id|req-&gt;rq_data
)paren
suffix:semicolon
id|out_free
suffix:colon
id|smb_rput
c_func
(paren
id|req
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|result
suffix:semicolon
)brace
r_static
r_int
DECL|function|smb_proc_getattr_95
id|smb_proc_getattr_95
c_func
(paren
r_struct
id|smb_sb_info
op_star
id|server
comma
r_struct
id|dentry
op_star
id|dir
comma
r_struct
id|smb_fattr
op_star
id|attr
)paren
(brace
r_struct
id|inode
op_star
id|inode
op_assign
id|dir-&gt;d_inode
suffix:semicolon
r_int
id|result
suffix:semicolon
multiline_comment|/* FIXME: why not use the &quot;all&quot; version? */
id|result
op_assign
id|smb_proc_getattr_trans2_std
c_func
(paren
id|server
comma
id|dir
comma
id|attr
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/*&n;&t; * None of the getattr versions here can make win9x return the right&n;&t; * filesize if there are changes made to an open file.&n;&t; * A seek-to-end does return the right size, but we only need to do&n;&t; * that on files we have written.&n;&t; */
r_if
c_cond
(paren
id|inode
op_logical_and
id|SMB_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|flags
op_amp
id|SMB_F_LOCALWRITE
op_logical_and
id|smb_is_open
c_func
(paren
id|inode
)paren
)paren
(brace
id|__u16
id|fileid
op_assign
id|SMB_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|fileid
suffix:semicolon
id|attr-&gt;f_size
op_assign
id|smb_proc_seek
c_func
(paren
id|server
comma
id|fileid
comma
l_int|2
comma
l_int|0
)paren
suffix:semicolon
)brace
id|out
suffix:colon
r_return
id|result
suffix:semicolon
)brace
r_int
DECL|function|smb_proc_getattr
id|smb_proc_getattr
c_func
(paren
r_struct
id|dentry
op_star
id|dir
comma
r_struct
id|smb_fattr
op_star
id|fattr
)paren
(brace
r_struct
id|smb_sb_info
op_star
id|server
op_assign
id|server_from_dentry
c_func
(paren
id|dir
)paren
suffix:semicolon
r_int
id|result
suffix:semicolon
id|smb_init_dirent
c_func
(paren
id|server
comma
id|fattr
)paren
suffix:semicolon
id|result
op_assign
id|server-&gt;ops
op_member_access_from_pointer
id|getattr
c_func
(paren
id|server
comma
id|dir
comma
id|fattr
)paren
suffix:semicolon
id|smb_finish_dirent
c_func
(paren
id|server
comma
id|fattr
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/*&n; * Because of bugs in the core protocol, we use this only to set&n; * attributes. See smb_proc_settime() below for timestamp handling.&n; *&n; * Bugs Noted:&n; * (1) If mtime is non-zero, both Win 3.1 and Win 95 fail&n; * with an undocumented error (ERRDOS code 50). Setting&n; * mtime to 0 allows the attributes to be set.&n; * (2) The extra parameters following the name string aren&squot;t&n; * in the CIFS docs, but seem to be necessary for operation.&n; */
r_static
r_int
DECL|function|smb_proc_setattr_core
id|smb_proc_setattr_core
c_func
(paren
r_struct
id|smb_sb_info
op_star
id|server
comma
r_struct
id|dentry
op_star
id|dentry
comma
id|__u16
id|attr
)paren
(brace
r_char
op_star
id|p
suffix:semicolon
r_int
id|result
suffix:semicolon
r_struct
id|smb_request
op_star
id|req
suffix:semicolon
id|result
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|req
op_assign
id|smb_alloc_request
c_func
(paren
id|server
comma
id|PAGE_SIZE
)paren
)paren
)paren
r_goto
id|out
suffix:semicolon
id|p
op_assign
id|smb_setup_header
c_func
(paren
id|req
comma
id|SMBsetatr
comma
l_int|8
comma
l_int|0
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|req-&gt;rq_header
comma
id|smb_vwv0
comma
id|attr
)paren
suffix:semicolon
id|DSET
c_func
(paren
id|req-&gt;rq_header
comma
id|smb_vwv1
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* mtime */
id|WSET
c_func
(paren
id|req-&gt;rq_header
comma
id|smb_vwv3
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* reserved values */
id|WSET
c_func
(paren
id|req-&gt;rq_header
comma
id|smb_vwv4
comma
l_int|0
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|req-&gt;rq_header
comma
id|smb_vwv5
comma
l_int|0
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|req-&gt;rq_header
comma
id|smb_vwv6
comma
l_int|0
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|req-&gt;rq_header
comma
id|smb_vwv7
comma
l_int|0
)paren
suffix:semicolon
id|result
op_assign
id|smb_simple_encode_path
c_func
(paren
id|req
comma
op_amp
id|p
comma
id|dentry
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
r_goto
id|out_free
suffix:semicolon
r_if
c_cond
(paren
id|p
op_plus
l_int|2
OG
(paren
r_char
op_star
)paren
id|req-&gt;rq_buffer
op_plus
id|req-&gt;rq_bufsize
)paren
(brace
id|result
op_assign
op_minus
id|ENAMETOOLONG
suffix:semicolon
r_goto
id|out_free
suffix:semicolon
)brace
op_star
id|p
op_increment
op_assign
l_int|4
suffix:semicolon
op_star
id|p
op_increment
op_assign
l_int|0
suffix:semicolon
id|smb_setup_bcc
c_func
(paren
id|req
comma
id|p
)paren
suffix:semicolon
id|result
op_assign
id|smb_request_ok
c_func
(paren
id|req
comma
id|SMBsetatr
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
r_goto
id|out_free
suffix:semicolon
id|result
op_assign
l_int|0
suffix:semicolon
id|out_free
suffix:colon
id|smb_rput
c_func
(paren
id|req
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/*&n; * Because of bugs in the trans2 setattr messages, we must set&n; * attributes and timestamps separately. The core SMBsetatr&n; * message seems to be the only reliable way to set attributes.&n; */
r_int
DECL|function|smb_proc_setattr
id|smb_proc_setattr
c_func
(paren
r_struct
id|dentry
op_star
id|dir
comma
r_struct
id|smb_fattr
op_star
id|fattr
)paren
(brace
r_struct
id|smb_sb_info
op_star
id|server
op_assign
id|server_from_dentry
c_func
(paren
id|dir
)paren
suffix:semicolon
r_int
id|result
suffix:semicolon
id|VERBOSE
c_func
(paren
l_string|&quot;setting %s/%s, open=%d&bslash;n&quot;
comma
id|DENTRY_PATH
c_func
(paren
id|dir
)paren
comma
id|smb_is_open
c_func
(paren
id|dir-&gt;d_inode
)paren
)paren
suffix:semicolon
id|result
op_assign
id|smb_proc_setattr_core
c_func
(paren
id|server
comma
id|dir
comma
id|fattr-&gt;attr
)paren
suffix:semicolon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/*&n; * Sets the timestamps for an file open with write permissions.&n; */
r_static
r_int
DECL|function|smb_proc_setattr_ext
id|smb_proc_setattr_ext
c_func
(paren
r_struct
id|smb_sb_info
op_star
id|server
comma
r_struct
id|inode
op_star
id|inode
comma
r_struct
id|smb_fattr
op_star
id|fattr
)paren
(brace
id|__u16
id|date
comma
id|time
suffix:semicolon
r_int
id|result
suffix:semicolon
r_struct
id|smb_request
op_star
id|req
suffix:semicolon
id|result
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|req
op_assign
id|smb_alloc_request
c_func
(paren
id|server
comma
l_int|0
)paren
)paren
)paren
r_goto
id|out
suffix:semicolon
id|smb_setup_header
c_func
(paren
id|req
comma
id|SMBsetattrE
comma
l_int|7
comma
l_int|0
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|req-&gt;rq_header
comma
id|smb_vwv0
comma
id|SMB_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|fileid
)paren
suffix:semicolon
multiline_comment|/* We don&squot;t change the creation time */
id|WSET
c_func
(paren
id|req-&gt;rq_header
comma
id|smb_vwv1
comma
l_int|0
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|req-&gt;rq_header
comma
id|smb_vwv2
comma
l_int|0
)paren
suffix:semicolon
id|date_unix2dos
c_func
(paren
id|server
comma
id|fattr-&gt;f_atime.tv_sec
comma
op_amp
id|date
comma
op_amp
id|time
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|req-&gt;rq_header
comma
id|smb_vwv3
comma
id|date
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|req-&gt;rq_header
comma
id|smb_vwv4
comma
id|time
)paren
suffix:semicolon
id|date_unix2dos
c_func
(paren
id|server
comma
id|fattr-&gt;f_mtime.tv_sec
comma
op_amp
id|date
comma
op_amp
id|time
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|req-&gt;rq_header
comma
id|smb_vwv5
comma
id|date
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|req-&gt;rq_header
comma
id|smb_vwv6
comma
id|time
)paren
suffix:semicolon
macro_line|#ifdef SMBFS_DEBUG_TIMESTAMP
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;smb_proc_setattr_ext: date=%d, time=%d, mtime=%ld&bslash;n&quot;
comma
id|date
comma
id|time
comma
id|fattr-&gt;f_mtime
)paren
suffix:semicolon
macro_line|#endif
id|req-&gt;rq_flags
op_or_assign
id|SMB_REQ_NORETRY
suffix:semicolon
id|result
op_assign
id|smb_request_ok
c_func
(paren
id|req
comma
id|SMBsetattrE
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
r_goto
id|out_free
suffix:semicolon
id|result
op_assign
l_int|0
suffix:semicolon
id|out_free
suffix:colon
id|smb_rput
c_func
(paren
id|req
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/*&n; * Bugs Noted:&n; * (1) The TRANSACT2_SETPATHINFO message under Win NT 4.0 doesn&squot;t&n; * set the file&squot;s attribute flags.&n; */
r_static
r_int
DECL|function|smb_proc_setattr_trans2
id|smb_proc_setattr_trans2
c_func
(paren
r_struct
id|smb_sb_info
op_star
id|server
comma
r_struct
id|dentry
op_star
id|dir
comma
r_struct
id|smb_fattr
op_star
id|fattr
)paren
(brace
id|__u16
id|date
comma
id|time
suffix:semicolon
r_char
op_star
id|p
comma
op_star
id|param
suffix:semicolon
r_int
id|result
suffix:semicolon
r_char
id|data
(braket
l_int|26
)braket
suffix:semicolon
r_struct
id|smb_request
op_star
id|req
suffix:semicolon
id|result
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|req
op_assign
id|smb_alloc_request
c_func
(paren
id|server
comma
id|PAGE_SIZE
)paren
)paren
)paren
r_goto
id|out
suffix:semicolon
id|param
op_assign
id|req-&gt;rq_buffer
suffix:semicolon
id|WSET
c_func
(paren
id|param
comma
l_int|0
comma
l_int|1
)paren
suffix:semicolon
multiline_comment|/* Info level SMB_INFO_STANDARD */
id|DSET
c_func
(paren
id|param
comma
l_int|2
comma
l_int|0
)paren
suffix:semicolon
id|result
op_assign
id|smb_encode_path
c_func
(paren
id|server
comma
id|param
op_plus
l_int|6
comma
id|SMB_MAXPATHLEN
op_plus
l_int|1
comma
id|dir
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
r_goto
id|out_free
suffix:semicolon
id|p
op_assign
id|param
op_plus
l_int|6
op_plus
id|result
suffix:semicolon
id|WSET
c_func
(paren
id|data
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* creation time */
id|WSET
c_func
(paren
id|data
comma
l_int|2
comma
l_int|0
)paren
suffix:semicolon
id|date_unix2dos
c_func
(paren
id|server
comma
id|fattr-&gt;f_atime.tv_sec
comma
op_amp
id|date
comma
op_amp
id|time
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|data
comma
l_int|4
comma
id|date
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|data
comma
l_int|6
comma
id|time
)paren
suffix:semicolon
id|date_unix2dos
c_func
(paren
id|server
comma
id|fattr-&gt;f_mtime.tv_sec
comma
op_amp
id|date
comma
op_amp
id|time
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|data
comma
l_int|8
comma
id|date
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|data
comma
l_int|10
comma
id|time
)paren
suffix:semicolon
macro_line|#ifdef SMBFS_DEBUG_TIMESTAMP
id|printk
c_func
(paren
id|KERN_DEBUG
l_string|&quot;setattr_trans2: %s/%s, date=%x, time=%x, mtime=%ld&bslash;n&quot;
comma
id|DENTRY_PATH
c_func
(paren
id|dir
)paren
comma
id|date
comma
id|time
comma
id|fattr-&gt;f_mtime
)paren
suffix:semicolon
macro_line|#endif
id|DSET
c_func
(paren
id|data
comma
l_int|12
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* size */
id|DSET
c_func
(paren
id|data
comma
l_int|16
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* blksize */
id|WSET
c_func
(paren
id|data
comma
l_int|20
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* attr */
id|DSET
c_func
(paren
id|data
comma
l_int|22
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* ULONG EA size */
id|req-&gt;rq_trans2_command
op_assign
id|TRANSACT2_SETPATHINFO
suffix:semicolon
id|req-&gt;rq_ldata
op_assign
l_int|26
suffix:semicolon
id|req-&gt;rq_data
op_assign
id|data
suffix:semicolon
id|req-&gt;rq_lparm
op_assign
id|p
op_minus
id|param
suffix:semicolon
id|req-&gt;rq_parm
op_assign
id|param
suffix:semicolon
id|req-&gt;rq_flags
op_assign
l_int|0
suffix:semicolon
id|result
op_assign
id|smb_add_request
c_func
(paren
id|req
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
r_goto
id|out_free
suffix:semicolon
id|result
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|req-&gt;rq_rcls
op_ne
l_int|0
)paren
id|result
op_assign
id|smb_errno
c_func
(paren
id|req
)paren
suffix:semicolon
id|out_free
suffix:colon
id|smb_rput
c_func
(paren
id|req
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/*&n; * ATTR_MODE      0x001&n; * ATTR_UID       0x002&n; * ATTR_GID       0x004&n; * ATTR_SIZE      0x008&n; * ATTR_ATIME     0x010&n; * ATTR_MTIME     0x020&n; * ATTR_CTIME     0x040&n; * ATTR_ATIME_SET 0x080&n; * ATTR_MTIME_SET 0x100&n; * ATTR_FORCE     0x200&t;&n; * ATTR_ATTR_FLAG 0x400&n; *&n; * major/minor should only be set by mknod.&n; */
r_int
DECL|function|smb_proc_setattr_unix
id|smb_proc_setattr_unix
c_func
(paren
r_struct
id|dentry
op_star
id|d
comma
r_struct
id|iattr
op_star
id|attr
comma
r_int
id|major
comma
r_int
id|minor
)paren
(brace
r_struct
id|smb_sb_info
op_star
id|server
op_assign
id|server_from_dentry
c_func
(paren
id|d
)paren
suffix:semicolon
id|u64
id|nttime
suffix:semicolon
r_char
op_star
id|p
comma
op_star
id|param
suffix:semicolon
r_int
id|result
suffix:semicolon
r_char
id|data
(braket
l_int|100
)braket
suffix:semicolon
r_struct
id|smb_request
op_star
id|req
suffix:semicolon
id|result
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|req
op_assign
id|smb_alloc_request
c_func
(paren
id|server
comma
id|PAGE_SIZE
)paren
)paren
)paren
r_goto
id|out
suffix:semicolon
id|param
op_assign
id|req-&gt;rq_buffer
suffix:semicolon
id|DEBUG1
c_func
(paren
l_string|&quot;valid flags = 0x%04x&bslash;n&quot;
comma
id|attr-&gt;ia_valid
)paren
suffix:semicolon
id|WSET
c_func
(paren
id|param
comma
l_int|0
comma
id|SMB_SET_FILE_UNIX_BASIC
)paren
suffix:semicolon
id|DSET
c_func
(paren
id|param
comma
l_int|2
comma
l_int|0
)paren
suffix:semicolon
id|result
op_assign
id|smb_encode_path
c_func
(paren
id|server
comma
id|param
op_plus
l_int|6
comma
id|SMB_MAXPATHLEN
op_plus
l_int|1
comma
id|d
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
r_goto
id|out_free
suffix:semicolon
id|p
op_assign
id|param
op_plus
l_int|6
op_plus
id|result
suffix:semicolon
multiline_comment|/* 0 L file size in bytes */
multiline_comment|/* 8 L file size on disk in bytes (block count) */
multiline_comment|/* 40 L uid */
multiline_comment|/* 48 L gid */
multiline_comment|/* 56 W file type enum */
multiline_comment|/* 60 L devmajor */
multiline_comment|/* 68 L devminor */
multiline_comment|/* 76 L unique ID (inode) */
multiline_comment|/* 84 L permissions */
multiline_comment|/* 92 L link count */
id|LSET
c_func
(paren
id|data
comma
l_int|0
comma
id|SMB_SIZE_NO_CHANGE
)paren
suffix:semicolon
id|LSET
c_func
(paren
id|data
comma
l_int|8
comma
id|SMB_SIZE_NO_CHANGE
)paren
suffix:semicolon
id|LSET
c_func
(paren
id|data
comma
l_int|16
comma
id|SMB_TIME_NO_CHANGE
)paren
suffix:semicolon
id|LSET
c_func
(paren
id|data
comma
l_int|24
comma
id|SMB_TIME_NO_CHANGE
)paren
suffix:semicolon
id|LSET
c_func
(paren
id|data
comma
l_int|32
comma
id|SMB_TIME_NO_CHANGE
)paren
suffix:semicolon
id|LSET
c_func
(paren
id|data
comma
l_int|40
comma
id|SMB_UID_NO_CHANGE
)paren
suffix:semicolon
id|LSET
c_func
(paren
id|data
comma
l_int|48
comma
id|SMB_GID_NO_CHANGE
)paren
suffix:semicolon
id|LSET
c_func
(paren
id|data
comma
l_int|56
comma
id|smb_filetype_from_mode
c_func
(paren
id|attr-&gt;ia_mode
)paren
)paren
suffix:semicolon
id|LSET
c_func
(paren
id|data
comma
l_int|60
comma
id|major
)paren
suffix:semicolon
id|LSET
c_func
(paren
id|data
comma
l_int|68
comma
id|minor
)paren
suffix:semicolon
id|LSET
c_func
(paren
id|data
comma
l_int|76
comma
l_int|0
)paren
suffix:semicolon
id|LSET
c_func
(paren
id|data
comma
l_int|84
comma
id|SMB_MODE_NO_CHANGE
)paren
suffix:semicolon
id|LSET
c_func
(paren
id|data
comma
l_int|92
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|attr-&gt;ia_valid
op_amp
id|ATTR_SIZE
)paren
(brace
id|LSET
c_func
(paren
id|data
comma
l_int|0
comma
id|attr-&gt;ia_size
)paren
suffix:semicolon
id|LSET
c_func
(paren
id|data
comma
l_int|8
comma
l_int|0
)paren
suffix:semicolon
multiline_comment|/* can&squot;t set anyway */
)brace
multiline_comment|/*&n;&t; * FIXME: check the conversion function it the correct one&n;&t; *&n;&t; * we can&squot;t set ctime but we might as well pass this to the server&n;&t; * and let it ignore it.&n;&t; */
r_if
c_cond
(paren
id|attr-&gt;ia_valid
op_amp
id|ATTR_CTIME
)paren
(brace
id|nttime
op_assign
id|smb_unixutc2ntutc
c_func
(paren
id|attr-&gt;ia_ctime
)paren
suffix:semicolon
id|LSET
c_func
(paren
id|data
comma
l_int|16
comma
id|nttime
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|attr-&gt;ia_valid
op_amp
id|ATTR_ATIME
)paren
(brace
id|nttime
op_assign
id|smb_unixutc2ntutc
c_func
(paren
id|attr-&gt;ia_atime
)paren
suffix:semicolon
id|LSET
c_func
(paren
id|data
comma
l_int|24
comma
id|nttime
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|attr-&gt;ia_valid
op_amp
id|ATTR_MTIME
)paren
(brace
id|nttime
op_assign
id|smb_unixutc2ntutc
c_func
(paren
id|attr-&gt;ia_mtime
)paren
suffix:semicolon
id|LSET
c_func
(paren
id|data
comma
l_int|32
comma
id|nttime
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|attr-&gt;ia_valid
op_amp
id|ATTR_UID
)paren
(brace
id|LSET
c_func
(paren
id|data
comma
l_int|40
comma
id|attr-&gt;ia_uid
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|attr-&gt;ia_valid
op_amp
id|ATTR_GID
)paren
(brace
id|LSET
c_func
(paren
id|data
comma
l_int|48
comma
id|attr-&gt;ia_gid
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|attr-&gt;ia_valid
op_amp
id|ATTR_MODE
)paren
(brace
id|LSET
c_func
(paren
id|data
comma
l_int|84
comma
id|attr-&gt;ia_mode
)paren
suffix:semicolon
)brace
id|req-&gt;rq_trans2_command
op_assign
id|TRANSACT2_SETPATHINFO
suffix:semicolon
id|req-&gt;rq_ldata
op_assign
l_int|100
suffix:semicolon
id|req-&gt;rq_data
op_assign
id|data
suffix:semicolon
id|req-&gt;rq_lparm
op_assign
id|p
op_minus
id|param
suffix:semicolon
id|req-&gt;rq_parm
op_assign
id|param
suffix:semicolon
id|req-&gt;rq_flags
op_assign
l_int|0
suffix:semicolon
id|result
op_assign
id|smb_add_request
c_func
(paren
id|req
)paren
suffix:semicolon
id|out_free
suffix:colon
id|smb_rput
c_func
(paren
id|req
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/*&n; * Set the modify and access timestamps for a file.&n; *&n; * Incredibly enough, in all of SMB there is no message to allow&n; * setting both attributes and timestamps at once. &n; *&n; * Bugs Noted:&n; * (1) Win 95 doesn&squot;t support the TRANSACT2_SETFILEINFO message &n; * with info level 1 (INFO_STANDARD).&n; * (2) Win 95 seems not to support setting directory timestamps.&n; * (3) Under the core protocol apparently the only way to set the&n; * timestamp is to open and close the file.&n; */
r_int
DECL|function|smb_proc_settime
id|smb_proc_settime
c_func
(paren
r_struct
id|dentry
op_star
id|dentry
comma
r_struct
id|smb_fattr
op_star
id|fattr
)paren
(brace
r_struct
id|smb_sb_info
op_star
id|server
op_assign
id|server_from_dentry
c_func
(paren
id|dentry
)paren
suffix:semicolon
r_struct
id|inode
op_star
id|inode
op_assign
id|dentry-&gt;d_inode
suffix:semicolon
r_int
id|result
suffix:semicolon
id|VERBOSE
c_func
(paren
l_string|&quot;setting %s/%s, open=%d&bslash;n&quot;
comma
id|DENTRY_PATH
c_func
(paren
id|dentry
)paren
comma
id|smb_is_open
c_func
(paren
id|inode
)paren
)paren
suffix:semicolon
multiline_comment|/* setting the time on a Win95 server fails (tridge) */
r_if
c_cond
(paren
id|server-&gt;opt.protocol
op_ge
id|SMB_PROTOCOL_LANMAN2
op_logical_and
op_logical_neg
(paren
id|server-&gt;mnt-&gt;flags
op_amp
id|SMB_MOUNT_WIN95
)paren
)paren
(brace
r_if
c_cond
(paren
id|smb_is_open
c_func
(paren
id|inode
)paren
op_logical_and
id|SMB_I
c_func
(paren
id|inode
)paren
op_member_access_from_pointer
id|access
op_ne
id|SMB_O_RDONLY
)paren
id|result
op_assign
id|smb_proc_setattr_ext
c_func
(paren
id|server
comma
id|inode
comma
id|fattr
)paren
suffix:semicolon
r_else
id|result
op_assign
id|smb_proc_setattr_trans2
c_func
(paren
id|server
comma
id|dentry
comma
id|fattr
)paren
suffix:semicolon
)brace
r_else
(brace
multiline_comment|/*&n;&t;&t; * Fail silently on directories ... timestamp can&squot;t be set?&n;&t;&t; */
id|result
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|S_ISREG
c_func
(paren
id|inode-&gt;i_mode
)paren
)paren
(brace
multiline_comment|/*&n;&t;&t;&t; * Set the mtime by opening and closing the file.&n;&t;&t;&t; * Note that the file is opened read-only, but this&n;&t;&t;&t; * still allows us to set the date (tridge)&n;&t;&t;&t; */
id|result
op_assign
op_minus
id|EACCES
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|smb_is_open
c_func
(paren
id|inode
)paren
)paren
id|smb_proc_open
c_func
(paren
id|server
comma
id|dentry
comma
id|SMB_O_RDONLY
)paren
suffix:semicolon
r_if
c_cond
(paren
id|smb_is_open
c_func
(paren
id|inode
)paren
)paren
(brace
id|inode-&gt;i_mtime
op_assign
id|fattr-&gt;f_mtime
suffix:semicolon
id|result
op_assign
id|smb_proc_close_inode
c_func
(paren
id|server
comma
id|inode
)paren
suffix:semicolon
)brace
)brace
)brace
r_return
id|result
suffix:semicolon
)brace
r_int
DECL|function|smb_proc_dskattr
id|smb_proc_dskattr
c_func
(paren
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|statfs
op_star
id|attr
)paren
(brace
r_struct
id|smb_sb_info
op_star
id|server
op_assign
id|SMB_SB
c_func
(paren
id|sb
)paren
suffix:semicolon
r_int
id|result
suffix:semicolon
r_char
op_star
id|p
suffix:semicolon
r_int
id|unit
suffix:semicolon
r_struct
id|smb_request
op_star
id|req
suffix:semicolon
id|result
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|req
op_assign
id|smb_alloc_request
c_func
(paren
id|server
comma
l_int|0
)paren
)paren
)paren
r_goto
id|out
suffix:semicolon
id|smb_setup_header
c_func
(paren
id|req
comma
id|SMBdskattr
comma
l_int|0
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|result
op_assign
id|smb_request_ok
c_func
(paren
id|req
comma
id|SMBdskattr
comma
l_int|5
comma
l_int|0
)paren
)paren
OL
l_int|0
)paren
r_goto
id|out_free
suffix:semicolon
id|p
op_assign
id|SMB_VWV
c_func
(paren
id|req-&gt;rq_header
)paren
suffix:semicolon
id|unit
op_assign
(paren
id|WVAL
c_func
(paren
id|p
comma
l_int|2
)paren
op_star
id|WVAL
c_func
(paren
id|p
comma
l_int|4
)paren
)paren
op_rshift
id|SMB_ST_BLKSHIFT
suffix:semicolon
id|attr-&gt;f_blocks
op_assign
id|WVAL
c_func
(paren
id|p
comma
l_int|0
)paren
op_star
id|unit
suffix:semicolon
id|attr-&gt;f_bsize
op_assign
id|SMB_ST_BLKSIZE
suffix:semicolon
id|attr-&gt;f_bavail
op_assign
id|attr-&gt;f_bfree
op_assign
id|WVAL
c_func
(paren
id|p
comma
l_int|6
)paren
op_star
id|unit
suffix:semicolon
id|result
op_assign
l_int|0
suffix:semicolon
id|out_free
suffix:colon
id|smb_rput
c_func
(paren
id|req
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|result
suffix:semicolon
)brace
r_int
DECL|function|smb_proc_read_link
id|smb_proc_read_link
c_func
(paren
r_struct
id|smb_sb_info
op_star
id|server
comma
r_struct
id|dentry
op_star
id|d
comma
r_char
op_star
id|buffer
comma
r_int
id|len
)paren
(brace
r_char
op_star
id|p
comma
op_star
id|param
suffix:semicolon
r_int
id|result
suffix:semicolon
r_struct
id|smb_request
op_star
id|req
suffix:semicolon
id|DEBUG1
c_func
(paren
l_string|&quot;readlink of %s/%s&bslash;n&quot;
comma
id|DENTRY_PATH
c_func
(paren
id|d
)paren
)paren
suffix:semicolon
id|result
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|req
op_assign
id|smb_alloc_request
c_func
(paren
id|server
comma
id|PAGE_SIZE
)paren
)paren
)paren
r_goto
id|out
suffix:semicolon
id|param
op_assign
id|req-&gt;rq_buffer
suffix:semicolon
id|WSET
c_func
(paren
id|param
comma
l_int|0
comma
id|SMB_QUERY_FILE_UNIX_LINK
)paren
suffix:semicolon
id|DSET
c_func
(paren
id|param
comma
l_int|2
comma
l_int|0
)paren
suffix:semicolon
id|result
op_assign
id|smb_encode_path
c_func
(paren
id|server
comma
id|param
op_plus
l_int|6
comma
id|SMB_MAXPATHLEN
op_plus
l_int|1
comma
id|d
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
r_goto
id|out_free
suffix:semicolon
id|p
op_assign
id|param
op_plus
l_int|6
op_plus
id|result
suffix:semicolon
id|req-&gt;rq_trans2_command
op_assign
id|TRANSACT2_QPATHINFO
suffix:semicolon
id|req-&gt;rq_ldata
op_assign
l_int|0
suffix:semicolon
id|req-&gt;rq_data
op_assign
l_int|NULL
suffix:semicolon
id|req-&gt;rq_lparm
op_assign
id|p
op_minus
id|param
suffix:semicolon
id|req-&gt;rq_parm
op_assign
id|param
suffix:semicolon
id|req-&gt;rq_flags
op_assign
l_int|0
suffix:semicolon
id|result
op_assign
id|smb_add_request
c_func
(paren
id|req
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
r_goto
id|out_free
suffix:semicolon
id|DEBUG1
c_func
(paren
l_string|&quot;for %s: result=%d, rcls=%d, err=%d&bslash;n&quot;
comma
op_amp
id|param
(braket
l_int|6
)braket
comma
id|result
comma
id|server-&gt;rcls
comma
id|server-&gt;err
)paren
suffix:semicolon
multiline_comment|/* copy data up to the &bslash;0 or buffer length */
id|result
op_assign
id|len
suffix:semicolon
r_if
c_cond
(paren
id|req-&gt;rq_ldata
OL
id|len
)paren
id|result
op_assign
id|req-&gt;rq_ldata
suffix:semicolon
id|strncpy
c_func
(paren
id|buffer
comma
id|req-&gt;rq_data
comma
id|result
)paren
suffix:semicolon
id|out_free
suffix:colon
id|smb_rput
c_func
(paren
id|req
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/*&n; * Create a symlink object called dentry which points to oldpath.&n; * Samba does not permit dangling links but returns a suitable error message.&n; */
r_int
DECL|function|smb_proc_symlink
id|smb_proc_symlink
c_func
(paren
r_struct
id|smb_sb_info
op_star
id|server
comma
r_struct
id|dentry
op_star
id|d
comma
r_const
r_char
op_star
id|oldpath
)paren
(brace
r_char
op_star
id|p
comma
op_star
id|param
suffix:semicolon
r_int
id|result
suffix:semicolon
r_struct
id|smb_request
op_star
id|req
suffix:semicolon
id|result
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|req
op_assign
id|smb_alloc_request
c_func
(paren
id|server
comma
id|PAGE_SIZE
)paren
)paren
)paren
r_goto
id|out
suffix:semicolon
id|param
op_assign
id|req-&gt;rq_buffer
suffix:semicolon
id|WSET
c_func
(paren
id|param
comma
l_int|0
comma
id|SMB_SET_FILE_UNIX_LINK
)paren
suffix:semicolon
id|DSET
c_func
(paren
id|param
comma
l_int|2
comma
l_int|0
)paren
suffix:semicolon
id|result
op_assign
id|smb_encode_path
c_func
(paren
id|server
comma
id|param
op_plus
l_int|6
comma
id|SMB_MAXPATHLEN
op_plus
l_int|1
comma
id|d
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
r_goto
id|out_free
suffix:semicolon
id|p
op_assign
id|param
op_plus
l_int|6
op_plus
id|result
suffix:semicolon
id|req-&gt;rq_trans2_command
op_assign
id|TRANSACT2_SETPATHINFO
suffix:semicolon
id|req-&gt;rq_ldata
op_assign
id|strlen
c_func
(paren
id|oldpath
)paren
op_plus
l_int|1
suffix:semicolon
id|req-&gt;rq_data
op_assign
(paren
r_char
op_star
)paren
id|oldpath
suffix:semicolon
id|req-&gt;rq_lparm
op_assign
id|p
op_minus
id|param
suffix:semicolon
id|req-&gt;rq_parm
op_assign
id|param
suffix:semicolon
id|req-&gt;rq_flags
op_assign
l_int|0
suffix:semicolon
id|result
op_assign
id|smb_add_request
c_func
(paren
id|req
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
r_goto
id|out_free
suffix:semicolon
id|DEBUG1
c_func
(paren
l_string|&quot;for %s: result=%d, rcls=%d, err=%d&bslash;n&quot;
comma
op_amp
id|param
(braket
l_int|6
)braket
comma
id|result
comma
id|server-&gt;rcls
comma
id|server-&gt;err
)paren
suffix:semicolon
id|result
op_assign
l_int|0
suffix:semicolon
id|out_free
suffix:colon
id|smb_rput
c_func
(paren
id|req
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|result
suffix:semicolon
)brace
multiline_comment|/*&n; * Create a hard link object called new_dentry which points to dentry.&n; */
r_int
DECL|function|smb_proc_link
id|smb_proc_link
c_func
(paren
r_struct
id|smb_sb_info
op_star
id|server
comma
r_struct
id|dentry
op_star
id|dentry
comma
r_struct
id|dentry
op_star
id|new_dentry
)paren
(brace
r_char
op_star
id|p
comma
op_star
id|param
suffix:semicolon
r_int
id|result
suffix:semicolon
r_struct
id|smb_request
op_star
id|req
suffix:semicolon
id|result
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|req
op_assign
id|smb_alloc_request
c_func
(paren
id|server
comma
id|PAGE_SIZE
)paren
)paren
)paren
r_goto
id|out
suffix:semicolon
id|param
op_assign
id|req-&gt;rq_buffer
suffix:semicolon
id|WSET
c_func
(paren
id|param
comma
l_int|0
comma
id|SMB_SET_FILE_UNIX_HLINK
)paren
suffix:semicolon
id|DSET
c_func
(paren
id|param
comma
l_int|2
comma
l_int|0
)paren
suffix:semicolon
id|result
op_assign
id|smb_encode_path
c_func
(paren
id|server
comma
id|param
op_plus
l_int|6
comma
id|SMB_MAXPATHLEN
op_plus
l_int|1
comma
id|new_dentry
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
r_goto
id|out_free
suffix:semicolon
id|p
op_assign
id|param
op_plus
l_int|6
op_plus
id|result
suffix:semicolon
multiline_comment|/* Grr, pointless separation of parameters and data ... */
id|req-&gt;rq_data
op_assign
id|p
suffix:semicolon
id|req-&gt;rq_ldata
op_assign
id|smb_encode_path
c_func
(paren
id|server
comma
id|p
comma
id|SMB_MAXPATHLEN
op_plus
l_int|1
comma
id|dentry
comma
l_int|NULL
)paren
suffix:semicolon
id|req-&gt;rq_trans2_command
op_assign
id|TRANSACT2_SETPATHINFO
suffix:semicolon
id|req-&gt;rq_lparm
op_assign
id|p
op_minus
id|param
suffix:semicolon
id|req-&gt;rq_parm
op_assign
id|param
suffix:semicolon
id|req-&gt;rq_flags
op_assign
l_int|0
suffix:semicolon
id|result
op_assign
id|smb_add_request
c_func
(paren
id|req
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
r_goto
id|out_free
suffix:semicolon
id|DEBUG1
c_func
(paren
l_string|&quot;for %s: result=%d, rcls=%d, err=%d&bslash;n&quot;
comma
op_amp
id|param
(braket
l_int|6
)braket
comma
id|result
comma
id|server-&gt;rcls
comma
id|server-&gt;err
)paren
suffix:semicolon
id|result
op_assign
l_int|0
suffix:semicolon
id|out_free
suffix:colon
id|smb_rput
c_func
(paren
id|req
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|result
suffix:semicolon
)brace
r_int
DECL|function|smb_proc_query_cifsunix
id|smb_proc_query_cifsunix
c_func
(paren
r_struct
id|smb_sb_info
op_star
id|server
)paren
(brace
r_int
id|result
suffix:semicolon
r_int
id|major
comma
id|minor
suffix:semicolon
id|u64
id|caps
suffix:semicolon
r_char
id|param
(braket
l_int|2
)braket
suffix:semicolon
r_struct
id|smb_request
op_star
id|req
suffix:semicolon
id|result
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|req
op_assign
id|smb_alloc_request
c_func
(paren
id|server
comma
l_int|100
)paren
)paren
)paren
r_goto
id|out
suffix:semicolon
id|WSET
c_func
(paren
id|param
comma
l_int|0
comma
id|SMB_QUERY_CIFS_UNIX_INFO
)paren
suffix:semicolon
id|req-&gt;rq_trans2_command
op_assign
id|TRANSACT2_QFSINFO
suffix:semicolon
id|req-&gt;rq_ldata
op_assign
l_int|0
suffix:semicolon
id|req-&gt;rq_data
op_assign
l_int|NULL
suffix:semicolon
id|req-&gt;rq_lparm
op_assign
l_int|2
suffix:semicolon
id|req-&gt;rq_parm
op_assign
id|param
suffix:semicolon
id|req-&gt;rq_flags
op_assign
l_int|0
suffix:semicolon
id|result
op_assign
id|smb_add_request
c_func
(paren
id|req
)paren
suffix:semicolon
r_if
c_cond
(paren
id|result
OL
l_int|0
)paren
r_goto
id|out_free
suffix:semicolon
r_if
c_cond
(paren
id|req-&gt;rq_ldata
OL
l_int|12
)paren
(brace
id|PARANOIA
c_func
(paren
l_string|&quot;Not enough data&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out_free
suffix:semicolon
)brace
id|major
op_assign
id|WVAL
c_func
(paren
id|req-&gt;rq_data
comma
l_int|0
)paren
suffix:semicolon
id|minor
op_assign
id|WVAL
c_func
(paren
id|req-&gt;rq_data
comma
l_int|2
)paren
suffix:semicolon
id|DEBUG1
c_func
(paren
l_string|&quot;Server implements CIFS Extensions for UNIX systems v%d.%d&bslash;n&quot;
comma
id|major
comma
id|minor
)paren
suffix:semicolon
multiline_comment|/* FIXME: verify that we are ok with this major/minor? */
id|caps
op_assign
id|LVAL
c_func
(paren
id|req-&gt;rq_data
comma
l_int|4
)paren
suffix:semicolon
id|DEBUG1
c_func
(paren
l_string|&quot;Server capabilities 0x%016llx&bslash;n&quot;
comma
id|caps
)paren
suffix:semicolon
id|out_free
suffix:colon
id|smb_rput
c_func
(paren
id|req
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|result
suffix:semicolon
)brace
r_static
r_void
DECL|function|install_ops
id|install_ops
c_func
(paren
r_struct
id|smb_ops
op_star
id|dst
comma
r_struct
id|smb_ops
op_star
id|src
)paren
(brace
id|memcpy
c_func
(paren
id|dst
comma
id|src
comma
r_sizeof
(paren
r_void
op_star
)paren
op_star
id|SMB_OPS_NUM_STATIC
)paren
suffix:semicolon
)brace
multiline_comment|/* &lt; LANMAN2 */
DECL|variable|smb_ops_core
r_static
r_struct
id|smb_ops
id|smb_ops_core
op_assign
(brace
dot
id|read
op_assign
id|smb_proc_read
comma
dot
id|write
op_assign
id|smb_proc_write
comma
dot
id|readdir
op_assign
id|smb_proc_readdir_short
comma
dot
id|getattr
op_assign
id|smb_proc_getattr_core
comma
dot
id|truncate
op_assign
id|smb_proc_trunc32
comma
)brace
suffix:semicolon
multiline_comment|/* LANMAN2, OS/2, others? */
DECL|variable|smb_ops_os2
r_static
r_struct
id|smb_ops
id|smb_ops_os2
op_assign
(brace
dot
id|read
op_assign
id|smb_proc_read
comma
dot
id|write
op_assign
id|smb_proc_write
comma
dot
id|readdir
op_assign
id|smb_proc_readdir_long
comma
dot
id|getattr
op_assign
id|smb_proc_getattr_trans2_std
comma
dot
id|truncate
op_assign
id|smb_proc_trunc32
comma
)brace
suffix:semicolon
multiline_comment|/* Win95, and possibly some NetApp versions too */
DECL|variable|smb_ops_win95
r_static
r_struct
id|smb_ops
id|smb_ops_win95
op_assign
(brace
dot
id|read
op_assign
id|smb_proc_read
comma
multiline_comment|/* does not support 12word readX */
dot
id|write
op_assign
id|smb_proc_write
comma
dot
id|readdir
op_assign
id|smb_proc_readdir_long
comma
dot
id|getattr
op_assign
id|smb_proc_getattr_95
comma
dot
id|truncate
op_assign
id|smb_proc_trunc95
comma
)brace
suffix:semicolon
multiline_comment|/* Samba, NT4 and NT5 */
DECL|variable|smb_ops_winNT
r_static
r_struct
id|smb_ops
id|smb_ops_winNT
op_assign
(brace
dot
id|read
op_assign
id|smb_proc_readX
comma
dot
id|write
op_assign
id|smb_proc_writeX
comma
dot
id|readdir
op_assign
id|smb_proc_readdir_long
comma
dot
id|getattr
op_assign
id|smb_proc_getattr_trans2_all
comma
dot
id|truncate
op_assign
id|smb_proc_trunc64
comma
)brace
suffix:semicolon
multiline_comment|/* Samba w/ unix extensions. Others? */
DECL|variable|smb_ops_unix
r_static
r_struct
id|smb_ops
id|smb_ops_unix
op_assign
(brace
dot
id|read
op_assign
id|smb_proc_readX
comma
dot
id|write
op_assign
id|smb_proc_writeX
comma
dot
id|readdir
op_assign
id|smb_proc_readdir_long
comma
dot
id|getattr
op_assign
id|smb_proc_getattr_unix
comma
multiline_comment|/* FIXME: core/ext/time setattr needs to be cleaned up! */
multiline_comment|/* .setattr&t;= smb_proc_setattr_unix, */
dot
id|truncate
op_assign
id|smb_proc_trunc64
comma
)brace
suffix:semicolon
eof
