multiline_comment|/*&n; * truncate.c&n; *&n; * PURPOSE&n; *&t;Truncate handling routines for the OSTA-UDF(tm) filesystem.&n; *&n; * CONTACTS&n; *&t;E-mail regarding any portion of the Linux UDF file system should be&n; *&t;directed to the development team mailing list (run by majordomo):&n; *&t;&t;linux_udf@hpesjro.fc.hp.com&n; *&n; * COPYRIGHT&n; *&t;This file is distributed under the terms of the GNU General Public&n; *&t;License (GPL). Copies of the GPL can be obtained from:&n; *&t;&t;ftp://prep.ai.mit.edu/pub/gnu/GPL&n; *&t;Each contributing author retains all rights to their own work.&n; *&n; *  (C) 1999-2004 Ben Fennema&n; *  (C) 1999 Stelias Computing Inc&n; *&n; * HISTORY&n; *&n; *  02/24/99 blf  Created.&n; *&n; */
macro_line|#include &quot;udfdecl.h&quot;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/udf_fs.h&gt;
macro_line|#include &lt;linux/buffer_head.h&gt;
macro_line|#include &quot;udf_i.h&quot;
macro_line|#include &quot;udf_sb.h&quot;
DECL|function|extent_trunc
r_static
r_void
id|extent_trunc
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
id|lb_addr
id|bloc
comma
r_int
id|extoffset
comma
id|lb_addr
id|eloc
comma
r_int8
id|etype
comma
r_uint32
id|elen
comma
r_struct
id|buffer_head
op_star
id|bh
comma
r_uint32
id|nelen
)paren
(brace
id|lb_addr
id|neloc
op_assign
(brace
l_int|0
comma
l_int|0
)brace
suffix:semicolon
r_int
id|last_block
op_assign
(paren
id|elen
op_plus
id|inode-&gt;i_sb-&gt;s_blocksize
op_minus
l_int|1
)paren
op_rshift
id|inode-&gt;i_sb-&gt;s_blocksize_bits
suffix:semicolon
r_int
id|first_block
op_assign
(paren
id|nelen
op_plus
id|inode-&gt;i_sb-&gt;s_blocksize
op_minus
l_int|1
)paren
op_rshift
id|inode-&gt;i_sb-&gt;s_blocksize_bits
suffix:semicolon
r_if
c_cond
(paren
id|nelen
)paren
(brace
r_if
c_cond
(paren
id|etype
op_eq
(paren
id|EXT_NOT_RECORDED_ALLOCATED
op_rshift
l_int|30
)paren
)paren
(brace
id|udf_free_blocks
c_func
(paren
id|inode-&gt;i_sb
comma
id|inode
comma
id|eloc
comma
l_int|0
comma
id|last_block
)paren
suffix:semicolon
id|etype
op_assign
(paren
id|EXT_NOT_RECORDED_NOT_ALLOCATED
op_rshift
l_int|30
)paren
suffix:semicolon
)brace
r_else
id|neloc
op_assign
id|eloc
suffix:semicolon
id|nelen
op_assign
(paren
id|etype
op_lshift
l_int|30
)paren
op_or
id|nelen
suffix:semicolon
)brace
r_if
c_cond
(paren
id|elen
op_ne
id|nelen
)paren
(brace
id|udf_write_aext
c_func
(paren
id|inode
comma
id|bloc
comma
op_amp
id|extoffset
comma
id|neloc
comma
id|nelen
comma
id|bh
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|last_block
op_minus
id|first_block
OG
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|etype
op_eq
(paren
id|EXT_RECORDED_ALLOCATED
op_rshift
l_int|30
)paren
)paren
id|mark_inode_dirty
c_func
(paren
id|inode
)paren
suffix:semicolon
r_if
c_cond
(paren
id|etype
op_ne
(paren
id|EXT_NOT_RECORDED_NOT_ALLOCATED
op_rshift
l_int|30
)paren
)paren
id|udf_free_blocks
c_func
(paren
id|inode-&gt;i_sb
comma
id|inode
comma
id|eloc
comma
id|first_block
comma
id|last_block
op_minus
id|first_block
)paren
suffix:semicolon
)brace
)brace
)brace
DECL|function|udf_discard_prealloc
r_void
id|udf_discard_prealloc
c_func
(paren
r_struct
id|inode
op_star
id|inode
)paren
(brace
id|lb_addr
id|bloc
comma
id|eloc
suffix:semicolon
r_uint32
id|extoffset
op_assign
l_int|0
comma
id|elen
comma
id|nelen
suffix:semicolon
r_uint64
id|lbcount
op_assign
l_int|0
suffix:semicolon
r_int8
id|etype
op_assign
op_minus
l_int|1
comma
id|netype
suffix:semicolon
r_struct
id|buffer_head
op_star
id|bh
op_assign
l_int|NULL
suffix:semicolon
r_int
id|adsize
suffix:semicolon
r_if
c_cond
(paren
id|UDF_I_ALLOCTYPE
c_func
(paren
id|inode
)paren
op_eq
id|ICBTAG_FLAG_AD_IN_ICB
op_logical_or
id|inode-&gt;i_size
op_eq
id|UDF_I_LENEXTENTS
c_func
(paren
id|inode
)paren
)paren
(brace
r_return
suffix:semicolon
)brace
r_if
c_cond
(paren
id|UDF_I_ALLOCTYPE
c_func
(paren
id|inode
)paren
op_eq
id|ICBTAG_FLAG_AD_SHORT
)paren
id|adsize
op_assign
r_sizeof
(paren
id|short_ad
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|UDF_I_ALLOCTYPE
c_func
(paren
id|inode
)paren
op_eq
id|ICBTAG_FLAG_AD_LONG
)paren
id|adsize
op_assign
r_sizeof
(paren
id|long_ad
)paren
suffix:semicolon
r_else
id|adsize
op_assign
l_int|0
suffix:semicolon
id|bloc
op_assign
id|UDF_I_LOCATION
c_func
(paren
id|inode
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|netype
op_assign
id|udf_next_aext
c_func
(paren
id|inode
comma
op_amp
id|bloc
comma
op_amp
id|extoffset
comma
op_amp
id|eloc
comma
op_amp
id|elen
comma
op_amp
id|bh
comma
l_int|1
)paren
)paren
op_ne
op_minus
l_int|1
)paren
(brace
id|etype
op_assign
id|netype
suffix:semicolon
id|lbcount
op_add_assign
id|elen
suffix:semicolon
r_if
c_cond
(paren
id|lbcount
OG
id|inode-&gt;i_size
op_logical_and
id|lbcount
op_minus
id|inode-&gt;i_size
OL
id|inode-&gt;i_sb-&gt;s_blocksize
)paren
(brace
id|nelen
op_assign
id|elen
op_minus
(paren
id|lbcount
op_minus
id|inode-&gt;i_size
)paren
suffix:semicolon
id|extent_trunc
c_func
(paren
id|inode
comma
id|bloc
comma
id|extoffset
op_minus
id|adsize
comma
id|eloc
comma
id|etype
comma
id|elen
comma
id|bh
comma
id|nelen
)paren
suffix:semicolon
id|lbcount
op_assign
id|inode-&gt;i_size
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|etype
op_eq
(paren
id|EXT_NOT_RECORDED_ALLOCATED
op_rshift
l_int|30
)paren
)paren
(brace
id|extoffset
op_sub_assign
id|adsize
suffix:semicolon
id|lbcount
op_sub_assign
id|elen
suffix:semicolon
id|extent_trunc
c_func
(paren
id|inode
comma
id|bloc
comma
id|extoffset
comma
id|eloc
comma
id|etype
comma
id|elen
comma
id|bh
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bh
)paren
(brace
id|UDF_I_LENALLOC
c_func
(paren
id|inode
)paren
op_assign
id|extoffset
op_minus
id|udf_file_entry_alloc_offset
c_func
(paren
id|inode
)paren
suffix:semicolon
id|mark_inode_dirty
c_func
(paren
id|inode
)paren
suffix:semicolon
)brace
r_else
(brace
r_struct
id|allocExtDesc
op_star
id|aed
op_assign
(paren
r_struct
id|allocExtDesc
op_star
)paren
(paren
id|bh-&gt;b_data
)paren
suffix:semicolon
id|aed-&gt;lengthAllocDescs
op_assign
id|cpu_to_le32
c_func
(paren
id|extoffset
op_minus
r_sizeof
(paren
r_struct
id|allocExtDesc
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|UDF_QUERY_FLAG
c_func
(paren
id|inode-&gt;i_sb
comma
id|UDF_FLAG_STRICT
)paren
op_logical_or
id|UDF_SB_UDFREV
c_func
(paren
id|inode-&gt;i_sb
)paren
op_ge
l_int|0x0201
)paren
id|udf_update_tag
c_func
(paren
id|bh-&gt;b_data
comma
id|extoffset
)paren
suffix:semicolon
r_else
id|udf_update_tag
c_func
(paren
id|bh-&gt;b_data
comma
r_sizeof
(paren
r_struct
id|allocExtDesc
)paren
)paren
suffix:semicolon
id|mark_buffer_dirty_inode
c_func
(paren
id|bh
comma
id|inode
)paren
suffix:semicolon
)brace
)brace
id|UDF_I_LENEXTENTS
c_func
(paren
id|inode
)paren
op_assign
id|lbcount
suffix:semicolon
id|udf_release_data
c_func
(paren
id|bh
)paren
suffix:semicolon
)brace
DECL|function|udf_truncate_extents
r_void
id|udf_truncate_extents
c_func
(paren
r_struct
id|inode
op_star
id|inode
)paren
(brace
id|lb_addr
id|bloc
comma
id|eloc
comma
id|neloc
op_assign
(brace
l_int|0
comma
l_int|0
)brace
suffix:semicolon
r_uint32
id|extoffset
comma
id|elen
comma
id|offset
comma
id|nelen
op_assign
l_int|0
comma
id|lelen
op_assign
l_int|0
comma
id|lenalloc
suffix:semicolon
r_int8
id|etype
suffix:semicolon
r_int
id|first_block
op_assign
id|inode-&gt;i_size
op_rshift
id|inode-&gt;i_sb-&gt;s_blocksize_bits
suffix:semicolon
r_struct
id|buffer_head
op_star
id|bh
op_assign
l_int|NULL
suffix:semicolon
r_int
id|adsize
suffix:semicolon
r_if
c_cond
(paren
id|UDF_I_ALLOCTYPE
c_func
(paren
id|inode
)paren
op_eq
id|ICBTAG_FLAG_AD_SHORT
)paren
id|adsize
op_assign
r_sizeof
(paren
id|short_ad
)paren
suffix:semicolon
r_else
r_if
c_cond
(paren
id|UDF_I_ALLOCTYPE
c_func
(paren
id|inode
)paren
op_eq
id|ICBTAG_FLAG_AD_LONG
)paren
id|adsize
op_assign
r_sizeof
(paren
id|long_ad
)paren
suffix:semicolon
r_else
id|adsize
op_assign
l_int|0
suffix:semicolon
id|etype
op_assign
id|inode_bmap
c_func
(paren
id|inode
comma
id|first_block
comma
op_amp
id|bloc
comma
op_amp
id|extoffset
comma
op_amp
id|eloc
comma
op_amp
id|elen
comma
op_amp
id|offset
comma
op_amp
id|bh
)paren
suffix:semicolon
id|offset
op_add_assign
(paren
id|inode-&gt;i_size
op_amp
(paren
id|inode-&gt;i_sb-&gt;s_blocksize
op_minus
l_int|1
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|etype
op_ne
op_minus
l_int|1
)paren
(brace
id|extoffset
op_sub_assign
id|adsize
suffix:semicolon
id|extent_trunc
c_func
(paren
id|inode
comma
id|bloc
comma
id|extoffset
comma
id|eloc
comma
id|etype
comma
id|elen
comma
id|bh
comma
id|offset
)paren
suffix:semicolon
id|extoffset
op_add_assign
id|adsize
suffix:semicolon
r_if
c_cond
(paren
id|offset
)paren
id|lenalloc
op_assign
id|extoffset
suffix:semicolon
r_else
id|lenalloc
op_assign
id|extoffset
op_minus
id|adsize
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|bh
)paren
id|lenalloc
op_sub_assign
id|udf_file_entry_alloc_offset
c_func
(paren
id|inode
)paren
suffix:semicolon
r_else
id|lenalloc
op_sub_assign
r_sizeof
(paren
r_struct
id|allocExtDesc
)paren
suffix:semicolon
r_while
c_loop
(paren
(paren
id|etype
op_assign
id|udf_current_aext
c_func
(paren
id|inode
comma
op_amp
id|bloc
comma
op_amp
id|extoffset
comma
op_amp
id|eloc
comma
op_amp
id|elen
comma
op_amp
id|bh
comma
l_int|0
)paren
)paren
op_ne
op_minus
l_int|1
)paren
(brace
r_if
c_cond
(paren
id|etype
op_eq
(paren
id|EXT_NEXT_EXTENT_ALLOCDECS
op_rshift
l_int|30
)paren
)paren
(brace
id|udf_write_aext
c_func
(paren
id|inode
comma
id|bloc
comma
op_amp
id|extoffset
comma
id|neloc
comma
id|nelen
comma
id|bh
comma
l_int|0
)paren
suffix:semicolon
id|extoffset
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|lelen
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|bh
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
r_else
id|memset
c_func
(paren
id|bh-&gt;b_data
comma
l_int|0x00
comma
r_sizeof
(paren
r_struct
id|allocExtDesc
)paren
)paren
suffix:semicolon
id|udf_free_blocks
c_func
(paren
id|inode-&gt;i_sb
comma
id|inode
comma
id|bloc
comma
l_int|0
comma
id|lelen
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
op_logical_neg
id|bh
)paren
(brace
id|UDF_I_LENALLOC
c_func
(paren
id|inode
)paren
op_assign
id|lenalloc
suffix:semicolon
id|mark_inode_dirty
c_func
(paren
id|inode
)paren
suffix:semicolon
)brace
r_else
(brace
r_struct
id|allocExtDesc
op_star
id|aed
op_assign
(paren
r_struct
id|allocExtDesc
op_star
)paren
(paren
id|bh-&gt;b_data
)paren
suffix:semicolon
id|aed-&gt;lengthAllocDescs
op_assign
id|cpu_to_le32
c_func
(paren
id|lenalloc
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|UDF_QUERY_FLAG
c_func
(paren
id|inode-&gt;i_sb
comma
id|UDF_FLAG_STRICT
)paren
op_logical_or
id|UDF_SB_UDFREV
c_func
(paren
id|inode-&gt;i_sb
)paren
op_ge
l_int|0x0201
)paren
id|udf_update_tag
c_func
(paren
id|bh-&gt;b_data
comma
id|lenalloc
op_plus
r_sizeof
(paren
r_struct
id|allocExtDesc
)paren
)paren
suffix:semicolon
r_else
id|udf_update_tag
c_func
(paren
id|bh-&gt;b_data
comma
r_sizeof
(paren
r_struct
id|allocExtDesc
)paren
)paren
suffix:semicolon
id|mark_buffer_dirty_inode
c_func
(paren
id|bh
comma
id|inode
)paren
suffix:semicolon
)brace
)brace
id|udf_release_data
c_func
(paren
id|bh
)paren
suffix:semicolon
id|extoffset
op_assign
r_sizeof
(paren
r_struct
id|allocExtDesc
)paren
suffix:semicolon
id|bloc
op_assign
id|eloc
suffix:semicolon
id|bh
op_assign
id|udf_tread
c_func
(paren
id|inode-&gt;i_sb
comma
id|udf_get_lb_pblock
c_func
(paren
id|inode-&gt;i_sb
comma
id|bloc
comma
l_int|0
)paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|elen
)paren
id|lelen
op_assign
(paren
id|elen
op_plus
id|inode-&gt;i_sb-&gt;s_blocksize
op_minus
l_int|1
)paren
op_rshift
id|inode-&gt;i_sb-&gt;s_blocksize_bits
suffix:semicolon
r_else
id|lelen
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
id|extent_trunc
c_func
(paren
id|inode
comma
id|bloc
comma
id|extoffset
comma
id|eloc
comma
id|etype
comma
id|elen
comma
id|bh
comma
l_int|0
)paren
suffix:semicolon
id|extoffset
op_add_assign
id|adsize
suffix:semicolon
)brace
)brace
r_if
c_cond
(paren
id|lelen
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|bh
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
r_else
id|memset
c_func
(paren
id|bh-&gt;b_data
comma
l_int|0x00
comma
r_sizeof
(paren
r_struct
id|allocExtDesc
)paren
)paren
suffix:semicolon
id|udf_free_blocks
c_func
(paren
id|inode-&gt;i_sb
comma
id|inode
comma
id|bloc
comma
l_int|0
comma
id|lelen
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
op_logical_neg
id|bh
)paren
(brace
id|UDF_I_LENALLOC
c_func
(paren
id|inode
)paren
op_assign
id|lenalloc
suffix:semicolon
id|mark_inode_dirty
c_func
(paren
id|inode
)paren
suffix:semicolon
)brace
r_else
(brace
r_struct
id|allocExtDesc
op_star
id|aed
op_assign
(paren
r_struct
id|allocExtDesc
op_star
)paren
(paren
id|bh-&gt;b_data
)paren
suffix:semicolon
id|aed-&gt;lengthAllocDescs
op_assign
id|cpu_to_le32
c_func
(paren
id|lenalloc
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|UDF_QUERY_FLAG
c_func
(paren
id|inode-&gt;i_sb
comma
id|UDF_FLAG_STRICT
)paren
op_logical_or
id|UDF_SB_UDFREV
c_func
(paren
id|inode-&gt;i_sb
)paren
op_ge
l_int|0x0201
)paren
id|udf_update_tag
c_func
(paren
id|bh-&gt;b_data
comma
id|lenalloc
op_plus
r_sizeof
(paren
r_struct
id|allocExtDesc
)paren
)paren
suffix:semicolon
r_else
id|udf_update_tag
c_func
(paren
id|bh-&gt;b_data
comma
r_sizeof
(paren
r_struct
id|allocExtDesc
)paren
)paren
suffix:semicolon
id|mark_buffer_dirty_inode
c_func
(paren
id|bh
comma
id|inode
)paren
suffix:semicolon
)brace
)brace
)brace
r_else
r_if
c_cond
(paren
id|inode-&gt;i_size
)paren
(brace
r_if
c_cond
(paren
id|offset
)paren
(brace
id|extoffset
op_sub_assign
id|adsize
suffix:semicolon
id|etype
op_assign
id|udf_next_aext
c_func
(paren
id|inode
comma
op_amp
id|bloc
comma
op_amp
id|extoffset
comma
op_amp
id|eloc
comma
op_amp
id|elen
comma
op_amp
id|bh
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|etype
op_eq
(paren
id|EXT_NOT_RECORDED_NOT_ALLOCATED
op_rshift
l_int|30
)paren
)paren
(brace
id|extoffset
op_sub_assign
id|adsize
suffix:semicolon
id|elen
op_assign
id|EXT_NOT_RECORDED_NOT_ALLOCATED
op_or
(paren
id|elen
op_plus
id|offset
)paren
suffix:semicolon
id|udf_write_aext
c_func
(paren
id|inode
comma
id|bloc
comma
op_amp
id|extoffset
comma
id|eloc
comma
id|elen
comma
id|bh
comma
l_int|0
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|etype
op_eq
(paren
id|EXT_NOT_RECORDED_ALLOCATED
op_rshift
l_int|30
)paren
)paren
(brace
id|lb_addr
id|neloc
op_assign
(brace
l_int|0
comma
l_int|0
)brace
suffix:semicolon
id|extoffset
op_sub_assign
id|adsize
suffix:semicolon
id|nelen
op_assign
id|EXT_NOT_RECORDED_NOT_ALLOCATED
op_or
(paren
(paren
id|elen
op_plus
id|offset
op_plus
id|inode-&gt;i_sb-&gt;s_blocksize
op_minus
l_int|1
)paren
op_amp
op_complement
(paren
id|inode-&gt;i_sb-&gt;s_blocksize
op_minus
l_int|1
)paren
)paren
suffix:semicolon
id|udf_write_aext
c_func
(paren
id|inode
comma
id|bloc
comma
op_amp
id|extoffset
comma
id|neloc
comma
id|nelen
comma
id|bh
comma
l_int|1
)paren
suffix:semicolon
id|udf_add_aext
c_func
(paren
id|inode
comma
op_amp
id|bloc
comma
op_amp
id|extoffset
comma
id|eloc
comma
(paren
id|etype
op_lshift
l_int|30
)paren
op_or
id|elen
comma
op_amp
id|bh
comma
l_int|1
)paren
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
id|elen
op_amp
(paren
id|inode-&gt;i_sb-&gt;s_blocksize
op_minus
l_int|1
)paren
)paren
(brace
id|extoffset
op_sub_assign
id|adsize
suffix:semicolon
id|elen
op_assign
id|EXT_RECORDED_ALLOCATED
op_or
(paren
(paren
id|elen
op_plus
id|inode-&gt;i_sb-&gt;s_blocksize
op_minus
l_int|1
)paren
op_amp
op_complement
(paren
id|inode-&gt;i_sb-&gt;s_blocksize
op_minus
l_int|1
)paren
)paren
suffix:semicolon
id|udf_write_aext
c_func
(paren
id|inode
comma
id|bloc
comma
op_amp
id|extoffset
comma
id|eloc
comma
id|elen
comma
id|bh
comma
l_int|1
)paren
suffix:semicolon
)brace
id|memset
c_func
(paren
op_amp
id|eloc
comma
l_int|0x00
comma
r_sizeof
(paren
id|lb_addr
)paren
)paren
suffix:semicolon
id|elen
op_assign
id|EXT_NOT_RECORDED_NOT_ALLOCATED
op_or
id|offset
suffix:semicolon
id|udf_add_aext
c_func
(paren
id|inode
comma
op_amp
id|bloc
comma
op_amp
id|extoffset
comma
id|eloc
comma
id|elen
comma
op_amp
id|bh
comma
l_int|1
)paren
suffix:semicolon
)brace
)brace
)brace
id|UDF_I_LENEXTENTS
c_func
(paren
id|inode
)paren
op_assign
id|inode-&gt;i_size
suffix:semicolon
id|udf_release_data
c_func
(paren
id|bh
)paren
suffix:semicolon
)brace
eof
