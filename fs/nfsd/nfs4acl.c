multiline_comment|/*&n; *  fs/nfs4acl/acl.c&n; *&n; *  Common NFSv4 ACL handling code.&n; *&n; *  Copyright (c) 2002, 2003 The Regents of the University of Michigan.&n; *  All rights reserved.&n; *&n; *  Marius Aamodt Eriksen &lt;marius@umich.edu&gt;&n; *  Jeff Sedlak &lt;jsedlak@umich.edu&gt;&n; *  J. Bruce Fields &lt;bfields@umich.edu&gt;&n; *&n; *  Redistribution and use in source and binary forms, with or without&n; *  modification, are permitted provided that the following conditions&n; *  are met:&n; *&n; *  1. Redistributions of source code must retain the above copyright&n; *     notice, this list of conditions and the following disclaimer.&n; *  2. Redistributions in binary form must reproduce the above copyright&n; *     notice, this list of conditions and the following disclaimer in the&n; *     documentation and/or other materials provided with the distribution.&n; *  3. Neither the name of the University nor the names of its&n; *     contributors may be used to endorse or promote products derived&n; *     from this software without specific prior written permission.&n; *&n; *  THIS SOFTWARE IS PROVIDED ``AS IS&squot;&squot; AND ANY EXPRESS OR IMPLIED&n; *  WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF&n; *  MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE&n; *  DISCLAIMED. IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE&n; *  FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR&n; *  CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF&n; *  SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR&n; *  BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF&n; *  LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING&n; *  NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS&n; *  SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.&n; */
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/list.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/nfs_fs.h&gt;
macro_line|#include &lt;linux/nfs4.h&gt;
macro_line|#include &lt;linux/nfs4_acl.h&gt;
r_struct
id|nfs4_acl
op_star
DECL|function|nfs4_acl_new
id|nfs4_acl_new
c_func
(paren
r_void
)paren
(brace
r_struct
id|nfs4_acl
op_star
id|acl
suffix:semicolon
r_if
c_cond
(paren
(paren
id|acl
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|acl
)paren
comma
id|GFP_KERNEL
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
l_int|NULL
suffix:semicolon
id|acl-&gt;naces
op_assign
l_int|0
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|acl-&gt;ace_head
)paren
suffix:semicolon
r_return
id|acl
suffix:semicolon
)brace
r_void
DECL|function|nfs4_acl_free
id|nfs4_acl_free
c_func
(paren
r_struct
id|nfs4_acl
op_star
id|acl
)paren
(brace
r_struct
id|list_head
op_star
id|h
suffix:semicolon
r_struct
id|nfs4_ace
op_star
id|ace
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|acl
)paren
r_return
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|acl-&gt;ace_head
)paren
)paren
(brace
id|h
op_assign
id|acl-&gt;ace_head.next
suffix:semicolon
id|list_del
c_func
(paren
id|h
)paren
suffix:semicolon
id|ace
op_assign
id|list_entry
c_func
(paren
id|h
comma
r_struct
id|nfs4_ace
comma
id|l_ace
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|ace
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|acl
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_int
DECL|function|nfs4_acl_add_ace
id|nfs4_acl_add_ace
c_func
(paren
r_struct
id|nfs4_acl
op_star
id|acl
comma
id|u32
id|type
comma
id|u32
id|flag
comma
id|u32
id|access_mask
comma
r_int
id|whotype
comma
id|uid_t
id|who
)paren
(brace
r_struct
id|nfs4_ace
op_star
id|ace
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ace
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|ace
)paren
comma
id|GFP_KERNEL
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|ace-&gt;type
op_assign
id|type
suffix:semicolon
id|ace-&gt;flag
op_assign
id|flag
suffix:semicolon
id|ace-&gt;access_mask
op_assign
id|access_mask
suffix:semicolon
id|ace-&gt;whotype
op_assign
id|whotype
suffix:semicolon
id|ace-&gt;who
op_assign
id|who
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|ace-&gt;l_ace
comma
op_amp
id|acl-&gt;ace_head
)paren
suffix:semicolon
id|acl-&gt;naces
op_increment
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_struct
(brace
DECL|member|string
r_char
op_star
id|string
suffix:semicolon
DECL|member|stringlen
r_int
id|stringlen
suffix:semicolon
DECL|member|type
r_int
id|type
suffix:semicolon
DECL|variable|s2t_map
)brace
id|s2t_map
(braket
)braket
op_assign
(brace
(brace
dot
id|string
op_assign
l_string|&quot;OWNER@&quot;
comma
dot
id|stringlen
op_assign
r_sizeof
(paren
l_string|&quot;OWNER@&quot;
)paren
op_minus
l_int|1
comma
dot
id|type
op_assign
id|NFS4_ACL_WHO_OWNER
comma
)brace
comma
(brace
dot
id|string
op_assign
l_string|&quot;GROUP@&quot;
comma
dot
id|stringlen
op_assign
r_sizeof
(paren
l_string|&quot;GROUP@&quot;
)paren
op_minus
l_int|1
comma
dot
id|type
op_assign
id|NFS4_ACL_WHO_GROUP
comma
)brace
comma
(brace
dot
id|string
op_assign
l_string|&quot;EVERYONE@&quot;
comma
dot
id|stringlen
op_assign
r_sizeof
(paren
l_string|&quot;EVERYONE@&quot;
)paren
op_minus
l_int|1
comma
dot
id|type
op_assign
id|NFS4_ACL_WHO_EVERYONE
comma
)brace
comma
)brace
suffix:semicolon
r_int
DECL|function|nfs4_acl_get_whotype
id|nfs4_acl_get_whotype
c_func
(paren
r_char
op_star
id|p
comma
id|u32
id|len
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
(paren
id|s2t_map
)paren
op_div
r_sizeof
(paren
op_star
id|s2t_map
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|s2t_map
(braket
id|i
)braket
dot
id|stringlen
op_eq
id|len
op_logical_and
l_int|0
op_eq
id|memcmp
c_func
(paren
id|s2t_map
(braket
id|i
)braket
dot
id|string
comma
id|p
comma
id|len
)paren
)paren
r_return
id|s2t_map
(braket
id|i
)braket
dot
id|type
suffix:semicolon
)brace
r_return
id|NFS4_ACL_WHO_NAMED
suffix:semicolon
)brace
r_int
DECL|function|nfs4_acl_write_who
id|nfs4_acl_write_who
c_func
(paren
r_int
id|who
comma
r_char
op_star
id|p
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
(paren
id|s2t_map
)paren
op_div
r_sizeof
(paren
op_star
id|s2t_map
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|s2t_map
(braket
id|i
)braket
dot
id|type
op_eq
id|who
)paren
(brace
id|memcpy
c_func
(paren
id|p
comma
id|s2t_map
(braket
id|i
)braket
dot
id|string
comma
id|s2t_map
(braket
id|i
)braket
dot
id|stringlen
)paren
suffix:semicolon
r_return
id|s2t_map
(braket
id|i
)braket
dot
id|stringlen
suffix:semicolon
)brace
)brace
id|BUG
c_func
(paren
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|match_who
id|match_who
c_func
(paren
r_struct
id|nfs4_ace
op_star
id|ace
comma
id|uid_t
id|owner
comma
id|gid_t
id|group
comma
id|uid_t
id|who
)paren
(brace
r_switch
c_cond
(paren
id|ace-&gt;whotype
)paren
(brace
r_case
id|NFS4_ACL_WHO_NAMED
suffix:colon
r_return
id|who
op_eq
id|ace-&gt;who
suffix:semicolon
r_case
id|NFS4_ACL_WHO_OWNER
suffix:colon
r_return
id|who
op_eq
id|owner
suffix:semicolon
r_case
id|NFS4_ACL_WHO_GROUP
suffix:colon
r_return
id|who
op_eq
id|group
suffix:semicolon
r_case
id|NFS4_ACL_WHO_EVERYONE
suffix:colon
r_return
l_int|1
suffix:semicolon
r_default
suffix:colon
r_return
l_int|0
suffix:semicolon
)brace
)brace
multiline_comment|/* 0 = granted, -EACCES = denied; mask is an nfsv4 mask, not mode bits */
r_int
DECL|function|nfs4_acl_permission
id|nfs4_acl_permission
c_func
(paren
r_struct
id|nfs4_acl
op_star
id|acl
comma
id|uid_t
id|owner
comma
id|gid_t
id|group
comma
id|uid_t
id|who
comma
id|u32
id|mask
)paren
(brace
r_struct
id|nfs4_ace
op_star
id|ace
suffix:semicolon
id|u32
id|allowed
op_assign
l_int|0
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|ace
comma
op_amp
id|acl-&gt;ace_head
comma
id|l_ace
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|match_who
c_func
(paren
id|ace
comma
id|group
comma
id|owner
comma
id|who
)paren
)paren
r_continue
suffix:semicolon
r_switch
c_cond
(paren
id|ace-&gt;type
)paren
(brace
r_case
id|NFS4_ACE_ACCESS_ALLOWED_ACE_TYPE
suffix:colon
id|allowed
op_or_assign
id|ace-&gt;access_mask
suffix:semicolon
r_if
c_cond
(paren
(paren
id|allowed
op_amp
id|mask
)paren
op_eq
id|mask
)paren
r_return
l_int|0
suffix:semicolon
r_break
suffix:semicolon
r_case
id|NFS4_ACE_ACCESS_DENIED_ACE_TYPE
suffix:colon
r_if
c_cond
(paren
id|ace-&gt;access_mask
op_amp
id|mask
)paren
r_return
op_minus
id|EACCES
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
r_return
op_minus
id|EACCES
suffix:semicolon
)brace
DECL|variable|nfs4_acl_new
id|EXPORT_SYMBOL
c_func
(paren
id|nfs4_acl_new
)paren
suffix:semicolon
DECL|variable|nfs4_acl_free
id|EXPORT_SYMBOL
c_func
(paren
id|nfs4_acl_free
)paren
suffix:semicolon
DECL|variable|nfs4_acl_add_ace
id|EXPORT_SYMBOL
c_func
(paren
id|nfs4_acl_add_ace
)paren
suffix:semicolon
DECL|variable|nfs4_acl_get_whotype
id|EXPORT_SYMBOL
c_func
(paren
id|nfs4_acl_get_whotype
)paren
suffix:semicolon
DECL|variable|nfs4_acl_write_who
id|EXPORT_SYMBOL
c_func
(paren
id|nfs4_acl_write_who
)paren
suffix:semicolon
DECL|variable|nfs4_acl_permission
id|EXPORT_SYMBOL
c_func
(paren
id|nfs4_acl_permission
)paren
suffix:semicolon
eof
