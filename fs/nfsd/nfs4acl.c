multiline_comment|/*&n; *  fs/nfs4acl/acl.c&n; *&n; *  Common NFSv4 ACL handling code.&n; *&n; *  Copyright (c) 2002, 2003 The Regents of the University of Michigan.&n; *  All rights reserved.&n; *&n; *  Marius Aamodt Eriksen &lt;marius@umich.edu&gt;&n; *  Jeff Sedlak &lt;jsedlak@umich.edu&gt;&n; *  J. Bruce Fields &lt;bfields@umich.edu&gt;&n; *&n; *  Redistribution and use in source and binary forms, with or without&n; *  modification, are permitted provided that the following conditions&n; *  are met:&n; *&n; *  1. Redistributions of source code must retain the above copyright&n; *     notice, this list of conditions and the following disclaimer.&n; *  2. Redistributions in binary form must reproduce the above copyright&n; *     notice, this list of conditions and the following disclaimer in the&n; *     documentation and/or other materials provided with the distribution.&n; *  3. Neither the name of the University nor the names of its&n; *     contributors may be used to endorse or promote products derived&n; *     from this software without specific prior written permission.&n; *&n; *  THIS SOFTWARE IS PROVIDED ``AS IS&squot;&squot; AND ANY EXPRESS OR IMPLIED&n; *  WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF&n; *  MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE&n; *  DISCLAIMED. IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE&n; *  FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR&n; *  CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF&n; *  SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR&n; *  BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF&n; *  LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING&n; *  NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS&n; *  SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.&n; */
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/list.h&gt;
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/fs.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/nfs_fs.h&gt;
macro_line|#include &lt;linux/posix_acl.h&gt;
macro_line|#include &lt;linux/nfs4.h&gt;
macro_line|#include &lt;linux/nfs4_acl.h&gt;
multiline_comment|/* mode bit translations: */
DECL|macro|NFS4_READ_MODE
mdefine_line|#define NFS4_READ_MODE (NFS4_ACE_READ_DATA | NFS4_ACE_READ_NAMED_ATTRS)
DECL|macro|NFS4_WRITE_MODE
mdefine_line|#define NFS4_WRITE_MODE (NFS4_ACE_WRITE_DATA | NFS4_ACE_WRITE_NAMED_ATTRS | NFS4_ACE_APPEND_DATA)
DECL|macro|NFS4_EXECUTE_MODE
mdefine_line|#define NFS4_EXECUTE_MODE NFS4_ACE_EXECUTE
DECL|macro|NFS4_ANYONE_MODE
mdefine_line|#define NFS4_ANYONE_MODE (NFS4_ACE_READ_ATTRIBUTES | NFS4_ACE_READ_ACL | NFS4_ACE_SYNCHRONIZE)
DECL|macro|NFS4_OWNER_MODE
mdefine_line|#define NFS4_OWNER_MODE (NFS4_ACE_WRITE_ATTRIBUTES | NFS4_ACE_WRITE_ACL)
multiline_comment|/* We don&squot;t support these bits; insist they be neither allowed nor denied */
DECL|macro|NFS4_MASK_UNSUPP
mdefine_line|#define NFS4_MASK_UNSUPP (NFS4_ACE_DELETE | NFS4_ACE_WRITE_OWNER)
multiline_comment|/* flags used to simulate posix default ACLs */
DECL|macro|NFS4_INHERITANCE_FLAGS
mdefine_line|#define NFS4_INHERITANCE_FLAGS (NFS4_ACE_FILE_INHERIT_ACE &bslash;&n;&t;&t;| NFS4_ACE_DIRECTORY_INHERIT_ACE | NFS4_ACE_INHERIT_ONLY_ACE)
DECL|macro|MASK_EQUAL
mdefine_line|#define MASK_EQUAL(mask1, mask2) &bslash;&n;&t;( ((mask1) &amp; NFS4_ACE_MASK_ALL) == ((mask2) &amp; NFS4_ACE_MASK_ALL) )
r_static
id|u32
DECL|function|mask_from_posix
id|mask_from_posix
c_func
(paren
r_int
r_int
id|perm
comma
r_int
r_int
id|flags
)paren
(brace
r_int
id|mask
op_assign
id|NFS4_ANYONE_MODE
suffix:semicolon
r_if
c_cond
(paren
id|flags
op_amp
id|NFS4_ACL_OWNER
)paren
id|mask
op_or_assign
id|NFS4_OWNER_MODE
suffix:semicolon
r_if
c_cond
(paren
id|perm
op_amp
id|ACL_READ
)paren
id|mask
op_or_assign
id|NFS4_READ_MODE
suffix:semicolon
r_if
c_cond
(paren
id|perm
op_amp
id|ACL_WRITE
)paren
id|mask
op_or_assign
id|NFS4_WRITE_MODE
suffix:semicolon
r_if
c_cond
(paren
(paren
id|perm
op_amp
id|ACL_WRITE
)paren
op_logical_and
(paren
id|flags
op_amp
id|NFS4_ACL_DIR
)paren
)paren
id|mask
op_or_assign
id|NFS4_ACE_DELETE_CHILD
suffix:semicolon
r_if
c_cond
(paren
id|perm
op_amp
id|ACL_EXECUTE
)paren
id|mask
op_or_assign
id|NFS4_EXECUTE_MODE
suffix:semicolon
r_return
id|mask
suffix:semicolon
)brace
r_static
id|u32
DECL|function|deny_mask
id|deny_mask
c_func
(paren
id|u32
id|allow_mask
comma
r_int
r_int
id|flags
)paren
(brace
id|u32
id|ret
op_assign
op_complement
id|allow_mask
op_amp
op_complement
id|NFS4_MASK_UNSUPP
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|flags
op_amp
id|NFS4_ACL_DIR
)paren
)paren
id|ret
op_and_assign
op_complement
id|NFS4_ACE_DELETE_CHILD
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
r_static
r_int
DECL|function|mode_from_nfs4
id|mode_from_nfs4
c_func
(paren
id|u32
id|perm
comma
r_int
r_int
op_star
id|mode
comma
r_int
r_int
id|flags
)paren
(brace
id|u32
id|ignore
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|flags
op_amp
id|NFS4_ACL_DIR
)paren
)paren
id|ignore
op_or_assign
id|NFS4_ACE_DELETE_CHILD
suffix:semicolon
multiline_comment|/* ignore it */
id|perm
op_or_assign
id|ignore
suffix:semicolon
op_star
id|mode
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
(paren
id|perm
op_amp
id|NFS4_READ_MODE
)paren
op_eq
id|NFS4_READ_MODE
)paren
op_star
id|mode
op_or_assign
id|ACL_READ
suffix:semicolon
r_if
c_cond
(paren
(paren
id|perm
op_amp
id|NFS4_WRITE_MODE
)paren
op_eq
id|NFS4_WRITE_MODE
)paren
op_star
id|mode
op_or_assign
id|ACL_WRITE
suffix:semicolon
r_if
c_cond
(paren
(paren
id|perm
op_amp
id|NFS4_EXECUTE_MODE
)paren
op_eq
id|NFS4_EXECUTE_MODE
)paren
op_star
id|mode
op_or_assign
id|ACL_EXECUTE
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|MASK_EQUAL
c_func
(paren
id|perm
comma
id|ignore
op_or
id|mask_from_posix
c_func
(paren
op_star
id|mode
comma
id|flags
)paren
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|struct|ace_container
r_struct
id|ace_container
(brace
DECL|member|ace
r_struct
id|nfs4_ace
op_star
id|ace
suffix:semicolon
DECL|member|ace_l
r_struct
id|list_head
id|ace_l
suffix:semicolon
)brace
suffix:semicolon
r_static
r_int
id|ace2type
c_func
(paren
r_struct
id|nfs4_ace
op_star
)paren
suffix:semicolon
r_static
r_int
id|_posix_to_nfsv4_one
c_func
(paren
r_struct
id|posix_acl
op_star
comma
r_struct
id|nfs4_acl
op_star
comma
r_int
r_int
)paren
suffix:semicolon
r_static
r_struct
id|posix_acl
op_star
id|_nfsv4_to_posix_one
c_func
(paren
r_struct
id|nfs4_acl
op_star
comma
r_int
r_int
)paren
suffix:semicolon
r_int
id|nfs4_acl_add_ace
c_func
(paren
r_struct
id|nfs4_acl
op_star
comma
id|u32
comma
id|u32
comma
id|u32
comma
r_int
comma
id|uid_t
)paren
suffix:semicolon
r_int
id|nfs4_acl_split
c_func
(paren
r_struct
id|nfs4_acl
op_star
comma
r_struct
id|nfs4_acl
op_star
)paren
suffix:semicolon
r_struct
id|nfs4_acl
op_star
DECL|function|nfs4_acl_posix_to_nfsv4
id|nfs4_acl_posix_to_nfsv4
c_func
(paren
r_struct
id|posix_acl
op_star
id|pacl
comma
r_struct
id|posix_acl
op_star
id|dpacl
comma
r_int
r_int
id|flags
)paren
(brace
r_struct
id|nfs4_acl
op_star
id|acl
suffix:semicolon
r_int
id|error
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
(paren
id|pacl
op_ne
l_int|NULL
op_logical_and
(paren
id|posix_acl_valid
c_func
(paren
id|pacl
)paren
OL
l_int|0
op_logical_or
id|pacl-&gt;a_count
op_eq
l_int|0
)paren
)paren
op_logical_or
(paren
id|dpacl
op_ne
l_int|NULL
op_logical_and
(paren
id|posix_acl_valid
c_func
(paren
id|dpacl
)paren
OL
l_int|0
op_logical_or
id|dpacl-&gt;a_count
op_eq
l_int|0
)paren
)paren
)paren
r_goto
id|out_err
suffix:semicolon
id|acl
op_assign
id|nfs4_acl_new
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|acl
op_eq
l_int|NULL
)paren
(brace
id|error
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_goto
id|out_err
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pacl
op_ne
l_int|NULL
)paren
(brace
id|error
op_assign
id|_posix_to_nfsv4_one
c_func
(paren
id|pacl
comma
id|acl
comma
id|flags
op_amp
op_complement
id|NFS4_ACL_TYPE_DEFAULT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
OL
l_int|0
)paren
r_goto
id|out_acl
suffix:semicolon
)brace
r_if
c_cond
(paren
id|dpacl
op_ne
l_int|NULL
)paren
(brace
id|error
op_assign
id|_posix_to_nfsv4_one
c_func
(paren
id|dpacl
comma
id|acl
comma
id|flags
op_or
id|NFS4_ACL_TYPE_DEFAULT
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
OL
l_int|0
)paren
r_goto
id|out_acl
suffix:semicolon
)brace
r_return
id|acl
suffix:semicolon
id|out_acl
suffix:colon
id|nfs4_acl_free
c_func
(paren
id|acl
)paren
suffix:semicolon
id|out_err
suffix:colon
id|acl
op_assign
id|ERR_PTR
c_func
(paren
id|error
)paren
suffix:semicolon
r_return
id|acl
suffix:semicolon
)brace
r_static
r_int
DECL|function|nfs4_acl_add_pair
id|nfs4_acl_add_pair
c_func
(paren
r_struct
id|nfs4_acl
op_star
id|acl
comma
r_int
id|eflag
comma
id|u32
id|mask
comma
r_int
id|whotype
comma
id|uid_t
id|owner
comma
r_int
r_int
id|flags
)paren
(brace
r_int
id|error
suffix:semicolon
id|error
op_assign
id|nfs4_acl_add_ace
c_func
(paren
id|acl
comma
id|NFS4_ACE_ACCESS_ALLOWED_ACE_TYPE
comma
id|eflag
comma
id|mask
comma
id|whotype
comma
id|owner
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
OL
l_int|0
)paren
r_return
id|error
suffix:semicolon
id|error
op_assign
id|nfs4_acl_add_ace
c_func
(paren
id|acl
comma
id|NFS4_ACE_ACCESS_DENIED_ACE_TYPE
comma
id|eflag
comma
id|deny_mask
c_func
(paren
id|mask
comma
id|flags
)paren
comma
id|whotype
comma
id|owner
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
multiline_comment|/* We assume the acl has been verified with posix_acl_valid. */
r_static
r_int
DECL|function|_posix_to_nfsv4_one
id|_posix_to_nfsv4_one
c_func
(paren
r_struct
id|posix_acl
op_star
id|pacl
comma
r_struct
id|nfs4_acl
op_star
id|acl
comma
r_int
r_int
id|flags
)paren
(brace
r_struct
id|posix_acl_entry
op_star
id|pa
comma
op_star
id|pe
comma
op_star
id|group_owner_entry
suffix:semicolon
r_int
id|error
op_assign
op_minus
id|EINVAL
suffix:semicolon
id|u32
id|mask
comma
id|mask_mask
suffix:semicolon
r_int
id|eflag
op_assign
(paren
(paren
id|flags
op_amp
id|NFS4_ACL_TYPE_DEFAULT
)paren
ques
c_cond
id|NFS4_INHERITANCE_FLAGS
suffix:colon
l_int|0
)paren
suffix:semicolon
id|BUG_ON
c_func
(paren
id|pacl-&gt;a_count
OL
l_int|3
)paren
suffix:semicolon
id|pe
op_assign
id|pacl-&gt;a_entries
op_plus
id|pacl-&gt;a_count
suffix:semicolon
id|pa
op_assign
id|pe
op_minus
l_int|2
suffix:semicolon
multiline_comment|/* if mask entry exists, it&squot;s second from the last. */
r_if
c_cond
(paren
id|pa-&gt;e_tag
op_eq
id|ACL_MASK
)paren
id|mask_mask
op_assign
id|deny_mask
c_func
(paren
id|mask_from_posix
c_func
(paren
id|pa-&gt;e_perm
comma
id|flags
)paren
comma
id|flags
)paren
suffix:semicolon
r_else
id|mask_mask
op_assign
l_int|0
suffix:semicolon
id|pa
op_assign
id|pacl-&gt;a_entries
suffix:semicolon
id|BUG_ON
c_func
(paren
id|pa-&gt;e_tag
op_ne
id|ACL_USER_OBJ
)paren
suffix:semicolon
id|mask
op_assign
id|mask_from_posix
c_func
(paren
id|pa-&gt;e_perm
comma
id|flags
op_or
id|NFS4_ACL_OWNER
)paren
suffix:semicolon
id|error
op_assign
id|nfs4_acl_add_pair
c_func
(paren
id|acl
comma
id|eflag
comma
id|mask
comma
id|NFS4_ACL_WHO_OWNER
comma
l_int|0
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
OL
l_int|0
)paren
r_goto
id|out
suffix:semicolon
id|pa
op_increment
suffix:semicolon
r_while
c_loop
(paren
id|pa-&gt;e_tag
op_eq
id|ACL_USER
)paren
(brace
id|mask
op_assign
id|mask_from_posix
c_func
(paren
id|pa-&gt;e_perm
comma
id|flags
)paren
suffix:semicolon
id|error
op_assign
id|nfs4_acl_add_ace
c_func
(paren
id|acl
comma
id|NFS4_ACE_ACCESS_DENIED_ACE_TYPE
comma
id|eflag
comma
id|mask_mask
comma
id|NFS4_ACL_WHO_NAMED
comma
id|pa-&gt;e_id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
OL
l_int|0
)paren
r_goto
id|out
suffix:semicolon
id|error
op_assign
id|nfs4_acl_add_pair
c_func
(paren
id|acl
comma
id|eflag
comma
id|mask
comma
id|NFS4_ACL_WHO_NAMED
comma
id|pa-&gt;e_id
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
OL
l_int|0
)paren
r_goto
id|out
suffix:semicolon
id|pa
op_increment
suffix:semicolon
)brace
multiline_comment|/* In the case of groups, we apply allow ACEs first, then deny ACEs,&n;&t; * since a user can be in more than one group.  */
multiline_comment|/* allow ACEs */
r_if
c_cond
(paren
id|pacl-&gt;a_count
OG
l_int|3
)paren
(brace
id|BUG_ON
c_func
(paren
id|pa-&gt;e_tag
op_ne
id|ACL_GROUP_OBJ
)paren
suffix:semicolon
id|error
op_assign
id|nfs4_acl_add_ace
c_func
(paren
id|acl
comma
id|NFS4_ACE_ACCESS_DENIED_ACE_TYPE
comma
id|NFS4_ACE_IDENTIFIER_GROUP
op_or
id|eflag
comma
id|mask_mask
comma
id|NFS4_ACL_WHO_GROUP
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
OL
l_int|0
)paren
r_goto
id|out
suffix:semicolon
)brace
id|group_owner_entry
op_assign
id|pa
suffix:semicolon
id|mask
op_assign
id|mask_from_posix
c_func
(paren
id|pa-&gt;e_perm
comma
id|flags
)paren
suffix:semicolon
id|error
op_assign
id|nfs4_acl_add_ace
c_func
(paren
id|acl
comma
id|NFS4_ACE_ACCESS_ALLOWED_ACE_TYPE
comma
id|NFS4_ACE_IDENTIFIER_GROUP
op_or
id|eflag
comma
id|mask
comma
id|NFS4_ACL_WHO_GROUP
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
OL
l_int|0
)paren
r_goto
id|out
suffix:semicolon
id|pa
op_increment
suffix:semicolon
r_while
c_loop
(paren
id|pa-&gt;e_tag
op_eq
id|ACL_GROUP
)paren
(brace
id|mask
op_assign
id|mask_from_posix
c_func
(paren
id|pa-&gt;e_perm
comma
id|flags
)paren
suffix:semicolon
id|error
op_assign
id|nfs4_acl_add_ace
c_func
(paren
id|acl
comma
id|NFS4_ACE_ACCESS_DENIED_ACE_TYPE
comma
id|NFS4_ACE_IDENTIFIER_GROUP
op_or
id|eflag
comma
id|mask_mask
comma
id|NFS4_ACL_WHO_NAMED
comma
id|pa-&gt;e_id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
OL
l_int|0
)paren
r_goto
id|out
suffix:semicolon
id|error
op_assign
id|nfs4_acl_add_ace
c_func
(paren
id|acl
comma
id|NFS4_ACE_ACCESS_ALLOWED_ACE_TYPE
comma
id|NFS4_ACE_IDENTIFIER_GROUP
op_or
id|eflag
comma
id|mask
comma
id|NFS4_ACL_WHO_NAMED
comma
id|pa-&gt;e_id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
OL
l_int|0
)paren
r_goto
id|out
suffix:semicolon
id|pa
op_increment
suffix:semicolon
)brace
multiline_comment|/* deny ACEs */
id|pa
op_assign
id|group_owner_entry
suffix:semicolon
id|mask
op_assign
id|mask_from_posix
c_func
(paren
id|pa-&gt;e_perm
comma
id|flags
)paren
suffix:semicolon
id|error
op_assign
id|nfs4_acl_add_ace
c_func
(paren
id|acl
comma
id|NFS4_ACE_ACCESS_DENIED_ACE_TYPE
comma
id|NFS4_ACE_IDENTIFIER_GROUP
op_or
id|eflag
comma
id|deny_mask
c_func
(paren
id|mask
comma
id|flags
)paren
comma
id|NFS4_ACL_WHO_GROUP
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
OL
l_int|0
)paren
r_goto
id|out
suffix:semicolon
id|pa
op_increment
suffix:semicolon
r_while
c_loop
(paren
id|pa-&gt;e_tag
op_eq
id|ACL_GROUP
)paren
(brace
id|mask
op_assign
id|mask_from_posix
c_func
(paren
id|pa-&gt;e_perm
comma
id|flags
)paren
suffix:semicolon
id|error
op_assign
id|nfs4_acl_add_ace
c_func
(paren
id|acl
comma
id|NFS4_ACE_ACCESS_DENIED_ACE_TYPE
comma
id|NFS4_ACE_IDENTIFIER_GROUP
op_or
id|eflag
comma
id|deny_mask
c_func
(paren
id|mask
comma
id|flags
)paren
comma
id|NFS4_ACL_WHO_NAMED
comma
id|pa-&gt;e_id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
OL
l_int|0
)paren
r_goto
id|out
suffix:semicolon
id|pa
op_increment
suffix:semicolon
)brace
r_if
c_cond
(paren
id|pa-&gt;e_tag
op_eq
id|ACL_MASK
)paren
id|pa
op_increment
suffix:semicolon
id|BUG_ON
c_func
(paren
id|pa-&gt;e_tag
op_ne
id|ACL_OTHER
)paren
suffix:semicolon
id|mask
op_assign
id|mask_from_posix
c_func
(paren
id|pa-&gt;e_perm
comma
id|flags
)paren
suffix:semicolon
id|error
op_assign
id|nfs4_acl_add_pair
c_func
(paren
id|acl
comma
id|eflag
comma
id|mask
comma
id|NFS4_ACL_WHO_EVERYONE
comma
l_int|0
comma
id|flags
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|error
suffix:semicolon
)brace
r_static
r_void
DECL|function|sort_pacl_range
id|sort_pacl_range
c_func
(paren
r_struct
id|posix_acl
op_star
id|pacl
comma
r_int
id|start
comma
r_int
id|end
)paren
(brace
r_int
id|sorted
op_assign
l_int|0
comma
id|i
suffix:semicolon
r_struct
id|posix_acl_entry
id|tmp
suffix:semicolon
multiline_comment|/* We just do a bubble sort; easy to do in place, and we&squot;re not&n;&t; * expecting acl&squot;s to be long enough to justify anything more. */
r_while
c_loop
(paren
op_logical_neg
id|sorted
)paren
(brace
id|sorted
op_assign
l_int|1
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
id|start
suffix:semicolon
id|i
OL
id|end
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|pacl-&gt;a_entries
(braket
id|i
)braket
dot
id|e_id
OG
id|pacl-&gt;a_entries
(braket
id|i
op_plus
l_int|1
)braket
dot
id|e_id
)paren
(brace
id|sorted
op_assign
l_int|0
suffix:semicolon
id|tmp
op_assign
id|pacl-&gt;a_entries
(braket
id|i
)braket
suffix:semicolon
id|pacl-&gt;a_entries
(braket
id|i
)braket
op_assign
id|pacl-&gt;a_entries
(braket
id|i
op_plus
l_int|1
)braket
suffix:semicolon
id|pacl-&gt;a_entries
(braket
id|i
op_plus
l_int|1
)braket
op_assign
id|tmp
suffix:semicolon
)brace
)brace
)brace
)brace
r_static
r_void
DECL|function|sort_pacl
id|sort_pacl
c_func
(paren
r_struct
id|posix_acl
op_star
id|pacl
)paren
(brace
multiline_comment|/* posix_acl_valid requires that users and groups be in order&n;&t; * by uid/gid. */
r_int
id|i
comma
id|j
suffix:semicolon
r_if
c_cond
(paren
id|pacl-&gt;a_count
op_le
l_int|4
)paren
r_return
suffix:semicolon
multiline_comment|/* no users or groups */
id|i
op_assign
l_int|1
suffix:semicolon
r_while
c_loop
(paren
id|pacl-&gt;a_entries
(braket
id|i
)braket
dot
id|e_tag
op_eq
id|ACL_USER
)paren
id|i
op_increment
suffix:semicolon
id|sort_pacl_range
c_func
(paren
id|pacl
comma
l_int|1
comma
id|i
op_minus
l_int|1
)paren
suffix:semicolon
id|BUG_ON
c_func
(paren
id|pacl-&gt;a_entries
(braket
id|i
)braket
dot
id|e_tag
op_ne
id|ACL_GROUP_OBJ
)paren
suffix:semicolon
id|j
op_assign
id|i
op_increment
suffix:semicolon
r_while
c_loop
(paren
id|pacl-&gt;a_entries
(braket
id|j
)braket
dot
id|e_tag
op_eq
id|ACL_GROUP
)paren
id|j
op_increment
suffix:semicolon
id|sort_pacl_range
c_func
(paren
id|pacl
comma
id|i
comma
id|j
op_minus
l_int|1
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_static
r_int
DECL|function|write_pace
id|write_pace
c_func
(paren
r_struct
id|nfs4_ace
op_star
id|ace
comma
r_struct
id|posix_acl
op_star
id|pacl
comma
r_struct
id|posix_acl_entry
op_star
op_star
id|pace
comma
r_int
id|tag
comma
r_int
r_int
id|flags
)paren
(brace
r_struct
id|posix_acl_entry
op_star
id|this
op_assign
op_star
id|pace
suffix:semicolon
r_if
c_cond
(paren
op_star
id|pace
op_eq
id|pacl-&gt;a_entries
op_plus
id|pacl-&gt;a_count
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
multiline_comment|/* fell off the end */
(paren
op_star
id|pace
)paren
op_increment
suffix:semicolon
id|this-&gt;e_tag
op_assign
id|tag
suffix:semicolon
r_if
c_cond
(paren
id|tag
op_eq
id|ACL_USER_OBJ
)paren
id|flags
op_or_assign
id|NFS4_ACL_OWNER
suffix:semicolon
r_if
c_cond
(paren
id|mode_from_nfs4
c_func
(paren
id|ace-&gt;access_mask
comma
op_amp
id|this-&gt;e_perm
comma
id|flags
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|this-&gt;e_id
op_assign
(paren
id|tag
op_eq
id|ACL_USER
op_logical_or
id|tag
op_eq
id|ACL_GROUP
ques
c_cond
id|ace-&gt;who
suffix:colon
id|ACL_UNDEFINED_ID
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_struct
id|nfs4_ace
op_star
DECL|function|get_next_v4_ace
id|get_next_v4_ace
c_func
(paren
r_struct
id|list_head
op_star
op_star
id|p
comma
r_struct
id|list_head
op_star
id|head
)paren
(brace
r_struct
id|nfs4_ace
op_star
id|ace
suffix:semicolon
op_star
id|p
op_assign
(paren
op_star
id|p
)paren
op_member_access_from_pointer
id|next
suffix:semicolon
r_if
c_cond
(paren
op_star
id|p
op_eq
id|head
)paren
r_return
l_int|NULL
suffix:semicolon
id|ace
op_assign
id|list_entry
c_func
(paren
op_star
id|p
comma
r_struct
id|nfs4_ace
comma
id|l_ace
)paren
suffix:semicolon
r_return
id|ace
suffix:semicolon
)brace
r_int
DECL|function|nfs4_acl_nfsv4_to_posix
id|nfs4_acl_nfsv4_to_posix
c_func
(paren
r_struct
id|nfs4_acl
op_star
id|acl
comma
r_struct
id|posix_acl
op_star
op_star
id|pacl
comma
r_struct
id|posix_acl
op_star
op_star
id|dpacl
comma
r_int
r_int
id|flags
)paren
(brace
r_struct
id|nfs4_acl
op_star
id|dacl
suffix:semicolon
r_int
id|error
op_assign
op_minus
id|ENOMEM
suffix:semicolon
op_star
id|pacl
op_assign
l_int|NULL
suffix:semicolon
op_star
id|dpacl
op_assign
l_int|NULL
suffix:semicolon
id|dacl
op_assign
id|nfs4_acl_new
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dacl
op_eq
l_int|NULL
)paren
r_goto
id|out
suffix:semicolon
id|error
op_assign
id|nfs4_acl_split
c_func
(paren
id|acl
comma
id|dacl
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
OL
l_int|0
)paren
r_goto
id|out_acl
suffix:semicolon
r_if
c_cond
(paren
id|pacl
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|acl-&gt;naces
op_eq
l_int|0
)paren
(brace
id|error
op_assign
op_minus
id|ENODATA
suffix:semicolon
r_goto
id|try_dpacl
suffix:semicolon
)brace
op_star
id|pacl
op_assign
id|_nfsv4_to_posix_one
c_func
(paren
id|acl
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
op_star
id|pacl
)paren
)paren
(brace
id|error
op_assign
id|PTR_ERR
c_func
(paren
op_star
id|pacl
)paren
suffix:semicolon
op_star
id|pacl
op_assign
l_int|NULL
suffix:semicolon
r_goto
id|out_acl
suffix:semicolon
)brace
)brace
id|try_dpacl
suffix:colon
r_if
c_cond
(paren
id|dpacl
op_ne
l_int|NULL
)paren
(brace
r_if
c_cond
(paren
id|dacl-&gt;naces
op_eq
l_int|0
)paren
(brace
r_if
c_cond
(paren
id|pacl
op_eq
l_int|NULL
op_logical_or
op_star
id|pacl
op_eq
l_int|NULL
)paren
id|error
op_assign
op_minus
id|ENODATA
suffix:semicolon
r_goto
id|out_acl
suffix:semicolon
)brace
id|error
op_assign
l_int|0
suffix:semicolon
op_star
id|dpacl
op_assign
id|_nfsv4_to_posix_one
c_func
(paren
id|dacl
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
op_star
id|dpacl
)paren
)paren
(brace
id|error
op_assign
id|PTR_ERR
c_func
(paren
op_star
id|dpacl
)paren
suffix:semicolon
op_star
id|dpacl
op_assign
l_int|NULL
suffix:semicolon
r_goto
id|out_acl
suffix:semicolon
)brace
)brace
id|out_acl
suffix:colon
r_if
c_cond
(paren
id|error
op_logical_and
id|pacl
)paren
(brace
id|posix_acl_release
c_func
(paren
op_star
id|pacl
)paren
suffix:semicolon
op_star
id|pacl
op_assign
l_int|NULL
suffix:semicolon
)brace
id|nfs4_acl_free
c_func
(paren
id|dacl
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|error
suffix:semicolon
)brace
r_static
r_int
DECL|function|same_who
id|same_who
c_func
(paren
r_struct
id|nfs4_ace
op_star
id|a
comma
r_struct
id|nfs4_ace
op_star
id|b
)paren
(brace
r_return
id|a-&gt;whotype
op_eq
id|b-&gt;whotype
op_logical_and
(paren
id|a-&gt;whotype
op_ne
id|NFS4_ACL_WHO_NAMED
op_logical_or
id|a-&gt;who
op_eq
id|b-&gt;who
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|complementary_ace_pair
id|complementary_ace_pair
c_func
(paren
r_struct
id|nfs4_ace
op_star
id|allow
comma
r_struct
id|nfs4_ace
op_star
id|deny
comma
r_int
r_int
id|flags
)paren
(brace
r_int
id|ignore
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|flags
op_amp
id|NFS4_ACL_DIR
)paren
)paren
id|ignore
op_or_assign
id|NFS4_ACE_DELETE_CHILD
suffix:semicolon
r_return
id|MASK_EQUAL
c_func
(paren
id|ignore
op_or
id|deny_mask
c_func
(paren
id|allow-&gt;access_mask
comma
id|flags
)paren
comma
id|ignore
op_or
id|deny-&gt;access_mask
)paren
op_logical_and
id|allow-&gt;type
op_eq
id|NFS4_ACE_ACCESS_ALLOWED_ACE_TYPE
op_logical_and
id|deny-&gt;type
op_eq
id|NFS4_ACE_ACCESS_DENIED_ACE_TYPE
op_logical_and
id|allow-&gt;flag
op_eq
id|deny-&gt;flag
op_logical_and
id|same_who
c_func
(paren
id|allow
comma
id|deny
)paren
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|user_obj_from_v4
id|user_obj_from_v4
c_func
(paren
r_struct
id|nfs4_acl
op_star
id|n4acl
comma
r_struct
id|list_head
op_star
op_star
id|p
comma
r_struct
id|posix_acl
op_star
id|pacl
comma
r_struct
id|posix_acl_entry
op_star
op_star
id|pace
comma
r_int
r_int
id|flags
)paren
(brace
r_int
id|error
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_struct
id|nfs4_ace
op_star
id|ace
comma
op_star
id|ace2
suffix:semicolon
id|ace
op_assign
id|get_next_v4_ace
c_func
(paren
id|p
comma
op_amp
id|n4acl-&gt;ace_head
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ace
op_eq
l_int|NULL
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|ace2type
c_func
(paren
id|ace
)paren
op_ne
id|ACL_USER_OBJ
)paren
r_goto
id|out
suffix:semicolon
id|error
op_assign
id|write_pace
c_func
(paren
id|ace
comma
id|pacl
comma
id|pace
comma
id|ACL_USER_OBJ
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
OL
l_int|0
)paren
r_goto
id|out
suffix:semicolon
id|error
op_assign
op_minus
id|EINVAL
suffix:semicolon
id|ace2
op_assign
id|get_next_v4_ace
c_func
(paren
id|p
comma
op_amp
id|n4acl-&gt;ace_head
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ace2
op_eq
l_int|NULL
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|complementary_ace_pair
c_func
(paren
id|ace
comma
id|ace2
comma
id|flags
)paren
)paren
r_goto
id|out
suffix:semicolon
id|error
op_assign
l_int|0
suffix:semicolon
id|out
suffix:colon
r_return
id|error
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|users_from_v4
id|users_from_v4
c_func
(paren
r_struct
id|nfs4_acl
op_star
id|n4acl
comma
r_struct
id|list_head
op_star
op_star
id|p
comma
r_struct
id|nfs4_ace
op_star
op_star
id|mask_ace
comma
r_struct
id|posix_acl
op_star
id|pacl
comma
r_struct
id|posix_acl_entry
op_star
op_star
id|pace
comma
r_int
r_int
id|flags
)paren
(brace
r_int
id|error
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_struct
id|nfs4_ace
op_star
id|ace
comma
op_star
id|ace2
suffix:semicolon
id|ace
op_assign
id|get_next_v4_ace
c_func
(paren
id|p
comma
op_amp
id|n4acl-&gt;ace_head
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ace
op_eq
l_int|NULL
)paren
r_goto
id|out
suffix:semicolon
r_while
c_loop
(paren
id|ace2type
c_func
(paren
id|ace
)paren
op_eq
id|ACL_USER
)paren
(brace
r_if
c_cond
(paren
id|ace-&gt;type
op_ne
id|NFS4_ACE_ACCESS_DENIED_ACE_TYPE
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
op_star
id|mask_ace
op_logical_and
op_logical_neg
id|MASK_EQUAL
c_func
(paren
id|ace-&gt;access_mask
comma
(paren
op_star
id|mask_ace
)paren
op_member_access_from_pointer
id|access_mask
)paren
)paren
r_goto
id|out
suffix:semicolon
op_star
id|mask_ace
op_assign
id|ace
suffix:semicolon
id|ace
op_assign
id|get_next_v4_ace
c_func
(paren
id|p
comma
op_amp
id|n4acl-&gt;ace_head
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ace
op_eq
l_int|NULL
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|ace-&gt;type
op_ne
id|NFS4_ACE_ACCESS_ALLOWED_ACE_TYPE
)paren
r_goto
id|out
suffix:semicolon
id|error
op_assign
id|write_pace
c_func
(paren
id|ace
comma
id|pacl
comma
id|pace
comma
id|ACL_USER
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
OL
l_int|0
)paren
r_goto
id|out
suffix:semicolon
id|error
op_assign
op_minus
id|EINVAL
suffix:semicolon
id|ace2
op_assign
id|get_next_v4_ace
c_func
(paren
id|p
comma
op_amp
id|n4acl-&gt;ace_head
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ace2
op_eq
l_int|NULL
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|complementary_ace_pair
c_func
(paren
id|ace
comma
id|ace2
comma
id|flags
)paren
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
(paren
op_star
id|mask_ace
)paren
op_member_access_from_pointer
id|flag
op_ne
id|ace2-&gt;flag
op_logical_or
op_logical_neg
id|same_who
c_func
(paren
op_star
id|mask_ace
comma
id|ace2
)paren
)paren
r_goto
id|out
suffix:semicolon
id|ace
op_assign
id|get_next_v4_ace
c_func
(paren
id|p
comma
op_amp
id|n4acl-&gt;ace_head
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ace
op_eq
l_int|NULL
)paren
r_goto
id|out
suffix:semicolon
)brace
id|error
op_assign
l_int|0
suffix:semicolon
id|out
suffix:colon
r_return
id|error
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|group_obj_and_groups_from_v4
id|group_obj_and_groups_from_v4
c_func
(paren
r_struct
id|nfs4_acl
op_star
id|n4acl
comma
r_struct
id|list_head
op_star
op_star
id|p
comma
r_struct
id|nfs4_ace
op_star
op_star
id|mask_ace
comma
r_struct
id|posix_acl
op_star
id|pacl
comma
r_struct
id|posix_acl_entry
op_star
op_star
id|pace
comma
r_int
r_int
id|flags
)paren
(brace
r_int
id|error
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_struct
id|nfs4_ace
op_star
id|ace
comma
op_star
id|ace2
suffix:semicolon
r_struct
id|ace_container
op_star
id|ac
suffix:semicolon
r_struct
id|list_head
id|group_l
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|group_l
)paren
suffix:semicolon
id|ace
op_assign
id|list_entry
c_func
(paren
op_star
id|p
comma
r_struct
id|nfs4_ace
comma
id|l_ace
)paren
suffix:semicolon
multiline_comment|/* group owner (mask and allow aces) */
r_if
c_cond
(paren
id|pacl-&gt;a_count
op_ne
l_int|3
)paren
(brace
multiline_comment|/* then the group owner should be preceded by mask */
r_if
c_cond
(paren
id|ace-&gt;type
op_ne
id|NFS4_ACE_ACCESS_DENIED_ACE_TYPE
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
op_star
id|mask_ace
op_logical_and
op_logical_neg
id|MASK_EQUAL
c_func
(paren
id|ace-&gt;access_mask
comma
(paren
op_star
id|mask_ace
)paren
op_member_access_from_pointer
id|access_mask
)paren
)paren
r_goto
id|out
suffix:semicolon
op_star
id|mask_ace
op_assign
id|ace
suffix:semicolon
id|ace
op_assign
id|get_next_v4_ace
c_func
(paren
id|p
comma
op_amp
id|n4acl-&gt;ace_head
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ace
op_eq
l_int|NULL
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
(paren
op_star
id|mask_ace
)paren
op_member_access_from_pointer
id|flag
op_ne
id|ace-&gt;flag
op_logical_or
op_logical_neg
id|same_who
c_func
(paren
op_star
id|mask_ace
comma
id|ace
)paren
)paren
r_goto
id|out
suffix:semicolon
)brace
r_if
c_cond
(paren
id|ace2type
c_func
(paren
id|ace
)paren
op_ne
id|ACL_GROUP_OBJ
)paren
r_goto
id|out
suffix:semicolon
id|ac
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|ac
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|error
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
id|ac
op_eq
l_int|NULL
)paren
r_goto
id|out
suffix:semicolon
id|ac-&gt;ace
op_assign
id|ace
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|ac-&gt;ace_l
comma
op_amp
id|group_l
)paren
suffix:semicolon
id|error
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|ace-&gt;type
op_ne
id|NFS4_ACE_ACCESS_ALLOWED_ACE_TYPE
)paren
r_goto
id|out
suffix:semicolon
id|error
op_assign
id|write_pace
c_func
(paren
id|ace
comma
id|pacl
comma
id|pace
comma
id|ACL_GROUP_OBJ
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
OL
l_int|0
)paren
r_goto
id|out
suffix:semicolon
id|error
op_assign
op_minus
id|EINVAL
suffix:semicolon
id|ace
op_assign
id|get_next_v4_ace
c_func
(paren
id|p
comma
op_amp
id|n4acl-&gt;ace_head
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ace
op_eq
l_int|NULL
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* groups (mask and allow aces) */
r_while
c_loop
(paren
id|ace2type
c_func
(paren
id|ace
)paren
op_eq
id|ACL_GROUP
)paren
(brace
r_if
c_cond
(paren
op_star
id|mask_ace
op_eq
l_int|NULL
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|ace-&gt;type
op_ne
id|NFS4_ACE_ACCESS_DENIED_ACE_TYPE
op_logical_or
op_logical_neg
id|MASK_EQUAL
c_func
(paren
id|ace-&gt;access_mask
comma
(paren
op_star
id|mask_ace
)paren
op_member_access_from_pointer
id|access_mask
)paren
)paren
r_goto
id|out
suffix:semicolon
op_star
id|mask_ace
op_assign
id|ace
suffix:semicolon
id|ace
op_assign
id|get_next_v4_ace
c_func
(paren
id|p
comma
op_amp
id|n4acl-&gt;ace_head
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ace
op_eq
l_int|NULL
)paren
r_goto
id|out
suffix:semicolon
id|ac
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|ac
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|error
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
id|ac
op_eq
l_int|NULL
)paren
r_goto
id|out
suffix:semicolon
id|error
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|ace-&gt;type
op_ne
id|NFS4_ACE_ACCESS_ALLOWED_ACE_TYPE
op_logical_or
op_logical_neg
id|same_who
c_func
(paren
id|ace
comma
op_star
id|mask_ace
)paren
)paren
r_goto
id|out
suffix:semicolon
id|ac-&gt;ace
op_assign
id|ace
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|ac-&gt;ace_l
comma
op_amp
id|group_l
)paren
suffix:semicolon
id|error
op_assign
id|write_pace
c_func
(paren
id|ace
comma
id|pacl
comma
id|pace
comma
id|ACL_GROUP
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
OL
l_int|0
)paren
r_goto
id|out
suffix:semicolon
id|error
op_assign
op_minus
id|EINVAL
suffix:semicolon
id|ace
op_assign
id|get_next_v4_ace
c_func
(paren
id|p
comma
op_amp
id|n4acl-&gt;ace_head
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ace
op_eq
l_int|NULL
)paren
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/* group owner (deny ace) */
r_if
c_cond
(paren
id|ace2type
c_func
(paren
id|ace
)paren
op_ne
id|ACL_GROUP_OBJ
)paren
r_goto
id|out
suffix:semicolon
id|ac
op_assign
id|list_entry
c_func
(paren
id|group_l.next
comma
r_struct
id|ace_container
comma
id|ace_l
)paren
suffix:semicolon
id|ace2
op_assign
id|ac-&gt;ace
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|complementary_ace_pair
c_func
(paren
id|ace2
comma
id|ace
comma
id|flags
)paren
)paren
r_goto
id|out
suffix:semicolon
id|list_del
c_func
(paren
id|group_l.next
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|ac
)paren
suffix:semicolon
multiline_comment|/* groups (deny aces) */
r_while
c_loop
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|group_l
)paren
)paren
(brace
id|ace
op_assign
id|get_next_v4_ace
c_func
(paren
id|p
comma
op_amp
id|n4acl-&gt;ace_head
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ace
op_eq
l_int|NULL
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|ace2type
c_func
(paren
id|ace
)paren
op_ne
id|ACL_GROUP
)paren
r_goto
id|out
suffix:semicolon
id|ac
op_assign
id|list_entry
c_func
(paren
id|group_l.next
comma
r_struct
id|ace_container
comma
id|ace_l
)paren
suffix:semicolon
id|ace2
op_assign
id|ac-&gt;ace
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|complementary_ace_pair
c_func
(paren
id|ace2
comma
id|ace
comma
id|flags
)paren
)paren
r_goto
id|out
suffix:semicolon
id|list_del
c_func
(paren
id|group_l.next
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|ac
)paren
suffix:semicolon
)brace
id|ace
op_assign
id|get_next_v4_ace
c_func
(paren
id|p
comma
op_amp
id|n4acl-&gt;ace_head
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ace
op_eq
l_int|NULL
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|ace2type
c_func
(paren
id|ace
)paren
op_ne
id|ACL_OTHER
)paren
r_goto
id|out
suffix:semicolon
id|error
op_assign
l_int|0
suffix:semicolon
id|out
suffix:colon
r_while
c_loop
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|group_l
)paren
)paren
(brace
id|ac
op_assign
id|list_entry
c_func
(paren
id|group_l.next
comma
r_struct
id|ace_container
comma
id|ace_l
)paren
suffix:semicolon
id|list_del
c_func
(paren
id|group_l.next
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|ac
)paren
suffix:semicolon
)brace
r_return
id|error
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|mask_from_v4
id|mask_from_v4
c_func
(paren
r_struct
id|nfs4_acl
op_star
id|n4acl
comma
r_struct
id|list_head
op_star
op_star
id|p
comma
r_struct
id|nfs4_ace
op_star
op_star
id|mask_ace
comma
r_struct
id|posix_acl
op_star
id|pacl
comma
r_struct
id|posix_acl_entry
op_star
op_star
id|pace
comma
r_int
r_int
id|flags
)paren
(brace
r_int
id|error
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_struct
id|nfs4_ace
op_star
id|ace
suffix:semicolon
id|ace
op_assign
id|list_entry
c_func
(paren
op_star
id|p
comma
r_struct
id|nfs4_ace
comma
id|l_ace
)paren
suffix:semicolon
r_if
c_cond
(paren
id|pacl-&gt;a_count
op_ne
l_int|3
)paren
(brace
r_if
c_cond
(paren
op_star
id|mask_ace
op_eq
l_int|NULL
)paren
r_goto
id|out
suffix:semicolon
(paren
op_star
id|mask_ace
)paren
op_member_access_from_pointer
id|access_mask
op_assign
id|deny_mask
c_func
(paren
(paren
op_star
id|mask_ace
)paren
op_member_access_from_pointer
id|access_mask
comma
id|flags
)paren
suffix:semicolon
id|write_pace
c_func
(paren
op_star
id|mask_ace
comma
id|pacl
comma
id|pace
comma
id|ACL_MASK
comma
id|flags
)paren
suffix:semicolon
)brace
id|error
op_assign
l_int|0
suffix:semicolon
id|out
suffix:colon
r_return
id|error
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|other_from_v4
id|other_from_v4
c_func
(paren
r_struct
id|nfs4_acl
op_star
id|n4acl
comma
r_struct
id|list_head
op_star
op_star
id|p
comma
r_struct
id|posix_acl
op_star
id|pacl
comma
r_struct
id|posix_acl_entry
op_star
op_star
id|pace
comma
r_int
r_int
id|flags
)paren
(brace
r_int
id|error
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_struct
id|nfs4_ace
op_star
id|ace
comma
op_star
id|ace2
suffix:semicolon
id|ace
op_assign
id|list_entry
c_func
(paren
op_star
id|p
comma
r_struct
id|nfs4_ace
comma
id|l_ace
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ace-&gt;type
op_ne
id|NFS4_ACE_ACCESS_ALLOWED_ACE_TYPE
)paren
r_goto
id|out
suffix:semicolon
id|error
op_assign
id|write_pace
c_func
(paren
id|ace
comma
id|pacl
comma
id|pace
comma
id|ACL_OTHER
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
OL
l_int|0
)paren
r_goto
id|out
suffix:semicolon
id|error
op_assign
op_minus
id|EINVAL
suffix:semicolon
id|ace2
op_assign
id|get_next_v4_ace
c_func
(paren
id|p
comma
op_amp
id|n4acl-&gt;ace_head
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ace2
op_eq
l_int|NULL
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|complementary_ace_pair
c_func
(paren
id|ace
comma
id|ace2
comma
id|flags
)paren
)paren
r_goto
id|out
suffix:semicolon
id|error
op_assign
l_int|0
suffix:semicolon
id|out
suffix:colon
r_return
id|error
suffix:semicolon
)brace
r_static
r_int
DECL|function|calculate_posix_ace_count
id|calculate_posix_ace_count
c_func
(paren
r_struct
id|nfs4_acl
op_star
id|n4acl
)paren
(brace
r_if
c_cond
(paren
id|n4acl-&gt;naces
op_eq
l_int|6
)paren
multiline_comment|/* owner, owner group, and other only */
r_return
l_int|3
suffix:semicolon
r_else
(brace
multiline_comment|/* Otherwise there must be a mask entry. */
multiline_comment|/* Also, the remaining entries are for named users and&n;&t;&t; * groups, and come in threes (mask, allow, deny): */
r_if
c_cond
(paren
id|n4acl-&gt;naces
OL
l_int|7
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
(paren
id|n4acl-&gt;naces
op_minus
l_int|7
)paren
op_mod
l_int|3
)paren
r_return
op_minus
l_int|1
suffix:semicolon
r_return
l_int|4
op_plus
(paren
id|n4acl-&gt;naces
op_minus
l_int|7
)paren
op_div
l_int|3
suffix:semicolon
)brace
)brace
r_static
r_struct
id|posix_acl
op_star
DECL|function|_nfsv4_to_posix_one
id|_nfsv4_to_posix_one
c_func
(paren
r_struct
id|nfs4_acl
op_star
id|n4acl
comma
r_int
r_int
id|flags
)paren
(brace
r_struct
id|posix_acl
op_star
id|pacl
suffix:semicolon
r_int
id|error
op_assign
op_minus
id|EINVAL
comma
id|nace
op_assign
l_int|0
suffix:semicolon
r_struct
id|list_head
op_star
id|p
suffix:semicolon
r_struct
id|nfs4_ace
op_star
id|mask_ace
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|posix_acl_entry
op_star
id|pace
suffix:semicolon
id|nace
op_assign
id|calculate_posix_ace_count
c_func
(paren
id|n4acl
)paren
suffix:semicolon
r_if
c_cond
(paren
id|nace
OL
l_int|0
)paren
r_goto
id|out_err
suffix:semicolon
id|pacl
op_assign
id|posix_acl_alloc
c_func
(paren
id|nace
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|error
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
id|pacl
op_eq
l_int|NULL
)paren
r_goto
id|out_err
suffix:semicolon
id|pace
op_assign
op_amp
id|pacl-&gt;a_entries
(braket
l_int|0
)braket
suffix:semicolon
id|p
op_assign
op_amp
id|n4acl-&gt;ace_head
suffix:semicolon
id|error
op_assign
id|user_obj_from_v4
c_func
(paren
id|n4acl
comma
op_amp
id|p
comma
id|pacl
comma
op_amp
id|pace
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_goto
id|out_acl
suffix:semicolon
id|error
op_assign
id|users_from_v4
c_func
(paren
id|n4acl
comma
op_amp
id|p
comma
op_amp
id|mask_ace
comma
id|pacl
comma
op_amp
id|pace
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_goto
id|out_acl
suffix:semicolon
id|error
op_assign
id|group_obj_and_groups_from_v4
c_func
(paren
id|n4acl
comma
op_amp
id|p
comma
op_amp
id|mask_ace
comma
id|pacl
comma
op_amp
id|pace
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_goto
id|out_acl
suffix:semicolon
id|error
op_assign
id|mask_from_v4
c_func
(paren
id|n4acl
comma
op_amp
id|p
comma
op_amp
id|mask_ace
comma
id|pacl
comma
op_amp
id|pace
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_goto
id|out_acl
suffix:semicolon
id|error
op_assign
id|other_from_v4
c_func
(paren
id|n4acl
comma
op_amp
id|p
comma
id|pacl
comma
op_amp
id|pace
comma
id|flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
)paren
r_goto
id|out_acl
suffix:semicolon
id|error
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|p-&gt;next
op_ne
op_amp
id|n4acl-&gt;ace_head
)paren
r_goto
id|out_acl
suffix:semicolon
r_if
c_cond
(paren
id|pace
op_ne
id|pacl-&gt;a_entries
op_plus
id|pacl-&gt;a_count
)paren
r_goto
id|out_acl
suffix:semicolon
id|sort_pacl
c_func
(paren
id|pacl
)paren
suffix:semicolon
r_return
id|pacl
suffix:semicolon
id|out_acl
suffix:colon
id|posix_acl_release
c_func
(paren
id|pacl
)paren
suffix:semicolon
id|out_err
suffix:colon
id|pacl
op_assign
id|ERR_PTR
c_func
(paren
id|error
)paren
suffix:semicolon
r_return
id|pacl
suffix:semicolon
)brace
r_int
DECL|function|nfs4_acl_split
id|nfs4_acl_split
c_func
(paren
r_struct
id|nfs4_acl
op_star
id|acl
comma
r_struct
id|nfs4_acl
op_star
id|dacl
)paren
(brace
r_struct
id|list_head
op_star
id|h
comma
op_star
id|n
suffix:semicolon
r_struct
id|nfs4_ace
op_star
id|ace
suffix:semicolon
r_int
id|error
op_assign
l_int|0
suffix:semicolon
id|list_for_each_safe
c_func
(paren
id|h
comma
id|n
comma
op_amp
id|acl-&gt;ace_head
)paren
(brace
id|ace
op_assign
id|list_entry
c_func
(paren
id|h
comma
r_struct
id|nfs4_ace
comma
id|l_ace
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ace-&gt;flag
op_amp
id|NFS4_INHERITANCE_FLAGS
)paren
op_ne
id|NFS4_INHERITANCE_FLAGS
)paren
r_continue
suffix:semicolon
id|error
op_assign
id|nfs4_acl_add_ace
c_func
(paren
id|dacl
comma
id|ace-&gt;type
comma
id|ace-&gt;flag
comma
id|ace-&gt;access_mask
comma
id|ace-&gt;whotype
comma
id|ace-&gt;who
)paren
op_eq
op_minus
l_int|1
suffix:semicolon
r_if
c_cond
(paren
id|error
OL
l_int|0
)paren
r_goto
id|out
suffix:semicolon
id|list_del
c_func
(paren
id|h
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|ace
)paren
suffix:semicolon
id|acl-&gt;naces
op_decrement
suffix:semicolon
)brace
id|out
suffix:colon
r_return
id|error
suffix:semicolon
)brace
r_static
r_int
DECL|function|ace2type
id|ace2type
c_func
(paren
r_struct
id|nfs4_ace
op_star
id|ace
)paren
(brace
r_switch
c_cond
(paren
id|ace-&gt;whotype
)paren
(brace
r_case
id|NFS4_ACL_WHO_NAMED
suffix:colon
r_return
(paren
id|ace-&gt;flag
op_amp
id|NFS4_ACE_IDENTIFIER_GROUP
ques
c_cond
id|ACL_GROUP
suffix:colon
id|ACL_USER
)paren
suffix:semicolon
r_case
id|NFS4_ACL_WHO_OWNER
suffix:colon
r_return
id|ACL_USER_OBJ
suffix:semicolon
r_case
id|NFS4_ACL_WHO_GROUP
suffix:colon
r_return
id|ACL_GROUP_OBJ
suffix:semicolon
r_case
id|NFS4_ACL_WHO_EVERYONE
suffix:colon
r_return
id|ACL_OTHER
suffix:semicolon
)brace
id|BUG
c_func
(paren
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
DECL|variable|nfs4_acl_posix_to_nfsv4
id|EXPORT_SYMBOL
c_func
(paren
id|nfs4_acl_posix_to_nfsv4
)paren
suffix:semicolon
DECL|variable|nfs4_acl_nfsv4_to_posix
id|EXPORT_SYMBOL
c_func
(paren
id|nfs4_acl_nfsv4_to_posix
)paren
suffix:semicolon
r_struct
id|nfs4_acl
op_star
DECL|function|nfs4_acl_new
id|nfs4_acl_new
c_func
(paren
r_void
)paren
(brace
r_struct
id|nfs4_acl
op_star
id|acl
suffix:semicolon
r_if
c_cond
(paren
(paren
id|acl
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|acl
)paren
comma
id|GFP_KERNEL
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
l_int|NULL
suffix:semicolon
id|acl-&gt;naces
op_assign
l_int|0
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|acl-&gt;ace_head
)paren
suffix:semicolon
r_return
id|acl
suffix:semicolon
)brace
r_void
DECL|function|nfs4_acl_free
id|nfs4_acl_free
c_func
(paren
r_struct
id|nfs4_acl
op_star
id|acl
)paren
(brace
r_struct
id|list_head
op_star
id|h
suffix:semicolon
r_struct
id|nfs4_ace
op_star
id|ace
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|acl
)paren
r_return
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|list_empty
c_func
(paren
op_amp
id|acl-&gt;ace_head
)paren
)paren
(brace
id|h
op_assign
id|acl-&gt;ace_head.next
suffix:semicolon
id|list_del
c_func
(paren
id|h
)paren
suffix:semicolon
id|ace
op_assign
id|list_entry
c_func
(paren
id|h
comma
r_struct
id|nfs4_ace
comma
id|l_ace
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|ace
)paren
suffix:semicolon
)brace
id|kfree
c_func
(paren
id|acl
)paren
suffix:semicolon
r_return
suffix:semicolon
)brace
r_int
DECL|function|nfs4_acl_add_ace
id|nfs4_acl_add_ace
c_func
(paren
r_struct
id|nfs4_acl
op_star
id|acl
comma
id|u32
id|type
comma
id|u32
id|flag
comma
id|u32
id|access_mask
comma
r_int
id|whotype
comma
id|uid_t
id|who
)paren
(brace
r_struct
id|nfs4_ace
op_star
id|ace
suffix:semicolon
r_if
c_cond
(paren
(paren
id|ace
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|ace
)paren
comma
id|GFP_KERNEL
)paren
)paren
op_eq
l_int|NULL
)paren
r_return
op_minus
l_int|1
suffix:semicolon
id|ace-&gt;type
op_assign
id|type
suffix:semicolon
id|ace-&gt;flag
op_assign
id|flag
suffix:semicolon
id|ace-&gt;access_mask
op_assign
id|access_mask
suffix:semicolon
id|ace-&gt;whotype
op_assign
id|whotype
suffix:semicolon
id|ace-&gt;who
op_assign
id|who
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|ace-&gt;l_ace
comma
op_amp
id|acl-&gt;ace_head
)paren
suffix:semicolon
id|acl-&gt;naces
op_increment
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_struct
(brace
DECL|member|string
r_char
op_star
id|string
suffix:semicolon
DECL|member|stringlen
r_int
id|stringlen
suffix:semicolon
DECL|member|type
r_int
id|type
suffix:semicolon
DECL|variable|s2t_map
)brace
id|s2t_map
(braket
)braket
op_assign
(brace
(brace
dot
id|string
op_assign
l_string|&quot;OWNER@&quot;
comma
dot
id|stringlen
op_assign
r_sizeof
(paren
l_string|&quot;OWNER@&quot;
)paren
op_minus
l_int|1
comma
dot
id|type
op_assign
id|NFS4_ACL_WHO_OWNER
comma
)brace
comma
(brace
dot
id|string
op_assign
l_string|&quot;GROUP@&quot;
comma
dot
id|stringlen
op_assign
r_sizeof
(paren
l_string|&quot;GROUP@&quot;
)paren
op_minus
l_int|1
comma
dot
id|type
op_assign
id|NFS4_ACL_WHO_GROUP
comma
)brace
comma
(brace
dot
id|string
op_assign
l_string|&quot;EVERYONE@&quot;
comma
dot
id|stringlen
op_assign
r_sizeof
(paren
l_string|&quot;EVERYONE@&quot;
)paren
op_minus
l_int|1
comma
dot
id|type
op_assign
id|NFS4_ACL_WHO_EVERYONE
comma
)brace
comma
)brace
suffix:semicolon
r_int
DECL|function|nfs4_acl_get_whotype
id|nfs4_acl_get_whotype
c_func
(paren
r_char
op_star
id|p
comma
id|u32
id|len
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
(paren
id|s2t_map
)paren
op_div
r_sizeof
(paren
op_star
id|s2t_map
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|s2t_map
(braket
id|i
)braket
dot
id|stringlen
op_eq
id|len
op_logical_and
l_int|0
op_eq
id|memcmp
c_func
(paren
id|s2t_map
(braket
id|i
)braket
dot
id|string
comma
id|p
comma
id|len
)paren
)paren
r_return
id|s2t_map
(braket
id|i
)braket
dot
id|type
suffix:semicolon
)brace
r_return
id|NFS4_ACL_WHO_NAMED
suffix:semicolon
)brace
r_int
DECL|function|nfs4_acl_write_who
id|nfs4_acl_write_who
c_func
(paren
r_int
id|who
comma
r_char
op_star
id|p
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
r_sizeof
(paren
id|s2t_map
)paren
op_div
r_sizeof
(paren
op_star
id|s2t_map
)paren
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
id|s2t_map
(braket
id|i
)braket
dot
id|type
op_eq
id|who
)paren
(brace
id|memcpy
c_func
(paren
id|p
comma
id|s2t_map
(braket
id|i
)braket
dot
id|string
comma
id|s2t_map
(braket
id|i
)braket
dot
id|stringlen
)paren
suffix:semicolon
r_return
id|s2t_map
(braket
id|i
)braket
dot
id|stringlen
suffix:semicolon
)brace
)brace
id|BUG
c_func
(paren
)paren
suffix:semicolon
r_return
op_minus
l_int|1
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|match_who
id|match_who
c_func
(paren
r_struct
id|nfs4_ace
op_star
id|ace
comma
id|uid_t
id|owner
comma
id|gid_t
id|group
comma
id|uid_t
id|who
)paren
(brace
r_switch
c_cond
(paren
id|ace-&gt;whotype
)paren
(brace
r_case
id|NFS4_ACL_WHO_NAMED
suffix:colon
r_return
id|who
op_eq
id|ace-&gt;who
suffix:semicolon
r_case
id|NFS4_ACL_WHO_OWNER
suffix:colon
r_return
id|who
op_eq
id|owner
suffix:semicolon
r_case
id|NFS4_ACL_WHO_GROUP
suffix:colon
r_return
id|who
op_eq
id|group
suffix:semicolon
r_case
id|NFS4_ACL_WHO_EVERYONE
suffix:colon
r_return
l_int|1
suffix:semicolon
r_default
suffix:colon
r_return
l_int|0
suffix:semicolon
)brace
)brace
DECL|variable|nfs4_acl_new
id|EXPORT_SYMBOL
c_func
(paren
id|nfs4_acl_new
)paren
suffix:semicolon
DECL|variable|nfs4_acl_free
id|EXPORT_SYMBOL
c_func
(paren
id|nfs4_acl_free
)paren
suffix:semicolon
DECL|variable|nfs4_acl_add_ace
id|EXPORT_SYMBOL
c_func
(paren
id|nfs4_acl_add_ace
)paren
suffix:semicolon
DECL|variable|nfs4_acl_get_whotype
id|EXPORT_SYMBOL
c_func
(paren
id|nfs4_acl_get_whotype
)paren
suffix:semicolon
DECL|variable|nfs4_acl_write_who
id|EXPORT_SYMBOL
c_func
(paren
id|nfs4_acl_write_who
)paren
suffix:semicolon
eof
