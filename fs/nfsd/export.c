DECL|macro|MSNFS
mdefine_line|#define MSNFS&t;/* HACK HACK */
multiline_comment|/*&n; * linux/fs/nfsd/export.c&n; *&n; * NFS exporting and validation.&n; *&n; * We maintain a list of clients, each of which has a list of&n; * exports. To export an fs to a given client, you first have&n; * to create the client entry with NFSCTL_ADDCLIENT, which&n; * creates a client control block and adds it to the hash&n; * table. Then, you call NFSCTL_EXPORT for each fs.&n; *&n; *&n; * Copyright (C) 1995, 1996 Olaf Kirch, &lt;okir@monad.swb.de&gt;&n; */
macro_line|#include &lt;linux/unistd.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/seq_file.h&gt;
macro_line|#include &lt;linux/rwsem.h&gt;
macro_line|#include &lt;linux/sunrpc/svc.h&gt;
macro_line|#include &lt;linux/nfsd/nfsd.h&gt;
macro_line|#include &lt;linux/nfsd/nfsfh.h&gt;
macro_line|#include &lt;linux/nfsd/syscall.h&gt;
macro_line|#include &lt;linux/lockd/bind.h&gt;
DECL|macro|NFSDDBG_FACILITY
mdefine_line|#define NFSDDBG_FACILITY&t;NFSDDBG_EXPORT
DECL|macro|NFSD_PARANOIA
mdefine_line|#define NFSD_PARANOIA 1
DECL|typedef|svc_client
r_typedef
r_struct
id|svc_client
id|svc_client
suffix:semicolon
DECL|typedef|svc_export
r_typedef
r_struct
id|svc_export
id|svc_export
suffix:semicolon
r_static
id|svc_export
op_star
id|exp_parent
c_func
(paren
id|svc_client
op_star
id|clp
comma
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|dentry
op_star
id|dentry
)paren
suffix:semicolon
r_static
id|svc_export
op_star
id|exp_child
c_func
(paren
id|svc_client
op_star
id|clp
comma
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|dentry
op_star
id|dentry
)paren
suffix:semicolon
r_static
r_void
id|exp_unexport_all
c_func
(paren
id|svc_client
op_star
id|clp
)paren
suffix:semicolon
r_static
r_void
id|exp_do_unexport
c_func
(paren
id|svc_export
op_star
id|unexp
)paren
suffix:semicolon
r_static
id|svc_client
op_star
id|exp_getclientbyname
c_func
(paren
r_char
op_star
id|name
)paren
suffix:semicolon
r_static
r_void
id|exp_freeclient
c_func
(paren
id|svc_client
op_star
id|clp
)paren
suffix:semicolon
r_static
r_void
id|exp_unhashclient
c_func
(paren
id|svc_client
op_star
id|clp
)paren
suffix:semicolon
r_static
r_int
id|exp_verify_string
c_func
(paren
r_char
op_star
id|cp
comma
r_int
id|max
)paren
suffix:semicolon
DECL|macro|CLIENT_HASHBITS
mdefine_line|#define CLIENT_HASHBITS&t;&t;6
DECL|macro|CLIENT_HASHMAX
mdefine_line|#define CLIENT_HASHMAX&t;&t;(1 &lt;&lt; CLIENT_HASHBITS)
DECL|macro|CLIENT_HASHMASK
mdefine_line|#define CLIENT_HASHMASK&t;&t;(CLIENT_HASHMAX - 1)
DECL|macro|CLIENT_HASH
mdefine_line|#define CLIENT_HASH(a) &bslash;&n;&t;&t;((((a)&gt;&gt;24) ^ ((a)&gt;&gt;16) ^ ((a)&gt;&gt;8) ^(a)) &amp; CLIENT_HASHMASK)
multiline_comment|/* XXX: is this adequate for 32bit kdev_t ? */
DECL|macro|EXPORT_HASH
mdefine_line|#define EXPORT_HASH(dev)&t;(minor(dev) &amp; (NFSCLNT_EXPMAX - 1))
DECL|macro|EXPORT_FSID_HASH
mdefine_line|#define EXPORT_FSID_HASH(fsid)&t;((fsid) &amp; (NFSCLNT_EXPMAX - 1))
DECL|struct|svc_clnthash
r_struct
id|svc_clnthash
(brace
DECL|member|h_next
r_struct
id|svc_clnthash
op_star
id|h_next
suffix:semicolon
DECL|member|h_addr
r_struct
id|in_addr
id|h_addr
suffix:semicolon
DECL|member|h_client
r_struct
id|svc_client
op_star
id|h_client
suffix:semicolon
)brace
suffix:semicolon
DECL|variable|clnt_hash
r_static
r_struct
id|svc_clnthash
op_star
id|clnt_hash
(braket
id|CLIENT_HASHMAX
)braket
suffix:semicolon
DECL|variable|clients
r_static
id|svc_client
op_star
id|clients
suffix:semicolon
multiline_comment|/*&n; * Find the client&squot;s export entry matching xdev/xino.&n; */
id|svc_export
op_star
DECL|function|exp_get
id|exp_get
c_func
(paren
id|svc_client
op_star
id|clp
comma
id|kdev_t
id|dev
comma
id|ino_t
id|ino
)paren
(brace
r_struct
id|list_head
op_star
id|head
comma
op_star
id|p
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|clp
)paren
r_return
l_int|NULL
suffix:semicolon
id|head
op_assign
op_amp
id|clp-&gt;cl_export
(braket
id|EXPORT_HASH
c_func
(paren
id|dev
)paren
)braket
suffix:semicolon
id|list_for_each
c_func
(paren
id|p
comma
id|head
)paren
(brace
id|svc_export
op_star
id|exp
op_assign
id|list_entry
c_func
(paren
id|p
comma
id|svc_export
comma
id|ex_hash
)paren
suffix:semicolon
r_if
c_cond
(paren
id|exp-&gt;ex_ino
op_eq
id|ino
op_logical_and
id|kdev_same
c_func
(paren
id|exp-&gt;ex_dev
comma
id|dev
)paren
)paren
r_return
id|exp
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; * Find the client&squot;s export entry matching fsid&n; */
id|svc_export
op_star
DECL|function|exp_get_fsid
id|exp_get_fsid
c_func
(paren
id|svc_client
op_star
id|clp
comma
r_int
id|fsid
)paren
(brace
r_struct
id|list_head
op_star
id|head
comma
op_star
id|p
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|clp
)paren
r_return
l_int|NULL
suffix:semicolon
id|head
op_assign
op_amp
id|clp-&gt;cl_expfsid
(braket
id|EXPORT_FSID_HASH
c_func
(paren
id|fsid
)paren
)braket
suffix:semicolon
id|list_for_each
c_func
(paren
id|p
comma
id|head
)paren
(brace
id|svc_export
op_star
id|exp
op_assign
id|list_entry
c_func
(paren
id|p
comma
id|svc_export
comma
id|ex_fsid_hash
)paren
suffix:semicolon
r_if
c_cond
(paren
id|exp-&gt;ex_fsid
op_eq
id|fsid
)paren
r_return
id|exp
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
id|svc_export
op_star
DECL|function|exp_get_by_name
id|exp_get_by_name
c_func
(paren
id|svc_client
op_star
id|clp
comma
r_struct
id|vfsmount
op_star
id|mnt
comma
r_struct
id|dentry
op_star
id|dentry
)paren
(brace
r_struct
id|list_head
op_star
id|head
comma
op_star
id|p
suffix:semicolon
r_int
id|hash
op_assign
id|EXPORT_HASH
c_func
(paren
id|mnt-&gt;mnt_sb-&gt;s_dev
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|clp
)paren
r_return
l_int|NULL
suffix:semicolon
id|head
op_assign
op_amp
id|clp-&gt;cl_export
(braket
id|hash
)braket
suffix:semicolon
id|list_for_each
c_func
(paren
id|p
comma
id|head
)paren
(brace
id|svc_export
op_star
id|exp
op_assign
id|list_entry
c_func
(paren
id|p
comma
id|svc_export
comma
id|ex_hash
)paren
suffix:semicolon
r_if
c_cond
(paren
id|exp-&gt;ex_dentry
op_eq
id|dentry
op_logical_and
id|exp-&gt;ex_mnt
op_eq
id|mnt
)paren
r_break
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; * Find the export entry for a given dentry.  &lt;gam3@acm.org&gt;&n; */
r_static
id|svc_export
op_star
DECL|function|exp_parent
id|exp_parent
c_func
(paren
id|svc_client
op_star
id|clp
comma
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|dentry
op_star
id|dentry
)paren
(brace
r_struct
id|list_head
op_star
id|head
op_assign
op_amp
id|clp-&gt;cl_export
(braket
id|EXPORT_HASH
c_func
(paren
id|sb-&gt;s_dev
)paren
)braket
suffix:semicolon
r_struct
id|list_head
op_star
id|p
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|dcache_lock
)paren
suffix:semicolon
id|list_for_each
c_func
(paren
id|p
comma
id|head
)paren
(brace
id|svc_export
op_star
id|exp
op_assign
id|list_entry
c_func
(paren
id|p
comma
id|svc_export
comma
id|ex_hash
)paren
suffix:semicolon
r_if
c_cond
(paren
id|is_subdir
c_func
(paren
id|dentry
comma
id|exp-&gt;ex_dentry
)paren
)paren
(brace
id|spin_unlock
c_func
(paren
op_amp
id|dcache_lock
)paren
suffix:semicolon
r_return
id|exp
suffix:semicolon
)brace
)brace
id|spin_unlock
c_func
(paren
op_amp
id|dcache_lock
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; * Find the child export entry for a given fs. This function is used&n; * only by the export syscall to keep the export tree consistent.&n; * &lt;gam3@acm.org&gt;&n; */
r_static
id|svc_export
op_star
DECL|function|exp_child
id|exp_child
c_func
(paren
id|svc_client
op_star
id|clp
comma
r_struct
id|super_block
op_star
id|sb
comma
r_struct
id|dentry
op_star
id|dentry
)paren
(brace
r_struct
id|list_head
op_star
id|head
op_assign
op_amp
id|clp-&gt;cl_export
(braket
id|EXPORT_HASH
c_func
(paren
id|sb-&gt;s_dev
)paren
)braket
suffix:semicolon
r_struct
id|list_head
op_star
id|p
suffix:semicolon
r_struct
id|dentry
op_star
id|ndentry
suffix:semicolon
id|spin_lock
c_func
(paren
op_amp
id|dcache_lock
)paren
suffix:semicolon
id|list_for_each
c_func
(paren
id|p
comma
id|head
)paren
(brace
id|svc_export
op_star
id|exp
op_assign
id|list_entry
c_func
(paren
id|p
comma
id|svc_export
comma
id|ex_hash
)paren
suffix:semicolon
id|ndentry
op_assign
id|exp-&gt;ex_dentry
suffix:semicolon
r_if
c_cond
(paren
id|ndentry
op_logical_and
id|is_subdir
c_func
(paren
id|ndentry-&gt;d_parent
comma
id|dentry
)paren
)paren
(brace
id|spin_unlock
c_func
(paren
op_amp
id|dcache_lock
)paren
suffix:semicolon
r_return
id|exp
suffix:semicolon
)brace
)brace
id|spin_unlock
c_func
(paren
op_amp
id|dcache_lock
)paren
suffix:semicolon
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* Update parent pointers of all exports */
DECL|function|exp_change_parents
r_static
r_void
id|exp_change_parents
c_func
(paren
id|svc_client
op_star
id|clp
comma
id|svc_export
op_star
id|old
comma
id|svc_export
op_star
r_new
)paren
(brace
r_struct
id|list_head
op_star
id|head
op_assign
op_amp
id|clp-&gt;cl_list
suffix:semicolon
r_struct
id|list_head
op_star
id|p
suffix:semicolon
id|list_for_each
c_func
(paren
id|p
comma
id|head
)paren
(brace
id|svc_export
op_star
id|exp
op_assign
id|list_entry
c_func
(paren
id|p
comma
id|svc_export
comma
id|ex_list
)paren
suffix:semicolon
r_if
c_cond
(paren
id|exp-&gt;ex_parent
op_eq
id|old
)paren
id|exp-&gt;ex_parent
op_assign
r_new
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * Hashtable locking. Write locks are placed only by user processes&n; * wanting to modify export information.&n; * Write locking only done in this file.  Read locking&n; * needed externally.&n; */
r_static
id|DECLARE_RWSEM
c_func
(paren
id|hash_sem
)paren
suffix:semicolon
r_void
DECL|function|exp_readlock
id|exp_readlock
c_func
(paren
r_void
)paren
(brace
id|down_read
c_func
(paren
op_amp
id|hash_sem
)paren
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|exp_writelock
id|exp_writelock
c_func
(paren
r_void
)paren
(brace
id|down_write
c_func
(paren
op_amp
id|hash_sem
)paren
suffix:semicolon
)brace
r_void
DECL|function|exp_readunlock
id|exp_readunlock
c_func
(paren
r_void
)paren
(brace
id|up_read
c_func
(paren
op_amp
id|hash_sem
)paren
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|exp_writeunlock
id|exp_writeunlock
c_func
(paren
r_void
)paren
(brace
id|up_write
c_func
(paren
op_amp
id|hash_sem
)paren
suffix:semicolon
)brace
DECL|function|exp_fsid_unhash
r_static
r_void
id|exp_fsid_unhash
c_func
(paren
r_struct
id|svc_export
op_star
id|exp
)paren
(brace
r_if
c_cond
(paren
(paren
id|exp-&gt;ex_flags
op_amp
id|NFSEXP_FSID
)paren
op_eq
l_int|0
)paren
r_return
suffix:semicolon
id|list_del_init
c_func
(paren
op_amp
id|exp-&gt;ex_fsid_hash
)paren
suffix:semicolon
)brace
DECL|function|exp_fsid_hash
r_static
r_void
id|exp_fsid_hash
c_func
(paren
r_struct
id|svc_client
op_star
id|clp
comma
r_struct
id|svc_export
op_star
id|exp
)paren
(brace
r_struct
id|list_head
op_star
id|head
suffix:semicolon
r_if
c_cond
(paren
(paren
id|exp-&gt;ex_flags
op_amp
id|NFSEXP_FSID
)paren
op_eq
l_int|0
)paren
r_return
suffix:semicolon
id|head
op_assign
id|clp-&gt;cl_expfsid
op_plus
id|EXPORT_FSID_HASH
c_func
(paren
id|exp-&gt;ex_fsid
)paren
suffix:semicolon
id|list_add
c_func
(paren
op_amp
id|exp-&gt;ex_fsid_hash
comma
id|head
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Export a file system.&n; */
r_int
DECL|function|exp_export
id|exp_export
c_func
(paren
r_struct
id|nfsctl_export
op_star
id|nxp
)paren
(brace
id|svc_client
op_star
id|clp
suffix:semicolon
id|svc_export
op_star
id|exp
op_assign
l_int|NULL
comma
op_star
id|parent
suffix:semicolon
id|svc_export
op_star
id|fsid_exp
suffix:semicolon
r_struct
id|nameidata
id|nd
suffix:semicolon
r_struct
id|inode
op_star
id|inode
op_assign
l_int|NULL
suffix:semicolon
r_int
id|err
suffix:semicolon
id|kdev_t
id|dev
suffix:semicolon
id|ino_t
id|ino
suffix:semicolon
multiline_comment|/* Consistency check */
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|exp_verify_string
c_func
(paren
id|nxp-&gt;ex_path
comma
id|NFS_MAXPATHLEN
)paren
op_logical_or
op_logical_neg
id|exp_verify_string
c_func
(paren
id|nxp-&gt;ex_client
comma
id|NFSCLNT_IDMAX
)paren
)paren
r_goto
id|out
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;exp_export called for %s:%s (%x/%ld fl %x).&bslash;n&quot;
comma
id|nxp-&gt;ex_client
comma
id|nxp-&gt;ex_path
comma
id|nxp-&gt;ex_dev
comma
(paren
r_int
)paren
id|nxp-&gt;ex_ino
comma
id|nxp-&gt;ex_flags
)paren
suffix:semicolon
multiline_comment|/* Try to lock the export table for update */
id|exp_writelock
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Look up client info */
r_if
c_cond
(paren
op_logical_neg
(paren
id|clp
op_assign
id|exp_getclientbyname
c_func
(paren
id|nxp-&gt;ex_client
)paren
)paren
)paren
r_goto
id|out_unlock
suffix:semicolon
multiline_comment|/* Look up the dentry */
id|err
op_assign
id|path_lookup
c_func
(paren
id|nxp-&gt;ex_path
comma
l_int|0
comma
op_amp
id|nd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|out_unlock
suffix:semicolon
id|inode
op_assign
id|nd.dentry-&gt;d_inode
suffix:semicolon
id|dev
op_assign
id|inode-&gt;i_dev
suffix:semicolon
id|ino
op_assign
id|inode-&gt;i_ino
suffix:semicolon
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
id|exp
op_assign
id|exp_get
c_func
(paren
id|clp
comma
id|dev
comma
id|ino
)paren
suffix:semicolon
multiline_comment|/* must make sure there wont be an ex_fsid clash */
r_if
c_cond
(paren
(paren
id|nxp-&gt;ex_flags
op_amp
id|NFSEXP_FSID
)paren
op_logical_and
(paren
id|fsid_exp
op_assign
id|exp_get_fsid
c_func
(paren
id|clp
comma
id|nxp-&gt;ex_dev
)paren
)paren
op_logical_and
id|fsid_exp
op_ne
id|exp
)paren
r_goto
id|finish
suffix:semicolon
r_if
c_cond
(paren
id|exp
op_ne
l_int|NULL
)paren
(brace
multiline_comment|/* just a flags/id/fsid update */
id|exp_fsid_unhash
c_func
(paren
id|exp
)paren
suffix:semicolon
id|exp-&gt;ex_flags
op_assign
id|nxp-&gt;ex_flags
suffix:semicolon
id|exp-&gt;ex_anon_uid
op_assign
id|nxp-&gt;ex_anon_uid
suffix:semicolon
id|exp-&gt;ex_anon_gid
op_assign
id|nxp-&gt;ex_anon_gid
suffix:semicolon
id|exp-&gt;ex_fsid
op_assign
id|nxp-&gt;ex_dev
suffix:semicolon
id|exp_fsid_hash
c_func
(paren
id|clp
comma
id|exp
)paren
suffix:semicolon
id|err
op_assign
l_int|0
suffix:semicolon
r_goto
id|finish
suffix:semicolon
)brace
multiline_comment|/* We currently export only dirs and regular files.&n;&t; * This is what umountd does.&n;&t; */
id|err
op_assign
op_minus
id|ENOTDIR
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|S_ISDIR
c_func
(paren
id|inode-&gt;i_mode
)paren
op_logical_and
op_logical_neg
id|S_ISREG
c_func
(paren
id|inode-&gt;i_mode
)paren
)paren
r_goto
id|finish
suffix:semicolon
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|inode-&gt;i_sb-&gt;s_type-&gt;fs_flags
op_amp
id|FS_REQUIRES_DEV
)paren
op_logical_or
(paren
id|inode-&gt;i_sb-&gt;s_op-&gt;read_inode
op_eq
l_int|NULL
op_logical_and
id|inode-&gt;i_sb-&gt;s_op-&gt;fh_to_dentry
op_eq
l_int|NULL
)paren
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;exp_export: export of invalid fs type.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|finish
suffix:semicolon
)brace
r_if
c_cond
(paren
(paren
id|parent
op_assign
id|exp_child
c_func
(paren
id|clp
comma
id|inode-&gt;i_sb
comma
id|nd.dentry
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;exp_export: export not valid (Rule 3).&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|finish
suffix:semicolon
)brace
multiline_comment|/* Is this is a sub-export, must be a proper subset of FS */
r_if
c_cond
(paren
(paren
id|parent
op_assign
id|exp_parent
c_func
(paren
id|clp
comma
id|inode-&gt;i_sb
comma
id|nd.dentry
)paren
)paren
op_ne
l_int|NULL
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;exp_export: sub-export not valid (Rule 2).&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|finish
suffix:semicolon
)brace
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|exp
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|exp
)paren
comma
id|GFP_USER
)paren
)paren
)paren
r_goto
id|finish
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;nfsd: created export entry %p for client %p&bslash;n&quot;
comma
id|exp
comma
id|clp
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|exp-&gt;ex_path
comma
id|nxp-&gt;ex_path
)paren
suffix:semicolon
id|exp-&gt;ex_client
op_assign
id|clp
suffix:semicolon
id|exp-&gt;ex_parent
op_assign
id|parent
suffix:semicolon
id|exp-&gt;ex_mnt
op_assign
id|mntget
c_func
(paren
id|nd.mnt
)paren
suffix:semicolon
id|exp-&gt;ex_dentry
op_assign
id|dget
c_func
(paren
id|nd.dentry
)paren
suffix:semicolon
id|exp-&gt;ex_flags
op_assign
id|nxp-&gt;ex_flags
suffix:semicolon
id|exp-&gt;ex_dev
op_assign
id|dev
suffix:semicolon
id|exp-&gt;ex_ino
op_assign
id|ino
suffix:semicolon
id|exp-&gt;ex_anon_uid
op_assign
id|nxp-&gt;ex_anon_uid
suffix:semicolon
id|exp-&gt;ex_anon_gid
op_assign
id|nxp-&gt;ex_anon_gid
suffix:semicolon
id|exp-&gt;ex_fsid
op_assign
id|nxp-&gt;ex_dev
suffix:semicolon
multiline_comment|/* Update parent pointers of all exports */
r_if
c_cond
(paren
id|parent
)paren
id|exp_change_parents
c_func
(paren
id|clp
comma
id|parent
comma
id|exp
)paren
suffix:semicolon
id|list_add
c_func
(paren
op_amp
id|exp-&gt;ex_hash
comma
id|clp-&gt;cl_export
op_plus
id|EXPORT_HASH
c_func
(paren
id|dev
)paren
)paren
suffix:semicolon
id|list_add_tail
c_func
(paren
op_amp
id|exp-&gt;ex_list
comma
op_amp
id|clp-&gt;cl_list
)paren
suffix:semicolon
id|exp_fsid_hash
c_func
(paren
id|clp
comma
id|exp
)paren
suffix:semicolon
id|err
op_assign
l_int|0
suffix:semicolon
id|finish
suffix:colon
id|path_release
c_func
(paren
op_amp
id|nd
)paren
suffix:semicolon
id|out_unlock
suffix:colon
id|exp_writeunlock
c_func
(paren
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*&n; * Unexport a file system. The export entry has already&n; * been removed from the client&squot;s list of exported fs&squot;s.&n; */
r_static
r_void
DECL|function|exp_do_unexport
id|exp_do_unexport
c_func
(paren
id|svc_export
op_star
id|unexp
)paren
(brace
r_struct
id|dentry
op_star
id|dentry
suffix:semicolon
r_struct
id|vfsmount
op_star
id|mnt
suffix:semicolon
r_struct
id|inode
op_star
id|inode
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|unexp-&gt;ex_list
)paren
suffix:semicolon
id|list_del
c_func
(paren
op_amp
id|unexp-&gt;ex_hash
)paren
suffix:semicolon
id|exp_fsid_unhash
c_func
(paren
id|unexp
)paren
suffix:semicolon
multiline_comment|/* Update parent pointers. */
id|exp_change_parents
c_func
(paren
id|unexp-&gt;ex_client
comma
id|unexp
comma
id|unexp-&gt;ex_parent
)paren
suffix:semicolon
id|dentry
op_assign
id|unexp-&gt;ex_dentry
suffix:semicolon
id|mnt
op_assign
id|unexp-&gt;ex_mnt
suffix:semicolon
id|inode
op_assign
id|dentry-&gt;d_inode
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|kdev_same
c_func
(paren
id|unexp-&gt;ex_dev
comma
id|inode-&gt;i_dev
)paren
op_logical_or
id|unexp-&gt;ex_ino
op_ne
id|inode-&gt;i_ino
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;nfsd: bad dentry in unexport!&bslash;n&quot;
)paren
suffix:semicolon
id|dput
c_func
(paren
id|dentry
)paren
suffix:semicolon
id|mntput
c_func
(paren
id|mnt
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|unexp
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Revoke all exports for a given client.&n; */
r_static
r_void
DECL|function|exp_unexport_all
id|exp_unexport_all
c_func
(paren
id|svc_client
op_star
id|clp
)paren
(brace
r_struct
id|list_head
op_star
id|p
op_assign
op_amp
id|clp-&gt;cl_list
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;unexporting all fs&squot;s for clnt %p&bslash;n&quot;
comma
id|clp
)paren
suffix:semicolon
r_while
c_loop
(paren
op_logical_neg
id|list_empty
c_func
(paren
id|p
)paren
)paren
(brace
id|svc_export
op_star
id|exp
op_assign
id|list_entry
c_func
(paren
id|p-&gt;next
comma
id|svc_export
comma
id|ex_list
)paren
suffix:semicolon
id|exp_do_unexport
c_func
(paren
id|exp
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * unexport syscall.&n; */
r_int
DECL|function|exp_unexport
id|exp_unexport
c_func
(paren
r_struct
id|nfsctl_export
op_star
id|nxp
)paren
(brace
id|svc_client
op_star
id|clp
suffix:semicolon
r_int
id|err
suffix:semicolon
multiline_comment|/* Consistency check */
r_if
c_cond
(paren
op_logical_neg
id|exp_verify_string
c_func
(paren
id|nxp-&gt;ex_client
comma
id|NFSCLNT_IDMAX
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|exp_writelock
c_func
(paren
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
id|clp
op_assign
id|exp_getclientbyname
c_func
(paren
id|nxp-&gt;ex_client
)paren
suffix:semicolon
r_if
c_cond
(paren
id|clp
)paren
(brace
id|kdev_t
id|ex_dev
op_assign
id|to_kdev_t
c_func
(paren
id|nxp-&gt;ex_dev
)paren
suffix:semicolon
id|svc_export
op_star
id|exp
op_assign
id|exp_get
c_func
(paren
id|clp
comma
id|ex_dev
comma
id|nxp-&gt;ex_ino
)paren
suffix:semicolon
r_if
c_cond
(paren
id|exp
)paren
(brace
id|exp_do_unexport
c_func
(paren
id|exp
)paren
suffix:semicolon
id|err
op_assign
l_int|0
suffix:semicolon
)brace
)brace
id|exp_writeunlock
c_func
(paren
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*&n; * Obtain the root fh on behalf of a client.&n; * This could be done in user space, but I feel that it adds some safety&n; * since its harder to fool a kernel module than a user space program.&n; */
r_int
DECL|function|exp_rootfh
id|exp_rootfh
c_func
(paren
r_struct
id|svc_client
op_star
id|clp
comma
r_char
op_star
id|path
comma
r_struct
id|knfsd_fh
op_star
id|f
comma
r_int
id|maxsize
)paren
(brace
r_struct
id|svc_export
op_star
id|exp
suffix:semicolon
r_struct
id|nameidata
id|nd
suffix:semicolon
r_struct
id|inode
op_star
id|inode
suffix:semicolon
r_struct
id|svc_fh
id|fh
suffix:semicolon
r_int
id|err
suffix:semicolon
id|err
op_assign
op_minus
id|EPERM
suffix:semicolon
multiline_comment|/* NB: we probably ought to check that it&squot;s NUL-terminated */
r_if
c_cond
(paren
id|path_lookup
c_func
(paren
id|path
comma
l_int|0
comma
op_amp
id|nd
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;nfsd: exp_rootfh path not found %s&quot;
comma
id|path
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|inode
op_assign
id|nd.dentry-&gt;d_inode
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;nfsd: exp_rootfh(%s [%p] %s:%s/%ld)&bslash;n&quot;
comma
id|path
comma
id|nd.dentry
comma
id|clp-&gt;cl_ident
comma
id|inode-&gt;i_sb-&gt;s_id
comma
id|inode-&gt;i_ino
)paren
suffix:semicolon
id|exp
op_assign
id|exp_parent
c_func
(paren
id|clp
comma
id|inode-&gt;i_sb
comma
id|nd.dentry
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|exp
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;nfsd: exp_rootfh export not found.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * fh must be initialized before calling fh_compose&n;&t; */
id|fh_init
c_func
(paren
op_amp
id|fh
comma
id|maxsize
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fh_compose
c_func
(paren
op_amp
id|fh
comma
id|exp
comma
id|dget
c_func
(paren
id|nd.dentry
)paren
comma
l_int|NULL
)paren
)paren
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_else
id|err
op_assign
l_int|0
suffix:semicolon
id|memcpy
c_func
(paren
id|f
comma
op_amp
id|fh.fh_handle
comma
r_sizeof
(paren
r_struct
id|knfsd_fh
)paren
)paren
suffix:semicolon
id|fh_put
c_func
(paren
op_amp
id|fh
)paren
suffix:semicolon
id|out
suffix:colon
id|path_release
c_func
(paren
op_amp
id|nd
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*&n; * Find a valid client given an inet address. We always move the most&n; * recently used client to the front of the hash chain to speed up&n; * future lookups.&n; * Locking against other processes is the responsibility of the caller.&n; */
r_struct
id|svc_client
op_star
DECL|function|exp_getclient
id|exp_getclient
c_func
(paren
r_struct
id|sockaddr_in
op_star
id|sin
)paren
(brace
r_struct
id|svc_clnthash
op_star
op_star
id|hp
comma
op_star
op_star
id|head
comma
op_star
id|tmp
suffix:semicolon
r_int
r_int
id|addr
op_assign
id|sin-&gt;sin_addr.s_addr
suffix:semicolon
id|head
op_assign
op_amp
id|clnt_hash
(braket
id|CLIENT_HASH
c_func
(paren
id|addr
)paren
)braket
suffix:semicolon
r_for
c_loop
(paren
id|hp
op_assign
id|head
suffix:semicolon
(paren
id|tmp
op_assign
op_star
id|hp
)paren
op_ne
l_int|NULL
suffix:semicolon
id|hp
op_assign
op_amp
(paren
id|tmp-&gt;h_next
)paren
)paren
(brace
r_if
c_cond
(paren
id|tmp-&gt;h_addr.s_addr
op_eq
id|addr
)paren
(brace
macro_line|#if 0
multiline_comment|/* If we really want to do this, we need a spin&n;lock to protect against multiple access (as we only&n;have an exp_readlock) and need to protect&n;the code in e_show() that walks this list too.&n;*/
multiline_comment|/* Move client to the front */
r_if
c_cond
(paren
id|head
op_ne
id|hp
)paren
(brace
op_star
id|hp
op_assign
id|tmp-&gt;h_next
suffix:semicolon
id|tmp-&gt;h_next
op_assign
op_star
id|head
suffix:semicolon
op_star
id|head
op_assign
id|tmp
suffix:semicolon
)brace
macro_line|#endif
r_return
id|tmp-&gt;h_client
suffix:semicolon
)brace
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; * Find a client given its identifier.&n; */
r_static
id|svc_client
op_star
DECL|function|exp_getclientbyname
id|exp_getclientbyname
c_func
(paren
r_char
op_star
id|ident
)paren
(brace
id|svc_client
op_star
id|clp
suffix:semicolon
r_for
c_loop
(paren
id|clp
op_assign
id|clients
suffix:semicolon
id|clp
suffix:semicolon
id|clp
op_assign
id|clp-&gt;cl_next
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|clp-&gt;cl_ident
comma
id|ident
)paren
)paren
r_return
id|clp
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/* Iterator */
DECL|function|e_start
r_static
r_void
op_star
id|e_start
c_func
(paren
r_struct
id|seq_file
op_star
id|m
comma
id|loff_t
op_star
id|pos
)paren
(brace
id|loff_t
id|n
op_assign
op_star
id|pos
suffix:semicolon
r_int
id|client
comma
id|export
suffix:semicolon
id|svc_client
op_star
id|clp
suffix:semicolon
r_struct
id|list_head
op_star
id|p
suffix:semicolon
id|exp_readlock
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|n
op_decrement
)paren
r_return
(paren
r_void
op_star
)paren
l_int|1
suffix:semicolon
id|client
op_assign
id|n
op_rshift
l_int|32
suffix:semicolon
id|export
op_assign
id|n
op_amp
(paren
(paren
l_int|1LL
op_lshift
l_int|32
)paren
op_minus
l_int|1
)paren
suffix:semicolon
r_for
c_loop
(paren
id|clp
op_assign
id|clients
suffix:semicolon
id|client
op_logical_and
id|clp
suffix:semicolon
id|clp
op_assign
id|clp-&gt;cl_next
comma
id|client
op_decrement
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|clp
)paren
r_return
l_int|NULL
suffix:semicolon
id|list_for_each
c_func
(paren
id|p
comma
op_amp
id|clp-&gt;cl_list
)paren
r_if
c_cond
(paren
op_logical_neg
id|export
op_decrement
)paren
r_return
id|list_entry
c_func
(paren
id|p
comma
id|svc_export
comma
id|ex_list
)paren
suffix:semicolon
id|n
op_and_assign
op_complement
(paren
(paren
l_int|1LL
op_lshift
l_int|32
)paren
op_minus
l_int|1
)paren
suffix:semicolon
r_do
(brace
id|clp
op_assign
id|clp-&gt;cl_next
suffix:semicolon
id|n
op_add_assign
l_int|1LL
op_lshift
l_int|32
suffix:semicolon
)brace
r_while
c_loop
(paren
id|clp
op_logical_and
id|list_empty
c_func
(paren
op_amp
id|clp-&gt;cl_list
)paren
)paren
(brace
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|clp
)paren
r_return
l_int|NULL
suffix:semicolon
op_star
id|pos
op_assign
id|n
op_plus
l_int|1
suffix:semicolon
r_return
id|list_entry
c_func
(paren
id|clp-&gt;cl_list.next
comma
id|svc_export
comma
id|ex_list
)paren
suffix:semicolon
)brace
DECL|function|e_next
r_static
r_void
op_star
id|e_next
c_func
(paren
r_struct
id|seq_file
op_star
id|m
comma
r_void
op_star
id|p
comma
id|loff_t
op_star
id|pos
)paren
(brace
id|svc_export
op_star
id|exp
op_assign
id|p
suffix:semicolon
id|svc_client
op_star
id|clp
suffix:semicolon
r_if
c_cond
(paren
id|p
op_eq
(paren
r_void
op_star
)paren
l_int|1
)paren
id|clp
op_assign
id|clients
suffix:semicolon
r_else
r_if
c_cond
(paren
id|exp-&gt;ex_list.next
op_eq
op_amp
id|exp-&gt;ex_client-&gt;cl_list
)paren
(brace
id|clp
op_assign
id|exp-&gt;ex_client-&gt;cl_next
suffix:semicolon
op_star
id|pos
op_add_assign
l_int|1LL
op_lshift
l_int|32
suffix:semicolon
)brace
r_else
(brace
op_increment
op_star
id|pos
suffix:semicolon
r_return
id|list_entry
c_func
(paren
id|exp-&gt;ex_list.next
comma
id|svc_export
comma
id|ex_list
)paren
suffix:semicolon
)brace
op_star
id|pos
op_and_assign
op_complement
(paren
(paren
l_int|1LL
op_lshift
l_int|32
)paren
op_minus
l_int|1
)paren
suffix:semicolon
r_while
c_loop
(paren
id|clp
op_logical_and
id|list_empty
c_func
(paren
op_amp
id|clp-&gt;cl_list
)paren
)paren
(brace
id|clp
op_assign
id|clp-&gt;cl_next
suffix:semicolon
op_star
id|pos
op_add_assign
l_int|1LL
op_lshift
l_int|32
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|clp
)paren
r_return
l_int|NULL
suffix:semicolon
op_increment
op_star
id|pos
suffix:semicolon
r_return
id|list_entry
c_func
(paren
id|clp-&gt;cl_list.next
comma
id|svc_export
comma
id|ex_list
)paren
suffix:semicolon
)brace
DECL|function|e_stop
r_static
r_void
id|e_stop
c_func
(paren
r_struct
id|seq_file
op_star
id|m
comma
r_void
op_star
id|p
)paren
(brace
id|exp_readunlock
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|struct|flags
r_struct
id|flags
(brace
DECL|member|flag
r_int
id|flag
suffix:semicolon
DECL|member|name
r_char
op_star
id|name
(braket
l_int|2
)braket
suffix:semicolon
DECL|variable|expflags
)brace
id|expflags
(braket
)braket
op_assign
(brace
(brace
id|NFSEXP_READONLY
comma
(brace
l_string|&quot;ro&quot;
comma
l_string|&quot;rw&quot;
)brace
)brace
comma
(brace
id|NFSEXP_INSECURE_PORT
comma
(brace
l_string|&quot;insecure&quot;
comma
l_string|&quot;&quot;
)brace
)brace
comma
(brace
id|NFSEXP_ROOTSQUASH
comma
(brace
l_string|&quot;root_squash&quot;
comma
l_string|&quot;no_root_squash&quot;
)brace
)brace
comma
(brace
id|NFSEXP_ALLSQUASH
comma
(brace
l_string|&quot;all_squash&quot;
comma
l_string|&quot;&quot;
)brace
)brace
comma
(brace
id|NFSEXP_ASYNC
comma
(brace
l_string|&quot;async&quot;
comma
l_string|&quot;sync&quot;
)brace
)brace
comma
(brace
id|NFSEXP_GATHERED_WRITES
comma
(brace
l_string|&quot;wdelay&quot;
comma
l_string|&quot;no_wdelay&quot;
)brace
)brace
comma
(brace
id|NFSEXP_UIDMAP
comma
(brace
l_string|&quot;uidmap&quot;
comma
l_string|&quot;&quot;
)brace
)brace
comma
(brace
id|NFSEXP_KERBEROS
comma
(brace
l_string|&quot;kerberos&quot;
comma
l_string|&quot;&quot;
)brace
)brace
comma
(brace
id|NFSEXP_SUNSECURE
comma
(brace
l_string|&quot;sunsecure&quot;
comma
l_string|&quot;&quot;
)brace
)brace
comma
(brace
id|NFSEXP_CROSSMNT
comma
(brace
l_string|&quot;nohide&quot;
comma
l_string|&quot;&quot;
)brace
)brace
comma
(brace
id|NFSEXP_NOSUBTREECHECK
comma
(brace
l_string|&quot;no_subtree_check&quot;
comma
l_string|&quot;&quot;
)brace
)brace
comma
(brace
id|NFSEXP_NOAUTHNLM
comma
(brace
l_string|&quot;insecure_locks&quot;
comma
l_string|&quot;&quot;
)brace
)brace
comma
macro_line|#ifdef MSNFS
(brace
id|NFSEXP_MSNFS
comma
(brace
l_string|&quot;msnfs&quot;
comma
l_string|&quot;&quot;
)brace
)brace
comma
macro_line|#endif
(brace
l_int|0
comma
(brace
l_string|&quot;&quot;
comma
l_string|&quot;&quot;
)brace
)brace
)brace
suffix:semicolon
DECL|function|exp_flags
r_static
r_void
id|exp_flags
c_func
(paren
r_struct
id|seq_file
op_star
id|m
comma
r_int
id|flag
comma
r_int
id|fsid
)paren
(brace
r_int
id|first
op_assign
l_int|0
suffix:semicolon
r_struct
id|flags
op_star
id|flg
suffix:semicolon
r_for
c_loop
(paren
id|flg
op_assign
id|expflags
suffix:semicolon
id|flg-&gt;flag
suffix:semicolon
id|flg
op_increment
)paren
(brace
r_int
id|state
op_assign
(paren
id|flg-&gt;flag
op_amp
id|flag
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_star
id|flg-&gt;name
(braket
id|state
)braket
)paren
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;%s%s&quot;
comma
id|first
op_increment
ques
c_cond
l_string|&quot;,&quot;
suffix:colon
l_string|&quot;&quot;
comma
id|flg-&gt;name
(braket
id|state
)braket
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|flag
op_amp
id|NFSEXP_FSID
)paren
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;%sfsid=%d&quot;
comma
id|first
op_increment
ques
c_cond
l_string|&quot;,&quot;
suffix:colon
l_string|&quot;&quot;
comma
id|fsid
)paren
suffix:semicolon
)brace
DECL|function|mangle
r_static
r_inline
r_void
id|mangle
c_func
(paren
r_struct
id|seq_file
op_star
id|m
comma
r_const
r_char
op_star
id|s
)paren
(brace
id|seq_escape
c_func
(paren
id|m
comma
id|s
comma
l_string|&quot; &bslash;t&bslash;n&bslash;&bslash;&quot;
)paren
suffix:semicolon
)brace
DECL|function|e_show
r_static
r_int
id|e_show
c_func
(paren
r_struct
id|seq_file
op_star
id|m
comma
r_void
op_star
id|p
)paren
(brace
r_struct
id|svc_export
op_star
id|exp
op_assign
id|p
suffix:semicolon
r_struct
id|svc_client
op_star
id|clp
suffix:semicolon
r_int
id|j
comma
id|first
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|p
op_eq
(paren
r_void
op_star
)paren
l_int|1
)paren
(brace
id|seq_puts
c_func
(paren
id|m
comma
l_string|&quot;# Version 1.1&bslash;n&quot;
)paren
suffix:semicolon
id|seq_puts
c_func
(paren
id|m
comma
l_string|&quot;# Path Client(Flags) # IPs&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|clp
op_assign
id|exp-&gt;ex_client
suffix:semicolon
id|mangle
c_func
(paren
id|m
comma
id|exp-&gt;ex_path
)paren
suffix:semicolon
id|seq_putc
c_func
(paren
id|m
comma
l_char|&squot;&bslash;t&squot;
)paren
suffix:semicolon
id|mangle
c_func
(paren
id|m
comma
id|clp-&gt;cl_ident
)paren
suffix:semicolon
id|seq_putc
c_func
(paren
id|m
comma
l_char|&squot;(&squot;
)paren
suffix:semicolon
id|exp_flags
c_func
(paren
id|m
comma
id|exp-&gt;ex_flags
comma
id|exp-&gt;ex_fsid
)paren
suffix:semicolon
id|seq_puts
c_func
(paren
id|m
comma
l_string|&quot;) # &quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|j
op_assign
l_int|0
suffix:semicolon
id|j
OL
id|clp-&gt;cl_naddr
suffix:semicolon
id|j
op_increment
)paren
(brace
r_struct
id|svc_clnthash
op_star
op_star
id|hp
comma
op_star
op_star
id|head
comma
op_star
id|tmp
suffix:semicolon
r_struct
id|in_addr
id|addr
op_assign
id|clp-&gt;cl_addr
(braket
id|j
)braket
suffix:semicolon
id|head
op_assign
op_amp
id|clnt_hash
(braket
id|CLIENT_HASH
c_func
(paren
id|addr.s_addr
)paren
)braket
suffix:semicolon
r_for
c_loop
(paren
id|hp
op_assign
id|head
suffix:semicolon
(paren
id|tmp
op_assign
op_star
id|hp
)paren
op_ne
l_int|NULL
suffix:semicolon
id|hp
op_assign
op_amp
(paren
id|tmp-&gt;h_next
)paren
)paren
(brace
r_if
c_cond
(paren
id|tmp-&gt;h_addr.s_addr
op_eq
id|addr.s_addr
)paren
r_break
suffix:semicolon
)brace
r_if
c_cond
(paren
id|tmp
)paren
(brace
r_if
c_cond
(paren
id|first
op_increment
)paren
id|seq_putc
c_func
(paren
id|m
comma
l_char|&squot; &squot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmp-&gt;h_client
op_ne
id|clp
)paren
id|seq_putc
c_func
(paren
id|m
comma
l_char|&squot;(&squot;
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;%d.%d.%d.%d&quot;
comma
id|htonl
c_func
(paren
id|addr.s_addr
)paren
op_rshift
l_int|24
op_amp
l_int|0xff
comma
id|htonl
c_func
(paren
id|addr.s_addr
)paren
op_rshift
l_int|16
op_amp
l_int|0xff
comma
id|htonl
c_func
(paren
id|addr.s_addr
)paren
op_rshift
l_int|8
op_amp
l_int|0xff
comma
id|htonl
c_func
(paren
id|addr.s_addr
)paren
op_rshift
l_int|0
op_amp
l_int|0xff
)paren
suffix:semicolon
r_if
c_cond
(paren
id|tmp-&gt;h_client
op_ne
id|clp
)paren
id|seq_putc
c_func
(paren
id|m
comma
l_char|&squot;)&squot;
)paren
suffix:semicolon
)brace
)brace
id|seq_putc
c_func
(paren
id|m
comma
l_char|&squot;&bslash;n&squot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|nfs_exports_op
r_struct
id|seq_operations
id|nfs_exports_op
op_assign
(brace
id|start
suffix:colon
id|e_start
comma
id|next
suffix:colon
id|e_next
comma
id|stop
suffix:colon
id|e_stop
comma
id|show
suffix:colon
id|e_show
comma
)brace
suffix:semicolon
multiline_comment|/*&n; * Add or modify a client.&n; * Change requests may involve the list of host addresses. The list of&n; * exports and possibly existing uid maps are left untouched.&n; */
r_int
DECL|function|exp_addclient
id|exp_addclient
c_func
(paren
r_struct
id|nfsctl_client
op_star
id|ncp
)paren
(brace
r_struct
id|svc_clnthash
op_star
id|ch
(braket
id|NFSCLNT_ADDRMAX
)braket
suffix:semicolon
id|svc_client
op_star
id|clp
suffix:semicolon
r_int
id|i
comma
id|err
comma
id|change
op_assign
l_int|0
comma
id|ilen
suffix:semicolon
multiline_comment|/* First, consistency check. */
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|ilen
op_assign
id|exp_verify_string
c_func
(paren
id|ncp-&gt;cl_ident
comma
id|NFSCLNT_IDMAX
)paren
)paren
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|ncp-&gt;cl_naddr
OG
id|NFSCLNT_ADDRMAX
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* Lock the hashtable */
id|exp_writelock
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* First check if this is a change request for a client. */
r_for
c_loop
(paren
id|clp
op_assign
id|clients
suffix:semicolon
id|clp
suffix:semicolon
id|clp
op_assign
id|clp-&gt;cl_next
)paren
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|clp-&gt;cl_ident
comma
id|ncp-&gt;cl_ident
)paren
)paren
r_break
suffix:semicolon
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
id|clp
)paren
(brace
id|change
op_assign
l_int|1
suffix:semicolon
)brace
r_else
(brace
r_if
c_cond
(paren
op_logical_neg
(paren
id|clp
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|clp
)paren
comma
id|GFP_KERNEL
)paren
)paren
)paren
r_goto
id|out_unlock
suffix:semicolon
id|memset
c_func
(paren
id|clp
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|clp
)paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|NFSCLNT_EXPMAX
suffix:semicolon
id|i
op_increment
)paren
(brace
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|clp-&gt;cl_export
(braket
id|i
)braket
)paren
suffix:semicolon
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|clp-&gt;cl_expfsid
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
id|INIT_LIST_HEAD
c_func
(paren
op_amp
id|clp-&gt;cl_list
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;created client %s (%p)&bslash;n&quot;
comma
id|ncp-&gt;cl_ident
comma
id|clp
)paren
suffix:semicolon
id|strcpy
c_func
(paren
id|clp-&gt;cl_ident
comma
id|ncp-&gt;cl_ident
)paren
suffix:semicolon
id|clp-&gt;cl_idlen
op_assign
id|ilen
suffix:semicolon
)brace
multiline_comment|/* Allocate hash buckets */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ncp-&gt;cl_naddr
suffix:semicolon
id|i
op_increment
)paren
(brace
id|ch
(braket
id|i
)braket
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
r_struct
id|svc_clnthash
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|ch
(braket
id|i
)braket
)paren
(brace
r_while
c_loop
(paren
id|i
op_decrement
)paren
id|kfree
c_func
(paren
id|ch
(braket
id|i
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|change
)paren
id|kfree
c_func
(paren
id|clp
)paren
suffix:semicolon
r_goto
id|out_unlock
suffix:semicolon
)brace
)brace
multiline_comment|/* Copy addresses. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ncp-&gt;cl_naddr
suffix:semicolon
id|i
op_increment
)paren
(brace
id|clp-&gt;cl_addr
(braket
id|i
)braket
op_assign
id|ncp-&gt;cl_addrlist
(braket
id|i
)braket
suffix:semicolon
)brace
id|clp-&gt;cl_naddr
op_assign
id|ncp-&gt;cl_naddr
suffix:semicolon
multiline_comment|/* Remove old client hash entries. */
r_if
c_cond
(paren
id|change
)paren
id|exp_unhashclient
c_func
(paren
id|clp
)paren
suffix:semicolon
multiline_comment|/* Insert client into hashtable. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ncp-&gt;cl_naddr
suffix:semicolon
id|i
op_increment
)paren
(brace
r_struct
id|in_addr
id|addr
op_assign
id|clp-&gt;cl_addr
(braket
id|i
)braket
suffix:semicolon
r_int
id|hash
suffix:semicolon
id|hash
op_assign
id|CLIENT_HASH
c_func
(paren
id|addr.s_addr
)paren
suffix:semicolon
id|ch
(braket
id|i
)braket
op_member_access_from_pointer
id|h_client
op_assign
id|clp
suffix:semicolon
id|ch
(braket
id|i
)braket
op_member_access_from_pointer
id|h_addr
op_assign
id|addr
suffix:semicolon
id|ch
(braket
id|i
)braket
op_member_access_from_pointer
id|h_next
op_assign
id|clnt_hash
(braket
id|hash
)braket
suffix:semicolon
id|clnt_hash
(braket
id|hash
)braket
op_assign
id|ch
(braket
id|i
)braket
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|change
)paren
(brace
id|clp-&gt;cl_next
op_assign
id|clients
suffix:semicolon
id|clients
op_assign
id|clp
suffix:semicolon
)brace
id|err
op_assign
l_int|0
suffix:semicolon
id|out_unlock
suffix:colon
id|exp_writeunlock
c_func
(paren
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*&n; * Delete a client given an identifier.&n; */
r_int
DECL|function|exp_delclient
id|exp_delclient
c_func
(paren
r_struct
id|nfsctl_client
op_star
id|ncp
)paren
(brace
id|svc_client
op_star
op_star
id|clpp
comma
op_star
id|clp
suffix:semicolon
r_int
id|err
suffix:semicolon
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|exp_verify_string
c_func
(paren
id|ncp-&gt;cl_ident
comma
id|NFSCLNT_IDMAX
)paren
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* Lock the hashtable */
id|exp_writelock
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|clpp
op_assign
op_amp
id|clients
suffix:semicolon
(paren
id|clp
op_assign
op_star
id|clpp
)paren
suffix:semicolon
id|clpp
op_assign
op_amp
(paren
id|clp-&gt;cl_next
)paren
)paren
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|ncp-&gt;cl_ident
comma
id|clp-&gt;cl_ident
)paren
)paren
r_break
suffix:semicolon
r_if
c_cond
(paren
id|clp
)paren
(brace
op_star
id|clpp
op_assign
id|clp-&gt;cl_next
suffix:semicolon
id|exp_freeclient
c_func
(paren
id|clp
)paren
suffix:semicolon
id|err
op_assign
l_int|0
suffix:semicolon
)brace
id|exp_writeunlock
c_func
(paren
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*&n; * Free a client. The caller has already removed it from the client list.&n; */
r_static
r_void
DECL|function|exp_freeclient
id|exp_freeclient
c_func
(paren
id|svc_client
op_star
id|clp
)paren
(brace
id|exp_unhashclient
c_func
(paren
id|clp
)paren
suffix:semicolon
multiline_comment|/* umap_free(&amp;(clp-&gt;cl_umap)); */
id|exp_unexport_all
c_func
(paren
id|clp
)paren
suffix:semicolon
id|nfsd_lockd_unexport
c_func
(paren
id|clp
)paren
suffix:semicolon
id|kfree
(paren
id|clp
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Remove client from hashtable. We first collect all hashtable&n; * entries and free them in one go.&n; * The hash table must be writelocked by the caller.&n; */
r_static
r_void
DECL|function|exp_unhashclient
id|exp_unhashclient
c_func
(paren
id|svc_client
op_star
id|clp
)paren
(brace
r_struct
id|svc_clnthash
op_star
op_star
id|hpp
comma
op_star
id|hp
comma
op_star
id|ch
(braket
id|NFSCLNT_ADDRMAX
)braket
suffix:semicolon
r_int
id|i
comma
id|count
comma
id|err
suffix:semicolon
id|again
suffix:colon
id|err
op_assign
l_int|0
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
comma
id|count
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|CLIENT_HASHMAX
op_logical_and
op_logical_neg
id|err
suffix:semicolon
id|i
op_increment
)paren
(brace
id|hpp
op_assign
id|clnt_hash
op_plus
id|i
suffix:semicolon
r_while
c_loop
(paren
(paren
id|hp
op_assign
op_star
id|hpp
)paren
op_logical_and
op_logical_neg
id|err
)paren
(brace
r_if
c_cond
(paren
id|hp-&gt;h_client
op_eq
id|clp
)paren
(brace
op_star
id|hpp
op_assign
id|hp-&gt;h_next
suffix:semicolon
id|ch
(braket
id|count
op_increment
)braket
op_assign
id|hp
suffix:semicolon
id|err
op_assign
(paren
id|count
op_ge
id|NFSCLNT_ADDRMAX
)paren
suffix:semicolon
)brace
r_else
(brace
id|hpp
op_assign
op_amp
(paren
id|hp-&gt;h_next
)paren
suffix:semicolon
)brace
)brace
)brace
r_if
c_cond
(paren
id|count
op_ne
id|clp-&gt;cl_naddr
)paren
id|printk
c_func
(paren
id|KERN_WARNING
l_string|&quot;nfsd: bad address count in freeclient!&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|again
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|count
suffix:semicolon
id|i
op_increment
)paren
id|kfree
(paren
id|ch
(braket
id|i
)braket
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Lockd is shutting down and tells us to unregister all clients&n; */
r_void
DECL|function|exp_nlmdetach
id|exp_nlmdetach
c_func
(paren
r_void
)paren
(brace
r_struct
id|svc_client
op_star
id|clp
suffix:semicolon
r_for
c_loop
(paren
id|clp
op_assign
id|clients
suffix:semicolon
id|clp
suffix:semicolon
id|clp
op_assign
id|clp-&gt;cl_next
)paren
id|nfsd_lockd_unexport
c_func
(paren
id|clp
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Verify that string is non-empty and does not exceed max length.&n; */
r_static
r_int
DECL|function|exp_verify_string
id|exp_verify_string
c_func
(paren
r_char
op_star
id|cp
comma
r_int
id|max
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|max
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
op_logical_neg
id|cp
(braket
id|i
)braket
)paren
r_return
id|i
suffix:semicolon
id|cp
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;nfsd: couldn&squot;t validate string %s&bslash;n&quot;
comma
id|cp
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Initialize the exports module.&n; */
r_void
DECL|function|nfsd_export_init
id|nfsd_export_init
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;nfsd: initializing export module.&bslash;n&quot;
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|CLIENT_HASHMAX
suffix:semicolon
id|i
op_increment
)paren
id|clnt_hash
(braket
id|i
)braket
op_assign
l_int|NULL
suffix:semicolon
id|clients
op_assign
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; * Shutdown the exports module.&n; */
r_void
DECL|function|nfsd_export_shutdown
id|nfsd_export_shutdown
c_func
(paren
r_void
)paren
(brace
r_int
id|i
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;nfsd: shutting down export module.&bslash;n&quot;
)paren
suffix:semicolon
id|exp_writelock
c_func
(paren
)paren
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|CLIENT_HASHMAX
suffix:semicolon
id|i
op_increment
)paren
(brace
r_while
c_loop
(paren
id|clnt_hash
(braket
id|i
)braket
)paren
id|exp_freeclient
c_func
(paren
id|clnt_hash
(braket
id|i
)braket
op_member_access_from_pointer
id|h_client
)paren
suffix:semicolon
)brace
id|clients
op_assign
l_int|NULL
suffix:semicolon
multiline_comment|/* we may be restarted before the module unloads */
id|exp_writeunlock
c_func
(paren
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;nfsd: export shutdown complete.&bslash;n&quot;
)paren
suffix:semicolon
)brace
eof
