DECL|macro|MSNFS
mdefine_line|#define MSNFS&t;/* HACK HACK */
multiline_comment|/*&n; * linux/fs/nfsd/export.c&n; *&n; * NFS exporting and validation.&n; *&n; * We maintain a list of clients, each of which has a list of&n; * exports. To export an fs to a given client, you first have&n; * to create the client entry with NFSCTL_ADDCLIENT, which&n; * creates a client control block and adds it to the hash&n; * table. Then, you call NFSCTL_EXPORT for each fs.&n; *&n; *&n; * Copyright (C) 1995, 1996 Olaf Kirch, &lt;okir@monad.swb.de&gt;&n; */
macro_line|#include &lt;linux/unistd.h&gt;
macro_line|#include &lt;linux/slab.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/stat.h&gt;
macro_line|#include &lt;linux/in.h&gt;
macro_line|#include &lt;linux/seq_file.h&gt;
macro_line|#include &lt;linux/syscalls.h&gt;
macro_line|#include &lt;linux/rwsem.h&gt;
macro_line|#include &lt;linux/dcache.h&gt;
macro_line|#include &lt;linux/namei.h&gt;
macro_line|#include &lt;linux/mount.h&gt;
macro_line|#include &lt;linux/hash.h&gt;
macro_line|#include &lt;linux/sunrpc/svc.h&gt;
macro_line|#include &lt;linux/nfsd/nfsd.h&gt;
macro_line|#include &lt;linux/nfsd/nfsfh.h&gt;
macro_line|#include &lt;linux/nfsd/syscall.h&gt;
macro_line|#include &lt;linux/lockd/bind.h&gt;
DECL|macro|NFSDDBG_FACILITY
mdefine_line|#define NFSDDBG_FACILITY&t;NFSDDBG_EXPORT
DECL|macro|NFSD_PARANOIA
mdefine_line|#define NFSD_PARANOIA 1
DECL|typedef|svc_client
r_typedef
r_struct
id|auth_domain
id|svc_client
suffix:semicolon
DECL|typedef|svc_export
r_typedef
r_struct
id|svc_export
id|svc_export
suffix:semicolon
r_static
r_void
id|exp_do_unexport
c_func
(paren
id|svc_export
op_star
id|unexp
)paren
suffix:semicolon
r_static
r_int
id|exp_verify_string
c_func
(paren
r_char
op_star
id|cp
comma
r_int
id|max
)paren
suffix:semicolon
multiline_comment|/*&n; * We have two caches.&n; * One maps client+vfsmnt+dentry to export options - the export map&n; * The other maps client+filehandle-fragment to export options. - the expkey map&n; *&n; * The export options are actually stored in the first map, and the&n; * second map contains a reference to the entry in the first map.&n; */
DECL|macro|EXPKEY_HASHBITS
mdefine_line|#define&t;EXPKEY_HASHBITS&t;&t;8
DECL|macro|EXPKEY_HASHMAX
mdefine_line|#define&t;EXPKEY_HASHMAX&t;&t;(1 &lt;&lt; EXPKEY_HASHBITS)
DECL|macro|EXPKEY_HASHMASK
mdefine_line|#define&t;EXPKEY_HASHMASK&t;&t;(EXPKEY_HASHMAX -1)
DECL|variable|expkey_table
r_static
r_struct
id|cache_head
op_star
id|expkey_table
(braket
id|EXPKEY_HASHMAX
)braket
suffix:semicolon
DECL|function|svc_expkey_hash
r_static
r_inline
r_int
id|svc_expkey_hash
c_func
(paren
r_struct
id|svc_expkey
op_star
id|item
)paren
(brace
r_int
id|hash
op_assign
id|item-&gt;ek_fsidtype
suffix:semicolon
r_char
op_star
id|cp
op_assign
(paren
r_char
op_star
)paren
id|item-&gt;ek_fsid
suffix:semicolon
r_int
id|len
op_assign
id|key_len
c_func
(paren
id|item-&gt;ek_fsidtype
)paren
suffix:semicolon
id|hash
op_xor_assign
id|hash_mem
c_func
(paren
id|cp
comma
id|len
comma
id|EXPKEY_HASHBITS
)paren
suffix:semicolon
id|hash
op_xor_assign
id|hash_ptr
c_func
(paren
id|item-&gt;ek_client
comma
id|EXPKEY_HASHBITS
)paren
suffix:semicolon
r_return
id|hash
op_amp
id|EXPKEY_HASHMASK
suffix:semicolon
)brace
DECL|function|expkey_put
r_void
id|expkey_put
c_func
(paren
r_struct
id|cache_head
op_star
id|item
comma
r_struct
id|cache_detail
op_star
id|cd
)paren
(brace
r_if
c_cond
(paren
id|cache_put
c_func
(paren
id|item
comma
id|cd
)paren
)paren
(brace
r_struct
id|svc_expkey
op_star
id|key
op_assign
id|container_of
c_func
(paren
id|item
comma
r_struct
id|svc_expkey
comma
id|h
)paren
suffix:semicolon
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|CACHE_VALID
comma
op_amp
id|item-&gt;flags
)paren
op_logical_and
op_logical_neg
id|test_bit
c_func
(paren
id|CACHE_NEGATIVE
comma
op_amp
id|item-&gt;flags
)paren
)paren
id|exp_put
c_func
(paren
id|key-&gt;ek_export
)paren
suffix:semicolon
id|auth_domain_put
c_func
(paren
id|key-&gt;ek_client
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|key
)paren
suffix:semicolon
)brace
)brace
DECL|function|expkey_request
r_void
id|expkey_request
c_func
(paren
r_struct
id|cache_detail
op_star
id|cd
comma
r_struct
id|cache_head
op_star
id|h
comma
r_char
op_star
op_star
id|bpp
comma
r_int
op_star
id|blen
)paren
(brace
multiline_comment|/* client fsidtype &bslash;xfsid */
r_struct
id|svc_expkey
op_star
id|ek
op_assign
id|container_of
c_func
(paren
id|h
comma
r_struct
id|svc_expkey
comma
id|h
)paren
suffix:semicolon
r_char
id|type
(braket
l_int|5
)braket
suffix:semicolon
id|qword_add
c_func
(paren
id|bpp
comma
id|blen
comma
id|ek-&gt;ek_client-&gt;name
)paren
suffix:semicolon
id|snprintf
c_func
(paren
id|type
comma
l_int|5
comma
l_string|&quot;%d&quot;
comma
id|ek-&gt;ek_fsidtype
)paren
suffix:semicolon
id|qword_add
c_func
(paren
id|bpp
comma
id|blen
comma
id|type
)paren
suffix:semicolon
id|qword_addhex
c_func
(paren
id|bpp
comma
id|blen
comma
(paren
r_char
op_star
)paren
id|ek-&gt;ek_fsid
comma
id|key_len
c_func
(paren
id|ek-&gt;ek_fsidtype
)paren
)paren
suffix:semicolon
(paren
op_star
id|bpp
)paren
(braket
op_minus
l_int|1
)braket
op_assign
l_char|&squot;&bslash;n&squot;
suffix:semicolon
)brace
r_static
r_struct
id|svc_expkey
op_star
id|svc_expkey_lookup
c_func
(paren
r_struct
id|svc_expkey
op_star
comma
r_int
)paren
suffix:semicolon
DECL|function|expkey_parse
r_int
id|expkey_parse
c_func
(paren
r_struct
id|cache_detail
op_star
id|cd
comma
r_char
op_star
id|mesg
comma
r_int
id|mlen
)paren
(brace
multiline_comment|/* client fsidtype fsid [path] */
r_char
op_star
id|buf
suffix:semicolon
r_int
id|len
suffix:semicolon
r_struct
id|auth_domain
op_star
id|dom
op_assign
l_int|NULL
suffix:semicolon
r_int
id|err
suffix:semicolon
r_int
id|fsidtype
suffix:semicolon
r_char
op_star
id|ep
suffix:semicolon
r_struct
id|svc_expkey
id|key
suffix:semicolon
r_if
c_cond
(paren
id|mesg
(braket
id|mlen
op_minus
l_int|1
)braket
op_ne
l_char|&squot;&bslash;n&squot;
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|mesg
(braket
id|mlen
op_minus
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|buf
op_assign
id|kmalloc
c_func
(paren
id|PAGE_SIZE
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|buf
)paren
r_goto
id|out
suffix:semicolon
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
(paren
id|len
op_assign
id|qword_get
c_func
(paren
op_amp
id|mesg
comma
id|buf
comma
id|PAGE_SIZE
)paren
)paren
op_le
l_int|0
)paren
r_goto
id|out
suffix:semicolon
id|err
op_assign
op_minus
id|ENOENT
suffix:semicolon
id|dom
op_assign
id|auth_domain_find
c_func
(paren
id|buf
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dom
)paren
r_goto
id|out
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;found domain %s&bslash;n&quot;
comma
id|buf
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
(paren
id|len
op_assign
id|qword_get
c_func
(paren
op_amp
id|mesg
comma
id|buf
comma
id|PAGE_SIZE
)paren
)paren
op_le
l_int|0
)paren
r_goto
id|out
suffix:semicolon
id|fsidtype
op_assign
id|simple_strtoul
c_func
(paren
id|buf
comma
op_amp
id|ep
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
op_star
id|ep
)paren
r_goto
id|out
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;found fsidtype %d&bslash;n&quot;
comma
id|fsidtype
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fsidtype
OG
l_int|2
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
(paren
id|len
op_assign
id|qword_get
c_func
(paren
op_amp
id|mesg
comma
id|buf
comma
id|PAGE_SIZE
)paren
)paren
op_le
l_int|0
)paren
r_goto
id|out
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;found fsid length %d&bslash;n&quot;
comma
id|len
)paren
suffix:semicolon
r_if
c_cond
(paren
id|len
op_ne
id|key_len
c_func
(paren
id|fsidtype
)paren
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* OK, we seem to have a valid key */
id|key.h.flags
op_assign
l_int|0
suffix:semicolon
id|key.h.expiry_time
op_assign
id|get_expiry
c_func
(paren
op_amp
id|mesg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|key.h.expiry_time
op_eq
l_int|0
)paren
r_goto
id|out
suffix:semicolon
id|key.ek_client
op_assign
id|dom
suffix:semicolon
id|key.ek_fsidtype
op_assign
id|fsidtype
suffix:semicolon
id|memcpy
c_func
(paren
id|key.ek_fsid
comma
id|buf
comma
id|len
)paren
suffix:semicolon
multiline_comment|/* now we want a pathname, or empty meaning NEGATIVE  */
r_if
c_cond
(paren
(paren
id|len
op_assign
id|qword_get
c_func
(paren
op_amp
id|mesg
comma
id|buf
comma
id|PAGE_SIZE
)paren
)paren
OL
l_int|0
)paren
r_goto
id|out
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;Path seems to be &lt;%s&gt;&bslash;n&quot;
comma
id|buf
)paren
suffix:semicolon
id|err
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|len
op_eq
l_int|0
)paren
(brace
r_struct
id|svc_expkey
op_star
id|ek
suffix:semicolon
id|set_bit
c_func
(paren
id|CACHE_NEGATIVE
comma
op_amp
id|key.h.flags
)paren
suffix:semicolon
id|ek
op_assign
id|svc_expkey_lookup
c_func
(paren
op_amp
id|key
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ek
)paren
id|expkey_put
c_func
(paren
op_amp
id|ek-&gt;h
comma
op_amp
id|svc_expkey_cache
)paren
suffix:semicolon
)brace
r_else
(brace
r_struct
id|nameidata
id|nd
suffix:semicolon
r_struct
id|svc_expkey
op_star
id|ek
suffix:semicolon
r_struct
id|svc_export
op_star
id|exp
suffix:semicolon
id|err
op_assign
id|path_lookup
c_func
(paren
id|buf
comma
l_int|0
comma
op_amp
id|nd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|out
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;Found the path %s&bslash;n&quot;
comma
id|buf
)paren
suffix:semicolon
id|exp
op_assign
id|exp_get_by_name
c_func
(paren
id|dom
comma
id|nd.mnt
comma
id|nd.dentry
comma
l_int|NULL
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|ENOENT
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|exp
)paren
r_goto
id|out_nd
suffix:semicolon
id|key.ek_export
op_assign
id|exp
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;And found export&bslash;n&quot;
)paren
suffix:semicolon
id|ek
op_assign
id|svc_expkey_lookup
c_func
(paren
op_amp
id|key
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ek
)paren
id|expkey_put
c_func
(paren
op_amp
id|ek-&gt;h
comma
op_amp
id|svc_expkey_cache
)paren
suffix:semicolon
id|exp_put
c_func
(paren
id|exp
)paren
suffix:semicolon
id|err
op_assign
l_int|0
suffix:semicolon
id|out_nd
suffix:colon
id|path_release
c_func
(paren
op_amp
id|nd
)paren
suffix:semicolon
)brace
id|cache_flush
c_func
(paren
)paren
suffix:semicolon
id|out
suffix:colon
r_if
c_cond
(paren
id|dom
)paren
id|auth_domain_put
c_func
(paren
id|dom
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buf
)paren
id|kfree
c_func
(paren
id|buf
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
DECL|function|expkey_show
r_static
r_int
id|expkey_show
c_func
(paren
r_struct
id|seq_file
op_star
id|m
comma
r_struct
id|cache_detail
op_star
id|cd
comma
r_struct
id|cache_head
op_star
id|h
)paren
(brace
r_struct
id|svc_expkey
op_star
id|ek
suffix:semicolon
r_if
c_cond
(paren
id|h
op_eq
l_int|NULL
)paren
(brace
id|seq_puts
c_func
(paren
id|m
comma
l_string|&quot;#domain fsidtype fsid [path]&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|ek
op_assign
id|container_of
c_func
(paren
id|h
comma
r_struct
id|svc_expkey
comma
id|h
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;%s %d 0x%08x&quot;
comma
id|ek-&gt;ek_client-&gt;name
comma
id|ek-&gt;ek_fsidtype
comma
id|ek-&gt;ek_fsid
(braket
l_int|0
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ek-&gt;ek_fsidtype
op_ne
l_int|1
)paren
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;%08x&quot;
comma
id|ek-&gt;ek_fsid
(braket
l_int|1
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ek-&gt;ek_fsidtype
op_eq
l_int|2
)paren
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;%08x&quot;
comma
id|ek-&gt;ek_fsid
(braket
l_int|2
)braket
)paren
suffix:semicolon
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|CACHE_VALID
comma
op_amp
id|h-&gt;flags
)paren
op_logical_and
op_logical_neg
id|test_bit
c_func
(paren
id|CACHE_NEGATIVE
comma
op_amp
id|h-&gt;flags
)paren
)paren
(brace
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot; &quot;
)paren
suffix:semicolon
id|seq_path
c_func
(paren
id|m
comma
id|ek-&gt;ek_export-&gt;ex_mnt
comma
id|ek-&gt;ek_export-&gt;ex_dentry
comma
l_string|&quot;&bslash;&bslash; &bslash;t&bslash;n&quot;
)paren
suffix:semicolon
)brace
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|svc_expkey_cache
r_struct
id|cache_detail
id|svc_expkey_cache
op_assign
(brace
dot
id|hash_size
op_assign
id|EXPKEY_HASHMAX
comma
dot
id|hash_table
op_assign
id|expkey_table
comma
dot
id|name
op_assign
l_string|&quot;nfsd.fh&quot;
comma
dot
id|cache_put
op_assign
id|expkey_put
comma
dot
id|cache_request
op_assign
id|expkey_request
comma
dot
id|cache_parse
op_assign
id|expkey_parse
comma
dot
id|cache_show
op_assign
id|expkey_show
comma
)brace
suffix:semicolon
DECL|function|svc_expkey_match
r_static
r_inline
r_int
id|svc_expkey_match
(paren
r_struct
id|svc_expkey
op_star
id|a
comma
r_struct
id|svc_expkey
op_star
id|b
)paren
(brace
r_if
c_cond
(paren
id|a-&gt;ek_fsidtype
op_ne
id|b-&gt;ek_fsidtype
op_logical_or
id|a-&gt;ek_client
op_ne
id|b-&gt;ek_client
op_logical_or
id|memcmp
c_func
(paren
id|a-&gt;ek_fsid
comma
id|b-&gt;ek_fsid
comma
id|key_len
c_func
(paren
id|a-&gt;ek_fsidtype
)paren
)paren
op_ne
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
r_return
l_int|1
suffix:semicolon
)brace
DECL|function|svc_expkey_init
r_static
r_inline
r_void
id|svc_expkey_init
c_func
(paren
r_struct
id|svc_expkey
op_star
r_new
comma
r_struct
id|svc_expkey
op_star
id|item
)paren
(brace
id|cache_get
c_func
(paren
op_amp
id|item-&gt;ek_client-&gt;h
)paren
suffix:semicolon
r_new
op_member_access_from_pointer
id|ek_client
op_assign
id|item-&gt;ek_client
suffix:semicolon
r_new
op_member_access_from_pointer
id|ek_fsidtype
op_assign
id|item-&gt;ek_fsidtype
suffix:semicolon
r_new
op_member_access_from_pointer
id|ek_fsid
(braket
l_int|0
)braket
op_assign
id|item-&gt;ek_fsid
(braket
l_int|0
)braket
suffix:semicolon
r_new
op_member_access_from_pointer
id|ek_fsid
(braket
l_int|1
)braket
op_assign
id|item-&gt;ek_fsid
(braket
l_int|1
)braket
suffix:semicolon
r_new
op_member_access_from_pointer
id|ek_fsid
(braket
l_int|2
)braket
op_assign
id|item-&gt;ek_fsid
(braket
l_int|2
)braket
suffix:semicolon
)brace
DECL|function|svc_expkey_update
r_static
r_inline
r_void
id|svc_expkey_update
c_func
(paren
r_struct
id|svc_expkey
op_star
r_new
comma
r_struct
id|svc_expkey
op_star
id|item
)paren
(brace
id|cache_get
c_func
(paren
op_amp
id|item-&gt;ek_export-&gt;h
)paren
suffix:semicolon
r_new
op_member_access_from_pointer
id|ek_export
op_assign
id|item-&gt;ek_export
suffix:semicolon
)brace
r_static
id|DefineSimpleCacheLookup
c_func
(paren
id|svc_expkey
comma
l_int|0
)paren
multiline_comment|/* no inplace updates */
DECL|macro|EXPORT_HASHBITS
mdefine_line|#define&t;EXPORT_HASHBITS&t;&t;8
DECL|macro|EXPORT_HASHMAX
mdefine_line|#define&t;EXPORT_HASHMAX&t;&t;(1&lt;&lt; EXPORT_HASHBITS)
DECL|macro|EXPORT_HASHMASK
mdefine_line|#define&t;EXPORT_HASHMASK&t;&t;(EXPORT_HASHMAX -1)
DECL|variable|export_table
r_static
r_struct
id|cache_head
op_star
id|export_table
(braket
id|EXPORT_HASHMAX
)braket
suffix:semicolon
DECL|function|svc_export_hash
r_static
r_inline
r_int
id|svc_export_hash
c_func
(paren
r_struct
id|svc_export
op_star
id|item
)paren
(brace
r_int
id|rv
suffix:semicolon
id|rv
op_assign
id|hash_ptr
c_func
(paren
id|item-&gt;ex_client
comma
id|EXPORT_HASHBITS
)paren
suffix:semicolon
id|rv
op_xor_assign
id|hash_ptr
c_func
(paren
id|item-&gt;ex_dentry
comma
id|EXPORT_HASHBITS
)paren
suffix:semicolon
id|rv
op_xor_assign
id|hash_ptr
c_func
(paren
id|item-&gt;ex_mnt
comma
id|EXPORT_HASHBITS
)paren
suffix:semicolon
r_return
id|rv
suffix:semicolon
)brace
DECL|function|svc_export_put
r_void
id|svc_export_put
c_func
(paren
r_struct
id|cache_head
op_star
id|item
comma
r_struct
id|cache_detail
op_star
id|cd
)paren
(brace
r_if
c_cond
(paren
id|cache_put
c_func
(paren
id|item
comma
id|cd
)paren
)paren
(brace
r_struct
id|svc_export
op_star
id|exp
op_assign
id|container_of
c_func
(paren
id|item
comma
r_struct
id|svc_export
comma
id|h
)paren
suffix:semicolon
id|dput
c_func
(paren
id|exp-&gt;ex_dentry
)paren
suffix:semicolon
id|mntput
c_func
(paren
id|exp-&gt;ex_mnt
)paren
suffix:semicolon
id|auth_domain_put
c_func
(paren
id|exp-&gt;ex_client
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|exp
)paren
suffix:semicolon
)brace
)brace
DECL|function|svc_export_request
r_void
id|svc_export_request
c_func
(paren
r_struct
id|cache_detail
op_star
id|cd
comma
r_struct
id|cache_head
op_star
id|h
comma
r_char
op_star
op_star
id|bpp
comma
r_int
op_star
id|blen
)paren
(brace
multiline_comment|/*  client path */
r_struct
id|svc_export
op_star
id|exp
op_assign
id|container_of
c_func
(paren
id|h
comma
r_struct
id|svc_export
comma
id|h
)paren
suffix:semicolon
r_char
op_star
id|pth
suffix:semicolon
id|qword_add
c_func
(paren
id|bpp
comma
id|blen
comma
id|exp-&gt;ex_client-&gt;name
)paren
suffix:semicolon
id|pth
op_assign
id|d_path
c_func
(paren
id|exp-&gt;ex_dentry
comma
id|exp-&gt;ex_mnt
comma
op_star
id|bpp
comma
op_star
id|blen
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|pth
)paren
)paren
(brace
multiline_comment|/* is this correct? */
(paren
op_star
id|bpp
)paren
(braket
l_int|0
)braket
op_assign
l_char|&squot;&bslash;n&squot;
suffix:semicolon
r_return
suffix:semicolon
)brace
id|qword_add
c_func
(paren
id|bpp
comma
id|blen
comma
id|pth
)paren
suffix:semicolon
(paren
op_star
id|bpp
)paren
(braket
op_minus
l_int|1
)braket
op_assign
l_char|&squot;&bslash;n&squot;
suffix:semicolon
)brace
r_static
r_struct
id|svc_export
op_star
id|svc_export_lookup
c_func
(paren
r_struct
id|svc_export
op_star
comma
r_int
)paren
suffix:semicolon
DECL|function|check_export
r_static
r_int
id|check_export
c_func
(paren
r_struct
id|inode
op_star
id|inode
comma
r_int
id|flags
)paren
(brace
multiline_comment|/* We currently export only dirs and regular files.&n;&t; * This is what umountd does.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
id|S_ISDIR
c_func
(paren
id|inode-&gt;i_mode
)paren
op_logical_and
op_logical_neg
id|S_ISREG
c_func
(paren
id|inode-&gt;i_mode
)paren
)paren
r_return
op_minus
id|ENOTDIR
suffix:semicolon
multiline_comment|/* There are two requirements on a filesystem to be exportable.&n;&t; * 1:  We must be able to identify the filesystem from a number.&n;&t; *       either a device number (so FS_REQUIRES_DEV needed)&n;&t; *       or an FSID number (so NFSEXP_FSID needed).&n;&t; * 2:  We must be able to find an inode from a filehandle.&n;&t; *       This means that s_export_op must be set.&n;&t; */
r_if
c_cond
(paren
op_logical_neg
(paren
id|inode-&gt;i_sb-&gt;s_type-&gt;fs_flags
op_amp
id|FS_REQUIRES_DEV
)paren
op_logical_and
op_logical_neg
(paren
id|flags
op_amp
id|NFSEXP_FSID
)paren
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;exp_export: export of non-dev fs without fsid&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
r_if
c_cond
(paren
op_logical_neg
id|inode-&gt;i_sb-&gt;s_export_op
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;exp_export: export of invalid fs type.&bslash;n&quot;
)paren
suffix:semicolon
r_return
op_minus
id|EINVAL
suffix:semicolon
)brace
multiline_comment|/* Ok, we can export it */
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|inode-&gt;i_sb-&gt;s_export_op-&gt;find_exported_dentry
)paren
id|inode-&gt;i_sb-&gt;s_export_op-&gt;find_exported_dentry
op_assign
id|find_exported_dentry
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|function|svc_export_parse
r_int
id|svc_export_parse
c_func
(paren
r_struct
id|cache_detail
op_star
id|cd
comma
r_char
op_star
id|mesg
comma
r_int
id|mlen
)paren
(brace
multiline_comment|/* client path expiry [flags anonuid anongid fsid] */
r_char
op_star
id|buf
suffix:semicolon
r_int
id|len
suffix:semicolon
r_int
id|err
suffix:semicolon
r_struct
id|auth_domain
op_star
id|dom
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|nameidata
id|nd
suffix:semicolon
r_struct
id|svc_export
id|exp
comma
op_star
id|expp
suffix:semicolon
r_int
id|an_int
suffix:semicolon
id|nd.dentry
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|mesg
(braket
id|mlen
op_minus
l_int|1
)braket
op_ne
l_char|&squot;&bslash;n&squot;
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|mesg
(braket
id|mlen
op_minus
l_int|1
)braket
op_assign
l_int|0
suffix:semicolon
id|buf
op_assign
id|kmalloc
c_func
(paren
id|PAGE_SIZE
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|buf
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* client */
id|len
op_assign
id|qword_get
c_func
(paren
op_amp
id|mesg
comma
id|buf
comma
id|PAGE_SIZE
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|len
op_le
l_int|0
)paren
r_goto
id|out
suffix:semicolon
id|err
op_assign
op_minus
id|ENOENT
suffix:semicolon
id|dom
op_assign
id|auth_domain_find
c_func
(paren
id|buf
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dom
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* path */
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
(paren
id|len
op_assign
id|qword_get
c_func
(paren
op_amp
id|mesg
comma
id|buf
comma
id|PAGE_SIZE
)paren
)paren
op_le
l_int|0
)paren
r_goto
id|out
suffix:semicolon
id|err
op_assign
id|path_lookup
c_func
(paren
id|buf
comma
l_int|0
comma
op_amp
id|nd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|out
suffix:semicolon
id|exp.h.flags
op_assign
l_int|0
suffix:semicolon
id|exp.ex_client
op_assign
id|dom
suffix:semicolon
id|exp.ex_mnt
op_assign
id|nd.mnt
suffix:semicolon
id|exp.ex_dentry
op_assign
id|nd.dentry
suffix:semicolon
multiline_comment|/* expiry */
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
id|exp.h.expiry_time
op_assign
id|get_expiry
c_func
(paren
op_amp
id|mesg
)paren
suffix:semicolon
r_if
c_cond
(paren
id|exp.h.expiry_time
op_eq
l_int|0
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* flags */
id|err
op_assign
id|get_int
c_func
(paren
op_amp
id|mesg
comma
op_amp
id|an_int
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
op_eq
op_minus
id|ENOENT
)paren
id|set_bit
c_func
(paren
id|CACHE_NEGATIVE
comma
op_amp
id|exp.h.flags
)paren
suffix:semicolon
r_else
(brace
r_if
c_cond
(paren
id|err
op_logical_or
id|an_int
OL
l_int|0
)paren
r_goto
id|out
suffix:semicolon
id|exp.ex_flags
op_assign
id|an_int
suffix:semicolon
multiline_comment|/* anon uid */
id|err
op_assign
id|get_int
c_func
(paren
op_amp
id|mesg
comma
op_amp
id|an_int
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|out
suffix:semicolon
id|exp.ex_anon_uid
op_assign
id|an_int
suffix:semicolon
multiline_comment|/* anon gid */
id|err
op_assign
id|get_int
c_func
(paren
op_amp
id|mesg
comma
op_amp
id|an_int
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|out
suffix:semicolon
id|exp.ex_anon_gid
op_assign
id|an_int
suffix:semicolon
multiline_comment|/* fsid */
id|err
op_assign
id|get_int
c_func
(paren
op_amp
id|mesg
comma
op_amp
id|an_int
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|out
suffix:semicolon
id|exp.ex_fsid
op_assign
id|an_int
suffix:semicolon
id|err
op_assign
id|check_export
c_func
(paren
id|nd.dentry-&gt;d_inode
comma
id|exp.ex_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|out
suffix:semicolon
)brace
id|expp
op_assign
id|svc_export_lookup
c_func
(paren
op_amp
id|exp
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|expp
)paren
id|exp_put
c_func
(paren
id|expp
)paren
suffix:semicolon
id|err
op_assign
l_int|0
suffix:semicolon
id|cache_flush
c_func
(paren
)paren
suffix:semicolon
id|out
suffix:colon
r_if
c_cond
(paren
id|nd.dentry
)paren
id|path_release
c_func
(paren
op_amp
id|nd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|dom
)paren
id|auth_domain_put
c_func
(paren
id|dom
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buf
)paren
id|kfree
c_func
(paren
id|buf
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
r_static
r_void
id|exp_flags
c_func
(paren
r_struct
id|seq_file
op_star
id|m
comma
r_int
id|flag
comma
r_int
id|fsid
comma
id|uid_t
id|anonu
comma
id|uid_t
id|anong
)paren
suffix:semicolon
DECL|function|svc_export_show
r_static
r_int
id|svc_export_show
c_func
(paren
r_struct
id|seq_file
op_star
id|m
comma
r_struct
id|cache_detail
op_star
id|cd
comma
r_struct
id|cache_head
op_star
id|h
)paren
(brace
r_struct
id|svc_export
op_star
id|exp
suffix:semicolon
r_if
c_cond
(paren
id|h
op_eq
l_int|NULL
)paren
(brace
id|seq_puts
c_func
(paren
id|m
comma
l_string|&quot;#path domain(flags)&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|exp
op_assign
id|container_of
c_func
(paren
id|h
comma
r_struct
id|svc_export
comma
id|h
)paren
suffix:semicolon
id|seq_path
c_func
(paren
id|m
comma
id|exp-&gt;ex_mnt
comma
id|exp-&gt;ex_dentry
comma
l_string|&quot; &bslash;t&bslash;n&bslash;&bslash;&quot;
)paren
suffix:semicolon
id|seq_putc
c_func
(paren
id|m
comma
l_char|&squot;&bslash;t&squot;
)paren
suffix:semicolon
id|seq_escape
c_func
(paren
id|m
comma
id|exp-&gt;ex_client-&gt;name
comma
l_string|&quot; &bslash;t&bslash;n&bslash;&bslash;&quot;
)paren
suffix:semicolon
id|seq_putc
c_func
(paren
id|m
comma
l_char|&squot;(&squot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|CACHE_VALID
comma
op_amp
id|h-&gt;flags
)paren
op_logical_and
op_logical_neg
id|test_bit
c_func
(paren
id|CACHE_NEGATIVE
comma
op_amp
id|h-&gt;flags
)paren
)paren
id|exp_flags
c_func
(paren
id|m
comma
id|exp-&gt;ex_flags
comma
id|exp-&gt;ex_fsid
comma
id|exp-&gt;ex_anon_uid
comma
id|exp-&gt;ex_anon_gid
)paren
suffix:semicolon
id|seq_puts
c_func
(paren
id|m
comma
l_string|&quot;)&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
DECL|variable|svc_export_cache
r_struct
id|cache_detail
id|svc_export_cache
op_assign
(brace
dot
id|hash_size
op_assign
id|EXPORT_HASHMAX
comma
dot
id|hash_table
op_assign
id|export_table
comma
dot
id|name
op_assign
l_string|&quot;nfsd.export&quot;
comma
dot
id|cache_put
op_assign
id|svc_export_put
comma
dot
id|cache_request
op_assign
id|svc_export_request
comma
dot
id|cache_parse
op_assign
id|svc_export_parse
comma
dot
id|cache_show
op_assign
id|svc_export_show
comma
)brace
suffix:semicolon
DECL|function|svc_export_match
r_static
r_inline
r_int
id|svc_export_match
c_func
(paren
r_struct
id|svc_export
op_star
id|a
comma
r_struct
id|svc_export
op_star
id|b
)paren
(brace
r_return
id|a-&gt;ex_client
op_eq
id|b-&gt;ex_client
op_logical_and
id|a-&gt;ex_dentry
op_eq
id|b-&gt;ex_dentry
op_logical_and
id|a-&gt;ex_mnt
op_eq
id|b-&gt;ex_mnt
suffix:semicolon
)brace
DECL|function|svc_export_init
r_static
r_inline
r_void
id|svc_export_init
c_func
(paren
r_struct
id|svc_export
op_star
r_new
comma
r_struct
id|svc_export
op_star
id|item
)paren
(brace
id|cache_get
c_func
(paren
op_amp
id|item-&gt;ex_client-&gt;h
)paren
suffix:semicolon
r_new
op_member_access_from_pointer
id|ex_client
op_assign
id|item-&gt;ex_client
suffix:semicolon
r_new
op_member_access_from_pointer
id|ex_dentry
op_assign
id|dget
c_func
(paren
id|item-&gt;ex_dentry
)paren
suffix:semicolon
r_new
op_member_access_from_pointer
id|ex_mnt
op_assign
id|mntget
c_func
(paren
id|item-&gt;ex_mnt
)paren
suffix:semicolon
)brace
DECL|function|svc_export_update
r_static
r_inline
r_void
id|svc_export_update
c_func
(paren
r_struct
id|svc_export
op_star
r_new
comma
r_struct
id|svc_export
op_star
id|item
)paren
(brace
r_new
op_member_access_from_pointer
id|ex_flags
op_assign
id|item-&gt;ex_flags
suffix:semicolon
r_new
op_member_access_from_pointer
id|ex_anon_uid
op_assign
id|item-&gt;ex_anon_uid
suffix:semicolon
r_new
op_member_access_from_pointer
id|ex_anon_gid
op_assign
id|item-&gt;ex_anon_gid
suffix:semicolon
r_new
op_member_access_from_pointer
id|ex_fsid
op_assign
id|item-&gt;ex_fsid
suffix:semicolon
)brace
r_static
id|DefineSimpleCacheLookup
c_func
(paren
id|svc_export
comma
l_int|1
)paren
multiline_comment|/* allow inplace updates */
r_struct
id|svc_expkey
op_star
DECL|function|exp_find_key
id|exp_find_key
c_func
(paren
id|svc_client
op_star
id|clp
comma
r_int
id|fsid_type
comma
id|u32
op_star
id|fsidv
comma
r_struct
id|cache_req
op_star
id|reqp
)paren
(brace
r_struct
id|svc_expkey
id|key
comma
op_star
id|ek
suffix:semicolon
r_int
id|err
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|clp
)paren
r_return
l_int|NULL
suffix:semicolon
id|key.ek_client
op_assign
id|clp
suffix:semicolon
id|key.ek_fsidtype
op_assign
id|fsid_type
suffix:semicolon
id|memcpy
c_func
(paren
id|key.ek_fsid
comma
id|fsidv
comma
id|key_len
c_func
(paren
id|fsid_type
)paren
)paren
suffix:semicolon
id|ek
op_assign
id|svc_expkey_lookup
c_func
(paren
op_amp
id|key
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ek
op_ne
l_int|NULL
)paren
r_if
c_cond
(paren
(paren
id|err
op_assign
id|cache_check
c_func
(paren
op_amp
id|svc_expkey_cache
comma
op_amp
id|ek-&gt;h
comma
id|reqp
)paren
)paren
)paren
id|ek
op_assign
id|ERR_PTR
c_func
(paren
id|err
)paren
suffix:semicolon
r_return
id|ek
suffix:semicolon
)brace
DECL|function|exp_set_key
r_int
id|exp_set_key
c_func
(paren
id|svc_client
op_star
id|clp
comma
r_int
id|fsid_type
comma
id|u32
op_star
id|fsidv
comma
r_struct
id|svc_export
op_star
id|exp
)paren
(brace
r_struct
id|svc_expkey
id|key
comma
op_star
id|ek
suffix:semicolon
id|key.ek_client
op_assign
id|clp
suffix:semicolon
id|key.ek_fsidtype
op_assign
id|fsid_type
suffix:semicolon
id|memcpy
c_func
(paren
id|key.ek_fsid
comma
id|fsidv
comma
id|key_len
c_func
(paren
id|fsid_type
)paren
)paren
suffix:semicolon
id|key.ek_export
op_assign
id|exp
suffix:semicolon
id|key.h.expiry_time
op_assign
id|NEVER
suffix:semicolon
id|key.h.flags
op_assign
l_int|0
suffix:semicolon
id|ek
op_assign
id|svc_expkey_lookup
c_func
(paren
op_amp
id|key
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ek
)paren
(brace
id|expkey_put
c_func
(paren
op_amp
id|ek-&gt;h
comma
op_amp
id|svc_expkey_cache
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_return
op_minus
id|ENOMEM
suffix:semicolon
)brace
multiline_comment|/*&n; * Find the client&squot;s export entry matching xdev/xino.&n; */
r_static
r_inline
r_struct
id|svc_expkey
op_star
DECL|function|exp_get_key
id|exp_get_key
c_func
(paren
id|svc_client
op_star
id|clp
comma
id|dev_t
id|dev
comma
id|ino_t
id|ino
)paren
(brace
id|u32
id|fsidv
(braket
l_int|3
)braket
suffix:semicolon
r_if
c_cond
(paren
id|old_valid_dev
c_func
(paren
id|dev
)paren
)paren
(brace
id|mk_fsid_v0
c_func
(paren
id|fsidv
comma
id|dev
comma
id|ino
)paren
suffix:semicolon
r_return
id|exp_find_key
c_func
(paren
id|clp
comma
l_int|0
comma
id|fsidv
comma
l_int|NULL
)paren
suffix:semicolon
)brace
id|mk_fsid_v3
c_func
(paren
id|fsidv
comma
id|dev
comma
id|ino
)paren
suffix:semicolon
r_return
id|exp_find_key
c_func
(paren
id|clp
comma
l_int|3
comma
id|fsidv
comma
l_int|NULL
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Find the client&squot;s export entry matching fsid&n; */
r_static
r_inline
r_struct
id|svc_expkey
op_star
DECL|function|exp_get_fsid_key
id|exp_get_fsid_key
c_func
(paren
id|svc_client
op_star
id|clp
comma
r_int
id|fsid
)paren
(brace
id|u32
id|fsidv
(braket
l_int|2
)braket
suffix:semicolon
id|mk_fsid_v1
c_func
(paren
id|fsidv
comma
id|fsid
)paren
suffix:semicolon
r_return
id|exp_find_key
c_func
(paren
id|clp
comma
l_int|1
comma
id|fsidv
comma
l_int|NULL
)paren
suffix:semicolon
)brace
id|svc_export
op_star
DECL|function|exp_get_by_name
id|exp_get_by_name
c_func
(paren
id|svc_client
op_star
id|clp
comma
r_struct
id|vfsmount
op_star
id|mnt
comma
r_struct
id|dentry
op_star
id|dentry
comma
r_struct
id|cache_req
op_star
id|reqp
)paren
(brace
r_struct
id|svc_export
op_star
id|exp
comma
id|key
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|clp
)paren
r_return
l_int|NULL
suffix:semicolon
id|key.ex_client
op_assign
id|clp
suffix:semicolon
id|key.ex_mnt
op_assign
id|mnt
suffix:semicolon
id|key.ex_dentry
op_assign
id|dentry
suffix:semicolon
id|exp
op_assign
id|svc_export_lookup
c_func
(paren
op_amp
id|key
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
id|exp
op_ne
l_int|NULL
)paren
r_switch
c_cond
(paren
id|cache_check
c_func
(paren
op_amp
id|svc_export_cache
comma
op_amp
id|exp-&gt;h
comma
id|reqp
)paren
)paren
(brace
r_case
l_int|0
suffix:colon
r_break
suffix:semicolon
r_case
op_minus
id|EAGAIN
suffix:colon
id|exp
op_assign
id|ERR_PTR
c_func
(paren
op_minus
id|EAGAIN
)paren
suffix:semicolon
r_break
suffix:semicolon
r_default
suffix:colon
id|exp
op_assign
l_int|NULL
suffix:semicolon
)brace
r_return
id|exp
suffix:semicolon
)brace
multiline_comment|/*&n; * Find the export entry for a given dentry.&n; */
r_struct
id|svc_export
op_star
DECL|function|exp_parent
id|exp_parent
c_func
(paren
id|svc_client
op_star
id|clp
comma
r_struct
id|vfsmount
op_star
id|mnt
comma
r_struct
id|dentry
op_star
id|dentry
comma
r_struct
id|cache_req
op_star
id|reqp
)paren
(brace
id|svc_export
op_star
id|exp
suffix:semicolon
id|dget
c_func
(paren
id|dentry
)paren
suffix:semicolon
id|exp
op_assign
id|exp_get_by_name
c_func
(paren
id|clp
comma
id|mnt
comma
id|dentry
comma
id|reqp
)paren
suffix:semicolon
r_while
c_loop
(paren
id|exp
op_eq
l_int|NULL
op_logical_and
op_logical_neg
id|IS_ROOT
c_func
(paren
id|dentry
)paren
)paren
(brace
r_struct
id|dentry
op_star
id|parent
suffix:semicolon
id|parent
op_assign
id|dget_parent
c_func
(paren
id|dentry
)paren
suffix:semicolon
id|dput
c_func
(paren
id|dentry
)paren
suffix:semicolon
id|dentry
op_assign
id|parent
suffix:semicolon
id|exp
op_assign
id|exp_get_by_name
c_func
(paren
id|clp
comma
id|mnt
comma
id|dentry
comma
id|reqp
)paren
suffix:semicolon
)brace
id|dput
c_func
(paren
id|dentry
)paren
suffix:semicolon
r_return
id|exp
suffix:semicolon
)brace
multiline_comment|/*&n; * Hashtable locking. Write locks are placed only by user processes&n; * wanting to modify export information.&n; * Write locking only done in this file.  Read locking&n; * needed externally.&n; */
r_static
id|DECLARE_RWSEM
c_func
(paren
id|hash_sem
)paren
suffix:semicolon
r_void
DECL|function|exp_readlock
id|exp_readlock
c_func
(paren
r_void
)paren
(brace
id|down_read
c_func
(paren
op_amp
id|hash_sem
)paren
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|exp_writelock
id|exp_writelock
c_func
(paren
r_void
)paren
(brace
id|down_write
c_func
(paren
op_amp
id|hash_sem
)paren
suffix:semicolon
)brace
r_void
DECL|function|exp_readunlock
id|exp_readunlock
c_func
(paren
r_void
)paren
(brace
id|up_read
c_func
(paren
op_amp
id|hash_sem
)paren
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|exp_writeunlock
id|exp_writeunlock
c_func
(paren
r_void
)paren
(brace
id|up_write
c_func
(paren
op_amp
id|hash_sem
)paren
suffix:semicolon
)brace
DECL|function|exp_fsid_unhash
r_static
r_void
id|exp_fsid_unhash
c_func
(paren
r_struct
id|svc_export
op_star
id|exp
)paren
(brace
r_struct
id|svc_expkey
op_star
id|ek
suffix:semicolon
r_if
c_cond
(paren
(paren
id|exp-&gt;ex_flags
op_amp
id|NFSEXP_FSID
)paren
op_eq
l_int|0
)paren
r_return
suffix:semicolon
id|ek
op_assign
id|exp_get_fsid_key
c_func
(paren
id|exp-&gt;ex_client
comma
id|exp-&gt;ex_fsid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ek
op_logical_and
op_logical_neg
id|IS_ERR
c_func
(paren
id|ek
)paren
)paren
(brace
id|ek-&gt;h.expiry_time
op_assign
id|get_seconds
c_func
(paren
)paren
op_minus
l_int|1
suffix:semicolon
id|expkey_put
c_func
(paren
op_amp
id|ek-&gt;h
comma
op_amp
id|svc_expkey_cache
)paren
suffix:semicolon
)brace
id|svc_expkey_cache.nextcheck
op_assign
id|get_seconds
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|function|exp_fsid_hash
r_static
r_int
id|exp_fsid_hash
c_func
(paren
id|svc_client
op_star
id|clp
comma
r_struct
id|svc_export
op_star
id|exp
)paren
(brace
id|u32
id|fsid
(braket
l_int|2
)braket
suffix:semicolon
r_if
c_cond
(paren
(paren
id|exp-&gt;ex_flags
op_amp
id|NFSEXP_FSID
)paren
op_eq
l_int|0
)paren
r_return
l_int|0
suffix:semicolon
id|mk_fsid_v1
c_func
(paren
id|fsid
comma
id|exp-&gt;ex_fsid
)paren
suffix:semicolon
r_return
id|exp_set_key
c_func
(paren
id|clp
comma
l_int|1
comma
id|fsid
comma
id|exp
)paren
suffix:semicolon
)brace
DECL|function|exp_hash
r_static
r_int
id|exp_hash
c_func
(paren
r_struct
id|auth_domain
op_star
id|clp
comma
r_struct
id|svc_export
op_star
id|exp
)paren
(brace
id|u32
id|fsid
(braket
l_int|2
)braket
suffix:semicolon
r_struct
id|inode
op_star
id|inode
op_assign
id|exp-&gt;ex_dentry-&gt;d_inode
suffix:semicolon
id|dev_t
id|dev
op_assign
id|inode-&gt;i_sb-&gt;s_dev
suffix:semicolon
r_if
c_cond
(paren
id|old_valid_dev
c_func
(paren
id|dev
)paren
)paren
(brace
id|mk_fsid_v0
c_func
(paren
id|fsid
comma
id|dev
comma
id|inode-&gt;i_ino
)paren
suffix:semicolon
r_return
id|exp_set_key
c_func
(paren
id|clp
comma
l_int|0
comma
id|fsid
comma
id|exp
)paren
suffix:semicolon
)brace
id|mk_fsid_v3
c_func
(paren
id|fsid
comma
id|dev
comma
id|inode-&gt;i_ino
)paren
suffix:semicolon
r_return
id|exp_set_key
c_func
(paren
id|clp
comma
l_int|3
comma
id|fsid
comma
id|exp
)paren
suffix:semicolon
)brace
DECL|function|exp_unhash
r_static
r_void
id|exp_unhash
c_func
(paren
r_struct
id|svc_export
op_star
id|exp
)paren
(brace
r_struct
id|svc_expkey
op_star
id|ek
suffix:semicolon
r_struct
id|inode
op_star
id|inode
op_assign
id|exp-&gt;ex_dentry-&gt;d_inode
suffix:semicolon
id|ek
op_assign
id|exp_get_key
c_func
(paren
id|exp-&gt;ex_client
comma
id|inode-&gt;i_sb-&gt;s_dev
comma
id|inode-&gt;i_ino
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ek
op_logical_and
op_logical_neg
id|IS_ERR
c_func
(paren
id|ek
)paren
)paren
(brace
id|ek-&gt;h.expiry_time
op_assign
id|get_seconds
c_func
(paren
)paren
op_minus
l_int|1
suffix:semicolon
id|expkey_put
c_func
(paren
op_amp
id|ek-&gt;h
comma
op_amp
id|svc_expkey_cache
)paren
suffix:semicolon
)brace
id|svc_expkey_cache.nextcheck
op_assign
id|get_seconds
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Export a file system.&n; */
r_int
DECL|function|exp_export
id|exp_export
c_func
(paren
r_struct
id|nfsctl_export
op_star
id|nxp
)paren
(brace
id|svc_client
op_star
id|clp
suffix:semicolon
r_struct
id|svc_export
op_star
id|exp
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|svc_export
r_new
suffix:semicolon
r_struct
id|svc_expkey
op_star
id|fsid_key
op_assign
l_int|NULL
suffix:semicolon
r_struct
id|nameidata
id|nd
suffix:semicolon
r_int
id|err
suffix:semicolon
multiline_comment|/* Consistency check */
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|exp_verify_string
c_func
(paren
id|nxp-&gt;ex_path
comma
id|NFS_MAXPATHLEN
)paren
op_logical_or
op_logical_neg
id|exp_verify_string
c_func
(paren
id|nxp-&gt;ex_client
comma
id|NFSCLNT_IDMAX
)paren
)paren
r_goto
id|out
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;exp_export called for %s:%s (%x/%ld fl %x).&bslash;n&quot;
comma
id|nxp-&gt;ex_client
comma
id|nxp-&gt;ex_path
comma
(paren
r_int
)paren
id|nxp-&gt;ex_dev
comma
(paren
r_int
)paren
id|nxp-&gt;ex_ino
comma
id|nxp-&gt;ex_flags
)paren
suffix:semicolon
multiline_comment|/* Try to lock the export table for update */
id|exp_writelock
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* Look up client info */
r_if
c_cond
(paren
op_logical_neg
(paren
id|clp
op_assign
id|auth_domain_find
c_func
(paren
id|nxp-&gt;ex_client
)paren
)paren
)paren
r_goto
id|out_unlock
suffix:semicolon
multiline_comment|/* Look up the dentry */
id|err
op_assign
id|path_lookup
c_func
(paren
id|nxp-&gt;ex_path
comma
l_int|0
comma
op_amp
id|nd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|out_unlock
suffix:semicolon
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
id|exp
op_assign
id|exp_get_by_name
c_func
(paren
id|clp
comma
id|nd.mnt
comma
id|nd.dentry
comma
l_int|NULL
)paren
suffix:semicolon
multiline_comment|/* must make sure there won&squot;t be an ex_fsid clash */
r_if
c_cond
(paren
(paren
id|nxp-&gt;ex_flags
op_amp
id|NFSEXP_FSID
)paren
op_logical_and
(paren
id|fsid_key
op_assign
id|exp_get_fsid_key
c_func
(paren
id|clp
comma
id|nxp-&gt;ex_dev
)paren
)paren
op_logical_and
op_logical_neg
id|IS_ERR
c_func
(paren
id|fsid_key
)paren
op_logical_and
id|fsid_key-&gt;ek_export
op_logical_and
id|fsid_key-&gt;ek_export
op_ne
id|exp
)paren
r_goto
id|finish
suffix:semicolon
r_if
c_cond
(paren
id|exp
)paren
(brace
multiline_comment|/* just a flags/id/fsid update */
id|exp_fsid_unhash
c_func
(paren
id|exp
)paren
suffix:semicolon
id|exp-&gt;ex_flags
op_assign
id|nxp-&gt;ex_flags
suffix:semicolon
id|exp-&gt;ex_anon_uid
op_assign
id|nxp-&gt;ex_anon_uid
suffix:semicolon
id|exp-&gt;ex_anon_gid
op_assign
id|nxp-&gt;ex_anon_gid
suffix:semicolon
id|exp-&gt;ex_fsid
op_assign
id|nxp-&gt;ex_dev
suffix:semicolon
id|err
op_assign
id|exp_fsid_hash
c_func
(paren
id|clp
comma
id|exp
)paren
suffix:semicolon
r_goto
id|finish
suffix:semicolon
)brace
id|err
op_assign
id|check_export
c_func
(paren
id|nd.dentry-&gt;d_inode
comma
id|nxp-&gt;ex_flags
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|finish
suffix:semicolon
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;nfsd: creating export entry %p for client %p&bslash;n&quot;
comma
id|exp
comma
id|clp
)paren
suffix:semicolon
r_new
dot
id|h.expiry_time
op_assign
id|NEVER
suffix:semicolon
r_new
dot
id|h.flags
op_assign
l_int|0
suffix:semicolon
r_new
dot
id|ex_client
op_assign
id|clp
suffix:semicolon
r_new
dot
id|ex_mnt
op_assign
id|nd.mnt
suffix:semicolon
r_new
dot
id|ex_dentry
op_assign
id|nd.dentry
suffix:semicolon
r_new
dot
id|ex_flags
op_assign
id|nxp-&gt;ex_flags
suffix:semicolon
r_new
dot
id|ex_anon_uid
op_assign
id|nxp-&gt;ex_anon_uid
suffix:semicolon
r_new
dot
id|ex_anon_gid
op_assign
id|nxp-&gt;ex_anon_gid
suffix:semicolon
r_new
dot
id|ex_fsid
op_assign
id|nxp-&gt;ex_dev
suffix:semicolon
id|exp
op_assign
id|svc_export_lookup
c_func
(paren
op_amp
r_new
comma
l_int|1
)paren
suffix:semicolon
r_if
c_cond
(paren
id|exp
op_eq
l_int|NULL
)paren
r_goto
id|finish
suffix:semicolon
id|err
op_assign
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|exp_hash
c_func
(paren
id|clp
comma
id|exp
)paren
op_logical_or
id|exp_fsid_hash
c_func
(paren
id|clp
comma
id|exp
)paren
)paren
(brace
multiline_comment|/* failed to create at least one index */
id|exp_do_unexport
c_func
(paren
id|exp
)paren
suffix:semicolon
id|cache_flush
c_func
(paren
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
)brace
id|finish
suffix:colon
r_if
c_cond
(paren
id|exp
)paren
id|exp_put
c_func
(paren
id|exp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fsid_key
op_logical_and
op_logical_neg
id|IS_ERR
c_func
(paren
id|fsid_key
)paren
)paren
id|expkey_put
c_func
(paren
op_amp
id|fsid_key-&gt;h
comma
op_amp
id|svc_expkey_cache
)paren
suffix:semicolon
r_if
c_cond
(paren
id|clp
)paren
id|auth_domain_put
c_func
(paren
id|clp
)paren
suffix:semicolon
id|path_release
c_func
(paren
op_amp
id|nd
)paren
suffix:semicolon
id|out_unlock
suffix:colon
id|exp_writeunlock
c_func
(paren
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*&n; * Unexport a file system. The export entry has already&n; * been removed from the client&squot;s list of exported fs&squot;s.&n; */
r_static
r_void
DECL|function|exp_do_unexport
id|exp_do_unexport
c_func
(paren
id|svc_export
op_star
id|unexp
)paren
(brace
id|unexp-&gt;h.expiry_time
op_assign
id|get_seconds
c_func
(paren
)paren
op_minus
l_int|1
suffix:semicolon
id|svc_export_cache.nextcheck
op_assign
id|get_seconds
c_func
(paren
)paren
suffix:semicolon
id|exp_unhash
c_func
(paren
id|unexp
)paren
suffix:semicolon
id|exp_fsid_unhash
c_func
(paren
id|unexp
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * unexport syscall.&n; */
r_int
DECL|function|exp_unexport
id|exp_unexport
c_func
(paren
r_struct
id|nfsctl_export
op_star
id|nxp
)paren
(brace
r_struct
id|auth_domain
op_star
id|dom
suffix:semicolon
id|svc_export
op_star
id|exp
suffix:semicolon
r_struct
id|nameidata
id|nd
suffix:semicolon
r_int
id|err
suffix:semicolon
multiline_comment|/* Consistency check */
r_if
c_cond
(paren
op_logical_neg
id|exp_verify_string
c_func
(paren
id|nxp-&gt;ex_path
comma
id|NFS_MAXPATHLEN
)paren
op_logical_or
op_logical_neg
id|exp_verify_string
c_func
(paren
id|nxp-&gt;ex_client
comma
id|NFSCLNT_IDMAX
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|exp_writelock
c_func
(paren
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
id|dom
op_assign
id|auth_domain_find
c_func
(paren
id|nxp-&gt;ex_client
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dom
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;nfsd: unexport couldn&squot;t find %s&bslash;n&quot;
comma
id|nxp-&gt;ex_client
)paren
suffix:semicolon
r_goto
id|out_unlock
suffix:semicolon
)brace
id|err
op_assign
id|path_lookup
c_func
(paren
id|nxp-&gt;ex_path
comma
l_int|0
comma
op_amp
id|nd
)paren
suffix:semicolon
r_if
c_cond
(paren
id|err
)paren
r_goto
id|out_domain
suffix:semicolon
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
id|exp
op_assign
id|exp_get_by_name
c_func
(paren
id|dom
comma
id|nd.mnt
comma
id|nd.dentry
comma
l_int|NULL
)paren
suffix:semicolon
id|path_release
c_func
(paren
op_amp
id|nd
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|exp
)paren
r_goto
id|out_domain
suffix:semicolon
id|exp_do_unexport
c_func
(paren
id|exp
)paren
suffix:semicolon
id|exp_put
c_func
(paren
id|exp
)paren
suffix:semicolon
id|err
op_assign
l_int|0
suffix:semicolon
id|out_domain
suffix:colon
id|auth_domain_put
c_func
(paren
id|dom
)paren
suffix:semicolon
id|cache_flush
c_func
(paren
)paren
suffix:semicolon
id|out_unlock
suffix:colon
id|exp_writeunlock
c_func
(paren
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*&n; * Obtain the root fh on behalf of a client.&n; * This could be done in user space, but I feel that it adds some safety&n; * since its harder to fool a kernel module than a user space program.&n; */
r_int
DECL|function|exp_rootfh
id|exp_rootfh
c_func
(paren
id|svc_client
op_star
id|clp
comma
r_char
op_star
id|path
comma
r_struct
id|knfsd_fh
op_star
id|f
comma
r_int
id|maxsize
)paren
(brace
r_struct
id|svc_export
op_star
id|exp
suffix:semicolon
r_struct
id|nameidata
id|nd
suffix:semicolon
r_struct
id|inode
op_star
id|inode
suffix:semicolon
r_struct
id|svc_fh
id|fh
suffix:semicolon
r_int
id|err
suffix:semicolon
id|err
op_assign
op_minus
id|EPERM
suffix:semicolon
multiline_comment|/* NB: we probably ought to check that it&squot;s NUL-terminated */
r_if
c_cond
(paren
id|path_lookup
c_func
(paren
id|path
comma
l_int|0
comma
op_amp
id|nd
)paren
)paren
(brace
id|printk
c_func
(paren
l_string|&quot;nfsd: exp_rootfh path not found %s&quot;
comma
id|path
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
id|inode
op_assign
id|nd.dentry-&gt;d_inode
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;nfsd: exp_rootfh(%s [%p] %s:%s/%ld)&bslash;n&quot;
comma
id|path
comma
id|nd.dentry
comma
id|clp-&gt;name
comma
id|inode-&gt;i_sb-&gt;s_id
comma
id|inode-&gt;i_ino
)paren
suffix:semicolon
id|exp
op_assign
id|exp_parent
c_func
(paren
id|clp
comma
id|nd.mnt
comma
id|nd.dentry
comma
l_int|NULL
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|exp
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;nfsd: exp_rootfh export not found.&bslash;n&quot;
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
multiline_comment|/*&n;&t; * fh must be initialized before calling fh_compose&n;&t; */
id|fh_init
c_func
(paren
op_amp
id|fh
comma
id|maxsize
)paren
suffix:semicolon
r_if
c_cond
(paren
id|fh_compose
c_func
(paren
op_amp
id|fh
comma
id|exp
comma
id|nd.dentry
comma
l_int|NULL
)paren
)paren
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_else
id|err
op_assign
l_int|0
suffix:semicolon
id|memcpy
c_func
(paren
id|f
comma
op_amp
id|fh.fh_handle
comma
r_sizeof
(paren
r_struct
id|knfsd_fh
)paren
)paren
suffix:semicolon
id|fh_put
c_func
(paren
op_amp
id|fh
)paren
suffix:semicolon
id|exp_put
c_func
(paren
id|exp
)paren
suffix:semicolon
id|out
suffix:colon
id|path_release
c_func
(paren
op_amp
id|nd
)paren
suffix:semicolon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*&n; * Called when we need the filehandle for the root of the pseudofs,&n; * for a given NFSv4 client.   The root is defined to be the&n; * export point with fsid==0&n; */
r_int
DECL|function|exp_pseudoroot
id|exp_pseudoroot
c_func
(paren
r_struct
id|auth_domain
op_star
id|clp
comma
r_struct
id|svc_fh
op_star
id|fhp
comma
r_struct
id|cache_req
op_star
id|creq
)paren
(brace
r_struct
id|svc_expkey
op_star
id|fsid_key
suffix:semicolon
r_int
id|rv
suffix:semicolon
id|u32
id|fsidv
(braket
l_int|2
)braket
suffix:semicolon
id|mk_fsid_v1
c_func
(paren
id|fsidv
comma
l_int|0
)paren
suffix:semicolon
id|fsid_key
op_assign
id|exp_find_key
c_func
(paren
id|clp
comma
l_int|1
comma
id|fsidv
comma
id|creq
)paren
suffix:semicolon
r_if
c_cond
(paren
id|IS_ERR
c_func
(paren
id|fsid_key
)paren
op_logical_and
id|PTR_ERR
c_func
(paren
id|fsid_key
)paren
op_eq
op_minus
id|EAGAIN
)paren
r_return
id|nfserr_dropit
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|fsid_key
op_logical_or
id|IS_ERR
c_func
(paren
id|fsid_key
)paren
)paren
r_return
id|nfserr_perm
suffix:semicolon
id|rv
op_assign
id|fh_compose
c_func
(paren
id|fhp
comma
id|fsid_key-&gt;ek_export
comma
id|fsid_key-&gt;ek_export-&gt;ex_dentry
comma
l_int|NULL
)paren
suffix:semicolon
id|expkey_put
c_func
(paren
op_amp
id|fsid_key-&gt;h
comma
op_amp
id|svc_expkey_cache
)paren
suffix:semicolon
r_return
id|rv
suffix:semicolon
)brace
multiline_comment|/* Iterator */
DECL|function|e_start
r_static
r_void
op_star
id|e_start
c_func
(paren
r_struct
id|seq_file
op_star
id|m
comma
id|loff_t
op_star
id|pos
)paren
(brace
id|loff_t
id|n
op_assign
op_star
id|pos
suffix:semicolon
r_int
id|hash
comma
id|export
suffix:semicolon
r_struct
id|cache_head
op_star
id|ch
suffix:semicolon
id|exp_readlock
c_func
(paren
)paren
suffix:semicolon
id|read_lock
c_func
(paren
op_amp
id|svc_export_cache.hash_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|n
op_decrement
)paren
r_return
(paren
r_void
op_star
)paren
l_int|1
suffix:semicolon
id|hash
op_assign
id|n
op_rshift
l_int|32
suffix:semicolon
id|export
op_assign
id|n
op_amp
(paren
(paren
l_int|1LL
op_lshift
l_int|32
)paren
op_minus
l_int|1
)paren
suffix:semicolon
r_for
c_loop
(paren
id|ch
op_assign
id|export_table
(braket
id|hash
)braket
suffix:semicolon
id|ch
suffix:semicolon
id|ch
op_assign
id|ch-&gt;next
)paren
r_if
c_cond
(paren
op_logical_neg
id|export
op_decrement
)paren
r_return
id|ch
suffix:semicolon
id|n
op_and_assign
op_complement
(paren
(paren
l_int|1LL
op_lshift
l_int|32
)paren
op_minus
l_int|1
)paren
suffix:semicolon
r_do
(brace
id|hash
op_increment
suffix:semicolon
id|n
op_add_assign
l_int|1LL
op_lshift
l_int|32
suffix:semicolon
)brace
r_while
c_loop
(paren
id|hash
OL
id|EXPORT_HASHMAX
op_logical_and
id|export_table
(braket
id|hash
)braket
op_eq
l_int|NULL
)paren
(brace
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hash
op_ge
id|EXPORT_HASHMAX
)paren
r_return
l_int|NULL
suffix:semicolon
op_star
id|pos
op_assign
id|n
op_plus
l_int|1
suffix:semicolon
r_return
id|export_table
(braket
id|hash
)braket
suffix:semicolon
)brace
DECL|function|e_next
r_static
r_void
op_star
id|e_next
c_func
(paren
r_struct
id|seq_file
op_star
id|m
comma
r_void
op_star
id|p
comma
id|loff_t
op_star
id|pos
)paren
(brace
r_struct
id|cache_head
op_star
id|ch
op_assign
id|p
suffix:semicolon
r_int
id|hash
op_assign
(paren
op_star
id|pos
op_rshift
l_int|32
)paren
suffix:semicolon
r_if
c_cond
(paren
id|p
op_eq
(paren
r_void
op_star
)paren
l_int|1
)paren
id|hash
op_assign
l_int|0
suffix:semicolon
r_else
r_if
c_cond
(paren
id|ch-&gt;next
op_eq
l_int|NULL
)paren
(brace
id|hash
op_increment
suffix:semicolon
op_star
id|pos
op_add_assign
l_int|1LL
op_lshift
l_int|32
suffix:semicolon
)brace
r_else
(brace
op_increment
op_star
id|pos
suffix:semicolon
r_return
id|ch-&gt;next
suffix:semicolon
)brace
op_star
id|pos
op_and_assign
op_complement
(paren
(paren
l_int|1LL
op_lshift
l_int|32
)paren
op_minus
l_int|1
)paren
suffix:semicolon
r_while
c_loop
(paren
id|hash
OL
id|EXPORT_HASHMAX
op_logical_and
id|export_table
(braket
id|hash
)braket
op_eq
l_int|NULL
)paren
(brace
id|hash
op_increment
suffix:semicolon
op_star
id|pos
op_add_assign
l_int|1LL
op_lshift
l_int|32
suffix:semicolon
)brace
r_if
c_cond
(paren
id|hash
op_ge
id|EXPORT_HASHMAX
)paren
r_return
l_int|NULL
suffix:semicolon
op_increment
op_star
id|pos
suffix:semicolon
r_return
id|export_table
(braket
id|hash
)braket
suffix:semicolon
)brace
DECL|function|e_stop
r_static
r_void
id|e_stop
c_func
(paren
r_struct
id|seq_file
op_star
id|m
comma
r_void
op_star
id|p
)paren
(brace
id|read_unlock
c_func
(paren
op_amp
id|svc_export_cache.hash_lock
)paren
suffix:semicolon
id|exp_readunlock
c_func
(paren
)paren
suffix:semicolon
)brace
DECL|struct|flags
r_struct
id|flags
(brace
DECL|member|flag
r_int
id|flag
suffix:semicolon
DECL|member|name
r_char
op_star
id|name
(braket
l_int|2
)braket
suffix:semicolon
DECL|variable|expflags
)brace
id|expflags
(braket
)braket
op_assign
(brace
(brace
id|NFSEXP_READONLY
comma
(brace
l_string|&quot;ro&quot;
comma
l_string|&quot;rw&quot;
)brace
)brace
comma
(brace
id|NFSEXP_INSECURE_PORT
comma
(brace
l_string|&quot;insecure&quot;
comma
l_string|&quot;&quot;
)brace
)brace
comma
(brace
id|NFSEXP_ROOTSQUASH
comma
(brace
l_string|&quot;root_squash&quot;
comma
l_string|&quot;no_root_squash&quot;
)brace
)brace
comma
(brace
id|NFSEXP_ALLSQUASH
comma
(brace
l_string|&quot;all_squash&quot;
comma
l_string|&quot;&quot;
)brace
)brace
comma
(brace
id|NFSEXP_ASYNC
comma
(brace
l_string|&quot;async&quot;
comma
l_string|&quot;sync&quot;
)brace
)brace
comma
(brace
id|NFSEXP_GATHERED_WRITES
comma
(brace
l_string|&quot;wdelay&quot;
comma
l_string|&quot;no_wdelay&quot;
)brace
)brace
comma
(brace
id|NFSEXP_NOHIDE
comma
(brace
l_string|&quot;nohide&quot;
comma
l_string|&quot;&quot;
)brace
)brace
comma
(brace
id|NFSEXP_CROSSMOUNT
comma
(brace
l_string|&quot;crossmnt&quot;
comma
l_string|&quot;&quot;
)brace
)brace
comma
(brace
id|NFSEXP_NOSUBTREECHECK
comma
(brace
l_string|&quot;no_subtree_check&quot;
comma
l_string|&quot;&quot;
)brace
)brace
comma
(brace
id|NFSEXP_NOAUTHNLM
comma
(brace
l_string|&quot;insecure_locks&quot;
comma
l_string|&quot;&quot;
)brace
)brace
comma
macro_line|#ifdef MSNFS
(brace
id|NFSEXP_MSNFS
comma
(brace
l_string|&quot;msnfs&quot;
comma
l_string|&quot;&quot;
)brace
)brace
comma
macro_line|#endif
(brace
l_int|0
comma
(brace
l_string|&quot;&quot;
comma
l_string|&quot;&quot;
)brace
)brace
)brace
suffix:semicolon
DECL|function|exp_flags
r_static
r_void
id|exp_flags
c_func
(paren
r_struct
id|seq_file
op_star
id|m
comma
r_int
id|flag
comma
r_int
id|fsid
comma
id|uid_t
id|anonu
comma
id|uid_t
id|anong
)paren
(brace
r_int
id|first
op_assign
l_int|0
suffix:semicolon
r_struct
id|flags
op_star
id|flg
suffix:semicolon
r_for
c_loop
(paren
id|flg
op_assign
id|expflags
suffix:semicolon
id|flg-&gt;flag
suffix:semicolon
id|flg
op_increment
)paren
(brace
r_int
id|state
op_assign
(paren
id|flg-&gt;flag
op_amp
id|flag
)paren
ques
c_cond
l_int|0
suffix:colon
l_int|1
suffix:semicolon
r_if
c_cond
(paren
op_star
id|flg-&gt;name
(braket
id|state
)braket
)paren
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;%s%s&quot;
comma
id|first
op_increment
ques
c_cond
l_string|&quot;,&quot;
suffix:colon
l_string|&quot;&quot;
comma
id|flg-&gt;name
(braket
id|state
)braket
)paren
suffix:semicolon
)brace
r_if
c_cond
(paren
id|flag
op_amp
id|NFSEXP_FSID
)paren
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;%sfsid=%d&quot;
comma
id|first
op_increment
ques
c_cond
l_string|&quot;,&quot;
suffix:colon
l_string|&quot;&quot;
comma
id|fsid
)paren
suffix:semicolon
r_if
c_cond
(paren
id|anonu
op_ne
(paren
id|uid_t
)paren
op_minus
l_int|2
op_logical_and
id|anonu
op_ne
(paren
l_int|0x10000
op_minus
l_int|2
)paren
)paren
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;%sanonuid=%d&quot;
comma
id|first
op_increment
ques
c_cond
l_string|&quot;,&quot;
suffix:colon
l_string|&quot;&quot;
comma
id|anonu
)paren
suffix:semicolon
r_if
c_cond
(paren
id|anong
op_ne
(paren
id|gid_t
)paren
op_minus
l_int|2
op_logical_and
id|anong
op_ne
(paren
l_int|0x10000
op_minus
l_int|2
)paren
)paren
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;%sanongid=%d&quot;
comma
id|first
op_increment
ques
c_cond
l_string|&quot;,&quot;
suffix:colon
l_string|&quot;&quot;
comma
id|anong
)paren
suffix:semicolon
)brace
DECL|function|e_show
r_static
r_int
id|e_show
c_func
(paren
r_struct
id|seq_file
op_star
id|m
comma
r_void
op_star
id|p
)paren
(brace
r_struct
id|cache_head
op_star
id|cp
op_assign
id|p
suffix:semicolon
r_struct
id|svc_export
op_star
id|exp
op_assign
id|container_of
c_func
(paren
id|cp
comma
r_struct
id|svc_export
comma
id|h
)paren
suffix:semicolon
id|svc_client
op_star
id|clp
suffix:semicolon
r_if
c_cond
(paren
id|p
op_eq
(paren
r_void
op_star
)paren
l_int|1
)paren
(brace
id|seq_puts
c_func
(paren
id|m
comma
l_string|&quot;# Version 1.1&bslash;n&quot;
)paren
suffix:semicolon
id|seq_puts
c_func
(paren
id|m
comma
l_string|&quot;# Path Client(Flags) # IPs&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|clp
op_assign
id|exp-&gt;ex_client
suffix:semicolon
id|cache_get
c_func
(paren
op_amp
id|exp-&gt;h
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cache_check
c_func
(paren
op_amp
id|svc_export_cache
comma
op_amp
id|exp-&gt;h
comma
l_int|NULL
)paren
)paren
r_return
l_int|0
suffix:semicolon
r_if
c_cond
(paren
id|cache_put
c_func
(paren
op_amp
id|exp-&gt;h
comma
op_amp
id|svc_export_cache
)paren
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
r_return
id|svc_export_show
c_func
(paren
id|m
comma
op_amp
id|svc_export_cache
comma
id|cp
)paren
suffix:semicolon
)brace
DECL|variable|nfs_exports_op
r_struct
id|seq_operations
id|nfs_exports_op
op_assign
(brace
dot
id|start
op_assign
id|e_start
comma
dot
id|next
op_assign
id|e_next
comma
dot
id|stop
op_assign
id|e_stop
comma
dot
id|show
op_assign
id|e_show
comma
)brace
suffix:semicolon
multiline_comment|/*&n; * Add or modify a client.&n; * Change requests may involve the list of host addresses. The list of&n; * exports and possibly existing uid maps are left untouched.&n; */
r_int
DECL|function|exp_addclient
id|exp_addclient
c_func
(paren
r_struct
id|nfsctl_client
op_star
id|ncp
)paren
(brace
r_struct
id|auth_domain
op_star
id|dom
suffix:semicolon
r_int
id|i
comma
id|err
suffix:semicolon
multiline_comment|/* First, consistency check. */
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|exp_verify_string
c_func
(paren
id|ncp-&gt;cl_ident
comma
id|NFSCLNT_IDMAX
)paren
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|ncp-&gt;cl_naddr
OG
id|NFSCLNT_ADDRMAX
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* Lock the hashtable */
id|exp_writelock
c_func
(paren
)paren
suffix:semicolon
id|dom
op_assign
id|unix_domain_find
c_func
(paren
id|ncp-&gt;cl_ident
)paren
suffix:semicolon
id|err
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|dom
)paren
r_goto
id|out_unlock
suffix:semicolon
multiline_comment|/* Insert client into hashtable. */
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|ncp-&gt;cl_naddr
suffix:semicolon
id|i
op_increment
)paren
id|auth_unix_add_addr
c_func
(paren
id|ncp-&gt;cl_addrlist
(braket
id|i
)braket
comma
id|dom
)paren
suffix:semicolon
id|auth_unix_forget_old
c_func
(paren
id|dom
)paren
suffix:semicolon
id|auth_domain_put
c_func
(paren
id|dom
)paren
suffix:semicolon
id|err
op_assign
l_int|0
suffix:semicolon
id|out_unlock
suffix:colon
id|exp_writeunlock
c_func
(paren
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*&n; * Delete a client given an identifier.&n; */
r_int
DECL|function|exp_delclient
id|exp_delclient
c_func
(paren
r_struct
id|nfsctl_client
op_star
id|ncp
)paren
(brace
r_int
id|err
suffix:semicolon
r_struct
id|auth_domain
op_star
id|dom
suffix:semicolon
id|err
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|exp_verify_string
c_func
(paren
id|ncp-&gt;cl_ident
comma
id|NFSCLNT_IDMAX
)paren
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* Lock the hashtable */
id|exp_writelock
c_func
(paren
)paren
suffix:semicolon
id|dom
op_assign
id|auth_domain_find
c_func
(paren
id|ncp-&gt;cl_ident
)paren
suffix:semicolon
multiline_comment|/* just make sure that no addresses work &n;&t; * and that it will expire soon &n;&t; */
r_if
c_cond
(paren
id|dom
)paren
(brace
id|err
op_assign
id|auth_unix_forget_old
c_func
(paren
id|dom
)paren
suffix:semicolon
id|dom-&gt;h.expiry_time
op_assign
id|get_seconds
c_func
(paren
)paren
suffix:semicolon
id|auth_domain_put
c_func
(paren
id|dom
)paren
suffix:semicolon
)brace
id|exp_writeunlock
c_func
(paren
)paren
suffix:semicolon
id|out
suffix:colon
r_return
id|err
suffix:semicolon
)brace
multiline_comment|/*&n; * Verify that string is non-empty and does not exceed max length.&n; */
r_static
r_int
DECL|function|exp_verify_string
id|exp_verify_string
c_func
(paren
r_char
op_star
id|cp
comma
r_int
id|max
)paren
(brace
r_int
id|i
suffix:semicolon
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|max
suffix:semicolon
id|i
op_increment
)paren
r_if
c_cond
(paren
op_logical_neg
id|cp
(braket
id|i
)braket
)paren
r_return
id|i
suffix:semicolon
id|cp
(braket
id|i
)braket
op_assign
l_int|0
suffix:semicolon
id|printk
c_func
(paren
id|KERN_NOTICE
l_string|&quot;nfsd: couldn&squot;t validate string %s&bslash;n&quot;
comma
id|cp
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
multiline_comment|/*&n; * Initialize the exports module.&n; */
r_void
DECL|function|nfsd_export_init
id|nfsd_export_init
c_func
(paren
r_void
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;nfsd: initializing export module.&bslash;n&quot;
)paren
suffix:semicolon
id|cache_register
c_func
(paren
op_amp
id|svc_export_cache
)paren
suffix:semicolon
id|cache_register
c_func
(paren
op_amp
id|svc_expkey_cache
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Flush exports table - called when last nfsd thread is killed&n; */
r_void
DECL|function|nfsd_export_flush
id|nfsd_export_flush
c_func
(paren
r_void
)paren
(brace
id|exp_writelock
c_func
(paren
)paren
suffix:semicolon
id|cache_purge
c_func
(paren
op_amp
id|svc_expkey_cache
)paren
suffix:semicolon
id|cache_purge
c_func
(paren
op_amp
id|svc_export_cache
)paren
suffix:semicolon
id|exp_writeunlock
c_func
(paren
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Shutdown the exports module.&n; */
r_void
DECL|function|nfsd_export_shutdown
id|nfsd_export_shutdown
c_func
(paren
r_void
)paren
(brace
id|dprintk
c_func
(paren
l_string|&quot;nfsd: shutting down export module.&bslash;n&quot;
)paren
suffix:semicolon
id|exp_writelock
c_func
(paren
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cache_unregister
c_func
(paren
op_amp
id|svc_expkey_cache
)paren
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;nfsd: failed to unregister expkey cache&bslash;n&quot;
)paren
suffix:semicolon
r_if
c_cond
(paren
id|cache_unregister
c_func
(paren
op_amp
id|svc_export_cache
)paren
)paren
id|printk
c_func
(paren
id|KERN_ERR
l_string|&quot;nfsd: failed to unregister export cache&bslash;n&quot;
)paren
suffix:semicolon
id|svcauth_unix_purge
c_func
(paren
)paren
suffix:semicolon
id|exp_writeunlock
c_func
(paren
)paren
suffix:semicolon
id|dprintk
c_func
(paren
l_string|&quot;nfsd: export shutdown complete.&bslash;n&quot;
)paren
suffix:semicolon
)brace
eof
