multiline_comment|/*&n; * linux/fs/nfsd/auth.c&n; *&n; * Copyright (C) 1995, 1996 Olaf Kirch &lt;okir@monad.swb.de&gt;&n; */
macro_line|#include &lt;linux/types.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/sunrpc/svc.h&gt;
macro_line|#include &lt;linux/sunrpc/svcauth.h&gt;
macro_line|#include &lt;linux/nfsd/nfsd.h&gt;
DECL|macro|CAP_NFSD_MASK
mdefine_line|#define&t;CAP_NFSD_MASK (CAP_FS_MASK|CAP_TO_MASK(CAP_SYS_RESOURCE))
DECL|function|nfsd_setuser
r_int
id|nfsd_setuser
c_func
(paren
r_struct
id|svc_rqst
op_star
id|rqstp
comma
r_struct
id|svc_export
op_star
id|exp
)paren
(brace
r_struct
id|svc_cred
op_star
id|cred
op_assign
op_amp
id|rqstp-&gt;rq_cred
suffix:semicolon
r_int
id|i
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
id|exp-&gt;ex_flags
op_amp
id|NFSEXP_ALLSQUASH
)paren
(brace
id|cred-&gt;cr_uid
op_assign
id|exp-&gt;ex_anon_uid
suffix:semicolon
id|cred-&gt;cr_gid
op_assign
id|exp-&gt;ex_anon_gid
suffix:semicolon
id|put_group_info
c_func
(paren
id|cred-&gt;cr_group_info
)paren
suffix:semicolon
id|cred-&gt;cr_group_info
op_assign
id|groups_alloc
c_func
(paren
l_int|0
)paren
suffix:semicolon
)brace
r_else
r_if
c_cond
(paren
id|exp-&gt;ex_flags
op_amp
id|NFSEXP_ROOTSQUASH
)paren
(brace
r_struct
id|group_info
op_star
id|gi
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cred-&gt;cr_uid
)paren
id|cred-&gt;cr_uid
op_assign
id|exp-&gt;ex_anon_uid
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cred-&gt;cr_gid
)paren
id|cred-&gt;cr_gid
op_assign
id|exp-&gt;ex_anon_gid
suffix:semicolon
id|gi
op_assign
id|groups_alloc
c_func
(paren
id|cred-&gt;cr_group_info-&gt;ngroups
)paren
suffix:semicolon
r_if
c_cond
(paren
id|gi
)paren
r_for
c_loop
(paren
id|i
op_assign
l_int|0
suffix:semicolon
id|i
OL
id|cred-&gt;cr_group_info-&gt;ngroups
suffix:semicolon
id|i
op_increment
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|GROUP_AT
c_func
(paren
id|cred-&gt;cr_group_info
comma
id|i
)paren
)paren
id|GROUP_AT
c_func
(paren
id|gi
comma
id|i
)paren
op_assign
id|exp-&gt;ex_anon_gid
suffix:semicolon
r_else
id|GROUP_AT
c_func
(paren
id|gi
comma
id|i
)paren
op_assign
id|GROUP_AT
c_func
(paren
id|cred-&gt;cr_group_info
comma
id|i
)paren
suffix:semicolon
)brace
id|put_group_info
c_func
(paren
id|cred-&gt;cr_group_info
)paren
suffix:semicolon
id|cred-&gt;cr_group_info
op_assign
id|gi
suffix:semicolon
)brace
r_if
c_cond
(paren
id|cred-&gt;cr_uid
op_ne
(paren
id|uid_t
)paren
op_minus
l_int|1
)paren
id|current-&gt;fsuid
op_assign
id|cred-&gt;cr_uid
suffix:semicolon
r_else
id|current-&gt;fsuid
op_assign
id|exp-&gt;ex_anon_uid
suffix:semicolon
r_if
c_cond
(paren
id|cred-&gt;cr_gid
op_ne
(paren
id|gid_t
)paren
op_minus
l_int|1
)paren
id|current-&gt;fsgid
op_assign
id|cred-&gt;cr_gid
suffix:semicolon
r_else
id|current-&gt;fsgid
op_assign
id|exp-&gt;ex_anon_gid
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|cred-&gt;cr_group_info
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|ret
op_assign
id|set_current_groups
c_func
(paren
id|cred-&gt;cr_group_info
)paren
suffix:semicolon
r_if
c_cond
(paren
(paren
id|cred-&gt;cr_uid
)paren
)paren
(brace
id|cap_t
c_func
(paren
id|current-&gt;cap_effective
)paren
op_and_assign
op_complement
id|CAP_NFSD_MASK
suffix:semicolon
)brace
r_else
(brace
id|cap_t
c_func
(paren
id|current-&gt;cap_effective
)paren
op_or_assign
(paren
id|CAP_NFSD_MASK
op_amp
id|current-&gt;cap_permitted
)paren
suffix:semicolon
)brace
r_return
id|ret
suffix:semicolon
)brace
eof
