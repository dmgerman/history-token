multiline_comment|/*&n; *  fs/nfsd/nfs4idmap.c&n; *&n; *  Mapping of UID/GIDs to name and vice versa.&n; *&n; *  Copyright (c) 2002, 2003 The Regents of the University of&n; *  Michigan.  All rights reserved.&n; *&n; *  Marius Aamodt Eriksen &lt;marius@umich.edu&gt;&n; *&n; *  Redistribution and use in source and binary forms, with or without&n; *  modification, are permitted provided that the following conditions&n; *  are met:&n; *&n; *  1. Redistributions of source code must retain the above copyright&n; *     notice, this list of conditions and the following disclaimer.&n; *  2. Redistributions in binary form must reproduce the above copyright&n; *     notice, this list of conditions and the following disclaimer in the&n; *     documentation and/or other materials provided with the distribution.&n; *  3. Neither the name of the University nor the names of its&n; *     contributors may be used to endorse or promote products derived&n; *     from this software without specific prior written permission.&n; *&n; *  THIS SOFTWARE IS PROVIDED ``AS IS&squot;&squot; AND ANY EXPRESS OR IMPLIED&n; *  WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF&n; *  MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE&n; *  DISCLAIMED. IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE&n; *  FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR&n; *  CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF&n; *  SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR&n; *  BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF&n; *  LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING&n; *  NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS&n; *  SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.&n; */
macro_line|#include &lt;linux/config.h&gt;
macro_line|#include &lt;linux/module.h&gt;
macro_line|#include &lt;linux/init.h&gt;
macro_line|#include &lt;linux/mm.h&gt;
macro_line|#include &lt;linux/utsname.h&gt;
macro_line|#include &lt;linux/errno.h&gt;
macro_line|#include &lt;linux/string.h&gt;
macro_line|#include &lt;linux/sunrpc/clnt.h&gt;
macro_line|#include &lt;linux/nfs.h&gt;
macro_line|#include &lt;linux/nfs4.h&gt;
macro_line|#include &lt;linux/nfs_fs.h&gt;
macro_line|#include &lt;linux/nfs_page.h&gt;
macro_line|#include &lt;linux/smp_lock.h&gt;
macro_line|#include &lt;linux/sunrpc/cache.h&gt;
macro_line|#include &lt;linux/nfsd_idmap.h&gt;
macro_line|#include &lt;linux/list.h&gt;
macro_line|#include &lt;linux/sched.h&gt;
macro_line|#include &lt;linux/time.h&gt;
macro_line|#include &lt;linux/seq_file.h&gt;
macro_line|#include &lt;linux/sunrpc/svcauth.h&gt;
multiline_comment|/*&n; * Cache entry&n; */
multiline_comment|/*&n; * XXX we know that IDMAP_NAMESZ &lt; PAGE_SIZE, but it&squot;s ugly to rely on&n; * that.&n; */
DECL|macro|IDMAP_TYPE_USER
mdefine_line|#define IDMAP_TYPE_USER  0
DECL|macro|IDMAP_TYPE_GROUP
mdefine_line|#define IDMAP_TYPE_GROUP 1
DECL|struct|ent
r_struct
id|ent
(brace
DECL|member|h
r_struct
id|cache_head
id|h
suffix:semicolon
DECL|member|type
r_int
id|type
suffix:semicolon
multiline_comment|/* User / Group */
DECL|member|id
id|uid_t
id|id
suffix:semicolon
DECL|member|name
r_char
id|name
(braket
id|IDMAP_NAMESZ
)braket
suffix:semicolon
DECL|member|authname
r_char
id|authname
(braket
id|IDMAP_NAMESZ
)braket
suffix:semicolon
)brace
suffix:semicolon
DECL|macro|DefineSimpleCacheLookupMap
mdefine_line|#define DefineSimpleCacheLookupMap(STRUCT, FUNC)&t;&t;&t;&bslash;&n;        DefineCacheLookup(struct STRUCT, h, FUNC##_lookup,&t;&t;&bslash;&n;        (struct STRUCT *item, int set), /*no setup */,&t;&t;&t;&bslash;&n;&t;&amp; FUNC##_cache, FUNC##_hash(item), FUNC##_match(item, tmp),&t;&bslash;&n;&t;STRUCT##_init(new, item), STRUCT##_update(tmp, item), 0)
multiline_comment|/* Common entry handling */
DECL|macro|ENT_HASHBITS
mdefine_line|#define ENT_HASHBITS          8
DECL|macro|ENT_HASHMAX
mdefine_line|#define ENT_HASHMAX           (1 &lt;&lt; ENT_HASHBITS)
DECL|macro|ENT_HASHMASK
mdefine_line|#define ENT_HASHMASK          (ENT_HASHMAX - 1)
r_static
r_inline
r_void
DECL|function|ent_init
id|ent_init
c_func
(paren
r_struct
id|ent
op_star
r_new
comma
r_struct
id|ent
op_star
id|itm
)paren
(brace
r_new
op_member_access_from_pointer
id|id
op_assign
id|itm-&gt;id
suffix:semicolon
r_new
op_member_access_from_pointer
id|type
op_assign
id|itm-&gt;type
suffix:semicolon
id|strlcpy
c_func
(paren
r_new
op_member_access_from_pointer
id|name
comma
id|itm-&gt;name
comma
r_sizeof
(paren
r_new
op_member_access_from_pointer
id|name
)paren
)paren
suffix:semicolon
id|strlcpy
c_func
(paren
r_new
op_member_access_from_pointer
id|authname
comma
id|itm-&gt;authname
comma
r_sizeof
(paren
r_new
op_member_access_from_pointer
id|name
)paren
)paren
suffix:semicolon
)brace
r_static
r_inline
r_void
DECL|function|ent_update
id|ent_update
c_func
(paren
r_struct
id|ent
op_star
r_new
comma
r_struct
id|ent
op_star
id|itm
)paren
(brace
id|ent_init
c_func
(paren
r_new
comma
id|itm
)paren
suffix:semicolon
)brace
r_void
DECL|function|ent_put
id|ent_put
c_func
(paren
r_struct
id|cache_head
op_star
id|ch
comma
r_struct
id|cache_detail
op_star
id|cd
)paren
(brace
r_if
c_cond
(paren
id|cache_put
c_func
(paren
id|ch
comma
id|cd
)paren
)paren
(brace
r_struct
id|ent
op_star
id|map
op_assign
id|container_of
c_func
(paren
id|ch
comma
r_struct
id|ent
comma
id|h
)paren
suffix:semicolon
id|kfree
c_func
(paren
id|map
)paren
suffix:semicolon
)brace
)brace
multiline_comment|/*&n; * ID -&gt; Name cache&n; */
DECL|variable|idtoname_table
r_static
r_struct
id|cache_head
op_star
id|idtoname_table
(braket
id|ENT_HASHMAX
)braket
suffix:semicolon
r_static
r_uint32
DECL|function|idtoname_hash
id|idtoname_hash
c_func
(paren
r_struct
id|ent
op_star
id|ent
)paren
(brace
r_uint32
id|hash
suffix:semicolon
id|hash
op_assign
id|hash_str
c_func
(paren
id|ent-&gt;authname
comma
id|ENT_HASHBITS
)paren
suffix:semicolon
id|hash
op_assign
id|hash_long
c_func
(paren
id|hash
op_xor
id|ent-&gt;id
comma
id|ENT_HASHBITS
)paren
suffix:semicolon
multiline_comment|/* Flip LSB for user/group */
r_if
c_cond
(paren
id|ent-&gt;type
op_eq
id|IDMAP_TYPE_GROUP
)paren
id|hash
op_xor_assign
l_int|1
suffix:semicolon
r_return
id|hash
suffix:semicolon
)brace
r_static
r_void
DECL|function|idtoname_request
id|idtoname_request
c_func
(paren
r_struct
id|cache_detail
op_star
id|cd
comma
r_struct
id|cache_head
op_star
id|ch
comma
r_char
op_star
op_star
id|bpp
comma
r_int
op_star
id|blen
)paren
(brace
r_struct
id|ent
op_star
id|ent
op_assign
id|container_of
c_func
(paren
id|ch
comma
r_struct
id|ent
comma
id|h
)paren
suffix:semicolon
r_char
id|idstr
(braket
l_int|11
)braket
suffix:semicolon
id|qword_add
c_func
(paren
id|bpp
comma
id|blen
comma
id|ent-&gt;authname
)paren
suffix:semicolon
id|snprintf
c_func
(paren
id|idstr
comma
r_sizeof
(paren
id|idstr
)paren
comma
l_string|&quot;%d&quot;
comma
id|ent-&gt;id
)paren
suffix:semicolon
id|qword_add
c_func
(paren
id|bpp
comma
id|blen
comma
id|ent-&gt;type
op_eq
id|IDMAP_TYPE_GROUP
ques
c_cond
l_string|&quot;group&quot;
suffix:colon
l_string|&quot;user&quot;
)paren
suffix:semicolon
id|qword_add
c_func
(paren
id|bpp
comma
id|blen
comma
id|idstr
)paren
suffix:semicolon
(paren
op_star
id|bpp
)paren
(braket
op_minus
l_int|1
)braket
op_assign
l_char|&squot;&bslash;n&squot;
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|idtoname_match
id|idtoname_match
c_func
(paren
r_struct
id|ent
op_star
id|a
comma
r_struct
id|ent
op_star
id|b
)paren
(brace
r_return
(paren
id|a-&gt;id
op_eq
id|b-&gt;id
op_logical_and
id|a-&gt;type
op_eq
id|b-&gt;type
op_logical_and
id|strcmp
c_func
(paren
id|a-&gt;authname
comma
id|b-&gt;authname
)paren
op_eq
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|idtoname_show
id|idtoname_show
c_func
(paren
r_struct
id|seq_file
op_star
id|m
comma
r_struct
id|cache_detail
op_star
id|cd
comma
r_struct
id|cache_head
op_star
id|h
)paren
(brace
r_struct
id|ent
op_star
id|ent
suffix:semicolon
r_if
c_cond
(paren
id|h
op_eq
l_int|NULL
)paren
(brace
id|seq_puts
c_func
(paren
id|m
comma
l_string|&quot;#domain type id [name]&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|ent
op_assign
id|container_of
c_func
(paren
id|h
comma
r_struct
id|ent
comma
id|h
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;%s %s %d&quot;
comma
id|ent-&gt;authname
comma
id|ent-&gt;type
op_eq
id|IDMAP_TYPE_GROUP
ques
c_cond
l_string|&quot;group&quot;
suffix:colon
l_string|&quot;user&quot;
comma
id|ent-&gt;id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|CACHE_VALID
comma
op_amp
id|h-&gt;flags
)paren
)paren
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot; %s&quot;
comma
id|ent-&gt;name
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
id|idtoname_parse
c_func
(paren
r_struct
id|cache_detail
op_star
comma
r_char
op_star
comma
r_int
)paren
suffix:semicolon
r_static
r_struct
id|ent
op_star
id|idtoname_lookup
c_func
(paren
r_struct
id|ent
op_star
comma
r_int
)paren
suffix:semicolon
DECL|variable|idtoname_cache
r_struct
id|cache_detail
id|idtoname_cache
op_assign
(brace
dot
id|hash_size
op_assign
id|ENT_HASHMAX
comma
dot
id|hash_table
op_assign
id|idtoname_table
comma
dot
id|name
op_assign
l_string|&quot;nfs4.idtoname&quot;
comma
dot
id|cache_put
op_assign
id|ent_put
comma
dot
id|cache_request
op_assign
id|idtoname_request
comma
dot
id|cache_parse
op_assign
id|idtoname_parse
comma
dot
id|cache_show
op_assign
id|idtoname_show
comma
)brace
suffix:semicolon
r_int
DECL|function|idtoname_parse
id|idtoname_parse
c_func
(paren
r_struct
id|cache_detail
op_star
id|cd
comma
r_char
op_star
id|buf
comma
r_int
id|buflen
)paren
(brace
r_struct
id|ent
id|ent
comma
op_star
id|res
suffix:semicolon
r_char
op_star
id|buf1
comma
op_star
id|bp
suffix:semicolon
r_int
id|error
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|buf
(braket
id|buflen
op_minus
l_int|1
)braket
op_ne
l_char|&squot;&bslash;n&squot;
)paren
r_return
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
id|buf
(braket
id|buflen
op_minus
l_int|1
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|buf1
op_assign
id|kmalloc
c_func
(paren
id|PAGE_SIZE
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buf1
op_eq
l_int|NULL
)paren
r_return
(paren
op_minus
id|ENOMEM
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|ent
comma
l_int|0
comma
r_sizeof
(paren
id|ent
)paren
)paren
suffix:semicolon
multiline_comment|/* Authentication name */
r_if
c_cond
(paren
id|qword_get
c_func
(paren
op_amp
id|buf
comma
id|buf1
comma
id|PAGE_SIZE
)paren
op_le
l_int|0
)paren
r_goto
id|out
suffix:semicolon
id|memcpy
c_func
(paren
id|ent.authname
comma
id|buf1
comma
r_sizeof
(paren
id|ent.authname
)paren
)paren
suffix:semicolon
multiline_comment|/* Type */
r_if
c_cond
(paren
id|qword_get
c_func
(paren
op_amp
id|buf
comma
id|buf1
comma
id|PAGE_SIZE
)paren
op_le
l_int|0
)paren
r_goto
id|out
suffix:semicolon
id|ent.type
op_assign
id|strcmp
c_func
(paren
id|buf1
comma
l_string|&quot;user&quot;
)paren
op_eq
l_int|0
ques
c_cond
id|IDMAP_TYPE_USER
suffix:colon
id|IDMAP_TYPE_GROUP
suffix:semicolon
multiline_comment|/* ID */
r_if
c_cond
(paren
id|qword_get
c_func
(paren
op_amp
id|buf
comma
id|buf1
comma
id|PAGE_SIZE
)paren
op_le
l_int|0
)paren
r_goto
id|out
suffix:semicolon
id|ent.id
op_assign
id|simple_strtoul
c_func
(paren
id|buf1
comma
op_amp
id|bp
comma
l_int|10
)paren
suffix:semicolon
r_if
c_cond
(paren
id|bp
op_eq
id|buf1
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* expiry */
id|ent.h.expiry_time
op_assign
id|get_expiry
c_func
(paren
op_amp
id|buf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ent.h.expiry_time
op_eq
l_int|0
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* Name */
id|error
op_assign
id|qword_get
c_func
(paren
op_amp
id|buf
comma
id|buf1
comma
id|PAGE_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
op_eq
op_minus
id|EINVAL
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|error
op_eq
op_minus
id|ENOENT
)paren
id|set_bit
c_func
(paren
id|CACHE_NEGATIVE
comma
op_amp
id|ent.h.flags
)paren
suffix:semicolon
r_else
(brace
r_if
c_cond
(paren
id|error
op_ge
id|IDMAP_NAMESZ
)paren
(brace
id|error
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|memcpy
c_func
(paren
id|ent.name
comma
id|buf1
comma
r_sizeof
(paren
id|ent.name
)paren
)paren
suffix:semicolon
)brace
id|error
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
(paren
id|res
op_assign
id|idtoname_lookup
c_func
(paren
op_amp
id|ent
comma
l_int|1
)paren
)paren
op_eq
l_int|NULL
)paren
r_goto
id|out
suffix:semicolon
id|ent_put
c_func
(paren
op_amp
id|res-&gt;h
comma
op_amp
id|idtoname_cache
)paren
suffix:semicolon
id|error
op_assign
l_int|0
suffix:semicolon
id|out
suffix:colon
id|kfree
c_func
(paren
id|buf1
)paren
suffix:semicolon
r_return
id|error
suffix:semicolon
)brace
r_static
id|DefineSimpleCacheLookupMap
c_func
(paren
id|ent
comma
id|idtoname
)paren
suffix:semicolon
multiline_comment|/*&n; * Name -&gt; ID cache&n; */
DECL|variable|nametoid_table
r_static
r_struct
id|cache_head
op_star
id|nametoid_table
(braket
id|ENT_HASHMAX
)braket
suffix:semicolon
r_static
r_inline
r_int
DECL|function|nametoid_hash
id|nametoid_hash
c_func
(paren
r_struct
id|ent
op_star
id|ent
)paren
(brace
r_return
id|hash_str
c_func
(paren
id|ent-&gt;name
comma
id|ENT_HASHBITS
)paren
suffix:semicolon
)brace
r_void
DECL|function|nametoid_request
id|nametoid_request
c_func
(paren
r_struct
id|cache_detail
op_star
id|cd
comma
r_struct
id|cache_head
op_star
id|ch
comma
r_char
op_star
op_star
id|bpp
comma
r_int
op_star
id|blen
)paren
(brace
r_struct
id|ent
op_star
id|ent
op_assign
id|container_of
c_func
(paren
id|ch
comma
r_struct
id|ent
comma
id|h
)paren
suffix:semicolon
id|qword_add
c_func
(paren
id|bpp
comma
id|blen
comma
id|ent-&gt;authname
)paren
suffix:semicolon
id|qword_add
c_func
(paren
id|bpp
comma
id|blen
comma
id|ent-&gt;type
op_eq
id|IDMAP_TYPE_GROUP
ques
c_cond
l_string|&quot;group&quot;
suffix:colon
l_string|&quot;user&quot;
)paren
suffix:semicolon
id|qword_add
c_func
(paren
id|bpp
comma
id|blen
comma
id|ent-&gt;name
)paren
suffix:semicolon
(paren
op_star
id|bpp
)paren
(braket
op_minus
l_int|1
)braket
op_assign
l_char|&squot;&bslash;n&squot;
suffix:semicolon
)brace
r_static
r_inline
r_int
DECL|function|nametoid_match
id|nametoid_match
c_func
(paren
r_struct
id|ent
op_star
id|a
comma
r_struct
id|ent
op_star
id|b
)paren
(brace
r_return
(paren
id|a-&gt;type
op_eq
id|b-&gt;type
op_logical_and
id|strcmp
c_func
(paren
id|a-&gt;name
comma
id|b-&gt;name
)paren
op_eq
l_int|0
op_logical_and
id|strcmp
c_func
(paren
id|a-&gt;authname
comma
id|b-&gt;authname
)paren
op_eq
l_int|0
)paren
suffix:semicolon
)brace
r_static
r_int
DECL|function|nametoid_show
id|nametoid_show
c_func
(paren
r_struct
id|seq_file
op_star
id|m
comma
r_struct
id|cache_detail
op_star
id|cd
comma
r_struct
id|cache_head
op_star
id|h
)paren
(brace
r_struct
id|ent
op_star
id|ent
suffix:semicolon
r_if
c_cond
(paren
id|h
op_eq
l_int|NULL
)paren
(brace
id|seq_puts
c_func
(paren
id|m
comma
l_string|&quot;#domain type name [id]&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
id|ent
op_assign
id|container_of
c_func
(paren
id|h
comma
r_struct
id|ent
comma
id|h
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;%s %s %s&quot;
comma
id|ent-&gt;authname
comma
id|ent-&gt;type
op_eq
id|IDMAP_TYPE_GROUP
ques
c_cond
l_string|&quot;group&quot;
suffix:colon
l_string|&quot;user&quot;
comma
id|ent-&gt;name
)paren
suffix:semicolon
r_if
c_cond
(paren
id|test_bit
c_func
(paren
id|CACHE_VALID
comma
op_amp
id|h-&gt;flags
)paren
)paren
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot; %d&quot;
comma
id|ent-&gt;id
)paren
suffix:semicolon
id|seq_printf
c_func
(paren
id|m
comma
l_string|&quot;&bslash;n&quot;
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_struct
id|ent
op_star
id|nametoid_lookup
c_func
(paren
r_struct
id|ent
op_star
comma
r_int
)paren
suffix:semicolon
r_int
id|nametoid_parse
c_func
(paren
r_struct
id|cache_detail
op_star
comma
r_char
op_star
comma
r_int
)paren
suffix:semicolon
DECL|variable|nametoid_cache
r_struct
id|cache_detail
id|nametoid_cache
op_assign
(brace
dot
id|hash_size
op_assign
id|ENT_HASHMAX
comma
dot
id|hash_table
op_assign
id|nametoid_table
comma
dot
id|name
op_assign
l_string|&quot;nfs4.nametoid&quot;
comma
dot
id|cache_put
op_assign
id|ent_put
comma
dot
id|cache_request
op_assign
id|nametoid_request
comma
dot
id|cache_parse
op_assign
id|nametoid_parse
comma
dot
id|cache_show
op_assign
id|nametoid_show
comma
)brace
suffix:semicolon
r_int
DECL|function|nametoid_parse
id|nametoid_parse
c_func
(paren
r_struct
id|cache_detail
op_star
id|cd
comma
r_char
op_star
id|buf
comma
r_int
id|buflen
)paren
(brace
r_struct
id|ent
id|ent
comma
op_star
id|res
suffix:semicolon
r_char
op_star
id|buf1
suffix:semicolon
r_int
id|error
op_assign
op_minus
id|EINVAL
suffix:semicolon
r_if
c_cond
(paren
id|buf
(braket
id|buflen
op_minus
l_int|1
)braket
op_ne
l_char|&squot;&bslash;n&squot;
)paren
r_return
(paren
op_minus
id|EINVAL
)paren
suffix:semicolon
id|buf
(braket
id|buflen
op_minus
l_int|1
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|buf1
op_assign
id|kmalloc
c_func
(paren
id|PAGE_SIZE
comma
id|GFP_KERNEL
)paren
suffix:semicolon
r_if
c_cond
(paren
id|buf1
op_eq
l_int|NULL
)paren
r_return
(paren
op_minus
id|ENOMEM
)paren
suffix:semicolon
id|memset
c_func
(paren
op_amp
id|ent
comma
l_int|0
comma
r_sizeof
(paren
id|ent
)paren
)paren
suffix:semicolon
multiline_comment|/* Authentication name */
r_if
c_cond
(paren
id|qword_get
c_func
(paren
op_amp
id|buf
comma
id|buf1
comma
id|PAGE_SIZE
)paren
op_le
l_int|0
)paren
r_goto
id|out
suffix:semicolon
id|memcpy
c_func
(paren
id|ent.authname
comma
id|buf1
comma
r_sizeof
(paren
id|ent.authname
)paren
)paren
suffix:semicolon
multiline_comment|/* Type */
r_if
c_cond
(paren
id|qword_get
c_func
(paren
op_amp
id|buf
comma
id|buf1
comma
id|PAGE_SIZE
)paren
op_le
l_int|0
)paren
r_goto
id|out
suffix:semicolon
id|ent.type
op_assign
id|strcmp
c_func
(paren
id|buf1
comma
l_string|&quot;user&quot;
)paren
op_eq
l_int|0
ques
c_cond
id|IDMAP_TYPE_USER
suffix:colon
id|IDMAP_TYPE_GROUP
suffix:semicolon
multiline_comment|/* Name */
id|error
op_assign
id|qword_get
c_func
(paren
op_amp
id|buf
comma
id|buf1
comma
id|PAGE_SIZE
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
op_le
l_int|0
op_logical_or
id|error
op_ge
id|IDMAP_NAMESZ
)paren
r_goto
id|out
suffix:semicolon
id|memcpy
c_func
(paren
id|ent.name
comma
id|buf1
comma
r_sizeof
(paren
id|ent.name
)paren
)paren
suffix:semicolon
multiline_comment|/* expiry */
id|ent.h.expiry_time
op_assign
id|get_expiry
c_func
(paren
op_amp
id|buf
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ent.h.expiry_time
op_eq
l_int|0
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* ID */
id|error
op_assign
id|get_int
c_func
(paren
op_amp
id|buf
comma
op_amp
id|ent.id
)paren
suffix:semicolon
r_if
c_cond
(paren
id|error
op_eq
op_minus
id|EINVAL
)paren
r_goto
id|out
suffix:semicolon
r_if
c_cond
(paren
id|error
op_eq
op_minus
id|ENOENT
)paren
id|set_bit
c_func
(paren
id|CACHE_NEGATIVE
comma
op_amp
id|ent.h.flags
)paren
suffix:semicolon
id|error
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
(paren
id|res
op_assign
id|nametoid_lookup
c_func
(paren
op_amp
id|ent
comma
l_int|1
)paren
)paren
op_eq
l_int|NULL
)paren
r_goto
id|out
suffix:semicolon
id|ent_put
c_func
(paren
op_amp
id|res-&gt;h
comma
op_amp
id|nametoid_cache
)paren
suffix:semicolon
id|error
op_assign
l_int|0
suffix:semicolon
id|out
suffix:colon
id|kfree
c_func
(paren
id|buf1
)paren
suffix:semicolon
r_return
(paren
id|error
)paren
suffix:semicolon
)brace
r_static
id|DefineSimpleCacheLookupMap
c_func
(paren
id|ent
comma
id|nametoid
)paren
suffix:semicolon
multiline_comment|/*&n; * Exported API&n; */
r_void
DECL|function|nfsd_idmap_init
id|nfsd_idmap_init
c_func
(paren
r_void
)paren
(brace
id|cache_register
c_func
(paren
op_amp
id|idtoname_cache
)paren
suffix:semicolon
id|cache_register
c_func
(paren
op_amp
id|nametoid_cache
)paren
suffix:semicolon
)brace
r_void
DECL|function|nfsd_idmap_shutdown
id|nfsd_idmap_shutdown
c_func
(paren
r_void
)paren
(brace
id|cache_unregister
c_func
(paren
op_amp
id|idtoname_cache
)paren
suffix:semicolon
id|cache_unregister
c_func
(paren
op_amp
id|nametoid_cache
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Deferred request handling&n; */
DECL|struct|idmap_defer_req
r_struct
id|idmap_defer_req
(brace
DECL|member|req
r_struct
id|cache_req
id|req
suffix:semicolon
DECL|member|deferred_req
r_struct
id|cache_deferred_req
id|deferred_req
suffix:semicolon
DECL|member|waitq
id|wait_queue_head_t
id|waitq
suffix:semicolon
DECL|member|count
id|atomic_t
id|count
suffix:semicolon
)brace
suffix:semicolon
r_static
r_void
DECL|function|put_mdr
id|put_mdr
c_func
(paren
r_struct
id|idmap_defer_req
op_star
id|mdr
)paren
(brace
r_if
c_cond
(paren
id|atomic_dec_and_test
c_func
(paren
op_amp
id|mdr-&gt;count
)paren
)paren
id|kfree
c_func
(paren
id|mdr
)paren
suffix:semicolon
)brace
r_static
r_void
DECL|function|idmap_revisit
id|idmap_revisit
c_func
(paren
r_struct
id|cache_deferred_req
op_star
id|dreq
comma
r_int
id|toomany
)paren
(brace
r_struct
id|idmap_defer_req
op_star
id|mdr
op_assign
id|container_of
c_func
(paren
id|dreq
comma
r_struct
id|idmap_defer_req
comma
id|deferred_req
)paren
suffix:semicolon
id|wake_up
c_func
(paren
op_amp
id|mdr-&gt;waitq
)paren
suffix:semicolon
id|put_mdr
c_func
(paren
id|mdr
)paren
suffix:semicolon
)brace
r_static
r_struct
id|cache_deferred_req
op_star
DECL|function|idmap_defer
id|idmap_defer
c_func
(paren
r_struct
id|cache_req
op_star
id|req
)paren
(brace
r_struct
id|idmap_defer_req
op_star
id|mdr
op_assign
id|container_of
c_func
(paren
id|req
comma
r_struct
id|idmap_defer_req
comma
id|req
)paren
suffix:semicolon
id|mdr-&gt;deferred_req.revisit
op_assign
id|idmap_revisit
suffix:semicolon
r_return
(paren
op_amp
id|mdr-&gt;deferred_req
)paren
suffix:semicolon
)brace
DECL|variable|threads_waiting
r_static
r_int
id|threads_waiting
op_assign
l_int|0
suffix:semicolon
r_static
r_inline
r_int
DECL|function|idmap_lookup_wait
id|idmap_lookup_wait
c_func
(paren
r_struct
id|idmap_defer_req
op_star
id|mdr
comma
id|wait_queue_t
id|waitq
comma
r_struct
id|svc_rqst
op_star
id|rqstp
)paren
(brace
r_int
id|ret
op_assign
op_minus
id|ETIMEDOUT
suffix:semicolon
id|set_task_state
c_func
(paren
id|current
comma
id|TASK_INTERRUPTIBLE
)paren
suffix:semicolon
id|lock_kernel
c_func
(paren
)paren
suffix:semicolon
multiline_comment|/* XXX: Does it matter that threads_waiting isn&squot;t per-server? */
multiline_comment|/* Note: BKL prevents races with nfsd_svc and other lookups */
r_if
c_cond
(paren
l_int|2
op_star
id|threads_waiting
OG
id|rqstp-&gt;rq_server-&gt;sv_nrthreads
)paren
r_goto
id|out
suffix:semicolon
id|threads_waiting
op_increment
suffix:semicolon
id|schedule_timeout
c_func
(paren
l_int|10
op_star
id|HZ
)paren
suffix:semicolon
id|threads_waiting
op_decrement
suffix:semicolon
id|ret
op_assign
l_int|0
suffix:semicolon
id|out
suffix:colon
id|unlock_kernel
c_func
(paren
)paren
suffix:semicolon
id|remove_wait_queue
c_func
(paren
op_amp
id|mdr-&gt;waitq
comma
op_amp
id|waitq
)paren
suffix:semicolon
id|set_task_state
c_func
(paren
id|current
comma
id|TASK_RUNNING
)paren
suffix:semicolon
id|put_mdr
c_func
(paren
id|mdr
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
r_static
r_int
DECL|function|idmap_lookup
id|idmap_lookup
c_func
(paren
r_struct
id|svc_rqst
op_star
id|rqstp
comma
r_struct
id|ent
op_star
(paren
op_star
id|lookup_fn
)paren
(paren
r_struct
id|ent
op_star
comma
r_int
)paren
comma
r_struct
id|ent
op_star
id|key
comma
r_struct
id|cache_detail
op_star
id|detail
comma
r_struct
id|ent
op_star
op_star
id|item
)paren
(brace
r_struct
id|idmap_defer_req
op_star
id|mdr
suffix:semicolon
id|DECLARE_WAITQUEUE
c_func
(paren
id|waitq
comma
id|current
)paren
suffix:semicolon
r_int
id|ret
suffix:semicolon
op_star
id|item
op_assign
id|lookup_fn
c_func
(paren
id|key
comma
l_int|0
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
op_star
id|item
)paren
r_return
op_minus
id|ENOMEM
suffix:semicolon
id|mdr
op_assign
id|kmalloc
c_func
(paren
r_sizeof
(paren
op_star
id|mdr
)paren
comma
id|GFP_KERNEL
)paren
suffix:semicolon
id|memset
c_func
(paren
id|mdr
comma
l_int|0
comma
r_sizeof
(paren
op_star
id|mdr
)paren
)paren
suffix:semicolon
id|init_waitqueue_head
c_func
(paren
op_amp
id|mdr-&gt;waitq
)paren
suffix:semicolon
id|add_wait_queue
c_func
(paren
op_amp
id|mdr-&gt;waitq
comma
op_amp
id|waitq
)paren
suffix:semicolon
id|atomic_set
c_func
(paren
op_amp
id|mdr-&gt;count
comma
l_int|2
)paren
suffix:semicolon
id|mdr-&gt;req.defer
op_assign
id|idmap_defer
suffix:semicolon
id|ret
op_assign
id|cache_check
c_func
(paren
id|detail
comma
op_amp
(paren
op_star
id|item
)paren
op_member_access_from_pointer
id|h
comma
op_amp
id|mdr-&gt;req
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
op_eq
op_minus
id|EAGAIN
)paren
(brace
id|ret
op_assign
id|idmap_lookup_wait
c_func
(paren
id|mdr
comma
id|waitq
comma
id|rqstp
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_goto
id|out
suffix:semicolon
multiline_comment|/* Try again, but don&squot;t wait. */
op_star
id|item
op_assign
id|lookup_fn
c_func
(paren
id|key
comma
l_int|0
)paren
suffix:semicolon
id|ret
op_assign
op_minus
id|ENOMEM
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
op_star
id|item
)paren
r_goto
id|out
suffix:semicolon
id|ret
op_assign
op_minus
id|ETIMEDOUT
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|test_bit
c_func
(paren
id|CACHE_VALID
comma
op_amp
(paren
op_star
id|item
)paren
op_member_access_from_pointer
id|h.flags
)paren
)paren
(brace
id|ent_put
c_func
(paren
op_amp
(paren
op_star
id|item
)paren
op_member_access_from_pointer
id|h
comma
id|detail
)paren
suffix:semicolon
r_goto
id|out
suffix:semicolon
)brace
id|ret
op_assign
id|cache_check
c_func
(paren
id|detail
comma
op_amp
(paren
op_star
id|item
)paren
op_member_access_from_pointer
id|h
comma
l_int|NULL
)paren
suffix:semicolon
)brace
id|out
suffix:colon
r_return
id|ret
suffix:semicolon
)brace
r_static
r_int
DECL|function|idmap_name_to_id
id|idmap_name_to_id
c_func
(paren
r_struct
id|svc_rqst
op_star
id|rqstp
comma
r_int
id|type
comma
r_const
r_char
op_star
id|name
comma
id|u32
id|namelen
comma
id|uid_t
op_star
id|id
)paren
(brace
r_struct
id|ent
op_star
id|item
comma
id|key
op_assign
(brace
dot
id|type
op_assign
id|type
comma
)brace
suffix:semicolon
r_int
id|ret
suffix:semicolon
r_if
c_cond
(paren
id|namelen
op_plus
l_int|1
OG
r_sizeof
(paren
id|key.name
)paren
)paren
r_return
op_minus
id|EINVAL
suffix:semicolon
id|memcpy
c_func
(paren
id|key.name
comma
id|name
comma
id|namelen
)paren
suffix:semicolon
id|key.name
(braket
id|namelen
)braket
op_assign
l_char|&squot;&bslash;0&squot;
suffix:semicolon
id|strlcpy
c_func
(paren
id|key.authname
comma
id|rqstp-&gt;rq_client-&gt;name
comma
r_sizeof
(paren
id|key.authname
)paren
)paren
suffix:semicolon
id|ret
op_assign
id|idmap_lookup
c_func
(paren
id|rqstp
comma
id|nametoid_lookup
comma
op_amp
id|key
comma
op_amp
id|nametoid_cache
comma
op_amp
id|item
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_return
id|ret
suffix:semicolon
op_star
id|id
op_assign
id|item-&gt;id
suffix:semicolon
id|ent_put
c_func
(paren
op_amp
id|item-&gt;h
comma
op_amp
id|nametoid_cache
)paren
suffix:semicolon
r_return
l_int|0
suffix:semicolon
)brace
r_static
r_int
DECL|function|idmap_id_to_name
id|idmap_id_to_name
c_func
(paren
r_struct
id|svc_rqst
op_star
id|rqstp
comma
r_int
id|type
comma
id|uid_t
id|id
comma
r_char
op_star
id|name
)paren
(brace
r_struct
id|ent
op_star
id|item
comma
id|key
op_assign
(brace
dot
id|id
op_assign
id|id
comma
dot
id|type
op_assign
id|type
comma
)brace
suffix:semicolon
r_int
id|ret
suffix:semicolon
id|strlcpy
c_func
(paren
id|key.authname
comma
id|rqstp-&gt;rq_client-&gt;name
comma
r_sizeof
(paren
id|key.authname
)paren
)paren
suffix:semicolon
id|ret
op_assign
id|idmap_lookup
c_func
(paren
id|rqstp
comma
id|idtoname_lookup
comma
op_amp
id|key
comma
op_amp
id|idtoname_cache
comma
op_amp
id|item
)paren
suffix:semicolon
r_if
c_cond
(paren
id|ret
)paren
r_return
id|ret
suffix:semicolon
id|ret
op_assign
id|strlen
c_func
(paren
id|item-&gt;name
)paren
suffix:semicolon
id|BUG_ON
c_func
(paren
id|ret
OG
id|IDMAP_NAMESZ
)paren
suffix:semicolon
id|memcpy
c_func
(paren
id|name
comma
id|item-&gt;name
comma
id|ret
)paren
suffix:semicolon
id|ent_put
c_func
(paren
op_amp
id|item-&gt;h
comma
op_amp
id|idtoname_cache
)paren
suffix:semicolon
r_return
id|ret
suffix:semicolon
)brace
r_int
DECL|function|nfsd_map_name_to_uid
id|nfsd_map_name_to_uid
c_func
(paren
r_struct
id|svc_rqst
op_star
id|rqstp
comma
r_const
r_char
op_star
id|name
comma
r_int
id|namelen
comma
id|__u32
op_star
id|id
)paren
(brace
r_return
id|idmap_name_to_id
c_func
(paren
id|rqstp
comma
id|IDMAP_TYPE_USER
comma
id|name
comma
id|namelen
comma
id|id
)paren
suffix:semicolon
)brace
r_int
DECL|function|nfsd_map_name_to_gid
id|nfsd_map_name_to_gid
c_func
(paren
r_struct
id|svc_rqst
op_star
id|rqstp
comma
r_const
r_char
op_star
id|name
comma
r_int
id|namelen
comma
id|__u32
op_star
id|id
)paren
(brace
r_return
id|idmap_name_to_id
c_func
(paren
id|rqstp
comma
id|IDMAP_TYPE_GROUP
comma
id|name
comma
id|namelen
comma
id|id
)paren
suffix:semicolon
)brace
r_int
DECL|function|nfsd_map_uid_to_name
id|nfsd_map_uid_to_name
c_func
(paren
r_struct
id|svc_rqst
op_star
id|rqstp
comma
id|__u32
id|id
comma
r_char
op_star
id|name
)paren
(brace
r_return
id|idmap_id_to_name
c_func
(paren
id|rqstp
comma
id|IDMAP_TYPE_USER
comma
id|id
comma
id|name
)paren
suffix:semicolon
)brace
r_int
DECL|function|nfsd_map_gid_to_name
id|nfsd_map_gid_to_name
c_func
(paren
r_struct
id|svc_rqst
op_star
id|rqstp
comma
id|__u32
id|id
comma
r_char
op_star
id|name
)paren
(brace
r_return
id|idmap_id_to_name
c_func
(paren
id|rqstp
comma
id|IDMAP_TYPE_GROUP
comma
id|id
comma
id|name
)paren
suffix:semicolon
)brace
eof
