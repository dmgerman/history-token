multiline_comment|/*&n; * inode.c - basic inode and dentry operations.&n; *&n; * sysfs is Copyright (c) 2001-3 Patrick Mochel&n; *&n; * Please see Documentation/filesystems/sysfs.txt for more information.&n; */
DECL|macro|DEBUG
macro_line|#undef DEBUG 
macro_line|#include &lt;linux/pagemap.h&gt;
macro_line|#include &lt;linux/namei.h&gt;
macro_line|#include &lt;linux/backing-dev.h&gt;
macro_line|#include &quot;sysfs.h&quot;
r_extern
r_struct
id|super_block
op_star
id|sysfs_sb
suffix:semicolon
DECL|variable|sysfs_aops
r_static
r_struct
id|address_space_operations
id|sysfs_aops
op_assign
(brace
dot
id|readpage
op_assign
id|simple_readpage
comma
dot
id|prepare_write
op_assign
id|simple_prepare_write
comma
dot
id|commit_write
op_assign
id|simple_commit_write
)brace
suffix:semicolon
DECL|variable|sysfs_backing_dev_info
r_static
r_struct
id|backing_dev_info
id|sysfs_backing_dev_info
op_assign
(brace
dot
id|ra_pages
op_assign
l_int|0
comma
multiline_comment|/* No readahead */
dot
id|memory_backed
op_assign
l_int|1
comma
multiline_comment|/* Does not contribute to dirty memory */
)brace
suffix:semicolon
DECL|function|sysfs_new_inode
r_struct
id|inode
op_star
id|sysfs_new_inode
c_func
(paren
id|mode_t
id|mode
)paren
(brace
r_struct
id|inode
op_star
id|inode
op_assign
id|new_inode
c_func
(paren
id|sysfs_sb
)paren
suffix:semicolon
r_if
c_cond
(paren
id|inode
)paren
(brace
id|inode-&gt;i_mode
op_assign
id|mode
suffix:semicolon
id|inode-&gt;i_uid
op_assign
l_int|0
suffix:semicolon
id|inode-&gt;i_gid
op_assign
l_int|0
suffix:semicolon
id|inode-&gt;i_blksize
op_assign
id|PAGE_CACHE_SIZE
suffix:semicolon
id|inode-&gt;i_blocks
op_assign
l_int|0
suffix:semicolon
id|inode-&gt;i_atime
op_assign
id|inode-&gt;i_mtime
op_assign
id|inode-&gt;i_ctime
op_assign
id|CURRENT_TIME
suffix:semicolon
id|inode-&gt;i_mapping-&gt;a_ops
op_assign
op_amp
id|sysfs_aops
suffix:semicolon
id|inode-&gt;i_mapping-&gt;backing_dev_info
op_assign
op_amp
id|sysfs_backing_dev_info
suffix:semicolon
)brace
r_return
id|inode
suffix:semicolon
)brace
DECL|function|sysfs_create
r_int
id|sysfs_create
c_func
(paren
r_struct
id|dentry
op_star
id|dentry
comma
r_int
id|mode
comma
r_int
(paren
op_star
id|init
)paren
(paren
r_struct
id|inode
op_star
)paren
)paren
(brace
r_int
id|error
op_assign
l_int|0
suffix:semicolon
r_struct
id|inode
op_star
id|inode
op_assign
l_int|NULL
suffix:semicolon
r_if
c_cond
(paren
id|dentry
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|dentry-&gt;d_inode
)paren
(brace
r_if
c_cond
(paren
(paren
id|inode
op_assign
id|sysfs_new_inode
c_func
(paren
id|mode
)paren
)paren
)paren
(brace
r_if
c_cond
(paren
id|dentry-&gt;d_parent
op_logical_and
id|dentry-&gt;d_parent-&gt;d_inode
)paren
(brace
r_struct
id|inode
op_star
id|p_inode
op_assign
id|dentry-&gt;d_parent-&gt;d_inode
suffix:semicolon
id|p_inode-&gt;i_mtime
op_assign
id|p_inode-&gt;i_ctime
op_assign
id|CURRENT_TIME
suffix:semicolon
)brace
r_goto
id|Proceed
suffix:semicolon
)brace
r_else
id|error
op_assign
op_minus
id|ENOMEM
suffix:semicolon
)brace
r_else
id|error
op_assign
op_minus
id|EEXIST
suffix:semicolon
)brace
r_else
id|error
op_assign
op_minus
id|ENOENT
suffix:semicolon
r_goto
id|Done
suffix:semicolon
id|Proceed
suffix:colon
r_if
c_cond
(paren
id|init
)paren
id|error
op_assign
id|init
c_func
(paren
id|inode
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|error
)paren
(brace
id|d_instantiate
c_func
(paren
id|dentry
comma
id|inode
)paren
suffix:semicolon
r_if
c_cond
(paren
id|S_ISDIR
c_func
(paren
id|mode
)paren
)paren
id|dget
c_func
(paren
id|dentry
)paren
suffix:semicolon
multiline_comment|/* pin only directory dentry in core */
)brace
r_else
id|iput
c_func
(paren
id|inode
)paren
suffix:semicolon
id|Done
suffix:colon
r_return
id|error
suffix:semicolon
)brace
DECL|function|sysfs_mknod
r_int
id|sysfs_mknod
c_func
(paren
r_struct
id|inode
op_star
id|dir
comma
r_struct
id|dentry
op_star
id|dentry
comma
r_int
id|mode
comma
id|dev_t
id|dev
)paren
(brace
r_return
id|sysfs_create
c_func
(paren
id|dentry
comma
id|mode
comma
l_int|NULL
)paren
suffix:semicolon
)brace
DECL|function|sysfs_get_dentry
r_struct
id|dentry
op_star
id|sysfs_get_dentry
c_func
(paren
r_struct
id|dentry
op_star
id|parent
comma
r_const
r_char
op_star
id|name
)paren
(brace
r_struct
id|qstr
id|qstr
suffix:semicolon
id|qstr.name
op_assign
id|name
suffix:semicolon
id|qstr.len
op_assign
id|strlen
c_func
(paren
id|name
)paren
suffix:semicolon
id|qstr.hash
op_assign
id|full_name_hash
c_func
(paren
id|name
comma
id|qstr.len
)paren
suffix:semicolon
r_return
id|lookup_hash
c_func
(paren
op_amp
id|qstr
comma
id|parent
)paren
suffix:semicolon
)brace
multiline_comment|/*&n; * Get the name for corresponding element represented by the given sysfs_dirent&n; */
DECL|function|sysfs_get_name
r_const
r_int
r_char
op_star
id|sysfs_get_name
c_func
(paren
r_struct
id|sysfs_dirent
op_star
id|sd
)paren
(brace
r_struct
id|attribute
op_star
id|attr
suffix:semicolon
r_struct
id|bin_attribute
op_star
id|bin_attr
suffix:semicolon
r_struct
id|sysfs_symlink
op_star
id|sl
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|sd
op_logical_or
op_logical_neg
id|sd-&gt;s_element
)paren
id|BUG
c_func
(paren
)paren
suffix:semicolon
r_switch
c_cond
(paren
id|sd-&gt;s_type
)paren
(brace
r_case
id|SYSFS_DIR
suffix:colon
multiline_comment|/* Always have a dentry so use that */
r_return
id|sd-&gt;s_dentry-&gt;d_name.name
suffix:semicolon
r_case
id|SYSFS_KOBJ_ATTR
suffix:colon
id|attr
op_assign
id|sd-&gt;s_element
suffix:semicolon
r_return
id|attr-&gt;name
suffix:semicolon
r_case
id|SYSFS_KOBJ_BIN_ATTR
suffix:colon
id|bin_attr
op_assign
id|sd-&gt;s_element
suffix:semicolon
r_return
id|bin_attr-&gt;attr.name
suffix:semicolon
r_case
id|SYSFS_KOBJ_LINK
suffix:colon
id|sl
op_assign
id|sd-&gt;s_element
suffix:semicolon
r_return
id|sl-&gt;link_name
suffix:semicolon
)brace
r_return
l_int|NULL
suffix:semicolon
)brace
multiline_comment|/*&n; * Unhashes the dentry corresponding to given sysfs_dirent&n; * Called with parent inode&squot;s i_sem held.&n; */
DECL|function|sysfs_drop_dentry
r_void
id|sysfs_drop_dentry
c_func
(paren
r_struct
id|sysfs_dirent
op_star
id|sd
comma
r_struct
id|dentry
op_star
id|parent
)paren
(brace
r_struct
id|dentry
op_star
id|dentry
op_assign
id|sd-&gt;s_dentry
suffix:semicolon
r_if
c_cond
(paren
id|dentry
)paren
(brace
id|spin_lock
c_func
(paren
op_amp
id|dcache_lock
)paren
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
(paren
id|d_unhashed
c_func
(paren
id|dentry
)paren
op_logical_and
id|dentry-&gt;d_inode
)paren
)paren
(brace
id|dget_locked
c_func
(paren
id|dentry
)paren
suffix:semicolon
id|__d_drop
c_func
(paren
id|dentry
)paren
suffix:semicolon
id|spin_unlock
c_func
(paren
op_amp
id|dcache_lock
)paren
suffix:semicolon
id|simple_unlink
c_func
(paren
id|parent-&gt;d_inode
comma
id|dentry
)paren
suffix:semicolon
)brace
r_else
id|spin_unlock
c_func
(paren
op_amp
id|dcache_lock
)paren
suffix:semicolon
)brace
)brace
DECL|function|sysfs_hash_and_remove
r_void
id|sysfs_hash_and_remove
c_func
(paren
r_struct
id|dentry
op_star
id|dir
comma
r_const
r_char
op_star
id|name
)paren
(brace
r_struct
id|sysfs_dirent
op_star
id|sd
suffix:semicolon
r_struct
id|sysfs_dirent
op_star
id|parent_sd
op_assign
id|dir-&gt;d_fsdata
suffix:semicolon
id|down
c_func
(paren
op_amp
id|dir-&gt;d_inode-&gt;i_sem
)paren
suffix:semicolon
id|list_for_each_entry
c_func
(paren
id|sd
comma
op_amp
id|parent_sd-&gt;s_children
comma
id|s_sibling
)paren
(brace
r_if
c_cond
(paren
op_logical_neg
id|sd-&gt;s_element
)paren
r_continue
suffix:semicolon
r_if
c_cond
(paren
op_logical_neg
id|strcmp
c_func
(paren
id|sysfs_get_name
c_func
(paren
id|sd
)paren
comma
id|name
)paren
)paren
(brace
id|list_del_init
c_func
(paren
op_amp
id|sd-&gt;s_sibling
)paren
suffix:semicolon
id|sysfs_drop_dentry
c_func
(paren
id|sd
comma
id|dir
)paren
suffix:semicolon
id|sysfs_put
c_func
(paren
id|sd
)paren
suffix:semicolon
r_break
suffix:semicolon
)brace
)brace
id|up
c_func
(paren
op_amp
id|dir-&gt;d_inode-&gt;i_sem
)paren
suffix:semicolon
)brace
eof
